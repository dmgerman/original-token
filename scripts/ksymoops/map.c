multiline_comment|/*&n;&t;map.c.&n;&n;&t;Read System.map for ksymoops, create merged System.map.&n;&n;&t;Copyright Keith Owens &lt;kaos@ocs.com.au&gt;.&n;&t;Released under the GNU Public Licence, Version 2.&n;&n;&t;Tue Nov  3 02:31:01 EST 1998&n;&t;Version 0.6&n;&t;Remove addresses 0-4095 from merged map after writing new map.&n;&t;Move &quot;Using_Version&quot; copy to map.c.&n;&n;&t;Wed Oct 28 13:47:23 EST 1998&n;&t;Version 0.4&n;&t;Split into separate sources.&n; */
macro_line|#include &quot;ksymoops.h&quot;
macro_line|#include &lt;malloc.h&gt;
multiline_comment|/* Read the symbols from System.map */
DECL|function|read_system_map
r_void
id|read_system_map
c_func
(paren
r_const
r_char
op_star
id|system_map
)paren
(brace
id|FILE
op_star
id|f
suffix:semicolon
r_char
op_star
id|line
op_assign
l_int|NULL
comma
op_star
op_star
id|string
op_assign
l_int|NULL
suffix:semicolon
r_int
id|i
comma
id|size
op_assign
l_int|0
suffix:semicolon
r_static
r_char
r_const
id|procname
(braket
)braket
op_assign
l_string|&quot;read_system_map&quot;
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|system_map
)paren
r_return
suffix:semicolon
id|ss_init
c_func
(paren
op_amp
id|ss_system_map
comma
l_string|&quot;System.map&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|debug
)paren
id|fprintf
c_func
(paren
id|stderr
comma
l_string|&quot;DEBUG: %s %s&bslash;n&quot;
comma
id|procname
comma
id|system_map
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|regular_file
c_func
(paren
id|system_map
comma
id|procname
)paren
)paren
r_return
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|f
op_assign
id|fopen_local
c_func
(paren
id|system_map
comma
l_string|&quot;r&quot;
comma
id|procname
)paren
)paren
)paren
r_return
suffix:semicolon
r_while
c_loop
(paren
id|fgets_local
c_func
(paren
op_amp
id|line
comma
op_amp
id|size
comma
id|f
comma
id|procname
)paren
)paren
(brace
id|i
op_assign
id|regexec
c_func
(paren
op_amp
id|re_nm
comma
id|line
comma
id|re_nm.re_nsub
op_plus
l_int|1
comma
id|re_nm_pmatch
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|debug
OG
l_int|3
)paren
id|fprintf
c_func
(paren
id|stderr
comma
l_string|&quot;DEBUG: %s regexec %d&bslash;n&quot;
comma
id|procname
comma
id|i
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
op_eq
l_int|0
)paren
(brace
id|re_strings
c_func
(paren
op_amp
id|re_nm
comma
id|line
comma
id|re_nm_pmatch
comma
op_amp
id|string
)paren
suffix:semicolon
id|add_symbol
c_func
(paren
op_amp
id|ss_system_map
comma
id|string
(braket
l_int|1
)braket
comma
op_star
id|string
(braket
l_int|2
)braket
comma
l_int|1
comma
id|string
(braket
l_int|3
)braket
)paren
suffix:semicolon
)brace
)brace
id|fclose_local
c_func
(paren
id|f
comma
id|procname
)paren
suffix:semicolon
id|re_strings_free
c_func
(paren
op_amp
id|re_nm
comma
op_amp
id|string
)paren
suffix:semicolon
id|free
c_func
(paren
id|line
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ss_system_map.used
)paren
(brace
id|ss_sort_na
c_func
(paren
op_amp
id|ss_system_map
)paren
suffix:semicolon
id|extract_Version
c_func
(paren
op_amp
id|ss_system_map
)paren
suffix:semicolon
)brace
r_else
(brace
id|fprintf
c_func
(paren
id|stderr
comma
l_string|&quot;Warning, no kernel symbols in System.map, is %s a &quot;
l_string|&quot;valid System.map file?&bslash;n&quot;
comma
id|system_map
)paren
suffix:semicolon
op_increment
id|warnings
suffix:semicolon
)brace
r_if
c_cond
(paren
id|debug
OG
l_int|1
)paren
id|fprintf
c_func
(paren
id|stderr
comma
l_string|&quot;DEBUG: %s %s used %d out of %d entries&bslash;n&quot;
comma
id|procname
comma
id|ss_system_map.source
comma
id|ss_system_map.used
comma
id|ss_system_map.alloc
)paren
suffix:semicolon
)brace
multiline_comment|/* Compare two maps, all symbols in the first should appear in the second. */
DECL|function|compare_maps
r_void
id|compare_maps
c_func
(paren
r_const
id|SYMBOL_SET
op_star
id|ss1
comma
r_const
id|SYMBOL_SET
op_star
id|ss2
comma
r_int
id|precedence
)paren
(brace
r_int
id|i
comma
id|start
op_assign
l_int|0
suffix:semicolon
id|SYMBOL
op_star
id|s1
comma
op_star
id|s2
comma
op_star
op_star
id|sdrop
op_assign
id|precedence
op_eq
l_int|1
ques
c_cond
op_amp
id|s2
suffix:colon
op_amp
id|s1
suffix:semicolon
r_const
id|SYMBOL_SET
op_star
op_star
id|ssdrop
op_assign
id|precedence
op_eq
l_int|1
ques
c_cond
op_amp
id|ss2
suffix:colon
op_amp
id|ss1
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|ss1-&gt;used
op_logical_and
id|ss2-&gt;used
)paren
)paren
r_return
suffix:semicolon
r_if
c_cond
(paren
id|debug
OG
l_int|1
)paren
id|fprintf
c_func
(paren
id|stderr
comma
l_string|&quot;DEBUG: compare_maps %s vs %s, %s takes precedence&bslash;n&quot;
comma
id|ss1-&gt;source
comma
id|ss2-&gt;source
comma
id|precedence
op_eq
l_int|1
ques
c_cond
id|ss1-&gt;source
suffix:colon
id|ss2-&gt;source
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|ss1-&gt;used
suffix:semicolon
op_increment
id|i
)paren
(brace
id|s1
op_assign
id|ss1-&gt;symbol
op_plus
id|i
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|s1-&gt;keep
)paren
)paren
r_continue
suffix:semicolon
id|s2
op_assign
id|find_symbol_name
c_func
(paren
id|ss2
comma
id|s1-&gt;name
comma
op_amp
id|start
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|s2
)paren
(brace
multiline_comment|/* Some types only appear in nm output, not in things&n;&t;&t;&t; * like System.map.  Silently ignore them.&n;&t;&t;&t; */
r_if
c_cond
(paren
id|s1-&gt;type
op_eq
l_char|&squot;a&squot;
op_logical_or
id|s1-&gt;type
op_eq
l_char|&squot;t&squot;
)paren
r_continue
suffix:semicolon
id|fprintf
c_func
(paren
id|stderr
comma
l_string|&quot;Warning: %s symbol %s not found in %s.  &quot;
l_string|&quot;Ignoring %s entry&bslash;n&quot;
comma
id|ss1-&gt;source
comma
id|s1-&gt;name
comma
id|ss2-&gt;source
comma
(paren
op_star
id|ssdrop
)paren
op_member_access_from_pointer
id|source
)paren
suffix:semicolon
op_increment
id|warnings
suffix:semicolon
r_if
c_cond
(paren
op_star
id|sdrop
)paren
(paren
op_star
id|sdrop
)paren
op_member_access_from_pointer
id|keep
op_assign
l_int|0
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|s1-&gt;address
op_ne
id|s2-&gt;address
)paren
(brace
multiline_comment|/* Type C symbols cannot be resolved from nm to ksyms,&n;&t;&t;&t; * silently ignore them.&n;&t;&t;&t; */
r_if
c_cond
(paren
id|s1-&gt;type
op_eq
l_char|&squot;C&squot;
op_logical_or
id|s2-&gt;type
op_eq
l_char|&squot;C&squot;
)paren
r_continue
suffix:semicolon
id|fprintf
c_func
(paren
id|stderr
comma
l_string|&quot;Warning: mismatch on symbol %s %c, &quot;
l_string|&quot;%s says %lx, %s says %lx.  &quot;
l_string|&quot;Ignoring %s entry&bslash;n&quot;
comma
id|s1-&gt;name
comma
id|s1-&gt;type
comma
id|ss1-&gt;source
comma
id|s1-&gt;address
comma
id|ss2-&gt;source
comma
id|s2-&gt;address
comma
(paren
op_star
id|ssdrop
)paren
op_member_access_from_pointer
id|source
)paren
suffix:semicolon
op_increment
id|warnings
suffix:semicolon
r_if
c_cond
(paren
op_star
id|sdrop
)paren
(paren
op_star
id|sdrop
)paren
op_member_access_from_pointer
id|keep
op_assign
l_int|0
suffix:semicolon
)brace
r_else
op_increment
id|start
suffix:semicolon
multiline_comment|/* step to next entry in ss2 */
)brace
)brace
multiline_comment|/* Append the second symbol set onto the first */
DECL|function|append_map
r_static
r_void
id|append_map
c_func
(paren
id|SYMBOL_SET
op_star
id|ss1
comma
r_const
id|SYMBOL_SET
op_star
id|ss2
)paren
(brace
r_int
id|i
suffix:semicolon
id|SYMBOL
op_star
id|s
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ss2
op_logical_or
op_logical_neg
id|ss2-&gt;used
)paren
r_return
suffix:semicolon
r_if
c_cond
(paren
id|debug
OG
l_int|1
)paren
id|fprintf
c_func
(paren
id|stderr
comma
l_string|&quot;DEBUG: append_map %s to %s&bslash;n&quot;
comma
id|ss2-&gt;source
comma
id|ss1-&gt;source
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|ss2-&gt;used
suffix:semicolon
op_increment
id|i
)paren
(brace
id|s
op_assign
id|ss2-&gt;symbol
op_plus
id|i
suffix:semicolon
r_if
c_cond
(paren
id|s-&gt;keep
)paren
id|add_symbol_n
c_func
(paren
id|ss1
comma
id|s-&gt;address
comma
id|s-&gt;type
comma
l_int|1
comma
id|s-&gt;name
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* Compare the various sources and build a merged system map */
DECL|function|merge_maps
r_void
id|merge_maps
c_func
(paren
r_const
r_char
op_star
id|save_system_map
)paren
(brace
r_int
id|i
suffix:semicolon
id|SYMBOL
op_star
id|s
suffix:semicolon
id|FILE
op_star
id|f
suffix:semicolon
r_static
r_char
r_const
id|procname
(braket
)braket
op_assign
l_string|&quot;merge_maps&quot;
suffix:semicolon
r_if
c_cond
(paren
id|debug
)paren
id|fprintf
c_func
(paren
id|stderr
comma
l_string|&quot;DEBUG: %s&bslash;n&quot;
comma
id|procname
)paren
suffix:semicolon
multiline_comment|/* Using_Versions only appears in ksyms, copy to other tables */
r_if
c_cond
(paren
(paren
id|s
op_assign
id|find_symbol_name
c_func
(paren
op_amp
id|ss_ksyms_base
comma
l_string|&quot;Using_Versions&quot;
comma
l_int|0
)paren
)paren
)paren
(brace
r_if
c_cond
(paren
id|ss_system_map.used
)paren
(brace
id|add_symbol_n
c_func
(paren
op_amp
id|ss_system_map
comma
id|s-&gt;address
comma
id|s-&gt;type
comma
id|s-&gt;keep
comma
id|s-&gt;name
)paren
suffix:semicolon
id|ss_sort_na
c_func
(paren
op_amp
id|ss_system_map
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ss_vmlinux.used
)paren
(brace
id|add_symbol_n
c_func
(paren
op_amp
id|ss_vmlinux
comma
id|s-&gt;address
comma
id|s-&gt;type
comma
id|s-&gt;keep
comma
id|s-&gt;name
)paren
suffix:semicolon
id|ss_sort_na
c_func
(paren
op_amp
id|ss_vmlinux
)paren
suffix:semicolon
)brace
)brace
id|compare_Version
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* highlight any version problems first */
id|compare_ksyms_lsmod
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* highlight any missing modules next */
id|compare_maps
c_func
(paren
op_amp
id|ss_ksyms_base
comma
op_amp
id|ss_vmlinux
comma
l_int|2
)paren
suffix:semicolon
id|compare_maps
c_func
(paren
op_amp
id|ss_system_map
comma
op_amp
id|ss_vmlinux
comma
l_int|2
)paren
suffix:semicolon
id|compare_maps
c_func
(paren
op_amp
id|ss_vmlinux
comma
op_amp
id|ss_system_map
comma
l_int|1
)paren
suffix:semicolon
id|compare_maps
c_func
(paren
op_amp
id|ss_ksyms_base
comma
op_amp
id|ss_system_map
comma
l_int|2
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ss_objects
)paren
(brace
id|map_ksyms_to_modules
c_func
(paren
)paren
suffix:semicolon
)brace
id|ss_init
c_func
(paren
op_amp
id|ss_merged
comma
l_string|&quot;merged&quot;
)paren
suffix:semicolon
id|append_map
c_func
(paren
op_amp
id|ss_merged
comma
op_amp
id|ss_vmlinux
)paren
suffix:semicolon
id|append_map
c_func
(paren
op_amp
id|ss_merged
comma
op_amp
id|ss_ksyms_base
)paren
suffix:semicolon
id|append_map
c_func
(paren
op_amp
id|ss_merged
comma
op_amp
id|ss_system_map
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|ss_ksyms_modules
suffix:semicolon
op_increment
id|i
)paren
id|append_map
c_func
(paren
op_amp
id|ss_merged
comma
(paren
id|ss_ksyms_module
op_plus
id|i
)paren
op_member_access_from_pointer
id|related
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ss_merged.used
)paren
(brace
id|fprintf
c_func
(paren
id|stderr
comma
l_string|&quot;Warning, no symbols in merged map&bslash;n&quot;
)paren
suffix:semicolon
op_increment
id|warnings
suffix:semicolon
)brace
multiline_comment|/* drop duplicates, type a (registers) and gcc2_compiled. */
id|ss_sort_atn
c_func
(paren
op_amp
id|ss_merged
)paren
suffix:semicolon
id|s
op_assign
id|ss_merged.symbol
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|ss_merged.used
op_minus
l_int|1
suffix:semicolon
op_increment
id|i
)paren
(brace
r_if
c_cond
(paren
id|s-&gt;type
op_eq
l_char|&squot;a&squot;
op_logical_or
(paren
id|s-&gt;type
op_eq
l_char|&squot;t&squot;
op_logical_and
op_logical_neg
id|strcmp
c_func
(paren
id|s-&gt;name
comma
l_string|&quot;gcc2_compiled.&quot;
)paren
)paren
)paren
id|s-&gt;keep
op_assign
l_int|0
suffix:semicolon
r_else
r_if
c_cond
(paren
id|strcmp
c_func
(paren
id|s-&gt;name
comma
(paren
id|s
op_plus
l_int|1
)paren
op_member_access_from_pointer
id|name
)paren
op_eq
l_int|0
op_logical_and
id|s-&gt;address
op_eq
(paren
id|s
op_plus
l_int|1
)paren
op_member_access_from_pointer
id|address
)paren
(brace
r_if
c_cond
(paren
id|s-&gt;type
op_ne
l_char|&squot; &squot;
)paren
(paren
id|s
op_plus
l_int|1
)paren
op_member_access_from_pointer
id|keep
op_assign
l_int|0
suffix:semicolon
r_else
id|s-&gt;keep
op_assign
l_int|0
suffix:semicolon
)brace
op_increment
id|s
suffix:semicolon
)brace
id|ss_sort_atn
c_func
(paren
op_amp
id|ss_merged
)paren
suffix:semicolon
multiline_comment|/* will remove dropped variables */
r_if
c_cond
(paren
id|save_system_map
)paren
(brace
r_if
c_cond
(paren
id|debug
)paren
id|fprintf
c_func
(paren
id|stderr
comma
l_string|&quot;DEBUG: writing merged map to %s&bslash;n&quot;
comma
id|save_system_map
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|f
op_assign
id|fopen_local
c_func
(paren
id|save_system_map
comma
l_string|&quot;w&quot;
comma
id|procname
)paren
)paren
)paren
r_return
suffix:semicolon
id|s
op_assign
id|ss_merged.symbol
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|ss_merged.used
suffix:semicolon
op_increment
id|i
)paren
(brace
r_if
c_cond
(paren
id|s-&gt;keep
)paren
id|fprintf
c_func
(paren
id|f
comma
l_string|&quot;%s %c %s&bslash;n&quot;
comma
id|format_address
c_func
(paren
id|s-&gt;address
)paren
comma
id|s-&gt;type
comma
id|s-&gt;name
)paren
suffix:semicolon
op_increment
id|s
suffix:semicolon
)brace
)brace
multiline_comment|/* The merged map may contain symbols with an address of 0, e.g.&n;&t; * Using_Versions.  These give incorrect results for low addresses in&n;&t; * map_address, such addresses map to &quot;Using_Versions+xxx&quot;.  Remove&n;&t; * any addresses below (arbitrary) 4096 from the merged map.  AFAIK,&n;&t; * Linux does not use the first page on any arch.&n;&t; */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|ss_merged.used
suffix:semicolon
op_increment
id|i
)paren
(brace
r_if
c_cond
(paren
(paren
id|ss_merged.symbol
op_plus
id|i
)paren
op_member_access_from_pointer
id|address
OL
l_int|4096
)paren
(paren
id|ss_merged.symbol
op_plus
id|i
)paren
op_member_access_from_pointer
id|keep
op_assign
l_int|0
suffix:semicolon
r_else
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|i
)paren
id|ss_sort_atn
c_func
(paren
op_amp
id|ss_merged
)paren
suffix:semicolon
multiline_comment|/* remove dropped variables */
)brace
eof
