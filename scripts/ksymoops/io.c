multiline_comment|/*&n;&t;io.c.&n;&n;&t;Local I/O routines for ksymoops.&n;&n;&t;Copyright Keith Owens &lt;kaos@ocs.com.au&gt;.&n;&t;Released under the GNU Public Licence, Version 2.&n;&n;&t;Tue Nov  3 02:31:01 EST 1998&n;&t;Version 0.6&n;&t;fwrite_local is redundant, replaced by bfd.&n;&n;&t;Wed Oct 28 13:47:23 EST 1998&n;&t;Version 0.4&n;&t;Split into separate sources.&n;&n; */
macro_line|#include &quot;ksymoops.h&quot;
macro_line|#include &lt;errno.h&gt;
macro_line|#include &lt;malloc.h&gt;
macro_line|#include &lt;string.h&gt;
macro_line|#include &lt;sys/stat.h&gt;
DECL|function|regular_file
r_int
id|regular_file
c_func
(paren
r_const
r_char
op_star
id|file
comma
r_const
r_char
op_star
id|msg
)paren
(brace
r_struct
id|stat
id|statbuf
suffix:semicolon
r_if
c_cond
(paren
id|stat
c_func
(paren
id|file
comma
op_amp
id|statbuf
)paren
)paren
(brace
id|fprintf
c_func
(paren
id|stderr
comma
l_string|&quot;%s: %s stat %s failed&quot;
comma
id|prefix
comma
id|msg
comma
id|file
)paren
suffix:semicolon
id|perror
c_func
(paren
l_string|&quot; &quot;
)paren
suffix:semicolon
op_increment
id|errors
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|S_ISREG
c_func
(paren
id|statbuf.st_mode
)paren
)paren
(brace
id|fprintf
c_func
(paren
id|stderr
comma
l_string|&quot;%s: %s %s is not a regular file, ignored&bslash;n&quot;
comma
id|prefix
comma
id|msg
comma
id|file
)paren
suffix:semicolon
op_increment
id|errors
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_return
l_int|1
suffix:semicolon
)brace
DECL|function|fopen_local
id|FILE
op_star
id|fopen_local
c_func
(paren
r_const
r_char
op_star
id|file
comma
r_const
r_char
op_star
id|mode
comma
r_const
r_char
op_star
id|msg
)paren
(brace
id|FILE
op_star
id|f
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|f
op_assign
id|fopen
c_func
(paren
id|file
comma
id|mode
)paren
)paren
)paren
(brace
id|fprintf
c_func
(paren
id|stderr
comma
l_string|&quot;%s: %s fopen &squot;%s&squot; failed&quot;
comma
id|prefix
comma
id|msg
comma
id|file
)paren
suffix:semicolon
id|perror
c_func
(paren
l_string|&quot; &quot;
)paren
suffix:semicolon
op_increment
id|errors
suffix:semicolon
)brace
r_return
id|f
suffix:semicolon
)brace
DECL|function|fclose_local
r_void
id|fclose_local
c_func
(paren
id|FILE
op_star
id|f
comma
r_const
r_char
op_star
id|msg
)paren
(brace
r_int
id|i
suffix:semicolon
r_if
c_cond
(paren
(paren
id|i
op_assign
id|fclose
c_func
(paren
id|f
)paren
)paren
)paren
(brace
id|fprintf
c_func
(paren
id|stderr
comma
l_string|&quot;%s: %s fclose failed %d&quot;
comma
id|prefix
comma
id|msg
comma
id|i
)paren
suffix:semicolon
id|perror
c_func
(paren
l_string|&quot; &quot;
)paren
suffix:semicolon
op_increment
id|errors
suffix:semicolon
)brace
)brace
multiline_comment|/* Read a line, increasing the size of the line as necessary until &bslash;n is read */
DECL|macro|INCREMENT
mdefine_line|#define INCREMENT 10&t;/* arbitrary */
DECL|function|fgets_local
r_char
op_star
id|fgets_local
c_func
(paren
r_char
op_star
op_star
id|line
comma
r_int
op_star
id|size
comma
id|FILE
op_star
id|f
comma
r_const
r_char
op_star
id|msg
)paren
(brace
r_char
op_star
id|l
comma
op_star
id|p
comma
op_star
id|r
suffix:semicolon
r_int
id|longline
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
op_star
id|line
)paren
(brace
op_star
id|size
op_assign
id|INCREMENT
suffix:semicolon
op_star
id|line
op_assign
id|malloc
c_func
(paren
op_star
id|size
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
op_star
id|line
)paren
id|malloc_error
c_func
(paren
l_string|&quot;fgets_local alloc line&quot;
)paren
suffix:semicolon
)brace
id|l
op_assign
op_star
id|line
suffix:semicolon
r_while
c_loop
(paren
id|longline
)paren
(brace
id|r
op_assign
id|fgets
c_func
(paren
id|l
comma
op_star
id|size
op_minus
(paren
id|l
op_minus
op_star
id|line
)paren
comma
id|f
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|r
)paren
(brace
r_if
c_cond
(paren
id|ferror
c_func
(paren
id|f
)paren
)paren
(brace
id|fprintf
c_func
(paren
id|stderr
comma
l_string|&quot;%s: %s fgets failed&quot;
comma
id|prefix
comma
id|msg
)paren
suffix:semicolon
id|perror
c_func
(paren
l_string|&quot; &quot;
)paren
suffix:semicolon
op_increment
id|errors
suffix:semicolon
)brace
r_if
c_cond
(paren
id|l
op_ne
op_star
id|line
)paren
r_return
op_star
id|line
suffix:semicolon
r_else
r_return
id|r
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|p
op_assign
id|strchr
c_func
(paren
op_star
id|line
comma
l_char|&squot;&bslash;n&squot;
)paren
)paren
)paren
(brace
op_star
id|size
op_add_assign
id|INCREMENT
suffix:semicolon
op_star
id|line
op_assign
id|realloc
c_func
(paren
op_star
id|line
comma
op_star
id|size
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
op_star
id|line
)paren
id|malloc_error
c_func
(paren
l_string|&quot;fgets_local realloc line&quot;
)paren
suffix:semicolon
id|l
op_assign
op_star
id|line
op_plus
op_star
id|size
op_minus
id|INCREMENT
op_minus
l_int|1
suffix:semicolon
)brace
r_else
(brace
op_star
id|p
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
id|longline
op_assign
l_int|0
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|debug
OG
l_int|3
)paren
id|fprintf
c_func
(paren
id|stderr
comma
l_string|&quot;DEBUG: %s line &squot;%s&squot;&bslash;n&quot;
comma
id|msg
comma
op_star
id|line
)paren
suffix:semicolon
r_return
op_star
id|line
suffix:semicolon
)brace
DECL|function|popen_local
id|FILE
op_star
id|popen_local
c_func
(paren
r_const
r_char
op_star
id|cmd
comma
r_const
r_char
op_star
id|msg
)paren
(brace
id|FILE
op_star
id|f
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|f
op_assign
id|popen
c_func
(paren
id|cmd
comma
l_string|&quot;r&quot;
)paren
)paren
)paren
(brace
id|fprintf
c_func
(paren
id|stderr
comma
l_string|&quot;%s: %s popen &squot;%s&squot; failed&quot;
comma
id|prefix
comma
id|msg
comma
id|cmd
)paren
suffix:semicolon
id|perror
c_func
(paren
l_string|&quot; &quot;
)paren
suffix:semicolon
op_increment
id|errors
suffix:semicolon
)brace
r_return
id|f
suffix:semicolon
)brace
DECL|function|pclose_local
r_void
id|pclose_local
c_func
(paren
id|FILE
op_star
id|f
comma
r_const
r_char
op_star
id|msg
)paren
(brace
r_int
id|i
suffix:semicolon
id|errno
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
(paren
id|i
op_assign
id|pclose
c_func
(paren
id|f
)paren
)paren
)paren
(brace
id|fprintf
c_func
(paren
id|stderr
comma
l_string|&quot;%s: %s pclose failed 0x%x&quot;
comma
id|prefix
comma
id|msg
comma
id|i
)paren
suffix:semicolon
r_if
c_cond
(paren
id|errno
)paren
id|perror
c_func
(paren
l_string|&quot; &quot;
)paren
suffix:semicolon
r_else
id|fprintf
c_func
(paren
id|stderr
comma
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
op_increment
id|errors
suffix:semicolon
)brace
)brace
eof
