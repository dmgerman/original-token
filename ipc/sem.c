multiline_comment|/*&n; * linux/ipc/sem.c&n; * Copyright (C) 1992 Krishna Balasubramanian &n; */
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;asm/segment.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/sem.h&gt;
macro_line|#include &lt;linux/ipc.h&gt;
r_extern
r_int
id|ipcperms
(paren
r_struct
id|ipc_perm
op_star
id|ipcp
comma
r_int
id|semflg
)paren
suffix:semicolon
r_static
r_int
id|newary
(paren
id|key_t
comma
r_int
comma
r_int
)paren
suffix:semicolon
r_static
r_int
id|findkey
(paren
id|key_t
id|key
)paren
suffix:semicolon
r_static
r_void
id|freeary
(paren
r_int
id|id
)paren
suffix:semicolon
DECL|variable|semary
r_static
r_struct
id|semid_ds
op_star
id|semary
(braket
id|SEMMNI
)braket
suffix:semicolon
DECL|variable|used_sems
DECL|variable|used_semids
r_static
r_int
id|used_sems
op_assign
l_int|0
comma
id|used_semids
op_assign
l_int|0
suffix:semicolon
DECL|variable|sem_lock
r_static
r_struct
id|wait_queue
op_star
id|sem_lock
op_assign
l_int|NULL
suffix:semicolon
DECL|variable|sem_seq
r_static
r_int
id|sem_seq
op_assign
l_int|0
suffix:semicolon
DECL|variable|max_semid
r_static
r_int
id|max_semid
op_assign
l_int|0
suffix:semicolon
DECL|function|sem_init
r_void
id|sem_init
(paren
r_void
)paren
(brace
r_int
id|i
op_assign
l_int|0
suffix:semicolon
id|sem_lock
op_assign
l_int|NULL
suffix:semicolon
id|used_sems
op_assign
id|used_semids
op_assign
id|max_semid
op_assign
id|sem_seq
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|SEMMNI
suffix:semicolon
id|i
op_increment
)paren
id|semary
(braket
id|i
)braket
op_assign
id|IPC_UNUSED
suffix:semicolon
r_return
suffix:semicolon
)brace
DECL|function|findkey
r_static
r_int
id|findkey
(paren
id|key_t
id|key
)paren
(brace
r_int
id|id
suffix:semicolon
r_struct
id|semid_ds
op_star
id|sma
suffix:semicolon
r_for
c_loop
(paren
id|id
op_assign
l_int|0
suffix:semicolon
id|id
op_le
id|max_semid
suffix:semicolon
id|id
op_increment
)paren
(brace
r_while
c_loop
(paren
(paren
id|sma
op_assign
id|semary
(braket
id|id
)braket
)paren
op_eq
id|IPC_NOID
)paren
id|interruptible_sleep_on
(paren
op_amp
id|sem_lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sma
op_eq
id|IPC_UNUSED
)paren
r_continue
suffix:semicolon
r_if
c_cond
(paren
id|key
op_eq
id|sma-&gt;sem_perm.key
)paren
r_return
id|id
suffix:semicolon
)brace
r_return
op_minus
l_int|1
suffix:semicolon
)brace
DECL|function|newary
r_static
r_int
id|newary
(paren
id|key_t
id|key
comma
r_int
id|nsems
comma
r_int
id|semflg
)paren
(brace
r_int
id|id
suffix:semicolon
r_struct
id|semid_ds
op_star
id|sma
suffix:semicolon
r_struct
id|ipc_perm
op_star
id|ipcp
suffix:semicolon
r_int
id|size
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|nsems
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|used_sems
op_plus
id|nsems
OG
id|SEMMNS
)paren
r_return
op_minus
id|ENOSPC
suffix:semicolon
r_for
c_loop
(paren
id|id
op_assign
l_int|0
suffix:semicolon
id|id
OL
id|SEMMNI
suffix:semicolon
id|id
op_increment
)paren
r_if
c_cond
(paren
id|semary
(braket
id|id
)braket
op_eq
id|IPC_UNUSED
)paren
(brace
id|semary
(braket
id|id
)braket
op_assign
id|IPC_NOID
suffix:semicolon
r_goto
id|found
suffix:semicolon
)brace
r_return
op_minus
id|ENOSPC
suffix:semicolon
id|found
suffix:colon
id|size
op_assign
r_sizeof
(paren
op_star
id|sma
)paren
op_plus
id|nsems
op_star
r_sizeof
(paren
r_struct
id|sem
)paren
suffix:semicolon
id|used_sems
op_add_assign
id|nsems
suffix:semicolon
id|sma
op_assign
(paren
r_struct
id|semid_ds
op_star
)paren
id|kmalloc
(paren
id|size
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|sma
)paren
(brace
id|semary
(braket
id|id
)braket
op_assign
id|IPC_UNUSED
suffix:semicolon
id|used_sems
op_sub_assign
id|nsems
suffix:semicolon
r_if
c_cond
(paren
id|sem_lock
)paren
id|wake_up
(paren
op_amp
id|sem_lock
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|memset
(paren
id|sma
comma
l_int|0
comma
id|size
)paren
suffix:semicolon
id|sma-&gt;sem_base
op_assign
(paren
r_struct
id|sem
op_star
)paren
op_amp
id|sma
(braket
l_int|1
)braket
suffix:semicolon
id|ipcp
op_assign
op_amp
id|sma-&gt;sem_perm
suffix:semicolon
id|ipcp-&gt;mode
op_assign
(paren
id|semflg
op_amp
l_int|0x01FF
)paren
suffix:semicolon
id|ipcp-&gt;key
op_assign
id|key
suffix:semicolon
id|ipcp-&gt;cuid
op_assign
id|ipcp-&gt;uid
op_assign
id|current-&gt;euid
suffix:semicolon
id|ipcp-&gt;gid
op_assign
id|ipcp-&gt;cgid
op_assign
id|current-&gt;egid
suffix:semicolon
id|ipcp-&gt;seq
op_assign
id|sem_seq
suffix:semicolon
id|sma-&gt;eventn
op_assign
id|sma-&gt;eventz
op_assign
l_int|NULL
suffix:semicolon
id|sma-&gt;sem_nsems
op_assign
id|nsems
suffix:semicolon
id|sma-&gt;sem_ctime
op_assign
id|CURRENT_TIME
suffix:semicolon
r_if
c_cond
(paren
id|id
OG
id|max_semid
)paren
id|max_semid
op_assign
id|id
suffix:semicolon
id|used_semids
op_increment
suffix:semicolon
id|semary
(braket
id|id
)braket
op_assign
id|sma
suffix:semicolon
r_if
c_cond
(paren
id|sem_lock
)paren
id|wake_up
(paren
op_amp
id|sem_lock
)paren
suffix:semicolon
r_return
id|sem_seq
op_star
id|SEMMNI
op_plus
id|id
suffix:semicolon
)brace
DECL|function|sys_semget
r_int
id|sys_semget
(paren
id|key_t
id|key
comma
r_int
id|nsems
comma
r_int
id|semflg
)paren
(brace
r_int
id|id
suffix:semicolon
r_struct
id|semid_ds
op_star
id|sma
suffix:semicolon
r_if
c_cond
(paren
id|nsems
template_param
id|SEMMSL
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|key
op_eq
id|IPC_PRIVATE
)paren
r_return
id|newary
c_func
(paren
id|key
comma
id|nsems
comma
id|semflg
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|id
op_assign
id|findkey
(paren
id|key
)paren
)paren
op_eq
op_minus
l_int|1
)paren
(brace
multiline_comment|/* key not used */
r_if
c_cond
(paren
op_logical_neg
(paren
id|semflg
op_amp
id|IPC_CREAT
)paren
)paren
r_return
op_minus
id|ENOENT
suffix:semicolon
r_return
id|newary
c_func
(paren
id|key
comma
id|nsems
comma
id|semflg
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|semflg
op_amp
id|IPC_CREAT
op_logical_and
id|semflg
op_amp
id|IPC_EXCL
)paren
r_return
op_minus
id|EEXIST
suffix:semicolon
id|sma
op_assign
id|semary
(braket
id|id
)braket
suffix:semicolon
r_if
c_cond
(paren
id|nsems
OG
id|sma-&gt;sem_nsems
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|ipcperms
c_func
(paren
op_amp
id|sma-&gt;sem_perm
comma
id|semflg
)paren
)paren
r_return
op_minus
id|EACCES
suffix:semicolon
r_return
id|sma-&gt;sem_perm.seq
op_star
id|SEMMNI
op_plus
id|id
suffix:semicolon
)brace
DECL|function|freeary
r_static
r_void
id|freeary
(paren
r_int
id|id
)paren
(brace
r_struct
id|semid_ds
op_star
id|sma
op_assign
id|semary
(braket
id|id
)braket
suffix:semicolon
id|sma-&gt;sem_perm.seq
op_increment
suffix:semicolon
r_if
c_cond
(paren
(paren
r_int
)paren
(paren
(paren
op_increment
id|sem_seq
op_plus
l_int|1
)paren
op_star
id|SEMMNI
)paren
OL
l_int|0
)paren
id|sem_seq
op_assign
l_int|0
suffix:semicolon
id|used_sems
op_sub_assign
id|sma-&gt;sem_nsems
suffix:semicolon
r_if
c_cond
(paren
id|id
op_eq
id|max_semid
)paren
r_while
c_loop
(paren
id|max_semid
op_logical_and
(paren
id|semary
(braket
op_decrement
id|max_semid
)braket
op_eq
id|IPC_UNUSED
)paren
)paren
suffix:semicolon
id|semary
(braket
id|id
)braket
op_assign
id|IPC_UNUSED
suffix:semicolon
id|used_semids
op_decrement
suffix:semicolon
r_while
c_loop
(paren
id|sma-&gt;eventz
op_logical_or
id|sma-&gt;eventn
)paren
(brace
r_if
c_cond
(paren
id|sma-&gt;eventz
)paren
id|wake_up
(paren
op_amp
id|sma-&gt;eventz
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sma-&gt;eventn
)paren
id|wake_up
(paren
op_amp
id|sma-&gt;eventn
)paren
suffix:semicolon
id|schedule
c_func
(paren
)paren
suffix:semicolon
)brace
id|kfree
(paren
id|sma
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
DECL|function|sys_semctl
r_int
id|sys_semctl
(paren
r_int
id|semid
comma
r_int
id|semnum
comma
r_int
id|cmd
comma
r_void
op_star
id|arg
)paren
(brace
r_int
id|i
comma
id|id
comma
id|val
op_assign
l_int|0
suffix:semicolon
r_struct
id|semid_ds
op_star
id|sma
comma
op_star
id|buf
comma
id|tbuf
suffix:semicolon
r_struct
id|ipc_perm
op_star
id|ipcp
suffix:semicolon
r_struct
id|sem
op_star
id|curr
suffix:semicolon
r_struct
id|sem_undo
op_star
id|un
suffix:semicolon
id|ushort
id|nsems
comma
op_star
id|array
op_assign
l_int|NULL
suffix:semicolon
id|ushort
id|sem_io
(braket
id|SEMMSL
)braket
suffix:semicolon
r_if
c_cond
(paren
id|semid
OL
l_int|0
op_logical_or
id|semnum
OL
l_int|0
op_logical_or
id|cmd
OL
l_int|0
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_switch
c_cond
(paren
id|cmd
)paren
(brace
r_case
id|IPC_INFO
suffix:colon
r_case
id|SEM_INFO
suffix:colon
(brace
r_struct
id|seminfo
id|seminfo
comma
op_star
id|tmp
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|arg
op_logical_or
op_logical_neg
(paren
id|tmp
op_assign
(paren
r_struct
id|seminfo
op_star
)paren
id|get_fs_long
(paren
id|arg
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
id|seminfo.semmni
op_assign
id|SEMMNI
suffix:semicolon
id|seminfo.semmns
op_assign
id|SEMMNS
suffix:semicolon
id|seminfo.semmsl
op_assign
id|SEMMSL
suffix:semicolon
id|seminfo.semopm
op_assign
id|SEMOPM
suffix:semicolon
id|seminfo.semvmx
op_assign
id|SEMVMX
suffix:semicolon
id|seminfo.semmnu
op_assign
id|SEMMNU
suffix:semicolon
id|seminfo.semmap
op_assign
id|SEMMAP
suffix:semicolon
id|seminfo.semume
op_assign
id|SEMUME
suffix:semicolon
id|seminfo.semusz
op_assign
id|SEMUSZ
suffix:semicolon
id|seminfo.semaem
op_assign
id|SEMAEM
suffix:semicolon
r_if
c_cond
(paren
id|cmd
op_eq
id|SEM_INFO
)paren
(brace
id|seminfo.semusz
op_assign
id|used_semids
suffix:semicolon
id|seminfo.semaem
op_assign
id|used_sems
suffix:semicolon
)brace
id|i
op_assign
id|verify_area
c_func
(paren
id|VERIFY_WRITE
comma
id|tmp
comma
r_sizeof
(paren
r_struct
id|seminfo
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
)paren
r_return
id|i
suffix:semicolon
id|memcpy_tofs
(paren
id|tmp
comma
op_amp
id|seminfo
comma
r_sizeof
(paren
r_struct
id|seminfo
)paren
)paren
suffix:semicolon
r_return
id|max_semid
suffix:semicolon
)brace
r_case
id|SEM_STAT
suffix:colon
r_if
c_cond
(paren
op_logical_neg
id|arg
op_logical_or
op_logical_neg
(paren
id|buf
op_assign
(paren
r_struct
id|semid_ds
op_star
)paren
id|get_fs_long
(paren
id|arg
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
id|i
op_assign
id|verify_area
(paren
id|VERIFY_WRITE
comma
id|buf
comma
r_sizeof
(paren
op_star
id|sma
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
)paren
r_return
id|i
suffix:semicolon
r_if
c_cond
(paren
id|semid
OG
id|max_semid
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|sma
op_assign
id|semary
(braket
id|semid
)braket
suffix:semicolon
r_if
c_cond
(paren
id|sma
op_eq
id|IPC_UNUSED
op_logical_or
id|sma
op_eq
id|IPC_NOID
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|ipcperms
(paren
op_amp
id|sma-&gt;sem_perm
comma
l_int|0444
)paren
)paren
r_return
op_minus
id|EACCES
suffix:semicolon
id|id
op_assign
id|semid
op_plus
id|sma-&gt;sem_perm.seq
op_star
id|SEMMNI
suffix:semicolon
id|memcpy_tofs
(paren
id|buf
comma
id|sma
comma
r_sizeof
(paren
op_star
id|sma
)paren
)paren
suffix:semicolon
r_return
id|id
suffix:semicolon
)brace
id|id
op_assign
id|semid
op_mod
id|SEMMNI
suffix:semicolon
id|sma
op_assign
id|semary
(braket
id|id
)braket
suffix:semicolon
r_if
c_cond
(paren
id|sma
op_eq
id|IPC_UNUSED
op_logical_or
id|sma
op_eq
id|IPC_NOID
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|ipcp
op_assign
op_amp
id|sma-&gt;sem_perm
suffix:semicolon
id|nsems
op_assign
id|sma-&gt;sem_nsems
suffix:semicolon
r_if
c_cond
(paren
id|ipcp-&gt;seq
op_ne
id|semid
op_div
id|SEMMNI
)paren
r_return
op_minus
id|EIDRM
suffix:semicolon
r_if
c_cond
(paren
id|semnum
op_ge
id|nsems
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|curr
op_assign
op_amp
id|sma-&gt;sem_base
(braket
id|semnum
)braket
suffix:semicolon
r_switch
c_cond
(paren
id|cmd
)paren
(brace
r_case
id|GETVAL
suffix:colon
r_case
id|GETPID
suffix:colon
r_case
id|GETNCNT
suffix:colon
r_case
id|GETZCNT
suffix:colon
r_case
id|GETALL
suffix:colon
r_if
c_cond
(paren
id|ipcperms
(paren
id|ipcp
comma
l_int|0444
)paren
)paren
r_return
op_minus
id|EACCES
suffix:semicolon
r_switch
c_cond
(paren
id|cmd
)paren
(brace
r_case
id|GETVAL
suffix:colon
r_return
id|curr-&gt;semval
suffix:semicolon
r_case
id|GETPID
suffix:colon
r_return
id|curr-&gt;sempid
suffix:semicolon
r_case
id|GETNCNT
suffix:colon
r_return
id|curr-&gt;semncnt
suffix:semicolon
r_case
id|GETZCNT
suffix:colon
r_return
id|curr-&gt;semzcnt
suffix:semicolon
r_case
id|GETALL
suffix:colon
r_if
c_cond
(paren
op_logical_neg
id|arg
op_logical_or
op_logical_neg
(paren
id|array
op_assign
(paren
id|ushort
op_star
)paren
id|get_fs_long
(paren
id|arg
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
id|i
op_assign
id|verify_area
(paren
id|VERIFY_WRITE
comma
id|array
comma
id|nsems
op_star
r_sizeof
(paren
r_int
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
)paren
r_return
id|i
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|SETVAL
suffix:colon
r_if
c_cond
(paren
op_logical_neg
id|arg
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_if
c_cond
(paren
(paren
id|val
op_assign
(paren
r_int
)paren
id|get_fs_long
(paren
id|arg
)paren
)paren
OG
id|SEMVMX
op_logical_or
id|val
OL
l_int|0
)paren
r_return
op_minus
id|ERANGE
suffix:semicolon
r_break
suffix:semicolon
r_case
id|IPC_RMID
suffix:colon
r_if
c_cond
(paren
id|suser
c_func
(paren
)paren
op_logical_or
id|current-&gt;euid
op_eq
id|ipcp-&gt;cuid
op_logical_or
id|current-&gt;euid
op_eq
id|ipcp-&gt;uid
)paren
(brace
id|freeary
(paren
id|id
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_return
op_minus
id|EPERM
suffix:semicolon
r_case
id|SETALL
suffix:colon
multiline_comment|/* arg is a pointer to an array of ushort */
r_if
c_cond
(paren
op_logical_neg
id|arg
op_logical_or
op_logical_neg
(paren
id|array
op_assign
(paren
id|ushort
op_star
)paren
id|get_fs_long
(paren
id|arg
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_if
c_cond
(paren
(paren
id|i
op_assign
id|verify_area
(paren
id|VERIFY_READ
comma
id|array
comma
r_sizeof
id|tbuf
)paren
)paren
)paren
r_return
id|i
suffix:semicolon
id|memcpy_fromfs
(paren
id|sem_io
comma
id|array
comma
id|nsems
op_star
r_sizeof
(paren
id|ushort
)paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|nsems
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
id|sem_io
(braket
id|i
)braket
OG
id|SEMVMX
)paren
r_return
op_minus
id|ERANGE
suffix:semicolon
r_break
suffix:semicolon
r_case
id|IPC_STAT
suffix:colon
r_if
c_cond
(paren
op_logical_neg
id|arg
op_logical_or
op_logical_neg
(paren
id|buf
op_assign
(paren
r_struct
id|semid_ds
op_star
)paren
id|get_fs_long
(paren
id|arg
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_if
c_cond
(paren
(paren
id|i
op_assign
id|verify_area
(paren
id|VERIFY_WRITE
comma
id|arg
comma
r_sizeof
id|tbuf
)paren
)paren
)paren
r_return
id|i
suffix:semicolon
r_break
suffix:semicolon
r_case
id|IPC_SET
suffix:colon
r_if
c_cond
(paren
op_logical_neg
id|arg
op_logical_or
op_logical_neg
(paren
id|buf
op_assign
(paren
r_struct
id|semid_ds
op_star
)paren
id|get_fs_long
(paren
id|arg
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_if
c_cond
(paren
(paren
id|i
op_assign
id|verify_area
(paren
id|VERIFY_READ
comma
id|buf
comma
r_sizeof
id|tbuf
)paren
)paren
)paren
r_return
id|i
suffix:semicolon
id|memcpy_fromfs
(paren
op_amp
id|tbuf
comma
id|buf
comma
r_sizeof
id|tbuf
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|semary
(braket
id|id
)braket
op_eq
id|IPC_UNUSED
op_logical_or
id|semary
(braket
id|id
)braket
op_eq
id|IPC_NOID
)paren
r_return
op_minus
id|EIDRM
suffix:semicolon
r_if
c_cond
(paren
id|ipcp-&gt;seq
op_ne
id|semid
op_div
id|SEMMNI
)paren
r_return
op_minus
id|EIDRM
suffix:semicolon
r_switch
c_cond
(paren
id|cmd
)paren
(brace
r_case
id|GETALL
suffix:colon
r_if
c_cond
(paren
id|ipcperms
(paren
id|ipcp
comma
l_int|0444
)paren
)paren
r_return
op_minus
id|EACCES
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|sma-&gt;sem_nsems
suffix:semicolon
id|i
op_increment
)paren
id|sem_io
(braket
id|i
)braket
op_assign
id|sma-&gt;sem_base
(braket
id|i
)braket
dot
id|semval
suffix:semicolon
id|memcpy_tofs
(paren
id|array
comma
id|sem_io
comma
id|nsems
op_star
r_sizeof
(paren
id|ushort
)paren
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SETVAL
suffix:colon
r_if
c_cond
(paren
id|ipcperms
(paren
id|ipcp
comma
l_int|0222
)paren
)paren
r_return
op_minus
id|EACCES
suffix:semicolon
r_for
c_loop
(paren
id|un
op_assign
id|sma-&gt;undo
suffix:semicolon
id|un
suffix:semicolon
id|un
op_assign
id|un-&gt;id_next
)paren
r_if
c_cond
(paren
id|semnum
op_eq
id|un-&gt;sem_num
)paren
id|un-&gt;semadj
op_assign
l_int|0
suffix:semicolon
id|sma-&gt;sem_ctime
op_assign
id|CURRENT_TIME
suffix:semicolon
id|curr-&gt;semval
op_assign
id|val
suffix:semicolon
r_if
c_cond
(paren
id|sma-&gt;eventn
)paren
id|wake_up
(paren
op_amp
id|sma-&gt;eventn
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sma-&gt;eventz
)paren
id|wake_up
(paren
op_amp
id|sma-&gt;eventz
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|IPC_SET
suffix:colon
r_if
c_cond
(paren
id|suser
c_func
(paren
)paren
op_logical_or
id|current-&gt;euid
op_eq
id|ipcp-&gt;cuid
op_logical_or
id|current-&gt;euid
op_eq
id|ipcp-&gt;uid
)paren
(brace
id|ipcp-&gt;uid
op_assign
id|tbuf.sem_perm.uid
suffix:semicolon
id|ipcp-&gt;gid
op_assign
id|tbuf.sem_perm.gid
suffix:semicolon
id|ipcp-&gt;mode
op_assign
(paren
id|ipcp-&gt;mode
op_amp
op_complement
l_int|0777
)paren
op_or
(paren
id|tbuf.sem_perm.mode
op_amp
l_int|0777
)paren
suffix:semicolon
id|sma-&gt;sem_ctime
op_assign
id|CURRENT_TIME
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_return
op_minus
id|EPERM
suffix:semicolon
r_case
id|IPC_STAT
suffix:colon
r_if
c_cond
(paren
id|ipcperms
(paren
id|ipcp
comma
l_int|0444
)paren
)paren
r_return
op_minus
id|EACCES
suffix:semicolon
id|memcpy_tofs
(paren
id|buf
comma
id|sma
comma
r_sizeof
(paren
op_star
id|sma
)paren
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SETALL
suffix:colon
r_if
c_cond
(paren
id|ipcperms
(paren
id|ipcp
comma
l_int|0222
)paren
)paren
r_return
op_minus
id|EACCES
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|nsems
suffix:semicolon
id|i
op_increment
)paren
id|sma-&gt;sem_base
(braket
id|i
)braket
dot
id|semval
op_assign
id|sem_io
(braket
id|i
)braket
suffix:semicolon
r_for
c_loop
(paren
id|un
op_assign
id|sma-&gt;undo
suffix:semicolon
id|un
op_ne
l_int|NULL
suffix:semicolon
id|un
op_assign
id|un-&gt;id_next
)paren
id|un-&gt;semadj
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|sma-&gt;eventn
)paren
id|wake_up
(paren
op_amp
id|sma-&gt;eventn
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sma-&gt;eventz
)paren
id|wake_up
(paren
op_amp
id|sma-&gt;eventz
)paren
suffix:semicolon
id|sma-&gt;sem_ctime
op_assign
id|CURRENT_TIME
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|sys_semop
r_int
id|sys_semop
(paren
r_int
id|semid
comma
r_struct
id|sembuf
op_star
id|tsops
comma
r_int
id|nsops
)paren
(brace
r_int
id|i
comma
id|id
suffix:semicolon
r_struct
id|semid_ds
op_star
id|sma
suffix:semicolon
r_struct
id|sem
op_star
id|curr
op_assign
l_int|NULL
suffix:semicolon
r_struct
id|sembuf
id|sops
(braket
id|SEMOPM
)braket
comma
op_star
id|sop
suffix:semicolon
r_struct
id|sem_undo
op_star
id|un
suffix:semicolon
r_int
id|undos
op_assign
l_int|0
comma
id|alter
op_assign
l_int|0
comma
id|semncnt
op_assign
l_int|0
comma
id|semzcnt
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|nsops
OL
l_int|1
op_logical_or
id|semid
OL
l_int|0
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|nsops
OG
id|SEMOPM
)paren
r_return
op_minus
id|E2BIG
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|tsops
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
id|memcpy_fromfs
(paren
id|sops
comma
id|tsops
comma
id|nsops
op_star
r_sizeof
(paren
op_star
id|tsops
)paren
)paren
suffix:semicolon
id|id
op_assign
id|semid
op_mod
id|SEMMNI
suffix:semicolon
r_if
c_cond
(paren
(paren
id|sma
op_assign
id|semary
(braket
id|id
)braket
)paren
op_eq
id|IPC_UNUSED
op_logical_or
id|sma
op_eq
id|IPC_NOID
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|nsops
suffix:semicolon
id|i
op_increment
)paren
(brace
id|sop
op_assign
op_amp
id|sops
(braket
id|i
)braket
suffix:semicolon
r_if
c_cond
(paren
id|sop-&gt;sem_num
OG
id|sma-&gt;sem_nsems
)paren
r_return
op_minus
id|EFBIG
suffix:semicolon
r_if
c_cond
(paren
id|sop-&gt;sem_flg
op_amp
id|SEM_UNDO
)paren
id|undos
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|sop-&gt;sem_op
)paren
(brace
id|alter
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|sop-&gt;sem_op
OG
l_int|0
)paren
id|semncnt
op_increment
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|ipcperms
c_func
(paren
op_amp
id|sma-&gt;sem_perm
comma
id|alter
ques
c_cond
l_int|0222
suffix:colon
l_int|0444
)paren
)paren
r_return
op_minus
id|EACCES
suffix:semicolon
multiline_comment|/* &n;&t; * ensure every sop with undo gets an undo structure &n;&t; */
r_if
c_cond
(paren
id|undos
)paren
(brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|nsops
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|sops
(braket
id|i
)braket
dot
id|sem_flg
op_amp
id|SEM_UNDO
)paren
)paren
r_continue
suffix:semicolon
r_for
c_loop
(paren
id|un
op_assign
id|current-&gt;semun
suffix:semicolon
id|un
suffix:semicolon
id|un
op_assign
id|un-&gt;proc_next
)paren
r_if
c_cond
(paren
(paren
id|un-&gt;semid
op_eq
id|semid
)paren
op_logical_and
(paren
id|un-&gt;sem_num
op_eq
id|sops
(braket
id|i
)braket
dot
id|sem_num
)paren
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
id|un
)paren
r_continue
suffix:semicolon
id|un
op_assign
(paren
r_struct
id|sem_undo
op_star
)paren
id|kmalloc
(paren
r_sizeof
(paren
op_star
id|un
)paren
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|un
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
multiline_comment|/* freed on exit */
id|un-&gt;semid
op_assign
id|semid
suffix:semicolon
id|un-&gt;semadj
op_assign
l_int|0
suffix:semicolon
id|un-&gt;sem_num
op_assign
id|sops
(braket
id|i
)braket
dot
id|sem_num
suffix:semicolon
id|un-&gt;proc_next
op_assign
id|current-&gt;semun
suffix:semicolon
id|current-&gt;semun
op_assign
id|un
suffix:semicolon
id|un-&gt;id_next
op_assign
id|sma-&gt;undo
suffix:semicolon
r_if
c_cond
(paren
id|sma-&gt;undo
)paren
id|sma-&gt;undo-&gt;id_prev
op_assign
id|un
suffix:semicolon
id|sma-&gt;undo
op_assign
id|un-&gt;id_prev
op_assign
id|un
suffix:semicolon
)brace
)brace
id|slept
suffix:colon
r_if
c_cond
(paren
id|sma-&gt;sem_perm.seq
op_ne
id|semid
op_div
id|SEMMNI
)paren
r_return
op_minus
id|EIDRM
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|nsops
suffix:semicolon
id|i
op_increment
)paren
(brace
id|sop
op_assign
op_amp
id|sops
(braket
id|i
)braket
suffix:semicolon
id|curr
op_assign
op_amp
id|sma-&gt;sem_base
(braket
id|sop-&gt;sem_num
)braket
suffix:semicolon
r_if
c_cond
(paren
id|sop-&gt;sem_op
op_plus
id|curr-&gt;semval
OG
id|SEMVMX
)paren
r_return
op_minus
id|ERANGE
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|sop-&gt;sem_op
op_logical_and
id|curr-&gt;semval
)paren
(brace
r_if
c_cond
(paren
id|sop-&gt;sem_flg
op_amp
id|IPC_NOWAIT
)paren
r_return
op_minus
id|EAGAIN
suffix:semicolon
r_if
c_cond
(paren
id|current-&gt;signal
op_amp
op_complement
id|current-&gt;blocked
)paren
r_return
op_minus
id|EINTR
suffix:semicolon
id|curr-&gt;semzcnt
op_increment
suffix:semicolon
id|interruptible_sleep_on
(paren
op_amp
id|sma-&gt;eventz
)paren
suffix:semicolon
id|curr-&gt;semzcnt
op_decrement
suffix:semicolon
r_goto
id|slept
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|sop-&gt;sem_op
op_plus
id|curr-&gt;semval
OL
l_int|0
)paren
)paren
(brace
r_if
c_cond
(paren
id|sop-&gt;sem_flg
op_amp
id|IPC_NOWAIT
)paren
r_return
op_minus
id|EAGAIN
suffix:semicolon
r_if
c_cond
(paren
id|current-&gt;signal
op_amp
op_complement
id|current-&gt;blocked
)paren
r_return
op_minus
id|EINTR
suffix:semicolon
id|curr-&gt;semncnt
op_increment
suffix:semicolon
id|interruptible_sleep_on
(paren
op_amp
id|sma-&gt;eventn
)paren
suffix:semicolon
id|curr-&gt;semncnt
op_decrement
suffix:semicolon
r_goto
id|slept
suffix:semicolon
)brace
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|nsops
suffix:semicolon
id|i
op_increment
)paren
(brace
id|sop
op_assign
op_amp
id|sops
(braket
id|i
)braket
suffix:semicolon
id|curr
op_assign
op_amp
id|sma-&gt;sem_base
(braket
id|sop-&gt;sem_num
)braket
suffix:semicolon
id|curr-&gt;sempid
op_assign
id|current-&gt;pid
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|curr-&gt;semval
op_add_assign
id|sop-&gt;sem_op
)paren
)paren
id|semzcnt
op_increment
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|sop-&gt;sem_flg
op_amp
id|SEM_UNDO
)paren
)paren
r_continue
suffix:semicolon
r_for
c_loop
(paren
id|un
op_assign
id|current-&gt;semun
suffix:semicolon
id|un
suffix:semicolon
id|un
op_assign
id|un-&gt;proc_next
)paren
r_if
c_cond
(paren
(paren
id|un-&gt;semid
op_eq
id|semid
)paren
op_logical_and
(paren
id|un-&gt;sem_num
op_eq
id|sop-&gt;sem_num
)paren
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|un
)paren
(brace
id|printk
(paren
l_string|&quot;semop : no undo for op %d&bslash;n&quot;
comma
id|i
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
id|un-&gt;semadj
op_sub_assign
id|sop-&gt;sem_op
suffix:semicolon
)brace
id|sma-&gt;sem_otime
op_assign
id|CURRENT_TIME
suffix:semicolon
r_if
c_cond
(paren
id|semncnt
op_logical_and
id|sma-&gt;eventn
)paren
id|wake_up
c_func
(paren
op_amp
id|sma-&gt;eventn
)paren
suffix:semicolon
r_if
c_cond
(paren
id|semzcnt
op_logical_and
id|sma-&gt;eventz
)paren
id|wake_up
c_func
(paren
op_amp
id|sma-&gt;eventz
)paren
suffix:semicolon
r_return
id|curr-&gt;semval
suffix:semicolon
)brace
multiline_comment|/*&n; * add semadj values to semaphores if alowed. Silently ignore errors!&n; */
DECL|function|sem_exit
r_void
id|sem_exit
(paren
r_void
)paren
(brace
r_struct
id|sem_undo
op_star
id|un
comma
op_star
id|tmp
suffix:semicolon
r_struct
id|semid_ds
op_star
id|sma
suffix:semicolon
r_struct
id|sem
op_star
id|sem
op_assign
l_int|NULL
suffix:semicolon
r_for
c_loop
(paren
id|un
op_assign
id|current-&gt;semun
suffix:semicolon
id|un
suffix:semicolon
id|kfree
c_func
(paren
id|un
)paren
comma
id|un
op_assign
id|tmp
)paren
(brace
id|un-&gt;id_prev-&gt;id_next
op_assign
id|un-&gt;id_next
suffix:semicolon
r_if
c_cond
(paren
id|un-&gt;id_next
)paren
id|un-&gt;id_next-&gt;id_prev
op_assign
id|un-&gt;id_prev
suffix:semicolon
id|tmp
op_assign
id|un-&gt;proc_next
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|un-&gt;semadj
)paren
r_continue
suffix:semicolon
id|sma
op_assign
id|semary
(braket
id|un-&gt;semid
op_mod
id|SEMMNI
)braket
suffix:semicolon
r_if
c_cond
(paren
id|sma
op_eq
id|IPC_UNUSED
op_logical_or
id|sma
op_eq
id|IPC_NOID
op_logical_or
id|sma-&gt;sem_perm.seq
op_ne
id|un-&gt;semid
op_div
id|SEMMNI
)paren
r_continue
suffix:semicolon
id|sem
op_assign
op_amp
id|sma-&gt;sem_base
(braket
id|un-&gt;sem_num
)braket
suffix:semicolon
r_if
c_cond
(paren
id|sem-&gt;semval
op_plus
id|un-&gt;semadj
op_ge
l_int|0
)paren
(brace
id|sem-&gt;semval
op_add_assign
id|un-&gt;semadj
suffix:semicolon
id|sem-&gt;sempid
op_assign
id|current-&gt;pid
suffix:semicolon
id|sma-&gt;sem_otime
op_assign
id|CURRENT_TIME
suffix:semicolon
r_if
c_cond
(paren
id|un-&gt;semadj
OG
l_int|0
op_logical_and
id|sma-&gt;eventn
)paren
id|wake_up
(paren
op_amp
id|sma-&gt;eventn
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|sem-&gt;semval
op_logical_and
id|sma-&gt;eventz
)paren
id|wake_up
(paren
op_amp
id|sma-&gt;eventz
)paren
suffix:semicolon
)brace
)brace
id|current-&gt;semun
op_assign
l_int|NULL
suffix:semicolon
r_return
suffix:semicolon
)brace
eof
