multiline_comment|/*&n; * linux/ipc/shm.c&n; * Copyright (C) 1992, 1993 Krishna Balasubramanian&n; *         Many improvements/fixes by Bruno Haible.&n; * Replaced `struct shm_desc&squot; by `struct vm_area_struct&squot;, July 1994.&n; */
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;asm/segment.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/mm.h&gt;
macro_line|#include &lt;linux/ipc.h&gt;
macro_line|#include &lt;linux/shm.h&gt;
macro_line|#include &lt;linux/stat.h&gt;
macro_line|#include &lt;linux/malloc.h&gt;
r_extern
r_int
id|ipcperms
(paren
r_struct
id|ipc_perm
op_star
id|ipcp
comma
r_int
id|shmflg
)paren
suffix:semicolon
r_extern
r_int
r_int
id|get_swap_page
(paren
r_void
)paren
suffix:semicolon
r_static
r_int
id|findkey
(paren
id|key_t
id|key
)paren
suffix:semicolon
r_static
r_int
id|newseg
(paren
id|key_t
id|key
comma
r_int
id|shmflg
comma
r_int
id|size
)paren
suffix:semicolon
r_static
r_int
id|shm_map
(paren
r_struct
id|vm_area_struct
op_star
id|shmd
comma
r_int
id|remap
)paren
suffix:semicolon
r_static
r_void
id|killseg
(paren
r_int
id|id
)paren
suffix:semicolon
r_static
r_void
id|shm_open
(paren
r_struct
id|vm_area_struct
op_star
id|shmd
)paren
suffix:semicolon
r_static
r_void
id|shm_close
(paren
r_struct
id|vm_area_struct
op_star
id|shmd
)paren
suffix:semicolon
r_static
r_int
r_int
id|shm_swap_in
(paren
r_struct
id|vm_area_struct
op_star
comma
r_int
r_int
comma
r_int
r_int
)paren
suffix:semicolon
DECL|variable|shm_tot
r_static
r_int
id|shm_tot
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* total number of shared memory pages */
DECL|variable|shm_rss
r_static
r_int
id|shm_rss
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* number of shared memory pages that are in memory */
DECL|variable|shm_swp
r_static
r_int
id|shm_swp
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* number of shared memory pages that are in swap */
DECL|variable|max_shmid
r_static
r_int
id|max_shmid
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* every used id is &lt;= max_shmid */
DECL|variable|shm_lock
r_static
r_struct
id|wait_queue
op_star
id|shm_lock
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/* calling findkey() may need to wait */
DECL|variable|shm_segs
r_static
r_struct
id|shmid_ds
op_star
id|shm_segs
(braket
id|SHMMNI
)braket
suffix:semicolon
DECL|variable|shm_seq
r_static
r_int
r_int
id|shm_seq
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* incremented, for recognizing stale ids */
multiline_comment|/* some statistics */
DECL|variable|swap_attempts
r_static
id|ulong
id|swap_attempts
op_assign
l_int|0
suffix:semicolon
DECL|variable|swap_successes
r_static
id|ulong
id|swap_successes
op_assign
l_int|0
suffix:semicolon
DECL|variable|used_segs
r_static
id|ulong
id|used_segs
op_assign
l_int|0
suffix:semicolon
DECL|function|shm_init
r_void
id|shm_init
(paren
r_void
)paren
(brace
r_int
id|id
suffix:semicolon
r_for
c_loop
(paren
id|id
op_assign
l_int|0
suffix:semicolon
id|id
OL
id|SHMMNI
suffix:semicolon
id|id
op_increment
)paren
id|shm_segs
(braket
id|id
)braket
op_assign
(paren
r_struct
id|shmid_ds
op_star
)paren
id|IPC_UNUSED
suffix:semicolon
id|shm_tot
op_assign
id|shm_rss
op_assign
id|shm_seq
op_assign
id|max_shmid
op_assign
id|used_segs
op_assign
l_int|0
suffix:semicolon
id|shm_lock
op_assign
l_int|NULL
suffix:semicolon
r_return
suffix:semicolon
)brace
DECL|function|findkey
r_static
r_int
id|findkey
(paren
id|key_t
id|key
)paren
(brace
r_int
id|id
suffix:semicolon
r_struct
id|shmid_ds
op_star
id|shp
suffix:semicolon
r_for
c_loop
(paren
id|id
op_assign
l_int|0
suffix:semicolon
id|id
op_le
id|max_shmid
suffix:semicolon
id|id
op_increment
)paren
(brace
r_while
c_loop
(paren
(paren
id|shp
op_assign
id|shm_segs
(braket
id|id
)braket
)paren
op_eq
id|IPC_NOID
)paren
id|sleep_on
(paren
op_amp
id|shm_lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|shp
op_eq
id|IPC_UNUSED
)paren
r_continue
suffix:semicolon
r_if
c_cond
(paren
id|key
op_eq
id|shp-&gt;shm_perm.key
)paren
r_return
id|id
suffix:semicolon
)brace
r_return
op_minus
l_int|1
suffix:semicolon
)brace
multiline_comment|/*&n; * allocate new shmid_ds and pgtable. protected by shm_segs[id] = NOID.&n; */
DECL|function|newseg
r_static
r_int
id|newseg
(paren
id|key_t
id|key
comma
r_int
id|shmflg
comma
r_int
id|size
)paren
(brace
r_struct
id|shmid_ds
op_star
id|shp
suffix:semicolon
r_int
id|numpages
op_assign
(paren
id|size
op_plus
id|PAGE_SIZE
op_minus
l_int|1
)paren
op_rshift
id|PAGE_SHIFT
suffix:semicolon
r_int
id|id
comma
id|i
suffix:semicolon
r_if
c_cond
(paren
id|size
OL
id|SHMMIN
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|shm_tot
op_plus
id|numpages
op_ge
id|SHMALL
)paren
r_return
op_minus
id|ENOSPC
suffix:semicolon
r_for
c_loop
(paren
id|id
op_assign
l_int|0
suffix:semicolon
id|id
OL
id|SHMMNI
suffix:semicolon
id|id
op_increment
)paren
r_if
c_cond
(paren
id|shm_segs
(braket
id|id
)braket
op_eq
id|IPC_UNUSED
)paren
(brace
id|shm_segs
(braket
id|id
)braket
op_assign
(paren
r_struct
id|shmid_ds
op_star
)paren
id|IPC_NOID
suffix:semicolon
r_goto
id|found
suffix:semicolon
)brace
r_return
op_minus
id|ENOSPC
suffix:semicolon
id|found
suffix:colon
id|shp
op_assign
(paren
r_struct
id|shmid_ds
op_star
)paren
id|kmalloc
(paren
r_sizeof
(paren
op_star
id|shp
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|shp
)paren
(brace
id|shm_segs
(braket
id|id
)braket
op_assign
(paren
r_struct
id|shmid_ds
op_star
)paren
id|IPC_UNUSED
suffix:semicolon
r_if
c_cond
(paren
id|shm_lock
)paren
id|wake_up
(paren
op_amp
id|shm_lock
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|shp-&gt;shm_pages
op_assign
(paren
id|ulong
op_star
)paren
id|kmalloc
(paren
id|numpages
op_star
r_sizeof
(paren
id|ulong
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|shp-&gt;shm_pages
)paren
(brace
id|shm_segs
(braket
id|id
)braket
op_assign
(paren
r_struct
id|shmid_ds
op_star
)paren
id|IPC_UNUSED
suffix:semicolon
r_if
c_cond
(paren
id|shm_lock
)paren
id|wake_up
(paren
op_amp
id|shm_lock
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|shp
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|numpages
suffix:semicolon
id|shp-&gt;shm_pages
(braket
id|i
op_increment
)braket
op_assign
l_int|0
)paren
suffix:semicolon
id|shm_tot
op_add_assign
id|numpages
suffix:semicolon
id|shp-&gt;shm_perm.key
op_assign
id|key
suffix:semicolon
id|shp-&gt;shm_perm.mode
op_assign
(paren
id|shmflg
op_amp
id|S_IRWXUGO
)paren
suffix:semicolon
id|shp-&gt;shm_perm.cuid
op_assign
id|shp-&gt;shm_perm.uid
op_assign
id|current-&gt;euid
suffix:semicolon
id|shp-&gt;shm_perm.cgid
op_assign
id|shp-&gt;shm_perm.gid
op_assign
id|current-&gt;egid
suffix:semicolon
id|shp-&gt;shm_perm.seq
op_assign
id|shm_seq
suffix:semicolon
id|shp-&gt;shm_segsz
op_assign
id|size
suffix:semicolon
id|shp-&gt;shm_cpid
op_assign
id|current-&gt;pid
suffix:semicolon
id|shp-&gt;attaches
op_assign
l_int|NULL
suffix:semicolon
id|shp-&gt;shm_lpid
op_assign
id|shp-&gt;shm_nattch
op_assign
l_int|0
suffix:semicolon
id|shp-&gt;shm_atime
op_assign
id|shp-&gt;shm_dtime
op_assign
l_int|0
suffix:semicolon
id|shp-&gt;shm_ctime
op_assign
id|CURRENT_TIME
suffix:semicolon
id|shp-&gt;shm_npages
op_assign
id|numpages
suffix:semicolon
r_if
c_cond
(paren
id|id
OG
id|max_shmid
)paren
id|max_shmid
op_assign
id|id
suffix:semicolon
id|shm_segs
(braket
id|id
)braket
op_assign
id|shp
suffix:semicolon
id|used_segs
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|shm_lock
)paren
id|wake_up
(paren
op_amp
id|shm_lock
)paren
suffix:semicolon
r_return
(paren
r_int
r_int
)paren
id|shp-&gt;shm_perm.seq
op_star
id|SHMMNI
op_plus
id|id
suffix:semicolon
)brace
DECL|function|sys_shmget
r_int
id|sys_shmget
(paren
id|key_t
id|key
comma
r_int
id|size
comma
r_int
id|shmflg
)paren
(brace
r_struct
id|shmid_ds
op_star
id|shp
suffix:semicolon
r_int
id|id
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|size
template_param
id|SHMMAX
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|key
op_eq
id|IPC_PRIVATE
)paren
r_return
id|newseg
c_func
(paren
id|key
comma
id|shmflg
comma
id|size
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|id
op_assign
id|findkey
(paren
id|key
)paren
)paren
op_eq
op_minus
l_int|1
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|shmflg
op_amp
id|IPC_CREAT
)paren
)paren
r_return
op_minus
id|ENOENT
suffix:semicolon
r_return
id|newseg
c_func
(paren
id|key
comma
id|shmflg
comma
id|size
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|shmflg
op_amp
id|IPC_CREAT
)paren
op_logical_and
(paren
id|shmflg
op_amp
id|IPC_EXCL
)paren
)paren
r_return
op_minus
id|EEXIST
suffix:semicolon
id|shp
op_assign
id|shm_segs
(braket
id|id
)braket
suffix:semicolon
r_if
c_cond
(paren
id|shp-&gt;shm_perm.mode
op_amp
id|SHM_DEST
)paren
r_return
op_minus
id|EIDRM
suffix:semicolon
r_if
c_cond
(paren
id|size
OG
id|shp-&gt;shm_segsz
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|ipcperms
(paren
op_amp
id|shp-&gt;shm_perm
comma
id|shmflg
)paren
)paren
r_return
op_minus
id|EACCES
suffix:semicolon
r_return
(paren
r_int
r_int
)paren
id|shp-&gt;shm_perm.seq
op_star
id|SHMMNI
op_plus
id|id
suffix:semicolon
)brace
multiline_comment|/*&n; * Only called after testing nattch and SHM_DEST.&n; * Here pages, pgtable and shmid_ds are freed.&n; */
DECL|function|killseg
r_static
r_void
id|killseg
(paren
r_int
id|id
)paren
(brace
r_struct
id|shmid_ds
op_star
id|shp
suffix:semicolon
r_int
id|i
comma
id|numpages
suffix:semicolon
id|ulong
id|page
suffix:semicolon
id|shp
op_assign
id|shm_segs
(braket
id|id
)braket
suffix:semicolon
r_if
c_cond
(paren
id|shp
op_eq
id|IPC_NOID
op_logical_or
id|shp
op_eq
id|IPC_UNUSED
)paren
(brace
id|printk
(paren
l_string|&quot;shm nono: killseg called on unused seg id=%d&bslash;n&quot;
comma
id|id
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|shp-&gt;shm_perm.seq
op_increment
suffix:semicolon
multiline_comment|/* for shmat */
id|shm_seq
op_assign
(paren
id|shm_seq
op_plus
l_int|1
)paren
op_mod
(paren
(paren
r_int
)paren
(paren
l_int|1
op_lshift
l_int|31
)paren
op_div
id|SHMMNI
)paren
suffix:semicolon
multiline_comment|/* increment, but avoid overflow */
id|shm_segs
(braket
id|id
)braket
op_assign
(paren
r_struct
id|shmid_ds
op_star
)paren
id|IPC_UNUSED
suffix:semicolon
id|used_segs
op_decrement
suffix:semicolon
r_if
c_cond
(paren
id|id
op_eq
id|max_shmid
)paren
r_while
c_loop
(paren
id|max_shmid
op_logical_and
(paren
id|shm_segs
(braket
op_decrement
id|max_shmid
)braket
op_eq
id|IPC_UNUSED
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|shp-&gt;shm_pages
)paren
(brace
id|printk
(paren
l_string|&quot;shm nono: killseg shp-&gt;pages=NULL. id=%d&bslash;n&quot;
comma
id|id
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|numpages
op_assign
id|shp-&gt;shm_npages
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|numpages
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|page
op_assign
id|shp-&gt;shm_pages
(braket
id|i
)braket
)paren
)paren
r_continue
suffix:semicolon
r_if
c_cond
(paren
id|page
op_amp
id|PAGE_PRESENT
)paren
(brace
id|free_page
(paren
id|page
op_amp
id|PAGE_MASK
)paren
suffix:semicolon
id|shm_rss
op_decrement
suffix:semicolon
)brace
r_else
(brace
id|swap_free
(paren
id|page
)paren
suffix:semicolon
id|shm_swp
op_decrement
suffix:semicolon
)brace
)brace
id|kfree
c_func
(paren
id|shp-&gt;shm_pages
)paren
suffix:semicolon
id|shm_tot
op_sub_assign
id|numpages
suffix:semicolon
id|kfree
c_func
(paren
id|shp
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
DECL|function|sys_shmctl
r_int
id|sys_shmctl
(paren
r_int
id|shmid
comma
r_int
id|cmd
comma
r_struct
id|shmid_ds
op_star
id|buf
)paren
(brace
r_struct
id|shmid_ds
id|tbuf
suffix:semicolon
r_struct
id|shmid_ds
op_star
id|shp
suffix:semicolon
r_struct
id|ipc_perm
op_star
id|ipcp
suffix:semicolon
r_int
id|id
comma
id|err
suffix:semicolon
r_if
c_cond
(paren
id|cmd
OL
l_int|0
op_logical_or
id|shmid
OL
l_int|0
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|cmd
op_eq
id|IPC_SET
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|buf
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
id|err
op_assign
id|verify_area
(paren
id|VERIFY_READ
comma
id|buf
comma
r_sizeof
(paren
op_star
id|buf
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
r_return
id|err
suffix:semicolon
id|memcpy_fromfs
(paren
op_amp
id|tbuf
comma
id|buf
comma
r_sizeof
(paren
op_star
id|buf
)paren
)paren
suffix:semicolon
)brace
r_switch
c_cond
(paren
id|cmd
)paren
(brace
multiline_comment|/* replace with proc interface ? */
r_case
id|IPC_INFO
suffix:colon
(brace
r_struct
id|shminfo
id|shminfo
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|buf
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
id|shminfo.shmmni
op_assign
id|SHMMNI
suffix:semicolon
id|shminfo.shmmax
op_assign
id|SHMMAX
suffix:semicolon
id|shminfo.shmmin
op_assign
id|SHMMIN
suffix:semicolon
id|shminfo.shmall
op_assign
id|SHMALL
suffix:semicolon
id|shminfo.shmseg
op_assign
id|SHMSEG
suffix:semicolon
id|err
op_assign
id|verify_area
(paren
id|VERIFY_WRITE
comma
id|buf
comma
r_sizeof
(paren
r_struct
id|shminfo
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
r_return
id|err
suffix:semicolon
id|memcpy_tofs
(paren
id|buf
comma
op_amp
id|shminfo
comma
r_sizeof
(paren
r_struct
id|shminfo
)paren
)paren
suffix:semicolon
r_return
id|max_shmid
suffix:semicolon
)brace
r_case
id|SHM_INFO
suffix:colon
(brace
r_struct
id|shm_info
id|shm_info
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|buf
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
id|err
op_assign
id|verify_area
(paren
id|VERIFY_WRITE
comma
id|buf
comma
r_sizeof
(paren
id|shm_info
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
r_return
id|err
suffix:semicolon
id|shm_info.used_ids
op_assign
id|used_segs
suffix:semicolon
id|shm_info.shm_rss
op_assign
id|shm_rss
suffix:semicolon
id|shm_info.shm_tot
op_assign
id|shm_tot
suffix:semicolon
id|shm_info.shm_swp
op_assign
id|shm_swp
suffix:semicolon
id|shm_info.swap_attempts
op_assign
id|swap_attempts
suffix:semicolon
id|shm_info.swap_successes
op_assign
id|swap_successes
suffix:semicolon
id|memcpy_tofs
(paren
id|buf
comma
op_amp
id|shm_info
comma
r_sizeof
(paren
id|shm_info
)paren
)paren
suffix:semicolon
r_return
id|max_shmid
suffix:semicolon
)brace
r_case
id|SHM_STAT
suffix:colon
r_if
c_cond
(paren
op_logical_neg
id|buf
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
id|err
op_assign
id|verify_area
(paren
id|VERIFY_WRITE
comma
id|buf
comma
r_sizeof
(paren
op_star
id|buf
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
r_return
id|err
suffix:semicolon
r_if
c_cond
(paren
id|shmid
OG
id|max_shmid
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|shp
op_assign
id|shm_segs
(braket
id|shmid
)braket
suffix:semicolon
r_if
c_cond
(paren
id|shp
op_eq
id|IPC_UNUSED
op_logical_or
id|shp
op_eq
id|IPC_NOID
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|ipcperms
(paren
op_amp
id|shp-&gt;shm_perm
comma
id|S_IRUGO
)paren
)paren
r_return
op_minus
id|EACCES
suffix:semicolon
id|id
op_assign
(paren
r_int
r_int
)paren
id|shp-&gt;shm_perm.seq
op_star
id|SHMMNI
op_plus
id|shmid
suffix:semicolon
id|tbuf.shm_perm
op_assign
id|shp-&gt;shm_perm
suffix:semicolon
id|tbuf.shm_segsz
op_assign
id|shp-&gt;shm_segsz
suffix:semicolon
id|tbuf.shm_atime
op_assign
id|shp-&gt;shm_atime
suffix:semicolon
id|tbuf.shm_dtime
op_assign
id|shp-&gt;shm_dtime
suffix:semicolon
id|tbuf.shm_ctime
op_assign
id|shp-&gt;shm_ctime
suffix:semicolon
id|tbuf.shm_cpid
op_assign
id|shp-&gt;shm_cpid
suffix:semicolon
id|tbuf.shm_lpid
op_assign
id|shp-&gt;shm_lpid
suffix:semicolon
id|tbuf.shm_nattch
op_assign
id|shp-&gt;shm_nattch
suffix:semicolon
id|memcpy_tofs
(paren
id|buf
comma
op_amp
id|tbuf
comma
r_sizeof
(paren
op_star
id|buf
)paren
)paren
suffix:semicolon
r_return
id|id
suffix:semicolon
)brace
id|shp
op_assign
id|shm_segs
(braket
id|id
op_assign
(paren
r_int
r_int
)paren
id|shmid
op_mod
id|SHMMNI
)braket
suffix:semicolon
r_if
c_cond
(paren
id|shp
op_eq
id|IPC_UNUSED
op_logical_or
id|shp
op_eq
id|IPC_NOID
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|shp-&gt;shm_perm.seq
op_ne
(paren
r_int
r_int
)paren
id|shmid
op_div
id|SHMMNI
)paren
r_return
op_minus
id|EIDRM
suffix:semicolon
id|ipcp
op_assign
op_amp
id|shp-&gt;shm_perm
suffix:semicolon
r_switch
c_cond
(paren
id|cmd
)paren
(brace
r_case
id|SHM_UNLOCK
suffix:colon
r_if
c_cond
(paren
op_logical_neg
id|suser
c_func
(paren
)paren
)paren
r_return
op_minus
id|EPERM
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|ipcp-&gt;mode
op_amp
id|SHM_LOCKED
)paren
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|ipcp-&gt;mode
op_and_assign
op_complement
id|SHM_LOCKED
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SHM_LOCK
suffix:colon
multiline_comment|/* Allow superuser to lock segment in memory */
multiline_comment|/* Should the pages be faulted in here or leave it to user? */
multiline_comment|/* need to determine interaction with current-&gt;swappable */
r_if
c_cond
(paren
op_logical_neg
id|suser
c_func
(paren
)paren
)paren
r_return
op_minus
id|EPERM
suffix:semicolon
r_if
c_cond
(paren
id|ipcp-&gt;mode
op_amp
id|SHM_LOCKED
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|ipcp-&gt;mode
op_or_assign
id|SHM_LOCKED
suffix:semicolon
r_break
suffix:semicolon
r_case
id|IPC_STAT
suffix:colon
r_if
c_cond
(paren
id|ipcperms
(paren
id|ipcp
comma
id|S_IRUGO
)paren
)paren
r_return
op_minus
id|EACCES
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|buf
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
id|err
op_assign
id|verify_area
(paren
id|VERIFY_WRITE
comma
id|buf
comma
r_sizeof
(paren
op_star
id|buf
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
r_return
id|err
suffix:semicolon
id|tbuf.shm_perm
op_assign
id|shp-&gt;shm_perm
suffix:semicolon
id|tbuf.shm_segsz
op_assign
id|shp-&gt;shm_segsz
suffix:semicolon
id|tbuf.shm_atime
op_assign
id|shp-&gt;shm_atime
suffix:semicolon
id|tbuf.shm_dtime
op_assign
id|shp-&gt;shm_dtime
suffix:semicolon
id|tbuf.shm_ctime
op_assign
id|shp-&gt;shm_ctime
suffix:semicolon
id|tbuf.shm_cpid
op_assign
id|shp-&gt;shm_cpid
suffix:semicolon
id|tbuf.shm_lpid
op_assign
id|shp-&gt;shm_lpid
suffix:semicolon
id|tbuf.shm_nattch
op_assign
id|shp-&gt;shm_nattch
suffix:semicolon
id|memcpy_tofs
(paren
id|buf
comma
op_amp
id|tbuf
comma
r_sizeof
(paren
op_star
id|buf
)paren
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|IPC_SET
suffix:colon
r_if
c_cond
(paren
id|suser
c_func
(paren
)paren
op_logical_or
id|current-&gt;euid
op_eq
id|shp-&gt;shm_perm.uid
op_logical_or
id|current-&gt;euid
op_eq
id|shp-&gt;shm_perm.cuid
)paren
(brace
id|ipcp-&gt;uid
op_assign
id|tbuf.shm_perm.uid
suffix:semicolon
id|ipcp-&gt;gid
op_assign
id|tbuf.shm_perm.gid
suffix:semicolon
id|ipcp-&gt;mode
op_assign
(paren
id|ipcp-&gt;mode
op_amp
op_complement
id|S_IRWXUGO
)paren
op_or
(paren
id|tbuf.shm_perm.mode
op_amp
id|S_IRWXUGO
)paren
suffix:semicolon
id|shp-&gt;shm_ctime
op_assign
id|CURRENT_TIME
suffix:semicolon
r_break
suffix:semicolon
)brace
r_return
op_minus
id|EPERM
suffix:semicolon
r_case
id|IPC_RMID
suffix:colon
r_if
c_cond
(paren
id|suser
c_func
(paren
)paren
op_logical_or
id|current-&gt;euid
op_eq
id|shp-&gt;shm_perm.uid
op_logical_or
id|current-&gt;euid
op_eq
id|shp-&gt;shm_perm.cuid
)paren
(brace
id|shp-&gt;shm_perm.mode
op_or_assign
id|SHM_DEST
suffix:semicolon
r_if
c_cond
(paren
id|shp-&gt;shm_nattch
op_le
l_int|0
)paren
id|killseg
(paren
id|id
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_return
op_minus
id|EPERM
suffix:semicolon
r_default
suffix:colon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * The per process internal structure for managing segments is&n; * `struct vm_area_struct&squot;.&n; * A shmat will add to and shmdt will remove from the list.&n; * shmd-&gt;vm_task&t;the attacher&n; * shmd-&gt;vm_start&t;virt addr of attach, multiple of SHMLBA&n; * shmd-&gt;vm_end&t;&t;multiple of SHMLBA&n; * shmd-&gt;vm_next&t;next attach for task&n; * shmd-&gt;vm_next_share&t;next attach for segment&n; * shmd-&gt;vm_offset&t;offset into segment&n; * shmd-&gt;vm_pte&t;&t;signature for this attach&n; */
DECL|variable|shm_vm_ops
r_static
r_struct
id|vm_operations_struct
id|shm_vm_ops
op_assign
(brace
id|shm_open
comma
multiline_comment|/* open */
id|shm_close
comma
multiline_comment|/* close */
l_int|NULL
comma
multiline_comment|/* unmap */
l_int|NULL
comma
multiline_comment|/* protect */
l_int|NULL
comma
multiline_comment|/* sync */
l_int|NULL
comma
multiline_comment|/* advise */
l_int|NULL
comma
multiline_comment|/* nopage (done with swapin) */
l_int|NULL
comma
multiline_comment|/* wppage */
l_int|NULL
comma
multiline_comment|/* swapout (hardcoded right now) */
id|shm_swap_in
multiline_comment|/* swapin */
)brace
suffix:semicolon
multiline_comment|/* Insert shmd into the circular list shp-&gt;attaches */
DECL|function|insert_attach
r_static
r_inline
r_void
id|insert_attach
(paren
r_struct
id|shmid_ds
op_star
id|shp
comma
r_struct
id|vm_area_struct
op_star
id|shmd
)paren
(brace
r_struct
id|vm_area_struct
op_star
id|attaches
suffix:semicolon
r_if
c_cond
(paren
(paren
id|attaches
op_assign
id|shp-&gt;attaches
)paren
)paren
(brace
id|shmd-&gt;vm_next_share
op_assign
id|attaches
suffix:semicolon
id|shmd-&gt;vm_prev_share
op_assign
id|attaches-&gt;vm_prev_share
suffix:semicolon
id|shmd-&gt;vm_prev_share-&gt;vm_next_share
op_assign
id|shmd
suffix:semicolon
id|attaches-&gt;vm_prev_share
op_assign
id|shmd
suffix:semicolon
)brace
r_else
id|shp-&gt;attaches
op_assign
id|shmd-&gt;vm_next_share
op_assign
id|shmd-&gt;vm_prev_share
op_assign
id|shmd
suffix:semicolon
)brace
multiline_comment|/* Remove shmd from circular list shp-&gt;attaches */
DECL|function|remove_attach
r_static
r_inline
r_void
id|remove_attach
(paren
r_struct
id|shmid_ds
op_star
id|shp
comma
r_struct
id|vm_area_struct
op_star
id|shmd
)paren
(brace
r_if
c_cond
(paren
id|shmd-&gt;vm_next_share
op_eq
id|shmd
)paren
(brace
r_if
c_cond
(paren
id|shp-&gt;attaches
op_ne
id|shmd
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;shm_close: shm segment (id=%ld) attach list inconsistent&bslash;n&quot;
comma
(paren
id|shmd-&gt;vm_pte
op_rshift
id|SHM_ID_SHIFT
)paren
op_amp
id|SHM_ID_MASK
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;shm_close: %d %08lx-%08lx %c%c%c%c %08lx %08lx&bslash;n&quot;
comma
id|shmd-&gt;vm_task-&gt;pid
comma
id|shmd-&gt;vm_start
comma
id|shmd-&gt;vm_end
comma
id|shmd-&gt;vm_flags
op_amp
id|VM_READ
ques
c_cond
l_char|&squot;r&squot;
suffix:colon
l_char|&squot;-&squot;
comma
id|shmd-&gt;vm_flags
op_amp
id|VM_WRITE
ques
c_cond
l_char|&squot;w&squot;
suffix:colon
l_char|&squot;-&squot;
comma
id|shmd-&gt;vm_flags
op_amp
id|VM_EXEC
ques
c_cond
l_char|&squot;x&squot;
suffix:colon
l_char|&squot;-&squot;
comma
id|shmd-&gt;vm_flags
op_amp
id|VM_SHARED
ques
c_cond
l_char|&squot;s&squot;
suffix:colon
l_char|&squot;p&squot;
comma
id|shmd-&gt;vm_offset
comma
id|shmd-&gt;vm_pte
)paren
suffix:semicolon
)brace
id|shp-&gt;attaches
op_assign
l_int|NULL
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|shp-&gt;attaches
op_eq
id|shmd
)paren
id|shp-&gt;attaches
op_assign
id|shmd-&gt;vm_next_share
suffix:semicolon
id|shmd-&gt;vm_prev_share-&gt;vm_next_share
op_assign
id|shmd-&gt;vm_next_share
suffix:semicolon
id|shmd-&gt;vm_next_share-&gt;vm_prev_share
op_assign
id|shmd-&gt;vm_prev_share
suffix:semicolon
)brace
)brace
multiline_comment|/*&n; * check range is unmapped, ensure page tables exist&n; * mark page table entries with shm_sgn.&n; * if remap != 0 the range is remapped.&n; */
DECL|function|shm_map
r_static
r_int
id|shm_map
(paren
r_struct
id|vm_area_struct
op_star
id|shmd
comma
r_int
id|remap
)paren
(brace
r_int
r_int
op_star
id|page_table
suffix:semicolon
r_int
r_int
id|tmp
comma
id|shm_sgn
suffix:semicolon
multiline_comment|/* check that the range is unmapped */
r_if
c_cond
(paren
op_logical_neg
id|remap
)paren
r_for
c_loop
(paren
id|tmp
op_assign
id|shmd-&gt;vm_start
suffix:semicolon
id|tmp
OL
id|shmd-&gt;vm_end
suffix:semicolon
id|tmp
op_add_assign
id|PAGE_SIZE
)paren
(brace
id|page_table
op_assign
id|PAGE_DIR_OFFSET
c_func
(paren
id|shmd-&gt;vm_task
comma
id|tmp
)paren
suffix:semicolon
r_if
c_cond
(paren
op_star
id|page_table
op_amp
id|PAGE_PRESENT
)paren
(brace
id|page_table
op_assign
(paren
id|ulong
op_star
)paren
(paren
id|PAGE_MASK
op_amp
op_star
id|page_table
)paren
suffix:semicolon
id|page_table
op_add_assign
(paren
(paren
id|tmp
op_rshift
id|PAGE_SHIFT
)paren
op_amp
(paren
id|PTRS_PER_PAGE
op_minus
l_int|1
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_star
id|page_table
)paren
(brace
multiline_comment|/* printk(&quot;shmat() -&gt; EINVAL because address 0x%lx is already mapped.&bslash;n&quot;,tmp); */
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
)brace
)brace
multiline_comment|/* clear old mappings */
id|do_munmap
c_func
(paren
id|shmd-&gt;vm_start
comma
id|shmd-&gt;vm_end
op_minus
id|shmd-&gt;vm_start
)paren
suffix:semicolon
multiline_comment|/* add new mapping */
id|insert_vm_struct
c_func
(paren
id|current
comma
id|shmd
)paren
suffix:semicolon
id|merge_segments
c_func
(paren
id|current
comma
id|shmd-&gt;vm_start
comma
id|shmd-&gt;vm_end
)paren
suffix:semicolon
multiline_comment|/* check that the range has page_tables */
r_for
c_loop
(paren
id|tmp
op_assign
id|shmd-&gt;vm_start
suffix:semicolon
id|tmp
OL
id|shmd-&gt;vm_end
suffix:semicolon
id|tmp
op_add_assign
id|PAGE_SIZE
)paren
(brace
id|page_table
op_assign
id|PAGE_DIR_OFFSET
c_func
(paren
id|shmd-&gt;vm_task
comma
id|tmp
)paren
suffix:semicolon
r_if
c_cond
(paren
op_star
id|page_table
op_amp
id|PAGE_PRESENT
)paren
(brace
id|page_table
op_assign
(paren
id|ulong
op_star
)paren
(paren
id|PAGE_MASK
op_amp
op_star
id|page_table
)paren
suffix:semicolon
id|page_table
op_add_assign
(paren
(paren
id|tmp
op_rshift
id|PAGE_SHIFT
)paren
op_amp
(paren
id|PTRS_PER_PAGE
op_minus
l_int|1
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_star
id|page_table
)paren
(brace
r_if
c_cond
(paren
op_star
id|page_table
op_amp
id|PAGE_PRESENT
)paren
(brace
op_decrement
id|current-&gt;mm-&gt;rss
suffix:semicolon
id|free_page
(paren
op_star
id|page_table
op_amp
id|PAGE_MASK
)paren
suffix:semicolon
)brace
r_else
id|swap_free
(paren
op_star
id|page_table
)paren
suffix:semicolon
op_star
id|page_table
op_assign
l_int|0
suffix:semicolon
)brace
)brace
r_else
(brace
r_int
r_int
id|new_pt
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|new_pt
op_assign
id|get_free_page
c_func
(paren
id|GFP_KERNEL
)paren
)paren
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
op_star
id|page_table
op_assign
id|new_pt
op_or
id|PAGE_TABLE
suffix:semicolon
id|tmp
op_or_assign
(paren
(paren
id|PAGE_SIZE
op_lshift
l_int|10
)paren
op_minus
id|PAGE_SIZE
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* map page range */
id|shm_sgn
op_assign
id|shmd-&gt;vm_pte
op_plus
(paren
(paren
id|shmd-&gt;vm_offset
op_rshift
id|PAGE_SHIFT
)paren
op_lshift
id|SHM_IDX_SHIFT
)paren
suffix:semicolon
r_for
c_loop
(paren
id|tmp
op_assign
id|shmd-&gt;vm_start
suffix:semicolon
id|tmp
OL
id|shmd-&gt;vm_end
suffix:semicolon
id|tmp
op_add_assign
id|PAGE_SIZE
comma
id|shm_sgn
op_add_assign
(paren
l_int|1
op_lshift
id|SHM_IDX_SHIFT
)paren
)paren
(brace
id|page_table
op_assign
id|PAGE_DIR_OFFSET
c_func
(paren
id|shmd-&gt;vm_task
comma
id|tmp
)paren
suffix:semicolon
id|page_table
op_assign
(paren
id|ulong
op_star
)paren
(paren
id|PAGE_MASK
op_amp
op_star
id|page_table
)paren
suffix:semicolon
id|page_table
op_add_assign
(paren
id|tmp
op_rshift
id|PAGE_SHIFT
)paren
op_amp
(paren
id|PTRS_PER_PAGE
op_minus
l_int|1
)paren
suffix:semicolon
op_star
id|page_table
op_assign
id|shm_sgn
suffix:semicolon
)brace
id|invalidate
c_func
(paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * Fix shmaddr, allocate descriptor, map shm, add attach descriptor to lists.&n; */
DECL|function|sys_shmat
r_int
id|sys_shmat
(paren
r_int
id|shmid
comma
r_char
op_star
id|shmaddr
comma
r_int
id|shmflg
comma
id|ulong
op_star
id|raddr
)paren
(brace
r_struct
id|shmid_ds
op_star
id|shp
suffix:semicolon
r_struct
id|vm_area_struct
op_star
id|shmd
suffix:semicolon
r_int
id|err
suffix:semicolon
r_int
r_int
id|id
suffix:semicolon
r_int
r_int
id|addr
suffix:semicolon
r_if
c_cond
(paren
id|shmid
OL
l_int|0
)paren
(brace
multiline_comment|/* printk(&quot;shmat() -&gt; EINVAL because shmid = %d &lt; 0&bslash;n&quot;,shmid); */
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|shp
op_assign
id|shm_segs
(braket
id|id
op_assign
(paren
r_int
r_int
)paren
id|shmid
op_mod
id|SHMMNI
)braket
suffix:semicolon
r_if
c_cond
(paren
id|shp
op_eq
id|IPC_UNUSED
op_logical_or
id|shp
op_eq
id|IPC_NOID
)paren
(brace
multiline_comment|/* printk(&quot;shmat() -&gt; EINVAL because shmid = %d is invalid&bslash;n&quot;,shmid); */
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|addr
op_assign
(paren
id|ulong
)paren
id|shmaddr
)paren
)paren
(brace
r_if
c_cond
(paren
id|shmflg
op_amp
id|SHM_REMAP
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|addr
op_assign
id|get_unmapped_area
c_func
(paren
id|shp-&gt;shm_segsz
)paren
)paren
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|addr
op_amp
(paren
id|SHMLBA
op_minus
l_int|1
)paren
)paren
(brace
r_if
c_cond
(paren
id|shmflg
op_amp
id|SHM_RND
)paren
id|addr
op_and_assign
op_complement
(paren
id|SHMLBA
op_minus
l_int|1
)paren
suffix:semicolon
multiline_comment|/* round down */
r_else
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|addr
OG
id|current-&gt;mm-&gt;start_stack
op_minus
l_int|16384
op_minus
id|PAGE_SIZE
op_star
id|shp-&gt;shm_npages
)paren
)paren
(brace
multiline_comment|/* printk(&quot;shmat() -&gt; EINVAL because segment intersects stack&bslash;n&quot;); */
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|shmflg
op_amp
id|SHM_REMAP
)paren
)paren
r_if
c_cond
(paren
(paren
id|shmd
op_assign
id|find_vma_intersection
c_func
(paren
id|current
comma
id|addr
comma
id|addr
op_plus
id|shp-&gt;shm_segsz
)paren
)paren
)paren
(brace
multiline_comment|/* printk(&quot;shmat() -&gt; EINVAL because the interval [0x%lx,0x%lx) intersects an already mapped interval [0x%lx,0x%lx).&bslash;n&quot;,&n;&t;&t;&t;&t;addr, addr + shp-&gt;shm_segsz, shmd-&gt;vm_start, shmd-&gt;vm_end); */
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ipcperms
c_func
(paren
op_amp
id|shp-&gt;shm_perm
comma
id|shmflg
op_amp
id|SHM_RDONLY
ques
c_cond
id|S_IRUGO
suffix:colon
id|S_IRUGO
op_or
id|S_IWUGO
)paren
)paren
r_return
op_minus
id|EACCES
suffix:semicolon
r_if
c_cond
(paren
id|shp-&gt;shm_perm.seq
op_ne
(paren
r_int
r_int
)paren
id|shmid
op_div
id|SHMMNI
)paren
r_return
op_minus
id|EIDRM
suffix:semicolon
id|shmd
op_assign
(paren
r_struct
id|vm_area_struct
op_star
)paren
id|kmalloc
(paren
r_sizeof
(paren
op_star
id|shmd
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|shmd
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
r_if
c_cond
(paren
(paren
id|shp
op_ne
id|shm_segs
(braket
id|id
)braket
)paren
op_logical_or
(paren
id|shp-&gt;shm_perm.seq
op_ne
(paren
r_int
r_int
)paren
id|shmid
op_div
id|SHMMNI
)paren
)paren
(brace
id|kfree
c_func
(paren
id|shmd
)paren
suffix:semicolon
r_return
op_minus
id|EIDRM
suffix:semicolon
)brace
id|shmd-&gt;vm_pte
op_assign
(paren
id|SHM_SWP_TYPE
op_lshift
l_int|1
)paren
op_or
(paren
id|id
op_lshift
id|SHM_ID_SHIFT
)paren
suffix:semicolon
id|shmd-&gt;vm_start
op_assign
id|addr
suffix:semicolon
id|shmd-&gt;vm_end
op_assign
id|addr
op_plus
id|shp-&gt;shm_npages
op_star
id|PAGE_SIZE
suffix:semicolon
id|shmd-&gt;vm_task
op_assign
id|current
suffix:semicolon
id|shmd-&gt;vm_page_prot
op_assign
(paren
id|shmflg
op_amp
id|SHM_RDONLY
)paren
ques
c_cond
id|PAGE_READONLY
suffix:colon
id|PAGE_SHARED
suffix:semicolon
id|shmd-&gt;vm_flags
op_assign
id|VM_SHM
op_or
id|VM_MAYSHARE
op_or
id|VM_SHARED
op_or
id|VM_MAYREAD
op_or
id|VM_MAYEXEC
op_or
id|VM_READ
op_or
id|VM_EXEC
op_or
(paren
(paren
id|shmflg
op_amp
id|SHM_RDONLY
)paren
ques
c_cond
l_int|0
suffix:colon
id|VM_MAYWRITE
op_or
id|VM_WRITE
)paren
suffix:semicolon
id|shmd-&gt;vm_next_share
op_assign
id|shmd-&gt;vm_prev_share
op_assign
l_int|NULL
suffix:semicolon
id|shmd-&gt;vm_inode
op_assign
l_int|NULL
suffix:semicolon
id|shmd-&gt;vm_offset
op_assign
l_int|0
suffix:semicolon
id|shmd-&gt;vm_ops
op_assign
op_amp
id|shm_vm_ops
suffix:semicolon
id|shp-&gt;shm_nattch
op_increment
suffix:semicolon
multiline_comment|/* prevent destruction */
r_if
c_cond
(paren
(paren
id|err
op_assign
id|shm_map
(paren
id|shmd
comma
id|shmflg
op_amp
id|SHM_REMAP
)paren
)paren
)paren
(brace
r_if
c_cond
(paren
op_decrement
id|shp-&gt;shm_nattch
op_le
l_int|0
op_logical_and
id|shp-&gt;shm_perm.mode
op_amp
id|SHM_DEST
)paren
id|killseg
c_func
(paren
id|id
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|shmd
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
id|insert_attach
c_func
(paren
id|shp
comma
id|shmd
)paren
suffix:semicolon
multiline_comment|/* insert shmd into shp-&gt;attaches */
id|shp-&gt;shm_lpid
op_assign
id|current-&gt;pid
suffix:semicolon
id|shp-&gt;shm_atime
op_assign
id|CURRENT_TIME
suffix:semicolon
op_star
id|raddr
op_assign
id|addr
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* This is called by fork, once for every shm attach. */
DECL|function|shm_open
r_static
r_void
id|shm_open
(paren
r_struct
id|vm_area_struct
op_star
id|shmd
)paren
(brace
r_int
r_int
id|id
suffix:semicolon
r_struct
id|shmid_ds
op_star
id|shp
suffix:semicolon
id|id
op_assign
(paren
id|shmd-&gt;vm_pte
op_rshift
id|SHM_ID_SHIFT
)paren
op_amp
id|SHM_ID_MASK
suffix:semicolon
id|shp
op_assign
id|shm_segs
(braket
id|id
)braket
suffix:semicolon
r_if
c_cond
(paren
id|shp
op_eq
id|IPC_UNUSED
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;shm_open: unused id=%d PANIC&bslash;n&quot;
comma
id|id
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|insert_attach
c_func
(paren
id|shp
comma
id|shmd
)paren
suffix:semicolon
multiline_comment|/* insert shmd into shp-&gt;attaches */
id|shp-&gt;shm_nattch
op_increment
suffix:semicolon
id|shp-&gt;shm_atime
op_assign
id|CURRENT_TIME
suffix:semicolon
id|shp-&gt;shm_lpid
op_assign
id|current-&gt;pid
suffix:semicolon
)brace
multiline_comment|/*&n; * remove the attach descriptor shmd.&n; * free memory for segment if it is marked destroyed.&n; * The descriptor has already been removed from the current-&gt;mm-&gt;mmap list&n; * and will later be kfree()d.&n; */
DECL|function|shm_close
r_static
r_void
id|shm_close
(paren
r_struct
id|vm_area_struct
op_star
id|shmd
)paren
(brace
r_struct
id|shmid_ds
op_star
id|shp
suffix:semicolon
r_int
id|id
suffix:semicolon
id|unmap_page_range
(paren
id|shmd-&gt;vm_start
comma
id|shmd-&gt;vm_end
op_minus
id|shmd-&gt;vm_start
)paren
suffix:semicolon
multiline_comment|/* remove from the list of attaches of the shm segment */
id|id
op_assign
(paren
id|shmd-&gt;vm_pte
op_rshift
id|SHM_ID_SHIFT
)paren
op_amp
id|SHM_ID_MASK
suffix:semicolon
id|shp
op_assign
id|shm_segs
(braket
id|id
)braket
suffix:semicolon
id|remove_attach
c_func
(paren
id|shp
comma
id|shmd
)paren
suffix:semicolon
multiline_comment|/* remove from shp-&gt;attaches */
id|shp-&gt;shm_lpid
op_assign
id|current-&gt;pid
suffix:semicolon
id|shp-&gt;shm_dtime
op_assign
id|CURRENT_TIME
suffix:semicolon
r_if
c_cond
(paren
op_decrement
id|shp-&gt;shm_nattch
op_le
l_int|0
op_logical_and
id|shp-&gt;shm_perm.mode
op_amp
id|SHM_DEST
)paren
id|killseg
(paren
id|id
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * detach and kill segment if marked destroyed.&n; * The work is done in shm_close.&n; */
DECL|function|sys_shmdt
r_int
id|sys_shmdt
(paren
r_char
op_star
id|shmaddr
)paren
(brace
r_struct
id|vm_area_struct
op_star
id|shmd
comma
op_star
id|shmdnext
suffix:semicolon
r_for
c_loop
(paren
id|shmd
op_assign
id|current-&gt;mm-&gt;mmap
suffix:semicolon
id|shmd
suffix:semicolon
id|shmd
op_assign
id|shmdnext
)paren
(brace
id|shmdnext
op_assign
id|shmd-&gt;vm_next
suffix:semicolon
r_if
c_cond
(paren
id|shmd-&gt;vm_ops
op_eq
op_amp
id|shm_vm_ops
op_logical_and
id|shmd-&gt;vm_start
op_minus
id|shmd-&gt;vm_offset
op_eq
(paren
id|ulong
)paren
id|shmaddr
)paren
id|do_munmap
c_func
(paren
id|shmd-&gt;vm_start
comma
id|shmd-&gt;vm_end
op_minus
id|shmd-&gt;vm_start
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * page not present ... go through shm_pages&n; */
DECL|function|shm_swap_in
r_static
r_int
r_int
id|shm_swap_in
c_func
(paren
r_struct
id|vm_area_struct
op_star
id|shmd
comma
r_int
r_int
id|offset
comma
r_int
r_int
id|code
)paren
(brace
r_int
r_int
id|page
suffix:semicolon
r_struct
id|shmid_ds
op_star
id|shp
suffix:semicolon
r_int
r_int
id|id
comma
id|idx
suffix:semicolon
id|id
op_assign
(paren
id|code
op_rshift
id|SHM_ID_SHIFT
)paren
op_amp
id|SHM_ID_MASK
suffix:semicolon
r_if
c_cond
(paren
id|id
op_ne
(paren
(paren
id|shmd-&gt;vm_pte
op_rshift
id|SHM_ID_SHIFT
)paren
op_amp
id|SHM_ID_MASK
)paren
)paren
(brace
id|printk
(paren
l_string|&quot;shm_swap_in: code id = %d and shmd id = %ld differ&bslash;n&quot;
comma
id|id
comma
(paren
id|shmd-&gt;vm_pte
op_rshift
id|SHM_ID_SHIFT
)paren
op_amp
id|SHM_ID_MASK
)paren
suffix:semicolon
r_return
id|BAD_PAGE
op_or
id|PAGE_SHARED
suffix:semicolon
)brace
r_if
c_cond
(paren
id|id
OG
id|max_shmid
)paren
(brace
id|printk
(paren
l_string|&quot;shm_swap_in: id=%d too big. proc mem corrupted&bslash;n&quot;
comma
id|id
)paren
suffix:semicolon
r_return
id|BAD_PAGE
op_or
id|PAGE_SHARED
suffix:semicolon
)brace
id|shp
op_assign
id|shm_segs
(braket
id|id
)braket
suffix:semicolon
r_if
c_cond
(paren
id|shp
op_eq
id|IPC_UNUSED
op_logical_or
id|shp
op_eq
id|IPC_NOID
)paren
(brace
id|printk
(paren
l_string|&quot;shm_swap_in: id=%d invalid. Race.&bslash;n&quot;
comma
id|id
)paren
suffix:semicolon
r_return
id|BAD_PAGE
op_or
id|PAGE_SHARED
suffix:semicolon
)brace
id|idx
op_assign
(paren
id|code
op_rshift
id|SHM_IDX_SHIFT
)paren
op_amp
id|SHM_IDX_MASK
suffix:semicolon
r_if
c_cond
(paren
id|idx
op_ne
(paren
id|offset
op_rshift
id|PAGE_SHIFT
)paren
)paren
(brace
id|printk
(paren
l_string|&quot;shm_swap_in: code idx = %u and shmd idx = %lu differ&bslash;n&quot;
comma
id|idx
comma
id|offset
op_rshift
id|PAGE_SHIFT
)paren
suffix:semicolon
r_return
id|BAD_PAGE
op_or
id|PAGE_SHARED
suffix:semicolon
)brace
r_if
c_cond
(paren
id|idx
op_ge
id|shp-&gt;shm_npages
)paren
(brace
id|printk
(paren
l_string|&quot;shm_swap_in : too large page index. id=%d&bslash;n&quot;
comma
id|id
)paren
suffix:semicolon
r_return
id|BAD_PAGE
op_or
id|PAGE_SHARED
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|shp-&gt;shm_pages
(braket
id|idx
)braket
op_amp
id|PAGE_PRESENT
)paren
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|page
op_assign
id|get_free_page
c_func
(paren
id|GFP_KERNEL
)paren
)paren
)paren
(brace
id|oom
c_func
(paren
id|current
)paren
suffix:semicolon
r_return
id|BAD_PAGE
op_or
id|PAGE_SHARED
suffix:semicolon
)brace
r_if
c_cond
(paren
id|shp-&gt;shm_pages
(braket
id|idx
)braket
op_amp
id|PAGE_PRESENT
)paren
(brace
id|free_page
(paren
id|page
)paren
suffix:semicolon
r_goto
id|done
suffix:semicolon
)brace
r_if
c_cond
(paren
id|shp-&gt;shm_pages
(braket
id|idx
)braket
)paren
(brace
id|read_swap_page
(paren
id|shp-&gt;shm_pages
(braket
id|idx
)braket
comma
(paren
r_char
op_star
)paren
id|page
)paren
suffix:semicolon
r_if
c_cond
(paren
id|shp-&gt;shm_pages
(braket
id|idx
)braket
op_amp
id|PAGE_PRESENT
)paren
(brace
id|free_page
(paren
id|page
)paren
suffix:semicolon
r_goto
id|done
suffix:semicolon
)brace
id|swap_free
(paren
id|shp-&gt;shm_pages
(braket
id|idx
)braket
)paren
suffix:semicolon
id|shm_swp
op_decrement
suffix:semicolon
)brace
id|shm_rss
op_increment
suffix:semicolon
id|shp-&gt;shm_pages
(braket
id|idx
)braket
op_assign
id|page
op_or
(paren
id|PAGE_SHARED
op_or
id|PAGE_DIRTY
)paren
suffix:semicolon
)brace
r_else
op_decrement
id|current-&gt;mm-&gt;maj_flt
suffix:semicolon
multiline_comment|/* was incremented in do_no_page */
id|done
suffix:colon
id|current-&gt;mm-&gt;min_flt
op_increment
suffix:semicolon
id|page
op_assign
id|shp-&gt;shm_pages
(braket
id|idx
)braket
suffix:semicolon
id|page
op_and_assign
op_complement
(paren
id|PAGE_RW
op_amp
op_complement
id|shmd-&gt;vm_page_prot
)paren
suffix:semicolon
multiline_comment|/* write-protect */
id|mem_map
(braket
id|MAP_NR
c_func
(paren
id|page
)paren
)braket
op_increment
suffix:semicolon
r_return
id|page
suffix:semicolon
)brace
multiline_comment|/*&n; * Goes through counter = (shm_rss &lt;&lt; prio) present shm pages.&n; */
DECL|variable|swap_id
r_static
r_int
r_int
id|swap_id
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* currently being swapped */
DECL|variable|swap_idx
r_static
r_int
r_int
id|swap_idx
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* next to swap */
DECL|function|shm_swap
r_int
id|shm_swap
(paren
r_int
id|prio
)paren
(brace
r_int
r_int
id|page
suffix:semicolon
r_struct
id|shmid_ds
op_star
id|shp
suffix:semicolon
r_struct
id|vm_area_struct
op_star
id|shmd
suffix:semicolon
r_int
r_int
id|swap_nr
suffix:semicolon
r_int
r_int
id|id
comma
id|idx
comma
id|invalid
op_assign
l_int|0
suffix:semicolon
r_int
id|counter
suffix:semicolon
id|counter
op_assign
id|shm_rss
op_rshift
id|prio
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|counter
op_logical_or
op_logical_neg
(paren
id|swap_nr
op_assign
id|get_swap_page
c_func
(paren
)paren
)paren
)paren
r_return
l_int|0
suffix:semicolon
id|check_id
suffix:colon
id|shp
op_assign
id|shm_segs
(braket
id|swap_id
)braket
suffix:semicolon
r_if
c_cond
(paren
id|shp
op_eq
id|IPC_UNUSED
op_logical_or
id|shp
op_eq
id|IPC_NOID
op_logical_or
id|shp-&gt;shm_perm.mode
op_amp
id|SHM_LOCKED
)paren
(brace
id|swap_idx
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
op_increment
id|swap_id
OG
id|max_shmid
)paren
id|swap_id
op_assign
l_int|0
suffix:semicolon
r_goto
id|check_id
suffix:semicolon
)brace
id|id
op_assign
id|swap_id
suffix:semicolon
id|check_table
suffix:colon
id|idx
op_assign
id|swap_idx
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|idx
op_ge
id|shp-&gt;shm_npages
)paren
(brace
id|swap_idx
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
op_increment
id|swap_id
OG
id|max_shmid
)paren
id|swap_id
op_assign
l_int|0
suffix:semicolon
r_goto
id|check_id
suffix:semicolon
)brace
id|page
op_assign
id|shp-&gt;shm_pages
(braket
id|idx
)braket
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|page
op_amp
id|PAGE_PRESENT
)paren
)paren
r_goto
id|check_table
suffix:semicolon
id|swap_attempts
op_increment
suffix:semicolon
r_if
c_cond
(paren
op_decrement
id|counter
OL
l_int|0
)paren
(brace
multiline_comment|/* failed */
r_if
c_cond
(paren
id|invalid
)paren
id|invalidate
c_func
(paren
)paren
suffix:semicolon
id|swap_free
(paren
id|swap_nr
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_for
c_loop
(paren
id|shmd
op_assign
id|shp-&gt;attaches
suffix:semicolon
suffix:semicolon
)paren
(brace
r_do
(brace
r_int
r_int
id|tmp
comma
op_star
id|pte
suffix:semicolon
r_if
c_cond
(paren
(paren
id|shmd-&gt;vm_pte
op_rshift
id|SHM_ID_SHIFT
op_amp
id|SHM_ID_MASK
)paren
op_ne
id|id
)paren
(brace
id|printk
(paren
l_string|&quot;shm_swap: id=%ld does not match shmd-&gt;vm_pte.id=%ld&bslash;n&quot;
comma
id|id
comma
id|shmd-&gt;vm_pte
op_rshift
id|SHM_ID_SHIFT
op_amp
id|SHM_ID_MASK
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
id|tmp
op_assign
id|shmd-&gt;vm_start
op_plus
(paren
id|idx
op_lshift
id|PAGE_SHIFT
)paren
op_minus
id|shmd-&gt;vm_offset
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|tmp
op_ge
id|shmd-&gt;vm_start
op_logical_and
id|tmp
OL
id|shmd-&gt;vm_end
)paren
)paren
r_continue
suffix:semicolon
id|pte
op_assign
id|PAGE_DIR_OFFSET
c_func
(paren
id|shmd-&gt;vm_task
comma
id|tmp
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
op_star
id|pte
op_amp
id|PAGE_PRESENT
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;shm_swap: bad pgtbl! id=%ld start=%lx idx=%ld&bslash;n&quot;
comma
id|id
comma
id|shmd-&gt;vm_start
comma
id|idx
)paren
suffix:semicolon
op_star
id|pte
op_assign
l_int|0
suffix:semicolon
r_continue
suffix:semicolon
)brace
id|pte
op_assign
(paren
id|ulong
op_star
)paren
(paren
id|PAGE_MASK
op_amp
op_star
id|pte
)paren
suffix:semicolon
id|pte
op_add_assign
(paren
(paren
id|tmp
op_rshift
id|PAGE_SHIFT
)paren
op_amp
(paren
id|PTRS_PER_PAGE
op_minus
l_int|1
)paren
)paren
suffix:semicolon
id|tmp
op_assign
op_star
id|pte
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|tmp
op_amp
id|PAGE_PRESENT
)paren
)paren
r_continue
suffix:semicolon
r_if
c_cond
(paren
id|tmp
op_amp
id|PAGE_ACCESSED
)paren
(brace
op_star
id|pte
op_and_assign
op_complement
id|PAGE_ACCESSED
suffix:semicolon
r_continue
suffix:semicolon
)brace
op_star
id|pte
op_assign
id|shmd-&gt;vm_pte
op_or
id|idx
op_lshift
id|SHM_IDX_SHIFT
suffix:semicolon
id|mem_map
(braket
id|MAP_NR
c_func
(paren
id|page
)paren
)braket
op_decrement
suffix:semicolon
id|shmd-&gt;vm_task-&gt;mm-&gt;rss
op_decrement
suffix:semicolon
id|invalid
op_increment
suffix:semicolon
multiline_comment|/* continue looping through circular list */
)brace
r_while
c_loop
(paren
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|shmd
op_assign
id|shmd-&gt;vm_next_share
)paren
op_eq
id|shp-&gt;attaches
)paren
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|mem_map
(braket
id|MAP_NR
c_func
(paren
id|page
)paren
)braket
op_ne
l_int|1
)paren
r_goto
id|check_table
suffix:semicolon
id|page
op_and_assign
id|PAGE_MASK
suffix:semicolon
id|shp-&gt;shm_pages
(braket
id|idx
)braket
op_assign
id|swap_nr
suffix:semicolon
r_if
c_cond
(paren
id|invalid
)paren
id|invalidate
c_func
(paren
)paren
suffix:semicolon
id|write_swap_page
(paren
id|swap_nr
comma
(paren
r_char
op_star
)paren
id|page
)paren
suffix:semicolon
id|free_page
(paren
id|page
)paren
suffix:semicolon
id|swap_successes
op_increment
suffix:semicolon
id|shm_swp
op_increment
suffix:semicolon
id|shm_rss
op_decrement
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
eof
