multiline_comment|/*&n; * linux/ipc/shm.c&n; * Copyright (C) 1992, 1993 Krishna Balasubramanian&n; *&t; Many improvements/fixes by Bruno Haible.&n; * Replaced `struct shm_desc&squot; by `struct vm_area_struct&squot;, July 1994.&n; * Fixed the shm swap deallocation (shm_unuse()), August 1998 Andrea Arcangeli.&n; *&n; * /proc/sysvipc/shm support (c) 1999 Dragos Acostachioaie &lt;dragos@iname.com&gt;&n; * BIGMEM support, Andrea Arcangeli &lt;andrea@suse.de&gt;&n; * SMP thread shm, Jean-Luc Boyard &lt;jean-luc.boyard@siemens.fr&gt;&n; * HIGHMEM support, Ingo Molnar &lt;mingo@redhat.com&gt;&n; * avoid vmalloc and make shmmax, shmall, shmmni sysctl&squot;able,&n; *                         Christoph Rohland &lt;hans-christoph.rohland@sap.com&gt;&n; * Shared /dev/zero support, Kanoj Sarcar &lt;kanoj@sgi.com&gt;&n; * make it a file system,  Christoph Rohland &lt;hans-christoph.rohland@sap.com&gt;&n; *&n; * The filesystem has the following restrictions/bugs:&n; * 1) It only can handle one directory.&n; * 2) Because the directory is represented by the SYSV shm array it&n; *    can only be mounted one time.&n; * 3) This again leads to SYSV shm not working properly in a chrooted&n; *    environment&n; * 4) Read and write are not implemented (should they?)&n; * 5) No special nodes are supported&n; */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/malloc.h&gt;
macro_line|#include &lt;linux/shm.h&gt;
macro_line|#include &lt;linux/swap.h&gt;
macro_line|#include &lt;linux/smp_lock.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/locks.h&gt;
macro_line|#include &lt;linux/file.h&gt;
macro_line|#include &lt;linux/mman.h&gt;
macro_line|#include &lt;linux/vmalloc.h&gt;
macro_line|#include &lt;linux/pagemap.h&gt;
macro_line|#include &lt;linux/proc_fs.h&gt;
macro_line|#include &lt;linux/highmem.h&gt;
macro_line|#include &lt;asm/uaccess.h&gt;
macro_line|#include &lt;asm/pgtable.h&gt;
macro_line|#include &quot;util.h&quot;
r_static
r_struct
id|super_block
op_star
id|shm_read_super
c_func
(paren
r_struct
id|super_block
op_star
comma
r_void
op_star
comma
r_int
)paren
suffix:semicolon
r_static
r_void
id|shm_put_super
(paren
r_struct
id|super_block
op_star
)paren
suffix:semicolon
r_static
r_int
id|shm_remount_fs
(paren
r_struct
id|super_block
op_star
comma
r_int
op_star
comma
r_char
op_star
)paren
suffix:semicolon
r_static
r_void
id|shm_read_inode
(paren
r_struct
id|inode
op_star
)paren
suffix:semicolon
r_static
r_void
id|shm_write_inode
c_func
(paren
r_struct
id|inode
op_star
)paren
suffix:semicolon
r_static
r_int
id|shm_statfs
(paren
r_struct
id|super_block
op_star
comma
r_struct
id|statfs
op_star
)paren
suffix:semicolon
r_static
r_int
id|shm_create
(paren
r_struct
id|inode
op_star
comma
r_struct
id|dentry
op_star
comma
r_int
)paren
suffix:semicolon
r_static
r_struct
id|dentry
op_star
id|shm_lookup
(paren
r_struct
id|inode
op_star
comma
r_struct
id|dentry
op_star
)paren
suffix:semicolon
r_static
r_int
id|shm_unlink
(paren
r_struct
id|inode
op_star
comma
r_struct
id|dentry
op_star
)paren
suffix:semicolon
r_static
r_int
id|shm_setattr
(paren
r_struct
id|dentry
op_star
id|dent
comma
r_struct
id|iattr
op_star
id|attr
)paren
suffix:semicolon
r_static
r_void
id|shm_delete
(paren
r_struct
id|inode
op_star
)paren
suffix:semicolon
r_static
r_int
id|shm_mmap
(paren
r_struct
id|file
op_star
comma
r_struct
id|vm_area_struct
op_star
)paren
suffix:semicolon
r_static
r_int
id|shm_readdir
(paren
r_struct
id|file
op_star
comma
r_void
op_star
comma
id|filldir_t
)paren
suffix:semicolon
DECL|variable|shm_path
r_char
id|shm_path
(braket
l_int|256
)braket
op_assign
l_string|&quot;/var/shm&quot;
suffix:semicolon
DECL|macro|SHM_NAME_LEN
mdefine_line|#define SHM_NAME_LEN NAME_MAX
DECL|macro|SHM_FMT
mdefine_line|#define SHM_FMT &quot;.IPC_%08x&quot;
DECL|macro|SHM_FMT_LEN
mdefine_line|#define SHM_FMT_LEN 13
DECL|struct|shmid_kernel
r_struct
id|shmid_kernel
multiline_comment|/* private to the kernel */
(brace
DECL|member|shm_perm
r_struct
id|kern_ipc_perm
id|shm_perm
suffix:semicolon
DECL|member|shm_segsz
r_int
id|shm_segsz
suffix:semicolon
DECL|member|shm_nattch
r_int
r_int
id|shm_nattch
suffix:semicolon
DECL|member|shm_npages
r_int
r_int
id|shm_npages
suffix:semicolon
multiline_comment|/* size of segment (pages) */
DECL|member|shm_dir
id|pte_t
op_star
op_star
id|shm_dir
suffix:semicolon
multiline_comment|/* ptr to arr of ptrs to frames */
DECL|member|id
r_int
id|id
suffix:semicolon
DECL|union|permap
r_union
id|permap
(brace
DECL|struct|shmem
r_struct
id|shmem
(brace
DECL|member|atime
id|time_t
id|atime
suffix:semicolon
DECL|member|dtime
id|time_t
id|dtime
suffix:semicolon
DECL|member|ctime
id|time_t
id|ctime
suffix:semicolon
DECL|member|cpid
id|pid_t
id|cpid
suffix:semicolon
DECL|member|lpid
id|pid_t
id|lpid
suffix:semicolon
DECL|member|nlen
r_int
id|nlen
suffix:semicolon
DECL|member|nm
r_char
id|nm
(braket
l_int|0
)braket
suffix:semicolon
DECL|member|shmem
)brace
id|shmem
suffix:semicolon
DECL|struct|zero
r_struct
id|zero
(brace
DECL|member|sema
r_struct
id|semaphore
id|sema
suffix:semicolon
DECL|member|list
r_struct
id|list_head
id|list
suffix:semicolon
DECL|member|zero
)brace
id|zero
suffix:semicolon
DECL|member|permap
)brace
id|permap
suffix:semicolon
)brace
suffix:semicolon
DECL|macro|shm_atim
mdefine_line|#define shm_atim&t;permap.shmem.atime
DECL|macro|shm_dtim
mdefine_line|#define shm_dtim&t;permap.shmem.dtime
DECL|macro|shm_ctim
mdefine_line|#define shm_ctim&t;permap.shmem.ctime
DECL|macro|shm_cprid
mdefine_line|#define shm_cprid&t;permap.shmem.cpid
DECL|macro|shm_lprid
mdefine_line|#define shm_lprid&t;permap.shmem.lpid
DECL|macro|shm_namelen
mdefine_line|#define shm_namelen&t;permap.shmem.nlen
DECL|macro|shm_name
mdefine_line|#define shm_name&t;permap.shmem.nm
DECL|macro|zsem
mdefine_line|#define zsem&t;&t;permap.zero.sema
DECL|macro|zero_list
mdefine_line|#define zero_list&t;permap.zero.list
DECL|variable|shm_ids
r_static
r_struct
id|ipc_ids
id|shm_ids
suffix:semicolon
DECL|macro|shm_lock
mdefine_line|#define shm_lock(id)&t;((struct shmid_kernel*)ipc_lock(&amp;shm_ids,id))
DECL|macro|shm_unlock
mdefine_line|#define shm_unlock(id)&t;ipc_unlock(&amp;shm_ids,id)
DECL|macro|shm_lockall
mdefine_line|#define shm_lockall()&t;ipc_lockall(&amp;shm_ids)
DECL|macro|shm_unlockall
mdefine_line|#define shm_unlockall()&t;ipc_unlockall(&amp;shm_ids)
DECL|macro|shm_get
mdefine_line|#define shm_get(id)&t;((struct shmid_kernel*)ipc_get(&amp;shm_ids,id))
DECL|macro|shm_rmid
mdefine_line|#define shm_rmid(id)&t;((struct shmid_kernel*)ipc_rmid(&amp;shm_ids,id))
DECL|macro|shm_checkid
mdefine_line|#define shm_checkid(s, id)&t;&bslash;&n;&t;ipc_checkid(&amp;shm_ids,&amp;s-&gt;shm_perm,id)
DECL|macro|shm_buildid
mdefine_line|#define shm_buildid(id, seq) &bslash;&n;&t;ipc_buildid(&amp;shm_ids, id, seq)
r_static
r_int
id|newseg
(paren
id|key_t
id|key
comma
r_const
r_char
op_star
id|name
comma
r_int
id|namelen
comma
r_int
id|shmflg
comma
r_int
id|size
)paren
suffix:semicolon
r_static
r_void
id|killseg_core
c_func
(paren
r_struct
id|shmid_kernel
op_star
id|shp
comma
r_int
id|doacc
)paren
suffix:semicolon
r_static
r_void
id|shm_open
(paren
r_struct
id|vm_area_struct
op_star
id|shmd
)paren
suffix:semicolon
r_static
r_void
id|shm_close
(paren
r_struct
id|vm_area_struct
op_star
id|shmd
)paren
suffix:semicolon
r_static
r_struct
id|page
op_star
id|shm_nopage
c_func
(paren
r_struct
id|vm_area_struct
op_star
comma
r_int
r_int
comma
r_int
)paren
suffix:semicolon
r_static
r_int
id|shm_swapout
c_func
(paren
r_struct
id|page
op_star
comma
r_struct
id|file
op_star
)paren
suffix:semicolon
macro_line|#ifdef CONFIG_PROC_FS
r_static
r_int
id|sysvipc_shm_read_proc
c_func
(paren
r_char
op_star
id|buffer
comma
r_char
op_star
op_star
id|start
comma
id|off_t
id|offset
comma
r_int
id|length
comma
r_int
op_star
id|eof
comma
r_void
op_star
id|data
)paren
suffix:semicolon
macro_line|#endif
r_static
r_void
id|zshm_swap
(paren
r_int
id|prio
comma
r_int
id|gfp_mask
comma
id|zone_t
op_star
id|zone
)paren
suffix:semicolon
r_static
r_void
id|zmap_unuse
c_func
(paren
id|swp_entry_t
id|entry
comma
r_struct
id|page
op_star
id|page
)paren
suffix:semicolon
r_static
r_void
id|shmzero_open
c_func
(paren
r_struct
id|vm_area_struct
op_star
id|shmd
)paren
suffix:semicolon
r_static
r_void
id|shmzero_close
c_func
(paren
r_struct
id|vm_area_struct
op_star
id|shmd
)paren
suffix:semicolon
r_static
r_struct
id|page
op_star
id|shmzero_nopage
c_func
(paren
r_struct
id|vm_area_struct
op_star
id|shmd
comma
r_int
r_int
id|address
comma
r_int
id|no_share
)paren
suffix:semicolon
DECL|variable|zero_id
r_static
r_int
id|zero_id
suffix:semicolon
DECL|variable|zshmid_kernel
r_static
r_struct
id|shmid_kernel
id|zshmid_kernel
suffix:semicolon
DECL|variable|zdent
r_static
r_struct
id|dentry
op_star
id|zdent
suffix:semicolon
DECL|macro|SHM_FS_MAGIC
mdefine_line|#define SHM_FS_MAGIC 0x02011994
DECL|variable|shm_sb
r_static
r_struct
id|super_block
op_star
id|shm_sb
suffix:semicolon
r_static
id|DECLARE_FSTYPE
c_func
(paren
id|shm_fs_type
comma
l_string|&quot;shm&quot;
comma
id|shm_read_super
comma
l_int|0
)paren
suffix:semicolon
DECL|variable|shm_sops
r_static
r_struct
id|super_operations
id|shm_sops
op_assign
(brace
id|read_inode
suffix:colon
id|shm_read_inode
comma
id|write_inode
suffix:colon
id|shm_write_inode
comma
id|delete_inode
suffix:colon
id|shm_delete
comma
id|put_super
suffix:colon
id|shm_put_super
comma
id|statfs
suffix:colon
id|shm_statfs
comma
id|remount_fs
suffix:colon
id|shm_remount_fs
comma
)brace
suffix:semicolon
DECL|variable|shm_root_operations
r_static
r_struct
id|file_operations
id|shm_root_operations
op_assign
(brace
id|readdir
suffix:colon
id|shm_readdir
comma
)brace
suffix:semicolon
DECL|variable|shm_root_inode_operations
r_static
r_struct
id|inode_operations
id|shm_root_inode_operations
op_assign
(brace
id|create
suffix:colon
id|shm_create
comma
id|lookup
suffix:colon
id|shm_lookup
comma
id|unlink
suffix:colon
id|shm_unlink
comma
)brace
suffix:semicolon
DECL|variable|shm_file_operations
r_static
r_struct
id|file_operations
id|shm_file_operations
op_assign
(brace
id|mmap
suffix:colon
id|shm_mmap
comma
)brace
suffix:semicolon
DECL|variable|shm_inode_operations
r_static
r_struct
id|inode_operations
id|shm_inode_operations
op_assign
(brace
id|setattr
suffix:colon
id|shm_setattr
comma
)brace
suffix:semicolon
DECL|variable|shm_vm_ops
r_static
r_struct
id|vm_operations_struct
id|shm_vm_ops
op_assign
(brace
id|open
suffix:colon
id|shm_open
comma
multiline_comment|/* callback for a new vm-area open */
id|close
suffix:colon
id|shm_close
comma
multiline_comment|/* callback for when the vm-area is released */
id|nopage
suffix:colon
id|shm_nopage
comma
id|swapout
suffix:colon
id|shm_swapout
comma
)brace
suffix:semicolon
DECL|variable|shm_ctlmax
r_int
id|shm_ctlmax
op_assign
id|SHMMAX
suffix:semicolon
multiline_comment|/* These parameters should be part of the superblock */
DECL|variable|shm_ctlall
r_static
r_int
id|shm_ctlall
suffix:semicolon
DECL|variable|shm_ctlmni
r_static
r_int
id|shm_ctlmni
suffix:semicolon
DECL|variable|shm_mode
r_static
r_int
id|shm_mode
suffix:semicolon
DECL|variable|shm_tot
r_static
r_int
id|shm_tot
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* total number of shared memory pages */
DECL|variable|shm_rss
r_static
r_int
id|shm_rss
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* number of shared memory pages that are in memory */
DECL|variable|shm_swp
r_static
r_int
id|shm_swp
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* number of shared memory pages that are in swap */
multiline_comment|/* locks order:&n;&t;pagecache_lock&n;&t;shm_lock()/shm_lockall()&n;&t;kernel lock&n;&t;inode-&gt;i_sem&n;&t;sem_ids.sem&n;&t;mmap_sem&n;&n;  SMP assumptions:&n;  - swap_free() never sleeps&n;  - add_to_swap_cache() never sleeps&n;  - add_to_swap_cache() doesn&squot;t acquire the big kernel lock.&n;  - shm_unuse() is called with the kernel lock acquired.&n; */
multiline_comment|/* some statistics */
DECL|variable|swap_attempts
r_static
id|ulong
id|swap_attempts
op_assign
l_int|0
suffix:semicolon
DECL|variable|swap_successes
r_static
id|ulong
id|swap_successes
op_assign
l_int|0
suffix:semicolon
DECL|variable|used_segs
r_static
id|ulong
id|used_segs
op_assign
l_int|0
suffix:semicolon
DECL|function|shm_init
r_void
id|__init
id|shm_init
(paren
r_void
)paren
(brace
id|ipc_init_ids
c_func
(paren
op_amp
id|shm_ids
comma
l_int|1
)paren
suffix:semicolon
id|register_filesystem
(paren
op_amp
id|shm_fs_type
)paren
suffix:semicolon
macro_line|#ifdef CONFIG_PROC_FS
id|create_proc_read_entry
c_func
(paren
l_string|&quot;sysvipc/shm&quot;
comma
l_int|0
comma
l_int|0
comma
id|sysvipc_shm_read_proc
comma
l_int|NULL
)paren
suffix:semicolon
macro_line|#endif
id|zero_id
op_assign
id|ipc_addid
c_func
(paren
op_amp
id|shm_ids
comma
op_amp
id|zshmid_kernel.shm_perm
comma
l_int|1
)paren
suffix:semicolon
id|shm_unlock
c_func
(paren
id|zero_id
)paren
suffix:semicolon
id|INIT_LIST_HEAD
c_func
(paren
op_amp
id|zshmid_kernel.zero_list
)paren
suffix:semicolon
id|zdent
op_assign
id|d_alloc_root
c_func
(paren
id|get_empty_inode
c_func
(paren
)paren
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
DECL|function|shm_parse_options
r_static
r_int
id|shm_parse_options
c_func
(paren
r_char
op_star
id|options
)paren
(brace
r_int
id|blocks
op_assign
id|shm_ctlall
suffix:semicolon
r_int
id|inodes
op_assign
id|shm_ctlmni
suffix:semicolon
id|umode_t
id|mode
op_assign
id|shm_mode
suffix:semicolon
r_char
op_star
id|this_char
comma
op_star
id|value
suffix:semicolon
id|this_char
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
id|options
)paren
id|this_char
op_assign
id|strtok
c_func
(paren
id|options
comma
l_string|&quot;,&quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
suffix:semicolon
id|this_char
suffix:semicolon
id|this_char
op_assign
id|strtok
c_func
(paren
l_int|NULL
comma
l_string|&quot;,&quot;
)paren
)paren
(brace
r_if
c_cond
(paren
(paren
id|value
op_assign
id|strchr
c_func
(paren
id|this_char
comma
l_char|&squot;=&squot;
)paren
)paren
op_ne
l_int|NULL
)paren
op_star
id|value
op_increment
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|strcmp
c_func
(paren
id|this_char
comma
l_string|&quot;nr_blocks&quot;
)paren
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|value
op_logical_or
op_logical_neg
op_star
id|value
)paren
r_return
l_int|1
suffix:semicolon
id|blocks
op_assign
id|simple_strtoul
c_func
(paren
id|value
comma
op_amp
id|value
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
op_star
id|value
)paren
r_return
l_int|1
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
op_logical_neg
id|strcmp
c_func
(paren
id|this_char
comma
l_string|&quot;nr_inodes&quot;
)paren
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|value
op_logical_or
op_logical_neg
op_star
id|value
)paren
r_return
l_int|1
suffix:semicolon
id|inodes
op_assign
id|simple_strtoul
c_func
(paren
id|value
comma
op_amp
id|value
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
op_star
id|value
)paren
r_return
l_int|1
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
op_logical_neg
id|strcmp
c_func
(paren
id|this_char
comma
l_string|&quot;mode&quot;
)paren
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|value
op_logical_or
op_logical_neg
op_star
id|value
)paren
r_return
l_int|1
suffix:semicolon
id|mode
op_assign
id|simple_strtoul
c_func
(paren
id|value
comma
op_amp
id|value
comma
l_int|8
)paren
suffix:semicolon
r_if
c_cond
(paren
op_star
id|value
)paren
r_return
l_int|1
suffix:semicolon
)brace
r_else
r_return
l_int|1
suffix:semicolon
)brace
id|shm_ctlmni
op_assign
id|inodes
suffix:semicolon
id|shm_ctlall
op_assign
id|blocks
suffix:semicolon
id|shm_mode
op_assign
id|mode
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|shm_read_super
r_static
r_struct
id|super_block
op_star
id|shm_read_super
c_func
(paren
r_struct
id|super_block
op_star
id|s
comma
r_void
op_star
id|data
comma
r_int
id|silent
)paren
(brace
r_struct
id|inode
op_star
id|root_inode
suffix:semicolon
r_if
c_cond
(paren
id|shm_sb
)paren
(brace
id|printk
(paren
l_string|&quot;shm fs already mounted&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
id|shm_ctlall
op_assign
id|SHMALL
suffix:semicolon
id|shm_ctlmni
op_assign
id|SHMMNI
suffix:semicolon
id|shm_mode
op_assign
id|S_IRWXUGO
op_or
id|S_ISVTX
suffix:semicolon
r_if
c_cond
(paren
id|shm_parse_options
(paren
id|data
)paren
)paren
(brace
id|printk
(paren
l_string|&quot;shm fs invalid option&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|out_unlock
suffix:semicolon
)brace
id|s-&gt;s_blocksize
op_assign
id|PAGE_SIZE
suffix:semicolon
id|s-&gt;s_blocksize_bits
op_assign
id|PAGE_SHIFT
suffix:semicolon
id|s-&gt;s_magic
op_assign
id|SHM_FS_MAGIC
suffix:semicolon
id|s-&gt;s_op
op_assign
op_amp
id|shm_sops
suffix:semicolon
id|root_inode
op_assign
id|iget
(paren
id|s
comma
id|SEQ_MULTIPLIER
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|root_inode
)paren
r_goto
id|out_no_root
suffix:semicolon
id|root_inode-&gt;i_op
op_assign
op_amp
id|shm_root_inode_operations
suffix:semicolon
id|root_inode-&gt;i_sb
op_assign
id|s
suffix:semicolon
id|root_inode-&gt;i_nlink
op_assign
l_int|2
suffix:semicolon
id|root_inode-&gt;i_mode
op_assign
id|S_IFDIR
op_or
id|shm_mode
suffix:semicolon
id|s-&gt;s_root
op_assign
id|d_alloc_root
c_func
(paren
id|root_inode
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|s-&gt;s_root
)paren
r_goto
id|out_no_root
suffix:semicolon
id|s-&gt;u.generic_sbp
op_assign
(paren
r_void
op_star
)paren
id|shm_sb
suffix:semicolon
id|shm_sb
op_assign
id|s
suffix:semicolon
r_return
id|s
suffix:semicolon
id|out_no_root
suffix:colon
id|printk
c_func
(paren
l_string|&quot;proc_read_super: get root inode failed&bslash;n&quot;
)paren
suffix:semicolon
id|iput
c_func
(paren
id|root_inode
)paren
suffix:semicolon
id|out_unlock
suffix:colon
r_return
l_int|NULL
suffix:semicolon
)brace
DECL|function|shm_remount_fs
r_static
r_int
id|shm_remount_fs
(paren
r_struct
id|super_block
op_star
id|sb
comma
r_int
op_star
id|flags
comma
r_char
op_star
id|data
)paren
(brace
r_if
c_cond
(paren
id|shm_parse_options
(paren
id|data
)paren
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|shm_put_super
r_static
r_void
id|shm_put_super
c_func
(paren
r_struct
id|super_block
op_star
id|sb
)paren
(brace
r_struct
id|super_block
op_star
op_star
id|p
op_assign
op_amp
id|shm_sb
suffix:semicolon
r_int
id|i
suffix:semicolon
r_struct
id|shmid_kernel
op_star
id|shp
suffix:semicolon
r_while
c_loop
(paren
op_star
id|p
op_ne
id|sb
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
op_star
id|p
)paren
multiline_comment|/* should never happen */
r_return
suffix:semicolon
id|p
op_assign
(paren
r_struct
id|super_block
op_star
op_star
)paren
op_amp
(paren
op_star
id|p
)paren
op_member_access_from_pointer
id|u.generic_sbp
suffix:semicolon
)brace
op_star
id|p
op_assign
(paren
r_struct
id|super_block
op_star
)paren
(paren
op_star
id|p
)paren
op_member_access_from_pointer
id|u.generic_sbp
suffix:semicolon
id|down
c_func
(paren
op_amp
id|shm_ids.sem
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
op_le
id|shm_ids.max_id
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|i
op_eq
id|zero_id
)paren
r_continue
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|shp
op_assign
id|shm_lock
(paren
id|i
)paren
)paren
)paren
r_continue
suffix:semicolon
r_if
c_cond
(paren
id|shp-&gt;shm_nattch
)paren
id|printk
(paren
l_string|&quot;shm_nattch = %ld&bslash;n&quot;
comma
id|shp-&gt;shm_nattch
)paren
suffix:semicolon
id|shp
op_assign
id|shm_rmid
c_func
(paren
id|i
)paren
suffix:semicolon
id|shm_unlock
c_func
(paren
id|i
)paren
suffix:semicolon
id|killseg_core
c_func
(paren
id|shp
comma
l_int|1
)paren
suffix:semicolon
)brace
id|dput
(paren
id|sb-&gt;s_root
)paren
suffix:semicolon
id|up
c_func
(paren
op_amp
id|shm_ids.sem
)paren
suffix:semicolon
)brace
DECL|function|shm_statfs
r_static
r_int
id|shm_statfs
c_func
(paren
r_struct
id|super_block
op_star
id|sb
comma
r_struct
id|statfs
op_star
id|buf
)paren
(brace
id|buf-&gt;f_type
op_assign
l_int|0
suffix:semicolon
id|buf-&gt;f_bsize
op_assign
id|PAGE_SIZE
suffix:semicolon
id|buf-&gt;f_blocks
op_assign
id|shm_ctlall
suffix:semicolon
id|buf-&gt;f_bavail
op_assign
id|buf-&gt;f_bfree
op_assign
id|shm_ctlall
op_minus
id|shm_tot
suffix:semicolon
id|buf-&gt;f_files
op_assign
id|shm_ctlmni
suffix:semicolon
id|buf-&gt;f_ffree
op_assign
id|shm_ctlmni
op_minus
id|used_segs
suffix:semicolon
id|buf-&gt;f_namelen
op_assign
id|SHM_NAME_LEN
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|shm_write_inode
r_static
r_void
id|shm_write_inode
c_func
(paren
r_struct
id|inode
op_star
id|inode
)paren
(brace
)brace
DECL|function|shm_read_inode
r_static
r_void
id|shm_read_inode
c_func
(paren
r_struct
id|inode
op_star
id|inode
)paren
(brace
r_int
id|id
suffix:semicolon
r_struct
id|shmid_kernel
op_star
id|shp
suffix:semicolon
id|id
op_assign
id|inode-&gt;i_ino
suffix:semicolon
id|inode-&gt;i_op
op_assign
l_int|NULL
suffix:semicolon
id|inode-&gt;i_mode
op_assign
l_int|0
suffix:semicolon
id|inode-&gt;i_mtime
op_assign
id|inode-&gt;i_atime
op_assign
id|inode-&gt;i_ctime
op_assign
id|CURRENT_TIME
suffix:semicolon
r_if
c_cond
(paren
id|id
OL
id|SEQ_MULTIPLIER
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|shp
op_assign
id|shm_lock
(paren
id|id
)paren
)paren
)paren
r_return
suffix:semicolon
id|inode-&gt;i_mode
op_assign
id|shp-&gt;shm_perm.mode
op_or
id|S_IFREG
suffix:semicolon
id|inode-&gt;i_uid
op_assign
id|shp-&gt;shm_perm.uid
suffix:semicolon
id|inode-&gt;i_gid
op_assign
id|shp-&gt;shm_perm.gid
suffix:semicolon
id|inode-&gt;i_size
op_assign
id|shp-&gt;shm_segsz
suffix:semicolon
id|shm_unlock
(paren
id|id
)paren
suffix:semicolon
id|inode-&gt;i_op
op_assign
op_amp
id|shm_inode_operations
suffix:semicolon
id|inode-&gt;i_fop
op_assign
op_amp
id|shm_file_operations
suffix:semicolon
r_return
suffix:semicolon
)brace
id|inode-&gt;i_op
op_assign
op_amp
id|shm_root_inode_operations
suffix:semicolon
id|inode-&gt;i_fop
op_assign
op_amp
id|shm_root_operations
suffix:semicolon
id|inode-&gt;i_sb
op_assign
id|shm_sb
suffix:semicolon
id|inode-&gt;i_nlink
op_assign
l_int|2
suffix:semicolon
id|inode-&gt;i_mode
op_assign
id|S_IFDIR
op_or
id|shm_mode
suffix:semicolon
id|inode-&gt;i_uid
op_assign
id|inode-&gt;i_gid
op_assign
l_int|0
suffix:semicolon
)brace
DECL|function|shm_create
r_static
r_int
id|shm_create
(paren
r_struct
id|inode
op_star
id|dir
comma
r_struct
id|dentry
op_star
id|dent
comma
r_int
id|mode
)paren
(brace
r_int
id|id
comma
id|err
suffix:semicolon
r_struct
id|inode
op_star
id|inode
suffix:semicolon
id|down
c_func
(paren
op_amp
id|shm_ids.sem
)paren
suffix:semicolon
id|err
op_assign
id|id
op_assign
id|newseg
(paren
id|IPC_PRIVATE
comma
id|dent-&gt;d_name.name
comma
id|dent-&gt;d_name.len
comma
id|mode
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
OL
l_int|0
)paren
r_goto
id|out
suffix:semicolon
id|err
op_assign
op_minus
id|ENOMEM
suffix:semicolon
id|inode
op_assign
id|iget
(paren
id|shm_sb
comma
id|id
op_mod
id|SEQ_MULTIPLIER
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|inode
)paren
r_goto
id|out
suffix:semicolon
id|err
op_assign
l_int|0
suffix:semicolon
id|down
(paren
op_amp
id|inode-&gt;i_sem
)paren
suffix:semicolon
id|inode-&gt;i_mode
op_assign
id|mode
op_or
id|S_IFREG
suffix:semicolon
id|inode-&gt;i_op
op_assign
op_amp
id|shm_inode_operations
suffix:semicolon
id|d_instantiate
c_func
(paren
id|dent
comma
id|inode
)paren
suffix:semicolon
id|up
(paren
op_amp
id|inode-&gt;i_sem
)paren
suffix:semicolon
id|out
suffix:colon
id|up
c_func
(paren
op_amp
id|shm_ids.sem
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
DECL|function|shm_readdir
r_static
r_int
id|shm_readdir
(paren
r_struct
id|file
op_star
id|filp
comma
r_void
op_star
id|dirent
comma
id|filldir_t
id|filldir
)paren
(brace
r_struct
id|inode
op_star
id|inode
op_assign
id|filp-&gt;f_dentry-&gt;d_inode
suffix:semicolon
r_struct
id|shmid_kernel
op_star
id|shp
suffix:semicolon
id|off_t
id|nr
suffix:semicolon
id|nr
op_assign
id|filp-&gt;f_pos
suffix:semicolon
r_switch
c_cond
(paren
id|nr
)paren
(brace
r_case
l_int|0
suffix:colon
r_if
c_cond
(paren
id|filldir
c_func
(paren
id|dirent
comma
l_string|&quot;.&quot;
comma
l_int|1
comma
id|nr
comma
id|inode-&gt;i_ino
)paren
OL
l_int|0
)paren
r_return
l_int|0
suffix:semicolon
id|filp-&gt;f_pos
op_assign
op_increment
id|nr
suffix:semicolon
multiline_comment|/* fall through */
r_case
l_int|1
suffix:colon
r_if
c_cond
(paren
id|filldir
c_func
(paren
id|dirent
comma
l_string|&quot;..&quot;
comma
l_int|2
comma
id|nr
comma
id|inode-&gt;i_ino
)paren
OL
l_int|0
)paren
r_return
l_int|0
suffix:semicolon
id|filp-&gt;f_pos
op_assign
op_increment
id|nr
suffix:semicolon
multiline_comment|/* fall through */
r_default
suffix:colon
id|down
c_func
(paren
op_amp
id|shm_ids.sem
)paren
suffix:semicolon
r_for
c_loop
(paren
suffix:semicolon
id|nr
op_minus
l_int|2
op_le
id|shm_ids.max_id
suffix:semicolon
id|nr
op_increment
)paren
(brace
r_if
c_cond
(paren
id|nr
op_minus
l_int|2
op_eq
id|zero_id
)paren
r_continue
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|shp
op_assign
id|shm_get
(paren
id|nr
op_minus
l_int|2
)paren
)paren
)paren
r_continue
suffix:semicolon
r_if
c_cond
(paren
id|shp-&gt;shm_perm.mode
op_amp
id|SHM_DEST
)paren
r_continue
suffix:semicolon
r_if
c_cond
(paren
id|filldir
c_func
(paren
id|dirent
comma
id|shp-&gt;shm_name
comma
id|shp-&gt;shm_namelen
comma
id|nr
comma
id|nr
)paren
OL
l_int|0
)paren
r_break
suffix:semicolon
suffix:semicolon
)brace
id|filp-&gt;f_pos
op_assign
id|nr
suffix:semicolon
id|up
c_func
(paren
op_amp
id|shm_ids.sem
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|UPDATE_ATIME
c_func
(paren
id|inode
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|shm_lookup
r_static
r_struct
id|dentry
op_star
id|shm_lookup
(paren
r_struct
id|inode
op_star
id|dir
comma
r_struct
id|dentry
op_star
id|dent
)paren
(brace
r_int
id|i
comma
id|err
op_assign
l_int|0
suffix:semicolon
r_struct
id|shmid_kernel
op_star
id|shp
suffix:semicolon
r_struct
id|inode
op_star
id|inode
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
id|dent-&gt;d_name.len
OG
id|SHM_NAME_LEN
)paren
r_return
id|ERR_PTR
c_func
(paren
op_minus
id|ENAMETOOLONG
)paren
suffix:semicolon
id|down
c_func
(paren
op_amp
id|shm_ids.sem
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
op_le
id|shm_ids.max_id
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|i
op_eq
id|zero_id
)paren
r_continue
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|shp
op_assign
id|shm_lock
c_func
(paren
id|i
)paren
)paren
)paren
r_continue
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|shp-&gt;shm_perm.mode
op_amp
id|SHM_DEST
)paren
op_logical_and
id|dent-&gt;d_name.len
op_eq
id|shp-&gt;shm_namelen
op_logical_and
id|strncmp
c_func
(paren
id|dent-&gt;d_name.name
comma
id|shp-&gt;shm_name
comma
id|shp-&gt;shm_namelen
)paren
op_eq
l_int|0
)paren
r_goto
id|found
suffix:semicolon
id|shm_unlock
c_func
(paren
id|i
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * prevent the reserved names as negative dentries. &n;&t; * This also prevents object creation through the filesystem&n;&t; */
r_if
c_cond
(paren
id|dent-&gt;d_name.len
op_eq
id|SHM_FMT_LEN
op_logical_and
id|memcmp
(paren
id|SHM_FMT
comma
id|dent-&gt;d_name.name
comma
id|SHM_FMT_LEN
op_minus
l_int|8
)paren
op_eq
l_int|0
)paren
id|err
op_assign
op_minus
id|EINVAL
suffix:semicolon
multiline_comment|/* EINVAL to give IPC_RMID the right error */
r_goto
id|out
suffix:semicolon
id|found
suffix:colon
id|shm_unlock
c_func
(paren
id|i
)paren
suffix:semicolon
id|inode
op_assign
id|iget
c_func
(paren
id|dir-&gt;i_sb
comma
id|i
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|inode
)paren
id|err
op_assign
op_minus
id|EACCES
suffix:semicolon
id|out
suffix:colon
r_if
c_cond
(paren
id|err
op_eq
l_int|0
)paren
id|d_add
(paren
id|dent
comma
id|inode
)paren
suffix:semicolon
id|up
(paren
op_amp
id|shm_ids.sem
)paren
suffix:semicolon
r_return
id|ERR_PTR
c_func
(paren
id|err
)paren
suffix:semicolon
)brace
DECL|function|shm_unlink
r_static
r_int
id|shm_unlink
(paren
r_struct
id|inode
op_star
id|dir
comma
r_struct
id|dentry
op_star
id|dent
)paren
(brace
r_struct
id|inode
op_star
id|inode
op_assign
id|dent-&gt;d_inode
suffix:semicolon
r_struct
id|shmid_kernel
op_star
id|shp
suffix:semicolon
id|down
(paren
op_amp
id|shm_ids.sem
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|shp
op_assign
id|shm_lock
(paren
id|inode-&gt;i_ino
)paren
)paren
)paren
id|BUG
c_func
(paren
)paren
suffix:semicolon
id|shp-&gt;shm_perm.mode
op_or_assign
id|SHM_DEST
suffix:semicolon
id|shp-&gt;shm_perm.key
op_assign
id|IPC_PRIVATE
suffix:semicolon
multiline_comment|/* Do not find it any more */
id|shm_unlock
(paren
id|inode-&gt;i_ino
)paren
suffix:semicolon
id|up
(paren
op_amp
id|shm_ids.sem
)paren
suffix:semicolon
id|inode-&gt;i_nlink
op_sub_assign
l_int|1
suffix:semicolon
id|d_delete
(paren
id|dent
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|macro|SHM_ENTRY
mdefine_line|#define SHM_ENTRY(shp, index) (shp)-&gt;shm_dir[(index)/PTRS_PER_PTE][(index)%PTRS_PER_PTE]
DECL|function|shm_alloc
r_static
id|pte_t
op_star
op_star
id|shm_alloc
c_func
(paren
r_int
r_int
id|pages
)paren
(brace
r_int
r_int
id|dir
op_assign
id|pages
op_div
id|PTRS_PER_PTE
suffix:semicolon
r_int
r_int
id|last
op_assign
id|pages
op_mod
id|PTRS_PER_PTE
suffix:semicolon
id|pte_t
op_star
op_star
id|ret
comma
op_star
op_star
id|ptr
comma
op_star
id|pte
suffix:semicolon
r_if
c_cond
(paren
id|pages
op_eq
l_int|0
)paren
r_return
l_int|NULL
suffix:semicolon
id|ret
op_assign
id|kmalloc
(paren
(paren
id|dir
op_plus
l_int|1
)paren
op_star
r_sizeof
(paren
id|pte_t
op_star
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ret
)paren
r_goto
id|nomem
suffix:semicolon
r_for
c_loop
(paren
id|ptr
op_assign
id|ret
suffix:semicolon
id|ptr
OL
id|ret
op_plus
id|dir
suffix:semicolon
id|ptr
op_increment
)paren
(brace
op_star
id|ptr
op_assign
(paren
id|pte_t
op_star
)paren
id|__get_free_page
(paren
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
op_star
id|ptr
)paren
r_goto
id|free
suffix:semicolon
r_for
c_loop
(paren
id|pte
op_assign
op_star
id|ptr
suffix:semicolon
id|pte
OL
op_star
id|ptr
op_plus
id|PTRS_PER_PTE
suffix:semicolon
id|pte
op_increment
)paren
id|pte_clear
(paren
id|pte
)paren
suffix:semicolon
)brace
multiline_comment|/* The last one is probably not of PAGE_SIZE: we use kmalloc */
r_if
c_cond
(paren
id|last
)paren
(brace
op_star
id|ptr
op_assign
id|kmalloc
(paren
id|last
op_star
r_sizeof
(paren
id|pte_t
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
op_star
id|ptr
)paren
r_goto
id|free
suffix:semicolon
r_for
c_loop
(paren
id|pte
op_assign
op_star
id|ptr
suffix:semicolon
id|pte
OL
op_star
id|ptr
op_plus
id|last
suffix:semicolon
id|pte
op_increment
)paren
id|pte_clear
(paren
id|pte
)paren
suffix:semicolon
)brace
r_return
id|ret
suffix:semicolon
id|free
suffix:colon
multiline_comment|/* The last failed: we decrement first */
r_while
c_loop
(paren
op_decrement
id|ptr
op_ge
id|ret
)paren
id|free_page
(paren
(paren
r_int
r_int
)paren
op_star
id|ptr
)paren
suffix:semicolon
id|kfree
(paren
id|ret
)paren
suffix:semicolon
id|nomem
suffix:colon
r_return
id|ERR_PTR
c_func
(paren
op_minus
id|ENOMEM
)paren
suffix:semicolon
)brace
DECL|function|shm_free
r_static
r_void
id|shm_free
c_func
(paren
id|pte_t
op_star
op_star
id|dir
comma
r_int
r_int
id|pages
)paren
(brace
id|pte_t
op_star
op_star
id|ptr
op_assign
id|dir
op_plus
id|pages
op_div
id|PTRS_PER_PTE
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dir
)paren
r_return
suffix:semicolon
multiline_comment|/* first the last page */
r_if
c_cond
(paren
id|pages
op_mod
id|PTRS_PER_PTE
)paren
id|kfree
(paren
op_star
id|ptr
)paren
suffix:semicolon
multiline_comment|/* now the whole pages */
r_while
c_loop
(paren
op_decrement
id|ptr
op_ge
id|dir
)paren
r_if
c_cond
(paren
op_star
id|ptr
)paren
id|free_page
(paren
(paren
r_int
r_int
)paren
op_star
id|ptr
)paren
suffix:semicolon
multiline_comment|/* Now the indirect block */
id|kfree
(paren
id|dir
)paren
suffix:semicolon
)brace
DECL|function|shm_setattr
r_static
r_int
id|shm_setattr
(paren
r_struct
id|dentry
op_star
id|dentry
comma
r_struct
id|iattr
op_star
id|attr
)paren
(brace
r_int
id|error
suffix:semicolon
r_struct
id|inode
op_star
id|inode
op_assign
id|dentry-&gt;d_inode
suffix:semicolon
r_struct
id|shmid_kernel
op_star
id|shp
suffix:semicolon
r_int
r_int
id|new_pages
comma
id|old_pages
suffix:semicolon
id|pte_t
op_star
op_star
id|new_dir
comma
op_star
op_star
id|old_dir
suffix:semicolon
r_if
c_cond
(paren
(paren
id|error
op_assign
id|inode_change_ok
c_func
(paren
id|inode
comma
id|attr
)paren
)paren
)paren
r_return
id|error
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|attr-&gt;ia_valid
op_amp
id|ATTR_SIZE
)paren
)paren
r_goto
id|set_attr
suffix:semicolon
r_if
c_cond
(paren
id|attr-&gt;ia_size
OG
id|shm_ctlmax
)paren
r_return
op_minus
id|EFBIG
suffix:semicolon
multiline_comment|/* We set old_pages and old_dir for easier cleanup */
id|old_pages
op_assign
id|new_pages
op_assign
(paren
id|attr-&gt;ia_size
op_plus
id|PAGE_SIZE
op_minus
l_int|1
)paren
op_rshift
id|PAGE_SHIFT
suffix:semicolon
r_if
c_cond
(paren
id|shm_tot
op_plus
id|new_pages
op_ge
id|shm_ctlall
)paren
r_return
op_minus
id|ENOSPC
suffix:semicolon
r_if
c_cond
(paren
id|IS_ERR
c_func
(paren
id|old_dir
op_assign
id|new_dir
op_assign
id|shm_alloc
c_func
(paren
id|new_pages
)paren
)paren
)paren
r_return
id|PTR_ERR
c_func
(paren
id|new_dir
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|shp
op_assign
id|shm_lock
c_func
(paren
id|inode-&gt;i_ino
)paren
)paren
)paren
id|BUG
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|shp-&gt;shm_segsz
op_eq
id|attr-&gt;ia_size
)paren
r_goto
id|out
suffix:semicolon
id|old_dir
op_assign
id|shp-&gt;shm_dir
suffix:semicolon
id|old_pages
op_assign
id|shp-&gt;shm_npages
suffix:semicolon
r_if
c_cond
(paren
id|old_dir
)paren
(brace
id|pte_t
op_star
id|swap
suffix:semicolon
r_int
id|i
comma
id|j
suffix:semicolon
id|i
op_assign
id|old_pages
OL
id|new_pages
ques
c_cond
id|old_pages
suffix:colon
id|new_pages
suffix:semicolon
id|j
op_assign
id|i
op_mod
id|PTRS_PER_PTE
suffix:semicolon
id|i
op_div_assign
id|PTRS_PER_PTE
suffix:semicolon
r_if
c_cond
(paren
id|j
)paren
id|memcpy
(paren
id|new_dir
(braket
id|i
)braket
comma
id|old_dir
(braket
id|i
)braket
comma
id|j
op_star
r_sizeof
(paren
id|pte_t
)paren
)paren
suffix:semicolon
r_while
c_loop
(paren
id|i
op_decrement
)paren
(brace
id|swap
op_assign
id|new_dir
(braket
id|i
)braket
suffix:semicolon
id|new_dir
(braket
id|i
)braket
op_assign
id|old_dir
(braket
id|i
)braket
suffix:semicolon
id|old_dir
(braket
id|i
)braket
op_assign
id|swap
suffix:semicolon
)brace
)brace
id|shp-&gt;shm_dir
op_assign
id|new_dir
suffix:semicolon
id|shp-&gt;shm_npages
op_assign
id|new_pages
suffix:semicolon
id|shp-&gt;shm_segsz
op_assign
id|attr-&gt;ia_size
suffix:semicolon
id|out
suffix:colon
id|shm_unlock
c_func
(paren
id|inode-&gt;i_ino
)paren
suffix:semicolon
id|shm_lockall
c_func
(paren
)paren
suffix:semicolon
id|shm_tot
op_add_assign
id|new_pages
op_minus
id|old_pages
suffix:semicolon
id|shm_unlockall
c_func
(paren
)paren
suffix:semicolon
id|shm_free
(paren
id|old_dir
comma
id|old_pages
)paren
suffix:semicolon
id|set_attr
suffix:colon
id|inode_setattr
c_func
(paren
id|inode
comma
id|attr
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|newseg_alloc
r_static
r_inline
r_struct
id|shmid_kernel
op_star
id|newseg_alloc
c_func
(paren
r_int
id|numpages
comma
r_int
id|namelen
)paren
(brace
r_struct
id|shmid_kernel
op_star
id|shp
suffix:semicolon
id|shp
op_assign
(paren
r_struct
id|shmid_kernel
op_star
)paren
id|kmalloc
(paren
r_sizeof
(paren
op_star
id|shp
)paren
op_plus
id|namelen
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|shp
)paren
r_return
l_int|0
suffix:semicolon
id|shp-&gt;shm_dir
op_assign
id|shm_alloc
(paren
id|numpages
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|shp-&gt;shm_dir
)paren
(brace
id|kfree
c_func
(paren
id|shp
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|shp-&gt;shm_npages
op_assign
id|numpages
suffix:semicolon
id|shp-&gt;shm_nattch
op_assign
l_int|0
suffix:semicolon
id|shp-&gt;shm_namelen
op_assign
id|namelen
suffix:semicolon
r_return
id|shp
suffix:semicolon
)brace
DECL|function|newseg
r_static
r_int
id|newseg
(paren
id|key_t
id|key
comma
r_const
r_char
op_star
id|name
comma
r_int
id|namelen
comma
r_int
id|shmflg
comma
r_int
id|size
)paren
(brace
r_struct
id|shmid_kernel
op_star
id|shp
suffix:semicolon
r_int
id|numpages
op_assign
(paren
id|size
op_plus
id|PAGE_SIZE
op_minus
l_int|1
)paren
op_rshift
id|PAGE_SHIFT
suffix:semicolon
r_int
id|id
suffix:semicolon
r_if
c_cond
(paren
id|namelen
OG
id|SHM_NAME_LEN
)paren
r_return
op_minus
id|ENAMETOOLONG
suffix:semicolon
r_if
c_cond
(paren
id|size
OG
id|shm_ctlmax
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|shm_tot
op_plus
id|numpages
op_ge
id|shm_ctlall
)paren
r_return
op_minus
id|ENOSPC
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|shp
op_assign
id|newseg_alloc
c_func
(paren
id|numpages
comma
id|namelen
ques
c_cond
id|namelen
suffix:colon
id|SHM_FMT_LEN
op_plus
l_int|1
)paren
)paren
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|id
op_assign
id|ipc_addid
c_func
(paren
op_amp
id|shm_ids
comma
op_amp
id|shp-&gt;shm_perm
comma
id|shm_ctlmni
op_plus
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|id
op_eq
op_minus
l_int|1
)paren
(brace
id|shm_free
c_func
(paren
id|shp-&gt;shm_dir
comma
id|numpages
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|shp
)paren
suffix:semicolon
r_return
op_minus
id|ENOSPC
suffix:semicolon
)brace
id|shp-&gt;shm_perm.key
op_assign
id|key
suffix:semicolon
id|shp-&gt;shm_perm.mode
op_assign
(paren
id|shmflg
op_amp
id|S_IRWXUGO
)paren
suffix:semicolon
id|shp-&gt;shm_segsz
op_assign
id|size
suffix:semicolon
id|shp-&gt;shm_cprid
op_assign
id|current-&gt;pid
suffix:semicolon
id|shp-&gt;shm_lprid
op_assign
l_int|0
suffix:semicolon
id|shp-&gt;shm_atim
op_assign
id|shp-&gt;shm_dtim
op_assign
l_int|0
suffix:semicolon
id|shp-&gt;shm_ctim
op_assign
id|CURRENT_TIME
suffix:semicolon
id|shp-&gt;id
op_assign
id|shm_buildid
c_func
(paren
id|id
comma
id|shp-&gt;shm_perm.seq
)paren
suffix:semicolon
r_if
c_cond
(paren
id|namelen
op_ne
l_int|0
)paren
(brace
id|shp-&gt;shm_namelen
op_assign
id|namelen
suffix:semicolon
id|memcpy
(paren
id|shp-&gt;shm_name
comma
id|name
comma
id|namelen
)paren
suffix:semicolon
)brace
r_else
(brace
id|shp-&gt;shm_namelen
op_assign
id|sprintf
(paren
id|shp-&gt;shm_name
comma
id|SHM_FMT
comma
id|shp-&gt;id
)paren
suffix:semicolon
)brace
id|shm_tot
op_add_assign
id|numpages
suffix:semicolon
id|used_segs
op_increment
suffix:semicolon
id|shm_unlock
c_func
(paren
id|id
)paren
suffix:semicolon
r_return
id|shp-&gt;id
suffix:semicolon
)brace
DECL|function|sys_shmget
id|asmlinkage
r_int
id|sys_shmget
(paren
id|key_t
id|key
comma
r_int
id|size
comma
r_int
id|shmflg
)paren
(brace
r_struct
id|shmid_kernel
op_star
id|shp
suffix:semicolon
r_int
id|err
comma
id|id
op_assign
l_int|0
suffix:semicolon
r_static
r_int
id|count
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|shm_sb
)paren
(brace
r_if
c_cond
(paren
id|count
op_increment
OL
l_int|5
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;shmget: shm filesystem not mounted&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|size
OL
id|SHMMIN
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|down
c_func
(paren
op_amp
id|shm_ids.sem
)paren
suffix:semicolon
r_if
c_cond
(paren
id|key
op_eq
id|IPC_PRIVATE
)paren
(brace
id|err
op_assign
id|newseg
c_func
(paren
id|key
comma
l_int|NULL
comma
l_int|0
comma
id|shmflg
comma
id|size
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
(paren
id|id
op_assign
id|ipc_findkey
c_func
(paren
op_amp
id|shm_ids
comma
id|key
)paren
)paren
op_eq
op_minus
l_int|1
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|shmflg
op_amp
id|IPC_CREAT
)paren
)paren
id|err
op_assign
op_minus
id|ENOENT
suffix:semicolon
r_else
id|err
op_assign
id|newseg
c_func
(paren
id|key
comma
l_int|NULL
comma
l_int|0
comma
id|shmflg
comma
id|size
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
(paren
id|shmflg
op_amp
id|IPC_CREAT
)paren
op_logical_and
(paren
id|shmflg
op_amp
id|IPC_EXCL
)paren
)paren
(brace
id|err
op_assign
op_minus
id|EEXIST
suffix:semicolon
)brace
r_else
(brace
id|shp
op_assign
id|shm_lock
c_func
(paren
id|id
)paren
suffix:semicolon
r_if
c_cond
(paren
id|shp
op_eq
l_int|NULL
)paren
(brace
id|BUG
c_func
(paren
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|shp-&gt;shm_segsz
OL
id|size
)paren
id|err
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_else
r_if
c_cond
(paren
id|ipcperms
c_func
(paren
op_amp
id|shp-&gt;shm_perm
comma
id|shmflg
)paren
)paren
id|err
op_assign
op_minus
id|EACCES
suffix:semicolon
r_else
id|err
op_assign
id|shm_buildid
c_func
(paren
id|id
comma
id|shp-&gt;shm_perm.seq
)paren
suffix:semicolon
id|shm_unlock
c_func
(paren
id|id
)paren
suffix:semicolon
)brace
id|up
c_func
(paren
op_amp
id|shm_ids.sem
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
DECL|function|killseg_core
r_static
r_void
id|killseg_core
c_func
(paren
r_struct
id|shmid_kernel
op_star
id|shp
comma
r_int
id|doacc
)paren
(brace
r_int
id|i
comma
id|numpages
comma
id|rss
comma
id|swp
suffix:semicolon
id|numpages
op_assign
id|shp-&gt;shm_npages
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
comma
id|rss
op_assign
l_int|0
comma
id|swp
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|numpages
suffix:semicolon
id|i
op_increment
)paren
(brace
id|pte_t
id|pte
suffix:semicolon
id|pte
op_assign
id|SHM_ENTRY
(paren
id|shp
comma
id|i
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pte_none
c_func
(paren
id|pte
)paren
)paren
r_continue
suffix:semicolon
r_if
c_cond
(paren
id|pte_present
c_func
(paren
id|pte
)paren
)paren
(brace
id|__free_page
(paren
id|pte_page
c_func
(paren
id|pte
)paren
)paren
suffix:semicolon
id|rss
op_increment
suffix:semicolon
)brace
r_else
(brace
id|swap_free
c_func
(paren
id|pte_to_swp_entry
c_func
(paren
id|pte
)paren
)paren
suffix:semicolon
id|swp
op_increment
suffix:semicolon
)brace
)brace
id|shm_free
(paren
id|shp-&gt;shm_dir
comma
id|numpages
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|shp
)paren
suffix:semicolon
r_if
c_cond
(paren
id|doacc
)paren
(brace
id|shm_lockall
c_func
(paren
)paren
suffix:semicolon
id|shm_rss
op_sub_assign
id|rss
suffix:semicolon
id|shm_swp
op_sub_assign
id|swp
suffix:semicolon
id|shm_tot
op_sub_assign
id|numpages
suffix:semicolon
id|used_segs
op_decrement
suffix:semicolon
id|shm_unlockall
c_func
(paren
)paren
suffix:semicolon
)brace
)brace
DECL|function|shm_delete
r_static
r_void
id|shm_delete
(paren
r_struct
id|inode
op_star
id|ino
)paren
(brace
r_int
id|shmid
op_assign
id|ino-&gt;i_ino
suffix:semicolon
r_struct
id|shmid_kernel
op_star
id|shp
suffix:semicolon
id|down
c_func
(paren
op_amp
id|shm_ids.sem
)paren
suffix:semicolon
id|shp
op_assign
id|shm_lock
c_func
(paren
id|shmid
)paren
suffix:semicolon
r_if
c_cond
(paren
id|shp
op_eq
l_int|NULL
)paren
(brace
id|BUG
c_func
(paren
)paren
suffix:semicolon
)brace
id|shp
op_assign
id|shm_rmid
c_func
(paren
id|shmid
)paren
suffix:semicolon
id|shm_unlock
c_func
(paren
id|shmid
)paren
suffix:semicolon
id|up
c_func
(paren
op_amp
id|shm_ids.sem
)paren
suffix:semicolon
id|killseg_core
c_func
(paren
id|shp
comma
l_int|1
)paren
suffix:semicolon
id|clear_inode
c_func
(paren
id|ino
)paren
suffix:semicolon
)brace
DECL|function|copy_shmid_to_user
r_static
r_inline
r_int
r_int
id|copy_shmid_to_user
c_func
(paren
r_void
op_star
id|buf
comma
r_struct
id|shmid64_ds
op_star
id|in
comma
r_int
id|version
)paren
(brace
r_switch
c_cond
(paren
id|version
)paren
(brace
r_case
id|IPC_64
suffix:colon
r_return
id|copy_to_user
c_func
(paren
id|buf
comma
id|in
comma
r_sizeof
(paren
op_star
id|in
)paren
)paren
suffix:semicolon
r_case
id|IPC_OLD
suffix:colon
(brace
r_struct
id|shmid_ds
id|out
suffix:semicolon
id|ipc64_perm_to_ipc_perm
c_func
(paren
op_amp
id|in-&gt;shm_perm
comma
op_amp
id|out.shm_perm
)paren
suffix:semicolon
id|out.shm_segsz
op_assign
id|in-&gt;shm_segsz
suffix:semicolon
id|out.shm_atime
op_assign
id|in-&gt;shm_atime
suffix:semicolon
id|out.shm_dtime
op_assign
id|in-&gt;shm_dtime
suffix:semicolon
id|out.shm_ctime
op_assign
id|in-&gt;shm_ctime
suffix:semicolon
id|out.shm_cpid
op_assign
id|in-&gt;shm_cpid
suffix:semicolon
id|out.shm_lpid
op_assign
id|in-&gt;shm_lpid
suffix:semicolon
id|out.shm_nattch
op_assign
id|in-&gt;shm_nattch
suffix:semicolon
r_return
id|copy_to_user
c_func
(paren
id|buf
comma
op_amp
id|out
comma
r_sizeof
(paren
id|out
)paren
)paren
suffix:semicolon
)brace
r_default
suffix:colon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
)brace
DECL|struct|shm_setbuf
r_struct
id|shm_setbuf
(brace
DECL|member|uid
id|uid_t
id|uid
suffix:semicolon
DECL|member|gid
id|gid_t
id|gid
suffix:semicolon
DECL|member|mode
id|mode_t
id|mode
suffix:semicolon
)brace
suffix:semicolon
DECL|function|copy_shmid_from_user
r_static
r_inline
r_int
r_int
id|copy_shmid_from_user
c_func
(paren
r_struct
id|shm_setbuf
op_star
id|out
comma
r_void
op_star
id|buf
comma
r_int
id|version
)paren
(brace
r_switch
c_cond
(paren
id|version
)paren
(brace
r_case
id|IPC_64
suffix:colon
(brace
r_struct
id|shmid64_ds
id|tbuf
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|tbuf
comma
id|buf
comma
r_sizeof
(paren
id|tbuf
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
id|out-&gt;uid
op_assign
id|tbuf.shm_perm.uid
suffix:semicolon
id|out-&gt;gid
op_assign
id|tbuf.shm_perm.gid
suffix:semicolon
id|out-&gt;mode
op_assign
id|tbuf.shm_perm.mode
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_case
id|IPC_OLD
suffix:colon
(brace
r_struct
id|shmid_ds
id|tbuf_old
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|tbuf_old
comma
id|buf
comma
r_sizeof
(paren
id|tbuf_old
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
id|out-&gt;uid
op_assign
id|tbuf_old.shm_perm.uid
suffix:semicolon
id|out-&gt;gid
op_assign
id|tbuf_old.shm_perm.gid
suffix:semicolon
id|out-&gt;mode
op_assign
id|tbuf_old.shm_perm.mode
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_default
suffix:colon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
)brace
DECL|function|copy_shminfo_to_user
r_static
r_inline
r_int
r_int
id|copy_shminfo_to_user
c_func
(paren
r_void
op_star
id|buf
comma
r_struct
id|shminfo64
op_star
id|in
comma
r_int
id|version
)paren
(brace
r_switch
c_cond
(paren
id|version
)paren
(brace
r_case
id|IPC_64
suffix:colon
r_return
id|copy_to_user
c_func
(paren
id|buf
comma
id|in
comma
r_sizeof
(paren
op_star
id|in
)paren
)paren
suffix:semicolon
r_case
id|IPC_OLD
suffix:colon
(brace
r_struct
id|shminfo
id|out
suffix:semicolon
r_if
c_cond
(paren
id|in-&gt;shmmax
OG
id|INT_MAX
)paren
(brace
id|out.shmmax
op_assign
id|INT_MAX
suffix:semicolon
)brace
r_else
id|out.shmmax
op_assign
(paren
r_int
)paren
id|in-&gt;shmmax
suffix:semicolon
id|out.shmmin
op_assign
id|in-&gt;shmmin
suffix:semicolon
id|out.shmmni
op_assign
id|in-&gt;shmmni
suffix:semicolon
id|out.shmseg
op_assign
id|in-&gt;shmseg
suffix:semicolon
id|out.shmall
op_assign
id|in-&gt;shmall
suffix:semicolon
r_return
id|copy_to_user
c_func
(paren
id|buf
comma
op_amp
id|out
comma
r_sizeof
(paren
id|out
)paren
)paren
suffix:semicolon
)brace
r_default
suffix:colon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
)brace
DECL|function|shm_getname
r_char
op_star
id|shm_getname
c_func
(paren
r_int
id|id
)paren
(brace
r_char
op_star
id|result
suffix:semicolon
id|result
op_assign
id|__getname
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|IS_ERR
c_func
(paren
id|result
)paren
)paren
r_return
id|result
suffix:semicolon
id|sprintf
(paren
id|result
comma
l_string|&quot;%s/&quot;
id|SHM_FMT
comma
id|shm_path
comma
id|id
)paren
suffix:semicolon
r_return
id|result
suffix:semicolon
)brace
DECL|function|sys_shmctl
id|asmlinkage
r_int
id|sys_shmctl
(paren
r_int
id|shmid
comma
r_int
id|cmd
comma
r_struct
id|shmid_ds
op_star
id|buf
)paren
(brace
r_struct
id|shm_setbuf
id|setbuf
suffix:semicolon
r_struct
id|shmid_kernel
op_star
id|shp
suffix:semicolon
r_int
id|err
comma
id|version
suffix:semicolon
r_static
r_int
id|count
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|shm_sb
)paren
(brace
r_if
c_cond
(paren
id|count
op_increment
OL
l_int|5
)paren
(brace
id|printk
(paren
id|KERN_WARNING
l_string|&quot;shmctl: shm filesystem not mounted&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|cmd
OL
l_int|0
op_logical_or
id|shmid
OL
l_int|0
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|version
op_assign
id|ipc_parse_version
c_func
(paren
op_amp
id|cmd
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|cmd
)paren
(brace
multiline_comment|/* replace with proc interface ? */
r_case
id|IPC_INFO
suffix:colon
(brace
r_struct
id|shminfo64
id|shminfo
suffix:semicolon
id|memset
c_func
(paren
op_amp
id|shminfo
comma
l_int|0
comma
r_sizeof
(paren
id|shminfo
)paren
)paren
suffix:semicolon
id|shminfo.shmmni
op_assign
id|shminfo.shmseg
op_assign
id|shm_ctlmni
suffix:semicolon
id|shminfo.shmmax
op_assign
id|shm_ctlmax
suffix:semicolon
id|shminfo.shmall
op_assign
id|shm_ctlall
suffix:semicolon
id|shminfo.shmmin
op_assign
id|SHMMIN
suffix:semicolon
r_if
c_cond
(paren
id|copy_shminfo_to_user
(paren
id|buf
comma
op_amp
id|shminfo
comma
id|version
)paren
)paren
(brace
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
multiline_comment|/* reading a integer is always atomic */
id|err
op_assign
id|shm_ids.max_id
suffix:semicolon
r_if
c_cond
(paren
id|err
OL
l_int|0
)paren
(brace
id|err
op_assign
l_int|0
suffix:semicolon
)brace
r_return
id|err
suffix:semicolon
)brace
r_case
id|SHM_INFO
suffix:colon
(brace
r_struct
id|shm_info
id|shm_info
suffix:semicolon
id|memset
c_func
(paren
op_amp
id|shm_info
comma
l_int|0
comma
r_sizeof
(paren
id|shm_info
)paren
)paren
suffix:semicolon
id|shm_lockall
c_func
(paren
)paren
suffix:semicolon
id|shm_info.used_ids
op_assign
id|shm_ids.in_use
suffix:semicolon
id|shm_info.shm_rss
op_assign
id|shm_rss
suffix:semicolon
id|shm_info.shm_tot
op_assign
id|shm_tot
suffix:semicolon
id|shm_info.shm_swp
op_assign
id|shm_swp
suffix:semicolon
id|shm_info.swap_attempts
op_assign
id|swap_attempts
suffix:semicolon
id|shm_info.swap_successes
op_assign
id|swap_successes
suffix:semicolon
id|err
op_assign
id|shm_ids.max_id
suffix:semicolon
id|shm_unlockall
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|copy_to_user
(paren
id|buf
comma
op_amp
id|shm_info
comma
r_sizeof
(paren
id|shm_info
)paren
)paren
)paren
(brace
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
r_return
id|err
OL
l_int|0
ques
c_cond
l_int|0
suffix:colon
id|err
suffix:semicolon
)brace
r_case
id|SHM_STAT
suffix:colon
r_case
id|IPC_STAT
suffix:colon
(brace
r_struct
id|shmid64_ds
id|tbuf
suffix:semicolon
r_int
id|result
suffix:semicolon
r_if
c_cond
(paren
(paren
id|shmid
op_mod
id|SEQ_MULTIPLIER
)paren
op_eq
id|zero_id
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|memset
c_func
(paren
op_amp
id|tbuf
comma
l_int|0
comma
r_sizeof
(paren
id|tbuf
)paren
)paren
suffix:semicolon
id|shp
op_assign
id|shm_lock
c_func
(paren
id|shmid
)paren
suffix:semicolon
r_if
c_cond
(paren
id|shp
op_eq
l_int|NULL
)paren
(brace
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|cmd
op_eq
id|SHM_STAT
)paren
(brace
id|err
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|shmid
OG
id|shm_ids.max_id
)paren
r_goto
id|out_unlock
suffix:semicolon
id|result
op_assign
id|shm_buildid
c_func
(paren
id|shmid
comma
id|shp-&gt;shm_perm.seq
)paren
suffix:semicolon
)brace
r_else
(brace
id|err
op_assign
op_minus
id|EIDRM
suffix:semicolon
r_if
c_cond
(paren
id|shm_checkid
c_func
(paren
id|shp
comma
id|shmid
)paren
)paren
(brace
r_goto
id|out_unlock
suffix:semicolon
)brace
id|result
op_assign
l_int|0
suffix:semicolon
)brace
id|err
op_assign
op_minus
id|EACCES
suffix:semicolon
r_if
c_cond
(paren
id|ipcperms
(paren
op_amp
id|shp-&gt;shm_perm
comma
id|S_IRUGO
)paren
)paren
r_goto
id|out_unlock
suffix:semicolon
id|kernel_to_ipc64_perm
c_func
(paren
op_amp
id|shp-&gt;shm_perm
comma
op_amp
id|tbuf.shm_perm
)paren
suffix:semicolon
id|tbuf.shm_segsz
op_assign
id|shp-&gt;shm_segsz
suffix:semicolon
id|tbuf.shm_atime
op_assign
id|shp-&gt;shm_atim
suffix:semicolon
id|tbuf.shm_dtime
op_assign
id|shp-&gt;shm_dtim
suffix:semicolon
id|tbuf.shm_ctime
op_assign
id|shp-&gt;shm_ctim
suffix:semicolon
id|tbuf.shm_cpid
op_assign
id|shp-&gt;shm_cprid
suffix:semicolon
id|tbuf.shm_lpid
op_assign
id|shp-&gt;shm_lprid
suffix:semicolon
id|tbuf.shm_nattch
op_assign
id|shp-&gt;shm_nattch
suffix:semicolon
id|shm_unlock
c_func
(paren
id|shmid
)paren
suffix:semicolon
r_if
c_cond
(paren
id|copy_shmid_to_user
(paren
id|buf
comma
op_amp
id|tbuf
comma
id|version
)paren
)paren
(brace
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
r_return
id|result
suffix:semicolon
)brace
r_case
id|SHM_LOCK
suffix:colon
r_case
id|SHM_UNLOCK
suffix:colon
(brace
multiline_comment|/* Allow superuser to lock segment in memory */
multiline_comment|/* Should the pages be faulted in here or leave it to user? */
multiline_comment|/* need to determine interaction with current-&gt;swappable */
r_struct
id|kern_ipc_perm
op_star
id|ipcp
suffix:semicolon
r_if
c_cond
(paren
(paren
id|shmid
op_mod
id|SEQ_MULTIPLIER
)paren
op_eq
id|zero_id
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|capable
c_func
(paren
id|CAP_IPC_LOCK
)paren
)paren
r_return
op_minus
id|EPERM
suffix:semicolon
id|shp
op_assign
id|shm_lock
c_func
(paren
id|shmid
)paren
suffix:semicolon
r_if
c_cond
(paren
id|shp
op_eq
l_int|NULL
)paren
(brace
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|err
op_assign
op_minus
id|EIDRM
suffix:semicolon
r_if
c_cond
(paren
id|shm_checkid
c_func
(paren
id|shp
comma
id|shmid
)paren
)paren
(brace
r_goto
id|out_unlock
suffix:semicolon
)brace
id|ipcp
op_assign
op_amp
id|shp-&gt;shm_perm
suffix:semicolon
r_if
c_cond
(paren
id|cmd
op_eq
id|SHM_LOCK
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|ipcp-&gt;mode
op_amp
id|SHM_LOCKED
)paren
)paren
(brace
id|ipcp-&gt;mode
op_or_assign
id|SHM_LOCKED
suffix:semicolon
id|err
op_assign
l_int|0
suffix:semicolon
)brace
)brace
r_else
(brace
r_if
c_cond
(paren
id|ipcp-&gt;mode
op_amp
id|SHM_LOCKED
)paren
(brace
id|ipcp-&gt;mode
op_and_assign
op_complement
id|SHM_LOCKED
suffix:semicolon
id|err
op_assign
l_int|0
suffix:semicolon
)brace
)brace
id|shm_unlock
c_func
(paren
id|shmid
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
r_case
id|IPC_RMID
suffix:colon
(brace
r_char
op_star
id|name
suffix:semicolon
r_if
c_cond
(paren
(paren
id|shmid
op_mod
id|SEQ_MULTIPLIER
)paren
op_eq
id|zero_id
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|name
op_assign
id|shm_getname
c_func
(paren
id|shmid
)paren
suffix:semicolon
r_if
c_cond
(paren
id|IS_ERR
c_func
(paren
id|name
)paren
)paren
r_return
id|PTR_ERR
c_func
(paren
id|name
)paren
suffix:semicolon
id|lock_kernel
c_func
(paren
)paren
suffix:semicolon
id|err
op_assign
id|do_unlink
(paren
id|name
)paren
suffix:semicolon
id|unlock_kernel
c_func
(paren
)paren
suffix:semicolon
id|putname
(paren
id|name
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
op_eq
op_minus
id|ENOENT
)paren
id|err
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
r_case
id|IPC_SET
suffix:colon
(brace
r_if
c_cond
(paren
(paren
id|shmid
op_mod
id|SEQ_MULTIPLIER
)paren
op_eq
id|zero_id
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|copy_shmid_from_user
(paren
op_amp
id|setbuf
comma
id|buf
comma
id|version
)paren
)paren
(brace
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
id|down
c_func
(paren
op_amp
id|shm_ids.sem
)paren
suffix:semicolon
id|shp
op_assign
id|shm_lock
c_func
(paren
id|shmid
)paren
suffix:semicolon
id|err
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|shp
op_eq
l_int|NULL
)paren
(brace
r_goto
id|out_up
suffix:semicolon
)brace
id|err
op_assign
op_minus
id|EIDRM
suffix:semicolon
r_if
c_cond
(paren
id|shm_checkid
c_func
(paren
id|shp
comma
id|shmid
)paren
)paren
(brace
r_goto
id|out_unlock_up
suffix:semicolon
)brace
id|err
op_assign
op_minus
id|EPERM
suffix:semicolon
r_if
c_cond
(paren
id|current-&gt;euid
op_ne
id|shp-&gt;shm_perm.uid
op_logical_and
id|current-&gt;euid
op_ne
id|shp-&gt;shm_perm.cuid
op_logical_and
op_logical_neg
id|capable
c_func
(paren
id|CAP_SYS_ADMIN
)paren
)paren
(brace
r_goto
id|out_unlock_up
suffix:semicolon
)brace
id|shp-&gt;shm_perm.uid
op_assign
id|setbuf.uid
suffix:semicolon
id|shp-&gt;shm_perm.gid
op_assign
id|setbuf.gid
suffix:semicolon
id|shp-&gt;shm_perm.mode
op_assign
(paren
id|shp-&gt;shm_perm.mode
op_amp
op_complement
id|S_IRWXUGO
)paren
op_or
(paren
id|setbuf.mode
op_amp
id|S_IRWXUGO
)paren
suffix:semicolon
id|shp-&gt;shm_ctim
op_assign
id|CURRENT_TIME
suffix:semicolon
r_break
suffix:semicolon
)brace
r_default
suffix:colon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|err
op_assign
l_int|0
suffix:semicolon
id|out_unlock_up
suffix:colon
id|shm_unlock
c_func
(paren
id|shmid
)paren
suffix:semicolon
id|out_up
suffix:colon
id|up
c_func
(paren
op_amp
id|shm_ids.sem
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
id|out_unlock
suffix:colon
id|shm_unlock
c_func
(paren
id|shmid
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
DECL|function|shm_inc
r_static
r_inline
r_void
id|shm_inc
(paren
r_int
id|id
)paren
(brace
r_struct
id|shmid_kernel
op_star
id|shp
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|shp
op_assign
id|shm_lock
c_func
(paren
id|id
)paren
)paren
)paren
(brace
id|BUG
c_func
(paren
)paren
suffix:semicolon
)brace
id|shp-&gt;shm_atim
op_assign
id|CURRENT_TIME
suffix:semicolon
id|shp-&gt;shm_lprid
op_assign
id|current-&gt;pid
suffix:semicolon
id|shp-&gt;shm_nattch
op_increment
suffix:semicolon
id|shm_unlock
c_func
(paren
id|id
)paren
suffix:semicolon
)brace
DECL|function|shm_mmap
r_static
r_int
id|shm_mmap
c_func
(paren
r_struct
id|file
op_star
id|file
comma
r_struct
id|vm_area_struct
op_star
id|vma
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|vma-&gt;vm_flags
op_amp
id|VM_SHARED
)paren
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
multiline_comment|/* we cannot do private mappings */
id|UPDATE_ATIME
c_func
(paren
id|file-&gt;f_dentry-&gt;d_inode
)paren
suffix:semicolon
id|vma-&gt;vm_ops
op_assign
op_amp
id|shm_vm_ops
suffix:semicolon
id|shm_inc
c_func
(paren
id|file-&gt;f_dentry-&gt;d_inode-&gt;i_ino
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * Fix shmaddr, allocate descriptor, map shm, add attach descriptor to lists.&n; */
DECL|function|sys_shmat
id|asmlinkage
r_int
id|sys_shmat
(paren
r_int
id|shmid
comma
r_char
op_star
id|shmaddr
comma
r_int
id|shmflg
comma
id|ulong
op_star
id|raddr
)paren
(brace
r_int
r_int
id|addr
suffix:semicolon
r_struct
id|file
op_star
id|file
suffix:semicolon
r_int
id|err
suffix:semicolon
r_int
id|flags
suffix:semicolon
r_char
op_star
id|name
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|shm_sb
op_logical_or
(paren
id|shmid
op_mod
id|SEQ_MULTIPLIER
)paren
op_eq
id|zero_id
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
(paren
id|addr
op_assign
(paren
id|ulong
)paren
id|shmaddr
)paren
)paren
(brace
r_if
c_cond
(paren
id|addr
op_amp
(paren
id|SHMLBA
op_minus
l_int|1
)paren
)paren
(brace
r_if
c_cond
(paren
id|shmflg
op_amp
id|SHM_RND
)paren
id|addr
op_and_assign
op_complement
(paren
id|SHMLBA
op_minus
l_int|1
)paren
suffix:semicolon
multiline_comment|/* round down */
r_else
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|flags
op_assign
id|MAP_SHARED
op_or
id|MAP_FIXED
suffix:semicolon
)brace
r_else
id|flags
op_assign
id|MAP_SHARED
suffix:semicolon
id|name
op_assign
id|shm_getname
c_func
(paren
id|shmid
)paren
suffix:semicolon
r_if
c_cond
(paren
id|IS_ERR
(paren
id|name
)paren
)paren
r_return
id|PTR_ERR
(paren
id|name
)paren
suffix:semicolon
id|lock_kernel
c_func
(paren
)paren
suffix:semicolon
id|file
op_assign
id|filp_open
(paren
id|name
comma
id|O_RDWR
comma
l_int|0
)paren
suffix:semicolon
id|putname
(paren
id|name
)paren
suffix:semicolon
r_if
c_cond
(paren
id|IS_ERR
(paren
id|file
)paren
)paren
(brace
id|unlock_kernel
c_func
(paren
)paren
suffix:semicolon
r_goto
id|bad_file
suffix:semicolon
)brace
op_star
id|raddr
op_assign
id|do_mmap
(paren
id|file
comma
id|addr
comma
id|file-&gt;f_dentry-&gt;d_inode-&gt;i_size
comma
(paren
id|shmflg
op_amp
id|SHM_RDONLY
ques
c_cond
id|PROT_READ
suffix:colon
id|PROT_READ
op_or
id|PROT_WRITE
)paren
comma
id|flags
comma
l_int|0
)paren
suffix:semicolon
id|unlock_kernel
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|IS_ERR
c_func
(paren
op_star
id|raddr
)paren
)paren
id|err
op_assign
id|PTR_ERR
c_func
(paren
op_star
id|raddr
)paren
suffix:semicolon
r_else
id|err
op_assign
l_int|0
suffix:semicolon
id|fput
(paren
id|file
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
id|bad_file
suffix:colon
r_if
c_cond
(paren
(paren
id|err
op_assign
id|PTR_ERR
c_func
(paren
id|file
)paren
)paren
op_eq
op_minus
id|ENOENT
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
multiline_comment|/* This is called by fork, once for every shm attach. */
DECL|function|shm_open
r_static
r_void
id|shm_open
(paren
r_struct
id|vm_area_struct
op_star
id|shmd
)paren
(brace
id|shm_inc
(paren
id|shmd-&gt;vm_file-&gt;f_dentry-&gt;d_inode-&gt;i_ino
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * remove the attach descriptor shmd.&n; * free memory for segment if it is marked destroyed.&n; * The descriptor has already been removed from the current-&gt;mm-&gt;mmap list&n; * and will later be kfree()d.&n; */
DECL|function|shm_close
r_static
r_void
id|shm_close
(paren
r_struct
id|vm_area_struct
op_star
id|shmd
)paren
(brace
r_int
id|id
op_assign
id|shmd-&gt;vm_file-&gt;f_dentry-&gt;d_inode-&gt;i_ino
suffix:semicolon
r_struct
id|shmid_kernel
op_star
id|shp
suffix:semicolon
multiline_comment|/* remove from the list of attaches of the shm segment */
r_if
c_cond
(paren
op_logical_neg
(paren
id|shp
op_assign
id|shm_lock
c_func
(paren
id|id
)paren
)paren
)paren
(brace
id|BUG
c_func
(paren
)paren
suffix:semicolon
)brace
id|shp-&gt;shm_lprid
op_assign
id|current-&gt;pid
suffix:semicolon
id|shp-&gt;shm_dtim
op_assign
id|CURRENT_TIME
suffix:semicolon
id|shp-&gt;shm_nattch
op_decrement
suffix:semicolon
id|shm_unlock
c_func
(paren
id|id
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * detach and kill segment if marked destroyed.&n; * The work is done in shm_close.&n; */
DECL|function|sys_shmdt
id|asmlinkage
r_int
id|sys_shmdt
(paren
r_char
op_star
id|shmaddr
)paren
(brace
r_struct
id|vm_area_struct
op_star
id|shmd
comma
op_star
id|shmdnext
suffix:semicolon
id|down
c_func
(paren
op_amp
id|current-&gt;mm-&gt;mmap_sem
)paren
suffix:semicolon
r_for
c_loop
(paren
id|shmd
op_assign
id|current-&gt;mm-&gt;mmap
suffix:semicolon
id|shmd
suffix:semicolon
id|shmd
op_assign
id|shmdnext
)paren
(brace
id|shmdnext
op_assign
id|shmd-&gt;vm_next
suffix:semicolon
r_if
c_cond
(paren
id|shmd-&gt;vm_ops
op_eq
op_amp
id|shm_vm_ops
op_logical_and
id|shmd-&gt;vm_start
op_minus
(paren
id|shmd-&gt;vm_pgoff
op_lshift
id|PAGE_SHIFT
)paren
op_eq
(paren
id|ulong
)paren
id|shmaddr
)paren
id|do_munmap
c_func
(paren
id|shmd-&gt;vm_start
comma
id|shmd-&gt;vm_end
op_minus
id|shmd-&gt;vm_start
)paren
suffix:semicolon
)brace
id|up
c_func
(paren
op_amp
id|current-&gt;mm-&gt;mmap_sem
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * Enter the shm page into the SHM data structures.&n; *&n; * The way &quot;nopage&quot; is done, we don&squot;t actually have to&n; * do anything here: nopage will have filled in the shm&n; * data structures already, and shm_swap_out() will just&n; * work off them..&n; */
DECL|function|shm_swapout
r_static
r_int
id|shm_swapout
c_func
(paren
r_struct
id|page
op_star
id|page
comma
r_struct
id|file
op_star
id|file
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * page not present ... go through shm_dir&n; */
DECL|function|shm_nopage_core
r_static
r_struct
id|page
op_star
id|shm_nopage_core
c_func
(paren
r_struct
id|shmid_kernel
op_star
id|shp
comma
r_int
r_int
id|idx
comma
r_int
op_star
id|swp
comma
r_int
op_star
id|rss
)paren
(brace
id|pte_t
id|pte
suffix:semicolon
r_struct
id|page
op_star
id|page
suffix:semicolon
r_if
c_cond
(paren
id|idx
op_ge
id|shp-&gt;shm_npages
)paren
r_goto
id|sigbus
suffix:semicolon
id|pte
op_assign
id|SHM_ENTRY
c_func
(paren
id|shp
comma
id|idx
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pte_present
c_func
(paren
id|pte
)paren
)paren
(brace
multiline_comment|/* page not present so shm_swap can&squot;t race with us&n;&t;&t;   and the semaphore protects us by other tasks that&n;&t;&t;   could potentially fault on our pte under us */
r_if
c_cond
(paren
id|pte_none
c_func
(paren
id|pte
)paren
)paren
(brace
id|shm_unlock
c_func
(paren
id|shp-&gt;id
)paren
suffix:semicolon
id|page
op_assign
id|alloc_page
c_func
(paren
id|GFP_HIGHUSER
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|page
)paren
r_goto
id|oom
suffix:semicolon
id|clear_highpage
c_func
(paren
id|page
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|shp
op_ne
id|shm_lock
c_func
(paren
id|shp-&gt;id
)paren
)paren
op_logical_and
(paren
id|shp-&gt;id
op_ne
id|zero_id
)paren
)paren
id|BUG
c_func
(paren
)paren
suffix:semicolon
)brace
r_else
(brace
id|swp_entry_t
id|entry
op_assign
id|pte_to_swp_entry
c_func
(paren
id|pte
)paren
suffix:semicolon
id|shm_unlock
c_func
(paren
id|shp-&gt;id
)paren
suffix:semicolon
id|page
op_assign
id|lookup_swap_cache
c_func
(paren
id|entry
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|page
)paren
(brace
id|lock_kernel
c_func
(paren
)paren
suffix:semicolon
id|swapin_readahead
c_func
(paren
id|entry
)paren
suffix:semicolon
id|page
op_assign
id|read_swap_cache
c_func
(paren
id|entry
)paren
suffix:semicolon
id|unlock_kernel
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|page
)paren
r_goto
id|oom
suffix:semicolon
)brace
id|delete_from_swap_cache
c_func
(paren
id|page
)paren
suffix:semicolon
id|page
op_assign
id|replace_with_highmem
c_func
(paren
id|page
)paren
suffix:semicolon
id|swap_free
c_func
(paren
id|entry
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|shp
op_ne
id|shm_lock
c_func
(paren
id|shp-&gt;id
)paren
)paren
op_logical_and
(paren
id|shp-&gt;id
op_ne
id|zero_id
)paren
)paren
id|BUG
c_func
(paren
)paren
suffix:semicolon
(paren
op_star
id|swp
)paren
op_decrement
suffix:semicolon
)brace
(paren
op_star
id|rss
)paren
op_increment
suffix:semicolon
id|pte
op_assign
id|pte_mkdirty
c_func
(paren
id|mk_pte
c_func
(paren
id|page
comma
id|PAGE_SHARED
)paren
)paren
suffix:semicolon
id|SHM_ENTRY
c_func
(paren
id|shp
comma
id|idx
)paren
op_assign
id|pte
suffix:semicolon
)brace
r_else
op_decrement
id|current-&gt;maj_flt
suffix:semicolon
multiline_comment|/* was incremented in do_no_page */
multiline_comment|/* pte_val(pte) == SHM_ENTRY (shp, idx) */
id|get_page
c_func
(paren
id|pte_page
c_func
(paren
id|pte
)paren
)paren
suffix:semicolon
id|current-&gt;min_flt
op_increment
suffix:semicolon
r_return
id|pte_page
c_func
(paren
id|pte
)paren
suffix:semicolon
id|oom
suffix:colon
r_return
id|NOPAGE_OOM
suffix:semicolon
id|sigbus
suffix:colon
r_return
id|NOPAGE_SIGBUS
suffix:semicolon
)brace
DECL|function|shm_nopage
r_static
r_struct
id|page
op_star
id|shm_nopage
c_func
(paren
r_struct
id|vm_area_struct
op_star
id|shmd
comma
r_int
r_int
id|address
comma
r_int
id|no_share
)paren
(brace
r_struct
id|page
op_star
id|page
suffix:semicolon
r_struct
id|shmid_kernel
op_star
id|shp
suffix:semicolon
r_int
r_int
id|idx
suffix:semicolon
r_struct
id|inode
op_star
id|inode
op_assign
id|shmd-&gt;vm_file-&gt;f_dentry-&gt;d_inode
suffix:semicolon
id|idx
op_assign
(paren
id|address
op_minus
id|shmd-&gt;vm_start
)paren
op_rshift
id|PAGE_SHIFT
suffix:semicolon
id|idx
op_add_assign
id|shmd-&gt;vm_pgoff
suffix:semicolon
id|down
c_func
(paren
op_amp
id|inode-&gt;i_sem
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|shp
op_assign
id|shm_lock
c_func
(paren
id|inode-&gt;i_ino
)paren
)paren
)paren
(brace
id|BUG
c_func
(paren
)paren
suffix:semicolon
)brace
id|page
op_assign
id|shm_nopage_core
c_func
(paren
id|shp
comma
id|idx
comma
op_amp
id|shm_swp
comma
op_amp
id|shm_rss
)paren
suffix:semicolon
id|shm_unlock
c_func
(paren
id|inode-&gt;i_ino
)paren
suffix:semicolon
id|up
c_func
(paren
op_amp
id|inode-&gt;i_sem
)paren
suffix:semicolon
r_return
id|page
suffix:semicolon
)brace
DECL|macro|OKAY
mdefine_line|#define OKAY&t;0
DECL|macro|RETRY
mdefine_line|#define RETRY&t;1
DECL|macro|FAILED
mdefine_line|#define FAILED&t;2
DECL|function|shm_swap_core
r_static
r_int
id|shm_swap_core
c_func
(paren
r_struct
id|shmid_kernel
op_star
id|shp
comma
r_int
r_int
id|idx
comma
id|swp_entry_t
id|swap_entry
comma
id|zone_t
op_star
id|zone
comma
r_int
op_star
id|counter
comma
r_struct
id|page
op_star
op_star
id|outpage
)paren
(brace
id|pte_t
id|page
suffix:semicolon
r_struct
id|page
op_star
id|page_map
suffix:semicolon
id|page
op_assign
id|SHM_ENTRY
c_func
(paren
id|shp
comma
id|idx
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pte_present
c_func
(paren
id|page
)paren
)paren
r_return
id|RETRY
suffix:semicolon
id|page_map
op_assign
id|pte_page
c_func
(paren
id|page
)paren
suffix:semicolon
r_if
c_cond
(paren
id|zone
op_logical_and
(paren
op_logical_neg
id|memclass
c_func
(paren
id|page_map-&gt;zone
comma
id|zone
)paren
)paren
)paren
r_return
id|RETRY
suffix:semicolon
r_if
c_cond
(paren
id|shp-&gt;id
op_ne
id|zero_id
)paren
id|swap_attempts
op_increment
suffix:semicolon
r_if
c_cond
(paren
op_decrement
id|counter
OL
l_int|0
)paren
multiline_comment|/* failed */
r_return
id|FAILED
suffix:semicolon
r_if
c_cond
(paren
id|page_count
c_func
(paren
id|page_map
)paren
op_ne
l_int|1
)paren
r_return
id|RETRY
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|page_map
op_assign
id|prepare_highmem_swapout
c_func
(paren
id|page_map
)paren
)paren
)paren
r_return
id|FAILED
suffix:semicolon
id|SHM_ENTRY
(paren
id|shp
comma
id|idx
)paren
op_assign
id|swp_entry_to_pte
c_func
(paren
id|swap_entry
)paren
suffix:semicolon
multiline_comment|/* add the locked page to the swap cache before allowing&n;&t;   the swapin path to run lookup_swap_cache(). This avoids&n;&t;   reading a not yet uptodate block from disk.&n;&t;   NOTE: we just accounted the swap space reference for this&n;&t;   swap cache page at __get_swap_page() time. */
id|add_to_swap_cache
c_func
(paren
op_star
id|outpage
op_assign
id|page_map
comma
id|swap_entry
)paren
suffix:semicolon
r_return
id|OKAY
suffix:semicolon
)brace
DECL|function|shm_swap_postop
r_static
r_void
id|shm_swap_postop
c_func
(paren
r_struct
id|page
op_star
id|page
)paren
(brace
id|lock_kernel
c_func
(paren
)paren
suffix:semicolon
id|rw_swap_page
c_func
(paren
id|WRITE
comma
id|page
comma
l_int|0
)paren
suffix:semicolon
id|unlock_kernel
c_func
(paren
)paren
suffix:semicolon
id|__free_page
c_func
(paren
id|page
)paren
suffix:semicolon
)brace
DECL|function|shm_swap_preop
r_static
r_int
id|shm_swap_preop
c_func
(paren
id|swp_entry_t
op_star
id|swap_entry
)paren
(brace
id|lock_kernel
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* subtle: preload the swap count for the swap cache. We can&squot;t&n;&t;   increase the count inside the critical section as we can&squot;t release&n;&t;   the shm_lock there. And we can&squot;t acquire the big lock with the&n;&t;   shm_lock held (otherwise we would deadlock too easily). */
op_star
id|swap_entry
op_assign
id|__get_swap_page
c_func
(paren
l_int|2
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|swap_entry.val
)paren
(brace
id|unlock_kernel
c_func
(paren
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
id|unlock_kernel
c_func
(paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * Goes through counter = (shm_rss &gt;&gt; prio) present shm pages.&n; */
DECL|variable|swap_id
r_static
r_int
r_int
id|swap_id
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* currently being swapped */
DECL|variable|swap_idx
r_static
r_int
r_int
id|swap_idx
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* next to swap */
DECL|function|shm_swap
r_int
id|shm_swap
(paren
r_int
id|prio
comma
r_int
id|gfp_mask
comma
id|zone_t
op_star
id|zone
)paren
(brace
r_struct
id|shmid_kernel
op_star
id|shp
suffix:semicolon
id|swp_entry_t
id|swap_entry
suffix:semicolon
r_int
r_int
id|id
comma
id|idx
suffix:semicolon
r_int
id|loop
op_assign
l_int|0
suffix:semicolon
r_int
id|counter
suffix:semicolon
r_struct
id|page
op_star
id|page_map
suffix:semicolon
id|zshm_swap
c_func
(paren
id|prio
comma
id|gfp_mask
comma
id|zone
)paren
suffix:semicolon
id|counter
op_assign
id|shm_rss
op_rshift
id|prio
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|counter
)paren
r_return
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|shm_swap_preop
c_func
(paren
op_amp
id|swap_entry
)paren
)paren
r_return
l_int|0
suffix:semicolon
id|shm_lockall
c_func
(paren
)paren
suffix:semicolon
id|check_id
suffix:colon
id|shp
op_assign
id|shm_get
c_func
(paren
id|swap_id
)paren
suffix:semicolon
r_if
c_cond
(paren
id|shp
op_eq
l_int|NULL
op_logical_or
id|shp-&gt;shm_perm.mode
op_amp
id|SHM_LOCKED
)paren
(brace
id|next_id
suffix:colon
id|swap_idx
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
op_increment
id|swap_id
OG
id|shm_ids.max_id
)paren
(brace
id|swap_id
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|loop
)paren
(brace
id|failed
suffix:colon
id|shm_unlockall
c_func
(paren
)paren
suffix:semicolon
id|__swap_free
c_func
(paren
id|swap_entry
comma
l_int|2
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|loop
op_assign
l_int|1
suffix:semicolon
)brace
r_goto
id|check_id
suffix:semicolon
)brace
id|id
op_assign
id|swap_id
suffix:semicolon
id|check_table
suffix:colon
id|idx
op_assign
id|swap_idx
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|idx
op_ge
id|shp-&gt;shm_npages
)paren
r_goto
id|next_id
suffix:semicolon
r_switch
c_cond
(paren
id|shm_swap_core
c_func
(paren
id|shp
comma
id|idx
comma
id|swap_entry
comma
id|zone
comma
op_amp
id|counter
comma
op_amp
id|page_map
)paren
)paren
(brace
r_case
id|RETRY
suffix:colon
r_goto
id|check_table
suffix:semicolon
r_case
id|FAILED
suffix:colon
r_goto
id|failed
suffix:semicolon
)brace
id|swap_successes
op_increment
suffix:semicolon
id|shm_swp
op_increment
suffix:semicolon
id|shm_rss
op_decrement
suffix:semicolon
id|shm_unlockall
c_func
(paren
)paren
suffix:semicolon
id|shm_swap_postop
c_func
(paren
id|page_map
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
multiline_comment|/*&n; * Free the swap entry and set the new pte for the shm page.&n; */
DECL|function|shm_unuse_page
r_static
r_void
id|shm_unuse_page
c_func
(paren
r_struct
id|shmid_kernel
op_star
id|shp
comma
r_int
r_int
id|idx
comma
id|swp_entry_t
id|entry
comma
r_struct
id|page
op_star
id|page
)paren
(brace
id|pte_t
id|pte
suffix:semicolon
id|pte
op_assign
id|pte_mkdirty
c_func
(paren
id|mk_pte
c_func
(paren
id|page
comma
id|PAGE_SHARED
)paren
)paren
suffix:semicolon
id|SHM_ENTRY
c_func
(paren
id|shp
comma
id|idx
)paren
op_assign
id|pte
suffix:semicolon
id|get_page
c_func
(paren
id|page
)paren
suffix:semicolon
id|shm_rss
op_increment
suffix:semicolon
id|shm_swp
op_decrement
suffix:semicolon
id|swap_free
c_func
(paren
id|entry
)paren
suffix:semicolon
)brace
DECL|function|shm_unuse_core
r_static
r_int
id|shm_unuse_core
c_func
(paren
r_struct
id|shmid_kernel
op_star
id|shp
comma
id|swp_entry_t
id|entry
comma
r_struct
id|page
op_star
id|page
)paren
(brace
r_int
id|n
suffix:semicolon
r_for
c_loop
(paren
id|n
op_assign
l_int|0
suffix:semicolon
id|n
OL
id|shp-&gt;shm_npages
suffix:semicolon
id|n
op_increment
)paren
(brace
r_if
c_cond
(paren
id|pte_none
c_func
(paren
id|SHM_ENTRY
c_func
(paren
id|shp
comma
id|n
)paren
)paren
)paren
r_continue
suffix:semicolon
r_if
c_cond
(paren
id|pte_present
c_func
(paren
id|SHM_ENTRY
c_func
(paren
id|shp
comma
id|n
)paren
)paren
)paren
r_continue
suffix:semicolon
r_if
c_cond
(paren
id|pte_to_swp_entry
c_func
(paren
id|SHM_ENTRY
c_func
(paren
id|shp
comma
id|n
)paren
)paren
dot
id|val
op_eq
id|entry.val
)paren
(brace
id|shm_unuse_page
c_func
(paren
id|shp
comma
id|n
comma
id|entry
comma
id|page
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * unuse_shm() search for an eventually swapped out shm page.&n; */
DECL|function|shm_unuse
r_void
id|shm_unuse
c_func
(paren
id|swp_entry_t
id|entry
comma
r_struct
id|page
op_star
id|page
)paren
(brace
r_int
id|i
suffix:semicolon
id|shm_lockall
c_func
(paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
op_le
id|shm_ids.max_id
suffix:semicolon
id|i
op_increment
)paren
(brace
r_struct
id|shmid_kernel
op_star
id|shp
op_assign
id|shm_get
c_func
(paren
id|i
)paren
suffix:semicolon
r_if
c_cond
(paren
id|shp
op_eq
l_int|NULL
)paren
(brace
r_continue
suffix:semicolon
)brace
r_if
c_cond
(paren
id|shm_unuse_core
c_func
(paren
id|shp
comma
id|entry
comma
id|page
)paren
)paren
r_goto
id|out
suffix:semicolon
)brace
id|out
suffix:colon
id|shm_unlockall
c_func
(paren
)paren
suffix:semicolon
id|zmap_unuse
c_func
(paren
id|entry
comma
id|page
)paren
suffix:semicolon
)brace
macro_line|#ifdef CONFIG_PROC_FS
DECL|function|sysvipc_shm_read_proc
r_static
r_int
id|sysvipc_shm_read_proc
c_func
(paren
r_char
op_star
id|buffer
comma
r_char
op_star
op_star
id|start
comma
id|off_t
id|offset
comma
r_int
id|length
comma
r_int
op_star
id|eof
comma
r_void
op_star
id|data
)paren
(brace
id|off_t
id|pos
op_assign
l_int|0
suffix:semicolon
id|off_t
id|begin
op_assign
l_int|0
suffix:semicolon
r_int
id|i
comma
id|len
op_assign
l_int|0
suffix:semicolon
id|down
c_func
(paren
op_amp
id|shm_ids.sem
)paren
suffix:semicolon
id|len
op_add_assign
id|sprintf
c_func
(paren
id|buffer
comma
l_string|&quot;       key      shmid perms       size  cpid  lpid nattch   uid   gid  cuid  cgid      atime      dtime      ctime name&bslash;n&quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
op_le
id|shm_ids.max_id
suffix:semicolon
id|i
op_increment
)paren
(brace
r_struct
id|shmid_kernel
op_star
id|shp
suffix:semicolon
r_if
c_cond
(paren
id|i
op_eq
id|zero_id
)paren
r_continue
suffix:semicolon
id|shp
op_assign
id|shm_lock
c_func
(paren
id|i
)paren
suffix:semicolon
r_if
c_cond
(paren
id|shp
op_ne
l_int|NULL
)paren
(brace
DECL|macro|SMALL_STRING
mdefine_line|#define SMALL_STRING &quot;%10d %10d  %4o %10u %5u %5u  %5d %5u %5u %5u %5u %10lu %10lu %10lu %.*s&bslash;n&quot;
DECL|macro|BIG_STRING
mdefine_line|#define BIG_STRING   &quot;%10d %10d  %4o %21u %5u %5u  %5d %5u %5u %5u %5u %10lu %10lu %10lu %.*s&bslash;n&quot;
r_char
op_star
id|format
suffix:semicolon
r_if
c_cond
(paren
r_sizeof
(paren
r_int
)paren
op_le
r_sizeof
(paren
r_int
)paren
)paren
id|format
op_assign
id|SMALL_STRING
suffix:semicolon
r_else
id|format
op_assign
id|BIG_STRING
suffix:semicolon
id|len
op_add_assign
id|sprintf
c_func
(paren
id|buffer
op_plus
id|len
comma
id|format
comma
id|shp-&gt;shm_perm.key
comma
id|shm_buildid
c_func
(paren
id|i
comma
id|shp-&gt;shm_perm.seq
)paren
comma
id|shp-&gt;shm_perm.mode
comma
id|shp-&gt;shm_segsz
comma
id|shp-&gt;shm_cprid
comma
id|shp-&gt;shm_lprid
comma
id|shp-&gt;shm_nattch
comma
id|shp-&gt;shm_perm.uid
comma
id|shp-&gt;shm_perm.gid
comma
id|shp-&gt;shm_perm.cuid
comma
id|shp-&gt;shm_perm.cgid
comma
id|shp-&gt;shm_atim
comma
id|shp-&gt;shm_dtim
comma
id|shp-&gt;shm_ctim
comma
id|shp-&gt;shm_namelen
comma
id|shp-&gt;shm_name
)paren
suffix:semicolon
id|shm_unlock
c_func
(paren
id|i
)paren
suffix:semicolon
id|pos
op_add_assign
id|len
suffix:semicolon
r_if
c_cond
(paren
id|pos
OL
id|offset
)paren
(brace
id|len
op_assign
l_int|0
suffix:semicolon
id|begin
op_assign
id|pos
suffix:semicolon
)brace
r_if
c_cond
(paren
id|pos
OG
id|offset
op_plus
id|length
)paren
(brace
r_goto
id|done
suffix:semicolon
)brace
)brace
)brace
op_star
id|eof
op_assign
l_int|1
suffix:semicolon
id|done
suffix:colon
id|up
c_func
(paren
op_amp
id|shm_ids.sem
)paren
suffix:semicolon
op_star
id|start
op_assign
id|buffer
op_plus
(paren
id|offset
op_minus
id|begin
)paren
suffix:semicolon
id|len
op_sub_assign
(paren
id|offset
op_minus
id|begin
)paren
suffix:semicolon
r_if
c_cond
(paren
id|len
OG
id|length
)paren
(brace
id|len
op_assign
id|length
suffix:semicolon
)brace
r_if
c_cond
(paren
id|len
OL
l_int|0
)paren
(brace
id|len
op_assign
l_int|0
suffix:semicolon
)brace
r_return
id|len
suffix:semicolon
)brace
macro_line|#endif
DECL|macro|VMA_TO_SHP
mdefine_line|#define VMA_TO_SHP(vma)&t;&t;((vma)-&gt;vm_file-&gt;private_data)
DECL|variable|zmap_list_lock
r_static
id|spinlock_t
id|zmap_list_lock
op_assign
id|SPIN_LOCK_UNLOCKED
suffix:semicolon
DECL|variable|zswap_idx
r_static
r_int
r_int
id|zswap_idx
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* next to swap */
DECL|variable|zswap_shp
r_static
r_struct
id|shmid_kernel
op_star
id|zswap_shp
op_assign
op_amp
id|zshmid_kernel
suffix:semicolon
DECL|variable|zshm_rss
r_static
r_int
id|zshm_rss
suffix:semicolon
DECL|variable|shmzero_vm_ops
r_static
r_struct
id|vm_operations_struct
id|shmzero_vm_ops
op_assign
(brace
id|open
suffix:colon
id|shmzero_open
comma
id|close
suffix:colon
id|shmzero_close
comma
id|nopage
suffix:colon
id|shmzero_nopage
comma
id|swapout
suffix:colon
id|shm_swapout
comma
)brace
suffix:semicolon
multiline_comment|/*&n; * In this implementation, the &quot;unuse&quot; and &quot;swapout&quot; interfaces are&n; * interlocked out via the kernel_lock, as well as shm_lock(zero_id).&n; * &quot;unuse&quot; and &quot;nopage/swapin&quot;, as well as &quot;swapout&quot; and &quot;nopage/swapin&quot;&n; * interlock via shm_lock(zero_id). All these interlocks can be based&n; * on a per mapping lock instead of being a global lock.&n; */
multiline_comment|/*&n; * Reference (existance) counting on the file/dentry/inode is done&n; * by generic vm_file code. The zero code does not hold any reference &n; * on the pseudo-file. This is possible because the open/close calls&n; * are bracketed by the file count update calls.&n; */
DECL|function|file_setup
r_static
r_struct
id|file
op_star
id|file_setup
c_func
(paren
r_struct
id|file
op_star
id|fzero
comma
r_struct
id|shmid_kernel
op_star
id|shp
)paren
(brace
r_struct
id|file
op_star
id|filp
suffix:semicolon
r_struct
id|inode
op_star
id|inp
suffix:semicolon
r_if
c_cond
(paren
(paren
id|filp
op_assign
id|get_empty_filp
c_func
(paren
)paren
)paren
op_eq
l_int|0
)paren
r_return
id|filp
suffix:semicolon
r_if
c_cond
(paren
(paren
id|inp
op_assign
id|get_empty_inode
c_func
(paren
)paren
)paren
op_eq
l_int|0
)paren
(brace
id|put_filp
c_func
(paren
id|filp
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|filp-&gt;f_dentry
op_assign
id|d_alloc
c_func
(paren
id|zdent
comma
op_amp
(paren
r_const
r_struct
id|qstr
)paren
(brace
l_string|&quot;dev/zero&quot;
comma
l_int|8
comma
l_int|0
)brace
)paren
)paren
op_eq
l_int|0
)paren
(brace
id|iput
c_func
(paren
id|inp
)paren
suffix:semicolon
id|put_filp
c_func
(paren
id|filp
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|d_instantiate
c_func
(paren
id|filp-&gt;f_dentry
comma
id|inp
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Copy over /dev/zero dev/ino for benefit of procfs. Use&n;&t; * ino to indicate seperate mappings.&n;&t; */
id|filp-&gt;f_dentry-&gt;d_inode-&gt;i_dev
op_assign
id|fzero-&gt;f_dentry-&gt;d_inode-&gt;i_dev
suffix:semicolon
id|filp-&gt;f_dentry-&gt;d_inode-&gt;i_ino
op_assign
(paren
r_int
r_int
)paren
id|shp
suffix:semicolon
id|fput
c_func
(paren
id|fzero
)paren
suffix:semicolon
multiline_comment|/* release /dev/zero file */
r_return
id|filp
suffix:semicolon
)brace
DECL|function|map_zero_setup
r_int
id|map_zero_setup
c_func
(paren
r_struct
id|vm_area_struct
op_star
id|vma
)paren
(brace
r_extern
r_int
id|vm_enough_memory
c_func
(paren
r_int
id|pages
)paren
suffix:semicolon
r_struct
id|shmid_kernel
op_star
id|shp
suffix:semicolon
r_struct
id|file
op_star
id|filp
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|vm_enough_memory
c_func
(paren
(paren
id|vma-&gt;vm_end
op_minus
id|vma-&gt;vm_start
)paren
op_rshift
id|PAGE_SHIFT
)paren
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|shp
op_assign
id|newseg_alloc
c_func
(paren
(paren
id|vma-&gt;vm_end
op_minus
id|vma-&gt;vm_start
)paren
op_div
id|PAGE_SIZE
comma
l_int|0
)paren
)paren
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
r_if
c_cond
(paren
(paren
id|filp
op_assign
id|file_setup
c_func
(paren
id|vma-&gt;vm_file
comma
id|shp
)paren
)paren
op_eq
l_int|0
)paren
(brace
id|killseg_core
c_func
(paren
id|shp
comma
l_int|0
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|vma-&gt;vm_file
op_assign
id|filp
suffix:semicolon
id|VMA_TO_SHP
c_func
(paren
id|vma
)paren
op_assign
(paren
r_void
op_star
)paren
id|shp
suffix:semicolon
id|shp-&gt;id
op_assign
id|zero_id
suffix:semicolon
id|init_MUTEX
c_func
(paren
op_amp
id|shp-&gt;zsem
)paren
suffix:semicolon
id|vma-&gt;vm_ops
op_assign
op_amp
id|shmzero_vm_ops
suffix:semicolon
id|shmzero_open
c_func
(paren
id|vma
)paren
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|zmap_list_lock
)paren
suffix:semicolon
id|list_add
c_func
(paren
op_amp
id|shp-&gt;zero_list
comma
op_amp
id|zshmid_kernel.zero_list
)paren
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|zmap_list_lock
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|shmzero_open
r_static
r_void
id|shmzero_open
c_func
(paren
r_struct
id|vm_area_struct
op_star
id|shmd
)paren
(brace
r_struct
id|shmid_kernel
op_star
id|shp
suffix:semicolon
id|shp
op_assign
id|VMA_TO_SHP
c_func
(paren
id|shmd
)paren
suffix:semicolon
id|down
c_func
(paren
op_amp
id|shp-&gt;zsem
)paren
suffix:semicolon
id|shp-&gt;shm_nattch
op_increment
suffix:semicolon
id|up
c_func
(paren
op_amp
id|shp-&gt;zsem
)paren
suffix:semicolon
)brace
DECL|function|shmzero_close
r_static
r_void
id|shmzero_close
c_func
(paren
r_struct
id|vm_area_struct
op_star
id|shmd
)paren
(brace
r_int
id|done
op_assign
l_int|0
suffix:semicolon
r_struct
id|shmid_kernel
op_star
id|shp
suffix:semicolon
id|shp
op_assign
id|VMA_TO_SHP
c_func
(paren
id|shmd
)paren
suffix:semicolon
id|down
c_func
(paren
op_amp
id|shp-&gt;zsem
)paren
suffix:semicolon
r_if
c_cond
(paren
op_decrement
id|shp-&gt;shm_nattch
op_eq
l_int|0
)paren
id|done
op_assign
l_int|1
suffix:semicolon
id|up
c_func
(paren
op_amp
id|shp-&gt;zsem
)paren
suffix:semicolon
r_if
c_cond
(paren
id|done
)paren
(brace
id|spin_lock
c_func
(paren
op_amp
id|zmap_list_lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|shp
op_eq
id|zswap_shp
)paren
id|zswap_shp
op_assign
id|list_entry
c_func
(paren
id|zswap_shp-&gt;zero_list.next
comma
r_struct
id|shmid_kernel
comma
id|zero_list
)paren
suffix:semicolon
id|list_del
c_func
(paren
op_amp
id|shp-&gt;zero_list
)paren
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|zmap_list_lock
)paren
suffix:semicolon
id|killseg_core
c_func
(paren
id|shp
comma
l_int|0
)paren
suffix:semicolon
)brace
)brace
DECL|function|shmzero_nopage
r_static
r_struct
id|page
op_star
id|shmzero_nopage
c_func
(paren
r_struct
id|vm_area_struct
op_star
id|shmd
comma
r_int
r_int
id|address
comma
r_int
id|no_share
)paren
(brace
r_struct
id|page
op_star
id|page
suffix:semicolon
r_struct
id|shmid_kernel
op_star
id|shp
suffix:semicolon
r_int
r_int
id|idx
suffix:semicolon
r_int
id|dummy
suffix:semicolon
id|idx
op_assign
(paren
id|address
op_minus
id|shmd-&gt;vm_start
)paren
op_rshift
id|PAGE_SHIFT
suffix:semicolon
id|idx
op_add_assign
id|shmd-&gt;vm_pgoff
suffix:semicolon
id|shp
op_assign
id|VMA_TO_SHP
c_func
(paren
id|shmd
)paren
suffix:semicolon
id|down
c_func
(paren
op_amp
id|shp-&gt;zsem
)paren
suffix:semicolon
id|shm_lock
c_func
(paren
id|zero_id
)paren
suffix:semicolon
id|page
op_assign
id|shm_nopage_core
c_func
(paren
id|shp
comma
id|idx
comma
op_amp
id|dummy
comma
op_amp
id|zshm_rss
)paren
suffix:semicolon
id|shm_unlock
c_func
(paren
id|zero_id
)paren
suffix:semicolon
id|up
c_func
(paren
op_amp
id|shp-&gt;zsem
)paren
suffix:semicolon
r_return
id|page
suffix:semicolon
)brace
DECL|function|zmap_unuse
r_static
r_void
id|zmap_unuse
c_func
(paren
id|swp_entry_t
id|entry
comma
r_struct
id|page
op_star
id|page
)paren
(brace
r_struct
id|shmid_kernel
op_star
id|shp
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|zmap_list_lock
)paren
suffix:semicolon
id|shm_lock
c_func
(paren
id|zero_id
)paren
suffix:semicolon
r_for
c_loop
(paren
id|shp
op_assign
id|list_entry
c_func
(paren
id|zshmid_kernel.zero_list.next
comma
r_struct
id|shmid_kernel
comma
id|zero_list
)paren
suffix:semicolon
id|shp
op_ne
op_amp
id|zshmid_kernel
suffix:semicolon
id|shp
op_assign
id|list_entry
c_func
(paren
id|shp-&gt;zero_list.next
comma
r_struct
id|shmid_kernel
comma
id|zero_list
)paren
)paren
(brace
r_if
c_cond
(paren
id|shm_unuse_core
c_func
(paren
id|shp
comma
id|entry
comma
id|page
)paren
)paren
r_break
suffix:semicolon
)brace
id|shm_unlock
c_func
(paren
id|zero_id
)paren
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|zmap_list_lock
)paren
suffix:semicolon
)brace
DECL|function|zshm_swap
r_static
r_void
id|zshm_swap
(paren
r_int
id|prio
comma
r_int
id|gfp_mask
comma
id|zone_t
op_star
id|zone
)paren
(brace
r_struct
id|shmid_kernel
op_star
id|shp
suffix:semicolon
id|swp_entry_t
id|swap_entry
suffix:semicolon
r_int
r_int
id|idx
suffix:semicolon
r_int
id|loop
op_assign
l_int|0
suffix:semicolon
r_int
id|counter
suffix:semicolon
r_struct
id|page
op_star
id|page_map
suffix:semicolon
id|counter
op_assign
id|zshm_rss
op_rshift
id|prio
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|counter
)paren
r_return
suffix:semicolon
id|next
suffix:colon
r_if
c_cond
(paren
id|shm_swap_preop
c_func
(paren
op_amp
id|swap_entry
)paren
)paren
r_return
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|zmap_list_lock
)paren
suffix:semicolon
id|shm_lock
c_func
(paren
id|zero_id
)paren
suffix:semicolon
r_if
c_cond
(paren
id|zshmid_kernel.zero_list.next
op_eq
l_int|0
)paren
r_goto
id|failed
suffix:semicolon
id|next_id
suffix:colon
r_if
c_cond
(paren
id|zswap_shp
op_eq
op_amp
id|zshmid_kernel
)paren
(brace
r_if
c_cond
(paren
id|loop
)paren
(brace
id|failed
suffix:colon
id|shm_unlock
c_func
(paren
id|zero_id
)paren
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|zmap_list_lock
)paren
suffix:semicolon
id|__swap_free
c_func
(paren
id|swap_entry
comma
l_int|2
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|zswap_shp
op_assign
id|list_entry
c_func
(paren
id|zshmid_kernel.zero_list.next
comma
r_struct
id|shmid_kernel
comma
id|zero_list
)paren
suffix:semicolon
id|zswap_idx
op_assign
l_int|0
suffix:semicolon
id|loop
op_assign
l_int|1
suffix:semicolon
)brace
id|shp
op_assign
id|zswap_shp
suffix:semicolon
id|check_table
suffix:colon
id|idx
op_assign
id|zswap_idx
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|idx
op_ge
id|shp-&gt;shm_npages
)paren
(brace
id|zswap_shp
op_assign
id|list_entry
c_func
(paren
id|zswap_shp-&gt;zero_list.next
comma
r_struct
id|shmid_kernel
comma
id|zero_list
)paren
suffix:semicolon
id|zswap_idx
op_assign
l_int|0
suffix:semicolon
r_goto
id|next_id
suffix:semicolon
)brace
r_switch
c_cond
(paren
id|shm_swap_core
c_func
(paren
id|shp
comma
id|idx
comma
id|swap_entry
comma
id|zone
comma
op_amp
id|counter
comma
op_amp
id|page_map
)paren
)paren
(brace
r_case
id|RETRY
suffix:colon
r_goto
id|check_table
suffix:semicolon
r_case
id|FAILED
suffix:colon
r_goto
id|failed
suffix:semicolon
)brace
id|shm_unlock
c_func
(paren
id|zero_id
)paren
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|zmap_list_lock
)paren
suffix:semicolon
id|shm_swap_postop
c_func
(paren
id|page_map
)paren
suffix:semicolon
r_if
c_cond
(paren
id|counter
)paren
r_goto
id|next
suffix:semicolon
r_return
suffix:semicolon
)brace
eof
