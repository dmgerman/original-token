multiline_comment|/*&n;&n;kHTTPd -- the next generation&n;&n;Wait for headers on the accepted connections&n;&n;*/
multiline_comment|/****************************************************************&n; *&t;This program is free software; you can redistribute it and/or modify&n; *&t;it under the terms of the GNU General Public License as published by&n; *&t;the Free Software Foundation; either version 2, or (at your option)&n; *&t;any later version.&n; *&n; *&t;This program is distributed in the hope that it will be useful,&n; *&t;but WITHOUT ANY WARRANTY; without even the implied warranty of&n; *&t;MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the&n; *&t;GNU General Public License for more details.&n; *&n; *&t;You should have received a copy of the GNU General Public License&n; *&t;along with this program; if not, write to the Free Software&n; *&t;Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.&n; *&n; ****************************************************************/
multiline_comment|/*&n;&n;Purpose:&n;&n;WaitForHeaders polls all connections in &quot;WaitForHeaderQueue&quot; to see if&n;headers have arived. If so, the headers are decoded and the request is&n;moved to either the &quot;SendingDataQueue&quot; or the &quot;UserspaceQueue&quot;.&n;&n;Return value:&n;&t;The number of requests that changed status&n;*/
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/skbuff.h&gt;
macro_line|#include &lt;linux/smp_lock.h&gt;
macro_line|#include &lt;linux/file.h&gt;
macro_line|#include &lt;asm/uaccess.h&gt;
macro_line|#include &quot;structure.h&quot;
macro_line|#include &quot;prototypes.h&quot;
DECL|variable|Buffer
r_static
r_char
op_star
id|Buffer
(braket
id|CONFIG_KHTTPD_NUMCPU
)braket
suffix:semicolon
r_static
r_int
id|DecodeHeader
c_func
(paren
r_const
r_int
id|CPUNR
comma
r_struct
id|http_request
op_star
id|Request
)paren
suffix:semicolon
DECL|function|WaitForHeaders
r_int
id|WaitForHeaders
c_func
(paren
r_const
r_int
id|CPUNR
)paren
(brace
r_struct
id|http_request
op_star
id|CurrentRequest
comma
op_star
op_star
id|Prev
suffix:semicolon
r_struct
id|sock
op_star
id|sk
suffix:semicolon
r_int
id|count
op_assign
l_int|0
suffix:semicolon
id|EnterFunction
c_func
(paren
l_string|&quot;WaitForHeaders&quot;
)paren
suffix:semicolon
id|CurrentRequest
op_assign
id|threadinfo
(braket
id|CPUNR
)braket
dot
id|WaitForHeaderQueue
suffix:semicolon
id|Prev
op_assign
op_amp
(paren
id|threadinfo
(braket
id|CPUNR
)braket
dot
id|WaitForHeaderQueue
)paren
suffix:semicolon
r_while
c_loop
(paren
id|CurrentRequest
op_ne
l_int|NULL
)paren
(brace
multiline_comment|/* If the connection is lost, remove from queue */
r_if
c_cond
(paren
id|CurrentRequest-&gt;sock-&gt;sk-&gt;state
op_ne
id|TCP_ESTABLISHED
op_logical_and
id|CurrentRequest-&gt;sock-&gt;sk-&gt;state
op_ne
id|TCP_CLOSE_WAIT
)paren
(brace
r_struct
id|http_request
op_star
id|Next
suffix:semicolon
id|Next
op_assign
id|CurrentRequest-&gt;Next
suffix:semicolon
op_star
id|Prev
op_assign
id|CurrentRequest-&gt;Next
suffix:semicolon
id|CurrentRequest-&gt;Next
op_assign
l_int|NULL
suffix:semicolon
id|CleanUpRequest
c_func
(paren
id|CurrentRequest
)paren
suffix:semicolon
id|CurrentRequest
op_assign
id|Next
suffix:semicolon
r_continue
suffix:semicolon
)brace
multiline_comment|/* If data pending, take action */
id|sk
op_assign
id|CurrentRequest-&gt;sock-&gt;sk
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|skb_queue_empty
c_func
(paren
op_amp
(paren
id|sk-&gt;receive_queue
)paren
)paren
)paren
multiline_comment|/* Do we have data ? */
(brace
r_struct
id|http_request
op_star
id|Next
suffix:semicolon
multiline_comment|/* Decode header */
r_if
c_cond
(paren
id|DecodeHeader
c_func
(paren
id|CPUNR
comma
id|CurrentRequest
)paren
OL
l_int|0
)paren
(brace
id|CurrentRequest
op_assign
id|CurrentRequest-&gt;Next
suffix:semicolon
r_continue
suffix:semicolon
)brace
multiline_comment|/* Remove from WaitForHeaderQueue */
id|Next
op_assign
id|CurrentRequest-&gt;Next
suffix:semicolon
op_star
id|Prev
op_assign
id|Next
suffix:semicolon
id|count
op_increment
suffix:semicolon
multiline_comment|/* Add to either the UserspaceQueue or the DataSendingQueue */
r_if
c_cond
(paren
id|CurrentRequest-&gt;IsForUserspace
op_ne
l_int|0
)paren
(brace
id|CurrentRequest-&gt;Next
op_assign
id|threadinfo
(braket
id|CPUNR
)braket
dot
id|UserspaceQueue
suffix:semicolon
id|threadinfo
(braket
id|CPUNR
)braket
dot
id|UserspaceQueue
op_assign
id|CurrentRequest
suffix:semicolon
)brace
r_else
(brace
id|CurrentRequest-&gt;Next
op_assign
id|threadinfo
(braket
id|CPUNR
)braket
dot
id|DataSendingQueue
suffix:semicolon
id|threadinfo
(braket
id|CPUNR
)braket
dot
id|DataSendingQueue
op_assign
id|CurrentRequest
suffix:semicolon
)brace
id|CurrentRequest
op_assign
id|Next
suffix:semicolon
r_continue
suffix:semicolon
)brace
id|Prev
op_assign
op_amp
(paren
id|CurrentRequest-&gt;Next
)paren
suffix:semicolon
id|CurrentRequest
op_assign
id|CurrentRequest-&gt;Next
suffix:semicolon
)brace
id|LeaveFunction
c_func
(paren
l_string|&quot;WaitHeaders&quot;
)paren
suffix:semicolon
r_return
id|count
suffix:semicolon
)brace
DECL|function|StopWaitingForHeaders
r_void
id|StopWaitingForHeaders
c_func
(paren
r_const
r_int
id|CPUNR
)paren
(brace
r_struct
id|http_request
op_star
id|CurrentRequest
comma
op_star
id|Next
suffix:semicolon
id|EnterFunction
c_func
(paren
l_string|&quot;StopWaitingForHeaders&quot;
)paren
suffix:semicolon
id|CurrentRequest
op_assign
id|threadinfo
(braket
id|CPUNR
)braket
dot
id|WaitForHeaderQueue
suffix:semicolon
r_while
c_loop
(paren
id|CurrentRequest
op_ne
l_int|NULL
)paren
(brace
id|Next
op_assign
id|CurrentRequest-&gt;Next
suffix:semicolon
id|CleanUpRequest
c_func
(paren
id|CurrentRequest
)paren
suffix:semicolon
id|CurrentRequest
op_assign
id|Next
suffix:semicolon
)brace
id|threadinfo
(braket
id|CPUNR
)braket
dot
id|WaitForHeaderQueue
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/* The queue is empty now */
id|free_page
c_func
(paren
(paren
r_int
r_int
)paren
id|Buffer
(braket
id|CPUNR
)braket
)paren
suffix:semicolon
id|Buffer
(braket
id|CPUNR
)braket
op_assign
l_int|NULL
suffix:semicolon
id|EnterFunction
c_func
(paren
l_string|&quot;StopWaitingForHeaders&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/* &n;&n;DecodeHeader peeks at the TCP/IP data, determines what the request is, &n;fills the request-structure and sends the HTTP-header when apropriate.&n;&n;*/
DECL|function|DecodeHeader
r_static
r_int
id|DecodeHeader
c_func
(paren
r_const
r_int
id|CPUNR
comma
r_struct
id|http_request
op_star
id|Request
)paren
(brace
r_struct
id|msghdr
id|msg
suffix:semicolon
r_struct
id|iovec
id|iov
suffix:semicolon
r_int
id|len
suffix:semicolon
id|mm_segment_t
id|oldfs
suffix:semicolon
id|EnterFunction
c_func
(paren
l_string|&quot;DecodeHeader&quot;
)paren
suffix:semicolon
multiline_comment|/* First, read the data */
id|msg.msg_name
op_assign
l_int|0
suffix:semicolon
id|msg.msg_namelen
op_assign
l_int|0
suffix:semicolon
id|msg.msg_iov
op_assign
op_amp
id|iov
suffix:semicolon
id|msg.msg_iovlen
op_assign
l_int|1
suffix:semicolon
id|msg.msg_control
op_assign
l_int|NULL
suffix:semicolon
id|msg.msg_controllen
op_assign
l_int|0
suffix:semicolon
id|msg.msg_flags
op_assign
l_int|0
suffix:semicolon
id|msg.msg_iov-&gt;iov_base
op_assign
op_amp
id|Buffer
(braket
id|CPUNR
)braket
(braket
l_int|0
)braket
suffix:semicolon
id|msg.msg_iov-&gt;iov_len
op_assign
(paren
r_int
)paren
l_int|4095
suffix:semicolon
id|len
op_assign
l_int|0
suffix:semicolon
id|oldfs
op_assign
id|get_fs
c_func
(paren
)paren
suffix:semicolon
id|set_fs
c_func
(paren
id|KERNEL_DS
)paren
suffix:semicolon
multiline_comment|/* 4095 leaves a &quot;0&quot; to terminate the string */
id|len
op_assign
id|sock_recvmsg
c_func
(paren
id|Request-&gt;sock
comma
op_amp
id|msg
comma
l_int|4095
comma
id|MSG_PEEK
)paren
suffix:semicolon
id|set_fs
c_func
(paren
id|oldfs
)paren
suffix:semicolon
r_if
c_cond
(paren
id|len
OL
l_int|0
)paren
(brace
multiline_comment|/* WONDERFUL. NO COMMENTS. --ANK */
id|Request-&gt;IsForUserspace
op_assign
l_int|1
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|len
op_ge
l_int|4094
)paren
multiline_comment|/* BIG header, we cannot decode it so leave it to userspace */
(brace
id|Request-&gt;IsForUserspace
op_assign
l_int|1
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Then, decode the header */
id|ParseHeader
c_func
(paren
id|Buffer
(braket
id|CPUNR
)braket
comma
id|len
comma
id|Request
)paren
suffix:semicolon
id|Request-&gt;filp
op_assign
id|OpenFileForSecurity
c_func
(paren
id|Request-&gt;FileName
)paren
suffix:semicolon
id|Request-&gt;MimeType
op_assign
id|ResolveMimeType
c_func
(paren
id|Request-&gt;FileName
comma
op_amp
id|Request-&gt;MimeLength
)paren
suffix:semicolon
r_if
c_cond
(paren
id|Request-&gt;MimeType
op_eq
l_int|NULL
)paren
multiline_comment|/* Unknown mime-type */
(brace
r_if
c_cond
(paren
id|Request-&gt;filp
op_ne
l_int|NULL
)paren
(brace
id|fput
c_func
(paren
id|Request-&gt;filp
)paren
suffix:semicolon
id|Request-&gt;filp
op_assign
l_int|NULL
suffix:semicolon
)brace
id|Request-&gt;IsForUserspace
op_assign
l_int|1
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|Request-&gt;filp
op_eq
l_int|NULL
)paren
(brace
id|Request-&gt;IsForUserspace
op_assign
l_int|1
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_else
(brace
id|Request-&gt;FileLength
op_assign
(paren
r_int
)paren
id|Request-&gt;filp-&gt;f_dentry-&gt;d_inode-&gt;i_size
suffix:semicolon
id|Request-&gt;Time
op_assign
id|Request-&gt;filp-&gt;f_dentry-&gt;d_inode-&gt;i_mtime
suffix:semicolon
id|Request-&gt;IMS_Time
op_assign
id|mimeTime_to_UnixTime
c_func
(paren
id|Request-&gt;IMS
)paren
suffix:semicolon
id|sprintf
c_func
(paren
id|Request-&gt;LengthS
comma
l_string|&quot;%i&quot;
comma
id|Request-&gt;FileLength
)paren
suffix:semicolon
id|time_Unix2RFC
c_func
(paren
id|min
c_func
(paren
id|Request-&gt;Time
comma
id|CurrentTime_i
)paren
comma
id|Request-&gt;TimeS
)paren
suffix:semicolon
multiline_comment|/* The min() is required by rfc1945, section 10.10:&n;   &t;           It is not allowed to send a filetime in the future */
r_if
c_cond
(paren
id|Request-&gt;IMS_Time
OG
id|Request-&gt;Time
)paren
(brace
multiline_comment|/* Not modified since last time */
id|Send304
c_func
(paren
id|Request-&gt;sock
)paren
suffix:semicolon
id|Request-&gt;FileLength
op_assign
l_int|0
suffix:semicolon
)brace
r_else
multiline_comment|/* Normal Case */
(brace
id|Request-&gt;sock-&gt;sk-&gt;tp_pinfo.af_tcp.nonagle
op_assign
l_int|2
suffix:semicolon
multiline_comment|/* this is TCP_CORK */
r_if
c_cond
(paren
id|Request-&gt;HTTPVER
op_ne
l_int|9
)paren
multiline_comment|/* HTTP/0.9 doesn&squot;t allow a header */
id|SendHTTPHeader
c_func
(paren
id|Request
)paren
suffix:semicolon
)brace
)brace
id|LeaveFunction
c_func
(paren
l_string|&quot;DecodeHeader&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|InitWaitHeaders
r_int
id|InitWaitHeaders
c_func
(paren
r_int
id|ThreadCount
)paren
(brace
r_int
id|I
comma
id|I2
suffix:semicolon
id|EnterFunction
c_func
(paren
l_string|&quot;InitWaitHeaders&quot;
)paren
suffix:semicolon
id|I
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
id|I
OL
id|ThreadCount
)paren
(brace
id|Buffer
(braket
id|I
)braket
op_assign
(paren
r_char
op_star
)paren
id|get_free_page
c_func
(paren
(paren
r_int
)paren
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|Buffer
(braket
id|I
)braket
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_CRIT
l_string|&quot;kHTTPd: Not enough memory for basic needs&bslash;n&quot;
)paren
suffix:semicolon
id|I2
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
id|I2
OL
id|I
op_minus
l_int|1
)paren
(brace
id|free_page
c_func
(paren
(paren
r_int
r_int
)paren
id|Buffer
(braket
id|I2
op_increment
)braket
)paren
suffix:semicolon
)brace
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|I
op_increment
suffix:semicolon
)brace
id|LeaveFunction
c_func
(paren
l_string|&quot;InitWaitHeaders&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
eof
