multiline_comment|/*&n;&n;kHTTPd -- the next generation&n;&n;Basic socket functions&n;&n;*/
multiline_comment|/****************************************************************&n; *&t;This program is free software; you can redistribute it and/or modify&n; *&t;it under the terms of the GNU General Public License as published by&n; *&t;the Free Software Foundation; either version 2, or (at your option)&n; *&t;any later version.&n; *&n; *&t;This program is distributed in the hope that it will be useful,&n; *&t;but WITHOUT ANY WARRANTY; without even the implied warranty of&n; *&t;MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the&n; *&t;GNU General Public License for more details.&n; *&n; *&t;You should have received a copy of the GNU General Public License&n; *&t;along with this program; if not, write to the Free Software&n; *&t;Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.&n; *&n; ****************************************************************/
macro_line|#include &quot;prototypes.h&quot;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/net.h&gt;
macro_line|#include &lt;linux/version.h&gt;
macro_line|#include &lt;linux/smp_lock.h&gt;
macro_line|#include &lt;net/sock.h&gt;
multiline_comment|/*&n;&n;MainSocket is shared by all threads, therefore it has to be&n;a global variable.&n;&n;*/
DECL|variable|MainSocket
r_struct
id|socket
op_star
id|MainSocket
op_assign
l_int|NULL
suffix:semicolon
DECL|function|StartListening
r_int
id|StartListening
c_func
(paren
r_const
r_int
id|Port
)paren
(brace
r_struct
id|socket
op_star
id|sock
suffix:semicolon
r_struct
id|sockaddr_in
id|sin
suffix:semicolon
r_int
id|error
suffix:semicolon
id|EnterFunction
c_func
(paren
l_string|&quot;StartListening&quot;
)paren
suffix:semicolon
multiline_comment|/* First create a socket */
id|error
op_assign
id|sock_create
c_func
(paren
id|PF_INET
comma
id|SOCK_STREAM
comma
id|IPPROTO_TCP
comma
op_amp
id|sock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
OL
l_int|0
)paren
(paren
r_void
)paren
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;Error during creation of socket; terminating&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* Now bind the socket */
id|sin.sin_family
op_assign
id|AF_INET
suffix:semicolon
id|sin.sin_addr.s_addr
op_assign
id|INADDR_ANY
suffix:semicolon
id|sin.sin_port
op_assign
id|htons
c_func
(paren
(paren
r_int
r_int
)paren
id|Port
)paren
suffix:semicolon
id|error
op_assign
id|sock-&gt;ops
op_member_access_from_pointer
id|bind
c_func
(paren
id|sock
comma
(paren
r_struct
id|sockaddr
op_star
)paren
op_amp
id|sin
comma
r_sizeof
(paren
id|sin
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
OL
l_int|0
)paren
(brace
(paren
r_void
)paren
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;kHTTPd: Error binding socket. This means that some other &bslash;n&quot;
)paren
suffix:semicolon
(paren
r_void
)paren
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;        daemon is (or was a short time ago) using port %i.&bslash;n&quot;
comma
id|Port
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Grrr... setsockopt() does this. */
id|sock-&gt;sk-&gt;reuse
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* Now, start listening on the socket */
multiline_comment|/* I have no idea what a sane backlog-value is. 48 works so far. */
id|error
op_assign
id|sock-&gt;ops
op_member_access_from_pointer
id|listen
c_func
(paren
id|sock
comma
l_int|48
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
op_ne
l_int|0
)paren
(paren
r_void
)paren
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;kHTTPd: Error listening on socket &bslash;n&quot;
)paren
suffix:semicolon
id|MainSocket
op_assign
id|sock
suffix:semicolon
id|EnterFunction
c_func
(paren
l_string|&quot;StartListening&quot;
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
DECL|function|StopListening
r_void
id|StopListening
c_func
(paren
r_void
)paren
(brace
r_struct
id|socket
op_star
id|sock
suffix:semicolon
id|EnterFunction
c_func
(paren
l_string|&quot;StopListening&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|MainSocket
op_eq
l_int|NULL
)paren
r_return
suffix:semicolon
id|sock
op_assign
id|MainSocket
suffix:semicolon
id|MainSocket
op_assign
l_int|NULL
suffix:semicolon
id|sock_release
c_func
(paren
id|sock
)paren
suffix:semicolon
id|LeaveFunction
c_func
(paren
l_string|&quot;StopListening&quot;
)paren
suffix:semicolon
)brace
eof
