multiline_comment|/*&n;&n;kHTTPd -- the next generation&n;&n;Sysctl interface&n;&n;*/
multiline_comment|/****************************************************************&n; *&t;This program is free software; you can redistribute it and/or modify&n; *&t;it under the terms of the GNU General Public License as published by&n; *&t;the Free Software Foundation; either version 2, or (at your option)&n; *&t;any later version.&n; *&n; *&t;This program is distributed in the hope that it will be useful,&n; *&t;but WITHOUT ANY WARRANTY; without even the implied warranty of&n; *&t;MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the&n; *&t;GNU General Public License for more details.&n; *&n; *&t;You should have received a copy of the GNU General Public License&n; *&t;along with this program; if not, write to the Free Software&n; *&t;Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.&n; *&n; ****************************************************************/
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/malloc.h&gt;
macro_line|#include &lt;linux/net.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/skbuff.h&gt;
macro_line|#include &lt;linux/smp_lock.h&gt;
macro_line|#include &lt;linux/sysctl.h&gt;
macro_line|#include &lt;linux/un.h&gt;
macro_line|#include &lt;linux/unistd.h&gt;
macro_line|#include &lt;net/ip.h&gt;
macro_line|#include &lt;net/sock.h&gt;
macro_line|#include &lt;net/tcp.h&gt;
macro_line|#include &lt;asm/atomic.h&gt;
macro_line|#include &lt;asm/semaphore.h&gt;
macro_line|#include &lt;asm/processor.h&gt;
macro_line|#include &lt;asm/uaccess.h&gt;
macro_line|#include &lt;linux/file.h&gt;
macro_line|#include &quot;prototypes.h&quot;
DECL|variable|sysctl_khttpd_docroot
r_char
id|sysctl_khttpd_docroot
(braket
l_int|200
)braket
op_assign
l_string|&quot;/var/www&quot;
suffix:semicolon
DECL|variable|sysctl_khttpd_stop
r_int
id|sysctl_khttpd_stop
op_assign
l_int|0
suffix:semicolon
DECL|variable|sysctl_khttpd_start
r_int
id|sysctl_khttpd_start
op_assign
l_int|0
suffix:semicolon
DECL|variable|sysctl_khttpd_unload
r_int
id|sysctl_khttpd_unload
op_assign
l_int|0
suffix:semicolon
DECL|variable|sysctl_khttpd_clientport
r_int
id|sysctl_khttpd_clientport
op_assign
l_int|80
suffix:semicolon
DECL|variable|sysctl_khttpd_permreq
r_int
id|sysctl_khttpd_permreq
op_assign
id|S_IROTH
suffix:semicolon
multiline_comment|/* &quot;other&quot; read-access is required by default*/
DECL|variable|sysctl_khttpd_permforbid
r_int
id|sysctl_khttpd_permforbid
op_assign
id|S_IFDIR
op_or
id|S_ISVTX
op_or
id|S_IXOTH
op_or
id|S_IXGRP
op_or
id|S_IXUSR
suffix:semicolon
multiline_comment|/* forbidden is execute, directory and sticky*/
DECL|variable|sysctl_khttpd_logging
r_int
id|sysctl_khttpd_logging
op_assign
l_int|0
suffix:semicolon
DECL|variable|sysctl_khttpd_serverport
r_int
id|sysctl_khttpd_serverport
op_assign
l_int|8080
suffix:semicolon
DECL|variable|sysctl_khttpd_dynamicstring
r_char
id|sysctl_khttpd_dynamicstring
(braket
l_int|200
)braket
suffix:semicolon
DECL|variable|sysctl_khttpd_sloppymime
r_int
id|sysctl_khttpd_sloppymime
op_assign
l_int|0
suffix:semicolon
DECL|variable|sysctl_khttpd_threads
r_int
id|sysctl_khttpd_threads
op_assign
l_int|2
suffix:semicolon
DECL|variable|sysctl_khttpd_maxconnect
r_int
id|sysctl_khttpd_maxconnect
op_assign
l_int|1000
suffix:semicolon
DECL|variable|khttpd_table_header
r_static
r_struct
id|ctl_table_header
op_star
id|khttpd_table_header
suffix:semicolon
r_static
r_int
id|sysctl_SecureString
c_func
(paren
id|ctl_table
op_star
id|table
comma
r_int
op_star
id|name
comma
r_int
id|nlen
comma
r_void
op_star
id|oldval
comma
r_int
op_star
id|oldlenp
comma
r_void
op_star
id|newval
comma
r_int
id|newlen
comma
r_void
op_star
op_star
id|context
)paren
suffix:semicolon
r_static
r_int
id|proc_dosecurestring
c_func
(paren
id|ctl_table
op_star
id|table
comma
r_int
id|write
comma
r_struct
id|file
op_star
id|filp
comma
r_void
op_star
id|buffer
comma
r_int
op_star
id|lenp
)paren
suffix:semicolon
DECL|variable|khttpd_table
r_static
id|ctl_table
id|khttpd_table
(braket
)braket
op_assign
(brace
(brace
id|NET_KHTTPD_DOCROOT
comma
l_string|&quot;documentroot&quot;
comma
op_amp
id|sysctl_khttpd_docroot
comma
r_sizeof
(paren
id|sysctl_khttpd_docroot
)paren
comma
l_int|0644
comma
l_int|NULL
comma
id|proc_dostring
comma
op_amp
id|sysctl_string
comma
l_int|NULL
comma
l_int|NULL
comma
l_int|NULL
)brace
comma
(brace
id|NET_KHTTPD_STOP
comma
l_string|&quot;stop&quot;
comma
op_amp
id|sysctl_khttpd_stop
comma
r_sizeof
(paren
r_int
)paren
comma
l_int|0644
comma
l_int|NULL
comma
id|proc_dointvec
comma
op_amp
id|sysctl_intvec
comma
l_int|NULL
comma
l_int|NULL
comma
l_int|NULL
)brace
comma
(brace
id|NET_KHTTPD_START
comma
l_string|&quot;start&quot;
comma
op_amp
id|sysctl_khttpd_start
comma
r_sizeof
(paren
r_int
)paren
comma
l_int|0644
comma
l_int|NULL
comma
id|proc_dointvec
comma
op_amp
id|sysctl_intvec
comma
l_int|NULL
comma
l_int|NULL
comma
l_int|NULL
)brace
comma
(brace
id|NET_KHTTPD_UNLOAD
comma
l_string|&quot;unload&quot;
comma
op_amp
id|sysctl_khttpd_unload
comma
r_sizeof
(paren
r_int
)paren
comma
l_int|0644
comma
l_int|NULL
comma
id|proc_dointvec
comma
op_amp
id|sysctl_intvec
comma
l_int|NULL
comma
l_int|NULL
comma
l_int|NULL
)brace
comma
(brace
id|NET_KHTTPD_THREADS
comma
l_string|&quot;threads&quot;
comma
op_amp
id|sysctl_khttpd_threads
comma
r_sizeof
(paren
r_int
)paren
comma
l_int|0644
comma
l_int|NULL
comma
id|proc_dointvec
comma
op_amp
id|sysctl_intvec
comma
l_int|NULL
comma
l_int|NULL
comma
l_int|NULL
)brace
comma
(brace
id|NET_KHTTPD_MAXCONNECT
comma
l_string|&quot;maxconnect&quot;
comma
op_amp
id|sysctl_khttpd_maxconnect
comma
r_sizeof
(paren
r_int
)paren
comma
l_int|0644
comma
l_int|NULL
comma
id|proc_dointvec
comma
op_amp
id|sysctl_intvec
comma
l_int|NULL
comma
l_int|NULL
comma
l_int|NULL
)brace
comma
(brace
id|NET_KHTTPD_SLOPPYMIME
comma
l_string|&quot;sloppymime&quot;
comma
op_amp
id|sysctl_khttpd_sloppymime
comma
r_sizeof
(paren
r_int
)paren
comma
l_int|0644
comma
l_int|NULL
comma
id|proc_dointvec
comma
op_amp
id|sysctl_intvec
comma
l_int|NULL
comma
l_int|NULL
comma
l_int|NULL
)brace
comma
(brace
id|NET_KHTTPD_CLIENTPORT
comma
l_string|&quot;clientport&quot;
comma
op_amp
id|sysctl_khttpd_clientport
comma
r_sizeof
(paren
r_int
)paren
comma
l_int|0644
comma
l_int|NULL
comma
id|proc_dointvec
comma
op_amp
id|sysctl_intvec
comma
l_int|NULL
comma
l_int|NULL
comma
l_int|NULL
)brace
comma
(brace
id|NET_KHTTPD_PERMREQ
comma
l_string|&quot;perm_required&quot;
comma
op_amp
id|sysctl_khttpd_permreq
comma
r_sizeof
(paren
r_int
)paren
comma
l_int|0644
comma
l_int|NULL
comma
id|proc_dointvec
comma
op_amp
id|sysctl_intvec
comma
l_int|NULL
comma
l_int|NULL
comma
l_int|NULL
)brace
comma
(brace
id|NET_KHTTPD_PERMFORBID
comma
l_string|&quot;perm_forbid&quot;
comma
op_amp
id|sysctl_khttpd_permforbid
comma
r_sizeof
(paren
r_int
)paren
comma
l_int|0644
comma
l_int|NULL
comma
id|proc_dointvec
comma
op_amp
id|sysctl_intvec
comma
l_int|NULL
comma
l_int|NULL
comma
l_int|NULL
)brace
comma
(brace
id|NET_KHTTPD_LOGGING
comma
l_string|&quot;logging&quot;
comma
op_amp
id|sysctl_khttpd_logging
comma
r_sizeof
(paren
r_int
)paren
comma
l_int|0644
comma
l_int|NULL
comma
id|proc_dointvec
comma
op_amp
id|sysctl_intvec
comma
l_int|NULL
comma
l_int|NULL
comma
l_int|NULL
)brace
comma
(brace
id|NET_KHTTPD_SERVERPORT
comma
l_string|&quot;serverport&quot;
comma
op_amp
id|sysctl_khttpd_serverport
comma
r_sizeof
(paren
r_int
)paren
comma
l_int|0644
comma
l_int|NULL
comma
id|proc_dointvec
comma
op_amp
id|sysctl_intvec
comma
l_int|NULL
comma
l_int|NULL
comma
l_int|NULL
)brace
comma
(brace
id|NET_KHTTPD_DYNAMICSTRING
comma
l_string|&quot;dynamic&quot;
comma
op_amp
id|sysctl_khttpd_dynamicstring
comma
r_sizeof
(paren
id|sysctl_khttpd_dynamicstring
)paren
comma
l_int|0644
comma
l_int|NULL
comma
id|proc_dosecurestring
comma
op_amp
id|sysctl_SecureString
comma
l_int|NULL
comma
l_int|NULL
comma
l_int|NULL
)brace
comma
(brace
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
)brace
)brace
suffix:semicolon
DECL|variable|khttpd_dir_table
r_static
id|ctl_table
id|khttpd_dir_table
(braket
)braket
op_assign
(brace
(brace
id|NET_KHTTPD
comma
l_string|&quot;khttpd&quot;
comma
l_int|NULL
comma
l_int|0
comma
l_int|0555
comma
id|khttpd_table
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
)brace
comma
(brace
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
)brace
)brace
suffix:semicolon
DECL|variable|khttpd_root_table
r_static
id|ctl_table
id|khttpd_root_table
(braket
)braket
op_assign
(brace
(brace
id|CTL_NET
comma
l_string|&quot;net&quot;
comma
l_int|NULL
comma
l_int|0
comma
l_int|0555
comma
id|khttpd_dir_table
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
)brace
comma
(brace
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
)brace
)brace
suffix:semicolon
DECL|function|StartSysctl
r_void
id|StartSysctl
c_func
(paren
r_void
)paren
(brace
id|khttpd_table_header
op_assign
id|register_sysctl_table
c_func
(paren
id|khttpd_root_table
comma
l_int|1
)paren
suffix:semicolon
)brace
DECL|function|EndSysctl
r_void
id|EndSysctl
c_func
(paren
r_void
)paren
(brace
id|unregister_sysctl_table
c_func
(paren
id|khttpd_table_header
)paren
suffix:semicolon
)brace
DECL|function|proc_dosecurestring
r_static
r_int
id|proc_dosecurestring
c_func
(paren
id|ctl_table
op_star
id|table
comma
r_int
id|write
comma
r_struct
id|file
op_star
id|filp
comma
r_void
op_star
id|buffer
comma
r_int
op_star
id|lenp
)paren
(brace
r_int
id|len
suffix:semicolon
r_char
op_star
id|p
comma
id|c
op_assign
l_int|0
suffix:semicolon
r_char
id|String
(braket
l_int|256
)braket
suffix:semicolon
r_if
c_cond
(paren
(paren
id|table-&gt;data
op_eq
l_int|0
)paren
op_logical_or
(paren
id|table-&gt;maxlen
op_eq
l_int|0
)paren
op_logical_or
(paren
op_star
id|lenp
op_eq
l_int|0
)paren
op_logical_or
(paren
(paren
id|filp-&gt;f_pos
op_ne
l_int|0
)paren
op_logical_and
(paren
id|write
op_eq
l_int|0
)paren
)paren
)paren
(brace
op_star
id|lenp
op_assign
l_int|0
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|write
op_ne
l_int|0
)paren
(brace
id|len
op_assign
l_int|0
suffix:semicolon
id|p
op_assign
id|buffer
suffix:semicolon
r_while
c_loop
(paren
id|len
OL
op_star
id|lenp
)paren
(brace
r_if
c_cond
(paren
id|get_user
c_func
(paren
id|c
comma
id|p
op_increment
)paren
)paren
(brace
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
r_if
c_cond
(paren
id|c
op_eq
l_int|0
op_logical_or
id|c
op_eq
l_char|&squot;&bslash;n&squot;
)paren
r_break
suffix:semicolon
id|len
op_increment
suffix:semicolon
)brace
r_if
c_cond
(paren
id|len
op_ge
id|table-&gt;maxlen
)paren
id|len
op_assign
id|table-&gt;maxlen
op_minus
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
id|String
comma
id|buffer
comma
(paren
r_int
r_int
)paren
id|len
)paren
)paren
(brace
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
(paren
(paren
r_char
op_star
)paren
id|String
)paren
(braket
id|len
)braket
op_assign
l_int|0
suffix:semicolon
id|filp-&gt;f_pos
op_add_assign
op_star
id|lenp
suffix:semicolon
id|AddDynamicString
c_func
(paren
id|String
)paren
suffix:semicolon
)brace
r_else
(brace
id|GetSecureString
c_func
(paren
id|String
)paren
suffix:semicolon
id|len
op_assign
id|strlen
c_func
(paren
id|String
)paren
suffix:semicolon
r_if
c_cond
(paren
id|len
OG
id|table-&gt;maxlen
)paren
id|len
op_assign
id|table-&gt;maxlen
suffix:semicolon
r_if
c_cond
(paren
id|len
OG
op_star
id|lenp
)paren
id|len
op_assign
op_star
id|lenp
suffix:semicolon
r_if
c_cond
(paren
id|len
op_ne
l_int|0
)paren
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
id|buffer
comma
id|String
comma
(paren
r_int
r_int
)paren
id|len
)paren
)paren
(brace
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
r_if
c_cond
(paren
id|len
OL
op_star
id|lenp
)paren
(brace
r_if
c_cond
(paren
id|put_user
c_func
(paren
l_char|&squot;&bslash;n&squot;
comma
(paren
(paren
r_char
op_star
)paren
id|buffer
)paren
op_plus
id|len
)paren
)paren
(brace
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
id|len
op_increment
suffix:semicolon
)brace
op_star
id|lenp
op_assign
id|len
suffix:semicolon
id|filp-&gt;f_pos
op_add_assign
id|len
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|sysctl_SecureString
r_static
r_int
id|sysctl_SecureString
(paren
multiline_comment|/*@unused@*/
id|ctl_table
op_star
id|table
comma
multiline_comment|/*@unused@*/
r_int
op_star
id|name
comma
multiline_comment|/*@unused@*/
r_int
id|nlen
comma
multiline_comment|/*@unused@*/
r_void
op_star
id|oldval
comma
multiline_comment|/*@unused@*/
r_int
op_star
id|oldlenp
comma
multiline_comment|/*@unused@*/
r_void
op_star
id|newval
comma
multiline_comment|/*@unused@*/
r_int
id|newlen
comma
multiline_comment|/*@unused@*/
r_void
op_star
op_star
id|context
)paren
(brace
r_return
op_minus
id|ENOSYS
suffix:semicolon
)brace
eof
