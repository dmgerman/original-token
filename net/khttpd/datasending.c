multiline_comment|/*&n;&n;kHTTPd -- the next generation&n;&n;Send actual file-data to the connections&n;&n;*/
multiline_comment|/****************************************************************&n; *&t;This program is free software; you can redistribute it and/or modify&n; *&t;it under the terms of the GNU General Public License as published by&n; *&t;the Free Software Foundation; either version 2, or (at your option)&n; *&t;any later version.&n; *&n; *&t;This program is distributed in the hope that it will be useful,&n; *&t;but WITHOUT ANY WARRANTY; without even the implied warranty of&n; *&t;MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the&n; *&t;GNU General Public License for more details.&n; *&n; *&t;You should have received a copy of the GNU General Public License&n; *&t;along with this program; if not, write to the Free Software&n; *&t;Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.&n; *&n; ****************************************************************/
multiline_comment|/*&n;&n;Purpose:&n;&n;DataSending does the actual sending of file-data to the socket.&n;&n;Note: Since asynchronous reads do not -yet- exists, this might block!&n;&n;Return value:&n;&t;The number of requests that changed status (ie: made some progress)&n;*/
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/skbuff.h&gt;
macro_line|#include &lt;net/tcp.h&gt;
macro_line|#include &lt;asm/uaccess.h&gt;
macro_line|#include &lt;linux/smp_lock.h&gt;
macro_line|#include &quot;structure.h&quot;
macro_line|#include &quot;prototypes.h&quot;
DECL|variable|Block
r_static
r_char
op_star
id|Block
(braket
id|CONFIG_KHTTPD_NUMCPU
)braket
suffix:semicolon
DECL|function|DataSending
r_int
id|DataSending
c_func
(paren
r_const
r_int
id|CPUNR
)paren
(brace
r_struct
id|http_request
op_star
id|CurrentRequest
comma
op_star
op_star
id|Prev
suffix:semicolon
r_int
id|count
op_assign
l_int|0
suffix:semicolon
id|EnterFunction
c_func
(paren
l_string|&quot;DataSending&quot;
)paren
suffix:semicolon
id|Prev
op_assign
op_amp
(paren
id|threadinfo
(braket
id|CPUNR
)braket
dot
id|DataSendingQueue
)paren
suffix:semicolon
id|CurrentRequest
op_assign
id|threadinfo
(braket
id|CPUNR
)braket
dot
id|DataSendingQueue
suffix:semicolon
r_while
c_loop
(paren
id|CurrentRequest
op_ne
l_int|NULL
)paren
(brace
r_int
id|ReadSize
comma
id|Space
suffix:semicolon
r_int
id|retval
suffix:semicolon
id|mm_segment_t
id|oldfs
suffix:semicolon
multiline_comment|/* First, test if the socket has any buffer-space left.&n;&t;&t;   If not, no need to actually try to send something.  */
id|Space
op_assign
l_int|4096
suffix:semicolon
r_if
c_cond
(paren
id|CurrentRequest-&gt;sock-&gt;sk
op_ne
l_int|NULL
)paren
multiline_comment|/* It&squot;s impossible */
(brace
id|Space
op_assign
id|sock_wspace
c_func
(paren
id|CurrentRequest-&gt;sock-&gt;sk
)paren
suffix:semicolon
)brace
id|ReadSize
op_assign
id|min
c_func
(paren
l_int|4096
comma
id|CurrentRequest-&gt;FileLength
op_minus
id|CurrentRequest-&gt;BytesSent
)paren
suffix:semicolon
id|ReadSize
op_assign
id|min
c_func
(paren
id|ReadSize
comma
id|Space
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ReadSize
OG
l_int|0
)paren
(brace
multiline_comment|/* This part does a redundant data-copy. To bad for now. &n;&t;&t;&t;   In the future, we might want to nick the data right out&n;&t;&t;&t;   of the page-cache&n;&n;&t;&t;&t;   WHY DO YOU NOT USE SENDFILE?&n;&t;&t;&t;*/
id|CurrentRequest-&gt;filp-&gt;f_pos
op_assign
id|CurrentRequest-&gt;BytesSent
suffix:semicolon
id|oldfs
op_assign
id|get_fs
c_func
(paren
)paren
suffix:semicolon
id|set_fs
c_func
(paren
id|KERNEL_DS
)paren
suffix:semicolon
id|retval
op_assign
id|CurrentRequest-&gt;filp-&gt;f_op
op_member_access_from_pointer
id|read
c_func
(paren
id|CurrentRequest-&gt;filp
comma
id|Block
(braket
id|CPUNR
)braket
comma
id|ReadSize
comma
op_amp
id|CurrentRequest-&gt;filp-&gt;f_pos
)paren
suffix:semicolon
id|set_fs
c_func
(paren
id|oldfs
)paren
suffix:semicolon
r_if
c_cond
(paren
id|retval
OG
l_int|0
)paren
(brace
id|retval
op_assign
id|SendBuffer_async
c_func
(paren
id|CurrentRequest-&gt;sock
comma
id|Block
(braket
id|CPUNR
)braket
comma
(paren
r_int
)paren
id|retval
)paren
suffix:semicolon
r_if
c_cond
(paren
id|retval
OG
l_int|0
)paren
(brace
id|CurrentRequest-&gt;BytesSent
op_add_assign
id|retval
suffix:semicolon
id|count
op_increment
suffix:semicolon
)brace
)brace
)brace
multiline_comment|/* &n;&t;&t;   If end-of-file or closed connection: Finish this request &n;&t;&t;   by moving it to the &quot;logging&quot; queue. &n;&t;&t;*/
r_if
c_cond
(paren
(paren
id|CurrentRequest-&gt;BytesSent
op_ge
id|CurrentRequest-&gt;FileLength
)paren
op_logical_or
(paren
id|CurrentRequest-&gt;sock-&gt;sk-&gt;state
op_ne
id|TCP_ESTABLISHED
op_logical_and
id|CurrentRequest-&gt;sock-&gt;sk-&gt;state
op_ne
id|TCP_CLOSE_WAIT
)paren
)paren
(brace
r_struct
id|http_request
op_star
id|Next
suffix:semicolon
id|Next
op_assign
id|CurrentRequest-&gt;Next
suffix:semicolon
id|lock_sock
c_func
(paren
id|CurrentRequest-&gt;sock-&gt;sk
)paren
suffix:semicolon
r_if
c_cond
(paren
id|CurrentRequest-&gt;sock-&gt;sk-&gt;state
op_eq
id|TCP_ESTABLISHED
op_logical_or
id|CurrentRequest-&gt;sock-&gt;sk-&gt;state
op_eq
id|TCP_CLOSE_WAIT
)paren
(brace
id|CurrentRequest-&gt;sock-&gt;sk-&gt;nonagle
op_assign
l_int|0
suffix:semicolon
id|tcp_push_pending_frames
c_func
(paren
id|CurrentRequest-&gt;sock-&gt;sk
comma
op_amp
(paren
id|CurrentRequest-&gt;sock-&gt;sk-&gt;tp_pinfo.af_tcp
)paren
)paren
suffix:semicolon
)brace
id|release_sock
c_func
(paren
id|CurrentRequest-&gt;sock-&gt;sk
)paren
suffix:semicolon
(paren
op_star
id|Prev
)paren
op_assign
id|CurrentRequest-&gt;Next
suffix:semicolon
id|CurrentRequest-&gt;Next
op_assign
id|threadinfo
(braket
id|CPUNR
)braket
dot
id|LoggingQueue
suffix:semicolon
id|threadinfo
(braket
id|CPUNR
)braket
dot
id|LoggingQueue
op_assign
id|CurrentRequest
suffix:semicolon
id|CurrentRequest
op_assign
id|Next
suffix:semicolon
r_continue
suffix:semicolon
)brace
id|Prev
op_assign
op_amp
(paren
id|CurrentRequest-&gt;Next
)paren
suffix:semicolon
id|CurrentRequest
op_assign
id|CurrentRequest-&gt;Next
suffix:semicolon
)brace
id|LeaveFunction
c_func
(paren
l_string|&quot;DataSending&quot;
)paren
suffix:semicolon
r_return
id|count
suffix:semicolon
)brace
DECL|function|InitDataSending
r_int
id|InitDataSending
c_func
(paren
r_int
id|ThreadCount
)paren
(brace
r_int
id|I
comma
id|I2
suffix:semicolon
id|EnterFunction
c_func
(paren
l_string|&quot;InitDataSending&quot;
)paren
suffix:semicolon
id|I
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
id|I
OL
id|ThreadCount
)paren
(brace
id|Block
(braket
id|I
)braket
op_assign
(paren
r_char
op_star
)paren
id|get_free_page
c_func
(paren
(paren
r_int
)paren
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|Block
(braket
id|I
)braket
op_eq
l_int|NULL
)paren
(brace
id|I2
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
id|I2
OL
id|I
op_minus
l_int|1
)paren
(brace
id|free_page
c_func
(paren
(paren
r_int
r_int
)paren
id|Block
(braket
id|I2
op_increment
)braket
)paren
suffix:semicolon
)brace
id|LeaveFunction
c_func
(paren
l_string|&quot;InitDataSending - abort&quot;
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|I
op_increment
suffix:semicolon
)brace
id|LeaveFunction
c_func
(paren
l_string|&quot;InitDataSending&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|StopDataSending
r_void
id|StopDataSending
c_func
(paren
r_const
r_int
id|CPUNR
)paren
(brace
r_struct
id|http_request
op_star
id|CurrentRequest
comma
op_star
id|Next
suffix:semicolon
id|EnterFunction
c_func
(paren
l_string|&quot;StopDataSending&quot;
)paren
suffix:semicolon
id|CurrentRequest
op_assign
id|threadinfo
(braket
id|CPUNR
)braket
dot
id|DataSendingQueue
suffix:semicolon
r_while
c_loop
(paren
id|CurrentRequest
op_ne
l_int|NULL
)paren
(brace
id|Next
op_assign
id|CurrentRequest-&gt;Next
suffix:semicolon
id|CleanUpRequest
c_func
(paren
id|CurrentRequest
)paren
suffix:semicolon
id|CurrentRequest
op_assign
id|Next
suffix:semicolon
)brace
id|threadinfo
(braket
id|CPUNR
)braket
dot
id|DataSendingQueue
op_assign
l_int|NULL
suffix:semicolon
id|free_page
c_func
(paren
(paren
r_int
r_int
)paren
id|Block
(braket
id|CPUNR
)braket
)paren
suffix:semicolon
id|LeaveFunction
c_func
(paren
l_string|&quot;StopDataSending&quot;
)paren
suffix:semicolon
)brace
eof
