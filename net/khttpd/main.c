multiline_comment|/*&n;&n;kHTTPd -- the next generation&n;&n;Main program&n;&n;&n;kHTTPd TNG consists of 1 thread, this main-thread handles ALL connections&n;simultanious. It does this by keeping queues with the requests in different&n;stages.&n;&n;The stages are&n;&n;&lt;not accepted&gt; &t;&t;-&t;TCP/IP connection is not accepted yet&n;WaitForHeaders&t;&t;-&t;Connection is accepted, waiting for headers&n;DataSending&t;&t;-&t;Headers decoded, sending file-data&n;Userspace&t;&t;-&t;Requires userspace daemon &n;Logging&t;&t;&t;-&t;The request is finished, cleanup and logging&n;&n;A typical flow for a request would be:&n;&n;&lt;not accepted&gt;&n;WaitForHeaders&n;DataSending&n;Logging&n;&n;or&n;&n;&lt;not accepted&gt;&n;WaitForHeaders&n;Userspace&n;&n;&n;&n;*/
multiline_comment|/****************************************************************&n; *&t;This program is free software; you can redistribute it and/or modify&n; *&t;it under the terms of the GNU General Public License as published by&n; *&t;the Free Software Foundation; either version 2, or (at your option)&n; *&t;any later version.&n; *&n; *&t;This program is distributed in the hope that it will be useful,&n; *&t;but WITHOUT ANY WARRANTY; without even the implied warranty of&n; *&t;MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the&n; *&t;GNU General Public License for more details.&n; *&n; *&t;You should have received a copy of the GNU General Public License&n; *&t;along with this program; if not, write to the Free Software&n; *&t;Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.&n; *&n; ****************************************************************/
DECL|variable|errno
r_static
r_int
id|errno
suffix:semicolon
DECL|macro|__KERNEL_SYSCALLS__
mdefine_line|#define __KERNEL_SYSCALLS__
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/signal.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/wait.h&gt;
macro_line|#include &lt;linux/smp_lock.h&gt;
macro_line|#include &lt;asm/unistd.h&gt;
macro_line|#include &quot;structure.h&quot;
macro_line|#include &quot;prototypes.h&quot;
macro_line|#include &quot;sysctl.h&quot;
DECL|variable|threadinfo
r_struct
id|khttpd_threadinfo
id|threadinfo
(braket
id|CONFIG_KHTTPD_NUMCPU
)braket
suffix:semicolon
multiline_comment|/* The actual work-queues */
DECL|variable|ConnectCount
id|atomic_t
id|ConnectCount
suffix:semicolon
DECL|variable|DaemonCount
id|atomic_t
id|DaemonCount
suffix:semicolon
DECL|variable|ActualThreads
r_static
r_int
id|ActualThreads
suffix:semicolon
multiline_comment|/* The number of actual, active threads */
DECL|function|ConnectionsPending
r_static
r_int
id|ConnectionsPending
c_func
(paren
r_int
id|CPUNR
)paren
(brace
r_if
c_cond
(paren
id|threadinfo
(braket
id|CPUNR
)braket
dot
id|DataSendingQueue
op_ne
l_int|NULL
)paren
r_return
id|O_NONBLOCK
suffix:semicolon
r_if
c_cond
(paren
id|threadinfo
(braket
id|CPUNR
)braket
dot
id|WaitForHeaderQueue
op_ne
l_int|NULL
)paren
r_return
id|O_NONBLOCK
suffix:semicolon
r_if
c_cond
(paren
id|threadinfo
(braket
id|CPUNR
)braket
dot
id|LoggingQueue
op_ne
l_int|NULL
)paren
r_return
id|O_NONBLOCK
suffix:semicolon
r_if
c_cond
(paren
id|threadinfo
(braket
id|CPUNR
)braket
dot
id|UserspaceQueue
op_ne
l_int|NULL
)paren
r_return
id|O_NONBLOCK
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|variable|DummyWQ
r_static
id|wait_queue_head_t
id|DummyWQ
(braket
id|CONFIG_KHTTPD_NUMCPU
)braket
suffix:semicolon
DECL|variable|Running
r_static
id|atomic_t
id|Running
(braket
id|CONFIG_KHTTPD_NUMCPU
)braket
suffix:semicolon
DECL|function|MainDaemon
r_static
r_int
id|MainDaemon
c_func
(paren
r_void
op_star
id|cpu_pointer
)paren
(brace
r_int
id|CPUNR
suffix:semicolon
id|sigset_t
id|tmpsig
suffix:semicolon
id|DECLARE_WAITQUEUE
c_func
(paren
id|main_wait
comma
id|current
)paren
suffix:semicolon
id|MOD_INC_USE_COUNT
suffix:semicolon
id|CPUNR
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|cpu_pointer
op_ne
l_int|NULL
)paren
id|CPUNR
op_assign
(paren
r_int
)paren
op_star
(paren
r_int
op_star
)paren
id|cpu_pointer
suffix:semicolon
id|sprintf
c_func
(paren
id|current-&gt;comm
comma
l_string|&quot;khttpd - %i&quot;
comma
id|CPUNR
)paren
suffix:semicolon
id|daemonize
c_func
(paren
)paren
suffix:semicolon
id|init_waitqueue_head
c_func
(paren
op_amp
(paren
id|DummyWQ
(braket
id|CPUNR
)braket
)paren
)paren
suffix:semicolon
multiline_comment|/* Block all signals except SIGKILL, SIGSTOP and SIGHUP */
id|spin_lock_irq
c_func
(paren
op_amp
id|current-&gt;sigmask_lock
)paren
suffix:semicolon
id|tmpsig
op_assign
id|current-&gt;blocked
suffix:semicolon
id|siginitsetinv
c_func
(paren
op_amp
id|current-&gt;blocked
comma
id|sigmask
c_func
(paren
id|SIGKILL
)paren
op_or
id|sigmask
c_func
(paren
id|SIGSTOP
)paren
op_or
id|sigmask
c_func
(paren
id|SIGHUP
)paren
)paren
suffix:semicolon
id|recalc_sigpending
c_func
(paren
id|current
)paren
suffix:semicolon
id|spin_unlock_irq
c_func
(paren
op_amp
id|current-&gt;sigmask_lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|MainSocket-&gt;sk
op_eq
l_int|NULL
)paren
r_return
l_int|0
suffix:semicolon
id|add_wait_queue_exclusive
c_func
(paren
id|MainSocket-&gt;sk-&gt;sleep
comma
op_amp
(paren
id|main_wait
)paren
)paren
suffix:semicolon
id|atomic_inc
c_func
(paren
op_amp
id|DaemonCount
)paren
suffix:semicolon
id|atomic_set
c_func
(paren
op_amp
id|Running
(braket
id|CPUNR
)braket
comma
l_int|1
)paren
suffix:semicolon
r_while
c_loop
(paren
id|sysctl_khttpd_stop
op_eq
l_int|0
)paren
(brace
r_int
id|changes
op_assign
l_int|0
suffix:semicolon
id|changes
op_add_assign
id|AcceptConnections
c_func
(paren
id|CPUNR
comma
id|MainSocket
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ConnectionsPending
c_func
(paren
id|CPUNR
)paren
)paren
(brace
id|changes
op_add_assign
id|WaitForHeaders
c_func
(paren
id|CPUNR
)paren
suffix:semicolon
id|changes
op_add_assign
id|DataSending
c_func
(paren
id|CPUNR
)paren
suffix:semicolon
id|changes
op_add_assign
id|Userspace
c_func
(paren
id|CPUNR
)paren
suffix:semicolon
id|changes
op_add_assign
id|Logging
c_func
(paren
id|CPUNR
)paren
suffix:semicolon
multiline_comment|/* Test for incomming connections _again_, because it is possible&n;&t;&t;&t;   one came in during the other steps, and the wakeup doesn&squot;t happen&n;&t;&t;&t;   then.&n;&t;&t;&t;*/
id|changes
op_add_assign
id|AcceptConnections
c_func
(paren
id|CPUNR
comma
id|MainSocket
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|changes
op_eq
l_int|0
)paren
(brace
(paren
r_void
)paren
id|interruptible_sleep_on_timeout
c_func
(paren
op_amp
(paren
id|DummyWQ
(braket
id|CPUNR
)braket
)paren
comma
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|CPUNR
op_eq
l_int|0
)paren
id|UpdateCurrentDate
c_func
(paren
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|signal_pending
c_func
(paren
id|current
)paren
op_ne
l_int|0
)paren
(brace
(paren
r_void
)paren
id|printk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;kHTTPd: Ring Ring - signal received&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
id|remove_wait_queue
c_func
(paren
id|MainSocket-&gt;sk-&gt;sleep
comma
op_amp
(paren
id|main_wait
)paren
)paren
suffix:semicolon
id|StopWaitingForHeaders
c_func
(paren
id|CPUNR
)paren
suffix:semicolon
id|StopDataSending
c_func
(paren
id|CPUNR
)paren
suffix:semicolon
id|StopUserspace
c_func
(paren
id|CPUNR
)paren
suffix:semicolon
id|StopLogging
c_func
(paren
id|CPUNR
)paren
suffix:semicolon
id|atomic_set
c_func
(paren
op_amp
id|Running
(braket
id|CPUNR
)braket
comma
l_int|0
)paren
suffix:semicolon
id|atomic_dec
c_func
(paren
op_amp
id|DaemonCount
)paren
suffix:semicolon
(paren
r_void
)paren
id|printk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;kHTTPd: Daemon %i has ended&bslash;n&quot;
comma
id|CPUNR
)paren
suffix:semicolon
id|MOD_DEC_USE_COUNT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|variable|CountBuf
r_static
r_int
id|CountBuf
(braket
id|CONFIG_KHTTPD_NUMCPU
)braket
suffix:semicolon
multiline_comment|/*&n;&n;The ManagementDaemon has a very simple task: Start the real daemons when the user wants us&n;to, and cleanup when the users wants to unload the module.&n;&n;Initially, kHTTPd didn&squot;t have this thread, but it is the only way to have &quot;delayed activation&quot;,&n;a feature required to prevent accidental activations resulting in unexpected backdoors.&n;&n;*/
DECL|function|ManagementDaemon
r_static
r_int
id|ManagementDaemon
c_func
(paren
r_void
op_star
id|unused
)paren
(brace
id|sigset_t
id|tmpsig
suffix:semicolon
r_int
id|waitpid_result
suffix:semicolon
id|DECLARE_WAIT_QUEUE_HEAD
c_func
(paren
id|WQ
)paren
suffix:semicolon
id|sprintf
c_func
(paren
id|current-&gt;comm
comma
l_string|&quot;khttpd manager&quot;
)paren
suffix:semicolon
id|daemonize
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* Block all signals except SIGKILL and SIGSTOP */
id|spin_lock_irq
c_func
(paren
op_amp
id|current-&gt;sigmask_lock
)paren
suffix:semicolon
id|tmpsig
op_assign
id|current-&gt;blocked
suffix:semicolon
id|siginitsetinv
c_func
(paren
op_amp
id|current-&gt;blocked
comma
id|sigmask
c_func
(paren
id|SIGKILL
)paren
op_or
id|sigmask
c_func
(paren
id|SIGSTOP
)paren
)paren
suffix:semicolon
id|recalc_sigpending
c_func
(paren
id|current
)paren
suffix:semicolon
id|spin_unlock_irq
c_func
(paren
op_amp
id|current-&gt;sigmask_lock
)paren
suffix:semicolon
multiline_comment|/* main loop */
r_while
c_loop
(paren
id|sysctl_khttpd_unload
op_eq
l_int|0
)paren
(brace
r_int
id|I
suffix:semicolon
multiline_comment|/* First : wait for activation */
id|sysctl_khttpd_start
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
(paren
id|sysctl_khttpd_start
op_eq
l_int|0
)paren
op_logical_and
(paren
op_logical_neg
id|signal_pending
c_func
(paren
id|current
)paren
)paren
op_logical_and
(paren
id|sysctl_khttpd_unload
op_eq
l_int|0
)paren
)paren
(brace
id|current-&gt;state
op_assign
id|TASK_INTERRUPTIBLE
suffix:semicolon
id|interruptible_sleep_on_timeout
c_func
(paren
op_amp
id|WQ
comma
id|HZ
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|signal_pending
c_func
(paren
id|current
)paren
)paren
op_logical_or
(paren
id|sysctl_khttpd_unload
op_ne
l_int|0
)paren
)paren
r_break
suffix:semicolon
multiline_comment|/* Then start listening and spawn the daemons */
r_if
c_cond
(paren
id|StartListening
c_func
(paren
id|sysctl_khttpd_serverport
)paren
op_eq
l_int|0
)paren
(brace
r_continue
suffix:semicolon
)brace
id|ActualThreads
op_assign
id|sysctl_khttpd_threads
suffix:semicolon
r_if
c_cond
(paren
id|ActualThreads
OL
l_int|1
)paren
id|ActualThreads
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|ActualThreads
OG
id|CONFIG_KHTTPD_NUMCPU
)paren
id|ActualThreads
op_assign
id|CONFIG_KHTTPD_NUMCPU
suffix:semicolon
multiline_comment|/* Write back the actual value */
id|sysctl_khttpd_threads
op_assign
id|ActualThreads
suffix:semicolon
id|InitUserspace
c_func
(paren
id|ActualThreads
)paren
suffix:semicolon
r_if
c_cond
(paren
id|InitDataSending
c_func
(paren
id|ActualThreads
)paren
op_ne
l_int|0
)paren
(brace
id|StopListening
c_func
(paren
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
r_if
c_cond
(paren
id|InitWaitHeaders
c_func
(paren
id|ActualThreads
)paren
op_ne
l_int|0
)paren
(brace
id|I
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
id|I
OL
id|ActualThreads
)paren
(brace
id|StopDataSending
c_func
(paren
id|I
)paren
suffix:semicolon
id|I
op_increment
suffix:semicolon
)brace
id|StopListening
c_func
(paren
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
multiline_comment|/* Clean all queues */
id|memset
c_func
(paren
id|threadinfo
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|khttpd_threadinfo
)paren
)paren
suffix:semicolon
id|I
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
id|I
OL
id|ActualThreads
)paren
(brace
id|atomic_set
c_func
(paren
op_amp
id|Running
(braket
id|I
)braket
comma
l_int|1
)paren
suffix:semicolon
(paren
r_void
)paren
id|kernel_thread
c_func
(paren
id|MainDaemon
comma
op_amp
(paren
id|CountBuf
(braket
id|I
)braket
)paren
comma
id|CLONE_FS
op_or
id|CLONE_FILES
op_or
id|CLONE_SIGHAND
)paren
suffix:semicolon
id|I
op_increment
suffix:semicolon
)brace
multiline_comment|/* Then wait for deactivation */
id|sysctl_khttpd_stop
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
(paren
id|sysctl_khttpd_stop
op_eq
l_int|0
)paren
op_logical_and
(paren
op_logical_neg
id|signal_pending
c_func
(paren
id|current
)paren
)paren
op_logical_and
(paren
id|sysctl_khttpd_unload
op_eq
l_int|0
)paren
)paren
(brace
r_if
c_cond
(paren
id|atomic_read
c_func
(paren
op_amp
id|DaemonCount
)paren
OL
id|ActualThreads
)paren
(brace
id|I
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
id|I
OL
id|ActualThreads
)paren
(brace
r_if
c_cond
(paren
id|atomic_read
c_func
(paren
op_amp
id|Running
(braket
id|I
)braket
)paren
op_eq
l_int|0
)paren
(brace
id|atomic_set
c_func
(paren
op_amp
id|Running
(braket
id|I
)braket
comma
l_int|1
)paren
suffix:semicolon
(paren
r_void
)paren
id|kernel_thread
c_func
(paren
id|MainDaemon
comma
op_amp
(paren
id|CountBuf
(braket
id|I
)braket
)paren
comma
id|CLONE_FS
op_or
id|CLONE_FILES
op_or
id|CLONE_SIGHAND
)paren
suffix:semicolon
(paren
r_void
)paren
id|printk
c_func
(paren
id|KERN_CRIT
l_string|&quot;kHTTPd: Restarting daemon %i &bslash;n&quot;
comma
id|I
)paren
suffix:semicolon
)brace
id|I
op_increment
suffix:semicolon
)brace
)brace
id|interruptible_sleep_on_timeout
c_func
(paren
op_amp
id|WQ
comma
id|HZ
)paren
suffix:semicolon
multiline_comment|/* reap the daemons */
id|waitpid_result
op_assign
id|waitpid
c_func
(paren
op_minus
l_int|1
comma
l_int|NULL
comma
id|__WCLONE
op_or
id|WNOHANG
)paren
suffix:semicolon
)brace
multiline_comment|/* The user wants us to stop. So stop listening on the socket. */
r_if
c_cond
(paren
id|sysctl_khttpd_stop
op_ne
l_int|0
)paren
(brace
multiline_comment|/* Wait for the daemons to stop, one second per iteration */
r_while
c_loop
(paren
id|atomic_read
c_func
(paren
op_amp
id|DaemonCount
)paren
OG
l_int|0
)paren
id|interruptible_sleep_on_timeout
c_func
(paren
op_amp
id|WQ
comma
id|HZ
)paren
suffix:semicolon
id|StopListening
c_func
(paren
)paren
suffix:semicolon
)brace
)brace
id|sysctl_khttpd_stop
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* Wait for the daemons to stop, one second per iteration */
r_while
c_loop
(paren
id|atomic_read
c_func
(paren
op_amp
id|DaemonCount
)paren
OG
l_int|0
)paren
id|interruptible_sleep_on_timeout
c_func
(paren
op_amp
id|WQ
comma
id|HZ
)paren
suffix:semicolon
id|waitpid_result
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* reap the zombie-daemons */
r_while
c_loop
(paren
id|waitpid_result
OG
l_int|0
)paren
id|waitpid_result
op_assign
id|waitpid
c_func
(paren
op_minus
l_int|1
comma
l_int|NULL
comma
id|__WCLONE
op_or
id|WNOHANG
)paren
suffix:semicolon
id|StopListening
c_func
(paren
)paren
suffix:semicolon
(paren
r_void
)paren
id|printk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;kHTTPd: Management daemon stopped. &bslash;n        You can unload the module now.&bslash;n&quot;
)paren
suffix:semicolon
id|MOD_DEC_USE_COUNT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|khttpd_init
r_int
id|__init
id|khttpd_init
c_func
(paren
r_void
)paren
(brace
r_int
id|I
suffix:semicolon
id|MOD_INC_USE_COUNT
suffix:semicolon
id|I
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
id|I
OL
id|CONFIG_KHTTPD_NUMCPU
)paren
(brace
id|CountBuf
(braket
id|I
)braket
op_assign
id|I
suffix:semicolon
id|I
op_increment
suffix:semicolon
)brace
id|atomic_set
c_func
(paren
op_amp
id|ConnectCount
comma
l_int|0
)paren
suffix:semicolon
id|atomic_set
c_func
(paren
op_amp
id|DaemonCount
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* Maybe the mime-types will be set-able through sysctl in the future */
id|AddMimeType
c_func
(paren
l_string|&quot;.htm&quot;
comma
l_string|&quot;text/html&quot;
)paren
suffix:semicolon
id|AddMimeType
c_func
(paren
l_string|&quot;html&quot;
comma
l_string|&quot;text/html&quot;
)paren
suffix:semicolon
id|AddMimeType
c_func
(paren
l_string|&quot;.gif&quot;
comma
l_string|&quot;image/gif&quot;
)paren
suffix:semicolon
id|AddMimeType
c_func
(paren
l_string|&quot;.jpg&quot;
comma
l_string|&quot;image/jpeg&quot;
)paren
suffix:semicolon
id|AddMimeType
c_func
(paren
l_string|&quot;.png&quot;
comma
l_string|&quot;image/png&quot;
)paren
suffix:semicolon
id|AddMimeType
c_func
(paren
l_string|&quot;tiff&quot;
comma
l_string|&quot;image/tiff&quot;
)paren
suffix:semicolon
id|AddMimeType
c_func
(paren
l_string|&quot;.zip&quot;
comma
l_string|&quot;application/zip&quot;
)paren
suffix:semicolon
id|AddMimeType
c_func
(paren
l_string|&quot;.pdf&quot;
comma
l_string|&quot;application/pdf&quot;
)paren
suffix:semicolon
id|AddMimeType
c_func
(paren
l_string|&quot;r.gz&quot;
comma
l_string|&quot;application/x-gtar&quot;
)paren
suffix:semicolon
id|AddMimeType
c_func
(paren
l_string|&quot;.tgz&quot;
comma
l_string|&quot;application/x-gtar&quot;
)paren
suffix:semicolon
id|AddMimeType
c_func
(paren
l_string|&quot;.deb&quot;
comma
l_string|&quot;application/x-debian-package&quot;
)paren
suffix:semicolon
id|AddMimeType
c_func
(paren
l_string|&quot;lass&quot;
comma
l_string|&quot;application/x-java&quot;
)paren
suffix:semicolon
id|AddMimeType
c_func
(paren
l_string|&quot;.mp3&quot;
comma
l_string|&quot;audio/mpeg&quot;
)paren
suffix:semicolon
id|AddMimeType
c_func
(paren
l_string|&quot;.txt&quot;
comma
l_string|&quot;text/plain&quot;
)paren
suffix:semicolon
id|AddDynamicString
c_func
(paren
l_string|&quot;..&quot;
)paren
suffix:semicolon
id|AddDynamicString
c_func
(paren
l_string|&quot;cgi-bin&quot;
)paren
suffix:semicolon
id|StartSysctl
c_func
(paren
)paren
suffix:semicolon
(paren
r_void
)paren
id|kernel_thread
c_func
(paren
id|ManagementDaemon
comma
l_int|NULL
comma
id|CLONE_FS
op_or
id|CLONE_FILES
op_or
id|CLONE_SIGHAND
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|khttpd_cleanup
r_void
id|khttpd_cleanup
c_func
(paren
r_void
)paren
(brace
id|EndSysctl
c_func
(paren
)paren
suffix:semicolon
)brace
id|module_init
c_func
(paren
id|khttpd_init
)paren
id|module_exit
c_func
(paren
id|khttpd_cleanup
)paren
eof
