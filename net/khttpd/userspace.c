multiline_comment|/*&n;&n;kHTTPd -- the next generation&n;&n;Pass connections to userspace-daemons&n;&n;*/
multiline_comment|/****************************************************************&n; *&t;This program is free software; you can redistribute it and/or modify&n; *&t;it under the terms of the GNU General Public License as published by&n; *&t;the Free Software Foundation; either version 2, or (at your option)&n; *&t;any later version.&n; *&n; *&t;This program is distributed in the hope that it will be useful,&n; *&t;but WITHOUT ANY WARRANTY; without even the implied warranty of&n; *&t;MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the&n; *&t;GNU General Public License for more details.&n; *&n; *&t;You should have received a copy of the GNU General Public License&n; *&t;along with this program; if not, write to the Free Software&n; *&t;Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.&n; *&n; ****************************************************************/
multiline_comment|/*&n;&n;Purpose:&n;&n;Userspace() hands all requests in the queue to the userspace-daemon, if&n;such beast exists.&n;&n;Return value:&n;&t;The number of requests that changed status&n;*/
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/malloc.h&gt;
macro_line|#include &lt;linux/net.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/skbuff.h&gt;
macro_line|#include &lt;linux/smp_lock.h&gt;
macro_line|#include &lt;linux/un.h&gt;
macro_line|#include &lt;linux/unistd.h&gt;
macro_line|#include &lt;linux/wait.h&gt;
macro_line|#include &lt;net/ip.h&gt;
macro_line|#include &lt;net/sock.h&gt;
macro_line|#include &lt;net/tcp.h&gt;
macro_line|#include &lt;asm/atomic.h&gt;
macro_line|#include &lt;asm/semaphore.h&gt;
macro_line|#include &lt;asm/processor.h&gt;
macro_line|#include &lt;asm/uaccess.h&gt;
macro_line|#include &lt;linux/file.h&gt;
macro_line|#include &quot;structure.h&quot;
macro_line|#include &quot;prototypes.h&quot;
macro_line|#include &quot;sysctl.h&quot;
multiline_comment|/* prototypes of local, static functions */
r_static
r_int
id|AddSocketToAcceptQueue
c_func
(paren
r_struct
id|socket
op_star
id|sock
comma
r_const
r_int
id|Port
)paren
suffix:semicolon
DECL|function|Userspace
r_int
id|Userspace
c_func
(paren
r_const
r_int
id|CPUNR
)paren
(brace
r_struct
id|http_request
op_star
id|CurrentRequest
comma
op_star
op_star
id|Prev
comma
op_star
id|Next
suffix:semicolon
id|EnterFunction
c_func
(paren
l_string|&quot;Userspace&quot;
)paren
suffix:semicolon
id|CurrentRequest
op_assign
id|threadinfo
(braket
id|CPUNR
)braket
dot
id|UserspaceQueue
suffix:semicolon
id|Prev
op_assign
op_amp
(paren
id|threadinfo
(braket
id|CPUNR
)braket
dot
id|UserspaceQueue
)paren
suffix:semicolon
r_while
c_loop
(paren
id|CurrentRequest
op_ne
l_int|NULL
)paren
(brace
multiline_comment|/* Clean-up the waitqueue of the socket.. Bad things happen if&n;&t;&t;   this is forgotten. */
r_if
c_cond
(paren
id|CurrentRequest-&gt;sock
op_ne
l_int|NULL
)paren
(brace
r_if
c_cond
(paren
(paren
id|CurrentRequest-&gt;sock
op_ne
l_int|NULL
)paren
op_logical_and
(paren
id|CurrentRequest-&gt;sock-&gt;sk
op_ne
l_int|NULL
)paren
)paren
(brace
id|remove_wait_queue
c_func
(paren
id|CurrentRequest-&gt;sock-&gt;sk-&gt;sleep
comma
op_amp
(paren
id|CurrentRequest-&gt;sleep
)paren
)paren
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|AddSocketToAcceptQueue
c_func
(paren
id|CurrentRequest-&gt;sock
comma
id|sysctl_khttpd_clientport
)paren
op_ge
l_int|0
)paren
(brace
(paren
op_star
id|Prev
)paren
op_assign
id|CurrentRequest-&gt;Next
suffix:semicolon
id|Next
op_assign
id|CurrentRequest-&gt;Next
suffix:semicolon
id|sock_release
c_func
(paren
id|CurrentRequest-&gt;sock
)paren
suffix:semicolon
id|CurrentRequest-&gt;sock
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/* We no longer own it */
id|CleanUpRequest
c_func
(paren
id|CurrentRequest
)paren
suffix:semicolon
id|CurrentRequest
op_assign
id|Next
suffix:semicolon
r_continue
suffix:semicolon
)brace
r_else
multiline_comment|/* No userspace-daemon present, or other problems with it */
(brace
(paren
op_star
id|Prev
)paren
op_assign
id|CurrentRequest-&gt;Next
suffix:semicolon
id|Next
op_assign
id|CurrentRequest-&gt;Next
suffix:semicolon
id|Send403
c_func
(paren
id|CurrentRequest-&gt;sock
)paren
suffix:semicolon
multiline_comment|/* Sorry, no go... */
id|CleanUpRequest
c_func
(paren
id|CurrentRequest
)paren
suffix:semicolon
id|CurrentRequest
op_assign
id|Next
suffix:semicolon
r_continue
suffix:semicolon
)brace
id|Prev
op_assign
op_amp
(paren
id|CurrentRequest-&gt;Next
)paren
suffix:semicolon
id|CurrentRequest
op_assign
id|CurrentRequest-&gt;Next
suffix:semicolon
)brace
id|LeaveFunction
c_func
(paren
l_string|&quot;Userspace&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|StopUserspace
r_void
id|StopUserspace
c_func
(paren
r_const
r_int
id|CPUNR
)paren
(brace
r_struct
id|http_request
op_star
id|CurrentRequest
comma
op_star
id|Next
suffix:semicolon
id|EnterFunction
c_func
(paren
l_string|&quot;StopUserspace&quot;
)paren
suffix:semicolon
id|CurrentRequest
op_assign
id|threadinfo
(braket
id|CPUNR
)braket
dot
id|UserspaceQueue
suffix:semicolon
r_while
c_loop
(paren
id|CurrentRequest
op_ne
l_int|NULL
)paren
(brace
id|Next
op_assign
id|CurrentRequest-&gt;Next
suffix:semicolon
id|CleanUpRequest
c_func
(paren
id|CurrentRequest
)paren
suffix:semicolon
id|CurrentRequest
op_assign
id|Next
suffix:semicolon
)brace
id|threadinfo
(braket
id|CPUNR
)braket
dot
id|UserspaceQueue
op_assign
l_int|NULL
suffix:semicolon
id|LeaveFunction
c_func
(paren
l_string|&quot;StopUserspace&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/* &n;   &quot;FindUserspace&quot; returns the struct sock of the userspace-daemon, so that we can&n;   &quot;drop&quot; our request in the accept-queue &n;*/
DECL|function|FindUserspace
r_static
r_struct
id|sock
op_star
id|FindUserspace
c_func
(paren
r_const
r_int
r_int
id|Port
)paren
(brace
r_struct
id|sock
op_star
id|sk
suffix:semicolon
id|EnterFunction
c_func
(paren
l_string|&quot;FindUserspace&quot;
)paren
suffix:semicolon
id|local_bh_disable
c_func
(paren
)paren
suffix:semicolon
id|sk
op_assign
id|tcp_v4_lookup_listener
c_func
(paren
id|INADDR_ANY
comma
id|Port
comma
l_int|0
)paren
suffix:semicolon
id|local_bh_enable
c_func
(paren
)paren
suffix:semicolon
r_return
id|sk
suffix:semicolon
)brace
DECL|function|dummy_destructor
r_static
r_void
id|dummy_destructor
c_func
(paren
r_struct
id|open_request
op_star
id|req
)paren
(brace
)brace
DECL|variable|Dummy
r_static
r_struct
id|or_calltable
id|Dummy
op_assign
(brace
l_int|0
comma
l_int|NULL
comma
l_int|NULL
comma
op_amp
id|dummy_destructor
comma
l_int|NULL
)brace
suffix:semicolon
DECL|function|AddSocketToAcceptQueue
r_static
r_int
id|AddSocketToAcceptQueue
c_func
(paren
r_struct
id|socket
op_star
id|sock
comma
r_const
r_int
id|Port
)paren
(brace
r_struct
id|open_request
op_star
id|req
suffix:semicolon
r_struct
id|sock
op_star
id|sk
comma
op_star
id|nsk
suffix:semicolon
id|EnterFunction
c_func
(paren
l_string|&quot;AddSocketToAcceptQueue&quot;
)paren
suffix:semicolon
id|sk
op_assign
id|FindUserspace
c_func
(paren
(paren
r_int
r_int
)paren
id|Port
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sk
op_eq
l_int|NULL
)paren
multiline_comment|/* No userspace-daemon found */
(brace
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|lock_sock
c_func
(paren
id|sk
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sk-&gt;state
op_ne
id|TCP_LISTEN
op_logical_or
id|tcp_acceptq_is_full
c_func
(paren
id|sk
)paren
)paren
(brace
id|release_sock
c_func
(paren
id|sk
)paren
suffix:semicolon
id|sock_put
c_func
(paren
id|sk
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|req
op_assign
id|tcp_openreq_alloc
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|req
op_eq
l_int|NULL
)paren
(brace
id|release_sock
c_func
(paren
id|sk
)paren
suffix:semicolon
id|sock_put
c_func
(paren
id|sk
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|nsk
op_assign
id|sock-&gt;sk
suffix:semicolon
id|sock-&gt;sk
op_assign
l_int|NULL
suffix:semicolon
id|sock-&gt;state
op_assign
id|SS_UNCONNECTED
suffix:semicolon
id|req
op_member_access_from_pointer
r_class
op_assign
op_amp
id|Dummy
suffix:semicolon
id|write_lock_bh
c_func
(paren
op_amp
id|nsk-&gt;callback_lock
)paren
suffix:semicolon
id|nsk-&gt;socket
op_assign
l_int|NULL
suffix:semicolon
id|nsk-&gt;sleep
op_assign
l_int|NULL
suffix:semicolon
id|write_unlock_bh
c_func
(paren
op_amp
id|nsk-&gt;callback_lock
)paren
suffix:semicolon
id|tcp_acceptq_queue
c_func
(paren
id|sk
comma
id|req
comma
id|nsk
)paren
suffix:semicolon
id|sk
op_member_access_from_pointer
id|data_ready
c_func
(paren
id|sk
comma
l_int|0
)paren
suffix:semicolon
id|release_sock
c_func
(paren
id|sk
)paren
suffix:semicolon
id|sock_put
c_func
(paren
id|sk
)paren
suffix:semicolon
id|LeaveFunction
c_func
(paren
l_string|&quot;AddSocketToAcceptQueue&quot;
)paren
suffix:semicolon
r_return
op_plus
l_int|1
suffix:semicolon
)brace
DECL|function|InitUserspace
r_void
id|InitUserspace
c_func
(paren
r_const
r_int
id|CPUNR
)paren
(brace
)brace
eof
