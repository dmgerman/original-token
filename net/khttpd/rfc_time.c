multiline_comment|/*&n;&n;Functions related to time:&n;&n;1) rfc (string) time to unix-time&n;2) unix-time to rfc (string) time&n;3) current time to rfc (string) time for the &quot;Date:&quot; header&n;&n;*/
multiline_comment|/****************************************************************&n; *&t;This program is free software; you can redistribute it and/or modify&n; *&t;it under the terms of the GNU General Public License as published by&n; *&t;the Free Software Foundation; either version 2, or (at your option)&n; *&t;any later version.&n; *&n; *&t;This program is distributed in the hope that it will be useful,&n; *&t;but WITHOUT ANY WARRANTY; without even the implied warranty of&n; *&t;MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the&n; *&t;GNU General Public License for more details.&n; *&n; *&t;You should have received a copy of the GNU General Public License&n; *&t;along with this program; if not, write to the Free Software&n; *&t;Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.&n; *&n; ****************************************************************/
macro_line|#include &lt;linux/time.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/malloc.h&gt;
macro_line|#include &lt;linux/ctype.h&gt;
macro_line|#include &quot;times.h&quot;
macro_line|#include &quot;prototypes.h&quot;
DECL|variable|dayName
r_static
r_char
op_star
id|dayName
(braket
l_int|7
)braket
op_assign
(brace
l_string|&quot;Sun&quot;
comma
l_string|&quot;Mon&quot;
comma
l_string|&quot;Tue&quot;
comma
l_string|&quot;Wed&quot;
comma
l_string|&quot;Thu&quot;
comma
l_string|&quot;Fri&quot;
comma
l_string|&quot;Sat&quot;
)brace
suffix:semicolon
DECL|variable|monthName
r_static
r_char
op_star
id|monthName
(braket
l_int|12
)braket
op_assign
(brace
l_string|&quot;Jan&quot;
comma
l_string|&quot;Feb&quot;
comma
l_string|&quot;Mar&quot;
comma
l_string|&quot;Apr&quot;
comma
l_string|&quot;May&quot;
comma
l_string|&quot;Jun&quot;
comma
l_string|&quot;Jul&quot;
comma
l_string|&quot;Aug&quot;
comma
l_string|&quot;Sep&quot;
comma
l_string|&quot;Oct&quot;
comma
l_string|&quot;Nov&quot;
comma
l_string|&quot;Dec&quot;
)brace
suffix:semicolon
DECL|variable|CurrentTime
r_char
id|CurrentTime
(braket
l_int|64
)braket
suffix:semicolon
DECL|variable|CurrentTime_i
r_int
id|CurrentTime_i
suffix:semicolon
DECL|variable|itoa_h
r_static
r_char
id|itoa_h
(braket
l_int|60
)braket
op_assign
initialization_block
suffix:semicolon
DECL|variable|itoa_l
r_static
r_char
id|itoa_l
(braket
l_int|60
)braket
op_assign
initialization_block
suffix:semicolon
DECL|function|time_Unix2RFC
r_void
id|time_Unix2RFC
c_func
(paren
r_const
id|time_t
id|Zulu
comma
r_char
op_star
id|Buffer
)paren
(brace
r_int
id|Y
op_assign
l_int|0
comma
id|M
op_assign
l_int|0
comma
id|D
op_assign
l_int|0
suffix:semicolon
r_int
id|H
op_assign
l_int|0
comma
id|Min
op_assign
l_int|0
comma
id|S
op_assign
l_int|0
comma
id|WD
op_assign
l_int|0
suffix:semicolon
r_int
id|I
comma
id|I2
suffix:semicolon
id|time_t
id|rest
suffix:semicolon
id|I
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
id|I
OL
id|KHTTPD_NUMYEARS
)paren
(brace
r_if
c_cond
(paren
id|TimeDays
(braket
id|I
)braket
(braket
l_int|0
)braket
OG
id|Zulu
)paren
r_break
suffix:semicolon
id|I
op_increment
suffix:semicolon
)brace
id|Y
op_assign
op_decrement
id|I
suffix:semicolon
r_if
c_cond
(paren
id|I
OL
l_int|0
)paren
(brace
id|Y
op_assign
l_int|0
suffix:semicolon
r_goto
id|BuildYear
suffix:semicolon
)brace
id|I2
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
id|I2
op_le
l_int|12
)paren
(brace
r_if
c_cond
(paren
id|TimeDays
(braket
id|I
)braket
(braket
id|I2
)braket
OG
id|Zulu
)paren
r_break
suffix:semicolon
id|I2
op_increment
suffix:semicolon
)brace
id|M
op_assign
id|I2
op_minus
l_int|1
suffix:semicolon
id|rest
op_assign
id|Zulu
op_minus
id|TimeDays
(braket
id|Y
)braket
(braket
id|M
)braket
suffix:semicolon
id|WD
op_assign
id|WeekDays
(braket
id|Y
)braket
(braket
id|M
)braket
suffix:semicolon
id|D
op_assign
id|rest
op_div
l_int|86400
suffix:semicolon
id|rest
op_assign
id|rest
op_mod
l_int|86400
suffix:semicolon
id|WD
op_add_assign
id|D
suffix:semicolon
id|WD
op_assign
id|WD
op_mod
l_int|7
suffix:semicolon
id|H
op_assign
id|rest
op_div
l_int|3600
suffix:semicolon
id|rest
op_assign
id|rest
op_mod
l_int|3600
suffix:semicolon
id|Min
op_assign
id|rest
op_div
l_int|60
suffix:semicolon
id|rest
op_assign
id|rest
op_mod
l_int|60
suffix:semicolon
id|S
op_assign
id|rest
suffix:semicolon
id|BuildYear
suffix:colon
id|Y
op_add_assign
id|KHTTPD_YEAROFFSET
suffix:semicolon
multiline_comment|/* Format:  Day, 01 Mon 1999 01:01:01 GMT */
multiline_comment|/*&t;&n;&t;We want to do &n;&t;&n;&t;sprintf( Buffer, &quot;%s, %02i %s %04i %02i:%02i:%02i GMT&quot;,&n;&t;&t;dayName[ WD ], D+1, monthName[ M ], Y,&n;&t;&t;H, Min, S&n;&t;);&n;&t;&n;&t;but this is very expensive. Since the string is fixed length,&n;&t;it is filled manually.&n;*/
id|Buffer
(braket
l_int|0
)braket
op_assign
id|dayName
(braket
id|WD
)braket
(braket
l_int|0
)braket
suffix:semicolon
id|Buffer
(braket
l_int|1
)braket
op_assign
id|dayName
(braket
id|WD
)braket
(braket
l_int|1
)braket
suffix:semicolon
id|Buffer
(braket
l_int|2
)braket
op_assign
id|dayName
(braket
id|WD
)braket
(braket
l_int|2
)braket
suffix:semicolon
id|Buffer
(braket
l_int|3
)braket
op_assign
l_char|&squot;,&squot;
suffix:semicolon
id|Buffer
(braket
l_int|4
)braket
op_assign
l_char|&squot; &squot;
suffix:semicolon
id|Buffer
(braket
l_int|5
)braket
op_assign
id|itoa_h
(braket
id|D
op_plus
l_int|1
)braket
suffix:semicolon
id|Buffer
(braket
l_int|6
)braket
op_assign
id|itoa_l
(braket
id|D
op_plus
l_int|1
)braket
suffix:semicolon
id|Buffer
(braket
l_int|7
)braket
op_assign
l_char|&squot; &squot;
suffix:semicolon
id|Buffer
(braket
l_int|8
)braket
op_assign
id|monthName
(braket
id|M
)braket
(braket
l_int|0
)braket
suffix:semicolon
id|Buffer
(braket
l_int|9
)braket
op_assign
id|monthName
(braket
id|M
)braket
(braket
l_int|1
)braket
suffix:semicolon
id|Buffer
(braket
l_int|10
)braket
op_assign
id|monthName
(braket
id|M
)braket
(braket
l_int|2
)braket
suffix:semicolon
id|Buffer
(braket
l_int|11
)braket
op_assign
l_char|&squot; &squot;
suffix:semicolon
id|Buffer
(braket
l_int|12
)braket
op_assign
id|itoa_l
(braket
id|Y
op_div
l_int|1000
)braket
suffix:semicolon
id|Buffer
(braket
l_int|13
)braket
op_assign
id|itoa_l
(braket
(paren
id|Y
op_div
l_int|100
)paren
op_mod
l_int|10
)braket
suffix:semicolon
id|Buffer
(braket
l_int|14
)braket
op_assign
id|itoa_l
(braket
(paren
id|Y
op_div
l_int|10
)paren
op_mod
l_int|10
)braket
suffix:semicolon
id|Buffer
(braket
l_int|15
)braket
op_assign
id|itoa_l
(braket
id|Y
op_mod
l_int|10
)braket
suffix:semicolon
id|Buffer
(braket
l_int|16
)braket
op_assign
l_char|&squot; &squot;
suffix:semicolon
id|Buffer
(braket
l_int|17
)braket
op_assign
id|itoa_h
(braket
id|H
)braket
suffix:semicolon
id|Buffer
(braket
l_int|18
)braket
op_assign
id|itoa_l
(braket
id|H
)braket
suffix:semicolon
id|Buffer
(braket
l_int|19
)braket
op_assign
l_char|&squot;:&squot;
suffix:semicolon
id|Buffer
(braket
l_int|20
)braket
op_assign
id|itoa_h
(braket
id|Min
)braket
suffix:semicolon
id|Buffer
(braket
l_int|21
)braket
op_assign
id|itoa_l
(braket
id|Min
)braket
suffix:semicolon
id|Buffer
(braket
l_int|22
)braket
op_assign
l_char|&squot;:&squot;
suffix:semicolon
id|Buffer
(braket
l_int|23
)braket
op_assign
id|itoa_h
(braket
id|S
)braket
suffix:semicolon
id|Buffer
(braket
l_int|24
)braket
op_assign
id|itoa_l
(braket
id|S
)braket
suffix:semicolon
id|Buffer
(braket
l_int|25
)braket
op_assign
l_char|&squot; &squot;
suffix:semicolon
id|Buffer
(braket
l_int|26
)braket
op_assign
l_char|&squot;G&squot;
suffix:semicolon
id|Buffer
(braket
l_int|27
)braket
op_assign
l_char|&squot;M&squot;
suffix:semicolon
id|Buffer
(braket
l_int|28
)braket
op_assign
l_char|&squot;T&squot;
suffix:semicolon
id|Buffer
(braket
l_int|29
)braket
op_assign
l_int|0
suffix:semicolon
)brace
DECL|function|UpdateCurrentDate
r_void
id|UpdateCurrentDate
c_func
(paren
r_void
)paren
(brace
r_struct
id|timeval
id|tv
suffix:semicolon
id|do_gettimeofday
c_func
(paren
op_amp
id|tv
)paren
suffix:semicolon
r_if
c_cond
(paren
id|CurrentTime_i
op_ne
id|tv.tv_sec
)paren
id|time_Unix2RFC
c_func
(paren
id|tv.tv_sec
comma
id|CurrentTime
)paren
suffix:semicolon
id|CurrentTime_i
op_assign
id|tv.tv_sec
suffix:semicolon
)brace
DECL|variable|MonthHash
r_static
r_int
id|MonthHash
(braket
l_int|32
)braket
op_assign
(brace
l_int|0
comma
l_int|0
comma
l_int|7
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|3
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|2
comma
l_int|6
comma
l_int|0
comma
l_int|5
comma
l_int|0
comma
l_int|9
comma
l_int|8
comma
l_int|4
comma
l_int|0
comma
l_int|0
comma
l_int|11
comma
l_int|1
comma
l_int|10
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
)brace
suffix:semicolon
DECL|macro|is_digit
mdefine_line|#define is_digit(c)&t;((c) &gt;= &squot;0&squot; &amp;&amp; (c) &lt;= &squot;9&squot;)
DECL|function|skip_atoi
id|__inline
r_static
r_int
id|skip_atoi
c_func
(paren
r_char
op_star
op_star
id|s
)paren
(brace
r_int
id|i
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
id|is_digit
c_func
(paren
op_star
op_star
id|s
)paren
)paren
id|i
op_assign
id|i
op_star
l_int|10
op_plus
op_star
(paren
(paren
op_star
id|s
)paren
op_increment
)paren
op_minus
l_char|&squot;0&squot;
suffix:semicolon
r_return
id|i
suffix:semicolon
)brace
DECL|function|mimeTime_to_UnixTime
id|time_t
id|mimeTime_to_UnixTime
c_func
(paren
r_char
op_star
id|Q
)paren
(brace
r_int
id|Y
comma
id|M
comma
id|D
comma
id|H
comma
id|Min
comma
id|S
suffix:semicolon
r_int
r_int
id|Hash
suffix:semicolon
id|time_t
id|Temp
suffix:semicolon
r_char
op_star
id|s
comma
op_star
op_star
id|s2
suffix:semicolon
id|s
op_assign
id|Q
suffix:semicolon
id|s2
op_assign
op_amp
id|s
suffix:semicolon
r_if
c_cond
(paren
id|strlen
c_func
(paren
id|s
)paren
OL
l_int|30
)paren
r_return
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|s
(braket
l_int|3
)braket
op_ne
l_char|&squot;,&squot;
)paren
r_return
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|s
(braket
l_int|19
)braket
op_ne
l_char|&squot;:&squot;
)paren
r_return
l_int|0
suffix:semicolon
id|s
op_add_assign
l_int|5
suffix:semicolon
multiline_comment|/* Skip day of week */
id|D
op_assign
id|skip_atoi
c_func
(paren
id|s2
)paren
suffix:semicolon
multiline_comment|/*  Day of month */
id|s
op_increment
suffix:semicolon
id|Hash
op_assign
(paren
r_int
r_char
)paren
id|s
(braket
l_int|0
)braket
op_plus
(paren
r_int
r_char
)paren
id|s
(braket
l_int|2
)braket
suffix:semicolon
id|Hash
op_assign
(paren
id|Hash
op_lshift
l_int|1
)paren
op_plus
(paren
r_int
r_char
)paren
id|s
(braket
l_int|1
)braket
suffix:semicolon
id|Hash
op_assign
(paren
id|Hash
op_amp
l_int|63
)paren
op_rshift
l_int|1
suffix:semicolon
id|M
op_assign
id|MonthHash
(braket
id|Hash
)braket
suffix:semicolon
id|s
op_add_assign
l_int|4
suffix:semicolon
id|Y
op_assign
id|skip_atoi
c_func
(paren
id|s2
)paren
suffix:semicolon
multiline_comment|/* Year */
id|s
op_increment
suffix:semicolon
id|H
op_assign
id|skip_atoi
c_func
(paren
id|s2
)paren
suffix:semicolon
multiline_comment|/* Hour */
id|s
op_increment
suffix:semicolon
id|Min
op_assign
id|skip_atoi
c_func
(paren
id|s2
)paren
suffix:semicolon
multiline_comment|/* Minutes */
id|s
op_increment
suffix:semicolon
id|S
op_assign
id|skip_atoi
c_func
(paren
id|s2
)paren
suffix:semicolon
multiline_comment|/* Seconds */
id|s
op_increment
suffix:semicolon
r_if
c_cond
(paren
(paren
id|s
(braket
l_int|0
)braket
op_ne
l_char|&squot;G&squot;
)paren
op_logical_or
(paren
id|s
(braket
l_int|1
)braket
op_ne
l_char|&squot;M&squot;
)paren
op_logical_or
(paren
id|s
(braket
l_int|2
)braket
op_ne
l_char|&squot;T&squot;
)paren
)paren
(brace
r_return
l_int|0
suffix:semicolon
multiline_comment|/* No GMT */
)brace
r_if
c_cond
(paren
id|Y
OL
id|KHTTPD_YEAROFFSET
)paren
id|Y
op_assign
id|KHTTPD_YEAROFFSET
suffix:semicolon
r_if
c_cond
(paren
id|Y
OG
id|KHTTPD_YEAROFFSET
op_plus
l_int|9
)paren
id|Y
op_assign
id|KHTTPD_YEAROFFSET
op_plus
l_int|9
suffix:semicolon
id|Temp
op_assign
id|TimeDays
(braket
id|Y
op_minus
id|KHTTPD_YEAROFFSET
)braket
(braket
id|M
)braket
suffix:semicolon
id|Temp
op_add_assign
id|D
op_star
l_int|86400
op_plus
id|H
op_star
l_int|3600
op_plus
id|Min
op_star
l_int|60
op_plus
id|S
suffix:semicolon
r_return
id|Temp
suffix:semicolon
)brace
eof
