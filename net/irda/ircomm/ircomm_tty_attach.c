multiline_comment|/*********************************************************************&n; *                &n; * Filename:      ircomm_tty_attach.c&n; * Version:       &n; * Description:   Code for attaching the serial driver to IrCOMM&n; * Status:        Experimental.&n; * Author:        Dag Brattli &lt;dagb@cs.uit.no&gt;&n; * Created at:    Sat Jun  5 17:42:00 1999&n; * Modified at:   Tue Jan  4 14:20:49 2000&n; * Modified by:   Dag Brattli &lt;dagb@cs.uit.no&gt;&n; * &n; *     Copyright (c) 1999-2000 Dag Brattli, All Rights Reserved.&n; *     &n; *     This program is free software; you can redistribute it and/or &n; *     modify it under the terms of the GNU General Public License as &n; *     published by the Free Software Foundation; either version 2 of &n; *     the License, or (at your option) any later version.&n; * &n; *     This program is distributed in the hope that it will be useful,&n; *     but WITHOUT ANY WARRANTY; without even the implied warranty of&n; *     MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the&n; *     GNU General Public License for more details.&n; * &n; *     You should have received a copy of the GNU General Public License &n; *     along with this program; if not, write to the Free Software &n; *     Foundation, Inc., 59 Temple Place, Suite 330, Boston, &n; *     MA 02111-1307 USA&n; *     &n; ********************************************************************/
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;net/irda/irda.h&gt;
macro_line|#include &lt;net/irda/irlmp.h&gt;
macro_line|#include &lt;net/irda/iriap.h&gt;
macro_line|#include &lt;net/irda/irttp.h&gt;
macro_line|#include &lt;net/irda/irias_object.h&gt;
macro_line|#include &lt;net/irda/parameters.h&gt;
macro_line|#include &lt;net/irda/ircomm_core.h&gt;
macro_line|#include &lt;net/irda/ircomm_param.h&gt;
macro_line|#include &lt;net/irda/ircomm_event.h&gt;
macro_line|#include &lt;net/irda/ircomm_tty.h&gt;
macro_line|#include &lt;net/irda/ircomm_tty_attach.h&gt;
r_static
r_void
id|ircomm_tty_ias_register
c_func
(paren
r_struct
id|ircomm_tty_cb
op_star
id|self
)paren
suffix:semicolon
r_static
r_void
id|ircomm_tty_discovery_indication
c_func
(paren
id|discovery_t
op_star
id|discovery
comma
r_void
op_star
id|priv
)paren
suffix:semicolon
r_static
r_void
id|ircomm_tty_getvalue_confirm
c_func
(paren
r_int
id|result
comma
id|__u16
id|obj_id
comma
r_struct
id|ias_value
op_star
id|value
comma
r_void
op_star
id|priv
)paren
suffix:semicolon
r_void
id|ircomm_tty_start_watchdog_timer
c_func
(paren
r_struct
id|ircomm_tty_cb
op_star
id|self
comma
r_int
id|timeout
)paren
suffix:semicolon
r_void
id|ircomm_tty_watchdog_timer_expired
c_func
(paren
r_void
op_star
id|data
)paren
suffix:semicolon
r_static
r_int
id|ircomm_tty_state_idle
c_func
(paren
r_struct
id|ircomm_tty_cb
op_star
id|self
comma
id|IRCOMM_TTY_EVENT
id|event
comma
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|ircomm_tty_info
op_star
id|info
)paren
suffix:semicolon
r_static
r_int
id|ircomm_tty_state_search
c_func
(paren
r_struct
id|ircomm_tty_cb
op_star
id|self
comma
id|IRCOMM_TTY_EVENT
id|event
comma
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|ircomm_tty_info
op_star
id|info
)paren
suffix:semicolon
r_static
r_int
id|ircomm_tty_state_query_parameters
c_func
(paren
r_struct
id|ircomm_tty_cb
op_star
id|self
comma
id|IRCOMM_TTY_EVENT
id|event
comma
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|ircomm_tty_info
op_star
id|info
)paren
suffix:semicolon
r_static
r_int
id|ircomm_tty_state_query_lsap_sel
c_func
(paren
r_struct
id|ircomm_tty_cb
op_star
id|self
comma
id|IRCOMM_TTY_EVENT
id|event
comma
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|ircomm_tty_info
op_star
id|info
)paren
suffix:semicolon
r_static
r_int
id|ircomm_tty_state_setup
c_func
(paren
r_struct
id|ircomm_tty_cb
op_star
id|self
comma
id|IRCOMM_TTY_EVENT
id|event
comma
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|ircomm_tty_info
op_star
id|info
)paren
suffix:semicolon
r_static
r_int
id|ircomm_tty_state_ready
c_func
(paren
r_struct
id|ircomm_tty_cb
op_star
id|self
comma
id|IRCOMM_TTY_EVENT
id|event
comma
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|ircomm_tty_info
op_star
id|info
)paren
suffix:semicolon
DECL|variable|ircomm_tty_state
r_char
op_star
id|ircomm_tty_state
(braket
)braket
op_assign
(brace
l_string|&quot;IRCOMM_TTY_IDLE&quot;
comma
l_string|&quot;IRCOMM_TTY_SEARCH&quot;
comma
l_string|&quot;IRCOMM_TTY_QUERY_PARAMETERS&quot;
comma
l_string|&quot;IRCOMM_TTY_QUERY_LSAP_SEL&quot;
comma
l_string|&quot;IRCOMM_TTY_SETUP&quot;
comma
l_string|&quot;IRCOMM_TTY_READY&quot;
comma
l_string|&quot;*** ERROR *** &quot;
comma
)brace
suffix:semicolon
DECL|variable|ircomm_tty_event
r_char
op_star
id|ircomm_tty_event
(braket
)braket
op_assign
(brace
l_string|&quot;IRCOMM_TTY_ATTACH_CABLE&quot;
comma
l_string|&quot;IRCOMM_TTY_DETACH_CABLE&quot;
comma
l_string|&quot;IRCOMM_TTY_DATA_REQUEST&quot;
comma
l_string|&quot;IRCOMM_TTY_DATA_INDICATION&quot;
comma
l_string|&quot;IRCOMM_TTY_DISCOVERY_REQUEST&quot;
comma
l_string|&quot;IRCOMM_TTY_DISCOVERY_INDICATION&quot;
comma
l_string|&quot;IRCOMM_TTY_CONNECT_CONFIRM&quot;
comma
l_string|&quot;IRCOMM_TTY_CONNECT_INDICATION&quot;
comma
l_string|&quot;IRCOMM_TTY_DISCONNECT_REQUEST&quot;
comma
l_string|&quot;IRCOMM_TTY_DISCONNECT_INDICATION&quot;
comma
l_string|&quot;IRCOMM_TTY_WD_TIMER_EXPIRED&quot;
comma
l_string|&quot;IRCOMM_TTY_GOT_PARAMETERS&quot;
comma
l_string|&quot;IRCOMM_TTY_GOT_LSAPSEL&quot;
comma
l_string|&quot;*** ERROR ****&quot;
comma
)brace
suffix:semicolon
DECL|variable|state
r_static
r_int
(paren
op_star
id|state
(braket
)braket
)paren
(paren
r_struct
id|ircomm_tty_cb
op_star
id|self
comma
id|IRCOMM_TTY_EVENT
id|event
comma
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|ircomm_tty_info
op_star
id|info
)paren
op_assign
(brace
id|ircomm_tty_state_idle
comma
id|ircomm_tty_state_search
comma
id|ircomm_tty_state_query_parameters
comma
id|ircomm_tty_state_query_lsap_sel
comma
id|ircomm_tty_state_setup
comma
id|ircomm_tty_state_ready
comma
)brace
suffix:semicolon
multiline_comment|/*&n; * Function ircomm_tty_attach_cable (driver)&n; *&n; *    Try to attach cable (IrCOMM link). This function will only return&n; *    when the link has been connected, or if an error condition occurs. &n; *    If success, the return value is the resulting service type.&n; */
DECL|function|ircomm_tty_attach_cable
r_int
id|ircomm_tty_attach_cable
c_func
(paren
r_struct
id|ircomm_tty_cb
op_star
id|self
)paren
(brace
id|IRDA_DEBUG
c_func
(paren
l_int|0
comma
id|__FUNCTION__
l_string|&quot;()&bslash;n&quot;
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|self
op_ne
l_int|NULL
comma
r_return
op_minus
l_int|1
suffix:semicolon
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|self-&gt;magic
op_eq
id|IRCOMM_TTY_MAGIC
comma
r_return
op_minus
l_int|1
suffix:semicolon
)paren
suffix:semicolon
multiline_comment|/* Check if somebody has already connected to us */
r_if
c_cond
(paren
id|ircomm_is_connected
c_func
(paren
id|self-&gt;ircomm
)paren
)paren
(brace
id|IRDA_DEBUG
c_func
(paren
l_int|0
comma
id|__FUNCTION__
l_string|&quot;(), already connected!&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Make sure nobody tries to write before the link is up */
id|self-&gt;tty-&gt;hw_stopped
op_assign
l_int|1
suffix:semicolon
id|ircomm_tty_ias_register
c_func
(paren
id|self
)paren
suffix:semicolon
multiline_comment|/* Check if somebody has already connected to us */
r_if
c_cond
(paren
id|ircomm_is_connected
c_func
(paren
id|self-&gt;ircomm
)paren
)paren
(brace
id|IRDA_DEBUG
c_func
(paren
l_int|0
comma
id|__FUNCTION__
l_string|&quot;(), already connected!&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|ircomm_tty_do_event
c_func
(paren
id|self
comma
id|IRCOMM_TTY_ATTACH_CABLE
comma
l_int|NULL
comma
l_int|NULL
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * Function ircomm_detach_cable (driver)&n; *&n; *    Detach cable, or cable has been detached by peer&n; *&n; */
DECL|function|ircomm_tty_detach_cable
r_void
id|ircomm_tty_detach_cable
c_func
(paren
r_struct
id|ircomm_tty_cb
op_star
id|self
)paren
(brace
id|IRDA_DEBUG
c_func
(paren
l_int|0
comma
id|__FUNCTION__
l_string|&quot;()&bslash;n&quot;
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|self
op_ne
l_int|NULL
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|self-&gt;magic
op_eq
id|IRCOMM_TTY_MAGIC
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
id|del_timer
c_func
(paren
op_amp
id|self-&gt;watchdog_timer
)paren
suffix:semicolon
multiline_comment|/* Remove IrCOMM hint bits */
id|irlmp_unregister_client
c_func
(paren
id|self-&gt;ckey
)paren
suffix:semicolon
id|irlmp_unregister_service
c_func
(paren
id|self-&gt;skey
)paren
suffix:semicolon
r_if
c_cond
(paren
id|self-&gt;iriap
)paren
(brace
id|iriap_close
c_func
(paren
id|self-&gt;iriap
)paren
suffix:semicolon
id|self-&gt;iriap
op_assign
l_int|NULL
suffix:semicolon
)brace
multiline_comment|/* Remove LM-IAS object */
r_if
c_cond
(paren
id|self-&gt;obj
)paren
(brace
id|irias_delete_object
c_func
(paren
id|self-&gt;obj
)paren
suffix:semicolon
id|self-&gt;obj
op_assign
l_int|NULL
suffix:semicolon
)brace
id|ircomm_tty_do_event
c_func
(paren
id|self
comma
id|IRCOMM_TTY_DETACH_CABLE
comma
l_int|NULL
comma
l_int|NULL
)paren
suffix:semicolon
multiline_comment|/* Reset some values */
id|self-&gt;daddr
op_assign
id|self-&gt;saddr
op_assign
l_int|0
suffix:semicolon
id|self-&gt;dlsap_sel
op_assign
id|self-&gt;slsap_sel
op_assign
l_int|0
suffix:semicolon
id|memset
c_func
(paren
op_amp
id|self-&gt;settings
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|ircomm_params
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Function ircomm_tty_ias_register (self)&n; *&n; *    Register with LM-IAS depending on which service type we are&n; *&n; */
DECL|function|ircomm_tty_ias_register
r_static
r_void
id|ircomm_tty_ias_register
c_func
(paren
r_struct
id|ircomm_tty_cb
op_star
id|self
)paren
(brace
id|__u8
id|oct_seq
(braket
l_int|6
)braket
suffix:semicolon
id|__u16
id|hints
suffix:semicolon
id|IRDA_DEBUG
c_func
(paren
l_int|0
comma
id|__FUNCTION__
l_string|&quot;()&bslash;n&quot;
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|self
op_ne
l_int|NULL
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|self-&gt;magic
op_eq
id|IRCOMM_TTY_MAGIC
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
r_if
c_cond
(paren
id|self-&gt;service_type
op_amp
id|IRCOMM_3_WIRE_RAW
)paren
(brace
id|hints
op_assign
id|irlmp_service_to_hint
c_func
(paren
id|S_PRINTER
)paren
suffix:semicolon
id|hints
op_or_assign
id|irlmp_service_to_hint
c_func
(paren
id|S_COMM
)paren
suffix:semicolon
multiline_comment|/* Register IrLPT with LM-IAS */
id|self-&gt;obj
op_assign
id|irias_new_object
c_func
(paren
l_string|&quot;IrLPT&quot;
comma
id|IAS_IRLPT_ID
)paren
suffix:semicolon
id|irias_add_integer_attrib
c_func
(paren
id|self-&gt;obj
comma
l_string|&quot;IrDA:IrLMP:LsapSel&quot;
comma
id|self-&gt;slsap_sel
comma
id|IAS_KERNEL_ATTR
)paren
suffix:semicolon
id|irias_insert_object
c_func
(paren
id|self-&gt;obj
)paren
suffix:semicolon
)brace
r_else
(brace
id|hints
op_assign
id|irlmp_service_to_hint
c_func
(paren
id|S_COMM
)paren
suffix:semicolon
multiline_comment|/* Register IrCOMM with LM-IAS */
id|self-&gt;obj
op_assign
id|irias_new_object
c_func
(paren
l_string|&quot;IrDA:IrCOMM&quot;
comma
id|IAS_IRCOMM_ID
)paren
suffix:semicolon
id|irias_add_integer_attrib
c_func
(paren
id|self-&gt;obj
comma
l_string|&quot;IrDA:TinyTP:LsapSel&quot;
comma
id|self-&gt;slsap_sel
comma
id|IAS_KERNEL_ATTR
)paren
suffix:semicolon
multiline_comment|/* Code the parameters into the buffer */
id|irda_param_pack
c_func
(paren
id|oct_seq
comma
l_string|&quot;bbbbbb&quot;
comma
id|IRCOMM_SERVICE_TYPE
comma
l_int|1
comma
id|self-&gt;service_type
comma
id|IRCOMM_PORT_TYPE
comma
l_int|1
comma
id|IRCOMM_SERIAL
)paren
suffix:semicolon
multiline_comment|/* Register parameters with LM-IAS */
id|irias_add_octseq_attrib
c_func
(paren
id|self-&gt;obj
comma
l_string|&quot;Parameters&quot;
comma
id|oct_seq
comma
l_int|6
comma
id|IAS_KERNEL_ATTR
)paren
suffix:semicolon
id|irias_insert_object
c_func
(paren
id|self-&gt;obj
)paren
suffix:semicolon
)brace
id|self-&gt;skey
op_assign
id|irlmp_register_service
c_func
(paren
id|hints
)paren
suffix:semicolon
id|self-&gt;ckey
op_assign
id|irlmp_register_client
c_func
(paren
id|hints
comma
id|ircomm_tty_discovery_indication
comma
l_int|NULL
comma
(paren
r_void
op_star
)paren
id|self
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Function ircomm_send_initial_parameters (self)&n; *&n; *    Send initial parameters to the remote IrCOMM device. These parameters&n; *    must be sent before any data.&n; */
DECL|function|ircomm_tty_send_initial_parameters
r_int
id|ircomm_tty_send_initial_parameters
c_func
(paren
r_struct
id|ircomm_tty_cb
op_star
id|self
)paren
(brace
id|ASSERT
c_func
(paren
id|self
op_ne
l_int|NULL
comma
r_return
op_minus
l_int|1
suffix:semicolon
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|self-&gt;magic
op_eq
id|IRCOMM_TTY_MAGIC
comma
r_return
op_minus
l_int|1
suffix:semicolon
)paren
suffix:semicolon
r_if
c_cond
(paren
id|self-&gt;service_type
op_amp
id|IRCOMM_3_WIRE_RAW
)paren
r_return
l_int|0
suffix:semicolon
multiline_comment|/* &n;&t; * Set default values, but only if the application for some reason &n;&t; * haven&squot;t set them already&n;&t; */
id|IRDA_DEBUG
c_func
(paren
l_int|2
comma
id|__FUNCTION__
l_string|&quot;(), data-rate = %d&bslash;n&quot;
comma
id|self-&gt;settings.data_rate
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|self-&gt;settings.data_rate
)paren
id|self-&gt;settings.data_rate
op_assign
l_int|9600
suffix:semicolon
id|IRDA_DEBUG
c_func
(paren
l_int|2
comma
id|__FUNCTION__
l_string|&quot;(), data-format = %d&bslash;n&quot;
comma
id|self-&gt;settings.data_format
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|self-&gt;settings.data_format
)paren
id|self-&gt;settings.data_format
op_assign
id|IRCOMM_WSIZE_8
suffix:semicolon
multiline_comment|/* 8N1 */
id|IRDA_DEBUG
c_func
(paren
l_int|2
comma
id|__FUNCTION__
l_string|&quot;(), flow-control = %d&bslash;n&quot;
comma
id|self-&gt;settings.flow_control
)paren
suffix:semicolon
multiline_comment|/*self-&gt;settings.flow_control = IRCOMM_RTS_CTS_IN|IRCOMM_RTS_CTS_OUT;*/
multiline_comment|/* Do not set delta values for the initial parameters */
id|self-&gt;settings.dte
op_assign
id|IRCOMM_DTR
op_or
id|IRCOMM_RTS
suffix:semicolon
multiline_comment|/* Only send service type parameter when we are the client */
r_if
c_cond
(paren
id|self-&gt;client
)paren
id|ircomm_param_request
c_func
(paren
id|self
comma
id|IRCOMM_SERVICE_TYPE
comma
id|FALSE
)paren
suffix:semicolon
id|ircomm_param_request
c_func
(paren
id|self
comma
id|IRCOMM_DATA_RATE
comma
id|FALSE
)paren
suffix:semicolon
id|ircomm_param_request
c_func
(paren
id|self
comma
id|IRCOMM_DATA_FORMAT
comma
id|FALSE
)paren
suffix:semicolon
multiline_comment|/* For a 3 wire service, we just flush the last parameter and return */
r_if
c_cond
(paren
id|self-&gt;settings.service_type
op_eq
id|IRCOMM_3_WIRE
)paren
(brace
id|ircomm_param_request
c_func
(paren
id|self
comma
id|IRCOMM_FLOW_CONTROL
comma
id|TRUE
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Only 9-wire service types continue here */
id|ircomm_param_request
c_func
(paren
id|self
comma
id|IRCOMM_FLOW_CONTROL
comma
id|FALSE
)paren
suffix:semicolon
macro_line|#if 0
id|ircomm_param_request
c_func
(paren
id|self
comma
id|IRCOMM_XON_XOFF
comma
id|FALSE
)paren
suffix:semicolon
id|ircomm_param_request
c_func
(paren
id|self
comma
id|IRCOMM_ENQ_ACK
comma
id|FALSE
)paren
suffix:semicolon
macro_line|#endif&t;
multiline_comment|/* Notify peer that we are ready to receive data */
id|ircomm_param_request
c_func
(paren
id|self
comma
id|IRCOMM_DTE
comma
id|TRUE
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * Function ircomm_tty_discovery_indication (discovery)&n; *&n; *    Remote device is discovered, try query the remote IAS to see which&n; *    device it is, and which services it has.&n; *&n; */
DECL|function|ircomm_tty_discovery_indication
r_static
r_void
id|ircomm_tty_discovery_indication
c_func
(paren
id|discovery_t
op_star
id|discovery
comma
r_void
op_star
id|priv
)paren
(brace
r_struct
id|ircomm_tty_cb
op_star
id|self
suffix:semicolon
r_struct
id|ircomm_tty_info
id|info
suffix:semicolon
id|IRDA_DEBUG
c_func
(paren
l_int|2
comma
id|__FUNCTION__
l_string|&quot;()&bslash;n&quot;
)paren
suffix:semicolon
id|info.daddr
op_assign
id|discovery-&gt;daddr
suffix:semicolon
id|info.saddr
op_assign
id|discovery-&gt;saddr
suffix:semicolon
id|self
op_assign
(paren
r_struct
id|ircomm_tty_cb
op_star
)paren
id|hashbin_get_first
c_func
(paren
id|ircomm_tty
)paren
suffix:semicolon
r_while
c_loop
(paren
id|self
op_ne
l_int|NULL
)paren
(brace
id|ASSERT
c_func
(paren
id|self-&gt;magic
op_eq
id|IRCOMM_TTY_MAGIC
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
id|ircomm_tty_do_event
c_func
(paren
id|self
comma
id|IRCOMM_TTY_DISCOVERY_INDICATION
comma
l_int|NULL
comma
op_amp
id|info
)paren
suffix:semicolon
id|self
op_assign
(paren
r_struct
id|ircomm_tty_cb
op_star
)paren
id|hashbin_get_next
c_func
(paren
id|ircomm_tty
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/*&n; * Function ircomm_tty_disconnect_indication (instance, sap, reason, skb)&n; *&n; *    Link disconnected&n; *&n; */
DECL|function|ircomm_tty_disconnect_indication
r_void
id|ircomm_tty_disconnect_indication
c_func
(paren
r_void
op_star
id|instance
comma
r_void
op_star
id|sap
comma
id|LM_REASON
id|reason
comma
r_struct
id|sk_buff
op_star
id|skb
)paren
(brace
r_struct
id|ircomm_tty_cb
op_star
id|self
op_assign
(paren
r_struct
id|ircomm_tty_cb
op_star
)paren
id|instance
suffix:semicolon
id|IRDA_DEBUG
c_func
(paren
l_int|2
comma
id|__FUNCTION__
l_string|&quot;()&bslash;n&quot;
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|self
op_ne
l_int|NULL
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|self-&gt;magic
op_eq
id|IRCOMM_TTY_MAGIC
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|self-&gt;tty
)paren
r_return
suffix:semicolon
multiline_comment|/* This will stop control data transfers */
id|self-&gt;flow
op_assign
id|FLOW_STOP
suffix:semicolon
multiline_comment|/* Stop data transfers */
id|self-&gt;tty-&gt;hw_stopped
op_assign
l_int|1
suffix:semicolon
id|ircomm_tty_do_event
c_func
(paren
id|self
comma
id|IRCOMM_TTY_DISCONNECT_INDICATION
comma
l_int|NULL
comma
l_int|NULL
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Function ircomm_tty_getvalue_confirm (result, obj_id, value, priv)&n; *&n; *    Got result from the IAS query we make&n; *&n; */
DECL|function|ircomm_tty_getvalue_confirm
r_static
r_void
id|ircomm_tty_getvalue_confirm
c_func
(paren
r_int
id|result
comma
id|__u16
id|obj_id
comma
r_struct
id|ias_value
op_star
id|value
comma
r_void
op_star
id|priv
)paren
(brace
r_struct
id|ircomm_tty_cb
op_star
id|self
op_assign
(paren
r_struct
id|ircomm_tty_cb
op_star
)paren
id|priv
suffix:semicolon
id|IRDA_DEBUG
c_func
(paren
l_int|2
comma
id|__FUNCTION__
l_string|&quot;()&bslash;n&quot;
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|self
op_ne
l_int|NULL
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|self-&gt;magic
op_eq
id|IRCOMM_TTY_MAGIC
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
multiline_comment|/* We probably don&squot;t need to make any more queries */
id|iriap_close
c_func
(paren
id|self-&gt;iriap
)paren
suffix:semicolon
id|self-&gt;iriap
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/* Check if request succeeded */
r_if
c_cond
(paren
id|result
op_ne
id|IAS_SUCCESS
)paren
(brace
id|IRDA_DEBUG
c_func
(paren
l_int|4
comma
id|__FUNCTION__
l_string|&quot;(), got NULL value!&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_switch
c_cond
(paren
id|value-&gt;type
)paren
(brace
r_case
id|IAS_OCT_SEQ
suffix:colon
id|IRDA_DEBUG
c_func
(paren
l_int|2
comma
id|__FUNCTION__
l_string|&quot;(), got octet sequence&bslash;n&quot;
)paren
suffix:semicolon
id|irda_param_extract_all
c_func
(paren
id|self
comma
id|value-&gt;t.oct_seq
comma
id|value-&gt;len
comma
op_amp
id|ircomm_param_info
)paren
suffix:semicolon
id|ircomm_tty_do_event
c_func
(paren
id|self
comma
id|IRCOMM_TTY_GOT_PARAMETERS
comma
l_int|NULL
comma
l_int|NULL
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|IAS_INTEGER
suffix:colon
multiline_comment|/* Got LSAP selector */
id|IRDA_DEBUG
c_func
(paren
l_int|2
comma
id|__FUNCTION__
l_string|&quot;(), got lsapsel = %d&bslash;n&quot;
comma
id|value-&gt;t.integer
)paren
suffix:semicolon
r_if
c_cond
(paren
id|value-&gt;t.integer
op_eq
op_minus
l_int|1
)paren
(brace
id|IRDA_DEBUG
c_func
(paren
l_int|0
comma
id|__FUNCTION__
l_string|&quot;(), invalid value!&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_else
id|self-&gt;dlsap_sel
op_assign
id|value-&gt;t.integer
suffix:semicolon
id|ircomm_tty_do_event
c_func
(paren
id|self
comma
id|IRCOMM_TTY_GOT_LSAPSEL
comma
l_int|NULL
comma
l_int|NULL
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|IAS_MISSING
suffix:colon
id|IRDA_DEBUG
c_func
(paren
l_int|0
comma
id|__FUNCTION__
l_string|&quot;(), got IAS_MISSING&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|IRDA_DEBUG
c_func
(paren
l_int|0
comma
id|__FUNCTION__
l_string|&quot;(), got unknown type!&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|irias_delete_value
c_func
(paren
id|value
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Function ircomm_tty_connect_confirm (instance, sap, qos, max_sdu_size, skb)&n; *&n; *    Connection confirmed&n; *&n; */
DECL|function|ircomm_tty_connect_confirm
r_void
id|ircomm_tty_connect_confirm
c_func
(paren
r_void
op_star
id|instance
comma
r_void
op_star
id|sap
comma
r_struct
id|qos_info
op_star
id|qos
comma
id|__u32
id|max_data_size
comma
id|__u8
id|max_header_size
comma
r_struct
id|sk_buff
op_star
id|skb
)paren
(brace
r_struct
id|ircomm_tty_cb
op_star
id|self
op_assign
(paren
r_struct
id|ircomm_tty_cb
op_star
)paren
id|instance
suffix:semicolon
id|IRDA_DEBUG
c_func
(paren
l_int|2
comma
id|__FUNCTION__
l_string|&quot;()&bslash;n&quot;
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|self
op_ne
l_int|NULL
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|self-&gt;magic
op_eq
id|IRCOMM_TTY_MAGIC
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
id|self-&gt;client
op_assign
id|TRUE
suffix:semicolon
id|self-&gt;max_data_size
op_assign
id|max_data_size
suffix:semicolon
id|self-&gt;max_header_size
op_assign
id|max_header_size
suffix:semicolon
id|self-&gt;flow
op_assign
id|FLOW_START
suffix:semicolon
id|ircomm_tty_do_event
c_func
(paren
id|self
comma
id|IRCOMM_TTY_CONNECT_CONFIRM
comma
l_int|NULL
comma
l_int|NULL
)paren
suffix:semicolon
id|dev_kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Function ircomm_tty_connect_indication (instance, sap, qos, max_sdu_size, &n; *                                         skb)&n; *&n; *    we are discovered and being requested to connect by remote device !&n; *&n; */
DECL|function|ircomm_tty_connect_indication
r_void
id|ircomm_tty_connect_indication
c_func
(paren
r_void
op_star
id|instance
comma
r_void
op_star
id|sap
comma
r_struct
id|qos_info
op_star
id|qos
comma
id|__u32
id|max_data_size
comma
id|__u8
id|max_header_size
comma
r_struct
id|sk_buff
op_star
id|skb
)paren
(brace
r_struct
id|ircomm_tty_cb
op_star
id|self
op_assign
(paren
r_struct
id|ircomm_tty_cb
op_star
)paren
id|instance
suffix:semicolon
r_int
id|clen
suffix:semicolon
id|IRDA_DEBUG
c_func
(paren
l_int|2
comma
id|__FUNCTION__
l_string|&quot;()&bslash;n&quot;
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|self
op_ne
l_int|NULL
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|self-&gt;magic
op_eq
id|IRCOMM_TTY_MAGIC
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
id|self-&gt;client
op_assign
id|FALSE
suffix:semicolon
id|self-&gt;max_data_size
op_assign
id|max_data_size
suffix:semicolon
id|self-&gt;max_header_size
op_assign
id|max_header_size
suffix:semicolon
id|self-&gt;flow
op_assign
id|FLOW_START
suffix:semicolon
id|clen
op_assign
id|skb-&gt;data
(braket
l_int|0
)braket
suffix:semicolon
r_if
c_cond
(paren
id|clen
)paren
id|irda_param_extract_all
c_func
(paren
id|self
comma
id|skb-&gt;data
op_plus
l_int|1
comma
id|IRDA_MIN
c_func
(paren
id|skb-&gt;len
comma
id|clen
)paren
comma
op_amp
id|ircomm_param_info
)paren
suffix:semicolon
id|ircomm_tty_do_event
c_func
(paren
id|self
comma
id|IRCOMM_TTY_CONNECT_INDICATION
comma
l_int|NULL
comma
l_int|NULL
)paren
suffix:semicolon
id|dev_kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Function ircomm_tty_link_established (self)&n; *&n; *    Called when the IrCOMM link is established&n; *&n; */
DECL|function|ircomm_tty_link_established
r_void
id|ircomm_tty_link_established
c_func
(paren
r_struct
id|ircomm_tty_cb
op_star
id|self
)paren
(brace
id|IRDA_DEBUG
c_func
(paren
l_int|2
comma
id|__FUNCTION__
l_string|&quot;()&bslash;n&quot;
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|self
op_ne
l_int|NULL
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|self-&gt;magic
op_eq
id|IRCOMM_TTY_MAGIC
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|self-&gt;tty
)paren
r_return
suffix:semicolon
id|del_timer
c_func
(paren
op_amp
id|self-&gt;watchdog_timer
)paren
suffix:semicolon
multiline_comment|/* &n;&t; * IrCOMM link is now up, and if we are not using hardware&n;&t; * flow-control, then declare the hardware as running. Otherwise we&n;&t; * will have to wait for the peer device (DCE) to raise the CTS&n;&t; * line.  &n;&t; */
r_if
c_cond
(paren
id|self-&gt;flags
op_amp
id|ASYNC_CTS_FLOW
)paren
(brace
id|IRDA_DEBUG
c_func
(paren
l_int|0
comma
id|__FUNCTION__
l_string|&quot;(), waiting for CTS ...&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_else
(brace
id|IRDA_DEBUG
c_func
(paren
l_int|2
comma
id|__FUNCTION__
l_string|&quot;(), starting hardware!&bslash;n&quot;
)paren
suffix:semicolon
id|self-&gt;tty-&gt;hw_stopped
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Wake up processes blocked on open */
id|wake_up_interruptible
c_func
(paren
op_amp
id|self-&gt;open_wait
)paren
suffix:semicolon
)brace
id|queue_task
c_func
(paren
op_amp
id|self-&gt;tqueue
comma
op_amp
id|tq_immediate
)paren
suffix:semicolon
id|mark_bh
c_func
(paren
id|IMMEDIATE_BH
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Function irlan_start_watchdog_timer (self, timeout)&n; *&n; *    Start the watchdog timer. This timer is used to make sure that any &n; *    connection attempt is successful, and if not, we will retry after &n; *    the timeout&n; */
DECL|function|ircomm_tty_start_watchdog_timer
r_void
id|ircomm_tty_start_watchdog_timer
c_func
(paren
r_struct
id|ircomm_tty_cb
op_star
id|self
comma
r_int
id|timeout
)paren
(brace
id|ASSERT
c_func
(paren
id|self
op_ne
l_int|NULL
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|self-&gt;magic
op_eq
id|IRCOMM_TTY_MAGIC
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
id|irda_start_timer
c_func
(paren
op_amp
id|self-&gt;watchdog_timer
comma
id|timeout
comma
(paren
r_void
op_star
)paren
id|self
comma
id|ircomm_tty_watchdog_timer_expired
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Function ircomm_tty_watchdog_timer_expired (data)&n; *&n; *    Called when the connect procedure have taken to much time.&n; *&n; */
DECL|function|ircomm_tty_watchdog_timer_expired
r_void
id|ircomm_tty_watchdog_timer_expired
c_func
(paren
r_void
op_star
id|data
)paren
(brace
r_struct
id|ircomm_tty_cb
op_star
id|self
op_assign
(paren
r_struct
id|ircomm_tty_cb
op_star
)paren
id|data
suffix:semicolon
id|IRDA_DEBUG
c_func
(paren
l_int|2
comma
id|__FUNCTION__
l_string|&quot;()&bslash;n&quot;
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|self
op_ne
l_int|NULL
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|self-&gt;magic
op_eq
id|IRCOMM_TTY_MAGIC
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
id|ircomm_tty_do_event
c_func
(paren
id|self
comma
id|IRCOMM_TTY_WD_TIMER_EXPIRED
comma
l_int|NULL
comma
l_int|NULL
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Function ircomm_tty_state_idle (self, event, skb, info)&n; *&n; *    Just hanging around&n; *&n; */
DECL|function|ircomm_tty_state_idle
r_static
r_int
id|ircomm_tty_state_idle
c_func
(paren
r_struct
id|ircomm_tty_cb
op_star
id|self
comma
id|IRCOMM_TTY_EVENT
id|event
comma
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|ircomm_tty_info
op_star
id|info
)paren
(brace
r_int
id|ret
op_assign
l_int|0
suffix:semicolon
id|IRDA_DEBUG
c_func
(paren
l_int|2
comma
id|__FUNCTION__
l_string|&quot;: state=%s, event=%s&bslash;n&quot;
comma
id|ircomm_tty_state
(braket
id|self-&gt;state
)braket
comma
id|ircomm_tty_event
(braket
id|event
)braket
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|event
)paren
(brace
r_case
id|IRCOMM_TTY_ATTACH_CABLE
suffix:colon
multiline_comment|/* Try to discover any remote devices */
id|ircomm_tty_start_watchdog_timer
c_func
(paren
id|self
comma
l_int|3
op_star
id|HZ
)paren
suffix:semicolon
id|ircomm_tty_next_state
c_func
(paren
id|self
comma
id|IRCOMM_TTY_SEARCH
)paren
suffix:semicolon
id|irlmp_discovery_request
c_func
(paren
id|DISCOVERY_DEFAULT_SLOTS
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|IRCOMM_TTY_DISCOVERY_INDICATION
suffix:colon
id|self-&gt;daddr
op_assign
id|info-&gt;daddr
suffix:semicolon
id|self-&gt;saddr
op_assign
id|info-&gt;saddr
suffix:semicolon
r_if
c_cond
(paren
id|self-&gt;iriap
)paren
(brace
id|WARNING
c_func
(paren
id|__FUNCTION__
l_string|&quot;(), busy with a previous query&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EBUSY
suffix:semicolon
)brace
id|self-&gt;iriap
op_assign
id|iriap_open
c_func
(paren
id|LSAP_ANY
comma
id|IAS_CLIENT
comma
id|self
comma
id|ircomm_tty_getvalue_confirm
)paren
suffix:semicolon
id|iriap_getvaluebyclass_request
c_func
(paren
id|self-&gt;iriap
comma
id|self-&gt;saddr
comma
id|self-&gt;daddr
comma
l_string|&quot;IrDA:IrCOMM&quot;
comma
l_string|&quot;Parameters&quot;
)paren
suffix:semicolon
id|ircomm_tty_start_watchdog_timer
c_func
(paren
id|self
comma
l_int|3
op_star
id|HZ
)paren
suffix:semicolon
id|ircomm_tty_next_state
c_func
(paren
id|self
comma
id|IRCOMM_TTY_QUERY_PARAMETERS
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|IRCOMM_TTY_CONNECT_INDICATION
suffix:colon
id|del_timer
c_func
(paren
op_amp
id|self-&gt;watchdog_timer
)paren
suffix:semicolon
multiline_comment|/* Accept connection */
id|ircomm_connect_response
c_func
(paren
id|self-&gt;ircomm
comma
l_int|NULL
)paren
suffix:semicolon
id|ircomm_tty_next_state
c_func
(paren
id|self
comma
id|IRCOMM_TTY_READY
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|IRCOMM_TTY_WD_TIMER_EXPIRED
suffix:colon
multiline_comment|/* Just stay idle */
r_break
suffix:semicolon
r_case
id|IRCOMM_TTY_DETACH_CABLE
suffix:colon
id|ircomm_tty_next_state
c_func
(paren
id|self
comma
id|IRCOMM_TTY_IDLE
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|IRDA_DEBUG
c_func
(paren
l_int|2
comma
id|__FUNCTION__
l_string|&quot;(), unknown event: %s&bslash;n&quot;
comma
id|ircomm_tty_event
(braket
id|event
)braket
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_return
id|ret
suffix:semicolon
)brace
multiline_comment|/*&n; * Function ircomm_tty_state_search (self, event, skb, info)&n; *&n; *    Trying to discover an IrCOMM device&n; *&n; */
DECL|function|ircomm_tty_state_search
r_static
r_int
id|ircomm_tty_state_search
c_func
(paren
r_struct
id|ircomm_tty_cb
op_star
id|self
comma
id|IRCOMM_TTY_EVENT
id|event
comma
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|ircomm_tty_info
op_star
id|info
)paren
(brace
r_int
id|ret
op_assign
l_int|0
suffix:semicolon
id|IRDA_DEBUG
c_func
(paren
l_int|2
comma
id|__FUNCTION__
l_string|&quot;: state=%s, event=%s&bslash;n&quot;
comma
id|ircomm_tty_state
(braket
id|self-&gt;state
)braket
comma
id|ircomm_tty_event
(braket
id|event
)braket
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|event
)paren
(brace
r_case
id|IRCOMM_TTY_DISCOVERY_INDICATION
suffix:colon
id|self-&gt;daddr
op_assign
id|info-&gt;daddr
suffix:semicolon
id|self-&gt;saddr
op_assign
id|info-&gt;saddr
suffix:semicolon
r_if
c_cond
(paren
id|self-&gt;iriap
)paren
(brace
id|WARNING
c_func
(paren
id|__FUNCTION__
l_string|&quot;(), busy with a previous query&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EBUSY
suffix:semicolon
)brace
id|self-&gt;iriap
op_assign
id|iriap_open
c_func
(paren
id|LSAP_ANY
comma
id|IAS_CLIENT
comma
id|self
comma
id|ircomm_tty_getvalue_confirm
)paren
suffix:semicolon
r_if
c_cond
(paren
id|self-&gt;service_type
op_eq
id|IRCOMM_3_WIRE_RAW
)paren
(brace
id|iriap_getvaluebyclass_request
c_func
(paren
id|self-&gt;iriap
comma
id|self-&gt;saddr
comma
id|self-&gt;daddr
comma
l_string|&quot;IrLPT&quot;
comma
l_string|&quot;IrDA:IrLMP:LsapSel&quot;
)paren
suffix:semicolon
id|ircomm_tty_next_state
c_func
(paren
id|self
comma
id|IRCOMM_TTY_QUERY_LSAP_SEL
)paren
suffix:semicolon
)brace
r_else
(brace
id|iriap_getvaluebyclass_request
c_func
(paren
id|self-&gt;iriap
comma
id|self-&gt;saddr
comma
id|self-&gt;daddr
comma
l_string|&quot;IrDA:IrCOMM&quot;
comma
l_string|&quot;Parameters&quot;
)paren
suffix:semicolon
id|ircomm_tty_next_state
c_func
(paren
id|self
comma
id|IRCOMM_TTY_QUERY_PARAMETERS
)paren
suffix:semicolon
)brace
id|ircomm_tty_start_watchdog_timer
c_func
(paren
id|self
comma
l_int|3
op_star
id|HZ
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|IRCOMM_TTY_CONNECT_INDICATION
suffix:colon
id|del_timer
c_func
(paren
op_amp
id|self-&gt;watchdog_timer
)paren
suffix:semicolon
multiline_comment|/* Accept connection */
id|ircomm_connect_response
c_func
(paren
id|self-&gt;ircomm
comma
l_int|NULL
)paren
suffix:semicolon
id|ircomm_tty_next_state
c_func
(paren
id|self
comma
id|IRCOMM_TTY_READY
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|IRCOMM_TTY_WD_TIMER_EXPIRED
suffix:colon
macro_line|#if 1
multiline_comment|/* Give up */
macro_line|#else
multiline_comment|/* Try to discover any remote devices */
id|ircomm_tty_start_watchdog_timer
c_func
(paren
id|self
comma
l_int|3
op_star
id|HZ
)paren
suffix:semicolon
id|irlmp_discovery_request
c_func
(paren
id|DISCOVERY_DEFAULT_SLOTS
)paren
suffix:semicolon
macro_line|#endif
r_break
suffix:semicolon
r_case
id|IRCOMM_TTY_DETACH_CABLE
suffix:colon
id|ircomm_tty_next_state
c_func
(paren
id|self
comma
id|IRCOMM_TTY_IDLE
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|IRDA_DEBUG
c_func
(paren
l_int|2
comma
id|__FUNCTION__
l_string|&quot;(), unknown event: %s&bslash;n&quot;
comma
id|ircomm_tty_event
(braket
id|event
)braket
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_return
id|ret
suffix:semicolon
)brace
multiline_comment|/*&n; * Function ircomm_tty_state_query (self, event, skb, info)&n; *&n; *    Querying the remote LM-IAS for IrCOMM parameters&n; *&n; */
DECL|function|ircomm_tty_state_query_parameters
r_static
r_int
id|ircomm_tty_state_query_parameters
c_func
(paren
r_struct
id|ircomm_tty_cb
op_star
id|self
comma
id|IRCOMM_TTY_EVENT
id|event
comma
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|ircomm_tty_info
op_star
id|info
)paren
(brace
r_int
id|ret
op_assign
l_int|0
suffix:semicolon
id|IRDA_DEBUG
c_func
(paren
l_int|2
comma
id|__FUNCTION__
l_string|&quot;: state=%s, event=%s&bslash;n&quot;
comma
id|ircomm_tty_state
(braket
id|self-&gt;state
)braket
comma
id|ircomm_tty_event
(braket
id|event
)braket
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|event
)paren
(brace
r_case
id|IRCOMM_TTY_GOT_PARAMETERS
suffix:colon
r_if
c_cond
(paren
id|self-&gt;iriap
)paren
(brace
id|WARNING
c_func
(paren
id|__FUNCTION__
l_string|&quot;(), busy with a previous query&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EBUSY
suffix:semicolon
)brace
id|self-&gt;iriap
op_assign
id|iriap_open
c_func
(paren
id|LSAP_ANY
comma
id|IAS_CLIENT
comma
id|self
comma
id|ircomm_tty_getvalue_confirm
)paren
suffix:semicolon
id|iriap_getvaluebyclass_request
c_func
(paren
id|self-&gt;iriap
comma
id|self-&gt;saddr
comma
id|self-&gt;daddr
comma
l_string|&quot;IrDA:IrCOMM&quot;
comma
l_string|&quot;IrDA:TinyTP:LsapSel&quot;
)paren
suffix:semicolon
id|ircomm_tty_start_watchdog_timer
c_func
(paren
id|self
comma
l_int|3
op_star
id|HZ
)paren
suffix:semicolon
id|ircomm_tty_next_state
c_func
(paren
id|self
comma
id|IRCOMM_TTY_QUERY_LSAP_SEL
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|IRCOMM_TTY_WD_TIMER_EXPIRED
suffix:colon
multiline_comment|/* Go back to search mode */
id|ircomm_tty_next_state
c_func
(paren
id|self
comma
id|IRCOMM_TTY_SEARCH
)paren
suffix:semicolon
id|ircomm_tty_start_watchdog_timer
c_func
(paren
id|self
comma
l_int|3
op_star
id|HZ
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|IRCOMM_TTY_CONNECT_INDICATION
suffix:colon
id|del_timer
c_func
(paren
op_amp
id|self-&gt;watchdog_timer
)paren
suffix:semicolon
multiline_comment|/* Accept connection */
id|ircomm_connect_response
c_func
(paren
id|self-&gt;ircomm
comma
l_int|NULL
)paren
suffix:semicolon
id|ircomm_tty_next_state
c_func
(paren
id|self
comma
id|IRCOMM_TTY_READY
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|IRCOMM_TTY_DETACH_CABLE
suffix:colon
id|ircomm_tty_next_state
c_func
(paren
id|self
comma
id|IRCOMM_TTY_IDLE
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|IRDA_DEBUG
c_func
(paren
l_int|2
comma
id|__FUNCTION__
l_string|&quot;(), unknown event: %s&bslash;n&quot;
comma
id|ircomm_tty_event
(braket
id|event
)braket
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_return
id|ret
suffix:semicolon
)brace
multiline_comment|/*&n; * Function ircomm_tty_state_query_lsap_sel (self, event, skb, info)&n; *&n; *    Query remote LM-IAS for the LSAP selector which we can connect to&n; *&n; */
DECL|function|ircomm_tty_state_query_lsap_sel
r_static
r_int
id|ircomm_tty_state_query_lsap_sel
c_func
(paren
r_struct
id|ircomm_tty_cb
op_star
id|self
comma
id|IRCOMM_TTY_EVENT
id|event
comma
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|ircomm_tty_info
op_star
id|info
)paren
(brace
r_int
id|ret
op_assign
l_int|0
suffix:semicolon
id|IRDA_DEBUG
c_func
(paren
l_int|2
comma
id|__FUNCTION__
l_string|&quot;: state=%s, event=%s&bslash;n&quot;
comma
id|ircomm_tty_state
(braket
id|self-&gt;state
)braket
comma
id|ircomm_tty_event
(braket
id|event
)braket
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|event
)paren
(brace
r_case
id|IRCOMM_TTY_GOT_LSAPSEL
suffix:colon
multiline_comment|/* Connect to remote device */
id|ret
op_assign
id|ircomm_connect_request
c_func
(paren
id|self-&gt;ircomm
comma
id|self-&gt;dlsap_sel
comma
id|self-&gt;saddr
comma
id|self-&gt;daddr
comma
l_int|NULL
comma
id|self-&gt;service_type
)paren
suffix:semicolon
id|ircomm_tty_start_watchdog_timer
c_func
(paren
id|self
comma
l_int|3
op_star
id|HZ
)paren
suffix:semicolon
id|ircomm_tty_next_state
c_func
(paren
id|self
comma
id|IRCOMM_TTY_SETUP
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|IRCOMM_TTY_WD_TIMER_EXPIRED
suffix:colon
multiline_comment|/* Go back to search mode */
id|ircomm_tty_next_state
c_func
(paren
id|self
comma
id|IRCOMM_TTY_SEARCH
)paren
suffix:semicolon
id|ircomm_tty_start_watchdog_timer
c_func
(paren
id|self
comma
l_int|3
op_star
id|HZ
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|IRCOMM_TTY_CONNECT_INDICATION
suffix:colon
id|del_timer
c_func
(paren
op_amp
id|self-&gt;watchdog_timer
)paren
suffix:semicolon
multiline_comment|/* Accept connection */
id|ircomm_connect_response
c_func
(paren
id|self-&gt;ircomm
comma
l_int|NULL
)paren
suffix:semicolon
id|ircomm_tty_next_state
c_func
(paren
id|self
comma
id|IRCOMM_TTY_READY
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|IRCOMM_TTY_DETACH_CABLE
suffix:colon
id|ircomm_tty_next_state
c_func
(paren
id|self
comma
id|IRCOMM_TTY_IDLE
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|IRDA_DEBUG
c_func
(paren
l_int|2
comma
id|__FUNCTION__
l_string|&quot;(), unknown event: %s&bslash;n&quot;
comma
id|ircomm_tty_event
(braket
id|event
)braket
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_return
id|ret
suffix:semicolon
)brace
multiline_comment|/*&n; * Function ircomm_tty_state_setup (self, event, skb, info)&n; *&n; *    Trying to connect&n; *&n; */
DECL|function|ircomm_tty_state_setup
r_static
r_int
id|ircomm_tty_state_setup
c_func
(paren
r_struct
id|ircomm_tty_cb
op_star
id|self
comma
id|IRCOMM_TTY_EVENT
id|event
comma
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|ircomm_tty_info
op_star
id|info
)paren
(brace
r_int
id|ret
op_assign
l_int|0
suffix:semicolon
id|IRDA_DEBUG
c_func
(paren
l_int|2
comma
id|__FUNCTION__
l_string|&quot;: state=%s, event=%s&bslash;n&quot;
comma
id|ircomm_tty_state
(braket
id|self-&gt;state
)braket
comma
id|ircomm_tty_event
(braket
id|event
)braket
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|event
)paren
(brace
r_case
id|IRCOMM_TTY_CONNECT_CONFIRM
suffix:colon
id|del_timer
c_func
(paren
op_amp
id|self-&gt;watchdog_timer
)paren
suffix:semicolon
id|ircomm_tty_next_state
c_func
(paren
id|self
comma
id|IRCOMM_TTY_READY
)paren
suffix:semicolon
multiline_comment|/* &n;&t;&t; * Send initial parameters. This will also send out queued&n;&t;&t; * parameters waiting for the connection to come up &n;&t;&t; */
id|ircomm_tty_send_initial_parameters
c_func
(paren
id|self
)paren
suffix:semicolon
id|ircomm_tty_link_established
c_func
(paren
id|self
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|IRCOMM_TTY_CONNECT_INDICATION
suffix:colon
id|del_timer
c_func
(paren
op_amp
id|self-&gt;watchdog_timer
)paren
suffix:semicolon
multiline_comment|/* Accept connection */
id|ircomm_connect_response
c_func
(paren
id|self-&gt;ircomm
comma
l_int|NULL
)paren
suffix:semicolon
id|ircomm_tty_next_state
c_func
(paren
id|self
comma
id|IRCOMM_TTY_READY
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|IRCOMM_TTY_WD_TIMER_EXPIRED
suffix:colon
multiline_comment|/* Go back to search mode */
id|ircomm_tty_next_state
c_func
(paren
id|self
comma
id|IRCOMM_TTY_SEARCH
)paren
suffix:semicolon
id|ircomm_tty_start_watchdog_timer
c_func
(paren
id|self
comma
l_int|3
op_star
id|HZ
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|IRCOMM_TTY_DETACH_CABLE
suffix:colon
multiline_comment|/* ircomm_disconnect_request(self-&gt;ircomm, NULL); */
id|ircomm_tty_next_state
c_func
(paren
id|self
comma
id|IRCOMM_TTY_IDLE
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|IRDA_DEBUG
c_func
(paren
l_int|2
comma
id|__FUNCTION__
l_string|&quot;(), unknown event: %s&bslash;n&quot;
comma
id|ircomm_tty_event
(braket
id|event
)braket
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_return
id|ret
suffix:semicolon
)brace
multiline_comment|/*&n; * Function ircomm_tty_state_ready (self, event, skb, info)&n; *&n; *    IrCOMM is now connected&n; *&n; */
DECL|function|ircomm_tty_state_ready
r_static
r_int
id|ircomm_tty_state_ready
c_func
(paren
r_struct
id|ircomm_tty_cb
op_star
id|self
comma
id|IRCOMM_TTY_EVENT
id|event
comma
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|ircomm_tty_info
op_star
id|info
)paren
(brace
r_int
id|ret
op_assign
l_int|0
suffix:semicolon
r_switch
c_cond
(paren
id|event
)paren
(brace
r_case
id|IRCOMM_TTY_DATA_REQUEST
suffix:colon
id|ret
op_assign
id|ircomm_data_request
c_func
(paren
id|self-&gt;ircomm
comma
id|skb
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|IRCOMM_TTY_DETACH_CABLE
suffix:colon
id|ircomm_disconnect_request
c_func
(paren
id|self-&gt;ircomm
comma
l_int|NULL
)paren
suffix:semicolon
id|ircomm_tty_next_state
c_func
(paren
id|self
comma
id|IRCOMM_TTY_IDLE
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|IRCOMM_TTY_DISCONNECT_INDICATION
suffix:colon
id|ircomm_tty_next_state
c_func
(paren
id|self
comma
id|IRCOMM_TTY_SEARCH
)paren
suffix:semicolon
id|ircomm_tty_start_watchdog_timer
c_func
(paren
id|self
comma
l_int|3
op_star
id|HZ
)paren
suffix:semicolon
r_if
c_cond
(paren
id|self-&gt;flags
op_amp
id|ASYNC_CHECK_CD
)paren
(brace
multiline_comment|/* Drop carrier */
id|self-&gt;settings.dce
op_assign
id|IRCOMM_DELTA_CD
suffix:semicolon
id|ircomm_tty_check_modem_status
c_func
(paren
id|self
)paren
suffix:semicolon
)brace
r_else
(brace
id|IRDA_DEBUG
c_func
(paren
l_int|0
comma
id|__FUNCTION__
l_string|&quot;(), hanging up!&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|self-&gt;tty
)paren
id|tty_hangup
c_func
(paren
id|self-&gt;tty
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_default
suffix:colon
id|IRDA_DEBUG
c_func
(paren
l_int|2
comma
id|__FUNCTION__
l_string|&quot;(), unknown event: %s&bslash;n&quot;
comma
id|ircomm_tty_event
(braket
id|event
)braket
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_return
id|ret
suffix:semicolon
)brace
multiline_comment|/*&n; * Function ircomm_tty_do_event (self, event, skb)&n; *&n; *    Process event&n; *&n; */
DECL|function|ircomm_tty_do_event
r_int
id|ircomm_tty_do_event
c_func
(paren
r_struct
id|ircomm_tty_cb
op_star
id|self
comma
id|IRCOMM_TTY_EVENT
id|event
comma
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|ircomm_tty_info
op_star
id|info
)paren
(brace
id|ASSERT
c_func
(paren
id|self
op_ne
l_int|NULL
comma
r_return
op_minus
l_int|1
suffix:semicolon
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|self-&gt;magic
op_eq
id|IRCOMM_TTY_MAGIC
comma
r_return
op_minus
l_int|1
suffix:semicolon
)paren
suffix:semicolon
id|IRDA_DEBUG
c_func
(paren
l_int|2
comma
id|__FUNCTION__
l_string|&quot;: state=%s, event=%s&bslash;n&quot;
comma
id|ircomm_tty_state
(braket
id|self-&gt;state
)braket
comma
id|ircomm_tty_event
(braket
id|event
)braket
)paren
suffix:semicolon
r_return
(paren
op_star
id|state
(braket
id|self-&gt;state
)braket
)paren
(paren
id|self
comma
id|event
comma
id|skb
comma
id|info
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Function ircomm_tty_next_state (self, state)&n; *&n; *    Switch state&n; *&n; */
DECL|function|ircomm_tty_next_state
r_void
id|ircomm_tty_next_state
c_func
(paren
r_struct
id|ircomm_tty_cb
op_star
id|self
comma
id|IRCOMM_TTY_STATE
id|state
)paren
(brace
id|ASSERT
c_func
(paren
id|self
op_ne
l_int|NULL
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|self-&gt;magic
op_eq
id|IRCOMM_TTY_MAGIC
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
id|self-&gt;state
op_assign
id|state
suffix:semicolon
id|IRDA_DEBUG
c_func
(paren
l_int|2
comma
id|__FUNCTION__
l_string|&quot;: next state=%s, service type=%d&bslash;n&quot;
comma
id|ircomm_tty_state
(braket
id|self-&gt;state
)braket
comma
id|self-&gt;service_type
)paren
suffix:semicolon
)brace
eof
