multiline_comment|/*********************************************************************&n; *                &n; * Filename:      irvtd_driver.c&n; * Version:       &n; * Description:   Virtual tty driver (the &quot;port emulation entity&quot; of IrCOMM)&n; * Status:        Experimental.&n; * Author:        Takahide Higuchi &lt;thiguchi@pluto.dti.ne.jp&gt;&n; * Source:        serial.c by Linus Torvalds&n; *                isdn_tty.c by Fritz Elfert&n; *&n; *     Copyright (c) 1998, Takahide Higuchi, &lt;thiguchi@pluto.dti.ne.jp&gt;,&n; *     All Rights Reserved.&n; *&n; *     This program is free software; you can redistribute it and/or&n; *     modify it under the terms of the GNU General Public License as&n; *     published by the Free Software Foundation; either version 2 of&n; *     the License, or (at your option) any later version.&n; *&n; *     I, Takahide Higuchi, provide no warranty for any of this software.&n; *     This material is provided &quot;AS-IS&quot; and at no charge.&n; *&n; ********************************************************************/
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/fs.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/termios.h&gt;
macro_line|#include &lt;linux/tty.h&gt;
macro_line|#include &lt;asm/segment.h&gt;
macro_line|#include &lt;asm/uaccess.h&gt;
macro_line|#include &lt;net/irda/irda.h&gt;
macro_line|#include &lt;net/irda/irttp.h&gt;
macro_line|#include &lt;net/irda/irias_object.h&gt;
macro_line|#include &lt;net/irda/irvtd.h&gt;
macro_line|#ifndef MIN
DECL|macro|MIN
mdefine_line|#define MIN(a,b)        ((a) &lt; (b) ? (a) : (b))
macro_line|#endif
DECL|macro|DO_RESTART
mdefine_line|#define DO_RESTART
DECL|macro|RELEVANT_IFLAG
mdefine_line|#define RELEVANT_IFLAG(iflag) (iflag &amp; (IGNBRK|BRKINT|IGNPAR|PARMRK|INPCK))
DECL|variable|irvtd_drv
r_struct
id|tty_driver
id|irvtd_drv
suffix:semicolon
DECL|variable|irvtd_table
r_struct
id|tty_struct
op_star
id|irvtd_table
(braket
id|COMM_MAX_TTY
)braket
suffix:semicolon
DECL|variable|irvtd_termios
r_struct
id|termios
op_star
id|irvtd_termios
(braket
id|COMM_MAX_TTY
)braket
suffix:semicolon
DECL|variable|irvtd_termios_locked
r_struct
id|termios
op_star
id|irvtd_termios_locked
(braket
id|COMM_MAX_TTY
)braket
suffix:semicolon
DECL|variable|irvtd_refcount
r_static
r_int
id|irvtd_refcount
suffix:semicolon
DECL|variable|irvtd
r_struct
id|irvtd_cb
op_star
op_star
id|irvtd
op_assign
l_int|NULL
suffix:semicolon
DECL|variable|revision_date
r_static
r_char
op_star
id|revision_date
op_assign
l_string|&quot;Wed Mar 10 15:33:03 1999&quot;
suffix:semicolon
multiline_comment|/*&n; * prototypes&n; */
r_int
id|irvtd_open
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
comma
r_struct
id|file
op_star
id|filp
)paren
suffix:semicolon
r_void
id|irvtd_close
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
comma
r_struct
id|file
op_star
id|filp
)paren
suffix:semicolon
r_int
id|irvtd_write
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
comma
r_int
id|from_user
comma
r_const
r_int
r_char
op_star
id|buf
comma
r_int
id|count
)paren
suffix:semicolon
r_void
id|irvtd_put_char
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
comma
r_int
r_char
id|ch
)paren
suffix:semicolon
r_int
id|irvtd_write_room
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
)paren
suffix:semicolon
r_int
id|irvtd_chars_in_buffer
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
)paren
suffix:semicolon
r_int
id|irvtd_ioctl
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
comma
r_struct
id|file
op_star
id|file
comma
r_int
r_int
id|cmd
comma
r_int
r_int
id|arg
)paren
suffix:semicolon
r_void
id|irvtd_set_termios
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
comma
r_struct
id|termios
op_star
id|old
)paren
suffix:semicolon
r_void
id|irvtd_throttle
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
)paren
suffix:semicolon
r_void
id|irvtd_unthrottle
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
)paren
suffix:semicolon
r_void
id|irvtd_stop
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
)paren
suffix:semicolon
r_void
id|irvtd_start
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
)paren
suffix:semicolon
r_void
id|irvtd_hangup
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
)paren
suffix:semicolon
r_void
id|irvtd_flush_buffer
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
)paren
suffix:semicolon
r_static
r_void
id|change_speed
c_func
(paren
r_struct
id|irvtd_cb
op_star
id|driver
)paren
suffix:semicolon
r_static
r_void
id|irvtd_write_to_tty
c_func
(paren
r_struct
id|irvtd_cb
op_star
)paren
suffix:semicolon
r_static
r_void
id|irvtd_send_data_request
c_func
(paren
r_struct
id|irvtd_cb
op_star
)paren
suffix:semicolon
r_static
r_void
id|irvtd_break
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
comma
r_int
id|break_state
)paren
suffix:semicolon
r_static
r_void
id|irvtd_send_xchar
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
comma
r_char
id|ch
)paren
suffix:semicolon
r_static
r_void
id|irvtd_wait_until_sent
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
comma
r_int
id|timeout
)paren
suffix:semicolon
r_static
r_void
id|irvtd_start_timer
c_func
(paren
r_struct
id|irvtd_cb
op_star
id|driver
)paren
suffix:semicolon
r_static
r_void
id|irvtd_timer_expired
c_func
(paren
r_int
r_int
id|data
)paren
suffix:semicolon
r_static
r_int
id|line_info
c_func
(paren
r_char
op_star
id|buf
comma
r_struct
id|irvtd_cb
op_star
id|driver
)paren
suffix:semicolon
r_static
r_int
id|irvtd_read_proc
c_func
(paren
r_char
op_star
id|buf
comma
r_char
op_star
op_star
id|start
comma
id|off_t
id|offset
comma
r_int
id|len
comma
r_int
op_star
id|eof
comma
r_void
op_star
id|unused
)paren
suffix:semicolon
multiline_comment|/*&n; * ----------------------------------------------------------------------&n; * &n; *&n;&n; * ----------------------------------------------------------------------&n; */
multiline_comment|/*&n; **********************************************************************&n; *&n; * ircomm_receive_data() and friends&n; *&n; * like interrupt handler in the serial.c,we receive data when &n; * ircomm_data_indication comes&n; *&n; **********************************************************************&n; */
multiline_comment|/* &n; * irvtd_write_to_tty&n; * send incoming/queued data to tty&n; */
DECL|function|irvtd_write_to_tty
r_static
r_void
id|irvtd_write_to_tty
c_func
(paren
r_struct
id|irvtd_cb
op_star
id|driver
)paren
(brace
r_int
id|status
comma
id|c
comma
id|flag
suffix:semicolon
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
r_struct
id|tty_struct
op_star
id|tty
op_assign
id|driver-&gt;tty
suffix:semicolon
id|skb
op_assign
id|skb_dequeue
c_func
(paren
op_amp
id|driver-&gt;rxbuff
)paren
suffix:semicolon
r_if
c_cond
(paren
id|skb
op_eq
l_int|NULL
)paren
(brace
r_return
suffix:semicolon
)brace
multiline_comment|/* there&squot;s nothing */
multiline_comment|/* &n;&t; * we should parse controlchannel field here. &n;&t; * (see process_data() in ircomm.c)&n;&t; */
id|ircomm_parse_tuples
c_func
(paren
id|driver-&gt;comm
comma
id|skb
comma
id|CONTROL_CHANNEL
)paren
suffix:semicolon
macro_line|#ifdef IRVTD_DEBUG_RX
id|printk
c_func
(paren
l_string|&quot;received data:&quot;
)paren
suffix:semicolon
(brace
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|skb-&gt;len
suffix:semicolon
id|i
op_increment
)paren
id|printk
c_func
(paren
l_string|&quot;%02x &quot;
comma
id|skb-&gt;data
(braket
id|i
)braket
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
)brace
macro_line|#endif
id|status
op_assign
id|driver-&gt;comm-&gt;peer_line_status
op_amp
id|driver-&gt;read_status_mask
suffix:semicolon
multiline_comment|/* &n;&t; * if there are too many errors which make a character ignored,&n;&t; * drop characters&n;&t; */
r_if
c_cond
(paren
id|status
op_amp
id|driver-&gt;ignore_status_mask
)paren
(brace
id|DEBUG
c_func
(paren
l_int|0
comma
id|__FUNCTION__
l_string|&quot;:some error:ignore characters.&bslash;n&quot;
)paren
suffix:semicolon
id|dev_kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|c
op_assign
id|MIN
c_func
(paren
id|skb-&gt;len
comma
(paren
id|TTY_FLIPBUF_SIZE
op_minus
id|tty-&gt;flip.count
)paren
)paren
suffix:semicolon
id|DEBUG
c_func
(paren
l_int|4
comma
id|__FUNCTION__
l_string|&quot;skb_len=%d, tty-&gt;flip.count=%d &bslash;n&quot;
comma
(paren
r_int
)paren
id|skb-&gt;len
comma
id|tty-&gt;flip.count
)paren
suffix:semicolon
r_if
c_cond
(paren
id|driver-&gt;comm-&gt;peer_break_signal
)paren
(brace
id|driver-&gt;comm-&gt;peer_break_signal
op_assign
l_int|0
suffix:semicolon
id|DEBUG
c_func
(paren
l_int|0
comma
l_string|&quot;handling break....&bslash;n&quot;
)paren
suffix:semicolon
id|flag
op_assign
id|TTY_BREAK
suffix:semicolon
r_if
c_cond
(paren
id|driver-&gt;flags
op_amp
id|ASYNC_SAK
)paren
multiline_comment|/*&n;&t;&t;&t; * do_SAK() seems to be an implementation of the &n;&t;&t;&t; * idea called &quot;Secure Attention Key&quot;,&n;&t;&t;&t; * which seems to be discribed in &quot;Orange book&quot;.&n;&t;&t;&t; * (which is published by U.S.military!!?? ,&n;&t;&t;&t; * see source of do_SAK())&n;&t;&t;&t; *&n;&t;&t;&t; * but what kind of security do we need &n;&t;&t;&t; * when we use infrared communication??? :p)&n;&t;&t;&t; */
id|do_SAK
c_func
(paren
id|tty
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|status
op_amp
id|LSR_PE
)paren
id|flag
op_assign
id|TTY_PARITY
suffix:semicolon
r_else
r_if
c_cond
(paren
id|status
op_amp
id|LSR_FE
)paren
id|flag
op_assign
id|TTY_FRAME
suffix:semicolon
r_else
r_if
c_cond
(paren
id|status
op_amp
id|LSR_OE
)paren
id|flag
op_assign
id|TTY_OVERRUN
suffix:semicolon
r_else
id|flag
op_assign
id|TTY_NORMAL
suffix:semicolon
r_if
c_cond
(paren
id|c
)paren
(brace
id|DEBUG
c_func
(paren
l_int|4
comma
l_string|&quot;writing %d chars to tty&bslash;n&quot;
comma
id|c
)paren
suffix:semicolon
id|driver-&gt;icount.rx
op_add_assign
id|c
suffix:semicolon
id|memset
c_func
(paren
id|tty-&gt;flip.flag_buf_ptr
comma
id|flag
comma
id|c
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|tty-&gt;flip.char_buf_ptr
comma
id|skb-&gt;data
comma
id|c
)paren
suffix:semicolon
id|tty-&gt;flip.flag_buf_ptr
op_add_assign
id|c
suffix:semicolon
id|tty-&gt;flip.char_buf_ptr
op_add_assign
id|c
suffix:semicolon
id|tty-&gt;flip.count
op_add_assign
id|c
suffix:semicolon
id|skb_pull
c_func
(paren
id|skb
comma
id|c
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|skb-&gt;len
op_eq
l_int|0
)paren
(brace
id|dev_kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* queue rest of data again */
id|DEBUG
c_func
(paren
l_int|4
comma
id|__FUNCTION__
l_string|&quot;:retrying frame!&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* build a dummy control channel */
id|skb_push
c_func
(paren
id|skb
comma
l_int|1
)paren
suffix:semicolon
op_star
id|skb-&gt;data
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* clen is 0 */
id|skb_queue_head
c_func
(paren
op_amp
id|driver-&gt;rxbuff
comma
id|skb
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|c
)paren
(brace
multiline_comment|/* let the process read its buffer! */
id|tty_flip_buffer_push
c_func
(paren
id|tty
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|skb_queue_len
c_func
(paren
op_amp
id|driver-&gt;rxbuff
)paren
OL
id|IRVTD_RX_QUEUE_LOW
op_logical_and
id|driver-&gt;ttp_stoprx
)paren
(brace
id|irttp_flow_request
c_func
(paren
id|driver-&gt;comm-&gt;tsap
comma
id|FLOW_START
)paren
suffix:semicolon
id|driver-&gt;ttp_stoprx
op_assign
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|skb_queue_empty
c_func
(paren
op_amp
id|driver-&gt;rxbuff
)paren
op_logical_and
id|driver-&gt;disconnect_pend
)paren
(brace
multiline_comment|/* disconnect */
id|driver-&gt;disconnect_pend
op_assign
l_int|0
suffix:semicolon
id|driver-&gt;rx_disable
op_assign
l_int|1
suffix:semicolon
id|tty_hangup
c_func
(paren
id|driver-&gt;tty
)paren
suffix:semicolon
)brace
)brace
DECL|function|irvtd_receive_data
r_static
r_int
id|irvtd_receive_data
c_func
(paren
r_void
op_star
id|instance
comma
r_void
op_star
id|sap
comma
r_struct
id|sk_buff
op_star
id|skb
)paren
(brace
r_struct
id|irvtd_cb
op_star
id|driver
op_assign
(paren
r_struct
id|irvtd_cb
op_star
)paren
id|instance
suffix:semicolon
id|ASSERT
c_func
(paren
id|driver
op_ne
l_int|NULL
comma
r_return
op_minus
l_int|1
suffix:semicolon
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|driver-&gt;magic
op_eq
id|IRVTD_MAGIC
comma
r_return
op_minus
l_int|1
suffix:semicolon
)paren
suffix:semicolon
id|DEBUG
c_func
(paren
l_int|4
comma
id|__FUNCTION__
l_string|&quot;(): queue frame&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* queue incoming data and make bottom half handler ready */
id|skb_queue_tail
c_func
(paren
op_amp
id|driver-&gt;rxbuff
comma
id|skb
)paren
suffix:semicolon
r_if
c_cond
(paren
id|skb_queue_len
c_func
(paren
op_amp
id|driver-&gt;rxbuff
)paren
OG
id|IRVTD_RX_QUEUE_HIGH
)paren
(brace
id|irttp_flow_request
c_func
(paren
id|driver-&gt;comm-&gt;tsap
comma
id|FLOW_STOP
)paren
suffix:semicolon
id|driver-&gt;ttp_stoprx
op_assign
l_int|1
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; ***********************************************************************&n; *&n; * irvtd_send_data() and friends&n; *&n; * like interrupt handler in the serial.c,we send data when &n; * a timer is expired&n; *&n; ***********************************************************************&n; */
DECL|function|irvtd_start_timer
r_static
r_void
id|irvtd_start_timer
c_func
(paren
r_struct
id|irvtd_cb
op_star
id|driver
)paren
(brace
id|ASSERT
c_func
(paren
id|driver
op_ne
l_int|NULL
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|driver-&gt;magic
op_eq
id|IRVTD_MAGIC
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
id|del_timer
c_func
(paren
op_amp
id|driver-&gt;timer
)paren
suffix:semicolon
id|driver-&gt;timer.data
op_assign
(paren
r_int
r_int
)paren
id|driver
suffix:semicolon
id|driver-&gt;timer.function
op_assign
op_amp
id|irvtd_timer_expired
suffix:semicolon
id|driver-&gt;timer.expires
op_assign
id|jiffies
op_plus
(paren
id|HZ
op_div
l_int|20
)paren
suffix:semicolon
multiline_comment|/* 50msec */
id|add_timer
c_func
(paren
op_amp
id|driver-&gt;timer
)paren
suffix:semicolon
)brace
DECL|function|irvtd_timer_expired
r_static
r_void
id|irvtd_timer_expired
c_func
(paren
r_int
r_int
id|data
)paren
(brace
r_struct
id|irvtd_cb
op_star
id|driver
op_assign
(paren
r_struct
id|irvtd_cb
op_star
)paren
id|data
suffix:semicolon
id|ASSERT
c_func
(paren
id|driver
op_ne
l_int|NULL
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|driver-&gt;magic
op_eq
id|IRVTD_MAGIC
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
id|DEBUG
c_func
(paren
l_int|4
comma
id|__FUNCTION__
l_string|&quot;()&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|driver-&gt;tty-&gt;hw_stopped
)paren
op_logical_and
op_logical_neg
(paren
id|driver-&gt;tx_disable
)paren
)paren
(brace
id|irvtd_send_data_request
c_func
(paren
id|driver
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|driver-&gt;rx_disable
)paren
)paren
(brace
id|irvtd_write_to_tty
c_func
(paren
id|driver
)paren
suffix:semicolon
)brace
multiline_comment|/* start our timer again and again */
id|irvtd_start_timer
c_func
(paren
id|driver
)paren
suffix:semicolon
)brace
DECL|function|irvtd_send_data_request
r_static
r_void
id|irvtd_send_data_request
c_func
(paren
r_struct
id|irvtd_cb
op_star
id|driver
)paren
(brace
r_int
id|err
suffix:semicolon
r_struct
id|sk_buff
op_star
id|skb
op_assign
id|driver-&gt;txbuff
suffix:semicolon
id|ASSERT
c_func
(paren
id|skb
op_ne
l_int|NULL
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
id|DEBUG
c_func
(paren
l_int|4
comma
id|__FUNCTION__
l_string|&quot;()&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|skb-&gt;len
)paren
(brace
r_return
suffix:semicolon
)brace
multiline_comment|/* no data to send */
macro_line|#ifdef IRVTD_DEBUG_TX
id|DEBUG
c_func
(paren
l_int|4
comma
l_string|&quot;flush_txbuff:count(%d)&bslash;n&quot;
comma
(paren
r_int
)paren
id|skb-&gt;len
)paren
suffix:semicolon
(brace
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|skb-&gt;len
suffix:semicolon
id|i
op_increment
)paren
id|printk
c_func
(paren
l_string|&quot;%02x&quot;
comma
id|skb-&gt;data
(braket
id|i
)braket
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
)brace
macro_line|#endif
id|DEBUG
c_func
(paren
l_int|4
comma
id|__FUNCTION__
l_string|&quot;():sending %d bytes&bslash;n&quot;
comma
(paren
r_int
)paren
id|skb-&gt;len
)paren
suffix:semicolon
id|driver-&gt;icount.tx
op_add_assign
id|skb-&gt;len
suffix:semicolon
id|err
op_assign
id|ircomm_data_request
c_func
(paren
id|driver-&gt;comm
comma
id|driver-&gt;txbuff
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
(brace
id|ASSERT
c_func
(paren
id|err
op_eq
l_int|0
comma
suffix:semicolon
)paren
suffix:semicolon
id|DEBUG
c_func
(paren
l_int|0
comma
l_string|&quot;%d chars are lost&bslash;n&quot;
comma
(paren
r_int
)paren
id|skb-&gt;len
)paren
suffix:semicolon
id|skb_trim
c_func
(paren
id|skb
comma
l_int|0
)paren
suffix:semicolon
)brace
multiline_comment|/* allocate a new frame */
id|skb
op_assign
id|driver-&gt;txbuff
op_assign
id|dev_alloc_skb
c_func
(paren
id|driver-&gt;comm-&gt;max_txbuff_size
)paren
suffix:semicolon
r_if
c_cond
(paren
id|skb
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|__FUNCTION__
l_string|&quot;():flush_txbuff():alloc_skb failed!&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_else
(brace
id|skb_reserve
c_func
(paren
id|skb
comma
id|COMM_HEADER_SIZE
)paren
suffix:semicolon
)brace
id|wake_up_interruptible
c_func
(paren
op_amp
id|driver-&gt;tty-&gt;write_wait
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; ***********************************************************************&n; *&n; * indication/confirmation handlers:&n; *&n; * these routines are handlers for IrCOMM protocol stack&n; *&n; ***********************************************************************&n; */
multiline_comment|/*&n; * Function irvtd_connect_confirm (instance, sap, qos, max_sdu_size, skb)&n; *&n; *    ircomm_connect_request which we have send have succeed!&n; *&n; */
DECL|function|irvtd_connect_confirm
r_void
id|irvtd_connect_confirm
c_func
(paren
r_void
op_star
id|instance
comma
r_void
op_star
id|sap
comma
r_struct
id|qos_info
op_star
id|qos
comma
id|__u32
id|max_sdu_size
comma
r_struct
id|sk_buff
op_star
id|skb
)paren
(brace
r_struct
id|irvtd_cb
op_star
id|driver
op_assign
(paren
r_struct
id|irvtd_cb
op_star
)paren
id|instance
suffix:semicolon
id|ASSERT
c_func
(paren
id|driver
op_ne
l_int|NULL
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|driver-&gt;magic
op_eq
id|IRVTD_MAGIC
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * set default value&n;&t; */
id|driver-&gt;msr
op_or_assign
(paren
id|MSR_DCD
op_or
id|MSR_RI
op_or
id|MSR_DSR
op_or
id|MSR_CTS
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * sending initial control parameters here&n;&t; */
macro_line|#if 1
r_if
c_cond
(paren
id|driver-&gt;comm-&gt;servicetype
op_eq
id|THREE_WIRE_RAW
)paren
(brace
r_return
suffix:semicolon
)brace
multiline_comment|/* do nothing */
id|ircomm_control_request
c_func
(paren
id|driver-&gt;comm
comma
id|SERVICETYPE
)paren
suffix:semicolon
id|ircomm_control_request
c_func
(paren
id|driver-&gt;comm
comma
id|DATA_RATE
)paren
suffix:semicolon
id|ircomm_control_request
c_func
(paren
id|driver-&gt;comm
comma
id|DATA_FORMAT
)paren
suffix:semicolon
id|ircomm_control_request
c_func
(paren
id|driver-&gt;comm
comma
id|FLOW_CONTROL
)paren
suffix:semicolon
id|ircomm_control_request
c_func
(paren
id|driver-&gt;comm
comma
id|XON_XOFF_CHAR
)paren
suffix:semicolon
multiline_comment|/* ircomm_control_request(driver-&gt;comm, ENQ_ACK_CHAR); */
r_switch
c_cond
(paren
id|driver-&gt;comm-&gt;servicetype
)paren
(brace
r_case
id|CENTRONICS
suffix:colon
r_break
suffix:semicolon
r_case
id|NINE_WIRE
suffix:colon
id|ircomm_control_request
c_func
(paren
id|driver-&gt;comm
comma
id|DTELINE_STATE
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
(brace
)brace
)brace
macro_line|#endif
id|driver-&gt;tx_disable
op_assign
l_int|0
suffix:semicolon
id|wake_up_interruptible
c_func
(paren
op_amp
id|driver-&gt;open_wait
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Function irvtd_connect_indication (instance, sap, qos, max_sdu_size, skb)&n; *&n; *    we are discovered and being requested to connect by remote device !&n; *&n; */
DECL|function|irvtd_connect_indication
r_void
id|irvtd_connect_indication
c_func
(paren
r_void
op_star
id|instance
comma
r_void
op_star
id|sap
comma
r_struct
id|qos_info
op_star
id|qos
comma
id|__u32
id|max_sdu_size
comma
r_struct
id|sk_buff
op_star
id|skb
)paren
(brace
r_struct
id|irvtd_cb
op_star
id|driver
op_assign
(paren
r_struct
id|irvtd_cb
op_star
)paren
id|instance
suffix:semicolon
r_struct
id|ircomm_cb
op_star
id|comm
op_assign
(paren
r_struct
id|ircomm_cb
op_star
)paren
id|sap
suffix:semicolon
id|ASSERT
c_func
(paren
id|driver
op_ne
l_int|NULL
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|driver-&gt;magic
op_eq
id|IRVTD_MAGIC
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|comm
op_ne
l_int|NULL
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|comm-&gt;magic
op_eq
id|IRCOMM_MAGIC
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
id|DEBUG
c_func
(paren
l_int|4
comma
l_string|&quot;irvtd_connect_indication:sending connect_response...&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/*TODO: connect_response should send initialcontrolparameters! TH*/
id|ircomm_connect_response
c_func
(paren
id|comm
comma
l_int|NULL
comma
id|SAR_DISABLE
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * set default value&n;&t; */
id|driver-&gt;msr
op_or_assign
(paren
id|MSR_DCD
op_or
id|MSR_RI
op_or
id|MSR_DSR
op_or
id|MSR_CTS
)paren
suffix:semicolon
id|driver-&gt;tx_disable
op_assign
l_int|0
suffix:semicolon
id|wake_up_interruptible
c_func
(paren
op_amp
id|driver-&gt;open_wait
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Function irvtd_disconnect_indication (instance, sap, reason, skb)&n; *&n; *    This is a handler for ircomm_disconnect_indication. since this&n; *    function is called in the context of interrupt handler,&n; *    interruptible_sleep_on() MUST not be used.&n; */
DECL|function|irvtd_disconnect_indication
r_void
id|irvtd_disconnect_indication
c_func
(paren
r_void
op_star
id|instance
comma
r_void
op_star
id|sap
comma
id|LM_REASON
id|reason
comma
r_struct
id|sk_buff
op_star
id|skb
)paren
(brace
r_struct
id|irvtd_cb
op_star
id|driver
op_assign
(paren
r_struct
id|irvtd_cb
op_star
)paren
id|instance
suffix:semicolon
id|ASSERT
c_func
(paren
id|driver
op_ne
l_int|NULL
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|driver-&gt;tty
op_ne
l_int|NULL
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|driver-&gt;magic
op_eq
id|IRVTD_MAGIC
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
id|DEBUG
c_func
(paren
l_int|4
comma
l_string|&quot;irvtd_disconnect_indication:&bslash;n&quot;
)paren
suffix:semicolon
id|driver-&gt;tx_disable
op_assign
l_int|1
suffix:semicolon
id|driver-&gt;disconnect_pend
op_assign
l_int|1
suffix:semicolon
)brace
multiline_comment|/*&n; * Function irvtd_control_indication (instance, sap, cmd)&n; *&n; *    &n; *&n; */
DECL|function|irvtd_control_indication
r_void
id|irvtd_control_indication
c_func
(paren
r_void
op_star
id|instance
comma
r_void
op_star
id|sap
comma
id|IRCOMM_CMD
id|cmd
)paren
(brace
r_struct
id|irvtd_cb
op_star
id|driver
op_assign
(paren
r_struct
id|irvtd_cb
op_star
)paren
id|instance
suffix:semicolon
id|ASSERT
c_func
(paren
id|driver
op_ne
l_int|NULL
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|driver-&gt;magic
op_eq
id|IRVTD_MAGIC
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
id|DEBUG
c_func
(paren
l_int|4
comma
id|__FUNCTION__
l_string|&quot;()&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cmd
op_eq
id|TX_READY
)paren
(brace
id|driver-&gt;ttp_stoptx
op_assign
l_int|0
suffix:semicolon
id|driver-&gt;tty-&gt;hw_stopped
op_assign
id|driver-&gt;cts_stoptx
suffix:semicolon
id|irvtd_start_timer
c_func
(paren
id|driver
)paren
suffix:semicolon
r_if
c_cond
(paren
id|driver-&gt;cts_stoptx
)paren
(brace
r_return
suffix:semicolon
)brace
multiline_comment|/* &n;&t;&t; * driver-&gt;tty-&gt;write_wait will keep asleep if&n;&t;&t; * our txbuff is full.&n;&t;&t; * now that we can send packets to IrTTP layer,&n;&t;&t; * we kick it here.&n;&t;&t; */
r_if
c_cond
(paren
(paren
id|driver-&gt;tty-&gt;flags
op_amp
(paren
l_int|1
op_lshift
id|TTY_DO_WRITE_WAKEUP
)paren
)paren
op_logical_and
id|driver-&gt;tty-&gt;ldisc.write_wakeup
)paren
(paren
id|driver-&gt;tty-&gt;ldisc.write_wakeup
)paren
(paren
id|driver-&gt;tty
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|cmd
op_eq
id|TX_BUSY
)paren
(brace
id|driver-&gt;ttp_stoptx
op_assign
id|driver-&gt;tty-&gt;hw_stopped
op_assign
l_int|1
suffix:semicolon
id|del_timer
c_func
(paren
op_amp
id|driver-&gt;timer
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|ASSERT
c_func
(paren
id|cmd
op_eq
id|CONTROL_CHANNEL
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|driver-&gt;comm-&gt;pi
)paren
(brace
r_case
id|DCELINE_STATE
suffix:colon
id|driver-&gt;msr
op_assign
id|driver-&gt;comm-&gt;peer_dce
suffix:semicolon
r_if
c_cond
(paren
id|driver-&gt;msr
op_amp
(paren
id|DELTA_CTS
op_or
id|DELTA_DSR
op_or
id|DELTA_RI
op_or
id|DELTA_DCD
)paren
)paren
(brace
r_if
c_cond
(paren
id|driver-&gt;msr
op_amp
id|DELTA_CTS
)paren
(brace
id|driver-&gt;icount.cts
op_increment
suffix:semicolon
)brace
r_if
c_cond
(paren
id|driver-&gt;msr
op_amp
id|DELTA_DSR
)paren
(brace
id|driver-&gt;icount.dsr
op_increment
suffix:semicolon
)brace
r_if
c_cond
(paren
id|driver-&gt;msr
op_amp
id|DELTA_RI
)paren
(brace
id|driver-&gt;icount.rng
op_increment
suffix:semicolon
)brace
r_if
c_cond
(paren
id|driver-&gt;msr
op_amp
id|DELTA_DCD
)paren
(brace
id|driver-&gt;icount.dcd
op_increment
suffix:semicolon
)brace
id|wake_up_interruptible
c_func
(paren
op_amp
id|driver-&gt;delta_msr_wait
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|driver-&gt;flags
op_amp
id|ASYNC_CHECK_CD
)paren
op_logical_and
(paren
id|driver-&gt;msr
op_amp
id|DELTA_DCD
)paren
)paren
(brace
id|DEBUG
c_func
(paren
l_int|0
comma
l_string|&quot;CD now %s...&bslash;n&quot;
comma
(paren
id|driver-&gt;msr
op_amp
id|MSR_DCD
)paren
ques
c_cond
l_string|&quot;on&quot;
suffix:colon
l_string|&quot;off&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|driver-&gt;msr
op_amp
id|MSR_DCD
)paren
(brace
multiline_comment|/* DCD raised! */
id|wake_up_interruptible
c_func
(paren
op_amp
id|driver-&gt;open_wait
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* DCD falled */
id|DEBUG
c_func
(paren
l_int|0
comma
id|__FUNCTION__
l_string|&quot;():hangup..&bslash;n&quot;
)paren
suffix:semicolon
id|tty_hangup
c_func
(paren
id|driver-&gt;tty
)paren
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|driver-&gt;comm-&gt;flow_ctrl
op_amp
id|USE_CTS
)paren
(brace
r_if
c_cond
(paren
id|driver-&gt;tty-&gt;hw_stopped
)paren
(brace
r_if
c_cond
(paren
id|driver-&gt;msr
op_amp
id|MSR_CTS
)paren
(brace
id|DEBUG
c_func
(paren
l_int|0
comma
l_string|&quot;CTS tx start...&bslash;n&quot;
)paren
suffix:semicolon
id|driver-&gt;cts_stoptx
op_assign
l_int|0
suffix:semicolon
id|driver-&gt;tty-&gt;hw_stopped
op_assign
id|driver-&gt;ttp_stoptx
suffix:semicolon
multiline_comment|/*  &n;&t;&t;&t;&t; * replacement of &n;&t;&t;&t;&t; * rs_sched_event(info, RS_EVENT_WRITE_WAKEUP)&n;&t;&t;&t;&t; * in serial.c&n;&t;&t;&t;&t; */
r_if
c_cond
(paren
(paren
id|driver-&gt;tty-&gt;flags
op_amp
(paren
l_int|1
op_lshift
id|TTY_DO_WRITE_WAKEUP
)paren
)paren
op_logical_and
id|driver-&gt;tty-&gt;ldisc.write_wakeup
)paren
(paren
id|driver-&gt;tty-&gt;ldisc.write_wakeup
)paren
(paren
id|driver-&gt;tty
)paren
suffix:semicolon
id|wake_up_interruptible
c_func
(paren
op_amp
id|driver-&gt;tty-&gt;write_wait
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
)brace
r_else
(brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|driver-&gt;msr
op_amp
id|MSR_CTS
)paren
)paren
(brace
id|DEBUG
c_func
(paren
l_int|0
comma
l_string|&quot;CTS tx stop...&quot;
)paren
suffix:semicolon
id|driver-&gt;cts_stoptx
op_assign
l_int|1
suffix:semicolon
id|driver-&gt;tty-&gt;hw_stopped
op_assign
l_int|1
suffix:semicolon
)brace
)brace
)brace
r_break
suffix:semicolon
r_default
suffix:colon
id|DEBUG
c_func
(paren
l_int|0
comma
id|__FUNCTION__
l_string|&quot;():PI = 0x%02x is not implemented&bslash;n&quot;
comma
(paren
r_int
)paren
id|driver-&gt;comm-&gt;pi
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/*&n; ***********************************************************************&n; *&n; * driver kernel interfaces&n; * these functions work as an interface between the kernel and this driver&n; *&n; ***********************************************************************&n; */
multiline_comment|/*&n; * ----------------------------------------------------------------------&n; * irvtd_open() and friends&n; *&n; * ----------------------------------------------------------------------&n; */
DECL|function|irvtd_block_til_ready
r_static
r_int
id|irvtd_block_til_ready
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
comma
r_struct
id|file
op_star
id|filp
comma
r_struct
id|irvtd_cb
op_star
id|driver
)paren
(brace
r_struct
id|wait_queue
id|wait
op_assign
(brace
id|current
comma
l_int|NULL
)brace
suffix:semicolon
r_int
id|retval
op_assign
l_int|0
suffix:semicolon
r_int
id|do_clocal
op_assign
l_int|0
suffix:semicolon
multiline_comment|/*&n;&t; * If non-blocking mode is set, or the port is not enabled,&n;&t; * then make the check up front and then exit.&n;&t; */
r_if
c_cond
(paren
(paren
id|filp-&gt;f_flags
op_amp
id|O_NONBLOCK
)paren
op_logical_or
(paren
id|tty-&gt;flags
op_amp
(paren
l_int|1
op_lshift
id|TTY_IO_ERROR
)paren
)paren
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|tty-&gt;termios-&gt;c_cflag
op_amp
id|CLOCAL
)paren
id|do_clocal
op_assign
l_int|1
suffix:semicolon
multiline_comment|/*&n;&t; * We wait until ircomm_connect_request() succeed or&n;&t; *   ircomm_connect_indication comes&n;&t; */
id|add_wait_queue
c_func
(paren
op_amp
id|driver-&gt;open_wait
comma
op_amp
id|wait
)paren
suffix:semicolon
id|DEBUG
c_func
(paren
l_int|0
comma
id|__FUNCTION__
l_string|&quot;():before block( line = %d, count = %d )&bslash;n&quot;
comma
id|driver-&gt;line
comma
id|driver-&gt;count
)paren
suffix:semicolon
id|driver-&gt;blocked_open
op_increment
suffix:semicolon
multiline_comment|/* wait for a connection established */
r_while
c_loop
(paren
l_int|1
)paren
(brace
id|current-&gt;state
op_assign
id|TASK_INTERRUPTIBLE
suffix:semicolon
r_if
c_cond
(paren
id|driver-&gt;comm-&gt;state
op_eq
id|COMM_CONN
)paren
(brace
multiline_comment|/* &n;&t;&t;&t; * signal DTR and RTS&n;&t;&t;&t; */
id|driver-&gt;comm-&gt;dte
op_assign
id|driver-&gt;mcr
op_or_assign
(paren
id|MCR_DTR
op_or
id|MCR_RTS
op_or
id|DELTA_DTR
op_or
id|DELTA_RTS
)paren
suffix:semicolon
id|ircomm_control_request
c_func
(paren
id|driver-&gt;comm
comma
id|DTELINE_STATE
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|tty_hung_up_p
c_func
(paren
id|filp
)paren
op_logical_or
op_logical_neg
(paren
id|driver-&gt;flags
op_amp
id|ASYNC_INITIALIZED
)paren
)paren
(brace
macro_line|#ifdef DO_RESTART
r_if
c_cond
(paren
id|driver-&gt;flags
op_amp
id|ASYNC_HUP_NOTIFY
)paren
id|retval
op_assign
op_minus
id|EAGAIN
suffix:semicolon
r_else
id|retval
op_assign
op_minus
id|ERESTARTSYS
suffix:semicolon
macro_line|#else
id|retval
op_assign
op_minus
id|EAGAIN
suffix:semicolon
macro_line|#endif
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|driver-&gt;flags
op_amp
id|ASYNC_CLOSING
)paren
op_logical_and
(paren
id|driver-&gt;comm-&gt;state
op_eq
id|COMM_CONN
)paren
op_logical_and
(paren
id|do_clocal
op_logical_or
(paren
id|driver-&gt;msr
op_amp
id|MSR_DCD
)paren
)paren
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
id|signal_pending
c_func
(paren
id|current
)paren
)paren
(brace
id|retval
op_assign
op_minus
id|ERESTARTSYS
suffix:semicolon
r_break
suffix:semicolon
)brace
id|DEBUG
c_func
(paren
l_int|4
comma
id|__FUNCTION__
l_string|&quot;():blocking( %s%d, count = %d )&bslash;n&quot;
comma
id|tty-&gt;driver.name
comma
id|driver-&gt;line
comma
id|driver-&gt;count
)paren
suffix:semicolon
id|schedule
c_func
(paren
)paren
suffix:semicolon
)brace
id|current-&gt;state
op_assign
id|TASK_RUNNING
suffix:semicolon
id|remove_wait_queue
c_func
(paren
op_amp
id|driver-&gt;open_wait
comma
op_amp
id|wait
)paren
suffix:semicolon
id|driver-&gt;blocked_open
op_decrement
suffix:semicolon
id|DEBUG
c_func
(paren
l_int|0
comma
id|__FUNCTION__
l_string|&quot;():after blocking&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|retval
)paren
r_return
id|retval
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|change_speed
r_static
r_void
id|change_speed
c_func
(paren
r_struct
id|irvtd_cb
op_star
id|driver
)paren
(brace
r_int
id|cflag
comma
id|cval
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|driver-&gt;tty
op_logical_or
op_logical_neg
id|driver-&gt;tty-&gt;termios
op_logical_or
op_logical_neg
id|driver-&gt;comm
)paren
r_return
suffix:semicolon
id|cflag
op_assign
id|driver-&gt;tty-&gt;termios-&gt;c_cflag
suffix:semicolon
multiline_comment|/* &n;&t; * byte size and parity&n;&t; */
r_switch
c_cond
(paren
id|cflag
op_amp
id|CSIZE
)paren
(brace
r_case
id|CS5
suffix:colon
id|cval
op_assign
id|IRCOMM_WLEN5
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CS6
suffix:colon
id|cval
op_assign
id|IRCOMM_WLEN6
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CS7
suffix:colon
id|cval
op_assign
id|IRCOMM_WLEN7
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CS8
suffix:colon
id|cval
op_assign
id|IRCOMM_WLEN8
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|cval
op_assign
id|IRCOMM_WLEN5
suffix:semicolon
r_break
suffix:semicolon
multiline_comment|/* too keep GCC shut... */
)brace
r_if
c_cond
(paren
id|cflag
op_amp
id|CSTOPB
)paren
(brace
multiline_comment|/* use 2 stop bit mode */
id|cval
op_or_assign
id|IRCOMM_STOP2
suffix:semicolon
)brace
r_if
c_cond
(paren
id|cflag
op_amp
id|PARENB
)paren
id|cval
op_or_assign
id|IRCOMM_PARENB
suffix:semicolon
multiline_comment|/* enable parity check */
r_if
c_cond
(paren
op_logical_neg
(paren
id|cflag
op_amp
id|PARODD
)paren
)paren
id|cval
op_or_assign
id|IRCOMM_PAREVEN
suffix:semicolon
multiline_comment|/* even parity */
multiline_comment|/* CTS flow control flag and modem status interrupts */
r_if
c_cond
(paren
id|cflag
op_amp
id|CRTSCTS
)paren
id|driver-&gt;comm-&gt;flow_ctrl
op_or_assign
id|USE_CTS
suffix:semicolon
r_else
id|driver-&gt;comm-&gt;flow_ctrl
op_or_assign
op_complement
id|USE_CTS
suffix:semicolon
r_if
c_cond
(paren
id|cflag
op_amp
id|CLOCAL
)paren
id|driver-&gt;flags
op_and_assign
op_complement
id|ASYNC_CHECK_CD
suffix:semicolon
r_else
id|driver-&gt;flags
op_or_assign
id|ASYNC_CHECK_CD
suffix:semicolon
multiline_comment|/*&n;&t; * Set up parity check flag&n;&t; */
id|driver-&gt;read_status_mask
op_assign
id|LSR_OE
suffix:semicolon
r_if
c_cond
(paren
id|I_INPCK
c_func
(paren
id|driver-&gt;tty
)paren
)paren
id|driver-&gt;read_status_mask
op_or_assign
id|LSR_FE
op_or
id|LSR_PE
suffix:semicolon
r_if
c_cond
(paren
id|I_BRKINT
c_func
(paren
id|driver-&gt;tty
)paren
op_logical_or
id|I_PARMRK
c_func
(paren
id|driver-&gt;tty
)paren
)paren
id|driver-&gt;read_status_mask
op_or_assign
id|LSR_BI
suffix:semicolon
multiline_comment|/*&n;&t; * Characters to ignore&n;&t; */
id|driver-&gt;ignore_status_mask
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|I_IGNPAR
c_func
(paren
id|driver-&gt;tty
)paren
)paren
id|driver-&gt;ignore_status_mask
op_or_assign
id|LSR_PE
op_or
id|LSR_FE
suffix:semicolon
r_if
c_cond
(paren
id|I_IGNBRK
c_func
(paren
id|driver-&gt;tty
)paren
)paren
(brace
id|driver-&gt;ignore_status_mask
op_or_assign
id|LSR_BI
suffix:semicolon
multiline_comment|/*&n;&t;&t; * If we&squot;re ignore parity and break indicators, ignore &n;&t;&t; * overruns too.  (For real raw support).&n;&t;&t; */
r_if
c_cond
(paren
id|I_IGNPAR
c_func
(paren
id|driver-&gt;tty
)paren
)paren
id|driver-&gt;ignore_status_mask
op_or_assign
id|LSR_OE
suffix:semicolon
)brace
id|driver-&gt;comm-&gt;data_format
op_assign
id|cval
suffix:semicolon
id|ircomm_control_request
c_func
(paren
id|driver-&gt;comm
comma
id|DATA_FORMAT
)paren
suffix:semicolon
id|ircomm_control_request
c_func
(paren
id|driver-&gt;comm
comma
id|FLOW_CONTROL
)paren
suffix:semicolon
)brace
DECL|function|irvtd_startup
r_static
r_int
id|irvtd_startup
c_func
(paren
r_struct
id|irvtd_cb
op_star
id|driver
)paren
(brace
r_int
id|retval
op_assign
l_int|0
suffix:semicolon
r_struct
id|ias_object
op_star
id|obj
suffix:semicolon
r_struct
id|notify_t
id|irvtd_notify
suffix:semicolon
multiline_comment|/* FIXME: it should not be hard coded */
id|__u8
id|oct_seq
(braket
l_int|6
)braket
op_assign
(brace
l_int|0
comma
l_int|1
comma
l_int|4
comma
l_int|1
comma
l_int|1
comma
l_int|1
)brace
suffix:semicolon
id|DEBUG
c_func
(paren
l_int|4
comma
id|__FUNCTION__
l_string|&quot;()&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|driver-&gt;flags
op_amp
id|ASYNC_INITIALIZED
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * initialize our tx/rx buffer&n;&t; */
id|skb_queue_head_init
c_func
(paren
op_amp
id|driver-&gt;rxbuff
)paren
suffix:semicolon
id|driver-&gt;txbuff
op_assign
id|dev_alloc_skb
c_func
(paren
id|COMM_DEFAULT_DATA_SIZE
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|driver-&gt;txbuff
)paren
(brace
id|DEBUG
c_func
(paren
l_int|0
comma
id|__FUNCTION__
l_string|&quot;():alloc_skb failed!&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|skb_reserve
c_func
(paren
id|driver-&gt;txbuff
comma
id|COMM_HEADER_SIZE
)paren
suffix:semicolon
id|irda_notify_init
c_func
(paren
op_amp
id|irvtd_notify
)paren
suffix:semicolon
id|irvtd_notify.data_indication
op_assign
id|irvtd_receive_data
suffix:semicolon
id|irvtd_notify.connect_confirm
op_assign
id|irvtd_connect_confirm
suffix:semicolon
id|irvtd_notify.connect_indication
op_assign
id|irvtd_connect_indication
suffix:semicolon
id|irvtd_notify.disconnect_indication
op_assign
id|irvtd_disconnect_indication
suffix:semicolon
id|irvtd_notify.flow_indication
op_assign
id|irvtd_control_indication
suffix:semicolon
id|strncpy
c_func
(paren
id|irvtd_notify.name
comma
l_string|&quot;ircomm_tty&quot;
comma
id|NOTIFY_MAX_NAME
)paren
suffix:semicolon
id|irvtd_notify.instance
op_assign
id|driver
suffix:semicolon
id|driver-&gt;comm
op_assign
id|ircomm_open_instance
c_func
(paren
id|irvtd_notify
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|driver-&gt;comm
)paren
(brace
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
multiline_comment|/* &n;         *  Register with LM-IAS as a server&n;         */
id|obj
op_assign
id|irias_new_object
c_func
(paren
l_string|&quot;IrDA:IrCOMM&quot;
comma
id|IAS_IRCOMM_ID
)paren
suffix:semicolon
id|irias_add_integer_attrib
c_func
(paren
id|obj
comma
l_string|&quot;IrDA:TinyTP:LsapSel&quot;
comma
id|driver-&gt;comm-&gt;tsap-&gt;stsap_sel
)paren
suffix:semicolon
id|irias_add_octseq_attrib
c_func
(paren
id|obj
comma
l_string|&quot;Parameters&quot;
comma
op_amp
id|oct_seq
(braket
l_int|0
)braket
comma
l_int|6
)paren
suffix:semicolon
id|irias_insert_object
c_func
(paren
id|obj
)paren
suffix:semicolon
id|driver-&gt;flags
op_or_assign
id|ASYNC_INITIALIZED
suffix:semicolon
multiline_comment|/*&n;&t; * discover a peer device&n;&t; *&t;   TODO: other servicetype(i.e. 3wire,3wireraw) support&n;&t; */
id|retval
op_assign
id|ircomm_query_ias_and_connect
c_func
(paren
id|driver-&gt;comm
comma
id|NINE_WIRE
)paren
suffix:semicolon
r_if
c_cond
(paren
id|retval
)paren
(brace
id|DEBUG
c_func
(paren
l_int|0
comma
id|__FUNCTION__
l_string|&quot;(): ircomm_query_ias returns %d&bslash;n&quot;
comma
id|retval
)paren
suffix:semicolon
r_return
id|retval
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * TODO:we have to initialize control-channel here!&n;&t; *   i.e.set something into RTS,CTS and so on....&n;&t; */
r_if
c_cond
(paren
id|driver-&gt;tty
)paren
id|clear_bit
c_func
(paren
id|TTY_IO_ERROR
comma
op_amp
id|driver-&gt;tty-&gt;flags
)paren
suffix:semicolon
id|change_speed
c_func
(paren
id|driver
)paren
suffix:semicolon
id|irvtd_start_timer
c_func
(paren
id|driver
)paren
suffix:semicolon
id|driver-&gt;rx_disable
op_assign
l_int|0
suffix:semicolon
id|driver-&gt;tx_disable
op_assign
l_int|1
suffix:semicolon
id|driver-&gt;disconnect_pend
op_assign
l_int|0
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|irvtd_open
r_int
id|irvtd_open
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
comma
r_struct
id|file
op_star
id|filp
)paren
(brace
r_struct
id|irvtd_cb
op_star
id|driver
suffix:semicolon
r_int
id|retval
suffix:semicolon
r_int
id|line
suffix:semicolon
id|DEBUG
c_func
(paren
l_int|4
comma
id|__FUNCTION__
l_string|&quot;():&bslash;n&quot;
)paren
suffix:semicolon
id|MOD_INC_USE_COUNT
suffix:semicolon
id|line
op_assign
id|MINOR
c_func
(paren
id|tty-&gt;device
)paren
op_minus
id|tty-&gt;driver.minor_start
suffix:semicolon
r_if
c_cond
(paren
(paren
id|line
OL
l_int|0
)paren
op_logical_or
(paren
id|line
op_ge
id|COMM_MAX_TTY
)paren
)paren
(brace
id|MOD_DEC_USE_COUNT
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
id|driver
op_assign
id|irvtd
(braket
id|line
)braket
suffix:semicolon
id|ASSERT
c_func
(paren
id|driver
op_ne
l_int|NULL
comma
id|MOD_DEC_USE_COUNT
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|driver-&gt;magic
op_eq
id|IRVTD_MAGIC
comma
id|MOD_DEC_USE_COUNT
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)paren
suffix:semicolon
id|driver-&gt;count
op_increment
suffix:semicolon
id|DEBUG
c_func
(paren
l_int|0
comma
id|__FUNCTION__
l_string|&quot;():%s%d count %d&bslash;n&quot;
comma
id|tty-&gt;driver.name
comma
id|line
comma
id|driver-&gt;count
)paren
suffix:semicolon
id|tty-&gt;driver_data
op_assign
id|driver
suffix:semicolon
id|driver-&gt;tty
op_assign
id|tty
suffix:semicolon
id|driver-&gt;tty-&gt;low_latency
op_assign
(paren
id|driver-&gt;flags
op_amp
id|ASYNC_LOW_LATENCY
)paren
ques
c_cond
l_int|1
suffix:colon
l_int|0
suffix:semicolon
multiline_comment|/*&n;&t; * If the device is in the middle of being closed, then block&n;&t; * (sleep) until it&squot;s done, then exit.&n;&t; */
r_if
c_cond
(paren
id|tty_hung_up_p
c_func
(paren
id|filp
)paren
op_logical_or
(paren
id|driver-&gt;flags
op_amp
id|ASYNC_CLOSING
)paren
)paren
(brace
r_if
c_cond
(paren
id|driver-&gt;flags
op_amp
id|ASYNC_CLOSING
)paren
id|interruptible_sleep_on
c_func
(paren
op_amp
id|driver-&gt;close_wait
)paren
suffix:semicolon
macro_line|#ifdef DO_RESTART
r_if
c_cond
(paren
id|driver-&gt;flags
op_amp
id|ASYNC_HUP_NOTIFY
)paren
r_return
op_minus
id|EAGAIN
suffix:semicolon
r_else
r_return
op_minus
id|ERESTARTSYS
suffix:semicolon
macro_line|#else
r_return
op_minus
id|EAGAIN
suffix:semicolon
macro_line|#endif
)brace
multiline_comment|/* &n;&t; * start up discovering process and ircomm_layer &n;&t; */
id|retval
op_assign
id|irvtd_startup
c_func
(paren
id|driver
)paren
suffix:semicolon
r_if
c_cond
(paren
id|retval
)paren
(brace
id|DEBUG
c_func
(paren
l_int|0
comma
id|__FUNCTION__
l_string|&quot;():irvtd_startup returns %d&bslash;n&quot;
comma
id|retval
)paren
suffix:semicolon
r_return
id|retval
suffix:semicolon
)brace
id|retval
op_assign
id|irvtd_block_til_ready
c_func
(paren
id|tty
comma
id|filp
comma
id|driver
)paren
suffix:semicolon
r_if
c_cond
(paren
id|retval
)paren
(brace
id|DEBUG
c_func
(paren
l_int|0
comma
id|__FUNCTION__
l_string|&quot;():returning after block_til_ready (errno = %d)&bslash;n&quot;
comma
id|retval
)paren
suffix:semicolon
r_return
id|retval
suffix:semicolon
)brace
id|driver-&gt;session
op_assign
id|current-&gt;session
suffix:semicolon
id|driver-&gt;pgrp
op_assign
id|current-&gt;pgrp
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * ----------------------------------------------------------------------&n; * irvtd_close() and friends&n; *&n; * most of this function is stolen from serial.c&n; * ----------------------------------------------------------------------&n; */
multiline_comment|/*&n; * Function irvtd_wait_until_sent (tty, timeout)&n; *&n; *    wait until Tx queue of IrTTP is empty &n; *&n; */
DECL|function|irvtd_wait_until_sent
r_static
r_void
id|irvtd_wait_until_sent
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
comma
r_int
id|timeout
)paren
(brace
r_struct
id|irvtd_cb
op_star
id|driver
op_assign
(paren
r_struct
id|irvtd_cb
op_star
)paren
id|tty-&gt;driver_data
suffix:semicolon
r_int
r_int
id|orig_jiffies
suffix:semicolon
id|ASSERT
c_func
(paren
id|driver
op_ne
l_int|NULL
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|driver-&gt;magic
op_eq
id|IRVTD_MAGIC
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|driver-&gt;comm
op_ne
l_int|NULL
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
id|DEBUG
c_func
(paren
l_int|0
comma
id|__FUNCTION__
l_string|&quot;():&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|tty-&gt;closing
)paren
(brace
r_return
suffix:semicolon
)brace
multiline_comment|/* nothing to do */
multiline_comment|/* &n;&t; * at disconnection, we should wait until Tx queue of IrTTP is&n;&t; * flushed&n;&t; */
id|ircomm_disconnect_request
c_func
(paren
id|driver-&gt;comm
comma
l_int|NULL
comma
id|P_NORMAL
)paren
suffix:semicolon
id|orig_jiffies
op_assign
id|jiffies
suffix:semicolon
r_while
c_loop
(paren
id|driver-&gt;comm-&gt;tsap-&gt;disconnect_pend
)paren
(brace
id|DEBUG
c_func
(paren
l_int|0
comma
id|__FUNCTION__
l_string|&quot;():wait..&bslash;n&quot;
)paren
suffix:semicolon
id|current-&gt;state
op_assign
id|TASK_INTERRUPTIBLE
suffix:semicolon
id|current-&gt;counter
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* make us low-priority */
id|schedule_timeout
c_func
(paren
id|HZ
)paren
suffix:semicolon
multiline_comment|/* 1sec */
r_if
c_cond
(paren
id|signal_pending
c_func
(paren
id|current
)paren
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
id|timeout
op_logical_and
id|time_after
c_func
(paren
id|jiffies
comma
id|orig_jiffies
op_plus
id|timeout
)paren
)paren
r_break
suffix:semicolon
)brace
id|current-&gt;state
op_assign
id|TASK_RUNNING
suffix:semicolon
)brace
DECL|function|irvtd_shutdown
r_static
r_void
id|irvtd_shutdown
c_func
(paren
r_struct
id|irvtd_cb
op_star
id|driver
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|driver-&gt;flags
op_amp
id|ASYNC_INITIALIZED
)paren
)paren
r_return
suffix:semicolon
id|DEBUG
c_func
(paren
l_int|0
comma
id|__FUNCTION__
l_string|&quot;()&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * This comment is written in serial.c:&n;&t; *&n;&t; * clear delta_msr_wait queue to avoid mem leaks: we may free the irq&n;&t; * here so the queue might never be waken up&n;&t; */
id|wake_up_interruptible
c_func
(paren
op_amp
id|driver-&gt;delta_msr_wait
)paren
suffix:semicolon
multiline_comment|/* clear DTR and RTS */
r_if
c_cond
(paren
op_logical_neg
id|driver-&gt;tty
op_logical_or
(paren
id|driver-&gt;tty-&gt;termios-&gt;c_cflag
op_amp
id|HUPCL
)paren
)paren
id|driver-&gt;mcr
op_and_assign
op_complement
(paren
id|MCR_DTR
op_or
id|MCR_RTS
)paren
suffix:semicolon
id|driver-&gt;comm-&gt;dte
op_assign
id|driver-&gt;mcr
suffix:semicolon
id|ircomm_control_request
c_func
(paren
id|driver-&gt;comm
comma
id|DTELINE_STATE
)paren
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* Disable interrupts */
r_if
c_cond
(paren
id|driver-&gt;tty
)paren
id|set_bit
c_func
(paren
id|TTY_IO_ERROR
comma
op_amp
id|driver-&gt;tty-&gt;flags
)paren
suffix:semicolon
id|del_timer
c_func
(paren
op_amp
id|driver-&gt;timer
)paren
suffix:semicolon
id|irias_delete_object
c_func
(paren
l_string|&quot;IrDA:IrCOMM&quot;
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Free the transmit buffer here &n;&t; */
r_while
c_loop
(paren
id|skb_queue_len
c_func
(paren
op_amp
id|driver-&gt;rxbuff
)paren
)paren
(brace
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
id|skb
op_assign
id|skb_dequeue
c_func
(paren
op_amp
id|driver-&gt;rxbuff
)paren
suffix:semicolon
id|dev_kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|driver-&gt;txbuff
)paren
(brace
id|dev_kfree_skb
c_func
(paren
id|driver-&gt;txbuff
)paren
suffix:semicolon
id|driver-&gt;txbuff
op_assign
l_int|NULL
suffix:semicolon
)brace
id|ircomm_close_instance
c_func
(paren
id|driver-&gt;comm
)paren
suffix:semicolon
id|driver-&gt;comm
op_assign
l_int|NULL
suffix:semicolon
id|driver-&gt;flags
op_and_assign
op_complement
id|ASYNC_INITIALIZED
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
DECL|function|irvtd_close
r_void
id|irvtd_close
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
comma
r_struct
id|file
op_star
id|filp
)paren
(brace
r_struct
id|irvtd_cb
op_star
id|driver
op_assign
(paren
r_struct
id|irvtd_cb
op_star
)paren
id|tty-&gt;driver_data
suffix:semicolon
r_int
id|line
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|DEBUG
c_func
(paren
l_int|0
comma
id|__FUNCTION__
l_string|&quot;():refcount= %d&bslash;n&quot;
comma
id|irvtd_refcount
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|driver
op_ne
l_int|NULL
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|driver-&gt;magic
op_eq
id|IRVTD_MAGIC
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tty_hung_up_p
c_func
(paren
id|filp
)paren
)paren
(brace
multiline_comment|/*&n;&t;&t; * upper tty layer caught a HUP signal and called irvtd_hangup()&n;&t;&t; * before. so we do nothing here.&n;&t;&t; */
id|DEBUG
c_func
(paren
l_int|0
comma
id|__FUNCTION__
l_string|&quot;():tty_hung_up_p.&bslash;n&quot;
)paren
suffix:semicolon
id|MOD_DEC_USE_COUNT
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|line
op_assign
id|MINOR
c_func
(paren
id|tty-&gt;device
)paren
op_minus
id|tty-&gt;driver.minor_start
suffix:semicolon
id|DEBUG
c_func
(paren
l_int|0
comma
id|__FUNCTION__
l_string|&quot;():%s%d count %d&bslash;n&quot;
comma
id|tty-&gt;driver.name
comma
id|line
comma
id|driver-&gt;count
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|tty-&gt;count
op_eq
l_int|1
)paren
op_logical_and
(paren
id|driver-&gt;count
op_ne
l_int|1
)paren
)paren
(brace
multiline_comment|/*&n;&t;&t; * Uh, oh.  tty-&gt;count is 1, which means that the tty&n;&t;&t; * structure will be freed.  Driver-&gt;count should always&n;&t;&t; * be one in these conditions.  If it&squot;s greater than&n;&t;&t; * one, we&squot;ve got real problems, since it means the&n;&t;&t; * ircomm service layer won&squot;t be shutdown.&n;&t;&t; */
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;irvtd_close: bad serial port count;&quot;
l_string|&quot;tty-&gt;count is 1, but driver-&gt;count is %d&bslash;n&quot;
comma
id|driver-&gt;count
)paren
suffix:semicolon
id|driver-&gt;count
op_assign
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
op_decrement
id|driver-&gt;count
OL
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;irvtd_close: bad count for line%d: %d&bslash;n&quot;
comma
id|line
comma
id|driver-&gt;count
)paren
suffix:semicolon
id|driver-&gt;count
op_assign
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|driver-&gt;count
)paren
(brace
multiline_comment|/* do nothing */
id|DEBUG
c_func
(paren
l_int|0
comma
id|__FUNCTION__
l_string|&quot;():driver-&gt;count is not 0&bslash;n&quot;
)paren
suffix:semicolon
id|MOD_DEC_USE_COUNT
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|driver-&gt;flags
op_or_assign
id|ASYNC_CLOSING
suffix:semicolon
multiline_comment|/*&n;&t; * Now we wait for the transmit buffer to clear; and we notify &n;&t; * the line discipline to only process XON/XOFF characters.&n;&t; */
id|tty-&gt;closing
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|driver-&gt;closing_wait
op_ne
id|ASYNC_CLOSING_WAIT_NONE
)paren
(brace
id|DEBUG
c_func
(paren
l_int|4
comma
id|__FUNCTION__
l_string|&quot;():calling tty_wait_until_sent()&bslash;n&quot;
)paren
suffix:semicolon
id|tty_wait_until_sent
c_func
(paren
id|tty
comma
id|driver-&gt;closing_wait
)paren
suffix:semicolon
)brace
multiline_comment|/* &n;&t; * we can send disconnect_request with P_HIGH since&n;&t; * tty_wait_until_sent() and irvtd_wait_until_sent() should&n;&t; * have disconnected the link&n;&t; */
id|ircomm_disconnect_request
c_func
(paren
id|driver-&gt;comm
comma
l_int|NULL
comma
id|P_HIGH
)paren
suffix:semicolon
multiline_comment|/* &n;&t; * Now we stop accepting input.&n;&t; */
id|driver-&gt;rx_disable
op_assign
id|TRUE
suffix:semicolon
multiline_comment|/* drop ldisc&squot;s buffer */
r_if
c_cond
(paren
id|tty-&gt;ldisc.flush_buffer
)paren
id|tty-&gt;ldisc
dot
id|flush_buffer
c_func
(paren
id|tty
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tty-&gt;driver.flush_buffer
)paren
id|tty-&gt;driver
dot
id|flush_buffer
c_func
(paren
id|driver-&gt;tty
)paren
suffix:semicolon
id|tty-&gt;closing
op_assign
l_int|0
suffix:semicolon
id|driver-&gt;tty
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
id|driver-&gt;blocked_open
)paren
(brace
r_if
c_cond
(paren
id|driver-&gt;close_delay
)paren
(brace
multiline_comment|/* kill time */
id|current-&gt;state
op_assign
id|TASK_INTERRUPTIBLE
suffix:semicolon
id|schedule_timeout
c_func
(paren
id|driver-&gt;close_delay
)paren
suffix:semicolon
)brace
id|wake_up_interruptible
c_func
(paren
op_amp
id|driver-&gt;open_wait
)paren
suffix:semicolon
)brace
id|irvtd_shutdown
c_func
(paren
id|driver
)paren
suffix:semicolon
id|driver-&gt;flags
op_and_assign
op_complement
id|ASYNC_CLOSING
suffix:semicolon
id|wake_up_interruptible
c_func
(paren
op_amp
id|driver-&gt;close_wait
)paren
suffix:semicolon
id|MOD_DEC_USE_COUNT
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|DEBUG
c_func
(paren
l_int|4
comma
id|__FUNCTION__
l_string|&quot;():done&bslash;n&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * ----------------------------------------------------------------------&n; * irvtd_write() and friends&n; * This routine will be called when something data are passed from&n; * kernel or user.&n; * ----------------------------------------------------------------------&n; */
DECL|function|irvtd_write
r_int
id|irvtd_write
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
comma
r_int
id|from_user
comma
r_const
r_int
r_char
op_star
id|buf
comma
r_int
id|count
)paren
(brace
r_struct
id|irvtd_cb
op_star
id|driver
suffix:semicolon
r_int
id|c
op_assign
l_int|0
suffix:semicolon
r_int
id|wrote
op_assign
l_int|0
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
id|__u8
op_star
id|frame
suffix:semicolon
id|ASSERT
c_func
(paren
id|tty
op_ne
l_int|NULL
comma
r_return
op_minus
id|EFAULT
suffix:semicolon
)paren
suffix:semicolon
id|driver
op_assign
(paren
r_struct
id|irvtd_cb
op_star
)paren
id|tty-&gt;driver_data
suffix:semicolon
id|ASSERT
c_func
(paren
id|driver
op_ne
l_int|NULL
comma
r_return
op_minus
id|EFAULT
suffix:semicolon
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|driver-&gt;magic
op_eq
id|IRVTD_MAGIC
comma
r_return
op_minus
id|EFAULT
suffix:semicolon
)paren
suffix:semicolon
id|DEBUG
c_func
(paren
l_int|4
comma
id|__FUNCTION__
l_string|&quot;()&bslash;n&quot;
)paren
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_while
c_loop
(paren
l_int|1
)paren
(brace
id|cli
c_func
(paren
)paren
suffix:semicolon
id|skb
op_assign
id|driver-&gt;txbuff
suffix:semicolon
id|ASSERT
c_func
(paren
id|skb
op_ne
l_int|NULL
comma
r_break
suffix:semicolon
)paren
suffix:semicolon
id|c
op_assign
id|MIN
c_func
(paren
id|count
comma
(paren
id|skb_tailroom
c_func
(paren
id|skb
)paren
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|c
op_le
l_int|0
)paren
r_break
suffix:semicolon
multiline_comment|/* write to the frame */
id|frame
op_assign
id|skb_put
c_func
(paren
id|skb
comma
id|c
)paren
suffix:semicolon
r_if
c_cond
(paren
id|from_user
)paren
(brace
id|copy_from_user
c_func
(paren
id|frame
comma
id|buf
comma
id|c
)paren
suffix:semicolon
)brace
r_else
id|memcpy
c_func
(paren
id|frame
comma
id|buf
comma
id|c
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|wrote
op_add_assign
id|c
suffix:semicolon
id|count
op_sub_assign
id|c
suffix:semicolon
id|buf
op_add_assign
id|c
suffix:semicolon
)brace
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
(paren
id|wrote
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Function irvtd_put_char (tty, ch)&n; *&n; *    This routine is called by the kernel to pass a single character.&n; *    If we exausted our buffer,we can ignore the character!&n; *&n; */
DECL|function|irvtd_put_char
r_void
id|irvtd_put_char
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
comma
r_int
r_char
id|ch
)paren
(brace
id|__u8
op_star
id|frame
suffix:semicolon
r_struct
id|irvtd_cb
op_star
id|driver
op_assign
(paren
r_struct
id|irvtd_cb
op_star
)paren
id|tty-&gt;driver_data
suffix:semicolon
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|ASSERT
c_func
(paren
id|driver
op_ne
l_int|NULL
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
id|DEBUG
c_func
(paren
l_int|4
comma
id|__FUNCTION__
l_string|&quot;()&bslash;n&quot;
)paren
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|skb
op_assign
id|driver-&gt;txbuff
suffix:semicolon
id|ASSERT
c_func
(paren
id|skb
op_ne
l_int|NULL
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|skb_tailroom
c_func
(paren
id|skb
)paren
OG
l_int|0
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
id|DEBUG
c_func
(paren
l_int|4
comma
l_string|&quot;irvtd_put_char(0x%02x) skb_len(%d) MAX(%d):&bslash;n&quot;
comma
(paren
r_int
)paren
id|ch
comma
(paren
r_int
)paren
id|skb-&gt;len
comma
id|driver-&gt;comm-&gt;max_txbuff_size
op_minus
id|COMM_HEADER_SIZE
)paren
suffix:semicolon
multiline_comment|/* append a character  */
id|frame
op_assign
id|skb_put
c_func
(paren
id|skb
comma
l_int|1
)paren
suffix:semicolon
id|frame
(braket
l_int|0
)braket
op_assign
id|ch
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/*&n; * Function irvtd_write_room (tty)&n; *&n; *    This routine returns the room that our buffer has now.&n; *&n; */
DECL|function|irvtd_write_room
r_int
(def_block
id|irvtd_write_room
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
)paren
(brace
r_int
id|ret
suffix:semicolon
r_struct
id|sk_buff
op_star
id|skb
op_assign
(paren
(paren
r_struct
id|irvtd_cb
op_star
)paren
id|tty-&gt;driver_data
)paren
op_member_access_from_pointer
id|txbuff
suffix:semicolon
id|ASSERT
c_func
(paren
id|skb
op_ne
l_int|NULL
comma
r_return
l_int|0
suffix:semicolon
)paren
suffix:semicolon
id|ret
op_assign
id|skb_tailroom
c_func
(paren
id|skb
)paren
suffix:semicolon
id|DEBUG
c_func
(paren
l_int|4
comma
id|__FUNCTION__
l_string|&quot;(): room is %d bytes&bslash;n&quot;
comma
id|ret
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
)def_block
multiline_comment|/*&n; * Function irvtd_chars_in_buffer (tty)&n; *&n; *    This function returns how many characters which have not been sent yet &n; *    are still in buffer.&n; *&n; */
DECL|function|irvtd_chars_in_buffer
r_int
(def_block
id|irvtd_chars_in_buffer
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
)paren
(brace
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|DEBUG
c_func
(paren
l_int|4
comma
id|__FUNCTION__
l_string|&quot;()&bslash;n&quot;
)paren
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|skb
op_assign
(paren
(paren
r_struct
id|irvtd_cb
op_star
)paren
id|tty-&gt;driver_data
)paren
op_member_access_from_pointer
id|txbuff
suffix:semicolon
r_if
c_cond
(paren
id|skb
op_eq
l_int|NULL
)paren
(brace
r_goto
id|err
suffix:semicolon
)brace
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
(paren
id|skb-&gt;len
)paren
suffix:semicolon
id|err
suffix:colon
id|ASSERT
c_func
(paren
id|skb
op_ne
l_int|NULL
comma
suffix:semicolon
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
multiline_comment|/* why not -EFAULT or such? see driver/char/serial.c */
)brace
)def_block
multiline_comment|/*&n; * Function irvtd_break (tty, break_state)&n; *&n; *    Routine which turns the break handling on or off&n; *&n; */
DECL|function|irvtd_break
r_static
r_void
(def_block
id|irvtd_break
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
comma
r_int
id|break_state
)paren
(brace
r_struct
id|irvtd_cb
op_star
id|driver
op_assign
(paren
r_struct
id|irvtd_cb
op_star
)paren
id|tty-&gt;driver_data
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|DEBUG
c_func
(paren
l_int|0
comma
id|__FUNCTION__
l_string|&quot;()&bslash;n&quot;
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|tty-&gt;driver_data
op_ne
l_int|NULL
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|driver-&gt;magic
op_eq
id|IRVTD_MAGIC
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|break_state
op_eq
op_minus
l_int|1
)paren
(brace
id|driver-&gt;comm-&gt;break_signal
op_assign
l_int|0x01
suffix:semicolon
id|ircomm_control_request
c_func
(paren
id|driver-&gt;comm
comma
id|BREAK_SIGNAL
)paren
suffix:semicolon
)brace
r_else
(brace
id|driver-&gt;comm-&gt;break_signal
op_assign
l_int|0x00
suffix:semicolon
id|ircomm_control_request
c_func
(paren
id|driver-&gt;comm
comma
id|BREAK_SIGNAL
)paren
suffix:semicolon
)brace
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
)def_block
multiline_comment|/*&n; * ----------------------------------------------------------------------&n; * irvtd_ioctl() and friends&n; * This routine allows us to implement device-specific ioctl&squot;s.&n; * If passed ioctl number (i.e.cmd) is unknown one, we should return &n; * ENOIOCTLCMD.&n; *&n; * TODO: we can&squot;t use setserial on IrCOMM because some ioctls are not implemented.&n; * we should add some ioctls and make some tool which is resemble to setserial.&n; * ----------------------------------------------------------------------&n; */
DECL|function|get_modem_info
r_static
r_int
id|get_modem_info
c_func
(paren
r_struct
id|irvtd_cb
op_star
id|driver
comma
r_int
r_int
op_star
id|value
)paren
(brace
r_int
r_int
id|result
suffix:semicolon
id|result
op_assign
(paren
(paren
id|driver-&gt;mcr
op_amp
id|MCR_RTS
)paren
ques
c_cond
id|TIOCM_RTS
suffix:colon
l_int|0
)paren
op_or
(paren
(paren
id|driver-&gt;mcr
op_amp
id|MCR_DTR
)paren
ques
c_cond
id|TIOCM_DTR
suffix:colon
l_int|0
)paren
op_or
(paren
(paren
id|driver-&gt;msr
op_amp
id|DELTA_DCD
)paren
ques
c_cond
id|TIOCM_CAR
suffix:colon
l_int|0
)paren
op_or
(paren
(paren
id|driver-&gt;msr
op_amp
id|DELTA_RI
)paren
ques
c_cond
id|TIOCM_RNG
suffix:colon
l_int|0
)paren
op_or
(paren
(paren
id|driver-&gt;msr
op_amp
id|DELTA_DSR
)paren
ques
c_cond
id|TIOCM_DSR
suffix:colon
l_int|0
)paren
op_or
(paren
(paren
id|driver-&gt;msr
op_amp
id|DELTA_CTS
)paren
ques
c_cond
id|TIOCM_CTS
suffix:colon
l_int|0
)paren
suffix:semicolon
r_return
id|put_user
c_func
(paren
id|result
comma
id|value
)paren
suffix:semicolon
)brace
DECL|function|set_modem_info
r_static
r_int
id|set_modem_info
c_func
(paren
r_struct
id|irvtd_cb
op_star
id|driver
comma
r_int
r_int
id|cmd
comma
r_int
r_int
op_star
id|value
)paren
(brace
r_int
id|error
suffix:semicolon
r_int
r_int
id|arg
suffix:semicolon
id|error
op_assign
id|get_user
c_func
(paren
id|arg
comma
id|value
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
)paren
(brace
r_return
id|error
suffix:semicolon
)brace
r_switch
c_cond
(paren
id|cmd
)paren
(brace
r_case
id|TIOCMBIS
suffix:colon
r_if
c_cond
(paren
id|arg
op_amp
id|TIOCM_RTS
)paren
id|driver-&gt;mcr
op_or_assign
id|MCR_RTS
suffix:semicolon
r_if
c_cond
(paren
id|arg
op_amp
id|TIOCM_DTR
)paren
id|driver-&gt;mcr
op_or_assign
id|MCR_DTR
suffix:semicolon
r_break
suffix:semicolon
r_case
id|TIOCMBIC
suffix:colon
r_if
c_cond
(paren
id|arg
op_amp
id|TIOCM_RTS
)paren
id|driver-&gt;mcr
op_and_assign
op_complement
id|MCR_RTS
suffix:semicolon
r_if
c_cond
(paren
id|arg
op_amp
id|TIOCM_DTR
)paren
id|driver-&gt;mcr
op_and_assign
op_complement
id|MCR_DTR
suffix:semicolon
r_break
suffix:semicolon
r_case
id|TIOCMSET
suffix:colon
id|driver-&gt;mcr
op_assign
(paren
(paren
id|driver-&gt;mcr
op_amp
op_complement
(paren
id|MCR_RTS
op_or
id|MCR_DTR
)paren
)paren
op_or
(paren
(paren
id|arg
op_amp
id|TIOCM_RTS
)paren
ques
c_cond
id|MCR_RTS
suffix:colon
l_int|0
)paren
op_or
(paren
(paren
id|arg
op_amp
id|TIOCM_DTR
)paren
ques
c_cond
id|MCR_DTR
suffix:colon
l_int|0
)paren
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|driver-&gt;comm-&gt;dte
op_assign
id|driver-&gt;mcr
suffix:semicolon
id|ircomm_control_request
c_func
(paren
id|driver-&gt;comm
comma
id|DTELINE_STATE
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|get_serial_info
r_static
r_int
id|get_serial_info
c_func
(paren
r_struct
id|irvtd_cb
op_star
id|driver
comma
r_struct
id|serial_struct
op_star
id|retinfo
)paren
(brace
r_struct
id|serial_struct
id|tmp
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|retinfo
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
id|memset
c_func
(paren
op_amp
id|tmp
comma
l_int|0
comma
r_sizeof
(paren
id|tmp
)paren
)paren
suffix:semicolon
id|tmp.line
op_assign
id|driver-&gt;line
suffix:semicolon
id|tmp.flags
op_assign
id|driver-&gt;flags
suffix:semicolon
id|tmp.baud_base
op_assign
id|driver-&gt;comm-&gt;data_rate
suffix:semicolon
id|tmp.close_delay
op_assign
id|driver-&gt;close_delay
suffix:semicolon
id|tmp.closing_wait
op_assign
id|driver-&gt;closing_wait
suffix:semicolon
multiline_comment|/* for compatibility  */
id|tmp.type
op_assign
id|PORT_16550A
suffix:semicolon
id|tmp.port
op_assign
l_int|0
suffix:semicolon
id|tmp.irq
op_assign
l_int|0
suffix:semicolon
id|tmp.xmit_fifo_size
op_assign
l_int|0
suffix:semicolon
id|tmp.hub6
op_assign
l_int|0
suffix:semicolon
id|tmp.custom_divisor
op_assign
id|driver-&gt;custom_divisor
suffix:semicolon
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
id|retinfo
comma
op_amp
id|tmp
comma
r_sizeof
(paren
op_star
id|retinfo
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|set_serial_info
r_static
r_int
id|set_serial_info
c_func
(paren
r_struct
id|irvtd_cb
op_star
id|driver
comma
r_struct
id|serial_struct
op_star
id|new_info
)paren
(brace
r_struct
id|serial_struct
id|new_serial
suffix:semicolon
r_struct
id|irvtd_cb
id|old_driver
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|new_serial
comma
id|new_info
comma
r_sizeof
(paren
id|new_serial
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
id|old_driver
op_assign
op_star
id|driver
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|capable
c_func
(paren
id|CAP_SYS_ADMIN
)paren
)paren
(brace
r_if
c_cond
(paren
(paren
id|new_serial.baud_base
op_ne
id|driver-&gt;comm-&gt;data_rate
)paren
op_logical_or
(paren
id|new_serial.close_delay
op_ne
id|driver-&gt;close_delay
)paren
op_logical_or
(paren
(paren
id|new_serial.flags
op_amp
op_complement
id|ASYNC_USR_MASK
)paren
op_ne
(paren
id|driver-&gt;flags
op_amp
op_complement
id|ASYNC_USR_MASK
)paren
)paren
)paren
r_return
op_minus
id|EPERM
suffix:semicolon
id|driver-&gt;flags
op_assign
(paren
(paren
id|driver-&gt;flags
op_amp
op_complement
id|ASYNC_USR_MASK
)paren
op_or
(paren
id|new_serial.flags
op_amp
id|ASYNC_USR_MASK
)paren
)paren
suffix:semicolon
id|driver-&gt;custom_divisor
op_assign
id|new_serial.custom_divisor
suffix:semicolon
r_goto
id|check_and_exit
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * OK, past this point, all the error checking has been done.&n;&t; * At this point, we start making changes.....&n;&t; */
r_if
c_cond
(paren
id|driver-&gt;comm-&gt;data_rate
op_ne
id|new_serial.baud_base
)paren
(brace
id|driver-&gt;comm-&gt;data_rate
op_assign
id|new_serial.baud_base
suffix:semicolon
r_if
c_cond
(paren
id|driver-&gt;comm-&gt;state
op_eq
id|COMM_CONN
)paren
(brace
id|ircomm_control_request
c_func
(paren
id|driver-&gt;comm
comma
id|DATA_RATE
)paren
suffix:semicolon
)brace
)brace
id|driver-&gt;close_delay
op_assign
id|new_serial.close_delay
op_star
id|HZ
op_div
l_int|100
suffix:semicolon
id|driver-&gt;closing_wait
op_assign
id|new_serial.closing_wait
op_star
id|HZ
op_div
l_int|100
suffix:semicolon
id|driver-&gt;custom_divisor
op_assign
id|new_serial.custom_divisor
suffix:semicolon
id|driver-&gt;flags
op_assign
(paren
(paren
id|driver-&gt;flags
op_amp
op_complement
id|ASYNC_FLAGS
)paren
op_or
(paren
id|new_serial.flags
op_amp
id|ASYNC_FLAGS
)paren
)paren
suffix:semicolon
id|driver-&gt;tty-&gt;low_latency
op_assign
(paren
id|driver-&gt;flags
op_amp
id|ASYNC_LOW_LATENCY
)paren
ques
c_cond
l_int|1
suffix:colon
l_int|0
suffix:semicolon
id|check_and_exit
suffix:colon
r_if
c_cond
(paren
id|driver-&gt;flags
op_amp
id|ASYNC_INITIALIZED
)paren
(brace
r_if
c_cond
(paren
(paren
(paren
id|old_driver.flags
op_amp
id|ASYNC_SPD_MASK
)paren
op_ne
(paren
id|driver-&gt;flags
op_amp
id|ASYNC_SPD_MASK
)paren
)paren
op_logical_or
(paren
id|old_driver.custom_divisor
op_ne
id|driver-&gt;custom_divisor
)paren
)paren
(brace
r_if
c_cond
(paren
(paren
id|driver-&gt;flags
op_amp
id|ASYNC_SPD_MASK
)paren
op_eq
id|ASYNC_SPD_HI
)paren
id|driver-&gt;tty-&gt;alt_speed
op_assign
l_int|57600
suffix:semicolon
r_if
c_cond
(paren
(paren
id|driver-&gt;flags
op_amp
id|ASYNC_SPD_MASK
)paren
op_eq
id|ASYNC_SPD_VHI
)paren
id|driver-&gt;tty-&gt;alt_speed
op_assign
l_int|115200
suffix:semicolon
r_if
c_cond
(paren
(paren
id|driver-&gt;flags
op_amp
id|ASYNC_SPD_MASK
)paren
op_eq
id|ASYNC_SPD_SHI
)paren
id|driver-&gt;tty-&gt;alt_speed
op_assign
l_int|230400
suffix:semicolon
r_if
c_cond
(paren
(paren
id|driver-&gt;flags
op_amp
id|ASYNC_SPD_MASK
)paren
op_eq
id|ASYNC_SPD_WARP
)paren
id|driver-&gt;tty-&gt;alt_speed
op_assign
l_int|460800
suffix:semicolon
id|change_speed
c_func
(paren
id|driver
)paren
suffix:semicolon
)brace
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|irvtd_ioctl
r_int
id|irvtd_ioctl
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
comma
r_struct
id|file
op_star
id|file
comma
r_int
r_int
id|cmd
comma
r_int
r_int
id|arg
)paren
(brace
r_int
id|error
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_struct
id|irvtd_cb
op_star
id|driver
op_assign
(paren
r_struct
id|irvtd_cb
op_star
)paren
id|tty-&gt;driver_data
suffix:semicolon
r_struct
id|serial_icounter_struct
id|cnow
comma
id|cprev
suffix:semicolon
r_struct
id|serial_icounter_struct
op_star
id|p_cuser
suffix:semicolon
multiline_comment|/* user space */
id|DEBUG
c_func
(paren
l_int|4
comma
l_string|&quot;irvtd_ioctl:requested ioctl(0x%08x)&bslash;n&quot;
comma
id|cmd
)paren
suffix:semicolon
macro_line|#ifdef IRVTD_DEBUG_IOCTL
(brace
multiline_comment|/* kill time so that debug messages will come slowly  */
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|current-&gt;state
op_assign
id|TASK_INTERRUPTIBLE
suffix:semicolon
id|current-&gt;timeout
op_assign
id|jiffies
op_plus
id|HZ
op_div
l_int|4
suffix:semicolon
multiline_comment|/*0.25sec*/
id|schedule
c_func
(paren
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
macro_line|#endif
r_if
c_cond
(paren
(paren
id|cmd
op_ne
id|TIOCGSERIAL
)paren
op_logical_and
(paren
id|cmd
op_ne
id|TIOCSSERIAL
)paren
op_logical_and
(paren
id|cmd
op_ne
id|TIOCSERCONFIG
)paren
op_logical_and
(paren
id|cmd
op_ne
id|TIOCSERGSTRUCT
)paren
op_logical_and
(paren
id|cmd
op_ne
id|TIOCMIWAIT
)paren
op_logical_and
(paren
id|cmd
op_ne
id|TIOCGICOUNT
)paren
)paren
(brace
r_if
c_cond
(paren
id|tty-&gt;flags
op_amp
(paren
l_int|1
op_lshift
id|TTY_IO_ERROR
)paren
)paren
(brace
r_return
op_minus
id|EIO
suffix:semicolon
)brace
)brace
r_switch
c_cond
(paren
id|cmd
)paren
(brace
r_case
id|TIOCMGET
suffix:colon
r_return
id|get_modem_info
c_func
(paren
id|driver
comma
(paren
r_int
r_int
op_star
)paren
id|arg
)paren
suffix:semicolon
r_case
id|TIOCMBIS
suffix:colon
r_case
id|TIOCMBIC
suffix:colon
r_case
id|TIOCMSET
suffix:colon
r_return
id|set_modem_info
c_func
(paren
id|driver
comma
id|cmd
comma
(paren
r_int
r_int
op_star
)paren
id|arg
)paren
suffix:semicolon
r_case
id|TIOCGSERIAL
suffix:colon
r_return
id|get_serial_info
c_func
(paren
id|driver
comma
(paren
r_struct
id|serial_struct
op_star
)paren
id|arg
)paren
suffix:semicolon
r_case
id|TIOCSSERIAL
suffix:colon
r_return
id|set_serial_info
c_func
(paren
id|driver
comma
(paren
r_struct
id|serial_struct
op_star
)paren
id|arg
)paren
suffix:semicolon
r_case
id|TIOCMIWAIT
suffix:colon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* note the counters on entry */
id|cprev
op_assign
id|driver-&gt;icount
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_while
c_loop
(paren
l_int|1
)paren
(brace
id|interruptible_sleep_on
c_func
(paren
op_amp
id|driver-&gt;delta_msr_wait
)paren
suffix:semicolon
multiline_comment|/* see if a signal did it */
r_if
c_cond
(paren
id|signal_pending
c_func
(paren
id|current
)paren
)paren
r_return
op_minus
id|ERESTARTSYS
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|cnow
op_assign
id|driver-&gt;icount
suffix:semicolon
multiline_comment|/* atomic copy */
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cnow.rng
op_eq
id|cprev.rng
op_logical_and
id|cnow.dsr
op_eq
id|cprev.dsr
op_logical_and
id|cnow.dcd
op_eq
id|cprev.dcd
op_logical_and
id|cnow.cts
op_eq
id|cprev.cts
)paren
r_return
op_minus
id|EIO
suffix:semicolon
multiline_comment|/* no change =&gt; error */
r_if
c_cond
(paren
(paren
(paren
id|arg
op_amp
id|TIOCM_RNG
)paren
op_logical_and
(paren
id|cnow.rng
op_ne
id|cprev.rng
)paren
)paren
op_logical_or
(paren
(paren
id|arg
op_amp
id|TIOCM_DSR
)paren
op_logical_and
(paren
id|cnow.dsr
op_ne
id|cprev.dsr
)paren
)paren
op_logical_or
(paren
(paren
id|arg
op_amp
id|TIOCM_CD
)paren
op_logical_and
(paren
id|cnow.dcd
op_ne
id|cprev.dcd
)paren
)paren
op_logical_or
(paren
(paren
id|arg
op_amp
id|TIOCM_CTS
)paren
op_logical_and
(paren
id|cnow.cts
op_ne
id|cprev.cts
)paren
)paren
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
id|cprev
op_assign
id|cnow
suffix:semicolon
)brace
multiline_comment|/* NOTREACHED */
r_case
id|TIOCGICOUNT
suffix:colon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|cnow
op_assign
id|driver-&gt;icount
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|p_cuser
op_assign
(paren
r_struct
id|serial_icounter_struct
op_star
)paren
id|arg
suffix:semicolon
id|error
op_assign
id|put_user
c_func
(paren
id|cnow.cts
comma
op_amp
id|p_cuser-&gt;cts
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
)paren
r_return
id|error
suffix:semicolon
id|error
op_assign
id|put_user
c_func
(paren
id|cnow.dsr
comma
op_amp
id|p_cuser-&gt;dsr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
)paren
r_return
id|error
suffix:semicolon
id|error
op_assign
id|put_user
c_func
(paren
id|cnow.rng
comma
op_amp
id|p_cuser-&gt;rng
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
)paren
r_return
id|error
suffix:semicolon
id|error
op_assign
id|put_user
c_func
(paren
id|cnow.dcd
comma
op_amp
id|p_cuser-&gt;dcd
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
)paren
r_return
id|error
suffix:semicolon
id|error
op_assign
id|put_user
c_func
(paren
id|cnow.rx
comma
op_amp
id|p_cuser-&gt;rx
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
)paren
r_return
id|error
suffix:semicolon
id|error
op_assign
id|put_user
c_func
(paren
id|cnow.tx
comma
op_amp
id|p_cuser-&gt;tx
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
)paren
r_return
id|error
suffix:semicolon
id|error
op_assign
id|put_user
c_func
(paren
id|cnow.frame
comma
op_amp
id|p_cuser-&gt;frame
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
)paren
r_return
id|error
suffix:semicolon
id|error
op_assign
id|put_user
c_func
(paren
id|cnow.overrun
comma
op_amp
id|p_cuser-&gt;overrun
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
)paren
r_return
id|error
suffix:semicolon
id|error
op_assign
id|put_user
c_func
(paren
id|cnow.parity
comma
op_amp
id|p_cuser-&gt;parity
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
)paren
r_return
id|error
suffix:semicolon
id|error
op_assign
id|put_user
c_func
(paren
id|cnow.brk
comma
op_amp
id|p_cuser-&gt;brk
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
)paren
r_return
id|error
suffix:semicolon
id|error
op_assign
id|put_user
c_func
(paren
id|cnow.buf_overrun
comma
op_amp
id|p_cuser-&gt;buf_overrun
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
)paren
r_return
id|error
suffix:semicolon
r_return
l_int|0
suffix:semicolon
multiline_comment|/* ioctls which are imcompatible with serial.c */
r_case
id|TIOCSERGSTRUCT
suffix:colon
id|DEBUG
c_func
(paren
l_int|0
comma
id|__FUNCTION__
l_string|&quot;():sorry, TIOCSERGSTRUCT is not supported&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENOIOCTLCMD
suffix:semicolon
r_case
id|TIOCSERGETLSR
suffix:colon
id|DEBUG
c_func
(paren
l_int|0
comma
id|__FUNCTION__
l_string|&quot;():sorry, TIOCSERGETLSR is not supported&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENOIOCTLCMD
suffix:semicolon
r_case
id|TIOCSERCONFIG
suffix:colon
id|DEBUG
c_func
(paren
l_int|0
comma
id|__FUNCTION__
l_string|&quot;():sorry, TIOCSERCONFIG is not supported&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENOIOCTLCMD
suffix:semicolon
r_default
suffix:colon
r_return
op_minus
id|ENOIOCTLCMD
suffix:semicolon
multiline_comment|/* ioctls which we must ignore */
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * ----------------------------------------------------------------------&n; * irvtd_set_termios()&n; * This is called when termios is changed.&n; * If things that changed is significant for us,(i.e. changing baud rate etc.)&n; * send something to peer device.&n; * ----------------------------------------------------------------------&n; */
DECL|function|irvtd_set_termios
r_void
(def_block
id|irvtd_set_termios
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
comma
r_struct
id|termios
op_star
id|old_termios
)paren
(brace
r_struct
id|irvtd_cb
op_star
id|driver
op_assign
(paren
r_struct
id|irvtd_cb
op_star
)paren
id|tty-&gt;driver_data
suffix:semicolon
id|ASSERT
c_func
(paren
id|driver
op_ne
l_int|NULL
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|driver-&gt;magic
op_eq
id|IRVTD_MAGIC
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
id|DEBUG
c_func
(paren
l_int|0
comma
l_string|&quot;irvtd_set_termios:&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
r_if
c_cond
(paren
(paren
id|tty-&gt;termios-&gt;c_cflag
op_eq
id|old_termios-&gt;c_cflag
)paren
op_logical_and
(paren
id|RELEVANT_IFLAG
c_func
(paren
id|tty-&gt;termios-&gt;c_iflag
)paren
op_eq
id|RELEVANT_IFLAG
c_func
(paren
id|old_termios-&gt;c_iflag
)paren
)paren
)paren
(brace
r_return
suffix:semicolon
)brace
id|change_speed
c_func
(paren
id|driver
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|old_termios-&gt;c_cflag
op_amp
id|CRTSCTS
)paren
op_logical_and
op_logical_neg
(paren
id|tty-&gt;termios-&gt;c_cflag
op_amp
id|CRTSCTS
)paren
)paren
(brace
id|tty-&gt;hw_stopped
op_assign
id|driver-&gt;ttp_stoptx
suffix:semicolon
multiline_comment|/* irvtd_start(tty); */
multiline_comment|/* we don&squot;t need this */
)brace
)brace
)def_block
multiline_comment|/*&n; * ----------------------------------------------------------------------&n; * irvtd_throttle,irvtd_unthrottle&n; *   These routines will be called when we have to pause sending up data to tty.&n; *   We use RTS virtual signal when servicetype is NINE_WIRE&n; * ----------------------------------------------------------------------&n; */
DECL|function|irvtd_send_xchar
r_static
r_void
(def_block
id|irvtd_send_xchar
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
comma
r_char
id|ch
)paren
(brace
id|DEBUG
c_func
(paren
l_int|0
comma
id|__FUNCTION__
l_string|&quot;():&bslash;n&quot;
)paren
suffix:semicolon
id|irvtd_put_char
c_func
(paren
id|tty
comma
id|ch
)paren
suffix:semicolon
)brace
)def_block
DECL|function|irvtd_throttle
r_void
(def_block
id|irvtd_throttle
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
)paren
(brace
r_struct
id|irvtd_cb
op_star
id|driver
op_assign
(paren
r_struct
id|irvtd_cb
op_star
)paren
id|tty-&gt;driver_data
suffix:semicolon
id|DEBUG
c_func
(paren
l_int|0
comma
l_string|&quot;irvtd_throttle:&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|I_IXOFF
c_func
(paren
id|tty
)paren
)paren
id|irvtd_put_char
c_func
(paren
id|tty
comma
id|STOP_CHAR
c_func
(paren
id|tty
)paren
)paren
suffix:semicolon
id|driver-&gt;mcr
op_and_assign
op_complement
id|MCR_RTS
suffix:semicolon
id|driver-&gt;mcr
op_or_assign
id|DELTA_RTS
suffix:semicolon
id|driver-&gt;comm-&gt;dte
op_assign
id|driver-&gt;mcr
suffix:semicolon
id|ircomm_control_request
c_func
(paren
id|driver-&gt;comm
comma
id|DTELINE_STATE
)paren
suffix:semicolon
id|irttp_flow_request
c_func
(paren
id|driver-&gt;comm-&gt;tsap
comma
id|FLOW_STOP
)paren
suffix:semicolon
)brace
)def_block
DECL|function|irvtd_unthrottle
r_void
(def_block
id|irvtd_unthrottle
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
)paren
(brace
r_struct
id|irvtd_cb
op_star
id|driver
op_assign
(paren
r_struct
id|irvtd_cb
op_star
)paren
id|tty-&gt;driver_data
suffix:semicolon
id|DEBUG
c_func
(paren
l_int|0
comma
l_string|&quot;irvtd_unthrottle:&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|I_IXOFF
c_func
(paren
id|tty
)paren
)paren
id|irvtd_put_char
c_func
(paren
id|tty
comma
id|START_CHAR
c_func
(paren
id|tty
)paren
)paren
suffix:semicolon
id|driver-&gt;mcr
op_or_assign
(paren
id|MCR_RTS
op_or
id|DELTA_RTS
)paren
suffix:semicolon
id|driver-&gt;comm-&gt;dte
op_assign
id|driver-&gt;mcr
suffix:semicolon
id|ircomm_control_request
c_func
(paren
id|driver-&gt;comm
comma
id|DTELINE_STATE
)paren
suffix:semicolon
id|irttp_flow_request
c_func
(paren
id|driver-&gt;comm-&gt;tsap
comma
id|FLOW_START
)paren
suffix:semicolon
)brace
)def_block
multiline_comment|/*&n; * ------------------------------------------------------------&n; * irvtd_stop() and irvtd_start()&n; *&n; * This routines are called before setting or resetting tty-&gt;stopped.&n; * They enable or disable an interrupt which means &quot;transmitter-is-ready&quot;&n; * in serial.c, but  I think these routine are not necessary for us. &n; * ------------------------------------------------------------&n; */
macro_line|#if 0
(def_block
id|irvtd_stop
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
)paren
(brace
id|DEBUG
c_func
(paren
l_int|0
comma
l_string|&quot;irvtd_stop()&bslash;n&quot;
)paren
suffix:semicolon
r_struct
id|irvtd_cb
op_star
id|info
op_assign
(paren
r_struct
id|irvtd_cb
op_star
)paren
id|tty-&gt;driver_data
suffix:semicolon
id|DEBUG
c_func
(paren
l_int|0
comma
l_string|&quot;irvtd_start():not implemented!&bslash;n&quot;
)paren
suffix:semicolon
)brace
)def_block
(def_block
id|irvtd_start
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
)paren
(brace
r_struct
id|irvtd_cb
op_star
id|info
op_assign
(paren
r_struct
id|irvtd_cb
op_star
)paren
id|tty-&gt;driver_data
suffix:semicolon
id|DEBUG
c_func
(paren
l_int|0
comma
l_string|&quot;irvtd_start():not_implemented!&bslash;n&quot;
)paren
suffix:semicolon
)brace
)def_block
macro_line|#endif
multiline_comment|/*&n; * ------------------------------------------------------------&n; * irvtd_hangup()&n; * This routine notifies that tty layer have got HUP signal&n; * ------------------------------------------------------------&n; */
DECL|function|irvtd_hangup
r_void
(def_block
id|irvtd_hangup
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
)paren
(brace
r_struct
id|irvtd_cb
op_star
id|info
op_assign
(paren
r_struct
id|irvtd_cb
op_star
)paren
id|tty-&gt;driver_data
suffix:semicolon
id|DEBUG
c_func
(paren
l_int|0
comma
id|__FUNCTION__
l_string|&quot;()&bslash;n&quot;
)paren
suffix:semicolon
id|irvtd_flush_buffer
c_func
(paren
id|tty
)paren
suffix:semicolon
id|irvtd_shutdown
c_func
(paren
id|info
)paren
suffix:semicolon
id|info-&gt;count
op_assign
l_int|0
suffix:semicolon
id|info-&gt;tty
op_assign
l_int|NULL
suffix:semicolon
id|wake_up_interruptible
c_func
(paren
op_amp
id|info-&gt;open_wait
)paren
suffix:semicolon
)brace
)def_block
DECL|function|irvtd_flush_buffer
r_void
(def_block
id|irvtd_flush_buffer
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
)paren
(brace
r_struct
id|irvtd_cb
op_star
id|driver
op_assign
(paren
r_struct
id|irvtd_cb
op_star
)paren
id|tty-&gt;driver_data
suffix:semicolon
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
id|skb
op_assign
id|driver-&gt;txbuff
suffix:semicolon
id|ASSERT
c_func
(paren
id|skb
op_ne
l_int|NULL
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
r_if
c_cond
(paren
id|skb-&gt;len
)paren
(brace
id|DEBUG
c_func
(paren
l_int|0
comma
id|__FUNCTION__
l_string|&quot;():%d chars in txbuff are lost..&bslash;n&quot;
comma
(paren
r_int
)paren
id|skb-&gt;len
)paren
suffix:semicolon
id|skb_trim
c_func
(paren
id|skb
comma
l_int|0
)paren
suffix:semicolon
)brace
multiline_comment|/* write_wait is a wait queue of tty_wait_until_sent().&n;&t; * see tty_io.c of kernel &n;&t; */
id|wake_up_interruptible
c_func
(paren
op_amp
id|tty-&gt;write_wait
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|tty-&gt;flags
op_amp
(paren
l_int|1
op_lshift
id|TTY_DO_WRITE_WAKEUP
)paren
)paren
op_logical_and
id|tty-&gt;ldisc.write_wakeup
)paren
(paren
id|tty-&gt;ldisc.write_wakeup
)paren
(paren
id|tty
)paren
suffix:semicolon
)brace
)def_block
multiline_comment|/*&n; * Function ircomm_register_device(void), init_module() and friends&n; *&n; *   we register &quot;port emulation entity&quot;(see IrCOMM specification) here&n; *   as a tty device.&n; */
DECL|function|irvtd_register_ttydriver
r_int
(def_block
id|irvtd_register_ttydriver
c_func
(paren
r_void
)paren
(brace
id|DEBUG
c_func
(paren
l_int|4
comma
l_string|&quot;--&gt;irvtd_register_ttydriver&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* setup virtual serial port device */
multiline_comment|/* Initialize the tty_driver structure ,which is defined in &n;&t;   tty_driver.h */
id|memset
c_func
(paren
op_amp
id|irvtd_drv
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|tty_driver
)paren
)paren
suffix:semicolon
id|irvtd_drv.magic
op_assign
id|IRVTD_MAGIC
suffix:semicolon
id|irvtd_drv.driver_name
op_assign
l_string|&quot;IrCOMM_tty&quot;
suffix:semicolon
id|irvtd_drv.name
op_assign
l_string|&quot;irnine&quot;
suffix:semicolon
id|irvtd_drv.major
op_assign
id|IRCOMM_MAJOR
suffix:semicolon
id|irvtd_drv.minor_start
op_assign
id|IRVTD_MINOR
suffix:semicolon
id|irvtd_drv.num
op_assign
id|COMM_MAX_TTY
suffix:semicolon
id|irvtd_drv.type
op_assign
id|TTY_DRIVER_TYPE_SERIAL
suffix:semicolon
multiline_comment|/* see tty_driver.h */
multiline_comment|/*&n;&t; * see drivers/char/tty_io.c and termios(3)&n;&t; */
id|irvtd_drv.init_termios
op_assign
id|tty_std_termios
suffix:semicolon
id|irvtd_drv.init_termios.c_cflag
op_assign
id|B9600
op_or
id|CS8
op_or
id|CREAD
op_or
id|HUPCL
op_or
id|CLOCAL
suffix:semicolon
id|irvtd_drv.flags
op_assign
id|TTY_DRIVER_REAL_RAW
suffix:semicolon
multiline_comment|/* see tty_driver.h */
id|irvtd_drv.refcount
op_assign
op_amp
id|irvtd_refcount
suffix:semicolon
multiline_comment|/* pointer to the tty data structures */
id|irvtd_drv.table
op_assign
id|irvtd_table
suffix:semicolon
id|irvtd_drv.termios
op_assign
id|irvtd_termios
suffix:semicolon
id|irvtd_drv.termios_locked
op_assign
id|irvtd_termios_locked
suffix:semicolon
multiline_comment|/*&n;         * Interface table from the kernel(tty driver) to the ircomm&n;         * layer&n;         */
id|irvtd_drv.open
op_assign
id|irvtd_open
suffix:semicolon
id|irvtd_drv.close
op_assign
id|irvtd_close
suffix:semicolon
id|irvtd_drv.write
op_assign
id|irvtd_write
suffix:semicolon
id|irvtd_drv.put_char
op_assign
id|irvtd_put_char
suffix:semicolon
id|irvtd_drv.flush_chars
op_assign
l_int|NULL
suffix:semicolon
id|irvtd_drv.write_room
op_assign
id|irvtd_write_room
suffix:semicolon
id|irvtd_drv.chars_in_buffer
op_assign
id|irvtd_chars_in_buffer
suffix:semicolon
id|irvtd_drv.flush_buffer
op_assign
id|irvtd_flush_buffer
suffix:semicolon
id|irvtd_drv.ioctl
op_assign
id|irvtd_ioctl
suffix:semicolon
id|irvtd_drv.throttle
op_assign
id|irvtd_throttle
suffix:semicolon
id|irvtd_drv.unthrottle
op_assign
id|irvtd_unthrottle
suffix:semicolon
id|irvtd_drv.set_termios
op_assign
id|irvtd_set_termios
suffix:semicolon
id|irvtd_drv.stop
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/*  irvtd_stop; */
id|irvtd_drv.start
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/* irvtd_start; */
id|irvtd_drv.hangup
op_assign
id|irvtd_hangup
suffix:semicolon
id|irvtd_drv.send_xchar
op_assign
id|irvtd_send_xchar
suffix:semicolon
id|irvtd_drv.break_ctl
op_assign
id|irvtd_break
suffix:semicolon
id|irvtd_drv.read_proc
op_assign
id|irvtd_read_proc
suffix:semicolon
id|irvtd_drv.wait_until_sent
op_assign
id|irvtd_wait_until_sent
suffix:semicolon
r_if
c_cond
(paren
id|tty_register_driver
c_func
(paren
op_amp
id|irvtd_drv
)paren
)paren
(brace
id|DEBUG
c_func
(paren
l_int|0
comma
l_string|&quot;IrCOMM:Couldn&squot;t register tty driver&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
id|DEBUG
c_func
(paren
l_int|4
comma
l_string|&quot;irvtd_register_ttydriver: done.&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
)def_block
multiline_comment|/*&n; * Function irvtd_unregister_device(void) &n; *   it will be called when you rmmod&n; */
DECL|function|irvtd_unregister_ttydriver
r_void
(def_block
id|irvtd_unregister_ttydriver
c_func
(paren
r_void
)paren
(brace
r_int
id|err
suffix:semicolon
id|DEBUG
c_func
(paren
l_int|4
comma
l_string|&quot;--&gt; irvtd_unregister_device&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* unregister tty device   */
id|err
op_assign
id|tty_unregister_driver
c_func
(paren
op_amp
id|irvtd_drv
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
id|printk
c_func
(paren
l_string|&quot;IrCOMM: failed to unregister vtd driver(%d)&bslash;n&quot;
comma
id|err
)paren
suffix:semicolon
id|DEBUG
c_func
(paren
l_int|4
comma
l_string|&quot;irvtd_unregister_device --&gt;&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
)def_block
multiline_comment|/*&n; **********************************************************************&n; *    proc stuff&n; *&n; **********************************************************************&n; */
DECL|function|line_info
r_static
r_int
id|line_info
c_func
(paren
r_char
op_star
id|buf
comma
r_struct
id|irvtd_cb
op_star
id|driver
)paren
(brace
r_int
id|ret
op_assign
l_int|0
suffix:semicolon
id|ASSERT
c_func
(paren
id|driver
op_ne
l_int|NULL
comma
r_goto
m_exit
suffix:semicolon
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|driver-&gt;magic
op_eq
id|IRVTD_MAGIC
comma
r_goto
m_exit
suffix:semicolon
)paren
suffix:semicolon
id|ret
op_add_assign
id|sprintf
c_func
(paren
id|buf
comma
l_string|&quot;tx: %d rx: %d&quot;
comma
id|driver-&gt;icount.tx
comma
id|driver-&gt;icount.rx
)paren
suffix:semicolon
r_if
c_cond
(paren
id|driver-&gt;icount.frame
)paren
id|ret
op_add_assign
id|sprintf
c_func
(paren
id|buf
op_plus
id|ret
comma
l_string|&quot; fe:%d&quot;
comma
id|driver-&gt;icount.frame
)paren
suffix:semicolon
r_if
c_cond
(paren
id|driver-&gt;icount.parity
)paren
id|ret
op_add_assign
id|sprintf
c_func
(paren
id|buf
op_plus
id|ret
comma
l_string|&quot; pe:%d&quot;
comma
id|driver-&gt;icount.parity
)paren
suffix:semicolon
r_if
c_cond
(paren
id|driver-&gt;icount.brk
)paren
id|ret
op_add_assign
id|sprintf
c_func
(paren
id|buf
op_plus
id|ret
comma
l_string|&quot; brk:%d&quot;
comma
id|driver-&gt;icount.brk
)paren
suffix:semicolon
r_if
c_cond
(paren
id|driver-&gt;icount.overrun
)paren
id|ret
op_add_assign
id|sprintf
c_func
(paren
id|buf
op_plus
id|ret
comma
l_string|&quot; oe:%d&quot;
comma
id|driver-&gt;icount.overrun
)paren
suffix:semicolon
r_if
c_cond
(paren
id|driver-&gt;mcr
op_amp
id|MCR_RTS
)paren
id|ret
op_add_assign
id|sprintf
c_func
(paren
id|buf
op_plus
id|ret
comma
l_string|&quot;|RTS&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|driver-&gt;msr
op_amp
id|MSR_CTS
)paren
id|ret
op_add_assign
id|sprintf
c_func
(paren
id|buf
op_plus
id|ret
comma
l_string|&quot;|CTS&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|driver-&gt;mcr
op_amp
id|MCR_DTR
)paren
id|ret
op_add_assign
id|sprintf
c_func
(paren
id|buf
op_plus
id|ret
comma
l_string|&quot;|DTR&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|driver-&gt;msr
op_amp
id|MSR_DSR
)paren
id|ret
op_add_assign
id|sprintf
c_func
(paren
id|buf
op_plus
id|ret
comma
l_string|&quot;|DSR&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|driver-&gt;msr
op_amp
id|MSR_DCD
)paren
id|ret
op_add_assign
id|sprintf
c_func
(paren
id|buf
op_plus
id|ret
comma
l_string|&quot;|CD&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|driver-&gt;msr
op_amp
id|MSR_RI
)paren
id|ret
op_add_assign
id|sprintf
c_func
(paren
id|buf
op_plus
id|ret
comma
l_string|&quot;|RI&quot;
)paren
suffix:semicolon
m_exit
suffix:colon
id|ret
op_add_assign
id|sprintf
c_func
(paren
id|buf
op_plus
id|ret
comma
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
DECL|function|irvtd_read_proc
r_static
r_int
id|irvtd_read_proc
c_func
(paren
r_char
op_star
id|buf
comma
r_char
op_star
op_star
id|start
comma
id|off_t
id|offset
comma
r_int
id|len
comma
r_int
op_star
id|eof
comma
r_void
op_star
id|unused
)paren
(brace
r_int
id|i
comma
id|count
op_assign
l_int|0
comma
id|l
suffix:semicolon
id|off_t
id|begin
op_assign
l_int|0
suffix:semicolon
id|count
op_add_assign
id|sprintf
c_func
(paren
id|buf
comma
l_string|&quot;driver revision:%s&bslash;n&quot;
comma
id|revision_date
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|COMM_MAX_TTY
op_logical_and
id|count
OL
l_int|4000
suffix:semicolon
id|i
op_increment
)paren
(brace
id|l
op_assign
id|line_info
c_func
(paren
id|buf
op_plus
id|count
comma
id|irvtd
(braket
id|i
)braket
)paren
suffix:semicolon
id|count
op_add_assign
id|l
suffix:semicolon
r_if
c_cond
(paren
id|count
op_plus
id|begin
OG
id|offset
op_plus
id|len
)paren
r_goto
id|done
suffix:semicolon
r_if
c_cond
(paren
id|count
op_plus
id|begin
OL
id|offset
)paren
(brace
id|begin
op_add_assign
id|count
suffix:semicolon
id|count
op_assign
l_int|0
suffix:semicolon
)brace
)brace
op_star
id|eof
op_assign
l_int|1
suffix:semicolon
id|done
suffix:colon
r_if
c_cond
(paren
id|offset
op_ge
id|count
op_plus
id|begin
)paren
r_return
l_int|0
suffix:semicolon
op_star
id|start
op_assign
id|buf
op_plus
(paren
id|begin
op_minus
id|offset
)paren
suffix:semicolon
r_return
(paren
(paren
id|len
OL
id|begin
op_plus
id|count
op_minus
id|offset
)paren
ques
c_cond
id|len
suffix:colon
id|begin
op_plus
id|count
op_minus
id|offset
)paren
suffix:semicolon
)brace
multiline_comment|/************************************************************&n; *    init &amp; cleanup this module &n; ************************************************************/
DECL|function|__initfunc
id|__initfunc
c_func
(paren
r_int
id|irvtd_init
c_func
(paren
r_void
)paren
)paren
(brace
r_int
id|i
suffix:semicolon
id|DEBUG
c_func
(paren
l_int|4
comma
id|__FUNCTION__
l_string|&quot;()&bslash;n&quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;ircomm_tty: virtual tty driver for IrCOMM ( revision:%s )&bslash;n&quot;
comma
id|revision_date
)paren
suffix:semicolon
multiline_comment|/* allocate a master array */
id|irvtd
op_assign
(paren
r_struct
id|irvtd_cb
op_star
op_star
)paren
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_void
op_star
)paren
op_star
id|COMM_MAX_TTY
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|irvtd
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
id|__FUNCTION__
l_string|&quot;(): kmalloc failed!&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|memset
c_func
(paren
id|irvtd
comma
l_int|0
comma
r_sizeof
(paren
r_void
op_star
)paren
op_star
id|COMM_MAX_TTY
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|COMM_MAX_TTY
suffix:semicolon
id|i
op_increment
)paren
(brace
id|irvtd
(braket
id|i
)braket
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|irvtd_cb
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|irvtd
(braket
id|i
)braket
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
id|__FUNCTION__
l_string|&quot;(): kmalloc failed!&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|memset
c_func
(paren
id|irvtd
(braket
id|i
)braket
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|irvtd_cb
)paren
)paren
suffix:semicolon
id|irvtd
(braket
id|i
)braket
op_member_access_from_pointer
id|magic
op_assign
id|IRVTD_MAGIC
suffix:semicolon
id|irvtd
(braket
id|i
)braket
op_member_access_from_pointer
id|line
op_assign
id|i
suffix:semicolon
id|irvtd
(braket
id|i
)braket
op_member_access_from_pointer
id|closing_wait
op_assign
l_int|30
op_star
id|HZ
suffix:semicolon
id|irvtd
(braket
id|i
)braket
op_member_access_from_pointer
id|close_delay
op_assign
l_int|5
op_star
id|HZ
op_div
l_int|10
suffix:semicolon
)brace
multiline_comment|/* &n;&t; * initialize a &quot;port emulation entity&quot;&n;&t; */
r_if
c_cond
(paren
id|irvtd_register_ttydriver
c_func
(paren
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;IrCOMM: Error in ircomm_register_device&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|irvtd_cleanup
r_void
id|irvtd_cleanup
c_func
(paren
r_void
)paren
(brace
r_int
id|i
suffix:semicolon
id|DEBUG
c_func
(paren
l_int|4
comma
id|__FUNCTION__
l_string|&quot;()&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * free some resources&n;&t; */
r_if
c_cond
(paren
id|irvtd
)paren
(brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|COMM_MAX_TTY
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|irvtd
(braket
id|i
)braket
)paren
(brace
r_if
c_cond
(paren
id|irvtd
(braket
id|i
)braket
op_member_access_from_pointer
id|comm
)paren
(brace
id|ircomm_close_instance
c_func
(paren
id|irvtd
(braket
id|i
)braket
op_member_access_from_pointer
id|comm
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|irvtd
(braket
id|i
)braket
op_member_access_from_pointer
id|txbuff
)paren
(brace
id|dev_kfree_skb
c_func
(paren
id|irvtd
(braket
id|i
)braket
op_member_access_from_pointer
id|txbuff
)paren
suffix:semicolon
)brace
id|DEBUG
c_func
(paren
l_int|4
comma
l_string|&quot;freeing structures&bslash;n&quot;
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|irvtd
(braket
id|i
)braket
)paren
suffix:semicolon
id|irvtd
(braket
id|i
)braket
op_assign
l_int|NULL
suffix:semicolon
)brace
)brace
id|DEBUG
c_func
(paren
l_int|4
comma
l_string|&quot;freeing master array&bslash;n&quot;
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|irvtd
)paren
suffix:semicolon
id|irvtd
op_assign
l_int|NULL
suffix:semicolon
)brace
id|irvtd_unregister_ttydriver
c_func
(paren
)paren
suffix:semicolon
)brace
macro_line|#ifdef MODULE
DECL|function|init_module
r_int
id|init_module
c_func
(paren
r_void
)paren
(brace
id|irvtd_init
c_func
(paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * Function ircomm_cleanup (void)&n; *   This is called when you rmmod.&n; */
DECL|function|cleanup_module
r_void
id|cleanup_module
c_func
(paren
r_void
)paren
(brace
id|irvtd_cleanup
c_func
(paren
)paren
suffix:semicolon
)brace
macro_line|#endif /* MODULE */
eof
