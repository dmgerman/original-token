multiline_comment|/*********************************************************************&n; *                &n; * Filename:      ircomm_common.c&n; * Version:       &n; * Description:   An implementation of IrCOMM service interface, &n; *                state machine, and incidental function(s).&n; * Status:        Experimental.&n; * Author:        Takahide Higuchi &lt;thiguchi@pluto.dti.ne.jp&gt;&n; * Source:        irlpt_event.c&n; *&n; *     Copyright (c) 1998, Takahide Higuchi, &lt;thiguchi@pluto.dti.ne.jp&gt;,&n; *     All Rights Reserved.&n; *&n; *     This program is free software; you can redistribute it and/or&n; *     modify it under the terms of the GNU General Public License as&n; *     published by the Free Software Foundation; either version 2 of&n; *     the License, or (at your option) any later version.&n; *&n; *     I, Takahide Higuchi, provide no warranty for any of this software.&n; *     This material is provided &quot;AS-IS&quot; and at no charge.&n; *&n; ********************************************************************/
multiline_comment|/*&n; *    Reference: &n; *    &quot;&squot;IrCOMM&squot;:Serial and Parallel Port Emulation Over IR(Wire Replacement)&quot;&n; *    version 1.0, which is available at http://www.irda.org/.&n; */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/proc_fs.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;net/irda/irmod.h&gt;
macro_line|#include &lt;net/irda/irlmp.h&gt;
macro_line|#include &lt;net/irda/iriap.h&gt;
macro_line|#include &lt;net/irda/irttp.h&gt;
macro_line|#include &lt;net/irda/ircomm_common.h&gt;
macro_line|#if 0
r_static
r_char
op_star
id|rcsid
op_assign
l_string|&quot;$Id: ircomm_common.c,v 1.13 1998/10/13 12:59:05 takahide Exp $&quot;
suffix:semicolon
macro_line|#endif
DECL|variable|version
r_static
r_char
op_star
id|version
op_assign
l_string|&quot;IrCOMM_common, $Revision: 1.13 $ $Date: 1998/10/13 12:59:05 $ (Takahide Higuchi)&quot;
suffix:semicolon
r_static
r_void
id|ircomm_state_discovery
c_func
(paren
r_struct
id|ircomm_cb
op_star
id|self
comma
id|IRCOMM_EVENT
id|event
comma
r_struct
id|sk_buff
op_star
id|skb
)paren
suffix:semicolon
r_static
r_void
id|ircomm_state_idle
c_func
(paren
r_struct
id|ircomm_cb
op_star
id|self
comma
id|IRCOMM_EVENT
id|event
comma
r_struct
id|sk_buff
op_star
id|skb
)paren
suffix:semicolon
r_static
r_void
id|ircomm_state_waiti
c_func
(paren
r_struct
id|ircomm_cb
op_star
id|self
comma
id|IRCOMM_EVENT
id|event
comma
r_struct
id|sk_buff
op_star
id|skb
)paren
suffix:semicolon
r_static
r_void
id|ircomm_state_waitr
c_func
(paren
r_struct
id|ircomm_cb
op_star
id|self
comma
id|IRCOMM_EVENT
id|event
comma
r_struct
id|sk_buff
op_star
id|skb
)paren
suffix:semicolon
r_static
r_void
id|ircomm_state_conn
c_func
(paren
r_struct
id|ircomm_cb
op_star
id|self
comma
id|IRCOMM_EVENT
id|event
comma
r_struct
id|sk_buff
op_star
id|skb
)paren
suffix:semicolon
r_static
r_void
id|ircomm_do_event
c_func
(paren
r_struct
id|ircomm_cb
op_star
id|self
comma
id|IRCOMM_EVENT
id|event
comma
r_struct
id|sk_buff
op_star
id|skb
)paren
suffix:semicolon
r_void
id|ircomm_next_state
c_func
(paren
r_struct
id|ircomm_cb
op_star
id|self
comma
id|IRCOMM_STATE
id|state
)paren
suffix:semicolon
r_int
id|ircomm_check_handle
c_func
(paren
r_int
id|handle
)paren
suffix:semicolon
r_static
r_void
id|ircomm_parse_control
c_func
(paren
r_struct
id|ircomm_cb
op_star
id|self
comma
r_struct
id|sk_buff
op_star
id|skb
comma
r_int
id|type
)paren
suffix:semicolon
DECL|variable|ircommstate
r_static
r_char
op_star
id|ircommstate
(braket
)braket
op_assign
(brace
l_string|&quot;DISCOVERY&quot;
comma
l_string|&quot;IDLE&quot;
comma
l_string|&quot;WAITI&quot;
comma
l_string|&quot;WAITR&quot;
comma
l_string|&quot;CONN&quot;
comma
)brace
suffix:semicolon
DECL|variable|ircommservicetype
r_static
r_char
op_star
id|ircommservicetype
(braket
)braket
op_assign
(brace
l_string|&quot;N/A&quot;
comma
l_string|&quot;THREE_WIRE_RAW&quot;
comma
l_string|&quot;THREE_WIRE&quot;
comma
l_string|&quot;NINE_WIRE&quot;
comma
l_string|&quot;CENTRONICS&quot;
comma
)brace
suffix:semicolon
DECL|variable|ircommporttype
r_static
r_char
op_star
id|ircommporttype
(braket
)braket
op_assign
(brace
l_string|&quot;Unknown&quot;
comma
l_string|&quot;SERIAL&quot;
comma
l_string|&quot;PARALLEL&quot;
comma
)brace
suffix:semicolon
DECL|variable|ircomm
r_struct
id|ircomm_cb
op_star
op_star
id|ircomm
op_assign
l_int|NULL
suffix:semicolon
DECL|variable|ircommevent
r_static
r_char
op_star
id|ircommevent
(braket
)braket
op_assign
(brace
l_string|&quot;IRCOMM_CONNECT_REQUEST&quot;
comma
l_string|&quot;TTP_CONNECT_INDICATION&quot;
comma
l_string|&quot;LMP_CONNECT_INDICATION&quot;
comma
l_string|&quot;TTP_CONNECT_CONFIRM&quot;
comma
l_string|&quot;TTP_DISCONNECT_INDICATION&quot;
comma
l_string|&quot;LMP_CONNECT_CONFIRM&quot;
comma
l_string|&quot;LMP_DISCONNECT_INDICATION&quot;
comma
l_string|&quot;IRCOMM_CONNECT_RESPONSE&quot;
comma
l_string|&quot;IRCOMM_DISCONNECT_REQUEST&quot;
comma
l_string|&quot;TTP_DATA_INDICATION&quot;
comma
l_string|&quot;IRCOMM_DATA_REQUEST&quot;
comma
l_string|&quot;LMP_DATA_INDICATION&quot;
comma
l_string|&quot;IRCOMM_CONTROL_REQUEST&quot;
comma
)brace
suffix:semicolon
r_int
id|ircomm_proc_read
c_func
(paren
r_char
op_star
id|buf
comma
r_char
op_star
op_star
id|start
comma
id|off_t
id|offset
comma
r_int
id|len
comma
r_int
id|unused
)paren
suffix:semicolon
macro_line|#ifdef CONFIG_PROC_FS
r_extern
r_struct
id|proc_dir_entry
id|proc_irda
suffix:semicolon
DECL|variable|proc_ircomm
r_struct
id|proc_dir_entry
id|proc_ircomm
op_assign
(brace
l_int|0
comma
l_int|6
comma
l_string|&quot;ircomm&quot;
comma
id|S_IFREG
op_or
id|S_IRUGO
comma
l_int|1
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|NULL
comma
op_amp
id|ircomm_proc_read
comma
)brace
suffix:semicolon
macro_line|#endif
DECL|variable|state
r_static
r_void
(paren
op_star
id|state
(braket
)braket
)paren
(paren
r_struct
id|ircomm_cb
op_star
id|self
comma
id|IRCOMM_EVENT
id|event
comma
r_struct
id|sk_buff
op_star
id|skb
)paren
op_assign
(brace
id|ircomm_state_discovery
comma
id|ircomm_state_idle
comma
id|ircomm_state_waiti
comma
id|ircomm_state_waitr
comma
id|ircomm_state_conn
comma
)brace
suffix:semicolon
DECL|function|__initfunc
id|__initfunc
c_func
(paren
r_int
id|ircomm_init
c_func
(paren
r_void
)paren
)paren
(brace
r_int
id|i
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s&bslash;n&quot;
comma
id|version
)paren
suffix:semicolon
id|DEBUG
c_func
(paren
l_int|4
comma
l_string|&quot;ircomm_common:init_module&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* allocate master array */
id|ircomm
op_assign
(paren
r_struct
id|ircomm_cb
op_star
op_star
)paren
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|ircomm_cb
op_star
)paren
op_star
id|IRCOMM_MAX_CONNECTION
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ircomm
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;IrCOMM: Can&squot;t allocate ircomm array!&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|memset
c_func
(paren
id|ircomm
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|ircomm_cb
op_star
)paren
op_star
id|IRCOMM_MAX_CONNECTION
)paren
suffix:semicolon
multiline_comment|/* initialize structures */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|IRCOMM_MAX_CONNECTION
suffix:semicolon
id|i
op_increment
)paren
(brace
id|ircomm
(braket
id|i
)braket
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|ircomm_cb
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ircomm
(braket
id|i
)braket
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;ircomm:kmalloc failed!&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|memset
c_func
(paren
id|ircomm
(braket
id|i
)braket
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|ircomm_cb
)paren
)paren
suffix:semicolon
id|ircomm
(braket
id|i
)braket
op_member_access_from_pointer
id|magic
op_assign
id|IRCOMM_MAGIC
suffix:semicolon
multiline_comment|/* default settings */
id|ircomm
(braket
id|i
)braket
op_member_access_from_pointer
id|data_format
op_assign
id|CS8
suffix:semicolon
id|ircomm
(braket
id|i
)braket
op_member_access_from_pointer
id|flow_ctrl
op_assign
id|USE_RTS
op_or
id|USE_DTR
suffix:semicolon
multiline_comment|/*TODO: is this OK? */
id|ircomm
(braket
id|i
)braket
op_member_access_from_pointer
id|xon_char
op_assign
l_int|0x11
suffix:semicolon
id|ircomm
(braket
id|i
)braket
op_member_access_from_pointer
id|xoff_char
op_assign
l_int|0x13
suffix:semicolon
id|ircomm
(braket
id|i
)braket
op_member_access_from_pointer
id|enq_char
op_assign
l_int|0x05
suffix:semicolon
id|ircomm
(braket
id|i
)braket
op_member_access_from_pointer
id|ack_char
op_assign
l_int|0x06
suffix:semicolon
id|ircomm
(braket
id|i
)braket
op_member_access_from_pointer
id|max_txbuff_size
op_assign
id|COMM_DEFAULT_DATA_SIZE
suffix:semicolon
multiline_comment|/* 64 */
id|ircomm
(braket
id|i
)braket
op_member_access_from_pointer
id|maxsdusize
op_assign
id|SAR_DISABLE
suffix:semicolon
id|ircomm
(braket
id|i
)braket
op_member_access_from_pointer
id|ctrl_skb
op_assign
id|dev_alloc_skb
c_func
(paren
id|COMM_DEFAULT_DATA_SIZE
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ircomm
(braket
id|i
)braket
op_member_access_from_pointer
id|ctrl_skb
op_eq
l_int|NULL
)paren
(brace
id|DEBUG
c_func
(paren
l_int|0
comma
l_string|&quot;ircomm:init_module:alloc_skb failed!&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|skb_reserve
c_func
(paren
id|ircomm
(braket
id|i
)braket
op_member_access_from_pointer
id|ctrl_skb
comma
id|COMM_HEADER_SIZE
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * we register /proc/irda/ircomm&n;&t; */
macro_line|#ifdef CONFIG_PROC_FS
id|proc_register
c_func
(paren
op_amp
id|proc_irda
comma
op_amp
id|proc_ircomm
)paren
suffix:semicolon
macro_line|#endif /* CONFIG_PROC_FS */
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|ircomm_cleanup
r_void
id|ircomm_cleanup
c_func
(paren
r_void
)paren
(brace
r_int
id|i
suffix:semicolon
id|DEBUG
c_func
(paren
l_int|4
comma
l_string|&quot;ircomm_common:cleanup_module&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * free some resources&n;&t; */
r_if
c_cond
(paren
id|ircomm
)paren
(brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|IRCOMM_MAX_CONNECTION
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|ircomm
(braket
id|i
)braket
)paren
(brace
r_if
c_cond
(paren
id|ircomm
(braket
id|i
)braket
op_member_access_from_pointer
id|ctrl_skb
)paren
(brace
id|dev_kfree_skb
c_func
(paren
id|ircomm
(braket
id|i
)braket
op_member_access_from_pointer
id|ctrl_skb
)paren
suffix:semicolon
id|ircomm
(braket
id|i
)braket
op_member_access_from_pointer
id|ctrl_skb
op_assign
l_int|NULL
suffix:semicolon
)brace
id|DEBUG
c_func
(paren
l_int|4
comma
l_string|&quot;freeing structures(%d)&bslash;n&quot;
comma
id|i
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|ircomm
(braket
id|i
)braket
)paren
suffix:semicolon
id|ircomm
(braket
id|i
)braket
op_assign
l_int|NULL
suffix:semicolon
)brace
)brace
id|DEBUG
c_func
(paren
l_int|4
comma
l_string|&quot;freeing master array&bslash;n&quot;
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|ircomm
)paren
suffix:semicolon
id|ircomm
op_assign
l_int|NULL
suffix:semicolon
)brace
macro_line|#ifdef CONFIG_PROC_FS
id|proc_unregister
c_func
(paren
op_amp
id|proc_irda
comma
id|proc_ircomm.low_ino
)paren
suffix:semicolon
macro_line|#endif
)brace
multiline_comment|/*&n; * ---------------------------------------------------------------------- &n; * callbacks which accept incoming indication/confirm from IrTTP  (or IrLMP)&n; * ---------------------------------------------------------------------- &n; */
DECL|function|ircomm_accept_data_indication
r_void
id|ircomm_accept_data_indication
c_func
(paren
r_void
op_star
id|instance
comma
r_void
op_star
id|sap
comma
r_struct
id|sk_buff
op_star
id|skb
)paren
(brace
r_struct
id|ircomm_cb
op_star
id|self
op_assign
(paren
r_struct
id|ircomm_cb
op_star
)paren
id|instance
suffix:semicolon
id|ASSERT
c_func
(paren
id|self
op_ne
l_int|NULL
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|self-&gt;magic
op_eq
id|IRCOMM_MAGIC
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|skb
op_ne
l_int|NULL
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
id|DEBUG
c_func
(paren
l_int|4
comma
l_string|&quot;ircomm_accept_data_indication:&bslash;n&quot;
)paren
suffix:semicolon
id|ircomm_do_event
c_func
(paren
id|self
comma
id|TTP_DATA_INDICATION
comma
id|skb
)paren
suffix:semicolon
)brace
DECL|function|ircomm_accept_connect_confirm
r_void
id|ircomm_accept_connect_confirm
c_func
(paren
r_void
op_star
id|instance
comma
r_void
op_star
id|sap
comma
r_struct
id|qos_info
op_star
id|qos
comma
r_int
id|maxsdusize
comma
r_struct
id|sk_buff
op_star
id|skb
)paren
(brace
r_struct
id|ircomm_cb
op_star
id|self
op_assign
(paren
r_struct
id|ircomm_cb
op_star
)paren
id|instance
suffix:semicolon
id|ASSERT
c_func
(paren
id|self
op_ne
l_int|NULL
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|self-&gt;magic
op_eq
id|IRCOMM_MAGIC
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|skb
op_ne
l_int|NULL
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|qos
op_ne
l_int|NULL
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
id|DEBUG
c_func
(paren
l_int|0
comma
l_string|&quot;ircomm_accept_connect_confirm:&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|maxsdusize
op_eq
id|SAR_DISABLE
)paren
(brace
id|self-&gt;max_txbuff_size
op_assign
id|qos-&gt;data_size.value
suffix:semicolon
)brace
r_else
(brace
id|ASSERT
c_func
(paren
id|maxsdusize
op_ge
id|COMM_DEFAULT_DATA_SIZE
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
id|self-&gt;max_txbuff_size
op_assign
id|maxsdusize
suffix:semicolon
multiline_comment|/* use fragmentation */
)brace
id|self-&gt;qos
op_assign
id|qos
suffix:semicolon
id|self-&gt;null_modem_mode
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* disable null modem emulation */
id|ircomm_do_event
c_func
(paren
id|self
comma
id|TTP_CONNECT_CONFIRM
comma
id|skb
)paren
suffix:semicolon
)brace
DECL|function|ircomm_accept_connect_indication
r_void
id|ircomm_accept_connect_indication
c_func
(paren
r_void
op_star
id|instance
comma
r_void
op_star
id|sap
comma
r_struct
id|qos_info
op_star
id|qos
comma
r_int
id|maxsdusize
comma
r_struct
id|sk_buff
op_star
id|skb
)paren
(brace
r_struct
id|ircomm_cb
op_star
id|self
op_assign
(paren
r_struct
id|ircomm_cb
op_star
)paren
id|instance
suffix:semicolon
id|ASSERT
c_func
(paren
id|self
op_ne
l_int|NULL
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|self-&gt;magic
op_eq
id|IRCOMM_MAGIC
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|skb
op_ne
l_int|NULL
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|qos
op_ne
l_int|NULL
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
id|DEBUG
c_func
(paren
l_int|0
comma
l_string|&quot;ircomm_accept_connect_indication:&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|maxsdusize
op_eq
id|SAR_DISABLE
)paren
(brace
id|self-&gt;max_txbuff_size
op_assign
id|qos-&gt;data_size.value
suffix:semicolon
)brace
r_else
id|self-&gt;max_txbuff_size
op_assign
id|maxsdusize
suffix:semicolon
id|self-&gt;qos
op_assign
id|qos
suffix:semicolon
id|ircomm_do_event
c_func
(paren
id|self
comma
id|TTP_CONNECT_INDICATION
comma
id|skb
)paren
suffix:semicolon
)brace
DECL|function|ircomm_accept_disconnect_indication
r_void
id|ircomm_accept_disconnect_indication
c_func
(paren
r_void
op_star
id|instance
comma
r_void
op_star
id|sap
comma
id|LM_REASON
id|reason
comma
r_struct
id|sk_buff
op_star
id|skb
)paren
(brace
r_struct
id|ircomm_cb
op_star
id|self
op_assign
(paren
r_struct
id|ircomm_cb
op_star
)paren
id|instance
suffix:semicolon
id|ASSERT
c_func
(paren
id|self
op_ne
l_int|NULL
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|self-&gt;magic
op_eq
id|IRCOMM_MAGIC
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|skb
op_ne
l_int|NULL
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
id|DEBUG
c_func
(paren
l_int|0
comma
l_string|&quot;ircomm_accept_disconnect_indication:&bslash;n&quot;
)paren
suffix:semicolon
id|ircomm_do_event
c_func
(paren
id|self
comma
id|TTP_DISCONNECT_INDICATION
comma
id|skb
)paren
suffix:semicolon
)brace
DECL|function|ircomm_accept_flow_indication
r_void
id|ircomm_accept_flow_indication
c_func
(paren
r_void
op_star
id|instance
comma
r_void
op_star
id|sap
comma
id|LOCAL_FLOW
id|cmd
)paren
(brace
r_struct
id|ircomm_cb
op_star
id|self
op_assign
(paren
r_struct
id|ircomm_cb
op_star
)paren
id|instance
suffix:semicolon
id|ASSERT
c_func
(paren
id|self
op_ne
l_int|NULL
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|self-&gt;magic
op_eq
id|IRCOMM_MAGIC
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|cmd
)paren
(brace
r_case
id|FLOW_START
suffix:colon
id|DEBUG
c_func
(paren
l_int|0
comma
l_string|&quot;ircomm_accept_flow_indication:START&bslash;n&quot;
)paren
suffix:semicolon
id|self-&gt;pi
op_assign
id|TX_READY
suffix:semicolon
id|self-&gt;ttp_stop
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|self-&gt;notify.flow_indication
)paren
(brace
id|self-&gt;notify
dot
id|flow_indication
c_func
(paren
id|self-&gt;notify.instance
comma
id|self
comma
id|cmd
)paren
suffix:semicolon
)brace
id|ircomm_control_request
c_func
(paren
id|self
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|FLOW_STOP
suffix:colon
id|DEBUG
c_func
(paren
l_int|0
comma
l_string|&quot;ircomm_accept_flow_indication:STOP&bslash;n&quot;
)paren
suffix:semicolon
id|self-&gt;pi
op_assign
id|TX_BUSY
suffix:semicolon
id|self-&gt;ttp_stop
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|self-&gt;notify.flow_indication
)paren
(brace
id|self-&gt;notify
dot
id|flow_indication
c_func
(paren
id|self-&gt;notify.instance
comma
id|self
comma
id|cmd
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_default
suffix:colon
id|DEBUG
c_func
(paren
l_int|0
comma
l_string|&quot;ircomm_accept_flow_indication:unknown status!&bslash;n&quot;
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* &n; * ----------------------------------------------------------------------&n; * Implementation of actions,descrived in section 7.4 of the reference.&n; * ----------------------------------------------------------------------&n; */
DECL|function|issue_connect_request
r_static
r_void
id|issue_connect_request
c_func
(paren
r_struct
id|ircomm_cb
op_star
id|self
comma
r_struct
id|sk_buff
op_star
id|userdata
)paren
(brace
multiline_comment|/* TODO: we have to send/build userdata field which contains &n;&t;   InitialControlParameters */
multiline_comment|/* but userdata field is not implemeted in irttp.c.. */
r_switch
c_cond
(paren
id|self-&gt;servicetype
)paren
(brace
r_case
id|THREE_WIRE_RAW
suffix:colon
multiline_comment|/* not implemented yet! Do nothing */
id|DEBUG
c_func
(paren
l_int|0
comma
l_string|&quot;ircomm:issue_connect_request:&quot;
l_string|&quot;not implemented servicetype!&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|DEFAULT
suffix:colon
id|irttp_connect_request
c_func
(paren
id|self-&gt;tsap
comma
id|self-&gt;dlsap
comma
id|self-&gt;saddr
comma
id|self-&gt;daddr
comma
l_int|NULL
comma
id|self-&gt;maxsdusize
comma
l_int|NULL
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|THREE_WIRE
suffix:colon
r_case
id|NINE_WIRE
suffix:colon
r_case
id|CENTRONICS
suffix:colon
id|irttp_connect_request
c_func
(paren
id|self-&gt;tsap
comma
id|self-&gt;dlsap
comma
id|self-&gt;saddr
comma
id|self-&gt;daddr
comma
l_int|NULL
comma
id|self-&gt;maxsdusize
comma
l_int|NULL
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|DEBUG
c_func
(paren
l_int|0
comma
l_string|&quot;ircomm:issue_connect_request:Illegal servicetype %d&bslash;n&quot;
comma
id|self-&gt;servicetype
)paren
suffix:semicolon
)brace
)brace
DECL|function|disconnect_indication
r_static
r_void
id|disconnect_indication
c_func
(paren
r_struct
id|ircomm_cb
op_star
id|self
comma
r_struct
id|sk_buff
op_star
id|skb
)paren
(brace
multiline_comment|/*&n;&t; * Not implemented parameter&quot;Reason&quot;.That is optional.&n;&t; * What is reason? maybe discribed in irmod.h?&n;&t; */
r_if
c_cond
(paren
id|self-&gt;notify.disconnect_indication
)paren
(brace
id|self-&gt;notify
dot
id|disconnect_indication
c_func
(paren
id|self-&gt;notify.instance
comma
id|self
comma
id|self-&gt;reason
comma
id|skb
)paren
suffix:semicolon
)brace
)brace
DECL|function|connect_indication
r_static
r_void
id|connect_indication
c_func
(paren
r_struct
id|ircomm_cb
op_star
id|self
comma
r_struct
id|qos_info
op_star
id|qos
comma
r_struct
id|sk_buff
op_star
id|skb
)paren
(brace
multiline_comment|/* If controlparameters don&squot;t exist, we use the servicetype&quot;DEFAULT&quot;.*/
multiline_comment|/* &t;if( !ircomm_parse_controlchannel( self, data)) */
multiline_comment|/* &t;&t;self-&gt;servicetype = DEFAULT;     TODOD:fix this! TH */
r_if
c_cond
(paren
id|self-&gt;notify.connect_indication
)paren
(brace
id|self-&gt;notify
dot
id|connect_indication
c_func
(paren
id|self-&gt;notify.instance
comma
id|self
comma
id|qos
comma
l_int|0
comma
id|skb
)paren
suffix:semicolon
)brace
)brace
macro_line|#if 0
multiline_comment|/*   it&squot;s for THREE_WIRE_RAW.*/
r_static
r_void
id|connect_indication_three_wire_raw
c_func
(paren
r_void
)paren
(brace
id|DEBUG
c_func
(paren
l_int|0
comma
l_string|&quot;ircomm:connect_indication_threewire():not implemented!&quot;
)paren
suffix:semicolon
)brace
macro_line|#endif 
DECL|function|connect_confirmation
r_static
r_void
id|connect_confirmation
c_func
(paren
r_struct
id|ircomm_cb
op_star
id|self
comma
r_struct
id|sk_buff
op_star
id|skb
)paren
(brace
multiline_comment|/* give a connect_confirm to the client */
r_if
c_cond
(paren
id|self-&gt;notify.connect_confirm
)paren
(brace
id|self-&gt;notify
dot
id|connect_confirm
c_func
(paren
id|self-&gt;notify.instance
comma
id|self
comma
l_int|NULL
comma
id|SAR_DISABLE
comma
id|skb
)paren
suffix:semicolon
)brace
)brace
DECL|function|issue_connect_response
r_static
r_void
id|issue_connect_response
c_func
(paren
r_struct
id|ircomm_cb
op_star
id|self
comma
r_struct
id|sk_buff
op_star
id|skb
)paren
(brace
id|DEBUG
c_func
(paren
l_int|0
comma
l_string|&quot;ircomm:issue_connect_response:&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|self-&gt;servicetype
op_eq
id|THREE_WIRE_RAW
)paren
(brace
id|DEBUG
c_func
(paren
l_int|0
comma
l_string|&quot;ircomm:issue_connect_response():3WIRE-RAW is not &quot;
l_string|&quot;implemented yet !&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* irlmp_connect_rsp(); */
)brace
r_else
(brace
id|irttp_connect_response
c_func
(paren
id|self-&gt;tsap
comma
id|self-&gt;maxsdusize
comma
id|skb
)paren
suffix:semicolon
)brace
)brace
DECL|function|issue_disconnect_request
r_static
r_void
id|issue_disconnect_request
c_func
(paren
r_struct
id|ircomm_cb
op_star
id|self
comma
r_struct
id|sk_buff
op_star
id|userdata
)paren
(brace
r_if
c_cond
(paren
id|self-&gt;servicetype
op_eq
id|THREE_WIRE_RAW
)paren
(brace
id|DEBUG
c_func
(paren
l_int|0
comma
l_string|&quot;ircomm:issue_disconnect_request():3wireraw is not implemented!&quot;
)paren
suffix:semicolon
)brace
r_else
id|irttp_disconnect_request
c_func
(paren
id|self-&gt;tsap
comma
l_int|NULL
comma
id|P_NORMAL
)paren
suffix:semicolon
)brace
DECL|function|issue_data_request
r_static
r_void
id|issue_data_request
c_func
(paren
r_struct
id|ircomm_cb
op_star
id|self
comma
r_struct
id|sk_buff
op_star
id|userdata
)paren
(brace
r_int
id|err
suffix:semicolon
r_if
c_cond
(paren
id|self-&gt;servicetype
op_eq
id|THREE_WIRE_RAW
)paren
(brace
multiline_comment|/* irlmp_data_request(self-&gt;lmhandle,userdata); */
id|DEBUG
c_func
(paren
l_int|0
comma
l_string|&quot;ircomm:issue_data_request():not implemented!&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|DEBUG
c_func
(paren
l_int|4
comma
l_string|&quot;ircomm:issue_data_request():sending frame&bslash;n&quot;
)paren
suffix:semicolon
id|err
op_assign
id|irttp_data_request
c_func
(paren
id|self-&gt;tsap
comma
id|userdata
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
(brace
id|DEBUG
c_func
(paren
l_int|0
comma
l_string|&quot;ircomm:ttp_data_request failed&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|userdata
op_logical_and
id|err
)paren
(brace
id|dev_kfree_skb
c_func
(paren
id|userdata
)paren
suffix:semicolon
)brace
)brace
DECL|function|issue_control_request
r_static
r_void
id|issue_control_request
c_func
(paren
r_struct
id|ircomm_cb
op_star
id|self
comma
r_struct
id|sk_buff
op_star
id|userdata
)paren
(brace
r_if
c_cond
(paren
id|self-&gt;servicetype
op_eq
id|THREE_WIRE_RAW
)paren
(brace
id|DEBUG
c_func
(paren
l_int|0
comma
l_string|&quot;THREE_WIRE_RAW is not implemented&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_else
(brace
id|irttp_data_request
c_func
(paren
id|self-&gt;tsap
comma
id|userdata
)paren
suffix:semicolon
)brace
)brace
DECL|function|process_data
r_static
r_void
id|process_data
c_func
(paren
r_struct
id|ircomm_cb
op_star
id|self
comma
r_struct
id|sk_buff
op_star
id|skb
)paren
(brace
id|DEBUG
c_func
(paren
l_int|4
comma
l_string|&quot;ircomm:process_data:skb_len is(%d),clen_is(%d)&bslash;n&quot;
comma
(paren
r_int
)paren
id|skb-&gt;len
comma
(paren
r_int
)paren
id|skb-&gt;data
(braket
l_int|0
)braket
)paren
suffix:semicolon
multiline_comment|/* &n;&t; * we always have to parse control channel&n;&t; *  (see page17 of IrCOMM standard) &n;&t; */
id|ircomm_parse_control
c_func
(paren
id|self
comma
id|skb
comma
id|CONTROL_CHANNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|self-&gt;notify.data_indication
op_logical_and
id|skb-&gt;len
)paren
(brace
id|self-&gt;notify
dot
id|data_indication
c_func
(paren
id|self-&gt;notify.instance
comma
id|self
comma
id|skb
)paren
suffix:semicolon
)brace
)brace
DECL|function|ircomm_data_indication
r_void
id|ircomm_data_indication
c_func
(paren
r_struct
id|ircomm_cb
op_star
id|self
comma
r_struct
id|sk_buff
op_star
id|skb
)paren
(brace
multiline_comment|/* Not implemented yet:THREE_WIRE_RAW service uses this function.  */
id|DEBUG
c_func
(paren
l_int|0
comma
l_string|&quot;ircomm_data_indication:not implemented yet!&bslash;n&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/* &n; * ----------------------------------------------------------------------&n; * Implementation of state chart,&n; * descrived in section 7.1 of the specification.&n; * ----------------------------------------------------------------------&n; */
DECL|function|ircomm_do_event
r_static
r_void
id|ircomm_do_event
c_func
(paren
r_struct
id|ircomm_cb
op_star
id|self
comma
id|IRCOMM_EVENT
id|event
comma
r_struct
id|sk_buff
op_star
id|skb
)paren
(brace
id|DEBUG
c_func
(paren
l_int|4
comma
l_string|&quot;ircomm_do_event: STATE = %s, EVENT = %s&bslash;n&quot;
comma
id|ircommstate
(braket
id|self-&gt;state
)braket
comma
id|ircommevent
(braket
id|event
)braket
)paren
suffix:semicolon
(paren
op_star
id|state
(braket
id|self-&gt;state
)braket
)paren
(paren
id|self
comma
id|event
comma
id|skb
)paren
suffix:semicolon
)brace
DECL|function|ircomm_next_state
r_void
id|ircomm_next_state
c_func
(paren
r_struct
id|ircomm_cb
op_star
id|self
comma
id|IRCOMM_STATE
id|state
)paren
(brace
id|self-&gt;state
op_assign
id|state
suffix:semicolon
id|DEBUG
c_func
(paren
l_int|0
comma
l_string|&quot;ircomm_next_state: NEXT STATE = %d(%s), sv(%d)&bslash;n&quot;
comma
(paren
r_int
)paren
id|state
comma
id|ircommstate
(braket
id|self-&gt;state
)braket
comma
id|self-&gt;servicetype
)paren
suffix:semicolon
)brace
multiline_comment|/* &n; * we currently need dummy (discovering) state for debugging,&n; * which state is not defined in the reference.&n; */
DECL|function|ircomm_state_discovery
r_static
r_void
id|ircomm_state_discovery
c_func
(paren
r_struct
id|ircomm_cb
op_star
id|self
comma
id|IRCOMM_EVENT
id|event
comma
r_struct
id|sk_buff
op_star
id|skb
)paren
(brace
id|DEBUG
c_func
(paren
l_int|0
comma
l_string|&quot;ircomm_state_discovery: &quot;
l_string|&quot;why call me? &bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|skb
)paren
(brace
id|dev_kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/*&n; * ircomm_state_idle&n; */
DECL|function|ircomm_state_idle
r_static
r_void
id|ircomm_state_idle
c_func
(paren
r_struct
id|ircomm_cb
op_star
id|self
comma
id|IRCOMM_EVENT
id|event
comma
r_struct
id|sk_buff
op_star
id|skb
)paren
(brace
r_switch
c_cond
(paren
id|event
)paren
(brace
r_case
id|IRCOMM_CONNECT_REQUEST
suffix:colon
id|ircomm_next_state
c_func
(paren
id|self
comma
id|COMM_WAITI
)paren
suffix:semicolon
id|issue_connect_request
c_func
(paren
id|self
comma
id|skb
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|TTP_CONNECT_INDICATION
suffix:colon
id|ircomm_next_state
c_func
(paren
id|self
comma
id|COMM_WAITR
)paren
suffix:semicolon
id|connect_indication
c_func
(paren
id|self
comma
id|self-&gt;qos
comma
id|skb
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|LMP_CONNECT_INDICATION
suffix:colon
multiline_comment|/* I think this is already done in irlpt_event.c */
id|DEBUG
c_func
(paren
l_int|0
comma
l_string|&quot;ircomm_state_idle():LMP_CONNECT_IND is notimplemented!&quot;
)paren
suffix:semicolon
multiline_comment|/* connect_indication_three_wire_raw(); */
multiline_comment|/* ircomm_next_state(self, COMM_WAITR); */
r_break
suffix:semicolon
r_default
suffix:colon
id|DEBUG
c_func
(paren
l_int|0
comma
l_string|&quot;ircomm_state_idle():unknown event =%d(%s)&bslash;n&quot;
comma
id|event
comma
id|ircommevent
(braket
id|event
)braket
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/*&n; * ircomm_state_waiti&n; */
DECL|function|ircomm_state_waiti
r_static
r_void
id|ircomm_state_waiti
c_func
(paren
r_struct
id|ircomm_cb
op_star
id|self
comma
id|IRCOMM_EVENT
id|event
comma
r_struct
id|sk_buff
op_star
id|skb
)paren
(brace
r_switch
c_cond
(paren
id|event
)paren
(brace
r_case
id|TTP_CONNECT_CONFIRM
suffix:colon
id|ircomm_next_state
c_func
(paren
id|self
comma
id|COMM_CONN
)paren
suffix:semicolon
id|connect_confirmation
c_func
(paren
id|self
comma
id|skb
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|TTP_DISCONNECT_INDICATION
suffix:colon
id|ircomm_next_state
c_func
(paren
id|self
comma
id|COMM_IDLE
)paren
suffix:semicolon
id|disconnect_indication
c_func
(paren
id|self
comma
id|skb
)paren
suffix:semicolon
r_break
suffix:semicolon
multiline_comment|/* &t;case LMP_CONNECT_CONFIRM: */
multiline_comment|/* &t;&t;ircomm_connect_cnfirmation; */
multiline_comment|/* &t;&t;ircomm_next_state(self, COMM_CONN); */
multiline_comment|/* &t;&t;break; */
multiline_comment|/* &t;case LMP_DISCONNECT_INDICATION: */
multiline_comment|/* &t;&t;ircomm_disconnect_ind; */
multiline_comment|/* &t;&t;ircomm_next_state(self, COMM_IDLE); */
multiline_comment|/* &t;&t;break; */
r_default
suffix:colon
id|DEBUG
c_func
(paren
l_int|0
comma
l_string|&quot;ircomm_state_waiti:unknown event =%d(%s)&bslash;n&quot;
comma
id|event
comma
id|ircommevent
(braket
id|event
)braket
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/*&n; * ircomm_state_waitr&n; */
DECL|function|ircomm_state_waitr
r_static
r_void
id|ircomm_state_waitr
c_func
(paren
r_struct
id|ircomm_cb
op_star
id|self
comma
id|IRCOMM_EVENT
id|event
comma
r_struct
id|sk_buff
op_star
id|skb
)paren
(brace
r_switch
c_cond
(paren
id|event
)paren
(brace
r_case
id|IRCOMM_CONNECT_RESPONSE
suffix:colon
multiline_comment|/* issue_connect_response */
r_if
c_cond
(paren
id|self-&gt;servicetype
op_eq
id|THREE_WIRE_RAW
)paren
(brace
id|DEBUG
c_func
(paren
l_int|0
comma
l_string|&quot;ircomm:issue_connect_response:&quot;
l_string|&quot;THREE_WIRE_RAW is not implemented!&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* irlmp_connect_response(Vpeersap,&n;&t;&t;&t; *                         ACCEPT,null);&n;&t;&t;&t; */
)brace
r_else
(brace
id|ircomm_next_state
c_func
(paren
id|self
comma
id|COMM_CONN
)paren
suffix:semicolon
id|issue_connect_response
c_func
(paren
id|self
comma
id|skb
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|IRCOMM_DISCONNECT_REQUEST
suffix:colon
id|ircomm_next_state
c_func
(paren
id|self
comma
id|COMM_IDLE
)paren
suffix:semicolon
id|issue_disconnect_request
c_func
(paren
id|self
comma
id|skb
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|TTP_DISCONNECT_INDICATION
suffix:colon
id|ircomm_next_state
c_func
(paren
id|self
comma
id|COMM_IDLE
)paren
suffix:semicolon
id|disconnect_indication
c_func
(paren
id|self
comma
id|skb
)paren
suffix:semicolon
r_break
suffix:semicolon
multiline_comment|/* &t;case LMP_DISCONNECT_INDICATION: */
multiline_comment|/* &t;&t;disconnect_indication();&t;&t; */
multiline_comment|/* &t;&t;ircomm_next_state(self, COMM_IDLE);&t;&t; */
multiline_comment|/* &t;&t;break; */
r_default
suffix:colon
id|DEBUG
c_func
(paren
l_int|0
comma
l_string|&quot;ircomm_state_waitr:unknown event =%d(%s)&bslash;n&quot;
comma
id|event
comma
id|ircommevent
(braket
id|event
)braket
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/*&n; * ircomm_state_conn&n; */
DECL|function|ircomm_state_conn
r_static
r_void
id|ircomm_state_conn
c_func
(paren
r_struct
id|ircomm_cb
op_star
id|self
comma
id|IRCOMM_EVENT
id|event
comma
r_struct
id|sk_buff
op_star
id|skb
)paren
(brace
r_switch
c_cond
(paren
id|event
)paren
(brace
r_case
id|TTP_DATA_INDICATION
suffix:colon
id|process_data
c_func
(paren
id|self
comma
id|skb
)paren
suffix:semicolon
multiline_comment|/* stay CONN state*/
r_break
suffix:semicolon
r_case
id|IRCOMM_DATA_REQUEST
suffix:colon
id|issue_data_request
c_func
(paren
id|self
comma
id|skb
)paren
suffix:semicolon
multiline_comment|/* stay CONN state*/
r_break
suffix:semicolon
multiline_comment|/* &t;case LMP_DATA_INDICATION: */
multiline_comment|/* &t;&t;ircomm_data_indicated(); */
multiline_comment|/* &t;&t; stay CONN state */
multiline_comment|/* &t;&t;break; */
r_case
id|IRCOMM_CONTROL_REQUEST
suffix:colon
id|issue_control_request
c_func
(paren
id|self
comma
id|skb
)paren
suffix:semicolon
multiline_comment|/* stay CONN state*/
r_break
suffix:semicolon
r_case
id|TTP_DISCONNECT_INDICATION
suffix:colon
id|ircomm_next_state
c_func
(paren
id|self
comma
id|COMM_IDLE
)paren
suffix:semicolon
id|disconnect_indication
c_func
(paren
id|self
comma
id|skb
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|IRCOMM_DISCONNECT_REQUEST
suffix:colon
id|ircomm_next_state
c_func
(paren
id|self
comma
id|COMM_IDLE
)paren
suffix:semicolon
id|issue_disconnect_request
c_func
(paren
id|self
comma
id|skb
)paren
suffix:semicolon
r_break
suffix:semicolon
multiline_comment|/* &t;case LM_DISCONNECT_INDICATION: */
multiline_comment|/* &t;&t;disconnect_indication(); */
multiline_comment|/* &t;&t;ircomm_next_state(self, COMM_IDLE); */
multiline_comment|/* &t;&t;break; */
r_default
suffix:colon
id|DEBUG
c_func
(paren
l_int|0
comma
l_string|&quot;ircomm_state_conn:unknown event =%d(%s)&bslash;n&quot;
comma
id|event
comma
id|ircommevent
(braket
id|event
)braket
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/*&n; *  ----------------------------------------------------------------------&n; *  ircomm requests&n; *&n; *  ----------------------------------------------------------------------&n; */
DECL|function|ircomm_connect_request
r_void
id|ircomm_connect_request
c_func
(paren
r_struct
id|ircomm_cb
op_star
id|self
comma
r_int
id|maxsdusize
)paren
(brace
multiline_comment|/*&n;&t; * TODO:build a packet which contains &quot;initial control parameters&quot;&n;&t; * and send it with connect_request&n;&t; */
id|ASSERT
c_func
(paren
id|self
op_ne
l_int|NULL
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|self-&gt;magic
op_eq
id|IRCOMM_MAGIC
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
id|DEBUG
c_func
(paren
l_int|0
comma
l_string|&quot;ircomm_connect_request:&bslash;n&quot;
)paren
suffix:semicolon
id|self-&gt;maxsdusize
op_assign
id|maxsdusize
suffix:semicolon
id|ircomm_do_event
c_func
(paren
id|self
comma
id|IRCOMM_CONNECT_REQUEST
comma
l_int|NULL
)paren
suffix:semicolon
)brace
DECL|function|ircomm_connect_response
r_void
id|ircomm_connect_response
c_func
(paren
r_struct
id|ircomm_cb
op_star
id|self
comma
r_struct
id|sk_buff
op_star
id|userdata
comma
r_int
id|maxsdusize
)paren
(brace
id|ASSERT
c_func
(paren
id|self
op_ne
l_int|NULL
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|self-&gt;magic
op_eq
id|IRCOMM_MAGIC
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
multiline_comment|/* ASSERT( userdata != NULL, return;); */
id|DEBUG
c_func
(paren
l_int|4
comma
l_string|&quot;ircomm_connect_response:&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * TODO:build a packet which contains &quot;initial control parameters&quot;&n;&t; * and send it with connect_response&n;&t; */
r_if
c_cond
(paren
op_logical_neg
id|userdata
)paren
(brace
multiline_comment|/* FIXME: check for errors and initialize? DB */
id|userdata
op_assign
id|dev_alloc_skb
c_func
(paren
id|COMM_DEFAULT_DATA_SIZE
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|userdata
)paren
(brace
id|DEBUG
c_func
(paren
l_int|0
comma
id|__FUNCTION__
l_string|&quot;alloc_skb failed&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|IS_SKB
c_func
(paren
id|userdata
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
id|skb_reserve
c_func
(paren
id|userdata
comma
id|COMM_HEADER_SIZE
)paren
suffix:semicolon
)brace
multiline_comment|/* enable null-modem emulation (i.e. server mode )*/
id|self-&gt;null_modem_mode
op_assign
l_int|1
suffix:semicolon
id|self-&gt;maxsdusize
op_assign
id|maxsdusize
suffix:semicolon
r_if
c_cond
(paren
id|maxsdusize
op_ne
id|SAR_DISABLE
)paren
(brace
id|self-&gt;max_txbuff_size
op_assign
id|maxsdusize
suffix:semicolon
)brace
id|ircomm_do_event
c_func
(paren
id|self
comma
id|IRCOMM_CONNECT_RESPONSE
comma
id|userdata
)paren
suffix:semicolon
)brace
DECL|function|ircomm_disconnect_request
r_void
id|ircomm_disconnect_request
c_func
(paren
r_struct
id|ircomm_cb
op_star
id|self
comma
r_struct
id|sk_buff
op_star
id|userdata
)paren
(brace
id|ASSERT
c_func
(paren
id|self
op_ne
l_int|NULL
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|self-&gt;magic
op_eq
id|IRCOMM_MAGIC
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
id|DEBUG
c_func
(paren
l_int|0
comma
l_string|&quot;ircomm_disconnect_request&bslash;n&quot;
)paren
suffix:semicolon
id|ircomm_do_event
c_func
(paren
id|self
comma
id|IRCOMM_DISCONNECT_REQUEST
comma
l_int|NULL
)paren
suffix:semicolon
)brace
DECL|function|ircomm_data_request
r_void
id|ircomm_data_request
c_func
(paren
r_struct
id|ircomm_cb
op_star
id|self
comma
r_struct
id|sk_buff
op_star
id|userdata
)paren
(brace
id|ASSERT
c_func
(paren
id|self
op_ne
l_int|NULL
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|self-&gt;magic
op_eq
id|IRCOMM_MAGIC
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|userdata
op_ne
l_int|NULL
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
r_if
c_cond
(paren
id|self-&gt;state
op_ne
id|COMM_CONN
)paren
(brace
id|DEBUG
c_func
(paren
l_int|4
comma
l_string|&quot;ignore IRCOMM_DATA_REQUEST:not connected&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|userdata
)paren
(brace
id|dev_kfree_skb
c_func
(paren
id|userdata
)paren
suffix:semicolon
)brace
r_return
suffix:semicolon
)brace
id|DEBUG
c_func
(paren
l_int|4
comma
l_string|&quot;ircomm_data_request&bslash;n&quot;
)paren
suffix:semicolon
id|ircomm_do_event
c_func
(paren
id|self
comma
id|IRCOMM_DATA_REQUEST
comma
id|userdata
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; *  ----------------------------------------------------------------------&n; *  IrCOMM_control.req and friends&n; *&n; *  ----------------------------------------------------------------------&n; */
DECL|function|ircomm_tx_ctrlbuffer
r_static
r_void
id|ircomm_tx_ctrlbuffer
c_func
(paren
r_struct
id|ircomm_cb
op_star
id|self
)paren
(brace
id|__u8
id|clen
suffix:semicolon
r_struct
id|sk_buff
op_star
id|skb
op_assign
id|self-&gt;ctrl_skb
suffix:semicolon
id|DEBUG
c_func
(paren
l_int|4
comma
l_string|&quot;ircomm_tx_ctrlbuffer:&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* add &quot;clen&quot; field */
id|clen
op_assign
id|skb-&gt;len
suffix:semicolon
r_if
c_cond
(paren
id|clen
)paren
(brace
id|skb_push
c_func
(paren
id|skb
comma
l_int|1
)paren
suffix:semicolon
id|skb-&gt;data
(braket
l_int|0
)braket
op_assign
id|clen
suffix:semicolon
macro_line|#if 0
id|printk
c_func
(paren
l_string|&quot;tx_ctrl:&quot;
)paren
suffix:semicolon
(brace
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|skb-&gt;len
suffix:semicolon
id|i
op_increment
)paren
id|printk
c_func
(paren
l_string|&quot;%02x&quot;
comma
id|skb-&gt;data
(braket
id|i
)braket
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
)brace
macro_line|#endif
id|ircomm_do_event
c_func
(paren
id|self
comma
id|IRCOMM_CONTROL_REQUEST
comma
id|skb
)paren
suffix:semicolon
id|skb
op_assign
id|dev_alloc_skb
c_func
(paren
id|COMM_DEFAULT_DATA_SIZE
)paren
suffix:semicolon
r_if
c_cond
(paren
id|skb
op_eq
l_int|NULL
)paren
(brace
id|DEBUG
c_func
(paren
l_int|0
comma
l_string|&quot;ircomm_tx_ctrlbuffer:alloc_skb failed!&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|skb_reserve
c_func
(paren
id|skb
comma
id|COMM_HEADER_SIZE
)paren
suffix:semicolon
id|self-&gt;ctrl_skb
op_assign
id|skb
suffix:semicolon
)brace
)brace
DECL|function|ircomm_control_request
r_void
id|ircomm_control_request
c_func
(paren
r_struct
id|ircomm_cb
op_star
id|self
)paren
(brace
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
id|ASSERT
c_func
(paren
id|self
op_ne
l_int|NULL
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|self-&gt;magic
op_eq
id|IRCOMM_MAGIC
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
id|DEBUG
c_func
(paren
l_int|0
comma
l_string|&quot;ircomm_control_request:&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|self-&gt;ttp_stop
op_logical_or
id|self-&gt;state
op_ne
id|COMM_CONN
)paren
(brace
id|DEBUG
c_func
(paren
l_int|0
comma
l_string|&quot;ircomm_control_request:can&squot;t send it.. ignore it&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|skb
op_assign
id|self-&gt;ctrl_skb
suffix:semicolon
id|IS_SKB
c_func
(paren
id|skb
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
r_if
c_cond
(paren
id|skb-&gt;len
)paren
(brace
id|ircomm_tx_ctrlbuffer
c_func
(paren
id|self
)paren
suffix:semicolon
)brace
)brace
DECL|function|append_tuple
r_static
r_void
id|append_tuple
c_func
(paren
r_struct
id|ircomm_cb
op_star
id|self
comma
id|__u8
id|instruction
comma
id|__u8
id|pl
comma
id|__u8
op_star
id|value
)paren
(brace
id|__u8
op_star
id|frame
suffix:semicolon
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
r_int
id|i
comma
id|c
suffix:semicolon
id|skb
op_assign
id|self-&gt;ctrl_skb
suffix:semicolon
id|ASSERT
c_func
(paren
id|skb
op_ne
l_int|NULL
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
id|IS_SKB
c_func
(paren
id|skb
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
multiline_comment|/*if there is little room in the packet... */
r_if
c_cond
(paren
id|skb-&gt;len
OG
id|COMM_DEFAULT_DATA_SIZE
op_minus
id|COMM_HEADER_SIZE
op_minus
(paren
id|pl
op_plus
l_int|2
)paren
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|self-&gt;ttp_stop
op_logical_and
id|self-&gt;state
op_eq
id|COMM_CONN
)paren
(brace
multiline_comment|/* send a packet if we can */
id|ircomm_tx_ctrlbuffer
c_func
(paren
id|self
)paren
suffix:semicolon
id|skb
op_assign
id|self-&gt;ctrl_skb
suffix:semicolon
)brace
r_else
(brace
id|DEBUG
c_func
(paren
l_int|0
comma
l_string|&quot;ircomm_append_ctrl:there&squot;s no room.. ignore it&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* TODO: we have to detect whether we have to resend some&n;&t;&t;&t;   information after ttp_stop is cleared */
multiline_comment|/* self-&gt;resend_ctrl = 1; */
r_return
suffix:semicolon
)brace
)brace
id|frame
op_assign
id|skb_put
c_func
(paren
id|skb
comma
id|pl
op_plus
l_int|2
)paren
suffix:semicolon
id|c
op_assign
l_int|0
suffix:semicolon
id|frame
(braket
id|c
op_increment
)braket
op_assign
id|instruction
suffix:semicolon
multiline_comment|/* PI */
id|frame
(braket
id|c
op_increment
)braket
op_assign
id|pl
suffix:semicolon
multiline_comment|/* PL */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|pl
suffix:semicolon
id|i
op_increment
)paren
(brace
id|frame
(braket
id|c
op_increment
)braket
op_assign
op_star
id|value
op_increment
suffix:semicolon
)brace
multiline_comment|/* PV */
)brace
multiline_comment|/*&n; * ircomm_append_ctrl();&n; * this function is exported as a request to send some control-channel tuples&n; * to peer device&n; */
DECL|function|ircomm_append_ctrl
r_void
id|ircomm_append_ctrl
c_func
(paren
r_struct
id|ircomm_cb
op_star
id|self
comma
id|__u8
id|instruction
)paren
(brace
id|__u8
id|pv
(braket
l_int|70
)braket
suffix:semicolon
id|__u8
op_star
id|value
op_assign
op_amp
id|pv
(braket
l_int|0
)braket
suffix:semicolon
id|__u32
id|temp
suffix:semicolon
id|ASSERT
c_func
(paren
id|self
op_ne
l_int|NULL
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|self-&gt;magic
op_eq
id|IRCOMM_MAGIC
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
r_if
c_cond
(paren
id|self-&gt;state
op_ne
id|COMM_CONN
)paren
(brace
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|self-&gt;servicetype
op_eq
id|THREE_WIRE_RAW
)paren
(brace
id|DEBUG
c_func
(paren
l_int|0
comma
l_string|&quot;THREE_WIRE_RAW shuold not use me!&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|DEBUG
c_func
(paren
l_int|4
comma
l_string|&quot;ircomm_append_ctrl:&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* find parameter and its length */
r_switch
c_cond
(paren
id|instruction
)paren
(brace
r_case
id|POLL_FOR_LINE_SETTINGS
suffix:colon
r_case
id|STATUS_QUERY
suffix:colon
r_case
id|IEEE1284_MODE_SUPPORT
suffix:colon
r_case
id|IEEE1284_DEVICEID
suffix:colon
id|append_tuple
c_func
(paren
id|self
comma
id|instruction
comma
l_int|0
comma
l_int|NULL
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SERVICETYPE
suffix:colon
id|value
(braket
l_int|0
)braket
op_assign
id|self-&gt;servicetype
suffix:semicolon
id|append_tuple
c_func
(paren
id|self
comma
id|instruction
comma
l_int|1
comma
id|value
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|DATA_FORMAT
suffix:colon
id|value
(braket
l_int|0
)braket
op_assign
id|self-&gt;data_format
suffix:semicolon
id|append_tuple
c_func
(paren
id|self
comma
id|instruction
comma
l_int|1
comma
id|value
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|FLOW_CONTROL
suffix:colon
r_if
c_cond
(paren
id|self-&gt;null_modem_mode
)paren
(brace
multiline_comment|/* inside out */
id|value
(braket
l_int|0
)braket
op_assign
(paren
id|self-&gt;flow_ctrl
op_amp
l_int|0x55
)paren
op_lshift
l_int|1
suffix:semicolon
id|value
(braket
l_int|0
)braket
op_or_assign
(paren
id|self-&gt;flow_ctrl
op_amp
l_int|0xAA
)paren
op_rshift
l_int|1
suffix:semicolon
)brace
r_else
(brace
id|value
(braket
l_int|0
)braket
op_assign
id|self-&gt;flow_ctrl
suffix:semicolon
)brace
id|append_tuple
c_func
(paren
id|self
comma
id|instruction
comma
l_int|1
comma
id|value
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|LINESTATUS
suffix:colon
id|value
(braket
l_int|0
)braket
op_assign
id|self-&gt;line_status
suffix:semicolon
id|append_tuple
c_func
(paren
id|self
comma
id|instruction
comma
l_int|1
comma
id|value
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|BREAK_SIGNAL
suffix:colon
id|value
(braket
l_int|0
)braket
op_assign
id|self-&gt;break_signal
suffix:semicolon
id|append_tuple
c_func
(paren
id|self
comma
id|instruction
comma
l_int|1
comma
id|value
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|DTELINE_STATE
suffix:colon
r_if
c_cond
(paren
id|self-&gt;null_modem_mode
)paren
(brace
multiline_comment|/* null modem emulation */
multiline_comment|/* output RTS as CTS */
r_if
c_cond
(paren
id|self-&gt;dte
op_amp
id|DELTA_RTS
)paren
(brace
id|value
(braket
l_int|0
)braket
op_assign
id|DELTA_CTS
suffix:semicolon
)brace
r_if
c_cond
(paren
id|self-&gt;dte
op_amp
id|MCR_RTS
)paren
(brace
id|value
(braket
l_int|0
)braket
op_or_assign
id|MSR_CTS
suffix:semicolon
)brace
multiline_comment|/* output DTR as {DSR &amp; CD &amp; RI} */
r_if
c_cond
(paren
id|self-&gt;dte
op_amp
id|DELTA_DTR
)paren
(brace
id|value
(braket
l_int|0
)braket
op_or_assign
(paren
id|DELTA_DSR
op_or
id|DELTA_RI
op_or
id|DELTA_DCD
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|self-&gt;dte
op_amp
id|MCR_DTR
)paren
(brace
id|value
(braket
l_int|0
)braket
op_or_assign
(paren
id|MSR_DSR
op_or
id|MSR_RI
op_or
id|MSR_DCD
)paren
suffix:semicolon
)brace
id|append_tuple
c_func
(paren
id|self
comma
id|DCELINE_STATE
comma
l_int|1
comma
id|value
)paren
suffix:semicolon
)brace
r_else
(brace
id|value
(braket
l_int|0
)braket
op_assign
id|self-&gt;dte
suffix:semicolon
id|append_tuple
c_func
(paren
id|self
comma
id|instruction
comma
l_int|1
comma
id|value
)paren
suffix:semicolon
)brace
id|self-&gt;dte
op_and_assign
op_complement
(paren
id|DELTA_RTS
op_or
id|DELTA_DTR
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|DCELINE_STATE
suffix:colon
id|value
(braket
l_int|0
)braket
op_assign
id|self-&gt;dce
suffix:semicolon
id|append_tuple
c_func
(paren
id|self
comma
id|instruction
comma
l_int|1
comma
id|value
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SET_BUSY_TIMEOUT
suffix:colon
id|value
(braket
l_int|0
)braket
op_assign
id|self-&gt;busy_timeout
suffix:semicolon
id|append_tuple
c_func
(paren
id|self
comma
id|instruction
comma
l_int|1
comma
id|value
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|XON_XOFF_CHAR
suffix:colon
id|value
(braket
l_int|0
)braket
op_assign
id|self-&gt;xon_char
suffix:semicolon
id|value
(braket
l_int|1
)braket
op_assign
id|self-&gt;xoff_char
suffix:semicolon
id|append_tuple
c_func
(paren
id|self
comma
id|instruction
comma
l_int|2
comma
id|value
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ENQ_ACK_CHAR
suffix:colon
id|value
(braket
l_int|0
)braket
op_assign
id|self-&gt;enq_char
suffix:semicolon
id|value
(braket
l_int|1
)braket
op_assign
id|self-&gt;ack_char
suffix:semicolon
id|append_tuple
c_func
(paren
id|self
comma
id|instruction
comma
l_int|2
comma
id|value
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|IEEE1284_ECP_EPP_DATA_TRANSFER
suffix:colon
id|value
(braket
l_int|0
)braket
op_assign
id|self-&gt;ecp_epp_mode
suffix:semicolon
id|value
(braket
l_int|1
)braket
op_assign
id|self-&gt;channel_or_addr
suffix:semicolon
id|append_tuple
c_func
(paren
id|self
comma
id|instruction
comma
l_int|2
comma
id|value
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|DATA_RATE
suffix:colon
id|temp
op_assign
id|self-&gt;data_rate
suffix:semicolon
id|value
(braket
l_int|3
)braket
op_assign
(paren
id|__u8
)paren
(paren
(paren
id|temp
op_rshift
l_int|24
)paren
op_amp
l_int|0x000000ff
)paren
suffix:semicolon
id|value
(braket
l_int|2
)braket
op_assign
(paren
id|__u8
)paren
(paren
(paren
id|temp
op_rshift
l_int|16
)paren
op_amp
l_int|0x000000ff
)paren
suffix:semicolon
id|value
(braket
l_int|1
)braket
op_assign
(paren
id|__u8
)paren
(paren
(paren
id|temp
op_rshift
l_int|8
)paren
op_amp
l_int|0x000000ff
)paren
suffix:semicolon
id|value
(braket
l_int|0
)braket
op_assign
(paren
id|__u8
)paren
(paren
id|temp
op_amp
l_int|0x000000ff
)paren
suffix:semicolon
id|append_tuple
c_func
(paren
id|self
comma
id|instruction
comma
l_int|4
comma
id|value
)paren
suffix:semicolon
r_break
suffix:semicolon
macro_line|#if 0
r_case
id|PORT_NAME
suffix:colon
r_case
id|FIXED_PORT_NAME
suffix:colon
id|temp
op_assign
id|strlen
c_func
(paren
op_amp
id|self-&gt;port_name
)paren
suffix:semicolon
r_if
c_cond
(paren
id|temp
OL
l_int|70
)paren
(brace
id|value
op_assign
(paren
id|__u8
)paren
(paren
id|self-&gt;port_name
)paren
suffix:semicolon
id|append_tuple
c_func
(paren
id|self
comma
id|instruction
comma
id|temp
comma
id|value
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
macro_line|#endif
multiline_comment|/* TODO: control tuples for centronics emulation is not implemented */
multiline_comment|/* &t;case IEEE1284_MODE: */
r_default
suffix:colon
id|DEBUG
c_func
(paren
l_int|0
comma
l_string|&quot;ircomm_append_ctrl:instruction(0x%02x)is not&quot;
l_string|&quot;implemented&bslash;n&quot;
comma
id|instruction
)paren
suffix:semicolon
)brace
)brace
DECL|function|ircomm_parse_control
r_static
r_void
id|ircomm_parse_control
c_func
(paren
r_struct
id|ircomm_cb
op_star
id|self
comma
r_struct
id|sk_buff
op_star
id|skb
comma
r_int
id|type
)paren
(brace
id|__u8
op_star
id|data
suffix:semicolon
id|__u8
id|pi
comma
id|pl
comma
id|pv
(braket
l_int|64
)braket
suffix:semicolon
r_int
id|clen
op_assign
l_int|0
suffix:semicolon
r_int
id|i
comma
id|indicate
comma
id|count
op_assign
l_int|0
suffix:semicolon
id|data
op_assign
id|skb-&gt;data
suffix:semicolon
r_if
c_cond
(paren
id|type
op_eq
id|IAS_PARAM
)paren
(brace
id|clen
op_assign
(paren
(paren
id|data
(braket
id|count
op_increment
)braket
op_lshift
l_int|8
)paren
op_amp
id|data
(braket
id|count
op_increment
)braket
)paren
suffix:semicolon
)brace
multiline_comment|/* MSB first */
r_else
multiline_comment|/* CONTROL_CHANNEL */
id|clen
op_assign
id|data
(braket
id|count
op_increment
)braket
suffix:semicolon
r_if
c_cond
(paren
id|clen
op_eq
l_int|0
)paren
(brace
id|skb_pull
c_func
(paren
id|skb
comma
l_int|1
)paren
suffix:semicolon
multiline_comment|/* remove clen field */
r_return
suffix:semicolon
)brace
r_while
c_loop
(paren
id|count
OL
id|clen
)paren
(brace
multiline_comment|/* &n;&t;&t; * parse controlparameters and set value into structure &n;&t;&t; */
id|pi
op_assign
id|data
(braket
id|count
op_increment
)braket
suffix:semicolon
id|pl
op_assign
id|data
(braket
id|count
op_increment
)braket
suffix:semicolon
id|DEBUG
c_func
(paren
l_int|0
comma
l_string|&quot;parse_control:instruction(0x%02x)&bslash;n&quot;
comma
id|pi
)paren
suffix:semicolon
multiline_comment|/* copy a tuple into pv[] */
macro_line|#ifdef IRCOMM_DEBUG_TUPLE
id|printk
c_func
(paren
l_string|&quot;data:&quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|pl
suffix:semicolon
id|i
op_increment
)paren
(brace
id|pv
(braket
id|i
)braket
op_assign
id|data
(braket
id|count
op_increment
)braket
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;%02x&quot;
comma
id|pv
(braket
id|i
)braket
)paren
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#else
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|pl
suffix:semicolon
id|i
op_increment
)paren
(brace
id|pv
(braket
id|i
)braket
op_assign
id|data
(braket
id|count
op_increment
)braket
suffix:semicolon
)brace
macro_line|#endif&t;&t;&t;
multiline_comment|/* parse pv */
id|indicate
op_assign
l_int|0
suffix:semicolon
r_switch
c_cond
(paren
id|pi
)paren
(brace
multiline_comment|/*&n;&t;&t;&t; * for 3-wire/9-wire/centronics&n;&t;&t;&t; */
r_case
id|SERVICETYPE
suffix:colon
id|self-&gt;peer_servicetype
op_assign
id|pv
(braket
l_int|0
)braket
suffix:semicolon
r_break
suffix:semicolon
r_case
id|PORT_TYPE
suffix:colon
id|self-&gt;peer_port_type
op_assign
id|pv
(braket
l_int|0
)braket
suffix:semicolon
r_break
suffix:semicolon
macro_line|#if 0 
r_case
id|PORT_NAME
suffix:colon
id|self-&gt;peer_port_name
op_assign
op_star
id|pv
suffix:semicolon
r_break
suffix:semicolon
r_case
id|FIXED_PORT_NAME
suffix:colon
id|self-&gt;peer_port_name
op_assign
op_star
id|pv
suffix:semicolon
multiline_comment|/* &n;&t;&t;&t; * We should not connect if user of IrCOMM can&squot;t&n;&t;&t;&t; * recognize the port name&n;&t;&t;&t; */
id|self-&gt;port_name_critical
op_assign
id|TRUE
suffix:semicolon
r_break
suffix:semicolon
macro_line|#endif
r_case
id|DATA_RATE
suffix:colon
id|self-&gt;peer_data_rate
op_assign
(paren
id|pv
(braket
l_int|3
)braket
op_lshift
l_int|24
)paren
op_amp
(paren
id|pv
(braket
l_int|2
)braket
op_lshift
l_int|16
)paren
op_amp
(paren
id|pv
(braket
l_int|1
)braket
op_lshift
l_int|8
)paren
op_amp
id|pv
(braket
l_int|0
)braket
suffix:semicolon
id|indicate
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
r_case
id|DATA_FORMAT
suffix:colon
id|self-&gt;peer_data_format
op_assign
id|pv
(braket
l_int|0
)braket
suffix:semicolon
r_break
suffix:semicolon
r_case
id|FLOW_CONTROL
suffix:colon
id|self-&gt;peer_flow_ctrl
op_assign
id|pv
(braket
l_int|0
)braket
suffix:semicolon
id|indicate
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
r_case
id|XON_XOFF_CHAR
suffix:colon
id|self-&gt;peer_xon_char
op_assign
id|pv
(braket
l_int|0
)braket
suffix:semicolon
id|self-&gt;peer_xoff_char
op_assign
id|pv
(braket
l_int|1
)braket
suffix:semicolon
id|indicate
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ENQ_ACK_CHAR
suffix:colon
id|self-&gt;peer_enq_char
op_assign
id|pv
(braket
l_int|0
)braket
suffix:semicolon
id|self-&gt;peer_ack_char
op_assign
id|pv
(braket
l_int|1
)braket
suffix:semicolon
id|indicate
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
r_case
id|LINESTATUS
suffix:colon
id|self-&gt;peer_line_status
op_assign
id|pv
(braket
l_int|0
)braket
suffix:semicolon
id|indicate
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
r_case
id|BREAK_SIGNAL
suffix:colon
id|self-&gt;peer_break_signal
op_assign
id|pv
(braket
l_int|0
)braket
suffix:semicolon
multiline_comment|/* indicate = 1; */
r_break
suffix:semicolon
multiline_comment|/*&n;&t;&t;&t; * for 9-wire&n;&t;&t;&t; */
r_case
id|DTELINE_STATE
suffix:colon
r_if
c_cond
(paren
id|self-&gt;null_modem_mode
)paren
(brace
multiline_comment|/* input DTR as {DSR &amp; CD &amp; RI} */
id|self-&gt;peer_dce
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|pv
(braket
l_int|0
)braket
op_amp
id|DELTA_DTR
)paren
(brace
id|self-&gt;peer_dce
op_or_assign
id|DELTA_DSR
op_or
id|DELTA_RI
op_or
id|DELTA_DCD
suffix:semicolon
)brace
r_if
c_cond
(paren
id|pv
(braket
l_int|0
)braket
op_amp
id|MCR_DTR
)paren
(brace
id|self-&gt;peer_dce
op_or_assign
id|MSR_DSR
op_or
id|MSR_RI
op_or
id|MSR_DCD
suffix:semicolon
)brace
multiline_comment|/* rts as cts */
r_if
c_cond
(paren
id|pv
(braket
l_int|0
)braket
op_amp
id|DELTA_RTS
)paren
(brace
id|self-&gt;peer_dce
op_or_assign
id|DELTA_CTS
suffix:semicolon
)brace
r_if
c_cond
(paren
id|pv
(braket
l_int|0
)braket
op_amp
id|MCR_RTS
)paren
(brace
id|self-&gt;peer_dce
op_or_assign
id|MSR_CTS
suffix:semicolon
)brace
)brace
r_else
(brace
id|self-&gt;peer_dte
op_assign
id|pv
(braket
l_int|0
)braket
suffix:semicolon
)brace
id|indicate
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
r_case
id|DCELINE_STATE
suffix:colon
id|self-&gt;peer_dce
op_assign
id|pv
(braket
l_int|0
)braket
suffix:semicolon
id|indicate
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
r_case
id|POLL_FOR_LINE_SETTINGS
suffix:colon
id|ircomm_append_ctrl
c_func
(paren
id|self
comma
id|DTELINE_STATE
)paren
suffix:semicolon
id|ircomm_control_request
c_func
(paren
id|self
)paren
suffix:semicolon
r_break
suffix:semicolon
multiline_comment|/*&n;&t;&t;&t; * for centronics .... not implemented yet&n;&t;&t;&t; */
multiline_comment|/* &t;&t;&t;case STATUS_QUERY: */
multiline_comment|/* &t;&t;&t;case SET_BUSY_TIMEOUT: */
multiline_comment|/* &t;&t;&t;case IEEE1284_MODE_SUPPORT: */
multiline_comment|/* &t;&t;&t;case IEEE1284_DEVICEID: */
multiline_comment|/* &t;&t;&t;case IEEE1284_MODE: */
multiline_comment|/* &t;&t;&t;case IEEE1284_ECP_EPP_DATA_TRANSFER:&t; */
r_default
suffix:colon
id|DEBUG
c_func
(paren
l_int|0
comma
l_string|&quot;ircomm_parse_control:not implemented &quot;
l_string|&quot;instruction(%d)&bslash;n&quot;
comma
id|pi
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|indicate
op_logical_and
id|self-&gt;notify.flow_indication
op_logical_and
id|type
op_eq
id|CONTROL_CHANNEL
)paren
(brace
id|DEBUG
c_func
(paren
l_int|0
comma
l_string|&quot;ircomm:parse_control:indicating..:&bslash;n&quot;
)paren
suffix:semicolon
id|self-&gt;pi
op_assign
id|pi
suffix:semicolon
r_if
c_cond
(paren
id|self-&gt;notify.flow_indication
)paren
(brace
id|self-&gt;notify
dot
id|flow_indication
c_func
(paren
id|self-&gt;notify.instance
comma
id|self
comma
l_int|0
)paren
suffix:semicolon
)brace
id|indicate
op_assign
l_int|0
suffix:semicolon
)brace
)brace
id|skb_pull
c_func
(paren
id|skb
comma
l_int|1
op_plus
id|clen
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/*&n; * ----------------------------------------------------------------------&n; * Function init_module(void) ,cleanup_module()&n; *&n; *   Initializes the ircomm control structure&n; *   These Function are called when you insmod / rmmod .&n; * ----------------------------------------------------------------------&n; */
macro_line|#ifdef MODULE
DECL|function|init_module
r_int
id|init_module
c_func
(paren
r_void
)paren
(brace
id|ircomm_init
c_func
(paren
)paren
suffix:semicolon
id|DEBUG
c_func
(paren
l_int|4
comma
l_string|&quot;ircomm:init_module:done&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|cleanup_module
r_void
id|cleanup_module
c_func
(paren
r_void
)paren
(brace
id|ircomm_cleanup
c_func
(paren
)paren
suffix:semicolon
id|DEBUG
c_func
(paren
l_int|0
comma
l_string|&quot;ircomm_common:cleanup_module:done.&bslash;n&quot;
)paren
suffix:semicolon
)brace
macro_line|#endif /* MODULE */
multiline_comment|/************************************************************&n; *     proc stuff&n; ************************************************************/
macro_line|#ifdef CONFIG_PROC_FS
multiline_comment|/*&n; * Function proc_ircomm_read (buf, start, offset, len, unused)&n; *&n; * this function is called if there is a access on /proc/irda/comm .&n; *&n; */
DECL|function|ircomm_proc_read
r_int
id|ircomm_proc_read
c_func
(paren
r_char
op_star
id|buf
comma
r_char
op_star
op_star
id|start
comma
id|off_t
id|offset
comma
r_int
id|len
comma
r_int
id|unused
)paren
(brace
r_int
id|i
comma
id|index
suffix:semicolon
id|len
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|IRCOMM_MAX_CONNECTION
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|ircomm
(braket
id|i
)braket
op_eq
l_int|NULL
op_logical_or
id|ircomm
(braket
id|i
)braket
op_member_access_from_pointer
id|magic
op_ne
id|IRCOMM_MAGIC
)paren
(brace
id|len
op_add_assign
id|sprintf
c_func
(paren
id|buf
op_plus
id|len
comma
l_string|&quot;???&bslash;t&quot;
)paren
suffix:semicolon
)brace
r_else
(brace
r_switch
c_cond
(paren
id|ircomm
(braket
id|i
)braket
op_member_access_from_pointer
id|servicetype
)paren
(brace
r_case
id|UNKNOWN
suffix:colon
id|index
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_case
id|THREE_WIRE_RAW
suffix:colon
id|index
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
r_case
id|THREE_WIRE
suffix:colon
id|index
op_assign
l_int|2
suffix:semicolon
r_break
suffix:semicolon
r_case
id|NINE_WIRE
suffix:colon
id|index
op_assign
l_int|3
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CENTRONICS
suffix:colon
id|index
op_assign
l_int|4
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|index
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
)brace
id|len
op_add_assign
id|sprintf
c_func
(paren
id|buf
op_plus
id|len
comma
l_string|&quot;service: %s&bslash;t&quot;
comma
id|ircommservicetype
(braket
id|index
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
id|index
)paren
(brace
id|len
op_add_assign
id|sprintf
c_func
(paren
id|buf
op_plus
id|len
comma
l_string|&quot;porttype: %s  &quot;
comma
id|ircommporttype
(braket
id|ircomm
(braket
id|i
)braket
op_member_access_from_pointer
id|port_type
)braket
)paren
suffix:semicolon
id|len
op_add_assign
id|sprintf
c_func
(paren
id|buf
op_plus
id|len
comma
l_string|&quot;state: %s  &quot;
comma
id|ircommstate
(braket
id|ircomm
(braket
id|i
)braket
op_member_access_from_pointer
id|state
)braket
)paren
suffix:semicolon
id|len
op_add_assign
id|sprintf
c_func
(paren
id|buf
op_plus
id|len
comma
l_string|&quot;user: %s  &quot;
comma
id|ircomm
(braket
id|i
)braket
op_member_access_from_pointer
id|notify.name
)paren
suffix:semicolon
id|len
op_add_assign
id|sprintf
c_func
(paren
id|buf
op_plus
id|len
comma
l_string|&quot;nullmodem emulation: %s&quot;
comma
(paren
id|ircomm
(braket
id|i
)braket
op_member_access_from_pointer
id|null_modem_mode
ques
c_cond
l_string|&quot;yes&quot;
suffix:colon
l_string|&quot;no&quot;
)paren
)paren
suffix:semicolon
)brace
)brace
id|len
op_add_assign
id|sprintf
c_func
(paren
id|buf
op_plus
id|len
comma
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_return
id|len
suffix:semicolon
)brace
macro_line|#endif /* CONFIG_PROC_FS */
eof
