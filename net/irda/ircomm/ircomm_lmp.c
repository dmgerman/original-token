multiline_comment|/*********************************************************************&n; *                &n; * Filename:      ircomm_lmp.c&n; * Version:       1.0&n; * Description:   Interface between IrCOMM and IrLMP&n; * Status:        Stable&n; * Author:        Dag Brattli &lt;dagb@cs.uit.no&gt;&n; * Created at:    Sun Jun  6 20:48:27 1999&n; * Modified at:   Sun Dec 12 13:44:17 1999&n; * Modified by:   Dag Brattli &lt;dagb@cs.uit.no&gt;&n; * Sources:       Previous IrLPT work by Thomas Davis&n; * &n; *     Copyright (c) 1999 Dag Brattli, All Rights Reserved.&n; *     &n; *     This program is free software; you can redistribute it and/or &n; *     modify it under the terms of the GNU General Public License as &n; *     published by the Free Software Foundation; either version 2 of &n; *     the License, or (at your option) any later version.&n; * &n; *     This program is distributed in the hope that it will be useful,&n; *     but WITHOUT ANY WARRANTY; without even the implied warranty of&n; *     MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the&n; *     GNU General Public License for more details.&n; * &n; *     You should have received a copy of the GNU General Public License &n; *     along with this program; if not, write to the Free Software &n; *     Foundation, Inc., 59 Temple Place, Suite 330, Boston, &n; *     MA 02111-1307 USA&n; *     &n; ********************************************************************/
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;net/irda/irda.h&gt;
macro_line|#include &lt;net/irda/irlmp.h&gt;
macro_line|#include &lt;net/irda/iriap.h&gt;
macro_line|#include &lt;net/irda/ircomm_event.h&gt;
macro_line|#include &lt;net/irda/ircomm_lmp.h&gt;
multiline_comment|/*&n; * Function ircomm_open_lsap (self)&n; *&n; *    Open LSAP. This function will only be used when using &quot;raw&quot; services&n; *&n; */
DECL|function|ircomm_open_lsap
r_int
id|ircomm_open_lsap
c_func
(paren
r_struct
id|ircomm_cb
op_star
id|self
)paren
(brace
id|notify_t
id|notify
suffix:semicolon
id|IRDA_DEBUG
c_func
(paren
l_int|0
comma
id|__FUNCTION__
l_string|&quot;()&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* Register callbacks */
id|irda_notify_init
c_func
(paren
op_amp
id|notify
)paren
suffix:semicolon
id|notify.data_indication
op_assign
id|ircomm_lmp_data_indication
suffix:semicolon
id|notify.connect_confirm
op_assign
id|ircomm_lmp_connect_confirm
suffix:semicolon
id|notify.connect_indication
op_assign
id|ircomm_lmp_connect_indication
suffix:semicolon
id|notify.disconnect_indication
op_assign
id|ircomm_lmp_disconnect_indication
suffix:semicolon
id|notify.instance
op_assign
id|self
suffix:semicolon
id|strncpy
c_func
(paren
id|notify.name
comma
l_string|&quot;IrCOMM&quot;
comma
id|NOTIFY_MAX_NAME
)paren
suffix:semicolon
id|self-&gt;lsap
op_assign
id|irlmp_open_lsap
c_func
(paren
id|LSAP_ANY
comma
op_amp
id|notify
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|self-&gt;lsap
)paren
(brace
id|IRDA_DEBUG
c_func
(paren
l_int|0
comma
id|__FUNCTION__
l_string|&quot;failed to allocate tsap&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|self-&gt;slsap_sel
op_assign
id|self-&gt;lsap-&gt;slsap_sel
suffix:semicolon
multiline_comment|/*&n;&t; *  Initialize the call-table for issuing commands&n;&t; */
id|self-&gt;issue.data_request
op_assign
id|ircomm_lmp_data_request
suffix:semicolon
id|self-&gt;issue.connect_request
op_assign
id|ircomm_lmp_connect_request
suffix:semicolon
id|self-&gt;issue.connect_response
op_assign
id|ircomm_lmp_connect_response
suffix:semicolon
id|self-&gt;issue.disconnect_request
op_assign
id|ircomm_lmp_disconnect_request
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * Function ircomm_lmp_connect_request (self, userdata)&n; *&n; *    &n; *&n; */
DECL|function|ircomm_lmp_connect_request
r_int
id|ircomm_lmp_connect_request
c_func
(paren
r_struct
id|ircomm_cb
op_star
id|self
comma
r_struct
id|sk_buff
op_star
id|userdata
comma
r_struct
id|ircomm_info
op_star
id|info
)paren
(brace
r_int
id|ret
op_assign
l_int|0
suffix:semicolon
id|IRDA_DEBUG
c_func
(paren
l_int|0
comma
id|__FUNCTION__
l_string|&quot;()&bslash;n&quot;
)paren
suffix:semicolon
id|ret
op_assign
id|irlmp_connect_request
c_func
(paren
id|self-&gt;lsap
comma
id|info-&gt;dlsap_sel
comma
id|info-&gt;saddr
comma
id|info-&gt;daddr
comma
l_int|NULL
comma
id|userdata
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
multiline_comment|/*&n; * Function ircomm_lmp_connect_response (self, skb)&n; *&n; *    &n; *&n; */
DECL|function|ircomm_lmp_connect_response
r_int
id|ircomm_lmp_connect_response
c_func
(paren
r_struct
id|ircomm_cb
op_star
id|self
comma
r_struct
id|sk_buff
op_star
id|skb
)paren
(brace
r_int
id|ret
suffix:semicolon
id|IRDA_DEBUG
c_func
(paren
l_int|0
comma
id|__FUNCTION__
l_string|&quot;()&bslash;n&quot;
)paren
suffix:semicolon
id|ret
op_assign
id|irlmp_connect_response
c_func
(paren
id|self-&gt;lsap
comma
id|skb
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|ircomm_lmp_disconnect_request
r_int
id|ircomm_lmp_disconnect_request
c_func
(paren
r_struct
id|ircomm_cb
op_star
id|self
comma
r_struct
id|sk_buff
op_star
id|userdata
comma
r_struct
id|ircomm_info
op_star
id|info
)paren
(brace
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
r_int
id|ret
suffix:semicolon
id|IRDA_DEBUG
c_func
(paren
l_int|0
comma
id|__FUNCTION__
l_string|&quot;()&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|userdata
)paren
(brace
id|skb
op_assign
id|dev_alloc_skb
c_func
(paren
l_int|64
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|skb
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
multiline_comment|/*  Reserve space for MUX and LAP header */
id|skb_reserve
c_func
(paren
id|skb
comma
id|LMP_MAX_HEADER
)paren
suffix:semicolon
id|userdata
op_assign
id|skb
suffix:semicolon
)brace
id|ret
op_assign
id|irlmp_disconnect_request
c_func
(paren
id|self-&gt;lsap
comma
id|userdata
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
multiline_comment|/*&n; * Function ircomm_lmp_flow_control (skb)&n; *&n; *    This function is called when a data frame we have sent to IrLAP has&n; *    been deallocated. We do this to make sure we don&squot;t flood IrLAP with &n; *    frames, since we are not using the IrTTP flow control mechanism&n; */
DECL|function|ircomm_lmp_flow_control
r_void
id|ircomm_lmp_flow_control
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
)paren
(brace
r_struct
id|irda_skb_cb
op_star
id|cb
suffix:semicolon
r_struct
id|ircomm_cb
op_star
id|self
suffix:semicolon
r_int
id|line
suffix:semicolon
id|ASSERT
c_func
(paren
id|skb
op_ne
l_int|NULL
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
id|cb
op_assign
(paren
r_struct
id|irda_skb_cb
op_star
)paren
id|skb-&gt;cb
suffix:semicolon
id|IRDA_DEBUG
c_func
(paren
l_int|2
comma
id|__FUNCTION__
l_string|&quot;()&bslash;n&quot;
)paren
suffix:semicolon
id|line
op_assign
id|cb-&gt;line
suffix:semicolon
id|self
op_assign
(paren
r_struct
id|ircomm_cb
op_star
)paren
id|hashbin_find
c_func
(paren
id|ircomm
comma
id|line
comma
l_int|NULL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|self
)paren
(brace
id|IRDA_DEBUG
c_func
(paren
l_int|2
comma
id|__FUNCTION__
l_string|&quot;(), didn&squot;t find myself&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|ASSERT
c_func
(paren
id|self
op_ne
l_int|NULL
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|self-&gt;magic
op_eq
id|IRCOMM_MAGIC
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
id|self-&gt;pkt_count
op_decrement
suffix:semicolon
r_if
c_cond
(paren
(paren
id|self-&gt;pkt_count
OL
l_int|2
)paren
op_logical_and
(paren
id|self-&gt;flow_status
op_eq
id|FLOW_STOP
)paren
)paren
(brace
id|IRDA_DEBUG
c_func
(paren
l_int|2
comma
id|__FUNCTION__
l_string|&quot;(), asking TTY to start again!&bslash;n&quot;
)paren
suffix:semicolon
id|self-&gt;flow_status
op_assign
id|FLOW_START
suffix:semicolon
r_if
c_cond
(paren
id|self-&gt;notify.flow_indication
)paren
id|self-&gt;notify
dot
id|flow_indication
c_func
(paren
id|self-&gt;notify.instance
comma
id|self
comma
id|FLOW_START
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/*&n; * Function ircomm_lmp_data_request (self, userdata)&n; *&n; *    Send data frame to peer device&n; *&n; */
DECL|function|ircomm_lmp_data_request
r_int
id|ircomm_lmp_data_request
c_func
(paren
r_struct
id|ircomm_cb
op_star
id|self
comma
r_struct
id|sk_buff
op_star
id|skb
comma
r_int
id|not_used
)paren
(brace
r_struct
id|irda_skb_cb
op_star
id|cb
suffix:semicolon
r_int
id|ret
suffix:semicolon
id|ASSERT
c_func
(paren
id|skb
op_ne
l_int|NULL
comma
r_return
op_minus
l_int|1
suffix:semicolon
)paren
suffix:semicolon
id|cb
op_assign
(paren
r_struct
id|irda_skb_cb
op_star
)paren
id|skb-&gt;cb
suffix:semicolon
id|cb-&gt;line
op_assign
id|self-&gt;line
suffix:semicolon
id|IRDA_DEBUG
c_func
(paren
l_int|4
comma
id|__FUNCTION__
l_string|&quot;(), sending frame&bslash;n&quot;
)paren
suffix:semicolon
id|skb-&gt;destructor
op_assign
id|ircomm_lmp_flow_control
suffix:semicolon
r_if
c_cond
(paren
(paren
id|self-&gt;pkt_count
op_increment
OG
l_int|7
)paren
op_logical_and
(paren
id|self-&gt;flow_status
op_eq
id|FLOW_START
)paren
)paren
(brace
id|IRDA_DEBUG
c_func
(paren
l_int|2
comma
id|__FUNCTION__
l_string|&quot;(), asking TTY to slow down!&bslash;n&quot;
)paren
suffix:semicolon
id|self-&gt;flow_status
op_assign
id|FLOW_STOP
suffix:semicolon
r_if
c_cond
(paren
id|self-&gt;notify.flow_indication
)paren
id|self-&gt;notify
dot
id|flow_indication
c_func
(paren
id|self-&gt;notify.instance
comma
id|self
comma
id|FLOW_STOP
)paren
suffix:semicolon
)brace
id|ret
op_assign
id|irlmp_data_request
c_func
(paren
id|self-&gt;lsap
comma
id|skb
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
)paren
(brace
id|ERROR
c_func
(paren
id|__FUNCTION__
l_string|&quot;(), failed&bslash;n&quot;
)paren
suffix:semicolon
id|dev_kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
)brace
r_return
id|ret
suffix:semicolon
)brace
multiline_comment|/*&n; * Function ircomm_lmp_data_indication (instance, sap, skb)&n; *&n; *    Incomming data which we must deliver to the state machine, to check&n; *    we are still connected.&n; */
DECL|function|ircomm_lmp_data_indication
r_int
id|ircomm_lmp_data_indication
c_func
(paren
r_void
op_star
id|instance
comma
r_void
op_star
id|sap
comma
r_struct
id|sk_buff
op_star
id|skb
)paren
(brace
r_struct
id|ircomm_cb
op_star
id|self
op_assign
(paren
r_struct
id|ircomm_cb
op_star
)paren
id|instance
suffix:semicolon
id|IRDA_DEBUG
c_func
(paren
l_int|4
comma
id|__FUNCTION__
l_string|&quot;()&bslash;n&quot;
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|self
op_ne
l_int|NULL
comma
r_return
op_minus
l_int|1
suffix:semicolon
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|self-&gt;magic
op_eq
id|IRCOMM_MAGIC
comma
r_return
op_minus
l_int|1
suffix:semicolon
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|skb
op_ne
l_int|NULL
comma
r_return
op_minus
l_int|1
suffix:semicolon
)paren
suffix:semicolon
id|ircomm_do_event
c_func
(paren
id|self
comma
id|IRCOMM_LMP_DATA_INDICATION
comma
id|skb
comma
l_int|NULL
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * Function ircomm_lmp_connect_confirm (instance, sap, qos, max_sdu_size, &n; *                                       max_header_size, skb)&n; *&n; *    Connection has been confirmed by peer device&n; *&n; */
DECL|function|ircomm_lmp_connect_confirm
r_void
id|ircomm_lmp_connect_confirm
c_func
(paren
r_void
op_star
id|instance
comma
r_void
op_star
id|sap
comma
r_struct
id|qos_info
op_star
id|qos
comma
id|__u32
id|max_seg_size
comma
id|__u8
id|max_header_size
comma
r_struct
id|sk_buff
op_star
id|skb
)paren
(brace
r_struct
id|ircomm_cb
op_star
id|self
op_assign
(paren
r_struct
id|ircomm_cb
op_star
)paren
id|instance
suffix:semicolon
r_struct
id|ircomm_info
id|info
suffix:semicolon
id|IRDA_DEBUG
c_func
(paren
l_int|0
comma
id|__FUNCTION__
l_string|&quot;()&bslash;n&quot;
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|self
op_ne
l_int|NULL
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|self-&gt;magic
op_eq
id|IRCOMM_MAGIC
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|skb
op_ne
l_int|NULL
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|qos
op_ne
l_int|NULL
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
id|info.max_data_size
op_assign
id|max_seg_size
suffix:semicolon
id|info.max_header_size
op_assign
id|max_header_size
suffix:semicolon
id|info.qos
op_assign
id|qos
suffix:semicolon
id|ircomm_do_event
c_func
(paren
id|self
comma
id|IRCOMM_LMP_CONNECT_CONFIRM
comma
id|skb
comma
op_amp
id|info
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Function ircomm_lmp_connect_indication (instance, sap, qos, max_sdu_size,&n; *                                         max_header_size, skb)&n; *&n; *    Peer device wants to make a connection with us&n; *&n; */
DECL|function|ircomm_lmp_connect_indication
r_void
id|ircomm_lmp_connect_indication
c_func
(paren
r_void
op_star
id|instance
comma
r_void
op_star
id|sap
comma
r_struct
id|qos_info
op_star
id|qos
comma
id|__u32
id|max_seg_size
comma
id|__u8
id|max_header_size
comma
r_struct
id|sk_buff
op_star
id|skb
)paren
(brace
r_struct
id|ircomm_cb
op_star
id|self
op_assign
(paren
r_struct
id|ircomm_cb
op_star
)paren
id|instance
suffix:semicolon
r_struct
id|ircomm_info
id|info
suffix:semicolon
id|IRDA_DEBUG
c_func
(paren
l_int|0
comma
id|__FUNCTION__
l_string|&quot;()&bslash;n&quot;
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|self
op_ne
l_int|NULL
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|self-&gt;magic
op_eq
id|IRCOMM_MAGIC
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|skb
op_ne
l_int|NULL
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|qos
op_ne
l_int|NULL
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
id|info.max_data_size
op_assign
id|max_seg_size
suffix:semicolon
id|info.max_header_size
op_assign
id|max_header_size
suffix:semicolon
id|info.qos
op_assign
id|qos
suffix:semicolon
id|ircomm_do_event
c_func
(paren
id|self
comma
id|IRCOMM_LMP_CONNECT_INDICATION
comma
id|skb
comma
op_amp
id|info
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Function ircomm_lmp_disconnect_indication (instance, sap, reason, skb)&n; *&n; *    Peer device has closed the connection, or the link went down for some&n; *    other reason&n; */
DECL|function|ircomm_lmp_disconnect_indication
r_void
id|ircomm_lmp_disconnect_indication
c_func
(paren
r_void
op_star
id|instance
comma
r_void
op_star
id|sap
comma
id|LM_REASON
id|reason
comma
r_struct
id|sk_buff
op_star
id|skb
)paren
(brace
r_struct
id|ircomm_cb
op_star
id|self
op_assign
(paren
r_struct
id|ircomm_cb
op_star
)paren
id|instance
suffix:semicolon
r_struct
id|ircomm_info
id|info
suffix:semicolon
id|IRDA_DEBUG
c_func
(paren
l_int|0
comma
id|__FUNCTION__
l_string|&quot;()&bslash;n&quot;
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|self
op_ne
l_int|NULL
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|self-&gt;magic
op_eq
id|IRCOMM_MAGIC
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
id|info.reason
op_assign
id|reason
suffix:semicolon
id|ircomm_do_event
c_func
(paren
id|self
comma
id|IRCOMM_LMP_DISCONNECT_INDICATION
comma
id|skb
comma
op_amp
id|info
)paren
suffix:semicolon
)brace
eof
