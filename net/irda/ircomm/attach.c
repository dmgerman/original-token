multiline_comment|/*********************************************************************&n; *                &n; * Filename:      attach.c&n; * Version:       &n; * Description:   An implementation of IrCOMM service interface.&n; * Status:        Experimental.&n; * Author:        Takahide Higuchi &lt;thiguchi@pluto.dti.ne.jp&gt;&n; *&n; *     Copyright (c) 1998, Takahide Higuchi, &lt;thiguchi@pluto.dti.ne.jp&gt;,&n; *     All Rights Reserved.&n; *&n; *     This program is free software; you can redistribute it and/or&n; *     modify it under the terms of the GNU General Public License as&n; *     published by the Free Software Foundation; either version 2 of&n; *     the License, or (at your option) any later version.&n; *&n; *     I, Takahide Higuchi, provide no warranty for any of this software.&n; *     This material is provided &quot;AS-IS&quot; and at no charge.&n; *&n; ********************************************************************/
multiline_comment|/*&n; * ----------------------------------------------------------------------&n; * IrIAS related things for IrCOMM&n; * If you are to use ircomm layer, use ircomm_attach_cable to&n; * setup it and register your program.&n; * ----------------------------------------------------------------------&n; */
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/tqueue.h&gt;
macro_line|#include &lt;net/irda/irlap.h&gt;
macro_line|#include &lt;net/irda/irttp.h&gt;
macro_line|#include &lt;net/irda/iriap.h&gt;
macro_line|#include &lt;net/irda/irias_object.h&gt;
macro_line|#include &lt;net/irda/ircomm_common.h&gt;
r_extern
r_struct
id|ircomm_cb
op_star
op_star
id|ircomm
suffix:semicolon
DECL|variable|discovering_instance
r_struct
id|ircomm_cb
op_star
id|discovering_instance
suffix:semicolon
r_static
r_void
id|got_lsapsel
c_func
(paren
r_struct
id|ircomm_cb
op_star
id|info
)paren
suffix:semicolon
r_static
r_void
id|query_lsapsel
c_func
(paren
r_struct
id|ircomm_cb
op_star
id|self
)paren
suffix:semicolon
r_void
id|ircomm_getvalue_confirm
c_func
(paren
id|__u16
id|obj_id
comma
r_struct
id|ias_value
op_star
id|value
comma
r_void
op_star
id|priv
)paren
suffix:semicolon
macro_line|#if 0
r_static
r_char
op_star
id|rcsid
op_assign
l_string|&quot;$Id: attach.c,v 1.11 1998/10/22 12:02:20 dagb Exp $&quot;
suffix:semicolon
macro_line|#endif
multiline_comment|/*&n; * handler for iriap_getvaluebyclass_request() &n; *&n; */
DECL|function|ircomm_getvalue_confirm
r_void
(def_block
id|ircomm_getvalue_confirm
c_func
(paren
id|__u16
id|obj_id
comma
r_struct
id|ias_value
op_star
id|value
comma
r_void
op_star
id|priv
)paren
(brace
r_struct
id|ircomm_cb
op_star
id|self
op_assign
(paren
r_struct
id|ircomm_cb
op_star
)paren
id|priv
suffix:semicolon
id|ASSERT
c_func
(paren
id|self
op_ne
l_int|NULL
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|self-&gt;magic
op_eq
id|IRCOMM_MAGIC
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
id|DEBUG
c_func
(paren
l_int|0
comma
id|__FUNCTION__
l_string|&quot;type(%d)&bslash;n&quot;
comma
id|value-&gt;type
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|value-&gt;type
)paren
(brace
r_case
id|IAS_OCT_SEQ
suffix:colon
multiline_comment|/* &n;&t;&t; * FIXME:we should use data which came here&n;&t;&t; * it is used for nothing at this time &n;&t;&t; */
macro_line|#if 1
id|DEBUG
c_func
(paren
l_int|0
comma
l_string|&quot;octet sequence is:&bslash;n&quot;
)paren
suffix:semicolon
(brace
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|value-&gt;len
suffix:semicolon
id|i
op_increment
)paren
id|printk
c_func
(paren
l_string|&quot;%02x&quot;
comma
(paren
r_int
)paren
(paren
op_star
id|value-&gt;t.oct_seq
op_plus
id|i
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
)brace
macro_line|#endif
id|query_lsapsel
c_func
(paren
id|self
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|IAS_INTEGER
suffix:colon
multiline_comment|/* LsapSel seems to be sent to me */
r_if
c_cond
(paren
id|value-&gt;t.integer
op_eq
op_minus
l_int|1
)paren
(brace
id|DEBUG
c_func
(paren
l_int|0
comma
l_string|&quot;ircomm_getvalue_confirm: invalid value!&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|self-&gt;state
op_eq
id|COMM_IDLE
)paren
(brace
id|self-&gt;dlsap
op_assign
id|value-&gt;t.integer
suffix:semicolon
id|got_lsapsel
c_func
(paren
id|self
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|IAS_STRING
suffix:colon
id|DEBUG
c_func
(paren
l_int|0
comma
id|__FUNCTION__
l_string|&quot;:STRING is not implemented&bslash;n&quot;
)paren
suffix:semicolon
id|DEBUG
c_func
(paren
l_int|0
comma
id|__FUNCTION__
l_string|&quot;:received string:%s&bslash;n&quot;
comma
id|value-&gt;t.string
)paren
suffix:semicolon
id|query_lsapsel
c_func
(paren
id|self
)paren
suffix:semicolon
multiline_comment|/* experiment */
r_break
suffix:semicolon
r_case
id|IAS_MISSING
suffix:colon
id|DEBUG
c_func
(paren
l_int|0
comma
id|__FUNCTION__
l_string|&quot;:MISSING is not implemented&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|DEBUG
c_func
(paren
l_int|0
comma
id|__FUNCTION__
l_string|&quot;:unknown type!&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
)def_block
DECL|function|got_lsapsel
r_static
r_void
(def_block
id|got_lsapsel
c_func
(paren
r_struct
id|ircomm_cb
op_star
id|self
)paren
(brace
r_struct
id|notify_t
id|notify
suffix:semicolon
id|DEBUG
c_func
(paren
l_int|0
comma
l_string|&quot;ircomm:got_lsapsel: got peersap!(%d)&bslash;n&quot;
comma
id|self-&gt;dlsap
)paren
suffix:semicolon
multiline_comment|/* remove tsap for server */
id|irttp_close_tsap
c_func
(paren
id|self-&gt;tsap
)paren
suffix:semicolon
multiline_comment|/* create TSAP for initiater ... */
id|irda_notify_init
c_func
(paren
op_amp
id|notify
)paren
suffix:semicolon
id|notify.data_indication
op_assign
id|ircomm_accept_data_indication
suffix:semicolon
id|notify.connect_confirm
op_assign
id|ircomm_accept_connect_confirm
suffix:semicolon
id|notify.connect_indication
op_assign
id|ircomm_accept_connect_indication
suffix:semicolon
id|notify.flow_indication
op_assign
id|ircomm_accept_flow_indication
suffix:semicolon
id|notify.disconnect_indication
op_assign
id|ircomm_accept_disconnect_indication
suffix:semicolon
id|strncpy
c_func
(paren
id|notify.name
comma
l_string|&quot;IrCOMM cli&quot;
comma
id|NOTIFY_MAX_NAME
)paren
suffix:semicolon
id|notify.instance
op_assign
id|self
suffix:semicolon
id|self-&gt;tsap
op_assign
id|irttp_open_tsap
c_func
(paren
id|LSAP_ANY
comma
id|DEFAULT_INITIAL_CREDIT
comma
op_amp
id|notify
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|self-&gt;tsap
op_ne
l_int|NULL
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * invoke state machine  &n;&t; * and notify that I&squot;m ready to accept connect_request&n;&t; */
id|ircomm_next_state
c_func
(paren
id|self
comma
id|COMM_IDLE
)paren
suffix:semicolon
r_if
c_cond
(paren
id|self-&gt;d_handler
)paren
(brace
id|self
op_member_access_from_pointer
id|d_handler
c_func
(paren
id|self
)paren
suffix:semicolon
)brace
)brace
)def_block
DECL|function|query_lsapsel
r_static
r_void
(def_block
id|query_lsapsel
c_func
(paren
r_struct
id|ircomm_cb
op_star
id|self
)paren
(brace
id|DEBUG
c_func
(paren
l_int|0
comma
l_string|&quot;ircomm:query_lsapsel..&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/*  &n;&t; *  since we&squot;ve got Parameters field of IAS, we are to get peersap.&n;&t; */
r_if
c_cond
(paren
op_logical_neg
(paren
id|self-&gt;servicetype
op_amp
id|THREE_WIRE_RAW
)paren
)paren
(brace
id|iriap_getvaluebyclass_request
(paren
id|self-&gt;daddr
comma
l_string|&quot;IrDA:IrCOMM&quot;
comma
l_string|&quot;IrDA:TinyTP:LsapSel&quot;
comma
id|ircomm_getvalue_confirm
comma
id|self
)paren
suffix:semicolon
)brace
r_else
(brace
id|DEBUG
c_func
(paren
l_int|0
comma
l_string|&quot;ircomm:query_lsap:&quot;
l_string|&quot;THREE_WIRE_RAW is not implemented!&bslash;n&quot;
)paren
suffix:semicolon
)brace
)brace
)def_block
multiline_comment|/*&n; * ircomm_discovery_indication()&n; *    Remote device is discovered, try query the remote IAS to see which&n; *    device it is, and which services it has.&n; */
DECL|function|ircomm_discovery_indication
r_void
id|ircomm_discovery_indication
c_func
(paren
id|DISCOVERY
op_star
id|discovery
)paren
(brace
r_struct
id|ircomm_cb
op_star
id|self
suffix:semicolon
id|DEBUG
c_func
(paren
l_int|0
comma
l_string|&quot;ircomm_discovery_indication&bslash;n&quot;
)paren
suffix:semicolon
id|self
op_assign
id|discovering_instance
suffix:semicolon
id|ASSERT
c_func
(paren
id|self
op_ne
l_int|NULL
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|self-&gt;magic
op_eq
id|IRCOMM_MAGIC
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
id|self-&gt;daddr
op_assign
id|discovery-&gt;daddr
suffix:semicolon
id|DEBUG
c_func
(paren
l_int|0
comma
l_string|&quot;ircomm_discovery_indication:daddr=%08x&bslash;n&quot;
comma
id|self-&gt;daddr
)paren
suffix:semicolon
multiline_comment|/* query &quot;Parameters&quot; attribute of LM-IAS */
id|DEBUG
c_func
(paren
l_int|0
comma
l_string|&quot;ircomm:querying parameters..&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#if 0
id|iriap_getvaluebyclass_request
c_func
(paren
id|self-&gt;daddr
comma
l_string|&quot;IrDA:IrCOMM&quot;
comma
l_string|&quot;Parameters&quot;
comma
id|ircomm_getvalue_confirm
comma
id|self
)paren
suffix:semicolon
macro_line|#else
id|query_lsapsel
c_func
(paren
id|self
)paren
suffix:semicolon
macro_line|#endif
r_return
suffix:semicolon
)brace
DECL|function|ircomm_attach_cable
r_struct
id|ircomm_cb
op_star
(def_block
id|ircomm_attach_cable
c_func
(paren
id|__u8
id|servicetype
comma
r_struct
id|notify_t
id|notify
comma
r_void
op_star
id|handler
)paren
(brace
r_int
id|i
suffix:semicolon
r_struct
id|ircomm_cb
op_star
id|self
op_assign
l_int|NULL
suffix:semicolon
r_struct
id|notify_t
id|server_notify
suffix:semicolon
r_struct
id|ias_object
op_star
id|obj
suffix:semicolon
multiline_comment|/* FIXME: it should not be hard coded */
id|__u8
id|oct_seq
(braket
l_int|6
)braket
op_assign
(brace
l_int|0
comma
l_int|1
comma
l_int|4
comma
l_int|1
comma
l_int|1
comma
l_int|1
)brace
suffix:semicolon
id|ASSERT
c_func
(paren
id|ircomm
op_ne
l_int|NULL
comma
r_return
l_int|NULL
suffix:semicolon
)paren
suffix:semicolon
id|DEBUG
c_func
(paren
l_int|0
comma
l_string|&quot;ircomm_attach_cable:&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* find free handle */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|IRCOMM_MAX_CONNECTION
suffix:semicolon
id|i
op_increment
)paren
(brace
id|ASSERT
c_func
(paren
id|ircomm
(braket
id|i
)braket
op_ne
l_int|NULL
comma
r_return
(paren
l_int|NULL
)paren
suffix:semicolon
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ircomm
(braket
id|i
)braket
op_member_access_from_pointer
id|in_use
)paren
(brace
id|self
op_assign
id|ircomm
(braket
id|i
)braket
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
op_logical_neg
id|self
)paren
(brace
id|DEBUG
c_func
(paren
l_int|0
comma
l_string|&quot;ircomm_attach_cable:no free handle!&bslash;n&quot;
)paren
suffix:semicolon
r_return
(paren
l_int|NULL
)paren
suffix:semicolon
)brace
id|self-&gt;in_use
op_assign
l_int|1
suffix:semicolon
id|self-&gt;servicetype
op_assign
id|servicetype
suffix:semicolon
id|DEBUG
c_func
(paren
l_int|0
comma
l_string|&quot;attach_cable:servicetype:%d&bslash;n&quot;
comma
id|servicetype
)paren
suffix:semicolon
id|self-&gt;d_handler
op_assign
id|handler
suffix:semicolon
id|self-&gt;notify
op_assign
id|notify
suffix:semicolon
multiline_comment|/* register server.. */
multiline_comment|/*&n;&t; * TODO: since server TSAP is currentry hard coded,&n;&t; * we can use *only one* IrCOMM connection.&n;&t; * We have to create one more TSAP and register IAS entry dynamically &n;&t; * each time when we are to allocate new server here.&n;&t; */
id|irda_notify_init
c_func
(paren
op_amp
id|server_notify
)paren
suffix:semicolon
id|server_notify.data_indication
op_assign
id|ircomm_accept_data_indication
suffix:semicolon
id|server_notify.connect_confirm
op_assign
id|ircomm_accept_connect_confirm
suffix:semicolon
id|server_notify.connect_indication
op_assign
id|ircomm_accept_connect_indication
suffix:semicolon
id|server_notify.flow_indication
op_assign
id|ircomm_accept_flow_indication
suffix:semicolon
id|server_notify.disconnect_indication
op_assign
id|ircomm_accept_disconnect_indication
suffix:semicolon
id|server_notify.instance
op_assign
id|self
suffix:semicolon
id|strncpy
c_func
(paren
id|server_notify.name
comma
l_string|&quot;IrCOMM srv&quot;
comma
id|NOTIFY_MAX_NAME
)paren
suffix:semicolon
id|self-&gt;tsap
op_assign
id|irttp_open_tsap
c_func
(paren
id|LSAP_ANY
comma
id|DEFAULT_INITIAL_CREDIT
comma
op_amp
id|server_notify
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|self-&gt;tsap
)paren
(brace
id|DEBUG
c_func
(paren
l_int|0
comma
l_string|&quot;ircomm:Sorry, failed to allocate server_tsap&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
multiline_comment|/* &n;         *  Register with LM-IAS&n;         */
id|obj
op_assign
id|irias_new_object
c_func
(paren
l_string|&quot;IrDA:IrCOMM&quot;
comma
id|IAS_IRCOMM_ID
)paren
suffix:semicolon
id|irias_add_integer_attrib
c_func
(paren
id|obj
comma
l_string|&quot;IrDA:TinyTP:LsapSel&quot;
comma
id|self-&gt;tsap-&gt;stsap_sel
)paren
suffix:semicolon
multiline_comment|/* FIXME: it should not be hard coded */
id|irias_add_octseq_attrib
c_func
(paren
id|obj
comma
l_string|&quot;Parameters&quot;
comma
op_amp
id|oct_seq
(braket
l_int|0
)braket
comma
l_int|6
)paren
suffix:semicolon
id|irias_insert_object
c_func
(paren
id|obj
)paren
suffix:semicolon
multiline_comment|/* &t;obj = irias_new_object( &quot;IrDA:IrCOMM&quot;, IAS_IRCOMM_ID); */
multiline_comment|/* &t;irias_add_octseq_attrib( obj, &quot;Parameters&quot;, len, &amp;octseq); */
multiline_comment|/* &t;irias_insert_object( obj); */
multiline_comment|/* and start discovering .. */
id|discovering_instance
op_assign
id|self
suffix:semicolon
r_switch
c_cond
(paren
id|servicetype
)paren
(brace
r_case
id|NINE_WIRE
suffix:colon
id|DEBUG
c_func
(paren
l_int|0
comma
l_string|&quot;ircomm_attach_cable:discovering..&bslash;n&quot;
)paren
suffix:semicolon
id|irlmp_register_layer
c_func
(paren
id|S_COMM
comma
id|CLIENT
op_or
id|SERVER
comma
id|TRUE
comma
id|ircomm_discovery_indication
)paren
suffix:semicolon
r_break
suffix:semicolon
multiline_comment|/* &t;case CENTRONICS: */
multiline_comment|/* &t;case THREE_WIRE: */
multiline_comment|/* &t;case THREE_WIRE_RAW: */
r_default
suffix:colon
id|DEBUG
c_func
(paren
l_int|0
comma
l_string|&quot;ircomm_attach_cable:requested servicetype is not &quot;
l_string|&quot;implemented!&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
id|ircomm_next_state
c_func
(paren
id|self
comma
id|COMM_IDLE
)paren
suffix:semicolon
r_return
(paren
id|self
)paren
suffix:semicolon
)brace
)def_block
DECL|function|ircomm_detach_cable
r_int
(def_block
id|ircomm_detach_cable
c_func
(paren
r_struct
id|ircomm_cb
op_star
id|self
)paren
(brace
id|ASSERT
c_func
(paren
id|self
op_ne
l_int|NULL
comma
r_return
op_minus
id|EIO
suffix:semicolon
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|self-&gt;magic
op_eq
id|IRCOMM_MAGIC
comma
r_return
op_minus
id|EIO
suffix:semicolon
)paren
suffix:semicolon
id|DEBUG
c_func
(paren
l_int|0
comma
l_string|&quot;ircomm_detach_cable:&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* shutdown ircomm layer */
r_if
c_cond
(paren
id|self-&gt;state
op_ne
id|COMM_IDLE
)paren
(brace
id|DEBUG
c_func
(paren
l_int|0
comma
l_string|&quot;ircomm:detach_cable:not IDLE&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|self-&gt;state
op_ne
id|COMM_WAITI
)paren
(brace
id|ircomm_disconnect_request
c_func
(paren
id|self
comma
l_int|NULL
)paren
suffix:semicolon
)brace
)brace
r_switch
c_cond
(paren
id|self-&gt;servicetype
)paren
(brace
multiline_comment|/* &t;case CENTRONICS: */
r_case
id|NINE_WIRE
suffix:colon
multiline_comment|/* &t;case THREE_WIRE: */
id|irlmp_unregister_layer
c_func
(paren
id|S_COMM
comma
id|CLIENT
op_or
id|SERVER
)paren
suffix:semicolon
r_break
suffix:semicolon
multiline_comment|/* &t;case THREE_WIRE_RAW: */
multiline_comment|/* &t;&t;irlmp_unregister( S_COMM ) */
multiline_comment|/*&t;&t;irlmp_unregister( S_PRINTER) */
multiline_comment|/* &t;&t;break; */
r_default
suffix:colon
id|DEBUG
c_func
(paren
l_int|0
comma
l_string|&quot;ircomm_detach_cable:requested servicetype is not &quot;
l_string|&quot;implemented!&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
multiline_comment|/* remove tsaps */
r_if
c_cond
(paren
id|self-&gt;tsap
)paren
(brace
id|irttp_close_tsap
c_func
(paren
id|self-&gt;tsap
)paren
suffix:semicolon
)brace
id|self-&gt;tsap
op_assign
l_int|NULL
suffix:semicolon
id|self-&gt;in_use
op_assign
l_int|0
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
)def_block
eof
