multiline_comment|/*********************************************************************&n; *                &n; * Filename:      iriap.c&n; * Version:       0.8&n; * Description:   Information Access Protocol (IAP)&n; * Status:        Experimental.&n; * Author:        Dag Brattli &lt;dagb@cs.uit.no&gt;&n; * Created at:    Thu Aug 21 00:02:07 1997&n; * Modified at:   Sat Dec 25 16:42:42 1999&n; * Modified by:   Dag Brattli &lt;dagb@cs.uit.no&gt;&n; * &n; *     Copyright (c) 1998-1999 Dag Brattli &lt;dagb@cs.uit.no&gt;, &n; *     All Rights Reserved.&n; *     &n; *     This program is free software; you can redistribute it and/or &n; *     modify it under the terms of the GNU General Public License as &n; *     published by the Free Software Foundation; either version 2 of &n; *     the License, or (at your option) any later version.&n; *&n; *     Neither Dag Brattli nor University of Troms&#xfffd; admit liability nor&n; *     provide warranty for any of this software. This material is &n; *     provided &quot;AS-IS&quot; and at no charge.&n; *&n; ********************************************************************/
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/skbuff.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;asm/byteorder.h&gt;
macro_line|#include &lt;asm/unaligned.h&gt;
macro_line|#include &lt;net/irda/irda.h&gt;
macro_line|#include &lt;net/irda/irttp.h&gt;
macro_line|#include &lt;net/irda/irmod.h&gt;
macro_line|#include &lt;net/irda/irlmp.h&gt;
macro_line|#include &lt;net/irda/irias_object.h&gt;
macro_line|#include &lt;net/irda/iriap_event.h&gt;
macro_line|#include &lt;net/irda/iriap.h&gt;
multiline_comment|/* FIXME: This one should go in irlmp.c */
DECL|variable|ias_charset_types
r_static
r_const
r_char
op_star
id|ias_charset_types
(braket
)braket
op_assign
(brace
l_string|&quot;CS_ASCII&quot;
comma
l_string|&quot;CS_ISO_8859_1&quot;
comma
l_string|&quot;CS_ISO_8859_2&quot;
comma
l_string|&quot;CS_ISO_8859_3&quot;
comma
l_string|&quot;CS_ISO_8859_4&quot;
comma
l_string|&quot;CS_ISO_8859_5&quot;
comma
l_string|&quot;CS_ISO_8859_6&quot;
comma
l_string|&quot;CS_ISO_8859_7&quot;
comma
l_string|&quot;CS_ISO_8859_8&quot;
comma
l_string|&quot;CS_ISO_8859_9&quot;
comma
l_string|&quot;CS_UNICODE&quot;
)brace
suffix:semicolon
DECL|variable|iriap
r_static
id|hashbin_t
op_star
id|iriap
op_assign
l_int|NULL
suffix:semicolon
DECL|variable|service_handle
r_static
id|__u32
id|service_handle
suffix:semicolon
r_extern
r_char
op_star
id|lmp_reasons
(braket
)braket
suffix:semicolon
r_static
r_void
id|__iriap_close
c_func
(paren
r_struct
id|iriap_cb
op_star
id|self
)paren
suffix:semicolon
r_static
r_int
id|iriap_register_lsap
c_func
(paren
r_struct
id|iriap_cb
op_star
id|self
comma
id|__u8
id|slsap_sel
comma
r_int
id|mode
)paren
suffix:semicolon
r_static
r_void
id|iriap_disconnect_indication
c_func
(paren
r_void
op_star
id|instance
comma
r_void
op_star
id|sap
comma
id|LM_REASON
id|reason
comma
r_struct
id|sk_buff
op_star
id|skb
)paren
suffix:semicolon
r_static
r_void
id|iriap_connect_indication
c_func
(paren
r_void
op_star
id|instance
comma
r_void
op_star
id|sap
comma
r_struct
id|qos_info
op_star
id|qos
comma
id|__u32
id|max_sdu_size
comma
id|__u8
id|max_header_size
comma
r_struct
id|sk_buff
op_star
id|skb
)paren
suffix:semicolon
r_static
r_void
id|iriap_connect_confirm
c_func
(paren
r_void
op_star
id|instance
comma
r_void
op_star
id|sap
comma
r_struct
id|qos_info
op_star
id|qos
comma
id|__u32
id|max_sdu_size
comma
id|__u8
id|max_header_size
comma
r_struct
id|sk_buff
op_star
id|skb
)paren
suffix:semicolon
r_static
r_int
id|iriap_data_indication
c_func
(paren
r_void
op_star
id|instance
comma
r_void
op_star
id|sap
comma
r_struct
id|sk_buff
op_star
id|skb
)paren
suffix:semicolon
multiline_comment|/*&n; * Function iriap_init (void)&n; *&n; *    Initializes the IrIAP layer, called by the module initialization code&n; *    in irmod.c &n; */
DECL|function|iriap_init
r_int
id|__init
id|iriap_init
c_func
(paren
r_void
)paren
(brace
r_struct
id|ias_object
op_star
id|obj
suffix:semicolon
r_struct
id|iriap_cb
op_star
id|server
suffix:semicolon
id|__u8
id|oct_seq
(braket
l_int|6
)braket
suffix:semicolon
id|__u16
id|hints
suffix:semicolon
multiline_comment|/* Allocate master array */
id|iriap
op_assign
id|hashbin_new
c_func
(paren
id|HB_LOCAL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|iriap
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|objects
op_assign
id|hashbin_new
c_func
(paren
id|HB_LOCAL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|objects
)paren
(brace
id|WARNING
c_func
(paren
id|__FUNCTION__
l_string|&quot;(), Can&squot;t allocate objects hashbin!&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
multiline_comment|/* &n;&t; *  Register some default services for IrLMP &n;&t; */
id|hints
op_assign
id|irlmp_service_to_hint
c_func
(paren
id|S_COMPUTER
)paren
suffix:semicolon
id|service_handle
op_assign
id|irlmp_register_service
c_func
(paren
id|hints
)paren
suffix:semicolon
multiline_comment|/* Register the Device object with LM-IAS */
id|obj
op_assign
id|irias_new_object
c_func
(paren
l_string|&quot;Device&quot;
comma
id|IAS_DEVICE_ID
)paren
suffix:semicolon
id|irias_add_string_attrib
c_func
(paren
id|obj
comma
l_string|&quot;DeviceName&quot;
comma
l_string|&quot;Linux&quot;
comma
id|IAS_KERNEL_ATTR
)paren
suffix:semicolon
id|oct_seq
(braket
l_int|0
)braket
op_assign
l_int|0x01
suffix:semicolon
multiline_comment|/* Version 1 */
id|oct_seq
(braket
l_int|1
)braket
op_assign
l_int|0x00
suffix:semicolon
multiline_comment|/* IAS support bits */
id|oct_seq
(braket
l_int|2
)braket
op_assign
l_int|0x00
suffix:semicolon
multiline_comment|/* LM-MUX support bits */
macro_line|#ifdef CONFIG_IRDA_ULTRA
id|oct_seq
(braket
l_int|2
)braket
op_or_assign
l_int|0x04
suffix:semicolon
multiline_comment|/* Connectionless Data support */
macro_line|#endif
id|irias_add_octseq_attrib
c_func
(paren
id|obj
comma
l_string|&quot;IrLMPSupport&quot;
comma
id|oct_seq
comma
l_int|3
comma
id|IAS_KERNEL_ATTR
)paren
suffix:semicolon
id|irias_insert_object
c_func
(paren
id|obj
)paren
suffix:semicolon
multiline_comment|/*  &n;&t; *  Register server support with IrLMP so we can accept incoming &n;&t; *  connections &n;&t; */
id|server
op_assign
id|iriap_open
c_func
(paren
id|LSAP_IAS
comma
id|IAS_SERVER
comma
l_int|NULL
comma
l_int|NULL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|server
)paren
(brace
id|IRDA_DEBUG
c_func
(paren
l_int|0
comma
id|__FUNCTION__
l_string|&quot;(), unable to open server&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|iriap_register_lsap
c_func
(paren
id|server
comma
id|LSAP_IAS
comma
id|IAS_SERVER
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * Function iriap_cleanup (void)&n; *&n; *    Initializes the IrIAP layer, called by the module cleanup code in &n; *    irmod.c&n; */
DECL|function|iriap_cleanup
r_void
id|iriap_cleanup
c_func
(paren
r_void
)paren
(brace
id|irlmp_unregister_service
c_func
(paren
id|service_handle
)paren
suffix:semicolon
id|hashbin_delete
c_func
(paren
id|iriap
comma
(paren
id|FREE_FUNC
)paren
id|__iriap_close
)paren
suffix:semicolon
id|hashbin_delete
c_func
(paren
id|objects
comma
(paren
id|FREE_FUNC
)paren
id|__irias_delete_object
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Function iriap_open (void)&n; *&n; *    Opens an instance of the IrIAP layer, and registers with IrLMP&n; */
DECL|function|iriap_open
r_struct
id|iriap_cb
op_star
id|iriap_open
c_func
(paren
id|__u8
id|slsap_sel
comma
r_int
id|mode
comma
r_void
op_star
id|priv
comma
id|CONFIRM_CALLBACK
id|callback
)paren
(brace
r_struct
id|iriap_cb
op_star
id|self
suffix:semicolon
id|IRDA_DEBUG
c_func
(paren
l_int|2
comma
id|__FUNCTION__
l_string|&quot;()&bslash;n&quot;
)paren
suffix:semicolon
id|self
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|iriap_cb
)paren
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|self
)paren
(brace
id|WARNING
c_func
(paren
id|__FUNCTION__
l_string|&quot;(), Unable to kmalloc!&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
multiline_comment|/*&n;&t; *  Initialize instance&n;&t; */
id|memset
c_func
(paren
id|self
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|iriap_cb
)paren
)paren
suffix:semicolon
id|self-&gt;magic
op_assign
id|IAS_MAGIC
suffix:semicolon
id|self-&gt;mode
op_assign
id|mode
suffix:semicolon
r_if
c_cond
(paren
id|mode
op_eq
id|IAS_CLIENT
)paren
id|iriap_register_lsap
c_func
(paren
id|self
comma
id|slsap_sel
comma
id|mode
)paren
suffix:semicolon
id|self-&gt;confirm
op_assign
id|callback
suffix:semicolon
id|self-&gt;priv
op_assign
id|priv
suffix:semicolon
id|init_timer
c_func
(paren
op_amp
id|self-&gt;watchdog_timer
)paren
suffix:semicolon
id|hashbin_insert
c_func
(paren
id|iriap
comma
(paren
id|irda_queue_t
op_star
)paren
id|self
comma
(paren
r_int
)paren
id|self
comma
l_int|NULL
)paren
suffix:semicolon
multiline_comment|/* Initialize state machines */
id|iriap_next_client_state
c_func
(paren
id|self
comma
id|S_DISCONNECT
)paren
suffix:semicolon
id|iriap_next_call_state
c_func
(paren
id|self
comma
id|S_MAKE_CALL
)paren
suffix:semicolon
id|iriap_next_server_state
c_func
(paren
id|self
comma
id|R_DISCONNECT
)paren
suffix:semicolon
id|iriap_next_r_connect_state
c_func
(paren
id|self
comma
id|R_WAITING
)paren
suffix:semicolon
r_return
id|self
suffix:semicolon
)brace
multiline_comment|/*&n; * Function __iriap_close (self)&n; *&n; *    Removes (deallocates) the IrIAP instance&n; *&n; */
DECL|function|__iriap_close
r_static
r_void
id|__iriap_close
c_func
(paren
r_struct
id|iriap_cb
op_star
id|self
)paren
(brace
id|IRDA_DEBUG
c_func
(paren
l_int|4
comma
id|__FUNCTION__
l_string|&quot;()&bslash;n&quot;
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|self
op_ne
l_int|NULL
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|self-&gt;magic
op_eq
id|IAS_MAGIC
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
id|del_timer
c_func
(paren
op_amp
id|self-&gt;watchdog_timer
)paren
suffix:semicolon
r_if
c_cond
(paren
id|self-&gt;skb
)paren
id|dev_kfree_skb
c_func
(paren
id|self-&gt;skb
)paren
suffix:semicolon
id|self-&gt;magic
op_assign
l_int|0
suffix:semicolon
id|kfree
c_func
(paren
id|self
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Function iriap_close (void)&n; *&n; *    Closes IrIAP and deregisters with IrLMP&n; */
DECL|function|iriap_close
r_void
id|iriap_close
c_func
(paren
r_struct
id|iriap_cb
op_star
id|self
)paren
(brace
r_struct
id|iriap_cb
op_star
id|entry
suffix:semicolon
id|IRDA_DEBUG
c_func
(paren
l_int|2
comma
id|__FUNCTION__
l_string|&quot;()&bslash;n&quot;
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|self
op_ne
l_int|NULL
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|self-&gt;magic
op_eq
id|IAS_MAGIC
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
r_if
c_cond
(paren
id|self-&gt;lsap
)paren
(brace
id|irlmp_close_lsap
c_func
(paren
id|self-&gt;lsap
)paren
suffix:semicolon
id|self-&gt;lsap
op_assign
l_int|NULL
suffix:semicolon
)brace
id|entry
op_assign
(paren
r_struct
id|iriap_cb
op_star
)paren
id|hashbin_remove
c_func
(paren
id|iriap
comma
(paren
r_int
)paren
id|self
comma
l_int|NULL
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|entry
op_eq
id|self
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
id|__iriap_close
c_func
(paren
id|self
)paren
suffix:semicolon
)brace
DECL|function|iriap_register_lsap
r_static
r_int
id|iriap_register_lsap
c_func
(paren
r_struct
id|iriap_cb
op_star
id|self
comma
id|__u8
id|slsap_sel
comma
r_int
id|mode
)paren
(brace
id|notify_t
id|notify
suffix:semicolon
id|IRDA_DEBUG
c_func
(paren
l_int|2
comma
id|__FUNCTION__
l_string|&quot;()&bslash;n&quot;
)paren
suffix:semicolon
id|irda_notify_init
c_func
(paren
op_amp
id|notify
)paren
suffix:semicolon
id|notify.connect_confirm
op_assign
id|iriap_connect_confirm
suffix:semicolon
id|notify.connect_indication
op_assign
id|iriap_connect_indication
suffix:semicolon
id|notify.disconnect_indication
op_assign
id|iriap_disconnect_indication
suffix:semicolon
id|notify.data_indication
op_assign
id|iriap_data_indication
suffix:semicolon
id|notify.instance
op_assign
id|self
suffix:semicolon
r_if
c_cond
(paren
id|mode
op_eq
id|IAS_CLIENT
)paren
id|strcpy
c_func
(paren
id|notify.name
comma
l_string|&quot;IrIAS cli&quot;
)paren
suffix:semicolon
r_else
id|strcpy
c_func
(paren
id|notify.name
comma
l_string|&quot;IrIAS srv&quot;
)paren
suffix:semicolon
id|self-&gt;lsap
op_assign
id|irlmp_open_lsap
c_func
(paren
id|slsap_sel
comma
op_amp
id|notify
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|self-&gt;lsap
op_eq
l_int|NULL
)paren
(brace
id|ERROR
c_func
(paren
id|__FUNCTION__
l_string|&quot;(), Unable to allocated LSAP!&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|self-&gt;slsap_sel
op_assign
id|self-&gt;lsap-&gt;slsap_sel
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * Function iriap_disconnect_indication (handle, reason)&n; *&n; *    Got disconnect, so clean up everything assosiated with this connection&n; *&n; */
DECL|function|iriap_disconnect_indication
r_static
r_void
id|iriap_disconnect_indication
c_func
(paren
r_void
op_star
id|instance
comma
r_void
op_star
id|sap
comma
id|LM_REASON
id|reason
comma
r_struct
id|sk_buff
op_star
id|userdata
)paren
(brace
r_struct
id|iriap_cb
op_star
id|self
suffix:semicolon
id|IRDA_DEBUG
c_func
(paren
l_int|4
comma
id|__FUNCTION__
l_string|&quot;(), reason=%s&bslash;n&quot;
comma
id|lmp_reasons
(braket
id|reason
)braket
)paren
suffix:semicolon
id|self
op_assign
(paren
r_struct
id|iriap_cb
op_star
)paren
id|instance
suffix:semicolon
id|ASSERT
c_func
(paren
id|self
op_ne
l_int|NULL
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|self-&gt;magic
op_eq
id|IAS_MAGIC
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|iriap
op_ne
l_int|NULL
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
id|del_timer
c_func
(paren
op_amp
id|self-&gt;watchdog_timer
)paren
suffix:semicolon
r_if
c_cond
(paren
id|self-&gt;mode
op_eq
id|IAS_CLIENT
)paren
(brace
id|IRDA_DEBUG
c_func
(paren
l_int|4
comma
id|__FUNCTION__
l_string|&quot;(), disconnect as client&bslash;n&quot;
)paren
suffix:semicolon
id|iriap_do_client_event
c_func
(paren
id|self
comma
id|IAP_LM_DISCONNECT_INDICATION
comma
l_int|NULL
)paren
suffix:semicolon
multiline_comment|/* &n;&t;&t; * Inform service user that the request failed by sending &n;&t;&t; * it a NULL value. Warning, the client might close us, so&n;&t;&t; * remember no to use self anymore after calling confirm&n;&t;&t; */
r_if
c_cond
(paren
id|self-&gt;confirm
)paren
id|self
op_member_access_from_pointer
id|confirm
c_func
(paren
id|IAS_DISCONNECT
comma
l_int|0
comma
l_int|NULL
comma
id|self-&gt;priv
)paren
suffix:semicolon
)brace
r_else
(brace
id|IRDA_DEBUG
c_func
(paren
l_int|4
comma
id|__FUNCTION__
l_string|&quot;(), disconnect as server&bslash;n&quot;
)paren
suffix:semicolon
id|iriap_do_server_event
c_func
(paren
id|self
comma
id|IAP_LM_DISCONNECT_INDICATION
comma
l_int|NULL
)paren
suffix:semicolon
id|iriap_close
c_func
(paren
id|self
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|userdata
)paren
id|dev_kfree_skb
c_func
(paren
id|userdata
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Function iriap_disconnect_request (handle)&n; *&n; *    &n; *&n; */
DECL|function|iriap_disconnect_request
r_void
id|iriap_disconnect_request
c_func
(paren
r_struct
id|iriap_cb
op_star
id|self
)paren
(brace
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
id|IRDA_DEBUG
c_func
(paren
l_int|4
comma
id|__FUNCTION__
l_string|&quot;()&bslash;n&quot;
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|self
op_ne
l_int|NULL
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|self-&gt;magic
op_eq
id|IAS_MAGIC
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
id|skb
op_assign
id|dev_alloc_skb
c_func
(paren
l_int|64
)paren
suffix:semicolon
r_if
c_cond
(paren
id|skb
op_eq
l_int|NULL
)paren
(brace
id|IRDA_DEBUG
c_func
(paren
l_int|0
comma
id|__FUNCTION__
l_string|&quot;(), Could not allocate an sk_buff of length %d&bslash;n&quot;
comma
l_int|64
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/* &n;&t; *  Reserve space for MUX control and LAP header &n;&t; */
id|skb_reserve
c_func
(paren
id|skb
comma
id|LMP_MAX_HEADER
)paren
suffix:semicolon
id|irlmp_disconnect_request
c_func
(paren
id|self-&gt;lsap
comma
id|skb
)paren
suffix:semicolon
)brace
DECL|function|iriap_getinfobasedetails_request
r_void
id|iriap_getinfobasedetails_request
c_func
(paren
r_void
)paren
(brace
id|IRDA_DEBUG
c_func
(paren
l_int|0
comma
id|__FUNCTION__
l_string|&quot;(), Not implemented!&bslash;n&quot;
)paren
suffix:semicolon
)brace
DECL|function|iriap_getinfobasedetails_confirm
r_void
id|iriap_getinfobasedetails_confirm
c_func
(paren
r_void
)paren
(brace
id|IRDA_DEBUG
c_func
(paren
l_int|0
comma
id|__FUNCTION__
l_string|&quot;(), Not implemented!&bslash;n&quot;
)paren
suffix:semicolon
)brace
DECL|function|iriap_getobjects_request
r_void
id|iriap_getobjects_request
c_func
(paren
r_void
)paren
(brace
id|IRDA_DEBUG
c_func
(paren
l_int|0
comma
id|__FUNCTION__
l_string|&quot;(), Not implemented!&bslash;n&quot;
)paren
suffix:semicolon
)brace
DECL|function|iriap_getobjects_confirm
r_void
id|iriap_getobjects_confirm
c_func
(paren
r_void
)paren
(brace
id|IRDA_DEBUG
c_func
(paren
l_int|0
comma
id|__FUNCTION__
l_string|&quot;(), Not implemented!&bslash;n&quot;
)paren
suffix:semicolon
)brace
DECL|function|iriap_getvalue
r_void
id|iriap_getvalue
c_func
(paren
r_void
)paren
(brace
id|IRDA_DEBUG
c_func
(paren
l_int|0
comma
id|__FUNCTION__
l_string|&quot;(), Not implemented!&bslash;n&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Function iriap_getvaluebyclass (addr, name, attr)&n; *&n; *    Retreive all values from attribute in all objects with given class&n; *    name&n; */
DECL|function|iriap_getvaluebyclass_request
r_int
id|iriap_getvaluebyclass_request
c_func
(paren
r_struct
id|iriap_cb
op_star
id|self
comma
id|__u32
id|saddr
comma
id|__u32
id|daddr
comma
r_char
op_star
id|name
comma
r_char
op_star
id|attr
)paren
(brace
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
r_int
id|name_len
comma
id|attr_len
suffix:semicolon
id|__u8
op_star
id|frame
suffix:semicolon
id|ASSERT
c_func
(paren
id|self
op_ne
l_int|NULL
comma
r_return
op_minus
l_int|1
suffix:semicolon
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|self-&gt;magic
op_eq
id|IAS_MAGIC
comma
r_return
op_minus
l_int|1
suffix:semicolon
)paren
suffix:semicolon
multiline_comment|/* Client must supply the destination device address */
r_if
c_cond
(paren
op_logical_neg
id|daddr
)paren
r_return
op_minus
l_int|1
suffix:semicolon
id|self-&gt;daddr
op_assign
id|daddr
suffix:semicolon
id|self-&gt;saddr
op_assign
id|saddr
suffix:semicolon
multiline_comment|/* &n;&t; *  Save operation, so we know what the later indication is about&n;&t; */
id|self-&gt;operation
op_assign
id|GET_VALUE_BY_CLASS
suffix:semicolon
multiline_comment|/* Give ourselves 10 secs to finish this operation */
id|iriap_start_watchdog_timer
c_func
(paren
id|self
comma
l_int|10
op_star
id|HZ
)paren
suffix:semicolon
id|skb
op_assign
id|dev_alloc_skb
c_func
(paren
l_int|64
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|skb
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|name_len
op_assign
id|strlen
c_func
(paren
id|name
)paren
suffix:semicolon
id|attr_len
op_assign
id|strlen
c_func
(paren
id|attr
)paren
suffix:semicolon
multiline_comment|/* Reserve space for MUX and LAP header */
id|skb_reserve
c_func
(paren
id|skb
comma
id|self-&gt;max_header_size
)paren
suffix:semicolon
id|skb_put
c_func
(paren
id|skb
comma
l_int|3
op_plus
id|name_len
op_plus
id|attr_len
)paren
suffix:semicolon
id|frame
op_assign
id|skb-&gt;data
suffix:semicolon
multiline_comment|/* Build frame */
id|frame
(braket
l_int|0
)braket
op_assign
id|IAP_LST
op_or
id|GET_VALUE_BY_CLASS
suffix:semicolon
id|frame
(braket
l_int|1
)braket
op_assign
id|name_len
suffix:semicolon
multiline_comment|/* Insert length of name */
id|memcpy
c_func
(paren
id|frame
op_plus
l_int|2
comma
id|name
comma
id|name_len
)paren
suffix:semicolon
multiline_comment|/* Insert name */
id|frame
(braket
l_int|2
op_plus
id|name_len
)braket
op_assign
id|attr_len
suffix:semicolon
multiline_comment|/* Insert length of attr */
id|memcpy
c_func
(paren
id|frame
op_plus
l_int|3
op_plus
id|name_len
comma
id|attr
comma
id|attr_len
)paren
suffix:semicolon
multiline_comment|/* Insert attr */
id|iriap_do_client_event
c_func
(paren
id|self
comma
id|IAP_CALL_REQUEST_GVBC
comma
id|skb
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * Function iriap_getvaluebyclass_confirm (self, skb)&n; *&n; *    Got result from GetValueByClass command. Parse it and return result&n; *    to service user.&n; *&n; */
DECL|function|iriap_getvaluebyclass_confirm
r_void
id|iriap_getvaluebyclass_confirm
c_func
(paren
r_struct
id|iriap_cb
op_star
id|self
comma
r_struct
id|sk_buff
op_star
id|skb
)paren
(brace
r_struct
id|ias_value
op_star
id|value
suffix:semicolon
r_int
id|charset
suffix:semicolon
id|__u32
id|value_len
suffix:semicolon
id|__u32
id|tmp_cpu32
suffix:semicolon
id|__u16
id|obj_id
suffix:semicolon
id|__u16
id|len
suffix:semicolon
id|__u8
id|type
suffix:semicolon
id|__u8
op_star
id|fp
suffix:semicolon
r_int
id|n
suffix:semicolon
id|ASSERT
c_func
(paren
id|self
op_ne
l_int|NULL
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|self-&gt;magic
op_eq
id|IAS_MAGIC
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|skb
op_ne
l_int|NULL
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
multiline_comment|/* Initialize variables */
id|fp
op_assign
id|skb-&gt;data
suffix:semicolon
id|n
op_assign
l_int|2
suffix:semicolon
multiline_comment|/* Get length, MSB first */
id|len
op_assign
id|be16_to_cpu
c_func
(paren
id|get_unaligned
c_func
(paren
(paren
id|__u16
op_star
)paren
(paren
id|fp
op_plus
id|n
)paren
)paren
)paren
suffix:semicolon
id|n
op_add_assign
l_int|2
suffix:semicolon
id|IRDA_DEBUG
c_func
(paren
l_int|4
comma
id|__FUNCTION__
l_string|&quot;(), len=%d&bslash;n&quot;
comma
id|len
)paren
suffix:semicolon
multiline_comment|/* Get object ID, MSB first */
id|obj_id
op_assign
id|be16_to_cpu
c_func
(paren
id|get_unaligned
c_func
(paren
(paren
id|__u16
op_star
)paren
(paren
id|fp
op_plus
id|n
)paren
)paren
)paren
suffix:semicolon
id|n
op_add_assign
l_int|2
suffix:semicolon
id|type
op_assign
id|fp
(braket
id|n
op_increment
)braket
suffix:semicolon
id|IRDA_DEBUG
c_func
(paren
l_int|4
comma
id|__FUNCTION__
l_string|&quot;(), Value type = %d&bslash;n&quot;
comma
id|type
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|type
)paren
(brace
r_case
id|IAS_INTEGER
suffix:colon
id|memcpy
c_func
(paren
op_amp
id|tmp_cpu32
comma
id|fp
op_plus
id|n
comma
l_int|4
)paren
suffix:semicolon
id|n
op_add_assign
l_int|4
suffix:semicolon
id|be32_to_cpus
c_func
(paren
op_amp
id|tmp_cpu32
)paren
suffix:semicolon
id|value
op_assign
id|irias_new_integer_value
c_func
(paren
id|tmp_cpu32
)paren
suffix:semicolon
multiline_comment|/*  Legal values restricted to 0x01-0x6f, page 15 irttp */
id|IRDA_DEBUG
c_func
(paren
l_int|4
comma
id|__FUNCTION__
l_string|&quot;(), lsap=%d&bslash;n&quot;
comma
id|value-&gt;t.integer
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|IAS_STRING
suffix:colon
id|charset
op_assign
id|fp
(braket
id|n
op_increment
)braket
suffix:semicolon
r_switch
c_cond
(paren
id|charset
)paren
(brace
r_case
id|CS_ASCII
suffix:colon
r_break
suffix:semicolon
multiline_comment|/* &t;&t;case CS_ISO_8859_1: */
multiline_comment|/* &t;&t;case CS_ISO_8859_2: */
multiline_comment|/* &t;&t;case CS_ISO_8859_3: */
multiline_comment|/* &t;&t;case CS_ISO_8859_4: */
multiline_comment|/* &t;&t;case CS_ISO_8859_5: */
multiline_comment|/* &t;&t;case CS_ISO_8859_6: */
multiline_comment|/* &t;&t;case CS_ISO_8859_7: */
multiline_comment|/* &t;&t;case CS_ISO_8859_8: */
multiline_comment|/* &t;&t;case CS_ISO_8859_9: */
multiline_comment|/* &t;&t;case CS_UNICODE: */
r_default
suffix:colon
id|IRDA_DEBUG
c_func
(paren
l_int|0
comma
id|__FUNCTION__
l_string|&quot;(), charset %s, not supported&bslash;n&quot;
comma
id|ias_charset_types
(braket
id|charset
)braket
)paren
suffix:semicolon
multiline_comment|/* Aborting, close connection! */
id|iriap_disconnect_request
c_func
(paren
id|self
)paren
suffix:semicolon
id|dev_kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
r_return
suffix:semicolon
multiline_comment|/* break; */
)brace
id|value_len
op_assign
id|fp
(braket
id|n
op_increment
)braket
suffix:semicolon
id|IRDA_DEBUG
c_func
(paren
l_int|4
comma
id|__FUNCTION__
l_string|&quot;(), strlen=%d&bslash;n&quot;
comma
id|value_len
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|value_len
OL
l_int|64
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
multiline_comment|/* Make sure the string is null-terminated */
id|fp
(braket
id|n
op_plus
id|value_len
)braket
op_assign
l_int|0x00
suffix:semicolon
id|IRDA_DEBUG
c_func
(paren
l_int|4
comma
l_string|&quot;Got string %s&bslash;n&quot;
comma
id|fp
op_plus
id|n
)paren
suffix:semicolon
id|value
op_assign
id|irias_new_string_value
c_func
(paren
id|fp
op_plus
id|n
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|IAS_OCT_SEQ
suffix:colon
id|value_len
op_assign
id|be16_to_cpu
c_func
(paren
id|get_unaligned
c_func
(paren
(paren
id|__u16
op_star
)paren
(paren
id|fp
op_plus
id|n
)paren
)paren
)paren
suffix:semicolon
id|n
op_add_assign
l_int|2
suffix:semicolon
id|ASSERT
c_func
(paren
id|value_len
op_le
l_int|55
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
id|value
op_assign
id|irias_new_octseq_value
c_func
(paren
id|fp
op_plus
id|n
comma
id|value_len
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|value
op_assign
id|irias_new_missing_value
c_func
(paren
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
multiline_comment|/* Finished, close connection! */
id|iriap_disconnect_request
c_func
(paren
id|self
)paren
suffix:semicolon
multiline_comment|/* Warning, the client might close us, so remember no to use self&n;&t; * anymore after calling confirm &n;&t; */
r_if
c_cond
(paren
id|self-&gt;confirm
)paren
id|self
op_member_access_from_pointer
id|confirm
c_func
(paren
id|IAS_SUCCESS
comma
id|obj_id
comma
id|value
comma
id|self-&gt;priv
)paren
suffix:semicolon
r_else
(brace
id|IRDA_DEBUG
c_func
(paren
l_int|0
comma
id|__FUNCTION__
l_string|&quot;(), missing handler!&bslash;n&quot;
)paren
suffix:semicolon
id|irias_delete_value
c_func
(paren
id|value
)paren
suffix:semicolon
)brace
id|dev_kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Function iriap_getvaluebyclass_response ()&n; *&n; *    Send answer back to remote LM-IAS&n; * &n; */
DECL|function|iriap_getvaluebyclass_response
r_void
id|iriap_getvaluebyclass_response
c_func
(paren
r_struct
id|iriap_cb
op_star
id|self
comma
id|__u16
id|obj_id
comma
id|__u8
id|ret_code
comma
r_struct
id|ias_value
op_star
id|value
)paren
(brace
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
r_int
id|n
suffix:semicolon
id|__u32
id|tmp_be32
comma
id|tmp_be16
suffix:semicolon
id|__u8
op_star
id|fp
suffix:semicolon
id|IRDA_DEBUG
c_func
(paren
l_int|4
comma
id|__FUNCTION__
l_string|&quot;()&bslash;n&quot;
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|self
op_ne
l_int|NULL
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|self-&gt;magic
op_eq
id|IAS_MAGIC
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|value
op_ne
l_int|NULL
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|value-&gt;len
op_le
l_int|1024
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
multiline_comment|/* Initialize variables */
id|n
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* &n;&t; *  We must adjust the size of the response after the length of the &n;&t; *  value. We add 32 bytes because of the 6 bytes for the frame and&n;&t; *  max 5 bytes for the value coding.&n;&t; */
id|skb
op_assign
id|dev_alloc_skb
c_func
(paren
id|value-&gt;len
op_plus
id|self-&gt;max_header_size
op_plus
l_int|32
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|skb
)paren
r_return
suffix:semicolon
multiline_comment|/* Reserve space for MUX and LAP header */
id|skb_reserve
c_func
(paren
id|skb
comma
id|self-&gt;max_header_size
)paren
suffix:semicolon
id|skb_put
c_func
(paren
id|skb
comma
l_int|6
)paren
suffix:semicolon
id|fp
op_assign
id|skb-&gt;data
suffix:semicolon
multiline_comment|/* Build frame */
id|fp
(braket
id|n
op_increment
)braket
op_assign
id|GET_VALUE_BY_CLASS
op_or
id|IAP_LST
suffix:semicolon
id|fp
(braket
id|n
op_increment
)braket
op_assign
id|ret_code
suffix:semicolon
multiline_comment|/* Insert list length (MSB first) */
id|tmp_be16
op_assign
id|__constant_htons
c_func
(paren
l_int|0x0001
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|fp
op_plus
id|n
comma
op_amp
id|tmp_be16
comma
l_int|2
)paren
suffix:semicolon
id|n
op_add_assign
l_int|2
suffix:semicolon
multiline_comment|/* Insert object identifier ( MSB first) */
id|tmp_be16
op_assign
id|cpu_to_be16
c_func
(paren
id|obj_id
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|fp
op_plus
id|n
comma
op_amp
id|tmp_be16
comma
l_int|2
)paren
suffix:semicolon
id|n
op_add_assign
l_int|2
suffix:semicolon
r_switch
c_cond
(paren
id|value-&gt;type
)paren
(brace
r_case
id|IAS_STRING
suffix:colon
id|skb_put
c_func
(paren
id|skb
comma
l_int|3
op_plus
id|value-&gt;len
)paren
suffix:semicolon
id|fp
(braket
id|n
op_increment
)braket
op_assign
id|value-&gt;type
suffix:semicolon
id|fp
(braket
id|n
op_increment
)braket
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* ASCII */
id|fp
(braket
id|n
op_increment
)braket
op_assign
(paren
id|__u8
)paren
id|value-&gt;len
suffix:semicolon
id|memcpy
c_func
(paren
id|fp
op_plus
id|n
comma
id|value-&gt;t.string
comma
id|value-&gt;len
)paren
suffix:semicolon
id|n
op_add_assign
id|value-&gt;len
suffix:semicolon
r_break
suffix:semicolon
r_case
id|IAS_INTEGER
suffix:colon
id|skb_put
c_func
(paren
id|skb
comma
l_int|5
)paren
suffix:semicolon
id|fp
(braket
id|n
op_increment
)braket
op_assign
id|value-&gt;type
suffix:semicolon
id|tmp_be32
op_assign
id|cpu_to_be32
c_func
(paren
id|value-&gt;t.integer
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|fp
op_plus
id|n
comma
op_amp
id|tmp_be32
comma
l_int|4
)paren
suffix:semicolon
id|n
op_add_assign
l_int|4
suffix:semicolon
r_break
suffix:semicolon
r_case
id|IAS_OCT_SEQ
suffix:colon
id|skb_put
c_func
(paren
id|skb
comma
l_int|3
op_plus
id|value-&gt;len
)paren
suffix:semicolon
id|fp
(braket
id|n
op_increment
)braket
op_assign
id|value-&gt;type
suffix:semicolon
id|tmp_be16
op_assign
id|cpu_to_be16
c_func
(paren
id|value-&gt;len
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|fp
op_plus
id|n
comma
op_amp
id|tmp_be16
comma
l_int|2
)paren
suffix:semicolon
id|n
op_add_assign
l_int|2
suffix:semicolon
id|memcpy
c_func
(paren
id|fp
op_plus
id|n
comma
id|value-&gt;t.oct_seq
comma
id|value-&gt;len
)paren
suffix:semicolon
id|n
op_add_assign
id|value-&gt;len
suffix:semicolon
r_break
suffix:semicolon
r_case
id|IAS_MISSING
suffix:colon
id|IRDA_DEBUG
c_func
(paren
l_int|3
comma
id|__FUNCTION__
l_string|&quot;: sending IAS_MISSING&bslash;n&quot;
)paren
suffix:semicolon
id|skb_put
c_func
(paren
id|skb
comma
l_int|1
)paren
suffix:semicolon
id|fp
(braket
id|n
op_increment
)braket
op_assign
id|value-&gt;type
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|IRDA_DEBUG
c_func
(paren
l_int|0
comma
id|__FUNCTION__
l_string|&quot;(), type not implemented!&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|iriap_do_r_connect_event
c_func
(paren
id|self
comma
id|IAP_CALL_RESPONSE
comma
id|skb
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Function iriap_getvaluebyclass_indication (self, skb)&n; *&n; *    getvaluebyclass is requested from peer LM-IAS&n; *&n; */
DECL|function|iriap_getvaluebyclass_indication
r_void
id|iriap_getvaluebyclass_indication
c_func
(paren
r_struct
id|iriap_cb
op_star
id|self
comma
r_struct
id|sk_buff
op_star
id|skb
)paren
(brace
r_struct
id|ias_object
op_star
id|obj
suffix:semicolon
r_struct
id|ias_attrib
op_star
id|attrib
suffix:semicolon
r_int
id|name_len
suffix:semicolon
r_int
id|attr_len
suffix:semicolon
r_char
id|name
(braket
l_int|64
)braket
suffix:semicolon
r_char
id|attr
(braket
l_int|64
)braket
suffix:semicolon
id|__u8
op_star
id|fp
suffix:semicolon
r_int
id|n
suffix:semicolon
id|IRDA_DEBUG
c_func
(paren
l_int|4
comma
id|__FUNCTION__
l_string|&quot;()&bslash;n&quot;
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|self
op_ne
l_int|NULL
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|self-&gt;magic
op_eq
id|IAS_MAGIC
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|skb
op_ne
l_int|NULL
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
id|fp
op_assign
id|skb-&gt;data
suffix:semicolon
id|n
op_assign
l_int|1
suffix:semicolon
id|name_len
op_assign
id|fp
(braket
id|n
op_increment
)braket
suffix:semicolon
id|memcpy
c_func
(paren
id|name
comma
id|fp
op_plus
id|n
comma
id|name_len
)paren
suffix:semicolon
id|n
op_add_assign
id|name_len
suffix:semicolon
id|name
(braket
id|name_len
)braket
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
id|attr_len
op_assign
id|fp
(braket
id|n
op_increment
)braket
suffix:semicolon
id|memcpy
c_func
(paren
id|attr
comma
id|fp
op_plus
id|n
comma
id|attr_len
)paren
suffix:semicolon
id|n
op_add_assign
id|attr_len
suffix:semicolon
id|attr
(braket
id|attr_len
)braket
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
multiline_comment|/* We do not need the buffer anymore */
id|dev_kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
id|IRDA_DEBUG
c_func
(paren
l_int|4
comma
l_string|&quot;LM-IAS: Looking up %s: %s&bslash;n&quot;
comma
id|name
comma
id|attr
)paren
suffix:semicolon
id|obj
op_assign
id|irias_find_object
c_func
(paren
id|name
)paren
suffix:semicolon
r_if
c_cond
(paren
id|obj
op_eq
l_int|NULL
)paren
(brace
id|IRDA_DEBUG
c_func
(paren
l_int|2
comma
l_string|&quot;LM-IAS: Object %s not found&bslash;n&quot;
comma
id|name
)paren
suffix:semicolon
id|iriap_getvaluebyclass_response
c_func
(paren
id|self
comma
l_int|0x1235
comma
id|IAS_CLASS_UNKNOWN
comma
op_amp
id|missing
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|IRDA_DEBUG
c_func
(paren
l_int|4
comma
l_string|&quot;LM-IAS: found %s, id=%d&bslash;n&quot;
comma
id|obj-&gt;name
comma
id|obj-&gt;id
)paren
suffix:semicolon
id|attrib
op_assign
id|irias_find_attrib
c_func
(paren
id|obj
comma
id|attr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|attrib
op_eq
l_int|NULL
)paren
(brace
id|IRDA_DEBUG
c_func
(paren
l_int|2
comma
l_string|&quot;LM-IAS: Attribute %s not found&bslash;n&quot;
comma
id|attr
)paren
suffix:semicolon
id|iriap_getvaluebyclass_response
c_func
(paren
id|self
comma
id|obj-&gt;id
comma
id|IAS_ATTRIB_UNKNOWN
comma
op_amp
id|missing
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/* We have a match; send the value.  */
id|iriap_getvaluebyclass_response
c_func
(paren
id|self
comma
id|obj-&gt;id
comma
id|IAS_SUCCESS
comma
id|attrib-&gt;value
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/*&n; * Function iriap_send_ack (void)&n; *&n; *    Currently not used&n; *&n; */
DECL|function|iriap_send_ack
r_void
id|iriap_send_ack
c_func
(paren
r_struct
id|iriap_cb
op_star
id|self
)paren
(brace
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
id|__u8
op_star
id|frame
suffix:semicolon
id|IRDA_DEBUG
c_func
(paren
l_int|2
comma
id|__FUNCTION__
l_string|&quot;()&bslash;n&quot;
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|self
op_ne
l_int|NULL
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|self-&gt;magic
op_eq
id|IAS_MAGIC
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
id|skb
op_assign
id|dev_alloc_skb
c_func
(paren
l_int|64
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|skb
)paren
r_return
suffix:semicolon
multiline_comment|/* Reserve space for MUX and LAP header */
id|skb_reserve
c_func
(paren
id|skb
comma
id|self-&gt;max_header_size
)paren
suffix:semicolon
id|skb_put
c_func
(paren
id|skb
comma
l_int|1
)paren
suffix:semicolon
id|frame
op_assign
id|skb-&gt;data
suffix:semicolon
multiline_comment|/* Build frame */
id|frame
(braket
l_int|0
)braket
op_assign
id|IAP_LST
op_or
id|IAP_ACK
op_or
id|self-&gt;operation
suffix:semicolon
id|irlmp_data_request
c_func
(paren
id|self-&gt;lsap
comma
id|skb
)paren
suffix:semicolon
)brace
DECL|function|iriap_connect_request
r_void
id|iriap_connect_request
c_func
(paren
r_struct
id|iriap_cb
op_star
id|self
)paren
(brace
r_int
id|ret
suffix:semicolon
id|ASSERT
c_func
(paren
id|self
op_ne
l_int|NULL
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|self-&gt;magic
op_eq
id|IAS_MAGIC
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
id|ret
op_assign
id|irlmp_connect_request
c_func
(paren
id|self-&gt;lsap
comma
id|LSAP_IAS
comma
id|self-&gt;saddr
comma
id|self-&gt;daddr
comma
l_int|NULL
comma
l_int|NULL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
OL
l_int|0
)paren
(brace
id|IRDA_DEBUG
c_func
(paren
l_int|0
comma
id|__FUNCTION__
l_string|&quot;(), connect failed!&bslash;n&quot;
)paren
suffix:semicolon
id|self
op_member_access_from_pointer
id|confirm
c_func
(paren
id|IAS_DISCONNECT
comma
l_int|0
comma
l_int|NULL
comma
id|self-&gt;priv
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/*&n; * Function iriap_connect_confirm (handle, skb)&n; *&n; *    LSAP connection confirmed!&n; *&n; */
DECL|function|iriap_connect_confirm
r_static
r_void
id|iriap_connect_confirm
c_func
(paren
r_void
op_star
id|instance
comma
r_void
op_star
id|sap
comma
r_struct
id|qos_info
op_star
id|qos
comma
id|__u32
id|max_seg_size
comma
id|__u8
id|max_header_size
comma
r_struct
id|sk_buff
op_star
id|userdata
)paren
(brace
r_struct
id|iriap_cb
op_star
id|self
suffix:semicolon
id|self
op_assign
(paren
r_struct
id|iriap_cb
op_star
)paren
id|instance
suffix:semicolon
id|ASSERT
c_func
(paren
id|self
op_ne
l_int|NULL
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|self-&gt;magic
op_eq
id|IAS_MAGIC
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|userdata
op_ne
l_int|NULL
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
id|self-&gt;max_data_size
op_assign
id|max_seg_size
suffix:semicolon
id|self-&gt;max_header_size
op_assign
id|max_header_size
suffix:semicolon
id|del_timer
c_func
(paren
op_amp
id|self-&gt;watchdog_timer
)paren
suffix:semicolon
id|iriap_do_client_event
c_func
(paren
id|self
comma
id|IAP_LM_CONNECT_CONFIRM
comma
id|userdata
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Function iriap_connect_indication ( handle, skb)&n; *&n; *    Remote LM-IAS is requesting connection&n; *&n; */
DECL|function|iriap_connect_indication
r_static
r_void
id|iriap_connect_indication
c_func
(paren
r_void
op_star
id|instance
comma
r_void
op_star
id|sap
comma
r_struct
id|qos_info
op_star
id|qos
comma
id|__u32
id|max_seg_size
comma
id|__u8
id|max_header_size
comma
r_struct
id|sk_buff
op_star
id|userdata
)paren
(brace
r_struct
id|iriap_cb
op_star
id|self
comma
op_star
r_new
suffix:semicolon
id|IRDA_DEBUG
c_func
(paren
l_int|0
comma
id|__FUNCTION__
l_string|&quot;()&bslash;n&quot;
)paren
suffix:semicolon
id|self
op_assign
(paren
r_struct
id|iriap_cb
op_star
)paren
id|instance
suffix:semicolon
id|ASSERT
c_func
(paren
id|self
op_ne
l_int|NULL
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|self-&gt;magic
op_eq
id|IAS_MAGIC
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
multiline_comment|/* Start new server */
r_new
op_assign
id|iriap_open
c_func
(paren
id|LSAP_IAS
comma
id|IAS_SERVER
comma
l_int|NULL
comma
l_int|NULL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
r_new
)paren
(brace
id|IRDA_DEBUG
c_func
(paren
l_int|0
comma
id|__FUNCTION__
l_string|&quot;(), open failed&bslash;n&quot;
)paren
suffix:semicolon
id|dev_kfree_skb
c_func
(paren
id|userdata
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/* Now attach up the new &quot;socket&quot; */
r_new
op_member_access_from_pointer
id|lsap
op_assign
id|irlmp_dup
c_func
(paren
id|self-&gt;lsap
comma
r_new
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
r_new
op_member_access_from_pointer
id|lsap
)paren
(brace
id|IRDA_DEBUG
c_func
(paren
l_int|0
comma
id|__FUNCTION__
l_string|&quot;(), dup failed!&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_new
op_member_access_from_pointer
id|max_data_size
op_assign
id|max_seg_size
suffix:semicolon
r_new
op_member_access_from_pointer
id|max_header_size
op_assign
id|max_header_size
suffix:semicolon
multiline_comment|/* Clean up the original one to keep it in listen state */
id|self-&gt;lsap-&gt;dlsap_sel
op_assign
id|LSAP_ANY
suffix:semicolon
id|self-&gt;lsap-&gt;lsap_state
op_assign
id|LSAP_DISCONNECTED
suffix:semicolon
multiline_comment|/* FIXME: refcount in irlmp might get wrong */
id|iriap_do_server_event
c_func
(paren
r_new
comma
id|IAP_LM_CONNECT_INDICATION
comma
id|userdata
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Function iriap_data_indication (handle, skb)&n; *&n; *    Receives data from connection identified by handle from IrLMP&n; *&n; */
DECL|function|iriap_data_indication
r_static
r_int
id|iriap_data_indication
c_func
(paren
r_void
op_star
id|instance
comma
r_void
op_star
id|sap
comma
r_struct
id|sk_buff
op_star
id|skb
)paren
(brace
r_struct
id|iriap_cb
op_star
id|self
suffix:semicolon
id|__u8
op_star
id|frame
suffix:semicolon
id|__u8
id|opcode
suffix:semicolon
id|IRDA_DEBUG
c_func
(paren
l_int|3
comma
id|__FUNCTION__
l_string|&quot;()&bslash;n&quot;
)paren
suffix:semicolon
id|self
op_assign
(paren
r_struct
id|iriap_cb
op_star
)paren
id|instance
suffix:semicolon
id|ASSERT
c_func
(paren
id|self
op_ne
l_int|NULL
comma
r_return
l_int|0
suffix:semicolon
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|self-&gt;magic
op_eq
id|IAS_MAGIC
comma
r_return
l_int|0
suffix:semicolon
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|skb
op_ne
l_int|NULL
comma
r_return
l_int|0
suffix:semicolon
)paren
suffix:semicolon
id|frame
op_assign
id|skb-&gt;data
suffix:semicolon
r_if
c_cond
(paren
id|self-&gt;mode
op_eq
id|IAS_SERVER
)paren
(brace
multiline_comment|/* Call server */
id|IRDA_DEBUG
c_func
(paren
l_int|4
comma
id|__FUNCTION__
l_string|&quot;(), Calling server!&bslash;n&quot;
)paren
suffix:semicolon
id|iriap_do_r_connect_event
c_func
(paren
id|self
comma
id|IAP_RECV_F_LST
comma
id|skb
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|opcode
op_assign
id|frame
(braket
l_int|0
)braket
suffix:semicolon
r_if
c_cond
(paren
op_complement
id|opcode
op_amp
id|IAP_LST
)paren
(brace
id|WARNING
c_func
(paren
id|__FUNCTION__
l_string|&quot;(), IrIAS multiframe commands or &quot;
l_string|&quot;results is not implemented yet!&bslash;n&quot;
)paren
suffix:semicolon
id|dev_kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Check for ack frames since they don&squot;t contain any data */
r_if
c_cond
(paren
id|opcode
op_amp
id|IAP_ACK
)paren
(brace
id|IRDA_DEBUG
c_func
(paren
l_int|0
comma
id|__FUNCTION__
l_string|&quot;() Got ack frame!&bslash;n&quot;
)paren
suffix:semicolon
id|dev_kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|opcode
op_and_assign
op_complement
id|IAP_LST
suffix:semicolon
multiline_comment|/* Mask away LST bit */
r_switch
c_cond
(paren
id|opcode
)paren
(brace
r_case
id|GET_INFO_BASE
suffix:colon
id|IRDA_DEBUG
c_func
(paren
l_int|0
comma
l_string|&quot;IrLMP GetInfoBaseDetails not implemented!&bslash;n&quot;
)paren
suffix:semicolon
id|dev_kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|GET_VALUE_BY_CLASS
suffix:colon
id|iriap_do_call_event
c_func
(paren
id|self
comma
id|IAP_RECV_F_LST
comma
l_int|NULL
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|frame
(braket
l_int|1
)braket
)paren
(brace
r_case
id|IAS_SUCCESS
suffix:colon
id|iriap_getvaluebyclass_confirm
c_func
(paren
id|self
comma
id|skb
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|IAS_CLASS_UNKNOWN
suffix:colon
id|IRDA_DEBUG
c_func
(paren
l_int|1
comma
id|__FUNCTION__
l_string|&quot;(), No such class!&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* Finished, close connection! */
id|iriap_disconnect_request
c_func
(paren
id|self
)paren
suffix:semicolon
multiline_comment|/* &n;&t;&t;&t; * Warning, the client might close us, so remember&n;&t;&t;&t; * no to use self anymore after calling confirm &n;&t;&t;&t; */
r_if
c_cond
(paren
id|self-&gt;confirm
)paren
id|self
op_member_access_from_pointer
id|confirm
c_func
(paren
id|IAS_CLASS_UNKNOWN
comma
l_int|0
comma
l_int|NULL
comma
id|self-&gt;priv
)paren
suffix:semicolon
id|dev_kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|IAS_ATTRIB_UNKNOWN
suffix:colon
id|IRDA_DEBUG
c_func
(paren
l_int|1
comma
id|__FUNCTION__
l_string|&quot;(), No such attribute!&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* Finished, close connection! */
id|iriap_disconnect_request
c_func
(paren
id|self
)paren
suffix:semicolon
multiline_comment|/* &n;&t;&t;&t; * Warning, the client might close us, so remember&n;&t;&t;&t; * no to use self anymore after calling confirm &n;&t;&t;&t; */
r_if
c_cond
(paren
id|self-&gt;confirm
)paren
id|self
op_member_access_from_pointer
id|confirm
c_func
(paren
id|IAS_ATTRIB_UNKNOWN
comma
l_int|0
comma
l_int|NULL
comma
id|self-&gt;priv
)paren
suffix:semicolon
id|dev_kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_break
suffix:semicolon
r_default
suffix:colon
id|IRDA_DEBUG
c_func
(paren
l_int|0
comma
id|__FUNCTION__
l_string|&quot;(), Unknown op-code: %02x&bslash;n&quot;
comma
id|opcode
)paren
suffix:semicolon
id|dev_kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * Function iriap_call_indication (self, skb)&n; *&n; *    Received call to server from peer LM-IAS&n; *&n; */
DECL|function|iriap_call_indication
r_void
id|iriap_call_indication
c_func
(paren
r_struct
id|iriap_cb
op_star
id|self
comma
r_struct
id|sk_buff
op_star
id|skb
)paren
(brace
id|__u8
op_star
id|fp
suffix:semicolon
id|__u8
id|opcode
suffix:semicolon
id|IRDA_DEBUG
c_func
(paren
l_int|4
comma
id|__FUNCTION__
l_string|&quot;()&bslash;n&quot;
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|self
op_ne
l_int|NULL
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|self-&gt;magic
op_eq
id|IAS_MAGIC
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|skb
op_ne
l_int|NULL
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
id|fp
op_assign
id|skb-&gt;data
suffix:semicolon
id|opcode
op_assign
id|fp
(braket
l_int|0
)braket
suffix:semicolon
r_if
c_cond
(paren
op_complement
id|opcode
op_amp
l_int|0x80
)paren
(brace
id|WARNING
c_func
(paren
id|__FUNCTION__
l_string|&quot;(), IrIAS multiframe commands or results&quot;
l_string|&quot;is not implemented yet!&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|opcode
op_and_assign
l_int|0x7f
suffix:semicolon
multiline_comment|/* Mask away LST bit */
r_switch
c_cond
(paren
id|opcode
)paren
(brace
r_case
id|GET_INFO_BASE
suffix:colon
id|WARNING
c_func
(paren
id|__FUNCTION__
l_string|&quot;(), GetInfoBaseDetails not implemented yet!&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|GET_VALUE_BY_CLASS
suffix:colon
id|iriap_getvaluebyclass_indication
c_func
(paren
id|self
comma
id|skb
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
multiline_comment|/*&n; * Function iriap_watchdog_timer_expired (data)&n; *&n; *    Query has taken to long time, so abort&n; *&n; */
DECL|function|iriap_watchdog_timer_expired
r_void
id|iriap_watchdog_timer_expired
c_func
(paren
r_void
op_star
id|data
)paren
(brace
r_struct
id|iriap_cb
op_star
id|self
op_assign
(paren
r_struct
id|iriap_cb
op_star
)paren
id|data
suffix:semicolon
id|ASSERT
c_func
(paren
id|self
op_ne
l_int|NULL
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|self-&gt;magic
op_eq
id|IAS_MAGIC
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
multiline_comment|/* iriap_close(self); */
)brace
macro_line|#ifdef CONFIG_PROC_FS
DECL|variable|ias_value_types
r_static
r_char
op_star
id|ias_value_types
(braket
)braket
op_assign
(brace
l_string|&quot;IAS_MISSING&quot;
comma
l_string|&quot;IAS_INTEGER&quot;
comma
l_string|&quot;IAS_OCT_SEQ&quot;
comma
l_string|&quot;IAS_STRING&quot;
)brace
suffix:semicolon
DECL|function|irias_proc_read
r_int
id|irias_proc_read
c_func
(paren
r_char
op_star
id|buf
comma
r_char
op_star
op_star
id|start
comma
id|off_t
id|offset
comma
r_int
id|len
)paren
(brace
r_struct
id|ias_object
op_star
id|obj
suffix:semicolon
r_struct
id|ias_attrib
op_star
id|attrib
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|ASSERT
c_func
(paren
id|objects
op_ne
l_int|NULL
comma
r_return
l_int|0
suffix:semicolon
)paren
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|len
op_assign
l_int|0
suffix:semicolon
id|len
op_add_assign
id|sprintf
c_func
(paren
id|buf
op_plus
id|len
comma
l_string|&quot;LM-IAS Objects:&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* List all objects */
id|obj
op_assign
(paren
r_struct
id|ias_object
op_star
)paren
id|hashbin_get_first
c_func
(paren
id|objects
)paren
suffix:semicolon
r_while
c_loop
(paren
id|obj
op_ne
l_int|NULL
)paren
(brace
id|ASSERT
c_func
(paren
id|obj-&gt;magic
op_eq
id|IAS_OBJECT_MAGIC
comma
r_return
l_int|0
suffix:semicolon
)paren
suffix:semicolon
id|len
op_add_assign
id|sprintf
c_func
(paren
id|buf
op_plus
id|len
comma
l_string|&quot;name: %s, &quot;
comma
id|obj-&gt;name
)paren
suffix:semicolon
id|len
op_add_assign
id|sprintf
c_func
(paren
id|buf
op_plus
id|len
comma
l_string|&quot;id=%d&quot;
comma
id|obj-&gt;id
)paren
suffix:semicolon
id|len
op_add_assign
id|sprintf
c_func
(paren
id|buf
op_plus
id|len
comma
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* List all attributes for this object */
id|attrib
op_assign
(paren
r_struct
id|ias_attrib
op_star
)paren
id|hashbin_get_first
c_func
(paren
id|obj-&gt;attribs
)paren
suffix:semicolon
r_while
c_loop
(paren
id|attrib
op_ne
l_int|NULL
)paren
(brace
id|ASSERT
c_func
(paren
id|attrib-&gt;magic
op_eq
id|IAS_ATTRIB_MAGIC
comma
r_return
l_int|0
suffix:semicolon
)paren
suffix:semicolon
id|len
op_add_assign
id|sprintf
c_func
(paren
id|buf
op_plus
id|len
comma
l_string|&quot; - Attribute name: &bslash;&quot;%s&bslash;&quot;, &quot;
comma
id|attrib-&gt;name
)paren
suffix:semicolon
id|len
op_add_assign
id|sprintf
c_func
(paren
id|buf
op_plus
id|len
comma
l_string|&quot;value[%s]: &quot;
comma
id|ias_value_types
(braket
id|attrib-&gt;value-&gt;type
)braket
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|attrib-&gt;value-&gt;type
)paren
(brace
r_case
id|IAS_INTEGER
suffix:colon
id|len
op_add_assign
id|sprintf
c_func
(paren
id|buf
op_plus
id|len
comma
l_string|&quot;%d&bslash;n&quot;
comma
id|attrib-&gt;value-&gt;t.integer
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|IAS_STRING
suffix:colon
id|len
op_add_assign
id|sprintf
c_func
(paren
id|buf
op_plus
id|len
comma
l_string|&quot;&bslash;&quot;%s&bslash;&quot;&bslash;n&quot;
comma
id|attrib-&gt;value-&gt;t.string
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|IAS_OCT_SEQ
suffix:colon
id|len
op_add_assign
id|sprintf
c_func
(paren
id|buf
op_plus
id|len
comma
l_string|&quot;octet sequence&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|IAS_MISSING
suffix:colon
id|len
op_add_assign
id|sprintf
c_func
(paren
id|buf
op_plus
id|len
comma
l_string|&quot;missing&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|IRDA_DEBUG
c_func
(paren
l_int|0
comma
id|__FUNCTION__
l_string|&quot;(), Unknown value type!&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|len
op_add_assign
id|sprintf
c_func
(paren
id|buf
op_plus
id|len
comma
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
id|attrib
op_assign
(paren
r_struct
id|ias_attrib
op_star
)paren
id|hashbin_get_next
c_func
(paren
id|obj-&gt;attribs
)paren
suffix:semicolon
)brace
id|obj
op_assign
(paren
r_struct
id|ias_object
op_star
)paren
id|hashbin_get_next
c_func
(paren
id|objects
)paren
suffix:semicolon
)brace
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
id|len
suffix:semicolon
)brace
macro_line|#endif /* PROC_FS */
eof
