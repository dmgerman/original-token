multiline_comment|/*********************************************************************&n; *                &n; * Filename:      irlan_provider.c&n; * Version:       0.9&n; * Description:   IrDA LAN Access Protocol Implementation&n; * Status:        Experimental.&n; * Author:        Dag Brattli &lt;dagb@cs.uit.no&gt;&n; * Created at:    Sun Aug 31 20:14:37 1997&n; * Modified at:   Sat Oct 30 12:52:10 1999&n; * Modified by:   Dag Brattli &lt;dagb@cs.uit.no&gt;&n; * Sources:       skeleton.c by Donald Becker &lt;becker@CESDIS.gsfc.nasa.gov&gt;&n; *                slip.c by Laurence Culhane,   &lt;loz@holmes.demon.co.uk&gt;&n; *                          Fred N. van Kempen, &lt;waltje@uwalt.nl.mugnet.org&gt;&n; * &n; *     Copyright (c) 1998-1999 Dag Brattli &lt;dagb@cs.uit.no&gt;, &n; *     All Rights Reserved.&n; *     &n; *     This program is free software; you can redistribute it and/or &n; *     modify it under the terms of the GNU General Public License as &n; *     published by the Free Software Foundation; either version 2 of &n; *     the License, or (at your option) any later version.&n; *&n; *     Neither Dag Brattli nor University of Troms&#xfffd; admit liability nor&n; *     provide warranty for any of this software. This material is &n; *     provided &quot;AS-IS&quot; and at no charge.&n; *&n; ********************************************************************/
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/netdevice.h&gt;
macro_line|#include &lt;linux/etherdevice.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/random.h&gt;
macro_line|#include &lt;asm/system.h&gt;
macro_line|#include &lt;asm/bitops.h&gt;
macro_line|#include &lt;asm/byteorder.h&gt;
macro_line|#include &lt;net/irda/irda.h&gt;
macro_line|#include &lt;net/irda/irttp.h&gt;
macro_line|#include &lt;net/irda/irlmp.h&gt;
macro_line|#include &lt;net/irda/irias_object.h&gt;
macro_line|#include &lt;net/irda/iriap.h&gt;
macro_line|#include &lt;net/irda/timer.h&gt;
macro_line|#include &lt;net/irda/irlan_common.h&gt;
macro_line|#include &lt;net/irda/irlan_eth.h&gt;
macro_line|#include &lt;net/irda/irlan_event.h&gt;
macro_line|#include &lt;net/irda/irlan_provider.h&gt;
macro_line|#include &lt;net/irda/irlan_filter.h&gt;
macro_line|#include &lt;net/irda/irlan_client.h&gt;
r_static
r_void
id|irlan_provider_connect_indication
c_func
(paren
r_void
op_star
id|instance
comma
r_void
op_star
id|sap
comma
r_struct
id|qos_info
op_star
id|qos
comma
id|__u32
id|max_sdu_size
comma
id|__u8
id|max_header_size
comma
r_struct
id|sk_buff
op_star
id|skb
)paren
suffix:semicolon
multiline_comment|/*&n; * Function irlan_provider_control_data_indication (handle, skb)&n; *&n; *    This function gets the data that is received on the control channel&n; *&n; */
DECL|function|irlan_provider_data_indication
r_static
r_int
id|irlan_provider_data_indication
c_func
(paren
r_void
op_star
id|instance
comma
r_void
op_star
id|sap
comma
r_struct
id|sk_buff
op_star
id|skb
)paren
(brace
r_struct
id|irlan_cb
op_star
id|self
suffix:semicolon
id|__u8
id|code
suffix:semicolon
id|IRDA_DEBUG
c_func
(paren
l_int|4
comma
id|__FUNCTION__
l_string|&quot;()&bslash;n&quot;
)paren
suffix:semicolon
id|self
op_assign
(paren
r_struct
id|irlan_cb
op_star
)paren
id|instance
suffix:semicolon
id|ASSERT
c_func
(paren
id|self
op_ne
l_int|NULL
comma
r_return
op_minus
l_int|1
suffix:semicolon
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|self-&gt;magic
op_eq
id|IRLAN_MAGIC
comma
r_return
op_minus
l_int|1
suffix:semicolon
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|skb
op_ne
l_int|NULL
comma
r_return
op_minus
l_int|1
suffix:semicolon
)paren
suffix:semicolon
id|code
op_assign
id|skb-&gt;data
(braket
l_int|0
)braket
suffix:semicolon
r_switch
c_cond
(paren
id|code
)paren
(brace
r_case
id|CMD_GET_PROVIDER_INFO
suffix:colon
id|IRDA_DEBUG
c_func
(paren
l_int|4
comma
l_string|&quot;Got GET_PROVIDER_INFO command!&bslash;n&quot;
)paren
suffix:semicolon
id|irlan_do_provider_event
c_func
(paren
id|self
comma
id|IRLAN_GET_INFO_CMD
comma
id|skb
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CMD_GET_MEDIA_CHAR
suffix:colon
id|IRDA_DEBUG
c_func
(paren
l_int|4
comma
l_string|&quot;Got GET_MEDIA_CHAR command!&bslash;n&quot;
)paren
suffix:semicolon
id|irlan_do_provider_event
c_func
(paren
id|self
comma
id|IRLAN_GET_MEDIA_CMD
comma
id|skb
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CMD_OPEN_DATA_CHANNEL
suffix:colon
id|IRDA_DEBUG
c_func
(paren
l_int|4
comma
l_string|&quot;Got OPEN_DATA_CHANNEL command!&bslash;n&quot;
)paren
suffix:semicolon
id|irlan_do_provider_event
c_func
(paren
id|self
comma
id|IRLAN_OPEN_DATA_CMD
comma
id|skb
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CMD_FILTER_OPERATION
suffix:colon
id|IRDA_DEBUG
c_func
(paren
l_int|4
comma
l_string|&quot;Got FILTER_OPERATION command!&bslash;n&quot;
)paren
suffix:semicolon
id|irlan_do_provider_event
c_func
(paren
id|self
comma
id|IRLAN_FILTER_CONFIG_CMD
comma
id|skb
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CMD_RECONNECT_DATA_CHAN
suffix:colon
id|IRDA_DEBUG
c_func
(paren
l_int|2
comma
id|__FUNCTION__
l_string|&quot;(), Got RECONNECT_DATA_CHAN command&bslash;n&quot;
)paren
suffix:semicolon
id|IRDA_DEBUG
c_func
(paren
l_int|2
comma
id|__FUNCTION__
l_string|&quot;(), NOT IMPLEMENTED&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CMD_CLOSE_DATA_CHAN
suffix:colon
id|IRDA_DEBUG
c_func
(paren
l_int|2
comma
l_string|&quot;Got CLOSE_DATA_CHAN command!&bslash;n&quot;
)paren
suffix:semicolon
id|IRDA_DEBUG
c_func
(paren
l_int|2
comma
id|__FUNCTION__
l_string|&quot;(), NOT IMPLEMENTED&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|IRDA_DEBUG
c_func
(paren
l_int|2
comma
id|__FUNCTION__
l_string|&quot;(), Unknown command!&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * Function irlan_provider_connect_indication (handle, skb, priv)&n; *&n; *    Got connection from peer IrLAN client&n; *&n; */
DECL|function|irlan_provider_connect_indication
r_static
r_void
id|irlan_provider_connect_indication
c_func
(paren
r_void
op_star
id|instance
comma
r_void
op_star
id|sap
comma
r_struct
id|qos_info
op_star
id|qos
comma
id|__u32
id|max_sdu_size
comma
id|__u8
id|max_header_size
comma
r_struct
id|sk_buff
op_star
id|skb
)paren
(brace
r_struct
id|irlan_cb
op_star
id|self
suffix:semicolon
r_struct
id|tsap_cb
op_star
id|tsap
suffix:semicolon
id|__u32
id|saddr
comma
id|daddr
suffix:semicolon
id|IRDA_DEBUG
c_func
(paren
l_int|0
comma
id|__FUNCTION__
l_string|&quot;()&bslash;n&quot;
)paren
suffix:semicolon
id|self
op_assign
(paren
r_struct
id|irlan_cb
op_star
)paren
id|instance
suffix:semicolon
id|tsap
op_assign
(paren
r_struct
id|tsap_cb
op_star
)paren
id|sap
suffix:semicolon
id|ASSERT
c_func
(paren
id|self
op_ne
l_int|NULL
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|self-&gt;magic
op_eq
id|IRLAN_MAGIC
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|tsap
op_eq
id|self-&gt;provider.tsap_ctrl
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|self-&gt;provider.state
op_eq
id|IRLAN_IDLE
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
id|daddr
op_assign
id|irttp_get_daddr
c_func
(paren
id|tsap
)paren
suffix:semicolon
id|saddr
op_assign
id|irttp_get_saddr
c_func
(paren
id|tsap
)paren
suffix:semicolon
id|self-&gt;provider.max_sdu_size
op_assign
id|max_sdu_size
suffix:semicolon
id|self-&gt;provider.max_header_size
op_assign
id|max_header_size
suffix:semicolon
id|irlan_do_provider_event
c_func
(paren
id|self
comma
id|IRLAN_CONNECT_INDICATION
comma
l_int|NULL
)paren
suffix:semicolon
multiline_comment|/*  &n;&t; * If we are in peer mode, the client may not have got the discovery&n;&t; * indication it needs to make progress. If the client is still in &n;&t; * IDLE state, we must kick it. &n;&t; */
r_if
c_cond
(paren
(paren
id|self-&gt;provider.access_type
op_eq
id|ACCESS_PEER
)paren
op_logical_and
(paren
id|self-&gt;client.state
op_eq
id|IRLAN_IDLE
)paren
)paren
(brace
id|irlan_client_wakeup
c_func
(paren
id|self
comma
id|self-&gt;saddr
comma
id|self-&gt;daddr
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/*&n; * Function irlan_provider_connect_response (handle)&n; *&n; *    Accept incomming connection&n; *&n; */
DECL|function|irlan_provider_connect_response
r_void
id|irlan_provider_connect_response
c_func
(paren
r_struct
id|irlan_cb
op_star
id|self
comma
r_struct
id|tsap_cb
op_star
id|tsap
)paren
(brace
id|ASSERT
c_func
(paren
id|self
op_ne
l_int|NULL
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|self-&gt;magic
op_eq
id|IRLAN_MAGIC
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
multiline_comment|/* Just accept */
id|irttp_connect_response
c_func
(paren
id|tsap
comma
id|IRLAN_MTU
comma
l_int|NULL
)paren
suffix:semicolon
)brace
DECL|function|irlan_provider_disconnect_indication
r_void
id|irlan_provider_disconnect_indication
c_func
(paren
r_void
op_star
id|instance
comma
r_void
op_star
id|sap
comma
id|LM_REASON
id|reason
comma
r_struct
id|sk_buff
op_star
id|userdata
)paren
(brace
r_struct
id|irlan_cb
op_star
id|self
suffix:semicolon
r_struct
id|tsap_cb
op_star
id|tsap
suffix:semicolon
id|IRDA_DEBUG
c_func
(paren
l_int|4
comma
id|__FUNCTION__
l_string|&quot;(), reason=%d&bslash;n&quot;
comma
id|reason
)paren
suffix:semicolon
id|self
op_assign
(paren
r_struct
id|irlan_cb
op_star
)paren
id|instance
suffix:semicolon
id|tsap
op_assign
(paren
r_struct
id|tsap_cb
op_star
)paren
id|sap
suffix:semicolon
id|ASSERT
c_func
(paren
id|self
op_ne
l_int|NULL
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|self-&gt;magic
op_eq
id|IRLAN_MAGIC
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|tsap
op_ne
l_int|NULL
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|tsap-&gt;magic
op_eq
id|TTP_TSAP_MAGIC
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|tsap
op_eq
id|self-&gt;provider.tsap_ctrl
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
id|irlan_do_provider_event
c_func
(paren
id|self
comma
id|IRLAN_LMP_DISCONNECT
comma
l_int|NULL
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Function irlan_parse_open_data_cmd (self, skb)&n; *&n; *    &n; *&n; */
DECL|function|irlan_parse_open_data_cmd
r_int
id|irlan_parse_open_data_cmd
c_func
(paren
r_struct
id|irlan_cb
op_star
id|self
comma
r_struct
id|sk_buff
op_star
id|skb
)paren
(brace
r_int
id|ret
suffix:semicolon
id|ret
op_assign
id|irlan_provider_parse_command
c_func
(paren
id|self
comma
id|CMD_OPEN_DATA_CHANNEL
comma
id|skb
)paren
suffix:semicolon
multiline_comment|/* Open data channel */
id|irlan_open_data_tsap
c_func
(paren
id|self
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
multiline_comment|/*&n; * Function parse_command (skb)&n; *&n; *    Extract all parameters from received buffer, then feed them to &n; *    check_params for parsing&n; *&n; */
DECL|function|irlan_provider_parse_command
r_int
id|irlan_provider_parse_command
c_func
(paren
r_struct
id|irlan_cb
op_star
id|self
comma
r_int
id|cmd
comma
r_struct
id|sk_buff
op_star
id|skb
)paren
(brace
id|__u8
op_star
id|frame
suffix:semicolon
id|__u8
op_star
id|ptr
suffix:semicolon
r_int
id|count
suffix:semicolon
id|__u16
id|val_len
suffix:semicolon
r_int
id|i
suffix:semicolon
r_char
op_star
id|name
suffix:semicolon
r_char
op_star
id|value
suffix:semicolon
r_int
id|ret
op_assign
id|RSP_SUCCESS
suffix:semicolon
id|ASSERT
c_func
(paren
id|skb
op_ne
l_int|NULL
comma
r_return
op_minus
id|RSP_PROTOCOL_ERROR
suffix:semicolon
)paren
suffix:semicolon
id|IRDA_DEBUG
c_func
(paren
l_int|4
comma
id|__FUNCTION__
l_string|&quot;(), skb-&gt;len=%d&bslash;n&quot;
comma
(paren
r_int
)paren
id|skb-&gt;len
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|self
op_ne
l_int|NULL
comma
r_return
op_minus
id|RSP_PROTOCOL_ERROR
suffix:semicolon
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|self-&gt;magic
op_eq
id|IRLAN_MAGIC
comma
r_return
op_minus
id|RSP_PROTOCOL_ERROR
suffix:semicolon
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|skb
)paren
r_return
op_minus
id|RSP_PROTOCOL_ERROR
suffix:semicolon
id|frame
op_assign
id|skb-&gt;data
suffix:semicolon
id|name
op_assign
id|kmalloc
c_func
(paren
l_int|255
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|name
)paren
r_return
op_minus
id|RSP_INSUFFICIENT_RESOURCES
suffix:semicolon
id|value
op_assign
id|kmalloc
c_func
(paren
l_int|1016
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|value
)paren
(brace
id|kfree
c_func
(paren
id|name
)paren
suffix:semicolon
r_return
op_minus
id|RSP_INSUFFICIENT_RESOURCES
suffix:semicolon
)brace
multiline_comment|/* How many parameters? */
id|count
op_assign
id|frame
(braket
l_int|1
)braket
suffix:semicolon
id|IRDA_DEBUG
c_func
(paren
l_int|4
comma
l_string|&quot;Got %d parameters&bslash;n&quot;
comma
id|count
)paren
suffix:semicolon
id|ptr
op_assign
id|frame
op_plus
l_int|2
suffix:semicolon
multiline_comment|/* For all parameters */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|count
suffix:semicolon
id|i
op_increment
)paren
(brace
id|ret
op_assign
id|irlan_extract_param
c_func
(paren
id|ptr
comma
id|name
comma
id|value
comma
op_amp
id|val_len
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
OL
l_int|0
)paren
(brace
id|IRDA_DEBUG
c_func
(paren
l_int|2
comma
id|__FUNCTION__
l_string|&quot;(), IrLAN, Error!&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|ptr
op_add_assign
id|ret
suffix:semicolon
id|ret
op_assign
id|RSP_SUCCESS
suffix:semicolon
id|irlan_check_command_param
c_func
(paren
id|self
comma
id|name
comma
id|value
)paren
suffix:semicolon
)brace
multiline_comment|/* Cleanup */
id|kfree
c_func
(paren
id|name
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|value
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
multiline_comment|/*&n; * Function irlan_provider_send_reply (self, info)&n; *&n; *    Send reply to query to peer IrLAN layer&n; *&n; */
DECL|function|irlan_provider_send_reply
r_void
id|irlan_provider_send_reply
c_func
(paren
r_struct
id|irlan_cb
op_star
id|self
comma
r_int
id|command
comma
r_int
id|ret_code
)paren
(brace
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
id|IRDA_DEBUG
c_func
(paren
l_int|4
comma
id|__FUNCTION__
l_string|&quot;()&bslash;n&quot;
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|self
op_ne
l_int|NULL
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|self-&gt;magic
op_eq
id|IRLAN_MAGIC
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
id|skb
op_assign
id|dev_alloc_skb
c_func
(paren
l_int|128
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|skb
)paren
r_return
suffix:semicolon
multiline_comment|/* Reserve space for TTP, LMP, and LAP header */
id|skb_reserve
c_func
(paren
id|skb
comma
id|self-&gt;provider.max_header_size
)paren
suffix:semicolon
id|skb_put
c_func
(paren
id|skb
comma
l_int|2
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|command
)paren
(brace
r_case
id|CMD_GET_PROVIDER_INFO
suffix:colon
id|skb-&gt;data
(braket
l_int|0
)braket
op_assign
l_int|0x00
suffix:semicolon
multiline_comment|/* Success */
id|skb-&gt;data
(braket
l_int|1
)braket
op_assign
l_int|0x02
suffix:semicolon
multiline_comment|/* 2 parameters */
r_switch
c_cond
(paren
id|self-&gt;media
)paren
(brace
r_case
id|MEDIA_802_3
suffix:colon
id|irlan_insert_string_param
c_func
(paren
id|skb
comma
l_string|&quot;MEDIA&quot;
comma
l_string|&quot;802.3&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MEDIA_802_5
suffix:colon
id|irlan_insert_string_param
c_func
(paren
id|skb
comma
l_string|&quot;MEDIA&quot;
comma
l_string|&quot;802.5&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|IRDA_DEBUG
c_func
(paren
l_int|2
comma
id|__FUNCTION__
l_string|&quot;(), unknown media type!&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|irlan_insert_short_param
c_func
(paren
id|skb
comma
l_string|&quot;IRLAN_VER&quot;
comma
l_int|0x0101
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CMD_GET_MEDIA_CHAR
suffix:colon
id|skb-&gt;data
(braket
l_int|0
)braket
op_assign
l_int|0x00
suffix:semicolon
multiline_comment|/* Success */
id|skb-&gt;data
(braket
l_int|1
)braket
op_assign
l_int|0x05
suffix:semicolon
multiline_comment|/* 5 parameters */
id|irlan_insert_string_param
c_func
(paren
id|skb
comma
l_string|&quot;FILTER_TYPE&quot;
comma
l_string|&quot;DIRECTED&quot;
)paren
suffix:semicolon
id|irlan_insert_string_param
c_func
(paren
id|skb
comma
l_string|&quot;FILTER_TYPE&quot;
comma
l_string|&quot;BROADCAST&quot;
)paren
suffix:semicolon
id|irlan_insert_string_param
c_func
(paren
id|skb
comma
l_string|&quot;FILTER_TYPE&quot;
comma
l_string|&quot;MULTICAST&quot;
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|self-&gt;provider.access_type
)paren
(brace
r_case
id|ACCESS_DIRECT
suffix:colon
id|irlan_insert_string_param
c_func
(paren
id|skb
comma
l_string|&quot;ACCESS_TYPE&quot;
comma
l_string|&quot;DIRECT&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ACCESS_PEER
suffix:colon
id|irlan_insert_string_param
c_func
(paren
id|skb
comma
l_string|&quot;ACCESS_TYPE&quot;
comma
l_string|&quot;PEER&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ACCESS_HOSTED
suffix:colon
id|irlan_insert_string_param
c_func
(paren
id|skb
comma
l_string|&quot;ACCESS_TYPE&quot;
comma
l_string|&quot;HOSTED&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|IRDA_DEBUG
c_func
(paren
l_int|2
comma
id|__FUNCTION__
l_string|&quot;(), Unknown access type&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|irlan_insert_short_param
c_func
(paren
id|skb
comma
l_string|&quot;MAX_FRAME&quot;
comma
l_int|0x05ee
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CMD_OPEN_DATA_CHANNEL
suffix:colon
id|skb-&gt;data
(braket
l_int|0
)braket
op_assign
l_int|0x00
suffix:semicolon
multiline_comment|/* Success */
r_if
c_cond
(paren
id|self-&gt;provider.send_arb_val
)paren
(brace
id|skb-&gt;data
(braket
l_int|1
)braket
op_assign
l_int|0x03
suffix:semicolon
multiline_comment|/* 3 parameters */
id|irlan_insert_short_param
c_func
(paren
id|skb
comma
l_string|&quot;CON_ARB&quot;
comma
id|self-&gt;provider.send_arb_val
)paren
suffix:semicolon
)brace
r_else
id|skb-&gt;data
(braket
l_int|1
)braket
op_assign
l_int|0x02
suffix:semicolon
multiline_comment|/* 2 parameters */
id|irlan_insert_byte_param
c_func
(paren
id|skb
comma
l_string|&quot;DATA_CHAN&quot;
comma
id|self-&gt;stsap_sel_data
)paren
suffix:semicolon
id|irlan_insert_array_param
c_func
(paren
id|skb
comma
l_string|&quot;RECONNECT_KEY&quot;
comma
l_string|&quot;LINUX RULES!&quot;
comma
l_int|12
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CMD_FILTER_OPERATION
suffix:colon
id|handle_filter_request
c_func
(paren
id|self
comma
id|skb
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|IRDA_DEBUG
c_func
(paren
l_int|2
comma
id|__FUNCTION__
l_string|&quot;(), Unknown command!&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|irttp_data_request
c_func
(paren
id|self-&gt;provider.tsap_ctrl
comma
id|skb
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Function irlan_provider_register(void)&n; *&n; *    Register provider support so we can accept incomming connections.&n; * &n; */
DECL|function|irlan_provider_open_ctrl_tsap
r_int
id|irlan_provider_open_ctrl_tsap
c_func
(paren
r_struct
id|irlan_cb
op_star
id|self
)paren
(brace
r_struct
id|tsap_cb
op_star
id|tsap
suffix:semicolon
id|notify_t
id|notify
suffix:semicolon
id|IRDA_DEBUG
c_func
(paren
l_int|4
comma
id|__FUNCTION__
l_string|&quot;()&bslash;n&quot;
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|self
op_ne
l_int|NULL
comma
r_return
op_minus
l_int|1
suffix:semicolon
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|self-&gt;magic
op_eq
id|IRLAN_MAGIC
comma
r_return
op_minus
l_int|1
suffix:semicolon
)paren
suffix:semicolon
multiline_comment|/* Check if already open */
r_if
c_cond
(paren
id|self-&gt;provider.tsap_ctrl
)paren
r_return
op_minus
l_int|1
suffix:semicolon
multiline_comment|/*&n;&t; *  First register well known control TSAP&n;&t; */
id|irda_notify_init
c_func
(paren
op_amp
id|notify
)paren
suffix:semicolon
id|notify.data_indication
op_assign
id|irlan_provider_data_indication
suffix:semicolon
id|notify.connect_indication
op_assign
id|irlan_provider_connect_indication
suffix:semicolon
id|notify.disconnect_indication
op_assign
id|irlan_provider_disconnect_indication
suffix:semicolon
id|notify.instance
op_assign
id|self
suffix:semicolon
id|strncpy
c_func
(paren
id|notify.name
comma
l_string|&quot;IrLAN ctrl (p)&quot;
comma
l_int|16
)paren
suffix:semicolon
id|tsap
op_assign
id|irttp_open_tsap
c_func
(paren
id|LSAP_ANY
comma
l_int|1
comma
op_amp
id|notify
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|tsap
)paren
(brace
id|IRDA_DEBUG
c_func
(paren
l_int|2
comma
id|__FUNCTION__
l_string|&quot;(), Got no tsap!&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|self-&gt;provider.tsap_ctrl
op_assign
id|tsap
suffix:semicolon
multiline_comment|/* Register with LM-IAS */
id|irlan_ias_register
c_func
(paren
id|self
comma
id|tsap-&gt;stsap_sel
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
eof
