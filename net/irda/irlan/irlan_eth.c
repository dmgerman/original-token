multiline_comment|/*********************************************************************&n; *                &n; * Filename:      irlan_eth.c&n; * Version:       &n; * Description:   &n; * Status:        Experimental.&n; * Author:        Dag Brattli &lt;dagb@cs.uit.no&gt;&n; * Created at:    Thu Oct 15 08:37:58 1998&n; * Modified at:   Wed Feb  3 19:58:28 1999&n; * Modified by:   Dag Brattli &lt;dagb@cs.uit.no&gt;&n; * Sources:       skeleton.c by Donald Becker &lt;becker@CESDIS.gsfc.nasa.gov&gt;&n; *                slip.c by Laurence Culhane,   &lt;loz@holmes.demon.co.uk&gt;&n; *                          Fred N. van Kempen, &lt;waltje@uwalt.nl.mugnet.org&gt;&n; * &n; *     Copyright (c) 1998 Dag Brattli, All Rights Reserved.&n; *      &n; *     This program is free software; you can redistribute it and/or &n; *     modify it under the terms of the GNU General Public License as &n; *     published by the Free Software Foundation; either version 2 of &n; *     the License, or (at your option) any later version.&n; *  &n; *     Neither Dag Brattli nor University of Troms&#xfffd; admit liability nor&n; *     provide warranty for any of this software. This material is &n; *     provided &quot;AS-IS&quot; and at no charge.&n; *     &n; ********************************************************************/
macro_line|#include &lt;linux/netdevice.h&gt;
macro_line|#include &lt;linux/etherdevice.h&gt;
macro_line|#include &lt;linux/if_arp.h&gt;
macro_line|#include &lt;net/arp.h&gt;
macro_line|#include &lt;net/irda/irda.h&gt;
macro_line|#include &lt;net/irda/irlan_common.h&gt;
macro_line|#include &lt;net/irda/irlan_eth.h&gt;
multiline_comment|/*&n; * Function irlan_eth_tx (skb)&n; *&n; *    Transmits ethernet frames over IrDA link.&n; *&n; */
DECL|function|irlan_eth_xmit
r_int
id|irlan_eth_xmit
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|device
op_star
id|dev
)paren
(brace
r_struct
id|irlan_cb
op_star
id|self
suffix:semicolon
id|DEBUG
c_func
(paren
l_int|4
comma
id|__FUNCTION__
l_string|&quot;()&bslash;n&quot;
)paren
suffix:semicolon
id|self
op_assign
(paren
r_struct
id|irlan_cb
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|ASSERT
c_func
(paren
id|self
op_ne
l_int|NULL
comma
r_return
l_int|0
suffix:semicolon
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|self-&gt;magic
op_eq
id|IRLAN_MAGIC
comma
r_return
l_int|0
suffix:semicolon
)paren
suffix:semicolon
multiline_comment|/* Lock transmit buffer */
r_if
c_cond
(paren
id|irda_lock
c_func
(paren
(paren
r_void
op_star
)paren
op_amp
id|dev-&gt;tbusy
)paren
op_eq
id|FALSE
)paren
(brace
multiline_comment|/*&n;&t;&t; * If we get here, some higher level has decided we are broken.&n;&t;&t; * There should really be a &quot;kick me&quot; function call instead.&n;&t;&t; */
r_int
id|tickssofar
op_assign
id|jiffies
op_minus
id|dev-&gt;trans_start
suffix:semicolon
r_if
c_cond
(paren
id|tickssofar
OL
l_int|5
)paren
r_return
op_minus
id|EBUSY
suffix:semicolon
id|dev-&gt;tbusy
op_assign
l_int|0
suffix:semicolon
id|dev-&gt;trans_start
op_assign
id|jiffies
suffix:semicolon
)brace
id|DEBUG
c_func
(paren
l_int|4
comma
l_string|&quot;Room left at head: %d&bslash;n&quot;
comma
id|skb_headroom
c_func
(paren
id|skb
)paren
)paren
suffix:semicolon
id|DEBUG
c_func
(paren
l_int|4
comma
l_string|&quot;Room left at tail: %d&bslash;n&quot;
comma
id|skb_tailroom
c_func
(paren
id|skb
)paren
)paren
suffix:semicolon
id|DEBUG
c_func
(paren
l_int|4
comma
l_string|&quot;Required room: %d&bslash;n&quot;
comma
id|IRLAN_MAX_HEADER
)paren
suffix:semicolon
multiline_comment|/* skb headroom large enough to contain IR-headers? */
r_if
c_cond
(paren
(paren
id|skb_headroom
c_func
(paren
id|skb
)paren
OL
id|IRLAN_MAX_HEADER
)paren
op_logical_or
(paren
id|skb_shared
c_func
(paren
id|skb
)paren
)paren
)paren
(brace
r_struct
id|sk_buff
op_star
id|new_skb
op_assign
id|skb_realloc_headroom
c_func
(paren
id|skb
comma
id|IRLAN_MAX_HEADER
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|new_skb
op_ne
l_int|NULL
comma
r_return
l_int|0
suffix:semicolon
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|skb_headroom
c_func
(paren
id|new_skb
)paren
op_ge
id|IRLAN_MAX_HEADER
comma
r_return
l_int|0
suffix:semicolon
)paren
suffix:semicolon
multiline_comment|/*  Free original skb, and use the new one */
id|dev_kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
id|skb
op_assign
id|new_skb
suffix:semicolon
)brace
id|dev-&gt;trans_start
op_assign
id|jiffies
suffix:semicolon
id|self-&gt;stats.tx_packets
op_increment
suffix:semicolon
id|self-&gt;stats.tx_bytes
op_add_assign
id|skb-&gt;len
suffix:semicolon
multiline_comment|/*&n;&t; *  Now queue the packet in the transport layer&n;&t; *  FIXME: clean up the code below! DB&n;&t; */
r_if
c_cond
(paren
id|self-&gt;use_udata
)paren
(brace
id|irttp_udata_request
c_func
(paren
id|self-&gt;tsap_data
comma
id|skb
)paren
suffix:semicolon
id|dev-&gt;tbusy
op_assign
l_int|0
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|irttp_data_request
c_func
(paren
id|self-&gt;tsap_data
comma
id|skb
)paren
op_eq
op_minus
l_int|1
)paren
(brace
multiline_comment|/*  &n;&t;&t; *  IrTTPs tx queue is full, so we just have to drop the&n;&t;&t; *  frame! You might think that we should just return -1&n;&t;&t; *  and don&squot;t deallocate the frame, but that is dangerous&n;&t;&t; *  since it&squot;s possible that we have replaced the original&n;&t;&t; *  skb with a new one with larger headroom, and that would&n;&t;&t; *  really confuse do_dev_queue_xmit() in dev.c! I have&n;&t;&t; *  tried :-) DB&n;&t;&t; */
id|dev_kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
op_increment
id|self-&gt;stats.tx_dropped
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|dev-&gt;tbusy
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Finished! */
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * Function irlan_eth_receive (handle, skb)&n; *&n; *    This function gets the data that is received on the data channel&n; *&n; */
DECL|function|irlan_eth_receive
r_void
id|irlan_eth_receive
c_func
(paren
r_void
op_star
id|instance
comma
r_void
op_star
id|sap
comma
r_struct
id|sk_buff
op_star
id|skb
)paren
(brace
r_struct
id|irlan_cb
op_star
id|self
suffix:semicolon
id|self
op_assign
(paren
r_struct
id|irlan_cb
op_star
)paren
id|instance
suffix:semicolon
id|ASSERT
c_func
(paren
id|self
op_ne
l_int|NULL
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|self-&gt;magic
op_eq
id|IRLAN_MAGIC
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
r_if
c_cond
(paren
id|skb
op_eq
l_int|NULL
)paren
(brace
op_increment
id|self-&gt;stats.rx_dropped
suffix:semicolon
r_return
suffix:semicolon
)brace
id|ASSERT
c_func
(paren
id|skb-&gt;len
OG
l_int|1
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
multiline_comment|/* &n;&t; * Adopt this frame! Important to set all these fields since they &n;&t; * might have been previously set by the low level IrDA network&n;&t; * device driver &n;&t; */
id|skb-&gt;dev
op_assign
op_amp
id|self-&gt;dev
suffix:semicolon
id|skb-&gt;protocol
op_assign
id|eth_type_trans
c_func
(paren
id|skb
comma
id|skb-&gt;dev
)paren
suffix:semicolon
multiline_comment|/* Remove eth header */
id|netif_rx
c_func
(paren
id|skb
)paren
suffix:semicolon
multiline_comment|/* Eat it! */
id|self-&gt;stats.rx_packets
op_increment
suffix:semicolon
id|self-&gt;stats.rx_bytes
op_add_assign
id|skb-&gt;len
suffix:semicolon
multiline_comment|/* &t;net_bh(); */
)brace
multiline_comment|/*&n; * Function irlan_eth_flow (status)&n; *&n; *    Do flow control between IP/Ethernet and IrLAN/IrTTP. This is done by &n; *    controlling the dev-&gt;tbusy variable.&n; */
DECL|function|irlan_eth_flow_indication
r_void
id|irlan_eth_flow_indication
c_func
(paren
r_void
op_star
id|instance
comma
r_void
op_star
id|sap
comma
id|LOCAL_FLOW
id|flow
)paren
(brace
r_struct
id|irlan_cb
op_star
id|self
suffix:semicolon
r_struct
id|device
op_star
id|dev
suffix:semicolon
id|DEBUG
c_func
(paren
l_int|4
comma
id|__FUNCTION__
l_string|&quot;()&bslash;n&quot;
)paren
suffix:semicolon
id|self
op_assign
(paren
r_struct
id|irlan_cb
op_star
)paren
id|instance
suffix:semicolon
id|ASSERT
c_func
(paren
id|self
op_ne
l_int|NULL
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|self-&gt;magic
op_eq
id|IRLAN_MAGIC
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
id|dev
op_assign
op_amp
id|self-&gt;dev
suffix:semicolon
id|ASSERT
c_func
(paren
id|dev
op_ne
l_int|NULL
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|flow
)paren
(brace
r_case
id|FLOW_STOP
suffix:colon
id|DEBUG
c_func
(paren
l_int|4
comma
l_string|&quot;IrLAN, stopping Ethernet layer&bslash;n&quot;
)paren
suffix:semicolon
id|dev-&gt;tbusy
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
r_case
id|FLOW_START
suffix:colon
multiline_comment|/* &n;&t;&t; *  Tell upper layers that its time to transmit frames again&n;&t;&t; */
id|DEBUG
c_func
(paren
l_int|4
comma
l_string|&quot;IrLAN, starting Ethernet layer&bslash;n&quot;
)paren
suffix:semicolon
id|dev-&gt;tbusy
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* &n;&t;&t; *  Ready to receive more frames, so schedule the network&n;&t;&t; *  layer&n;&t;&t; */
id|mark_bh
c_func
(paren
id|NET_BH
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|DEBUG
c_func
(paren
l_int|0
comma
id|__FUNCTION__
l_string|&quot;(), Unknown flow command!&bslash;n&quot;
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/*&n; * Function irlan_eth_rebuild_header (buff, dev, dest, skb)&n; *&n; *    If we don&squot;t want to use ARP. Currently not used!!&n; *&n; */
DECL|function|irlan_eth_rebuild_header
r_void
id|irlan_eth_rebuild_header
c_func
(paren
r_void
op_star
id|buff
comma
r_struct
id|device
op_star
id|dev
comma
r_int
r_int
id|dest
comma
r_struct
id|sk_buff
op_star
id|skb
)paren
(brace
r_struct
id|ethhdr
op_star
id|eth
op_assign
(paren
r_struct
id|ethhdr
op_star
)paren
id|buff
suffix:semicolon
id|memcpy
c_func
(paren
id|eth-&gt;h_source
comma
id|dev-&gt;dev_addr
comma
id|dev-&gt;addr_len
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|eth-&gt;h_dest
comma
id|dev-&gt;dev_addr
comma
id|dev-&gt;addr_len
)paren
suffix:semicolon
multiline_comment|/* return 0; */
)brace
multiline_comment|/*&n; * Function set_multicast_list (dev)&n; *&n; *    Configure the filtering of the device&n; *&n; */
DECL|macro|HW_MAX_ADDRS
mdefine_line|#define HW_MAX_ADDRS 4 /* Must query to get it! */
DECL|function|irlan_eth_set_multicast_list
r_void
id|irlan_eth_set_multicast_list
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
r_struct
id|irlan_cb
op_star
id|self
suffix:semicolon
id|self
op_assign
id|dev-&gt;priv
suffix:semicolon
id|DEBUG
c_func
(paren
l_int|0
comma
id|__FUNCTION__
l_string|&quot;()&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
id|ASSERT
c_func
(paren
id|self
op_ne
l_int|NULL
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|self-&gt;magic
op_eq
id|IRLAN_MAGIC
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;flags
op_amp
id|IFF_PROMISC
)paren
(brace
multiline_comment|/* Enable promiscuous mode */
id|DEBUG
c_func
(paren
l_int|0
comma
l_string|&quot;Promiscous mode not implemented&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* outw(MULTICAST|PROMISC, ioaddr); */
)brace
r_else
r_if
c_cond
(paren
(paren
id|dev-&gt;flags
op_amp
id|IFF_ALLMULTI
)paren
op_logical_or
id|dev-&gt;mc_count
OG
id|HW_MAX_ADDRS
)paren
(brace
multiline_comment|/* Disable promiscuous mode, use normal mode. */
id|DEBUG
c_func
(paren
l_int|4
comma
id|__FUNCTION__
l_string|&quot;(), Setting multicast filter&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* hardware_set_filter(NULL); */
id|irlan_set_multicast_filter
c_func
(paren
id|self
comma
id|TRUE
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|dev-&gt;mc_count
)paren
(brace
id|DEBUG
c_func
(paren
l_int|4
comma
id|__FUNCTION__
l_string|&quot;(), Setting multicast filter&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* Walk the address list, and load the filter */
multiline_comment|/* hardware_set_filter(dev-&gt;mc_list); */
id|irlan_set_multicast_filter
c_func
(paren
id|self
comma
id|TRUE
)paren
suffix:semicolon
)brace
r_else
(brace
id|DEBUG
c_func
(paren
l_int|4
comma
id|__FUNCTION__
l_string|&quot;(), Clearing multicast filter&bslash;n&quot;
)paren
suffix:semicolon
id|irlan_set_multicast_filter
c_func
(paren
id|self
comma
id|FALSE
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|dev-&gt;flags
op_amp
id|IFF_BROADCAST
)paren
(brace
id|DEBUG
c_func
(paren
l_int|4
comma
id|__FUNCTION__
l_string|&quot;(), Setting broadcast filter&bslash;n&quot;
)paren
suffix:semicolon
id|irlan_set_broadcast_filter
c_func
(paren
id|self
comma
id|TRUE
)paren
suffix:semicolon
)brace
r_else
(brace
id|DEBUG
c_func
(paren
l_int|4
comma
id|__FUNCTION__
l_string|&quot;(), Clearing broadcast filter&bslash;n&quot;
)paren
suffix:semicolon
id|irlan_set_broadcast_filter
c_func
(paren
id|self
comma
id|FALSE
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/*&n; * Function irlan_get_stats (dev)&n; *&n; *    Get the current statistics for this device&n; *&n; */
DECL|function|irlan_eth_get_stats
r_struct
id|enet_statistics
op_star
id|irlan_eth_get_stats
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
r_struct
id|irlan_cb
op_star
id|self
op_assign
(paren
r_struct
id|irlan_cb
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|ASSERT
c_func
(paren
id|self
op_ne
l_int|NULL
comma
r_return
l_int|NULL
suffix:semicolon
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|self-&gt;magic
op_eq
id|IRLAN_MAGIC
comma
r_return
l_int|NULL
suffix:semicolon
)paren
suffix:semicolon
r_return
op_amp
id|self-&gt;stats
suffix:semicolon
)brace
eof
