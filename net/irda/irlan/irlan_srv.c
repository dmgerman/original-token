multiline_comment|/*********************************************************************&n; *                &n; * Filename:      irlan_srv.c&n; * Version:       0.1&n; * Description:   IrDA LAN Access Protocol Implementation&n; * Status:        Experimental.&n; * Author:        Dag Brattli &lt;dagb@cs.uit.no&gt;&n; * Created at:    Sun Aug 31 20:14:37 1997&n; * Modified at:   Mon Dec 14 19:10:49 1998&n; * Modified by:   Dag Brattli &lt;dagb@cs.uit.no&gt;&n; * Sources:       skeleton.c by Donald Becker &lt;becker@CESDIS.gsfc.nasa.gov&gt;&n; *                slip.c by Laurence Culhane,   &lt;loz@holmes.demon.co.uk&gt;&n; *                          Fred N. van Kempen, &lt;waltje@uwalt.nl.mugnet.org&gt;&n; * &n; *     Copyright (c) 1998 Dag Brattli &lt;dagb@cs.uit.no&gt;, All Rights Reserved.&n; *     &n; *     This program is free software; you can redistribute it and/or &n; *     modify it under the terms of the GNU General Public License as &n; *     published by the Free Software Foundation; either version 2 of &n; *     the License, or (at your option) any later version.&n; *&n; *     Neither Dag Brattli nor University of Troms&#xfffd; admit liability nor&n; *     provide warranty for any of this software. This material is &n; *     provided &quot;AS-IS&quot; and at no charge.&n; *&n; ********************************************************************/
macro_line|#include &lt;linux/module.h&gt; 
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/netdevice.h&gt;
macro_line|#include &lt;linux/etherdevice.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;asm/system.h&gt;
macro_line|#include &lt;asm/bitops.h&gt;
macro_line|#include &lt;asm/byteorder.h&gt;
macro_line|#include &lt;net/irda/irda.h&gt;
macro_line|#include &lt;net/irda/irttp.h&gt;
macro_line|#include &lt;net/irda/irlmp.h&gt;
macro_line|#include &lt;net/irda/irias_object.h&gt;
macro_line|#include &lt;net/irda/iriap.h&gt;
macro_line|#include &lt;net/irda/timer.h&gt;
macro_line|#include &lt;net/irda/irlan_common.h&gt;
macro_line|#include &lt;net/irda/irlan_eth.h&gt;
macro_line|#include &lt;net/irda/irlan_event.h&gt;
macro_line|#include &lt;net/irda/irlan_srv.h&gt;
multiline_comment|/*&n; *  Private functions&n; */
r_static
r_void
id|__irlan_server_close
c_func
(paren
r_struct
id|irlan_cb
op_star
id|self
)paren
suffix:semicolon
r_static
r_int
id|irlan_server_dev_init
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_int
id|irlan_server_dev_open
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_int
id|irlan_server_dev_close
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_void
id|irlan_check_param
c_func
(paren
r_struct
id|irlan_cb
op_star
id|self
comma
r_char
op_star
id|param
comma
r_char
op_star
id|value
)paren
suffix:semicolon
multiline_comment|/*&n; * Function irlan_server_init (dev)&n; *&n; *   Allocates the master array. Called by modprobe().&n; */
DECL|function|__initfunc
id|__initfunc
c_func
(paren
r_int
id|irlan_server_init
c_func
(paren
r_void
)paren
)paren
(brace
id|DEBUG
c_func
(paren
l_int|4
comma
l_string|&quot;--&gt; irlan_server_init&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* Register with IrLMP as a service */
id|irlmp_register_layer
c_func
(paren
id|S_LAN
comma
id|SERVER
comma
id|FALSE
comma
l_int|NULL
)paren
suffix:semicolon
id|irlan_server_register
c_func
(paren
)paren
suffix:semicolon
id|DEBUG
c_func
(paren
l_int|4
comma
l_string|&quot;irlan_server_init --&gt;&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * Function irlan_server_cleanup (void)&n; *&n; *    Removes all instances of the IrLAN network device driver, and the&n; *    master array. Called by rmmod().&n; */
DECL|function|irlan_server_cleanup
r_void
id|irlan_server_cleanup
c_func
(paren
r_void
)paren
(brace
id|DEBUG
c_func
(paren
l_int|4
comma
l_string|&quot;--&gt; irlan_server_cleanup&bslash;n&quot;
)paren
suffix:semicolon
id|irlmp_unregister_layer
c_func
(paren
id|S_LAN
comma
id|SERVER
)paren
suffix:semicolon
multiline_comment|/*&n;&t; *  Delete hashbin and close all irlan client instances in it&n;&t; */
multiline_comment|/* hashbin_delete( irlan, (FREE_FUNC) __irlan_server_close); */
id|DEBUG
c_func
(paren
l_int|4
comma
l_string|&quot;irlan_server_cleanup --&gt;&bslash;n&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Function irlan_server_open (void)&n; *&n; *    This function allocates and opens a new instance of the IrLAN network&n; *    device driver.&n; */
DECL|function|irlan_server_open
r_struct
id|irlan_cb
op_star
id|irlan_server_open
c_func
(paren
r_void
)paren
(brace
r_struct
id|irlan_cb
op_star
id|self
suffix:semicolon
r_int
id|result
suffix:semicolon
id|DEBUG
c_func
(paren
l_int|4
comma
id|__FUNCTION__
l_string|&quot;()&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* &n;&t; *  Initialize the irlan_server structure. &n;&t; */
id|self
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|irlan_cb
)paren
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
id|self
op_eq
l_int|NULL
)paren
(brace
id|DEBUG
c_func
(paren
l_int|0
comma
id|__FUNCTION__
l_string|&quot;(), Unable to kmalloc!&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
id|memset
c_func
(paren
id|self
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|irlan_cb
)paren
)paren
suffix:semicolon
multiline_comment|/*&n;&t; *  Initialize local device structure&n;&t; */
id|self-&gt;magic
op_assign
id|IRLAN_MAGIC
suffix:semicolon
id|self-&gt;dev.name
op_assign
id|self-&gt;ifname
suffix:semicolon
id|self-&gt;dev.init
op_assign
id|irlan_server_dev_init
suffix:semicolon
id|self-&gt;dev.priv
op_assign
(paren
r_void
op_star
)paren
id|self
suffix:semicolon
id|self-&gt;dev.next
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
(paren
id|result
op_assign
id|register_netdev
c_func
(paren
op_amp
id|self-&gt;dev
)paren
)paren
op_ne
l_int|0
)paren
(brace
id|DEBUG
c_func
(paren
l_int|0
comma
id|__FUNCTION__
l_string|&quot;(), register_netdev() failed!&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
id|irlan_next_state
c_func
(paren
id|self
comma
id|IRLAN_IDLE
)paren
suffix:semicolon
id|hashbin_insert
c_func
(paren
id|irlan
comma
(paren
id|QUEUE
op_star
)paren
id|self
comma
(paren
r_int
)paren
id|self
comma
l_int|NULL
)paren
suffix:semicolon
r_return
id|self
suffix:semicolon
)brace
multiline_comment|/*&n; * Function irlan_server_dev_init (dev)&n; *&n; *    The network device initialization function. Called only once.&n; *&n; */
DECL|function|irlan_server_dev_init
r_static
r_int
id|irlan_server_dev_init
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
id|DEBUG
c_func
(paren
l_int|4
comma
id|__FUNCTION__
l_string|&quot;()&bslash;n&quot;
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|dev
op_ne
l_int|NULL
comma
r_return
op_minus
l_int|1
suffix:semicolon
)paren
suffix:semicolon
id|irlan_eth_init
c_func
(paren
id|dev
)paren
suffix:semicolon
multiline_comment|/* Overrride some functions */
id|dev-&gt;open
op_assign
id|irlan_server_dev_open
suffix:semicolon
id|dev-&gt;stop
op_assign
id|irlan_server_dev_close
suffix:semicolon
multiline_comment|/*  &n;&t; *  OK, since we are emulating an IrLAN sever we will have to give&n;&t; *  ourself an ethernet address!&n;&t; *  FIXME: this must be more dynamically&n;&t; */
id|dev-&gt;dev_addr
(braket
l_int|0
)braket
op_assign
l_int|0x40
suffix:semicolon
id|dev-&gt;dev_addr
(braket
l_int|1
)braket
op_assign
l_int|0x00
suffix:semicolon
id|dev-&gt;dev_addr
(braket
l_int|2
)braket
op_assign
l_int|0x00
suffix:semicolon
id|dev-&gt;dev_addr
(braket
l_int|3
)braket
op_assign
l_int|0x00
suffix:semicolon
id|dev-&gt;dev_addr
(braket
l_int|4
)braket
op_assign
l_int|0x23
suffix:semicolon
id|dev-&gt;dev_addr
(braket
l_int|5
)braket
op_assign
l_int|0x45
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * Function irlan_server_dev_open (dev)&n; *&n; *    Start the Servers ether network device, this function will be called by&n; *    &quot;ifconfig server0 up&quot;.  &n; */
DECL|function|irlan_server_dev_open
r_static
r_int
id|irlan_server_dev_open
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
multiline_comment|/* struct irlan_cb *self = (struct irlan_cb *) dev-&gt;priv; */
id|DEBUG
c_func
(paren
l_int|4
comma
l_string|&quot;irlan_server_dev_open()&bslash;n&quot;
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|dev
op_ne
l_int|NULL
comma
r_return
op_minus
l_int|1
suffix:semicolon
)paren
suffix:semicolon
id|dev-&gt;tbusy
op_assign
l_int|0
suffix:semicolon
id|dev-&gt;interrupt
op_assign
l_int|0
suffix:semicolon
id|dev-&gt;start
op_assign
l_int|1
suffix:semicolon
id|MOD_INC_USE_COUNT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|__irlan_server_close
r_static
r_void
id|__irlan_server_close
c_func
(paren
r_struct
id|irlan_cb
op_star
id|self
)paren
(brace
id|DEBUG
c_func
(paren
l_int|4
comma
l_string|&quot;--&gt; irlan_server_close()&bslash;n&quot;
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|self
op_ne
l_int|NULL
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|self-&gt;magic
op_eq
id|IRLAN_MAGIC
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
multiline_comment|/* &n;&t; *  Disconnect open TSAP connections&n;&t; */
r_if
c_cond
(paren
id|self-&gt;tsap_data
)paren
(brace
id|irttp_disconnect_request
c_func
(paren
id|self-&gt;tsap_data
comma
l_int|NULL
comma
id|P_HIGH
)paren
suffix:semicolon
multiline_comment|/* FIXME: this will close the tsap before the disconenct&n;&t;&t; * frame has been sent &n;&t;&t; */
multiline_comment|/* irttp_close_tsap( self-&gt;tsap_data); */
)brace
r_if
c_cond
(paren
id|self-&gt;tsap_ctrl
)paren
(brace
id|irttp_disconnect_request
c_func
(paren
id|self-&gt;tsap_ctrl
comma
l_int|NULL
comma
id|P_HIGH
)paren
suffix:semicolon
multiline_comment|/* irttp_close_tsap( self-&gt;tsap_control); */
)brace
id|unregister_netdev
c_func
(paren
op_amp
id|self-&gt;dev
)paren
suffix:semicolon
id|self-&gt;magic
op_assign
op_complement
id|IRLAN_MAGIC
suffix:semicolon
id|kfree
c_func
(paren
id|self
)paren
suffix:semicolon
id|DEBUG
c_func
(paren
l_int|4
comma
l_string|&quot;irlan_server_close() --&gt;&bslash;n&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Function irlan_server_close (self)&n; *&n; *    This function closes and marks the IrLAN instance as not in use. &n; */
DECL|function|irlan_server_close
r_void
id|irlan_server_close
c_func
(paren
r_struct
id|irlan_cb
op_star
id|self
)paren
(brace
r_struct
id|irlan_cb
op_star
id|entry
suffix:semicolon
id|DEBUG
c_func
(paren
l_int|4
comma
l_string|&quot;--&gt; irlan_server_close()&bslash;n&quot;
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|self
op_ne
l_int|NULL
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|self-&gt;magic
op_eq
id|IRLAN_MAGIC
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
id|entry
op_assign
id|hashbin_remove
c_func
(paren
id|irlan
comma
(paren
r_int
)paren
id|self
comma
l_int|NULL
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|entry
op_eq
id|self
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
id|__irlan_server_close
c_func
(paren
id|self
)paren
suffix:semicolon
id|DEBUG
c_func
(paren
l_int|4
comma
l_string|&quot;irlan_server_close() --&gt;&bslash;n&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Function irlan_server_dev_close (dev)&n; *&n; *    Stop the IrLAN ether network device, his function will be called by&n; *    ifconfig down.&n; */
DECL|function|irlan_server_dev_close
r_static
r_int
id|irlan_server_dev_close
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
id|DEBUG
c_func
(paren
l_int|4
comma
id|__FUNCTION__
l_string|&quot;()&bslash;n&quot;
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|dev
op_ne
l_int|NULL
comma
r_return
op_minus
l_int|1
suffix:semicolon
)paren
suffix:semicolon
id|dev-&gt;tbusy
op_assign
l_int|1
suffix:semicolon
id|dev-&gt;start
op_assign
l_int|0
suffix:semicolon
id|MOD_DEC_USE_COUNT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * Function irlan_server_disconnect_indication (handle, reason, priv)&n; *&n; *    Callback function for the IrTTP layer. Indicates a disconnection of&n; *    the specified connection (handle)&n; *&n; */
DECL|function|irlan_server_disconnect_indication
r_void
id|irlan_server_disconnect_indication
c_func
(paren
r_void
op_star
id|instance
comma
r_void
op_star
id|sap
comma
id|LM_REASON
id|reason
comma
r_struct
id|sk_buff
op_star
id|skb
)paren
(brace
r_struct
id|irlan_info
id|info
suffix:semicolon
r_struct
id|irlan_cb
op_star
id|self
suffix:semicolon
r_struct
id|tsap_cb
op_star
id|tsap
suffix:semicolon
id|DEBUG
c_func
(paren
l_int|4
comma
id|__FUNCTION__
l_string|&quot;(), Reason=%d&bslash;n&quot;
comma
id|reason
)paren
suffix:semicolon
id|self
op_assign
(paren
r_struct
id|irlan_cb
op_star
)paren
id|instance
suffix:semicolon
id|tsap
op_assign
(paren
r_struct
id|tsap_cb
op_star
)paren
id|sap
suffix:semicolon
id|ASSERT
c_func
(paren
id|self
op_ne
l_int|NULL
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|self-&gt;magic
op_eq
id|IRLAN_MAGIC
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
id|info.daddr
op_assign
id|self-&gt;daddr
suffix:semicolon
r_if
c_cond
(paren
id|tsap
op_eq
id|self-&gt;tsap_data
)paren
(brace
id|DEBUG
c_func
(paren
l_int|0
comma
l_string|&quot;IrLAN, data channel disconnected by peer!&bslash;n&quot;
)paren
suffix:semicolon
id|self-&gt;connected
op_assign
id|FALSE
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|tsap
op_eq
id|self-&gt;tsap_ctrl
)paren
(brace
id|DEBUG
c_func
(paren
l_int|0
comma
l_string|&quot;IrLAN, control channel disconnected by peer!&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_else
(brace
id|DEBUG
c_func
(paren
l_int|0
comma
l_string|&quot;Error, disconnect on unknown handle!&bslash;n&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/* Stop IP from transmitting more packets */
multiline_comment|/* irlan_flow_indication( handle, FLOW_STOP, priv); */
id|irlan_do_server_event
c_func
(paren
id|self
comma
id|IRLAN_LMP_DISCONNECT
comma
l_int|NULL
comma
l_int|NULL
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Function irlan_server_control_data_indication (handle, skb)&n; *&n; *    This function gets the data that is received on the control channel&n; *&n; */
DECL|function|irlan_server_control_data_indication
r_void
id|irlan_server_control_data_indication
c_func
(paren
r_void
op_star
id|instance
comma
r_void
op_star
id|sap
comma
r_struct
id|sk_buff
op_star
id|skb
)paren
(brace
r_struct
id|irlan_cb
op_star
id|self
suffix:semicolon
id|__u8
id|code
suffix:semicolon
id|DEBUG
c_func
(paren
l_int|4
comma
id|__FUNCTION__
l_string|&quot;()&bslash;n&quot;
)paren
suffix:semicolon
id|self
op_assign
(paren
r_struct
id|irlan_cb
op_star
)paren
id|instance
suffix:semicolon
id|ASSERT
c_func
(paren
id|self
op_ne
l_int|NULL
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|self-&gt;magic
op_eq
id|IRLAN_MAGIC
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|skb
op_ne
l_int|NULL
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
id|code
op_assign
id|skb-&gt;data
(braket
l_int|0
)braket
suffix:semicolon
r_switch
c_cond
(paren
id|code
)paren
(brace
r_case
id|CMD_GET_PROVIDER_INFO
suffix:colon
id|DEBUG
c_func
(paren
l_int|4
comma
l_string|&quot;Got GET_PROVIDER_INFO command!&bslash;n&quot;
)paren
suffix:semicolon
id|irlan_do_server_event
c_func
(paren
id|self
comma
id|IRLAN_GET_INFO_CMD
comma
id|skb
comma
l_int|NULL
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CMD_GET_MEDIA_CHAR
suffix:colon
id|DEBUG
c_func
(paren
l_int|4
comma
l_string|&quot;Got GET_MEDIA_CHAR command!&bslash;n&quot;
)paren
suffix:semicolon
id|irlan_do_server_event
c_func
(paren
id|self
comma
id|IRLAN_GET_MEDIA_CMD
comma
id|skb
comma
l_int|NULL
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CMD_OPEN_DATA_CHANNEL
suffix:colon
id|DEBUG
c_func
(paren
l_int|4
comma
l_string|&quot;Got OPEN_DATA_CHANNEL command!&bslash;n&quot;
)paren
suffix:semicolon
id|irlan_do_server_event
c_func
(paren
id|self
comma
id|IRLAN_OPEN_DATA_CMD
comma
id|skb
comma
l_int|NULL
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CMD_FILTER_OPERATION
suffix:colon
id|DEBUG
c_func
(paren
l_int|4
comma
l_string|&quot;Got FILTER_OPERATION command!&bslash;n&quot;
)paren
suffix:semicolon
id|irlan_do_server_event
c_func
(paren
id|self
comma
id|IRLAN_FILTER_CONFIG_CMD
comma
id|skb
comma
l_int|NULL
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CMD_RECONNECT_DATA_CHAN
suffix:colon
id|DEBUG
c_func
(paren
l_int|0
comma
id|__FUNCTION__
l_string|&quot;(), Got RECONNECT_DATA_CHAN command&bslash;n&quot;
)paren
suffix:semicolon
id|DEBUG
c_func
(paren
l_int|0
comma
id|__FUNCTION__
l_string|&quot;(), NOT IMPLEMENTED&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CMD_CLOSE_DATA_CHAN
suffix:colon
id|DEBUG
c_func
(paren
l_int|0
comma
l_string|&quot;Got CLOSE_DATA_CHAN command!&bslash;n&quot;
)paren
suffix:semicolon
id|DEBUG
c_func
(paren
l_int|0
comma
id|__FUNCTION__
l_string|&quot;(), NOT IMPLEMENTED&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|DEBUG
c_func
(paren
l_int|0
comma
id|__FUNCTION__
l_string|&quot;(), Unknown command!&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
multiline_comment|/*&n; * Function irlan_server_connect_indication (handle, skb, priv)&n; *&n; *    Got connection from peer IrLAN layer&n; *&n; */
DECL|function|irlan_server_connect_indication
r_void
id|irlan_server_connect_indication
c_func
(paren
r_void
op_star
id|instance
comma
r_void
op_star
id|sap
comma
r_struct
id|qos_info
op_star
id|qos
comma
r_int
id|max_sdu_size
comma
r_struct
id|sk_buff
op_star
id|skb
)paren
(brace
r_struct
id|irlan_cb
op_star
id|self
suffix:semicolon
r_struct
id|irlan_info
id|info
suffix:semicolon
r_struct
id|tsap_cb
op_star
id|tsap
suffix:semicolon
id|DEBUG
c_func
(paren
l_int|4
comma
id|__FUNCTION__
l_string|&quot;()&bslash;n&quot;
)paren
suffix:semicolon
id|self
op_assign
(paren
r_struct
id|irlan_cb
op_star
)paren
id|instance
suffix:semicolon
id|tsap
op_assign
(paren
r_struct
id|tsap_cb
op_star
)paren
id|sap
suffix:semicolon
id|ASSERT
c_func
(paren
id|self
op_ne
l_int|NULL
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|self-&gt;magic
op_eq
id|IRLAN_MAGIC
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
id|info.tsap
op_assign
id|tsap
suffix:semicolon
r_if
c_cond
(paren
id|tsap
op_eq
id|self-&gt;tsap_data
)paren
id|irlan_do_server_event
c_func
(paren
id|self
comma
id|IRLAN_DATA_CONNECT_INDICATION
comma
l_int|NULL
comma
op_amp
id|info
)paren
suffix:semicolon
r_else
id|irlan_do_server_event
c_func
(paren
id|self
comma
id|IRLAN_CONNECT_INDICATION
comma
l_int|NULL
comma
op_amp
id|info
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Function irlan_server_connect_response (handle)&n; *&n; *    Accept incomming connection&n; *&n; */
DECL|function|irlan_server_connect_response
r_void
id|irlan_server_connect_response
c_func
(paren
r_struct
id|irlan_cb
op_star
id|self
comma
r_struct
id|tsap_cb
op_star
id|tsap
)paren
(brace
id|ASSERT
c_func
(paren
id|self
op_ne
l_int|NULL
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|self-&gt;magic
op_eq
id|IRLAN_MAGIC
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
multiline_comment|/* FIXME: define this value */
id|irttp_connect_response
c_func
(paren
id|tsap
comma
l_int|1518
comma
l_int|NULL
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Function irlan_server_get_provider_info (self)&n; *&n; *    Send Get Provider Information command to peer IrLAN layer&n; *&n; */
DECL|function|irlan_server_get_provider_info
r_void
id|irlan_server_get_provider_info
c_func
(paren
r_struct
id|irlan_cb
op_star
id|self
)paren
(brace
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
id|__u8
op_star
id|frame
suffix:semicolon
id|DEBUG
c_func
(paren
l_int|4
comma
id|__FUNCTION__
l_string|&quot;()&bslash;n&quot;
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|self
op_ne
l_int|NULL
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|self-&gt;magic
op_eq
id|IRLAN_MAGIC
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
id|skb
op_assign
id|dev_alloc_skb
c_func
(paren
l_int|64
)paren
suffix:semicolon
r_if
c_cond
(paren
id|skb
op_eq
l_int|NULL
)paren
(brace
id|DEBUG
c_func
(paren
l_int|0
comma
l_string|&quot;irlan_server_get_provider_info: &quot;
l_string|&quot;Could not allocate an sk_buff of length %d&bslash;n&quot;
comma
l_int|64
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/* Reserve space for TTP, LMP, and LAP header */
id|skb_reserve
c_func
(paren
id|skb
comma
id|TTP_HEADER
op_plus
id|LMP_HEADER
op_plus
id|LAP_HEADER
)paren
suffix:semicolon
id|skb_put
c_func
(paren
id|skb
comma
l_int|2
)paren
suffix:semicolon
id|frame
op_assign
id|skb-&gt;data
suffix:semicolon
id|frame
(braket
l_int|0
)braket
op_assign
id|CMD_GET_PROVIDER_INFO
suffix:semicolon
id|frame
(braket
l_int|1
)braket
op_assign
l_int|0x00
suffix:semicolon
multiline_comment|/* Zero parameters */
id|irttp_data_request
c_func
(paren
id|self-&gt;tsap_ctrl
comma
id|skb
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Function irlan_parse_open_data_cmd (self, skb)&n; *&n; *    &n; *&n; */
DECL|function|irlan_parse_open_data_cmd
r_int
id|irlan_parse_open_data_cmd
c_func
(paren
r_struct
id|irlan_cb
op_star
id|self
comma
r_struct
id|sk_buff
op_star
id|skb
)paren
(brace
r_int
id|ret
op_assign
id|RSP_SUCCESS
suffix:semicolon
id|irlan_server_extract_params
c_func
(paren
id|self
comma
id|CMD_OPEN_DATA_CHANNEL
comma
id|skb
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
multiline_comment|/*&n; * Function extract_params (skb)&n; *&n; *    Extract all parameters from received buffer, then feed them to &n; *    check_params for parsing&n; *&n; */
DECL|function|irlan_server_extract_params
r_int
id|irlan_server_extract_params
c_func
(paren
r_struct
id|irlan_cb
op_star
id|self
comma
r_int
id|cmd
comma
r_struct
id|sk_buff
op_star
id|skb
)paren
(brace
id|__u8
op_star
id|frame
suffix:semicolon
id|__u8
op_star
id|ptr
suffix:semicolon
r_int
id|count
suffix:semicolon
id|__u8
id|name_len
suffix:semicolon
id|__u16
id|val_len
suffix:semicolon
r_int
id|i
suffix:semicolon
id|ASSERT
c_func
(paren
id|skb
op_ne
l_int|NULL
comma
r_return
op_minus
id|RSP_PROTOCOL_ERROR
suffix:semicolon
)paren
suffix:semicolon
id|DEBUG
c_func
(paren
l_int|4
comma
id|__FUNCTION__
l_string|&quot;(), skb-&gt;len=%d&bslash;n&quot;
comma
(paren
r_int
)paren
id|skb-&gt;len
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|self
op_ne
l_int|NULL
comma
r_return
op_minus
id|RSP_PROTOCOL_ERROR
suffix:semicolon
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|self-&gt;magic
op_eq
id|IRLAN_MAGIC
comma
r_return
op_minus
id|RSP_PROTOCOL_ERROR
suffix:semicolon
)paren
suffix:semicolon
r_if
c_cond
(paren
id|skb
op_eq
l_int|NULL
)paren
(brace
id|DEBUG
c_func
(paren
l_int|0
comma
l_string|&quot;extract_params: Got NULL skb!&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|RSP_PROTOCOL_ERROR
suffix:semicolon
)brace
id|frame
op_assign
id|skb-&gt;data
suffix:semicolon
multiline_comment|/* How many parameters? */
id|count
op_assign
id|frame
(braket
l_int|1
)braket
suffix:semicolon
id|DEBUG
c_func
(paren
l_int|4
comma
l_string|&quot;Got %d parameters&bslash;n&quot;
comma
id|count
)paren
suffix:semicolon
id|ptr
op_assign
id|frame
op_plus
l_int|2
suffix:semicolon
multiline_comment|/* For all parameters */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|count
suffix:semicolon
id|i
op_increment
)paren
(brace
multiline_comment|/* get length of parameter name ( 1 byte) */
id|name_len
op_assign
op_star
id|ptr
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|name_len
OG
l_int|255
)paren
(brace
id|DEBUG
c_func
(paren
l_int|0
comma
l_string|&quot;extract_params, name_len &gt; 255&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|RSP_PROTOCOL_ERROR
suffix:semicolon
)brace
multiline_comment|/* get parameter name */
id|memcpy
c_func
(paren
id|self-&gt;name
comma
id|ptr
comma
id|name_len
)paren
suffix:semicolon
id|self-&gt;name
(braket
id|name_len
)braket
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
id|ptr
op_add_assign
id|name_len
suffix:semicolon
multiline_comment|/*  &n;&t;&t; *  Get length of parameter value ( 2 bytes in little endian &n;&t;&t; *  format) &n;&t;&t; */
id|val_len
op_assign
op_star
id|ptr
op_increment
op_amp
l_int|0xff
suffix:semicolon
id|val_len
op_or_assign
op_star
id|ptr
op_increment
op_lshift
l_int|8
suffix:semicolon
r_if
c_cond
(paren
id|val_len
OG
l_int|1016
)paren
(brace
id|DEBUG
c_func
(paren
l_int|0
comma
l_string|&quot;extract_params, parameter length to long&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|RSP_PROTOCOL_ERROR
suffix:semicolon
)brace
multiline_comment|/* get parameter value */
id|memcpy
c_func
(paren
id|self-&gt;value
comma
id|ptr
comma
id|val_len
)paren
suffix:semicolon
id|self-&gt;value
(braket
id|val_len
)braket
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
id|ptr
op_add_assign
id|val_len
suffix:semicolon
id|DEBUG
c_func
(paren
l_int|4
comma
l_string|&quot;Parameter: %s &quot;
comma
id|self-&gt;name
)paren
suffix:semicolon
id|DEBUG
c_func
(paren
l_int|4
comma
l_string|&quot;Value: %s&bslash;n&quot;
comma
id|self-&gt;value
)paren
suffix:semicolon
id|irlan_check_param
c_func
(paren
id|self
comma
id|self-&gt;name
comma
id|self-&gt;value
)paren
suffix:semicolon
)brace
r_return
id|RSP_SUCCESS
suffix:semicolon
)brace
multiline_comment|/*&n; * Function handle_filter_request (self, skb)&n; *&n; *    Handle filter request from client peer device&n; *&n; */
DECL|function|handle_filter_request
r_void
id|handle_filter_request
c_func
(paren
r_struct
id|irlan_cb
op_star
id|self
comma
r_struct
id|sk_buff
op_star
id|skb
)paren
(brace
id|ASSERT
c_func
(paren
id|self
op_ne
l_int|NULL
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|self-&gt;magic
op_eq
id|IRLAN_MAGIC
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|self-&gt;t.server.filter_type
op_eq
id|IR_DIRECTED
)paren
op_logical_and
(paren
id|self-&gt;t.server.filter_operation
op_eq
id|DYNAMIC
)paren
)paren
(brace
id|DEBUG
c_func
(paren
l_int|0
comma
l_string|&quot;Giving peer a dynamic Ethernet address&bslash;n&quot;
)paren
suffix:semicolon
id|self-&gt;t.server.mac_address
(braket
l_int|0
)braket
op_assign
l_int|0x40
suffix:semicolon
id|self-&gt;t.server.mac_address
(braket
l_int|1
)braket
op_assign
l_int|0x00
suffix:semicolon
id|self-&gt;t.server.mac_address
(braket
l_int|2
)braket
op_assign
l_int|0x00
suffix:semicolon
id|self-&gt;t.server.mac_address
(braket
l_int|3
)braket
op_assign
l_int|0x00
suffix:semicolon
id|self-&gt;t.server.mac_address
(braket
l_int|4
)braket
op_assign
l_int|0x12
suffix:semicolon
id|self-&gt;t.server.mac_address
(braket
l_int|5
)braket
op_assign
l_int|0x34
suffix:semicolon
id|skb-&gt;data
(braket
l_int|0
)braket
op_assign
l_int|0x00
suffix:semicolon
multiline_comment|/* Success */
id|skb-&gt;data
(braket
l_int|1
)braket
op_assign
l_int|0x03
suffix:semicolon
id|insert_param
c_func
(paren
id|skb
comma
l_string|&quot;FILTER_MODE&quot;
comma
l_int|1
comma
l_string|&quot;NONE&quot;
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
id|insert_param
c_func
(paren
id|skb
comma
l_string|&quot;MAX_ENTRY&quot;
comma
l_int|3
comma
l_int|NULL
comma
l_int|0
comma
l_int|0x0001
)paren
suffix:semicolon
id|insert_array_param
c_func
(paren
id|skb
comma
l_string|&quot;FILTER_ENTRY&quot;
comma
id|self-&gt;t.server.mac_address
comma
l_int|6
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|self-&gt;t.server.filter_type
op_eq
id|IR_DIRECTED
)paren
op_logical_and
(paren
id|self-&gt;t.server.filter_mode
op_eq
id|FILTER
)paren
)paren
(brace
id|DEBUG
c_func
(paren
l_int|0
comma
l_string|&quot;Directed filter on&bslash;n&quot;
)paren
suffix:semicolon
id|skb-&gt;data
(braket
l_int|0
)braket
op_assign
l_int|0x00
suffix:semicolon
multiline_comment|/* Success */
id|skb-&gt;data
(braket
l_int|1
)braket
op_assign
l_int|0x00
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|self-&gt;t.server.filter_type
op_eq
id|IR_DIRECTED
)paren
op_logical_and
(paren
id|self-&gt;t.server.filter_mode
op_eq
id|NONE
)paren
)paren
(brace
id|DEBUG
c_func
(paren
l_int|0
comma
l_string|&quot;Directed filter off&bslash;n&quot;
)paren
suffix:semicolon
id|skb-&gt;data
(braket
l_int|0
)braket
op_assign
l_int|0x00
suffix:semicolon
multiline_comment|/* Success */
id|skb-&gt;data
(braket
l_int|1
)braket
op_assign
l_int|0x00
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|self-&gt;t.server.filter_type
op_eq
id|IR_BROADCAST
)paren
op_logical_and
(paren
id|self-&gt;t.server.filter_mode
op_eq
id|FILTER
)paren
)paren
(brace
id|DEBUG
c_func
(paren
l_int|0
comma
l_string|&quot;Broadcast filter on&bslash;n&quot;
)paren
suffix:semicolon
id|skb-&gt;data
(braket
l_int|0
)braket
op_assign
l_int|0x00
suffix:semicolon
multiline_comment|/* Success */
id|skb-&gt;data
(braket
l_int|1
)braket
op_assign
l_int|0x00
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|self-&gt;t.server.filter_type
op_eq
id|IR_BROADCAST
)paren
op_logical_and
(paren
id|self-&gt;t.server.filter_mode
op_eq
id|NONE
)paren
)paren
(brace
id|DEBUG
c_func
(paren
l_int|0
comma
l_string|&quot;Broadcast filter off&bslash;n&quot;
)paren
suffix:semicolon
id|skb-&gt;data
(braket
l_int|0
)braket
op_assign
l_int|0x00
suffix:semicolon
multiline_comment|/* Success */
id|skb-&gt;data
(braket
l_int|1
)braket
op_assign
l_int|0x00
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|self-&gt;t.server.filter_type
op_eq
id|IR_MULTICAST
)paren
op_logical_and
(paren
id|self-&gt;t.server.filter_mode
op_eq
id|FILTER
)paren
)paren
(brace
id|DEBUG
c_func
(paren
l_int|0
comma
l_string|&quot;Multicast filter on&bslash;n&quot;
)paren
suffix:semicolon
id|skb-&gt;data
(braket
l_int|0
)braket
op_assign
l_int|0x00
suffix:semicolon
multiline_comment|/* Success */
id|skb-&gt;data
(braket
l_int|1
)braket
op_assign
l_int|0x00
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|self-&gt;t.server.filter_type
op_eq
id|IR_MULTICAST
)paren
op_logical_and
(paren
id|self-&gt;t.server.filter_mode
op_eq
id|NONE
)paren
)paren
(brace
id|DEBUG
c_func
(paren
l_int|0
comma
l_string|&quot;Multicast filter off&bslash;n&quot;
)paren
suffix:semicolon
id|skb-&gt;data
(braket
l_int|0
)braket
op_assign
l_int|0x00
suffix:semicolon
multiline_comment|/* Success */
id|skb-&gt;data
(braket
l_int|1
)braket
op_assign
l_int|0x00
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|self-&gt;t.server.filter_type
op_eq
id|IR_MULTICAST
)paren
op_logical_and
(paren
id|self-&gt;t.server.filter_operation
op_eq
id|GET
)paren
)paren
(brace
id|DEBUG
c_func
(paren
l_int|0
comma
l_string|&quot;Multicast filter get&bslash;n&quot;
)paren
suffix:semicolon
id|skb-&gt;data
(braket
l_int|0
)braket
op_assign
l_int|0x00
suffix:semicolon
multiline_comment|/* Success? */
id|skb-&gt;data
(braket
l_int|1
)braket
op_assign
l_int|0x02
suffix:semicolon
id|insert_param
c_func
(paren
id|skb
comma
l_string|&quot;FILTER_MODE&quot;
comma
l_int|1
comma
l_string|&quot;NONE&quot;
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
id|insert_param
c_func
(paren
id|skb
comma
l_string|&quot;MAX_ENTRY&quot;
comma
l_int|3
comma
l_int|NULL
comma
l_int|0
comma
l_int|16
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|skb-&gt;data
(braket
l_int|0
)braket
op_assign
l_int|0x00
suffix:semicolon
multiline_comment|/* Command not supported */
id|skb-&gt;data
(braket
l_int|1
)braket
op_assign
l_int|0x00
suffix:semicolon
id|DEBUG
c_func
(paren
l_int|0
comma
l_string|&quot;Not implemented!&bslash;n&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Function check_request_param (self, param, value)&n; *&n; *    Check parameters in request from peer device&n; *&n; */
DECL|function|irlan_check_param
r_static
r_void
id|irlan_check_param
c_func
(paren
r_struct
id|irlan_cb
op_star
id|self
comma
r_char
op_star
id|param
comma
r_char
op_star
id|value
)paren
(brace
id|__u8
op_star
id|bytes
suffix:semicolon
id|DEBUG
c_func
(paren
l_int|4
comma
id|__FUNCTION__
l_string|&quot;()&bslash;n&quot;
)paren
suffix:semicolon
id|bytes
op_assign
id|value
suffix:semicolon
id|ASSERT
c_func
(paren
id|self
op_ne
l_int|NULL
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|self-&gt;magic
op_eq
id|IRLAN_MAGIC
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
id|DEBUG
c_func
(paren
l_int|4
comma
l_string|&quot;%s, %s&bslash;n&quot;
comma
id|param
comma
id|value
)paren
suffix:semicolon
multiline_comment|/*&n;&t; *  This is experimental!! DB.&n;&t; */
r_if
c_cond
(paren
id|strcmp
c_func
(paren
id|param
comma
l_string|&quot;MODE&quot;
)paren
op_eq
l_int|0
)paren
(brace
id|DEBUG
c_func
(paren
l_int|0
comma
id|__FUNCTION__
l_string|&quot;()&bslash;n&quot;
)paren
suffix:semicolon
id|self-&gt;use_udata
op_assign
id|TRUE
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/*&n;&t; *  FILTER_TYPE&n;&t; */
r_if
c_cond
(paren
id|strcmp
c_func
(paren
id|param
comma
l_string|&quot;FILTER_TYPE&quot;
)paren
op_eq
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|strcmp
c_func
(paren
id|value
comma
l_string|&quot;DIRECTED&quot;
)paren
op_eq
l_int|0
)paren
(brace
id|self-&gt;t.server.filter_type
op_assign
id|IR_DIRECTED
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|strcmp
c_func
(paren
id|value
comma
l_string|&quot;MULTICAST&quot;
)paren
op_eq
l_int|0
)paren
(brace
id|self-&gt;t.server.filter_type
op_assign
id|IR_MULTICAST
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|strcmp
c_func
(paren
id|value
comma
l_string|&quot;BROADCAST&quot;
)paren
op_eq
l_int|0
)paren
(brace
id|self-&gt;t.server.filter_type
op_assign
id|IR_BROADCAST
suffix:semicolon
r_return
suffix:semicolon
)brace
)brace
multiline_comment|/*&n;&t; *  FILTER_MODE&n;&t; */
r_if
c_cond
(paren
id|strcmp
c_func
(paren
id|param
comma
l_string|&quot;FILTER_MODE&quot;
)paren
op_eq
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|strcmp
c_func
(paren
id|value
comma
l_string|&quot;ALL&quot;
)paren
op_eq
l_int|0
)paren
(brace
id|self-&gt;t.server.filter_mode
op_assign
id|ALL
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|strcmp
c_func
(paren
id|value
comma
l_string|&quot;FILTER&quot;
)paren
op_eq
l_int|0
)paren
(brace
id|self-&gt;t.server.filter_mode
op_assign
id|FILTER
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|strcmp
c_func
(paren
id|value
comma
l_string|&quot;NONE&quot;
)paren
op_eq
l_int|0
)paren
(brace
id|self-&gt;t.server.filter_mode
op_assign
id|FILTER
suffix:semicolon
r_return
suffix:semicolon
)brace
)brace
multiline_comment|/*&n;&t; *  FILTER_OPERATION&n;&t; */
r_if
c_cond
(paren
id|strcmp
c_func
(paren
id|param
comma
l_string|&quot;FILTER_OPERATION&quot;
)paren
op_eq
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|strcmp
c_func
(paren
id|value
comma
l_string|&quot;DYNAMIC&quot;
)paren
op_eq
l_int|0
)paren
(brace
id|self-&gt;t.server.filter_operation
op_assign
id|DYNAMIC
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|strcmp
c_func
(paren
id|value
comma
l_string|&quot;GET&quot;
)paren
op_eq
l_int|0
)paren
(brace
id|self-&gt;t.server.filter_operation
op_assign
id|GET
suffix:semicolon
r_return
suffix:semicolon
)brace
)brace
)brace
multiline_comment|/*&n; * Function irlan_server_send_reply (self, info)&n; *&n; *    Send reply to query to peer IrLAN layer&n; *&n; */
DECL|function|irlan_server_send_reply
r_void
id|irlan_server_send_reply
c_func
(paren
r_struct
id|irlan_cb
op_star
id|self
comma
r_int
id|command
comma
r_int
id|ret_code
)paren
(brace
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
id|DEBUG
c_func
(paren
l_int|4
comma
l_string|&quot;irlan_server_send_reply()&bslash;n&quot;
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|self
op_ne
l_int|NULL
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|self-&gt;magic
op_eq
id|IRLAN_MAGIC
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
id|skb
op_assign
id|dev_alloc_skb
c_func
(paren
l_int|128
)paren
suffix:semicolon
r_if
c_cond
(paren
id|skb
op_eq
l_int|NULL
)paren
(brace
id|DEBUG
c_func
(paren
l_int|0
comma
l_string|&quot;irlan_server_send_reply: &quot;
l_string|&quot;Could not allocate an sk_buff of length %d&bslash;n&quot;
comma
l_int|128
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/* Reserve space for TTP, LMP, and LAP header */
id|skb_reserve
c_func
(paren
id|skb
comma
id|TTP_HEADER
op_plus
id|LMP_HEADER
op_plus
id|LAP_HEADER
)paren
suffix:semicolon
id|skb_put
c_func
(paren
id|skb
comma
l_int|2
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|command
)paren
(brace
r_case
id|CMD_GET_PROVIDER_INFO
suffix:colon
id|skb-&gt;data
(braket
l_int|0
)braket
op_assign
l_int|0x00
suffix:semicolon
multiline_comment|/* Success */
id|skb-&gt;data
(braket
l_int|1
)braket
op_assign
l_int|0x02
suffix:semicolon
multiline_comment|/* 2 parameters */
id|insert_param
c_func
(paren
id|skb
comma
l_string|&quot;MEDIA&quot;
comma
l_int|1
comma
l_string|&quot;802.3&quot;
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
id|insert_param
c_func
(paren
id|skb
comma
l_string|&quot;IRLAN_VER&quot;
comma
l_int|3
comma
l_int|NULL
comma
l_int|0
comma
l_int|0x0101
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CMD_GET_MEDIA_CHAR
suffix:colon
id|skb-&gt;data
(braket
l_int|0
)braket
op_assign
l_int|0x00
suffix:semicolon
multiline_comment|/* Success */
id|skb-&gt;data
(braket
l_int|1
)braket
op_assign
l_int|0x05
suffix:semicolon
multiline_comment|/* 5 parameters */
id|insert_param
c_func
(paren
id|skb
comma
l_string|&quot;FILTER_TYPE&quot;
comma
l_int|1
comma
l_string|&quot;DIRECTED&quot;
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
id|insert_param
c_func
(paren
id|skb
comma
l_string|&quot;FILTER_TYPE&quot;
comma
l_int|1
comma
l_string|&quot;BROADCAST&quot;
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
id|insert_param
c_func
(paren
id|skb
comma
l_string|&quot;FILTER_TYPE&quot;
comma
l_int|1
comma
l_string|&quot;MULTICAST&quot;
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
id|insert_param
c_func
(paren
id|skb
comma
l_string|&quot;ACCESS_TYPE&quot;
comma
l_int|1
comma
l_string|&quot;DIRECTED&quot;
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
id|insert_param
c_func
(paren
id|skb
comma
l_string|&quot;MAX_FRAME&quot;
comma
l_int|3
comma
l_int|NULL
comma
l_int|0
comma
l_int|0x05ee
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CMD_OPEN_DATA_CHANNEL
suffix:colon
id|skb-&gt;data
(braket
l_int|0
)braket
op_assign
l_int|0x00
suffix:semicolon
multiline_comment|/* Success */
id|skb-&gt;data
(braket
l_int|1
)braket
op_assign
l_int|0x02
suffix:semicolon
multiline_comment|/* 2 parameters */
id|insert_param
c_func
(paren
id|skb
comma
l_string|&quot;DATA_CHAN&quot;
comma
l_int|2
comma
l_int|NULL
comma
id|self-&gt;stsap_sel_data
comma
l_int|0
)paren
suffix:semicolon
id|insert_param
c_func
(paren
id|skb
comma
l_string|&quot;RECONNECT_KEY&quot;
comma
l_int|1
comma
l_string|&quot;LINUX RULES!&quot;
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CMD_FILTER_OPERATION
suffix:colon
id|handle_filter_request
c_func
(paren
id|self
comma
id|skb
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|DEBUG
c_func
(paren
l_int|0
comma
id|__FUNCTION__
l_string|&quot;(), Unknown command!&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|irttp_data_request
c_func
(paren
id|self-&gt;tsap_ctrl
comma
id|skb
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Function irlan_server_register(void)&n; *&n; *    Register server support so we can accept incomming connections. We&n; *    must register both a TSAP for control and data&n; * &n; */
DECL|function|irlan_server_register
r_void
id|irlan_server_register
c_func
(paren
r_void
)paren
(brace
r_struct
id|notify_t
id|notify
suffix:semicolon
r_struct
id|irlan_cb
op_star
id|self
suffix:semicolon
r_struct
id|ias_object
op_star
id|obj
suffix:semicolon
r_struct
id|tsap_cb
op_star
id|tsap
suffix:semicolon
id|DEBUG
c_func
(paren
l_int|4
comma
id|__FUNCTION__
l_string|&quot;()&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/*&n;&t; *  Open irlan_server instance&n;&t; */
id|self
op_assign
id|irlan_server_open
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|self
op_logical_or
id|self-&gt;magic
op_ne
id|IRLAN_MAGIC
)paren
(brace
id|DEBUG
c_func
(paren
l_int|0
comma
id|__FUNCTION__
l_string|&quot;(), Unable to open server!&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/*&n;&t; *  First register well known control TSAP&n;&t; */
id|irda_notify_init
c_func
(paren
op_amp
id|notify
)paren
suffix:semicolon
id|notify.data_indication
op_assign
id|irlan_server_control_data_indication
suffix:semicolon
id|notify.connect_indication
op_assign
id|irlan_server_connect_indication
suffix:semicolon
id|notify.disconnect_indication
op_assign
id|irlan_server_disconnect_indication
suffix:semicolon
id|notify.instance
op_assign
id|self
suffix:semicolon
id|strncpy
c_func
(paren
id|notify.name
comma
l_string|&quot;IrLAN srv. ctrl&quot;
comma
l_int|16
)paren
suffix:semicolon
multiline_comment|/* FIXME: should not use a static value here! */
id|tsap
op_assign
id|irttp_open_tsap
c_func
(paren
id|TSAP_IRLAN
comma
l_int|1
comma
op_amp
id|notify
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tsap
op_eq
l_int|NULL
)paren
(brace
id|DEBUG
c_func
(paren
l_int|0
comma
id|__FUNCTION__
l_string|&quot;(), Got no handle!!&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|self-&gt;tsap_ctrl
op_assign
id|tsap
suffix:semicolon
multiline_comment|/*&n;&t; *  Now register data TSAP&n;&t; */
id|irda_notify_init
c_func
(paren
op_amp
id|notify
)paren
suffix:semicolon
id|notify.data_indication
op_assign
id|irlan_eth_rx
suffix:semicolon
id|notify.udata_indication
op_assign
id|irlan_eth_rx
suffix:semicolon
id|notify.connect_indication
op_assign
id|irlan_server_connect_indication
suffix:semicolon
id|notify.disconnect_indication
op_assign
id|irlan_server_disconnect_indication
suffix:semicolon
id|notify.instance
op_assign
id|self
suffix:semicolon
id|strncpy
c_func
(paren
id|notify.name
comma
l_string|&quot;IrLAN srv. data&quot;
comma
l_int|16
)paren
suffix:semicolon
multiline_comment|/*&n;&t; *  Register well known address with IrTTP&n;&t; */
id|tsap
op_assign
id|irttp_open_tsap
c_func
(paren
id|LSAP_ANY
comma
id|DEFAULT_INITIAL_CREDIT
comma
op_amp
id|notify
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tsap
op_eq
l_int|NULL
)paren
(brace
id|DEBUG
c_func
(paren
l_int|0
comma
id|__FUNCTION__
l_string|&quot;(), Got no handle!&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|self-&gt;tsap_data
op_assign
id|tsap
suffix:semicolon
multiline_comment|/* &n;&t; *  This is the data TSAP selector which we will pass to the client&n;&t; *  when the client ask for it.&n;&t; */
id|self-&gt;stsap_sel_data
op_assign
id|tsap-&gt;stsap_sel
suffix:semicolon
id|ASSERT
c_func
(paren
id|self-&gt;stsap_sel_data
OG
l_int|0
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
id|DEBUG
c_func
(paren
l_int|0
comma
l_string|&quot;irlan_server_register(), Using Source TSAP selector=%02x&bslash;n&quot;
comma
id|self-&gt;stsap_sel_data
)paren
suffix:semicolon
multiline_comment|/* &n;&t; *  Register with LM-IAS&n;&t; */
id|obj
op_assign
id|irias_new_object
c_func
(paren
l_string|&quot;IrLAN&quot;
comma
id|IAS_IRLAN_ID
)paren
suffix:semicolon
id|irias_add_integer_attrib
c_func
(paren
id|obj
comma
l_string|&quot;IrDA:TinyTP:LsapSel&quot;
comma
id|TSAP_IRLAN
)paren
suffix:semicolon
id|irias_insert_object
c_func
(paren
id|obj
)paren
suffix:semicolon
id|obj
op_assign
id|irias_new_object
c_func
(paren
l_string|&quot;PnP&quot;
comma
id|IAS_PNP_ID
)paren
suffix:semicolon
id|irias_add_string_attrib
c_func
(paren
id|obj
comma
l_string|&quot;Name&quot;
comma
l_string|&quot;Linux&quot;
)paren
suffix:semicolon
id|irias_add_string_attrib
c_func
(paren
id|obj
comma
l_string|&quot;DeviceID&quot;
comma
l_string|&quot;HWP19F0&quot;
)paren
suffix:semicolon
id|irias_add_integer_attrib
c_func
(paren
id|obj
comma
l_string|&quot;CompCnt&quot;
comma
l_int|2
)paren
suffix:semicolon
id|irias_add_string_attrib
c_func
(paren
id|obj
comma
l_string|&quot;Comp#01&quot;
comma
l_string|&quot;PNP8294&quot;
)paren
suffix:semicolon
id|irias_add_string_attrib
c_func
(paren
id|obj
comma
l_string|&quot;Comp#01&quot;
comma
l_string|&quot;PNP8389&quot;
)paren
suffix:semicolon
id|irias_add_string_attrib
c_func
(paren
id|obj
comma
l_string|&quot;Manufacturer&quot;
comma
l_string|&quot;Linux/IR Project&quot;
)paren
suffix:semicolon
id|irias_insert_object
c_func
(paren
id|obj
)paren
suffix:semicolon
)brace
macro_line|#ifdef MODULE
id|MODULE_AUTHOR
c_func
(paren
l_string|&quot;Dag Brattli &lt;dagb@cs.uit.no&gt;&quot;
)paren
suffix:semicolon
id|MODULE_DESCRIPTION
c_func
(paren
l_string|&quot;The Linux IrDA LAN Server protocol&quot;
)paren
suffix:semicolon
multiline_comment|/*&n; * Function init_module (void)&n; *&n; *    Initialize the IrLAN module, this function is called by the&n; *    modprobe(1) program.&n; */
DECL|function|init_module
r_int
id|init_module
c_func
(paren
r_void
)paren
(brace
multiline_comment|/* &t;int result; */
id|DEBUG
c_func
(paren
l_int|4
comma
l_string|&quot;--&gt; IrLAN irlan_server: init_module&bslash;n&quot;
)paren
suffix:semicolon
id|irlan_server_init
c_func
(paren
)paren
suffix:semicolon
id|DEBUG
c_func
(paren
l_int|4
comma
l_string|&quot;IrLAN irlan_server: init_module --&gt;&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * Function cleanup_module (void)&n; *&n; *    Remove the IrLAN module, this function is called by the rmmod(1)&n; *    program&n; */
DECL|function|cleanup_module
r_void
id|cleanup_module
c_func
(paren
r_void
)paren
(brace
id|DEBUG
c_func
(paren
l_int|4
comma
l_string|&quot;--&gt; irlan_server, cleanup_module&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* No need to check MOD_IN_USE, as sys_delete_module() checks. */
multiline_comment|/* Free some memory */
id|irlan_server_cleanup
c_func
(paren
)paren
suffix:semicolon
id|DEBUG
c_func
(paren
l_int|4
comma
l_string|&quot;irlan_server, cleanup_module --&gt;&bslash;n&quot;
)paren
suffix:semicolon
)brace
macro_line|#endif /* MODULE */
eof
