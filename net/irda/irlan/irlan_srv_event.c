multiline_comment|/*********************************************************************&n; *                &n; * Filename:      irlan_srv_event.c&n; * Version:       0.1&n; * Description:   IrLAN Server FSM (Finite State Machine)&n; * Status:        Experimental.&n; * Author:        Dag Brattli &lt;dagb@cs.uit.no&gt;&n; * Created at:    Sun Aug 31 20:14:37 1997&n; * Modified at:   Wed Dec  9 02:39:05 1998&n; * Modified by:   Dag Brattli &lt;dagb@cs.uit.no&gt;&n; * &n; *     Copyright (c) 1998 Dag Brattli &lt;dagb@cs.uit.no&gt;, All Rights Reserved.&n; *     &n; *     This program is free software; you can redistribute it and/or &n; *     modify it under the terms of the GNU General Public License as &n; *     published by the Free Software Foundation; either version 2 of &n; *     the License, or (at your option) any later version.&n; *&n; *     Neither Dag Brattli nor University of Troms&#xfffd; admit liability nor&n; *     provide warranty for any of this software. This material is &n; *     provided &quot;AS-IS&quot; and at no charge.&n; *&n; ********************************************************************/
macro_line|#include &lt;net/irda/irda.h&gt;
macro_line|#include &lt;net/irda/iriap.h&gt;
macro_line|#include &lt;net/irda/irlmp.h&gt;
macro_line|#include &lt;net/irda/irttp.h&gt;
macro_line|#include &lt;net/irda/irlan_srv.h&gt;
macro_line|#include &lt;net/irda/irlan_event.h&gt;
r_static
r_int
id|irlan_server_state_idle
(paren
r_struct
id|irlan_cb
op_star
id|self
comma
id|IRLAN_EVENT
id|event
comma
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|irlan_info
op_star
id|info
)paren
suffix:semicolon
r_static
r_int
id|irlan_server_state_info
(paren
r_struct
id|irlan_cb
op_star
id|self
comma
id|IRLAN_EVENT
id|event
comma
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|irlan_info
op_star
id|info
)paren
suffix:semicolon
r_static
r_int
id|irlan_server_state_open
(paren
r_struct
id|irlan_cb
op_star
id|self
comma
id|IRLAN_EVENT
id|event
comma
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|irlan_info
op_star
id|info
)paren
suffix:semicolon
r_static
r_int
id|irlan_server_state_data
(paren
r_struct
id|irlan_cb
op_star
id|self
comma
id|IRLAN_EVENT
id|event
comma
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|irlan_info
op_star
id|info
)paren
suffix:semicolon
DECL|variable|state
r_static
r_int
(paren
op_star
id|state
(braket
)braket
)paren
(paren
r_struct
id|irlan_cb
op_star
id|self
comma
id|IRLAN_EVENT
id|event
comma
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|irlan_info
op_star
id|info
)paren
op_assign
(brace
id|irlan_server_state_idle
comma
l_int|NULL
comma
multiline_comment|/* Query */
l_int|NULL
comma
multiline_comment|/* Info */
id|irlan_server_state_info
comma
l_int|NULL
comma
multiline_comment|/* Media */
id|irlan_server_state_open
comma
l_int|NULL
comma
multiline_comment|/* Wait */
l_int|NULL
comma
multiline_comment|/* Arb */
id|irlan_server_state_data
comma
l_int|NULL
comma
multiline_comment|/* Close */
l_int|NULL
comma
multiline_comment|/* Sync */
)brace
suffix:semicolon
DECL|function|irlan_do_server_event
r_void
id|irlan_do_server_event
c_func
(paren
r_struct
id|irlan_cb
op_star
id|self
comma
id|IRLAN_EVENT
id|event
comma
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|irlan_info
op_star
id|info
)paren
(brace
(paren
op_star
id|state
(braket
id|self-&gt;state
)braket
)paren
(paren
id|self
comma
id|event
comma
id|skb
comma
id|info
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Function irlan_server_state_idle (event, skb, info)&n; *&n; *    IDLE, We are waiting for an indication that there is a provider&n; *    available.&n; */
DECL|function|irlan_server_state_idle
r_static
r_int
id|irlan_server_state_idle
c_func
(paren
r_struct
id|irlan_cb
op_star
id|self
comma
id|IRLAN_EVENT
id|event
comma
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|irlan_info
op_star
id|info
)paren
(brace
id|DEBUG
c_func
(paren
l_int|4
comma
id|__FUNCTION__
l_string|&quot;()&bslash;n&quot;
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|self
op_ne
l_int|NULL
comma
r_return
op_minus
l_int|1
suffix:semicolon
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|event
)paren
(brace
r_case
id|IRLAN_CONNECT_INDICATION
suffix:colon
id|ASSERT
c_func
(paren
id|info
op_ne
l_int|NULL
comma
r_return
l_int|0
suffix:semicolon
)paren
suffix:semicolon
id|irlan_server_connect_response
c_func
(paren
id|self
comma
id|info-&gt;tsap
)paren
suffix:semicolon
id|irlan_next_state
c_func
(paren
id|self
comma
id|IRLAN_INFO
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|DEBUG
c_func
(paren
l_int|4
comma
id|__FUNCTION__
l_string|&quot;(), Unknown event %d&bslash;n&quot;
comma
id|event
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|skb
)paren
(brace
id|dev_kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * Function irlan_server_state_info (self, event, skb, info)&n; *&n; *    INFO, We have issued a GetInfo command and is awaiting a reply.&n; */
DECL|function|irlan_server_state_info
r_static
r_int
id|irlan_server_state_info
c_func
(paren
r_struct
id|irlan_cb
op_star
id|self
comma
id|IRLAN_EVENT
id|event
comma
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|irlan_info
op_star
id|info
)paren
(brace
r_int
id|ret
suffix:semicolon
id|DEBUG
c_func
(paren
l_int|4
comma
id|__FUNCTION__
l_string|&quot;()&bslash;n&quot;
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|self
op_ne
l_int|NULL
comma
r_return
op_minus
l_int|1
suffix:semicolon
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|event
)paren
(brace
r_case
id|IRLAN_GET_INFO_CMD
suffix:colon
id|irlan_server_send_reply
c_func
(paren
id|self
comma
id|CMD_GET_PROVIDER_INFO
comma
id|RSP_SUCCESS
)paren
suffix:semicolon
multiline_comment|/* Keep state */
r_break
suffix:semicolon
r_case
id|IRLAN_GET_MEDIA_CMD
suffix:colon
id|irlan_server_send_reply
c_func
(paren
id|self
comma
id|CMD_GET_MEDIA_CHAR
comma
id|RSP_SUCCESS
)paren
suffix:semicolon
multiline_comment|/* Keep state */
r_break
suffix:semicolon
r_case
id|IRLAN_OPEN_DATA_CMD
suffix:colon
id|ret
op_assign
id|irlan_parse_open_data_cmd
c_func
(paren
id|self
comma
id|skb
)paren
suffix:semicolon
id|irlan_server_send_reply
c_func
(paren
id|self
comma
id|CMD_OPEN_DATA_CHANNEL
comma
id|ret
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
op_eq
id|RSP_SUCCESS
)paren
id|irlan_next_state
c_func
(paren
id|self
comma
id|IRLAN_OPEN
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|IRLAN_LMP_DISCONNECT
suffix:colon
r_case
id|IRLAN_LAP_DISCONNECT
suffix:colon
id|irlan_next_state
c_func
(paren
id|self
comma
id|IRLAN_IDLE
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|DEBUG
c_func
(paren
l_int|0
comma
l_string|&quot;irlan_server_state_info, Unknown event %d&bslash;n&quot;
comma
id|event
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|skb
)paren
(brace
id|dev_kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * Function irlan_server_state_open (self, event, skb, info)&n; *&n; *    OPEN, The client has issued a OpenData command and is awaiting a&n; *    reply&n; *&n; */
DECL|function|irlan_server_state_open
r_static
r_int
id|irlan_server_state_open
c_func
(paren
r_struct
id|irlan_cb
op_star
id|self
comma
id|IRLAN_EVENT
id|event
comma
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|irlan_info
op_star
id|info
)paren
(brace
id|DEBUG
c_func
(paren
l_int|4
comma
id|__FUNCTION__
l_string|&quot;()&bslash;n&quot;
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|self
op_ne
l_int|NULL
comma
r_return
op_minus
l_int|1
suffix:semicolon
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|event
)paren
(brace
r_case
id|IRLAN_FILTER_CONFIG_CMD
suffix:colon
id|irlan_server_extract_params
c_func
(paren
id|self
comma
id|CMD_FILTER_OPERATION
comma
id|skb
)paren
suffix:semicolon
id|irlan_server_send_reply
c_func
(paren
id|self
comma
id|CMD_FILTER_OPERATION
comma
id|RSP_SUCCESS
)paren
suffix:semicolon
multiline_comment|/* Keep state */
r_break
suffix:semicolon
r_case
id|IRLAN_DATA_CONNECT_INDICATION
suffix:colon
id|DEBUG
c_func
(paren
l_int|4
comma
l_string|&quot;DATA_CONNECT_INDICATION&bslash;n&quot;
)paren
suffix:semicolon
id|irlan_next_state
c_func
(paren
id|self
comma
id|IRLAN_DATA
)paren
suffix:semicolon
id|irlan_server_connect_response
c_func
(paren
id|self
comma
id|info-&gt;tsap
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|IRLAN_LMP_DISCONNECT
suffix:colon
r_case
id|IRLAN_LAP_DISCONNECT
suffix:colon
id|irlan_next_state
c_func
(paren
id|self
comma
id|IRLAN_IDLE
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|DEBUG
c_func
(paren
l_int|0
comma
id|__FUNCTION__
l_string|&quot;(), Unknown event %d&bslash;n&quot;
comma
id|event
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|skb
)paren
(brace
id|dev_kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * Function irlan_server_state_data (self, event, skb, info)&n; *&n; *    DATA, The data channel is connected, allowing data transfers between&n; *    the local and remote machines.&n; *&n; */
DECL|function|irlan_server_state_data
r_static
r_int
id|irlan_server_state_data
c_func
(paren
r_struct
id|irlan_cb
op_star
id|self
comma
id|IRLAN_EVENT
id|event
comma
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|irlan_info
op_star
id|info
)paren
(brace
r_struct
id|irmanager_event
id|mgr_event
suffix:semicolon
id|DEBUG
c_func
(paren
l_int|4
comma
id|__FUNCTION__
l_string|&quot;()&bslash;n&quot;
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|self
op_ne
l_int|NULL
comma
r_return
op_minus
l_int|1
suffix:semicolon
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|self-&gt;magic
op_eq
id|IRLAN_MAGIC
comma
r_return
op_minus
l_int|1
suffix:semicolon
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|event
)paren
(brace
r_case
id|IRLAN_FILTER_CONFIG_CMD
suffix:colon
id|irlan_server_extract_params
c_func
(paren
id|self
comma
id|CMD_FILTER_OPERATION
comma
id|skb
)paren
suffix:semicolon
id|irlan_server_send_reply
c_func
(paren
id|self
comma
id|CMD_FILTER_OPERATION
comma
id|RSP_SUCCESS
)paren
suffix:semicolon
multiline_comment|/* Make sure the code below only runs once */
r_if
c_cond
(paren
op_logical_neg
id|self-&gt;connected
)paren
(brace
id|mgr_event.event
op_assign
id|EVENT_IRLAN_START
suffix:semicolon
id|sprintf
c_func
(paren
id|mgr_event.devname
comma
l_string|&quot;%s&quot;
comma
id|self-&gt;ifname
)paren
suffix:semicolon
id|irmanager_notify
c_func
(paren
op_amp
id|mgr_event
)paren
suffix:semicolon
id|self-&gt;connected
op_assign
id|TRUE
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|IRLAN_LMP_DISCONNECT
suffix:colon
r_case
id|IRLAN_LAP_DISCONNECT
suffix:colon
id|mgr_event.event
op_assign
id|EVENT_IRLAN_STOP
suffix:semicolon
id|sprintf
c_func
(paren
id|mgr_event.devname
comma
l_string|&quot;%s&quot;
comma
id|self-&gt;ifname
)paren
suffix:semicolon
id|irmanager_notify
c_func
(paren
op_amp
id|mgr_event
)paren
suffix:semicolon
id|irlan_next_state
c_func
(paren
id|self
comma
id|IRLAN_IDLE
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|DEBUG
c_func
(paren
l_int|0
comma
l_string|&quot;irlan_server_state_data, Unknown event %d&bslash;n&quot;
comma
id|event
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|skb
)paren
(brace
id|dev_kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
eof
