multiline_comment|/*********************************************************************&n; *                &n; * Filename:      irlan_cli.c&n; * Version:       0.8&n; * Description:   IrDA LAN Access Protocol Client&n; * Status:        Experimental.&n; * Author:        Dag Brattli &lt;dagb@cs.uit.no&gt;&n; * Created at:    Sun Aug 31 20:14:37 1997&n; * Modified at:   Mon Jan 18 13:24:26 1999&n; * Modified by:   Dag Brattli &lt;dagb@cs.uit.no&gt;&n; * Sources:       skeleton.c by Donald Becker &lt;becker@CESDIS.gsfc.nasa.gov&gt;&n; *                slip.c by Laurence Culhane, &lt;loz@holmes.demon.co.uk&gt;&n; *                          Fred N. van Kempen, &lt;waltje@uwalt.nl.mugnet.org&gt;&n; * &n; *     Copyright (c) 1998 Dag Brattli &lt;dagb@cs.uit.no&gt;, All Rights Reserved.&n; *     &n; *     This program is free software; you can redistribute it and/or &n; *     modify it under the terms of the GNU General Public License as &n; *     published by the Free Software Foundation; either version 2 of &n; *     the License, or (at your option) any later version.&n; *&n; *     Neither Dag Brattli nor University of Troms&#xfffd; admit liability nor&n; *     provide warranty for any of this software. This material is &n; *     provided &quot;AS-IS&quot; and at no charge.&n; *&n; ********************************************************************/
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/netdevice.h&gt;
macro_line|#include &lt;linux/etherdevice.h&gt;
macro_line|#include &lt;linux/if_arp.h&gt;
macro_line|#include &lt;net/arp.h&gt;
macro_line|#include &lt;asm/system.h&gt;
macro_line|#include &lt;asm/bitops.h&gt;
macro_line|#include &lt;asm/byteorder.h&gt;
macro_line|#include &lt;net/irda/irda.h&gt;
macro_line|#include &lt;net/irda/irttp.h&gt;
macro_line|#include &lt;net/irda/irlmp.h&gt;
macro_line|#include &lt;net/irda/irias_object.h&gt;
macro_line|#include &lt;net/irda/iriap.h&gt;
macro_line|#include &lt;net/irda/timer.h&gt;
macro_line|#include &lt;net/irda/irlan_common.h&gt;
macro_line|#include &lt;net/irda/irlan_event.h&gt;
macro_line|#include &lt;net/irda/irlan_eth.h&gt;
macro_line|#include &lt;net/irda/irlan_cli.h&gt;
multiline_comment|/*&n; *  Private functions&n; */
r_static
r_struct
id|irlan_cb
op_star
id|irlan_client_open
c_func
(paren
id|__u32
id|saddr
comma
id|__u32
id|daddr
)paren
suffix:semicolon
r_static
r_void
id|irlan_client_close
c_func
(paren
r_struct
id|irlan_cb
op_star
id|self
)paren
suffix:semicolon
DECL|function|irlan_client_eth_open
r_static
r_int
id|irlan_client_eth_open
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
multiline_comment|/* struct irlan_cb *self = (struct irlan_cb *) dev-&gt;priv; */
id|DEBUG
c_func
(paren
l_int|4
comma
id|__FUNCTION__
l_string|&quot;()&bslash;n&quot;
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|dev
op_ne
l_int|NULL
comma
r_return
op_minus
l_int|1
suffix:semicolon
)paren
suffix:semicolon
multiline_comment|/* Ready to play! */
id|dev-&gt;tbusy
op_assign
l_int|0
suffix:semicolon
id|dev-&gt;interrupt
op_assign
l_int|0
suffix:semicolon
id|dev-&gt;start
op_assign
l_int|1
suffix:semicolon
id|MOD_INC_USE_COUNT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * Function irlan_eth_close (dev)&n; *&n; *    Stop the Client ether network device, his function will be called by&n; *    ifconfig down.&n; */
DECL|function|irlan_client_eth_close
r_static
r_int
id|irlan_client_eth_close
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
id|DEBUG
c_func
(paren
l_int|4
comma
id|__FUNCTION__
l_string|&quot;()&bslash;n&quot;
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|dev
op_ne
l_int|NULL
comma
r_return
op_minus
l_int|1
suffix:semicolon
)paren
suffix:semicolon
multiline_comment|/* Stop device */
id|dev-&gt;tbusy
op_assign
l_int|1
suffix:semicolon
id|dev-&gt;start
op_assign
l_int|0
suffix:semicolon
id|MOD_DEC_USE_COUNT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * Function irlan_client_eth_init (dev)&n; *&n; *    &n; *&n; */
DECL|function|irlan_client_eth_init
r_int
id|irlan_client_eth_init
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
id|irlan_eth_init
c_func
(paren
id|dev
)paren
suffix:semicolon
multiline_comment|/* Overrride some functions */
id|dev-&gt;open
op_assign
id|irlan_client_eth_open
suffix:semicolon
id|dev-&gt;stop
op_assign
id|irlan_client_eth_close
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * Function irlan_client_init (dev)&n; *&n; *   Allocates the master array. Called by modprobe().&n; */
DECL|function|__initfunc
id|__initfunc
c_func
(paren
r_int
id|irlan_client_init
c_func
(paren
r_void
)paren
)paren
(brace
id|DEBUG
c_func
(paren
l_int|4
comma
id|__FUNCTION__
l_string|&quot;()&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* Register with IrLMP as a service user */
id|irlmp_register_layer
c_func
(paren
id|S_LAN
comma
id|CLIENT
comma
id|TRUE
comma
id|irlan_discovery_indication
)paren
suffix:semicolon
multiline_comment|/* Do some fast discovery! */
id|irlmp_discovery_request
c_func
(paren
l_int|8
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * Function irlan_client_cleanup (void)&n; *&n; *    Removes all instances of the IrLAN network device driver, and the&n; *    master array. Called by rmmod().&n; *&n; */
DECL|function|irlan_client_cleanup
r_void
id|irlan_client_cleanup
c_func
(paren
r_void
)paren
(brace
id|DEBUG
c_func
(paren
l_int|4
comma
id|__FUNCTION__
l_string|&quot;()&bslash;n&quot;
)paren
suffix:semicolon
id|irlmp_unregister_layer
c_func
(paren
id|S_LAN
comma
id|CLIENT
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Function irlan_client_open (void)&n; *&n; *    This function allocates and opens a new instance of the IrLAN network&n; *    device driver.&n; *&n; */
DECL|function|irlan_client_open
r_static
r_struct
id|irlan_cb
op_star
id|irlan_client_open
c_func
(paren
id|__u32
id|saddr
comma
id|__u32
id|daddr
)paren
(brace
r_struct
id|irlan_cb
op_star
id|self
suffix:semicolon
r_int
id|result
suffix:semicolon
id|DEBUG
c_func
(paren
l_int|4
comma
l_string|&quot;IrLAN: irlan_client_open()&bslash;n&quot;
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|irlan
op_ne
l_int|NULL
comma
r_return
l_int|NULL
suffix:semicolon
)paren
suffix:semicolon
id|self
op_assign
id|irlan_open
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|self
op_eq
l_int|NULL
)paren
r_return
l_int|NULL
suffix:semicolon
multiline_comment|/* Use default name instead! */
multiline_comment|/* sprintf( self-&gt;ifname, &quot;irlan%d&quot;, ); */
id|self-&gt;dev.name
op_assign
id|self-&gt;ifname
suffix:semicolon
id|self-&gt;dev.priv
op_assign
(paren
r_void
op_star
)paren
id|self
suffix:semicolon
id|self-&gt;dev.next
op_assign
l_int|NULL
suffix:semicolon
id|self-&gt;dev.init
op_assign
id|irlan_client_eth_init
suffix:semicolon
id|self-&gt;saddr
op_assign
id|saddr
suffix:semicolon
id|self-&gt;daddr
op_assign
id|daddr
suffix:semicolon
multiline_comment|/*&n;&t; *  Insert ourself into the hashbin&n;&t; */
id|hashbin_insert
c_func
(paren
id|irlan
comma
(paren
id|QUEUE
op_star
)paren
id|self
comma
id|saddr
comma
l_int|NULL
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|result
op_assign
id|register_netdev
c_func
(paren
op_amp
id|self-&gt;dev
)paren
)paren
op_ne
l_int|0
)paren
(brace
id|DEBUG
c_func
(paren
l_int|0
comma
l_string|&quot;IrLAN, Register_netdev() failed!&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
id|irlan_next_state
c_func
(paren
id|self
comma
id|IRLAN_IDLE
)paren
suffix:semicolon
id|irlan_client_open_tsaps
c_func
(paren
id|self
)paren
suffix:semicolon
r_return
id|self
suffix:semicolon
)brace
multiline_comment|/*&n; * Function irlan_client_close (self)&n; *&n; *    &n; *&n; */
DECL|function|irlan_client_close
r_static
r_void
id|irlan_client_close
c_func
(paren
r_struct
id|irlan_cb
op_star
id|self
)paren
(brace
r_struct
id|irlan_cb
op_star
id|entry
suffix:semicolon
id|DEBUG
c_func
(paren
l_int|0
comma
id|__FUNCTION__
l_string|&quot;()&bslash;n&quot;
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|self
op_ne
l_int|NULL
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|self-&gt;magic
op_eq
id|IRLAN_MAGIC
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
id|entry
op_assign
id|hashbin_remove
c_func
(paren
id|irlan
comma
id|self-&gt;daddr
comma
l_int|NULL
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|entry
op_eq
id|self
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
multiline_comment|/* __irlan_close( self); */
)brace
multiline_comment|/*&n; * Function irlan_discovery_indication (daddr)&n; *&n; *    Remote device with IrLAN server support discovered&n; *&n; */
DECL|function|irlan_discovery_indication
r_void
id|irlan_discovery_indication
c_func
(paren
id|DISCOVERY
op_star
id|discovery
)paren
(brace
r_struct
id|irlan_cb
op_star
id|self
suffix:semicolon
id|__u32
id|saddr
comma
id|daddr
suffix:semicolon
id|ASSERT
c_func
(paren
id|irlan
op_ne
l_int|NULL
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|discovery
op_ne
l_int|NULL
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
id|saddr
op_assign
id|discovery-&gt;saddr
suffix:semicolon
id|daddr
op_assign
id|discovery-&gt;daddr
suffix:semicolon
multiline_comment|/* &n;&t; *  Check if an instance is already dealing with this device&n;&t; *  (saddr) &n;&t; */
id|self
op_assign
(paren
r_struct
id|irlan_cb
op_star
)paren
id|hashbin_find
c_func
(paren
id|irlan
comma
id|saddr
comma
l_int|NULL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|self
op_ne
l_int|NULL
)paren
(brace
id|ASSERT
c_func
(paren
id|self-&gt;magic
op_eq
id|IRLAN_MAGIC
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
id|DEBUG
c_func
(paren
l_int|4
comma
id|__FUNCTION__
l_string|&quot;(), Found instance!&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|self-&gt;state
op_eq
id|IRLAN_IDLE
)paren
(brace
multiline_comment|/* daddr may have changed! */
id|self-&gt;daddr
op_assign
id|daddr
suffix:semicolon
id|irlan_do_client_event
c_func
(paren
id|self
comma
id|IRLAN_DISCOVERY_INDICATION
comma
l_int|NULL
)paren
suffix:semicolon
)brace
r_else
(brace
id|DEBUG
c_func
(paren
l_int|0
comma
id|__FUNCTION__
l_string|&quot;(), state=%s&bslash;n&quot;
comma
id|irlan_state
(braket
id|self-&gt;state
)braket
)paren
suffix:semicolon
multiline_comment|/*  &n;&t;&t;&t; *  If we get here, it&squot;s obvious that the last &n;&t;&t;&t; *  connection attempt has failed, so its best &n;&t;&t;&t; *  to go back to idle!&n;&t;&t;&t; */
id|irlan_do_client_event
c_func
(paren
id|self
comma
id|IRLAN_LMP_DISCONNECT
comma
l_int|NULL
)paren
suffix:semicolon
)brace
r_return
suffix:semicolon
)brace
multiline_comment|/* &n;&t; * We have no instance for daddr, so time to start a new instance.&n;&t; */
id|DEBUG
c_func
(paren
l_int|0
comma
id|__FUNCTION__
l_string|&quot;(), Opening new instance for saddr=%#x&bslash;n&quot;
comma
id|saddr
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|self
op_assign
id|irlan_client_open
c_func
(paren
id|saddr
comma
id|daddr
)paren
)paren
op_eq
l_int|NULL
)paren
(brace
id|DEBUG
c_func
(paren
l_int|0
comma
l_string|&quot;irlan_client_open failed!&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|ASSERT
c_func
(paren
id|self
op_ne
l_int|NULL
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|self-&gt;magic
op_eq
id|IRLAN_MAGIC
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
id|DEBUG
c_func
(paren
l_int|4
comma
l_string|&quot;Setting irlan_client state!&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|self-&gt;state
op_eq
id|IRLAN_IDLE
)paren
(brace
id|irlan_do_client_event
c_func
(paren
id|self
comma
id|IRLAN_DISCOVERY_INDICATION
comma
l_int|NULL
)paren
suffix:semicolon
)brace
r_else
(brace
id|DEBUG
c_func
(paren
l_int|0
comma
id|__FUNCTION__
l_string|&quot;(), Hmm, got here too!&bslash;n&quot;
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/*&n; * Function irlan_client_disconnect_indication (handle)&n; *&n; *    Callback function for the IrTTP layer. Indicates a disconnection of&n; *    the specified connection (handle)&n; */
DECL|function|irlan_client_disconnect_indication
r_void
id|irlan_client_disconnect_indication
c_func
(paren
r_void
op_star
id|instance
comma
r_void
op_star
id|sap
comma
id|LM_REASON
id|reason
comma
r_struct
id|sk_buff
op_star
id|userdata
)paren
(brace
r_struct
id|irlan_cb
op_star
id|self
suffix:semicolon
r_struct
id|tsap_cb
op_star
id|tsap
suffix:semicolon
id|self
op_assign
(paren
r_struct
id|irlan_cb
op_star
)paren
id|instance
suffix:semicolon
id|tsap
op_assign
(paren
r_struct
id|tsap_cb
op_star
)paren
id|sap
suffix:semicolon
id|ASSERT
c_func
(paren
id|self
op_ne
l_int|NULL
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|self-&gt;magic
op_eq
id|IRLAN_MAGIC
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|tsap
op_ne
l_int|NULL
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|tsap-&gt;magic
op_eq
id|TTP_TSAP_MAGIC
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
id|DEBUG
c_func
(paren
l_int|4
comma
id|__FUNCTION__
l_string|&quot;(), reason=%d&bslash;n&quot;
comma
id|reason
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tsap
op_eq
id|self-&gt;tsap_data
)paren
(brace
id|DEBUG
c_func
(paren
l_int|4
comma
l_string|&quot;IrLAN, data channel disconnected by peer!&bslash;n&quot;
)paren
suffix:semicolon
id|self-&gt;connected
op_assign
id|FALSE
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|tsap
op_eq
id|self-&gt;tsap_ctrl
)paren
(brace
id|DEBUG
c_func
(paren
l_int|4
comma
l_string|&quot;IrLAN, control channel disconnected by peer!&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_else
(brace
id|DEBUG
c_func
(paren
l_int|0
comma
l_string|&quot;Error, disconnect on unknown handle!&bslash;n&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/* Stop IP from transmitting more packets */
multiline_comment|/* irlan_client_flow_indication( handle, FLOW_STOP, priv); */
id|irlan_do_client_event
c_func
(paren
id|self
comma
id|IRLAN_LMP_DISCONNECT
comma
l_int|NULL
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Function irlan_control_data_indication (handle, skb)&n; *&n; *    This function gets the data that is received on the control channel&n; *&n; */
DECL|function|irlan_client_ctrl_data_indication
r_void
id|irlan_client_ctrl_data_indication
c_func
(paren
r_void
op_star
id|instance
comma
r_void
op_star
id|sap
comma
r_struct
id|sk_buff
op_star
id|skb
)paren
(brace
r_struct
id|irlan_cb
op_star
id|self
suffix:semicolon
id|DEBUG
c_func
(paren
l_int|4
comma
id|__FUNCTION__
l_string|&quot;()&bslash;n&quot;
)paren
suffix:semicolon
id|self
op_assign
(paren
r_struct
id|irlan_cb
op_star
)paren
id|instance
suffix:semicolon
id|ASSERT
c_func
(paren
id|self
op_ne
l_int|NULL
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|self-&gt;magic
op_eq
id|IRLAN_MAGIC
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|skb
op_ne
l_int|NULL
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
id|DEBUG
c_func
(paren
l_int|4
comma
l_string|&quot;Got IRLAN_DATA_INDICATION!&bslash;n&quot;
)paren
suffix:semicolon
id|irlan_do_client_event
c_func
(paren
id|self
comma
id|IRLAN_DATA_INDICATION
comma
id|skb
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Function irlan_client_open_tsaps (self)&n; *&n; *    Initialize callbacks and open IrTTP TSAPs&n; *&n; */
DECL|function|irlan_client_open_tsaps
r_void
id|irlan_client_open_tsaps
c_func
(paren
r_struct
id|irlan_cb
op_star
id|self
)paren
(brace
multiline_comment|/* struct irlan_frame frame; */
r_struct
id|notify_t
id|notify_ctrl
suffix:semicolon
r_struct
id|notify_t
id|notify_data
suffix:semicolon
id|DEBUG
c_func
(paren
l_int|4
comma
id|__FUNCTION__
l_string|&quot;()&bslash;n&quot;
)paren
suffix:semicolon
id|irda_notify_init
c_func
(paren
op_amp
id|notify_ctrl
)paren
suffix:semicolon
id|irda_notify_init
c_func
(paren
op_amp
id|notify_data
)paren
suffix:semicolon
multiline_comment|/* Set up callbacks */
id|notify_ctrl.data_indication
op_assign
id|irlan_client_ctrl_data_indication
suffix:semicolon
id|notify_ctrl.connect_confirm
op_assign
id|irlan_client_connect_confirm
suffix:semicolon
id|notify_ctrl.disconnect_indication
op_assign
id|irlan_client_disconnect_indication
suffix:semicolon
id|notify_ctrl.instance
op_assign
id|self
suffix:semicolon
id|strncpy
c_func
(paren
id|notify_ctrl.name
comma
l_string|&quot;IrLAN ctrl&quot;
comma
id|NOTIFY_MAX_NAME
)paren
suffix:semicolon
id|notify_data.data_indication
op_assign
id|irlan_eth_rx
suffix:semicolon
id|notify_data.udata_indication
op_assign
id|irlan_eth_rx
suffix:semicolon
id|notify_data.connect_confirm
op_assign
id|irlan_client_connect_confirm
suffix:semicolon
id|notify_data.flow_indication
op_assign
id|irlan_eth_flow_indication
suffix:semicolon
id|notify_data.disconnect_indication
op_assign
id|irlan_client_disconnect_indication
suffix:semicolon
id|notify_data.instance
op_assign
id|self
suffix:semicolon
id|strncpy
c_func
(paren
id|notify_data.name
comma
l_string|&quot;IrLAN data&quot;
comma
id|NOTIFY_MAX_NAME
)paren
suffix:semicolon
multiline_comment|/* Create TSAP&squot;s */
id|self-&gt;tsap_ctrl
op_assign
id|irttp_open_tsap
c_func
(paren
id|LSAP_ANY
comma
id|DEFAULT_INITIAL_CREDIT
comma
op_amp
id|notify_ctrl
)paren
suffix:semicolon
id|self-&gt;tsap_data
op_assign
id|irttp_open_tsap
c_func
(paren
id|LSAP_ANY
comma
id|DEFAULT_INITIAL_CREDIT
comma
op_amp
id|notify_data
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Function irlan_client_connect_confirm (handle, skb)&n; *&n; *    Connection to peer IrLAN laye confirmed&n; *&n; */
DECL|function|irlan_client_connect_confirm
r_void
id|irlan_client_connect_confirm
c_func
(paren
r_void
op_star
id|instance
comma
r_void
op_star
id|sap
comma
r_struct
id|qos_info
op_star
id|qos
comma
r_int
id|max_sdu_size
comma
r_struct
id|sk_buff
op_star
id|skb
)paren
(brace
r_struct
id|irlan_cb
op_star
id|self
suffix:semicolon
id|DEBUG
c_func
(paren
l_int|4
comma
id|__FUNCTION__
l_string|&quot;()&bslash;n&quot;
)paren
suffix:semicolon
id|self
op_assign
(paren
r_struct
id|irlan_cb
op_star
)paren
id|instance
suffix:semicolon
id|ASSERT
c_func
(paren
id|self
op_ne
l_int|NULL
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|self-&gt;magic
op_eq
id|IRLAN_MAGIC
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
multiline_comment|/* TODO: we could set the MTU depending on the max_sdu_size */
id|irlan_do_client_event
c_func
(paren
id|self
comma
id|IRLAN_CONNECT_COMPLETE
comma
l_int|NULL
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Function irlan_client_reconnect_data_channel (self)&n; *&n; *    Try to reconnect data channel (currently not used)&n; *&n; */
DECL|function|irlan_client_reconnect_data_channel
r_void
id|irlan_client_reconnect_data_channel
c_func
(paren
r_struct
id|irlan_cb
op_star
id|self
)paren
(brace
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
id|__u8
op_star
id|frame
suffix:semicolon
id|DEBUG
c_func
(paren
l_int|4
comma
id|__FUNCTION__
l_string|&quot;()&bslash;n&quot;
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|self
op_ne
l_int|NULL
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|self-&gt;magic
op_eq
id|IRLAN_MAGIC
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
id|skb
op_assign
id|dev_alloc_skb
c_func
(paren
l_int|128
)paren
suffix:semicolon
r_if
c_cond
(paren
id|skb
op_eq
l_int|NULL
)paren
(brace
id|DEBUG
c_func
(paren
l_int|0
comma
id|__FUNCTION__
l_string|&quot;(), Could not allocate an sk_buff of length %d&bslash;n&quot;
comma
l_int|64
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/* Reserve space for TTP, LMP, and LAP header */
id|skb_reserve
c_func
(paren
id|skb
comma
id|TTP_HEADER
op_plus
id|LMP_HEADER
op_plus
id|LAP_HEADER
)paren
suffix:semicolon
id|skb_put
c_func
(paren
id|skb
comma
l_int|2
)paren
suffix:semicolon
id|frame
op_assign
id|skb-&gt;data
suffix:semicolon
id|frame
(braket
l_int|0
)braket
op_assign
id|CMD_RECONNECT_DATA_CHAN
suffix:semicolon
id|frame
(braket
l_int|1
)braket
op_assign
l_int|0x01
suffix:semicolon
id|insert_array_param
c_func
(paren
id|skb
comma
l_string|&quot;RECONNECT_KEY&quot;
comma
id|self-&gt;t.client.reconnect_key
comma
id|self-&gt;t.client.key_len
)paren
suffix:semicolon
id|irttp_data_request
c_func
(paren
id|self-&gt;tsap_ctrl
comma
id|skb
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Function irlan_client_extract_params (skb)&n; *&n; *    Extract all parameters from received buffer, then feed them to &n; *    check_params for parsing&n; *&n; */
DECL|function|irlan_client_extract_params
r_void
id|irlan_client_extract_params
c_func
(paren
r_struct
id|irlan_cb
op_star
id|self
comma
r_struct
id|sk_buff
op_star
id|skb
)paren
(brace
id|__u8
op_star
id|frame
suffix:semicolon
id|__u8
op_star
id|ptr
suffix:semicolon
r_int
id|count
suffix:semicolon
r_int
id|ret
suffix:semicolon
r_int
id|val_len
suffix:semicolon
r_int
id|i
suffix:semicolon
id|ASSERT
c_func
(paren
id|skb
op_ne
l_int|NULL
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
id|DEBUG
c_func
(paren
l_int|4
comma
id|__FUNCTION__
l_string|&quot;() skb-&gt;len=%d&bslash;n&quot;
comma
(paren
r_int
)paren
id|skb-&gt;len
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|self
op_ne
l_int|NULL
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|self-&gt;magic
op_eq
id|IRLAN_MAGIC
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
r_if
c_cond
(paren
id|skb
op_eq
l_int|NULL
)paren
(brace
id|DEBUG
c_func
(paren
l_int|0
comma
id|__FUNCTION__
l_string|&quot;(), Got NULL skb!&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|frame
op_assign
id|skb-&gt;data
suffix:semicolon
multiline_comment|/* &n;&t; *  Check return code and print it if not success &n;&t; */
r_if
c_cond
(paren
id|frame
(braket
l_int|0
)braket
)paren
id|print_ret_code
c_func
(paren
id|frame
(braket
l_int|0
)braket
)paren
suffix:semicolon
multiline_comment|/* How many parameters? */
id|count
op_assign
id|frame
(braket
l_int|1
)braket
suffix:semicolon
id|DEBUG
c_func
(paren
l_int|4
comma
l_string|&quot;Got %d parameters&bslash;n&quot;
comma
id|count
)paren
suffix:semicolon
id|ptr
op_assign
id|frame
op_plus
l_int|2
suffix:semicolon
multiline_comment|/* For all parameters */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|count
suffix:semicolon
id|i
op_increment
)paren
(brace
id|ret
op_assign
id|irlan_get_response_param
c_func
(paren
id|ptr
comma
id|self-&gt;name
comma
id|self-&gt;value
comma
op_amp
id|val_len
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
op_eq
op_minus
l_int|1
)paren
(brace
id|DEBUG
c_func
(paren
l_int|0
comma
id|__FUNCTION__
l_string|&quot;(), IrLAN, Error!&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|ptr
op_add_assign
id|ret
suffix:semicolon
id|check_response_param
c_func
(paren
id|self
comma
id|self-&gt;name
comma
id|self-&gt;value
comma
id|val_len
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/*&n; * Function check_param (param, value)&n; *&n; *    Check which parameter is received and update local variables&n; *&n; */
DECL|function|check_response_param
r_void
id|check_response_param
c_func
(paren
r_struct
id|irlan_cb
op_star
id|self
comma
r_char
op_star
id|param
comma
r_char
op_star
id|value
comma
r_int
id|val_len
)paren
(brace
r_int
id|i
suffix:semicolon
id|__u8
op_star
id|bytes
suffix:semicolon
id|DEBUG
c_func
(paren
l_int|4
comma
id|__FUNCTION__
l_string|&quot;()&bslash;n&quot;
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|self
op_ne
l_int|NULL
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|self-&gt;magic
op_eq
id|IRLAN_MAGIC
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
multiline_comment|/*&n;&t; *  Media type&n;&t; */
r_if
c_cond
(paren
id|strcmp
c_func
(paren
id|param
comma
l_string|&quot;MEDIA&quot;
)paren
op_eq
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|strcmp
c_func
(paren
id|value
comma
l_string|&quot;802.3&quot;
)paren
op_eq
l_int|0
)paren
id|self-&gt;media
op_assign
id|MEDIA_802_3
suffix:semicolon
r_else
id|self-&gt;media
op_assign
id|MEDIA_802_5
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/*&n;&t; *  IRLAN version&n;&t; */
r_if
c_cond
(paren
id|strcmp
c_func
(paren
id|param
comma
l_string|&quot;IRLAN_VER&quot;
)paren
op_eq
l_int|0
)paren
(brace
id|DEBUG
c_func
(paren
l_int|4
comma
l_string|&quot;IrLAN version %d.%d&bslash;n&quot;
comma
(paren
id|__u8
)paren
id|value
(braket
l_int|0
)braket
comma
(paren
id|__u8
)paren
id|value
(braket
l_int|1
)braket
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/*&n;&t; *  Which remote TSAP to use for data channel&n;&t; */
r_if
c_cond
(paren
id|strcmp
c_func
(paren
id|param
comma
l_string|&quot;DATA_CHAN&quot;
)paren
op_eq
l_int|0
)paren
(brace
id|self-&gt;dtsap_sel_data
op_assign
id|value
(braket
l_int|0
)braket
suffix:semicolon
id|DEBUG
c_func
(paren
l_int|4
comma
l_string|&quot;Data TSAP = %02x&bslash;n&quot;
comma
id|self-&gt;dtsap_sel_data
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/*&n;&t; *  RECONNECT_KEY, in case the link goes down!&n;&t; */
r_if
c_cond
(paren
id|strcmp
c_func
(paren
id|param
comma
l_string|&quot;RECONNECT_KEY&quot;
)paren
op_eq
l_int|0
)paren
(brace
id|DEBUG
c_func
(paren
l_int|4
comma
l_string|&quot;Got reconnect key: &quot;
)paren
suffix:semicolon
multiline_comment|/* for (i = 0; i &lt; val_len; i++) */
multiline_comment|/* &t;&t;&t;printk( &quot;%02x&quot;, value[i]); */
id|memcpy
c_func
(paren
id|self-&gt;t.client.reconnect_key
comma
id|value
comma
id|val_len
)paren
suffix:semicolon
id|self-&gt;t.client.key_len
op_assign
id|val_len
suffix:semicolon
id|DEBUG
c_func
(paren
l_int|4
comma
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;&t; *  FILTER_ENTRY, have we got the ethernet address?&n;&t; */
r_if
c_cond
(paren
id|strcmp
c_func
(paren
id|param
comma
l_string|&quot;FILTER_ENTRY&quot;
)paren
op_eq
l_int|0
)paren
(brace
id|bytes
op_assign
id|value
suffix:semicolon
id|DEBUG
c_func
(paren
l_int|4
comma
l_string|&quot;Ethernet address = %02x:%02x:%02x:%02x:%02x:%02x&bslash;n&quot;
comma
id|bytes
(braket
l_int|0
)braket
comma
id|bytes
(braket
l_int|1
)braket
comma
id|bytes
(braket
l_int|2
)braket
comma
id|bytes
(braket
l_int|3
)braket
comma
id|bytes
(braket
l_int|4
)braket
comma
id|bytes
(braket
l_int|5
)braket
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|6
suffix:semicolon
id|i
op_increment
)paren
id|self-&gt;dev.dev_addr
(braket
id|i
)braket
op_assign
id|bytes
(braket
id|i
)braket
suffix:semicolon
macro_line|#if 0
multiline_comment|/*&n;&t; * When we get a new MAC address do a gratuitous ARP. This is useful&n;&t; * if we have changed access points on the same subnet.&n;&t; */
id|DEBUG
c_func
(paren
l_int|4
comma
l_string|&quot;IrLAN: Sending gratuitous ARP&bslash;n&quot;
)paren
suffix:semicolon
id|arp_send
c_func
(paren
id|ARPOP_REQUEST
comma
id|ETH_P_ARP
comma
id|self-&gt;dev.pa_addr
comma
op_amp
id|self-&gt;dev
comma
id|self-&gt;dev.pa_addr
comma
l_int|NULL
comma
id|self-&gt;dev.dev_addr
comma
l_int|NULL
)paren
suffix:semicolon
macro_line|#endif
)brace
)brace
multiline_comment|/*&n; * Function irlan_client_get_value_confirm (obj_id, value)&n; *&n; *    Got results from previous GetValueByClass request&n; *&n; */
DECL|function|irlan_client_get_value_confirm
r_void
id|irlan_client_get_value_confirm
c_func
(paren
id|__u16
id|obj_id
comma
r_struct
id|ias_value
op_star
id|value
comma
r_void
op_star
id|priv
)paren
(brace
r_struct
id|irlan_cb
op_star
id|self
suffix:semicolon
id|DEBUG
c_func
(paren
l_int|4
comma
id|__FUNCTION__
l_string|&quot;()&bslash;n&quot;
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|priv
op_ne
l_int|NULL
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
id|self
op_assign
(paren
r_struct
id|irlan_cb
op_star
)paren
id|priv
suffix:semicolon
id|ASSERT
c_func
(paren
id|self-&gt;magic
op_eq
id|IRLAN_MAGIC
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|value-&gt;type
)paren
(brace
r_case
id|IAS_INTEGER
suffix:colon
id|self-&gt;dtsap_sel_ctrl
op_assign
id|value-&gt;t.integer
suffix:semicolon
r_if
c_cond
(paren
id|value-&gt;t.integer
op_ne
op_minus
l_int|1
)paren
(brace
id|irlan_do_client_event
c_func
(paren
id|self
comma
id|IRLAN_IAS_PROVIDER_AVAIL
comma
l_int|NULL
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|IAS_STRING
suffix:colon
id|DEBUG
c_func
(paren
l_int|0
comma
id|__FUNCTION__
l_string|&quot;(), got string %s&bslash;n&quot;
comma
id|value-&gt;t.string
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|IAS_OCT_SEQ
suffix:colon
id|DEBUG
c_func
(paren
l_int|0
comma
id|__FUNCTION__
l_string|&quot;(), OCT_SEQ not implemented&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|IAS_MISSING
suffix:colon
id|DEBUG
c_func
(paren
l_int|0
comma
id|__FUNCTION__
l_string|&quot;(), MISSING not implemented&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|DEBUG
c_func
(paren
l_int|0
comma
id|__FUNCTION__
l_string|&quot;(), unknown type!&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|irlan_do_client_event
c_func
(paren
id|self
comma
id|IRLAN_IAS_PROVIDER_NOT_AVAIL
comma
l_int|NULL
)paren
suffix:semicolon
)brace
macro_line|#ifdef MODULE
id|MODULE_AUTHOR
c_func
(paren
l_string|&quot;Dag Brattli &lt;dagb@cs.uit.no&gt;&quot;
)paren
suffix:semicolon
id|MODULE_DESCRIPTION
c_func
(paren
l_string|&quot;The Linux IrDA LAN protocol&quot;
)paren
suffix:semicolon
multiline_comment|/*&n; * Function init_module (void)&n; *&n; *    Initialize the IrLAN module, this function is called by the&n; *    modprobe(1) program.&n; */
DECL|function|init_module
r_int
id|init_module
c_func
(paren
r_void
)paren
(brace
id|DEBUG
c_func
(paren
l_int|4
comma
id|__FUNCTION__
l_string|&quot;(), irlan_client.c&bslash;n&quot;
)paren
suffix:semicolon
id|irlan_client_init
c_func
(paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * Function cleanup_module (void)&n; *&n; *    Remove the IrLAN module, this function is called by the rmmod(1)&n; *    program&n; */
DECL|function|cleanup_module
r_void
id|cleanup_module
c_func
(paren
r_void
)paren
(brace
id|DEBUG
c_func
(paren
l_int|4
comma
l_string|&quot;--&gt; irlan, cleanup_module&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* No need to check MOD_IN_USE, as sys_delete_module() checks. */
multiline_comment|/* Free some memory */
id|irlan_client_cleanup
c_func
(paren
)paren
suffix:semicolon
id|DEBUG
c_func
(paren
l_int|4
comma
l_string|&quot;irlan, cleanup_module --&gt;&bslash;n&quot;
)paren
suffix:semicolon
)brace
macro_line|#endif /* MODULE */
eof
