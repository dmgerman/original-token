multiline_comment|/*********************************************************************&n; *                &n; * Filename:      irlap_frame.c&n; * Version:       1.0&n; * Description:   Build and transmit IrLAP frames&n; * Status:        Stable&n; * Author:        Dag Brattli &lt;dagb@cs.uit.no&gt;&n; * Created at:    Tue Aug 19 10:27:26 1997&n; * Modified at:   Wed Jan  5 08:59:04 2000&n; * Modified by:   Dag Brattli &lt;dagb@cs.uit.no&gt;&n; * &n; *     Copyright (c) 1998-2000 Dag Brattli &lt;dagb@cs.uit.no&gt;, &n; *     All Rights Reserved.&n; *     &n; *     This program is free software; you can redistribute it and/or &n; *     modify it under the terms of the GNU General Public License as &n; *     published by the Free Software Foundation; either version 2 of &n; *     the License, or (at your option) any later version.&n; *&n; *     Neither Dag Brattli nor University of Troms&#xfffd; admit liability nor&n; *     provide warranty for any of this software. This material is &n; *     provided &quot;AS-IS&quot; and at no charge.&n; *&n; ********************************************************************/
macro_line|#include &lt;linux/skbuff.h&gt;
macro_line|#include &lt;linux/if.h&gt;
macro_line|#include &lt;linux/if_ether.h&gt;
macro_line|#include &lt;linux/netdevice.h&gt;
macro_line|#include &lt;linux/irda.h&gt;
macro_line|#include &lt;net/pkt_sched.h&gt;
macro_line|#include &lt;net/sock.h&gt;
macro_line|#include &lt;asm/byteorder.h&gt;
macro_line|#include &lt;net/irda/irda.h&gt;
macro_line|#include &lt;net/irda/irda_device.h&gt;
macro_line|#include &lt;net/irda/irlap.h&gt;
macro_line|#include &lt;net/irda/wrapper.h&gt;
macro_line|#include &lt;net/irda/timer.h&gt;
macro_line|#include &lt;net/irda/irlap_frame.h&gt;
macro_line|#include &lt;net/irda/qos.h&gt;
multiline_comment|/*&n; * Function irlap_insert_info (self, skb)&n; *&n; *    Insert minimum turnaround time and speed information into the skb. We &n; *    need to do this since it&squot;s per packet relevant information. Safe to&n; *    have this function inlined since it&squot;s only called from one place&n; */
DECL|function|irlap_insert_info
r_static
r_inline
r_void
id|irlap_insert_info
c_func
(paren
r_struct
id|irlap_cb
op_star
id|self
comma
r_struct
id|sk_buff
op_star
id|skb
)paren
(brace
r_struct
id|irda_skb_cb
op_star
id|cb
op_assign
(paren
r_struct
id|irda_skb_cb
op_star
)paren
id|skb-&gt;cb
suffix:semicolon
multiline_comment|/*  &n;&t; * Insert MTT (min. turn time) and speed into skb, so that the&n;&t; * device driver knows which settings to use &n;&t; */
id|cb-&gt;magic
op_assign
id|LAP_MAGIC
suffix:semicolon
id|cb-&gt;mtt
op_assign
id|self-&gt;mtt_required
suffix:semicolon
id|cb-&gt;speed
op_assign
id|self-&gt;speed
suffix:semicolon
multiline_comment|/* Reset */
id|self-&gt;mtt_required
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* &n;&t; * Delay equals negotiated BOFs count, plus the number of BOFs to &n;&t; * force the negotiated minimum turnaround time &n;&t; */
id|cb-&gt;xbofs
op_assign
id|self-&gt;bofs_count
suffix:semicolon
id|cb-&gt;xbofs_delay
op_assign
id|self-&gt;xbofs_delay
suffix:semicolon
multiline_comment|/* Reset XBOF&squot;s delay (used only for getting min turn time) */
id|self-&gt;xbofs_delay
op_assign
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * Function irlap_queue_xmit (self, skb)&n; *&n; *    A little wrapper for dev_queue_xmit, so we can insert some common&n; *    code into it.&n; */
DECL|function|irlap_queue_xmit
r_void
id|irlap_queue_xmit
c_func
(paren
r_struct
id|irlap_cb
op_star
id|self
comma
r_struct
id|sk_buff
op_star
id|skb
)paren
(brace
multiline_comment|/* Some common init stuff */
id|skb-&gt;dev
op_assign
id|self-&gt;netdev
suffix:semicolon
id|skb-&gt;h.raw
op_assign
id|skb-&gt;nh.raw
op_assign
id|skb-&gt;mac.raw
op_assign
id|skb-&gt;data
suffix:semicolon
id|skb-&gt;protocol
op_assign
id|htons
c_func
(paren
id|ETH_P_IRDA
)paren
suffix:semicolon
id|skb-&gt;priority
op_assign
id|TC_PRIO_BESTEFFORT
suffix:semicolon
id|irlap_insert_info
c_func
(paren
id|self
comma
id|skb
)paren
suffix:semicolon
id|dev_queue_xmit
c_func
(paren
id|skb
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Function irlap_send_snrm_cmd (void)&n; *&n; *    Transmits a connect SNRM command frame&n; */
DECL|function|irlap_send_snrm_frame
r_void
id|irlap_send_snrm_frame
c_func
(paren
r_struct
id|irlap_cb
op_star
id|self
comma
r_struct
id|qos_info
op_star
id|qos
)paren
(brace
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
r_struct
id|snrm_frame
op_star
id|frame
suffix:semicolon
r_int
id|ret
suffix:semicolon
id|ASSERT
c_func
(paren
id|self
op_ne
l_int|NULL
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|self-&gt;magic
op_eq
id|LAP_MAGIC
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
multiline_comment|/* Allocate frame */
id|skb
op_assign
id|dev_alloc_skb
c_func
(paren
l_int|64
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|skb
)paren
r_return
suffix:semicolon
id|frame
op_assign
(paren
r_struct
id|snrm_frame
op_star
)paren
id|skb_put
c_func
(paren
id|skb
comma
l_int|2
)paren
suffix:semicolon
multiline_comment|/* Insert connection address field */
r_if
c_cond
(paren
id|qos
)paren
id|frame-&gt;caddr
op_assign
id|CMD_FRAME
op_or
id|CBROADCAST
suffix:semicolon
r_else
id|frame-&gt;caddr
op_assign
id|CMD_FRAME
op_or
id|self-&gt;caddr
suffix:semicolon
multiline_comment|/* Insert control field */
id|frame-&gt;control
op_assign
id|SNRM_CMD
op_or
id|PF_BIT
suffix:semicolon
multiline_comment|/*&n;&t; *  If we are establishing a connection then insert QoS paramerters &n;&t; */
r_if
c_cond
(paren
id|qos
)paren
(brace
id|skb_put
c_func
(paren
id|skb
comma
l_int|9
)paren
suffix:semicolon
multiline_comment|/* 21 left */
id|frame-&gt;saddr
op_assign
id|cpu_to_le32
c_func
(paren
id|self-&gt;saddr
)paren
suffix:semicolon
id|frame-&gt;daddr
op_assign
id|cpu_to_le32
c_func
(paren
id|self-&gt;daddr
)paren
suffix:semicolon
id|frame-&gt;ncaddr
op_assign
id|self-&gt;caddr
suffix:semicolon
id|ret
op_assign
id|irlap_insert_qos_negotiation_params
c_func
(paren
id|self
comma
id|skb
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
OL
l_int|0
)paren
(brace
id|dev_kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
)brace
id|irlap_queue_xmit
c_func
(paren
id|self
comma
id|skb
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Function irlap_recv_snrm_cmd (skb, info)&n; *&n; *    Received SNRM (Set Normal Response Mode) command frame&n; *&n; */
DECL|function|irlap_recv_snrm_cmd
r_static
r_void
id|irlap_recv_snrm_cmd
c_func
(paren
r_struct
id|irlap_cb
op_star
id|self
comma
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|irlap_info
op_star
id|info
)paren
(brace
r_struct
id|snrm_frame
op_star
id|frame
suffix:semicolon
id|frame
op_assign
(paren
r_struct
id|snrm_frame
op_star
)paren
id|skb-&gt;data
suffix:semicolon
r_if
c_cond
(paren
id|skb-&gt;len
op_ge
r_sizeof
(paren
r_struct
id|snrm_frame
)paren
)paren
(brace
multiline_comment|/* Copy the new connection address */
id|info-&gt;caddr
op_assign
id|frame-&gt;ncaddr
suffix:semicolon
multiline_comment|/* Check if the new connection address is valid */
r_if
c_cond
(paren
(paren
id|info-&gt;caddr
op_eq
l_int|0x00
)paren
op_logical_or
(paren
id|info-&gt;caddr
op_eq
l_int|0xfe
)paren
)paren
(brace
id|IRDA_DEBUG
c_func
(paren
l_int|3
comma
id|__FUNCTION__
l_string|&quot;(), invalid connection address!&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/* Copy peer device address */
id|info-&gt;daddr
op_assign
id|le32_to_cpu
c_func
(paren
id|frame-&gt;saddr
)paren
suffix:semicolon
id|info-&gt;saddr
op_assign
id|le32_to_cpu
c_func
(paren
id|frame-&gt;daddr
)paren
suffix:semicolon
multiline_comment|/* Only accept if addressed directly to us */
r_if
c_cond
(paren
id|info-&gt;saddr
op_ne
id|self-&gt;saddr
)paren
(brace
id|IRDA_DEBUG
c_func
(paren
l_int|2
comma
id|__FUNCTION__
l_string|&quot;(), not addressed to us!&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|irlap_do_event
c_func
(paren
id|self
comma
id|RECV_SNRM_CMD
comma
id|skb
comma
id|info
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* Signal that this SNRM frame does not contain and I-field */
id|irlap_do_event
c_func
(paren
id|self
comma
id|RECV_SNRM_CMD
comma
id|skb
comma
l_int|NULL
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/*&n; * Function irlap_send_ua_response_frame (qos)&n; *&n; *    Send UA (Unnumbered Acknowledgement) frame&n; *&n; */
DECL|function|irlap_send_ua_response_frame
r_void
id|irlap_send_ua_response_frame
c_func
(paren
r_struct
id|irlap_cb
op_star
id|self
comma
r_struct
id|qos_info
op_star
id|qos
)paren
(brace
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
r_struct
id|ua_frame
op_star
id|frame
suffix:semicolon
r_int
id|ret
suffix:semicolon
id|IRDA_DEBUG
c_func
(paren
l_int|2
comma
id|__FUNCTION__
l_string|&quot;() &lt;%ld&gt;&bslash;n&quot;
comma
id|jiffies
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|self
op_ne
l_int|NULL
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|self-&gt;magic
op_eq
id|LAP_MAGIC
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
id|skb
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/* Allocate frame */
id|skb
op_assign
id|dev_alloc_skb
c_func
(paren
l_int|64
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|skb
)paren
r_return
suffix:semicolon
id|frame
op_assign
(paren
r_struct
id|ua_frame
op_star
)paren
id|skb_put
c_func
(paren
id|skb
comma
l_int|10
)paren
suffix:semicolon
multiline_comment|/* Build UA response */
id|frame-&gt;caddr
op_assign
id|self-&gt;caddr
suffix:semicolon
id|frame-&gt;control
op_assign
id|UA_RSP
op_or
id|PF_BIT
suffix:semicolon
id|frame-&gt;saddr
op_assign
id|cpu_to_le32
c_func
(paren
id|self-&gt;saddr
)paren
suffix:semicolon
id|frame-&gt;daddr
op_assign
id|cpu_to_le32
c_func
(paren
id|self-&gt;daddr
)paren
suffix:semicolon
multiline_comment|/* Should we send QoS negotiation parameters? */
r_if
c_cond
(paren
id|qos
)paren
(brace
id|ret
op_assign
id|irlap_insert_qos_negotiation_params
c_func
(paren
id|self
comma
id|skb
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
OL
l_int|0
)paren
(brace
id|dev_kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
)brace
id|irlap_queue_xmit
c_func
(paren
id|self
comma
id|skb
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Function irlap_send_dm_frame (void)&n; *&n; *    Send disconnected mode (DM) frame&n; *&n; */
DECL|function|irlap_send_dm_frame
r_void
id|irlap_send_dm_frame
c_func
(paren
r_struct
id|irlap_cb
op_star
id|self
)paren
(brace
r_struct
id|sk_buff
op_star
id|skb
op_assign
l_int|NULL
suffix:semicolon
id|__u8
op_star
id|frame
suffix:semicolon
id|ASSERT
c_func
(paren
id|self
op_ne
l_int|NULL
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|self-&gt;magic
op_eq
id|LAP_MAGIC
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
id|skb
op_assign
id|dev_alloc_skb
c_func
(paren
l_int|32
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|skb
)paren
r_return
suffix:semicolon
id|frame
op_assign
id|skb_put
c_func
(paren
id|skb
comma
l_int|2
)paren
suffix:semicolon
r_if
c_cond
(paren
id|self-&gt;state
op_eq
id|LAP_NDM
)paren
id|frame
(braket
l_int|0
)braket
op_assign
id|CBROADCAST
suffix:semicolon
r_else
id|frame
(braket
l_int|0
)braket
op_assign
id|self-&gt;caddr
suffix:semicolon
id|frame
(braket
l_int|1
)braket
op_assign
id|DM_RSP
op_or
id|PF_BIT
suffix:semicolon
id|irlap_queue_xmit
c_func
(paren
id|self
comma
id|skb
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Function irlap_send_disc_frame (void)&n; *&n; *    Send disconnect (DISC) frame&n; *&n; */
DECL|function|irlap_send_disc_frame
r_void
id|irlap_send_disc_frame
c_func
(paren
r_struct
id|irlap_cb
op_star
id|self
)paren
(brace
r_struct
id|sk_buff
op_star
id|skb
op_assign
l_int|NULL
suffix:semicolon
id|__u8
op_star
id|frame
suffix:semicolon
id|IRDA_DEBUG
c_func
(paren
l_int|3
comma
id|__FUNCTION__
l_string|&quot;()&bslash;n&quot;
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|self
op_ne
l_int|NULL
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|self-&gt;magic
op_eq
id|LAP_MAGIC
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
id|skb
op_assign
id|dev_alloc_skb
c_func
(paren
l_int|16
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|skb
)paren
r_return
suffix:semicolon
id|frame
op_assign
id|skb_put
c_func
(paren
id|skb
comma
l_int|2
)paren
suffix:semicolon
id|frame
(braket
l_int|0
)braket
op_assign
id|self-&gt;caddr
op_or
id|CMD_FRAME
suffix:semicolon
id|frame
(braket
l_int|1
)braket
op_assign
id|DISC_CMD
op_or
id|PF_BIT
suffix:semicolon
id|irlap_queue_xmit
c_func
(paren
id|self
comma
id|skb
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Function irlap_send_discovery_xid_frame (S, s, command)&n; *&n; *    Build and transmit a XID (eXchange station IDentifier) discovery&n; *    frame. &n; */
DECL|function|irlap_send_discovery_xid_frame
r_void
id|irlap_send_discovery_xid_frame
c_func
(paren
r_struct
id|irlap_cb
op_star
id|self
comma
r_int
id|S
comma
id|__u8
id|s
comma
id|__u8
id|command
comma
id|discovery_t
op_star
id|discovery
)paren
(brace
r_struct
id|sk_buff
op_star
id|skb
op_assign
l_int|NULL
suffix:semicolon
r_struct
id|xid_frame
op_star
id|frame
suffix:semicolon
id|__u32
id|bcast
op_assign
id|BROADCAST
suffix:semicolon
id|__u8
op_star
id|info
suffix:semicolon
id|IRDA_DEBUG
c_func
(paren
l_int|4
comma
id|__FUNCTION__
l_string|&quot;(), s=%d, S=%d, command=%d&bslash;n&quot;
comma
id|s
comma
id|S
comma
id|command
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|self
op_ne
l_int|NULL
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|self-&gt;magic
op_eq
id|LAP_MAGIC
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|discovery
op_ne
l_int|NULL
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
id|skb
op_assign
id|dev_alloc_skb
c_func
(paren
l_int|64
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|skb
)paren
r_return
suffix:semicolon
id|skb_put
c_func
(paren
id|skb
comma
l_int|14
)paren
suffix:semicolon
id|frame
op_assign
(paren
r_struct
id|xid_frame
op_star
)paren
id|skb-&gt;data
suffix:semicolon
r_if
c_cond
(paren
id|command
)paren
(brace
id|frame-&gt;caddr
op_assign
id|CBROADCAST
op_or
id|CMD_FRAME
suffix:semicolon
id|frame-&gt;control
op_assign
id|XID_CMD
op_or
id|PF_BIT
suffix:semicolon
)brace
r_else
(brace
id|frame-&gt;caddr
op_assign
id|CBROADCAST
suffix:semicolon
id|frame-&gt;control
op_assign
id|XID_RSP
op_or
id|PF_BIT
suffix:semicolon
)brace
id|frame-&gt;ident
op_assign
id|XID_FORMAT
suffix:semicolon
id|frame-&gt;saddr
op_assign
id|cpu_to_le32
c_func
(paren
id|self-&gt;saddr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|command
)paren
id|frame-&gt;daddr
op_assign
id|cpu_to_le32
c_func
(paren
id|bcast
)paren
suffix:semicolon
r_else
id|frame-&gt;daddr
op_assign
id|cpu_to_le32
c_func
(paren
id|discovery-&gt;daddr
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|S
)paren
(brace
r_case
l_int|1
suffix:colon
id|frame-&gt;flags
op_assign
l_int|0x00
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|6
suffix:colon
id|frame-&gt;flags
op_assign
l_int|0x01
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|8
suffix:colon
id|frame-&gt;flags
op_assign
l_int|0x02
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|16
suffix:colon
id|frame-&gt;flags
op_assign
l_int|0x03
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|frame-&gt;flags
op_assign
l_int|0x02
suffix:semicolon
r_break
suffix:semicolon
)brace
id|frame-&gt;slotnr
op_assign
id|s
suffix:semicolon
id|frame-&gt;version
op_assign
l_int|0x00
suffix:semicolon
multiline_comment|/*  &n;&t; *  Provide info for final slot only in commands, and for all&n;&t; *  responses. Send the second byte of the hint only if the&n;&t; *  EXTENSION bit is set in the first byte.&n;&t; */
r_if
c_cond
(paren
op_logical_neg
id|command
op_logical_or
(paren
id|frame-&gt;slotnr
op_eq
l_int|0xff
)paren
)paren
(brace
r_int
id|len
suffix:semicolon
r_if
c_cond
(paren
id|discovery-&gt;hints.byte
(braket
l_int|0
)braket
op_amp
id|HINT_EXTENSION
)paren
(brace
id|info
op_assign
id|skb_put
c_func
(paren
id|skb
comma
l_int|2
)paren
suffix:semicolon
id|info
(braket
l_int|0
)braket
op_assign
id|discovery-&gt;hints.byte
(braket
l_int|0
)braket
suffix:semicolon
id|info
(braket
l_int|1
)braket
op_assign
id|discovery-&gt;hints.byte
(braket
l_int|1
)braket
suffix:semicolon
)brace
r_else
(brace
id|info
op_assign
id|skb_put
c_func
(paren
id|skb
comma
l_int|1
)paren
suffix:semicolon
id|info
(braket
l_int|0
)braket
op_assign
id|discovery-&gt;hints.byte
(braket
l_int|0
)braket
suffix:semicolon
)brace
id|info
op_assign
id|skb_put
c_func
(paren
id|skb
comma
l_int|1
)paren
suffix:semicolon
id|info
(braket
l_int|0
)braket
op_assign
id|discovery-&gt;charset
suffix:semicolon
id|len
op_assign
id|IRDA_MIN
c_func
(paren
id|discovery-&gt;name_len
comma
id|skb_tailroom
c_func
(paren
id|skb
)paren
)paren
suffix:semicolon
id|info
op_assign
id|skb_put
c_func
(paren
id|skb
comma
id|len
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|info
comma
id|discovery-&gt;nickname
comma
id|len
)paren
suffix:semicolon
)brace
id|irlap_queue_xmit
c_func
(paren
id|self
comma
id|skb
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Function irlap_recv_discovery_xid_rsp (skb, info)&n; *&n; *    Received a XID discovery response&n; *&n; */
DECL|function|irlap_recv_discovery_xid_rsp
r_static
r_void
id|irlap_recv_discovery_xid_rsp
c_func
(paren
r_struct
id|irlap_cb
op_star
id|self
comma
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|irlap_info
op_star
id|info
)paren
(brace
r_struct
id|xid_frame
op_star
id|xid
suffix:semicolon
id|discovery_t
op_star
id|discovery
op_assign
l_int|NULL
suffix:semicolon
id|__u8
op_star
id|discovery_info
suffix:semicolon
r_char
op_star
id|text
suffix:semicolon
id|IRDA_DEBUG
c_func
(paren
l_int|4
comma
id|__FUNCTION__
l_string|&quot;()&bslash;n&quot;
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|self
op_ne
l_int|NULL
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|self-&gt;magic
op_eq
id|LAP_MAGIC
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
id|xid
op_assign
(paren
r_struct
id|xid_frame
op_star
)paren
id|skb-&gt;data
suffix:semicolon
id|info-&gt;daddr
op_assign
id|le32_to_cpu
c_func
(paren
id|xid-&gt;saddr
)paren
suffix:semicolon
id|info-&gt;saddr
op_assign
id|le32_to_cpu
c_func
(paren
id|xid-&gt;daddr
)paren
suffix:semicolon
multiline_comment|/* Make sure frame is addressed to us */
r_if
c_cond
(paren
(paren
id|info-&gt;saddr
op_ne
id|self-&gt;saddr
)paren
op_logical_and
(paren
id|info-&gt;saddr
op_ne
id|BROADCAST
)paren
)paren
(brace
id|IRDA_DEBUG
c_func
(paren
l_int|0
comma
id|__FUNCTION__
l_string|&quot;(), frame is not addressed to us!&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|discovery
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
id|discovery_t
)paren
comma
id|GFP_ATOMIC
)paren
)paren
op_eq
l_int|NULL
)paren
(brace
id|WARNING
c_func
(paren
id|__FUNCTION__
l_string|&quot;(), kmalloc failed!&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|memset
c_func
(paren
id|discovery
comma
l_int|0
comma
r_sizeof
(paren
id|discovery_t
)paren
)paren
suffix:semicolon
id|discovery-&gt;daddr
op_assign
id|info-&gt;daddr
suffix:semicolon
id|discovery-&gt;saddr
op_assign
id|self-&gt;saddr
suffix:semicolon
id|discovery-&gt;timestamp
op_assign
id|jiffies
suffix:semicolon
id|IRDA_DEBUG
c_func
(paren
l_int|4
comma
id|__FUNCTION__
l_string|&quot;(), daddr=%08x&bslash;n&quot;
comma
id|discovery-&gt;daddr
)paren
suffix:semicolon
id|discovery_info
op_assign
id|skb_pull
c_func
(paren
id|skb
comma
r_sizeof
(paren
r_struct
id|xid_frame
)paren
)paren
suffix:semicolon
multiline_comment|/* Get info returned from peer */
id|discovery-&gt;hints.byte
(braket
l_int|0
)braket
op_assign
id|discovery_info
(braket
l_int|0
)braket
suffix:semicolon
r_if
c_cond
(paren
id|discovery_info
(braket
l_int|0
)braket
op_amp
id|HINT_EXTENSION
)paren
(brace
id|IRDA_DEBUG
c_func
(paren
l_int|4
comma
l_string|&quot;EXTENSION&bslash;n&quot;
)paren
suffix:semicolon
id|discovery-&gt;hints.byte
(braket
l_int|1
)braket
op_assign
id|discovery_info
(braket
l_int|1
)braket
suffix:semicolon
id|discovery-&gt;charset
op_assign
id|discovery_info
(braket
l_int|2
)braket
suffix:semicolon
id|text
op_assign
(paren
r_char
op_star
)paren
op_amp
id|discovery_info
(braket
l_int|3
)braket
suffix:semicolon
)brace
r_else
(brace
id|discovery-&gt;hints.byte
(braket
l_int|1
)braket
op_assign
l_int|0
suffix:semicolon
id|discovery-&gt;charset
op_assign
id|discovery_info
(braket
l_int|1
)braket
suffix:semicolon
id|text
op_assign
(paren
r_char
op_star
)paren
op_amp
id|discovery_info
(braket
l_int|2
)braket
suffix:semicolon
)brace
multiline_comment|/* &n;&t; *  Terminate info string, should be safe since this is where the &n;&t; *  FCS bytes resides.&n;&t; */
id|skb-&gt;data
(braket
id|skb-&gt;len
)braket
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
id|strncpy
c_func
(paren
id|discovery-&gt;nickname
comma
id|text
comma
id|NICKNAME_MAX_LEN
)paren
suffix:semicolon
id|discovery-&gt;name_len
op_assign
id|strlen
c_func
(paren
id|discovery-&gt;nickname
)paren
suffix:semicolon
id|info-&gt;discovery
op_assign
id|discovery
suffix:semicolon
id|irlap_do_event
c_func
(paren
id|self
comma
id|RECV_DISCOVERY_XID_RSP
comma
id|skb
comma
id|info
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Function irlap_recv_discovery_xid_cmd (skb, info)&n; *&n; *    Received a XID discovery command&n; *&n; */
DECL|function|irlap_recv_discovery_xid_cmd
r_static
r_void
id|irlap_recv_discovery_xid_cmd
c_func
(paren
r_struct
id|irlap_cb
op_star
id|self
comma
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|irlap_info
op_star
id|info
)paren
(brace
r_struct
id|xid_frame
op_star
id|xid
suffix:semicolon
id|discovery_t
op_star
id|discovery
op_assign
l_int|NULL
suffix:semicolon
id|__u8
op_star
id|discovery_info
suffix:semicolon
r_char
op_star
id|text
suffix:semicolon
id|xid
op_assign
(paren
r_struct
id|xid_frame
op_star
)paren
id|skb-&gt;data
suffix:semicolon
id|info-&gt;daddr
op_assign
id|le32_to_cpu
c_func
(paren
id|xid-&gt;saddr
)paren
suffix:semicolon
id|info-&gt;saddr
op_assign
id|le32_to_cpu
c_func
(paren
id|xid-&gt;daddr
)paren
suffix:semicolon
multiline_comment|/* Make sure frame is addressed to us */
r_if
c_cond
(paren
(paren
id|info-&gt;saddr
op_ne
id|self-&gt;saddr
)paren
op_logical_and
(paren
id|info-&gt;saddr
op_ne
id|BROADCAST
)paren
)paren
(brace
id|IRDA_DEBUG
c_func
(paren
l_int|0
comma
id|__FUNCTION__
l_string|&quot;(), frame is not addressed to us!&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_switch
c_cond
(paren
id|xid-&gt;flags
op_amp
l_int|0x03
)paren
(brace
r_case
l_int|0x00
suffix:colon
id|info-&gt;S
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x01
suffix:colon
id|info-&gt;S
op_assign
l_int|6
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x02
suffix:colon
id|info-&gt;S
op_assign
l_int|8
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x03
suffix:colon
id|info-&gt;S
op_assign
l_int|16
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
multiline_comment|/* Error!! */
id|dev_kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|info-&gt;s
op_assign
id|xid-&gt;slotnr
suffix:semicolon
id|discovery_info
op_assign
id|skb_pull
c_func
(paren
id|skb
comma
r_sizeof
(paren
r_struct
id|xid_frame
)paren
)paren
suffix:semicolon
multiline_comment|/* &n;&t; *  Check if last frame &n;&t; */
r_if
c_cond
(paren
id|info-&gt;s
op_eq
l_int|0xff
)paren
(brace
multiline_comment|/* Check if things are sane at this point... */
r_if
c_cond
(paren
(paren
id|discovery_info
op_eq
l_int|NULL
)paren
op_logical_or
(paren
id|skb-&gt;len
OL
l_int|3
)paren
)paren
(brace
id|ERROR
c_func
(paren
id|__FUNCTION__
l_string|&quot;(), discovery frame to short!&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/*&n;&t;&t; *  We now have some discovery info to deliver!&n;&t;&t; */
id|discovery
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
id|discovery_t
)paren
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|discovery
)paren
(brace
id|WARNING
c_func
(paren
id|__FUNCTION__
l_string|&quot;(), unable to malloc!&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|discovery-&gt;daddr
op_assign
id|info-&gt;daddr
suffix:semicolon
id|discovery-&gt;saddr
op_assign
id|self-&gt;saddr
suffix:semicolon
id|discovery-&gt;timestamp
op_assign
id|jiffies
suffix:semicolon
id|discovery-&gt;hints.byte
(braket
l_int|0
)braket
op_assign
id|discovery_info
(braket
l_int|0
)braket
suffix:semicolon
r_if
c_cond
(paren
id|discovery_info
(braket
l_int|0
)braket
op_amp
id|HINT_EXTENSION
)paren
(brace
id|discovery-&gt;hints.byte
(braket
l_int|1
)braket
op_assign
id|discovery_info
(braket
l_int|1
)braket
suffix:semicolon
id|discovery-&gt;charset
op_assign
id|discovery_info
(braket
l_int|2
)braket
suffix:semicolon
id|text
op_assign
(paren
r_char
op_star
)paren
op_amp
id|discovery_info
(braket
l_int|3
)braket
suffix:semicolon
)brace
r_else
(brace
id|discovery-&gt;hints.byte
(braket
l_int|1
)braket
op_assign
l_int|0
suffix:semicolon
id|discovery-&gt;charset
op_assign
id|discovery_info
(braket
l_int|1
)braket
suffix:semicolon
id|text
op_assign
(paren
r_char
op_star
)paren
op_amp
id|discovery_info
(braket
l_int|2
)braket
suffix:semicolon
)brace
multiline_comment|/* &n;&t;&t; *  Terminate string, should be safe since this is where the &n;&t;&t; *  FCS bytes resides.&n;&t;&t; */
id|skb-&gt;data
(braket
id|skb-&gt;len
)braket
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
id|strncpy
c_func
(paren
id|discovery-&gt;nickname
comma
id|text
comma
id|NICKNAME_MAX_LEN
)paren
suffix:semicolon
id|discovery-&gt;name_len
op_assign
id|strlen
c_func
(paren
id|discovery-&gt;nickname
)paren
suffix:semicolon
id|info-&gt;discovery
op_assign
id|discovery
suffix:semicolon
)brace
r_else
id|info-&gt;discovery
op_assign
l_int|NULL
suffix:semicolon
id|irlap_do_event
c_func
(paren
id|self
comma
id|RECV_DISCOVERY_XID_CMD
comma
id|skb
comma
id|info
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Function irlap_send_rr_frame (self, command)&n; *&n; *    Build and transmit RR (Receive Ready) frame. Notice that it is currently&n; *    only possible to send RR frames with the poll bit set.&n; */
DECL|function|irlap_send_rr_frame
r_void
id|irlap_send_rr_frame
c_func
(paren
r_struct
id|irlap_cb
op_star
id|self
comma
r_int
id|command
)paren
(brace
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
id|__u8
op_star
id|frame
suffix:semicolon
id|skb
op_assign
id|dev_alloc_skb
c_func
(paren
l_int|16
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|skb
)paren
r_return
suffix:semicolon
id|frame
op_assign
id|skb_put
c_func
(paren
id|skb
comma
l_int|2
)paren
suffix:semicolon
id|frame
(braket
l_int|0
)braket
op_assign
id|self-&gt;caddr
suffix:semicolon
id|frame
(braket
l_int|0
)braket
op_or_assign
(paren
id|command
)paren
ques
c_cond
id|CMD_FRAME
suffix:colon
l_int|0
suffix:semicolon
id|frame
(braket
l_int|1
)braket
op_assign
id|RR
op_or
id|PF_BIT
op_or
(paren
id|self-&gt;vr
op_lshift
l_int|5
)paren
suffix:semicolon
id|irlap_queue_xmit
c_func
(paren
id|self
comma
id|skb
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Function irlap_send_rd_frame (self)&n; *&n; *    Request disconnect. Used by a secondary station to request the &n; *    disconnection of the link.&n; */
DECL|function|irlap_send_rd_frame
r_void
id|irlap_send_rd_frame
c_func
(paren
r_struct
id|irlap_cb
op_star
id|self
)paren
(brace
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
id|__u8
op_star
id|frame
suffix:semicolon
id|skb
op_assign
id|dev_alloc_skb
c_func
(paren
l_int|16
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|skb
)paren
r_return
suffix:semicolon
id|frame
op_assign
id|skb_put
c_func
(paren
id|skb
comma
l_int|2
)paren
suffix:semicolon
id|frame
(braket
l_int|0
)braket
op_assign
id|self-&gt;caddr
suffix:semicolon
id|frame
(braket
l_int|1
)braket
op_assign
id|RD_RSP
op_or
id|PF_BIT
suffix:semicolon
id|irlap_queue_xmit
c_func
(paren
id|self
comma
id|skb
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Function irlap_recv_rr_frame (skb, info)&n; *&n; *    Received RR (Receive Ready) frame from peer station, no harm in&n; *    making it inline since its called only from one single place&n; *    (irlap_driver_rcv).&n; */
DECL|function|irlap_recv_rr_frame
r_static
r_inline
r_void
id|irlap_recv_rr_frame
c_func
(paren
r_struct
id|irlap_cb
op_star
id|self
comma
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|irlap_info
op_star
id|info
comma
r_int
id|command
)paren
(brace
id|info-&gt;nr
op_assign
id|skb-&gt;data
(braket
l_int|1
)braket
op_rshift
l_int|5
suffix:semicolon
multiline_comment|/* Check if this is a command or a response frame */
r_if
c_cond
(paren
id|command
)paren
id|irlap_do_event
c_func
(paren
id|self
comma
id|RECV_RR_CMD
comma
id|skb
comma
id|info
)paren
suffix:semicolon
r_else
id|irlap_do_event
c_func
(paren
id|self
comma
id|RECV_RR_RSP
comma
id|skb
comma
id|info
)paren
suffix:semicolon
)brace
DECL|function|irlap_send_frmr_frame
r_void
id|irlap_send_frmr_frame
c_func
(paren
r_struct
id|irlap_cb
op_star
id|self
comma
r_int
id|command
)paren
(brace
r_struct
id|sk_buff
op_star
id|skb
op_assign
l_int|NULL
suffix:semicolon
id|__u8
op_star
id|frame
suffix:semicolon
id|ASSERT
c_func
(paren
id|self
op_ne
l_int|NULL
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|self-&gt;magic
op_eq
id|LAP_MAGIC
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
id|skb
op_assign
id|dev_alloc_skb
c_func
(paren
l_int|32
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|skb
)paren
r_return
suffix:semicolon
id|frame
op_assign
id|skb_put
c_func
(paren
id|skb
comma
l_int|2
)paren
suffix:semicolon
id|frame
(braket
l_int|0
)braket
op_assign
id|self-&gt;caddr
suffix:semicolon
id|frame
(braket
l_int|0
)braket
op_or_assign
(paren
id|command
)paren
ques
c_cond
id|CMD_FRAME
suffix:colon
l_int|0
suffix:semicolon
id|frame
(braket
l_int|1
)braket
op_assign
(paren
id|self-&gt;vs
op_lshift
l_int|1
)paren
suffix:semicolon
id|frame
(braket
l_int|1
)braket
op_or_assign
id|PF_BIT
suffix:semicolon
id|frame
(braket
l_int|1
)braket
op_or_assign
(paren
id|self-&gt;vr
op_lshift
l_int|5
)paren
suffix:semicolon
id|frame
(braket
l_int|2
)braket
op_assign
l_int|0
suffix:semicolon
id|IRDA_DEBUG
c_func
(paren
l_int|4
comma
id|__FUNCTION__
l_string|&quot;(), vr=%d, %ld&bslash;n&quot;
comma
id|self-&gt;vr
comma
id|jiffies
)paren
suffix:semicolon
id|irlap_queue_xmit
c_func
(paren
id|self
comma
id|skb
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Function irlap_recv_rnr_frame (self, skb, info)&n; *&n; *    Received RNR (Receive Not Ready) frame from peer station&n; *&n; */
DECL|function|irlap_recv_rnr_frame
r_static
r_void
id|irlap_recv_rnr_frame
c_func
(paren
r_struct
id|irlap_cb
op_star
id|self
comma
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|irlap_info
op_star
id|info
comma
r_int
id|command
)paren
(brace
id|info-&gt;nr
op_assign
id|skb-&gt;data
(braket
l_int|1
)braket
op_rshift
l_int|5
suffix:semicolon
id|IRDA_DEBUG
c_func
(paren
l_int|4
comma
id|__FUNCTION__
l_string|&quot;(), nr=%d, %ld&bslash;n&quot;
comma
id|info-&gt;nr
comma
id|jiffies
)paren
suffix:semicolon
r_if
c_cond
(paren
id|command
)paren
id|irlap_do_event
c_func
(paren
id|self
comma
id|RECV_RNR_CMD
comma
id|skb
comma
id|info
)paren
suffix:semicolon
r_else
id|irlap_do_event
c_func
(paren
id|self
comma
id|RECV_RNR_RSP
comma
id|skb
comma
id|info
)paren
suffix:semicolon
)brace
DECL|function|irlap_recv_rej_frame
r_static
r_void
id|irlap_recv_rej_frame
c_func
(paren
r_struct
id|irlap_cb
op_star
id|self
comma
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|irlap_info
op_star
id|info
comma
r_int
id|command
)paren
(brace
id|IRDA_DEBUG
c_func
(paren
l_int|0
comma
id|__FUNCTION__
l_string|&quot;()&bslash;n&quot;
)paren
suffix:semicolon
id|info-&gt;nr
op_assign
id|skb-&gt;data
(braket
l_int|1
)braket
op_rshift
l_int|5
suffix:semicolon
multiline_comment|/* Check if this is a command or a response frame */
r_if
c_cond
(paren
id|command
)paren
id|irlap_do_event
c_func
(paren
id|self
comma
id|RECV_REJ_CMD
comma
id|skb
comma
id|info
)paren
suffix:semicolon
r_else
id|irlap_do_event
c_func
(paren
id|self
comma
id|RECV_REJ_RSP
comma
id|skb
comma
id|info
)paren
suffix:semicolon
)brace
DECL|function|irlap_recv_srej_frame
r_static
r_void
id|irlap_recv_srej_frame
c_func
(paren
r_struct
id|irlap_cb
op_star
id|self
comma
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|irlap_info
op_star
id|info
comma
r_int
id|command
)paren
(brace
id|IRDA_DEBUG
c_func
(paren
l_int|0
comma
id|__FUNCTION__
l_string|&quot;()&bslash;n&quot;
)paren
suffix:semicolon
id|info-&gt;nr
op_assign
id|skb-&gt;data
(braket
l_int|1
)braket
op_rshift
l_int|5
suffix:semicolon
multiline_comment|/* Check if this is a command or a response frame */
r_if
c_cond
(paren
id|command
)paren
id|irlap_do_event
c_func
(paren
id|self
comma
id|RECV_SREJ_CMD
comma
id|skb
comma
id|info
)paren
suffix:semicolon
r_else
id|irlap_do_event
c_func
(paren
id|self
comma
id|RECV_SREJ_RSP
comma
id|skb
comma
id|info
)paren
suffix:semicolon
)brace
DECL|function|irlap_recv_disc_frame
r_static
r_void
id|irlap_recv_disc_frame
c_func
(paren
r_struct
id|irlap_cb
op_star
id|self
comma
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|irlap_info
op_star
id|info
comma
r_int
id|command
)paren
(brace
id|IRDA_DEBUG
c_func
(paren
l_int|0
comma
id|__FUNCTION__
l_string|&quot;()&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* Check if this is a command or a response frame */
r_if
c_cond
(paren
id|command
)paren
id|irlap_do_event
c_func
(paren
id|self
comma
id|RECV_DISC_CMD
comma
id|skb
comma
id|info
)paren
suffix:semicolon
r_else
id|irlap_do_event
c_func
(paren
id|self
comma
id|RECV_RD_RSP
comma
id|skb
comma
id|info
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Function irlap_recv_ua_frame (skb, frame)&n; *&n; *    Received UA (Unnumbered Acknowledgement) frame&n; *&n; */
DECL|function|irlap_recv_ua_frame
r_static
r_inline
r_void
id|irlap_recv_ua_frame
c_func
(paren
r_struct
id|irlap_cb
op_star
id|self
comma
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|irlap_info
op_star
id|info
)paren
(brace
id|irlap_do_event
c_func
(paren
id|self
comma
id|RECV_UA_RSP
comma
id|skb
comma
id|info
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Function irlap_send_data_primary(self, skb)&n; *&n; *    Send I-frames as the primary station but without the poll bit set&n; *&n; */
DECL|function|irlap_send_data_primary
r_void
id|irlap_send_data_primary
c_func
(paren
r_struct
id|irlap_cb
op_star
id|self
comma
r_struct
id|sk_buff
op_star
id|skb
)paren
(brace
r_struct
id|sk_buff
op_star
id|tx_skb
suffix:semicolon
r_if
c_cond
(paren
id|skb-&gt;data
(braket
l_int|1
)braket
op_eq
id|I_FRAME
)paren
(brace
multiline_comment|/*  &n;&t;&t; *  Insert frame sequence number (Vs) in control field before&n;&t;&t; *  inserting into transmit window queue.&n;&t;&t; */
id|skb-&gt;data
(braket
l_int|1
)braket
op_assign
id|I_FRAME
op_or
(paren
id|self-&gt;vs
op_lshift
l_int|1
)paren
suffix:semicolon
multiline_comment|/* Copy buffer */
id|tx_skb
op_assign
id|skb_clone
c_func
(paren
id|skb
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tx_skb
op_eq
l_int|NULL
)paren
(brace
r_return
suffix:semicolon
)brace
multiline_comment|/*&n;&t;&t; *  make sure the skb-&gt;sk accounting of memory usage is sane&n;&t;&t; */
r_if
c_cond
(paren
id|skb-&gt;sk
op_ne
l_int|NULL
)paren
id|skb_set_owner_w
c_func
(paren
id|tx_skb
comma
id|skb-&gt;sk
)paren
suffix:semicolon
multiline_comment|/* &n;&t;&t; *  Insert frame in store, in case of retransmissions &n;&t;&t; */
id|skb_queue_tail
c_func
(paren
op_amp
id|self-&gt;wx_list
comma
id|skb_get
c_func
(paren
id|skb
)paren
)paren
suffix:semicolon
id|self-&gt;vs
op_assign
(paren
id|self-&gt;vs
op_plus
l_int|1
)paren
op_mod
l_int|8
suffix:semicolon
id|self-&gt;ack_required
op_assign
id|FALSE
suffix:semicolon
id|self-&gt;window
op_sub_assign
l_int|1
suffix:semicolon
id|irlap_send_i_frame
c_func
(paren
id|self
comma
id|tx_skb
comma
id|CMD_FRAME
)paren
suffix:semicolon
)brace
r_else
(brace
id|IRDA_DEBUG
c_func
(paren
l_int|4
comma
id|__FUNCTION__
l_string|&quot;(), sending unreliable frame&bslash;n&quot;
)paren
suffix:semicolon
id|irlap_send_ui_frame
c_func
(paren
id|self
comma
id|skb_get
c_func
(paren
id|skb
)paren
comma
id|self-&gt;caddr
comma
id|CMD_FRAME
)paren
suffix:semicolon
id|self-&gt;window
op_sub_assign
l_int|1
suffix:semicolon
)brace
)brace
multiline_comment|/*&n; * Function irlap_send_data_primary_poll (self, skb)&n; *&n; *    Send I(nformation) frame as primary with poll bit set&n; */
DECL|function|irlap_send_data_primary_poll
r_void
id|irlap_send_data_primary_poll
c_func
(paren
r_struct
id|irlap_cb
op_star
id|self
comma
r_struct
id|sk_buff
op_star
id|skb
)paren
(brace
r_struct
id|sk_buff
op_star
id|tx_skb
suffix:semicolon
multiline_comment|/* Is this reliable or unreliable data? */
r_if
c_cond
(paren
id|skb-&gt;data
(braket
l_int|1
)braket
op_eq
id|I_FRAME
)paren
(brace
multiline_comment|/*  &n;&t;&t; *  Insert frame sequence number (Vs) in control field before&n;&t;&t; *  inserting into transmit window queue.&n;&t;&t; */
id|skb-&gt;data
(braket
l_int|1
)braket
op_assign
id|I_FRAME
op_or
(paren
id|self-&gt;vs
op_lshift
l_int|1
)paren
suffix:semicolon
multiline_comment|/* Copy buffer */
id|tx_skb
op_assign
id|skb_clone
c_func
(paren
id|skb
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tx_skb
op_eq
l_int|NULL
)paren
(brace
r_return
suffix:semicolon
)brace
multiline_comment|/*&n;&t;&t; *  make sure the skb-&gt;sk accounting of memory usage is sane&n;&t;&t; */
r_if
c_cond
(paren
id|skb-&gt;sk
op_ne
l_int|NULL
)paren
id|skb_set_owner_w
c_func
(paren
id|tx_skb
comma
id|skb-&gt;sk
)paren
suffix:semicolon
multiline_comment|/* &n;&t;&t; *  Insert frame in store, in case of retransmissions &n;&t;&t; */
id|skb_queue_tail
c_func
(paren
op_amp
id|self-&gt;wx_list
comma
id|skb_get
c_func
(paren
id|skb
)paren
)paren
suffix:semicolon
multiline_comment|/*  &n;&t;&t; *  Set poll bit if necessary. We do this to the copied&n;&t;&t; *  skb, since retransmitted need to set or clear the poll&n;&t;&t; *  bit depending on when they are sent.  &n;&t;&t; */
multiline_comment|/* Stop P timer */
id|del_timer
c_func
(paren
op_amp
id|self-&gt;poll_timer
)paren
suffix:semicolon
id|tx_skb-&gt;data
(braket
l_int|1
)braket
op_or_assign
id|PF_BIT
suffix:semicolon
id|self-&gt;vs
op_assign
(paren
id|self-&gt;vs
op_plus
l_int|1
)paren
op_mod
l_int|8
suffix:semicolon
id|self-&gt;ack_required
op_assign
id|FALSE
suffix:semicolon
id|self-&gt;window
op_assign
id|self-&gt;window_size
suffix:semicolon
id|irlap_start_final_timer
c_func
(paren
id|self
comma
id|self-&gt;final_timeout
)paren
suffix:semicolon
id|irlap_send_i_frame
c_func
(paren
id|self
comma
id|tx_skb
comma
id|CMD_FRAME
)paren
suffix:semicolon
)brace
r_else
(brace
id|IRDA_DEBUG
c_func
(paren
l_int|4
comma
id|__FUNCTION__
l_string|&quot;(), sending unreliable frame&bslash;n&quot;
)paren
suffix:semicolon
id|del_timer
c_func
(paren
op_amp
id|self-&gt;poll_timer
)paren
suffix:semicolon
r_if
c_cond
(paren
id|self-&gt;ack_required
)paren
(brace
id|irlap_send_ui_frame
c_func
(paren
id|self
comma
id|skb_get
c_func
(paren
id|skb
)paren
comma
id|self-&gt;caddr
comma
id|CMD_FRAME
)paren
suffix:semicolon
id|irlap_send_rr_frame
c_func
(paren
id|self
comma
id|CMD_FRAME
)paren
suffix:semicolon
id|self-&gt;ack_required
op_assign
id|FALSE
suffix:semicolon
)brace
r_else
(brace
id|skb-&gt;data
(braket
l_int|1
)braket
op_or_assign
id|PF_BIT
suffix:semicolon
id|irlap_send_ui_frame
c_func
(paren
id|self
comma
id|skb_get
c_func
(paren
id|skb
)paren
comma
id|self-&gt;caddr
comma
id|CMD_FRAME
)paren
suffix:semicolon
)brace
id|self-&gt;window
op_assign
id|self-&gt;window_size
suffix:semicolon
id|irlap_start_final_timer
c_func
(paren
id|self
comma
id|self-&gt;final_timeout
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/*&n; * Function irlap_send_data_secondary_final (self, skb)&n; *&n; *    Send I(nformation) frame as secondary with final bit set&n; *&n; */
DECL|function|irlap_send_data_secondary_final
r_void
id|irlap_send_data_secondary_final
c_func
(paren
r_struct
id|irlap_cb
op_star
id|self
comma
r_struct
id|sk_buff
op_star
id|skb
)paren
(brace
r_struct
id|sk_buff
op_star
id|tx_skb
op_assign
l_int|NULL
suffix:semicolon
id|ASSERT
c_func
(paren
id|self
op_ne
l_int|NULL
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|self-&gt;magic
op_eq
id|LAP_MAGIC
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|skb
op_ne
l_int|NULL
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
multiline_comment|/* Is this reliable or unreliable data? */
r_if
c_cond
(paren
id|skb-&gt;data
(braket
l_int|1
)braket
op_eq
id|I_FRAME
)paren
(brace
multiline_comment|/*  &n;&t;&t; *  Insert frame sequence number (Vs) in control field before&n;&t;&t; *  inserting into transmit window queue.&n;&t;&t; */
id|skb-&gt;data
(braket
l_int|1
)braket
op_assign
id|I_FRAME
op_or
(paren
id|self-&gt;vs
op_lshift
l_int|1
)paren
suffix:semicolon
id|tx_skb
op_assign
id|skb_clone
c_func
(paren
id|skb
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tx_skb
op_eq
l_int|NULL
)paren
(brace
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|skb-&gt;sk
op_ne
l_int|NULL
)paren
id|skb_set_owner_w
c_func
(paren
id|tx_skb
comma
id|skb-&gt;sk
)paren
suffix:semicolon
multiline_comment|/* Insert frame in store */
id|skb_queue_tail
c_func
(paren
op_amp
id|self-&gt;wx_list
comma
id|skb_get
c_func
(paren
id|skb
)paren
)paren
suffix:semicolon
id|tx_skb-&gt;data
(braket
l_int|1
)braket
op_or_assign
id|PF_BIT
suffix:semicolon
id|self-&gt;vs
op_assign
(paren
id|self-&gt;vs
op_plus
l_int|1
)paren
op_mod
l_int|8
suffix:semicolon
id|self-&gt;window
op_assign
id|self-&gt;window_size
suffix:semicolon
id|self-&gt;ack_required
op_assign
id|FALSE
suffix:semicolon
id|irlap_start_wd_timer
c_func
(paren
id|self
comma
id|self-&gt;wd_timeout
)paren
suffix:semicolon
id|irlap_send_i_frame
c_func
(paren
id|self
comma
id|tx_skb
comma
id|RSP_FRAME
)paren
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|self-&gt;ack_required
)paren
(brace
id|irlap_send_ui_frame
c_func
(paren
id|self
comma
id|skb_get
c_func
(paren
id|skb
)paren
comma
id|self-&gt;caddr
comma
id|RSP_FRAME
)paren
suffix:semicolon
id|irlap_send_rr_frame
c_func
(paren
id|self
comma
id|RSP_FRAME
)paren
suffix:semicolon
id|self-&gt;ack_required
op_assign
id|FALSE
suffix:semicolon
)brace
r_else
(brace
id|skb-&gt;data
(braket
l_int|1
)braket
op_or_assign
id|PF_BIT
suffix:semicolon
id|irlap_send_ui_frame
c_func
(paren
id|self
comma
id|skb_get
c_func
(paren
id|skb
)paren
comma
id|self-&gt;caddr
comma
id|RSP_FRAME
)paren
suffix:semicolon
)brace
id|self-&gt;window
op_assign
id|self-&gt;window_size
suffix:semicolon
id|irlap_start_wd_timer
c_func
(paren
id|self
comma
id|self-&gt;wd_timeout
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/*&n; * Function irlap_send_data_secondary (self, skb)&n; *&n; *    Send I(nformation) frame as secondary without final bit set&n; *&n; */
DECL|function|irlap_send_data_secondary
r_void
id|irlap_send_data_secondary
c_func
(paren
r_struct
id|irlap_cb
op_star
id|self
comma
r_struct
id|sk_buff
op_star
id|skb
)paren
(brace
r_struct
id|sk_buff
op_star
id|tx_skb
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/* Is this reliable or unreliable data? */
r_if
c_cond
(paren
id|skb-&gt;data
(braket
l_int|1
)braket
op_eq
id|I_FRAME
)paren
(brace
multiline_comment|/*  &n;&t;&t; *  Insert frame sequence number (Vs) in control field before&n;&t;&t; *  inserting into transmit window queue.&n;&t;&t; */
id|skb-&gt;data
(braket
l_int|1
)braket
op_assign
id|I_FRAME
op_or
(paren
id|self-&gt;vs
op_lshift
l_int|1
)paren
suffix:semicolon
id|tx_skb
op_assign
id|skb_clone
c_func
(paren
id|skb
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tx_skb
op_eq
l_int|NULL
)paren
(brace
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|skb-&gt;sk
op_ne
l_int|NULL
)paren
id|skb_set_owner_w
c_func
(paren
id|tx_skb
comma
id|skb-&gt;sk
)paren
suffix:semicolon
multiline_comment|/* Insert frame in store */
id|skb_queue_tail
c_func
(paren
op_amp
id|self-&gt;wx_list
comma
id|skb_get
c_func
(paren
id|skb
)paren
)paren
suffix:semicolon
id|self-&gt;vs
op_assign
(paren
id|self-&gt;vs
op_plus
l_int|1
)paren
op_mod
l_int|8
suffix:semicolon
id|self-&gt;ack_required
op_assign
id|FALSE
suffix:semicolon
id|self-&gt;window
op_sub_assign
l_int|1
suffix:semicolon
id|irlap_send_i_frame
c_func
(paren
id|self
comma
id|tx_skb
comma
id|RSP_FRAME
)paren
suffix:semicolon
)brace
r_else
(brace
id|irlap_send_ui_frame
c_func
(paren
id|self
comma
id|skb_get
c_func
(paren
id|skb
)paren
comma
id|self-&gt;caddr
comma
id|RSP_FRAME
)paren
suffix:semicolon
id|self-&gt;window
op_sub_assign
l_int|1
suffix:semicolon
)brace
)brace
multiline_comment|/*&n; * Function irlap_resend_rejected_frames (nr)&n; *&n; *    Resend frames which has not been acknowledged. Should be safe to &n; *    traverse the list without locking it since this function will only be &n; *    called from interrupt context (BH)&n; */
DECL|function|irlap_resend_rejected_frames
r_void
id|irlap_resend_rejected_frames
c_func
(paren
r_struct
id|irlap_cb
op_star
id|self
comma
r_int
id|command
)paren
(brace
r_struct
id|sk_buff
op_star
id|tx_skb
suffix:semicolon
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
r_int
id|count
suffix:semicolon
id|ASSERT
c_func
(paren
id|self
op_ne
l_int|NULL
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|self-&gt;magic
op_eq
id|LAP_MAGIC
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
multiline_comment|/* Initialize variables */
id|skb
op_assign
id|tx_skb
op_assign
l_int|NULL
suffix:semicolon
id|count
op_assign
id|skb_queue_len
c_func
(paren
op_amp
id|self-&gt;wx_list
)paren
suffix:semicolon
multiline_comment|/*  Resend unacknowledged frame(s) */
id|skb
op_assign
id|skb_peek
c_func
(paren
op_amp
id|self-&gt;wx_list
)paren
suffix:semicolon
r_while
c_loop
(paren
id|skb
op_ne
l_int|NULL
)paren
(brace
id|irlap_wait_min_turn_around
c_func
(paren
id|self
comma
op_amp
id|self-&gt;qos_tx
)paren
suffix:semicolon
multiline_comment|/* We copy the skb to be retransmitted since we will have to &n;&t;&t; * modify it. Cloning will confuse packet sniffers &n;&t;&t; */
multiline_comment|/* tx_skb = skb_clone( skb, GFP_ATOMIC); */
id|tx_skb
op_assign
id|skb_copy
c_func
(paren
id|skb
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|tx_skb
)paren
(brace
id|IRDA_DEBUG
c_func
(paren
l_int|0
comma
id|__FUNCTION__
l_string|&quot;(), unable to copy&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/* Unlink tx_skb from list */
id|tx_skb-&gt;next
op_assign
id|tx_skb-&gt;prev
op_assign
l_int|NULL
suffix:semicolon
id|tx_skb-&gt;list
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/*&n;&t;&t; *  make sure the skb-&gt;sk accounting of memory usage is sane&n;&t;&t; */
r_if
c_cond
(paren
id|skb-&gt;sk
op_ne
l_int|NULL
)paren
id|skb_set_owner_w
c_func
(paren
id|tx_skb
comma
id|skb-&gt;sk
)paren
suffix:semicolon
multiline_comment|/* Clear old Nr field + poll bit */
id|tx_skb-&gt;data
(braket
l_int|1
)braket
op_and_assign
l_int|0x0f
suffix:semicolon
multiline_comment|/* &n;&t;&t; *  Set poll bit on the last frame retransmitted&n;&t;&t; */
r_if
c_cond
(paren
id|count
op_decrement
op_eq
l_int|1
)paren
id|tx_skb-&gt;data
(braket
l_int|1
)braket
op_or_assign
id|PF_BIT
suffix:semicolon
multiline_comment|/* Set p/f bit */
r_else
id|tx_skb-&gt;data
(braket
l_int|1
)braket
op_and_assign
op_complement
id|PF_BIT
suffix:semicolon
multiline_comment|/* Clear p/f bit */
id|irlap_send_i_frame
c_func
(paren
id|self
comma
id|tx_skb
comma
id|command
)paren
suffix:semicolon
multiline_comment|/* &n;&t;&t; *  If our skb is the last buffer in the list, then&n;&t;&t; *  we are finished, if not, move to the next sk-buffer&n;&t;&t; */
r_if
c_cond
(paren
id|skb
op_eq
id|skb_peek_tail
c_func
(paren
op_amp
id|self-&gt;wx_list
)paren
)paren
id|skb
op_assign
l_int|NULL
suffix:semicolon
r_else
id|skb
op_assign
id|skb-&gt;next
suffix:semicolon
)brace
macro_line|#if 0 /* Not yet */
multiline_comment|/* &n;&t; *  We can now fill the window with additinal data frames&n;&t; */
r_while
c_loop
(paren
id|skb_queue_len
c_func
(paren
op_amp
id|self-&gt;txq
)paren
OG
l_int|0
)paren
(brace
id|IRDA_DEBUG
c_func
(paren
l_int|0
comma
id|__FUNCTION__
l_string|&quot;(), sending additional frames!&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|skb_queue_len
c_func
(paren
op_amp
id|self-&gt;txq
)paren
OG
l_int|0
)paren
op_logical_and
(paren
id|self-&gt;window
OG
l_int|0
)paren
)paren
(brace
id|skb
op_assign
id|skb_dequeue
c_func
(paren
op_amp
id|self-&gt;txq
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|skb
op_ne
l_int|NULL
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t;&t; *  If send window &gt; 1 then send frame with pf &n;&t;&t;&t; *  bit cleared&n;&t;&t;&t; */
r_if
c_cond
(paren
(paren
id|self-&gt;window
OG
l_int|1
)paren
op_logical_and
id|skb_queue_len
c_func
(paren
op_amp
id|self-&gt;txq
)paren
OG
l_int|0
)paren
(brace
id|irlap_send_data_primary
c_func
(paren
id|self
comma
id|skb
)paren
suffix:semicolon
)brace
r_else
(brace
id|irlap_send_data_primary_poll
c_func
(paren
id|self
comma
id|skb
)paren
suffix:semicolon
)brace
id|kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
)brace
)brace
macro_line|#endif
)brace
DECL|function|irlap_resend_rejected_frame
r_void
id|irlap_resend_rejected_frame
c_func
(paren
r_struct
id|irlap_cb
op_star
id|self
comma
r_int
id|command
)paren
(brace
r_struct
id|sk_buff
op_star
id|tx_skb
suffix:semicolon
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
id|ASSERT
c_func
(paren
id|self
op_ne
l_int|NULL
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|self-&gt;magic
op_eq
id|LAP_MAGIC
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
multiline_comment|/* Initialize variables */
id|skb
op_assign
id|tx_skb
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/*  Resend unacknowledged frame(s) */
id|skb
op_assign
id|skb_peek
c_func
(paren
op_amp
id|self-&gt;wx_list
)paren
suffix:semicolon
r_if
c_cond
(paren
id|skb
op_ne
l_int|NULL
)paren
(brace
id|irlap_wait_min_turn_around
c_func
(paren
id|self
comma
op_amp
id|self-&gt;qos_tx
)paren
suffix:semicolon
multiline_comment|/* We copy the skb to be retransmitted since we will have to &n;&t;&t; * modify it. Cloning will confuse packet sniffers &n;&t;&t; */
multiline_comment|/* tx_skb = skb_clone( skb, GFP_ATOMIC); */
id|tx_skb
op_assign
id|skb_copy
c_func
(paren
id|skb
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|tx_skb
)paren
(brace
id|IRDA_DEBUG
c_func
(paren
l_int|0
comma
id|__FUNCTION__
l_string|&quot;(), unable to copy&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/* Unlink tx_skb from list */
id|tx_skb-&gt;next
op_assign
id|tx_skb-&gt;prev
op_assign
l_int|NULL
suffix:semicolon
id|tx_skb-&gt;list
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/*&n;&t;&t; *  make sure the skb-&gt;sk accounting of memory usage is sane&n;&t;&t; */
r_if
c_cond
(paren
id|skb-&gt;sk
op_ne
l_int|NULL
)paren
id|skb_set_owner_w
c_func
(paren
id|tx_skb
comma
id|skb-&gt;sk
)paren
suffix:semicolon
multiline_comment|/* Clear old Nr field + poll bit */
id|tx_skb-&gt;data
(braket
l_int|1
)braket
op_and_assign
l_int|0x0f
suffix:semicolon
multiline_comment|/*  Set poll/final bit */
id|tx_skb-&gt;data
(braket
l_int|1
)braket
op_or_assign
id|PF_BIT
suffix:semicolon
multiline_comment|/* Set p/f bit */
id|irlap_send_i_frame
c_func
(paren
id|self
comma
id|tx_skb
comma
id|command
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/*&n; * Function irlap_send_ui_frame (self, skb, command)&n; *&n; *    Contruct and transmit an Unnumbered Information (UI) frame&n; *&n; */
DECL|function|irlap_send_ui_frame
r_void
id|irlap_send_ui_frame
c_func
(paren
r_struct
id|irlap_cb
op_star
id|self
comma
r_struct
id|sk_buff
op_star
id|skb
comma
id|__u8
id|caddr
comma
r_int
id|command
)paren
(brace
id|IRDA_DEBUG
c_func
(paren
l_int|4
comma
id|__FUNCTION__
l_string|&quot;()&bslash;n&quot;
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|self
op_ne
l_int|NULL
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|self-&gt;magic
op_eq
id|LAP_MAGIC
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|skb
op_ne
l_int|NULL
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
multiline_comment|/* Insert connection address */
id|skb-&gt;data
(braket
l_int|0
)braket
op_assign
id|caddr
op_or
(paren
(paren
id|command
)paren
ques
c_cond
id|CMD_FRAME
suffix:colon
l_int|0
)paren
suffix:semicolon
id|irlap_queue_xmit
c_func
(paren
id|self
comma
id|skb
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Function irlap_send_i_frame (skb)&n; *&n; *    Contruct and transmit Information (I) frame&n; */
DECL|function|irlap_send_i_frame
r_void
id|irlap_send_i_frame
c_func
(paren
r_struct
id|irlap_cb
op_star
id|self
comma
r_struct
id|sk_buff
op_star
id|skb
comma
r_int
id|command
)paren
(brace
multiline_comment|/* Insert connection address */
id|skb-&gt;data
(braket
l_int|0
)braket
op_assign
id|self-&gt;caddr
suffix:semicolon
id|skb-&gt;data
(braket
l_int|0
)braket
op_or_assign
(paren
id|command
)paren
ques
c_cond
id|CMD_FRAME
suffix:colon
l_int|0
suffix:semicolon
multiline_comment|/* Insert next to receive (Vr) */
id|skb-&gt;data
(braket
l_int|1
)braket
op_or_assign
(paren
id|self-&gt;vr
op_lshift
l_int|5
)paren
suffix:semicolon
multiline_comment|/* insert nr */
id|irlap_queue_xmit
c_func
(paren
id|self
comma
id|skb
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Function irlap_recv_i_frame (skb, frame)&n; *&n; *    Receive and parse an I (Information) frame, no harm in making it inline&n; *    since it&squot;s called only from one single place (irlap_driver_rcv).&n; */
DECL|function|irlap_recv_i_frame
r_static
r_inline
r_void
id|irlap_recv_i_frame
c_func
(paren
r_struct
id|irlap_cb
op_star
id|self
comma
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|irlap_info
op_star
id|info
comma
r_int
id|command
)paren
(brace
id|info-&gt;nr
op_assign
id|skb-&gt;data
(braket
l_int|1
)braket
op_rshift
l_int|5
suffix:semicolon
multiline_comment|/* Next to receive */
id|info-&gt;pf
op_assign
id|skb-&gt;data
(braket
l_int|1
)braket
op_amp
id|PF_BIT
suffix:semicolon
multiline_comment|/* Final bit */
id|info-&gt;ns
op_assign
(paren
id|skb-&gt;data
(braket
l_int|1
)braket
op_rshift
l_int|1
)paren
op_amp
l_int|0x07
suffix:semicolon
multiline_comment|/* Next to send */
multiline_comment|/* Check if this is a command or a response frame */
r_if
c_cond
(paren
id|command
)paren
id|irlap_do_event
c_func
(paren
id|self
comma
id|RECV_I_CMD
comma
id|skb
comma
id|info
)paren
suffix:semicolon
r_else
id|irlap_do_event
c_func
(paren
id|self
comma
id|RECV_I_RSP
comma
id|skb
comma
id|info
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Function irlap_recv_ui_frame (self, skb, info)&n; *&n; *    Receive and parse an Unnumbered Information (UI) frame&n; *&n; */
DECL|function|irlap_recv_ui_frame
r_static
r_void
id|irlap_recv_ui_frame
c_func
(paren
r_struct
id|irlap_cb
op_star
id|self
comma
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|irlap_info
op_star
id|info
)paren
(brace
id|IRDA_DEBUG
c_func
(paren
l_int|4
comma
id|__FUNCTION__
l_string|&quot;()&bslash;n&quot;
)paren
suffix:semicolon
id|info-&gt;pf
op_assign
id|skb-&gt;data
(braket
l_int|1
)braket
op_amp
id|PF_BIT
suffix:semicolon
multiline_comment|/* Final bit */
id|irlap_do_event
c_func
(paren
id|self
comma
id|RECV_UI_FRAME
comma
id|skb
comma
id|info
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Function irlap_recv_frmr_frame (skb, frame)&n; *&n; *    Received Frame Reject response.&n; *&n; */
DECL|function|irlap_recv_frmr_frame
r_static
r_void
id|irlap_recv_frmr_frame
c_func
(paren
r_struct
id|irlap_cb
op_star
id|self
comma
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|irlap_info
op_star
id|info
)paren
(brace
id|__u8
op_star
id|frame
suffix:semicolon
r_int
id|w
comma
id|x
comma
id|y
comma
id|z
suffix:semicolon
id|IRDA_DEBUG
c_func
(paren
l_int|0
comma
id|__FUNCTION__
l_string|&quot;()&bslash;n&quot;
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|self
op_ne
l_int|NULL
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|self-&gt;magic
op_eq
id|LAP_MAGIC
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|skb
op_ne
l_int|NULL
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|info
op_ne
l_int|NULL
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
id|frame
op_assign
id|skb-&gt;data
suffix:semicolon
id|info-&gt;nr
op_assign
id|frame
(braket
l_int|2
)braket
op_rshift
l_int|5
suffix:semicolon
multiline_comment|/* Next to receive */
id|info-&gt;pf
op_assign
id|frame
(braket
l_int|2
)braket
op_amp
id|PF_BIT
suffix:semicolon
multiline_comment|/* Final bit */
id|info-&gt;ns
op_assign
(paren
id|frame
(braket
l_int|2
)braket
op_rshift
l_int|1
)paren
op_amp
l_int|0x07
suffix:semicolon
multiline_comment|/* Next to send */
id|w
op_assign
id|frame
(braket
l_int|3
)braket
op_amp
l_int|0x01
suffix:semicolon
id|x
op_assign
id|frame
(braket
l_int|3
)braket
op_amp
l_int|0x02
suffix:semicolon
id|y
op_assign
id|frame
(braket
l_int|3
)braket
op_amp
l_int|0x04
suffix:semicolon
id|z
op_assign
id|frame
(braket
l_int|3
)braket
op_amp
l_int|0x08
suffix:semicolon
r_if
c_cond
(paren
id|w
)paren
(brace
id|IRDA_DEBUG
c_func
(paren
l_int|0
comma
l_string|&quot;Rejected control field is undefined or not &quot;
l_string|&quot;implemented.&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|x
)paren
(brace
id|IRDA_DEBUG
c_func
(paren
l_int|0
comma
l_string|&quot;Rejected control field was invalid because it &quot;
l_string|&quot;contained a non permitted I field.&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|y
)paren
(brace
id|IRDA_DEBUG
c_func
(paren
l_int|0
comma
l_string|&quot;Received I field exceeded the maximum negotiated &quot;
l_string|&quot;for the existing connection or exceeded the maximum &quot;
l_string|&quot;this station supports if no connection exists.&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|z
)paren
(brace
id|IRDA_DEBUG
c_func
(paren
l_int|0
comma
l_string|&quot;Rejected control field control field contained an &quot;
l_string|&quot;invalid Nr count.&bslash;n&quot;
)paren
suffix:semicolon
)brace
id|irlap_do_event
c_func
(paren
id|self
comma
id|RECV_FRMR_RSP
comma
id|skb
comma
id|info
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Function irlap_send_test_frame (self, daddr)&n; *&n; *    Send a test frame response&n; *&n; */
DECL|function|irlap_send_test_frame
r_void
id|irlap_send_test_frame
c_func
(paren
r_struct
id|irlap_cb
op_star
id|self
comma
id|__u8
id|caddr
comma
id|__u32
id|daddr
comma
r_struct
id|sk_buff
op_star
id|cmd
)paren
(brace
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
r_struct
id|test_frame
op_star
id|frame
suffix:semicolon
id|__u8
op_star
id|info
suffix:semicolon
id|skb
op_assign
id|dev_alloc_skb
c_func
(paren
id|cmd-&gt;len
op_plus
r_sizeof
(paren
r_struct
id|test_frame
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|skb
)paren
r_return
suffix:semicolon
multiline_comment|/* Broadcast frames must include saddr and daddr fields */
r_if
c_cond
(paren
id|caddr
op_eq
id|CBROADCAST
)paren
(brace
id|frame
op_assign
(paren
r_struct
id|test_frame
op_star
)paren
id|skb_put
c_func
(paren
id|skb
comma
r_sizeof
(paren
r_struct
id|test_frame
)paren
)paren
suffix:semicolon
multiline_comment|/* Insert the swapped addresses */
id|frame-&gt;saddr
op_assign
id|cpu_to_le32
c_func
(paren
id|self-&gt;saddr
)paren
suffix:semicolon
id|frame-&gt;daddr
op_assign
id|cpu_to_le32
c_func
(paren
id|daddr
)paren
suffix:semicolon
)brace
r_else
id|frame
op_assign
(paren
r_struct
id|test_frame
op_star
)paren
id|skb_put
c_func
(paren
id|skb
comma
id|LAP_ADDR_HEADER
op_plus
id|LAP_CTRL_HEADER
)paren
suffix:semicolon
id|frame-&gt;caddr
op_assign
id|caddr
suffix:semicolon
id|frame-&gt;control
op_assign
id|TEST_RSP
op_or
id|PF_BIT
suffix:semicolon
multiline_comment|/* Copy info */
id|info
op_assign
id|skb_put
c_func
(paren
id|skb
comma
id|cmd-&gt;len
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|info
comma
id|cmd-&gt;data
comma
id|cmd-&gt;len
)paren
suffix:semicolon
multiline_comment|/* Return to sender */
id|irlap_wait_min_turn_around
c_func
(paren
id|self
comma
op_amp
id|self-&gt;qos_tx
)paren
suffix:semicolon
id|irlap_queue_xmit
c_func
(paren
id|self
comma
id|skb
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Function irlap_recv_test_frame (self, skb)&n; *&n; *    Receive a test frame&n; *&n; */
DECL|function|irlap_recv_test_frame
r_static
r_void
id|irlap_recv_test_frame
c_func
(paren
r_struct
id|irlap_cb
op_star
id|self
comma
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|irlap_info
op_star
id|info
comma
r_int
id|command
)paren
(brace
r_struct
id|test_frame
op_star
id|frame
suffix:semicolon
id|IRDA_DEBUG
c_func
(paren
l_int|2
comma
id|__FUNCTION__
l_string|&quot;()&bslash;n&quot;
)paren
suffix:semicolon
id|frame
op_assign
(paren
r_struct
id|test_frame
op_star
)paren
id|skb-&gt;data
suffix:semicolon
multiline_comment|/* Broadcast frames must carry saddr and daddr fields */
r_if
c_cond
(paren
id|info-&gt;caddr
op_eq
id|CBROADCAST
)paren
(brace
r_if
c_cond
(paren
id|skb-&gt;len
OL
r_sizeof
(paren
r_struct
id|test_frame
)paren
)paren
(brace
id|IRDA_DEBUG
c_func
(paren
l_int|0
comma
id|__FUNCTION__
l_string|&quot;() test frame to short!&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/* Read and swap addresses */
id|info-&gt;daddr
op_assign
id|le32_to_cpu
c_func
(paren
id|frame-&gt;saddr
)paren
suffix:semicolon
id|info-&gt;saddr
op_assign
id|le32_to_cpu
c_func
(paren
id|frame-&gt;daddr
)paren
suffix:semicolon
multiline_comment|/* Make sure frame is addressed to us */
r_if
c_cond
(paren
(paren
id|info-&gt;saddr
op_ne
id|self-&gt;saddr
)paren
op_logical_and
(paren
id|info-&gt;saddr
op_ne
id|BROADCAST
)paren
)paren
(brace
r_return
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|command
)paren
id|irlap_do_event
c_func
(paren
id|self
comma
id|RECV_TEST_CMD
comma
id|skb
comma
id|info
)paren
suffix:semicolon
r_else
id|irlap_do_event
c_func
(paren
id|self
comma
id|RECV_TEST_RSP
comma
id|skb
comma
id|info
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Function irlap_driver_rcv (skb, netdev, ptype)&n; *&n; *    Called when a frame is received. Dispatches the right receive function &n; *    for processing of the frame.&n; *&n; */
DECL|function|irlap_driver_rcv
r_int
id|irlap_driver_rcv
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|net_device
op_star
id|dev
comma
r_struct
id|packet_type
op_star
id|ptype
)paren
(brace
r_struct
id|irlap_info
id|info
suffix:semicolon
r_struct
id|irlap_cb
op_star
id|self
suffix:semicolon
r_int
id|command
suffix:semicolon
id|__u8
id|control
suffix:semicolon
multiline_comment|/* FIXME: should we get our own field? */
id|self
op_assign
(paren
r_struct
id|irlap_cb
op_star
)paren
id|dev-&gt;atalk_ptr
suffix:semicolon
multiline_comment|/* If the net device is down, then IrLAP is gone! */
r_if
c_cond
(paren
op_logical_neg
id|self
op_logical_or
id|self-&gt;magic
op_ne
id|LAP_MAGIC
)paren
(brace
id|dev_kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
multiline_comment|/* Check if frame is large enough for parsing */
r_if
c_cond
(paren
id|skb-&gt;len
OL
l_int|2
)paren
(brace
id|ERROR
c_func
(paren
id|__FUNCTION__
l_string|&quot;(), frame to short!&bslash;n&quot;
)paren
suffix:semicolon
id|dev_kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|command
op_assign
id|skb-&gt;data
(braket
l_int|0
)braket
op_amp
id|CMD_FRAME
suffix:semicolon
id|info.caddr
op_assign
id|skb-&gt;data
(braket
l_int|0
)braket
op_amp
id|CBROADCAST
suffix:semicolon
id|info.pf
op_assign
id|skb-&gt;data
(braket
l_int|1
)braket
op_amp
id|PF_BIT
suffix:semicolon
id|info.control
op_assign
id|skb-&gt;data
(braket
l_int|1
)braket
op_amp
op_complement
id|PF_BIT
suffix:semicolon
multiline_comment|/* Mask away poll/final bit */
id|control
op_assign
id|info.control
suffix:semicolon
multiline_comment|/*  First we check if this frame has a valid connection address */
r_if
c_cond
(paren
(paren
id|info.caddr
op_ne
id|self-&gt;caddr
)paren
op_logical_and
(paren
id|info.caddr
op_ne
id|CBROADCAST
)paren
)paren
(brace
id|IRDA_DEBUG
c_func
(paren
l_int|0
comma
id|__FUNCTION__
l_string|&quot;(), wrong connection address!&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
multiline_comment|/*  &n;&t; *  Optimize for the common case and check if the frame is an&n;&t; *  I(nformation) frame. Only I-frames have bit 0 set to 0&n;&t; */
r_if
c_cond
(paren
op_complement
id|control
op_amp
l_int|0x01
)paren
(brace
id|irlap_recv_i_frame
c_func
(paren
id|self
comma
id|skb
comma
op_amp
id|info
comma
id|command
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
multiline_comment|/*&n;&t; *  We now check is the frame is an S(upervisory) frame. Only &n;&t; *  S-frames have bit 0 set to 1 and bit 1 set to 0&n;&t; */
r_if
c_cond
(paren
op_complement
id|control
op_amp
l_int|0x02
)paren
(brace
multiline_comment|/* &n;&t;&t; *  Received S(upervisory) frame, check which frame type it is&n;&t;&t; *  only the first nibble is of interest&n;&t;&t; */
r_switch
c_cond
(paren
id|control
op_amp
l_int|0x0f
)paren
(brace
r_case
id|RR
suffix:colon
id|irlap_recv_rr_frame
c_func
(paren
id|self
comma
id|skb
comma
op_amp
id|info
comma
id|command
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|RNR
suffix:colon
id|irlap_recv_rnr_frame
c_func
(paren
id|self
comma
id|skb
comma
op_amp
id|info
comma
id|command
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|REJ
suffix:colon
id|irlap_recv_rej_frame
c_func
(paren
id|self
comma
id|skb
comma
op_amp
id|info
comma
id|command
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SREJ
suffix:colon
id|irlap_recv_srej_frame
c_func
(paren
id|self
comma
id|skb
comma
op_amp
id|info
comma
id|command
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|WARNING
c_func
(paren
id|__FUNCTION__
l_string|&quot;() Unknown S-frame %02x received!&bslash;n&quot;
comma
id|info.control
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_goto
id|out
suffix:semicolon
)brace
multiline_comment|/* &n;&t; *  This must be a C(ontrol) frame &n;&t; */
r_switch
c_cond
(paren
id|control
)paren
(brace
r_case
id|XID_RSP
suffix:colon
id|irlap_recv_discovery_xid_rsp
c_func
(paren
id|self
comma
id|skb
comma
op_amp
id|info
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|XID_CMD
suffix:colon
id|irlap_recv_discovery_xid_cmd
c_func
(paren
id|self
comma
id|skb
comma
op_amp
id|info
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SNRM_CMD
suffix:colon
id|irlap_recv_snrm_cmd
c_func
(paren
id|self
comma
id|skb
comma
op_amp
id|info
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|DM_RSP
suffix:colon
id|irlap_do_event
c_func
(paren
id|self
comma
id|RECV_DM_RSP
comma
id|skb
comma
op_amp
id|info
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|DISC_CMD
suffix:colon
multiline_comment|/* And RD_RSP since they have the same value */
id|irlap_recv_disc_frame
c_func
(paren
id|self
comma
id|skb
comma
op_amp
id|info
comma
id|command
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|TEST_CMD
suffix:colon
id|irlap_recv_test_frame
c_func
(paren
id|self
comma
id|skb
comma
op_amp
id|info
comma
id|command
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|UA_RSP
suffix:colon
id|irlap_recv_ua_frame
c_func
(paren
id|self
comma
id|skb
comma
op_amp
id|info
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|FRMR_RSP
suffix:colon
id|irlap_recv_frmr_frame
c_func
(paren
id|self
comma
id|skb
comma
op_amp
id|info
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|UI_FRAME
suffix:colon
id|irlap_recv_ui_frame
c_func
(paren
id|self
comma
id|skb
comma
op_amp
id|info
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|WARNING
c_func
(paren
id|__FUNCTION__
l_string|&quot;(), Unknown frame %02x received!&bslash;n&quot;
comma
id|info.control
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|out
suffix:colon
id|dev_kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
eof
