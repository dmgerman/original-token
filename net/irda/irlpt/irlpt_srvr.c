multiline_comment|/*********************************************************************&n; *&n; * Filename:      irlpt.c&n; * Version:       &n; * Description:   &n; * Status:        Experimental.&n; * Author:        Thomas Davis, &lt;ratbert@radiks.net&gt;&n; * Created at:    Sat Feb 21 18:54:38 1998&n; * Modified at:   Sun Mar  8 23:44:19 1998&n; * Modified by:   Dag Brattli &lt;dagb@cs.uit.no&gt;&n; * Sources:&t;  irlan.c&n; *&n; *     Copyright (c) 1998, Thomas Davis, &lt;ratbert@radiks.net&gt;,&n; *&t;&t;&t;   Dag Brattli,  &lt;dagb@cs.uit.no&gt;&n; *     All Rights Reserved.&n; *&n; *     This program is free software; you can redistribute it and/or&n; *     modify it under the terms of the GNU General Public License as&n; *     published by the Free Software Foundation; either version 2 of&n; *     the License, or (at your option) any later version.&n; *&n; *     I, Thomas Davis, provide no warranty for any of this software.&n; *     This material is provided &quot;AS-IS&quot; and at no charge.&n; *&n; ********************************************************************/
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;asm/uaccess.h&gt;
macro_line|#include &lt;linux/miscdevice.h&gt;
macro_line|#include &lt;linux/proc_fs.h&gt;
macro_line|#include &lt;net/irda/irlap.h&gt;
macro_line|#include &lt;net/irda/irlmp.h&gt;
macro_line|#include &lt;net/irda/iriap.h&gt;
macro_line|#include &lt;net/irda/irias_object.h&gt;
macro_line|#include &lt;net/irda/timer.h&gt;
macro_line|#include &lt;net/irda/irda.h&gt;
macro_line|#include &lt;net/irda/irlpt_common.h&gt;
macro_line|#include &lt;net/irda/irlpt_server.h&gt;
macro_line|#include &lt;net/irda/irlpt_server_fsm.h&gt;
macro_line|#ifdef CONFIG_PROC_FS
r_static
r_int
id|irlpt_server_proc_read
c_func
(paren
r_char
op_star
id|buf
comma
r_char
op_star
op_star
id|start
comma
id|off_t
id|offset
comma
r_int
id|len
comma
r_int
id|unused
)paren
suffix:semicolon
macro_line|#endif /* CONFIG_PROC_FS */
r_int
id|irlpt_server_init
c_func
(paren
r_void
)paren
suffix:semicolon
r_static
r_void
id|irlpt_server_cleanup
c_func
(paren
r_void
)paren
suffix:semicolon
r_static
r_void
id|irlpt_server_disconnect_indication
c_func
(paren
r_void
op_star
id|instance
comma
r_void
op_star
id|sap
comma
id|LM_REASON
id|reason
comma
r_struct
id|sk_buff
op_star
id|skb
)paren
suffix:semicolon
r_static
r_void
id|irlpt_server_connect_confirm
c_func
(paren
r_void
op_star
id|instance
comma
r_void
op_star
id|sap
comma
r_struct
id|qos_info
op_star
id|qos
comma
r_int
id|max_seg_size
comma
r_struct
id|sk_buff
op_star
id|skb
)paren
suffix:semicolon
r_static
r_void
id|irlpt_server_connect_indication
c_func
(paren
r_void
op_star
id|instance
comma
r_void
op_star
id|sap
comma
r_struct
id|qos_info
op_star
id|qos
comma
r_int
id|max_seg_size
comma
r_struct
id|sk_buff
op_star
id|skb
)paren
suffix:semicolon
r_static
r_void
id|irlpt_server_data_indication
c_func
(paren
r_void
op_star
id|instance
comma
r_void
op_star
id|sap
comma
r_struct
id|sk_buff
op_star
id|skb
)paren
suffix:semicolon
r_static
r_void
id|register_irlpt_server
c_func
(paren
r_void
)paren
suffix:semicolon
r_static
r_void
id|deregister_irlpt_server
c_func
(paren
r_void
)paren
suffix:semicolon
DECL|variable|irlpt_server_lsap
r_int
id|irlpt_server_lsap
op_assign
id|LSAP_IRLPT
suffix:semicolon
DECL|variable|irlpt_server_debug
r_int
id|irlpt_server_debug
op_assign
l_int|4
suffix:semicolon
macro_line|#if 0
r_static
r_char
op_star
id|rcsid
op_assign
l_string|&quot;$Id: irlpt_server.c,v 1.9 1998/10/22 12:02:22 dagb Exp $&quot;
suffix:semicolon
macro_line|#endif
DECL|variable|version
r_static
r_char
op_star
id|version
op_assign
l_string|&quot;IrLPT server, v2 (Thomas Davis)&quot;
suffix:semicolon
DECL|variable|irlpt_fops
r_struct
id|file_operations
id|irlpt_fops
op_assign
(brace
id|irlpt_seek
comma
multiline_comment|/* seek */
id|irlpt_read
comma
multiline_comment|/* read */
id|irlpt_write
comma
l_int|NULL
comma
multiline_comment|/* readdir */
l_int|NULL
comma
multiline_comment|/* poll */
l_int|NULL
comma
multiline_comment|/* ioctl */
l_int|NULL
comma
multiline_comment|/* mmap */
id|irlpt_open
comma
multiline_comment|/* open */
l_int|NULL
comma
multiline_comment|/* flush */
id|irlpt_close
comma
multiline_comment|/* release */
l_int|NULL
comma
multiline_comment|/* fsync */
l_int|NULL
comma
multiline_comment|/* fasync */
l_int|NULL
comma
multiline_comment|/* check_media_change */
l_int|NULL
comma
multiline_comment|/* revalidate */
l_int|NULL
comma
multiline_comment|/* lock */
)brace
suffix:semicolon
macro_line|#ifdef CONFIG_PROC_FS
multiline_comment|/*&n; * Function irlpt_server_proc_read (buf, start, offset, len, unused)&n; *&n; *&n; *&n; */
DECL|function|irlpt_server_proc_read
r_static
r_int
id|irlpt_server_proc_read
c_func
(paren
r_char
op_star
id|buf
comma
r_char
op_star
op_star
id|start
comma
id|off_t
id|offset
comma
r_int
id|len
comma
r_int
id|unused
)paren
(brace
r_int
id|index
suffix:semicolon
id|DEBUG
c_func
(paren
id|irlpt_server_debug
comma
l_string|&quot;--&gt; &quot;
id|__FUNCTION__
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|irlpt_server
op_ne
l_int|NULL
)paren
(brace
id|len
op_assign
id|sprintf
c_func
(paren
id|buf
comma
l_string|&quot;%s&bslash;n&bslash;n&quot;
comma
id|version
)paren
suffix:semicolon
id|len
op_add_assign
id|sprintf
c_func
(paren
id|buf
op_plus
id|len
comma
l_string|&quot;ifname: %s&bslash;n&quot;
comma
id|irlpt_server-&gt;ifname
)paren
suffix:semicolon
id|len
op_add_assign
id|sprintf
c_func
(paren
id|buf
op_plus
id|len
comma
l_string|&quot;minor: %d&bslash;n&quot;
comma
id|irlpt_server-&gt;ir_dev.minor
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|irlpt_server-&gt;servicetype
)paren
(brace
r_case
id|IRLPT_UNKNOWN
suffix:colon
id|index
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_case
id|IRLPT_THREE_WIRE_RAW
suffix:colon
id|index
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
r_case
id|IRLPT_THREE_WIRE
suffix:colon
id|index
op_assign
l_int|2
suffix:semicolon
r_break
suffix:semicolon
r_case
id|IRLPT_NINE_WIRE
suffix:colon
id|index
op_assign
l_int|3
suffix:semicolon
r_break
suffix:semicolon
r_case
id|IRLPT_CENTRONICS
suffix:colon
id|index
op_assign
l_int|4
suffix:semicolon
r_break
suffix:semicolon
r_case
id|IRLPT_SERVER_MODE
suffix:colon
id|index
op_assign
l_int|5
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|index
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
)brace
id|len
op_add_assign
id|sprintf
c_func
(paren
id|buf
op_plus
id|len
comma
l_string|&quot;servicetype: %s, porttype: %s&bslash;n&quot;
comma
id|irlpt_service_type
(braket
id|index
)braket
comma
id|irlpt_port_type
(braket
id|irlpt_server-&gt;porttype
)braket
)paren
suffix:semicolon
id|len
op_add_assign
id|sprintf
c_func
(paren
id|buf
op_plus
id|len
comma
l_string|&quot;saddr: 0x%08x, daddr: 0x%08x&bslash;n&quot;
comma
id|irlpt_server-&gt;saddr
comma
id|irlpt_server-&gt;daddr
)paren
suffix:semicolon
id|len
op_add_assign
id|sprintf
c_func
(paren
id|buf
op_plus
id|len
comma
l_string|&quot;slsap: 0x%08x, dlsap: 0x%08x&bslash;n&quot;
comma
id|irlpt_server-&gt;slsap_sel
comma
id|irlpt_server-&gt;dlsap_sel
)paren
suffix:semicolon
id|len
op_add_assign
id|sprintf
c_func
(paren
id|buf
op_plus
id|len
comma
l_string|&quot;retries: %d, count: %d&bslash;n&quot;
comma
id|irlpt_server-&gt;open_retries
comma
id|irlpt_server-&gt;count
)paren
suffix:semicolon
id|len
op_add_assign
id|sprintf
c_func
(paren
id|buf
op_plus
id|len
comma
l_string|&quot;fsm state: %s, rx queue depth: %d&bslash;n&quot;
comma
id|irlpt_server_fsm_state
(braket
id|irlpt_server-&gt;state
)braket
comma
id|skb_queue_len
c_func
(paren
op_amp
id|irlpt_server-&gt;rx_queue
)paren
)paren
suffix:semicolon
id|len
op_add_assign
id|sprintf
c_func
(paren
id|buf
op_plus
id|len
comma
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
)brace
id|DEBUG
c_func
(paren
id|irlpt_server_debug
comma
id|__FUNCTION__
l_string|&quot; --&gt;&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|len
suffix:semicolon
)brace
r_extern
r_struct
id|proc_dir_entry
id|proc_irda
suffix:semicolon
DECL|variable|proc_irlpt_server
r_struct
id|proc_dir_entry
id|proc_irlpt_server
op_assign
(brace
l_int|0
comma
l_int|12
comma
l_string|&quot;irlpt_server&quot;
comma
id|S_IFREG
op_or
id|S_IRUGO
comma
l_int|1
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|NULL
multiline_comment|/* ops -- default to array */
comma
op_amp
id|irlpt_server_proc_read
multiline_comment|/* get_info */
comma
)brace
suffix:semicolon
macro_line|#endif /* CONFIG_PROC_FS */
multiline_comment|/*&n; * Function irlpt_init (dev)&n; *&n; *   Initializes the irlpt control structure&n; *&n; */
multiline_comment|/*int irlpt_init( struct device *dev) {*/
DECL|function|__initfunc
id|__initfunc
c_func
(paren
r_int
id|irlpt_server_init
c_func
(paren
r_void
)paren
)paren
(brace
id|DEBUG
c_func
(paren
id|irlpt_server_debug
comma
l_string|&quot;--&gt; &quot;
id|__FUNCTION__
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s&bslash;n&quot;
comma
id|version
)paren
suffix:semicolon
id|irlpt_server
op_assign
(paren
r_struct
id|irlpt_cb
op_star
)paren
id|kmalloc
(paren
r_sizeof
(paren
r_struct
id|irlpt_cb
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|irlpt_server
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;IrLPT server: Can&squot;t allocate&quot;
l_string|&quot; irlpt_server control block!&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|memset
c_func
(paren
id|irlpt_server
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|irlpt_cb
)paren
)paren
suffix:semicolon
id|sprintf
c_func
(paren
id|irlpt_server-&gt;ifname
comma
l_string|&quot;irlpt_server&quot;
)paren
suffix:semicolon
id|irlpt_server-&gt;ir_dev.minor
op_assign
id|MISC_DYNAMIC_MINOR
suffix:semicolon
id|irlpt_server-&gt;ir_dev.name
op_assign
id|irlpt_server-&gt;ifname
suffix:semicolon
id|irlpt_server-&gt;ir_dev.fops
op_assign
op_amp
id|irlpt_fops
suffix:semicolon
id|misc_register
c_func
(paren
op_amp
id|irlpt_server-&gt;ir_dev
)paren
suffix:semicolon
id|irlpt_server-&gt;magic
op_assign
id|IRLPT_MAGIC
suffix:semicolon
id|irlpt_server-&gt;in_use
op_assign
id|TRUE
suffix:semicolon
id|irlpt_server-&gt;servicetype
op_assign
id|IRLPT_THREE_WIRE_RAW
suffix:semicolon
id|irlpt_server-&gt;porttype
op_assign
id|IRLPT_SERIAL
suffix:semicolon
id|skb_queue_head_init
c_func
(paren
op_amp
id|irlpt_server-&gt;rx_queue
)paren
suffix:semicolon
id|irlmp_register_layer
c_func
(paren
id|S_PRINTER
comma
id|SERVER
comma
id|FALSE
comma
l_int|NULL
)paren
suffix:semicolon
id|register_irlpt_server
c_func
(paren
)paren
suffix:semicolon
macro_line|#ifdef CONFIG_PROC_FS
id|proc_register
c_func
(paren
op_amp
id|proc_irda
comma
op_amp
id|proc_irlpt_server
)paren
suffix:semicolon
macro_line|#endif /* CONFIG_PROC_FS */
id|DEBUG
c_func
(paren
id|irlpt_server_debug
comma
id|__FUNCTION__
l_string|&quot; --&gt;&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * Function irlpt_cleanup (void)&n; *&n; *&n; *&n; */
DECL|function|irlpt_server_cleanup
r_static
r_void
id|irlpt_server_cleanup
c_func
(paren
r_void
)paren
(brace
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
id|DEBUG
c_func
(paren
id|irlpt_server_debug
comma
l_string|&quot;--&gt; &quot;
id|__FUNCTION__
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
id|deregister_irlpt_server
c_func
(paren
)paren
suffix:semicolon
r_while
c_loop
(paren
(paren
id|skb
op_assign
id|skb_dequeue
c_func
(paren
op_amp
id|irlpt_server-&gt;rx_queue
)paren
)paren
op_ne
l_int|NULL
)paren
(brace
id|DEBUG
c_func
(paren
id|irlpt_server_debug
comma
id|__FUNCTION__
l_string|&quot;: freeing SKB&bslash;n&quot;
)paren
suffix:semicolon
id|IS_SKB
c_func
(paren
id|skb
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
id|FREE_SKB_MAGIC
c_func
(paren
id|skb
)paren
suffix:semicolon
id|dev_kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
)brace
id|misc_deregister
c_func
(paren
op_amp
id|irlpt_server-&gt;ir_dev
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|irlpt_server
)paren
suffix:semicolon
macro_line|#ifdef CONFIG_PROC_FS
id|proc_unregister
c_func
(paren
op_amp
id|proc_irda
comma
id|proc_irlpt_server.low_ino
)paren
suffix:semicolon
macro_line|#endif
id|DEBUG
c_func
(paren
id|irlpt_server_debug
comma
id|__FUNCTION__
l_string|&quot; --&gt;&bslash;n&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Function irlpt_disconnect_indication (handle)&n; *&n; */
DECL|function|irlpt_server_disconnect_indication
r_static
r_void
id|irlpt_server_disconnect_indication
c_func
(paren
r_void
op_star
id|instance
comma
r_void
op_star
id|sap
comma
id|LM_REASON
id|reason
comma
r_struct
id|sk_buff
op_star
id|userdata
)paren
(brace
macro_line|#if 0
r_struct
id|irlpt_info
id|info
suffix:semicolon
macro_line|#endif
r_struct
id|irlpt_cb
op_star
id|self
suffix:semicolon
id|DEBUG
c_func
(paren
id|irlpt_server_debug
comma
l_string|&quot;--&gt; &quot;
id|__FUNCTION__
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
id|self
op_assign
(paren
r_struct
id|irlpt_cb
op_star
)paren
id|instance
suffix:semicolon
id|ASSERT
c_func
(paren
id|self
op_ne
l_int|NULL
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|self-&gt;magic
op_eq
id|IRLPT_MAGIC
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
macro_line|#if 0
id|info.daddr
op_assign
id|self-&gt;daddr
suffix:semicolon
macro_line|#endif
id|DEBUG
c_func
(paren
id|irlpt_server_debug
comma
id|__FUNCTION__
l_string|&quot;: reason=%d (%s), dlsap_sel=%d&bslash;n&quot;
comma
id|reason
comma
id|irlpt_reasons
(braket
id|reason
)braket
comma
id|self-&gt;dlsap_sel
)paren
suffix:semicolon
id|self-&gt;connected
op_assign
id|IRLPT_DISCONNECTED
suffix:semicolon
id|self-&gt;eof
op_assign
id|reason
suffix:semicolon
id|wake_up_interruptible
c_func
(paren
op_amp
id|self-&gt;read_wait
)paren
suffix:semicolon
id|wake_up_interruptible
c_func
(paren
op_amp
id|self-&gt;write_wait
)paren
suffix:semicolon
id|wake_up_interruptible
c_func
(paren
op_amp
id|self-&gt;ex_wait
)paren
suffix:semicolon
id|DEBUG
c_func
(paren
id|irlpt_server_debug
comma
id|__FUNCTION__
l_string|&quot;: rx queue length: %d&bslash;n&quot;
comma
id|skb_queue_len
c_func
(paren
op_amp
id|irlpt_server-&gt;rx_queue
)paren
)paren
suffix:semicolon
id|irlpt_server_do_event
c_func
(paren
id|self
comma
id|LMP_DISCONNECT
comma
l_int|NULL
comma
l_int|NULL
)paren
suffix:semicolon
id|deregister_irlpt_server
c_func
(paren
)paren
suffix:semicolon
id|register_irlpt_server
c_func
(paren
)paren
suffix:semicolon
id|DEBUG
c_func
(paren
id|irlpt_server_debug
comma
id|__FUNCTION__
l_string|&quot; --&gt;&bslash;n&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Function irlpt_connect_confirm (handle, qos, skb)&n; *&n; *    LSAP connection confirmed!&n; */
DECL|function|irlpt_server_connect_confirm
r_static
r_void
id|irlpt_server_connect_confirm
c_func
(paren
r_void
op_star
id|instance
comma
r_void
op_star
id|sap
comma
r_struct
id|qos_info
op_star
id|qos
comma
r_int
id|max_seg_size
comma
r_struct
id|sk_buff
op_star
id|skb
)paren
(brace
r_struct
id|irlpt_cb
op_star
id|self
suffix:semicolon
id|DEBUG
c_func
(paren
id|irlpt_server_debug
comma
l_string|&quot;--&gt; &quot;
id|__FUNCTION__
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
id|self
op_assign
(paren
r_struct
id|irlpt_cb
op_star
)paren
id|instance
suffix:semicolon
id|ASSERT
c_func
(paren
id|self
op_ne
l_int|NULL
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|self-&gt;magic
op_eq
id|IRLPT_MAGIC
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
id|self-&gt;connected
op_assign
id|TRUE
suffix:semicolon
id|irlpt_server_do_event
c_func
(paren
id|self
comma
id|LMP_CONNECT
comma
l_int|NULL
comma
l_int|NULL
)paren
suffix:semicolon
id|DEBUG
c_func
(paren
id|irlpt_server_debug
comma
id|__FUNCTION__
l_string|&quot; --&gt;&bslash;n&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Function irlpt_connect_indication (handle)&n; *&n; */
DECL|function|irlpt_server_connect_indication
r_static
r_void
id|irlpt_server_connect_indication
c_func
(paren
r_void
op_star
id|instance
comma
r_void
op_star
id|sap
comma
r_struct
id|qos_info
op_star
id|qos
comma
r_int
id|max_seg_size
comma
r_struct
id|sk_buff
op_star
id|skb
)paren
(brace
r_struct
id|irlpt_cb
op_star
id|self
suffix:semicolon
r_struct
id|irlpt_info
id|info
suffix:semicolon
id|DEBUG
c_func
(paren
id|irlpt_server_debug
comma
l_string|&quot;--&gt; &quot;
id|__FUNCTION__
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
id|self
op_assign
(paren
r_struct
id|irlpt_cb
op_star
)paren
id|instance
suffix:semicolon
id|info.lsap
op_assign
(paren
r_struct
id|lsap_cb
op_star
)paren
id|sap
suffix:semicolon
id|ASSERT
c_func
(paren
id|self
op_ne
l_int|NULL
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|self-&gt;magic
op_eq
id|IRLPT_MAGIC
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
id|self-&gt;connected
op_assign
id|IRLPT_CONNECTED
suffix:semicolon
id|self-&gt;eof
op_assign
id|FALSE
suffix:semicolon
id|irlpt_server_do_event
c_func
(paren
id|self
comma
id|LMP_CONNECT
comma
l_int|NULL
comma
op_amp
id|info
)paren
suffix:semicolon
r_if
c_cond
(paren
id|skb
)paren
(brace
id|dev_kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
)brace
id|DEBUG
c_func
(paren
id|irlpt_server_debug
comma
id|__FUNCTION__
l_string|&quot; --&gt;&bslash;n&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Function irlpt_server_data_indication (handle, skb)&n; *&n; *    This function gets the data that is received on the data channel&n; *&n; */
DECL|function|irlpt_server_data_indication
r_static
r_void
id|irlpt_server_data_indication
c_func
(paren
r_void
op_star
id|instance
comma
r_void
op_star
id|sap
comma
r_struct
id|sk_buff
op_star
id|skb
)paren
(brace
r_struct
id|irlpt_cb
op_star
id|self
suffix:semicolon
id|DEBUG
c_func
(paren
id|irlpt_server_debug
comma
l_string|&quot;--&gt; &quot;
id|__FUNCTION__
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
id|self
op_assign
(paren
r_struct
id|irlpt_cb
op_star
)paren
id|instance
suffix:semicolon
id|ASSERT
c_func
(paren
id|self
op_ne
l_int|NULL
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|self-&gt;magic
op_eq
id|IRLPT_MAGIC
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|skb
op_ne
l_int|NULL
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
id|DEBUG
c_func
(paren
id|irlpt_server_debug
comma
id|__FUNCTION__
l_string|&quot;: len=%d&bslash;n&quot;
comma
(paren
r_int
)paren
id|skb-&gt;len
)paren
suffix:semicolon
macro_line|#if 0
id|dump_buffer
c_func
(paren
id|skb
)paren
suffix:semicolon
macro_line|#endif
id|skb_queue_tail
c_func
(paren
op_amp
id|self-&gt;rx_queue
comma
id|skb
)paren
suffix:semicolon
id|wake_up_interruptible
c_func
(paren
op_amp
id|self-&gt;read_wait
)paren
suffix:semicolon
id|DEBUG
c_func
(paren
id|irlpt_server_debug
comma
id|__FUNCTION__
l_string|&quot; --&gt;&bslash;n&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Function register_irlpt_server(void)&n; *&n; *    Register server support so we can accept incoming connections. We&n; *    must register both a TSAP for control and data&n; * &n; */
DECL|function|register_irlpt_server
r_static
r_void
id|register_irlpt_server
c_func
(paren
r_void
)paren
(brace
r_struct
id|notify_t
id|notify
suffix:semicolon
r_struct
id|ias_object
op_star
id|obj
suffix:semicolon
id|DEBUG
c_func
(paren
id|irlpt_server_debug
comma
l_string|&quot;--&gt; &quot;
id|__FUNCTION__
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/*&n;&t; *  First register control TSAP&n;&t; */
r_if
c_cond
(paren
op_logical_neg
id|irlpt_server
op_logical_or
id|irlpt_server-&gt;magic
op_ne
id|IRLPT_MAGIC
)paren
(brace
id|DEBUG
c_func
(paren
l_int|0
comma
id|__FUNCTION__
l_string|&quot;: unable to obtain handle!&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|irda_notify_init
c_func
(paren
op_amp
id|notify
)paren
suffix:semicolon
id|notify.connect_confirm
op_assign
id|irlpt_server_connect_confirm
suffix:semicolon
id|notify.connect_indication
op_assign
id|irlpt_server_connect_indication
suffix:semicolon
id|notify.disconnect_indication
op_assign
id|irlpt_server_disconnect_indication
suffix:semicolon
id|notify.data_indication
op_assign
id|irlpt_server_data_indication
suffix:semicolon
id|notify.instance
op_assign
id|irlpt_server
suffix:semicolon
id|strcpy
c_func
(paren
id|notify.name
comma
l_string|&quot;IrLPT server&quot;
)paren
suffix:semicolon
id|irlpt_server-&gt;lsap
op_assign
id|irlmp_open_lsap
c_func
(paren
id|irlpt_server_lsap
comma
op_amp
id|notify
)paren
suffix:semicolon
id|irlpt_server-&gt;connected
op_assign
id|IRLPT_WAITING
suffix:semicolon
id|irlpt_server-&gt;service_LSAP
op_assign
id|irlpt_server_lsap
suffix:semicolon
id|irlpt_server-&gt;slsap_sel
op_assign
id|irlpt_server_lsap
suffix:semicolon
multiline_comment|/* &n;&t; *  Register with LM-IAS&n;&t; */
id|obj
op_assign
id|irias_new_object
c_func
(paren
l_string|&quot;IrLPT&quot;
comma
id|IAS_IRLPT_ID
)paren
suffix:semicolon
id|irias_add_integer_attrib
c_func
(paren
id|obj
comma
l_string|&quot;IrDA:IrLMP:LsapSel&quot;
comma
id|irlpt_server_lsap
)paren
suffix:semicolon
id|irias_insert_object
c_func
(paren
id|obj
)paren
suffix:semicolon
id|DEBUG
c_func
(paren
id|irlpt_server_debug
comma
id|__FUNCTION__
l_string|&quot;: Source LSAP sel=%d&bslash;n&quot;
comma
id|irlpt_server-&gt;slsap_sel
)paren
suffix:semicolon
id|DEBUG
c_func
(paren
id|irlpt_server_debug
comma
id|__FUNCTION__
l_string|&quot; --&gt;&bslash;n&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Function register_irlpt_server(void)&n; *&n; *    Register server support so we can accept incoming connections. We&n; *    must register both a TSAP for control and data&n; * &n; */
DECL|function|deregister_irlpt_server
r_static
r_void
id|deregister_irlpt_server
c_func
(paren
r_void
)paren
(brace
id|DEBUG
c_func
(paren
id|irlpt_server_debug
comma
l_string|&quot;--&gt; &quot;
id|__FUNCTION__
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
id|irlpt_server-&gt;connected
op_assign
id|IRLPT_DISCONNECTED
suffix:semicolon
multiline_comment|/* &n;&t; *  de-Register with LM-IAS&n;&t; */
id|irias_delete_object
c_func
(paren
l_string|&quot;IrLPT&quot;
)paren
suffix:semicolon
id|DEBUG
c_func
(paren
id|irlpt_server_debug
comma
id|__FUNCTION__
l_string|&quot;: Source LSAP sel=%d&bslash;n&quot;
comma
id|irlpt_server-&gt;slsap_sel
)paren
suffix:semicolon
id|DEBUG
c_func
(paren
id|irlpt_server_debug
comma
id|__FUNCTION__
l_string|&quot; --&gt;&bslash;n&quot;
)paren
suffix:semicolon
)brace
macro_line|#ifdef MODULE
id|MODULE_AUTHOR
c_func
(paren
l_string|&quot;Thomas Davis &lt;ratbert@radiks.net&gt;&quot;
)paren
suffix:semicolon
id|MODULE_DESCRIPTION
c_func
(paren
l_string|&quot;The Linux IrDA/IrLPT server protocol&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|irlpt_server_debug
comma
l_string|&quot;1i&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|irlpt_server_fsm_debug
comma
l_string|&quot;1i&quot;
)paren
suffix:semicolon
multiline_comment|/*&n; * Function init_module (void)&n; *&n; *    Initialize the IrLPT server module, this function is called by the&n; *    modprobe(1) program.&n; */
DECL|function|init_module
r_int
id|init_module
c_func
(paren
r_void
)paren
(brace
id|DEBUG
c_func
(paren
id|irlpt_server_debug
comma
l_string|&quot;--&gt; IrLPT server: init_module&bslash;n&quot;
)paren
suffix:semicolon
id|irlpt_server_init
c_func
(paren
)paren
suffix:semicolon
id|DEBUG
c_func
(paren
id|irlpt_server_debug
comma
l_string|&quot;IrLPT server: init_module --&gt;&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * Function cleanup_module (void)&n; *&n; *    Remove the IrLPT server module, this function is called by the rmmod(1)&n; *    program&n; */
DECL|function|cleanup_module
r_void
id|cleanup_module
c_func
(paren
r_void
)paren
(brace
id|DEBUG
c_func
(paren
id|irlpt_server_debug
comma
l_string|&quot;--&gt; IrLPT server: cleanup_module&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* No need to check MOD_IN_USE, as sys_delete_module() checks. */
multiline_comment|/* Free some memory */
id|irlpt_server_cleanup
c_func
(paren
)paren
suffix:semicolon
id|DEBUG
c_func
(paren
id|irlpt_server_debug
comma
l_string|&quot;IrLPT server: cleanup_module --&gt;&bslash;n&quot;
)paren
suffix:semicolon
)brace
macro_line|#endif /* MODULE */
eof
