multiline_comment|/*********************************************************************&n; *&n; * Filename:      irlpt_common.c&n; * Version:       &n; * Description:   &n; * Status:        Experimental.&n; * Author:        Thomas Davis, &lt;ratbert@radiks.net&gt;&n; * Created at:    Sat Feb 21 18:54:38 1998&n; * Modified at:   Sun Mar  8 23:44:19 1998&n; * Modified by:   Dag Brattli &lt;dagb@cs.uit.no&gt;&n; * Sources:&t;  irlpt.c&n; *&n; *     Copyright (c) 1998, Thomas Davis, &lt;ratbert@radiks.net&gt;,&n; *     Copyright (c) 1998, Dag Brattli,  &lt;dagb@cs.uit.no&gt;&n; *     All Rights Reserved.&n; *&n; *     This program is free software; you can redistribute it and/or&n; *     modify it under the terms of the GNU General Public License as&n; *     published by the Free Software Foundation; either version 2 of&n; *     the License, or (at your option) any later version.&n; *&n; *     I, Thomas Davis, provide no warranty for any of this software.&n; *     This material is provided &quot;AS-IS&quot; and at no charge.&n; *&n; ********************************************************************/
macro_line|#include &lt;linux/module.h&gt; 
macro_line|#include &lt;asm/segment.h&gt;
macro_line|#include &lt;net/irda/irda.h&gt;
macro_line|#include &lt;net/irda/irlap.h&gt;
macro_line|#include &lt;net/irda/irlmp.h&gt;
macro_line|#include &lt;net/irda/iriap.h&gt;
macro_line|#include &lt;net/irda/irttp.h&gt;
macro_line|#include &lt;net/irda/timer.h&gt;
macro_line|#include &lt;net/irda/irlpt_common.h&gt;
multiline_comment|/* #include &quot;irlpt_client.h&quot; */
multiline_comment|/* #include &quot;irlpt_server.h&quot; */
macro_line|#include &lt;asm/uaccess.h&gt;
macro_line|#include &lt;linux/miscdevice.h&gt;
macro_line|#include &lt;linux/proc_fs.h&gt;
macro_line|#include &lt;linux/fs.h&gt;
DECL|variable|irlpt_service_type
r_char
op_star
id|irlpt_service_type
(braket
)braket
op_assign
(brace
l_string|&quot;IRLPT_UNKNOWN&quot;
comma
l_string|&quot;IRLPT_THREE_WIRE_RAW&quot;
comma
l_string|&quot;IRLPT_THREE_WIRE&quot;
comma
l_string|&quot;IRLPT_NINE_WIRE&quot;
comma
l_string|&quot;IRLPT_CENTRONICS&quot;
comma
l_string|&quot;IRLPT_SERVER_MODE&quot;
comma
)brace
suffix:semicolon
DECL|variable|irlpt_port_type
r_char
op_star
id|irlpt_port_type
(braket
)braket
op_assign
(brace
l_string|&quot;IRLPT_UNKNOWN&quot;
comma
l_string|&quot;IRLPT_SERIAL&quot;
comma
l_string|&quot;IRLPT_PARALLEL&quot;
comma
)brace
suffix:semicolon
DECL|variable|irlpt_connected
r_char
op_star
id|irlpt_connected
(braket
)braket
op_assign
(brace
l_string|&quot;IRLPT_DISCONNECTED&quot;
comma
l_string|&quot;IRLPT_WAITING&quot;
comma
l_string|&quot;IRLPT_CONNECTED&quot;
comma
l_string|&quot;IRLPT_FLUSHED&quot;
comma
)brace
suffix:semicolon
DECL|variable|irlpt_reasons
r_char
op_star
id|irlpt_reasons
(braket
)braket
op_assign
(brace
l_string|&quot;SERVICE_CLOSE&quot;
comma
multiline_comment|/* Service has closed the connection */
l_string|&quot;DISC_INDICATION&quot;
comma
multiline_comment|/* Received disconnect request from peer entity*/
l_string|&quot;NO_RESPONSE&quot;
comma
multiline_comment|/* To many retransmits without response */
l_string|&quot;DEADLOCK_DETECTED&quot;
comma
multiline_comment|/* To many retransmits _with_ response */
l_string|&quot;FOUND_NONE&quot;
comma
multiline_comment|/* No devices were discovered */
l_string|&quot;MEDIA_BUSY&quot;
comma
)brace
suffix:semicolon
DECL|variable|irlpt_client_fsm_state
r_char
op_star
id|irlpt_client_fsm_state
(braket
)braket
op_assign
(brace
l_string|&quot;IRLPT_CLIENT_IDLE&quot;
comma
l_string|&quot;IRLPT_CLIENT_QUERY&quot;
comma
l_string|&quot;IRLPT_CLIENT_READY&quot;
comma
l_string|&quot;IRLPT_CLIENT_WAITI&quot;
comma
l_string|&quot;IRLPT_CLIENT_CONN&quot;
)brace
suffix:semicolon
DECL|variable|irlpt_server_fsm_state
r_char
op_star
id|irlpt_server_fsm_state
(braket
)braket
op_assign
(brace
l_string|&quot;IRLPT_SERVER_IDLE&quot;
comma
l_string|&quot;IRLPT_SERVER_CONN&quot;
)brace
suffix:semicolon
DECL|variable|irlpt_fsm_event
r_char
op_star
id|irlpt_fsm_event
(braket
)braket
op_assign
(brace
l_string|&quot;QUERY_REMOTE_IAS&quot;
comma
l_string|&quot;IAS_PROVIDER_AVAIL&quot;
comma
l_string|&quot;IAS_PROVIDER_NOT_AVAIL&quot;
comma
l_string|&quot;LAP_DISCONNECT&quot;
comma
l_string|&quot;LMP_CONNECT&quot;
comma
l_string|&quot;LMP_DISCONNECT&quot;
comma
l_string|&quot;LMP_CONNECT_INDICATION&quot;
comma
l_string|&quot;LMP_DISCONNECT_INDICATION&quot;
comma
l_string|&quot;IRLPT_DISCOVERY_INDICATION&quot;
comma
l_string|&quot;IRLPT_CONNECT_REQUEST&quot;
comma
l_string|&quot;IRLPT_DISCONNECT_REQUEST&quot;
comma
l_string|&quot;CLIENT_DATA_INDICATION&quot;
comma
)brace
suffix:semicolon
DECL|variable|irlpt_clients
id|hashbin_t
op_star
id|irlpt_clients
op_assign
l_int|NULL
suffix:semicolon
DECL|variable|irlpt_server
r_struct
id|irlpt_cb
op_star
id|irlpt_server
op_assign
l_int|NULL
suffix:semicolon
DECL|variable|irlpt_common_debug
r_int
id|irlpt_common_debug
op_assign
l_int|4
suffix:semicolon
multiline_comment|/* want to change this? please don&squot;t! &n;&t;&t;&t;&t;use irlpt_common_debug=3 on the &n;&t;&t;&t;&t;command line! */
macro_line|#if 0
r_static
r_char
op_star
id|rcsid
op_assign
l_string|&quot;$Id: irlpt_common.c,v 1.6 1998/11/10 22:50:58 dagb Exp $&quot;
suffix:semicolon
macro_line|#endif
DECL|function|irlpt_find_handle
r_struct
id|irlpt_cb
op_star
id|irlpt_find_handle
c_func
(paren
r_int
r_int
id|minor
)paren
(brace
r_struct
id|irlpt_cb
op_star
id|self
suffix:semicolon
id|DEBUG
c_func
(paren
id|irlpt_common_debug
comma
l_string|&quot;--&gt; &quot;
id|__FUNCTION__
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* Check for server */
r_if
c_cond
(paren
id|irlpt_server
op_ne
l_int|NULL
op_logical_and
id|irlpt_server-&gt;ir_dev.minor
op_eq
id|minor
)paren
(brace
id|DEBUG
c_func
(paren
id|irlpt_common_debug
comma
id|__FUNCTION__
l_string|&quot;: irlpt_server file handle!&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|irlpt_server
suffix:semicolon
)brace
multiline_comment|/* Check the clients */
id|self
op_assign
(paren
r_struct
id|irlpt_cb
op_star
)paren
id|hashbin_get_first
c_func
(paren
id|irlpt_clients
)paren
suffix:semicolon
r_while
c_loop
(paren
id|self
)paren
(brace
id|ASSERT
c_func
(paren
id|self-&gt;magic
op_eq
id|IRLPT_MAGIC
comma
r_return
l_int|NULL
suffix:semicolon
)paren
suffix:semicolon
r_if
c_cond
(paren
id|minor
op_eq
id|self-&gt;ir_dev.minor
)paren
r_return
id|self
suffix:semicolon
id|self
op_assign
(paren
r_struct
id|irlpt_cb
op_star
)paren
id|hashbin_get_next
c_func
(paren
id|irlpt_clients
)paren
suffix:semicolon
)brace
id|DEBUG
c_func
(paren
id|irlpt_common_debug
comma
id|__FUNCTION__
l_string|&quot; --&gt;&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
DECL|function|irlpt_read
id|ssize_t
id|irlpt_read
c_func
(paren
r_struct
id|file
op_star
id|file
comma
r_char
op_star
id|buffer
comma
r_int
id|count
comma
id|loff_t
op_star
id|noidea
)paren
(brace
r_int
id|len
op_assign
l_int|0
suffix:semicolon
r_char
op_star
id|ptr
op_assign
id|buffer
suffix:semicolon
r_struct
id|irlpt_cb
op_star
id|self
suffix:semicolon
r_struct
id|sk_buff
op_star
id|skb
op_assign
l_int|NULL
suffix:semicolon
id|DEBUG
c_func
(paren
id|irlpt_common_debug
comma
l_string|&quot;--&gt; &quot;
id|__FUNCTION__
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
id|self
op_assign
id|irlpt_find_handle
c_func
(paren
id|MINOR
c_func
(paren
id|file-&gt;f_dentry-&gt;d_inode-&gt;i_rdev
)paren
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|self
op_ne
l_int|NULL
comma
r_return
l_int|0
suffix:semicolon
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|self-&gt;magic
op_eq
id|IRLPT_MAGIC
comma
r_return
l_int|0
suffix:semicolon
)paren
suffix:semicolon
id|DEBUG
c_func
(paren
id|irlpt_common_debug
comma
id|__FUNCTION__
l_string|&quot;: count=%d, skb_len=%d, connected=%d (%s) eof=%d&bslash;n&quot;
comma
id|count
comma
id|skb_queue_len
c_func
(paren
op_amp
id|self-&gt;rx_queue
)paren
comma
id|self-&gt;connected
comma
id|irlpt_connected
(braket
id|self-&gt;connected
)braket
comma
id|self-&gt;eof
)paren
suffix:semicolon
r_if
c_cond
(paren
id|self-&gt;eof
op_logical_and
op_logical_neg
id|skb_queue_len
c_func
(paren
op_amp
id|self-&gt;rx_queue
)paren
)paren
(brace
r_switch
c_cond
(paren
id|self-&gt;eof
)paren
(brace
r_case
id|LM_USER_REQUEST
suffix:colon
id|self-&gt;eof
op_assign
id|FALSE
suffix:semicolon
id|DEBUG
c_func
(paren
id|irlpt_common_debug
comma
id|__FUNCTION__
l_string|&quot;: returning 0&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
r_case
id|LM_LAP_DISCONNECT
suffix:colon
id|self-&gt;eof
op_assign
id|FALSE
suffix:semicolon
r_return
l_int|0
suffix:semicolon
r_case
id|LM_LAP_RESET
suffix:colon
id|self-&gt;eof
op_assign
id|FALSE
suffix:semicolon
r_return
op_minus
id|ECONNRESET
suffix:semicolon
r_default
suffix:colon
id|self-&gt;eof
op_assign
id|FALSE
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
)brace
r_while
c_loop
(paren
id|len
op_le
id|count
)paren
(brace
id|skb
op_assign
id|skb_dequeue
c_func
(paren
op_amp
id|self-&gt;rx_queue
)paren
suffix:semicolon
r_if
c_cond
(paren
id|skb
op_ne
l_int|NULL
)paren
(brace
id|DEBUG
c_func
(paren
id|irlpt_common_debug
comma
id|__FUNCTION__
l_string|&quot;: len=%d, skb-&gt;len=%d, count=%d&bslash;n&quot;
comma
id|len
comma
(paren
r_int
)paren
id|skb-&gt;len
comma
id|count
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|skb-&gt;len
op_plus
id|len
)paren
OL
id|count
)paren
(brace
id|copy_to_user
c_func
(paren
id|ptr
comma
id|skb-&gt;data
comma
id|skb-&gt;len
)paren
suffix:semicolon
id|len
op_add_assign
id|skb-&gt;len
suffix:semicolon
id|ptr
op_add_assign
id|skb-&gt;len
suffix:semicolon
id|dev_kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
)brace
r_else
(brace
id|skb_queue_head
c_func
(paren
op_amp
id|self-&gt;rx_queue
comma
id|skb
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
r_else
(brace
id|DEBUG
c_func
(paren
id|irlpt_common_debug
comma
id|__FUNCTION__
l_string|&quot;: skb=NULL, len=%d, count=%d, eof=%d&bslash;n&quot;
comma
id|len
comma
id|count
comma
id|self-&gt;eof
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|signal_pending
c_func
(paren
id|current
)paren
op_logical_and
op_logical_neg
id|self-&gt;eof
)paren
(brace
id|interruptible_sleep_on
c_func
(paren
op_amp
id|self-&gt;read_wait
)paren
suffix:semicolon
)brace
r_else
r_break
suffix:semicolon
)brace
)brace
id|DEBUG
c_func
(paren
id|irlpt_common_debug
comma
id|__FUNCTION__
l_string|&quot;: len=%d&bslash;n&quot;
comma
id|len
)paren
suffix:semicolon
id|DEBUG
c_func
(paren
id|irlpt_common_debug
comma
id|__FUNCTION__
l_string|&quot; --&gt;&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|len
suffix:semicolon
)brace
DECL|function|irlpt_write
id|ssize_t
id|irlpt_write
c_func
(paren
r_struct
id|file
op_star
id|file
comma
r_const
r_char
op_star
id|buffer
comma
r_int
id|count
comma
id|loff_t
op_star
id|noidea
)paren
(brace
r_struct
id|irlpt_cb
op_star
id|self
suffix:semicolon
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
id|DEBUG
c_func
(paren
id|irlpt_common_debug
comma
l_string|&quot;--&gt; &quot;
id|__FUNCTION__
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
id|self
op_assign
id|irlpt_find_handle
c_func
(paren
id|MINOR
c_func
(paren
id|file-&gt;f_dentry-&gt;d_inode-&gt;i_rdev
)paren
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|self
op_ne
l_int|NULL
comma
r_return
l_int|0
suffix:semicolon
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|self-&gt;magic
op_eq
id|IRLPT_MAGIC
comma
r_return
l_int|0
suffix:semicolon
)paren
suffix:semicolon
id|DEBUG
c_func
(paren
id|irlpt_common_debug
comma
id|__FUNCTION__
l_string|&quot;: count = %d&bslash;n&quot;
comma
id|count
)paren
suffix:semicolon
id|DEBUG
c_func
(paren
id|irlpt_common_debug
comma
id|__FUNCTION__
l_string|&quot;: pkt_count = %d&bslash;n&quot;
comma
id|self-&gt;pkt_count
)paren
suffix:semicolon
r_if
c_cond
(paren
id|self-&gt;pkt_count
OG
l_int|8
)paren
(brace
id|DEBUG
c_func
(paren
id|irlpt_common_debug
comma
id|__FUNCTION__
l_string|&quot;: too many outstanding buffers, going to sleep&bslash;n&quot;
)paren
suffix:semicolon
id|interruptible_sleep_on
c_func
(paren
op_amp
id|self-&gt;write_wait
)paren
suffix:semicolon
)brace
id|DEBUG
c_func
(paren
id|irlpt_common_debug
comma
id|__FUNCTION__
l_string|&quot;: pkt_count = %d&bslash;n&quot;
comma
id|self-&gt;pkt_count
)paren
suffix:semicolon
r_if
c_cond
(paren
id|self-&gt;state
op_ne
id|IRLPT_CLIENT_CONN
)paren
(brace
id|DEBUG
c_func
(paren
id|irlpt_common_debug
comma
id|__FUNCTION__
l_string|&quot;: state != IRLPT_CONN (possible link problems?)&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENOLINK
suffix:semicolon
)brace
id|DEBUG
c_func
(paren
id|irlpt_common_debug
comma
id|__FUNCTION__
l_string|&quot;: count = %d, irlap_data_size = %d, IRLPT_MAX_HEADER = %d&bslash;n&quot;
comma
id|count
comma
id|self-&gt;irlap_data_size
comma
id|IRLPT_MAX_HEADER
)paren
suffix:semicolon
r_if
c_cond
(paren
id|count
OG
(paren
id|self-&gt;irlap_data_size
op_minus
id|IRLPT_MAX_HEADER
)paren
)paren
(brace
id|count
op_assign
(paren
id|self-&gt;irlap_data_size
op_minus
id|IRLPT_MAX_HEADER
)paren
suffix:semicolon
id|DEBUG
c_func
(paren
id|irlpt_common_debug
comma
id|__FUNCTION__
l_string|&quot;: setting count to %d&bslash;n&quot;
comma
id|count
)paren
suffix:semicolon
)brace
id|DEBUG
c_func
(paren
id|irlpt_common_debug
comma
id|__FUNCTION__
l_string|&quot;: count = %d&bslash;n&quot;
comma
id|count
)paren
suffix:semicolon
id|skb
op_assign
id|dev_alloc_skb
c_func
(paren
id|count
op_plus
id|IRLPT_MAX_HEADER
)paren
suffix:semicolon
r_if
c_cond
(paren
id|skb
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
id|__FUNCTION__
l_string|&quot;: couldn&squot;t allocate skbuff!&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * we use the unused stamp field to hold the device minor&n;&t; * number, so we can look it up when the skb is destroyed.&n;&t; */
op_star
(paren
(paren
id|__u32
op_star
)paren
op_amp
id|skb-&gt;stamp
)paren
op_assign
id|MINOR
c_func
(paren
id|file-&gt;f_dentry-&gt;d_inode-&gt;i_rdev
)paren
suffix:semicolon
id|skb_reserve
c_func
(paren
id|skb
comma
id|IRLPT_MAX_HEADER
)paren
suffix:semicolon
id|skb_put
c_func
(paren
id|skb
comma
id|count
)paren
suffix:semicolon
id|skb-&gt;destructor
op_assign
id|irlpt_flow_control
suffix:semicolon
id|self-&gt;pkt_count
op_increment
suffix:semicolon
id|copy_from_user
c_func
(paren
id|skb-&gt;data
comma
id|buffer
comma
id|count
)paren
suffix:semicolon
id|irlmp_data_request
c_func
(paren
id|self-&gt;lsap
comma
id|skb
)paren
suffix:semicolon
id|irda_start_timer
c_func
(paren
op_amp
id|self-&gt;lpt_timer
comma
l_int|5000
comma
(paren
r_int
r_int
)paren
id|self
comma
id|self-&gt;timeout
)paren
suffix:semicolon
id|DEBUG
c_func
(paren
id|irlpt_common_debug
comma
id|__FUNCTION__
l_string|&quot; --&gt;&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|count
suffix:semicolon
)brace
DECL|function|irlpt_seek
id|loff_t
id|irlpt_seek
c_func
(paren
r_struct
id|file
op_star
id|file
comma
id|loff_t
id|offset
comma
r_int
id|count
)paren
(brace
id|DEBUG
c_func
(paren
id|irlpt_common_debug
comma
l_string|&quot;--&gt; &quot;
id|__FUNCTION__
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
id|DEBUG
c_func
(paren
id|irlpt_common_debug
comma
id|__FUNCTION__
l_string|&quot; --&gt;&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ESPIPE
suffix:semicolon
)brace
multiline_comment|/*&n; * Function irlpt_poll (file, wait)&n; *&n; *    &n; *&n; */
DECL|function|irlpt_poll
id|u_int
id|irlpt_poll
c_func
(paren
r_struct
id|file
op_star
id|file
comma
id|poll_table
op_star
id|wait
)paren
(brace
id|DEBUG
c_func
(paren
id|irlpt_common_debug
comma
l_string|&quot;--&gt; &quot;
id|__FUNCTION__
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* check out /usr/src/pcmcia/modules/ds.c for an example */
id|DEBUG
c_func
(paren
id|irlpt_common_debug
comma
id|__FUNCTION__
l_string|&quot; --&gt;&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * Function open_irlpt (inode, file)&n; *&n; *&n; *&n; */
DECL|function|irlpt_open
r_int
id|irlpt_open
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
)paren
(brace
r_struct
id|irlpt_cb
op_star
id|self
suffix:semicolon
r_struct
id|irlpt_info
id|info
suffix:semicolon
id|DEBUG
c_func
(paren
id|irlpt_common_debug
comma
l_string|&quot;--&gt; &quot;
id|__FUNCTION__
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
id|self
op_assign
id|irlpt_find_handle
c_func
(paren
id|MINOR
c_func
(paren
id|file-&gt;f_dentry-&gt;d_inode-&gt;i_rdev
)paren
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|self
op_ne
l_int|NULL
comma
r_return
op_minus
l_int|1
suffix:semicolon
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|self-&gt;magic
op_eq
id|IRLPT_MAGIC
comma
r_return
op_minus
l_int|1
suffix:semicolon
)paren
suffix:semicolon
r_if
c_cond
(paren
id|self-&gt;count
op_increment
)paren
(brace
id|DEBUG
c_func
(paren
id|irlpt_common_debug
comma
id|__FUNCTION__
l_string|&quot;: count not zero; actual = %d&bslash;n&quot;
comma
id|self-&gt;count
)paren
suffix:semicolon
id|self-&gt;count
op_decrement
suffix:semicolon
r_return
op_minus
id|EBUSY
suffix:semicolon
)brace
id|self-&gt;eof
op_assign
id|FALSE
suffix:semicolon
multiline_comment|/* ok, now, if it&squot;s idle, try to get some information&n;&t;   about the remote end, and sleep till we get totally connected.. */
r_if
c_cond
(paren
(paren
id|self-&gt;servicetype
op_ne
id|IRLPT_SERVER_MODE
)paren
op_logical_and
id|self-&gt;state
op_ne
id|IRLPT_CLIENT_CONN
)paren
(brace
id|DEBUG
c_func
(paren
id|irlpt_common_debug
comma
id|__FUNCTION__
l_string|&quot;: self-&gt;state != IRLPT_CLIENT_CONN&bslash;n&quot;
)paren
suffix:semicolon
id|info.daddr
op_assign
id|self-&gt;daddr
suffix:semicolon
id|info.saddr
op_assign
id|self-&gt;saddr
suffix:semicolon
r_if
c_cond
(paren
id|self-&gt;do_event
op_ne
l_int|NULL
)paren
(brace
id|DEBUG
c_func
(paren
id|irlpt_common_debug
comma
id|__FUNCTION__
l_string|&quot;: doing a discovery..&bslash;n&quot;
)paren
suffix:semicolon
id|self
op_member_access_from_pointer
id|do_event
c_func
(paren
id|self
comma
id|IRLPT_DISCOVERY_INDICATION
comma
l_int|NULL
comma
op_amp
id|info
)paren
suffix:semicolon
id|DEBUG
c_func
(paren
id|irlpt_common_debug
comma
id|__FUNCTION__
l_string|&quot;: sleeping until connected.&bslash;n&quot;
)paren
suffix:semicolon
id|interruptible_sleep_on
c_func
(paren
op_amp
id|self-&gt;read_wait
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* at this point, if it&squot;s a client, we have a connection.&n;&t; * if it&squot;s the server, it&squot;s waiting for a connection.&n;&t; */
id|DEBUG
c_func
(paren
id|irlpt_common_debug
comma
id|__FUNCTION__
l_string|&quot; --&gt;&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * Function close_irlpt (inode, file)&n; *&n; *&n; *&n; */
DECL|function|irlpt_close
r_int
id|irlpt_close
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
)paren
(brace
r_struct
id|irlpt_cb
op_star
id|self
suffix:semicolon
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
r_struct
id|irlpt_info
id|info
suffix:semicolon
id|DEBUG
c_func
(paren
id|irlpt_common_debug
comma
l_string|&quot;--&gt; &quot;
id|__FUNCTION__
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
id|self
op_assign
id|irlpt_find_handle
c_func
(paren
id|MINOR
c_func
(paren
id|file-&gt;f_dentry-&gt;d_inode-&gt;i_rdev
)paren
)paren
suffix:semicolon
id|DEBUG
c_func
(paren
id|irlpt_common_debug
comma
id|__FUNCTION__
l_string|&quot;: have handle!&bslash;n&quot;
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|self
op_ne
l_int|NULL
comma
r_return
op_minus
l_int|1
suffix:semicolon
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|self-&gt;magic
op_eq
id|IRLPT_MAGIC
comma
r_return
op_minus
l_int|1
suffix:semicolon
)paren
suffix:semicolon
id|DEBUG
c_func
(paren
id|irlpt_common_debug
comma
id|__FUNCTION__
l_string|&quot;: self-&gt;count=%d&bslash;n&quot;
comma
id|self-&gt;count
)paren
suffix:semicolon
r_if
c_cond
(paren
id|self-&gt;count
OG
l_int|0
)paren
id|self-&gt;count
op_decrement
suffix:semicolon
r_while
c_loop
(paren
id|self-&gt;pkt_count
OG
l_int|0
)paren
(brace
id|interruptible_sleep_on
c_func
(paren
op_amp
id|self-&gt;write_wait
)paren
suffix:semicolon
)brace
multiline_comment|/* all done, tear down the connection and wait for the next open */
r_if
c_cond
(paren
(paren
id|self-&gt;servicetype
op_ne
id|IRLPT_SERVER_MODE
)paren
op_logical_and
id|self-&gt;state
op_eq
id|IRLPT_CLIENT_CONN
)paren
(brace
id|skb
op_assign
id|dev_alloc_skb
c_func
(paren
l_int|64
)paren
suffix:semicolon
r_if
c_cond
(paren
id|skb
op_eq
l_int|NULL
)paren
(brace
id|DEBUG
c_func
(paren
l_int|0
comma
id|__FUNCTION__
l_string|&quot;(: Could not allocate an &quot;
l_string|&quot;sk_buff of length %d&bslash;n&quot;
comma
l_int|64
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|skb_reserve
c_func
(paren
id|skb
comma
id|LMP_CONTROL_HEADER
op_plus
id|LAP_HEADER
)paren
suffix:semicolon
id|irlmp_disconnect_request
c_func
(paren
id|self-&gt;lsap
comma
id|skb
)paren
suffix:semicolon
id|DEBUG
c_func
(paren
id|irlpt_common_debug
comma
id|__FUNCTION__
l_string|&quot;: irlmp_close_slap(self-&gt;lsap)&bslash;n&quot;
)paren
suffix:semicolon
id|irlmp_close_lsap
c_func
(paren
id|self-&gt;lsap
)paren
suffix:semicolon
)brace
id|info.daddr
op_assign
id|self-&gt;daddr
suffix:semicolon
r_if
c_cond
(paren
id|self-&gt;do_event
op_ne
l_int|NULL
)paren
(brace
id|DEBUG
c_func
(paren
id|irlpt_common_debug
comma
id|__FUNCTION__
l_string|&quot;: closing connection..&bslash;n&quot;
)paren
suffix:semicolon
id|self
op_member_access_from_pointer
id|do_event
c_func
(paren
id|self
comma
id|LMP_DISCONNECT
comma
l_int|NULL
comma
op_amp
id|info
)paren
suffix:semicolon
)brace
id|DEBUG
c_func
(paren
id|irlpt_common_debug
comma
id|__FUNCTION__
l_string|&quot; --&gt;&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|irlpt_dump_buffer
r_void
id|irlpt_dump_buffer
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
)paren
(brace
r_int
id|i
suffix:semicolon
id|DEBUG
c_func
(paren
id|irlpt_common_debug
comma
l_string|&quot;--&gt; &quot;
id|__FUNCTION__
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|skb-&gt;len
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
id|skb-&gt;data
(braket
id|i
)braket
OG
l_int|31
op_logical_and
id|skb-&gt;data
(braket
id|i
)braket
OL
l_int|128
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%c&quot;
comma
id|skb-&gt;data
(braket
id|i
)braket
)paren
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|skb-&gt;data
(braket
id|i
)braket
op_eq
l_int|0x0d
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_else
(brace
id|printk
c_func
(paren
l_string|&quot;.&quot;
)paren
suffix:semicolon
)brace
)brace
id|printk
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
id|DEBUG
c_func
(paren
id|irlpt_common_debug
comma
id|__FUNCTION__
l_string|&quot; --&gt;&bslash;n&quot;
)paren
suffix:semicolon
)brace
DECL|function|irlpt_flow_control
r_void
id|irlpt_flow_control
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
)paren
(brace
r_struct
id|irlpt_cb
op_star
id|self
suffix:semicolon
id|DEBUG
c_func
(paren
id|irlpt_common_debug
comma
l_string|&quot;--&gt; &quot;
id|__FUNCTION__
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
id|self
op_assign
id|irlpt_find_handle
c_func
(paren
op_star
(paren
(paren
id|__u32
op_star
)paren
op_amp
id|skb-&gt;stamp
)paren
)paren
suffix:semicolon
id|self-&gt;pkt_count
op_decrement
suffix:semicolon
id|ASSERT
c_func
(paren
id|self-&gt;pkt_count
op_ge
l_int|0
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
id|DEBUG
c_func
(paren
id|irlpt_common_debug
comma
id|__FUNCTION__
l_string|&quot;: packet destroyed, count = %d&bslash;n&quot;
comma
id|self-&gt;pkt_count
)paren
suffix:semicolon
id|wake_up_interruptible
c_func
(paren
op_amp
id|self-&gt;write_wait
)paren
suffix:semicolon
id|DEBUG
c_func
(paren
id|irlpt_common_debug
comma
id|__FUNCTION__
l_string|&quot; --&gt;&bslash;n&quot;
)paren
suffix:semicolon
)brace
macro_line|#ifdef MODULE
id|MODULE_AUTHOR
c_func
(paren
l_string|&quot;Thomas Davis &lt;ratbert@radiks.net&gt;&quot;
)paren
suffix:semicolon
id|MODULE_DESCRIPTION
c_func
(paren
l_string|&quot;The Linux IrDA/IrLPT common&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|irlpt_common_debug
comma
l_string|&quot;1i&quot;
)paren
suffix:semicolon
multiline_comment|/*&n; * Function init_module (void)&n; *&n; *    Initialize the module, this function is called by the&n; *    modprobe(1) program.&n; */
DECL|function|init_module
r_int
id|init_module
c_func
(paren
r_void
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * Function cleanup_module (void)&n; *&n; *    Remove the module, this function is called by the rmmod(1)&n; *    program&n; */
DECL|function|cleanup_module
r_void
id|cleanup_module
c_func
(paren
r_void
)paren
(brace
)brace
macro_line|#endif /* MODULE */
eof
