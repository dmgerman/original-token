multiline_comment|/*********************************************************************&n; *                &n; * Filename:      irlmp.c&n; * Version:       0.8&n; * Description:   IrDA Link Management Protocol (LMP) layer                 &n; * Status:        Experimental.&n; * Author:        Dag Brattli &lt;dagb@cs.uit.no&gt;&n; * Created at:    Sun Aug 17 20:54:32 1997&n; * Modified at:   Sat Jan 16 22:13:20 1999&n; * Modified by:   Dag Brattli &lt;dagb@cs.uit.no&gt;&n; * &n; *     Copyright (c) 1998 Dag Brattli &lt;dagb@cs.uit.no&gt;, &n; *     All Rights Reserved.&n; *     &n; *     This program is free software; you can redistribute it and/or &n; *     modify it under the terms of the GNU General Public License as &n; *     published by the Free Software Foundation; either version 2 of &n; *     the License, or (at your option) any later version.&n; *&n; *     Neither Dag Brattli nor University of Troms&#xfffd; admit liability nor&n; *     provide warranty for any of this software. This material is &n; *     provided &quot;AS-IS&quot; and at no charge.&n; *&n; ********************************************************************/
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/malloc.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/skbuff.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/proc_fs.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;net/irda/irda.h&gt;
macro_line|#include &lt;net/irda/irmod.h&gt;
macro_line|#include &lt;net/irda/timer.h&gt;
macro_line|#include &lt;net/irda/qos.h&gt;
macro_line|#include &lt;net/irda/irlap.h&gt;
macro_line|#include &lt;net/irda/iriap.h&gt;
macro_line|#include &lt;net/irda/irlmp.h&gt;
macro_line|#include &lt;net/irda/irlmp_frame.h&gt;
macro_line|#include &lt;linux/kmod.h&gt;
multiline_comment|/* Master structure */
DECL|variable|irlmp
r_struct
id|irlmp_cb
op_star
id|irlmp
op_assign
l_int|NULL
suffix:semicolon
DECL|variable|sysctl_discovery
r_int
id|sysctl_discovery
op_assign
l_int|0
suffix:semicolon
DECL|variable|sysctl_devname
r_char
id|sysctl_devname
(braket
l_int|65
)braket
suffix:semicolon
id|__u8
op_star
id|irlmp_hint_to_service
c_func
(paren
id|__u8
op_star
id|hint
)paren
suffix:semicolon
macro_line|#ifdef CONFIG_PROC_FS
r_int
id|irlmp_proc_read
c_func
(paren
r_char
op_star
id|buf
comma
r_char
op_star
op_star
id|start
comma
id|off_t
id|offset
comma
r_int
id|len
comma
r_int
id|unused
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/*&n; * Function irlmp_init (void)&n; *&n; *    Create (allocate) the main IrLMP structure and the pointer array&n; *    which will contain pointers to each instance of a LSAP.&n; */
DECL|function|__initfunc
id|__initfunc
c_func
(paren
r_int
id|irlmp_init
c_func
(paren
r_void
)paren
)paren
(brace
id|DEBUG
c_func
(paren
l_int|4
comma
l_string|&quot;--&gt; irlmp_init&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* Initialize the irlmp structure. */
r_if
c_cond
(paren
id|irlmp
op_eq
l_int|NULL
)paren
(brace
id|irlmp
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|irlmp_cb
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|irlmp
op_eq
l_int|NULL
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|memset
c_func
(paren
id|irlmp
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|irlmp_cb
)paren
)paren
suffix:semicolon
id|irlmp-&gt;magic
op_assign
id|LMP_MAGIC
suffix:semicolon
id|irlmp-&gt;registry
op_assign
id|hashbin_new
c_func
(paren
id|HB_LOCAL
)paren
suffix:semicolon
id|irlmp-&gt;links
op_assign
id|hashbin_new
c_func
(paren
id|HB_LOCAL
)paren
suffix:semicolon
id|irlmp-&gt;unconnected_lsaps
op_assign
id|hashbin_new
c_func
(paren
id|HB_GLOBAL
)paren
suffix:semicolon
id|irlmp-&gt;free_lsap_sel
op_assign
l_int|0x10
suffix:semicolon
multiline_comment|/* Servers use 0x00-0x0f */
macro_line|#ifdef CONFIG_IRDA_CACHE_LAST_LSAP
id|irlmp-&gt;cache.valid
op_assign
id|FALSE
suffix:semicolon
macro_line|#endif
id|strcpy
c_func
(paren
id|sysctl_devname
comma
l_string|&quot;Linux&quot;
)paren
suffix:semicolon
multiline_comment|/* Do discovery every 3 seconds */
id|init_timer
c_func
(paren
op_amp
id|irlmp-&gt;discovery_timer
)paren
suffix:semicolon
id|irlmp_start_discovery_timer
c_func
(paren
id|irlmp
comma
l_int|600
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * Function irlmp_cleanup (void)&n; *&n; *    Remove IrLMP layer&n; *&n; */
DECL|function|irlmp_cleanup
r_void
id|irlmp_cleanup
c_func
(paren
r_void
)paren
(brace
multiline_comment|/* Check for main structure */
id|ASSERT
c_func
(paren
id|irlmp
op_ne
l_int|NULL
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|irlmp-&gt;magic
op_eq
id|LMP_MAGIC
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
id|del_timer
c_func
(paren
op_amp
id|irlmp-&gt;discovery_timer
)paren
suffix:semicolon
multiline_comment|/* FIXME, we need a special function to deallocate LAPs */
id|hashbin_delete
c_func
(paren
id|irlmp-&gt;links
comma
(paren
id|FREE_FUNC
)paren
id|kfree
)paren
suffix:semicolon
id|hashbin_delete
c_func
(paren
id|irlmp-&gt;unconnected_lsaps
comma
(paren
id|FREE_FUNC
)paren
id|kfree
)paren
suffix:semicolon
id|hashbin_delete
c_func
(paren
id|irlmp-&gt;registry
comma
(paren
id|FREE_FUNC
)paren
id|kfree
)paren
suffix:semicolon
multiline_comment|/* De-allocate main structure */
id|kfree
c_func
(paren
id|irlmp
)paren
suffix:semicolon
id|irlmp
op_assign
l_int|NULL
suffix:semicolon
)brace
multiline_comment|/*&n; * Function irlmp_open_lsap (slsap, notify)&n; *&n; *   Register with IrLMP and create a local LSAP,&n; *   returns handle to LSAP.&n; */
DECL|function|irlmp_open_lsap
r_struct
id|lsap_cb
op_star
id|irlmp_open_lsap
c_func
(paren
id|__u8
id|slsap_sel
comma
r_struct
id|notify_t
op_star
id|notify
)paren
(brace
r_struct
id|lsap_cb
op_star
id|self
suffix:semicolon
id|ASSERT
c_func
(paren
id|notify
op_ne
l_int|NULL
comma
r_return
l_int|NULL
suffix:semicolon
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|irlmp
op_ne
l_int|NULL
comma
r_return
l_int|NULL
suffix:semicolon
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|irlmp-&gt;magic
op_eq
id|LMP_MAGIC
comma
r_return
l_int|NULL
suffix:semicolon
)paren
suffix:semicolon
id|DEBUG
c_func
(paren
l_int|4
comma
l_string|&quot;irlmp_open_lsap(), slsap_sel=%02x&bslash;n&quot;
comma
id|slsap_sel
)paren
suffix:semicolon
multiline_comment|/* &n;&t; *  Does the client care which Source LSAP selector it gets? &n;&t; */
r_if
c_cond
(paren
id|slsap_sel
op_eq
id|LSAP_ANY
)paren
(brace
multiline_comment|/*&n;&t;&t; *  Find unused LSAP&n;&t;&t; */
id|slsap_sel
op_assign
id|irlmp_find_free_slsap
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|slsap_sel
op_eq
l_int|0
)paren
r_return
l_int|NULL
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/*&n;&t;&t; *  Client wants specific LSAP, so check if it&squot;s already&n;&t;&t; *  in use&n;&t;&t; */
r_if
c_cond
(paren
id|irlmp_slsap_inuse
c_func
(paren
id|slsap_sel
)paren
)paren
(brace
r_return
l_int|NULL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|slsap_sel
OG
id|irlmp-&gt;free_lsap_sel
)paren
id|irlmp-&gt;free_lsap_sel
op_assign
id|slsap_sel
op_plus
l_int|1
suffix:semicolon
)brace
multiline_comment|/*&n;&t; *  Allocate new instance of a LSAP connection&n;&t; */
id|self
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|lsap_cb
)paren
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
id|self
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;IrLMP: Can&squot;t allocate memory for &quot;
l_string|&quot;LSAP control block!&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
id|memset
c_func
(paren
id|self
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|lsap_cb
)paren
)paren
suffix:semicolon
id|self-&gt;magic
op_assign
id|LMP_LSAP_MAGIC
suffix:semicolon
id|self-&gt;slsap_sel
op_assign
id|slsap_sel
suffix:semicolon
id|self-&gt;dlsap_sel
op_assign
id|LSAP_ANY
suffix:semicolon
id|init_timer
c_func
(paren
op_amp
id|self-&gt;watchdog_timer
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|notify-&gt;instance
op_ne
l_int|NULL
comma
r_return
l_int|NULL
suffix:semicolon
)paren
suffix:semicolon
id|self-&gt;notify
op_assign
op_star
id|notify
suffix:semicolon
id|irlmp_next_lsap_state
c_func
(paren
id|self
comma
id|LSAP_DISCONNECTED
)paren
suffix:semicolon
multiline_comment|/*&n;&t; *  Insert into queue of unconnected LSAPs&n;&t; */
id|hashbin_insert
c_func
(paren
id|irlmp-&gt;unconnected_lsaps
comma
(paren
id|QUEUE
op_star
)paren
id|self
comma
id|self-&gt;slsap_sel
comma
l_int|NULL
)paren
suffix:semicolon
r_return
id|self
suffix:semicolon
)brace
multiline_comment|/*&n; * Function irlmp_close_lsap (self)&n; *&n; *    Remove an instance of a LSAP&n; */
DECL|function|__irlmp_close_lsap
r_static
r_void
id|__irlmp_close_lsap
c_func
(paren
r_struct
id|lsap_cb
op_star
id|self
)paren
(brace
id|DEBUG
c_func
(paren
l_int|4
comma
l_string|&quot;irlmp_close()&bslash;n&quot;
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|self
op_ne
l_int|NULL
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|self-&gt;magic
op_eq
id|LMP_LSAP_MAGIC
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
multiline_comment|/*&n;&t; *  Set some of the variables to preset values&n;&t; */
id|self-&gt;magic
op_assign
op_complement
id|LMP_LSAP_MAGIC
suffix:semicolon
id|del_timer
c_func
(paren
op_amp
id|self-&gt;watchdog_timer
)paren
suffix:semicolon
multiline_comment|/* Important! */
macro_line|#ifdef CONFIG_IRDA_CACHE_LAST_LSAP
id|ASSERT
c_func
(paren
id|irlmp
op_ne
l_int|NULL
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
id|irlmp-&gt;cache.valid
op_assign
id|FALSE
suffix:semicolon
macro_line|#endif
multiline_comment|/*&n;&t; *  Deallocate structure&n;&t; */
id|kfree
c_func
(paren
id|self
)paren
suffix:semicolon
id|DEBUG
c_func
(paren
l_int|4
comma
l_string|&quot;irlmp_close() --&gt;&bslash;n&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Function irlmp_close_lsap (self)&n; *&n; *    &n; *&n; */
DECL|function|irlmp_close_lsap
r_void
id|irlmp_close_lsap
c_func
(paren
r_struct
id|lsap_cb
op_star
id|self
)paren
(brace
r_struct
id|lap_cb
op_star
id|lap
suffix:semicolon
r_struct
id|lsap_cb
op_star
id|lsap
suffix:semicolon
id|ASSERT
c_func
(paren
id|self
op_ne
l_int|NULL
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|self-&gt;magic
op_eq
id|LMP_LSAP_MAGIC
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
id|lap
op_assign
id|self-&gt;lap
suffix:semicolon
multiline_comment|/*&n;&t; *  Find out if we should remove this LSAP from a link or from the&n;&t; *  list of unconnected lsaps (not associated with a link)&n;&t; */
r_if
c_cond
(paren
id|lap
op_eq
l_int|NULL
)paren
(brace
id|lsap
op_assign
id|hashbin_remove
c_func
(paren
id|irlmp-&gt;unconnected_lsaps
comma
id|self-&gt;slsap_sel
comma
l_int|NULL
)paren
suffix:semicolon
)brace
r_else
(brace
id|ASSERT
c_func
(paren
id|lap
op_ne
l_int|NULL
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|lap-&gt;magic
op_eq
id|LMP_LAP_MAGIC
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
id|lsap
op_assign
id|hashbin_remove
c_func
(paren
id|lap-&gt;lsaps
comma
id|self-&gt;slsap_sel
comma
l_int|NULL
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|lsap
op_eq
l_int|NULL
)paren
(brace
id|DEBUG
c_func
(paren
l_int|0
comma
id|__FUNCTION__
l_string|&quot;(), Looks like somebody has removed me already!&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|ASSERT
c_func
(paren
id|lsap
op_eq
id|self
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
id|__irlmp_close_lsap
c_func
(paren
id|self
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Function irlmp_register_irlap (saddr, notify)&n; *&n; *    Register IrLAP layer with IrLMP. There is possible to have multiple&n; *    instances of the IrLAP layer, each connected to different IrDA ports&n; *&n; */
DECL|function|irlmp_register_irlap
r_void
id|irlmp_register_irlap
c_func
(paren
r_struct
id|irlap_cb
op_star
id|irlap
comma
id|__u32
id|saddr
comma
r_struct
id|notify_t
op_star
id|notify
)paren
(brace
r_struct
id|lap_cb
op_star
id|lap
suffix:semicolon
id|DEBUG
c_func
(paren
l_int|4
comma
id|__FUNCTION__
l_string|&quot;(), Registered IrLAP, saddr = %08x&bslash;n&quot;
comma
id|saddr
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|irlmp
op_ne
l_int|NULL
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|irlmp-&gt;magic
op_eq
id|LMP_MAGIC
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|notify
op_ne
l_int|NULL
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
multiline_comment|/*&n;&t; *  Allocate new instance of a LSAP connection&n;&t; */
id|lap
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|lap_cb
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|lap
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;IrLMP: Can&squot;t allocate memory for &quot;
l_string|&quot;LAP control block!&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|memset
c_func
(paren
id|lap
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|lap_cb
)paren
)paren
suffix:semicolon
id|lap-&gt;irlap
op_assign
id|irlap
suffix:semicolon
id|lap-&gt;magic
op_assign
id|LMP_LAP_MAGIC
suffix:semicolon
id|lap-&gt;saddr
op_assign
id|saddr
suffix:semicolon
id|lap-&gt;lsaps
op_assign
id|hashbin_new
c_func
(paren
id|HB_GLOBAL
)paren
suffix:semicolon
id|lap-&gt;cachelog
op_assign
id|hashbin_new
c_func
(paren
id|HB_LOCAL
)paren
suffix:semicolon
id|irlmp_next_lap_state
c_func
(paren
id|lap
comma
id|LAP_STANDBY
)paren
suffix:semicolon
multiline_comment|/*&n;&t; *  Insert into queue of unconnected LSAPs&n;&t; */
id|hashbin_insert
c_func
(paren
id|irlmp-&gt;links
comma
(paren
id|QUEUE
op_star
)paren
id|lap
comma
id|lap-&gt;saddr
comma
l_int|NULL
)paren
suffix:semicolon
multiline_comment|/* &n;&t; *  We set only this variable so IrLAP can tell us on which link the&n;&t; *  different events happened on &n;&t; */
id|irda_notify_init
c_func
(paren
id|notify
)paren
suffix:semicolon
id|notify-&gt;instance
op_assign
id|lap
suffix:semicolon
)brace
multiline_comment|/*&n; * Function irlmp_unregister_irlap (saddr)&n; *&n; *    IrLAP layer has been removed!&n; *&n; */
DECL|function|irlmp_unregister_irlap
r_void
id|irlmp_unregister_irlap
c_func
(paren
id|__u32
id|saddr
)paren
(brace
r_struct
id|lap_cb
op_star
id|self
suffix:semicolon
id|DEBUG
c_func
(paren
l_int|4
comma
id|__FUNCTION__
l_string|&quot;()&bslash;n&quot;
)paren
suffix:semicolon
id|self
op_assign
id|hashbin_remove
c_func
(paren
id|irlmp-&gt;links
comma
id|saddr
comma
l_int|NULL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|self
op_ne
l_int|NULL
)paren
(brace
id|ASSERT
c_func
(paren
id|self-&gt;magic
op_eq
id|LMP_LAP_MAGIC
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
id|self-&gt;magic
op_assign
op_complement
id|LMP_LAP_MAGIC
suffix:semicolon
id|kfree
c_func
(paren
id|self
)paren
suffix:semicolon
)brace
r_else
(brace
id|DEBUG
c_func
(paren
l_int|0
comma
l_string|&quot;irlmp_unregister_irlap(), Didn&squot;t find LAP!&bslash;n&quot;
)paren
suffix:semicolon
)brace
)brace
DECL|function|dump_discoveries
r_void
id|dump_discoveries
c_func
(paren
id|hashbin_t
op_star
id|log
)paren
(brace
id|DISCOVERY
op_star
id|d
suffix:semicolon
id|ASSERT
c_func
(paren
id|log
op_ne
l_int|NULL
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
id|d
op_assign
(paren
id|DISCOVERY
op_star
)paren
id|hashbin_get_first
c_func
(paren
id|log
)paren
suffix:semicolon
r_while
c_loop
(paren
id|d
op_ne
l_int|NULL
)paren
(brace
id|DEBUG
c_func
(paren
l_int|0
comma
l_string|&quot;Discovery:&bslash;n&quot;
)paren
suffix:semicolon
id|DEBUG
c_func
(paren
l_int|0
comma
l_string|&quot;  daddr=%08x&bslash;n&quot;
comma
id|d-&gt;daddr
)paren
suffix:semicolon
id|DEBUG
c_func
(paren
l_int|0
comma
l_string|&quot;  name=%s&bslash;n&quot;
comma
id|d-&gt;info
)paren
suffix:semicolon
id|d
op_assign
(paren
id|DISCOVERY
op_star
)paren
id|hashbin_get_next
c_func
(paren
id|log
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/*&n; * Function irlmp_connect_request (handle, dlsap, userdata)&n; *&n; *    Connect with a peer LSAP  &n; *&n; */
DECL|function|irlmp_connect_request
r_void
id|irlmp_connect_request
c_func
(paren
r_struct
id|lsap_cb
op_star
id|self
comma
id|__u8
id|dlsap_sel
comma
id|__u32
id|daddr
comma
r_struct
id|qos_info
op_star
id|qos
comma
r_struct
id|sk_buff
op_star
id|userdata
)paren
(brace
r_struct
id|sk_buff
op_star
id|skb
op_assign
l_int|NULL
suffix:semicolon
r_struct
id|lap_cb
op_star
id|lap
suffix:semicolon
r_struct
id|lsap_cb
op_star
id|lsap
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|ASSERT
c_func
(paren
id|self
op_ne
l_int|NULL
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|self-&gt;magic
op_eq
id|LMP_LSAP_MAGIC
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
id|DEBUG
c_func
(paren
l_int|4
comma
l_string|&quot;irlmp_connect_request(), &quot;
l_string|&quot;slsap_sel=%02x, dlsap_sel=%02x, daddr=%08x&bslash;n&quot;
comma
id|self-&gt;slsap_sel
comma
id|dlsap_sel
comma
id|daddr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|self-&gt;connected
)paren
(brace
id|DEBUG
c_func
(paren
l_int|0
comma
id|__FUNCTION__
l_string|&quot;(), Error: already connected!!&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/* Any userdata? */
r_if
c_cond
(paren
id|userdata
op_eq
l_int|NULL
)paren
(brace
id|skb
op_assign
id|dev_alloc_skb
c_func
(paren
l_int|64
)paren
suffix:semicolon
r_if
c_cond
(paren
id|skb
op_eq
l_int|NULL
)paren
(brace
id|DEBUG
c_func
(paren
l_int|0
comma
id|__FUNCTION__
l_string|&quot;(), Could not allocate sk_buff of length %d&bslash;n&quot;
comma
l_int|64
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|skb_reserve
c_func
(paren
id|skb
comma
id|LMP_CONTROL_HEADER
op_plus
id|LAP_HEADER
)paren
suffix:semicolon
)brace
r_else
id|skb
op_assign
id|userdata
suffix:semicolon
multiline_comment|/* Make room for MUX control header ( 3 bytes) */
id|ASSERT
c_func
(paren
id|skb_headroom
c_func
(paren
id|skb
)paren
op_ge
id|LMP_CONTROL_HEADER
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
id|skb_push
c_func
(paren
id|skb
comma
id|LMP_CONTROL_HEADER
)paren
suffix:semicolon
id|self-&gt;dlsap_sel
op_assign
id|dlsap_sel
suffix:semicolon
id|self-&gt;tmp_skb
op_assign
id|skb
suffix:semicolon
multiline_comment|/* &n;&t; *  Find out which link to connect on, and make sure nothing strange&n;&t; *  happens while we traverse the list&n;&t; */
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|lap
op_assign
(paren
r_struct
id|lap_cb
op_star
)paren
id|hashbin_get_first
c_func
(paren
id|irlmp-&gt;links
)paren
suffix:semicolon
r_while
c_loop
(paren
id|lap
op_ne
l_int|NULL
)paren
(brace
id|ASSERT
c_func
(paren
id|lap-&gt;magic
op_eq
id|LMP_LAP_MAGIC
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
multiline_comment|/* dump_discoveries( lap-&gt;cachelog); */
r_if
c_cond
(paren
id|hashbin_find
c_func
(paren
id|lap-&gt;cachelog
comma
id|daddr
comma
l_int|NULL
)paren
)paren
(brace
id|DEBUG
c_func
(paren
l_int|4
comma
l_string|&quot;irlmp_connect_request() found link to connect on!&bslash;n&quot;
)paren
suffix:semicolon
id|self-&gt;lap
op_assign
id|lap
suffix:semicolon
r_break
suffix:semicolon
)brace
id|lap
op_assign
(paren
r_struct
id|lap_cb
op_star
)paren
id|hashbin_get_next
c_func
(paren
id|irlmp-&gt;links
)paren
suffix:semicolon
)brace
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
multiline_comment|/* &n;&t; *  Remove LSAP from list of unconnected LSAPs and insert it into the &n;&t; *  list of connected LSAPs for the particular link */
id|lsap
op_assign
id|hashbin_remove
c_func
(paren
id|irlmp-&gt;unconnected_lsaps
comma
id|self-&gt;slsap_sel
comma
l_int|NULL
)paren
suffix:semicolon
multiline_comment|/* Check if we found a link to connect on */
r_if
c_cond
(paren
id|self-&gt;lap
op_eq
l_int|NULL
)paren
(brace
id|DEBUG
c_func
(paren
l_int|0
comma
id|__FUNCTION__
l_string|&quot;(), Unable to find a usable link!&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|ASSERT
c_func
(paren
id|lsap
op_ne
l_int|NULL
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|lsap-&gt;magic
op_eq
id|LMP_LSAP_MAGIC
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|lsap-&gt;lap
op_ne
l_int|NULL
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|lsap-&gt;lap-&gt;magic
op_eq
id|LMP_LAP_MAGIC
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
id|hashbin_insert
c_func
(paren
id|self-&gt;lap-&gt;lsaps
comma
(paren
id|QUEUE
op_star
)paren
id|self
comma
id|self-&gt;slsap_sel
comma
l_int|NULL
)paren
suffix:semicolon
id|self-&gt;connected
op_assign
id|TRUE
suffix:semicolon
multiline_comment|/*&n;&t; *  User supplied qos specifications?&n;&t; */
r_if
c_cond
(paren
id|qos
)paren
id|self-&gt;qos
op_assign
op_star
id|qos
suffix:semicolon
id|DEBUG
c_func
(paren
l_int|4
comma
l_string|&quot;*** Connecting SLSAP=%02x, DLSAP= %02x&bslash;n&quot;
comma
id|self-&gt;slsap_sel
comma
id|self-&gt;dlsap_sel
)paren
suffix:semicolon
id|irlmp_do_lsap_event
c_func
(paren
id|self
comma
id|LM_CONNECT_REQUEST
comma
id|skb
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Function irlmp_connect_indication (self)&n; *&n; *    Incomming connection&n; *&n; */
DECL|function|irlmp_connect_indication
r_void
id|irlmp_connect_indication
c_func
(paren
r_struct
id|lsap_cb
op_star
id|self
comma
r_struct
id|sk_buff
op_star
id|skb
)paren
(brace
r_int
id|max_seg_size
suffix:semicolon
id|DEBUG
c_func
(paren
l_int|4
comma
l_string|&quot;irlmp_connect_indication()&bslash;n&quot;
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|self
op_ne
l_int|NULL
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|self-&gt;magic
op_eq
id|LMP_LSAP_MAGIC
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|skb
op_ne
l_int|NULL
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|self-&gt;lap
op_ne
l_int|NULL
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
id|self-&gt;qos
op_assign
op_star
id|self-&gt;lap-&gt;qos
suffix:semicolon
id|max_seg_size
op_assign
id|self-&gt;lap-&gt;qos-&gt;data_size.value
suffix:semicolon
id|DEBUG
c_func
(paren
l_int|4
comma
id|__FUNCTION__
l_string|&quot;(), max_seg_size=%d&bslash;n&quot;
comma
id|max_seg_size
)paren
suffix:semicolon
multiline_comment|/* Hide LMP_CONTROL_HEADER header from layer above */
id|skb_pull
c_func
(paren
id|skb
comma
id|LMP_CONTROL_HEADER
)paren
suffix:semicolon
r_if
c_cond
(paren
id|self-&gt;notify.connect_indication
)paren
id|self-&gt;notify
dot
id|connect_indication
c_func
(paren
id|self-&gt;notify.instance
comma
id|self
comma
op_amp
id|self-&gt;qos
comma
id|max_seg_size
comma
id|skb
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Function irlmp_connect_response (handle, userdata)&n; *&n; *    Service user is accepting connection&n; *&n; */
DECL|function|irlmp_connect_response
r_void
id|irlmp_connect_response
c_func
(paren
r_struct
id|lsap_cb
op_star
id|self
comma
r_struct
id|sk_buff
op_star
id|userdata
)paren
(brace
id|DEBUG
c_func
(paren
l_int|4
comma
l_string|&quot;irlmp_connect_response()&bslash;n&quot;
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|self
op_ne
l_int|NULL
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|self-&gt;magic
op_eq
id|LMP_LSAP_MAGIC
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|userdata
op_ne
l_int|NULL
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
id|self-&gt;connected
op_assign
id|TRUE
suffix:semicolon
id|DEBUG
c_func
(paren
l_int|4
comma
l_string|&quot;irlmp_connect_response: slsap_sel=%02x, dlsap_sel=%02x&bslash;n&quot;
comma
id|self-&gt;slsap_sel
comma
id|self-&gt;dlsap_sel
)paren
suffix:semicolon
multiline_comment|/* Make room for MUX control header ( 3 bytes) */
id|ASSERT
c_func
(paren
id|skb_headroom
c_func
(paren
id|userdata
)paren
op_ge
id|LMP_CONTROL_HEADER
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
id|skb_push
c_func
(paren
id|userdata
comma
id|LMP_CONTROL_HEADER
)paren
suffix:semicolon
id|irlmp_do_lsap_event
c_func
(paren
id|self
comma
id|LM_CONNECT_RESPONSE
comma
id|userdata
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Function irlmp_connect_confirm (handle, skb)&n; *&n; *    LSAP connection confirmed peer device!&n; */
DECL|function|irlmp_connect_confirm
r_void
id|irlmp_connect_confirm
c_func
(paren
r_struct
id|lsap_cb
op_star
id|self
comma
r_struct
id|sk_buff
op_star
id|skb
)paren
(brace
r_int
id|max_seg_size
suffix:semicolon
id|DEBUG
c_func
(paren
l_int|4
comma
id|__FUNCTION__
l_string|&quot;()&bslash;n&quot;
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|skb
op_ne
l_int|NULL
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|self
op_ne
l_int|NULL
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|self-&gt;magic
op_eq
id|LMP_LSAP_MAGIC
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|self-&gt;lap
op_ne
l_int|NULL
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
id|self-&gt;qos
op_assign
op_star
id|self-&gt;lap-&gt;qos
suffix:semicolon
id|max_seg_size
op_assign
id|self-&gt;qos.data_size.value
suffix:semicolon
id|DEBUG
c_func
(paren
l_int|4
comma
id|__FUNCTION__
l_string|&quot;(), max_seg_size=%d&bslash;n&quot;
comma
id|max_seg_size
)paren
suffix:semicolon
multiline_comment|/* Hide LMP_CONTROL_HEADER header from layer above */
id|skb_pull
c_func
(paren
id|skb
comma
id|LMP_CONTROL_HEADER
)paren
suffix:semicolon
r_if
c_cond
(paren
id|self-&gt;notify.connect_confirm
)paren
(brace
id|self-&gt;notify
dot
id|connect_confirm
c_func
(paren
id|self-&gt;notify.instance
comma
id|self
comma
op_amp
id|self-&gt;qos
comma
id|max_seg_size
comma
id|skb
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/*&n; * Function irlmp_disconnect_request (handle, userdata)&n; *&n; *    The service user is requesting disconnection, this will not remove the &n; *    LSAP, but only mark it as disconnected&n; */
DECL|function|irlmp_disconnect_request
r_void
id|irlmp_disconnect_request
c_func
(paren
r_struct
id|lsap_cb
op_star
id|self
comma
r_struct
id|sk_buff
op_star
id|userdata
)paren
(brace
r_struct
id|lsap_cb
op_star
id|lsap
suffix:semicolon
id|DEBUG
c_func
(paren
l_int|4
comma
l_string|&quot;irlmp_disconnect_request()&bslash;n&quot;
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|self
op_ne
l_int|NULL
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|self-&gt;magic
op_eq
id|LMP_LSAP_MAGIC
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
multiline_comment|/* Already disconnected? */
r_if
c_cond
(paren
op_logical_neg
id|self-&gt;connected
)paren
(brace
id|DEBUG
c_func
(paren
l_int|0
comma
id|__FUNCTION__
l_string|&quot;(), already disconnected!&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|ASSERT
c_func
(paren
id|userdata
op_ne
l_int|NULL
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|self-&gt;connected
op_eq
id|TRUE
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
id|skb_push
c_func
(paren
id|userdata
comma
id|LMP_CONTROL_HEADER
)paren
suffix:semicolon
multiline_comment|/* &n;&t; *  Do the event before the other stuff since we must know&n;&t; *  which lap layer that the frame should be transmitted on&n;&t; */
id|irlmp_do_lsap_event
c_func
(paren
id|self
comma
id|LM_DISCONNECT_REQUEST
comma
id|userdata
)paren
suffix:semicolon
multiline_comment|/* &n;&t; *  Remove LSAP from list of connected LSAPs for the particular link&n;&t; *  and insert it into the list of unconnected LSAPs&n;&t; */
id|ASSERT
c_func
(paren
id|self-&gt;lap
op_ne
l_int|NULL
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|self-&gt;lap-&gt;magic
op_eq
id|LMP_LAP_MAGIC
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|self-&gt;lap-&gt;lsaps
op_ne
l_int|NULL
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
id|lsap
op_assign
id|hashbin_remove
c_func
(paren
id|self-&gt;lap-&gt;lsaps
comma
id|self-&gt;slsap_sel
comma
l_int|NULL
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|lsap
op_ne
l_int|NULL
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|lsap-&gt;magic
op_eq
id|LMP_LSAP_MAGIC
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|lsap
op_eq
id|self
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
id|hashbin_insert
c_func
(paren
id|irlmp-&gt;unconnected_lsaps
comma
(paren
id|QUEUE
op_star
)paren
id|self
comma
id|self-&gt;slsap_sel
comma
l_int|NULL
)paren
suffix:semicolon
multiline_comment|/* Reset some values */
id|self-&gt;connected
op_assign
id|FALSE
suffix:semicolon
id|self-&gt;dlsap_sel
op_assign
id|LSAP_ANY
suffix:semicolon
id|self-&gt;lap
op_assign
l_int|NULL
suffix:semicolon
)brace
multiline_comment|/*&n; * Function irlmp_disconnect_indication (reason, userdata)&n; *&n; *    LSAP is being closed!&n; */
DECL|function|irlmp_disconnect_indication
r_void
id|irlmp_disconnect_indication
c_func
(paren
r_struct
id|lsap_cb
op_star
id|self
comma
id|LM_REASON
id|reason
comma
r_struct
id|sk_buff
op_star
id|userdata
)paren
(brace
r_struct
id|lsap_cb
op_star
id|lsap
suffix:semicolon
id|DEBUG
c_func
(paren
l_int|4
comma
id|__FUNCTION__
l_string|&quot;()&bslash;n&quot;
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|self
op_ne
l_int|NULL
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|self-&gt;magic
op_eq
id|LMP_LSAP_MAGIC
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|self-&gt;connected
op_eq
id|TRUE
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
id|DEBUG
c_func
(paren
l_int|4
comma
id|__FUNCTION__
l_string|&quot;(), slsap_sel=%02x, dlsap_sel=%02x&bslash;n&quot;
comma
id|self-&gt;slsap_sel
comma
id|self-&gt;dlsap_sel
)paren
suffix:semicolon
id|self-&gt;connected
op_assign
id|FALSE
suffix:semicolon
id|self-&gt;dlsap_sel
op_assign
id|LSAP_ANY
suffix:semicolon
multiline_comment|/* &n;&t; *  Remove assosiation betwen this LSAP and the kink it used &n;&t; */
id|ASSERT
c_func
(paren
id|self-&gt;lap
op_ne
l_int|NULL
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|self-&gt;lap-&gt;lsaps
op_ne
l_int|NULL
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
id|lsap
op_assign
id|hashbin_remove
c_func
(paren
id|self-&gt;lap-&gt;lsaps
comma
id|self-&gt;slsap_sel
comma
l_int|NULL
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|lsap
op_ne
l_int|NULL
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|lsap
op_eq
id|self
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
id|hashbin_insert
c_func
(paren
id|irlmp-&gt;unconnected_lsaps
comma
(paren
id|QUEUE
op_star
)paren
id|lsap
comma
id|lsap-&gt;slsap_sel
comma
l_int|NULL
)paren
suffix:semicolon
id|self-&gt;lap
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/* FIXME: the reasons should be extracted somewhere else? */
r_if
c_cond
(paren
id|userdata
)paren
(brace
id|DEBUG
c_func
(paren
l_int|4
comma
id|__FUNCTION__
l_string|&quot;(), reason=%02x&bslash;n&quot;
comma
id|userdata-&gt;data
(braket
l_int|3
)braket
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;&t; *  Inform service user&n;&t; */
r_if
c_cond
(paren
id|self-&gt;notify.disconnect_indication
)paren
(brace
id|self-&gt;notify
dot
id|disconnect_indication
c_func
(paren
id|self-&gt;notify.instance
comma
id|self
comma
id|reason
comma
id|userdata
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/*&n; * Function irlmp_discovery_request (nslots)&n; *&n; *    Do a discovery of devices in front of the computer&n; *&n; */
DECL|function|irlmp_discovery_request
r_void
id|irlmp_discovery_request
c_func
(paren
r_int
id|nslots
)paren
(brace
r_struct
id|lap_cb
op_star
id|lap
suffix:semicolon
id|DEBUG
c_func
(paren
l_int|4
comma
id|__FUNCTION__
l_string|&quot;()&bslash;n&quot;
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|irlmp
op_ne
l_int|NULL
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|sysctl_discovery
)paren
r_return
suffix:semicolon
multiline_comment|/*&n;&t; *  Construct new discovery info to be used by IrLAP,&n;&t; *  TODO: no need to do this every time!&n;&t; */
id|irlmp-&gt;discovery_cmd.hint
(braket
l_int|0
)braket
op_assign
id|irlmp-&gt;hint
(braket
l_int|0
)braket
suffix:semicolon
id|irlmp-&gt;discovery_cmd.hint
(braket
l_int|1
)braket
op_assign
id|irlmp-&gt;hint
(braket
l_int|1
)braket
suffix:semicolon
multiline_comment|/* &n;&t; *  Set character set for device name (we use ASCII), and &n;&t; *  copy device name. Remember to make room for a &bslash;0 at the &n;&t; *  end&n;&t; */
id|irlmp-&gt;discovery_cmd.charset
op_assign
id|CS_ASCII
suffix:semicolon
id|strncpy
c_func
(paren
id|irlmp-&gt;discovery_cmd.info
comma
id|sysctl_devname
comma
l_int|31
)paren
suffix:semicolon
id|irlmp-&gt;discovery_cmd.info_len
op_assign
id|strlen
c_func
(paren
id|irlmp-&gt;discovery_cmd.info
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Try to send discovery packets on all links&n;&t; */
id|lap
op_assign
(paren
r_struct
id|lap_cb
op_star
)paren
id|hashbin_get_first
c_func
(paren
id|irlmp-&gt;links
)paren
suffix:semicolon
r_while
c_loop
(paren
id|lap
op_ne
l_int|NULL
)paren
(brace
id|ASSERT
c_func
(paren
id|lap-&gt;magic
op_eq
id|LMP_LAP_MAGIC
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
id|DEBUG
c_func
(paren
l_int|4
comma
l_string|&quot;irlmp_discovery_request() sending request!&bslash;n&quot;
)paren
suffix:semicolon
id|irlmp_do_lap_event
c_func
(paren
id|lap
comma
id|LM_LAP_DISCOVERY_REQUEST
comma
l_int|NULL
)paren
suffix:semicolon
id|lap
op_assign
(paren
r_struct
id|lap_cb
op_star
)paren
id|hashbin_get_next
c_func
(paren
id|irlmp-&gt;links
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/*&n; * Function irlmp_check_services (discovery)&n; *&n; *    &n; *&n; */
DECL|function|irlmp_check_services
r_void
id|irlmp_check_services
c_func
(paren
id|DISCOVERY
op_star
id|discovery
)paren
(brace
r_struct
id|irlmp_registration
op_star
id|entry
suffix:semicolon
r_struct
id|irmanager_event
id|event
suffix:semicolon
id|__u8
op_star
id|service
suffix:semicolon
r_int
id|i
op_assign
l_int|0
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;IrDA Discovered: %s&bslash;n&quot;
comma
id|discovery-&gt;info
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;    Services: &quot;
)paren
suffix:semicolon
id|service
op_assign
id|irlmp_hint_to_service
c_func
(paren
id|discovery-&gt;hint
)paren
suffix:semicolon
r_if
c_cond
(paren
id|service
op_ne
l_int|NULL
)paren
(brace
multiline_comment|/*&n;&t;&t; *  Check all services on the device&n;&t;&t; */
r_while
c_loop
(paren
id|service
(braket
id|i
)braket
op_ne
id|S_END
)paren
(brace
id|DEBUG
c_func
(paren
l_int|4
comma
l_string|&quot;service=%02x&bslash;n&quot;
comma
id|service
(braket
id|i
)braket
)paren
suffix:semicolon
id|entry
op_assign
id|hashbin_find
c_func
(paren
id|irlmp-&gt;registry
comma
id|service
(braket
id|i
)braket
comma
l_int|NULL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|entry
op_logical_and
id|entry-&gt;discovery_callback
)paren
(brace
id|DEBUG
c_func
(paren
l_int|4
comma
l_string|&quot;discovery_callback!&bslash;n&quot;
)paren
suffix:semicolon
id|entry
op_member_access_from_pointer
id|discovery_callback
c_func
(paren
id|discovery
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* &n;&t;&t;&t;&t; * Found no clients for dealing with this&n;&t;&t;&t;&t; * service, so ask the user space irmanager&n;&t;&t;&t;&t; * to try to load the right module for us&n;&t;&t;&t;&t; */
id|event.event
op_assign
id|EVENT_DEVICE_DISCOVERED
suffix:semicolon
id|event.service
op_assign
id|service
(braket
id|i
)braket
suffix:semicolon
id|event.daddr
op_assign
id|discovery-&gt;daddr
suffix:semicolon
id|sprintf
c_func
(paren
id|event.info
comma
l_string|&quot;%s&quot;
comma
id|discovery-&gt;info
)paren
suffix:semicolon
id|irmanager_notify
c_func
(paren
op_amp
id|event
)paren
suffix:semicolon
)brace
id|i
op_increment
suffix:semicolon
multiline_comment|/* Next service */
)brace
id|kfree
c_func
(paren
id|service
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/*&n; * Function irlmp_discovery_confirm ( self, log)&n; *&n; *    Some device(s) answered to our discovery request! Check to see which&n; *    device it is, and give indication to the client(s)&n; * &n; */
DECL|function|irlmp_discovery_confirm
r_void
id|irlmp_discovery_confirm
c_func
(paren
r_struct
id|lap_cb
op_star
id|self
comma
id|hashbin_t
op_star
id|log
)paren
(brace
id|DISCOVERY
op_star
id|discovery
suffix:semicolon
id|DEBUG
c_func
(paren
l_int|4
comma
id|__FUNCTION__
l_string|&quot;()&bslash;n&quot;
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|self
op_ne
l_int|NULL
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|self-&gt;magic
op_eq
id|LMP_LAP_MAGIC
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
multiline_comment|/*&n;&t; *  Now, check all discovered devices (if any)&n;&t; */
id|discovery
op_assign
(paren
id|DISCOVERY
op_star
)paren
id|hashbin_get_first
c_func
(paren
id|log
)paren
suffix:semicolon
r_while
c_loop
(paren
id|discovery
op_ne
l_int|NULL
)paren
(brace
id|self-&gt;daddr
op_assign
id|discovery-&gt;daddr
suffix:semicolon
id|DEBUG
c_func
(paren
l_int|4
comma
l_string|&quot;discovery-&gt;daddr = 0x%08x&bslash;n&quot;
comma
id|discovery-&gt;daddr
)paren
suffix:semicolon
id|irlmp_check_services
c_func
(paren
id|discovery
)paren
suffix:semicolon
id|discovery
op_assign
(paren
id|DISCOVERY
op_star
)paren
id|hashbin_get_next
c_func
(paren
id|log
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/*&n; * Function irlmp_discovery_indication (discovery)&n; *&n; *    A remote device is discovering us!&n; *&n; */
DECL|function|irlmp_discovery_indication
r_void
id|irlmp_discovery_indication
c_func
(paren
r_struct
id|lap_cb
op_star
id|self
comma
id|DISCOVERY
op_star
id|discovery
)paren
(brace
multiline_comment|/* struct irda_event event; */
id|ASSERT
c_func
(paren
id|self
op_ne
l_int|NULL
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|self-&gt;magic
op_eq
id|LMP_LAP_MAGIC
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|discovery
op_ne
l_int|NULL
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
id|DEBUG
c_func
(paren
l_int|4
comma
id|__FUNCTION__
l_string|&quot;()&bslash;n&quot;
)paren
suffix:semicolon
id|DEBUG
c_func
(paren
l_int|4
comma
l_string|&quot;discovery-&gt;daddr = 0x%08x&bslash;n&quot;
comma
id|discovery-&gt;daddr
)paren
suffix:semicolon
id|self-&gt;daddr
op_assign
id|discovery-&gt;daddr
suffix:semicolon
multiline_comment|/*&n;&t; *  Create a new discovery log if neccessary&n;&t; */
multiline_comment|/* if ( self-&gt;cachelog == NULL) */
multiline_comment|/* &t;&t;self-&gt;cachelog = hashbin_new( HB_LOCAL); */
id|ASSERT
c_func
(paren
id|self-&gt;cachelog
op_ne
l_int|NULL
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
multiline_comment|/*&n;&t; *  Insert this discovery device into the discovery_log if its&n;&t; *  not there already&n;&t; */
r_if
c_cond
(paren
op_logical_neg
id|hashbin_find
c_func
(paren
id|self-&gt;cachelog
comma
id|discovery-&gt;daddr
comma
l_int|NULL
)paren
)paren
id|hashbin_insert
c_func
(paren
id|self-&gt;cachelog
comma
(paren
id|QUEUE
op_star
)paren
id|discovery
comma
id|discovery-&gt;daddr
comma
l_int|NULL
)paren
suffix:semicolon
id|irlmp_check_services
c_func
(paren
id|discovery
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Function irlmp_get_discovery_response ()&n; *&n; *    Used by IrLAP to get the disocvery info it needs when answering&n; *    discovery requests by other devices.&n; */
DECL|function|irlmp_get_discovery_response
id|DISCOVERY
op_star
id|irlmp_get_discovery_response
c_func
(paren
)paren
(brace
id|DEBUG
c_func
(paren
l_int|4
comma
l_string|&quot;irlmp_get_discovery_response()&bslash;n&quot;
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|irlmp
op_ne
l_int|NULL
comma
r_return
l_int|NULL
suffix:semicolon
)paren
suffix:semicolon
id|irlmp-&gt;discovery_rsp.hint
(braket
l_int|0
)braket
op_assign
id|irlmp-&gt;hint
(braket
l_int|0
)braket
suffix:semicolon
id|irlmp-&gt;discovery_rsp.hint
(braket
l_int|1
)braket
op_assign
id|irlmp-&gt;hint
(braket
l_int|1
)braket
suffix:semicolon
multiline_comment|/* &n;&t; *  Set character set for device name (we use ASCII), and &n;&t; *  copy device name. Remember to make room for a &bslash;0 at the &n;&t; *  end&n;&t; */
id|irlmp-&gt;discovery_rsp.charset
op_assign
id|CS_ASCII
suffix:semicolon
id|strncpy
c_func
(paren
id|irlmp-&gt;discovery_rsp.info
comma
id|sysctl_devname
comma
l_int|31
)paren
suffix:semicolon
id|irlmp-&gt;discovery_rsp.info_len
op_assign
id|strlen
c_func
(paren
id|irlmp-&gt;discovery_rsp.info
)paren
op_plus
l_int|2
suffix:semicolon
r_return
op_amp
id|irlmp-&gt;discovery_rsp
suffix:semicolon
)brace
multiline_comment|/*&n; * Function irlmp_data_request (self, skb)&n; *&n; *    Send some data to peer device&n; *&n; */
DECL|function|irlmp_data_request
r_void
id|irlmp_data_request
c_func
(paren
r_struct
id|lsap_cb
op_star
id|self
comma
r_struct
id|sk_buff
op_star
id|skb
)paren
(brace
id|DEBUG
c_func
(paren
l_int|4
comma
id|__FUNCTION__
l_string|&quot;()&bslash;n&quot;
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|skb
op_ne
l_int|NULL
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|self
op_ne
l_int|NULL
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|self-&gt;magic
op_eq
id|LMP_LSAP_MAGIC
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
multiline_comment|/* Make room for MUX header */
id|ASSERT
c_func
(paren
id|skb_headroom
c_func
(paren
id|skb
)paren
op_ge
id|LMP_HEADER
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
id|skb_push
c_func
(paren
id|skb
comma
id|LMP_HEADER
)paren
suffix:semicolon
id|irlmp_do_lsap_event
c_func
(paren
id|self
comma
id|LM_DATA_REQUEST
comma
id|skb
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Function irlmp_data_indication (handle, skb)&n; *&n; *    Got data from LAP layer so pass it up to upper layer&n; *&n; */
DECL|function|irlmp_data_indication
r_void
id|irlmp_data_indication
c_func
(paren
r_struct
id|lsap_cb
op_star
id|self
comma
r_struct
id|sk_buff
op_star
id|skb
)paren
(brace
id|DEBUG
c_func
(paren
l_int|4
comma
l_string|&quot;irlmp_data_indication()&bslash;n&quot;
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|self
op_ne
l_int|NULL
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|self-&gt;magic
op_eq
id|LMP_LSAP_MAGIC
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|skb
op_ne
l_int|NULL
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
multiline_comment|/* Hide LMP header from layer above */
id|skb_pull
c_func
(paren
id|skb
comma
id|LMP_HEADER
)paren
suffix:semicolon
r_if
c_cond
(paren
id|self-&gt;notify.data_indication
)paren
id|self-&gt;notify
dot
id|data_indication
c_func
(paren
id|self-&gt;notify.instance
comma
id|self
comma
id|skb
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Function irlmp_udata_request (self, skb)&n; *&n; *    &n; *&n; */
DECL|function|irlmp_udata_request
r_void
id|irlmp_udata_request
c_func
(paren
r_struct
id|lsap_cb
op_star
id|self
comma
r_struct
id|sk_buff
op_star
id|skb
)paren
(brace
id|DEBUG
c_func
(paren
l_int|4
comma
id|__FUNCTION__
l_string|&quot;()&bslash;n&quot;
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|skb
op_ne
l_int|NULL
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|self
op_ne
l_int|NULL
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|self-&gt;magic
op_eq
id|LMP_LSAP_MAGIC
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
multiline_comment|/* Make room for MUX header */
id|ASSERT
c_func
(paren
id|skb_headroom
c_func
(paren
id|skb
)paren
op_ge
id|LMP_HEADER
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
id|skb_push
c_func
(paren
id|skb
comma
id|LMP_HEADER
)paren
suffix:semicolon
id|irlmp_do_lsap_event
c_func
(paren
id|self
comma
id|LM_UDATA_REQUEST
comma
id|skb
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Function irlmp_udata_indication (self, skb)&n; *&n; *    Send unreliable data (but still within the connection)&n; *&n; */
DECL|function|irlmp_udata_indication
r_void
id|irlmp_udata_indication
c_func
(paren
r_struct
id|lsap_cb
op_star
id|self
comma
r_struct
id|sk_buff
op_star
id|skb
)paren
(brace
id|DEBUG
c_func
(paren
l_int|4
comma
id|__FUNCTION__
l_string|&quot;()&bslash;n&quot;
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|self
op_ne
l_int|NULL
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|self-&gt;magic
op_eq
id|LMP_LSAP_MAGIC
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|skb
op_ne
l_int|NULL
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
multiline_comment|/* Hide LMP header from layer above */
id|skb_pull
c_func
(paren
id|skb
comma
id|LMP_HEADER
)paren
suffix:semicolon
r_if
c_cond
(paren
id|self-&gt;notify.udata_indication
)paren
id|self-&gt;notify
dot
id|udata_indication
c_func
(paren
id|self-&gt;notify.instance
comma
id|self
comma
id|skb
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Function irlmp_connection_less_data_request (skb)&n; *&n; *    Send out of connection UI frames&n; *&n; */
DECL|function|irlmp_connectionless_data_request
r_void
id|irlmp_connectionless_data_request
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
)paren
(brace
id|DEBUG
c_func
(paren
l_int|0
comma
id|__FUNCTION__
l_string|&quot;(), Sorry not implemented&bslash;n&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Function irlmp_connection_less_data_indication (skb)&n; *&n; *    &n; *&n; */
DECL|function|irlmp_connectionless_data_indication
r_void
id|irlmp_connectionless_data_indication
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
)paren
(brace
id|DEBUG
c_func
(paren
l_int|0
comma
id|__FUNCTION__
l_string|&quot;()&bslash;n&quot;
)paren
suffix:semicolon
)brace
DECL|function|irlmp_status_request
r_void
id|irlmp_status_request
c_func
(paren
r_void
)paren
(brace
id|DEBUG
c_func
(paren
l_int|0
comma
l_string|&quot;irlmp_status_request(), Not implemented&bslash;n&quot;
)paren
suffix:semicolon
)brace
DECL|function|irlmp_status_indication
r_void
id|irlmp_status_indication
c_func
(paren
id|LINK_STATUS
id|link
comma
id|LOCK_STATUS
id|lock
)paren
(brace
id|DEBUG
c_func
(paren
l_int|4
comma
l_string|&quot;irlmp_status_indication(), Not implemented&bslash;n&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Function irlmp_hint_to_service (hint)&n; *&n; *    Returns a list of all servics contained in the given hint bits. This&n; *    funtion assumes that the hint bits have the size of two bytes only&n; */
DECL|function|irlmp_hint_to_service
id|__u8
op_star
id|irlmp_hint_to_service
c_func
(paren
id|__u8
op_star
id|hint
)paren
(brace
id|__u8
op_star
id|service
suffix:semicolon
r_int
id|i
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Allocate array to store services in */
id|service
op_assign
id|kmalloc
c_func
(paren
l_int|16
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|service
)paren
(brace
id|DEBUG
c_func
(paren
l_int|0
comma
l_string|&quot;irlmp_hint_to_service: Unable to kmalloc!&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|hint
(braket
l_int|0
)braket
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;&lt;None&gt;&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|hint
(braket
l_int|0
)braket
op_amp
id|HINT_PNP
)paren
id|printk
c_func
(paren
l_string|&quot;PnP Compatible &quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|hint
(braket
l_int|0
)braket
op_amp
id|HINT_PDA
)paren
id|printk
c_func
(paren
l_string|&quot;PDA/Palmtop &quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|hint
(braket
l_int|0
)braket
op_amp
id|HINT_COMPUTER
)paren
id|printk
c_func
(paren
l_string|&quot;Computer &quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|hint
(braket
l_int|0
)braket
op_amp
id|HINT_PRINTER
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;Printer&bslash;n&quot;
)paren
suffix:semicolon
id|service
(braket
id|i
op_increment
)braket
op_assign
id|S_PRINTER
suffix:semicolon
)brace
r_if
c_cond
(paren
id|hint
(braket
l_int|0
)braket
op_amp
id|HINT_MODEM
)paren
id|printk
c_func
(paren
l_string|&quot;Modem &quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|hint
(braket
l_int|0
)braket
op_amp
id|HINT_FAX
)paren
id|printk
c_func
(paren
l_string|&quot;Fax &quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|hint
(braket
l_int|0
)braket
op_amp
id|HINT_LAN
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;LAN Access&bslash;n&quot;
)paren
suffix:semicolon
id|service
(braket
id|i
op_increment
)braket
op_assign
id|S_LAN
suffix:semicolon
)brace
multiline_comment|/* &n;&t; *  Test if extension byte exists. This byte will usually be&n;&t; *  there, but this is not really required by the standard.&n;&t; *  (IrLMP p. 29)&n;&t; */
r_if
c_cond
(paren
id|hint
(braket
l_int|0
)braket
op_amp
id|HINT_EXTENSION
)paren
(brace
r_if
c_cond
(paren
id|hint
(braket
l_int|1
)braket
op_amp
id|HINT_TELEPHONY
)paren
id|printk
c_func
(paren
l_string|&quot;Telephony &quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|hint
(braket
l_int|1
)braket
op_amp
id|HINT_FILE_SERVER
)paren
id|printk
c_func
(paren
l_string|&quot;File Server &quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|hint
(braket
l_int|1
)braket
op_amp
id|HINT_COMM
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;IrCOMM &quot;
)paren
suffix:semicolon
id|service
(braket
id|i
op_increment
)braket
op_assign
id|S_COMM
suffix:semicolon
)brace
r_if
c_cond
(paren
id|hint
(braket
l_int|1
)braket
op_amp
id|HINT_OBEX
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;IrOBEX &quot;
)paren
suffix:semicolon
id|service
(braket
id|i
op_increment
)braket
op_assign
id|S_OBEX
suffix:semicolon
)brace
)brace
id|printk
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
id|service
(braket
id|i
)braket
op_assign
id|S_END
suffix:semicolon
r_return
id|service
suffix:semicolon
)brace
multiline_comment|/*&n; * Function irlmp_service_to_hint (service, hint)&n; *&n; *    &n; *&n; */
DECL|function|irlmp_service_to_hint
r_void
id|irlmp_service_to_hint
c_func
(paren
r_int
id|service
comma
id|__u8
op_star
id|hint
)paren
(brace
r_switch
c_cond
(paren
id|service
)paren
(brace
r_case
id|S_PNP
suffix:colon
id|hint
(braket
l_int|0
)braket
op_or_assign
id|HINT_PNP
suffix:semicolon
r_break
suffix:semicolon
r_case
id|S_PDA
suffix:colon
id|hint
(braket
l_int|0
)braket
op_or_assign
id|HINT_PDA
suffix:semicolon
r_break
suffix:semicolon
r_case
id|S_COMPUTER
suffix:colon
id|hint
(braket
l_int|0
)braket
op_or_assign
id|HINT_COMPUTER
suffix:semicolon
r_break
suffix:semicolon
r_case
id|S_PRINTER
suffix:colon
id|hint
(braket
l_int|0
)braket
op_or_assign
id|HINT_PRINTER
suffix:semicolon
r_break
suffix:semicolon
r_case
id|S_MODEM
suffix:colon
id|hint
(braket
l_int|0
)braket
op_or_assign
id|HINT_PRINTER
suffix:semicolon
r_break
suffix:semicolon
r_case
id|S_LAN
suffix:colon
id|hint
(braket
l_int|0
)braket
op_or_assign
id|HINT_LAN
suffix:semicolon
r_break
suffix:semicolon
r_case
id|S_COMM
suffix:colon
id|hint
(braket
l_int|0
)braket
op_or_assign
id|HINT_EXTENSION
suffix:semicolon
id|hint
(braket
l_int|1
)braket
op_or_assign
id|HINT_COMM
suffix:semicolon
r_break
suffix:semicolon
r_case
id|S_OBEX
suffix:colon
id|hint
(braket
l_int|0
)braket
op_or_assign
id|HINT_EXTENSION
suffix:semicolon
id|hint
(braket
l_int|1
)braket
op_or_assign
id|HINT_OBEX
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|DEBUG
c_func
(paren
l_int|0
comma
l_string|&quot;irlmp_service_to_hint(), Unknown service!&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
multiline_comment|/*&n; * Function irlmp_register (service, type, callback)&n; *&n; *    Register a local client or server with IrLMP&n; *&n; */
DECL|function|irlmp_register_layer
r_void
id|irlmp_register_layer
c_func
(paren
r_int
id|service
comma
r_int
id|type
comma
r_int
id|do_discovery
comma
id|DISCOVERY_CALLBACK
id|callback
)paren
(brace
r_struct
id|irlmp_registration
op_star
id|entry
suffix:semicolon
id|sysctl_discovery
op_or_assign
id|do_discovery
suffix:semicolon
r_if
c_cond
(paren
id|type
op_amp
id|SERVER
)paren
id|irlmp_service_to_hint
c_func
(paren
id|service
comma
id|irlmp-&gt;hint
)paren
suffix:semicolon
multiline_comment|/* Check if this service has been registred before */
id|entry
op_assign
id|hashbin_find
c_func
(paren
id|irlmp-&gt;registry
comma
id|service
comma
l_int|NULL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|entry
op_ne
l_int|NULL
)paren
(brace
multiline_comment|/* Update type in entry */
id|entry-&gt;type
op_or_assign
id|type
suffix:semicolon
multiline_comment|/*  Update callback only if client, since servers don&squot;t &n;&t;&t; *  use callbacks, and we don&squot;t want to overwrite a &n;&t;&t; *  previous registred client callback&n;&t;&t; */
r_if
c_cond
(paren
id|type
op_amp
id|CLIENT
)paren
id|entry-&gt;discovery_callback
op_assign
id|callback
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/* Make a new registration */
id|entry
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|irlmp_registration
)paren
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|entry
)paren
(brace
id|DEBUG
c_func
(paren
l_int|0
comma
l_string|&quot;irlmp_register(), Unable to kmalloc!&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|entry-&gt;service
op_assign
id|service
suffix:semicolon
id|entry-&gt;type
op_assign
id|type
suffix:semicolon
id|entry-&gt;discovery_callback
op_assign
id|callback
suffix:semicolon
id|hashbin_insert
c_func
(paren
id|irlmp-&gt;registry
comma
(paren
id|QUEUE
op_star
)paren
id|entry
comma
id|entry-&gt;service
comma
l_int|NULL
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Function irlmp_unregister (serivice)&n; *&n; *    &n; *&n; */
DECL|function|irlmp_unregister_layer
r_void
id|irlmp_unregister_layer
c_func
(paren
r_int
id|service
comma
r_int
id|type
)paren
(brace
r_struct
id|irlmp_registration
op_star
id|entry
suffix:semicolon
id|DEBUG
c_func
(paren
l_int|4
comma
id|__FUNCTION__
l_string|&quot;()&bslash;n&quot;
)paren
suffix:semicolon
id|entry
op_assign
id|hashbin_find
c_func
(paren
id|irlmp-&gt;registry
comma
id|service
comma
l_int|NULL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|entry
op_ne
l_int|NULL
)paren
(brace
id|DEBUG
c_func
(paren
l_int|4
comma
l_string|&quot;Found entry to change or remove!&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* Remove this type from the service registration */
id|entry-&gt;type
op_and_assign
op_complement
id|type
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|entry
)paren
(brace
id|DEBUG
c_func
(paren
l_int|0
comma
l_string|&quot;Unable to find entry to unregister!&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/* &n;&t; *  Remove entry if there is no more client and server support &n;&t; *  left in entry&n;&t; */
r_if
c_cond
(paren
op_logical_neg
id|entry-&gt;type
)paren
(brace
id|DEBUG
c_func
(paren
l_int|4
comma
id|__FUNCTION__
l_string|&quot;(), removing entry!&bslash;n&quot;
)paren
suffix:semicolon
id|entry
op_assign
id|hashbin_remove
c_func
(paren
id|irlmp-&gt;registry
comma
id|service
comma
l_int|NULL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|entry
op_ne
l_int|NULL
)paren
id|kfree
c_func
(paren
id|entry
)paren
suffix:semicolon
)brace
multiline_comment|/* Remove old hint bits */
id|irlmp-&gt;hint
(braket
l_int|0
)braket
op_assign
l_int|0
suffix:semicolon
id|irlmp-&gt;hint
(braket
l_int|1
)braket
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Refresh current hint bits */
id|entry
op_assign
(paren
r_struct
id|irlmp_registration
op_star
)paren
id|hashbin_get_first
c_func
(paren
id|irlmp-&gt;registry
)paren
suffix:semicolon
r_while
c_loop
(paren
id|entry
op_ne
l_int|NULL
)paren
(brace
r_if
c_cond
(paren
id|entry-&gt;type
op_amp
id|SERVER
)paren
id|irlmp_service_to_hint
c_func
(paren
id|entry-&gt;service
comma
id|irlmp-&gt;hint
)paren
suffix:semicolon
id|entry
op_assign
(paren
r_struct
id|irlmp_registration
op_star
)paren
id|hashbin_get_next
c_func
(paren
id|irlmp-&gt;registry
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/*&n; * Function irlmp_slsap_inuse (slsap)&n; *&n; *    Check if the given source LSAP selector is in use&n; */
DECL|function|irlmp_slsap_inuse
r_int
id|irlmp_slsap_inuse
c_func
(paren
id|__u8
id|slsap_sel
)paren
(brace
r_struct
id|lsap_cb
op_star
id|self
suffix:semicolon
r_struct
id|lap_cb
op_star
id|lap
suffix:semicolon
id|ASSERT
c_func
(paren
id|irlmp
op_ne
l_int|NULL
comma
r_return
id|TRUE
suffix:semicolon
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|irlmp-&gt;magic
op_eq
id|LMP_MAGIC
comma
r_return
id|TRUE
suffix:semicolon
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|slsap_sel
op_ne
id|LSAP_ANY
comma
r_return
id|TRUE
suffix:semicolon
)paren
suffix:semicolon
id|DEBUG
c_func
(paren
l_int|4
comma
l_string|&quot;irlmp_slsap_inuse()&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/*&n;&t; *  Check if slsap is already in use. To do this we have to loop over&n;&t; *  every IrLAP connection and check every LSAP assosiated with each&n;&t; *  the connection.&n;&t; */
id|lap
op_assign
(paren
r_struct
id|lap_cb
op_star
)paren
id|hashbin_get_first
c_func
(paren
id|irlmp-&gt;links
)paren
suffix:semicolon
r_while
c_loop
(paren
id|lap
op_ne
l_int|NULL
)paren
(brace
id|ASSERT
c_func
(paren
id|lap-&gt;magic
op_eq
id|LMP_LAP_MAGIC
comma
r_return
id|TRUE
suffix:semicolon
)paren
suffix:semicolon
id|self
op_assign
(paren
r_struct
id|lsap_cb
op_star
)paren
id|hashbin_get_first
c_func
(paren
id|lap-&gt;lsaps
)paren
suffix:semicolon
r_while
c_loop
(paren
id|self
op_ne
l_int|NULL
)paren
(brace
id|ASSERT
c_func
(paren
id|self-&gt;magic
op_eq
id|LMP_LSAP_MAGIC
comma
r_return
id|TRUE
suffix:semicolon
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|self-&gt;slsap_sel
op_eq
id|slsap_sel
)paren
)paren
multiline_comment|/*  &amp;&amp;  */
multiline_comment|/* &t;&t;&t;    ( self-&gt;dlsap_sel == LSAP_ANY)) */
(brace
id|DEBUG
c_func
(paren
l_int|4
comma
l_string|&quot;Source LSAP selector=%02x in use&bslash;n&quot;
comma
id|self-&gt;slsap_sel
)paren
suffix:semicolon
r_return
id|TRUE
suffix:semicolon
)brace
id|self
op_assign
(paren
r_struct
id|lsap_cb
op_star
)paren
id|hashbin_get_next
c_func
(paren
id|lap-&gt;lsaps
)paren
suffix:semicolon
)brace
id|lap
op_assign
(paren
r_struct
id|lap_cb
op_star
)paren
id|hashbin_get_next
c_func
(paren
id|irlmp-&gt;links
)paren
suffix:semicolon
)brace
r_return
id|FALSE
suffix:semicolon
)brace
multiline_comment|/*&n; * Function irlmp_find_free_slsap ()&n; *&n; *    Find a free source LSAP to use. This function is called if the service&n; *    user has requested a source LSAP equal to LM_ANY&n; */
DECL|function|irlmp_find_free_slsap
id|__u8
id|irlmp_find_free_slsap
c_func
(paren
r_void
)paren
(brace
id|__u8
id|lsap_sel
suffix:semicolon
id|ASSERT
c_func
(paren
id|irlmp
op_ne
l_int|NULL
comma
r_return
op_minus
l_int|1
suffix:semicolon
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|irlmp-&gt;magic
op_eq
id|LMP_MAGIC
comma
r_return
op_minus
l_int|1
suffix:semicolon
)paren
suffix:semicolon
id|lsap_sel
op_assign
id|irlmp-&gt;free_lsap_sel
op_increment
suffix:semicolon
id|DEBUG
c_func
(paren
l_int|4
comma
l_string|&quot;irlmp_find_free_slsap(), picked next free lsap_sel=%02x&bslash;n&quot;
comma
id|lsap_sel
)paren
suffix:semicolon
r_return
id|lsap_sel
suffix:semicolon
)brace
multiline_comment|/*&n; * Function irlmp_convert_lap_reason (lap_reason)&n; *&n; *    Converts IrLAP disconnect reason codes to IrLMP disconnect reason&n; *    codes&n; *&n; */
DECL|function|irlmp_convert_lap_reason
id|LM_REASON
id|irlmp_convert_lap_reason
c_func
(paren
id|LAP_REASON
id|lap_reason
)paren
(brace
r_int
id|reason
op_assign
id|LM_LAP_DISCONNECT
suffix:semicolon
r_switch
c_cond
(paren
id|lap_reason
)paren
(brace
r_case
id|LAP_DISC_INDICATION
suffix:colon
multiline_comment|/* Received a disconnect request from peer */
id|reason
op_assign
id|LM_USER_REQUEST
suffix:semicolon
r_break
suffix:semicolon
r_case
id|LAP_NO_RESPONSE
suffix:colon
multiline_comment|/* To many retransmits without response */
id|reason
op_assign
id|LM_LAP_DISCONNECT
suffix:semicolon
r_break
suffix:semicolon
r_case
id|LAP_RESET_INDICATION
suffix:colon
id|reason
op_assign
id|LM_LAP_RESET
suffix:semicolon
r_break
suffix:semicolon
r_case
id|LAP_FOUND_NONE
suffix:colon
r_case
id|LAP_MEDIA_BUSY
suffix:colon
r_case
id|LAP_PRIMARY_CONFLICT
suffix:colon
id|reason
op_assign
id|LM_CONNECT_FAILURE
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|DEBUG
c_func
(paren
l_int|0
comma
id|__FUNCTION__
l_string|&quot;(), Unknow IrLAP disconnect reason %d!&bslash;n&quot;
comma
id|lap_reason
)paren
suffix:semicolon
id|reason
op_assign
id|LM_LAP_DISCONNECT
suffix:semicolon
r_break
suffix:semicolon
)brace
r_return
id|reason
suffix:semicolon
)brace
macro_line|#ifdef CONFIG_PROC_FS
multiline_comment|/*&n; * Function irlmp_proc_read (buf, start, offset, len, unused)&n; *&n; *    Give some info to the /proc file system&n; *&n; */
DECL|function|irlmp_proc_read
r_int
id|irlmp_proc_read
c_func
(paren
r_char
op_star
id|buf
comma
r_char
op_star
op_star
id|start
comma
id|off_t
id|offset
comma
r_int
id|len
comma
r_int
id|unused
)paren
(brace
r_struct
id|lsap_cb
op_star
id|self
suffix:semicolon
r_struct
id|lap_cb
op_star
id|lap
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|ASSERT
c_func
(paren
id|irlmp
op_ne
l_int|NULL
comma
r_return
l_int|0
suffix:semicolon
)paren
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|len
op_assign
l_int|0
suffix:semicolon
id|len
op_add_assign
id|sprintf
c_func
(paren
id|buf
op_plus
id|len
comma
l_string|&quot;Unconnected LSAPs:&bslash;n&quot;
)paren
suffix:semicolon
id|self
op_assign
(paren
r_struct
id|lsap_cb
op_star
)paren
id|hashbin_get_first
c_func
(paren
id|irlmp-&gt;unconnected_lsaps
)paren
suffix:semicolon
r_while
c_loop
(paren
id|self
op_ne
l_int|NULL
)paren
(brace
id|ASSERT
c_func
(paren
id|self-&gt;magic
op_eq
id|LMP_LSAP_MAGIC
comma
r_return
l_int|0
suffix:semicolon
)paren
suffix:semicolon
id|len
op_add_assign
id|sprintf
c_func
(paren
id|buf
op_plus
id|len
comma
l_string|&quot;lsap state: %s, &quot;
comma
id|irlsap_state
(braket
id|self-&gt;lsap_state
)braket
)paren
suffix:semicolon
id|len
op_add_assign
id|sprintf
c_func
(paren
id|buf
op_plus
id|len
comma
l_string|&quot;slsap_sel: %#02x, dlsap_sel: %#02x, &quot;
comma
id|self-&gt;slsap_sel
comma
id|self-&gt;dlsap_sel
)paren
suffix:semicolon
id|len
op_add_assign
id|sprintf
c_func
(paren
id|buf
op_plus
id|len
comma
l_string|&quot;(%s)&quot;
comma
id|self-&gt;notify.name
)paren
suffix:semicolon
id|len
op_add_assign
id|sprintf
c_func
(paren
id|buf
op_plus
id|len
comma
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
id|self
op_assign
(paren
r_struct
id|lsap_cb
op_star
)paren
id|hashbin_get_next
c_func
(paren
id|irlmp-&gt;unconnected_lsaps
)paren
suffix:semicolon
)brace
id|len
op_add_assign
id|sprintf
c_func
(paren
id|buf
op_plus
id|len
comma
l_string|&quot;&bslash;nRegistred Link Layers:&bslash;n&quot;
)paren
suffix:semicolon
id|lap
op_assign
(paren
r_struct
id|lap_cb
op_star
)paren
id|hashbin_get_first
c_func
(paren
id|irlmp-&gt;links
)paren
suffix:semicolon
r_while
c_loop
(paren
id|lap
op_ne
l_int|NULL
)paren
(brace
id|ASSERT
c_func
(paren
id|lap-&gt;magic
op_eq
id|LMP_LAP_MAGIC
comma
r_return
l_int|0
suffix:semicolon
)paren
suffix:semicolon
id|len
op_add_assign
id|sprintf
c_func
(paren
id|buf
op_plus
id|len
comma
l_string|&quot;lap state: %s, &quot;
comma
id|irlmp_state
(braket
id|lap-&gt;lap_state
)braket
)paren
suffix:semicolon
id|len
op_add_assign
id|sprintf
c_func
(paren
id|buf
op_plus
id|len
comma
l_string|&quot;saddr: %#08x, daddr: %#08x, &quot;
comma
id|lap-&gt;saddr
comma
id|lap-&gt;daddr
)paren
suffix:semicolon
id|len
op_add_assign
id|sprintf
c_func
(paren
id|buf
op_plus
id|len
comma
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
id|len
op_add_assign
id|sprintf
c_func
(paren
id|buf
op_plus
id|len
comma
l_string|&quot;&bslash;nConnected LSAPs:&bslash;n&quot;
)paren
suffix:semicolon
id|self
op_assign
(paren
r_struct
id|lsap_cb
op_star
)paren
id|hashbin_get_first
c_func
(paren
id|lap-&gt;lsaps
)paren
suffix:semicolon
r_while
c_loop
(paren
id|self
op_ne
l_int|NULL
)paren
(brace
id|ASSERT
c_func
(paren
id|self-&gt;magic
op_eq
id|LMP_LSAP_MAGIC
comma
r_return
l_int|0
suffix:semicolon
)paren
suffix:semicolon
id|len
op_add_assign
id|sprintf
c_func
(paren
id|buf
op_plus
id|len
comma
l_string|&quot;lsap state: %s, &quot;
comma
id|irlsap_state
(braket
id|self-&gt;lsap_state
)braket
)paren
suffix:semicolon
id|len
op_add_assign
id|sprintf
c_func
(paren
id|buf
op_plus
id|len
comma
l_string|&quot;slsap_sel: %#02x, dlsap_sel: %#02x, &quot;
comma
id|self-&gt;slsap_sel
comma
id|self-&gt;dlsap_sel
)paren
suffix:semicolon
id|len
op_add_assign
id|sprintf
c_func
(paren
id|buf
op_plus
id|len
comma
l_string|&quot;(%s)&quot;
comma
id|self-&gt;notify.name
)paren
suffix:semicolon
id|len
op_add_assign
id|sprintf
c_func
(paren
id|buf
op_plus
id|len
comma
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
id|self
op_assign
(paren
r_struct
id|lsap_cb
op_star
)paren
id|hashbin_get_next
c_func
(paren
id|lap-&gt;lsaps
)paren
suffix:semicolon
)brace
id|lap
op_assign
(paren
r_struct
id|lap_cb
op_star
)paren
id|hashbin_get_next
c_func
(paren
id|irlmp-&gt;links
)paren
suffix:semicolon
)brace
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
id|len
suffix:semicolon
)brace
macro_line|#endif /* PROC_FS */
eof
