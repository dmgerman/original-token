multiline_comment|/*********************************************************************&n; *                &n; * Filename:      discovery.c&n; * Version:       0.1&n; * Description:   Routines for handling discoveries at the IrLMP layer&n; * Status:        Experimental.&n; * Author:        Dag Brattli &lt;dagb@cs.uit.no&gt;&n; * Created at:    Tue Apr  6 15:33:50 1999&n; * Modified at:   Mon Aug 23 09:48:40 1999&n; * Modified by:   Dag Brattli &lt;dagb@cs.uit.no&gt;&n; * Modified at:   Fri May 28  3:11 CST 1999&n; * Modified by:   Horst von Brand &lt;vonbrand@sleipnir.valparaiso.cl&gt;&n; * &n; *     Copyright (c) 1999 Dag Brattli, All Rights Reserved.&n; *     &n; *     This program is free software; you can redistribute it and/or &n; *     modify it under the terms of the GNU General Public License as &n; *     published by the Free Software Foundation; either version 2 of &n; *     the License, or (at your option) any later version.&n; * &n; *     This program is distributed in the hope that it will be useful,&n; *     but WITHOUT ANY WARRANTY; without even the implied warranty of&n; *     MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the&n; *     GNU General Public License for more details.&n; * &n; *     You should have received a copy of the GNU General Public License &n; *     along with this program; if not, write to the Free Software &n; *     Foundation, Inc., 59 Temple Place, Suite 330, Boston, &n; *     MA 02111-1307 USA&n; *     &n; ********************************************************************/
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/socket.h&gt;
macro_line|#include &lt;linux/irda.h&gt;
macro_line|#include &lt;net/irda/irda.h&gt;
macro_line|#include &lt;net/irda/irlmp.h&gt;
macro_line|#include &lt;net/irda/discovery.h&gt;
multiline_comment|/*&n; * Function irlmp_add_discovery (cachelog, discovery)&n; *&n; *    Add a new discovery to the cachelog, and remove any old discoveries&n; *    from the same device&n; */
DECL|function|irlmp_add_discovery
r_void
id|irlmp_add_discovery
c_func
(paren
id|hashbin_t
op_star
id|cachelog
comma
id|discovery_t
op_star
r_new
)paren
(brace
id|discovery_t
op_star
id|discovery
comma
op_star
id|node
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|irlmp-&gt;lock
comma
id|flags
)paren
suffix:semicolon
multiline_comment|/* &n;&t; * Remove all discoveries of devices that has previously been &n;&t; * discovered on the same link with the same name (info), or the &n;&t; * same daddr. We do this since some devices (mostly PDAs) change&n;&t; * their device address between every discovery.&n;&t; */
id|discovery
op_assign
(paren
id|discovery_t
op_star
)paren
id|hashbin_get_first
c_func
(paren
id|cachelog
)paren
suffix:semicolon
r_while
c_loop
(paren
id|discovery
op_ne
l_int|NULL
)paren
(brace
id|node
op_assign
id|discovery
suffix:semicolon
multiline_comment|/* Be sure to stay one item ahead */
id|discovery
op_assign
(paren
id|discovery_t
op_star
)paren
id|hashbin_get_next
c_func
(paren
id|cachelog
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|node-&gt;daddr
op_eq
r_new
op_member_access_from_pointer
id|daddr
)paren
op_logical_or
(paren
id|strcmp
c_func
(paren
id|node-&gt;nickname
comma
r_new
op_member_access_from_pointer
id|nickname
)paren
op_eq
l_int|0
)paren
)paren
(brace
multiline_comment|/* This discovery is a previous discovery &n;&t;&t;&t;&t; * from the same device, so just remove it&n;&t;&t;&t;&t; */
id|hashbin_remove
c_func
(paren
id|cachelog
comma
id|node-&gt;daddr
comma
l_int|NULL
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|node
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* Insert the new and updated version */
id|hashbin_insert
c_func
(paren
id|cachelog
comma
(paren
id|QUEUE
op_star
)paren
r_new
comma
r_new
op_member_access_from_pointer
id|daddr
comma
l_int|NULL
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|irlmp-&gt;lock
comma
id|flags
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Function irlmp_add_discovery_log (cachelog, log)&n; *&n; *    Merge a disovery log into the cachlog.&n; *&n; */
DECL|function|irlmp_add_discovery_log
r_void
id|irlmp_add_discovery_log
c_func
(paren
id|hashbin_t
op_star
id|cachelog
comma
id|hashbin_t
op_star
id|log
)paren
(brace
id|discovery_t
op_star
id|discovery
suffix:semicolon
id|DEBUG
c_func
(paren
l_int|4
comma
id|__FUNCTION__
l_string|&quot;()&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/*&n;&t; *  If log is missing this means that IrLAP was unable to perform the&n;&t; *  discovery, so restart discovery again with just the half timeout&n;&t; *  of the normal one.&n;&t; */
r_if
c_cond
(paren
id|log
op_eq
l_int|NULL
)paren
(brace
multiline_comment|/* irlmp_start_discovery_timer(irlmp, 150); */
r_return
suffix:semicolon
)brace
id|discovery
op_assign
(paren
id|discovery_t
op_star
)paren
id|hashbin_remove_first
c_func
(paren
id|log
)paren
suffix:semicolon
r_while
c_loop
(paren
id|discovery
op_ne
l_int|NULL
)paren
(brace
id|irlmp_add_discovery
c_func
(paren
id|cachelog
comma
id|discovery
)paren
suffix:semicolon
id|discovery
op_assign
(paren
id|discovery_t
op_star
)paren
id|hashbin_remove_first
c_func
(paren
id|log
)paren
suffix:semicolon
)brace
multiline_comment|/* Delete the now empty log */
id|hashbin_delete
c_func
(paren
id|log
comma
(paren
id|FREE_FUNC
)paren
id|kfree
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Function irlmp_expire_discoveries (log, saddr, force)&n; *&n; *    Go through all discoveries and expire all that has stayed to long&n; *&n; */
DECL|function|irlmp_expire_discoveries
r_void
id|irlmp_expire_discoveries
c_func
(paren
id|hashbin_t
op_star
id|log
comma
id|__u32
id|saddr
comma
r_int
id|force
)paren
(brace
id|discovery_t
op_star
id|discovery
comma
op_star
id|curr
suffix:semicolon
id|DEBUG
c_func
(paren
l_int|4
comma
id|__FUNCTION__
l_string|&quot;()&bslash;n&quot;
)paren
suffix:semicolon
id|discovery
op_assign
(paren
id|discovery_t
op_star
)paren
id|hashbin_get_first
c_func
(paren
id|log
)paren
suffix:semicolon
r_while
c_loop
(paren
id|discovery
op_ne
l_int|NULL
)paren
(brace
id|curr
op_assign
id|discovery
suffix:semicolon
multiline_comment|/* Be sure to be one item ahead */
id|discovery
op_assign
(paren
id|discovery_t
op_star
)paren
id|hashbin_get_next
c_func
(paren
id|log
)paren
suffix:semicolon
multiline_comment|/* Test if it&squot;s time to expire this discovery */
r_if
c_cond
(paren
(paren
id|curr-&gt;saddr
op_eq
id|saddr
)paren
op_logical_and
(paren
id|force
op_logical_or
(paren
(paren
id|jiffies
op_minus
id|curr-&gt;timestamp
)paren
OG
id|DISCOVERY_EXPIRE_TIMEOUT
)paren
)paren
)paren
(brace
id|curr
op_assign
id|hashbin_remove
c_func
(paren
id|log
comma
id|curr-&gt;daddr
comma
l_int|NULL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|curr
)paren
id|kfree
c_func
(paren
id|curr
)paren
suffix:semicolon
)brace
)brace
)brace
multiline_comment|/*&n; * Function irlmp_dump_discoveries (log)&n; *&n; *    Print out all discoveries in log&n; *&n; */
DECL|function|irlmp_dump_discoveries
r_void
id|irlmp_dump_discoveries
c_func
(paren
id|hashbin_t
op_star
id|log
)paren
(brace
id|discovery_t
op_star
id|discovery
suffix:semicolon
id|ASSERT
c_func
(paren
id|log
op_ne
l_int|NULL
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
id|discovery
op_assign
(paren
id|discovery_t
op_star
)paren
id|hashbin_get_first
c_func
(paren
id|log
)paren
suffix:semicolon
r_while
c_loop
(paren
id|discovery
op_ne
l_int|NULL
)paren
(brace
id|DEBUG
c_func
(paren
l_int|0
comma
l_string|&quot;Discovery:&bslash;n&quot;
)paren
suffix:semicolon
id|DEBUG
c_func
(paren
l_int|0
comma
l_string|&quot;  daddr=%08x&bslash;n&quot;
comma
id|discovery-&gt;daddr
)paren
suffix:semicolon
id|DEBUG
c_func
(paren
l_int|0
comma
l_string|&quot;  saddr=%08x&bslash;n&quot;
comma
id|discovery-&gt;saddr
)paren
suffix:semicolon
id|DEBUG
c_func
(paren
l_int|0
comma
l_string|&quot;  nickname=%s&bslash;n&quot;
comma
id|discovery-&gt;nickname
)paren
suffix:semicolon
id|discovery
op_assign
(paren
id|discovery_t
op_star
)paren
id|hashbin_get_next
c_func
(paren
id|log
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/*&n; * Function irlmp_find_device (name, saddr)&n; *&n; *    Look through the discovery log at each of the links and try to find &n; *    the device with the given name. Return daddr and saddr. If saddr is&n; *    specified, that look at that particular link only (not impl).&n; */
DECL|function|irlmp_find_device
id|__u32
id|irlmp_find_device
c_func
(paren
id|hashbin_t
op_star
id|cachelog
comma
r_char
op_star
id|name
comma
id|__u32
op_star
id|saddr
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
id|discovery_t
op_star
id|d
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|irlmp-&gt;lock
comma
id|flags
)paren
suffix:semicolon
multiline_comment|/* Look at all discoveries for that link */
id|d
op_assign
(paren
id|discovery_t
op_star
)paren
id|hashbin_get_first
c_func
(paren
id|cachelog
)paren
suffix:semicolon
r_while
c_loop
(paren
id|d
op_ne
l_int|NULL
)paren
(brace
id|DEBUG
c_func
(paren
l_int|1
comma
l_string|&quot;Discovery:&bslash;n&quot;
)paren
suffix:semicolon
id|DEBUG
c_func
(paren
l_int|1
comma
l_string|&quot;  daddr=%08x&bslash;n&quot;
comma
id|d-&gt;daddr
)paren
suffix:semicolon
id|DEBUG
c_func
(paren
l_int|1
comma
l_string|&quot;  nickname=%s&bslash;n&quot;
comma
id|d-&gt;nickname
)paren
suffix:semicolon
r_if
c_cond
(paren
id|strcmp
c_func
(paren
id|name
comma
id|d-&gt;nickname
)paren
op_eq
l_int|0
)paren
(brace
op_star
id|saddr
op_assign
id|d-&gt;saddr
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|irlmp-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_return
id|d-&gt;daddr
suffix:semicolon
)brace
id|d
op_assign
(paren
id|discovery_t
op_star
)paren
id|hashbin_get_next
c_func
(paren
id|cachelog
)paren
suffix:semicolon
)brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|irlmp-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * Function proc_discovery_read (buf, start, offset, len, unused)&n; *&n; *    Print discovery information in /proc file system&n; *&n; */
DECL|function|discovery_proc_read
r_int
id|discovery_proc_read
c_func
(paren
r_char
op_star
id|buf
comma
r_char
op_star
op_star
id|start
comma
id|off_t
id|offset
comma
r_int
id|len
comma
r_int
id|unused
)paren
(brace
id|discovery_t
op_star
id|discovery
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|hashbin_t
op_star
id|cachelog
op_assign
id|irlmp_get_cachelog
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|irlmp
)paren
r_return
id|len
suffix:semicolon
id|len
op_assign
id|sprintf
c_func
(paren
id|buf
comma
l_string|&quot;IrLMP: Discovery log:&bslash;n&bslash;n&quot;
)paren
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|discovery
op_assign
(paren
id|discovery_t
op_star
)paren
id|hashbin_get_first
c_func
(paren
id|cachelog
)paren
suffix:semicolon
r_while
c_loop
(paren
id|discovery
op_ne
l_int|NULL
)paren
(brace
id|len
op_add_assign
id|sprintf
c_func
(paren
id|buf
op_plus
id|len
comma
l_string|&quot;nickname: %s,&quot;
comma
id|discovery-&gt;nickname
)paren
suffix:semicolon
id|len
op_add_assign
id|sprintf
c_func
(paren
id|buf
op_plus
id|len
comma
l_string|&quot; hint: 0x%02x%02x&quot;
comma
id|discovery-&gt;hints.byte
(braket
l_int|0
)braket
comma
id|discovery-&gt;hints.byte
(braket
l_int|1
)braket
)paren
suffix:semicolon
macro_line|#if 0
r_if
c_cond
(paren
id|discovery-&gt;hints.byte
(braket
l_int|0
)braket
op_amp
id|HINT_PNP
)paren
id|len
op_add_assign
id|sprintf
c_func
(paren
id|buf
op_plus
id|len
comma
l_string|&quot;PnP Compatible &quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|discovery-&gt;hints.byte
(braket
l_int|0
)braket
op_amp
id|HINT_PDA
)paren
id|len
op_add_assign
id|sprintf
c_func
(paren
id|buf
op_plus
id|len
comma
l_string|&quot;PDA/Palmtop &quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|discovery-&gt;hints.byte
(braket
l_int|0
)braket
op_amp
id|HINT_COMPUTER
)paren
id|len
op_add_assign
id|sprintf
c_func
(paren
id|buf
op_plus
id|len
comma
l_string|&quot;Computer &quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|discovery-&gt;hints.byte
(braket
l_int|0
)braket
op_amp
id|HINT_PRINTER
)paren
id|len
op_add_assign
id|sprintf
c_func
(paren
id|buf
op_plus
id|len
comma
l_string|&quot;Printer &quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|discovery-&gt;hints.byte
(braket
l_int|0
)braket
op_amp
id|HINT_MODEM
)paren
id|len
op_add_assign
id|sprintf
c_func
(paren
id|buf
op_plus
id|len
comma
l_string|&quot;Modem &quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|discovery-&gt;hints.byte
(braket
l_int|0
)braket
op_amp
id|HINT_FAX
)paren
id|len
op_add_assign
id|sprintf
c_func
(paren
id|buf
op_plus
id|len
comma
l_string|&quot;Fax &quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|discovery-&gt;hints.byte
(braket
l_int|0
)braket
op_amp
id|HINT_LAN
)paren
id|len
op_add_assign
id|sprintf
c_func
(paren
id|buf
op_plus
id|len
comma
l_string|&quot;LAN Access &quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|discovery-&gt;hints.byte
(braket
l_int|1
)braket
op_amp
id|HINT_TELEPHONY
)paren
id|len
op_add_assign
id|sprintf
c_func
(paren
id|buf
op_plus
id|len
comma
l_string|&quot;Telephony &quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|discovery-&gt;hints.byte
(braket
l_int|1
)braket
op_amp
id|HINT_FILE_SERVER
)paren
id|len
op_add_assign
id|sprintf
c_func
(paren
id|buf
op_plus
id|len
comma
l_string|&quot;File Server &quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|discovery-&gt;hints.byte
(braket
l_int|1
)braket
op_amp
id|HINT_COMM
)paren
id|len
op_add_assign
id|sprintf
c_func
(paren
id|buf
op_plus
id|len
comma
l_string|&quot;IrCOMM &quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|discovery-&gt;hints.byte
(braket
l_int|1
)braket
op_amp
id|HINT_OBEX
)paren
id|len
op_add_assign
id|sprintf
c_func
(paren
id|buf
op_plus
id|len
comma
l_string|&quot;IrOBEX &quot;
)paren
suffix:semicolon
macro_line|#endif&t;&t;
id|len
op_add_assign
id|sprintf
c_func
(paren
id|buf
op_plus
id|len
comma
l_string|&quot;, saddr: 0x%08x&quot;
comma
id|discovery-&gt;saddr
)paren
suffix:semicolon
id|len
op_add_assign
id|sprintf
c_func
(paren
id|buf
op_plus
id|len
comma
l_string|&quot;, daddr: 0x%08x&bslash;n&quot;
comma
id|discovery-&gt;daddr
)paren
suffix:semicolon
id|len
op_add_assign
id|sprintf
c_func
(paren
id|buf
op_plus
id|len
comma
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
id|discovery
op_assign
(paren
id|discovery_t
op_star
)paren
id|hashbin_get_next
c_func
(paren
id|cachelog
)paren
suffix:semicolon
)brace
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
id|len
suffix:semicolon
)brace
eof
