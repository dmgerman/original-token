multiline_comment|/*********************************************************************&n; *                &n; * Filename:      irlmp_event.c&n; * Version:       0.8&n; * Description:   An IrDA LMP event driver for Linux&n; * Status:        Experimental.&n; * Author:        Dag Brattli &lt;dagb@cs.uit.no&gt;&n; * Created at:    Mon Aug  4 20:40:53 1997&n; * Modified at:   Tue Dec 14 23:04:16 1999&n; * Modified by:   Dag Brattli &lt;dagb@cs.uit.no&gt;&n; * &n; *     Copyright (c) 1998-1999 Dag Brattli &lt;dagb@cs.uit.no&gt;, &n; *     All Rights Reserved.&n; *     &n; *     This program is free software; you can redistribute it and/or &n; *     modify it under the terms of the GNU General Public License as &n; *     published by the Free Software Foundation; either version 2 of &n; *     the License, or (at your option) any later version.&n; *&n; *     Neither Dag Brattli nor University of Troms&#xfffd; admit liability nor&n; *     provide warranty for any of this software. This material is &n; *     provided &quot;AS-IS&quot; and at no charge.&n; *&n; ********************************************************************/
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;net/irda/irda.h&gt;
macro_line|#include &lt;net/irda/timer.h&gt;
macro_line|#include &lt;net/irda/irlap.h&gt;
macro_line|#include &lt;net/irda/irlmp.h&gt;
macro_line|#include &lt;net/irda/irlmp_frame.h&gt;
macro_line|#include &lt;net/irda/irlmp_event.h&gt;
DECL|variable|irlmp_state
r_const
r_char
op_star
id|irlmp_state
(braket
)braket
op_assign
(brace
l_string|&quot;LAP_STANDBY&quot;
comma
l_string|&quot;LAP_U_CONNECT&quot;
comma
l_string|&quot;LAP_ACTIVE&quot;
comma
)brace
suffix:semicolon
DECL|variable|irlsap_state
r_const
r_char
op_star
id|irlsap_state
(braket
)braket
op_assign
(brace
l_string|&quot;LSAP_DISCONNECTED&quot;
comma
l_string|&quot;LSAP_CONNECT&quot;
comma
l_string|&quot;LSAP_CONNECT_PEND&quot;
comma
l_string|&quot;LSAP_DATA_TRANSFER_READY&quot;
comma
l_string|&quot;LSAP_SETUP&quot;
comma
l_string|&quot;LSAP_SETUP_PEND&quot;
comma
)brace
suffix:semicolon
DECL|variable|irlmp_event
r_static
r_const
r_char
op_star
id|irlmp_event
(braket
)braket
op_assign
(brace
l_string|&quot;LM_CONNECT_REQUEST&quot;
comma
l_string|&quot;LM_CONNECT_CONFIRM&quot;
comma
l_string|&quot;LM_CONNECT_RESPONSE&quot;
comma
l_string|&quot;LM_CONNECT_INDICATION&quot;
comma
l_string|&quot;LM_DISCONNECT_INDICATION&quot;
comma
l_string|&quot;LM_DISCONNECT_REQUEST&quot;
comma
l_string|&quot;LM_DATA_REQUEST&quot;
comma
l_string|&quot;LM_UDATA_REQUEST&quot;
comma
l_string|&quot;LM_DATA_INDICATION&quot;
comma
l_string|&quot;LM_UDATA_INDICATION&quot;
comma
l_string|&quot;LM_WATCHDOG_TIMEOUT&quot;
comma
multiline_comment|/* IrLAP events */
l_string|&quot;LM_LAP_CONNECT_REQUEST&quot;
comma
l_string|&quot;LM_LAP_CONNECT_INDICATION&quot;
comma
l_string|&quot;LM_LAP_CONNECT_CONFIRM&quot;
comma
l_string|&quot;LM_LAP_DISCONNECT_INDICATION&quot;
comma
l_string|&quot;LM_LAP_DISCONNECT_REQUEST&quot;
comma
l_string|&quot;LM_LAP_DISCOVERY_REQUEST&quot;
comma
l_string|&quot;LM_LAP_DISCOVERY_CONFIRM&quot;
comma
l_string|&quot;LM_LAP_IDLE_TIMEOUT&quot;
comma
)brace
suffix:semicolon
multiline_comment|/* LAP Connection control proto declarations */
r_static
r_void
id|irlmp_state_standby
(paren
r_struct
id|lap_cb
op_star
comma
id|IRLMP_EVENT
comma
r_struct
id|sk_buff
op_star
)paren
suffix:semicolon
r_static
r_void
id|irlmp_state_u_connect
c_func
(paren
r_struct
id|lap_cb
op_star
comma
id|IRLMP_EVENT
comma
r_struct
id|sk_buff
op_star
)paren
suffix:semicolon
r_static
r_void
id|irlmp_state_active
(paren
r_struct
id|lap_cb
op_star
comma
id|IRLMP_EVENT
comma
r_struct
id|sk_buff
op_star
)paren
suffix:semicolon
multiline_comment|/* LSAP Connection control proto declarations */
r_static
r_int
id|irlmp_state_disconnected
c_func
(paren
r_struct
id|lsap_cb
op_star
comma
id|IRLMP_EVENT
comma
r_struct
id|sk_buff
op_star
)paren
suffix:semicolon
r_static
r_int
id|irlmp_state_connect
(paren
r_struct
id|lsap_cb
op_star
comma
id|IRLMP_EVENT
comma
r_struct
id|sk_buff
op_star
)paren
suffix:semicolon
r_static
r_int
id|irlmp_state_connect_pend
c_func
(paren
r_struct
id|lsap_cb
op_star
comma
id|IRLMP_EVENT
comma
r_struct
id|sk_buff
op_star
)paren
suffix:semicolon
r_static
r_int
id|irlmp_state_dtr
(paren
r_struct
id|lsap_cb
op_star
comma
id|IRLMP_EVENT
comma
r_struct
id|sk_buff
op_star
)paren
suffix:semicolon
r_static
r_int
id|irlmp_state_setup
(paren
r_struct
id|lsap_cb
op_star
comma
id|IRLMP_EVENT
comma
r_struct
id|sk_buff
op_star
)paren
suffix:semicolon
r_static
r_int
id|irlmp_state_setup_pend
(paren
r_struct
id|lsap_cb
op_star
comma
id|IRLMP_EVENT
comma
r_struct
id|sk_buff
op_star
)paren
suffix:semicolon
DECL|variable|lap_state
r_static
r_void
(paren
op_star
id|lap_state
(braket
)braket
)paren
(paren
r_struct
id|lap_cb
op_star
comma
id|IRLMP_EVENT
comma
r_struct
id|sk_buff
op_star
)paren
op_assign
(brace
id|irlmp_state_standby
comma
id|irlmp_state_u_connect
comma
id|irlmp_state_active
comma
)brace
suffix:semicolon
DECL|variable|lsap_state
r_static
r_int
(paren
op_star
id|lsap_state
(braket
)braket
)paren
(paren
r_struct
id|lsap_cb
op_star
comma
id|IRLMP_EVENT
comma
r_struct
id|sk_buff
op_star
)paren
op_assign
(brace
id|irlmp_state_disconnected
comma
id|irlmp_state_connect
comma
id|irlmp_state_connect_pend
comma
id|irlmp_state_dtr
comma
id|irlmp_state_setup
comma
id|irlmp_state_setup_pend
)brace
suffix:semicolon
multiline_comment|/* Do connection control events */
DECL|function|irlmp_do_lsap_event
r_int
id|irlmp_do_lsap_event
c_func
(paren
r_struct
id|lsap_cb
op_star
id|self
comma
id|IRLMP_EVENT
id|event
comma
r_struct
id|sk_buff
op_star
id|skb
)paren
(brace
id|ASSERT
c_func
(paren
id|self
op_ne
l_int|NULL
comma
r_return
op_minus
l_int|1
suffix:semicolon
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|self-&gt;magic
op_eq
id|LMP_LSAP_MAGIC
comma
r_return
op_minus
l_int|1
suffix:semicolon
)paren
suffix:semicolon
id|IRDA_DEBUG
c_func
(paren
l_int|4
comma
id|__FUNCTION__
l_string|&quot;(), EVENT = %s, STATE = %s&bslash;n&quot;
comma
id|irlmp_event
(braket
id|event
)braket
comma
id|irlsap_state
(braket
id|self-&gt;lsap_state
)braket
)paren
suffix:semicolon
r_return
(paren
op_star
id|lsap_state
(braket
id|self-&gt;lsap_state
)braket
)paren
(paren
id|self
comma
id|event
comma
id|skb
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Function do_lap_event (event, skb, info)&n; *&n; *    Do IrLAP control events&n; *&n; */
DECL|function|irlmp_do_lap_event
r_void
id|irlmp_do_lap_event
c_func
(paren
r_struct
id|lap_cb
op_star
id|self
comma
id|IRLMP_EVENT
id|event
comma
r_struct
id|sk_buff
op_star
id|skb
)paren
(brace
id|ASSERT
c_func
(paren
id|self
op_ne
l_int|NULL
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|self-&gt;magic
op_eq
id|LMP_LAP_MAGIC
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
id|IRDA_DEBUG
c_func
(paren
l_int|4
comma
id|__FUNCTION__
l_string|&quot;(), EVENT = %s, STATE = %s&bslash;n&quot;
comma
id|irlmp_event
(braket
id|event
)braket
comma
id|irlmp_state
(braket
id|self-&gt;lap_state
)braket
)paren
suffix:semicolon
(paren
op_star
id|lap_state
(braket
id|self-&gt;lap_state
)braket
)paren
(paren
id|self
comma
id|event
comma
id|skb
)paren
suffix:semicolon
)brace
DECL|function|irlmp_discovery_timer_expired
r_void
id|irlmp_discovery_timer_expired
c_func
(paren
r_void
op_star
id|data
)paren
(brace
id|IRDA_DEBUG
c_func
(paren
l_int|4
comma
id|__FUNCTION__
l_string|&quot;()&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sysctl_discovery
)paren
id|irlmp_do_discovery
c_func
(paren
id|sysctl_discovery_slots
)paren
suffix:semicolon
multiline_comment|/* Restart timer */
id|irlmp_start_discovery_timer
c_func
(paren
id|irlmp
comma
id|sysctl_discovery_timeout
op_star
id|HZ
)paren
suffix:semicolon
)brace
DECL|function|irlmp_watchdog_timer_expired
r_void
id|irlmp_watchdog_timer_expired
c_func
(paren
r_void
op_star
id|data
)paren
(brace
r_struct
id|lsap_cb
op_star
id|self
op_assign
(paren
r_struct
id|lsap_cb
op_star
)paren
id|data
suffix:semicolon
id|IRDA_DEBUG
c_func
(paren
l_int|2
comma
id|__FUNCTION__
l_string|&quot;()&bslash;n&quot;
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|self
op_ne
l_int|NULL
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|self-&gt;magic
op_eq
id|LMP_LSAP_MAGIC
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
id|irlmp_do_lsap_event
c_func
(paren
id|self
comma
id|LM_WATCHDOG_TIMEOUT
comma
l_int|NULL
)paren
suffix:semicolon
)brace
DECL|function|irlmp_idle_timer_expired
r_void
id|irlmp_idle_timer_expired
c_func
(paren
r_void
op_star
id|data
)paren
(brace
r_struct
id|lap_cb
op_star
id|self
op_assign
(paren
r_struct
id|lap_cb
op_star
)paren
id|data
suffix:semicolon
id|IRDA_DEBUG
c_func
(paren
l_int|2
comma
id|__FUNCTION__
l_string|&quot;()&bslash;n&quot;
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|self
op_ne
l_int|NULL
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|self-&gt;magic
op_eq
id|LMP_LAP_MAGIC
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
id|irlmp_do_lap_event
c_func
(paren
id|self
comma
id|LM_LAP_IDLE_TIMEOUT
comma
l_int|NULL
)paren
suffix:semicolon
)brace
multiline_comment|/*********************************************************************&n; *&n; *    LAP connection control states&n; *&n; ********************************************************************/
multiline_comment|/*&n; * Function irlmp_state_standby (event, skb, info)&n; *&n; *    STANDBY, The IrLAP connection does not exist.&n; *&n; */
DECL|function|irlmp_state_standby
r_static
r_void
id|irlmp_state_standby
c_func
(paren
r_struct
id|lap_cb
op_star
id|self
comma
id|IRLMP_EVENT
id|event
comma
r_struct
id|sk_buff
op_star
id|skb
)paren
(brace
id|IRDA_DEBUG
c_func
(paren
l_int|4
comma
id|__FUNCTION__
l_string|&quot;()&bslash;n&quot;
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|self-&gt;irlap
op_ne
l_int|NULL
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|event
)paren
(brace
r_case
id|LM_LAP_DISCOVERY_REQUEST
suffix:colon
multiline_comment|/* irlmp_next_station_state( LMP_DISCOVER); */
id|irlap_discovery_request
c_func
(paren
id|self-&gt;irlap
comma
op_amp
id|irlmp-&gt;discovery_cmd
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|LM_LAP_DISCOVERY_CONFIRM
suffix:colon
multiline_comment|/* irlmp_next_station_state( LMP_READY); */
id|irlmp_discovery_confirm
c_func
(paren
id|irlmp-&gt;cachelog
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|LM_LAP_CONNECT_INDICATION
suffix:colon
multiline_comment|/*  It&squot;s important to switch state first, to avoid IrLMP to &n;&t;&t; *  think that the link is free since IrLMP may then start&n;&t;&t; *  discovery before the connection is properly set up. DB.&n;&t;&t; */
id|irlmp_next_lap_state
c_func
(paren
id|self
comma
id|LAP_ACTIVE
)paren
suffix:semicolon
multiline_comment|/* Just accept connection TODO, this should be fixed */
id|irlap_connect_response
c_func
(paren
id|self-&gt;irlap
comma
id|skb
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|LM_LAP_CONNECT_REQUEST
suffix:colon
id|IRDA_DEBUG
c_func
(paren
l_int|4
comma
id|__FUNCTION__
l_string|&quot;() LS_CONNECT_REQUEST&bslash;n&quot;
)paren
suffix:semicolon
id|irlmp_next_lap_state
c_func
(paren
id|self
comma
id|LAP_U_CONNECT
)paren
suffix:semicolon
id|self-&gt;refcount
op_increment
suffix:semicolon
multiline_comment|/* FIXME: need to set users requested QoS */
id|irlap_connect_request
c_func
(paren
id|self-&gt;irlap
comma
id|self-&gt;daddr
comma
l_int|NULL
comma
l_int|0
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|LM_LAP_DISCONNECT_INDICATION
suffix:colon
id|IRDA_DEBUG
c_func
(paren
l_int|4
comma
id|__FUNCTION__
l_string|&quot;(), Error LM_LAP_DISCONNECT_INDICATION&bslash;n&quot;
)paren
suffix:semicolon
id|irlmp_next_lap_state
c_func
(paren
id|self
comma
id|LAP_STANDBY
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|IRDA_DEBUG
c_func
(paren
l_int|0
comma
id|__FUNCTION__
l_string|&quot;(), Unknown event %s&bslash;n&quot;
comma
id|irlmp_event
(braket
id|event
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
id|skb
)paren
id|dev_kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
multiline_comment|/*&n; * Function irlmp_state_u_connect (event, skb, info)&n; *&n; *    U_CONNECT, The layer above has tried to open an LSAP connection but&n; *    since the IrLAP connection does not exist, we must first start an&n; *    IrLAP connection. We are now waiting response from IrLAP.&n; * */
DECL|function|irlmp_state_u_connect
r_static
r_void
id|irlmp_state_u_connect
c_func
(paren
r_struct
id|lap_cb
op_star
id|self
comma
id|IRLMP_EVENT
id|event
comma
r_struct
id|sk_buff
op_star
id|skb
)paren
(brace
r_struct
id|lsap_cb
op_star
id|lsap
suffix:semicolon
r_struct
id|lsap_cb
op_star
id|lsap_current
suffix:semicolon
id|IRDA_DEBUG
c_func
(paren
l_int|2
comma
id|__FUNCTION__
l_string|&quot;(), event=%s&bslash;n&quot;
comma
id|irlmp_event
(braket
id|event
)braket
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|event
)paren
(brace
r_case
id|LM_LAP_CONNECT_INDICATION
suffix:colon
multiline_comment|/*  It&squot;s important to switch state first, to avoid IrLMP to &n;&t;&t; *  think that the link is free since IrLMP may then start&n;&t;&t; *  discovery before the connection is properly set up. DB.&n;&t;&t; */
id|irlmp_next_lap_state
c_func
(paren
id|self
comma
id|LAP_ACTIVE
)paren
suffix:semicolon
multiline_comment|/* Just accept connection TODO, this should be fixed */
id|irlap_connect_response
c_func
(paren
id|self-&gt;irlap
comma
id|skb
)paren
suffix:semicolon
id|lsap
op_assign
(paren
r_struct
id|lsap_cb
op_star
)paren
id|hashbin_get_first
c_func
(paren
id|self-&gt;lsaps
)paren
suffix:semicolon
r_while
c_loop
(paren
id|lsap
op_ne
l_int|NULL
)paren
(brace
id|irlmp_do_lsap_event
c_func
(paren
id|lsap
comma
id|LM_LAP_CONNECT_CONFIRM
comma
l_int|NULL
)paren
suffix:semicolon
id|lsap
op_assign
(paren
r_struct
id|lsap_cb
op_star
)paren
id|hashbin_get_next
c_func
(paren
id|self-&gt;lsaps
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|LM_LAP_CONNECT_REQUEST
suffix:colon
multiline_comment|/* Already trying to connect */
id|self-&gt;refcount
op_increment
suffix:semicolon
r_break
suffix:semicolon
r_case
id|LM_LAP_CONNECT_CONFIRM
suffix:colon
multiline_comment|/* For all lsap_ce E Associated do LS_Connect_confirm */
id|irlmp_next_lap_state
c_func
(paren
id|self
comma
id|LAP_ACTIVE
)paren
suffix:semicolon
id|lsap
op_assign
(paren
r_struct
id|lsap_cb
op_star
)paren
id|hashbin_get_first
c_func
(paren
id|self-&gt;lsaps
)paren
suffix:semicolon
r_while
c_loop
(paren
id|lsap
op_ne
l_int|NULL
)paren
(brace
id|irlmp_do_lsap_event
c_func
(paren
id|lsap
comma
id|LM_LAP_CONNECT_CONFIRM
comma
l_int|NULL
)paren
suffix:semicolon
id|lsap
op_assign
(paren
r_struct
id|lsap_cb
op_star
)paren
id|hashbin_get_next
c_func
(paren
id|self-&gt;lsaps
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|LM_LAP_DISCONNECT_INDICATION
suffix:colon
id|irlmp_next_lap_state
c_func
(paren
id|self
comma
id|LAP_STANDBY
)paren
suffix:semicolon
id|self-&gt;refcount
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Send disconnect event to all LSAPs using this link */
id|lsap
op_assign
(paren
r_struct
id|lsap_cb
op_star
)paren
id|hashbin_get_first
c_func
(paren
id|self-&gt;lsaps
)paren
suffix:semicolon
r_while
c_loop
(paren
id|lsap
op_ne
l_int|NULL
)paren
(brace
id|ASSERT
c_func
(paren
id|lsap-&gt;magic
op_eq
id|LMP_LSAP_MAGIC
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
id|lsap_current
op_assign
id|lsap
suffix:semicolon
multiline_comment|/* Be sure to stay one item ahead */
id|lsap
op_assign
(paren
r_struct
id|lsap_cb
op_star
)paren
id|hashbin_get_next
c_func
(paren
id|self-&gt;lsaps
)paren
suffix:semicolon
id|irlmp_do_lsap_event
c_func
(paren
id|lsap_current
comma
id|LM_LAP_DISCONNECT_INDICATION
comma
l_int|NULL
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|LM_LAP_DISCONNECT_REQUEST
suffix:colon
id|IRDA_DEBUG
c_func
(paren
l_int|4
comma
id|__FUNCTION__
l_string|&quot;(), LM_LAP_DISCONNECT_REQUEST&bslash;n&quot;
)paren
suffix:semicolon
id|self-&gt;refcount
op_decrement
suffix:semicolon
r_if
c_cond
(paren
id|self-&gt;refcount
op_eq
l_int|0
)paren
id|irlmp_next_lap_state
c_func
(paren
id|self
comma
id|LAP_STANDBY
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|IRDA_DEBUG
c_func
(paren
l_int|0
comma
id|__FUNCTION__
l_string|&quot;(), Unknown event %s&bslash;n&quot;
comma
id|irlmp_event
(braket
id|event
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
id|skb
)paren
id|dev_kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
multiline_comment|/*&n; * Function irlmp_state_active (event, skb, info)&n; *&n; *    ACTIVE, IrLAP connection is active&n; *&n; */
DECL|function|irlmp_state_active
r_static
r_void
id|irlmp_state_active
c_func
(paren
r_struct
id|lap_cb
op_star
id|self
comma
id|IRLMP_EVENT
id|event
comma
r_struct
id|sk_buff
op_star
id|skb
)paren
(brace
r_struct
id|lsap_cb
op_star
id|lsap
suffix:semicolon
r_struct
id|lsap_cb
op_star
id|lsap_current
suffix:semicolon
id|IRDA_DEBUG
c_func
(paren
l_int|4
comma
id|__FUNCTION__
l_string|&quot;()&bslash;n&quot;
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|event
)paren
(brace
r_case
id|LM_LAP_CONNECT_REQUEST
suffix:colon
id|IRDA_DEBUG
c_func
(paren
l_int|4
comma
id|__FUNCTION__
l_string|&quot;(), LS_CONNECT_REQUEST&bslash;n&quot;
)paren
suffix:semicolon
id|self-&gt;refcount
op_increment
suffix:semicolon
multiline_comment|/*&n;&t;&t; *  LAP connection allready active, just bounce back! Since we &n;&t;&t; *  don&squot;t know which LSAP that tried to do this, we have to &n;&t;&t; *  notify all LSAPs using this LAP, but that should be safe to&n;&t;&t; *  do anyway.&n;&t;&t; */
id|lsap
op_assign
(paren
r_struct
id|lsap_cb
op_star
)paren
id|hashbin_get_first
c_func
(paren
id|self-&gt;lsaps
)paren
suffix:semicolon
r_while
c_loop
(paren
id|lsap
op_ne
l_int|NULL
)paren
(brace
id|irlmp_do_lsap_event
c_func
(paren
id|lsap
comma
id|LM_LAP_CONNECT_CONFIRM
comma
l_int|NULL
)paren
suffix:semicolon
id|lsap
op_assign
(paren
r_struct
id|lsap_cb
op_star
)paren
id|hashbin_get_next
c_func
(paren
id|self-&gt;lsaps
)paren
suffix:semicolon
)brace
multiline_comment|/* Needed by connect indication */
id|lsap
op_assign
(paren
r_struct
id|lsap_cb
op_star
)paren
id|hashbin_get_first
c_func
(paren
id|irlmp-&gt;unconnected_lsaps
)paren
suffix:semicolon
r_while
c_loop
(paren
id|lsap
op_ne
l_int|NULL
)paren
(brace
id|lsap_current
op_assign
id|lsap
suffix:semicolon
multiline_comment|/* Be sure to stay one item ahead */
id|lsap
op_assign
(paren
r_struct
id|lsap_cb
op_star
)paren
id|hashbin_get_next
c_func
(paren
id|irlmp-&gt;unconnected_lsaps
)paren
suffix:semicolon
id|irlmp_do_lsap_event
c_func
(paren
id|lsap_current
comma
id|LM_LAP_CONNECT_CONFIRM
comma
l_int|NULL
)paren
suffix:semicolon
)brace
multiline_comment|/* Keep state */
r_break
suffix:semicolon
r_case
id|LM_LAP_DISCONNECT_REQUEST
suffix:colon
id|self-&gt;refcount
op_decrement
suffix:semicolon
multiline_comment|/*&n;&t;&t; *  Need to find out if we should close IrLAP or not. If there&n;&t;&t; *  is only one LSAP connection left on this link, that LSAP &n;&t;&t; *  must be the one that tries to close IrLAP. It will be &n;&t;&t; *  removed later and moved to the list of unconnected LSAPs&n;&t;&t; */
r_if
c_cond
(paren
id|HASHBIN_GET_SIZE
c_func
(paren
id|self-&gt;lsaps
)paren
OG
l_int|0
)paren
id|irlmp_start_idle_timer
c_func
(paren
id|self
comma
id|LM_IDLE_TIMEOUT
)paren
suffix:semicolon
r_else
(brace
multiline_comment|/* No more connections, so close IrLAP */
id|irlmp_next_lap_state
c_func
(paren
id|self
comma
id|LAP_STANDBY
)paren
suffix:semicolon
id|irlap_disconnect_request
c_func
(paren
id|self-&gt;irlap
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|LM_LAP_IDLE_TIMEOUT
suffix:colon
r_if
c_cond
(paren
id|HASHBIN_GET_SIZE
c_func
(paren
id|self-&gt;lsaps
)paren
op_eq
l_int|0
)paren
(brace
id|irlmp_next_lap_state
c_func
(paren
id|self
comma
id|LAP_STANDBY
)paren
suffix:semicolon
id|irlap_disconnect_request
c_func
(paren
id|self-&gt;irlap
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|LM_LAP_DISCONNECT_INDICATION
suffix:colon
id|irlmp_next_lap_state
c_func
(paren
id|self
comma
id|LAP_STANDBY
)paren
suffix:semicolon
id|self-&gt;refcount
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* In some case, at this point our side has already closed&n;&t;&t; * all lsaps, and we are waiting for the idle_timer to&n;&t;&t; * expire. If another device reconnect immediately, the&n;&t;&t; * idle timer will expire in the midle of the connection&n;&t;&t; * initialisation, screwing up things a lot...&n;&t;&t; * Therefore, we must stop the timer... */
id|irlmp_stop_idle_timer
c_func
(paren
id|self
)paren
suffix:semicolon
multiline_comment|/* &n;&t;&t; *  Inform all connected LSAP&squot;s using this link&n;&t;&t; */
id|lsap
op_assign
(paren
r_struct
id|lsap_cb
op_star
)paren
id|hashbin_get_first
c_func
(paren
id|self-&gt;lsaps
)paren
suffix:semicolon
r_while
c_loop
(paren
id|lsap
op_ne
l_int|NULL
)paren
(brace
id|ASSERT
c_func
(paren
id|lsap-&gt;magic
op_eq
id|LMP_LSAP_MAGIC
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
id|lsap_current
op_assign
id|lsap
suffix:semicolon
multiline_comment|/* Be sure to stay one item ahead */
id|lsap
op_assign
(paren
r_struct
id|lsap_cb
op_star
)paren
id|hashbin_get_next
c_func
(paren
id|self-&gt;lsaps
)paren
suffix:semicolon
id|irlmp_do_lsap_event
c_func
(paren
id|lsap_current
comma
id|LM_LAP_DISCONNECT_INDICATION
comma
l_int|NULL
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_default
suffix:colon
id|IRDA_DEBUG
c_func
(paren
l_int|0
comma
id|__FUNCTION__
l_string|&quot;(), Unknown event %s&bslash;n&quot;
comma
id|irlmp_event
(braket
id|event
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
id|skb
)paren
id|dev_kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
multiline_comment|/*********************************************************************&n; *&n; *    LSAP connection control states&n; *&n; ********************************************************************/
multiline_comment|/*&n; * Function irlmp_state_disconnected (event, skb, info)&n; *&n; *    DISCONNECTED&n; *&n; */
DECL|function|irlmp_state_disconnected
r_static
r_int
id|irlmp_state_disconnected
c_func
(paren
r_struct
id|lsap_cb
op_star
id|self
comma
id|IRLMP_EVENT
id|event
comma
r_struct
id|sk_buff
op_star
id|skb
)paren
(brace
r_int
id|ret
op_assign
l_int|0
suffix:semicolon
id|IRDA_DEBUG
c_func
(paren
l_int|4
comma
id|__FUNCTION__
l_string|&quot;()&bslash;n&quot;
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|self
op_ne
l_int|NULL
comma
r_return
op_minus
l_int|1
suffix:semicolon
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|self-&gt;magic
op_eq
id|LMP_LSAP_MAGIC
comma
r_return
op_minus
l_int|1
suffix:semicolon
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|event
)paren
(brace
macro_line|#ifdef CONFIG_IRDA_ULTRA
r_case
id|LM_UDATA_INDICATION
suffix:colon
id|irlmp_connless_data_indication
c_func
(paren
id|self
comma
id|skb
)paren
suffix:semicolon
r_break
suffix:semicolon
macro_line|#endif /* CONFIG_IRDA_ULTRA */
r_case
id|LM_CONNECT_REQUEST
suffix:colon
id|IRDA_DEBUG
c_func
(paren
l_int|4
comma
id|__FUNCTION__
l_string|&quot;(), LM_CONNECT_REQUEST&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|self-&gt;conn_skb
)paren
(brace
id|WARNING
c_func
(paren
id|__FUNCTION__
l_string|&quot;(), busy with another request!&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EBUSY
suffix:semicolon
)brace
id|self-&gt;conn_skb
op_assign
id|skb
suffix:semicolon
id|irlmp_next_lsap_state
c_func
(paren
id|self
comma
id|LSAP_SETUP_PEND
)paren
suffix:semicolon
id|irlmp_do_lap_event
c_func
(paren
id|self-&gt;lap
comma
id|LM_LAP_CONNECT_REQUEST
comma
l_int|NULL
)paren
suffix:semicolon
multiline_comment|/* Start watchdog timer (5 secs for now) */
id|irlmp_start_watchdog_timer
c_func
(paren
id|self
comma
l_int|5
op_star
id|HZ
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|LM_CONNECT_INDICATION
suffix:colon
id|irlmp_next_lsap_state
c_func
(paren
id|self
comma
id|LSAP_CONNECT_PEND
)paren
suffix:semicolon
r_if
c_cond
(paren
id|self-&gt;conn_skb
)paren
(brace
id|WARNING
c_func
(paren
id|__FUNCTION__
l_string|&quot;(), busy with another request!&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EBUSY
suffix:semicolon
)brace
id|self-&gt;conn_skb
op_assign
id|skb
suffix:semicolon
id|irlmp_do_lap_event
c_func
(paren
id|self-&gt;lap
comma
id|LM_LAP_CONNECT_REQUEST
comma
l_int|NULL
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|IRDA_DEBUG
c_func
(paren
l_int|2
comma
id|__FUNCTION__
l_string|&quot;(), Unknown event %s&bslash;n&quot;
comma
id|irlmp_event
(braket
id|event
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
id|skb
)paren
id|dev_kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_return
id|ret
suffix:semicolon
)brace
multiline_comment|/*&n; * Function irlmp_state_connect (self, event, skb)&n; *&n; *    CONNECT&n; *&n; */
DECL|function|irlmp_state_connect
r_static
r_int
id|irlmp_state_connect
c_func
(paren
r_struct
id|lsap_cb
op_star
id|self
comma
id|IRLMP_EVENT
id|event
comma
r_struct
id|sk_buff
op_star
id|skb
)paren
(brace
r_struct
id|lsap_cb
op_star
id|lsap
suffix:semicolon
r_int
id|ret
op_assign
l_int|0
suffix:semicolon
id|IRDA_DEBUG
c_func
(paren
l_int|4
comma
id|__FUNCTION__
l_string|&quot;()&bslash;n&quot;
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|self
op_ne
l_int|NULL
comma
r_return
op_minus
l_int|1
suffix:semicolon
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|self-&gt;magic
op_eq
id|LMP_LSAP_MAGIC
comma
r_return
op_minus
l_int|1
suffix:semicolon
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|event
)paren
(brace
r_case
id|LM_CONNECT_RESPONSE
suffix:colon
multiline_comment|/* &n;&t;&t; *  Bind this LSAP to the IrLAP link where the connect was&n;&t;&t; *  received &n;&t;&t; */
id|lsap
op_assign
id|hashbin_remove
c_func
(paren
id|irlmp-&gt;unconnected_lsaps
comma
(paren
r_int
)paren
id|self
comma
l_int|NULL
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|lsap
op_eq
id|self
comma
r_return
op_minus
l_int|1
suffix:semicolon
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|self-&gt;lap
op_ne
l_int|NULL
comma
r_return
op_minus
l_int|1
suffix:semicolon
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|self-&gt;lap-&gt;lsaps
op_ne
l_int|NULL
comma
r_return
op_minus
l_int|1
suffix:semicolon
)paren
suffix:semicolon
id|hashbin_insert
c_func
(paren
id|self-&gt;lap-&gt;lsaps
comma
(paren
id|irda_queue_t
op_star
)paren
id|self
comma
(paren
r_int
)paren
id|self
comma
l_int|NULL
)paren
suffix:semicolon
id|irlmp_send_lcf_pdu
c_func
(paren
id|self-&gt;lap
comma
id|self-&gt;dlsap_sel
comma
id|self-&gt;slsap_sel
comma
id|CONNECT_CNF
comma
id|skb
)paren
suffix:semicolon
id|del_timer
c_func
(paren
op_amp
id|self-&gt;watchdog_timer
)paren
suffix:semicolon
id|irlmp_next_lsap_state
c_func
(paren
id|self
comma
id|LSAP_DATA_TRANSFER_READY
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|IRDA_DEBUG
c_func
(paren
l_int|0
comma
id|__FUNCTION__
l_string|&quot;(), Unknown event %s&bslash;n&quot;
comma
id|irlmp_event
(braket
id|event
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
id|skb
)paren
id|dev_kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_return
id|ret
suffix:semicolon
)brace
multiline_comment|/*&n; * Function irlmp_state_connect_pend (event, skb, info)&n; *&n; *    CONNECT_PEND&n; *&n; */
DECL|function|irlmp_state_connect_pend
r_static
r_int
id|irlmp_state_connect_pend
c_func
(paren
r_struct
id|lsap_cb
op_star
id|self
comma
id|IRLMP_EVENT
id|event
comma
r_struct
id|sk_buff
op_star
id|skb
)paren
(brace
r_int
id|ret
op_assign
l_int|0
suffix:semicolon
id|IRDA_DEBUG
c_func
(paren
l_int|4
comma
id|__FUNCTION__
l_string|&quot;()&bslash;n&quot;
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|self
op_ne
l_int|NULL
comma
r_return
op_minus
l_int|1
suffix:semicolon
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|self-&gt;magic
op_eq
id|LMP_LSAP_MAGIC
comma
r_return
op_minus
l_int|1
suffix:semicolon
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|event
)paren
(brace
r_case
id|LM_CONNECT_REQUEST
suffix:colon
multiline_comment|/* Keep state */
r_break
suffix:semicolon
r_case
id|LM_CONNECT_RESPONSE
suffix:colon
id|IRDA_DEBUG
c_func
(paren
l_int|0
comma
id|__FUNCTION__
l_string|&quot;(), LM_CONNECT_RESPONSE, &quot;
l_string|&quot;no indication issued yet&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* Keep state */
r_break
suffix:semicolon
r_case
id|LM_DISCONNECT_REQUEST
suffix:colon
id|IRDA_DEBUG
c_func
(paren
l_int|0
comma
id|__FUNCTION__
l_string|&quot;(), LM_DISCONNECT_REQUEST, &quot;
l_string|&quot;not yet bound to IrLAP connection&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* Keep state */
r_break
suffix:semicolon
r_case
id|LM_LAP_CONNECT_CONFIRM
suffix:colon
id|IRDA_DEBUG
c_func
(paren
l_int|4
comma
id|__FUNCTION__
l_string|&quot;(), LS_CONNECT_CONFIRM&bslash;n&quot;
)paren
suffix:semicolon
id|irlmp_next_lsap_state
c_func
(paren
id|self
comma
id|LSAP_CONNECT
)paren
suffix:semicolon
id|skb
op_assign
id|self-&gt;conn_skb
suffix:semicolon
id|self-&gt;conn_skb
op_assign
l_int|NULL
suffix:semicolon
id|irlmp_connect_indication
c_func
(paren
id|self
comma
id|skb
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|IRDA_DEBUG
c_func
(paren
l_int|0
comma
id|__FUNCTION__
l_string|&quot;Unknown event %s&bslash;n&quot;
comma
id|irlmp_event
(braket
id|event
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
id|skb
)paren
id|dev_kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_return
id|ret
suffix:semicolon
)brace
multiline_comment|/*&n; * Function irlmp_state_dtr (self, event, skb)&n; *&n; *    DATA_TRANSFER_READY&n; *&n; */
DECL|function|irlmp_state_dtr
r_static
r_int
id|irlmp_state_dtr
c_func
(paren
r_struct
id|lsap_cb
op_star
id|self
comma
id|IRLMP_EVENT
id|event
comma
r_struct
id|sk_buff
op_star
id|skb
)paren
(brace
id|LM_REASON
id|reason
suffix:semicolon
r_int
id|ret
op_assign
l_int|0
suffix:semicolon
id|IRDA_DEBUG
c_func
(paren
l_int|4
comma
id|__FUNCTION__
l_string|&quot;()&bslash;n&quot;
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|self
op_ne
l_int|NULL
comma
r_return
op_minus
l_int|1
suffix:semicolon
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|self-&gt;magic
op_eq
id|LMP_LSAP_MAGIC
comma
r_return
op_minus
l_int|1
suffix:semicolon
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|self-&gt;lap
op_ne
l_int|NULL
comma
r_return
op_minus
l_int|1
suffix:semicolon
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|event
)paren
(brace
r_case
id|LM_DATA_REQUEST
suffix:colon
multiline_comment|/* Optimize for the common case */
id|irlmp_send_data_pdu
c_func
(paren
id|self-&gt;lap
comma
id|self-&gt;dlsap_sel
comma
id|self-&gt;slsap_sel
comma
id|FALSE
comma
id|skb
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|LM_DATA_INDICATION
suffix:colon
multiline_comment|/* Optimize for the common case */
id|irlmp_data_indication
c_func
(paren
id|self
comma
id|skb
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|LM_UDATA_REQUEST
suffix:colon
id|ASSERT
c_func
(paren
id|skb
op_ne
l_int|NULL
comma
r_return
op_minus
l_int|1
suffix:semicolon
)paren
suffix:semicolon
id|irlmp_send_data_pdu
c_func
(paren
id|self-&gt;lap
comma
id|self-&gt;dlsap_sel
comma
id|self-&gt;slsap_sel
comma
id|TRUE
comma
id|skb
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|LM_UDATA_INDICATION
suffix:colon
id|irlmp_udata_indication
c_func
(paren
id|self
comma
id|skb
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|LM_CONNECT_REQUEST
suffix:colon
id|IRDA_DEBUG
c_func
(paren
l_int|0
comma
id|__FUNCTION__
l_string|&quot;(), LM_CONNECT_REQUEST, &quot;
l_string|&quot;error, LSAP already connected&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* Keep state */
r_break
suffix:semicolon
r_case
id|LM_CONNECT_RESPONSE
suffix:colon
id|IRDA_DEBUG
c_func
(paren
l_int|0
comma
id|__FUNCTION__
l_string|&quot;(), LM_CONNECT_RESPONSE, &quot;
l_string|&quot;error, LSAP allready connected&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* Keep state */
r_break
suffix:semicolon
r_case
id|LM_DISCONNECT_REQUEST
suffix:colon
id|irlmp_send_lcf_pdu
c_func
(paren
id|self-&gt;lap
comma
id|self-&gt;dlsap_sel
comma
id|self-&gt;slsap_sel
comma
id|DISCONNECT
comma
id|skb
)paren
suffix:semicolon
id|irlmp_next_lsap_state
c_func
(paren
id|self
comma
id|LSAP_DISCONNECTED
)paren
suffix:semicolon
multiline_comment|/* Try to close the LAP connection if its still there */
r_if
c_cond
(paren
id|self-&gt;lap
)paren
(brace
id|IRDA_DEBUG
c_func
(paren
l_int|4
comma
id|__FUNCTION__
l_string|&quot;(), trying to close IrLAP&bslash;n&quot;
)paren
suffix:semicolon
id|irlmp_do_lap_event
c_func
(paren
id|self-&gt;lap
comma
id|LM_LAP_DISCONNECT_REQUEST
comma
l_int|NULL
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|LM_LAP_DISCONNECT_INDICATION
suffix:colon
id|irlmp_next_lsap_state
c_func
(paren
id|self
comma
id|LSAP_DISCONNECTED
)paren
suffix:semicolon
id|reason
op_assign
id|irlmp_convert_lap_reason
c_func
(paren
id|self-&gt;lap-&gt;reason
)paren
suffix:semicolon
id|irlmp_disconnect_indication
c_func
(paren
id|self
comma
id|reason
comma
l_int|NULL
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|LM_DISCONNECT_INDICATION
suffix:colon
id|irlmp_next_lsap_state
c_func
(paren
id|self
comma
id|LSAP_DISCONNECTED
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|self-&gt;lap
op_ne
l_int|NULL
comma
r_return
op_minus
l_int|1
suffix:semicolon
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|self-&gt;lap-&gt;magic
op_eq
id|LMP_LAP_MAGIC
comma
r_return
op_minus
l_int|1
suffix:semicolon
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|skb
op_ne
l_int|NULL
comma
r_return
op_minus
l_int|1
suffix:semicolon
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|skb-&gt;len
OG
l_int|3
comma
r_return
op_minus
l_int|1
suffix:semicolon
)paren
suffix:semicolon
id|reason
op_assign
id|skb-&gt;data
(braket
l_int|3
)braket
suffix:semicolon
multiline_comment|/* Try to close the LAP connection */
id|IRDA_DEBUG
c_func
(paren
l_int|4
comma
id|__FUNCTION__
l_string|&quot;(), trying to close IrLAP&bslash;n&quot;
)paren
suffix:semicolon
id|irlmp_do_lap_event
c_func
(paren
id|self-&gt;lap
comma
id|LM_LAP_DISCONNECT_REQUEST
comma
l_int|NULL
)paren
suffix:semicolon
id|irlmp_disconnect_indication
c_func
(paren
id|self
comma
id|reason
comma
id|skb
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|IRDA_DEBUG
c_func
(paren
l_int|0
comma
id|__FUNCTION__
l_string|&quot;(), Unknown event %s&bslash;n&quot;
comma
id|irlmp_event
(braket
id|event
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
id|skb
)paren
id|dev_kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_return
id|ret
suffix:semicolon
)brace
multiline_comment|/*&n; * Function irlmp_state_setup (event, skb, info)&n; *&n; *    SETUP, Station Control has set up the underlying IrLAP connection.&n; *    An LSAP connection request has been transmitted to the peer&n; *    LSAP-Connection Control FSM and we are awaiting reply.&n; */
DECL|function|irlmp_state_setup
r_static
r_int
id|irlmp_state_setup
c_func
(paren
r_struct
id|lsap_cb
op_star
id|self
comma
id|IRLMP_EVENT
id|event
comma
r_struct
id|sk_buff
op_star
id|skb
)paren
(brace
id|LM_REASON
id|reason
suffix:semicolon
r_int
id|ret
op_assign
l_int|0
suffix:semicolon
id|ASSERT
c_func
(paren
id|self
op_ne
l_int|NULL
comma
r_return
op_minus
l_int|1
suffix:semicolon
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|self-&gt;magic
op_eq
id|LMP_LSAP_MAGIC
comma
r_return
op_minus
l_int|1
suffix:semicolon
)paren
suffix:semicolon
id|IRDA_DEBUG
c_func
(paren
l_int|4
comma
id|__FUNCTION__
l_string|&quot;()&bslash;n&quot;
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|event
)paren
(brace
r_case
id|LM_CONNECT_CONFIRM
suffix:colon
id|irlmp_next_lsap_state
c_func
(paren
id|self
comma
id|LSAP_DATA_TRANSFER_READY
)paren
suffix:semicolon
id|del_timer
c_func
(paren
op_amp
id|self-&gt;watchdog_timer
)paren
suffix:semicolon
id|irlmp_connect_confirm
c_func
(paren
id|self
comma
id|skb
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|LM_DISCONNECT_INDICATION
suffix:colon
id|irlmp_next_lsap_state
c_func
(paren
id|self
comma
id|LSAP_DISCONNECTED
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|self-&gt;lap
op_ne
l_int|NULL
comma
r_return
op_minus
l_int|1
suffix:semicolon
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|self-&gt;lap-&gt;magic
op_eq
id|LMP_LAP_MAGIC
comma
r_return
op_minus
l_int|1
suffix:semicolon
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|skb
op_ne
l_int|NULL
comma
r_return
op_minus
l_int|1
suffix:semicolon
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|skb-&gt;len
OG
l_int|3
comma
r_return
op_minus
l_int|1
suffix:semicolon
)paren
suffix:semicolon
id|reason
op_assign
id|skb-&gt;data
(braket
l_int|3
)braket
suffix:semicolon
multiline_comment|/* Try to close the LAP connection */
id|IRDA_DEBUG
c_func
(paren
l_int|4
comma
id|__FUNCTION__
l_string|&quot;(), trying to close IrLAP&bslash;n&quot;
)paren
suffix:semicolon
id|irlmp_do_lap_event
c_func
(paren
id|self-&gt;lap
comma
id|LM_LAP_DISCONNECT_REQUEST
comma
l_int|NULL
)paren
suffix:semicolon
id|irlmp_disconnect_indication
c_func
(paren
id|self
comma
id|reason
comma
id|skb
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|LM_LAP_DISCONNECT_INDICATION
suffix:colon
id|irlmp_next_lsap_state
c_func
(paren
id|self
comma
id|LSAP_DISCONNECTED
)paren
suffix:semicolon
id|del_timer
c_func
(paren
op_amp
id|self-&gt;watchdog_timer
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|self-&gt;lap
op_ne
l_int|NULL
comma
r_return
op_minus
l_int|1
suffix:semicolon
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|self-&gt;lap-&gt;magic
op_eq
id|LMP_LAP_MAGIC
comma
r_return
op_minus
l_int|1
suffix:semicolon
)paren
suffix:semicolon
id|reason
op_assign
id|irlmp_convert_lap_reason
c_func
(paren
id|self-&gt;lap-&gt;reason
)paren
suffix:semicolon
id|irlmp_disconnect_indication
c_func
(paren
id|self
comma
id|reason
comma
id|skb
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|LM_WATCHDOG_TIMEOUT
suffix:colon
id|IRDA_DEBUG
c_func
(paren
l_int|0
comma
id|__FUNCTION__
l_string|&quot;() WATCHDOG_TIMEOUT!&bslash;n&quot;
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|self-&gt;lap
op_ne
l_int|NULL
comma
r_return
op_minus
l_int|1
suffix:semicolon
)paren
suffix:semicolon
id|irlmp_do_lap_event
c_func
(paren
id|self-&gt;lap
comma
id|LM_LAP_DISCONNECT_REQUEST
comma
l_int|NULL
)paren
suffix:semicolon
id|irlmp_next_lsap_state
c_func
(paren
id|self
comma
id|LSAP_DISCONNECTED
)paren
suffix:semicolon
id|irlmp_disconnect_indication
c_func
(paren
id|self
comma
id|LM_CONNECT_FAILURE
comma
l_int|NULL
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|IRDA_DEBUG
c_func
(paren
l_int|0
comma
id|__FUNCTION__
l_string|&quot;(), Unknown event %s&bslash;n&quot;
comma
id|irlmp_event
(braket
id|event
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
id|skb
)paren
id|dev_kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_return
id|ret
suffix:semicolon
)brace
multiline_comment|/*&n; * Function irlmp_state_setup_pend (event, skb, info)&n; *&n; *    SETUP_PEND, An LM_CONNECT_REQUEST has been received from the service&n; *    user to set up an LSAP connection. A request has been sent to the&n; *    LAP FSM to set up the underlying IrLAP connection, and we&n; *    are awaiting confirm.&n; */
DECL|function|irlmp_state_setup_pend
r_static
r_int
id|irlmp_state_setup_pend
c_func
(paren
r_struct
id|lsap_cb
op_star
id|self
comma
id|IRLMP_EVENT
id|event
comma
r_struct
id|sk_buff
op_star
id|skb
)paren
(brace
id|LM_REASON
id|reason
suffix:semicolon
r_int
id|ret
op_assign
l_int|0
suffix:semicolon
id|IRDA_DEBUG
c_func
(paren
l_int|4
comma
id|__FUNCTION__
l_string|&quot;()&bslash;n&quot;
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|self
op_ne
l_int|NULL
comma
r_return
op_minus
l_int|1
suffix:semicolon
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|irlmp
op_ne
l_int|NULL
comma
r_return
op_minus
l_int|1
suffix:semicolon
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|event
)paren
(brace
r_case
id|LM_LAP_CONNECT_CONFIRM
suffix:colon
id|ASSERT
c_func
(paren
id|self-&gt;conn_skb
op_ne
l_int|NULL
comma
r_return
op_minus
l_int|1
suffix:semicolon
)paren
suffix:semicolon
id|skb
op_assign
id|self-&gt;conn_skb
suffix:semicolon
id|self-&gt;conn_skb
op_assign
l_int|NULL
suffix:semicolon
id|irlmp_send_lcf_pdu
c_func
(paren
id|self-&gt;lap
comma
id|self-&gt;dlsap_sel
comma
id|self-&gt;slsap_sel
comma
id|CONNECT_CMD
comma
id|skb
)paren
suffix:semicolon
id|irlmp_next_lsap_state
c_func
(paren
id|self
comma
id|LSAP_SETUP
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|LM_WATCHDOG_TIMEOUT
suffix:colon
id|IRDA_DEBUG
c_func
(paren
l_int|0
comma
id|__FUNCTION__
l_string|&quot;() WATCHDOG_TIMEOUT!&bslash;n&quot;
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|self-&gt;lap
op_ne
l_int|NULL
comma
r_return
op_minus
l_int|1
suffix:semicolon
)paren
suffix:semicolon
id|irlmp_do_lap_event
c_func
(paren
id|self-&gt;lap
comma
id|LM_LAP_DISCONNECT_REQUEST
comma
l_int|NULL
)paren
suffix:semicolon
id|irlmp_next_lsap_state
c_func
(paren
id|self
comma
id|LSAP_DISCONNECTED
)paren
suffix:semicolon
id|irlmp_disconnect_indication
c_func
(paren
id|self
comma
id|LM_CONNECT_FAILURE
comma
l_int|NULL
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|LM_LAP_DISCONNECT_INDICATION
suffix:colon
multiline_comment|/* LS_Disconnect.indication */
id|del_timer
c_func
(paren
op_amp
id|self-&gt;watchdog_timer
)paren
suffix:semicolon
id|irlmp_next_lsap_state
c_func
(paren
id|self
comma
id|LSAP_DISCONNECTED
)paren
suffix:semicolon
id|reason
op_assign
id|irlmp_convert_lap_reason
c_func
(paren
id|self-&gt;lap-&gt;reason
)paren
suffix:semicolon
id|irlmp_disconnect_indication
c_func
(paren
id|self
comma
id|reason
comma
l_int|NULL
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|IRDA_DEBUG
c_func
(paren
l_int|0
comma
id|__FUNCTION__
l_string|&quot;(), Unknown event %s&bslash;n&quot;
comma
id|irlmp_event
(braket
id|event
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
id|skb
)paren
id|dev_kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_return
id|ret
suffix:semicolon
)brace
DECL|function|irlmp_next_lap_state
r_void
id|irlmp_next_lap_state
c_func
(paren
r_struct
id|lap_cb
op_star
id|self
comma
id|IRLMP_STATE
id|state
)paren
(brace
id|IRDA_DEBUG
c_func
(paren
l_int|4
comma
id|__FUNCTION__
l_string|&quot;(), LMP LAP = %s&bslash;n&quot;
comma
id|irlmp_state
(braket
id|state
)braket
)paren
suffix:semicolon
id|self-&gt;lap_state
op_assign
id|state
suffix:semicolon
)brace
DECL|function|irlmp_next_lsap_state
r_void
id|irlmp_next_lsap_state
c_func
(paren
r_struct
id|lsap_cb
op_star
id|self
comma
id|LSAP_STATE
id|state
)paren
(brace
id|ASSERT
c_func
(paren
id|self
op_ne
l_int|NULL
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
id|IRDA_DEBUG
c_func
(paren
l_int|4
comma
id|__FUNCTION__
l_string|&quot;(), LMP LSAP = %s&bslash;n&quot;
comma
id|irlsap_state
(braket
id|state
)braket
)paren
suffix:semicolon
id|self-&gt;lsap_state
op_assign
id|state
suffix:semicolon
)brace
eof
