multiline_comment|/*********************************************************************&n; *                &n; * Filename:      af_irda.c&n; * Version:       0.1&n; * Description:   IrDA sockets implementation&n; * Status:        Experimental.&n; * Author:        Dag Brattli &lt;dagb@cs.uit.no&gt;&n; * Created at:    Sun May 31 10:12:43 1998&n; * Modified at:   Mon Dec 14 10:39:45 1998&n; * Modified by:   Dag Brattli &lt;dagb@cs.uit.no&gt;&n; * Sources:       af_netroom.c, af_ax25.x&n; * &n; *     Copyright (c) 1997 Dag Brattli, All Rights Reserved.&n; *      &n; *     This program is free software; you can redistribute it and/or &n; *     modify it under the terms of the GNU General Public License as &n; *     published by the Free Software Foundation; either version 2 of &n; *     the License, or (at your option) any later version.&n; *  &n; *     Neither Dag Brattli nor University of Troms&#xfffd; admit liability nor&n; *     provide warranty for any of this software. This material is &n; *     provided &quot;AS-IS&quot; and at no charge.&n; *     &n; ********************************************************************/
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/socket.h&gt;
macro_line|#include &lt;linux/sockios.h&gt;
macro_line|#include &lt;net/sock.h&gt;
macro_line|#include &lt;asm/segment.h&gt;
macro_line|#include &lt;net/irda/irda.h&gt;
macro_line|#include &lt;net/irda/irmod.h&gt;
macro_line|#include &lt;net/irda/irttp.h&gt;
r_extern
r_int
id|irda_init
c_func
(paren
r_void
)paren
suffix:semicolon
r_extern
r_void
id|irda_cleanup
c_func
(paren
r_void
)paren
suffix:semicolon
r_extern
r_int
id|irlap_input
c_func
(paren
r_struct
id|sk_buff
op_star
comma
r_struct
id|device
op_star
comma
r_struct
id|packet_type
op_star
)paren
suffix:semicolon
DECL|macro|IRDA_MAX_HEADER
mdefine_line|#define IRDA_MAX_HEADER (TTP_HEADER+LMP_HEADER+LAP_HEADER)
macro_line|#ifdef IRDA_SOCKETS
multiline_comment|/*&n; * Function irda_getname (sock, uaddr, uaddr_len, peer)&n; *&n; *    &n; *&n; */
DECL|function|irda_getname
r_static
r_int
id|irda_getname
c_func
(paren
r_struct
id|socket
op_star
id|sock
comma
r_struct
id|sockaddr
op_star
id|uaddr
comma
r_int
op_star
id|uaddr_len
comma
r_int
id|peer
)paren
(brace
id|DEBUG
c_func
(paren
l_int|0
comma
id|__FUNCTION__
l_string|&quot;(), Not implemented!&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * Function irda_sendmsg (sock, msg, len, noblock, flags)&n; *&n; *    &n; *&n; */
DECL|function|irda_sendmsg
r_static
r_int
id|irda_sendmsg
c_func
(paren
r_struct
id|socket
op_star
id|sock
comma
r_struct
id|msghdr
op_star
id|msg
comma
r_int
id|len
comma
r_int
id|noblock
comma
r_int
id|flags
)paren
(brace
macro_line|#if 0
r_struct
id|sock
op_star
id|sk
op_assign
(paren
r_struct
id|sock
op_star
)paren
id|sock-&gt;data
suffix:semicolon
multiline_comment|/* struct sockaddr_irda *usax = (struct sockaddr_irda *)msg-&gt;msg_name; */
r_int
id|err
suffix:semicolon
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
r_int
r_char
op_star
id|asmptr
suffix:semicolon
r_int
id|size
suffix:semicolon
r_struct
id|tsap_cb
op_star
id|tsap
suffix:semicolon
id|DEBUG
c_func
(paren
l_int|0
comma
id|__FUNCTION__
l_string|&quot;()&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sk-&gt;err
)paren
r_return
id|sock_error
c_func
(paren
id|sk
)paren
suffix:semicolon
r_if
c_cond
(paren
id|flags
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|sk-&gt;zapped
)paren
r_return
op_minus
id|EADDRNOTAVAIL
suffix:semicolon
r_if
c_cond
(paren
id|sk-&gt;debug
)paren
id|printk
c_func
(paren
l_string|&quot;IrDA: sendto: Addresses built.&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* Build a packet */
r_if
c_cond
(paren
id|sk-&gt;debug
)paren
id|printk
c_func
(paren
l_string|&quot;IrDA: sendto: building packet.&bslash;n&quot;
)paren
suffix:semicolon
id|size
op_assign
id|len
op_plus
id|IRDA_MAX_HEADER
suffix:semicolon
r_if
c_cond
(paren
(paren
id|skb
op_assign
id|sock_alloc_send_skb
c_func
(paren
id|sk
comma
id|size
comma
l_int|0
comma
l_int|0
comma
op_amp
id|err
)paren
)paren
op_eq
l_int|NULL
)paren
r_return
id|err
suffix:semicolon
id|skb-&gt;sk
op_assign
id|sk
suffix:semicolon
id|skb-&gt;free
op_assign
l_int|1
suffix:semicolon
id|skb-&gt;arp
op_assign
l_int|1
suffix:semicolon
id|skb_reserve
c_func
(paren
id|skb
comma
id|size
op_minus
id|len
)paren
suffix:semicolon
id|memcpy_fromiovec
c_func
(paren
id|asmptr
comma
id|msg-&gt;msg_iov
comma
id|len
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sk-&gt;debug
)paren
id|printk
c_func
(paren
l_string|&quot;IrDA: Transmitting buffer&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sk-&gt;state
op_ne
id|TCP_ESTABLISHED
)paren
(brace
id|kfree_skb
c_func
(paren
id|skb
comma
id|FREE_WRITE
)paren
suffix:semicolon
r_return
op_minus
id|ENOTCONN
suffix:semicolon
)brace
id|tsap
op_assign
(paren
r_struct
id|tsap_cb
op_star
)paren
id|sk-&gt;protinfo.irda
suffix:semicolon
id|ASSERT
c_func
(paren
id|tsap
op_ne
l_int|NULL
comma
r_return
op_minus
id|ENODEV
suffix:semicolon
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|tsap-&gt;magic
op_eq
id|TTP_TSAP_MAGIC
comma
r_return
op_minus
id|EBADR
suffix:semicolon
)paren
suffix:semicolon
id|irttp_data_request
c_func
(paren
id|tsap
comma
id|skb
)paren
suffix:semicolon
macro_line|#endif&t;
r_return
id|len
suffix:semicolon
)brace
multiline_comment|/*&n; * Function irda_recvmsg (sock, msg, size, noblock, flags, addr_len)&n; *&n; *    &n; *&n; */
DECL|function|irda_recvmsg
r_static
r_int
id|irda_recvmsg
c_func
(paren
r_struct
id|socket
op_star
id|sock
comma
r_struct
id|msghdr
op_star
id|msg
comma
r_int
id|size
comma
r_int
id|noblock
comma
r_int
id|flags
comma
r_int
op_star
id|addr_len
)paren
(brace
r_int
id|copied
op_assign
l_int|0
suffix:semicolon
macro_line|#if 0
r_struct
id|sock
op_star
id|sk
op_assign
(paren
r_struct
id|sock
op_star
)paren
id|sock-&gt;data
suffix:semicolon
r_struct
id|sockaddr_irda
op_star
id|sax
op_assign
(paren
r_struct
id|sockaddr_irda
op_star
)paren
id|msg-&gt;msg_name
suffix:semicolon
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
r_int
id|er
suffix:semicolon
id|DEBUG
c_func
(paren
l_int|0
comma
id|__FUNCTION__
l_string|&quot;()&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sk-&gt;err
)paren
r_return
id|sock_error
c_func
(paren
id|sk
)paren
suffix:semicolon
r_if
c_cond
(paren
id|addr_len
op_ne
l_int|NULL
)paren
op_star
id|addr_len
op_assign
r_sizeof
(paren
op_star
id|sax
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * This works for seqpacket too. The receiver has ordered the queue for&n;&t; * us! We do one quick check first though&n;&t; */
r_if
c_cond
(paren
id|sk-&gt;state
op_ne
id|TCP_ESTABLISHED
)paren
r_return
op_minus
id|ENOTCONN
suffix:semicolon
multiline_comment|/* Now we can treat all alike */
r_if
c_cond
(paren
(paren
id|skb
op_assign
id|skb_recv_datagram
c_func
(paren
id|sk
comma
id|flags
comma
id|noblock
comma
op_amp
id|er
)paren
)paren
op_eq
l_int|NULL
)paren
r_return
id|er
suffix:semicolon
multiline_comment|/* &t;if (!sk-&gt;nr-&gt;hdrincl) { */
multiline_comment|/* &t;&t;skb_pull(skb, NR_NETWORK_LEN + NR_TRANSPORT_LEN); */
multiline_comment|/* &t;&t;skb-&gt;h.raw = skb-&gt;data; */
multiline_comment|/* &t;} */
id|copied
op_assign
(paren
id|size
OL
id|skb-&gt;len
)paren
ques
c_cond
id|size
suffix:colon
id|skb-&gt;len
suffix:semicolon
id|skb_copy_datagram_iovec
c_func
(paren
id|skb
comma
l_int|0
comma
id|msg-&gt;msg_iov
comma
id|copied
)paren
suffix:semicolon
id|skb_free_datagram
c_func
(paren
id|sk
comma
id|skb
)paren
suffix:semicolon
macro_line|#endif
r_return
id|copied
suffix:semicolon
)brace
multiline_comment|/*&n; * Function irda_listen (sock, backlog)&n; *&n; *    &n; *&n; */
DECL|function|irda_listen
r_static
r_int
id|irda_listen
c_func
(paren
r_struct
id|socket
op_star
id|sock
comma
r_int
id|backlog
)paren
(brace
macro_line|#if 0
r_struct
id|sock
op_star
id|sk
op_assign
(paren
r_struct
id|sock
op_star
)paren
id|sock-&gt;data
suffix:semicolon
r_if
c_cond
(paren
id|sk-&gt;state
op_ne
id|TCP_LISTEN
)paren
(brace
id|sk-&gt;max_ack_backlog
op_assign
id|backlog
suffix:semicolon
id|sk-&gt;state
op_assign
id|TCP_LISTEN
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#endif
r_return
op_minus
id|EOPNOTSUPP
suffix:semicolon
)brace
multiline_comment|/*&n; * Function irda_bind (sock, uaddr, addr_len)&n; *&n; *    Bind to a specified TSAP&n; *&n; */
DECL|function|irda_bind
r_static
r_int
id|irda_bind
c_func
(paren
r_struct
id|socket
op_star
id|sock
comma
r_struct
id|sockaddr
op_star
id|uaddr
comma
r_int
id|addr_len
)paren
(brace
macro_line|#if 0&t;
r_struct
id|sock
op_star
id|sk
suffix:semicolon
r_struct
id|full_sockaddr_irda
op_star
id|addr
op_assign
(paren
r_struct
id|full_sockaddr_irda
op_star
)paren
id|uaddr
suffix:semicolon
r_struct
id|device
op_star
id|dev
suffix:semicolon
id|irda_address
op_star
id|user
comma
op_star
id|source
suffix:semicolon
r_struct
id|tsap_cb
op_star
id|tsap
suffix:semicolon
r_struct
id|notify_t
id|notify
suffix:semicolon
id|DEBUG
c_func
(paren
l_int|0
comma
id|__FUNCTION__
l_string|&quot;()&bslash;n&quot;
)paren
suffix:semicolon
id|sk
op_assign
(paren
r_struct
id|sock
op_star
)paren
id|sock-&gt;data
suffix:semicolon
r_if
c_cond
(paren
id|sk-&gt;zapped
op_eq
l_int|0
)paren
r_return
op_minus
id|EIO
suffix:semicolon
id|irda_notify_init
c_func
(paren
op_amp
id|notify
)paren
suffix:semicolon
id|tsap
op_assign
id|irttp_open_tsap
c_func
(paren
id|LSAP_ANY
comma
id|DEFAULT_INITIAL_CREDIT
comma
op_amp
id|notify
)paren
suffix:semicolon
id|sk-&gt;zapped
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|sk-&gt;debug
)paren
id|printk
c_func
(paren
l_string|&quot;IrDA: socket is bound&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * Function irda_connect (sock, uaddr, addr_len, flags)&n; *&n; *    Connect to a IrDA device&n; *&n; */
DECL|function|irda_connect
r_static
r_int
id|irda_connect
c_func
(paren
r_struct
id|socket
op_star
id|sock
comma
r_struct
id|sockaddr
op_star
id|uaddr
comma
r_int
id|addr_len
comma
r_int
id|flags
)paren
(brace
macro_line|#if 0
r_struct
id|sock
op_star
id|sk
op_assign
(paren
r_struct
id|sock
op_star
)paren
id|sock-&gt;data
suffix:semicolon
r_struct
id|sockaddr_irda
op_star
id|addr
op_assign
(paren
r_struct
id|sockaddr_irda
op_star
)paren
id|uaddr
suffix:semicolon
id|irda_address
op_star
id|user
comma
op_star
id|source
op_assign
l_int|NULL
suffix:semicolon
r_struct
id|device
op_star
id|dev
suffix:semicolon
id|DEBUG
c_func
(paren
l_int|0
comma
id|__FUNCTION__
l_string|&quot;()&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sk-&gt;state
op_eq
id|TCP_ESTABLISHED
op_logical_and
id|sock-&gt;state
op_eq
id|SS_CONNECTING
)paren
(brace
id|sock-&gt;state
op_assign
id|SS_CONNECTED
suffix:semicolon
r_return
l_int|0
suffix:semicolon
multiline_comment|/* Connect completed during a ERESTARTSYS event */
)brace
r_if
c_cond
(paren
id|sk-&gt;state
op_eq
id|TCP_CLOSE
op_logical_and
id|sock-&gt;state
op_eq
id|SS_CONNECTING
)paren
(brace
id|sock-&gt;state
op_assign
id|SS_UNCONNECTED
suffix:semicolon
r_return
op_minus
id|ECONNREFUSED
suffix:semicolon
)brace
r_if
c_cond
(paren
id|sk-&gt;state
op_eq
id|TCP_ESTABLISHED
)paren
r_return
op_minus
id|EISCONN
suffix:semicolon
multiline_comment|/* No reconnect on a seqpacket socket */
id|sk-&gt;state
op_assign
id|TCP_CLOSE
suffix:semicolon
id|sock-&gt;state
op_assign
id|SS_UNCONNECTED
suffix:semicolon
r_if
c_cond
(paren
id|addr_len
op_ne
r_sizeof
(paren
r_struct
id|sockaddr_irda
)paren
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
multiline_comment|/* Now the loop */
r_if
c_cond
(paren
id|sk-&gt;state
op_ne
id|TCP_ESTABLISHED
op_logical_and
(paren
id|flags
op_amp
id|O_NONBLOCK
)paren
)paren
r_return
op_minus
id|EINPROGRESS
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* To avoid races on the sleep */
multiline_comment|/* A Connect Ack with Choke or timeout or failed routing will go to&n;&t; * closed.  */
r_while
c_loop
(paren
id|sk-&gt;state
op_eq
id|TCP_SYN_SENT
)paren
(brace
id|interruptible_sleep_on
c_func
(paren
id|sk-&gt;sleep
)paren
suffix:semicolon
r_if
c_cond
(paren
id|current-&gt;signal
op_amp
op_complement
id|current-&gt;blocked
)paren
(brace
id|sti
c_func
(paren
)paren
suffix:semicolon
r_return
op_minus
id|ERESTARTSYS
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|sk-&gt;state
op_ne
id|TCP_ESTABLISHED
)paren
(brace
id|sti
c_func
(paren
)paren
suffix:semicolon
id|sock-&gt;state
op_assign
id|SS_UNCONNECTED
suffix:semicolon
r_return
id|sock_error
c_func
(paren
id|sk
)paren
suffix:semicolon
multiline_comment|/* Always set at this point */
)brace
id|sock-&gt;state
op_assign
id|SS_CONNECTED
suffix:semicolon
id|sti
c_func
(paren
)paren
suffix:semicolon
macro_line|#endif
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|irda_socketpair
r_static
r_int
id|irda_socketpair
c_func
(paren
r_struct
id|socket
op_star
id|sock1
comma
r_struct
id|socket
op_star
id|sock2
)paren
(brace
id|DEBUG
c_func
(paren
l_int|0
comma
id|__FUNCTION__
l_string|&quot;(), Not implemented&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EOPNOTSUPP
suffix:semicolon
)brace
DECL|function|irda_accept
r_static
r_int
id|irda_accept
c_func
(paren
r_struct
id|socket
op_star
id|sock
comma
r_struct
id|socket
op_star
id|newsock
comma
r_int
id|flags
)paren
(brace
r_struct
id|sock
op_star
id|sk
suffix:semicolon
r_struct
id|sock
op_star
id|newsk
suffix:semicolon
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
id|DEBUG
c_func
(paren
l_int|0
comma
id|__FUNCTION__
l_string|&quot;()&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#if 0
r_if
c_cond
(paren
id|newsock-&gt;data
)paren
id|sk_free
c_func
(paren
id|newsock-&gt;data
)paren
suffix:semicolon
id|newsock-&gt;data
op_assign
l_int|NULL
suffix:semicolon
id|sk
op_assign
(paren
r_struct
id|sock
op_star
)paren
id|sock-&gt;data
suffix:semicolon
r_if
c_cond
(paren
id|sk-&gt;type
op_ne
id|SOCK_SEQPACKET
)paren
r_return
op_minus
id|EOPNOTSUPP
suffix:semicolon
r_if
c_cond
(paren
id|sk-&gt;state
op_ne
id|TCP_LISTEN
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
multiline_comment|/*&n;&t; *&t;The write queue this time is holding sockets ready to use&n;&t; *&t;hooked into the SABM we saved&n;&t; */
r_do
(brace
id|cli
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|skb
op_assign
id|skb_dequeue
c_func
(paren
op_amp
id|sk-&gt;receive_queue
)paren
)paren
op_eq
l_int|NULL
)paren
(brace
r_if
c_cond
(paren
id|flags
op_amp
id|O_NONBLOCK
)paren
(brace
id|sti
c_func
(paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|interruptible_sleep_on
c_func
(paren
id|sk-&gt;sleep
)paren
suffix:semicolon
r_if
c_cond
(paren
id|current-&gt;signal
op_amp
op_complement
id|current-&gt;blocked
)paren
(brace
id|sti
c_func
(paren
)paren
suffix:semicolon
r_return
op_minus
id|ERESTARTSYS
suffix:semicolon
)brace
)brace
)brace
r_while
c_loop
(paren
id|skb
op_eq
l_int|NULL
)paren
suffix:semicolon
id|newsk
op_assign
id|skb-&gt;sk
suffix:semicolon
id|newsk-&gt;pair
op_assign
l_int|NULL
suffix:semicolon
id|sti
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* Now attach up the new socket */
id|skb-&gt;sk
op_assign
l_int|NULL
suffix:semicolon
id|kfree_skb
c_func
(paren
id|skb
comma
id|FREE_READ
)paren
suffix:semicolon
id|sk-&gt;ack_backlog
op_decrement
suffix:semicolon
id|newsock-&gt;data
op_assign
id|newsk
suffix:semicolon
macro_line|#endif
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|def_callback1
r_static
r_void
id|def_callback1
c_func
(paren
r_struct
id|sock
op_star
id|sk
)paren
(brace
id|DEBUG
c_func
(paren
l_int|0
comma
id|__FUNCTION__
l_string|&quot;()&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|sk-&gt;dead
)paren
id|wake_up_interruptible
c_func
(paren
id|sk-&gt;sleep
)paren
suffix:semicolon
)brace
DECL|function|def_callback2
r_static
r_void
id|def_callback2
c_func
(paren
r_struct
id|sock
op_star
id|sk
comma
r_int
id|len
)paren
(brace
id|DEBUG
c_func
(paren
l_int|0
comma
id|__FUNCTION__
l_string|&quot;()&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|sk-&gt;dead
)paren
id|wake_up_interruptible
c_func
(paren
id|sk-&gt;sleep
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Function irda_create (sock, protocol)&n; *&n; *    Create IrDA socket&n; *&n; */
DECL|function|irda_create
r_static
r_int
id|irda_create
c_func
(paren
r_struct
id|socket
op_star
id|sock
comma
r_int
id|protocol
)paren
(brace
r_struct
id|sock
op_star
id|sk
suffix:semicolon
id|DEBUG
c_func
(paren
l_int|0
comma
id|__FUNCTION__
l_string|&quot;()&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#if 0
r_if
c_cond
(paren
id|sock-&gt;type
op_ne
id|SOCK_SEQPACKET
op_logical_or
id|protocol
op_ne
l_int|0
)paren
r_return
op_minus
id|ESOCKTNOSUPPORT
suffix:semicolon
multiline_comment|/* Allocate socket */
r_if
c_cond
(paren
(paren
id|sk
op_assign
id|sk_alloc
c_func
(paren
id|GFP_ATOMIC
)paren
)paren
op_eq
l_int|NULL
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|skb_queue_head_init
c_func
(paren
op_amp
id|sk-&gt;receive_queue
)paren
suffix:semicolon
id|skb_queue_head_init
c_func
(paren
op_amp
id|sk-&gt;write_queue
)paren
suffix:semicolon
id|skb_queue_head_init
c_func
(paren
op_amp
id|sk-&gt;back_log
)paren
suffix:semicolon
id|init_timer
c_func
(paren
op_amp
id|sk-&gt;timer
)paren
suffix:semicolon
id|sk-&gt;socket
op_assign
id|sock
suffix:semicolon
id|sk-&gt;type
op_assign
id|sock-&gt;type
suffix:semicolon
id|sk-&gt;protocol
op_assign
id|protocol
suffix:semicolon
id|sk-&gt;allocation
op_assign
id|GFP_KERNEL
suffix:semicolon
id|sk-&gt;rcvbuf
op_assign
id|SK_RMEM_MAX
suffix:semicolon
id|sk-&gt;sndbuf
op_assign
id|SK_WMEM_MAX
suffix:semicolon
id|sk-&gt;state
op_assign
id|TCP_CLOSE
suffix:semicolon
id|sk-&gt;priority
op_assign
id|SOPRI_NORMAL
suffix:semicolon
id|sk-&gt;mtu
op_assign
l_int|2048
suffix:semicolon
multiline_comment|/* FIXME, insert the right size*/
id|sk-&gt;zapped
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* &t;sk-&gt;window&t;  = nr_default.window; */
id|sk-&gt;state_change
op_assign
id|def_callback1
suffix:semicolon
id|sk-&gt;data_ready
op_assign
id|def_callback2
suffix:semicolon
id|sk-&gt;write_space
op_assign
id|def_callback1
suffix:semicolon
id|sk-&gt;error_report
op_assign
id|def_callback1
suffix:semicolon
r_if
c_cond
(paren
id|sock
op_ne
l_int|NULL
)paren
(brace
id|sock-&gt;data
op_assign
(paren
r_void
op_star
)paren
id|sk
suffix:semicolon
id|sk-&gt;sleep
op_assign
id|sock-&gt;wait
suffix:semicolon
)brace
macro_line|#endif
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * Function irda_destroy_socket (tsap)&n; *&n; *    Destroy socket&n; *&n; */
DECL|function|irda_destroy_socket
r_void
id|irda_destroy_socket
c_func
(paren
r_struct
id|tsap_cb
op_star
id|tsap
)paren
(brace
id|DEBUG
c_func
(paren
l_int|0
comma
id|__FUNCTION__
l_string|&quot;()&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/*&n; * Function irda_release (sock, peer)&n; *&n; *    &n; *&n; */
DECL|function|irda_release
r_static
r_int
id|irda_release
c_func
(paren
r_struct
id|socket
op_star
id|sock
comma
r_struct
id|socket
op_star
id|peer
)paren
(brace
macro_line|#if 0
r_struct
id|sock
op_star
id|sk
op_assign
(paren
r_struct
id|sock
op_star
)paren
id|sock-&gt;data
suffix:semicolon
id|DEBUG
c_func
(paren
l_int|0
comma
id|__FUNCTION__
l_string|&quot;()&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sk
op_eq
l_int|NULL
)paren
r_return
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|sk-&gt;type
op_eq
id|SOCK_SEQPACKET
)paren
(brace
)brace
r_else
(brace
id|sk-&gt;state
op_assign
id|TCP_CLOSE
suffix:semicolon
id|sk-&gt;shutdown
op_or_assign
id|SEND_SHUTDOWN
suffix:semicolon
id|sk
op_member_access_from_pointer
id|state_change
c_func
(paren
id|sk
)paren
suffix:semicolon
id|sk-&gt;dead
op_assign
l_int|1
suffix:semicolon
id|irda_destroy_socket
c_func
(paren
id|sk-&gt;protinfo.irda
)paren
suffix:semicolon
)brace
id|sock-&gt;data
op_assign
l_int|NULL
suffix:semicolon
id|sk-&gt;socket
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/* Not used, but we should do this. **/
macro_line|#endif
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * Function irda_dup (newsock, oldsock)&n; *&n; *    &n; *&n; */
DECL|function|irda_dup
r_static
r_int
id|irda_dup
c_func
(paren
r_struct
id|socket
op_star
id|newsock
comma
r_struct
id|socket
op_star
id|oldsock
)paren
(brace
macro_line|#if 0
r_struct
id|sock
op_star
id|sk
op_assign
(paren
r_struct
id|sock
op_star
)paren
id|oldsock-&gt;data
suffix:semicolon
id|DEBUG
c_func
(paren
l_int|0
comma
id|__FUNCTION__
l_string|&quot;()&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sk
op_eq
l_int|NULL
op_logical_or
id|newsock
op_eq
l_int|NULL
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_return
id|irda_create
c_func
(paren
id|newsock
comma
id|sk-&gt;protocol
)paren
suffix:semicolon
macro_line|#endif
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|irda_shutdown
r_static
r_int
id|irda_shutdown
c_func
(paren
r_struct
id|socket
op_star
id|sk
comma
r_int
id|how
)paren
(brace
id|DEBUG
c_func
(paren
l_int|0
comma
id|__FUNCTION__
l_string|&quot;()&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* FIXME - generate DM and RNR states */
r_return
op_minus
id|EOPNOTSUPP
suffix:semicolon
)brace
DECL|function|irda_poll
r_int
r_int
id|irda_poll
c_func
(paren
r_struct
id|file
op_star
id|file
comma
r_struct
id|socket
op_star
id|sock
comma
r_struct
id|poll_table_struct
op_star
id|wait
)paren
(brace
)brace
multiline_comment|/*&n; * Function irda_ioctl (sock, cmd, arg)&n; *&n; *    &n; *&n; */
DECL|function|irda_ioctl
r_static
r_int
id|irda_ioctl
c_func
(paren
r_struct
id|socket
op_star
id|sock
comma
r_int
r_int
id|cmd
comma
r_int
r_int
id|arg
)paren
(brace
macro_line|#if 0
r_struct
id|sock
op_star
id|sk
op_assign
(paren
r_struct
id|sock
op_star
)paren
id|sock-&gt;data
suffix:semicolon
r_int
id|err
suffix:semicolon
id|DEBUG
c_func
(paren
l_int|0
comma
id|__FUNCTION__
l_string|&quot;(), Not implemented!&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|irda_setsockopt
r_static
r_int
id|irda_setsockopt
c_func
(paren
r_struct
id|socket
op_star
id|sock
comma
r_int
id|level
comma
r_int
id|optname
comma
r_char
op_star
id|optval
comma
r_int
id|optlen
)paren
(brace
macro_line|#if 0
r_struct
id|sock
op_star
id|sk
op_assign
(paren
r_struct
id|sock
op_star
)paren
id|sock-&gt;data
suffix:semicolon
r_int
id|err
comma
id|opt
suffix:semicolon
id|DEBUG
c_func
(paren
l_int|0
comma
id|__FUNCTION__
l_string|&quot;()&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|level
op_eq
id|SOL_SOCKET
)paren
r_return
id|sock_setsockopt
c_func
(paren
id|sk
comma
id|level
comma
id|optname
comma
id|optval
comma
id|optlen
)paren
suffix:semicolon
multiline_comment|/* if (level != SOL_AX25) */
multiline_comment|/*                 return -EOPNOTSUPP; */
r_if
c_cond
(paren
id|optval
op_eq
l_int|NULL
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
(paren
id|err
op_assign
id|verify_area
c_func
(paren
id|VERIFY_READ
comma
id|optval
comma
r_sizeof
(paren
r_int
)paren
)paren
)paren
op_ne
l_int|0
)paren
r_return
id|err
suffix:semicolon
id|opt
op_assign
id|get_fs_long
c_func
(paren
(paren
r_int
op_star
)paren
id|optval
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|optname
)paren
(brace
r_default
suffix:colon
r_return
op_minus
id|ENOPROTOOPT
suffix:semicolon
)brace
macro_line|#endif
r_return
op_minus
id|ENOPROTOOPT
suffix:semicolon
)brace
DECL|function|irda_getsockopt
r_static
r_int
id|irda_getsockopt
c_func
(paren
r_struct
id|socket
op_star
id|sock
comma
r_int
id|level
comma
r_int
id|optname
comma
r_char
op_star
id|optval
comma
r_int
op_star
id|optlen
)paren
(brace
macro_line|#if 0
r_struct
id|sock
op_star
id|sk
op_assign
(paren
r_struct
id|sock
op_star
)paren
id|sock-&gt;data
suffix:semicolon
r_int
id|val
op_assign
l_int|0
suffix:semicolon
r_int
id|err
suffix:semicolon
id|DEBUG
c_func
(paren
l_int|0
comma
id|__FUNCTION__
l_string|&quot;()&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|level
op_eq
id|SOL_SOCKET
)paren
r_return
id|sock_getsockopt
c_func
(paren
id|sk
comma
id|level
comma
id|optname
comma
id|optval
comma
id|optlen
)paren
suffix:semicolon
multiline_comment|/* if (level != SOL_AX25) */
multiline_comment|/*                 return -EOPNOTSUPP; */
r_switch
c_cond
(paren
id|optname
)paren
(brace
r_default
suffix:colon
r_return
op_minus
id|ENOPROTOOPT
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|err
op_assign
id|verify_area
c_func
(paren
id|VERIFY_WRITE
comma
id|optlen
comma
r_sizeof
(paren
r_int
)paren
)paren
)paren
op_ne
l_int|0
)paren
r_return
id|err
suffix:semicolon
id|put_user
c_func
(paren
r_sizeof
(paren
r_int
)paren
comma
id|optlen
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|err
op_assign
id|verify_area
c_func
(paren
id|VERIFY_WRITE
comma
id|optval
comma
r_sizeof
(paren
r_int
)paren
)paren
)paren
op_ne
l_int|0
)paren
r_return
id|err
suffix:semicolon
id|put_user
c_func
(paren
id|val
comma
(paren
r_int
op_star
)paren
id|optval
)paren
suffix:semicolon
macro_line|#endif
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|irda_fcntl
r_static
r_int
id|irda_fcntl
c_func
(paren
r_struct
id|socket
op_star
id|sock
comma
r_int
r_int
id|cmd
comma
r_int
r_int
id|arg
)paren
(brace
id|DEBUG
c_func
(paren
l_int|0
comma
id|__FUNCTION__
l_string|&quot;()&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
multiline_comment|/*&n; * Function irda_rcv (skb, dev, dev_addr, ptype)&n; *&n; *    &n; *&n; */
DECL|function|irda_rcv
r_static
r_int
id|irda_rcv
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|device
op_star
id|dev
comma
id|irda_address
op_star
id|dev_addr
comma
r_struct
id|packet_type
op_star
id|ptype
)paren
(brace
id|DEBUG
c_func
(paren
l_int|0
comma
id|__FUNCTION__
l_string|&quot;()&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * Function irda_driver_rcv (skb, dev, ptype)&n; *&n; *    &n; *&n; */
DECL|function|irda_driver_rcv
r_static
r_int
id|irda_driver_rcv
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|device
op_star
id|dev
comma
r_struct
id|packet_type
op_star
id|ptype
)paren
(brace
id|skb-&gt;sk
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/* Initially we don&squot;t know who it&squot;s for */
id|DEBUG
c_func
(paren
l_int|0
comma
id|__FUNCTION__
l_string|&quot;()&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#if 0
r_if
c_cond
(paren
(paren
op_star
id|skb-&gt;data
op_amp
l_int|0x0F
)paren
op_ne
l_int|0
)paren
(brace
id|kfree_skb
c_func
(paren
id|skb
comma
id|FREE_READ
)paren
suffix:semicolon
multiline_comment|/* Not a KISS data frame */
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* skb_pull(skb, AX25_KISS_HEADER_LEN);  */
multiline_comment|/* Remove the KISS byte */
r_return
id|irda_rcv
c_func
(paren
id|skb
comma
id|dev
comma
(paren
id|irda_address
op_star
)paren
id|dev-&gt;dev_addr
comma
id|ptype
)paren
suffix:semicolon
macro_line|#endif
r_return
l_int|NULL
suffix:semicolon
)brace
DECL|variable|irda_proto_ops
r_static
r_struct
id|proto_ops
id|irda_proto_ops
op_assign
(brace
id|AF_IRDA
comma
id|irda_create
comma
id|irda_dup
comma
id|irda_release
comma
id|irda_bind
comma
id|irda_connect
comma
id|irda_socketpair
comma
id|irda_accept
comma
id|irda_getname
comma
id|irda_poll
comma
id|irda_ioctl
comma
id|irda_listen
comma
id|irda_shutdown
comma
id|irda_setsockopt
comma
id|irda_getsockopt
comma
id|irda_fcntl
comma
id|irda_sendmsg
comma
id|irda_recvmsg
)brace
suffix:semicolon
macro_line|#endif /* IRDA_SOCKETS */
DECL|function|irda_device_event
r_static
r_int
id|irda_device_event
c_func
(paren
r_struct
id|notifier_block
op_star
id|this
comma
r_int
r_int
id|event
comma
r_void
op_star
id|ptr
)paren
(brace
multiline_comment|/* struct device *dev = (struct device *) ptr; */
id|DEBUG
c_func
(paren
l_int|0
comma
id|__FUNCTION__
l_string|&quot;()&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* Reject non AX.25 devices */
multiline_comment|/*  if (dev-&gt;type != ARPHRD_AX25) */
multiline_comment|/*                 return NOTIFY_DONE; */
r_switch
c_cond
(paren
id|event
)paren
(brace
r_case
id|NETDEV_UP
suffix:colon
multiline_comment|/* ax25_dev_device_up(dev); */
r_break
suffix:semicolon
r_case
id|NETDEV_DOWN
suffix:colon
multiline_comment|/* ax25_kill_by_device(dev); */
multiline_comment|/*                         ax25_rt_device_down(dev); */
multiline_comment|/*                         ax25_dev_device_down(dev); */
r_break
suffix:semicolon
r_default
suffix:colon
r_break
suffix:semicolon
)brace
r_return
id|NOTIFY_DONE
suffix:semicolon
)brace
DECL|variable|irda_packet_type
r_static
r_struct
id|packet_type
id|irda_packet_type
op_assign
(brace
l_int|0
comma
multiline_comment|/* MUTTER ntohs(ETH_P_IRDA),*/
l_int|NULL
comma
id|irlap_input
comma
multiline_comment|/* irda_driver_rcv, */
l_int|NULL
comma
l_int|NULL
comma
)brace
suffix:semicolon
DECL|variable|irda_dev_notifier
r_static
r_struct
id|notifier_block
id|irda_dev_notifier
op_assign
(brace
id|irda_device_event
comma
l_int|NULL
comma
l_int|0
)brace
suffix:semicolon
multiline_comment|/*&n; * Function irda_proto_init (pro)&n; *&n; *    Initialize IrDA protocol layer&n; *&n; */
DECL|function|irda_proto_init
r_void
id|irda_proto_init
c_func
(paren
r_struct
id|net_proto
op_star
id|pro
)paren
(brace
id|DEBUG
c_func
(paren
l_int|0
comma
id|__FUNCTION__
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* sock_register( irda_proto_ops.family, &amp;irda_proto_ops); */
id|irda_packet_type.type
op_assign
id|htons
c_func
(paren
id|ETH_P_IRDA
)paren
suffix:semicolon
id|dev_add_pack
c_func
(paren
op_amp
id|irda_packet_type
)paren
suffix:semicolon
multiline_comment|/* register_netdevice_notifier( &amp;irda_dev_notifier); */
multiline_comment|/* printk( KERN_INFO &quot;IrDA Sockets for Linux (Dag Brattli)&bslash;n&quot;); */
id|irda_init
c_func
(paren
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Function irda_proto_cleanup (void)&n; *&n; *    Remove IrDA protocol layer&n; *&n; */
DECL|function|irda_proto_cleanup
r_void
id|irda_proto_cleanup
c_func
(paren
r_void
)paren
(brace
id|DEBUG
c_func
(paren
l_int|0
comma
id|__FUNCTION__
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
id|irda_packet_type.type
op_assign
id|htons
c_func
(paren
id|ETH_P_IRDA
)paren
suffix:semicolon
id|dev_remove_pack
c_func
(paren
op_amp
id|irda_packet_type
)paren
suffix:semicolon
multiline_comment|/* unregister_netdevice_notifier( &amp;irda_dev_notifier); */
multiline_comment|/* (void) sock_unregister( irda_proto_ops.family); */
id|irda_cleanup
c_func
(paren
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
eof
