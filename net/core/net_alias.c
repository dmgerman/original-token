multiline_comment|/*&n; *&t;&t;NET_ALIAS network device aliasing module.&n; *&n; *&n; * Version:&t;@(#)net_alias.c&t;0.43   12/20/95&n; *&n; * Authors:&t;Juan Jose Ciarlante, &lt;jjciarla@raiz.uncu.edu.ar&gt;&n; *&t;&t;Marcelo Fabian Roccasalva, &lt;mfroccas@raiz.uncu.edu.ar&gt;&n; *&n; * Features:&n; *&t;-&t;AF_ independent: net_alias_type objects&n; *&t;-&t;AF_INET optimized&n; *&t;-&t;ACTUAL alias devices inserted in dev chain&n; *&t;-&t;fast hashed alias address lookup&n; *&t;-&t;net_alias_type objs registration/unreg., module-ables.&n; *&t;-&t;/proc/net/aliases &amp; /proc/net/alias_types entries&n; * Fixes:&n; *&t;&t;&t;JJC&t;:&t;several net_alias_type func. renamed.&n; *&t;&t;&t;JJC&t;:&t;net_alias_type object methods now pass &n; *&t;&t;&t;&t;&t;*this.&n; *&t;&t;&t;JJC&t;:&t;xxx_rcv device selection based on &lt;src,dst&gt; &n; *&t;&t;&t;&t;&t;addrs&n; *&t;&t;Andreas Schultz&t;:&t;Kerneld support.&n; *&n; * FIXME:&n; *&t;- User calls sleep/wake_up locking.&n; *&n; *&n; *&t;This program is free software; you can redistribute it and/or&n; *&t;modify it under the terms of the GNU General Public License&n; *&t;as published by the Free Software Foundation; either version&n; *&t;2 of the License, or (at your option) any later version.&n; *&t;&n; */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/netdevice.h&gt;
macro_line|#include &lt;linux/notifier.h&gt;
macro_line|#include &lt;linux/if.h&gt;
macro_line|#include &lt;linux/inet.h&gt;
macro_line|#include &lt;linux/in.h&gt;
macro_line|#include &lt;linux/proc_fs.h&gt;
macro_line|#include &lt;linux/stat.h&gt;
macro_line|#ifdef ALIAS_USER_LAND_DEBUG
macro_line|#include &quot;net_alias.h&quot;
macro_line|#include &quot;user_stubs.h&quot;
macro_line|#endif
macro_line|#include &lt;linux/net_alias.h&gt;
macro_line|#ifdef CONFIG_KERNELD
macro_line|#include &lt;linux/kerneld.h&gt;
macro_line|#endif
multiline_comment|/*&n; * Only allow the following flags to pass from main device to aliases&n; */
DECL|macro|NET_ALIAS_IFF_MASK
mdefine_line|#define  NET_ALIAS_IFF_MASK   (IFF_UP|IFF_BROADCAST|IFF_RUNNING|IFF_NOARP|IFF_LOOPBACK|IFF_POINTOPOINT)
r_static
r_struct
id|net_alias_type
op_star
id|nat_getbytype
c_func
(paren
r_int
id|type
)paren
suffix:semicolon
r_static
r_int
id|nat_attach_chg
c_func
(paren
r_struct
id|net_alias_type
op_star
id|nat
comma
r_int
id|delta
)paren
suffix:semicolon
r_static
r_int
id|nat_bind
c_func
(paren
r_struct
id|net_alias_type
op_star
id|nat
comma
r_struct
id|net_alias
op_star
id|alias
comma
r_struct
id|sockaddr
op_star
id|sa
)paren
suffix:semicolon
r_static
r_int
id|nat_unbind
c_func
(paren
r_struct
id|net_alias_type
op_star
id|nat
comma
r_struct
id|net_alias
op_star
id|alias
)paren
suffix:semicolon
r_static
r_int
id|net_alias_devinit
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_int
id|net_alias_hard_start_xmit
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_int
id|net_alias_devsetup
c_func
(paren
r_struct
id|net_alias
op_star
id|alias
comma
r_struct
id|net_alias_type
op_star
id|nat
comma
r_struct
id|sockaddr
op_star
id|sa
)paren
suffix:semicolon
r_static
r_struct
id|net_alias
op_star
op_star
id|net_alias_slow_findp
c_func
(paren
r_struct
id|net_alias_info
op_star
id|alias_info
comma
r_struct
id|net_alias
op_star
id|alias
)paren
suffix:semicolon
r_static
r_struct
id|device
op_star
id|net_alias_dev_create
c_func
(paren
r_struct
id|device
op_star
id|main_dev
comma
r_int
id|slot
comma
r_int
op_star
id|err
comma
r_struct
id|sockaddr
op_star
id|sa
comma
r_void
op_star
id|data
)paren
suffix:semicolon
r_static
r_struct
id|device
op_star
id|net_alias_dev_delete
c_func
(paren
r_struct
id|device
op_star
id|main_dev
comma
r_int
id|slot
comma
r_int
op_star
id|err
)paren
suffix:semicolon
r_static
r_void
id|net_alias_free
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
suffix:semicolon
multiline_comment|/*&n; * net_alias_type base array, will hold net_alias_type obj hashed list heads.&n; */
DECL|variable|nat_base
r_struct
id|net_alias_type
op_star
id|nat_base
(braket
l_int|16
)braket
suffix:semicolon
multiline_comment|/*&n; * get net_alias_type ptr by type&n; */
r_static
id|__inline__
r_struct
id|net_alias_type
op_star
DECL|function|nat_getbytype
id|nat_getbytype
c_func
(paren
r_int
id|type
)paren
(brace
r_struct
id|net_alias_type
op_star
id|nat
suffix:semicolon
r_for
c_loop
(paren
id|nat
op_assign
id|nat_base
(braket
id|type
op_amp
l_int|0x0f
)braket
suffix:semicolon
id|nat
suffix:semicolon
id|nat
op_assign
id|nat-&gt;next
)paren
(brace
r_if
c_cond
(paren
id|nat-&gt;type
op_eq
id|type
)paren
r_return
id|nat
suffix:semicolon
)brace
r_return
l_int|NULL
suffix:semicolon
)brace
multiline_comment|/*&n; * get addr32 representation (pre-hashing) of address.&n; * if NULL nat-&gt;get_addr32, assume sockaddr_in struct (IP-ish).&n; */
r_static
id|__inline__
id|__u32
DECL|function|nat_addr32
id|nat_addr32
c_func
(paren
r_struct
id|net_alias_type
op_star
id|nat
comma
r_struct
id|sockaddr
op_star
id|sa
)paren
(brace
r_if
c_cond
(paren
id|nat-&gt;get_addr32
)paren
r_return
id|nat
op_member_access_from_pointer
id|get_addr32
c_func
(paren
id|nat
comma
id|sa
)paren
suffix:semicolon
r_else
r_return
(paren
r_struct
id|sockaddr_in
op_star
)paren
id|sa.sin_addr.s_addr
suffix:semicolon
)brace
multiline_comment|/*&n; * hashing code for alias_info-&gt;hash_tab entries&n; * 4 bytes -&gt; 1/2 byte using xor complemented by af&n; */
r_static
id|__inline__
r_int
DECL|function|HASH
id|HASH
c_func
(paren
id|__u32
id|addr
comma
r_int
id|af
)paren
(brace
r_int
id|tmp
op_assign
id|addr
op_xor
(paren
id|addr
op_rshift
l_int|16
)paren
suffix:semicolon
multiline_comment|/* 4 -&gt; 2 */
id|tmp
op_xor_assign
(paren
id|tmp
op_rshift
l_int|8
)paren
suffix:semicolon
multiline_comment|/* 2 -&gt; 1 */
r_return
(paren
id|tmp
op_xor
(paren
id|tmp
op_rshift
l_int|4
)paren
op_xor
id|af
)paren
op_amp
l_int|0x0f
suffix:semicolon
multiline_comment|/* 1 -&gt; 1/2 */
)brace
multiline_comment|/*&n; * get hash key for supplied net alias type and address&n; * nat must be !NULL&n; * the purpose here is to map a net_alias_type and a generic&n; * address to a hash code.&n; */
r_static
id|__inline__
r_int
DECL|function|nat_hash_key
id|nat_hash_key
c_func
(paren
r_struct
id|net_alias_type
op_star
id|nat
comma
r_struct
id|sockaddr
op_star
id|sa
)paren
(brace
r_return
id|HASH
c_func
(paren
id|nat_addr32
c_func
(paren
id|nat
comma
id|sa
)paren
comma
id|sa-&gt;sa_family
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * change net_alias_type number of attachments (bindings)&n; */
r_static
r_int
DECL|function|nat_attach_chg
id|nat_attach_chg
c_func
(paren
r_struct
id|net_alias_type
op_star
id|nat
comma
r_int
id|delta
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
r_int
id|n_at
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|nat
)paren
r_return
op_minus
l_int|1
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|n_at
op_assign
id|nat-&gt;n_attach
op_plus
id|delta
suffix:semicolon
r_if
c_cond
(paren
id|n_at
OL
l_int|0
)paren
(brace
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;net_alias: tried to set n_attach &lt; 0 for (family==%d) nat object.&bslash;n&quot;
comma
id|nat-&gt;type
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|nat-&gt;n_attach
op_assign
id|n_at
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * bind alias to its type (family) object and call initialization hook&n; */
r_static
id|__inline__
r_int
DECL|function|nat_bind
id|nat_bind
c_func
(paren
r_struct
id|net_alias_type
op_star
id|nat
comma
r_struct
id|net_alias
op_star
id|alias
comma
r_struct
id|sockaddr
op_star
id|sa
)paren
(brace
r_if
c_cond
(paren
id|nat-&gt;alias_init_1
)paren
id|nat
op_member_access_from_pointer
id|alias_init_1
c_func
(paren
id|nat
comma
id|alias
comma
id|sa
)paren
suffix:semicolon
r_return
id|nat_attach_chg
c_func
(paren
id|nat
comma
op_plus
l_int|1
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * unbind alias from type object and call alias destructor&n; */
r_static
id|__inline__
r_int
DECL|function|nat_unbind
id|nat_unbind
c_func
(paren
r_struct
id|net_alias_type
op_star
id|nat
comma
r_struct
id|net_alias
op_star
id|alias
)paren
(brace
r_if
c_cond
(paren
id|nat-&gt;alias_done_1
)paren
id|nat
op_member_access_from_pointer
id|alias_done_1
c_func
(paren
id|nat
comma
id|alias
)paren
suffix:semicolon
r_return
id|nat_attach_chg
c_func
(paren
id|nat
comma
op_minus
l_int|1
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * compare device address with given. if NULL nat-&gt;dev_addr_chk,&n; * compare dev-&gt;pa_addr with (sockaddr_in) 32 bits address (IP-ish)&n; */
DECL|function|nat_dev_addr_chk_1
r_static
id|__inline__
r_int
id|nat_dev_addr_chk_1
c_func
(paren
r_struct
id|net_alias_type
op_star
id|nat
comma
r_struct
id|device
op_star
id|dev
comma
r_struct
id|sockaddr
op_star
id|sa
)paren
(brace
r_if
c_cond
(paren
id|nat-&gt;dev_addr_chk
)paren
r_return
id|nat
op_member_access_from_pointer
id|dev_addr_chk
c_func
(paren
id|nat
comma
id|dev
comma
id|sa
)paren
suffix:semicolon
r_else
r_return
(paren
id|dev-&gt;pa_addr
op_eq
(paren
r_struct
id|sockaddr_in
op_star
)paren
id|sa.sin_addr.s_addr
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * alias device init()&n; * do nothing.&n; */
r_static
r_int
DECL|function|net_alias_devinit
id|net_alias_devinit
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
macro_line|#ifdef ALIAS_USER_LAND_DEBUG
id|printk
c_func
(paren
l_string|&quot;net_alias_devinit(%s) called.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
macro_line|#endif
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * hard_start_xmit() should not be called.&n; * ignore ... but shout!.&n; */
r_static
r_int
DECL|function|net_alias_hard_start_xmit
id|net_alias_hard_start_xmit
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|device
op_star
id|dev
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;net_alias: net_alias_hard_start_xmit() for %s called (ignored)!!&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|dev_kfree_skb
c_func
(paren
id|skb
comma
id|FREE_WRITE
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * setups a new (alias) device &n; */
r_static
r_int
DECL|function|net_alias_devsetup
id|net_alias_devsetup
c_func
(paren
r_struct
id|net_alias
op_star
id|alias
comma
r_struct
id|net_alias_type
op_star
id|nat
comma
r_struct
id|sockaddr
op_star
id|sa
)paren
(brace
r_struct
id|device
op_star
id|main_dev
suffix:semicolon
r_struct
id|device
op_star
id|dev
suffix:semicolon
r_int
id|family
suffix:semicolon
r_int
id|i
suffix:semicolon
multiline_comment|/*&n;   *&n;   * generic device setup based on main_dev info&n;   *&n;   * FIXME: is NULL bitwise 0 for all Linux platforms?&n;   */
id|main_dev
op_assign
id|alias-&gt;main_dev
suffix:semicolon
id|dev
op_assign
op_amp
id|alias-&gt;dev
suffix:semicolon
id|memset
c_func
(paren
id|dev
comma
l_char|&squot;&bslash;0&squot;
comma
r_sizeof
(paren
r_struct
id|device
)paren
)paren
suffix:semicolon
id|family
op_assign
(paren
id|sa
)paren
ques
c_cond
id|sa-&gt;sa_family
suffix:colon
id|main_dev-&gt;family
suffix:semicolon
id|dev-&gt;alias_info
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/* no aliasing recursion */
id|dev-&gt;my_alias
op_assign
id|alias
suffix:semicolon
multiline_comment|/* point to alias */
id|dev-&gt;name
op_assign
id|alias-&gt;name
suffix:semicolon
id|dev-&gt;type
op_assign
id|main_dev-&gt;type
suffix:semicolon
id|dev-&gt;hard_header_len
op_assign
id|main_dev-&gt;hard_header_len
suffix:semicolon
id|memcpy
c_func
(paren
id|dev-&gt;broadcast
comma
id|main_dev-&gt;broadcast
comma
id|MAX_ADDR_LEN
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|dev-&gt;dev_addr
comma
id|main_dev-&gt;dev_addr
comma
id|MAX_ADDR_LEN
)paren
suffix:semicolon
id|dev-&gt;addr_len
op_assign
id|main_dev-&gt;addr_len
suffix:semicolon
id|dev-&gt;init
op_assign
id|net_alias_devinit
suffix:semicolon
id|dev-&gt;hard_start_xmit
op_assign
id|net_alias_hard_start_xmit
suffix:semicolon
id|dev-&gt;flags
op_assign
id|main_dev-&gt;flags
op_amp
id|NET_ALIAS_IFF_MASK
op_amp
op_complement
id|IFF_UP
suffix:semicolon
multiline_comment|/*&n;   * only makes sense if same family&n;   */
r_if
c_cond
(paren
id|family
op_eq
id|main_dev-&gt;family
)paren
(brace
id|dev-&gt;metric
op_assign
id|main_dev-&gt;metric
suffix:semicolon
id|dev-&gt;mtu
op_assign
id|main_dev-&gt;mtu
suffix:semicolon
id|dev-&gt;pa_alen
op_assign
id|main_dev-&gt;pa_alen
suffix:semicolon
id|dev-&gt;hard_header
op_assign
id|main_dev-&gt;hard_header
suffix:semicolon
id|dev-&gt;rebuild_header
op_assign
id|main_dev-&gt;rebuild_header
suffix:semicolon
)brace
multiline_comment|/*&n;   *&t;Fill in the generic fields of the device structure.&n;   *    not actually used, avoids some dev.c #ifdef&squot;s&n;   */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|DEV_NUMBUFFS
suffix:semicolon
id|i
op_increment
)paren
id|skb_queue_head_init
c_func
(paren
op_amp
id|dev-&gt;buffs
(braket
id|i
)braket
)paren
suffix:semicolon
id|dev-&gt;family
op_assign
id|family
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * slow alias find (parse the whole hash_tab)&n; * returns: alias&squot; pointer address&n; */
r_static
r_struct
id|net_alias
op_star
op_star
DECL|function|net_alias_slow_findp
id|net_alias_slow_findp
c_func
(paren
r_struct
id|net_alias_info
op_star
id|alias_info
comma
r_struct
id|net_alias
op_star
id|alias
)paren
(brace
r_int
id|idx
comma
id|n_aliases
suffix:semicolon
r_struct
id|net_alias
op_star
op_star
id|aliasp
suffix:semicolon
multiline_comment|/*&n;   * for each alias_info&squot;s hash_tab entry, for every alias ...&n;   */
id|n_aliases
op_assign
id|alias_info-&gt;n_aliases
suffix:semicolon
r_for
c_loop
(paren
id|idx
op_assign
l_int|0
suffix:semicolon
id|idx
OL
l_int|16
suffix:semicolon
id|idx
op_increment
)paren
r_for
c_loop
(paren
id|aliasp
op_assign
op_amp
id|alias_info-&gt;hash_tab
(braket
id|idx
)braket
suffix:semicolon
op_star
id|aliasp
suffix:semicolon
id|aliasp
op_assign
op_amp
(paren
op_star
id|aliasp
)paren
op_member_access_from_pointer
id|next
)paren
r_if
c_cond
(paren
op_star
id|aliasp
op_eq
id|alias
)paren
r_return
id|aliasp
suffix:semicolon
r_else
r_if
c_cond
(paren
op_decrement
id|n_aliases
op_eq
l_int|0
)paren
r_break
suffix:semicolon
multiline_comment|/* faster give up */
r_return
l_int|NULL
suffix:semicolon
)brace
multiline_comment|/*&n; * create alias device for main_dev with given slot num.&n; * if sa==NULL will create a same_family alias device &n; */
r_static
r_struct
id|device
op_star
DECL|function|net_alias_dev_create
id|net_alias_dev_create
c_func
(paren
r_struct
id|device
op_star
id|main_dev
comma
r_int
id|slot
comma
r_int
op_star
id|err
comma
r_struct
id|sockaddr
op_star
id|sa
comma
r_void
op_star
id|data
)paren
(brace
r_struct
id|net_alias_info
op_star
id|alias_info
suffix:semicolon
r_struct
id|net_alias
op_star
id|alias
comma
op_star
op_star
id|aliasp
suffix:semicolon
r_struct
id|net_alias_type
op_star
id|nat
suffix:semicolon
r_struct
id|device
op_star
id|dev
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_int
id|family
suffix:semicolon
id|__u32
id|addr32
suffix:semicolon
multiline_comment|/* FIXME: lock */
id|alias_info
op_assign
id|main_dev-&gt;alias_info
suffix:semicolon
multiline_comment|/*&n;   * if NULL address given, take family from main_dev&n;   */
id|family
op_assign
(paren
id|sa
)paren
ques
c_cond
id|sa-&gt;sa_family
suffix:colon
id|main_dev-&gt;family
suffix:semicolon
multiline_comment|/*&n;   * check if wanted family has a net_alias_type object registered&n;   */
id|nat
op_assign
id|nat_getbytype
c_func
(paren
id|family
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|nat
)paren
(brace
macro_line|#ifdef CONFIG_KERNELD
r_char
id|modname
(braket
l_int|20
)braket
suffix:semicolon
id|sprintf
(paren
id|modname
comma
l_string|&quot;netalias-%d&quot;
comma
id|family
)paren
suffix:semicolon
id|request_module
c_func
(paren
id|modname
)paren
suffix:semicolon
id|nat
op_assign
id|nat_getbytype
c_func
(paren
id|family
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|nat
)paren
(brace
macro_line|#endif
id|printk
c_func
(paren
l_string|&quot;net_alias_dev_create(%s:%d): unregistered family==%d&bslash;n&quot;
comma
id|main_dev-&gt;name
comma
id|slot
comma
id|family
)paren
suffix:semicolon
multiline_comment|/* *err = -EAFNOSUPPORT; */
op_star
id|err
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
macro_line|#ifdef CONFIG_KERNELD
)brace
macro_line|#endif
)brace
multiline_comment|/*&n;   * do not allow creation over downed devices&n;   */
op_star
id|err
op_assign
op_minus
id|EIO
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|main_dev-&gt;flags
op_amp
id|IFF_UP
)paren
)paren
r_return
l_int|NULL
suffix:semicolon
multiline_comment|/*&n;   * if first alias, must also create alias_info&n;   */
op_star
id|err
op_assign
op_minus
id|ENOMEM
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|alias_info
)paren
(brace
id|alias_info
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|net_alias_info
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|alias_info
)paren
r_return
l_int|NULL
suffix:semicolon
multiline_comment|/* ENOMEM */
id|memset
c_func
(paren
id|alias_info
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|net_alias_info
)paren
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|alias
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|net_alias
)paren
comma
id|GFP_KERNEL
)paren
)paren
)paren
r_return
l_int|NULL
suffix:semicolon
multiline_comment|/* ENOMEM */
multiline_comment|/*&n;   * FIXME: is NULL bitwise 0 for all Linux platforms?&n;   */
id|memset
c_func
(paren
id|alias
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|net_alias
)paren
)paren
suffix:semicolon
id|alias-&gt;slot
op_assign
id|slot
suffix:semicolon
id|alias-&gt;main_dev
op_assign
id|main_dev
suffix:semicolon
id|alias-&gt;nat
op_assign
id|nat
suffix:semicolon
id|alias-&gt;next
op_assign
l_int|NULL
suffix:semicolon
id|alias-&gt;data
op_assign
id|data
suffix:semicolon
id|sprintf
c_func
(paren
id|alias-&gt;name
comma
l_string|&quot;%s:%d&quot;
comma
id|main_dev-&gt;name
comma
id|slot
)paren
suffix:semicolon
multiline_comment|/*&n;   * initialise alias&squot; device structure&n;   */
id|net_alias_devsetup
c_func
(paren
id|alias
comma
id|nat
comma
id|sa
)paren
suffix:semicolon
id|dev
op_assign
op_amp
id|alias-&gt;dev
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/*&n;   * bind alias to its object type&n;   * nat_bind calls nat-&gt;alias_init_1&n;   */
id|nat_bind
c_func
(paren
id|nat
comma
id|alias
comma
id|sa
)paren
suffix:semicolon
multiline_comment|/*&n;   * if no address passed, take from device (could have been&n;   * set by nat-&gt;alias_init_1)&n;   */
id|addr32
op_assign
(paren
id|sa
)paren
ques
c_cond
id|nat_addr32
c_func
(paren
id|nat
comma
id|sa
)paren
suffix:colon
id|alias-&gt;dev.pa_addr
suffix:semicolon
multiline_comment|/*&n;   * store hash key in alias: will speed-up rehashing and deletion&n;   */
id|alias-&gt;hash
op_assign
id|HASH
c_func
(paren
id|addr32
comma
id|family
)paren
suffix:semicolon
multiline_comment|/*&n;   * insert alias in hashed linked list&n;   */
id|aliasp
op_assign
op_amp
id|alias_info-&gt;hash_tab
(braket
id|alias-&gt;hash
)braket
suffix:semicolon
id|alias-&gt;next
op_assign
op_star
id|aliasp
suffix:semicolon
op_star
id|aliasp
op_assign
id|alias
suffix:semicolon
multiline_comment|/*&n;   * if first alias ...&n;   */
r_if
c_cond
(paren
op_logical_neg
id|alias_info-&gt;n_aliases
op_increment
)paren
(brace
id|alias_info-&gt;taildev
op_assign
id|main_dev
suffix:semicolon
id|main_dev-&gt;alias_info
op_assign
id|alias_info
suffix:semicolon
)brace
multiline_comment|/*&n;   * add device at tail (just after last main_dev alias)&n;   */
id|dev-&gt;next
op_assign
id|alias_info-&gt;taildev-&gt;next
suffix:semicolon
id|alias_info-&gt;taildev-&gt;next
op_assign
id|dev
suffix:semicolon
id|alias_info-&gt;taildev
op_assign
id|dev
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
id|dev
suffix:semicolon
)brace
multiline_comment|/*&n; * delete one main_dev alias (referred by its slot num)&n; */
r_static
r_struct
id|device
op_star
DECL|function|net_alias_dev_delete
id|net_alias_dev_delete
c_func
(paren
r_struct
id|device
op_star
id|main_dev
comma
r_int
id|slot
comma
r_int
op_star
id|err
)paren
(brace
r_struct
id|net_alias_info
op_star
id|alias_info
suffix:semicolon
r_struct
id|net_alias
op_star
id|alias
comma
op_star
op_star
id|aliasp
suffix:semicolon
r_struct
id|device
op_star
id|dev
suffix:semicolon
r_int
id|n_aliases
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_struct
id|net_alias_type
op_star
id|nat
suffix:semicolon
r_struct
id|device
op_star
id|prevdev
suffix:semicolon
multiline_comment|/* FIXME: lock */
op_star
id|err
op_assign
op_minus
id|ENODEV
suffix:semicolon
r_if
c_cond
(paren
id|main_dev
op_eq
l_int|NULL
)paren
r_return
l_int|NULL
suffix:semicolon
multiline_comment|/*&n;   * does main_dev have aliases?&n;   */
id|alias_info
op_assign
id|main_dev-&gt;alias_info
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|alias_info
)paren
r_return
l_int|NULL
suffix:semicolon
multiline_comment|/* ENODEV */
id|n_aliases
op_assign
id|alias_info-&gt;n_aliases
suffix:semicolon
multiline_comment|/*&n;   * find device that holds the same slot number (could also&n;   * be strcmp() ala dev_get).&n;   */
r_for
c_loop
(paren
id|prevdev
op_assign
id|main_dev
comma
id|alias
op_assign
l_int|NULL
suffix:semicolon
id|prevdev-&gt;next
op_logical_and
id|n_aliases
suffix:semicolon
id|prevdev
op_assign
id|prevdev-&gt;next
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|alias
op_assign
id|prevdev-&gt;next-&gt;my_alias
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;ERROR: net_alias_dev_delete(): incorrect non-alias device after maindev&bslash;n&quot;
)paren
suffix:semicolon
r_continue
suffix:semicolon
multiline_comment|/* or should give up? */
)brace
r_if
c_cond
(paren
id|alias-&gt;slot
op_eq
id|slot
)paren
r_break
suffix:semicolon
id|alias
op_assign
l_int|NULL
suffix:semicolon
id|n_aliases
op_decrement
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|alias
)paren
r_return
l_int|NULL
suffix:semicolon
multiline_comment|/* ENODEV */
id|dev
op_assign
op_amp
id|alias-&gt;dev
suffix:semicolon
multiline_comment|/*&n;   * find alias hashed entry&n;   */
r_for
c_loop
(paren
id|aliasp
op_assign
op_amp
id|alias_info-&gt;hash_tab
(braket
id|alias-&gt;hash
)braket
suffix:semicolon
op_star
id|aliasp
suffix:semicolon
id|aliasp
op_assign
op_amp
(paren
op_star
id|aliasp
)paren
op_member_access_from_pointer
id|next
)paren
r_if
c_cond
(paren
op_star
id|aliasp
op_eq
id|alias
)paren
(brace
r_break
suffix:semicolon
)brace
multiline_comment|/*&n;   * if not found (???), try a full search&n;   */
r_if
c_cond
(paren
op_star
id|aliasp
op_ne
id|alias
)paren
r_if
c_cond
(paren
(paren
id|aliasp
op_assign
id|net_alias_slow_findp
c_func
(paren
id|alias_info
comma
id|alias
)paren
)paren
)paren
id|printk
c_func
(paren
l_string|&quot;net_alias_dev_delete(%s): bad hashing recovered&bslash;n&quot;
comma
id|alias-&gt;name
)paren
suffix:semicolon
r_else
(brace
id|printk
c_func
(paren
l_string|&quot;ERROR: net_alias_dev_delete(%s): unhashed alias!&bslash;n&quot;
comma
id|alias-&gt;name
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
multiline_comment|/* ENODEV */
)brace
id|nat
op_assign
id|alias-&gt;nat
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/*&n;   * unbind alias from alias_type obj.&n;   */
id|nat_unbind
c_func
(paren
id|nat
comma
id|alias
)paren
suffix:semicolon
multiline_comment|/*&n;   * is alias at tail?&n;   */
r_if
c_cond
(paren
id|dev
op_eq
id|alias_info-&gt;taildev
)paren
id|alias_info-&gt;taildev
op_assign
id|prevdev
suffix:semicolon
multiline_comment|/*&n;   * unlink and close device&n;   */
id|prevdev-&gt;next
op_assign
id|dev-&gt;next
suffix:semicolon
id|dev_close
c_func
(paren
id|dev
)paren
suffix:semicolon
multiline_comment|/*&n;   * unlink alias&n;   */
op_star
id|aliasp
op_assign
(paren
op_star
id|aliasp
)paren
op_member_access_from_pointer
id|next
suffix:semicolon
r_if
c_cond
(paren
op_decrement
id|alias_info-&gt;n_aliases
op_eq
l_int|0
)paren
multiline_comment|/* last alias */
id|main_dev-&gt;alias_info
op_assign
l_int|NULL
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
multiline_comment|/*&n;   * now free structures&n;   */
id|kfree_s
c_func
(paren
id|alias
comma
r_sizeof
(paren
r_struct
id|net_alias
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|main_dev-&gt;alias_info
op_eq
l_int|NULL
)paren
id|kfree_s
c_func
(paren
id|alias_info
comma
r_sizeof
(paren
r_struct
id|net_alias_info
)paren
)paren
suffix:semicolon
multiline_comment|/*&n;   * deletion ok (*err=0), NULL device returned.&n;   */
op_star
id|err
op_assign
l_int|0
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
multiline_comment|/*&n; * free all main device aliasing stuff&n; * will be called on dev_close(main_dev)&n; */
r_static
r_void
DECL|function|net_alias_free
id|net_alias_free
c_func
(paren
r_struct
id|device
op_star
id|main_dev
)paren
(brace
r_struct
id|net_alias_info
op_star
id|alias_info
suffix:semicolon
r_struct
id|net_alias
op_star
id|alias
suffix:semicolon
r_struct
id|net_alias_type
op_star
id|nat
suffix:semicolon
r_struct
id|device
op_star
id|dev
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
multiline_comment|/*&n;   * do I really have aliases?&n;   */
r_if
c_cond
(paren
op_logical_neg
(paren
id|alias_info
op_assign
id|main_dev-&gt;alias_info
)paren
)paren
r_return
suffix:semicolon
multiline_comment|/*&n;   * fast device link &quot;short-circuit&quot;: set main_dev-&gt;next to&n;   * device after last alias&n;   */
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|dev
op_assign
id|main_dev-&gt;next
suffix:semicolon
id|main_dev-&gt;next
op_assign
id|alias_info-&gt;taildev-&gt;next
suffix:semicolon
id|main_dev-&gt;alias_info
op_assign
l_int|NULL
suffix:semicolon
id|alias_info-&gt;taildev-&gt;next
op_assign
l_int|NULL
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
multiline_comment|/*&n;   * loop over alias devices, free and dev_close()&n;   */
r_while
c_loop
(paren
id|dev
)paren
(brace
r_if
c_cond
(paren
id|net_alias_is
c_func
(paren
id|dev
)paren
)paren
(brace
id|alias
op_assign
id|dev-&gt;my_alias
suffix:semicolon
r_if
c_cond
(paren
id|alias-&gt;main_dev
op_eq
id|main_dev
)paren
(brace
multiline_comment|/*&n;&t; * unbind alias from alias_type object&n;&t; */
id|nat
op_assign
id|alias-&gt;nat
suffix:semicolon
r_if
c_cond
(paren
id|nat
)paren
(brace
id|nat_unbind
c_func
(paren
id|nat
comma
id|alias
)paren
suffix:semicolon
)brace
multiline_comment|/*  else error/printk ??? */
id|dev_close
c_func
(paren
id|dev
)paren
suffix:semicolon
id|dev
op_assign
id|dev-&gt;next
suffix:semicolon
id|kfree_s
c_func
(paren
id|alias
comma
r_sizeof
(paren
r_struct
id|net_alias
)paren
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
r_else
id|printk
c_func
(paren
l_string|&quot;net_alias_free(%s): &squot;%s&squot; is not my alias&bslash;n&quot;
comma
id|main_dev-&gt;name
comma
id|alias-&gt;name
)paren
suffix:semicolon
)brace
r_else
id|printk
c_func
(paren
l_string|&quot;net_alias_free(%s): found a non-alias after device!&bslash;n&quot;
comma
id|main_dev-&gt;name
)paren
suffix:semicolon
id|dev
op_assign
id|dev-&gt;next
suffix:semicolon
)brace
id|kfree_s
c_func
(paren
id|alias_info
comma
r_sizeof
(paren
id|alias_info
)paren
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/*&n; * dev_get() with added alias naming magic.&n; */
r_struct
id|device
op_star
DECL|function|net_alias_dev_get
id|net_alias_dev_get
c_func
(paren
r_char
op_star
id|dev_name
comma
r_int
id|aliasing_ok
comma
r_int
op_star
id|err
comma
r_struct
id|sockaddr
op_star
id|sa
comma
r_void
op_star
id|data
)paren
(brace
r_struct
id|device
op_star
id|dev
suffix:semicolon
r_char
op_star
id|sptr
comma
op_star
id|eptr
suffix:semicolon
r_int
id|slot
op_assign
l_int|0
suffix:semicolon
r_int
r_delete
op_assign
l_int|0
suffix:semicolon
op_star
id|err
op_assign
op_minus
id|ENODEV
suffix:semicolon
r_if
c_cond
(paren
(paren
id|dev
op_assign
id|dev_get
c_func
(paren
id|dev_name
)paren
)paren
)paren
r_return
id|dev
suffix:semicolon
multiline_comment|/*&n;   * want alias naming magic?&n;   */
r_if
c_cond
(paren
op_logical_neg
id|aliasing_ok
)paren
r_return
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dev_name
op_logical_or
op_logical_neg
op_star
id|dev_name
)paren
r_return
l_int|NULL
suffix:semicolon
multiline_comment|/*&n;   * find the first &squot;:&squot; , must be followed by, at least, 1 char&n;   */
r_for
c_loop
(paren
id|sptr
op_assign
id|dev_name
suffix:semicolon
op_star
id|sptr
suffix:semicolon
id|sptr
op_increment
)paren
r_if
c_cond
(paren
op_star
id|sptr
op_eq
l_char|&squot;:&squot;
)paren
(brace
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
op_star
id|sptr
op_logical_or
op_logical_neg
op_star
(paren
id|sptr
op_plus
l_int|1
)paren
)paren
r_return
l_int|NULL
suffix:semicolon
multiline_comment|/*&n;   * seems to be an alias name, fetch main device&n;   */
op_star
id|sptr
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|dev
op_assign
id|dev_get
c_func
(paren
id|dev_name
)paren
)paren
)paren
r_return
l_int|NULL
suffix:semicolon
op_star
id|sptr
op_increment
op_assign
l_char|&squot;:&squot;
suffix:semicolon
multiline_comment|/*&n;   * fetch slot number&n;   */
id|slot
op_assign
id|simple_strtoul
c_func
(paren
id|sptr
comma
op_amp
id|eptr
comma
l_int|10
)paren
suffix:semicolon
r_if
c_cond
(paren
id|slot
op_ge
id|NET_ALIAS_MAX_SLOT
)paren
r_return
l_int|NULL
suffix:semicolon
multiline_comment|/*&n;   * if last char is &squot;-&squot;, it is a deletion request&n;   */
r_if
c_cond
(paren
id|eptr
(braket
l_int|0
)braket
op_eq
l_char|&squot;-&squot;
op_logical_and
op_logical_neg
id|eptr
(braket
l_int|1
)braket
)paren
r_delete
op_increment
suffix:semicolon
r_else
r_if
c_cond
(paren
id|eptr
(braket
l_int|0
)braket
)paren
r_return
l_int|NULL
suffix:semicolon
multiline_comment|/*&n;   * well... let&squot;s work.&n;   */
r_if
c_cond
(paren
r_delete
)paren
r_return
id|net_alias_dev_delete
c_func
(paren
id|dev
comma
id|slot
comma
id|err
)paren
suffix:semicolon
r_else
r_return
id|net_alias_dev_create
c_func
(paren
id|dev
comma
id|slot
comma
id|err
comma
id|sa
comma
id|data
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * rehash alias device with address supplied. &n; */
r_int
DECL|function|net_alias_dev_rehash
id|net_alias_dev_rehash
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
r_struct
id|sockaddr
op_star
id|sa
)paren
(brace
r_struct
id|net_alias_info
op_star
id|alias_info
suffix:semicolon
r_struct
id|net_alias
op_star
id|alias
comma
op_star
op_star
id|aliasp
suffix:semicolon
r_struct
id|device
op_star
id|main_dev
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_struct
id|net_alias_type
op_star
id|o_nat
comma
op_star
id|n_nat
suffix:semicolon
r_int
id|n_hash
suffix:semicolon
multiline_comment|/*&n;   * defensive ...&n;   */
r_if
c_cond
(paren
id|dev
op_eq
l_int|NULL
)paren
r_return
op_minus
l_int|1
suffix:semicolon
r_if
c_cond
(paren
(paren
id|alias
op_assign
id|dev-&gt;my_alias
)paren
op_eq
l_int|NULL
)paren
r_return
op_minus
l_int|1
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|sa
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;ERROR: net_alias_rehash(): NULL sockaddr passed&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
multiline_comment|/*&n;   * defensive. should not happen.&n;   */
r_if
c_cond
(paren
(paren
id|main_dev
op_assign
id|alias-&gt;main_dev
)paren
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;ERROR: net_alias_rehash for %s: NULL maindev&bslash;n&quot;
comma
id|alias-&gt;name
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
multiline_comment|/*&n;   * defensive. should not happen.&n;   */
r_if
c_cond
(paren
op_logical_neg
(paren
id|alias_info
op_assign
id|main_dev-&gt;alias_info
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;ERROR: net_alias_rehash for %s: NULL alias_info&bslash;n&quot;
comma
id|alias-&gt;name
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
multiline_comment|/*&n;   * will the request also change device family?&n;   */
id|o_nat
op_assign
id|alias-&gt;nat
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|o_nat
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;ERROR: net_alias_rehash(%s): unbound alias.&bslash;n&quot;
comma
id|alias-&gt;name
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
multiline_comment|/*&n;   * point to new alias_type obj.&n;   */
r_if
c_cond
(paren
id|o_nat-&gt;type
op_eq
id|sa-&gt;sa_family
)paren
id|n_nat
op_assign
id|o_nat
suffix:semicolon
r_else
(brace
id|n_nat
op_assign
id|nat_getbytype
c_func
(paren
id|sa-&gt;sa_family
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|n_nat
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;ERROR: net_alias_rehash(%s): unreg family==%d.&bslash;n&quot;
comma
id|alias-&gt;name
comma
id|sa-&gt;sa_family
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
)brace
multiline_comment|/*&n;   * new hash key. if same as old AND same type (family) return;&n;   */
id|n_hash
op_assign
id|nat_hash_key
c_func
(paren
id|n_nat
comma
id|sa
)paren
suffix:semicolon
r_if
c_cond
(paren
id|n_hash
op_eq
id|alias-&gt;hash
op_logical_and
id|o_nat
op_eq
id|n_nat
)paren
r_return
l_int|0
suffix:semicolon
multiline_comment|/*&n;   * find alias in hashed list&n;   */
r_for
c_loop
(paren
id|aliasp
op_assign
op_amp
id|alias_info-&gt;hash_tab
(braket
id|alias-&gt;hash
)braket
suffix:semicolon
op_star
id|aliasp
suffix:semicolon
id|aliasp
op_assign
op_amp
(paren
op_star
id|aliasp
)paren
op_member_access_from_pointer
id|next
)paren
r_if
c_cond
(paren
op_star
id|aliasp
op_eq
id|alias
)paren
r_break
suffix:semicolon
multiline_comment|/*&n;   * not found (???). try a full search&n;   */
r_if
c_cond
(paren
op_logical_neg
op_star
id|aliasp
)paren
r_if
c_cond
(paren
(paren
id|aliasp
op_assign
id|net_alias_slow_findp
c_func
(paren
id|alias_info
comma
id|alias
)paren
)paren
)paren
id|printk
c_func
(paren
l_string|&quot;net_alias_rehash(%s): bad hashing recovered&bslash;n&quot;
comma
id|alias-&gt;name
)paren
suffix:semicolon
r_else
(brace
id|printk
c_func
(paren
l_string|&quot;ERROR: net_alias_rehash(%s): unhashed alias!&bslash;n&quot;
comma
id|alias-&gt;name
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/*&n;   * if type (family) changed, unlink from old type object (o_nat)&n;   * will call o_nat-&gt;alias_done_1()&n;   */
r_if
c_cond
(paren
id|o_nat
op_ne
id|n_nat
)paren
id|nat_unbind
c_func
(paren
id|o_nat
comma
id|alias
)paren
suffix:semicolon
multiline_comment|/*&n;   * if diff hash key, change alias position in hashed list&n;   */
r_if
c_cond
(paren
id|n_hash
op_ne
id|alias-&gt;hash
)paren
(brace
op_star
id|aliasp
op_assign
(paren
op_star
id|aliasp
)paren
op_member_access_from_pointer
id|next
suffix:semicolon
id|alias-&gt;hash
op_assign
id|n_hash
suffix:semicolon
id|aliasp
op_assign
op_amp
id|alias_info-&gt;hash_tab
(braket
id|n_hash
)braket
suffix:semicolon
id|alias-&gt;next
op_assign
op_star
id|aliasp
suffix:semicolon
op_star
id|aliasp
op_assign
id|alias
suffix:semicolon
)brace
multiline_comment|/*&n;   * if type (family) changed link to new type object (n_nat)&n;   * will call n_nat-&gt;alias_init_1()&n;   */
r_if
c_cond
(paren
id|o_nat
op_ne
id|n_nat
)paren
id|nat_bind
c_func
(paren
id|n_nat
comma
id|alias
comma
id|sa
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; *  implements /proc/net/alias_types entry&n; *  shows net_alias_type objects registered.&n; */
DECL|function|net_alias_types_getinfo
r_int
id|net_alias_types_getinfo
c_func
(paren
r_char
op_star
id|buffer
comma
r_char
op_star
op_star
id|start
comma
id|off_t
id|offset
comma
r_int
id|length
comma
r_int
id|dummy
)paren
(brace
id|off_t
id|pos
op_assign
l_int|0
comma
id|begin
op_assign
l_int|0
suffix:semicolon
r_int
id|len
op_assign
l_int|0
suffix:semicolon
r_struct
id|net_alias_type
op_star
id|nat
suffix:semicolon
r_int
id|idx
suffix:semicolon
id|len
op_assign
id|sprintf
c_func
(paren
id|buffer
comma
l_string|&quot;type    name            n_attach&bslash;n&quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|idx
op_assign
l_int|0
suffix:semicolon
id|idx
OL
l_int|16
suffix:semicolon
id|idx
op_increment
)paren
r_for
c_loop
(paren
id|nat
op_assign
id|nat_base
(braket
id|idx
)braket
suffix:semicolon
id|nat
suffix:semicolon
id|nat
op_assign
id|nat-&gt;next
)paren
(brace
id|len
op_add_assign
id|sprintf
c_func
(paren
id|buffer
op_plus
id|len
comma
l_string|&quot;%-7d %-15s %-7d&bslash;n&quot;
comma
id|nat-&gt;type
comma
id|nat-&gt;name
comma
id|nat-&gt;n_attach
)paren
suffix:semicolon
id|pos
op_assign
id|begin
op_plus
id|len
suffix:semicolon
r_if
c_cond
(paren
id|pos
OL
id|offset
)paren
(brace
id|len
op_assign
l_int|0
suffix:semicolon
id|begin
op_assign
id|pos
suffix:semicolon
)brace
r_if
c_cond
(paren
id|pos
OG
id|offset
op_plus
id|length
)paren
(brace
r_break
suffix:semicolon
)brace
)brace
op_star
id|start
op_assign
id|buffer
op_plus
(paren
id|offset
op_minus
id|begin
)paren
suffix:semicolon
id|len
op_sub_assign
(paren
id|offset
op_minus
id|begin
)paren
suffix:semicolon
r_if
c_cond
(paren
id|len
OG
id|length
)paren
(brace
id|len
op_assign
id|length
suffix:semicolon
)brace
r_return
id|len
suffix:semicolon
)brace
multiline_comment|/*&n; *  implements /proc/net/aliases entry, shows alias devices.&n; *   calls alias nat-&gt;alias_print_1 if not NULL and formats everything&n; *   to a fixed rec. size without using local (stack) buffers&n; *&n; */
DECL|macro|NET_ALIASES_RECSIZ
mdefine_line|#define NET_ALIASES_RECSIZ 64
DECL|function|net_alias_getinfo
r_int
id|net_alias_getinfo
c_func
(paren
r_char
op_star
id|buffer
comma
r_char
op_star
op_star
id|start
comma
id|off_t
id|offset
comma
r_int
id|length
comma
r_int
id|dummy
)paren
(brace
id|off_t
id|pos
op_assign
l_int|0
comma
id|begin
op_assign
l_int|0
suffix:semicolon
r_int
id|len
op_assign
l_int|0
suffix:semicolon
r_int
id|dlen
suffix:semicolon
r_struct
id|net_alias_type
op_star
id|nat
suffix:semicolon
r_struct
id|net_alias
op_star
id|alias
suffix:semicolon
r_struct
id|device
op_star
id|dev
suffix:semicolon
id|len
op_assign
id|sprintf
c_func
(paren
id|buffer
comma
l_string|&quot;%-*s&bslash;n&quot;
comma
id|NET_ALIASES_RECSIZ
op_minus
l_int|1
comma
l_string|&quot;device           family address&quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|dev
op_assign
id|dev_base
suffix:semicolon
id|dev
suffix:semicolon
id|dev
op_assign
id|dev-&gt;next
)paren
r_if
c_cond
(paren
id|net_alias_is
c_func
(paren
id|dev
)paren
)paren
(brace
id|alias
op_assign
id|dev-&gt;my_alias
suffix:semicolon
id|nat
op_assign
id|alias-&gt;nat
suffix:semicolon
id|dlen
op_assign
id|sprintf
c_func
(paren
id|buffer
op_plus
id|len
comma
l_string|&quot;%-16s %-6d &quot;
comma
id|alias-&gt;name
comma
id|alias-&gt;dev.family
)paren
suffix:semicolon
multiline_comment|/*&n;       * call alias_type specific print function.&n;       */
r_if
c_cond
(paren
id|nat-&gt;alias_print_1
)paren
id|dlen
op_add_assign
id|nat
op_member_access_from_pointer
id|alias_print_1
c_func
(paren
id|nat
comma
id|alias
comma
id|buffer
op_plus
id|len
op_plus
id|dlen
comma
id|NET_ALIASES_RECSIZ
op_minus
id|dlen
)paren
suffix:semicolon
r_else
id|dlen
op_add_assign
id|sprintf
c_func
(paren
id|buffer
op_plus
id|len
op_plus
id|dlen
comma
l_string|&quot;-&quot;
)paren
suffix:semicolon
multiline_comment|/*&n;       * fill with spaces if needed &n;       */
r_if
c_cond
(paren
id|dlen
OL
id|NET_ALIASES_RECSIZ
)paren
id|memset
c_func
(paren
id|buffer
op_plus
id|len
op_plus
id|dlen
comma
l_char|&squot; &squot;
comma
id|NET_ALIASES_RECSIZ
op_minus
id|dlen
)paren
suffix:semicolon
multiline_comment|/*&n;       * truncate to NET_ALIASES_RECSIZ&n;       */
id|len
op_add_assign
id|NET_ALIASES_RECSIZ
suffix:semicolon
id|buffer
(braket
id|len
op_minus
l_int|1
)braket
op_assign
l_char|&squot;&bslash;n&squot;
suffix:semicolon
id|pos
op_assign
id|begin
op_plus
id|len
suffix:semicolon
r_if
c_cond
(paren
id|pos
OL
id|offset
)paren
(brace
id|len
op_assign
l_int|0
suffix:semicolon
id|begin
op_assign
id|pos
suffix:semicolon
)brace
r_if
c_cond
(paren
id|pos
OG
id|offset
op_plus
id|length
)paren
(brace
r_break
suffix:semicolon
)brace
)brace
op_star
id|start
op_assign
id|buffer
op_plus
(paren
id|offset
op_minus
id|begin
)paren
suffix:semicolon
id|len
op_sub_assign
(paren
id|offset
op_minus
id|begin
)paren
suffix:semicolon
r_if
c_cond
(paren
id|len
OG
id|length
)paren
(brace
id|len
op_assign
id|length
suffix:semicolon
)brace
r_return
id|len
suffix:semicolon
)brace
multiline_comment|/*&n; * notifier for devices events&n; */
DECL|function|net_alias_device_event
r_int
id|net_alias_device_event
c_func
(paren
r_struct
id|notifier_block
op_star
id|this
comma
r_int
r_int
id|event
comma
r_void
op_star
id|ptr
)paren
(brace
r_struct
id|device
op_star
id|dev
op_assign
id|ptr
suffix:semicolon
r_if
c_cond
(paren
id|event
op_eq
id|NETDEV_DOWN
)paren
(brace
macro_line|#ifdef ALIAS_USER_LAND_DEBUG
id|printk
c_func
(paren
l_string|&quot;net_alias: NETDEV_DOWN for %s received&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|net_alias_has
c_func
(paren
id|dev
)paren
)paren
id|net_alias_free
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|event
op_eq
id|NETDEV_UP
)paren
(brace
macro_line|#ifdef ALIAS_USER_LAND_DEBUG
id|printk
c_func
(paren
l_string|&quot;net_alias: NETDEV_UP for %s received&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
macro_line|#endif
id|dev-&gt;alias_info
op_assign
l_int|0
suffix:semicolon
)brace
r_return
id|NOTIFY_DONE
suffix:semicolon
)brace
multiline_comment|/*&n; * device aliases address comparison workhorse&n; * no checks for nat and alias_info, must be !NULL&n; */
r_static
id|__inline__
r_struct
id|device
op_star
DECL|function|nat_addr_chk
id|nat_addr_chk
c_func
(paren
r_struct
id|net_alias_type
op_star
id|nat
comma
r_struct
id|net_alias_info
op_star
id|alias_info
comma
r_struct
id|sockaddr
op_star
id|sa
comma
r_int
id|flags_on
comma
r_int
id|flags_off
)paren
(brace
r_struct
id|net_alias
op_star
id|alias
suffix:semicolon
r_for
c_loop
(paren
id|alias
op_assign
id|alias_info-&gt;hash_tab
(braket
id|nat_hash_key
c_func
(paren
id|nat
comma
id|sa
)paren
)braket
suffix:semicolon
id|alias
suffix:semicolon
id|alias
op_assign
id|alias-&gt;next
)paren
(brace
r_if
c_cond
(paren
id|alias-&gt;dev.family
op_ne
id|sa-&gt;sa_family
)paren
r_continue
suffix:semicolon
multiline_comment|/*&n;     * nat_dev_addr_chk_1 will call type specific address cmp function.&n;     */
r_if
c_cond
(paren
id|alias-&gt;dev.flags
op_amp
id|flags_on
op_logical_and
op_logical_neg
(paren
id|alias-&gt;dev.flags
op_amp
id|flags_off
)paren
op_logical_and
id|nat_dev_addr_chk_1
c_func
(paren
id|nat
comma
op_amp
id|alias-&gt;dev
comma
id|sa
)paren
)paren
r_return
op_amp
id|alias-&gt;dev
suffix:semicolon
)brace
r_return
l_int|NULL
suffix:semicolon
)brace
multiline_comment|/*&n; * nat_addr_chk enough for protocols whose addr is (fully) stored at pa_addr.&n; * note that nat pointer is ignored because of static comparison.&n; */
r_static
id|__inline__
r_struct
id|device
op_star
DECL|function|nat_addr_chk32
id|nat_addr_chk32
c_func
(paren
r_struct
id|net_alias_type
op_star
id|nat
comma
r_struct
id|net_alias_info
op_star
id|alias_info
comma
r_int
id|family
comma
id|__u32
id|addr32
comma
r_int
id|flags_on
comma
r_int
id|flags_off
)paren
(brace
r_struct
id|net_alias
op_star
id|alias
suffix:semicolon
r_for
c_loop
(paren
id|alias
op_assign
id|alias_info-&gt;hash_tab
(braket
id|HASH
c_func
(paren
id|addr32
comma
id|family
)paren
)braket
suffix:semicolon
id|alias
suffix:semicolon
id|alias
op_assign
id|alias-&gt;next
)paren
(brace
r_if
c_cond
(paren
id|alias-&gt;dev.family
op_ne
id|family
)paren
r_continue
suffix:semicolon
multiline_comment|/*&n;     * &quot;hard&quot; (static) comparison between addr32 and pa_addr.&n;     */
r_if
c_cond
(paren
id|alias-&gt;dev.flags
op_amp
id|flags_on
op_logical_and
op_logical_neg
(paren
id|alias-&gt;dev.flags
op_amp
id|flags_off
)paren
op_logical_and
id|addr32
op_eq
id|alias-&gt;dev.pa_addr
)paren
r_return
op_amp
id|alias-&gt;dev
suffix:semicolon
)brace
r_return
l_int|NULL
suffix:semicolon
)brace
multiline_comment|/*&n; * returns alias device with specified address AND flags_on AND flags_off,&n; * else NULL.&n; * intended for main devices.&n; */
r_struct
id|device
op_star
DECL|function|net_alias_dev_chk
id|net_alias_dev_chk
c_func
(paren
r_struct
id|device
op_star
id|main_dev
comma
r_struct
id|sockaddr
op_star
id|sa
comma
r_int
id|flags_on
comma
r_int
id|flags_off
)paren
(brace
r_struct
id|net_alias_info
op_star
id|alias_info
op_assign
id|main_dev-&gt;alias_info
suffix:semicolon
r_struct
id|net_alias_type
op_star
id|nat
suffix:semicolon
multiline_comment|/*&n;   * only if main_dev has aliases&n;   */
r_if
c_cond
(paren
op_logical_neg
id|alias_info
)paren
r_return
l_int|NULL
suffix:semicolon
multiline_comment|/*&n;   * get alias_type object for sa-&gt;sa_family.&n;   */
id|nat
op_assign
id|nat_getbytype
c_func
(paren
id|sa-&gt;sa_family
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|nat
)paren
r_return
l_int|NULL
suffix:semicolon
r_return
id|nat_addr_chk
c_func
(paren
id|nat
comma
id|alias_info
comma
id|sa
comma
id|flags_on
comma
id|flags_off
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * net_alias_dev_chk enough for protocols whose addr is (fully) stored&n; * at pa_addr.&n; */
r_struct
id|device
op_star
DECL|function|net_alias_dev_chk32
id|net_alias_dev_chk32
c_func
(paren
r_struct
id|device
op_star
id|main_dev
comma
r_int
id|family
comma
id|__u32
id|addr32
comma
r_int
id|flags_on
comma
r_int
id|flags_off
)paren
(brace
r_struct
id|net_alias_info
op_star
id|alias_info
op_assign
id|main_dev-&gt;alias_info
suffix:semicolon
multiline_comment|/*&n;   * only if main_dev has aliases&n;   */
r_if
c_cond
(paren
op_logical_neg
id|alias_info
)paren
r_return
l_int|NULL
suffix:semicolon
r_return
id|nat_addr_chk32
c_func
(paren
l_int|NULL
comma
id|alias_info
comma
id|family
comma
id|addr32
comma
id|flags_on
comma
id|flags_off
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * select closest (main or alias) device to &lt;src,dst&gt; addresses given. if no&n; * further info is available, return main_dev (for easier calling arrangement).&n; *&n; * Should be called early at xxx_rcv() time for device selection&n; */
r_struct
id|device
op_star
DECL|function|net_alias_dev_rcv_sel
id|net_alias_dev_rcv_sel
c_func
(paren
r_struct
id|device
op_star
id|main_dev
comma
r_struct
id|sockaddr
op_star
id|sa_src
comma
r_struct
id|sockaddr
op_star
id|sa_dst
)paren
(brace
r_int
id|family
suffix:semicolon
r_struct
id|net_alias_type
op_star
id|nat
suffix:semicolon
r_struct
id|net_alias_info
op_star
id|alias_info
suffix:semicolon
r_struct
id|device
op_star
id|dev
suffix:semicolon
r_if
c_cond
(paren
id|main_dev
op_eq
l_int|NULL
)paren
r_return
l_int|NULL
suffix:semicolon
multiline_comment|/*&n;   * if not aliased, don&squot;t bother any more&n;   */
r_if
c_cond
(paren
(paren
id|alias_info
op_assign
id|main_dev-&gt;alias_info
)paren
op_eq
l_int|NULL
)paren
r_return
id|main_dev
suffix:semicolon
multiline_comment|/*&n;   * find out family&n;   */
id|family
op_assign
(paren
id|sa_src
)paren
ques
c_cond
id|sa_src-&gt;sa_family
suffix:colon
(paren
(paren
id|sa_dst
)paren
ques
c_cond
id|sa_dst-&gt;sa_family
suffix:colon
id|AF_UNSPEC
)paren
suffix:semicolon
r_if
c_cond
(paren
id|family
op_eq
id|AF_UNSPEC
)paren
r_return
id|main_dev
suffix:semicolon
multiline_comment|/*&n;   * get net_alias_type object for this family&n;   */
r_if
c_cond
(paren
(paren
id|nat
op_assign
id|nat_getbytype
c_func
(paren
id|family
)paren
)paren
op_eq
l_int|NULL
)paren
r_return
id|main_dev
suffix:semicolon
multiline_comment|/*&n;   * first step: find out if dst addr is main_dev&squot;s or one of its aliases&squot;&n;   */
r_if
c_cond
(paren
id|sa_dst
)paren
(brace
r_if
c_cond
(paren
id|nat_dev_addr_chk_1
c_func
(paren
id|nat
comma
id|main_dev
comma
id|sa_dst
)paren
)paren
r_return
id|main_dev
suffix:semicolon
id|dev
op_assign
id|nat_addr_chk
c_func
(paren
id|nat
comma
id|alias_info
comma
id|sa_dst
comma
id|IFF_UP
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dev
op_ne
l_int|NULL
)paren
r_return
id|dev
suffix:semicolon
)brace
multiline_comment|/*&n;   * second step: find the rcv addr &squot;closest&squot; alias through nat method call&n;   */
r_if
c_cond
(paren
id|sa_src
op_eq
l_int|NULL
op_logical_or
id|nat-&gt;dev_select
op_eq
l_int|NULL
)paren
r_return
id|main_dev
suffix:semicolon
id|dev
op_assign
id|nat
op_member_access_from_pointer
id|dev_select
c_func
(paren
id|nat
comma
id|main_dev
comma
id|sa_src
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dev
op_eq
l_int|NULL
op_logical_or
id|dev-&gt;family
op_ne
id|family
)paren
r_return
id|main_dev
suffix:semicolon
multiline_comment|/*&n;   * dev ok only if it is alias of main_dev&n;   */
id|dev
op_assign
id|net_alias_is
c_func
(paren
id|dev
)paren
ques
c_cond
(paren
(paren
id|dev-&gt;my_alias-&gt;main_dev
op_eq
id|main_dev
)paren
ques
c_cond
id|dev
suffix:colon
l_int|NULL
)paren
suffix:colon
l_int|NULL
suffix:semicolon
multiline_comment|/*&n;   * do not return NULL.&n;   */
r_return
(paren
id|dev
)paren
ques
c_cond
id|dev
suffix:colon
id|main_dev
suffix:semicolon
)brace
multiline_comment|/*&n; * dev_rcv_sel32: dev_rcv_sel for &squot;pa_addr&squot; protocols.&n; */
r_struct
id|device
op_star
DECL|function|net_alias_dev_rcv_sel32
id|net_alias_dev_rcv_sel32
c_func
(paren
r_struct
id|device
op_star
id|main_dev
comma
r_int
id|family
comma
id|__u32
id|src
comma
id|__u32
id|dst
)paren
(brace
r_struct
id|net_alias_type
op_star
id|nat
suffix:semicolon
r_struct
id|net_alias_info
op_star
id|alias_info
suffix:semicolon
r_struct
id|sockaddr_in
id|sin_src
suffix:semicolon
r_struct
id|device
op_star
id|dev
suffix:semicolon
r_if
c_cond
(paren
id|main_dev
op_eq
l_int|NULL
)paren
r_return
l_int|NULL
suffix:semicolon
multiline_comment|/*&n;   * if not aliased, don&squot;t bother any more&n;   */
r_if
c_cond
(paren
(paren
id|alias_info
op_assign
id|main_dev-&gt;alias_info
)paren
op_eq
l_int|NULL
)paren
r_return
id|main_dev
suffix:semicolon
multiline_comment|/*&n;   * early return if dst is main_dev&squot;s address&n;   */
r_if
c_cond
(paren
id|dst
op_eq
id|main_dev-&gt;pa_addr
)paren
r_return
id|main_dev
suffix:semicolon
r_if
c_cond
(paren
id|family
op_eq
id|AF_UNSPEC
)paren
r_return
id|main_dev
suffix:semicolon
multiline_comment|/*&n;   * get net_alias_type object for this family&n;   */
r_if
c_cond
(paren
(paren
id|nat
op_assign
id|nat_getbytype
c_func
(paren
id|family
)paren
)paren
op_eq
l_int|NULL
)paren
r_return
id|main_dev
suffix:semicolon
multiline_comment|/*&n;   * first step: find out if dst address one of main_dev aliases&squot;&n;   */
r_if
c_cond
(paren
id|dst
)paren
(brace
id|dev
op_assign
id|nat_addr_chk32
c_func
(paren
id|nat
comma
id|alias_info
comma
id|family
comma
id|dst
comma
id|IFF_UP
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dev
)paren
r_return
id|dev
suffix:semicolon
)brace
multiline_comment|/*&n;   * second step: find the rcv addr &squot;closest&squot; alias through nat method call&n;   */
r_if
c_cond
(paren
id|src
op_eq
l_int|0
op_logical_or
id|nat-&gt;dev_select
op_eq
l_int|NULL
)paren
r_return
id|main_dev
suffix:semicolon
id|sin_src.sin_family
op_assign
id|family
suffix:semicolon
id|sin_src.sin_addr.s_addr
op_assign
id|src
suffix:semicolon
id|dev
op_assign
id|nat
op_member_access_from_pointer
id|dev_select
c_func
(paren
id|nat
comma
id|main_dev
comma
(paren
r_struct
id|sockaddr
op_star
)paren
op_amp
id|sin_src
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dev
op_eq
l_int|NULL
op_logical_or
id|dev-&gt;family
op_ne
id|family
)paren
r_return
id|main_dev
suffix:semicolon
multiline_comment|/*&n;   * dev ok only if it is alias of main_dev&n;   */
id|dev
op_assign
id|net_alias_is
c_func
(paren
id|dev
)paren
ques
c_cond
(paren
(paren
id|dev-&gt;my_alias-&gt;main_dev
op_eq
id|main_dev
)paren
ques
c_cond
id|dev
suffix:colon
l_int|NULL
)paren
suffix:colon
l_int|NULL
suffix:semicolon
multiline_comment|/*&n;   * do not return NULL.&n;   */
r_return
(paren
id|dev
)paren
ques
c_cond
id|dev
suffix:colon
id|main_dev
suffix:semicolon
)brace
multiline_comment|/*&n; * device event hook&n; */
DECL|variable|net_alias_dev_notifier
r_static
r_struct
id|notifier_block
id|net_alias_dev_notifier
op_assign
(brace
id|net_alias_device_event
comma
l_int|NULL
comma
l_int|0
)brace
suffix:semicolon
multiline_comment|/*&n; * net_alias initialisation&n; * called from net_dev_init().&n; */
DECL|function|net_alias_init
r_void
id|net_alias_init
c_func
(paren
r_void
)paren
(brace
multiline_comment|/*&n;   * register dev events notifier&n;   */
id|register_netdevice_notifier
c_func
(paren
op_amp
id|net_alias_dev_notifier
)paren
suffix:semicolon
multiline_comment|/*&n;   * register /proc/net entries&n;   */
macro_line|#ifndef ALIAS_USER_LAND_DEBUG
id|proc_net_register
c_func
(paren
op_amp
(paren
r_struct
id|proc_dir_entry
)paren
(brace
id|PROC_NET_ALIAS_TYPES
comma
l_int|11
comma
l_string|&quot;alias_types&quot;
comma
id|S_IFREG
op_or
id|S_IRUGO
comma
l_int|1
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
op_amp
id|proc_net_inode_operations
comma
id|net_alias_types_getinfo
)brace
)paren
suffix:semicolon
id|proc_net_register
c_func
(paren
op_amp
(paren
r_struct
id|proc_dir_entry
)paren
(brace
id|PROC_NET_ALIASES
comma
l_int|7
comma
l_string|&quot;aliases&quot;
comma
id|S_IFREG
op_or
id|S_IRUGO
comma
l_int|1
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
op_amp
id|proc_net_inode_operations
comma
id|net_alias_getinfo
)brace
)paren
suffix:semicolon
macro_line|#endif
)brace
multiline_comment|/*&n; * net_alias type object registering func.&n; */
DECL|function|register_net_alias_type
r_int
id|register_net_alias_type
c_func
(paren
r_struct
id|net_alias_type
op_star
id|nat
comma
r_int
id|type
)paren
(brace
r_int
id|hash
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|nat
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;register_net_alias_type(): NULL arg&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|nat-&gt;type
op_assign
id|type
suffix:semicolon
id|nat-&gt;n_attach
op_assign
l_int|0
suffix:semicolon
id|hash
op_assign
id|nat-&gt;type
op_amp
l_int|0x0f
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|nat-&gt;next
op_assign
id|nat_base
(braket
id|hash
)braket
suffix:semicolon
id|nat_base
(braket
id|hash
)braket
op_assign
id|nat
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * net_alias type object unreg.&n; */
DECL|function|unregister_net_alias_type
r_int
id|unregister_net_alias_type
c_func
(paren
r_struct
id|net_alias_type
op_star
id|nat
)paren
(brace
r_struct
id|net_alias_type
op_star
op_star
id|natp
suffix:semicolon
r_int
id|hash
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|nat
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;unregister_net_alias_type(): NULL arg&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
multiline_comment|/*&n;   * only allow unregistration if it has no attachments&n;   */
r_if
c_cond
(paren
id|nat-&gt;n_attach
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;unregister_net_alias_type(): has %d attachments. failed&bslash;n&quot;
comma
id|nat-&gt;n_attach
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|hash
op_assign
id|nat-&gt;type
op_amp
l_int|0x0f
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|natp
op_assign
op_amp
id|nat_base
(braket
id|hash
)braket
suffix:semicolon
op_star
id|natp
suffix:semicolon
id|natp
op_assign
op_amp
(paren
op_star
id|natp
)paren
op_member_access_from_pointer
id|next
)paren
(brace
r_if
c_cond
(paren
id|nat
op_eq
(paren
op_star
id|natp
)paren
)paren
(brace
op_star
id|natp
op_assign
id|nat-&gt;next
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
)brace
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;unregister_net_alias_type(type=%d): not found!&bslash;n&quot;
comma
id|nat-&gt;type
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
eof
