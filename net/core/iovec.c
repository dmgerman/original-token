multiline_comment|/*&n; *&t;iovec manipulation routines.&n; *&n; *&n; *&t;&t;This program is free software; you can redistribute it and/or&n; *&t;&t;modify it under the terms of the GNU General Public License&n; *&t;&t;as published by the Free Software Foundation; either version&n; *&t;&t;2 of the License, or (at your option) any later version.&n; *&n; *&t;Fixes:&n; *&t;&t;Andrew Lunn&t;:&t;Errors in iovec copying.&n; *&t;&t;Pedro Roque&t;:&t;Added memcpy_fromiovecend and&n; *&t;&t;&t;&t;&t;csum_..._fromiovecend.&n; *&t;&t;Andi Kleen&t;:&t;fixed error handling for 2.1&n; *&t;&t;Alexey Kuznetsov:&t;2.1 optimisations&n; */
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/mm.h&gt;
macro_line|#include &lt;linux/malloc.h&gt;
macro_line|#include &lt;linux/net.h&gt;
macro_line|#include &lt;linux/in6.h&gt;
macro_line|#include &lt;asm/uaccess.h&gt;
macro_line|#include &lt;asm/byteorder.h&gt;
macro_line|#include &lt;asm/checksum.h&gt;
DECL|function|min
r_extern
r_inline
r_int
id|min
c_func
(paren
r_int
id|x
comma
r_int
id|y
)paren
(brace
r_return
id|x
OG
id|y
ques
c_cond
id|y
suffix:colon
id|x
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;Verify iovec&n; *&t;verify area does a simple check for completly bogus addresses&n; *&n; *&t;Save time not doing verify_area. copy_*_user will make this work&n; *&t;in any case.&n; */
DECL|function|verify_iovec
r_int
id|verify_iovec
c_func
(paren
r_struct
id|msghdr
op_star
id|m
comma
r_struct
id|iovec
op_star
id|iov
comma
r_char
op_star
id|address
comma
r_int
id|mode
)paren
(brace
r_int
id|err
op_assign
l_int|0
suffix:semicolon
r_int
id|len
op_assign
l_int|0
suffix:semicolon
r_int
id|ct
suffix:semicolon
r_if
c_cond
(paren
id|m-&gt;msg_namelen
)paren
(brace
r_if
c_cond
(paren
id|mode
op_eq
id|VERIFY_READ
)paren
(brace
id|err
op_assign
id|move_addr_to_kernel
c_func
(paren
id|m-&gt;msg_name
comma
id|m-&gt;msg_namelen
comma
id|address
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
OL
l_int|0
)paren
(brace
r_return
id|err
suffix:semicolon
)brace
)brace
id|m-&gt;msg_name
op_assign
id|address
suffix:semicolon
)brace
r_else
id|m-&gt;msg_name
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
id|m-&gt;msg_iovlen
OG
id|UIO_FASTIOV
)paren
(brace
id|iov
op_assign
id|kmalloc
c_func
(paren
id|m-&gt;msg_iovlen
op_star
r_sizeof
(paren
r_struct
id|iovec
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|iov
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|err
op_assign
id|copy_from_user
c_func
(paren
id|iov
comma
id|m-&gt;msg_iov
comma
r_sizeof
(paren
r_struct
id|iovec
)paren
op_star
id|m-&gt;msg_iovlen
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
(brace
r_if
c_cond
(paren
id|m-&gt;msg_iovlen
OG
id|UIO_FASTIOV
)paren
id|kfree
c_func
(paren
id|iov
)paren
suffix:semicolon
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
r_for
c_loop
(paren
id|ct
op_assign
l_int|0
suffix:semicolon
id|ct
OL
id|m-&gt;msg_iovlen
suffix:semicolon
id|ct
op_increment
)paren
(brace
id|len
op_add_assign
id|iov
(braket
id|ct
)braket
dot
id|iov_len
suffix:semicolon
)brace
id|m-&gt;msg_iov
op_assign
id|iov
suffix:semicolon
r_return
id|len
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;Copy kernel to iovec.&n; */
DECL|function|memcpy_toiovec
r_int
id|memcpy_toiovec
c_func
(paren
r_struct
id|iovec
op_star
id|iov
comma
r_int
r_char
op_star
id|kdata
comma
r_int
id|len
)paren
(brace
r_int
id|err
suffix:semicolon
r_while
c_loop
(paren
id|len
OG
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|iov-&gt;iov_len
)paren
(brace
r_int
id|copy
op_assign
id|min
c_func
(paren
id|iov-&gt;iov_len
comma
id|len
)paren
suffix:semicolon
id|err
op_assign
id|copy_to_user
c_func
(paren
id|iov-&gt;iov_base
comma
id|kdata
comma
id|copy
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
r_return
id|err
suffix:semicolon
id|kdata
op_add_assign
id|copy
suffix:semicolon
id|len
op_sub_assign
id|copy
suffix:semicolon
id|iov-&gt;iov_len
op_sub_assign
id|copy
suffix:semicolon
id|iov-&gt;iov_base
op_add_assign
id|copy
suffix:semicolon
)brace
id|iov
op_increment
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;Copy iovec to kernel.&n; */
DECL|function|memcpy_fromiovec
r_int
id|memcpy_fromiovec
c_func
(paren
r_int
r_char
op_star
id|kdata
comma
r_struct
id|iovec
op_star
id|iov
comma
r_int
id|len
)paren
(brace
r_int
id|err
suffix:semicolon
r_while
c_loop
(paren
id|len
OG
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|iov-&gt;iov_len
)paren
(brace
r_int
id|copy
op_assign
id|min
c_func
(paren
id|len
comma
id|iov-&gt;iov_len
)paren
suffix:semicolon
id|err
op_assign
id|copy_from_user
c_func
(paren
id|kdata
comma
id|iov-&gt;iov_base
comma
id|copy
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
(brace
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
id|len
op_sub_assign
id|copy
suffix:semicolon
id|kdata
op_add_assign
id|copy
suffix:semicolon
id|iov-&gt;iov_base
op_add_assign
id|copy
suffix:semicolon
id|iov-&gt;iov_len
op_sub_assign
id|copy
suffix:semicolon
)brace
id|iov
op_increment
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;For use with ip_build_xmit&n; */
DECL|function|memcpy_fromiovecend
r_int
id|memcpy_fromiovecend
c_func
(paren
r_int
r_char
op_star
id|kdata
comma
r_struct
id|iovec
op_star
id|iov
comma
r_int
id|offset
comma
r_int
id|len
)paren
(brace
r_int
id|err
suffix:semicolon
r_while
c_loop
(paren
id|offset
OG
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|offset
OG
id|iov-&gt;iov_len
)paren
(brace
id|offset
op_sub_assign
id|iov-&gt;iov_len
suffix:semicolon
)brace
r_else
(brace
id|u8
op_star
id|base
suffix:semicolon
r_int
id|copy
suffix:semicolon
id|base
op_assign
id|iov-&gt;iov_base
op_plus
id|offset
suffix:semicolon
id|copy
op_assign
id|min
c_func
(paren
id|len
comma
id|iov-&gt;iov_len
op_minus
id|offset
)paren
suffix:semicolon
id|offset
op_assign
l_int|0
suffix:semicolon
id|err
op_assign
id|copy_from_user
c_func
(paren
id|kdata
comma
id|base
comma
id|copy
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
(brace
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
id|len
op_sub_assign
id|copy
suffix:semicolon
id|kdata
op_add_assign
id|copy
suffix:semicolon
)brace
id|iov
op_increment
suffix:semicolon
)brace
r_while
c_loop
(paren
id|len
OG
l_int|0
)paren
(brace
r_int
id|copy
op_assign
id|min
c_func
(paren
id|len
comma
id|iov-&gt;iov_len
)paren
suffix:semicolon
id|err
op_assign
id|copy_from_user
c_func
(paren
id|kdata
comma
id|iov-&gt;iov_base
comma
id|copy
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
(brace
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
id|len
op_sub_assign
id|copy
suffix:semicolon
id|kdata
op_add_assign
id|copy
suffix:semicolon
id|iov
op_increment
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;And now for the all-in-one: copy and checksum from a user iovec&n; *&t;directly to a datagram&n; *&t;Calls to csum_partial but the last must be in 32 bit chunks&n; *&n; *&t;ip_build_xmit must ensure that when fragmenting only the last&n; *&t;call to this function will be unaligned also.&n; *&n; *&t;FIXME: add an error handling path when a copy/checksum from&n; *&t;user space failed because of a invalid pointer.&n; */
DECL|function|csum_partial_copy_fromiovecend
r_int
r_int
id|csum_partial_copy_fromiovecend
c_func
(paren
r_int
r_char
op_star
id|kdata
comma
r_struct
id|iovec
op_star
id|iov
comma
r_int
id|offset
comma
r_int
id|len
comma
r_int
id|csum
)paren
(brace
id|__u32
id|partial
suffix:semicolon
id|__u32
id|partial_cnt
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
id|offset
OG
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|offset
OG
id|iov-&gt;iov_len
)paren
(brace
id|offset
op_sub_assign
id|iov-&gt;iov_len
suffix:semicolon
)brace
r_else
(brace
id|u8
op_star
id|base
suffix:semicolon
r_int
id|copy
suffix:semicolon
id|base
op_assign
id|iov-&gt;iov_base
op_plus
id|offset
suffix:semicolon
id|copy
op_assign
id|min
c_func
(paren
id|len
comma
id|iov-&gt;iov_len
op_minus
id|offset
)paren
suffix:semicolon
id|offset
op_assign
l_int|0
suffix:semicolon
id|partial_cnt
op_assign
id|copy
op_mod
l_int|4
suffix:semicolon
r_if
c_cond
(paren
id|partial_cnt
)paren
(brace
id|copy
op_sub_assign
id|partial_cnt
suffix:semicolon
id|copy_from_user
c_func
(paren
op_amp
id|partial
comma
id|base
op_plus
id|copy
comma
id|partial_cnt
)paren
suffix:semicolon
)brace
multiline_comment|/*&t;&n;&t;&t;&t; *&t;FIXME: add exception handling to the&n;&t;&t;&t; *&t;csum functions and set *err when an&n;&t;&t;&t; *&t;exception occurs.&n;&t;&t;&t; */
id|csum
op_assign
id|csum_partial_copy_fromuser
c_func
(paren
id|base
comma
id|kdata
comma
id|copy
comma
id|csum
)paren
suffix:semicolon
id|len
op_sub_assign
id|copy
op_plus
id|partial_cnt
suffix:semicolon
id|kdata
op_add_assign
id|copy
op_plus
id|partial_cnt
suffix:semicolon
)brace
id|iov
op_increment
suffix:semicolon
)brace
r_while
c_loop
(paren
id|len
OG
l_int|0
)paren
(brace
id|u8
op_star
id|base
op_assign
id|iov-&gt;iov_base
suffix:semicolon
r_int
id|copy
op_assign
id|min
c_func
(paren
id|len
comma
id|iov-&gt;iov_len
)paren
suffix:semicolon
r_if
c_cond
(paren
id|partial_cnt
)paren
(brace
r_int
id|par_len
op_assign
l_int|4
op_minus
id|partial_cnt
suffix:semicolon
id|copy_from_user
c_func
(paren
op_amp
id|partial
comma
id|base
op_plus
id|partial_cnt
comma
id|par_len
)paren
suffix:semicolon
id|csum
op_assign
id|csum_partial
c_func
(paren
(paren
id|u8
op_star
)paren
op_amp
id|partial
comma
l_int|4
comma
id|csum
)paren
suffix:semicolon
id|base
op_add_assign
id|par_len
suffix:semicolon
id|copy
op_sub_assign
id|par_len
suffix:semicolon
id|partial_cnt
op_assign
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|len
op_minus
id|copy
OG
l_int|0
)paren
(brace
id|partial_cnt
op_assign
id|copy
op_mod
l_int|4
suffix:semicolon
r_if
c_cond
(paren
id|partial_cnt
)paren
(brace
id|copy
op_sub_assign
id|partial_cnt
suffix:semicolon
id|copy_from_user
c_func
(paren
op_amp
id|partial
comma
id|base
op_plus
id|copy
comma
id|partial_cnt
)paren
suffix:semicolon
)brace
)brace
id|csum
op_assign
id|csum_partial_copy_fromuser
c_func
(paren
id|base
comma
id|kdata
comma
id|copy
comma
id|csum
)paren
suffix:semicolon
id|len
op_sub_assign
id|copy
op_plus
id|partial_cnt
suffix:semicolon
id|kdata
op_add_assign
id|copy
op_plus
id|partial_cnt
suffix:semicolon
id|iov
op_increment
suffix:semicolon
)brace
r_return
id|csum
suffix:semicolon
)brace
eof
