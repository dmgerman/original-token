multiline_comment|/*&n; *&t;Linux INET6 implementation &n; *&t;Forwarding Information Database&n; *&n; *&t;Authors:&n; *&t;Pedro Roque&t;&t;&lt;roque@di.fc.ul.pt&gt;&t;&n; *&n; *&t;$Id: ip6_fib.c,v 1.10 1997/12/13 21:53:10 kuznet Exp $&n; *&n; *&t;This program is free software; you can redistribute it and/or&n; *      modify it under the terms of the GNU General Public License&n; *      as published by the Free Software Foundation; either version&n; *      2 of the License, or (at your option) any later version.&n; */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/net.h&gt;
macro_line|#include &lt;linux/route.h&gt;
macro_line|#include &lt;linux/netdevice.h&gt;
macro_line|#include &lt;linux/in6.h&gt;
macro_line|#ifdef &t;CONFIG_PROC_FS
macro_line|#include &lt;linux/proc_fs.h&gt;
macro_line|#endif
macro_line|#include &lt;net/ipv6.h&gt;
macro_line|#include &lt;net/ndisc.h&gt;
macro_line|#include &lt;net/addrconf.h&gt;
macro_line|#include &lt;net/ip6_fib.h&gt;
macro_line|#include &lt;net/ip6_route.h&gt;
DECL|macro|RT_DEBUG
mdefine_line|#define RT_DEBUG 2
DECL|variable|rt6_stats
r_struct
id|rt6_statistics
id|rt6_stats
suffix:semicolon
multiline_comment|/*&n; *&t;A routing update causes an increase of the serial number on the&n; *&t;afected subtree. This allows for cached routes to be asynchronously&n; *&t;tested when modifications are made to the destination cache as a&n; *&t;result of redirects, path MTU changes, etc.&n; */
DECL|variable|rt_sernum
r_static
id|__u32
id|rt_sernum
op_assign
l_int|0
suffix:semicolon
DECL|variable|ip6_fib_timer
r_static
r_struct
id|timer_list
id|ip6_fib_timer
op_assign
(brace
l_int|NULL
comma
l_int|NULL
comma
l_int|0
comma
l_int|0
comma
id|fib6_run_gc
)brace
suffix:semicolon
multiline_comment|/*&n; *&t;Auxiliary address test functions for the radix tree.&n; *&n; *&t;These assume a 32bit processor (although it will work on &n; *&t;64bit processors)&n; */
multiline_comment|/*&n; *&t;compare &quot;prefix length&quot; bits of an address&n; */
DECL|function|addr_match
r_static
id|__inline__
r_int
id|addr_match
c_func
(paren
r_void
op_star
id|token1
comma
r_void
op_star
id|token2
comma
r_int
id|prefixlen
)paren
(brace
id|__u32
op_star
id|a1
op_assign
id|token1
suffix:semicolon
id|__u32
op_star
id|a2
op_assign
id|token2
suffix:semicolon
r_int
id|pdw
suffix:semicolon
r_int
id|pbi
suffix:semicolon
id|pdw
op_assign
id|prefixlen
op_rshift
l_int|0x05
suffix:semicolon
multiline_comment|/* num of whole __u32 in prefix */
id|pbi
op_assign
id|prefixlen
op_amp
l_int|0x1f
suffix:semicolon
multiline_comment|/* num of bits in incomplete u32 in prefix */
r_if
c_cond
(paren
id|pdw
)paren
r_if
c_cond
(paren
id|memcmp
c_func
(paren
id|a1
comma
id|a2
comma
id|pdw
op_lshift
l_int|2
)paren
)paren
r_return
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|pbi
)paren
(brace
id|__u32
id|w1
comma
id|w2
suffix:semicolon
id|__u32
id|mask
suffix:semicolon
id|w1
op_assign
id|a1
(braket
id|pdw
)braket
suffix:semicolon
id|w2
op_assign
id|a2
(braket
id|pdw
)braket
suffix:semicolon
id|mask
op_assign
id|htonl
c_func
(paren
(paren
l_int|0xffffffff
)paren
op_lshift
(paren
l_int|0x20
op_minus
id|pbi
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|w1
op_xor
id|w2
)paren
op_amp
id|mask
)paren
r_return
l_int|0
suffix:semicolon
)brace
r_return
l_int|1
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;test bit&n; */
DECL|function|addr_bit_set
r_static
id|__inline__
r_int
id|addr_bit_set
c_func
(paren
r_void
op_star
id|token
comma
r_int
id|fn_bit
)paren
(brace
r_int
id|dw
suffix:semicolon
id|__u32
id|b1
suffix:semicolon
id|__u32
id|mask
suffix:semicolon
r_int
id|bit
op_assign
id|fn_bit
suffix:semicolon
id|__u32
op_star
id|addr
op_assign
id|token
suffix:semicolon
id|dw
op_assign
id|bit
op_rshift
l_int|0x05
suffix:semicolon
id|b1
op_assign
id|addr
(braket
id|dw
)braket
suffix:semicolon
id|bit
op_assign
op_complement
id|bit
suffix:semicolon
id|bit
op_and_assign
l_int|0x1f
suffix:semicolon
id|mask
op_assign
id|htonl
c_func
(paren
l_int|1
op_lshift
id|bit
)paren
suffix:semicolon
r_return
(paren
id|b1
op_amp
id|mask
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;find the first different bit between two addresses&n; *&t;length of address must be a multiple of 32bits&n; */
DECL|function|addr_diff
r_static
id|__inline__
r_int
id|addr_diff
c_func
(paren
r_void
op_star
id|token1
comma
r_void
op_star
id|token2
comma
r_int
id|addrlen
)paren
(brace
id|__u32
op_star
id|a1
op_assign
id|token1
suffix:semicolon
id|__u32
op_star
id|a2
op_assign
id|token2
suffix:semicolon
r_int
id|i
suffix:semicolon
id|addrlen
op_rshift_assign
l_int|2
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|addrlen
suffix:semicolon
id|i
op_increment
)paren
(brace
id|__u32
id|b1
comma
id|b2
suffix:semicolon
id|__u32
id|xb
suffix:semicolon
id|b1
op_assign
id|a1
(braket
id|i
)braket
suffix:semicolon
id|b2
op_assign
id|a2
(braket
id|i
)braket
suffix:semicolon
id|xb
op_assign
id|b1
op_xor
id|b2
suffix:semicolon
r_if
c_cond
(paren
id|xb
)paren
(brace
r_int
id|res
op_assign
l_int|0
suffix:semicolon
r_int
id|j
op_assign
l_int|31
suffix:semicolon
id|xb
op_assign
id|ntohl
c_func
(paren
id|xb
)paren
suffix:semicolon
r_while
c_loop
(paren
id|test_bit
c_func
(paren
id|j
comma
op_amp
id|xb
)paren
op_eq
l_int|0
)paren
(brace
id|res
op_increment
suffix:semicolon
id|j
op_decrement
suffix:semicolon
)brace
r_return
(paren
id|i
op_star
l_int|32
op_plus
id|res
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/*&n;&t; *&t;we should *never* get to this point since that &n;&t; *&t;would mean the addrs are equal&n;&t; */
r_return
op_minus
l_int|1
suffix:semicolon
)brace
DECL|function|node_alloc
r_static
id|__inline__
r_struct
id|fib6_node
op_star
id|node_alloc
c_func
(paren
r_void
)paren
(brace
r_struct
id|fib6_node
op_star
id|fn
suffix:semicolon
r_if
c_cond
(paren
(paren
id|fn
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|fib6_node
)paren
comma
id|GFP_ATOMIC
)paren
)paren
)paren
(brace
id|memset
c_func
(paren
id|fn
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|fib6_node
)paren
)paren
suffix:semicolon
id|rt6_stats.fib_nodes
op_increment
suffix:semicolon
)brace
r_return
id|fn
suffix:semicolon
)brace
DECL|function|node_free
r_static
id|__inline__
r_void
id|node_free
c_func
(paren
r_struct
id|fib6_node
op_star
id|fn
)paren
(brace
id|rt6_stats.fib_nodes
op_decrement
suffix:semicolon
id|kfree
c_func
(paren
id|fn
)paren
suffix:semicolon
)brace
DECL|function|rt6_release
r_extern
id|__inline__
r_void
id|rt6_release
c_func
(paren
r_struct
id|rt6_info
op_star
id|rt
)paren
(brace
r_struct
id|dst_entry
op_star
id|dst
op_assign
(paren
r_struct
id|dst_entry
op_star
)paren
id|rt
suffix:semicolon
r_if
c_cond
(paren
id|atomic_dec_and_test
c_func
(paren
op_amp
id|dst-&gt;refcnt
)paren
)paren
(brace
id|rt-&gt;rt6i_node
op_assign
l_int|NULL
suffix:semicolon
id|dst_free
c_func
(paren
id|dst
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/*&n; *&t;Routing Table&n; *&n; *&t;return the apropriate node for a routing tree &quot;add&quot; operation&n; *&t;by either creating and inserting or by returning an existing&n; *&t;node.&n; */
DECL|function|fib6_add_1
r_static
r_struct
id|fib6_node
op_star
id|fib6_add_1
c_func
(paren
r_struct
id|fib6_node
op_star
id|root
comma
r_void
op_star
id|addr
comma
r_int
id|addrlen
comma
r_int
id|plen
comma
r_int
r_int
id|offset
comma
r_struct
id|rt6_info
op_star
id|rt
)paren
(brace
r_struct
id|fib6_node
op_star
id|fn
suffix:semicolon
r_struct
id|fib6_node
op_star
id|pn
op_assign
l_int|NULL
suffix:semicolon
r_struct
id|fib6_node
op_star
id|in
suffix:semicolon
r_struct
id|fib6_node
op_star
id|ln
suffix:semicolon
r_struct
id|rt6key
op_star
id|key
suffix:semicolon
id|__u32
id|bit
suffix:semicolon
id|__u32
id|dir
op_assign
l_int|0
suffix:semicolon
id|__u32
id|sernum
op_assign
op_increment
id|rt_sernum
suffix:semicolon
multiline_comment|/* insert node in tree */
id|fn
op_assign
id|root
suffix:semicolon
r_if
c_cond
(paren
id|plen
op_eq
l_int|0
)paren
r_return
id|fn
suffix:semicolon
r_for
c_loop
(paren
suffix:semicolon
suffix:semicolon
)paren
(brace
r_if
c_cond
(paren
id|fn
op_eq
l_int|NULL
)paren
(brace
id|ln
op_assign
id|node_alloc
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ln
op_eq
l_int|NULL
)paren
r_return
l_int|NULL
suffix:semicolon
id|ln-&gt;fn_bit
op_assign
id|plen
suffix:semicolon
id|ln-&gt;parent
op_assign
id|pn
suffix:semicolon
id|ln-&gt;fn_sernum
op_assign
id|sernum
suffix:semicolon
id|rt-&gt;rt6i_node
op_assign
id|ln
suffix:semicolon
r_if
c_cond
(paren
id|dir
)paren
id|pn-&gt;right
op_assign
id|ln
suffix:semicolon
r_else
id|pn-&gt;left
op_assign
id|ln
suffix:semicolon
r_return
id|ln
suffix:semicolon
)brace
id|key
op_assign
(paren
r_struct
id|rt6key
op_star
)paren
(paren
(paren
id|u8
op_star
)paren
id|fn-&gt;leaf
op_plus
id|offset
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t; *&t;Prefix match&n;&t;&t; */
r_if
c_cond
(paren
id|addr_match
c_func
(paren
op_amp
id|key-&gt;addr
comma
id|addr
comma
id|fn-&gt;fn_bit
)paren
)paren
(brace
multiline_comment|/*&n;&t;&t;&t; *&t;Exact match ?&n;&t;&t;&t; */
r_if
c_cond
(paren
id|plen
op_eq
id|fn-&gt;fn_bit
)paren
(brace
multiline_comment|/* clean up an intermediate node */
r_if
c_cond
(paren
(paren
id|fn-&gt;fn_flags
op_amp
id|RTN_RTINFO
)paren
op_eq
l_int|0
)paren
(brace
id|rt6_release
c_func
(paren
id|fn-&gt;leaf
)paren
suffix:semicolon
id|fn-&gt;leaf
op_assign
l_int|NULL
suffix:semicolon
)brace
id|fn-&gt;fn_sernum
op_assign
id|sernum
suffix:semicolon
r_return
id|fn
suffix:semicolon
)brace
multiline_comment|/*&n;&t;&t;&t; *&t;We have more bits to go&n;&t;&t;&t; */
r_if
c_cond
(paren
id|plen
OG
id|fn-&gt;fn_bit
)paren
(brace
multiline_comment|/* Walk down on tree. */
id|fn-&gt;fn_sernum
op_assign
id|sernum
suffix:semicolon
id|dir
op_assign
id|addr_bit_set
c_func
(paren
id|addr
comma
id|fn-&gt;fn_bit
)paren
suffix:semicolon
id|pn
op_assign
id|fn
suffix:semicolon
id|fn
op_assign
id|dir
ques
c_cond
id|fn-&gt;right
suffix:colon
id|fn-&gt;left
suffix:semicolon
multiline_comment|/*&n;&t;&t;&t;&t; *&t;Round we go. Note if fn has become&n;&t;&t;&t;&t; *&t;NULL then dir is set and fn is handled&n;&t;&t;&t;&t; *&t;top of loop.&n;&t;&t;&t;&t; */
r_continue
suffix:semicolon
)brace
)brace
multiline_comment|/*&n;&t;&t; * split since we don&squot;t have a common prefix anymore or &n;&t;&t; * we have a less significant route.&n;&t;&t; * we&squot;ve to insert an intermediate node on the list&n;&t;&t; * this new node will point to the one we need to create&n;&t;&t; * and the current&n;&t;&t; */
id|pn
op_assign
id|fn-&gt;parent
suffix:semicolon
multiline_comment|/* find 1st bit in difference between the 2 addrs */
id|bit
op_assign
id|addr_diff
c_func
(paren
id|addr
comma
op_amp
id|key-&gt;addr
comma
id|addrlen
)paren
suffix:semicolon
multiline_comment|/* &n;&t;&t; *&t;&t;(intermediate)&t;&n;&t;&t; *&t;          /&t;   &bslash;&n;&t;&t; *&t;(new leaf node)    (old node)&n;&t;&t; */
r_if
c_cond
(paren
id|plen
OG
id|bit
)paren
(brace
id|in
op_assign
id|node_alloc
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|in
op_eq
l_int|NULL
)paren
r_return
l_int|NULL
suffix:semicolon
multiline_comment|/* &n;&t;&t;&t; * new intermediate node. &n;&t;&t;&t; * RTN_RTINFO will&n;&t;&t;&t; * be off since that an address that chooses one of&n;&t;&t;&t; * the branches would not match less specific routes&n;&t;&t;&t; * int the other branch&n;&t;&t;&t; */
id|in-&gt;fn_bit
op_assign
id|bit
suffix:semicolon
id|in-&gt;parent
op_assign
id|pn
suffix:semicolon
id|in-&gt;leaf
op_assign
id|rt
suffix:semicolon
id|in-&gt;fn_sernum
op_assign
id|sernum
suffix:semicolon
id|atomic_inc
c_func
(paren
op_amp
id|rt-&gt;rt6i_ref
)paren
suffix:semicolon
multiline_comment|/* leaf node */
id|ln
op_assign
id|node_alloc
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ln
op_eq
l_int|NULL
)paren
(brace
id|node_free
c_func
(paren
id|in
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
multiline_comment|/* update parent pointer */
r_if
c_cond
(paren
id|dir
)paren
id|pn-&gt;right
op_assign
id|in
suffix:semicolon
r_else
id|pn-&gt;left
op_assign
id|in
suffix:semicolon
id|ln-&gt;fn_bit
op_assign
id|plen
suffix:semicolon
id|ln-&gt;parent
op_assign
id|in
suffix:semicolon
id|fn-&gt;parent
op_assign
id|in
suffix:semicolon
id|ln-&gt;fn_sernum
op_assign
id|sernum
suffix:semicolon
r_if
c_cond
(paren
id|addr_bit_set
c_func
(paren
id|addr
comma
id|bit
)paren
)paren
(brace
id|in-&gt;right
op_assign
id|ln
suffix:semicolon
id|in-&gt;left
op_assign
id|fn
suffix:semicolon
)brace
r_else
(brace
id|in-&gt;left
op_assign
id|ln
suffix:semicolon
id|in-&gt;right
op_assign
id|fn
suffix:semicolon
)brace
r_return
id|ln
suffix:semicolon
)brace
multiline_comment|/* &n;&t;&t; *&t;&t;(new leaf node)&n;&t;&t; *&t;          /&t;   &bslash;&n;&t;&t; *&t;     (old node)    NULL&n;&t;&t; */
id|ln
op_assign
id|node_alloc
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ln
op_eq
l_int|NULL
)paren
r_return
l_int|NULL
suffix:semicolon
id|ln-&gt;fn_bit
op_assign
id|plen
suffix:semicolon
id|ln-&gt;parent
op_assign
id|pn
suffix:semicolon
id|ln-&gt;fn_sernum
op_assign
id|sernum
suffix:semicolon
r_if
c_cond
(paren
id|dir
)paren
id|pn-&gt;right
op_assign
id|ln
suffix:semicolon
r_else
id|pn-&gt;left
op_assign
id|ln
suffix:semicolon
r_if
c_cond
(paren
id|addr_bit_set
c_func
(paren
op_amp
id|key-&gt;addr
comma
id|plen
)paren
)paren
id|ln-&gt;right
op_assign
id|fn
suffix:semicolon
r_else
id|ln-&gt;left
op_assign
id|fn
suffix:semicolon
id|fn-&gt;parent
op_assign
id|ln
suffix:semicolon
r_return
id|ln
suffix:semicolon
)brace
r_return
l_int|NULL
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;Insert routing information in a node.&n; */
DECL|function|fib6_add_rt2node
r_static
r_int
id|fib6_add_rt2node
c_func
(paren
r_struct
id|fib6_node
op_star
id|fn
comma
r_struct
id|rt6_info
op_star
id|rt
)paren
(brace
r_struct
id|rt6_info
op_star
id|iter
op_assign
l_int|NULL
suffix:semicolon
r_struct
id|rt6_info
op_star
op_star
id|ins
suffix:semicolon
id|rt-&gt;rt6i_node
op_assign
id|fn
suffix:semicolon
id|ins
op_assign
op_amp
id|fn-&gt;leaf
suffix:semicolon
r_for
c_loop
(paren
id|iter
op_assign
id|fn-&gt;leaf
suffix:semicolon
id|iter
suffix:semicolon
id|iter
op_assign
id|iter-&gt;u.next
)paren
(brace
multiline_comment|/*&n;&t;&t; *&t;Search for duplicates&n;&t;&t; */
r_if
c_cond
(paren
id|iter-&gt;rt6i_metric
op_eq
id|rt-&gt;rt6i_metric
)paren
(brace
multiline_comment|/*&n;&t;&t;&t; *&t;Same priority level&n;&t;&t;&t; */
r_if
c_cond
(paren
(paren
id|iter-&gt;rt6i_dev
op_eq
id|rt-&gt;rt6i_dev
)paren
op_logical_and
(paren
id|iter-&gt;rt6i_flowr
op_eq
id|rt-&gt;rt6i_flowr
)paren
op_logical_and
(paren
id|ipv6_addr_cmp
c_func
(paren
op_amp
id|iter-&gt;rt6i_gateway
comma
op_amp
id|rt-&gt;rt6i_gateway
)paren
op_eq
l_int|0
)paren
)paren
(brace
r_if
c_cond
(paren
id|rt-&gt;rt6i_expires
op_eq
l_int|0
op_logical_or
(paren
r_int
)paren
(paren
id|rt-&gt;rt6i_expires
op_minus
id|iter-&gt;rt6i_expires
)paren
OG
l_int|0
)paren
id|rt-&gt;rt6i_expires
op_assign
id|iter-&gt;rt6i_expires
suffix:semicolon
r_return
op_minus
id|EEXIST
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|iter-&gt;rt6i_metric
OG
id|rt-&gt;rt6i_metric
)paren
r_break
suffix:semicolon
id|ins
op_assign
op_amp
id|iter-&gt;u.next
suffix:semicolon
)brace
multiline_comment|/*&n;&t; *&t;insert node&n;&t; */
op_star
id|ins
op_assign
id|rt
suffix:semicolon
id|rt-&gt;u.next
op_assign
id|iter
suffix:semicolon
id|atomic_inc
c_func
(paren
op_amp
id|rt-&gt;rt6i_ref
)paren
suffix:semicolon
macro_line|#ifdef CONFIG_RTNETLINK
id|inet6_rt_notify
c_func
(paren
id|RTM_NEWROUTE
comma
id|rt
)paren
suffix:semicolon
macro_line|#endif
id|rt6_stats.fib_rt_entries
op_increment
suffix:semicolon
r_if
c_cond
(paren
(paren
id|fn-&gt;fn_flags
op_amp
id|RTN_RTINFO
)paren
op_eq
l_int|0
)paren
(brace
id|rt6_stats.fib_route_nodes
op_increment
suffix:semicolon
id|fn-&gt;fn_flags
op_or_assign
id|RTN_RTINFO
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|fib6_start_gc
r_static
id|__inline__
r_void
id|fib6_start_gc
c_func
(paren
r_struct
id|rt6_info
op_star
id|rt
)paren
(brace
r_if
c_cond
(paren
(paren
id|ip6_fib_timer.expires
op_eq
l_int|0
)paren
op_logical_and
(paren
id|rt-&gt;rt6i_flags
op_amp
(paren
id|RTF_ADDRCONF
op_or
id|RTF_CACHE
)paren
)paren
)paren
(brace
id|del_timer
c_func
(paren
op_amp
id|ip6_fib_timer
)paren
suffix:semicolon
id|ip6_fib_timer.expires
op_assign
id|jiffies
op_plus
id|ip6_rt_gc_interval
suffix:semicolon
id|add_timer
c_func
(paren
op_amp
id|ip6_fib_timer
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/*&n; *&t;Add routing information to the routing tree.&n; *&t;&lt;destination addr&gt;/&lt;source addr&gt;&n; *&t;with source addr info in sub-trees&n; */
DECL|function|fib6_add
r_int
id|fib6_add
c_func
(paren
r_struct
id|fib6_node
op_star
id|root
comma
r_struct
id|rt6_info
op_star
id|rt
)paren
(brace
r_struct
id|fib6_node
op_star
id|fn
suffix:semicolon
r_int
id|err
op_assign
op_minus
id|ENOMEM
suffix:semicolon
r_int
r_int
id|offset
suffix:semicolon
id|offset
op_assign
(paren
id|u8
op_star
)paren
op_amp
id|rt-&gt;rt6i_dst
op_minus
(paren
id|u8
op_star
)paren
id|rt
suffix:semicolon
id|fn
op_assign
id|fib6_add_1
c_func
(paren
id|root
comma
op_amp
id|rt-&gt;rt6i_dst.addr
comma
r_sizeof
(paren
r_struct
id|in6_addr
)paren
comma
id|rt-&gt;rt6i_dst.plen
comma
id|offset
comma
id|rt
)paren
suffix:semicolon
r_if
c_cond
(paren
id|fn
op_eq
l_int|NULL
)paren
(brace
macro_line|#if RT_DEBUG &gt;= 2
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;fib6_add: fn == NULL&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
r_goto
id|out
suffix:semicolon
)brace
r_if
c_cond
(paren
id|rt-&gt;rt6i_src.plen
)paren
(brace
r_struct
id|fib6_node
op_star
id|sn
suffix:semicolon
macro_line|#if RT_DEBUG &gt;= 2
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;fib6_add: src.len &gt; 0&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|fn-&gt;subtree
op_eq
l_int|NULL
)paren
(brace
r_struct
id|fib6_node
op_star
id|sfn
suffix:semicolon
r_if
c_cond
(paren
id|fn-&gt;leaf
op_eq
l_int|NULL
)paren
(brace
id|fn-&gt;leaf
op_assign
id|rt
suffix:semicolon
id|atomic_inc
c_func
(paren
op_amp
id|rt-&gt;rt6i_ref
)paren
suffix:semicolon
)brace
id|sfn
op_assign
id|node_alloc
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sfn
op_eq
l_int|NULL
)paren
r_goto
id|out
suffix:semicolon
id|sfn-&gt;parent
op_assign
id|fn
suffix:semicolon
id|sfn-&gt;leaf
op_assign
op_amp
id|ip6_null_entry
suffix:semicolon
id|sfn-&gt;fn_flags
op_assign
id|RTN_ROOT
suffix:semicolon
id|sfn-&gt;fn_sernum
op_assign
op_increment
id|rt_sernum
suffix:semicolon
id|fn-&gt;subtree
op_assign
id|sfn
suffix:semicolon
)brace
id|offset
op_assign
(paren
id|u8
op_star
)paren
op_amp
id|rt-&gt;rt6i_src
op_minus
(paren
id|u8
op_star
)paren
id|rt
suffix:semicolon
id|sn
op_assign
id|fib6_add_1
c_func
(paren
id|fn-&gt;subtree
comma
op_amp
id|rt-&gt;rt6i_src.addr
comma
r_sizeof
(paren
r_struct
id|in6_addr
)paren
comma
id|rt-&gt;rt6i_src.plen
comma
id|offset
comma
id|rt
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sn
op_eq
l_int|NULL
)paren
r_goto
id|out
suffix:semicolon
id|fn
op_assign
id|sn
suffix:semicolon
)brace
id|err
op_assign
id|fib6_add_rt2node
c_func
(paren
id|fn
comma
id|rt
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
op_eq
l_int|0
)paren
id|fib6_start_gc
c_func
(paren
id|rt
)paren
suffix:semicolon
id|out
suffix:colon
r_if
c_cond
(paren
id|err
)paren
id|dst_free
c_func
(paren
op_amp
id|rt-&gt;u.dst
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;Routing tree lookup&n; *&n; */
DECL|struct|lookup_args
r_struct
id|lookup_args
(brace
DECL|member|offset
r_int
r_int
id|offset
suffix:semicolon
multiline_comment|/* key offset on rt6_info&t;*/
DECL|member|addr
r_struct
id|in6_addr
op_star
id|addr
suffix:semicolon
multiline_comment|/* search key&t;&t;&t;*/
)brace
suffix:semicolon
DECL|function|fib6_lookup_1
r_static
r_struct
id|fib6_node
op_star
id|fib6_lookup_1
c_func
(paren
r_struct
id|fib6_node
op_star
id|root
comma
r_struct
id|lookup_args
op_star
id|args
)paren
(brace
r_struct
id|fib6_node
op_star
id|fn
suffix:semicolon
r_int
id|dir
suffix:semicolon
multiline_comment|/*&n;&t; *&t;Descend on a tree&n;&t; */
id|fn
op_assign
id|root
suffix:semicolon
r_for
c_loop
(paren
suffix:semicolon
suffix:semicolon
)paren
(brace
r_struct
id|fib6_node
op_star
id|next
suffix:semicolon
id|dir
op_assign
id|addr_bit_set
c_func
(paren
id|args-&gt;addr
comma
id|fn-&gt;fn_bit
)paren
suffix:semicolon
id|next
op_assign
id|dir
ques
c_cond
id|fn-&gt;right
suffix:colon
id|fn-&gt;left
suffix:semicolon
r_if
c_cond
(paren
id|next
)paren
(brace
id|fn
op_assign
id|next
suffix:semicolon
r_continue
suffix:semicolon
)brace
r_break
suffix:semicolon
)brace
r_while
c_loop
(paren
(paren
id|fn-&gt;fn_flags
op_amp
id|RTN_ROOT
)paren
op_eq
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|fn-&gt;subtree
)paren
(brace
r_struct
id|fib6_node
op_star
id|st
suffix:semicolon
r_struct
id|lookup_args
op_star
id|narg
suffix:semicolon
id|narg
op_assign
id|args
op_plus
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|narg-&gt;addr
)paren
(brace
id|st
op_assign
id|fib6_lookup_1
c_func
(paren
id|fn-&gt;subtree
comma
id|narg
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|st-&gt;fn_flags
op_amp
id|RTN_ROOT
)paren
)paren
(brace
r_return
id|st
suffix:semicolon
)brace
)brace
)brace
r_if
c_cond
(paren
id|fn-&gt;fn_flags
op_amp
id|RTN_RTINFO
)paren
(brace
r_struct
id|rt6key
op_star
id|key
suffix:semicolon
id|key
op_assign
(paren
r_struct
id|rt6key
op_star
)paren
(paren
(paren
id|u8
op_star
)paren
id|fn-&gt;leaf
op_plus
id|args-&gt;offset
)paren
suffix:semicolon
r_if
c_cond
(paren
id|addr_match
c_func
(paren
op_amp
id|key-&gt;addr
comma
id|args-&gt;addr
comma
id|key-&gt;plen
)paren
)paren
r_return
id|fn
suffix:semicolon
)brace
id|fn
op_assign
id|fn-&gt;parent
suffix:semicolon
)brace
r_return
l_int|NULL
suffix:semicolon
)brace
DECL|function|fib6_lookup
r_struct
id|fib6_node
op_star
id|fib6_lookup
c_func
(paren
r_struct
id|fib6_node
op_star
id|root
comma
r_struct
id|in6_addr
op_star
id|daddr
comma
r_struct
id|in6_addr
op_star
id|saddr
)paren
(brace
r_struct
id|lookup_args
id|args
(braket
l_int|2
)braket
suffix:semicolon
r_struct
id|rt6_info
op_star
id|rt
op_assign
l_int|NULL
suffix:semicolon
r_struct
id|fib6_node
op_star
id|fn
suffix:semicolon
id|args
(braket
l_int|0
)braket
dot
id|offset
op_assign
(paren
id|u8
op_star
)paren
op_amp
id|rt-&gt;rt6i_dst
op_minus
(paren
id|u8
op_star
)paren
id|rt
suffix:semicolon
id|args
(braket
l_int|0
)braket
dot
id|addr
op_assign
id|daddr
suffix:semicolon
id|args
(braket
l_int|1
)braket
dot
id|offset
op_assign
(paren
id|u8
op_star
)paren
op_amp
id|rt-&gt;rt6i_src
op_minus
(paren
id|u8
op_star
)paren
id|rt
suffix:semicolon
id|args
(braket
l_int|1
)braket
dot
id|addr
op_assign
id|saddr
suffix:semicolon
id|fn
op_assign
id|fib6_lookup_1
c_func
(paren
id|root
comma
id|args
)paren
suffix:semicolon
r_if
c_cond
(paren
id|fn
op_eq
l_int|NULL
)paren
id|fn
op_assign
id|root
suffix:semicolon
r_return
id|fn
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;Deletion&n; *&n; */
DECL|function|fib6_find_prefix
r_static
r_struct
id|rt6_info
op_star
id|fib6_find_prefix
c_func
(paren
r_struct
id|fib6_node
op_star
id|fn
)paren
(brace
r_while
c_loop
(paren
id|fn
)paren
(brace
r_if
c_cond
(paren
id|fn-&gt;left
)paren
(brace
r_return
id|fn-&gt;left-&gt;leaf
suffix:semicolon
)brace
r_if
c_cond
(paren
id|fn-&gt;right
)paren
(brace
r_return
id|fn-&gt;right-&gt;leaf
suffix:semicolon
)brace
id|fn
op_assign
id|fn-&gt;subtree
suffix:semicolon
)brace
r_return
l_int|NULL
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;Called to trim the tree of intermediate nodes when possible. &quot;fn&quot;&n; *&t;is the node we want to try and remove.&n; */
DECL|function|fib6_del_2
r_static
r_void
id|fib6_del_2
c_func
(paren
r_struct
id|fib6_node
op_star
id|fn
)paren
(brace
r_struct
id|rt6_info
op_star
id|rt
suffix:semicolon
id|fn-&gt;fn_flags
op_and_assign
op_complement
id|RTN_RTINFO
suffix:semicolon
id|rt6_stats.fib_route_nodes
op_decrement
suffix:semicolon
multiline_comment|/*&n;&t; *&t;Can&squot;t delete a root node&n;&t; */
r_if
c_cond
(paren
id|fn-&gt;fn_flags
op_amp
id|RTN_TL_ROOT
)paren
r_return
suffix:semicolon
r_do
(brace
r_struct
id|fib6_node
op_star
id|pn
comma
op_star
id|child
suffix:semicolon
r_int
id|children
op_assign
l_int|0
suffix:semicolon
id|child
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/*&n;&t;&t; *&t;We have a child to left&n;&t;&t; */
r_if
c_cond
(paren
id|fn-&gt;left
)paren
(brace
id|children
op_increment
suffix:semicolon
id|child
op_assign
id|fn-&gt;left
suffix:semicolon
)brace
multiline_comment|/*&n;&t;&t; *&t;To right&n;&t;&t; */
r_if
c_cond
(paren
id|fn-&gt;right
)paren
(brace
id|children
op_increment
suffix:semicolon
id|child
op_assign
id|fn-&gt;right
suffix:semicolon
)brace
multiline_comment|/*&n;&t;&t; *&t;We can&squot;t tidy a case of two children.&n;&t;&t; */
r_if
c_cond
(paren
id|children
OG
l_int|1
op_logical_or
(paren
id|fn-&gt;fn_flags
op_amp
id|RTN_RTINFO
)paren
)paren
r_break
suffix:semicolon
multiline_comment|/*&n;&t;&t; *&t;The node we plan to tidy has an stree. Talk about&n;&t;&t; *&t;making life hard.&n;&t;&t; */
r_if
c_cond
(paren
id|fn-&gt;subtree
)paren
r_goto
id|stree_node
suffix:semicolon
multiline_comment|/*&n;&t;&t; *&t;Up we go&n;&t;&t; */
id|pn
op_assign
id|fn-&gt;parent
suffix:semicolon
multiline_comment|/*&n;&t;&t; *&t;Not a ROOT - we can tidy&n;&t;&t; */
r_if
c_cond
(paren
(paren
id|fn-&gt;fn_flags
op_amp
id|RTN_ROOT
)paren
op_eq
l_int|0
)paren
(brace
multiline_comment|/*&n;&t;&t;&t; *&t;Make our child our parents child&n;&t;&t;&t; */
r_if
c_cond
(paren
id|pn-&gt;left
op_eq
id|fn
)paren
id|pn-&gt;left
op_assign
id|child
suffix:semicolon
r_else
id|pn-&gt;right
op_assign
id|child
suffix:semicolon
multiline_comment|/*&n;&t;&t;&t; *&t;Reparent the child&n;&t;&t;&t; */
r_if
c_cond
(paren
id|child
)paren
id|child-&gt;parent
op_assign
id|pn
suffix:semicolon
multiline_comment|/*&n;&t;&t;&t; *&t;Discard leaf entries&n;&t;&t;&t; */
r_if
c_cond
(paren
id|fn-&gt;leaf
)paren
id|rt6_release
c_func
(paren
id|fn-&gt;leaf
)paren
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|children
)paren
r_break
suffix:semicolon
multiline_comment|/*&n;&t;&t;&t; *&t;No children so no subtree&n;&t;&t;&t; */
id|pn-&gt;subtree
op_assign
l_int|NULL
suffix:semicolon
)brace
multiline_comment|/*&n;&t;&t; *&t;We are discarding &n;&t;&t; */
id|node_free
c_func
(paren
id|fn
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t; *&t;Our merge of entries might propogate further&n;&t;&t; *&t;up the tree, so move up a level and retry.&n;&t;&t; */
id|fn
op_assign
id|pn
suffix:semicolon
)brace
r_while
c_loop
(paren
op_logical_neg
(paren
id|fn-&gt;fn_flags
op_amp
id|RTN_TL_ROOT
)paren
)paren
suffix:semicolon
r_return
suffix:semicolon
id|stree_node
suffix:colon
id|rt6_release
c_func
(paren
id|fn-&gt;leaf
)paren
suffix:semicolon
id|rt
op_assign
id|fib6_find_prefix
c_func
(paren
id|fn
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rt
op_eq
l_int|NULL
)paren
id|panic
c_func
(paren
l_string|&quot;fib6_del_2: inconsistent tree&bslash;n&quot;
)paren
suffix:semicolon
id|atomic_inc
c_func
(paren
op_amp
id|rt-&gt;rt6i_ref
)paren
suffix:semicolon
id|fn-&gt;leaf
op_assign
id|rt
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;Remove our entry in the tree. This throws away the route entry&n; *&t;from the list of entries attached to this fib node. It doesn&squot;t&n; *&t;expunge from the tree.&n; */
DECL|function|fib6_del_1
r_static
r_struct
id|fib6_node
op_star
id|fib6_del_1
c_func
(paren
r_struct
id|rt6_info
op_star
id|rt
)paren
(brace
r_struct
id|fib6_node
op_star
id|fn
suffix:semicolon
id|fn
op_assign
id|rt-&gt;rt6i_node
suffix:semicolon
multiline_comment|/* We need a fib node! */
r_if
c_cond
(paren
id|fn
)paren
(brace
r_struct
id|rt6_info
op_star
op_star
id|back
suffix:semicolon
r_struct
id|rt6_info
op_star
id|lf
suffix:semicolon
id|back
op_assign
op_amp
id|fn-&gt;leaf
suffix:semicolon
multiline_comment|/*&n;&t;&t; *&t;Walk the leaf entries looking for ourself&n;&t;&t; */
r_for
c_loop
(paren
id|lf
op_assign
id|fn-&gt;leaf
suffix:semicolon
id|lf
suffix:semicolon
id|lf
op_assign
id|lf-&gt;u.next
)paren
(brace
r_if
c_cond
(paren
id|rt
op_eq
id|lf
)paren
(brace
multiline_comment|/*&n;&t;&t;&t;&t; *&t;Delete this entry.&n;&t;&t;&t;&t; */
op_star
id|back
op_assign
id|lf-&gt;u.next
suffix:semicolon
macro_line|#ifdef CONFIG_RTNETLINK
id|inet6_rt_notify
c_func
(paren
id|RTM_DELROUTE
comma
id|lf
)paren
suffix:semicolon
macro_line|#endif&t;&t;&t;
id|rt6_release
c_func
(paren
id|lf
)paren
suffix:semicolon
id|rt6_stats.fib_rt_entries
op_decrement
suffix:semicolon
r_return
id|fn
suffix:semicolon
)brace
id|back
op_assign
op_amp
id|lf-&gt;u.next
suffix:semicolon
)brace
)brace
r_return
l_int|NULL
suffix:semicolon
)brace
DECL|function|fib6_del
r_int
id|fib6_del
c_func
(paren
r_struct
id|rt6_info
op_star
id|rt
)paren
(brace
r_struct
id|fib6_node
op_star
id|fn
suffix:semicolon
id|fn
op_assign
id|fib6_del_1
c_func
(paren
id|rt
)paren
suffix:semicolon
r_if
c_cond
(paren
id|fn
op_eq
l_int|NULL
)paren
r_return
op_minus
id|ENOENT
suffix:semicolon
r_if
c_cond
(paren
id|fn-&gt;leaf
op_eq
l_int|NULL
)paren
id|fib6_del_2
c_func
(paren
id|fn
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;Tree transversal function&n; *&n; *&t;Wau... It is NOT REENTERABLE!!!!!!! It is cathastrophe. --ANK&n; */
DECL|variable|fib6_walk_count
r_int
id|fib6_walk_count
suffix:semicolon
DECL|function|fib6_walk_tree
r_void
id|fib6_walk_tree
c_func
(paren
r_struct
id|fib6_node
op_star
id|root
comma
id|f_pnode
id|func
comma
r_void
op_star
id|arg
comma
r_int
id|filter
)paren
(brace
r_struct
id|fib6_node
op_star
id|fn
suffix:semicolon
id|fn
op_assign
id|root
suffix:semicolon
id|fib6_walk_count
op_increment
suffix:semicolon
r_do
(brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|fn-&gt;fn_flags
op_amp
id|RTN_TAG
)paren
)paren
(brace
id|fn-&gt;fn_flags
op_or_assign
id|RTN_TAG
suffix:semicolon
r_if
c_cond
(paren
id|fn-&gt;left
)paren
(brace
id|fn
op_assign
id|fn-&gt;left
suffix:semicolon
r_continue
suffix:semicolon
)brace
)brace
id|fn-&gt;fn_flags
op_and_assign
op_complement
id|RTN_TAG
suffix:semicolon
r_if
c_cond
(paren
id|fn-&gt;right
)paren
(brace
id|fn
op_assign
id|fn-&gt;right
suffix:semicolon
r_continue
suffix:semicolon
)brace
r_do
(brace
r_struct
id|fib6_node
op_star
id|node
suffix:semicolon
r_if
c_cond
(paren
id|fn-&gt;fn_flags
op_amp
id|RTN_ROOT
)paren
r_break
suffix:semicolon
id|node
op_assign
id|fn
suffix:semicolon
id|fn
op_assign
id|fn-&gt;parent
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|node-&gt;fn_flags
op_amp
id|RTN_TAG
)paren
)paren
(brace
r_if
c_cond
(paren
id|node-&gt;subtree
)paren
(brace
id|fib6_walk_tree
c_func
(paren
id|node-&gt;subtree
comma
id|func
comma
id|arg
comma
id|filter
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|filter
op_logical_or
(paren
id|node-&gt;fn_flags
op_amp
id|RTN_RTINFO
)paren
)paren
(paren
op_star
id|func
)paren
(paren
id|node
comma
id|arg
)paren
suffix:semicolon
)brace
)brace
r_while
c_loop
(paren
op_logical_neg
(paren
id|fn-&gt;fn_flags
op_amp
id|RTN_TAG
)paren
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
op_logical_neg
(paren
id|fn-&gt;fn_flags
op_amp
id|RTN_ROOT
)paren
op_logical_or
(paren
id|fn-&gt;fn_flags
op_amp
id|RTN_TAG
)paren
)paren
suffix:semicolon
id|fib6_walk_count
op_decrement
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;Garbage collection&n; */
DECL|function|fib6_gc_node
r_static
r_int
id|fib6_gc_node
c_func
(paren
r_struct
id|fib6_node
op_star
id|fn
comma
r_int
id|timeout
)paren
(brace
r_struct
id|rt6_info
op_star
id|rt
comma
op_star
op_star
id|back
suffix:semicolon
r_int
id|more
op_assign
l_int|0
suffix:semicolon
r_int
r_int
id|now
op_assign
id|jiffies
suffix:semicolon
id|back
op_assign
op_amp
id|fn-&gt;leaf
suffix:semicolon
r_for
c_loop
(paren
id|rt
op_assign
id|fn-&gt;leaf
suffix:semicolon
id|rt
suffix:semicolon
)paren
(brace
r_if
c_cond
(paren
(paren
id|rt-&gt;rt6i_flags
op_amp
id|RTF_CACHE
)paren
op_logical_and
id|atomic_read
c_func
(paren
op_amp
id|rt-&gt;rt6i_use
)paren
op_eq
l_int|0
)paren
(brace
r_if
c_cond
(paren
(paren
r_int
)paren
(paren
id|now
op_minus
id|rt-&gt;rt6i_tstamp
)paren
op_ge
id|timeout
)paren
(brace
r_struct
id|rt6_info
op_star
id|old
suffix:semicolon
id|old
op_assign
id|rt
suffix:semicolon
id|rt
op_assign
id|rt-&gt;u.next
suffix:semicolon
op_star
id|back
op_assign
id|rt
suffix:semicolon
id|old-&gt;rt6i_node
op_assign
l_int|NULL
suffix:semicolon
macro_line|#ifdef CONFIG_RTNETLINK
id|inet6_rt_notify
c_func
(paren
id|RTM_DELROUTE
comma
id|old
)paren
suffix:semicolon
macro_line|#endif
id|old-&gt;u.dst.obsolete
op_assign
l_int|1
suffix:semicolon
id|rt6_release
c_func
(paren
id|old
)paren
suffix:semicolon
id|rt6_stats.fib_rt_entries
op_decrement
suffix:semicolon
r_continue
suffix:semicolon
)brace
id|more
op_increment
suffix:semicolon
)brace
multiline_comment|/*&n;&t;&t; *&t;check addrconf expiration here.&n;&t;&t; *&n;&t;&t; *&t;BUGGGG Crossing fingers and ...&n;&t;&t; *&t;Seems, radix tree walking is absolutely broken,&n;&t;&t; *&t;but we will try in any case --ANK&n;&t;&t; */
r_if
c_cond
(paren
id|rt-&gt;rt6i_expires
op_logical_and
(paren
r_int
)paren
(paren
id|now
op_minus
id|rt-&gt;rt6i_expires
)paren
OL
l_int|0
)paren
(brace
r_struct
id|rt6_info
op_star
id|old
suffix:semicolon
id|old
op_assign
id|rt
suffix:semicolon
id|rt
op_assign
id|rt-&gt;u.next
suffix:semicolon
op_star
id|back
op_assign
id|rt
suffix:semicolon
id|old-&gt;rt6i_node
op_assign
l_int|NULL
suffix:semicolon
macro_line|#ifdef CONFIG_RTNETLINK
id|inet6_rt_notify
c_func
(paren
id|RTM_DELROUTE
comma
id|old
)paren
suffix:semicolon
macro_line|#endif
id|old-&gt;u.dst.obsolete
op_assign
l_int|1
suffix:semicolon
id|rt6_release
c_func
(paren
id|old
)paren
suffix:semicolon
id|rt6_stats.fib_rt_entries
op_decrement
suffix:semicolon
r_continue
suffix:semicolon
)brace
id|back
op_assign
op_amp
id|rt-&gt;u.next
suffix:semicolon
id|rt
op_assign
id|rt-&gt;u.next
suffix:semicolon
)brace
r_return
id|more
suffix:semicolon
)brace
DECL|struct|fib6_gc_args
r_struct
id|fib6_gc_args
(brace
DECL|member|timeout
r_int
r_int
id|timeout
suffix:semicolon
DECL|member|more
r_int
id|more
suffix:semicolon
)brace
suffix:semicolon
DECL|function|fib6_garbage_collect
r_static
r_void
id|fib6_garbage_collect
c_func
(paren
r_struct
id|fib6_node
op_star
id|fn
comma
r_void
op_star
id|p_arg
)paren
(brace
r_struct
id|fib6_gc_args
op_star
id|args
op_assign
(paren
r_struct
id|fib6_gc_args
op_star
)paren
id|p_arg
suffix:semicolon
r_if
c_cond
(paren
id|fn-&gt;fn_flags
op_amp
id|RTN_RTINFO
)paren
(brace
r_int
id|more
suffix:semicolon
id|more
op_assign
id|fib6_gc_node
c_func
(paren
id|fn
comma
id|args-&gt;timeout
)paren
suffix:semicolon
r_if
c_cond
(paren
id|fn-&gt;leaf
)paren
(brace
id|args-&gt;more
op_add_assign
id|more
suffix:semicolon
r_return
suffix:semicolon
)brace
id|rt6_stats.fib_route_nodes
op_decrement
suffix:semicolon
id|fn-&gt;fn_flags
op_and_assign
op_complement
id|RTN_RTINFO
suffix:semicolon
)brace
multiline_comment|/*&n;&t; *&t;tree nodes (with no routing information)&n;&t; */
r_if
c_cond
(paren
op_logical_neg
id|fn-&gt;subtree
op_logical_and
op_logical_neg
(paren
id|fn-&gt;fn_flags
op_amp
id|RTN_TL_ROOT
)paren
)paren
(brace
r_int
id|children
op_assign
l_int|0
suffix:semicolon
r_struct
id|fib6_node
op_star
id|chld
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
id|fn-&gt;left
)paren
(brace
id|children
op_increment
suffix:semicolon
id|chld
op_assign
id|fn-&gt;left
suffix:semicolon
)brace
r_if
c_cond
(paren
id|fn-&gt;right
)paren
(brace
id|children
op_increment
suffix:semicolon
id|chld
op_assign
id|fn-&gt;right
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|fn-&gt;fn_flags
op_amp
id|RTN_ROOT
)paren
)paren
(brace
r_if
c_cond
(paren
id|children
op_eq
l_int|0
)paren
(brace
r_struct
id|fib6_node
op_star
id|pn
suffix:semicolon
id|pn
op_assign
id|fn-&gt;parent
suffix:semicolon
id|pn-&gt;subtree
op_assign
l_int|NULL
suffix:semicolon
id|node_free
c_func
(paren
id|fn
)paren
suffix:semicolon
)brace
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|children
op_le
l_int|1
)paren
(brace
r_struct
id|fib6_node
op_star
id|pn
op_assign
id|fn-&gt;parent
suffix:semicolon
r_if
c_cond
(paren
id|pn-&gt;left
op_eq
id|fn
)paren
id|pn-&gt;left
op_assign
id|chld
suffix:semicolon
r_else
id|pn-&gt;right
op_assign
id|chld
suffix:semicolon
r_if
c_cond
(paren
id|chld
)paren
id|chld-&gt;parent
op_assign
id|pn
suffix:semicolon
r_if
c_cond
(paren
id|fn-&gt;leaf
)paren
id|rt6_release
c_func
(paren
id|fn-&gt;leaf
)paren
suffix:semicolon
id|node_free
c_func
(paren
id|fn
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|fn-&gt;leaf
op_eq
l_int|NULL
)paren
(brace
r_struct
id|rt6_info
op_star
id|nrt
suffix:semicolon
id|nrt
op_assign
id|fib6_find_prefix
c_func
(paren
id|fn
)paren
suffix:semicolon
r_if
c_cond
(paren
id|nrt
op_eq
l_int|NULL
)paren
id|panic
c_func
(paren
l_string|&quot;fib6: inconsistent tree&bslash;n&quot;
)paren
suffix:semicolon
id|atomic_inc
c_func
(paren
op_amp
id|nrt-&gt;rt6i_ref
)paren
suffix:semicolon
id|fn-&gt;leaf
op_assign
id|nrt
suffix:semicolon
)brace
)brace
DECL|function|fib6_run_gc
r_void
id|fib6_run_gc
c_func
(paren
r_int
r_int
id|dummy
)paren
(brace
r_struct
id|fib6_gc_args
id|arg
op_assign
(brace
id|ip6_rt_gc_timeout
comma
l_int|0
)brace
suffix:semicolon
id|del_timer
c_func
(paren
op_amp
id|ip6_fib_timer
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dummy
)paren
id|arg.timeout
op_assign
id|dummy
suffix:semicolon
r_if
c_cond
(paren
id|fib6_walk_count
op_eq
l_int|0
)paren
id|fib6_walk_tree
c_func
(paren
op_amp
id|ip6_routing_table
comma
id|fib6_garbage_collect
comma
op_amp
id|arg
comma
l_int|0
)paren
suffix:semicolon
r_else
id|arg.more
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|arg.more
)paren
(brace
id|ip6_fib_timer.expires
op_assign
id|jiffies
op_plus
id|ip6_rt_gc_interval
suffix:semicolon
id|add_timer
c_func
(paren
op_amp
id|ip6_fib_timer
)paren
suffix:semicolon
)brace
r_else
(brace
id|ip6_fib_timer.expires
op_assign
l_int|0
suffix:semicolon
)brace
)brace
eof
