multiline_comment|/*&n; *&t;Extension Header handling for IPv6&n; *&t;Linux INET6 implementation&n; *&n; *&t;Authors:&n; *&t;Pedro Roque&t;&t;&lt;roque@di.fc.ul.pt&gt;&n; *&n; *&t;$Id: exthdrs.c,v 1.4 1997/03/18 18:24:29 davem Exp $&n; *&n; *&t;This program is free software; you can redistribute it and/or&n; *      modify it under the terms of the GNU General Public License&n; *      as published by the Free Software Foundation; either version&n; *      2 of the License, or (at your option) any later version.&n; */
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/socket.h&gt;
macro_line|#include &lt;linux/sockios.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/net.h&gt;
macro_line|#include &lt;linux/netdevice.h&gt;
macro_line|#include &lt;linux/in6.h&gt;
macro_line|#include &lt;linux/icmpv6.h&gt;
macro_line|#include &lt;net/sock.h&gt;
macro_line|#include &lt;net/snmp.h&gt;
macro_line|#include &lt;net/ipv6.h&gt;
macro_line|#include &lt;net/protocol.h&gt;
macro_line|#include &lt;net/transp_v6.h&gt;
macro_line|#include &lt;net/rawv6.h&gt;
macro_line|#include &lt;net/ndisc.h&gt;
macro_line|#include &lt;net/ip6_route.h&gt;
macro_line|#include &lt;net/addrconf.h&gt;
multiline_comment|/*&n; *&t;inbound&n; */
macro_line|#if 0
r_int
id|ipv6_routing_header
c_func
(paren
r_struct
id|sk_buff
op_star
op_star
id|skb_ptr
comma
r_struct
id|device
op_star
id|dev
comma
id|__u8
op_star
id|nhptr
comma
r_struct
id|ipv6_options
op_star
id|opt
)paren
(brace
r_struct
id|sk_buff
op_star
id|skb
op_assign
op_star
id|skb_ptr
suffix:semicolon
r_struct
id|in6_addr
op_star
id|addr
suffix:semicolon
r_struct
id|in6_addr
id|daddr
suffix:semicolon
r_int
id|addr_type
op_assign
l_int|0
suffix:semicolon
r_int
id|strict
op_assign
l_int|0
suffix:semicolon
id|__u32
id|bit_map
suffix:semicolon
r_int
id|pos
suffix:semicolon
r_int
id|n
comma
id|i
suffix:semicolon
r_struct
id|ipv6_rt_hdr
op_star
id|hdr
op_assign
(paren
r_struct
id|ipv6_rt_hdr
op_star
)paren
id|skb-&gt;h.raw
suffix:semicolon
r_struct
id|rt0_hdr
op_star
id|rthdr
suffix:semicolon
r_if
c_cond
(paren
id|hdr-&gt;segments_left
op_eq
l_int|0
)paren
(brace
r_struct
id|ipv6_options
op_star
id|opt
suffix:semicolon
id|opt
op_assign
(paren
r_struct
id|ipv6_options
op_star
)paren
id|skb-&gt;cb
suffix:semicolon
id|opt-&gt;srcrt
op_assign
id|hdr
suffix:semicolon
id|skb-&gt;h.raw
op_add_assign
(paren
id|hdr-&gt;hdrlen
op_plus
l_int|1
)paren
op_lshift
l_int|3
suffix:semicolon
r_return
id|hdr-&gt;nexthdr
suffix:semicolon
)brace
r_if
c_cond
(paren
id|hdr-&gt;type
op_ne
id|IPV6_SRCRT_TYPE_0
op_logical_or
id|hdr-&gt;hdrlen
op_amp
l_int|0x01
op_logical_or
id|hdr-&gt;hdrlen
OG
l_int|46
)paren
(brace
multiline_comment|/* &n;&t;&t; *&t;Discard &n;&t;&t; */
id|pos
op_assign
(paren
id|__u8
op_star
)paren
id|hdr
op_minus
(paren
id|__u8
op_star
)paren
id|skb-&gt;nh.ipv6h
op_plus
l_int|2
suffix:semicolon
r_if
c_cond
(paren
id|hdr-&gt;type
)paren
id|pos
op_add_assign
l_int|2
suffix:semicolon
r_else
id|pos
op_add_assign
l_int|1
suffix:semicolon
id|icmpv6_send
c_func
(paren
id|skb
comma
id|ICMPV6_PARAMETER_PROB
comma
l_int|0
comma
id|pos
comma
id|dev
)paren
suffix:semicolon
id|kfree_skb
c_func
(paren
id|skb
comma
id|FREE_READ
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n;&t; *&t;This is the routing header forwarding algorithm from&n;&t; *&t;RFC 1883, page 17.&n;&t; */
id|n
op_assign
id|hdr-&gt;hdrlen
op_rshift
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|hdr-&gt;segments_left
OG
id|n
)paren
(brace
id|pos
op_assign
(paren
id|__u8
op_star
)paren
id|hdr
op_minus
(paren
id|__u8
op_star
)paren
id|skb-&gt;nh.ipv6h
op_plus
l_int|2
suffix:semicolon
id|pos
op_add_assign
l_int|3
suffix:semicolon
id|icmpv6_send
c_func
(paren
id|skb
comma
id|ICMPV6_PARAMETER_PROB
comma
l_int|0
comma
id|pos
comma
id|dev
)paren
suffix:semicolon
id|kfree_skb
c_func
(paren
id|skb
comma
id|FREE_READ
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|i
op_assign
id|n
op_minus
op_decrement
id|hdr-&gt;segments_left
suffix:semicolon
id|rthdr
op_assign
(paren
r_struct
id|rt0_hdr
op_star
)paren
id|hdr
suffix:semicolon
id|addr
op_assign
id|rthdr-&gt;addr
suffix:semicolon
id|addr
op_add_assign
id|i
op_minus
l_int|1
suffix:semicolon
id|addr_type
op_assign
id|ipv6_addr_type
c_func
(paren
id|addr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|addr_type
op_eq
id|IPV6_ADDR_MULTICAST
)paren
(brace
id|kfree_skb
c_func
(paren
id|skb
comma
id|FREE_READ
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|ipv6_addr_copy
c_func
(paren
op_amp
id|daddr
comma
id|addr
)paren
suffix:semicolon
id|ipv6_addr_copy
c_func
(paren
id|addr
comma
op_amp
id|skb-&gt;nh.ipv6h-&gt;daddr
)paren
suffix:semicolon
id|ipv6_addr_copy
c_func
(paren
op_amp
id|skb-&gt;nh.ipv6h-&gt;daddr
comma
op_amp
id|daddr
)paren
suffix:semicolon
multiline_comment|/*&n;&t; *&t;Check Strick Source Route&n;&t; */
id|bit_map
op_assign
id|ntohl
c_func
(paren
id|rthdr-&gt;bitmap
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|bit_map
op_amp
(paren
l_int|1
op_lshift
id|i
)paren
)paren
op_eq
id|IPV6_SRCRT_STRICT
)paren
id|strict
op_assign
l_int|1
suffix:semicolon
id|ipv6_forward
c_func
(paren
id|skb
comma
id|dev
comma
(paren
id|strict
ques
c_cond
id|IP6_FW_STRICT
suffix:colon
l_int|0
)paren
op_or
id|IP6_FW_SRCRT
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;outbound&n; */
r_int
id|ipv6opt_bld_rthdr
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|ipv6_options
op_star
id|opt
comma
r_struct
id|in6_addr
op_star
id|addr
comma
r_int
id|proto
)paren
(brace
r_struct
id|rt0_hdr
op_star
id|phdr
comma
op_star
id|ihdr
suffix:semicolon
r_int
id|hops
suffix:semicolon
id|ihdr
op_assign
(paren
r_struct
id|rt0_hdr
op_star
)paren
id|opt-&gt;srcrt
suffix:semicolon
id|phdr
op_assign
(paren
r_struct
id|rt0_hdr
op_star
)paren
id|skb_put
c_func
(paren
id|skb
comma
(paren
id|ihdr-&gt;rt_hdr.hdrlen
op_plus
l_int|1
)paren
op_lshift
l_int|3
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|phdr
comma
id|ihdr
comma
r_sizeof
(paren
r_struct
id|ipv6_rt_hdr
)paren
)paren
suffix:semicolon
id|hops
op_assign
id|ihdr-&gt;rt_hdr.hdrlen
op_rshift
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|hops
OG
l_int|1
)paren
id|memcpy
c_func
(paren
id|phdr-&gt;addr
comma
id|ihdr-&gt;addr
op_plus
l_int|1
comma
(paren
id|hops
op_minus
l_int|1
)paren
op_star
r_sizeof
(paren
r_struct
id|in6_addr
)paren
)paren
suffix:semicolon
id|ipv6_addr_copy
c_func
(paren
id|phdr-&gt;addr
op_plus
(paren
id|hops
op_minus
l_int|1
)paren
comma
id|addr
)paren
suffix:semicolon
id|phdr-&gt;rt_hdr.nexthdr
op_assign
id|proto
suffix:semicolon
r_return
id|NEXTHDR_ROUTING
suffix:semicolon
)brace
macro_line|#endif
eof
