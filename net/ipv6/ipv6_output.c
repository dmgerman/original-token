multiline_comment|/*&n; *&t;IPv6 output functions&n; *&t;Linux INET6 implementation &n; *&n; *&t;Authors:&n; *&t;Pedro Roque&t;&t;&lt;roque@di.fc.ul.pt&gt;&t;&n; *&n; *&t;Based on linux/net/ipv4/ip_output.c&n; *&n; *&t;$Id: ipv6_output.c,v 1.19 1996/10/16 18:34:16 roque Exp $&n; *&n; *&t;This program is free software; you can redistribute it and/or&n; *      modify it under the terms of the GNU General Public License&n; *      as published by the Free Software Foundation; either version&n; *      2 of the License, or (at your option) any later version.&n; */
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/socket.h&gt;
macro_line|#include &lt;linux/sockios.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/net.h&gt;
macro_line|#include &lt;linux/netdevice.h&gt;
macro_line|#include &lt;linux/if_arp.h&gt;
macro_line|#include &lt;linux/in6.h&gt;
macro_line|#include &lt;net/sock.h&gt;
macro_line|#include &lt;net/snmp.h&gt;
macro_line|#include &lt;net/ipv6.h&gt;
macro_line|#include &lt;net/ndisc.h&gt;
macro_line|#include &lt;net/protocol.h&gt;
macro_line|#include &lt;net/transp_v6.h&gt;
macro_line|#include &lt;net/ipv6_route.h&gt;
macro_line|#include &lt;net/addrconf.h&gt;
DECL|variable|ipv6_fragmentation_id
r_static
id|u32
id|ipv6_fragmentation_id
op_assign
l_int|1
suffix:semicolon
DECL|variable|ipv6_forwarding
r_int
id|ipv6_forwarding
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* default: host */
DECL|function|ipv6_build_mac_header
r_static
r_int
id|__inline__
id|ipv6_build_mac_header
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|device
op_star
id|dev
comma
r_struct
id|neighbour
op_star
id|neigh
comma
r_int
id|len
)paren
(brace
r_int
id|mac
suffix:semicolon
r_int
id|hdrlen
op_assign
l_int|0
suffix:semicolon
id|skb-&gt;arp
op_assign
l_int|1
suffix:semicolon
id|skb-&gt;nexthop
op_assign
id|neigh
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;hard_header_len
)paren
(brace
id|skb_reserve
c_func
(paren
id|skb
comma
(paren
id|dev-&gt;hard_header_len
op_plus
l_int|15
)paren
op_amp
op_complement
l_int|15
)paren
suffix:semicolon
r_if
c_cond
(paren
id|neigh
op_logical_and
(paren
id|neigh-&gt;flags
op_amp
id|NCF_HHVALID
)paren
)paren
(brace
multiline_comment|/*&n;&t;&t;&t; *&t;Cached hardware header&n;&t;&t;&t; */
id|memcpy
c_func
(paren
id|skb_push
c_func
(paren
id|skb
comma
id|dev-&gt;hard_header_len
)paren
comma
id|neigh-&gt;hh_data
comma
id|dev-&gt;hard_header_len
)paren
suffix:semicolon
r_return
id|dev-&gt;hard_header_len
suffix:semicolon
)brace
r_if
c_cond
(paren
id|dev-&gt;hard_header
)paren
(brace
id|mac
op_assign
id|dev
op_member_access_from_pointer
id|hard_header
c_func
(paren
id|skb
comma
id|dev
comma
id|ETH_P_IPV6
comma
l_int|NULL
comma
l_int|NULL
comma
id|len
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mac
OL
l_int|0
)paren
(brace
id|hdrlen
op_assign
op_minus
id|mac
suffix:semicolon
id|skb-&gt;arp
op_assign
l_int|0
suffix:semicolon
)brace
r_else
(brace
id|hdrlen
op_assign
id|mac
suffix:semicolon
)brace
)brace
r_else
id|hdrlen
op_assign
id|dev-&gt;hard_header_len
suffix:semicolon
)brace
r_return
id|hdrlen
suffix:semicolon
)brace
DECL|function|ipv6_redo_mac_hdr
r_void
id|ipv6_redo_mac_hdr
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|neighbour
op_star
id|neigh
comma
r_int
id|len
)paren
(brace
r_struct
id|device
op_star
id|dev
op_assign
id|neigh-&gt;dev
suffix:semicolon
r_int
id|mac
suffix:semicolon
id|skb-&gt;dev
op_assign
id|dev
suffix:semicolon
id|skb-&gt;nexthop
op_assign
id|neigh
suffix:semicolon
id|skb-&gt;arp
op_assign
l_int|1
suffix:semicolon
id|skb_pull
c_func
(paren
id|skb
comma
(paren
r_int
r_char
op_star
)paren
id|skb-&gt;ipv6_hdr
op_minus
id|skb-&gt;data
)paren
suffix:semicolon
multiline_comment|/*&n;&t; *&t;neighbour cache should have the ether address&n;&t; *&t;cached... use it&n;&t; */
r_if
c_cond
(paren
id|dev-&gt;hard_header
)paren
(brace
r_if
c_cond
(paren
id|neigh
op_logical_and
(paren
id|neigh-&gt;flags
op_amp
id|NCF_HHVALID
)paren
)paren
(brace
multiline_comment|/*&n;&t;&t;&t; *&t;Cached hardware header&n;&t;&t;&t; */
id|memcpy
c_func
(paren
id|skb_push
c_func
(paren
id|skb
comma
id|dev-&gt;hard_header_len
)paren
comma
id|neigh-&gt;hh_data
comma
id|dev-&gt;hard_header_len
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|mac
op_assign
id|dev
op_member_access_from_pointer
id|hard_header
c_func
(paren
id|skb
comma
id|dev
comma
id|ETH_P_IPV6
comma
l_int|NULL
comma
l_int|NULL
comma
id|len
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mac
OL
l_int|0
)paren
(brace
id|skb-&gt;arp
op_assign
l_int|0
suffix:semicolon
)brace
)brace
)brace
DECL|function|default_output_method
r_void
id|default_output_method
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|rt6_info
op_star
id|rt
)paren
(brace
r_struct
id|sock
op_star
id|sk
op_assign
id|skb-&gt;sk
suffix:semicolon
r_struct
id|device
op_star
id|dev
op_assign
id|skb-&gt;dev
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;flags
op_amp
id|IFF_UP
)paren
(brace
multiline_comment|/*&n;&t;&t; *&t;If we have an owner use its priority setting,&n;&t;&t; *&t;otherwise use NORMAL&n;&t;&t; */
r_if
c_cond
(paren
id|sk
op_ne
l_int|NULL
)paren
(brace
id|dev_queue_xmit
c_func
(paren
id|skb
comma
id|dev
comma
id|sk-&gt;priority
)paren
suffix:semicolon
)brace
r_else
(brace
id|dev_queue_xmit
c_func
(paren
id|skb
comma
id|dev
comma
id|SOPRI_NORMAL
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
r_if
c_cond
(paren
id|sk
)paren
(brace
id|sk-&gt;err
op_assign
id|ENETDOWN
suffix:semicolon
)brace
id|ipv6_statistics.Ip6OutDiscards
op_increment
suffix:semicolon
id|kfree_skb
c_func
(paren
id|skb
comma
id|FREE_WRITE
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/*&n; *&t;xmit an sk_buff (used by TCP)&n; *&t;sk can be NULL (for sending RESETs)&n; */
DECL|function|ipv6_xmit
r_int
id|ipv6_xmit
c_func
(paren
r_struct
id|sock
op_star
id|sk
comma
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|in6_addr
op_star
id|saddr
comma
r_struct
id|in6_addr
op_star
id|daddr
comma
r_struct
id|ipv6_options
op_star
id|opt
comma
r_int
id|proto
)paren
(brace
r_struct
id|ipv6hdr
op_star
id|hdr
suffix:semicolon
r_struct
id|dest_entry
op_star
id|dc
suffix:semicolon
r_struct
id|ipv6_pinfo
op_star
id|np
op_assign
l_int|NULL
suffix:semicolon
r_struct
id|device
op_star
id|dev
op_assign
id|skb-&gt;dev
suffix:semicolon
r_int
id|seg_len
suffix:semicolon
r_int
id|addr_type
suffix:semicolon
r_int
id|rt_flags
op_assign
l_int|0
suffix:semicolon
id|addr_type
op_assign
id|ipv6_addr_type
c_func
(paren
id|daddr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|addr_type
op_amp
(paren
id|IPV6_ADDR_LINKLOCAL
op_or
id|IPV6_ADDR_SITELOCAL
)paren
)paren
(brace
multiline_comment|/*&n;&t;&t; *&t;force device match on route lookup&n;&t;&t; */
id|rt_flags
op_or_assign
id|RTI_DEVRT
suffix:semicolon
)brace
r_if
c_cond
(paren
id|skb-&gt;localroute
)paren
(brace
id|rt_flags
op_or_assign
id|RTI_GATEWAY
suffix:semicolon
)brace
id|hdr
op_assign
id|skb-&gt;ipv6_hdr
suffix:semicolon
r_if
c_cond
(paren
id|sk
)paren
(brace
id|np
op_assign
op_amp
id|sk-&gt;net_pinfo.af_inet6
suffix:semicolon
)brace
r_if
c_cond
(paren
id|np
op_logical_and
id|np-&gt;dest
)paren
(brace
id|dc
op_assign
id|ipv6_dst_check
c_func
(paren
id|np-&gt;dest
comma
id|daddr
comma
id|np-&gt;dc_sernum
comma
id|rt_flags
)paren
suffix:semicolon
)brace
r_else
(brace
id|dc
op_assign
id|ipv6_dst_route
c_func
(paren
id|daddr
comma
id|dev
comma
id|rt_flags
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|dc
op_eq
l_int|NULL
)paren
(brace
id|ipv6_statistics.Ip6OutNoRoutes
op_increment
suffix:semicolon
r_return
op_minus
id|ENETUNREACH
suffix:semicolon
)brace
id|dev
op_assign
id|dc-&gt;rt.rt_dev
suffix:semicolon
r_if
c_cond
(paren
id|saddr
op_eq
l_int|NULL
)paren
(brace
r_struct
id|inet6_ifaddr
op_star
id|ifa
suffix:semicolon
id|ifa
op_assign
id|ipv6_get_saddr
c_func
(paren
(paren
r_struct
id|rt6_info
op_star
)paren
id|dc
comma
id|daddr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ifa
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;ipv6_xmit: get_saddr failed&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENETUNREACH
suffix:semicolon
)brace
id|saddr
op_assign
op_amp
id|ifa-&gt;addr
suffix:semicolon
r_if
c_cond
(paren
id|np
)paren
(brace
id|ipv6_addr_copy
c_func
(paren
op_amp
id|np-&gt;saddr
comma
id|saddr
)paren
suffix:semicolon
)brace
)brace
id|seg_len
op_assign
id|skb-&gt;tail
op_minus
(paren
(paren
r_int
r_char
op_star
)paren
id|hdr
)paren
suffix:semicolon
multiline_comment|/*&n;&t; *&t;Link Layer headers&n;&t; */
id|skb-&gt;sk
op_assign
id|sk
suffix:semicolon
id|skb-&gt;protocol
op_assign
id|__constant_htons
c_func
(paren
id|ETH_P_IPV6
)paren
suffix:semicolon
id|skb-&gt;free
op_assign
l_int|1
suffix:semicolon
id|skb-&gt;dev
op_assign
id|dev
suffix:semicolon
id|ipv6_redo_mac_hdr
c_func
(paren
id|skb
comma
id|dc-&gt;dc_nexthop
comma
id|seg_len
)paren
suffix:semicolon
multiline_comment|/*&n;&t; *&t;Fill in the IPv6 header&n;&t; */
id|hdr-&gt;version
op_assign
l_int|6
suffix:semicolon
id|hdr-&gt;priority
op_assign
id|np
ques
c_cond
id|np-&gt;priority
suffix:colon
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|np
)paren
id|memcpy
c_func
(paren
id|hdr-&gt;flow_lbl
comma
(paren
r_void
op_star
)paren
op_amp
id|np-&gt;flow_lbl
comma
l_int|3
)paren
suffix:semicolon
r_else
id|memset
c_func
(paren
id|hdr-&gt;flow_lbl
comma
l_int|0
comma
l_int|3
)paren
suffix:semicolon
id|hdr-&gt;payload_len
op_assign
id|htons
c_func
(paren
id|seg_len
op_minus
r_sizeof
(paren
r_struct
id|ipv6hdr
)paren
)paren
suffix:semicolon
id|hdr-&gt;nexthdr
op_assign
id|proto
suffix:semicolon
id|hdr-&gt;hop_limit
op_assign
id|np
ques
c_cond
id|np-&gt;hop_limit
suffix:colon
id|ipv6_hop_limit
suffix:semicolon
id|memcpy
c_func
(paren
op_amp
id|hdr-&gt;saddr
comma
id|saddr
comma
r_sizeof
(paren
r_struct
id|in6_addr
)paren
)paren
suffix:semicolon
id|memcpy
c_func
(paren
op_amp
id|hdr-&gt;daddr
comma
id|daddr
comma
r_sizeof
(paren
r_struct
id|in6_addr
)paren
)paren
suffix:semicolon
multiline_comment|/*&n;&t; *&t;Options&n;&t; */
multiline_comment|/*&n;&t; *&t;Output the packet&n;&t; */
id|ipv6_statistics.Ip6OutRequests
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|dc-&gt;rt.rt_output_method
)paren
(brace
(paren
op_star
id|dc-&gt;rt.rt_output_method
)paren
(paren
id|skb
comma
(paren
r_struct
id|rt6_info
op_star
)paren
id|dc
)paren
suffix:semicolon
)brace
r_else
id|default_output_method
c_func
(paren
id|skb
comma
(paren
r_struct
id|rt6_info
op_star
)paren
id|dc
)paren
suffix:semicolon
multiline_comment|/*&n;&t; *&t;Update serial number of cached dest_entry or&n;&t; *&t;release destination cache entry&n;&t; */
r_if
c_cond
(paren
id|np
)paren
(brace
id|np-&gt;dest
op_assign
id|dc
suffix:semicolon
r_if
c_cond
(paren
id|dc-&gt;rt.fib_node
)paren
(brace
id|np-&gt;dc_sernum
op_assign
id|dc-&gt;rt.fib_node-&gt;fn_sernum
suffix:semicolon
)brace
)brace
r_else
(brace
id|ipv6_dst_unlock
c_func
(paren
id|dc
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;To avoid extra problems ND packets are send through this&n; *&t;routine. It&squot;s code duplication but i really want to avoid&n; *&t;extra checks since ipv6_build_header is used by TCP (which&n; *&t;is for us performace critical)&n; */
DECL|function|ipv6_bld_hdr_2
r_int
id|ipv6_bld_hdr_2
c_func
(paren
r_struct
id|sock
op_star
id|sk
comma
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|device
op_star
id|dev
comma
r_struct
id|neighbour
op_star
id|neigh
comma
r_struct
id|in6_addr
op_star
id|saddr
comma
r_struct
id|in6_addr
op_star
id|daddr
comma
r_int
id|proto
comma
r_int
id|len
)paren
(brace
r_struct
id|ipv6_pinfo
op_star
id|np
op_assign
op_amp
id|sk-&gt;net_pinfo.af_inet6
suffix:semicolon
r_struct
id|ipv6hdr
op_star
id|hdr
suffix:semicolon
r_int
id|hdrlen
op_assign
l_int|0
suffix:semicolon
id|skb-&gt;dev
op_assign
id|dev
suffix:semicolon
multiline_comment|/* build MAC header */
id|hdrlen
op_add_assign
id|ipv6_build_mac_header
c_func
(paren
id|skb
comma
id|dev
comma
id|neigh
comma
id|len
)paren
suffix:semicolon
multiline_comment|/* build fixed IPv6 header */
r_if
c_cond
(paren
id|proto
op_eq
id|IPPROTO_RAW
)paren
r_return
id|hdrlen
suffix:semicolon
id|hdr
op_assign
(paren
r_struct
id|ipv6hdr
op_star
)paren
id|skb_put
c_func
(paren
id|skb
comma
r_sizeof
(paren
r_struct
id|ipv6hdr
)paren
)paren
suffix:semicolon
id|skb-&gt;ipv6_hdr
op_assign
id|hdr
suffix:semicolon
id|hdr-&gt;version
op_assign
l_int|6
suffix:semicolon
id|hdr-&gt;priority
op_assign
id|np-&gt;priority
op_amp
l_int|0x0f
suffix:semicolon
id|memset
c_func
(paren
id|hdr-&gt;flow_lbl
comma
l_int|0
comma
l_int|3
)paren
suffix:semicolon
id|hdr-&gt;hop_limit
op_assign
id|np-&gt;hop_limit
suffix:semicolon
r_if
c_cond
(paren
id|saddr
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;bug: bld_hdr called with no saddr&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENETUNREACH
suffix:semicolon
)brace
id|memcpy
c_func
(paren
op_amp
id|hdr-&gt;saddr
comma
id|saddr
comma
r_sizeof
(paren
r_struct
id|in6_addr
)paren
)paren
suffix:semicolon
id|memcpy
c_func
(paren
op_amp
id|hdr-&gt;daddr
comma
id|daddr
comma
r_sizeof
(paren
r_struct
id|in6_addr
)paren
)paren
suffix:semicolon
id|hdrlen
op_add_assign
r_sizeof
(paren
r_struct
id|ipv6hdr
)paren
suffix:semicolon
id|hdr-&gt;nexthdr
op_assign
id|proto
suffix:semicolon
r_return
id|hdrlen
suffix:semicolon
)brace
DECL|function|ipv6_queue_xmit
r_void
id|ipv6_queue_xmit
c_func
(paren
r_struct
id|sock
op_star
id|sk
comma
r_struct
id|device
op_star
id|dev
comma
r_struct
id|sk_buff
op_star
id|skb
comma
r_int
id|free
)paren
(brace
r_struct
id|ipv6hdr
op_star
id|hdr
suffix:semicolon
id|u32
id|seg_len
suffix:semicolon
id|hdr
op_assign
id|skb-&gt;ipv6_hdr
suffix:semicolon
id|skb-&gt;sk
op_assign
id|sk
suffix:semicolon
id|skb-&gt;protocol
op_assign
id|__constant_htons
c_func
(paren
id|ETH_P_IPV6
)paren
suffix:semicolon
id|skb-&gt;free
op_assign
l_int|1
suffix:semicolon
id|seg_len
op_assign
id|skb-&gt;tail
op_minus
(paren
(paren
r_int
r_char
op_star
)paren
id|hdr
)paren
suffix:semicolon
id|hdr-&gt;payload_len
op_assign
id|htons
c_func
(paren
id|seg_len
op_minus
r_sizeof
(paren
r_struct
id|ipv6hdr
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dev
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;ipv6_queue_xmit: unknown device&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|skb-&gt;dev
op_assign
id|dev
suffix:semicolon
id|ipv6_statistics.Ip6OutRequests
op_increment
suffix:semicolon
multiline_comment|/*&n;&t; *&t;Multicast loopback&n;&t; */
r_if
c_cond
(paren
id|dev-&gt;flags
op_amp
id|IFF_UP
)paren
(brace
multiline_comment|/*&n;&t;&t; *&t;If we have an owner use its priority setting,&n;&t;&t; *&t;otherwise use NORMAL&n;&t;&t; */
r_if
c_cond
(paren
id|sk
op_ne
l_int|NULL
)paren
(brace
id|dev_queue_xmit
c_func
(paren
id|skb
comma
id|dev
comma
id|sk-&gt;priority
)paren
suffix:semicolon
)brace
r_else
(brace
id|dev_queue_xmit
c_func
(paren
id|skb
comma
id|dev
comma
id|SOPRI_NORMAL
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
r_if
c_cond
(paren
id|sk
)paren
(brace
id|sk-&gt;err
op_assign
id|ENETDOWN
suffix:semicolon
)brace
id|ipv6_statistics.Ip6OutDiscards
op_increment
suffix:semicolon
id|kfree_skb
c_func
(paren
id|skb
comma
id|FREE_WRITE
)paren
suffix:semicolon
)brace
)brace
DECL|function|ipv6_build_xmit
r_int
id|ipv6_build_xmit
c_func
(paren
r_struct
id|sock
op_star
id|sk
comma
id|inet_getfrag_t
id|getfrag
comma
r_const
r_void
op_star
id|data
comma
r_struct
id|in6_addr
op_star
id|dest
comma
r_int
r_int
r_int
id|length
comma
r_struct
id|in6_addr
op_star
id|saddr
comma
r_struct
id|device
op_star
id|dev
comma
r_struct
id|ipv6_options
op_star
id|opt
comma
r_int
id|proto
comma
r_int
id|noblock
)paren
(brace
id|rt6_output_method_t
id|output_method
op_assign
id|default_output_method
suffix:semicolon
r_int
id|hlimit
suffix:semicolon
r_struct
id|ipv6_pinfo
op_star
id|np
op_assign
op_amp
id|sk-&gt;net_pinfo.af_inet6
suffix:semicolon
r_struct
id|dest_entry
op_star
id|dc
op_assign
l_int|NULL
suffix:semicolon
r_struct
id|in6_addr
op_star
id|daddr
op_assign
id|dest
suffix:semicolon
r_struct
id|ipv6hdr
op_star
id|hdr
suffix:semicolon
r_struct
id|neighbour
op_star
id|neigh
suffix:semicolon
r_int
id|addr_type
suffix:semicolon
r_int
id|pktlength
suffix:semicolon
r_int
id|pmtu
op_assign
l_int|0
suffix:semicolon
r_int
id|rt_flags
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|opt
op_logical_and
id|opt-&gt;srcrt
)paren
(brace
r_struct
id|rt0_hdr
op_star
id|rt0
op_assign
(paren
r_struct
id|rt0_hdr
op_star
)paren
id|opt-&gt;srcrt
suffix:semicolon
id|daddr
op_assign
id|rt0-&gt;addr
suffix:semicolon
)brace
id|addr_type
op_assign
id|ipv6_addr_type
c_func
(paren
id|daddr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|addr_type
op_amp
id|IPV6_ADDR_MULTICAST
)paren
(brace
id|hlimit
op_assign
id|np-&gt;mcast_hops
suffix:semicolon
r_if
c_cond
(paren
id|dev
op_eq
l_int|NULL
)paren
(brace
id|dev
op_assign
id|np-&gt;mc_if
suffix:semicolon
)brace
)brace
r_else
id|hlimit
op_assign
id|np-&gt;hop_limit
suffix:semicolon
r_if
c_cond
(paren
id|addr_type
op_amp
(paren
id|IPV6_ADDR_LINKLOCAL
op_or
id|IPV6_ADDR_SITELOCAL
op_or
id|IPV6_ADDR_MULTICAST
)paren
)paren
(brace
multiline_comment|/*&n;&t;&t; *&t;force device match on route lookup&n;&t;&t; */
id|rt_flags
op_or_assign
id|RTI_DEVRT
suffix:semicolon
)brace
r_if
c_cond
(paren
id|sk-&gt;localroute
)paren
(brace
id|rt_flags
op_or_assign
id|RTI_GATEWAY
suffix:semicolon
)brace
r_if
c_cond
(paren
id|np-&gt;dest
)paren
(brace
id|np-&gt;dest
op_assign
id|ipv6_dst_check
c_func
(paren
id|np-&gt;dest
comma
id|daddr
comma
id|np-&gt;dc_sernum
comma
id|rt_flags
)paren
suffix:semicolon
id|dc
op_assign
id|np-&gt;dest
suffix:semicolon
r_if
c_cond
(paren
id|dc
op_logical_and
id|dc-&gt;rt.fib_node
)paren
(brace
id|np-&gt;dc_sernum
op_assign
id|dc-&gt;rt.fib_node-&gt;fn_sernum
suffix:semicolon
)brace
r_else
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;dc entry not in table&bslash;n&quot;
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
id|dc
op_assign
id|ipv6_dst_route
c_func
(paren
id|daddr
comma
id|dev
comma
id|rt_flags
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|dc
op_eq
l_int|NULL
)paren
(brace
r_if
c_cond
(paren
(paren
id|addr_type
op_amp
id|IPV6_ADDR_MULTICAST
)paren
op_logical_and
id|dev
)paren
(brace
id|neigh
op_assign
l_int|NULL
suffix:semicolon
id|pmtu
op_assign
id|dev-&gt;mtu
suffix:semicolon
)brace
r_else
(brace
id|ipv6_statistics.Ip6OutNoRoutes
op_increment
suffix:semicolon
r_return
op_minus
id|ENETUNREACH
suffix:semicolon
)brace
)brace
r_else
(brace
id|neigh
op_assign
id|dc-&gt;dc_nexthop
suffix:semicolon
id|dev
op_assign
id|neigh-&gt;dev
suffix:semicolon
r_if
c_cond
(paren
id|dc-&gt;rt.rt_output_method
)paren
(brace
id|output_method
op_assign
id|dc-&gt;rt.rt_output_method
suffix:semicolon
)brace
r_if
c_cond
(paren
id|dc-&gt;dc_flags
op_amp
id|DCF_PMTU
)paren
id|pmtu
op_assign
id|dc-&gt;dc_pmtu
suffix:semicolon
r_else
id|pmtu
op_assign
id|dev-&gt;mtu
suffix:semicolon
)brace
r_if
c_cond
(paren
id|saddr
op_eq
l_int|NULL
)paren
(brace
r_struct
id|inet6_ifaddr
op_star
id|ifa
suffix:semicolon
id|ifa
op_assign
id|ipv6_get_saddr
c_func
(paren
(paren
r_struct
id|rt6_info
op_star
)paren
id|dc
comma
id|daddr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ifa
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;ipv6_build_xmit: get_saddr failed&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENETUNREACH
suffix:semicolon
)brace
id|saddr
op_assign
op_amp
id|ifa-&gt;addr
suffix:semicolon
)brace
r_if
c_cond
(paren
id|dc
op_logical_and
id|np-&gt;dest
op_eq
l_int|NULL
)paren
(brace
id|ipv6_dst_unlock
c_func
(paren
id|dc
)paren
suffix:semicolon
)brace
id|pktlength
op_assign
id|length
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|sk-&gt;ip_hdrincl
)paren
(brace
id|pktlength
op_add_assign
r_sizeof
(paren
r_struct
id|ipv6hdr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|opt
)paren
(brace
id|pktlength
op_add_assign
id|opt-&gt;opt_flen
op_plus
id|opt-&gt;opt_nflen
suffix:semicolon
)brace
)brace
id|dev_lock_list
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/*&n;&t; *&t;reminder: don&squot;t allow fragmentation for IPPROTO_RAW&n;&t; */
r_if
c_cond
(paren
id|pktlength
op_le
id|pmtu
)paren
(brace
r_int
id|error
suffix:semicolon
r_struct
id|sk_buff
op_star
id|skb
op_assign
id|sock_alloc_send_skb
c_func
(paren
id|sk
comma
id|pktlength
op_plus
l_int|15
op_plus
id|dev-&gt;hard_header_len
comma
l_int|0
comma
id|noblock
comma
op_amp
id|error
)paren
suffix:semicolon
r_if
c_cond
(paren
id|skb
op_eq
l_int|NULL
)paren
(brace
id|ipv6_statistics.Ip6OutDiscards
op_increment
suffix:semicolon
id|dev_unlock_list
c_func
(paren
)paren
suffix:semicolon
r_return
id|error
suffix:semicolon
)brace
id|skb-&gt;dev
op_assign
id|dev
suffix:semicolon
id|skb-&gt;protocol
op_assign
id|htons
c_func
(paren
id|ETH_P_IPV6
)paren
suffix:semicolon
id|skb-&gt;free
op_assign
l_int|1
suffix:semicolon
id|skb-&gt;when
op_assign
id|jiffies
suffix:semicolon
id|skb-&gt;sk
op_assign
id|sk
suffix:semicolon
id|skb-&gt;arp
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* build the mac header... */
id|ipv6_build_mac_header
c_func
(paren
id|skb
comma
id|dev
comma
id|neigh
comma
id|pktlength
)paren
suffix:semicolon
id|hdr
op_assign
(paren
r_struct
id|ipv6hdr
op_star
)paren
id|skb-&gt;tail
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|sk-&gt;ip_hdrincl
)paren
(brace
id|skb_put
c_func
(paren
id|skb
comma
r_sizeof
(paren
r_struct
id|ipv6hdr
)paren
)paren
suffix:semicolon
id|skb-&gt;ipv6_hdr
op_assign
id|hdr
suffix:semicolon
id|hdr-&gt;version
op_assign
l_int|6
suffix:semicolon
id|hdr-&gt;priority
op_assign
id|np-&gt;priority
suffix:semicolon
id|memcpy
c_func
(paren
id|hdr-&gt;flow_lbl
comma
op_amp
id|np-&gt;flow_lbl
comma
l_int|3
)paren
suffix:semicolon
id|hdr-&gt;payload_len
op_assign
id|htons
c_func
(paren
id|pktlength
op_minus
r_sizeof
(paren
r_struct
id|ipv6hdr
)paren
)paren
suffix:semicolon
id|hdr-&gt;hop_limit
op_assign
id|hlimit
suffix:semicolon
id|memcpy
c_func
(paren
op_amp
id|hdr-&gt;saddr
comma
id|saddr
comma
r_sizeof
(paren
r_struct
id|in6_addr
)paren
)paren
suffix:semicolon
id|memcpy
c_func
(paren
op_amp
id|hdr-&gt;daddr
comma
id|daddr
comma
r_sizeof
(paren
r_struct
id|in6_addr
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|opt
op_logical_and
id|opt-&gt;srcrt
)paren
(brace
id|hdr-&gt;nexthdr
op_assign
id|ipv6opt_bld_rthdr
c_func
(paren
id|skb
comma
id|opt
comma
id|dest
comma
id|proto
)paren
suffix:semicolon
)brace
r_else
id|hdr-&gt;nexthdr
op_assign
id|proto
suffix:semicolon
)brace
id|skb_put
c_func
(paren
id|skb
comma
id|length
)paren
suffix:semicolon
id|getfrag
c_func
(paren
id|data
comma
op_amp
id|hdr-&gt;saddr
comma
(paren
(paren
r_char
op_star
)paren
id|hdr
)paren
op_plus
(paren
id|pktlength
op_minus
id|length
)paren
comma
l_int|0
comma
id|length
)paren
suffix:semicolon
id|ipv6_statistics.Ip6OutRequests
op_increment
suffix:semicolon
(paren
op_star
id|output_method
)paren
(paren
id|skb
comma
(paren
r_struct
id|rt6_info
op_star
)paren
id|dc
)paren
suffix:semicolon
id|dev_unlock_list
c_func
(paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/*&n;&t;&t; *&t;Fragmentation&n;&t;&t; */
multiline_comment|/*&n;&t;&t; *&t;Extension header order:&n;&t;&t; *&t;Hop-by-hop -&gt; Routing -&gt; Fragment -&gt; rest (...)&n;&t;&t; *&t;&n;&t;&t; *&t;We must build the non-fragmented part that&n;&t;&t; *&t;will be in every packet... this also means&n;&t;&t; *&t;that other extension headers (Dest, Auth, etc)&n;&t;&t; *&t;must be considered in the data to be fragmented&n;&t;&t; */
r_struct
id|sk_buff
op_star
id|last_skb
suffix:semicolon
r_struct
id|frag_hdr
op_star
id|fhdr
suffix:semicolon
r_int
id|unfrag_len
suffix:semicolon
r_int
id|payl_len
suffix:semicolon
r_int
id|frag_len
suffix:semicolon
r_int
id|last_len
suffix:semicolon
r_int
id|nfrags
suffix:semicolon
r_int
id|err
suffix:semicolon
r_int
id|fhdr_dist
suffix:semicolon
id|__u32
id|id
suffix:semicolon
r_if
c_cond
(paren
id|sk-&gt;ip_hdrincl
)paren
(brace
r_return
op_minus
id|EMSGSIZE
suffix:semicolon
)brace
id|id
op_assign
id|ipv6_fragmentation_id
op_increment
suffix:semicolon
id|unfrag_len
op_assign
r_sizeof
(paren
r_struct
id|ipv6hdr
)paren
op_plus
r_sizeof
(paren
r_struct
id|frag_hdr
)paren
suffix:semicolon
id|payl_len
op_assign
id|length
suffix:semicolon
r_if
c_cond
(paren
id|opt
)paren
(brace
id|unfrag_len
op_add_assign
id|opt-&gt;opt_nflen
suffix:semicolon
id|payl_len
op_add_assign
id|opt-&gt;opt_flen
suffix:semicolon
)brace
id|nfrags
op_assign
id|payl_len
op_div
(paren
(paren
id|pmtu
op_minus
id|unfrag_len
)paren
op_amp
op_complement
l_int|0x7
)paren
suffix:semicolon
multiline_comment|/* &n;&t;&t; * Length of fragmented part on every packet but &n;&t;&t; * the last must be an:&n;&t;&t; * &quot;integer multiple of 8 octects&quot;.&n;&t;&t; */
id|frag_len
op_assign
(paren
id|pmtu
op_minus
id|unfrag_len
)paren
op_amp
op_complement
l_int|0x7
suffix:semicolon
multiline_comment|/*&n;&t;&t; *&t;We must send from end to start because of &n;&t;&t; *&t;UDP/ICMP checksums. We do a funny trick:&n;&t;&t; *&t;fill the last skb first with the fixed&n;&t;&t; *&t;header (and its data) and then use it&n;&t;&t; *&t;to create the following segments and send it&n;&t;&t; *&t;in the end. If the peer is checking the M_flag&n;&t;&t; *&t;to trigger the reassembly code then this &n;&t;&t; *&t;might be a good idea.&n;&t;&t; */
id|last_len
op_assign
id|payl_len
op_minus
(paren
id|nfrags
op_star
id|frag_len
)paren
suffix:semicolon
r_if
c_cond
(paren
id|last_len
op_eq
l_int|0
)paren
(brace
id|last_len
op_assign
id|frag_len
suffix:semicolon
id|nfrags
op_decrement
suffix:semicolon
)brace
id|last_skb
op_assign
id|sock_alloc_send_skb
c_func
(paren
id|sk
comma
id|unfrag_len
op_plus
id|frag_len
op_plus
id|dev-&gt;hard_header_len
op_plus
l_int|15
comma
l_int|0
comma
id|noblock
comma
op_amp
id|err
)paren
suffix:semicolon
r_if
c_cond
(paren
id|last_skb
op_eq
l_int|NULL
)paren
(brace
id|dev_unlock_list
c_func
(paren
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
id|last_skb-&gt;dev
op_assign
id|dev
suffix:semicolon
id|last_skb-&gt;protocol
op_assign
id|htons
c_func
(paren
id|ETH_P_IPV6
)paren
suffix:semicolon
id|last_skb-&gt;free
op_assign
l_int|1
suffix:semicolon
id|last_skb-&gt;when
op_assign
id|jiffies
suffix:semicolon
id|last_skb-&gt;sk
op_assign
id|sk
suffix:semicolon
id|last_skb-&gt;arp
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* &n;&t;&t; * build the mac header... &n;&t;&t; */
id|ipv6_build_mac_header
c_func
(paren
id|last_skb
comma
id|dev
comma
id|neigh
comma
id|unfrag_len
op_plus
id|frag_len
)paren
suffix:semicolon
id|hdr
op_assign
(paren
r_struct
id|ipv6hdr
op_star
)paren
id|skb_put
c_func
(paren
id|last_skb
comma
r_sizeof
(paren
r_struct
id|ipv6hdr
)paren
)paren
suffix:semicolon
id|last_skb-&gt;ipv6_hdr
op_assign
id|hdr
suffix:semicolon
id|hdr-&gt;version
op_assign
l_int|6
suffix:semicolon
id|hdr-&gt;priority
op_assign
id|np-&gt;priority
suffix:semicolon
id|memcpy
c_func
(paren
id|hdr-&gt;flow_lbl
comma
op_amp
id|np-&gt;flow_lbl
comma
l_int|3
)paren
suffix:semicolon
id|hdr-&gt;payload_len
op_assign
id|htons
c_func
(paren
id|unfrag_len
op_plus
id|frag_len
op_minus
r_sizeof
(paren
r_struct
id|ipv6hdr
)paren
)paren
suffix:semicolon
id|hdr-&gt;hop_limit
op_assign
id|hlimit
suffix:semicolon
id|hdr-&gt;nexthdr
op_assign
id|NEXTHDR_FRAGMENT
suffix:semicolon
id|memcpy
c_func
(paren
op_amp
id|hdr-&gt;saddr
comma
id|saddr
comma
r_sizeof
(paren
r_struct
id|in6_addr
)paren
)paren
suffix:semicolon
id|memcpy
c_func
(paren
op_amp
id|hdr-&gt;daddr
comma
id|daddr
comma
r_sizeof
(paren
r_struct
id|in6_addr
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|opt
op_logical_and
id|opt-&gt;srcrt
)paren
(brace
id|hdr-&gt;nexthdr
op_assign
id|ipv6opt_bld_rthdr
c_func
(paren
id|last_skb
comma
id|opt
comma
id|dest
comma
id|NEXTHDR_FRAGMENT
)paren
suffix:semicolon
)brace
id|fhdr
op_assign
(paren
r_struct
id|frag_hdr
op_star
)paren
id|skb_put
c_func
(paren
id|last_skb
comma
r_sizeof
(paren
r_struct
id|frag_hdr
)paren
)paren
suffix:semicolon
id|memset
c_func
(paren
id|fhdr
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|frag_hdr
)paren
)paren
suffix:semicolon
id|fhdr-&gt;nexthdr
op_assign
id|proto
suffix:semicolon
id|fhdr-&gt;frag_off
op_assign
id|ntohs
c_func
(paren
id|nfrags
op_star
id|frag_len
)paren
suffix:semicolon
id|fhdr-&gt;identification
op_assign
id|id
suffix:semicolon
id|fhdr_dist
op_assign
(paren
r_int
r_char
op_star
)paren
id|fhdr
op_minus
id|last_skb-&gt;data
suffix:semicolon
id|getfrag
c_func
(paren
id|data
comma
op_amp
id|hdr-&gt;saddr
comma
id|last_skb-&gt;tail
comma
id|nfrags
op_star
id|frag_len
comma
id|last_len
)paren
suffix:semicolon
r_while
c_loop
(paren
id|nfrags
op_decrement
)paren
(brace
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
r_struct
id|frag_hdr
op_star
id|fhdr2
suffix:semicolon
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;sending frag %d&bslash;n&quot;
comma
id|nfrags
)paren
suffix:semicolon
id|skb
op_assign
id|skb_copy
c_func
(paren
id|last_skb
comma
id|sk-&gt;allocation
)paren
suffix:semicolon
id|fhdr2
op_assign
(paren
r_struct
id|frag_hdr
op_star
)paren
(paren
id|skb-&gt;data
op_plus
id|fhdr_dist
)paren
suffix:semicolon
multiline_comment|/* more flag on */
id|fhdr2-&gt;frag_off
op_assign
id|ntohs
c_func
(paren
id|nfrags
op_star
id|frag_len
op_plus
l_int|1
)paren
suffix:semicolon
multiline_comment|/* if (nfrags == 0)&n;&t;&t;&t;   put rest of headers&n;&t;&t;&t;   */
id|getfrag
c_func
(paren
id|data
comma
op_amp
id|hdr-&gt;saddr
comma
id|skb_put
c_func
(paren
id|skb
comma
id|frag_len
)paren
comma
id|nfrags
op_star
id|frag_len
comma
id|frag_len
)paren
suffix:semicolon
id|ipv6_statistics.Ip6OutRequests
op_increment
suffix:semicolon
(paren
op_star
id|output_method
)paren
(paren
id|skb
comma
(paren
r_struct
id|rt6_info
op_star
)paren
id|dc
)paren
suffix:semicolon
)brace
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;sending last frag &bslash;n&quot;
)paren
suffix:semicolon
id|hdr-&gt;payload_len
op_assign
id|htons
c_func
(paren
id|unfrag_len
op_plus
id|last_len
op_minus
r_sizeof
(paren
r_struct
id|ipv6hdr
)paren
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t; *&t;update last_skb to reflect the getfrag we did&n;&t;&t; *&t;on start.&n;&t;&t; */
id|last_skb-&gt;tail
op_add_assign
id|last_len
suffix:semicolon
id|last_skb-&gt;len
op_add_assign
id|last_len
suffix:semicolon
multiline_comment|/* &n;&t;&t; * toss the mac header out and rebuild it.&n;&t;&t; * needed because of the different frame length.&n;&t;&t; * ie: not needed for an ethernet.&n;&t;&t; */
r_if
c_cond
(paren
id|dev-&gt;type
op_ne
id|ARPHRD_ETHER
op_logical_and
id|last_len
op_ne
id|frag_len
)paren
(brace
id|ipv6_redo_mac_hdr
c_func
(paren
id|last_skb
comma
id|neigh
comma
id|unfrag_len
op_plus
id|last_len
)paren
suffix:semicolon
)brace
id|ipv6_statistics.Ip6OutRequests
op_increment
suffix:semicolon
(paren
op_star
id|output_method
)paren
(paren
id|last_skb
comma
(paren
r_struct
id|rt6_info
op_star
)paren
id|dc
)paren
suffix:semicolon
id|dev_unlock_list
c_func
(paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_return
op_minus
l_int|1
suffix:semicolon
)brace
DECL|variable|pri_values
r_static
r_int
id|pri_values
(braket
l_int|4
)braket
op_assign
(brace
id|SOPRI_BACKGROUND
comma
id|SOPRI_NORMAL
comma
id|SOPRI_NORMAL
comma
id|SOPRI_INTERACTIVE
)brace
suffix:semicolon
DECL|function|ipv6_forward
r_void
id|ipv6_forward
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|device
op_star
id|dev
comma
r_int
id|flags
)paren
(brace
r_struct
id|neighbour
op_star
id|neigh
suffix:semicolon
r_struct
id|dest_entry
op_star
id|dest
suffix:semicolon
r_int
id|priority
suffix:semicolon
r_int
id|rt_flags
suffix:semicolon
r_int
id|size
suffix:semicolon
r_int
id|pmtu
suffix:semicolon
r_if
c_cond
(paren
id|skb-&gt;ipv6_hdr-&gt;hop_limit
op_le
l_int|1
)paren
(brace
id|icmpv6_send
c_func
(paren
id|skb
comma
id|ICMPV6_TIME_EXCEEDED
comma
id|ICMPV6_EXC_HOPLIMIT
comma
l_int|0
comma
id|dev
)paren
suffix:semicolon
id|kfree_skb
c_func
(paren
id|skb
comma
id|FREE_READ
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|skb-&gt;ipv6_hdr-&gt;hop_limit
op_decrement
suffix:semicolon
r_if
c_cond
(paren
id|ipv6_addr_type
c_func
(paren
op_amp
id|skb-&gt;ipv6_hdr-&gt;saddr
)paren
op_amp
id|IPV6_ADDR_LINKLOCAL
)paren
(brace
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;ipv6_forward: link local source addr&bslash;n&quot;
)paren
suffix:semicolon
id|icmpv6_send
c_func
(paren
id|skb
comma
id|ICMPV6_DEST_UNREACH
comma
id|ICMPV6_NOT_NEIGHBOUR
comma
l_int|0
comma
id|dev
)paren
suffix:semicolon
id|kfree_skb
c_func
(paren
id|skb
comma
id|FREE_READ
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|rt_flags
op_assign
id|RTF_MODIFIED
suffix:semicolon
r_if
c_cond
(paren
(paren
id|flags
op_amp
id|IP6_FW_STRICT
)paren
)paren
(brace
id|rt_flags
op_or_assign
id|RTF_GATEWAY
suffix:semicolon
)brace
id|dest
op_assign
id|ipv6_dst_route
c_func
(paren
op_amp
id|skb-&gt;ipv6_hdr-&gt;daddr
comma
l_int|NULL
comma
id|rt_flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dest
op_eq
l_int|NULL
)paren
(brace
r_int
id|code
suffix:semicolon
r_if
c_cond
(paren
id|flags
op_amp
id|IP6_FW_STRICT
)paren
id|code
op_assign
id|ICMPV6_NOT_NEIGHBOUR
suffix:semicolon
r_else
id|code
op_assign
id|ICMPV6_NOROUTE
suffix:semicolon
id|icmpv6_send
c_func
(paren
id|skb
comma
id|ICMPV6_DEST_UNREACH
comma
id|code
comma
l_int|0
comma
id|dev
)paren
suffix:semicolon
id|kfree_skb
c_func
(paren
id|skb
comma
id|FREE_READ
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|neigh
op_assign
id|dest-&gt;dc_nexthop
suffix:semicolon
r_if
c_cond
(paren
id|neigh-&gt;dev
op_eq
id|dev
op_logical_and
(paren
id|dev-&gt;flags
op_amp
id|IFF_MULTICAST
)paren
op_logical_and
op_logical_neg
(paren
id|flags
op_amp
id|IP6_FW_SRCRT
)paren
)paren
(brace
r_struct
id|in6_addr
op_star
id|target
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/* &n;&t;&t; *&t;outgoing device equal to incoming device&n;&t;&t; *&t;send a redirect&n;&t;&t; */
r_if
c_cond
(paren
(paren
id|dest-&gt;dc_flags
op_amp
id|RTF_GATEWAY
)paren
)paren
(brace
id|target
op_assign
op_amp
id|neigh-&gt;addr
suffix:semicolon
)brace
r_else
(brace
id|target
op_assign
op_amp
id|skb-&gt;ipv6_hdr-&gt;daddr
suffix:semicolon
)brace
id|ndisc_send_redirect
c_func
(paren
id|skb
comma
id|neigh
comma
id|target
)paren
suffix:semicolon
)brace
id|pmtu
op_assign
id|neigh-&gt;dev-&gt;mtu
suffix:semicolon
id|size
op_assign
r_sizeof
(paren
r_struct
id|ipv6hdr
)paren
op_plus
id|ntohs
c_func
(paren
id|skb-&gt;ipv6_hdr-&gt;payload_len
)paren
suffix:semicolon
r_if
c_cond
(paren
id|size
OG
id|pmtu
)paren
(brace
id|icmpv6_send
c_func
(paren
id|skb
comma
id|ICMPV6_PKT_TOOBIG
comma
l_int|0
comma
id|pmtu
comma
id|dev
)paren
suffix:semicolon
id|kfree_skb
c_func
(paren
id|skb
comma
id|FREE_READ
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|ipv6_dst_unlock
c_func
(paren
id|dest
)paren
suffix:semicolon
r_if
c_cond
(paren
id|skb_headroom
c_func
(paren
id|skb
)paren
OL
id|neigh-&gt;dev-&gt;hard_header_len
)paren
(brace
r_struct
id|sk_buff
op_star
id|buff
suffix:semicolon
id|buff
op_assign
id|alloc_skb
c_func
(paren
id|neigh-&gt;dev-&gt;hard_header_len
op_plus
id|skb-&gt;len
op_plus
l_int|15
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
id|buff
op_eq
l_int|NULL
)paren
(brace
r_return
suffix:semicolon
)brace
id|skb_reserve
c_func
(paren
id|buff
comma
(paren
id|neigh-&gt;dev-&gt;hard_header_len
op_plus
l_int|15
)paren
op_amp
op_complement
l_int|15
)paren
suffix:semicolon
id|buff-&gt;protocol
op_assign
id|__constant_htons
c_func
(paren
id|ETH_P_IPV6
)paren
suffix:semicolon
id|buff-&gt;free
op_assign
l_int|1
suffix:semicolon
id|buff-&gt;h.raw
op_assign
id|skb_put
c_func
(paren
id|buff
comma
id|size
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|buff-&gt;h.raw
comma
id|skb-&gt;ipv6_hdr
comma
id|size
)paren
suffix:semicolon
id|buff-&gt;ipv6_hdr
op_assign
(paren
r_struct
id|ipv6hdr
op_star
)paren
id|buff-&gt;h.raw
suffix:semicolon
id|kfree_skb
c_func
(paren
id|skb
comma
id|FREE_READ
)paren
suffix:semicolon
id|skb
op_assign
id|buff
suffix:semicolon
)brace
id|ipv6_redo_mac_hdr
c_func
(paren
id|skb
comma
id|neigh
comma
id|size
)paren
suffix:semicolon
id|priority
op_assign
id|skb-&gt;ipv6_hdr-&gt;priority
suffix:semicolon
id|priority
op_assign
(paren
id|priority
op_amp
l_int|0x7
)paren
op_rshift
l_int|1
suffix:semicolon
id|priority
op_assign
id|pri_values
(braket
id|priority
)braket
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;flags
op_amp
id|IFF_UP
)paren
(brace
id|dev_queue_xmit
c_func
(paren
id|skb
comma
id|neigh-&gt;dev
comma
id|priority
)paren
suffix:semicolon
)brace
r_else
(brace
id|ipv6_statistics.Ip6OutDiscards
op_increment
suffix:semicolon
id|kfree_skb
c_func
(paren
id|skb
comma
id|FREE_READ
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/*&n; * Local variables:&n; * c-file-style: &quot;Linux&quot;&n; * End:&n; */
eof
