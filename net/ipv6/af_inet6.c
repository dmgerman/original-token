multiline_comment|/*&n; *&t;PF_INET6 socket protocol family&n; *&t;Linux INET6 implementation &n; *&n; *&t;Authors:&n; *&t;Pedro Roque&t;&t;&lt;roque@di.fc.ul.pt&gt;&t;&n; *&n; *&t;Adapted from linux/net/ipv4/af_inet.c&n; *&n; *&t;$Id: af_inet6.c,v 1.60 2000/10/19 01:05:34 davem Exp $&n; *&n; * &t;Fixes:&n; * &t;Hideaki YOSHIFUJI&t;:&t;sin6_scope_id support&n; * &t;Arnaldo Melo&t;&t;: &t;check proc_net_create return, cleanups&n; *&n; *&t;This program is free software; you can redistribute it and/or&n; *      modify it under the terms of the GNU General Public License&n; *      as published by the Free Software Foundation; either version&n; *      2 of the License, or (at your option) any later version.&n; */
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/socket.h&gt;
macro_line|#include &lt;linux/in.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/major.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/timer.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/sockios.h&gt;
macro_line|#include &lt;linux/net.h&gt;
macro_line|#include &lt;linux/fcntl.h&gt;
macro_line|#include &lt;linux/mm.h&gt;
macro_line|#include &lt;linux/interrupt.h&gt;
macro_line|#include &lt;linux/proc_fs.h&gt;
macro_line|#include &lt;linux/stat.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/version.h&gt;
macro_line|#include &lt;linux/inet.h&gt;
macro_line|#include &lt;linux/netdevice.h&gt;
macro_line|#include &lt;linux/icmpv6.h&gt;
macro_line|#include &lt;linux/smp_lock.h&gt;
macro_line|#include &lt;net/ip.h&gt;
macro_line|#include &lt;net/ipv6.h&gt;
macro_line|#include &lt;net/udp.h&gt;
macro_line|#include &lt;net/tcp.h&gt;
macro_line|#include &lt;net/ipip.h&gt;
macro_line|#include &lt;net/protocol.h&gt;
macro_line|#include &lt;net/inet_common.h&gt;
macro_line|#include &lt;net/transp_v6.h&gt;
macro_line|#include &lt;net/ip6_route.h&gt;
macro_line|#include &lt;net/addrconf.h&gt;
macro_line|#include &lt;asm/uaccess.h&gt;
macro_line|#include &lt;asm/system.h&gt;
macro_line|#ifdef MODULE
DECL|variable|unloadable
r_static
r_int
id|unloadable
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* XX: Turn to one when all is ok within the&n;&t;&t;&t;      module for allowing unload */
macro_line|#endif
macro_line|#if defined(MODULE) &amp;&amp; LINUX_VERSION_CODE &gt; 0x20115
id|MODULE_AUTHOR
c_func
(paren
l_string|&quot;Cast of dozens&quot;
)paren
suffix:semicolon
id|MODULE_DESCRIPTION
c_func
(paren
l_string|&quot;IPv6 protocol stack for Linux&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|unloadable
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
macro_line|#endif
r_extern
r_struct
id|proto_ops
id|inet6_stream_ops
suffix:semicolon
r_extern
r_struct
id|proto_ops
id|inet6_dgram_ops
suffix:semicolon
multiline_comment|/* IPv6 procfs goodies... */
macro_line|#ifdef CONFIG_PROC_FS
r_extern
r_int
id|raw6_get_info
c_func
(paren
r_char
op_star
comma
r_char
op_star
op_star
comma
id|off_t
comma
r_int
)paren
suffix:semicolon
r_extern
r_int
id|tcp6_get_info
c_func
(paren
r_char
op_star
comma
r_char
op_star
op_star
comma
id|off_t
comma
r_int
)paren
suffix:semicolon
r_extern
r_int
id|udp6_get_info
c_func
(paren
r_char
op_star
comma
r_char
op_star
op_star
comma
id|off_t
comma
r_int
)paren
suffix:semicolon
r_extern
r_int
id|afinet6_get_info
c_func
(paren
r_char
op_star
comma
r_char
op_star
op_star
comma
id|off_t
comma
r_int
)paren
suffix:semicolon
r_extern
r_int
id|afinet6_get_snmp
c_func
(paren
r_char
op_star
comma
r_char
op_star
op_star
comma
id|off_t
comma
r_int
)paren
suffix:semicolon
macro_line|#endif
macro_line|#ifdef CONFIG_SYSCTL
r_extern
r_void
id|ipv6_sysctl_register
c_func
(paren
r_void
)paren
suffix:semicolon
r_extern
r_void
id|ipv6_sysctl_unregister
c_func
(paren
r_void
)paren
suffix:semicolon
macro_line|#endif
macro_line|#ifdef INET_REFCNT_DEBUG
DECL|variable|inet6_sock_nr
id|atomic_t
id|inet6_sock_nr
suffix:semicolon
macro_line|#endif
DECL|function|inet6_sock_destruct
r_static
r_void
id|inet6_sock_destruct
c_func
(paren
r_struct
id|sock
op_star
id|sk
)paren
(brace
id|inet_sock_destruct
c_func
(paren
id|sk
)paren
suffix:semicolon
macro_line|#ifdef INET_REFCNT_DEBUG
id|atomic_dec
c_func
(paren
op_amp
id|inet6_sock_nr
)paren
suffix:semicolon
macro_line|#endif
id|MOD_DEC_USE_COUNT
suffix:semicolon
)brace
DECL|function|inet6_create
r_static
r_int
id|inet6_create
c_func
(paren
r_struct
id|socket
op_star
id|sock
comma
r_int
id|protocol
)paren
(brace
r_struct
id|sock
op_star
id|sk
suffix:semicolon
r_struct
id|proto
op_star
id|prot
suffix:semicolon
id|sk
op_assign
id|sk_alloc
c_func
(paren
id|PF_INET6
comma
id|GFP_KERNEL
comma
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sk
op_eq
l_int|NULL
)paren
r_goto
id|do_oom
suffix:semicolon
r_if
c_cond
(paren
id|sock-&gt;type
op_eq
id|SOCK_STREAM
op_logical_or
id|sock-&gt;type
op_eq
id|SOCK_SEQPACKET
)paren
(brace
r_if
c_cond
(paren
id|protocol
op_logical_and
id|protocol
op_ne
id|IPPROTO_TCP
)paren
r_goto
id|free_and_noproto
suffix:semicolon
id|protocol
op_assign
id|IPPROTO_TCP
suffix:semicolon
id|prot
op_assign
op_amp
id|tcpv6_prot
suffix:semicolon
id|sock-&gt;ops
op_assign
op_amp
id|inet6_stream_ops
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|sock-&gt;type
op_eq
id|SOCK_DGRAM
)paren
(brace
r_if
c_cond
(paren
id|protocol
op_logical_and
id|protocol
op_ne
id|IPPROTO_UDP
)paren
r_goto
id|free_and_noproto
suffix:semicolon
id|protocol
op_assign
id|IPPROTO_UDP
suffix:semicolon
id|sk-&gt;no_check
op_assign
id|UDP_CSUM_DEFAULT
suffix:semicolon
id|prot
op_assign
op_amp
id|udpv6_prot
suffix:semicolon
id|sock-&gt;ops
op_assign
op_amp
id|inet6_dgram_ops
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|sock-&gt;type
op_eq
id|SOCK_RAW
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|capable
c_func
(paren
id|CAP_NET_RAW
)paren
)paren
r_goto
id|free_and_badperm
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|protocol
)paren
r_goto
id|free_and_noproto
suffix:semicolon
id|prot
op_assign
op_amp
id|rawv6_prot
suffix:semicolon
id|sock-&gt;ops
op_assign
op_amp
id|inet6_dgram_ops
suffix:semicolon
id|sk-&gt;reuse
op_assign
l_int|1
suffix:semicolon
id|sk-&gt;num
op_assign
id|protocol
suffix:semicolon
)brace
r_else
(brace
r_goto
id|free_and_badtype
suffix:semicolon
)brace
id|sock_init_data
c_func
(paren
id|sock
comma
id|sk
)paren
suffix:semicolon
id|sk-&gt;destruct
op_assign
id|inet6_sock_destruct
suffix:semicolon
id|sk-&gt;zapped
op_assign
l_int|0
suffix:semicolon
id|sk-&gt;family
op_assign
id|PF_INET6
suffix:semicolon
id|sk-&gt;protocol
op_assign
id|protocol
suffix:semicolon
id|sk-&gt;prot
op_assign
id|prot
suffix:semicolon
id|sk-&gt;backlog_rcv
op_assign
id|prot-&gt;backlog_rcv
suffix:semicolon
id|sk-&gt;net_pinfo.af_inet6.hop_limit
op_assign
op_minus
l_int|1
suffix:semicolon
id|sk-&gt;net_pinfo.af_inet6.mcast_hops
op_assign
op_minus
l_int|1
suffix:semicolon
id|sk-&gt;net_pinfo.af_inet6.mc_loop
op_assign
l_int|1
suffix:semicolon
id|sk-&gt;net_pinfo.af_inet6.pmtudisc
op_assign
id|IPV6_PMTUDISC_WANT
suffix:semicolon
multiline_comment|/* Init the ipv4 part of the socket since we can have sockets&n;&t; * using v6 API for ipv4.&n;&t; */
id|sk-&gt;protinfo.af_inet.ttl
op_assign
l_int|64
suffix:semicolon
id|sk-&gt;protinfo.af_inet.mc_loop
op_assign
l_int|1
suffix:semicolon
id|sk-&gt;protinfo.af_inet.mc_ttl
op_assign
l_int|1
suffix:semicolon
id|sk-&gt;protinfo.af_inet.mc_index
op_assign
l_int|0
suffix:semicolon
id|sk-&gt;protinfo.af_inet.mc_list
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
id|ipv4_config.no_pmtu_disc
)paren
id|sk-&gt;protinfo.af_inet.pmtudisc
op_assign
id|IP_PMTUDISC_DONT
suffix:semicolon
r_else
id|sk-&gt;protinfo.af_inet.pmtudisc
op_assign
id|IP_PMTUDISC_WANT
suffix:semicolon
macro_line|#ifdef INET_REFCNT_DEBUG
id|atomic_inc
c_func
(paren
op_amp
id|inet6_sock_nr
)paren
suffix:semicolon
id|atomic_inc
c_func
(paren
op_amp
id|inet_sock_nr
)paren
suffix:semicolon
macro_line|#endif
id|MOD_INC_USE_COUNT
suffix:semicolon
r_if
c_cond
(paren
id|sk-&gt;type
op_eq
id|SOCK_RAW
op_logical_and
id|protocol
op_eq
id|IPPROTO_RAW
)paren
id|sk-&gt;protinfo.af_inet.hdrincl
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|sk-&gt;num
)paren
(brace
multiline_comment|/* It assumes that any protocol which allows&n;&t;&t; * the user to assign a number at socket&n;&t;&t; * creation time automatically shares.&n;&t;&t; */
id|sk-&gt;sport
op_assign
id|ntohs
c_func
(paren
id|sk-&gt;num
)paren
suffix:semicolon
id|sk-&gt;prot
op_member_access_from_pointer
id|hash
c_func
(paren
id|sk
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|sk-&gt;prot-&gt;init
)paren
(brace
r_int
id|err
op_assign
id|sk-&gt;prot
op_member_access_from_pointer
id|init
c_func
(paren
id|sk
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
op_ne
l_int|0
)paren
(brace
id|MOD_DEC_USE_COUNT
suffix:semicolon
id|inet_sock_release
c_func
(paren
id|sk
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
)brace
r_return
l_int|0
suffix:semicolon
id|free_and_badtype
suffix:colon
id|sk_free
c_func
(paren
id|sk
)paren
suffix:semicolon
r_return
op_minus
id|ESOCKTNOSUPPORT
suffix:semicolon
id|free_and_badperm
suffix:colon
id|sk_free
c_func
(paren
id|sk
)paren
suffix:semicolon
r_return
op_minus
id|EPERM
suffix:semicolon
id|free_and_noproto
suffix:colon
id|sk_free
c_func
(paren
id|sk
)paren
suffix:semicolon
r_return
op_minus
id|EPROTONOSUPPORT
suffix:semicolon
id|do_oom
suffix:colon
r_return
op_minus
id|ENOBUFS
suffix:semicolon
)brace
multiline_comment|/* bind for INET6 API */
DECL|function|inet6_bind
r_static
r_int
id|inet6_bind
c_func
(paren
r_struct
id|socket
op_star
id|sock
comma
r_struct
id|sockaddr
op_star
id|uaddr
comma
r_int
id|addr_len
)paren
(brace
r_struct
id|sockaddr_in6
op_star
id|addr
op_assign
(paren
r_struct
id|sockaddr_in6
op_star
)paren
id|uaddr
suffix:semicolon
r_struct
id|sock
op_star
id|sk
op_assign
id|sock-&gt;sk
suffix:semicolon
id|__u32
id|v4addr
op_assign
l_int|0
suffix:semicolon
r_int
r_int
id|snum
suffix:semicolon
r_int
id|addr_type
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* If the socket has its own bind function then use it. */
r_if
c_cond
(paren
id|sk-&gt;prot-&gt;bind
)paren
(brace
r_return
id|sk-&gt;prot
op_member_access_from_pointer
id|bind
c_func
(paren
id|sk
comma
id|uaddr
comma
id|addr_len
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|addr_len
OL
id|SIN6_LEN_RFC2133
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|addr_type
op_assign
id|ipv6_addr_type
c_func
(paren
op_amp
id|addr-&gt;sin6_addr
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|addr_type
op_amp
id|IPV6_ADDR_MULTICAST
)paren
op_logical_and
id|sock-&gt;type
op_eq
id|SOCK_STREAM
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
multiline_comment|/* Check if the address belongs to the host. */
r_if
c_cond
(paren
id|addr_type
op_eq
id|IPV6_ADDR_MAPPED
)paren
(brace
id|v4addr
op_assign
id|addr-&gt;sin6_addr.s6_addr32
(braket
l_int|3
)braket
suffix:semicolon
r_if
c_cond
(paren
id|inet_addr_type
c_func
(paren
id|v4addr
)paren
op_ne
id|RTN_LOCAL
)paren
r_return
op_minus
id|EADDRNOTAVAIL
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|addr_type
op_ne
id|IPV6_ADDR_ANY
)paren
(brace
multiline_comment|/* ipv4 addr of the socket is invalid.  Only the&n;&t;&t;&t; * unpecified and mapped address have a v4 equivalent.&n;&t;&t;&t; */
id|v4addr
op_assign
id|LOOPBACK4_IPV6
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|addr_type
op_amp
id|IPV6_ADDR_MULTICAST
)paren
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|ipv6_chk_addr
c_func
(paren
op_amp
id|addr-&gt;sin6_addr
comma
l_int|NULL
)paren
)paren
r_return
op_minus
id|EADDRNOTAVAIL
suffix:semicolon
)brace
)brace
)brace
id|snum
op_assign
id|ntohs
c_func
(paren
id|addr-&gt;sin6_port
)paren
suffix:semicolon
r_if
c_cond
(paren
id|snum
op_logical_and
id|snum
OL
id|PROT_SOCK
op_logical_and
op_logical_neg
id|capable
c_func
(paren
id|CAP_NET_BIND_SERVICE
)paren
)paren
r_return
op_minus
id|EACCES
suffix:semicolon
id|lock_sock
c_func
(paren
id|sk
)paren
suffix:semicolon
multiline_comment|/* Check these errors (active socket, double bind). */
r_if
c_cond
(paren
(paren
id|sk-&gt;state
op_ne
id|TCP_CLOSE
)paren
op_logical_or
(paren
id|sk-&gt;num
op_ne
l_int|0
)paren
)paren
(brace
id|release_sock
c_func
(paren
id|sk
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|addr_type
op_amp
id|IPV6_ADDR_LINKLOCAL
)paren
(brace
r_if
c_cond
(paren
id|addr_len
op_ge
r_sizeof
(paren
r_struct
id|sockaddr_in6
)paren
op_logical_and
id|addr-&gt;sin6_scope_id
)paren
(brace
multiline_comment|/* Override any existing binding, if another one&n;&t;&t;&t; * is supplied by user.&n;&t;&t;&t; */
id|sk-&gt;bound_dev_if
op_assign
id|addr-&gt;sin6_scope_id
suffix:semicolon
)brace
multiline_comment|/* Binding to link-local address requires an interface */
r_if
c_cond
(paren
id|sk-&gt;bound_dev_if
op_eq
l_int|0
)paren
(brace
id|release_sock
c_func
(paren
id|sk
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
)brace
id|sk-&gt;rcv_saddr
op_assign
id|v4addr
suffix:semicolon
id|sk-&gt;saddr
op_assign
id|v4addr
suffix:semicolon
id|ipv6_addr_copy
c_func
(paren
op_amp
id|sk-&gt;net_pinfo.af_inet6.rcv_saddr
comma
op_amp
id|addr-&gt;sin6_addr
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|addr_type
op_amp
id|IPV6_ADDR_MULTICAST
)paren
)paren
id|ipv6_addr_copy
c_func
(paren
op_amp
id|sk-&gt;net_pinfo.af_inet6.saddr
comma
op_amp
id|addr-&gt;sin6_addr
)paren
suffix:semicolon
multiline_comment|/* Make sure we are allowed to bind here. */
r_if
c_cond
(paren
id|sk-&gt;prot
op_member_access_from_pointer
id|get_port
c_func
(paren
id|sk
comma
id|snum
)paren
op_ne
l_int|0
)paren
(brace
id|sk-&gt;rcv_saddr
op_assign
l_int|0
suffix:semicolon
id|sk-&gt;saddr
op_assign
l_int|0
suffix:semicolon
id|memset
c_func
(paren
op_amp
id|sk-&gt;net_pinfo.af_inet6.rcv_saddr
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|in6_addr
)paren
)paren
suffix:semicolon
id|memset
c_func
(paren
op_amp
id|sk-&gt;net_pinfo.af_inet6.saddr
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|in6_addr
)paren
)paren
suffix:semicolon
id|release_sock
c_func
(paren
id|sk
)paren
suffix:semicolon
r_return
op_minus
id|EADDRINUSE
suffix:semicolon
)brace
r_if
c_cond
(paren
id|addr_type
op_ne
id|IPV6_ADDR_ANY
)paren
id|sk-&gt;userlocks
op_or_assign
id|SOCK_BINDADDR_LOCK
suffix:semicolon
r_if
c_cond
(paren
id|snum
)paren
id|sk-&gt;userlocks
op_or_assign
id|SOCK_BINDPORT_LOCK
suffix:semicolon
id|sk-&gt;sport
op_assign
id|ntohs
c_func
(paren
id|sk-&gt;num
)paren
suffix:semicolon
id|sk-&gt;dport
op_assign
l_int|0
suffix:semicolon
id|sk-&gt;daddr
op_assign
l_int|0
suffix:semicolon
id|release_sock
c_func
(paren
id|sk
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|inet6_release
r_static
r_int
id|inet6_release
c_func
(paren
r_struct
id|socket
op_star
id|sock
)paren
(brace
r_struct
id|sock
op_star
id|sk
op_assign
id|sock-&gt;sk
suffix:semicolon
r_if
c_cond
(paren
id|sk
op_eq
l_int|NULL
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
multiline_comment|/* Free mc lists */
id|ipv6_sock_mc_close
c_func
(paren
id|sk
)paren
suffix:semicolon
r_return
id|inet_release
c_func
(paren
id|sock
)paren
suffix:semicolon
)brace
DECL|function|inet6_destroy_sock
r_int
id|inet6_destroy_sock
c_func
(paren
r_struct
id|sock
op_star
id|sk
)paren
(brace
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
r_struct
id|ipv6_txoptions
op_star
id|opt
suffix:semicolon
multiline_comment|/*&n;&t; *&t;Release destination entry&n;&t; */
id|sk_dst_reset
c_func
(paren
id|sk
)paren
suffix:semicolon
multiline_comment|/* Release rx options */
r_if
c_cond
(paren
(paren
id|skb
op_assign
id|xchg
c_func
(paren
op_amp
id|sk-&gt;net_pinfo.af_inet6.pktoptions
comma
l_int|NULL
)paren
)paren
op_ne
l_int|NULL
)paren
id|kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
multiline_comment|/* Free flowlabels */
id|fl6_free_socklist
c_func
(paren
id|sk
)paren
suffix:semicolon
multiline_comment|/* Free tx options */
r_if
c_cond
(paren
(paren
id|opt
op_assign
id|xchg
c_func
(paren
op_amp
id|sk-&gt;net_pinfo.af_inet6.opt
comma
l_int|NULL
)paren
)paren
op_ne
l_int|NULL
)paren
id|sock_kfree_s
c_func
(paren
id|sk
comma
id|opt
comma
id|opt-&gt;tot_len
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;This does both peername and sockname.&n; */
DECL|function|inet6_getname
r_static
r_int
id|inet6_getname
c_func
(paren
r_struct
id|socket
op_star
id|sock
comma
r_struct
id|sockaddr
op_star
id|uaddr
comma
r_int
op_star
id|uaddr_len
comma
r_int
id|peer
)paren
(brace
r_struct
id|sockaddr_in6
op_star
id|sin
op_assign
(paren
r_struct
id|sockaddr_in6
op_star
)paren
id|uaddr
suffix:semicolon
r_struct
id|sock
op_star
id|sk
op_assign
id|sock-&gt;sk
suffix:semicolon
id|sin-&gt;sin6_family
op_assign
id|AF_INET6
suffix:semicolon
id|sin-&gt;sin6_flowinfo
op_assign
l_int|0
suffix:semicolon
id|sin-&gt;sin6_scope_id
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|peer
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|sk-&gt;dport
)paren
r_return
op_minus
id|ENOTCONN
suffix:semicolon
r_if
c_cond
(paren
(paren
(paren
l_int|1
op_lshift
id|sk-&gt;state
)paren
op_amp
(paren
id|TCPF_CLOSE
op_or
id|TCPF_SYN_SENT
)paren
)paren
op_logical_and
id|peer
op_eq
l_int|1
)paren
r_return
op_minus
id|ENOTCONN
suffix:semicolon
id|sin-&gt;sin6_port
op_assign
id|sk-&gt;dport
suffix:semicolon
id|memcpy
c_func
(paren
op_amp
id|sin-&gt;sin6_addr
comma
op_amp
id|sk-&gt;net_pinfo.af_inet6.daddr
comma
r_sizeof
(paren
r_struct
id|in6_addr
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sk-&gt;net_pinfo.af_inet6.sndflow
)paren
id|sin-&gt;sin6_flowinfo
op_assign
id|sk-&gt;net_pinfo.af_inet6.flow_label
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|ipv6_addr_type
c_func
(paren
op_amp
id|sk-&gt;net_pinfo.af_inet6.rcv_saddr
)paren
op_eq
id|IPV6_ADDR_ANY
)paren
id|memcpy
c_func
(paren
op_amp
id|sin-&gt;sin6_addr
comma
op_amp
id|sk-&gt;net_pinfo.af_inet6.saddr
comma
r_sizeof
(paren
r_struct
id|in6_addr
)paren
)paren
suffix:semicolon
r_else
id|memcpy
c_func
(paren
op_amp
id|sin-&gt;sin6_addr
comma
op_amp
id|sk-&gt;net_pinfo.af_inet6.rcv_saddr
comma
r_sizeof
(paren
r_struct
id|in6_addr
)paren
)paren
suffix:semicolon
id|sin-&gt;sin6_port
op_assign
id|sk-&gt;sport
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ipv6_addr_type
c_func
(paren
op_amp
id|sin-&gt;sin6_addr
)paren
op_amp
id|IPV6_ADDR_LINKLOCAL
)paren
id|sin-&gt;sin6_scope_id
op_assign
id|sk-&gt;bound_dev_if
suffix:semicolon
op_star
id|uaddr_len
op_assign
r_sizeof
(paren
op_star
id|sin
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|inet6_ioctl
r_static
r_int
id|inet6_ioctl
c_func
(paren
r_struct
id|socket
op_star
id|sock
comma
r_int
r_int
id|cmd
comma
r_int
r_int
id|arg
)paren
(brace
r_struct
id|sock
op_star
id|sk
op_assign
id|sock-&gt;sk
suffix:semicolon
r_int
id|err
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_int
id|pid
suffix:semicolon
r_switch
c_cond
(paren
id|cmd
)paren
(brace
r_case
id|FIOSETOWN
suffix:colon
r_case
id|SIOCSPGRP
suffix:colon
r_if
c_cond
(paren
id|get_user
c_func
(paren
id|pid
comma
(paren
r_int
op_star
)paren
id|arg
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
multiline_comment|/* see sock_no_fcntl */
r_if
c_cond
(paren
id|current-&gt;pid
op_ne
id|pid
op_logical_and
id|current-&gt;pgrp
op_ne
op_minus
id|pid
op_logical_and
op_logical_neg
id|capable
c_func
(paren
id|CAP_NET_ADMIN
)paren
)paren
r_return
op_minus
id|EPERM
suffix:semicolon
id|sk-&gt;proc
op_assign
id|pid
suffix:semicolon
r_return
l_int|0
suffix:semicolon
r_case
id|FIOGETOWN
suffix:colon
r_case
id|SIOCGPGRP
suffix:colon
r_return
id|put_user
c_func
(paren
id|sk-&gt;proc
comma
(paren
r_int
op_star
)paren
id|arg
)paren
suffix:semicolon
r_case
id|SIOCGSTAMP
suffix:colon
r_if
c_cond
(paren
id|sk-&gt;stamp.tv_sec
op_eq
l_int|0
)paren
(brace
r_return
op_minus
id|ENOENT
suffix:semicolon
)brace
id|err
op_assign
id|copy_to_user
c_func
(paren
(paren
r_void
op_star
)paren
id|arg
comma
op_amp
id|sk-&gt;stamp
comma
r_sizeof
(paren
r_struct
id|timeval
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
r_case
id|SIOCADDRT
suffix:colon
r_case
id|SIOCDELRT
suffix:colon
r_return
id|ipv6_route_ioctl
c_func
(paren
id|cmd
comma
(paren
r_void
op_star
)paren
id|arg
)paren
suffix:semicolon
r_case
id|SIOCSIFADDR
suffix:colon
r_return
id|addrconf_add_ifaddr
c_func
(paren
(paren
r_void
op_star
)paren
id|arg
)paren
suffix:semicolon
r_case
id|SIOCDIFADDR
suffix:colon
r_return
id|addrconf_del_ifaddr
c_func
(paren
(paren
r_void
op_star
)paren
id|arg
)paren
suffix:semicolon
r_case
id|SIOCSIFDSTADDR
suffix:colon
r_return
id|addrconf_set_dstaddr
c_func
(paren
(paren
r_void
op_star
)paren
id|arg
)paren
suffix:semicolon
r_default
suffix:colon
(brace
)brace
r_if
c_cond
(paren
(paren
id|cmd
op_ge
id|SIOCDEVPRIVATE
)paren
op_logical_and
(paren
id|cmd
op_le
(paren
id|SIOCDEVPRIVATE
op_plus
l_int|15
)paren
)paren
)paren
r_return
id|dev_ioctl
c_func
(paren
id|cmd
comma
(paren
r_void
op_star
)paren
id|arg
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sk-&gt;prot-&gt;ioctl
op_eq
l_int|0
op_logical_or
(paren
id|err
op_assign
id|sk-&gt;prot
op_member_access_from_pointer
id|ioctl
c_func
(paren
id|sk
comma
id|cmd
comma
id|arg
)paren
)paren
op_eq
op_minus
id|ENOIOCTLCMD
)paren
(brace
r_return
id|dev_ioctl
c_func
(paren
id|cmd
comma
(paren
r_void
op_star
)paren
id|arg
)paren
suffix:semicolon
)brace
r_return
id|err
suffix:semicolon
)brace
multiline_comment|/*NOTREACHED*/
r_return
l_int|0
suffix:semicolon
)brace
DECL|variable|inet6_stream_ops
r_struct
id|proto_ops
id|inet6_stream_ops
op_assign
(brace
id|family
suffix:colon
id|PF_INET6
comma
id|release
suffix:colon
id|inet6_release
comma
id|bind
suffix:colon
id|inet6_bind
comma
id|connect
suffix:colon
id|inet_stream_connect
comma
multiline_comment|/* ok&t;&t;*/
id|socketpair
suffix:colon
id|sock_no_socketpair
comma
multiline_comment|/* a do nothing&t;*/
id|accept
suffix:colon
id|inet_accept
comma
multiline_comment|/* ok&t;&t;*/
id|getname
suffix:colon
id|inet6_getname
comma
id|poll
suffix:colon
id|tcp_poll
comma
multiline_comment|/* ok&t;&t;*/
id|ioctl
suffix:colon
id|inet6_ioctl
comma
multiline_comment|/* must change  */
id|listen
suffix:colon
id|inet_listen
comma
multiline_comment|/* ok&t;&t;*/
id|shutdown
suffix:colon
id|inet_shutdown
comma
multiline_comment|/* ok&t;&t;*/
id|setsockopt
suffix:colon
id|inet_setsockopt
comma
multiline_comment|/* ok&t;&t;*/
id|getsockopt
suffix:colon
id|inet_getsockopt
comma
multiline_comment|/* ok&t;&t;*/
id|sendmsg
suffix:colon
id|inet_sendmsg
comma
multiline_comment|/* ok&t;&t;*/
id|recvmsg
suffix:colon
id|inet_recvmsg
comma
multiline_comment|/* ok&t;&t;*/
id|mmap
suffix:colon
id|sock_no_mmap
comma
)brace
suffix:semicolon
DECL|variable|inet6_dgram_ops
r_struct
id|proto_ops
id|inet6_dgram_ops
op_assign
(brace
id|family
suffix:colon
id|PF_INET6
comma
id|release
suffix:colon
id|inet6_release
comma
id|bind
suffix:colon
id|inet6_bind
comma
id|connect
suffix:colon
id|inet_dgram_connect
comma
multiline_comment|/* ok&t;&t;*/
id|socketpair
suffix:colon
id|sock_no_socketpair
comma
multiline_comment|/* a do nothing&t;*/
id|accept
suffix:colon
id|sock_no_accept
comma
multiline_comment|/* a do nothing&t;*/
id|getname
suffix:colon
id|inet6_getname
comma
id|poll
suffix:colon
id|datagram_poll
comma
multiline_comment|/* ok&t;&t;*/
id|ioctl
suffix:colon
id|inet6_ioctl
comma
multiline_comment|/* must change  */
id|listen
suffix:colon
id|sock_no_listen
comma
multiline_comment|/* ok&t;&t;*/
id|shutdown
suffix:colon
id|inet_shutdown
comma
multiline_comment|/* ok&t;&t;*/
id|setsockopt
suffix:colon
id|inet_setsockopt
comma
multiline_comment|/* ok&t;&t;*/
id|getsockopt
suffix:colon
id|inet_getsockopt
comma
multiline_comment|/* ok&t;&t;*/
id|sendmsg
suffix:colon
id|inet_sendmsg
comma
multiline_comment|/* ok&t;&t;*/
id|recvmsg
suffix:colon
id|inet_recvmsg
comma
multiline_comment|/* ok&t;&t;*/
id|mmap
suffix:colon
id|sock_no_mmap
comma
)brace
suffix:semicolon
DECL|variable|inet6_family_ops
r_struct
id|net_proto_family
id|inet6_family_ops
op_assign
(brace
id|PF_INET6
comma
id|inet6_create
)brace
suffix:semicolon
macro_line|#ifdef MODULE
DECL|function|ipv6_unload
r_int
id|ipv6_unload
c_func
(paren
r_void
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|unloadable
)paren
r_return
l_int|1
suffix:semicolon
multiline_comment|/* We keep internally 3 raw sockets */
r_return
id|atomic_read
c_func
(paren
op_amp
(paren
id|__this_module.uc.usecount
)paren
)paren
op_minus
l_int|3
suffix:semicolon
)brace
macro_line|#endif
macro_line|#if defined(MODULE) &amp;&amp; defined(CONFIG_SYSCTL)
r_extern
r_void
id|ipv6_sysctl_register
c_func
(paren
r_void
)paren
suffix:semicolon
r_extern
r_void
id|ipv6_sysctl_unregister
c_func
(paren
r_void
)paren
suffix:semicolon
macro_line|#endif
DECL|function|inet6_init
r_static
r_int
id|__init
id|inet6_init
c_func
(paren
r_void
)paren
(brace
r_struct
id|sk_buff
op_star
id|dummy_skb
suffix:semicolon
r_int
id|err
suffix:semicolon
macro_line|#ifdef MODULE
r_if
c_cond
(paren
op_logical_neg
id|mod_member_present
c_func
(paren
op_amp
id|__this_module
comma
id|can_unload
)paren
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|__this_module.can_unload
op_assign
op_amp
id|ipv6_unload
suffix:semicolon
macro_line|#endif
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;IPv6 v0.8 for NET4.0&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
r_sizeof
(paren
r_struct
id|inet6_skb_parm
)paren
OG
r_sizeof
(paren
id|dummy_skb-&gt;cb
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_CRIT
l_string|&quot;inet6_proto_init: size fault&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
multiline_comment|/*&n;&t; *&t;ipngwg API draft makes clear that the correct semantics&n;&t; *&t;for TCP and UDP is to consider one TCP and UDP instance&n;&t; *&t;in a host availiable by both INET and INET6 APIs and&n;&t; *&t;able to communicate via both network protocols.&n;&t; */
macro_line|#if defined(MODULE) &amp;&amp; defined(CONFIG_SYSCTL)
id|ipv6_sysctl_register
c_func
(paren
)paren
suffix:semicolon
macro_line|#endif
id|err
op_assign
id|icmpv6_init
c_func
(paren
op_amp
id|inet6_family_ops
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
r_goto
id|icmp_fail
suffix:semicolon
id|err
op_assign
id|ndisc_init
c_func
(paren
op_amp
id|inet6_family_ops
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
r_goto
id|ndisc_fail
suffix:semicolon
id|err
op_assign
id|igmp6_init
c_func
(paren
op_amp
id|inet6_family_ops
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
r_goto
id|igmp_fail
suffix:semicolon
multiline_comment|/* Create /proc/foo6 entries. */
macro_line|#ifdef CONFIG_PROC_FS
id|err
op_assign
op_minus
id|ENOMEM
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|proc_net_create
c_func
(paren
l_string|&quot;raw6&quot;
comma
l_int|0
comma
id|raw6_get_info
)paren
)paren
r_goto
id|proc_raw6_fail
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|proc_net_create
c_func
(paren
l_string|&quot;tcp6&quot;
comma
l_int|0
comma
id|tcp6_get_info
)paren
)paren
r_goto
id|proc_tcp6_fail
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|proc_net_create
c_func
(paren
l_string|&quot;udp6&quot;
comma
l_int|0
comma
id|udp6_get_info
)paren
)paren
r_goto
id|proc_udp6_fail
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|proc_net_create
c_func
(paren
l_string|&quot;sockstat6&quot;
comma
l_int|0
comma
id|afinet6_get_info
)paren
)paren
r_goto
id|proc_sockstat6_fail
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|proc_net_create
c_func
(paren
l_string|&quot;snmp6&quot;
comma
l_int|0
comma
id|afinet6_get_snmp
)paren
)paren
r_goto
id|proc_snmp6_fail
suffix:semicolon
macro_line|#endif
id|ipv6_netdev_notif_init
c_func
(paren
)paren
suffix:semicolon
id|ipv6_packet_init
c_func
(paren
)paren
suffix:semicolon
id|ip6_route_init
c_func
(paren
)paren
suffix:semicolon
id|ip6_flowlabel_init
c_func
(paren
)paren
suffix:semicolon
id|addrconf_init
c_func
(paren
)paren
suffix:semicolon
id|sit_init
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* Init v6 transport protocols. */
id|udpv6_init
c_func
(paren
)paren
suffix:semicolon
id|tcpv6_init
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* Now the userspace is allowed to create INET6 sockets. */
(paren
r_void
)paren
id|sock_register
c_func
(paren
op_amp
id|inet6_family_ops
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
macro_line|#ifdef CONFIG_PROC_FS
id|proc_snmp6_fail
suffix:colon
id|proc_net_remove
c_func
(paren
l_string|&quot;sockstat6&quot;
)paren
suffix:semicolon
id|proc_sockstat6_fail
suffix:colon
id|proc_net_remove
c_func
(paren
l_string|&quot;udp6&quot;
)paren
suffix:semicolon
id|proc_udp6_fail
suffix:colon
id|proc_net_remove
c_func
(paren
l_string|&quot;tcp6&quot;
)paren
suffix:semicolon
id|proc_tcp6_fail
suffix:colon
id|proc_net_remove
c_func
(paren
l_string|&quot;raw6&quot;
)paren
suffix:semicolon
id|proc_raw6_fail
suffix:colon
id|igmp6_cleanup
c_func
(paren
)paren
suffix:semicolon
macro_line|#endif
id|igmp_fail
suffix:colon
id|ndisc_cleanup
c_func
(paren
)paren
suffix:semicolon
id|ndisc_fail
suffix:colon
id|icmpv6_cleanup
c_func
(paren
)paren
suffix:semicolon
id|icmp_fail
suffix:colon
macro_line|#if defined(MODULE) &amp;&amp; defined(CONFIG_SYSCTL)
id|ipv6_sysctl_unregister
c_func
(paren
)paren
suffix:semicolon
macro_line|#endif
r_return
id|err
suffix:semicolon
)brace
DECL|variable|inet6_init
id|module_init
c_func
(paren
id|inet6_init
)paren
suffix:semicolon
macro_line|#ifdef MODULE
DECL|function|inet6_exit
r_static
r_void
id|inet6_exit
c_func
(paren
r_void
)paren
(brace
multiline_comment|/* First of all disallow new sockets creation. */
id|sock_unregister
c_func
(paren
id|PF_INET6
)paren
suffix:semicolon
macro_line|#ifdef CONFIG_PROC_FS
id|proc_net_remove
c_func
(paren
l_string|&quot;raw6&quot;
)paren
suffix:semicolon
id|proc_net_remove
c_func
(paren
l_string|&quot;tcp6&quot;
)paren
suffix:semicolon
id|proc_net_remove
c_func
(paren
l_string|&quot;udp6&quot;
)paren
suffix:semicolon
id|proc_net_remove
c_func
(paren
l_string|&quot;sockstat6&quot;
)paren
suffix:semicolon
id|proc_net_remove
c_func
(paren
l_string|&quot;snmp6&quot;
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/* Cleanup code parts. */
id|sit_cleanup
c_func
(paren
)paren
suffix:semicolon
id|ipv6_netdev_notif_cleanup
c_func
(paren
)paren
suffix:semicolon
id|ip6_flowlabel_cleanup
c_func
(paren
)paren
suffix:semicolon
id|addrconf_cleanup
c_func
(paren
)paren
suffix:semicolon
id|ip6_route_cleanup
c_func
(paren
)paren
suffix:semicolon
id|ipv6_packet_cleanup
c_func
(paren
)paren
suffix:semicolon
id|igmp6_cleanup
c_func
(paren
)paren
suffix:semicolon
id|ndisc_cleanup
c_func
(paren
)paren
suffix:semicolon
id|icmpv6_cleanup
c_func
(paren
)paren
suffix:semicolon
macro_line|#ifdef CONFIG_SYSCTL
id|ipv6_sysctl_unregister
c_func
(paren
)paren
suffix:semicolon
macro_line|#endif
)brace
DECL|variable|inet6_exit
id|module_exit
c_func
(paren
id|inet6_exit
)paren
suffix:semicolon
macro_line|#endif /* MODULE */
eof
