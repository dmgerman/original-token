multiline_comment|/*&n; *&t;AF_INET6 socket family&n; *&t;Linux INET6 implementation &n; *&n; *&t;Authors:&n; *&t;Pedro Roque&t;&t;&lt;roque@di.fc.ul.pt&gt;&t;&n; *&n; *&t;Adapted from linux/net/ipv4/af_inet.c&n; *&n; *&t;$Id: af_inet6.c,v 1.8 1997/01/26 07:14:56 davem Exp $&n; *&n; *&t;This program is free software; you can redistribute it and/or&n; *      modify it under the terms of the GNU General Public License&n; *      as published by the Free Software Foundation; either version&n; *      2 of the License, or (at your option) any later version.&n; */
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/socket.h&gt;
macro_line|#include &lt;linux/in.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/major.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/timer.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/sockios.h&gt;
macro_line|#include &lt;linux/net.h&gt;
macro_line|#include &lt;linux/fcntl.h&gt;
macro_line|#include &lt;linux/mm.h&gt;
macro_line|#include &lt;linux/interrupt.h&gt;
macro_line|#include &lt;linux/proc_fs.h&gt;
macro_line|#include &lt;linux/stat.h&gt;
macro_line|#include &lt;asm/uaccess.h&gt;
macro_line|#include &lt;asm/system.h&gt;
macro_line|#include &lt;linux/inet.h&gt;
macro_line|#include &lt;linux/netdevice.h&gt;
macro_line|#include &lt;net/ip.h&gt;
macro_line|#include &lt;net/ipv6.h&gt;
macro_line|#include &lt;net/protocol.h&gt;
macro_line|#include &lt;net/arp.h&gt;
macro_line|#include &lt;net/rarp.h&gt;
macro_line|#include &lt;net/route.h&gt;
macro_line|#include &lt;net/tcp.h&gt;
macro_line|#include &lt;net/udp.h&gt;
macro_line|#include &lt;linux/skbuff.h&gt;
macro_line|#include &lt;net/sock.h&gt;
macro_line|#include &lt;net/raw.h&gt;
macro_line|#include &lt;net/icmp.h&gt;
macro_line|#include &lt;linux/icmpv6.h&gt;
macro_line|#include &lt;net/inet_common.h&gt;
macro_line|#include &lt;net/transp_v6.h&gt;
macro_line|#include &lt;net/ndisc.h&gt;
macro_line|#include &lt;net/ipv6_route.h&gt;
macro_line|#include &lt;net/sit.h&gt;
macro_line|#include &lt;linux/ip_fw.h&gt;
macro_line|#include &lt;net/addrconf.h&gt;
DECL|variable|rawv6_sock_array
r_struct
id|sock
op_star
id|rawv6_sock_array
(braket
id|SOCK_ARRAY_SIZE
)braket
suffix:semicolon
r_extern
r_struct
id|proto_ops
id|inet6_stream_ops
suffix:semicolon
r_extern
r_struct
id|proto_ops
id|inet6_dgram_ops
suffix:semicolon
DECL|function|inet6_create
r_static
r_int
id|inet6_create
c_func
(paren
r_struct
id|socket
op_star
id|sock
comma
r_int
id|protocol
)paren
(brace
r_struct
id|sock
op_star
id|sk
suffix:semicolon
r_struct
id|proto
op_star
id|prot
suffix:semicolon
r_int
id|err
suffix:semicolon
id|sk
op_assign
id|sk_alloc
c_func
(paren
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sk
op_eq
l_int|NULL
)paren
r_return
op_minus
id|ENOBUFS
suffix:semicolon
multiline_comment|/*&n;&t; *&t;Note for tcp that also wiped the dummy_th block for us.&n;&t; */
r_switch
c_cond
(paren
id|sock-&gt;type
)paren
(brace
r_case
id|SOCK_STREAM
suffix:colon
r_case
id|SOCK_SEQPACKET
suffix:colon
r_if
c_cond
(paren
id|protocol
op_logical_and
id|protocol
op_ne
id|IPPROTO_TCP
)paren
(brace
id|sk_free
c_func
(paren
id|sk
)paren
suffix:semicolon
r_return
op_minus
id|EPROTONOSUPPORT
suffix:semicolon
)brace
id|protocol
op_assign
id|IPPROTO_TCP
suffix:semicolon
id|sk-&gt;no_check
op_assign
id|TCP_NO_CHECK
suffix:semicolon
id|prot
op_assign
op_amp
id|tcpv6_prot
suffix:semicolon
id|sock-&gt;ops
op_assign
op_amp
id|inet6_stream_ops
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SOCK_DGRAM
suffix:colon
r_if
c_cond
(paren
id|protocol
op_logical_and
id|protocol
op_ne
id|IPPROTO_UDP
)paren
(brace
id|sk_free
c_func
(paren
id|sk
)paren
suffix:semicolon
r_return
op_minus
id|EPROTONOSUPPORT
suffix:semicolon
)brace
id|protocol
op_assign
id|IPPROTO_UDP
suffix:semicolon
id|sk-&gt;no_check
op_assign
id|UDP_NO_CHECK
suffix:semicolon
id|prot
op_assign
op_amp
id|udpv6_prot
suffix:semicolon
id|sock-&gt;ops
op_assign
op_amp
id|inet6_dgram_ops
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SOCK_RAW
suffix:colon
r_if
c_cond
(paren
op_logical_neg
id|suser
c_func
(paren
)paren
)paren
(brace
id|sk_free
c_func
(paren
id|sk
)paren
suffix:semicolon
r_return
op_minus
id|EPERM
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|protocol
)paren
(brace
id|sk_free
c_func
(paren
id|sk
)paren
suffix:semicolon
r_return
op_minus
id|EPROTONOSUPPORT
suffix:semicolon
)brace
id|prot
op_assign
op_amp
id|rawv6_prot
suffix:semicolon
id|sock-&gt;ops
op_assign
op_amp
id|inet6_dgram_ops
suffix:semicolon
id|sk-&gt;reuse
op_assign
l_int|1
suffix:semicolon
id|sk-&gt;num
op_assign
id|protocol
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|sk_free
c_func
(paren
id|sk
)paren
suffix:semicolon
r_return
op_minus
id|ESOCKTNOSUPPORT
suffix:semicolon
)brace
id|sock_init_data
c_func
(paren
id|sock
comma
id|sk
)paren
suffix:semicolon
id|sk-&gt;zapped
op_assign
l_int|0
suffix:semicolon
id|sk-&gt;family
op_assign
id|AF_INET6
suffix:semicolon
id|sk-&gt;protocol
op_assign
id|protocol
suffix:semicolon
id|sk-&gt;prot
op_assign
id|prot
suffix:semicolon
id|sk-&gt;backlog_rcv
op_assign
id|prot-&gt;backlog_rcv
suffix:semicolon
id|sk-&gt;timer.data
op_assign
(paren
r_int
r_int
)paren
id|sk
suffix:semicolon
id|sk-&gt;timer.function
op_assign
op_amp
id|net_timer
suffix:semicolon
id|init_timer
c_func
(paren
op_amp
id|sk-&gt;timer
)paren
suffix:semicolon
id|sk-&gt;net_pinfo.af_inet6.hop_limit
op_assign
id|ipv6_hop_limit
suffix:semicolon
id|sk-&gt;net_pinfo.af_inet6.mcast_hops
op_assign
id|IPV6_DEFAULT_MCASTHOPS
suffix:semicolon
id|sk-&gt;net_pinfo.af_inet6.mc_loop
op_assign
l_int|1
suffix:semicolon
multiline_comment|/*&n;&t; *&t;init the ipv4 part of the socket since&n;&t; *&t;we can have sockets using v6 API for ipv4&n;&t; */
id|sk-&gt;ip_ttl
op_assign
l_int|64
suffix:semicolon
id|sk-&gt;ip_mc_loop
op_assign
l_int|1
suffix:semicolon
id|sk-&gt;ip_mc_ttl
op_assign
l_int|1
suffix:semicolon
id|sk-&gt;ip_mc_index
op_assign
l_int|0
suffix:semicolon
id|sk-&gt;ip_mc_list
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
id|sk-&gt;type
op_eq
id|SOCK_RAW
op_logical_and
id|protocol
op_eq
id|IPPROTO_RAW
)paren
id|sk-&gt;ip_hdrincl
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|sk-&gt;num
)paren
(brace
multiline_comment|/*&n;&t;&t; * It assumes that any protocol which allows&n;&t;&t; * the user to assign a number at socket&n;&t;&t; * creation time automatically&n;&t;&t; * shares.&n;&t;&t; */
id|inet_put_sock
c_func
(paren
id|sk-&gt;num
comma
id|sk
)paren
suffix:semicolon
id|sk-&gt;dummy_th.source
op_assign
id|ntohs
c_func
(paren
id|sk-&gt;num
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|sk-&gt;prot-&gt;init
)paren
(brace
id|err
op_assign
id|sk-&gt;prot
op_member_access_from_pointer
id|init
c_func
(paren
id|sk
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
op_ne
l_int|0
)paren
(brace
id|destroy_sock
c_func
(paren
id|sk
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
)brace
id|MOD_INC_USE_COUNT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|inet6_dup
r_static
r_int
id|inet6_dup
c_func
(paren
r_struct
id|socket
op_star
id|newsock
comma
r_struct
id|socket
op_star
id|oldsock
)paren
(brace
r_return
id|inet6_create
c_func
(paren
id|newsock
comma
id|oldsock-&gt;sk-&gt;protocol
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;bind for INET6 API&t;&n; */
DECL|function|inet6_bind
r_static
r_int
id|inet6_bind
c_func
(paren
r_struct
id|socket
op_star
id|sock
comma
r_struct
id|sockaddr
op_star
id|uaddr
comma
r_int
id|addr_len
)paren
(brace
r_struct
id|sockaddr_in6
op_star
id|addr
op_assign
(paren
r_struct
id|sockaddr_in6
op_star
)paren
id|uaddr
suffix:semicolon
r_struct
id|sock
op_star
id|sk
op_assign
id|sock-&gt;sk
comma
op_star
id|sk2
suffix:semicolon
id|__u32
id|v4addr
op_assign
l_int|0
suffix:semicolon
r_int
r_int
id|snum
op_assign
l_int|0
suffix:semicolon
r_int
id|addr_type
op_assign
l_int|0
suffix:semicolon
multiline_comment|/*&n;&t; *&t;If the socket has its own bind function then use it.&n;&t; */
r_if
c_cond
(paren
id|sk-&gt;prot-&gt;bind
)paren
(brace
r_return
id|sk-&gt;prot
op_member_access_from_pointer
id|bind
c_func
(paren
id|sk
comma
id|uaddr
comma
id|addr_len
)paren
suffix:semicolon
)brace
multiline_comment|/* check this error. */
r_if
c_cond
(paren
id|sk-&gt;state
op_ne
id|TCP_CLOSE
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|addr_len
OL
r_sizeof
(paren
r_struct
id|sockaddr_in6
)paren
)paren
(brace
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|sock-&gt;type
op_ne
id|SOCK_RAW
)paren
(brace
r_if
c_cond
(paren
id|sk-&gt;num
op_ne
l_int|0
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|snum
op_assign
id|ntohs
c_func
(paren
id|addr-&gt;sin6_port
)paren
suffix:semicolon
r_if
c_cond
(paren
id|snum
op_eq
l_int|0
)paren
id|snum
op_assign
id|get_new_socknum
c_func
(paren
id|sk-&gt;prot
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|snum
OL
id|PROT_SOCK
op_logical_and
op_logical_neg
id|suser
c_func
(paren
)paren
)paren
r_return
op_minus
id|EACCES
suffix:semicolon
)brace
id|addr_type
op_assign
id|ipv6_addr_type
c_func
(paren
op_amp
id|addr-&gt;sin6_addr
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|addr_type
op_amp
id|IPV6_ADDR_MULTICAST
)paren
op_logical_and
id|sock-&gt;type
op_eq
id|SOCK_STREAM
)paren
(brace
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
multiline_comment|/*&n;&t; *&t;check if the address belongs to the host&n;&t; */
r_if
c_cond
(paren
id|addr_type
op_eq
id|IPV6_ADDR_MAPPED
)paren
(brace
id|v4addr
op_assign
id|addr-&gt;sin6_addr.s6_addr32
(braket
l_int|3
)braket
suffix:semicolon
r_if
c_cond
(paren
id|__ip_chk_addr
c_func
(paren
id|v4addr
)paren
op_ne
id|IS_MYADDR
)paren
r_return
op_minus
id|EADDRNOTAVAIL
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|addr_type
op_ne
id|IPV6_ADDR_ANY
)paren
(brace
multiline_comment|/* &n;&t;&t;&t; *&t;ipv4 addr of the socket is invalid.&n;&t;&t;&t; *&t;only the unpecified and mapped address&t;&n;&t;&t;&t; *&t;have a v4 equivalent.&n;&t;&t;&t; */
id|v4addr
op_assign
id|LOOPBACK4_IPV6
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|addr_type
op_amp
id|IPV6_ADDR_MULTICAST
)paren
)paren
(brace
r_if
c_cond
(paren
id|ipv6_chk_addr
c_func
(paren
op_amp
id|addr-&gt;sin6_addr
)paren
op_eq
l_int|NULL
)paren
r_return
op_minus
id|EADDRNOTAVAIL
suffix:semicolon
)brace
)brace
)brace
id|sk-&gt;rcv_saddr
op_assign
id|v4addr
suffix:semicolon
id|sk-&gt;saddr
op_assign
id|v4addr
suffix:semicolon
id|memcpy
c_func
(paren
op_amp
id|sk-&gt;net_pinfo.af_inet6.rcv_saddr
comma
op_amp
id|addr-&gt;sin6_addr
comma
r_sizeof
(paren
r_struct
id|in6_addr
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|addr_type
op_amp
id|IPV6_ADDR_MULTICAST
)paren
)paren
id|memcpy
c_func
(paren
op_amp
id|sk-&gt;net_pinfo.af_inet6.saddr
comma
op_amp
id|addr-&gt;sin6_addr
comma
r_sizeof
(paren
r_struct
id|in6_addr
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sock-&gt;type
op_ne
id|SOCK_RAW
)paren
(brace
multiline_comment|/* Make sure we are allowed to bind here. */
id|cli
c_func
(paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|sk2
op_assign
id|sk-&gt;prot-&gt;sock_array
(braket
id|snum
op_amp
(paren
id|SOCK_ARRAY_SIZE
op_minus
l_int|1
)paren
)braket
suffix:semicolon
id|sk2
op_ne
l_int|NULL
suffix:semicolon
id|sk2
op_assign
id|sk2-&gt;next
)paren
(brace
multiline_comment|/*&n;&t;&t;&t; *&t;Hash collision or real match ?&n;&t;&t;&t; */
r_if
c_cond
(paren
id|sk2-&gt;num
op_ne
id|snum
)paren
r_continue
suffix:semicolon
multiline_comment|/*&n;&t;&t;&t; *&t;Either bind on the port is wildcard means&n;&t;&t;&t; *&t;they will overlap and thus be in error.&n;&t;&t;&t; *&t;We use the sk2 v4 address to test the &n;&t;&t;&t; *&t;other socket since addr_any in av4 implies&n;&t;&t;&t; *&t;addr_any in v6&n;&t;&t;&t; */
r_if
c_cond
(paren
id|addr_type
op_eq
id|IPV6_ADDR_ANY
op_logical_or
(paren
op_logical_neg
id|sk2-&gt;rcv_saddr
)paren
)paren
(brace
multiline_comment|/*&n;&t;&t;&t;&t; *&t;Allow only if both are setting reuse.&n;&t;&t;&t;&t; */
r_if
c_cond
(paren
id|sk2-&gt;reuse
op_logical_and
id|sk-&gt;reuse
op_logical_and
id|sk2-&gt;state
op_ne
id|TCP_LISTEN
)paren
(brace
r_continue
suffix:semicolon
)brace
id|sti
c_func
(paren
)paren
suffix:semicolon
r_return
op_minus
id|EADDRINUSE
suffix:semicolon
)brace
multiline_comment|/*&n;&t;&t;&t; *&t;Two binds match ?&n;&t;&t;&t; */
r_if
c_cond
(paren
id|ipv6_addr_cmp
c_func
(paren
op_amp
id|sk-&gt;net_pinfo.af_inet6.rcv_saddr
comma
op_amp
id|sk2-&gt;net_pinfo.af_inet6.rcv_saddr
)paren
)paren
r_continue
suffix:semicolon
multiline_comment|/*&n;&t;&t;&t; *&t;Reusable port ?&n;&t;&t;&t; */
r_if
c_cond
(paren
op_logical_neg
id|sk-&gt;reuse
)paren
(brace
id|sti
c_func
(paren
)paren
suffix:semicolon
r_return
op_minus
id|EADDRINUSE
suffix:semicolon
)brace
multiline_comment|/*&n;&t;&t;&t; *&t;Reuse ?&n;&t;&t;&t; */
r_if
c_cond
(paren
op_logical_neg
id|sk2-&gt;reuse
op_logical_or
id|sk2-&gt;state
op_eq
id|TCP_LISTEN
)paren
(brace
id|sti
c_func
(paren
)paren
suffix:semicolon
r_return
op_minus
id|EADDRINUSE
suffix:semicolon
)brace
)brace
id|sti
c_func
(paren
)paren
suffix:semicolon
id|inet_remove_sock
c_func
(paren
id|sk
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t;if(sock-&gt;type==SOCK_DGRAM)&n;&t;&t;&t;udp_cache_zap();&n;&t;&t;if(sock-&gt;type==SOCK_STREAM)&n;&t;&t;&t;tcp_cache_zap();&n;&t;&t;&t;*/
id|inet_put_sock
c_func
(paren
id|snum
comma
id|sk
)paren
suffix:semicolon
id|sk-&gt;dummy_th.source
op_assign
id|ntohs
c_func
(paren
id|sk-&gt;num
)paren
suffix:semicolon
id|sk-&gt;dummy_th.dest
op_assign
l_int|0
suffix:semicolon
id|sk-&gt;daddr
op_assign
l_int|0
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|inet6_release
r_static
r_int
id|inet6_release
c_func
(paren
r_struct
id|socket
op_star
id|sock
comma
r_struct
id|socket
op_star
id|peer
)paren
(brace
id|MOD_DEC_USE_COUNT
suffix:semicolon
r_return
id|inet_release
c_func
(paren
id|sock
comma
id|peer
)paren
suffix:semicolon
)brace
DECL|function|inet6_socketpair
r_static
r_int
id|inet6_socketpair
c_func
(paren
r_struct
id|socket
op_star
id|sock1
comma
r_struct
id|socket
op_star
id|sock2
)paren
(brace
r_return
op_minus
id|EOPNOTSUPP
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;This does both peername and sockname.&n; */
DECL|function|inet6_getname
r_static
r_int
id|inet6_getname
c_func
(paren
r_struct
id|socket
op_star
id|sock
comma
r_struct
id|sockaddr
op_star
id|uaddr
comma
r_int
op_star
id|uaddr_len
comma
r_int
id|peer
)paren
(brace
r_struct
id|sockaddr_in6
op_star
id|sin
op_assign
(paren
r_struct
id|sockaddr_in6
op_star
)paren
id|uaddr
suffix:semicolon
r_struct
id|sock
op_star
id|sk
suffix:semicolon
id|sin-&gt;sin6_family
op_assign
id|AF_INET6
suffix:semicolon
id|sk
op_assign
id|sock-&gt;sk
suffix:semicolon
r_if
c_cond
(paren
id|peer
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|tcp_connected
c_func
(paren
id|sk-&gt;state
)paren
)paren
r_return
op_minus
id|ENOTCONN
suffix:semicolon
id|sin-&gt;sin6_port
op_assign
id|sk-&gt;dummy_th.dest
suffix:semicolon
id|memcpy
c_func
(paren
op_amp
id|sin-&gt;sin6_addr
comma
op_amp
id|sk-&gt;net_pinfo.af_inet6.daddr
comma
r_sizeof
(paren
r_struct
id|in6_addr
)paren
)paren
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|ipv6_addr_type
c_func
(paren
op_amp
id|sk-&gt;net_pinfo.af_inet6.rcv_saddr
)paren
op_eq
id|IPV6_ADDR_ANY
)paren
id|memcpy
c_func
(paren
op_amp
id|sin-&gt;sin6_addr
comma
op_amp
id|sk-&gt;net_pinfo.af_inet6.saddr
comma
r_sizeof
(paren
r_struct
id|in6_addr
)paren
)paren
suffix:semicolon
r_else
id|memcpy
c_func
(paren
op_amp
id|sin-&gt;sin6_addr
comma
op_amp
id|sk-&gt;net_pinfo.af_inet6.rcv_saddr
comma
r_sizeof
(paren
r_struct
id|in6_addr
)paren
)paren
suffix:semicolon
id|sin-&gt;sin6_port
op_assign
id|sk-&gt;dummy_th.source
suffix:semicolon
)brace
op_star
id|uaddr_len
op_assign
r_sizeof
(paren
op_star
id|sin
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|inet6_ioctl
r_static
r_int
id|inet6_ioctl
c_func
(paren
r_struct
id|socket
op_star
id|sock
comma
r_int
r_int
id|cmd
comma
r_int
r_int
id|arg
)paren
(brace
r_struct
id|sock
op_star
id|sk
op_assign
id|sock-&gt;sk
suffix:semicolon
r_int
id|err
suffix:semicolon
r_int
id|pid
suffix:semicolon
r_switch
c_cond
(paren
id|cmd
)paren
(brace
r_case
id|FIOSETOWN
suffix:colon
r_case
id|SIOCSPGRP
suffix:colon
id|err
op_assign
id|get_user
c_func
(paren
id|pid
comma
(paren
r_int
op_star
)paren
id|arg
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
(brace
r_return
id|err
suffix:semicolon
)brace
multiline_comment|/* see sock_no_fcntl */
r_if
c_cond
(paren
id|current-&gt;pid
op_ne
id|pid
op_logical_and
id|current-&gt;pgrp
op_ne
op_minus
id|pid
op_logical_and
op_logical_neg
id|suser
c_func
(paren
)paren
)paren
r_return
op_minus
id|EPERM
suffix:semicolon
id|sk-&gt;proc
op_assign
id|pid
suffix:semicolon
r_return
l_int|0
suffix:semicolon
r_case
id|FIOGETOWN
suffix:colon
r_case
id|SIOCGPGRP
suffix:colon
id|err
op_assign
id|put_user
c_func
(paren
id|sk-&gt;proc
comma
(paren
r_int
op_star
)paren
id|arg
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
(brace
r_return
id|err
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
r_case
id|SIOCGSTAMP
suffix:colon
r_if
c_cond
(paren
id|sk-&gt;stamp.tv_sec
op_eq
l_int|0
)paren
(brace
r_return
op_minus
id|ENOENT
suffix:semicolon
)brace
id|err
op_assign
id|copy_to_user
c_func
(paren
(paren
r_void
op_star
)paren
id|arg
comma
op_amp
id|sk-&gt;stamp
comma
r_sizeof
(paren
r_struct
id|timeval
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
r_case
id|SIOCADDRT
suffix:colon
r_case
id|SIOCDELRT
suffix:colon
r_return
id|ipv6_route_ioctl
c_func
(paren
id|cmd
comma
(paren
r_void
op_star
)paren
id|arg
)paren
suffix:semicolon
r_case
id|SIOCGIFCONF
suffix:colon
r_case
id|SIOCGIFFLAGS
suffix:colon
r_case
id|SIOCSIFFLAGS
suffix:colon
r_case
id|SIOCADDMULTI
suffix:colon
r_case
id|SIOCDELMULTI
suffix:colon
multiline_comment|/*&n;&n;  this ioctls deal with addresses&n;  must process the addr info before&n;  calling dev_ioctl to perform dev specific functions&n;&n;&t;case SIOCGIFADDR:&n;&t;case SIOCSIFADDR:&n;&n;&n;&t;case SIOCGIFDSTADDR:&n;&n;&t;case SIOCGIFBRDADDR:&n;&t;case SIOCSIFBRDADDR:&n;&t;case SIOCGIFNETMASK:&n;&t;case SIOCSIFNETMASK:&n;&t;*/
r_case
id|SIOCGIFMETRIC
suffix:colon
r_case
id|SIOCSIFMETRIC
suffix:colon
r_case
id|SIOCGIFMEM
suffix:colon
r_case
id|SIOCSIFMEM
suffix:colon
r_case
id|SIOCGIFMTU
suffix:colon
r_case
id|SIOCSIFMTU
suffix:colon
r_case
id|SIOCSIFLINK
suffix:colon
r_case
id|SIOCGIFHWADDR
suffix:colon
r_case
id|SIOCSIFHWADDR
suffix:colon
r_case
id|SIOCSIFMAP
suffix:colon
r_case
id|SIOCGIFMAP
suffix:colon
r_case
id|SIOCSIFSLAVE
suffix:colon
r_case
id|SIOCGIFSLAVE
suffix:colon
r_case
id|SIOGIFINDEX
suffix:colon
r_return
id|dev_ioctl
c_func
(paren
id|cmd
comma
(paren
r_void
op_star
)paren
id|arg
)paren
suffix:semicolon
r_case
id|SIOCSIFADDR
suffix:colon
r_return
id|addrconf_add_ifaddr
c_func
(paren
(paren
r_void
op_star
)paren
id|arg
)paren
suffix:semicolon
r_case
id|SIOCSIFDSTADDR
suffix:colon
r_return
id|addrconf_set_dstaddr
c_func
(paren
(paren
r_void
op_star
)paren
id|arg
)paren
suffix:semicolon
r_default
suffix:colon
(brace
)brace
r_if
c_cond
(paren
(paren
id|cmd
op_ge
id|SIOCDEVPRIVATE
)paren
op_logical_and
(paren
id|cmd
op_le
(paren
id|SIOCDEVPRIVATE
op_plus
l_int|15
)paren
)paren
)paren
r_return
id|dev_ioctl
c_func
(paren
id|cmd
comma
(paren
r_void
op_star
)paren
id|arg
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sk-&gt;prot-&gt;ioctl
op_eq
l_int|NULL
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_return
id|sk-&gt;prot
op_member_access_from_pointer
id|ioctl
c_func
(paren
id|sk
comma
id|cmd
comma
id|arg
)paren
suffix:semicolon
)brace
multiline_comment|/*NOTREACHED*/
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * This routine must find a socket given a TCP or UDP header.&n; * Everything is assumed to be in net order.&n; *&n; * We give priority to more closely bound ports: if some socket&n; * is bound to a particular foreign address, it will get the packet&n; * rather than somebody listening to any address..&n; */
DECL|function|inet6_get_sock
r_struct
id|sock
op_star
id|inet6_get_sock
c_func
(paren
r_struct
id|proto
op_star
id|prot
comma
r_struct
id|in6_addr
op_star
id|loc_addr
comma
r_struct
id|in6_addr
op_star
id|rmt_addr
comma
r_int
r_int
id|loc_port
comma
r_int
r_int
id|rmt_port
)paren
(brace
r_struct
id|sock
op_star
id|s
suffix:semicolon
r_struct
id|sock
op_star
id|result
op_assign
l_int|NULL
suffix:semicolon
r_int
id|badness
op_assign
op_minus
l_int|1
suffix:semicolon
r_int
r_int
id|hnum
suffix:semicolon
r_struct
id|ipv6_pinfo
op_star
id|np
suffix:semicolon
id|hnum
op_assign
id|ntohs
c_func
(paren
id|loc_port
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * SOCK_ARRAY_SIZE must be a power of two.  This will work better&n;&t; * than a prime unless 3 or more sockets end up using the same&n;&t; * array entry.  This should not be a problem because most&n;&t; * well known sockets don&squot;t overlap that much, and for&n;&t; * the other ones, we can just be careful about picking our&n;&t; * socket number when we choose an arbitrary one.&n;&t; */
r_for
c_loop
(paren
id|s
op_assign
id|prot-&gt;sock_array
(braket
id|hnum
op_amp
(paren
id|SOCK_ARRAY_SIZE
op_minus
l_int|1
)paren
)braket
suffix:semicolon
id|s
op_ne
l_int|NULL
suffix:semicolon
id|s
op_assign
id|s-&gt;next
)paren
(brace
r_int
id|score
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
(paren
id|s-&gt;num
op_ne
id|hnum
)paren
op_logical_or
id|s-&gt;family
op_ne
id|AF_INET6
)paren
r_continue
suffix:semicolon
r_if
c_cond
(paren
id|s-&gt;dead
op_logical_and
(paren
id|s-&gt;state
op_eq
id|TCP_CLOSE
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;dead or closed socket&bslash;n&quot;
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
id|np
op_assign
op_amp
id|s-&gt;net_pinfo.af_inet6
suffix:semicolon
multiline_comment|/* remote port matches? */
r_if
c_cond
(paren
id|s-&gt;dummy_th.dest
)paren
(brace
r_if
c_cond
(paren
id|s-&gt;dummy_th.dest
op_ne
id|rmt_port
)paren
(brace
r_continue
suffix:semicolon
)brace
id|score
op_increment
suffix:semicolon
)brace
multiline_comment|/* local address matches? */
r_if
c_cond
(paren
op_logical_neg
id|ipv6_addr_any
c_func
(paren
op_amp
id|np-&gt;rcv_saddr
)paren
)paren
(brace
r_if
c_cond
(paren
id|ipv6_addr_cmp
c_func
(paren
op_amp
id|np-&gt;rcv_saddr
comma
id|loc_addr
)paren
)paren
(brace
r_continue
suffix:semicolon
)brace
id|score
op_increment
suffix:semicolon
)brace
multiline_comment|/* remote address matches? */
r_if
c_cond
(paren
op_logical_neg
id|ipv6_addr_any
c_func
(paren
op_amp
id|np-&gt;daddr
)paren
)paren
(brace
r_if
c_cond
(paren
id|ipv6_addr_cmp
c_func
(paren
op_amp
id|np-&gt;daddr
comma
id|rmt_addr
)paren
)paren
(brace
r_continue
suffix:semicolon
)brace
id|score
op_increment
suffix:semicolon
)brace
multiline_comment|/* perfect match? */
r_if
c_cond
(paren
id|score
op_eq
l_int|3
)paren
r_return
id|s
suffix:semicolon
multiline_comment|/* no, check if this is the best so far.. */
r_if
c_cond
(paren
id|score
op_le
id|badness
)paren
r_continue
suffix:semicolon
id|result
op_assign
id|s
suffix:semicolon
id|badness
op_assign
id|score
suffix:semicolon
)brace
r_return
id|result
suffix:semicolon
)brace
DECL|function|inet6_mc_check
r_static
r_int
id|__inline__
id|inet6_mc_check
c_func
(paren
r_struct
id|sock
op_star
id|sk
comma
r_struct
id|in6_addr
op_star
id|addr
)paren
(brace
r_struct
id|ipv6_mc_socklist
op_star
id|mc
suffix:semicolon
r_for
c_loop
(paren
id|mc
op_assign
id|sk-&gt;net_pinfo.af_inet6.ipv6_mc_list
suffix:semicolon
id|mc
suffix:semicolon
id|mc
op_assign
id|mc-&gt;next
)paren
(brace
r_if
c_cond
(paren
id|ipv6_addr_cmp
c_func
(paren
op_amp
id|mc-&gt;addr
comma
id|addr
)paren
op_eq
l_int|0
)paren
r_return
l_int|1
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;Deliver a datagram to raw sockets.&n; */
DECL|function|inet6_get_sock_raw
r_struct
id|sock
op_star
id|inet6_get_sock_raw
c_func
(paren
r_struct
id|sock
op_star
id|sk
comma
r_int
r_int
id|num
comma
r_struct
id|in6_addr
op_star
id|loc_addr
comma
r_struct
id|in6_addr
op_star
id|rmt_addr
)paren
(brace
r_struct
id|sock
op_star
id|s
suffix:semicolon
r_struct
id|ipv6_pinfo
op_star
id|np
suffix:semicolon
r_int
id|addr_type
op_assign
l_int|0
suffix:semicolon
id|s
op_assign
id|sk
suffix:semicolon
id|addr_type
op_assign
id|ipv6_addr_type
c_func
(paren
id|loc_addr
)paren
suffix:semicolon
r_for
c_loop
(paren
suffix:semicolon
id|s
op_ne
l_int|NULL
suffix:semicolon
id|s
op_assign
id|s-&gt;next
)paren
(brace
r_if
c_cond
(paren
id|s-&gt;num
op_ne
id|num
)paren
r_continue
suffix:semicolon
r_if
c_cond
(paren
id|s-&gt;dead
op_logical_and
(paren
id|s-&gt;state
op_eq
id|TCP_CLOSE
)paren
)paren
(brace
r_continue
suffix:semicolon
)brace
id|np
op_assign
op_amp
id|s-&gt;net_pinfo.af_inet6
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ipv6_addr_any
c_func
(paren
op_amp
id|np-&gt;daddr
)paren
op_logical_and
id|ipv6_addr_cmp
c_func
(paren
op_amp
id|np-&gt;daddr
comma
id|rmt_addr
)paren
)paren
(brace
r_continue
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|ipv6_addr_any
c_func
(paren
op_amp
id|np-&gt;rcv_saddr
)paren
)paren
(brace
r_if
c_cond
(paren
id|ipv6_addr_cmp
c_func
(paren
op_amp
id|np-&gt;rcv_saddr
comma
id|loc_addr
)paren
op_eq
l_int|0
)paren
r_return
id|s
suffix:semicolon
r_if
c_cond
(paren
(paren
id|addr_type
op_amp
id|IPV6_ADDR_MULTICAST
)paren
op_logical_and
id|inet6_mc_check
c_func
(paren
id|s
comma
id|loc_addr
)paren
)paren
r_return
(paren
id|s
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
r_return
id|s
suffix:semicolon
)brace
r_return
l_int|NULL
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;inet6_get_sock_mcast for UDP sockets.&n; */
DECL|function|inet6_get_sock_mcast
r_struct
id|sock
op_star
id|inet6_get_sock_mcast
c_func
(paren
r_struct
id|sock
op_star
id|sk
comma
r_int
r_int
id|num
comma
r_int
r_int
id|rmt_port
comma
r_struct
id|in6_addr
op_star
id|loc_addr
comma
r_struct
id|in6_addr
op_star
id|rmt_addr
)paren
(brace
r_struct
id|sock
op_star
id|s
suffix:semicolon
r_struct
id|ipv6_pinfo
op_star
id|np
suffix:semicolon
id|s
op_assign
id|sk
suffix:semicolon
r_for
c_loop
(paren
suffix:semicolon
id|s
op_ne
l_int|NULL
suffix:semicolon
id|s
op_assign
id|s-&gt;next
)paren
(brace
r_if
c_cond
(paren
id|s-&gt;num
op_ne
id|num
)paren
r_continue
suffix:semicolon
r_if
c_cond
(paren
id|s-&gt;dead
op_logical_and
(paren
id|s-&gt;state
op_eq
id|TCP_CLOSE
)paren
)paren
(brace
r_continue
suffix:semicolon
)brace
id|np
op_assign
op_amp
id|s-&gt;net_pinfo.af_inet6
suffix:semicolon
r_if
c_cond
(paren
id|s-&gt;dummy_th.dest
)paren
(brace
r_if
c_cond
(paren
id|s-&gt;dummy_th.dest
op_ne
id|rmt_port
)paren
(brace
r_continue
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
op_logical_neg
id|ipv6_addr_any
c_func
(paren
op_amp
id|np-&gt;daddr
)paren
op_logical_and
id|ipv6_addr_cmp
c_func
(paren
op_amp
id|np-&gt;daddr
comma
id|rmt_addr
)paren
)paren
(brace
r_continue
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|ipv6_addr_any
c_func
(paren
op_amp
id|np-&gt;rcv_saddr
)paren
)paren
(brace
r_if
c_cond
(paren
id|ipv6_addr_cmp
c_func
(paren
op_amp
id|np-&gt;rcv_saddr
comma
id|loc_addr
)paren
op_eq
l_int|0
)paren
r_return
id|s
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|inet6_mc_check
c_func
(paren
id|s
comma
id|loc_addr
)paren
)paren
(brace
r_continue
suffix:semicolon
)brace
r_return
id|s
suffix:semicolon
)brace
r_return
l_int|NULL
suffix:semicolon
)brace
DECL|variable|inet6_stream_ops
r_struct
id|proto_ops
id|inet6_stream_ops
op_assign
(brace
id|AF_INET6
comma
id|inet6_dup
comma
id|inet6_release
comma
id|inet6_bind
comma
id|inet_stream_connect
comma
multiline_comment|/* ok&t;&t;*/
id|inet6_socketpair
comma
multiline_comment|/* a do nothing&t;*/
id|inet_accept
comma
multiline_comment|/* ok&t;&t;*/
id|inet6_getname
comma
id|inet_poll
comma
multiline_comment|/* ok&t;&t;*/
id|inet6_ioctl
comma
multiline_comment|/* must change  */
id|inet_listen
comma
multiline_comment|/* ok&t;&t;*/
id|inet_shutdown
comma
multiline_comment|/* ok&t;&t;*/
id|inet_setsockopt
comma
multiline_comment|/* ok&t;&t;*/
id|inet_getsockopt
comma
multiline_comment|/* ok&t;&t;*/
id|sock_no_fcntl
comma
multiline_comment|/* ok&t;&t;*/
id|inet_sendmsg
comma
multiline_comment|/* ok&t;&t;*/
id|inet_recvmsg
multiline_comment|/* ok&t;&t;*/
)brace
suffix:semicolon
DECL|variable|inet6_dgram_ops
r_struct
id|proto_ops
id|inet6_dgram_ops
op_assign
(brace
id|AF_INET6
comma
id|inet6_dup
comma
id|inet6_release
comma
id|inet6_bind
comma
id|inet_dgram_connect
comma
multiline_comment|/* ok&t;&t;*/
id|inet6_socketpair
comma
multiline_comment|/* a do nothing&t;*/
id|inet_accept
comma
multiline_comment|/* ok&t;&t;*/
id|inet6_getname
comma
id|datagram_poll
comma
multiline_comment|/* ok&t;&t;*/
id|inet6_ioctl
comma
multiline_comment|/* must change  */
id|inet_listen
comma
multiline_comment|/* ok&t;&t;*/
id|inet_shutdown
comma
multiline_comment|/* ok&t;&t;*/
id|inet_setsockopt
comma
multiline_comment|/* ok&t;&t;*/
id|inet_getsockopt
comma
multiline_comment|/* ok&t;&t;*/
id|sock_no_fcntl
comma
multiline_comment|/* ok&t;&t;*/
id|inet_sendmsg
comma
multiline_comment|/* ok&t;&t;*/
id|inet_recvmsg
multiline_comment|/* ok&t;&t;*/
)brace
suffix:semicolon
DECL|variable|inet6_family_ops
r_struct
id|net_proto_family
id|inet6_family_ops
op_assign
(brace
id|AF_INET6
comma
id|inet6_create
)brace
suffix:semicolon
macro_line|#ifdef MODULE
DECL|function|init_module
r_int
id|init_module
c_func
(paren
r_void
)paren
macro_line|#else
r_void
id|inet6_proto_init
c_func
(paren
r_struct
id|net_proto
op_star
id|pro
)paren
macro_line|#endif
(brace
r_int
id|i
suffix:semicolon
r_struct
id|sk_buff
op_star
id|dummy_skb
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;IPv6 v0.1 for NET3.037&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
r_sizeof
(paren
r_struct
id|ipv6_options
)paren
OG
r_sizeof
(paren
id|dummy_skb-&gt;cb
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_CRIT
l_string|&quot;inet6_proto_init: size fault&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
(paren
r_void
)paren
id|sock_register
c_func
(paren
op_amp
id|inet6_family_ops
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|SOCK_ARRAY_SIZE
suffix:semicolon
id|i
op_increment
)paren
(brace
id|rawv6_sock_array
(braket
id|i
)braket
op_assign
l_int|NULL
suffix:semicolon
)brace
multiline_comment|/*&n;&t; *&t;ipngwg API draft makes clear that the correct semantics&n;&t; *&t;for TCP and UDP is to consider one TCP and UDP instance&n;&t; *&t;in a host availiable by both INET and INET6 APIs and&n;&t; *&t;hable to communicate via both network protocols.&n;&t; */
id|tcpv6_prot.inuse
op_assign
l_int|0
suffix:semicolon
id|tcpv6_prot.highestinuse
op_assign
l_int|0
suffix:semicolon
id|tcpv6_prot.sock_array
op_assign
id|tcp_sock_array
suffix:semicolon
id|udpv6_prot.inuse
op_assign
l_int|0
suffix:semicolon
id|udpv6_prot.highestinuse
op_assign
l_int|0
suffix:semicolon
id|udpv6_prot.sock_array
op_assign
id|udp_sock_array
suffix:semicolon
id|rawv6_prot.inuse
op_assign
l_int|0
suffix:semicolon
id|rawv6_prot.highestinuse
op_assign
l_int|0
suffix:semicolon
id|rawv6_prot.sock_array
op_assign
id|rawv6_sock_array
suffix:semicolon
id|ipv6_init
c_func
(paren
)paren
suffix:semicolon
id|icmpv6_init
c_func
(paren
op_amp
id|inet6_family_ops
)paren
suffix:semicolon
id|ndisc_init
c_func
(paren
op_amp
id|inet6_family_ops
)paren
suffix:semicolon
id|addrconf_init
c_func
(paren
)paren
suffix:semicolon
id|sit_init
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* init v6 transport protocols */
id|udpv6_init
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* add /proc entries here */
id|tcpv6_init
c_func
(paren
)paren
suffix:semicolon
macro_line|#ifdef MODULE
r_return
l_int|0
suffix:semicolon
macro_line|#endif
)brace
macro_line|#ifdef MODULE
DECL|function|cleanup_module
r_void
id|cleanup_module
c_func
(paren
r_void
)paren
(brace
id|sit_cleanup
c_func
(paren
)paren
suffix:semicolon
id|ipv6_cleanup
c_func
(paren
)paren
suffix:semicolon
id|sock_unregister
c_func
(paren
id|AF_INET6
)paren
suffix:semicolon
)brace
macro_line|#endif
eof
