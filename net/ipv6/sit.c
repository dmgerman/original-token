multiline_comment|/*&n; *&t;IPv6 over IPv4 tunnel device - Simple Internet Transition (SIT)&n; *&t;Linux INET6 implementation&n; *&n; *&t;Authors:&n; *&t;Pedro Roque&t;&t;&lt;roque@di.fc.ul.pt&gt;&t;&n; *&n; *&n; *&t;This program is free software; you can redistribute it and/or&n; *      modify it under the terms of the GNU General Public License&n; *      as published by the Free Software Foundation; either version&n; *      2 of the License, or (at your option) any later version.&n; */
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/socket.h&gt;
macro_line|#include &lt;linux/sockios.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/net.h&gt;
macro_line|#include &lt;linux/in6.h&gt;
macro_line|#include &lt;linux/netdevice.h&gt;
macro_line|#include &lt;linux/if_arp.h&gt;
macro_line|#include &lt;linux/icmp.h&gt;
macro_line|#include &lt;net/sock.h&gt;
macro_line|#include &lt;net/snmp.h&gt;
macro_line|#include &lt;net/ipv6.h&gt;
macro_line|#include &lt;net/protocol.h&gt;
macro_line|#include &lt;net/transp_v6.h&gt;
macro_line|#include &lt;net/ndisc.h&gt;
macro_line|#include &lt;net/ipv6_route.h&gt;
macro_line|#include &lt;net/addrconf.h&gt;
macro_line|#include &lt;net/ip.h&gt;
macro_line|#include &lt;net/udp.h&gt;
macro_line|#include &lt;net/sit.h&gt;
r_static
r_int
id|sit_init_dev
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
suffix:semicolon
DECL|variable|sit_device
r_static
r_struct
id|device
id|sit_device
op_assign
(brace
l_string|&quot;sit0&quot;
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0x0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|NULL
comma
id|sit_init_dev
)brace
suffix:semicolon
DECL|variable|sit_gc_last_run
r_static
r_int
r_int
id|sit_gc_last_run
suffix:semicolon
r_static
r_void
id|sit_mtu_cache_gc
c_func
(paren
r_void
)paren
suffix:semicolon
r_static
r_int
id|sit_xmit
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_int
id|sit_rcv
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|device
op_star
id|dev
comma
r_struct
id|options
op_star
id|opt
comma
id|__u32
id|daddr
comma
r_int
r_int
id|len
comma
id|__u32
id|saddr
comma
r_int
id|redo
comma
r_struct
id|inet_protocol
op_star
id|protocol
)paren
suffix:semicolon
r_static
r_int
id|sit_open
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_int
id|sit_close
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_struct
id|enet_statistics
op_star
id|sit_get_stats
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_void
id|sit_err
c_func
(paren
r_int
id|type
comma
r_int
id|code
comma
r_int
r_char
op_star
id|buff
comma
id|__u32
id|info
comma
id|__u32
id|daddr
comma
id|__u32
id|saddr
comma
r_struct
id|inet_protocol
op_star
id|protocol
)paren
suffix:semicolon
DECL|variable|sit_protocol
r_static
r_struct
id|inet_protocol
id|sit_protocol
op_assign
(brace
id|sit_rcv
comma
id|sit_err
comma
l_int|0
comma
id|IPPROTO_IPV6
comma
l_int|0
comma
l_int|NULL
comma
l_string|&quot;IPv6&quot;
)brace
suffix:semicolon
DECL|macro|SIT_NUM_BUCKETS
mdefine_line|#define SIT_NUM_BUCKETS&t;16
DECL|variable|sit_mtu_cache
r_struct
id|sit_mtu_info
op_star
id|sit_mtu_cache
(braket
id|SIT_NUM_BUCKETS
)braket
suffix:semicolon
DECL|variable|vif_num
r_static
r_int
id|vif_num
op_assign
l_int|0
suffix:semicolon
DECL|variable|vif_list
r_static
r_struct
id|sit_vif
op_star
id|vif_list
op_assign
l_int|NULL
suffix:semicolon
DECL|function|sit_addr_hash
r_static
id|__inline__
id|__u32
id|sit_addr_hash
c_func
(paren
id|__u32
id|addr
)paren
(brace
id|__u32
id|hash_val
suffix:semicolon
id|hash_val
op_assign
id|addr
suffix:semicolon
id|hash_val
op_xor_assign
id|hash_val
op_rshift
l_int|16
suffix:semicolon
id|hash_val
op_xor_assign
id|hash_val
op_rshift
l_int|8
suffix:semicolon
r_return
(paren
id|hash_val
op_amp
(paren
id|SIT_NUM_BUCKETS
op_minus
l_int|1
)paren
)paren
suffix:semicolon
)brace
DECL|function|sit_cache_insert
r_static
r_void
id|sit_cache_insert
c_func
(paren
id|__u32
id|addr
comma
r_int
id|mtu
)paren
(brace
r_struct
id|sit_mtu_info
op_star
id|minfo
suffix:semicolon
r_int
id|hash
suffix:semicolon
id|minfo
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|sit_mtu_info
)paren
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
id|minfo
op_eq
l_int|NULL
)paren
r_return
suffix:semicolon
id|minfo-&gt;addr
op_assign
id|addr
suffix:semicolon
id|minfo-&gt;tstamp
op_assign
id|jiffies
suffix:semicolon
id|minfo-&gt;mtu
op_assign
id|mtu
suffix:semicolon
id|hash
op_assign
id|sit_addr_hash
c_func
(paren
id|addr
)paren
suffix:semicolon
id|minfo-&gt;next
op_assign
id|sit_mtu_cache
(braket
id|hash
)braket
suffix:semicolon
id|sit_mtu_cache
(braket
id|hash
)braket
op_assign
id|minfo
suffix:semicolon
)brace
DECL|function|sit_mtu_lookup
r_static
r_struct
id|sit_mtu_info
op_star
id|sit_mtu_lookup
c_func
(paren
id|__u32
id|addr
)paren
(brace
r_struct
id|sit_mtu_info
op_star
id|iter
suffix:semicolon
r_int
id|hash
suffix:semicolon
id|hash
op_assign
id|sit_addr_hash
c_func
(paren
id|addr
)paren
suffix:semicolon
r_for
c_loop
(paren
id|iter
op_assign
id|sit_mtu_cache
(braket
id|hash
)braket
suffix:semicolon
id|iter
suffix:semicolon
id|iter
op_assign
id|iter-&gt;next
)paren
(brace
r_if
c_cond
(paren
id|iter-&gt;addr
op_eq
id|addr
)paren
(brace
id|iter-&gt;tstamp
op_assign
id|jiffies
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
multiline_comment|/*&n;&t; *&t;run garbage collector&n;&t; */
r_if
c_cond
(paren
id|jiffies
op_minus
id|sit_gc_last_run
OG
id|SIT_GC_FREQUENCY
)paren
(brace
id|sit_mtu_cache_gc
c_func
(paren
)paren
suffix:semicolon
id|sit_gc_last_run
op_assign
id|jiffies
suffix:semicolon
)brace
r_return
id|iter
suffix:semicolon
)brace
DECL|function|sit_mtu_cache_gc
r_static
r_void
id|sit_mtu_cache_gc
c_func
(paren
r_void
)paren
(brace
r_struct
id|sit_mtu_info
op_star
id|iter
comma
op_star
id|back
suffix:semicolon
r_int
r_int
id|now
op_assign
id|jiffies
suffix:semicolon
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|SIT_NUM_BUCKETS
suffix:semicolon
id|i
op_increment
)paren
(brace
id|back
op_assign
l_int|NULL
suffix:semicolon
r_for
c_loop
(paren
id|iter
op_assign
id|sit_mtu_cache
(braket
id|i
)braket
suffix:semicolon
id|iter
suffix:semicolon
)paren
(brace
r_if
c_cond
(paren
id|now
op_minus
id|iter-&gt;tstamp
OG
id|SIT_GC_TIMEOUT
)paren
(brace
r_struct
id|sit_mtu_info
op_star
id|old
suffix:semicolon
id|old
op_assign
id|iter
suffix:semicolon
id|iter
op_assign
id|iter-&gt;next
suffix:semicolon
r_if
c_cond
(paren
id|back
)paren
(brace
id|back-&gt;next
op_assign
id|iter
suffix:semicolon
)brace
r_else
(brace
id|sit_mtu_cache
(braket
id|i
)braket
op_assign
id|iter
suffix:semicolon
)brace
id|kfree
c_func
(paren
id|old
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
id|back
op_assign
id|iter
suffix:semicolon
id|iter
op_assign
id|iter-&gt;next
suffix:semicolon
)brace
)brace
)brace
DECL|function|sit_init_dev
r_static
r_int
id|sit_init_dev
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
r_int
id|i
suffix:semicolon
id|dev-&gt;open
op_assign
id|sit_open
suffix:semicolon
id|dev-&gt;stop
op_assign
id|sit_close
suffix:semicolon
id|dev-&gt;hard_start_xmit
op_assign
id|sit_xmit
suffix:semicolon
id|dev-&gt;get_stats
op_assign
id|sit_get_stats
suffix:semicolon
id|dev-&gt;priv
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|enet_statistics
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;priv
op_eq
l_int|NULL
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|memset
c_func
(paren
id|dev-&gt;priv
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|enet_statistics
)paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|DEV_NUMBUFFS
suffix:semicolon
id|i
op_increment
)paren
id|skb_queue_head_init
c_func
(paren
op_amp
id|dev-&gt;buffs
(braket
id|i
)braket
)paren
suffix:semicolon
id|dev-&gt;hard_header
op_assign
l_int|NULL
suffix:semicolon
id|dev-&gt;rebuild_header
op_assign
l_int|NULL
suffix:semicolon
id|dev-&gt;set_mac_address
op_assign
l_int|NULL
suffix:semicolon
id|dev-&gt;header_cache_bind
op_assign
l_int|NULL
suffix:semicolon
id|dev-&gt;header_cache_update
op_assign
l_int|NULL
suffix:semicolon
id|dev-&gt;type
op_assign
id|ARPHRD_SIT
suffix:semicolon
id|dev-&gt;hard_header_len
op_assign
id|MAX_HEADER
suffix:semicolon
id|dev-&gt;mtu
op_assign
l_int|1500
op_minus
r_sizeof
(paren
r_struct
id|iphdr
)paren
suffix:semicolon
id|dev-&gt;addr_len
op_assign
l_int|0
suffix:semicolon
id|dev-&gt;tx_queue_len
op_assign
l_int|2
suffix:semicolon
id|memset
c_func
(paren
id|dev-&gt;broadcast
comma
l_int|0
comma
id|MAX_ADDR_LEN
)paren
suffix:semicolon
id|memset
c_func
(paren
id|dev-&gt;dev_addr
comma
l_int|0
comma
id|MAX_ADDR_LEN
)paren
suffix:semicolon
id|dev-&gt;flags
op_assign
id|IFF_NOARP
suffix:semicolon
id|dev-&gt;family
op_assign
id|AF_INET6
suffix:semicolon
id|dev-&gt;pa_addr
op_assign
l_int|0
suffix:semicolon
id|dev-&gt;pa_brdaddr
op_assign
l_int|0
suffix:semicolon
id|dev-&gt;pa_dstaddr
op_assign
l_int|0
suffix:semicolon
id|dev-&gt;pa_mask
op_assign
l_int|0
suffix:semicolon
id|dev-&gt;pa_alen
op_assign
l_int|4
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|sit_init_vif
r_static
r_int
id|sit_init_vif
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
r_int
id|i
suffix:semicolon
id|dev-&gt;flags
op_assign
id|IFF_NOARP
op_or
id|IFF_POINTOPOINT
op_or
id|IFF_MULTICAST
suffix:semicolon
id|dev-&gt;priv
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|enet_statistics
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;priv
op_eq
l_int|NULL
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|memset
c_func
(paren
id|dev-&gt;priv
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|enet_statistics
)paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|DEV_NUMBUFFS
suffix:semicolon
id|i
op_increment
)paren
id|skb_queue_head_init
c_func
(paren
op_amp
id|dev-&gt;buffs
(braket
id|i
)braket
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|sit_open
r_static
r_int
id|sit_open
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|sit_close
r_static
r_int
id|sit_close
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|sit_init
r_int
id|sit_init
c_func
(paren
r_void
)paren
(brace
r_int
id|i
suffix:semicolon
multiline_comment|/* register device */
r_if
c_cond
(paren
id|register_netdev
c_func
(paren
op_amp
id|sit_device
)paren
op_ne
l_int|0
)paren
(brace
r_return
op_minus
id|EIO
suffix:semicolon
)brace
id|inet_add_protocol
c_func
(paren
op_amp
id|sit_protocol
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|SIT_NUM_BUCKETS
suffix:semicolon
id|i
op_increment
)paren
id|sit_mtu_cache
(braket
id|i
)braket
op_assign
l_int|NULL
suffix:semicolon
id|sit_gc_last_run
op_assign
id|jiffies
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|sit_add_tunnel
r_struct
id|device
op_star
id|sit_add_tunnel
c_func
(paren
id|__u32
id|dstaddr
)paren
(brace
r_struct
id|sit_vif
op_star
id|vif
suffix:semicolon
r_struct
id|device
op_star
id|dev
suffix:semicolon
r_if
c_cond
(paren
(paren
id|sit_device.flags
op_amp
id|IFF_UP
)paren
op_eq
l_int|0
)paren
r_return
l_int|NULL
suffix:semicolon
id|vif
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|sit_vif
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|vif
op_eq
l_int|NULL
)paren
r_return
l_int|NULL
suffix:semicolon
multiline_comment|/*&n;&t; *&t;Create PtoP configured tunnel&n;&t; */
id|dev
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|device
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dev
op_eq
l_int|NULL
)paren
r_return
l_int|NULL
suffix:semicolon
id|memcpy
c_func
(paren
id|dev
comma
op_amp
id|sit_device
comma
r_sizeof
(paren
r_struct
id|device
)paren
)paren
suffix:semicolon
id|dev-&gt;init
op_assign
id|sit_init_vif
suffix:semicolon
id|dev-&gt;pa_dstaddr
op_assign
id|dstaddr
suffix:semicolon
id|dev-&gt;name
op_assign
id|vif-&gt;name
suffix:semicolon
id|sprintf
c_func
(paren
id|vif-&gt;name
comma
l_string|&quot;sit%d&quot;
comma
op_increment
id|vif_num
)paren
suffix:semicolon
id|register_netdev
c_func
(paren
id|dev
)paren
suffix:semicolon
id|vif-&gt;dev
op_assign
id|dev
suffix:semicolon
id|vif-&gt;next
op_assign
id|vif_list
suffix:semicolon
id|vif_list
op_assign
id|vif
suffix:semicolon
r_return
id|dev
suffix:semicolon
)brace
DECL|function|sit_cleanup
r_void
id|sit_cleanup
c_func
(paren
r_void
)paren
(brace
r_struct
id|sit_vif
op_star
id|vif
suffix:semicolon
r_for
c_loop
(paren
id|vif
op_assign
id|vif_list
suffix:semicolon
id|vif
suffix:semicolon
)paren
(brace
r_struct
id|device
op_star
id|dev
op_assign
id|vif-&gt;dev
suffix:semicolon
r_struct
id|sit_vif
op_star
id|cur
suffix:semicolon
id|unregister_netdev
c_func
(paren
id|dev
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|dev-&gt;priv
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|dev
)paren
suffix:semicolon
id|cur
op_assign
id|vif
suffix:semicolon
id|vif
op_assign
id|vif-&gt;next
suffix:semicolon
)brace
id|vif_list
op_assign
l_int|NULL
suffix:semicolon
id|unregister_netdev
c_func
(paren
op_amp
id|sit_device
)paren
suffix:semicolon
id|inet_del_protocol
c_func
(paren
op_amp
id|sit_protocol
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;receive IPv4 ICMP messages&n; */
DECL|function|sit_err
r_static
r_void
id|sit_err
c_func
(paren
r_int
id|type
comma
r_int
id|code
comma
r_int
r_char
op_star
id|buff
comma
id|__u32
id|info
comma
id|__u32
id|daddr
comma
id|__u32
id|saddr
comma
r_struct
id|inet_protocol
op_star
id|protocol
)paren
(brace
r_if
c_cond
(paren
id|type
op_eq
id|ICMP_DEST_UNREACH
op_logical_and
id|code
op_eq
id|ICMP_FRAG_NEEDED
)paren
(brace
r_struct
id|sit_mtu_info
op_star
id|minfo
suffix:semicolon
id|info
op_sub_assign
r_sizeof
(paren
r_struct
id|iphdr
)paren
suffix:semicolon
id|minfo
op_assign
id|sit_mtu_lookup
c_func
(paren
id|daddr
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;sit: %08lx pmtu = %ul&bslash;n&quot;
comma
id|ntohl
c_func
(paren
id|saddr
)paren
comma
id|info
)paren
suffix:semicolon
r_if
c_cond
(paren
id|minfo
op_eq
l_int|NULL
)paren
(brace
id|minfo
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|sit_mtu_info
)paren
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
id|minfo
op_eq
l_int|NULL
)paren
r_return
suffix:semicolon
id|start_bh_atomic
c_func
(paren
)paren
suffix:semicolon
id|sit_cache_insert
c_func
(paren
id|daddr
comma
id|info
)paren
suffix:semicolon
id|end_bh_atomic
c_func
(paren
)paren
suffix:semicolon
)brace
r_else
(brace
id|minfo-&gt;mtu
op_assign
id|info
suffix:semicolon
)brace
)brace
)brace
DECL|function|sit_rcv
r_static
r_int
id|sit_rcv
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|device
op_star
id|idev
comma
r_struct
id|options
op_star
id|opt
comma
id|__u32
id|daddr
comma
r_int
r_int
id|len
comma
id|__u32
id|saddr
comma
r_int
id|redo
comma
r_struct
id|inet_protocol
op_star
id|protocol
)paren
(brace
r_struct
id|enet_statistics
op_star
id|stats
suffix:semicolon
r_struct
id|device
op_star
id|dev
op_assign
l_int|NULL
suffix:semicolon
r_struct
id|sit_vif
op_star
id|vif
suffix:semicolon
id|skb-&gt;h.raw
op_assign
id|skb_pull
c_func
(paren
id|skb
comma
id|skb-&gt;h.raw
op_minus
id|skb-&gt;data
)paren
suffix:semicolon
id|skb-&gt;protocol
op_assign
id|__constant_htons
c_func
(paren
id|ETH_P_IPV6
)paren
suffix:semicolon
r_for
c_loop
(paren
id|vif
op_assign
id|vif_list
suffix:semicolon
id|vif
suffix:semicolon
id|vif
op_assign
id|vif-&gt;next
)paren
(brace
r_if
c_cond
(paren
id|saddr
op_eq
id|vif-&gt;dev-&gt;pa_dstaddr
)paren
(brace
id|dev
op_assign
id|vif-&gt;dev
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|dev
op_eq
l_int|NULL
)paren
(brace
id|dev
op_assign
op_amp
id|sit_device
suffix:semicolon
)brace
id|skb-&gt;dev
op_assign
id|dev
suffix:semicolon
id|skb-&gt;ip_summed
op_assign
id|CHECKSUM_NONE
suffix:semicolon
id|stats
op_assign
(paren
r_struct
id|enet_statistics
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|stats-&gt;rx_packets
op_increment
suffix:semicolon
id|ipv6_rcv
c_func
(paren
id|skb
comma
id|dev
comma
l_int|NULL
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|sit_xmit
r_static
r_int
id|sit_xmit
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|device
op_star
id|dev
)paren
(brace
r_struct
id|enet_statistics
op_star
id|stats
suffix:semicolon
r_struct
id|sit_mtu_info
op_star
id|minfo
suffix:semicolon
r_struct
id|in6_addr
op_star
id|addr6
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_struct
id|rtable
op_star
id|rt
suffix:semicolon
r_struct
id|iphdr
op_star
id|iph
suffix:semicolon
id|__u32
id|saddr
suffix:semicolon
id|__u32
id|daddr
suffix:semicolon
id|__u32
id|raddr
suffix:semicolon
r_int
id|addr_type
suffix:semicolon
r_int
id|mtu
suffix:semicolon
r_int
id|len
suffix:semicolon
multiline_comment|/* &n;&t; *&t;Make sure we are not busy (check lock variable) &n;&t; */
id|stats
op_assign
(paren
r_struct
id|enet_statistics
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;tbusy
op_ne
l_int|0
)paren
(brace
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;sit_xmit: busy&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
id|dev-&gt;tbusy
op_assign
l_int|1
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|daddr
op_assign
id|dev-&gt;pa_dstaddr
suffix:semicolon
r_if
c_cond
(paren
id|daddr
op_eq
l_int|0
)paren
(brace
r_struct
id|neighbour
op_star
id|neigh
suffix:semicolon
id|neigh
op_assign
id|skb-&gt;nexthop
suffix:semicolon
r_if
c_cond
(paren
id|neigh
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;sit: nexthop == NULL&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|on_error
suffix:semicolon
)brace
id|addr6
op_assign
op_amp
id|neigh-&gt;addr
suffix:semicolon
id|addr_type
op_assign
id|ipv6_addr_type
c_func
(paren
id|addr6
)paren
suffix:semicolon
r_if
c_cond
(paren
id|addr_type
op_eq
id|IPV6_ADDR_ANY
)paren
(brace
id|addr6
op_assign
op_amp
id|skb-&gt;ipv6_hdr-&gt;daddr
suffix:semicolon
id|addr_type
op_assign
id|ipv6_addr_type
c_func
(paren
id|addr6
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|addr_type
op_amp
id|IPV6_ADDR_COMPATv4
)paren
op_eq
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;sit_xmit: non v4 address&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|on_error
suffix:semicolon
)brace
id|daddr
op_assign
id|addr6-&gt;s6_addr32
(braket
l_int|3
)braket
suffix:semicolon
)brace
id|len
op_assign
id|skb-&gt;tail
op_minus
(paren
id|skb-&gt;data
op_plus
r_sizeof
(paren
r_struct
id|ipv6hdr
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|skb-&gt;sk
)paren
(brace
id|atomic_sub
c_func
(paren
id|skb-&gt;truesize
comma
op_amp
id|skb-&gt;sk-&gt;wmem_alloc
)paren
suffix:semicolon
)brace
id|skb-&gt;sk
op_assign
l_int|NULL
suffix:semicolon
id|iph
op_assign
(paren
r_struct
id|iphdr
op_star
)paren
id|skb_push
c_func
(paren
id|skb
comma
r_sizeof
(paren
r_struct
id|iphdr
)paren
)paren
suffix:semicolon
id|skb-&gt;protocol
op_assign
id|htons
c_func
(paren
id|ETH_P_IP
)paren
suffix:semicolon
multiline_comment|/* get route */
id|rt
op_assign
id|ip_rt_route
c_func
(paren
id|daddr
comma
id|skb-&gt;localroute
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rt
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;sit: no route to host&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|on_error
suffix:semicolon
)brace
id|minfo
op_assign
id|sit_mtu_lookup
c_func
(paren
id|daddr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|minfo
)paren
id|mtu
op_assign
id|minfo-&gt;mtu
suffix:semicolon
r_else
id|mtu
op_assign
id|rt-&gt;rt_dev-&gt;mtu
suffix:semicolon
r_if
c_cond
(paren
id|mtu
OG
l_int|576
op_logical_and
id|len
OG
id|mtu
)paren
(brace
id|icmpv6_send
c_func
(paren
id|skb
comma
id|ICMPV6_PKT_TOOBIG
comma
l_int|0
comma
id|mtu
comma
id|dev
)paren
suffix:semicolon
r_goto
id|on_error
suffix:semicolon
)brace
id|saddr
op_assign
id|rt-&gt;rt_src
suffix:semicolon
id|skb-&gt;dev
op_assign
id|rt-&gt;rt_dev
suffix:semicolon
id|raddr
op_assign
id|rt-&gt;rt_gateway
suffix:semicolon
r_if
c_cond
(paren
id|raddr
op_eq
l_int|0
)paren
id|raddr
op_assign
id|daddr
suffix:semicolon
multiline_comment|/* now for the device header */
id|skb-&gt;arp
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|skb-&gt;dev-&gt;hard_header_len
)paren
(brace
r_int
id|mac
suffix:semicolon
r_if
c_cond
(paren
id|skb-&gt;data
op_minus
id|skb-&gt;head
OL
id|skb-&gt;dev-&gt;hard_header_len
)paren
(brace
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;sit: space at head &lt; dev header&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|on_error
suffix:semicolon
)brace
r_if
c_cond
(paren
id|skb-&gt;dev-&gt;hard_header
)paren
(brace
id|mac
op_assign
id|skb-&gt;dev
op_member_access_from_pointer
id|hard_header
c_func
(paren
id|skb
comma
id|skb-&gt;dev
comma
id|ETH_P_IP
comma
l_int|NULL
comma
l_int|NULL
comma
id|len
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mac
OL
l_int|0
)paren
id|skb-&gt;arp
op_assign
l_int|0
suffix:semicolon
id|skb-&gt;raddr
op_assign
id|raddr
suffix:semicolon
)brace
)brace
id|ip_rt_put
c_func
(paren
id|rt
)paren
suffix:semicolon
id|iph-&gt;version
op_assign
l_int|4
suffix:semicolon
id|iph-&gt;ihl
op_assign
l_int|5
suffix:semicolon
id|iph-&gt;tos
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* tos set to 0... */
r_if
c_cond
(paren
id|mtu
OG
l_int|576
)paren
(brace
id|iph-&gt;frag_off
op_assign
id|htons
c_func
(paren
id|IP_DF
)paren
suffix:semicolon
)brace
r_else
id|iph-&gt;frag_off
op_assign
l_int|0
suffix:semicolon
id|iph-&gt;ttl
op_assign
l_int|64
suffix:semicolon
id|iph-&gt;saddr
op_assign
id|saddr
suffix:semicolon
id|iph-&gt;daddr
op_assign
id|daddr
suffix:semicolon
id|iph-&gt;protocol
op_assign
id|IPPROTO_IPV6
suffix:semicolon
id|skb-&gt;ip_hdr
op_assign
id|iph
suffix:semicolon
id|ip_send_check
c_func
(paren
id|iph
)paren
suffix:semicolon
id|ip_queue_xmit
c_func
(paren
l_int|NULL
comma
id|skb-&gt;dev
comma
id|skb
comma
l_int|1
)paren
suffix:semicolon
id|stats-&gt;tx_packets
op_increment
suffix:semicolon
id|dev-&gt;tbusy
op_assign
l_int|0
suffix:semicolon
r_return
l_int|0
suffix:semicolon
id|on_error
suffix:colon
id|kfree_skb
c_func
(paren
id|skb
comma
id|FREE_WRITE
)paren
suffix:semicolon
id|dev-&gt;tbusy
op_assign
l_int|0
suffix:semicolon
id|stats-&gt;tx_errors
op_increment
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|sit_get_stats
r_static
r_struct
id|enet_statistics
op_star
id|sit_get_stats
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
r_return
(paren
r_struct
id|enet_statistics
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
)brace
multiline_comment|/*&n; * Local variables:&n; *  compile-command: &quot;gcc -D__KERNEL__ -I/usr/src/linux/include -Wall -Wstrict-prototypes -O2 -fomit-frame-pointer -fno-strength-reduce -pipe -m486 -DCPU=486 -DMODULE -DMODVERSIONS -include /usr/src/linux/include/linux/modversions.h  -c -o sit.o sit.c&quot;&n; * c-file-style: &quot;Linux&quot;&n; * End:&n; */
eof
