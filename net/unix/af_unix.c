multiline_comment|/*&n; * NET3:&t;Implementation of BSD Unix domain sockets.&n; *&n; * Authors:&t;Alan Cox, &lt;alan@cymru.net&gt;&n; *&n; *&t;&t;Currently this contains all but the file descriptor passing code.&n; *&t;&t;Before that goes in the odd bugs in the iovec handlers need &n; *&t;&t;fixing, and this bit testing. BSD fd passing is not a trivial part&n; *&t;&t;of the exercise it turns out. Anyone like writing garbage collectors.&n; *&n; *&t;&t;This program is free software; you can redistribute it and/or&n; *&t;&t;modify it under the terms of the GNU General Public License&n; *&t;&t;as published by the Free Software Foundation; either version&n; *&t;&t;2 of the License, or (at your option) any later version.&n; *&n; * Fixes:&n; *&t;&t;Linus Torvalds&t;:&t;Assorted bug cures.&n; *&t;&t;Niibe Yutaka&t;:&t;async I/O support.&n; *&t;&t;Carsten Paeth&t;:&t;PF_UNIX check, address fixes.&n; *&t;&t;Alan Cox&t;:&t;Limit size of allocated blocks.&n; *&t;&t;Alan Cox&t;:&t;Fixed the stupid socketpair bug.&n; *&t;&t;Alan Cox&t;:&t;BSD compatibility fine tuning.&n; *&t;&t;Alan Cox&t;:&t;Fixed a bug in connect when interrupted.&n; *&t;&t;Alan Cox&t;:&t;Sorted out a proper draft version of&n; *&t;&t;&t;&t;&t;file descriptor passing hacked up from&n; *&t;&t;&t;&t;&t;Mike Shaver&squot;s work.&n; *&t;&t;Marty Leisner&t;:&t;Fixes to fd passing&n; *&t;&t;Nick Nevin&t;:&t;recvmsg bugfix.&n; *&t;&t;Alan Cox&t;:&t;Started proper garbage collector&n; *&t;&t;Heiko EiBfeldt&t;:&t;Missing verify_area check&n; *&n; * Known differences from reference BSD that was tested:&n; *&n; *&t;[TO FIX]&n; *&t;ECONNREFUSED is not returned from one end of a connected() socket to the&n; *&t;&t;other the moment one end closes.&n; *&t;fstat() doesn&squot;t return st_dev=NODEV, and give the blksize as high water mark&n; *&t;&t;and a fake inode identifier (nor the BSD first socket fstat twice bug).&n; *&t;[NOT TO FIX]&n; *&t;accept() returns a path name even if the connecting socket has closed&n; *&t;&t;in the meantime (BSD loses the path and gives up).&n; *&t;accept() returns 0 length path for an unbound connector. BSD returns 16&n; *&t;&t;and a null first byte in the path (but not for gethost/peername - BSD bug ??)&n; *&t;socketpair(...SOCK_RAW..) doesn&squot;t panic the kernel.&n; *&t;BSD af_unix apparently has connect forgetting to block properly.&n; */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/major.h&gt;
macro_line|#include &lt;linux/signal.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/stat.h&gt;
macro_line|#include &lt;linux/socket.h&gt;
macro_line|#include &lt;linux/un.h&gt;
macro_line|#include &lt;linux/fcntl.h&gt;
macro_line|#include &lt;linux/termios.h&gt;
macro_line|#include &lt;linux/socket.h&gt;
macro_line|#include &lt;linux/sockios.h&gt;
macro_line|#include &lt;linux/net.h&gt;
macro_line|#include &lt;linux/in.h&gt;
macro_line|#include &lt;linux/fs.h&gt;
macro_line|#include &lt;linux/malloc.h&gt;
macro_line|#include &lt;asm/segment.h&gt;
macro_line|#include &lt;linux/skbuff.h&gt;
macro_line|#include &lt;linux/netdevice.h&gt;
macro_line|#include &lt;net/sock.h&gt;
macro_line|#include &lt;net/tcp.h&gt;
macro_line|#include &lt;net/af_unix.h&gt;
macro_line|#include &lt;linux/proc_fs.h&gt;
DECL|variable|unix_socket_list
id|unix_socket
op_star
id|unix_socket_list
op_assign
l_int|NULL
suffix:semicolon
DECL|macro|min
mdefine_line|#define min(a,b)&t;(((a)&lt;(b))?(a):(b))
multiline_comment|/*&n; *&t;Make sure the unix name is null-terminated.&n; */
DECL|function|unix_mkname
r_static
r_inline
r_void
id|unix_mkname
c_func
(paren
r_struct
id|sockaddr_un
op_star
id|sunaddr
comma
r_int
r_int
id|len
)paren
(brace
r_if
c_cond
(paren
id|len
op_ge
r_sizeof
(paren
op_star
id|sunaddr
)paren
)paren
id|len
op_assign
r_sizeof
(paren
op_star
id|sunaddr
)paren
op_minus
l_int|1
suffix:semicolon
(paren
(paren
r_char
op_star
)paren
id|sunaddr
)paren
(braket
id|len
)braket
op_assign
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;Note: Sockets may not be removed _during_ an interrupt or net_bh&n; *&t;handler using this technique. They can be added although we do not&n; *&t;use this facility.&n; */
DECL|function|unix_remove_socket
r_static
r_void
id|unix_remove_socket
c_func
(paren
id|unix_socket
op_star
id|sk
)paren
(brace
id|unix_socket
op_star
op_star
id|s
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|s
op_assign
op_amp
id|unix_socket_list
suffix:semicolon
r_while
c_loop
(paren
op_star
id|s
op_ne
l_int|NULL
)paren
(brace
r_if
c_cond
(paren
op_star
id|s
op_eq
id|sk
)paren
(brace
op_star
id|s
op_assign
id|sk-&gt;next
suffix:semicolon
id|sti
c_func
(paren
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|s
op_assign
op_amp
(paren
(paren
op_star
id|s
)paren
op_member_access_from_pointer
id|next
)paren
suffix:semicolon
)brace
id|sti
c_func
(paren
)paren
suffix:semicolon
)brace
DECL|function|unix_insert_socket
r_static
r_void
id|unix_insert_socket
c_func
(paren
id|unix_socket
op_star
id|sk
)paren
(brace
id|cli
c_func
(paren
)paren
suffix:semicolon
id|sk-&gt;next
op_assign
id|unix_socket_list
suffix:semicolon
id|unix_socket_list
op_assign
id|sk
suffix:semicolon
id|sti
c_func
(paren
)paren
suffix:semicolon
)brace
DECL|function|unix_find_socket
r_static
id|unix_socket
op_star
id|unix_find_socket
c_func
(paren
r_struct
id|inode
op_star
id|i
)paren
(brace
id|unix_socket
op_star
id|s
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|s
op_assign
id|unix_socket_list
suffix:semicolon
r_while
c_loop
(paren
id|s
)paren
(brace
r_if
c_cond
(paren
id|s-&gt;protinfo.af_unix.inode
op_eq
id|i
)paren
(brace
id|sti
c_func
(paren
)paren
suffix:semicolon
r_return
id|s
suffix:semicolon
)brace
id|s
op_assign
id|s-&gt;next
suffix:semicolon
)brace
id|sti
c_func
(paren
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;Delete a unix socket. We have to allow for deferring this on a timer.&n; */
DECL|function|unix_destroy_timer
r_static
r_void
id|unix_destroy_timer
c_func
(paren
r_int
r_int
id|data
)paren
(brace
id|unix_socket
op_star
id|sk
op_assign
(paren
id|unix_socket
op_star
)paren
id|data
suffix:semicolon
r_if
c_cond
(paren
id|sk-&gt;protinfo.af_unix.locks
op_eq
l_int|0
op_logical_and
id|sk-&gt;wmem_alloc
op_eq
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|sk-&gt;protinfo.af_unix.name
)paren
(brace
id|kfree
c_func
(paren
id|sk-&gt;protinfo.af_unix.name
)paren
suffix:semicolon
)brace
id|sk_free
c_func
(paren
id|sk
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/*&n;&t; *&t;Retry;&n;&t; */
id|sk-&gt;timer.expires
op_assign
id|jiffies
op_plus
l_int|10
op_star
id|HZ
suffix:semicolon
multiline_comment|/* No real hurry try it every 10 seconds or so */
id|add_timer
c_func
(paren
op_amp
id|sk-&gt;timer
)paren
suffix:semicolon
)brace
DECL|function|unix_delayed_delete
r_static
r_void
id|unix_delayed_delete
c_func
(paren
id|unix_socket
op_star
id|sk
)paren
(brace
id|sk-&gt;timer.data
op_assign
(paren
r_int
r_int
)paren
id|sk
suffix:semicolon
id|sk-&gt;timer.expires
op_assign
id|jiffies
op_plus
id|HZ
suffix:semicolon
multiline_comment|/* Normally 1 second after will clean up. After that we try every 10 */
id|sk-&gt;timer.function
op_assign
id|unix_destroy_timer
suffix:semicolon
id|add_timer
c_func
(paren
op_amp
id|sk-&gt;timer
)paren
suffix:semicolon
)brace
DECL|function|unix_destroy_socket
r_static
r_void
id|unix_destroy_socket
c_func
(paren
id|unix_socket
op_star
id|sk
)paren
(brace
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
id|unix_remove_socket
c_func
(paren
id|sk
)paren
suffix:semicolon
r_while
c_loop
(paren
(paren
id|skb
op_assign
id|skb_dequeue
c_func
(paren
op_amp
id|sk-&gt;receive_queue
)paren
)paren
op_ne
l_int|NULL
)paren
(brace
r_if
c_cond
(paren
id|sk-&gt;state
op_eq
id|TCP_LISTEN
)paren
(brace
id|unix_socket
op_star
id|osk
op_assign
id|skb-&gt;sk
suffix:semicolon
id|osk-&gt;state
op_assign
id|TCP_CLOSE
suffix:semicolon
id|kfree_skb
c_func
(paren
id|skb
comma
id|FREE_WRITE
)paren
suffix:semicolon
multiline_comment|/* Now surplus - free the skb first before the socket */
id|osk
op_member_access_from_pointer
id|state_change
c_func
(paren
id|osk
)paren
suffix:semicolon
multiline_comment|/* So the connect wakes and cleans up (if any) */
multiline_comment|/* osk will be destroyed when it gets to close or the timer fires */
)brace
r_else
(brace
multiline_comment|/* passed fds are erased in the kfree_skb hook */
id|kfree_skb
c_func
(paren
id|skb
comma
id|FREE_WRITE
)paren
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|sk-&gt;protinfo.af_unix.inode
op_ne
l_int|NULL
)paren
(brace
id|iput
c_func
(paren
id|sk-&gt;protinfo.af_unix.inode
)paren
suffix:semicolon
id|sk-&gt;protinfo.af_unix.inode
op_assign
l_int|NULL
suffix:semicolon
)brace
r_if
c_cond
(paren
op_decrement
id|sk-&gt;protinfo.af_unix.locks
op_eq
l_int|0
op_logical_and
id|sk-&gt;wmem_alloc
op_eq
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|sk-&gt;protinfo.af_unix.name
)paren
(brace
id|kfree
c_func
(paren
id|sk-&gt;protinfo.af_unix.name
)paren
suffix:semicolon
)brace
id|sk_free
c_func
(paren
id|sk
)paren
suffix:semicolon
)brace
r_else
(brace
id|sk-&gt;dead
op_assign
l_int|1
suffix:semicolon
id|unix_delayed_delete
c_func
(paren
id|sk
)paren
suffix:semicolon
multiline_comment|/* Try every so often until buffers are all freed */
)brace
)brace
multiline_comment|/*&n; *&t;Fixme: We need async I/O on AF_UNIX doing next.&n; */
DECL|function|unix_fcntl
r_static
r_int
id|unix_fcntl
c_func
(paren
r_struct
id|socket
op_star
id|sock
comma
r_int
r_int
id|cmd
comma
r_int
r_int
id|arg
)paren
(brace
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;Yes socket options work with the new unix domain socketry!!!!!!!&n; */
DECL|function|unix_setsockopt
r_static
r_int
id|unix_setsockopt
c_func
(paren
r_struct
id|socket
op_star
id|sock
comma
r_int
id|level
comma
r_int
id|optname
comma
r_char
op_star
id|optval
comma
r_int
id|optlen
)paren
(brace
id|unix_socket
op_star
id|sk
op_assign
id|sock-&gt;data
suffix:semicolon
r_if
c_cond
(paren
id|level
op_ne
id|SOL_SOCKET
)paren
(brace
r_return
op_minus
id|EOPNOTSUPP
suffix:semicolon
)brace
r_return
id|sock_setsockopt
c_func
(paren
id|sk
comma
id|level
comma
id|optname
comma
id|optval
comma
id|optlen
)paren
suffix:semicolon
)brace
DECL|function|unix_getsockopt
r_static
r_int
id|unix_getsockopt
c_func
(paren
r_struct
id|socket
op_star
id|sock
comma
r_int
id|level
comma
r_int
id|optname
comma
r_char
op_star
id|optval
comma
r_int
op_star
id|optlen
)paren
(brace
id|unix_socket
op_star
id|sk
op_assign
id|sock-&gt;data
suffix:semicolon
r_if
c_cond
(paren
id|level
op_ne
id|SOL_SOCKET
)paren
(brace
r_return
op_minus
id|EOPNOTSUPP
suffix:semicolon
)brace
r_return
id|sock_getsockopt
c_func
(paren
id|sk
comma
id|level
comma
id|optname
comma
id|optval
comma
id|optlen
)paren
suffix:semicolon
)brace
DECL|function|unix_listen
r_static
r_int
id|unix_listen
c_func
(paren
r_struct
id|socket
op_star
id|sock
comma
r_int
id|backlog
)paren
(brace
id|unix_socket
op_star
id|sk
op_assign
id|sock-&gt;data
suffix:semicolon
r_if
c_cond
(paren
id|sk-&gt;type
op_ne
id|SOCK_STREAM
)paren
(brace
r_return
op_minus
id|EOPNOTSUPP
suffix:semicolon
)brace
multiline_comment|/* Only stream sockets accept */
r_if
c_cond
(paren
id|sk-&gt;protinfo.af_unix.name
op_eq
l_int|NULL
)paren
(brace
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
multiline_comment|/* No listens on an unbound socket */
id|sk-&gt;max_ack_backlog
op_assign
id|backlog
suffix:semicolon
id|sk-&gt;state
op_assign
id|TCP_LISTEN
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|def_callback1
r_static
r_void
id|def_callback1
c_func
(paren
r_struct
id|sock
op_star
id|sk
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|sk-&gt;dead
)paren
(brace
id|wake_up_interruptible
c_func
(paren
id|sk-&gt;sleep
)paren
suffix:semicolon
)brace
)brace
DECL|function|def_callback2
r_static
r_void
id|def_callback2
c_func
(paren
r_struct
id|sock
op_star
id|sk
comma
r_int
id|len
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|sk-&gt;dead
)paren
(brace
id|wake_up_interruptible
c_func
(paren
id|sk-&gt;sleep
)paren
suffix:semicolon
id|sock_wake_async
c_func
(paren
id|sk-&gt;socket
comma
l_int|1
)paren
suffix:semicolon
)brace
)brace
DECL|function|def_callback3
r_static
r_void
id|def_callback3
c_func
(paren
r_struct
id|sock
op_star
id|sk
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|sk-&gt;dead
)paren
(brace
id|wake_up_interruptible
c_func
(paren
id|sk-&gt;sleep
)paren
suffix:semicolon
id|sock_wake_async
c_func
(paren
id|sk-&gt;socket
comma
l_int|2
)paren
suffix:semicolon
)brace
)brace
DECL|function|unix_create
r_static
r_int
id|unix_create
c_func
(paren
r_struct
id|socket
op_star
id|sock
comma
r_int
id|protocol
)paren
(brace
id|unix_socket
op_star
id|sk
suffix:semicolon
r_if
c_cond
(paren
id|protocol
op_logical_and
id|protocol
op_ne
id|PF_UNIX
)paren
(brace
r_return
op_minus
id|EPROTONOSUPPORT
suffix:semicolon
)brace
id|sk
op_assign
(paren
id|unix_socket
op_star
)paren
id|sk_alloc
c_func
(paren
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sk
op_eq
l_int|NULL
)paren
(brace
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
r_switch
c_cond
(paren
id|sock-&gt;type
)paren
(brace
r_case
id|SOCK_STREAM
suffix:colon
r_break
suffix:semicolon
multiline_comment|/*&n;&t;&t; *&t;Believe it or not BSD has AF_UNIX, SOCK_RAW though&n;&t;&t; *&t;nothing uses it.&n;&t;&t; */
r_case
id|SOCK_RAW
suffix:colon
id|sock-&gt;type
op_assign
id|SOCK_DGRAM
suffix:semicolon
r_case
id|SOCK_DGRAM
suffix:colon
r_break
suffix:semicolon
r_default
suffix:colon
id|sk_free
c_func
(paren
id|sk
)paren
suffix:semicolon
r_return
op_minus
id|ESOCKTNOSUPPORT
suffix:semicolon
)brace
id|sk-&gt;type
op_assign
id|sock-&gt;type
suffix:semicolon
id|init_timer
c_func
(paren
op_amp
id|sk-&gt;timer
)paren
suffix:semicolon
id|skb_queue_head_init
c_func
(paren
op_amp
id|sk-&gt;write_queue
)paren
suffix:semicolon
id|skb_queue_head_init
c_func
(paren
op_amp
id|sk-&gt;receive_queue
)paren
suffix:semicolon
id|skb_queue_head_init
c_func
(paren
op_amp
id|sk-&gt;back_log
)paren
suffix:semicolon
id|sk-&gt;protinfo.af_unix.family
op_assign
id|AF_UNIX
suffix:semicolon
id|sk-&gt;protinfo.af_unix.inode
op_assign
l_int|NULL
suffix:semicolon
id|sk-&gt;protinfo.af_unix.locks
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* Us */
id|sk-&gt;protinfo.af_unix.readsem
op_assign
id|MUTEX
suffix:semicolon
multiline_comment|/* single task reading lock */
id|sk-&gt;rcvbuf
op_assign
id|SK_RMEM_MAX
suffix:semicolon
id|sk-&gt;sndbuf
op_assign
id|SK_WMEM_MAX
suffix:semicolon
id|sk-&gt;allocation
op_assign
id|GFP_KERNEL
suffix:semicolon
id|sk-&gt;state
op_assign
id|TCP_CLOSE
suffix:semicolon
id|sk-&gt;priority
op_assign
id|SOPRI_NORMAL
suffix:semicolon
id|sk-&gt;state_change
op_assign
id|def_callback1
suffix:semicolon
id|sk-&gt;data_ready
op_assign
id|def_callback2
suffix:semicolon
id|sk-&gt;write_space
op_assign
id|def_callback3
suffix:semicolon
id|sk-&gt;error_report
op_assign
id|def_callback1
suffix:semicolon
id|sk-&gt;mtu
op_assign
l_int|4096
suffix:semicolon
id|sk-&gt;socket
op_assign
id|sock
suffix:semicolon
id|sock-&gt;data
op_assign
(paren
r_void
op_star
)paren
id|sk
suffix:semicolon
id|sk-&gt;sleep
op_assign
id|sock-&gt;wait
suffix:semicolon
id|unix_insert_socket
c_func
(paren
id|sk
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|unix_dup
r_static
r_int
id|unix_dup
c_func
(paren
r_struct
id|socket
op_star
id|newsock
comma
r_struct
id|socket
op_star
id|oldsock
)paren
(brace
r_return
id|unix_create
c_func
(paren
id|newsock
comma
l_int|0
)paren
suffix:semicolon
)brace
DECL|function|unix_release
r_static
r_int
id|unix_release
c_func
(paren
r_struct
id|socket
op_star
id|sock
comma
r_struct
id|socket
op_star
id|peer
)paren
(brace
id|unix_socket
op_star
id|sk
op_assign
id|sock-&gt;data
suffix:semicolon
id|unix_socket
op_star
id|skpair
suffix:semicolon
multiline_comment|/* May not have data attached */
r_if
c_cond
(paren
id|sk
op_eq
l_int|NULL
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
id|sk
op_member_access_from_pointer
id|state_change
c_func
(paren
id|sk
)paren
suffix:semicolon
id|sk-&gt;dead
op_assign
l_int|1
suffix:semicolon
id|skpair
op_assign
(paren
id|unix_socket
op_star
)paren
id|sk-&gt;protinfo.af_unix.other
suffix:semicolon
multiline_comment|/* Person we send to (default) */
r_if
c_cond
(paren
id|sk-&gt;type
op_eq
id|SOCK_STREAM
op_logical_and
id|skpair
op_ne
l_int|NULL
op_logical_and
id|skpair-&gt;state
op_ne
id|TCP_LISTEN
)paren
(brace
id|skpair-&gt;shutdown
op_assign
id|SHUTDOWN_MASK
suffix:semicolon
multiline_comment|/* No more writes */
id|skpair
op_member_access_from_pointer
id|state_change
c_func
(paren
id|skpair
)paren
suffix:semicolon
multiline_comment|/* Wake any blocked writes */
)brace
r_if
c_cond
(paren
id|skpair
op_ne
l_int|NULL
)paren
(brace
id|skpair-&gt;protinfo.af_unix.locks
op_decrement
suffix:semicolon
)brace
multiline_comment|/* It may now die */
id|sk-&gt;protinfo.af_unix.other
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/* No pair */
id|unix_destroy_socket
c_func
(paren
id|sk
)paren
suffix:semicolon
multiline_comment|/* Try to flush out this socket. Throw out buffers at least */
id|unix_gc
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* Garbage collect fds */
multiline_comment|/*&n;&t; *&t;FIXME: BSD difference: In BSD all sockets connected to use get ECONNRESET and we die on the spot. In&n;&t; *&t;Linux we behave like files and pipes do and wait for the last dereference.&n;&t; */
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|unix_find_other
r_static
id|unix_socket
op_star
id|unix_find_other
c_func
(paren
r_char
op_star
id|path
comma
r_int
op_star
id|error
)paren
(brace
r_int
id|old_fs
suffix:semicolon
r_int
id|err
suffix:semicolon
r_struct
id|inode
op_star
id|inode
suffix:semicolon
id|unix_socket
op_star
id|u
suffix:semicolon
id|old_fs
op_assign
id|get_fs
c_func
(paren
)paren
suffix:semicolon
id|set_fs
c_func
(paren
id|get_ds
c_func
(paren
)paren
)paren
suffix:semicolon
id|err
op_assign
id|open_namei
c_func
(paren
id|path
comma
l_int|2
comma
id|S_IFSOCK
comma
op_amp
id|inode
comma
l_int|NULL
)paren
suffix:semicolon
id|set_fs
c_func
(paren
id|old_fs
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
OL
l_int|0
)paren
(brace
op_star
id|error
op_assign
id|err
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
id|u
op_assign
id|unix_find_socket
c_func
(paren
id|inode
)paren
suffix:semicolon
id|iput
c_func
(paren
id|inode
)paren
suffix:semicolon
r_if
c_cond
(paren
id|u
op_eq
l_int|NULL
)paren
(brace
op_star
id|error
op_assign
op_minus
id|ECONNREFUSED
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
r_return
id|u
suffix:semicolon
)brace
DECL|function|unix_bind
r_static
r_int
id|unix_bind
c_func
(paren
r_struct
id|socket
op_star
id|sock
comma
r_struct
id|sockaddr
op_star
id|uaddr
comma
r_int
id|addr_len
)paren
(brace
r_struct
id|sockaddr_un
op_star
id|sunaddr
op_assign
(paren
r_struct
id|sockaddr_un
op_star
)paren
id|uaddr
suffix:semicolon
id|unix_socket
op_star
id|sk
op_assign
id|sock-&gt;data
suffix:semicolon
r_int
id|old_fs
suffix:semicolon
r_int
id|err
suffix:semicolon
r_if
c_cond
(paren
id|sk-&gt;protinfo.af_unix.name
)paren
(brace
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
multiline_comment|/* Already bound */
r_if
c_cond
(paren
id|addr_len
OG
r_sizeof
(paren
r_struct
id|sockaddr_un
)paren
op_logical_or
id|addr_len
OL
l_int|3
op_logical_or
id|sunaddr-&gt;sun_family
op_ne
id|AF_UNIX
)paren
(brace
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|unix_mkname
c_func
(paren
id|sunaddr
comma
id|addr_len
)paren
suffix:semicolon
multiline_comment|/*&n;&t; *&t;Put ourselves in the filesystem&n;&t; */
r_if
c_cond
(paren
id|sk-&gt;protinfo.af_unix.inode
op_ne
l_int|NULL
)paren
(brace
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|sk-&gt;protinfo.af_unix.name
op_assign
id|kmalloc
c_func
(paren
id|addr_len
op_plus
l_int|1
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sk-&gt;protinfo.af_unix.name
op_eq
l_int|NULL
)paren
(brace
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|memcpy
c_func
(paren
id|sk-&gt;protinfo.af_unix.name
comma
id|sunaddr-&gt;sun_path
comma
id|addr_len
op_plus
l_int|1
)paren
suffix:semicolon
id|old_fs
op_assign
id|get_fs
c_func
(paren
)paren
suffix:semicolon
id|set_fs
c_func
(paren
id|get_ds
c_func
(paren
)paren
)paren
suffix:semicolon
id|err
op_assign
id|do_mknod
c_func
(paren
id|sk-&gt;protinfo.af_unix.name
comma
id|S_IFSOCK
op_or
id|S_IRWXUGO
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
op_eq
l_int|0
)paren
(brace
id|err
op_assign
id|open_namei
c_func
(paren
id|sk-&gt;protinfo.af_unix.name
comma
l_int|2
comma
id|S_IFSOCK
comma
op_amp
id|sk-&gt;protinfo.af_unix.inode
comma
l_int|NULL
)paren
suffix:semicolon
)brace
id|set_fs
c_func
(paren
id|old_fs
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
OL
l_int|0
)paren
(brace
id|kfree_s
c_func
(paren
id|sk-&gt;protinfo.af_unix.name
comma
id|addr_len
op_plus
l_int|1
)paren
suffix:semicolon
id|sk-&gt;protinfo.af_unix.name
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
id|err
op_eq
op_minus
id|EEXIST
)paren
(brace
r_return
op_minus
id|EADDRINUSE
suffix:semicolon
)brace
r_else
r_return
id|err
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|unix_connect
r_static
r_int
id|unix_connect
c_func
(paren
r_struct
id|socket
op_star
id|sock
comma
r_struct
id|sockaddr
op_star
id|uaddr
comma
r_int
id|addr_len
comma
r_int
id|flags
)paren
(brace
id|unix_socket
op_star
id|sk
op_assign
id|sock-&gt;data
suffix:semicolon
r_struct
id|sockaddr_un
op_star
id|sunaddr
op_assign
(paren
r_struct
id|sockaddr_un
op_star
)paren
id|uaddr
suffix:semicolon
id|unix_socket
op_star
id|other
suffix:semicolon
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
r_int
id|err
suffix:semicolon
r_if
c_cond
(paren
id|sk-&gt;type
op_eq
id|SOCK_STREAM
op_logical_and
id|sk-&gt;protinfo.af_unix.other
)paren
(brace
r_if
c_cond
(paren
id|sock-&gt;state
op_eq
id|SS_CONNECTING
op_logical_and
id|sk-&gt;state
op_eq
id|TCP_ESTABLISHED
)paren
(brace
id|sock-&gt;state
op_assign
id|SS_CONNECTED
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|sock-&gt;state
op_eq
id|SS_CONNECTING
op_logical_and
id|sk-&gt;state
op_eq
id|TCP_CLOSE
)paren
(brace
id|sock-&gt;state
op_assign
id|SS_UNCONNECTED
suffix:semicolon
r_return
op_minus
id|ECONNREFUSED
suffix:semicolon
)brace
r_if
c_cond
(paren
id|sock-&gt;state
op_ne
id|SS_CONNECTING
)paren
(brace
r_return
op_minus
id|EISCONN
suffix:semicolon
)brace
r_if
c_cond
(paren
id|flags
op_amp
id|O_NONBLOCK
)paren
(brace
r_return
op_minus
id|EALREADY
suffix:semicolon
)brace
multiline_comment|/*&n;&t;&t; *&t;Drop through the connect up logic to the wait.&n;&t;&t; */
)brace
r_if
c_cond
(paren
id|addr_len
OL
r_sizeof
(paren
id|sunaddr-&gt;sun_family
)paren
op_plus
l_int|1
op_logical_or
id|sunaddr-&gt;sun_family
op_ne
id|AF_UNIX
)paren
(brace
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|unix_mkname
c_func
(paren
id|sunaddr
comma
id|addr_len
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sk-&gt;type
op_eq
id|SOCK_DGRAM
)paren
(brace
r_if
c_cond
(paren
id|sk-&gt;protinfo.af_unix.other
)paren
(brace
id|sk-&gt;protinfo.af_unix.other-&gt;protinfo.af_unix.locks
op_decrement
suffix:semicolon
id|sk-&gt;protinfo.af_unix.other
op_assign
l_int|NULL
suffix:semicolon
id|sock-&gt;state
op_assign
id|SS_UNCONNECTED
suffix:semicolon
)brace
id|other
op_assign
id|unix_find_other
c_func
(paren
id|sunaddr-&gt;sun_path
comma
op_amp
id|err
)paren
suffix:semicolon
r_if
c_cond
(paren
id|other
op_eq
l_int|NULL
)paren
(brace
r_return
id|err
suffix:semicolon
)brace
r_if
c_cond
(paren
id|other-&gt;type
op_ne
id|sk-&gt;type
)paren
(brace
r_return
op_minus
id|EPROTOTYPE
suffix:semicolon
)brace
id|other-&gt;protinfo.af_unix.locks
op_increment
suffix:semicolon
id|sk-&gt;protinfo.af_unix.other
op_assign
id|other
suffix:semicolon
id|sock-&gt;state
op_assign
id|SS_CONNECTED
suffix:semicolon
id|sk-&gt;state
op_assign
id|TCP_ESTABLISHED
suffix:semicolon
r_return
l_int|0
suffix:semicolon
multiline_comment|/* Done */
)brace
r_if
c_cond
(paren
id|sock-&gt;state
op_eq
id|SS_UNCONNECTED
)paren
(brace
multiline_comment|/*&n;&t;&t; *&t;Now ready to connect&n;&t;&t; */
id|skb
op_assign
id|sock_alloc_send_skb
c_func
(paren
id|sk
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
op_amp
id|err
)paren
suffix:semicolon
multiline_comment|/* Marker object */
r_if
c_cond
(paren
id|skb
op_eq
l_int|NULL
)paren
(brace
r_return
id|err
suffix:semicolon
)brace
id|skb-&gt;sk
op_assign
id|sk
suffix:semicolon
multiline_comment|/* So they know it is us */
id|skb-&gt;free
op_assign
l_int|1
suffix:semicolon
id|sk-&gt;state
op_assign
id|TCP_CLOSE
suffix:semicolon
id|unix_mkname
c_func
(paren
id|sunaddr
comma
id|addr_len
)paren
suffix:semicolon
id|other
op_assign
id|unix_find_other
c_func
(paren
id|sunaddr-&gt;sun_path
comma
op_amp
id|err
)paren
suffix:semicolon
r_if
c_cond
(paren
id|other
op_eq
l_int|NULL
)paren
(brace
id|kfree_skb
c_func
(paren
id|skb
comma
id|FREE_WRITE
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
r_if
c_cond
(paren
id|other-&gt;type
op_ne
id|sk-&gt;type
)paren
(brace
id|kfree_skb
c_func
(paren
id|skb
comma
id|FREE_WRITE
)paren
suffix:semicolon
r_return
op_minus
id|EPROTOTYPE
suffix:semicolon
)brace
id|other-&gt;protinfo.af_unix.locks
op_increment
suffix:semicolon
multiline_comment|/* Lock the other socket so it doesn&squot;t run off for a moment */
id|other-&gt;ack_backlog
op_increment
suffix:semicolon
id|sk-&gt;protinfo.af_unix.other
op_assign
id|other
suffix:semicolon
id|skb_queue_tail
c_func
(paren
op_amp
id|other-&gt;receive_queue
comma
id|skb
)paren
suffix:semicolon
id|sk-&gt;state
op_assign
id|TCP_SYN_SENT
suffix:semicolon
id|sock-&gt;state
op_assign
id|SS_CONNECTING
suffix:semicolon
id|sti
c_func
(paren
)paren
suffix:semicolon
id|other
op_member_access_from_pointer
id|data_ready
c_func
(paren
id|other
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* Wake up ! */
)brace
multiline_comment|/* Wait for an accept */
id|cli
c_func
(paren
)paren
suffix:semicolon
r_while
c_loop
(paren
id|sk-&gt;state
op_eq
id|TCP_SYN_SENT
)paren
(brace
r_if
c_cond
(paren
id|flags
op_amp
id|O_NONBLOCK
)paren
(brace
id|sti
c_func
(paren
)paren
suffix:semicolon
r_return
op_minus
id|EINPROGRESS
suffix:semicolon
)brace
id|interruptible_sleep_on
c_func
(paren
id|sk-&gt;sleep
)paren
suffix:semicolon
r_if
c_cond
(paren
id|current-&gt;signal
op_amp
op_complement
id|current-&gt;blocked
)paren
(brace
id|sti
c_func
(paren
)paren
suffix:semicolon
r_return
op_minus
id|ERESTARTSYS
suffix:semicolon
)brace
)brace
multiline_comment|/*&n;&t; *&t;Has the other end closed on us ?&n;&t; */
r_if
c_cond
(paren
id|sk-&gt;state
op_eq
id|TCP_CLOSE
)paren
(brace
id|sk-&gt;protinfo.af_unix.other-&gt;protinfo.af_unix.locks
op_decrement
suffix:semicolon
id|sk-&gt;protinfo.af_unix.other
op_assign
l_int|NULL
suffix:semicolon
id|sock-&gt;state
op_assign
id|SS_UNCONNECTED
suffix:semicolon
id|sti
c_func
(paren
)paren
suffix:semicolon
r_return
op_minus
id|ECONNREFUSED
suffix:semicolon
)brace
multiline_comment|/*&n;&t; *&t;Amazingly it has worked&n;&t; */
id|sock-&gt;state
op_assign
id|SS_CONNECTED
suffix:semicolon
id|sti
c_func
(paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|unix_socketpair
r_static
r_int
id|unix_socketpair
c_func
(paren
r_struct
id|socket
op_star
id|a
comma
r_struct
id|socket
op_star
id|b
)paren
(brace
id|unix_socket
op_star
id|ska
comma
op_star
id|skb
suffix:semicolon
id|ska
op_assign
id|a-&gt;data
suffix:semicolon
id|skb
op_assign
id|b-&gt;data
suffix:semicolon
multiline_comment|/* Join our sockets back to back */
id|ska-&gt;protinfo.af_unix.locks
op_increment
suffix:semicolon
id|skb-&gt;protinfo.af_unix.locks
op_increment
suffix:semicolon
id|ska-&gt;protinfo.af_unix.other
op_assign
id|skb
suffix:semicolon
id|skb-&gt;protinfo.af_unix.other
op_assign
id|ska
suffix:semicolon
id|ska-&gt;state
op_assign
id|TCP_ESTABLISHED
suffix:semicolon
id|skb-&gt;state
op_assign
id|TCP_ESTABLISHED
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|unix_accept
r_static
r_int
id|unix_accept
c_func
(paren
r_struct
id|socket
op_star
id|sock
comma
r_struct
id|socket
op_star
id|newsock
comma
r_int
id|flags
)paren
(brace
id|unix_socket
op_star
id|sk
op_assign
id|sock-&gt;data
suffix:semicolon
id|unix_socket
op_star
id|newsk
comma
op_star
id|tsk
suffix:semicolon
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
r_if
c_cond
(paren
id|sk-&gt;type
op_ne
id|SOCK_STREAM
)paren
(brace
r_return
op_minus
id|EOPNOTSUPP
suffix:semicolon
)brace
r_if
c_cond
(paren
id|sk-&gt;state
op_ne
id|TCP_LISTEN
)paren
(brace
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|newsk
op_assign
id|newsock-&gt;data
suffix:semicolon
r_if
c_cond
(paren
id|sk-&gt;protinfo.af_unix.name
op_ne
l_int|NULL
)paren
(brace
id|newsk-&gt;protinfo.af_unix.name
op_assign
id|kmalloc
c_func
(paren
id|strlen
c_func
(paren
id|sk-&gt;protinfo.af_unix.name
)paren
op_plus
l_int|1
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|newsk-&gt;protinfo.af_unix.name
op_eq
l_int|NULL
)paren
(brace
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|strcpy
c_func
(paren
id|newsk-&gt;protinfo.af_unix.name
comma
id|sk-&gt;protinfo.af_unix.name
)paren
suffix:semicolon
)brace
r_do
(brace
id|cli
c_func
(paren
)paren
suffix:semicolon
id|skb
op_assign
id|skb_dequeue
c_func
(paren
op_amp
id|sk-&gt;receive_queue
)paren
suffix:semicolon
r_if
c_cond
(paren
id|skb
op_eq
l_int|NULL
)paren
(brace
r_if
c_cond
(paren
id|flags
op_amp
id|O_NONBLOCK
)paren
(brace
id|sti
c_func
(paren
)paren
suffix:semicolon
r_return
op_minus
id|EAGAIN
suffix:semicolon
)brace
id|interruptible_sleep_on
c_func
(paren
id|sk-&gt;sleep
)paren
suffix:semicolon
r_if
c_cond
(paren
id|current-&gt;signal
op_amp
op_complement
id|current-&gt;blocked
)paren
(brace
id|sti
c_func
(paren
)paren
suffix:semicolon
r_return
op_minus
id|ERESTARTSYS
suffix:semicolon
)brace
id|sti
c_func
(paren
)paren
suffix:semicolon
)brace
)brace
r_while
c_loop
(paren
id|skb
op_eq
l_int|NULL
)paren
(brace
suffix:semicolon
)brace
id|tsk
op_assign
id|skb-&gt;sk
suffix:semicolon
id|kfree_skb
c_func
(paren
id|skb
comma
id|FREE_WRITE
)paren
suffix:semicolon
multiline_comment|/* The buffer is just used as a tag */
id|sk-&gt;ack_backlog
op_decrement
suffix:semicolon
id|newsk-&gt;protinfo.af_unix.other
op_assign
id|tsk
suffix:semicolon
id|tsk-&gt;protinfo.af_unix.other
op_assign
id|newsk
suffix:semicolon
id|tsk-&gt;state
op_assign
id|TCP_ESTABLISHED
suffix:semicolon
id|newsk-&gt;state
op_assign
id|TCP_ESTABLISHED
suffix:semicolon
id|newsk-&gt;protinfo.af_unix.locks
op_increment
suffix:semicolon
multiline_comment|/* Swap lock over */
id|sk-&gt;protinfo.af_unix.locks
op_decrement
suffix:semicolon
multiline_comment|/* Locked to child socket not master */
id|tsk-&gt;protinfo.af_unix.locks
op_increment
suffix:semicolon
multiline_comment|/* Back lock */
id|sti
c_func
(paren
)paren
suffix:semicolon
id|tsk
op_member_access_from_pointer
id|state_change
c_func
(paren
id|tsk
)paren
suffix:semicolon
multiline_comment|/* Wake up any sleeping connect */
id|sock_wake_async
c_func
(paren
id|tsk-&gt;socket
comma
l_int|0
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|unix_getname
r_static
r_int
id|unix_getname
c_func
(paren
r_struct
id|socket
op_star
id|sock
comma
r_struct
id|sockaddr
op_star
id|uaddr
comma
r_int
op_star
id|uaddr_len
comma
r_int
id|peer
)paren
(brace
id|unix_socket
op_star
id|sk
op_assign
id|sock-&gt;data
suffix:semicolon
r_struct
id|sockaddr_un
op_star
id|sunaddr
op_assign
(paren
r_struct
id|sockaddr_un
op_star
)paren
id|uaddr
suffix:semicolon
r_if
c_cond
(paren
id|peer
)paren
(brace
r_if
c_cond
(paren
id|sk-&gt;protinfo.af_unix.other
op_eq
l_int|NULL
)paren
(brace
r_return
op_minus
id|ENOTCONN
suffix:semicolon
)brace
id|sk
op_assign
id|sk-&gt;protinfo.af_unix.other
suffix:semicolon
)brace
id|sunaddr-&gt;sun_family
op_assign
id|AF_UNIX
suffix:semicolon
r_if
c_cond
(paren
id|sk-&gt;protinfo.af_unix.name
op_eq
l_int|NULL
)paren
(brace
op_star
id|sunaddr-&gt;sun_path
op_assign
l_int|0
suffix:semicolon
op_star
id|uaddr_len
op_assign
r_sizeof
(paren
id|sunaddr-&gt;sun_family
)paren
op_plus
l_int|1
suffix:semicolon
r_return
l_int|0
suffix:semicolon
multiline_comment|/* Not bound */
)brace
op_star
id|uaddr_len
op_assign
r_sizeof
(paren
id|sunaddr-&gt;sun_family
)paren
op_plus
id|strlen
c_func
(paren
id|sk-&gt;protinfo.af_unix.name
)paren
op_plus
l_int|1
suffix:semicolon
id|strcpy
c_func
(paren
id|sunaddr-&gt;sun_path
comma
id|sk-&gt;protinfo.af_unix.name
)paren
suffix:semicolon
multiline_comment|/* 108 byte limited */
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;Support routines for struct cmsghdr handling&n; */
DECL|function|unix_copyrights
r_static
r_struct
id|cmsghdr
op_star
id|unix_copyrights
c_func
(paren
r_void
op_star
id|userp
comma
r_int
id|len
)paren
(brace
r_struct
id|cmsghdr
op_star
id|cm
suffix:semicolon
r_if
c_cond
(paren
id|len
OG
l_int|256
op_logical_or
id|len
op_le
l_int|0
)paren
(brace
r_return
l_int|NULL
suffix:semicolon
)brace
id|cm
op_assign
id|kmalloc
c_func
(paren
id|len
comma
id|GFP_KERNEL
)paren
suffix:semicolon
id|memcpy_fromfs
c_func
(paren
id|cm
comma
id|userp
comma
id|len
)paren
suffix:semicolon
r_return
id|cm
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;Return a header block&n; */
DECL|function|unix_returnrights
r_static
r_void
id|unix_returnrights
c_func
(paren
r_void
op_star
id|userp
comma
r_int
id|len
comma
r_struct
id|cmsghdr
op_star
id|cm
)paren
(brace
id|memcpy_tofs
c_func
(paren
id|userp
comma
id|cm
comma
id|len
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|cm
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;Copy file descriptors into system space.&n; *&t;Return number copied or negative error code&n; */
DECL|function|unix_fd_copy
r_static
r_int
id|unix_fd_copy
c_func
(paren
r_struct
id|sock
op_star
id|sk
comma
r_struct
id|cmsghdr
op_star
id|cmsg
comma
r_struct
id|file
op_star
op_star
id|fp
)paren
(brace
r_int
id|num
op_assign
id|cmsg-&gt;cmsg_len
op_minus
r_sizeof
(paren
r_struct
id|cmsghdr
)paren
suffix:semicolon
r_int
id|i
suffix:semicolon
r_int
op_star
id|fdp
op_assign
(paren
r_int
op_star
)paren
id|cmsg-&gt;cmsg_data
suffix:semicolon
id|num
op_div_assign
l_int|4
suffix:semicolon
multiline_comment|/* Odd bytes are forgotten in BSD not errored */
r_if
c_cond
(paren
id|num
op_ge
id|UNIX_MAX_FD
)paren
(brace
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
multiline_comment|/*&n;&t; *&t;Verify the descriptors.&n;&t; */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|num
suffix:semicolon
id|i
op_increment
)paren
(brace
r_int
id|fd
suffix:semicolon
id|fd
op_assign
id|fdp
(braket
id|i
)braket
suffix:semicolon
macro_line|#if 0
id|printk
c_func
(paren
l_string|&quot;testing  fd %d&bslash;n&quot;
comma
id|fd
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|fd
OL
l_int|0
op_logical_or
id|fd
op_ge
id|NR_OPEN
)paren
(brace
r_return
op_minus
id|EBADF
suffix:semicolon
)brace
r_if
c_cond
(paren
id|current-&gt;files-&gt;fd
(braket
id|fd
)braket
op_eq
l_int|NULL
)paren
(brace
r_return
op_minus
id|EBADF
suffix:semicolon
)brace
)brace
multiline_comment|/* add another reference to these files */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|num
suffix:semicolon
id|i
op_increment
)paren
(brace
id|fp
(braket
id|i
)braket
op_assign
id|current-&gt;files-&gt;fd
(braket
id|fdp
(braket
id|i
)braket
)braket
suffix:semicolon
id|fp
(braket
id|i
)braket
op_member_access_from_pointer
id|f_count
op_increment
suffix:semicolon
id|unix_inflight
c_func
(paren
id|fp
(braket
id|i
)braket
)paren
suffix:semicolon
)brace
r_return
id|num
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;Free the descriptors in the array&n; */
DECL|function|unix_fd_free
r_static
r_void
id|unix_fd_free
c_func
(paren
r_struct
id|sock
op_star
id|sk
comma
r_struct
id|file
op_star
op_star
id|fp
comma
r_int
id|num
)paren
(brace
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|num
suffix:semicolon
id|i
op_increment
)paren
(brace
id|close_fp
c_func
(paren
id|fp
(braket
id|i
)braket
)paren
suffix:semicolon
id|unix_notinflight
c_func
(paren
id|fp
(braket
id|i
)braket
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/*&n; *&t;Count the free descriptors available to a process. &n; *&t;Interpretation issue: Is the limit the highest descriptor (buggy&n; *&t;allowing passed fd&squot;s higher up to cause a limit to be exceeded) -&n; *&t;but how the old code did it - or like this...&n; */
DECL|function|unix_files_free
r_static
r_int
id|unix_files_free
c_func
(paren
r_void
)paren
(brace
r_int
id|i
suffix:semicolon
r_int
id|n
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|NR_OPEN
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|current-&gt;files-&gt;fd
(braket
id|i
)braket
)paren
(brace
id|n
op_increment
suffix:semicolon
)brace
)brace
id|i
op_assign
id|NR_OPEN
suffix:semicolon
r_if
c_cond
(paren
id|i
OG
id|current-&gt;rlim
(braket
id|RLIMIT_NOFILE
)braket
dot
id|rlim_cur
)paren
(brace
id|i
op_assign
id|current-&gt;rlim
(braket
id|RLIMIT_NOFILE
)braket
dot
id|rlim_cur
suffix:semicolon
)brace
r_if
c_cond
(paren
id|n
op_ge
id|i
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
r_return
id|i
op_minus
id|n
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;Perform the AF_UNIX file descriptor pass out functionality. This&n; *&t;is nasty and messy as is the whole design of BSD file passing.&n; */
DECL|function|unix_detach_fds
r_static
r_void
id|unix_detach_fds
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|cmsghdr
op_star
id|cmsg
)paren
(brace
r_int
id|i
suffix:semicolon
multiline_comment|/* count of space in parent for fds */
r_int
id|cmnum
suffix:semicolon
r_struct
id|file
op_star
op_star
id|fp
suffix:semicolon
r_struct
id|file
op_star
op_star
id|ufp
suffix:semicolon
r_int
op_star
id|cmfptr
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/* =NULL To keep gcc happy */
multiline_comment|/* number of fds actually passed */
r_int
id|fdnum
suffix:semicolon
r_int
id|ffree
suffix:semicolon
r_int
id|ufn
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|cmsg
op_eq
l_int|NULL
)paren
(brace
id|cmnum
op_assign
l_int|0
suffix:semicolon
)brace
r_else
(brace
id|cmnum
op_assign
id|cmsg-&gt;cmsg_len
op_minus
r_sizeof
(paren
r_struct
id|cmsghdr
)paren
suffix:semicolon
id|cmnum
op_div_assign
r_sizeof
(paren
r_int
)paren
suffix:semicolon
id|cmfptr
op_assign
(paren
r_int
op_star
)paren
op_amp
id|cmsg-&gt;cmsg_data
suffix:semicolon
)brace
id|memcpy
c_func
(paren
op_amp
id|fdnum
comma
id|skb-&gt;h.filp
comma
r_sizeof
(paren
r_int
)paren
)paren
suffix:semicolon
id|fp
op_assign
(paren
r_struct
id|file
op_star
op_star
)paren
(paren
id|skb-&gt;h.filp
op_plus
r_sizeof
(paren
r_int
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cmnum
OG
id|fdnum
)paren
(brace
id|cmnum
op_assign
id|fdnum
suffix:semicolon
)brace
id|ffree
op_assign
id|unix_files_free
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cmnum
OG
id|ffree
)paren
(brace
id|cmnum
op_assign
id|ffree
suffix:semicolon
)brace
id|ufp
op_assign
op_amp
id|current-&gt;files-&gt;fd
(braket
l_int|0
)braket
suffix:semicolon
multiline_comment|/*&n;&t; *&t;Copy those that fit&n;&t; */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|cmnum
suffix:semicolon
id|i
op_increment
)paren
(brace
multiline_comment|/*&n;&t;&t; *&t;Insert the fd&n;&t;&t; */
r_while
c_loop
(paren
id|ufp
(braket
id|ufn
)braket
op_ne
l_int|NULL
)paren
(brace
id|ufn
op_increment
suffix:semicolon
)brace
id|ufp
(braket
id|ufn
)braket
op_assign
id|fp
(braket
id|i
)braket
suffix:semicolon
op_star
id|cmfptr
op_increment
op_assign
id|ufn
suffix:semicolon
id|FD_CLR
c_func
(paren
id|ufn
comma
op_amp
id|current-&gt;files-&gt;close_on_exec
)paren
suffix:semicolon
id|unix_notinflight
c_func
(paren
id|fp
(braket
id|i
)braket
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;&t; *&t;Dump those that don&squot;t&n;&t; */
r_for
c_loop
(paren
suffix:semicolon
id|i
OL
id|fdnum
suffix:semicolon
id|i
op_increment
)paren
(brace
id|close_fp
c_func
(paren
id|fp
(braket
id|i
)braket
)paren
suffix:semicolon
id|unix_notinflight
c_func
(paren
id|fp
(braket
id|i
)braket
)paren
suffix:semicolon
)brace
id|kfree
c_func
(paren
id|skb-&gt;h.filp
)paren
suffix:semicolon
id|skb-&gt;h.filp
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/* no need to use destructor */
id|skb-&gt;destructor
op_assign
l_int|NULL
suffix:semicolon
)brace
DECL|function|unix_destruct_fds
r_static
r_void
id|unix_destruct_fds
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
)paren
(brace
id|unix_detach_fds
c_func
(paren
id|skb
comma
l_int|NULL
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;Attach the file descriptor array to an sk_buff&n; */
DECL|function|unix_attach_fds
r_static
r_void
id|unix_attach_fds
c_func
(paren
r_int
id|fpnum
comma
r_struct
id|file
op_star
op_star
id|fp
comma
r_struct
id|sk_buff
op_star
id|skb
)paren
(brace
id|skb-&gt;h.filp
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_int
)paren
op_plus
id|fpnum
op_star
r_sizeof
(paren
r_struct
id|file
op_star
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
multiline_comment|/* number of descriptors starts block */
id|memcpy
c_func
(paren
id|skb-&gt;h.filp
comma
op_amp
id|fpnum
comma
r_sizeof
(paren
r_int
)paren
)paren
suffix:semicolon
multiline_comment|/* actual  descriptors */
id|memcpy
c_func
(paren
id|skb-&gt;h.filp
op_plus
r_sizeof
(paren
r_int
)paren
comma
id|fp
comma
id|fpnum
op_star
r_sizeof
(paren
r_struct
id|file
op_star
)paren
)paren
suffix:semicolon
id|skb-&gt;destructor
op_assign
id|unix_destruct_fds
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;Send AF_UNIX data.&n; */
DECL|function|unix_sendmsg
r_static
r_int
id|unix_sendmsg
c_func
(paren
r_struct
id|socket
op_star
id|sock
comma
r_struct
id|msghdr
op_star
id|msg
comma
r_int
id|len
comma
r_int
id|nonblock
comma
r_int
id|flags
)paren
(brace
id|unix_socket
op_star
id|sk
op_assign
id|sock-&gt;data
suffix:semicolon
id|unix_socket
op_star
id|other
suffix:semicolon
r_struct
id|sockaddr_un
op_star
id|sunaddr
op_assign
id|msg-&gt;msg_name
suffix:semicolon
r_int
id|err
comma
id|size
suffix:semicolon
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
r_int
id|limit
op_assign
l_int|0
suffix:semicolon
r_int
id|sent
op_assign
l_int|0
suffix:semicolon
r_struct
id|file
op_star
id|fp
(braket
id|UNIX_MAX_FD
)braket
suffix:semicolon
multiline_comment|/* number of fds waiting to be passed, 0 means either&n;&t; * no fds to pass or they&squot;ve already been passed &n;&t; */
r_int
id|fpnum
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|sk-&gt;err
)paren
(brace
r_return
id|sock_error
c_func
(paren
id|sk
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|flags
op_amp
id|MSG_OOB
)paren
(brace
r_return
op_minus
id|EOPNOTSUPP
suffix:semicolon
)brace
r_if
c_cond
(paren
id|flags
)paren
multiline_comment|/* For now */
(brace
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|sunaddr
op_ne
l_int|NULL
)paren
(brace
r_if
c_cond
(paren
id|sock-&gt;type
op_eq
id|SOCK_STREAM
)paren
(brace
r_if
c_cond
(paren
id|sk-&gt;state
op_eq
id|TCP_ESTABLISHED
)paren
(brace
r_return
op_minus
id|EISCONN
suffix:semicolon
)brace
r_else
r_return
op_minus
id|EOPNOTSUPP
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|sunaddr
op_eq
l_int|NULL
)paren
(brace
r_if
c_cond
(paren
id|sk-&gt;protinfo.af_unix.other
op_eq
l_int|NULL
)paren
(brace
r_return
op_minus
id|ENOTCONN
suffix:semicolon
)brace
)brace
multiline_comment|/*&n;&t; *&t;A control message has been attached.&n;&t; */
r_if
c_cond
(paren
id|msg-&gt;msg_accrights
)paren
(brace
r_struct
id|cmsghdr
op_star
id|cm
op_assign
id|unix_copyrights
c_func
(paren
id|msg-&gt;msg_accrights
comma
id|msg-&gt;msg_accrightslen
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cm
op_eq
l_int|NULL
op_logical_or
id|msg-&gt;msg_accrightslen
OL
r_sizeof
(paren
r_struct
id|cmsghdr
)paren
op_logical_or
id|cm-&gt;cmsg_type
op_ne
id|SCM_RIGHTS
op_logical_or
id|cm-&gt;cmsg_level
op_ne
id|SOL_SOCKET
op_logical_or
id|msg-&gt;msg_accrightslen
op_ne
id|cm-&gt;cmsg_len
)paren
(brace
id|kfree
c_func
(paren
id|cm
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|fpnum
op_assign
id|unix_fd_copy
c_func
(paren
id|sk
comma
id|cm
comma
id|fp
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|cm
)paren
suffix:semicolon
r_if
c_cond
(paren
id|fpnum
OL
l_int|0
)paren
(brace
r_return
id|fpnum
suffix:semicolon
)brace
)brace
r_while
c_loop
(paren
id|sent
OL
id|len
)paren
(brace
multiline_comment|/*&n;&t;&t; *&t;Optimisation for the fact that under 0.01% of X messages typically&n;&t;&t; *&t;need breaking up.&n;&t;&t; */
id|size
op_assign
id|len
op_minus
id|sent
suffix:semicolon
r_if
c_cond
(paren
id|size
OG
(paren
id|sk-&gt;sndbuf
op_minus
r_sizeof
(paren
r_struct
id|sk_buff
)paren
)paren
op_div
l_int|2
)paren
multiline_comment|/* Keep two messages in the pipe so it schedules better */
(brace
r_if
c_cond
(paren
id|sock-&gt;type
op_eq
id|SOCK_DGRAM
)paren
(brace
id|unix_fd_free
c_func
(paren
id|sk
comma
id|fp
comma
id|fpnum
)paren
suffix:semicolon
r_return
op_minus
id|EMSGSIZE
suffix:semicolon
)brace
id|size
op_assign
(paren
id|sk-&gt;sndbuf
op_minus
r_sizeof
(paren
r_struct
id|sk_buff
)paren
)paren
op_div
l_int|2
suffix:semicolon
)brace
multiline_comment|/*&n;&t;&t; *&t;Keep to page sized kmalloc()&squot;s as various people&n;&t;&t; *&t;have suggested. Big mallocs stress the vm too&n;&t;&t; *&t;much.&n;&t;&t; */
r_if
c_cond
(paren
id|size
OG
l_int|4000
op_logical_and
id|sock-&gt;type
op_ne
id|SOCK_DGRAM
)paren
(brace
id|limit
op_assign
l_int|4000
suffix:semicolon
)brace
multiline_comment|/* Fall back to 4K if we can&squot;t grab a big buffer this instant */
r_else
id|limit
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Otherwise just grab and wait */
multiline_comment|/*&n;&t;&t; *&t;Grab a buffer&n;&t;&t; */
id|skb
op_assign
id|sock_alloc_send_skb
c_func
(paren
id|sk
comma
id|size
comma
id|limit
comma
id|nonblock
comma
op_amp
id|err
)paren
suffix:semicolon
r_if
c_cond
(paren
id|skb
op_eq
l_int|NULL
)paren
(brace
id|unix_fd_free
c_func
(paren
id|sk
comma
id|fp
comma
id|fpnum
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sent
)paren
(brace
id|sk-&gt;err
op_assign
op_minus
id|err
suffix:semicolon
r_return
id|sent
suffix:semicolon
)brace
r_return
id|err
suffix:semicolon
)brace
id|size
op_assign
id|skb_tailroom
c_func
(paren
id|skb
)paren
suffix:semicolon
multiline_comment|/* If we dropped back on a limit then our skb is smaller */
id|skb-&gt;sk
op_assign
id|sk
suffix:semicolon
id|skb-&gt;free
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|fpnum
)paren
(brace
id|unix_attach_fds
c_func
(paren
id|fpnum
comma
id|fp
comma
id|skb
)paren
suffix:semicolon
id|fpnum
op_assign
l_int|0
suffix:semicolon
)brace
r_else
id|skb-&gt;h.filp
op_assign
l_int|NULL
suffix:semicolon
id|memcpy_fromiovec
c_func
(paren
id|skb_put
c_func
(paren
id|skb
comma
id|size
)paren
comma
id|msg-&gt;msg_iov
comma
id|size
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sunaddr
op_eq
l_int|NULL
)paren
(brace
id|other
op_assign
id|sk-&gt;protinfo.af_unix.other
suffix:semicolon
r_if
c_cond
(paren
id|sock-&gt;type
op_eq
id|SOCK_DGRAM
op_logical_and
id|other-&gt;dead
)paren
(brace
id|other-&gt;protinfo.af_unix.locks
op_decrement
suffix:semicolon
id|sk-&gt;protinfo.af_unix.other
op_assign
l_int|NULL
suffix:semicolon
id|sock-&gt;state
op_assign
id|SS_UNCONNECTED
suffix:semicolon
id|sti
c_func
(paren
)paren
suffix:semicolon
id|kfree_skb
c_func
(paren
id|skb
comma
id|FREE_WRITE
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|sent
)paren
(brace
r_return
op_minus
id|ECONNRESET
suffix:semicolon
)brace
r_else
r_return
id|sent
suffix:semicolon
)brace
)brace
r_else
(brace
id|unix_mkname
c_func
(paren
id|sunaddr
comma
id|msg-&gt;msg_namelen
)paren
suffix:semicolon
id|other
op_assign
id|unix_find_other
c_func
(paren
id|sunaddr-&gt;sun_path
comma
op_amp
id|err
)paren
suffix:semicolon
r_if
c_cond
(paren
id|other
op_eq
l_int|NULL
)paren
(brace
id|sti
c_func
(paren
)paren
suffix:semicolon
id|kfree_skb
c_func
(paren
id|skb
comma
id|FREE_WRITE
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sent
)paren
(brace
r_return
id|sent
suffix:semicolon
)brace
r_else
r_return
id|err
suffix:semicolon
)brace
)brace
id|skb_queue_tail
c_func
(paren
op_amp
id|other-&gt;receive_queue
comma
id|skb
)paren
suffix:semicolon
id|sti
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* if we sent an fd, only do it once */
id|other
op_member_access_from_pointer
id|data_ready
c_func
(paren
id|other
comma
id|size
)paren
suffix:semicolon
id|sent
op_add_assign
id|size
suffix:semicolon
)brace
r_return
id|sent
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;Sleep until data has arrive. But check for races..&n; */
DECL|function|unix_data_wait
r_static
r_void
id|unix_data_wait
c_func
(paren
id|unix_socket
op_star
id|sk
)paren
(brace
id|cli
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|skb_peek
c_func
(paren
op_amp
id|sk-&gt;receive_queue
)paren
)paren
(brace
id|sk-&gt;socket-&gt;flags
op_or_assign
id|SO_WAITDATA
suffix:semicolon
id|interruptible_sleep_on
c_func
(paren
id|sk-&gt;sleep
)paren
suffix:semicolon
id|sk-&gt;socket-&gt;flags
op_and_assign
op_complement
id|SO_WAITDATA
suffix:semicolon
)brace
id|sti
c_func
(paren
)paren
suffix:semicolon
)brace
DECL|function|unix_recvmsg
r_static
r_int
id|unix_recvmsg
c_func
(paren
r_struct
id|socket
op_star
id|sock
comma
r_struct
id|msghdr
op_star
id|msg
comma
r_int
id|size
comma
r_int
id|noblock
comma
r_int
id|flags
comma
r_int
op_star
id|addr_len
)paren
(brace
id|unix_socket
op_star
id|sk
op_assign
id|sock-&gt;data
suffix:semicolon
r_struct
id|sockaddr_un
op_star
id|sunaddr
op_assign
id|msg-&gt;msg_name
suffix:semicolon
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
r_int
id|copied
op_assign
l_int|0
suffix:semicolon
r_int
r_char
op_star
id|sp
suffix:semicolon
r_int
id|len
suffix:semicolon
r_int
id|num
suffix:semicolon
r_struct
id|iovec
op_star
id|iov
op_assign
id|msg-&gt;msg_iov
suffix:semicolon
r_struct
id|cmsghdr
op_star
id|cm
op_assign
l_int|NULL
suffix:semicolon
r_int
id|ct
op_assign
id|msg-&gt;msg_iovlen
suffix:semicolon
r_if
c_cond
(paren
id|flags
op_amp
id|MSG_OOB
)paren
(brace
r_return
op_minus
id|EOPNOTSUPP
suffix:semicolon
)brace
r_if
c_cond
(paren
id|addr_len
)paren
(brace
op_star
id|addr_len
op_assign
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|sk-&gt;err
)paren
(brace
r_return
id|sock_error
c_func
(paren
id|sk
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|msg-&gt;msg_accrights
)paren
(brace
id|cm
op_assign
id|unix_copyrights
c_func
(paren
id|msg-&gt;msg_accrights
comma
id|msg-&gt;msg_accrightslen
)paren
suffix:semicolon
r_if
c_cond
(paren
id|msg-&gt;msg_accrightslen
OL
r_sizeof
(paren
r_struct
id|cmsghdr
)paren
macro_line|#if 0 
multiline_comment|/*&t;&t;investigate this further -- Stevens example doesn&squot;t seem to care */
op_logical_or
id|cm-&gt;cmsg_type
op_ne
id|SCM_RIGHTS
op_logical_or
id|cm-&gt;cmsg_level
op_ne
id|SOL_SOCKET
op_logical_or
id|msg-&gt;msg_accrightslen
op_ne
id|cm-&gt;cmsg_len
macro_line|#endif
)paren
(brace
id|kfree
c_func
(paren
id|cm
)paren
suffix:semicolon
multiline_comment|/*&t;&t;&t;printk(&quot;recvmsg: Bad msg_accrights&bslash;n&quot;);*/
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
)brace
id|down
c_func
(paren
op_amp
id|sk-&gt;protinfo.af_unix.readsem
)paren
suffix:semicolon
multiline_comment|/* Lock the socket */
r_while
c_loop
(paren
id|ct
op_decrement
)paren
(brace
r_int
id|done
op_assign
l_int|0
suffix:semicolon
id|sp
op_assign
id|iov-&gt;iov_base
suffix:semicolon
id|len
op_assign
id|iov-&gt;iov_len
suffix:semicolon
id|iov
op_increment
suffix:semicolon
r_while
c_loop
(paren
id|done
OL
id|len
)paren
(brace
r_if
c_cond
(paren
id|copied
op_logical_and
(paren
id|flags
op_amp
id|MSG_PEEK
)paren
)paren
r_goto
id|out
suffix:semicolon
r_if
c_cond
(paren
id|copied
op_eq
id|size
)paren
r_goto
id|out
suffix:semicolon
id|skb
op_assign
id|skb_dequeue
c_func
(paren
op_amp
id|sk-&gt;receive_queue
)paren
suffix:semicolon
r_if
c_cond
(paren
id|skb
op_eq
l_int|NULL
)paren
(brace
id|up
c_func
(paren
op_amp
id|sk-&gt;protinfo.af_unix.readsem
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sk-&gt;shutdown
op_amp
id|RCV_SHUTDOWN
)paren
(brace
r_return
id|copied
suffix:semicolon
)brace
r_if
c_cond
(paren
id|copied
)paren
(brace
r_return
id|copied
suffix:semicolon
)brace
r_if
c_cond
(paren
id|noblock
)paren
(brace
r_return
op_minus
id|EAGAIN
suffix:semicolon
)brace
r_if
c_cond
(paren
id|current-&gt;signal
op_amp
op_complement
id|current-&gt;blocked
)paren
(brace
r_return
op_minus
id|ERESTARTSYS
suffix:semicolon
)brace
id|unix_data_wait
c_func
(paren
id|sk
)paren
suffix:semicolon
id|down
c_func
(paren
op_amp
id|sk-&gt;protinfo.af_unix.readsem
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
r_if
c_cond
(paren
id|msg-&gt;msg_name
op_ne
l_int|NULL
)paren
(brace
id|sunaddr-&gt;sun_family
op_assign
id|AF_UNIX
suffix:semicolon
r_if
c_cond
(paren
id|skb-&gt;sk-&gt;protinfo.af_unix.name
)paren
(brace
id|memcpy
c_func
(paren
id|sunaddr-&gt;sun_path
comma
id|skb-&gt;sk-&gt;protinfo.af_unix.name
comma
l_int|108
)paren
suffix:semicolon
r_if
c_cond
(paren
id|addr_len
)paren
(brace
op_star
id|addr_len
op_assign
id|strlen
c_func
(paren
id|sunaddr-&gt;sun_path
)paren
op_plus
r_sizeof
(paren
r_int
)paren
suffix:semicolon
)brace
)brace
r_else
r_if
c_cond
(paren
id|addr_len
)paren
(brace
op_star
id|addr_len
op_assign
r_sizeof
(paren
r_int
)paren
suffix:semicolon
)brace
)brace
id|num
op_assign
id|min
c_func
(paren
id|skb-&gt;len
comma
id|len
op_minus
id|done
)paren
suffix:semicolon
id|memcpy_tofs
c_func
(paren
id|sp
comma
id|skb-&gt;data
comma
id|num
)paren
suffix:semicolon
r_if
c_cond
(paren
id|skb-&gt;h.filp
op_ne
l_int|NULL
)paren
id|unix_detach_fds
c_func
(paren
id|skb
comma
id|cm
)paren
suffix:semicolon
id|copied
op_add_assign
id|num
suffix:semicolon
id|done
op_add_assign
id|num
suffix:semicolon
id|sp
op_add_assign
id|num
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|flags
op_amp
id|MSG_PEEK
)paren
)paren
id|skb_pull
c_func
(paren
id|skb
comma
id|num
)paren
suffix:semicolon
multiline_comment|/* put the skb back if we didn&squot;t use it up.. */
r_if
c_cond
(paren
id|skb-&gt;len
)paren
(brace
id|skb_queue_head
c_func
(paren
op_amp
id|sk-&gt;receive_queue
comma
id|skb
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
id|kfree_skb
c_func
(paren
id|skb
comma
id|FREE_WRITE
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sock-&gt;type
op_eq
id|SOCK_DGRAM
op_logical_or
id|cm
)paren
(brace
r_goto
id|out
suffix:semicolon
)brace
)brace
)brace
id|out
suffix:colon
id|up
c_func
(paren
op_amp
id|sk-&gt;protinfo.af_unix.readsem
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cm
)paren
(brace
id|unix_returnrights
c_func
(paren
id|msg-&gt;msg_accrights
comma
id|msg-&gt;msg_accrightslen
comma
id|cm
)paren
suffix:semicolon
)brace
r_return
id|copied
suffix:semicolon
)brace
DECL|function|unix_shutdown
r_static
r_int
id|unix_shutdown
c_func
(paren
r_struct
id|socket
op_star
id|sock
comma
r_int
id|mode
)paren
(brace
id|unix_socket
op_star
id|sk
op_assign
(paren
id|unix_socket
op_star
)paren
id|sock-&gt;data
suffix:semicolon
id|unix_socket
op_star
id|other
op_assign
id|sk-&gt;protinfo.af_unix.other
suffix:semicolon
r_if
c_cond
(paren
id|mode
op_amp
id|SEND_SHUTDOWN
)paren
(brace
id|sk-&gt;shutdown
op_or_assign
id|SEND_SHUTDOWN
suffix:semicolon
id|sk
op_member_access_from_pointer
id|state_change
c_func
(paren
id|sk
)paren
suffix:semicolon
r_if
c_cond
(paren
id|other
)paren
(brace
id|other-&gt;shutdown
op_or_assign
id|RCV_SHUTDOWN
suffix:semicolon
id|other
op_member_access_from_pointer
id|state_change
c_func
(paren
id|other
)paren
suffix:semicolon
)brace
)brace
id|other
op_assign
id|sk-&gt;protinfo.af_unix.other
suffix:semicolon
r_if
c_cond
(paren
id|mode
op_amp
id|RCV_SHUTDOWN
)paren
(brace
id|sk-&gt;shutdown
op_or_assign
id|RCV_SHUTDOWN
suffix:semicolon
id|sk
op_member_access_from_pointer
id|state_change
c_func
(paren
id|sk
)paren
suffix:semicolon
r_if
c_cond
(paren
id|other
)paren
(brace
id|other-&gt;shutdown
op_or_assign
id|SEND_SHUTDOWN
suffix:semicolon
id|other
op_member_access_from_pointer
id|state_change
c_func
(paren
id|other
)paren
suffix:semicolon
)brace
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|unix_select
r_static
r_int
id|unix_select
c_func
(paren
r_struct
id|socket
op_star
id|sock
comma
r_int
id|sel_type
comma
id|select_table
op_star
id|wait
)paren
(brace
r_return
id|datagram_select
c_func
(paren
id|sock-&gt;data
comma
id|sel_type
comma
id|wait
)paren
suffix:semicolon
)brace
DECL|function|unix_ioctl
r_static
r_int
id|unix_ioctl
c_func
(paren
r_struct
id|socket
op_star
id|sock
comma
r_int
r_int
id|cmd
comma
r_int
r_int
id|arg
)paren
(brace
id|unix_socket
op_star
id|sk
op_assign
id|sock-&gt;data
suffix:semicolon
r_int
id|err
suffix:semicolon
r_int
id|amount
op_assign
l_int|0
suffix:semicolon
r_switch
c_cond
(paren
id|cmd
)paren
(brace
r_case
id|TIOCOUTQ
suffix:colon
id|err
op_assign
id|verify_area
c_func
(paren
id|VERIFY_WRITE
comma
(paren
r_void
op_star
)paren
id|arg
comma
r_sizeof
(paren
r_int
r_int
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
(brace
r_return
id|err
suffix:semicolon
)brace
id|amount
op_assign
id|sk-&gt;sndbuf
op_minus
id|sk-&gt;wmem_alloc
suffix:semicolon
r_if
c_cond
(paren
id|amount
OL
l_int|0
)paren
(brace
id|amount
op_assign
l_int|0
suffix:semicolon
)brace
id|put_fs_long
c_func
(paren
id|amount
comma
(paren
r_int
r_int
op_star
)paren
id|arg
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
r_case
id|TIOCINQ
suffix:colon
(brace
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
r_if
c_cond
(paren
id|sk-&gt;state
op_eq
id|TCP_LISTEN
)paren
(brace
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
multiline_comment|/* These two are safe on a single CPU system as only user tasks fiddle here */
r_if
c_cond
(paren
(paren
id|skb
op_assign
id|skb_peek
c_func
(paren
op_amp
id|sk-&gt;receive_queue
)paren
)paren
op_ne
l_int|NULL
)paren
(brace
id|amount
op_assign
id|skb-&gt;len
suffix:semicolon
)brace
id|err
op_assign
id|verify_area
c_func
(paren
id|VERIFY_WRITE
comma
(paren
r_void
op_star
)paren
id|arg
comma
r_sizeof
(paren
r_int
r_int
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
(brace
r_return
id|err
suffix:semicolon
)brace
id|put_fs_long
c_func
(paren
id|amount
comma
(paren
r_int
r_int
op_star
)paren
id|arg
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_default
suffix:colon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
multiline_comment|/*NOTREACHED*/
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#ifdef CONFIG_PROC_FS
DECL|function|unix_get_info
r_static
r_int
id|unix_get_info
c_func
(paren
r_char
op_star
id|buffer
comma
r_char
op_star
op_star
id|start
comma
id|off_t
id|offset
comma
r_int
id|length
comma
r_int
id|dummy
)paren
(brace
id|off_t
id|pos
op_assign
l_int|0
suffix:semicolon
id|off_t
id|begin
op_assign
l_int|0
suffix:semicolon
r_int
id|len
op_assign
l_int|0
suffix:semicolon
id|unix_socket
op_star
id|s
op_assign
id|unix_socket_list
suffix:semicolon
id|len
op_add_assign
id|sprintf
c_func
(paren
id|buffer
comma
l_string|&quot;Num       RefCount Protocol Flags    Type St &quot;
l_string|&quot;Inode Path&bslash;n&quot;
)paren
suffix:semicolon
r_while
c_loop
(paren
id|s
op_ne
l_int|NULL
)paren
(brace
id|len
op_add_assign
id|sprintf
c_func
(paren
id|buffer
op_plus
id|len
comma
l_string|&quot;%p: %08X %08X %08lX %04X %02X %5ld&quot;
comma
id|s
comma
id|s-&gt;protinfo.af_unix.locks
comma
l_int|0
comma
id|s-&gt;socket-&gt;flags
comma
id|s-&gt;socket-&gt;type
comma
id|s-&gt;socket-&gt;state
comma
id|s-&gt;socket-&gt;inode
ques
c_cond
id|s-&gt;socket-&gt;inode-&gt;i_ino
suffix:colon
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|s-&gt;protinfo.af_unix.name
op_ne
l_int|NULL
)paren
(brace
id|len
op_add_assign
id|sprintf
c_func
(paren
id|buffer
op_plus
id|len
comma
l_string|&quot; %s&bslash;n&quot;
comma
id|s-&gt;protinfo.af_unix.name
)paren
suffix:semicolon
)brace
r_else
id|buffer
(braket
id|len
op_increment
)braket
op_assign
l_char|&squot;&bslash;n&squot;
suffix:semicolon
id|pos
op_assign
id|begin
op_plus
id|len
suffix:semicolon
r_if
c_cond
(paren
id|pos
OL
id|offset
)paren
(brace
id|len
op_assign
l_int|0
suffix:semicolon
id|begin
op_assign
id|pos
suffix:semicolon
)brace
r_if
c_cond
(paren
id|pos
OG
id|offset
op_plus
id|length
)paren
(brace
r_break
suffix:semicolon
)brace
id|s
op_assign
id|s-&gt;next
suffix:semicolon
)brace
op_star
id|start
op_assign
id|buffer
op_plus
(paren
id|offset
op_minus
id|begin
)paren
suffix:semicolon
id|len
op_sub_assign
(paren
id|offset
op_minus
id|begin
)paren
suffix:semicolon
r_if
c_cond
(paren
id|len
OG
id|length
)paren
(brace
id|len
op_assign
id|length
suffix:semicolon
)brace
r_return
id|len
suffix:semicolon
)brace
macro_line|#endif
DECL|variable|unix_proto_ops
r_struct
id|proto_ops
id|unix_proto_ops
op_assign
(brace
id|AF_UNIX
comma
id|unix_create
comma
id|unix_dup
comma
id|unix_release
comma
id|unix_bind
comma
id|unix_connect
comma
id|unix_socketpair
comma
id|unix_accept
comma
id|unix_getname
comma
id|unix_select
comma
id|unix_ioctl
comma
id|unix_listen
comma
id|unix_shutdown
comma
id|unix_setsockopt
comma
id|unix_getsockopt
comma
id|unix_fcntl
comma
id|unix_sendmsg
comma
id|unix_recvmsg
)brace
suffix:semicolon
DECL|function|unix_proto_init
r_void
id|unix_proto_init
c_func
(paren
r_struct
id|net_proto
op_star
id|pro
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;NET3: Unix domain sockets 0.12 for Linux NET3.035.&bslash;n&quot;
)paren
suffix:semicolon
id|sock_register
c_func
(paren
id|unix_proto_ops.family
comma
op_amp
id|unix_proto_ops
)paren
suffix:semicolon
macro_line|#ifdef CONFIG_PROC_FS
id|proc_net_register
c_func
(paren
op_amp
(paren
r_struct
id|proc_dir_entry
)paren
(brace
id|PROC_NET_UNIX
comma
l_int|4
comma
l_string|&quot;unix&quot;
comma
id|S_IFREG
op_or
id|S_IRUGO
comma
l_int|1
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
op_amp
id|proc_net_inode_operations
comma
id|unix_get_info
)brace
)paren
suffix:semicolon
macro_line|#endif
)brace
multiline_comment|/*&n; * Local variables:&n; *  compile-command: &quot;gcc -g -D__KERNEL__ -Wall -O6 -I/usr/src/linux/include -c af_unix.c&quot;&n; * End:&n; */
eof
