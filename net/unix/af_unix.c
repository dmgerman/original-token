multiline_comment|/*&n; * NET3:&t;Implementation of BSD Unix domain sockets.&n; *&n; * Authors:&t;Alan Cox, &lt;alan.cox@linux.org&gt;&n; *&n; *&t;&t;This program is free software; you can redistribute it and/or&n; *&t;&t;modify it under the terms of the GNU General Public License&n; *&t;&t;as published by the Free Software Foundation; either version&n; *&t;&t;2 of the License, or (at your option) any later version.&n; *&n; * Fixes:&n; *&t;&t;Linus Torvalds&t;:&t;Assorted bug cures.&n; *&t;&t;Niibe Yutaka&t;:&t;async I/O support.&n; *&t;&t;Carsten Paeth&t;:&t;PF_UNIX check, address fixes.&n; *&t;&t;Alan Cox&t;:&t;Limit size of allocated blocks.&n; *&t;&t;Alan Cox&t;:&t;Fixed the stupid socketpair bug.&n; *&t;&t;Alan Cox&t;:&t;BSD compatibility fine tuning.&n; *&t;&t;Alan Cox&t;:&t;Fixed a bug in connect when interrupted.&n; *&t;&t;Alan Cox&t;:&t;Sorted out a proper draft version of&n; *&t;&t;&t;&t;&t;file descriptor passing hacked up from&n; *&t;&t;&t;&t;&t;Mike Shaver&squot;s work.&n; *&t;&t;Marty Leisner&t;:&t;Fixes to fd passing&n; *&t;&t;Nick Nevin&t;:&t;recvmsg bugfix.&n; *&t;&t;Alan Cox&t;:&t;Started proper garbage collector&n; *&t;&t;Heiko EiBfeldt&t;:&t;Missing verify_area check&n; *&t;&t;Alan Cox&t;:&t;Started POSIXisms&n; *&n; * Known differences from reference BSD that was tested:&n; *&n; *&t;[TO FIX]&n; *&t;ECONNREFUSED is not returned from one end of a connected() socket to the&n; *&t;&t;other the moment one end closes.&n; *&t;fstat() doesn&squot;t return st_dev=NODEV, and give the blksize as high water mark&n; *&t;&t;and a fake inode identifier (nor the BSD first socket fstat twice bug).&n; *&t;[NOT TO FIX]&n; *&t;accept() returns a path name even if the connecting socket has closed&n; *&t;&t;in the meantime (BSD loses the path and gives up).&n; *&t;accept() returns 0 length path for an unbound connector. BSD returns 16&n; *&t;&t;and a null first byte in the path (but not for gethost/peername - BSD bug ??)&n; *&t;socketpair(...SOCK_RAW..) doesn&squot;t panic the kernel.&n; *&t;BSD af_unix apparently has connect forgetting to block properly.&n; *&t;&t;(need to check this with the POSIX spec in detail)&n; *&n; * Differences from 2.0.0-11-... (ANK)&n; *&t;Bug fixes and improvements.&n; *&t;&t;- client shutdown killed server socket.&n; *&t;&t;- removed all useless cli/sti pairs.&n; *&n; *&t;Semantic changes/extensions.&n; *&t;&t;- generic control message passing.&n; *&t;&t;- SCM_CREDENTIALS control message.&n; *&t;&t;- &quot;Abstract&quot; (not FS based) socket bindings.&n; *&t;&t;  Abstract names are sequences of bytes (not zero terminated)&n; *&t;&t;  started by 0, so that this name space does not intersect&n; *&t;&t;  with BSD names.&n; */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/major.h&gt;
macro_line|#include &lt;linux/signal.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/stat.h&gt;
macro_line|#include &lt;linux/socket.h&gt;
macro_line|#include &lt;linux/un.h&gt;
macro_line|#include &lt;linux/fcntl.h&gt;
macro_line|#include &lt;linux/termios.h&gt;
macro_line|#include &lt;linux/socket.h&gt;
macro_line|#include &lt;linux/sockios.h&gt;
macro_line|#include &lt;linux/net.h&gt;
macro_line|#include &lt;linux/in.h&gt;
macro_line|#include &lt;linux/fs.h&gt;
macro_line|#include &lt;linux/malloc.h&gt;
macro_line|#include &lt;asm/uaccess.h&gt;
macro_line|#include &lt;linux/skbuff.h&gt;
macro_line|#include &lt;linux/netdevice.h&gt;
macro_line|#include &lt;net/sock.h&gt;
macro_line|#include &lt;net/tcp.h&gt;
macro_line|#include &lt;net/af_unix.h&gt;
macro_line|#include &lt;linux/proc_fs.h&gt;
macro_line|#include &lt;net/scm.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;asm/checksum.h&gt;
DECL|macro|min
mdefine_line|#define min(a,b)&t;(((a)&lt;(b))?(a):(b))
DECL|variable|sysctl_unix_delete_delay
r_int
id|sysctl_unix_delete_delay
op_assign
id|HZ
suffix:semicolon
DECL|variable|sysctl_unix_destroy_delay
r_int
id|sysctl_unix_destroy_delay
op_assign
l_int|10
op_star
id|HZ
suffix:semicolon
DECL|variable|unix_socket_table
id|unix_socket
op_star
id|unix_socket_table
(braket
id|UNIX_HASH_SIZE
op_plus
l_int|1
)braket
suffix:semicolon
DECL|macro|unix_sockets_unbound
mdefine_line|#define unix_sockets_unbound&t;(unix_socket_table[UNIX_HASH_SIZE])
DECL|macro|UNIX_ABSTRACT
mdefine_line|#define UNIX_ABSTRACT(sk)&t;((sk)-&gt;protinfo.af_unix.addr-&gt;hash!=UNIX_HASH_SIZE)
DECL|function|unix_hash_fold
r_extern
id|__inline__
r_int
id|unix_hash_fold
c_func
(paren
r_int
id|hash
)paren
(brace
id|hash
op_xor_assign
id|hash
op_rshift
l_int|16
suffix:semicolon
id|hash
op_xor_assign
id|hash
op_rshift
l_int|8
suffix:semicolon
id|hash
op_xor_assign
id|hash
op_rshift
l_int|4
suffix:semicolon
r_return
id|hash
suffix:semicolon
)brace
DECL|macro|unix_peer
mdefine_line|#define unix_peer(sk) ((sk)-&gt;pair)
DECL|function|unix_our_peer
r_extern
id|__inline__
r_int
id|unix_our_peer
c_func
(paren
id|unix_socket
op_star
id|sk
comma
id|unix_socket
op_star
id|osk
)paren
(brace
r_return
id|unix_peer
c_func
(paren
id|osk
)paren
op_eq
id|sk
suffix:semicolon
)brace
DECL|function|unix_may_send
r_extern
id|__inline__
r_int
id|unix_may_send
c_func
(paren
id|unix_socket
op_star
id|sk
comma
id|unix_socket
op_star
id|osk
)paren
(brace
r_return
(paren
id|sk-&gt;type
op_eq
id|osk-&gt;type
)paren
suffix:semicolon
)brace
DECL|function|unix_lock
r_extern
id|__inline__
r_void
id|unix_lock
c_func
(paren
id|unix_socket
op_star
id|sk
)paren
(brace
id|sk-&gt;sock_readers
op_increment
suffix:semicolon
)brace
DECL|function|unix_unlock
r_extern
id|__inline__
r_int
id|unix_unlock
c_func
(paren
id|unix_socket
op_star
id|sk
)paren
(brace
r_return
id|sk-&gt;sock_readers
op_decrement
suffix:semicolon
)brace
DECL|function|unix_locked
r_extern
id|__inline__
r_int
id|unix_locked
c_func
(paren
id|unix_socket
op_star
id|sk
)paren
(brace
r_return
id|sk-&gt;sock_readers
suffix:semicolon
)brace
DECL|function|unix_release_addr
r_extern
id|__inline__
r_void
id|unix_release_addr
c_func
(paren
r_struct
id|unix_address
op_star
id|addr
)paren
(brace
r_if
c_cond
(paren
id|addr
)paren
(brace
r_if
c_cond
(paren
id|atomic_dec_and_test
c_func
(paren
op_amp
id|addr-&gt;refcnt
)paren
)paren
id|kfree
c_func
(paren
id|addr
)paren
suffix:semicolon
)brace
)brace
DECL|function|unix_destruct_addr
r_static
r_void
id|unix_destruct_addr
c_func
(paren
r_struct
id|sock
op_star
id|sk
)paren
(brace
r_struct
id|unix_address
op_star
id|addr
op_assign
id|sk-&gt;protinfo.af_unix.addr
suffix:semicolon
id|unix_release_addr
c_func
(paren
id|addr
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;Check unix socket name:&n; *&t;&t;- should be not zero length.&n; *&t;        - if started by not zero, should be NULL terminated (FS object)&n; *&t;&t;- if started by zero, it is abstract name.&n; */
DECL|function|unix_mkname
r_static
r_int
id|unix_mkname
c_func
(paren
r_struct
id|sockaddr_un
op_star
id|sunaddr
comma
r_int
id|len
comma
r_int
op_star
id|hashp
)paren
(brace
r_if
c_cond
(paren
id|len
op_le
r_sizeof
(paren
r_int
)paren
op_logical_or
id|len
OG
r_sizeof
(paren
op_star
id|sunaddr
)paren
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|sunaddr
op_logical_or
id|sunaddr-&gt;sun_family
op_ne
id|AF_UNIX
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|sunaddr-&gt;sun_path
(braket
l_int|0
)braket
)paren
(brace
r_if
c_cond
(paren
id|len
op_ge
r_sizeof
(paren
op_star
id|sunaddr
)paren
)paren
id|len
op_assign
r_sizeof
(paren
op_star
id|sunaddr
)paren
op_minus
l_int|1
suffix:semicolon
(paren
(paren
r_char
op_star
)paren
id|sunaddr
)paren
(braket
id|len
)braket
op_assign
l_int|0
suffix:semicolon
id|len
op_assign
id|strlen
c_func
(paren
id|sunaddr-&gt;sun_path
)paren
op_plus
l_int|1
op_plus
r_sizeof
(paren
r_int
)paren
suffix:semicolon
r_return
id|len
suffix:semicolon
)brace
op_star
id|hashp
op_assign
id|unix_hash_fold
c_func
(paren
id|csum_partial
c_func
(paren
(paren
r_char
op_star
)paren
id|sunaddr
comma
id|len
comma
l_int|0
)paren
)paren
suffix:semicolon
r_return
id|len
suffix:semicolon
)brace
DECL|function|unix_remove_socket
r_static
r_void
id|unix_remove_socket
c_func
(paren
id|unix_socket
op_star
id|sk
)paren
(brace
id|unix_socket
op_star
op_star
id|list
op_assign
id|sk-&gt;protinfo.af_unix.list
suffix:semicolon
r_if
c_cond
(paren
id|sk-&gt;next
)paren
id|sk-&gt;next-&gt;prev
op_assign
id|sk-&gt;prev
suffix:semicolon
r_if
c_cond
(paren
id|sk-&gt;prev
)paren
id|sk-&gt;prev-&gt;next
op_assign
id|sk-&gt;next
suffix:semicolon
r_if
c_cond
(paren
op_star
id|list
op_eq
id|sk
)paren
op_star
id|list
op_assign
id|sk-&gt;next
suffix:semicolon
id|sk-&gt;protinfo.af_unix.list
op_assign
l_int|NULL
suffix:semicolon
id|sk-&gt;prev
op_assign
l_int|NULL
suffix:semicolon
id|sk-&gt;next
op_assign
l_int|NULL
suffix:semicolon
)brace
DECL|function|unix_insert_socket
r_static
r_void
id|unix_insert_socket
c_func
(paren
id|unix_socket
op_star
id|sk
)paren
(brace
id|unix_socket
op_star
op_star
id|list
op_assign
id|sk-&gt;protinfo.af_unix.list
suffix:semicolon
id|sk-&gt;prev
op_assign
l_int|NULL
suffix:semicolon
id|sk-&gt;next
op_assign
op_star
id|list
suffix:semicolon
r_if
c_cond
(paren
op_star
id|list
)paren
(paren
op_star
id|list
)paren
op_member_access_from_pointer
id|prev
op_assign
id|sk
suffix:semicolon
op_star
id|list
op_assign
id|sk
suffix:semicolon
)brace
DECL|function|unix_find_socket_byname
r_static
id|unix_socket
op_star
id|unix_find_socket_byname
c_func
(paren
r_struct
id|sockaddr_un
op_star
id|sunname
comma
r_int
id|len
comma
r_int
id|type
comma
r_int
id|hash
)paren
(brace
id|unix_socket
op_star
id|s
suffix:semicolon
r_for
c_loop
(paren
id|s
op_assign
id|unix_socket_table
(braket
(paren
id|hash
op_xor
id|type
)paren
op_amp
l_int|0xF
)braket
suffix:semicolon
id|s
suffix:semicolon
id|s
op_assign
id|s-&gt;next
)paren
(brace
r_if
c_cond
(paren
id|s-&gt;protinfo.af_unix.addr-&gt;len
op_eq
id|len
op_logical_and
id|memcmp
c_func
(paren
id|s-&gt;protinfo.af_unix.addr-&gt;name
comma
id|sunname
comma
id|len
)paren
op_eq
l_int|0
op_logical_and
id|s-&gt;type
op_eq
id|type
)paren
(brace
id|unix_lock
c_func
(paren
id|s
)paren
suffix:semicolon
r_return
id|s
suffix:semicolon
)brace
)brace
r_return
l_int|NULL
suffix:semicolon
)brace
DECL|function|unix_find_socket_byinode
r_static
id|unix_socket
op_star
id|unix_find_socket_byinode
c_func
(paren
r_struct
id|inode
op_star
id|i
)paren
(brace
id|unix_socket
op_star
id|s
suffix:semicolon
r_for
c_loop
(paren
id|s
op_assign
id|unix_socket_table
(braket
id|i-&gt;i_ino
op_amp
l_int|0xF
)braket
suffix:semicolon
id|s
suffix:semicolon
id|s
op_assign
id|s-&gt;next
)paren
(brace
r_if
c_cond
(paren
id|s-&gt;protinfo.af_unix.inode
op_eq
id|i
)paren
(brace
id|unix_lock
c_func
(paren
id|s
)paren
suffix:semicolon
r_return
id|s
suffix:semicolon
)brace
)brace
r_return
l_int|NULL
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;Delete a unix socket. We have to allow for deferring this on a timer.&n; */
DECL|function|unix_destroy_timer
r_static
r_void
id|unix_destroy_timer
c_func
(paren
r_int
r_int
id|data
)paren
(brace
id|unix_socket
op_star
id|sk
op_assign
(paren
id|unix_socket
op_star
)paren
id|data
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|unix_locked
c_func
(paren
id|sk
)paren
op_logical_and
id|atomic_read
c_func
(paren
op_amp
id|sk-&gt;wmem_alloc
)paren
op_eq
l_int|0
)paren
(brace
id|sk_free
c_func
(paren
id|sk
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/*&n;&t; *&t;Retry;&n;&t; */
id|sk-&gt;timer.expires
op_assign
id|jiffies
op_plus
id|sysctl_unix_destroy_delay
suffix:semicolon
multiline_comment|/* No real hurry try it every 10 seconds or so */
id|add_timer
c_func
(paren
op_amp
id|sk-&gt;timer
)paren
suffix:semicolon
)brace
DECL|function|unix_delayed_delete
r_static
r_void
id|unix_delayed_delete
c_func
(paren
id|unix_socket
op_star
id|sk
)paren
(brace
id|sk-&gt;timer.data
op_assign
(paren
r_int
r_int
)paren
id|sk
suffix:semicolon
id|sk-&gt;timer.expires
op_assign
id|jiffies
op_plus
id|sysctl_unix_delete_delay
suffix:semicolon
multiline_comment|/* Normally 1 second after will clean up. After that we try every 10 */
id|sk-&gt;timer.function
op_assign
id|unix_destroy_timer
suffix:semicolon
id|add_timer
c_func
(paren
op_amp
id|sk-&gt;timer
)paren
suffix:semicolon
)brace
DECL|function|unix_destroy_socket
r_static
r_void
id|unix_destroy_socket
c_func
(paren
id|unix_socket
op_star
id|sk
)paren
(brace
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
id|unix_remove_socket
c_func
(paren
id|sk
)paren
suffix:semicolon
r_while
c_loop
(paren
(paren
id|skb
op_assign
id|skb_dequeue
c_func
(paren
op_amp
id|sk-&gt;receive_queue
)paren
)paren
op_ne
l_int|NULL
)paren
(brace
r_if
c_cond
(paren
id|sk-&gt;state
op_eq
id|TCP_LISTEN
)paren
(brace
id|unix_socket
op_star
id|osk
op_assign
id|skb-&gt;sk
suffix:semicolon
id|osk-&gt;state
op_assign
id|TCP_CLOSE
suffix:semicolon
id|kfree_skb
c_func
(paren
id|skb
comma
id|FREE_WRITE
)paren
suffix:semicolon
multiline_comment|/* Now surplus - free the skb first before the socket */
id|osk
op_member_access_from_pointer
id|state_change
c_func
(paren
id|osk
)paren
suffix:semicolon
multiline_comment|/* So the connect wakes and cleans up (if any) */
multiline_comment|/* osk will be destroyed when it gets to close or the timer fires */
)brace
r_else
(brace
multiline_comment|/* passed fds are erased in the kfree_skb hook */
id|kfree_skb
c_func
(paren
id|skb
comma
id|FREE_WRITE
)paren
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|sk-&gt;protinfo.af_unix.inode
op_ne
l_int|NULL
)paren
(brace
id|iput
c_func
(paren
id|sk-&gt;protinfo.af_unix.inode
)paren
suffix:semicolon
id|sk-&gt;protinfo.af_unix.inode
op_assign
l_int|NULL
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|unix_unlock
c_func
(paren
id|sk
)paren
op_logical_and
id|atomic_read
c_func
(paren
op_amp
id|sk-&gt;wmem_alloc
)paren
op_eq
l_int|0
)paren
(brace
id|sk_free
c_func
(paren
id|sk
)paren
suffix:semicolon
)brace
r_else
(brace
id|sk-&gt;dead
op_assign
l_int|1
suffix:semicolon
id|unix_delayed_delete
c_func
(paren
id|sk
)paren
suffix:semicolon
multiline_comment|/* Try every so often until buffers are all freed */
)brace
)brace
DECL|function|unix_listen
r_static
r_int
id|unix_listen
c_func
(paren
r_struct
id|socket
op_star
id|sock
comma
r_int
id|backlog
)paren
(brace
r_struct
id|sock
op_star
id|sk
op_assign
id|sock-&gt;sk
suffix:semicolon
r_if
c_cond
(paren
id|sock-&gt;state
op_ne
id|SS_UNCONNECTED
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|sock-&gt;type
op_ne
id|SOCK_STREAM
)paren
r_return
op_minus
id|EOPNOTSUPP
suffix:semicolon
multiline_comment|/* Only stream sockets accept */
r_if
c_cond
(paren
op_logical_neg
id|sk-&gt;protinfo.af_unix.addr
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
multiline_comment|/* No listens on an unbound socket */
id|sk-&gt;max_ack_backlog
op_assign
id|backlog
suffix:semicolon
r_if
c_cond
(paren
id|sk-&gt;ack_backlog
OL
id|backlog
)paren
id|sk
op_member_access_from_pointer
id|state_change
c_func
(paren
id|sk
)paren
suffix:semicolon
id|sk-&gt;state
op_assign
id|TCP_LISTEN
suffix:semicolon
id|sock-&gt;flags
op_or_assign
id|SO_ACCEPTCON
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_extern
r_struct
id|proto_ops
id|unix_stream_ops
suffix:semicolon
r_extern
r_struct
id|proto_ops
id|unix_dgram_ops
suffix:semicolon
DECL|function|unix_create
r_static
r_int
id|unix_create
c_func
(paren
r_struct
id|socket
op_star
id|sock
comma
r_int
id|protocol
)paren
(brace
r_struct
id|sock
op_star
id|sk
suffix:semicolon
id|sock-&gt;state
op_assign
id|SS_UNCONNECTED
suffix:semicolon
r_if
c_cond
(paren
id|protocol
op_logical_and
id|protocol
op_ne
id|PF_UNIX
)paren
r_return
op_minus
id|EPROTONOSUPPORT
suffix:semicolon
r_switch
c_cond
(paren
id|sock-&gt;type
)paren
(brace
r_case
id|SOCK_STREAM
suffix:colon
id|sock-&gt;ops
op_assign
op_amp
id|unix_stream_ops
suffix:semicolon
r_break
suffix:semicolon
multiline_comment|/*&n;&t;&t; *&t;Believe it or not BSD has AF_UNIX, SOCK_RAW though&n;&t;&t; *&t;nothing uses it.&n;&t;&t; */
r_case
id|SOCK_RAW
suffix:colon
id|sock-&gt;type
op_assign
id|SOCK_DGRAM
suffix:semicolon
r_case
id|SOCK_DGRAM
suffix:colon
id|sock-&gt;ops
op_assign
op_amp
id|unix_dgram_ops
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
r_return
op_minus
id|ESOCKTNOSUPPORT
suffix:semicolon
)brace
id|sk
op_assign
id|sk_alloc
c_func
(paren
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|sk
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|sock_init_data
c_func
(paren
id|sock
comma
id|sk
)paren
suffix:semicolon
id|sk-&gt;destruct
op_assign
id|unix_destruct_addr
suffix:semicolon
id|sk-&gt;protinfo.af_unix.family
op_assign
id|AF_UNIX
suffix:semicolon
id|sk-&gt;protinfo.af_unix.inode
op_assign
l_int|NULL
suffix:semicolon
id|sk-&gt;sock_readers
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* Us */
id|sk-&gt;protinfo.af_unix.readsem
op_assign
id|MUTEX
suffix:semicolon
multiline_comment|/* single task reading lock */
id|sk-&gt;mtu
op_assign
l_int|4096
suffix:semicolon
id|sk-&gt;protinfo.af_unix.list
op_assign
op_amp
id|unix_sockets_unbound
suffix:semicolon
id|unix_insert_socket
c_func
(paren
id|sk
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|unix_dup
r_static
r_int
id|unix_dup
c_func
(paren
r_struct
id|socket
op_star
id|newsock
comma
r_struct
id|socket
op_star
id|oldsock
)paren
(brace
r_return
id|unix_create
c_func
(paren
id|newsock
comma
l_int|0
)paren
suffix:semicolon
)brace
DECL|function|unix_release
r_static
r_int
id|unix_release
c_func
(paren
r_struct
id|socket
op_star
id|sock
comma
r_struct
id|socket
op_star
id|peer
)paren
(brace
id|unix_socket
op_star
id|sk
op_assign
id|sock-&gt;sk
suffix:semicolon
id|unix_socket
op_star
id|skpair
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|sk
)paren
r_return
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|sock-&gt;state
op_ne
id|SS_UNCONNECTED
)paren
id|sock-&gt;state
op_assign
id|SS_DISCONNECTING
suffix:semicolon
id|sk
op_member_access_from_pointer
id|state_change
c_func
(paren
id|sk
)paren
suffix:semicolon
id|sk-&gt;dead
op_assign
l_int|1
suffix:semicolon
id|skpair
op_assign
id|unix_peer
c_func
(paren
id|sk
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sock-&gt;type
op_eq
id|SOCK_STREAM
op_logical_and
id|skpair
)paren
(brace
r_if
c_cond
(paren
id|unix_our_peer
c_func
(paren
id|sk
comma
id|skpair
)paren
)paren
id|skpair-&gt;shutdown
op_assign
id|SHUTDOWN_MASK
suffix:semicolon
multiline_comment|/* No more writes */
r_if
c_cond
(paren
id|skpair-&gt;state
op_ne
id|TCP_LISTEN
)paren
id|skpair
op_member_access_from_pointer
id|state_change
c_func
(paren
id|skpair
)paren
suffix:semicolon
multiline_comment|/* Wake any blocked writes */
)brace
r_if
c_cond
(paren
id|skpair
op_ne
l_int|NULL
)paren
id|unix_unlock
c_func
(paren
id|skpair
)paren
suffix:semicolon
multiline_comment|/* It may now die */
id|unix_peer
c_func
(paren
id|sk
)paren
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/* No pair */
id|unix_destroy_socket
c_func
(paren
id|sk
)paren
suffix:semicolon
multiline_comment|/* Try to flush out this socket. Throw out buffers at least */
id|unix_gc
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* Garbage collect fds */
multiline_comment|/*&n;&t; *&t;FIXME: BSD difference: In BSD all sockets connected to use get ECONNRESET and we die on the spot. In&n;&t; *&t;Linux we behave like files and pipes do and wait for the last dereference.&n;&t; */
r_if
c_cond
(paren
id|sk-&gt;socket
)paren
(brace
id|sk-&gt;socket
op_assign
l_int|NULL
suffix:semicolon
id|sock-&gt;sk
op_assign
l_int|NULL
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|unix_autobind
r_static
r_int
id|unix_autobind
c_func
(paren
r_struct
id|socket
op_star
id|sock
)paren
(brace
r_struct
id|sock
op_star
id|sk
op_assign
id|sock-&gt;sk
suffix:semicolon
r_static
id|u32
id|ordernum
op_assign
l_int|1
suffix:semicolon
r_struct
id|unix_address
op_star
id|addr
suffix:semicolon
id|unix_socket
op_star
id|osk
suffix:semicolon
id|addr
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
op_star
id|addr
)paren
op_plus
r_sizeof
(paren
r_int
)paren
op_plus
l_int|16
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|addr
)paren
r_return
op_minus
id|ENOBUFS
suffix:semicolon
r_if
c_cond
(paren
id|sk-&gt;protinfo.af_unix.addr
op_logical_or
id|sk-&gt;protinfo.af_unix.inode
)paren
(brace
id|kfree
c_func
(paren
id|addr
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|memset
c_func
(paren
id|addr
comma
l_int|0
comma
r_sizeof
(paren
op_star
id|addr
)paren
op_plus
r_sizeof
(paren
r_int
)paren
op_plus
l_int|16
)paren
suffix:semicolon
id|addr-&gt;name-&gt;sun_family
op_assign
id|AF_UNIX
suffix:semicolon
id|atomic_set
c_func
(paren
op_amp
id|addr-&gt;refcnt
comma
l_int|1
)paren
suffix:semicolon
id|retry
suffix:colon
id|addr-&gt;len
op_assign
id|sprintf
c_func
(paren
id|addr-&gt;name-&gt;sun_path
op_plus
l_int|1
comma
l_string|&quot;%08x&quot;
comma
id|ordernum
)paren
op_plus
l_int|1
op_plus
r_sizeof
(paren
r_int
)paren
suffix:semicolon
id|addr-&gt;hash
op_assign
id|unix_hash_fold
c_func
(paren
id|csum_partial
c_func
(paren
(paren
r_void
op_star
)paren
id|addr-&gt;name
comma
id|addr-&gt;len
comma
l_int|0
)paren
)paren
suffix:semicolon
id|ordernum
op_increment
suffix:semicolon
r_if
c_cond
(paren
(paren
id|osk
op_assign
id|unix_find_socket_byname
c_func
(paren
id|addr-&gt;name
comma
id|addr-&gt;len
comma
id|sock-&gt;type
comma
id|addr-&gt;hash
)paren
)paren
op_ne
l_int|NULL
)paren
(brace
id|unix_unlock
c_func
(paren
id|osk
)paren
suffix:semicolon
r_goto
id|retry
suffix:semicolon
)brace
id|sk-&gt;protinfo.af_unix.addr
op_assign
id|addr
suffix:semicolon
id|unix_remove_socket
c_func
(paren
id|sk
)paren
suffix:semicolon
id|sk-&gt;protinfo.af_unix.list
op_assign
op_amp
id|unix_socket_table
(braket
(paren
id|addr-&gt;hash
op_xor
id|sk-&gt;type
)paren
op_amp
l_int|0xF
)braket
suffix:semicolon
id|unix_insert_socket
c_func
(paren
id|sk
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|unix_find_other
r_static
id|unix_socket
op_star
id|unix_find_other
c_func
(paren
r_struct
id|sockaddr_un
op_star
id|sunname
comma
r_int
id|len
comma
r_int
id|type
comma
r_int
id|hash
comma
r_int
op_star
id|error
)paren
(brace
r_int
r_int
id|old_fs
suffix:semicolon
r_int
id|err
suffix:semicolon
r_struct
id|inode
op_star
id|inode
suffix:semicolon
id|unix_socket
op_star
id|u
suffix:semicolon
r_if
c_cond
(paren
id|sunname-&gt;sun_path
(braket
l_int|0
)braket
)paren
(brace
id|old_fs
op_assign
id|get_fs
c_func
(paren
)paren
suffix:semicolon
id|set_fs
c_func
(paren
id|get_ds
c_func
(paren
)paren
)paren
suffix:semicolon
id|err
op_assign
id|open_namei
c_func
(paren
id|sunname-&gt;sun_path
comma
l_int|2
comma
id|S_IFSOCK
comma
op_amp
id|inode
comma
l_int|NULL
)paren
suffix:semicolon
id|set_fs
c_func
(paren
id|old_fs
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
OL
l_int|0
)paren
(brace
op_star
id|error
op_assign
id|err
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
id|u
op_assign
id|unix_find_socket_byinode
c_func
(paren
id|inode
)paren
suffix:semicolon
id|iput
c_func
(paren
id|inode
)paren
suffix:semicolon
r_if
c_cond
(paren
id|u
op_logical_and
id|u-&gt;type
op_ne
id|type
)paren
(brace
op_star
id|error
op_assign
op_minus
id|EPROTOTYPE
suffix:semicolon
id|unix_unlock
c_func
(paren
id|u
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
)brace
r_else
id|u
op_assign
id|unix_find_socket_byname
c_func
(paren
id|sunname
comma
id|len
comma
id|type
comma
id|hash
)paren
suffix:semicolon
r_if
c_cond
(paren
id|u
op_eq
l_int|NULL
)paren
(brace
op_star
id|error
op_assign
op_minus
id|ECONNREFUSED
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
r_return
id|u
suffix:semicolon
)brace
DECL|function|unix_bind
r_static
r_int
id|unix_bind
c_func
(paren
r_struct
id|socket
op_star
id|sock
comma
r_struct
id|sockaddr
op_star
id|uaddr
comma
r_int
id|addr_len
)paren
(brace
r_struct
id|sock
op_star
id|sk
op_assign
id|sock-&gt;sk
suffix:semicolon
r_struct
id|sockaddr_un
op_star
id|sunaddr
op_assign
(paren
r_struct
id|sockaddr_un
op_star
)paren
id|uaddr
suffix:semicolon
r_struct
id|inode
op_star
id|inode
suffix:semicolon
r_int
id|old_fs
suffix:semicolon
r_int
id|err
suffix:semicolon
r_int
id|hash
suffix:semicolon
r_struct
id|unix_address
op_star
id|addr
suffix:semicolon
r_if
c_cond
(paren
id|sk-&gt;protinfo.af_unix.addr
op_logical_or
id|sk-&gt;protinfo.af_unix.inode
op_logical_or
id|sunaddr-&gt;sun_family
op_ne
id|AF_UNIX
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|addr_len
op_eq
r_sizeof
(paren
r_int
)paren
)paren
r_return
id|unix_autobind
c_func
(paren
id|sock
)paren
suffix:semicolon
id|addr_len
op_assign
id|unix_mkname
c_func
(paren
id|sunaddr
comma
id|addr_len
comma
op_amp
id|hash
)paren
suffix:semicolon
r_if
c_cond
(paren
id|addr_len
OL
l_int|0
)paren
r_return
id|addr_len
suffix:semicolon
id|addr
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
op_star
id|addr
)paren
op_plus
id|addr_len
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|addr
)paren
r_return
op_minus
id|ENOBUFS
suffix:semicolon
multiline_comment|/* We slept; recheck ... */
r_if
c_cond
(paren
id|sk-&gt;protinfo.af_unix.addr
op_logical_or
id|sk-&gt;protinfo.af_unix.inode
)paren
(brace
id|kfree
c_func
(paren
id|addr
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
multiline_comment|/* Already bound */
)brace
id|memcpy
c_func
(paren
id|addr-&gt;name
comma
id|sunaddr
comma
id|addr_len
)paren
suffix:semicolon
id|addr-&gt;len
op_assign
id|addr_len
suffix:semicolon
id|addr-&gt;hash
op_assign
id|hash
suffix:semicolon
id|atomic_set
c_func
(paren
op_amp
id|addr-&gt;refcnt
comma
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|sunaddr-&gt;sun_path
(braket
l_int|0
)braket
)paren
(brace
id|unix_socket
op_star
id|osk
op_assign
id|unix_find_socket_byname
c_func
(paren
id|sunaddr
comma
id|addr_len
comma
id|sk-&gt;type
comma
id|hash
)paren
suffix:semicolon
r_if
c_cond
(paren
id|osk
)paren
(brace
id|unix_unlock
c_func
(paren
id|osk
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|addr
)paren
suffix:semicolon
r_return
op_minus
id|EADDRINUSE
suffix:semicolon
)brace
id|unix_remove_socket
c_func
(paren
id|sk
)paren
suffix:semicolon
id|sk-&gt;protinfo.af_unix.addr
op_assign
id|addr
suffix:semicolon
id|sk-&gt;protinfo.af_unix.list
op_assign
op_amp
id|unix_socket_table
(braket
(paren
id|hash
op_xor
id|sk-&gt;type
)paren
op_amp
l_int|0xF
)braket
suffix:semicolon
id|unix_insert_socket
c_func
(paren
id|sk
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|addr-&gt;hash
op_assign
id|UNIX_HASH_SIZE
suffix:semicolon
id|sk-&gt;protinfo.af_unix.addr
op_assign
id|addr
suffix:semicolon
id|old_fs
op_assign
id|get_fs
c_func
(paren
)paren
suffix:semicolon
id|set_fs
c_func
(paren
id|get_ds
c_func
(paren
)paren
)paren
suffix:semicolon
id|err
op_assign
id|do_mknod
c_func
(paren
id|sunaddr-&gt;sun_path
comma
id|S_IFSOCK
op_or
id|S_IRWXUGO
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|err
)paren
id|err
op_assign
id|open_namei
c_func
(paren
id|sunaddr-&gt;sun_path
comma
l_int|2
comma
id|S_IFSOCK
comma
op_amp
id|inode
comma
l_int|NULL
)paren
suffix:semicolon
id|set_fs
c_func
(paren
id|old_fs
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
OL
l_int|0
)paren
(brace
id|unix_release_addr
c_func
(paren
id|addr
)paren
suffix:semicolon
id|sk-&gt;protinfo.af_unix.addr
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
id|err
op_eq
op_minus
id|EEXIST
)paren
r_return
op_minus
id|EADDRINUSE
suffix:semicolon
r_else
r_return
id|err
suffix:semicolon
)brace
id|unix_remove_socket
c_func
(paren
id|sk
)paren
suffix:semicolon
id|sk-&gt;protinfo.af_unix.list
op_assign
op_amp
id|unix_socket_table
(braket
id|inode-&gt;i_ino
op_amp
l_int|0xF
)braket
suffix:semicolon
id|sk-&gt;protinfo.af_unix.inode
op_assign
id|inode
suffix:semicolon
id|unix_insert_socket
c_func
(paren
id|sk
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|unix_dgram_connect
r_static
r_int
id|unix_dgram_connect
c_func
(paren
r_struct
id|socket
op_star
id|sock
comma
r_struct
id|sockaddr
op_star
id|addr
comma
r_int
id|alen
comma
r_int
id|flags
)paren
(brace
r_struct
id|sock
op_star
id|sk
op_assign
id|sock-&gt;sk
suffix:semicolon
r_struct
id|sockaddr_un
op_star
id|sunaddr
op_assign
(paren
r_struct
id|sockaddr_un
op_star
)paren
id|addr
suffix:semicolon
r_struct
id|sock
op_star
id|other
suffix:semicolon
r_int
id|hash
suffix:semicolon
r_int
id|err
suffix:semicolon
multiline_comment|/*&n;&t; *&t;1003.1g breaking connected state with AF_UNSPEC&n;&t; */
r_if
c_cond
(paren
id|addr-&gt;sa_family
op_eq
id|AF_UNSPEC
)paren
(brace
r_if
c_cond
(paren
id|unix_peer
c_func
(paren
id|sk
)paren
)paren
(brace
id|unix_unlock
c_func
(paren
id|unix_peer
c_func
(paren
id|sk
)paren
)paren
suffix:semicolon
id|unix_peer
c_func
(paren
id|sk
)paren
op_assign
l_int|NULL
suffix:semicolon
id|sock-&gt;state
op_assign
id|SS_UNCONNECTED
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
id|alen
op_assign
id|unix_mkname
c_func
(paren
id|sunaddr
comma
id|alen
comma
op_amp
id|hash
)paren
suffix:semicolon
r_if
c_cond
(paren
id|alen
OL
l_int|0
)paren
r_return
id|alen
suffix:semicolon
id|other
op_assign
id|unix_find_other
c_func
(paren
id|sunaddr
comma
id|alen
comma
id|sock-&gt;type
comma
id|hash
comma
op_amp
id|err
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|other
)paren
r_return
id|err
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|unix_may_send
c_func
(paren
id|sk
comma
id|other
)paren
)paren
(brace
id|unix_unlock
c_func
(paren
id|other
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * If it was connected, reconnect.&n;&t; */
r_if
c_cond
(paren
id|unix_peer
c_func
(paren
id|sk
)paren
)paren
(brace
id|unix_unlock
c_func
(paren
id|unix_peer
c_func
(paren
id|sk
)paren
)paren
suffix:semicolon
id|unix_peer
c_func
(paren
id|sk
)paren
op_assign
l_int|NULL
suffix:semicolon
)brace
id|unix_peer
c_func
(paren
id|sk
)paren
op_assign
id|other
suffix:semicolon
r_if
c_cond
(paren
id|sock-&gt;passcred
op_logical_and
op_logical_neg
id|sk-&gt;protinfo.af_unix.addr
)paren
id|unix_autobind
c_func
(paren
id|sock
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|unix_stream_connect1
r_static
r_int
id|unix_stream_connect1
c_func
(paren
r_struct
id|socket
op_star
id|sock
comma
r_struct
id|msghdr
op_star
id|msg
comma
r_int
id|len
comma
r_struct
id|unix_skb_parms
op_star
id|cmsg
comma
r_int
id|nonblock
)paren
(brace
r_struct
id|sockaddr_un
op_star
id|sunaddr
op_assign
(paren
r_struct
id|sockaddr_un
op_star
)paren
id|msg-&gt;msg_name
suffix:semicolon
r_struct
id|sock
op_star
id|sk
op_assign
id|sock-&gt;sk
suffix:semicolon
id|unix_socket
op_star
id|other
suffix:semicolon
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
r_int
id|err
suffix:semicolon
r_int
id|hash
suffix:semicolon
r_int
id|addr_len
suffix:semicolon
id|addr_len
op_assign
id|unix_mkname
c_func
(paren
id|sunaddr
comma
id|msg-&gt;msg_namelen
comma
op_amp
id|hash
)paren
suffix:semicolon
r_if
c_cond
(paren
id|addr_len
OL
l_int|0
)paren
r_return
id|addr_len
suffix:semicolon
r_switch
c_cond
(paren
id|sock-&gt;state
)paren
(brace
r_case
id|SS_UNCONNECTED
suffix:colon
multiline_comment|/* This is ok... continue with connect */
r_break
suffix:semicolon
r_case
id|SS_CONNECTED
suffix:colon
multiline_comment|/* Socket is already connected */
r_return
op_minus
id|EISCONN
suffix:semicolon
r_case
id|SS_CONNECTING
suffix:colon
multiline_comment|/* Not yet connected... we will check this. */
r_break
suffix:semicolon
r_default
suffix:colon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|unix_peer
c_func
(paren
id|sk
)paren
)paren
(brace
r_if
c_cond
(paren
id|sock-&gt;state
op_eq
id|SS_CONNECTING
op_logical_and
id|sk-&gt;state
op_eq
id|TCP_ESTABLISHED
)paren
(brace
id|sock-&gt;state
op_assign
id|SS_CONNECTED
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|sk-&gt;protinfo.af_unix.addr
)paren
id|unix_autobind
c_func
(paren
id|sock
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|sock-&gt;state
op_eq
id|SS_CONNECTING
op_logical_and
id|sk-&gt;state
op_eq
id|TCP_CLOSE
)paren
(brace
id|sock-&gt;state
op_assign
id|SS_UNCONNECTED
suffix:semicolon
r_return
op_minus
id|ECONNREFUSED
suffix:semicolon
)brace
r_if
c_cond
(paren
id|sock-&gt;state
op_ne
id|SS_CONNECTING
)paren
r_return
op_minus
id|EISCONN
suffix:semicolon
r_if
c_cond
(paren
id|nonblock
)paren
r_return
op_minus
id|EALREADY
suffix:semicolon
multiline_comment|/*&n;&t;&t; *&t;Drop through the connect up logic to the wait.&n;&t;&t; */
)brace
r_if
c_cond
(paren
id|sock-&gt;state
op_eq
id|SS_UNCONNECTED
)paren
(brace
multiline_comment|/*&n;&t;&t; *&t;Now ready to connect&n;&t;&t; */
id|skb
op_assign
id|sock_alloc_send_skb
c_func
(paren
id|sk
comma
id|len
comma
l_int|0
comma
id|nonblock
comma
op_amp
id|err
)paren
suffix:semicolon
multiline_comment|/* Marker object */
r_if
c_cond
(paren
id|skb
op_eq
l_int|NULL
)paren
(brace
r_return
id|err
suffix:semicolon
)brace
id|memcpy
c_func
(paren
op_amp
id|UNIXCB
c_func
(paren
id|skb
)paren
comma
id|cmsg
comma
r_sizeof
(paren
op_star
id|cmsg
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|len
)paren
id|memcpy_fromiovec
c_func
(paren
id|skb_put
c_func
(paren
id|skb
comma
id|len
)paren
comma
id|msg-&gt;msg_iov
comma
id|len
)paren
suffix:semicolon
id|sk-&gt;state
op_assign
id|TCP_CLOSE
suffix:semicolon
id|other
op_assign
id|unix_find_other
c_func
(paren
id|sunaddr
comma
id|addr_len
comma
id|sk-&gt;type
comma
id|hash
comma
op_amp
id|err
)paren
suffix:semicolon
r_if
c_cond
(paren
id|other
op_eq
l_int|NULL
)paren
(brace
id|kfree_skb
c_func
(paren
id|skb
comma
id|FREE_WRITE
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
id|other-&gt;ack_backlog
op_increment
suffix:semicolon
id|unix_peer
c_func
(paren
id|sk
)paren
op_assign
id|other
suffix:semicolon
id|skb_queue_tail
c_func
(paren
op_amp
id|other-&gt;receive_queue
comma
id|skb
)paren
suffix:semicolon
id|sk-&gt;state
op_assign
id|TCP_SYN_SENT
suffix:semicolon
id|sock-&gt;state
op_assign
id|SS_CONNECTING
suffix:semicolon
id|other
op_member_access_from_pointer
id|data_ready
c_func
(paren
id|other
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* Wake up ! */
)brace
multiline_comment|/* Wait for an accept */
r_while
c_loop
(paren
id|sk-&gt;state
op_eq
id|TCP_SYN_SENT
)paren
(brace
r_if
c_cond
(paren
id|nonblock
)paren
(brace
r_return
op_minus
id|EINPROGRESS
suffix:semicolon
)brace
id|interruptible_sleep_on
c_func
(paren
id|sk-&gt;sleep
)paren
suffix:semicolon
r_if
c_cond
(paren
id|current-&gt;signal
op_amp
op_complement
id|current-&gt;blocked
)paren
(brace
r_return
op_minus
id|ERESTARTSYS
suffix:semicolon
)brace
)brace
multiline_comment|/*&n;&t; *&t;Has the other end closed on us ?&n;&t; */
r_if
c_cond
(paren
id|sk-&gt;state
op_eq
id|TCP_CLOSE
)paren
(brace
id|unix_unlock
c_func
(paren
id|unix_peer
c_func
(paren
id|sk
)paren
)paren
suffix:semicolon
id|unix_peer
c_func
(paren
id|sk
)paren
op_assign
l_int|NULL
suffix:semicolon
id|sock-&gt;state
op_assign
id|SS_UNCONNECTED
suffix:semicolon
r_return
op_minus
id|ECONNREFUSED
suffix:semicolon
)brace
multiline_comment|/*&n;&t; *&t;Amazingly it has worked&n;&t; */
id|sock-&gt;state
op_assign
id|SS_CONNECTED
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|sk-&gt;protinfo.af_unix.addr
)paren
id|unix_autobind
c_func
(paren
id|sock
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|unix_stream_connect
r_static
r_int
id|unix_stream_connect
c_func
(paren
r_struct
id|socket
op_star
id|sock
comma
r_struct
id|sockaddr
op_star
id|uaddr
comma
r_int
id|addr_len
comma
r_int
id|flags
)paren
(brace
r_struct
id|msghdr
id|msg
suffix:semicolon
r_struct
id|unix_skb_parms
id|cmsg
suffix:semicolon
id|msg.msg_name
op_assign
id|uaddr
suffix:semicolon
id|msg.msg_namelen
op_assign
id|addr_len
suffix:semicolon
id|cmsg.fp
op_assign
l_int|NULL
suffix:semicolon
id|cmsg.attr
op_assign
id|MSG_SYN
suffix:semicolon
id|cmsg.creds.pid
op_assign
id|current-&gt;pid
suffix:semicolon
id|cmsg.creds.uid
op_assign
id|current-&gt;euid
suffix:semicolon
id|cmsg.creds.gid
op_assign
id|current-&gt;egid
suffix:semicolon
r_return
id|unix_stream_connect1
c_func
(paren
id|sock
comma
op_amp
id|msg
comma
l_int|0
comma
op_amp
id|cmsg
comma
id|flags
op_amp
id|O_NONBLOCK
)paren
suffix:semicolon
)brace
DECL|function|unix_socketpair
r_static
r_int
id|unix_socketpair
c_func
(paren
r_struct
id|socket
op_star
id|socka
comma
r_struct
id|socket
op_star
id|sockb
)paren
(brace
r_struct
id|sock
op_star
id|ska
op_assign
id|socka-&gt;sk
comma
op_star
id|skb
op_assign
id|sockb-&gt;sk
suffix:semicolon
multiline_comment|/* Join our sockets back to back */
id|unix_lock
c_func
(paren
id|ska
)paren
suffix:semicolon
id|unix_lock
c_func
(paren
id|skb
)paren
suffix:semicolon
id|unix_peer
c_func
(paren
id|ska
)paren
op_assign
id|skb
suffix:semicolon
id|unix_peer
c_func
(paren
id|skb
)paren
op_assign
id|ska
suffix:semicolon
r_if
c_cond
(paren
id|ska-&gt;type
op_ne
id|SOCK_DGRAM
)paren
(brace
id|ska-&gt;state
op_assign
id|TCP_ESTABLISHED
suffix:semicolon
id|skb-&gt;state
op_assign
id|TCP_ESTABLISHED
suffix:semicolon
id|socka-&gt;state
op_assign
id|SS_CONNECTED
suffix:semicolon
id|sockb-&gt;state
op_assign
id|SS_CONNECTED
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|unix_accept
r_static
r_int
id|unix_accept
c_func
(paren
r_struct
id|socket
op_star
id|sock
comma
r_struct
id|socket
op_star
id|newsock
comma
r_int
id|flags
)paren
(brace
id|unix_socket
op_star
id|sk
op_assign
id|sock-&gt;sk
suffix:semicolon
id|unix_socket
op_star
id|newsk
op_assign
id|newsock-&gt;sk
suffix:semicolon
id|unix_socket
op_star
id|tsk
suffix:semicolon
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
r_if
c_cond
(paren
id|sock-&gt;state
op_ne
id|SS_UNCONNECTED
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|sock-&gt;flags
op_amp
id|SO_ACCEPTCON
)paren
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|sock-&gt;type
op_ne
id|SOCK_STREAM
)paren
r_return
op_minus
id|EOPNOTSUPP
suffix:semicolon
r_if
c_cond
(paren
id|sk-&gt;state
op_ne
id|TCP_LISTEN
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|sk-&gt;protinfo.af_unix.addr
)paren
(brace
id|atomic_inc
c_func
(paren
op_amp
id|sk-&gt;protinfo.af_unix.addr-&gt;refcnt
)paren
suffix:semicolon
id|newsk-&gt;protinfo.af_unix.addr
op_assign
id|sk-&gt;protinfo.af_unix.addr
suffix:semicolon
)brace
r_if
c_cond
(paren
id|sk-&gt;protinfo.af_unix.inode
)paren
(brace
id|atomic_inc
c_func
(paren
op_amp
id|sk-&gt;protinfo.af_unix.inode-&gt;i_count
)paren
suffix:semicolon
id|newsk-&gt;protinfo.af_unix.inode
op_assign
id|sk-&gt;protinfo.af_unix.inode
suffix:semicolon
)brace
r_for
c_loop
(paren
suffix:semicolon
suffix:semicolon
)paren
(brace
id|skb
op_assign
id|skb_dequeue
c_func
(paren
op_amp
id|sk-&gt;receive_queue
)paren
suffix:semicolon
r_if
c_cond
(paren
id|skb
op_eq
l_int|NULL
)paren
(brace
r_if
c_cond
(paren
id|flags
op_amp
id|O_NONBLOCK
)paren
(brace
r_return
op_minus
id|EAGAIN
suffix:semicolon
)brace
id|interruptible_sleep_on
c_func
(paren
id|sk-&gt;sleep
)paren
suffix:semicolon
r_if
c_cond
(paren
id|current-&gt;signal
op_amp
op_complement
id|current-&gt;blocked
)paren
(brace
r_return
op_minus
id|ERESTARTSYS
suffix:semicolon
)brace
r_continue
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|UNIXCB
c_func
(paren
id|skb
)paren
dot
id|attr
op_amp
id|MSG_SYN
)paren
)paren
(brace
id|tsk
op_assign
id|skb-&gt;sk
suffix:semicolon
id|tsk
op_member_access_from_pointer
id|state_change
c_func
(paren
id|tsk
)paren
suffix:semicolon
id|kfree_skb
c_func
(paren
id|skb
comma
id|FREE_WRITE
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
r_break
suffix:semicolon
)brace
id|tsk
op_assign
id|skb-&gt;sk
suffix:semicolon
id|sk-&gt;ack_backlog
op_decrement
suffix:semicolon
id|unix_peer
c_func
(paren
id|newsk
)paren
op_assign
id|tsk
suffix:semicolon
id|unix_peer
c_func
(paren
id|tsk
)paren
op_assign
id|newsk
suffix:semicolon
id|tsk-&gt;state
op_assign
id|TCP_ESTABLISHED
suffix:semicolon
id|newsk-&gt;state
op_assign
id|TCP_ESTABLISHED
suffix:semicolon
id|memcpy
c_func
(paren
op_amp
id|newsk-&gt;peercred
comma
id|UNIXCREDS
c_func
(paren
id|skb
)paren
comma
r_sizeof
(paren
r_struct
id|ucred
)paren
)paren
suffix:semicolon
id|tsk-&gt;peercred.pid
op_assign
id|current-&gt;pid
suffix:semicolon
id|tsk-&gt;peercred.uid
op_assign
id|current-&gt;euid
suffix:semicolon
id|tsk-&gt;peercred.gid
op_assign
id|current-&gt;egid
suffix:semicolon
id|unix_lock
c_func
(paren
id|newsk
)paren
suffix:semicolon
multiline_comment|/* Swap lock over */
id|unix_unlock
c_func
(paren
id|sk
)paren
suffix:semicolon
multiline_comment|/* Locked to child socket not master */
id|unix_lock
c_func
(paren
id|tsk
)paren
suffix:semicolon
multiline_comment|/* Back lock */
id|kfree_skb
c_func
(paren
id|skb
comma
id|FREE_WRITE
)paren
suffix:semicolon
multiline_comment|/* The buffer is just used as a tag */
id|tsk
op_member_access_from_pointer
id|state_change
c_func
(paren
id|tsk
)paren
suffix:semicolon
multiline_comment|/* Wake up any sleeping connect */
id|sock_wake_async
c_func
(paren
id|tsk-&gt;socket
comma
l_int|0
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|unix_getname
r_static
r_int
id|unix_getname
c_func
(paren
r_struct
id|socket
op_star
id|sock
comma
r_struct
id|sockaddr
op_star
id|uaddr
comma
r_int
op_star
id|uaddr_len
comma
r_int
id|peer
)paren
(brace
r_struct
id|sock
op_star
id|sk
op_assign
id|sock-&gt;sk
suffix:semicolon
r_struct
id|sockaddr_un
op_star
id|sunaddr
op_assign
(paren
r_struct
id|sockaddr_un
op_star
)paren
id|uaddr
suffix:semicolon
r_if
c_cond
(paren
id|peer
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|unix_peer
c_func
(paren
id|sk
)paren
)paren
r_return
op_minus
id|ENOTCONN
suffix:semicolon
id|sk
op_assign
id|unix_peer
c_func
(paren
id|sk
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|sk-&gt;protinfo.af_unix.addr
)paren
(brace
id|sunaddr-&gt;sun_family
op_assign
id|AF_UNIX
suffix:semicolon
id|sunaddr-&gt;sun_path
(braket
l_int|0
)braket
op_assign
l_int|0
suffix:semicolon
op_star
id|uaddr_len
op_assign
r_sizeof
(paren
r_int
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
multiline_comment|/* Not bound */
)brace
op_star
id|uaddr_len
op_assign
id|sk-&gt;protinfo.af_unix.addr-&gt;len
suffix:semicolon
id|memcpy
c_func
(paren
id|sunaddr
comma
id|sk-&gt;protinfo.af_unix.addr-&gt;name
comma
op_star
id|uaddr_len
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|unix_detach_fds
r_static
r_void
id|unix_detach_fds
c_func
(paren
r_struct
id|scm_cookie
op_star
id|scm
comma
r_struct
id|sk_buff
op_star
id|skb
)paren
(brace
r_int
id|i
suffix:semicolon
id|scm-&gt;fp
op_assign
id|UNIXCB
c_func
(paren
id|skb
)paren
dot
id|fp
suffix:semicolon
id|skb-&gt;destructor
op_assign
id|sock_wfree
suffix:semicolon
id|UNIXCB
c_func
(paren
id|skb
)paren
dot
id|fp
op_assign
l_int|NULL
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
id|scm-&gt;fp-&gt;count
op_minus
l_int|1
suffix:semicolon
id|i
op_ge
l_int|0
suffix:semicolon
id|i
op_decrement
)paren
id|unix_notinflight
c_func
(paren
id|scm-&gt;fp-&gt;fp
(braket
id|i
)braket
)paren
suffix:semicolon
)brace
DECL|function|unix_destruct_fds
r_static
r_void
id|unix_destruct_fds
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
)paren
(brace
r_struct
id|scm_cookie
id|scm
suffix:semicolon
id|memset
c_func
(paren
op_amp
id|scm
comma
l_int|0
comma
r_sizeof
(paren
id|scm
)paren
)paren
suffix:semicolon
id|unix_detach_fds
c_func
(paren
op_amp
id|scm
comma
id|skb
)paren
suffix:semicolon
id|scm_destroy
c_func
(paren
op_amp
id|scm
)paren
suffix:semicolon
id|sock_wfree
c_func
(paren
id|skb
)paren
suffix:semicolon
)brace
DECL|function|unix_attach_fds
r_static
r_void
id|unix_attach_fds
c_func
(paren
r_struct
id|scm_cookie
op_star
id|scm
comma
r_struct
id|sk_buff
op_star
id|skb
)paren
(brace
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
id|scm-&gt;fp-&gt;count
op_minus
l_int|1
suffix:semicolon
id|i
op_ge
l_int|0
suffix:semicolon
id|i
op_decrement
)paren
id|unix_inflight
c_func
(paren
id|scm-&gt;fp-&gt;fp
(braket
id|i
)braket
)paren
suffix:semicolon
id|UNIXCB
c_func
(paren
id|skb
)paren
dot
id|fp
op_assign
id|scm-&gt;fp
suffix:semicolon
id|skb-&gt;destructor
op_assign
id|unix_destruct_fds
suffix:semicolon
id|scm-&gt;fp
op_assign
l_int|NULL
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;Send AF_UNIX data.&n; */
DECL|function|unix_dgram_sendmsg
r_static
r_int
id|unix_dgram_sendmsg
c_func
(paren
r_struct
id|socket
op_star
id|sock
comma
r_struct
id|msghdr
op_star
id|msg
comma
r_int
id|len
comma
r_struct
id|scm_cookie
op_star
id|scm
)paren
(brace
r_struct
id|sock
op_star
id|sk
op_assign
id|sock-&gt;sk
suffix:semicolon
id|unix_socket
op_star
id|other
suffix:semicolon
r_struct
id|sockaddr_un
op_star
id|sunaddr
op_assign
id|msg-&gt;msg_name
suffix:semicolon
r_int
id|namelen
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* fake GCC */
r_int
id|err
suffix:semicolon
r_int
id|hash
suffix:semicolon
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
r_if
c_cond
(paren
id|msg-&gt;msg_flags
op_amp
id|MSG_OOB
)paren
r_return
op_minus
id|EOPNOTSUPP
suffix:semicolon
r_if
c_cond
(paren
id|msg-&gt;msg_flags
op_amp
op_complement
id|MSG_DONTWAIT
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|msg-&gt;msg_namelen
)paren
(brace
id|namelen
op_assign
id|unix_mkname
c_func
(paren
id|sunaddr
comma
id|msg-&gt;msg_namelen
comma
op_amp
id|hash
)paren
suffix:semicolon
r_if
c_cond
(paren
id|namelen
OL
l_int|0
)paren
r_return
id|namelen
suffix:semicolon
)brace
r_else
(brace
id|sunaddr
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|unix_peer
c_func
(paren
id|sk
)paren
)paren
r_return
op_minus
id|ENOTCONN
suffix:semicolon
)brace
r_if
c_cond
(paren
id|sock-&gt;passcred
op_logical_and
op_logical_neg
id|sk-&gt;protinfo.af_unix.addr
)paren
id|unix_autobind
c_func
(paren
id|sock
)paren
suffix:semicolon
id|skb
op_assign
id|sock_alloc_send_skb
c_func
(paren
id|sk
comma
id|len
comma
l_int|0
comma
id|msg-&gt;msg_flags
op_amp
id|MSG_DONTWAIT
comma
op_amp
id|err
)paren
suffix:semicolon
r_if
c_cond
(paren
id|skb
op_eq
l_int|NULL
)paren
r_return
id|err
suffix:semicolon
id|memcpy
c_func
(paren
id|UNIXCREDS
c_func
(paren
id|skb
)paren
comma
op_amp
id|scm-&gt;creds
comma
r_sizeof
(paren
r_struct
id|ucred
)paren
)paren
suffix:semicolon
id|UNIXCB
c_func
(paren
id|skb
)paren
dot
id|attr
op_assign
id|msg-&gt;msg_flags
suffix:semicolon
r_if
c_cond
(paren
id|scm-&gt;fp
)paren
id|unix_attach_fds
c_func
(paren
id|scm
comma
id|skb
)paren
suffix:semicolon
id|skb-&gt;h.raw
op_assign
id|skb-&gt;data
suffix:semicolon
id|memcpy_fromiovec
c_func
(paren
id|skb_put
c_func
(paren
id|skb
comma
id|len
)paren
comma
id|msg-&gt;msg_iov
comma
id|len
)paren
suffix:semicolon
id|other
op_assign
id|unix_peer
c_func
(paren
id|sk
)paren
suffix:semicolon
r_if
c_cond
(paren
id|other
op_logical_and
id|other-&gt;dead
)paren
(brace
multiline_comment|/*&n;&t;&t; *&t;Check with 1003.1g - what should&n;&t;&t; *&t;datagram error&n;&t;&t; */
id|unix_unlock
c_func
(paren
id|other
)paren
suffix:semicolon
id|unix_peer
c_func
(paren
id|sk
)paren
op_assign
l_int|NULL
suffix:semicolon
id|other
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
id|sunaddr
op_eq
l_int|NULL
)paren
(brace
id|kfree_skb
c_func
(paren
id|skb
comma
id|FREE_WRITE
)paren
suffix:semicolon
r_return
op_minus
id|ECONNRESET
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
op_logical_neg
id|other
)paren
(brace
id|other
op_assign
id|unix_find_other
c_func
(paren
id|sunaddr
comma
id|namelen
comma
id|sk-&gt;type
comma
id|hash
comma
op_amp
id|err
)paren
suffix:semicolon
r_if
c_cond
(paren
id|other
op_eq
l_int|NULL
)paren
(brace
id|kfree_skb
c_func
(paren
id|skb
comma
id|FREE_WRITE
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|unix_may_send
c_func
(paren
id|sk
comma
id|other
)paren
)paren
(brace
id|unix_unlock
c_func
(paren
id|other
)paren
suffix:semicolon
id|kfree_skb
c_func
(paren
id|skb
comma
id|FREE_WRITE
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
)brace
id|skb_queue_tail
c_func
(paren
op_amp
id|other-&gt;receive_queue
comma
id|skb
)paren
suffix:semicolon
id|other
op_member_access_from_pointer
id|data_ready
c_func
(paren
id|other
comma
id|len
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|unix_peer
c_func
(paren
id|sk
)paren
)paren
id|unix_unlock
c_func
(paren
id|other
)paren
suffix:semicolon
r_return
id|len
suffix:semicolon
)brace
DECL|function|unix_stream_sendmsg
r_static
r_int
id|unix_stream_sendmsg
c_func
(paren
r_struct
id|socket
op_star
id|sock
comma
r_struct
id|msghdr
op_star
id|msg
comma
r_int
id|len
comma
r_struct
id|scm_cookie
op_star
id|scm
)paren
(brace
r_struct
id|sock
op_star
id|sk
op_assign
id|sock-&gt;sk
suffix:semicolon
id|unix_socket
op_star
id|other
suffix:semicolon
r_struct
id|sockaddr_un
op_star
id|sunaddr
op_assign
id|msg-&gt;msg_name
suffix:semicolon
r_int
id|err
comma
id|size
suffix:semicolon
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
r_int
id|limit
op_assign
l_int|0
suffix:semicolon
r_int
id|sent
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|sock-&gt;flags
op_amp
id|SO_ACCEPTCON
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|msg-&gt;msg_flags
op_amp
id|MSG_OOB
)paren
r_return
op_minus
id|EOPNOTSUPP
suffix:semicolon
r_if
c_cond
(paren
id|msg-&gt;msg_flags
op_amp
op_complement
id|MSG_DONTWAIT
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|msg-&gt;msg_namelen
)paren
(brace
r_if
c_cond
(paren
id|sk-&gt;state
op_eq
id|TCP_ESTABLISHED
)paren
r_return
op_minus
id|EISCONN
suffix:semicolon
r_else
r_return
op_minus
id|EOPNOTSUPP
suffix:semicolon
)brace
r_else
(brace
id|sunaddr
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|unix_peer
c_func
(paren
id|sk
)paren
)paren
r_return
op_minus
id|ENOTCONN
suffix:semicolon
)brace
r_if
c_cond
(paren
id|sk-&gt;shutdown
op_amp
id|SEND_SHUTDOWN
)paren
(brace
id|send_sig
c_func
(paren
id|SIGPIPE
comma
id|current
comma
l_int|0
)paren
suffix:semicolon
r_return
op_minus
id|EPIPE
suffix:semicolon
)brace
r_while
c_loop
(paren
id|sent
OL
id|len
)paren
(brace
multiline_comment|/*&n;&t;&t; *&t;Optimisation for the fact that under 0.01% of X messages typically&n;&t;&t; *&t;need breaking up.&n;&t;&t; */
id|size
op_assign
id|len
op_minus
id|sent
suffix:semicolon
r_if
c_cond
(paren
id|size
OG
(paren
id|sk-&gt;sndbuf
op_minus
r_sizeof
(paren
r_struct
id|sk_buff
)paren
)paren
op_div
l_int|2
)paren
multiline_comment|/* Keep two messages in the pipe so it schedules better */
id|size
op_assign
(paren
id|sk-&gt;sndbuf
op_minus
r_sizeof
(paren
r_struct
id|sk_buff
)paren
)paren
op_div
l_int|2
suffix:semicolon
multiline_comment|/*&n;&t;&t; *&t;Keep to page sized kmalloc()&squot;s as various people&n;&t;&t; *&t;have suggested. Big mallocs stress the vm too&n;&t;&t; *&t;much.&n;&t;&t; */
r_if
c_cond
(paren
id|size
OG
l_int|3500
)paren
id|limit
op_assign
l_int|3500
suffix:semicolon
multiline_comment|/* Fall back to a page if we can&squot;t grab a big buffer this instant */
r_else
id|limit
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Otherwise just grab and wait */
multiline_comment|/*&n;&t;&t; *&t;Grab a buffer&n;&t;&t; */
id|skb
op_assign
id|sock_alloc_send_skb
c_func
(paren
id|sk
comma
id|size
comma
id|limit
comma
id|msg-&gt;msg_flags
op_amp
id|MSG_DONTWAIT
comma
op_amp
id|err
)paren
suffix:semicolon
r_if
c_cond
(paren
id|skb
op_eq
l_int|NULL
)paren
(brace
r_if
c_cond
(paren
id|sent
)paren
r_return
id|sent
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
multiline_comment|/*&n;&t;&t; *&t;If you pass two values to the sock_alloc_send_skb&n;&t;&t; *&t;it tries to grab the large buffer with GFP_BUFFER&n;&t;&t; *&t;(which can fail easily), and if it fails grab the&n;&t;&t; *&t;fallback size buffer which is under a page and will&n;&t;&t; *&t;succeed. [Alan]&n;&t;&t; */
id|size
op_assign
id|min
c_func
(paren
id|size
comma
id|skb_tailroom
c_func
(paren
id|skb
)paren
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|UNIXCREDS
c_func
(paren
id|skb
)paren
comma
op_amp
id|scm-&gt;creds
comma
r_sizeof
(paren
r_struct
id|ucred
)paren
)paren
suffix:semicolon
id|UNIXCB
c_func
(paren
id|skb
)paren
dot
id|attr
op_assign
id|msg-&gt;msg_flags
suffix:semicolon
r_if
c_cond
(paren
id|scm-&gt;fp
)paren
id|unix_attach_fds
c_func
(paren
id|scm
comma
id|skb
)paren
suffix:semicolon
id|memcpy_fromiovec
c_func
(paren
id|skb_put
c_func
(paren
id|skb
comma
id|size
)paren
comma
id|msg-&gt;msg_iov
comma
id|size
)paren
suffix:semicolon
id|other
op_assign
id|unix_peer
c_func
(paren
id|sk
)paren
suffix:semicolon
r_if
c_cond
(paren
id|other-&gt;dead
op_logical_or
(paren
id|sk-&gt;shutdown
op_amp
id|SEND_SHUTDOWN
)paren
)paren
(brace
id|kfree_skb
c_func
(paren
id|skb
comma
id|FREE_WRITE
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sent
)paren
(brace
r_return
id|sent
suffix:semicolon
)brace
id|send_sig
c_func
(paren
id|SIGPIPE
comma
id|current
comma
l_int|0
)paren
suffix:semicolon
r_return
op_minus
id|EPIPE
suffix:semicolon
)brace
id|skb_queue_tail
c_func
(paren
op_amp
id|other-&gt;receive_queue
comma
id|skb
)paren
suffix:semicolon
id|other
op_member_access_from_pointer
id|data_ready
c_func
(paren
id|other
comma
id|size
)paren
suffix:semicolon
id|sent
op_add_assign
id|size
suffix:semicolon
)brace
r_return
id|sent
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;Sleep until data has arrive. But check for races..&n; */
DECL|function|unix_data_wait
r_static
r_void
id|unix_data_wait
c_func
(paren
id|unix_socket
op_star
id|sk
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|skb_peek
c_func
(paren
op_amp
id|sk-&gt;receive_queue
)paren
)paren
(brace
id|sk-&gt;socket-&gt;flags
op_or_assign
id|SO_WAITDATA
suffix:semicolon
id|interruptible_sleep_on
c_func
(paren
id|sk-&gt;sleep
)paren
suffix:semicolon
id|sk-&gt;socket-&gt;flags
op_and_assign
op_complement
id|SO_WAITDATA
suffix:semicolon
)brace
)brace
DECL|function|unix_dgram_recvmsg
r_static
r_int
id|unix_dgram_recvmsg
c_func
(paren
r_struct
id|socket
op_star
id|sock
comma
r_struct
id|msghdr
op_star
id|msg
comma
r_int
id|size
comma
r_int
id|flags
comma
r_struct
id|scm_cookie
op_star
id|scm
)paren
(brace
r_struct
id|sock
op_star
id|sk
op_assign
id|sock-&gt;sk
suffix:semicolon
r_int
id|noblock
op_assign
id|flags
op_amp
id|MSG_DONTWAIT
suffix:semicolon
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
r_int
id|err
suffix:semicolon
r_if
c_cond
(paren
id|flags
op_amp
id|MSG_OOB
)paren
r_return
op_minus
id|EOPNOTSUPP
suffix:semicolon
id|msg-&gt;msg_namelen
op_assign
l_int|0
suffix:semicolon
id|skb
op_assign
id|skb_recv_datagram
c_func
(paren
id|sk
comma
id|flags
comma
id|noblock
comma
op_amp
id|err
)paren
suffix:semicolon
r_if
c_cond
(paren
id|skb
op_eq
l_int|NULL
)paren
(brace
r_return
id|err
suffix:semicolon
)brace
r_if
c_cond
(paren
id|msg-&gt;msg_name
)paren
(brace
r_if
c_cond
(paren
id|skb-&gt;sk-&gt;protinfo.af_unix.addr
)paren
(brace
id|memcpy
c_func
(paren
id|msg-&gt;msg_name
comma
id|skb-&gt;sk-&gt;protinfo.af_unix.addr-&gt;name
comma
id|skb-&gt;sk-&gt;protinfo.af_unix.addr-&gt;len
)paren
suffix:semicolon
id|msg-&gt;msg_namelen
op_assign
id|skb-&gt;sk-&gt;protinfo.af_unix.addr-&gt;len
suffix:semicolon
)brace
r_else
id|msg-&gt;msg_namelen
op_assign
r_sizeof
(paren
r_int
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|size
OG
id|skb-&gt;len
)paren
id|size
op_assign
id|skb-&gt;len
suffix:semicolon
r_else
r_if
c_cond
(paren
id|size
OL
id|skb-&gt;len
)paren
id|msg-&gt;msg_flags
op_or_assign
id|MSG_TRUNC
suffix:semicolon
r_if
c_cond
(paren
id|skb_copy_datagram_iovec
c_func
(paren
id|skb
comma
l_int|0
comma
id|msg-&gt;msg_iov
comma
id|size
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
id|scm-&gt;creds
op_assign
op_star
id|UNIXCREDS
c_func
(paren
id|skb
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|flags
op_amp
id|MSG_PEEK
)paren
)paren
(brace
r_if
c_cond
(paren
id|UNIXCB
c_func
(paren
id|skb
)paren
dot
id|fp
)paren
id|unix_detach_fds
c_func
(paren
id|scm
comma
id|skb
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* It is questionable: on PEEK we could:&n;&t;&t;   - do not return fds - good, but too simple 8)&n;&t;&t;   - return fds, and do not return them on read (old strategy,&n;&t;&t;     apparently wrong)&n;&t;&t;   - clone fds (I choosed it for now, it is the most universal&n;&t;&t;     solution)&n;&t;&t;&n;&t;           POSIX 1003.1g does not actually define this clearly&n;&t;           at all. POSIX 1003.1g doesn&squot;t define a lot of things&n;&t;           clearly however!&t;&t;     &n;&t;&t;   &n;&t;&t;*/
r_if
c_cond
(paren
id|UNIXCB
c_func
(paren
id|skb
)paren
dot
id|fp
)paren
id|scm-&gt;fp
op_assign
id|scm_fp_dup
c_func
(paren
id|UNIXCB
c_func
(paren
id|skb
)paren
dot
id|fp
)paren
suffix:semicolon
)brace
id|skb_free_datagram
c_func
(paren
id|sk
comma
id|skb
)paren
suffix:semicolon
r_return
id|size
suffix:semicolon
)brace
DECL|function|unix_stream_recvmsg
r_static
r_int
id|unix_stream_recvmsg
c_func
(paren
r_struct
id|socket
op_star
id|sock
comma
r_struct
id|msghdr
op_star
id|msg
comma
r_int
id|size
comma
r_int
id|flags
comma
r_struct
id|scm_cookie
op_star
id|scm
)paren
(brace
r_struct
id|sock
op_star
id|sk
op_assign
id|sock-&gt;sk
suffix:semicolon
r_int
id|noblock
op_assign
id|flags
op_amp
id|MSG_DONTWAIT
suffix:semicolon
r_struct
id|sockaddr_un
op_star
id|sunaddr
op_assign
id|msg-&gt;msg_name
suffix:semicolon
r_int
id|copied
op_assign
l_int|0
suffix:semicolon
r_int
id|check_creds
op_assign
l_int|0
suffix:semicolon
r_int
id|target
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|sock-&gt;flags
op_amp
id|SO_ACCEPTCON
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|flags
op_amp
id|MSG_OOB
)paren
r_return
op_minus
id|EOPNOTSUPP
suffix:semicolon
r_if
c_cond
(paren
id|flags
op_amp
id|MSG_WAITALL
)paren
(brace
id|target
op_assign
id|size
suffix:semicolon
)brace
id|msg-&gt;msg_namelen
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Lock the socket to prevent queue disordering&n;&t; * while sleeps in memcpy_tomsg&n;&t; */
id|down
c_func
(paren
op_amp
id|sk-&gt;protinfo.af_unix.readsem
)paren
suffix:semicolon
r_do
(brace
r_int
id|chunk
suffix:semicolon
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
id|skb
op_assign
id|skb_dequeue
c_func
(paren
op_amp
id|sk-&gt;receive_queue
)paren
suffix:semicolon
r_if
c_cond
(paren
id|skb
op_eq
l_int|NULL
)paren
(brace
r_if
c_cond
(paren
id|copied
op_ge
id|target
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
id|sk-&gt;err
)paren
r_return
id|sock_error
c_func
(paren
id|sk
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sk-&gt;shutdown
op_amp
id|RCV_SHUTDOWN
)paren
r_break
suffix:semicolon
id|up
c_func
(paren
op_amp
id|sk-&gt;protinfo.af_unix.readsem
)paren
suffix:semicolon
r_if
c_cond
(paren
id|noblock
)paren
r_return
op_minus
id|EAGAIN
suffix:semicolon
id|unix_data_wait
c_func
(paren
id|sk
)paren
suffix:semicolon
r_if
c_cond
(paren
id|current-&gt;signal
op_amp
op_complement
id|current-&gt;blocked
)paren
r_return
op_minus
id|ERESTARTSYS
suffix:semicolon
id|down
c_func
(paren
op_amp
id|sk-&gt;protinfo.af_unix.readsem
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
multiline_comment|/* Never glue messages from different writers */
r_if
c_cond
(paren
id|check_creds
op_logical_and
id|memcmp
c_func
(paren
id|UNIXCREDS
c_func
(paren
id|skb
)paren
comma
op_amp
id|scm-&gt;creds
comma
r_sizeof
(paren
id|scm-&gt;creds
)paren
)paren
op_ne
l_int|0
)paren
(brace
id|skb_queue_head
c_func
(paren
op_amp
id|sk-&gt;receive_queue
comma
id|skb
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
multiline_comment|/* Copy address just once */
r_if
c_cond
(paren
id|sunaddr
)paren
(brace
r_if
c_cond
(paren
id|skb-&gt;sk-&gt;protinfo.af_unix.addr
)paren
(brace
id|memcpy
c_func
(paren
id|sunaddr
comma
id|skb-&gt;sk-&gt;protinfo.af_unix.addr-&gt;name
comma
id|skb-&gt;sk-&gt;protinfo.af_unix.addr-&gt;len
)paren
suffix:semicolon
id|msg-&gt;msg_namelen
op_assign
id|skb-&gt;sk-&gt;protinfo.af_unix.addr-&gt;len
suffix:semicolon
)brace
r_else
id|msg-&gt;msg_namelen
op_assign
r_sizeof
(paren
r_int
)paren
suffix:semicolon
id|sunaddr
op_assign
l_int|NULL
suffix:semicolon
)brace
id|chunk
op_assign
id|min
c_func
(paren
id|skb-&gt;len
comma
id|size
)paren
suffix:semicolon
id|memcpy_toiovec
c_func
(paren
id|msg-&gt;msg_iov
comma
id|skb-&gt;data
comma
id|chunk
)paren
suffix:semicolon
id|copied
op_add_assign
id|chunk
suffix:semicolon
id|size
op_sub_assign
id|chunk
suffix:semicolon
multiline_comment|/* Copy credentials */
id|scm-&gt;creds
op_assign
op_star
id|UNIXCREDS
c_func
(paren
id|skb
)paren
suffix:semicolon
id|check_creds
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* Mark read part of skb as used */
r_if
c_cond
(paren
op_logical_neg
(paren
id|flags
op_amp
id|MSG_PEEK
)paren
)paren
(brace
id|skb_pull
c_func
(paren
id|skb
comma
id|chunk
)paren
suffix:semicolon
r_if
c_cond
(paren
id|UNIXCB
c_func
(paren
id|skb
)paren
dot
id|fp
)paren
id|unix_detach_fds
c_func
(paren
id|scm
comma
id|skb
)paren
suffix:semicolon
multiline_comment|/* put the skb back if we didn&squot;t use it up.. */
r_if
c_cond
(paren
id|skb-&gt;len
)paren
(brace
id|skb_queue_head
c_func
(paren
op_amp
id|sk-&gt;receive_queue
comma
id|skb
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|kfree_skb
c_func
(paren
id|skb
comma
id|FREE_WRITE
)paren
suffix:semicolon
r_if
c_cond
(paren
id|scm-&gt;fp
)paren
r_break
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* It is questionable, see note in unix_dgram_recvmsg.&n;&t;&t;&t;   &n;&t;&t;&t; */
r_if
c_cond
(paren
id|UNIXCB
c_func
(paren
id|skb
)paren
dot
id|fp
)paren
id|scm-&gt;fp
op_assign
id|scm_fp_dup
c_func
(paren
id|UNIXCB
c_func
(paren
id|skb
)paren
dot
id|fp
)paren
suffix:semicolon
multiline_comment|/* put message back and return */
id|skb_queue_head
c_func
(paren
op_amp
id|sk-&gt;receive_queue
comma
id|skb
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
r_while
c_loop
(paren
id|size
)paren
suffix:semicolon
id|up
c_func
(paren
op_amp
id|sk-&gt;protinfo.af_unix.readsem
)paren
suffix:semicolon
r_return
id|copied
suffix:semicolon
)brace
DECL|function|unix_shutdown
r_static
r_int
id|unix_shutdown
c_func
(paren
r_struct
id|socket
op_star
id|sock
comma
r_int
id|mode
)paren
(brace
r_struct
id|sock
op_star
id|sk
op_assign
id|sock-&gt;sk
suffix:semicolon
id|unix_socket
op_star
id|other
op_assign
id|unix_peer
c_func
(paren
id|sk
)paren
suffix:semicolon
id|mode
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|mode
op_amp
id|SEND_SHUTDOWN
)paren
(brace
id|sk-&gt;shutdown
op_or_assign
id|SEND_SHUTDOWN
suffix:semicolon
id|sk
op_member_access_from_pointer
id|state_change
c_func
(paren
id|sk
)paren
suffix:semicolon
r_if
c_cond
(paren
id|other
op_logical_and
id|sk-&gt;type
op_eq
id|SOCK_STREAM
op_logical_and
id|other-&gt;state
op_ne
id|TCP_LISTEN
)paren
(brace
r_if
c_cond
(paren
id|unix_our_peer
c_func
(paren
id|sk
comma
id|other
)paren
)paren
id|other-&gt;shutdown
op_or_assign
id|RCV_SHUTDOWN
suffix:semicolon
id|other
op_member_access_from_pointer
id|state_change
c_func
(paren
id|other
)paren
suffix:semicolon
)brace
)brace
id|other
op_assign
id|unix_peer
c_func
(paren
id|sk
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mode
op_amp
id|RCV_SHUTDOWN
)paren
(brace
id|sk-&gt;shutdown
op_or_assign
id|RCV_SHUTDOWN
suffix:semicolon
id|sk
op_member_access_from_pointer
id|state_change
c_func
(paren
id|sk
)paren
suffix:semicolon
r_if
c_cond
(paren
id|other
op_logical_and
id|sk-&gt;type
op_ne
id|SOCK_DGRAM
op_logical_and
id|other-&gt;state
op_ne
id|TCP_LISTEN
)paren
(brace
r_if
c_cond
(paren
id|unix_our_peer
c_func
(paren
id|sk
comma
id|other
)paren
)paren
id|other-&gt;shutdown
op_or_assign
id|SEND_SHUTDOWN
suffix:semicolon
id|other
op_member_access_from_pointer
id|state_change
c_func
(paren
id|other
)paren
suffix:semicolon
)brace
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|unix_ioctl
r_static
r_int
id|unix_ioctl
c_func
(paren
r_struct
id|socket
op_star
id|sock
comma
r_int
r_int
id|cmd
comma
r_int
r_int
id|arg
)paren
(brace
r_struct
id|sock
op_star
id|sk
op_assign
id|sock-&gt;sk
suffix:semicolon
r_int
id|amount
op_assign
l_int|0
suffix:semicolon
r_switch
c_cond
(paren
id|cmd
)paren
(brace
r_case
id|TIOCOUTQ
suffix:colon
id|amount
op_assign
id|sk-&gt;sndbuf
op_minus
id|atomic_read
c_func
(paren
op_amp
id|sk-&gt;wmem_alloc
)paren
suffix:semicolon
r_if
c_cond
(paren
id|amount
OL
l_int|0
)paren
(brace
id|amount
op_assign
l_int|0
suffix:semicolon
)brace
r_return
id|put_user
c_func
(paren
id|amount
comma
(paren
r_int
op_star
)paren
id|arg
)paren
suffix:semicolon
r_case
id|TIOCINQ
suffix:colon
(brace
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
r_if
c_cond
(paren
id|sk-&gt;state
op_eq
id|TCP_LISTEN
)paren
(brace
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
multiline_comment|/*&n;&t;&t;&t; *&t;These two are safe on current systems as&n;&t;&t;&t; *&t;only user tasks fiddle here&n;&t;&t;&t; */
r_if
c_cond
(paren
(paren
id|skb
op_assign
id|skb_peek
c_func
(paren
op_amp
id|sk-&gt;receive_queue
)paren
)paren
op_ne
l_int|NULL
)paren
(brace
id|amount
op_assign
id|skb-&gt;len
suffix:semicolon
)brace
r_return
id|put_user
c_func
(paren
id|amount
comma
(paren
r_int
op_star
)paren
id|arg
)paren
suffix:semicolon
)brace
r_default
suffix:colon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
multiline_comment|/*NOTREACHED*/
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#ifdef CONFIG_PROC_FS
DECL|function|unix_read_proc
r_static
r_int
id|unix_read_proc
c_func
(paren
r_char
op_star
id|buffer
comma
r_char
op_star
op_star
id|start
comma
id|off_t
id|offset
comma
r_int
id|length
comma
r_int
op_star
id|eof
comma
r_void
op_star
id|data
)paren
(brace
id|off_t
id|pos
op_assign
l_int|0
suffix:semicolon
id|off_t
id|begin
op_assign
l_int|0
suffix:semicolon
r_int
id|len
op_assign
l_int|0
suffix:semicolon
r_int
id|i
suffix:semicolon
id|unix_socket
op_star
id|s
suffix:semicolon
id|len
op_add_assign
id|sprintf
c_func
(paren
id|buffer
comma
l_string|&quot;Num       RefCount Protocol Flags    Type St &quot;
l_string|&quot;Inode Path&bslash;n&quot;
)paren
suffix:semicolon
id|forall_unix_sockets
(paren
id|i
comma
id|s
)paren
(brace
id|len
op_add_assign
id|sprintf
c_func
(paren
id|buffer
op_plus
id|len
comma
l_string|&quot;%p: %08X %08X %08lX %04X %02X %5ld&quot;
comma
id|s
comma
id|s-&gt;sock_readers
comma
l_int|0
comma
id|s-&gt;socket
ques
c_cond
id|s-&gt;socket-&gt;flags
suffix:colon
l_int|0
comma
id|s-&gt;type
comma
id|s-&gt;socket
ques
c_cond
id|s-&gt;socket-&gt;state
suffix:colon
l_int|0
comma
id|s-&gt;socket
ques
c_cond
id|s-&gt;socket-&gt;inode-&gt;i_ino
suffix:colon
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|s-&gt;protinfo.af_unix.addr
)paren
(brace
id|buffer
(braket
id|len
op_increment
)braket
op_assign
l_char|&squot; &squot;
suffix:semicolon
id|memcpy
c_func
(paren
id|buffer
op_plus
id|len
comma
id|s-&gt;protinfo.af_unix.addr-&gt;name-&gt;sun_path
comma
id|s-&gt;protinfo.af_unix.addr-&gt;len
op_minus
r_sizeof
(paren
r_int
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|UNIX_ABSTRACT
c_func
(paren
id|s
)paren
)paren
id|len
op_decrement
suffix:semicolon
r_else
id|buffer
(braket
id|len
)braket
op_assign
l_char|&squot;@&squot;
suffix:semicolon
id|len
op_add_assign
id|s-&gt;protinfo.af_unix.addr-&gt;len
op_minus
r_sizeof
(paren
r_int
)paren
suffix:semicolon
)brace
id|buffer
(braket
id|len
op_increment
)braket
op_assign
l_char|&squot;&bslash;n&squot;
suffix:semicolon
id|pos
op_assign
id|begin
op_plus
id|len
suffix:semicolon
r_if
c_cond
(paren
id|pos
OL
id|offset
)paren
(brace
id|len
op_assign
l_int|0
suffix:semicolon
id|begin
op_assign
id|pos
suffix:semicolon
)brace
r_if
c_cond
(paren
id|pos
OG
id|offset
op_plus
id|length
)paren
(brace
r_goto
id|done
suffix:semicolon
)brace
)brace
op_star
id|eof
op_assign
l_int|1
suffix:semicolon
id|done
suffix:colon
op_star
id|start
op_assign
id|buffer
op_plus
(paren
id|offset
op_minus
id|begin
)paren
suffix:semicolon
id|len
op_sub_assign
(paren
id|offset
op_minus
id|begin
)paren
suffix:semicolon
r_if
c_cond
(paren
id|len
OG
id|length
)paren
(brace
id|len
op_assign
id|length
suffix:semicolon
)brace
r_return
id|len
suffix:semicolon
)brace
macro_line|#endif
DECL|variable|unix_stream_ops
r_struct
id|proto_ops
id|unix_stream_ops
op_assign
(brace
id|AF_UNIX
comma
id|unix_dup
comma
id|unix_release
comma
id|unix_bind
comma
id|unix_stream_connect
comma
id|unix_socketpair
comma
id|unix_accept
comma
id|unix_getname
comma
id|datagram_poll
comma
id|unix_ioctl
comma
id|unix_listen
comma
id|unix_shutdown
comma
id|sock_no_setsockopt
comma
id|sock_no_getsockopt
comma
id|sock_no_fcntl
comma
id|unix_stream_sendmsg
comma
id|unix_stream_recvmsg
)brace
suffix:semicolon
DECL|variable|unix_dgram_ops
r_struct
id|proto_ops
id|unix_dgram_ops
op_assign
(brace
id|AF_UNIX
comma
id|unix_dup
comma
id|unix_release
comma
id|unix_bind
comma
id|unix_dgram_connect
comma
id|unix_socketpair
comma
l_int|NULL
comma
id|unix_getname
comma
id|datagram_poll
comma
id|unix_ioctl
comma
id|sock_no_listen
comma
id|unix_shutdown
comma
id|sock_no_setsockopt
comma
id|sock_no_getsockopt
comma
id|sock_no_fcntl
comma
id|unix_dgram_sendmsg
comma
id|unix_dgram_recvmsg
)brace
suffix:semicolon
DECL|variable|unix_family_ops
r_struct
id|net_proto_family
id|unix_family_ops
op_assign
(brace
id|AF_UNIX
comma
id|unix_create
)brace
suffix:semicolon
DECL|function|__initfunc
id|__initfunc
c_func
(paren
r_void
id|unix_proto_init
c_func
(paren
r_struct
id|net_proto
op_star
id|pro
)paren
)paren
(brace
r_struct
id|sk_buff
op_star
id|dummy_skb
suffix:semicolon
r_struct
id|proc_dir_entry
op_star
id|ent
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;NET3: Unix domain sockets 0.16 for Linux NET3.038.&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
r_sizeof
(paren
r_struct
id|unix_skb_parms
)paren
OG
r_sizeof
(paren
id|dummy_skb-&gt;cb
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_CRIT
l_string|&quot;unix_proto_init: panic&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|sock_register
c_func
(paren
op_amp
id|unix_family_ops
)paren
suffix:semicolon
macro_line|#ifdef CONFIG_PROC_FS
id|ent
op_assign
id|create_proc_entry
c_func
(paren
l_string|&quot;net/unix&quot;
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
id|ent-&gt;read_proc
op_assign
id|unix_read_proc
suffix:semicolon
macro_line|#endif
)brace
multiline_comment|/*&n; * Local variables:&n; *  compile-command: &quot;gcc -g -D__KERNEL__ -Wall -O6 -I/usr/src/linux/include -c af_unix.c&quot;&n; * End:&n; */
eof
