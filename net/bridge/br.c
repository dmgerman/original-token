multiline_comment|/*&n; *&t;Linux NET3 Bridge Support&n; *&n; *&t;Originally by John Hayes (Network Plumbing).&n; *&t;Minor hacks to get it to run with 1.3.x by Alan Cox &lt;Alan.Cox@linux.org&gt;&n; *&t;More hacks to be able to switch protocols on and off by Christoph Lameter&n; *&t;&lt;clameter@debian.org&gt;&n; *&t;Software and more Documentation for the bridge is available from ftp.debian.org&n; *&t;in the bridge package or at ftp.fuller.edu/Linux/bridge&n; *&n; *&t;This program is free software; you can redistribute it and/or&n; *&t;modify it under the terms of the GNU General Public License&n; *&t;as published by the Free Software Foundation; either version&n; *&t;2 of the License, or (at your option) any later version.&n; *&n; * Fixes:&n; *&t;Yury Shevchuk&t;:&t;Bridge with non bridging ports&n; *&t;Jean-Rene Peulve: jr.peulve@aix.pacwan.net &t;&t;Jan/Feb 98&n; *&t;&t;&t;support Linux 2.0&n; *&t;&t;&t;Handle Receive config bpdu&n; *&t;&t;&t;kick mark_bh to send Spanning Tree pdus&n; *&t;&t;&t;bridgeId comparison using htonl()&n; *&t;&t;&t;make STP interoperable with other vendors&n; *&t;&t;&t;wrong test in root_selection()&n; *&t;&t;&t;add more STP debug info &n; *&t;&t;&t;some performance improvments&n; *&t;&t;&t;do not clear bridgeId.mac  while setting priority&n; *&t;&t;&t;do not reset port priority when starting bridge&n; *&t;&t;&t;make port priority from user value and port number&n; *&t;&t;&t;maintains user port state out of device state&n; *&t;&t;&t;broacast/multicast storm limitation&n; *&t;&t;&t;forwarding statistics&n; *&t;&t;&t;stop br_tick when bridge is turn off&n; *&t;&t;&t;add local MACs in avl_tree to forward up stack&n; *&t;&t;&t;fake receive on right port for IP/ARP &n; *&t;&t;&t;ages tree even if packet does not cross bridge&n; *&t;&t;&t;add BRCMD_DISPLAY_FDB (ioctl for now)&n; *&n; *&t;Alan Cox:&t;Merged Jean-Rene&squot;s stuff, reformatted stuff a bit&n; *&t;&t;&t;so blame me first if its broken ;)&n; *&n; *&t;Todo:&n; *&t;&t;Don&squot;t bring up devices automatically. Start ports disabled&n; *&t;and use a netlink notifier so a daemon can maintain the bridge&n; *&t;port group (could we also do multiple groups ????).&n; *&t;&t;A nice /proc file interface.&n; *&t;&t;Put the path costs in the port info and devices.&n; *&t;&t;Put the bridge port number in the device structure for speed.&n; *&t;&t;Bridge SNMP stats.&n; *&t;&n; */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/socket.h&gt;
macro_line|#include &lt;linux/in.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/timer.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/net.h&gt;
macro_line|#include &lt;linux/inet.h&gt;
macro_line|#include &lt;linux/netdevice.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/skbuff.h&gt;
macro_line|#include &lt;linux/if_arp.h&gt;
macro_line|#include &lt;linux/ip.h&gt;
macro_line|#include &lt;linux/version.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;asm/uaccess.h&gt;
macro_line|#include &lt;asm/system.h&gt;
macro_line|#include &lt;net/br.h&gt;
macro_line|#include &lt;linux/proc_fs.h&gt;
macro_line|#ifndef min
DECL|macro|min
mdefine_line|#define min(a, b) (((a) &lt;= (b)) ? (a) : (b))
macro_line|#endif
r_static
r_void
id|transmit_config
c_func
(paren
r_int
id|port_no
)paren
suffix:semicolon
r_static
r_int
id|root_bridge
c_func
(paren
r_void
)paren
suffix:semicolon
r_static
r_int
id|supersedes_port_info
c_func
(paren
r_int
id|port_no
comma
id|Config_bpdu
op_star
id|config
)paren
suffix:semicolon
r_static
r_void
id|record_config_information
c_func
(paren
r_int
id|port_no
comma
id|Config_bpdu
op_star
id|config
)paren
suffix:semicolon
r_static
r_void
id|record_config_timeout_values
c_func
(paren
id|Config_bpdu
op_star
id|config
)paren
suffix:semicolon
r_static
r_void
id|config_bpdu_generation
c_func
(paren
r_void
)paren
suffix:semicolon
r_static
r_int
id|designated_port
c_func
(paren
r_int
id|port_no
)paren
suffix:semicolon
r_static
r_void
id|reply
c_func
(paren
r_int
id|port_no
)paren
suffix:semicolon
r_static
r_void
id|transmit_tcn
c_func
(paren
r_void
)paren
suffix:semicolon
r_static
r_void
id|configuration_update
c_func
(paren
r_void
)paren
suffix:semicolon
r_static
r_void
id|root_selection
c_func
(paren
r_void
)paren
suffix:semicolon
r_static
r_void
id|designated_port_selection
c_func
(paren
r_void
)paren
suffix:semicolon
r_static
r_void
id|become_designated_port
c_func
(paren
r_int
id|port_no
)paren
suffix:semicolon
r_static
r_void
id|port_state_selection
c_func
(paren
r_void
)paren
suffix:semicolon
r_static
r_void
id|make_forwarding
c_func
(paren
r_int
id|port_no
)paren
suffix:semicolon
r_static
r_void
id|topology_change_detection
c_func
(paren
r_void
)paren
suffix:semicolon
r_static
r_void
id|topology_change_acknowledged
c_func
(paren
r_void
)paren
suffix:semicolon
r_static
r_void
id|acknowledge_topology_change
c_func
(paren
r_int
id|port_no
)paren
suffix:semicolon
r_static
r_void
id|make_blocking
c_func
(paren
r_int
id|port_no
)paren
suffix:semicolon
r_static
r_void
id|set_port_state
c_func
(paren
r_int
id|port_no
comma
r_int
id|state
)paren
suffix:semicolon
r_static
r_void
id|received_config_bpdu
c_func
(paren
r_int
id|port_no
comma
id|Config_bpdu
op_star
id|config
)paren
suffix:semicolon
r_static
r_void
id|received_tcn_bpdu
c_func
(paren
r_int
id|port_no
comma
id|Tcn_bpdu
op_star
id|tcn
)paren
suffix:semicolon
r_static
r_void
id|hello_timer_expiry
c_func
(paren
r_void
)paren
suffix:semicolon
r_static
r_void
id|message_age_timer_expiry
c_func
(paren
r_int
id|port_no
)paren
suffix:semicolon
r_static
r_void
id|forward_delay_timer_expiry
c_func
(paren
r_int
id|port_no
)paren
suffix:semicolon
r_static
r_int
id|designated_for_some_port
c_func
(paren
r_void
)paren
suffix:semicolon
r_static
r_void
id|tcn_timer_expiry
c_func
(paren
r_void
)paren
suffix:semicolon
r_static
r_void
id|topology_change_timer_expiry
c_func
(paren
r_void
)paren
suffix:semicolon
r_static
r_void
id|hold_timer_expiry
c_func
(paren
r_int
id|port_no
)paren
suffix:semicolon
r_static
r_void
id|br_init_port
c_func
(paren
r_int
id|port_no
)paren
suffix:semicolon
r_static
r_void
id|enable_port
c_func
(paren
r_int
id|port_no
)paren
suffix:semicolon
r_static
r_void
id|disable_port
c_func
(paren
r_int
id|port_no
)paren
suffix:semicolon
r_static
r_void
id|set_bridge_priority
c_func
(paren
id|bridge_id_t
op_star
id|new_bridge_id
)paren
suffix:semicolon
r_static
r_void
id|set_port_priority
c_func
(paren
r_int
id|port_no
)paren
suffix:semicolon
r_static
r_void
id|set_path_cost
c_func
(paren
r_int
id|port_no
comma
r_int
r_int
id|path_cost
)paren
suffix:semicolon
r_static
r_void
id|start_hello_timer
c_func
(paren
r_void
)paren
suffix:semicolon
r_static
r_void
id|stop_hello_timer
c_func
(paren
r_void
)paren
suffix:semicolon
r_static
r_int
id|hello_timer_expired
c_func
(paren
r_void
)paren
suffix:semicolon
r_static
r_void
id|start_tcn_timer
c_func
(paren
r_void
)paren
suffix:semicolon
r_static
r_void
id|stop_tcn_timer
c_func
(paren
r_void
)paren
suffix:semicolon
r_static
r_int
id|tcn_timer_expired
c_func
(paren
r_void
)paren
suffix:semicolon
r_static
r_void
id|start_topology_change_timer
c_func
(paren
r_void
)paren
suffix:semicolon
r_static
r_void
id|stop_topology_change_timer
c_func
(paren
r_void
)paren
suffix:semicolon
r_static
r_int
id|topology_change_timer_expired
c_func
(paren
r_void
)paren
suffix:semicolon
r_static
r_void
id|start_message_age_timer
c_func
(paren
r_int
id|port_no
comma
r_int
r_int
id|message_age
)paren
suffix:semicolon
r_static
r_void
id|stop_message_age_timer
c_func
(paren
r_int
id|port_no
)paren
suffix:semicolon
r_static
r_int
id|message_age_timer_expired
c_func
(paren
r_int
id|port_no
)paren
suffix:semicolon
r_static
r_void
id|start_forward_delay_timer
c_func
(paren
r_int
id|port_no
)paren
suffix:semicolon
r_static
r_void
id|stop_forward_delay_timer
c_func
(paren
r_int
id|port_no
)paren
suffix:semicolon
r_static
r_int
id|forward_delay_timer_expired
c_func
(paren
r_int
id|port_no
)paren
suffix:semicolon
r_static
r_void
id|start_hold_timer
c_func
(paren
r_int
id|port_no
)paren
suffix:semicolon
r_static
r_void
id|stop_hold_timer
c_func
(paren
r_int
id|port_no
)paren
suffix:semicolon
r_static
r_int
id|hold_timer_expired
c_func
(paren
r_int
id|port_no
)paren
suffix:semicolon
r_static
r_int
id|br_device_event
c_func
(paren
r_struct
id|notifier_block
op_star
id|dnot
comma
r_int
r_int
id|event
comma
r_void
op_star
id|ptr
)paren
suffix:semicolon
r_static
r_void
id|br_tick
c_func
(paren
r_int
r_int
id|arg
)paren
suffix:semicolon
r_static
r_int
id|br_forward
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_int
id|port
)paren
suffix:semicolon
multiline_comment|/* 3.7 */
r_static
r_int
id|br_port_cost
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
suffix:semicolon
multiline_comment|/* 4.10.2 */
r_static
r_void
id|br_bpdu
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_int
id|port
)paren
suffix:semicolon
multiline_comment|/* consumes skb */
r_static
r_int
id|br_cmp
c_func
(paren
r_int
r_int
op_star
id|a
comma
r_int
r_int
op_star
id|b
)paren
suffix:semicolon
r_static
r_int
id|send_tcn_bpdu
c_func
(paren
r_int
id|port_no
comma
id|Tcn_bpdu
op_star
id|bpdu
)paren
suffix:semicolon
r_static
r_int
id|send_config_bpdu
c_func
(paren
r_int
id|port_no
comma
id|Config_bpdu
op_star
id|config_bpdu
)paren
suffix:semicolon
r_static
r_int
id|find_port
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_void
id|br_add_local_mac
c_func
(paren
r_int
r_char
op_star
id|mac
)paren
suffix:semicolon
r_static
r_int
id|br_flood
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_int
id|port
)paren
suffix:semicolon
r_static
r_int
id|br_drop
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
)paren
suffix:semicolon
r_static
r_int
id|br_learn
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_int
id|port
)paren
suffix:semicolon
multiline_comment|/* 3.8 */
DECL|variable|bridge_ula
r_static
r_int
r_char
id|bridge_ula
(braket
id|ETH_ALEN
)braket
op_assign
(brace
l_int|0x01
comma
l_int|0x80
comma
l_int|0xc2
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
)brace
suffix:semicolon
DECL|variable|bridge_info
r_static
id|Bridge_data
id|bridge_info
suffix:semicolon
multiline_comment|/* (4.5.3)&t; */
DECL|variable|port_info
id|Port_data
id|port_info
(braket
id|All_ports
)braket
suffix:semicolon
multiline_comment|/* (4.5.5)&t; */
multiline_comment|/* JRP: fdb cache 1/port save kmalloc/kfree on every frame */
DECL|variable|newfdb
r_struct
id|fdb
op_star
id|newfdb
(braket
id|All_ports
)braket
suffix:semicolon
DECL|variable|allocated_fdb_cnt
r_int
id|allocated_fdb_cnt
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* broacast/multicast storm limitation */
DECL|variable|max_mcast_per_period
r_int
id|max_mcast_per_period
op_assign
id|MAX_MCAST_PER_PERIOD
suffix:semicolon
DECL|variable|mcast_hold_time
r_int
id|mcast_hold_time
op_assign
id|MCAST_HOLD_TIME
suffix:semicolon
multiline_comment|/* JRP: next two bpdu are copied to skbuff so we need only 1 of each */
DECL|variable|config_bpdu
r_static
id|Config_bpdu
id|config_bpdu
suffix:semicolon
DECL|variable|tcn_bpdu
r_static
id|Tcn_bpdu
id|tcn_bpdu
suffix:semicolon
DECL|variable|port_priority
r_static
r_int
r_char
id|port_priority
(braket
id|All_ports
)braket
suffix:semicolon
DECL|variable|user_port_state
r_static
r_int
r_char
id|user_port_state
(braket
id|All_ports
)braket
suffix:semicolon
DECL|variable|hello_timer
r_static
id|Timer
id|hello_timer
suffix:semicolon
multiline_comment|/* (4.5.4.1)&t; */
DECL|variable|tcn_timer
r_static
id|Timer
id|tcn_timer
suffix:semicolon
multiline_comment|/* (4.5.4.2)&t; */
DECL|variable|topology_change_timer
r_static
id|Timer
id|topology_change_timer
suffix:semicolon
multiline_comment|/* (4.5.4.3)&t; */
DECL|variable|message_age_timer
r_static
id|Timer
id|message_age_timer
(braket
id|All_ports
)braket
suffix:semicolon
multiline_comment|/* (4.5.6.1)&t; */
DECL|variable|forward_delay_timer
r_static
id|Timer
id|forward_delay_timer
(braket
id|All_ports
)braket
suffix:semicolon
multiline_comment|/* (4.5.6.2)&t; */
DECL|variable|hold_timer
r_static
id|Timer
id|hold_timer
(braket
id|All_ports
)braket
suffix:semicolon
multiline_comment|/* (4.5.6.3)&t; */
multiline_comment|/* entries timeout after this many seconds */
DECL|variable|fdb_aging_time
r_int
r_int
id|fdb_aging_time
op_assign
id|FDB_TIMEOUT
suffix:semicolon
DECL|variable|br_stats
r_struct
id|br_stat
id|br_stats
suffix:semicolon
DECL|macro|br_stats_cnt
mdefine_line|#define br_stats_cnt br_stats.packet_cnts
DECL|variable|tl
r_static
r_struct
id|timer_list
id|tl
suffix:semicolon
multiline_comment|/* for 1 second timer... */
multiline_comment|/*&n; * the following structure is required so that we receive&n; * event notifications when network devices are enabled and&n; * disabled (ifconfig up and down).&n; */
DECL|variable|br_dev_notifier
r_static
r_struct
id|notifier_block
id|br_dev_notifier
op_assign
initialization_block
suffix:semicolon
multiline_comment|/*&n; * Implementation of Protocol specific bridging&n; *&n; * The protocols to be bridged or not to be bridged are stored in a hashed array. This is the old type&n; * of unlinked hash array where one simply takes the next cell if the one the hash function points to&n; * is occupied.&n; */
DECL|macro|BR_PROTOCOL_HASH
mdefine_line|#define BR_PROTOCOL_HASH(x) (x % BR_MAX_PROTOCOLS)
multiline_comment|/* Checks if that protocol type is to be bridged */
DECL|function|br_protocol_ok
r_int
id|br_protocol_ok
c_func
(paren
r_int
r_int
id|protocol
)paren
(brace
r_int
id|x
suffix:semicolon
multiline_comment|/* See if protocol statistics are to be kept */
r_if
c_cond
(paren
id|br_stats.flags
op_amp
id|BR_PROT_STATS
)paren
(brace
r_for
c_loop
(paren
id|x
op_assign
l_int|0
suffix:semicolon
id|x
OL
id|BR_MAX_PROT_STATS
op_logical_and
id|br_stats.prot_id
(braket
id|x
)braket
op_ne
id|protocol
op_logical_and
id|br_stats.prot_id
(braket
id|x
)braket
suffix:semicolon
id|x
op_increment
)paren
(brace
suffix:semicolon
)brace
r_if
c_cond
(paren
id|x
OL
id|BR_MAX_PROT_STATS
)paren
(brace
id|br_stats.prot_id
(braket
id|x
)braket
op_assign
id|protocol
suffix:semicolon
id|br_stats.prot_counter
(braket
id|x
)braket
op_increment
suffix:semicolon
)brace
)brace
r_for
c_loop
(paren
id|x
op_assign
id|BR_PROTOCOL_HASH
c_func
(paren
id|protocol
)paren
suffix:semicolon
id|br_stats.protocols
(braket
id|x
)braket
op_ne
l_int|0
suffix:semicolon
)paren
(brace
r_if
c_cond
(paren
id|br_stats.protocols
(braket
id|x
)braket
op_eq
id|protocol
)paren
r_return
op_logical_neg
id|br_stats.policy
suffix:semicolon
id|x
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|x
op_eq
id|BR_MAX_PROTOCOLS
)paren
id|x
op_assign
l_int|0
suffix:semicolon
)brace
r_return
id|br_stats.policy
suffix:semicolon
)brace
multiline_comment|/* Add a protocol to be handled opposite to the standard policy of the bridge */
DECL|function|br_add_exempt_protocol
r_static
r_int
id|br_add_exempt_protocol
c_func
(paren
r_int
r_int
id|p
)paren
(brace
r_int
id|x
suffix:semicolon
r_if
c_cond
(paren
id|p
op_eq
l_int|0
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|br_stats.exempt_protocols
OG
id|BR_MAX_PROTOCOLS
op_minus
l_int|2
)paren
r_return
op_minus
id|EXFULL
suffix:semicolon
r_for
c_loop
(paren
id|x
op_assign
id|BR_PROTOCOL_HASH
c_func
(paren
id|p
)paren
suffix:semicolon
id|br_stats.protocols
(braket
id|x
)braket
op_ne
l_int|0
suffix:semicolon
)paren
(brace
r_if
c_cond
(paren
id|br_stats.protocols
(braket
id|x
)braket
op_eq
id|p
)paren
r_return
l_int|0
suffix:semicolon
multiline_comment|/* Attempt to add the protocol a second time */
id|x
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|x
op_eq
id|BR_MAX_PROTOCOLS
)paren
id|x
op_assign
l_int|0
suffix:semicolon
)brace
id|br_stats.protocols
(braket
id|x
)braket
op_assign
id|p
suffix:semicolon
id|br_stats.exempt_protocols
op_increment
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Valid Policies are 0=No Protocols bridged 1=Bridge all protocols */
DECL|function|br_set_policy
r_static
r_int
id|br_set_policy
c_func
(paren
r_int
id|policy
)paren
(brace
r_if
c_cond
(paren
id|policy
OG
l_int|1
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|br_stats.policy
op_assign
id|policy
suffix:semicolon
multiline_comment|/* Policy change means initializing the exempt table */
id|memset
c_func
(paren
id|br_stats.protocols
comma
l_int|0
comma
r_sizeof
(paren
id|br_stats.protocols
)paren
)paren
suffix:semicolon
id|br_stats.exempt_protocols
op_assign
l_int|0
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/** Elements of Procedure (4.6) **/
multiline_comment|/*&n; * this section of code was graciously borrowed from the IEEE 802.1d&n; * specification section 4.9.1 starting on pg 69.  It has been&n; * modified somewhat to fit within our framework and structure.  It&n; * implements the spanning tree algorithm that is the heart of the&n; * 802.1d bridging protocol.&n; */
DECL|function|transmit_config
r_static
r_void
id|transmit_config
c_func
(paren
r_int
id|port_no
)paren
multiline_comment|/* (4.6.1)&t; */
(brace
r_if
c_cond
(paren
id|hold_timer
(braket
id|port_no
)braket
dot
id|active
)paren
(brace
multiline_comment|/* (4.6.1.3.1)&t; */
id|port_info
(braket
id|port_no
)braket
dot
id|config_pending
op_assign
id|TRUE
suffix:semicolon
multiline_comment|/* (4.6.1.3.1)&t; */
)brace
r_else
(brace
multiline_comment|/* (4.6.1.3.2)&t; */
id|config_bpdu.type
op_assign
id|BPDU_TYPE_CONFIG
suffix:semicolon
id|config_bpdu.root_id
op_assign
id|bridge_info.designated_root
suffix:semicolon
multiline_comment|/* (4.6.1.3.2(1)) */
id|config_bpdu.root_path_cost
op_assign
id|bridge_info.root_path_cost
suffix:semicolon
multiline_comment|/* (4.6.1.3.2(2)) */
id|config_bpdu.bridge_id
op_assign
id|bridge_info.bridge_id
suffix:semicolon
multiline_comment|/* (4.6.1.3.2(3)) */
id|config_bpdu.port_id
op_assign
id|port_info
(braket
id|port_no
)braket
dot
id|port_id
suffix:semicolon
multiline_comment|/*&n;&t;&t; * (4.6.1.3.2(4))&n;&t;&t; */
r_if
c_cond
(paren
id|root_bridge
c_func
(paren
)paren
)paren
(brace
id|config_bpdu.message_age
op_assign
id|Zero
suffix:semicolon
multiline_comment|/* (4.6.1.3.2(5)) */
)brace
r_else
(brace
id|config_bpdu.message_age
op_assign
id|message_age_timer
(braket
id|bridge_info.root_port
)braket
dot
id|value
op_plus
id|Message_age_increment
suffix:semicolon
multiline_comment|/* (4.6.1.3.2(6)) */
)brace
id|config_bpdu.max_age
op_assign
id|bridge_info.max_age
suffix:semicolon
multiline_comment|/* (4.6.1.3.2(7)) */
id|config_bpdu.hello_time
op_assign
id|bridge_info.hello_time
suffix:semicolon
id|config_bpdu.forward_delay
op_assign
id|bridge_info.forward_delay
suffix:semicolon
id|config_bpdu.top_change_ack
op_assign
id|port_info
(braket
id|port_no
)braket
dot
id|top_change_ack
suffix:semicolon
multiline_comment|/* (4.6.1.3.2(8)) */
id|port_info
(braket
id|port_no
)braket
dot
id|top_change_ack
op_assign
l_int|0
suffix:semicolon
id|config_bpdu.top_change
op_assign
id|bridge_info.top_change
suffix:semicolon
multiline_comment|/* (4.6.1.3.2(9)) */
id|send_config_bpdu
c_func
(paren
id|port_no
comma
op_amp
id|config_bpdu
)paren
suffix:semicolon
id|port_info
(braket
id|port_no
)braket
dot
id|config_pending
op_assign
id|FALSE
suffix:semicolon
multiline_comment|/* (4.6.1.3.2(10)) */
id|start_hold_timer
c_func
(paren
id|port_no
)paren
suffix:semicolon
multiline_comment|/* (4.6.1.3.2(11)) */
)brace
multiline_comment|/* JRP: we want the frame to be xmitted even if no other traffic.&n; *&t;net_bh() will do a dev_transmit() that kicks all devices&n; */
id|mark_bh
c_func
(paren
id|NET_BH
)paren
suffix:semicolon
)brace
DECL|function|root_bridge
r_static
r_int
id|root_bridge
c_func
(paren
r_void
)paren
(brace
r_return
(paren
id|br_cmp
c_func
(paren
id|bridge_info.designated_root.BRIDGE_ID
comma
id|bridge_info.bridge_id.BRIDGE_ID
)paren
ques
c_cond
id|FALSE
suffix:colon
id|TRUE
)paren
suffix:semicolon
)brace
DECL|function|supersedes_port_info
r_static
r_int
id|supersedes_port_info
c_func
(paren
r_int
id|port_no
comma
id|Config_bpdu
op_star
id|config
)paren
multiline_comment|/* (4.6.2.2)&t; */
(brace
r_return
(paren
(paren
id|br_cmp
c_func
(paren
id|config-&gt;root_id.BRIDGE_ID
comma
id|port_info
(braket
id|port_no
)braket
dot
id|designated_root.BRIDGE_ID
)paren
OL
l_int|0
)paren
multiline_comment|/* (4.6.2.2.1)&t; */
op_logical_or
(paren
(paren
id|br_cmp
c_func
(paren
id|config-&gt;root_id.BRIDGE_ID
comma
id|port_info
(braket
id|port_no
)braket
dot
id|designated_root.BRIDGE_ID
)paren
op_eq
l_int|0
)paren
op_logical_and
(paren
(paren
id|config-&gt;root_path_cost
OL
id|port_info
(braket
id|port_no
)braket
dot
id|designated_cost
multiline_comment|/* (4.6.2.2.2)&t; */
)paren
op_logical_or
(paren
(paren
id|config-&gt;root_path_cost
op_eq
id|port_info
(braket
id|port_no
)braket
dot
id|designated_cost
)paren
op_logical_and
(paren
(paren
id|br_cmp
c_func
(paren
id|config-&gt;bridge_id.BRIDGE_ID
comma
id|port_info
(braket
id|port_no
)braket
dot
id|designated_bridge.BRIDGE_ID
)paren
OL
l_int|0
multiline_comment|/* (4.6.2.2.3)    */
)paren
op_logical_or
(paren
(paren
id|br_cmp
c_func
(paren
id|config-&gt;bridge_id.BRIDGE_ID
comma
id|port_info
(braket
id|port_no
)braket
dot
id|designated_bridge.BRIDGE_ID
)paren
op_eq
l_int|0
)paren
multiline_comment|/* (4.6.2.2.4)&t; */
op_logical_and
(paren
(paren
id|br_cmp
c_func
(paren
id|config-&gt;bridge_id.BRIDGE_ID
comma
id|bridge_info.bridge_id.BRIDGE_ID
)paren
op_ne
l_int|0
)paren
multiline_comment|/* (4.6.2.2.4(1)) */
op_logical_or
(paren
id|config-&gt;port_id
op_le
id|port_info
(braket
id|port_no
)braket
dot
id|designated_port
)paren
multiline_comment|/* (4.6.2.2.4(2)) */
)paren
)paren
)paren
)paren
)paren
)paren
)paren
suffix:semicolon
)brace
DECL|function|record_config_information
r_static
r_void
id|record_config_information
c_func
(paren
r_int
id|port_no
comma
id|Config_bpdu
op_star
id|config
)paren
multiline_comment|/* (4.6.2)&t; */
(brace
id|port_info
(braket
id|port_no
)braket
dot
id|designated_root
op_assign
id|config-&gt;root_id
suffix:semicolon
multiline_comment|/* (4.6.2.3.1)   */
id|port_info
(braket
id|port_no
)braket
dot
id|designated_cost
op_assign
id|config-&gt;root_path_cost
suffix:semicolon
id|port_info
(braket
id|port_no
)braket
dot
id|designated_bridge
op_assign
id|config-&gt;bridge_id
suffix:semicolon
id|port_info
(braket
id|port_no
)braket
dot
id|designated_port
op_assign
id|config-&gt;port_id
suffix:semicolon
id|start_message_age_timer
c_func
(paren
id|port_no
comma
id|config-&gt;message_age
)paren
suffix:semicolon
multiline_comment|/* (4.6.2.3.2)   */
)brace
DECL|function|record_config_timeout_values
r_static
r_void
id|record_config_timeout_values
c_func
(paren
id|Config_bpdu
op_star
id|config
)paren
multiline_comment|/* (4.6.3)&t; */
(brace
id|bridge_info.max_age
op_assign
id|config-&gt;max_age
suffix:semicolon
multiline_comment|/* (4.6.3.3)&t; */
id|bridge_info.hello_time
op_assign
id|config-&gt;hello_time
suffix:semicolon
id|bridge_info.forward_delay
op_assign
id|config-&gt;forward_delay
suffix:semicolon
id|bridge_info.top_change
op_assign
id|config-&gt;top_change
suffix:semicolon
)brace
DECL|function|config_bpdu_generation
r_static
r_void
id|config_bpdu_generation
c_func
(paren
r_void
)paren
(brace
multiline_comment|/* (4.6.4)&t; */
r_int
id|port_no
suffix:semicolon
r_for
c_loop
(paren
id|port_no
op_assign
id|One
suffix:semicolon
id|port_no
op_le
id|No_of_ports
suffix:semicolon
id|port_no
op_increment
)paren
(brace
multiline_comment|/* (4.6.4.3) */
r_if
c_cond
(paren
id|designated_port
c_func
(paren
id|port_no
)paren
multiline_comment|/* (4.6.4.3)&t; */
op_logical_and
(paren
id|port_info
(braket
id|port_no
)braket
dot
id|state
op_ne
id|Disabled
)paren
)paren
(brace
id|transmit_config
c_func
(paren
id|port_no
)paren
suffix:semicolon
multiline_comment|/* (4.6.4.3)&t; */
)brace
multiline_comment|/* (4.6.1.2)&t; */
)brace
)brace
DECL|function|designated_port
r_static
r_int
id|designated_port
c_func
(paren
r_int
id|port_no
)paren
(brace
r_return
(paren
(paren
id|br_cmp
c_func
(paren
id|port_info
(braket
id|port_no
)braket
dot
id|designated_bridge.BRIDGE_ID
comma
id|bridge_info.bridge_id.BRIDGE_ID
)paren
op_eq
l_int|0
)paren
op_logical_and
(paren
id|port_info
(braket
id|port_no
)braket
dot
id|designated_port
op_eq
id|port_info
(braket
id|port_no
)braket
dot
id|port_id
)paren
)paren
suffix:semicolon
)brace
DECL|function|reply
r_static
r_void
id|reply
c_func
(paren
r_int
id|port_no
)paren
multiline_comment|/* (4.6.5)&t; */
(brace
id|transmit_config
c_func
(paren
id|port_no
)paren
suffix:semicolon
multiline_comment|/* (4.6.5.3)&t; */
)brace
DECL|function|transmit_tcn
r_static
r_void
id|transmit_tcn
c_func
(paren
r_void
)paren
(brace
multiline_comment|/* (4.6.6)&t; */
r_int
id|port_no
suffix:semicolon
id|port_no
op_assign
id|bridge_info.root_port
suffix:semicolon
id|tcn_bpdu.type
op_assign
id|BPDU_TYPE_TOPO_CHANGE
suffix:semicolon
id|send_tcn_bpdu
c_func
(paren
id|port_no
comma
op_amp
id|tcn_bpdu
)paren
suffix:semicolon
multiline_comment|/* (4.6.6.3)     */
)brace
DECL|function|configuration_update
r_static
r_void
id|configuration_update
c_func
(paren
r_void
)paren
multiline_comment|/* (4.6.7) */
(brace
id|root_selection
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* (4.6.7.3.1)&t; */
multiline_comment|/* (4.6.8.2)&t; */
id|designated_port_selection
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* (4.6.7.3.2)&t; */
multiline_comment|/* (4.6.9.2)&t; */
)brace
DECL|function|root_selection
r_static
r_void
id|root_selection
c_func
(paren
r_void
)paren
(brace
multiline_comment|/* (4.6.8) */
r_int
id|root_port
suffix:semicolon
r_int
id|port_no
suffix:semicolon
id|root_port
op_assign
id|No_port
suffix:semicolon
r_for
c_loop
(paren
id|port_no
op_assign
id|One
suffix:semicolon
id|port_no
op_le
id|No_of_ports
suffix:semicolon
id|port_no
op_increment
)paren
(brace
multiline_comment|/* (4.6.8.3.1) */
r_if
c_cond
(paren
(paren
(paren
op_logical_neg
id|designated_port
c_func
(paren
id|port_no
)paren
)paren
op_logical_and
(paren
id|port_info
(braket
id|port_no
)braket
dot
id|state
op_ne
id|Disabled
)paren
op_logical_and
(paren
id|br_cmp
c_func
(paren
id|port_info
(braket
id|port_no
)braket
dot
id|designated_root.BRIDGE_ID
comma
id|bridge_info.bridge_id.BRIDGE_ID
)paren
OL
l_int|0
)paren
)paren
op_logical_and
(paren
(paren
id|root_port
op_eq
id|No_port
)paren
op_logical_or
(paren
id|br_cmp
c_func
(paren
id|port_info
(braket
id|port_no
)braket
dot
id|designated_root.BRIDGE_ID
comma
id|port_info
(braket
id|root_port
)braket
dot
id|designated_root.BRIDGE_ID
)paren
OL
l_int|0
)paren
op_logical_or
(paren
(paren
id|br_cmp
c_func
(paren
id|port_info
(braket
id|port_no
)braket
dot
id|designated_root.BRIDGE_ID
comma
id|port_info
(braket
id|root_port
)braket
dot
id|designated_root.BRIDGE_ID
)paren
op_eq
l_int|0
)paren
op_logical_and
(paren
(paren
(paren
id|port_info
(braket
id|port_no
)braket
dot
id|designated_cost
op_plus
id|port_info
(braket
id|port_no
)braket
dot
id|path_cost
)paren
OL
(paren
id|port_info
(braket
id|root_port
)braket
dot
id|designated_cost
op_plus
id|port_info
(braket
id|root_port
)braket
dot
id|path_cost
)paren
multiline_comment|/* (4.6.8.3.1(2)) */
)paren
op_logical_or
(paren
(paren
(paren
id|port_info
(braket
id|port_no
)braket
dot
id|designated_cost
op_plus
id|port_info
(braket
id|port_no
)braket
dot
id|path_cost
)paren
op_eq
(paren
id|port_info
(braket
id|root_port
)braket
dot
id|designated_cost
op_plus
id|port_info
(braket
id|root_port
)braket
dot
id|path_cost
)paren
)paren
op_logical_and
(paren
(paren
id|br_cmp
c_func
(paren
id|port_info
(braket
id|port_no
)braket
dot
id|designated_bridge.BRIDGE_ID
comma
id|port_info
(braket
id|root_port
)braket
dot
id|designated_bridge.BRIDGE_ID
)paren
OL
l_int|0
)paren
multiline_comment|/* (4.6.8.3.1(3)) */
op_logical_or
(paren
(paren
id|br_cmp
c_func
(paren
id|port_info
(braket
id|port_no
)braket
dot
id|designated_bridge.BRIDGE_ID
comma
id|port_info
(braket
id|root_port
)braket
dot
id|designated_bridge.BRIDGE_ID
)paren
op_eq
l_int|0
)paren
op_logical_and
(paren
(paren
id|port_info
(braket
id|port_no
)braket
dot
id|designated_port
OL
id|port_info
(braket
id|root_port
)braket
dot
id|designated_port
)paren
multiline_comment|/* (4.6.8.3.1(4)) */
op_logical_or
(paren
(paren
id|port_info
(braket
id|port_no
)braket
dot
id|designated_port
multiline_comment|/* JRP: was missing an &quot;=&quot; ! */
op_eq
id|port_info
(braket
id|root_port
)braket
dot
id|designated_port
)paren
op_logical_and
(paren
id|port_info
(braket
id|port_no
)braket
dot
id|port_id
OL
id|port_info
(braket
id|root_port
)braket
dot
id|port_id
)paren
multiline_comment|/* (4.6.8.3.1(5)) */
)paren
)paren
)paren
)paren
)paren
)paren
)paren
)paren
)paren
(brace
id|root_port
op_assign
id|port_no
suffix:semicolon
)brace
)brace
id|bridge_info.root_port
op_assign
id|root_port
suffix:semicolon
multiline_comment|/* (4.6.8.3.1)&t; */
r_if
c_cond
(paren
id|root_port
op_eq
id|No_port
)paren
(brace
multiline_comment|/* (4.6.8.3.2)&t; */
macro_line|#ifdef DEBUG_STP
r_if
c_cond
(paren
id|br_stats.flags
op_amp
id|BR_DEBUG
)paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;root_selection: becomes root&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
id|bridge_info.designated_root
op_assign
id|bridge_info.bridge_id
suffix:semicolon
multiline_comment|/* (4.6.8.3.2(1)) */
id|bridge_info.root_path_cost
op_assign
id|Zero
suffix:semicolon
multiline_comment|/* (4.6.8.3.2(2)) */
)brace
r_else
(brace
multiline_comment|/* (4.6.8.3.3)&t; */
id|bridge_info.designated_root
op_assign
id|port_info
(braket
id|root_port
)braket
dot
id|designated_root
suffix:semicolon
multiline_comment|/* (4.6.8.3.3(1)) */
id|bridge_info.root_path_cost
op_assign
(paren
id|port_info
(braket
id|root_port
)braket
dot
id|designated_cost
op_plus
id|port_info
(braket
id|root_port
)braket
dot
id|path_cost
)paren
suffix:semicolon
multiline_comment|/* (4.6.8.3.3(2)) */
)brace
)brace
DECL|function|designated_port_selection
r_static
r_void
id|designated_port_selection
c_func
(paren
r_void
)paren
(brace
multiline_comment|/* (4.6.9)&t; */
r_int
id|port_no
suffix:semicolon
r_for
c_loop
(paren
id|port_no
op_assign
id|One
suffix:semicolon
id|port_no
op_le
id|No_of_ports
suffix:semicolon
id|port_no
op_increment
)paren
(brace
multiline_comment|/* (4.6.9.3)&t; */
r_if
c_cond
(paren
id|port_info
(braket
id|port_no
)braket
dot
id|state
op_eq
id|Disabled
)paren
(brace
r_continue
suffix:semicolon
)brace
r_if
c_cond
(paren
id|designated_port
c_func
(paren
id|port_no
)paren
multiline_comment|/* (4.6.9.3.1)&t; */
op_logical_or
(paren
id|br_cmp
c_func
(paren
id|port_info
(braket
id|port_no
)braket
dot
id|designated_root.BRIDGE_ID
comma
id|bridge_info.designated_root.BRIDGE_ID
)paren
op_ne
l_int|0
)paren
op_logical_or
(paren
id|bridge_info.root_path_cost
OL
id|port_info
(braket
id|port_no
)braket
dot
id|designated_cost
)paren
multiline_comment|/* (4.6.9.3.3)&t; */
op_logical_or
(paren
(paren
id|bridge_info.root_path_cost
op_eq
id|port_info
(braket
id|port_no
)braket
dot
id|designated_cost
)paren
op_logical_and
(paren
(paren
id|br_cmp
c_func
(paren
id|bridge_info.bridge_id.BRIDGE_ID
comma
id|port_info
(braket
id|port_no
)braket
dot
id|designated_bridge.BRIDGE_ID
)paren
OL
l_int|0
)paren
multiline_comment|/* (4.6.9.3.4)&t; */
op_logical_or
(paren
(paren
id|br_cmp
c_func
(paren
id|bridge_info.bridge_id.BRIDGE_ID
comma
id|port_info
(braket
id|port_no
)braket
dot
id|designated_bridge.BRIDGE_ID
)paren
op_eq
l_int|0
)paren
op_logical_and
(paren
id|port_info
(braket
id|port_no
)braket
dot
id|port_id
op_le
id|port_info
(braket
id|port_no
)braket
dot
id|designated_port
)paren
multiline_comment|/* (4.6.9.3.5)&t; */
)paren
)paren
)paren
)paren
(brace
id|become_designated_port
c_func
(paren
id|port_no
)paren
suffix:semicolon
multiline_comment|/* (4.6.10.3.2.2) */
)brace
)brace
)brace
DECL|function|become_designated_port
r_static
r_void
id|become_designated_port
c_func
(paren
r_int
id|port_no
)paren
(brace
multiline_comment|/* (4.6.10)&t; */
multiline_comment|/* (4.6.10.3.1) */
id|port_info
(braket
id|port_no
)braket
dot
id|designated_root
op_assign
id|bridge_info.designated_root
suffix:semicolon
multiline_comment|/* (4.6.10.3.2) */
id|port_info
(braket
id|port_no
)braket
dot
id|designated_cost
op_assign
id|bridge_info.root_path_cost
suffix:semicolon
multiline_comment|/* (4.6.10.3.3) */
id|port_info
(braket
id|port_no
)braket
dot
id|designated_bridge
op_assign
id|bridge_info.bridge_id
suffix:semicolon
multiline_comment|/* (4.6.10.3.4) */
id|port_info
(braket
id|port_no
)braket
dot
id|designated_port
op_assign
id|port_info
(braket
id|port_no
)braket
dot
id|port_id
suffix:semicolon
)brace
DECL|function|port_state_selection
r_static
r_void
id|port_state_selection
c_func
(paren
r_void
)paren
(brace
multiline_comment|/* (4.6.11) */
r_int
id|port_no
suffix:semicolon
r_char
op_star
id|state_str
suffix:semicolon
r_for
c_loop
(paren
id|port_no
op_assign
id|One
suffix:semicolon
id|port_no
op_le
id|No_of_ports
suffix:semicolon
id|port_no
op_increment
)paren
(brace
r_if
c_cond
(paren
id|port_info
(braket
id|port_no
)braket
dot
id|state
op_eq
id|Disabled
)paren
(brace
r_continue
suffix:semicolon
)brace
r_if
c_cond
(paren
id|port_no
op_eq
id|bridge_info.root_port
)paren
(brace
multiline_comment|/* (4.6.11.3.1) */
id|state_str
op_assign
l_string|&quot;root&quot;
suffix:semicolon
id|port_info
(braket
id|port_no
)braket
dot
id|config_pending
op_assign
id|FALSE
suffix:semicolon
multiline_comment|/* (4.6.11.3.1(1)) */
id|port_info
(braket
id|port_no
)braket
dot
id|top_change_ack
op_assign
l_int|0
suffix:semicolon
id|make_forwarding
c_func
(paren
id|port_no
)paren
suffix:semicolon
multiline_comment|/* (4.6.11.3.1(2)) */
)brace
r_else
r_if
c_cond
(paren
id|designated_port
c_func
(paren
id|port_no
)paren
)paren
(brace
multiline_comment|/* (4.6.11.3.2) */
id|state_str
op_assign
l_string|&quot;designated&quot;
suffix:semicolon
id|stop_message_age_timer
c_func
(paren
id|port_no
)paren
suffix:semicolon
multiline_comment|/* (4.6.11.3.2(1)) */
id|make_forwarding
c_func
(paren
id|port_no
)paren
suffix:semicolon
multiline_comment|/* (4.6.11.3.2(2)) */
)brace
r_else
(brace
multiline_comment|/* (4.6.11.3.3) */
id|state_str
op_assign
l_string|&quot;blocking&quot;
suffix:semicolon
id|port_info
(braket
id|port_no
)braket
dot
id|config_pending
op_assign
id|FALSE
suffix:semicolon
multiline_comment|/* (4.6.11.3.3(1)) */
id|port_info
(braket
id|port_no
)braket
dot
id|top_change_ack
op_assign
l_int|0
suffix:semicolon
id|make_blocking
c_func
(paren
id|port_no
)paren
suffix:semicolon
multiline_comment|/* (4.6.11.3.3(2)) */
)brace
macro_line|#ifdef DEBUG_STP
r_if
c_cond
(paren
id|br_stats.flags
op_amp
id|BR_DEBUG
)paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;port_state_selection: becomes %s port %d&bslash;n&quot;
comma
id|state_str
comma
id|port_no
)paren
suffix:semicolon
macro_line|#endif
)brace
)brace
DECL|function|make_forwarding
r_static
r_void
id|make_forwarding
c_func
(paren
r_int
id|port_no
)paren
(brace
multiline_comment|/* (4.6.12) */
r_if
c_cond
(paren
id|port_info
(braket
id|port_no
)braket
dot
id|state
op_eq
id|Blocking
)paren
(brace
multiline_comment|/* (4.6.12.3) */
id|set_port_state
c_func
(paren
id|port_no
comma
id|Listening
)paren
suffix:semicolon
multiline_comment|/* (4.6.12.3.1) */
id|start_forward_delay_timer
c_func
(paren
id|port_no
)paren
suffix:semicolon
multiline_comment|/* (4.6.12.3.2) */
)brace
)brace
DECL|function|topology_change_detection
r_static
r_void
id|topology_change_detection
c_func
(paren
r_void
)paren
(brace
multiline_comment|/* (4.6.14)       */
macro_line|#ifdef DEBUG_STP
r_if
c_cond
(paren
(paren
id|br_stats.flags
op_amp
id|BR_DEBUG
)paren
op_logical_and
(paren
id|bridge_info.top_change_detected
op_eq
l_int|0
)paren
)paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;topology_change_detected&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|root_bridge
c_func
(paren
)paren
)paren
(brace
multiline_comment|/* (4.6.14.3.1)   */
id|bridge_info.top_change
op_assign
l_int|1
suffix:semicolon
id|start_topology_change_timer
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* (4.6.14.3.1(2)) */
)brace
r_else
r_if
c_cond
(paren
op_logical_neg
(paren
id|bridge_info.top_change_detected
)paren
)paren
(brace
id|transmit_tcn
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* (4.6.14.3.2(1)) */
id|start_tcn_timer
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* (4.6.14.3.2(2)) */
)brace
id|bridge_info.top_change_detected
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* (4.6.14.3.3) */
)brace
DECL|function|topology_change_acknowledged
r_static
r_void
id|topology_change_acknowledged
c_func
(paren
r_void
)paren
(brace
multiline_comment|/* (4.6.15) */
macro_line|#ifdef DEBUG_STP
r_if
c_cond
(paren
id|br_stats.flags
op_amp
id|BR_DEBUG
)paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;topology_change_acked&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
id|bridge_info.top_change_detected
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* (4.6.15.3.1) */
id|stop_tcn_timer
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* (4.6.15.3.2) */
)brace
DECL|function|acknowledge_topology_change
r_static
r_void
id|acknowledge_topology_change
c_func
(paren
r_int
id|port_no
)paren
(brace
multiline_comment|/* (4.6.16) */
id|port_info
(braket
id|port_no
)braket
dot
id|top_change_ack
op_assign
l_int|1
suffix:semicolon
id|transmit_config
c_func
(paren
id|port_no
)paren
suffix:semicolon
multiline_comment|/* (4.6.16.3.2) */
)brace
DECL|function|make_blocking
r_static
r_void
id|make_blocking
c_func
(paren
r_int
id|port_no
)paren
multiline_comment|/* (4.6.13)&t; */
(brace
r_if
c_cond
(paren
(paren
id|port_info
(braket
id|port_no
)braket
dot
id|state
op_ne
id|Disabled
)paren
op_logical_and
(paren
id|port_info
(braket
id|port_no
)braket
dot
id|state
op_ne
id|Blocking
)paren
multiline_comment|/* (4.6.13.3)&t; */
)paren
(brace
r_if
c_cond
(paren
(paren
id|port_info
(braket
id|port_no
)braket
dot
id|state
op_eq
id|Forwarding
)paren
op_logical_or
(paren
id|port_info
(braket
id|port_no
)braket
dot
id|state
op_eq
id|Learning
)paren
)paren
(brace
id|topology_change_detection
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* (4.6.13.3.1) */
multiline_comment|/* (4.6.14.2.3)&t; */
)brace
id|set_port_state
c_func
(paren
id|port_no
comma
id|Blocking
)paren
suffix:semicolon
multiline_comment|/* (4.6.13.3.2) */
id|stop_forward_delay_timer
c_func
(paren
id|port_no
)paren
suffix:semicolon
multiline_comment|/* (4.6.13.3.3) */
)brace
)brace
DECL|function|set_port_state
r_static
r_void
id|set_port_state
c_func
(paren
r_int
id|port_no
comma
r_int
id|state
)paren
(brace
id|port_info
(braket
id|port_no
)braket
dot
id|state
op_assign
id|state
suffix:semicolon
)brace
DECL|function|received_config_bpdu
r_static
r_void
id|received_config_bpdu
c_func
(paren
r_int
id|port_no
comma
id|Config_bpdu
op_star
id|config
)paren
multiline_comment|/* (4.7.1)&t; */
(brace
r_int
id|root
suffix:semicolon
id|root
op_assign
id|root_bridge
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|port_info
(braket
id|port_no
)braket
dot
id|state
op_ne
id|Disabled
)paren
(brace
macro_line|#ifdef DEBUG_STP
r_if
c_cond
(paren
id|br_stats.flags
op_amp
id|BR_DEBUG
)paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;received_config_bpdu: port %d&bslash;n&quot;
comma
id|port_no
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|supersedes_port_info
c_func
(paren
id|port_no
comma
id|config
)paren
)paren
(brace
multiline_comment|/* (4.7.1.1)&t; */
multiline_comment|/* (4.&n;&t;&t;&t;&t;&t;&t;&t;&t; * 6.2.2)&t; */
id|record_config_information
c_func
(paren
id|port_no
comma
id|config
)paren
suffix:semicolon
multiline_comment|/* (4.7.1.1.1)&t; */
multiline_comment|/* (4.6.2.2)&t; */
id|configuration_update
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* (4.7.1.1.2)&t; */
multiline_comment|/* (4.6.7.2.1)&t; */
id|port_state_selection
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* (4.7.1.1.3)&t; */
multiline_comment|/* (4.6.11.2.1)&t; */
r_if
c_cond
(paren
(paren
op_logical_neg
id|root_bridge
c_func
(paren
)paren
)paren
op_logical_and
id|root
)paren
(brace
multiline_comment|/* (4.7.1.1.4)&t; */
id|stop_hello_timer
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|bridge_info.top_change_detected
)paren
(brace
multiline_comment|/* (4.7.1.1.5 */
id|stop_topology_change_timer
c_func
(paren
)paren
suffix:semicolon
id|transmit_tcn
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* (4.6.6.1)&t; */
id|start_tcn_timer
c_func
(paren
)paren
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|port_no
op_eq
id|bridge_info.root_port
)paren
(brace
id|record_config_timeout_values
c_func
(paren
id|config
)paren
suffix:semicolon
multiline_comment|/* (4.7.1.1.6)&t; */
multiline_comment|/* (4.6.3.2)&t; */
id|config_bpdu_generation
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* (4.6.4.2.1)&t; */
r_if
c_cond
(paren
id|config-&gt;top_change_ack
)paren
(brace
multiline_comment|/* (4.7.1.1.7)    */
id|topology_change_acknowledged
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* (4.6.15.2)&t; */
)brace
)brace
)brace
r_else
r_if
c_cond
(paren
id|designated_port
c_func
(paren
id|port_no
)paren
)paren
(brace
multiline_comment|/* (4.7.1.2)&t; */
id|reply
c_func
(paren
id|port_no
)paren
suffix:semicolon
multiline_comment|/* (4.7.1.2.1)&t; */
multiline_comment|/* (4.6.5.2)&t; */
)brace
)brace
)brace
DECL|function|received_tcn_bpdu
r_static
r_void
id|received_tcn_bpdu
c_func
(paren
r_int
id|port_no
comma
id|Tcn_bpdu
op_star
id|tcn
)paren
multiline_comment|/* (4.7.2)&t; */
(brace
r_if
c_cond
(paren
id|port_info
(braket
id|port_no
)braket
dot
id|state
op_ne
id|Disabled
)paren
(brace
macro_line|#ifdef DEBUG_STP
r_if
c_cond
(paren
id|br_stats.flags
op_amp
id|BR_DEBUG
)paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;received_tcn_bpdu: port %d&bslash;n&quot;
comma
id|port_no
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|designated_port
c_func
(paren
id|port_no
)paren
)paren
(brace
id|topology_change_detection
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* (4.7.2.1)&t; */
multiline_comment|/* (4.6.14.2.1)&t; */
id|acknowledge_topology_change
c_func
(paren
id|port_no
)paren
suffix:semicolon
multiline_comment|/* (4.7.2.2)&t; */
)brace
multiline_comment|/* (4.6.16.2)&t; */
)brace
)brace
DECL|function|hello_timer_expiry
r_static
r_void
id|hello_timer_expiry
c_func
(paren
r_void
)paren
(brace
multiline_comment|/* (4.7.3)&t; */
id|config_bpdu_generation
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* (4.6.4.2.2)&t; */
id|start_hello_timer
c_func
(paren
)paren
suffix:semicolon
)brace
DECL|function|message_age_timer_expiry
r_static
r_void
id|message_age_timer_expiry
c_func
(paren
r_int
id|port_no
)paren
multiline_comment|/* (4.7.4)&t; */
(brace
r_int
id|root
suffix:semicolon
id|root
op_assign
id|root_bridge
c_func
(paren
)paren
suffix:semicolon
macro_line|#ifdef DEBUG_STP
r_if
c_cond
(paren
id|br_stats.flags
op_amp
id|BR_DEBUG
)paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;message_age_timer_expiry: port %d&bslash;n&quot;
comma
id|port_no
)paren
suffix:semicolon
macro_line|#endif
id|become_designated_port
c_func
(paren
id|port_no
)paren
suffix:semicolon
multiline_comment|/* (4.7.4.1)&t; */
multiline_comment|/* (4.6.10.2.1)&t; */
id|configuration_update
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* (4.7.4.2)&t; */
multiline_comment|/* (4.6.7.2.2)&t; */
id|port_state_selection
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* (4.7.4.3)&t; */
multiline_comment|/* (4.6.11.2.2)&t; */
r_if
c_cond
(paren
(paren
id|root_bridge
c_func
(paren
)paren
)paren
op_logical_and
(paren
op_logical_neg
id|root
)paren
)paren
(brace
multiline_comment|/* (4.7.4.4)&t; */
id|bridge_info.max_age
op_assign
id|bridge_info.bridge_max_age
suffix:semicolon
multiline_comment|/* (4.7.4.4.1)    */
id|bridge_info.hello_time
op_assign
id|bridge_info.bridge_hello_time
suffix:semicolon
id|bridge_info.forward_delay
op_assign
id|bridge_info.bridge_forward_delay
suffix:semicolon
id|topology_change_detection
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* (4.7.4.4.2)&t; */
multiline_comment|/* (4.6.14.2.4)&t; */
id|stop_tcn_timer
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* (4.7.4.4.3)&t; */
id|config_bpdu_generation
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* (4.7.4.4.4)&t; */
multiline_comment|/* (4.6.4.4.3)&t; */
id|start_hello_timer
c_func
(paren
)paren
suffix:semicolon
)brace
)brace
DECL|function|forward_delay_timer_expiry
r_static
r_void
id|forward_delay_timer_expiry
c_func
(paren
r_int
id|port_no
)paren
multiline_comment|/* (4.7.5)&t; */
(brace
r_if
c_cond
(paren
id|port_info
(braket
id|port_no
)braket
dot
id|state
op_eq
id|Listening
)paren
(brace
multiline_comment|/* (4.7.5.1)&t; */
id|set_port_state
c_func
(paren
id|port_no
comma
id|Learning
)paren
suffix:semicolon
multiline_comment|/* (4.7.5.1.1)&t; */
id|start_forward_delay_timer
c_func
(paren
id|port_no
)paren
suffix:semicolon
multiline_comment|/* (4.7.5.1.2)&t; */
)brace
r_else
r_if
c_cond
(paren
id|port_info
(braket
id|port_no
)braket
dot
id|state
op_eq
id|Learning
)paren
(brace
multiline_comment|/* (4.7.5.2) */
id|set_port_state
c_func
(paren
id|port_no
comma
id|Forwarding
)paren
suffix:semicolon
multiline_comment|/* (4.7.5.2.1) */
r_if
c_cond
(paren
id|designated_for_some_port
c_func
(paren
)paren
)paren
(brace
multiline_comment|/* (4.7.5.2.2) */
id|topology_change_detection
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* (4.6.14.2.2) */
)brace
)brace
)brace
DECL|function|designated_for_some_port
r_static
r_int
id|designated_for_some_port
c_func
(paren
r_void
)paren
(brace
r_int
id|port_no
suffix:semicolon
r_for
c_loop
(paren
id|port_no
op_assign
id|One
suffix:semicolon
id|port_no
op_le
id|No_of_ports
suffix:semicolon
id|port_no
op_increment
)paren
(brace
r_if
c_cond
(paren
id|port_info
(braket
id|port_no
)braket
dot
id|state
op_eq
id|Disabled
)paren
(brace
r_continue
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|br_cmp
c_func
(paren
id|port_info
(braket
id|port_no
)braket
dot
id|designated_bridge.BRIDGE_ID
comma
id|bridge_info.bridge_id.BRIDGE_ID
)paren
op_eq
l_int|0
)paren
)paren
(brace
r_return
(paren
id|TRUE
)paren
suffix:semicolon
)brace
)brace
r_return
(paren
id|FALSE
)paren
suffix:semicolon
)brace
DECL|function|tcn_timer_expiry
r_static
r_void
id|tcn_timer_expiry
c_func
(paren
r_void
)paren
(brace
multiline_comment|/* (4.7.6)&t; */
id|transmit_tcn
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* (4.7.6.1)&t; */
id|start_tcn_timer
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* (4.7.6.2)&t; */
)brace
DECL|function|topology_change_timer_expiry
r_static
r_void
id|topology_change_timer_expiry
c_func
(paren
r_void
)paren
(brace
multiline_comment|/* (4.7.7)&t; */
id|bridge_info.top_change_detected
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* (4.7.7.1) */
id|bridge_info.top_change
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* (4.7.7.2)&t; */
)brace
DECL|function|hold_timer_expiry
r_static
r_void
id|hold_timer_expiry
c_func
(paren
r_int
id|port_no
)paren
multiline_comment|/* (4.7.8)&t; */
(brace
r_if
c_cond
(paren
id|port_info
(braket
id|port_no
)braket
dot
id|config_pending
)paren
(brace
id|transmit_config
c_func
(paren
id|port_no
)paren
suffix:semicolon
multiline_comment|/* (4.7.8.1)&t; */
)brace
multiline_comment|/* (4.6.1.2.3)&t; */
)brace
multiline_comment|/* Vova Oksman: Write the buffer (contents of the Bridge table) */
multiline_comment|/* to a PROCfs file                                             */
DECL|function|br_tree_get_info
r_int
id|br_tree_get_info
c_func
(paren
r_char
op_star
id|buffer
comma
r_char
op_star
op_star
id|start
comma
id|off_t
id|offset
comma
r_int
id|length
comma
r_int
id|dummy
)paren
(brace
r_int
id|size
suffix:semicolon
r_int
id|len
op_assign
l_int|0
suffix:semicolon
id|off_t
id|pos
op_assign
l_int|0
suffix:semicolon
r_char
op_star
id|pbuffer
suffix:semicolon
r_if
c_cond
(paren
l_int|0
op_eq
id|offset
)paren
(brace
multiline_comment|/* first time write the header */
id|size
op_assign
id|sprintf
c_func
(paren
id|buffer
comma
l_string|&quot;%s&quot;
comma
l_string|&quot;MAC address           Device     Flags     Age (sec.)&bslash;n&quot;
)paren
suffix:semicolon
id|len
op_assign
id|size
suffix:semicolon
)brace
id|pbuffer
op_assign
op_amp
id|buffer
(braket
id|len
)braket
suffix:semicolon
id|sprintf_avl
c_func
(paren
op_amp
id|pbuffer
comma
l_int|NULL
comma
op_amp
id|pos
comma
op_amp
id|len
comma
id|offset
comma
id|length
)paren
suffix:semicolon
op_star
id|start
op_assign
id|buffer
op_plus
id|len
op_minus
(paren
id|pos
op_minus
id|offset
)paren
suffix:semicolon
multiline_comment|/* Start of wanted data */
id|len
op_assign
id|pos
op_minus
id|offset
suffix:semicolon
multiline_comment|/* Start slop */
r_if
c_cond
(paren
id|len
OG
id|length
)paren
id|len
op_assign
id|length
suffix:semicolon
multiline_comment|/* Ending slop */
r_return
id|len
suffix:semicolon
)brace
macro_line|#ifdef CONFIG_PROC_FS
DECL|variable|proc_net_bridge
r_struct
id|proc_dir_entry
id|proc_net_bridge
op_assign
(brace
id|PROC_NET_BRIDGE
comma
l_int|6
comma
l_string|&quot;bridge&quot;
comma
id|S_IFREG
op_or
id|S_IRUGO
comma
l_int|1
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
op_amp
id|proc_net_inode_operations
comma
id|br_tree_get_info
)brace
suffix:semicolon
macro_line|#endif
DECL|function|__initfunc
id|__initfunc
c_func
(paren
r_void
id|br_init
c_func
(paren
r_void
)paren
)paren
(brace
multiline_comment|/* (4.8.1)&t; */
r_int
id|port_no
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;NET4: Ethernet Bridge 005 for NET4.0&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Form initial topology change time.&n;&t; * The topology change timer is only used if this is the root bridge.&n;&t; */
id|bridge_info.topology_change_time
op_assign
id|BRIDGE_MAX_AGE
op_plus
id|BRIDGE_FORWARD_DELAY
suffix:semicolon
multiline_comment|/* (4.5.3.13) */
id|bridge_info.designated_root
op_assign
id|bridge_info.bridge_id
suffix:semicolon
multiline_comment|/* (4.8.1.1)&t; */
id|bridge_info.root_path_cost
op_assign
id|Zero
suffix:semicolon
id|bridge_info.root_port
op_assign
id|No_port
suffix:semicolon
macro_line|#ifdef DEBUG_STP
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;br_init: becomes root&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
id|bridge_info.bridge_max_age
op_assign
id|BRIDGE_MAX_AGE
suffix:semicolon
id|bridge_info.bridge_hello_time
op_assign
id|BRIDGE_HELLO_TIME
suffix:semicolon
id|bridge_info.bridge_forward_delay
op_assign
id|BRIDGE_FORWARD_DELAY
suffix:semicolon
id|bridge_info.hold_time
op_assign
id|HOLD_TIME
suffix:semicolon
id|bridge_info.max_age
op_assign
id|bridge_info.bridge_max_age
suffix:semicolon
multiline_comment|/* (4.8.1.2)&t; */
id|bridge_info.hello_time
op_assign
id|bridge_info.bridge_hello_time
suffix:semicolon
id|bridge_info.forward_delay
op_assign
id|bridge_info.bridge_forward_delay
suffix:semicolon
id|bridge_info.top_change_detected
op_assign
l_int|0
suffix:semicolon
id|bridge_info.top_change
op_assign
l_int|0
suffix:semicolon
id|stop_tcn_timer
c_func
(paren
)paren
suffix:semicolon
id|stop_topology_change_timer
c_func
(paren
)paren
suffix:semicolon
id|memset
c_func
(paren
id|newfdb
comma
l_int|0
comma
r_sizeof
(paren
id|newfdb
)paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|port_no
op_assign
id|One
suffix:semicolon
id|port_no
op_le
id|No_of_ports
suffix:semicolon
id|port_no
op_increment
)paren
(brace
multiline_comment|/* (4.8.1.4) */
multiline_comment|/* initial state = Enable */
id|user_port_state
(braket
id|port_no
)braket
op_assign
op_complement
id|Disabled
suffix:semicolon
id|port_priority
(braket
id|port_no
)braket
op_assign
l_int|128
suffix:semicolon
id|br_init_port
c_func
(paren
id|port_no
)paren
suffix:semicolon
id|disable_port
c_func
(paren
id|port_no
)paren
suffix:semicolon
)brace
macro_line|#if 0 /* JRP: We are not UP ! Wait for the start command */
id|port_state_selection
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* (4.8.1.5)&t; */
id|config_bpdu_generation
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* (4.8.1.6)&t; */
multiline_comment|/* initialize system timer */
id|tl.expires
op_assign
id|jiffies
op_plus
id|HZ
suffix:semicolon
multiline_comment|/* 1 second */
id|tl.function
op_assign
id|br_tick
suffix:semicolon
id|add_timer
c_func
(paren
op_amp
id|tl
)paren
suffix:semicolon
macro_line|#endif&t;
id|register_netdevice_notifier
c_func
(paren
op_amp
id|br_dev_notifier
)paren
suffix:semicolon
id|br_stats.flags
op_assign
l_int|0
suffix:semicolon
multiline_comment|/*BR_UP | BR_DEBUG*/
suffix:semicolon
multiline_comment|/* enable bridge */
id|br_stats.policy
op_assign
id|BR_ACCEPT
suffix:semicolon
multiline_comment|/* Enable bridge to accpet all protocols */
id|br_stats.exempt_protocols
op_assign
l_int|0
suffix:semicolon
multiline_comment|/*start_hello_timer();*/
multiline_comment|/* Vova Oksman: register the function for the PROCfs &quot;bridge&quot; file */
macro_line|#ifdef CONFIG_PROC_FS
id|proc_net_register
c_func
(paren
op_amp
id|proc_net_bridge
)paren
suffix:semicolon
macro_line|#endif
)brace
DECL|function|make_port_id
r_static
r_inline
r_int
r_int
id|make_port_id
c_func
(paren
r_int
id|port_no
)paren
(brace
r_return
(paren
id|port_priority
(braket
id|port_no
)braket
op_lshift
l_int|8
)paren
op_or
id|port_no
suffix:semicolon
)brace
DECL|function|br_init_port
r_static
r_void
id|br_init_port
c_func
(paren
r_int
id|port_no
)paren
(brace
id|port_info
(braket
id|port_no
)braket
dot
id|port_id
op_assign
id|make_port_id
c_func
(paren
id|port_no
)paren
suffix:semicolon
id|become_designated_port
c_func
(paren
id|port_no
)paren
suffix:semicolon
multiline_comment|/* (4.8.1.4.1) */
id|set_port_state
c_func
(paren
id|port_no
comma
id|Blocking
)paren
suffix:semicolon
multiline_comment|/* (4.8.1.4.2)    */
id|port_info
(braket
id|port_no
)braket
dot
id|top_change_ack
op_assign
l_int|0
suffix:semicolon
id|port_info
(braket
id|port_no
)braket
dot
id|config_pending
op_assign
id|FALSE
suffix:semicolon
multiline_comment|/* (4.8.1.4.4)&t; */
id|stop_message_age_timer
c_func
(paren
id|port_no
)paren
suffix:semicolon
multiline_comment|/* (4.8.1.4.5)&t; */
id|stop_forward_delay_timer
c_func
(paren
id|port_no
)paren
suffix:semicolon
multiline_comment|/* (4.8.1.4.6)&t; */
id|stop_hold_timer
c_func
(paren
id|port_no
)paren
suffix:semicolon
multiline_comment|/* (4.8.1.4.7)&t; */
)brace
DECL|function|enable_port
r_static
r_void
id|enable_port
c_func
(paren
r_int
id|port_no
)paren
multiline_comment|/* (4.8.2)&t; */
(brace
id|br_init_port
c_func
(paren
id|port_no
)paren
suffix:semicolon
id|port_state_selection
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* (4.8.2.7)&t; */
)brace
multiline_comment|/* */
DECL|function|disable_port
r_static
r_void
id|disable_port
c_func
(paren
r_int
id|port_no
)paren
multiline_comment|/* (4.8.3)&t; */
(brace
r_int
id|root
suffix:semicolon
id|root
op_assign
id|root_bridge
c_func
(paren
)paren
suffix:semicolon
id|become_designated_port
c_func
(paren
id|port_no
)paren
suffix:semicolon
multiline_comment|/* (4.8.3.1)&t; */
id|set_port_state
c_func
(paren
id|port_no
comma
id|Disabled
)paren
suffix:semicolon
multiline_comment|/* (4.8.3.2)&t; */
id|port_info
(braket
id|port_no
)braket
dot
id|top_change_ack
op_assign
l_int|0
suffix:semicolon
id|port_info
(braket
id|port_no
)braket
dot
id|config_pending
op_assign
id|FALSE
suffix:semicolon
multiline_comment|/* (4.8.3.4)&t; */
id|stop_message_age_timer
c_func
(paren
id|port_no
)paren
suffix:semicolon
multiline_comment|/* (4.8.3.5)&t; */
id|stop_forward_delay_timer
c_func
(paren
id|port_no
)paren
suffix:semicolon
multiline_comment|/* (4.8.3.6)&t; */
id|configuration_update
c_func
(paren
)paren
suffix:semicolon
id|port_state_selection
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* (4.8.3.7)&t; */
r_if
c_cond
(paren
(paren
id|root_bridge
c_func
(paren
)paren
)paren
op_logical_and
(paren
op_logical_neg
id|root
)paren
)paren
(brace
multiline_comment|/* (4.8.3.8)&t; */
id|bridge_info.max_age
op_assign
id|bridge_info.bridge_max_age
suffix:semicolon
multiline_comment|/* (4.8.3.8.1)    */
id|bridge_info.hello_time
op_assign
id|bridge_info.bridge_hello_time
suffix:semicolon
id|bridge_info.forward_delay
op_assign
id|bridge_info.bridge_forward_delay
suffix:semicolon
id|topology_change_detection
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* (4.8.3.8.2)    */
id|stop_tcn_timer
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* (4.8.3.8.3)    */
id|config_bpdu_generation
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* (4.8.3.8.4)    */
id|start_hello_timer
c_func
(paren
)paren
suffix:semicolon
)brace
)brace
DECL|function|set_bridge_priority
r_static
r_void
id|set_bridge_priority
c_func
(paren
id|bridge_id_t
op_star
id|new_bridge_id
)paren
multiline_comment|/* (4.8.4)&t; */
(brace
r_int
id|root
suffix:semicolon
r_int
id|port_no
suffix:semicolon
id|root
op_assign
id|root_bridge
c_func
(paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|port_no
op_assign
id|One
suffix:semicolon
id|port_no
op_le
id|No_of_ports
suffix:semicolon
id|port_no
op_increment
)paren
(brace
multiline_comment|/* (4.8.4.2) */
r_if
c_cond
(paren
id|port_info
(braket
id|port_no
)braket
dot
id|state
op_eq
id|Disabled
)paren
(brace
r_continue
suffix:semicolon
)brace
r_if
c_cond
(paren
id|designated_port
c_func
(paren
id|port_no
)paren
)paren
(brace
id|port_info
(braket
id|port_no
)braket
dot
id|designated_bridge
op_assign
op_star
id|new_bridge_id
suffix:semicolon
)brace
)brace
id|bridge_info.bridge_id
op_assign
op_star
id|new_bridge_id
suffix:semicolon
multiline_comment|/* (4.8.4.3)&t; */
id|configuration_update
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* (4.8.4.4)&t; */
id|port_state_selection
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* (4.8.4.5)&t; */
r_if
c_cond
(paren
(paren
id|root_bridge
c_func
(paren
)paren
)paren
op_logical_and
(paren
op_logical_neg
id|root
)paren
)paren
(brace
multiline_comment|/* (4.8.4.6)&t; */
id|bridge_info.max_age
op_assign
id|bridge_info.bridge_max_age
suffix:semicolon
multiline_comment|/* (4.8.4.6.1)    */
id|bridge_info.hello_time
op_assign
id|bridge_info.bridge_hello_time
suffix:semicolon
id|bridge_info.forward_delay
op_assign
id|bridge_info.bridge_forward_delay
suffix:semicolon
id|topology_change_detection
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* (4.8.4.6.2)    */
id|stop_tcn_timer
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* (4.8.4.6.3)    */
id|config_bpdu_generation
c_func
(paren
)paren
comma
multiline_comment|/* (4.8.4.6.4)    */
id|start_hello_timer
c_func
(paren
)paren
suffix:semicolon
)brace
)brace
DECL|function|set_port_priority
r_static
r_void
id|set_port_priority
c_func
(paren
r_int
id|port_no
)paren
multiline_comment|/* (4.8.5)&t; */
(brace
r_int
id|new_port_id
op_assign
id|make_port_id
c_func
(paren
id|port_no
)paren
suffix:semicolon
r_if
c_cond
(paren
id|designated_port
c_func
(paren
id|port_no
)paren
)paren
(brace
multiline_comment|/* (4.8.5.2)&t; */
id|port_info
(braket
id|port_no
)braket
dot
id|designated_port
op_assign
id|new_port_id
suffix:semicolon
)brace
id|port_info
(braket
id|port_no
)braket
dot
id|port_id
op_assign
id|new_port_id
suffix:semicolon
multiline_comment|/* (4.8.5.3)&t; */
r_if
c_cond
(paren
(paren
id|br_cmp
c_func
(paren
id|bridge_info.bridge_id.BRIDGE_ID
comma
id|port_info
(braket
id|port_no
)braket
dot
id|designated_bridge.BRIDGE_ID
)paren
op_eq
l_int|0
)paren
op_logical_and
(paren
id|port_info
(braket
id|port_no
)braket
dot
id|port_id
OL
id|port_info
(braket
id|port_no
)braket
dot
id|designated_port
)paren
)paren
(brace
id|become_designated_port
c_func
(paren
id|port_no
)paren
suffix:semicolon
multiline_comment|/* (4.8.5.4.1) */
id|port_state_selection
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* (4.8.5.4.2) */
)brace
)brace
DECL|function|set_path_cost
r_static
r_void
id|set_path_cost
c_func
(paren
r_int
id|port_no
comma
r_int
r_int
id|path_cost
)paren
multiline_comment|/* (4.8.6)&t; */
(brace
id|port_info
(braket
id|port_no
)braket
dot
id|path_cost
op_assign
id|path_cost
suffix:semicolon
multiline_comment|/* (4.8.6.1)&t; */
id|configuration_update
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* (4.8.6.2)&t; */
id|port_state_selection
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* (4.8.6.3)&t; */
)brace
DECL|function|br_tick
r_static
r_void
id|br_tick
c_func
(paren
r_int
r_int
id|arg
)paren
(brace
r_int
id|port_no
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|br_stats.flags
op_amp
id|BR_UP
)paren
)paren
(brace
r_return
suffix:semicolon
)brace
multiline_comment|/* JRP: we have been shot down */
r_if
c_cond
(paren
id|hello_timer_expired
c_func
(paren
)paren
)paren
id|hello_timer_expiry
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tcn_timer_expired
c_func
(paren
)paren
)paren
id|tcn_timer_expiry
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|topology_change_timer_expired
c_func
(paren
)paren
)paren
id|topology_change_timer_expiry
c_func
(paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|port_no
op_assign
id|One
suffix:semicolon
id|port_no
op_le
id|No_of_ports
suffix:semicolon
id|port_no
op_increment
)paren
(brace
r_if
c_cond
(paren
id|port_info
(braket
id|port_no
)braket
dot
id|state
op_eq
id|Disabled
)paren
(brace
r_continue
suffix:semicolon
)brace
r_if
c_cond
(paren
id|forward_delay_timer_expired
c_func
(paren
id|port_no
)paren
)paren
id|forward_delay_timer_expiry
c_func
(paren
id|port_no
)paren
suffix:semicolon
r_if
c_cond
(paren
id|message_age_timer_expired
c_func
(paren
id|port_no
)paren
)paren
id|message_age_timer_expiry
c_func
(paren
id|port_no
)paren
suffix:semicolon
r_if
c_cond
(paren
id|hold_timer_expired
c_func
(paren
id|port_no
)paren
)paren
id|hold_timer_expiry
c_func
(paren
id|port_no
)paren
suffix:semicolon
)brace
multiline_comment|/* call me again sometime... */
id|tl.expires
op_assign
id|jiffies
op_plus
id|HZ
suffix:semicolon
multiline_comment|/* 1 second */
id|tl.function
op_assign
id|br_tick
suffix:semicolon
id|add_timer
c_func
(paren
op_amp
id|tl
)paren
suffix:semicolon
)brace
DECL|function|start_hello_timer
r_static
r_void
id|start_hello_timer
c_func
(paren
r_void
)paren
(brace
id|hello_timer.value
op_assign
l_int|0
suffix:semicolon
id|hello_timer.active
op_assign
id|TRUE
suffix:semicolon
)brace
DECL|function|stop_hello_timer
r_static
r_void
id|stop_hello_timer
c_func
(paren
r_void
)paren
(brace
id|hello_timer.active
op_assign
id|FALSE
suffix:semicolon
)brace
DECL|function|hello_timer_expired
r_static
r_int
id|hello_timer_expired
c_func
(paren
r_void
)paren
(brace
r_if
c_cond
(paren
id|hello_timer.active
op_logical_and
(paren
op_increment
id|hello_timer.value
op_ge
id|bridge_info.hello_time
)paren
)paren
(brace
id|hello_timer.active
op_assign
id|FALSE
suffix:semicolon
r_return
(paren
id|TRUE
)paren
suffix:semicolon
)brace
r_return
(paren
id|FALSE
)paren
suffix:semicolon
)brace
DECL|function|start_tcn_timer
r_static
r_void
id|start_tcn_timer
c_func
(paren
r_void
)paren
(brace
id|tcn_timer.value
op_assign
l_int|0
suffix:semicolon
id|tcn_timer.active
op_assign
id|TRUE
suffix:semicolon
)brace
DECL|function|stop_tcn_timer
r_static
r_void
id|stop_tcn_timer
c_func
(paren
r_void
)paren
(brace
id|tcn_timer.active
op_assign
id|FALSE
suffix:semicolon
)brace
DECL|function|tcn_timer_expired
r_static
r_int
id|tcn_timer_expired
c_func
(paren
r_void
)paren
(brace
r_if
c_cond
(paren
id|tcn_timer.active
op_logical_and
(paren
op_increment
id|tcn_timer.value
op_ge
id|bridge_info.bridge_hello_time
)paren
)paren
(brace
id|tcn_timer.active
op_assign
id|FALSE
suffix:semicolon
r_return
(paren
id|TRUE
)paren
suffix:semicolon
)brace
r_return
(paren
id|FALSE
)paren
suffix:semicolon
)brace
DECL|function|start_topology_change_timer
r_static
r_void
id|start_topology_change_timer
c_func
(paren
r_void
)paren
(brace
id|topology_change_timer.value
op_assign
l_int|0
suffix:semicolon
id|topology_change_timer.active
op_assign
id|TRUE
suffix:semicolon
)brace
DECL|function|stop_topology_change_timer
r_static
r_void
id|stop_topology_change_timer
c_func
(paren
r_void
)paren
(brace
id|topology_change_timer.active
op_assign
id|FALSE
suffix:semicolon
)brace
DECL|function|topology_change_timer_expired
r_static
r_int
id|topology_change_timer_expired
c_func
(paren
r_void
)paren
(brace
r_if
c_cond
(paren
id|topology_change_timer.active
op_logical_and
(paren
op_increment
id|topology_change_timer.value
op_ge
id|bridge_info.topology_change_time
)paren
)paren
(brace
id|topology_change_timer.active
op_assign
id|FALSE
suffix:semicolon
r_return
(paren
id|TRUE
)paren
suffix:semicolon
)brace
r_return
(paren
id|FALSE
)paren
suffix:semicolon
)brace
DECL|function|start_message_age_timer
r_static
r_void
id|start_message_age_timer
c_func
(paren
r_int
id|port_no
comma
r_int
r_int
id|message_age
)paren
(brace
id|message_age_timer
(braket
id|port_no
)braket
dot
id|value
op_assign
id|message_age
suffix:semicolon
id|message_age_timer
(braket
id|port_no
)braket
dot
id|active
op_assign
id|TRUE
suffix:semicolon
)brace
DECL|function|stop_message_age_timer
r_static
r_void
id|stop_message_age_timer
c_func
(paren
r_int
id|port_no
)paren
(brace
id|message_age_timer
(braket
id|port_no
)braket
dot
id|active
op_assign
id|FALSE
suffix:semicolon
)brace
DECL|function|message_age_timer_expired
r_static
r_int
id|message_age_timer_expired
c_func
(paren
r_int
id|port_no
)paren
(brace
r_if
c_cond
(paren
id|message_age_timer
(braket
id|port_no
)braket
dot
id|active
op_logical_and
(paren
op_increment
id|message_age_timer
(braket
id|port_no
)braket
dot
id|value
op_ge
id|bridge_info.max_age
)paren
)paren
(brace
id|message_age_timer
(braket
id|port_no
)braket
dot
id|active
op_assign
id|FALSE
suffix:semicolon
r_return
(paren
id|TRUE
)paren
suffix:semicolon
)brace
r_return
(paren
id|FALSE
)paren
suffix:semicolon
)brace
DECL|function|start_forward_delay_timer
r_static
r_void
id|start_forward_delay_timer
c_func
(paren
r_int
id|port_no
)paren
(brace
id|forward_delay_timer
(braket
id|port_no
)braket
dot
id|value
op_assign
l_int|0
suffix:semicolon
id|forward_delay_timer
(braket
id|port_no
)braket
dot
id|active
op_assign
id|TRUE
suffix:semicolon
)brace
DECL|function|stop_forward_delay_timer
r_static
r_void
id|stop_forward_delay_timer
c_func
(paren
r_int
id|port_no
)paren
(brace
id|forward_delay_timer
(braket
id|port_no
)braket
dot
id|active
op_assign
id|FALSE
suffix:semicolon
)brace
DECL|function|forward_delay_timer_expired
r_static
r_int
id|forward_delay_timer_expired
c_func
(paren
r_int
id|port_no
)paren
(brace
r_if
c_cond
(paren
id|forward_delay_timer
(braket
id|port_no
)braket
dot
id|active
op_logical_and
(paren
op_increment
id|forward_delay_timer
(braket
id|port_no
)braket
dot
id|value
op_ge
id|bridge_info.forward_delay
)paren
)paren
(brace
id|forward_delay_timer
(braket
id|port_no
)braket
dot
id|active
op_assign
id|FALSE
suffix:semicolon
r_return
(paren
id|TRUE
)paren
suffix:semicolon
)brace
r_return
(paren
id|FALSE
)paren
suffix:semicolon
)brace
DECL|function|start_hold_timer
r_static
r_void
id|start_hold_timer
c_func
(paren
r_int
id|port_no
)paren
(brace
id|hold_timer
(braket
id|port_no
)braket
dot
id|value
op_assign
l_int|0
suffix:semicolon
id|hold_timer
(braket
id|port_no
)braket
dot
id|active
op_assign
id|TRUE
suffix:semicolon
)brace
DECL|function|stop_hold_timer
r_static
r_void
id|stop_hold_timer
c_func
(paren
r_int
id|port_no
)paren
(brace
id|hold_timer
(braket
id|port_no
)braket
dot
id|active
op_assign
id|FALSE
suffix:semicolon
)brace
DECL|function|hold_timer_expired
r_static
r_int
id|hold_timer_expired
c_func
(paren
r_int
id|port_no
)paren
(brace
r_if
c_cond
(paren
id|hold_timer
(braket
id|port_no
)braket
dot
id|active
op_logical_and
(paren
op_increment
id|hold_timer
(braket
id|port_no
)braket
dot
id|value
op_ge
id|bridge_info.hold_time
)paren
)paren
(brace
id|hold_timer
(braket
id|port_no
)braket
dot
id|active
op_assign
id|FALSE
suffix:semicolon
r_return
(paren
id|TRUE
)paren
suffix:semicolon
)brace
r_return
(paren
id|FALSE
)paren
suffix:semicolon
)brace
DECL|function|alloc_bridge_skb
r_static
r_struct
id|sk_buff
op_star
id|alloc_bridge_skb
c_func
(paren
r_int
id|port_no
comma
r_int
id|pdu_size
comma
r_char
op_star
id|pdu_name
)paren
(brace
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
r_struct
id|device
op_star
id|dev
op_assign
id|port_info
(braket
id|port_no
)braket
dot
id|dev
suffix:semicolon
r_struct
id|ethhdr
op_star
id|eth
suffix:semicolon
r_int
id|size
op_assign
id|dev-&gt;hard_header_len
op_plus
id|BRIDGE_LLC1_HS
op_plus
id|pdu_size
suffix:semicolon
r_int
r_char
op_star
id|llc_buffer
suffix:semicolon
r_int
id|pad_size
op_assign
l_int|60
op_minus
id|size
suffix:semicolon
id|size
op_assign
l_int|60
suffix:semicolon
multiline_comment|/* minimum Ethernet frame - CRC */
r_if
c_cond
(paren
id|port_info
(braket
id|port_no
)braket
dot
id|state
op_eq
id|Disabled
)paren
(brace
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;send_%s_bpdu: port %i not valid&bslash;n&quot;
comma
id|pdu_name
comma
id|port_no
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
id|skb
op_assign
id|alloc_skb
c_func
(paren
id|size
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
id|skb
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;send_%s_bpdu: no skb available&bslash;n&quot;
comma
id|pdu_name
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
id|skb-&gt;dev
op_assign
id|dev
suffix:semicolon
id|skb-&gt;mac.raw
op_assign
id|skb-&gt;h.raw
op_assign
id|skb_put
c_func
(paren
id|skb
comma
id|size
)paren
suffix:semicolon
id|memset
c_func
(paren
id|skb-&gt;h.raw
op_plus
l_int|60
op_minus
id|pad_size
comma
l_int|0xa5
comma
id|pad_size
)paren
suffix:semicolon
id|eth
op_assign
id|skb-&gt;mac.ethernet
suffix:semicolon
id|memcpy
c_func
(paren
id|eth-&gt;h_dest
comma
id|bridge_ula
comma
id|ETH_ALEN
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|eth-&gt;h_source
comma
id|dev-&gt;dev_addr
comma
id|ETH_ALEN
)paren
suffix:semicolon
r_if
c_cond
(paren
id|br_stats.flags
op_amp
id|BR_DEBUG
)paren
id|printk
c_func
(paren
l_string|&quot;send_%s_bpdu: port %i src %02x:%02x:%02x:%02x:%02x:%02x&bslash;n&quot;
comma
id|pdu_name
comma
id|port_no
comma
id|eth-&gt;h_source
(braket
l_int|0
)braket
comma
id|eth-&gt;h_source
(braket
l_int|1
)braket
comma
id|eth-&gt;h_source
(braket
l_int|2
)braket
comma
id|eth-&gt;h_source
(braket
l_int|3
)braket
comma
id|eth-&gt;h_source
(braket
l_int|4
)braket
comma
id|eth-&gt;h_source
(braket
l_int|5
)braket
)paren
suffix:semicolon
macro_line|#if 0
multiline_comment|/* 8038 is used in older DEC spanning tree protocol which uses a&n;  * different pdu layout as well&n;  */
id|eth-&gt;h_proto
op_assign
id|htons
c_func
(paren
l_int|0x8038
)paren
suffix:semicolon
macro_line|#endif
id|eth-&gt;h_proto
op_assign
id|htons
c_func
(paren
id|pdu_size
op_plus
id|BRIDGE_LLC1_HS
)paren
suffix:semicolon
id|skb-&gt;h.raw
op_add_assign
id|skb-&gt;dev-&gt;hard_header_len
suffix:semicolon
id|llc_buffer
op_assign
id|skb-&gt;h.raw
suffix:semicolon
op_star
id|llc_buffer
op_increment
op_assign
id|BRIDGE_LLC1_DSAP
suffix:semicolon
op_star
id|llc_buffer
op_increment
op_assign
id|BRIDGE_LLC1_SSAP
suffix:semicolon
op_star
id|llc_buffer
op_increment
op_assign
id|BRIDGE_LLC1_CTRL
suffix:semicolon
multiline_comment|/* set h.raw to where the bpdu starts */
id|skb-&gt;h.raw
op_add_assign
id|BRIDGE_LLC1_HS
suffix:semicolon
multiline_comment|/* mark that we&squot;ve been here... */
id|skb-&gt;pkt_bridged
op_assign
id|IS_BRIDGED
suffix:semicolon
r_return
id|skb
suffix:semicolon
)brace
DECL|function|send_config_bpdu
r_static
r_int
id|send_config_bpdu
c_func
(paren
r_int
id|port_no
comma
id|Config_bpdu
op_star
id|config_bpdu
)paren
(brace
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
multiline_comment|/*&n;&t; *&t;Create and send the message&n;&t; */
id|skb
op_assign
id|alloc_bridge_skb
c_func
(paren
id|port_no
comma
id|BRIDGE_BPDU_8021_CONFIG_SIZE
comma
l_string|&quot;config&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|skb
op_eq
l_int|NULL
)paren
r_return
op_minus
l_int|1
suffix:semicolon
multiline_comment|/* copy fields before &quot;flags&quot; */
id|memcpy
c_func
(paren
id|skb-&gt;h.raw
comma
id|config_bpdu
comma
id|BRIDGE_BPDU_8021_CONFIG_FLAG_OFFSET
)paren
suffix:semicolon
multiline_comment|/* build the &quot;flags&quot; field */
op_star
(paren
id|skb-&gt;h.raw
op_plus
id|BRIDGE_BPDU_8021_CONFIG_FLAG_OFFSET
)paren
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|config_bpdu-&gt;top_change_ack
)paren
op_star
(paren
id|skb-&gt;h.raw
op_plus
id|BRIDGE_BPDU_8021_CONFIG_FLAG_OFFSET
)paren
op_or_assign
l_int|0x80
suffix:semicolon
r_if
c_cond
(paren
id|config_bpdu-&gt;top_change
)paren
op_star
(paren
id|skb-&gt;h.raw
op_plus
id|BRIDGE_BPDU_8021_CONFIG_FLAG_OFFSET
)paren
op_or_assign
l_int|0x01
suffix:semicolon
id|config_bpdu_hton
c_func
(paren
id|config_bpdu
)paren
suffix:semicolon
multiline_comment|/* copy the rest */
id|memcpy
c_func
(paren
id|skb-&gt;h.raw
op_plus
id|BRIDGE_BPDU_8021_CONFIG_FLAG_OFFSET
op_plus
l_int|1
comma
(paren
r_char
op_star
)paren
op_amp
(paren
id|config_bpdu-&gt;root_id
)paren
comma
id|BRIDGE_BPDU_8021_CONFIG_SIZE
op_minus
l_int|1
op_minus
id|BRIDGE_BPDU_8021_CONFIG_FLAG_OFFSET
)paren
suffix:semicolon
id|dev_queue_xmit
c_func
(paren
id|skb
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|send_tcn_bpdu
r_static
r_int
id|send_tcn_bpdu
c_func
(paren
r_int
id|port_no
comma
id|Tcn_bpdu
op_star
id|bpdu
)paren
(brace
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
id|skb
op_assign
id|alloc_bridge_skb
c_func
(paren
id|port_no
comma
r_sizeof
(paren
id|Tcn_bpdu
)paren
comma
l_string|&quot;tcn&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|skb
op_eq
l_int|NULL
)paren
r_return
op_minus
l_int|1
suffix:semicolon
id|memcpy
c_func
(paren
id|skb-&gt;h.raw
comma
id|bpdu
comma
r_sizeof
(paren
id|Tcn_bpdu
)paren
)paren
suffix:semicolon
id|dev_queue_xmit
c_func
(paren
id|skb
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|br_device_event
r_static
r_int
id|br_device_event
c_func
(paren
r_struct
id|notifier_block
op_star
id|unused
comma
r_int
r_int
id|event
comma
r_void
op_star
id|ptr
)paren
(brace
r_struct
id|device
op_star
id|dev
op_assign
id|ptr
suffix:semicolon
r_int
id|i
suffix:semicolon
multiline_comment|/* check for loopback devices */
r_if
c_cond
(paren
id|dev-&gt;flags
op_amp
id|IFF_LOOPBACK
)paren
r_return
id|NOTIFY_DONE
suffix:semicolon
r_switch
c_cond
(paren
id|event
)paren
(brace
r_case
id|NETDEV_DOWN
suffix:colon
r_if
c_cond
(paren
id|br_stats.flags
op_amp
id|BR_DEBUG
)paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;br_device_event: NETDEV_DOWN...&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* find our device and mark it down */
r_for
c_loop
(paren
id|i
op_assign
id|One
suffix:semicolon
id|i
op_le
id|No_of_ports
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|port_info
(braket
id|i
)braket
dot
id|dev
op_eq
id|dev
)paren
(brace
id|disable_port
c_func
(paren
id|i
)paren
suffix:semicolon
r_return
id|NOTIFY_DONE
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
r_break
suffix:semicolon
r_case
id|NETDEV_UP
suffix:colon
r_if
c_cond
(paren
id|br_stats.flags
op_amp
id|BR_DEBUG
)paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;br_device_event: NETDEV_UP...&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* Only handle ethernet ports */
r_if
c_cond
(paren
id|dev-&gt;type
op_ne
id|ARPHRD_ETHER
op_logical_and
id|dev-&gt;type
op_ne
id|ARPHRD_LOOPBACK
)paren
(brace
r_return
id|NOTIFY_DONE
suffix:semicolon
)brace
multiline_comment|/* look up an unused device and enable it */
r_for
c_loop
(paren
id|i
op_assign
id|One
suffix:semicolon
id|i
op_le
id|No_of_ports
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|port_info
(braket
id|i
)braket
dot
id|dev
op_eq
l_int|NULL
op_logical_or
id|port_info
(braket
id|i
)braket
dot
id|dev
op_eq
id|dev
)paren
(brace
id|port_info
(braket
id|i
)braket
dot
id|dev
op_assign
id|dev
suffix:semicolon
id|port_info
(braket
id|i
)braket
dot
id|port_id
op_assign
id|i
suffix:semicolon
multiline_comment|/* set bridge addr from 1st device addr */
r_if
c_cond
(paren
(paren
(paren
id|htonl
c_func
(paren
id|bridge_info.bridge_id.BRIDGE_ID
(braket
l_int|0
)braket
)paren
op_amp
l_int|0xffff
)paren
op_eq
l_int|0
)paren
op_logical_and
(paren
id|bridge_info.bridge_id.BRIDGE_ID
(braket
l_int|1
)braket
op_eq
l_int|0
)paren
)paren
(brace
id|memcpy
c_func
(paren
id|bridge_info.bridge_id.BRIDGE_ID_ULA
comma
id|dev-&gt;dev_addr
comma
l_int|6
)paren
suffix:semicolon
r_if
c_cond
(paren
id|bridge_info.bridge_id.BRIDGE_PRIORITY
op_eq
l_int|0
)paren
(brace
id|bridge_info.bridge_id.BRIDGE_PRIORITY
op_assign
id|htons
c_func
(paren
l_int|32768
)paren
suffix:semicolon
)brace
id|set_bridge_priority
c_func
(paren
op_amp
id|bridge_info.bridge_id
)paren
suffix:semicolon
)brace
id|br_add_local_mac
c_func
(paren
id|dev-&gt;dev_addr
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|br_stats.flags
op_amp
id|BR_UP
)paren
op_logical_and
(paren
id|user_port_state
(braket
id|i
)braket
op_ne
id|Disabled
)paren
)paren
(brace
multiline_comment|/* don&squot;t start if user said so */
id|enable_port
c_func
(paren
id|i
)paren
suffix:semicolon
id|set_path_cost
c_func
(paren
id|i
comma
id|br_port_cost
c_func
(paren
id|dev
)paren
)paren
suffix:semicolon
id|set_port_priority
c_func
(paren
id|i
)paren
suffix:semicolon
id|make_forwarding
c_func
(paren
id|i
)paren
suffix:semicolon
)brace
r_return
id|NOTIFY_DONE
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
r_break
suffix:semicolon
)brace
r_return
id|NOTIFY_DONE
suffix:semicolon
)brace
multiline_comment|/*&n; * following routine is called when a frame is received&n; * from an interface, it returns 1 when it consumes the&n; * frame, 0 when it does not&n; */
DECL|function|br_receive_frame
r_int
id|br_receive_frame
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
)paren
multiline_comment|/* 3.5 */
(brace
r_int
id|port
suffix:semicolon
id|Port_data
op_star
id|p
suffix:semicolon
r_struct
id|ethhdr
op_star
id|eth
suffix:semicolon
multiline_comment|/* sanity */
r_if
c_cond
(paren
op_logical_neg
id|skb
)paren
(brace
id|printk
c_func
(paren
id|KERN_CRIT
l_string|&quot;br_receive_frame: no skb!&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
id|skb-&gt;pkt_bridged
op_assign
id|IS_BRIDGED
suffix:semicolon
multiline_comment|/* check for loopback */
r_if
c_cond
(paren
id|skb-&gt;dev-&gt;flags
op_amp
id|IFF_LOOPBACK
)paren
r_return
l_int|0
suffix:semicolon
id|port
op_assign
id|find_port
c_func
(paren
id|skb-&gt;dev
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|port
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
id|skb-&gt;h.raw
op_assign
id|skb-&gt;mac.raw
suffix:semicolon
id|eth
op_assign
id|skb-&gt;mac.ethernet
suffix:semicolon
id|p
op_assign
op_amp
id|port_info
(braket
id|port
)braket
suffix:semicolon
r_if
c_cond
(paren
id|p-&gt;state
op_eq
id|Disabled
)paren
(brace
multiline_comment|/* We are here if BR_UP even if this port is Disabled.&n; &t;&t; * Send everything up&n; &t;&t; */
id|skb-&gt;pkt_type
op_assign
id|PACKET_HOST
suffix:semicolon
op_increment
id|br_stats_cnt.port_disable_up_stack
suffix:semicolon
r_return
l_int|0
suffix:semicolon
multiline_comment|/* pass frame up our stack (this will */
multiline_comment|/* happen in net_bh() in dev.c) */
)brace
multiline_comment|/* Here only if not disable.&n; &t; * Remark: only frames going up will show up in NIT (tcpdump)&n; &t; */
multiline_comment|/* JRP: even if port is Blocking we need to process the Spanning Tree&n;&t; * frames to keep the port in that state&n;&t; */
r_if
c_cond
(paren
id|memcmp
c_func
(paren
id|eth-&gt;h_dest
comma
id|bridge_ula
comma
id|ETH_ALEN
)paren
op_eq
l_int|0
)paren
(brace
op_increment
id|br_stats_cnt.rcv_bpdu
suffix:semicolon
id|br_bpdu
c_func
(paren
id|skb
comma
id|port
)paren
suffix:semicolon
multiline_comment|/* br_bpdu consumes skb */
r_return
l_int|1
suffix:semicolon
)brace
r_switch
c_cond
(paren
id|p-&gt;state
)paren
(brace
r_case
id|Learning
suffix:colon
r_if
c_cond
(paren
id|br_learn
c_func
(paren
id|skb
comma
id|port
)paren
)paren
(brace
multiline_comment|/* 3.8 */
op_increment
id|br_stats_cnt.drop_multicast
suffix:semicolon
r_return
id|br_drop
c_func
(paren
id|skb
)paren
suffix:semicolon
)brace
multiline_comment|/* fall through */
r_case
id|Listening
suffix:colon
multiline_comment|/* fall through */
r_case
id|Blocking
suffix:colon
op_increment
id|br_stats_cnt.notForwarding
suffix:semicolon
r_return
id|br_drop
c_func
(paren
id|skb
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t;case Disabled: is now handled before this switch !&n;&t;&t;Keep the break to allow GCC to use a jmp table.&n;&t;&t; */
r_break
suffix:semicolon
r_case
id|Forwarding
suffix:colon
r_if
c_cond
(paren
id|br_learn
c_func
(paren
id|skb
comma
id|port
)paren
)paren
(brace
multiline_comment|/* 3.8 */
op_increment
id|br_stats_cnt.drop_multicast
suffix:semicolon
r_return
id|br_drop
c_func
(paren
id|skb
)paren
suffix:semicolon
)brace
multiline_comment|/* Now this frame came from one of bridged&n;&t;&t;&t;   ports this means we should attempt to forward it.&n;&t;&t;&t;   JRP: local addresses are now in the AVL tree,&n;&t;&t;&t;   br_forward will pass frames up if it matches&n;&t;&t;&t;   one of our local MACs or if it is a multicast&n;&t;&t;&t;   group address.&n;&t;&t;&t;   br_forward() will not consume the frame if this&n;&t;&t;&t;   is the case */
r_return
id|br_forward
c_func
(paren
id|skb
comma
id|port
)paren
suffix:semicolon
r_default
suffix:colon
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;br_receive_frame: port [%i] unknown state [%i]&bslash;n&quot;
comma
id|port
comma
id|p-&gt;state
)paren
suffix:semicolon
op_increment
id|br_stats_cnt.unknown_state
suffix:semicolon
r_return
id|br_drop
c_func
(paren
id|skb
)paren
suffix:semicolon
multiline_comment|/* discard frame */
)brace
)brace
multiline_comment|/*&n; * the following routine is called to transmit frames from the host&n; * stack.  it returns 1 when it consumes the frame and&n; * 0 when it does not.&n; */
DECL|function|br_tx_frame
r_int
id|br_tx_frame
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
)paren
multiline_comment|/* 3.5 */
(brace
r_int
id|port
suffix:semicolon
r_struct
id|ethhdr
op_star
id|eth
suffix:semicolon
multiline_comment|/* sanity */
r_if
c_cond
(paren
op_logical_neg
id|skb
)paren
(brace
id|printk
c_func
(paren
id|KERN_CRIT
l_string|&quot;br_tx_frame: no skb!&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|skb-&gt;dev
)paren
(brace
id|printk
c_func
(paren
id|KERN_CRIT
l_string|&quot;br_tx_frame: no dev!&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* check for loopback */
r_if
c_cond
(paren
id|skb-&gt;dev-&gt;flags
op_amp
id|IFF_LOOPBACK
)paren
r_return
l_int|0
suffix:semicolon
multiline_comment|/* if bridging is not enabled on the port we are going to send&n;           to, we have nothing to do with this frame, hands off */
r_if
c_cond
(paren
(paren
(paren
id|port
op_assign
id|find_port
c_func
(paren
id|skb-&gt;dev
)paren
)paren
op_eq
l_int|0
)paren
op_logical_or
(paren
id|port_info
(braket
id|port
)braket
dot
id|state
op_eq
id|Disabled
)paren
)paren
(brace
op_increment
id|br_stats_cnt.port_disable
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
op_increment
id|br_stats_cnt.port_not_disable
suffix:semicolon
id|skb-&gt;mac.raw
op_assign
id|skb-&gt;h.raw
op_assign
id|skb-&gt;data
suffix:semicolon
id|eth
op_assign
id|skb-&gt;mac.ethernet
suffix:semicolon
id|port
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* an impossible port (locally generated) */
r_if
c_cond
(paren
id|br_stats.flags
op_amp
id|BR_DEBUG
)paren
id|printk
c_func
(paren
l_string|&quot;br_tx_fr : port %i src %02x:%02x:%02x:%02x:%02x:%02x&quot;
l_string|&quot; dest %02x:%02x:%02x:%02x:%02x:%02x&bslash;n&quot;
comma
id|port
comma
id|eth-&gt;h_source
(braket
l_int|0
)braket
comma
id|eth-&gt;h_source
(braket
l_int|1
)braket
comma
id|eth-&gt;h_source
(braket
l_int|2
)braket
comma
id|eth-&gt;h_source
(braket
l_int|3
)braket
comma
id|eth-&gt;h_source
(braket
l_int|4
)braket
comma
id|eth-&gt;h_source
(braket
l_int|5
)braket
comma
id|eth-&gt;h_dest
(braket
l_int|0
)braket
comma
id|eth-&gt;h_dest
(braket
l_int|1
)braket
comma
id|eth-&gt;h_dest
(braket
l_int|2
)braket
comma
id|eth-&gt;h_dest
(braket
l_int|3
)braket
comma
id|eth-&gt;h_dest
(braket
l_int|4
)braket
comma
id|eth-&gt;h_dest
(braket
l_int|5
)braket
)paren
suffix:semicolon
r_return
id|br_forward
c_func
(paren
id|skb
comma
id|port
)paren
suffix:semicolon
)brace
DECL|function|br_add_local_mac
r_static
r_void
id|br_add_local_mac
c_func
(paren
r_int
r_char
op_star
id|mac
)paren
(brace
r_struct
id|fdb
op_star
id|f
suffix:semicolon
id|f
op_assign
(paren
r_struct
id|fdb
op_star
)paren
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|fdb
)paren
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|f
)paren
(brace
id|printk
c_func
(paren
id|KERN_CRIT
l_string|&quot;br_add_local_mac: unable to malloc fdb&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|f-&gt;port
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* dest port == 0 =&gt;local */
id|memcpy
c_func
(paren
id|f-&gt;ula
comma
id|mac
comma
l_int|6
)paren
suffix:semicolon
id|f-&gt;timer
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* will not aged anyway */
id|f-&gt;flags
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* not valid =&gt; br_forward special route */
multiline_comment|/*&n;&t; * add entity to AVL tree.  If entity already&n;&t; * exists in the tree, update the fields with&n;&t; * what we have here.&n;  &t; */
r_if
c_cond
(paren
id|br_avl_insert
c_func
(paren
id|f
)paren
op_ne
l_int|NULL
)paren
(brace
multiline_comment|/* Already in */
id|kfree
c_func
(paren
id|f
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* Avoid broadcast loop by limiting the number of broacast frames per&n; * period. The idea is to limit this per source&n; * returns: 0 if limit is not reached&n; *          1 if frame should be dropped&n; */
DECL|function|mcast_quench
r_static
r_inline
r_int
id|mcast_quench
c_func
(paren
r_struct
id|fdb
op_star
id|f
)paren
(brace
r_if
c_cond
(paren
id|f-&gt;mcast_count
op_increment
op_eq
l_int|0
)paren
(brace
multiline_comment|/* first time */
id|f-&gt;mcast_timer
op_assign
id|jiffies
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|f-&gt;mcast_count
OG
id|max_mcast_per_period
)paren
(brace
r_if
c_cond
(paren
id|time_after
c_func
(paren
id|jiffies
comma
id|f-&gt;mcast_timer
op_plus
id|mcast_hold_time
)paren
)paren
(brace
id|f-&gt;mcast_count
op_assign
l_int|0
suffix:semicolon
)brace
r_else
r_return
l_int|1
suffix:semicolon
)brace
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * this routine returns 0 when it learns (or updates) from the&n; * frame, and 1 if we must dropped the frame.&n; */
DECL|function|br_learn
r_static
r_int
id|br_learn
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_int
id|port
)paren
multiline_comment|/* 3.8 */
(brace
r_struct
id|fdb
op_star
id|f
comma
op_star
id|oldfdb
suffix:semicolon
id|Port_data
op_star
id|p
op_assign
op_amp
id|port_info
(braket
id|port
)braket
suffix:semicolon
r_struct
id|ethhdr
op_star
id|eth
op_assign
id|skb-&gt;mac.ethernet
suffix:semicolon
multiline_comment|/* JRP: no reason to check port state again. We are called by&n;&t; * br_receive_frame() only when in Learning or Forwarding&n;&t; * Remark: code not realigned yet to keep diffs smaller&n;&t; */
multiline_comment|/* don&squot;t keep group addresses in the tree */
r_if
c_cond
(paren
id|eth-&gt;h_source
(braket
l_int|0
)braket
op_amp
l_int|0x01
)paren
r_return
l_int|0
suffix:semicolon
r_if
c_cond
(paren
(paren
id|f
op_assign
id|newfdb
(braket
id|port
)braket
)paren
op_eq
l_int|NULL
)paren
(brace
id|newfdb
(braket
id|port
)braket
op_assign
id|f
op_assign
(paren
r_struct
id|fdb
op_star
)paren
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|fdb
)paren
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|f
)paren
(brace
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;br_learn: unable to malloc fdb&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
multiline_comment|/* this drop the frame */
)brace
)brace
id|f-&gt;port
op_assign
id|port
suffix:semicolon
multiline_comment|/* source port */
id|memcpy
c_func
(paren
id|f-&gt;ula
comma
id|eth-&gt;h_source
comma
l_int|6
)paren
suffix:semicolon
id|f-&gt;timer
op_assign
id|CURRENT_TIME
suffix:semicolon
id|f-&gt;flags
op_assign
id|FDB_ENT_VALID
suffix:semicolon
multiline_comment|/*&n;&t; * add entity to AVL tree.  If entity already&n;&t; * exists in the tree, update the fields with&n;&t; * what we have here.&n;&t; */
r_if
c_cond
(paren
(paren
id|oldfdb
op_assign
id|br_avl_insert
c_func
(paren
id|f
)paren
)paren
)paren
(brace
multiline_comment|/* update if !NULL */
r_if
c_cond
(paren
(paren
id|eth-&gt;h_dest
(braket
l_int|0
)braket
op_amp
l_int|0x01
)paren
op_logical_and
multiline_comment|/* multicast */
id|mcast_quench
c_func
(paren
id|oldfdb
)paren
)paren
(brace
r_return
l_int|1
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
id|newfdb
(braket
id|port
)braket
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/* force kmalloc next time */
id|f-&gt;mcast_count
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* add to head of port chain */
id|f-&gt;fdb_next
op_assign
id|p-&gt;fdb
suffix:semicolon
id|p-&gt;fdb
op_assign
id|f
suffix:semicolon
id|allocated_fdb_cnt
op_increment
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* JRP: always called under br_receive_frame(). No need for Q protection. */
DECL|function|requeue_fdb
r_void
id|requeue_fdb
c_func
(paren
r_struct
id|fdb
op_star
id|node
comma
r_int
id|new_port
)paren
(brace
id|Port_data
op_star
id|p
op_assign
op_amp
id|port_info
(braket
id|node-&gt;port
)braket
suffix:semicolon
multiline_comment|/* dequeue */
r_if
c_cond
(paren
id|p-&gt;fdb
op_eq
id|node
)paren
(brace
id|p-&gt;fdb
op_assign
id|node-&gt;fdb_next
suffix:semicolon
)brace
r_else
(brace
r_struct
id|fdb
op_star
id|prev
suffix:semicolon
r_for
c_loop
(paren
id|prev
op_assign
id|p-&gt;fdb
suffix:semicolon
id|prev
suffix:semicolon
id|prev
op_assign
id|prev-&gt;fdb_next
)paren
r_if
c_cond
(paren
id|prev-&gt;fdb_next
op_eq
id|node
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
id|prev
op_ne
l_int|NULL
)paren
(brace
id|prev-&gt;fdb_next
op_assign
id|node-&gt;fdb_next
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/*&t;Forget about this update. */
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;br:requeue_fdb&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
)brace
multiline_comment|/* enqueue */
id|node-&gt;port
op_assign
id|new_port
suffix:semicolon
id|node-&gt;fdb_next
op_assign
id|port_info
(braket
id|new_port
)braket
dot
id|fdb
suffix:semicolon
id|port_info
(braket
id|new_port
)braket
dot
id|fdb
op_assign
id|node
suffix:semicolon
)brace
multiline_comment|/*&n; * this routine always consumes the frame&n; */
DECL|function|br_drop
r_static
r_int
id|br_drop
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
)paren
(brace
id|kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
multiline_comment|/*&n; * this routine always consumes the frame&n; */
DECL|function|br_dev_drop
r_static
r_int
id|br_dev_drop
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
)paren
(brace
id|dev_kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
multiline_comment|/*&n; * Forward the frame SKB to proper port[s].  PORT is the port that the&n; * frame has come from; we will not send the frame back there.  PORT == 0&n; * means we have been called from br_tx_fr(), not from br_receive_frame().&n; *&n; * this routine returns 1 if it consumes the frame, 0&n; * if not...&n; */
DECL|function|br_forward
r_static
r_int
id|br_forward
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_int
id|port
)paren
multiline_comment|/* 3.7 */
(brace
r_struct
id|fdb
op_star
id|f
suffix:semicolon
multiline_comment|/*&n;   &t; * flood all ports with frames destined for a group&n;&t; * address.  If frame came from above, drop it,&n;&t; * otherwise it will be handled in br_receive_frame()&n;&t; * Multicast frames will also need to be seen&n;&t; * by our upper layers.&n;&t; */
r_if
c_cond
(paren
id|skb-&gt;mac.ethernet-&gt;h_dest
(braket
l_int|0
)braket
op_amp
l_int|0x01
)paren
(brace
multiline_comment|/* group address */
id|br_flood
c_func
(paren
id|skb
comma
id|port
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t; *&t;External groups are fed out via the normal source&n;&t;&t; *&t;This probably should be dropped since the flood will&n;&t;&t; *&t;have sent it anyway.&n;&t;&t; */
r_if
c_cond
(paren
id|port
op_eq
l_int|0
)paren
(brace
multiline_comment|/* Locally generated */
op_increment
id|br_stats_cnt.local_multicast
suffix:semicolon
r_return
id|br_dev_drop
c_func
(paren
id|skb
)paren
suffix:semicolon
)brace
op_increment
id|br_stats_cnt.forwarded_multicast
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* unicast frame, locate port to forward to */
id|f
op_assign
id|br_avl_find_addr
c_func
(paren
id|skb-&gt;mac.ethernet-&gt;h_dest
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t; *&t;Send flood and drop.&n;&t;&t; */
r_if
c_cond
(paren
op_logical_neg
id|f
op_logical_or
op_logical_neg
(paren
id|f-&gt;flags
op_amp
id|FDB_ENT_VALID
)paren
)paren
(brace
r_if
c_cond
(paren
id|f
op_logical_and
(paren
id|f-&gt;port
op_eq
l_int|0
)paren
)paren
(brace
id|skb-&gt;pkt_type
op_assign
id|PACKET_HOST
suffix:semicolon
op_increment
id|br_stats_cnt.forwarded_unicast_up_stack
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* not found or too old; flood all ports */
op_increment
id|br_stats_cnt.flood_unicast
suffix:semicolon
id|br_flood
c_func
(paren
id|skb
comma
id|port
)paren
suffix:semicolon
r_return
id|br_dev_drop
c_func
(paren
id|skb
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;&t;&t; *&t;Sending&n;&t;&t; */
r_if
c_cond
(paren
id|f-&gt;port
op_ne
id|port
op_logical_and
id|port_info
(braket
id|f-&gt;port
)braket
dot
id|state
op_eq
id|Forwarding
)paren
(brace
multiline_comment|/* Has entry expired? */
r_if
c_cond
(paren
id|f-&gt;timer
op_plus
id|fdb_aging_time
OL
id|CURRENT_TIME
)paren
(brace
multiline_comment|/* timer expired, invalidate entry */
id|f-&gt;flags
op_and_assign
op_complement
id|FDB_ENT_VALID
suffix:semicolon
r_if
c_cond
(paren
id|br_stats.flags
op_amp
id|BR_DEBUG
)paren
id|printk
c_func
(paren
l_string|&quot;fdb entry expired...&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t;&t;&t; *&t;Send flood and drop original&n;&t;&t;&t;&t; */
op_increment
id|br_stats_cnt.aged_flood_unicast
suffix:semicolon
id|br_flood
c_func
(paren
id|skb
comma
id|port
)paren
suffix:semicolon
r_return
id|br_dev_drop
c_func
(paren
id|skb
)paren
suffix:semicolon
)brace
op_increment
id|br_stats_cnt.forwarded_unicast
suffix:semicolon
multiline_comment|/* mark that&squot;s we&squot;ve been here... */
id|skb-&gt;pkt_bridged
op_assign
id|IS_BRIDGED
suffix:semicolon
multiline_comment|/* reset the skb-&gt;ip pointer */
id|skb-&gt;h.raw
op_assign
id|skb-&gt;data
op_plus
id|ETH_HLEN
suffix:semicolon
multiline_comment|/*&n;&t;&t;&t; *&t;Send the buffer out.&n;&t;&t;&t; */
id|skb-&gt;dev
op_assign
id|port_info
(braket
id|f-&gt;port
)braket
dot
id|dev
suffix:semicolon
multiline_comment|/*&n;&t;&t;&t; *&t;We send this still locked&n;&t;&t;&t; */
id|skb-&gt;priority
op_assign
l_int|1
suffix:semicolon
id|dev_queue_xmit
c_func
(paren
id|skb
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
multiline_comment|/* skb has been consumed */
)brace
r_else
(brace
multiline_comment|/* JRP: Needs to aged entry as well, if topology changes&n;&t;&t;&t; * the entry would not age. Got this while swapping&n;&t;&t;&t; * two cables !&n;&t;&t;&t; *&n;&t;&t;&t; *&t;Has entry expired?&n;&t;&t;&t; */
r_if
c_cond
(paren
id|f-&gt;timer
op_plus
id|fdb_aging_time
OL
id|CURRENT_TIME
)paren
(brace
multiline_comment|/* timer expired, invalidate entry */
id|f-&gt;flags
op_and_assign
op_complement
id|FDB_ENT_VALID
suffix:semicolon
r_if
c_cond
(paren
id|br_stats.flags
op_amp
id|BR_DEBUG
)paren
id|printk
c_func
(paren
l_string|&quot;fdb entry expired...&bslash;n&quot;
)paren
suffix:semicolon
op_increment
id|br_stats_cnt.drop_same_port_aged
suffix:semicolon
)brace
r_else
op_increment
id|br_stats_cnt.drop_same_port
suffix:semicolon
multiline_comment|/*&n;&t;&t;&t; *&t;Arrived on the right port, we discard&n;&t;&t;&t; */
r_return
id|br_dev_drop
c_func
(paren
id|skb
)paren
suffix:semicolon
)brace
)brace
)brace
multiline_comment|/*&n; * this routine sends a copy of the frame to all forwarding ports&n; * with the exception of the port given.  This routine never&n; * consumes the original frame.&n; */
DECL|function|br_flood
r_static
r_int
id|br_flood
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_int
id|port
)paren
(brace
r_int
id|i
suffix:semicolon
r_struct
id|sk_buff
op_star
id|nskb
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
id|One
suffix:semicolon
id|i
op_le
id|No_of_ports
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|i
op_eq
id|port
)paren
multiline_comment|/* don&squot;t send back where we got it */
r_continue
suffix:semicolon
r_if
c_cond
(paren
id|port_info
(braket
id|i
)braket
dot
id|state
op_eq
id|Forwarding
)paren
(brace
id|nskb
op_assign
id|skb_clone
c_func
(paren
id|skb
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
id|nskb
op_eq
l_int|NULL
)paren
(brace
r_continue
suffix:semicolon
)brace
multiline_comment|/* mark that&squot;s we&squot;ve been here... */
id|nskb-&gt;pkt_bridged
op_assign
id|IS_BRIDGED
suffix:semicolon
multiline_comment|/* Send to each port in turn */
id|nskb-&gt;dev
op_assign
id|port_info
(braket
id|i
)braket
dot
id|dev
suffix:semicolon
multiline_comment|/* To get here we must have done ARP already,&n;&t;&t;&t;   or have a received valid MAC header */
multiline_comment|/*&t;&t;&t;printk(&quot;Flood to port %d&bslash;n&quot;,i);*/
id|nskb-&gt;h.raw
op_assign
id|nskb-&gt;data
op_plus
id|ETH_HLEN
suffix:semicolon
macro_line|#if LINUX_VERSION_CODE &gt;= 0x20100
id|nskb-&gt;priority
op_assign
l_int|1
suffix:semicolon
id|dev_queue_xmit
c_func
(paren
id|nskb
)paren
suffix:semicolon
macro_line|#else
id|dev_queue_xmit
c_func
(paren
id|nskb
comma
id|nskb-&gt;dev
comma
l_int|1
)paren
suffix:semicolon
macro_line|#endif
)brace
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|find_port
r_static
r_int
id|find_port
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
id|One
suffix:semicolon
id|i
op_le
id|No_of_ports
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
id|port_info
(braket
id|i
)braket
dot
id|dev
op_eq
id|dev
)paren
r_return
id|i
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;FIXME: This needs to come from the device structs, eg for&n; *&t;10,100,1Gbit ethernet.&n; */
DECL|function|br_port_cost
r_static
r_int
id|br_port_cost
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
multiline_comment|/* 4.10.2 */
(brace
r_if
c_cond
(paren
id|strncmp
c_func
(paren
id|dev-&gt;name
comma
l_string|&quot;eth&quot;
comma
l_int|3
)paren
op_eq
l_int|0
)paren
multiline_comment|/* ethernet */
r_return
l_int|100
suffix:semicolon
r_if
c_cond
(paren
id|strncmp
c_func
(paren
id|dev-&gt;name
comma
l_string|&quot;plip&quot;
comma
l_int|4
)paren
op_eq
l_int|0
)paren
multiline_comment|/* plip */
r_return
(paren
l_int|1600
)paren
suffix:semicolon
r_return
l_int|100
suffix:semicolon
multiline_comment|/* default */
)brace
multiline_comment|/*&n; * this routine always consumes the skb &n; */
DECL|function|br_bpdu
r_static
r_void
id|br_bpdu
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_int
id|port
)paren
multiline_comment|/* consumes skb */
(brace
r_char
op_star
id|bufp
op_assign
id|skb-&gt;data
op_plus
id|ETH_HLEN
suffix:semicolon
id|Tcn_bpdu
op_star
id|bpdu
op_assign
(paren
id|Tcn_bpdu
op_star
)paren
(paren
id|bufp
op_plus
id|BRIDGE_LLC1_HS
)paren
suffix:semicolon
id|Config_bpdu
id|rcv_bpdu
suffix:semicolon
r_if
c_cond
(paren
(paren
op_star
id|bufp
op_increment
op_eq
id|BRIDGE_LLC1_DSAP
)paren
op_logical_and
(paren
op_star
id|bufp
op_increment
op_eq
id|BRIDGE_LLC1_SSAP
)paren
op_logical_and
(paren
op_star
id|bufp
op_increment
op_eq
id|BRIDGE_LLC1_CTRL
)paren
op_logical_and
(paren
id|bpdu-&gt;protocol_id
op_eq
id|BRIDGE_BPDU_8021_PROTOCOL_ID
)paren
op_logical_and
(paren
id|bpdu-&gt;protocol_version_id
op_eq
id|BRIDGE_BPDU_8021_PROTOCOL_VERSION_ID
)paren
)paren
(brace
r_switch
c_cond
(paren
id|bpdu-&gt;type
)paren
(brace
r_case
id|BPDU_TYPE_CONFIG
suffix:colon
multiline_comment|/* realign for portability to RISC */
id|memcpy
c_func
(paren
(paren
r_char
op_star
)paren
op_amp
id|rcv_bpdu
comma
id|bufp
comma
id|BRIDGE_BPDU_8021_CONFIG_FLAG_OFFSET
)paren
suffix:semicolon
id|bufp
op_add_assign
id|BRIDGE_BPDU_8021_CONFIG_FLAG_OFFSET
suffix:semicolon
id|rcv_bpdu.top_change_ack
op_assign
(paren
op_star
id|bufp
op_amp
id|TOPOLOGY_CHANGE_ACK
)paren
op_ne
l_int|0
suffix:semicolon
id|rcv_bpdu.top_change
op_assign
(paren
op_star
id|bufp
op_amp
id|TOPOLOGY_CHANGE
)paren
op_ne
l_int|0
suffix:semicolon
id|bufp
op_increment
suffix:semicolon
id|memcpy
c_func
(paren
(paren
r_char
op_star
)paren
op_amp
id|rcv_bpdu.root_id
comma
id|bufp
comma
id|BRIDGE_BPDU_8021_CONFIG_SIZE
op_minus
l_int|1
op_minus
id|BRIDGE_BPDU_8021_CONFIG_FLAG_OFFSET
)paren
suffix:semicolon
id|config_bpdu_ntoh
c_func
(paren
op_amp
id|rcv_bpdu
)paren
suffix:semicolon
id|received_config_bpdu
c_func
(paren
id|port
comma
op_amp
id|rcv_bpdu
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|BPDU_TYPE_TOPO_CHANGE
suffix:colon
id|received_tcn_bpdu
c_func
(paren
id|port
comma
id|bpdu
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;br_bpdu: received unknown bpdu, type = %i&bslash;n&quot;
comma
id|bpdu-&gt;type
)paren
suffix:semicolon
multiline_comment|/* break; */
)brace
)brace
id|br_drop
c_func
(paren
id|skb
)paren
suffix:semicolon
)brace
DECL|function|get_fdb_info
r_struct
id|fdb_info
op_star
id|get_fdb_info
c_func
(paren
r_int
id|user_buf_size
comma
r_int
op_star
id|copied
comma
r_int
op_star
id|notcopied
)paren
(brace
r_int
id|fdb_size
comma
id|i
comma
id|built
op_assign
l_int|0
suffix:semicolon
r_struct
id|fdb_info
op_star
id|fdbi
comma
op_star
id|fdbis
suffix:semicolon
op_star
id|copied
op_assign
id|user_buf_size
op_minus
r_sizeof
(paren
r_struct
id|fdb_info_hdr
)paren
suffix:semicolon
op_star
id|copied
op_div_assign
r_sizeof
(paren
r_struct
id|fdb_info
)paren
suffix:semicolon
op_star
id|copied
op_assign
id|min
c_func
(paren
op_star
id|copied
comma
id|allocated_fdb_cnt
)paren
suffix:semicolon
op_star
id|notcopied
op_assign
id|allocated_fdb_cnt
op_minus
op_star
id|copied
suffix:semicolon
r_if
c_cond
(paren
op_star
id|copied
op_eq
l_int|0
)paren
(brace
r_return
l_int|NULL
suffix:semicolon
)brace
id|fdb_size
op_assign
op_star
id|copied
op_star
r_sizeof
(paren
r_struct
id|fdb_info
)paren
suffix:semicolon
id|fdbis
op_assign
id|kmalloc
c_func
(paren
id|fdb_size
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|fdbis
op_eq
l_int|NULL
)paren
(brace
r_return
l_int|NULL
suffix:semicolon
)brace
id|fdbi
op_assign
id|fdbis
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
id|One
suffix:semicolon
id|i
op_le
id|No_of_ports
suffix:semicolon
id|i
op_increment
)paren
(brace
r_struct
id|fdb
op_star
id|fdb
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|fdb
op_assign
id|port_info
(braket
id|i
)braket
dot
id|fdb
suffix:semicolon
r_while
c_loop
(paren
id|fdb
)paren
(brace
id|memcpy
c_func
(paren
id|fdbi-&gt;ula
comma
id|fdb-&gt;ula
comma
id|ETH_ALEN
)paren
suffix:semicolon
id|fdbi-&gt;port
op_assign
id|fdb-&gt;port
suffix:semicolon
id|fdbi-&gt;flags
op_assign
id|fdb-&gt;flags
suffix:semicolon
id|fdbi-&gt;timer
op_assign
id|fdb-&gt;timer
suffix:semicolon
id|fdbi
op_increment
suffix:semicolon
r_if
c_cond
(paren
op_increment
id|built
op_eq
op_star
id|copied
)paren
(brace
id|sti
c_func
(paren
)paren
suffix:semicolon
r_return
id|fdbis
suffix:semicolon
)brace
id|fdb
op_assign
id|fdb-&gt;fdb_next
suffix:semicolon
)brace
id|sti
c_func
(paren
)paren
suffix:semicolon
)brace
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;get_fdb_info: built=%d&bslash;n&quot;
comma
id|built
)paren
suffix:semicolon
r_return
id|fdbis
suffix:semicolon
)brace
DECL|function|br_ioctl
r_int
id|br_ioctl
c_func
(paren
r_int
r_int
id|cmd
comma
r_void
op_star
id|arg
)paren
(brace
r_int
id|err
comma
id|i
suffix:semicolon
r_struct
id|br_cf
id|bcf
suffix:semicolon
id|bridge_id_t
id|new_id
suffix:semicolon
r_switch
c_cond
(paren
id|cmd
)paren
(brace
r_case
id|SIOCGIFBR
suffix:colon
multiline_comment|/* get bridging control blocks */
id|memcpy
c_func
(paren
op_amp
id|br_stats.bridge_data
comma
op_amp
id|bridge_info
comma
r_sizeof
(paren
id|Bridge_data
)paren
)paren
suffix:semicolon
id|memcpy
c_func
(paren
op_amp
id|br_stats.port_data
comma
op_amp
id|port_info
comma
r_sizeof
(paren
id|Port_data
)paren
op_star
id|No_of_ports
)paren
suffix:semicolon
id|err
op_assign
id|copy_to_user
c_func
(paren
id|arg
comma
op_amp
id|br_stats
comma
r_sizeof
(paren
r_struct
id|br_stat
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
(brace
id|err
op_assign
op_minus
id|EFAULT
suffix:semicolon
)brace
r_return
id|err
suffix:semicolon
r_case
id|SIOCSIFBR
suffix:colon
id|err
op_assign
id|copy_from_user
c_func
(paren
op_amp
id|bcf
comma
id|arg
comma
r_sizeof
(paren
r_struct
id|br_cf
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_if
c_cond
(paren
id|bcf.cmd
op_ne
id|BRCMD_DISPLAY_FDB
op_logical_and
op_logical_neg
id|suser
c_func
(paren
)paren
)paren
r_return
op_minus
id|EPERM
suffix:semicolon
r_switch
c_cond
(paren
id|bcf.cmd
)paren
(brace
r_case
id|BRCMD_BRIDGE_ENABLE
suffix:colon
r_if
c_cond
(paren
id|br_stats.flags
op_amp
id|BR_UP
)paren
r_return
op_minus
id|EALREADY
suffix:semicolon
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;br: enabling bridging function&bslash;n&quot;
)paren
suffix:semicolon
id|br_stats.flags
op_or_assign
id|BR_UP
suffix:semicolon
multiline_comment|/* enable bridge */
r_for
c_loop
(paren
id|i
op_assign
id|One
suffix:semicolon
id|i
op_le
id|No_of_ports
suffix:semicolon
id|i
op_increment
)paren
(brace
multiline_comment|/* don&squot;t start if user said so */
r_if
c_cond
(paren
(paren
id|user_port_state
(braket
id|i
)braket
op_ne
id|Disabled
)paren
op_logical_and
id|port_info
(braket
id|i
)braket
dot
id|dev
)paren
(brace
id|enable_port
c_func
(paren
id|i
)paren
suffix:semicolon
)brace
)brace
id|port_state_selection
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* (4.8.1.5)&t; */
id|config_bpdu_generation
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* (4.8.1.6)&t; */
multiline_comment|/* initialize system timer */
id|tl.expires
op_assign
id|jiffies
op_plus
id|HZ
suffix:semicolon
multiline_comment|/* 1 second */
id|tl.function
op_assign
id|br_tick
suffix:semicolon
id|add_timer
c_func
(paren
op_amp
id|tl
)paren
suffix:semicolon
id|start_hello_timer
c_func
(paren
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|BRCMD_BRIDGE_DISABLE
suffix:colon
r_if
c_cond
(paren
op_logical_neg
(paren
id|br_stats.flags
op_amp
id|BR_UP
)paren
)paren
r_return
op_minus
id|EALREADY
suffix:semicolon
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;br: disabling bridging function&bslash;n&quot;
)paren
suffix:semicolon
id|br_stats.flags
op_and_assign
op_complement
id|BR_UP
suffix:semicolon
multiline_comment|/* disable bridge */
id|stop_hello_timer
c_func
(paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
id|One
suffix:semicolon
id|i
op_le
id|No_of_ports
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
id|port_info
(braket
id|i
)braket
dot
id|state
op_ne
id|Disabled
)paren
id|disable_port
c_func
(paren
id|i
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|BRCMD_PORT_ENABLE
suffix:colon
r_if
c_cond
(paren
id|port_info
(braket
id|bcf.arg1
)braket
dot
id|dev
op_eq
l_int|0
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|user_port_state
(braket
id|bcf.arg1
)braket
op_ne
id|Disabled
)paren
r_return
op_minus
id|EALREADY
suffix:semicolon
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;br: enabling port %i&bslash;n&quot;
comma
id|bcf.arg1
)paren
suffix:semicolon
id|user_port_state
(braket
id|bcf.arg1
)braket
op_assign
op_complement
id|Disabled
suffix:semicolon
r_if
c_cond
(paren
id|br_stats.flags
op_amp
id|BR_UP
)paren
(brace
id|enable_port
c_func
(paren
id|bcf.arg1
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|BRCMD_PORT_DISABLE
suffix:colon
r_if
c_cond
(paren
id|port_info
(braket
id|bcf.arg1
)braket
dot
id|dev
op_eq
l_int|0
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|user_port_state
(braket
id|bcf.arg1
)braket
op_eq
id|Disabled
)paren
r_return
op_minus
id|EALREADY
suffix:semicolon
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;br: disabling port %i&bslash;n&quot;
comma
id|bcf.arg1
)paren
suffix:semicolon
id|user_port_state
(braket
id|bcf.arg1
)braket
op_assign
id|Disabled
suffix:semicolon
r_if
c_cond
(paren
id|br_stats.flags
op_amp
id|BR_UP
)paren
(brace
id|disable_port
c_func
(paren
id|bcf.arg1
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|BRCMD_SET_BRIDGE_PRIORITY
suffix:colon
id|new_id
op_assign
id|bridge_info.bridge_id
suffix:semicolon
id|new_id.BRIDGE_PRIORITY
op_assign
id|htons
c_func
(paren
id|bcf.arg1
)paren
suffix:semicolon
id|set_bridge_priority
c_func
(paren
op_amp
id|new_id
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|BRCMD_SET_PORT_PRIORITY
suffix:colon
r_if
c_cond
(paren
(paren
id|port_info
(braket
id|bcf.arg1
)braket
dot
id|dev
op_eq
l_int|0
)paren
op_logical_or
(paren
id|bcf.arg2
op_amp
op_complement
l_int|0xff
)paren
)paren
(brace
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|port_priority
(braket
id|bcf.arg1
)braket
op_assign
id|bcf.arg2
suffix:semicolon
id|set_port_priority
c_func
(paren
id|bcf.arg1
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|BRCMD_SET_PATH_COST
suffix:colon
r_if
c_cond
(paren
id|port_info
(braket
id|bcf.arg1
)braket
dot
id|dev
op_eq
l_int|0
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|set_path_cost
c_func
(paren
id|bcf.arg1
comma
id|bcf.arg2
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|BRCMD_ENABLE_DEBUG
suffix:colon
id|br_stats.flags
op_or_assign
id|BR_DEBUG
suffix:semicolon
r_break
suffix:semicolon
r_case
id|BRCMD_DISABLE_DEBUG
suffix:colon
id|br_stats.flags
op_and_assign
op_complement
id|BR_DEBUG
suffix:semicolon
r_break
suffix:semicolon
r_case
id|BRCMD_SET_POLICY
suffix:colon
r_return
id|br_set_policy
c_func
(paren
id|bcf.arg1
)paren
suffix:semicolon
r_case
id|BRCMD_EXEMPT_PROTOCOL
suffix:colon
r_return
id|br_add_exempt_protocol
c_func
(paren
id|bcf.arg1
)paren
suffix:semicolon
r_case
id|BRCMD_ENABLE_PROT_STATS
suffix:colon
id|br_stats.flags
op_or_assign
id|BR_PROT_STATS
suffix:semicolon
r_break
suffix:semicolon
r_case
id|BRCMD_DISABLE_PROT_STATS
suffix:colon
id|br_stats.flags
op_and_assign
op_complement
id|BR_PROT_STATS
suffix:semicolon
r_break
suffix:semicolon
r_case
id|BRCMD_ZERO_PROT_STATS
suffix:colon
id|memset
c_func
(paren
op_amp
id|br_stats.prot_id
comma
l_int|0
comma
r_sizeof
(paren
id|br_stats.prot_id
)paren
)paren
suffix:semicolon
id|memset
c_func
(paren
op_amp
id|br_stats.prot_counter
comma
l_int|0
comma
r_sizeof
(paren
id|br_stats.prot_counter
)paren
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|BRCMD_DISPLAY_FDB
suffix:colon
(brace
r_struct
id|fdb_info_hdr
op_star
id|user_buf
op_assign
(paren
r_void
op_star
)paren
id|bcf.arg1
suffix:semicolon
r_struct
id|fdb_info
op_star
id|u_fdbs
comma
op_star
id|fdbis
suffix:semicolon
r_int
id|copied
comma
id|notcopied
suffix:semicolon
id|u32
id|j
op_assign
id|CURRENT_TIME
suffix:semicolon
r_if
c_cond
(paren
id|bcf.arg2
OL
r_sizeof
(paren
r_struct
id|fdb_info_hdr
)paren
)paren
(brace
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|put_user
c_func
(paren
id|j
comma
op_amp
id|user_buf-&gt;cmd_time
)paren
suffix:semicolon
r_if
c_cond
(paren
id|allocated_fdb_cnt
op_eq
l_int|0
)paren
(brace
id|put_user
c_func
(paren
l_int|0
comma
op_amp
id|user_buf-&gt;copied
)paren
suffix:semicolon
id|put_user
c_func
(paren
l_int|0
comma
op_amp
id|user_buf-&gt;not_copied
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|fdbis
op_assign
id|get_fdb_info
c_func
(paren
id|bcf.arg2
comma
op_amp
id|copied
comma
op_amp
id|notcopied
)paren
suffix:semicolon
id|put_user
c_func
(paren
id|copied
comma
op_amp
id|user_buf-&gt;copied
)paren
suffix:semicolon
id|put_user
c_func
(paren
id|notcopied
comma
op_amp
id|user_buf-&gt;not_copied
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|fdbis
)paren
(brace
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|u_fdbs
op_assign
(paren
r_struct
id|fdb_info
op_star
)paren
(paren
id|user_buf
op_plus
l_int|1
)paren
suffix:semicolon
id|err
op_assign
id|copy_to_user
c_func
(paren
id|u_fdbs
comma
id|fdbis
comma
id|copied
op_star
r_sizeof
(paren
r_struct
id|fdb_info
)paren
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|fdbis
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
(brace
id|err
op_assign
op_minus
id|EFAULT
suffix:semicolon
)brace
r_return
id|err
suffix:semicolon
)brace
r_default
suffix:colon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
r_default
suffix:colon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
multiline_comment|/*NOTREACHED*/
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|br_cmp
r_static
r_int
id|br_cmp
c_func
(paren
r_int
r_int
op_star
id|a
comma
r_int
r_int
op_star
id|b
)paren
(brace
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|2
suffix:semicolon
id|i
op_increment
)paren
(brace
multiline_comment|/* JRP: compares prty then MAC address in memory byte order&n;&t;&t; * OK optimizer does htonl() only once per long !&n;&t;&t; */
r_if
c_cond
(paren
id|htonl
c_func
(paren
id|a
(braket
id|i
)braket
)paren
OL
id|htonl
c_func
(paren
id|b
(braket
id|i
)braket
)paren
)paren
r_return
op_minus
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|htonl
c_func
(paren
id|a
(braket
id|i
)braket
)paren
OG
id|htonl
c_func
(paren
id|b
(braket
id|i
)braket
)paren
)paren
r_return
l_int|1
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
eof
