multiline_comment|/*&n; *&t;Linux NET3 Bridge Support&n; *&n; *&t;Originally by John Hayes (Network Plumbing).&n; *&t;Minor hacks to get it to run with 1.3.x by Alan Cox &lt;Alan.Cox@linux.org&gt;&n; *&t;More hacks to be able to switch protocols on and off by Christoph Lameter&n; *&t;&lt;clameter@debian.org&gt;&n; *&t;Software and more Documentation for the bridge is available from ftp.debian.org&n; *&t;in the bridge package or at ftp.fuller.edu/Linux/bridge&n; *&n; *&t;This program is free software; you can redistribute it and/or&n; *&t;modify it under the terms of the GNU General Public License&n; *&t;as published by the Free Software Foundation; either version&n; *&t;2 of the License, or (at your option) any later version.&n; *&n; *&t;Fixes:&n; *&t;&t;Yury Shevchuk&t;:&t;Bridge with non bridging ports&n; *&n; *&t;Todo:&n; *&t;&t;Don&squot;t bring up devices automatically. Start ports disabled&n; *&t;and use a netlink notifier so a daemon can maintain the bridge&n; *&t;port group (could we also do multiple groups ????).&n; *&t;&t;A nice /proc file interface.&n; *&t;&t;Put the path costs in the port info and devices.&n; *&t;&t;Put the bridge port number in the device structure for speed.&n; *&t;&t;Bridge SNMP stats.&n; *&t;&n; */
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/socket.h&gt;
macro_line|#include &lt;linux/in.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/timer.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/net.h&gt;
macro_line|#include &lt;linux/inet.h&gt;
macro_line|#include &lt;linux/netdevice.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/skbuff.h&gt;
macro_line|#include &lt;linux/if_arp.h&gt;
macro_line|#include &lt;asm/uaccess.h&gt;
macro_line|#include &lt;asm/system.h&gt;
macro_line|#include &lt;net/br.h&gt;
r_static
r_int
id|br_device_event
c_func
(paren
r_struct
id|notifier_block
op_star
id|dnot
comma
r_int
r_int
id|event
comma
r_void
op_star
id|ptr
)paren
suffix:semicolon
r_static
r_void
id|br_tick
c_func
(paren
r_int
r_int
id|arg
)paren
suffix:semicolon
r_int
id|br_forward
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_int
id|port
)paren
suffix:semicolon
multiline_comment|/* 3.7 */
r_int
id|br_port_cost
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
suffix:semicolon
multiline_comment|/* 4.10.2 */
r_void
id|br_bpdu
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
)paren
suffix:semicolon
multiline_comment|/* consumes skb */
r_int
id|br_tx_frame
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
)paren
suffix:semicolon
r_int
id|br_cmp
c_func
(paren
r_int
r_int
op_star
id|a
comma
r_int
r_int
op_star
id|b
)paren
suffix:semicolon
DECL|variable|bridge_ula
r_int
r_char
id|bridge_ula
(braket
id|ETH_ALEN
)braket
op_assign
(brace
l_int|0x01
comma
l_int|0x80
comma
l_int|0xc2
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
)brace
suffix:semicolon
DECL|variable|bridge_info
id|Bridge_data
id|bridge_info
suffix:semicolon
multiline_comment|/* (4.5.3)&t; */
DECL|variable|port_info
id|Port_data
id|port_info
(braket
id|All_ports
)braket
suffix:semicolon
multiline_comment|/* (4.5.5)&t; */
DECL|variable|config_bpdu
id|Config_bpdu
id|config_bpdu
(braket
id|All_ports
)braket
suffix:semicolon
DECL|variable|tcn_bpdu
id|Tcn_bpdu
id|tcn_bpdu
(braket
id|All_ports
)braket
suffix:semicolon
DECL|variable|hello_timer
id|Timer
id|hello_timer
suffix:semicolon
multiline_comment|/* (4.5.4.1)&t; */
DECL|variable|tcn_timer
id|Timer
id|tcn_timer
suffix:semicolon
multiline_comment|/* (4.5.4.2)&t; */
DECL|variable|topology_change_timer
id|Timer
id|topology_change_timer
suffix:semicolon
multiline_comment|/* (4.5.4.3)&t; */
DECL|variable|message_age_timer
id|Timer
id|message_age_timer
(braket
id|All_ports
)braket
suffix:semicolon
multiline_comment|/* (4.5.6.1)&t; */
DECL|variable|forward_delay_timer
id|Timer
id|forward_delay_timer
(braket
id|All_ports
)braket
suffix:semicolon
multiline_comment|/* (4.5.6.2)&t; */
DECL|variable|hold_timer
id|Timer
id|hold_timer
(braket
id|All_ports
)braket
suffix:semicolon
multiline_comment|/* (4.5.6.3)&t; */
multiline_comment|/* entries timeout after this many seconds */
DECL|variable|fdb_aging_time
r_int
r_int
id|fdb_aging_time
op_assign
id|FDB_TIMEOUT
suffix:semicolon
DECL|variable|br_stats
r_struct
id|br_stat
id|br_stats
suffix:semicolon
DECL|variable|tl
r_static
r_struct
id|timer_list
id|tl
suffix:semicolon
multiline_comment|/* for 1 second timer... */
multiline_comment|/*&n; * the following structure is required so that we receive&n; * event notifications when network devices are enabled and&n; * disabled (ifconfig up and down).&n; */
DECL|variable|br_dev_notifier
r_static
r_struct
id|notifier_block
id|br_dev_notifier
op_assign
initialization_block
suffix:semicolon
multiline_comment|/*&n; * Implementation of Protocol specific bridging&n; *&n; * The protocols to be bridged or not to be bridged are stored in a hashed array. This is the old type&n; * of unlinked hash array where one simply takes the next cell if the one the hash function points to&n; * is occupied.&n; */
DECL|macro|BR_PROTOCOL_HASH
mdefine_line|#define BR_PROTOCOL_HASH(x) (x % BR_MAX_PROTOCOLS)
multiline_comment|/* Checks if that protocol type is to be bridged */
DECL|function|br_protocol_ok
r_int
id|br_protocol_ok
c_func
(paren
r_int
r_int
id|protocol
)paren
(brace
r_int
id|x
suffix:semicolon
multiline_comment|/* See if protocol statistics are to be kept */
r_if
c_cond
(paren
id|br_stats.flags
op_amp
id|BR_PROT_STATS
)paren
(brace
r_for
c_loop
(paren
id|x
op_assign
l_int|0
suffix:semicolon
id|x
OL
id|BR_MAX_PROT_STATS
op_logical_and
id|br_stats.prot_id
(braket
id|x
)braket
op_ne
id|protocol
op_logical_and
id|br_stats.prot_id
(braket
id|x
)braket
suffix:semicolon
id|x
op_increment
)paren
(brace
suffix:semicolon
)brace
r_if
c_cond
(paren
id|x
OL
id|BR_MAX_PROT_STATS
)paren
(brace
id|br_stats.prot_id
(braket
id|x
)braket
op_assign
id|protocol
suffix:semicolon
id|br_stats.prot_counter
(braket
id|x
)braket
op_increment
suffix:semicolon
)brace
)brace
r_for
c_loop
(paren
id|x
op_assign
id|BR_PROTOCOL_HASH
c_func
(paren
id|protocol
)paren
suffix:semicolon
id|br_stats.protocols
(braket
id|x
)braket
op_ne
l_int|0
suffix:semicolon
)paren
(brace
r_if
c_cond
(paren
id|br_stats.protocols
(braket
id|x
)braket
op_eq
id|protocol
)paren
r_return
op_logical_neg
id|br_stats.policy
suffix:semicolon
id|x
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|x
op_eq
id|BR_MAX_PROTOCOLS
)paren
id|x
op_assign
l_int|0
suffix:semicolon
)brace
r_return
id|br_stats.policy
suffix:semicolon
)brace
multiline_comment|/* Add a protocol to be handled opposite to the standard policy of the bridge */
DECL|function|br_add_exempt_protocol
r_int
id|br_add_exempt_protocol
c_func
(paren
r_int
r_int
id|p
)paren
(brace
r_int
id|x
suffix:semicolon
r_if
c_cond
(paren
id|p
op_eq
l_int|0
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|br_stats.exempt_protocols
OG
id|BR_MAX_PROTOCOLS
op_minus
l_int|2
)paren
r_return
op_minus
id|EXFULL
suffix:semicolon
r_for
c_loop
(paren
id|x
op_assign
id|BR_PROTOCOL_HASH
c_func
(paren
id|p
)paren
suffix:semicolon
id|br_stats.protocols
(braket
id|x
)braket
op_ne
l_int|0
suffix:semicolon
)paren
(brace
r_if
c_cond
(paren
id|br_stats.protocols
(braket
id|x
)braket
op_eq
id|p
)paren
r_return
l_int|0
suffix:semicolon
multiline_comment|/* Attempt to add the protocol a second time */
id|x
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|x
op_eq
id|BR_MAX_PROTOCOLS
)paren
id|x
op_assign
l_int|0
suffix:semicolon
)brace
id|br_stats.protocols
(braket
id|x
)braket
op_assign
id|p
suffix:semicolon
id|br_stats.exempt_protocols
op_increment
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Valid Policies are 0=No Protocols bridged 1=Bridge all protocols */
DECL|function|br_set_policy
r_int
id|br_set_policy
c_func
(paren
r_int
id|policy
)paren
(brace
r_if
c_cond
(paren
id|policy
OG
l_int|1
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|br_stats.policy
op_assign
id|policy
suffix:semicolon
multiline_comment|/* Policy change means initializing the exempt table */
id|memset
c_func
(paren
id|br_stats.protocols
comma
l_int|0
comma
r_sizeof
(paren
id|br_stats.protocols
)paren
)paren
suffix:semicolon
id|br_stats.exempt_protocols
op_assign
l_int|0
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/** Elements of Procedure (4.6) **/
multiline_comment|/*&n; * this section of code was graciously borrowed from the IEEE 802.1d&n; * specification section 4.9.1 starting on pg 69.  It has been&n; * modified somewhat to fit within out framework and structure.  It&n; * implements the spanning tree algorithm that is the heart of the&n; * 802.1d bridging protocol.&n; */
DECL|function|transmit_config
r_void
id|transmit_config
c_func
(paren
r_int
id|port_no
)paren
multiline_comment|/* (4.6.1)&t; */
(brace
r_if
c_cond
(paren
id|hold_timer
(braket
id|port_no
)braket
dot
id|active
)paren
(brace
multiline_comment|/* (4.6.1.3.1)&t; */
id|port_info
(braket
id|port_no
)braket
dot
id|config_pending
op_assign
id|TRUE
suffix:semicolon
multiline_comment|/* (4.6.1.3.1)&t; */
)brace
r_else
(brace
multiline_comment|/* (4.6.1.3.2)&t; */
id|config_bpdu
(braket
id|port_no
)braket
dot
id|type
op_assign
id|BPDU_TYPE_CONFIG
suffix:semicolon
id|config_bpdu
(braket
id|port_no
)braket
dot
id|root_id
op_assign
id|bridge_info.designated_root
suffix:semicolon
multiline_comment|/* (4.6.1.3.2(1)) */
id|config_bpdu
(braket
id|port_no
)braket
dot
id|root_path_cost
op_assign
id|bridge_info.root_path_cost
suffix:semicolon
multiline_comment|/* (4.6.1.3.2(2)) */
id|config_bpdu
(braket
id|port_no
)braket
dot
id|bridge_id
op_assign
id|bridge_info.bridge_id
suffix:semicolon
multiline_comment|/* (4.6.1.3.2(3)) */
id|config_bpdu
(braket
id|port_no
)braket
dot
id|port_id
op_assign
id|port_info
(braket
id|port_no
)braket
dot
id|port_id
suffix:semicolon
multiline_comment|/*&n;&t;&t; * (4.6.1.3.2(4))&n;&t;&t; */
r_if
c_cond
(paren
id|root_bridge
c_func
(paren
)paren
)paren
(brace
id|config_bpdu
(braket
id|port_no
)braket
dot
id|message_age
op_assign
id|Zero
suffix:semicolon
multiline_comment|/* (4.6.1.3.2(5)) */
)brace
r_else
(brace
id|config_bpdu
(braket
id|port_no
)braket
dot
id|message_age
op_assign
id|message_age_timer
(braket
id|bridge_info.root_port
)braket
dot
id|value
op_plus
id|Message_age_increment
suffix:semicolon
multiline_comment|/* (4.6.1.3.2(6)) */
)brace
id|config_bpdu
(braket
id|port_no
)braket
dot
id|max_age
op_assign
id|bridge_info.max_age
suffix:semicolon
multiline_comment|/* (4.6.1.3.2(7)) */
id|config_bpdu
(braket
id|port_no
)braket
dot
id|hello_time
op_assign
id|bridge_info.hello_time
suffix:semicolon
id|config_bpdu
(braket
id|port_no
)braket
dot
id|forward_delay
op_assign
id|bridge_info.forward_delay
suffix:semicolon
id|config_bpdu
(braket
id|port_no
)braket
dot
id|flags
op_assign
l_int|0
suffix:semicolon
id|config_bpdu
(braket
id|port_no
)braket
dot
id|flags
op_or_assign
id|port_info
(braket
id|port_no
)braket
dot
id|top_change_ack
ques
c_cond
id|TOPOLOGY_CHANGE_ACK
suffix:colon
l_int|0
suffix:semicolon
multiline_comment|/* (4.6.1.3.2(8)) */
id|port_info
(braket
id|port_no
)braket
dot
id|top_change_ack
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* (4.6.1.3.2(8)) */
id|config_bpdu
(braket
id|port_no
)braket
dot
id|flags
op_or_assign
id|bridge_info.top_change
ques
c_cond
id|TOPOLOGY_CHANGE
suffix:colon
l_int|0
suffix:semicolon
multiline_comment|/* (4.6.1.3.2(9)) */
id|send_config_bpdu
c_func
(paren
id|port_no
comma
op_amp
id|config_bpdu
(braket
id|port_no
)braket
)paren
suffix:semicolon
id|port_info
(braket
id|port_no
)braket
dot
id|config_pending
op_assign
id|FALSE
suffix:semicolon
multiline_comment|/* (4.6.1.3.2(10)) */
id|start_hold_timer
c_func
(paren
id|port_no
)paren
suffix:semicolon
multiline_comment|/* (4.6.1.3.2(11)) */
)brace
)brace
DECL|function|root_bridge
r_int
id|root_bridge
c_func
(paren
r_void
)paren
(brace
r_return
(paren
id|br_cmp
c_func
(paren
id|bridge_info.designated_root.BRIDGE_ID
comma
id|bridge_info.bridge_id.BRIDGE_ID
)paren
ques
c_cond
id|FALSE
suffix:colon
id|TRUE
)paren
suffix:semicolon
)brace
DECL|function|supersedes_port_info
r_int
id|supersedes_port_info
c_func
(paren
r_int
id|port_no
comma
id|Config_bpdu
op_star
id|config
)paren
multiline_comment|/* (4.6.2.2)&t; */
(brace
r_return
(paren
(paren
id|br_cmp
c_func
(paren
id|config-&gt;root_id.BRIDGE_ID
comma
id|port_info
(braket
id|port_no
)braket
dot
id|designated_root.BRIDGE_ID
)paren
OL
l_int|0
)paren
multiline_comment|/* (4.6.2.2.1)&t; */
op_logical_or
(paren
(paren
id|br_cmp
c_func
(paren
id|config-&gt;root_id.BRIDGE_ID
comma
id|port_info
(braket
id|port_no
)braket
dot
id|designated_root.BRIDGE_ID
)paren
op_eq
l_int|0
)paren
op_logical_and
(paren
(paren
id|config-&gt;root_path_cost
OL
id|port_info
(braket
id|port_no
)braket
dot
id|designated_cost
multiline_comment|/* (4.6.2.2.2)&t; */
)paren
op_logical_or
(paren
(paren
id|config-&gt;root_path_cost
op_eq
id|port_info
(braket
id|port_no
)braket
dot
id|designated_cost
)paren
op_logical_and
(paren
(paren
id|br_cmp
c_func
(paren
id|config-&gt;bridge_id.BRIDGE_ID
comma
id|port_info
(braket
id|port_no
)braket
dot
id|designated_bridge.BRIDGE_ID
)paren
OL
l_int|0
multiline_comment|/* (4.6.2.2.3)    */
)paren
op_logical_or
(paren
(paren
id|br_cmp
c_func
(paren
id|config-&gt;bridge_id.BRIDGE_ID
comma
id|port_info
(braket
id|port_no
)braket
dot
id|designated_bridge.BRIDGE_ID
)paren
op_eq
l_int|0
)paren
multiline_comment|/* (4.6.2.2.4)&t; */
op_logical_and
(paren
(paren
id|br_cmp
c_func
(paren
id|config-&gt;bridge_id.BRIDGE_ID
comma
id|bridge_info.bridge_id.BRIDGE_ID
)paren
op_ne
l_int|0
)paren
multiline_comment|/* (4.6.2.2.4(1)) */
op_logical_or
(paren
id|config-&gt;port_id
op_le
id|port_info
(braket
id|port_no
)braket
dot
id|designated_port
)paren
multiline_comment|/* (4.6.2.2.4(2)) */
)paren
)paren
)paren
)paren
)paren
)paren
)paren
suffix:semicolon
)brace
DECL|function|record_config_information
r_void
id|record_config_information
c_func
(paren
r_int
id|port_no
comma
id|Config_bpdu
op_star
id|config
)paren
multiline_comment|/* (4.6.2)&t; */
(brace
id|port_info
(braket
id|port_no
)braket
dot
id|designated_root
op_assign
id|config-&gt;root_id
suffix:semicolon
multiline_comment|/* (4.6.2.3.1)   */
id|port_info
(braket
id|port_no
)braket
dot
id|designated_cost
op_assign
id|config-&gt;root_path_cost
suffix:semicolon
id|port_info
(braket
id|port_no
)braket
dot
id|designated_bridge
op_assign
id|config-&gt;bridge_id
suffix:semicolon
id|port_info
(braket
id|port_no
)braket
dot
id|designated_port
op_assign
id|config-&gt;port_id
suffix:semicolon
id|start_message_age_timer
c_func
(paren
id|port_no
comma
id|config-&gt;message_age
)paren
suffix:semicolon
multiline_comment|/* (4.6.2.3.2)   */
)brace
DECL|function|record_config_timeout_values
r_void
id|record_config_timeout_values
c_func
(paren
id|Config_bpdu
op_star
id|config
)paren
multiline_comment|/* (4.6.3)&t; */
(brace
id|bridge_info.max_age
op_assign
id|config-&gt;max_age
suffix:semicolon
multiline_comment|/* (4.6.3.3)&t; */
id|bridge_info.hello_time
op_assign
id|config-&gt;hello_time
suffix:semicolon
id|bridge_info.forward_delay
op_assign
id|config-&gt;forward_delay
suffix:semicolon
r_if
c_cond
(paren
id|config-&gt;flags
op_amp
id|TOPOLOGY_CHANGE
)paren
id|bridge_info.top_change
op_assign
l_int|1
suffix:semicolon
)brace
DECL|function|config_bpdu_generation
r_void
id|config_bpdu_generation
c_func
(paren
r_void
)paren
(brace
multiline_comment|/* (4.6.4)&t; */
r_int
id|port_no
suffix:semicolon
r_for
c_loop
(paren
id|port_no
op_assign
id|One
suffix:semicolon
id|port_no
op_le
id|No_of_ports
suffix:semicolon
id|port_no
op_increment
)paren
(brace
multiline_comment|/* (4.6.4.3) */
r_if
c_cond
(paren
id|designated_port
c_func
(paren
id|port_no
)paren
multiline_comment|/* (4.6.4.3)&t; */
op_logical_and
(paren
id|port_info
(braket
id|port_no
)braket
dot
id|state
op_ne
id|Disabled
)paren
)paren
(brace
id|transmit_config
c_func
(paren
id|port_no
)paren
suffix:semicolon
multiline_comment|/* (4.6.4.3)&t; */
)brace
multiline_comment|/* (4.6.1.2)&t; */
)brace
)brace
DECL|function|designated_port
r_int
id|designated_port
c_func
(paren
r_int
id|port_no
)paren
(brace
r_return
(paren
(paren
id|br_cmp
c_func
(paren
id|port_info
(braket
id|port_no
)braket
dot
id|designated_bridge.BRIDGE_ID
comma
id|bridge_info.bridge_id.BRIDGE_ID
)paren
op_eq
l_int|0
)paren
op_logical_and
(paren
id|port_info
(braket
id|port_no
)braket
dot
id|designated_port
op_eq
id|port_info
(braket
id|port_no
)braket
dot
id|port_id
)paren
)paren
suffix:semicolon
)brace
DECL|function|reply
r_void
id|reply
c_func
(paren
r_int
id|port_no
)paren
multiline_comment|/* (4.6.5)&t; */
(brace
id|transmit_config
c_func
(paren
id|port_no
)paren
suffix:semicolon
multiline_comment|/* (4.6.5.3)&t; */
)brace
DECL|function|transmit_tcn
r_void
id|transmit_tcn
c_func
(paren
r_void
)paren
(brace
multiline_comment|/* (4.6.6)&t; */
r_int
id|port_no
suffix:semicolon
id|port_no
op_assign
id|bridge_info.root_port
suffix:semicolon
id|tcn_bpdu
(braket
id|port_no
)braket
dot
id|type
op_assign
id|BPDU_TYPE_TOPO_CHANGE
suffix:semicolon
id|send_tcn_bpdu
c_func
(paren
id|port_no
comma
op_amp
id|tcn_bpdu
(braket
id|bridge_info.root_port
)braket
)paren
suffix:semicolon
multiline_comment|/* (4.6.6.3)     */
)brace
DECL|function|configuration_update
r_void
id|configuration_update
c_func
(paren
r_void
)paren
multiline_comment|/* (4.6.7) */
(brace
id|root_selection
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* (4.6.7.3.1)&t; */
multiline_comment|/* (4.6.8.2)&t; */
id|designated_port_selection
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* (4.6.7.3.2)&t; */
multiline_comment|/* (4.6.9.2)&t; */
)brace
DECL|function|root_selection
r_void
id|root_selection
c_func
(paren
r_void
)paren
(brace
multiline_comment|/* (4.6.8) */
r_int
id|root_port
suffix:semicolon
r_int
id|port_no
suffix:semicolon
id|root_port
op_assign
id|No_port
suffix:semicolon
r_for
c_loop
(paren
id|port_no
op_assign
id|One
suffix:semicolon
id|port_no
op_le
id|No_of_ports
suffix:semicolon
id|port_no
op_increment
)paren
(brace
multiline_comment|/* (4.6.8.3.1) */
r_if
c_cond
(paren
(paren
(paren
op_logical_neg
id|designated_port
c_func
(paren
id|port_no
)paren
)paren
op_logical_and
(paren
id|port_info
(braket
id|port_no
)braket
dot
id|state
op_ne
id|Disabled
)paren
op_logical_and
(paren
id|br_cmp
c_func
(paren
id|port_info
(braket
id|port_no
)braket
dot
id|designated_root.BRIDGE_ID
comma
id|bridge_info.bridge_id.BRIDGE_ID
)paren
OL
l_int|0
)paren
)paren
op_logical_and
(paren
(paren
id|root_port
op_eq
id|No_port
)paren
op_logical_or
(paren
id|br_cmp
c_func
(paren
id|port_info
(braket
id|port_no
)braket
dot
id|designated_root.BRIDGE_ID
comma
id|port_info
(braket
id|root_port
)braket
dot
id|designated_root.BRIDGE_ID
)paren
OL
l_int|0
)paren
op_logical_or
(paren
(paren
id|br_cmp
c_func
(paren
id|port_info
(braket
id|port_no
)braket
dot
id|designated_root.BRIDGE_ID
comma
id|port_info
(braket
id|root_port
)braket
dot
id|designated_root.BRIDGE_ID
)paren
op_eq
l_int|0
)paren
op_logical_and
(paren
(paren
(paren
id|port_info
(braket
id|port_no
)braket
dot
id|designated_cost
op_plus
id|port_info
(braket
id|port_no
)braket
dot
id|path_cost
)paren
OL
(paren
id|port_info
(braket
id|root_port
)braket
dot
id|designated_cost
op_plus
id|port_info
(braket
id|root_port
)braket
dot
id|path_cost
)paren
multiline_comment|/* (4.6.8.3.1(2)) */
)paren
op_logical_or
(paren
(paren
(paren
id|port_info
(braket
id|port_no
)braket
dot
id|designated_cost
op_plus
id|port_info
(braket
id|port_no
)braket
dot
id|path_cost
)paren
op_eq
(paren
id|port_info
(braket
id|root_port
)braket
dot
id|designated_cost
op_plus
id|port_info
(braket
id|root_port
)braket
dot
id|path_cost
)paren
)paren
op_logical_and
(paren
(paren
id|br_cmp
c_func
(paren
id|port_info
(braket
id|port_no
)braket
dot
id|designated_bridge.BRIDGE_ID
comma
id|port_info
(braket
id|root_port
)braket
dot
id|designated_bridge.BRIDGE_ID
)paren
OL
l_int|0
)paren
multiline_comment|/* (4.6.8.3.1(3)) */
op_logical_or
(paren
(paren
id|br_cmp
c_func
(paren
id|port_info
(braket
id|port_no
)braket
dot
id|designated_bridge.BRIDGE_ID
comma
id|port_info
(braket
id|root_port
)braket
dot
id|designated_bridge.BRIDGE_ID
)paren
op_eq
l_int|0
)paren
op_logical_and
(paren
(paren
id|port_info
(braket
id|port_no
)braket
dot
id|designated_port
OL
id|port_info
(braket
id|root_port
)braket
dot
id|designated_port
)paren
multiline_comment|/* (4.6.8.3.1(4)) */
op_logical_or
(paren
(paren
id|port_info
(braket
id|port_no
)braket
dot
id|designated_port
op_assign
id|port_info
(braket
id|root_port
)braket
dot
id|designated_port
)paren
op_logical_and
(paren
id|port_info
(braket
id|port_no
)braket
dot
id|port_id
OL
id|port_info
(braket
id|root_port
)braket
dot
id|port_id
)paren
multiline_comment|/* (4.6.8.3.1(5)) */
)paren
)paren
)paren
)paren
)paren
)paren
)paren
)paren
)paren
(brace
id|root_port
op_assign
id|port_no
suffix:semicolon
)brace
)brace
id|bridge_info.root_port
op_assign
id|root_port
suffix:semicolon
multiline_comment|/* (4.6.8.3.1)&t; */
r_if
c_cond
(paren
id|root_port
op_eq
id|No_port
)paren
(brace
multiline_comment|/* (4.6.8.3.2)&t; */
id|bridge_info.designated_root
op_assign
id|bridge_info.bridge_id
suffix:semicolon
multiline_comment|/* (4.6.8.3.2(1)) */
id|bridge_info.root_path_cost
op_assign
id|Zero
suffix:semicolon
multiline_comment|/* (4.6.8.3.2(2)) */
)brace
r_else
(brace
multiline_comment|/* (4.6.8.3.3)&t; */
id|bridge_info.designated_root
op_assign
id|port_info
(braket
id|root_port
)braket
dot
id|designated_root
suffix:semicolon
multiline_comment|/* (4.6.8.3.3(1)) */
id|bridge_info.root_path_cost
op_assign
(paren
id|port_info
(braket
id|root_port
)braket
dot
id|designated_cost
op_plus
id|port_info
(braket
id|root_port
)braket
dot
id|path_cost
)paren
suffix:semicolon
multiline_comment|/* (4.6.8.3.3(2)) */
)brace
)brace
DECL|function|designated_port_selection
r_void
id|designated_port_selection
c_func
(paren
r_void
)paren
(brace
multiline_comment|/* (4.6.9)&t; */
r_int
id|port_no
suffix:semicolon
r_for
c_loop
(paren
id|port_no
op_assign
id|One
suffix:semicolon
id|port_no
op_le
id|No_of_ports
suffix:semicolon
id|port_no
op_increment
)paren
(brace
multiline_comment|/* (4.6.9.3)&t; */
r_if
c_cond
(paren
id|designated_port
c_func
(paren
id|port_no
)paren
multiline_comment|/* (4.6.9.3.1)&t; */
op_logical_or
(paren
id|br_cmp
c_func
(paren
id|port_info
(braket
id|port_no
)braket
dot
id|designated_root.BRIDGE_ID
comma
id|bridge_info.designated_root.BRIDGE_ID
)paren
op_ne
l_int|0
)paren
op_logical_or
(paren
id|bridge_info.root_path_cost
OL
id|port_info
(braket
id|port_no
)braket
dot
id|designated_cost
)paren
multiline_comment|/* (4.6.9.3.3)&t; */
op_logical_or
(paren
(paren
id|bridge_info.root_path_cost
op_eq
id|port_info
(braket
id|port_no
)braket
dot
id|designated_cost
)paren
op_logical_and
(paren
(paren
id|br_cmp
c_func
(paren
id|bridge_info.bridge_id.BRIDGE_ID
comma
id|port_info
(braket
id|port_no
)braket
dot
id|designated_bridge.BRIDGE_ID
)paren
OL
l_int|0
)paren
multiline_comment|/* (4.6.9.3.4)&t; */
op_logical_or
(paren
(paren
id|br_cmp
c_func
(paren
id|bridge_info.bridge_id.BRIDGE_ID
comma
id|port_info
(braket
id|port_no
)braket
dot
id|designated_bridge.BRIDGE_ID
)paren
op_eq
l_int|0
)paren
op_logical_and
(paren
id|port_info
(braket
id|port_no
)braket
dot
id|port_id
op_le
id|port_info
(braket
id|port_no
)braket
dot
id|designated_port
)paren
multiline_comment|/* (4.6.9.3.5)&t; */
)paren
)paren
)paren
)paren
(brace
id|become_designated_port
c_func
(paren
id|port_no
)paren
suffix:semicolon
multiline_comment|/* (4.6.10.3.2.2) */
)brace
)brace
)brace
DECL|function|become_designated_port
r_void
id|become_designated_port
c_func
(paren
r_int
id|port_no
)paren
(brace
multiline_comment|/* (4.6.10)&t; */
multiline_comment|/* (4.6.10.3.1) */
id|port_info
(braket
id|port_no
)braket
dot
id|designated_root
op_assign
id|bridge_info.designated_root
suffix:semicolon
multiline_comment|/* (4.6.10.3.2) */
id|port_info
(braket
id|port_no
)braket
dot
id|designated_cost
op_assign
id|bridge_info.root_path_cost
suffix:semicolon
multiline_comment|/* (4.6.10.3.3) */
id|port_info
(braket
id|port_no
)braket
dot
id|designated_bridge
op_assign
id|bridge_info.bridge_id
suffix:semicolon
multiline_comment|/* (4.6.10.3.4) */
id|port_info
(braket
id|port_no
)braket
dot
id|designated_port
op_assign
id|port_info
(braket
id|port_no
)braket
dot
id|port_id
suffix:semicolon
)brace
DECL|function|port_state_selection
r_void
id|port_state_selection
c_func
(paren
r_void
)paren
(brace
multiline_comment|/* (4.6.11) */
r_int
id|port_no
suffix:semicolon
r_for
c_loop
(paren
id|port_no
op_assign
id|One
suffix:semicolon
id|port_no
op_le
id|No_of_ports
suffix:semicolon
id|port_no
op_increment
)paren
(brace
r_if
c_cond
(paren
id|port_no
op_eq
id|bridge_info.root_port
)paren
(brace
multiline_comment|/* (4.6.11.3.1) */
id|port_info
(braket
id|port_no
)braket
dot
id|config_pending
op_assign
id|FALSE
suffix:semicolon
multiline_comment|/* (4.6.11.3~1(1)) */
id|port_info
(braket
id|port_no
)braket
dot
id|top_change_ack
op_assign
l_int|0
suffix:semicolon
id|make_forwarding
c_func
(paren
id|port_no
)paren
suffix:semicolon
multiline_comment|/* (4.6.11.3.1(2)) */
)brace
r_else
r_if
c_cond
(paren
id|designated_port
c_func
(paren
id|port_no
)paren
)paren
(brace
multiline_comment|/* (4.6.11.3.2) */
id|stop_message_age_timer
c_func
(paren
id|port_no
)paren
suffix:semicolon
multiline_comment|/* (4.6.11.3.2(1)) */
id|make_forwarding
c_func
(paren
id|port_no
)paren
suffix:semicolon
multiline_comment|/* (4.6.11.3.2(2)) */
)brace
r_else
(brace
multiline_comment|/* (4.6.11.3.3) */
id|port_info
(braket
id|port_no
)braket
dot
id|config_pending
op_assign
id|FALSE
suffix:semicolon
multiline_comment|/* (4.6.11.3.3(1)) */
id|port_info
(braket
id|port_no
)braket
dot
id|top_change_ack
op_assign
l_int|0
suffix:semicolon
id|make_blocking
c_func
(paren
id|port_no
)paren
suffix:semicolon
multiline_comment|/* (4.6.11.3.3(2)) */
)brace
)brace
)brace
DECL|function|make_forwarding
r_void
id|make_forwarding
c_func
(paren
r_int
id|port_no
)paren
(brace
multiline_comment|/* (4.6.12) */
r_if
c_cond
(paren
id|port_info
(braket
id|port_no
)braket
dot
id|state
op_eq
id|Blocking
)paren
(brace
multiline_comment|/* (4.6.12.3) */
id|set_port_state
c_func
(paren
id|port_no
comma
id|Listening
)paren
suffix:semicolon
multiline_comment|/* (4.6.12.3.1) */
id|start_forward_delay_timer
c_func
(paren
id|port_no
)paren
suffix:semicolon
multiline_comment|/* (4.6.12.3.2) */
)brace
)brace
DECL|function|topology_change_detection
r_void
id|topology_change_detection
c_func
(paren
r_void
)paren
(brace
multiline_comment|/* (4.6.14)       */
r_if
c_cond
(paren
id|root_bridge
c_func
(paren
)paren
)paren
(brace
multiline_comment|/* (4.6.14.3.1)   */
id|bridge_info.top_change
op_assign
l_int|1
suffix:semicolon
id|start_topology_change_timer
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* (4.6.14.3.1(2)) */
)brace
r_else
r_if
c_cond
(paren
op_logical_neg
(paren
id|bridge_info.top_change_detected
)paren
)paren
(brace
id|transmit_tcn
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* (4.6.14.3.2(1)) */
id|start_tcn_timer
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* (4.6.14.3.2(2)) */
)brace
id|bridge_info.top_change
op_assign
l_int|1
suffix:semicolon
)brace
DECL|function|topology_change_acknowledged
r_void
id|topology_change_acknowledged
c_func
(paren
r_void
)paren
(brace
multiline_comment|/* (4.6.15) */
id|bridge_info.top_change_detected
op_assign
l_int|0
suffix:semicolon
id|stop_tcn_timer
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* (4.6.15.3.2) */
)brace
DECL|function|acknowledge_topology_change
r_void
id|acknowledge_topology_change
c_func
(paren
r_int
id|port_no
)paren
(brace
multiline_comment|/* (4.6.16) */
id|port_info
(braket
id|port_no
)braket
dot
id|top_change_ack
op_assign
l_int|1
suffix:semicolon
id|transmit_config
c_func
(paren
id|port_no
)paren
suffix:semicolon
multiline_comment|/* (4.6.16.3.2) */
)brace
DECL|function|make_blocking
r_void
id|make_blocking
c_func
(paren
r_int
id|port_no
)paren
multiline_comment|/* (4.6.13)&t; */
(brace
r_if
c_cond
(paren
(paren
id|port_info
(braket
id|port_no
)braket
dot
id|state
op_ne
id|Disabled
)paren
op_logical_and
(paren
id|port_info
(braket
id|port_no
)braket
dot
id|state
op_ne
id|Blocking
)paren
multiline_comment|/* (4.6.13.3)&t; */
)paren
(brace
r_if
c_cond
(paren
(paren
id|port_info
(braket
id|port_no
)braket
dot
id|state
op_eq
id|Forwarding
)paren
op_logical_or
(paren
id|port_info
(braket
id|port_no
)braket
dot
id|state
op_eq
id|Learning
)paren
)paren
(brace
id|topology_change_detection
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* (4.6.13.3.1) */
multiline_comment|/* (4.6.14.2.3)&t; */
)brace
id|set_port_state
c_func
(paren
id|port_no
comma
id|Blocking
)paren
suffix:semicolon
multiline_comment|/* (4.6.13.3.2) */
id|stop_forward_delay_timer
c_func
(paren
id|port_no
)paren
suffix:semicolon
multiline_comment|/* (4.6.13.3.3) */
)brace
)brace
DECL|function|set_port_state
r_void
id|set_port_state
c_func
(paren
r_int
id|port_no
comma
r_int
id|state
)paren
(brace
id|port_info
(braket
id|port_no
)braket
dot
id|state
op_assign
id|state
suffix:semicolon
)brace
DECL|function|received_config_bpdu
r_void
id|received_config_bpdu
c_func
(paren
r_int
id|port_no
comma
id|Config_bpdu
op_star
id|config
)paren
multiline_comment|/* (4.7.1)&t; */
(brace
r_int
id|root
suffix:semicolon
id|root
op_assign
id|root_bridge
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|port_info
(braket
id|port_no
)braket
dot
id|state
op_ne
id|Disabled
)paren
(brace
r_if
c_cond
(paren
id|supersedes_port_info
c_func
(paren
id|port_no
comma
id|config
)paren
)paren
(brace
multiline_comment|/* (4.7.1.1)&t; */
multiline_comment|/* (4.&n;&t;&t;&t;&t;&t;&t;&t;&t; * 6.2.2)&t; */
id|record_config_information
c_func
(paren
id|port_no
comma
id|config
)paren
suffix:semicolon
multiline_comment|/* (4.7.1.1.1)&t; */
multiline_comment|/* (4.6.2.2)&t; */
id|configuration_update
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* (4.7.1.1.2)&t; */
multiline_comment|/* (4.6.7.2.1)&t; */
id|port_state_selection
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* (4.7.1.1.3)&t; */
multiline_comment|/* (4.6.11.2.1)&t; */
r_if
c_cond
(paren
(paren
op_logical_neg
id|root_bridge
c_func
(paren
)paren
)paren
op_logical_and
id|root
)paren
(brace
multiline_comment|/* (4.7.1.1.4)&t; */
id|stop_hello_timer
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|bridge_info.top_change_detected
)paren
(brace
multiline_comment|/* (4.7.1.1.5~ */
id|stop_topology_change_timer
c_func
(paren
)paren
suffix:semicolon
id|transmit_tcn
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* (4.6.6.1)&t; */
id|start_tcn_timer
c_func
(paren
)paren
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|port_no
op_eq
id|bridge_info.root_port
)paren
(brace
id|record_config_timeout_values
c_func
(paren
id|config
)paren
suffix:semicolon
multiline_comment|/* (4.7.1.1.6)&t; */
multiline_comment|/* (4.6.3.2)&t; */
id|config_bpdu_generation
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* (4.6.4.2.1)&t; */
r_if
c_cond
(paren
id|config-&gt;flags
op_amp
id|TOPOLOGY_CHANGE_ACK
)paren
(brace
multiline_comment|/* (4.7.1.1.7)    */
id|topology_change_acknowledged
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* (4.6.15.2)&t; */
)brace
)brace
)brace
r_else
r_if
c_cond
(paren
id|designated_port
c_func
(paren
id|port_no
)paren
)paren
(brace
multiline_comment|/* (4.7.1.2)&t; */
id|reply
c_func
(paren
id|port_no
)paren
suffix:semicolon
multiline_comment|/* (4.7.1.2.1)&t; */
multiline_comment|/* (4.6.5.2)&t; */
)brace
)brace
)brace
DECL|function|received_tcn_bpdu
r_void
id|received_tcn_bpdu
c_func
(paren
r_int
id|port_no
comma
id|Tcn_bpdu
op_star
id|tcn
)paren
multiline_comment|/* (4.7.2)&t; */
(brace
r_if
c_cond
(paren
id|port_info
(braket
id|port_no
)braket
dot
id|state
op_ne
id|Disabled
)paren
(brace
r_if
c_cond
(paren
id|designated_port
c_func
(paren
id|port_no
)paren
)paren
(brace
id|topology_change_detection
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* (4.7.2.1)&t; */
multiline_comment|/* (4.6.14.2.1)&t; */
id|acknowledge_topology_change
c_func
(paren
id|port_no
)paren
suffix:semicolon
multiline_comment|/* (4.7.2.2)&t; */
)brace
multiline_comment|/* (4.6.16.2)&t; */
)brace
)brace
DECL|function|hello_timer_expiry
r_void
id|hello_timer_expiry
c_func
(paren
r_void
)paren
(brace
multiline_comment|/* (4.7.3)&t; */
id|config_bpdu_generation
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* (4.6.4.2.2)&t; */
id|start_hello_timer
c_func
(paren
)paren
suffix:semicolon
)brace
DECL|function|message_age_timer_expiry
r_void
id|message_age_timer_expiry
c_func
(paren
r_int
id|port_no
)paren
multiline_comment|/* (4.7.4)&t; */
(brace
r_int
id|root
suffix:semicolon
id|root
op_assign
id|root_bridge
c_func
(paren
)paren
suffix:semicolon
id|become_designated_port
c_func
(paren
id|port_no
)paren
suffix:semicolon
multiline_comment|/* (4.7.4.1)&t; */
multiline_comment|/* (4.6.10.2.1)&t; */
id|configuration_update
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* (4.7.4.2)&t; */
multiline_comment|/* (4.6.7.2.2)&t; */
id|port_state_selection
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* (4.7.4.3)&t; */
multiline_comment|/* (4.6.11.2.2)&t; */
r_if
c_cond
(paren
(paren
id|root_bridge
c_func
(paren
)paren
)paren
op_logical_and
(paren
op_logical_neg
id|root
)paren
)paren
(brace
multiline_comment|/* (4.7.4.4)&t; */
id|bridge_info.max_age
op_assign
id|bridge_info.bridge_max_age
suffix:semicolon
multiline_comment|/* (4.7.4.4.1)    */
id|bridge_info.hello_time
op_assign
id|bridge_info.bridge_hello_time
suffix:semicolon
id|bridge_info.forward_delay
op_assign
id|bridge_info.bridge_forward_delay
suffix:semicolon
id|topology_change_detection
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* (4.7.4.4.2)&t; */
multiline_comment|/* (4.6.14.2.4)&t; */
id|stop_tcn_timer
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* (4.7.4.4.3)&t; */
id|config_bpdu_generation
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* (4.7.4.4.4)&t; */
multiline_comment|/* (4.6.4.4.3)&t; */
id|start_hello_timer
c_func
(paren
)paren
suffix:semicolon
)brace
)brace
DECL|function|forward_delay_timer_expiry
r_void
id|forward_delay_timer_expiry
c_func
(paren
r_int
id|port_no
)paren
multiline_comment|/* (4.7.5)&t; */
(brace
r_if
c_cond
(paren
id|port_info
(braket
id|port_no
)braket
dot
id|state
op_eq
id|Listening
)paren
(brace
multiline_comment|/* (4.7.5.1)&t; */
id|set_port_state
c_func
(paren
id|port_no
comma
id|Learning
)paren
suffix:semicolon
multiline_comment|/* (4.7.5.1.1)&t; */
id|start_forward_delay_timer
c_func
(paren
id|port_no
)paren
suffix:semicolon
multiline_comment|/* (4.7.5.1.2)&t; */
)brace
r_else
r_if
c_cond
(paren
id|port_info
(braket
id|port_no
)braket
dot
id|state
op_eq
id|Learning
)paren
(brace
multiline_comment|/* (4.7.5.2) */
id|set_port_state
c_func
(paren
id|port_no
comma
id|Forwarding
)paren
suffix:semicolon
multiline_comment|/* (4.7.5.2.1) */
r_if
c_cond
(paren
id|designated_for_some_port
c_func
(paren
)paren
)paren
(brace
multiline_comment|/* (4.7.5.2.2) */
id|topology_change_detection
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* (4.6.14.2.2) */
)brace
)brace
)brace
DECL|function|designated_for_some_port
r_int
id|designated_for_some_port
c_func
(paren
r_void
)paren
(brace
r_int
id|port_no
suffix:semicolon
r_for
c_loop
(paren
id|port_no
op_assign
id|One
suffix:semicolon
id|port_no
op_le
id|No_of_ports
suffix:semicolon
id|port_no
op_increment
)paren
(brace
r_if
c_cond
(paren
(paren
id|br_cmp
c_func
(paren
id|port_info
(braket
id|port_no
)braket
dot
id|designated_bridge.BRIDGE_ID
comma
id|bridge_info.bridge_id.BRIDGE_ID
)paren
op_eq
l_int|0
)paren
)paren
(brace
r_return
(paren
id|TRUE
)paren
suffix:semicolon
)brace
)brace
r_return
(paren
id|FALSE
)paren
suffix:semicolon
)brace
DECL|function|tcn_timer_expiry
r_void
id|tcn_timer_expiry
c_func
(paren
r_void
)paren
(brace
multiline_comment|/* (4.7.6)&t; */
id|transmit_tcn
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* (4.7.6.1)&t; */
id|start_tcn_timer
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* (4.7.6.2)&t; */
)brace
DECL|function|topology_change_timer_expiry
r_void
id|topology_change_timer_expiry
c_func
(paren
r_void
)paren
(brace
multiline_comment|/* (4.7.7)&t; */
id|bridge_info.top_change_detected
op_assign
l_int|0
suffix:semicolon
id|bridge_info.top_change
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* (4.7.7.2)&t; */
)brace
DECL|function|hold_timer_expiry
r_void
id|hold_timer_expiry
c_func
(paren
r_int
id|port_no
)paren
multiline_comment|/* (4.7.8)&t; */
(brace
r_if
c_cond
(paren
id|port_info
(braket
id|port_no
)braket
dot
id|config_pending
)paren
(brace
id|transmit_config
c_func
(paren
id|port_no
)paren
suffix:semicolon
multiline_comment|/* (4.7.8.1)&t; */
)brace
multiline_comment|/* (4.6.1.2.3)&t; */
)brace
DECL|function|br_init
r_void
id|br_init
c_func
(paren
r_void
)paren
(brace
multiline_comment|/* (4.8.1)&t; */
r_int
id|port_no
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;Ethernet Bridge 003 for NET3.037 (Linux 2.1)&bslash;n&quot;
)paren
suffix:semicolon
id|bridge_info.designated_root
op_assign
id|bridge_info.bridge_id
suffix:semicolon
multiline_comment|/* (4.8.1.1)&t; */
id|bridge_info.root_path_cost
op_assign
id|Zero
suffix:semicolon
id|bridge_info.root_port
op_assign
id|No_port
suffix:semicolon
id|bridge_info.bridge_max_age
op_assign
id|BRIDGE_MAX_AGE
suffix:semicolon
id|bridge_info.bridge_hello_time
op_assign
id|BRIDGE_HELLO_TIME
suffix:semicolon
id|bridge_info.bridge_forward_delay
op_assign
id|BRIDGE_FORWARD_DELAY
suffix:semicolon
id|bridge_info.hold_time
op_assign
id|HOLD_TIME
suffix:semicolon
id|bridge_info.max_age
op_assign
id|bridge_info.bridge_max_age
suffix:semicolon
multiline_comment|/* (4.8.1.2)&t; */
id|bridge_info.hello_time
op_assign
id|bridge_info.bridge_hello_time
suffix:semicolon
id|bridge_info.forward_delay
op_assign
id|bridge_info.bridge_forward_delay
suffix:semicolon
id|bridge_info.top_change_detected
op_assign
l_int|0
suffix:semicolon
id|bridge_info.top_change
op_assign
l_int|0
suffix:semicolon
id|stop_tcn_timer
c_func
(paren
)paren
suffix:semicolon
id|stop_topology_change_timer
c_func
(paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|port_no
op_assign
id|One
suffix:semicolon
id|port_no
op_le
id|No_of_ports
suffix:semicolon
id|port_no
op_increment
)paren
(brace
multiline_comment|/* (4.8.1.4) */
id|br_init_port
c_func
(paren
id|port_no
)paren
suffix:semicolon
id|disable_port
c_func
(paren
id|port_no
)paren
suffix:semicolon
)brace
id|port_state_selection
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* (4.8.1.5)&t; */
id|config_bpdu_generation
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* (4.8.1.6)&t; */
multiline_comment|/* initialize system timer */
id|tl.expires
op_assign
id|jiffies
op_plus
id|HZ
suffix:semicolon
multiline_comment|/* 1 second */
id|tl.function
op_assign
id|br_tick
suffix:semicolon
id|add_timer
c_func
(paren
op_amp
id|tl
)paren
suffix:semicolon
id|register_netdevice_notifier
c_func
(paren
op_amp
id|br_dev_notifier
)paren
suffix:semicolon
id|br_stats.flags
op_assign
l_int|0
suffix:semicolon
multiline_comment|/*BR_UP | BR_DEBUG*/
suffix:semicolon
multiline_comment|/* enable bridge */
id|br_stats.policy
op_assign
id|BR_ACCEPT
suffix:semicolon
multiline_comment|/* Enable bridge to accpet all protocols */
id|br_stats.exempt_protocols
op_assign
l_int|0
suffix:semicolon
multiline_comment|/*start_hello_timer();*/
)brace
DECL|function|br_init_port
r_void
id|br_init_port
c_func
(paren
r_int
id|port_no
)paren
(brace
id|become_designated_port
c_func
(paren
id|port_no
)paren
suffix:semicolon
multiline_comment|/* (4.8.1.4.1) */
id|set_port_state
c_func
(paren
id|port_no
comma
id|Blocking
)paren
suffix:semicolon
multiline_comment|/* (4.8.1.4.2)    */
id|port_info
(braket
id|port_no
)braket
dot
id|top_change_ack
op_assign
l_int|0
suffix:semicolon
id|port_info
(braket
id|port_no
)braket
dot
id|config_pending
op_assign
id|FALSE
suffix:semicolon
multiline_comment|/* (4.8.1.4.4)&t; */
id|stop_message_age_timer
c_func
(paren
id|port_no
)paren
suffix:semicolon
multiline_comment|/* (4.8.1.4.5)&t; */
id|stop_forward_delay_timer
c_func
(paren
id|port_no
)paren
suffix:semicolon
multiline_comment|/* (4.8.1.4.6)&t; */
id|stop_hold_timer
c_func
(paren
id|port_no
)paren
suffix:semicolon
multiline_comment|/* (4.8.1.4.7)&t; */
)brace
DECL|function|enable_port
r_void
id|enable_port
c_func
(paren
r_int
id|port_no
)paren
multiline_comment|/* (4.8.2)&t; */
(brace
id|br_init_port
c_func
(paren
id|port_no
)paren
suffix:semicolon
id|port_state_selection
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* (4.8.2.7)&t; */
)brace
multiline_comment|/* */
DECL|function|disable_port
r_void
id|disable_port
c_func
(paren
r_int
id|port_no
)paren
multiline_comment|/* (4.8.3)&t; */
(brace
r_int
id|root
suffix:semicolon
id|root
op_assign
id|root_bridge
c_func
(paren
)paren
suffix:semicolon
id|become_designated_port
c_func
(paren
id|port_no
)paren
suffix:semicolon
multiline_comment|/* (4.8.3.1)&t; */
id|set_port_state
c_func
(paren
id|port_no
comma
id|Disabled
)paren
suffix:semicolon
multiline_comment|/* (4.8.3.2)&t; */
id|port_info
(braket
id|port_no
)braket
dot
id|top_change_ack
op_assign
l_int|0
suffix:semicolon
id|port_info
(braket
id|port_no
)braket
dot
id|config_pending
op_assign
id|FALSE
suffix:semicolon
multiline_comment|/* (4.8.3.4)&t; */
id|stop_message_age_timer
c_func
(paren
id|port_no
)paren
suffix:semicolon
multiline_comment|/* (4.8.3.5)&t; */
id|stop_forward_delay_timer
c_func
(paren
id|port_no
)paren
suffix:semicolon
multiline_comment|/* (4.8.3.6)&t; */
id|configuration_update
c_func
(paren
)paren
suffix:semicolon
id|port_state_selection
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* (4.8.3.7)&t; */
r_if
c_cond
(paren
(paren
id|root_bridge
c_func
(paren
)paren
)paren
op_logical_and
(paren
op_logical_neg
id|root
)paren
)paren
(brace
multiline_comment|/* (4.8.3.8)&t; */
id|bridge_info.max_age
op_assign
id|bridge_info.bridge_max_age
suffix:semicolon
multiline_comment|/* (4.8.3.8.1)    */
id|bridge_info.hello_time
op_assign
id|bridge_info.bridge_hello_time
suffix:semicolon
id|bridge_info.forward_delay
op_assign
id|bridge_info.bridge_forward_delay
suffix:semicolon
id|topology_change_detection
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* (4.8.3.8.2)    */
id|stop_tcn_timer
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* (4.8.3.8.3)    */
id|config_bpdu_generation
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* (4.8.3.8.4)    */
id|start_hello_timer
c_func
(paren
)paren
suffix:semicolon
)brace
)brace
DECL|function|set_bridge_priority
r_void
id|set_bridge_priority
c_func
(paren
id|bridge_id_t
op_star
id|new_bridge_id
)paren
multiline_comment|/* (4.8.4)&t; */
(brace
r_int
id|root
suffix:semicolon
r_int
id|port_no
suffix:semicolon
id|root
op_assign
id|root_bridge
c_func
(paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|port_no
op_assign
id|One
suffix:semicolon
id|port_no
op_le
id|No_of_ports
suffix:semicolon
id|port_no
op_increment
)paren
(brace
multiline_comment|/* (4.8.4.2) */
r_if
c_cond
(paren
id|designated_port
c_func
(paren
id|port_no
)paren
)paren
(brace
id|port_info
(braket
id|port_no
)braket
dot
id|designated_bridge
op_assign
op_star
id|new_bridge_id
suffix:semicolon
)brace
)brace
id|bridge_info.bridge_id
op_assign
op_star
id|new_bridge_id
suffix:semicolon
multiline_comment|/* (4.8.4.3)&t; */
id|configuration_update
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* (4.8.4.4)&t; */
id|port_state_selection
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* (4.8.4.5)&t; */
r_if
c_cond
(paren
(paren
id|root_bridge
c_func
(paren
)paren
)paren
op_logical_and
(paren
op_logical_neg
id|root
)paren
)paren
(brace
multiline_comment|/* (4.8.4.6)&t; */
id|bridge_info.max_age
op_assign
id|bridge_info.bridge_max_age
suffix:semicolon
multiline_comment|/* (4.8.4.6.1)    */
id|bridge_info.hello_time
op_assign
id|bridge_info.bridge_hello_time
suffix:semicolon
id|bridge_info.forward_delay
op_assign
id|bridge_info.bridge_forward_delay
suffix:semicolon
id|topology_change_detection
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* (4.8.4.6.2)    */
id|stop_tcn_timer
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* (4.8.4.6.3)    */
id|config_bpdu_generation
c_func
(paren
)paren
comma
multiline_comment|/* (4.8.4.6.4)    */
id|start_hello_timer
c_func
(paren
)paren
suffix:semicolon
)brace
)brace
DECL|function|set_port_priority
r_void
id|set_port_priority
c_func
(paren
r_int
id|port_no
comma
r_int
r_int
id|new_port_id
)paren
multiline_comment|/* (4.8.5)&t; */
(brace
r_if
c_cond
(paren
id|designated_port
c_func
(paren
id|port_no
)paren
)paren
(brace
multiline_comment|/* (4.8.5.2)&t; */
id|port_info
(braket
id|port_no
)braket
dot
id|designated_port
op_assign
id|new_port_id
suffix:semicolon
)brace
id|port_info
(braket
id|port_no
)braket
dot
id|port_id
op_assign
id|new_port_id
suffix:semicolon
multiline_comment|/* (4.8.5.3)&t; */
r_if
c_cond
(paren
(paren
id|br_cmp
c_func
(paren
id|bridge_info.bridge_id.BRIDGE_ID
comma
id|port_info
(braket
id|port_no
)braket
dot
id|designated_bridge.BRIDGE_ID
)paren
op_eq
l_int|0
)paren
op_logical_and
(paren
id|port_info
(braket
id|port_no
)braket
dot
id|port_id
OL
id|port_info
(braket
id|port_no
)braket
dot
id|designated_port
)paren
)paren
(brace
id|become_designated_port
c_func
(paren
id|port_no
)paren
suffix:semicolon
multiline_comment|/* (4.8.5.4.1) */
id|port_state_selection
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* (4.8.5.4.2) */
)brace
)brace
DECL|function|set_path_cost
r_void
id|set_path_cost
c_func
(paren
r_int
id|port_no
comma
r_int
r_int
id|path_cost
)paren
multiline_comment|/* (4.8.6)&t; */
(brace
id|port_info
(braket
id|port_no
)braket
dot
id|path_cost
op_assign
id|path_cost
suffix:semicolon
multiline_comment|/* (4.8.6.1)&t; */
id|configuration_update
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* (4.8.6.2)&t; */
id|port_state_selection
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* (4.8.6.3)&t; */
)brace
DECL|function|br_tick
r_static
r_void
id|br_tick
c_func
(paren
r_int
r_int
id|arg
)paren
(brace
r_int
id|port_no
suffix:semicolon
r_if
c_cond
(paren
id|hello_timer_expired
c_func
(paren
)paren
)paren
(brace
id|hello_timer_expiry
c_func
(paren
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|tcn_timer_expired
c_func
(paren
)paren
)paren
(brace
id|tcn_timer_expiry
c_func
(paren
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|topology_change_timer_expired
c_func
(paren
)paren
)paren
(brace
id|topology_change_timer_expiry
c_func
(paren
)paren
suffix:semicolon
)brace
r_for
c_loop
(paren
id|port_no
op_assign
id|One
suffix:semicolon
id|port_no
op_le
id|No_of_ports
suffix:semicolon
id|port_no
op_increment
)paren
(brace
r_if
c_cond
(paren
id|forward_delay_timer_expired
c_func
(paren
id|port_no
)paren
)paren
(brace
id|forward_delay_timer_expiry
c_func
(paren
id|port_no
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|message_age_timer_expired
c_func
(paren
id|port_no
)paren
)paren
(brace
id|message_age_timer_expiry
c_func
(paren
id|port_no
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|hold_timer_expired
c_func
(paren
id|port_no
)paren
)paren
(brace
id|hold_timer_expiry
c_func
(paren
id|port_no
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* call me again sometime... */
id|tl.expires
op_assign
id|jiffies
op_plus
id|HZ
suffix:semicolon
multiline_comment|/* 1 second */
id|tl.function
op_assign
id|br_tick
suffix:semicolon
id|add_timer
c_func
(paren
op_amp
id|tl
)paren
suffix:semicolon
)brace
DECL|function|start_hello_timer
r_void
id|start_hello_timer
c_func
(paren
r_void
)paren
(brace
id|hello_timer.value
op_assign
l_int|0
suffix:semicolon
id|hello_timer.active
op_assign
id|TRUE
suffix:semicolon
)brace
DECL|function|stop_hello_timer
r_void
id|stop_hello_timer
c_func
(paren
r_void
)paren
(brace
id|hello_timer.active
op_assign
id|FALSE
suffix:semicolon
)brace
DECL|function|hello_timer_expired
r_int
id|hello_timer_expired
c_func
(paren
r_void
)paren
(brace
r_if
c_cond
(paren
id|hello_timer.active
op_logical_and
(paren
op_increment
id|hello_timer.value
op_ge
id|bridge_info.hello_time
)paren
)paren
(brace
id|hello_timer.active
op_assign
id|FALSE
suffix:semicolon
r_return
(paren
id|TRUE
)paren
suffix:semicolon
)brace
r_return
(paren
id|FALSE
)paren
suffix:semicolon
)brace
DECL|function|start_tcn_timer
r_void
id|start_tcn_timer
c_func
(paren
r_void
)paren
(brace
id|tcn_timer.value
op_assign
l_int|0
suffix:semicolon
id|tcn_timer.active
op_assign
id|TRUE
suffix:semicolon
)brace
DECL|function|stop_tcn_timer
r_void
id|stop_tcn_timer
c_func
(paren
r_void
)paren
(brace
id|tcn_timer.active
op_assign
id|FALSE
suffix:semicolon
)brace
DECL|function|tcn_timer_expired
r_int
id|tcn_timer_expired
c_func
(paren
r_void
)paren
(brace
r_if
c_cond
(paren
id|tcn_timer.active
op_logical_and
(paren
op_increment
id|tcn_timer.value
op_ge
id|bridge_info.bridge_hello_time
)paren
)paren
(brace
id|tcn_timer.active
op_assign
id|FALSE
suffix:semicolon
r_return
(paren
id|TRUE
)paren
suffix:semicolon
)brace
r_return
(paren
id|FALSE
)paren
suffix:semicolon
)brace
DECL|function|start_topology_change_timer
r_void
id|start_topology_change_timer
c_func
(paren
r_void
)paren
(brace
id|topology_change_timer.value
op_assign
l_int|0
suffix:semicolon
id|topology_change_timer.active
op_assign
id|TRUE
suffix:semicolon
)brace
DECL|function|stop_topology_change_timer
r_void
id|stop_topology_change_timer
c_func
(paren
r_void
)paren
(brace
id|topology_change_timer.active
op_assign
id|FALSE
suffix:semicolon
)brace
DECL|function|topology_change_timer_expired
r_int
id|topology_change_timer_expired
c_func
(paren
r_void
)paren
(brace
r_if
c_cond
(paren
id|topology_change_timer.active
op_logical_and
(paren
op_increment
id|topology_change_timer.value
op_ge
id|bridge_info.topology_change_time
)paren
)paren
(brace
id|topology_change_timer.active
op_assign
id|FALSE
suffix:semicolon
r_return
(paren
id|TRUE
)paren
suffix:semicolon
)brace
r_return
(paren
id|FALSE
)paren
suffix:semicolon
)brace
DECL|function|start_message_age_timer
r_void
id|start_message_age_timer
c_func
(paren
r_int
id|port_no
comma
r_int
r_int
id|message_age
)paren
(brace
id|message_age_timer
(braket
id|port_no
)braket
dot
id|value
op_assign
id|message_age
suffix:semicolon
id|message_age_timer
(braket
id|port_no
)braket
dot
id|active
op_assign
id|TRUE
suffix:semicolon
)brace
DECL|function|stop_message_age_timer
r_void
id|stop_message_age_timer
c_func
(paren
r_int
id|port_no
)paren
(brace
id|message_age_timer
(braket
id|port_no
)braket
dot
id|active
op_assign
id|FALSE
suffix:semicolon
)brace
DECL|function|message_age_timer_expired
r_int
id|message_age_timer_expired
c_func
(paren
r_int
id|port_no
)paren
(brace
r_if
c_cond
(paren
id|message_age_timer
(braket
id|port_no
)braket
dot
id|active
op_logical_and
(paren
op_increment
id|message_age_timer
(braket
id|port_no
)braket
dot
id|value
op_ge
id|bridge_info.max_age
)paren
)paren
(brace
id|message_age_timer
(braket
id|port_no
)braket
dot
id|active
op_assign
id|FALSE
suffix:semicolon
r_return
(paren
id|TRUE
)paren
suffix:semicolon
)brace
r_return
(paren
id|FALSE
)paren
suffix:semicolon
)brace
DECL|function|start_forward_delay_timer
r_void
id|start_forward_delay_timer
c_func
(paren
r_int
id|port_no
)paren
(brace
id|forward_delay_timer
(braket
id|port_no
)braket
dot
id|value
op_assign
l_int|0
suffix:semicolon
id|forward_delay_timer
(braket
id|port_no
)braket
dot
id|active
op_assign
id|TRUE
suffix:semicolon
)brace
DECL|function|stop_forward_delay_timer
r_void
id|stop_forward_delay_timer
c_func
(paren
r_int
id|port_no
)paren
(brace
id|forward_delay_timer
(braket
id|port_no
)braket
dot
id|active
op_assign
id|FALSE
suffix:semicolon
)brace
DECL|function|forward_delay_timer_expired
r_int
id|forward_delay_timer_expired
c_func
(paren
r_int
id|port_no
)paren
(brace
r_if
c_cond
(paren
id|forward_delay_timer
(braket
id|port_no
)braket
dot
id|active
op_logical_and
(paren
op_increment
id|forward_delay_timer
(braket
id|port_no
)braket
dot
id|value
op_ge
id|bridge_info.forward_delay
)paren
)paren
(brace
id|forward_delay_timer
(braket
id|port_no
)braket
dot
id|active
op_assign
id|FALSE
suffix:semicolon
r_return
(paren
id|TRUE
)paren
suffix:semicolon
)brace
r_return
(paren
id|FALSE
)paren
suffix:semicolon
)brace
DECL|function|start_hold_timer
r_void
id|start_hold_timer
c_func
(paren
r_int
id|port_no
)paren
(brace
id|hold_timer
(braket
id|port_no
)braket
dot
id|value
op_assign
l_int|0
suffix:semicolon
id|hold_timer
(braket
id|port_no
)braket
dot
id|active
op_assign
id|TRUE
suffix:semicolon
)brace
DECL|function|stop_hold_timer
r_void
id|stop_hold_timer
c_func
(paren
r_int
id|port_no
)paren
(brace
id|hold_timer
(braket
id|port_no
)braket
dot
id|active
op_assign
id|FALSE
suffix:semicolon
)brace
DECL|function|hold_timer_expired
r_int
id|hold_timer_expired
c_func
(paren
r_int
id|port_no
)paren
(brace
r_if
c_cond
(paren
id|hold_timer
(braket
id|port_no
)braket
dot
id|active
op_logical_and
(paren
op_increment
id|hold_timer
(braket
id|port_no
)braket
dot
id|value
op_ge
id|bridge_info.hold_time
)paren
)paren
(brace
id|hold_timer
(braket
id|port_no
)braket
dot
id|active
op_assign
id|FALSE
suffix:semicolon
r_return
(paren
id|TRUE
)paren
suffix:semicolon
)brace
r_return
(paren
id|FALSE
)paren
suffix:semicolon
)brace
DECL|function|send_config_bpdu
r_int
id|send_config_bpdu
c_func
(paren
r_int
id|port_no
comma
id|Config_bpdu
op_star
id|config_bpdu
)paren
(brace
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
r_struct
id|device
op_star
id|dev
op_assign
id|port_info
(braket
id|port_no
)braket
dot
id|dev
suffix:semicolon
r_int
id|size
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_struct
id|ethhdr
op_star
id|eth
suffix:semicolon
r_if
c_cond
(paren
id|port_info
(braket
id|port_no
)braket
dot
id|state
op_eq
id|Disabled
)paren
(brace
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;send_config_bpdu: port %i not valid&bslash;n&quot;
comma
id|port_no
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|br_stats.flags
op_amp
id|BR_DEBUG
)paren
id|printk
c_func
(paren
l_string|&quot;send_config_bpdu: &quot;
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * create and send the message&n;&t; */
id|size
op_assign
id|dev-&gt;hard_header_len
op_plus
r_sizeof
(paren
id|Config_bpdu
)paren
suffix:semicolon
id|skb
op_assign
id|alloc_skb
c_func
(paren
id|size
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
id|skb
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;send_config_bpdu: no skb available&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|skb-&gt;dev
op_assign
id|dev
suffix:semicolon
id|skb-&gt;mac.raw
op_assign
id|skb-&gt;h.raw
op_assign
id|skb_put
c_func
(paren
id|skb
comma
id|size
)paren
suffix:semicolon
id|eth
op_assign
id|skb-&gt;mac.ethernet
suffix:semicolon
id|memcpy
c_func
(paren
id|eth-&gt;h_dest
comma
id|bridge_ula
comma
id|ETH_ALEN
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|eth-&gt;h_source
comma
id|dev-&gt;dev_addr
comma
id|ETH_ALEN
)paren
suffix:semicolon
r_if
c_cond
(paren
id|br_stats.flags
op_amp
id|BR_DEBUG
)paren
id|printk
c_func
(paren
l_string|&quot;port %i src %02x:%02x:%02x:%02x:%02x:%02x&bslash;&n;&t;&t;&t;dest %02x:%02x:%02x:%02x:%02x:%02x&bslash;n&quot;
comma
id|port_no
comma
id|eth-&gt;h_source
(braket
l_int|0
)braket
comma
id|eth-&gt;h_source
(braket
l_int|1
)braket
comma
id|eth-&gt;h_source
(braket
l_int|2
)braket
comma
id|eth-&gt;h_source
(braket
l_int|3
)braket
comma
id|eth-&gt;h_source
(braket
l_int|4
)braket
comma
id|eth-&gt;h_source
(braket
l_int|5
)braket
comma
id|eth-&gt;h_dest
(braket
l_int|0
)braket
comma
id|eth-&gt;h_dest
(braket
l_int|1
)braket
comma
id|eth-&gt;h_dest
(braket
l_int|2
)braket
comma
id|eth-&gt;h_dest
(braket
l_int|3
)braket
comma
id|eth-&gt;h_dest
(braket
l_int|4
)braket
comma
id|eth-&gt;h_dest
(braket
l_int|5
)braket
)paren
suffix:semicolon
id|eth-&gt;h_proto
op_assign
id|htons
c_func
(paren
l_int|0x8038
)paren
suffix:semicolon
id|skb-&gt;h.raw
op_add_assign
id|skb-&gt;dev-&gt;hard_header_len
suffix:semicolon
id|memcpy
c_func
(paren
id|skb-&gt;h.raw
comma
id|config_bpdu
comma
r_sizeof
(paren
id|Config_bpdu
)paren
)paren
suffix:semicolon
multiline_comment|/* won&squot;t get bridged again... */
id|skb-&gt;pkt_bridged
op_assign
id|IS_BRIDGED
suffix:semicolon
id|skb-&gt;arp
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* do not resolve... */
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|skb_queue_tail
c_func
(paren
id|dev-&gt;buffs
comma
id|skb
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|send_tcn_bpdu
r_int
id|send_tcn_bpdu
c_func
(paren
r_int
id|port_no
comma
id|Tcn_bpdu
op_star
id|bpdu
)paren
(brace
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
r_struct
id|device
op_star
id|dev
op_assign
id|port_info
(braket
id|port_no
)braket
dot
id|dev
suffix:semicolon
r_int
id|size
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_struct
id|ethhdr
op_star
id|eth
suffix:semicolon
r_if
c_cond
(paren
id|port_info
(braket
id|port_no
)braket
dot
id|state
op_eq
id|Disabled
)paren
(brace
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;send_tcn_bpdu: port %i not valid&bslash;n&quot;
comma
id|port_no
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|br_stats.flags
op_amp
id|BR_DEBUG
)paren
id|printk
c_func
(paren
l_string|&quot;send_tcn_bpdu: &quot;
)paren
suffix:semicolon
id|size
op_assign
r_sizeof
(paren
id|Tcn_bpdu
)paren
op_plus
id|dev-&gt;hard_header_len
suffix:semicolon
id|skb
op_assign
id|alloc_skb
c_func
(paren
id|size
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
id|skb
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;send_tcn_bpdu: no skb available&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|skb-&gt;dev
op_assign
id|dev
suffix:semicolon
id|skb-&gt;mac.raw
op_assign
id|skb-&gt;h.raw
op_assign
id|skb_put
c_func
(paren
id|skb
comma
id|size
)paren
suffix:semicolon
id|eth
op_assign
id|skb-&gt;mac.ethernet
suffix:semicolon
id|memcpy
c_func
(paren
id|eth-&gt;h_dest
comma
id|bridge_ula
comma
id|ETH_ALEN
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|eth-&gt;h_source
comma
id|dev-&gt;dev_addr
comma
id|ETH_ALEN
)paren
suffix:semicolon
r_if
c_cond
(paren
id|br_stats.flags
op_amp
id|BR_DEBUG
)paren
id|printk
c_func
(paren
l_string|&quot;port %i src %02x:%02x:%02x:%02x:%02x:%02x&bslash;&n;&t;&t;&t;dest %02x:%02x:%02x:%02x:%02x:%02x&bslash;n&quot;
comma
id|port_no
comma
id|eth-&gt;h_source
(braket
l_int|0
)braket
comma
id|eth-&gt;h_source
(braket
l_int|1
)braket
comma
id|eth-&gt;h_source
(braket
l_int|2
)braket
comma
id|eth-&gt;h_source
(braket
l_int|3
)braket
comma
id|eth-&gt;h_source
(braket
l_int|4
)braket
comma
id|eth-&gt;h_source
(braket
l_int|5
)braket
comma
id|eth-&gt;h_dest
(braket
l_int|0
)braket
comma
id|eth-&gt;h_dest
(braket
l_int|1
)braket
comma
id|eth-&gt;h_dest
(braket
l_int|2
)braket
comma
id|eth-&gt;h_dest
(braket
l_int|3
)braket
comma
id|eth-&gt;h_dest
(braket
l_int|4
)braket
comma
id|eth-&gt;h_dest
(braket
l_int|5
)braket
)paren
suffix:semicolon
id|eth-&gt;h_proto
op_assign
id|htons
c_func
(paren
l_int|0x8038
)paren
suffix:semicolon
id|skb-&gt;h.raw
op_add_assign
id|skb-&gt;dev-&gt;hard_header_len
suffix:semicolon
id|memcpy
c_func
(paren
id|skb-&gt;h.raw
comma
id|bpdu
comma
r_sizeof
(paren
id|Tcn_bpdu
)paren
)paren
suffix:semicolon
multiline_comment|/* mark that we&squot;ve been here... */
id|skb-&gt;pkt_bridged
op_assign
id|IS_BRIDGED
suffix:semicolon
id|skb-&gt;arp
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* do not resolve... */
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|skb_queue_tail
c_func
(paren
id|dev-&gt;buffs
comma
id|skb
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|br_device_event
r_static
r_int
id|br_device_event
c_func
(paren
r_struct
id|notifier_block
op_star
id|unused
comma
r_int
r_int
id|event
comma
r_void
op_star
id|ptr
)paren
(brace
r_struct
id|device
op_star
id|dev
op_assign
id|ptr
suffix:semicolon
r_int
id|i
suffix:semicolon
multiline_comment|/* check for loopback devices */
r_if
c_cond
(paren
id|dev-&gt;flags
op_amp
id|IFF_LOOPBACK
)paren
r_return
id|NOTIFY_DONE
suffix:semicolon
r_switch
c_cond
(paren
id|event
)paren
(brace
r_case
id|NETDEV_DOWN
suffix:colon
r_if
c_cond
(paren
id|br_stats.flags
op_amp
id|BR_DEBUG
)paren
id|printk
c_func
(paren
l_string|&quot;br_device_event: NETDEV_DOWN...&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* find our device and mark it down */
r_for
c_loop
(paren
id|i
op_assign
id|One
suffix:semicolon
id|i
op_le
id|No_of_ports
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|port_info
(braket
id|i
)braket
dot
id|dev
op_eq
id|dev
)paren
(brace
id|disable_port
c_func
(paren
id|i
)paren
suffix:semicolon
r_return
id|NOTIFY_DONE
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
r_break
suffix:semicolon
r_case
id|NETDEV_UP
suffix:colon
r_if
c_cond
(paren
id|br_stats.flags
op_amp
id|BR_DEBUG
)paren
id|printk
c_func
(paren
l_string|&quot;br_device_event: NETDEV_UP...&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* Only handle ethernet ports */
r_if
c_cond
(paren
id|dev-&gt;type
op_ne
id|ARPHRD_ETHER
op_logical_and
id|dev-&gt;type
op_ne
id|ARPHRD_LOOPBACK
)paren
(brace
r_return
id|NOTIFY_DONE
suffix:semicolon
)brace
multiline_comment|/* look up an unused device and enable it */
r_for
c_loop
(paren
id|i
op_assign
id|One
suffix:semicolon
id|i
op_le
id|No_of_ports
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
(paren
id|port_info
(braket
id|i
)braket
dot
id|dev
op_eq
(paren
r_struct
id|device
op_star
)paren
l_int|0
)paren
op_logical_or
(paren
id|port_info
(braket
id|i
)braket
dot
id|dev
op_eq
id|dev
)paren
)paren
(brace
id|port_info
(braket
id|i
)braket
dot
id|dev
op_assign
id|dev
suffix:semicolon
id|enable_port
c_func
(paren
id|i
)paren
suffix:semicolon
id|set_path_cost
c_func
(paren
id|i
comma
id|br_port_cost
c_func
(paren
id|dev
)paren
)paren
suffix:semicolon
id|set_port_priority
c_func
(paren
id|i
comma
l_int|128
)paren
suffix:semicolon
id|port_info
(braket
id|i
)braket
dot
id|port_id
op_assign
id|i
suffix:semicolon
multiline_comment|/* set bridge addr from 1st device addr */
r_if
c_cond
(paren
(paren
id|bridge_info.bridge_id.BRIDGE_ID
(braket
l_int|0
)braket
op_eq
l_int|0
)paren
op_logical_and
(paren
id|bridge_info.bridge_id.BRIDGE_ID
(braket
l_int|1
)braket
op_eq
l_int|0
)paren
)paren
(brace
id|memcpy
c_func
(paren
id|bridge_info.bridge_id.BRIDGE_ID_ULA
comma
id|dev-&gt;dev_addr
comma
l_int|6
)paren
suffix:semicolon
id|bridge_info.bridge_id.BRIDGE_PRIORITY
op_assign
id|port_info
(braket
id|i
)braket
dot
id|port_id
suffix:semicolon
id|set_bridge_priority
c_func
(paren
op_amp
id|bridge_info.bridge_id
)paren
suffix:semicolon
)brace
id|make_forwarding
c_func
(paren
id|i
)paren
suffix:semicolon
r_return
id|NOTIFY_DONE
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
r_break
suffix:semicolon
macro_line|#if 0
r_default
suffix:colon
id|printk
c_func
(paren
l_string|&quot;br_device_event: unknown event [%x]&bslash;n&quot;
comma
(paren
r_int
r_int
)paren
id|event
)paren
suffix:semicolon
macro_line|#endif&t;&t;&t;
)brace
r_return
id|NOTIFY_DONE
suffix:semicolon
)brace
multiline_comment|/*&n; * following routine is called when a frame is received&n; * from an interface, it returns 1 when it consumes the&n; * frame, 0 when it does not&n; */
DECL|function|br_receive_frame
r_int
id|br_receive_frame
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
)paren
multiline_comment|/* 3.5 */
(brace
r_int
id|port
suffix:semicolon
r_struct
id|ethhdr
op_star
id|eth
suffix:semicolon
r_if
c_cond
(paren
id|br_stats.flags
op_amp
id|BR_DEBUG
)paren
id|printk
c_func
(paren
l_string|&quot;br_receive_frame: &quot;
)paren
suffix:semicolon
multiline_comment|/* sanity */
r_if
c_cond
(paren
op_logical_neg
id|skb
)paren
(brace
id|printk
c_func
(paren
id|KERN_CRIT
l_string|&quot;br_receive_frame: no skb!&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
id|skb-&gt;pkt_bridged
op_assign
id|IS_BRIDGED
suffix:semicolon
multiline_comment|/* check for loopback */
r_if
c_cond
(paren
id|skb-&gt;dev-&gt;flags
op_amp
id|IFF_LOOPBACK
)paren
r_return
l_int|0
suffix:semicolon
id|port
op_assign
id|find_port
c_func
(paren
id|skb-&gt;dev
)paren
suffix:semicolon
id|skb-&gt;arp
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* Received frame so it is resolved */
id|skb-&gt;h.raw
op_assign
id|skb-&gt;mac.raw
suffix:semicolon
id|eth
op_assign
id|skb-&gt;mac.ethernet
suffix:semicolon
r_if
c_cond
(paren
id|br_stats.flags
op_amp
id|BR_DEBUG
)paren
id|printk
c_func
(paren
l_string|&quot;port %i src %02x:%02x:%02x:%02x:%02x:%02x&bslash;&n;&t;&t;&t;dest %02x:%02x:%02x:%02x:%02x:%02x&bslash;n&quot;
comma
id|port
comma
id|eth-&gt;h_source
(braket
l_int|0
)braket
comma
id|eth-&gt;h_source
(braket
l_int|1
)braket
comma
id|eth-&gt;h_source
(braket
l_int|2
)braket
comma
id|eth-&gt;h_source
(braket
l_int|3
)braket
comma
id|eth-&gt;h_source
(braket
l_int|4
)braket
comma
id|eth-&gt;h_source
(braket
l_int|5
)braket
comma
id|eth-&gt;h_dest
(braket
l_int|0
)braket
comma
id|eth-&gt;h_dest
(braket
l_int|1
)braket
comma
id|eth-&gt;h_dest
(braket
l_int|2
)braket
comma
id|eth-&gt;h_dest
(braket
l_int|3
)braket
comma
id|eth-&gt;h_dest
(braket
l_int|4
)braket
comma
id|eth-&gt;h_dest
(braket
l_int|5
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|port
)paren
(brace
r_if
c_cond
(paren
id|br_stats.flags
op_amp
id|BR_DEBUG
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;&bslash;nbr_receive_frame: no port!&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
r_switch
c_cond
(paren
id|port_info
(braket
id|port
)braket
dot
id|state
)paren
(brace
r_case
id|Learning
suffix:colon
(paren
r_void
)paren
id|br_learn
c_func
(paren
id|skb
comma
id|port
)paren
suffix:semicolon
multiline_comment|/* 3.8 */
multiline_comment|/* fall through */
r_case
id|Listening
suffix:colon
multiline_comment|/* process BPDUs */
r_if
c_cond
(paren
id|memcmp
c_func
(paren
id|eth-&gt;h_dest
comma
id|bridge_ula
comma
l_int|6
)paren
op_eq
l_int|0
)paren
(brace
id|br_bpdu
c_func
(paren
id|skb
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
multiline_comment|/* br_bpdu consumes skb */
)brace
multiline_comment|/* fall through */
r_case
id|Blocking
suffix:colon
multiline_comment|/* fall through */
r_case
id|Disabled
suffix:colon
multiline_comment|/* should drop frames, but for now, we let&n;&t;&t;&t; * them get passed up to the next higher layer&n;&t;&t;&t;return(br_drop(skb));&t;&n;&t;&t;&t; */
r_return
l_int|0
suffix:semicolon
multiline_comment|/* pass frame up stack */
r_break
suffix:semicolon
r_case
id|Forwarding
suffix:colon
(paren
r_void
)paren
id|br_learn
c_func
(paren
id|skb
comma
id|port
)paren
suffix:semicolon
multiline_comment|/* 3.8 */
multiline_comment|/* process BPDUs */
r_if
c_cond
(paren
id|memcmp
c_func
(paren
id|eth-&gt;h_dest
comma
id|bridge_ula
comma
id|ETH_ALEN
)paren
op_eq
l_int|0
)paren
(brace
multiline_comment|/*printk(&quot;frame bpdu processor for me!!!&bslash;n&quot;);*/
id|br_bpdu
c_func
(paren
id|skb
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
multiline_comment|/* br_bpdu consumes skb */
)brace
multiline_comment|/* is frame for me? */
r_if
c_cond
(paren
id|memcmp
c_func
(paren
id|eth-&gt;h_dest
comma
id|port_info
(braket
id|port
)braket
dot
id|dev-&gt;dev_addr
comma
id|ETH_ALEN
)paren
op_eq
l_int|0
)paren
(brace
multiline_comment|/* Packet is for us */
id|skb-&gt;pkt_type
op_assign
id|PACKET_HOST
suffix:semicolon
r_return
l_int|0
suffix:semicolon
multiline_comment|/* pass frame up our stack (this will */
multiline_comment|/* happen in net_bh() in dev.c) */
)brace
multiline_comment|/* Now this frame came from one of bridged&n;&t;&t;&t;   ports, and it appears to be not for me;&n;&t;&t;&t;   this means we should attempt to forward it.&n;&t;&t;&t;   But actually this frame can still be for me&n;&t;&t;&t;   [as well] if it is destined to one of our&n;&t;&t;&t;   multicast groups.  br_forward() will not&n;&t;&t;&t;   consume the frame if this is the case */
r_return
id|br_forward
c_func
(paren
id|skb
comma
id|port
)paren
suffix:semicolon
r_default
suffix:colon
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;br_receive_frame: port [%i] unknown state [%i]&bslash;n&quot;
comma
id|port
comma
id|port_info
(braket
id|port
)braket
dot
id|state
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
multiline_comment|/* pass frame up stack? */
)brace
)brace
multiline_comment|/*&n; * the following routine is called to transmit frames from the host&n; * stack.  it returns 1 when it consumes the frame and&n; * 0 when it does not.&n; */
DECL|function|br_tx_frame
r_int
id|br_tx_frame
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
)paren
multiline_comment|/* 3.5 */
(brace
r_int
id|port
suffix:semicolon
r_struct
id|ethhdr
op_star
id|eth
suffix:semicolon
multiline_comment|/* sanity */
r_if
c_cond
(paren
op_logical_neg
id|skb
)paren
(brace
id|printk
c_func
(paren
id|KERN_CRIT
l_string|&quot;br_tx_frame: no skb!&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|skb-&gt;dev
)paren
(brace
id|printk
c_func
(paren
id|KERN_CRIT
l_string|&quot;br_tx_frame: no dev!&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* check for loopback */
r_if
c_cond
(paren
id|skb-&gt;dev-&gt;flags
op_amp
id|IFF_LOOPBACK
)paren
r_return
l_int|0
suffix:semicolon
multiline_comment|/* if bridging is not enabled on the port we are going to send&n;           to, we have nothing to do with this frame, hands off */
r_if
c_cond
(paren
op_logical_neg
id|find_port
c_func
(paren
id|skb-&gt;dev
)paren
)paren
r_return
l_int|0
suffix:semicolon
id|skb-&gt;mac.raw
op_assign
id|skb-&gt;h.raw
op_assign
id|skb-&gt;data
suffix:semicolon
id|eth
op_assign
id|skb-&gt;mac.ethernet
suffix:semicolon
id|port
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* an impossible port */
r_if
c_cond
(paren
id|br_stats.flags
op_amp
id|BR_DEBUG
)paren
id|printk
c_func
(paren
l_string|&quot;br_tx_fr : port %i src %02x:%02x:%02x:%02x:%02x:%02x&bslash;&n;&t;  &t;&t;dest %02x:%02x:%02x:%02x:%02x:%02x&bslash;n&quot;
comma
id|port
comma
id|eth-&gt;h_source
(braket
l_int|0
)braket
comma
id|eth-&gt;h_source
(braket
l_int|1
)braket
comma
id|eth-&gt;h_source
(braket
l_int|2
)braket
comma
id|eth-&gt;h_source
(braket
l_int|3
)braket
comma
id|eth-&gt;h_source
(braket
l_int|4
)braket
comma
id|eth-&gt;h_source
(braket
l_int|5
)braket
comma
id|eth-&gt;h_dest
(braket
l_int|0
)braket
comma
id|eth-&gt;h_dest
(braket
l_int|1
)braket
comma
id|eth-&gt;h_dest
(braket
l_int|2
)braket
comma
id|eth-&gt;h_dest
(braket
l_int|3
)braket
comma
id|eth-&gt;h_dest
(braket
l_int|4
)braket
comma
id|eth-&gt;h_dest
(braket
l_int|5
)braket
)paren
suffix:semicolon
r_return
id|br_forward
c_func
(paren
id|skb
comma
id|port
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * this routine returns 0 when it learns (or updates) from the&n; * frame, and -1 if the frame is simply discarded due to port&n; * state or lack of resources...&n; */
DECL|function|br_learn
r_int
id|br_learn
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_int
id|port
)paren
multiline_comment|/* 3.8 */
(brace
r_struct
id|fdb
op_star
id|f
suffix:semicolon
r_switch
c_cond
(paren
id|port_info
(braket
id|port
)braket
dot
id|state
)paren
(brace
r_case
id|Listening
suffix:colon
r_case
id|Blocking
suffix:colon
r_case
id|Disabled
suffix:colon
r_default
suffix:colon
r_return
op_minus
l_int|1
suffix:semicolon
multiline_comment|/* break; */
r_case
id|Learning
suffix:colon
r_case
id|Forwarding
suffix:colon
multiline_comment|/* don&squot;t keep group addresses in the tree */
r_if
c_cond
(paren
id|skb-&gt;mac.ethernet-&gt;h_source
(braket
l_int|0
)braket
op_amp
l_int|0x01
)paren
r_return
op_minus
l_int|1
suffix:semicolon
id|f
op_assign
(paren
r_struct
id|fdb
op_star
)paren
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|fdb
)paren
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|f
)paren
(brace
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;br_learn: unable to malloc fdb&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|f-&gt;port
op_assign
id|port
suffix:semicolon
multiline_comment|/* source port */
id|memcpy
c_func
(paren
id|f-&gt;ula
comma
id|skb-&gt;mac.ethernet-&gt;h_source
comma
l_int|6
)paren
suffix:semicolon
id|f-&gt;timer
op_assign
id|CURRENT_TIME
suffix:semicolon
id|f-&gt;flags
op_assign
id|FDB_ENT_VALID
suffix:semicolon
multiline_comment|/*&n;&t;&t;&t; * add entity to AVL tree.  If entity already&n;&t;&t;&t; * exists in the tree, update the fields with&n;&t;&t;&t; * what we have here.&n;&t;&t;  &t; */
r_if
c_cond
(paren
id|br_avl_insert
c_func
(paren
id|f
)paren
op_eq
l_int|0
)paren
(brace
multiline_comment|/* update */
id|kfree
c_func
(paren
id|f
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* add to head of port chain */
id|f-&gt;fdb_next
op_assign
id|port_info
(braket
id|port
)braket
dot
id|fdb
suffix:semicolon
id|port_info
(braket
id|port
)braket
dot
id|fdb
op_assign
id|f
suffix:semicolon
r_return
l_int|0
suffix:semicolon
multiline_comment|/* break */
)brace
)brace
multiline_comment|/*&n; * this routine always consumes the frame&n; */
DECL|function|br_drop
r_int
id|br_drop
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
)paren
(brace
id|kfree_skb
c_func
(paren
id|skb
comma
l_int|0
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
multiline_comment|/*&n; * this routine always consumes the frame&n; */
DECL|function|br_dev_drop
r_int
id|br_dev_drop
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
)paren
(brace
id|dev_kfree_skb
c_func
(paren
id|skb
comma
l_int|0
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
multiline_comment|/*&n; * Forward the frame SKB to proper port[s].  PORT is the port that the&n; * frame has come from; we will not send the frame back there.  PORT == 0&n; * means we have been called from br_tx_fr(), not from br_receive_frame().&n; *&n; * this routine returns 1 if it consumes the frame, 0&n; * if not...&n; */
DECL|function|br_forward
r_int
id|br_forward
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_int
id|port
)paren
multiline_comment|/* 3.7 */
(brace
r_struct
id|fdb
op_star
id|f
suffix:semicolon
multiline_comment|/*&n;   &t; * flood all ports with frames destined for a group&n;&t; * address.  If frame came from above, drop it,&n;&t; * otherwise it will be handled in br_receive_frame()&n;&t; * Multicast frames will also need to be seen&n;&t; * by our upper layers.&n;&t; */
r_if
c_cond
(paren
id|skb-&gt;mac.ethernet-&gt;h_dest
(braket
l_int|0
)braket
op_amp
l_int|0x01
)paren
(brace
multiline_comment|/* group address */
id|br_flood
c_func
(paren
id|skb
comma
id|port
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t; *&t;External groups are fed out via the normal source&n;&t;&t; *&t;This probably should be dropped since the flood will&n;&t;&t; *&t;have sent it anyway.&n;&t;&t; */
r_if
c_cond
(paren
id|port
op_eq
l_int|0
)paren
multiline_comment|/* locally generated */
r_return
id|br_dev_drop
c_func
(paren
id|skb
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* locate port to forward to */
id|f
op_assign
id|br_avl_find_addr
c_func
(paren
id|skb-&gt;mac.ethernet-&gt;h_dest
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t; *&t;Send flood and drop.&n;&t;&t; */
r_if
c_cond
(paren
op_logical_neg
id|f
op_logical_or
op_logical_neg
(paren
id|f-&gt;flags
op_amp
id|FDB_ENT_VALID
)paren
)paren
(brace
multiline_comment|/* not found; flood all ports */
id|br_flood
c_func
(paren
id|skb
comma
id|port
)paren
suffix:semicolon
r_return
id|br_dev_drop
c_func
(paren
id|skb
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;&t;&t; *&t;Sending&n;&t;&t; */
r_if
c_cond
(paren
id|f-&gt;port
op_ne
id|port
op_logical_and
id|port_info
(braket
id|f-&gt;port
)braket
dot
id|state
op_eq
id|Forwarding
)paren
(brace
multiline_comment|/* has entry expired? */
r_if
c_cond
(paren
id|f-&gt;timer
op_plus
id|fdb_aging_time
OL
id|CURRENT_TIME
)paren
(brace
multiline_comment|/* timer expired, invalidate entry */
id|f-&gt;flags
op_and_assign
op_complement
id|FDB_ENT_VALID
suffix:semicolon
r_if
c_cond
(paren
id|br_stats.flags
op_amp
id|BR_DEBUG
)paren
id|printk
c_func
(paren
l_string|&quot;fdb entry expired...&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t;&t;&t; *&t;Send flood and drop original&n;&t;&t;&t;&t; */
id|br_flood
c_func
(paren
id|skb
comma
id|port
)paren
suffix:semicolon
r_return
id|br_dev_drop
c_func
(paren
id|skb
)paren
suffix:semicolon
)brace
multiline_comment|/* mark that&squot;s we&squot;ve been here... */
id|skb-&gt;pkt_bridged
op_assign
id|IS_BRIDGED
suffix:semicolon
multiline_comment|/* reset the skb-&gt;ip pointer */
id|skb-&gt;h.raw
op_assign
id|skb-&gt;data
op_plus
id|ETH_HLEN
suffix:semicolon
multiline_comment|/*&n;&t;&t;&t; *&t;Send the buffer out.&n;&t;&t;&t; */
id|skb-&gt;dev
op_assign
id|port_info
(braket
id|f-&gt;port
)braket
dot
id|dev
suffix:semicolon
multiline_comment|/*&n;&t;&t;&t; *&t;We send this still locked&n;&t;&t;&t; */
id|skb-&gt;priority
op_assign
l_int|1
suffix:semicolon
id|dev_queue_xmit
c_func
(paren
id|skb
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
multiline_comment|/* skb has been consumed */
)brace
r_else
(brace
multiline_comment|/*&n;&t;&t;&t; *&t;Arrived on the right port, we discard&n;&t;&t;&t; */
r_return
id|br_dev_drop
c_func
(paren
id|skb
)paren
suffix:semicolon
)brace
)brace
)brace
multiline_comment|/*&n; * this routine sends a copy of the frame to all forwarding ports&n; * with the exception of the port given.  This routine never&n; * consumes the original frame.&n; */
DECL|function|br_flood
r_int
id|br_flood
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_int
id|port
)paren
(brace
r_int
id|i
suffix:semicolon
r_struct
id|sk_buff
op_star
id|nskb
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
id|One
suffix:semicolon
id|i
op_le
id|No_of_ports
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|i
op_eq
id|port
)paren
r_continue
suffix:semicolon
r_if
c_cond
(paren
id|port_info
(braket
id|i
)braket
dot
id|state
op_eq
id|Forwarding
)paren
(brace
id|nskb
op_assign
id|skb_clone
c_func
(paren
id|skb
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
id|nskb
op_eq
l_int|NULL
)paren
(brace
r_continue
suffix:semicolon
)brace
multiline_comment|/* mark that&squot;s we&squot;ve been here... */
id|nskb-&gt;pkt_bridged
op_assign
id|IS_BRIDGED
suffix:semicolon
multiline_comment|/* Send to each port in turn */
id|nskb-&gt;dev
op_assign
id|port_info
(braket
id|i
)braket
dot
id|dev
suffix:semicolon
multiline_comment|/* To get here we must have done ARP already,&n;&t;&t;&t;   or have a received valid MAC header */
id|nskb-&gt;arp
op_assign
l_int|1
suffix:semicolon
multiline_comment|/*&t;&t;&t;printk(&quot;Flood to port %d&bslash;n&quot;,i);*/
id|nskb-&gt;h.raw
op_assign
id|nskb-&gt;data
op_plus
id|ETH_HLEN
suffix:semicolon
id|nskb-&gt;priority
op_assign
l_int|1
suffix:semicolon
id|dev_queue_xmit
c_func
(paren
id|nskb
)paren
suffix:semicolon
)brace
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|find_port
r_int
id|find_port
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
id|One
suffix:semicolon
id|i
op_le
id|No_of_ports
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
(paren
id|port_info
(braket
id|i
)braket
dot
id|dev
op_eq
id|dev
)paren
op_logical_and
(paren
id|port_info
(braket
id|i
)braket
dot
id|state
op_ne
id|Disabled
)paren
)paren
r_return
id|i
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|br_port_cost
r_int
id|br_port_cost
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
multiline_comment|/* 4.10.2 */
(brace
r_if
c_cond
(paren
id|strncmp
c_func
(paren
id|dev-&gt;name
comma
l_string|&quot;eth&quot;
comma
l_int|3
)paren
op_eq
l_int|0
)paren
multiline_comment|/* ethernet */
r_return
l_int|100
suffix:semicolon
r_if
c_cond
(paren
id|strncmp
c_func
(paren
id|dev-&gt;name
comma
l_string|&quot;wic&quot;
comma
l_int|3
)paren
op_eq
l_int|0
)paren
multiline_comment|/* wic */
r_return
l_int|1600
suffix:semicolon
r_if
c_cond
(paren
id|strncmp
c_func
(paren
id|dev-&gt;name
comma
l_string|&quot;plip&quot;
comma
l_int|4
)paren
op_eq
l_int|0
)paren
multiline_comment|/* plip */
r_return
(paren
l_int|1600
)paren
suffix:semicolon
r_return
l_int|100
suffix:semicolon
multiline_comment|/* default */
)brace
multiline_comment|/*&n; * this routine always consumes the skb &n; */
DECL|function|br_bpdu
r_void
id|br_bpdu
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
)paren
multiline_comment|/* consumes skb */
(brace
id|Tcn_bpdu
op_star
id|bpdu
suffix:semicolon
r_int
id|port
suffix:semicolon
id|port
op_assign
id|find_port
c_func
(paren
id|skb-&gt;dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|port
op_eq
l_int|0
)paren
(brace
multiline_comment|/* unknown port */
id|br_drop
c_func
(paren
id|skb
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|bpdu
op_assign
(paren
id|Tcn_bpdu
op_star
)paren
id|skb-&gt;data
op_plus
id|ETH_HLEN
suffix:semicolon
r_switch
c_cond
(paren
id|bpdu-&gt;type
)paren
(brace
r_case
id|BPDU_TYPE_CONFIG
suffix:colon
id|received_config_bpdu
c_func
(paren
id|port
comma
(paren
id|Config_bpdu
op_star
)paren
id|bpdu
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|BPDU_TYPE_TOPO_CHANGE
suffix:colon
id|received_tcn_bpdu
c_func
(paren
id|port
comma
id|bpdu
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;br_bpdu: received unknown bpdu, type = %i&bslash;n&quot;
comma
id|bpdu-&gt;type
)paren
suffix:semicolon
multiline_comment|/* break; */
)brace
id|br_drop
c_func
(paren
id|skb
)paren
suffix:semicolon
)brace
DECL|function|br_ioctl
r_int
id|br_ioctl
c_func
(paren
r_int
r_int
id|cmd
comma
r_void
op_star
id|arg
)paren
(brace
r_int
id|err
suffix:semicolon
r_struct
id|br_cf
id|bcf
suffix:semicolon
r_switch
c_cond
(paren
id|cmd
)paren
(brace
r_case
id|SIOCGIFBR
suffix:colon
multiline_comment|/* get bridging control blocks */
id|memcpy
c_func
(paren
op_amp
id|br_stats.bridge_data
comma
op_amp
id|bridge_info
comma
r_sizeof
(paren
id|Bridge_data
)paren
)paren
suffix:semicolon
id|memcpy
c_func
(paren
op_amp
id|br_stats.port_data
comma
op_amp
id|port_info
comma
r_sizeof
(paren
id|Port_data
)paren
op_star
id|No_of_ports
)paren
suffix:semicolon
id|err
op_assign
id|copy_to_user
c_func
(paren
id|arg
comma
op_amp
id|br_stats
comma
r_sizeof
(paren
r_struct
id|br_stat
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
(brace
id|err
op_assign
op_minus
id|EFAULT
suffix:semicolon
)brace
r_return
id|err
suffix:semicolon
r_case
id|SIOCSIFBR
suffix:colon
r_if
c_cond
(paren
op_logical_neg
id|suser
c_func
(paren
)paren
)paren
r_return
op_minus
id|EPERM
suffix:semicolon
id|err
op_assign
id|copy_from_user
c_func
(paren
op_amp
id|bcf
comma
id|arg
comma
r_sizeof
(paren
r_struct
id|br_cf
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_switch
c_cond
(paren
id|bcf.cmd
)paren
(brace
r_case
id|BRCMD_BRIDGE_ENABLE
suffix:colon
r_if
c_cond
(paren
id|br_stats.flags
op_amp
id|BR_UP
)paren
r_return
op_minus
id|EALREADY
suffix:semicolon
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;br: enabling bridging function&bslash;n&quot;
)paren
suffix:semicolon
id|br_stats.flags
op_or_assign
id|BR_UP
suffix:semicolon
multiline_comment|/* enable bridge */
id|start_hello_timer
c_func
(paren
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|BRCMD_BRIDGE_DISABLE
suffix:colon
r_if
c_cond
(paren
op_logical_neg
(paren
id|br_stats.flags
op_amp
id|BR_UP
)paren
)paren
r_return
op_minus
id|EALREADY
suffix:semicolon
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;br: disabling bridging function&bslash;n&quot;
)paren
suffix:semicolon
id|br_stats.flags
op_and_assign
op_complement
id|BR_UP
suffix:semicolon
multiline_comment|/* disable bridge */
id|stop_hello_timer
c_func
(paren
)paren
suffix:semicolon
macro_line|#if 0&t;&t;&t;&t;&t;
r_for
c_loop
(paren
id|i
op_assign
id|One
suffix:semicolon
id|i
op_le
id|No_of_ports
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
id|port_info
(braket
id|i
)braket
dot
id|state
op_ne
id|Disabled
)paren
id|disable_port
c_func
(paren
id|i
)paren
suffix:semicolon
macro_line|#endif&t;&t;&t;&t;&t;&t;&t;
r_break
suffix:semicolon
r_case
id|BRCMD_PORT_ENABLE
suffix:colon
r_if
c_cond
(paren
id|port_info
(braket
id|bcf.arg1
)braket
dot
id|dev
op_eq
l_int|0
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|port_info
(braket
id|bcf.arg1
)braket
dot
id|state
op_ne
id|Disabled
)paren
r_return
op_minus
id|EALREADY
suffix:semicolon
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;br: enabling port %i&bslash;n&quot;
comma
id|bcf.arg1
)paren
suffix:semicolon
id|enable_port
c_func
(paren
id|bcf.arg1
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|BRCMD_PORT_DISABLE
suffix:colon
r_if
c_cond
(paren
id|port_info
(braket
id|bcf.arg1
)braket
dot
id|dev
op_eq
l_int|0
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|port_info
(braket
id|bcf.arg1
)braket
dot
id|state
op_eq
id|Disabled
)paren
r_return
op_minus
id|EALREADY
suffix:semicolon
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;br: disabling port %i&bslash;n&quot;
comma
id|bcf.arg1
)paren
suffix:semicolon
id|disable_port
c_func
(paren
id|bcf.arg1
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|BRCMD_SET_BRIDGE_PRIORITY
suffix:colon
id|set_bridge_priority
c_func
(paren
(paren
id|bridge_id_t
op_star
)paren
op_amp
id|bcf.arg1
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|BRCMD_SET_PORT_PRIORITY
suffix:colon
r_if
c_cond
(paren
id|port_info
(braket
id|bcf.arg1
)braket
dot
id|dev
op_eq
l_int|0
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|set_port_priority
c_func
(paren
id|bcf.arg1
comma
id|bcf.arg2
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|BRCMD_SET_PATH_COST
suffix:colon
r_if
c_cond
(paren
id|port_info
(braket
id|bcf.arg1
)braket
dot
id|dev
op_eq
l_int|0
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|set_path_cost
c_func
(paren
id|bcf.arg1
comma
id|bcf.arg2
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|BRCMD_ENABLE_DEBUG
suffix:colon
id|br_stats.flags
op_or_assign
id|BR_DEBUG
suffix:semicolon
r_break
suffix:semicolon
r_case
id|BRCMD_DISABLE_DEBUG
suffix:colon
id|br_stats.flags
op_and_assign
op_complement
id|BR_DEBUG
suffix:semicolon
r_break
suffix:semicolon
r_case
id|BRCMD_SET_POLICY
suffix:colon
r_return
id|br_set_policy
c_func
(paren
id|bcf.arg1
)paren
suffix:semicolon
r_case
id|BRCMD_EXEMPT_PROTOCOL
suffix:colon
r_return
id|br_add_exempt_protocol
c_func
(paren
id|bcf.arg1
)paren
suffix:semicolon
r_case
id|BRCMD_ENABLE_PROT_STATS
suffix:colon
id|br_stats.flags
op_or_assign
id|BR_PROT_STATS
suffix:semicolon
r_break
suffix:semicolon
r_case
id|BRCMD_DISABLE_PROT_STATS
suffix:colon
id|br_stats.flags
op_and_assign
op_complement
id|BR_PROT_STATS
suffix:semicolon
r_break
suffix:semicolon
r_case
id|BRCMD_ZERO_PROT_STATS
suffix:colon
id|memset
c_func
(paren
op_amp
id|br_stats.prot_id
comma
l_int|0
comma
r_sizeof
(paren
id|br_stats.prot_id
)paren
)paren
suffix:semicolon
id|memset
c_func
(paren
op_amp
id|br_stats.prot_counter
comma
l_int|0
comma
r_sizeof
(paren
id|br_stats.prot_counter
)paren
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
r_default
suffix:colon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
multiline_comment|/*NOTREACHED*/
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|br_cmp
r_int
id|br_cmp
c_func
(paren
r_int
r_int
op_star
id|a
comma
r_int
r_int
op_star
id|b
)paren
(brace
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|2
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|a
(braket
id|i
)braket
op_eq
id|b
(braket
id|i
)braket
)paren
r_continue
suffix:semicolon
r_if
c_cond
(paren
id|a
(braket
id|i
)braket
OL
id|b
(braket
id|i
)braket
)paren
r_return
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|a
(braket
id|i
)braket
OG
id|b
(braket
id|i
)braket
)paren
r_return
op_minus
l_int|1
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
eof
