multiline_comment|/*&n; *&t;This module implements the (SPP-derived) Sequenced Packet eXchange&n; *&t;(SPX) protocol for Linux 2.1.X as specified in&n; *&t;&t;NetWare SPX Services Specification, Semantics and API&n; *&t;&t; Revision:       1.00&n; *&t;&t; Revision Date:  February 9, 1993&n; *&n; *&t;Developers:&n; *      Jay Schulist    &lt;jschlst@turbolinux.com&gt;&n; *&t;Jim Freeman&t;&lt;jfree@caldera.com&gt;&n; *&n; *&t;Changes:&n; *&t;Alan Cox&t;:&t;Fixed an skb_unshare check for NULL&n; *&t;&t;&t;&t;that crashed it under load. Renamed and&n; *&t;&t;&t;&t;made static the ipx ops. Removed the hack&n; *&t;&t;&t;&t;ipx methods interface. Dropped AF_SPX - its&n; *&t;&t;&t;&t;the wrong abstraction.&n; *&t;Eduardo Trapani&t;:&t;Added a check for the return value of&n; *&t;&t;&t;&t;ipx_if_offset that crashed sock_alloc_send_skb.&n; *&t;&t;&t;&t;Added spx_datagram_poll() so that select()&n; *&t;&t;&t;&t;works now on SPX sockets.  Added updating&n; *&t;&t;&t;&t;of the alloc count to follow rmt_seq.&n; *&n; *&t;This program is free software; you can redistribute it and/or&n; *      modify it under the terms of the GNU General Public License&n; *      as published by the Free Software Foundation; either version&n; *      2 of the License, or (at your option) any later version.&n; *&n; *&t;None of the authors or maintainers or their employers admit&n; *&t;liability nor provide warranty for any of this software.&n; *&t;This material is provided &quot;as is&quot; and at no charge.&n; */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#if defined(CONFIG_SPX) || defined(CONFIG_SPX_MODULE)
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;net/ipx.h&gt;
macro_line|#include &lt;net/spx.h&gt;
macro_line|#include &lt;net/sock.h&gt;
macro_line|#include &lt;asm/byteorder.h&gt;
macro_line|#include &lt;asm/uaccess.h&gt;
macro_line|#include &lt;linux/uio.h&gt;
macro_line|#include &lt;linux/unistd.h&gt;
macro_line|#include &lt;linux/poll.h&gt;
DECL|variable|ipx_operations
r_static
r_struct
id|proto_ops
op_star
id|ipx_operations
suffix:semicolon
DECL|variable|spx_ops
r_static
r_struct
id|proto_ops
id|spx_ops
suffix:semicolon
DECL|variable|connids
r_static
id|__u16
id|connids
suffix:semicolon
multiline_comment|/* Functions needed for SPX connection start up */
r_static
r_int
id|spx_transmit
c_func
(paren
r_struct
id|sock
op_star
id|sk
comma
r_struct
id|sk_buff
op_star
id|skb
comma
r_int
id|type
comma
r_int
id|len
)paren
suffix:semicolon
r_static
r_void
id|spx_retransmit
c_func
(paren
r_int
r_int
id|data
)paren
suffix:semicolon
r_static
r_void
id|spx_watchdog
c_func
(paren
r_int
r_int
id|data
)paren
suffix:semicolon
r_void
id|spx_rcv
c_func
(paren
r_struct
id|sock
op_star
id|sk
comma
r_int
id|bytes
)paren
suffix:semicolon
r_extern
r_void
id|ipx_remove_socket
c_func
(paren
r_struct
id|sock
op_star
id|sk
)paren
suffix:semicolon
multiline_comment|/* Datagram poll:&t;the same code as datagram_poll() in net/core&n;&t;&t;&t;but the right spx buffers are looked at and&n;&t;&t;&t;there is no question on the type of the socket&n;&t;&t;&t;*/
DECL|function|spx_datagram_poll
r_static
r_int
r_int
id|spx_datagram_poll
c_func
(paren
r_struct
id|file
op_star
id|file
comma
r_struct
id|socket
op_star
id|sock
comma
id|poll_table
op_star
id|wait
)paren
(brace
r_struct
id|sock
op_star
id|sk
op_assign
id|sock-&gt;sk
suffix:semicolon
r_struct
id|spx_opt
op_star
id|pdata
op_assign
op_amp
id|sk-&gt;tp_pinfo.af_spx
suffix:semicolon
r_int
r_int
id|mask
suffix:semicolon
id|poll_wait
c_func
(paren
id|file
comma
id|sk-&gt;sleep
comma
id|wait
)paren
suffix:semicolon
id|mask
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* exceptional events? */
r_if
c_cond
(paren
id|sk-&gt;err
op_logical_or
op_logical_neg
id|skb_queue_empty
c_func
(paren
op_amp
id|sk-&gt;error_queue
)paren
)paren
id|mask
op_or_assign
id|POLLERR
suffix:semicolon
r_if
c_cond
(paren
id|sk-&gt;shutdown
op_amp
id|RCV_SHUTDOWN
)paren
id|mask
op_or_assign
id|POLLHUP
suffix:semicolon
multiline_comment|/* readable? */
r_if
c_cond
(paren
op_logical_neg
id|skb_queue_empty
c_func
(paren
op_amp
id|pdata-&gt;rcv_queue
)paren
)paren
id|mask
op_or_assign
id|POLLIN
op_or
id|POLLRDNORM
suffix:semicolon
multiline_comment|/* Need to check for termination and startup */
r_if
c_cond
(paren
id|sk-&gt;state
op_eq
id|TCP_CLOSE
)paren
id|mask
op_or_assign
id|POLLHUP
suffix:semicolon
multiline_comment|/* connection hasn&squot;t started yet? */
r_if
c_cond
(paren
id|sk-&gt;state
op_eq
id|TCP_SYN_SENT
)paren
r_return
id|mask
suffix:semicolon
multiline_comment|/* writable? */
r_if
c_cond
(paren
id|sock_writeable
c_func
(paren
id|sk
)paren
)paren
id|mask
op_or_assign
id|POLLOUT
op_or
id|POLLWRNORM
op_or
id|POLLWRBAND
suffix:semicolon
r_else
id|set_bit
c_func
(paren
id|SOCK_ASYNC_NOSPACE
comma
op_amp
id|sk-&gt;socket-&gt;flags
)paren
suffix:semicolon
r_return
id|mask
suffix:semicolon
)brace
multiline_comment|/* Create the SPX specific data */
DECL|function|spx_sock_init
r_static
r_int
id|spx_sock_init
c_func
(paren
r_struct
id|sock
op_star
id|sk
)paren
(brace
r_struct
id|spx_opt
op_star
id|pdata
op_assign
op_amp
id|sk-&gt;tp_pinfo.af_spx
suffix:semicolon
id|pdata-&gt;state
op_assign
id|SPX_CLOSED
suffix:semicolon
id|pdata-&gt;sequence
op_assign
l_int|0
suffix:semicolon
id|pdata-&gt;acknowledge
op_assign
l_int|0
suffix:semicolon
id|pdata-&gt;source_connid
op_assign
id|htons
c_func
(paren
id|connids
)paren
suffix:semicolon
id|pdata-&gt;rmt_seq
op_assign
l_int|0
suffix:semicolon
id|connids
op_increment
suffix:semicolon
id|pdata-&gt;owner
op_assign
(paren
r_void
op_star
)paren
id|sk
suffix:semicolon
id|pdata-&gt;sndbuf
op_assign
id|sk-&gt;sndbuf
suffix:semicolon
id|pdata-&gt;watchdog.function
op_assign
id|spx_watchdog
suffix:semicolon
id|pdata-&gt;watchdog.data
op_assign
(paren
r_int
r_int
)paren
id|sk
suffix:semicolon
id|pdata-&gt;wd_interval
op_assign
id|VERIFY_TIMEOUT
suffix:semicolon
id|pdata-&gt;retransmit.function
op_assign
id|spx_retransmit
suffix:semicolon
id|pdata-&gt;retransmit.data
op_assign
(paren
r_int
r_int
)paren
id|sk
suffix:semicolon
id|pdata-&gt;retransmits
op_assign
l_int|0
suffix:semicolon
id|pdata-&gt;retries
op_assign
l_int|0
suffix:semicolon
id|pdata-&gt;max_retries
op_assign
id|RETRY_COUNT
suffix:semicolon
id|skb_queue_head_init
c_func
(paren
op_amp
id|pdata-&gt;rcv_queue
)paren
suffix:semicolon
id|skb_queue_head_init
c_func
(paren
op_amp
id|pdata-&gt;transmit_queue
)paren
suffix:semicolon
id|skb_queue_head_init
c_func
(paren
op_amp
id|pdata-&gt;retransmit_queue
)paren
suffix:semicolon
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
DECL|function|spx_create
r_static
r_int
id|spx_create
c_func
(paren
r_struct
id|socket
op_star
id|sock
comma
r_int
id|protocol
)paren
(brace
r_struct
id|sock
op_star
id|sk
suffix:semicolon
multiline_comment|/*&n;&t; *&t;Called on connection receive so cannot be GFP_KERNEL&n;&t; */
id|sk
op_assign
id|sk_alloc
c_func
(paren
id|PF_IPX
comma
id|GFP_ATOMIC
comma
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sk
op_eq
l_int|NULL
)paren
(brace
r_return
(paren
op_minus
id|ENOMEM
)paren
suffix:semicolon
)brace
r_switch
c_cond
(paren
id|sock-&gt;type
)paren
(brace
r_case
id|SOCK_SEQPACKET
suffix:colon
id|sock-&gt;ops
op_assign
op_amp
id|spx_ops
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|sk_free
c_func
(paren
id|sk
)paren
suffix:semicolon
r_return
(paren
op_minus
id|ESOCKTNOSUPPORT
)paren
suffix:semicolon
)brace
id|sock_init_data
c_func
(paren
id|sock
comma
id|sk
)paren
suffix:semicolon
id|spx_sock_init
c_func
(paren
id|sk
)paren
suffix:semicolon
id|sk-&gt;data_ready
op_assign
id|spx_rcv
suffix:semicolon
id|sk-&gt;destruct
op_assign
l_int|NULL
suffix:semicolon
id|sk-&gt;no_check
op_assign
l_int|1
suffix:semicolon
id|MOD_INC_USE_COUNT
suffix:semicolon
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
DECL|function|spx_close_socket
r_void
id|spx_close_socket
c_func
(paren
r_struct
id|sock
op_star
id|sk
)paren
(brace
r_struct
id|spx_opt
op_star
id|pdata
op_assign
op_amp
id|sk-&gt;tp_pinfo.af_spx
suffix:semicolon
id|pdata-&gt;state
op_assign
id|SPX_CLOSED
suffix:semicolon
id|sk-&gt;state
op_assign
id|TCP_CLOSE
suffix:semicolon
id|del_timer
c_func
(paren
op_amp
id|pdata-&gt;retransmit
)paren
suffix:semicolon
id|del_timer
c_func
(paren
op_amp
id|pdata-&gt;watchdog
)paren
suffix:semicolon
)brace
DECL|function|spx_destroy_socket
r_void
id|spx_destroy_socket
c_func
(paren
r_struct
id|sock
op_star
id|sk
)paren
(brace
r_struct
id|spx_opt
op_star
id|pdata
op_assign
op_amp
id|sk-&gt;tp_pinfo.af_spx
suffix:semicolon
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
id|ipx_remove_socket
c_func
(paren
id|sk
)paren
suffix:semicolon
r_while
c_loop
(paren
(paren
id|skb
op_assign
id|skb_dequeue
c_func
(paren
op_amp
id|sk-&gt;receive_queue
)paren
)paren
op_ne
l_int|NULL
)paren
(brace
id|kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
(paren
id|skb
op_assign
id|skb_dequeue
c_func
(paren
op_amp
id|pdata-&gt;transmit_queue
)paren
)paren
op_ne
l_int|NULL
)paren
(brace
id|kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
(paren
id|skb
op_assign
id|skb_dequeue
c_func
(paren
op_amp
id|pdata-&gt;retransmit_queue
)paren
)paren
op_ne
l_int|NULL
)paren
(brace
id|kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
(paren
id|skb
op_assign
id|skb_dequeue
c_func
(paren
op_amp
id|pdata-&gt;rcv_queue
)paren
)paren
op_ne
l_int|NULL
)paren
(brace
id|kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
)brace
id|sk_free
c_func
(paren
id|sk
)paren
suffix:semicolon
id|MOD_DEC_USE_COUNT
suffix:semicolon
)brace
multiline_comment|/* Release an SPX socket */
DECL|function|spx_release
r_static
r_int
id|spx_release
c_func
(paren
r_struct
id|socket
op_star
id|sock
)paren
(brace
r_struct
id|sock
op_star
id|sk
op_assign
id|sock-&gt;sk
suffix:semicolon
r_struct
id|spx_opt
op_star
id|pdata
op_assign
op_amp
id|sk-&gt;tp_pinfo.af_spx
suffix:semicolon
r_if
c_cond
(paren
id|sk
op_eq
l_int|NULL
)paren
(brace
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|sk-&gt;dead
)paren
(brace
id|sk
op_member_access_from_pointer
id|state_change
c_func
(paren
id|sk
)paren
suffix:semicolon
)brace
id|sk-&gt;dead
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|pdata-&gt;state
op_ne
id|SPX_CLOSED
)paren
(brace
id|spx_transmit
c_func
(paren
id|sk
comma
l_int|NULL
comma
id|DISCON
comma
l_int|0
)paren
suffix:semicolon
id|spx_close_socket
c_func
(paren
id|sk
)paren
suffix:semicolon
)brace
id|sock-&gt;sk
op_assign
l_int|NULL
suffix:semicolon
id|sk-&gt;socket
op_assign
l_int|NULL
suffix:semicolon
id|spx_destroy_socket
c_func
(paren
id|sk
)paren
suffix:semicolon
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
multiline_comment|/* Move a socket into listening state. */
DECL|function|spx_listen
r_static
r_int
id|spx_listen
c_func
(paren
r_struct
id|socket
op_star
id|sock
comma
r_int
id|backlog
)paren
(brace
r_struct
id|sock
op_star
id|sk
op_assign
id|sock-&gt;sk
suffix:semicolon
r_if
c_cond
(paren
id|sock-&gt;state
op_ne
id|SS_UNCONNECTED
)paren
(brace
r_return
(paren
op_minus
id|EINVAL
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|sock-&gt;type
op_ne
id|SOCK_SEQPACKET
)paren
(brace
r_return
(paren
op_minus
id|EOPNOTSUPP
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|sk-&gt;zapped
op_ne
l_int|0
)paren
(brace
r_return
(paren
op_minus
id|EAGAIN
)paren
suffix:semicolon
)brace
id|sk-&gt;max_ack_backlog
op_assign
id|backlog
suffix:semicolon
r_if
c_cond
(paren
id|sk-&gt;state
op_ne
id|TCP_LISTEN
)paren
(brace
id|sk-&gt;ack_backlog
op_assign
l_int|0
suffix:semicolon
id|sk-&gt;state
op_assign
id|TCP_LISTEN
suffix:semicolon
)brace
id|sk-&gt;socket-&gt;flags
op_or_assign
id|__SO_ACCEPTCON
suffix:semicolon
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
multiline_comment|/* Accept a pending SPX connection */
DECL|function|spx_accept
r_static
r_int
id|spx_accept
c_func
(paren
r_struct
id|socket
op_star
id|sock
comma
r_struct
id|socket
op_star
id|newsock
comma
r_int
id|flags
)paren
(brace
r_struct
id|sock
op_star
id|sk
suffix:semicolon
r_struct
id|sock
op_star
id|newsk
suffix:semicolon
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
r_int
id|err
suffix:semicolon
r_if
c_cond
(paren
id|sock-&gt;sk
op_eq
l_int|NULL
)paren
(brace
r_return
(paren
op_minus
id|EINVAL
)paren
suffix:semicolon
)brace
id|sk
op_assign
id|sock-&gt;sk
suffix:semicolon
r_if
c_cond
(paren
(paren
id|sock-&gt;state
op_ne
id|SS_UNCONNECTED
)paren
op_logical_or
op_logical_neg
(paren
id|sock-&gt;flags
op_amp
id|__SO_ACCEPTCON
)paren
)paren
(brace
r_return
(paren
op_minus
id|EINVAL
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|sock-&gt;type
op_ne
id|SOCK_SEQPACKET
)paren
(brace
r_return
(paren
op_minus
id|EOPNOTSUPP
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|sk-&gt;state
op_ne
id|TCP_LISTEN
)paren
(brace
r_return
(paren
op_minus
id|EINVAL
)paren
suffix:semicolon
)brace
id|cli
c_func
(paren
)paren
suffix:semicolon
r_do
(brace
id|skb
op_assign
id|skb_dequeue
c_func
(paren
op_amp
id|sk-&gt;receive_queue
)paren
suffix:semicolon
r_if
c_cond
(paren
id|skb
op_eq
l_int|NULL
)paren
(brace
r_if
c_cond
(paren
id|flags
op_amp
id|O_NONBLOCK
)paren
(brace
id|sti
c_func
(paren
)paren
suffix:semicolon
r_return
(paren
op_minus
id|EWOULDBLOCK
)paren
suffix:semicolon
)brace
id|interruptible_sleep_on
c_func
(paren
id|sk-&gt;sleep
)paren
suffix:semicolon
r_if
c_cond
(paren
id|signal_pending
c_func
(paren
id|current
)paren
)paren
(brace
id|sti
c_func
(paren
)paren
suffix:semicolon
r_return
(paren
op_minus
id|ERESTARTSYS
)paren
suffix:semicolon
)brace
)brace
)brace
r_while
c_loop
(paren
id|skb
op_eq
l_int|NULL
)paren
suffix:semicolon
id|newsk
op_assign
id|skb-&gt;sk
suffix:semicolon
id|newsk-&gt;pair
op_assign
l_int|NULL
suffix:semicolon
id|sti
c_func
(paren
)paren
suffix:semicolon
id|err
op_assign
id|spx_transmit
c_func
(paren
id|newsk
comma
id|skb
comma
id|CONACK
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* Connection ACK */
r_if
c_cond
(paren
id|err
)paren
(brace
r_return
(paren
id|err
)paren
suffix:semicolon
)brace
multiline_comment|/* Now attach up the new socket */
id|sock-&gt;sk
op_assign
l_int|NULL
suffix:semicolon
id|sk-&gt;ack_backlog
op_decrement
suffix:semicolon
id|newsock-&gt;sk
op_assign
id|newsk
suffix:semicolon
id|newsk-&gt;state
op_assign
id|TCP_ESTABLISHED
suffix:semicolon
id|newsk-&gt;protinfo.af_ipx.dest_addr
op_assign
id|newsk-&gt;tp_pinfo.af_spx.dest_addr
suffix:semicolon
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
multiline_comment|/* Build a connection to an SPX socket */
DECL|function|spx_connect
r_static
r_int
id|spx_connect
c_func
(paren
r_struct
id|socket
op_star
id|sock
comma
r_struct
id|sockaddr
op_star
id|uaddr
comma
r_int
id|addr_len
comma
r_int
id|flags
)paren
(brace
r_struct
id|sock
op_star
id|sk
op_assign
id|sock-&gt;sk
suffix:semicolon
r_struct
id|spx_opt
op_star
id|pdata
op_assign
op_amp
id|sk-&gt;tp_pinfo.af_spx
suffix:semicolon
r_struct
id|sockaddr_ipx
id|src
suffix:semicolon
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
r_int
id|size
comma
id|err
suffix:semicolon
id|size
op_assign
r_sizeof
(paren
id|src
)paren
suffix:semicolon
id|err
op_assign
id|ipx_operations
op_member_access_from_pointer
id|getname
c_func
(paren
id|sock
comma
(paren
r_struct
id|sockaddr
op_star
)paren
op_amp
id|src
comma
op_amp
id|size
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
(brace
r_return
(paren
id|err
)paren
suffix:semicolon
)brace
id|pdata-&gt;source_addr.net
op_assign
id|src.sipx_network
suffix:semicolon
id|memcpy
c_func
(paren
id|pdata-&gt;source_addr.node
comma
id|src.sipx_node
comma
id|IPX_NODE_LEN
)paren
suffix:semicolon
id|pdata-&gt;source_addr.sock
op_assign
(paren
r_int
r_int
)paren
id|src.sipx_port
suffix:semicolon
id|err
op_assign
id|ipx_operations
op_member_access_from_pointer
id|connect
c_func
(paren
id|sock
comma
id|uaddr
comma
id|addr_len
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
(brace
r_return
(paren
id|err
)paren
suffix:semicolon
)brace
id|pdata-&gt;dest_addr
op_assign
id|sk-&gt;protinfo.af_ipx.dest_addr
suffix:semicolon
id|pdata-&gt;state
op_assign
id|SPX_CONNECTING
suffix:semicolon
id|sock-&gt;state
op_assign
id|SS_CONNECTING
suffix:semicolon
id|sk-&gt;state
op_assign
id|TCP_SYN_SENT
suffix:semicolon
multiline_comment|/* Send Connection request */
id|err
op_assign
id|spx_transmit
c_func
(paren
id|sk
comma
l_int|NULL
comma
id|CONREQ
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
(brace
r_return
(paren
id|err
)paren
suffix:semicolon
)brace
id|cli
c_func
(paren
)paren
suffix:semicolon
r_do
(brace
id|skb
op_assign
id|skb_dequeue
c_func
(paren
op_amp
id|sk-&gt;receive_queue
)paren
suffix:semicolon
r_if
c_cond
(paren
id|skb
op_eq
l_int|NULL
)paren
(brace
r_if
c_cond
(paren
id|flags
op_amp
id|O_NONBLOCK
)paren
(brace
id|sti
c_func
(paren
)paren
suffix:semicolon
r_return
(paren
op_minus
id|EWOULDBLOCK
)paren
suffix:semicolon
)brace
id|interruptible_sleep_on
c_func
(paren
id|sk-&gt;sleep
)paren
suffix:semicolon
r_if
c_cond
(paren
id|signal_pending
c_func
(paren
id|current
)paren
)paren
(brace
id|sti
c_func
(paren
)paren
suffix:semicolon
r_return
(paren
op_minus
id|ERESTARTSYS
)paren
suffix:semicolon
)brace
)brace
)brace
r_while
c_loop
(paren
id|skb
op_eq
l_int|NULL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pdata-&gt;state
op_eq
id|SPX_CLOSED
)paren
(brace
id|sti
c_func
(paren
)paren
suffix:semicolon
id|del_timer
c_func
(paren
op_amp
id|pdata-&gt;watchdog
)paren
suffix:semicolon
r_return
(paren
op_minus
id|ETIMEDOUT
)paren
suffix:semicolon
)brace
id|sock-&gt;state
op_assign
id|SS_CONNECTED
suffix:semicolon
id|sk-&gt;state
op_assign
id|TCP_ESTABLISHED
suffix:semicolon
id|kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
id|sti
c_func
(paren
)paren
suffix:semicolon
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Calculate the timeout for a packet. Thankfully SPX has a large&n; * fudge factor (3/4 secs) and does not pay much attention to RTT.&n; * As we simply have a default retry time of 1*HZ and a max retry&n; * time of 5*HZ. Between those values we increase the timeout based&n; * on the number of retransmit tries.&n; *&n; * FixMe: This is quite fake, but will work for now. (JS)&n; */
DECL|function|spx_calc_rtt
r_static
r_inline
r_int
r_int
id|spx_calc_rtt
c_func
(paren
r_int
id|tries
)paren
(brace
r_if
c_cond
(paren
id|tries
OL
l_int|1
)paren
(brace
r_return
(paren
id|RETRY_TIME
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|tries
OG
l_int|5
)paren
(brace
r_return
(paren
id|MAX_RETRY_DELAY
)paren
suffix:semicolon
)brace
r_return
(paren
id|tries
op_star
id|HZ
)paren
suffix:semicolon
)brace
DECL|function|spx_route_skb
r_static
r_int
id|spx_route_skb
c_func
(paren
r_struct
id|spx_opt
op_star
id|pdata
comma
r_struct
id|sk_buff
op_star
id|skb
comma
r_int
id|type
)paren
(brace
r_struct
id|sk_buff
op_star
id|skb2
suffix:semicolon
r_int
id|err
op_assign
l_int|0
suffix:semicolon
id|skb
op_assign
id|skb_unshare
c_func
(paren
id|skb
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
id|skb
op_eq
l_int|NULL
)paren
(brace
r_return
(paren
op_minus
id|ENOBUFS
)paren
suffix:semicolon
)brace
r_switch
c_cond
(paren
id|type
)paren
(brace
r_case
(paren
id|CONREQ
)paren
suffix:colon
r_case
(paren
id|DATA
)paren
suffix:colon
r_if
c_cond
(paren
op_logical_neg
id|skb_queue_empty
c_func
(paren
op_amp
id|pdata-&gt;retransmit_queue
)paren
)paren
(brace
id|skb_queue_tail
c_func
(paren
op_amp
id|pdata-&gt;transmit_queue
comma
id|skb
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_case
(paren
id|TQUEUE
)paren
suffix:colon
id|pdata-&gt;retransmit.expires
op_assign
id|jiffies
op_plus
id|spx_calc_rtt
c_func
(paren
l_int|0
)paren
suffix:semicolon
id|add_timer
c_func
(paren
op_amp
id|pdata-&gt;retransmit
)paren
suffix:semicolon
id|skb2
op_assign
id|skb_clone
c_func
(paren
id|skb
comma
id|GFP_BUFFER
)paren
suffix:semicolon
r_if
c_cond
(paren
id|skb2
op_eq
l_int|NULL
)paren
(brace
r_return
op_minus
id|ENOBUFS
suffix:semicolon
)brace
id|skb_queue_tail
c_func
(paren
op_amp
id|pdata-&gt;retransmit_queue
comma
id|skb2
)paren
suffix:semicolon
r_case
(paren
id|ACK
)paren
suffix:colon
r_case
(paren
id|CONACK
)paren
suffix:colon
r_case
(paren
id|WDREQ
)paren
suffix:colon
r_case
(paren
id|WDACK
)paren
suffix:colon
r_case
(paren
id|DISCON
)paren
suffix:colon
r_case
(paren
id|DISACK
)paren
suffix:colon
r_case
(paren
id|RETRAN
)paren
suffix:colon
r_default
suffix:colon
multiline_comment|/* Send data */
id|err
op_assign
id|ipxrtr_route_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
(brace
id|kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
)brace
)brace
r_return
(paren
id|err
)paren
suffix:semicolon
)brace
multiline_comment|/* SPX packet transmit engine */
DECL|function|spx_transmit
r_static
r_int
id|spx_transmit
c_func
(paren
r_struct
id|sock
op_star
id|sk
comma
r_struct
id|sk_buff
op_star
id|skb
comma
r_int
id|type
comma
r_int
id|len
)paren
(brace
r_struct
id|spx_opt
op_star
id|pdata
op_assign
op_amp
id|sk-&gt;tp_pinfo.af_spx
suffix:semicolon
r_struct
id|ipxspxhdr
op_star
id|ipxh
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_int
id|err
suffix:semicolon
r_if
c_cond
(paren
id|skb
op_eq
l_int|NULL
)paren
(brace
r_int
id|offset
op_assign
id|ipx_if_offset
c_func
(paren
id|pdata-&gt;dest_addr.net
)paren
suffix:semicolon
r_int
id|size
op_assign
id|offset
op_plus
r_sizeof
(paren
r_struct
id|ipxspxhdr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|offset
OL
l_int|0
)paren
multiline_comment|/* ENETUNREACH */
r_return
op_minus
id|ENETUNREACH
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|skb
op_assign
id|sock_alloc_send_skb
c_func
(paren
id|sk
comma
id|size
comma
l_int|1
comma
l_int|0
comma
op_amp
id|err
)paren
suffix:semicolon
r_if
c_cond
(paren
id|skb
op_eq
l_int|NULL
)paren
(brace
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
(paren
op_minus
id|ENOMEM
)paren
suffix:semicolon
)brace
id|skb_reserve
c_func
(paren
id|skb
comma
id|offset
)paren
suffix:semicolon
id|skb-&gt;h.raw
op_assign
id|skb-&gt;nh.raw
op_assign
id|skb_put
c_func
(paren
id|skb
comma
r_sizeof
(paren
r_struct
id|ipxspxhdr
)paren
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
multiline_comment|/* IPX header */
id|ipxh
op_assign
(paren
r_struct
id|ipxspxhdr
op_star
)paren
id|skb-&gt;nh.raw
suffix:semicolon
id|ipxh-&gt;ipx.ipx_checksum
op_assign
l_int|0xFFFF
suffix:semicolon
id|ipxh-&gt;ipx.ipx_pktsize
op_assign
id|htons
c_func
(paren
id|SPX_SYS_PKT_LEN
)paren
suffix:semicolon
id|ipxh-&gt;ipx.ipx_tctrl
op_assign
l_int|0
suffix:semicolon
id|ipxh-&gt;ipx.ipx_type
op_assign
id|IPX_TYPE_SPX
suffix:semicolon
id|ipxh-&gt;ipx.ipx_dest
op_assign
id|pdata-&gt;dest_addr
suffix:semicolon
id|ipxh-&gt;ipx.ipx_source
op_assign
id|pdata-&gt;source_addr
suffix:semicolon
multiline_comment|/* SPX header */
id|ipxh-&gt;spx.dtype
op_assign
l_int|0
suffix:semicolon
id|ipxh-&gt;spx.sequence
op_assign
id|htons
c_func
(paren
id|pdata-&gt;sequence
)paren
suffix:semicolon
id|ipxh-&gt;spx.ackseq
op_assign
id|htons
c_func
(paren
id|pdata-&gt;rmt_seq
)paren
suffix:semicolon
id|ipxh-&gt;spx.sconn
op_assign
id|pdata-&gt;source_connid
suffix:semicolon
id|ipxh-&gt;spx.dconn
op_assign
id|pdata-&gt;dest_connid
suffix:semicolon
id|ipxh-&gt;spx.allocseq
op_assign
id|htons
c_func
(paren
id|pdata-&gt;alloc
)paren
suffix:semicolon
multiline_comment|/* Reset/Set WD timer */
id|mod_timer
c_func
(paren
op_amp
id|pdata-&gt;watchdog
comma
id|jiffies
op_plus
id|VERIFY_TIMEOUT
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|type
)paren
(brace
r_case
(paren
id|DATA
)paren
suffix:colon
multiline_comment|/* Data */
id|ipxh-&gt;ipx.ipx_pktsize
op_assign
id|htons
c_func
(paren
id|SPX_SYS_PKT_LEN
op_plus
id|len
)paren
suffix:semicolon
id|ipxh-&gt;spx.cctl
op_assign
(paren
id|CCTL_ACK
op_or
id|CCTL_EOM
)paren
suffix:semicolon
id|pdata-&gt;sequence
op_increment
suffix:semicolon
r_break
suffix:semicolon
r_case
(paren
id|ACK
)paren
suffix:colon
multiline_comment|/* ACK */
id|pdata-&gt;rmt_seq
op_increment
suffix:semicolon
r_case
(paren
id|WDACK
)paren
suffix:colon
multiline_comment|/* WD ACK */
r_case
(paren
id|CONACK
)paren
suffix:colon
multiline_comment|/* Connection ACK */
id|ipxh-&gt;spx.cctl
op_assign
id|CCTL_SYS
suffix:semicolon
id|ipxh-&gt;spx.ackseq
op_assign
id|htons
c_func
(paren
id|pdata-&gt;rmt_seq
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
(paren
id|CONREQ
)paren
suffix:colon
multiline_comment|/* Connection Request */
id|del_timer
c_func
(paren
op_amp
id|pdata-&gt;watchdog
)paren
suffix:semicolon
r_case
(paren
id|WDREQ
)paren
suffix:colon
multiline_comment|/* WD Request */
id|pdata-&gt;source_connid
op_assign
id|htons
c_func
(paren
id|connids
op_increment
)paren
suffix:semicolon
id|pdata-&gt;dest_connid
op_assign
l_int|0xFFFF
suffix:semicolon
id|pdata-&gt;alloc
op_assign
l_int|3
op_plus
id|pdata-&gt;rmt_seq
suffix:semicolon
id|ipxh-&gt;spx.cctl
op_assign
(paren
id|CCTL_ACK
op_or
id|CCTL_SYS
)paren
suffix:semicolon
id|ipxh-&gt;spx.sconn
op_assign
id|pdata-&gt;source_connid
suffix:semicolon
id|ipxh-&gt;spx.dconn
op_assign
id|pdata-&gt;dest_connid
suffix:semicolon
id|ipxh-&gt;spx.allocseq
op_assign
id|htons
c_func
(paren
id|pdata-&gt;alloc
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
(paren
id|DISCON
)paren
suffix:colon
multiline_comment|/* Informed Disconnect */
id|ipxh-&gt;spx.cctl
op_assign
id|CCTL_ACK
suffix:semicolon
id|ipxh-&gt;spx.dtype
op_assign
id|SPX_DTYPE_ECONN
suffix:semicolon
r_break
suffix:semicolon
r_case
(paren
id|DISACK
)paren
suffix:colon
multiline_comment|/* Informed Disconnect ACK */
id|ipxh-&gt;spx.cctl
op_assign
l_int|0
suffix:semicolon
id|ipxh-&gt;spx.dtype
op_assign
id|SPX_DTYPE_ECACK
suffix:semicolon
id|ipxh-&gt;spx.sequence
op_assign
l_int|0
suffix:semicolon
id|ipxh-&gt;spx.ackseq
op_assign
id|htons
c_func
(paren
id|pdata-&gt;rmt_seq
op_increment
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
r_return
(paren
op_minus
id|EOPNOTSUPP
)paren
suffix:semicolon
)brace
multiline_comment|/* Send data */
r_return
(paren
id|spx_route_skb
c_func
(paren
id|pdata
comma
id|skb
comma
id|type
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/* Check the state of the connection and send a WD request if needed. */
DECL|function|spx_watchdog
r_static
r_void
id|spx_watchdog
c_func
(paren
r_int
r_int
id|data
)paren
(brace
r_struct
id|sock
op_star
id|sk
op_assign
(paren
r_struct
id|sock
op_star
)paren
id|data
suffix:semicolon
r_struct
id|spx_opt
op_star
id|pdata
op_assign
op_amp
id|sk-&gt;tp_pinfo.af_spx
suffix:semicolon
id|del_timer
c_func
(paren
op_amp
id|pdata-&gt;watchdog
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pdata-&gt;state
op_eq
id|SPX_CLOSED
)paren
(brace
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|pdata-&gt;retries
OG
id|pdata-&gt;max_retries
)paren
(brace
id|spx_close_socket
c_func
(paren
id|sk
)paren
suffix:semicolon
multiline_comment|/* Unilateral Abort */
r_return
suffix:semicolon
)brace
multiline_comment|/* Send WD request */
id|spx_transmit
c_func
(paren
id|sk
comma
l_int|NULL
comma
id|WDREQ
comma
l_int|0
)paren
suffix:semicolon
id|pdata-&gt;retries
op_increment
suffix:semicolon
r_return
suffix:semicolon
)brace
DECL|function|spx_retransmit
r_static
r_void
id|spx_retransmit
c_func
(paren
r_int
r_int
id|data
)paren
(brace
r_struct
id|sock
op_star
id|sk
op_assign
(paren
r_struct
id|sock
op_star
)paren
id|data
suffix:semicolon
r_struct
id|spx_opt
op_star
id|pdata
op_assign
op_amp
id|sk-&gt;tp_pinfo.af_spx
suffix:semicolon
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_int
id|err
suffix:semicolon
id|del_timer
c_func
(paren
op_amp
id|pdata-&gt;retransmit
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pdata-&gt;state
op_eq
id|SPX_CLOSED
)paren
(brace
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|pdata-&gt;retransmits
OG
id|RETRY_COUNT
)paren
(brace
id|spx_close_socket
c_func
(paren
id|sk
)paren
suffix:semicolon
multiline_comment|/* Unilateral Abort */
r_return
suffix:semicolon
)brace
multiline_comment|/* Need to leave skb on the queue, aye the fear */
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|skb
op_assign
id|skb_peek
c_func
(paren
op_amp
id|pdata-&gt;retransmit_queue
)paren
suffix:semicolon
r_if
c_cond
(paren
id|skb_cloned
c_func
(paren
id|skb
)paren
)paren
(brace
id|skb
op_assign
id|skb_copy
c_func
(paren
id|skb
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
)brace
r_else
id|skb
op_assign
id|skb_clone
c_func
(paren
id|skb
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|pdata-&gt;retransmit.expires
op_assign
id|jiffies
op_plus
id|spx_calc_rtt
c_func
(paren
id|pdata-&gt;retransmits
)paren
suffix:semicolon
id|add_timer
c_func
(paren
op_amp
id|pdata-&gt;retransmit
)paren
suffix:semicolon
id|err
op_assign
id|spx_route_skb
c_func
(paren
id|pdata
comma
id|skb
comma
id|RETRAN
)paren
suffix:semicolon
id|pdata-&gt;retransmits
op_increment
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/* Check packet for retransmission, ConReqAck aware */
DECL|function|spx_retransmit_chk
r_static
r_int
id|spx_retransmit_chk
c_func
(paren
r_struct
id|spx_opt
op_star
id|pdata
comma
r_int
id|ackseq
comma
r_int
id|type
)paren
(brace
r_struct
id|ipxspxhdr
op_star
id|ipxh
suffix:semicolon
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
id|skb
op_assign
id|skb_dequeue
c_func
(paren
op_amp
id|pdata-&gt;retransmit_queue
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|skb
)paren
(brace
r_return
(paren
op_minus
id|ENOENT
)paren
suffix:semicolon
)brace
multiline_comment|/* Check Data/ACK seq */
r_switch
c_cond
(paren
id|type
)paren
(brace
r_case
id|ACK
suffix:colon
multiline_comment|/* Check Sequence, Should == 1 */
id|ipxh
op_assign
(paren
r_struct
id|ipxspxhdr
op_star
)paren
id|skb-&gt;nh.raw
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|ntohs
c_func
(paren
id|ipxh-&gt;spx.sequence
)paren
op_minus
id|htons
c_func
(paren
id|ackseq
)paren
)paren
)paren
(brace
r_break
suffix:semicolon
)brace
r_case
id|CONACK
suffix:colon
id|del_timer
c_func
(paren
op_amp
id|pdata-&gt;retransmit
)paren
suffix:semicolon
id|pdata-&gt;retransmits
op_assign
l_int|0
suffix:semicolon
id|kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
r_if
c_cond
(paren
id|skb_queue_empty
c_func
(paren
op_amp
id|pdata-&gt;retransmit_queue
)paren
)paren
(brace
id|skb
op_assign
id|skb_dequeue
c_func
(paren
op_amp
id|pdata-&gt;transmit_queue
)paren
suffix:semicolon
r_if
c_cond
(paren
id|skb
op_ne
l_int|NULL
)paren
(brace
id|spx_route_skb
c_func
(paren
id|pdata
comma
id|skb
comma
id|TQUEUE
)paren
suffix:semicolon
)brace
)brace
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
id|skb_queue_head
c_func
(paren
op_amp
id|pdata-&gt;retransmit_queue
comma
id|skb
)paren
suffix:semicolon
r_return
(paren
op_minus
l_int|1
)paren
suffix:semicolon
)brace
multiline_comment|/* SPX packet receive engine */
DECL|function|spx_rcv
r_void
id|spx_rcv
c_func
(paren
r_struct
id|sock
op_star
id|sk
comma
r_int
id|bytes
)paren
(brace
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
r_struct
id|ipxspxhdr
op_star
id|ipxh
suffix:semicolon
r_struct
id|spx_opt
op_star
id|pdata
op_assign
op_amp
id|sk-&gt;tp_pinfo.af_spx
suffix:semicolon
id|skb
op_assign
id|skb_dequeue
c_func
(paren
op_amp
id|sk-&gt;receive_queue
)paren
suffix:semicolon
r_if
c_cond
(paren
id|skb
op_eq
l_int|NULL
)paren
(brace
r_return
suffix:semicolon
)brace
id|ipxh
op_assign
(paren
r_struct
id|ipxspxhdr
op_star
)paren
id|skb-&gt;nh.raw
suffix:semicolon
multiline_comment|/* Can&squot;t receive on a closed connection */
r_if
c_cond
(paren
(paren
id|pdata-&gt;state
op_eq
id|SPX_CLOSED
)paren
op_logical_and
(paren
id|ipxh-&gt;spx.sequence
op_ne
l_int|0
)paren
)paren
(brace
r_goto
id|toss_skb
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ntohs
c_func
(paren
id|ipxh-&gt;ipx.ipx_pktsize
)paren
OL
id|SPX_SYS_PKT_LEN
)paren
(brace
r_goto
id|toss_skb
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ipxh-&gt;ipx.ipx_type
op_ne
id|IPX_TYPE_SPX
)paren
(brace
r_goto
id|toss_skb
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ntohs
c_func
(paren
id|ipxh-&gt;spx.ackseq
)paren
OG
id|pdata-&gt;sequence
)paren
(brace
r_goto
id|toss_skb
suffix:semicolon
)brace
multiline_comment|/* Reset WD timer on any received packet */
id|del_timer
c_func
(paren
op_amp
id|pdata-&gt;watchdog
)paren
suffix:semicolon
id|pdata-&gt;retries
op_assign
l_int|0
suffix:semicolon
id|pdata-&gt;watchdog.expires
op_assign
id|jiffies
op_plus
id|ABORT_TIMEOUT
suffix:semicolon
id|add_timer
c_func
(paren
op_amp
id|pdata-&gt;watchdog
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|ipxh-&gt;spx.cctl
)paren
(brace
r_case
(paren
id|CCTL_SYS
op_or
id|CCTL_ACK
)paren
suffix:colon
r_if
c_cond
(paren
(paren
id|ipxh-&gt;spx.sequence
op_eq
l_int|0
)paren
multiline_comment|/* ConReq */
op_logical_and
(paren
id|ipxh-&gt;spx.ackseq
op_eq
l_int|0
)paren
op_logical_and
(paren
id|ipxh-&gt;spx.dconn
op_eq
l_int|0xFFFF
)paren
)paren
(brace
id|pdata-&gt;state
op_assign
id|SPX_CONNECTED
suffix:semicolon
id|pdata-&gt;dest_addr
op_assign
id|ipxh-&gt;ipx.ipx_source
suffix:semicolon
id|pdata-&gt;source_addr
op_assign
id|ipxh-&gt;ipx.ipx_dest
suffix:semicolon
id|pdata-&gt;dest_connid
op_assign
id|ipxh-&gt;spx.sconn
suffix:semicolon
id|pdata-&gt;alloc
op_assign
l_int|3
op_plus
id|ntohs
c_func
(paren
id|ipxh-&gt;spx.sequence
)paren
suffix:semicolon
id|skb_queue_tail
c_func
(paren
op_amp
id|sk-&gt;receive_queue
comma
id|skb
)paren
suffix:semicolon
id|wake_up_interruptible
c_func
(paren
id|sk-&gt;sleep
)paren
suffix:semicolon
)brace
r_else
multiline_comment|/* WD Request */
id|spx_transmit
c_func
(paren
id|sk
comma
id|skb
comma
id|WDACK
comma
l_int|0
)paren
suffix:semicolon
r_goto
id|finish
suffix:semicolon
r_case
id|CCTL_SYS
suffix:colon
multiline_comment|/* ACK */
r_if
c_cond
(paren
(paren
id|ipxh-&gt;spx.dtype
op_eq
l_int|0
)paren
multiline_comment|/* ConReq ACK */
op_logical_and
(paren
id|ipxh-&gt;spx.sconn
op_ne
l_int|0xFFFF
)paren
op_logical_and
(paren
id|ipxh-&gt;spx.dconn
op_ne
l_int|0xFFFF
)paren
op_logical_and
(paren
id|ipxh-&gt;spx.sequence
op_eq
l_int|0
)paren
op_logical_and
(paren
id|ipxh-&gt;spx.ackseq
op_eq
l_int|0
)paren
op_logical_and
(paren
id|pdata-&gt;state
op_ne
id|SPX_CONNECTED
)paren
)paren
(brace
id|pdata-&gt;state
op_assign
id|SPX_CONNECTED
suffix:semicolon
id|pdata-&gt;dest_connid
op_assign
id|ipxh-&gt;spx.sconn
suffix:semicolon
r_if
c_cond
(paren
id|spx_retransmit_chk
c_func
(paren
id|pdata
comma
l_int|0
comma
id|CONACK
)paren
OL
l_int|0
)paren
(brace
r_goto
id|toss_skb
suffix:semicolon
)brace
id|skb_queue_tail
c_func
(paren
op_amp
id|sk-&gt;receive_queue
comma
id|skb
)paren
suffix:semicolon
id|wake_up_interruptible
c_func
(paren
id|sk-&gt;sleep
)paren
suffix:semicolon
r_goto
id|finish
suffix:semicolon
)brace
id|spx_retransmit_chk
c_func
(paren
id|pdata
comma
id|ipxh-&gt;spx.ackseq
comma
id|ACK
)paren
suffix:semicolon
r_goto
id|toss_skb
suffix:semicolon
r_case
(paren
id|CCTL_ACK
)paren
suffix:colon
multiline_comment|/* Informed Disconnect */
r_if
c_cond
(paren
id|ipxh-&gt;spx.dtype
op_eq
id|SPX_DTYPE_ECONN
)paren
(brace
id|spx_transmit
c_func
(paren
id|sk
comma
id|skb
comma
id|DISACK
comma
l_int|0
)paren
suffix:semicolon
id|spx_close_socket
c_func
(paren
id|sk
)paren
suffix:semicolon
r_goto
id|finish
suffix:semicolon
)brace
multiline_comment|/* Fall through */
r_default
suffix:colon
(brace
)brace
r_if
c_cond
(paren
id|ntohs
c_func
(paren
id|ipxh-&gt;spx.sequence
)paren
op_eq
id|pdata-&gt;rmt_seq
)paren
(brace
id|pdata-&gt;rmt_seq
op_assign
id|ntohs
c_func
(paren
id|ipxh-&gt;spx.sequence
)paren
suffix:semicolon
id|pdata-&gt;rmt_ack
op_assign
id|ntohs
c_func
(paren
id|ipxh-&gt;spx.ackseq
)paren
suffix:semicolon
id|pdata-&gt;alloc
op_assign
id|pdata-&gt;rmt_seq
op_plus
l_int|3
suffix:semicolon
r_if
c_cond
(paren
id|pdata-&gt;rmt_ack
OG
l_int|0
op_logical_or
id|pdata-&gt;rmt_ack
op_eq
l_int|0
)paren
(brace
id|spx_retransmit_chk
c_func
(paren
id|pdata
comma
id|pdata-&gt;rmt_ack
comma
id|ACK
)paren
suffix:semicolon
)brace
id|skb_queue_tail
c_func
(paren
op_amp
id|pdata-&gt;rcv_queue
comma
id|skb
)paren
suffix:semicolon
id|wake_up_interruptible
c_func
(paren
id|sk-&gt;sleep
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ipxh-&gt;spx.cctl
op_amp
id|CCTL_ACK
)paren
(brace
id|spx_transmit
c_func
(paren
id|sk
comma
l_int|NULL
comma
id|ACK
comma
l_int|0
)paren
suffix:semicolon
)brace
r_goto
id|finish
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ipxh-&gt;spx.dtype
op_eq
id|SPX_DTYPE_ECACK
)paren
(brace
r_if
c_cond
(paren
id|pdata-&gt;state
op_ne
id|SPX_CLOSED
)paren
(brace
id|spx_close_socket
c_func
(paren
id|sk
)paren
suffix:semicolon
)brace
r_goto
id|toss_skb
suffix:semicolon
)brace
)brace
id|toss_skb
suffix:colon
multiline_comment|/* Catch All */
id|kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
id|finish
suffix:colon
r_return
suffix:semicolon
)brace
multiline_comment|/* Get message/packet data from user-land */
DECL|function|spx_sendmsg
r_static
r_int
id|spx_sendmsg
c_func
(paren
r_struct
id|socket
op_star
id|sock
comma
r_struct
id|msghdr
op_star
id|msg
comma
r_int
id|len
comma
r_struct
id|scm_cookie
op_star
id|scm
)paren
(brace
r_struct
id|sock
op_star
id|sk
op_assign
id|sock-&gt;sk
suffix:semicolon
r_int
id|flags
op_assign
id|msg-&gt;msg_flags
suffix:semicolon
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
r_int
id|err
comma
id|offset
comma
id|size
suffix:semicolon
r_if
c_cond
(paren
id|len
OG
l_int|534
)paren
(brace
r_return
(paren
op_minus
id|EMSGSIZE
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|sk-&gt;zapped
)paren
(brace
r_return
(paren
op_minus
id|ENOTCONN
)paren
suffix:semicolon
)brace
multiline_comment|/* Socket not bound */
r_if
c_cond
(paren
id|flags
op_amp
op_complement
id|MSG_DONTWAIT
)paren
(brace
r_return
(paren
op_minus
id|EINVAL
)paren
suffix:semicolon
)brace
id|offset
op_assign
id|ipx_if_offset
c_func
(paren
id|sk-&gt;tp_pinfo.af_spx.dest_addr.net
)paren
suffix:semicolon
id|size
op_assign
id|offset
op_plus
r_sizeof
(paren
r_struct
id|ipxspxhdr
)paren
op_plus
id|len
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|skb
op_assign
id|sock_alloc_send_skb
c_func
(paren
id|sk
comma
id|size
comma
l_int|0
comma
id|flags
op_amp
id|MSG_DONTWAIT
comma
op_amp
id|err
)paren
suffix:semicolon
id|sti
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|skb
op_eq
l_int|NULL
)paren
(brace
r_return
(paren
id|err
)paren
suffix:semicolon
)brace
id|skb-&gt;sk
op_assign
id|sk
suffix:semicolon
id|skb_reserve
c_func
(paren
id|skb
comma
id|offset
)paren
suffix:semicolon
id|skb-&gt;h.raw
op_assign
id|skb-&gt;nh.raw
op_assign
id|skb_put
c_func
(paren
id|skb
comma
r_sizeof
(paren
r_struct
id|ipxspxhdr
)paren
)paren
suffix:semicolon
id|err
op_assign
id|memcpy_fromiovec
c_func
(paren
id|skb_put
c_func
(paren
id|skb
comma
id|len
)paren
comma
id|msg-&gt;msg_iov
comma
id|len
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
(brace
id|kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
r_return
(paren
op_minus
id|EFAULT
)paren
suffix:semicolon
)brace
id|err
op_assign
id|spx_transmit
c_func
(paren
id|sk
comma
id|skb
comma
id|DATA
comma
id|len
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
(brace
r_return
(paren
op_minus
id|EAGAIN
)paren
suffix:semicolon
)brace
r_return
(paren
id|len
)paren
suffix:semicolon
)brace
multiline_comment|/* Send message/packet data to user-land */
DECL|function|spx_recvmsg
r_static
r_int
id|spx_recvmsg
c_func
(paren
r_struct
id|socket
op_star
id|sock
comma
r_struct
id|msghdr
op_star
id|msg
comma
r_int
id|size
comma
r_int
id|flags
comma
r_struct
id|scm_cookie
op_star
id|scm
)paren
(brace
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
r_struct
id|ipxspxhdr
op_star
id|ispxh
suffix:semicolon
r_struct
id|sock
op_star
id|sk
op_assign
id|sock-&gt;sk
suffix:semicolon
r_struct
id|spx_opt
op_star
id|pdata
op_assign
op_amp
id|sk-&gt;tp_pinfo.af_spx
suffix:semicolon
r_struct
id|sockaddr_ipx
op_star
id|sipx
op_assign
(paren
r_struct
id|sockaddr_ipx
op_star
)paren
id|msg-&gt;msg_name
suffix:semicolon
r_int
id|copied
comma
id|err
suffix:semicolon
r_if
c_cond
(paren
id|sk-&gt;zapped
)paren
(brace
r_return
(paren
op_minus
id|ENOTCONN
)paren
suffix:semicolon
)brace
multiline_comment|/* Socket not bound */
id|lock_sock
c_func
(paren
id|sk
)paren
suffix:semicolon
id|restart
suffix:colon
r_while
c_loop
(paren
id|skb_queue_empty
c_func
(paren
op_amp
id|pdata-&gt;rcv_queue
)paren
)paren
multiline_comment|/* No data */
(brace
multiline_comment|/* Socket errors? */
id|err
op_assign
id|sock_error
c_func
(paren
id|sk
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
(brace
r_return
(paren
id|err
)paren
suffix:semicolon
)brace
multiline_comment|/* Socket shut down? */
r_if
c_cond
(paren
id|sk-&gt;shutdown
op_amp
id|RCV_SHUTDOWN
)paren
(brace
r_return
(paren
op_minus
id|ESHUTDOWN
)paren
suffix:semicolon
)brace
multiline_comment|/* handle signals */
r_if
c_cond
(paren
id|signal_pending
c_func
(paren
id|current
)paren
)paren
(brace
r_return
(paren
op_minus
id|ERESTARTSYS
)paren
suffix:semicolon
)brace
multiline_comment|/* User doesn&squot;t want to wait */
r_if
c_cond
(paren
id|flags
op_amp
id|MSG_DONTWAIT
)paren
(brace
r_return
(paren
op_minus
id|EAGAIN
)paren
suffix:semicolon
)brace
id|release_sock
c_func
(paren
id|sk
)paren
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|skb_peek
c_func
(paren
op_amp
id|pdata-&gt;rcv_queue
)paren
op_eq
l_int|NULL
)paren
(brace
id|interruptible_sleep_on
c_func
(paren
id|sk-&gt;sleep
)paren
suffix:semicolon
)brace
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|lock_sock
c_func
(paren
id|sk
)paren
suffix:semicolon
)brace
id|skb
op_assign
id|skb_dequeue
c_func
(paren
op_amp
id|pdata-&gt;rcv_queue
)paren
suffix:semicolon
r_if
c_cond
(paren
id|skb
op_eq
l_int|NULL
)paren
(brace
r_goto
id|restart
suffix:semicolon
)brace
id|ispxh
op_assign
(paren
r_struct
id|ipxspxhdr
op_star
)paren
id|skb-&gt;nh.raw
suffix:semicolon
id|copied
op_assign
id|ntohs
c_func
(paren
id|ispxh-&gt;ipx.ipx_pktsize
)paren
op_minus
id|SPX_SYS_PKT_LEN
suffix:semicolon
r_if
c_cond
(paren
id|copied
OG
id|size
)paren
(brace
id|copied
op_assign
id|size
suffix:semicolon
id|msg-&gt;msg_flags
op_or_assign
id|MSG_TRUNC
suffix:semicolon
)brace
id|err
op_assign
id|memcpy_toiovec
c_func
(paren
id|msg-&gt;msg_iov
comma
id|skb-&gt;nh.raw
op_plus
id|SPX_SYS_PKT_LEN
comma
id|copied
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
(brace
r_return
(paren
op_minus
id|EFAULT
)paren
suffix:semicolon
)brace
id|msg-&gt;msg_namelen
op_assign
r_sizeof
(paren
op_star
id|sipx
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sipx
)paren
(brace
id|sipx-&gt;sipx_family
op_assign
id|AF_IPX
suffix:semicolon
id|sipx-&gt;sipx_port
op_assign
id|ispxh-&gt;ipx.ipx_source.sock
suffix:semicolon
id|memcpy
c_func
(paren
id|sipx-&gt;sipx_node
comma
id|ispxh-&gt;ipx.ipx_source.node
comma
id|IPX_NODE_LEN
)paren
suffix:semicolon
id|sipx-&gt;sipx_network
op_assign
id|ispxh-&gt;ipx.ipx_source.net
suffix:semicolon
id|sipx-&gt;sipx_type
op_assign
id|ispxh-&gt;ipx.ipx_type
suffix:semicolon
)brace
id|kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
id|release_sock
c_func
(paren
id|sk
)paren
suffix:semicolon
r_return
(paren
id|copied
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Functions which just wrap their IPX cousins&n; */
DECL|function|spx_bind
r_static
r_int
id|spx_bind
c_func
(paren
r_struct
id|socket
op_star
id|sock
comma
r_struct
id|sockaddr
op_star
id|uaddr
comma
r_int
id|addr_len
)paren
(brace
r_int
id|err
suffix:semicolon
id|err
op_assign
id|ipx_operations
op_member_access_from_pointer
id|bind
c_func
(paren
id|sock
comma
id|uaddr
comma
id|addr_len
)paren
suffix:semicolon
r_return
(paren
id|err
)paren
suffix:semicolon
)brace
DECL|function|spx_getname
r_static
r_int
id|spx_getname
(paren
r_struct
id|socket
op_star
id|sock
comma
r_struct
id|sockaddr
op_star
id|uaddr
comma
r_int
op_star
id|usockaddr_len
comma
r_int
id|peer
)paren
(brace
r_int
id|err
suffix:semicolon
id|err
op_assign
id|ipx_operations
op_member_access_from_pointer
id|getname
c_func
(paren
id|sock
comma
id|uaddr
comma
id|usockaddr_len
comma
id|peer
)paren
suffix:semicolon
r_return
(paren
id|err
)paren
suffix:semicolon
)brace
DECL|function|spx_ioctl
r_static
r_int
id|spx_ioctl
(paren
r_struct
id|socket
op_star
id|sock
comma
r_int
r_int
id|cmd
comma
r_int
r_int
id|arg
)paren
(brace
r_int
id|err
suffix:semicolon
id|err
op_assign
id|ipx_operations
op_member_access_from_pointer
id|ioctl
c_func
(paren
id|sock
comma
id|cmd
comma
id|arg
)paren
suffix:semicolon
r_return
(paren
id|err
)paren
suffix:semicolon
)brace
DECL|function|spx_setsockopt
r_static
r_int
id|spx_setsockopt
c_func
(paren
r_struct
id|socket
op_star
id|sock
comma
r_int
id|level
comma
r_int
id|optname
comma
r_char
op_star
id|optval
comma
r_int
id|optlen
)paren
(brace
r_int
id|err
suffix:semicolon
id|err
op_assign
id|ipx_operations
op_member_access_from_pointer
id|setsockopt
c_func
(paren
id|sock
comma
id|level
comma
id|optname
comma
id|optval
comma
id|optlen
)paren
suffix:semicolon
r_return
(paren
id|err
)paren
suffix:semicolon
)brace
DECL|function|spx_getsockopt
r_static
r_int
id|spx_getsockopt
c_func
(paren
r_struct
id|socket
op_star
id|sock
comma
r_int
id|level
comma
r_int
id|optname
comma
r_char
op_star
id|optval
comma
r_int
op_star
id|optlen
)paren
(brace
r_int
id|err
suffix:semicolon
id|err
op_assign
id|ipx_operations
op_member_access_from_pointer
id|getsockopt
c_func
(paren
id|sock
comma
id|level
comma
id|optname
comma
id|optval
comma
id|optlen
)paren
suffix:semicolon
r_return
(paren
id|err
)paren
suffix:semicolon
)brace
DECL|variable|spx_ops
r_static
r_struct
id|proto_ops
id|SOCKOPS_WRAPPED
c_func
(paren
id|spx_ops
)paren
op_assign
(brace
id|family
suffix:colon
id|PF_IPX
comma
id|release
suffix:colon
id|spx_release
comma
id|bind
suffix:colon
id|spx_bind
comma
id|connect
suffix:colon
id|spx_connect
comma
id|socketpair
suffix:colon
id|sock_no_socketpair
comma
id|accept
suffix:colon
id|spx_accept
comma
id|getname
suffix:colon
id|spx_getname
comma
id|poll
suffix:colon
id|spx_datagram_poll
comma
id|ioctl
suffix:colon
id|spx_ioctl
comma
id|listen
suffix:colon
id|spx_listen
comma
id|shutdown
suffix:colon
id|sock_no_shutdown
comma
id|setsockopt
suffix:colon
id|spx_setsockopt
comma
id|getsockopt
suffix:colon
id|spx_getsockopt
comma
id|sendmsg
suffix:colon
id|spx_sendmsg
comma
id|recvmsg
suffix:colon
id|spx_recvmsg
comma
id|mmap
suffix:colon
id|sock_no_mmap
comma
)brace
suffix:semicolon
macro_line|#include &lt;linux/smp_lock.h&gt;
id|SOCKOPS_WRAP
c_func
(paren
id|spx
comma
id|PF_IPX
)paren
suffix:semicolon
DECL|variable|spx_family_ops
r_static
r_struct
id|net_proto_family
id|spx_family_ops
op_assign
(brace
id|PF_IPX
comma
id|spx_create
)brace
suffix:semicolon
DECL|function|spx_proto_init
r_void
id|spx_proto_init
c_func
(paren
r_void
)paren
(brace
r_int
id|error
suffix:semicolon
id|connids
op_assign
(paren
id|__u16
)paren
id|jiffies
suffix:semicolon
multiline_comment|/* initalize random */
id|error
op_assign
id|ipx_register_spx
c_func
(paren
op_amp
id|ipx_operations
comma
op_amp
id|spx_family_ops
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
)paren
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;SPX: unable to register with IPX.&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* route socket(PF_IPX, SOCK_SEQPACKET) calls through spx_create() */
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;NET4: Sequenced Packet eXchange (SPX) 0.02 for Linux NET4.0&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
DECL|function|spx_proto_finito
r_void
id|spx_proto_finito
c_func
(paren
r_void
)paren
(brace
id|ipx_unregister_spx
c_func
(paren
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
macro_line|#ifdef MODULE
DECL|function|init_module
r_int
id|init_module
c_func
(paren
r_void
)paren
(brace
id|spx_proto_init
c_func
(paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|cleanup_module
r_void
id|cleanup_module
c_func
(paren
r_void
)paren
(brace
id|spx_proto_finito
c_func
(paren
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
macro_line|#endif /* MODULE */
macro_line|#endif /* CONFIG_SPX || CONFIG_SPX_MODULE */
eof
