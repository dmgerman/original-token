multiline_comment|/*&n; * we8003.c&t;A generic WD8003 driver for LINUX.&n; *&n; * Version:&t;@(#)we8003.c&t;1.0.0&t;04/22/93&n; *&n; * Author:&t;Fred N. van Kempen, &lt;waltje@uwalt.nl.mugnet.org&gt;&n; */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/fs.h&gt;
macro_line|#include &lt;linux/tty.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/ptrace.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/ddi.h&gt;
macro_line|#include &lt;asm/system.h&gt;
macro_line|#include &lt;asm/segment.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;errno.h&gt;
macro_line|#include &lt;linux/fcntl.h&gt;
macro_line|#include &lt;netinet/in.h&gt;
macro_line|#include &quot;we8003.h&quot;
DECL|macro|VERSION
mdefine_line|#define VERSION&t;&t;&quot;1.0.0&quot;&t;&t;/* current version ID&t;&t;*/
DECL|variable|we_ptrs
r_struct
id|ddi_device
op_star
id|we_ptrs
(braket
id|NR_WE8003
)braket
suffix:semicolon
multiline_comment|/* pointers to DDI blocks&t;*/
r_static
r_int
DECL|function|we_getconf
id|we_getconf
c_func
(paren
r_struct
id|ddi_device
op_star
id|dev
comma
r_struct
id|ddconf
op_star
id|cp
)paren
(brace
id|cp-&gt;ioaddr
op_assign
id|dev-&gt;config.ioaddr
suffix:semicolon
multiline_comment|/* I/O base address&t;&t;*/
id|cp-&gt;ioaux
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* not used&t;&t;&t;*/
id|cp-&gt;irq
op_assign
id|dev-&gt;config.irq
suffix:semicolon
multiline_comment|/* IRQ channel&t;&t;&t;*/
id|cp-&gt;dma
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* not used&t;&t;&t;*/
id|cp-&gt;memaddr
op_assign
id|dev-&gt;config.memaddr
suffix:semicolon
multiline_comment|/* RAM base address&t;&t;*/
id|cp-&gt;memsize
op_assign
id|dev-&gt;config.memsize
suffix:semicolon
multiline_comment|/* RAM size&t;&t;&t;*/
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_int
DECL|function|we_setconf
id|we_setconf
c_func
(paren
r_struct
id|ddi_device
op_star
id|dev
comma
r_struct
id|ddconf
op_star
id|cp
)paren
(brace
id|dev-&gt;config.ioaddr
op_assign
id|cp-&gt;ioaddr
suffix:semicolon
multiline_comment|/* I/O base address&t;&t;*/
id|dev-&gt;config.irq
op_assign
id|cp-&gt;irq
suffix:semicolon
multiline_comment|/* IRQ channel&t;&t;&t;*/
id|dev-&gt;config.memaddr
op_assign
id|cp-&gt;memaddr
suffix:semicolon
multiline_comment|/* RAM base address&t;&t;*/
id|dev-&gt;config.memsize
op_assign
id|cp-&gt;memsize
suffix:semicolon
multiline_comment|/* RAM size&t;&t;&t;*/
id|PRINTK
(paren
(paren
l_string|&quot;%s: IO=0x%X IRQ=%d MEM=0x%X(%d)&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|dev-&gt;config.ioaddr
comma
id|dev-&gt;config.irq
comma
id|dev-&gt;config.memaddr
comma
id|dev-&gt;config.memsize
)paren
)paren
suffix:semicolon
multiline_comment|/* FIXME: request the IRQ line and initialize HW here! */
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_int
DECL|function|we_open
id|we_open
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
)paren
(brace
r_int
id|minor
suffix:semicolon
r_struct
id|ddi_device
op_star
id|dev
suffix:semicolon
id|minor
op_assign
id|MINOR
c_func
(paren
id|inode-&gt;i_rdev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|minor
OL
l_int|0
op_logical_or
id|minor
op_ge
id|NR_WE8003
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
id|dev
op_assign
id|we_ptrs
(braket
id|minor
)braket
suffix:semicolon
r_if
c_cond
(paren
id|dev
op_eq
l_int|NULL
op_logical_or
(paren
id|dev-&gt;flags
op_amp
id|DDI_FREADY
)paren
op_eq
l_int|0
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_void
DECL|function|we_close
id|we_close
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
)paren
(brace
r_int
id|minor
suffix:semicolon
r_struct
id|ddi_device
op_star
id|dev
suffix:semicolon
id|minor
op_assign
id|MINOR
c_func
(paren
id|inode-&gt;i_rdev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|minor
OL
l_int|0
op_logical_or
id|minor
op_ge
id|NR_WE8003
)paren
r_return
suffix:semicolon
id|dev
op_assign
id|we_ptrs
(braket
id|minor
)braket
suffix:semicolon
r_if
c_cond
(paren
id|dev
op_eq
l_int|NULL
op_logical_or
(paren
id|dev-&gt;flags
op_amp
id|DDI_FREADY
)paren
op_eq
l_int|0
)paren
r_return
suffix:semicolon
)brace
r_static
r_int
DECL|function|we_ioctl
id|we_ioctl
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
comma
r_int
r_int
id|cmd
comma
r_int
r_int
id|arg
)paren
(brace
r_int
id|minor
comma
id|ret
suffix:semicolon
r_struct
id|ddi_device
op_star
id|dev
suffix:semicolon
r_struct
id|ddconf
id|conf
suffix:semicolon
id|minor
op_assign
id|MINOR
c_func
(paren
id|inode-&gt;i_rdev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|minor
OL
l_int|0
op_logical_or
id|minor
op_ge
id|NR_WE8003
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
id|dev
op_assign
id|we_ptrs
(braket
id|minor
)braket
suffix:semicolon
r_if
c_cond
(paren
id|dev
op_eq
l_int|NULL
op_logical_or
(paren
id|dev-&gt;flags
op_amp
id|DDI_FREADY
)paren
op_eq
l_int|0
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
id|ret
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_switch
c_cond
(paren
id|cmd
)paren
(brace
r_case
id|DDIOCGNAME
suffix:colon
id|memcpy_tofs
c_func
(paren
(paren
r_void
op_star
)paren
id|arg
comma
id|dev-&gt;name
comma
id|DDI_MAXNAME
)paren
suffix:semicolon
id|ret
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_case
id|DDIOCGCONF
suffix:colon
id|ret
op_assign
id|we_getconf
c_func
(paren
id|dev
comma
op_amp
id|conf
)paren
suffix:semicolon
id|memcpy_tofs
c_func
(paren
(paren
r_void
op_star
)paren
id|arg
comma
op_amp
id|conf
comma
r_sizeof
(paren
id|conf
)paren
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|DDIOCSCONF
suffix:colon
id|memcpy_fromfs
c_func
(paren
op_amp
id|conf
comma
(paren
r_void
op_star
)paren
id|arg
comma
r_sizeof
(paren
id|conf
)paren
)paren
suffix:semicolon
id|ret
op_assign
id|we_setconf
c_func
(paren
id|dev
comma
op_amp
id|conf
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
r_break
suffix:semicolon
)brace
r_return
id|ret
suffix:semicolon
)brace
DECL|variable|we_fops
r_static
r_struct
id|file_operations
id|we_fops
op_assign
(brace
l_int|NULL
comma
multiline_comment|/* LSEEK&t;*/
l_int|NULL
comma
multiline_comment|/* READ&t;&t;*/
l_int|NULL
comma
multiline_comment|/* WRITE&t;*/
l_int|NULL
comma
multiline_comment|/* READDIR&t;*/
l_int|NULL
comma
multiline_comment|/* SELECT&t;*/
id|we_ioctl
comma
multiline_comment|/* IOCTL&t;*/
l_int|NULL
comma
multiline_comment|/* MMAP&t;&t;*/
id|we_open
comma
multiline_comment|/* OPEN&t;&t;*/
id|we_close
multiline_comment|/* CLOSE&t;*/
)brace
suffix:semicolon
multiline_comment|/* This is the main entry point of this driver. */
r_int
DECL|function|we8003_init
id|we8003_init
c_func
(paren
r_struct
id|ddi_device
op_star
id|dev
)paren
(brace
r_static
r_int
id|unit_nr
op_assign
l_int|0
suffix:semicolon
r_int
id|i
suffix:semicolon
multiline_comment|/* Initialize the driver if this is the first call. */
r_if
c_cond
(paren
id|unit_nr
op_eq
l_int|0
)paren
(brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|NR_WE8003
suffix:semicolon
id|i
op_increment
)paren
(brace
id|we_ptrs
(braket
id|i
)braket
op_assign
l_int|NULL
suffix:semicolon
)brace
)brace
multiline_comment|/* Initialize the local control block pointer. */
id|we_ptrs
(braket
id|unit_nr
)braket
op_assign
id|dev
suffix:semicolon
id|dev-&gt;unit
op_assign
id|unit_nr
op_increment
suffix:semicolon
id|sprintf
c_func
(paren
id|dev-&gt;name
comma
id|WE_NAME
comma
id|dev-&gt;unit
)paren
suffix:semicolon
id|dev-&gt;flags
op_or_assign
id|DDI_FREADY
suffix:semicolon
multiline_comment|/* Say hello to our viewers. */
id|PRINTK
(paren
(paren
l_string|&quot;%s: version %s: &quot;
comma
id|dev-&gt;title
comma
id|VERSION
)paren
)paren
suffix:semicolon
(paren
r_void
)paren
id|we_setconf
c_func
(paren
id|dev
comma
op_amp
id|dev-&gt;config
)paren
suffix:semicolon
multiline_comment|/* First of all, setup a VFS major device handler if needed. */
r_if
c_cond
(paren
id|dev-&gt;major
op_ne
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|dev-&gt;flags
op_amp
id|DDI_FBLKDEV
)paren
(brace
r_if
c_cond
(paren
id|register_blkdev
c_func
(paren
id|dev-&gt;major
comma
l_string|&quot;WE8003&quot;
comma
op_amp
id|we_fops
)paren
OL
l_int|0
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%s: cannot register block device %d!&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|dev-&gt;major
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|dev-&gt;flags
op_amp
id|DDI_FCHRDEV
)paren
(brace
r_if
c_cond
(paren
id|register_chrdev
c_func
(paren
id|dev-&gt;major
comma
l_string|&quot;WE8003&quot;
comma
op_amp
id|we_fops
)paren
OL
l_int|0
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%s: cannot register character device %d!&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|dev-&gt;major
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
)brace
)brace
multiline_comment|/* All done... */
r_return
l_int|0
suffix:semicolon
)brace
eof
