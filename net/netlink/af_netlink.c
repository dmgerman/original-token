multiline_comment|/*&n; * NETLINK      Kernel-user communication protocol.&n; *&n; * &t;&t;Authors:&t;Alan Cox &lt;alan@redhat.com&gt;&n; * &t;&t;&t;&t;Alexey Kuznetsov &lt;kuznet@ms2.inr.ac.ru&gt;&n; *&n; *&t;&t;This program is free software; you can redistribute it and/or&n; *&t;&t;modify it under the terms of the GNU General Public License&n; *&t;&t;as published by the Free Software Foundation; either version&n; *&t;&t;2 of the License, or (at your option) any later version.&n; * &n; */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/major.h&gt;
macro_line|#include &lt;linux/signal.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/stat.h&gt;
macro_line|#include &lt;linux/socket.h&gt;
macro_line|#include &lt;linux/un.h&gt;
macro_line|#include &lt;linux/fcntl.h&gt;
macro_line|#include &lt;linux/termios.h&gt;
macro_line|#include &lt;linux/sockios.h&gt;
macro_line|#include &lt;linux/net.h&gt;
macro_line|#include &lt;linux/fs.h&gt;
macro_line|#include &lt;linux/malloc.h&gt;
macro_line|#include &lt;asm/uaccess.h&gt;
macro_line|#include &lt;linux/skbuff.h&gt;
macro_line|#include &lt;linux/netdevice.h&gt;
macro_line|#include &lt;linux/netlink.h&gt;
macro_line|#include &lt;linux/proc_fs.h&gt;
macro_line|#include &lt;linux/smp_lock.h&gt;
macro_line|#include &lt;net/sock.h&gt;
macro_line|#include &lt;net/scm.h&gt;
DECL|macro|Nprintk
mdefine_line|#define Nprintk(a...)
macro_line|#if defined(CONFIG_NETLINK_DEV) || defined(CONFIG_NETLINK_DEV_MODULE)
DECL|macro|NL_EMULATE_DEV
mdefine_line|#define NL_EMULATE_DEV
macro_line|#endif
DECL|macro|BUG_TRAP
mdefine_line|#define BUG_TRAP(x) if (!(x)) { printk(&quot;Assertion (&quot; #x &quot;) failed at &quot; __FILE__ &quot;(%d):&quot; __FUNCTION__ &quot;&bslash;n&quot;, __LINE__); }
DECL|struct|netlink_opt
r_struct
id|netlink_opt
(brace
DECL|member|pid
id|u32
id|pid
suffix:semicolon
DECL|member|groups
r_int
id|groups
suffix:semicolon
DECL|member|dst_pid
id|u32
id|dst_pid
suffix:semicolon
DECL|member|dst_groups
r_int
id|dst_groups
suffix:semicolon
DECL|member|state
r_int
r_int
id|state
suffix:semicolon
DECL|member|handler
r_int
(paren
op_star
id|handler
)paren
(paren
r_int
id|unit
comma
r_struct
id|sk_buff
op_star
id|skb
)paren
suffix:semicolon
DECL|member|wait
id|wait_queue_head_t
id|wait
suffix:semicolon
DECL|member|cb
r_struct
id|netlink_callback
op_star
id|cb
suffix:semicolon
DECL|member|cb_lock
id|spinlock_t
id|cb_lock
suffix:semicolon
DECL|member|data_ready
r_void
(paren
op_star
id|data_ready
)paren
(paren
r_struct
id|sock
op_star
id|sk
comma
r_int
id|bytes
)paren
suffix:semicolon
)brace
suffix:semicolon
DECL|variable|nl_table
r_static
r_struct
id|sock
op_star
id|nl_table
(braket
id|MAX_LINKS
)braket
suffix:semicolon
r_static
id|DECLARE_WAIT_QUEUE_HEAD
c_func
(paren
id|nl_table_wait
)paren
suffix:semicolon
macro_line|#ifdef NL_EMULATE_DEV
DECL|variable|netlink_kernel
r_static
r_struct
id|socket
op_star
id|netlink_kernel
(braket
id|MAX_LINKS
)braket
suffix:semicolon
macro_line|#endif
r_static
r_int
id|netlink_dump
c_func
(paren
r_struct
id|sock
op_star
id|sk
)paren
suffix:semicolon
r_static
r_void
id|netlink_destroy_callback
c_func
(paren
r_struct
id|netlink_callback
op_star
id|cb
)paren
suffix:semicolon
DECL|variable|netlink_sock_nr
id|atomic_t
id|netlink_sock_nr
suffix:semicolon
DECL|variable|nl_table_lock
r_static
id|rwlock_t
id|nl_table_lock
op_assign
id|RW_LOCK_UNLOCKED
suffix:semicolon
DECL|variable|nl_table_users
r_static
id|atomic_t
id|nl_table_users
op_assign
id|ATOMIC_INIT
c_func
(paren
l_int|0
)paren
suffix:semicolon
DECL|function|netlink_sock_destruct
r_static
r_void
id|netlink_sock_destruct
c_func
(paren
r_struct
id|sock
op_star
id|sk
)paren
(brace
id|skb_queue_purge
c_func
(paren
op_amp
id|sk-&gt;receive_queue
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|sk-&gt;dead
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;Freeing alive netlink socket %p&bslash;n&quot;
comma
id|sk
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|BUG_TRAP
c_func
(paren
id|atomic_read
c_func
(paren
op_amp
id|sk-&gt;rmem_alloc
)paren
op_eq
l_int|0
)paren
suffix:semicolon
id|BUG_TRAP
c_func
(paren
id|atomic_read
c_func
(paren
op_amp
id|sk-&gt;wmem_alloc
)paren
op_eq
l_int|0
)paren
suffix:semicolon
id|BUG_TRAP
c_func
(paren
id|sk-&gt;protinfo.af_netlink-&gt;cb
op_eq
l_int|NULL
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|sk-&gt;protinfo.af_netlink
)paren
suffix:semicolon
id|atomic_dec
c_func
(paren
op_amp
id|netlink_sock_nr
)paren
suffix:semicolon
macro_line|#ifdef NETLINK_REFCNT_DEBUG
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;NETLINK %p released, %d are still alive&bslash;n&quot;
comma
id|sk
comma
id|atomic_read
c_func
(paren
op_amp
id|netlink_sock_nr
)paren
)paren
suffix:semicolon
macro_line|#endif
)brace
multiline_comment|/* This lock without WQ_FLAG_EXCLUSIVE is good on UP and it is _very_ bad on SMP.&n; * Look, when several writers sleep and reader wakes them up, all but one&n; * immediately hit write lock and grab all the cpus. Exclusive sleep solves&n; * this, _but_ remember, it adds useless work on UP machines.&n; */
DECL|function|netlink_table_grab
r_static
r_void
id|netlink_table_grab
c_func
(paren
r_void
)paren
(brace
id|write_lock_bh
c_func
(paren
op_amp
id|nl_table_lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|atomic_read
c_func
(paren
op_amp
id|nl_table_users
)paren
)paren
(brace
id|DECLARE_WAITQUEUE
c_func
(paren
id|wait
comma
id|current
)paren
suffix:semicolon
id|add_wait_queue_exclusive
c_func
(paren
op_amp
id|nl_table_wait
comma
op_amp
id|wait
)paren
suffix:semicolon
r_for
c_loop
(paren
suffix:semicolon
suffix:semicolon
)paren
(brace
id|set_current_state
c_func
(paren
id|TASK_UNINTERRUPTIBLE
)paren
suffix:semicolon
r_if
c_cond
(paren
id|atomic_read
c_func
(paren
op_amp
id|nl_table_users
)paren
op_eq
l_int|0
)paren
r_break
suffix:semicolon
id|write_unlock_bh
c_func
(paren
op_amp
id|nl_table_lock
)paren
suffix:semicolon
id|schedule
c_func
(paren
)paren
suffix:semicolon
id|write_lock_bh
c_func
(paren
op_amp
id|nl_table_lock
)paren
suffix:semicolon
)brace
id|__set_current_state
c_func
(paren
id|TASK_RUNNING
)paren
suffix:semicolon
id|remove_wait_queue
c_func
(paren
op_amp
id|nl_table_wait
comma
op_amp
id|wait
)paren
suffix:semicolon
)brace
)brace
DECL|function|netlink_table_ungrab
r_static
id|__inline__
r_void
id|netlink_table_ungrab
c_func
(paren
r_void
)paren
(brace
id|write_unlock_bh
c_func
(paren
op_amp
id|nl_table_lock
)paren
suffix:semicolon
id|wake_up
c_func
(paren
op_amp
id|nl_table_wait
)paren
suffix:semicolon
)brace
r_static
id|__inline__
r_void
DECL|function|netlink_lock_table
id|netlink_lock_table
c_func
(paren
r_void
)paren
(brace
multiline_comment|/* read_lock() synchronizes us to netlink_table_grab */
id|read_lock
c_func
(paren
op_amp
id|nl_table_lock
)paren
suffix:semicolon
id|atomic_inc
c_func
(paren
op_amp
id|nl_table_users
)paren
suffix:semicolon
id|read_unlock
c_func
(paren
op_amp
id|nl_table_lock
)paren
suffix:semicolon
)brace
r_static
id|__inline__
r_void
DECL|function|netlink_unlock_table
id|netlink_unlock_table
c_func
(paren
r_void
)paren
(brace
r_if
c_cond
(paren
id|atomic_dec_and_test
c_func
(paren
op_amp
id|nl_table_users
)paren
)paren
id|wake_up
c_func
(paren
op_amp
id|nl_table_wait
)paren
suffix:semicolon
)brace
DECL|function|netlink_lookup
r_static
id|__inline__
r_struct
id|sock
op_star
id|netlink_lookup
c_func
(paren
r_int
id|protocol
comma
id|u32
id|pid
)paren
(brace
r_struct
id|sock
op_star
id|sk
suffix:semicolon
id|read_lock
c_func
(paren
op_amp
id|nl_table_lock
)paren
suffix:semicolon
r_for
c_loop
(paren
id|sk
op_assign
id|nl_table
(braket
id|protocol
)braket
suffix:semicolon
id|sk
suffix:semicolon
id|sk
op_assign
id|sk-&gt;next
)paren
(brace
r_if
c_cond
(paren
id|sk-&gt;protinfo.af_netlink-&gt;pid
op_eq
id|pid
)paren
(brace
id|sock_hold
c_func
(paren
id|sk
)paren
suffix:semicolon
id|read_unlock
c_func
(paren
op_amp
id|nl_table_lock
)paren
suffix:semicolon
r_return
id|sk
suffix:semicolon
)brace
)brace
id|read_unlock
c_func
(paren
op_amp
id|nl_table_lock
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
r_extern
r_struct
id|proto_ops
id|netlink_ops
suffix:semicolon
DECL|function|netlink_insert
r_static
r_int
id|netlink_insert
c_func
(paren
r_struct
id|sock
op_star
id|sk
comma
id|u32
id|pid
)paren
(brace
r_int
id|err
op_assign
op_minus
id|EADDRINUSE
suffix:semicolon
r_struct
id|sock
op_star
id|osk
suffix:semicolon
id|netlink_table_grab
c_func
(paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|osk
op_assign
id|nl_table
(braket
id|sk-&gt;protocol
)braket
suffix:semicolon
id|osk
suffix:semicolon
id|osk
op_assign
id|osk-&gt;next
)paren
(brace
r_if
c_cond
(paren
id|osk-&gt;protinfo.af_netlink-&gt;pid
op_eq
id|pid
)paren
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|osk
op_eq
l_int|NULL
)paren
(brace
id|err
op_assign
op_minus
id|EBUSY
suffix:semicolon
r_if
c_cond
(paren
id|sk-&gt;protinfo.af_netlink-&gt;pid
op_eq
l_int|0
)paren
(brace
id|sk-&gt;protinfo.af_netlink-&gt;pid
op_assign
id|pid
suffix:semicolon
id|sk-&gt;next
op_assign
id|nl_table
(braket
id|sk-&gt;protocol
)braket
suffix:semicolon
id|nl_table
(braket
id|sk-&gt;protocol
)braket
op_assign
id|sk
suffix:semicolon
id|sock_hold
c_func
(paren
id|sk
)paren
suffix:semicolon
id|err
op_assign
l_int|0
suffix:semicolon
)brace
)brace
id|netlink_table_ungrab
c_func
(paren
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
DECL|function|netlink_remove
r_static
r_void
id|netlink_remove
c_func
(paren
r_struct
id|sock
op_star
id|sk
)paren
(brace
r_struct
id|sock
op_star
op_star
id|skp
suffix:semicolon
id|netlink_table_grab
c_func
(paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|skp
op_assign
op_amp
id|nl_table
(braket
id|sk-&gt;protocol
)braket
suffix:semicolon
op_star
id|skp
suffix:semicolon
id|skp
op_assign
op_amp
(paren
(paren
op_star
id|skp
)paren
op_member_access_from_pointer
id|next
)paren
)paren
(brace
r_if
c_cond
(paren
op_star
id|skp
op_eq
id|sk
)paren
(brace
op_star
id|skp
op_assign
id|sk-&gt;next
suffix:semicolon
id|__sock_put
c_func
(paren
id|sk
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
id|netlink_table_ungrab
c_func
(paren
)paren
suffix:semicolon
)brace
DECL|function|netlink_create
r_static
r_int
id|netlink_create
c_func
(paren
r_struct
id|socket
op_star
id|sock
comma
r_int
id|protocol
)paren
(brace
r_struct
id|sock
op_star
id|sk
suffix:semicolon
id|sock-&gt;state
op_assign
id|SS_UNCONNECTED
suffix:semicolon
r_if
c_cond
(paren
id|sock-&gt;type
op_ne
id|SOCK_RAW
op_logical_and
id|sock-&gt;type
op_ne
id|SOCK_DGRAM
)paren
r_return
op_minus
id|ESOCKTNOSUPPORT
suffix:semicolon
r_if
c_cond
(paren
id|protocol
OL
l_int|0
op_logical_or
id|protocol
op_ge
id|MAX_LINKS
)paren
r_return
op_minus
id|EPROTONOSUPPORT
suffix:semicolon
id|sock-&gt;ops
op_assign
op_amp
id|netlink_ops
suffix:semicolon
id|sk
op_assign
id|sk_alloc
c_func
(paren
id|PF_NETLINK
comma
id|GFP_KERNEL
comma
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|sk
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|sock_init_data
c_func
(paren
id|sock
comma
id|sk
)paren
suffix:semicolon
id|sk-&gt;protinfo.af_netlink
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|netlink_opt
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sk-&gt;protinfo.af_netlink
op_eq
l_int|NULL
)paren
(brace
id|sk_free
c_func
(paren
id|sk
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|memset
c_func
(paren
id|sk-&gt;protinfo.af_netlink
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|netlink_opt
)paren
)paren
suffix:semicolon
id|spin_lock_init
c_func
(paren
op_amp
id|sk-&gt;protinfo.af_netlink-&gt;cb_lock
)paren
suffix:semicolon
id|init_waitqueue_head
c_func
(paren
op_amp
id|sk-&gt;protinfo.af_netlink-&gt;wait
)paren
suffix:semicolon
id|sk-&gt;destruct
op_assign
id|netlink_sock_destruct
suffix:semicolon
id|atomic_inc
c_func
(paren
op_amp
id|netlink_sock_nr
)paren
suffix:semicolon
id|sk-&gt;protocol
op_assign
id|protocol
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|netlink_release
r_static
r_int
id|netlink_release
c_func
(paren
r_struct
id|socket
op_star
id|sock
)paren
(brace
r_struct
id|sock
op_star
id|sk
op_assign
id|sock-&gt;sk
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|sk
)paren
r_return
l_int|0
suffix:semicolon
id|netlink_remove
c_func
(paren
id|sk
)paren
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|sk-&gt;protinfo.af_netlink-&gt;cb_lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sk-&gt;protinfo.af_netlink-&gt;cb
)paren
(brace
id|sk-&gt;protinfo.af_netlink-&gt;cb
op_member_access_from_pointer
id|done
c_func
(paren
id|sk-&gt;protinfo.af_netlink-&gt;cb
)paren
suffix:semicolon
id|netlink_destroy_callback
c_func
(paren
id|sk-&gt;protinfo.af_netlink-&gt;cb
)paren
suffix:semicolon
id|sk-&gt;protinfo.af_netlink-&gt;cb
op_assign
l_int|NULL
suffix:semicolon
id|__sock_put
c_func
(paren
id|sk
)paren
suffix:semicolon
)brace
id|spin_unlock
c_func
(paren
op_amp
id|sk-&gt;protinfo.af_netlink-&gt;cb_lock
)paren
suffix:semicolon
multiline_comment|/* OK. Socket is unlinked, and, therefore,&n;&t;   no new packets will arrive */
id|sock_orphan
c_func
(paren
id|sk
)paren
suffix:semicolon
id|sock-&gt;sk
op_assign
l_int|NULL
suffix:semicolon
id|wake_up_interruptible_all
c_func
(paren
op_amp
id|sk-&gt;protinfo.af_netlink-&gt;wait
)paren
suffix:semicolon
id|skb_queue_purge
c_func
(paren
op_amp
id|sk-&gt;write_queue
)paren
suffix:semicolon
id|sock_put
c_func
(paren
id|sk
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|netlink_autobind
r_static
r_int
id|netlink_autobind
c_func
(paren
r_struct
id|socket
op_star
id|sock
)paren
(brace
r_struct
id|sock
op_star
id|sk
op_assign
id|sock-&gt;sk
suffix:semicolon
r_struct
id|sock
op_star
id|osk
suffix:semicolon
id|s32
id|pid
op_assign
id|current-&gt;pid
suffix:semicolon
r_int
id|err
suffix:semicolon
id|retry
suffix:colon
id|netlink_table_grab
c_func
(paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|osk
op_assign
id|nl_table
(braket
id|sk-&gt;protocol
)braket
suffix:semicolon
id|osk
suffix:semicolon
id|osk
op_assign
id|osk-&gt;next
)paren
(brace
r_if
c_cond
(paren
id|osk-&gt;protinfo.af_netlink-&gt;pid
op_eq
id|pid
)paren
(brace
multiline_comment|/* Bind collision, search negative pid values. */
r_if
c_cond
(paren
id|pid
OG
l_int|0
)paren
id|pid
op_assign
op_minus
l_int|4096
suffix:semicolon
id|pid
op_decrement
suffix:semicolon
id|netlink_table_ungrab
c_func
(paren
)paren
suffix:semicolon
r_goto
id|retry
suffix:semicolon
)brace
)brace
id|netlink_table_ungrab
c_func
(paren
)paren
suffix:semicolon
id|err
op_assign
id|netlink_insert
c_func
(paren
id|sk
comma
id|pid
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
op_eq
op_minus
id|EADDRINUSE
)paren
r_goto
id|retry
suffix:semicolon
id|sk-&gt;protinfo.af_netlink-&gt;groups
op_assign
l_int|0
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|netlink_bind
r_static
r_int
id|netlink_bind
c_func
(paren
r_struct
id|socket
op_star
id|sock
comma
r_struct
id|sockaddr
op_star
id|addr
comma
r_int
id|addr_len
)paren
(brace
r_struct
id|sock
op_star
id|sk
op_assign
id|sock-&gt;sk
suffix:semicolon
r_int
id|err
suffix:semicolon
r_struct
id|sockaddr_nl
op_star
id|nladdr
op_assign
(paren
r_struct
id|sockaddr_nl
op_star
)paren
id|addr
suffix:semicolon
r_if
c_cond
(paren
id|nladdr-&gt;nl_family
op_ne
id|AF_NETLINK
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
multiline_comment|/* Only superuser is allowed to listen multicasts */
r_if
c_cond
(paren
id|nladdr-&gt;nl_groups
op_logical_and
op_logical_neg
id|capable
c_func
(paren
id|CAP_NET_ADMIN
)paren
)paren
r_return
op_minus
id|EPERM
suffix:semicolon
r_if
c_cond
(paren
id|sk-&gt;protinfo.af_netlink-&gt;pid
)paren
(brace
r_if
c_cond
(paren
id|nladdr-&gt;nl_pid
op_ne
id|sk-&gt;protinfo.af_netlink-&gt;pid
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|sk-&gt;protinfo.af_netlink-&gt;groups
op_assign
id|nladdr-&gt;nl_groups
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|nladdr-&gt;nl_pid
op_eq
l_int|0
)paren
(brace
id|err
op_assign
id|netlink_autobind
c_func
(paren
id|sock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
op_eq
l_int|0
)paren
id|sk-&gt;protinfo.af_netlink-&gt;groups
op_assign
id|nladdr-&gt;nl_groups
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
id|err
op_assign
id|netlink_insert
c_func
(paren
id|sk
comma
id|nladdr-&gt;nl_pid
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
op_eq
l_int|0
)paren
id|sk-&gt;protinfo.af_netlink-&gt;groups
op_assign
id|nladdr-&gt;nl_groups
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
DECL|function|netlink_connect
r_static
r_int
id|netlink_connect
c_func
(paren
r_struct
id|socket
op_star
id|sock
comma
r_struct
id|sockaddr
op_star
id|addr
comma
r_int
id|alen
comma
r_int
id|flags
)paren
(brace
r_int
id|err
op_assign
l_int|0
suffix:semicolon
r_struct
id|sock
op_star
id|sk
op_assign
id|sock-&gt;sk
suffix:semicolon
r_struct
id|sockaddr_nl
op_star
id|nladdr
op_assign
(paren
r_struct
id|sockaddr_nl
op_star
)paren
id|addr
suffix:semicolon
r_if
c_cond
(paren
id|addr-&gt;sa_family
op_eq
id|AF_UNSPEC
)paren
(brace
id|sk-&gt;protinfo.af_netlink-&gt;dst_pid
op_assign
l_int|0
suffix:semicolon
id|sk-&gt;protinfo.af_netlink-&gt;dst_groups
op_assign
l_int|0
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|addr-&gt;sa_family
op_ne
id|AF_NETLINK
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
multiline_comment|/* Only superuser is allowed to send multicasts */
r_if
c_cond
(paren
id|nladdr-&gt;nl_groups
op_logical_and
op_logical_neg
id|capable
c_func
(paren
id|CAP_NET_ADMIN
)paren
)paren
r_return
op_minus
id|EPERM
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|sk-&gt;protinfo.af_netlink-&gt;pid
)paren
id|err
op_assign
id|netlink_autobind
c_func
(paren
id|sock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
op_eq
l_int|0
)paren
(brace
id|sk-&gt;protinfo.af_netlink-&gt;dst_pid
op_assign
id|nladdr-&gt;nl_pid
suffix:semicolon
id|sk-&gt;protinfo.af_netlink-&gt;dst_groups
op_assign
id|nladdr-&gt;nl_groups
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|netlink_getname
r_static
r_int
id|netlink_getname
c_func
(paren
r_struct
id|socket
op_star
id|sock
comma
r_struct
id|sockaddr
op_star
id|addr
comma
r_int
op_star
id|addr_len
comma
r_int
id|peer
)paren
(brace
r_struct
id|sock
op_star
id|sk
op_assign
id|sock-&gt;sk
suffix:semicolon
r_struct
id|sockaddr_nl
op_star
id|nladdr
op_assign
(paren
r_struct
id|sockaddr_nl
op_star
)paren
id|addr
suffix:semicolon
id|nladdr-&gt;nl_family
op_assign
id|AF_NETLINK
suffix:semicolon
op_star
id|addr_len
op_assign
r_sizeof
(paren
op_star
id|nladdr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|peer
)paren
(brace
id|nladdr-&gt;nl_pid
op_assign
id|sk-&gt;protinfo.af_netlink-&gt;dst_pid
suffix:semicolon
id|nladdr-&gt;nl_groups
op_assign
id|sk-&gt;protinfo.af_netlink-&gt;dst_groups
suffix:semicolon
)brace
r_else
(brace
id|nladdr-&gt;nl_pid
op_assign
id|sk-&gt;protinfo.af_netlink-&gt;pid
suffix:semicolon
id|nladdr-&gt;nl_groups
op_assign
id|sk-&gt;protinfo.af_netlink-&gt;groups
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|netlink_overrun
r_static
r_void
id|netlink_overrun
c_func
(paren
r_struct
id|sock
op_star
id|sk
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|test_and_set_bit
c_func
(paren
l_int|0
comma
op_amp
id|sk-&gt;protinfo.af_netlink-&gt;state
)paren
)paren
(brace
id|sk-&gt;err
op_assign
id|ENOBUFS
suffix:semicolon
id|sk
op_member_access_from_pointer
id|error_report
c_func
(paren
id|sk
)paren
suffix:semicolon
)brace
)brace
DECL|function|netlink_unicast
r_int
id|netlink_unicast
c_func
(paren
r_struct
id|sock
op_star
id|ssk
comma
r_struct
id|sk_buff
op_star
id|skb
comma
id|u32
id|pid
comma
r_int
id|nonblock
)paren
(brace
r_struct
id|sock
op_star
id|sk
suffix:semicolon
r_int
id|len
op_assign
id|skb-&gt;len
suffix:semicolon
r_int
id|protocol
op_assign
id|ssk-&gt;protocol
suffix:semicolon
r_int
id|timeo
suffix:semicolon
id|DECLARE_WAITQUEUE
c_func
(paren
id|wait
comma
id|current
)paren
suffix:semicolon
id|timeo
op_assign
id|sock_sndtimeo
c_func
(paren
id|ssk
comma
id|nonblock
)paren
suffix:semicolon
id|retry
suffix:colon
id|sk
op_assign
id|netlink_lookup
c_func
(paren
id|protocol
comma
id|pid
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sk
op_eq
l_int|NULL
)paren
r_goto
id|no_dst
suffix:semicolon
macro_line|#ifdef NL_EMULATE_DEV
r_if
c_cond
(paren
id|sk-&gt;protinfo.af_netlink-&gt;handler
)paren
(brace
id|skb_orphan
c_func
(paren
id|skb
)paren
suffix:semicolon
id|len
op_assign
id|sk-&gt;protinfo.af_netlink
op_member_access_from_pointer
id|handler
c_func
(paren
id|protocol
comma
id|skb
)paren
suffix:semicolon
id|sock_put
c_func
(paren
id|sk
)paren
suffix:semicolon
r_return
id|len
suffix:semicolon
)brace
macro_line|#endif
r_if
c_cond
(paren
id|atomic_read
c_func
(paren
op_amp
id|sk-&gt;rmem_alloc
)paren
OG
id|sk-&gt;rcvbuf
op_logical_or
id|test_bit
c_func
(paren
l_int|0
comma
op_amp
id|sk-&gt;protinfo.af_netlink-&gt;state
)paren
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|timeo
)paren
(brace
r_if
c_cond
(paren
id|ssk-&gt;protinfo.af_netlink-&gt;pid
op_eq
l_int|0
)paren
id|netlink_overrun
c_func
(paren
id|sk
)paren
suffix:semicolon
id|sock_put
c_func
(paren
id|sk
)paren
suffix:semicolon
id|kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
r_return
op_minus
id|EAGAIN
suffix:semicolon
)brace
id|__set_current_state
c_func
(paren
id|TASK_INTERRUPTIBLE
)paren
suffix:semicolon
id|add_wait_queue
c_func
(paren
op_amp
id|sk-&gt;protinfo.af_netlink-&gt;wait
comma
op_amp
id|wait
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|atomic_read
c_func
(paren
op_amp
id|sk-&gt;rmem_alloc
)paren
OG
id|sk-&gt;rcvbuf
op_logical_or
id|test_bit
c_func
(paren
l_int|0
comma
op_amp
id|sk-&gt;protinfo.af_netlink-&gt;state
)paren
)paren
op_logical_and
op_logical_neg
id|sk-&gt;dead
)paren
id|timeo
op_assign
id|schedule_timeout
c_func
(paren
id|timeo
)paren
suffix:semicolon
id|__set_current_state
c_func
(paren
id|TASK_RUNNING
)paren
suffix:semicolon
id|remove_wait_queue
c_func
(paren
op_amp
id|sk-&gt;protinfo.af_netlink-&gt;wait
comma
op_amp
id|wait
)paren
suffix:semicolon
id|sock_put
c_func
(paren
id|sk
)paren
suffix:semicolon
r_if
c_cond
(paren
id|signal_pending
c_func
(paren
id|current
)paren
)paren
(brace
id|kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
r_return
id|sock_intr_errno
c_func
(paren
id|timeo
)paren
suffix:semicolon
)brace
r_goto
id|retry
suffix:semicolon
)brace
id|skb_orphan
c_func
(paren
id|skb
)paren
suffix:semicolon
id|skb_set_owner_r
c_func
(paren
id|skb
comma
id|sk
)paren
suffix:semicolon
id|skb_queue_tail
c_func
(paren
op_amp
id|sk-&gt;receive_queue
comma
id|skb
)paren
suffix:semicolon
id|sk
op_member_access_from_pointer
id|data_ready
c_func
(paren
id|sk
comma
id|len
)paren
suffix:semicolon
id|sock_put
c_func
(paren
id|sk
)paren
suffix:semicolon
r_return
id|len
suffix:semicolon
id|no_dst
suffix:colon
id|kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
r_return
op_minus
id|ECONNREFUSED
suffix:semicolon
)brace
DECL|function|netlink_broadcast_deliver
r_static
id|__inline__
r_int
id|netlink_broadcast_deliver
c_func
(paren
r_struct
id|sock
op_star
id|sk
comma
r_struct
id|sk_buff
op_star
id|skb
)paren
(brace
macro_line|#ifdef NL_EMULATE_DEV
r_if
c_cond
(paren
id|sk-&gt;protinfo.af_netlink-&gt;handler
)paren
(brace
id|skb_orphan
c_func
(paren
id|skb
)paren
suffix:semicolon
id|sk-&gt;protinfo.af_netlink
op_member_access_from_pointer
id|handler
c_func
(paren
id|sk-&gt;protocol
comma
id|skb
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_else
macro_line|#endif
r_if
c_cond
(paren
id|atomic_read
c_func
(paren
op_amp
id|sk-&gt;rmem_alloc
)paren
op_le
id|sk-&gt;rcvbuf
op_logical_and
op_logical_neg
id|test_bit
c_func
(paren
l_int|0
comma
op_amp
id|sk-&gt;protinfo.af_netlink-&gt;state
)paren
)paren
(brace
id|skb_orphan
c_func
(paren
id|skb
)paren
suffix:semicolon
id|skb_set_owner_r
c_func
(paren
id|skb
comma
id|sk
)paren
suffix:semicolon
id|skb_queue_tail
c_func
(paren
op_amp
id|sk-&gt;receive_queue
comma
id|skb
)paren
suffix:semicolon
id|sk
op_member_access_from_pointer
id|data_ready
c_func
(paren
id|sk
comma
id|skb-&gt;len
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_return
op_minus
l_int|1
suffix:semicolon
)brace
DECL|function|netlink_broadcast
r_void
id|netlink_broadcast
c_func
(paren
r_struct
id|sock
op_star
id|ssk
comma
r_struct
id|sk_buff
op_star
id|skb
comma
id|u32
id|pid
comma
id|u32
id|group
comma
r_int
id|allocation
)paren
(brace
r_struct
id|sock
op_star
id|sk
suffix:semicolon
r_struct
id|sk_buff
op_star
id|skb2
op_assign
l_int|NULL
suffix:semicolon
r_int
id|protocol
op_assign
id|ssk-&gt;protocol
suffix:semicolon
r_int
id|failure
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* While we sleep in clone, do not allow to change socket list */
id|netlink_lock_table
c_func
(paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|sk
op_assign
id|nl_table
(braket
id|protocol
)braket
suffix:semicolon
id|sk
suffix:semicolon
id|sk
op_assign
id|sk-&gt;next
)paren
(brace
r_if
c_cond
(paren
id|ssk
op_eq
id|sk
)paren
r_continue
suffix:semicolon
r_if
c_cond
(paren
id|sk-&gt;protinfo.af_netlink-&gt;pid
op_eq
id|pid
op_logical_or
op_logical_neg
(paren
id|sk-&gt;protinfo.af_netlink-&gt;groups
op_amp
id|group
)paren
)paren
r_continue
suffix:semicolon
r_if
c_cond
(paren
id|failure
)paren
(brace
id|netlink_overrun
c_func
(paren
id|sk
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
id|sock_hold
c_func
(paren
id|sk
)paren
suffix:semicolon
r_if
c_cond
(paren
id|skb2
op_eq
l_int|NULL
)paren
(brace
r_if
c_cond
(paren
id|atomic_read
c_func
(paren
op_amp
id|skb-&gt;users
)paren
op_ne
l_int|1
)paren
(brace
id|skb2
op_assign
id|skb_clone
c_func
(paren
id|skb
comma
id|allocation
)paren
suffix:semicolon
)brace
r_else
(brace
id|skb2
op_assign
id|skb
suffix:semicolon
id|atomic_inc
c_func
(paren
op_amp
id|skb-&gt;users
)paren
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|skb2
op_eq
l_int|NULL
)paren
(brace
id|netlink_overrun
c_func
(paren
id|sk
)paren
suffix:semicolon
multiline_comment|/* Clone failed. Notify ALL listeners. */
id|failure
op_assign
l_int|1
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|netlink_broadcast_deliver
c_func
(paren
id|sk
comma
id|skb2
)paren
)paren
(brace
id|netlink_overrun
c_func
(paren
id|sk
)paren
suffix:semicolon
)brace
r_else
id|skb2
op_assign
l_int|NULL
suffix:semicolon
id|sock_put
c_func
(paren
id|sk
)paren
suffix:semicolon
)brace
id|netlink_unlock_table
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|skb2
)paren
id|kfree_skb
c_func
(paren
id|skb2
)paren
suffix:semicolon
id|kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
)brace
DECL|function|netlink_set_err
r_void
id|netlink_set_err
c_func
(paren
r_struct
id|sock
op_star
id|ssk
comma
id|u32
id|pid
comma
id|u32
id|group
comma
r_int
id|code
)paren
(brace
r_struct
id|sock
op_star
id|sk
suffix:semicolon
r_int
id|protocol
op_assign
id|ssk-&gt;protocol
suffix:semicolon
id|read_lock
c_func
(paren
op_amp
id|nl_table_lock
)paren
suffix:semicolon
r_for
c_loop
(paren
id|sk
op_assign
id|nl_table
(braket
id|protocol
)braket
suffix:semicolon
id|sk
suffix:semicolon
id|sk
op_assign
id|sk-&gt;next
)paren
(brace
r_if
c_cond
(paren
id|ssk
op_eq
id|sk
)paren
r_continue
suffix:semicolon
r_if
c_cond
(paren
id|sk-&gt;protinfo.af_netlink-&gt;pid
op_eq
id|pid
op_logical_or
op_logical_neg
(paren
id|sk-&gt;protinfo.af_netlink-&gt;groups
op_amp
id|group
)paren
)paren
r_continue
suffix:semicolon
id|sk-&gt;err
op_assign
id|code
suffix:semicolon
id|sk
op_member_access_from_pointer
id|error_report
c_func
(paren
id|sk
)paren
suffix:semicolon
)brace
id|read_unlock
c_func
(paren
op_amp
id|nl_table_lock
)paren
suffix:semicolon
)brace
DECL|function|netlink_sendmsg
r_static
r_int
id|netlink_sendmsg
c_func
(paren
r_struct
id|socket
op_star
id|sock
comma
r_struct
id|msghdr
op_star
id|msg
comma
r_int
id|len
comma
r_struct
id|scm_cookie
op_star
id|scm
)paren
(brace
r_struct
id|sock
op_star
id|sk
op_assign
id|sock-&gt;sk
suffix:semicolon
r_struct
id|sockaddr_nl
op_star
id|addr
op_assign
id|msg-&gt;msg_name
suffix:semicolon
id|u32
id|dst_pid
suffix:semicolon
id|u32
id|dst_groups
suffix:semicolon
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
r_int
id|err
suffix:semicolon
r_if
c_cond
(paren
id|msg-&gt;msg_flags
op_amp
id|MSG_OOB
)paren
r_return
op_minus
id|EOPNOTSUPP
suffix:semicolon
r_if
c_cond
(paren
id|msg-&gt;msg_namelen
)paren
(brace
r_if
c_cond
(paren
id|addr-&gt;nl_family
op_ne
id|AF_NETLINK
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|dst_pid
op_assign
id|addr-&gt;nl_pid
suffix:semicolon
id|dst_groups
op_assign
id|addr-&gt;nl_groups
suffix:semicolon
r_if
c_cond
(paren
id|dst_groups
op_logical_and
op_logical_neg
id|capable
c_func
(paren
id|CAP_NET_ADMIN
)paren
)paren
r_return
op_minus
id|EPERM
suffix:semicolon
)brace
r_else
(brace
id|dst_pid
op_assign
id|sk-&gt;protinfo.af_netlink-&gt;dst_pid
suffix:semicolon
id|dst_groups
op_assign
id|sk-&gt;protinfo.af_netlink-&gt;dst_groups
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|sk-&gt;protinfo.af_netlink-&gt;pid
)paren
(brace
id|err
op_assign
id|netlink_autobind
c_func
(paren
id|sock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
r_goto
id|out
suffix:semicolon
)brace
id|err
op_assign
op_minus
id|EMSGSIZE
suffix:semicolon
r_if
c_cond
(paren
(paren
r_int
)paren
id|len
OG
id|sk-&gt;sndbuf
op_minus
l_int|32
)paren
r_goto
id|out
suffix:semicolon
id|err
op_assign
op_minus
id|ENOBUFS
suffix:semicolon
id|skb
op_assign
id|alloc_skb
c_func
(paren
id|len
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|skb
op_eq
l_int|NULL
)paren
r_goto
id|out
suffix:semicolon
id|NETLINK_CB
c_func
(paren
id|skb
)paren
dot
id|pid
op_assign
id|sk-&gt;protinfo.af_netlink-&gt;pid
suffix:semicolon
id|NETLINK_CB
c_func
(paren
id|skb
)paren
dot
id|groups
op_assign
id|sk-&gt;protinfo.af_netlink-&gt;groups
suffix:semicolon
id|NETLINK_CB
c_func
(paren
id|skb
)paren
dot
id|dst_pid
op_assign
id|dst_pid
suffix:semicolon
id|NETLINK_CB
c_func
(paren
id|skb
)paren
dot
id|dst_groups
op_assign
id|dst_groups
suffix:semicolon
id|memcpy
c_func
(paren
id|NETLINK_CREDS
c_func
(paren
id|skb
)paren
comma
op_amp
id|scm-&gt;creds
comma
r_sizeof
(paren
r_struct
id|ucred
)paren
)paren
suffix:semicolon
multiline_comment|/* What can I do? Netlink is asynchronous, so that&n;&t;   we will have to save current capabilities to&n;&t;   check them, when this message will be delivered&n;&t;   to corresponding kernel module.   --ANK (980802)&n;&t; */
id|NETLINK_CB
c_func
(paren
id|skb
)paren
dot
id|eff_cap
op_assign
id|current-&gt;cap_effective
suffix:semicolon
id|err
op_assign
op_minus
id|EFAULT
suffix:semicolon
r_if
c_cond
(paren
id|memcpy_fromiovec
c_func
(paren
id|skb_put
c_func
(paren
id|skb
comma
id|len
)paren
comma
id|msg-&gt;msg_iov
comma
id|len
)paren
)paren
(brace
id|kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
r_if
c_cond
(paren
id|dst_groups
)paren
(brace
id|atomic_inc
c_func
(paren
op_amp
id|skb-&gt;users
)paren
suffix:semicolon
id|netlink_broadcast
c_func
(paren
id|sk
comma
id|skb
comma
id|dst_pid
comma
id|dst_groups
comma
id|GFP_KERNEL
)paren
suffix:semicolon
)brace
id|err
op_assign
id|netlink_unicast
c_func
(paren
id|sk
comma
id|skb
comma
id|dst_pid
comma
id|msg-&gt;msg_flags
op_amp
id|MSG_DONTWAIT
)paren
suffix:semicolon
id|out
suffix:colon
r_return
id|err
suffix:semicolon
)brace
DECL|function|netlink_recvmsg
r_static
r_int
id|netlink_recvmsg
c_func
(paren
r_struct
id|socket
op_star
id|sock
comma
r_struct
id|msghdr
op_star
id|msg
comma
r_int
id|len
comma
r_int
id|flags
comma
r_struct
id|scm_cookie
op_star
id|scm
)paren
(brace
r_struct
id|sock
op_star
id|sk
op_assign
id|sock-&gt;sk
suffix:semicolon
r_int
id|noblock
op_assign
id|flags
op_amp
id|MSG_DONTWAIT
suffix:semicolon
r_int
id|copied
suffix:semicolon
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
r_int
id|err
suffix:semicolon
r_if
c_cond
(paren
id|flags
op_amp
id|MSG_OOB
)paren
r_return
op_minus
id|EOPNOTSUPP
suffix:semicolon
id|copied
op_assign
l_int|0
suffix:semicolon
id|skb
op_assign
id|skb_recv_datagram
c_func
(paren
id|sk
comma
id|flags
comma
id|noblock
comma
op_amp
id|err
)paren
suffix:semicolon
r_if
c_cond
(paren
id|skb
op_eq
l_int|NULL
)paren
r_goto
id|out
suffix:semicolon
id|msg-&gt;msg_namelen
op_assign
l_int|0
suffix:semicolon
id|copied
op_assign
id|skb-&gt;len
suffix:semicolon
r_if
c_cond
(paren
id|len
OL
id|copied
)paren
(brace
id|msg-&gt;msg_flags
op_or_assign
id|MSG_TRUNC
suffix:semicolon
id|copied
op_assign
id|len
suffix:semicolon
)brace
id|skb-&gt;h.raw
op_assign
id|skb-&gt;data
suffix:semicolon
id|err
op_assign
id|skb_copy_datagram_iovec
c_func
(paren
id|skb
comma
l_int|0
comma
id|msg-&gt;msg_iov
comma
id|copied
)paren
suffix:semicolon
r_if
c_cond
(paren
id|msg-&gt;msg_name
)paren
(brace
r_struct
id|sockaddr_nl
op_star
id|addr
op_assign
(paren
r_struct
id|sockaddr_nl
op_star
)paren
id|msg-&gt;msg_name
suffix:semicolon
id|addr-&gt;nl_family
op_assign
id|AF_NETLINK
suffix:semicolon
id|addr-&gt;nl_pid
op_assign
id|NETLINK_CB
c_func
(paren
id|skb
)paren
dot
id|pid
suffix:semicolon
id|addr-&gt;nl_groups
op_assign
id|NETLINK_CB
c_func
(paren
id|skb
)paren
dot
id|dst_groups
suffix:semicolon
id|msg-&gt;msg_namelen
op_assign
r_sizeof
(paren
op_star
id|addr
)paren
suffix:semicolon
)brace
id|scm-&gt;creds
op_assign
op_star
id|NETLINK_CREDS
c_func
(paren
id|skb
)paren
suffix:semicolon
id|skb_free_datagram
c_func
(paren
id|sk
comma
id|skb
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sk-&gt;protinfo.af_netlink-&gt;cb
op_logical_and
id|atomic_read
c_func
(paren
op_amp
id|sk-&gt;rmem_alloc
)paren
op_le
id|sk-&gt;rcvbuf
op_div
l_int|2
)paren
id|netlink_dump
c_func
(paren
id|sk
)paren
suffix:semicolon
id|out
suffix:colon
r_if
c_cond
(paren
id|skb_queue_len
c_func
(paren
op_amp
id|sk-&gt;receive_queue
)paren
op_le
id|sk-&gt;rcvbuf
op_div
l_int|2
)paren
(brace
r_if
c_cond
(paren
id|skb_queue_len
c_func
(paren
op_amp
id|sk-&gt;receive_queue
)paren
op_eq
l_int|0
)paren
id|clear_bit
c_func
(paren
l_int|0
comma
op_amp
id|sk-&gt;protinfo.af_netlink-&gt;state
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|test_bit
c_func
(paren
l_int|0
comma
op_amp
id|sk-&gt;protinfo.af_netlink-&gt;state
)paren
)paren
id|wake_up_interruptible
c_func
(paren
op_amp
id|sk-&gt;protinfo.af_netlink-&gt;wait
)paren
suffix:semicolon
)brace
r_return
id|err
ques
c_cond
suffix:colon
id|copied
suffix:semicolon
)brace
DECL|function|netlink_data_ready
r_void
id|netlink_data_ready
c_func
(paren
r_struct
id|sock
op_star
id|sk
comma
r_int
id|len
)paren
(brace
r_if
c_cond
(paren
id|sk-&gt;protinfo.af_netlink-&gt;data_ready
)paren
id|sk-&gt;protinfo.af_netlink
op_member_access_from_pointer
id|data_ready
c_func
(paren
id|sk
comma
id|len
)paren
suffix:semicolon
r_if
c_cond
(paren
id|skb_queue_len
c_func
(paren
op_amp
id|sk-&gt;receive_queue
)paren
op_le
id|sk-&gt;rcvbuf
op_div
l_int|2
)paren
(brace
r_if
c_cond
(paren
id|skb_queue_len
c_func
(paren
op_amp
id|sk-&gt;receive_queue
)paren
op_eq
l_int|0
)paren
id|clear_bit
c_func
(paren
l_int|0
comma
op_amp
id|sk-&gt;protinfo.af_netlink-&gt;state
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|test_bit
c_func
(paren
l_int|0
comma
op_amp
id|sk-&gt;protinfo.af_netlink-&gt;state
)paren
)paren
id|wake_up_interruptible
c_func
(paren
op_amp
id|sk-&gt;protinfo.af_netlink-&gt;wait
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/*&n; *&t;We export these functions to other modules. They provide a &n; *&t;complete set of kernel non-blocking support for message&n; *&t;queueing.&n; */
r_struct
id|sock
op_star
DECL|function|netlink_kernel_create
id|netlink_kernel_create
c_func
(paren
r_int
id|unit
comma
r_void
(paren
op_star
id|input
)paren
(paren
r_struct
id|sock
op_star
id|sk
comma
r_int
id|len
)paren
)paren
(brace
r_struct
id|socket
op_star
id|sock
suffix:semicolon
r_struct
id|sock
op_star
id|sk
suffix:semicolon
r_if
c_cond
(paren
id|unit
OL
l_int|0
op_logical_or
id|unit
op_ge
id|MAX_LINKS
)paren
r_return
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|sock
op_assign
id|sock_alloc
c_func
(paren
)paren
)paren
)paren
r_return
l_int|NULL
suffix:semicolon
id|sock-&gt;type
op_assign
id|SOCK_RAW
suffix:semicolon
r_if
c_cond
(paren
id|netlink_create
c_func
(paren
id|sock
comma
id|unit
)paren
OL
l_int|0
)paren
(brace
id|sock_release
c_func
(paren
id|sock
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
id|sk
op_assign
id|sock-&gt;sk
suffix:semicolon
id|sk-&gt;data_ready
op_assign
id|netlink_data_ready
suffix:semicolon
r_if
c_cond
(paren
id|input
)paren
id|sk-&gt;protinfo.af_netlink-&gt;data_ready
op_assign
id|input
suffix:semicolon
id|netlink_insert
c_func
(paren
id|sk
comma
l_int|0
)paren
suffix:semicolon
r_return
id|sk
suffix:semicolon
)brace
DECL|function|netlink_destroy_callback
r_static
r_void
id|netlink_destroy_callback
c_func
(paren
r_struct
id|netlink_callback
op_star
id|cb
)paren
(brace
r_if
c_cond
(paren
id|cb-&gt;skb
)paren
id|kfree_skb
c_func
(paren
id|cb-&gt;skb
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|cb
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * It looks a bit ugly.&n; * It would be better to create kernel thread.&n; */
DECL|function|netlink_dump
r_static
r_int
id|netlink_dump
c_func
(paren
r_struct
id|sock
op_star
id|sk
)paren
(brace
r_struct
id|netlink_callback
op_star
id|cb
suffix:semicolon
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
r_struct
id|nlmsghdr
op_star
id|nlh
suffix:semicolon
r_int
id|len
suffix:semicolon
id|skb
op_assign
id|sock_rmalloc
c_func
(paren
id|sk
comma
id|NLMSG_GOODSIZE
comma
l_int|0
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|skb
)paren
r_return
op_minus
id|ENOBUFS
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|sk-&gt;protinfo.af_netlink-&gt;cb_lock
)paren
suffix:semicolon
id|cb
op_assign
id|sk-&gt;protinfo.af_netlink-&gt;cb
suffix:semicolon
r_if
c_cond
(paren
id|cb
op_eq
l_int|NULL
)paren
(brace
id|spin_unlock
c_func
(paren
op_amp
id|sk-&gt;protinfo.af_netlink-&gt;cb_lock
)paren
suffix:semicolon
id|kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|len
op_assign
id|cb
op_member_access_from_pointer
id|dump
c_func
(paren
id|skb
comma
id|cb
)paren
suffix:semicolon
r_if
c_cond
(paren
id|len
OG
l_int|0
)paren
(brace
id|spin_unlock
c_func
(paren
op_amp
id|sk-&gt;protinfo.af_netlink-&gt;cb_lock
)paren
suffix:semicolon
id|skb_queue_tail
c_func
(paren
op_amp
id|sk-&gt;receive_queue
comma
id|skb
)paren
suffix:semicolon
id|sk
op_member_access_from_pointer
id|data_ready
c_func
(paren
id|sk
comma
id|len
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|nlh
op_assign
id|__nlmsg_put
c_func
(paren
id|skb
comma
id|NETLINK_CB
c_func
(paren
id|cb-&gt;skb
)paren
dot
id|pid
comma
id|cb-&gt;nlh-&gt;nlmsg_seq
comma
id|NLMSG_DONE
comma
r_sizeof
(paren
r_int
)paren
)paren
suffix:semicolon
id|nlh-&gt;nlmsg_flags
op_or_assign
id|NLM_F_MULTI
suffix:semicolon
id|memcpy
c_func
(paren
id|NLMSG_DATA
c_func
(paren
id|nlh
)paren
comma
op_amp
id|len
comma
r_sizeof
(paren
id|len
)paren
)paren
suffix:semicolon
id|skb_queue_tail
c_func
(paren
op_amp
id|sk-&gt;receive_queue
comma
id|skb
)paren
suffix:semicolon
id|sk
op_member_access_from_pointer
id|data_ready
c_func
(paren
id|sk
comma
id|skb-&gt;len
)paren
suffix:semicolon
id|cb
op_member_access_from_pointer
id|done
c_func
(paren
id|cb
)paren
suffix:semicolon
id|sk-&gt;protinfo.af_netlink-&gt;cb
op_assign
l_int|NULL
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|sk-&gt;protinfo.af_netlink-&gt;cb_lock
)paren
suffix:semicolon
id|netlink_destroy_callback
c_func
(paren
id|cb
)paren
suffix:semicolon
id|sock_put
c_func
(paren
id|sk
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|netlink_dump_start
r_int
id|netlink_dump_start
c_func
(paren
r_struct
id|sock
op_star
id|ssk
comma
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|nlmsghdr
op_star
id|nlh
comma
r_int
(paren
op_star
id|dump
)paren
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|netlink_callback
op_star
)paren
comma
r_int
(paren
op_star
id|done
)paren
(paren
r_struct
id|netlink_callback
op_star
)paren
)paren
(brace
r_struct
id|netlink_callback
op_star
id|cb
suffix:semicolon
r_struct
id|sock
op_star
id|sk
suffix:semicolon
id|cb
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
op_star
id|cb
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cb
op_eq
l_int|NULL
)paren
r_return
op_minus
id|ENOBUFS
suffix:semicolon
id|memset
c_func
(paren
id|cb
comma
l_int|0
comma
r_sizeof
(paren
op_star
id|cb
)paren
)paren
suffix:semicolon
id|cb-&gt;dump
op_assign
id|dump
suffix:semicolon
id|cb-&gt;done
op_assign
id|done
suffix:semicolon
id|cb-&gt;nlh
op_assign
id|nlh
suffix:semicolon
id|atomic_inc
c_func
(paren
op_amp
id|skb-&gt;users
)paren
suffix:semicolon
id|cb-&gt;skb
op_assign
id|skb
suffix:semicolon
id|sk
op_assign
id|netlink_lookup
c_func
(paren
id|ssk-&gt;protocol
comma
id|NETLINK_CB
c_func
(paren
id|skb
)paren
dot
id|pid
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sk
op_eq
l_int|NULL
)paren
(brace
id|netlink_destroy_callback
c_func
(paren
id|cb
)paren
suffix:semicolon
r_return
op_minus
id|ECONNREFUSED
suffix:semicolon
)brace
multiline_comment|/* A dump is in progress... */
id|spin_lock
c_func
(paren
op_amp
id|sk-&gt;protinfo.af_netlink-&gt;cb_lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sk-&gt;protinfo.af_netlink-&gt;cb
)paren
(brace
id|spin_unlock
c_func
(paren
op_amp
id|sk-&gt;protinfo.af_netlink-&gt;cb_lock
)paren
suffix:semicolon
id|netlink_destroy_callback
c_func
(paren
id|cb
)paren
suffix:semicolon
id|sock_put
c_func
(paren
id|sk
)paren
suffix:semicolon
r_return
op_minus
id|EBUSY
suffix:semicolon
)brace
id|sk-&gt;protinfo.af_netlink-&gt;cb
op_assign
id|cb
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|sk-&gt;protinfo.af_netlink-&gt;cb_lock
)paren
suffix:semicolon
id|netlink_dump
c_func
(paren
id|sk
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|netlink_ack
r_void
id|netlink_ack
c_func
(paren
r_struct
id|sk_buff
op_star
id|in_skb
comma
r_struct
id|nlmsghdr
op_star
id|nlh
comma
r_int
id|err
)paren
(brace
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
r_struct
id|nlmsghdr
op_star
id|rep
suffix:semicolon
r_struct
id|nlmsgerr
op_star
id|errmsg
suffix:semicolon
r_int
id|size
suffix:semicolon
r_if
c_cond
(paren
id|err
op_eq
l_int|0
)paren
id|size
op_assign
id|NLMSG_SPACE
c_func
(paren
r_sizeof
(paren
r_struct
id|nlmsgerr
)paren
)paren
suffix:semicolon
r_else
id|size
op_assign
id|NLMSG_SPACE
c_func
(paren
l_int|4
op_plus
id|NLMSG_ALIGN
c_func
(paren
id|nlh-&gt;nlmsg_len
)paren
)paren
suffix:semicolon
id|skb
op_assign
id|alloc_skb
c_func
(paren
id|size
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|skb
)paren
r_return
suffix:semicolon
id|rep
op_assign
id|__nlmsg_put
c_func
(paren
id|skb
comma
id|NETLINK_CB
c_func
(paren
id|in_skb
)paren
dot
id|pid
comma
id|nlh-&gt;nlmsg_seq
comma
id|NLMSG_ERROR
comma
r_sizeof
(paren
r_struct
id|nlmsgerr
)paren
)paren
suffix:semicolon
id|errmsg
op_assign
id|NLMSG_DATA
c_func
(paren
id|rep
)paren
suffix:semicolon
id|errmsg-&gt;error
op_assign
id|err
suffix:semicolon
id|memcpy
c_func
(paren
op_amp
id|errmsg-&gt;msg
comma
id|nlh
comma
id|err
ques
c_cond
id|nlh-&gt;nlmsg_len
suffix:colon
r_sizeof
(paren
r_struct
id|nlmsghdr
)paren
)paren
suffix:semicolon
id|netlink_unicast
c_func
(paren
id|in_skb-&gt;sk
comma
id|skb
comma
id|NETLINK_CB
c_func
(paren
id|in_skb
)paren
dot
id|pid
comma
id|MSG_DONTWAIT
)paren
suffix:semicolon
)brace
macro_line|#ifdef NL_EMULATE_DEV
DECL|variable|nl_emu_lock
r_static
id|rwlock_t
id|nl_emu_lock
op_assign
id|RW_LOCK_UNLOCKED
suffix:semicolon
multiline_comment|/*&n; *&t;Backward compatibility.&n; */
DECL|function|netlink_attach
r_int
id|netlink_attach
c_func
(paren
r_int
id|unit
comma
r_int
(paren
op_star
id|function
)paren
(paren
r_int
comma
r_struct
id|sk_buff
op_star
id|skb
)paren
)paren
(brace
r_struct
id|sock
op_star
id|sk
op_assign
id|netlink_kernel_create
c_func
(paren
id|unit
comma
l_int|NULL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sk
op_eq
l_int|NULL
)paren
r_return
op_minus
id|ENOBUFS
suffix:semicolon
id|sk-&gt;protinfo.af_netlink-&gt;handler
op_assign
id|function
suffix:semicolon
id|write_lock_bh
c_func
(paren
op_amp
id|nl_emu_lock
)paren
suffix:semicolon
id|netlink_kernel
(braket
id|unit
)braket
op_assign
id|sk-&gt;socket
suffix:semicolon
id|write_unlock_bh
c_func
(paren
op_amp
id|nl_emu_lock
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|netlink_detach
r_void
id|netlink_detach
c_func
(paren
r_int
id|unit
)paren
(brace
r_struct
id|socket
op_star
id|sock
suffix:semicolon
id|write_lock_bh
c_func
(paren
op_amp
id|nl_emu_lock
)paren
suffix:semicolon
id|sock
op_assign
id|netlink_kernel
(braket
id|unit
)braket
suffix:semicolon
id|netlink_kernel
(braket
id|unit
)braket
op_assign
l_int|NULL
suffix:semicolon
id|write_unlock_bh
c_func
(paren
op_amp
id|nl_emu_lock
)paren
suffix:semicolon
id|sock_release
c_func
(paren
id|sock
)paren
suffix:semicolon
)brace
DECL|function|netlink_post
r_int
id|netlink_post
c_func
(paren
r_int
id|unit
comma
r_struct
id|sk_buff
op_star
id|skb
)paren
(brace
r_struct
id|socket
op_star
id|sock
suffix:semicolon
id|read_lock
c_func
(paren
op_amp
id|nl_emu_lock
)paren
suffix:semicolon
id|sock
op_assign
id|netlink_kernel
(braket
id|unit
)braket
suffix:semicolon
r_if
c_cond
(paren
id|sock
)paren
(brace
r_struct
id|sock
op_star
id|sk
op_assign
id|sock-&gt;sk
suffix:semicolon
id|memset
c_func
(paren
id|skb-&gt;cb
comma
l_int|0
comma
r_sizeof
(paren
id|skb-&gt;cb
)paren
)paren
suffix:semicolon
id|sock_hold
c_func
(paren
id|sk
)paren
suffix:semicolon
id|read_unlock
c_func
(paren
op_amp
id|nl_emu_lock
)paren
suffix:semicolon
id|netlink_broadcast
c_func
(paren
id|sk
comma
id|skb
comma
l_int|0
comma
op_complement
l_int|0
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
id|sock_put
c_func
(paren
id|sk
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|read_unlock
c_func
(paren
op_amp
id|nl_emu_lock
)paren
suffix:semicolon
r_return
op_minus
id|EUNATCH
suffix:semicolon
)brace
macro_line|#endif
macro_line|#ifdef CONFIG_PROC_FS
DECL|function|netlink_read_proc
r_static
r_int
id|netlink_read_proc
c_func
(paren
r_char
op_star
id|buffer
comma
r_char
op_star
op_star
id|start
comma
id|off_t
id|offset
comma
r_int
id|length
comma
r_int
op_star
id|eof
comma
r_void
op_star
id|data
)paren
(brace
id|off_t
id|pos
op_assign
l_int|0
suffix:semicolon
id|off_t
id|begin
op_assign
l_int|0
suffix:semicolon
r_int
id|len
op_assign
l_int|0
suffix:semicolon
r_int
id|i
suffix:semicolon
r_struct
id|sock
op_star
id|s
suffix:semicolon
id|len
op_add_assign
id|sprintf
c_func
(paren
id|buffer
comma
l_string|&quot;sk       Eth Pid    Groups   &quot;
l_string|&quot;Rmem     Wmem     Dump     Locks&bslash;n&quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|MAX_LINKS
suffix:semicolon
id|i
op_increment
)paren
(brace
id|read_lock
c_func
(paren
op_amp
id|nl_table_lock
)paren
suffix:semicolon
r_for
c_loop
(paren
id|s
op_assign
id|nl_table
(braket
id|i
)braket
suffix:semicolon
id|s
suffix:semicolon
id|s
op_assign
id|s-&gt;next
)paren
(brace
id|len
op_add_assign
id|sprintf
c_func
(paren
id|buffer
op_plus
id|len
comma
l_string|&quot;%p %-3d %-6d %08x %-8d %-8d %p %d&quot;
comma
id|s
comma
id|s-&gt;protocol
comma
id|s-&gt;protinfo.af_netlink-&gt;pid
comma
id|s-&gt;protinfo.af_netlink-&gt;groups
comma
id|atomic_read
c_func
(paren
op_amp
id|s-&gt;rmem_alloc
)paren
comma
id|atomic_read
c_func
(paren
op_amp
id|s-&gt;wmem_alloc
)paren
comma
id|s-&gt;protinfo.af_netlink-&gt;cb
comma
id|atomic_read
c_func
(paren
op_amp
id|s-&gt;refcnt
)paren
)paren
suffix:semicolon
id|buffer
(braket
id|len
op_increment
)braket
op_assign
l_char|&squot;&bslash;n&squot;
suffix:semicolon
id|pos
op_assign
id|begin
op_plus
id|len
suffix:semicolon
r_if
c_cond
(paren
id|pos
OL
id|offset
)paren
(brace
id|len
op_assign
l_int|0
suffix:semicolon
id|begin
op_assign
id|pos
suffix:semicolon
)brace
r_if
c_cond
(paren
id|pos
OG
id|offset
op_plus
id|length
)paren
(brace
id|read_unlock
c_func
(paren
op_amp
id|nl_table_lock
)paren
suffix:semicolon
r_goto
id|done
suffix:semicolon
)brace
)brace
id|read_unlock
c_func
(paren
op_amp
id|nl_table_lock
)paren
suffix:semicolon
)brace
op_star
id|eof
op_assign
l_int|1
suffix:semicolon
id|done
suffix:colon
op_star
id|start
op_assign
id|buffer
op_plus
(paren
id|offset
op_minus
id|begin
)paren
suffix:semicolon
id|len
op_sub_assign
(paren
id|offset
op_minus
id|begin
)paren
suffix:semicolon
r_if
c_cond
(paren
id|len
OG
id|length
)paren
(brace
id|len
op_assign
id|length
suffix:semicolon
)brace
r_if
c_cond
(paren
id|len
OL
l_int|0
)paren
(brace
id|len
op_assign
l_int|0
suffix:semicolon
)brace
r_return
id|len
suffix:semicolon
)brace
macro_line|#endif
DECL|variable|netlink_ops
r_struct
id|proto_ops
id|netlink_ops
op_assign
(brace
id|family
suffix:colon
id|PF_NETLINK
comma
id|release
suffix:colon
id|netlink_release
comma
id|bind
suffix:colon
id|netlink_bind
comma
id|connect
suffix:colon
id|netlink_connect
comma
id|socketpair
suffix:colon
id|sock_no_socketpair
comma
id|accept
suffix:colon
id|sock_no_accept
comma
id|getname
suffix:colon
id|netlink_getname
comma
id|poll
suffix:colon
id|datagram_poll
comma
id|ioctl
suffix:colon
id|sock_no_ioctl
comma
id|listen
suffix:colon
id|sock_no_listen
comma
id|shutdown
suffix:colon
id|sock_no_shutdown
comma
id|setsockopt
suffix:colon
id|sock_no_setsockopt
comma
id|getsockopt
suffix:colon
id|sock_no_getsockopt
comma
id|sendmsg
suffix:colon
id|netlink_sendmsg
comma
id|recvmsg
suffix:colon
id|netlink_recvmsg
comma
id|mmap
suffix:colon
id|sock_no_mmap
comma
)brace
suffix:semicolon
DECL|variable|netlink_family_ops
r_struct
id|net_proto_family
id|netlink_family_ops
op_assign
(brace
id|PF_NETLINK
comma
id|netlink_create
)brace
suffix:semicolon
DECL|function|netlink_proto_init
r_static
r_int
id|__init
id|netlink_proto_init
c_func
(paren
r_void
)paren
(brace
r_struct
id|sk_buff
op_star
id|dummy_skb
suffix:semicolon
r_if
c_cond
(paren
r_sizeof
(paren
r_struct
id|netlink_skb_parms
)paren
OG
r_sizeof
(paren
id|dummy_skb-&gt;cb
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_CRIT
l_string|&quot;netlink_init: panic&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|sock_register
c_func
(paren
op_amp
id|netlink_family_ops
)paren
suffix:semicolon
macro_line|#ifdef CONFIG_PROC_FS
id|create_proc_read_entry
c_func
(paren
l_string|&quot;net/netlink&quot;
comma
l_int|0
comma
l_int|0
comma
id|netlink_read_proc
comma
l_int|NULL
)paren
suffix:semicolon
macro_line|#endif
r_return
l_int|0
suffix:semicolon
)brace
DECL|variable|netlink_proto_init
id|module_init
c_func
(paren
id|netlink_proto_init
)paren
suffix:semicolon
eof
