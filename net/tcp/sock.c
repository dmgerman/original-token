multiline_comment|/* sock.c */
multiline_comment|/*&n;    Copyright (C) 1992  Ross Biro&n;&n;    This program is free software; you can redistribute it and/or modify&n;    it under the terms of the GNU General Public License as published by&n;    the Free Software Foundation; either version 2, or (at your option)&n;    any later version.&n;&n;    This program is distributed in the hope that it will be useful,&n;    but WITHOUT ANY WARRANTY; without even the implied warranty of&n;    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the&n;    GNU General Public License for more details.&n;&n;    You should have received a copy of the GNU General Public License&n;    along with this program; if not, write to the Free Software&n;    Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA. &n;&n;    The Author may be reached as bir7@leland.stanford.edu or&n;    C/O Department of Mathematics; Stanford University; Stanford, CA 94305&n;*/
multiline_comment|/* $Id: sock.c,v 0.8.4.2 1992/11/10 10:38:48 bir7 Exp $ */
multiline_comment|/* $Log: sock.c,v $&n; * Revision 0.8.4.2  1992/11/10  10:38:48  bir7&n; * Change free_s to kfree_s and accidently changed free_skb to kfree_skb.&n; *&n; * Revision 0.8.4.1  1992/11/10  00:17:18  bir7&n; * version change only.&n; *&n; * Revision 0.8.3.5  1992/11/10  00:14:47  bir7&n; * Changed malloc to kmalloc and added Id and Log&n; * */
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/socket.h&gt;
macro_line|#include &lt;netinet/in.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/timer.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/sock_ioctl.h&gt;
macro_line|#include &quot;../kern_sock.h&quot;
macro_line|#include &quot;timer.h&quot;
macro_line|#include &quot;ip.h&quot;
macro_line|#include &quot;tcp.h&quot;
macro_line|#include &quot;udp.h&quot;
macro_line|#include &quot;sock.h&quot;
macro_line|#include &lt;asm/segment.h&gt;
macro_line|#include &lt;asm/system.h&gt;
macro_line|#include &lt;linux/fcntl.h&gt;
macro_line|#include &lt;linux/mm.h&gt;
macro_line|#ifdef MEM_DEBUG
DECL|macro|MPRINTK
mdefine_line|#define MPRINTK printk
macro_line|#else
DECL|macro|MPRINTK
mdefine_line|#define MPRINTK dummy_routine
macro_line|#endif
DECL|macro|min
mdefine_line|#define min(a,b) ((a)&lt;(b)?(a):(b))
DECL|macro|swap
mdefine_line|#define swap(a,b) {unsigned long c; c=a; a=b; b=c;}
r_extern
r_struct
id|proto
id|tcp_prot
suffix:semicolon
r_extern
r_struct
id|proto
id|udp_prot
suffix:semicolon
r_extern
r_struct
id|proto
id|raw_prot
suffix:semicolon
r_extern
r_struct
id|proto
id|packet_prot
suffix:semicolon
r_static
r_int
id|ip_proto_init
c_func
(paren
r_void
)paren
suffix:semicolon
r_static
r_int
id|ip_proto_create
c_func
(paren
r_struct
id|socket
op_star
id|sock
comma
r_int
id|protocol
)paren
suffix:semicolon
r_static
r_int
id|ip_proto_dup
c_func
(paren
r_struct
id|socket
op_star
id|newsock
comma
r_struct
id|socket
op_star
id|oldsock
)paren
suffix:semicolon
r_static
r_int
id|ip_proto_release
c_func
(paren
r_struct
id|socket
op_star
id|sock
comma
r_struct
id|socket
op_star
id|peer
)paren
suffix:semicolon
r_static
r_int
id|ip_proto_bind
c_func
(paren
r_struct
id|socket
op_star
id|sock
comma
r_struct
id|sockaddr
op_star
id|umyaddr
comma
r_int
id|sockaddr_len
)paren
suffix:semicolon
r_static
r_int
id|ip_proto_connect
c_func
(paren
r_struct
id|socket
op_star
id|sock
comma
r_struct
id|sockaddr
op_star
id|uservaddr
comma
r_int
id|sockaddr_len
comma
r_int
id|flags
)paren
suffix:semicolon
r_static
r_int
id|ip_proto_socketpair
c_func
(paren
r_struct
id|socket
op_star
id|sock1
comma
r_struct
id|socket
op_star
id|sock2
)paren
suffix:semicolon
r_static
r_int
id|ip_proto_accept
c_func
(paren
r_struct
id|socket
op_star
id|sock
comma
r_struct
id|socket
op_star
id|newsock
comma
r_int
id|flags
)paren
suffix:semicolon
r_static
r_int
id|ip_proto_getname
c_func
(paren
r_struct
id|socket
op_star
id|sock
comma
r_struct
id|sockaddr
op_star
id|usockaddr
comma
r_int
op_star
id|usockaddr_len
comma
r_int
id|peer
)paren
suffix:semicolon
r_static
r_int
id|ip_proto_read
c_func
(paren
r_struct
id|socket
op_star
id|sock
comma
r_char
op_star
id|ubuf
comma
r_int
id|size
comma
r_int
id|nonblock
)paren
suffix:semicolon
r_static
r_int
id|ip_proto_write
c_func
(paren
r_struct
id|socket
op_star
id|sock
comma
r_char
op_star
id|ubuf
comma
r_int
id|size
comma
r_int
id|nonblock
)paren
suffix:semicolon
r_static
r_int
id|ip_proto_select
c_func
(paren
r_struct
id|socket
op_star
id|sock
comma
r_int
id|which
comma
id|select_table
op_star
id|wait
)paren
suffix:semicolon
r_static
r_int
id|ip_proto_ioctl
c_func
(paren
r_struct
id|socket
op_star
id|sock
comma
r_int
r_int
id|cmd
comma
r_int
r_int
id|arg
)paren
suffix:semicolon
r_static
r_int
id|ip_proto_listen
c_func
(paren
r_struct
id|socket
op_star
id|sock
comma
r_int
id|backlog
)paren
suffix:semicolon
r_static
r_int
id|ip_proto_send
(paren
r_struct
id|socket
op_star
id|sock
comma
r_void
op_star
id|buff
comma
r_int
id|len
comma
r_int
id|nonblock
comma
r_int
id|flags
)paren
suffix:semicolon
r_static
r_int
id|ip_proto_recv
(paren
r_struct
id|socket
op_star
id|sock
comma
r_void
op_star
id|buff
comma
r_int
id|len
comma
r_int
id|nonblock
comma
r_int
id|flags
)paren
suffix:semicolon
r_static
r_int
id|ip_proto_sendto
(paren
r_struct
id|socket
op_star
id|sock
comma
r_void
op_star
id|buff
comma
r_int
id|len
comma
r_int
id|nonblock
comma
r_int
id|flags
comma
r_struct
id|sockaddr
op_star
id|addr
comma
r_int
id|addr_len
)paren
suffix:semicolon
r_static
r_int
id|ip_proto_recvfrom
(paren
r_struct
id|socket
op_star
id|sock
comma
r_void
op_star
id|buff
comma
r_int
id|len
comma
r_int
id|nonblock
comma
r_int
id|flags
comma
r_struct
id|sockaddr
op_star
id|addr
comma
r_int
op_star
id|addr_len
)paren
suffix:semicolon
r_static
r_int
id|ip_proto_shutdown
(paren
r_struct
id|socket
op_star
id|sock
comma
r_int
id|how
)paren
suffix:semicolon
r_static
r_int
id|ip_proto_setsockopt
(paren
r_struct
id|socket
op_star
id|sock
comma
r_int
id|level
comma
r_int
id|optname
comma
r_char
op_star
id|optval
comma
r_int
id|optlen
)paren
suffix:semicolon
r_static
r_int
id|ip_proto_getsockopt
(paren
r_struct
id|socket
op_star
id|sock
comma
r_int
id|level
comma
r_int
id|optname
comma
r_char
op_star
id|optval
comma
r_int
op_star
id|optlen
)paren
suffix:semicolon
r_static
r_int
id|ip_proto_fcntl
(paren
r_struct
id|socket
op_star
id|sock
comma
r_int
r_int
id|cmd
comma
r_int
r_int
id|arg
)paren
suffix:semicolon
DECL|variable|inet_proto_ops
r_struct
id|proto_ops
id|inet_proto_ops
op_assign
(brace
id|ip_proto_init
comma
id|ip_proto_create
comma
id|ip_proto_dup
comma
id|ip_proto_release
comma
id|ip_proto_bind
comma
id|ip_proto_connect
comma
id|ip_proto_socketpair
comma
id|ip_proto_accept
comma
id|ip_proto_getname
comma
id|ip_proto_read
comma
id|ip_proto_write
comma
id|ip_proto_select
comma
id|ip_proto_ioctl
comma
id|ip_proto_listen
comma
id|ip_proto_send
comma
id|ip_proto_recv
comma
id|ip_proto_sendto
comma
id|ip_proto_recvfrom
comma
id|ip_proto_shutdown
comma
id|ip_proto_setsockopt
comma
id|ip_proto_getsockopt
comma
id|ip_proto_fcntl
)brace
suffix:semicolon
r_void
DECL|function|print_sk
id|print_sk
(paren
r_volatile
r_struct
id|sock
op_star
id|sk
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|sk
)paren
(brace
id|PRINTK
(paren
l_string|&quot;  print_sk(NULL)&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|PRINTK
(paren
l_string|&quot;  wmem_alloc = %d&bslash;n&quot;
comma
id|sk-&gt;wmem_alloc
)paren
suffix:semicolon
id|PRINTK
(paren
l_string|&quot;  rmem_alloc = %d&bslash;n&quot;
comma
id|sk-&gt;rmem_alloc
)paren
suffix:semicolon
id|PRINTK
(paren
l_string|&quot;  send_head = %X&bslash;n&quot;
comma
id|sk-&gt;send_head
)paren
suffix:semicolon
id|PRINTK
(paren
l_string|&quot;  state = %d&bslash;n&quot;
comma
id|sk-&gt;state
)paren
suffix:semicolon
id|PRINTK
(paren
l_string|&quot;  wback = %X, rqueue = %X&bslash;n&quot;
comma
id|sk-&gt;wback
comma
id|sk-&gt;rqueue
)paren
suffix:semicolon
id|PRINTK
(paren
l_string|&quot;  wfront = %X&bslash;n&quot;
comma
id|sk-&gt;wfront
)paren
suffix:semicolon
id|PRINTK
(paren
l_string|&quot;  daddr = %X, saddr = %X&bslash;n&quot;
comma
id|sk-&gt;daddr
comma
id|sk-&gt;saddr
)paren
suffix:semicolon
id|PRINTK
(paren
l_string|&quot;  num = %d&quot;
comma
id|sk-&gt;num
)paren
suffix:semicolon
id|PRINTK
(paren
l_string|&quot; next = %X&bslash;n&quot;
comma
id|sk-&gt;next
)paren
suffix:semicolon
id|PRINTK
(paren
l_string|&quot;  send_seq = %d, acked_seq = %d, copied_seq = %d&bslash;n&quot;
comma
id|sk-&gt;send_seq
comma
id|sk-&gt;acked_seq
comma
id|sk-&gt;copied_seq
)paren
suffix:semicolon
id|PRINTK
(paren
l_string|&quot;  rcv_ack_seq = %d, window_seq = %d, fin_seq = %d&bslash;n&quot;
comma
id|sk-&gt;rcv_ack_seq
comma
id|sk-&gt;window_seq
comma
id|sk-&gt;fin_seq
)paren
suffix:semicolon
id|PRINTK
(paren
l_string|&quot;  prot = %X&bslash;n&quot;
comma
id|sk-&gt;prot
)paren
suffix:semicolon
id|PRINTK
(paren
l_string|&quot;  pair = %X, back_log = %X&bslash;n&quot;
comma
id|sk-&gt;pair
comma
id|sk-&gt;back_log
)paren
suffix:semicolon
id|PRINTK
(paren
l_string|&quot;  inuse = %d , blog = %d&bslash;n&quot;
comma
id|sk-&gt;inuse
comma
id|sk-&gt;blog
)paren
suffix:semicolon
id|PRINTK
(paren
l_string|&quot;  dead = %d delay_acks=%d&bslash;n&quot;
comma
id|sk-&gt;dead
comma
id|sk-&gt;delay_acks
)paren
suffix:semicolon
id|PRINTK
(paren
l_string|&quot;  retransmits = %d, timeout = %d&bslash;n&quot;
comma
id|sk-&gt;retransmits
comma
id|sk-&gt;timeout
)paren
suffix:semicolon
id|PRINTK
(paren
l_string|&quot;  cong_window = %d, packets_out = %d&bslash;n&quot;
comma
id|sk-&gt;cong_window
comma
id|sk-&gt;packets_out
)paren
suffix:semicolon
)brace
r_void
DECL|function|print_skb
id|print_skb
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|skb
)paren
(brace
id|PRINTK
(paren
l_string|&quot;  print_skb(NULL)&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|PRINTK
(paren
l_string|&quot;  prev = %X, next = %X&bslash;n&quot;
comma
id|skb-&gt;prev
comma
id|skb-&gt;next
)paren
suffix:semicolon
id|PRINTK
(paren
l_string|&quot;  sk = %X link3 = %X&bslash;n&quot;
comma
id|skb-&gt;sk
comma
id|skb-&gt;link3
)paren
suffix:semicolon
id|PRINTK
(paren
l_string|&quot;  mem_addr = %X, mem_len = %d&bslash;n&quot;
comma
id|skb-&gt;mem_addr
comma
id|skb-&gt;mem_len
)paren
suffix:semicolon
id|PRINTK
(paren
l_string|&quot;  used = %d free = %d&bslash;n&quot;
comma
id|skb-&gt;used
comma
id|skb-&gt;free
)paren
suffix:semicolon
)brace
multiline_comment|/* just used to reference some pointers to keep gcc from over optimizing&n;   my code so that it doesn&squot;t work. */
DECL|function|dummy_routine
r_void
id|dummy_routine
c_func
(paren
r_void
op_star
id|dummy
comma
dot
dot
dot
)paren
(brace
r_return
suffix:semicolon
)brace
r_void
DECL|function|lock_skb
id|lock_skb
(paren
r_struct
id|sk_buff
op_star
id|skb
)paren
(brace
r_if
c_cond
(paren
id|skb-&gt;lock
)paren
(brace
id|printk
(paren
l_string|&quot;*** bug more than one lock on sk_buff. &bslash;n&quot;
)paren
suffix:semicolon
)brace
id|skb-&gt;lock
op_assign
l_int|1
suffix:semicolon
)brace
r_void
DECL|function|kfree_skb
id|kfree_skb
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_int
id|rw
)paren
(brace
r_if
c_cond
(paren
id|skb-&gt;lock
)paren
(brace
id|skb-&gt;free
op_assign
l_int|1
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|skb-&gt;sk
)paren
(brace
r_if
c_cond
(paren
id|rw
)paren
(brace
id|skb-&gt;sk-&gt;prot-&gt;rfree
(paren
id|skb-&gt;sk
comma
id|skb-&gt;mem_addr
comma
id|skb-&gt;mem_len
)paren
suffix:semicolon
)brace
r_else
(brace
id|skb-&gt;sk-&gt;prot-&gt;wfree
(paren
id|skb-&gt;sk
comma
id|skb-&gt;mem_addr
comma
id|skb-&gt;mem_len
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
id|kfree_s
(paren
id|skb-&gt;mem_addr
comma
id|skb-&gt;mem_len
)paren
suffix:semicolon
)brace
)brace
r_void
DECL|function|unlock_skb
id|unlock_skb
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_int
id|rw
)paren
(brace
r_if
c_cond
(paren
id|skb-&gt;lock
op_ne
l_int|1
)paren
(brace
id|printk
(paren
l_string|&quot;*** bug unlocking non-locked sk_buff. &bslash;n&quot;
)paren
suffix:semicolon
)brace
id|skb-&gt;lock
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|skb-&gt;free
)paren
id|kfree_skb
(paren
id|skb
comma
id|rw
)paren
suffix:semicolon
)brace
r_static
r_int
DECL|function|sk_inuse
id|sk_inuse
c_func
(paren
r_struct
id|proto
op_star
id|prot
comma
r_int
id|num
)paren
(brace
r_volatile
r_struct
id|sock
op_star
id|sk
suffix:semicolon
r_for
c_loop
(paren
id|sk
op_assign
id|prot-&gt;sock_array
(braket
id|num
op_amp
(paren
id|SOCK_ARRAY_SIZE
op_minus
l_int|1
)paren
)braket
suffix:semicolon
id|sk
op_ne
l_int|NULL
suffix:semicolon
id|sk
op_assign
id|sk-&gt;next
)paren
(brace
r_if
c_cond
(paren
id|sk-&gt;dummy_th.source
op_eq
id|num
)paren
r_return
(paren
l_int|1
)paren
suffix:semicolon
)brace
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
r_int
r_int
DECL|function|get_new_socknum
id|get_new_socknum
c_func
(paren
r_struct
id|proto
op_star
id|prot
comma
r_int
r_int
id|base
)paren
(brace
r_static
r_int
id|start
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* used to cycle through the port numbers so the chances of&n;     a confused connection drop. */
r_int
id|i
comma
id|j
suffix:semicolon
r_int
id|best
op_assign
l_int|0
suffix:semicolon
r_int
id|size
op_assign
l_int|32767
suffix:semicolon
multiline_comment|/* a big num. */
r_volatile
r_struct
id|sock
op_star
id|sk
suffix:semicolon
id|start
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|base
op_eq
l_int|0
)paren
id|base
op_assign
id|PROT_SOCK
op_plus
l_int|1
op_plus
(paren
id|start
op_mod
l_int|1024
)paren
suffix:semicolon
r_if
c_cond
(paren
id|base
op_le
id|PROT_SOCK
)paren
(brace
id|base
op_add_assign
id|PROT_SOCK
op_plus
(paren
id|start
op_mod
l_int|1024
)paren
suffix:semicolon
)brace
multiline_comment|/* now look through the entire array and try to find an empty&n;     ptr. */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|SOCK_ARRAY_SIZE
suffix:semicolon
id|i
op_increment
)paren
(brace
id|j
op_assign
l_int|0
suffix:semicolon
id|sk
op_assign
id|prot-&gt;sock_array
(braket
(paren
id|i
op_plus
id|base
op_plus
l_int|1
)paren
op_amp
(paren
id|SOCK_ARRAY_SIZE
op_minus
l_int|1
)paren
)braket
suffix:semicolon
r_while
c_loop
(paren
id|sk
op_ne
l_int|NULL
)paren
(brace
id|sk
op_assign
id|sk-&gt;next
suffix:semicolon
id|j
op_increment
suffix:semicolon
)brace
r_if
c_cond
(paren
id|j
op_eq
l_int|0
)paren
r_return
(paren
id|i
op_plus
id|base
op_plus
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|j
OL
id|size
)paren
(brace
id|best
op_assign
id|i
suffix:semicolon
id|size
op_assign
id|j
suffix:semicolon
)brace
)brace
multiline_comment|/* now make sure the one we want is not in use. */
r_while
c_loop
(paren
id|sk_inuse
(paren
id|prot
comma
id|base
op_plus
id|best
op_plus
l_int|1
)paren
)paren
(brace
id|best
op_add_assign
id|SOCK_ARRAY_SIZE
suffix:semicolon
)brace
r_return
(paren
id|best
op_plus
id|base
op_plus
l_int|1
)paren
suffix:semicolon
)brace
r_void
DECL|function|put_sock
id|put_sock
c_func
(paren
r_int
r_int
id|num
comma
r_volatile
r_struct
id|sock
op_star
id|sk
)paren
(brace
r_volatile
r_struct
id|sock
op_star
id|sk1
suffix:semicolon
r_volatile
r_struct
id|sock
op_star
id|sk2
suffix:semicolon
r_int
id|mask
suffix:semicolon
id|PRINTK
(paren
l_string|&quot;put_sock (num = %d, sk = %X&bslash;n&quot;
comma
id|num
comma
id|sk
)paren
suffix:semicolon
id|sk-&gt;num
op_assign
id|num
suffix:semicolon
id|sk-&gt;next
op_assign
l_int|NULL
suffix:semicolon
id|num
op_assign
id|num
op_amp
(paren
id|SOCK_ARRAY_SIZE
op_minus
l_int|1
)paren
suffix:semicolon
multiline_comment|/* we can&squot;t have an interupt renter here. */
id|cli
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sk-&gt;prot-&gt;sock_array
(braket
id|num
)braket
op_eq
l_int|NULL
)paren
(brace
id|sk-&gt;prot-&gt;sock_array
(braket
id|num
)braket
op_assign
id|sk
suffix:semicolon
id|sti
c_func
(paren
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|sti
c_func
(paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|mask
op_assign
l_int|0xff000000
suffix:semicolon
id|mask
op_ne
l_int|0xffffffff
suffix:semicolon
id|mask
op_assign
(paren
id|mask
op_rshift
l_int|8
)paren
op_or
id|mask
)paren
(brace
r_if
c_cond
(paren
id|mask
op_amp
id|sk-&gt;saddr
)paren
(brace
id|mask
op_assign
id|mask
op_lshift
l_int|8
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
id|PRINTK
(paren
l_string|&quot;mask = %X&bslash;n&quot;
comma
id|mask
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|sk1
op_assign
id|sk-&gt;prot-&gt;sock_array
(braket
id|num
)braket
suffix:semicolon
r_for
c_loop
(paren
id|sk2
op_assign
id|sk1
suffix:semicolon
id|sk2
op_ne
l_int|NULL
suffix:semicolon
id|sk2
op_assign
id|sk2-&gt;next
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|sk2-&gt;saddr
op_amp
id|mask
)paren
)paren
(brace
r_if
c_cond
(paren
id|sk2
op_eq
id|sk1
)paren
(brace
id|sk-&gt;next
op_assign
id|sk-&gt;prot-&gt;sock_array
(braket
id|num
)braket
suffix:semicolon
id|sk-&gt;prot-&gt;sock_array
(braket
id|num
)braket
op_assign
id|sk
suffix:semicolon
id|sti
c_func
(paren
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|sk-&gt;next
op_assign
id|sk2
suffix:semicolon
id|sk1-&gt;next
op_assign
id|sk
suffix:semicolon
id|sti
c_func
(paren
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|sk1
op_assign
id|sk2
suffix:semicolon
)brace
multiline_comment|/* goes at the end. */
id|sk-&gt;next
op_assign
l_int|NULL
suffix:semicolon
id|sk1-&gt;next
op_assign
id|sk
suffix:semicolon
id|sti
c_func
(paren
)paren
suffix:semicolon
)brace
r_static
r_void
DECL|function|remove_sock
id|remove_sock
c_func
(paren
r_volatile
r_struct
id|sock
op_star
id|sk1
)paren
(brace
r_volatile
r_struct
id|sock
op_star
id|sk2
suffix:semicolon
id|PRINTK
(paren
l_string|&quot;remove_sock(sk1=%X)&bslash;n&quot;
comma
id|sk1
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|sk1
)paren
(brace
id|printk
(paren
l_string|&quot;sock.c: remove_sock: sk1 == NULL&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|sk1-&gt;prot
)paren
(brace
id|printk
(paren
l_string|&quot;sock.c: remove_sock: sk1-&gt;prot == NULL&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/* we can&squot;t have this changing out from under us. */
id|cli
c_func
(paren
)paren
suffix:semicolon
id|sk2
op_assign
id|sk1-&gt;prot-&gt;sock_array
(braket
id|sk1-&gt;num
op_amp
(paren
id|SOCK_ARRAY_SIZE
op_minus
l_int|1
)paren
)braket
suffix:semicolon
r_if
c_cond
(paren
id|sk2
op_eq
id|sk1
)paren
(brace
id|sk1-&gt;prot-&gt;sock_array
(braket
id|sk1-&gt;num
op_amp
(paren
id|SOCK_ARRAY_SIZE
op_minus
l_int|1
)paren
)braket
op_assign
id|sk1-&gt;next
suffix:semicolon
id|sti
c_func
(paren
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_while
c_loop
(paren
id|sk2
op_logical_and
id|sk2-&gt;next
op_ne
id|sk1
)paren
id|sk2
op_assign
id|sk2-&gt;next
suffix:semicolon
r_if
c_cond
(paren
id|sk2
)paren
(brace
id|sk2-&gt;next
op_assign
id|sk1-&gt;next
suffix:semicolon
id|sti
c_func
(paren
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|sti
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sk1-&gt;num
op_ne
l_int|0
)paren
id|PRINTK
(paren
l_string|&quot;remove_sock: sock  not found.&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_void
DECL|function|destroy_sock
id|destroy_sock
c_func
(paren
r_volatile
r_struct
id|sock
op_star
id|sk
)paren
(brace
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
id|PRINTK
(paren
l_string|&quot;destroying socket %X&bslash;n&quot;
comma
id|sk
)paren
suffix:semicolon
multiline_comment|/* just to be safe. */
id|sk-&gt;inuse
op_assign
l_int|1
suffix:semicolon
id|remove_sock
(paren
id|sk
)paren
suffix:semicolon
multiline_comment|/* now we can no longer get new packets. */
id|delete_timer
c_func
(paren
(paren
r_struct
id|timer
op_star
)paren
op_amp
id|sk-&gt;time_wait
)paren
suffix:semicolon
multiline_comment|/* cleanup up the write buffer. */
r_for
c_loop
(paren
id|skb
op_assign
id|sk-&gt;wfront
suffix:semicolon
id|skb
op_ne
l_int|NULL
suffix:semicolon
)paren
(brace
r_struct
id|sk_buff
op_star
id|skb2
suffix:semicolon
id|skb2
op_assign
id|skb-&gt;next
suffix:semicolon
id|kfree_skb
c_func
(paren
id|skb
comma
id|FREE_WRITE
)paren
suffix:semicolon
id|skb
op_assign
id|skb2
suffix:semicolon
)brace
id|sk-&gt;wfront
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
id|sk-&gt;rqueue
op_ne
l_int|NULL
)paren
(brace
id|skb
op_assign
id|sk-&gt;rqueue
suffix:semicolon
r_do
(brace
r_struct
id|sk_buff
op_star
id|skb2
suffix:semicolon
id|skb2
op_assign
id|skb-&gt;next
suffix:semicolon
multiline_comment|/* this will take care of closing sockets that were&n;&t;     listening and didn&squot;t accept everything. */
r_if
c_cond
(paren
id|skb-&gt;sk
op_ne
l_int|NULL
op_logical_and
id|skb-&gt;sk
op_ne
id|sk
)paren
(brace
id|skb-&gt;sk-&gt;dead
op_assign
l_int|1
suffix:semicolon
id|skb-&gt;sk-&gt;prot-&gt;close
(paren
id|skb-&gt;sk
comma
l_int|0
)paren
suffix:semicolon
)brace
id|kfree_skb
c_func
(paren
id|skb
comma
id|FREE_READ
)paren
suffix:semicolon
id|skb
op_assign
id|skb2
suffix:semicolon
)brace
r_while
c_loop
(paren
id|skb
op_ne
id|sk-&gt;rqueue
)paren
suffix:semicolon
)brace
id|sk-&gt;rqueue
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/* now we need to clean up the send head. */
r_for
c_loop
(paren
id|skb
op_assign
id|sk-&gt;send_head
suffix:semicolon
id|skb
op_ne
l_int|NULL
suffix:semicolon
)paren
(brace
r_struct
id|sk_buff
op_star
id|skb2
suffix:semicolon
multiline_comment|/* we need to remove skb from the transmit queue. */
id|cli
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* see if it&squot;s in a transmit queue. */
r_if
c_cond
(paren
id|skb-&gt;next
op_ne
l_int|NULL
)paren
(brace
r_if
c_cond
(paren
id|skb-&gt;next
op_ne
id|skb
)paren
(brace
id|skb-&gt;next-&gt;prev
op_assign
id|skb-&gt;prev
suffix:semicolon
id|skb-&gt;prev-&gt;next
op_assign
id|skb-&gt;next
suffix:semicolon
)brace
r_else
(brace
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|DEV_NUMBUFFS
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|skb-&gt;dev
op_logical_and
id|skb-&gt;dev-&gt;buffs
(braket
id|i
)braket
op_eq
id|skb
)paren
(brace
id|skb-&gt;dev-&gt;buffs
(braket
id|i
)braket
op_assign
l_int|NULL
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
)brace
)brace
id|sti
c_func
(paren
)paren
suffix:semicolon
id|skb2
op_assign
id|skb-&gt;link3
suffix:semicolon
id|kfree_skb
c_func
(paren
id|skb
comma
id|FREE_WRITE
)paren
suffix:semicolon
id|skb
op_assign
id|skb2
suffix:semicolon
)brace
id|sk-&gt;send_head
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/* and now the backlog. */
r_if
c_cond
(paren
id|sk-&gt;back_log
op_ne
l_int|NULL
)paren
(brace
multiline_comment|/* this should never happen. */
id|printk
(paren
l_string|&quot;cleaning back_log. &bslash;n&quot;
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|skb
op_assign
id|sk-&gt;back_log
suffix:semicolon
r_do
(brace
r_struct
id|sk_buff
op_star
id|skb2
suffix:semicolon
id|skb2
op_assign
id|skb-&gt;next
suffix:semicolon
id|kfree_skb
c_func
(paren
id|skb
comma
id|FREE_READ
)paren
suffix:semicolon
id|skb
op_assign
id|skb2
suffix:semicolon
)brace
r_while
c_loop
(paren
id|skb
op_ne
id|sk-&gt;back_log
)paren
suffix:semicolon
id|sti
c_func
(paren
)paren
suffix:semicolon
)brace
id|sk-&gt;back_log
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/* Now if it has a half accepted/ closed socket. */
r_if
c_cond
(paren
id|sk-&gt;pair
)paren
(brace
id|sk-&gt;pair-&gt;dead
op_assign
l_int|1
suffix:semicolon
id|sk-&gt;pair-&gt;prot-&gt;close
(paren
id|sk
comma
l_int|0
)paren
suffix:semicolon
id|sk-&gt;pair
op_assign
l_int|NULL
suffix:semicolon
)brace
multiline_comment|/* now if everything is gone we can free the socket structure, &n;     otherwise we need to keep it around until everything is gone. */
r_if
c_cond
(paren
id|sk-&gt;rmem_alloc
op_eq
l_int|0
op_logical_and
id|sk-&gt;wmem_alloc
op_eq
l_int|0
)paren
(brace
id|kfree_s
(paren
(paren
r_void
op_star
)paren
id|sk
comma
r_sizeof
(paren
op_star
id|sk
)paren
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* this should never happen. */
multiline_comment|/* actually it can if an ack has just been sent. */
id|PRINTK
(paren
l_string|&quot;possible memory leak in socket = %X&bslash;n&quot;
comma
id|sk
)paren
suffix:semicolon
id|print_sk
(paren
id|sk
)paren
suffix:semicolon
id|sk-&gt;destroy
op_assign
l_int|1
suffix:semicolon
id|sk-&gt;ack_backlog
op_assign
l_int|0
suffix:semicolon
id|sk-&gt;inuse
op_assign
l_int|0
suffix:semicolon
id|sk-&gt;time_wait.len
op_assign
id|SOCK_DESTROY_TIME
suffix:semicolon
id|sk-&gt;timeout
op_assign
id|TIME_DESTROY
suffix:semicolon
id|reset_timer
(paren
(paren
r_struct
id|timer
op_star
)paren
op_amp
id|sk-&gt;time_wait
)paren
suffix:semicolon
)brace
)brace
r_static
r_int
DECL|function|ip_proto_fcntl
id|ip_proto_fcntl
(paren
r_struct
id|socket
op_star
id|sock
comma
r_int
r_int
id|cmd
comma
r_int
r_int
id|arg
)paren
(brace
r_volatile
r_struct
id|sock
op_star
id|sk
suffix:semicolon
id|sk
op_assign
id|sock-&gt;data
suffix:semicolon
r_if
c_cond
(paren
id|sk
op_eq
l_int|NULL
)paren
(brace
id|printk
(paren
l_string|&quot;Warning: sock-&gt;data = NULL: %d&bslash;n&quot;
comma
id|__LINE__
)paren
suffix:semicolon
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
r_switch
c_cond
(paren
id|cmd
)paren
(brace
r_case
id|F_SETOWN
suffix:colon
id|sk-&gt;proc
op_assign
id|arg
suffix:semicolon
r_return
(paren
l_int|0
)paren
suffix:semicolon
r_case
id|F_GETOWN
suffix:colon
r_return
(paren
id|sk-&gt;proc
)paren
suffix:semicolon
r_default
suffix:colon
r_return
(paren
op_minus
id|EINVAL
)paren
suffix:semicolon
)brace
)brace
r_static
r_int
DECL|function|ip_proto_setsockopt
id|ip_proto_setsockopt
c_func
(paren
r_struct
id|socket
op_star
id|sock
comma
r_int
id|level
comma
r_int
id|optname
comma
r_char
op_star
id|optval
comma
r_int
id|optlen
)paren
(brace
r_volatile
r_struct
id|sock
op_star
id|sk
suffix:semicolon
r_int
id|val
suffix:semicolon
multiline_comment|/* This should really pass things on to the other levels. */
r_if
c_cond
(paren
id|level
op_ne
id|SOL_SOCKET
)paren
r_return
(paren
op_minus
id|EOPNOTSUPP
)paren
suffix:semicolon
id|sk
op_assign
id|sock-&gt;data
suffix:semicolon
r_if
c_cond
(paren
id|sk
op_eq
l_int|NULL
)paren
(brace
id|printk
(paren
l_string|&quot;Warning: sock-&gt;data = NULL: %d&bslash;n&quot;
comma
id|__LINE__
)paren
suffix:semicolon
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
id|verify_area
(paren
id|optval
comma
r_sizeof
(paren
r_int
)paren
)paren
suffix:semicolon
id|val
op_assign
id|get_fs_long
(paren
(paren
r_int
r_int
op_star
)paren
id|optval
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|optname
)paren
(brace
r_case
id|SO_TYPE
suffix:colon
r_case
id|SO_ERROR
suffix:colon
r_default
suffix:colon
r_return
(paren
op_minus
id|ENOPROTOOPT
)paren
suffix:semicolon
r_case
id|SO_DEBUG
suffix:colon
multiline_comment|/* not implemented. */
r_case
id|SO_DONTROUTE
suffix:colon
r_case
id|SO_BROADCAST
suffix:colon
r_case
id|SO_SNDBUF
suffix:colon
r_case
id|SO_RCVBUF
suffix:colon
r_return
(paren
l_int|0
)paren
suffix:semicolon
r_case
id|SO_REUSEADDR
suffix:colon
r_if
c_cond
(paren
id|val
)paren
id|sk-&gt;reuse
op_assign
l_int|1
suffix:semicolon
r_else
id|sk-&gt;reuse
op_assign
l_int|0
suffix:semicolon
r_return
(paren
l_int|0
)paren
suffix:semicolon
r_case
id|SO_KEEPALIVE
suffix:colon
r_if
c_cond
(paren
id|val
)paren
id|sk-&gt;keepopen
op_assign
l_int|1
suffix:semicolon
r_else
id|sk-&gt;keepopen
op_assign
l_int|0
suffix:semicolon
r_return
(paren
l_int|0
)paren
suffix:semicolon
r_case
id|SO_OOBINLINE
suffix:colon
r_if
c_cond
(paren
id|val
)paren
id|sk-&gt;urginline
op_assign
l_int|1
suffix:semicolon
r_else
id|sk-&gt;urginline
op_assign
l_int|0
suffix:semicolon
r_return
(paren
l_int|0
)paren
suffix:semicolon
r_case
id|SO_NO_CHECK
suffix:colon
r_if
c_cond
(paren
id|val
)paren
id|sk-&gt;no_check
op_assign
l_int|1
suffix:semicolon
r_else
id|sk-&gt;no_check
op_assign
l_int|0
suffix:semicolon
r_return
(paren
l_int|0
)paren
suffix:semicolon
r_case
id|SO_PRIORITY
suffix:colon
r_if
c_cond
(paren
id|val
op_ge
l_int|0
op_logical_and
id|val
OL
id|DEV_NUMBUFFS
)paren
(brace
id|sk-&gt;priority
op_assign
id|val
suffix:semicolon
)brace
r_else
(brace
r_return
(paren
op_minus
id|EINVAL
)paren
suffix:semicolon
)brace
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
)brace
r_static
r_int
DECL|function|ip_proto_getsockopt
id|ip_proto_getsockopt
c_func
(paren
r_struct
id|socket
op_star
id|sock
comma
r_int
id|level
comma
r_int
id|optname
comma
r_char
op_star
id|optval
comma
r_int
op_star
id|optlen
)paren
(brace
r_volatile
r_struct
id|sock
op_star
id|sk
suffix:semicolon
r_int
id|val
suffix:semicolon
multiline_comment|/* This should really pass things on to the other levels. */
r_if
c_cond
(paren
id|level
op_ne
id|SOL_SOCKET
)paren
r_return
(paren
op_minus
id|EOPNOTSUPP
)paren
suffix:semicolon
id|sk
op_assign
id|sock-&gt;data
suffix:semicolon
r_if
c_cond
(paren
id|sk
op_eq
l_int|NULL
)paren
(brace
id|printk
(paren
l_string|&quot;Warning: sock-&gt;data = NULL: %d&bslash;n&quot;
comma
id|__LINE__
)paren
suffix:semicolon
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
r_switch
c_cond
(paren
id|optname
)paren
(brace
r_default
suffix:colon
r_return
(paren
op_minus
id|ENOPROTOOPT
)paren
suffix:semicolon
r_case
id|SO_DEBUG
suffix:colon
multiline_comment|/* not implemented. */
r_case
id|SO_DONTROUTE
suffix:colon
r_case
id|SO_BROADCAST
suffix:colon
r_case
id|SO_SNDBUF
suffix:colon
r_case
id|SO_RCVBUF
suffix:colon
id|val
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SO_REUSEADDR
suffix:colon
id|val
op_assign
id|sk-&gt;reuse
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SO_KEEPALIVE
suffix:colon
id|val
op_assign
id|sk-&gt;keepopen
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SO_TYPE
suffix:colon
r_if
c_cond
(paren
id|sk-&gt;prot
op_eq
op_amp
id|tcp_prot
)paren
id|val
op_assign
id|SOCK_STREAM
suffix:semicolon
r_else
id|val
op_assign
id|SOCK_DGRAM
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SO_ERROR
suffix:colon
id|val
op_assign
id|sk-&gt;err
suffix:semicolon
id|sk-&gt;err
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SO_OOBINLINE
suffix:colon
id|val
op_assign
id|sk-&gt;urginline
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SO_NO_CHECK
suffix:colon
id|val
op_assign
id|sk-&gt;no_check
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SO_PRIORITY
suffix:colon
id|val
op_assign
id|sk-&gt;priority
suffix:semicolon
r_break
suffix:semicolon
)brace
id|verify_area
(paren
id|optlen
comma
r_sizeof
(paren
r_int
)paren
)paren
suffix:semicolon
id|put_fs_long
(paren
r_sizeof
(paren
r_int
)paren
comma
(paren
r_int
r_int
op_star
)paren
id|optlen
)paren
suffix:semicolon
id|verify_area
c_func
(paren
id|optval
comma
r_sizeof
(paren
r_int
)paren
)paren
suffix:semicolon
id|put_fs_long
(paren
id|val
comma
(paren
r_int
r_int
op_star
)paren
id|optval
)paren
suffix:semicolon
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
r_static
r_int
DECL|function|ip_proto_listen
id|ip_proto_listen
c_func
(paren
r_struct
id|socket
op_star
id|sock
comma
r_int
id|backlog
)paren
(brace
r_volatile
r_struct
id|sock
op_star
id|sk
suffix:semicolon
id|sk
op_assign
id|sock-&gt;data
suffix:semicolon
r_if
c_cond
(paren
id|sk
op_eq
l_int|NULL
)paren
(brace
id|printk
(paren
l_string|&quot;Warning: sock-&gt;data = NULL: %d&bslash;n&quot;
comma
id|__LINE__
)paren
suffix:semicolon
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
multiline_comment|/* we may need to bind the socket. */
r_if
c_cond
(paren
id|sk-&gt;num
op_eq
l_int|0
)paren
(brace
id|sk-&gt;num
op_assign
id|get_new_socknum
(paren
id|sk-&gt;prot
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sk-&gt;num
op_eq
l_int|0
)paren
r_return
(paren
op_minus
id|EAGAIN
)paren
suffix:semicolon
id|put_sock
(paren
id|sk-&gt;num
comma
id|sk
)paren
suffix:semicolon
id|sk-&gt;dummy_th.source
op_assign
id|net16
c_func
(paren
id|sk-&gt;num
)paren
suffix:semicolon
)brace
id|sk-&gt;state
op_assign
id|TCP_LISTEN
suffix:semicolon
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
multiline_comment|/* Hardware should be inited here. */
DECL|function|ip_proto_init
r_static
r_int
id|ip_proto_init
c_func
(paren
r_void
)paren
(brace
r_int
id|i
suffix:semicolon
r_struct
id|device
op_star
id|dev
suffix:semicolon
r_struct
id|ip_protocol
op_star
id|p
suffix:semicolon
id|seq_offset
op_assign
id|CURRENT_TIME
op_star
l_int|250
suffix:semicolon
multiline_comment|/* add all the protocols. */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|SOCK_ARRAY_SIZE
suffix:semicolon
id|i
op_increment
)paren
(brace
id|tcp_prot.sock_array
(braket
id|i
)braket
op_assign
l_int|NULL
suffix:semicolon
id|udp_prot.sock_array
(braket
id|i
)braket
op_assign
l_int|NULL
suffix:semicolon
id|raw_prot.sock_array
(braket
id|i
)braket
op_assign
l_int|NULL
suffix:semicolon
)brace
r_for
c_loop
(paren
id|p
op_assign
id|ip_protocol_base
suffix:semicolon
id|p
op_ne
l_int|NULL
suffix:semicolon
)paren
(brace
r_struct
id|ip_protocol
op_star
id|tmp
suffix:semicolon
multiline_comment|/* add all the protocols. */
id|tmp
op_assign
id|p-&gt;next
suffix:semicolon
id|add_ip_protocol
(paren
id|p
)paren
suffix:semicolon
id|p
op_assign
id|tmp
suffix:semicolon
)brace
multiline_comment|/* add the devices */
r_for
c_loop
(paren
id|dev
op_assign
id|dev_base
suffix:semicolon
id|dev
op_ne
l_int|NULL
suffix:semicolon
id|dev
op_assign
id|dev-&gt;next
)paren
(brace
r_if
c_cond
(paren
id|dev-&gt;init
)paren
id|dev
op_member_access_from_pointer
id|init
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
id|timer_table
(braket
id|NET_TIMER
)braket
dot
id|fn
op_assign
id|net_timer
suffix:semicolon
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
r_static
r_int
DECL|function|ip_proto_create
id|ip_proto_create
(paren
r_struct
id|socket
op_star
id|sock
comma
r_int
id|protocol
)paren
(brace
r_volatile
r_struct
id|sock
op_star
id|sk
suffix:semicolon
r_struct
id|proto
op_star
id|prot
suffix:semicolon
r_int
id|err
suffix:semicolon
id|sk
op_assign
id|kmalloc
(paren
r_sizeof
(paren
op_star
id|sk
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sk
op_eq
l_int|NULL
)paren
r_return
(paren
op_minus
id|ENOMEM
)paren
suffix:semicolon
id|sk-&gt;num
op_assign
l_int|0
suffix:semicolon
r_switch
c_cond
(paren
id|sock-&gt;type
)paren
(brace
r_case
id|SOCK_STREAM
suffix:colon
r_case
id|SOCK_SEQPACKET
suffix:colon
r_if
c_cond
(paren
id|protocol
op_logical_and
id|protocol
op_ne
id|IPPROTO_TCP
)paren
(brace
id|kfree_s
(paren
(paren
r_void
op_star
)paren
id|sk
comma
r_sizeof
(paren
op_star
id|sk
)paren
)paren
suffix:semicolon
r_return
(paren
op_minus
id|EPROTONOSUPPORT
)paren
suffix:semicolon
)brace
id|sk-&gt;no_check
op_assign
id|TCP_NO_CHECK
suffix:semicolon
id|prot
op_assign
op_amp
id|tcp_prot
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SOCK_DGRAM
suffix:colon
r_if
c_cond
(paren
id|protocol
op_logical_and
id|protocol
op_ne
id|IPPROTO_UDP
)paren
(brace
id|kfree_s
(paren
(paren
r_void
op_star
)paren
id|sk
comma
r_sizeof
(paren
op_star
id|sk
)paren
)paren
suffix:semicolon
r_return
(paren
op_minus
id|EPROTONOSUPPORT
)paren
suffix:semicolon
)brace
id|sk-&gt;no_check
op_assign
id|UDP_NO_CHECK
suffix:semicolon
id|prot
op_assign
op_amp
id|udp_prot
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SOCK_RAW
suffix:colon
r_if
c_cond
(paren
op_logical_neg
id|suser
c_func
(paren
)paren
)paren
(brace
id|kfree_s
(paren
(paren
r_void
op_star
)paren
id|sk
comma
r_sizeof
(paren
op_star
id|sk
)paren
)paren
suffix:semicolon
r_return
(paren
op_minus
id|EPERM
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|protocol
)paren
(brace
id|kfree_s
(paren
(paren
r_void
op_star
)paren
id|sk
comma
r_sizeof
(paren
op_star
id|sk
)paren
)paren
suffix:semicolon
r_return
(paren
op_minus
id|EPROTONOSUPPORT
)paren
suffix:semicolon
)brace
id|prot
op_assign
op_amp
id|raw_prot
suffix:semicolon
id|sk-&gt;reuse
op_assign
l_int|1
suffix:semicolon
id|sk-&gt;no_check
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* doesn&squot;t matter no checksum is preformed&n;&t;&t;&t;    anyway. */
id|sk-&gt;num
op_assign
id|protocol
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SOCK_PACKET
suffix:colon
r_if
c_cond
(paren
op_logical_neg
id|suser
c_func
(paren
)paren
)paren
(brace
id|kfree_s
(paren
(paren
r_void
op_star
)paren
id|sk
comma
r_sizeof
(paren
op_star
id|sk
)paren
)paren
suffix:semicolon
r_return
(paren
op_minus
id|EPERM
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|protocol
)paren
(brace
id|kfree_s
(paren
(paren
r_void
op_star
)paren
id|sk
comma
r_sizeof
(paren
op_star
id|sk
)paren
)paren
suffix:semicolon
r_return
(paren
op_minus
id|EPROTONOSUPPORT
)paren
suffix:semicolon
)brace
id|prot
op_assign
op_amp
id|packet_prot
suffix:semicolon
id|sk-&gt;reuse
op_assign
l_int|1
suffix:semicolon
id|sk-&gt;no_check
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* doesn&squot;t matter no checksum is preformed&n;&t;&t;&t;    anyway. */
id|sk-&gt;num
op_assign
id|protocol
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|kfree_s
(paren
(paren
r_void
op_star
)paren
id|sk
comma
r_sizeof
(paren
op_star
id|sk
)paren
)paren
suffix:semicolon
r_return
(paren
op_minus
id|ESOCKTNOSUPPORT
)paren
suffix:semicolon
)brace
id|sk-&gt;protocol
op_assign
id|protocol
suffix:semicolon
id|sk-&gt;wmem_alloc
op_assign
l_int|0
suffix:semicolon
id|sk-&gt;rmem_alloc
op_assign
l_int|0
suffix:semicolon
id|sk-&gt;pair
op_assign
l_int|NULL
suffix:semicolon
id|sk-&gt;opt
op_assign
l_int|NULL
suffix:semicolon
id|sk-&gt;send_seq
op_assign
l_int|0
suffix:semicolon
id|sk-&gt;acked_seq
op_assign
l_int|0
suffix:semicolon
id|sk-&gt;copied_seq
op_assign
l_int|0
suffix:semicolon
id|sk-&gt;fin_seq
op_assign
l_int|0
suffix:semicolon
id|sk-&gt;proc
op_assign
l_int|0
suffix:semicolon
id|sk-&gt;rtt
op_assign
id|TCP_WRITE_TIME
suffix:semicolon
id|sk-&gt;packets_out
op_assign
l_int|0
suffix:semicolon
id|sk-&gt;cong_window
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* start with only sending one packet at a time. */
id|sk-&gt;exp_growth
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* if set cong_window grow exponentially every time&n;&t;&t;&t;  we get an ack. */
id|sk-&gt;urginline
op_assign
l_int|0
suffix:semicolon
id|sk-&gt;intr
op_assign
l_int|0
suffix:semicolon
id|sk-&gt;linger
op_assign
l_int|0
suffix:semicolon
id|sk-&gt;destroy
op_assign
l_int|0
suffix:semicolon
id|sk-&gt;reuse
op_assign
l_int|0
suffix:semicolon
id|sk-&gt;priority
op_assign
l_int|1
suffix:semicolon
id|sk-&gt;shutdown
op_assign
l_int|0
suffix:semicolon
id|sk-&gt;urg
op_assign
l_int|0
suffix:semicolon
id|sk-&gt;keepopen
op_assign
l_int|0
suffix:semicolon
id|sk-&gt;done
op_assign
l_int|0
suffix:semicolon
id|sk-&gt;ack_backlog
op_assign
l_int|0
suffix:semicolon
id|sk-&gt;window
op_assign
l_int|0
suffix:semicolon
id|sk-&gt;bytes_rcv
op_assign
l_int|0
suffix:semicolon
id|sk-&gt;state
op_assign
id|TCP_CLOSE
suffix:semicolon
id|sk-&gt;dead
op_assign
l_int|0
suffix:semicolon
id|sk-&gt;ack_timed
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* this is how many unacked bytes we will accept for&n;     this socket.  */
id|sk-&gt;max_unacked
op_assign
l_int|2048
suffix:semicolon
multiline_comment|/* needs to be at most 2 full packets. */
multiline_comment|/* how many packets we should send before forcing an ack. &n;     if this is set to zero it is the same as sk-&gt;delay_acks = 0 */
id|sk-&gt;max_ack_backlog
op_assign
id|MAX_ACK_BACKLOG
suffix:semicolon
id|sk-&gt;inuse
op_assign
l_int|0
suffix:semicolon
id|sk-&gt;delay_acks
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* default to waiting a while before sending&n;&t;&t;&t; acks.  */
id|sk-&gt;wback
op_assign
l_int|NULL
suffix:semicolon
id|sk-&gt;wfront
op_assign
l_int|NULL
suffix:semicolon
id|sk-&gt;rqueue
op_assign
l_int|NULL
suffix:semicolon
id|sk-&gt;mtu
op_assign
l_int|576
suffix:semicolon
id|sk-&gt;prot
op_assign
id|prot
suffix:semicolon
id|sk-&gt;sleep
op_assign
id|sock-&gt;wait
suffix:semicolon
id|sk-&gt;daddr
op_assign
l_int|0
suffix:semicolon
id|sk-&gt;saddr
op_assign
id|MY_IP_ADDR
suffix:semicolon
id|sk-&gt;err
op_assign
l_int|0
suffix:semicolon
id|sk-&gt;next
op_assign
l_int|NULL
suffix:semicolon
id|sk-&gt;pair
op_assign
l_int|NULL
suffix:semicolon
id|sk-&gt;send_tail
op_assign
l_int|NULL
suffix:semicolon
id|sk-&gt;send_head
op_assign
l_int|NULL
suffix:semicolon
id|sk-&gt;time_wait.len
op_assign
id|TCP_CONNECT_TIME
suffix:semicolon
id|sk-&gt;time_wait.when
op_assign
l_int|0
suffix:semicolon
id|sk-&gt;time_wait.sk
op_assign
id|sk
suffix:semicolon
id|sk-&gt;time_wait.next
op_assign
l_int|NULL
suffix:semicolon
id|sk-&gt;timeout
op_assign
l_int|0
suffix:semicolon
id|sk-&gt;back_log
op_assign
l_int|NULL
suffix:semicolon
id|sk-&gt;blog
op_assign
l_int|0
suffix:semicolon
id|sock-&gt;data
op_assign
(paren
r_void
op_star
)paren
id|sk
suffix:semicolon
id|sk-&gt;dummy_th.doff
op_assign
r_sizeof
(paren
id|sk-&gt;dummy_th
)paren
op_div
l_int|4
suffix:semicolon
id|sk-&gt;dummy_th.res1
op_assign
l_int|0
suffix:semicolon
id|sk-&gt;dummy_th.res2
op_assign
l_int|0
suffix:semicolon
id|sk-&gt;dummy_th.urg_ptr
op_assign
l_int|0
suffix:semicolon
id|sk-&gt;dummy_th.fin
op_assign
l_int|0
suffix:semicolon
id|sk-&gt;dummy_th.syn
op_assign
l_int|0
suffix:semicolon
id|sk-&gt;dummy_th.rst
op_assign
l_int|0
suffix:semicolon
id|sk-&gt;dummy_th.psh
op_assign
l_int|0
suffix:semicolon
id|sk-&gt;dummy_th.ack
op_assign
l_int|0
suffix:semicolon
id|sk-&gt;dummy_th.urg
op_assign
l_int|0
suffix:semicolon
id|sk-&gt;dummy_th.dest
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|sk-&gt;num
)paren
(brace
multiline_comment|/* it assumes that any protocol which allows&n;&t; the user to assign a number at socket&n;&t; creation time automatically&n;&t; shares. */
id|put_sock
(paren
id|sk-&gt;num
comma
id|sk
)paren
suffix:semicolon
id|sk-&gt;dummy_th.source
op_assign
id|net16
c_func
(paren
id|sk-&gt;num
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|sk-&gt;prot-&gt;init
)paren
(brace
id|err
op_assign
id|sk-&gt;prot
op_member_access_from_pointer
id|init
c_func
(paren
id|sk
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
op_ne
l_int|0
)paren
(brace
id|destroy_sock
(paren
id|sk
)paren
suffix:semicolon
r_return
(paren
id|err
)paren
suffix:semicolon
)brace
)brace
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
r_static
r_int
DECL|function|ip_proto_dup
id|ip_proto_dup
(paren
r_struct
id|socket
op_star
id|newsock
comma
r_struct
id|socket
op_star
id|oldsock
)paren
(brace
r_return
(paren
id|ip_proto_create
(paren
id|newsock
comma
(paren
(paren
r_volatile
r_struct
id|sock
op_star
)paren
(paren
id|oldsock-&gt;data
)paren
)paren
op_member_access_from_pointer
id|protocol
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/* the peer socket should always be NULL. */
r_static
r_int
DECL|function|ip_proto_release
id|ip_proto_release
c_func
(paren
r_struct
id|socket
op_star
id|sock
comma
r_struct
id|socket
op_star
id|peer
)paren
(brace
r_volatile
r_struct
id|sock
op_star
id|sk
suffix:semicolon
id|sk
op_assign
id|sock-&gt;data
suffix:semicolon
r_if
c_cond
(paren
id|sk
op_eq
l_int|NULL
)paren
r_return
(paren
l_int|0
)paren
suffix:semicolon
id|wake_up
(paren
id|sk-&gt;sleep
)paren
suffix:semicolon
multiline_comment|/* start closing the connection.  This may take a while. */
multiline_comment|/* if linger is set, we don&squot;t return until the close is&n;     complete.  Other wise we return immediately.  The&n;     actually closing is done the same either way. */
r_if
c_cond
(paren
id|sk-&gt;linger
op_eq
l_int|0
)paren
(brace
id|sk-&gt;prot
op_member_access_from_pointer
id|close
c_func
(paren
id|sk
comma
l_int|0
)paren
suffix:semicolon
id|sk-&gt;dead
op_assign
l_int|1
suffix:semicolon
)brace
r_else
(brace
id|sk-&gt;prot
op_member_access_from_pointer
id|close
c_func
(paren
id|sk
comma
l_int|0
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
r_while
c_loop
(paren
id|sk-&gt;state
op_ne
id|TCP_CLOSE
)paren
(brace
id|interruptible_sleep_on
(paren
id|sk-&gt;sleep
)paren
suffix:semicolon
r_if
c_cond
(paren
id|current-&gt;signal
op_amp
op_complement
id|current-&gt;blocked
)paren
(brace
id|sti
c_func
(paren
)paren
suffix:semicolon
r_return
(paren
op_minus
id|ERESTARTSYS
)paren
suffix:semicolon
)brace
)brace
id|sti
c_func
(paren
)paren
suffix:semicolon
id|sk-&gt;dead
op_assign
l_int|1
suffix:semicolon
)brace
id|sk-&gt;inuse
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* this will destroy it. */
id|release_sock
(paren
id|sk
)paren
suffix:semicolon
id|sock-&gt;data
op_assign
l_int|NULL
suffix:semicolon
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
multiline_comment|/* this needs to be changed to dissallow&n;   the rebinding of sockets.   What error&n;   should it return? */
r_static
r_int
DECL|function|ip_proto_bind
id|ip_proto_bind
(paren
r_struct
id|socket
op_star
id|sock
comma
r_struct
id|sockaddr
op_star
id|uaddr
comma
r_int
id|addr_len
)paren
(brace
r_struct
id|sockaddr_in
id|addr
suffix:semicolon
r_volatile
r_struct
id|sock
op_star
id|sk
comma
op_star
id|sk2
suffix:semicolon
r_int
r_int
id|snum
suffix:semicolon
id|sk
op_assign
id|sock-&gt;data
suffix:semicolon
r_if
c_cond
(paren
id|sk
op_eq
l_int|NULL
)paren
(brace
id|printk
(paren
l_string|&quot;Warning: sock-&gt;data = NULL: %d&bslash;n&quot;
comma
id|__LINE__
)paren
suffix:semicolon
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
multiline_comment|/* check this error. */
r_if
c_cond
(paren
id|sk-&gt;state
op_ne
id|TCP_CLOSE
)paren
r_return
(paren
op_minus
id|EIO
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sk-&gt;num
op_ne
l_int|0
)paren
r_return
(paren
op_minus
id|EINVAL
)paren
suffix:semicolon
id|verify_area
(paren
id|uaddr
comma
id|addr_len
)paren
suffix:semicolon
id|memcpy_fromfs
(paren
op_amp
id|addr
comma
id|uaddr
comma
id|min
(paren
r_sizeof
(paren
id|addr
)paren
comma
id|addr_len
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|addr.sin_family
op_logical_and
id|addr.sin_family
op_ne
id|AF_INET
)paren
r_return
(paren
op_minus
id|EINVAL
)paren
suffix:semicolon
multiline_comment|/* this needs to be changed. */
id|snum
op_assign
id|net16
c_func
(paren
id|addr.sin_port
)paren
suffix:semicolon
id|PRINTK
(paren
l_string|&quot;bind sk =%X to port = %d&bslash;n&quot;
comma
id|sk
comma
id|snum
)paren
suffix:semicolon
id|print_sk
(paren
id|sk
)paren
suffix:semicolon
id|sk
op_assign
id|sock-&gt;data
suffix:semicolon
multiline_comment|/* we can&squot;t just leave the socket bound wherever it is, it might be bound&n;     to a priveledged port. However, since there seems to be a bug here,&n;     we will leave it if the port is not priveledged(sp?) */
r_if
c_cond
(paren
id|snum
op_eq
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|sk-&gt;num
OG
id|PROT_SOCK
)paren
r_return
(paren
l_int|0
)paren
suffix:semicolon
id|snum
op_assign
id|get_new_socknum
(paren
id|sk-&gt;prot
comma
l_int|0
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|snum
op_le
id|PROT_SOCK
op_logical_and
op_logical_neg
id|suser
c_func
(paren
)paren
)paren
r_return
(paren
op_minus
id|EACCES
)paren
suffix:semicolon
r_if
c_cond
(paren
id|my_ip_addr
c_func
(paren
id|addr.sin_addr.s_addr
)paren
op_logical_or
id|addr.sin_addr.s_addr
op_eq
l_int|0
)paren
id|sk-&gt;saddr
op_assign
id|addr.sin_addr.s_addr
suffix:semicolon
id|PRINTK
(paren
l_string|&quot;sock_array[%d] = %X:&bslash;n&quot;
comma
id|snum
op_amp
(paren
id|SOCK_ARRAY_SIZE
op_minus
l_int|1
)paren
comma
id|sk-&gt;prot-&gt;sock_array
(braket
id|snum
op_amp
(paren
id|SOCK_ARRAY_SIZE
op_minus
l_int|1
)paren
)braket
)paren
suffix:semicolon
id|print_sk
(paren
id|sk-&gt;prot-&gt;sock_array
(braket
id|snum
op_amp
(paren
id|SOCK_ARRAY_SIZE
op_minus
l_int|1
)paren
)braket
)paren
suffix:semicolon
multiline_comment|/* make sure we are allowed to bind here. */
r_for
c_loop
(paren
id|sk2
op_assign
id|sk-&gt;prot-&gt;sock_array
(braket
id|snum
op_amp
(paren
id|SOCK_ARRAY_SIZE
op_minus
l_int|1
)paren
)braket
suffix:semicolon
id|sk2
op_ne
l_int|NULL
suffix:semicolon
id|sk2
op_assign
id|sk2-&gt;next
)paren
(brace
r_if
c_cond
(paren
id|sk2-&gt;num
op_ne
id|snum
)paren
r_continue
suffix:semicolon
r_if
c_cond
(paren
id|sk2-&gt;saddr
op_ne
id|sk-&gt;saddr
)paren
r_continue
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|sk-&gt;reuse
)paren
r_return
(paren
op_minus
id|EADDRINUSE
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|sk2-&gt;reuse
)paren
r_return
(paren
op_minus
id|EADDRINUSE
)paren
suffix:semicolon
)brace
id|remove_sock
(paren
id|sk
)paren
suffix:semicolon
id|put_sock
c_func
(paren
id|snum
comma
id|sk
)paren
suffix:semicolon
id|sk-&gt;dummy_th.source
op_assign
id|net16
c_func
(paren
id|sk-&gt;num
)paren
suffix:semicolon
id|sk-&gt;daddr
op_assign
l_int|0
suffix:semicolon
id|sk-&gt;dummy_th.dest
op_assign
l_int|0
suffix:semicolon
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
r_static
r_int
DECL|function|ip_proto_connect
id|ip_proto_connect
(paren
r_struct
id|socket
op_star
id|sock
comma
r_struct
id|sockaddr
op_star
id|uaddr
comma
r_int
id|addr_len
comma
r_int
id|flags
)paren
(brace
r_volatile
r_struct
id|sock
op_star
id|sk
suffix:semicolon
r_int
id|err
suffix:semicolon
id|sock-&gt;conn
op_assign
l_int|NULL
suffix:semicolon
id|sk
op_assign
id|sock-&gt;data
suffix:semicolon
r_if
c_cond
(paren
id|sk
op_eq
l_int|NULL
)paren
(brace
id|printk
(paren
l_string|&quot;Warning: sock-&gt;data = NULL: %d&bslash;n&quot;
comma
id|__LINE__
)paren
suffix:semicolon
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
multiline_comment|/* we may need to bind the socket. */
r_if
c_cond
(paren
id|sk-&gt;num
op_eq
l_int|0
)paren
(brace
id|sk-&gt;num
op_assign
id|get_new_socknum
(paren
id|sk-&gt;prot
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sk-&gt;num
op_eq
l_int|0
)paren
r_return
(paren
op_minus
id|EAGAIN
)paren
suffix:semicolon
id|put_sock
(paren
id|sk-&gt;num
comma
id|sk
)paren
suffix:semicolon
id|sk-&gt;dummy_th.source
op_assign
id|net16
c_func
(paren
id|sk-&gt;num
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|sk-&gt;prot-&gt;connect
op_eq
l_int|NULL
)paren
r_return
(paren
op_minus
id|EOPNOTSUPP
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sk-&gt;intr
op_eq
l_int|0
)paren
(brace
id|err
op_assign
id|sk-&gt;prot-&gt;connect
(paren
id|sk
comma
(paren
r_struct
id|sockaddr_in
op_star
)paren
id|uaddr
comma
id|addr_len
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
OL
l_int|0
)paren
r_return
(paren
id|err
)paren
suffix:semicolon
)brace
id|sock-&gt;state
op_assign
id|SS_CONNECTED
suffix:semicolon
r_if
c_cond
(paren
id|flags
op_amp
id|O_NONBLOCK
)paren
r_return
(paren
l_int|0
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* avoid the race condition */
r_while
c_loop
(paren
id|sk-&gt;state
op_ne
id|TCP_ESTABLISHED
op_logical_and
id|sk-&gt;state
OL
id|TCP_CLOSING
)paren
(brace
id|interruptible_sleep_on
(paren
id|sk-&gt;sleep
)paren
suffix:semicolon
r_if
c_cond
(paren
id|current-&gt;signal
op_amp
op_complement
id|current-&gt;blocked
)paren
(brace
id|sti
c_func
(paren
)paren
suffix:semicolon
id|sk-&gt;intr
op_assign
l_int|1
suffix:semicolon
r_return
(paren
op_minus
id|ERESTARTSYS
)paren
suffix:semicolon
)brace
)brace
id|sti
c_func
(paren
)paren
suffix:semicolon
id|sk-&gt;intr
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|sk-&gt;state
op_ne
id|TCP_ESTABLISHED
op_logical_and
id|sk-&gt;err
)paren
(brace
r_return
(paren
op_minus
id|sk-&gt;err
)paren
suffix:semicolon
)brace
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
r_static
r_int
DECL|function|ip_proto_socketpair
id|ip_proto_socketpair
(paren
r_struct
id|socket
op_star
id|sock1
comma
r_struct
id|socket
op_star
id|sock2
)paren
(brace
r_return
(paren
op_minus
id|EOPNOTSUPP
)paren
suffix:semicolon
)brace
r_static
r_int
DECL|function|ip_proto_accept
id|ip_proto_accept
(paren
r_struct
id|socket
op_star
id|sock
comma
r_struct
id|socket
op_star
id|newsock
comma
r_int
id|flags
)paren
(brace
r_volatile
r_struct
id|sock
op_star
id|sk1
comma
op_star
id|sk2
suffix:semicolon
id|sk1
op_assign
id|sock-&gt;data
suffix:semicolon
r_if
c_cond
(paren
id|sk1
op_eq
l_int|NULL
)paren
(brace
id|printk
(paren
l_string|&quot;Warning: sock-&gt;data = NULL: %d&bslash;n&quot;
comma
id|__LINE__
)paren
suffix:semicolon
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
id|newsock-&gt;data
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
id|sk1-&gt;prot-&gt;accept
op_eq
l_int|NULL
)paren
r_return
(paren
op_minus
id|EOPNOTSUPP
)paren
suffix:semicolon
multiline_comment|/* restore the state if we have been interrupted, and&n;     then returned. */
r_if
c_cond
(paren
id|sk1-&gt;pair
op_ne
l_int|NULL
)paren
(brace
id|sk2
op_assign
id|sk1-&gt;pair
suffix:semicolon
id|sk1-&gt;pair
op_assign
l_int|NULL
suffix:semicolon
)brace
r_else
(brace
id|sk2
op_assign
id|sk1-&gt;prot-&gt;accept
(paren
id|sk1
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sk2
op_eq
l_int|NULL
)paren
(brace
r_if
c_cond
(paren
id|sk1-&gt;err
op_le
l_int|0
)paren
id|printk
(paren
l_string|&quot;Warning sock.c:sk1-&gt;err &lt;= 0.  Returning non-error.&bslash;n&quot;
)paren
suffix:semicolon
r_return
(paren
op_minus
id|sk1-&gt;err
)paren
suffix:semicolon
)brace
)brace
id|newsock-&gt;data
op_assign
(paren
r_void
op_star
)paren
id|sk2
suffix:semicolon
id|sk2-&gt;sleep
op_assign
(paren
r_void
op_star
)paren
id|newsock-&gt;wait
suffix:semicolon
id|newsock-&gt;conn
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
id|flags
op_amp
id|O_NONBLOCK
)paren
r_return
(paren
l_int|0
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* avoid the race. */
r_while
c_loop
(paren
id|sk2-&gt;state
op_eq
id|TCP_SYN_RECV
)paren
(brace
id|interruptible_sleep_on
(paren
id|sk2-&gt;sleep
)paren
suffix:semicolon
r_if
c_cond
(paren
id|current-&gt;signal
op_amp
op_complement
id|current-&gt;blocked
)paren
(brace
id|sti
c_func
(paren
)paren
suffix:semicolon
id|sk1-&gt;pair
op_assign
id|sk2
suffix:semicolon
id|sk2-&gt;sleep
op_assign
l_int|NULL
suffix:semicolon
id|newsock-&gt;data
op_assign
l_int|NULL
suffix:semicolon
r_return
(paren
op_minus
id|ERESTARTSYS
)paren
suffix:semicolon
)brace
)brace
id|sti
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sk2-&gt;state
op_ne
id|TCP_ESTABLISHED
op_logical_and
id|sk2-&gt;err
OG
l_int|0
)paren
(brace
r_int
id|err
suffix:semicolon
id|err
op_assign
op_minus
id|sk2-&gt;err
suffix:semicolon
id|destroy_sock
(paren
id|sk2
)paren
suffix:semicolon
id|newsock-&gt;data
op_assign
l_int|NULL
suffix:semicolon
r_return
(paren
id|err
)paren
suffix:semicolon
)brace
id|newsock-&gt;state
op_assign
id|SS_CONNECTED
suffix:semicolon
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
r_static
r_int
DECL|function|ip_proto_getname
id|ip_proto_getname
c_func
(paren
r_struct
id|socket
op_star
id|sock
comma
r_struct
id|sockaddr
op_star
id|uaddr
comma
r_int
op_star
id|uaddr_len
comma
r_int
id|peer
)paren
(brace
r_struct
id|sockaddr_in
id|sin
suffix:semicolon
r_volatile
r_struct
id|sock
op_star
id|sk
suffix:semicolon
r_int
id|len
suffix:semicolon
id|verify_area
c_func
(paren
id|uaddr_len
comma
r_sizeof
(paren
id|len
)paren
)paren
suffix:semicolon
id|len
op_assign
id|get_fs_long
c_func
(paren
id|uaddr_len
)paren
suffix:semicolon
multiline_comment|/* check this error. */
r_if
c_cond
(paren
id|len
OL
r_sizeof
(paren
id|sin
)paren
)paren
r_return
(paren
op_minus
id|EINVAL
)paren
suffix:semicolon
id|verify_area
(paren
id|uaddr
comma
id|len
)paren
suffix:semicolon
id|sin.sin_family
op_assign
id|AF_INET
suffix:semicolon
id|sk
op_assign
id|sock-&gt;data
suffix:semicolon
r_if
c_cond
(paren
id|sk
op_eq
l_int|NULL
)paren
(brace
id|printk
(paren
l_string|&quot;Warning: sock-&gt;data = NULL: %d&bslash;n&quot;
comma
id|__LINE__
)paren
suffix:semicolon
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|peer
)paren
(brace
r_if
c_cond
(paren
id|sk-&gt;state
op_ne
id|TCP_ESTABLISHED
)paren
r_return
(paren
op_minus
id|ENOTCONN
)paren
suffix:semicolon
id|sin.sin_port
op_assign
id|sk-&gt;dummy_th.dest
suffix:semicolon
id|sin.sin_addr.s_addr
op_assign
id|sk-&gt;daddr
suffix:semicolon
)brace
r_else
(brace
id|sin.sin_port
op_assign
id|sk-&gt;dummy_th.source
suffix:semicolon
id|sin.sin_addr.s_addr
op_assign
id|sk-&gt;saddr
suffix:semicolon
)brace
id|len
op_assign
r_sizeof
(paren
id|sin
)paren
suffix:semicolon
id|memcpy_tofs
c_func
(paren
id|uaddr
comma
op_amp
id|sin
comma
r_sizeof
(paren
id|sin
)paren
)paren
suffix:semicolon
id|put_fs_long
(paren
id|len
comma
id|uaddr_len
)paren
suffix:semicolon
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
r_static
r_int
DECL|function|ip_proto_read
id|ip_proto_read
(paren
r_struct
id|socket
op_star
id|sock
comma
r_char
op_star
id|ubuf
comma
r_int
id|size
comma
r_int
id|noblock
)paren
(brace
r_volatile
r_struct
id|sock
op_star
id|sk
suffix:semicolon
id|sk
op_assign
id|sock-&gt;data
suffix:semicolon
r_if
c_cond
(paren
id|sk
op_eq
l_int|NULL
)paren
(brace
id|printk
(paren
l_string|&quot;Warning: sock-&gt;data = NULL: %d&bslash;n&quot;
comma
id|__LINE__
)paren
suffix:semicolon
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|sk-&gt;shutdown
op_amp
id|RCV_SHUTDOWN
)paren
r_return
(paren
op_minus
id|EIO
)paren
suffix:semicolon
multiline_comment|/* we may need to bind the socket. */
r_if
c_cond
(paren
id|sk-&gt;num
op_eq
l_int|0
)paren
(brace
id|sk-&gt;num
op_assign
id|get_new_socknum
(paren
id|sk-&gt;prot
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sk-&gt;num
op_eq
l_int|0
)paren
r_return
(paren
op_minus
id|EAGAIN
)paren
suffix:semicolon
id|put_sock
(paren
id|sk-&gt;num
comma
id|sk
)paren
suffix:semicolon
id|sk-&gt;dummy_th.source
op_assign
id|net16
c_func
(paren
id|sk-&gt;num
)paren
suffix:semicolon
)brace
r_return
(paren
id|sk-&gt;prot-&gt;read
(paren
id|sk
comma
id|ubuf
comma
id|size
comma
id|noblock
comma
l_int|0
)paren
)paren
suffix:semicolon
)brace
r_static
r_int
DECL|function|ip_proto_recv
id|ip_proto_recv
(paren
r_struct
id|socket
op_star
id|sock
comma
r_void
op_star
id|ubuf
comma
r_int
id|size
comma
r_int
id|noblock
comma
r_int
id|flags
)paren
(brace
r_volatile
r_struct
id|sock
op_star
id|sk
suffix:semicolon
id|sk
op_assign
id|sock-&gt;data
suffix:semicolon
r_if
c_cond
(paren
id|sk
op_eq
l_int|NULL
)paren
(brace
id|printk
(paren
l_string|&quot;Warning: sock-&gt;data = NULL: %d&bslash;n&quot;
comma
id|__LINE__
)paren
suffix:semicolon
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|sk-&gt;shutdown
op_amp
id|RCV_SHUTDOWN
)paren
r_return
(paren
op_minus
id|EIO
)paren
suffix:semicolon
multiline_comment|/* we may need to bind the socket. */
r_if
c_cond
(paren
id|sk-&gt;num
op_eq
l_int|0
)paren
(brace
id|sk-&gt;num
op_assign
id|get_new_socknum
(paren
id|sk-&gt;prot
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sk-&gt;num
op_eq
l_int|0
)paren
r_return
(paren
op_minus
id|EAGAIN
)paren
suffix:semicolon
id|put_sock
(paren
id|sk-&gt;num
comma
id|sk
)paren
suffix:semicolon
id|sk-&gt;dummy_th.source
op_assign
id|net16
c_func
(paren
id|sk-&gt;num
)paren
suffix:semicolon
)brace
r_return
(paren
id|sk-&gt;prot-&gt;read
(paren
id|sk
comma
id|ubuf
comma
id|size
comma
id|noblock
comma
id|flags
)paren
)paren
suffix:semicolon
)brace
r_static
r_int
DECL|function|ip_proto_write
id|ip_proto_write
(paren
r_struct
id|socket
op_star
id|sock
comma
r_char
op_star
id|ubuf
comma
r_int
id|size
comma
r_int
id|noblock
)paren
(brace
r_volatile
r_struct
id|sock
op_star
id|sk
suffix:semicolon
id|sk
op_assign
id|sock-&gt;data
suffix:semicolon
r_if
c_cond
(paren
id|sk
op_eq
l_int|NULL
)paren
(brace
id|printk
(paren
l_string|&quot;Warning: sock-&gt;data = NULL: %d&bslash;n&quot;
comma
id|__LINE__
)paren
suffix:semicolon
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|sk-&gt;shutdown
op_amp
id|SEND_SHUTDOWN
)paren
r_return
(paren
op_minus
id|EIO
)paren
suffix:semicolon
multiline_comment|/* we may need to bind the socket. */
r_if
c_cond
(paren
id|sk-&gt;num
op_eq
l_int|0
)paren
(brace
id|sk-&gt;num
op_assign
id|get_new_socknum
(paren
id|sk-&gt;prot
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sk-&gt;num
op_eq
l_int|0
)paren
r_return
(paren
op_minus
id|EAGAIN
)paren
suffix:semicolon
id|put_sock
(paren
id|sk-&gt;num
comma
id|sk
)paren
suffix:semicolon
id|sk-&gt;dummy_th.source
op_assign
id|net16
c_func
(paren
id|sk-&gt;num
)paren
suffix:semicolon
)brace
r_return
(paren
id|sk-&gt;prot-&gt;write
(paren
id|sk
comma
id|ubuf
comma
id|size
comma
id|noblock
comma
l_int|0
)paren
)paren
suffix:semicolon
)brace
r_static
r_int
DECL|function|ip_proto_send
id|ip_proto_send
(paren
r_struct
id|socket
op_star
id|sock
comma
r_void
op_star
id|ubuf
comma
r_int
id|size
comma
r_int
id|noblock
comma
r_int
id|flags
)paren
(brace
r_volatile
r_struct
id|sock
op_star
id|sk
suffix:semicolon
id|sk
op_assign
id|sock-&gt;data
suffix:semicolon
r_if
c_cond
(paren
id|sk
op_eq
l_int|NULL
)paren
(brace
id|printk
(paren
l_string|&quot;Warning: sock-&gt;data = NULL: %d&bslash;n&quot;
comma
id|__LINE__
)paren
suffix:semicolon
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|sk-&gt;shutdown
op_amp
id|SEND_SHUTDOWN
)paren
r_return
(paren
op_minus
id|EIO
)paren
suffix:semicolon
multiline_comment|/* we may need to bind the socket. */
r_if
c_cond
(paren
id|sk-&gt;num
op_eq
l_int|0
)paren
(brace
id|sk-&gt;num
op_assign
id|get_new_socknum
(paren
id|sk-&gt;prot
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sk-&gt;num
op_eq
l_int|0
)paren
r_return
(paren
op_minus
id|EAGAIN
)paren
suffix:semicolon
id|put_sock
(paren
id|sk-&gt;num
comma
id|sk
)paren
suffix:semicolon
id|sk-&gt;dummy_th.source
op_assign
id|net16
c_func
(paren
id|sk-&gt;num
)paren
suffix:semicolon
)brace
r_return
(paren
id|sk-&gt;prot-&gt;write
(paren
id|sk
comma
id|ubuf
comma
id|size
comma
id|noblock
comma
id|flags
)paren
)paren
suffix:semicolon
)brace
r_static
r_int
DECL|function|ip_proto_sendto
id|ip_proto_sendto
(paren
r_struct
id|socket
op_star
id|sock
comma
r_void
op_star
id|ubuf
comma
r_int
id|size
comma
r_int
id|noblock
comma
r_int
id|flags
comma
r_struct
id|sockaddr
op_star
id|sin
comma
r_int
id|addr_len
)paren
(brace
r_volatile
r_struct
id|sock
op_star
id|sk
suffix:semicolon
id|sk
op_assign
id|sock-&gt;data
suffix:semicolon
r_if
c_cond
(paren
id|sk
op_eq
l_int|NULL
)paren
(brace
id|printk
(paren
l_string|&quot;Warning: sock-&gt;data = NULL: %d&bslash;n&quot;
comma
id|__LINE__
)paren
suffix:semicolon
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|sk-&gt;shutdown
op_amp
id|SEND_SHUTDOWN
)paren
r_return
(paren
op_minus
id|EIO
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sk-&gt;prot-&gt;sendto
op_eq
l_int|NULL
)paren
r_return
(paren
op_minus
id|EOPNOTSUPP
)paren
suffix:semicolon
multiline_comment|/* we may need to bind the socket. */
r_if
c_cond
(paren
id|sk-&gt;num
op_eq
l_int|0
)paren
(brace
id|sk-&gt;num
op_assign
id|get_new_socknum
(paren
id|sk-&gt;prot
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sk-&gt;num
op_eq
l_int|0
)paren
r_return
(paren
op_minus
id|EAGAIN
)paren
suffix:semicolon
id|put_sock
(paren
id|sk-&gt;num
comma
id|sk
)paren
suffix:semicolon
id|sk-&gt;dummy_th.source
op_assign
id|net16
c_func
(paren
id|sk-&gt;num
)paren
suffix:semicolon
)brace
r_return
(paren
id|sk-&gt;prot-&gt;sendto
(paren
id|sk
comma
id|ubuf
comma
id|size
comma
id|noblock
comma
id|flags
comma
(paren
r_struct
id|sockaddr_in
op_star
)paren
id|sin
comma
id|addr_len
)paren
)paren
suffix:semicolon
)brace
r_static
r_int
DECL|function|ip_proto_recvfrom
id|ip_proto_recvfrom
(paren
r_struct
id|socket
op_star
id|sock
comma
r_void
op_star
id|ubuf
comma
r_int
id|size
comma
r_int
id|noblock
comma
r_int
id|flags
comma
r_struct
id|sockaddr
op_star
id|sin
comma
r_int
op_star
id|addr_len
)paren
(brace
r_volatile
r_struct
id|sock
op_star
id|sk
suffix:semicolon
id|sk
op_assign
id|sock-&gt;data
suffix:semicolon
r_if
c_cond
(paren
id|sk
op_eq
l_int|NULL
)paren
(brace
id|printk
(paren
l_string|&quot;Warning: sock-&gt;data = NULL: %d&bslash;n&quot;
comma
id|__LINE__
)paren
suffix:semicolon
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|sk-&gt;shutdown
op_amp
id|RCV_SHUTDOWN
)paren
r_return
(paren
op_minus
id|EIO
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sk-&gt;prot-&gt;recvfrom
op_eq
l_int|NULL
)paren
r_return
(paren
op_minus
id|EOPNOTSUPP
)paren
suffix:semicolon
multiline_comment|/* we may need to bind the socket. */
r_if
c_cond
(paren
id|sk-&gt;num
op_eq
l_int|0
)paren
(brace
id|sk-&gt;num
op_assign
id|get_new_socknum
(paren
id|sk-&gt;prot
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sk-&gt;num
op_eq
l_int|0
)paren
r_return
(paren
op_minus
id|EAGAIN
)paren
suffix:semicolon
id|put_sock
(paren
id|sk-&gt;num
comma
id|sk
)paren
suffix:semicolon
id|sk-&gt;dummy_th.source
op_assign
id|net16
c_func
(paren
id|sk-&gt;num
)paren
suffix:semicolon
)brace
r_return
(paren
id|sk-&gt;prot-&gt;recvfrom
(paren
id|sk
comma
id|ubuf
comma
id|size
comma
id|noblock
comma
id|flags
comma
(paren
r_struct
id|sockaddr_in
op_star
)paren
id|sin
comma
id|addr_len
)paren
)paren
suffix:semicolon
)brace
r_static
r_int
DECL|function|ip_proto_shutdown
id|ip_proto_shutdown
(paren
r_struct
id|socket
op_star
id|sock
comma
r_int
id|how
)paren
(brace
r_volatile
r_struct
id|sock
op_star
id|sk
suffix:semicolon
multiline_comment|/* this should really check to make sure the socket is&n;&t;   a tcp socket. */
id|how
op_increment
suffix:semicolon
multiline_comment|/* maps 0-&gt;1 has the advantage of making bit 1 rcvs and&n;&t;&t;       1-&gt;2 bit 2 snds.&n;&t;&t;       2-&gt;3 */
r_if
c_cond
(paren
id|how
op_amp
op_complement
id|SHUTDOWN_MASK
)paren
r_return
(paren
op_minus
id|EINVAL
)paren
suffix:semicolon
id|sk
op_assign
id|sock-&gt;data
suffix:semicolon
r_if
c_cond
(paren
id|sk
op_eq
l_int|NULL
)paren
(brace
id|printk
(paren
l_string|&quot;Warning: sock-&gt;data = NULL: %d&bslash;n&quot;
comma
id|__LINE__
)paren
suffix:semicolon
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|sk-&gt;state
op_ne
id|TCP_ESTABLISHED
)paren
r_return
(paren
op_minus
id|ENOTCONN
)paren
suffix:semicolon
id|sk-&gt;shutdown
op_or_assign
id|how
suffix:semicolon
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
r_static
r_int
DECL|function|ip_proto_select
id|ip_proto_select
(paren
r_struct
id|socket
op_star
id|sock
comma
r_int
id|sel_type
comma
id|select_table
op_star
id|wait
)paren
(brace
r_volatile
r_struct
id|sock
op_star
id|sk
suffix:semicolon
id|sk
op_assign
id|sock-&gt;data
suffix:semicolon
r_if
c_cond
(paren
id|sk
op_eq
l_int|NULL
)paren
(brace
id|printk
(paren
l_string|&quot;Warning: sock-&gt;data = NULL: %d&bslash;n&quot;
comma
id|__LINE__
)paren
suffix:semicolon
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|sk-&gt;prot-&gt;select
op_eq
l_int|NULL
)paren
(brace
id|PRINTK
(paren
l_string|&quot;select on non-selectable socket. &bslash;n&quot;
)paren
suffix:semicolon
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
r_return
(paren
id|sk-&gt;prot
op_member_access_from_pointer
id|select
c_func
(paren
id|sk
comma
id|sel_type
comma
id|wait
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/* these should be distributed to the different protocol routines. */
r_static
r_int
DECL|function|ip_proto_ioctl
id|ip_proto_ioctl
(paren
r_struct
id|socket
op_star
id|sock
comma
r_int
r_int
id|cmd
comma
r_int
r_int
id|arg
)paren
(brace
r_volatile
r_struct
id|sock
op_star
id|sk
suffix:semicolon
id|sk
op_assign
id|sock-&gt;data
suffix:semicolon
r_if
c_cond
(paren
id|sk
op_eq
l_int|NULL
)paren
(brace
id|printk
(paren
l_string|&quot;Warning: sock-&gt;data = NULL: %d&bslash;n&quot;
comma
id|__LINE__
)paren
suffix:semicolon
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
id|PRINTK
(paren
l_string|&quot;in ip_proto_ioctl&bslash;n&quot;
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|cmd
)paren
(brace
r_case
id|IP_SET_DEV
suffix:colon
r_if
c_cond
(paren
op_logical_neg
id|suser
c_func
(paren
)paren
)paren
r_return
(paren
op_minus
id|EPERM
)paren
suffix:semicolon
r_return
(paren
id|ip_set_dev
c_func
(paren
(paren
r_struct
id|ip_config
op_star
)paren
id|arg
)paren
)paren
suffix:semicolon
r_case
id|FIOSETOWN
suffix:colon
r_case
id|SIOCSPGRP
suffix:colon
(brace
r_int
id|user
suffix:semicolon
id|user
op_assign
id|get_fs_long
(paren
(paren
r_void
op_star
)paren
id|arg
)paren
suffix:semicolon
id|sk-&gt;proc
op_assign
id|user
suffix:semicolon
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
r_case
id|FIOGETOWN
suffix:colon
r_case
id|SIOCGPGRP
suffix:colon
(brace
id|verify_area
(paren
(paren
r_void
op_star
)paren
id|arg
comma
r_sizeof
(paren
r_int
)paren
)paren
suffix:semicolon
id|put_fs_long
(paren
id|sk-&gt;proc
comma
(paren
r_void
op_star
)paren
id|arg
)paren
suffix:semicolon
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
r_default
suffix:colon
(brace
)brace
r_if
c_cond
(paren
op_logical_neg
id|sk-&gt;prot-&gt;ioctl
)paren
r_return
(paren
op_minus
id|EINVAL
)paren
suffix:semicolon
r_return
(paren
id|sk-&gt;prot-&gt;ioctl
(paren
id|sk
comma
id|cmd
comma
id|arg
)paren
)paren
suffix:semicolon
)brace
)brace
r_void
op_star
DECL|function|sock_wmalloc
id|sock_wmalloc
c_func
(paren
r_volatile
r_struct
id|sock
op_star
id|sk
comma
r_int
r_int
id|size
comma
r_int
id|force
comma
r_int
id|priority
)paren
(brace
r_if
c_cond
(paren
id|sk
)paren
(brace
r_if
c_cond
(paren
id|sk-&gt;wmem_alloc
op_plus
id|size
OL
id|SK_WMEM_MAX
op_logical_or
id|force
)paren
(brace
id|cli
c_func
(paren
)paren
suffix:semicolon
id|sk-&gt;wmem_alloc
op_add_assign
id|size
suffix:semicolon
id|sti
c_func
(paren
)paren
suffix:semicolon
r_return
(paren
id|kmalloc
(paren
id|size
comma
id|priority
)paren
)paren
suffix:semicolon
)brace
id|MPRINTK
(paren
l_string|&quot;sock_wmalloc(%X,%d,%d,%d) returning NULL&bslash;n&quot;
comma
id|sk
comma
id|size
comma
id|force
comma
id|priority
)paren
suffix:semicolon
r_return
(paren
l_int|NULL
)paren
suffix:semicolon
)brace
r_return
(paren
id|kmalloc
c_func
(paren
id|size
comma
id|priority
)paren
)paren
suffix:semicolon
)brace
r_void
op_star
DECL|function|sock_rmalloc
id|sock_rmalloc
c_func
(paren
r_volatile
r_struct
id|sock
op_star
id|sk
comma
r_int
r_int
id|size
comma
r_int
id|force
comma
r_int
id|priority
)paren
(brace
r_if
c_cond
(paren
id|sk
)paren
(brace
r_if
c_cond
(paren
id|sk-&gt;rmem_alloc
op_plus
id|size
OL
id|SK_RMEM_MAX
op_logical_or
id|force
)paren
(brace
id|cli
c_func
(paren
)paren
suffix:semicolon
id|sk-&gt;rmem_alloc
op_add_assign
id|size
suffix:semicolon
id|sti
c_func
(paren
)paren
suffix:semicolon
r_return
(paren
id|kmalloc
(paren
id|size
comma
id|priority
)paren
)paren
suffix:semicolon
)brace
id|MPRINTK
(paren
l_string|&quot;sock_rmalloc(%X,%d,%d,%d) returning NULL&bslash;n&quot;
comma
id|sk
comma
id|size
comma
id|force
comma
id|priority
)paren
suffix:semicolon
r_return
(paren
l_int|NULL
)paren
suffix:semicolon
)brace
r_return
(paren
id|kmalloc
(paren
id|size
comma
id|priority
)paren
)paren
suffix:semicolon
)brace
r_int
r_int
DECL|function|sock_rspace
id|sock_rspace
(paren
r_volatile
r_struct
id|sock
op_star
id|sk
)paren
(brace
r_int
id|amt
suffix:semicolon
r_if
c_cond
(paren
id|sk
op_ne
l_int|NULL
)paren
(brace
r_if
c_cond
(paren
id|sk-&gt;rmem_alloc
op_ge
id|SK_RMEM_MAX
op_minus
l_int|2
op_star
id|MIN_WINDOW
)paren
r_return
(paren
l_int|0
)paren
suffix:semicolon
id|amt
op_assign
id|min
(paren
(paren
id|SK_RMEM_MAX
op_minus
id|sk-&gt;rmem_alloc
)paren
op_div
l_int|2
op_minus
id|MIN_WINDOW
comma
id|MAX_WINDOW
)paren
suffix:semicolon
r_if
c_cond
(paren
id|amt
OL
l_int|0
)paren
r_return
(paren
l_int|0
)paren
suffix:semicolon
r_return
(paren
id|amt
)paren
suffix:semicolon
)brace
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
r_int
r_int
DECL|function|sock_wspace
id|sock_wspace
(paren
r_volatile
r_struct
id|sock
op_star
id|sk
)paren
(brace
r_if
c_cond
(paren
id|sk
op_ne
l_int|NULL
)paren
(brace
r_if
c_cond
(paren
id|sk-&gt;shutdown
op_amp
id|SEND_SHUTDOWN
)paren
r_return
(paren
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sk-&gt;wmem_alloc
op_ge
id|SK_WMEM_MAX
)paren
r_return
(paren
l_int|0
)paren
suffix:semicolon
r_return
(paren
id|SK_WMEM_MAX
op_minus
id|sk-&gt;wmem_alloc
)paren
suffix:semicolon
)brace
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
r_void
DECL|function|sock_wfree
id|sock_wfree
(paren
r_volatile
r_struct
id|sock
op_star
id|sk
comma
r_void
op_star
id|mem
comma
r_int
r_int
id|size
)paren
(brace
id|MPRINTK
(paren
l_string|&quot;sock_wfree (sk=%X, mem=%X, size=%d)&bslash;n&quot;
comma
id|sk
comma
id|mem
comma
id|size
)paren
suffix:semicolon
id|kfree_s
(paren
id|mem
comma
id|size
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sk
)paren
(brace
id|sk-&gt;wmem_alloc
op_sub_assign
id|size
suffix:semicolon
multiline_comment|/* in case it might be waiting for more memory. */
r_if
c_cond
(paren
op_logical_neg
id|sk-&gt;dead
op_logical_and
id|sk-&gt;wmem_alloc
OG
id|SK_WMEM_MAX
op_div
l_int|2
)paren
id|wake_up
c_func
(paren
id|sk-&gt;sleep
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sk-&gt;destroy
op_logical_and
id|sk-&gt;wmem_alloc
op_eq
l_int|0
op_logical_and
id|sk-&gt;rmem_alloc
op_eq
l_int|0
)paren
(brace
id|MPRINTK
(paren
l_string|&quot;recovered lost memory, destroying sock = %X&bslash;n&quot;
comma
id|sk
)paren
suffix:semicolon
id|delete_timer
(paren
(paren
r_struct
id|timer
op_star
)paren
op_amp
id|sk-&gt;time_wait
)paren
suffix:semicolon
id|kfree_s
(paren
(paren
r_void
op_star
)paren
id|sk
comma
r_sizeof
(paren
op_star
id|sk
)paren
)paren
suffix:semicolon
)brace
r_return
suffix:semicolon
)brace
)brace
r_void
DECL|function|sock_rfree
id|sock_rfree
(paren
r_volatile
r_struct
id|sock
op_star
id|sk
comma
r_void
op_star
id|mem
comma
r_int
r_int
id|size
)paren
(brace
id|MPRINTK
(paren
l_string|&quot;sock_rfree (sk=%X, mem=%X, size=%d)&bslash;n&quot;
comma
id|sk
comma
id|mem
comma
id|size
)paren
suffix:semicolon
id|kfree_s
(paren
id|mem
comma
id|size
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sk
)paren
(brace
id|sk-&gt;rmem_alloc
op_sub_assign
id|size
suffix:semicolon
r_if
c_cond
(paren
id|sk-&gt;destroy
op_logical_and
id|sk-&gt;wmem_alloc
op_eq
l_int|0
op_logical_and
id|sk-&gt;rmem_alloc
op_eq
l_int|0
)paren
(brace
id|delete_timer
(paren
(paren
r_struct
id|timer
op_star
)paren
op_amp
id|sk-&gt;time_wait
)paren
suffix:semicolon
id|kfree_s
(paren
(paren
r_void
op_star
)paren
id|sk
comma
r_sizeof
(paren
op_star
id|sk
)paren
)paren
suffix:semicolon
)brace
)brace
)brace
multiline_comment|/* This routine must find a socket given a tcp header.  Everyhting&n;   is assumed to be in net order. */
DECL|function|get_sock
r_volatile
r_struct
id|sock
op_star
id|get_sock
(paren
r_struct
id|proto
op_star
id|prot
comma
r_int
r_int
id|num
comma
r_int
r_int
id|raddr
comma
r_int
r_int
id|rnum
comma
r_int
r_int
id|laddr
)paren
(brace
r_volatile
r_struct
id|sock
op_star
id|s
suffix:semicolon
id|PRINTK
(paren
l_string|&quot;get_sock (prot=%X, num=%d, raddr=%X, rnum=%d, laddr=%X)&bslash;n&quot;
comma
id|prot
comma
id|num
comma
id|raddr
comma
id|rnum
comma
id|laddr
)paren
suffix:semicolon
multiline_comment|/* SOCK_ARRAY_SIZE must be a power of two.  This will work better&n;     than a prime unless 3 or more sockets end up using the same&n;     array entry.  This should not be a problem because most&n;     well known sockets don&squot;t overlap that much, and for&n;     the other ones, we can just be careful about picking our&n;     socket number when we choose an arbitrary one. */
r_for
c_loop
(paren
id|s
op_assign
id|prot-&gt;sock_array
(braket
id|num
op_amp
(paren
id|SOCK_ARRAY_SIZE
op_minus
l_int|1
)paren
)braket
suffix:semicolon
id|s
op_ne
l_int|NULL
suffix:semicolon
id|s
op_assign
id|s-&gt;next
)paren
(brace
r_if
c_cond
(paren
id|s-&gt;num
op_eq
id|num
)paren
(brace
multiline_comment|/* we need to see if this is the socket that we want. */
r_if
c_cond
(paren
op_logical_neg
id|ip_addr_match
(paren
id|s-&gt;daddr
comma
id|raddr
)paren
)paren
r_continue
suffix:semicolon
r_if
c_cond
(paren
id|s-&gt;dummy_th.dest
op_ne
id|rnum
op_logical_and
id|s-&gt;dummy_th.dest
op_ne
l_int|0
)paren
r_continue
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ip_addr_match
(paren
id|s-&gt;saddr
comma
id|laddr
)paren
)paren
r_continue
suffix:semicolon
r_return
(paren
id|s
)paren
suffix:semicolon
)brace
)brace
r_return
(paren
l_int|NULL
)paren
suffix:semicolon
)brace
DECL|function|release_sock
r_void
id|release_sock
(paren
r_volatile
r_struct
id|sock
op_star
id|sk
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|sk
)paren
(brace
id|printk
(paren
l_string|&quot;sock.c: release_sock sk == NULL&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|sk-&gt;prot
)paren
(brace
id|printk
(paren
l_string|&quot;sock.c: release_sock sk-&gt;prot == NULL&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|sk-&gt;blog
)paren
r_return
suffix:semicolon
multiline_comment|/* see if we have any packets built up. */
id|cli
c_func
(paren
)paren
suffix:semicolon
id|sk-&gt;inuse
op_assign
l_int|1
suffix:semicolon
r_while
c_loop
(paren
id|sk-&gt;back_log
op_ne
l_int|NULL
)paren
(brace
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
id|sk-&gt;blog
op_assign
l_int|1
suffix:semicolon
id|skb
op_assign
id|sk-&gt;back_log
suffix:semicolon
id|PRINTK
(paren
l_string|&quot;release_sock: skb = %X:&bslash;n&quot;
comma
id|skb
)paren
suffix:semicolon
id|print_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
r_if
c_cond
(paren
id|skb-&gt;next
op_ne
id|skb
)paren
(brace
id|sk-&gt;back_log
op_assign
id|skb-&gt;next
suffix:semicolon
id|skb-&gt;prev-&gt;next
op_assign
id|skb-&gt;next
suffix:semicolon
id|skb-&gt;next-&gt;prev
op_assign
id|skb-&gt;prev
suffix:semicolon
)brace
r_else
(brace
id|sk-&gt;back_log
op_assign
l_int|NULL
suffix:semicolon
)brace
id|sti
c_func
(paren
)paren
suffix:semicolon
id|PRINTK
(paren
l_string|&quot;sk-&gt;back_log = %X&bslash;n&quot;
comma
id|sk-&gt;back_log
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sk-&gt;prot-&gt;rcv
)paren
id|sk-&gt;prot
op_member_access_from_pointer
id|rcv
c_func
(paren
id|skb
comma
id|skb-&gt;dev
comma
id|sk-&gt;opt
comma
id|skb-&gt;saddr
comma
id|skb-&gt;len
comma
id|skb-&gt;daddr
comma
l_int|1
comma
multiline_comment|/* only used for/by raw sockets. */
(paren
r_struct
id|ip_protocol
op_star
)paren
id|sk-&gt;pair
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
)brace
id|sk-&gt;blog
op_assign
l_int|0
suffix:semicolon
id|sk-&gt;inuse
op_assign
l_int|0
suffix:semicolon
id|sti
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sk-&gt;dead
op_logical_and
id|sk-&gt;state
op_eq
id|TCP_CLOSE
)paren
(brace
multiline_comment|/* should be about 2 rtt&squot;s */
id|sk-&gt;time_wait.len
op_assign
id|min
(paren
id|sk-&gt;rtt
op_star
l_int|2
comma
id|TCP_DONE_TIME
)paren
suffix:semicolon
id|sk-&gt;timeout
op_assign
id|TIME_DONE
suffix:semicolon
id|reset_timer
(paren
(paren
r_struct
id|timer
op_star
)paren
op_amp
id|sk-&gt;time_wait
)paren
suffix:semicolon
)brace
)brace
eof
