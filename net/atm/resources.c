multiline_comment|/* net/atm/resources.c - Staticly allocated resources */
multiline_comment|/* Written 1995-2000 by Werner Almesberger, EPFL LRC/ICA */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/ctype.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/atmdev.h&gt;
macro_line|#include &lt;linux/kernel.h&gt; /* for barrier */
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/bitops.h&gt;
macro_line|#include &lt;net/sock.h&gt;&t; /* for struct sock */
macro_line|#include &lt;asm/segment.h&gt; /* for get_fs_long and put_fs_long */
macro_line|#include &quot;common.h&quot;
macro_line|#include &quot;resources.h&quot;
macro_line|#ifndef NULL
DECL|macro|NULL
mdefine_line|#define NULL 0
macro_line|#endif
DECL|variable|atm_devs
r_struct
id|atm_dev
op_star
id|atm_devs
op_assign
l_int|NULL
suffix:semicolon
DECL|variable|last_dev
r_static
r_struct
id|atm_dev
op_star
id|last_dev
op_assign
l_int|NULL
suffix:semicolon
DECL|variable|nodev_vccs
r_struct
id|atm_vcc
op_star
id|nodev_vccs
op_assign
l_int|NULL
suffix:semicolon
r_extern
id|spinlock_t
id|atm_dev_lock
suffix:semicolon
DECL|function|alloc_atm_dev
r_static
r_struct
id|atm_dev
op_star
id|alloc_atm_dev
c_func
(paren
r_const
r_char
op_star
id|type
)paren
(brace
r_struct
id|atm_dev
op_star
id|dev
suffix:semicolon
id|dev
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
op_star
id|dev
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dev
)paren
r_return
l_int|NULL
suffix:semicolon
id|memset
c_func
(paren
id|dev
comma
l_int|0
comma
r_sizeof
(paren
op_star
id|dev
)paren
)paren
suffix:semicolon
id|dev-&gt;type
op_assign
id|type
suffix:semicolon
id|dev-&gt;prev
op_assign
id|last_dev
suffix:semicolon
id|dev-&gt;signal
op_assign
id|ATM_PHY_SIG_UNKNOWN
suffix:semicolon
id|dev-&gt;link_rate
op_assign
id|ATM_OC3_PCR
suffix:semicolon
id|dev-&gt;next
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
id|atm_devs
)paren
id|last_dev-&gt;next
op_assign
id|dev
suffix:semicolon
r_else
id|atm_devs
op_assign
id|dev
suffix:semicolon
id|last_dev
op_assign
id|dev
suffix:semicolon
r_return
id|dev
suffix:semicolon
)brace
DECL|function|free_atm_dev
r_static
r_void
id|free_atm_dev
c_func
(paren
r_struct
id|atm_dev
op_star
id|dev
)paren
(brace
id|spin_lock
(paren
op_amp
id|atm_dev_lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;prev
)paren
id|dev-&gt;prev-&gt;next
op_assign
id|dev-&gt;next
suffix:semicolon
r_else
id|atm_devs
op_assign
id|dev-&gt;next
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;next
)paren
id|dev-&gt;next-&gt;prev
op_assign
id|dev-&gt;prev
suffix:semicolon
r_else
id|last_dev
op_assign
id|dev-&gt;prev
suffix:semicolon
id|kfree
c_func
(paren
id|dev
)paren
suffix:semicolon
id|spin_unlock
(paren
op_amp
id|atm_dev_lock
)paren
suffix:semicolon
)brace
DECL|function|atm_find_dev
r_struct
id|atm_dev
op_star
id|atm_find_dev
c_func
(paren
r_int
id|number
)paren
(brace
r_struct
id|atm_dev
op_star
id|dev
suffix:semicolon
r_for
c_loop
(paren
id|dev
op_assign
id|atm_devs
suffix:semicolon
id|dev
suffix:semicolon
id|dev
op_assign
id|dev-&gt;next
)paren
r_if
c_cond
(paren
id|dev-&gt;ops
op_logical_and
id|dev-&gt;number
op_eq
id|number
)paren
r_return
id|dev
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
DECL|function|atm_dev_register
r_struct
id|atm_dev
op_star
id|atm_dev_register
c_func
(paren
r_const
r_char
op_star
id|type
comma
r_const
r_struct
id|atmdev_ops
op_star
id|ops
comma
r_int
id|number
comma
id|atm_dev_flags_t
op_star
id|flags
)paren
(brace
r_struct
id|atm_dev
op_star
id|dev
suffix:semicolon
id|dev
op_assign
id|alloc_atm_dev
c_func
(paren
id|type
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dev
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;atm_dev_register: no space for dev %s&bslash;n&quot;
comma
id|type
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|number
op_ne
op_minus
l_int|1
)paren
(brace
r_if
c_cond
(paren
id|atm_find_dev
c_func
(paren
id|number
)paren
)paren
(brace
id|free_atm_dev
c_func
(paren
id|dev
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
id|dev-&gt;number
op_assign
id|number
suffix:semicolon
)brace
r_else
(brace
id|dev-&gt;number
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
id|atm_find_dev
c_func
(paren
id|dev-&gt;number
)paren
)paren
id|dev-&gt;number
op_increment
suffix:semicolon
)brace
id|dev-&gt;vccs
op_assign
id|dev-&gt;last
op_assign
l_int|NULL
suffix:semicolon
id|dev-&gt;dev_data
op_assign
l_int|NULL
suffix:semicolon
id|barrier
c_func
(paren
)paren
suffix:semicolon
id|dev-&gt;ops
op_assign
id|ops
suffix:semicolon
r_if
c_cond
(paren
id|flags
)paren
id|dev-&gt;flags
op_assign
op_star
id|flags
suffix:semicolon
r_else
id|memset
c_func
(paren
op_amp
id|dev-&gt;flags
comma
l_int|0
comma
r_sizeof
(paren
id|dev-&gt;flags
)paren
)paren
suffix:semicolon
id|memset
c_func
(paren
(paren
r_void
op_star
)paren
op_amp
id|dev-&gt;stats
comma
l_int|0
comma
r_sizeof
(paren
id|dev-&gt;stats
)paren
)paren
suffix:semicolon
macro_line|#ifdef CONFIG_PROC_FS
r_if
c_cond
(paren
id|ops-&gt;proc_read
)paren
r_if
c_cond
(paren
id|atm_proc_dev_register
c_func
(paren
id|dev
)paren
OL
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;atm_dev_register: &quot;
l_string|&quot;atm_proc_dev_register failed for dev %s&bslash;n&quot;
comma
id|type
)paren
suffix:semicolon
id|spin_unlock
(paren
op_amp
id|atm_dev_lock
)paren
suffix:semicolon
id|free_atm_dev
c_func
(paren
id|dev
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
macro_line|#endif
id|spin_unlock
(paren
op_amp
id|atm_dev_lock
)paren
suffix:semicolon
r_return
id|dev
suffix:semicolon
)brace
DECL|function|atm_dev_deregister
r_void
id|atm_dev_deregister
c_func
(paren
r_struct
id|atm_dev
op_star
id|dev
)paren
(brace
macro_line|#ifdef CONFIG_PROC_FS
r_if
c_cond
(paren
id|dev-&gt;ops-&gt;proc_read
)paren
id|atm_proc_dev_deregister
c_func
(paren
id|dev
)paren
suffix:semicolon
macro_line|#endif
id|free_atm_dev
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
DECL|function|shutdown_atm_dev
r_void
id|shutdown_atm_dev
c_func
(paren
r_struct
id|atm_dev
op_star
id|dev
)paren
(brace
r_if
c_cond
(paren
id|dev-&gt;vccs
)paren
(brace
id|set_bit
c_func
(paren
id|ATM_DF_CLOSE
comma
op_amp
id|dev-&gt;flags
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|dev-&gt;ops-&gt;dev_close
)paren
id|dev-&gt;ops
op_member_access_from_pointer
id|dev_close
c_func
(paren
id|dev
)paren
suffix:semicolon
id|atm_dev_deregister
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
multiline_comment|/* Handler for sk-&gt;destruct, invoked by sk_free() */
DECL|function|atm_free_sock
r_static
r_void
id|atm_free_sock
c_func
(paren
r_struct
id|sock
op_star
id|sk
)paren
(brace
id|kfree
c_func
(paren
id|sk-&gt;protinfo.af_atm
)paren
suffix:semicolon
)brace
DECL|function|alloc_atm_vcc_sk
r_struct
id|sock
op_star
id|alloc_atm_vcc_sk
c_func
(paren
r_int
id|family
)paren
(brace
r_struct
id|sock
op_star
id|sk
suffix:semicolon
r_struct
id|atm_vcc
op_star
id|vcc
suffix:semicolon
id|sk
op_assign
id|sk_alloc
c_func
(paren
id|family
comma
id|GFP_KERNEL
comma
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|sk
)paren
r_return
l_int|NULL
suffix:semicolon
id|vcc
op_assign
id|sk-&gt;protinfo.af_atm
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
op_star
id|vcc
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|vcc
)paren
(brace
id|sk_free
c_func
(paren
id|sk
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
id|sock_init_data
c_func
(paren
l_int|NULL
comma
id|sk
)paren
suffix:semicolon
id|sk-&gt;destruct
op_assign
id|atm_free_sock
suffix:semicolon
id|memset
c_func
(paren
id|vcc
comma
l_int|0
comma
r_sizeof
(paren
op_star
id|vcc
)paren
)paren
suffix:semicolon
id|vcc-&gt;sk
op_assign
id|sk
suffix:semicolon
r_if
c_cond
(paren
id|nodev_vccs
)paren
id|nodev_vccs-&gt;prev
op_assign
id|vcc
suffix:semicolon
id|vcc-&gt;prev
op_assign
l_int|NULL
suffix:semicolon
id|vcc-&gt;next
op_assign
id|nodev_vccs
suffix:semicolon
id|nodev_vccs
op_assign
id|vcc
suffix:semicolon
r_return
id|sk
suffix:semicolon
)brace
DECL|function|unlink_vcc
r_static
r_void
id|unlink_vcc
c_func
(paren
r_struct
id|atm_vcc
op_star
id|vcc
comma
r_struct
id|atm_dev
op_star
id|hold_dev
)paren
(brace
r_if
c_cond
(paren
id|vcc-&gt;prev
)paren
id|vcc-&gt;prev-&gt;next
op_assign
id|vcc-&gt;next
suffix:semicolon
r_else
r_if
c_cond
(paren
id|vcc-&gt;dev
)paren
id|vcc-&gt;dev-&gt;vccs
op_assign
id|vcc-&gt;next
suffix:semicolon
r_else
id|nodev_vccs
op_assign
id|vcc-&gt;next
suffix:semicolon
r_if
c_cond
(paren
id|vcc-&gt;next
)paren
id|vcc-&gt;next-&gt;prev
op_assign
id|vcc-&gt;prev
suffix:semicolon
r_else
r_if
c_cond
(paren
id|vcc-&gt;dev
)paren
id|vcc-&gt;dev-&gt;last
op_assign
id|vcc-&gt;prev
suffix:semicolon
r_if
c_cond
(paren
id|vcc-&gt;dev
op_logical_and
id|vcc-&gt;dev
op_ne
id|hold_dev
op_logical_and
op_logical_neg
id|vcc-&gt;dev-&gt;vccs
op_logical_and
id|test_bit
c_func
(paren
id|ATM_DF_CLOSE
comma
op_amp
id|vcc-&gt;dev-&gt;flags
)paren
)paren
id|shutdown_atm_dev
c_func
(paren
id|vcc-&gt;dev
)paren
suffix:semicolon
)brace
DECL|function|free_atm_vcc_sk
r_void
id|free_atm_vcc_sk
c_func
(paren
r_struct
id|sock
op_star
id|sk
)paren
(brace
id|unlink_vcc
c_func
(paren
id|sk-&gt;protinfo.af_atm
comma
l_int|NULL
)paren
suffix:semicolon
id|sk_free
c_func
(paren
id|sk
)paren
suffix:semicolon
)brace
DECL|function|bind_vcc
r_void
id|bind_vcc
c_func
(paren
r_struct
id|atm_vcc
op_star
id|vcc
comma
r_struct
id|atm_dev
op_star
id|dev
)paren
(brace
id|unlink_vcc
c_func
(paren
id|vcc
comma
id|dev
)paren
suffix:semicolon
id|vcc-&gt;dev
op_assign
id|dev
suffix:semicolon
r_if
c_cond
(paren
id|dev
)paren
(brace
id|vcc-&gt;next
op_assign
l_int|NULL
suffix:semicolon
id|vcc-&gt;prev
op_assign
id|dev-&gt;last
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;vccs
)paren
id|dev-&gt;last-&gt;next
op_assign
id|vcc
suffix:semicolon
r_else
id|dev-&gt;vccs
op_assign
id|vcc
suffix:semicolon
id|dev-&gt;last
op_assign
id|vcc
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|nodev_vccs
)paren
id|nodev_vccs-&gt;prev
op_assign
id|vcc
suffix:semicolon
id|vcc-&gt;next
op_assign
id|nodev_vccs
suffix:semicolon
id|vcc-&gt;prev
op_assign
l_int|NULL
suffix:semicolon
id|nodev_vccs
op_assign
id|vcc
suffix:semicolon
)brace
)brace
DECL|variable|atm_dev_register
id|EXPORT_SYMBOL
c_func
(paren
id|atm_dev_register
)paren
suffix:semicolon
DECL|variable|atm_dev_deregister
id|EXPORT_SYMBOL
c_func
(paren
id|atm_dev_deregister
)paren
suffix:semicolon
DECL|variable|atm_find_dev
id|EXPORT_SYMBOL
c_func
(paren
id|atm_find_dev
)paren
suffix:semicolon
DECL|variable|shutdown_atm_dev
id|EXPORT_SYMBOL
c_func
(paren
id|shutdown_atm_dev
)paren
suffix:semicolon
DECL|variable|bind_vcc
id|EXPORT_SYMBOL
c_func
(paren
id|bind_vcc
)paren
suffix:semicolon
eof
