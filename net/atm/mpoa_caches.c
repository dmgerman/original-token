macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/atmmpc.h&gt;
macro_line|#include &lt;linux/time.h&gt;
macro_line|#include &quot;mpoa_caches.h&quot;
macro_line|#include &quot;mpc.h&quot;
multiline_comment|/*&n; * mpoa_caches.c: Implementation of ingress and egress cache&n; * handling functions&n; */
macro_line|#if 0
mdefine_line|#define dprintk printk    /* debug */
macro_line|#else
DECL|macro|dprintk
mdefine_line|#define dprintk(format,args...)
macro_line|#endif
macro_line|#if 0
mdefine_line|#define ddprintk printk  /* more debug */
macro_line|#else
DECL|macro|ddprintk
mdefine_line|#define ddprintk(format,args...)
macro_line|#endif
DECL|function|in_cache_search
r_static
id|in_cache_entry
op_star
id|in_cache_search
c_func
(paren
r_uint32
id|dst_ip
comma
r_struct
id|mpoa_client
op_star
id|client
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
id|in_cache_entry
op_star
id|entry
suffix:semicolon
id|read_lock_irqsave
c_func
(paren
op_amp
id|client-&gt;ingress_lock
comma
id|flags
)paren
suffix:semicolon
id|entry
op_assign
id|client-&gt;in_cache
suffix:semicolon
r_while
c_loop
(paren
id|entry
op_ne
l_int|NULL
)paren
(brace
r_if
c_cond
(paren
id|entry-&gt;ctrl_info.in_dst_ip
op_eq
id|dst_ip
)paren
(brace
id|read_unlock_irqrestore
c_func
(paren
op_amp
id|client-&gt;ingress_lock
comma
id|flags
)paren
suffix:semicolon
r_return
id|entry
suffix:semicolon
)brace
id|entry
op_assign
id|entry-&gt;next
suffix:semicolon
)brace
id|read_unlock_irqrestore
c_func
(paren
op_amp
id|client-&gt;ingress_lock
comma
id|flags
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
DECL|function|in_cache_search_with_mask
r_static
id|in_cache_entry
(def_block
op_star
id|in_cache_search_with_mask
c_func
(paren
r_uint32
id|dst_ip
comma
r_struct
id|mpoa_client
op_star
id|client
comma
r_uint32
id|mask
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
id|in_cache_entry
op_star
id|entry
suffix:semicolon
id|read_lock_irqsave
c_func
(paren
op_amp
id|client-&gt;ingress_lock
comma
id|flags
)paren
suffix:semicolon
id|entry
op_assign
id|client-&gt;in_cache
suffix:semicolon
r_while
c_loop
(paren
id|entry
op_ne
l_int|NULL
)paren
(brace
r_if
c_cond
(paren
(paren
id|entry-&gt;ctrl_info.in_dst_ip
op_amp
id|mask
)paren
op_eq
(paren
id|dst_ip
op_amp
id|mask
)paren
)paren
(brace
id|read_unlock_irqrestore
c_func
(paren
op_amp
id|client-&gt;ingress_lock
comma
id|flags
)paren
suffix:semicolon
r_return
id|entry
suffix:semicolon
)brace
id|entry
op_assign
id|entry-&gt;next
suffix:semicolon
)brace
id|read_unlock_irqrestore
c_func
(paren
op_amp
id|client-&gt;ingress_lock
comma
id|flags
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
)def_block
DECL|function|in_cache_search_by_vcc
r_static
id|in_cache_entry
op_star
id|in_cache_search_by_vcc
c_func
(paren
r_struct
id|atm_vcc
op_star
id|vcc
comma
r_struct
id|mpoa_client
op_star
id|client
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
id|in_cache_entry
op_star
id|entry
suffix:semicolon
id|read_lock_irqsave
c_func
(paren
op_amp
id|client-&gt;ingress_lock
comma
id|flags
)paren
suffix:semicolon
id|entry
op_assign
id|client-&gt;in_cache
suffix:semicolon
r_while
c_loop
(paren
id|entry
op_ne
l_int|NULL
)paren
(brace
r_if
c_cond
(paren
id|entry-&gt;shortcut
op_eq
id|vcc
)paren
(brace
id|read_unlock_irqrestore
c_func
(paren
op_amp
id|client-&gt;ingress_lock
comma
id|flags
)paren
suffix:semicolon
r_return
id|entry
suffix:semicolon
)brace
id|entry
op_assign
id|entry-&gt;next
suffix:semicolon
)brace
id|read_unlock_irqrestore
c_func
(paren
op_amp
id|client-&gt;ingress_lock
comma
id|flags
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
DECL|function|new_in_cache_entry
r_static
id|in_cache_entry
op_star
id|new_in_cache_entry
c_func
(paren
r_uint32
id|dst_ip
comma
r_struct
id|mpoa_client
op_star
id|client
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
r_int
r_char
op_star
id|ip
op_assign
(paren
r_int
r_char
op_star
)paren
op_amp
id|dst_ip
suffix:semicolon
id|in_cache_entry
op_star
id|entry
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
id|in_cache_entry
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|entry
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;mpoa: mpoa_caches.c: new_in_cache_entry: out of memory&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
id|dprintk
c_func
(paren
l_string|&quot;mpoa: mpoa_caches.c: adding an ingress entry, ip = %u.%u.%u.%u&bslash;n&quot;
comma
id|ip
(braket
l_int|0
)braket
comma
id|ip
(braket
l_int|1
)braket
comma
id|ip
(braket
l_int|2
)braket
comma
id|ip
(braket
l_int|3
)braket
)paren
suffix:semicolon
id|memset
c_func
(paren
id|entry
comma
l_int|0
comma
r_sizeof
(paren
id|in_cache_entry
)paren
)paren
suffix:semicolon
id|dprintk
c_func
(paren
l_string|&quot;mpoa: mpoa_caches.c: new_in_cache_entry: about to lock&bslash;n&quot;
)paren
suffix:semicolon
id|write_lock_irqsave
c_func
(paren
op_amp
id|client-&gt;ingress_lock
comma
id|flags
)paren
suffix:semicolon
id|entry-&gt;next
op_assign
id|client-&gt;in_cache
suffix:semicolon
id|entry-&gt;prev
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
id|client-&gt;in_cache
op_ne
l_int|NULL
)paren
id|client-&gt;in_cache-&gt;prev
op_assign
id|entry
suffix:semicolon
id|client-&gt;in_cache
op_assign
id|entry
suffix:semicolon
id|write_unlock_irqrestore
c_func
(paren
op_amp
id|client-&gt;ingress_lock
comma
id|flags
)paren
suffix:semicolon
id|dprintk
c_func
(paren
l_string|&quot;mpoa: mpoa_caches.c: new_in_cache_entry: unlocked&bslash;n&quot;
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|entry-&gt;MPS_ctrl_ATM_addr
comma
id|client-&gt;mps_ctrl_addr
comma
id|ATM_ESA_LEN
)paren
suffix:semicolon
id|entry-&gt;ctrl_info.in_dst_ip
op_assign
id|dst_ip
suffix:semicolon
id|do_gettimeofday
c_func
(paren
op_amp
(paren
id|entry-&gt;tv
)paren
)paren
suffix:semicolon
id|entry-&gt;retry_time
op_assign
id|client-&gt;parameters.mpc_p4
suffix:semicolon
id|entry-&gt;count
op_assign
l_int|1
suffix:semicolon
id|entry-&gt;entry_state
op_assign
id|INGRESS_INVALID
suffix:semicolon
id|entry-&gt;ctrl_info.holding_time
op_assign
id|HOLDING_TIME_DEFAULT
suffix:semicolon
r_return
id|entry
suffix:semicolon
)brace
DECL|function|cache_hit
r_static
r_int
id|cache_hit
c_func
(paren
id|in_cache_entry
op_star
id|entry
comma
r_struct
id|mpoa_client
op_star
id|mpc
)paren
(brace
r_struct
id|atm_mpoa_qos
op_star
id|qos
suffix:semicolon
r_struct
id|k_message
id|msg
suffix:semicolon
id|entry-&gt;count
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|entry-&gt;entry_state
op_eq
id|INGRESS_RESOLVED
op_logical_and
id|entry-&gt;shortcut
op_ne
l_int|NULL
)paren
(brace
r_return
id|OPEN
suffix:semicolon
)brace
r_if
c_cond
(paren
id|entry-&gt;entry_state
op_eq
id|INGRESS_REFRESHING
)paren
(brace
r_if
c_cond
(paren
id|entry-&gt;count
OG
id|mpc-&gt;parameters.mpc_p1
)paren
(brace
id|msg.type
op_assign
id|SND_MPOA_RES_RQST
suffix:semicolon
id|msg.content.in_info
op_assign
id|entry-&gt;ctrl_info
suffix:semicolon
id|memcpy
c_func
(paren
id|msg.MPS_ctrl
comma
id|mpc-&gt;mps_ctrl_addr
comma
id|ATM_ESA_LEN
)paren
suffix:semicolon
id|qos
op_assign
id|atm_mpoa_search_qos
c_func
(paren
id|entry-&gt;ctrl_info.in_dst_ip
)paren
suffix:semicolon
r_if
c_cond
(paren
id|qos
op_ne
l_int|NULL
)paren
id|msg.qos
op_assign
id|qos-&gt;qos
suffix:semicolon
id|msg_to_mpoad
c_func
(paren
op_amp
id|msg
comma
id|mpc
)paren
suffix:semicolon
id|do_gettimeofday
c_func
(paren
op_amp
(paren
id|entry-&gt;reply_wait
)paren
)paren
suffix:semicolon
id|entry-&gt;entry_state
op_assign
id|INGRESS_RESOLVING
suffix:semicolon
)brace
r_if
c_cond
(paren
id|entry-&gt;shortcut
op_ne
l_int|NULL
)paren
(brace
r_return
id|OPEN
suffix:semicolon
)brace
r_return
id|CLOSED
suffix:semicolon
)brace
r_if
c_cond
(paren
id|entry-&gt;entry_state
op_eq
id|INGRESS_RESOLVING
op_logical_and
id|entry-&gt;shortcut
op_ne
l_int|NULL
)paren
(brace
r_return
id|OPEN
suffix:semicolon
)brace
r_if
c_cond
(paren
id|entry-&gt;count
OG
id|mpc-&gt;parameters.mpc_p1
op_logical_and
id|entry-&gt;entry_state
op_eq
id|INGRESS_INVALID
)paren
(brace
r_int
r_char
op_star
id|ip
op_assign
(paren
r_int
r_char
op_star
)paren
op_amp
id|entry-&gt;ctrl_info.in_dst_ip
suffix:semicolon
id|dprintk
c_func
(paren
l_string|&quot;mpoa: (%s) mpoa_caches.c: threshold exceeded for ip %u.%u.%u.%u, sending MPOA res req&bslash;n&quot;
comma
id|mpc-&gt;dev-&gt;name
comma
id|ip
(braket
l_int|0
)braket
comma
id|ip
(braket
l_int|1
)braket
comma
id|ip
(braket
l_int|2
)braket
comma
id|ip
(braket
l_int|3
)braket
)paren
suffix:semicolon
id|entry-&gt;entry_state
op_assign
id|INGRESS_RESOLVING
suffix:semicolon
id|msg.type
op_assign
id|SND_MPOA_RES_RQST
suffix:semicolon
id|memcpy
c_func
(paren
id|msg.MPS_ctrl
comma
id|mpc-&gt;mps_ctrl_addr
comma
id|ATM_ESA_LEN
)paren
suffix:semicolon
id|msg.content.in_info
op_assign
id|entry-&gt;ctrl_info
suffix:semicolon
id|qos
op_assign
id|atm_mpoa_search_qos
c_func
(paren
id|entry-&gt;ctrl_info.in_dst_ip
)paren
suffix:semicolon
r_if
c_cond
(paren
id|qos
op_ne
l_int|NULL
)paren
id|msg.qos
op_assign
id|qos-&gt;qos
suffix:semicolon
id|msg_to_mpoad
c_func
(paren
op_amp
id|msg
comma
id|mpc
)paren
suffix:semicolon
id|do_gettimeofday
c_func
(paren
op_amp
(paren
id|entry-&gt;reply_wait
)paren
)paren
suffix:semicolon
)brace
r_return
id|CLOSED
suffix:semicolon
)brace
multiline_comment|/*&n; * If there are no more references to vcc in egress cache,&n; * we are ready to close it.&n; */
DECL|function|close_unused_egress_vcc
r_static
r_void
id|close_unused_egress_vcc
c_func
(paren
r_struct
id|atm_vcc
op_star
id|vcc
comma
r_struct
id|mpoa_client
op_star
id|mpc
)paren
(brace
r_if
c_cond
(paren
id|vcc
op_eq
l_int|NULL
)paren
r_return
suffix:semicolon
id|dprintk
c_func
(paren
l_string|&quot;mpoa: mpoa_caches.c: close_unused_egress_vcc:&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mpc-&gt;eg_ops
op_member_access_from_pointer
id|search_by_vcc
c_func
(paren
id|vcc
comma
id|mpc
)paren
op_ne
l_int|NULL
)paren
r_return
suffix:semicolon
multiline_comment|/* entry still in use */
id|atm_async_release_vcc
c_func
(paren
id|vcc
comma
op_minus
id|EPIPE
)paren
suffix:semicolon
multiline_comment|/* nobody uses this VCC anymore, close it */
id|dprintk
c_func
(paren
l_string|&quot;mpoa: mpoa_caches.c: close_unused_egress_vcc, closed one:&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/*&n; * This should be called with write lock on&n; */
DECL|function|in_cache_remove
r_static
r_int
id|in_cache_remove
c_func
(paren
id|in_cache_entry
op_star
id|entry
comma
r_struct
id|mpoa_client
op_star
id|client
)paren
(brace
r_struct
id|atm_vcc
op_star
id|vcc
suffix:semicolon
r_struct
id|k_message
id|msg
suffix:semicolon
r_int
r_char
op_star
id|ip
suffix:semicolon
r_if
c_cond
(paren
id|entry
op_eq
l_int|NULL
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
id|vcc
op_assign
id|entry-&gt;shortcut
suffix:semicolon
id|ip
op_assign
(paren
r_int
r_char
op_star
)paren
op_amp
id|entry-&gt;ctrl_info.in_dst_ip
suffix:semicolon
id|dprintk
c_func
(paren
l_string|&quot;mpoa: mpoa_caches.c: removing an ingress entry, ip = %u.%u.%u.%u&bslash;n&quot;
comma
id|ip
(braket
l_int|0
)braket
comma
id|ip
(braket
l_int|1
)braket
comma
id|ip
(braket
l_int|2
)braket
comma
id|ip
(braket
l_int|3
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
id|entry-&gt;prev
op_ne
l_int|NULL
)paren
id|entry-&gt;prev-&gt;next
op_assign
id|entry-&gt;next
suffix:semicolon
r_else
id|client-&gt;in_cache
op_assign
id|entry-&gt;next
suffix:semicolon
r_if
c_cond
(paren
id|entry-&gt;next
op_ne
l_int|NULL
)paren
id|entry-&gt;next-&gt;prev
op_assign
id|entry-&gt;prev
suffix:semicolon
id|memset
c_func
(paren
id|entry
comma
l_int|0
comma
r_sizeof
(paren
id|in_cache_entry
)paren
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|entry
)paren
suffix:semicolon
r_if
c_cond
(paren
id|client-&gt;in_cache
op_eq
l_int|NULL
op_logical_and
id|client-&gt;eg_cache
op_eq
l_int|NULL
)paren
(brace
id|msg.type
op_assign
id|STOP_KEEP_ALIVE_SM
suffix:semicolon
id|msg_to_mpoad
c_func
(paren
op_amp
id|msg
comma
id|client
)paren
suffix:semicolon
)brace
id|close_unused_egress_vcc
c_func
(paren
id|vcc
comma
id|client
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
multiline_comment|/* Call this every MPC-p2 seconds... Not exactly correct solution, &n;   but an easy one... */
DECL|function|clear_count_and_expired
r_static
r_void
id|clear_count_and_expired
c_func
(paren
r_struct
id|mpoa_client
op_star
id|client
)paren
(brace
r_int
r_char
op_star
id|ip
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|in_cache_entry
op_star
id|entry
comma
op_star
id|next_entry
suffix:semicolon
r_struct
id|timeval
id|now
suffix:semicolon
id|do_gettimeofday
c_func
(paren
op_amp
id|now
)paren
suffix:semicolon
id|write_lock_irqsave
c_func
(paren
op_amp
id|client-&gt;ingress_lock
comma
id|flags
)paren
suffix:semicolon
id|entry
op_assign
id|client-&gt;in_cache
suffix:semicolon
r_while
c_loop
(paren
id|entry
op_ne
l_int|NULL
)paren
(brace
id|entry-&gt;count
op_assign
l_int|0
suffix:semicolon
id|next_entry
op_assign
id|entry-&gt;next
suffix:semicolon
r_if
c_cond
(paren
(paren
id|now.tv_sec
op_minus
id|entry-&gt;tv.tv_sec
)paren
OG
id|entry-&gt;ctrl_info.holding_time
)paren
(brace
id|ip
op_assign
(paren
r_int
r_char
op_star
)paren
op_amp
id|entry-&gt;ctrl_info.in_dst_ip
suffix:semicolon
id|dprintk
c_func
(paren
l_string|&quot;mpoa: mpoa_caches.c: holding time expired, ip = %d.%d.%d.%d&bslash;n&quot;
comma
id|ip
(braket
l_int|0
)braket
comma
id|ip
(braket
l_int|1
)braket
comma
id|ip
(braket
l_int|2
)braket
comma
id|ip
(braket
l_int|3
)braket
)paren
suffix:semicolon
id|in_cache_remove
c_func
(paren
id|entry
comma
id|client
)paren
suffix:semicolon
)brace
id|entry
op_assign
id|next_entry
suffix:semicolon
)brace
id|write_unlock_irqrestore
c_func
(paren
op_amp
id|client-&gt;ingress_lock
comma
id|flags
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/* Call this every MPC-p4 seconds. */
DECL|function|check_resolving_entries
r_static
r_void
id|check_resolving_entries
c_func
(paren
r_struct
id|mpoa_client
op_star
id|client
)paren
(brace
r_struct
id|atm_mpoa_qos
op_star
id|qos
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|in_cache_entry
op_star
id|entry
suffix:semicolon
r_struct
id|timeval
id|now
suffix:semicolon
r_struct
id|k_message
id|msg
suffix:semicolon
id|do_gettimeofday
c_func
(paren
op_amp
id|now
)paren
suffix:semicolon
id|read_lock_irqsave
c_func
(paren
op_amp
id|client-&gt;ingress_lock
comma
id|flags
)paren
suffix:semicolon
id|entry
op_assign
id|client-&gt;in_cache
suffix:semicolon
r_while
c_loop
(paren
id|entry
op_ne
l_int|NULL
)paren
(brace
r_if
c_cond
(paren
id|entry-&gt;entry_state
op_eq
id|INGRESS_RESOLVING
)paren
(brace
r_if
c_cond
(paren
id|now.tv_sec
op_minus
id|entry-&gt;hold_down.tv_sec
OL
id|client-&gt;parameters.mpc_p6
)paren
(brace
id|entry
op_assign
id|entry-&gt;next
suffix:semicolon
multiline_comment|/* Entry in hold down */
r_continue
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|now.tv_sec
op_minus
id|entry-&gt;reply_wait.tv_sec
)paren
OG
id|entry-&gt;retry_time
)paren
(brace
id|entry-&gt;retry_time
op_assign
id|MPC_C1
op_star
(paren
id|entry-&gt;retry_time
)paren
suffix:semicolon
r_if
c_cond
(paren
id|entry-&gt;retry_time
OG
id|client-&gt;parameters.mpc_p5
)paren
(brace
multiline_comment|/* Retry time maximum exceeded, put entry in hold down. */
id|do_gettimeofday
c_func
(paren
op_amp
(paren
id|entry-&gt;hold_down
)paren
)paren
suffix:semicolon
id|entry-&gt;retry_time
op_assign
id|client-&gt;parameters.mpc_p4
suffix:semicolon
id|entry
op_assign
id|entry-&gt;next
suffix:semicolon
r_continue
suffix:semicolon
)brace
multiline_comment|/* Ask daemon to send a resolution request. */
id|memset
c_func
(paren
op_amp
(paren
id|entry-&gt;hold_down
)paren
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|timeval
)paren
)paren
suffix:semicolon
id|msg.type
op_assign
id|SND_MPOA_RES_RTRY
suffix:semicolon
id|memcpy
c_func
(paren
id|msg.MPS_ctrl
comma
id|client-&gt;mps_ctrl_addr
comma
id|ATM_ESA_LEN
)paren
suffix:semicolon
id|msg.content.in_info
op_assign
id|entry-&gt;ctrl_info
suffix:semicolon
id|qos
op_assign
id|atm_mpoa_search_qos
c_func
(paren
id|entry-&gt;ctrl_info.in_dst_ip
)paren
suffix:semicolon
r_if
c_cond
(paren
id|qos
op_ne
l_int|NULL
)paren
id|msg.qos
op_assign
id|qos-&gt;qos
suffix:semicolon
id|msg_to_mpoad
c_func
(paren
op_amp
id|msg
comma
id|client
)paren
suffix:semicolon
id|do_gettimeofday
c_func
(paren
op_amp
(paren
id|entry-&gt;reply_wait
)paren
)paren
suffix:semicolon
)brace
)brace
id|entry
op_assign
id|entry-&gt;next
suffix:semicolon
)brace
id|read_unlock_irqrestore
c_func
(paren
op_amp
id|client-&gt;ingress_lock
comma
id|flags
)paren
suffix:semicolon
)brace
multiline_comment|/* Call this every MPC-p5 seconds. */
DECL|function|refresh_entries
r_static
r_void
id|refresh_entries
c_func
(paren
r_struct
id|mpoa_client
op_star
id|client
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
r_struct
id|timeval
id|now
suffix:semicolon
r_struct
id|in_cache_entry
op_star
id|entry
op_assign
id|client-&gt;in_cache
suffix:semicolon
id|ddprintk
c_func
(paren
l_string|&quot;mpoa: mpoa_caches.c: refresh_entries&bslash;n&quot;
)paren
suffix:semicolon
id|do_gettimeofday
c_func
(paren
op_amp
id|now
)paren
suffix:semicolon
id|read_lock_irqsave
c_func
(paren
op_amp
id|client-&gt;ingress_lock
comma
id|flags
)paren
suffix:semicolon
r_while
c_loop
(paren
id|entry
op_ne
l_int|NULL
)paren
(brace
r_if
c_cond
(paren
id|entry-&gt;entry_state
op_eq
id|INGRESS_RESOLVED
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|entry-&gt;refresh_time
)paren
)paren
(brace
id|entry-&gt;refresh_time
op_assign
(paren
l_int|2
op_star
(paren
id|entry-&gt;ctrl_info.holding_time
)paren
)paren
op_div
l_int|3
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|now.tv_sec
op_minus
id|entry-&gt;reply_wait.tv_sec
)paren
OG
id|entry-&gt;refresh_time
)paren
(brace
id|dprintk
c_func
(paren
l_string|&quot;mpoa: mpoa_caches.c: refreshing an entry.&bslash;n&quot;
)paren
suffix:semicolon
id|entry-&gt;entry_state
op_assign
id|INGRESS_REFRESHING
suffix:semicolon
)brace
)brace
id|entry
op_assign
id|entry-&gt;next
suffix:semicolon
)brace
id|read_unlock_irqrestore
c_func
(paren
op_amp
id|client-&gt;ingress_lock
comma
id|flags
)paren
suffix:semicolon
)brace
DECL|function|eg_cache_search_by_cache_id
r_static
id|eg_cache_entry
op_star
id|eg_cache_search_by_cache_id
c_func
(paren
r_uint32
id|cache_id
comma
r_struct
id|mpoa_client
op_star
id|client
)paren
(brace
id|eg_cache_entry
op_star
id|entry
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|read_lock_irqsave
c_func
(paren
op_amp
id|client-&gt;egress_lock
comma
id|flags
)paren
suffix:semicolon
id|entry
op_assign
id|client-&gt;eg_cache
suffix:semicolon
r_while
c_loop
(paren
id|entry
op_ne
l_int|NULL
)paren
(brace
r_if
c_cond
(paren
id|entry-&gt;ctrl_info.cache_id
op_eq
id|cache_id
)paren
(brace
id|read_unlock_irqrestore
c_func
(paren
op_amp
id|client-&gt;egress_lock
comma
id|flags
)paren
suffix:semicolon
r_return
id|entry
suffix:semicolon
)brace
id|entry
op_assign
id|entry-&gt;next
suffix:semicolon
)brace
id|read_unlock_irqrestore
c_func
(paren
op_amp
id|client-&gt;egress_lock
comma
id|flags
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
DECL|function|eg_cache_search_by_tag
r_static
id|eg_cache_entry
op_star
id|eg_cache_search_by_tag
c_func
(paren
r_uint32
id|tag
comma
r_struct
id|mpoa_client
op_star
id|client
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
id|eg_cache_entry
op_star
id|entry
suffix:semicolon
id|read_lock_irqsave
c_func
(paren
op_amp
id|client-&gt;egress_lock
comma
id|flags
)paren
suffix:semicolon
id|entry
op_assign
id|client-&gt;eg_cache
suffix:semicolon
r_while
c_loop
(paren
id|entry
op_ne
l_int|NULL
)paren
(brace
r_if
c_cond
(paren
id|entry-&gt;ctrl_info.tag
op_eq
id|tag
)paren
(brace
id|read_unlock_irqrestore
c_func
(paren
op_amp
id|client-&gt;egress_lock
comma
id|flags
)paren
suffix:semicolon
r_return
id|entry
suffix:semicolon
)brace
id|entry
op_assign
id|entry-&gt;next
suffix:semicolon
)brace
id|read_unlock_irqrestore
c_func
(paren
op_amp
id|client-&gt;egress_lock
comma
id|flags
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
DECL|function|eg_cache_search_by_vcc
r_static
id|eg_cache_entry
op_star
id|eg_cache_search_by_vcc
c_func
(paren
r_struct
id|atm_vcc
op_star
id|vcc
comma
r_struct
id|mpoa_client
op_star
id|client
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
id|eg_cache_entry
op_star
id|entry
suffix:semicolon
id|read_lock_irqsave
c_func
(paren
op_amp
id|client-&gt;egress_lock
comma
id|flags
)paren
suffix:semicolon
id|entry
op_assign
id|client-&gt;eg_cache
suffix:semicolon
r_while
c_loop
(paren
id|entry
op_ne
l_int|NULL
)paren
(brace
r_if
c_cond
(paren
id|entry-&gt;shortcut
op_eq
id|vcc
)paren
(brace
id|read_unlock_irqrestore
c_func
(paren
op_amp
id|client-&gt;egress_lock
comma
id|flags
)paren
suffix:semicolon
r_return
id|entry
suffix:semicolon
)brace
id|entry
op_assign
id|entry-&gt;next
suffix:semicolon
)brace
id|read_unlock_irqrestore
c_func
(paren
op_amp
id|client-&gt;egress_lock
comma
id|flags
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
DECL|function|eg_cache_search_by_src_ip
r_static
id|eg_cache_entry
op_star
id|eg_cache_search_by_src_ip
c_func
(paren
r_uint32
id|ipaddr
comma
r_struct
id|mpoa_client
op_star
id|client
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
id|eg_cache_entry
op_star
id|entry
suffix:semicolon
id|read_lock_irqsave
c_func
(paren
op_amp
id|client-&gt;egress_lock
comma
id|flags
)paren
suffix:semicolon
id|entry
op_assign
id|client-&gt;eg_cache
suffix:semicolon
r_while
c_loop
(paren
id|entry
op_ne
l_int|NULL
)paren
(brace
r_if
c_cond
(paren
id|entry-&gt;latest_ip_addr
op_eq
id|ipaddr
)paren
(brace
r_break
suffix:semicolon
)brace
id|entry
op_assign
id|entry-&gt;next
suffix:semicolon
)brace
id|read_unlock_irqrestore
c_func
(paren
op_amp
id|client-&gt;egress_lock
comma
id|flags
)paren
suffix:semicolon
r_return
id|entry
suffix:semicolon
)brace
multiline_comment|/*&n; * If there are no more references to vcc in ingress cache,&n; * we are ready to close it.&n; */
DECL|function|close_unused_ingress_vcc
r_static
r_void
id|close_unused_ingress_vcc
c_func
(paren
r_struct
id|atm_vcc
op_star
id|vcc
comma
r_struct
id|mpoa_client
op_star
id|mpc
)paren
(brace
r_if
c_cond
(paren
id|vcc
op_eq
l_int|NULL
)paren
r_return
suffix:semicolon
id|dprintk
c_func
(paren
l_string|&quot;mpoa: mpoa_caches.c: close_unused_ingress_vcc:&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mpc-&gt;in_ops
op_member_access_from_pointer
id|search_by_vcc
c_func
(paren
id|vcc
comma
id|mpc
)paren
op_ne
l_int|NULL
)paren
r_return
suffix:semicolon
multiline_comment|/* entry still in use */
id|atm_async_release_vcc
c_func
(paren
id|vcc
comma
op_minus
id|EPIPE
)paren
suffix:semicolon
multiline_comment|/* nobody uses this VCC anymore, close it */
id|dprintk
c_func
(paren
l_string|&quot;mpoa: mpoa_caches.c: close_unused_ingress_vcc:, closed one&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/*&n; * This should be called with write lock on&n; */
DECL|function|eg_cache_remove
r_static
r_int
id|eg_cache_remove
c_func
(paren
id|eg_cache_entry
op_star
id|entry
comma
r_struct
id|mpoa_client
op_star
id|client
)paren
(brace
r_struct
id|atm_vcc
op_star
id|vcc
suffix:semicolon
r_struct
id|k_message
id|msg
suffix:semicolon
r_if
c_cond
(paren
id|entry
op_eq
l_int|NULL
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
id|vcc
op_assign
id|entry-&gt;shortcut
suffix:semicolon
id|dprintk
c_func
(paren
l_string|&quot;mpoa: mpoa_caches.c: removing an egress entry.&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|entry-&gt;prev
op_ne
l_int|NULL
)paren
id|entry-&gt;prev-&gt;next
op_assign
id|entry-&gt;next
suffix:semicolon
r_else
id|client-&gt;eg_cache
op_assign
id|entry-&gt;next
suffix:semicolon
r_if
c_cond
(paren
id|entry-&gt;next
op_ne
l_int|NULL
)paren
id|entry-&gt;next-&gt;prev
op_assign
id|entry-&gt;prev
suffix:semicolon
id|memset
c_func
(paren
id|entry
comma
l_int|0
comma
r_sizeof
(paren
id|eg_cache_entry
)paren
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|entry
)paren
suffix:semicolon
r_if
c_cond
(paren
id|client-&gt;in_cache
op_eq
l_int|NULL
op_logical_and
id|client-&gt;eg_cache
op_eq
l_int|NULL
)paren
(brace
id|msg.type
op_assign
id|STOP_KEEP_ALIVE_SM
suffix:semicolon
id|msg_to_mpoad
c_func
(paren
op_amp
id|msg
comma
id|client
)paren
suffix:semicolon
)brace
id|close_unused_ingress_vcc
c_func
(paren
id|vcc
comma
id|client
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
DECL|function|new_eg_cache_entry
r_static
id|eg_cache_entry
op_star
id|new_eg_cache_entry
c_func
(paren
r_struct
id|k_message
op_star
id|msg
comma
r_struct
id|mpoa_client
op_star
id|client
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
r_int
r_char
op_star
id|ip
suffix:semicolon
id|eg_cache_entry
op_star
id|entry
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
id|eg_cache_entry
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|entry
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;mpoa: mpoa_caches.c: new_eg_cache_entry: out of memory&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
id|ip
op_assign
(paren
r_int
r_char
op_star
)paren
op_amp
id|msg-&gt;content.eg_info.eg_dst_ip
suffix:semicolon
id|dprintk
c_func
(paren
l_string|&quot;mpoa: mpoa_caches.c: adding an egress entry, ip = %d.%d.%d.%d, this should be our IP&bslash;n&quot;
comma
id|ip
(braket
l_int|0
)braket
comma
id|ip
(braket
l_int|1
)braket
comma
id|ip
(braket
l_int|2
)braket
comma
id|ip
(braket
l_int|3
)braket
)paren
suffix:semicolon
id|memset
c_func
(paren
id|entry
comma
l_int|0
comma
r_sizeof
(paren
id|eg_cache_entry
)paren
)paren
suffix:semicolon
id|dprintk
c_func
(paren
l_string|&quot;mpoa: mpoa_caches.c: new_eg_cache_entry: about to lock&bslash;n&quot;
)paren
suffix:semicolon
id|write_lock_irqsave
c_func
(paren
op_amp
id|client-&gt;egress_lock
comma
id|flags
)paren
suffix:semicolon
id|entry-&gt;next
op_assign
id|client-&gt;eg_cache
suffix:semicolon
id|entry-&gt;prev
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
id|client-&gt;eg_cache
op_ne
l_int|NULL
)paren
id|client-&gt;eg_cache-&gt;prev
op_assign
id|entry
suffix:semicolon
id|client-&gt;eg_cache
op_assign
id|entry
suffix:semicolon
id|write_unlock_irqrestore
c_func
(paren
op_amp
id|client-&gt;egress_lock
comma
id|flags
)paren
suffix:semicolon
id|dprintk
c_func
(paren
l_string|&quot;mpoa: mpoa_caches.c: new_eg_cache_entry: unlocked&bslash;n&quot;
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|entry-&gt;MPS_ctrl_ATM_addr
comma
id|client-&gt;mps_ctrl_addr
comma
id|ATM_ESA_LEN
)paren
suffix:semicolon
id|entry-&gt;ctrl_info
op_assign
id|msg-&gt;content.eg_info
suffix:semicolon
id|do_gettimeofday
c_func
(paren
op_amp
(paren
id|entry-&gt;tv
)paren
)paren
suffix:semicolon
id|entry-&gt;entry_state
op_assign
id|EGRESS_RESOLVED
suffix:semicolon
id|dprintk
c_func
(paren
l_string|&quot;mpoa: mpoa_caches.c: new_eg_cache_entry cache_id %lu&bslash;n&quot;
comma
id|ntohl
c_func
(paren
id|entry-&gt;ctrl_info.cache_id
)paren
)paren
suffix:semicolon
id|ip
op_assign
(paren
r_int
r_char
op_star
)paren
op_amp
id|entry-&gt;ctrl_info.mps_ip
suffix:semicolon
id|dprintk
c_func
(paren
l_string|&quot;mpoa: mpoa_caches.c: mps_ip = %d.%d.%d.%d&bslash;n&quot;
comma
id|ip
(braket
l_int|0
)braket
comma
id|ip
(braket
l_int|1
)braket
comma
id|ip
(braket
l_int|2
)braket
comma
id|ip
(braket
l_int|3
)braket
)paren
suffix:semicolon
r_return
id|entry
suffix:semicolon
)brace
DECL|function|update_eg_cache_entry
r_static
r_void
id|update_eg_cache_entry
c_func
(paren
id|eg_cache_entry
op_star
id|entry
comma
r_uint16
id|holding_time
)paren
(brace
id|do_gettimeofday
c_func
(paren
op_amp
(paren
id|entry-&gt;tv
)paren
)paren
suffix:semicolon
id|entry-&gt;entry_state
op_assign
id|EGRESS_RESOLVED
suffix:semicolon
id|entry-&gt;ctrl_info.holding_time
op_assign
id|holding_time
suffix:semicolon
r_return
suffix:semicolon
)brace
DECL|function|clear_expired
r_static
r_void
(def_block
id|clear_expired
c_func
(paren
r_struct
id|mpoa_client
op_star
id|client
)paren
(brace
id|eg_cache_entry
op_star
id|entry
comma
op_star
id|next_entry
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_struct
id|timeval
id|now
suffix:semicolon
r_struct
id|k_message
id|msg
suffix:semicolon
id|do_gettimeofday
c_func
(paren
op_amp
id|now
)paren
suffix:semicolon
id|write_lock_irqsave
c_func
(paren
op_amp
id|client-&gt;egress_lock
comma
id|flags
)paren
suffix:semicolon
id|entry
op_assign
id|client-&gt;eg_cache
suffix:semicolon
r_while
c_loop
(paren
id|entry
op_ne
l_int|NULL
)paren
(brace
id|next_entry
op_assign
id|entry-&gt;next
suffix:semicolon
r_if
c_cond
(paren
(paren
id|now.tv_sec
op_minus
id|entry-&gt;tv.tv_sec
)paren
OG
id|entry-&gt;ctrl_info.holding_time
)paren
(brace
id|msg.type
op_assign
id|SND_EGRESS_PURGE
suffix:semicolon
id|msg.content.eg_info
op_assign
id|entry-&gt;ctrl_info
suffix:semicolon
id|dprintk
c_func
(paren
l_string|&quot;mpoa: mpoa_caches.c: egress_cache: holding time expired, cache_id = %lu.&bslash;n&quot;
comma
id|ntohl
c_func
(paren
id|entry-&gt;ctrl_info.cache_id
)paren
)paren
suffix:semicolon
id|msg_to_mpoad
c_func
(paren
op_amp
id|msg
comma
id|client
)paren
suffix:semicolon
id|eg_cache_remove
c_func
(paren
id|entry
comma
id|client
)paren
suffix:semicolon
)brace
id|entry
op_assign
id|next_entry
suffix:semicolon
)brace
id|write_unlock_irqrestore
c_func
(paren
op_amp
id|client-&gt;egress_lock
comma
id|flags
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
)def_block
DECL|variable|ingress_ops
r_static
r_struct
id|in_cache_ops
id|ingress_ops
op_assign
(brace
id|new_in_cache_entry
comma
multiline_comment|/* new_entry        */
id|in_cache_search
comma
multiline_comment|/* search           */
id|in_cache_search_with_mask
comma
multiline_comment|/* search_with_mask */
id|in_cache_search_by_vcc
comma
multiline_comment|/* search_by_vcc    */
id|cache_hit
comma
multiline_comment|/* cache_hit        */
id|in_cache_remove
comma
multiline_comment|/* cache_remove     */
id|clear_count_and_expired
comma
multiline_comment|/* clear_count      */
id|check_resolving_entries
comma
multiline_comment|/* check_resolving  */
id|refresh_entries
comma
multiline_comment|/* refresh          */
)brace
suffix:semicolon
DECL|variable|egress_ops
r_static
r_struct
id|eg_cache_ops
id|egress_ops
op_assign
(brace
id|new_eg_cache_entry
comma
multiline_comment|/* new_entry          */
id|eg_cache_search_by_cache_id
comma
multiline_comment|/* search_by_cache_id */
id|eg_cache_search_by_tag
comma
multiline_comment|/* search_by_tag      */
id|eg_cache_search_by_vcc
comma
multiline_comment|/* search_by_vcc      */
id|eg_cache_search_by_src_ip
comma
multiline_comment|/* search_by_src_ip   */
id|eg_cache_remove
comma
multiline_comment|/* cache_remove       */
id|update_eg_cache_entry
comma
multiline_comment|/* update             */
id|clear_expired
multiline_comment|/* clear_expired      */
)brace
suffix:semicolon
DECL|function|atm_mpoa_init_cache
r_void
id|atm_mpoa_init_cache
c_func
(paren
r_struct
id|mpoa_client
op_star
id|mpc
)paren
(brace
id|mpc-&gt;in_ops
op_assign
op_amp
id|ingress_ops
suffix:semicolon
id|mpc-&gt;eg_ops
op_assign
op_amp
id|egress_ops
suffix:semicolon
r_return
suffix:semicolon
)brace
eof
