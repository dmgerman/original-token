multiline_comment|/*&n; * INET&t;&t;An implementation of the TCP/IP protocol suite for the LINUX&n; *&t;&t;operating system.  INET is implemented using the  BSD Socket&n; *&t;&t;interface as the means of communication with the user level.&n; *&n; *&t;&t;The User Datagram Protocol (UDP).&n; *&n; * Version:&t;@(#)udp.c&t;1.0.13&t;06/02/93&n; *&n; * Authors:&t;Ross Biro, &lt;bir7@leland.Stanford.Edu&gt;&n; *&t;&t;Fred N. van Kempen, &lt;waltje@uWalt.NL.Mugnet.ORG&gt;&n; *&n; * Fixes:&n; *&t;&t;Alan Cox&t;:&t;verify_area() calls&n; *&t;&t;Alan Cox&t;: &t;stopped close while in use off icmp&n; *&t;&t;&t;&t;&t;messages. Not a fix but a botch that&n; *&t;&t;&t;&t;&t;for udp at least is &squot;valid&squot;.&n; *&t;&t;Alan Cox&t;:&t;Fixed icmp handling properly&n; *&t;&t;Alan Cox&t;: &t;Correct error for oversized datagrams&n; *&t;&t;Alan Cox&t;:&t;Tidied select() semantics. &n; *&t;&t;Alan Cox&t;:&t;udp_err() fixed properly, also now &n; *&t;&t;&t;&t;&t;select and read wake correctly on errors&n; *&t;&t;Alan Cox&t;:&t;udp_send verify_area moved to avoid mem leak&n; *&t;&t;Alan Cox&t;:&t;UDP can count its memory&n; *&t;&t;Alan Cox&t;:&t;send to an unknown connection causes&n; *&t;&t;&t;&t;&t;an ECONNREFUSED off the icmp, but&n; *&t;&t;&t;&t;&t;does NOT close.&n; *&t;&t;Alan Cox&t;:&t;Switched to new sk_buff handlers. No more backlog!&n; *&t;&t;Alan Cox&t;:&t;Using generic datagram code. Even smaller and the PEEK&n; *&t;&t;&t;&t;&t;bug no longer crashes it.&n; *&t;&t;Fred Van Kempen&t;: &t;Net2e support for sk-&gt;broadcast.&n; *&t;&t;Alan Cox&t;:&t;Uses skb_free_datagram&n; *&t;&t;Alan Cox&t;:&t;Added get/set sockopt support.&n; *&t;&t;Alan Cox&t;:&t;Broadcasting without option set returns EACCES.&n; *&t;&t;Alan Cox&t;:&t;No wakeup calls. Instead we now use the callbacks.&n; *&t;&t;Alan Cox&t;:&t;Use ip_tos and ip_ttl&n; *&t;&t;Alan Cox&t;:&t;SNMP Mibs&n; *&t;&t;Alan Cox&t;:&t;MSG_DONTROUTE, and 0.0.0.0 support.&n; *&t;&t;Matt Dillon&t;:&t;UDP length checks.&n; *&t;&t;Alan Cox&t;:&t;Smarter af_inet used properly.&n; *&t;&t;Alan Cox&t;:&t;Use new kernel side addressing.&n; *&t;&t;Alan Cox&t;:&t;Incorrect return on truncated datagram receive.&n; *&n; *&n; *&t;&t;This program is free software; you can redistribute it and/or&n; *&t;&t;modify it under the terms of the GNU General Public License&n; *&t;&t;as published by the Free Software Foundation; either version&n; *&t;&t;2 of the License, or (at your option) any later version.&n; */
macro_line|#include &lt;asm/system.h&gt;
macro_line|#include &lt;asm/segment.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/fcntl.h&gt;
macro_line|#include &lt;linux/socket.h&gt;
macro_line|#include &lt;linux/sockios.h&gt;
macro_line|#include &lt;linux/in.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/timer.h&gt;
macro_line|#include &lt;linux/termios.h&gt;
macro_line|#include &lt;linux/mm.h&gt;
macro_line|#include &lt;linux/inet.h&gt;
macro_line|#include &lt;linux/netdevice.h&gt;
macro_line|#include &quot;snmp.h&quot;
macro_line|#include &quot;ip.h&quot;
macro_line|#include &quot;protocol.h&quot;
macro_line|#include &quot;tcp.h&quot;
macro_line|#include &lt;linux/skbuff.h&gt;
macro_line|#include &quot;sock.h&quot;
macro_line|#include &quot;udp.h&quot;
macro_line|#include &quot;icmp.h&quot;
multiline_comment|/*&n; *&t;SNMP MIB for the UDP layer&n; */
DECL|variable|udp_statistics
r_struct
id|udp_mib
id|udp_statistics
suffix:semicolon
r_static
r_int
id|udp_deliver
c_func
(paren
r_struct
id|sock
op_star
id|sk
comma
r_struct
id|udphdr
op_star
id|uh
comma
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|device
op_star
id|dev
comma
r_int
id|saddr
comma
r_int
id|daddr
comma
r_int
id|len
)paren
suffix:semicolon
DECL|macro|min
mdefine_line|#define min(a,b)&t;((a)&lt;(b)?(a):(b))
multiline_comment|/*&n; * This routine is called by the ICMP module when it gets some&n; * sort of error condition.  If err &lt; 0 then the socket should&n; * be closed and the error returned to the user.  If err &gt; 0&n; * it&squot;s just the icmp type &lt;&lt; 8 | icmp code.  &n; * Header points to the ip header of the error packet. We move&n; * on past this. Then (as it used to claim before adjustment)&n; * header points to the first 8 bytes of the udp header.  We need&n; * to find the appropriate port.&n; */
DECL|function|udp_err
r_void
id|udp_err
c_func
(paren
r_int
id|err
comma
r_int
r_char
op_star
id|header
comma
r_int
r_int
id|daddr
comma
r_int
r_int
id|saddr
comma
r_struct
id|inet_protocol
op_star
id|protocol
)paren
(brace
r_struct
id|udphdr
op_star
id|th
suffix:semicolon
r_struct
id|sock
op_star
id|sk
suffix:semicolon
r_struct
id|iphdr
op_star
id|ip
op_assign
(paren
r_struct
id|iphdr
op_star
)paren
id|header
suffix:semicolon
id|header
op_add_assign
l_int|4
op_star
id|ip-&gt;ihl
suffix:semicolon
multiline_comment|/*&n;&t; *&t;Find the 8 bytes of post IP header ICMP included for us&n;&t; */
id|th
op_assign
(paren
r_struct
id|udphdr
op_star
)paren
id|header
suffix:semicolon
id|sk
op_assign
id|get_sock
c_func
(paren
op_amp
id|udp_prot
comma
id|th-&gt;source
comma
id|daddr
comma
id|th-&gt;dest
comma
id|saddr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sk
op_eq
l_int|NULL
)paren
r_return
suffix:semicolon
multiline_comment|/* No socket for error */
r_if
c_cond
(paren
id|err
op_amp
l_int|0xff00
op_eq
(paren
id|ICMP_SOURCE_QUENCH
op_lshift
l_int|8
)paren
)paren
(brace
multiline_comment|/* Slow down! */
r_if
c_cond
(paren
id|sk-&gt;cong_window
OG
l_int|1
)paren
id|sk-&gt;cong_window
op_assign
id|sk-&gt;cong_window
op_div
l_int|2
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/*&n;&t; *&t;Various people wanted BSD UDP semantics. Well they&squot;ve come &n;&t; *&t;back out because they slow down response to stuff like dead&n;&t; *&t;or unreachable name servers and they screw term users something&n;&t; *&t;chronic. Oh and it violates RFC1122. So basically fix your &n;&t; *&t;client code people.&n;&t; */
macro_line|#ifdef CONFIG_I_AM_A_BROKEN_BSD_WEENIE
multiline_comment|/*&n;&t; *&t;It&squot;s only fatal if we have connected to them. I&squot;m not happy&n;&t; *&t;with this code. Some BSD comparisons need doing.&n;&t; */
r_if
c_cond
(paren
id|icmp_err_convert
(braket
id|err
op_amp
l_int|0xff
)braket
dot
id|fatal
op_logical_and
id|sk-&gt;state
op_eq
id|TCP_ESTABLISHED
)paren
(brace
id|sk-&gt;err
op_assign
id|icmp_err_convert
(braket
id|err
op_amp
l_int|0xff
)braket
dot
id|errno
suffix:semicolon
id|sk
op_member_access_from_pointer
id|error_report
c_func
(paren
id|sk
)paren
suffix:semicolon
)brace
macro_line|#else
r_if
c_cond
(paren
id|icmp_err_convert
(braket
id|err
op_amp
l_int|0xff
)braket
dot
id|fatal
)paren
(brace
id|sk-&gt;err
op_assign
id|icmp_err_convert
(braket
id|err
op_amp
l_int|0xff
)braket
dot
id|errno
suffix:semicolon
id|sk
op_member_access_from_pointer
id|error_report
c_func
(paren
id|sk
)paren
suffix:semicolon
)brace
macro_line|#endif
)brace
DECL|function|udp_check
r_static
r_int
r_int
id|udp_check
c_func
(paren
r_struct
id|udphdr
op_star
id|uh
comma
r_int
id|len
comma
r_int
r_int
id|saddr
comma
r_int
r_int
id|daddr
)paren
(brace
r_int
r_int
id|sum
suffix:semicolon
id|__asm__
c_func
(paren
l_string|&quot;&bslash;t addl %%ecx,%%ebx&bslash;n&quot;
l_string|&quot;&bslash;t adcl %%edx,%%ebx&bslash;n&quot;
l_string|&quot;&bslash;t adcl $0, %%ebx&bslash;n&quot;
suffix:colon
l_string|&quot;=b&quot;
(paren
id|sum
)paren
suffix:colon
l_string|&quot;0&quot;
(paren
id|daddr
)paren
comma
l_string|&quot;c&quot;
(paren
id|saddr
)paren
comma
l_string|&quot;d&quot;
(paren
(paren
id|ntohs
c_func
(paren
id|len
)paren
op_lshift
l_int|16
)paren
op_plus
id|IPPROTO_UDP
op_star
l_int|256
)paren
suffix:colon
l_string|&quot;cx&quot;
comma
l_string|&quot;bx&quot;
comma
l_string|&quot;dx&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|len
OG
l_int|3
)paren
(brace
id|__asm__
c_func
(paren
l_string|&quot;&bslash;tclc&bslash;n&quot;
l_string|&quot;1:&bslash;n&quot;
l_string|&quot;&bslash;t lodsl&bslash;n&quot;
l_string|&quot;&bslash;t adcl %%eax, %%ebx&bslash;n&quot;
l_string|&quot;&bslash;t loop 1b&bslash;n&quot;
l_string|&quot;&bslash;t adcl $0, %%ebx&bslash;n&quot;
suffix:colon
l_string|&quot;=b&quot;
(paren
id|sum
)paren
comma
l_string|&quot;=S&quot;
(paren
id|uh
)paren
suffix:colon
l_string|&quot;0&quot;
(paren
id|sum
)paren
comma
l_string|&quot;c&quot;
(paren
id|len
op_div
l_int|4
)paren
comma
l_string|&quot;1&quot;
(paren
id|uh
)paren
suffix:colon
l_string|&quot;ax&quot;
comma
l_string|&quot;cx&quot;
comma
l_string|&quot;bx&quot;
comma
l_string|&quot;si&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;&t; *&t;Convert from 32 bits to 16 bits. &n;&t; */
id|__asm__
c_func
(paren
l_string|&quot;&bslash;t movl %%ebx, %%ecx&bslash;n&quot;
l_string|&quot;&bslash;t shrl $16,%%ecx&bslash;n&quot;
l_string|&quot;&bslash;t addw %%cx, %%bx&bslash;n&quot;
l_string|&quot;&bslash;t adcw $0, %%bx&bslash;n&quot;
suffix:colon
l_string|&quot;=b&quot;
(paren
id|sum
)paren
suffix:colon
l_string|&quot;0&quot;
(paren
id|sum
)paren
suffix:colon
l_string|&quot;bx&quot;
comma
l_string|&quot;cx&quot;
)paren
suffix:semicolon
multiline_comment|/* &n;&t; *&t;Check for an extra word. &n;&t; */
r_if
c_cond
(paren
(paren
id|len
op_amp
l_int|2
)paren
op_ne
l_int|0
)paren
(brace
id|__asm__
c_func
(paren
l_string|&quot;&bslash;t lodsw&bslash;n&quot;
l_string|&quot;&bslash;t addw %%ax,%%bx&bslash;n&quot;
l_string|&quot;&bslash;t adcw $0, %%bx&bslash;n&quot;
suffix:colon
l_string|&quot;=b&quot;
(paren
id|sum
)paren
comma
l_string|&quot;=S&quot;
(paren
id|uh
)paren
suffix:colon
l_string|&quot;0&quot;
(paren
id|sum
)paren
comma
l_string|&quot;1&quot;
(paren
id|uh
)paren
suffix:colon
l_string|&quot;si&quot;
comma
l_string|&quot;ax&quot;
comma
l_string|&quot;bx&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;  &t; *&t;Now check for the extra byte. &n;  &t; */
r_if
c_cond
(paren
(paren
id|len
op_amp
l_int|1
)paren
op_ne
l_int|0
)paren
(brace
id|__asm__
c_func
(paren
l_string|&quot;&bslash;t lodsb&bslash;n&quot;
l_string|&quot;&bslash;t movb $0,%%ah&bslash;n&quot;
l_string|&quot;&bslash;t addw %%ax,%%bx&bslash;n&quot;
l_string|&quot;&bslash;t adcw $0, %%bx&bslash;n&quot;
suffix:colon
l_string|&quot;=b&quot;
(paren
id|sum
)paren
suffix:colon
l_string|&quot;0&quot;
(paren
id|sum
)paren
comma
l_string|&quot;S&quot;
(paren
id|uh
)paren
suffix:colon
l_string|&quot;si&quot;
comma
l_string|&quot;ax&quot;
comma
l_string|&quot;bx&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/* &n;  &t; *&t;We only want the bottom 16 bits, but we never cleared the top 16. &n;  &t; */
r_return
(paren
op_complement
id|sum
)paren
op_amp
l_int|0xffff
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;Generate UDP checksums. These may be disabled, eg for fast NFS over ethernet&n; *&t;We default them enabled.. if you turn them off you either know what you are&n; *&t;doing or get burned...&n; */
DECL|function|udp_send_check
r_static
r_void
id|udp_send_check
c_func
(paren
r_struct
id|udphdr
op_star
id|uh
comma
r_int
r_int
id|saddr
comma
r_int
r_int
id|daddr
comma
r_int
id|len
comma
r_struct
id|sock
op_star
id|sk
)paren
(brace
id|uh-&gt;check
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|sk
op_logical_and
id|sk-&gt;no_check
)paren
r_return
suffix:semicolon
id|uh-&gt;check
op_assign
id|udp_check
c_func
(paren
id|uh
comma
id|len
comma
id|saddr
comma
id|daddr
)paren
suffix:semicolon
multiline_comment|/*&n;&t; *&t;FFFF and 0 are the same, pick the right one as 0 in the&n;&t; *&t;actual field means no checksum.&n;&t; */
r_if
c_cond
(paren
id|uh-&gt;check
op_eq
l_int|0
)paren
id|uh-&gt;check
op_assign
l_int|0xffff
suffix:semicolon
)brace
DECL|function|udp_send
r_static
r_int
id|udp_send
c_func
(paren
r_struct
id|sock
op_star
id|sk
comma
r_struct
id|sockaddr_in
op_star
id|sin
comma
r_int
r_char
op_star
id|from
comma
r_int
id|len
comma
r_int
id|rt
)paren
(brace
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
r_struct
id|device
op_star
id|dev
suffix:semicolon
r_struct
id|udphdr
op_star
id|uh
suffix:semicolon
r_int
r_char
op_star
id|buff
suffix:semicolon
r_int
r_int
id|saddr
suffix:semicolon
r_int
id|size
comma
id|tmp
suffix:semicolon
r_int
id|ttl
suffix:semicolon
multiline_comment|/* &n;&t; *&t;Allocate an sk_buff copy of the packet.&n;&t; */
id|size
op_assign
id|sk-&gt;prot-&gt;max_header
op_plus
id|len
suffix:semicolon
id|skb
op_assign
id|sock_alloc_send_skb
c_func
(paren
id|sk
comma
id|size
comma
l_int|0
comma
op_amp
id|tmp
)paren
suffix:semicolon
r_if
c_cond
(paren
id|skb
op_eq
l_int|NULL
)paren
r_return
id|tmp
suffix:semicolon
id|skb-&gt;sk
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/* to avoid changing sk-&gt;saddr */
id|skb-&gt;free
op_assign
l_int|1
suffix:semicolon
id|skb-&gt;localroute
op_assign
id|sk-&gt;localroute
op_or
(paren
id|rt
op_amp
id|MSG_DONTROUTE
)paren
suffix:semicolon
multiline_comment|/*&n;&t; *&t;Now build the IP and MAC header. &n;&t; */
id|buff
op_assign
id|skb-&gt;data
suffix:semicolon
id|saddr
op_assign
id|sk-&gt;saddr
suffix:semicolon
id|dev
op_assign
l_int|NULL
suffix:semicolon
id|ttl
op_assign
id|sk-&gt;ip_ttl
suffix:semicolon
macro_line|#ifdef CONFIG_IP_MULTICAST
r_if
c_cond
(paren
id|MULTICAST
c_func
(paren
id|sin-&gt;sin_addr.s_addr
)paren
)paren
id|ttl
op_assign
id|sk-&gt;ip_mc_ttl
suffix:semicolon
macro_line|#endif
id|tmp
op_assign
id|sk-&gt;prot
op_member_access_from_pointer
id|build_header
c_func
(paren
id|skb
comma
id|saddr
comma
id|sin-&gt;sin_addr.s_addr
comma
op_amp
id|dev
comma
id|IPPROTO_UDP
comma
id|sk-&gt;opt
comma
id|skb-&gt;mem_len
comma
id|sk-&gt;ip_tos
comma
id|ttl
)paren
suffix:semicolon
id|skb-&gt;sk
op_assign
id|sk
suffix:semicolon
multiline_comment|/* So memory is freed correctly */
multiline_comment|/*&n;&t; *&t;Unable to put a header on the packet.&n;&t; */
r_if
c_cond
(paren
id|tmp
OL
l_int|0
)paren
(brace
id|sk-&gt;prot
op_member_access_from_pointer
id|wfree
c_func
(paren
id|sk
comma
id|skb-&gt;mem_addr
comma
id|skb-&gt;mem_len
)paren
suffix:semicolon
r_return
id|tmp
suffix:semicolon
)brace
id|buff
op_add_assign
id|tmp
suffix:semicolon
id|saddr
op_assign
id|skb-&gt;saddr
suffix:semicolon
multiline_comment|/*dev-&gt;pa_addr;*/
id|skb-&gt;len
op_assign
id|tmp
op_plus
r_sizeof
(paren
r_struct
id|udphdr
)paren
op_plus
id|len
suffix:semicolon
multiline_comment|/* len + UDP + IP + MAC */
id|skb-&gt;dev
op_assign
id|dev
suffix:semicolon
multiline_comment|/*&n;&t; *&t;Fill in the UDP header. &n;&t; */
id|uh
op_assign
(paren
r_struct
id|udphdr
op_star
)paren
id|buff
suffix:semicolon
id|uh-&gt;len
op_assign
id|htons
c_func
(paren
id|len
op_plus
r_sizeof
(paren
r_struct
id|udphdr
)paren
)paren
suffix:semicolon
id|uh-&gt;source
op_assign
id|sk-&gt;dummy_th.source
suffix:semicolon
id|uh-&gt;dest
op_assign
id|sin-&gt;sin_port
suffix:semicolon
id|buff
op_assign
(paren
r_int
r_char
op_star
)paren
(paren
id|uh
op_plus
l_int|1
)paren
suffix:semicolon
multiline_comment|/*&n;&t; *&t;Copy the user data. &n;&t; */
id|memcpy_fromfs
c_func
(paren
id|buff
comma
id|from
comma
id|len
)paren
suffix:semicolon
multiline_comment|/*&n;  &t; *&t;Set up the UDP checksum. &n;  &t; */
id|udp_send_check
c_func
(paren
id|uh
comma
id|saddr
comma
id|sin-&gt;sin_addr.s_addr
comma
id|skb-&gt;len
op_minus
id|tmp
comma
id|sk
)paren
suffix:semicolon
multiline_comment|/* &n;&t; *&t;Send the datagram to the interface. &n;&t; */
id|udp_statistics.UdpOutDatagrams
op_increment
suffix:semicolon
id|sk-&gt;prot
op_member_access_from_pointer
id|queue_xmit
c_func
(paren
id|sk
comma
id|dev
comma
id|skb
comma
l_int|1
)paren
suffix:semicolon
r_return
id|len
suffix:semicolon
)brace
DECL|function|udp_sendto
r_static
r_int
id|udp_sendto
c_func
(paren
r_struct
id|sock
op_star
id|sk
comma
r_int
r_char
op_star
id|from
comma
r_int
id|len
comma
r_int
id|noblock
comma
r_int
id|flags
comma
r_struct
id|sockaddr_in
op_star
id|usin
comma
r_int
id|addr_len
)paren
(brace
r_struct
id|sockaddr_in
id|sin
suffix:semicolon
r_int
id|tmp
suffix:semicolon
multiline_comment|/* &n;&t; *&t;Check the flags. We support no flags for UDP sending&n;&t; */
r_if
c_cond
(paren
id|flags
op_amp
op_complement
id|MSG_DONTROUTE
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
multiline_comment|/*&n;&t; *&t;Get and verify the address. &n;&t; */
r_if
c_cond
(paren
id|usin
)paren
(brace
r_if
c_cond
(paren
id|addr_len
OL
r_sizeof
(paren
id|sin
)paren
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|memcpy
c_func
(paren
op_amp
id|sin
comma
id|usin
comma
r_sizeof
(paren
id|sin
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sin.sin_family
op_logical_and
id|sin.sin_family
op_ne
id|AF_INET
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|sin.sin_port
op_eq
l_int|0
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|sk-&gt;state
op_ne
id|TCP_ESTABLISHED
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|sin.sin_family
op_assign
id|AF_INET
suffix:semicolon
id|sin.sin_port
op_assign
id|sk-&gt;dummy_th.dest
suffix:semicolon
id|sin.sin_addr.s_addr
op_assign
id|sk-&gt;daddr
suffix:semicolon
)brace
multiline_comment|/*&n;  &t; *&t;BSD socket semantics. You must set SO_BROADCAST to permit&n;  &t; *&t;broadcasting of data.&n;  &t; */
r_if
c_cond
(paren
id|sin.sin_addr.s_addr
op_eq
id|INADDR_ANY
)paren
(brace
id|sin.sin_addr.s_addr
op_assign
id|ip_my_addr
c_func
(paren
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|sk-&gt;broadcast
op_logical_and
id|ip_chk_addr
c_func
(paren
id|sin.sin_addr.s_addr
)paren
op_eq
id|IS_BROADCAST
)paren
(brace
r_return
op_minus
id|EACCES
suffix:semicolon
)brace
multiline_comment|/* Must turn broadcast on first */
id|sk-&gt;inuse
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* Send the packet. */
id|tmp
op_assign
id|udp_send
c_func
(paren
id|sk
comma
op_amp
id|sin
comma
id|from
comma
id|len
comma
id|flags
)paren
suffix:semicolon
multiline_comment|/* The datagram has been sent off.  Release the socket. */
id|release_sock
c_func
(paren
id|sk
)paren
suffix:semicolon
r_return
id|tmp
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;In BSD SOCK_DGRAM a write is just like a send.&n; */
DECL|function|udp_write
r_static
r_int
id|udp_write
c_func
(paren
r_struct
id|sock
op_star
id|sk
comma
r_int
r_char
op_star
id|buff
comma
r_int
id|len
comma
r_int
id|noblock
comma
r_int
id|flags
)paren
(brace
r_return
id|udp_sendto
c_func
(paren
id|sk
comma
id|buff
comma
id|len
comma
id|noblock
comma
id|flags
comma
l_int|NULL
comma
l_int|0
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;IOCTL requests applicable to the UDP protocol&n; */
DECL|function|udp_ioctl
r_int
id|udp_ioctl
c_func
(paren
r_struct
id|sock
op_star
id|sk
comma
r_int
id|cmd
comma
r_int
r_int
id|arg
)paren
(brace
r_int
id|err
suffix:semicolon
r_switch
c_cond
(paren
id|cmd
)paren
(brace
r_case
id|TIOCOUTQ
suffix:colon
(brace
r_int
r_int
id|amount
suffix:semicolon
r_if
c_cond
(paren
id|sk-&gt;state
op_eq
id|TCP_LISTEN
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|amount
op_assign
id|sk-&gt;prot
op_member_access_from_pointer
id|wspace
c_func
(paren
id|sk
)paren
multiline_comment|/*/2*/
suffix:semicolon
id|err
op_assign
id|verify_area
c_func
(paren
id|VERIFY_WRITE
comma
(paren
r_void
op_star
)paren
id|arg
comma
r_sizeof
(paren
r_int
r_int
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
(brace
r_return
id|err
suffix:semicolon
)brace
id|put_fs_long
c_func
(paren
id|amount
comma
(paren
r_int
r_int
op_star
)paren
id|arg
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_case
id|TIOCINQ
suffix:colon
(brace
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
r_int
r_int
id|amount
suffix:semicolon
r_if
c_cond
(paren
id|sk-&gt;state
op_eq
id|TCP_LISTEN
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|amount
op_assign
l_int|0
suffix:semicolon
id|skb
op_assign
id|skb_peek
c_func
(paren
op_amp
id|sk-&gt;receive_queue
)paren
suffix:semicolon
r_if
c_cond
(paren
id|skb
op_ne
l_int|NULL
)paren
(brace
multiline_comment|/*&n;&t;&t;&t;&t; * We will only return the amount&n;&t;&t;&t;&t; * of this packet since that is all&n;&t;&t;&t;&t; * that will be read.&n;&t;&t;&t;&t; */
id|amount
op_assign
id|skb-&gt;len
suffix:semicolon
)brace
id|err
op_assign
id|verify_area
c_func
(paren
id|VERIFY_WRITE
comma
(paren
r_void
op_star
)paren
id|arg
comma
r_sizeof
(paren
r_int
r_int
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
(brace
r_return
id|err
suffix:semicolon
)brace
id|put_fs_long
c_func
(paren
id|amount
comma
(paren
r_int
r_int
op_star
)paren
id|arg
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_default
suffix:colon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * &t;This should be easy, if there is something there we&bslash;&n; * &t;return it, otherwise we block.&n; */
DECL|function|udp_recvfrom
r_int
id|udp_recvfrom
c_func
(paren
r_struct
id|sock
op_star
id|sk
comma
r_int
r_char
op_star
id|to
comma
r_int
id|len
comma
r_int
id|noblock
comma
r_int
id|flags
comma
r_struct
id|sockaddr_in
op_star
id|sin
comma
r_int
op_star
id|addr_len
)paren
(brace
r_int
id|copied
op_assign
l_int|0
suffix:semicolon
r_int
id|truesize
suffix:semicolon
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
r_int
id|er
suffix:semicolon
multiline_comment|/*&n;&t; *&t;Check any passed addresses&n;&t; */
r_if
c_cond
(paren
id|addr_len
)paren
op_star
id|addr_len
op_assign
r_sizeof
(paren
op_star
id|sin
)paren
suffix:semicolon
multiline_comment|/*&n;&t; *&t;From here the generic datagram does a lot of the work. Come&n;&t; *&t;the finished NET3, it will do _ALL_ the work!&n;&t; */
id|skb
op_assign
id|skb_recv_datagram
c_func
(paren
id|sk
comma
id|flags
comma
id|noblock
comma
op_amp
id|er
)paren
suffix:semicolon
r_if
c_cond
(paren
id|skb
op_eq
l_int|NULL
)paren
(brace
r_return
id|er
suffix:semicolon
)brace
id|truesize
op_assign
id|skb-&gt;len
suffix:semicolon
id|copied
op_assign
id|min
c_func
(paren
id|len
comma
id|truesize
)paren
suffix:semicolon
multiline_comment|/*&n;  &t; *&t;FIXME : should use udp header size info value &n;  &t; */
id|skb_copy_datagram
c_func
(paren
id|skb
comma
r_sizeof
(paren
r_struct
id|udphdr
)paren
comma
id|to
comma
id|copied
)paren
suffix:semicolon
id|sk-&gt;stamp
op_assign
id|skb-&gt;stamp
suffix:semicolon
multiline_comment|/* Copy the address. */
r_if
c_cond
(paren
id|sin
)paren
(brace
id|sin-&gt;sin_family
op_assign
id|AF_INET
suffix:semicolon
id|sin-&gt;sin_port
op_assign
id|skb-&gt;h.uh-&gt;source
suffix:semicolon
id|sin-&gt;sin_addr.s_addr
op_assign
id|skb-&gt;daddr
suffix:semicolon
)brace
id|skb_free_datagram
c_func
(paren
id|skb
)paren
suffix:semicolon
id|release_sock
c_func
(paren
id|sk
)paren
suffix:semicolon
r_return
id|truesize
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;Read has the same semantics as recv in SOCK_DGRAM&n; */
DECL|function|udp_read
r_int
id|udp_read
c_func
(paren
r_struct
id|sock
op_star
id|sk
comma
r_int
r_char
op_star
id|buff
comma
r_int
id|len
comma
r_int
id|noblock
comma
r_int
id|flags
)paren
(brace
r_return
id|udp_recvfrom
c_func
(paren
id|sk
comma
id|buff
comma
id|len
comma
id|noblock
comma
id|flags
comma
l_int|NULL
comma
l_int|NULL
)paren
suffix:semicolon
)brace
DECL|function|udp_connect
r_int
id|udp_connect
c_func
(paren
r_struct
id|sock
op_star
id|sk
comma
r_struct
id|sockaddr_in
op_star
id|usin
comma
r_int
id|addr_len
)paren
(brace
r_if
c_cond
(paren
id|addr_len
OL
r_sizeof
(paren
op_star
id|usin
)paren
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|usin-&gt;sin_family
op_logical_and
id|usin-&gt;sin_family
op_ne
id|AF_INET
)paren
r_return
op_minus
id|EAFNOSUPPORT
suffix:semicolon
r_if
c_cond
(paren
id|usin-&gt;sin_addr.s_addr
op_eq
id|INADDR_ANY
)paren
id|usin-&gt;sin_addr.s_addr
op_assign
id|ip_my_addr
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|sk-&gt;broadcast
op_logical_and
id|ip_chk_addr
c_func
(paren
id|usin-&gt;sin_addr.s_addr
)paren
op_eq
id|IS_BROADCAST
)paren
(brace
r_return
op_minus
id|EACCES
suffix:semicolon
)brace
multiline_comment|/* Must turn broadcast on first */
id|sk-&gt;daddr
op_assign
id|usin-&gt;sin_addr.s_addr
suffix:semicolon
id|sk-&gt;dummy_th.dest
op_assign
id|usin-&gt;sin_port
suffix:semicolon
id|sk-&gt;state
op_assign
id|TCP_ESTABLISHED
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|udp_close
r_static
r_void
id|udp_close
c_func
(paren
r_struct
id|sock
op_star
id|sk
comma
r_int
id|timeout
)paren
(brace
id|sk-&gt;inuse
op_assign
l_int|1
suffix:semicolon
id|sk-&gt;state
op_assign
id|TCP_CLOSE
suffix:semicolon
r_if
c_cond
(paren
id|sk-&gt;dead
)paren
id|destroy_sock
c_func
(paren
id|sk
)paren
suffix:semicolon
r_else
id|release_sock
c_func
(paren
id|sk
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;All we need to do is get the socket, and then do a checksum. &n; */
DECL|function|udp_rcv
r_int
id|udp_rcv
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|device
op_star
id|dev
comma
r_struct
id|options
op_star
id|opt
comma
r_int
r_int
id|daddr
comma
r_int
r_int
id|len
comma
r_int
r_int
id|saddr
comma
r_int
id|redo
comma
r_struct
id|inet_protocol
op_star
id|protocol
)paren
(brace
r_struct
id|sock
op_star
id|sk
suffix:semicolon
r_struct
id|udphdr
op_star
id|uh
suffix:semicolon
r_int
r_int
id|ulen
suffix:semicolon
r_int
id|addr_type
op_assign
id|IS_MYADDR
suffix:semicolon
r_if
c_cond
(paren
id|skb-&gt;dev-&gt;pa_addr
op_ne
id|daddr
)paren
(brace
id|addr_type
op_assign
id|ip_chk_addr
c_func
(paren
id|daddr
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;&t; *&t;Get the header.&n;&t; */
id|uh
op_assign
(paren
r_struct
id|udphdr
op_star
)paren
id|skb-&gt;h.uh
suffix:semicolon
id|ip_statistics.IpInDelivers
op_increment
suffix:semicolon
multiline_comment|/*&n;&t; *&t;Validate the packet and the UDP length.&n;&t; */
id|ulen
op_assign
id|ntohs
c_func
(paren
id|uh-&gt;len
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ulen
OG
id|len
op_logical_or
id|len
OL
r_sizeof
(paren
op_star
id|uh
)paren
op_logical_or
id|ulen
OL
r_sizeof
(paren
op_star
id|uh
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;UDP: short packet: %d/%d&bslash;n&quot;
comma
id|ulen
comma
id|len
)paren
suffix:semicolon
id|udp_statistics.UdpInErrors
op_increment
suffix:semicolon
id|kfree_skb
c_func
(paren
id|skb
comma
id|FREE_WRITE
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|uh-&gt;check
op_logical_and
id|udp_check
c_func
(paren
id|uh
comma
id|len
comma
id|saddr
comma
id|daddr
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;UDP: bad checksum.&bslash;n&quot;
)paren
suffix:semicolon
id|udp_statistics.UdpInErrors
op_increment
suffix:semicolon
id|kfree_skb
c_func
(paren
id|skb
comma
id|FREE_WRITE
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|len
op_assign
id|ulen
suffix:semicolon
macro_line|#ifdef CONFIG_IP_MULTICAST
r_if
c_cond
(paren
id|addr_type
op_ne
id|IS_MYADDR
)paren
(brace
multiline_comment|/*&n;&t;&t; *&t;Multicasts and broadcasts go to each listener.&n;&t;&t; */
r_struct
id|sock
op_star
id|sknext
op_assign
l_int|NULL
suffix:semicolon
id|sk
op_assign
id|get_sock_mcast
c_func
(paren
id|udp_prot.sock_array
(braket
id|ntohs
c_func
(paren
id|uh-&gt;dest
)paren
op_amp
(paren
id|SOCK_ARRAY_SIZE
op_minus
l_int|1
)paren
)braket
comma
id|uh-&gt;dest
comma
id|saddr
comma
id|uh-&gt;source
comma
id|daddr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sk
)paren
(brace
r_do
(brace
r_struct
id|sk_buff
op_star
id|skb1
suffix:semicolon
id|sknext
op_assign
id|get_sock_mcast
c_func
(paren
id|sk-&gt;next
comma
id|uh-&gt;dest
comma
id|saddr
comma
id|uh-&gt;source
comma
id|daddr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sknext
)paren
(brace
id|skb1
op_assign
id|skb_clone
c_func
(paren
id|skb
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
)brace
r_else
id|skb1
op_assign
id|skb
suffix:semicolon
r_if
c_cond
(paren
id|skb1
)paren
(brace
id|udp_deliver
c_func
(paren
id|sk
comma
id|uh
comma
id|skb1
comma
id|skb-&gt;dev
comma
id|saddr
comma
id|daddr
comma
id|len
)paren
suffix:semicolon
)brace
id|sk
op_assign
id|sknext
suffix:semicolon
)brace
r_while
c_loop
(paren
id|sknext
op_ne
l_int|NULL
)paren
(brace
suffix:semicolon
)brace
)brace
r_else
id|kfree_skb
c_func
(paren
id|skb
comma
id|FREE_READ
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#endif
id|sk
op_assign
id|get_sock
c_func
(paren
op_amp
id|udp_prot
comma
id|uh-&gt;dest
comma
id|saddr
comma
id|uh-&gt;source
comma
id|daddr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sk
op_eq
l_int|NULL
)paren
(brace
id|udp_statistics.UdpNoPorts
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|addr_type
op_eq
id|IS_MYADDR
)paren
(brace
id|icmp_send
c_func
(paren
id|skb
comma
id|ICMP_DEST_UNREACH
comma
id|ICMP_PORT_UNREACH
comma
id|dev
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;&t;&t; * Hmm.  We got an UDP broadcast to a port to which we&n;&t;&t; * don&squot;t wanna listen.  Ignore it.&n;&t;&t; */
id|skb-&gt;sk
op_assign
l_int|NULL
suffix:semicolon
id|kfree_skb
c_func
(paren
id|skb
comma
id|FREE_WRITE
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_return
id|udp_deliver
c_func
(paren
id|sk
comma
id|uh
comma
id|skb
comma
id|skb-&gt;dev
comma
id|saddr
comma
id|daddr
comma
id|len
)paren
suffix:semicolon
)brace
DECL|function|udp_deliver
r_static
r_int
id|udp_deliver
c_func
(paren
r_struct
id|sock
op_star
id|sk
comma
r_struct
id|udphdr
op_star
id|uh
comma
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|device
op_star
id|dev
comma
r_int
id|saddr
comma
r_int
id|daddr
comma
r_int
id|len
)paren
(brace
id|skb-&gt;sk
op_assign
id|sk
suffix:semicolon
id|skb-&gt;dev
op_assign
id|dev
suffix:semicolon
id|skb-&gt;len
op_assign
id|len
suffix:semicolon
multiline_comment|/*&n;&t; *&t;These are supposed to be switched. &n;&t; */
id|skb-&gt;daddr
op_assign
id|saddr
suffix:semicolon
id|skb-&gt;saddr
op_assign
id|daddr
suffix:semicolon
multiline_comment|/*&n;&t; *&t;Charge it to the socket, dropping if the queue is full.&n;&t; */
id|skb-&gt;len
op_assign
id|len
op_minus
r_sizeof
(paren
op_star
id|uh
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sock_queue_rcv_skb
c_func
(paren
id|sk
comma
id|skb
)paren
OL
l_int|0
)paren
(brace
id|udp_statistics.UdpInErrors
op_increment
suffix:semicolon
id|ip_statistics.IpInDiscards
op_increment
suffix:semicolon
id|ip_statistics.IpInDelivers
op_decrement
suffix:semicolon
id|skb-&gt;sk
op_assign
l_int|NULL
suffix:semicolon
id|kfree_skb
c_func
(paren
id|skb
comma
id|FREE_WRITE
)paren
suffix:semicolon
id|release_sock
c_func
(paren
id|sk
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|udp_statistics.UdpInDatagrams
op_increment
suffix:semicolon
id|release_sock
c_func
(paren
id|sk
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|variable|udp_prot
r_struct
id|proto
id|udp_prot
op_assign
(brace
id|sock_wmalloc
comma
id|sock_rmalloc
comma
id|sock_wfree
comma
id|sock_rfree
comma
id|sock_rspace
comma
id|sock_wspace
comma
id|udp_close
comma
id|udp_read
comma
id|udp_write
comma
id|udp_sendto
comma
id|udp_recvfrom
comma
id|ip_build_header
comma
id|udp_connect
comma
l_int|NULL
comma
id|ip_queue_xmit
comma
id|ip_retransmit
comma
l_int|NULL
comma
l_int|NULL
comma
id|udp_rcv
comma
id|datagram_select
comma
id|udp_ioctl
comma
l_int|NULL
comma
l_int|NULL
comma
id|ip_setsockopt
comma
id|ip_getsockopt
comma
l_int|128
comma
l_int|0
comma
(brace
l_int|NULL
comma
)brace
comma
l_string|&quot;UDP&quot;
)brace
suffix:semicolon
eof
