multiline_comment|/* auto_irq.c: Auto-configure IRQ lines for linux. */
multiline_comment|/*&n;    Written 1993 by Donald Becker.&n;&n;    The Author may be reached as becker@super.org or&n;    C/O Supercomputing Research Ctr., 17100 Science Dr., Bowie MD 20715&n;&n;    This code is a general-purpose IRQ line detector for devices with&n;    jumpered IRQ lines.  If you can make the device raise an IRQ (and&n;    that IRQ line isn&squot;t already being used), these routines will tell&n;    you what IRQ line it&squot;s using -- perfect for those oh-so-cool boot-time&n;    device probes!&n;&n;    To use this, first call autoirq_setup(timeout). TIMEOUT is how many&n;    &squot;jiffies&squot; (1/18 sec.) to detect other devices that have active IRQ lines,&n;    and can usually be zero at boot.  &squot;autoirq_setup()&squot; returns the bit&n;    vector of nominally-available IRQ lines (lines may be physically in-use,&n;    but not yet registered to a device).&n;    Next, set up your device to trigger an interrupt.&n;    Finally call autoirq_report(TIMEOUT) to find out which IRQ line was&n;    most recently active.  The TIMEOUT should usually be zero, but may&n;    be set to the number of jiffies to wait for a slow device to raise an IRQ.&n;&n;    The idea of using the setup timeout to filter out bogus IRQs came from&n;    the serial driver.&n;*/
macro_line|#ifdef version
DECL|variable|version
r_static
r_char
op_star
id|version
op_assign
l_string|&quot;auto_irq.c:v0.02 1993 Donald Becker (becker@super.org)&quot;
suffix:semicolon
macro_line|#endif
multiline_comment|/*#include &lt;linux/config.h&gt;*/
multiline_comment|/*#include &lt;linux/kernel.h&gt;*/
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;asm/bitops.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &quot;dev.h&quot;
multiline_comment|/*#include &lt;asm/system.h&gt;*/
DECL|variable|irq2dev_map
r_struct
id|device
op_star
id|irq2dev_map
(braket
l_int|16
)braket
op_assign
(brace
l_int|0
comma
l_int|0
comma
multiline_comment|/* ... zeroed */
)brace
suffix:semicolon
DECL|variable|irqs_busy
r_int
id|irqs_busy
op_assign
l_int|0x01
suffix:semicolon
multiline_comment|/* The set of fixed IRQs always enabled */
DECL|variable|irqs_used
r_int
id|irqs_used
op_assign
l_int|0x01
suffix:semicolon
multiline_comment|/* The set of fixed IRQs sometimes enabled. */
DECL|variable|irqs_reserved
r_int
id|irqs_reserved
op_assign
l_int|0x00
suffix:semicolon
multiline_comment|/* An advisory &quot;reserved&quot; table. */
DECL|variable|irqs_shared
r_int
id|irqs_shared
op_assign
l_int|0x00
suffix:semicolon
multiline_comment|/* IRQ lines &quot;shared&quot; among conforming cards.*/
DECL|variable|irq_number
r_static
r_volatile
r_int
id|irq_number
suffix:semicolon
multiline_comment|/* The latest irq number we actually found. */
DECL|variable|irq_bitmap
r_static
r_volatile
r_int
id|irq_bitmap
suffix:semicolon
multiline_comment|/* The irqs we actually found. */
DECL|variable|irq_handled
r_static
r_int
id|irq_handled
suffix:semicolon
multiline_comment|/* The irq lines we have a handler on. */
DECL|function|autoirq_probe
r_static
r_void
id|autoirq_probe
c_func
(paren
r_int
id|irq
)paren
(brace
id|irq_number
op_assign
id|irq
suffix:semicolon
id|set_bit
c_func
(paren
id|irq
comma
(paren
r_void
op_star
)paren
op_amp
id|irq_bitmap
)paren
suffix:semicolon
multiline_comment|/* irq_bitmap |= 1 &lt;&lt; irq; */
r_return
suffix:semicolon
)brace
DECL|variable|autoirq_sigaction
r_struct
id|sigaction
id|autoirq_sigaction
op_assign
(brace
id|autoirq_probe
comma
l_int|0
comma
id|SA_INTERRUPT
comma
l_int|NULL
)brace
suffix:semicolon
DECL|function|autoirq_setup
r_int
id|autoirq_setup
c_func
(paren
r_int
id|waittime
)paren
(brace
r_int
id|i
comma
id|mask
suffix:semicolon
r_int
id|timeout
op_assign
id|jiffies
op_plus
id|waittime
suffix:semicolon
id|irq_number
op_assign
l_int|0
suffix:semicolon
id|irq_bitmap
op_assign
l_int|0
suffix:semicolon
id|irq_handled
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|16
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|irqaction
c_func
(paren
id|i
comma
op_amp
id|autoirq_sigaction
)paren
)paren
id|set_bit
c_func
(paren
id|i
comma
(paren
r_void
op_star
)paren
op_amp
id|irq_handled
)paren
suffix:semicolon
multiline_comment|/* irq_handled |= 1 &lt;&lt; i;*/
)brace
multiline_comment|/* Update our USED lists. */
id|irqs_used
op_or_assign
op_complement
id|irq_handled
suffix:semicolon
multiline_comment|/* Hang out at least &lt;waittime&gt; jiffies waiting for bogus IRQ hits. */
r_while
c_loop
(paren
id|timeout
op_ge
id|jiffies
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
comma
id|mask
op_assign
l_int|0x01
suffix:semicolon
id|i
OL
l_int|16
suffix:semicolon
id|i
op_increment
comma
id|mask
op_lshift_assign
l_int|1
)paren
(brace
r_if
c_cond
(paren
id|irq_bitmap
op_amp
id|irq_handled
op_amp
id|mask
)paren
(brace
id|irq_handled
op_and_assign
op_complement
id|mask
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot; Spurious interrupt on IRQ %d&bslash;n&quot;
comma
id|i
)paren
suffix:semicolon
id|free_irq
c_func
(paren
id|i
)paren
suffix:semicolon
)brace
)brace
r_return
id|irq_handled
suffix:semicolon
)brace
DECL|function|autoirq_report
r_int
id|autoirq_report
c_func
(paren
r_int
id|waittime
)paren
(brace
r_int
id|i
suffix:semicolon
r_int
id|timeout
op_assign
id|jiffies
op_plus
id|waittime
suffix:semicolon
multiline_comment|/* Hang out at least &lt;waittime&gt; jiffies waiting for the IRQ. */
r_while
c_loop
(paren
id|timeout
op_ge
id|jiffies
)paren
r_if
c_cond
(paren
id|irq_number
)paren
r_break
suffix:semicolon
multiline_comment|/* Retract the irq handlers that we installed. */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|16
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|test_bit
c_func
(paren
id|i
comma
(paren
r_void
op_star
)paren
op_amp
id|irq_handled
)paren
)paren
id|free_irq
c_func
(paren
id|i
)paren
suffix:semicolon
)brace
r_return
id|irq_number
suffix:semicolon
)brace
"&f;"
multiline_comment|/*&n; * Local variables:&n; *  compile-command: &quot;gcc -DKERNEL -Wall -O6 -fomit-frame-pointer -I/usr/src/linux/net/tcp -c auto_irq.c&quot;&n; *  version-control: t&n; *  kept-new-versions: 5&n; * End:&n; */
eof
