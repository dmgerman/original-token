multiline_comment|/*&n; * INET&t;&t;An implementation of the TCP/IP protocol suite for the LINUX&n; *&t;&t;operating system.  INET is implemented using the  BSD Socket&n; *&t;&t;interface as the means of communication with the user level.&n; *&n; *&t;&t;Internet Control Message Protocol (ICMP)&n; *&n; * Version:&t;@(#)icmp.c&t;1.0.11&t;06/02/93&n; *&n; * Authors:&t;Ross Biro, &lt;bir7@leland.Stanford.Edu&gt;&n; *&t;&t;Fred N. van Kempen, &lt;waltje@uWalt.NL.Mugnet.ORG&gt;&n; *&t;&t;Mark Evans, &lt;evansmp@uhura.aston.ac.uk&gt;&n; *&n; * Fixes:&t;&n; *&t;&t;Alan Cox&t;:&t;Generic queue usage.&n; *&t;&t;Gerhard Koerting:&t;ICMP addressing corrected&n; *&n; *&n; *&t;&t;This program is free software; you can redistribute it and/or&n; *&t;&t;modify it under the terms of the GNU General Public License&n; *&t;&t;as published by the Free Software Foundation; either version&n; *&t;&t;2 of the License, or (at your option) any later version.&n; */
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/fcntl.h&gt;
macro_line|#include &lt;linux/socket.h&gt;
macro_line|#include &lt;linux/in.h&gt;
macro_line|#include &quot;inet.h&quot;
macro_line|#include &quot;dev.h&quot;
macro_line|#include &quot;ip.h&quot;
macro_line|#include &quot;route.h&quot;
macro_line|#include &quot;protocol.h&quot;
macro_line|#include &quot;icmp.h&quot;
macro_line|#include &quot;tcp.h&quot;
macro_line|#include &quot;skbuff.h&quot;
macro_line|#include &quot;sock.h&quot;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/timer.h&gt;
macro_line|#include &lt;asm/system.h&gt;
macro_line|#include &lt;asm/segment.h&gt;
DECL|macro|min
mdefine_line|#define min(a,b)&t;((a)&lt;(b)?(a):(b))
multiline_comment|/* An array of errno for error messages from dest unreach. */
DECL|variable|icmp_err_convert
r_struct
id|icmp_err
id|icmp_err_convert
(braket
)braket
op_assign
(brace
(brace
id|ENETUNREACH
comma
l_int|1
)brace
comma
multiline_comment|/*&t;ICMP_NET_UNREACH&t;*/
(brace
id|EHOSTUNREACH
comma
l_int|1
)brace
comma
multiline_comment|/*&t;ICMP_HOST_UNREACH&t;*/
(brace
id|ENOPROTOOPT
comma
l_int|1
)brace
comma
multiline_comment|/*&t;ICMP_PROT_UNREACH&t;*/
(brace
id|ECONNREFUSED
comma
l_int|1
)brace
comma
multiline_comment|/*&t;ICMP_PORT_UNREACH&t;*/
(brace
id|EOPNOTSUPP
comma
l_int|0
)brace
comma
multiline_comment|/*&t;ICMP_FRAG_NEEDED&t;*/
(brace
id|EOPNOTSUPP
comma
l_int|0
)brace
comma
multiline_comment|/*&t;ICMP_SR_FAILED&t;&t;*/
(brace
id|ENETUNREACH
comma
l_int|1
)brace
comma
multiline_comment|/* &t;ICMP_NET_UNKNOWN&t;*/
(brace
id|EHOSTDOWN
comma
l_int|1
)brace
comma
multiline_comment|/*&t;ICMP_HOST_UNKNOWN&t;*/
(brace
id|ENONET
comma
l_int|1
)brace
comma
multiline_comment|/*&t;ICMP_HOST_ISOLATED&t;*/
(brace
id|ENETUNREACH
comma
l_int|1
)brace
comma
multiline_comment|/*&t;ICMP_NET_ANO&t;&t;*/
(brace
id|EHOSTUNREACH
comma
l_int|1
)brace
comma
multiline_comment|/*&t;ICMP_HOST_ANO&t;&t;*/
(brace
id|EOPNOTSUPP
comma
l_int|0
)brace
comma
multiline_comment|/*&t;ICMP_NET_UNR_TOS&t;*/
(brace
id|EOPNOTSUPP
comma
l_int|0
)brace
multiline_comment|/*&t;ICMP_HOST_UNR_TOS&t;*/
)brace
suffix:semicolon
multiline_comment|/* Display the contents of an ICMP header. */
r_static
r_void
DECL|function|print_icmp
id|print_icmp
c_func
(paren
r_struct
id|icmphdr
op_star
id|icmph
)paren
(brace
r_if
c_cond
(paren
id|inet_debug
op_ne
id|DBG_ICMP
)paren
r_return
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;ICMP: type = %d, code = %d, checksum = %X&bslash;n&quot;
comma
id|icmph-&gt;type
comma
id|icmph-&gt;code
comma
id|icmph-&gt;checksum
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;      gateway = %s&bslash;n&quot;
comma
id|in_ntoa
c_func
(paren
id|icmph-&gt;un.gateway
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/* Send an ICMP message. */
r_void
DECL|function|icmp_send
id|icmp_send
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb_in
comma
r_int
id|type
comma
r_int
id|code
comma
r_struct
id|device
op_star
id|dev
)paren
(brace
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
r_struct
id|iphdr
op_star
id|iph
suffix:semicolon
r_int
id|offset
suffix:semicolon
r_struct
id|icmphdr
op_star
id|icmph
suffix:semicolon
r_int
id|len
suffix:semicolon
id|DPRINTF
c_func
(paren
(paren
id|DBG_ICMP
comma
l_string|&quot;icmp_send(skb_in = %X, type = %d, code = %d, dev=%X)&bslash;n&quot;
comma
id|skb_in
comma
id|type
comma
id|code
comma
id|dev
)paren
)paren
suffix:semicolon
multiline_comment|/* Get some memory for the reply. */
id|len
op_assign
r_sizeof
(paren
r_struct
id|sk_buff
)paren
op_plus
id|dev-&gt;hard_header_len
op_plus
r_sizeof
(paren
r_struct
id|iphdr
)paren
op_plus
r_sizeof
(paren
r_struct
id|icmphdr
)paren
op_plus
r_sizeof
(paren
r_struct
id|iphdr
)paren
op_plus
l_int|8
suffix:semicolon
multiline_comment|/* amount of header to return */
id|skb
op_assign
(paren
r_struct
id|sk_buff
op_star
)paren
id|alloc_skb
c_func
(paren
id|len
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
id|skb
op_eq
l_int|NULL
)paren
r_return
suffix:semicolon
id|skb-&gt;sk
op_assign
l_int|NULL
suffix:semicolon
id|skb-&gt;mem_addr
op_assign
id|skb
suffix:semicolon
id|skb-&gt;mem_len
op_assign
id|len
suffix:semicolon
id|len
op_sub_assign
r_sizeof
(paren
r_struct
id|sk_buff
)paren
suffix:semicolon
multiline_comment|/* Find the IP header. */
id|iph
op_assign
(paren
r_struct
id|iphdr
op_star
)paren
(paren
id|skb_in
op_plus
l_int|1
)paren
suffix:semicolon
id|iph
op_assign
(paren
r_struct
id|iphdr
op_star
)paren
(paren
(paren
r_int
r_char
op_star
)paren
id|iph
op_plus
id|dev-&gt;hard_header_len
)paren
suffix:semicolon
multiline_comment|/* Build Layer 2-3 headers for message back to source. */
id|offset
op_assign
id|ip_build_header
c_func
(paren
id|skb
comma
id|dev-&gt;pa_addr
comma
id|iph-&gt;saddr
comma
op_amp
id|dev
comma
id|IPPROTO_ICMP
comma
l_int|NULL
comma
id|len
)paren
suffix:semicolon
r_if
c_cond
(paren
id|offset
OL
l_int|0
)paren
(brace
id|skb-&gt;sk
op_assign
l_int|NULL
suffix:semicolon
id|kfree_skb
c_func
(paren
id|skb
comma
id|FREE_READ
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/* Re-adjust length according to actual IP header size. */
id|skb-&gt;len
op_assign
id|offset
op_plus
r_sizeof
(paren
r_struct
id|icmphdr
)paren
op_plus
r_sizeof
(paren
r_struct
id|iphdr
)paren
op_plus
l_int|8
suffix:semicolon
id|icmph
op_assign
(paren
r_struct
id|icmphdr
op_star
)paren
(paren
(paren
r_int
r_char
op_star
)paren
(paren
id|skb
op_plus
l_int|1
)paren
op_plus
id|offset
)paren
suffix:semicolon
id|icmph-&gt;type
op_assign
id|type
suffix:semicolon
id|icmph-&gt;code
op_assign
id|code
suffix:semicolon
id|icmph-&gt;checksum
op_assign
l_int|0
suffix:semicolon
id|icmph-&gt;un.gateway
op_assign
l_int|0
suffix:semicolon
id|memcpy
c_func
(paren
id|icmph
op_plus
l_int|1
comma
id|iph
comma
r_sizeof
(paren
r_struct
id|iphdr
)paren
op_plus
l_int|8
)paren
suffix:semicolon
id|icmph-&gt;checksum
op_assign
id|ip_compute_csum
c_func
(paren
(paren
r_int
r_char
op_star
)paren
id|icmph
comma
r_sizeof
(paren
r_struct
id|icmphdr
)paren
op_plus
r_sizeof
(paren
r_struct
id|iphdr
)paren
op_plus
l_int|8
)paren
suffix:semicolon
id|DPRINTF
c_func
(paren
(paren
id|DBG_ICMP
comma
l_string|&quot;&gt;&gt;&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|print_icmp
c_func
(paren
id|icmph
)paren
suffix:semicolon
multiline_comment|/* Send it and free it. */
id|ip_queue_xmit
c_func
(paren
l_int|NULL
comma
id|dev
comma
id|skb
comma
l_int|1
)paren
suffix:semicolon
)brace
multiline_comment|/* Handle ICMP_UNREACH and ICMP_QUENCH. */
r_static
r_void
DECL|function|icmp_unreach
id|icmp_unreach
c_func
(paren
r_struct
id|icmphdr
op_star
id|icmph
comma
r_struct
id|sk_buff
op_star
id|skb
)paren
(brace
r_struct
id|inet_protocol
op_star
id|ipprot
suffix:semicolon
r_struct
id|iphdr
op_star
id|iph
suffix:semicolon
r_int
r_char
id|hash
suffix:semicolon
r_int
id|err
suffix:semicolon
id|err
op_assign
(paren
id|icmph-&gt;type
op_lshift
l_int|8
)paren
op_or
id|icmph-&gt;code
suffix:semicolon
id|iph
op_assign
(paren
r_struct
id|iphdr
op_star
)paren
(paren
id|icmph
op_plus
l_int|1
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|icmph-&gt;code
op_amp
l_int|7
)paren
(brace
r_case
id|ICMP_NET_UNREACH
suffix:colon
id|DPRINTF
c_func
(paren
(paren
id|DBG_ICMP
comma
l_string|&quot;ICMP: %s: network unreachable.&bslash;n&quot;
comma
id|in_ntoa
c_func
(paren
id|iph-&gt;daddr
)paren
)paren
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ICMP_HOST_UNREACH
suffix:colon
id|DPRINTF
c_func
(paren
(paren
id|DBG_ICMP
comma
l_string|&quot;ICMP: %s: host unreachable.&bslash;n&quot;
comma
id|in_ntoa
c_func
(paren
id|iph-&gt;daddr
)paren
)paren
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ICMP_PROT_UNREACH
suffix:colon
id|printk
c_func
(paren
l_string|&quot;ICMP: %s:%d: protocol unreachable.&bslash;n&quot;
comma
id|in_ntoa
c_func
(paren
id|iph-&gt;daddr
)paren
comma
id|ntohs
c_func
(paren
id|iph-&gt;protocol
)paren
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ICMP_PORT_UNREACH
suffix:colon
id|DPRINTF
c_func
(paren
(paren
id|DBG_ICMP
comma
l_string|&quot;ICMP: %s:%d: port unreachable.&bslash;n&quot;
comma
id|in_ntoa
c_func
(paren
id|iph-&gt;daddr
)paren
comma
op_minus
l_int|1
multiline_comment|/* FIXME: ntohs(iph-&gt;port) */
)paren
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ICMP_FRAG_NEEDED
suffix:colon
id|printk
c_func
(paren
l_string|&quot;ICMP: %s: fragmentation needed and DF set.&bslash;n&quot;
comma
id|in_ntoa
c_func
(paren
id|iph-&gt;daddr
)paren
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ICMP_SR_FAILED
suffix:colon
id|printk
c_func
(paren
l_string|&quot;ICMP: %s: Source Route Failed.&bslash;n&quot;
comma
id|in_ntoa
c_func
(paren
id|iph-&gt;daddr
)paren
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|DPRINTF
c_func
(paren
(paren
id|DBG_ICMP
comma
l_string|&quot;ICMP: Unreachable: CODE=%d from %s&bslash;n&quot;
comma
(paren
id|icmph-&gt;code
op_amp
l_int|7
)paren
comma
id|in_ntoa
c_func
(paren
id|iph-&gt;daddr
)paren
)paren
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
multiline_comment|/* Get the protocol(s). */
id|hash
op_assign
id|iph-&gt;protocol
op_amp
(paren
id|MAX_INET_PROTOS
op_minus
l_int|1
)paren
suffix:semicolon
multiline_comment|/* This can change while we are doing it. */
id|ipprot
op_assign
(paren
r_struct
id|inet_protocol
op_star
)paren
id|inet_protos
(braket
id|hash
)braket
suffix:semicolon
r_while
c_loop
(paren
id|ipprot
op_ne
l_int|NULL
)paren
(brace
r_struct
id|inet_protocol
op_star
id|nextip
suffix:semicolon
id|nextip
op_assign
(paren
r_struct
id|inet_protocol
op_star
)paren
id|ipprot-&gt;next
suffix:semicolon
multiline_comment|/* Pass it off to everyone who wants it. */
r_if
c_cond
(paren
id|iph-&gt;protocol
op_eq
id|ipprot-&gt;protocol
op_logical_and
id|ipprot-&gt;err_handler
)paren
(brace
id|ipprot
op_member_access_from_pointer
id|err_handler
c_func
(paren
id|err
comma
(paren
r_int
r_char
op_star
)paren
(paren
id|icmph
op_plus
l_int|1
)paren
comma
id|iph-&gt;daddr
comma
id|iph-&gt;saddr
comma
id|ipprot
)paren
suffix:semicolon
)brace
id|ipprot
op_assign
id|nextip
suffix:semicolon
)brace
id|skb-&gt;sk
op_assign
l_int|NULL
suffix:semicolon
id|kfree_skb
c_func
(paren
id|skb
comma
id|FREE_READ
)paren
suffix:semicolon
)brace
multiline_comment|/* Handle ICMP_REDIRECT. */
r_static
r_void
DECL|function|icmp_redirect
id|icmp_redirect
c_func
(paren
r_struct
id|icmphdr
op_star
id|icmph
comma
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|device
op_star
id|dev
)paren
(brace
r_struct
id|iphdr
op_star
id|iph
suffix:semicolon
r_int
r_int
id|ip
suffix:semicolon
id|iph
op_assign
(paren
r_struct
id|iphdr
op_star
)paren
(paren
id|icmph
op_plus
l_int|1
)paren
suffix:semicolon
id|ip
op_assign
id|iph-&gt;daddr
suffix:semicolon
r_switch
c_cond
(paren
id|icmph-&gt;code
op_amp
l_int|7
)paren
(brace
r_case
id|ICMP_REDIR_NET
suffix:colon
id|rt_add
c_func
(paren
(paren
id|RTF_DYNAMIC
op_or
id|RTF_MODIFIED
op_or
id|RTF_GATEWAY
)paren
comma
id|ip
comma
l_int|0
comma
id|icmph-&gt;un.gateway
comma
id|dev
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ICMP_REDIR_HOST
suffix:colon
id|rt_add
c_func
(paren
(paren
id|RTF_DYNAMIC
op_or
id|RTF_MODIFIED
op_or
id|RTF_HOST
op_or
id|RTF_GATEWAY
)paren
comma
id|ip
comma
l_int|0
comma
id|icmph-&gt;un.gateway
comma
id|dev
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ICMP_REDIR_NETTOS
suffix:colon
r_case
id|ICMP_REDIR_HOSTTOS
suffix:colon
id|printk
c_func
(paren
l_string|&quot;ICMP: cannot handle TOS redirects yet!&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|DPRINTF
c_func
(paren
(paren
id|DBG_ICMP
comma
l_string|&quot;ICMP: Unreach: CODE=%d&bslash;n&quot;
comma
(paren
id|icmph-&gt;code
op_amp
l_int|7
)paren
)paren
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|skb-&gt;sk
op_assign
l_int|NULL
suffix:semicolon
id|kfree_skb
c_func
(paren
id|skb
comma
id|FREE_READ
)paren
suffix:semicolon
)brace
multiline_comment|/* Handle ICMP_ECHO (&quot;ping&quot;) requests. */
r_static
r_void
DECL|function|icmp_echo
id|icmp_echo
c_func
(paren
r_struct
id|icmphdr
op_star
id|icmph
comma
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|device
op_star
id|dev
comma
r_int
r_int
id|saddr
comma
r_int
r_int
id|daddr
comma
r_int
id|len
comma
r_struct
id|options
op_star
id|opt
)paren
(brace
r_struct
id|icmphdr
op_star
id|icmphr
suffix:semicolon
r_struct
id|sk_buff
op_star
id|skb2
suffix:semicolon
r_int
id|size
comma
id|offset
suffix:semicolon
id|size
op_assign
r_sizeof
(paren
r_struct
id|sk_buff
)paren
op_plus
id|dev-&gt;hard_header_len
op_plus
l_int|64
op_plus
id|len
suffix:semicolon
id|skb2
op_assign
id|alloc_skb
c_func
(paren
id|size
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
id|skb2
op_eq
l_int|NULL
)paren
(brace
id|skb-&gt;sk
op_assign
l_int|NULL
suffix:semicolon
id|kfree_skb
c_func
(paren
id|skb
comma
id|FREE_READ
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|skb2-&gt;sk
op_assign
l_int|NULL
suffix:semicolon
id|skb2-&gt;mem_addr
op_assign
id|skb2
suffix:semicolon
id|skb2-&gt;mem_len
op_assign
id|size
suffix:semicolon
id|skb2-&gt;free
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* Build Layer 2-3 headers for message back to source */
id|offset
op_assign
id|ip_build_header
c_func
(paren
id|skb2
comma
id|daddr
comma
id|saddr
comma
op_amp
id|dev
comma
id|IPPROTO_ICMP
comma
id|opt
comma
id|len
)paren
suffix:semicolon
r_if
c_cond
(paren
id|offset
OL
l_int|0
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;ICMP: Could not build IP Header for ICMP ECHO Response&bslash;n&quot;
)paren
suffix:semicolon
id|kfree_skb
c_func
(paren
id|skb2
comma
id|FREE_WRITE
)paren
suffix:semicolon
id|skb-&gt;sk
op_assign
l_int|NULL
suffix:semicolon
id|kfree_skb
c_func
(paren
id|skb
comma
id|FREE_READ
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/* Re-adjust length according to actual IP header size. */
id|skb2-&gt;len
op_assign
id|offset
op_plus
id|len
suffix:semicolon
multiline_comment|/* Build ICMP_ECHO Response message. */
id|icmphr
op_assign
(paren
r_struct
id|icmphdr
op_star
)paren
(paren
(paren
r_char
op_star
)paren
(paren
id|skb2
op_plus
l_int|1
)paren
op_plus
id|offset
)paren
suffix:semicolon
id|memcpy
c_func
(paren
(paren
r_char
op_star
)paren
id|icmphr
comma
(paren
r_char
op_star
)paren
id|icmph
comma
id|len
)paren
suffix:semicolon
id|icmphr-&gt;type
op_assign
id|ICMP_ECHOREPLY
suffix:semicolon
id|icmphr-&gt;code
op_assign
l_int|0
suffix:semicolon
id|icmphr-&gt;checksum
op_assign
l_int|0
suffix:semicolon
id|icmphr-&gt;checksum
op_assign
id|ip_compute_csum
c_func
(paren
(paren
r_int
r_char
op_star
)paren
id|icmphr
comma
id|len
)paren
suffix:semicolon
multiline_comment|/* Ship it out - free it when done */
id|ip_queue_xmit
c_func
(paren
(paren
r_struct
id|sock
op_star
)paren
l_int|NULL
comma
id|dev
comma
id|skb2
comma
l_int|1
)paren
suffix:semicolon
id|skb-&gt;sk
op_assign
l_int|NULL
suffix:semicolon
id|kfree_skb
c_func
(paren
id|skb
comma
id|FREE_READ
)paren
suffix:semicolon
)brace
multiline_comment|/* Handle the ICMP INFORMATION REQUEST. */
r_static
r_void
DECL|function|icmp_info
id|icmp_info
c_func
(paren
r_struct
id|icmphdr
op_star
id|icmph
comma
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|device
op_star
id|dev
comma
r_int
r_int
id|saddr
comma
r_int
r_int
id|daddr
comma
r_int
id|len
comma
r_struct
id|options
op_star
id|opt
)paren
(brace
multiline_comment|/* NOT YET */
id|skb-&gt;sk
op_assign
l_int|NULL
suffix:semicolon
id|kfree_skb
c_func
(paren
id|skb
comma
id|FREE_READ
)paren
suffix:semicolon
)brace
multiline_comment|/* Handle ICMP_ADRESS_MASK requests. */
r_static
r_void
DECL|function|icmp_address
id|icmp_address
c_func
(paren
r_struct
id|icmphdr
op_star
id|icmph
comma
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|device
op_star
id|dev
comma
r_int
r_int
id|saddr
comma
r_int
r_int
id|daddr
comma
r_int
id|len
comma
r_struct
id|options
op_star
id|opt
)paren
(brace
r_struct
id|icmphdr
op_star
id|icmphr
suffix:semicolon
r_struct
id|sk_buff
op_star
id|skb2
suffix:semicolon
r_int
id|size
comma
id|offset
suffix:semicolon
id|size
op_assign
r_sizeof
(paren
r_struct
id|sk_buff
)paren
op_plus
id|dev-&gt;hard_header_len
op_plus
l_int|64
op_plus
id|len
suffix:semicolon
id|skb2
op_assign
id|alloc_skb
c_func
(paren
id|size
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
id|skb2
op_eq
l_int|NULL
)paren
(brace
id|skb-&gt;sk
op_assign
l_int|NULL
suffix:semicolon
id|kfree_skb
c_func
(paren
id|skb
comma
id|FREE_READ
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|skb2-&gt;sk
op_assign
l_int|NULL
suffix:semicolon
id|skb2-&gt;mem_addr
op_assign
id|skb2
suffix:semicolon
id|skb2-&gt;mem_len
op_assign
id|size
suffix:semicolon
id|skb2-&gt;free
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* Build Layer 2-3 headers for message back to source */
id|offset
op_assign
id|ip_build_header
c_func
(paren
id|skb2
comma
id|daddr
comma
id|saddr
comma
op_amp
id|dev
comma
id|IPPROTO_ICMP
comma
id|opt
comma
id|len
)paren
suffix:semicolon
r_if
c_cond
(paren
id|offset
OL
l_int|0
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;ICMP: Could not build IP Header for ICMP ADDRESS Response&bslash;n&quot;
)paren
suffix:semicolon
id|kfree_skb
c_func
(paren
id|skb2
comma
id|FREE_WRITE
)paren
suffix:semicolon
id|skb-&gt;sk
op_assign
l_int|NULL
suffix:semicolon
id|kfree_skb
c_func
(paren
id|skb
comma
id|FREE_READ
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/* Re-adjust length according to actual IP header size. */
id|skb2-&gt;len
op_assign
id|offset
op_plus
id|len
suffix:semicolon
multiline_comment|/* Build ICMP ADDRESS MASK Response message. */
id|icmphr
op_assign
(paren
r_struct
id|icmphdr
op_star
)paren
(paren
(paren
r_char
op_star
)paren
(paren
id|skb2
op_plus
l_int|1
)paren
op_plus
id|offset
)paren
suffix:semicolon
id|icmphr-&gt;type
op_assign
id|ICMP_ADDRESSREPLY
suffix:semicolon
id|icmphr-&gt;code
op_assign
l_int|0
suffix:semicolon
id|icmphr-&gt;checksum
op_assign
l_int|0
suffix:semicolon
id|icmphr-&gt;un.echo.id
op_assign
id|icmph-&gt;un.echo.id
suffix:semicolon
id|icmphr-&gt;un.echo.sequence
op_assign
id|icmph-&gt;un.echo.sequence
suffix:semicolon
id|memcpy
c_func
(paren
(paren
r_char
op_star
)paren
(paren
id|icmphr
op_plus
l_int|1
)paren
comma
(paren
r_char
op_star
)paren
op_amp
id|dev-&gt;pa_mask
comma
r_sizeof
(paren
id|dev-&gt;pa_mask
)paren
)paren
suffix:semicolon
id|icmphr-&gt;checksum
op_assign
id|ip_compute_csum
c_func
(paren
(paren
r_int
r_char
op_star
)paren
id|icmphr
comma
id|len
)paren
suffix:semicolon
multiline_comment|/* Ship it out - free it when done */
id|ip_queue_xmit
c_func
(paren
(paren
r_struct
id|sock
op_star
)paren
l_int|NULL
comma
id|dev
comma
id|skb2
comma
l_int|1
)paren
suffix:semicolon
id|skb-&gt;sk
op_assign
l_int|NULL
suffix:semicolon
id|kfree_skb
c_func
(paren
id|skb
comma
id|FREE_READ
)paren
suffix:semicolon
)brace
multiline_comment|/* Deal with incoming ICMP packets. */
r_int
DECL|function|icmp_rcv
id|icmp_rcv
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb1
comma
r_struct
id|device
op_star
id|dev
comma
r_struct
id|options
op_star
id|opt
comma
r_int
r_int
id|daddr
comma
r_int
r_int
id|len
comma
r_int
r_int
id|saddr
comma
r_int
id|redo
comma
r_struct
id|inet_protocol
op_star
id|protocol
)paren
(brace
r_struct
id|icmphdr
op_star
id|icmph
suffix:semicolon
r_int
r_char
op_star
id|buff
suffix:semicolon
multiline_comment|/* Drop broadcast packets. */
r_if
c_cond
(paren
id|chk_addr
c_func
(paren
id|daddr
)paren
op_eq
id|IS_BROADCAST
)paren
(brace
id|DPRINTF
c_func
(paren
(paren
id|DBG_ICMP
comma
l_string|&quot;ICMP: Discarded broadcast from %s&bslash;n&quot;
comma
id|in_ntoa
c_func
(paren
id|saddr
)paren
)paren
)paren
suffix:semicolon
id|skb1-&gt;sk
op_assign
l_int|NULL
suffix:semicolon
id|kfree_skb
c_func
(paren
id|skb1
comma
id|FREE_READ
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|buff
op_assign
id|skb1-&gt;h.raw
suffix:semicolon
id|icmph
op_assign
(paren
r_struct
id|icmphdr
op_star
)paren
id|buff
suffix:semicolon
multiline_comment|/* Validate the packet first */
r_if
c_cond
(paren
id|ip_compute_csum
c_func
(paren
(paren
r_int
r_char
op_star
)paren
id|icmph
comma
id|len
)paren
)paren
(brace
multiline_comment|/* Failed checksum! */
id|printk
c_func
(paren
l_string|&quot;ICMP: failed checksum from %s!&bslash;n&quot;
comma
id|in_ntoa
c_func
(paren
id|saddr
)paren
)paren
suffix:semicolon
id|skb1-&gt;sk
op_assign
l_int|NULL
suffix:semicolon
id|kfree_skb
c_func
(paren
id|skb1
comma
id|FREE_READ
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|print_icmp
c_func
(paren
id|icmph
)paren
suffix:semicolon
multiline_comment|/* Parse the ICMP message */
r_switch
c_cond
(paren
id|icmph-&gt;type
)paren
(brace
r_case
id|ICMP_TIME_EXCEEDED
suffix:colon
r_case
id|ICMP_DEST_UNREACH
suffix:colon
r_case
id|ICMP_SOURCE_QUENCH
suffix:colon
id|icmp_unreach
c_func
(paren
id|icmph
comma
id|skb1
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
r_case
id|ICMP_REDIRECT
suffix:colon
id|icmp_redirect
c_func
(paren
id|icmph
comma
id|skb1
comma
id|dev
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
r_case
id|ICMP_ECHO
suffix:colon
id|icmp_echo
c_func
(paren
id|icmph
comma
id|skb1
comma
id|dev
comma
id|saddr
comma
id|daddr
comma
id|len
comma
id|opt
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
r_case
id|ICMP_ECHOREPLY
suffix:colon
id|skb1-&gt;sk
op_assign
l_int|NULL
suffix:semicolon
id|kfree_skb
c_func
(paren
id|skb1
comma
id|FREE_READ
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
r_case
id|ICMP_INFO_REQUEST
suffix:colon
id|icmp_info
c_func
(paren
id|icmph
comma
id|skb1
comma
id|dev
comma
id|saddr
comma
id|daddr
comma
id|len
comma
id|opt
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
r_case
id|ICMP_INFO_REPLY
suffix:colon
id|skb1-&gt;sk
op_assign
l_int|NULL
suffix:semicolon
id|kfree_skb
c_func
(paren
id|skb1
comma
id|FREE_READ
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
r_case
id|ICMP_ADDRESS
suffix:colon
id|icmp_address
c_func
(paren
id|icmph
comma
id|skb1
comma
id|dev
comma
id|saddr
comma
id|daddr
comma
id|len
comma
id|opt
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
r_case
id|ICMP_ADDRESSREPLY
suffix:colon
id|skb1-&gt;sk
op_assign
l_int|NULL
suffix:semicolon
id|kfree_skb
c_func
(paren
id|skb1
comma
id|FREE_READ
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
r_default
suffix:colon
id|DPRINTF
c_func
(paren
(paren
id|DBG_ICMP
comma
l_string|&quot;ICMP: Unsupported ICMP from %s, type = 0x%X&bslash;n&quot;
comma
id|in_ntoa
c_func
(paren
id|saddr
)paren
comma
id|icmph-&gt;type
)paren
)paren
suffix:semicolon
id|skb1-&gt;sk
op_assign
l_int|NULL
suffix:semicolon
id|kfree_skb
c_func
(paren
id|skb1
comma
id|FREE_READ
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*NOTREACHED*/
id|skb1-&gt;sk
op_assign
l_int|NULL
suffix:semicolon
id|kfree_skb
c_func
(paren
id|skb1
comma
id|FREE_READ
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
multiline_comment|/* Perform any ICMP-related I/O control requests. */
r_int
DECL|function|icmp_ioctl
id|icmp_ioctl
c_func
(paren
r_struct
id|sock
op_star
id|sk
comma
r_int
id|cmd
comma
r_int
r_int
id|arg
)paren
(brace
r_switch
c_cond
(paren
id|cmd
)paren
(brace
r_case
id|DDIOCSDBG
suffix:colon
r_return
id|dbg_ioctl
c_func
(paren
(paren
r_void
op_star
)paren
id|arg
comma
id|DBG_ICMP
)paren
suffix:semicolon
r_default
suffix:colon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
eof
