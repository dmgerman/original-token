multiline_comment|/*&n; * INET&t;&t;An implementation of the TCP/IP protocol suite for the LINUX&n; *&t;&t;operating system.  INET is implemented using the  BSD Socket&n; *&t;&t;interface as the means of communication with the user level.&n; *&n; *&t;&t;Internet Control Message Protocol (ICMP)&n; *&n; * Version:&t;@(#)icmp.c&t;1.0.11&t;06/02/93&n; *&n; * Authors:&t;Ross Biro, &lt;bir7@leland.Stanford.Edu&gt;&n; *&t;&t;Fred N. van Kempen, &lt;waltje@uWalt.NL.Mugnet.ORG&gt;&n; *&t;&t;Mark Evans, &lt;evansmp@uhura.aston.ac.uk&gt;&n; *&t;&t;Alan Cox, &lt;gw4pts@gw4pts.ampr.org&gt;&n; *&t;&t;Stefan Becker, &lt;stefanb@yello.ping.de&gt;&n; *&n; * Fixes:&t;&n; *&t;&t;Alan Cox&t;:&t;Generic queue usage.&n; *&t;&t;Gerhard Koerting:&t;ICMP addressing corrected&n; *&t;&t;Alan Cox&t;:&t;Use tos/ttl settings&n; *&t;&t;Alan Cox&t;:&t;Protocol violations&n; *&t;&t;Alan Cox&t;:&t;SNMP Statistics&t;&t;&n; *&t;&t;Alan Cox&t;:&t;Routing errors&n; *&t;&t;Alan Cox&t;:&t;Changes for newer routing code&n; *&t;&t;Alan Cox&t;:&t;Removed old debugging junk&n; *&t;&t;Alan Cox&t;:&t;Fixed the ICMP error status of net/host unreachable&n; *&t;Gerhard Koerting&t;:&t;Fixed broadcast ping properly&n; *&t;&t;Ulrich Kunitz&t;:&t;Fixed ICMP timestamp reply&n; *&t;&t;A.N.Kuznetsov&t;:&t;Multihoming fixes.&n; *&t;&t;Laco Rusnak&t;:&t;Multihoming fixes.&n; *&t;&t;Alan Cox&t;:&t;Tightened up icmp_send().&n; *&t;&t;Alan Cox&t;:&t;Multicasts.&n; *&t;&t;Stefan Becker   :       ICMP redirects in icmp_send().&n; *&n; * &n; *&n; *&t;&t;This program is free software; you can redistribute it and/or&n; *&t;&t;modify it under the terms of the GNU General Public License&n; *&t;&t;as published by the Free Software Foundation; either version&n; *&t;&t;2 of the License, or (at your option) any later version.&n; */
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/fcntl.h&gt;
macro_line|#include &lt;linux/socket.h&gt;
macro_line|#include &lt;linux/in.h&gt;
macro_line|#include &lt;linux/inet.h&gt;
macro_line|#include &lt;linux/netdevice.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &quot;snmp.h&quot;
macro_line|#include &quot;ip.h&quot;
macro_line|#include &quot;route.h&quot;
macro_line|#include &quot;protocol.h&quot;
macro_line|#include &quot;icmp.h&quot;
macro_line|#include &quot;tcp.h&quot;
macro_line|#include &quot;snmp.h&quot;
macro_line|#include &lt;linux/skbuff.h&gt;
macro_line|#include &quot;sock.h&quot;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/timer.h&gt;
macro_line|#include &lt;asm/system.h&gt;
macro_line|#include &lt;asm/segment.h&gt;
DECL|macro|min
mdefine_line|#define min(a,b)&t;((a)&lt;(b)?(a):(b))
multiline_comment|/*&n; *&t;Statistics&n; */
DECL|variable|icmp_statistics
r_struct
id|icmp_mib
id|icmp_statistics
op_assign
initialization_block
suffix:semicolon
multiline_comment|/* An array of errno for error messages from dest unreach. */
DECL|variable|icmp_err_convert
r_struct
id|icmp_err
id|icmp_err_convert
(braket
)braket
op_assign
(brace
(brace
id|ENETUNREACH
comma
l_int|0
)brace
comma
multiline_comment|/*&t;ICMP_NET_UNREACH&t;*/
(brace
id|EHOSTUNREACH
comma
l_int|0
)brace
comma
multiline_comment|/*&t;ICMP_HOST_UNREACH&t;*/
(brace
id|ENOPROTOOPT
comma
l_int|1
)brace
comma
multiline_comment|/*&t;ICMP_PROT_UNREACH&t;*/
(brace
id|ECONNREFUSED
comma
l_int|1
)brace
comma
multiline_comment|/*&t;ICMP_PORT_UNREACH&t;*/
(brace
id|EOPNOTSUPP
comma
l_int|0
)brace
comma
multiline_comment|/*&t;ICMP_FRAG_NEEDED&t;*/
(brace
id|EOPNOTSUPP
comma
l_int|0
)brace
comma
multiline_comment|/*&t;ICMP_SR_FAILED&t;&t;*/
(brace
id|ENETUNREACH
comma
l_int|1
)brace
comma
multiline_comment|/* &t;ICMP_NET_UNKNOWN&t;*/
(brace
id|EHOSTDOWN
comma
l_int|1
)brace
comma
multiline_comment|/*&t;ICMP_HOST_UNKNOWN&t;*/
(brace
id|ENONET
comma
l_int|1
)brace
comma
multiline_comment|/*&t;ICMP_HOST_ISOLATED&t;*/
(brace
id|ENETUNREACH
comma
l_int|1
)brace
comma
multiline_comment|/*&t;ICMP_NET_ANO&t;&t;*/
(brace
id|EHOSTUNREACH
comma
l_int|1
)brace
comma
multiline_comment|/*&t;ICMP_HOST_ANO&t;&t;*/
(brace
id|EOPNOTSUPP
comma
l_int|0
)brace
comma
multiline_comment|/*&t;ICMP_NET_UNR_TOS&t;*/
(brace
id|EOPNOTSUPP
comma
l_int|0
)brace
multiline_comment|/*&t;ICMP_HOST_UNR_TOS&t;*/
)brace
suffix:semicolon
multiline_comment|/*&n; *&t;Send an ICMP message in response to a situation&n; *&n; *&t;Fixme: Fragment handling is wrong really.&n; */
DECL|function|icmp_send
r_void
id|icmp_send
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb_in
comma
r_int
id|type
comma
r_int
id|code
comma
r_int
r_int
id|info
comma
r_struct
id|device
op_star
id|dev
)paren
(brace
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
r_struct
id|iphdr
op_star
id|iph
suffix:semicolon
r_int
id|offset
suffix:semicolon
r_struct
id|icmphdr
op_star
id|icmph
suffix:semicolon
r_int
id|len
suffix:semicolon
r_struct
id|device
op_star
id|ndev
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/* Make this =dev to force replies on the same interface */
r_int
r_int
id|our_addr
suffix:semicolon
r_int
id|atype
suffix:semicolon
multiline_comment|/*&n;&t; *&t;Find the original IP header.&n;&t; */
id|iph
op_assign
(paren
r_struct
id|iphdr
op_star
)paren
(paren
id|skb_in-&gt;data
op_plus
id|dev-&gt;hard_header_len
)paren
suffix:semicolon
multiline_comment|/*&n;&t; *&t;No replies to MAC multicast&n;&t; */
r_if
c_cond
(paren
id|skb_in-&gt;pkt_type
op_ne
id|PACKET_HOST
)paren
(brace
r_return
suffix:semicolon
)brace
multiline_comment|/*&n;&t; *&t;No replies to IP multicasting&n;&t; */
id|atype
op_assign
id|ip_chk_addr
c_func
(paren
id|iph-&gt;daddr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|atype
op_eq
id|IS_BROADCAST
op_logical_or
id|IN_MULTICAST
c_func
(paren
id|iph-&gt;daddr
)paren
)paren
(brace
r_return
suffix:semicolon
)brace
multiline_comment|/*&n;&t; *&t;Only reply to first fragment.&n;&t; */
r_if
c_cond
(paren
id|ntohs
c_func
(paren
id|iph-&gt;frag_off
)paren
op_amp
id|IP_OFFSET
)paren
(brace
r_return
suffix:semicolon
)brace
multiline_comment|/*&n;&t; *&t;We must NEVER NEVER send an ICMP error to an ICMP error message&n;&t; */
r_if
c_cond
(paren
id|type
op_eq
id|ICMP_DEST_UNREACH
op_logical_or
id|type
op_eq
id|ICMP_REDIRECT
op_logical_or
id|type
op_eq
id|ICMP_SOURCE_QUENCH
op_logical_or
id|type
op_eq
id|ICMP_TIME_EXCEEDED
)paren
(brace
multiline_comment|/*&n;&t;&t; *&t;Is the original packet an ICMP packet?&n;&t;&t; */
r_if
c_cond
(paren
id|iph-&gt;protocol
op_eq
id|IPPROTO_ICMP
)paren
(brace
id|icmph
op_assign
(paren
r_struct
id|icmphdr
op_star
)paren
(paren
(paren
r_char
op_star
)paren
id|iph
op_plus
l_int|4
op_star
id|iph-&gt;ihl
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t;&t; *&t;Check for ICMP error packets (Must never reply to&n;&t;&t;&t; *&t;an ICMP error).&n;&t;&t;&t; */
r_if
c_cond
(paren
id|icmph-&gt;type
op_eq
id|ICMP_DEST_UNREACH
op_logical_or
id|icmph-&gt;type
op_eq
id|ICMP_SOURCE_QUENCH
op_logical_or
id|icmph-&gt;type
op_eq
id|ICMP_REDIRECT
op_logical_or
id|icmph-&gt;type
op_eq
id|ICMP_TIME_EXCEEDED
op_logical_or
id|icmph-&gt;type
op_eq
id|ICMP_PARAMETERPROB
)paren
r_return
suffix:semicolon
)brace
)brace
id|icmp_statistics.IcmpOutMsgs
op_increment
suffix:semicolon
multiline_comment|/*&n;&t; *&t;This needs a tidy.&t;&n;&t; */
r_switch
c_cond
(paren
id|type
)paren
(brace
r_case
id|ICMP_DEST_UNREACH
suffix:colon
id|icmp_statistics.IcmpOutDestUnreachs
op_increment
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ICMP_SOURCE_QUENCH
suffix:colon
id|icmp_statistics.IcmpOutSrcQuenchs
op_increment
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ICMP_REDIRECT
suffix:colon
id|icmp_statistics.IcmpOutRedirects
op_increment
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ICMP_ECHO
suffix:colon
id|icmp_statistics.IcmpOutEchos
op_increment
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ICMP_ECHOREPLY
suffix:colon
id|icmp_statistics.IcmpOutEchoReps
op_increment
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ICMP_TIME_EXCEEDED
suffix:colon
id|icmp_statistics.IcmpOutTimeExcds
op_increment
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ICMP_PARAMETERPROB
suffix:colon
id|icmp_statistics.IcmpOutParmProbs
op_increment
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ICMP_TIMESTAMP
suffix:colon
id|icmp_statistics.IcmpOutTimestamps
op_increment
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ICMP_TIMESTAMPREPLY
suffix:colon
id|icmp_statistics.IcmpOutTimestampReps
op_increment
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ICMP_ADDRESS
suffix:colon
id|icmp_statistics.IcmpOutAddrMasks
op_increment
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ICMP_ADDRESSREPLY
suffix:colon
id|icmp_statistics.IcmpOutAddrMaskReps
op_increment
suffix:semicolon
r_break
suffix:semicolon
)brace
multiline_comment|/*&n;&t; *&t;Get some memory for the reply. &n;&t; */
id|len
op_assign
id|dev-&gt;hard_header_len
op_plus
r_sizeof
(paren
r_struct
id|iphdr
)paren
op_plus
r_sizeof
(paren
r_struct
id|icmphdr
)paren
op_plus
r_sizeof
(paren
r_struct
id|iphdr
)paren
op_plus
l_int|8
suffix:semicolon
multiline_comment|/* amount of header to return */
id|skb
op_assign
(paren
r_struct
id|sk_buff
op_star
)paren
id|alloc_skb
c_func
(paren
id|len
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
id|skb
op_eq
l_int|NULL
)paren
(brace
id|icmp_statistics.IcmpOutErrors
op_increment
suffix:semicolon
r_return
suffix:semicolon
)brace
id|skb-&gt;free
op_assign
l_int|1
suffix:semicolon
multiline_comment|/*&n;&t; *&t;Build Layer 2-3 headers for message back to source. &n;&t; */
id|our_addr
op_assign
id|dev-&gt;pa_addr
suffix:semicolon
r_if
c_cond
(paren
id|iph-&gt;daddr
op_ne
id|our_addr
op_logical_and
id|ip_chk_addr
c_func
(paren
id|iph-&gt;daddr
)paren
op_eq
id|IS_MYADDR
)paren
id|our_addr
op_assign
id|iph-&gt;daddr
suffix:semicolon
id|offset
op_assign
id|ip_build_header
c_func
(paren
id|skb
comma
id|our_addr
comma
id|iph-&gt;saddr
comma
op_amp
id|ndev
comma
id|IPPROTO_ICMP
comma
l_int|NULL
comma
id|len
comma
id|skb_in-&gt;ip_hdr-&gt;tos
comma
l_int|255
)paren
suffix:semicolon
r_if
c_cond
(paren
id|offset
OL
l_int|0
)paren
(brace
id|icmp_statistics.IcmpOutErrors
op_increment
suffix:semicolon
id|skb-&gt;sk
op_assign
l_int|NULL
suffix:semicolon
id|kfree_skb
c_func
(paren
id|skb
comma
id|FREE_READ
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/* &n;&t; *&t;Re-adjust length according to actual IP header size. &n;&t; */
id|skb-&gt;len
op_assign
id|offset
op_plus
r_sizeof
(paren
r_struct
id|icmphdr
)paren
op_plus
r_sizeof
(paren
r_struct
id|iphdr
)paren
op_plus
l_int|8
suffix:semicolon
multiline_comment|/*&n;&t; *&t;Fill in the frame&n;&t; */
id|icmph
op_assign
(paren
r_struct
id|icmphdr
op_star
)paren
(paren
id|skb-&gt;data
op_plus
id|offset
)paren
suffix:semicolon
id|icmph-&gt;type
op_assign
id|type
suffix:semicolon
id|icmph-&gt;code
op_assign
id|code
suffix:semicolon
id|icmph-&gt;checksum
op_assign
l_int|0
suffix:semicolon
id|icmph-&gt;un.gateway
op_assign
id|info
suffix:semicolon
multiline_comment|/* This might not be meant for &n;&t;&t;&t;&t;&t;   this form of the union but it will&n;&t;&t;&t;&t;&t;   be right anyway */
id|memcpy
c_func
(paren
id|icmph
op_plus
l_int|1
comma
id|iph
comma
r_sizeof
(paren
r_struct
id|iphdr
)paren
op_plus
l_int|8
)paren
suffix:semicolon
id|icmph-&gt;checksum
op_assign
id|ip_compute_csum
c_func
(paren
(paren
r_int
r_char
op_star
)paren
id|icmph
comma
r_sizeof
(paren
r_struct
id|icmphdr
)paren
op_plus
r_sizeof
(paren
r_struct
id|iphdr
)paren
op_plus
l_int|8
)paren
suffix:semicolon
multiline_comment|/*&n;&t; *&t;Send it and free it once sent.&n;&t; */
id|ip_queue_xmit
c_func
(paren
l_int|NULL
comma
id|ndev
comma
id|skb
comma
l_int|1
)paren
suffix:semicolon
)brace
multiline_comment|/* &n; *&t;Handle ICMP_UNREACH and ICMP_QUENCH. &n; */
DECL|function|icmp_unreach
r_static
r_void
id|icmp_unreach
c_func
(paren
r_struct
id|icmphdr
op_star
id|icmph
comma
r_struct
id|sk_buff
op_star
id|skb
)paren
(brace
r_struct
id|inet_protocol
op_star
id|ipprot
suffix:semicolon
r_struct
id|iphdr
op_star
id|iph
suffix:semicolon
r_int
r_char
id|hash
suffix:semicolon
r_int
id|err
suffix:semicolon
id|err
op_assign
(paren
id|icmph-&gt;type
op_lshift
l_int|8
)paren
op_or
id|icmph-&gt;code
suffix:semicolon
id|iph
op_assign
(paren
r_struct
id|iphdr
op_star
)paren
(paren
id|icmph
op_plus
l_int|1
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|icmph-&gt;code
op_amp
l_int|7
)paren
(brace
r_case
id|ICMP_NET_UNREACH
suffix:colon
r_break
suffix:semicolon
r_case
id|ICMP_HOST_UNREACH
suffix:colon
r_break
suffix:semicolon
r_case
id|ICMP_PROT_UNREACH
suffix:colon
id|printk
c_func
(paren
l_string|&quot;ICMP: %s:%d: protocol unreachable.&bslash;n&quot;
comma
id|in_ntoa
c_func
(paren
id|iph-&gt;daddr
)paren
comma
id|ntohs
c_func
(paren
id|iph-&gt;protocol
)paren
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ICMP_PORT_UNREACH
suffix:colon
r_break
suffix:semicolon
r_case
id|ICMP_FRAG_NEEDED
suffix:colon
id|printk
c_func
(paren
l_string|&quot;ICMP: %s: fragmentation needed and DF set.&bslash;n&quot;
comma
id|in_ntoa
c_func
(paren
id|iph-&gt;daddr
)paren
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ICMP_SR_FAILED
suffix:colon
id|printk
c_func
(paren
l_string|&quot;ICMP: %s: Source Route Failed.&bslash;n&quot;
comma
id|in_ntoa
c_func
(paren
id|iph-&gt;daddr
)paren
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
r_break
suffix:semicolon
)brace
multiline_comment|/*&n;&t; *&t;Get the protocol(s). &n;&t; */
id|hash
op_assign
id|iph-&gt;protocol
op_amp
(paren
id|MAX_INET_PROTOS
op_minus
l_int|1
)paren
suffix:semicolon
multiline_comment|/*&n;&t; *&t;This can&squot;t change while we are doing it. &n;&t; */
id|ipprot
op_assign
(paren
r_struct
id|inet_protocol
op_star
)paren
id|inet_protos
(braket
id|hash
)braket
suffix:semicolon
r_while
c_loop
(paren
id|ipprot
op_ne
l_int|NULL
)paren
(brace
r_struct
id|inet_protocol
op_star
id|nextip
suffix:semicolon
id|nextip
op_assign
(paren
r_struct
id|inet_protocol
op_star
)paren
id|ipprot-&gt;next
suffix:semicolon
multiline_comment|/* &n;&t;&t; *&t;Pass it off to everyone who wants it. &n;&t;&t; */
r_if
c_cond
(paren
id|iph-&gt;protocol
op_eq
id|ipprot-&gt;protocol
op_logical_and
id|ipprot-&gt;err_handler
)paren
(brace
id|ipprot
op_member_access_from_pointer
id|err_handler
c_func
(paren
id|err
comma
(paren
r_int
r_char
op_star
)paren
(paren
id|icmph
op_plus
l_int|1
)paren
comma
id|iph-&gt;daddr
comma
id|iph-&gt;saddr
comma
id|ipprot
)paren
suffix:semicolon
)brace
id|ipprot
op_assign
id|nextip
suffix:semicolon
)brace
id|kfree_skb
c_func
(paren
id|skb
comma
id|FREE_READ
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;Handle ICMP_REDIRECT. &n; */
DECL|function|icmp_redirect
r_static
r_void
id|icmp_redirect
c_func
(paren
r_struct
id|icmphdr
op_star
id|icmph
comma
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|device
op_star
id|dev
comma
r_int
r_int
id|source
)paren
(brace
r_struct
id|rtable
op_star
id|rt
suffix:semicolon
r_struct
id|iphdr
op_star
id|iph
suffix:semicolon
r_int
r_int
id|ip
suffix:semicolon
multiline_comment|/*&n;&t; *&t;Get the copied header of the packet that caused the redirect&n;&t; */
id|iph
op_assign
(paren
r_struct
id|iphdr
op_star
)paren
(paren
id|icmph
op_plus
l_int|1
)paren
suffix:semicolon
id|ip
op_assign
id|iph-&gt;daddr
suffix:semicolon
r_switch
c_cond
(paren
id|icmph-&gt;code
op_amp
l_int|7
)paren
(brace
r_case
id|ICMP_REDIR_NET
suffix:colon
multiline_comment|/*&n;&t;&t;&t; *&t;This causes a problem with subnetted networks. What we should do&n;&t;&t;&t; *&t;is use ICMP_ADDRESS to get the subnet mask of the problem route&n;&t;&t;&t; *&t;and set both. But we don&squot;t..&n;&t;&t;&t; */
macro_line|#ifdef not_a_good_idea
id|ip_rt_add
c_func
(paren
(paren
id|RTF_DYNAMIC
op_or
id|RTF_MODIFIED
op_or
id|RTF_GATEWAY
)paren
comma
id|ip
comma
l_int|0
comma
id|icmph-&gt;un.gateway
comma
id|dev
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
r_break
suffix:semicolon
macro_line|#endif
r_case
id|ICMP_REDIR_HOST
suffix:colon
multiline_comment|/*&n;&t;&t;&t; *&t;Add better route to host.&n;&t;&t;&t; *&t;But first check that the redirect&n;&t;&t;&t; *&t;comes from the old gateway..&n;&t;&t;&t; */
id|rt
op_assign
id|ip_rt_route
c_func
(paren
id|ip
comma
l_int|NULL
comma
l_int|NULL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|rt
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
id|rt-&gt;rt_gateway
op_ne
id|source
)paren
r_break
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;redirect from %s&bslash;n&quot;
comma
id|in_ntoa
c_func
(paren
id|source
)paren
)paren
suffix:semicolon
id|ip_rt_add
c_func
(paren
(paren
id|RTF_DYNAMIC
op_or
id|RTF_MODIFIED
op_or
id|RTF_HOST
op_or
id|RTF_GATEWAY
)paren
comma
id|ip
comma
l_int|0
comma
id|icmph-&gt;un.gateway
comma
id|dev
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ICMP_REDIR_NETTOS
suffix:colon
r_case
id|ICMP_REDIR_HOSTTOS
suffix:colon
id|printk
c_func
(paren
l_string|&quot;ICMP: cannot handle TOS redirects yet!&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
r_break
suffix:semicolon
)brace
multiline_comment|/*&n;  &t; *&t;Discard the original packet&n;  &t; */
id|kfree_skb
c_func
(paren
id|skb
comma
id|FREE_READ
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;Handle ICMP_ECHO (&quot;ping&quot;) requests. &n; */
DECL|function|icmp_echo
r_static
r_void
id|icmp_echo
c_func
(paren
r_struct
id|icmphdr
op_star
id|icmph
comma
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|device
op_star
id|dev
comma
r_int
r_int
id|saddr
comma
r_int
r_int
id|daddr
comma
r_int
id|len
comma
r_struct
id|options
op_star
id|opt
)paren
(brace
r_struct
id|icmphdr
op_star
id|icmphr
suffix:semicolon
r_struct
id|sk_buff
op_star
id|skb2
suffix:semicolon
r_struct
id|device
op_star
id|ndev
op_assign
l_int|NULL
suffix:semicolon
r_int
id|size
comma
id|offset
suffix:semicolon
id|icmp_statistics.IcmpOutEchoReps
op_increment
suffix:semicolon
id|icmp_statistics.IcmpOutMsgs
op_increment
suffix:semicolon
id|size
op_assign
id|dev-&gt;hard_header_len
op_plus
l_int|64
op_plus
id|len
suffix:semicolon
id|skb2
op_assign
id|alloc_skb
c_func
(paren
id|size
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
id|skb2
op_eq
l_int|NULL
)paren
(brace
id|icmp_statistics.IcmpOutErrors
op_increment
suffix:semicolon
id|kfree_skb
c_func
(paren
id|skb
comma
id|FREE_READ
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|skb2-&gt;free
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* Build Layer 2-3 headers for message back to source */
id|offset
op_assign
id|ip_build_header
c_func
(paren
id|skb2
comma
id|daddr
comma
id|saddr
comma
op_amp
id|ndev
comma
id|IPPROTO_ICMP
comma
id|opt
comma
id|len
comma
id|skb-&gt;ip_hdr-&gt;tos
comma
l_int|255
)paren
suffix:semicolon
r_if
c_cond
(paren
id|offset
OL
l_int|0
)paren
(brace
id|icmp_statistics.IcmpOutErrors
op_increment
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;ICMP: Could not build IP Header for ICMP ECHO Response&bslash;n&quot;
)paren
suffix:semicolon
id|kfree_skb
c_func
(paren
id|skb2
comma
id|FREE_WRITE
)paren
suffix:semicolon
id|kfree_skb
c_func
(paren
id|skb
comma
id|FREE_READ
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/*&n;&t; *&t;Re-adjust length according to actual IP header size. &n;&t; */
id|skb2-&gt;len
op_assign
id|offset
op_plus
id|len
suffix:semicolon
multiline_comment|/*&n;&t; *&t;Build ICMP_ECHO Response message. &n;&t; */
id|icmphr
op_assign
(paren
r_struct
id|icmphdr
op_star
)paren
(paren
id|skb2-&gt;data
op_plus
id|offset
)paren
suffix:semicolon
id|memcpy
c_func
(paren
(paren
r_char
op_star
)paren
id|icmphr
comma
(paren
r_char
op_star
)paren
id|icmph
comma
id|len
)paren
suffix:semicolon
id|icmphr-&gt;type
op_assign
id|ICMP_ECHOREPLY
suffix:semicolon
id|icmphr-&gt;code
op_assign
l_int|0
suffix:semicolon
id|icmphr-&gt;checksum
op_assign
l_int|0
suffix:semicolon
id|icmphr-&gt;checksum
op_assign
id|ip_compute_csum
c_func
(paren
(paren
r_int
r_char
op_star
)paren
id|icmphr
comma
id|len
)paren
suffix:semicolon
multiline_comment|/*&n;&t; *&t;Ship it out - free it when done &n;&t; */
id|ip_queue_xmit
c_func
(paren
(paren
r_struct
id|sock
op_star
)paren
l_int|NULL
comma
id|ndev
comma
id|skb2
comma
l_int|1
)paren
suffix:semicolon
multiline_comment|/*&n;&t; *&t;Free the received frame&n;&t; */
id|kfree_skb
c_func
(paren
id|skb
comma
id|FREE_READ
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;Handle ICMP Timestamp requests. &n; */
DECL|function|icmp_timestamp
r_static
r_void
id|icmp_timestamp
c_func
(paren
r_struct
id|icmphdr
op_star
id|icmph
comma
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|device
op_star
id|dev
comma
r_int
r_int
id|saddr
comma
r_int
r_int
id|daddr
comma
r_int
id|len
comma
r_struct
id|options
op_star
id|opt
)paren
(brace
r_struct
id|icmphdr
op_star
id|icmphr
suffix:semicolon
r_struct
id|sk_buff
op_star
id|skb2
suffix:semicolon
r_int
id|size
comma
id|offset
suffix:semicolon
r_int
r_int
op_star
id|timeptr
comma
id|midtime
suffix:semicolon
r_struct
id|device
op_star
id|ndev
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
id|len
op_ne
l_int|20
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;ICMP: Size (%d) of ICMP_TIMESTAMP request should be 20!&bslash;n&quot;
comma
id|len
)paren
suffix:semicolon
id|icmp_statistics.IcmpInErrors
op_increment
suffix:semicolon
macro_line|#if 1
multiline_comment|/* correct answers are possible for everything &gt;= 12 */
r_if
c_cond
(paren
id|len
OL
l_int|12
)paren
macro_line|#endif
r_return
suffix:semicolon
)brace
id|size
op_assign
id|dev-&gt;hard_header_len
op_plus
l_int|84
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|skb2
op_assign
id|alloc_skb
c_func
(paren
id|size
comma
id|GFP_ATOMIC
)paren
)paren
)paren
(brace
id|skb-&gt;sk
op_assign
l_int|NULL
suffix:semicolon
id|kfree_skb
c_func
(paren
id|skb
comma
id|FREE_READ
)paren
suffix:semicolon
id|icmp_statistics.IcmpOutErrors
op_increment
suffix:semicolon
r_return
suffix:semicolon
)brace
id|skb2-&gt;free
op_assign
l_int|1
suffix:semicolon
multiline_comment|/*&n; *&t;Build Layer 2-3 headers for message back to source &n; */
id|offset
op_assign
id|ip_build_header
c_func
(paren
id|skb2
comma
id|daddr
comma
id|saddr
comma
op_amp
id|ndev
comma
id|IPPROTO_ICMP
comma
id|opt
comma
id|len
comma
id|skb-&gt;ip_hdr-&gt;tos
comma
l_int|255
)paren
suffix:semicolon
r_if
c_cond
(paren
id|offset
OL
l_int|0
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;ICMP: Could not build IP Header for ICMP TIMESTAMP Response&bslash;n&quot;
)paren
suffix:semicolon
id|kfree_skb
c_func
(paren
id|skb2
comma
id|FREE_WRITE
)paren
suffix:semicolon
id|kfree_skb
c_func
(paren
id|skb
comma
id|FREE_READ
)paren
suffix:semicolon
id|icmp_statistics.IcmpOutErrors
op_increment
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/*&n;&t; *&t;Re-adjust length according to actual IP header size. &n;&t; */
id|skb2-&gt;len
op_assign
id|offset
op_plus
l_int|20
suffix:semicolon
multiline_comment|/*&n;&t; *&t;Build ICMP_TIMESTAMP Response message. &n;&t; */
id|icmphr
op_assign
(paren
r_struct
id|icmphdr
op_star
)paren
(paren
(paren
r_char
op_star
)paren
(paren
id|skb2
op_plus
l_int|1
)paren
op_plus
id|offset
)paren
suffix:semicolon
id|memcpy
c_func
(paren
(paren
r_char
op_star
)paren
id|icmphr
comma
(paren
r_char
op_star
)paren
id|icmph
comma
l_int|12
)paren
suffix:semicolon
id|icmphr-&gt;type
op_assign
id|ICMP_TIMESTAMPREPLY
suffix:semicolon
id|icmphr-&gt;code
op_assign
id|icmphr-&gt;checksum
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* fill in the current time as ms since midnight UT: */
id|midtime
op_assign
(paren
id|xtime.tv_sec
op_mod
l_int|86400
)paren
op_star
l_int|1000
op_plus
id|xtime.tv_usec
op_div
l_int|1000
suffix:semicolon
id|timeptr
op_assign
(paren
r_int
r_int
op_star
)paren
(paren
id|icmphr
op_plus
l_int|1
)paren
suffix:semicolon
multiline_comment|/*&n;&t; *&t;the originate timestamp (timeptr [0]) is still in the copy: &n;&t; */
id|timeptr
(braket
l_int|1
)braket
op_assign
id|timeptr
(braket
l_int|2
)braket
op_assign
id|htonl
c_func
(paren
id|midtime
)paren
suffix:semicolon
id|icmphr-&gt;checksum
op_assign
id|ip_compute_csum
c_func
(paren
(paren
r_int
r_char
op_star
)paren
id|icmphr
comma
l_int|20
)paren
suffix:semicolon
multiline_comment|/*&n;&t; *&t;Ship it out - free it when done &n;&t; */
id|ip_queue_xmit
c_func
(paren
(paren
r_struct
id|sock
op_star
)paren
l_int|NULL
comma
id|ndev
comma
id|skb2
comma
l_int|1
)paren
suffix:semicolon
id|icmp_statistics.IcmpOutTimestampReps
op_increment
suffix:semicolon
id|kfree_skb
c_func
(paren
id|skb
comma
id|FREE_READ
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;Handle the ICMP INFORMATION REQUEST. &n; */
DECL|function|icmp_info
r_static
r_void
id|icmp_info
c_func
(paren
r_struct
id|icmphdr
op_star
id|icmph
comma
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|device
op_star
id|dev
comma
r_int
r_int
id|saddr
comma
r_int
r_int
id|daddr
comma
r_int
id|len
comma
r_struct
id|options
op_star
id|opt
)paren
(brace
multiline_comment|/* Obsolete */
id|kfree_skb
c_func
(paren
id|skb
comma
id|FREE_READ
)paren
suffix:semicolon
)brace
multiline_comment|/* &n; *&t;Handle ICMP_ADDRESS_MASK requests. &n; */
DECL|function|icmp_address
r_static
r_void
id|icmp_address
c_func
(paren
r_struct
id|icmphdr
op_star
id|icmph
comma
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|device
op_star
id|dev
comma
r_int
r_int
id|saddr
comma
r_int
r_int
id|daddr
comma
r_int
id|len
comma
r_struct
id|options
op_star
id|opt
)paren
(brace
r_struct
id|icmphdr
op_star
id|icmphr
suffix:semicolon
r_struct
id|sk_buff
op_star
id|skb2
suffix:semicolon
r_int
id|size
comma
id|offset
suffix:semicolon
r_struct
id|device
op_star
id|ndev
op_assign
l_int|NULL
suffix:semicolon
id|icmp_statistics.IcmpOutMsgs
op_increment
suffix:semicolon
id|icmp_statistics.IcmpOutAddrMaskReps
op_increment
suffix:semicolon
id|size
op_assign
id|dev-&gt;hard_header_len
op_plus
l_int|64
op_plus
id|len
suffix:semicolon
id|skb2
op_assign
id|alloc_skb
c_func
(paren
id|size
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
id|skb2
op_eq
l_int|NULL
)paren
(brace
id|icmp_statistics.IcmpOutErrors
op_increment
suffix:semicolon
id|kfree_skb
c_func
(paren
id|skb
comma
id|FREE_READ
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|skb2-&gt;free
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* &n;&t; *&t;Build Layer 2-3 headers for message back to source &n;&t; */
id|offset
op_assign
id|ip_build_header
c_func
(paren
id|skb2
comma
id|daddr
comma
id|saddr
comma
op_amp
id|ndev
comma
id|IPPROTO_ICMP
comma
id|opt
comma
id|len
comma
id|skb-&gt;ip_hdr-&gt;tos
comma
l_int|255
)paren
suffix:semicolon
r_if
c_cond
(paren
id|offset
OL
l_int|0
)paren
(brace
id|icmp_statistics.IcmpOutErrors
op_increment
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;ICMP: Could not build IP Header for ICMP ADDRESS Response&bslash;n&quot;
)paren
suffix:semicolon
id|kfree_skb
c_func
(paren
id|skb2
comma
id|FREE_WRITE
)paren
suffix:semicolon
id|kfree_skb
c_func
(paren
id|skb
comma
id|FREE_READ
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/*&n;&t; *&t;Re-adjust length according to actual IP header size. &n;&t; */
id|skb2-&gt;len
op_assign
id|offset
op_plus
id|len
suffix:semicolon
multiline_comment|/*&n;&t; *&t;Build ICMP ADDRESS MASK Response message. &n;&t; */
id|icmphr
op_assign
(paren
r_struct
id|icmphdr
op_star
)paren
(paren
id|skb2-&gt;data
op_plus
id|offset
)paren
suffix:semicolon
id|icmphr-&gt;type
op_assign
id|ICMP_ADDRESSREPLY
suffix:semicolon
id|icmphr-&gt;code
op_assign
l_int|0
suffix:semicolon
id|icmphr-&gt;checksum
op_assign
l_int|0
suffix:semicolon
id|icmphr-&gt;un.echo.id
op_assign
id|icmph-&gt;un.echo.id
suffix:semicolon
id|icmphr-&gt;un.echo.sequence
op_assign
id|icmph-&gt;un.echo.sequence
suffix:semicolon
id|memcpy
c_func
(paren
(paren
r_char
op_star
)paren
(paren
id|icmphr
op_plus
l_int|1
)paren
comma
(paren
r_char
op_star
)paren
op_amp
id|dev-&gt;pa_mask
comma
r_sizeof
(paren
id|dev-&gt;pa_mask
)paren
)paren
suffix:semicolon
id|icmphr-&gt;checksum
op_assign
id|ip_compute_csum
c_func
(paren
(paren
r_int
r_char
op_star
)paren
id|icmphr
comma
id|len
)paren
suffix:semicolon
multiline_comment|/* Ship it out - free it when done */
id|ip_queue_xmit
c_func
(paren
(paren
r_struct
id|sock
op_star
)paren
l_int|NULL
comma
id|ndev
comma
id|skb2
comma
l_int|1
)paren
suffix:semicolon
id|skb-&gt;sk
op_assign
l_int|NULL
suffix:semicolon
id|kfree_skb
c_func
(paren
id|skb
comma
id|FREE_READ
)paren
suffix:semicolon
)brace
multiline_comment|/* &n; *&t;Deal with incoming ICMP packets. &n; */
DECL|function|icmp_rcv
r_int
id|icmp_rcv
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb1
comma
r_struct
id|device
op_star
id|dev
comma
r_struct
id|options
op_star
id|opt
comma
r_int
r_int
id|daddr
comma
r_int
r_int
id|len
comma
r_int
r_int
id|saddr
comma
r_int
id|redo
comma
r_struct
id|inet_protocol
op_star
id|protocol
)paren
(brace
r_struct
id|icmphdr
op_star
id|icmph
suffix:semicolon
r_int
r_char
op_star
id|buff
suffix:semicolon
multiline_comment|/*&n;&t; *&t;Drop broadcast packets. IP has done a broadcast check and ought one day&n;&t; *&t;to pass on that information.&n;&t; */
id|icmp_statistics.IcmpInMsgs
op_increment
suffix:semicolon
multiline_comment|/*&n;  &t; *&t;Grab the packet as an icmp object&n;  &t; */
id|buff
op_assign
id|skb1-&gt;h.raw
suffix:semicolon
id|icmph
op_assign
(paren
r_struct
id|icmphdr
op_star
)paren
id|buff
suffix:semicolon
multiline_comment|/*&n;&t; *&t;Validate the packet first &n;&t; */
r_if
c_cond
(paren
id|ip_compute_csum
c_func
(paren
(paren
r_int
r_char
op_star
)paren
id|icmph
comma
id|len
)paren
)paren
(brace
multiline_comment|/* Failed checksum! */
id|icmp_statistics.IcmpInErrors
op_increment
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;ICMP: failed checksum from %s!&bslash;n&quot;
comma
id|in_ntoa
c_func
(paren
id|saddr
)paren
)paren
suffix:semicolon
id|kfree_skb
c_func
(paren
id|skb1
comma
id|FREE_READ
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n;&t; *&t;Parse the ICMP message &n;&t; */
r_if
c_cond
(paren
id|ip_chk_addr
c_func
(paren
id|daddr
)paren
op_ne
id|IS_MYADDR
)paren
(brace
r_if
c_cond
(paren
id|icmph-&gt;type
op_ne
id|ICMP_ECHO
)paren
(brace
id|icmp_statistics.IcmpInErrors
op_increment
suffix:semicolon
id|kfree_skb
c_func
(paren
id|skb1
comma
id|FREE_READ
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|daddr
op_assign
id|dev-&gt;pa_addr
suffix:semicolon
)brace
r_switch
c_cond
(paren
id|icmph-&gt;type
)paren
(brace
r_case
id|ICMP_TIME_EXCEEDED
suffix:colon
id|icmp_statistics.IcmpInTimeExcds
op_increment
suffix:semicolon
id|icmp_unreach
c_func
(paren
id|icmph
comma
id|skb1
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
r_case
id|ICMP_DEST_UNREACH
suffix:colon
id|icmp_statistics.IcmpInDestUnreachs
op_increment
suffix:semicolon
id|icmp_unreach
c_func
(paren
id|icmph
comma
id|skb1
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
r_case
id|ICMP_SOURCE_QUENCH
suffix:colon
id|icmp_statistics.IcmpInSrcQuenchs
op_increment
suffix:semicolon
id|icmp_unreach
c_func
(paren
id|icmph
comma
id|skb1
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
r_case
id|ICMP_REDIRECT
suffix:colon
id|icmp_statistics.IcmpInRedirects
op_increment
suffix:semicolon
id|icmp_redirect
c_func
(paren
id|icmph
comma
id|skb1
comma
id|dev
comma
id|saddr
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
r_case
id|ICMP_ECHO
suffix:colon
id|icmp_statistics.IcmpInEchos
op_increment
suffix:semicolon
id|icmp_echo
c_func
(paren
id|icmph
comma
id|skb1
comma
id|dev
comma
id|saddr
comma
id|daddr
comma
id|len
comma
id|opt
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
r_case
id|ICMP_ECHOREPLY
suffix:colon
id|icmp_statistics.IcmpInEchoReps
op_increment
suffix:semicolon
id|kfree_skb
c_func
(paren
id|skb1
comma
id|FREE_READ
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
r_case
id|ICMP_TIMESTAMP
suffix:colon
id|icmp_statistics.IcmpInTimestamps
op_increment
suffix:semicolon
id|icmp_timestamp
c_func
(paren
id|icmph
comma
id|skb1
comma
id|dev
comma
id|saddr
comma
id|daddr
comma
id|len
comma
id|opt
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
r_case
id|ICMP_TIMESTAMPREPLY
suffix:colon
id|icmp_statistics.IcmpInTimestampReps
op_increment
suffix:semicolon
id|kfree_skb
c_func
(paren
id|skb1
comma
id|FREE_READ
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
multiline_comment|/* INFO is obsolete and doesn&squot;t even feature in the SNMP stats */
r_case
id|ICMP_INFO_REQUEST
suffix:colon
id|icmp_info
c_func
(paren
id|icmph
comma
id|skb1
comma
id|dev
comma
id|saddr
comma
id|daddr
comma
id|len
comma
id|opt
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
r_case
id|ICMP_INFO_REPLY
suffix:colon
id|skb1-&gt;sk
op_assign
l_int|NULL
suffix:semicolon
id|kfree_skb
c_func
(paren
id|skb1
comma
id|FREE_READ
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
r_case
id|ICMP_ADDRESS
suffix:colon
id|icmp_statistics.IcmpInAddrMasks
op_increment
suffix:semicolon
id|icmp_address
c_func
(paren
id|icmph
comma
id|skb1
comma
id|dev
comma
id|saddr
comma
id|daddr
comma
id|len
comma
id|opt
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
r_case
id|ICMP_ADDRESSREPLY
suffix:colon
multiline_comment|/*&n;&t;&t;&t; *&t;We ought to set our netmask on receiving this, but &n;&t;&t;&t; *&t;experience shows its a waste of effort.&n;&t;&t;&t; */
id|icmp_statistics.IcmpInAddrMaskReps
op_increment
suffix:semicolon
id|kfree_skb
c_func
(paren
id|skb1
comma
id|FREE_READ
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
r_default
suffix:colon
id|icmp_statistics.IcmpInErrors
op_increment
suffix:semicolon
id|kfree_skb
c_func
(paren
id|skb1
comma
id|FREE_READ
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*NOTREACHED*/
id|kfree_skb
c_func
(paren
id|skb1
comma
id|FREE_READ
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;Perform any ICMP-related I/O control requests. &n; *&t;[to vanish soon]&n; */
DECL|function|icmp_ioctl
r_int
id|icmp_ioctl
c_func
(paren
r_struct
id|sock
op_star
id|sk
comma
r_int
id|cmd
comma
r_int
r_int
id|arg
)paren
(brace
r_switch
c_cond
(paren
id|cmd
)paren
(brace
r_default
suffix:colon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
eof
