multiline_comment|/* 8390.c: A general NS8390 ethernet driver core for linux. */
multiline_comment|/*&n;    Written 1992,1993 by Donald Becker.&n;&n;    Copyright 1993 United States Government as represented by the&n;    Director, National Security Agency.  This software may be used and&n;    distributed according to the terms of the GNU Public License,&n;    incorporated herein by reference.&n;&n;    This is the chip-specific code for many 8390-based ethernet adaptors.&n;&n;    The Author may be reached as becker@super.org or&n;    C/O Supercomputing Research Ctr., 17100 Science Dr., Bowie MD 20715&n;*/
DECL|variable|version
r_static
r_char
op_star
id|version
op_assign
l_string|&quot;8390.c:v0.99-13 9/3/93 for 0.99.13 Donald Becker (becker@super.org)&bslash;n&quot;
suffix:semicolon
macro_line|#include &lt;linux/config.h&gt;
multiline_comment|/*&n;  Braindamage remaining:&n;&n;  Ethernet devices should use a chr_drv device interface, with ioctl()s to&n;  configure the card, bring the interface up or down, allow access to&n;  statistics, and maybe read() and write() access to raw packets.&n;  This won&squot;t be done until after Linux 1.00.&n;&n;Sources:&n;  The National Semiconductor LAN Databook, and the 3Com 3c503 databook.&n;  The NE* programming info came from the Crynwr packet driver, and figuring&n;  out that the those boards are similar to the NatSemi evaluation board&n;  described in AN-729.  Thanks NS, no thanks to Novell/Eagle.&n;  */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/fs.h&gt;
macro_line|#include &lt;linux/tty.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/ptrace.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;asm/system.h&gt;
macro_line|#include &lt;asm/segment.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;errno.h&gt;
macro_line|#include &lt;linux/fcntl.h&gt;
macro_line|#include &lt;linux/in.h&gt;
macro_line|#include &lt;linux/interrupt.h&gt;
macro_line|#include &quot;dev.h&quot;
macro_line|#include &quot;eth.h&quot;
macro_line|#include &quot;ip.h&quot;
macro_line|#include &quot;protocol.h&quot;
macro_line|#include &quot;tcp.h&quot;
macro_line|#include &quot;skbuff.h&quot;
macro_line|#include &quot;sock.h&quot;
macro_line|#include &quot;arp.h&quot;
macro_line|#include &quot;8390.h&quot;
DECL|macro|ei_reset_8390
mdefine_line|#define ei_reset_8390 (ei_local-&gt;reset_8390)
DECL|macro|ei_block_output
mdefine_line|#define ei_block_output (ei_local-&gt;block_output)
DECL|macro|ei_block_input
mdefine_line|#define ei_block_input (ei_local-&gt;block_input)
multiline_comment|/* use 0 for production, 1 for verification, &gt;2 for debug */
macro_line|#ifdef EI_DEBUG
DECL|variable|ei_debug
r_int
id|ei_debug
op_assign
id|EI_DEBUG
suffix:semicolon
macro_line|#else
DECL|variable|ei_debug
r_int
id|ei_debug
op_assign
l_int|1
suffix:semicolon
macro_line|#endif
multiline_comment|/* Max number of packets received at one Intr. */
multiline_comment|/*static int high_water_mark = 0;*/
multiline_comment|/* Index to functions. */
multiline_comment|/* Put in the device structure. */
r_int
id|ei_open
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
suffix:semicolon
multiline_comment|/* Dispatch from interrupts. */
r_void
id|ei_interrupt
c_func
(paren
r_int
id|reg_ptr
)paren
suffix:semicolon
r_static
r_void
id|ei_tx_intr
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_void
id|ei_receive
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_void
id|ei_rx_overrun
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
suffix:semicolon
multiline_comment|/* Routines generic to NS8390-based boards. */
r_void
id|NS8390_init
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
r_int
id|startp
)paren
suffix:semicolon
r_static
r_void
id|NS8390_trigger_send
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
r_int
r_int
id|length
comma
r_int
id|start_page
)paren
suffix:semicolon
DECL|variable|ei_sigaction
r_struct
id|sigaction
id|ei_sigaction
op_assign
(brace
id|ei_interrupt
comma
l_int|0
comma
l_int|0
comma
l_int|NULL
comma
)brace
suffix:semicolon
"&f;"
multiline_comment|/* Open/initialize the board.  This routine goes all-out, setting everything&n;   up anew at each open, even though many of these registers should only&n;   need to be set once at boot.&n;   */
r_int
DECL|function|ei_open
id|ei_open
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
r_struct
id|ei_device
op_star
id|ei_local
op_assign
(paren
r_struct
id|ei_device
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ei_local
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%s: Opening a non-existent physical device&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
multiline_comment|/* ENXIO would be more accurate. */
)brace
id|irq2dev_map
(braket
id|dev-&gt;irq
)braket
op_assign
id|dev
suffix:semicolon
id|NS8390_init
c_func
(paren
id|dev
comma
l_int|1
)paren
suffix:semicolon
id|ei_local-&gt;tx1
op_assign
id|ei_local-&gt;tx2
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* The old local flags... */
id|ei_local-&gt;txing
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* ... are now global. */
id|dev-&gt;tbusy
op_assign
l_int|0
suffix:semicolon
id|dev-&gt;interrupt
op_assign
l_int|0
suffix:semicolon
id|dev-&gt;start
op_assign
l_int|1
suffix:semicolon
id|ei_local-&gt;irqlock
op_assign
l_int|0
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_int
DECL|function|ei_start_xmit
id|ei_start_xmit
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|device
op_star
id|dev
)paren
(brace
r_int
id|e8390_base
op_assign
id|dev-&gt;base_addr
suffix:semicolon
r_struct
id|ei_device
op_star
id|ei_local
op_assign
(paren
r_struct
id|ei_device
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_int
id|length
comma
id|send_length
suffix:semicolon
r_int
id|tmp_tbusy
suffix:semicolon
multiline_comment|/* we must lock dev_tint in dev.c with dev-&gt;t_busy =1 */
multiline_comment|/* because on a slow pc a quasi endless loop can appear */
r_if
c_cond
(paren
id|dev-&gt;tbusy
)paren
(brace
multiline_comment|/* Do timeouts, just like the 8003 driver. */
r_int
id|txsr
op_assign
id|inb
c_func
(paren
id|e8390_base
op_plus
id|EN0_TSR
)paren
comma
id|isr
suffix:semicolon
r_int
id|tickssofar
op_assign
id|jiffies
op_minus
id|dev-&gt;trans_start
suffix:semicolon
r_if
c_cond
(paren
id|tickssofar
OL
l_int|5
op_logical_or
(paren
id|tickssofar
OL
l_int|15
op_logical_and
op_logical_neg
(paren
id|txsr
op_amp
id|ENTSR_PTX
)paren
)paren
)paren
(brace
r_return
l_int|1
suffix:semicolon
)brace
id|isr
op_assign
id|inb
c_func
(paren
id|e8390_base
op_plus
id|EN0_ISR
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;%s: transmit timed out, TX status %#2x, ISR %#2x.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|txsr
comma
id|isr
)paren
suffix:semicolon
multiline_comment|/* It&squot;s possible to check for an IRQ conflict here.&n;&t;   I may have to do that someday. */
r_if
c_cond
(paren
id|isr
)paren
id|printk
c_func
(paren
l_string|&quot;%s: Possible IRQ conflict on IRQ%d?&quot;
comma
id|dev-&gt;name
comma
id|dev-&gt;irq
)paren
suffix:semicolon
r_else
id|printk
c_func
(paren
l_string|&quot;%s: Possible network cable problem?&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
multiline_comment|/* It futile, but try to restart it anyway. */
id|ei_reset_8390
c_func
(paren
id|dev
)paren
suffix:semicolon
id|NS8390_init
c_func
(paren
id|dev
comma
l_int|1
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/* This is new: it means some higher layer thinks we&squot;ve missed an&n;       tx-done interrupt. Caution: dev_tint() handles the cli()/sti()&n;       itself. */
r_if
c_cond
(paren
id|skb
op_eq
l_int|NULL
)paren
(brace
id|dev_tint
c_func
(paren
id|dev
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Fill in the ethernet header. */
r_if
c_cond
(paren
op_logical_neg
id|skb-&gt;arp
op_logical_and
id|dev
op_member_access_from_pointer
id|rebuild_header
c_func
(paren
id|skb
op_plus
l_int|1
comma
id|dev
)paren
)paren
(brace
id|skb-&gt;dev
op_assign
id|dev
suffix:semicolon
id|arp_queue
(paren
id|skb
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|skb-&gt;len
op_le
l_int|0
)paren
r_return
l_int|0
suffix:semicolon
id|length
op_assign
id|skb-&gt;len
suffix:semicolon
id|send_length
op_assign
id|ETH_ZLEN
OL
id|length
ques
c_cond
id|length
suffix:colon
id|ETH_ZLEN
suffix:semicolon
multiline_comment|/* Turn off interrupts so that we can put the packet out safely. */
id|cli
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;interrupt
op_logical_or
id|ei_local-&gt;irqlock
)paren
(brace
multiline_comment|/* We should never get here during an interrupt after 0.99.4. */
id|sti
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ei_debug
OG
l_int|2
)paren
id|printk
c_func
(paren
l_string|&quot;%s: Attempt to reenter critical zone%s.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|ei_local-&gt;irqlock
ques
c_cond
l_string|&quot; during interrupt&quot;
suffix:colon
l_string|&quot;&quot;
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
id|outb
c_func
(paren
l_int|0x00
comma
id|e8390_base
op_plus
id|EN0_IMR
)paren
suffix:semicolon
id|tmp_tbusy
op_assign
id|dev-&gt;tbusy
suffix:semicolon
id|dev-&gt;tbusy
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* lock dev_tint() in dev.c */
id|ei_local-&gt;irqlock
op_assign
l_int|1
suffix:semicolon
id|sti
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ei_local-&gt;pingpong
)paren
(brace
r_int
id|output_page
suffix:semicolon
r_if
c_cond
(paren
id|ei_local-&gt;tx1
op_eq
l_int|0
)paren
(brace
id|output_page
op_assign
id|ei_local-&gt;tx_start_page
suffix:semicolon
id|ei_local-&gt;tx1
op_assign
id|send_length
suffix:semicolon
r_if
c_cond
(paren
id|ei_debug
op_logical_and
id|ei_local-&gt;tx2
OG
l_int|0
)paren
id|printk
c_func
(paren
l_string|&quot;%s: idle transmitter tx2=%d, lasttx=%d, txing=%d.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|ei_local-&gt;tx2
comma
id|ei_local-&gt;lasttx
comma
id|ei_local-&gt;txing
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|ei_local-&gt;tx2
op_eq
l_int|0
)paren
(brace
id|output_page
op_assign
id|ei_local-&gt;tx_start_page
op_plus
l_int|6
suffix:semicolon
id|ei_local-&gt;tx2
op_assign
id|send_length
suffix:semicolon
r_if
c_cond
(paren
id|ei_debug
op_logical_and
id|ei_local-&gt;tx1
OG
l_int|0
)paren
id|printk
c_func
(paren
l_string|&quot;%s: idle transmitter, tx1=%d, lasttx=%d, txing=%d.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|ei_local-&gt;tx1
comma
id|ei_local-&gt;lasttx
comma
id|ei_local-&gt;txing
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* We can get to here if we get an rx interrupt and queued&n;&t;       a tx packet just before masking 8390 irqs above. */
r_if
c_cond
(paren
id|ei_debug
OG
l_int|2
)paren
id|printk
c_func
(paren
l_string|&quot;%s: No packet buffer space for ping-pong use.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|ei_local-&gt;irqlock
op_assign
l_int|0
suffix:semicolon
id|dev-&gt;tbusy
op_assign
id|tmp_tbusy
suffix:semicolon
id|outb_p
c_func
(paren
id|ENISR_ALL
comma
id|e8390_base
op_plus
id|EN0_IMR
)paren
suffix:semicolon
id|sti
c_func
(paren
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
id|dev-&gt;trans_start
op_assign
id|jiffies
suffix:semicolon
id|ei_block_output
c_func
(paren
id|dev
comma
id|length
comma
(paren
r_int
r_char
op_star
)paren
(paren
id|skb
op_plus
l_int|1
)paren
comma
id|output_page
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ei_local-&gt;txing
)paren
(brace
id|NS8390_trigger_send
c_func
(paren
id|dev
comma
id|send_length
comma
id|output_page
)paren
suffix:semicolon
r_if
c_cond
(paren
id|output_page
op_eq
id|ei_local-&gt;tx_start_page
)paren
id|ei_local-&gt;tx1
op_assign
op_minus
l_int|1
comma
id|ei_local-&gt;lasttx
op_assign
op_minus
l_int|1
suffix:semicolon
r_else
id|ei_local-&gt;tx2
op_assign
op_minus
l_int|1
comma
id|ei_local-&gt;lasttx
op_assign
op_minus
l_int|2
suffix:semicolon
id|ei_local-&gt;txing
op_assign
l_int|1
suffix:semicolon
)brace
r_else
id|ei_local-&gt;txqueue
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|ei_local-&gt;tx1
op_logical_and
id|ei_local-&gt;tx2
)paren
id|tmp_tbusy
op_assign
l_int|1
suffix:semicolon
)brace
r_else
(brace
id|dev-&gt;trans_start
op_assign
id|jiffies
suffix:semicolon
id|ei_block_output
c_func
(paren
id|dev
comma
id|length
comma
(paren
r_int
r_char
op_star
)paren
(paren
id|skb
op_plus
l_int|1
)paren
comma
id|ei_local-&gt;tx_start_page
)paren
suffix:semicolon
id|NS8390_trigger_send
c_func
(paren
id|dev
comma
id|send_length
comma
id|ei_local-&gt;tx_start_page
)paren
suffix:semicolon
id|tmp_tbusy
op_assign
l_int|1
suffix:semicolon
)brace
multiline_comment|/* PINGPONG */
r_if
c_cond
(paren
id|skb-&gt;free
)paren
id|kfree_skb
(paren
id|skb
comma
id|FREE_WRITE
)paren
suffix:semicolon
multiline_comment|/* Turn 8390 interrupts back on. */
id|cli
c_func
(paren
)paren
suffix:semicolon
id|outb_p
c_func
(paren
id|ENISR_ALL
comma
id|e8390_base
op_plus
id|EN0_IMR
)paren
suffix:semicolon
id|ei_local-&gt;irqlock
op_assign
l_int|0
suffix:semicolon
id|dev-&gt;tbusy
op_assign
id|tmp_tbusy
suffix:semicolon
id|sti
c_func
(paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
"&f;"
multiline_comment|/* The typical workload of the driver:&n;   Handle the ether interface interrupts. */
r_void
DECL|function|ei_interrupt
id|ei_interrupt
c_func
(paren
r_int
id|reg_ptr
)paren
(brace
r_int
id|irq
op_assign
op_minus
(paren
(paren
(paren
r_struct
id|pt_regs
op_star
)paren
id|reg_ptr
)paren
op_member_access_from_pointer
id|orig_eax
op_plus
l_int|2
)paren
suffix:semicolon
r_struct
id|device
op_star
id|dev
op_assign
(paren
r_struct
id|device
op_star
)paren
(paren
id|irq2dev_map
(braket
id|irq
)braket
)paren
suffix:semicolon
r_int
id|e8390_base
suffix:semicolon
r_int
id|interrupts
comma
id|boguscount
op_assign
l_int|0
suffix:semicolon
r_struct
id|ei_device
op_star
id|ei_local
suffix:semicolon
r_if
c_cond
(paren
id|dev
op_eq
l_int|NULL
)paren
(brace
id|printk
(paren
l_string|&quot;net_interrupt(): irq %d for unknown device.&bslash;n&quot;
comma
id|irq
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|e8390_base
op_assign
id|dev-&gt;base_addr
suffix:semicolon
id|ei_local
op_assign
(paren
r_struct
id|ei_device
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;interrupt
op_logical_or
id|ei_local-&gt;irqlock
)paren
(brace
multiline_comment|/* The &quot;irqlock&quot; check is only for testing. */
id|sti
c_func
(paren
)paren
suffix:semicolon
id|printk
c_func
(paren
id|ei_local-&gt;irqlock
ques
c_cond
l_string|&quot;%s: Interrupted while interrupts are masked! isr=%#2x imr=%#2x.&bslash;n&quot;
suffix:colon
l_string|&quot;%s: Reentering the interrupt handler! isr=%#2x imr=%#2x.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|inb_p
c_func
(paren
id|e8390_base
op_plus
id|EN0_ISR
)paren
comma
id|inb_p
c_func
(paren
id|e8390_base
op_plus
id|EN0_IMR
)paren
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|dev-&gt;interrupt
op_assign
l_int|1
suffix:semicolon
id|sti
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* Allow other interrupts. */
multiline_comment|/* Change to page 0 and read the intr status reg. */
id|outb_p
c_func
(paren
id|E8390_NODMA
op_plus
id|E8390_PAGE0
comma
id|e8390_base
op_plus
id|E8390_CMD
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ei_debug
OG
l_int|3
)paren
id|printk
c_func
(paren
l_string|&quot;%s: interrupt(isr=%#2.2x).&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|inb_p
c_func
(paren
id|e8390_base
op_plus
id|EN0_ISR
)paren
)paren
suffix:semicolon
multiline_comment|/* !!Assumption!! -- we stay in page 0.  Don&squot;t break this. */
r_while
c_loop
(paren
(paren
id|interrupts
op_assign
id|inb_p
c_func
(paren
id|e8390_base
op_plus
id|EN0_ISR
)paren
)paren
op_ne
l_int|0
op_logical_and
op_increment
id|boguscount
OL
l_int|20
)paren
(brace
r_if
c_cond
(paren
id|interrupts
op_amp
id|ENISR_RDC
)paren
(brace
multiline_comment|/* Ack meaningless DMA complete. */
id|outb_p
c_func
(paren
id|ENISR_RDC
comma
id|e8390_base
op_plus
id|EN0_ISR
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|interrupts
op_amp
id|ENISR_OVER
)paren
(brace
id|ei_rx_overrun
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|interrupts
op_amp
(paren
id|ENISR_RX
op_plus
id|ENISR_RX_ERR
)paren
)paren
(brace
multiline_comment|/* Got a good (?) packet. */
id|ei_receive
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
multiline_comment|/* Push the next to-transmit packet through. */
r_if
c_cond
(paren
id|interrupts
op_amp
id|ENISR_TX
)paren
(brace
id|ei_tx_intr
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|interrupts
op_amp
id|ENISR_COUNTERS
)paren
(brace
r_struct
id|ei_device
op_star
id|ei_local
op_assign
(paren
r_struct
id|ei_device
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|ei_local-&gt;stat.rx_frame_errors
op_add_assign
id|inb_p
c_func
(paren
id|e8390_base
op_plus
id|EN0_COUNTER0
)paren
suffix:semicolon
id|ei_local-&gt;stat.rx_crc_errors
op_add_assign
id|inb_p
c_func
(paren
id|e8390_base
op_plus
id|EN0_COUNTER1
)paren
suffix:semicolon
id|ei_local-&gt;stat.rx_missed_errors
op_add_assign
id|inb_p
c_func
(paren
id|e8390_base
op_plus
id|EN0_COUNTER2
)paren
suffix:semicolon
id|outb_p
c_func
(paren
id|ENISR_COUNTERS
comma
id|e8390_base
op_plus
id|EN0_ISR
)paren
suffix:semicolon
multiline_comment|/* Ack intr. */
)brace
multiline_comment|/* Ignore the transmit errs and reset intr for now. */
r_if
c_cond
(paren
id|interrupts
op_amp
id|ENISR_TX_ERR
)paren
(brace
id|outb_p
c_func
(paren
id|ENISR_TX_ERR
comma
id|e8390_base
op_plus
id|EN0_ISR
)paren
suffix:semicolon
multiline_comment|/* Ack intr. */
)brace
id|outb_p
c_func
(paren
id|E8390_NODMA
op_plus
id|E8390_PAGE0
op_plus
id|E8390_START
comma
id|e8390_base
op_plus
id|E8390_CMD
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|interrupts
op_logical_and
id|ei_debug
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%s: unknown interrupt %#2x&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|interrupts
)paren
suffix:semicolon
id|outb_p
c_func
(paren
id|E8390_NODMA
op_plus
id|E8390_PAGE0
op_plus
id|E8390_START
comma
id|e8390_base
op_plus
id|E8390_CMD
)paren
suffix:semicolon
id|outb_p
c_func
(paren
l_int|0xff
comma
id|e8390_base
op_plus
id|EN0_ISR
)paren
suffix:semicolon
multiline_comment|/* Ack. all intrs. */
)brace
id|dev-&gt;interrupt
op_assign
l_int|0
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/* We have finished a transmit: check for errors and then trigger the next&n;   packet to be sent. */
r_static
r_void
DECL|function|ei_tx_intr
id|ei_tx_intr
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
r_int
id|e8390_base
op_assign
id|dev-&gt;base_addr
suffix:semicolon
r_int
id|status
op_assign
id|inb
c_func
(paren
id|e8390_base
op_plus
id|EN0_TSR
)paren
suffix:semicolon
r_struct
id|ei_device
op_star
id|ei_local
op_assign
(paren
r_struct
id|ei_device
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|outb_p
c_func
(paren
id|ENISR_TX
comma
id|e8390_base
op_plus
id|EN0_ISR
)paren
suffix:semicolon
multiline_comment|/* Ack intr. */
r_if
c_cond
(paren
id|ei_local-&gt;pingpong
)paren
(brace
id|ei_local-&gt;txqueue
op_decrement
suffix:semicolon
r_if
c_cond
(paren
id|ei_local-&gt;tx1
OL
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|ei_local-&gt;lasttx
op_ne
l_int|1
op_logical_and
id|ei_local-&gt;lasttx
op_ne
op_minus
l_int|1
)paren
id|printk
c_func
(paren
l_string|&quot;%s: bogus last_tx_buffer %d, tx1=%d.&bslash;n&quot;
comma
id|ei_local-&gt;name
comma
id|ei_local-&gt;lasttx
comma
id|ei_local-&gt;tx1
)paren
suffix:semicolon
id|ei_local-&gt;tx1
op_assign
l_int|0
suffix:semicolon
id|dev-&gt;tbusy
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|ei_local-&gt;tx2
OG
l_int|0
)paren
(brace
id|NS8390_trigger_send
c_func
(paren
id|dev
comma
id|ei_local-&gt;tx2
comma
id|ei_local-&gt;tx_start_page
op_plus
l_int|6
)paren
suffix:semicolon
id|dev-&gt;trans_start
op_assign
id|jiffies
suffix:semicolon
id|ei_local-&gt;txing
op_assign
l_int|1
suffix:semicolon
id|ei_local-&gt;tx2
op_assign
op_minus
l_int|1
comma
id|ei_local-&gt;lasttx
op_assign
l_int|2
suffix:semicolon
)brace
r_else
id|ei_local-&gt;lasttx
op_assign
l_int|20
comma
id|ei_local-&gt;txing
op_assign
l_int|0
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|ei_local-&gt;tx2
OL
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|ei_local-&gt;lasttx
op_ne
l_int|2
op_logical_and
id|ei_local-&gt;lasttx
op_ne
op_minus
l_int|2
)paren
id|printk
c_func
(paren
l_string|&quot;%s: bogus last_tx_buffer %d, tx2=%d.&bslash;n&quot;
comma
id|ei_local-&gt;name
comma
id|ei_local-&gt;lasttx
comma
id|ei_local-&gt;tx2
)paren
suffix:semicolon
id|ei_local-&gt;tx2
op_assign
l_int|0
suffix:semicolon
id|dev-&gt;tbusy
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|ei_local-&gt;tx1
OG
l_int|0
)paren
(brace
id|NS8390_trigger_send
c_func
(paren
id|dev
comma
id|ei_local-&gt;tx1
comma
id|ei_local-&gt;tx_start_page
)paren
suffix:semicolon
id|dev-&gt;trans_start
op_assign
id|jiffies
suffix:semicolon
id|ei_local-&gt;txing
op_assign
l_int|1
suffix:semicolon
id|ei_local-&gt;tx1
op_assign
op_minus
l_int|1
suffix:semicolon
id|ei_local-&gt;lasttx
op_assign
l_int|1
suffix:semicolon
)brace
r_else
id|ei_local-&gt;lasttx
op_assign
l_int|10
comma
id|ei_local-&gt;txing
op_assign
l_int|0
suffix:semicolon
)brace
r_else
id|printk
c_func
(paren
l_string|&quot;%s: unexpected TX-done interrupt, lasttx=%d.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|ei_local-&gt;lasttx
)paren
suffix:semicolon
)brace
r_else
(brace
id|ei_local-&gt;txing
op_assign
l_int|0
suffix:semicolon
id|dev-&gt;tbusy
op_assign
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Do the statistics _after_ we start the next TX. */
r_if
c_cond
(paren
id|status
op_amp
id|ENTSR_PTX
)paren
id|ei_local-&gt;stat.tx_packets
op_increment
suffix:semicolon
r_else
id|ei_local-&gt;stat.tx_errors
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
id|ENTSR_COL
)paren
id|ei_local-&gt;stat.collisions
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
id|ENTSR_ABT
)paren
id|ei_local-&gt;stat.tx_aborted_errors
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
id|ENTSR_CRS
)paren
id|ei_local-&gt;stat.tx_carrier_errors
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
id|ENTSR_FU
)paren
id|ei_local-&gt;stat.tx_fifo_errors
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
id|ENTSR_CDH
)paren
id|ei_local-&gt;stat.tx_heartbeat_errors
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
id|ENTSR_OWC
)paren
id|ei_local-&gt;stat.tx_window_errors
op_increment
suffix:semicolon
id|mark_bh
(paren
id|INET_BH
)paren
suffix:semicolon
)brace
multiline_comment|/* We have a good packet(s), get it/them out of the buffers. */
r_static
r_void
DECL|function|ei_receive
id|ei_receive
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
r_int
id|e8390_base
op_assign
id|dev-&gt;base_addr
suffix:semicolon
r_struct
id|ei_device
op_star
id|ei_local
op_assign
(paren
r_struct
id|ei_device
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_int
id|rxing_page
comma
id|this_frame
comma
id|next_frame
comma
id|current_offset
suffix:semicolon
r_int
id|boguscount
op_assign
l_int|0
suffix:semicolon
r_struct
id|e8390_pkt_hdr
id|rx_frame
suffix:semicolon
r_int
id|num_rx_pages
op_assign
id|ei_local-&gt;stop_page
op_minus
id|ei_local-&gt;rx_start_page
suffix:semicolon
r_while
c_loop
(paren
op_increment
id|boguscount
OL
l_int|10
)paren
(brace
r_int
id|size
suffix:semicolon
multiline_comment|/* Get the rx page (incoming packet pointer). */
id|outb_p
c_func
(paren
id|E8390_NODMA
op_plus
id|E8390_PAGE1
comma
id|e8390_base
op_plus
id|E8390_CMD
)paren
suffix:semicolon
id|rxing_page
op_assign
id|inb_p
c_func
(paren
id|e8390_base
op_plus
id|EN1_CURPAG
)paren
suffix:semicolon
id|outb_p
c_func
(paren
id|E8390_NODMA
op_plus
id|E8390_PAGE0
comma
id|e8390_base
op_plus
id|E8390_CMD
)paren
suffix:semicolon
multiline_comment|/* Remove one frame from the ring.  Boundary is alway a page behind. */
id|this_frame
op_assign
id|inb_p
c_func
(paren
id|e8390_base
op_plus
id|EN0_BOUNDARY
)paren
op_plus
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|this_frame
op_ge
id|ei_local-&gt;stop_page
)paren
id|this_frame
op_assign
id|ei_local-&gt;rx_start_page
suffix:semicolon
multiline_comment|/* Someday we&squot;ll omit the previous step, iff we never get this message.*/
r_if
c_cond
(paren
id|ei_debug
OG
l_int|0
op_logical_and
id|this_frame
op_ne
id|ei_local-&gt;current_page
)paren
id|printk
c_func
(paren
l_string|&quot;%s: mismatched read page pointers %2x vs %2x.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|this_frame
comma
id|ei_local-&gt;current_page
)paren
suffix:semicolon
r_if
c_cond
(paren
id|this_frame
op_eq
id|rxing_page
)paren
multiline_comment|/* Read all the frames? */
r_break
suffix:semicolon
multiline_comment|/* Done for now */
id|current_offset
op_assign
id|this_frame
op_lshift
l_int|8
suffix:semicolon
id|ei_block_input
c_func
(paren
id|dev
comma
r_sizeof
(paren
id|rx_frame
)paren
comma
(paren
r_char
op_star
)paren
op_amp
id|rx_frame
comma
id|current_offset
)paren
suffix:semicolon
id|size
op_assign
id|rx_frame.count
op_minus
r_sizeof
(paren
id|rx_frame
)paren
suffix:semicolon
id|next_frame
op_assign
id|this_frame
op_plus
l_int|1
op_plus
(paren
(paren
id|size
op_plus
l_int|4
)paren
op_rshift
l_int|8
)paren
suffix:semicolon
multiline_comment|/* Check for bogosity warned by 3c503 book: the status byte is never&n;&t; written.  This happened a lot during testing! This code should be&n;&t; cleaned up someday, and the printk()s should be PRINTK()s. */
r_if
c_cond
(paren
id|rx_frame.next
op_ne
id|next_frame
op_logical_and
id|rx_frame.next
op_ne
id|next_frame
op_plus
l_int|1
op_logical_and
id|rx_frame.next
op_ne
id|next_frame
op_minus
id|num_rx_pages
op_logical_and
id|rx_frame.next
op_ne
id|next_frame
op_plus
l_int|1
op_minus
id|num_rx_pages
)paren
(brace
macro_line|#ifndef EI_DEBUG
id|ei_local-&gt;current_page
op_assign
id|rxing_page
suffix:semicolon
id|outb
c_func
(paren
id|ei_local-&gt;current_page
op_minus
l_int|1
comma
id|e8390_base
op_plus
id|EN0_BOUNDARY
)paren
suffix:semicolon
r_continue
suffix:semicolon
macro_line|#else
r_static
r_int
id|last_rx_bogosity
op_assign
op_minus
l_int|1
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;%s: bogus packet header, status=%#2x nxpg=%#2x sz=%#x (at %#4x)&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|rx_frame.status
comma
id|rx_frame.next
comma
id|rx_frame.count
comma
id|current_offset
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ei_local-&gt;stat.rx_packets
op_ne
id|last_rx_bogosity
)paren
(brace
multiline_comment|/* Maybe we can avoid resetting the chip... empty the packet ring. */
id|ei_local-&gt;current_page
op_assign
id|rxing_page
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;%s:   setting next frame to %#2x (nxt=%#2x, rx_frm.nx=%#2x rx_frm.stat=%#2x).&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|ei_local-&gt;current_page
comma
id|next_frame
comma
id|rx_frame.next
comma
id|rx_frame.status
)paren
suffix:semicolon
id|last_rx_bogosity
op_assign
id|ei_local-&gt;stat.rx_packets
suffix:semicolon
id|outb
c_func
(paren
id|ei_local-&gt;current_page
op_minus
l_int|1
comma
id|e8390_base
op_plus
id|EN0_BOUNDARY
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* Oh no Mr Bill! Last ditch error recovery. */
id|printk
c_func
(paren
l_string|&quot;%s: recovery failed, resetting at packet #%d..&quot;
comma
id|dev-&gt;name
comma
id|ei_local-&gt;stat.rx_packets
)paren
suffix:semicolon
id|sti
c_func
(paren
)paren
suffix:semicolon
id|ei_reset_8390
c_func
(paren
id|dev
)paren
suffix:semicolon
id|NS8390_init
c_func
(paren
id|dev
comma
l_int|1
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;restarting.&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
macro_line|#endif  /* EI8390_NOCHECK */
)brace
r_if
c_cond
(paren
(paren
id|size
template_param
l_int|1535
)paren
op_logical_and
id|ei_debug
)paren
id|printk
c_func
(paren
l_string|&quot;%s: bogus packet size, status=%#2x nxpg=%#2x size=%#x&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|rx_frame.status
comma
id|rx_frame.next
comma
id|rx_frame.count
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|rx_frame.status
op_amp
l_int|0x0F
)paren
op_eq
id|ENRSR_RXOK
)paren
(brace
r_int
id|sksize
op_assign
r_sizeof
(paren
r_struct
id|sk_buff
)paren
op_plus
id|size
suffix:semicolon
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
id|skb
op_assign
(paren
r_struct
id|sk_buff
op_star
)paren
id|kmalloc
c_func
(paren
id|sksize
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
id|skb
op_ne
l_int|NULL
)paren
(brace
id|skb-&gt;lock
op_assign
l_int|0
suffix:semicolon
id|skb-&gt;mem_len
op_assign
id|sksize
suffix:semicolon
id|skb-&gt;mem_addr
op_assign
id|skb
suffix:semicolon
multiline_comment|/* &squot;skb+1&squot; points to the start of sk_buff data area. */
id|ei_block_input
c_func
(paren
id|dev
comma
id|size
comma
(paren
r_char
op_star
)paren
(paren
id|skb
op_plus
l_int|1
)paren
comma
id|current_offset
op_plus
r_sizeof
(paren
id|rx_frame
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dev_rint
c_func
(paren
(paren
r_int
r_char
op_star
)paren
id|skb
comma
id|size
comma
id|IN_SKBUFF
comma
id|dev
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%s: receive buffers full.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|kfree_s
c_func
(paren
id|skb
comma
id|sksize
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
r_else
r_if
c_cond
(paren
id|ei_debug
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%s: Couldn&squot;t allocate a sk_buff of size %d.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|sksize
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|ei_local-&gt;stat.rx_packets
op_increment
suffix:semicolon
)brace
r_else
(brace
r_int
id|errs
op_assign
id|rx_frame.status
suffix:semicolon
r_if
c_cond
(paren
id|ei_debug
)paren
id|printk
c_func
(paren
l_string|&quot;%s: bogus packet, status=%#2x nxpg=%#2x size=%d&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|rx_frame.status
comma
id|rx_frame.next
comma
id|rx_frame.count
)paren
suffix:semicolon
r_if
c_cond
(paren
id|errs
op_amp
id|ENRSR_FO
)paren
id|ei_local-&gt;stat.rx_fifo_errors
op_increment
suffix:semicolon
)brace
id|next_frame
op_assign
id|rx_frame.next
suffix:semicolon
multiline_comment|/* This should never happen, it&squot;s here for debugging. */
r_if
c_cond
(paren
id|next_frame
op_ge
id|ei_local-&gt;stop_page
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%s: next frame inconsistency, %#2x..&quot;
comma
id|dev-&gt;name
comma
id|next_frame
)paren
suffix:semicolon
id|next_frame
op_assign
id|ei_local-&gt;rx_start_page
suffix:semicolon
)brace
id|ei_local-&gt;current_page
op_add_assign
l_int|1
op_plus
(paren
(paren
id|size
op_plus
l_int|4
)paren
op_rshift
l_int|8
)paren
suffix:semicolon
id|ei_local-&gt;current_page
op_assign
id|next_frame
suffix:semicolon
id|outb
c_func
(paren
id|next_frame
op_minus
l_int|1
comma
id|e8390_base
op_plus
id|EN0_BOUNDARY
)paren
suffix:semicolon
)brace
multiline_comment|/* If any worth-while packets have been received, dev_rint()&n;       has done a mark_bh(INET_BH) for us and will work on them&n;       when we get to the bottom-half routine. */
multiline_comment|/* Bug alert!  Reset ENISR_OVER to avoid spurious overruns! */
id|outb_p
c_func
(paren
id|ENISR_RX
op_plus
id|ENISR_RX_ERR
op_plus
id|ENISR_OVER
comma
id|e8390_base
op_plus
id|EN0_ISR
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/* We have a receiver overrun: we have to kick the 8390 to get it started&n;   again.*/
r_static
r_void
DECL|function|ei_rx_overrun
id|ei_rx_overrun
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
r_int
id|e8390_base
op_assign
id|dev-&gt;base_addr
suffix:semicolon
r_int
id|reset_start_time
op_assign
id|jiffies
suffix:semicolon
r_struct
id|ei_device
op_star
id|ei_local
op_assign
(paren
r_struct
id|ei_device
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
multiline_comment|/* We should already be stopped and in page0.  Remove after testing. */
id|outb_p
c_func
(paren
id|E8390_NODMA
op_plus
id|E8390_PAGE0
op_plus
id|E8390_STOP
comma
id|e8390_base
op_plus
id|E8390_CMD
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ei_debug
)paren
id|printk
c_func
(paren
l_string|&quot;%s: Receiver overrun.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|ei_local-&gt;stat.rx_over_errors
op_increment
suffix:semicolon
multiline_comment|/* The we.c driver does dummy = inb_p( RBCR[01] ); at this point.&n;       It might mean something -- magic to speed up a reset?  A 8390 bug?*/
multiline_comment|/* Wait for reset in case the NIC is doing a tx or rx.  This could take up to&n;       1.5msec, but we have no way of timing something in that range.  The &squot;jiffies&squot;&n;       are just a sanity check. */
r_while
c_loop
(paren
(paren
id|inb_p
c_func
(paren
id|e8390_base
op_plus
id|EN0_ISR
)paren
op_amp
id|ENISR_RESET
)paren
op_eq
l_int|0
)paren
r_if
c_cond
(paren
id|jiffies
op_minus
id|reset_start_time
OG
l_int|1
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%s: reset did not complete at ei_rx_overrun.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|NS8390_init
c_func
(paren
id|dev
comma
l_int|1
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
suffix:semicolon
multiline_comment|/* Remove packets right away. */
id|ei_receive
c_func
(paren
id|dev
)paren
suffix:semicolon
id|outb_p
c_func
(paren
l_int|0xff
comma
id|e8390_base
op_plus
id|EN0_ISR
)paren
suffix:semicolon
multiline_comment|/* Generic 8390 insns to start up again, same as in open_8390(). */
id|outb_p
c_func
(paren
id|E8390_NODMA
op_plus
id|E8390_PAGE0
op_plus
id|E8390_START
comma
id|e8390_base
op_plus
id|E8390_CMD
)paren
suffix:semicolon
id|outb_p
c_func
(paren
id|E8390_TXCONFIG
comma
id|e8390_base
op_plus
id|EN0_TXCR
)paren
suffix:semicolon
multiline_comment|/* xmit on. */
)brace
r_static
r_struct
id|enet_statistics
op_star
DECL|function|get_stats
id|get_stats
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
r_struct
id|ei_device
op_star
id|ei_local
op_assign
(paren
r_struct
id|ei_device
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_return
op_amp
id|ei_local-&gt;stat
suffix:semicolon
)brace
multiline_comment|/* Initialize the rest of the 8390 device structure. */
r_int
DECL|function|ethdev_init
id|ethdev_init
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
r_int
id|i
suffix:semicolon
r_if
c_cond
(paren
id|ei_debug
OG
l_int|1
)paren
id|printk
c_func
(paren
id|version
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|DEV_NUMBUFFS
suffix:semicolon
id|i
op_increment
)paren
id|dev-&gt;buffs
(braket
id|i
)braket
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/* The open call may be overridden by the card-specific code. */
r_if
c_cond
(paren
id|dev-&gt;open
op_eq
l_int|NULL
)paren
id|dev-&gt;open
op_assign
op_amp
id|ei_open
suffix:semicolon
id|dev-&gt;get_stats
op_assign
id|get_stats
suffix:semicolon
id|dev-&gt;hard_header
op_assign
id|eth_header
suffix:semicolon
id|dev-&gt;add_arp
op_assign
id|eth_add_arp
suffix:semicolon
id|dev-&gt;queue_xmit
op_assign
id|dev_queue_xmit
suffix:semicolon
id|dev-&gt;rebuild_header
op_assign
id|eth_rebuild_header
suffix:semicolon
id|dev-&gt;type_trans
op_assign
id|eth_type_trans
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;priv
op_eq
l_int|NULL
)paren
(brace
r_struct
id|ei_device
op_star
id|ei_local
suffix:semicolon
id|dev-&gt;priv
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|ei_device
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
id|memset
c_func
(paren
id|dev-&gt;priv
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|ei_device
)paren
)paren
suffix:semicolon
id|ei_local
op_assign
(paren
r_struct
id|ei_device
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
macro_line|#ifndef NO_PINGPONG
id|ei_local-&gt;pingpong
op_assign
l_int|1
suffix:semicolon
macro_line|#endif
)brace
id|dev-&gt;hard_start_xmit
op_assign
op_amp
id|ei_start_xmit
suffix:semicolon
id|dev-&gt;type
op_assign
id|ARPHRD_ETHER
suffix:semicolon
id|dev-&gt;hard_header_len
op_assign
id|ETH_HLEN
suffix:semicolon
id|dev-&gt;mtu
op_assign
l_int|1500
suffix:semicolon
multiline_comment|/* eth_mtu */
id|dev-&gt;addr_len
op_assign
id|ETH_ALEN
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|dev-&gt;addr_len
suffix:semicolon
id|i
op_increment
)paren
(brace
id|dev-&gt;broadcast
(braket
id|i
)braket
op_assign
l_int|0xff
suffix:semicolon
)brace
multiline_comment|/* New-style flags. */
id|dev-&gt;flags
op_assign
id|IFF_BROADCAST
suffix:semicolon
id|dev-&gt;family
op_assign
id|AF_INET
suffix:semicolon
id|dev-&gt;pa_addr
op_assign
l_int|0
suffix:semicolon
id|dev-&gt;pa_brdaddr
op_assign
l_int|0
suffix:semicolon
id|dev-&gt;pa_mask
op_assign
l_int|0
suffix:semicolon
id|dev-&gt;pa_alen
op_assign
r_sizeof
(paren
r_int
r_int
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
"&f;"
multiline_comment|/* This page of functions should be 8390 generic */
multiline_comment|/* Follow National Semi&squot;s recommendations for initializing the &quot;NIC&quot;. */
DECL|function|NS8390_init
r_void
id|NS8390_init
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
r_int
id|startp
)paren
(brace
r_int
id|e8390_base
op_assign
id|dev-&gt;base_addr
suffix:semicolon
r_struct
id|ei_device
op_star
id|ei_local
op_assign
(paren
r_struct
id|ei_device
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_int
id|i
suffix:semicolon
r_int
id|endcfg
op_assign
id|ei_local-&gt;word16
ques
c_cond
(paren
l_int|0x48
op_or
id|ENDCFG_WTS
)paren
suffix:colon
l_int|0x48
suffix:semicolon
multiline_comment|/* Follow National Semi&squot;s recommendations for initing the DP83902. */
id|outb_p
c_func
(paren
id|E8390_NODMA
op_plus
id|E8390_PAGE0
op_plus
id|E8390_STOP
comma
id|e8390_base
)paren
suffix:semicolon
multiline_comment|/* 0x21 */
id|outb_p
c_func
(paren
id|endcfg
comma
id|e8390_base
op_plus
id|EN0_DCFG
)paren
suffix:semicolon
multiline_comment|/* 0x48 or 0x49 */
multiline_comment|/* Clear the remote byte count registers. */
id|outb_p
c_func
(paren
l_int|0x00
comma
id|e8390_base
op_plus
id|EN0_RCNTLO
)paren
suffix:semicolon
id|outb_p
c_func
(paren
l_int|0x00
comma
id|e8390_base
op_plus
id|EN0_RCNTHI
)paren
suffix:semicolon
multiline_comment|/* Set to monitor and loopback mode -- this is vital!. */
id|outb_p
c_func
(paren
id|E8390_RXOFF
comma
id|e8390_base
op_plus
id|EN0_RXCR
)paren
suffix:semicolon
multiline_comment|/* 0x20 */
id|outb_p
c_func
(paren
id|E8390_TXOFF
comma
id|e8390_base
op_plus
id|EN0_TXCR
)paren
suffix:semicolon
multiline_comment|/* 0x02 */
multiline_comment|/* Set the transmit page and receive ring. */
id|outb_p
c_func
(paren
id|ei_local-&gt;tx_start_page
comma
id|e8390_base
op_plus
id|EN0_TPSR
)paren
suffix:semicolon
id|ei_local-&gt;tx1
op_assign
id|ei_local-&gt;tx2
op_assign
l_int|0
suffix:semicolon
id|outb_p
c_func
(paren
id|ei_local-&gt;rx_start_page
comma
id|e8390_base
op_plus
id|EN0_STARTPG
)paren
suffix:semicolon
id|outb_p
c_func
(paren
id|ei_local-&gt;stop_page
op_minus
l_int|1
comma
id|e8390_base
op_plus
id|EN0_BOUNDARY
)paren
suffix:semicolon
multiline_comment|/* 3c503 says 0x3f,NS0x26*/
id|ei_local-&gt;current_page
op_assign
id|ei_local-&gt;rx_start_page
suffix:semicolon
multiline_comment|/* assert boundary+1 */
id|outb_p
c_func
(paren
id|ei_local-&gt;stop_page
comma
id|e8390_base
op_plus
id|EN0_STOPPG
)paren
suffix:semicolon
multiline_comment|/* Clear the pending interrupts and mask. */
id|outb_p
c_func
(paren
l_int|0xFF
comma
id|e8390_base
op_plus
id|EN0_ISR
)paren
suffix:semicolon
id|outb_p
c_func
(paren
l_int|0x00
comma
id|e8390_base
op_plus
id|EN0_IMR
)paren
suffix:semicolon
multiline_comment|/* Copy the station address into the DS8390 registers,&n;       and set the multicast hash bitmap to receive all multicasts. */
id|cli
c_func
(paren
)paren
suffix:semicolon
id|outb_p
c_func
(paren
id|E8390_NODMA
op_plus
id|E8390_PAGE1
op_plus
id|E8390_STOP
comma
id|e8390_base
)paren
suffix:semicolon
multiline_comment|/* 0x61 */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|6
suffix:semicolon
id|i
op_increment
)paren
(brace
id|outb_p
c_func
(paren
id|dev-&gt;dev_addr
(braket
id|i
)braket
comma
id|e8390_base
op_plus
id|EN1_PHYS
op_plus
id|i
)paren
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|8
suffix:semicolon
id|i
op_increment
)paren
(brace
id|outb_p
c_func
(paren
l_int|0xff
comma
id|e8390_base
op_plus
id|EN1_MULT
op_plus
id|i
)paren
suffix:semicolon
)brace
id|outb_p
c_func
(paren
id|ei_local-&gt;rx_start_page
comma
id|e8390_base
op_plus
id|EN1_CURPAG
)paren
suffix:semicolon
id|outb_p
c_func
(paren
id|E8390_NODMA
op_plus
id|E8390_PAGE0
op_plus
id|E8390_STOP
comma
id|e8390_base
)paren
suffix:semicolon
id|sti
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|startp
)paren
(brace
id|outb_p
c_func
(paren
l_int|0xff
comma
id|e8390_base
op_plus
id|EN0_ISR
)paren
suffix:semicolon
id|outb_p
c_func
(paren
id|ENISR_ALL
comma
id|e8390_base
op_plus
id|EN0_IMR
)paren
suffix:semicolon
id|outb_p
c_func
(paren
id|E8390_NODMA
op_plus
id|E8390_PAGE0
op_plus
id|E8390_START
comma
id|e8390_base
)paren
suffix:semicolon
id|outb_p
c_func
(paren
id|E8390_TXCONFIG
comma
id|e8390_base
op_plus
id|EN0_TXCR
)paren
suffix:semicolon
multiline_comment|/* xmit on. */
multiline_comment|/* 3c503 TechMan says rxconfig only after the NIC is started. */
id|outb_p
c_func
(paren
id|E8390_RXCONFIG
comma
id|e8390_base
op_plus
id|EN0_RXCR
)paren
suffix:semicolon
multiline_comment|/* rx on,  */
)brace
r_return
suffix:semicolon
)brace
multiline_comment|/* Trigger a transmit start, assuming the length is valid. */
DECL|function|NS8390_trigger_send
r_static
r_void
id|NS8390_trigger_send
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
r_int
r_int
id|length
comma
r_int
id|start_page
)paren
(brace
r_int
id|e8390_base
op_assign
id|dev-&gt;base_addr
suffix:semicolon
id|ei_status.txing
op_assign
l_int|1
suffix:semicolon
id|outb_p
c_func
(paren
id|E8390_NODMA
op_plus
id|E8390_PAGE0
comma
id|e8390_base
)paren
suffix:semicolon
r_if
c_cond
(paren
id|inb_p
c_func
(paren
id|e8390_base
)paren
op_amp
id|E8390_TRANS
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%s: trigger_send() called with the transmitter busy.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|outb_p
c_func
(paren
id|length
op_amp
l_int|0xff
comma
id|e8390_base
op_plus
id|EN0_TCNTLO
)paren
suffix:semicolon
id|outb_p
c_func
(paren
id|length
op_rshift
l_int|8
comma
id|e8390_base
op_plus
id|EN0_TCNTHI
)paren
suffix:semicolon
id|outb_p
c_func
(paren
id|start_page
comma
id|e8390_base
op_plus
id|EN0_TPSR
)paren
suffix:semicolon
id|outb_p
c_func
(paren
id|E8390_NODMA
op_plus
id|E8390_TRANS
op_plus
id|E8390_START
comma
id|e8390_base
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
"&f;"
multiline_comment|/*&n; * Local variables:&n; *  compile-command: &quot;gcc -D__KERNEL__ -Wall -O6 -x c++ -c 8390.c&quot;&n; *  version-control: t&n; *  kept-new-versions: 5&n; * End:&n; */
eof
