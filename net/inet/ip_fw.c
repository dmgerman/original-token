multiline_comment|/*&n; *&t;IP firewalling code. This is taken from 4.4BSD. Please note the &n; *&t;copyright message below. As per the GPL it must be maintained&n; *&t;and the licenses thus do not conflict. While this port is subject&n; *&t;to the GPL I also place my modifications under the original &n; *&t;license in recognition of the original copyright. &n; *&n; *&t;Ported from BSD to Linux,&n; *&t;&t;Alan Cox 22/Nov/1994.&n; *&n; *&t;All the real work was done by .....&n; */
multiline_comment|/*&n; * Copyright (c) 1993 Daniel Boulet&n; * Copyright (c) 1994 Ugen J.S.Antsilevich&n; *&n; * Redistribution and use in source forms, with and without modification,&n; * are permitted provided that this entire comment appears intact.&n; *&n; * Redistribution in binary form may occur without any restrictions.&n; * Obviously, it would be nice if you gave credit where credit is due&n; * but requiring it would be too onerous.&n; *&n; * This software is provided ``AS IS&squot;&squot; without any warranties of any kind.&n; */
macro_line|#include &lt;asm/segment.h&gt;
macro_line|#include &lt;asm/system.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/socket.h&gt;
macro_line|#include &lt;linux/sockios.h&gt;
macro_line|#include &lt;linux/in.h&gt;
macro_line|#include &lt;linux/inet.h&gt;
macro_line|#include &lt;linux/netdevice.h&gt;
macro_line|#include &quot;ip.h&quot;
macro_line|#include &quot;protocol.h&quot;
macro_line|#include &quot;route.h&quot;
macro_line|#include &quot;tcp.h&quot;
macro_line|#include &lt;linux/skbuff.h&gt;
macro_line|#include &quot;sock.h&quot;
macro_line|#include &quot;icmp.h&quot;
macro_line|#include &lt;linux/ip_fw.h&gt;
multiline_comment|/*&n; *&t;Implement IP packet firewall&n; */
macro_line|#ifdef CONFIG_IP_FIREWALL
DECL|variable|ip_fw_fwd_chain
r_struct
id|ip_fw
op_star
id|ip_fw_fwd_chain
suffix:semicolon
DECL|variable|ip_fw_blk_chain
r_struct
id|ip_fw
op_star
id|ip_fw_blk_chain
suffix:semicolon
DECL|variable|ip_fw_policy
r_static
r_int
id|ip_fw_policy
op_assign
l_int|1
suffix:semicolon
macro_line|#endif
macro_line|#ifdef CONFIG_IP_ACCT
DECL|variable|ip_acct_chain
r_struct
id|ip_fw
op_star
id|ip_acct_chain
suffix:semicolon
macro_line|#endif
DECL|function|print_ip
r_extern
r_inline
r_void
id|print_ip
c_func
(paren
r_int
r_int
id|xaddr
)paren
(brace
r_int
r_int
id|addr
op_assign
id|ntohl
c_func
(paren
id|xaddr
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;%ld.%ld.%ld.%ld&quot;
comma
(paren
id|addr
op_rshift
l_int|24
)paren
op_amp
l_int|0xff
comma
(paren
id|addr
op_rshift
l_int|16
)paren
op_amp
l_int|0xff
comma
(paren
id|addr
op_rshift
l_int|8
)paren
op_amp
l_int|0xff
comma
id|addr
op_amp
l_int|0xFF
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;Returns 1 if the port is matched by the vector, 0 otherwise&n; */
DECL|function|port_match
r_extern
r_inline
r_int
id|port_match
c_func
(paren
r_int
r_int
op_star
id|portptr
comma
r_int
id|nports
comma
r_int
r_int
id|port
comma
r_int
id|range_flag
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|nports
)paren
r_return
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|range_flag
)paren
(brace
r_if
c_cond
(paren
id|portptr
(braket
l_int|0
)braket
op_le
id|port
op_logical_and
id|port
op_le
id|portptr
(braket
l_int|1
)braket
)paren
(brace
r_return
l_int|1
suffix:semicolon
)brace
id|nports
op_sub_assign
l_int|2
suffix:semicolon
id|portptr
op_add_assign
l_int|2
suffix:semicolon
)brace
r_while
c_loop
(paren
id|nports
op_decrement
OG
l_int|0
)paren
(brace
r_if
c_cond
(paren
op_star
id|portptr
op_increment
op_eq
id|port
)paren
(brace
r_return
l_int|1
suffix:semicolon
)brace
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;Returns 0 if packet should be dropped, 1 or more if it should be accepted&n; */
macro_line|#ifdef CONFIG_IP_FIREWALL
DECL|function|ip_fw_chk
r_int
id|ip_fw_chk
c_func
(paren
r_struct
id|iphdr
op_star
id|ip
comma
r_struct
id|ip_fw
op_star
id|chain
)paren
(brace
r_int
r_int
id|src
comma
id|dst
suffix:semicolon
r_char
id|got_proto
op_assign
l_int|0
suffix:semicolon
r_int
id|frwl_proto
comma
id|proto
op_assign
l_int|0
suffix:semicolon
r_struct
id|ip_fw
op_star
id|f
suffix:semicolon
r_int
r_int
id|src_port
op_assign
l_int|0
comma
id|dst_port
op_assign
l_int|0
suffix:semicolon
r_int
r_int
op_star
id|portptr
op_assign
(paren
r_int
r_int
op_star
)paren
op_amp
(paren
(paren
(paren
id|u_int
op_star
)paren
id|ip
)paren
(braket
id|ip-&gt;ihl
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|chain
)paren
r_return
l_int|1
suffix:semicolon
multiline_comment|/* If no chain , always say Ok to packet */
id|src
op_assign
id|ip-&gt;saddr
suffix:semicolon
id|dst
op_assign
id|ip-&gt;daddr
suffix:semicolon
macro_line|#ifdef DEBUG_CONFIG_IP_FIREWALL
(brace
id|printk
c_func
(paren
l_string|&quot;packet &quot;
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|ip-&gt;protocol
)paren
(brace
r_case
id|IPPROTO_TCP
suffix:colon
id|printf
c_func
(paren
l_string|&quot;TCP &quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|IPPROTO_UDP
suffix:colon
id|printf
c_func
(paren
l_string|&quot;UDP &quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|IPPROTO_ICMP
suffix:colon
id|printf
c_func
(paren
l_string|&quot;ICMP:%d &quot;
comma
(paren
(paren
r_char
op_star
)paren
id|portptr
)paren
(braket
l_int|0
)braket
op_amp
l_int|0xff
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|printf
c_func
(paren
l_string|&quot;p=%d &quot;
comma
id|ip-&gt;protocol
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|print_ip
c_func
(paren
id|ip-&gt;saddr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ip-&gt;protocol
op_eq
id|IPPROTO_TCP
op_logical_or
id|ip-&gt;protocol
op_eq
id|IPPROTO_UDP
)paren
(brace
id|printf
c_func
(paren
l_string|&quot;:%d &quot;
comma
id|ntohs
c_func
(paren
id|portptr
(braket
l_int|0
)braket
)paren
)paren
suffix:semicolon
)brace
id|print_ip
c_func
(paren
id|ip-&gt;daddr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ip-&gt;protocol
op_eq
id|IPPROTO_TCP
op_logical_or
id|ip-&gt;protocol
op_eq
id|IPPROTO_UDP
)paren
(brace
id|printf
c_func
(paren
l_string|&quot;:%d &quot;
comma
id|ntohs
c_func
(paren
id|portptr
(braket
l_int|1
)braket
)paren
)paren
suffix:semicolon
)brace
id|printf
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
)brace
macro_line|#endif
r_for
c_loop
(paren
id|f
op_assign
id|chain
suffix:semicolon
id|f
suffix:semicolon
id|f
op_assign
id|f-&gt;next
)paren
(brace
r_if
c_cond
(paren
(paren
id|src
op_amp
id|f-&gt;src_mask.s_addr
)paren
op_eq
id|f-&gt;src.s_addr
op_logical_and
(paren
id|dst
op_amp
id|f-&gt;dst_mask.s_addr
)paren
op_eq
id|f-&gt;dst.s_addr
)paren
(brace
id|frwl_proto
op_assign
id|f-&gt;flags
op_amp
id|IP_FW_F_KIND
suffix:semicolon
r_if
c_cond
(paren
id|frwl_proto
op_eq
id|IP_FW_F_ALL
)paren
(brace
multiline_comment|/* Universal frwl - we&squot;ve got a match! */
macro_line|#ifdef DEBUG_CONFIG_IP_FIREWALL
id|printf
c_func
(paren
l_string|&quot;universal frwl match&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
macro_line|#ifdef CONFIG_IP_FIREWALL_VERBOSE
r_if
c_cond
(paren
op_logical_neg
(paren
id|f-&gt;flags
op_amp
id|IP_FW_F_ACCEPT
)paren
)paren
r_goto
id|bad_packet
suffix:semicolon
r_return
l_int|1
suffix:semicolon
macro_line|#else
r_return
id|f-&gt;flags
op_amp
id|IP_FW_F_ACCEPT
suffix:semicolon
macro_line|#endif
)brace
r_else
(brace
multiline_comment|/*&n;&t;&t;&t;&t; *&t;Specific firewall - packet&squot;s protocol must match firewall&squot;s&n;&t;&t;&t;&t; */
r_if
c_cond
(paren
op_logical_neg
id|got_proto
)paren
(brace
multiline_comment|/*&n;&t; &t;&t;&t;&t; * We still had not determined the protocol&n;&t;&t;&t;&t;&t; * of this packet,now the time to do so.&n;&t;&t;&t;&t;&t; */
r_switch
c_cond
(paren
id|ip-&gt;protocol
)paren
(brace
r_case
id|IPPROTO_TCP
suffix:colon
multiline_comment|/*&n;&t;&t;&t;&t;&t;&t;&t; * &t;First two shorts in TCP are src/dst ports&n;&t;&t;&t;&t;&t;&t;&t; */
id|proto
op_assign
id|IP_FW_F_TCP
suffix:semicolon
id|src_port
op_assign
id|ntohs
c_func
(paren
id|portptr
(braket
l_int|0
)braket
)paren
suffix:semicolon
id|dst_port
op_assign
id|ntohs
c_func
(paren
id|portptr
(braket
l_int|1
)braket
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|IPPROTO_UDP
suffix:colon
multiline_comment|/*&n;&t;&t;&t;&t;&t;&t;&t; *&t;First two shorts in UDP are src/dst ports&n;&t;&t;&t; &t;&t;&t;&t; */
id|proto
op_assign
id|IP_FW_F_UDP
suffix:semicolon
id|src_port
op_assign
id|ntohs
c_func
(paren
id|portptr
(braket
l_int|0
)braket
)paren
suffix:semicolon
id|dst_port
op_assign
id|ntohs
c_func
(paren
id|portptr
(braket
l_int|1
)braket
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|IPPROTO_ICMP
suffix:colon
id|proto
op_assign
id|IP_FW_F_ICMP
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|proto
op_assign
id|IP_FW_F_ALL
suffix:semicolon
macro_line|#ifdef DEBUG_CONFIG_IP_FIREWALL
id|printf
c_func
(paren
l_string|&quot;non TCP/UDP packet&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
)brace
id|got_proto
op_assign
l_int|1
suffix:semicolon
)brace
multiline_comment|/*&n;&t;&t;&t;&t; * At this moment we surely know the protocol of this&n;&t;&t;&t;&t; * packet and we&squot;ll check if it matches,then proceed futher..&n;&t;&t;&t;&t; */
r_if
c_cond
(paren
id|proto
op_eq
id|frwl_proto
)paren
(brace
r_if
c_cond
(paren
id|proto
op_eq
id|IP_FW_F_ICMP
op_logical_or
(paren
id|port_match
c_func
(paren
op_amp
id|f-&gt;ports
(braket
l_int|0
)braket
comma
id|f-&gt;n_src_p
comma
id|src_port
comma
id|f-&gt;flags
op_amp
id|IP_FW_F_SRNG
)paren
op_logical_and
id|port_match
c_func
(paren
op_amp
id|f-&gt;ports
(braket
id|f-&gt;n_src_p
)braket
comma
id|f-&gt;n_dst_p
comma
id|dst_port
comma
id|f-&gt;flags
op_amp
id|IP_FW_F_DRNG
)paren
)paren
)paren
(brace
macro_line|#ifdef CONFIG_IP_FIREWALL_VERBOSE
r_if
c_cond
(paren
op_logical_neg
(paren
id|f-&gt;flags
op_amp
id|IP_FW_F_ACCEPT
)paren
)paren
r_goto
id|bad_packet
suffix:semicolon
r_return
l_int|1
suffix:semicolon
macro_line|#else
r_return
id|f-&gt;flags
op_amp
id|IP_FW_F_ACCEPT
suffix:semicolon
macro_line|#endif
)brace
multiline_comment|/* Ports match */
)brace
multiline_comment|/* Proto matches */
)brace
multiline_comment|/* ALL/Specific */
)brace
multiline_comment|/* IP addr/mask matches */
)brace
multiline_comment|/* Loop */
multiline_comment|/*&n;&t; * If we get here then none of the firewalls matched.&n;&t; * So now we relay on policy defined by user-unmatched packet can&n;&t; * be ever accepted or rejected...&n;&t; */
macro_line|#ifdef CONFIG_IP_FIREWALL_VERBOSE
r_if
c_cond
(paren
op_logical_neg
(paren
id|ip_fw_policy
)paren
)paren
r_goto
id|bad_packet
suffix:semicolon
r_return
l_int|1
suffix:semicolon
macro_line|#else
r_return
id|ip_fw_policy
suffix:semicolon
macro_line|#endif
macro_line|#ifdef CONFIG_IP_FIREWALL_VERBOSE
id|bad_packet
suffix:colon
multiline_comment|/*&n;&t; * VERY ugly piece of code which actually&n;&t; * makes kernel printf for denied packets...&n;&t; */
r_if
c_cond
(paren
id|f-&gt;flags
op_amp
id|IP_FW_F_PRN
)paren
(brace
id|printf
c_func
(paren
l_string|&quot;ip_fw_chk says no to &quot;
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|ip-&gt;protocol
)paren
(brace
r_case
id|IPPROTO_TCP
suffix:colon
id|printf
c_func
(paren
l_string|&quot;TCP &quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|IPPROTO_UDP
suffix:colon
id|printf
c_func
(paren
l_string|&quot;UDP &quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|IPPROTO_ICMP
suffix:colon
id|printf
c_func
(paren
l_string|&quot;ICMP:%d &quot;
comma
(paren
(paren
r_char
op_star
)paren
id|portptr
)paren
(braket
l_int|0
)braket
op_amp
l_int|0xff
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|printf
c_func
(paren
l_string|&quot;p=%d &quot;
comma
id|ip-&gt;protocol
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|print_ip
c_func
(paren
id|ip-&gt;saddr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ip-&gt;protocol
op_eq
id|IPPROTO_TCP
op_logical_or
id|ip-&gt;protocol
op_eq
id|IPPROTO_UDP
)paren
(brace
id|printf
c_func
(paren
l_string|&quot;:%d &quot;
comma
id|ntohs
c_func
(paren
id|portptr
(braket
l_int|0
)braket
)paren
)paren
suffix:semicolon
)brace
r_else
(brace
id|printf
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
)brace
id|print_ip
c_func
(paren
id|ip-&gt;daddr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ip-&gt;protocol
op_eq
id|IPPROTO_TCP
op_logical_or
id|ip-&gt;protocol
op_eq
id|IPPROTO_UDP
)paren
(brace
id|printf
c_func
(paren
l_string|&quot;:%d &quot;
comma
id|ntohs
c_func
(paren
id|portptr
(braket
l_int|1
)braket
)paren
)paren
suffix:semicolon
)brace
id|printf
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
macro_line|#endif
)brace
macro_line|#endif /* CONFIG_IP_FIREWALL */
macro_line|#ifdef CONFIG_IP_ACCT
DECL|function|ip_acct_cnt
r_void
id|ip_acct_cnt
c_func
(paren
r_struct
id|iphdr
op_star
id|ip
comma
r_struct
id|ip_fw
op_star
id|chain
comma
r_int
id|nh_conv
)paren
(brace
r_int
r_int
id|src
comma
id|dst
suffix:semicolon
r_char
id|got_proto
op_assign
l_int|0
comma
id|rev
op_assign
l_int|0
suffix:semicolon
r_int
id|frwl_proto
comma
id|proto
op_assign
l_int|0
suffix:semicolon
r_struct
id|ip_fw
op_star
id|f
suffix:semicolon
r_int
r_int
id|src_port
op_assign
l_int|0
comma
id|dst_port
op_assign
l_int|0
suffix:semicolon
r_int
r_int
op_star
id|portptr
op_assign
(paren
r_int
r_int
op_star
)paren
op_amp
(paren
(paren
(paren
id|u_int
op_star
)paren
id|ip
)paren
(braket
id|ip-&gt;ihl
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|chain
)paren
r_return
suffix:semicolon
id|src
op_assign
id|ip-&gt;saddr
suffix:semicolon
id|dst
op_assign
id|ip-&gt;daddr
suffix:semicolon
r_for
c_loop
(paren
id|f
op_assign
id|chain
suffix:semicolon
id|f
suffix:semicolon
id|f
op_assign
id|f-&gt;next
)paren
(brace
r_if
c_cond
(paren
(paren
id|src
op_amp
id|f-&gt;src_mask.s_addr
)paren
op_eq
id|f-&gt;src.s_addr
op_logical_and
(paren
id|dst
op_amp
id|f-&gt;dst_mask.s_addr
)paren
op_eq
id|f-&gt;dst.s_addr
)paren
(brace
id|rev
op_assign
l_int|0
suffix:semicolon
r_goto
id|addr_match
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|f-&gt;flags
op_amp
id|IP_FW_F_BIDIR
)paren
op_logical_and
(paren
(paren
id|src
op_amp
id|f-&gt;src_mask.s_addr
)paren
op_eq
id|f-&gt;dst.s_addr
op_logical_and
(paren
id|dst
op_amp
id|f-&gt;dst_mask.s_addr
)paren
op_eq
id|f-&gt;src.s_addr
)paren
)paren
(brace
id|rev
op_assign
l_int|1
suffix:semicolon
r_goto
id|addr_match
suffix:semicolon
)brace
r_continue
suffix:semicolon
id|addr_match
suffix:colon
id|frwl_proto
op_assign
id|f-&gt;flags
op_amp
id|IP_FW_F_KIND
suffix:semicolon
r_if
c_cond
(paren
id|frwl_proto
op_eq
id|IP_FW_F_ALL
)paren
(brace
multiline_comment|/*&t;Universal frwl - we&squot;ve got a match! */
id|f-&gt;p_cnt
op_increment
suffix:semicolon
multiline_comment|/*&t;Rise packet count */
multiline_comment|/*&n;&t;&t;&t; *&t;Rise byte count, if need to convert from host to network byte order,do it.&n;&t;&t;     &t; */
r_if
c_cond
(paren
id|nh_conv
)paren
id|f-&gt;b_cnt
op_add_assign
id|ntohs
c_func
(paren
id|ip-&gt;tot_len
)paren
suffix:semicolon
r_else
id|f-&gt;b_cnt
op_add_assign
id|ip-&gt;tot_len
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/*&n;&t;&t;&t; *&t;Specific firewall - packet&squot;s protocol must match firewall&squot;s&n;&t;&t;&t; */
r_if
c_cond
(paren
op_logical_neg
id|got_proto
)paren
(brace
multiline_comment|/*&n; &t;&t;&t;&t; *&t;We still had not determined the protocol&n;&t;&t;&t;&t; *&t;of this packet,now the time to do so.&n;&t;&t;&t;&t; */
r_switch
c_cond
(paren
id|ip-&gt;protocol
)paren
(brace
r_case
id|IPPROTO_TCP
suffix:colon
multiline_comment|/*&n;&t;&t;&t;&t;&t;&t; *&t;First two shorts in TCP are src/dst ports&n;&t;&t;&t;&t;&t;&t; */
id|proto
op_assign
id|IP_FW_F_TCP
suffix:semicolon
id|src_port
op_assign
id|ntohs
c_func
(paren
id|portptr
(braket
l_int|0
)braket
)paren
suffix:semicolon
id|dst_port
op_assign
id|ntohs
c_func
(paren
id|portptr
(braket
l_int|1
)braket
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|IPPROTO_UDP
suffix:colon
multiline_comment|/*&n;&t;&t;&t;&t;&t;&t; * First two shorts in UDP are src/dst ports&n;&t;&t;&t;&t;&t;&t; */
id|proto
op_assign
id|IP_FW_F_UDP
suffix:semicolon
id|src_port
op_assign
id|ntohs
c_func
(paren
id|portptr
(braket
l_int|0
)braket
)paren
suffix:semicolon
id|dst_port
op_assign
id|ntohs
c_func
(paren
id|portptr
(braket
l_int|1
)braket
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|IPPROTO_ICMP
suffix:colon
id|proto
op_assign
id|IP_FW_F_ICMP
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|proto
op_assign
id|IP_FW_F_ALL
suffix:semicolon
)brace
id|got_proto
op_assign
l_int|1
suffix:semicolon
)brace
multiline_comment|/*&n;&t;&t;&t; * At this moment we surely know the protocol of this&n;&t;&t;&t; * packet and we&squot;ll check if it matches,then proceed futher..&n;&t;&t;&t; */
r_if
c_cond
(paren
id|proto
op_eq
id|frwl_proto
)paren
(brace
r_if
c_cond
(paren
(paren
id|proto
op_eq
id|IP_FW_F_ICMP
op_logical_or
(paren
id|port_match
c_func
(paren
op_amp
id|f-&gt;ports
(braket
l_int|0
)braket
comma
id|f-&gt;n_src_p
comma
id|src_port
comma
id|f-&gt;flags
op_amp
id|IP_FW_F_SRNG
)paren
op_logical_and
id|port_match
c_func
(paren
op_amp
id|f-&gt;ports
(braket
id|f-&gt;n_src_p
)braket
comma
id|f-&gt;n_dst_p
comma
id|dst_port
comma
id|f-&gt;flags
op_amp
id|IP_FW_F_DRNG
)paren
)paren
)paren
op_logical_or
(paren
(paren
id|rev
)paren
op_logical_and
(paren
id|port_match
c_func
(paren
op_amp
id|f-&gt;ports
(braket
l_int|0
)braket
comma
id|f-&gt;n_src_p
comma
id|dst_port
comma
id|f-&gt;flags
op_amp
id|IP_FW_F_SRNG
)paren
op_logical_and
id|port_match
c_func
(paren
op_amp
id|f-&gt;ports
(braket
id|f-&gt;n_src_p
)braket
comma
id|f-&gt;n_dst_p
comma
id|src_port
comma
id|f-&gt;flags
op_amp
id|IP_FW_F_DRNG
)paren
)paren
)paren
)paren
(brace
id|f-&gt;p_cnt
op_increment
suffix:semicolon
multiline_comment|/* Rise packet count */
multiline_comment|/*&n;&t;&t;&t;&t;&t; * Rise byte count, if need to convert from host to network byte order,do it.&n;&t;&t;&t;&t;&t; */
r_if
c_cond
(paren
id|nh_conv
)paren
id|f-&gt;b_cnt
op_add_assign
id|ntohs
c_func
(paren
id|ip-&gt;tot_len
)paren
suffix:semicolon
r_else
id|f-&gt;b_cnt
op_add_assign
id|ip-&gt;tot_len
suffix:semicolon
)brace
multiline_comment|/* Ports match */
)brace
multiline_comment|/* Proto matches */
)brace
multiline_comment|/* ALL/Specific */
)brace
multiline_comment|/* IP addr/mask matches */
)brace
multiline_comment|/* End of whole function */
macro_line|#endif /* CONFIG_IP_ACCT */
macro_line|#ifdef CONFIG_IP_ACCT
DECL|function|zero_fw_chain
r_static
r_void
id|zero_fw_chain
c_func
(paren
r_struct
id|ip_fw
op_star
id|chainptr
)paren
(brace
r_struct
id|ip_fw
op_star
id|ctmp
op_assign
id|chainptr
suffix:semicolon
r_while
c_loop
(paren
id|ctmp
)paren
(brace
id|ctmp-&gt;p_cnt
op_assign
l_int|0l
suffix:semicolon
id|ctmp-&gt;b_cnt
op_assign
l_int|0l
suffix:semicolon
id|ctmp
op_assign
id|ctmp-&gt;next
suffix:semicolon
)brace
)brace
macro_line|#endif
macro_line|#if defined(CONFIG_IP_ACCT) || defined(CONFIG_IP_FIREWALL)
DECL|function|free_fw_chain
r_static
r_void
id|free_fw_chain
c_func
(paren
r_struct
id|ip_fw
op_star
op_star
id|chainptr
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
r_while
c_loop
(paren
op_star
id|chainptr
op_ne
l_int|NULL
)paren
(brace
r_struct
id|ip_fw
op_star
id|ftmp
suffix:semicolon
id|ftmp
op_assign
op_star
id|chainptr
suffix:semicolon
op_star
id|chainptr
op_assign
id|ftmp-&gt;next
suffix:semicolon
id|kfree_s
c_func
(paren
id|ftmp
comma
r_sizeof
(paren
op_star
id|ftmp
)paren
)paren
suffix:semicolon
)brace
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
macro_line|#endif  /* CONFIG_IP_ACCT || CONFIG_IP_FIREWALL */
macro_line|#ifdef CONFIG_IP_FIREWALL
DECL|function|add_to_chain
r_static
r_int
id|add_to_chain
c_func
(paren
r_struct
id|ip_fw
op_star
op_star
id|chainptr
comma
r_struct
id|ip_fw
op_star
id|frwl
)paren
(brace
r_struct
id|ip_fw
op_star
id|ftmp
suffix:semicolon
r_struct
id|ip_fw
op_star
id|chtmp
op_assign
l_int|NULL
suffix:semicolon
r_struct
id|ip_fw
op_star
id|chtmp_prev
op_assign
l_int|NULL
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_int
r_int
id|m_src_mask
comma
id|m_dst_mask
suffix:semicolon
r_int
r_int
id|n_sa
comma
id|n_da
comma
id|o_sa
comma
id|o_da
comma
id|o_sm
comma
id|o_dm
comma
id|n_sm
comma
id|n_dm
suffix:semicolon
r_int
r_int
id|n_sr
comma
id|n_dr
comma
id|o_sr
comma
id|o_dr
suffix:semicolon
r_int
r_int
id|oldkind
comma
id|newkind
suffix:semicolon
r_int
id|addb4
op_assign
l_int|0
suffix:semicolon
r_int
id|n_o
comma
id|n_n
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|ftmp
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|ip_fw
)paren
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ftmp
op_eq
l_int|NULL
)paren
(brace
macro_line|#ifdef DEBUG_CONFIG_IP_FIREWALL
id|printf
c_func
(paren
l_string|&quot;ip_fw_ctl:  malloc said no&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
r_return
id|ENOSPC
suffix:semicolon
)brace
id|memcpy
c_func
(paren
id|ftmp
comma
id|frwl
comma
r_sizeof
(paren
r_struct
id|ip_fw
)paren
)paren
suffix:semicolon
id|ftmp-&gt;p_cnt
op_assign
l_int|0L
suffix:semicolon
id|ftmp-&gt;b_cnt
op_assign
l_int|0L
suffix:semicolon
id|ftmp-&gt;next
op_assign
l_int|NULL
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_star
id|chainptr
op_eq
l_int|NULL
)paren
(brace
op_star
id|chainptr
op_assign
id|ftmp
suffix:semicolon
)brace
r_else
(brace
id|chtmp_prev
op_assign
l_int|NULL
suffix:semicolon
r_for
c_loop
(paren
id|chtmp
op_assign
op_star
id|chainptr
suffix:semicolon
id|chtmp
op_ne
l_int|NULL
suffix:semicolon
id|chtmp
op_assign
id|chtmp-&gt;next
)paren
(brace
id|addb4
op_assign
l_int|0
suffix:semicolon
id|newkind
op_assign
id|ftmp-&gt;flags
op_amp
id|IP_FW_F_KIND
suffix:semicolon
id|oldkind
op_assign
id|chtmp-&gt;flags
op_amp
id|IP_FW_F_KIND
suffix:semicolon
r_if
c_cond
(paren
id|newkind
op_ne
id|IP_FW_F_ALL
op_logical_and
id|oldkind
op_ne
id|IP_FW_F_ALL
op_logical_and
id|oldkind
op_ne
id|newkind
)paren
(brace
id|chtmp_prev
op_assign
id|chtmp
suffix:semicolon
r_continue
suffix:semicolon
)brace
multiline_comment|/*&n;&t;&t;&t; *&t;Very very *UGLY* code...&n;&t;&t;&t; *&t;Sorry,but i had to do this....&n;&t;&t;&t; */
id|n_sa
op_assign
id|ntohl
c_func
(paren
id|ftmp-&gt;src.s_addr
)paren
suffix:semicolon
id|n_da
op_assign
id|ntohl
c_func
(paren
id|ftmp-&gt;dst.s_addr
)paren
suffix:semicolon
id|n_sm
op_assign
id|ntohl
c_func
(paren
id|ftmp-&gt;src_mask.s_addr
)paren
suffix:semicolon
id|n_dm
op_assign
id|ntohl
c_func
(paren
id|ftmp-&gt;dst_mask.s_addr
)paren
suffix:semicolon
id|o_sa
op_assign
id|ntohl
c_func
(paren
id|chtmp-&gt;src.s_addr
)paren
suffix:semicolon
id|o_da
op_assign
id|ntohl
c_func
(paren
id|chtmp-&gt;dst.s_addr
)paren
suffix:semicolon
id|o_sm
op_assign
id|ntohl
c_func
(paren
id|chtmp-&gt;src_mask.s_addr
)paren
suffix:semicolon
id|o_dm
op_assign
id|ntohl
c_func
(paren
id|chtmp-&gt;dst_mask.s_addr
)paren
suffix:semicolon
id|m_src_mask
op_assign
id|o_sm
op_amp
id|n_sm
suffix:semicolon
id|m_dst_mask
op_assign
id|o_dm
op_amp
id|n_dm
suffix:semicolon
r_if
c_cond
(paren
(paren
id|o_sa
op_amp
id|m_src_mask
)paren
op_eq
(paren
id|n_sa
op_amp
id|m_src_mask
)paren
)paren
(brace
r_if
c_cond
(paren
id|n_sm
OG
id|o_sm
)paren
id|addb4
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|n_sm
OL
id|o_sm
)paren
id|addb4
op_decrement
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|o_da
op_amp
id|m_dst_mask
)paren
op_eq
(paren
id|n_da
op_amp
id|m_dst_mask
)paren
)paren
(brace
r_if
c_cond
(paren
id|n_dm
OG
id|o_dm
)paren
id|addb4
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|n_dm
OL
id|o_dm
)paren
id|addb4
op_decrement
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
(paren
id|o_da
op_amp
id|o_dm
)paren
op_eq
(paren
id|n_da
op_amp
id|n_dm
)paren
)paren
op_logical_and
(paren
(paren
id|o_sa
op_amp
id|o_sm
)paren
op_eq
(paren
id|n_sa
op_amp
id|n_sm
)paren
)paren
)paren
(brace
r_if
c_cond
(paren
id|newkind
op_ne
id|IP_FW_F_ALL
op_logical_and
id|oldkind
op_eq
id|IP_FW_F_ALL
)paren
id|addb4
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|newkind
op_eq
id|oldkind
op_logical_and
(paren
id|oldkind
op_eq
id|IP_FW_F_TCP
op_logical_or
id|oldkind
op_eq
id|IP_FW_F_UDP
)paren
)paren
(brace
multiline_comment|/*&n;&t;&t;&t;&t;&t; * &t;Here the main idea is to check the size&n;&t;&t;&t;&t;&t; * &t;of port range which the frwl covers&n;&t;&t;&t;&t;&t; * &t;We actually don&squot;t check their values but&n;&t;&t;&t;&t;&t; *&t;just the wideness of range they have&n;&t;&t;&t;&t;&t; *&t;so that less wide ranges or single ports&n;&t;&t;&t;&t;&t; *&t;go first and wide ranges go later. No ports&n;&t;&t;&t;&t;&t; *&t;at all treated as a range of maximum number&n;&t;&t;&t;&t;&t; *&t;of ports.&n;&t;&t;&t;&t;&t; */
r_if
c_cond
(paren
id|ftmp-&gt;flags
op_amp
id|IP_FW_F_SRNG
)paren
id|n_sr
op_assign
id|ftmp-&gt;ports
(braket
l_int|1
)braket
op_minus
id|ftmp-&gt;ports
(braket
l_int|0
)braket
suffix:semicolon
r_else
id|n_sr
op_assign
(paren
id|ftmp-&gt;n_src_p
)paren
ques
c_cond
id|ftmp-&gt;n_src_p
suffix:colon
l_int|0xFFFF
suffix:semicolon
r_if
c_cond
(paren
id|chtmp-&gt;flags
op_amp
id|IP_FW_F_SRNG
)paren
id|o_sr
op_assign
id|chtmp-&gt;ports
(braket
l_int|1
)braket
op_minus
id|chtmp-&gt;ports
(braket
l_int|0
)braket
suffix:semicolon
r_else
id|o_sr
op_assign
(paren
id|chtmp-&gt;n_src_p
)paren
ques
c_cond
id|chtmp-&gt;n_src_p
suffix:colon
l_int|0xFFFF
suffix:semicolon
r_if
c_cond
(paren
id|n_sr
OL
id|o_sr
)paren
id|addb4
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|n_sr
OG
id|o_sr
)paren
id|addb4
op_decrement
suffix:semicolon
id|n_n
op_assign
id|ftmp-&gt;n_src_p
suffix:semicolon
id|n_o
op_assign
id|chtmp-&gt;n_src_p
suffix:semicolon
multiline_comment|/*&n;&t;&t;&t;&t;&t; * Actually this cannot happen as the frwl control&n;&t;&t;&t;&t;&t; * procedure checks for number of ports in source and&n;&t;&t;&t;&t;&t; * destination range but we will try to be more safe.&n;&t;&t;&t;&t;&t; */
r_if
c_cond
(paren
(paren
id|n_n
OG
(paren
id|IP_FW_MAX_PORTS
op_minus
l_int|2
)paren
)paren
op_logical_or
(paren
id|n_o
OG
(paren
id|IP_FW_MAX_PORTS
op_minus
l_int|2
)paren
)paren
)paren
r_goto
id|skip_check
suffix:semicolon
r_if
c_cond
(paren
id|ftmp-&gt;flags
op_amp
id|IP_FW_F_DRNG
)paren
id|n_dr
op_assign
id|ftmp-&gt;ports
(braket
id|n_n
op_plus
l_int|1
)braket
op_minus
id|ftmp-&gt;ports
(braket
id|n_n
)braket
suffix:semicolon
r_else
id|n_dr
op_assign
(paren
id|ftmp-&gt;n_dst_p
)paren
ques
c_cond
id|ftmp-&gt;n_dst_p
suffix:colon
l_int|0xFFFF
suffix:semicolon
r_if
c_cond
(paren
id|chtmp-&gt;flags
op_amp
id|IP_FW_F_DRNG
)paren
id|o_dr
op_assign
id|chtmp-&gt;ports
(braket
id|n_o
op_plus
l_int|1
)braket
op_minus
id|chtmp-&gt;ports
(braket
id|n_o
)braket
suffix:semicolon
r_else
id|o_dr
op_assign
(paren
id|chtmp-&gt;n_dst_p
)paren
ques
c_cond
id|chtmp-&gt;n_dst_p
suffix:colon
l_int|0xFFFF
suffix:semicolon
r_if
c_cond
(paren
id|n_dr
OL
id|o_dr
)paren
id|addb4
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|n_dr
OG
id|o_dr
)paren
id|addb4
op_decrement
suffix:semicolon
id|skip_check
suffix:colon
)brace
)brace
r_if
c_cond
(paren
id|addb4
OG
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|chtmp_prev
)paren
(brace
id|chtmp_prev-&gt;next
op_assign
id|ftmp
suffix:semicolon
id|ftmp-&gt;next
op_assign
id|chtmp
suffix:semicolon
)brace
r_else
(brace
op_star
id|chainptr
op_assign
id|ftmp
suffix:semicolon
id|ftmp-&gt;next
op_assign
id|chtmp
suffix:semicolon
)brace
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|chtmp_prev
op_assign
id|chtmp
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|chtmp_prev
)paren
id|chtmp_prev-&gt;next
op_assign
id|ftmp
suffix:semicolon
r_else
(brace
op_star
id|chainptr
op_assign
id|ftmp
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;ip_fw: add_to_chain: Can&squot;t happen&quot;
)paren
suffix:semicolon
)brace
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|del_from_chain
r_static
r_int
id|del_from_chain
c_func
(paren
r_struct
id|ip_fw
op_star
op_star
id|chainptr
comma
r_struct
id|ip_fw
op_star
id|frwl
)paren
(brace
r_struct
id|ip_fw
op_star
id|ftmp
comma
op_star
id|ltmp
suffix:semicolon
r_int
r_int
id|tport1
comma
id|tport2
comma
id|tmpnum
suffix:semicolon
r_char
id|matches
comma
id|was_found
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|ftmp
op_assign
op_star
id|chainptr
suffix:semicolon
r_if
c_cond
(paren
id|ftmp
op_eq
l_int|NULL
)paren
(brace
macro_line|#ifdef DEBUG_CONFIG_IP_FIREWALL
id|printf
c_func
(paren
l_string|&quot;ip_fw_ctl:  chain is empty&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
id|EINVAL
suffix:semicolon
)brace
id|ltmp
op_assign
l_int|NULL
suffix:semicolon
id|was_found
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
id|ftmp
op_ne
l_int|NULL
)paren
(brace
id|matches
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
(paren
id|memcmp
c_func
(paren
op_amp
id|ftmp-&gt;src
comma
op_amp
id|frwl-&gt;src
comma
r_sizeof
(paren
r_struct
id|in_addr
)paren
)paren
)paren
op_logical_or
(paren
id|memcmp
c_func
(paren
op_amp
id|ftmp-&gt;src_mask
comma
op_amp
id|frwl-&gt;src_mask
comma
r_sizeof
(paren
r_struct
id|in_addr
)paren
)paren
)paren
op_logical_or
(paren
id|memcmp
c_func
(paren
op_amp
id|ftmp-&gt;dst
comma
op_amp
id|frwl-&gt;dst
comma
r_sizeof
(paren
r_struct
id|in_addr
)paren
)paren
)paren
op_logical_or
(paren
id|memcmp
c_func
(paren
op_amp
id|ftmp-&gt;dst_mask
comma
op_amp
id|frwl-&gt;dst_mask
comma
r_sizeof
(paren
r_struct
id|in_addr
)paren
)paren
)paren
op_logical_or
(paren
id|ftmp-&gt;flags
op_ne
id|frwl-&gt;flags
)paren
)paren
id|matches
op_assign
l_int|0
suffix:semicolon
id|tport1
op_assign
id|ftmp-&gt;n_src_p
op_plus
id|ftmp-&gt;n_dst_p
suffix:semicolon
id|tport2
op_assign
id|frwl-&gt;n_src_p
op_plus
id|frwl-&gt;n_dst_p
suffix:semicolon
r_if
c_cond
(paren
id|tport1
op_ne
id|tport2
)paren
id|matches
op_assign
l_int|0
suffix:semicolon
r_else
r_if
c_cond
(paren
id|tport1
op_ne
l_int|0
)paren
(brace
r_for
c_loop
(paren
id|tmpnum
op_assign
l_int|0
suffix:semicolon
id|tmpnum
OL
id|tport1
op_logical_and
id|tmpnum
OL
id|IP_FW_MAX_PORTS
suffix:semicolon
id|tmpnum
op_increment
)paren
r_if
c_cond
(paren
id|ftmp-&gt;ports
(braket
id|tmpnum
)braket
op_ne
id|frwl-&gt;ports
(braket
id|tmpnum
)braket
)paren
id|matches
op_assign
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|matches
)paren
(brace
id|was_found
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|ltmp
)paren
(brace
id|ltmp-&gt;next
op_assign
id|ftmp-&gt;next
suffix:semicolon
id|kfree_s
c_func
(paren
id|ftmp
comma
r_sizeof
(paren
op_star
id|ftmp
)paren
)paren
suffix:semicolon
id|ftmp
op_assign
id|ltmp-&gt;next
suffix:semicolon
)brace
r_else
(brace
op_star
id|chainptr
op_assign
id|ftmp-&gt;next
suffix:semicolon
id|kfree_s
c_func
(paren
id|ftmp
comma
r_sizeof
(paren
op_star
id|ftmp
)paren
)paren
suffix:semicolon
id|ftmp
op_assign
op_star
id|chainptr
suffix:semicolon
)brace
)brace
r_else
(brace
id|ltmp
op_assign
id|ftmp
suffix:semicolon
id|ftmp
op_assign
id|ftmp-&gt;next
suffix:semicolon
)brace
)brace
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|was_found
)paren
r_return
l_int|0
suffix:semicolon
r_else
r_return
id|EINVAL
suffix:semicolon
)brace
macro_line|#endif /* CONFIG_IP_FIREWALL */
DECL|function|check_ipfw_struct
r_struct
id|ip_fw
op_star
id|check_ipfw_struct
c_func
(paren
r_struct
id|ip_fw
op_star
id|frwl
comma
r_int
id|len
)paren
(brace
r_if
c_cond
(paren
id|len
op_ne
r_sizeof
(paren
r_struct
id|ip_fw
)paren
)paren
(brace
macro_line|#ifdef DEBUG_CONFIG_IP_FIREWALL
id|printf
c_func
(paren
l_string|&quot;ip_fw_ctl: len=%d, want %d&bslash;n&quot;
comma
id|m-&gt;m_len
comma
r_sizeof
(paren
r_struct
id|ip_fw
)paren
)paren
suffix:semicolon
macro_line|#endif
r_return
l_int|NULL
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|frwl-&gt;flags
op_amp
op_complement
id|IP_FW_F_MASK
)paren
op_ne
l_int|0
)paren
(brace
macro_line|#ifdef DEBUG_CONFIG_IP_FIREWALL
id|printf
c_func
(paren
l_string|&quot;ip_fw_ctl: undefined flag bits set (flags=%x)&bslash;n&quot;
comma
id|frwl-&gt;flags
)paren
suffix:semicolon
macro_line|#endif
r_return
l_int|NULL
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|frwl-&gt;flags
op_amp
id|IP_FW_F_SRNG
)paren
op_logical_and
id|frwl-&gt;n_src_p
OL
l_int|2
)paren
(brace
macro_line|#ifdef DEBUG_CONFIG_IP_FIREWALL
id|printf
c_func
(paren
l_string|&quot;ip_fw_ctl: src range set but n_src_p=%d&bslash;n&quot;
comma
id|frwl-&gt;n_src_p
)paren
suffix:semicolon
macro_line|#endif
r_return
l_int|NULL
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|frwl-&gt;flags
op_amp
id|IP_FW_F_DRNG
)paren
op_logical_and
id|frwl-&gt;n_dst_p
OL
l_int|2
)paren
(brace
macro_line|#ifdef DEBUG_CONFIG_IP_FIREWALL
id|printf
c_func
(paren
l_string|&quot;ip_fw_ctl: dst range set but n_dst_p=%d&bslash;n&quot;
comma
id|frwl-&gt;n_dst_p
)paren
suffix:semicolon
macro_line|#endif
r_return
l_int|NULL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|frwl-&gt;n_src_p
op_plus
id|frwl-&gt;n_dst_p
OG
id|IP_FW_MAX_PORTS
)paren
(brace
macro_line|#ifdef DEBUG_CONFIG_IP_FIREWALL
id|printf
c_func
(paren
l_string|&quot;ip_fw_ctl: too many ports (%d+%d)&bslash;n&quot;
comma
id|frwl-&gt;n_src_p
comma
id|frwl-&gt;n_dst_p
)paren
suffix:semicolon
macro_line|#endif
r_return
l_int|NULL
suffix:semicolon
)brace
r_return
id|frwl
suffix:semicolon
)brace
macro_line|#ifdef CONFIG_IP_ACCT
DECL|function|ip_acct_ctl
r_int
id|ip_acct_ctl
c_func
(paren
r_int
id|stage
comma
r_void
op_star
id|m
comma
r_int
id|len
)paren
(brace
r_if
c_cond
(paren
id|stage
op_eq
id|IP_ACCT_FLUSH
)paren
(brace
id|free_fw_chain
c_func
(paren
op_amp
id|ip_acct_chain
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|stage
op_eq
id|IP_ACCT_ZERO
)paren
(brace
id|zero_fw_chain
c_func
(paren
id|ip_acct_chain
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|stage
op_eq
id|IP_ACCT_ADD
op_logical_or
id|stage
op_eq
id|IP_ACCT_DEL
)paren
(brace
r_struct
id|ip_fw
op_star
id|frwl
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|frwl
op_assign
id|check_ipfw_struct
c_func
(paren
id|m
comma
id|len
)paren
)paren
)paren
r_return
(paren
id|EINVAL
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|stage
)paren
(brace
r_case
id|IP_ACCT_ADD
suffix:colon
r_return
id|add_to_chain
c_func
(paren
op_amp
id|ip_acct_chain
comma
id|frwl
)paren
suffix:semicolon
r_case
id|IP_ACCT_DEL
suffix:colon
r_return
id|del_from_chain
c_func
(paren
op_amp
id|ip_acct_chain
comma
id|frwl
)paren
suffix:semicolon
r_default
suffix:colon
multiline_comment|/*&n; &t;&t;&t;&t; *&t;Should be panic but... (Why ??? - AC)&n;&t;&t;&t;&t; */
macro_line|#ifdef DEBUG_CONFIG_IP_FIREWALL
id|printf
c_func
(paren
l_string|&quot;ip_acct_ctl:  unknown request %d&bslash;n&quot;
comma
id|stage
)paren
suffix:semicolon
macro_line|#endif
r_return
id|EINVAL
suffix:semicolon
)brace
)brace
macro_line|#ifdef DEBUG_CONFIG_IP_FIREWALL
id|printf
c_func
(paren
l_string|&quot;ip_acct_ctl:  unknown request %d&bslash;n&quot;
comma
id|stage
)paren
suffix:semicolon
macro_line|#endif
r_return
id|EINVAL
suffix:semicolon
)brace
macro_line|#endif
macro_line|#ifdef CONFIG_IP_FIREWALL
DECL|function|ip_fw_ctl
r_int
id|ip_fw_ctl
c_func
(paren
r_int
id|stage
comma
r_void
op_star
id|m
comma
r_int
id|len
)paren
(brace
r_if
c_cond
(paren
id|stage
op_eq
id|IP_FW_FLUSH
)paren
(brace
id|free_fw_chain
c_func
(paren
op_amp
id|ip_fw_blk_chain
)paren
suffix:semicolon
id|free_fw_chain
c_func
(paren
op_amp
id|ip_fw_fwd_chain
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|stage
op_eq
id|IP_FW_POLICY
)paren
(brace
r_int
op_star
id|tmp_policy_ptr
suffix:semicolon
id|tmp_policy_ptr
op_assign
(paren
r_int
op_star
)paren
id|m
suffix:semicolon
r_if
c_cond
(paren
(paren
op_star
id|tmp_policy_ptr
)paren
op_ne
l_int|1
op_logical_and
(paren
op_star
id|tmp_policy_ptr
)paren
op_ne
l_int|0
)paren
r_return
(paren
id|EINVAL
)paren
suffix:semicolon
id|ip_fw_policy
op_assign
op_star
id|tmp_policy_ptr
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|stage
op_eq
id|IP_FW_CHK_BLK
op_logical_or
id|stage
op_eq
id|IP_FW_CHK_FWD
)paren
(brace
r_struct
id|iphdr
op_star
id|ip
suffix:semicolon
r_if
c_cond
(paren
id|len
OL
r_sizeof
(paren
r_struct
id|iphdr
)paren
op_plus
l_int|2
op_star
r_sizeof
(paren
r_int
r_int
)paren
)paren
(brace
macro_line|#ifdef DEBUG_CONFIG_IP_FIREWALL
id|printf
c_func
(paren
l_string|&quot;ip_fw_ctl: len=%d, want at least %d&bslash;n&quot;
comma
id|len
comma
r_sizeof
(paren
r_struct
id|ip
)paren
op_plus
l_int|2
op_star
r_sizeof
(paren
r_int
r_int
)paren
)paren
suffix:semicolon
macro_line|#endif
r_return
id|EINVAL
suffix:semicolon
)brace
id|ip
op_assign
(paren
r_struct
id|iphdr
op_star
)paren
id|m
suffix:semicolon
r_if
c_cond
(paren
id|ip-&gt;ihl
op_ne
r_sizeof
(paren
r_struct
id|iphdr
)paren
op_div
r_sizeof
(paren
r_int
)paren
)paren
(brace
macro_line|#ifdef DEBUG_CONFIG_IP_FIREWALL
id|printf
c_func
(paren
l_string|&quot;ip_fw_ctl: ip-&gt;ihl=%d, want %d&bslash;n&quot;
comma
id|ip-&gt;ihl
comma
r_sizeof
(paren
r_struct
id|ip
)paren
op_div
r_sizeof
(paren
r_int
)paren
)paren
suffix:semicolon
macro_line|#endif
r_return
id|EINVAL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ip_fw_chk
c_func
(paren
id|ip
comma
id|stage
op_eq
id|IP_FW_CHK_BLK
ques
c_cond
id|ip_fw_blk_chain
suffix:colon
id|ip_fw_fwd_chain
)paren
)paren
r_return
l_int|0
suffix:semicolon
r_else
r_return
id|EACCES
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;Here we really working hard-adding new elements&n; *&t;to blocking/forwarding chains or deleting&squot;em&n; */
r_if
c_cond
(paren
id|stage
op_eq
id|IP_FW_ADD_BLK
op_logical_or
id|stage
op_eq
id|IP_FW_ADD_FWD
op_logical_or
id|stage
op_eq
id|IP_FW_DEL_BLK
op_logical_or
id|stage
op_eq
id|IP_FW_DEL_FWD
)paren
(brace
r_struct
id|ip_fw
op_star
id|frwl
suffix:semicolon
id|frwl
op_assign
id|check_ipfw_struct
c_func
(paren
id|m
comma
id|len
)paren
suffix:semicolon
r_if
c_cond
(paren
id|frwl
op_eq
l_int|NULL
)paren
r_return
(paren
id|EINVAL
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|stage
)paren
(brace
r_case
id|IP_FW_ADD_BLK
suffix:colon
r_return
id|add_to_chain
c_func
(paren
op_amp
id|ip_fw_blk_chain
comma
id|frwl
)paren
suffix:semicolon
r_case
id|IP_FW_ADD_FWD
suffix:colon
r_return
id|add_to_chain
c_func
(paren
op_amp
id|ip_fw_fwd_chain
comma
id|frwl
)paren
suffix:semicolon
r_case
id|IP_FW_DEL_BLK
suffix:colon
r_return
id|del_from_chain
c_func
(paren
op_amp
id|ip_fw_blk_chain
comma
id|frwl
)paren
suffix:semicolon
r_case
id|IP_FW_DEL_FWD
suffix:colon
r_return
id|del_from_chain
c_func
(paren
op_amp
id|ip_fw_fwd_chain
comma
id|frwl
)paren
suffix:semicolon
r_default
suffix:colon
multiline_comment|/*&n;&t; &t;&t; *&t;Should be panic but... (Why are BSD people panic obsessed ??)&n;&t;&t;&t; */
macro_line|#ifdef DEBUG_CONFIG_IP_FIREWALL
id|printf
c_func
(paren
l_string|&quot;ip_fw_ctl:  unknown request %d&bslash;n&quot;
comma
id|stage
)paren
suffix:semicolon
macro_line|#endif
r_return
id|EINVAL
suffix:semicolon
)brace
)brace
macro_line|#ifdef DEBUG_CONFIG_IP_FIREWALL
id|printf
c_func
(paren
l_string|&quot;ip_fw_ctl:  unknown request %d&bslash;n&quot;
comma
id|stage
)paren
suffix:semicolon
macro_line|#endif
r_return
id|EINVAL
suffix:semicolon
)brace
macro_line|#endif /* CONFIG_IP_FIREWALL */
eof
