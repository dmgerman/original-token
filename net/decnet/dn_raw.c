multiline_comment|/*&n; * DECnet       An implementation of the DECnet protocol suite for the LINUX&n; *              operating system.  DECnet is implemented using the  BSD Socket&n; *              interface as the means of communication with the user level.&n; *&n; *              DECnet Raw Sockets Interface&n; *&n; * Author:      Steve Whitehouse &lt;SteveW@ACM.org&gt;&n; *&n; *&n; * Changes:&n; *           Steve Whitehouse - connect() function.&n; *           Steve Whitehouse - SMP changes, removed MOP stubs. MOP will&n; *                              be userland only.&n; */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/net.h&gt;
macro_line|#include &lt;linux/skbuff.h&gt;
macro_line|#include &lt;linux/netdevice.h&gt;
macro_line|#include &lt;linux/socket.h&gt;
macro_line|#include &lt;linux/sockios.h&gt;
macro_line|#include &lt;net/sock.h&gt;
macro_line|#include &lt;net/dst.h&gt;
macro_line|#include &lt;net/dn.h&gt;
macro_line|#include &lt;net/dn_raw.h&gt;
macro_line|#include &lt;net/dn_route.h&gt;
DECL|variable|dn_raw_hash_lock
r_static
id|rwlock_t
id|dn_raw_hash_lock
op_assign
id|RW_LOCK_UNLOCKED
suffix:semicolon
DECL|variable|dn_raw_nsp_sklist
r_static
r_struct
id|sock
op_star
id|dn_raw_nsp_sklist
op_assign
l_int|NULL
suffix:semicolon
DECL|variable|dn_raw_routing_sklist
r_static
r_struct
id|sock
op_star
id|dn_raw_routing_sklist
op_assign
l_int|NULL
suffix:semicolon
DECL|function|dn_raw_hash
r_static
r_void
id|dn_raw_hash
c_func
(paren
r_struct
id|sock
op_star
id|sk
)paren
(brace
r_struct
id|sock
op_star
op_star
id|skp
suffix:semicolon
r_switch
c_cond
(paren
id|sk-&gt;protocol
)paren
(brace
r_case
id|DNPROTO_NSP
suffix:colon
id|skp
op_assign
op_amp
id|dn_raw_nsp_sklist
suffix:semicolon
r_break
suffix:semicolon
r_case
id|DNPROTO_ROU
suffix:colon
id|skp
op_assign
op_amp
id|dn_raw_routing_sklist
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;dn_raw_hash: Unknown protocol&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|write_lock_bh
c_func
(paren
op_amp
id|dn_raw_hash_lock
)paren
suffix:semicolon
id|sk-&gt;next
op_assign
op_star
id|skp
suffix:semicolon
id|sk-&gt;pprev
op_assign
id|skp
suffix:semicolon
op_star
id|skp
op_assign
id|sk
suffix:semicolon
id|write_unlock_bh
c_func
(paren
op_amp
id|dn_raw_hash_lock
)paren
suffix:semicolon
)brace
DECL|function|dn_raw_unhash
r_static
r_void
id|dn_raw_unhash
c_func
(paren
r_struct
id|sock
op_star
id|sk
)paren
(brace
r_struct
id|sock
op_star
op_star
id|skp
op_assign
id|sk-&gt;pprev
suffix:semicolon
r_if
c_cond
(paren
id|skp
op_eq
l_int|NULL
)paren
r_return
suffix:semicolon
id|write_lock_bh
c_func
(paren
op_amp
id|dn_raw_hash_lock
)paren
suffix:semicolon
r_while
c_loop
(paren
op_star
id|skp
op_ne
id|sk
)paren
(brace
id|skp
op_assign
op_amp
(paren
(paren
op_star
id|skp
)paren
op_member_access_from_pointer
id|next
)paren
suffix:semicolon
)brace
op_star
id|skp
op_assign
id|sk-&gt;next
suffix:semicolon
id|write_unlock_bh
c_func
(paren
op_amp
id|dn_raw_hash_lock
)paren
suffix:semicolon
id|sk-&gt;next
op_assign
l_int|NULL
suffix:semicolon
id|sk-&gt;pprev
op_assign
l_int|NULL
suffix:semicolon
)brace
DECL|function|dn_raw_autobind
r_static
r_void
id|dn_raw_autobind
c_func
(paren
r_struct
id|sock
op_star
id|sk
)paren
(brace
id|dn_raw_hash
c_func
(paren
id|sk
)paren
suffix:semicolon
id|sk-&gt;zapped
op_assign
l_int|0
suffix:semicolon
)brace
DECL|function|dn_raw_release
r_static
r_int
id|dn_raw_release
c_func
(paren
r_struct
id|socket
op_star
id|sock
)paren
(brace
r_struct
id|sock
op_star
id|sk
op_assign
id|sock-&gt;sk
suffix:semicolon
r_if
c_cond
(paren
id|sk
op_eq
l_int|NULL
)paren
r_return
l_int|0
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|sk-&gt;dead
)paren
id|sk
op_member_access_from_pointer
id|state_change
c_func
(paren
id|sk
)paren
suffix:semicolon
id|sk-&gt;dead
op_assign
l_int|1
suffix:semicolon
id|sk-&gt;socket
op_assign
l_int|NULL
suffix:semicolon
id|sock-&gt;sk
op_assign
l_int|NULL
suffix:semicolon
id|dn_raw_unhash
c_func
(paren
id|sk
)paren
suffix:semicolon
id|sock_put
c_func
(paren
id|sk
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * Bind does odd things with raw sockets. Its basically used to filter&n; * the incoming packets, but this differs with the different layers&n; * at which you extract packets.&n; *&n; * For Routing layer sockets, the object name is a host ordered unsigned&n; * short which is a mask for the 16 different types of possible routing&n; * packet. I&squot;d like to also select by destination address of the packets&n; * but alas, this is rather too difficult to do at the moment.&n; */
DECL|function|dn_raw_bind
r_static
r_int
id|dn_raw_bind
c_func
(paren
r_struct
id|socket
op_star
id|sock
comma
r_struct
id|sockaddr
op_star
id|uaddr
comma
r_int
id|addr_len
)paren
(brace
r_struct
id|sock
op_star
id|sk
op_assign
id|sock-&gt;sk
suffix:semicolon
r_struct
id|sockaddr_dn
op_star
id|addr
op_assign
(paren
r_struct
id|sockaddr_dn
op_star
)paren
id|uaddr
suffix:semicolon
r_if
c_cond
(paren
id|addr_len
op_ne
r_sizeof
(paren
r_struct
id|sockaddr_dn
)paren
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|sk-&gt;zapped
op_eq
l_int|0
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_switch
c_cond
(paren
id|sk-&gt;protocol
)paren
(brace
r_case
id|DNPROTO_ROU
suffix:colon
r_if
c_cond
(paren
id|dn_ntohs
c_func
(paren
id|addr-&gt;sdn_objnamel
)paren
op_logical_and
(paren
id|dn_ntohs
c_func
(paren
id|addr-&gt;sdn_objnamel
)paren
op_ne
l_int|2
)paren
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
multiline_comment|/* Fall through here */
r_case
id|DNPROTO_NSP
suffix:colon
r_if
c_cond
(paren
id|dn_ntohs
c_func
(paren
id|addr-&gt;sdn_add.a_len
)paren
op_logical_and
(paren
id|dn_ntohs
c_func
(paren
id|addr-&gt;sdn_add.a_len
)paren
op_ne
l_int|2
)paren
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
r_return
op_minus
id|EPROTONOSUPPORT
suffix:semicolon
)brace
r_if
c_cond
(paren
id|dn_ntohs
c_func
(paren
id|addr-&gt;sdn_objnamel
)paren
OG
(paren
id|DN_MAXOBJL
op_minus
l_int|1
)paren
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|dn_ntohs
c_func
(paren
id|addr-&gt;sdn_add.a_len
)paren
OG
id|DN_MAXADDL
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|memcpy
c_func
(paren
op_amp
id|sk-&gt;protinfo.dn.addr
comma
id|addr
comma
r_sizeof
(paren
r_struct
id|sockaddr_dn
)paren
)paren
suffix:semicolon
id|dn_raw_autobind
c_func
(paren
id|sk
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * This is to allow send() and write() to work. You set the destination address&n; * with this function.&n; */
DECL|function|dn_raw_connect
r_static
r_int
id|dn_raw_connect
c_func
(paren
r_struct
id|socket
op_star
id|sock
comma
r_struct
id|sockaddr
op_star
id|uaddr
comma
r_int
id|addr_len
comma
r_int
id|flags
)paren
(brace
r_struct
id|sock
op_star
id|sk
op_assign
id|sock-&gt;sk
suffix:semicolon
r_struct
id|dn_scp
op_star
id|scp
op_assign
op_amp
id|sk-&gt;protinfo.dn
suffix:semicolon
r_struct
id|sockaddr_dn
op_star
id|saddr
op_assign
(paren
r_struct
id|sockaddr_dn
op_star
)paren
id|uaddr
suffix:semicolon
r_int
id|err
suffix:semicolon
id|lock_sock
c_func
(paren
id|sk
)paren
suffix:semicolon
id|err
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|addr_len
op_ne
r_sizeof
(paren
r_struct
id|sockaddr_dn
)paren
)paren
r_goto
id|out
suffix:semicolon
r_if
c_cond
(paren
id|saddr-&gt;sdn_family
op_ne
id|AF_DECnet
)paren
r_goto
id|out
suffix:semicolon
r_if
c_cond
(paren
id|dn_ntohs
c_func
(paren
id|saddr-&gt;sdn_objnamel
)paren
OG
(paren
id|DN_MAXOBJL
op_minus
l_int|1
)paren
)paren
r_goto
id|out
suffix:semicolon
r_if
c_cond
(paren
id|dn_ntohs
c_func
(paren
id|saddr-&gt;sdn_add.a_len
)paren
OG
id|DN_MAXADDL
)paren
r_goto
id|out
suffix:semicolon
r_if
c_cond
(paren
id|sk-&gt;zapped
)paren
id|dn_raw_autobind
c_func
(paren
id|sk
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|err
op_assign
id|dn_route_output
c_func
(paren
op_amp
id|sk-&gt;dst_cache
comma
id|dn_saddr2dn
c_func
(paren
id|saddr
)paren
comma
id|dn_saddr2dn
c_func
(paren
op_amp
id|scp-&gt;addr
)paren
comma
l_int|0
)paren
)paren
OL
l_int|0
)paren
r_goto
id|out
suffix:semicolon
id|memcpy
c_func
(paren
op_amp
id|scp-&gt;peer
comma
id|saddr
comma
r_sizeof
(paren
r_struct
id|sockaddr_dn
)paren
)paren
suffix:semicolon
id|out
suffix:colon
id|release_sock
c_func
(paren
id|sk
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
multiline_comment|/*&n; * TBD.&n; */
DECL|function|dn_raw_sendmsg
r_static
r_int
id|dn_raw_sendmsg
c_func
(paren
r_struct
id|socket
op_star
id|sock
comma
r_struct
id|msghdr
op_star
id|hdr
comma
r_int
id|size
comma
r_struct
id|scm_cookie
op_star
id|scm
)paren
(brace
r_struct
id|sock
op_star
id|sk
op_assign
id|sock-&gt;sk
suffix:semicolon
r_if
c_cond
(paren
id|sk-&gt;zapped
)paren
id|dn_raw_autobind
c_func
(paren
id|sk
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sk-&gt;protocol
op_ne
id|DNPROTO_NSP
)paren
r_return
op_minus
id|EOPNOTSUPP
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * This works fine, execpt that it doesn&squot;t report the originating address&n; * or anything at the moment.&n; */
DECL|function|dn_raw_recvmsg
r_static
r_int
id|dn_raw_recvmsg
c_func
(paren
r_struct
id|socket
op_star
id|sock
comma
r_struct
id|msghdr
op_star
id|msg
comma
r_int
id|size
comma
r_int
id|flags
comma
r_struct
id|scm_cookie
op_star
id|scm
)paren
(brace
r_struct
id|sock
op_star
id|sk
op_assign
id|sock-&gt;sk
suffix:semicolon
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
r_int
id|err
op_assign
l_int|0
suffix:semicolon
r_int
id|copied
op_assign
l_int|0
suffix:semicolon
id|lock_sock
c_func
(paren
id|sk
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sk-&gt;zapped
)paren
id|dn_raw_autobind
c_func
(paren
id|sk
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|skb
op_assign
id|skb_recv_datagram
c_func
(paren
id|sk
comma
id|flags
op_amp
op_complement
id|MSG_DONTWAIT
comma
id|flags
op_amp
id|MSG_DONTWAIT
comma
op_amp
id|err
)paren
)paren
op_eq
l_int|NULL
)paren
r_goto
id|out
suffix:semicolon
id|copied
op_assign
id|skb-&gt;len
suffix:semicolon
r_if
c_cond
(paren
id|copied
OG
id|size
)paren
(brace
id|copied
op_assign
id|size
suffix:semicolon
id|msg-&gt;msg_flags
op_or_assign
id|MSG_TRUNC
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|err
op_assign
id|skb_copy_datagram_iovec
c_func
(paren
id|skb
comma
l_int|0
comma
id|msg-&gt;msg_iov
comma
id|copied
)paren
)paren
op_ne
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|flags
op_amp
id|MSG_PEEK
)paren
id|atomic_dec
c_func
(paren
op_amp
id|skb-&gt;users
)paren
suffix:semicolon
r_else
id|skb_queue_head
c_func
(paren
op_amp
id|sk-&gt;receive_queue
comma
id|skb
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|skb_free_datagram
c_func
(paren
id|sk
comma
id|skb
)paren
suffix:semicolon
id|out
suffix:colon
id|release_sock
c_func
(paren
id|sk
)paren
suffix:semicolon
r_return
id|copied
ques
c_cond
id|copied
suffix:colon
id|err
suffix:semicolon
)brace
DECL|variable|dn_raw_proto_ops
r_struct
id|proto_ops
id|dn_raw_proto_ops
op_assign
(brace
id|AF_DECnet
comma
id|dn_raw_release
comma
id|dn_raw_bind
comma
id|dn_raw_connect
comma
id|sock_no_socketpair
comma
id|sock_no_accept
comma
id|sock_no_getname
comma
id|datagram_poll
comma
id|sock_no_ioctl
comma
id|sock_no_listen
comma
id|sock_no_shutdown
comma
id|sock_no_setsockopt
comma
id|sock_no_getsockopt
comma
id|sock_no_fcntl
comma
id|dn_raw_sendmsg
comma
id|dn_raw_recvmsg
comma
id|sock_no_mmap
)brace
suffix:semicolon
macro_line|#ifdef CONFIG_PROC_FS
DECL|function|dn_raw_get_info
r_int
id|dn_raw_get_info
c_func
(paren
r_char
op_star
id|buffer
comma
r_char
op_star
op_star
id|start
comma
id|off_t
id|offset
comma
r_int
id|length
comma
r_int
id|dummy
)paren
(brace
r_int
id|len
op_assign
l_int|0
suffix:semicolon
id|off_t
id|pos
op_assign
l_int|0
suffix:semicolon
id|off_t
id|begin
op_assign
l_int|0
suffix:semicolon
r_struct
id|sock
op_star
id|sk
suffix:semicolon
id|read_lock_bh
c_func
(paren
op_amp
id|dn_raw_hash_lock
)paren
suffix:semicolon
r_for
c_loop
(paren
id|sk
op_assign
id|dn_raw_nsp_sklist
suffix:semicolon
id|sk
suffix:semicolon
id|sk
op_assign
id|sk-&gt;next
)paren
(brace
id|len
op_add_assign
id|sprintf
c_func
(paren
id|buffer
op_plus
id|len
comma
l_string|&quot;NSP&bslash;n&quot;
)paren
suffix:semicolon
id|pos
op_assign
id|begin
op_plus
id|len
suffix:semicolon
r_if
c_cond
(paren
id|pos
OL
id|offset
)paren
(brace
id|len
op_assign
l_int|0
suffix:semicolon
id|begin
op_assign
id|pos
suffix:semicolon
)brace
r_if
c_cond
(paren
id|pos
OG
id|offset
op_plus
id|length
)paren
r_goto
id|all_done
suffix:semicolon
)brace
r_for
c_loop
(paren
id|sk
op_assign
id|dn_raw_routing_sklist
suffix:semicolon
id|sk
suffix:semicolon
id|sk
op_assign
id|sk-&gt;next
)paren
(brace
id|len
op_add_assign
id|sprintf
c_func
(paren
id|buffer
op_plus
id|len
comma
l_string|&quot;ROU&bslash;n&quot;
)paren
suffix:semicolon
id|pos
op_assign
id|begin
op_plus
id|len
suffix:semicolon
r_if
c_cond
(paren
id|pos
OL
id|offset
)paren
(brace
id|len
op_assign
l_int|0
suffix:semicolon
id|begin
op_assign
id|pos
suffix:semicolon
)brace
r_if
c_cond
(paren
id|pos
OG
id|offset
op_plus
id|length
)paren
r_goto
id|all_done
suffix:semicolon
)brace
id|all_done
suffix:colon
id|read_unlock_bh
c_func
(paren
op_amp
id|dn_raw_hash_lock
)paren
suffix:semicolon
op_star
id|start
op_assign
id|buffer
op_plus
(paren
id|offset
op_minus
id|begin
)paren
suffix:semicolon
id|len
op_sub_assign
(paren
id|offset
op_minus
id|begin
)paren
suffix:semicolon
r_if
c_cond
(paren
id|len
OG
id|length
)paren
id|len
op_assign
id|length
suffix:semicolon
r_return
id|len
suffix:semicolon
)brace
macro_line|#endif /* CONFIG_PROC_FS */
DECL|function|dn_raw_rx_nsp
r_void
id|dn_raw_rx_nsp
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
)paren
(brace
r_struct
id|sock
op_star
id|sk
suffix:semicolon
r_struct
id|sk_buff
op_star
id|skb2
suffix:semicolon
id|read_lock
c_func
(paren
op_amp
id|dn_raw_hash_lock
)paren
suffix:semicolon
r_for
c_loop
(paren
id|sk
op_assign
id|dn_raw_nsp_sklist
suffix:semicolon
id|sk
op_ne
l_int|NULL
suffix:semicolon
id|sk
op_assign
id|sk-&gt;next
)paren
(brace
r_if
c_cond
(paren
id|skb-&gt;len
OG
id|sock_rspace
c_func
(paren
id|sk
)paren
)paren
r_continue
suffix:semicolon
r_if
c_cond
(paren
id|sk-&gt;dead
)paren
r_continue
suffix:semicolon
r_if
c_cond
(paren
(paren
id|skb2
op_assign
id|skb_clone
c_func
(paren
id|skb
comma
id|GFP_ATOMIC
)paren
)paren
op_ne
l_int|NULL
)paren
(brace
id|skb_set_owner_r
c_func
(paren
id|skb2
comma
id|sk
)paren
suffix:semicolon
id|skb_queue_tail
c_func
(paren
op_amp
id|sk-&gt;receive_queue
comma
id|skb2
)paren
suffix:semicolon
id|sk
op_member_access_from_pointer
id|data_ready
c_func
(paren
id|sk
comma
id|skb-&gt;len
)paren
suffix:semicolon
)brace
)brace
id|read_unlock
c_func
(paren
op_amp
id|dn_raw_hash_lock
)paren
suffix:semicolon
)brace
DECL|function|dn_raw_rx_routing
r_void
id|dn_raw_rx_routing
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
)paren
(brace
r_struct
id|sock
op_star
id|sk
suffix:semicolon
r_struct
id|sk_buff
op_star
id|skb2
suffix:semicolon
r_struct
id|dn_skb_cb
op_star
id|cb
op_assign
(paren
r_struct
id|dn_skb_cb
op_star
)paren
id|skb-&gt;cb
suffix:semicolon
r_int
r_int
id|rt_flagmask
suffix:semicolon
r_int
r_int
id|objnamel
suffix:semicolon
r_struct
id|dn_scp
op_star
id|scp
suffix:semicolon
id|read_lock
c_func
(paren
op_amp
id|dn_raw_hash_lock
)paren
suffix:semicolon
r_for
c_loop
(paren
id|sk
op_assign
id|dn_raw_routing_sklist
suffix:semicolon
id|sk
op_ne
l_int|NULL
suffix:semicolon
id|sk
op_assign
id|sk-&gt;next
)paren
(brace
r_if
c_cond
(paren
id|skb-&gt;len
OG
id|sock_rspace
c_func
(paren
id|sk
)paren
)paren
r_continue
suffix:semicolon
r_if
c_cond
(paren
id|sk-&gt;dead
)paren
r_continue
suffix:semicolon
id|scp
op_assign
op_amp
id|sk-&gt;protinfo.dn
suffix:semicolon
id|rt_flagmask
op_assign
id|dn_ntohs
c_func
(paren
op_star
(paren
r_int
r_int
op_star
)paren
id|scp-&gt;addr.sdn_objname
)paren
suffix:semicolon
id|objnamel
op_assign
id|dn_ntohs
c_func
(paren
id|scp-&gt;addr.sdn_objnamel
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|objnamel
op_eq
l_int|2
)paren
op_logical_and
(paren
op_logical_neg
(paren
(paren
l_int|1
op_lshift
(paren
id|cb-&gt;rt_flags
op_amp
l_int|0x0f
)paren
)paren
op_amp
id|rt_flagmask
)paren
)paren
)paren
r_continue
suffix:semicolon
r_if
c_cond
(paren
(paren
id|skb2
op_assign
id|skb_clone
c_func
(paren
id|skb
comma
id|GFP_ATOMIC
)paren
)paren
op_ne
l_int|NULL
)paren
(brace
id|skb_set_owner_r
c_func
(paren
id|skb2
comma
id|sk
)paren
suffix:semicolon
id|skb_queue_tail
c_func
(paren
op_amp
id|sk-&gt;receive_queue
comma
id|skb2
)paren
suffix:semicolon
id|sk
op_member_access_from_pointer
id|data_ready
c_func
(paren
id|sk
comma
id|skb-&gt;len
)paren
suffix:semicolon
)brace
)brace
id|read_unlock
c_func
(paren
op_amp
id|dn_raw_hash_lock
)paren
suffix:semicolon
)brace
eof
