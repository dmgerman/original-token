multiline_comment|/*&n; * DECnet       An implementation of the DECnet protocol suite for the LINUX&n; *              operating system.  DECnet is implemented using the  BSD Socket&n; *              interface as the means of communication with the user level.&n; *&n; *              DECnet Network Services Protocol (Input)&n; *&n; * Author:      Eduardo Marcelo Serrat &lt;emserrat@geocities.com&gt;&n; *&n; * Changes:&n; *&n; *    Steve Whitehouse:  Split into dn_nsp_in.c and dn_nsp_out.c from&n; *                       original dn_nsp.c.&n; *    Steve Whitehouse:  Updated to work with my new routing architecture.&n; *    Steve Whitehouse:  Add changes from Eduardo Serrat&squot;s patches.&n; *    Steve Whitehouse:  Put all ack handling code in a common routine.&n; *    Steve Whitehouse:  Put other common bits into dn_nsp_rx()&n; *    Steve Whitehouse:  More checks on skb-&gt;len to catch bogus packets&n; *                       Fixed various race conditions and possible nasties.&n; *    Steve Whitehouse:  Now handles returned conninit frames.&n; *     David S. Miller:  New socket locking&n; *    Steve Whitehouse:  Fixed lockup when socket filtering was enabled.&n; *         Paul Koning:  Fix to push CC sockets into RUN when acks are&n; *                       received.&n; *    Steve Whitehouse:&n; *   Patrick Caulfield:  Checking conninits for correctness &amp; sending of error&n; *                       responses.&n; */
multiline_comment|/******************************************************************************&n;    (c) 1995-1998 E.M. Serrat&t;&t;emserrat@geocities.com&n;    &n;    This program is free software; you can redistribute it and/or modify&n;    it under the terms of the GNU General Public License as published by&n;    the Free Software Foundation; either version 2 of the License, or&n;    any later version.&n;&n;    This program is distributed in the hope that it will be useful,&n;    but WITHOUT ANY WARRANTY; without even the implied warranty of&n;    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the&n;    GNU General Public License for more details.&n;*******************************************************************************/
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/socket.h&gt;
macro_line|#include &lt;linux/in.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/timer.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/sockios.h&gt;
macro_line|#include &lt;linux/net.h&gt;
macro_line|#include &lt;linux/netdevice.h&gt;
macro_line|#include &lt;linux/inet.h&gt;
macro_line|#include &lt;linux/route.h&gt;
macro_line|#include &lt;net/sock.h&gt;
macro_line|#include &lt;asm/segment.h&gt;
macro_line|#include &lt;asm/system.h&gt;
macro_line|#include &lt;linux/fcntl.h&gt;
macro_line|#include &lt;linux/mm.h&gt;
macro_line|#include &lt;linux/termios.h&gt;      
macro_line|#include &lt;linux/interrupt.h&gt;
macro_line|#include &lt;linux/proc_fs.h&gt;
macro_line|#include &lt;linux/stat.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/poll.h&gt;
macro_line|#include &lt;linux/netfilter_decnet.h&gt;
macro_line|#include &lt;net/neighbour.h&gt;
macro_line|#include &lt;net/dst.h&gt;
macro_line|#include &lt;net/dn_nsp.h&gt;
macro_line|#include &lt;net/dn_dev.h&gt;
macro_line|#include &lt;net/dn_route.h&gt;
r_extern
r_int
id|decnet_log_martians
suffix:semicolon
DECL|function|dn_log_martian
r_static
r_void
id|dn_log_martian
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_const
r_char
op_star
id|msg
)paren
(brace
r_if
c_cond
(paren
id|decnet_log_martians
op_logical_and
id|net_ratelimit
c_func
(paren
)paren
)paren
(brace
r_char
op_star
id|devname
op_assign
id|skb-&gt;dev
ques
c_cond
id|skb-&gt;dev-&gt;name
suffix:colon
l_string|&quot;???&quot;
suffix:semicolon
r_struct
id|dn_skb_cb
op_star
id|cb
op_assign
(paren
r_struct
id|dn_skb_cb
op_star
)paren
id|skb-&gt;cb
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;DECnet: Martian packet (%s) dev=%s src=0x%04hx dst=0x%04hx srcport=0x%04hx dstport=0x%04hx&bslash;n&quot;
comma
id|msg
comma
id|devname
comma
id|cb-&gt;src
comma
id|cb-&gt;dst
comma
id|cb-&gt;src_port
comma
id|cb-&gt;dst_port
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/*&n; * For this function we&squot;ve flipped the cross-subchannel bit&n; * if the message is an otherdata or linkservice message. Thus&n; * we can use it to work out what to update.&n; */
DECL|function|dn_ack
r_static
r_void
id|dn_ack
c_func
(paren
r_struct
id|sock
op_star
id|sk
comma
r_struct
id|sk_buff
op_star
id|skb
comma
r_int
r_int
id|ack
)paren
(brace
r_struct
id|dn_scp
op_star
id|scp
op_assign
op_amp
id|sk-&gt;protinfo.dn
suffix:semicolon
r_int
r_int
id|type
op_assign
(paren
(paren
id|ack
op_rshift
l_int|12
)paren
op_amp
l_int|0x0003
)paren
suffix:semicolon
r_int
id|wakeup
op_assign
l_int|0
suffix:semicolon
r_switch
c_cond
(paren
id|type
)paren
(brace
r_case
l_int|0
suffix:colon
multiline_comment|/* ACK - Data */
r_if
c_cond
(paren
id|after
c_func
(paren
id|ack
comma
id|scp-&gt;ackrcv_dat
)paren
)paren
(brace
id|scp-&gt;ackrcv_dat
op_assign
id|ack
op_amp
l_int|0x0fff
suffix:semicolon
id|wakeup
op_or_assign
id|dn_nsp_check_xmit_queue
c_func
(paren
id|sk
comma
id|skb
comma
op_amp
id|scp-&gt;data_xmit_queue
comma
id|ack
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
l_int|1
suffix:colon
multiline_comment|/* NAK - Data */
r_break
suffix:semicolon
r_case
l_int|2
suffix:colon
multiline_comment|/* ACK - OtherData */
r_if
c_cond
(paren
id|after
c_func
(paren
id|ack
comma
id|scp-&gt;ackrcv_oth
)paren
)paren
(brace
id|scp-&gt;ackrcv_oth
op_assign
id|ack
op_amp
l_int|0x0fff
suffix:semicolon
id|wakeup
op_or_assign
id|dn_nsp_check_xmit_queue
c_func
(paren
id|sk
comma
id|skb
comma
op_amp
id|scp-&gt;other_xmit_queue
comma
id|ack
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
l_int|3
suffix:colon
multiline_comment|/* NAK - OtherData */
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|wakeup
op_logical_and
op_logical_neg
id|sk-&gt;dead
)paren
id|sk
op_member_access_from_pointer
id|state_change
c_func
(paren
id|sk
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * This function is a universal ack processor.&n; */
DECL|function|dn_process_ack
r_static
r_int
id|dn_process_ack
c_func
(paren
r_struct
id|sock
op_star
id|sk
comma
r_struct
id|sk_buff
op_star
id|skb
comma
r_int
id|oth
)paren
(brace
r_int
r_int
op_star
id|ptr
op_assign
(paren
r_int
r_int
op_star
)paren
id|skb-&gt;data
suffix:semicolon
r_int
id|len
op_assign
l_int|0
suffix:semicolon
r_int
r_int
id|ack
suffix:semicolon
r_if
c_cond
(paren
id|skb-&gt;len
OL
l_int|2
)paren
r_return
id|len
suffix:semicolon
r_if
c_cond
(paren
(paren
id|ack
op_assign
id|dn_ntohs
c_func
(paren
op_star
id|ptr
)paren
)paren
op_amp
l_int|0x8000
)paren
(brace
id|skb_pull
c_func
(paren
id|skb
comma
l_int|2
)paren
suffix:semicolon
id|ptr
op_increment
suffix:semicolon
id|len
op_add_assign
l_int|2
suffix:semicolon
r_if
c_cond
(paren
(paren
id|ack
op_amp
l_int|0x4000
)paren
op_eq
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|oth
)paren
id|ack
op_xor_assign
l_int|0x2000
suffix:semicolon
id|dn_ack
c_func
(paren
id|sk
comma
id|skb
comma
id|ack
)paren
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|skb-&gt;len
OL
l_int|2
)paren
r_return
id|len
suffix:semicolon
r_if
c_cond
(paren
(paren
id|ack
op_assign
id|dn_ntohs
c_func
(paren
op_star
id|ptr
)paren
)paren
op_amp
l_int|0x8000
)paren
(brace
id|skb_pull
c_func
(paren
id|skb
comma
l_int|2
)paren
suffix:semicolon
id|len
op_add_assign
l_int|2
suffix:semicolon
r_if
c_cond
(paren
(paren
id|ack
op_amp
l_int|0x4000
)paren
op_eq
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|oth
)paren
id|ack
op_xor_assign
l_int|0x2000
suffix:semicolon
id|dn_ack
c_func
(paren
id|sk
comma
id|skb
comma
id|ack
)paren
suffix:semicolon
)brace
)brace
r_return
id|len
suffix:semicolon
)brace
multiline_comment|/**&n; * dn_check_idf - Check an image data field format is correct.&n; * @pptr: Pointer to pointer to image data&n; * @len: Pointer to length of image data&n; * @max: The maximum allowed length of the data in the image data field&n; * @follow_on: Check that this many bytes exist beyond the end of the image data&n; *&n; * Returns: 0 if ok, -1 on error&n; */
DECL|function|dn_check_idf
r_static
r_inline
r_int
id|dn_check_idf
c_func
(paren
r_int
r_char
op_star
op_star
id|pptr
comma
r_int
op_star
id|len
comma
r_int
r_char
id|max
comma
r_int
r_char
id|follow_on
)paren
(brace
r_int
r_char
op_star
id|ptr
op_assign
op_star
id|pptr
suffix:semicolon
r_int
r_char
id|flen
op_assign
op_star
id|ptr
op_increment
suffix:semicolon
(paren
op_star
id|len
)paren
op_decrement
suffix:semicolon
r_if
c_cond
(paren
id|flen
OG
id|max
)paren
r_return
op_minus
l_int|1
suffix:semicolon
r_if
c_cond
(paren
(paren
id|flen
op_plus
id|follow_on
)paren
OG
op_star
id|len
)paren
r_return
op_minus
l_int|1
suffix:semicolon
op_star
id|len
op_sub_assign
id|flen
suffix:semicolon
op_star
id|pptr
op_assign
id|ptr
op_plus
id|flen
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * Table of reason codes to pass back to node which sent us a badly&n; * formed message, plus text messages for the log. A zero entry in&n; * the reason field means &quot;don&squot;t reply&quot; otherwise a disc init is sent with&n; * the specified reason code.&n; */
r_static
r_struct
(brace
DECL|member|reason
r_int
r_int
id|reason
suffix:semicolon
DECL|member|text
r_const
r_char
op_star
id|text
suffix:semicolon
DECL|variable|ci_err_table
)brace
id|ci_err_table
(braket
)braket
op_assign
(brace
(brace
l_int|0
comma
l_string|&quot;CI: Truncated message&quot;
)brace
comma
(brace
id|NSP_REASON_ID
comma
l_string|&quot;CI: Destination username error&quot;
)brace
comma
(brace
id|NSP_REASON_ID
comma
l_string|&quot;CI: Destination username type&quot;
)brace
comma
(brace
id|NSP_REASON_US
comma
l_string|&quot;CI: Source username error&quot;
)brace
comma
(brace
l_int|0
comma
l_string|&quot;CI: Truncated at menuver&quot;
)brace
comma
(brace
l_int|0
comma
l_string|&quot;CI: Truncated before access or user data&quot;
)brace
comma
(brace
id|NSP_REASON_IO
comma
l_string|&quot;CI: Access data format error&quot;
)brace
comma
(brace
id|NSP_REASON_IO
comma
l_string|&quot;CI: User data format error&quot;
)brace
)brace
suffix:semicolon
multiline_comment|/*&n; * This function uses a slightly different lookup method&n; * to find its sockets, since it searches on object name/number&n; * rather than port numbers. Various tests are done to ensure that&n; * the incoming data is in the correct format before it is queued to&n; * a socket.&n; */
DECL|function|dn_find_listener
r_static
r_struct
id|sock
op_star
id|dn_find_listener
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_int
r_int
op_star
id|reason
)paren
(brace
r_struct
id|dn_skb_cb
op_star
id|cb
op_assign
(paren
r_struct
id|dn_skb_cb
op_star
)paren
id|skb-&gt;cb
suffix:semicolon
r_struct
id|nsp_conn_init_msg
op_star
id|msg
op_assign
(paren
r_struct
id|nsp_conn_init_msg
op_star
)paren
id|skb-&gt;data
suffix:semicolon
r_struct
id|sockaddr_dn
id|dstaddr
suffix:semicolon
r_struct
id|sockaddr_dn
id|srcaddr
suffix:semicolon
r_int
r_char
id|type
op_assign
l_int|0
suffix:semicolon
r_int
id|dstlen
suffix:semicolon
r_int
id|srclen
suffix:semicolon
r_int
r_char
op_star
id|ptr
suffix:semicolon
r_int
id|len
suffix:semicolon
r_int
id|err
op_assign
l_int|0
suffix:semicolon
r_int
r_char
id|menuver
suffix:semicolon
id|memset
c_func
(paren
op_amp
id|dstaddr
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|sockaddr_dn
)paren
)paren
suffix:semicolon
id|memset
c_func
(paren
op_amp
id|srcaddr
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|sockaddr_dn
)paren
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * 1. Decode &amp; remove message header&n;&t; */
id|cb-&gt;src_port
op_assign
id|msg-&gt;srcaddr
suffix:semicolon
id|cb-&gt;dst_port
op_assign
id|msg-&gt;dstaddr
suffix:semicolon
id|cb-&gt;services
op_assign
id|msg-&gt;services
suffix:semicolon
id|cb-&gt;info
op_assign
id|msg-&gt;info
suffix:semicolon
id|cb-&gt;segsize
op_assign
id|dn_ntohs
c_func
(paren
id|msg-&gt;segsize
)paren
suffix:semicolon
r_if
c_cond
(paren
id|skb-&gt;len
OL
r_sizeof
(paren
op_star
id|msg
)paren
)paren
r_goto
id|err_out
suffix:semicolon
id|skb_pull
c_func
(paren
id|skb
comma
r_sizeof
(paren
op_star
id|msg
)paren
)paren
suffix:semicolon
id|len
op_assign
id|skb-&gt;len
suffix:semicolon
id|ptr
op_assign
id|skb-&gt;data
suffix:semicolon
multiline_comment|/*&n;&t; * 2. Check destination end username format&n;&t; */
id|dstlen
op_assign
id|dn_username2sockaddr
c_func
(paren
id|ptr
comma
id|len
comma
op_amp
id|dstaddr
comma
op_amp
id|type
)paren
suffix:semicolon
id|err
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|dstlen
OL
l_int|0
)paren
r_goto
id|err_out
suffix:semicolon
id|err
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|type
OG
l_int|1
)paren
r_goto
id|err_out
suffix:semicolon
id|len
op_sub_assign
id|dstlen
suffix:semicolon
id|ptr
op_add_assign
id|dstlen
suffix:semicolon
multiline_comment|/*&n;&t; * 3. Check source end username format&n;&t; */
id|srclen
op_assign
id|dn_username2sockaddr
c_func
(paren
id|ptr
comma
id|len
comma
op_amp
id|srcaddr
comma
op_amp
id|type
)paren
suffix:semicolon
id|err
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|srclen
OL
l_int|0
)paren
r_goto
id|err_out
suffix:semicolon
id|len
op_sub_assign
id|srclen
suffix:semicolon
id|ptr
op_add_assign
id|srclen
suffix:semicolon
id|err
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|len
OL
l_int|1
)paren
r_goto
id|err_out
suffix:semicolon
id|menuver
op_assign
op_star
id|ptr
suffix:semicolon
id|ptr
op_increment
suffix:semicolon
id|len
op_decrement
suffix:semicolon
multiline_comment|/*&n;&t; * 4. Check that optional data actually exists if menuver says it does&n;&t; */
id|err
op_increment
suffix:semicolon
r_if
c_cond
(paren
(paren
id|menuver
op_amp
(paren
id|DN_MENUVER_ACC
op_or
id|DN_MENUVER_USR
)paren
)paren
op_logical_and
(paren
id|len
OL
l_int|1
)paren
)paren
r_goto
id|err_out
suffix:semicolon
multiline_comment|/*&n;&t; * 5. Check optional access data format&n;&t; */
id|err
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|menuver
op_amp
id|DN_MENUVER_ACC
)paren
(brace
r_if
c_cond
(paren
id|dn_check_idf
c_func
(paren
op_amp
id|ptr
comma
op_amp
id|len
comma
l_int|39
comma
l_int|1
)paren
)paren
r_goto
id|err_out
suffix:semicolon
r_if
c_cond
(paren
id|dn_check_idf
c_func
(paren
op_amp
id|ptr
comma
op_amp
id|len
comma
l_int|39
comma
l_int|1
)paren
)paren
r_goto
id|err_out
suffix:semicolon
r_if
c_cond
(paren
id|dn_check_idf
c_func
(paren
op_amp
id|ptr
comma
op_amp
id|len
comma
l_int|39
comma
(paren
id|menuver
op_amp
id|DN_MENUVER_USR
)paren
ques
c_cond
l_int|1
suffix:colon
l_int|0
)paren
)paren
r_goto
id|err_out
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * 6. Check optional user data format&n;&t; */
id|err
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|menuver
op_amp
id|DN_MENUVER_USR
)paren
(brace
r_if
c_cond
(paren
id|dn_check_idf
c_func
(paren
op_amp
id|ptr
comma
op_amp
id|len
comma
l_int|16
comma
l_int|0
)paren
)paren
r_goto
id|err_out
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * 7. Look up socket based on destination end username&n;&t; */
r_return
id|dn_sklist_find_listener
c_func
(paren
op_amp
id|dstaddr
)paren
suffix:semicolon
id|err_out
suffix:colon
id|dn_log_martian
c_func
(paren
id|skb
comma
id|ci_err_table
(braket
id|err
)braket
dot
id|text
)paren
suffix:semicolon
op_star
id|reason
op_assign
id|ci_err_table
(braket
id|err
)braket
dot
id|reason
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
DECL|function|dn_nsp_conn_init
r_static
r_void
id|dn_nsp_conn_init
c_func
(paren
r_struct
id|sock
op_star
id|sk
comma
r_struct
id|sk_buff
op_star
id|skb
)paren
(brace
r_if
c_cond
(paren
id|sk-&gt;ack_backlog
op_ge
id|sk-&gt;max_ack_backlog
)paren
(brace
id|kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|sk-&gt;ack_backlog
op_increment
suffix:semicolon
id|skb_queue_tail
c_func
(paren
op_amp
id|sk-&gt;receive_queue
comma
id|skb
)paren
suffix:semicolon
id|sk
op_member_access_from_pointer
id|state_change
c_func
(paren
id|sk
)paren
suffix:semicolon
)brace
DECL|function|dn_nsp_conn_conf
r_static
r_void
id|dn_nsp_conn_conf
c_func
(paren
r_struct
id|sock
op_star
id|sk
comma
r_struct
id|sk_buff
op_star
id|skb
)paren
(brace
r_struct
id|dn_skb_cb
op_star
id|cb
op_assign
(paren
r_struct
id|dn_skb_cb
op_star
)paren
id|skb-&gt;cb
suffix:semicolon
r_struct
id|dn_scp
op_star
id|scp
op_assign
op_amp
id|sk-&gt;protinfo.dn
suffix:semicolon
r_if
c_cond
(paren
id|skb-&gt;len
OL
l_int|3
)paren
r_goto
id|out
suffix:semicolon
id|cb-&gt;services
op_assign
op_star
id|skb-&gt;data
suffix:semicolon
id|cb-&gt;info
op_assign
op_star
(paren
id|skb-&gt;data
op_plus
l_int|1
)paren
suffix:semicolon
id|skb_pull
c_func
(paren
id|skb
comma
l_int|2
)paren
suffix:semicolon
id|cb-&gt;segsize
op_assign
id|dn_ntohs
c_func
(paren
op_star
(paren
id|__u16
op_star
)paren
id|skb-&gt;data
)paren
suffix:semicolon
id|skb_pull
c_func
(paren
id|skb
comma
l_int|2
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * FIXME: Check out services and info fields to check that&n;&t; * we can talk to this kind of node.&n;&t; */
r_if
c_cond
(paren
(paren
id|scp-&gt;state
op_eq
id|DN_CI
)paren
op_logical_or
(paren
id|scp-&gt;state
op_eq
id|DN_CD
)paren
)paren
(brace
id|scp-&gt;persist
op_assign
l_int|0
suffix:semicolon
id|scp-&gt;addrrem
op_assign
id|cb-&gt;src_port
suffix:semicolon
id|sk-&gt;state
op_assign
id|TCP_ESTABLISHED
suffix:semicolon
id|scp-&gt;state
op_assign
id|DN_RUN
suffix:semicolon
r_if
c_cond
(paren
id|scp-&gt;mss
OG
id|cb-&gt;segsize
)paren
id|scp-&gt;mss
op_assign
id|cb-&gt;segsize
suffix:semicolon
r_if
c_cond
(paren
id|scp-&gt;mss
OL
l_int|230
)paren
id|scp-&gt;mss
op_assign
l_int|230
suffix:semicolon
r_if
c_cond
(paren
id|skb-&gt;len
OG
l_int|0
)paren
(brace
r_int
r_char
id|dlen
op_assign
op_star
id|skb-&gt;data
suffix:semicolon
r_if
c_cond
(paren
(paren
id|dlen
op_le
l_int|16
)paren
op_logical_and
(paren
id|dlen
op_le
id|skb-&gt;len
)paren
)paren
(brace
id|scp-&gt;conndata_in.opt_optl
op_assign
id|dlen
suffix:semicolon
id|memcpy
c_func
(paren
id|scp-&gt;conndata_in.opt_data
comma
id|skb-&gt;data
op_plus
l_int|1
comma
id|dlen
)paren
suffix:semicolon
)brace
)brace
id|dn_nsp_send_lnk
c_func
(paren
id|sk
comma
id|DN_NOCHANGE
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|sk-&gt;dead
)paren
id|sk
op_member_access_from_pointer
id|state_change
c_func
(paren
id|sk
)paren
suffix:semicolon
)brace
id|out
suffix:colon
id|kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
)brace
DECL|function|dn_nsp_conn_ack
r_static
r_void
id|dn_nsp_conn_ack
c_func
(paren
r_struct
id|sock
op_star
id|sk
comma
r_struct
id|sk_buff
op_star
id|skb
)paren
(brace
r_struct
id|dn_scp
op_star
id|scp
op_assign
op_amp
id|sk-&gt;protinfo.dn
suffix:semicolon
r_if
c_cond
(paren
id|scp-&gt;state
op_eq
id|DN_CI
)paren
(brace
id|scp-&gt;state
op_assign
id|DN_CD
suffix:semicolon
id|scp-&gt;persist
op_assign
l_int|0
suffix:semicolon
)brace
id|kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
)brace
DECL|function|dn_nsp_disc_init
r_static
r_void
id|dn_nsp_disc_init
c_func
(paren
r_struct
id|sock
op_star
id|sk
comma
r_struct
id|sk_buff
op_star
id|skb
)paren
(brace
r_struct
id|dn_scp
op_star
id|scp
op_assign
op_amp
id|sk-&gt;protinfo.dn
suffix:semicolon
r_struct
id|dn_skb_cb
op_star
id|cb
op_assign
(paren
r_struct
id|dn_skb_cb
op_star
)paren
id|skb-&gt;cb
suffix:semicolon
r_int
r_int
id|reason
suffix:semicolon
r_if
c_cond
(paren
id|skb-&gt;len
OL
l_int|2
)paren
r_goto
id|out
suffix:semicolon
id|reason
op_assign
id|dn_ntohs
c_func
(paren
op_star
(paren
id|__u16
op_star
)paren
id|skb-&gt;data
)paren
suffix:semicolon
id|skb_pull
c_func
(paren
id|skb
comma
l_int|2
)paren
suffix:semicolon
id|scp-&gt;discdata_in.opt_status
op_assign
id|reason
suffix:semicolon
id|scp-&gt;discdata_in.opt_optl
op_assign
l_int|0
suffix:semicolon
id|memset
c_func
(paren
id|scp-&gt;discdata_in.opt_data
comma
l_int|0
comma
l_int|16
)paren
suffix:semicolon
r_if
c_cond
(paren
id|skb-&gt;len
OG
l_int|0
)paren
(brace
r_int
r_char
id|dlen
op_assign
op_star
id|skb-&gt;data
suffix:semicolon
r_if
c_cond
(paren
(paren
id|dlen
op_le
l_int|16
)paren
op_logical_and
(paren
id|dlen
op_le
id|skb-&gt;len
)paren
)paren
(brace
id|scp-&gt;discdata_in.opt_optl
op_assign
id|dlen
suffix:semicolon
id|memcpy
c_func
(paren
id|scp-&gt;discdata_in.opt_data
comma
id|skb-&gt;data
op_plus
l_int|1
comma
id|dlen
)paren
suffix:semicolon
)brace
)brace
id|scp-&gt;addrrem
op_assign
id|cb-&gt;src_port
suffix:semicolon
id|sk-&gt;state
op_assign
id|TCP_CLOSE
suffix:semicolon
r_switch
c_cond
(paren
id|scp-&gt;state
)paren
(brace
r_case
id|DN_CI
suffix:colon
r_case
id|DN_CD
suffix:colon
id|scp-&gt;state
op_assign
id|DN_RJ
suffix:semicolon
r_break
suffix:semicolon
r_case
id|DN_RUN
suffix:colon
id|sk-&gt;shutdown
op_or_assign
id|SHUTDOWN_MASK
suffix:semicolon
id|scp-&gt;state
op_assign
id|DN_DN
suffix:semicolon
r_break
suffix:semicolon
r_case
id|DN_DI
suffix:colon
id|scp-&gt;state
op_assign
id|DN_DIC
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|sk-&gt;dead
)paren
(brace
r_if
c_cond
(paren
id|sk-&gt;socket-&gt;state
op_ne
id|SS_UNCONNECTED
)paren
id|sk-&gt;socket-&gt;state
op_assign
id|SS_DISCONNECTING
suffix:semicolon
id|sk
op_member_access_from_pointer
id|state_change
c_func
(paren
id|sk
)paren
suffix:semicolon
)brace
id|dn_nsp_send_disc
c_func
(paren
id|sk
comma
id|NSP_DISCCONF
comma
id|NSP_REASON_DC
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
id|scp-&gt;persist_fxn
op_assign
id|dn_destroy_timer
suffix:semicolon
id|scp-&gt;persist
op_assign
id|dn_nsp_persist
c_func
(paren
id|sk
)paren
suffix:semicolon
id|out
suffix:colon
id|kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * disc_conf messages are also called no_resources or no_link&n; * messages depending upon the &quot;reason&quot; field.&n; */
DECL|function|dn_nsp_disc_conf
r_static
r_void
id|dn_nsp_disc_conf
c_func
(paren
r_struct
id|sock
op_star
id|sk
comma
r_struct
id|sk_buff
op_star
id|skb
)paren
(brace
r_struct
id|dn_scp
op_star
id|scp
op_assign
op_amp
id|sk-&gt;protinfo.dn
suffix:semicolon
r_int
r_int
id|reason
suffix:semicolon
r_if
c_cond
(paren
id|skb-&gt;len
op_ne
l_int|2
)paren
r_goto
id|out
suffix:semicolon
id|reason
op_assign
id|dn_ntohs
c_func
(paren
op_star
(paren
id|__u16
op_star
)paren
id|skb-&gt;data
)paren
suffix:semicolon
id|sk-&gt;state
op_assign
id|TCP_CLOSE
suffix:semicolon
r_switch
c_cond
(paren
id|scp-&gt;state
)paren
(brace
r_case
id|DN_CI
suffix:colon
id|scp-&gt;state
op_assign
id|DN_NR
suffix:semicolon
r_break
suffix:semicolon
r_case
id|DN_DR
suffix:colon
r_if
c_cond
(paren
id|reason
op_eq
id|NSP_REASON_DC
)paren
id|scp-&gt;state
op_assign
id|DN_DRC
suffix:semicolon
r_if
c_cond
(paren
id|reason
op_eq
id|NSP_REASON_NL
)paren
id|scp-&gt;state
op_assign
id|DN_CN
suffix:semicolon
r_break
suffix:semicolon
r_case
id|DN_DI
suffix:colon
id|scp-&gt;state
op_assign
id|DN_DIC
suffix:semicolon
r_break
suffix:semicolon
r_case
id|DN_RUN
suffix:colon
id|sk-&gt;shutdown
op_or_assign
id|SHUTDOWN_MASK
suffix:semicolon
r_case
id|DN_CC
suffix:colon
id|scp-&gt;state
op_assign
id|DN_CN
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|sk-&gt;dead
)paren
(brace
r_if
c_cond
(paren
id|sk-&gt;socket-&gt;state
op_ne
id|SS_UNCONNECTED
)paren
id|sk-&gt;socket-&gt;state
op_assign
id|SS_DISCONNECTING
suffix:semicolon
id|sk
op_member_access_from_pointer
id|state_change
c_func
(paren
id|sk
)paren
suffix:semicolon
)brace
id|scp-&gt;persist_fxn
op_assign
id|dn_destroy_timer
suffix:semicolon
id|scp-&gt;persist
op_assign
id|dn_nsp_persist
c_func
(paren
id|sk
)paren
suffix:semicolon
id|out
suffix:colon
id|kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
)brace
DECL|function|dn_nsp_linkservice
r_static
r_void
id|dn_nsp_linkservice
c_func
(paren
r_struct
id|sock
op_star
id|sk
comma
r_struct
id|sk_buff
op_star
id|skb
)paren
(brace
r_struct
id|dn_skb_cb
op_star
id|cb
op_assign
(paren
r_struct
id|dn_skb_cb
op_star
)paren
id|skb-&gt;cb
suffix:semicolon
r_int
r_int
id|segnum
suffix:semicolon
r_int
r_char
id|lsflags
suffix:semicolon
r_char
id|fcval
suffix:semicolon
r_if
c_cond
(paren
id|skb-&gt;len
op_ne
l_int|4
)paren
r_goto
id|out
suffix:semicolon
id|cb-&gt;segnum
op_assign
id|segnum
op_assign
id|dn_ntohs
c_func
(paren
op_star
(paren
id|__u16
op_star
)paren
id|skb-&gt;data
)paren
suffix:semicolon
id|skb_pull
c_func
(paren
id|skb
comma
l_int|2
)paren
suffix:semicolon
id|lsflags
op_assign
op_star
(paren
r_int
r_char
op_star
)paren
id|skb-&gt;data
suffix:semicolon
id|skb_pull
c_func
(paren
id|skb
comma
l_int|1
)paren
suffix:semicolon
id|fcval
op_assign
op_star
(paren
r_char
op_star
)paren
id|skb-&gt;data
suffix:semicolon
r_if
c_cond
(paren
id|lsflags
op_amp
l_int|0xf0
)paren
r_goto
id|out
suffix:semicolon
r_if
c_cond
(paren
(paren
(paren
id|sk-&gt;protinfo.dn.numoth_rcv
op_plus
l_int|1
)paren
op_amp
l_int|0x0FFF
)paren
op_eq
(paren
id|segnum
op_amp
l_int|0x0FFF
)paren
)paren
(brace
id|sk-&gt;protinfo.dn.numoth_rcv
op_add_assign
l_int|1
suffix:semicolon
r_switch
c_cond
(paren
id|lsflags
op_amp
l_int|0x03
)paren
(brace
r_case
l_int|0x00
suffix:colon
r_break
suffix:semicolon
r_case
l_int|0x01
suffix:colon
id|sk-&gt;protinfo.dn.flowrem_sw
op_assign
id|DN_DONTSEND
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x02
suffix:colon
id|sk-&gt;protinfo.dn.flowrem_sw
op_assign
id|DN_SEND
suffix:semicolon
id|dn_nsp_output
c_func
(paren
id|sk
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|sk-&gt;dead
)paren
id|sk
op_member_access_from_pointer
id|state_change
c_func
(paren
id|sk
)paren
suffix:semicolon
)brace
)brace
id|dn_nsp_send_oth_ack
c_func
(paren
id|sk
)paren
suffix:semicolon
id|out
suffix:colon
id|kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Copy of sock_queue_rcv_skb (from sock.h) without&n; * bh_lock_sock() (its already held when this is called) which&n; * also allows data and other data to be queued to a socket.&n; */
DECL|function|dn_queue_skb
r_static
id|__inline__
r_int
id|dn_queue_skb
c_func
(paren
r_struct
id|sock
op_star
id|sk
comma
r_struct
id|sk_buff
op_star
id|skb
comma
r_int
id|sig
comma
r_struct
id|sk_buff_head
op_star
id|queue
)paren
(brace
macro_line|#ifdef CONFIG_FILTER
r_struct
id|sk_filter
op_star
id|filter
suffix:semicolon
macro_line|#endif
multiline_comment|/* Cast skb-&gt;rcvbuf to unsigned... It&squot;s pointless, but reduces&n;           number of warnings when compiling with -W --ANK&n;         */
r_if
c_cond
(paren
id|atomic_read
c_func
(paren
op_amp
id|sk-&gt;rmem_alloc
)paren
op_plus
id|skb-&gt;truesize
op_ge
(paren
r_int
)paren
id|sk-&gt;rcvbuf
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
macro_line|#ifdef CONFIG_FILTER
r_if
c_cond
(paren
id|sk-&gt;filter
)paren
(brace
r_int
id|err
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
(paren
id|filter
op_assign
id|sk-&gt;filter
)paren
op_ne
l_int|NULL
op_logical_and
id|sk_filter
c_func
(paren
id|skb
comma
id|sk-&gt;filter
)paren
)paren
id|err
op_assign
op_minus
id|EPERM
suffix:semicolon
multiline_comment|/* Toss packet */
r_if
c_cond
(paren
id|err
)paren
r_return
id|err
suffix:semicolon
)brace
macro_line|#endif /* CONFIG_FILTER */
id|skb_set_owner_r
c_func
(paren
id|skb
comma
id|sk
)paren
suffix:semicolon
id|skb_queue_tail
c_func
(paren
id|queue
comma
id|skb
)paren
suffix:semicolon
multiline_comment|/* This code only runs from BH or BH protected context.&n;&t; * Therefore the plain read_lock is ok here. -DaveM&n;&t; */
id|read_lock
c_func
(paren
op_amp
id|sk-&gt;callback_lock
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|sk-&gt;dead
)paren
(brace
r_struct
id|socket
op_star
id|sock
op_assign
id|sk-&gt;socket
suffix:semicolon
id|wake_up_interruptible
c_func
(paren
id|sk-&gt;sleep
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sock
op_logical_and
id|sock-&gt;fasync_list
op_logical_and
op_logical_neg
id|test_bit
c_func
(paren
id|SOCK_ASYNC_WAITDATA
comma
op_amp
id|sock-&gt;flags
)paren
)paren
id|__kill_fasync
c_func
(paren
id|sock-&gt;fasync_list
comma
id|sig
comma
(paren
id|sig
op_eq
id|SIGURG
)paren
ques
c_cond
id|POLL_PRI
suffix:colon
id|POLL_IN
)paren
suffix:semicolon
)brace
id|read_unlock
c_func
(paren
op_amp
id|sk-&gt;callback_lock
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|dn_nsp_otherdata
r_static
r_void
id|dn_nsp_otherdata
c_func
(paren
r_struct
id|sock
op_star
id|sk
comma
r_struct
id|sk_buff
op_star
id|skb
)paren
(brace
r_struct
id|dn_scp
op_star
id|scp
op_assign
op_amp
id|sk-&gt;protinfo.dn
suffix:semicolon
r_int
r_int
id|segnum
suffix:semicolon
r_struct
id|dn_skb_cb
op_star
id|cb
op_assign
(paren
r_struct
id|dn_skb_cb
op_star
)paren
id|skb-&gt;cb
suffix:semicolon
r_int
id|queued
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|skb-&gt;len
OL
l_int|2
)paren
r_goto
id|out
suffix:semicolon
id|cb-&gt;segnum
op_assign
id|segnum
op_assign
id|dn_ntohs
c_func
(paren
op_star
(paren
id|__u16
op_star
)paren
id|skb-&gt;data
)paren
suffix:semicolon
id|skb_pull
c_func
(paren
id|skb
comma
l_int|2
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
(paren
id|sk-&gt;protinfo.dn.numoth_rcv
op_plus
l_int|1
)paren
op_amp
l_int|0x0fff
)paren
op_eq
(paren
id|segnum
op_amp
l_int|0x0fff
)paren
)paren
(brace
r_if
c_cond
(paren
id|dn_queue_skb
c_func
(paren
id|sk
comma
id|skb
comma
id|SIGURG
comma
op_amp
id|scp-&gt;other_receive_queue
)paren
op_eq
l_int|0
)paren
(brace
id|sk-&gt;protinfo.dn.numoth_rcv
op_increment
suffix:semicolon
id|scp-&gt;other_report
op_assign
l_int|0
suffix:semicolon
id|queued
op_assign
l_int|1
suffix:semicolon
)brace
)brace
id|dn_nsp_send_oth_ack
c_func
(paren
id|sk
)paren
suffix:semicolon
id|out
suffix:colon
r_if
c_cond
(paren
op_logical_neg
id|queued
)paren
id|kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
)brace
DECL|function|dn_nsp_data
r_static
r_void
id|dn_nsp_data
c_func
(paren
r_struct
id|sock
op_star
id|sk
comma
r_struct
id|sk_buff
op_star
id|skb
)paren
(brace
r_int
id|queued
op_assign
l_int|0
suffix:semicolon
r_int
r_int
id|segnum
suffix:semicolon
r_struct
id|dn_skb_cb
op_star
id|cb
op_assign
(paren
r_struct
id|dn_skb_cb
op_star
)paren
id|skb-&gt;cb
suffix:semicolon
r_struct
id|dn_scp
op_star
id|scp
op_assign
op_amp
id|sk-&gt;protinfo.dn
suffix:semicolon
r_if
c_cond
(paren
id|skb-&gt;len
OL
l_int|2
)paren
r_goto
id|out
suffix:semicolon
id|cb-&gt;segnum
op_assign
id|segnum
op_assign
id|dn_ntohs
c_func
(paren
op_star
(paren
id|__u16
op_star
)paren
id|skb-&gt;data
)paren
suffix:semicolon
id|skb_pull
c_func
(paren
id|skb
comma
l_int|2
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
(paren
id|sk-&gt;protinfo.dn.numdat_rcv
op_plus
l_int|1
)paren
op_amp
l_int|0x0FFF
)paren
op_eq
(paren
id|segnum
op_amp
l_int|0x0FFF
)paren
)paren
(brace
r_if
c_cond
(paren
id|dn_queue_skb
c_func
(paren
id|sk
comma
id|skb
comma
id|SIGIO
comma
op_amp
id|sk-&gt;receive_queue
)paren
op_eq
l_int|0
)paren
(brace
id|sk-&gt;protinfo.dn.numdat_rcv
op_increment
suffix:semicolon
id|queued
op_assign
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|scp-&gt;flowloc_sw
op_eq
id|DN_SEND
)paren
op_logical_and
id|dn_congested
c_func
(paren
id|sk
)paren
)paren
(brace
id|scp-&gt;flowloc_sw
op_assign
id|DN_DONTSEND
suffix:semicolon
id|dn_nsp_send_lnk
c_func
(paren
id|sk
comma
id|DN_DONTSEND
)paren
suffix:semicolon
)brace
)brace
id|dn_nsp_send_data_ack
c_func
(paren
id|sk
)paren
suffix:semicolon
id|out
suffix:colon
r_if
c_cond
(paren
op_logical_neg
id|queued
)paren
id|kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * If one of our conninit messages is returned, this function&n; * deals with it. It puts the socket into the NO_COMMUNICATION&n; * state.&n; */
DECL|function|dn_returned_conn_init
r_static
r_void
id|dn_returned_conn_init
c_func
(paren
r_struct
id|sock
op_star
id|sk
comma
r_struct
id|sk_buff
op_star
id|skb
)paren
(brace
r_struct
id|dn_scp
op_star
id|scp
op_assign
op_amp
id|sk-&gt;protinfo.dn
suffix:semicolon
r_if
c_cond
(paren
id|scp-&gt;state
op_eq
id|DN_CI
)paren
(brace
id|scp-&gt;state
op_assign
id|DN_NC
suffix:semicolon
id|sk-&gt;state
op_assign
id|TCP_CLOSE
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|sk-&gt;dead
)paren
id|sk
op_member_access_from_pointer
id|state_change
c_func
(paren
id|sk
)paren
suffix:semicolon
)brace
id|kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
)brace
DECL|function|dn_nsp_no_socket
r_static
r_void
id|dn_nsp_no_socket
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_int
r_int
id|reason
)paren
(brace
r_struct
id|dn_skb_cb
op_star
id|cb
op_assign
(paren
r_struct
id|dn_skb_cb
op_star
)paren
id|skb-&gt;cb
suffix:semicolon
r_if
c_cond
(paren
(paren
id|reason
op_ne
id|NSP_REASON_OK
)paren
op_logical_and
(paren
(paren
id|cb-&gt;nsp_flags
op_amp
l_int|0x0c
)paren
op_eq
l_int|0x08
)paren
)paren
(brace
r_switch
c_cond
(paren
id|cb-&gt;nsp_flags
op_amp
l_int|0x70
)paren
(brace
r_case
l_int|0x10
suffix:colon
r_case
l_int|0x60
suffix:colon
multiline_comment|/* (Retransmitted) Connect Init */
id|dn_nsp_return_disc
c_func
(paren
id|skb
comma
id|NSP_DISCINIT
comma
id|reason
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x20
suffix:colon
multiline_comment|/* Connect Confirm */
id|dn_nsp_return_disc
c_func
(paren
id|skb
comma
id|NSP_DISCCONF
comma
id|reason
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
id|kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
)brace
DECL|function|dn_nsp_rx_packet
r_static
r_int
id|dn_nsp_rx_packet
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
)paren
(brace
r_struct
id|dn_skb_cb
op_star
id|cb
op_assign
(paren
r_struct
id|dn_skb_cb
op_star
)paren
id|skb-&gt;cb
suffix:semicolon
r_struct
id|sock
op_star
id|sk
op_assign
l_int|NULL
suffix:semicolon
r_int
r_char
op_star
id|ptr
op_assign
(paren
r_int
r_char
op_star
)paren
id|skb-&gt;data
suffix:semicolon
r_int
r_int
id|reason
op_assign
id|NSP_REASON_NL
suffix:semicolon
id|skb-&gt;h.raw
op_assign
id|skb-&gt;data
suffix:semicolon
id|cb-&gt;nsp_flags
op_assign
op_star
id|ptr
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|decnet_debug_level
op_amp
l_int|2
)paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;dn_nsp_rx: Message type 0x%02x&bslash;n&quot;
comma
(paren
r_int
)paren
id|cb-&gt;nsp_flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|skb-&gt;len
OL
l_int|2
)paren
r_goto
id|free_out
suffix:semicolon
r_if
c_cond
(paren
id|cb-&gt;nsp_flags
op_amp
l_int|0x83
)paren
r_goto
id|free_out
suffix:semicolon
multiline_comment|/*&n;&t; * Returned packets...&n;&t; * Swap src &amp; dst and look up in the normal way.&n;&t; */
r_if
c_cond
(paren
id|cb-&gt;rt_flags
op_amp
id|DN_RT_F_RTS
)paren
(brace
r_int
r_int
id|tmp
op_assign
id|cb-&gt;dst_port
suffix:semicolon
id|cb-&gt;dst_port
op_assign
id|cb-&gt;src_port
suffix:semicolon
id|cb-&gt;src_port
op_assign
id|tmp
suffix:semicolon
id|tmp
op_assign
id|cb-&gt;dst
suffix:semicolon
id|cb-&gt;dst
op_assign
id|cb-&gt;src
suffix:semicolon
id|cb-&gt;src
op_assign
id|tmp
suffix:semicolon
id|sk
op_assign
id|dn_find_by_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
r_goto
id|got_it
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * Filter out conninits and useless packet types&n;&t; */
r_if
c_cond
(paren
(paren
id|cb-&gt;nsp_flags
op_amp
l_int|0x0c
)paren
op_eq
l_int|0x08
)paren
(brace
r_switch
c_cond
(paren
id|cb-&gt;nsp_flags
op_amp
l_int|0x70
)paren
(brace
r_case
l_int|0x00
suffix:colon
multiline_comment|/* NOP */
r_case
l_int|0x70
suffix:colon
multiline_comment|/* Reserved */
r_case
l_int|0x50
suffix:colon
multiline_comment|/* Reserved, Phase II node init */
r_goto
id|free_out
suffix:semicolon
r_case
l_int|0x10
suffix:colon
r_case
l_int|0x60
suffix:colon
id|sk
op_assign
id|dn_find_listener
c_func
(paren
id|skb
comma
op_amp
id|reason
)paren
suffix:semicolon
r_goto
id|got_it
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|skb-&gt;len
OL
l_int|3
)paren
r_goto
id|free_out
suffix:semicolon
multiline_comment|/*&n;&t; * Grab the destination address.&n;&t; */
id|cb-&gt;dst_port
op_assign
op_star
(paren
r_int
r_int
op_star
)paren
id|ptr
suffix:semicolon
id|cb-&gt;src_port
op_assign
l_int|0
suffix:semicolon
id|ptr
op_add_assign
l_int|2
suffix:semicolon
multiline_comment|/*&n;&t; * If not a connack, grab the source address too.&n;&t; */
r_if
c_cond
(paren
id|skb-&gt;len
op_ge
l_int|5
)paren
(brace
id|cb-&gt;src_port
op_assign
op_star
(paren
r_int
r_int
op_star
)paren
id|ptr
suffix:semicolon
id|ptr
op_add_assign
l_int|2
suffix:semicolon
id|skb_pull
c_func
(paren
id|skb
comma
l_int|5
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * Find the socket to which this skb is destined.&n;&t; */
id|sk
op_assign
id|dn_find_by_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
id|got_it
suffix:colon
r_if
c_cond
(paren
id|sk
op_ne
l_int|NULL
)paren
(brace
r_struct
id|dn_scp
op_star
id|scp
op_assign
op_amp
id|sk-&gt;protinfo.dn
suffix:semicolon
r_int
id|ret
suffix:semicolon
multiline_comment|/* Reset backoff */
id|scp-&gt;nsp_rxtshift
op_assign
l_int|0
suffix:semicolon
id|bh_lock_sock
c_func
(paren
id|sk
)paren
suffix:semicolon
id|ret
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|sk-&gt;lock.users
op_eq
l_int|0
)paren
id|ret
op_assign
id|dn_nsp_backlog_rcv
c_func
(paren
id|sk
comma
id|skb
)paren
suffix:semicolon
r_else
id|sk_add_backlog
c_func
(paren
id|sk
comma
id|skb
)paren
suffix:semicolon
id|bh_unlock_sock
c_func
(paren
id|sk
)paren
suffix:semicolon
id|sock_put
c_func
(paren
id|sk
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
id|dn_nsp_no_socket
c_func
(paren
id|skb
comma
id|reason
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
id|free_out
suffix:colon
id|kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|dn_nsp_rx
r_int
id|dn_nsp_rx
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
)paren
(brace
r_return
id|NF_HOOK
c_func
(paren
id|PF_DECnet
comma
id|NF_DN_LOCAL_IN
comma
id|skb
comma
id|skb-&gt;dev
comma
l_int|NULL
comma
id|dn_nsp_rx_packet
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * This is the main receive routine for sockets. It is called&n; * from the above when the socket is not busy, and also from&n; * sock_release() when there is a backlog queued up.&n; */
DECL|function|dn_nsp_backlog_rcv
r_int
id|dn_nsp_backlog_rcv
c_func
(paren
r_struct
id|sock
op_star
id|sk
comma
r_struct
id|sk_buff
op_star
id|skb
)paren
(brace
r_struct
id|dn_scp
op_star
id|scp
op_assign
op_amp
id|sk-&gt;protinfo.dn
suffix:semicolon
r_struct
id|dn_skb_cb
op_star
id|cb
op_assign
(paren
r_struct
id|dn_skb_cb
op_star
)paren
id|skb-&gt;cb
suffix:semicolon
r_if
c_cond
(paren
id|cb-&gt;rt_flags
op_amp
id|DN_RT_F_RTS
)paren
(brace
id|dn_returned_conn_init
c_func
(paren
id|sk
comma
id|skb
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * Control packet.&n;&t; */
r_if
c_cond
(paren
(paren
id|cb-&gt;nsp_flags
op_amp
l_int|0x0c
)paren
op_eq
l_int|0x08
)paren
(brace
r_switch
c_cond
(paren
id|cb-&gt;nsp_flags
op_amp
l_int|0x70
)paren
(brace
r_case
l_int|0x10
suffix:colon
r_case
l_int|0x60
suffix:colon
id|dn_nsp_conn_init
c_func
(paren
id|sk
comma
id|skb
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x20
suffix:colon
id|dn_nsp_conn_conf
c_func
(paren
id|sk
comma
id|skb
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x30
suffix:colon
id|dn_nsp_disc_init
c_func
(paren
id|sk
comma
id|skb
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x40
suffix:colon
id|dn_nsp_disc_conf
c_func
(paren
id|sk
comma
id|skb
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
r_else
r_if
c_cond
(paren
id|cb-&gt;nsp_flags
op_eq
l_int|0x24
)paren
(brace
multiline_comment|/*&n;&t;&t; * Special for connacks, &squot;cos they don&squot;t have&n;&t;&t; * ack data or ack otherdata info.&n;&t;&t; */
id|dn_nsp_conn_ack
c_func
(paren
id|sk
comma
id|skb
)paren
suffix:semicolon
)brace
r_else
(brace
r_int
id|other
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* both data and ack frames can kick a CC socket into RUN */
r_if
c_cond
(paren
(paren
id|scp-&gt;state
op_eq
id|DN_CC
)paren
op_logical_and
op_logical_neg
id|sk-&gt;dead
)paren
(brace
id|scp-&gt;state
op_assign
id|DN_RUN
suffix:semicolon
id|sk-&gt;state
op_assign
id|TCP_ESTABLISHED
suffix:semicolon
id|sk
op_member_access_from_pointer
id|state_change
c_func
(paren
id|sk
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|cb-&gt;nsp_flags
op_amp
l_int|0x1c
)paren
op_eq
l_int|0
)paren
id|other
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|cb-&gt;nsp_flags
op_eq
l_int|0x04
)paren
id|other
op_assign
l_int|0
suffix:semicolon
multiline_comment|/*&n;&t;&t; * Read out ack data here, this applies equally&n;&t;&t; * to data, other data, link serivce and both&n;&t;&t; * ack data and ack otherdata.&n;&t;&t; */
id|dn_process_ack
c_func
(paren
id|sk
comma
id|skb
comma
id|other
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t; * If we&squot;ve some sort of data here then call a&n;&t;&t; * suitable routine for dealing with it, otherwise&n;&t;&t; * the packet is an ack and can be discarded.&n;&t;&t; */
r_if
c_cond
(paren
(paren
id|cb-&gt;nsp_flags
op_amp
l_int|0x0c
)paren
op_eq
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|scp-&gt;state
op_ne
id|DN_RUN
)paren
r_goto
id|free_out
suffix:semicolon
r_switch
c_cond
(paren
id|cb-&gt;nsp_flags
)paren
(brace
r_case
l_int|0x10
suffix:colon
multiline_comment|/* LS */
id|dn_nsp_linkservice
c_func
(paren
id|sk
comma
id|skb
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x30
suffix:colon
multiline_comment|/* OD */
id|dn_nsp_otherdata
c_func
(paren
id|sk
comma
id|skb
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|dn_nsp_data
c_func
(paren
id|sk
comma
id|skb
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
multiline_comment|/* Ack, chuck it out here */
id|free_out
suffix:colon
id|kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
)brace
)brace
r_return
l_int|0
suffix:semicolon
)brace
eof
