multiline_comment|/*&n; *&t;NetBIOS name handler&n; */
multiline_comment|/*&n; *&t;You must hold the netbios name lock before using these.&n; */
DECL|function|nb_name_find
r_struct
id|nb_name
op_star
id|nb_name_find
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
r_const
r_char
op_star
id|name
)paren
(brace
r_struct
id|nb_name
op_star
id|nb
op_assign
id|nb_name_list
suffix:semicolon
r_while
c_loop
(paren
id|nb
op_ne
l_int|NULL
)paren
(brace
r_if
c_cond
(paren
(paren
id|dev
op_eq
l_int|NULL
op_logical_or
id|dev
op_eq
id|nb-&gt;dev
)paren
op_logical_and
id|strncmp
c_func
(paren
id|name
comma
id|nb-&gt;name
comma
id|NB_NAME_LEN
)paren
op_eq
l_int|0
)paren
(brace
r_return
id|nb
suffix:semicolon
)brace
id|nb
op_assign
id|nb-&gt;next
suffix:semicolon
)brace
r_return
l_int|NULL
suffix:semicolon
)brace
DECL|function|nb_name_add
r_int
id|nb_name_add
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
r_const
r_char
op_star
id|name
comma
r_int
id|ours
comma
r_int
id|pri
)paren
(brace
r_struct
id|nb_name
op_star
id|nb
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
op_star
id|nb
)paren
comma
id|pri
)paren
suffix:semicolon
r_if
c_cond
(paren
id|nb
op_eq
l_int|NULL
)paren
(brace
r_return
l_int|NULL
suffix:semicolon
)brace
id|nb-&gt;dev
op_assign
id|dev
suffix:semicolon
id|strncpy
c_func
(paren
id|nb-&gt;name
comma
id|name
comma
id|NB_NAME_LEN
)paren
suffix:semicolon
id|nb-&gt;name
(braket
id|NB_NAME_LEN
op_minus
l_int|1
)braket
op_assign
l_int|0
suffix:semicolon
id|nb-&gt;next
op_assign
id|nb_name_list
suffix:semicolon
id|nb-&gt;ours
op_assign
id|ours
suffix:semicolon
id|nb_name_list
op_assign
id|nb
suffix:semicolon
)brace
DECL|function|nb_name_delete
r_void
id|nb_name_delete
c_func
(paren
r_struct
id|nb_name
op_star
id|nb
)paren
(brace
r_struct
id|nb_name
op_star
id|i
op_assign
op_amp
id|nb_name_list
suffix:semicolon
r_while
c_loop
(paren
(paren
op_star
id|i
)paren
op_ne
l_int|NULL
)paren
(brace
r_if
c_cond
(paren
op_star
id|i
op_eq
id|nb
)paren
(brace
op_star
id|i
op_assign
id|nb-&gt;next
suffix:semicolon
id|kfree_s
c_func
(paren
id|nb
comma
r_sizeof
(paren
op_star
id|nb
)paren
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|i
op_assign
op_amp
(paren
(paren
op_star
id|i
)paren
op_member_access_from_pointer
id|next
)paren
suffix:semicolon
)brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;nb_name_delete: bad name pointer!&bslash;n&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;NETBIOS name handlers&n; */
DECL|function|nb_defend
r_static
r_void
id|nb_defend
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
r_const
r_char
op_star
id|name
)paren
(brace
r_struct
id|sk_buff
op_star
id|nskb
op_assign
id|nb_alloc_skb
c_func
(paren
id|NB_CONTROL_LEN
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
id|nskb
op_eq
l_int|NULL
)paren
(brace
r_return
suffix:semicolon
)brace
multiline_comment|/* Build a name defence packet */
id|nskb-&gt;dev
op_assign
id|dev
suffix:semicolon
id|nskb-&gt;priority
op_assign
id|TC_PRIO_CONTROL
suffix:semicolon
id|dev_queue_xmit
c_func
(paren
id|nskb
)paren
suffix:semicolon
)brace
DECL|function|netbeui_heard_name
r_void
id|netbeui_heard_name
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
r_struct
id|sk_buff
op_star
id|skb
)paren
(brace
r_struct
id|nb_name
op_star
id|nb
suffix:semicolon
id|name
op_assign
dot
dot
dot
r_if
c_cond
(paren
(paren
id|nb
op_assign
id|nb_name_find
c_func
(paren
id|dev
comma
id|name
)paren
)paren
op_ne
l_int|NULL
)paren
(brace
multiline_comment|/*&n;&t;&t; *&t;If we own the name then defend it&n;&t;&t; */
r_if
c_cond
(paren
id|nb-&gt;our
op_logical_and
op_logical_neg
id|nb-&gt;state
op_eq
id|NB_ACQUIRE
)paren
(brace
id|nb_defend
c_func
(paren
id|dev
comma
id|name
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;&t;&t; *&t;A name has been resolved. Wake up pending&n;&t;&t; *&t;connectors.&n;&t;&t; */
r_if
c_cond
(paren
id|nb-&gt;state
op_eq
id|NB_QUERY
)paren
(brace
id|nb-&gt;state
op_assign
id|NB_OTHER
suffix:semicolon
id|nb_complete
c_func
(paren
id|nb
comma
id|skb
)paren
suffix:semicolon
)brace
)brace
id|kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;Handle incoming name defences&n; */
DECL|function|netbeui_name_defence
r_void
id|netbeui_name_defence
c_func
(paren
r_struct
id|dev
op_star
id|dev
comma
r_struct
id|sk_buff
op_star
id|skb
)paren
(brace
r_struct
id|nb_name
op_star
id|name
suffix:semicolon
id|name
op_assign
r_if
c_cond
(paren
(paren
id|nb
op_assign
id|nb_name_find
c_func
(paren
id|dev
comma
id|name
)paren
)paren
op_ne
l_int|NULL
)paren
(brace
r_if
c_cond
(paren
id|nb-&gt;ours
)paren
(brace
multiline_comment|/*&t;&n;&t;&t;&t; *&t;We wanted it, we got told its used&n;&t;&t;&t; */
r_if
c_cond
(paren
id|nb-&gt;state
op_eq
id|NB_ACQUIRE
)paren
(brace
multiline_comment|/*&n;&t;&t;&t;&t; *&t;Fill in the record for its true&n;&t;&t;&t;&t; *&t;owner. Set the state first as&n;&t;&t;&t;&t; *&t;nb_complete may well delete the&n;&t;&t;&t;&t; *&t;record.&n;&t;&t;&t;&t; */
id|nb-&gt;state
op_assign
id|NB_OTHER
suffix:semicolon
id|nb_complete
c_func
(paren
id|nb
comma
id|skb
)paren
suffix:semicolon
id|nb_wakeup
c_func
(paren
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;&t;&t;&t; *&t;We own it we got told its used. This is&n;&t;&t;&t; *&t;a deep cack even that can only occur when&n;&t;&t;&t; *&t;a bridge comes back and the net was split.&n;&t;&t;&t; *&t;Make sure both sides lose.&n;&t;&t;&t; */
r_if
c_cond
(paren
id|nb-&gt;state
op_eq
id|NB_OURS
op_logical_or
id|nb-&gt;state
op_eq
id|NB_COLLIDE
)paren
(brace
id|nb-&gt;state
op_assign
id|NR_COLLIDE
suffix:semicolon
id|nb_wakeup
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t;&t;&t; *&t;Kill the other copy too&n;&t;&t;&t;&t; */
id|nb_defend
c_func
(paren
id|dev
comma
id|name
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t;&t;&t; *&t;Timer expiry will delete our&n;&t;&t;&t;&t; *&t;record.&n;&t;&t;&t;&t; */
id|nb_start_timer
c_func
(paren
id|nb
comma
id|NB_TIME_COLLIDED
)paren
suffix:semicolon
)brace
)brace
)brace
id|kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
)brace
DECL|function|netbeui_name_query
r_void
id|netbeui_name_query
c_func
(paren
r_struct
id|dev
op_star
id|dev
comma
r_struct
id|sk_buff
op_star
id|skb
)paren
(brace
r_char
op_star
id|name
op_assign
dot
dot
dot
r_struct
id|nb_name
op_star
id|nb
op_assign
id|nb_find_name
c_func
(paren
id|dev
comma
id|name
)paren
suffix:semicolon
r_if
c_cond
(paren
id|nb
op_ne
l_int|NULL
op_logical_and
id|nb-&gt;ours
)paren
(brace
r_struct
id|sk_buff
op_star
id|nskb
op_assign
id|nb_alloc_skb
c_func
(paren
id|NB_CONTROL_LEN
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
id|nskb
op_ne
l_int|NULL
)paren
(brace
multiline_comment|/* Build a name reply packet */
id|nskb-&gt;dev
op_assign
id|dev
suffix:semicolon
id|nskb-&gt;priority
op_assign
id|TC_PRIO_CONTROL
suffix:semicolon
id|dev_queue_xmit
c_func
(paren
id|nskb
)paren
suffix:semicolon
)brace
)brace
id|kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
)brace
eof
