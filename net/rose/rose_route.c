multiline_comment|/*&n; *&t;ROSE release 002&n; *&n; *&t;This code REQUIRES 2.1.15 or higher/ NET3.038&n; *&n; *&t;This module:&n; *&t;&t;This module is free software; you can redistribute it and/or&n; *&t;&t;modify it under the terms of the GNU General Public License&n; *&t;&t;as published by the Free Software Foundation; either version&n; *&t;&t;2 of the License, or (at your option) any later version.&n; *&n; *&t;History&n; *&t;ROSE 001&t;Jonathan(G4KLX)&t;Cloned from nr_route.c.&n; *&t;&t;&t;Terry(VK2KTJ)&t;Added support for variable length&n; *&t;&t;&t;&t;&t;address masks.&n; *&t;ROSE 002&t;Jonathan(G4KLX)&t;Uprated through routing of packets.&n; *&t;&t;&t;&t;&t;Routing loop detection.&n; */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#if defined(CONFIG_ROSE) || defined(CONFIG_ROSE_MODULE)
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/socket.h&gt;
macro_line|#include &lt;linux/in.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/timer.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/sockios.h&gt;
macro_line|#include &lt;linux/net.h&gt;
macro_line|#include &lt;net/ax25.h&gt;
macro_line|#include &lt;linux/inet.h&gt;
macro_line|#include &lt;linux/netdevice.h&gt;
macro_line|#include &lt;net/arp.h&gt;
macro_line|#include &lt;linux/if_arp.h&gt;
macro_line|#include &lt;linux/skbuff.h&gt;
macro_line|#include &lt;net/sock.h&gt;
macro_line|#include &lt;asm/segment.h&gt;
macro_line|#include &lt;asm/system.h&gt;
macro_line|#include &lt;asm/uaccess.h&gt;
macro_line|#include &lt;linux/fcntl.h&gt;
macro_line|#include &lt;linux/termios.h&gt;&t;/* For TIOCINQ/OUTQ */
macro_line|#include &lt;linux/mm.h&gt;
macro_line|#include &lt;linux/interrupt.h&gt;
macro_line|#include &lt;linux/notifier.h&gt;
macro_line|#include &lt;linux/firewall.h&gt;
macro_line|#include &lt;net/rose.h&gt;
DECL|variable|rose_neigh_no
r_static
r_int
r_int
id|rose_neigh_no
op_assign
l_int|1
suffix:semicolon
DECL|variable|rose_node_list
r_static
r_struct
id|rose_node
op_star
id|rose_node_list
op_assign
l_int|NULL
suffix:semicolon
DECL|variable|rose_neigh_list
r_static
r_struct
id|rose_neigh
op_star
id|rose_neigh_list
op_assign
l_int|NULL
suffix:semicolon
DECL|variable|rose_route_list
r_static
r_struct
id|rose_route
op_star
id|rose_route_list
op_assign
l_int|NULL
suffix:semicolon
r_static
r_void
id|rose_remove_neigh
c_func
(paren
r_struct
id|rose_neigh
op_star
)paren
suffix:semicolon
multiline_comment|/*&n; *&t;Add a new route to a node, and in the process add the node and the&n; *&t;neighbour if it is new.&n; */
DECL|function|rose_add_node
r_static
r_int
id|rose_add_node
c_func
(paren
r_struct
id|rose_route_struct
op_star
id|rose_route
comma
r_struct
id|device
op_star
id|dev
)paren
(brace
r_struct
id|rose_node
op_star
id|rose_node
comma
op_star
id|rose_tmpn
comma
op_star
id|rose_tmpp
suffix:semicolon
r_struct
id|rose_neigh
op_star
id|rose_neigh
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|rose_node
op_assign
id|rose_node_list
suffix:semicolon
id|rose_node
op_ne
l_int|NULL
suffix:semicolon
id|rose_node
op_assign
id|rose_node-&gt;next
)paren
r_if
c_cond
(paren
(paren
id|rose_node-&gt;mask
op_eq
id|rose_route-&gt;mask
)paren
op_logical_and
(paren
id|rosecmpm
c_func
(paren
op_amp
id|rose_route-&gt;address
comma
op_amp
id|rose_node-&gt;address
comma
id|rose_route-&gt;mask
)paren
op_eq
l_int|0
)paren
)paren
r_break
suffix:semicolon
r_for
c_loop
(paren
id|rose_neigh
op_assign
id|rose_neigh_list
suffix:semicolon
id|rose_neigh
op_ne
l_int|NULL
suffix:semicolon
id|rose_neigh
op_assign
id|rose_neigh-&gt;next
)paren
r_if
c_cond
(paren
id|ax25cmp
c_func
(paren
op_amp
id|rose_route-&gt;neighbour
comma
op_amp
id|rose_neigh-&gt;callsign
)paren
op_eq
l_int|0
op_logical_and
id|rose_neigh-&gt;dev
op_eq
id|dev
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
id|rose_neigh
op_eq
l_int|NULL
)paren
(brace
r_if
c_cond
(paren
(paren
id|rose_neigh
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
op_star
id|rose_neigh
)paren
comma
id|GFP_ATOMIC
)paren
)paren
op_eq
l_int|NULL
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|rose_neigh-&gt;callsign
op_assign
id|rose_route-&gt;neighbour
suffix:semicolon
id|rose_neigh-&gt;digipeat
op_assign
l_int|NULL
suffix:semicolon
id|rose_neigh-&gt;dev
op_assign
id|dev
suffix:semicolon
id|rose_neigh-&gt;count
op_assign
l_int|0
suffix:semicolon
id|rose_neigh-&gt;dce_mode
op_assign
l_int|0
suffix:semicolon
id|rose_neigh-&gt;number
op_assign
id|rose_neigh_no
op_increment
suffix:semicolon
id|rose_neigh-&gt;restarted
op_assign
l_int|0
suffix:semicolon
id|skb_queue_head_init
c_func
(paren
op_amp
id|rose_neigh-&gt;queue
)paren
suffix:semicolon
id|rose_neigh-&gt;t0timer
op_assign
l_int|0
suffix:semicolon
id|rose_neigh-&gt;ftimer
op_assign
l_int|0
suffix:semicolon
id|init_timer
c_func
(paren
op_amp
id|rose_neigh-&gt;timer
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rose_route-&gt;ndigis
op_ne
l_int|0
)paren
(brace
r_if
c_cond
(paren
(paren
id|rose_neigh-&gt;digipeat
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
id|ax25_digi
)paren
comma
id|GFP_KERNEL
)paren
)paren
op_eq
l_int|NULL
)paren
(brace
id|kfree
c_func
(paren
id|rose_neigh
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|rose_neigh-&gt;digipeat-&gt;ndigi
op_assign
id|rose_route-&gt;ndigis
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|rose_route-&gt;ndigis
suffix:semicolon
id|i
op_increment
)paren
id|rose_neigh-&gt;digipeat-&gt;calls
(braket
id|i
)braket
op_assign
id|rose_route-&gt;digipeaters
(braket
id|i
)braket
suffix:semicolon
)brace
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|rose_neigh-&gt;next
op_assign
id|rose_neigh_list
suffix:semicolon
id|rose_neigh_list
op_assign
id|rose_neigh
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * This is a new node to be inserted into the list. Find where it needs&n;&t; * to be inserted into the list, and insert it. We want to be sure&n;&t; * to order the list in descending order of mask size to ensure that&n;&t; * later when we are searching this list the first match will be the&n;&t; * best match.&n;&t; */
r_if
c_cond
(paren
id|rose_node
op_eq
l_int|NULL
)paren
(brace
id|rose_tmpn
op_assign
id|rose_node_list
suffix:semicolon
id|rose_tmpp
op_assign
l_int|NULL
suffix:semicolon
r_while
c_loop
(paren
id|rose_tmpn
op_ne
l_int|NULL
)paren
(brace
r_if
c_cond
(paren
id|rose_tmpn-&gt;mask
OG
id|rose_route-&gt;mask
)paren
(brace
id|rose_tmpp
op_assign
id|rose_tmpn
suffix:semicolon
id|rose_tmpn
op_assign
id|rose_tmpn-&gt;next
suffix:semicolon
)brace
r_else
(brace
r_break
suffix:semicolon
)brace
)brace
multiline_comment|/* create new node */
r_if
c_cond
(paren
(paren
id|rose_node
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
op_star
id|rose_node
)paren
comma
id|GFP_ATOMIC
)paren
)paren
op_eq
l_int|NULL
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|rose_node-&gt;address
op_assign
id|rose_route-&gt;address
suffix:semicolon
id|rose_node-&gt;mask
op_assign
id|rose_route-&gt;mask
suffix:semicolon
id|rose_node-&gt;count
op_assign
l_int|1
suffix:semicolon
id|rose_node-&gt;neighbour
(braket
l_int|0
)braket
op_assign
id|rose_neigh
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rose_tmpn
op_eq
l_int|NULL
)paren
(brace
r_if
c_cond
(paren
id|rose_tmpp
op_eq
l_int|NULL
)paren
(brace
multiline_comment|/* Empty list */
id|rose_node_list
op_assign
id|rose_node
suffix:semicolon
id|rose_node-&gt;next
op_assign
l_int|NULL
suffix:semicolon
)brace
r_else
(brace
id|rose_tmpp-&gt;next
op_assign
id|rose_node
suffix:semicolon
id|rose_node-&gt;next
op_assign
l_int|NULL
suffix:semicolon
)brace
)brace
r_else
(brace
r_if
c_cond
(paren
id|rose_tmpp
op_eq
l_int|NULL
)paren
(brace
multiline_comment|/* 1st node */
id|rose_node-&gt;next
op_assign
id|rose_node_list
suffix:semicolon
id|rose_node_list
op_assign
id|rose_node
suffix:semicolon
)brace
r_else
(brace
id|rose_tmpp-&gt;next
op_assign
id|rose_node
suffix:semicolon
id|rose_node-&gt;next
op_assign
id|rose_tmpn
suffix:semicolon
)brace
)brace
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|rose_neigh-&gt;count
op_increment
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* We have space, slot it in */
r_if
c_cond
(paren
id|rose_node-&gt;count
OL
l_int|3
)paren
(brace
id|rose_node-&gt;neighbour
(braket
id|rose_node-&gt;count
)braket
op_assign
id|rose_neigh
suffix:semicolon
id|rose_node-&gt;count
op_increment
suffix:semicolon
id|rose_neigh-&gt;count
op_increment
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|rose_remove_node
r_static
r_void
id|rose_remove_node
c_func
(paren
r_struct
id|rose_node
op_star
id|rose_node
)paren
(brace
r_struct
id|rose_node
op_star
id|s
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|s
op_assign
id|rose_node_list
)paren
op_eq
id|rose_node
)paren
(brace
id|rose_node_list
op_assign
id|rose_node-&gt;next
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|rose_node
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_while
c_loop
(paren
id|s
op_ne
l_int|NULL
op_logical_and
id|s-&gt;next
op_ne
l_int|NULL
)paren
(brace
r_if
c_cond
(paren
id|s-&gt;next
op_eq
id|rose_node
)paren
(brace
id|s-&gt;next
op_assign
id|rose_node-&gt;next
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|rose_node
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|s
op_assign
id|s-&gt;next
suffix:semicolon
)brace
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
DECL|function|rose_remove_neigh
r_static
r_void
id|rose_remove_neigh
c_func
(paren
r_struct
id|rose_neigh
op_star
id|rose_neigh
)paren
(brace
r_struct
id|rose_neigh
op_star
id|s
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
id|del_timer
c_func
(paren
op_amp
id|rose_neigh-&gt;timer
)paren
suffix:semicolon
r_while
c_loop
(paren
(paren
id|skb
op_assign
id|skb_dequeue
c_func
(paren
op_amp
id|rose_neigh-&gt;queue
)paren
)paren
op_ne
l_int|NULL
)paren
id|kfree_skb
c_func
(paren
id|skb
comma
id|FREE_WRITE
)paren
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|s
op_assign
id|rose_neigh_list
)paren
op_eq
id|rose_neigh
)paren
(brace
id|rose_neigh_list
op_assign
id|rose_neigh-&gt;next
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rose_neigh-&gt;digipeat
op_ne
l_int|NULL
)paren
id|kfree
c_func
(paren
id|rose_neigh-&gt;digipeat
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|rose_neigh
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_while
c_loop
(paren
id|s
op_ne
l_int|NULL
op_logical_and
id|s-&gt;next
op_ne
l_int|NULL
)paren
(brace
r_if
c_cond
(paren
id|s-&gt;next
op_eq
id|rose_neigh
)paren
(brace
id|s-&gt;next
op_assign
id|rose_neigh-&gt;next
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rose_neigh-&gt;digipeat
op_ne
l_int|NULL
)paren
id|kfree
c_func
(paren
id|rose_neigh-&gt;digipeat
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|rose_neigh
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|s
op_assign
id|s-&gt;next
suffix:semicolon
)brace
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
DECL|function|rose_remove_route
r_static
r_void
id|rose_remove_route
c_func
(paren
r_struct
id|rose_route
op_star
id|rose_route
)paren
(brace
r_struct
id|rose_route
op_star
id|s
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|s
op_assign
id|rose_route_list
)paren
op_eq
id|rose_route
)paren
(brace
id|rose_route_list
op_assign
id|rose_route-&gt;next
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|rose_route
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_while
c_loop
(paren
id|s
op_ne
l_int|NULL
op_logical_and
id|s-&gt;next
op_ne
l_int|NULL
)paren
(brace
r_if
c_cond
(paren
id|s-&gt;next
op_eq
id|rose_route
)paren
(brace
id|s-&gt;next
op_assign
id|rose_route-&gt;next
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|rose_route
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|s
op_assign
id|s-&gt;next
suffix:semicolon
)brace
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;&quot;Delete&quot; a node. Strictly speaking remove a route to a node. The node&n; *&t;is only deleted if no routes are left to it.&n; */
DECL|function|rose_del_node
r_static
r_int
id|rose_del_node
c_func
(paren
r_struct
id|rose_route_struct
op_star
id|rose_route
comma
r_struct
id|device
op_star
id|dev
)paren
(brace
r_struct
id|rose_node
op_star
id|rose_node
suffix:semicolon
r_struct
id|rose_neigh
op_star
id|rose_neigh
suffix:semicolon
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|rose_node
op_assign
id|rose_node_list
suffix:semicolon
id|rose_node
op_ne
l_int|NULL
suffix:semicolon
id|rose_node
op_assign
id|rose_node-&gt;next
)paren
r_if
c_cond
(paren
(paren
id|rose_node-&gt;mask
op_eq
id|rose_route-&gt;mask
)paren
op_logical_and
(paren
id|rosecmpm
c_func
(paren
op_amp
id|rose_route-&gt;address
comma
op_amp
id|rose_node-&gt;address
comma
id|rose_route-&gt;mask
)paren
op_eq
l_int|0
)paren
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
id|rose_node
op_eq
l_int|NULL
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_for
c_loop
(paren
id|rose_neigh
op_assign
id|rose_neigh_list
suffix:semicolon
id|rose_neigh
op_ne
l_int|NULL
suffix:semicolon
id|rose_neigh
op_assign
id|rose_neigh-&gt;next
)paren
r_if
c_cond
(paren
id|ax25cmp
c_func
(paren
op_amp
id|rose_route-&gt;neighbour
comma
op_amp
id|rose_neigh-&gt;callsign
)paren
op_eq
l_int|0
op_logical_and
id|rose_neigh-&gt;dev
op_eq
id|dev
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
id|rose_neigh
op_eq
l_int|NULL
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|rose_node-&gt;count
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|rose_node-&gt;neighbour
(braket
id|i
)braket
op_eq
id|rose_neigh
)paren
(brace
id|rose_neigh-&gt;count
op_decrement
suffix:semicolon
r_if
c_cond
(paren
id|rose_neigh-&gt;count
op_eq
l_int|0
)paren
id|rose_remove_neigh
c_func
(paren
id|rose_neigh
)paren
suffix:semicolon
id|rose_node-&gt;count
op_decrement
suffix:semicolon
r_if
c_cond
(paren
id|rose_node-&gt;count
op_eq
l_int|0
)paren
(brace
id|rose_remove_node
c_func
(paren
id|rose_node
)paren
suffix:semicolon
)brace
r_else
(brace
r_switch
c_cond
(paren
id|i
)paren
(brace
r_case
l_int|0
suffix:colon
id|rose_node-&gt;neighbour
(braket
l_int|0
)braket
op_assign
id|rose_node-&gt;neighbour
(braket
l_int|1
)braket
suffix:semicolon
r_case
l_int|1
suffix:colon
id|rose_node-&gt;neighbour
(braket
l_int|1
)braket
op_assign
id|rose_node-&gt;neighbour
(braket
l_int|2
)braket
suffix:semicolon
r_case
l_int|2
suffix:colon
r_break
suffix:semicolon
)brace
)brace
r_return
l_int|0
suffix:semicolon
)brace
)brace
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;A device has been removed. Remove its routes and neighbours.&n; */
DECL|function|rose_rt_device_down
r_void
id|rose_rt_device_down
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
r_struct
id|rose_neigh
op_star
id|s
comma
op_star
id|rose_neigh
op_assign
id|rose_neigh_list
suffix:semicolon
r_struct
id|rose_node
op_star
id|t
comma
op_star
id|rose_node
suffix:semicolon
r_int
id|i
suffix:semicolon
r_while
c_loop
(paren
id|rose_neigh
op_ne
l_int|NULL
)paren
(brace
id|s
op_assign
id|rose_neigh
suffix:semicolon
id|rose_neigh
op_assign
id|rose_neigh-&gt;next
suffix:semicolon
r_if
c_cond
(paren
id|s-&gt;dev
op_eq
id|dev
)paren
(brace
id|rose_node
op_assign
id|rose_node_list
suffix:semicolon
r_while
c_loop
(paren
id|rose_node
op_ne
l_int|NULL
)paren
(brace
id|t
op_assign
id|rose_node
suffix:semicolon
id|rose_node
op_assign
id|rose_node-&gt;next
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|t-&gt;count
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|t-&gt;neighbour
(braket
id|i
)braket
op_eq
id|s
)paren
(brace
id|t-&gt;count
op_decrement
suffix:semicolon
r_switch
c_cond
(paren
id|i
)paren
(brace
r_case
l_int|0
suffix:colon
id|t-&gt;neighbour
(braket
l_int|0
)braket
op_assign
id|t-&gt;neighbour
(braket
l_int|1
)braket
suffix:semicolon
r_case
l_int|1
suffix:colon
id|t-&gt;neighbour
(braket
l_int|1
)braket
op_assign
id|t-&gt;neighbour
(braket
l_int|2
)braket
suffix:semicolon
r_case
l_int|2
suffix:colon
r_break
suffix:semicolon
)brace
)brace
)brace
r_if
c_cond
(paren
id|t-&gt;count
op_le
l_int|0
)paren
id|rose_remove_node
c_func
(paren
id|t
)paren
suffix:semicolon
)brace
id|rose_remove_neigh
c_func
(paren
id|s
)paren
suffix:semicolon
)brace
)brace
)brace
multiline_comment|/*&n; *&t;A device has been removed. Remove its links.&n; */
DECL|function|rose_route_device_down
r_void
id|rose_route_device_down
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
r_struct
id|rose_route
op_star
id|s
comma
op_star
id|rose_route
op_assign
id|rose_route_list
suffix:semicolon
r_while
c_loop
(paren
id|rose_route
op_ne
l_int|NULL
)paren
(brace
id|s
op_assign
id|rose_route
suffix:semicolon
id|rose_route
op_assign
id|rose_route-&gt;next
suffix:semicolon
r_if
c_cond
(paren
id|s-&gt;neigh1-&gt;dev
op_eq
id|dev
op_logical_or
id|s-&gt;neigh2-&gt;dev
op_eq
id|dev
)paren
id|rose_remove_route
c_func
(paren
id|s
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/*&n; *&t;Check that the device given is a valid AX.25 interface that is &quot;up&quot;.&n; */
DECL|function|rose_ax25_dev_get
r_struct
id|device
op_star
id|rose_ax25_dev_get
c_func
(paren
r_char
op_star
id|devname
)paren
(brace
r_struct
id|device
op_star
id|dev
suffix:semicolon
r_if
c_cond
(paren
(paren
id|dev
op_assign
id|dev_get
c_func
(paren
id|devname
)paren
)paren
op_eq
l_int|NULL
)paren
r_return
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
(paren
id|dev-&gt;flags
op_amp
id|IFF_UP
)paren
op_logical_and
id|dev-&gt;type
op_eq
id|ARPHRD_AX25
)paren
r_return
id|dev
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;Find the first active ROSE device, usually &quot;rose0&quot;.&n; */
DECL|function|rose_dev_first
r_struct
id|device
op_star
id|rose_dev_first
c_func
(paren
r_void
)paren
(brace
r_struct
id|device
op_star
id|dev
comma
op_star
id|first
op_assign
l_int|NULL
suffix:semicolon
r_for
c_loop
(paren
id|dev
op_assign
id|dev_base
suffix:semicolon
id|dev
op_ne
l_int|NULL
suffix:semicolon
id|dev
op_assign
id|dev-&gt;next
)paren
r_if
c_cond
(paren
(paren
id|dev-&gt;flags
op_amp
id|IFF_UP
)paren
op_logical_and
id|dev-&gt;type
op_eq
id|ARPHRD_ROSE
)paren
r_if
c_cond
(paren
id|first
op_eq
l_int|NULL
op_logical_or
id|strncmp
c_func
(paren
id|dev-&gt;name
comma
id|first-&gt;name
comma
l_int|3
)paren
OL
l_int|0
)paren
id|first
op_assign
id|dev
suffix:semicolon
r_return
id|first
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;Find the ROSE device for the given address.&n; */
DECL|function|rose_dev_get
r_struct
id|device
op_star
id|rose_dev_get
c_func
(paren
id|rose_address
op_star
id|addr
)paren
(brace
r_struct
id|device
op_star
id|dev
suffix:semicolon
r_for
c_loop
(paren
id|dev
op_assign
id|dev_base
suffix:semicolon
id|dev
op_ne
l_int|NULL
suffix:semicolon
id|dev
op_assign
id|dev-&gt;next
)paren
r_if
c_cond
(paren
(paren
id|dev-&gt;flags
op_amp
id|IFF_UP
)paren
op_logical_and
id|dev-&gt;type
op_eq
id|ARPHRD_ROSE
op_logical_and
id|rosecmp
c_func
(paren
id|addr
comma
(paren
id|rose_address
op_star
)paren
id|dev-&gt;dev_addr
)paren
op_eq
l_int|0
)paren
r_return
id|dev
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
DECL|function|rose_route_free_lci
r_struct
id|rose_route
op_star
id|rose_route_free_lci
c_func
(paren
r_int
r_int
id|lci
comma
r_struct
id|rose_neigh
op_star
id|neigh
)paren
(brace
r_struct
id|rose_route
op_star
id|rose_route
suffix:semicolon
r_for
c_loop
(paren
id|rose_route
op_assign
id|rose_route_list
suffix:semicolon
id|rose_route
op_ne
l_int|NULL
suffix:semicolon
id|rose_route
op_assign
id|rose_route-&gt;next
)paren
r_if
c_cond
(paren
(paren
id|rose_route-&gt;neigh1
op_eq
id|neigh
op_logical_and
id|rose_route-&gt;lci1
op_eq
id|lci
)paren
op_logical_or
(paren
id|rose_route-&gt;neigh2
op_eq
id|neigh
op_logical_and
id|rose_route-&gt;lci2
op_eq
id|lci
)paren
)paren
r_return
id|rose_route
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;Find a neighbour given a ROSE address.&n; */
DECL|function|rose_get_neigh
r_struct
id|rose_neigh
op_star
id|rose_get_neigh
c_func
(paren
id|rose_address
op_star
id|addr
)paren
(brace
r_struct
id|rose_node
op_star
id|node
suffix:semicolon
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|node
op_assign
id|rose_node_list
suffix:semicolon
id|node
op_ne
l_int|NULL
suffix:semicolon
id|node
op_assign
id|node-&gt;next
)paren
(brace
r_if
c_cond
(paren
id|rosecmpm
c_func
(paren
id|addr
comma
op_amp
id|node-&gt;address
comma
id|node-&gt;mask
)paren
op_eq
l_int|0
)paren
(brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|node-&gt;count
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|node-&gt;neighbour
(braket
id|i
)braket
op_member_access_from_pointer
id|ftimer
op_eq
l_int|0
)paren
r_return
id|node-&gt;neighbour
(braket
id|i
)braket
suffix:semicolon
)brace
)brace
)brace
r_return
l_int|NULL
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;Handle the ioctls that control the routing functions.&n; */
DECL|function|rose_rt_ioctl
r_int
id|rose_rt_ioctl
c_func
(paren
r_int
r_int
id|cmd
comma
r_void
op_star
id|arg
)paren
(brace
r_struct
id|rose_route_struct
id|rose_route
suffix:semicolon
r_struct
id|device
op_star
id|dev
suffix:semicolon
r_int
id|err
suffix:semicolon
r_switch
c_cond
(paren
id|cmd
)paren
(brace
r_case
id|SIOCADDRT
suffix:colon
r_if
c_cond
(paren
(paren
id|err
op_assign
id|verify_area
c_func
(paren
id|VERIFY_READ
comma
id|arg
comma
r_sizeof
(paren
r_struct
id|rose_route_struct
)paren
)paren
)paren
op_ne
l_int|0
)paren
r_return
id|err
suffix:semicolon
id|copy_from_user
c_func
(paren
op_amp
id|rose_route
comma
id|arg
comma
r_sizeof
(paren
r_struct
id|rose_route_struct
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|dev
op_assign
id|rose_ax25_dev_get
c_func
(paren
id|rose_route.device
)paren
)paren
op_eq
l_int|NULL
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|rose_dev_get
c_func
(paren
op_amp
id|rose_route.address
)paren
op_ne
l_int|NULL
)paren
multiline_comment|/* Can&squot;t add routes to ourself */
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|rose_route.mask
OG
l_int|10
)paren
multiline_comment|/* Mask can&squot;t be more than 10 digits */
r_return
op_minus
id|EINVAL
suffix:semicolon
r_return
id|rose_add_node
c_func
(paren
op_amp
id|rose_route
comma
id|dev
)paren
suffix:semicolon
r_case
id|SIOCDELRT
suffix:colon
r_if
c_cond
(paren
(paren
id|err
op_assign
id|verify_area
c_func
(paren
id|VERIFY_READ
comma
id|arg
comma
r_sizeof
(paren
r_struct
id|rose_route_struct
)paren
)paren
)paren
op_ne
l_int|0
)paren
r_return
id|err
suffix:semicolon
id|copy_from_user
c_func
(paren
op_amp
id|rose_route
comma
id|arg
comma
r_sizeof
(paren
r_struct
id|rose_route_struct
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|dev
op_assign
id|rose_ax25_dev_get
c_func
(paren
id|rose_route.device
)paren
)paren
op_eq
l_int|NULL
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_return
id|rose_del_node
c_func
(paren
op_amp
id|rose_route
comma
id|dev
)paren
suffix:semicolon
r_default
suffix:colon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|rose_del_route_by_neigh
r_static
r_void
id|rose_del_route_by_neigh
c_func
(paren
r_struct
id|rose_neigh
op_star
id|rose_neigh
)paren
(brace
r_struct
id|rose_route
op_star
id|rose_route
comma
op_star
id|s
suffix:semicolon
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
id|rose_neigh-&gt;restarted
op_assign
l_int|0
suffix:semicolon
id|rose_neigh-&gt;t0timer
op_assign
l_int|0
suffix:semicolon
id|rose_neigh-&gt;ftimer
op_assign
id|sysctl_rose_link_fail_timeout
suffix:semicolon
id|rose_link_set_timer
c_func
(paren
id|rose_neigh
)paren
suffix:semicolon
r_while
c_loop
(paren
(paren
id|skb
op_assign
id|skb_dequeue
c_func
(paren
op_amp
id|rose_neigh-&gt;queue
)paren
)paren
op_ne
l_int|NULL
)paren
id|kfree_skb
c_func
(paren
id|skb
comma
id|FREE_WRITE
)paren
suffix:semicolon
id|rose_route
op_assign
id|rose_route_list
suffix:semicolon
r_while
c_loop
(paren
id|rose_route
op_ne
l_int|NULL
)paren
(brace
r_if
c_cond
(paren
(paren
id|rose_route-&gt;neigh1
op_eq
id|rose_neigh
op_logical_and
id|rose_route-&gt;neigh2
op_eq
id|rose_neigh
)paren
op_logical_or
(paren
id|rose_route-&gt;neigh1
op_eq
id|rose_neigh
op_logical_and
id|rose_route-&gt;neigh2
op_eq
l_int|NULL
)paren
op_logical_or
(paren
id|rose_route-&gt;neigh2
op_eq
id|rose_neigh
op_logical_and
id|rose_route-&gt;neigh1
op_eq
l_int|NULL
)paren
)paren
(brace
id|s
op_assign
id|rose_route-&gt;next
suffix:semicolon
id|rose_remove_route
c_func
(paren
id|rose_route
)paren
suffix:semicolon
id|rose_route
op_assign
id|s
suffix:semicolon
r_continue
suffix:semicolon
)brace
r_if
c_cond
(paren
id|rose_route-&gt;neigh1
op_eq
id|rose_neigh
)paren
(brace
id|rose_route-&gt;neigh1
op_assign
l_int|NULL
suffix:semicolon
id|rose_transmit_clear_request
c_func
(paren
id|rose_route-&gt;neigh2
comma
id|rose_route-&gt;lci2
comma
l_int|0x0D
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|rose_route-&gt;neigh2
op_eq
id|rose_neigh
)paren
(brace
id|rose_route-&gt;neigh2
op_assign
l_int|NULL
suffix:semicolon
id|rose_transmit_clear_request
c_func
(paren
id|rose_route-&gt;neigh1
comma
id|rose_route-&gt;lci1
comma
l_int|0x0D
)paren
suffix:semicolon
)brace
id|rose_route
op_assign
id|rose_route-&gt;next
suffix:semicolon
)brace
)brace
multiline_comment|/*&n; * &t;A level 2 link has timed out, therefore it appears to be a poor link,&n; *&t;then don&squot;t use that neighbour until it is reset. Blow away all through&n; *&t;routes and connections using this route.&n; */
DECL|function|rose_link_failed
r_void
id|rose_link_failed
c_func
(paren
id|ax25_address
op_star
id|callsign
comma
r_struct
id|device
op_star
id|dev
)paren
(brace
r_struct
id|rose_neigh
op_star
id|rose_neigh
suffix:semicolon
r_for
c_loop
(paren
id|rose_neigh
op_assign
id|rose_neigh_list
suffix:semicolon
id|rose_neigh
op_ne
l_int|NULL
suffix:semicolon
id|rose_neigh
op_assign
id|rose_neigh-&gt;next
)paren
r_if
c_cond
(paren
id|ax25cmp
c_func
(paren
op_amp
id|rose_neigh-&gt;callsign
comma
id|callsign
)paren
op_eq
l_int|0
op_logical_and
id|rose_neigh-&gt;dev
op_eq
id|dev
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
id|rose_neigh
op_eq
l_int|NULL
)paren
r_return
suffix:semicolon
id|rose_del_route_by_neigh
c_func
(paren
id|rose_neigh
)paren
suffix:semicolon
id|rose_kill_by_neigh
c_func
(paren
id|rose_neigh
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * &t;A device has been &quot;downed&quot; remove its link status. Blow away all&n; *&t;through routes and connections that use this device.&n; */
DECL|function|rose_link_device_down
r_void
id|rose_link_device_down
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
r_struct
id|rose_neigh
op_star
id|rose_neigh
suffix:semicolon
r_for
c_loop
(paren
id|rose_neigh
op_assign
id|rose_neigh_list
suffix:semicolon
id|rose_neigh
op_ne
l_int|NULL
suffix:semicolon
id|rose_neigh
op_assign
id|rose_neigh-&gt;next
)paren
(brace
r_if
c_cond
(paren
id|rose_neigh-&gt;dev
op_eq
id|dev
)paren
(brace
id|rose_del_route_by_neigh
c_func
(paren
id|rose_neigh
)paren
suffix:semicolon
id|rose_kill_by_neigh
c_func
(paren
id|rose_neigh
)paren
suffix:semicolon
)brace
)brace
)brace
multiline_comment|/*&n; *&t;Route a frame to an appropriate AX.25 connection.&n; */
DECL|function|rose_route_frame
r_int
id|rose_route_frame
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
id|ax25_cb
op_star
id|ax25
)paren
(brace
r_struct
id|rose_neigh
op_star
id|rose_neigh
comma
op_star
id|new_neigh
suffix:semicolon
r_struct
id|rose_route
op_star
id|rose_route
suffix:semicolon
r_struct
id|rose_facilities
id|facilities
suffix:semicolon
id|rose_address
op_star
id|src_addr
comma
op_star
id|dest_addr
suffix:semicolon
r_struct
id|sock
op_star
id|sk
suffix:semicolon
r_int
r_int
id|frametype
suffix:semicolon
r_int
r_int
id|lci
comma
id|new_lci
suffix:semicolon
r_struct
id|device
op_star
id|dev
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_if
c_cond
(paren
id|call_in_firewall
c_func
(paren
id|PF_ROSE
comma
id|skb-&gt;dev
comma
id|skb-&gt;data
comma
l_int|NULL
comma
op_amp
id|skb
)paren
op_ne
id|FW_ACCEPT
)paren
r_return
l_int|0
suffix:semicolon
id|frametype
op_assign
id|skb-&gt;data
(braket
l_int|2
)braket
suffix:semicolon
id|lci
op_assign
(paren
(paren
id|skb-&gt;data
(braket
l_int|0
)braket
op_lshift
l_int|8
)paren
op_amp
l_int|0xF00
)paren
op_plus
(paren
(paren
id|skb-&gt;data
(braket
l_int|1
)braket
op_lshift
l_int|0
)paren
op_amp
l_int|0x0FF
)paren
suffix:semicolon
id|src_addr
op_assign
(paren
id|rose_address
op_star
)paren
(paren
id|skb-&gt;data
op_plus
l_int|9
)paren
suffix:semicolon
id|dest_addr
op_assign
(paren
id|rose_address
op_star
)paren
(paren
id|skb-&gt;data
op_plus
l_int|4
)paren
suffix:semicolon
r_for
c_loop
(paren
id|rose_neigh
op_assign
id|rose_neigh_list
suffix:semicolon
id|rose_neigh
op_ne
l_int|NULL
suffix:semicolon
id|rose_neigh
op_assign
id|rose_neigh-&gt;next
)paren
r_if
c_cond
(paren
id|ax25cmp
c_func
(paren
op_amp
id|ax25-&gt;dest_addr
comma
op_amp
id|rose_neigh-&gt;callsign
)paren
op_eq
l_int|0
op_logical_and
id|ax25-&gt;ax25_dev-&gt;dev
op_eq
id|rose_neigh-&gt;dev
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
id|rose_neigh
op_eq
l_int|NULL
)paren
r_return
l_int|0
suffix:semicolon
multiline_comment|/*&n;&t; *&t;Obviously the link is working, halt the ftimer.&n;&t; */
id|rose_neigh-&gt;ftimer
op_assign
l_int|0
suffix:semicolon
multiline_comment|/*&n;&t; *&t;LCI of zero is always for us, and its always a restart&n;&t; * &t;frame.&n;&t; */
r_if
c_cond
(paren
id|lci
op_eq
l_int|0
)paren
(brace
id|rose_link_rx_restart
c_func
(paren
id|skb
comma
id|rose_neigh
comma
id|frametype
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n;&t; *&t;Find an existing socket.&n;&t; */
r_if
c_cond
(paren
(paren
id|sk
op_assign
id|rose_find_socket
c_func
(paren
id|lci
comma
id|rose_neigh
)paren
)paren
op_ne
l_int|NULL
)paren
(brace
id|skb-&gt;h.raw
op_assign
id|skb-&gt;data
suffix:semicolon
r_return
id|rose_process_rx_frame
c_func
(paren
id|sk
comma
id|skb
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;&t; *&t;Is is a Call Request and is it for us ?&n;&t; */
r_if
c_cond
(paren
id|frametype
op_eq
id|ROSE_CALL_REQUEST
)paren
r_if
c_cond
(paren
(paren
id|dev
op_assign
id|rose_dev_get
c_func
(paren
id|dest_addr
)paren
)paren
op_ne
l_int|NULL
)paren
r_return
id|rose_rx_call_request
c_func
(paren
id|skb
comma
id|dev
comma
id|rose_neigh
comma
id|lci
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|sysctl_rose_routing_control
)paren
(brace
id|rose_transmit_clear_request
c_func
(paren
id|rose_neigh
comma
id|lci
comma
l_int|0x0D
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n;&t; *&t;Route it to the next in line if we have an entry for it.&n;&t; */
r_for
c_loop
(paren
id|rose_route
op_assign
id|rose_route_list
suffix:semicolon
id|rose_route
op_ne
l_int|NULL
suffix:semicolon
id|rose_route
op_assign
id|rose_route-&gt;next
)paren
(brace
r_if
c_cond
(paren
id|rose_route-&gt;lci1
op_eq
id|lci
op_logical_and
id|rose_route-&gt;neigh1
op_eq
id|rose_neigh
)paren
(brace
r_if
c_cond
(paren
id|rose_route-&gt;neigh2
op_ne
l_int|NULL
)paren
(brace
id|skb-&gt;data
(braket
l_int|0
)braket
op_and_assign
l_int|0xF0
suffix:semicolon
id|skb-&gt;data
(braket
l_int|0
)braket
op_or_assign
(paren
id|rose_route-&gt;lci2
op_rshift
l_int|8
)paren
op_amp
l_int|0x0F
suffix:semicolon
id|skb-&gt;data
(braket
l_int|1
)braket
op_assign
(paren
id|rose_route-&gt;lci2
op_rshift
l_int|0
)paren
op_amp
l_int|0xFF
suffix:semicolon
id|rose_transmit_link
c_func
(paren
id|skb
comma
id|rose_route-&gt;neigh2
)paren
suffix:semicolon
r_if
c_cond
(paren
id|frametype
op_eq
id|ROSE_CLEAR_CONFIRMATION
)paren
id|rose_remove_route
c_func
(paren
id|rose_route
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|frametype
op_eq
id|ROSE_CLEAR_CONFIRMATION
)paren
id|rose_remove_route
c_func
(paren
id|rose_route
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|rose_route-&gt;lci2
op_eq
id|lci
op_logical_and
id|rose_route-&gt;neigh2
op_eq
id|rose_neigh
)paren
(brace
r_if
c_cond
(paren
id|rose_route-&gt;neigh1
op_ne
l_int|NULL
)paren
(brace
id|skb-&gt;data
(braket
l_int|0
)braket
op_and_assign
l_int|0xF0
suffix:semicolon
id|skb-&gt;data
(braket
l_int|0
)braket
op_or_assign
(paren
id|rose_route-&gt;lci1
op_rshift
l_int|8
)paren
op_amp
l_int|0x0F
suffix:semicolon
id|skb-&gt;data
(braket
l_int|1
)braket
op_assign
(paren
id|rose_route-&gt;lci1
op_rshift
l_int|0
)paren
op_amp
l_int|0xFF
suffix:semicolon
id|rose_transmit_link
c_func
(paren
id|skb
comma
id|rose_route-&gt;neigh1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|frametype
op_eq
id|ROSE_CLEAR_CONFIRMATION
)paren
id|rose_remove_route
c_func
(paren
id|rose_route
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|frametype
op_eq
id|ROSE_CLEAR_CONFIRMATION
)paren
id|rose_remove_route
c_func
(paren
id|rose_route
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
)brace
)brace
multiline_comment|/*&n;&t; *&t;We know that:&n;&t; *&t;1. The frame isn&squot;t for us,&n;&t; *&t;2. It isn&squot;t &quot;owned&quot; by any existing route.&n;&t; */
r_if
c_cond
(paren
id|frametype
op_ne
id|ROSE_CALL_REQUEST
)paren
multiline_comment|/* XXX */
r_return
l_int|0
suffix:semicolon
id|rose_parse_facilities
c_func
(paren
id|skb
comma
op_amp
id|facilities
)paren
suffix:semicolon
multiline_comment|/*&n;&t; *&t;Check for routing loops.&n;&t; */
r_for
c_loop
(paren
id|rose_route
op_assign
id|rose_route_list
suffix:semicolon
id|rose_route
op_ne
l_int|NULL
suffix:semicolon
id|rose_route
op_assign
id|rose_route-&gt;next
)paren
(brace
r_if
c_cond
(paren
id|rose_route-&gt;rand
op_eq
id|facilities.rand
op_logical_and
id|rosecmp
c_func
(paren
id|src_addr
comma
op_amp
id|rose_route-&gt;src_addr
)paren
op_eq
l_int|0
op_logical_and
id|ax25cmp
c_func
(paren
op_amp
id|facilities.dest_call
comma
op_amp
id|rose_route-&gt;src_call
)paren
op_eq
l_int|0
op_logical_and
id|ax25cmp
c_func
(paren
op_amp
id|facilities.source_call
comma
op_amp
id|rose_route-&gt;dest_call
)paren
op_eq
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;ROSE: routing loop from %s&bslash;n&quot;
comma
id|rose2asc
c_func
(paren
id|src_addr
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;ROSE:                to %s&bslash;n&quot;
comma
id|rose2asc
c_func
(paren
id|dest_addr
)paren
)paren
suffix:semicolon
id|rose_transmit_clear_request
c_func
(paren
id|rose_neigh
comma
id|lci
comma
l_int|0x0D
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
(paren
id|new_neigh
op_assign
id|rose_get_neigh
c_func
(paren
id|dest_addr
)paren
)paren
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;ROSE: no route to %s&bslash;n&quot;
comma
id|rose2asc
c_func
(paren
id|dest_addr
)paren
)paren
suffix:semicolon
id|rose_transmit_clear_request
c_func
(paren
id|rose_neigh
comma
id|lci
comma
l_int|0x0D
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|new_lci
op_assign
id|rose_new_lci
c_func
(paren
id|new_neigh
)paren
)paren
op_eq
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;ROSE: no spare VCs to %s&bslash;n&quot;
comma
id|rose2asc
c_func
(paren
id|dest_addr
)paren
)paren
suffix:semicolon
id|rose_transmit_clear_request
c_func
(paren
id|rose_neigh
comma
id|lci
comma
l_int|0x0D
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|rose_route
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
op_star
id|rose_route
)paren
comma
id|GFP_ATOMIC
)paren
)paren
op_eq
l_int|NULL
)paren
(brace
id|rose_transmit_clear_request
c_func
(paren
id|rose_neigh
comma
id|lci
comma
l_int|0x0D
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|rose_route-&gt;lci1
op_assign
id|lci
suffix:semicolon
id|rose_route-&gt;src_addr
op_assign
op_star
id|src_addr
suffix:semicolon
id|rose_route-&gt;dest_addr
op_assign
op_star
id|dest_addr
suffix:semicolon
id|rose_route-&gt;src_call
op_assign
id|facilities.dest_call
suffix:semicolon
id|rose_route-&gt;dest_call
op_assign
id|facilities.source_call
suffix:semicolon
id|rose_route-&gt;rand
op_assign
id|facilities.rand
suffix:semicolon
id|rose_route-&gt;neigh1
op_assign
id|rose_neigh
suffix:semicolon
id|rose_route-&gt;lci2
op_assign
id|new_lci
suffix:semicolon
id|rose_route-&gt;neigh2
op_assign
id|new_neigh
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|rose_route-&gt;next
op_assign
id|rose_route_list
suffix:semicolon
id|rose_route_list
op_assign
id|rose_route
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|skb-&gt;data
(braket
l_int|0
)braket
op_and_assign
l_int|0xF0
suffix:semicolon
id|skb-&gt;data
(braket
l_int|0
)braket
op_or_assign
(paren
id|rose_route-&gt;lci2
op_rshift
l_int|8
)paren
op_amp
l_int|0x0F
suffix:semicolon
id|skb-&gt;data
(braket
l_int|1
)braket
op_assign
(paren
id|rose_route-&gt;lci2
op_rshift
l_int|0
)paren
op_amp
l_int|0xFF
suffix:semicolon
id|rose_transmit_link
c_func
(paren
id|skb
comma
id|rose_route-&gt;neigh2
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
DECL|function|rose_nodes_get_info
r_int
id|rose_nodes_get_info
c_func
(paren
r_char
op_star
id|buffer
comma
r_char
op_star
op_star
id|start
comma
id|off_t
id|offset
comma
r_int
id|length
comma
r_int
id|dummy
)paren
(brace
r_struct
id|rose_node
op_star
id|rose_node
suffix:semicolon
r_int
id|len
op_assign
l_int|0
suffix:semicolon
id|off_t
id|pos
op_assign
l_int|0
suffix:semicolon
id|off_t
id|begin
op_assign
l_int|0
suffix:semicolon
r_int
id|i
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|len
op_add_assign
id|sprintf
c_func
(paren
id|buffer
comma
l_string|&quot;address    mask n neigh neigh neigh&bslash;n&quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|rose_node
op_assign
id|rose_node_list
suffix:semicolon
id|rose_node
op_ne
l_int|NULL
suffix:semicolon
id|rose_node
op_assign
id|rose_node-&gt;next
)paren
(brace
id|len
op_add_assign
id|sprintf
c_func
(paren
id|buffer
op_plus
id|len
comma
l_string|&quot;%-10s %04d %d&quot;
comma
id|rose2asc
c_func
(paren
op_amp
id|rose_node-&gt;address
)paren
comma
id|rose_node-&gt;mask
comma
id|rose_node-&gt;count
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|rose_node-&gt;count
suffix:semicolon
id|i
op_increment
)paren
id|len
op_add_assign
id|sprintf
c_func
(paren
id|buffer
op_plus
id|len
comma
l_string|&quot; %05d&quot;
comma
id|rose_node-&gt;neighbour
(braket
id|i
)braket
op_member_access_from_pointer
id|number
)paren
suffix:semicolon
id|len
op_add_assign
id|sprintf
c_func
(paren
id|buffer
op_plus
id|len
comma
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
id|pos
op_assign
id|begin
op_plus
id|len
suffix:semicolon
r_if
c_cond
(paren
id|pos
OL
id|offset
)paren
(brace
id|len
op_assign
l_int|0
suffix:semicolon
id|begin
op_assign
id|pos
suffix:semicolon
)brace
r_if
c_cond
(paren
id|pos
OG
id|offset
op_plus
id|length
)paren
r_break
suffix:semicolon
)brace
id|sti
c_func
(paren
)paren
suffix:semicolon
op_star
id|start
op_assign
id|buffer
op_plus
(paren
id|offset
op_minus
id|begin
)paren
suffix:semicolon
id|len
op_sub_assign
(paren
id|offset
op_minus
id|begin
)paren
suffix:semicolon
r_if
c_cond
(paren
id|len
OG
id|length
)paren
id|len
op_assign
id|length
suffix:semicolon
r_return
id|len
suffix:semicolon
)brace
DECL|function|rose_neigh_get_info
r_int
id|rose_neigh_get_info
c_func
(paren
r_char
op_star
id|buffer
comma
r_char
op_star
op_star
id|start
comma
id|off_t
id|offset
comma
r_int
id|length
comma
r_int
id|dummy
)paren
(brace
r_struct
id|rose_neigh
op_star
id|rose_neigh
suffix:semicolon
r_int
id|len
op_assign
l_int|0
suffix:semicolon
id|off_t
id|pos
op_assign
l_int|0
suffix:semicolon
id|off_t
id|begin
op_assign
l_int|0
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|len
op_add_assign
id|sprintf
c_func
(paren
id|buffer
comma
l_string|&quot;addr  callsign  dev  count  mode  restart   t0   tf&bslash;n&quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|rose_neigh
op_assign
id|rose_neigh_list
suffix:semicolon
id|rose_neigh
op_ne
l_int|NULL
suffix:semicolon
id|rose_neigh
op_assign
id|rose_neigh-&gt;next
)paren
(brace
id|len
op_add_assign
id|sprintf
c_func
(paren
id|buffer
op_plus
id|len
comma
l_string|&quot;%05d %-9s %-4s   %3d   %3s      %3s  %3d  %3d&bslash;n&quot;
comma
id|rose_neigh-&gt;number
comma
id|ax2asc
c_func
(paren
op_amp
id|rose_neigh-&gt;callsign
)paren
comma
id|rose_neigh-&gt;dev
ques
c_cond
id|rose_neigh-&gt;dev-&gt;name
suffix:colon
l_string|&quot;???&quot;
comma
id|rose_neigh-&gt;count
comma
(paren
id|rose_neigh-&gt;dce_mode
)paren
ques
c_cond
l_string|&quot;DCE&quot;
suffix:colon
l_string|&quot;DTE&quot;
comma
(paren
id|rose_neigh-&gt;restarted
)paren
ques
c_cond
l_string|&quot;yes&quot;
suffix:colon
l_string|&quot;no&quot;
comma
id|rose_neigh-&gt;t0timer
op_div
id|ROSE_SLOWHZ
comma
id|rose_neigh-&gt;ftimer
op_div
id|ROSE_SLOWHZ
)paren
suffix:semicolon
id|pos
op_assign
id|begin
op_plus
id|len
suffix:semicolon
r_if
c_cond
(paren
id|pos
OL
id|offset
)paren
(brace
id|len
op_assign
l_int|0
suffix:semicolon
id|begin
op_assign
id|pos
suffix:semicolon
)brace
r_if
c_cond
(paren
id|pos
OG
id|offset
op_plus
id|length
)paren
r_break
suffix:semicolon
)brace
id|sti
c_func
(paren
)paren
suffix:semicolon
op_star
id|start
op_assign
id|buffer
op_plus
(paren
id|offset
op_minus
id|begin
)paren
suffix:semicolon
id|len
op_sub_assign
(paren
id|offset
op_minus
id|begin
)paren
suffix:semicolon
r_if
c_cond
(paren
id|len
OG
id|length
)paren
id|len
op_assign
id|length
suffix:semicolon
r_return
id|len
suffix:semicolon
)brace
DECL|function|rose_routes_get_info
r_int
id|rose_routes_get_info
c_func
(paren
r_char
op_star
id|buffer
comma
r_char
op_star
op_star
id|start
comma
id|off_t
id|offset
comma
r_int
id|length
comma
r_int
id|dummy
)paren
(brace
r_struct
id|rose_route
op_star
id|rose_route
suffix:semicolon
r_int
id|len
op_assign
l_int|0
suffix:semicolon
id|off_t
id|pos
op_assign
l_int|0
suffix:semicolon
id|off_t
id|begin
op_assign
l_int|0
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|len
op_add_assign
id|sprintf
c_func
(paren
id|buffer
comma
l_string|&quot;lci  address     callsign   neigh  &lt;-&gt; lci  address     callsign   neigh&bslash;n&quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|rose_route
op_assign
id|rose_route_list
suffix:semicolon
id|rose_route
op_ne
l_int|NULL
suffix:semicolon
id|rose_route
op_assign
id|rose_route-&gt;next
)paren
(brace
r_if
c_cond
(paren
id|rose_route-&gt;neigh1
op_ne
l_int|NULL
)paren
(brace
id|len
op_add_assign
id|sprintf
c_func
(paren
id|buffer
op_plus
id|len
comma
l_string|&quot;%3.3X  %-10s  %-9s  %05d      &quot;
comma
id|rose_route-&gt;lci1
comma
id|rose2asc
c_func
(paren
op_amp
id|rose_route-&gt;src_addr
)paren
comma
id|ax2asc
c_func
(paren
op_amp
id|rose_route-&gt;src_call
)paren
comma
id|rose_route-&gt;neigh1-&gt;number
)paren
suffix:semicolon
)brace
r_else
(brace
id|len
op_add_assign
id|sprintf
c_func
(paren
id|buffer
op_plus
id|len
comma
l_string|&quot;000  *           *          00000      &quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|rose_route-&gt;neigh2
op_ne
l_int|NULL
)paren
(brace
id|len
op_add_assign
id|sprintf
c_func
(paren
id|buffer
op_plus
id|len
comma
l_string|&quot;%3.3X  %-10s  %-9s  %05d&bslash;n&quot;
comma
id|rose_route-&gt;lci2
comma
id|rose2asc
c_func
(paren
op_amp
id|rose_route-&gt;dest_addr
)paren
comma
id|ax2asc
c_func
(paren
op_amp
id|rose_route-&gt;dest_call
)paren
comma
id|rose_route-&gt;neigh2-&gt;number
)paren
suffix:semicolon
)brace
r_else
(brace
id|len
op_add_assign
id|sprintf
c_func
(paren
id|buffer
op_plus
id|len
comma
l_string|&quot;000  *           *          00000&bslash;n&quot;
)paren
suffix:semicolon
)brace
id|pos
op_assign
id|begin
op_plus
id|len
suffix:semicolon
r_if
c_cond
(paren
id|pos
OL
id|offset
)paren
(brace
id|len
op_assign
l_int|0
suffix:semicolon
id|begin
op_assign
id|pos
suffix:semicolon
)brace
r_if
c_cond
(paren
id|pos
OG
id|offset
op_plus
id|length
)paren
r_break
suffix:semicolon
)brace
id|sti
c_func
(paren
)paren
suffix:semicolon
op_star
id|start
op_assign
id|buffer
op_plus
(paren
id|offset
op_minus
id|begin
)paren
suffix:semicolon
id|len
op_sub_assign
(paren
id|offset
op_minus
id|begin
)paren
suffix:semicolon
r_if
c_cond
(paren
id|len
OG
id|length
)paren
id|len
op_assign
id|length
suffix:semicolon
r_return
id|len
suffix:semicolon
)brace
macro_line|#ifdef MODULE
multiline_comment|/*&n; *&t;Release all memory associated with ROSE routing structures.&n; */
DECL|function|rose_rt_free
r_void
id|rose_rt_free
c_func
(paren
r_void
)paren
(brace
r_struct
id|rose_neigh
op_star
id|s
comma
op_star
id|rose_neigh
op_assign
id|rose_neigh_list
suffix:semicolon
r_struct
id|rose_node
op_star
id|t
comma
op_star
id|rose_node
op_assign
id|rose_node_list
suffix:semicolon
r_struct
id|rose_route
op_star
id|u
comma
op_star
id|rose_route
op_assign
id|rose_route_list
suffix:semicolon
r_while
c_loop
(paren
id|rose_neigh
op_ne
l_int|NULL
)paren
(brace
id|s
op_assign
id|rose_neigh
suffix:semicolon
id|rose_neigh
op_assign
id|rose_neigh-&gt;next
suffix:semicolon
id|rose_remove_neigh
c_func
(paren
id|s
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
id|rose_node
op_ne
l_int|NULL
)paren
(brace
id|t
op_assign
id|rose_node
suffix:semicolon
id|rose_node
op_assign
id|rose_node-&gt;next
suffix:semicolon
id|rose_remove_node
c_func
(paren
id|t
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
id|rose_route
op_ne
l_int|NULL
)paren
(brace
id|u
op_assign
id|rose_route
suffix:semicolon
id|rose_route
op_assign
id|rose_route-&gt;next
suffix:semicolon
id|rose_remove_route
c_func
(paren
id|u
)paren
suffix:semicolon
)brace
)brace
macro_line|#endif
macro_line|#endif
eof
