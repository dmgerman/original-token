multiline_comment|/*&n; *&t;DDP:&t;An implementation of the Appletalk DDP protocol for&n; *&t;&t;ethernet &squot;ELAP&squot;.&n; *&n; *&t;&t;Alan Cox  &lt;Alan.Cox@linux.org&gt;&n; *&t;&t;&t;  &lt;iialan@www.linux.org.uk&gt;&n; *&n; *&t;&t;With more than a little assistance from &n; *&t;&n; *&t;&t;Wesley Craig &lt;netatalk@umich.edu&gt;&n; *&n; *&t;&t;This program is free software; you can redistribute it and/or&n; *&t;&t;modify it under the terms of the GNU General Public License&n; *&t;&t;as published by the Free Software Foundation; either version&n; *&t;&t;2 of the License, or (at your option) any later version.&n; *&n; *&t;TODO&n; *&t;&t;ASYNC I/O&n; *&t;&t;Testing.&n; */
macro_line|#include &lt;asm/segment.h&gt;
macro_line|#include &lt;asm/system.h&gt;
macro_line|#include &lt;asm/bitops.h&gt;
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/mm.h&gt;
macro_line|#include &lt;linux/socket.h&gt;
macro_line|#include &lt;linux/sockios.h&gt;
macro_line|#include &lt;linux/in.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/interrupt.h&gt;
macro_line|#include &lt;linux/if_ether.h&gt;
macro_line|#include &lt;linux/inet.h&gt;
macro_line|#include &lt;linux/notifier.h&gt;
macro_line|#include &lt;linux/netdevice.h&gt;
macro_line|#include &lt;linux/etherdevice.h&gt;
macro_line|#include &lt;linux/skbuff.h&gt;
macro_line|#include &lt;linux/termios.h&gt;&t;/* For TIOCOUTQ/INQ */
macro_line|#include &lt;net/datalink.h&gt;
macro_line|#include &lt;net/p8022.h&gt;
macro_line|#include &lt;net/psnap.h&gt;
macro_line|#include &lt;net/sock.h&gt;
macro_line|#include &lt;net/atalk.h&gt;
macro_line|#ifdef CONFIG_ATALK
DECL|macro|APPLETALK_DEBUG
mdefine_line|#define APPLETALK_DEBUG
macro_line|#ifdef APPLETALK_DEBUG
DECL|macro|DPRINT
mdefine_line|#define DPRINT(x)&t;&t;print(x)
macro_line|#else
DECL|macro|DPRINT
mdefine_line|#define DPRINT(x)
macro_line|#endif
DECL|variable|ddp_dl
DECL|variable|aarp_dl
r_struct
id|datalink_proto
op_star
id|ddp_dl
comma
op_star
id|aarp_dl
suffix:semicolon
DECL|macro|min
mdefine_line|#define min(a,b)&t;(((a)&lt;(b))?(a):(b))
multiline_comment|/***********************************************************************************************************************&bslash;&n;*&t;&t;&t;&t;&t;&t;&t;&t;&t;&t;&t;&t;&t;&t;&t;*&n;*&t;&t;&t;&t;&t;&t;Handlers for the socket list.&t;&t;&t;&t;&t;&t;*&n;*&t;&t;&t;&t;&t;&t;&t;&t;&t;&t;&t;&t;&t;&t;&t;*&n;&bslash;***********************************************************************************************************************/
DECL|variable|atalk_socket_list
r_static
id|atalk_socket
op_star
r_volatile
id|atalk_socket_list
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/*&n; *&t;Note: Sockets may not be removed _during_ an interrupt or inet_bh&n; *&t;handler using this technique. They can be added although we do not&n; *&t;use this facility.&n; */
DECL|function|atalk_remove_socket
r_static
r_void
id|atalk_remove_socket
c_func
(paren
id|atalk_socket
op_star
id|sk
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
id|atalk_socket
op_star
id|s
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|s
op_assign
id|atalk_socket_list
suffix:semicolon
r_if
c_cond
(paren
id|s
op_eq
id|sk
)paren
(brace
id|atalk_socket_list
op_assign
id|s-&gt;next
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_while
c_loop
(paren
id|s
op_logical_and
id|s-&gt;next
)paren
(brace
r_if
c_cond
(paren
id|s-&gt;next
op_eq
id|sk
)paren
(brace
id|s-&gt;next
op_assign
id|sk-&gt;next
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|s
op_assign
id|s-&gt;next
suffix:semicolon
)brace
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
DECL|function|atalk_insert_socket
r_static
r_void
id|atalk_insert_socket
c_func
(paren
id|atalk_socket
op_star
id|sk
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|sk-&gt;next
op_assign
id|atalk_socket_list
suffix:semicolon
id|atalk_socket_list
op_assign
id|sk
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
DECL|function|atalk_search_socket
r_static
id|atalk_socket
op_star
id|atalk_search_socket
c_func
(paren
r_struct
id|sockaddr_at
op_star
id|to
comma
r_struct
id|atalk_iface
op_star
id|atif
)paren
(brace
id|atalk_socket
op_star
id|s
suffix:semicolon
r_for
c_loop
(paren
id|s
op_assign
id|atalk_socket_list
suffix:semicolon
id|s
op_ne
l_int|NULL
suffix:semicolon
id|s
op_assign
id|s-&gt;next
)paren
(brace
r_if
c_cond
(paren
id|to-&gt;sat_port
op_ne
id|s-&gt;at.src_port
)paren
(brace
r_continue
suffix:semicolon
)brace
r_if
c_cond
(paren
id|to-&gt;sat_addr.s_net
op_eq
l_int|0
op_logical_and
id|to-&gt;sat_addr.s_node
op_eq
id|ATADDR_BCAST
op_logical_and
id|s-&gt;at.src_net
op_eq
id|atif-&gt;address.s_net
)paren
(brace
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|to-&gt;sat_addr.s_net
op_eq
id|s-&gt;at.src_net
op_logical_and
id|to-&gt;sat_addr.s_node
op_eq
id|s-&gt;at.src_node
)paren
(brace
r_break
suffix:semicolon
)brace
multiline_comment|/* XXXX.0 */
)brace
r_return
id|s
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;Find a socket in the list.&n; */
DECL|function|atalk_find_socket
r_static
id|atalk_socket
op_star
id|atalk_find_socket
c_func
(paren
r_struct
id|sockaddr_at
op_star
id|sat
)paren
(brace
id|atalk_socket
op_star
id|s
suffix:semicolon
r_for
c_loop
(paren
id|s
op_assign
id|atalk_socket_list
suffix:semicolon
id|s
op_ne
l_int|NULL
suffix:semicolon
id|s
op_assign
id|s-&gt;next
)paren
(brace
r_if
c_cond
(paren
id|s-&gt;at.src_net
op_ne
id|sat-&gt;sat_addr.s_net
)paren
(brace
r_continue
suffix:semicolon
)brace
r_if
c_cond
(paren
id|s-&gt;at.src_node
op_ne
id|sat-&gt;sat_addr.s_node
)paren
(brace
r_continue
suffix:semicolon
)brace
r_if
c_cond
(paren
id|s-&gt;at.src_port
op_ne
id|sat-&gt;sat_port
)paren
(brace
r_continue
suffix:semicolon
)brace
r_break
suffix:semicolon
)brace
r_return
id|s
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;This is only called from user mode. Thus it protects itself against&n; *&t;interrupt users but doesn&squot;t worry about being called during work.&n; *&t;Once it is removed from the queue no interrupt or bottom half will&n; *&t;touch it and we are (fairly 8-) ) safe.&n; */
r_static
r_void
id|atalk_destroy_socket
c_func
(paren
id|atalk_socket
op_star
id|sk
)paren
suffix:semicolon
multiline_comment|/*&n; *&t;Handler for deferred kills.&n; */
DECL|function|atalk_destroy_timer
r_static
r_void
id|atalk_destroy_timer
c_func
(paren
r_int
r_int
id|data
)paren
(brace
id|atalk_destroy_socket
c_func
(paren
(paren
id|atalk_socket
op_star
)paren
id|data
)paren
suffix:semicolon
)brace
DECL|function|atalk_destroy_socket
r_static
r_void
id|atalk_destroy_socket
c_func
(paren
id|atalk_socket
op_star
id|sk
)paren
(brace
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
id|atalk_remove_socket
c_func
(paren
id|sk
)paren
suffix:semicolon
r_while
c_loop
(paren
(paren
id|skb
op_assign
id|skb_dequeue
c_func
(paren
op_amp
id|sk-&gt;receive_queue
)paren
)paren
op_ne
l_int|NULL
)paren
(brace
id|kfree_skb
c_func
(paren
id|skb
comma
id|FREE_READ
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|sk-&gt;wmem_alloc
op_eq
l_int|0
op_logical_and
id|sk-&gt;rmem_alloc
op_eq
l_int|0
op_logical_and
id|sk-&gt;dead
)paren
(brace
id|kfree_s
c_func
(paren
id|sk
comma
r_sizeof
(paren
op_star
id|sk
)paren
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/*&n;&t;&t; *&t;Someone is using our buffers still.. defer&n;&t;&t; */
id|init_timer
c_func
(paren
op_amp
id|sk-&gt;timer
)paren
suffix:semicolon
id|sk-&gt;timer.expires
op_assign
l_int|10
op_star
id|HZ
suffix:semicolon
id|sk-&gt;timer.function
op_assign
id|atalk_destroy_timer
suffix:semicolon
id|sk-&gt;timer.data
op_assign
(paren
r_int
r_int
)paren
id|sk
suffix:semicolon
id|add_timer
c_func
(paren
op_amp
id|sk-&gt;timer
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* Called from proc fs */
DECL|function|atalk_get_info
r_int
id|atalk_get_info
c_func
(paren
r_char
op_star
id|buffer
comma
r_char
op_star
op_star
id|start
comma
id|off_t
id|offset
comma
r_int
id|length
)paren
(brace
id|atalk_socket
op_star
id|s
suffix:semicolon
r_int
id|len
op_assign
l_int|0
suffix:semicolon
id|off_t
id|pos
op_assign
l_int|0
suffix:semicolon
id|off_t
id|begin
op_assign
l_int|0
suffix:semicolon
multiline_comment|/*&n;&t; *&t;Fill this in to print out the appletalk info you want&n;&t; */
multiline_comment|/* Theory.. Keep printing in the same place until we pass offset */
id|len
op_add_assign
id|sprintf
(paren
id|buffer
comma
l_string|&quot;Type local_addr  remote_addr tx_queue rx_queue st uid&bslash;n&quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|s
op_assign
id|atalk_socket_list
suffix:semicolon
id|s
op_ne
l_int|NULL
suffix:semicolon
id|s
op_assign
id|s-&gt;next
)paren
(brace
id|len
op_add_assign
id|sprintf
(paren
id|buffer
op_plus
id|len
comma
l_string|&quot;%02X   &quot;
comma
id|s-&gt;type
)paren
suffix:semicolon
id|len
op_add_assign
id|sprintf
(paren
id|buffer
op_plus
id|len
comma
l_string|&quot;%04X:%02X:%02X  &quot;
comma
id|s-&gt;at.src_net
comma
id|s-&gt;at.src_node
comma
id|s-&gt;at.src_port
)paren
suffix:semicolon
id|len
op_add_assign
id|sprintf
(paren
id|buffer
op_plus
id|len
comma
l_string|&quot;%04X:%02X:%02X  &quot;
comma
id|s-&gt;at.dest_net
comma
id|s-&gt;at.dest_node
comma
id|s-&gt;at.dest_port
)paren
suffix:semicolon
id|len
op_add_assign
id|sprintf
(paren
id|buffer
op_plus
id|len
comma
l_string|&quot;%08lX:%08lX &quot;
comma
id|s-&gt;wmem_alloc
comma
id|s-&gt;rmem_alloc
)paren
suffix:semicolon
id|len
op_add_assign
id|sprintf
(paren
id|buffer
op_plus
id|len
comma
l_string|&quot;%02X %d&bslash;n&quot;
comma
id|s-&gt;state
comma
id|SOCK_INODE
c_func
(paren
id|s-&gt;socket
)paren
op_member_access_from_pointer
id|i_uid
)paren
suffix:semicolon
multiline_comment|/* Are we still dumping unwanted data then discard the record */
id|pos
op_assign
id|begin
op_plus
id|len
suffix:semicolon
r_if
c_cond
(paren
id|pos
OL
id|offset
)paren
(brace
id|len
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Keep dumping into the buffer start */
id|begin
op_assign
id|pos
suffix:semicolon
)brace
r_if
c_cond
(paren
id|pos
OG
id|offset
op_plus
id|length
)paren
(brace
multiline_comment|/* We have dumped enough */
r_break
suffix:semicolon
)brace
)brace
multiline_comment|/* The data in question runs from begin to begin+len */
op_star
id|start
op_assign
id|buffer
op_plus
(paren
id|offset
op_minus
id|begin
)paren
suffix:semicolon
multiline_comment|/* Start of wanted data */
id|len
op_sub_assign
(paren
id|offset
op_minus
id|begin
)paren
suffix:semicolon
multiline_comment|/* Remove unwanted header data from length */
r_if
c_cond
(paren
id|len
OG
id|length
)paren
(brace
id|len
op_assign
id|length
suffix:semicolon
)brace
multiline_comment|/* Remove unwanted tail data from length */
r_return
id|len
suffix:semicolon
)brace
multiline_comment|/*******************************************************************************************************************&bslash;&n;*&t;&t;&t;&t;&t;&t;&t;&t;&t;&t;&t;&t;&t;            *&n;*&t;            &t;&t;&t;Routing tables for the Appletalk socket layer&t;&t;&t;       &t;    *&n;*&t;&t;&t;&t;&t;&t;&t;&t;&t;&t;&t;&t;&t;&t;    *&n;&bslash;*******************************************************************************************************************/
DECL|variable|atalk_router_list
r_static
r_struct
id|atalk_route
op_star
id|atalk_router_list
op_assign
l_int|NULL
suffix:semicolon
DECL|variable|atrtr_default
r_static
r_struct
id|atalk_route
id|atrtr_default
suffix:semicolon
multiline_comment|/* For probing devices or in a routerless network */
DECL|variable|atalk_iface_list
r_static
r_struct
id|atalk_iface
op_star
id|atalk_iface_list
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/*&n; *&t;Appletalk interface control&n; */
multiline_comment|/*&n; *&t;Drop a device. Doesn&squot;t drop any of its routes - that is the &n; *&t;the callers problem. Called when we down the interface or &n; *&t;delete the address.&n; */
DECL|function|atif_drop_device
r_static
r_void
id|atif_drop_device
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
r_struct
id|atalk_iface
op_star
op_star
id|iface
op_assign
op_amp
id|atalk_iface_list
suffix:semicolon
r_struct
id|atalk_iface
op_star
id|tmp
suffix:semicolon
r_while
c_loop
(paren
(paren
id|tmp
op_assign
op_star
id|iface
)paren
op_ne
l_int|NULL
)paren
(brace
r_if
c_cond
(paren
id|tmp-&gt;dev
op_eq
id|dev
)paren
(brace
op_star
id|iface
op_assign
id|tmp-&gt;next
suffix:semicolon
id|kfree_s
c_func
(paren
id|tmp
comma
r_sizeof
(paren
r_struct
id|atalk_iface
)paren
)paren
suffix:semicolon
)brace
r_else
id|iface
op_assign
op_amp
id|tmp-&gt;next
suffix:semicolon
)brace
)brace
DECL|function|atif_add_device
r_static
r_struct
id|atalk_iface
op_star
id|atif_add_device
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
r_struct
id|at_addr
op_star
id|sa
)paren
(brace
r_struct
id|atalk_iface
op_star
id|iface
op_assign
(paren
r_struct
id|atalk_iface
op_star
)paren
id|kmalloc
c_func
(paren
r_sizeof
(paren
op_star
id|iface
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_if
c_cond
(paren
id|iface
op_eq
l_int|NULL
)paren
(brace
r_return
l_int|NULL
suffix:semicolon
)brace
id|iface-&gt;dev
op_assign
id|dev
suffix:semicolon
id|iface-&gt;address
op_assign
op_star
id|sa
suffix:semicolon
id|iface-&gt;status
op_assign
l_int|0
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|iface-&gt;next
op_assign
id|atalk_iface_list
suffix:semicolon
id|atalk_iface_list
op_assign
id|iface
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
id|iface
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;Perform phase 2 AARP probing on our tentative address.&n; */
DECL|function|atif_probe_device
r_static
r_int
id|atif_probe_device
c_func
(paren
r_struct
id|atalk_iface
op_star
id|atif
)paren
(brace
r_int
id|ct
suffix:semicolon
r_int
id|netrange
op_assign
id|ntohs
c_func
(paren
id|atif-&gt;nets.nr_lastnet
)paren
op_minus
id|ntohs
c_func
(paren
id|atif-&gt;nets.nr_firstnet
)paren
op_plus
l_int|1
suffix:semicolon
r_int
id|probe_net
op_assign
id|ntohs
c_func
(paren
id|atif-&gt;address.s_net
)paren
suffix:semicolon
r_int
id|netct
suffix:semicolon
r_int
id|nodect
suffix:semicolon
multiline_comment|/*&n;&t; *&t;Offset the network we start probing with.&n;&t; */
r_if
c_cond
(paren
id|probe_net
op_eq
id|ATADDR_ANYNET
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|netrange
)paren
(brace
id|probe_net
op_assign
id|ntohs
c_func
(paren
id|atif-&gt;nets.nr_firstnet
)paren
suffix:semicolon
)brace
r_else
id|probe_net
op_assign
id|ntohs
c_func
(paren
id|atif-&gt;nets.nr_firstnet
)paren
op_plus
(paren
id|jiffies
op_mod
id|netrange
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;&t; *&t;Scan the networks.&n;&t; */
r_for
c_loop
(paren
id|netct
op_assign
l_int|0
suffix:semicolon
id|netct
op_le
id|netrange
suffix:semicolon
id|netct
op_increment
)paren
(brace
multiline_comment|/*&n;&t;&t; *&t;Sweep the available nodes from a random start.&n;&t;&t; */
r_int
id|nodeoff
op_assign
id|jiffies
op_amp
l_int|255
suffix:semicolon
id|atif-&gt;address.s_net
op_assign
id|htons
c_func
(paren
id|probe_net
)paren
suffix:semicolon
r_for
c_loop
(paren
id|nodect
op_assign
l_int|0
suffix:semicolon
id|nodect
OL
l_int|256
suffix:semicolon
id|nodect
op_increment
)paren
(brace
id|atif-&gt;address.s_node
op_assign
(paren
(paren
id|nodect
op_plus
id|nodeoff
)paren
op_amp
l_int|0xFF
)paren
suffix:semicolon
r_if
c_cond
(paren
id|atif-&gt;address.s_node
OG
l_int|0
op_logical_and
id|atif-&gt;address.s_node
OL
l_int|254
)paren
(brace
multiline_comment|/*&n;&t;&t;&t;&t; *&t;Probe a proposed address.&n;&t;&t;&t;&t; */
r_for
c_loop
(paren
id|ct
op_assign
l_int|0
suffix:semicolon
id|ct
OL
id|AARP_RETRANSMIT_LIMIT
suffix:semicolon
id|ct
op_increment
)paren
(brace
id|aarp_send_probe
c_func
(paren
id|atif-&gt;dev
comma
op_amp
id|atif-&gt;address
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t;&t;&t;&t; *&t;Defer 1/10th&n;&t;&t;&t;&t;&t; */
id|current-&gt;timeout
op_assign
id|jiffies
op_plus
(paren
id|HZ
op_div
l_int|10
)paren
suffix:semicolon
id|current-&gt;state
op_assign
id|TASK_INTERRUPTIBLE
suffix:semicolon
id|schedule
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|atif-&gt;status
op_amp
id|ATIF_PROBE_FAIL
)paren
(brace
r_break
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|atif-&gt;status
op_amp
id|ATIF_PROBE_FAIL
)paren
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
)brace
id|atif-&gt;status
op_and_assign
op_complement
id|ATIF_PROBE_FAIL
suffix:semicolon
)brace
id|probe_net
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|probe_net
OG
id|ntohs
c_func
(paren
id|atif-&gt;nets.nr_lastnet
)paren
)paren
(brace
id|probe_net
op_assign
id|ntohs
c_func
(paren
id|atif-&gt;nets.nr_firstnet
)paren
suffix:semicolon
)brace
)brace
r_return
op_minus
id|EADDRINUSE
suffix:semicolon
multiline_comment|/* Network is full... */
)brace
DECL|function|atalk_find_dev_addr
r_struct
id|at_addr
op_star
id|atalk_find_dev_addr
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
r_struct
id|atalk_iface
op_star
id|iface
suffix:semicolon
r_for
c_loop
(paren
id|iface
op_assign
id|atalk_iface_list
suffix:semicolon
id|iface
op_ne
l_int|NULL
suffix:semicolon
id|iface
op_assign
id|iface-&gt;next
)paren
r_if
c_cond
(paren
id|iface-&gt;dev
op_eq
id|dev
)paren
(brace
r_return
op_amp
id|iface-&gt;address
suffix:semicolon
)brace
r_return
l_int|NULL
suffix:semicolon
)brace
DECL|function|atalk_find_primary
r_static
r_struct
id|at_addr
op_star
id|atalk_find_primary
c_func
(paren
r_void
)paren
(brace
r_struct
id|atalk_iface
op_star
id|iface
suffix:semicolon
r_for
c_loop
(paren
id|iface
op_assign
id|atalk_iface_list
suffix:semicolon
id|iface
op_ne
l_int|NULL
suffix:semicolon
id|iface
op_assign
id|iface-&gt;next
)paren
r_if
c_cond
(paren
op_logical_neg
(paren
id|iface-&gt;dev-&gt;flags
op_amp
id|IFF_LOOPBACK
)paren
)paren
(brace
r_return
op_amp
id|iface-&gt;address
suffix:semicolon
)brace
r_if
c_cond
(paren
id|atalk_iface_list
op_ne
l_int|NULL
)paren
(brace
r_return
op_amp
id|atalk_iface_list-&gt;address
suffix:semicolon
)brace
r_else
(brace
r_return
l_int|NULL
suffix:semicolon
)brace
)brace
multiline_comment|/*&n; *&t;Give a device find its atif control structure&n; */
DECL|function|atalk_find_dev
r_struct
id|atalk_iface
op_star
id|atalk_find_dev
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
r_struct
id|atalk_iface
op_star
id|iface
suffix:semicolon
r_for
c_loop
(paren
id|iface
op_assign
id|atalk_iface_list
suffix:semicolon
id|iface
op_ne
l_int|NULL
suffix:semicolon
id|iface
op_assign
id|iface-&gt;next
)paren
r_if
c_cond
(paren
id|iface-&gt;dev
op_eq
id|dev
)paren
(brace
r_return
id|iface
suffix:semicolon
)brace
r_return
l_int|NULL
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;Find a match for &squot;any network&squot; - ie any of our interfaces with that&n; *&t;node number will do just nicely.&n; */
DECL|function|atalk_find_anynet
r_static
r_struct
id|atalk_iface
op_star
id|atalk_find_anynet
c_func
(paren
r_int
id|node
comma
r_struct
id|device
op_star
id|dev
)paren
(brace
r_struct
id|atalk_iface
op_star
id|iface
suffix:semicolon
r_for
c_loop
(paren
id|iface
op_assign
id|atalk_iface_list
suffix:semicolon
id|iface
op_ne
l_int|NULL
suffix:semicolon
id|iface
op_assign
id|iface-&gt;next
)paren
(brace
r_if
c_cond
(paren
id|iface-&gt;dev
op_ne
id|dev
op_logical_or
(paren
id|iface-&gt;status
op_amp
id|ATIF_PROBE
)paren
)paren
(brace
r_continue
suffix:semicolon
)brace
r_if
c_cond
(paren
id|node
op_eq
id|ATADDR_BCAST
op_logical_or
id|iface-&gt;address.s_node
op_eq
id|node
)paren
(brace
r_return
id|iface
suffix:semicolon
)brace
)brace
r_return
l_int|NULL
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;Find a match for a specific network:node pair&n; */
DECL|function|atalk_find_interface
r_static
r_struct
id|atalk_iface
op_star
id|atalk_find_interface
c_func
(paren
r_int
id|net
comma
r_int
id|node
)paren
(brace
r_struct
id|atalk_iface
op_star
id|iface
suffix:semicolon
r_for
c_loop
(paren
id|iface
op_assign
id|atalk_iface_list
suffix:semicolon
id|iface
op_ne
l_int|NULL
suffix:semicolon
id|iface
op_assign
id|iface-&gt;next
)paren
(brace
r_if
c_cond
(paren
(paren
id|node
op_eq
id|ATADDR_BCAST
op_logical_or
id|iface-&gt;address.s_node
op_eq
id|node
)paren
op_logical_and
id|iface-&gt;address.s_net
op_eq
id|net
op_logical_and
op_logical_neg
(paren
id|iface-&gt;status
op_amp
id|ATIF_PROBE
)paren
)paren
(brace
r_return
id|iface
suffix:semicolon
)brace
)brace
r_return
l_int|NULL
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;Find a route for an appletalk packet. This ought to get cached in&n; *&t;the socket (later on...). We know about host routes and the fact&n; *&t;that a route must be direct to broadcast.&n; */
DECL|function|atrtr_find
r_static
r_struct
id|atalk_route
op_star
id|atrtr_find
c_func
(paren
r_struct
id|at_addr
op_star
id|target
)paren
(brace
r_struct
id|atalk_route
op_star
id|r
suffix:semicolon
r_for
c_loop
(paren
id|r
op_assign
id|atalk_router_list
suffix:semicolon
id|r
op_ne
l_int|NULL
suffix:semicolon
id|r
op_assign
id|r-&gt;next
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|r-&gt;flags
op_amp
id|RTF_UP
)paren
)paren
(brace
r_continue
suffix:semicolon
)brace
r_if
c_cond
(paren
id|r-&gt;target.s_net
op_eq
id|target-&gt;s_net
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|r-&gt;flags
op_amp
id|RTF_HOST
)paren
op_logical_or
id|r-&gt;target.s_node
op_eq
id|target-&gt;s_node
)paren
(brace
r_return
id|r
suffix:semicolon
)brace
)brace
)brace
r_if
c_cond
(paren
id|atrtr_default.dev
)paren
(brace
r_return
op_amp
id|atrtr_default
suffix:semicolon
)brace
r_return
l_int|NULL
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;Given an appletalk network find the device to use. This can be&n; *&t;a simple lookup. Funny stuff like routers can wait 8)&n; */
DECL|function|atrtr_get_dev
r_static
r_struct
id|device
op_star
id|atrtr_get_dev
c_func
(paren
r_struct
id|at_addr
op_star
id|sa
)paren
(brace
r_struct
id|atalk_route
op_star
id|atr
op_assign
id|atrtr_find
c_func
(paren
id|sa
)paren
suffix:semicolon
r_if
c_cond
(paren
id|atr
op_eq
l_int|NULL
)paren
(brace
r_return
l_int|NULL
suffix:semicolon
)brace
r_else
r_return
id|atr-&gt;dev
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;Set up a default router.&n; */
DECL|function|atrtr_set_default
r_static
r_void
id|atrtr_set_default
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
id|atrtr_default.dev
op_assign
id|dev
suffix:semicolon
id|atrtr_default.flags
op_assign
id|RTF_UP
suffix:semicolon
id|atrtr_default.gateway.s_net
op_assign
id|htons
c_func
(paren
l_int|0
)paren
suffix:semicolon
id|atrtr_default.gateway.s_node
op_assign
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;Add a router. Basically make sure it looks valid and stuff the&n; *&t;entry in the list. While it uses netranges we always set them to one&n; *&t;entry to work like netatalk.&n; */
DECL|function|atrtr_create
r_static
r_int
id|atrtr_create
c_func
(paren
r_struct
id|rtentry
op_star
id|r
comma
r_struct
id|device
op_star
id|devhint
)paren
(brace
r_struct
id|sockaddr_at
op_star
id|ta
op_assign
(paren
r_struct
id|sockaddr_at
op_star
)paren
op_amp
id|r-&gt;rt_dst
suffix:semicolon
r_struct
id|sockaddr_at
op_star
id|ga
op_assign
(paren
r_struct
id|sockaddr_at
op_star
)paren
op_amp
id|r-&gt;rt_gateway
suffix:semicolon
r_struct
id|atalk_route
op_star
id|rt
suffix:semicolon
r_struct
id|atalk_iface
op_star
id|iface
comma
op_star
id|riface
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
multiline_comment|/*&n;&t; *&t;Fixme: Raise/Lower a routing change semaphore for these&n;&t; *&t;operations.&n;&t; */
multiline_comment|/*&n;&t; *&t;Validate the request&n;&t; */
r_if
c_cond
(paren
id|ta-&gt;sat_family
op_ne
id|AF_APPLETALK
)paren
(brace
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|devhint
op_eq
l_int|NULL
op_logical_and
id|ga-&gt;sat_family
op_ne
id|AF_APPLETALK
)paren
(brace
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
multiline_comment|/*&n;&t; *&t;Now walk the routing table and make our decisions&n;&t; */
r_for
c_loop
(paren
id|rt
op_assign
id|atalk_router_list
suffix:semicolon
id|rt
op_ne
l_int|NULL
suffix:semicolon
id|rt
op_assign
id|rt-&gt;next
)paren
(brace
r_if
c_cond
(paren
id|r-&gt;rt_flags
op_ne
id|rt-&gt;flags
)paren
(brace
r_continue
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ta-&gt;sat_addr.s_net
op_eq
id|rt-&gt;target.s_net
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|rt-&gt;flags
op_amp
id|RTF_HOST
)paren
)paren
(brace
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ta-&gt;sat_addr.s_node
op_eq
id|rt-&gt;target.s_node
)paren
(brace
r_break
suffix:semicolon
)brace
)brace
)brace
r_if
c_cond
(paren
id|devhint
op_eq
l_int|NULL
)paren
(brace
r_for
c_loop
(paren
id|riface
op_assign
l_int|NULL
comma
id|iface
op_assign
id|atalk_iface_list
suffix:semicolon
id|iface
suffix:semicolon
id|iface
op_assign
id|iface-&gt;next
)paren
(brace
r_if
c_cond
(paren
id|riface
op_eq
l_int|NULL
op_logical_and
id|ntohs
c_func
(paren
id|ga-&gt;sat_addr.s_net
)paren
op_ge
id|ntohs
c_func
(paren
id|iface-&gt;nets.nr_firstnet
)paren
op_logical_and
id|ntohs
c_func
(paren
id|ga-&gt;sat_addr.s_net
)paren
op_le
id|ntohs
c_func
(paren
id|iface-&gt;nets.nr_lastnet
)paren
)paren
id|riface
op_assign
id|iface
suffix:semicolon
r_if
c_cond
(paren
id|ga-&gt;sat_addr.s_net
op_eq
id|iface-&gt;address.s_net
op_logical_and
id|ga-&gt;sat_addr.s_node
op_eq
id|iface-&gt;address.s_node
)paren
id|riface
op_assign
id|iface
suffix:semicolon
)brace
r_if
c_cond
(paren
id|riface
op_eq
l_int|NULL
)paren
r_return
op_minus
id|ENETUNREACH
suffix:semicolon
id|devhint
op_assign
id|riface-&gt;dev
suffix:semicolon
)brace
r_if
c_cond
(paren
id|rt
op_eq
l_int|NULL
)paren
(brace
id|rt
op_assign
(paren
r_struct
id|atalk_route
op_star
)paren
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|atalk_route
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rt
op_eq
l_int|NULL
)paren
(brace
r_return
op_minus
id|ENOBUFS
suffix:semicolon
)brace
id|cli
c_func
(paren
)paren
suffix:semicolon
id|rt-&gt;next
op_assign
id|atalk_router_list
suffix:semicolon
id|atalk_router_list
op_assign
id|rt
suffix:semicolon
)brace
multiline_comment|/*&n;&t; *&t;Fill in the entry.&n;&t; */
id|rt-&gt;target
op_assign
id|ta-&gt;sat_addr
suffix:semicolon
id|rt-&gt;dev
op_assign
id|devhint
suffix:semicolon
id|rt-&gt;flags
op_assign
id|r-&gt;rt_flags
suffix:semicolon
id|rt-&gt;gateway
op_assign
id|ga-&gt;sat_addr
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;Delete a route. Find it and discard it.&n; */
DECL|function|atrtr_delete
r_static
r_int
id|atrtr_delete
c_func
(paren
r_struct
id|at_addr
op_star
id|addr
)paren
(brace
r_struct
id|atalk_route
op_star
op_star
id|r
op_assign
op_amp
id|atalk_router_list
suffix:semicolon
r_struct
id|atalk_route
op_star
id|tmp
suffix:semicolon
r_while
c_loop
(paren
(paren
id|tmp
op_assign
op_star
id|r
)paren
op_ne
l_int|NULL
)paren
(brace
r_if
c_cond
(paren
id|tmp-&gt;target.s_net
op_eq
id|addr-&gt;s_net
op_logical_and
(paren
op_logical_neg
(paren
id|tmp-&gt;flags
op_amp
id|RTF_GATEWAY
)paren
op_logical_or
id|tmp-&gt;target.s_node
op_eq
id|addr-&gt;s_node
)paren
)paren
(brace
op_star
id|r
op_assign
id|tmp-&gt;next
suffix:semicolon
id|kfree_s
c_func
(paren
id|tmp
comma
r_sizeof
(paren
r_struct
id|atalk_route
)paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|r
op_assign
op_amp
id|tmp-&gt;next
suffix:semicolon
)brace
r_return
op_minus
id|ENOENT
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;Called when a device is downed. Just throw away any routes&n; *&t;via it.&n; */
DECL|function|atrtr_device_down
r_void
id|atrtr_device_down
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
r_struct
id|atalk_route
op_star
op_star
id|r
op_assign
op_amp
id|atalk_router_list
suffix:semicolon
r_struct
id|atalk_route
op_star
id|tmp
suffix:semicolon
r_while
c_loop
(paren
(paren
id|tmp
op_assign
op_star
id|r
)paren
op_ne
l_int|NULL
)paren
(brace
r_if
c_cond
(paren
id|tmp-&gt;dev
op_eq
id|dev
)paren
(brace
op_star
id|r
op_assign
id|tmp-&gt;next
suffix:semicolon
id|kfree_s
c_func
(paren
id|tmp
comma
r_sizeof
(paren
r_struct
id|atalk_route
)paren
)paren
suffix:semicolon
)brace
r_else
id|r
op_assign
op_amp
id|tmp-&gt;next
suffix:semicolon
)brace
r_if
c_cond
(paren
id|atrtr_default.dev
op_eq
id|dev
)paren
(brace
id|atrtr_set_default
c_func
(paren
l_int|NULL
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/*&n; *&t;A device event has occured. Watch for devices going down and&n; *&t;delete our use of them (iface and route).&n; */
DECL|function|ddp_device_event
r_static
r_int
id|ddp_device_event
c_func
(paren
r_int
r_int
id|event
comma
r_void
op_star
id|ptr
)paren
(brace
r_if
c_cond
(paren
id|event
op_eq
id|NETDEV_DOWN
)paren
(brace
multiline_comment|/* Discard any use of this */
id|atrtr_device_down
c_func
(paren
(paren
r_struct
id|device
op_star
)paren
id|ptr
)paren
suffix:semicolon
id|atif_drop_device
c_func
(paren
(paren
r_struct
id|device
op_star
)paren
id|ptr
)paren
suffix:semicolon
)brace
r_return
id|NOTIFY_DONE
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;ioctl calls. Shouldn&squot;t even need touching.&n; */
multiline_comment|/*&n; *&t;Device configuration ioctl calls.&n; */
DECL|function|atif_ioctl
r_int
id|atif_ioctl
c_func
(paren
r_int
id|cmd
comma
r_void
op_star
id|arg
)paren
(brace
r_struct
id|ifreq
id|atreq
suffix:semicolon
r_static
r_char
id|aarp_mcast
(braket
l_int|6
)braket
op_assign
initialization_block
suffix:semicolon
r_struct
id|netrange
op_star
id|nr
suffix:semicolon
r_struct
id|sockaddr_at
op_star
id|sa
suffix:semicolon
r_struct
id|device
op_star
id|dev
suffix:semicolon
r_struct
id|atalk_iface
op_star
id|atif
suffix:semicolon
r_int
id|ro
op_assign
(paren
id|cmd
op_eq
id|SIOCSIFADDR
)paren
suffix:semicolon
r_int
id|err
op_assign
id|verify_area
c_func
(paren
id|ro
ques
c_cond
id|VERIFY_READ
suffix:colon
id|VERIFY_WRITE
comma
id|arg
comma
r_sizeof
(paren
id|atreq
)paren
)paren
suffix:semicolon
r_int
id|ct
suffix:semicolon
r_int
id|limit
suffix:semicolon
r_struct
id|rtentry
id|rtdef
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
(brace
r_return
id|err
suffix:semicolon
)brace
id|memcpy_fromfs
c_func
(paren
op_amp
id|atreq
comma
id|arg
comma
r_sizeof
(paren
id|atreq
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|dev
op_assign
id|dev_get
c_func
(paren
id|atreq.ifr_name
)paren
)paren
op_eq
l_int|NULL
)paren
(brace
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
id|sa
op_assign
(paren
r_struct
id|sockaddr_at
op_star
)paren
op_amp
id|atreq.ifr_addr
suffix:semicolon
id|atif
op_assign
id|atalk_find_dev
c_func
(paren
id|dev
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|cmd
)paren
(brace
r_case
id|SIOCSIFADDR
suffix:colon
r_if
c_cond
(paren
op_logical_neg
id|suser
c_func
(paren
)paren
)paren
(brace
r_return
op_minus
id|EPERM
suffix:semicolon
)brace
r_if
c_cond
(paren
id|sa-&gt;sat_family
op_ne
id|AF_APPLETALK
)paren
(brace
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|dev-&gt;type
op_ne
id|ARPHRD_ETHER
)paren
(brace
r_return
op_minus
id|EPROTONOSUPPORT
suffix:semicolon
)brace
id|nr
op_assign
(paren
r_struct
id|netrange
op_star
)paren
op_amp
id|sa-&gt;sat_zero
(braket
l_int|0
)braket
suffix:semicolon
r_if
c_cond
(paren
id|nr-&gt;nr_phase
op_ne
l_int|2
)paren
(brace
r_return
op_minus
id|EPROTONOSUPPORT
suffix:semicolon
)brace
r_if
c_cond
(paren
id|sa-&gt;sat_addr.s_node
op_eq
id|ATADDR_BCAST
op_logical_or
id|sa-&gt;sat_addr.s_node
op_eq
l_int|254
)paren
(brace
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|atif
)paren
(brace
multiline_comment|/*&n;&t;&t;&t;&t; *&t;Already setting address.&n;&t;&t;&t;&t; */
r_if
c_cond
(paren
id|atif-&gt;status
op_amp
id|ATIF_PROBE
)paren
(brace
r_return
op_minus
id|EBUSY
suffix:semicolon
)brace
id|atif-&gt;address.s_net
op_assign
id|sa-&gt;sat_addr.s_net
suffix:semicolon
id|atif-&gt;address.s_node
op_assign
id|sa-&gt;sat_addr.s_node
suffix:semicolon
id|atrtr_device_down
c_func
(paren
id|dev
)paren
suffix:semicolon
multiline_comment|/* Flush old routes */
)brace
r_else
(brace
id|atif
op_assign
id|atif_add_device
c_func
(paren
id|dev
comma
op_amp
id|sa-&gt;sat_addr
)paren
suffix:semicolon
)brace
id|atif-&gt;nets
op_assign
op_star
id|nr
suffix:semicolon
multiline_comment|/*&n;&t;&t;&t; *&t;Check if the chosen address is used. If so we &n;&t;&t;&t; *&t;error and atalkd will try another. &n;&t;&t;&t; */
r_if
c_cond
(paren
op_logical_neg
(paren
id|dev-&gt;flags
op_amp
id|IFF_LOOPBACK
)paren
op_logical_and
id|atif_probe_device
c_func
(paren
id|atif
)paren
OL
l_int|0
)paren
(brace
id|atif_drop_device
c_func
(paren
id|dev
)paren
suffix:semicolon
r_return
op_minus
id|EADDRINUSE
suffix:semicolon
)brace
multiline_comment|/*&n;&t;&t;&t; *&t;Hey it worked - add the direct&n;&t;&t;&t; *&t;routes.&n;&t;&t;&t; */
id|sa
op_assign
(paren
r_struct
id|sockaddr_at
op_star
)paren
op_amp
id|rtdef.rt_gateway
suffix:semicolon
id|sa-&gt;sat_family
op_assign
id|AF_APPLETALK
suffix:semicolon
id|sa-&gt;sat_addr.s_net
op_assign
id|atif-&gt;address.s_net
suffix:semicolon
id|sa-&gt;sat_addr.s_node
op_assign
id|atif-&gt;address.s_node
suffix:semicolon
id|sa
op_assign
(paren
r_struct
id|sockaddr_at
op_star
)paren
op_amp
id|rtdef.rt_dst
suffix:semicolon
id|rtdef.rt_flags
op_assign
id|RTF_UP
suffix:semicolon
id|sa-&gt;sat_family
op_assign
id|AF_APPLETALK
suffix:semicolon
id|sa-&gt;sat_addr.s_node
op_assign
id|ATADDR_ANYNODE
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;flags
op_amp
id|IFF_LOOPBACK
)paren
(brace
id|rtdef.rt_flags
op_or_assign
id|RTF_HOST
suffix:semicolon
)brace
multiline_comment|/*&n;&t;&t;&t; *&t;Routerless initial state.&n;&t;&t;&t; */
r_if
c_cond
(paren
id|nr-&gt;nr_firstnet
op_eq
id|htons
c_func
(paren
l_int|0
)paren
op_logical_and
id|nr-&gt;nr_lastnet
op_eq
id|htons
c_func
(paren
l_int|0xFFFE
)paren
)paren
(brace
id|sa-&gt;sat_addr.s_net
op_assign
id|atif-&gt;address.s_net
suffix:semicolon
id|atrtr_create
c_func
(paren
op_amp
id|rtdef
comma
id|dev
)paren
suffix:semicolon
id|atrtr_set_default
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
r_else
(brace
id|limit
op_assign
id|ntohs
c_func
(paren
id|nr-&gt;nr_lastnet
)paren
suffix:semicolon
r_if
c_cond
(paren
id|limit
op_minus
id|ntohs
c_func
(paren
id|nr-&gt;nr_firstnet
)paren
OG
l_int|256
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;Too many routes/iface.&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_for
c_loop
(paren
id|ct
op_assign
id|ntohs
c_func
(paren
id|nr-&gt;nr_firstnet
)paren
suffix:semicolon
id|ct
op_le
id|limit
suffix:semicolon
id|ct
op_increment
)paren
(brace
id|sa-&gt;sat_addr.s_net
op_assign
id|htons
c_func
(paren
id|ct
)paren
suffix:semicolon
id|atrtr_create
c_func
(paren
op_amp
id|rtdef
comma
id|dev
)paren
suffix:semicolon
)brace
)brace
id|dev_mc_add
c_func
(paren
id|dev
comma
id|aarp_mcast
comma
l_int|6
comma
l_int|1
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
r_case
id|SIOCGIFADDR
suffix:colon
r_if
c_cond
(paren
id|atif
op_eq
l_int|NULL
)paren
(brace
r_return
op_minus
id|EADDRNOTAVAIL
suffix:semicolon
)brace
(paren
(paren
r_struct
id|sockaddr_at
op_star
)paren
(paren
op_amp
id|atreq.ifr_addr
)paren
)paren
op_member_access_from_pointer
id|sat_family
op_assign
id|AF_APPLETALK
suffix:semicolon
(paren
(paren
r_struct
id|sockaddr_at
op_star
)paren
(paren
op_amp
id|atreq.ifr_addr
)paren
)paren
op_member_access_from_pointer
id|sat_addr
op_assign
id|atif-&gt;address
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SIOCGIFBRDADDR
suffix:colon
r_if
c_cond
(paren
id|atif
op_eq
l_int|NULL
)paren
(brace
r_return
op_minus
id|EADDRNOTAVAIL
suffix:semicolon
)brace
(paren
(paren
r_struct
id|sockaddr_at
op_star
)paren
(paren
op_amp
id|atreq.ifr_addr
)paren
)paren
op_member_access_from_pointer
id|sat_family
op_assign
id|AF_APPLETALK
suffix:semicolon
(paren
(paren
r_struct
id|sockaddr_at
op_star
)paren
(paren
op_amp
id|atreq.ifr_addr
)paren
)paren
op_member_access_from_pointer
id|sat_addr.s_net
op_assign
id|atif-&gt;address.s_net
suffix:semicolon
(paren
(paren
r_struct
id|sockaddr_at
op_star
)paren
(paren
op_amp
id|atreq.ifr_addr
)paren
)paren
op_member_access_from_pointer
id|sat_addr.s_node
op_assign
id|ATADDR_BCAST
suffix:semicolon
r_break
suffix:semicolon
)brace
id|memcpy_tofs
c_func
(paren
id|arg
comma
op_amp
id|atreq
comma
r_sizeof
(paren
id|atreq
)paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;Routing ioctl() calls&n; */
DECL|function|atrtr_ioctl
r_static
r_int
id|atrtr_ioctl
c_func
(paren
r_int
r_int
id|cmd
comma
r_void
op_star
id|arg
)paren
(brace
r_int
id|err
suffix:semicolon
r_struct
id|rtentry
id|rt
suffix:semicolon
id|err
op_assign
id|verify_area
c_func
(paren
id|VERIFY_READ
comma
id|arg
comma
r_sizeof
(paren
id|rt
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
(brace
r_return
id|err
suffix:semicolon
)brace
id|memcpy_fromfs
c_func
(paren
op_amp
id|rt
comma
id|arg
comma
r_sizeof
(paren
id|rt
)paren
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|cmd
)paren
(brace
r_case
id|SIOCDELRT
suffix:colon
r_if
c_cond
(paren
id|rt.rt_dst.sa_family
op_ne
id|AF_APPLETALK
)paren
(brace
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_return
id|atrtr_delete
c_func
(paren
op_amp
(paren
(paren
r_struct
id|sockaddr_at
op_star
)paren
op_amp
id|rt.rt_dst
)paren
op_member_access_from_pointer
id|sat_addr
)paren
suffix:semicolon
r_case
id|SIOCADDRT
suffix:colon
r_return
id|atrtr_create
c_func
(paren
op_amp
id|rt
comma
l_int|NULL
)paren
suffix:semicolon
r_default
suffix:colon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
)brace
multiline_comment|/* Called from proc fs - just make it print the ifaces neatly */
DECL|function|atalk_if_get_info
r_int
id|atalk_if_get_info
c_func
(paren
r_char
op_star
id|buffer
comma
r_char
op_star
op_star
id|start
comma
id|off_t
id|offset
comma
r_int
id|length
)paren
(brace
r_struct
id|atalk_iface
op_star
id|iface
suffix:semicolon
r_int
id|len
op_assign
l_int|0
suffix:semicolon
id|off_t
id|pos
op_assign
l_int|0
suffix:semicolon
id|off_t
id|begin
op_assign
l_int|0
suffix:semicolon
id|len
op_add_assign
id|sprintf
(paren
id|buffer
comma
l_string|&quot;Interface&t;  Address   Networks   Status&bslash;n&quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|iface
op_assign
id|atalk_iface_list
suffix:semicolon
id|iface
op_ne
l_int|NULL
suffix:semicolon
id|iface
op_assign
id|iface-&gt;next
)paren
(brace
id|len
op_add_assign
id|sprintf
(paren
id|buffer
op_plus
id|len
comma
l_string|&quot;%-16s %04X:%02X  %04X-%04X  %d&bslash;n&quot;
comma
id|iface-&gt;dev-&gt;name
comma
id|ntohs
c_func
(paren
id|iface-&gt;address.s_net
)paren
comma
id|iface-&gt;address.s_node
comma
id|ntohs
c_func
(paren
id|iface-&gt;nets.nr_firstnet
)paren
comma
id|ntohs
c_func
(paren
id|iface-&gt;nets.nr_lastnet
)paren
comma
id|iface-&gt;status
)paren
suffix:semicolon
id|pos
op_assign
id|begin
op_plus
id|len
suffix:semicolon
r_if
c_cond
(paren
id|pos
OL
id|offset
)paren
(brace
id|len
op_assign
l_int|0
suffix:semicolon
id|begin
op_assign
id|pos
suffix:semicolon
)brace
r_if
c_cond
(paren
id|pos
OG
id|offset
op_plus
id|length
)paren
(brace
r_break
suffix:semicolon
)brace
)brace
op_star
id|start
op_assign
id|buffer
op_plus
(paren
id|offset
op_minus
id|begin
)paren
suffix:semicolon
id|len
op_sub_assign
(paren
id|offset
op_minus
id|begin
)paren
suffix:semicolon
r_if
c_cond
(paren
id|len
OG
id|length
)paren
(brace
id|len
op_assign
id|length
suffix:semicolon
)brace
r_return
id|len
suffix:semicolon
)brace
multiline_comment|/* Called from proc fs - just make it print the routes neatly */
DECL|function|atalk_rt_get_info
r_int
id|atalk_rt_get_info
c_func
(paren
r_char
op_star
id|buffer
comma
r_char
op_star
op_star
id|start
comma
id|off_t
id|offset
comma
r_int
id|length
)paren
(brace
r_struct
id|atalk_route
op_star
id|rt
suffix:semicolon
r_int
id|len
op_assign
l_int|0
suffix:semicolon
id|off_t
id|pos
op_assign
l_int|0
suffix:semicolon
id|off_t
id|begin
op_assign
l_int|0
suffix:semicolon
id|len
op_add_assign
id|sprintf
(paren
id|buffer
comma
l_string|&quot;Target        Router  Flags Dev&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|atrtr_default.dev
)paren
(brace
id|rt
op_assign
op_amp
id|atrtr_default
suffix:semicolon
id|len
op_add_assign
id|sprintf
(paren
id|buffer
op_plus
id|len
comma
l_string|&quot;Default     %5d:%-3d  %-4d  %s&bslash;n&quot;
comma
id|ntohs
c_func
(paren
id|rt-&gt;gateway.s_net
)paren
comma
id|rt-&gt;gateway.s_node
comma
id|rt-&gt;flags
comma
id|rt-&gt;dev-&gt;name
)paren
suffix:semicolon
)brace
r_for
c_loop
(paren
id|rt
op_assign
id|atalk_router_list
suffix:semicolon
id|rt
op_ne
l_int|NULL
suffix:semicolon
id|rt
op_assign
id|rt-&gt;next
)paren
(brace
id|len
op_add_assign
id|sprintf
(paren
id|buffer
op_plus
id|len
comma
l_string|&quot;%04X:%02X     %5d:%-3d  %-4d  %s&bslash;n&quot;
comma
id|ntohs
c_func
(paren
id|rt-&gt;target.s_net
)paren
comma
id|rt-&gt;target.s_node
comma
id|ntohs
c_func
(paren
id|rt-&gt;gateway.s_net
)paren
comma
id|rt-&gt;gateway.s_node
comma
id|rt-&gt;flags
comma
id|rt-&gt;dev-&gt;name
)paren
suffix:semicolon
id|pos
op_assign
id|begin
op_plus
id|len
suffix:semicolon
r_if
c_cond
(paren
id|pos
OL
id|offset
)paren
(brace
id|len
op_assign
l_int|0
suffix:semicolon
id|begin
op_assign
id|pos
suffix:semicolon
)brace
r_if
c_cond
(paren
id|pos
OG
id|offset
op_plus
id|length
)paren
(brace
r_break
suffix:semicolon
)brace
)brace
op_star
id|start
op_assign
id|buffer
op_plus
(paren
id|offset
op_minus
id|begin
)paren
suffix:semicolon
id|len
op_sub_assign
(paren
id|offset
op_minus
id|begin
)paren
suffix:semicolon
r_if
c_cond
(paren
id|len
OG
id|length
)paren
(brace
id|len
op_assign
id|length
suffix:semicolon
)brace
r_return
id|len
suffix:semicolon
)brace
multiline_comment|/*******************************************************************************************************************&bslash;&n;*&t;&t;&t;&t;&t;&t;&t;&t;&t;&t;&t;&t;&t;            *&n;*&t;      Handling for system calls applied via the various interfaces to an Appletalk socket object&t;    *&n;*&t;&t;&t;&t;&t;&t;&t;&t;&t;&t;&t;&t;&t;&t;    *&n;&bslash;*******************************************************************************************************************/
multiline_comment|/*&n; *&t;Checksum: This is &squot;optional&squot;. It&squot;s quite likely also a good&n; *&t;candidate for assembler hackery 8)&n; */
DECL|function|atalk_checksum
r_int
r_int
id|atalk_checksum
c_func
(paren
r_struct
id|ddpehdr
op_star
id|ddp
comma
r_int
id|len
)paren
(brace
r_int
r_int
id|sum
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Assume unsigned long is &gt;16 bits */
r_int
r_char
op_star
id|data
op_assign
(paren
r_int
r_char
op_star
)paren
id|ddp
suffix:semicolon
id|len
op_sub_assign
l_int|4
suffix:semicolon
multiline_comment|/* skip header 4 bytes */
id|data
op_add_assign
l_int|4
suffix:semicolon
multiline_comment|/* This ought to be unwrapped neatly. I&squot;ll trust gcc for now */
r_while
c_loop
(paren
id|len
op_decrement
)paren
(brace
id|sum
op_add_assign
op_star
id|data
suffix:semicolon
id|sum
op_lshift_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|sum
op_amp
l_int|0x10000
)paren
(brace
id|sum
op_increment
suffix:semicolon
id|sum
op_and_assign
l_int|0xFFFF
suffix:semicolon
)brace
id|data
op_increment
suffix:semicolon
)brace
r_if
c_cond
(paren
id|sum
)paren
(brace
r_return
id|htons
c_func
(paren
(paren
r_int
r_int
)paren
id|sum
)paren
suffix:semicolon
)brace
r_return
l_int|0xFFFF
suffix:semicolon
multiline_comment|/* Use 0xFFFF for 0. 0 itself means none */
)brace
multiline_comment|/*&n; *&t;Generic fcntl calls are already dealt with. If we don&squot;t need funny ones&n; *&t;this is the all you need. Async I/O is also seperate.&n; */
DECL|function|atalk_fcntl
r_static
r_int
id|atalk_fcntl
c_func
(paren
r_struct
id|socket
op_star
id|sock
comma
r_int
r_int
id|cmd
comma
r_int
r_int
id|arg
)paren
(brace
multiline_comment|/*&t;atalk_socket *sk=(atalk_socket *)sock-&gt;data;*/
r_switch
c_cond
(paren
id|cmd
)paren
(brace
r_default
suffix:colon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
)brace
multiline_comment|/*&n; *&t;Set &squot;magic&squot; options for appletalk. If we don&squot;t have any this is fine &n; *&t;as it is.&n; */
DECL|function|atalk_setsockopt
r_static
r_int
id|atalk_setsockopt
c_func
(paren
r_struct
id|socket
op_star
id|sock
comma
r_int
id|level
comma
r_int
id|optname
comma
r_char
op_star
id|optval
comma
r_int
id|optlen
)paren
(brace
id|atalk_socket
op_star
id|sk
suffix:semicolon
r_int
id|err
comma
id|opt
suffix:semicolon
id|sk
op_assign
(paren
id|atalk_socket
op_star
)paren
id|sock-&gt;data
suffix:semicolon
r_if
c_cond
(paren
id|optval
op_eq
l_int|NULL
)paren
(brace
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|err
op_assign
id|verify_area
c_func
(paren
id|VERIFY_READ
comma
id|optval
comma
r_sizeof
(paren
r_int
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
(brace
r_return
id|err
suffix:semicolon
)brace
id|opt
op_assign
id|get_fs_long
c_func
(paren
(paren
r_int
r_int
op_star
)paren
id|optval
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|level
)paren
(brace
r_case
id|SOL_ATALK
suffix:colon
r_switch
c_cond
(paren
id|optname
)paren
(brace
r_default
suffix:colon
r_return
op_minus
id|EOPNOTSUPP
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|SOL_SOCKET
suffix:colon
r_return
id|sock_setsockopt
c_func
(paren
id|sk
comma
id|level
comma
id|optname
comma
id|optval
comma
id|optlen
)paren
suffix:semicolon
r_default
suffix:colon
r_return
op_minus
id|EOPNOTSUPP
suffix:semicolon
)brace
)brace
multiline_comment|/*&n; *&t;Get any magic options. Comment above applies.&n; */
DECL|function|atalk_getsockopt
r_static
r_int
id|atalk_getsockopt
c_func
(paren
r_struct
id|socket
op_star
id|sock
comma
r_int
id|level
comma
r_int
id|optname
comma
r_char
op_star
id|optval
comma
r_int
op_star
id|optlen
)paren
(brace
id|atalk_socket
op_star
id|sk
suffix:semicolon
r_int
id|val
op_assign
l_int|0
suffix:semicolon
r_int
id|err
suffix:semicolon
id|sk
op_assign
(paren
id|atalk_socket
op_star
)paren
id|sock-&gt;data
suffix:semicolon
r_switch
c_cond
(paren
id|level
)paren
(brace
r_case
id|SOL_ATALK
suffix:colon
r_switch
c_cond
(paren
id|optname
)paren
(brace
r_default
suffix:colon
r_return
op_minus
id|ENOPROTOOPT
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|SOL_SOCKET
suffix:colon
r_return
id|sock_getsockopt
c_func
(paren
id|sk
comma
id|level
comma
id|optname
comma
id|optval
comma
id|optlen
)paren
suffix:semicolon
r_default
suffix:colon
r_return
op_minus
id|EOPNOTSUPP
suffix:semicolon
)brace
id|err
op_assign
id|verify_area
c_func
(paren
id|VERIFY_WRITE
comma
id|optlen
comma
r_sizeof
(paren
r_int
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
(brace
r_return
id|err
suffix:semicolon
)brace
id|put_user
c_func
(paren
r_sizeof
(paren
r_int
)paren
comma
id|optlen
)paren
suffix:semicolon
id|err
op_assign
id|verify_area
c_func
(paren
id|VERIFY_WRITE
comma
id|optval
comma
r_sizeof
(paren
r_int
)paren
)paren
suffix:semicolon
id|put_user
c_func
(paren
id|val
comma
id|optval
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;Only for connection oriented sockets - ignore&n; */
DECL|function|atalk_listen
r_static
r_int
id|atalk_listen
c_func
(paren
r_struct
id|socket
op_star
id|sock
comma
r_int
id|backlog
)paren
(brace
r_return
op_minus
id|EOPNOTSUPP
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;These are standard.&n; */
DECL|function|def_callback1
r_static
r_void
id|def_callback1
c_func
(paren
r_struct
id|sock
op_star
id|sk
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|sk-&gt;dead
)paren
(brace
id|wake_up_interruptible
c_func
(paren
id|sk-&gt;sleep
)paren
suffix:semicolon
)brace
)brace
DECL|function|def_callback2
r_static
r_void
id|def_callback2
c_func
(paren
r_struct
id|sock
op_star
id|sk
comma
r_int
id|len
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|sk-&gt;dead
)paren
(brace
id|wake_up_interruptible
c_func
(paren
id|sk-&gt;sleep
)paren
suffix:semicolon
id|sock_wake_async
c_func
(paren
id|sk-&gt;socket
comma
l_int|0
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/*&n; *&t;Create a socket. Initialise the socket, blank the addresses&n; *&t;set the state.&n; */
DECL|function|atalk_create
r_static
r_int
id|atalk_create
c_func
(paren
r_struct
id|socket
op_star
id|sock
comma
r_int
id|protocol
)paren
(brace
id|atalk_socket
op_star
id|sk
suffix:semicolon
id|sk
op_assign
(paren
id|atalk_socket
op_star
)paren
id|kmalloc
c_func
(paren
r_sizeof
(paren
op_star
id|sk
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sk
op_eq
l_int|NULL
)paren
(brace
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
r_switch
c_cond
(paren
id|sock-&gt;type
)paren
(brace
multiline_comment|/* This RAW is an extension. It is trivial to do and gives you&n;&t;&t;   the full ELAP frame. Should be handy for CAP 8) */
r_case
id|SOCK_RAW
suffix:colon
multiline_comment|/* We permit DDP datagram sockets */
r_case
id|SOCK_DGRAM
suffix:colon
r_break
suffix:semicolon
r_default
suffix:colon
id|kfree_s
c_func
(paren
(paren
r_void
op_star
)paren
id|sk
comma
r_sizeof
(paren
op_star
id|sk
)paren
)paren
suffix:semicolon
r_return
op_minus
id|ESOCKTNOSUPPORT
suffix:semicolon
)brace
id|sk-&gt;dead
op_assign
l_int|0
suffix:semicolon
id|sk-&gt;next
op_assign
l_int|NULL
suffix:semicolon
id|sk-&gt;broadcast
op_assign
l_int|0
suffix:semicolon
id|sk-&gt;no_check
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Checksums on by default */
id|sk-&gt;rcvbuf
op_assign
id|SK_RMEM_MAX
suffix:semicolon
id|sk-&gt;sndbuf
op_assign
id|SK_WMEM_MAX
suffix:semicolon
id|sk-&gt;pair
op_assign
l_int|NULL
suffix:semicolon
id|sk-&gt;wmem_alloc
op_assign
l_int|0
suffix:semicolon
id|sk-&gt;rmem_alloc
op_assign
l_int|0
suffix:semicolon
id|sk-&gt;inuse
op_assign
l_int|0
suffix:semicolon
id|sk-&gt;proc
op_assign
l_int|0
suffix:semicolon
id|sk-&gt;priority
op_assign
l_int|1
suffix:semicolon
id|sk-&gt;shutdown
op_assign
l_int|0
suffix:semicolon
id|sk-&gt;prot
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/* So we use default free mechanisms */
id|sk-&gt;broadcast
op_assign
l_int|0
suffix:semicolon
id|sk-&gt;err
op_assign
l_int|0
suffix:semicolon
id|skb_queue_head_init
c_func
(paren
op_amp
id|sk-&gt;receive_queue
)paren
suffix:semicolon
id|skb_queue_head_init
c_func
(paren
op_amp
id|sk-&gt;write_queue
)paren
suffix:semicolon
id|sk-&gt;send_head
op_assign
l_int|NULL
suffix:semicolon
id|skb_queue_head_init
c_func
(paren
op_amp
id|sk-&gt;back_log
)paren
suffix:semicolon
id|sk-&gt;state
op_assign
id|TCP_CLOSE
suffix:semicolon
id|sk-&gt;socket
op_assign
id|sock
suffix:semicolon
id|sk-&gt;type
op_assign
id|sock-&gt;type
suffix:semicolon
id|sk-&gt;debug
op_assign
l_int|0
suffix:semicolon
id|sk-&gt;at.src_net
op_assign
l_int|0
suffix:semicolon
id|sk-&gt;at.src_node
op_assign
l_int|0
suffix:semicolon
id|sk-&gt;at.src_port
op_assign
l_int|0
suffix:semicolon
id|sk-&gt;at.dest_net
op_assign
l_int|0
suffix:semicolon
id|sk-&gt;at.dest_node
op_assign
l_int|0
suffix:semicolon
id|sk-&gt;at.dest_port
op_assign
l_int|0
suffix:semicolon
id|sk-&gt;mtu
op_assign
id|DDP_MAXSZ
suffix:semicolon
r_if
c_cond
(paren
id|sock
op_ne
l_int|NULL
)paren
(brace
id|sock-&gt;data
op_assign
(paren
r_void
op_star
)paren
id|sk
suffix:semicolon
id|sk-&gt;sleep
op_assign
id|sock-&gt;wait
suffix:semicolon
)brace
id|sk-&gt;state_change
op_assign
id|def_callback1
suffix:semicolon
id|sk-&gt;data_ready
op_assign
id|def_callback2
suffix:semicolon
id|sk-&gt;write_space
op_assign
id|def_callback1
suffix:semicolon
id|sk-&gt;error_report
op_assign
id|def_callback1
suffix:semicolon
id|sk-&gt;zapped
op_assign
l_int|1
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;Copy a socket. No work needed.&n; */
DECL|function|atalk_dup
r_static
r_int
id|atalk_dup
c_func
(paren
r_struct
id|socket
op_star
id|newsock
comma
r_struct
id|socket
op_star
id|oldsock
)paren
(brace
r_return
id|atalk_create
c_func
(paren
id|newsock
comma
id|SOCK_DGRAM
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;Free a socket. No work needed&n; */
DECL|function|atalk_release
r_static
r_int
id|atalk_release
c_func
(paren
r_struct
id|socket
op_star
id|sock
comma
r_struct
id|socket
op_star
id|peer
)paren
(brace
id|atalk_socket
op_star
id|sk
op_assign
(paren
id|atalk_socket
op_star
)paren
id|sock-&gt;data
suffix:semicolon
r_if
c_cond
(paren
id|sk
op_eq
l_int|NULL
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|sk-&gt;dead
)paren
(brace
id|sk
op_member_access_from_pointer
id|state_change
c_func
(paren
id|sk
)paren
suffix:semicolon
)brace
id|sk-&gt;dead
op_assign
l_int|1
suffix:semicolon
id|sock-&gt;data
op_assign
l_int|NULL
suffix:semicolon
id|atalk_destroy_socket
c_func
(paren
id|sk
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;Pick a source address if one is not given. Just return&n; *&t;an error if not supportable.&n; */
DECL|function|atalk_pick_port
r_static
r_int
id|atalk_pick_port
c_func
(paren
r_struct
id|sockaddr_at
op_star
id|sat
)paren
(brace
r_for
c_loop
(paren
id|sat-&gt;sat_port
op_assign
id|ATPORT_RESERVED
suffix:semicolon
id|sat-&gt;sat_port
OL
id|ATPORT_LAST
suffix:semicolon
id|sat-&gt;sat_port
op_increment
)paren
r_if
c_cond
(paren
id|atalk_find_socket
c_func
(paren
id|sat
)paren
op_eq
l_int|NULL
)paren
r_return
id|sat-&gt;sat_port
suffix:semicolon
r_return
op_minus
id|EBUSY
suffix:semicolon
)brace
DECL|function|atalk_autobind
r_static
r_int
id|atalk_autobind
c_func
(paren
id|atalk_socket
op_star
id|sk
)paren
(brace
r_struct
id|at_addr
op_star
id|ap
op_assign
id|atalk_find_primary
c_func
(paren
)paren
suffix:semicolon
r_struct
id|sockaddr_at
id|sat
suffix:semicolon
r_int
id|n
suffix:semicolon
r_if
c_cond
(paren
id|ap
op_eq
l_int|NULL
op_logical_or
id|ap-&gt;s_net
op_eq
id|htons
c_func
(paren
id|ATADDR_ANYNET
)paren
)paren
r_return
op_minus
id|EADDRNOTAVAIL
suffix:semicolon
id|sk-&gt;at.src_net
op_assign
id|sat.sat_addr.s_net
op_assign
id|ap-&gt;s_net
suffix:semicolon
id|sk-&gt;at.src_node
op_assign
id|sat.sat_addr.s_node
op_assign
id|ap-&gt;s_node
suffix:semicolon
r_if
c_cond
(paren
(paren
id|n
op_assign
id|atalk_pick_port
c_func
(paren
op_amp
id|sat
)paren
)paren
OL
l_int|0
)paren
r_return
id|n
suffix:semicolon
id|sk-&gt;at.src_port
op_assign
id|n
suffix:semicolon
id|atalk_insert_socket
c_func
(paren
id|sk
)paren
suffix:semicolon
id|sk-&gt;zapped
op_assign
l_int|0
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;Set the address &squot;our end&squot; of the connection.&n; */
DECL|function|atalk_bind
r_static
r_int
id|atalk_bind
c_func
(paren
r_struct
id|socket
op_star
id|sock
comma
r_struct
id|sockaddr
op_star
id|uaddr
comma
r_int
id|addr_len
)paren
(brace
id|atalk_socket
op_star
id|sk
suffix:semicolon
r_struct
id|sockaddr_at
op_star
id|addr
op_assign
(paren
r_struct
id|sockaddr_at
op_star
)paren
id|uaddr
suffix:semicolon
id|sk
op_assign
(paren
id|atalk_socket
op_star
)paren
id|sock-&gt;data
suffix:semicolon
r_if
c_cond
(paren
id|sk-&gt;zapped
op_eq
l_int|0
)paren
(brace
r_return
op_minus
id|EIO
suffix:semicolon
)brace
r_if
c_cond
(paren
id|addr_len
op_ne
r_sizeof
(paren
r_struct
id|sockaddr_at
)paren
)paren
(brace
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|addr-&gt;sat_family
op_ne
id|AF_APPLETALK
)paren
(brace
r_return
op_minus
id|EAFNOSUPPORT
suffix:semicolon
)brace
r_if
c_cond
(paren
id|addr-&gt;sat_addr.s_net
op_eq
id|htons
c_func
(paren
id|ATADDR_ANYNET
)paren
)paren
(brace
r_struct
id|at_addr
op_star
id|ap
op_assign
id|atalk_find_primary
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ap
op_eq
l_int|NULL
)paren
(brace
r_return
op_minus
id|EADDRNOTAVAIL
suffix:semicolon
)brace
id|sk-&gt;at.src_net
op_assign
id|addr-&gt;sat_addr.s_net
op_assign
id|ap-&gt;s_net
suffix:semicolon
id|sk-&gt;at.src_node
op_assign
id|addr-&gt;sat_addr.s_node
op_assign
id|ap-&gt;s_node
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|atalk_find_interface
c_func
(paren
id|addr-&gt;sat_addr.s_net
comma
id|addr-&gt;sat_addr.s_node
)paren
op_eq
l_int|NULL
)paren
r_return
op_minus
id|EADDRNOTAVAIL
suffix:semicolon
id|sk-&gt;at.src_net
op_assign
id|addr-&gt;sat_addr.s_net
suffix:semicolon
id|sk-&gt;at.src_node
op_assign
id|addr-&gt;sat_addr.s_node
suffix:semicolon
)brace
r_if
c_cond
(paren
id|addr-&gt;sat_port
op_eq
id|ATADDR_ANYPORT
)paren
(brace
r_int
id|n
op_assign
id|atalk_pick_port
c_func
(paren
id|addr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|n
OL
l_int|0
)paren
(brace
r_return
id|n
suffix:semicolon
)brace
id|sk-&gt;at.src_port
op_assign
id|addr-&gt;sat_port
op_assign
id|n
suffix:semicolon
)brace
r_else
id|sk-&gt;at.src_port
op_assign
id|addr-&gt;sat_port
suffix:semicolon
r_if
c_cond
(paren
id|atalk_find_socket
c_func
(paren
id|addr
)paren
op_ne
l_int|NULL
)paren
(brace
r_return
op_minus
id|EADDRINUSE
suffix:semicolon
)brace
id|atalk_insert_socket
c_func
(paren
id|sk
)paren
suffix:semicolon
id|sk-&gt;zapped
op_assign
l_int|0
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;Set the address we talk to.&n; */
DECL|function|atalk_connect
r_static
r_int
id|atalk_connect
c_func
(paren
r_struct
id|socket
op_star
id|sock
comma
r_struct
id|sockaddr
op_star
id|uaddr
comma
r_int
id|addr_len
comma
r_int
id|flags
)paren
(brace
id|atalk_socket
op_star
id|sk
op_assign
(paren
id|atalk_socket
op_star
)paren
id|sock-&gt;data
suffix:semicolon
r_struct
id|sockaddr_at
op_star
id|addr
suffix:semicolon
id|sk-&gt;state
op_assign
id|TCP_CLOSE
suffix:semicolon
id|sock-&gt;state
op_assign
id|SS_UNCONNECTED
suffix:semicolon
r_if
c_cond
(paren
id|addr_len
op_ne
r_sizeof
(paren
op_star
id|addr
)paren
)paren
(brace
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|addr
op_assign
(paren
r_struct
id|sockaddr_at
op_star
)paren
id|uaddr
suffix:semicolon
r_if
c_cond
(paren
id|addr-&gt;sat_family
op_ne
id|AF_APPLETALK
)paren
(brace
r_return
op_minus
id|EAFNOSUPPORT
suffix:semicolon
)brace
macro_line|#if 0 &t;/* Netatalk doesnt check this */
r_if
c_cond
(paren
id|addr-&gt;sat_addr.s_node
op_eq
id|ATADDR_BCAST
op_logical_and
op_logical_neg
id|sk-&gt;broadcast
)paren
(brace
r_return
op_minus
id|EPERM
suffix:semicolon
)brace
macro_line|#endif&t;&t;
r_if
c_cond
(paren
id|sk-&gt;zapped
)paren
(brace
r_if
c_cond
(paren
id|atalk_autobind
c_func
(paren
id|sk
)paren
OL
l_int|0
)paren
(brace
r_return
op_minus
id|EBUSY
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|atrtr_get_dev
c_func
(paren
op_amp
id|addr-&gt;sat_addr
)paren
op_eq
l_int|NULL
)paren
(brace
r_return
op_minus
id|ENETUNREACH
suffix:semicolon
)brace
id|sk-&gt;at.dest_port
op_assign
id|addr-&gt;sat_port
suffix:semicolon
id|sk-&gt;at.dest_net
op_assign
id|addr-&gt;sat_addr.s_net
suffix:semicolon
id|sk-&gt;at.dest_node
op_assign
id|addr-&gt;sat_addr.s_node
suffix:semicolon
id|sock-&gt;state
op_assign
id|SS_CONNECTED
suffix:semicolon
id|sk-&gt;state
op_assign
id|TCP_ESTABLISHED
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;Not relevant&n; */
DECL|function|atalk_socketpair
r_static
r_int
id|atalk_socketpair
c_func
(paren
r_struct
id|socket
op_star
id|sock1
comma
r_struct
id|socket
op_star
id|sock2
)paren
(brace
r_return
op_minus
id|EOPNOTSUPP
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;Not relevant&n; */
DECL|function|atalk_accept
r_static
r_int
id|atalk_accept
c_func
(paren
r_struct
id|socket
op_star
id|sock
comma
r_struct
id|socket
op_star
id|newsock
comma
r_int
id|flags
)paren
(brace
r_if
c_cond
(paren
id|newsock-&gt;data
)paren
(brace
id|kfree_s
c_func
(paren
id|newsock-&gt;data
comma
r_sizeof
(paren
id|atalk_socket
)paren
)paren
suffix:semicolon
)brace
r_return
op_minus
id|EOPNOTSUPP
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;Find the name of an appletalk socket. Just copy the right&n; *&t;fields into the sockaddr.&n; */
DECL|function|atalk_getname
r_static
r_int
id|atalk_getname
c_func
(paren
r_struct
id|socket
op_star
id|sock
comma
r_struct
id|sockaddr
op_star
id|uaddr
comma
r_int
op_star
id|uaddr_len
comma
r_int
id|peer
)paren
(brace
r_struct
id|sockaddr_at
id|sat
suffix:semicolon
id|atalk_socket
op_star
id|sk
suffix:semicolon
id|sk
op_assign
(paren
id|atalk_socket
op_star
)paren
id|sock-&gt;data
suffix:semicolon
r_if
c_cond
(paren
id|sk-&gt;zapped
)paren
(brace
r_if
c_cond
(paren
id|atalk_autobind
c_func
(paren
id|sk
)paren
OL
l_int|0
)paren
(brace
r_return
op_minus
id|EBUSY
suffix:semicolon
)brace
)brace
op_star
id|uaddr_len
op_assign
r_sizeof
(paren
r_struct
id|sockaddr_at
)paren
suffix:semicolon
r_if
c_cond
(paren
id|peer
)paren
(brace
r_if
c_cond
(paren
id|sk-&gt;state
op_ne
id|TCP_ESTABLISHED
)paren
(brace
r_return
op_minus
id|ENOTCONN
suffix:semicolon
)brace
id|sat.sat_addr.s_net
op_assign
id|sk-&gt;at.dest_net
suffix:semicolon
id|sat.sat_addr.s_node
op_assign
id|sk-&gt;at.dest_node
suffix:semicolon
id|sat.sat_port
op_assign
id|sk-&gt;at.dest_port
suffix:semicolon
)brace
r_else
(brace
id|sat.sat_addr.s_net
op_assign
id|sk-&gt;at.src_net
suffix:semicolon
id|sat.sat_addr.s_node
op_assign
id|sk-&gt;at.src_node
suffix:semicolon
id|sat.sat_port
op_assign
id|sk-&gt;at.src_port
suffix:semicolon
)brace
id|sat.sat_family
op_assign
id|AF_APPLETALK
suffix:semicolon
id|memcpy
c_func
(paren
id|uaddr
comma
op_amp
id|sat
comma
r_sizeof
(paren
id|sat
)paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;Receive a packet (in skb) from device dev. This has come from the SNAP decoder, and on entry&n; *&t;skb-&gt;h.raw is the DDP header, skb-&gt;len is the DDP length. The physical headers have been &n; *&t;extracted.&n; */
DECL|function|atalk_rcv
r_int
id|atalk_rcv
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|device
op_star
id|dev
comma
r_struct
id|packet_type
op_star
id|pt
)paren
(brace
id|atalk_socket
op_star
id|sock
suffix:semicolon
r_struct
id|ddpehdr
op_star
id|ddp
op_assign
(paren
r_void
op_star
)paren
id|skb-&gt;h.raw
suffix:semicolon
r_struct
id|atalk_iface
op_star
id|atif
suffix:semicolon
r_struct
id|sockaddr_at
id|tosat
suffix:semicolon
multiline_comment|/* Size check */
r_if
c_cond
(paren
id|skb-&gt;len
OL
r_sizeof
(paren
op_star
id|ddp
)paren
)paren
(brace
id|kfree_skb
c_func
(paren
id|skb
comma
id|FREE_READ
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n;&t; *&t;Fix up the length field&t;[Ok this is horrible but otherwise&n;&t; *&t;I end up with unions of bit fields and messy bit field order&n;&t; *&t;compiler/endian dependancies..]&n;&t; */
op_star
(paren
(paren
id|__u16
op_star
)paren
id|ddp
)paren
op_assign
id|ntohs
c_func
(paren
op_star
(paren
(paren
id|__u16
op_star
)paren
id|ddp
)paren
)paren
suffix:semicolon
multiline_comment|/*&n;&t; *&t;Trim buffer in case of stray trailing data&n;&t; */
id|skb-&gt;len
op_assign
id|min
c_func
(paren
id|skb-&gt;len
comma
id|ddp-&gt;deh_len
)paren
suffix:semicolon
multiline_comment|/*&n;&t; *&t;Size check to see if ddp-&gt;deh_len was crap&n;&t; *&t;(Otherwise we&squot;ll detonate most spectacularly&n;&t; *&t; in the middle of recvfrom()).&n;&t; */
r_if
c_cond
(paren
id|skb-&gt;len
OL
r_sizeof
(paren
op_star
id|ddp
)paren
)paren
(brace
id|kfree_skb
c_func
(paren
id|skb
comma
id|FREE_READ
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n;&t; *&t;Any checksums. Note we don&squot;t do htons() on this == is assumed to be&n;&t; *&t;valid for net byte orders all over the networking code... &n;&t; */
r_if
c_cond
(paren
id|ddp-&gt;deh_sum
op_logical_and
id|atalk_checksum
c_func
(paren
id|ddp
comma
id|ddp-&gt;deh_len
)paren
op_ne
id|ddp-&gt;deh_sum
)paren
(brace
multiline_comment|/* Not a valid appletalk frame - dustbin time */
id|kfree_skb
c_func
(paren
id|skb
comma
id|FREE_READ
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Check the packet is aimed at us */
r_if
c_cond
(paren
id|ddp-&gt;deh_dnet
op_eq
l_int|0
)paren
(brace
multiline_comment|/* Net 0 is &squot;this network&squot; */
id|atif
op_assign
id|atalk_find_anynet
c_func
(paren
id|ddp-&gt;deh_dnode
comma
id|dev
)paren
suffix:semicolon
)brace
r_else
id|atif
op_assign
id|atalk_find_interface
c_func
(paren
id|ddp-&gt;deh_dnet
comma
id|ddp-&gt;deh_dnode
)paren
suffix:semicolon
multiline_comment|/* Not ours */
r_if
c_cond
(paren
id|atif
op_eq
l_int|NULL
)paren
(brace
r_struct
id|atalk_route
op_star
id|rt
suffix:semicolon
r_struct
id|at_addr
id|ta
suffix:semicolon
id|ta.s_net
op_assign
id|ddp-&gt;deh_dnet
suffix:semicolon
id|ta.s_node
op_assign
id|ddp-&gt;deh_dnode
suffix:semicolon
multiline_comment|/* Route the packet */
id|rt
op_assign
id|atrtr_find
c_func
(paren
op_amp
id|ta
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rt
op_eq
l_int|NULL
op_logical_or
id|ddp-&gt;deh_hops
op_eq
l_int|15
)paren
(brace
id|kfree_skb
c_func
(paren
id|skb
comma
id|FREE_READ
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|ddp-&gt;deh_hops
op_increment
suffix:semicolon
op_star
(paren
(paren
id|__u16
op_star
)paren
id|ddp
)paren
op_assign
id|ntohs
c_func
(paren
op_star
(paren
(paren
id|__u16
op_star
)paren
id|ddp
)paren
)paren
suffix:semicolon
multiline_comment|/* Mend the byte order */
multiline_comment|/*&n;&t;&t; *&t;Send the buffer onwards&n;&t;&t; */
r_if
c_cond
(paren
id|aarp_send_ddp
c_func
(paren
id|dev
comma
id|skb
comma
op_amp
id|ta
comma
l_int|NULL
)paren
op_eq
op_minus
l_int|1
)paren
(brace
id|kfree_skb
c_func
(paren
id|skb
comma
id|FREE_READ
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Which socket - atalk_search_socket() looks for a *full match*&n;&t;   of the &lt;net,node,port&gt; tuple */
id|tosat.sat_addr.s_net
op_assign
id|ddp-&gt;deh_dnet
suffix:semicolon
id|tosat.sat_addr.s_node
op_assign
id|ddp-&gt;deh_dnode
suffix:semicolon
id|tosat.sat_port
op_assign
id|ddp-&gt;deh_dport
suffix:semicolon
id|sock
op_assign
id|atalk_search_socket
c_func
(paren
op_amp
id|tosat
comma
id|atif
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sock
op_eq
l_int|NULL
)paren
multiline_comment|/* But not one of our sockets */
(brace
id|kfree_skb
c_func
(paren
id|skb
comma
id|FREE_READ
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n;&t; *&t;Queue packet (standard)&n;&t; */
id|skb-&gt;sk
op_assign
id|sock
suffix:semicolon
r_if
c_cond
(paren
id|sock_queue_rcv_skb
c_func
(paren
id|sock
comma
id|skb
)paren
OL
l_int|0
)paren
(brace
id|skb-&gt;sk
op_assign
l_int|NULL
suffix:semicolon
id|kfree_skb
c_func
(paren
id|skb
comma
id|FREE_WRITE
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|atalk_sendto
r_static
r_int
id|atalk_sendto
c_func
(paren
r_struct
id|socket
op_star
id|sock
comma
r_void
op_star
id|ubuf
comma
r_int
id|len
comma
r_int
id|noblock
comma
r_int
id|flags
comma
r_struct
id|sockaddr
op_star
id|sat
comma
r_int
id|addr_len
)paren
(brace
id|atalk_socket
op_star
id|sk
op_assign
(paren
id|atalk_socket
op_star
)paren
id|sock-&gt;data
suffix:semicolon
r_struct
id|sockaddr_at
op_star
id|usat
op_assign
(paren
r_struct
id|sockaddr_at
op_star
)paren
id|sat
suffix:semicolon
r_struct
id|sockaddr_at
id|local_satalk
comma
id|gsat
suffix:semicolon
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
r_struct
id|device
op_star
id|dev
suffix:semicolon
r_struct
id|ddpehdr
op_star
id|ddp
suffix:semicolon
r_int
id|size
suffix:semicolon
r_struct
id|atalk_route
op_star
id|rt
suffix:semicolon
r_int
id|loopback
op_assign
l_int|0
suffix:semicolon
r_int
id|err
suffix:semicolon
r_if
c_cond
(paren
id|flags
)paren
(brace
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|len
OG
l_int|587
)paren
(brace
r_return
op_minus
id|EMSGSIZE
suffix:semicolon
)brace
r_if
c_cond
(paren
id|usat
)paren
(brace
r_if
c_cond
(paren
id|sk-&gt;zapped
)paren
multiline_comment|/* put the autobinding in */
(brace
r_if
c_cond
(paren
id|atalk_autobind
c_func
(paren
id|sk
)paren
OL
l_int|0
)paren
(brace
r_return
op_minus
id|EBUSY
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|addr_len
OL
r_sizeof
(paren
op_star
id|usat
)paren
)paren
(brace
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|usat-&gt;sat_family
op_ne
id|AF_APPLETALK
)paren
(brace
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
macro_line|#if 0 &t;/* netatalk doesnt implement this check */
r_if
c_cond
(paren
id|usat-&gt;sat_addr.s_node
op_eq
id|ATADDR_BCAST
op_logical_and
op_logical_neg
id|sk-&gt;broadcast
)paren
(brace
r_return
op_minus
id|EPERM
suffix:semicolon
)brace
macro_line|#endif&t;&t;&t;
)brace
r_else
(brace
r_if
c_cond
(paren
id|sk-&gt;state
op_ne
id|TCP_ESTABLISHED
)paren
(brace
r_return
op_minus
id|ENOTCONN
suffix:semicolon
)brace
id|usat
op_assign
op_amp
id|local_satalk
suffix:semicolon
id|usat-&gt;sat_family
op_assign
id|AF_APPLETALK
suffix:semicolon
id|usat-&gt;sat_port
op_assign
id|sk-&gt;at.dest_port
suffix:semicolon
id|usat-&gt;sat_addr.s_node
op_assign
id|sk-&gt;at.dest_node
suffix:semicolon
id|usat-&gt;sat_addr.s_net
op_assign
id|sk-&gt;at.dest_net
suffix:semicolon
)brace
multiline_comment|/* Build a packet */
r_if
c_cond
(paren
id|sk-&gt;debug
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;SK %p: Got address.&bslash;n&quot;
comma
id|sk
)paren
suffix:semicolon
)brace
id|size
op_assign
r_sizeof
(paren
r_struct
id|ddpehdr
)paren
op_plus
id|len
op_plus
id|ddp_dl-&gt;header_length
suffix:semicolon
multiline_comment|/* For headers */
r_if
c_cond
(paren
id|usat-&gt;sat_addr.s_net
op_ne
l_int|0
op_logical_or
id|usat-&gt;sat_addr.s_node
op_eq
id|ATADDR_ANYNODE
)paren
(brace
id|rt
op_assign
id|atrtr_find
c_func
(paren
op_amp
id|usat-&gt;sat_addr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rt
op_eq
l_int|NULL
)paren
(brace
r_return
op_minus
id|ENETUNREACH
suffix:semicolon
)brace
id|dev
op_assign
id|rt-&gt;dev
suffix:semicolon
)brace
r_else
(brace
r_struct
id|at_addr
id|at_hint
suffix:semicolon
id|at_hint.s_node
op_assign
l_int|0
suffix:semicolon
id|at_hint.s_net
op_assign
id|sk-&gt;at.src_net
suffix:semicolon
id|rt
op_assign
id|atrtr_find
c_func
(paren
op_amp
id|at_hint
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rt
op_eq
l_int|NULL
)paren
(brace
r_return
op_minus
id|ENETUNREACH
suffix:semicolon
)brace
id|dev
op_assign
id|rt-&gt;dev
suffix:semicolon
)brace
r_if
c_cond
(paren
id|sk-&gt;debug
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;SK %p: Size needed %d, device %s&bslash;n&quot;
comma
id|sk
comma
id|size
comma
id|dev-&gt;name
)paren
suffix:semicolon
)brace
id|size
op_add_assign
id|dev-&gt;hard_header_len
suffix:semicolon
id|skb
op_assign
id|sock_alloc_send_skb
c_func
(paren
id|sk
comma
id|size
comma
l_int|0
comma
op_amp
id|err
)paren
suffix:semicolon
r_if
c_cond
(paren
id|skb
op_eq
l_int|NULL
)paren
(brace
r_return
id|err
suffix:semicolon
)brace
id|skb-&gt;sk
op_assign
id|sk
suffix:semicolon
id|skb-&gt;free
op_assign
l_int|1
suffix:semicolon
id|skb-&gt;arp
op_assign
l_int|1
suffix:semicolon
id|skb-&gt;len
op_assign
id|size
suffix:semicolon
id|skb-&gt;dev
op_assign
id|dev
suffix:semicolon
r_if
c_cond
(paren
id|sk-&gt;debug
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;SK %p: Begin build.&bslash;n&quot;
comma
id|sk
)paren
suffix:semicolon
)brace
id|skb-&gt;h.raw
op_assign
id|skb-&gt;data
op_plus
id|ddp_dl-&gt;header_length
op_plus
id|dev-&gt;hard_header_len
suffix:semicolon
id|ddp
op_assign
(paren
r_struct
id|ddpehdr
op_star
)paren
id|skb-&gt;h.raw
suffix:semicolon
id|ddp-&gt;deh_pad
op_assign
l_int|0
suffix:semicolon
id|ddp-&gt;deh_hops
op_assign
l_int|0
suffix:semicolon
id|ddp-&gt;deh_len
op_assign
id|len
op_plus
r_sizeof
(paren
op_star
id|ddp
)paren
suffix:semicolon
multiline_comment|/*&n;&t; *&t;Fix up the length field&t;[Ok this is horrible but otherwise&n;&t; *&t;I end up with unions of bit fields and messy bit field order&n;&t; *&t;compiler/endian dependancies..&n;&t; */
op_star
(paren
(paren
id|__u16
op_star
)paren
id|ddp
)paren
op_assign
id|ntohs
c_func
(paren
op_star
(paren
(paren
id|__u16
op_star
)paren
id|ddp
)paren
)paren
suffix:semicolon
id|ddp-&gt;deh_dnet
op_assign
id|usat-&gt;sat_addr.s_net
suffix:semicolon
id|ddp-&gt;deh_snet
op_assign
id|sk-&gt;at.src_net
suffix:semicolon
id|ddp-&gt;deh_dnode
op_assign
id|usat-&gt;sat_addr.s_node
suffix:semicolon
id|ddp-&gt;deh_snode
op_assign
id|sk-&gt;at.src_node
suffix:semicolon
id|ddp-&gt;deh_dport
op_assign
id|usat-&gt;sat_port
suffix:semicolon
id|ddp-&gt;deh_sport
op_assign
id|sk-&gt;at.src_port
suffix:semicolon
r_if
c_cond
(paren
id|sk-&gt;debug
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;SK %p: Copy user data (%d bytes).&bslash;n&quot;
comma
id|sk
comma
id|len
)paren
suffix:semicolon
)brace
id|memcpy_fromfs
c_func
(paren
(paren
r_char
op_star
)paren
(paren
id|ddp
op_plus
l_int|1
)paren
comma
id|ubuf
comma
id|len
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sk-&gt;no_check
op_eq
l_int|1
)paren
(brace
id|ddp-&gt;deh_sum
op_assign
l_int|0
suffix:semicolon
)brace
r_else
id|ddp-&gt;deh_sum
op_assign
id|atalk_checksum
c_func
(paren
id|ddp
comma
id|len
op_plus
r_sizeof
(paren
op_star
id|ddp
)paren
)paren
suffix:semicolon
multiline_comment|/*&n;&t; *&t;Loopback broadcast packets to non gateway targets (ie routes&n;&t; *&t;to group we are in)&n;&t; */
r_if
c_cond
(paren
id|ddp-&gt;deh_dnode
op_eq
id|ATADDR_BCAST
)paren
(brace
r_if
c_cond
(paren
(paren
op_logical_neg
(paren
id|rt-&gt;flags
op_amp
id|RTF_GATEWAY
)paren
)paren
op_logical_and
(paren
op_logical_neg
(paren
id|dev-&gt;flags
op_amp
id|IFF_LOOPBACK
)paren
)paren
)paren
(brace
r_struct
id|sk_buff
op_star
id|skb2
op_assign
id|skb_clone
c_func
(paren
id|skb
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|skb2
)paren
(brace
id|loopback
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|sk-&gt;debug
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;SK %p: send out(copy).&bslash;n&quot;
comma
id|sk
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|aarp_send_ddp
c_func
(paren
id|dev
comma
id|skb2
comma
op_amp
id|usat-&gt;sat_addr
comma
l_int|NULL
)paren
op_eq
op_minus
l_int|1
)paren
(brace
id|kfree_skb
c_func
(paren
id|skb2
comma
id|FREE_WRITE
)paren
suffix:semicolon
)brace
multiline_comment|/* else queued/sent above in the aarp queue */
)brace
)brace
)brace
r_if
c_cond
(paren
(paren
id|dev-&gt;flags
op_amp
id|IFF_LOOPBACK
)paren
op_logical_or
id|loopback
)paren
(brace
r_if
c_cond
(paren
id|sk-&gt;debug
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;SK %p: Loop back.&bslash;n&quot;
comma
id|sk
)paren
suffix:semicolon
)brace
multiline_comment|/* loop back */
id|sk-&gt;wmem_alloc
op_sub_assign
id|skb-&gt;mem_len
suffix:semicolon
id|ddp_dl
op_member_access_from_pointer
id|datalink_header
c_func
(paren
id|ddp_dl
comma
id|skb
comma
id|dev-&gt;dev_addr
)paren
suffix:semicolon
id|skb-&gt;sk
op_assign
l_int|NULL
suffix:semicolon
id|skb-&gt;h.raw
op_assign
id|skb-&gt;data
op_plus
id|ddp_dl-&gt;header_length
op_plus
id|dev-&gt;hard_header_len
suffix:semicolon
id|skb-&gt;len
op_sub_assign
id|ddp_dl-&gt;header_length
suffix:semicolon
id|skb-&gt;len
op_sub_assign
id|dev-&gt;hard_header_len
suffix:semicolon
id|atalk_rcv
c_func
(paren
id|skb
comma
id|dev
comma
l_int|NULL
)paren
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|sk-&gt;debug
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;SK %p: send out.&bslash;n&quot;
comma
id|sk
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|rt-&gt;flags
op_amp
id|RTF_GATEWAY
)paren
(brace
id|gsat.sat_addr
op_assign
id|rt-&gt;gateway
suffix:semicolon
id|usat
op_assign
op_amp
id|gsat
suffix:semicolon
)brace
r_if
c_cond
(paren
id|aarp_send_ddp
c_func
(paren
id|dev
comma
id|skb
comma
op_amp
id|usat-&gt;sat_addr
comma
l_int|NULL
)paren
op_eq
op_minus
l_int|1
)paren
(brace
id|kfree_skb
c_func
(paren
id|skb
comma
id|FREE_WRITE
)paren
suffix:semicolon
)brace
multiline_comment|/* else queued/sent above in the aarp queue */
)brace
r_if
c_cond
(paren
id|sk-&gt;debug
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;SK %p: Done write (%d).&bslash;n&quot;
comma
id|sk
comma
id|len
)paren
suffix:semicolon
)brace
r_return
id|len
suffix:semicolon
)brace
DECL|function|atalk_send
r_static
r_int
id|atalk_send
c_func
(paren
r_struct
id|socket
op_star
id|sock
comma
r_void
op_star
id|ubuf
comma
r_int
id|size
comma
r_int
id|noblock
comma
r_int
id|flags
)paren
(brace
r_return
id|atalk_sendto
c_func
(paren
id|sock
comma
id|ubuf
comma
id|size
comma
id|noblock
comma
id|flags
comma
l_int|NULL
comma
l_int|0
)paren
suffix:semicolon
)brace
DECL|function|atalk_recvfrom
r_static
r_int
id|atalk_recvfrom
c_func
(paren
r_struct
id|socket
op_star
id|sock
comma
r_void
op_star
id|ubuf
comma
r_int
id|size
comma
r_int
id|noblock
comma
r_int
id|flags
comma
r_struct
id|sockaddr
op_star
id|sip
comma
r_int
op_star
id|addr_len
)paren
(brace
id|atalk_socket
op_star
id|sk
op_assign
(paren
id|atalk_socket
op_star
)paren
id|sock-&gt;data
suffix:semicolon
r_struct
id|sockaddr_at
op_star
id|sat
op_assign
(paren
r_struct
id|sockaddr_at
op_star
)paren
id|sip
suffix:semicolon
r_struct
id|ddpehdr
op_star
id|ddp
op_assign
l_int|NULL
suffix:semicolon
r_int
id|copied
op_assign
l_int|0
suffix:semicolon
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
r_int
id|er
suffix:semicolon
r_if
c_cond
(paren
id|sk-&gt;err
)paren
(brace
id|er
op_assign
op_minus
id|sk-&gt;err
suffix:semicolon
id|sk-&gt;err
op_assign
l_int|0
suffix:semicolon
r_return
id|er
suffix:semicolon
)brace
r_if
c_cond
(paren
id|addr_len
)paren
(brace
op_star
id|addr_len
op_assign
r_sizeof
(paren
op_star
id|sat
)paren
suffix:semicolon
)brace
id|skb
op_assign
id|skb_recv_datagram
c_func
(paren
id|sk
comma
id|flags
comma
id|noblock
comma
op_amp
id|er
)paren
suffix:semicolon
r_if
c_cond
(paren
id|skb
op_eq
l_int|NULL
)paren
(brace
r_return
id|er
suffix:semicolon
)brace
id|ddp
op_assign
(paren
r_struct
id|ddpehdr
op_star
)paren
(paren
id|skb-&gt;h.raw
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sk-&gt;type
op_eq
id|SOCK_RAW
)paren
(brace
id|copied
op_assign
id|ddp-&gt;deh_len
suffix:semicolon
r_if
c_cond
(paren
id|copied
OG
id|size
)paren
(brace
id|copied
op_assign
id|size
suffix:semicolon
)brace
id|skb_copy_datagram
c_func
(paren
id|skb
comma
l_int|0
comma
id|ubuf
comma
id|copied
)paren
suffix:semicolon
)brace
r_else
(brace
id|copied
op_assign
id|ddp-&gt;deh_len
op_minus
r_sizeof
(paren
op_star
id|ddp
)paren
suffix:semicolon
r_if
c_cond
(paren
id|copied
OG
id|size
)paren
id|copied
op_assign
id|size
suffix:semicolon
id|skb_copy_datagram
c_func
(paren
id|skb
comma
r_sizeof
(paren
op_star
id|ddp
)paren
comma
id|ubuf
comma
id|copied
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|sat
)paren
(brace
id|sat-&gt;sat_family
op_assign
id|AF_APPLETALK
suffix:semicolon
id|sat-&gt;sat_port
op_assign
id|ddp-&gt;deh_sport
suffix:semicolon
id|sat-&gt;sat_addr.s_node
op_assign
id|ddp-&gt;deh_snode
suffix:semicolon
id|sat-&gt;sat_addr.s_net
op_assign
id|ddp-&gt;deh_snet
suffix:semicolon
)brace
id|skb_free_datagram
c_func
(paren
id|skb
)paren
suffix:semicolon
r_return
id|copied
suffix:semicolon
)brace
DECL|function|atalk_write
r_static
r_int
id|atalk_write
c_func
(paren
r_struct
id|socket
op_star
id|sock
comma
r_char
op_star
id|ubuf
comma
r_int
id|size
comma
r_int
id|noblock
)paren
(brace
r_return
id|atalk_send
c_func
(paren
id|sock
comma
id|ubuf
comma
id|size
comma
id|noblock
comma
l_int|0
)paren
suffix:semicolon
)brace
DECL|function|atalk_recv
r_static
r_int
id|atalk_recv
c_func
(paren
r_struct
id|socket
op_star
id|sock
comma
r_void
op_star
id|ubuf
comma
r_int
id|size
comma
r_int
id|noblock
comma
r_int
id|flags
)paren
(brace
id|atalk_socket
op_star
id|sk
op_assign
(paren
id|atalk_socket
op_star
)paren
id|sock-&gt;data
suffix:semicolon
r_if
c_cond
(paren
id|sk-&gt;zapped
)paren
(brace
r_return
op_minus
id|ENOTCONN
suffix:semicolon
)brace
r_return
id|atalk_recvfrom
c_func
(paren
id|sock
comma
id|ubuf
comma
id|size
comma
id|noblock
comma
id|flags
comma
l_int|NULL
comma
l_int|NULL
)paren
suffix:semicolon
)brace
DECL|function|atalk_read
r_static
r_int
id|atalk_read
c_func
(paren
r_struct
id|socket
op_star
id|sock
comma
r_char
op_star
id|ubuf
comma
r_int
id|size
comma
r_int
id|noblock
)paren
(brace
r_return
id|atalk_recv
c_func
(paren
id|sock
comma
id|ubuf
comma
id|size
comma
id|noblock
comma
l_int|0
)paren
suffix:semicolon
)brace
DECL|function|atalk_shutdown
r_static
r_int
id|atalk_shutdown
c_func
(paren
r_struct
id|socket
op_star
id|sk
comma
r_int
id|how
)paren
(brace
r_return
op_minus
id|EOPNOTSUPP
suffix:semicolon
)brace
DECL|function|atalk_select
r_static
r_int
id|atalk_select
c_func
(paren
r_struct
id|socket
op_star
id|sock
comma
r_int
id|sel_type
comma
id|select_table
op_star
id|wait
)paren
(brace
id|atalk_socket
op_star
id|sk
op_assign
(paren
id|atalk_socket
op_star
)paren
id|sock-&gt;data
suffix:semicolon
r_return
id|datagram_select
c_func
(paren
id|sk
comma
id|sel_type
comma
id|wait
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;Appletalk ioctl calls.&n; */
DECL|function|atalk_ioctl
r_static
r_int
id|atalk_ioctl
c_func
(paren
r_struct
id|socket
op_star
id|sock
comma
r_int
r_int
id|cmd
comma
r_int
r_int
id|arg
)paren
(brace
r_int
id|err
suffix:semicolon
r_int
id|amount
op_assign
l_int|0
suffix:semicolon
id|atalk_socket
op_star
id|sk
op_assign
(paren
id|atalk_socket
op_star
)paren
id|sock-&gt;data
suffix:semicolon
r_int
id|v
suffix:semicolon
r_switch
c_cond
(paren
id|cmd
)paren
(brace
multiline_comment|/*&n;&t;&t; *&t;Protocol layer&n;&t;&t; */
r_case
id|TIOCOUTQ
suffix:colon
id|v
op_assign
id|sk-&gt;sndbuf
op_minus
id|sk-&gt;wmem_alloc
suffix:semicolon
r_if
c_cond
(paren
id|v
OL
l_int|0
)paren
(brace
id|v
op_assign
l_int|0
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|TIOCINQ
suffix:colon
(brace
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
multiline_comment|/* These two are safe on a single CPU system as only user tasks fiddle here */
r_if
c_cond
(paren
(paren
id|skb
op_assign
id|skb_peek
c_func
(paren
op_amp
id|sk-&gt;receive_queue
)paren
)paren
op_ne
l_int|NULL
)paren
(brace
id|v
op_assign
id|skb-&gt;len
op_minus
r_sizeof
(paren
r_struct
id|ddpehdr
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
)brace
r_case
id|SIOCGSTAMP
suffix:colon
r_if
c_cond
(paren
id|sk
)paren
(brace
r_if
c_cond
(paren
id|sk-&gt;stamp.tv_sec
op_eq
l_int|0
)paren
(brace
r_return
op_minus
id|ENOENT
suffix:semicolon
)brace
id|err
op_assign
id|verify_area
c_func
(paren
id|VERIFY_WRITE
comma
(paren
r_void
op_star
)paren
id|arg
comma
r_sizeof
(paren
r_struct
id|timeval
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
(brace
r_return
id|err
suffix:semicolon
)brace
id|memcpy_tofs
c_func
(paren
(paren
r_void
op_star
)paren
id|arg
comma
op_amp
id|sk-&gt;stamp
comma
r_sizeof
(paren
r_struct
id|timeval
)paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_return
op_minus
id|EINVAL
suffix:semicolon
multiline_comment|/*&n;&t;&t; *&t;Routing&n;&t;&t; */
r_case
id|SIOCADDRT
suffix:colon
r_case
id|SIOCDELRT
suffix:colon
r_if
c_cond
(paren
op_logical_neg
id|suser
c_func
(paren
)paren
)paren
(brace
r_return
op_minus
id|EPERM
suffix:semicolon
)brace
r_return
id|atrtr_ioctl
c_func
(paren
id|cmd
comma
(paren
r_void
op_star
)paren
id|arg
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t; *&t;Interface&n;&t;&t; */
r_case
id|SIOCGIFADDR
suffix:colon
r_case
id|SIOCSIFADDR
suffix:colon
r_case
id|SIOCGIFBRDADDR
suffix:colon
r_return
id|atif_ioctl
c_func
(paren
id|cmd
comma
(paren
r_void
op_star
)paren
id|arg
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t; *&t;Physical layer ioctl calls&n;&t;&t; */
r_case
id|SIOCSIFLINK
suffix:colon
r_case
id|SIOCGIFHWADDR
suffix:colon
r_case
id|SIOCSIFHWADDR
suffix:colon
r_case
id|OLD_SIOCGIFHWADDR
suffix:colon
r_case
id|SIOCGIFFLAGS
suffix:colon
r_case
id|SIOCSIFFLAGS
suffix:colon
r_case
id|SIOCGIFMTU
suffix:colon
r_case
id|SIOCGIFCONF
suffix:colon
r_case
id|SIOCADDMULTI
suffix:colon
r_case
id|SIOCDELMULTI
suffix:colon
r_return
id|dev_ioctl
c_func
(paren
id|cmd
comma
(paren
r_void
op_star
)paren
id|arg
)paren
suffix:semicolon
r_case
id|SIOCSIFMETRIC
suffix:colon
r_case
id|SIOCSIFBRDADDR
suffix:colon
r_case
id|SIOCGIFNETMASK
suffix:colon
r_case
id|SIOCSIFNETMASK
suffix:colon
r_case
id|SIOCGIFMEM
suffix:colon
r_case
id|SIOCSIFMEM
suffix:colon
r_case
id|SIOCGIFDSTADDR
suffix:colon
r_case
id|SIOCSIFDSTADDR
suffix:colon
r_return
op_minus
id|EINVAL
suffix:semicolon
r_default
suffix:colon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|err
op_assign
id|verify_area
c_func
(paren
id|VERIFY_WRITE
comma
(paren
r_void
op_star
)paren
id|arg
comma
r_sizeof
(paren
r_int
r_int
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
(brace
r_return
id|err
suffix:semicolon
)brace
id|put_fs_long
c_func
(paren
id|amount
comma
(paren
r_int
r_int
op_star
)paren
id|arg
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|variable|atalk_proto_ops
r_static
r_struct
id|proto_ops
id|atalk_proto_ops
op_assign
(brace
id|AF_APPLETALK
comma
id|atalk_create
comma
id|atalk_dup
comma
id|atalk_release
comma
id|atalk_bind
comma
id|atalk_connect
comma
id|atalk_socketpair
comma
id|atalk_accept
comma
id|atalk_getname
comma
id|atalk_read
comma
id|atalk_write
comma
id|atalk_select
comma
id|atalk_ioctl
comma
id|atalk_listen
comma
id|atalk_send
comma
id|atalk_recv
comma
id|atalk_sendto
comma
id|atalk_recvfrom
comma
id|atalk_shutdown
comma
id|atalk_setsockopt
comma
id|atalk_getsockopt
comma
id|atalk_fcntl
comma
)brace
suffix:semicolon
DECL|variable|ddp_notifier
r_static
r_struct
id|notifier_block
id|ddp_notifier
op_assign
initialization_block
suffix:semicolon
multiline_comment|/* Called by proto.c on kernel start up */
DECL|function|atalk_proto_init
r_void
id|atalk_proto_init
c_func
(paren
r_struct
id|net_proto
op_star
id|pro
)paren
(brace
r_static
r_char
id|ddp_snap_id
(braket
)braket
op_assign
initialization_block
suffix:semicolon
(paren
r_void
)paren
id|sock_register
c_func
(paren
id|atalk_proto_ops.family
comma
op_amp
id|atalk_proto_ops
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|ddp_dl
op_assign
id|register_snap_client
c_func
(paren
id|ddp_snap_id
comma
id|atalk_rcv
)paren
)paren
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;Unable to register DDP with SNAP.&bslash;n&quot;
)paren
suffix:semicolon
)brace
id|register_netdevice_notifier
c_func
(paren
op_amp
id|ddp_notifier
)paren
suffix:semicolon
id|aarp_proto_init
c_func
(paren
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;Appletalk ALPHA 0.08 for Linux NET3.029&bslash;n&quot;
)paren
suffix:semicolon
)brace
macro_line|#endif
eof
