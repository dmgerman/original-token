multiline_comment|/*&n; * linux/net/sunrpc/stats.c&n; *&n; * procfs-based user access to RPC statistics&n; *&n; * Everything is complicated by the fact that procfs doesn&squot;t pass the&n; * proc_dir_info struct in the call to get_info. We need our own &n; * inode_ops for /proc/net/rpc (we want to have a write op for zeroing&n; * the current stats, anyway).&n; *&n; * Copyright (C) 1995, 1996 Olaf Kirch &lt;okir@monad.swb.de&gt;&n; */
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/proc_fs.h&gt;
macro_line|#include &lt;linux/sunrpc/clnt.h&gt;
macro_line|#include &lt;linux/sunrpc/svcsock.h&gt;
DECL|macro|RPCDBG_FACILITY
mdefine_line|#define RPCDBG_FACILITY&t;RPCDBG_MISC
multiline_comment|/*&n; * Generic stats object (same for clnt and svc stats).&n; * Must agree with first two fields of either.&n; */
DECL|struct|stats
r_struct
id|stats
(brace
DECL|member|next
r_struct
id|stats
op_star
id|next
suffix:semicolon
DECL|member|entry
r_struct
id|proc_dir_entry
op_star
id|entry
suffix:semicolon
)brace
suffix:semicolon
multiline_comment|/* Code disabled until updated to new dynamic /proc code */
macro_line|#if 0
r_static
r_struct
id|stats
op_star
id|rpc_stats
op_assign
l_int|NULL
suffix:semicolon
r_static
r_struct
id|stats
op_star
id|svc_stats
op_assign
l_int|NULL
suffix:semicolon
r_static
r_struct
id|proc_dir_entry
id|proc_rpc
op_assign
(brace
l_int|0
comma
l_int|3
comma
l_string|&quot;rpc&quot;
comma
id|S_IFDIR
op_or
id|S_IRUGO
op_or
id|S_IXUGO
comma
l_int|1
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|NULL
comma
l_int|NULL
comma
l_int|NULL
comma
l_int|NULL
comma
l_int|NULL
comma
l_int|NULL
comma
)brace
suffix:semicolon
multiline_comment|/*&n; * Register/unregister a stats file&n; */
r_static
r_void
id|stats_register
c_func
(paren
r_struct
id|stats
op_star
op_star
id|q
comma
r_struct
id|stats
op_star
id|p
)paren
(brace
id|dprintk
c_func
(paren
l_string|&quot;RPC: registering /proc/net/rpc/%s&bslash;n&quot;
comma
id|p-&gt;entry-&gt;name
)paren
suffix:semicolon
multiline_comment|/* return; */
r_if
c_cond
(paren
id|p-&gt;entry-&gt;low_ino
)paren
r_return
suffix:semicolon
id|p-&gt;next
op_assign
op_star
id|q
suffix:semicolon
op_star
id|q
op_assign
id|p
suffix:semicolon
id|proc_register_dynamic
c_func
(paren
op_amp
id|proc_rpc
comma
id|p-&gt;entry
)paren
suffix:semicolon
)brace
r_static
r_void
id|stats_unregister
c_func
(paren
r_struct
id|stats
op_star
op_star
id|q
comma
r_struct
id|stats
op_star
id|p
)paren
(brace
id|dprintk
c_func
(paren
l_string|&quot;RPC: unregistering /proc/net/rpc/%s&bslash;n&quot;
comma
id|p-&gt;entry-&gt;name
)paren
suffix:semicolon
multiline_comment|/* return; */
r_if
c_cond
(paren
op_logical_neg
id|p-&gt;entry-&gt;low_ino
)paren
r_return
suffix:semicolon
r_while
c_loop
(paren
op_star
id|q
)paren
(brace
r_if
c_cond
(paren
op_star
id|q
op_eq
id|p
)paren
(brace
op_star
id|q
op_assign
id|p-&gt;next
suffix:semicolon
id|proc_unregister
c_func
(paren
op_amp
id|proc_rpc
comma
id|p-&gt;entry-&gt;low_ino
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|q
op_assign
op_amp
(paren
(paren
op_star
id|q
)paren
op_member_access_from_pointer
id|next
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/*&n; * Client stats handling&n; */
r_void
id|rpcstat_register
c_func
(paren
r_struct
id|rpc_stat
op_star
id|statp
)paren
(brace
id|stats_register
c_func
(paren
op_amp
id|rpc_stats
comma
(paren
r_struct
id|stats
op_star
)paren
id|statp
)paren
suffix:semicolon
)brace
r_void
id|rpcstat_unregister
c_func
(paren
r_struct
id|rpc_stat
op_star
id|statp
)paren
(brace
id|stats_unregister
c_func
(paren
op_amp
id|rpc_stats
comma
(paren
r_struct
id|stats
op_star
)paren
id|statp
)paren
suffix:semicolon
)brace
r_int
id|rpcstat_get_info
c_func
(paren
r_struct
id|rpc_stat
op_star
id|statp
comma
r_char
op_star
id|buffer
comma
r_char
op_star
op_star
id|start
comma
id|off_t
id|offset
comma
r_int
id|length
)paren
(brace
r_struct
id|rpc_program
op_star
id|prog
op_assign
id|statp-&gt;program
suffix:semicolon
r_struct
id|rpc_version
op_star
id|vers
suffix:semicolon
r_int
id|len
comma
id|i
comma
id|j
suffix:semicolon
id|len
op_assign
id|sprintf
c_func
(paren
id|buffer
comma
l_string|&quot;net %d %d %d %d&bslash;n&quot;
comma
id|statp-&gt;netcnt
comma
id|statp-&gt;netudpcnt
comma
id|statp-&gt;nettcpcnt
comma
id|statp-&gt;nettcpconn
)paren
suffix:semicolon
id|len
op_add_assign
id|sprintf
c_func
(paren
id|buffer
op_plus
id|len
comma
l_string|&quot;rpc %d %d %d&bslash;n&quot;
comma
id|statp-&gt;rpccnt
comma
id|statp-&gt;rpcretrans
comma
id|statp-&gt;rpcauthrefresh
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|prog-&gt;nrvers
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|vers
op_assign
id|prog-&gt;version
(braket
id|i
)braket
)paren
)paren
r_continue
suffix:semicolon
id|len
op_add_assign
id|sprintf
c_func
(paren
id|buffer
op_plus
id|len
comma
l_string|&quot;proc%d %d&quot;
comma
id|vers-&gt;number
comma
id|vers-&gt;nrprocs
)paren
suffix:semicolon
r_for
c_loop
(paren
id|j
op_assign
l_int|0
suffix:semicolon
id|j
OL
id|vers-&gt;nrprocs
suffix:semicolon
id|j
op_increment
)paren
id|len
op_add_assign
id|sprintf
c_func
(paren
id|buffer
op_plus
id|len
comma
l_string|&quot; %d&quot;
comma
id|vers-&gt;procs
(braket
id|j
)braket
dot
id|p_count
)paren
suffix:semicolon
id|buffer
(braket
id|len
op_increment
)braket
op_assign
l_char|&squot;&bslash;n&squot;
suffix:semicolon
)brace
r_if
c_cond
(paren
id|offset
op_ge
id|len
)paren
(brace
op_star
id|start
op_assign
id|buffer
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
op_star
id|start
op_assign
id|buffer
op_plus
id|offset
suffix:semicolon
id|len
op_sub_assign
id|offset
suffix:semicolon
r_if
c_cond
(paren
id|len
OG
id|length
)paren
id|len
op_assign
id|length
suffix:semicolon
r_return
id|len
suffix:semicolon
)brace
multiline_comment|/*&n; * Server stats handling&n; */
r_void
id|svcstat_register
c_func
(paren
r_struct
id|svc_stat
op_star
id|statp
)paren
(brace
id|stats_register
c_func
(paren
op_amp
id|svc_stats
comma
(paren
r_struct
id|stats
op_star
)paren
id|statp
)paren
suffix:semicolon
)brace
r_void
id|svcstat_unregister
c_func
(paren
r_struct
id|svc_stat
op_star
id|statp
)paren
(brace
id|stats_unregister
c_func
(paren
op_amp
id|svc_stats
comma
(paren
r_struct
id|stats
op_star
)paren
id|statp
)paren
suffix:semicolon
)brace
r_int
id|svcstat_get_info
c_func
(paren
r_struct
id|svc_stat
op_star
id|statp
comma
r_char
op_star
id|buffer
comma
r_char
op_star
op_star
id|start
comma
id|off_t
id|offset
comma
r_int
id|length
)paren
(brace
r_struct
id|svc_program
op_star
id|prog
op_assign
id|statp-&gt;program
suffix:semicolon
r_struct
id|svc_procedure
op_star
id|proc
suffix:semicolon
r_struct
id|svc_version
op_star
id|vers
suffix:semicolon
r_int
id|len
comma
id|i
comma
id|j
suffix:semicolon
id|len
op_assign
id|sprintf
c_func
(paren
id|buffer
comma
l_string|&quot;net %d %d %d %d&bslash;n&quot;
comma
id|statp-&gt;netcnt
comma
id|statp-&gt;netudpcnt
comma
id|statp-&gt;nettcpcnt
comma
id|statp-&gt;nettcpconn
)paren
suffix:semicolon
id|len
op_add_assign
id|sprintf
c_func
(paren
id|buffer
op_plus
id|len
comma
l_string|&quot;rpc %d %d %d %d %d&bslash;n&quot;
comma
id|statp-&gt;rpccnt
comma
id|statp-&gt;rpcbadfmt
op_plus
id|statp-&gt;rpcbadauth
op_plus
id|statp-&gt;rpcbadclnt
comma
id|statp-&gt;rpcbadfmt
comma
id|statp-&gt;rpcbadauth
comma
id|statp-&gt;rpcbadclnt
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|prog-&gt;pg_nvers
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|vers
op_assign
id|prog-&gt;pg_vers
(braket
id|i
)braket
)paren
op_logical_or
op_logical_neg
(paren
id|proc
op_assign
id|vers-&gt;vs_proc
)paren
)paren
r_continue
suffix:semicolon
id|len
op_add_assign
id|sprintf
c_func
(paren
id|buffer
op_plus
id|len
comma
l_string|&quot;proc%d %d&quot;
comma
id|i
comma
id|vers-&gt;vs_nproc
)paren
suffix:semicolon
r_for
c_loop
(paren
id|j
op_assign
l_int|0
suffix:semicolon
id|j
OL
id|vers-&gt;vs_nproc
suffix:semicolon
id|j
op_increment
comma
id|proc
op_increment
)paren
id|len
op_add_assign
id|sprintf
c_func
(paren
id|buffer
op_plus
id|len
comma
l_string|&quot; %d&quot;
comma
id|proc-&gt;pc_count
)paren
suffix:semicolon
id|buffer
(braket
id|len
op_increment
)braket
op_assign
l_char|&squot;&bslash;n&squot;
suffix:semicolon
)brace
r_if
c_cond
(paren
id|offset
op_ge
id|len
)paren
(brace
op_star
id|start
op_assign
id|buffer
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
op_star
id|start
op_assign
id|buffer
op_plus
id|offset
suffix:semicolon
r_if
c_cond
(paren
(paren
id|len
op_sub_assign
id|offset
)paren
OG
id|length
)paren
id|len
op_assign
id|length
suffix:semicolon
r_return
id|len
suffix:semicolon
)brace
multiline_comment|/*&n; * Register /proc/net/rpc&n; */
r_void
id|rpcstat_init
c_func
(paren
r_void
)paren
(brace
id|dprintk
c_func
(paren
l_string|&quot;RPC: registering /proc/net/rpc&bslash;n&quot;
)paren
suffix:semicolon
id|proc_rpc.ops
op_assign
id|proc_net.ops
suffix:semicolon
multiline_comment|/* cheat */
id|proc_register_dynamic
c_func
(paren
op_amp
id|proc_net
comma
op_amp
id|proc_rpc
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Unregister /proc/net/rpc&n; */
r_void
id|rpcstat_exit
c_func
(paren
r_void
)paren
(brace
r_while
c_loop
(paren
id|rpc_stats
)paren
id|stats_unregister
c_func
(paren
op_amp
id|rpc_stats
comma
id|rpc_stats
)paren
suffix:semicolon
r_while
c_loop
(paren
id|svc_stats
)paren
id|stats_unregister
c_func
(paren
op_amp
id|svc_stats
comma
id|svc_stats
)paren
suffix:semicolon
id|dprintk
c_func
(paren
l_string|&quot;RPC: unregistering /proc/net/rpc&bslash;n&quot;
)paren
suffix:semicolon
id|proc_unregister
c_func
(paren
op_amp
id|proc_net
comma
id|proc_rpc.low_ino
)paren
suffix:semicolon
)brace
macro_line|#else
multiline_comment|/* Various dummy functions */
r_int
DECL|function|rpcstat_get_info
id|rpcstat_get_info
c_func
(paren
r_struct
id|rpc_stat
op_star
id|statp
comma
r_char
op_star
id|buffer
comma
r_char
op_star
op_star
id|start
comma
id|off_t
id|offset
comma
r_int
id|length
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
r_int
DECL|function|svcstat_get_info
id|svcstat_get_info
c_func
(paren
r_struct
id|svc_stat
op_star
id|statp
comma
r_char
op_star
id|buffer
comma
r_char
op_star
op_star
id|start
comma
id|off_t
id|offset
comma
r_int
id|length
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
r_void
DECL|function|rpcstat_register
id|rpcstat_register
c_func
(paren
r_struct
id|rpc_stat
op_star
id|statp
)paren
(brace
)brace
r_void
DECL|function|rpcstat_unregister
id|rpcstat_unregister
c_func
(paren
r_struct
id|rpc_stat
op_star
id|statp
)paren
(brace
)brace
r_void
DECL|function|svcstat_register
id|svcstat_register
c_func
(paren
r_struct
id|svc_stat
op_star
id|statp
)paren
(brace
)brace
r_void
DECL|function|svcstat_unregister
id|svcstat_unregister
c_func
(paren
r_struct
id|svc_stat
op_star
id|statp
)paren
(brace
)brace
r_void
DECL|function|rpcstat_init
id|rpcstat_init
c_func
(paren
r_void
)paren
(brace
)brace
r_void
DECL|function|rpcstat_exit
id|rpcstat_exit
c_func
(paren
r_void
)paren
(brace
)brace
macro_line|#endif
eof
