multiline_comment|/*&n; * linux/net/sunrpc/svcsock.c&n; *&n; * These are the RPC server socket internals.&n; *&n; * The server scheduling algorithm does not always distribute the load&n; * evenly when servicing a single client. May need to modify the&n; * svc_sock_enqueue procedure...&n; *&n; * TCP support is largely untested and may be a little slow. The problem&n; * is that we currently do two separate recvfrom&squot;s, one for the 4-byte&n; * record length, and the second for the actual record. This could possibly&n; * be improved by always reading a minimum size of around 100 bytes and&n; * tucking any superfluous bytes away in a temporary store. Still, that&n; * leaves write requests out in the rain. An alternative may be to peek at&n; * the first skb in the queue, and if it matches the next TCP sequence&n; * number, to extract the record marker. Yuck.&n; *&n; * Copyright (C) 1995, 1996 Olaf Kirch &lt;okir@monad.swb.de&gt;&n; */
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/fcntl.h&gt;
macro_line|#include &lt;linux/net.h&gt;
macro_line|#include &lt;linux/in.h&gt;
macro_line|#include &lt;linux/inet.h&gt;
macro_line|#include &lt;linux/udp.h&gt;
macro_line|#include &lt;linux/version.h&gt;
macro_line|#include &lt;linux/unistd.h&gt;
macro_line|#include &lt;linux/malloc.h&gt;
macro_line|#include &lt;linux/netdevice.h&gt;
macro_line|#include &lt;linux/skbuff.h&gt;
macro_line|#include &lt;net/sock.h&gt;
macro_line|#include &lt;net/checksum.h&gt;
macro_line|#include &lt;net/ip.h&gt;
macro_line|#include &lt;asm/uaccess.h&gt;
macro_line|#include &lt;linux/sunrpc/types.h&gt;
macro_line|#include &lt;linux/sunrpc/xdr.h&gt;
macro_line|#include &lt;linux/sunrpc/svcsock.h&gt;
macro_line|#include &lt;linux/sunrpc/stats.h&gt;
multiline_comment|/* SMP locking strategy:&n; *&n; * &t;svc_sock-&gt;sk_lock and svc_serv-&gt;sv_lock protect their&n; *&t;respective structures.&n; *&n; *&t;Antideadlock ordering is sk_lock --&gt; sv_lock.&n; */
DECL|macro|RPCDBG_FACILITY
mdefine_line|#define RPCDBG_FACILITY&t;RPCDBG_SVCSOCK
r_static
r_struct
id|svc_sock
op_star
id|svc_setup_socket
c_func
(paren
r_struct
id|svc_serv
op_star
comma
r_struct
id|socket
op_star
comma
r_int
op_star
id|errp
comma
r_int
id|pmap_reg
)paren
suffix:semicolon
r_static
r_void
id|svc_udp_data_ready
c_func
(paren
r_struct
id|sock
op_star
comma
r_int
)paren
suffix:semicolon
r_static
r_int
id|svc_udp_recvfrom
c_func
(paren
r_struct
id|svc_rqst
op_star
)paren
suffix:semicolon
r_static
r_int
id|svc_udp_sendto
c_func
(paren
r_struct
id|svc_rqst
op_star
)paren
suffix:semicolon
multiline_comment|/*&n; * Queue up an idle server thread.  Must have serv-&gt;sv_lock held.&n; */
r_static
r_inline
r_void
DECL|function|svc_serv_enqueue
id|svc_serv_enqueue
c_func
(paren
r_struct
id|svc_serv
op_star
id|serv
comma
r_struct
id|svc_rqst
op_star
id|rqstp
)paren
(brace
id|rpc_append_list
c_func
(paren
op_amp
id|serv-&gt;sv_threads
comma
id|rqstp
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Dequeue an nfsd thread.  Must have serv-&gt;sv_lock held.&n; */
r_static
r_inline
r_void
DECL|function|svc_serv_dequeue
id|svc_serv_dequeue
c_func
(paren
r_struct
id|svc_serv
op_star
id|serv
comma
r_struct
id|svc_rqst
op_star
id|rqstp
)paren
(brace
id|rpc_remove_list
c_func
(paren
op_amp
id|serv-&gt;sv_threads
comma
id|rqstp
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Release an skbuff after use&n; */
r_static
r_inline
r_void
DECL|function|svc_release_skb
id|svc_release_skb
c_func
(paren
r_struct
id|svc_rqst
op_star
id|rqstp
)paren
(brace
r_struct
id|sk_buff
op_star
id|skb
op_assign
id|rqstp-&gt;rq_skbuff
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|skb
)paren
r_return
suffix:semicolon
id|rqstp-&gt;rq_skbuff
op_assign
l_int|NULL
suffix:semicolon
id|dprintk
c_func
(paren
l_string|&quot;svc: service %p, releasing skb %p&bslash;n&quot;
comma
id|rqstp
comma
id|skb
)paren
suffix:semicolon
id|skb_free_datagram
c_func
(paren
id|rqstp-&gt;rq_sock-&gt;sk_sk
comma
id|skb
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Queue up a socket with data pending. If there are idle nfsd&n; * processes, wake &squot;em up.&n; *&n; * This must be called with svsk-&gt;sk_lock held.&n; */
r_static
r_void
DECL|function|svc_sock_enqueue
id|svc_sock_enqueue
c_func
(paren
r_struct
id|svc_sock
op_star
id|svsk
)paren
(brace
r_struct
id|svc_serv
op_star
id|serv
op_assign
id|svsk-&gt;sk_server
suffix:semicolon
r_struct
id|svc_rqst
op_star
id|rqstp
suffix:semicolon
multiline_comment|/* NOTE: Local BH is already disabled by our caller. */
id|spin_lock
c_func
(paren
op_amp
id|serv-&gt;sv_lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|serv-&gt;sv_threads
op_logical_and
id|serv-&gt;sv_sockets
)paren
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;svc_sock_enqueue: threads and sockets both waiting??&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|svsk-&gt;sk_busy
)paren
(brace
multiline_comment|/* Don&squot;t enqueue socket while daemon is receiving */
id|dprintk
c_func
(paren
l_string|&quot;svc: socket %p busy, not enqueued&bslash;n&quot;
comma
id|svsk-&gt;sk_sk
)paren
suffix:semicolon
r_goto
id|out_unlock
suffix:semicolon
)brace
multiline_comment|/* Mark socket as busy. It will remain in this state until the&n;&t; * server has processed all pending data and put the socket back&n;&t; * on the idle list.&n;&t; */
id|svsk-&gt;sk_busy
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
(paren
id|rqstp
op_assign
id|serv-&gt;sv_threads
)paren
op_ne
l_int|NULL
)paren
(brace
id|dprintk
c_func
(paren
l_string|&quot;svc: socket %p served by daemon %p&bslash;n&quot;
comma
id|svsk-&gt;sk_sk
comma
id|rqstp
)paren
suffix:semicolon
id|svc_serv_dequeue
c_func
(paren
id|serv
comma
id|rqstp
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rqstp-&gt;rq_sock
)paren
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;svc_sock_enqueue: server %p, rq_sock=%p!&bslash;n&quot;
comma
id|rqstp
comma
id|rqstp-&gt;rq_sock
)paren
suffix:semicolon
id|rqstp-&gt;rq_sock
op_assign
id|svsk
suffix:semicolon
id|svsk-&gt;sk_inuse
op_increment
suffix:semicolon
id|wake_up
c_func
(paren
op_amp
id|rqstp-&gt;rq_wait
)paren
suffix:semicolon
)brace
r_else
(brace
id|dprintk
c_func
(paren
l_string|&quot;svc: socket %p put into queue&bslash;n&quot;
comma
id|svsk-&gt;sk_sk
)paren
suffix:semicolon
id|rpc_append_list
c_func
(paren
op_amp
id|serv-&gt;sv_sockets
comma
id|svsk
)paren
suffix:semicolon
id|svsk-&gt;sk_qued
op_assign
l_int|1
suffix:semicolon
)brace
id|out_unlock
suffix:colon
id|spin_unlock
c_func
(paren
op_amp
id|serv-&gt;sv_lock
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Dequeue the first socket.  Must be called with the serv-&gt;sv_lock held.&n; */
r_static
r_inline
r_struct
id|svc_sock
op_star
DECL|function|svc_sock_dequeue
id|svc_sock_dequeue
c_func
(paren
r_struct
id|svc_serv
op_star
id|serv
)paren
(brace
r_struct
id|svc_sock
op_star
id|svsk
suffix:semicolon
r_if
c_cond
(paren
(paren
id|svsk
op_assign
id|serv-&gt;sv_sockets
)paren
op_ne
l_int|NULL
)paren
id|rpc_remove_list
c_func
(paren
op_amp
id|serv-&gt;sv_sockets
comma
id|svsk
)paren
suffix:semicolon
r_if
c_cond
(paren
id|svsk
)paren
(brace
id|dprintk
c_func
(paren
l_string|&quot;svc: socket %p dequeued, inuse=%d&bslash;n&quot;
comma
id|svsk-&gt;sk_sk
comma
id|svsk-&gt;sk_inuse
)paren
suffix:semicolon
id|svsk-&gt;sk_qued
op_assign
l_int|0
suffix:semicolon
)brace
r_return
id|svsk
suffix:semicolon
)brace
multiline_comment|/*&n; * Having read count bytes from a socket, check whether it&n; * needs to be re-enqueued.&n; */
r_static
r_inline
r_void
DECL|function|svc_sock_received
id|svc_sock_received
c_func
(paren
r_struct
id|svc_sock
op_star
id|svsk
comma
r_int
id|count
)paren
(brace
id|spin_lock_bh
c_func
(paren
op_amp
id|svsk-&gt;sk_lock
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|svsk-&gt;sk_data
op_sub_assign
id|count
)paren
OL
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;svc: sk_data negative!&bslash;n&quot;
)paren
suffix:semicolon
id|svsk-&gt;sk_data
op_assign
l_int|0
suffix:semicolon
)brace
id|svsk-&gt;sk_rqstp
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/* XXX */
id|svsk-&gt;sk_busy
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|svsk-&gt;sk_conn
op_logical_or
id|svsk-&gt;sk_data
op_logical_or
id|svsk-&gt;sk_close
)paren
(brace
id|dprintk
c_func
(paren
l_string|&quot;svc: socket %p re-enqueued after receive&bslash;n&quot;
comma
id|svsk-&gt;sk_sk
)paren
suffix:semicolon
id|svc_sock_enqueue
c_func
(paren
id|svsk
)paren
suffix:semicolon
)brace
id|spin_unlock_bh
c_func
(paren
op_amp
id|svsk-&gt;sk_lock
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Dequeue a new connection.&n; */
r_static
r_inline
r_void
DECL|function|svc_sock_accepted
id|svc_sock_accepted
c_func
(paren
r_struct
id|svc_sock
op_star
id|svsk
)paren
(brace
id|spin_lock_bh
c_func
(paren
op_amp
id|svsk-&gt;sk_lock
)paren
suffix:semicolon
id|svsk-&gt;sk_busy
op_assign
l_int|0
suffix:semicolon
id|svsk-&gt;sk_conn
op_decrement
suffix:semicolon
r_if
c_cond
(paren
id|svsk-&gt;sk_conn
op_logical_or
id|svsk-&gt;sk_data
op_logical_or
id|svsk-&gt;sk_close
)paren
(brace
id|dprintk
c_func
(paren
l_string|&quot;svc: socket %p re-enqueued after accept&bslash;n&quot;
comma
id|svsk-&gt;sk_sk
)paren
suffix:semicolon
id|svc_sock_enqueue
c_func
(paren
id|svsk
)paren
suffix:semicolon
)brace
id|spin_unlock_bh
c_func
(paren
op_amp
id|svsk-&gt;sk_lock
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Release a socket after use.&n; */
r_static
r_inline
r_void
DECL|function|svc_sock_release
id|svc_sock_release
c_func
(paren
r_struct
id|svc_rqst
op_star
id|rqstp
)paren
(brace
r_struct
id|svc_sock
op_star
id|svsk
op_assign
id|rqstp-&gt;rq_sock
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|svsk
)paren
r_return
suffix:semicolon
id|svc_release_skb
c_func
(paren
id|rqstp
)paren
suffix:semicolon
id|rqstp-&gt;rq_sock
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
op_decrement
(paren
id|svsk-&gt;sk_inuse
)paren
op_logical_and
id|svsk-&gt;sk_dead
)paren
(brace
id|dprintk
c_func
(paren
l_string|&quot;svc: releasing dead socket&bslash;n&quot;
)paren
suffix:semicolon
id|sock_release
c_func
(paren
id|svsk-&gt;sk_sock
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|svsk
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/*&n; * External function to wake up a server waiting for data&n; */
r_void
DECL|function|svc_wake_up
id|svc_wake_up
c_func
(paren
r_struct
id|svc_serv
op_star
id|serv
)paren
(brace
r_struct
id|svc_rqst
op_star
id|rqstp
suffix:semicolon
id|spin_lock_bh
c_func
(paren
op_amp
id|serv-&gt;sv_lock
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|rqstp
op_assign
id|serv-&gt;sv_threads
)paren
op_ne
l_int|NULL
)paren
(brace
id|dprintk
c_func
(paren
l_string|&quot;svc: daemon %p woken up.&bslash;n&quot;
comma
id|rqstp
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t;svc_serv_dequeue(serv, rqstp);&n;&t;&t;rqstp-&gt;rq_sock = NULL;&n;&t;&t; */
id|wake_up
c_func
(paren
op_amp
id|rqstp-&gt;rq_wait
)paren
suffix:semicolon
)brace
id|spin_unlock_bh
c_func
(paren
op_amp
id|serv-&gt;sv_lock
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Generic sendto routine&n; */
r_static
r_int
DECL|function|svc_sendto
id|svc_sendto
c_func
(paren
r_struct
id|svc_rqst
op_star
id|rqstp
comma
r_struct
id|iovec
op_star
id|iov
comma
r_int
id|nr
)paren
(brace
id|mm_segment_t
id|oldfs
suffix:semicolon
r_struct
id|svc_sock
op_star
id|svsk
op_assign
id|rqstp-&gt;rq_sock
suffix:semicolon
r_struct
id|socket
op_star
id|sock
op_assign
id|svsk-&gt;sk_sock
suffix:semicolon
r_struct
id|msghdr
id|msg
suffix:semicolon
r_int
id|i
comma
id|buflen
comma
id|len
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
id|buflen
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|nr
suffix:semicolon
id|i
op_increment
)paren
id|buflen
op_add_assign
id|iov
(braket
id|i
)braket
dot
id|iov_len
suffix:semicolon
id|msg.msg_name
op_assign
op_amp
id|rqstp-&gt;rq_addr
suffix:semicolon
id|msg.msg_namelen
op_assign
r_sizeof
(paren
id|rqstp-&gt;rq_addr
)paren
suffix:semicolon
id|msg.msg_iov
op_assign
id|iov
suffix:semicolon
id|msg.msg_iovlen
op_assign
id|nr
suffix:semicolon
id|msg.msg_control
op_assign
l_int|NULL
suffix:semicolon
id|msg.msg_controllen
op_assign
l_int|0
suffix:semicolon
id|msg.msg_flags
op_assign
id|MSG_DONTWAIT
suffix:semicolon
id|oldfs
op_assign
id|get_fs
c_func
(paren
)paren
suffix:semicolon
id|set_fs
c_func
(paren
id|KERNEL_DS
)paren
suffix:semicolon
id|len
op_assign
id|sock_sendmsg
c_func
(paren
id|sock
comma
op_amp
id|msg
comma
id|buflen
)paren
suffix:semicolon
id|set_fs
c_func
(paren
id|oldfs
)paren
suffix:semicolon
id|dprintk
c_func
(paren
l_string|&quot;svc: socket %p sendto([%p %Zu... ], %d, %d) = %d&bslash;n&quot;
comma
id|rqstp-&gt;rq_sock
comma
id|iov
(braket
l_int|0
)braket
dot
id|iov_base
comma
id|iov
(braket
l_int|0
)braket
dot
id|iov_len
comma
id|nr
comma
id|buflen
comma
id|len
)paren
suffix:semicolon
r_return
id|len
suffix:semicolon
)brace
multiline_comment|/*&n; * Check input queue length&n; */
r_static
r_int
DECL|function|svc_recv_available
id|svc_recv_available
c_func
(paren
r_struct
id|svc_sock
op_star
id|svsk
)paren
(brace
id|mm_segment_t
id|oldfs
suffix:semicolon
r_struct
id|socket
op_star
id|sock
op_assign
id|svsk-&gt;sk_sock
suffix:semicolon
r_int
id|avail
comma
id|err
suffix:semicolon
id|oldfs
op_assign
id|get_fs
c_func
(paren
)paren
suffix:semicolon
id|set_fs
c_func
(paren
id|KERNEL_DS
)paren
suffix:semicolon
id|err
op_assign
id|sock-&gt;ops
op_member_access_from_pointer
id|ioctl
c_func
(paren
id|sock
comma
id|TIOCINQ
comma
(paren
r_int
r_int
)paren
op_amp
id|avail
)paren
suffix:semicolon
id|set_fs
c_func
(paren
id|oldfs
)paren
suffix:semicolon
r_return
(paren
id|err
op_ge
l_int|0
)paren
ques
c_cond
id|avail
suffix:colon
id|err
suffix:semicolon
)brace
multiline_comment|/*&n; * Generic recvfrom routine.&n; */
r_static
r_int
DECL|function|svc_recvfrom
id|svc_recvfrom
c_func
(paren
r_struct
id|svc_rqst
op_star
id|rqstp
comma
r_struct
id|iovec
op_star
id|iov
comma
r_int
id|nr
comma
r_int
id|buflen
)paren
(brace
id|mm_segment_t
id|oldfs
suffix:semicolon
r_struct
id|msghdr
id|msg
suffix:semicolon
r_struct
id|socket
op_star
id|sock
suffix:semicolon
r_int
id|len
comma
id|alen
suffix:semicolon
id|rqstp-&gt;rq_addrlen
op_assign
r_sizeof
(paren
id|rqstp-&gt;rq_addr
)paren
suffix:semicolon
id|sock
op_assign
id|rqstp-&gt;rq_sock-&gt;sk_sock
suffix:semicolon
id|msg.msg_name
op_assign
op_amp
id|rqstp-&gt;rq_addr
suffix:semicolon
id|msg.msg_namelen
op_assign
r_sizeof
(paren
id|rqstp-&gt;rq_addr
)paren
suffix:semicolon
id|msg.msg_iov
op_assign
id|iov
suffix:semicolon
id|msg.msg_iovlen
op_assign
id|nr
suffix:semicolon
id|msg.msg_control
op_assign
l_int|NULL
suffix:semicolon
id|msg.msg_controllen
op_assign
l_int|0
suffix:semicolon
id|msg.msg_flags
op_assign
id|MSG_DONTWAIT
suffix:semicolon
id|oldfs
op_assign
id|get_fs
c_func
(paren
)paren
suffix:semicolon
id|set_fs
c_func
(paren
id|KERNEL_DS
)paren
suffix:semicolon
id|len
op_assign
id|sock_recvmsg
c_func
(paren
id|sock
comma
op_amp
id|msg
comma
id|buflen
comma
id|MSG_DONTWAIT
)paren
suffix:semicolon
id|set_fs
c_func
(paren
id|oldfs
)paren
suffix:semicolon
multiline_comment|/* sock_recvmsg doesn&squot;t fill in the name/namelen, so we must..&n;&t; * possibly we should cache this in the svc_sock structure&n;&t; * at accept time. FIXME&n;&t; */
id|alen
op_assign
r_sizeof
(paren
id|rqstp-&gt;rq_addr
)paren
suffix:semicolon
id|sock-&gt;ops
op_member_access_from_pointer
id|getname
c_func
(paren
id|sock
comma
(paren
r_struct
id|sockaddr
op_star
)paren
op_amp
id|rqstp-&gt;rq_addr
comma
op_amp
id|alen
comma
l_int|1
)paren
suffix:semicolon
id|dprintk
c_func
(paren
l_string|&quot;svc: socket %p recvfrom(%p, %Zu) = %d&bslash;n&quot;
comma
id|rqstp-&gt;rq_sock
comma
id|iov
(braket
l_int|0
)braket
dot
id|iov_base
comma
id|iov
(braket
l_int|0
)braket
dot
id|iov_len
comma
id|len
)paren
suffix:semicolon
r_return
id|len
suffix:semicolon
)brace
multiline_comment|/*&n; * INET callback when data has been received on the socket.&n; */
r_static
r_void
DECL|function|svc_udp_data_ready
id|svc_udp_data_ready
c_func
(paren
r_struct
id|sock
op_star
id|sk
comma
r_int
id|count
)paren
(brace
r_struct
id|svc_sock
op_star
id|svsk
op_assign
(paren
r_struct
id|svc_sock
op_star
)paren
(paren
id|sk-&gt;user_data
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|svsk
)paren
r_goto
id|out
suffix:semicolon
id|dprintk
c_func
(paren
l_string|&quot;svc: socket %p(inet %p), count=%d, busy=%d&bslash;n&quot;
comma
id|svsk
comma
id|sk
comma
id|count
comma
id|svsk-&gt;sk_busy
)paren
suffix:semicolon
id|spin_lock_bh
c_func
(paren
op_amp
id|svsk-&gt;sk_lock
)paren
suffix:semicolon
id|svsk-&gt;sk_data
op_assign
l_int|1
suffix:semicolon
id|svc_sock_enqueue
c_func
(paren
id|svsk
)paren
suffix:semicolon
id|spin_unlock_bh
c_func
(paren
op_amp
id|svsk-&gt;sk_lock
)paren
suffix:semicolon
id|out
suffix:colon
r_if
c_cond
(paren
id|sk-&gt;sleep
op_logical_and
id|waitqueue_active
c_func
(paren
id|sk-&gt;sleep
)paren
)paren
id|wake_up_interruptible
c_func
(paren
id|sk-&gt;sleep
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Receive a datagram from a UDP socket.&n; */
r_static
r_int
DECL|function|svc_udp_recvfrom
id|svc_udp_recvfrom
c_func
(paren
r_struct
id|svc_rqst
op_star
id|rqstp
)paren
(brace
r_struct
id|svc_sock
op_star
id|svsk
op_assign
id|rqstp-&gt;rq_sock
suffix:semicolon
r_struct
id|svc_serv
op_star
id|serv
op_assign
id|svsk-&gt;sk_server
suffix:semicolon
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
id|u32
op_star
id|data
suffix:semicolon
r_int
id|err
comma
id|len
suffix:semicolon
id|svsk-&gt;sk_data
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
(paren
id|skb
op_assign
id|skb_recv_datagram
c_func
(paren
id|svsk-&gt;sk_sk
comma
l_int|0
comma
l_int|1
comma
op_amp
id|err
)paren
)paren
op_eq
l_int|NULL
)paren
(brace
id|svc_sock_received
c_func
(paren
id|svsk
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
op_eq
op_minus
id|EAGAIN
)paren
r_return
id|err
suffix:semicolon
multiline_comment|/* possibly an icmp error */
id|dprintk
c_func
(paren
l_string|&quot;svc: recvfrom returned error %d&bslash;n&quot;
comma
op_minus
id|err
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|skb-&gt;ip_summed
op_ne
id|CHECKSUM_UNNECESSARY
)paren
(brace
r_int
r_int
id|csum
op_assign
id|skb-&gt;csum
suffix:semicolon
id|csum
op_assign
id|csum_partial
c_func
(paren
id|skb-&gt;h.raw
comma
id|skb-&gt;len
comma
id|csum
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
r_int
r_int
)paren
id|csum_fold
c_func
(paren
id|csum
)paren
)paren
(brace
id|skb_free_datagram
c_func
(paren
id|svsk-&gt;sk_sk
comma
id|skb
)paren
suffix:semicolon
id|svc_sock_received
c_func
(paren
id|svsk
comma
l_int|0
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
)brace
multiline_comment|/* There may be more data */
id|svsk-&gt;sk_data
op_assign
l_int|1
suffix:semicolon
id|len
op_assign
id|skb-&gt;len
op_minus
r_sizeof
(paren
r_struct
id|udphdr
)paren
suffix:semicolon
id|data
op_assign
(paren
id|u32
op_star
)paren
(paren
id|skb-&gt;h.raw
op_plus
r_sizeof
(paren
r_struct
id|udphdr
)paren
)paren
suffix:semicolon
id|rqstp-&gt;rq_skbuff
op_assign
id|skb
suffix:semicolon
id|rqstp-&gt;rq_argbuf.base
op_assign
id|data
suffix:semicolon
id|rqstp-&gt;rq_argbuf.buf
op_assign
id|data
suffix:semicolon
id|rqstp-&gt;rq_argbuf.len
op_assign
(paren
id|len
op_rshift
l_int|2
)paren
suffix:semicolon
multiline_comment|/* rqstp-&gt;rq_resbuf      = rqstp-&gt;rq_defbuf; */
id|rqstp-&gt;rq_prot
op_assign
id|IPPROTO_UDP
suffix:semicolon
multiline_comment|/* Get sender address */
id|rqstp-&gt;rq_addr.sin_family
op_assign
id|AF_INET
suffix:semicolon
id|rqstp-&gt;rq_addr.sin_port
op_assign
id|skb-&gt;h.uh-&gt;source
suffix:semicolon
id|rqstp-&gt;rq_addr.sin_addr.s_addr
op_assign
id|skb-&gt;nh.iph-&gt;saddr
suffix:semicolon
r_if
c_cond
(paren
id|serv-&gt;sv_stats
)paren
id|serv-&gt;sv_stats-&gt;netudpcnt
op_increment
suffix:semicolon
multiline_comment|/* One down, maybe more to go... */
id|svsk-&gt;sk_sk-&gt;stamp
op_assign
id|skb-&gt;stamp
suffix:semicolon
id|svc_sock_received
c_func
(paren
id|svsk
comma
l_int|0
)paren
suffix:semicolon
r_return
id|len
suffix:semicolon
)brace
r_static
r_int
DECL|function|svc_udp_sendto
id|svc_udp_sendto
c_func
(paren
r_struct
id|svc_rqst
op_star
id|rqstp
)paren
(brace
r_struct
id|svc_buf
op_star
id|bufp
op_assign
op_amp
id|rqstp-&gt;rq_resbuf
suffix:semicolon
r_int
id|error
suffix:semicolon
multiline_comment|/* Set up the first element of the reply iovec.&n;&t; * Any other iovecs that may be in use have been taken&n;&t; * care of by the server implementation itself.&n;&t; */
multiline_comment|/* bufp-&gt;base = bufp-&gt;area; */
id|bufp-&gt;iov
(braket
l_int|0
)braket
dot
id|iov_base
op_assign
id|bufp-&gt;base
suffix:semicolon
id|bufp-&gt;iov
(braket
l_int|0
)braket
dot
id|iov_len
op_assign
id|bufp-&gt;len
op_lshift
l_int|2
suffix:semicolon
id|error
op_assign
id|svc_sendto
c_func
(paren
id|rqstp
comma
id|bufp-&gt;iov
comma
id|bufp-&gt;nriov
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
op_eq
op_minus
id|ECONNREFUSED
)paren
multiline_comment|/* ICMP error on earlier request. */
id|error
op_assign
id|svc_sendto
c_func
(paren
id|rqstp
comma
id|bufp-&gt;iov
comma
id|bufp-&gt;nriov
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
id|error
op_eq
op_minus
id|EAGAIN
)paren
multiline_comment|/* Ignore and wait for re-xmit */
id|error
op_assign
l_int|0
suffix:semicolon
r_return
id|error
suffix:semicolon
)brace
r_static
r_int
DECL|function|svc_udp_init
id|svc_udp_init
c_func
(paren
r_struct
id|svc_sock
op_star
id|svsk
)paren
(brace
id|svsk-&gt;sk_sk-&gt;data_ready
op_assign
id|svc_udp_data_ready
suffix:semicolon
id|svsk-&gt;sk_recvfrom
op_assign
id|svc_udp_recvfrom
suffix:semicolon
id|svsk-&gt;sk_sendto
op_assign
id|svc_udp_sendto
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * A state change on a listening socket means there&squot;s a connection&n; * pending.&n; */
r_static
r_void
DECL|function|svc_tcp_state_change1
id|svc_tcp_state_change1
c_func
(paren
r_struct
id|sock
op_star
id|sk
)paren
(brace
r_struct
id|svc_sock
op_star
id|svsk
suffix:semicolon
id|dprintk
c_func
(paren
l_string|&quot;svc: socket %p TCP (listen) state change %d&bslash;n&quot;
comma
id|sk
comma
id|sk-&gt;state
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sk-&gt;state
op_ne
id|TCP_ESTABLISHED
)paren
(brace
multiline_comment|/* Aborted connection, SYN_RECV or whatever... */
r_goto
id|out
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|svsk
op_assign
(paren
r_struct
id|svc_sock
op_star
)paren
id|sk-&gt;user_data
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;svc: socket %p: no user data&bslash;n&quot;
comma
id|sk
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|spin_lock_bh
c_func
(paren
op_amp
id|svsk-&gt;sk_lock
)paren
suffix:semicolon
id|svsk-&gt;sk_conn
op_increment
suffix:semicolon
id|svc_sock_enqueue
c_func
(paren
id|svsk
)paren
suffix:semicolon
id|spin_unlock_bh
c_func
(paren
op_amp
id|svsk-&gt;sk_lock
)paren
suffix:semicolon
id|out
suffix:colon
r_if
c_cond
(paren
id|sk-&gt;sleep
op_logical_and
id|waitqueue_active
c_func
(paren
id|sk-&gt;sleep
)paren
)paren
id|wake_up_interruptible_all
c_func
(paren
id|sk-&gt;sleep
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * A state change on a connected socket means it&squot;s dying or dead.&n; */
r_static
r_void
DECL|function|svc_tcp_state_change2
id|svc_tcp_state_change2
c_func
(paren
r_struct
id|sock
op_star
id|sk
)paren
(brace
r_struct
id|svc_sock
op_star
id|svsk
suffix:semicolon
id|dprintk
c_func
(paren
l_string|&quot;svc: socket %p TCP (connected) state change %d (svsk %p)&bslash;n&quot;
comma
id|sk
comma
id|sk-&gt;state
comma
id|sk-&gt;user_data
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|svsk
op_assign
(paren
r_struct
id|svc_sock
op_star
)paren
id|sk-&gt;user_data
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;svc: socket %p: no user data&bslash;n&quot;
comma
id|sk
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|spin_lock_bh
c_func
(paren
op_amp
id|svsk-&gt;sk_lock
)paren
suffix:semicolon
id|svsk-&gt;sk_close
op_assign
l_int|1
suffix:semicolon
id|svc_sock_enqueue
c_func
(paren
id|svsk
)paren
suffix:semicolon
id|spin_unlock_bh
c_func
(paren
op_amp
id|svsk-&gt;sk_lock
)paren
suffix:semicolon
id|out
suffix:colon
r_if
c_cond
(paren
id|sk-&gt;sleep
op_logical_and
id|waitqueue_active
c_func
(paren
id|sk-&gt;sleep
)paren
)paren
id|wake_up_interruptible_all
c_func
(paren
id|sk-&gt;sleep
)paren
suffix:semicolon
)brace
r_static
r_void
DECL|function|svc_tcp_data_ready
id|svc_tcp_data_ready
c_func
(paren
r_struct
id|sock
op_star
id|sk
comma
r_int
id|count
)paren
(brace
r_struct
id|svc_sock
op_star
id|svsk
suffix:semicolon
id|dprintk
c_func
(paren
l_string|&quot;svc: socket %p TCP data ready (svsk %p)&bslash;n&quot;
comma
id|sk
comma
id|sk-&gt;user_data
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|svsk
op_assign
(paren
r_struct
id|svc_sock
op_star
)paren
(paren
id|sk-&gt;user_data
)paren
)paren
)paren
r_goto
id|out
suffix:semicolon
id|spin_lock_bh
c_func
(paren
op_amp
id|svsk-&gt;sk_lock
)paren
suffix:semicolon
id|svsk-&gt;sk_data
op_increment
suffix:semicolon
id|svc_sock_enqueue
c_func
(paren
id|svsk
)paren
suffix:semicolon
id|spin_unlock_bh
c_func
(paren
op_amp
id|svsk-&gt;sk_lock
)paren
suffix:semicolon
id|out
suffix:colon
r_if
c_cond
(paren
id|sk-&gt;sleep
op_logical_and
id|waitqueue_active
c_func
(paren
id|sk-&gt;sleep
)paren
)paren
id|wake_up_interruptible
c_func
(paren
id|sk-&gt;sleep
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Accept a TCP connection&n; */
r_static
r_void
DECL|function|svc_tcp_accept
id|svc_tcp_accept
c_func
(paren
r_struct
id|svc_sock
op_star
id|svsk
)paren
(brace
r_struct
id|sockaddr_in
id|sin
suffix:semicolon
r_struct
id|svc_serv
op_star
id|serv
op_assign
id|svsk-&gt;sk_server
suffix:semicolon
r_struct
id|socket
op_star
id|sock
op_assign
id|svsk-&gt;sk_sock
suffix:semicolon
r_struct
id|socket
op_star
id|newsock
suffix:semicolon
r_struct
id|proto_ops
op_star
id|ops
suffix:semicolon
r_struct
id|svc_sock
op_star
id|newsvsk
suffix:semicolon
r_int
id|err
comma
id|slen
suffix:semicolon
id|dprintk
c_func
(paren
l_string|&quot;svc: tcp_accept %p sock %p&bslash;n&quot;
comma
id|svsk
comma
id|sock
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|sock
)paren
r_return
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|newsock
op_assign
id|sock_alloc
c_func
(paren
)paren
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: no more sockets!&bslash;n&quot;
comma
id|serv-&gt;sv_name
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|dprintk
c_func
(paren
l_string|&quot;svc: tcp_accept %p allocated&bslash;n&quot;
comma
id|newsock
)paren
suffix:semicolon
id|newsock-&gt;type
op_assign
id|sock-&gt;type
suffix:semicolon
id|newsock-&gt;ops
op_assign
id|ops
op_assign
id|sock-&gt;ops
suffix:semicolon
r_if
c_cond
(paren
(paren
id|err
op_assign
id|ops
op_member_access_from_pointer
id|accept
c_func
(paren
id|sock
comma
id|newsock
comma
id|O_NONBLOCK
)paren
)paren
OL
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|net_ratelimit
c_func
(paren
)paren
)paren
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: accept failed (err %d)!&bslash;n&quot;
comma
id|serv-&gt;sv_name
comma
op_minus
id|err
)paren
suffix:semicolon
r_goto
id|failed
suffix:semicolon
multiline_comment|/* aborted connection or whatever */
)brace
id|slen
op_assign
r_sizeof
(paren
id|sin
)paren
suffix:semicolon
id|err
op_assign
id|ops
op_member_access_from_pointer
id|getname
c_func
(paren
id|newsock
comma
(paren
r_struct
id|sockaddr
op_star
)paren
op_amp
id|sin
comma
op_amp
id|slen
comma
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
OL
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|net_ratelimit
c_func
(paren
)paren
)paren
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: peername failed (err %d)!&bslash;n&quot;
comma
id|serv-&gt;sv_name
comma
op_minus
id|err
)paren
suffix:semicolon
r_goto
id|failed
suffix:semicolon
multiline_comment|/* aborted connection or whatever */
)brace
multiline_comment|/* Ideally, we would want to reject connections from unauthorized&n;&t; * hosts here, but when we get encription, the IP of the host won&squot;t&n;&t; * tell us anything. For now just warn about unpriv connections.&n;&t; */
r_if
c_cond
(paren
id|ntohs
c_func
(paren
id|sin.sin_port
)paren
op_ge
l_int|1024
)paren
(brace
r_if
c_cond
(paren
id|net_ratelimit
c_func
(paren
)paren
)paren
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: connect from unprivileged port: %u.%u.%u.%u:%d&bslash;n&quot;
comma
id|serv-&gt;sv_name
comma
id|NIPQUAD
c_func
(paren
id|sin.sin_addr.s_addr
)paren
comma
id|ntohs
c_func
(paren
id|sin.sin_port
)paren
)paren
suffix:semicolon
)brace
id|dprintk
c_func
(paren
l_string|&quot;%s: connect from %u.%u.%u.%u:%04x&bslash;n&quot;
comma
id|serv-&gt;sv_name
comma
id|NIPQUAD
c_func
(paren
id|sin.sin_addr.s_addr
)paren
comma
id|ntohs
c_func
(paren
id|sin.sin_port
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|newsvsk
op_assign
id|svc_setup_socket
c_func
(paren
id|serv
comma
id|newsock
comma
op_amp
id|err
comma
l_int|0
)paren
)paren
)paren
r_goto
id|failed
suffix:semicolon
multiline_comment|/* Precharge. Data may have arrived on the socket before we&n;&t; * installed the data_ready callback. &n;&t; */
id|spin_lock_bh
c_func
(paren
op_amp
id|newsvsk-&gt;sk_lock
)paren
suffix:semicolon
id|newsvsk-&gt;sk_data
op_assign
l_int|1
suffix:semicolon
id|newsvsk-&gt;sk_temp
op_assign
l_int|1
suffix:semicolon
id|svc_sock_enqueue
c_func
(paren
id|newsvsk
)paren
suffix:semicolon
id|spin_unlock_bh
c_func
(paren
op_amp
id|newsvsk-&gt;sk_lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|serv-&gt;sv_stats
)paren
id|serv-&gt;sv_stats-&gt;nettcpconn
op_increment
suffix:semicolon
r_return
suffix:semicolon
id|failed
suffix:colon
id|sock_release
c_func
(paren
id|newsock
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/*&n; * Receive data from a TCP socket.&n; */
r_static
r_int
DECL|function|svc_tcp_recvfrom
id|svc_tcp_recvfrom
c_func
(paren
r_struct
id|svc_rqst
op_star
id|rqstp
)paren
(brace
r_struct
id|svc_sock
op_star
id|svsk
op_assign
id|rqstp-&gt;rq_sock
suffix:semicolon
r_struct
id|svc_serv
op_star
id|serv
op_assign
id|svsk-&gt;sk_server
suffix:semicolon
r_struct
id|svc_buf
op_star
id|bufp
op_assign
op_amp
id|rqstp-&gt;rq_argbuf
suffix:semicolon
r_int
id|len
comma
id|ready
comma
id|used
suffix:semicolon
id|dprintk
c_func
(paren
l_string|&quot;svc: tcp_recv %p data %d conn %d close %d&bslash;n&quot;
comma
id|svsk
comma
id|svsk-&gt;sk_data
comma
id|svsk-&gt;sk_conn
comma
id|svsk-&gt;sk_close
)paren
suffix:semicolon
r_if
c_cond
(paren
id|svsk-&gt;sk_close
)paren
(brace
id|svc_delete_socket
c_func
(paren
id|svsk
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|svsk-&gt;sk_conn
)paren
(brace
id|svc_tcp_accept
c_func
(paren
id|svsk
)paren
suffix:semicolon
id|svc_sock_accepted
c_func
(paren
id|svsk
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|ready
op_assign
id|svsk-&gt;sk_data
suffix:semicolon
multiline_comment|/* Receive data. If we haven&squot;t got the record length yet, get&n;&t; * the next four bytes. Otherwise try to gobble up as much as&n;&t; * possible up to the complete record length.&n;&t; */
r_if
c_cond
(paren
id|svsk-&gt;sk_tcplen
OL
l_int|4
)paren
(brace
r_int
r_int
id|want
op_assign
l_int|4
op_minus
id|svsk-&gt;sk_tcplen
suffix:semicolon
r_struct
id|iovec
id|iov
suffix:semicolon
id|iov.iov_base
op_assign
(paren
(paren
r_char
op_star
)paren
op_amp
id|svsk-&gt;sk_reclen
)paren
op_plus
id|svsk-&gt;sk_tcplen
suffix:semicolon
id|iov.iov_len
op_assign
id|want
suffix:semicolon
r_if
c_cond
(paren
(paren
id|len
op_assign
id|svc_recvfrom
c_func
(paren
id|rqstp
comma
op_amp
id|iov
comma
l_int|1
comma
id|want
)paren
)paren
OL
l_int|0
)paren
r_goto
id|error
suffix:semicolon
id|svsk-&gt;sk_tcplen
op_add_assign
id|len
suffix:semicolon
id|svsk-&gt;sk_reclen
op_assign
id|ntohl
c_func
(paren
id|svsk-&gt;sk_reclen
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|svsk-&gt;sk_reclen
op_amp
l_int|0x80000000
)paren
)paren
(brace
multiline_comment|/* FIXME: technically, a record can be fragmented,&n;&t;&t;&t; *  and non-terminal fragments will not have the top&n;&t;&t;&t; *  bit set in the fragment length header.&n;&t;&t;&t; *  But apparently no known nfs clients send fragmented&n;&t;&t;&t; *  records. */
multiline_comment|/* FIXME: shutdown socket */
id|printk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;RPC: bad TCP reclen %08lx&quot;
comma
(paren
r_int
r_int
)paren
id|svsk-&gt;sk_reclen
)paren
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
id|svsk-&gt;sk_reclen
op_and_assign
l_int|0x7fffffff
suffix:semicolon
id|dprintk
c_func
(paren
l_string|&quot;svc: TCP record, %d bytes&bslash;n&quot;
comma
id|svsk-&gt;sk_reclen
)paren
suffix:semicolon
)brace
multiline_comment|/* Check whether enough data is available */
id|len
op_assign
id|svc_recv_available
c_func
(paren
id|svsk
)paren
suffix:semicolon
r_if
c_cond
(paren
id|len
OL
l_int|0
)paren
r_goto
id|error
suffix:semicolon
r_if
c_cond
(paren
id|len
OL
id|svsk-&gt;sk_reclen
)paren
(brace
multiline_comment|/* FIXME: if sk_reclen &gt; window-size, then we will&n;&t;&t; * never be able to receive the record, so should&n;&t;&t; * shutdown the connection&n;&t;&t; */
id|dprintk
c_func
(paren
l_string|&quot;svc: incomplete TCP record (%d of %d)&bslash;n&quot;
comma
id|len
comma
id|svsk-&gt;sk_reclen
)paren
suffix:semicolon
id|svc_sock_received
c_func
(paren
id|svsk
comma
id|ready
)paren
suffix:semicolon
r_return
op_minus
id|EAGAIN
suffix:semicolon
multiline_comment|/* record not complete */
)brace
multiline_comment|/* if we think there is only one more record to read, but&n;&t; * it is bigger than we expect, then two records must have arrived&n;&t; * together, so pretend we aren&squot;t using the record.. */
r_if
c_cond
(paren
id|len
OG
id|svsk-&gt;sk_reclen
op_logical_and
id|ready
op_eq
l_int|1
)paren
id|used
op_assign
l_int|0
suffix:semicolon
r_else
id|used
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* Frob argbuf */
id|bufp-&gt;iov
(braket
l_int|0
)braket
dot
id|iov_base
op_add_assign
l_int|4
suffix:semicolon
id|bufp-&gt;iov
(braket
l_int|0
)braket
dot
id|iov_len
op_sub_assign
l_int|4
suffix:semicolon
multiline_comment|/* Now receive data */
id|len
op_assign
id|svc_recvfrom
c_func
(paren
id|rqstp
comma
id|bufp-&gt;iov
comma
id|bufp-&gt;nriov
comma
id|svsk-&gt;sk_reclen
)paren
suffix:semicolon
r_if
c_cond
(paren
id|len
OL
l_int|0
)paren
r_goto
id|error
suffix:semicolon
id|dprintk
c_func
(paren
l_string|&quot;svc: TCP complete record (%d bytes)&bslash;n&quot;
comma
id|len
)paren
suffix:semicolon
multiline_comment|/* Position reply write pointer immediately after&n;&t; * record length */
id|rqstp-&gt;rq_resbuf.buf
op_add_assign
l_int|1
suffix:semicolon
id|rqstp-&gt;rq_resbuf.len
op_assign
l_int|1
suffix:semicolon
id|rqstp-&gt;rq_skbuff
op_assign
l_int|0
suffix:semicolon
id|rqstp-&gt;rq_argbuf.buf
op_add_assign
l_int|1
suffix:semicolon
id|rqstp-&gt;rq_argbuf.len
op_assign
(paren
id|len
op_rshift
l_int|2
)paren
suffix:semicolon
id|rqstp-&gt;rq_prot
op_assign
id|IPPROTO_TCP
suffix:semicolon
multiline_comment|/* Reset TCP read info */
id|svsk-&gt;sk_reclen
op_assign
l_int|0
suffix:semicolon
id|svsk-&gt;sk_tcplen
op_assign
l_int|0
suffix:semicolon
id|svc_sock_received
c_func
(paren
id|svsk
comma
id|used
)paren
suffix:semicolon
r_if
c_cond
(paren
id|serv-&gt;sv_stats
)paren
id|serv-&gt;sv_stats-&gt;nettcpcnt
op_increment
suffix:semicolon
r_return
id|len
suffix:semicolon
id|error
suffix:colon
r_if
c_cond
(paren
id|len
op_eq
op_minus
id|EAGAIN
)paren
(brace
id|dprintk
c_func
(paren
l_string|&quot;RPC: TCP recvfrom got EAGAIN&bslash;n&quot;
)paren
suffix:semicolon
id|svc_sock_received
c_func
(paren
id|svsk
comma
id|ready
)paren
suffix:semicolon
multiline_comment|/* Clear data ready */
)brace
r_else
(brace
id|printk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;%s: recvfrom returned errno %d&bslash;n&quot;
comma
id|svsk-&gt;sk_server-&gt;sv_name
comma
op_minus
id|len
)paren
suffix:semicolon
id|svc_sock_received
c_func
(paren
id|svsk
comma
l_int|0
)paren
suffix:semicolon
)brace
r_return
id|len
suffix:semicolon
)brace
multiline_comment|/*&n; * Send out data on TCP socket.&n; * FIXME: Make the sendto call non-blocking in order not to hang&n; * a daemon on a dead client. Requires write queue maintenance.&n; */
r_static
r_int
DECL|function|svc_tcp_sendto
id|svc_tcp_sendto
c_func
(paren
r_struct
id|svc_rqst
op_star
id|rqstp
)paren
(brace
r_struct
id|svc_buf
op_star
id|bufp
op_assign
op_amp
id|rqstp-&gt;rq_resbuf
suffix:semicolon
r_int
id|sent
suffix:semicolon
multiline_comment|/* Set up the first element of the reply iovec.&n;&t; * Any other iovecs that may be in use have been taken&n;&t; * care of by the server implementation itself.&n;&t; */
id|bufp-&gt;iov
(braket
l_int|0
)braket
dot
id|iov_base
op_assign
id|bufp-&gt;base
suffix:semicolon
id|bufp-&gt;iov
(braket
l_int|0
)braket
dot
id|iov_len
op_assign
id|bufp-&gt;len
op_lshift
l_int|2
suffix:semicolon
id|bufp-&gt;base
(braket
l_int|0
)braket
op_assign
id|htonl
c_func
(paren
l_int|0x80000000
op_or
(paren
(paren
id|bufp-&gt;len
op_lshift
l_int|2
)paren
op_minus
l_int|4
)paren
)paren
suffix:semicolon
id|sent
op_assign
id|svc_sendto
c_func
(paren
id|rqstp
comma
id|bufp-&gt;iov
comma
id|bufp-&gt;nriov
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sent
op_ne
id|bufp-&gt;len
op_lshift
l_int|2
)paren
(brace
id|printk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;rpc-srv/tcp: %s: sent only %d bytes of %d - should shutdown socket&bslash;n&quot;
comma
id|rqstp-&gt;rq_sock-&gt;sk_server-&gt;sv_name
comma
id|sent
comma
id|bufp-&gt;len
op_lshift
l_int|2
)paren
suffix:semicolon
multiline_comment|/* FIXME: should shutdown the socket, or allocate more memort&n;&t;&t; * or wait and try again or something.  Otherwise&n;&t;&t; * client will get confused&n;&t;&t; */
)brace
r_return
id|sent
suffix:semicolon
)brace
r_static
r_int
DECL|function|svc_tcp_init
id|svc_tcp_init
c_func
(paren
r_struct
id|svc_sock
op_star
id|svsk
)paren
(brace
r_struct
id|sock
op_star
id|sk
op_assign
id|svsk-&gt;sk_sk
suffix:semicolon
id|svsk-&gt;sk_recvfrom
op_assign
id|svc_tcp_recvfrom
suffix:semicolon
id|svsk-&gt;sk_sendto
op_assign
id|svc_tcp_sendto
suffix:semicolon
r_if
c_cond
(paren
id|sk-&gt;state
op_eq
id|TCP_LISTEN
)paren
(brace
id|dprintk
c_func
(paren
l_string|&quot;setting up TCP socket for listening&bslash;n&quot;
)paren
suffix:semicolon
id|sk-&gt;state_change
op_assign
id|svc_tcp_state_change1
suffix:semicolon
)brace
r_else
(brace
id|dprintk
c_func
(paren
l_string|&quot;setting up TCP socket for reading&bslash;n&quot;
)paren
suffix:semicolon
id|sk-&gt;state_change
op_assign
id|svc_tcp_state_change2
suffix:semicolon
id|sk-&gt;data_ready
op_assign
id|svc_tcp_data_ready
suffix:semicolon
id|svsk-&gt;sk_reclen
op_assign
l_int|0
suffix:semicolon
id|svsk-&gt;sk_tcplen
op_assign
l_int|0
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * Receive the next request on any socket.&n; */
r_int
DECL|function|svc_recv
id|svc_recv
c_func
(paren
r_struct
id|svc_serv
op_star
id|serv
comma
r_struct
id|svc_rqst
op_star
id|rqstp
comma
r_int
id|timeout
)paren
(brace
r_struct
id|svc_sock
op_star
id|svsk
suffix:semicolon
r_int
id|len
suffix:semicolon
id|DECLARE_WAITQUEUE
c_func
(paren
id|wait
comma
id|current
)paren
suffix:semicolon
id|dprintk
c_func
(paren
l_string|&quot;svc: server %p waiting for data (to = %ld)&bslash;n&quot;
comma
id|rqstp
comma
id|timeout
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rqstp-&gt;rq_sock
)paren
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;svc_recv: service %p, socket not NULL!&bslash;n&quot;
comma
id|rqstp
)paren
suffix:semicolon
r_if
c_cond
(paren
id|waitqueue_active
c_func
(paren
op_amp
id|rqstp-&gt;rq_wait
)paren
)paren
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;svc_recv: service %p, wait queue active!&bslash;n&quot;
comma
id|rqstp
)paren
suffix:semicolon
multiline_comment|/* Initialize the buffers */
id|rqstp-&gt;rq_argbuf
op_assign
id|rqstp-&gt;rq_defbuf
suffix:semicolon
id|rqstp-&gt;rq_resbuf
op_assign
id|rqstp-&gt;rq_defbuf
suffix:semicolon
r_if
c_cond
(paren
id|signalled
c_func
(paren
)paren
)paren
r_return
op_minus
id|EINTR
suffix:semicolon
id|spin_lock_bh
c_func
(paren
op_amp
id|serv-&gt;sv_lock
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|svsk
op_assign
id|svc_sock_dequeue
c_func
(paren
id|serv
)paren
)paren
op_ne
l_int|NULL
)paren
(brace
id|rqstp-&gt;rq_sock
op_assign
id|svsk
suffix:semicolon
id|svsk-&gt;sk_inuse
op_increment
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* No data pending. Go to sleep */
id|svc_serv_enqueue
c_func
(paren
id|serv
comma
id|rqstp
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t; * We have to be able to interrupt this wait&n;&t;&t; * to bring down the daemons ...&n;&t;&t; */
id|set_current_state
c_func
(paren
id|TASK_INTERRUPTIBLE
)paren
suffix:semicolon
id|add_wait_queue
c_func
(paren
op_amp
id|rqstp-&gt;rq_wait
comma
op_amp
id|wait
)paren
suffix:semicolon
id|spin_unlock_bh
c_func
(paren
op_amp
id|serv-&gt;sv_lock
)paren
suffix:semicolon
id|schedule_timeout
c_func
(paren
id|timeout
)paren
suffix:semicolon
id|spin_lock_bh
c_func
(paren
op_amp
id|serv-&gt;sv_lock
)paren
suffix:semicolon
id|remove_wait_queue
c_func
(paren
op_amp
id|rqstp-&gt;rq_wait
comma
op_amp
id|wait
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|svsk
op_assign
id|rqstp-&gt;rq_sock
)paren
)paren
(brace
id|svc_serv_dequeue
c_func
(paren
id|serv
comma
id|rqstp
)paren
suffix:semicolon
id|spin_unlock_bh
c_func
(paren
op_amp
id|serv-&gt;sv_lock
)paren
suffix:semicolon
id|dprintk
c_func
(paren
l_string|&quot;svc: server %p, no data yet&bslash;n&quot;
comma
id|rqstp
)paren
suffix:semicolon
r_return
id|signalled
c_func
(paren
)paren
ques
c_cond
op_minus
id|EINTR
suffix:colon
op_minus
id|EAGAIN
suffix:semicolon
)brace
)brace
id|spin_unlock_bh
c_func
(paren
op_amp
id|serv-&gt;sv_lock
)paren
suffix:semicolon
id|dprintk
c_func
(paren
l_string|&quot;svc: server %p, socket %p, inuse=%d&bslash;n&quot;
comma
id|rqstp
comma
id|svsk
comma
id|svsk-&gt;sk_inuse
)paren
suffix:semicolon
id|len
op_assign
id|svsk
op_member_access_from_pointer
id|sk_recvfrom
c_func
(paren
id|rqstp
)paren
suffix:semicolon
id|dprintk
c_func
(paren
l_string|&quot;svc: got len=%d&bslash;n&quot;
comma
id|len
)paren
suffix:semicolon
multiline_comment|/* No data, incomplete (TCP) read, or accept() */
r_if
c_cond
(paren
id|len
op_eq
l_int|0
op_logical_or
id|len
op_eq
op_minus
id|EAGAIN
)paren
(brace
id|svc_sock_release
c_func
(paren
id|rqstp
)paren
suffix:semicolon
r_return
op_minus
id|EAGAIN
suffix:semicolon
)brace
id|rqstp-&gt;rq_secure
op_assign
id|ntohs
c_func
(paren
id|rqstp-&gt;rq_addr.sin_port
)paren
OL
l_int|1024
suffix:semicolon
id|rqstp-&gt;rq_userset
op_assign
l_int|0
suffix:semicolon
id|rqstp-&gt;rq_verfed
op_assign
l_int|0
suffix:semicolon
id|svc_getlong
c_func
(paren
op_amp
id|rqstp-&gt;rq_argbuf
comma
id|rqstp-&gt;rq_xid
)paren
suffix:semicolon
id|svc_putlong
c_func
(paren
op_amp
id|rqstp-&gt;rq_resbuf
comma
id|rqstp-&gt;rq_xid
)paren
suffix:semicolon
multiline_comment|/* Assume that the reply consists of a single buffer. */
id|rqstp-&gt;rq_resbuf.nriov
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|serv-&gt;sv_stats
)paren
id|serv-&gt;sv_stats-&gt;netcnt
op_increment
suffix:semicolon
r_return
id|len
suffix:semicolon
)brace
multiline_comment|/* &n; * Drop request&n; */
r_void
DECL|function|svc_drop
id|svc_drop
c_func
(paren
r_struct
id|svc_rqst
op_star
id|rqstp
)paren
(brace
id|dprintk
c_func
(paren
l_string|&quot;svc: socket %p dropped request&bslash;n&quot;
comma
id|rqstp-&gt;rq_sock
)paren
suffix:semicolon
id|svc_sock_release
c_func
(paren
id|rqstp
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Return reply to client.&n; */
r_int
DECL|function|svc_send
id|svc_send
c_func
(paren
r_struct
id|svc_rqst
op_star
id|rqstp
)paren
(brace
r_struct
id|svc_sock
op_star
id|svsk
suffix:semicolon
r_int
id|len
suffix:semicolon
r_if
c_cond
(paren
(paren
id|svsk
op_assign
id|rqstp-&gt;rq_sock
)paren
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;NULL socket pointer in %s:%d&bslash;n&quot;
comma
id|__FILE__
comma
id|__LINE__
)paren
suffix:semicolon
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
multiline_comment|/* release the receive skb before sending the reply */
id|svc_release_skb
c_func
(paren
id|rqstp
)paren
suffix:semicolon
id|len
op_assign
id|svsk
op_member_access_from_pointer
id|sk_sendto
c_func
(paren
id|rqstp
)paren
suffix:semicolon
id|svc_sock_release
c_func
(paren
id|rqstp
)paren
suffix:semicolon
r_if
c_cond
(paren
id|len
op_eq
op_minus
id|ECONNREFUSED
op_logical_or
id|len
op_eq
op_minus
id|ENOTCONN
op_logical_or
id|len
op_eq
op_minus
id|EAGAIN
)paren
r_return
l_int|0
suffix:semicolon
r_return
id|len
suffix:semicolon
)brace
multiline_comment|/*&n; * Initialize socket for RPC use and create svc_sock struct&n; * XXX: May want to setsockopt SO_SNDBUF and SO_RCVBUF.&n; */
r_static
r_struct
id|svc_sock
op_star
DECL|function|svc_setup_socket
id|svc_setup_socket
c_func
(paren
r_struct
id|svc_serv
op_star
id|serv
comma
r_struct
id|socket
op_star
id|sock
comma
r_int
op_star
id|errp
comma
r_int
id|pmap_register
)paren
(brace
r_struct
id|svc_sock
op_star
id|svsk
suffix:semicolon
r_struct
id|sock
op_star
id|inet
suffix:semicolon
id|dprintk
c_func
(paren
l_string|&quot;svc: svc_setup_socket %p&bslash;n&quot;
comma
id|sock
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|svsk
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
op_star
id|svsk
)paren
comma
id|GFP_KERNEL
)paren
)paren
)paren
(brace
op_star
id|errp
op_assign
op_minus
id|ENOMEM
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
id|memset
c_func
(paren
id|svsk
comma
l_int|0
comma
r_sizeof
(paren
op_star
id|svsk
)paren
)paren
suffix:semicolon
id|inet
op_assign
id|sock-&gt;sk
suffix:semicolon
id|inet-&gt;user_data
op_assign
id|svsk
suffix:semicolon
id|svsk-&gt;sk_sock
op_assign
id|sock
suffix:semicolon
id|svsk-&gt;sk_sk
op_assign
id|inet
suffix:semicolon
id|svsk-&gt;sk_ostate
op_assign
id|inet-&gt;state_change
suffix:semicolon
id|svsk-&gt;sk_odata
op_assign
id|inet-&gt;data_ready
suffix:semicolon
id|svsk-&gt;sk_server
op_assign
id|serv
suffix:semicolon
id|spin_lock_init
c_func
(paren
op_amp
id|svsk-&gt;sk_lock
)paren
suffix:semicolon
multiline_comment|/* Initialize the socket */
r_if
c_cond
(paren
id|sock-&gt;type
op_eq
id|SOCK_DGRAM
)paren
op_star
id|errp
op_assign
id|svc_udp_init
c_func
(paren
id|svsk
)paren
suffix:semicolon
r_else
op_star
id|errp
op_assign
id|svc_tcp_init
c_func
(paren
id|svsk
)paren
suffix:semicolon
r_if
c_cond
(paren
id|svsk-&gt;sk_sk
op_eq
l_int|NULL
)paren
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;svsk-&gt;sk_sk == NULL after svc_prot_init!&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* Register socket with portmapper */
r_if
c_cond
(paren
op_star
id|errp
op_ge
l_int|0
op_logical_and
id|pmap_register
)paren
op_star
id|errp
op_assign
id|svc_register
c_func
(paren
id|serv
comma
id|inet-&gt;protocol
comma
id|ntohs
c_func
(paren
id|inet-&gt;sport
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_star
id|errp
OL
l_int|0
)paren
(brace
id|inet-&gt;user_data
op_assign
l_int|NULL
suffix:semicolon
id|kfree
c_func
(paren
id|svsk
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
id|spin_lock_bh
c_func
(paren
op_amp
id|serv-&gt;sv_lock
)paren
suffix:semicolon
id|svsk-&gt;sk_list
op_assign
id|serv-&gt;sv_allsocks
suffix:semicolon
id|serv-&gt;sv_allsocks
op_assign
id|svsk
suffix:semicolon
id|spin_unlock_bh
c_func
(paren
op_amp
id|serv-&gt;sv_lock
)paren
suffix:semicolon
id|dprintk
c_func
(paren
l_string|&quot;svc: svc_setup_socket created %p (inet %p)&bslash;n&quot;
comma
id|svsk
comma
id|svsk-&gt;sk_sk
)paren
suffix:semicolon
r_return
id|svsk
suffix:semicolon
)brace
multiline_comment|/*&n; * Create socket for RPC service.&n; */
r_static
r_int
DECL|function|svc_create_socket
id|svc_create_socket
c_func
(paren
r_struct
id|svc_serv
op_star
id|serv
comma
r_int
id|protocol
comma
r_struct
id|sockaddr_in
op_star
id|sin
)paren
(brace
r_struct
id|svc_sock
op_star
id|svsk
suffix:semicolon
r_struct
id|socket
op_star
id|sock
suffix:semicolon
r_int
id|error
suffix:semicolon
r_int
id|type
suffix:semicolon
id|dprintk
c_func
(paren
l_string|&quot;svc: svc_create_socket(%s, %d, %u.%u.%u.%u:%d)&bslash;n&quot;
comma
id|serv-&gt;sv_program-&gt;pg_name
comma
id|protocol
comma
id|NIPQUAD
c_func
(paren
id|sin-&gt;sin_addr.s_addr
)paren
comma
id|ntohs
c_func
(paren
id|sin-&gt;sin_port
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|protocol
op_ne
id|IPPROTO_UDP
op_logical_and
id|protocol
op_ne
id|IPPROTO_TCP
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;svc: only UDP and TCP &quot;
l_string|&quot;sockets supported&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|type
op_assign
(paren
id|protocol
op_eq
id|IPPROTO_UDP
)paren
ques
c_cond
id|SOCK_DGRAM
suffix:colon
id|SOCK_STREAM
suffix:semicolon
r_if
c_cond
(paren
(paren
id|error
op_assign
id|sock_create
c_func
(paren
id|PF_INET
comma
id|type
comma
id|protocol
comma
op_amp
id|sock
)paren
)paren
OL
l_int|0
)paren
r_return
id|error
suffix:semicolon
r_if
c_cond
(paren
id|sin
op_ne
l_int|NULL
)paren
(brace
id|error
op_assign
id|sock-&gt;ops
op_member_access_from_pointer
id|bind
c_func
(paren
id|sock
comma
(paren
r_struct
id|sockaddr
op_star
)paren
id|sin
comma
r_sizeof
(paren
op_star
id|sin
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
OL
l_int|0
)paren
r_goto
id|bummer
suffix:semicolon
)brace
r_if
c_cond
(paren
id|protocol
op_eq
id|IPPROTO_TCP
)paren
(brace
r_if
c_cond
(paren
(paren
id|error
op_assign
id|sock-&gt;ops
op_member_access_from_pointer
id|listen
c_func
(paren
id|sock
comma
l_int|5
)paren
)paren
OL
l_int|0
)paren
r_goto
id|bummer
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|svsk
op_assign
id|svc_setup_socket
c_func
(paren
id|serv
comma
id|sock
comma
op_amp
id|error
comma
l_int|1
)paren
)paren
op_ne
l_int|NULL
)paren
r_return
l_int|0
suffix:semicolon
id|bummer
suffix:colon
id|dprintk
c_func
(paren
l_string|&quot;svc: svc_create_socket error = %d&bslash;n&quot;
comma
op_minus
id|error
)paren
suffix:semicolon
id|sock_release
c_func
(paren
id|sock
)paren
suffix:semicolon
r_return
id|error
suffix:semicolon
)brace
multiline_comment|/*&n; * Remove a dead socket&n; */
r_void
DECL|function|svc_delete_socket
id|svc_delete_socket
c_func
(paren
r_struct
id|svc_sock
op_star
id|svsk
)paren
(brace
r_struct
id|svc_sock
op_star
op_star
id|rsk
suffix:semicolon
r_struct
id|svc_serv
op_star
id|serv
suffix:semicolon
r_struct
id|sock
op_star
id|sk
suffix:semicolon
id|dprintk
c_func
(paren
l_string|&quot;svc: svc_delete_socket(%p)&bslash;n&quot;
comma
id|svsk
)paren
suffix:semicolon
id|serv
op_assign
id|svsk-&gt;sk_server
suffix:semicolon
id|sk
op_assign
id|svsk-&gt;sk_sk
suffix:semicolon
id|sk-&gt;state_change
op_assign
id|svsk-&gt;sk_ostate
suffix:semicolon
id|sk-&gt;data_ready
op_assign
id|svsk-&gt;sk_odata
suffix:semicolon
id|spin_lock_bh
c_func
(paren
op_amp
id|serv-&gt;sv_lock
)paren
suffix:semicolon
r_for
c_loop
(paren
id|rsk
op_assign
op_amp
id|serv-&gt;sv_allsocks
suffix:semicolon
op_star
id|rsk
suffix:semicolon
id|rsk
op_assign
op_amp
(paren
op_star
id|rsk
)paren
op_member_access_from_pointer
id|sk_list
)paren
(brace
r_if
c_cond
(paren
op_star
id|rsk
op_eq
id|svsk
)paren
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
op_star
id|rsk
)paren
(brace
id|spin_unlock_bh
c_func
(paren
op_amp
id|serv-&gt;sv_lock
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
op_star
id|rsk
op_assign
id|svsk-&gt;sk_list
suffix:semicolon
r_if
c_cond
(paren
id|svsk-&gt;sk_qued
)paren
id|rpc_remove_list
c_func
(paren
op_amp
id|serv-&gt;sv_sockets
comma
id|svsk
)paren
suffix:semicolon
id|spin_unlock_bh
c_func
(paren
op_amp
id|serv-&gt;sv_lock
)paren
suffix:semicolon
id|svsk-&gt;sk_dead
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|svsk-&gt;sk_inuse
)paren
(brace
id|sock_release
c_func
(paren
id|svsk-&gt;sk_sock
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|svsk
)paren
suffix:semicolon
)brace
r_else
(brace
id|printk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;svc: server socket destroy delayed&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* svsk-&gt;sk_server = NULL; */
)brace
)brace
multiline_comment|/*&n; * Make a socket for nfsd and lockd&n; */
r_int
DECL|function|svc_makesock
id|svc_makesock
c_func
(paren
r_struct
id|svc_serv
op_star
id|serv
comma
r_int
id|protocol
comma
r_int
r_int
id|port
)paren
(brace
r_struct
id|sockaddr_in
id|sin
suffix:semicolon
id|dprintk
c_func
(paren
l_string|&quot;svc: creating socket proto = %d&bslash;n&quot;
comma
id|protocol
)paren
suffix:semicolon
id|sin.sin_family
op_assign
id|AF_INET
suffix:semicolon
id|sin.sin_addr.s_addr
op_assign
id|INADDR_ANY
suffix:semicolon
id|sin.sin_port
op_assign
id|htons
c_func
(paren
id|port
)paren
suffix:semicolon
r_return
id|svc_create_socket
c_func
(paren
id|serv
comma
id|protocol
comma
op_amp
id|sin
)paren
suffix:semicolon
)brace
eof
