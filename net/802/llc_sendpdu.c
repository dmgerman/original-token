multiline_comment|/*&n; * NET&t;&t;An implementation of the IEEE 802.2 LLC protocol for the&n; *&t;&t;LINUX operating system.  LLC is implemented as a set of &n; *&t;&t;state machines and callbacks for higher networking layers.&n; *&n; *&t;&t;llc_sendpdu(), llc_sendipdu(), resend() + queue handling code&n; *&n; *&t;&t;Written by Tim Alpaerts, Tim_Alpaerts@toyota-motor-europe.com&n; *&n; *&t;&t;This program is free software; you can redistribute it and/or&n; *&t;&t;modify it under the terms of the GNU General Public License&n; *&t;&t;as published by the Free Software Foundation; either version&n; *&t;&t;2 of the License, or (at your option) any later version.&n; *&n; *&t;Changes&n; *&t;&t;Alan Cox&t;:&t;Chainsawed into Linux format, style&n; *&t;&t;&t;&t;&t;Added llc_ to function names&n; */
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/malloc.h&gt;
macro_line|#include &lt;linux/netdevice.h&gt;
macro_line|#include &lt;linux/skbuff.h&gt;
macro_line|#include &lt;net/p8022.h&gt;
macro_line|#include &lt;linux/stat.h&gt;
macro_line|#include &lt;asm/byteorder.h&gt;
macro_line|#include &lt;net/llc_frame.h&gt;
macro_line|#include &lt;net/llc.h&gt;
DECL|variable|cntl_byte_encode
r_static
r_int
r_char
id|cntl_byte_encode
(braket
)braket
op_assign
(brace
l_int|0x00
comma
multiline_comment|/* I_CMD */
l_int|0x01
comma
multiline_comment|/* RR_CMD */
l_int|0x05
comma
multiline_comment|/* RNR_CMD */
l_int|0x09
comma
multiline_comment|/* REJ_CMD */
l_int|0x43
comma
multiline_comment|/* DISC_CMD */
l_int|0x7F
comma
multiline_comment|/* SABME_CMD */
l_int|0x00
comma
multiline_comment|/* I_RSP */
l_int|0x01
comma
multiline_comment|/* RR_RSP */
l_int|0x05
comma
multiline_comment|/* RNR_RSP */
l_int|0x09
comma
multiline_comment|/* REJ_RSP */
l_int|0x63
comma
multiline_comment|/* UA_RSP */
l_int|0x0F
comma
multiline_comment|/* DM_RSP */
l_int|0x87
comma
multiline_comment|/* FRMR_RSP */
l_int|0xFF
comma
multiline_comment|/* BAD_FRAME */
l_int|0x03
comma
multiline_comment|/* UI_CMD */
l_int|0xBF
comma
multiline_comment|/* XID_CMD */
l_int|0xE3
comma
multiline_comment|/* TEST_CMD */
l_int|0xBF
comma
multiline_comment|/* XID_RSP */
l_int|0xE3
multiline_comment|/* TEST_RSP */
)brace
suffix:semicolon
DECL|variable|fr_length_encode
r_static
r_int
r_char
id|fr_length_encode
(braket
)braket
op_assign
(brace
l_int|0x04
comma
multiline_comment|/* I_CMD */
l_int|0x04
comma
multiline_comment|/* RR_CMD */
l_int|0x04
comma
multiline_comment|/* RNR_CMD */
l_int|0x04
comma
multiline_comment|/* REJ_CMD */
l_int|0x03
comma
multiline_comment|/* DISC_CMD */
l_int|0x03
comma
multiline_comment|/* SABME_CMD */
l_int|0x04
comma
multiline_comment|/* I_RSP */
l_int|0x04
comma
multiline_comment|/* RR_RSP */
l_int|0x04
comma
multiline_comment|/* RNR_RSP */
l_int|0x04
comma
multiline_comment|/* REJ_RSP */
l_int|0x03
comma
multiline_comment|/* UA_RSP */
l_int|0x03
comma
multiline_comment|/* DM_RSP */
l_int|0x03
comma
multiline_comment|/* FRMR_RSP */
l_int|0x00
comma
multiline_comment|/* BAD_FRAME */
l_int|0x03
comma
multiline_comment|/* UI_CMD */
l_int|0x03
comma
multiline_comment|/* XID_CMD */
l_int|0x03
comma
multiline_comment|/* TEST_CMD */
l_int|0x03
comma
multiline_comment|/* XID_RSP */
l_int|0x03
multiline_comment|/* TEST_RSP */
)brace
suffix:semicolon
DECL|variable|cr_bit_encode
r_static
r_int
r_char
id|cr_bit_encode
(braket
)braket
op_assign
(brace
l_int|0x00
comma
multiline_comment|/* I_CMD */
l_int|0x00
comma
multiline_comment|/* RR_CMD */
l_int|0x00
comma
multiline_comment|/* RNR_CMD */
l_int|0x00
comma
multiline_comment|/* REJ_CMD */
l_int|0x00
comma
multiline_comment|/* DISC_CMD */
l_int|0x00
comma
multiline_comment|/* SABME_CMD */
l_int|0x01
comma
multiline_comment|/* I_RSP */
l_int|0x01
comma
multiline_comment|/* RR_RSP */
l_int|0x01
comma
multiline_comment|/* RNR_RSP */
l_int|0x01
comma
multiline_comment|/* REJ_RSP */
l_int|0x01
comma
multiline_comment|/* UA_RSP */
l_int|0x01
comma
multiline_comment|/* DM_RSP */
l_int|0x01
comma
multiline_comment|/* FRMR_RSP */
l_int|0x00
comma
multiline_comment|/* BAD_FRAME */
l_int|0x00
comma
multiline_comment|/* UI_CMD */
l_int|0x00
comma
multiline_comment|/* XID_CMD */
l_int|0x00
comma
multiline_comment|/* TEST_CMD */
l_int|0x01
comma
multiline_comment|/* XID_RSP */
l_int|0x01
multiline_comment|/* TEST_RSP */
)brace
suffix:semicolon
multiline_comment|/*&n; *&t;Sendpdu() constructs an output frame in a new skb and&n; *&t;gives it to the MAC layer for transmision.&n; *&t;This function is not used to send I pdus.&n; *&t;No queues are updated here, nothing is saved for retransmission.&n; *&n; *&t;Parameter pf controls both the poll/final bit and dsap&n; *&t;fields in the output pdu. &n; *&t;The dsap trick was needed to implement XID_CMD send with&n; *&t;zero dsap field as described in doc 6.6 item 1 of enum.  &n; */
DECL|function|llc_sendpdu
r_void
id|llc_sendpdu
c_func
(paren
id|llcptr
id|lp
comma
r_char
id|type
comma
r_char
id|pf
comma
r_int
id|data_len
comma
r_char
op_star
id|pdu_data
)paren
(brace
id|frameptr
id|fr
suffix:semicolon
multiline_comment|/* ptr to output pdu buffer */
r_int
r_int
r_int
id|fl
suffix:semicolon
multiline_comment|/* frame length == 802.3 &quot;length&quot; value */
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
id|fl
op_assign
id|data_len
op_plus
id|fr_length_encode
(braket
(paren
r_int
)paren
id|type
)braket
suffix:semicolon
id|skb
op_assign
id|alloc_skb
c_func
(paren
l_int|16
op_plus
id|fl
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
id|skb
op_ne
l_int|NULL
)paren
(brace
id|skb-&gt;dev
op_assign
id|lp-&gt;dev
suffix:semicolon
id|skb_reserve
c_func
(paren
id|skb
comma
l_int|16
)paren
suffix:semicolon
id|fr
op_assign
(paren
id|frameptr
)paren
id|skb_put
c_func
(paren
id|skb
comma
id|fl
)paren
suffix:semicolon
id|memset
c_func
(paren
id|fr
comma
l_int|0
comma
id|fl
)paren
suffix:semicolon
multiline_comment|/*&n;                 *&t;Construct 802.2 header &n;                 */
r_if
c_cond
(paren
id|pf
op_amp
l_int|0x02
)paren
id|fr-&gt;pdu_hdr.dsap
op_assign
l_int|0
suffix:semicolon
r_else
id|fr-&gt;pdu_hdr.dsap
op_assign
id|lp-&gt;remote_sap
suffix:semicolon
id|fr-&gt;pdu_hdr.ssap
op_assign
id|lp-&gt;local_sap
op_plus
id|cr_bit_encode
(braket
(paren
r_int
)paren
id|type
)braket
suffix:semicolon
id|fr-&gt;pdu_cntl.byte1
op_assign
id|cntl_byte_encode
(braket
(paren
r_int
)paren
id|type
)braket
suffix:semicolon
multiline_comment|/* &n;&t;&t; *&t;Fill in pflag and seq nbrs: &n;&t;&t; */
r_if
c_cond
(paren
id|IS_SFRAME
c_func
(paren
id|fr
)paren
)paren
(brace
multiline_comment|/* case S-frames */
r_if
c_cond
(paren
id|pf
op_amp
l_int|0x01
)paren
id|fr-&gt;i_hdr.i_pflag
op_assign
l_int|1
suffix:semicolon
id|fr-&gt;i_hdr.nr
op_assign
id|lp-&gt;vr
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* case U frames */
r_if
c_cond
(paren
id|pf
op_amp
l_int|0x01
)paren
id|fr-&gt;u_hdr.u_pflag
op_assign
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|data_len
OG
l_int|0
)paren
(brace
multiline_comment|/* append data if any  */
r_if
c_cond
(paren
id|IS_UFRAME
c_func
(paren
id|fr
)paren
)paren
(brace
id|memcpy
c_func
(paren
id|fr-&gt;u_hdr.u_info
comma
id|pdu_data
comma
id|data_len
)paren
suffix:semicolon
)brace
r_else
(brace
id|memcpy
c_func
(paren
id|fr-&gt;i_hdr.is_info
comma
id|pdu_data
comma
id|data_len
)paren
suffix:semicolon
)brace
)brace
id|lp-&gt;dev
op_member_access_from_pointer
id|hard_header
c_func
(paren
id|skb
comma
id|lp-&gt;dev
comma
id|ETH_P_802_3
comma
id|lp-&gt;remote_mac
comma
l_int|NULL
comma
id|fl
)paren
suffix:semicolon
id|skb-&gt;dev
op_assign
id|lp-&gt;dev
suffix:semicolon
id|dev_queue_xmit
c_func
(paren
id|skb
)paren
suffix:semicolon
)brace
r_else
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;cl2llc: skb_alloc() in llc_sendpdu() failed&bslash;n&quot;
)paren
suffix:semicolon
)brace
DECL|function|llc_xid_request
r_void
id|llc_xid_request
c_func
(paren
id|llcptr
id|lp
comma
r_char
id|opt
comma
r_int
id|ll
comma
r_char
op_star
id|data
)paren
(brace
id|llc_sendpdu
c_func
(paren
id|lp
comma
id|XID_CMD
comma
id|opt
comma
id|ll
comma
id|data
)paren
suffix:semicolon
)brace
DECL|function|llc_test_request
r_void
id|llc_test_request
c_func
(paren
id|llcptr
id|lp
comma
r_int
id|ll
comma
r_char
op_star
id|data
)paren
(brace
id|llc_sendpdu
c_func
(paren
id|lp
comma
id|TEST_CMD
comma
l_int|0
comma
id|ll
comma
id|data
)paren
suffix:semicolon
)brace
DECL|function|llc_unit_data_request
r_void
id|llc_unit_data_request
c_func
(paren
id|llcptr
id|lp
comma
r_int
id|ll
comma
r_char
op_star
id|data
)paren
(brace
id|llc_sendpdu
c_func
(paren
id|lp
comma
id|UI_CMD
comma
l_int|0
comma
id|ll
comma
id|data
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;llc_sendipdu() Completes an I pdu in an existing skb and gives it&n; *&t;to the MAC layer for transmision.&n; *&t;Parameter &quot;type&quot; must be either I_CMD or I_RSP.&n; *&t;The skb is not freed after xmit, it is kept in case a retransmission&n; *&t;is requested. If needed it can be picked up again from the rtq.&n; */
DECL|function|llc_sendipdu
r_void
id|llc_sendipdu
c_func
(paren
id|llcptr
id|lp
comma
r_char
id|type
comma
r_char
id|pf
comma
r_struct
id|sk_buff
op_star
id|skb
)paren
(brace
id|frameptr
id|fr
suffix:semicolon
multiline_comment|/* ptr to output pdu buffer */
r_struct
id|sk_buff
op_star
id|tmp
suffix:semicolon
id|fr
op_assign
(paren
id|frameptr
)paren
id|skb-&gt;data
suffix:semicolon
id|fr-&gt;pdu_hdr.dsap
op_assign
id|lp-&gt;remote_sap
suffix:semicolon
id|fr-&gt;pdu_hdr.ssap
op_assign
id|lp-&gt;local_sap
op_plus
id|cr_bit_encode
(braket
(paren
r_int
)paren
id|type
)braket
suffix:semicolon
id|fr-&gt;pdu_cntl.byte1
op_assign
id|cntl_byte_encode
(braket
(paren
r_int
)paren
id|type
)braket
suffix:semicolon
r_if
c_cond
(paren
id|pf
)paren
id|fr-&gt;i_hdr.i_pflag
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* p/f and seq numbers */
id|fr-&gt;i_hdr.nr
op_assign
id|lp-&gt;vr
suffix:semicolon
id|fr-&gt;i_hdr.ns
op_assign
id|lp-&gt;vs
suffix:semicolon
id|lp-&gt;vs
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|lp-&gt;vs
OG
l_int|127
)paren
id|lp-&gt;vs
op_assign
l_int|0
suffix:semicolon
id|lp-&gt;dev
op_member_access_from_pointer
id|hard_header
c_func
(paren
id|skb
comma
id|lp-&gt;dev
comma
id|ETH_P_802_3
comma
id|lp-&gt;remote_mac
comma
l_int|NULL
comma
id|skb-&gt;len
)paren
suffix:semicolon
id|ADD_TO_RTQ
c_func
(paren
id|skb
)paren
suffix:semicolon
multiline_comment|/* add skb to the retransmit queue */
id|tmp
op_assign
id|skb_clone
c_func
(paren
id|skb
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tmp
op_ne
l_int|NULL
)paren
(brace
id|tmp-&gt;dev
op_assign
id|lp-&gt;dev
suffix:semicolon
id|dev_queue_xmit
c_func
(paren
id|tmp
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/*&n; *&t;Resend_ipdu() will resend the pdus in the retransmit queue (rtq)&n; *&t;the return value is the number of pdus resend.&n; *&t;ack_nr is N(R) of 1st pdu to resent.&n; *&t;Type is I_CMD or I_RSP for 1st pdu resent.&n; *&t;p is p/f flag 0 or 1 for 1st pdu resent.&n; *&t;All subsequent pdus will be sent as I_CMDs with p/f set to 0&n; */
DECL|function|llc_resend_ipdu
r_int
id|llc_resend_ipdu
c_func
(paren
id|llcptr
id|lp
comma
r_int
r_char
id|ack_nr
comma
r_int
r_char
id|type
comma
r_char
id|p
)paren
(brace
r_struct
id|sk_buff
op_star
id|skb
comma
op_star
id|tmp
suffix:semicolon
r_int
id|resend_count
suffix:semicolon
id|frameptr
id|fr
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|resend_count
op_assign
l_int|0
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|skb
op_assign
id|skb_peek
c_func
(paren
op_amp
id|lp-&gt;rtq
)paren
suffix:semicolon
r_while
c_loop
(paren
id|skb
op_logical_and
id|skb
op_ne
(paren
r_struct
id|sk_buff
op_star
)paren
op_amp
id|lp-&gt;rtq
)paren
(brace
id|fr
op_assign
(paren
id|frameptr
)paren
(paren
id|skb-&gt;data
op_plus
id|lp-&gt;dev-&gt;hard_header_len
)paren
suffix:semicolon
r_if
c_cond
(paren
id|resend_count
op_eq
l_int|0
)paren
(brace
multiline_comment|/* &n;&t;&t;&t; *&t;Resending 1st pdu: &n;&t;&t;&t; */
r_if
c_cond
(paren
id|p
)paren
id|fr-&gt;i_hdr.i_pflag
op_assign
l_int|1
suffix:semicolon
r_else
id|fr-&gt;i_hdr.i_pflag
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|type
op_eq
id|I_CMD
)paren
id|fr-&gt;pdu_hdr.ssap
op_assign
id|fr-&gt;pdu_hdr.ssap
op_amp
l_int|0xfe
suffix:semicolon
r_else
id|fr-&gt;pdu_hdr.ssap
op_assign
id|fr-&gt;pdu_hdr.ssap
op_or
l_int|0x01
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/*&n;&t;        &t; *&t;Resending pdu 2...n &n;&t;        &t; */
id|fr-&gt;pdu_hdr.ssap
op_assign
id|fr-&gt;pdu_hdr.ssap
op_amp
l_int|0xfe
suffix:semicolon
id|fr-&gt;i_hdr.i_pflag
op_assign
l_int|0
suffix:semicolon
)brace
id|fr-&gt;i_hdr.nr
op_assign
id|lp-&gt;vr
suffix:semicolon
id|fr-&gt;i_hdr.ns
op_assign
id|lp-&gt;vs
suffix:semicolon
id|lp-&gt;vs
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|lp-&gt;vs
OG
l_int|127
)paren
id|lp-&gt;vs
op_assign
l_int|0
suffix:semicolon
id|tmp
op_assign
id|skb_clone
c_func
(paren
id|skb
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tmp
op_ne
l_int|NULL
)paren
(brace
id|tmp-&gt;dev
op_assign
id|lp-&gt;dev
suffix:semicolon
id|dev_queue_xmit
c_func
(paren
id|skb
)paren
suffix:semicolon
)brace
id|resend_count
op_increment
suffix:semicolon
id|skb
op_assign
id|skb-&gt;next
suffix:semicolon
)brace
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
id|resend_count
suffix:semicolon
)brace
multiline_comment|/* ************** internal queue management code ****************** */
multiline_comment|/*&n; *&t;Remove one skb from the front of the awaiting transmit queue&n; *&t;(this is the skb longest on the queue) and return a pointer to &n; *&t;that skb. &n; */
DECL|function|llc_pull_from_atq
r_struct
id|sk_buff
op_star
id|llc_pull_from_atq
c_func
(paren
id|llcptr
id|lp
)paren
(brace
r_return
id|skb_dequeue
c_func
(paren
op_amp
id|lp-&gt;atq
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;Free_acknowledged_skbs(), remove from retransmit queue (rtq)&n; *&t;and free all skbs with an N(S) chronologicaly before &squot;pdu_ack&squot;.&n; *&t;The return value is the number of pdus acknowledged.&n; */
DECL|function|llc_free_acknowledged_skbs
r_int
id|llc_free_acknowledged_skbs
c_func
(paren
id|llcptr
id|lp
comma
r_int
r_char
id|pdu_ack
)paren
(brace
r_struct
id|sk_buff
op_star
id|pp
suffix:semicolon
id|frameptr
id|fr
suffix:semicolon
r_int
id|ack_count
suffix:semicolon
r_int
r_char
id|ack
suffix:semicolon
multiline_comment|/* N(S) of most recently ack&squot;ed pdu */
r_int
r_char
id|ns_save
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_if
c_cond
(paren
id|pdu_ack
OG
l_int|0
)paren
id|ack
op_assign
id|pdu_ack
op_minus
l_int|1
suffix:semicolon
r_else
id|ack
op_assign
l_int|127
suffix:semicolon
id|ack_count
op_assign
l_int|0
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|pp
op_assign
id|skb_dequeue
c_func
(paren
op_amp
id|lp-&gt;rtq
)paren
suffix:semicolon
r_while
c_loop
(paren
id|pp
op_ne
l_int|NULL
)paren
(brace
multiline_comment|/* &n;&t;&t; *&t;Locate skb with N(S) == ack &n;&t;&t; */
multiline_comment|/*&n;&t;&t; *&t;BUG: FIXME - use skb-&gt;h.*&n;&t;&t; */
id|fr
op_assign
(paren
id|frameptr
)paren
(paren
id|pp-&gt;data
op_plus
id|lp-&gt;dev-&gt;hard_header_len
)paren
suffix:semicolon
id|ns_save
op_assign
id|fr-&gt;i_hdr.ns
suffix:semicolon
id|kfree_skb
c_func
(paren
id|pp
)paren
suffix:semicolon
id|ack_count
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|ns_save
op_eq
id|ack
)paren
r_break
suffix:semicolon
id|pp
op_assign
id|skb_dequeue
c_func
(paren
op_amp
id|lp-&gt;rtq
)paren
suffix:semicolon
)brace
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
id|ack_count
suffix:semicolon
)brace
eof
