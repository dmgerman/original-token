multiline_comment|/*&n; * INET&t;&t;An implementation of the TCP/IP protocol suite for the LINUX&n; *&t;&t;operating system.  INET is implemented using the  BSD Socket&n; *&t;&t;interface as the means of communication with the user level.&n; *&n; *&t;&t;HIPPI-type device handling.&n; *&n; * Version:&t;@(#)hippi.c&t;1.0.0&t;05/29/97&n; *&n; * Authors:&t;Ross Biro, &lt;bir7@leland.Stanford.Edu&gt;&n; *&t;&t;Fred N. van Kempen, &lt;waltje@uWalt.NL.Mugnet.ORG&gt;&n; *&t;&t;Mark Evans, &lt;evansmp@uhura.aston.ac.uk&gt;&n; *&t;&t;Florian  La Roche, &lt;rzsfl@rz.uni-sb.de&gt;&n; *&t;&t;Alan Cox, &lt;gw4pts@gw4pts.ampr.org&gt;&n; *&t;&t;Jes Sorensen, &lt;Jes.Sorensen@cern.ch&gt;&n; *&n; *&t;&t;This program is free software; you can redistribute it and/or&n; *&t;&t;modify it under the terms of the GNU General Public License&n; *&t;&t;as published by the Free Software Foundation; either version&n; *&t;&t;2 of the License, or (at your option) any later version.&n; */
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/mm.h&gt;
macro_line|#include &lt;linux/socket.h&gt;
macro_line|#include &lt;linux/in.h&gt;
macro_line|#include &lt;linux/inet.h&gt;
macro_line|#include &lt;linux/netdevice.h&gt;
macro_line|#include &lt;linux/hippidevice.h&gt;
macro_line|#include &lt;linux/skbuff.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;net/arp.h&gt;
macro_line|#include &lt;net/sock.h&gt;
macro_line|#include &lt;asm/uaccess.h&gt;
macro_line|#include &lt;asm/checksum.h&gt;
macro_line|#include &lt;asm/segment.h&gt;
macro_line|#include &lt;asm/system.h&gt;
multiline_comment|/*&n; * hippi_net_init()&n; *&n; * Do nothing, this is just to pursuade the stupid linker to behave.&n; */
DECL|function|hippi_net_init
r_void
id|hippi_net_init
c_func
(paren
r_void
)paren
(brace
r_return
suffix:semicolon
)brace
multiline_comment|/*&n; * Create the HIPPI MAC header for an arbitrary protocol layer &n; *&n; * saddr=NULL&t;means use device source address&n; * daddr=NULL&t;means leave destination address (eg unresolved arp)&n; */
DECL|function|hippi_header
r_int
id|hippi_header
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|net_device
op_star
id|dev
comma
r_int
r_int
id|type
comma
r_void
op_star
id|daddr
comma
r_void
op_star
id|saddr
comma
r_int
id|len
)paren
(brace
r_struct
id|hippi_hdr
op_star
id|hip
op_assign
(paren
r_struct
id|hippi_hdr
op_star
)paren
id|skb_push
c_func
(paren
id|skb
comma
id|HIPPI_HLEN
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|len
)paren
(brace
id|len
op_assign
id|skb-&gt;len
op_minus
id|HIPPI_HLEN
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;hippi_header(): length not supplied&bslash;n&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * Due to the stupidity of the little endian byte-order we&n;&t; * have to set the fp field this way.&n;&t; */
id|hip-&gt;fp.fixed
op_assign
id|__constant_htonl
c_func
(paren
l_int|0x04800018
)paren
suffix:semicolon
id|hip-&gt;fp.d2_size
op_assign
id|htonl
c_func
(paren
id|len
op_plus
l_int|8
)paren
suffix:semicolon
id|hip-&gt;le.fc
op_assign
l_int|0
suffix:semicolon
id|hip-&gt;le.double_wide
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* only HIPPI 800 for the time being */
id|hip-&gt;le.message_type
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Data PDU */
id|hip-&gt;le.dest_addr_type
op_assign
l_int|2
suffix:semicolon
multiline_comment|/* 12 bit SC address */
id|hip-&gt;le.src_addr_type
op_assign
l_int|2
suffix:semicolon
multiline_comment|/* 12 bit SC address */
id|memcpy
c_func
(paren
id|hip-&gt;le.src_switch_addr
comma
id|dev-&gt;dev_addr
op_plus
l_int|3
comma
l_int|3
)paren
suffix:semicolon
id|memset
c_func
(paren
op_amp
id|hip-&gt;le.reserved
comma
l_int|0
comma
l_int|16
)paren
suffix:semicolon
id|hip-&gt;snap.dsap
op_assign
id|HIPPI_EXTENDED_SAP
suffix:semicolon
id|hip-&gt;snap.ssap
op_assign
id|HIPPI_EXTENDED_SAP
suffix:semicolon
id|hip-&gt;snap.ctrl
op_assign
id|HIPPI_UI_CMD
suffix:semicolon
id|hip-&gt;snap.oui
(braket
l_int|0
)braket
op_assign
l_int|0x00
suffix:semicolon
id|hip-&gt;snap.oui
(braket
l_int|1
)braket
op_assign
l_int|0x00
suffix:semicolon
id|hip-&gt;snap.oui
(braket
l_int|2
)braket
op_assign
l_int|0x00
suffix:semicolon
id|hip-&gt;snap.ethertype
op_assign
id|htons
c_func
(paren
id|type
)paren
suffix:semicolon
r_if
c_cond
(paren
id|daddr
)paren
(brace
id|memcpy
c_func
(paren
id|hip-&gt;le.dest_switch_addr
comma
id|daddr
op_plus
l_int|3
comma
l_int|3
)paren
suffix:semicolon
id|memcpy
c_func
(paren
op_amp
id|skb
op_member_access_from_pointer
r_private
dot
id|ifield
comma
id|daddr
op_plus
l_int|2
comma
l_int|4
)paren
suffix:semicolon
r_return
id|HIPPI_HLEN
suffix:semicolon
)brace
r_return
op_minus
id|HIPPI_HLEN
suffix:semicolon
)brace
multiline_comment|/*&n; * Rebuild the HIPPI MAC header. This is called after an ARP has&n; * completed on this sk_buff. We now let ARP fill in the other fields.&n; */
DECL|function|hippi_rebuild_header
r_int
id|hippi_rebuild_header
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
)paren
(brace
r_struct
id|hippi_hdr
op_star
id|hip
op_assign
(paren
r_struct
id|hippi_hdr
op_star
)paren
id|skb-&gt;data
suffix:semicolon
multiline_comment|/*&n;&t; * Only IP is currently supported&n;&t; */
r_if
c_cond
(paren
id|hip-&gt;snap.ethertype
op_ne
id|__constant_htons
c_func
(paren
id|ETH_P_IP
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%s: unable to resolve type %X addresses.&bslash;n&quot;
comma
id|skb-&gt;dev-&gt;name
comma
id|ntohs
c_func
(paren
id|hip-&gt;snap.ethertype
)paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * We don&squot;t support dynamic ARP on HIPPI, but we use the ARP&n;&t; * static ARP tables to hold the I-FIELDs.&n;&t; */
r_return
id|arp_find
c_func
(paren
id|hip-&gt;le.daddr
comma
id|skb
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;Determine the packet&squot;s protocol ID.&n; */
DECL|function|hippi_type_trans
r_int
r_int
id|hippi_type_trans
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|hippi_hdr
op_star
id|hip
suffix:semicolon
id|hip
op_assign
(paren
r_struct
id|hippi_hdr
op_star
)paren
id|skb-&gt;data
suffix:semicolon
multiline_comment|/*&n;&t; * This is actually wrong ... question is if we really should&n;&t; * set the raw address here.&n;&t; */
id|skb-&gt;mac.raw
op_assign
id|skb-&gt;data
suffix:semicolon
id|skb_pull
c_func
(paren
id|skb
comma
id|HIPPI_HLEN
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * No fancy promisc stuff here now.&n;&t; */
r_return
id|hip-&gt;snap.ethertype
suffix:semicolon
)brace
eof
