multiline_comment|/*&n; *&t;&t;IP_MASQ_FTP ftp masquerading module&n; *&n; *&n; * Version:&t;@(#)ip_masq_ftp.c 0.04   02/05/96&n; *&n; * Author:&t;Wouter Gadeyne&n; *&t;&t;&n; *&n; * Fixes:&n; *&t;Wouter Gadeyne&t;&t;:&t;Fixed masquerading support of ftp PORT commands&n; * &t;Juan Jose Ciarlante&t;:&t;Code moved and adapted from ip_fw.c&n; * &t;Keith Owens&t;&t;:&t;Add keep alive for ftp control channel&n; *&t;Nigel Metheringham&t;:&t;Added multiple port support&n; * &t;Juan Jose Ciarlante&t;:&t;Use control_add() for ftp control chan&n; * &t;Juan Jose Ciarlante&t;:&t;Litl bits for 2.1&n; *&t;Juan Jose Ciarlante&t;:&t;use ip_masq_listen() &n; *&t;Juan Jose Ciarlante&t;: &t;use private app_data for own flag(s)&n; *&n; *&n; *&n; *&t;This program is free software; you can redistribute it and/or&n; *&t;modify it under the terms of the GNU General Public License&n; *&t;as published by the Free Software Foundation; either version&n; *&t;2 of the License, or (at your option) any later version.&n; *&t;&n; * Multiple Port Support&n; *&t;The helper can be made to handle up to MAX_MASQ_APP_PORTS (normally 12)&n; *&t;with the port numbers being defined at module load time.  The module&n; *&t;uses the symbol &quot;ports&quot; to define a list of monitored ports, which can&n; *&t;be specified on the insmod command line as&n; *&t;&t;ports=x1,x2,x3...&n; *&t;where x[n] are integer port numbers.  This option can be put into&n; *&t;/etc/conf.modules (or /etc/modules.conf depending on your config)&n; *&t;where modload will pick it up should you use modload to load your&n; *&t;modules.&n; *&t;&n; */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;asm/system.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/skbuff.h&gt;
macro_line|#include &lt;linux/in.h&gt;
macro_line|#include &lt;linux/ip.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;net/protocol.h&gt;
macro_line|#include &lt;net/tcp.h&gt;
multiline_comment|/* #define IP_MASQ_NDEBUG */
macro_line|#include &lt;net/ip_masq.h&gt;
multiline_comment|/* &n; * List of ports (up to MAX_MASQ_APP_PORTS) to be handled by helper&n; * First port is set to the default port.&n; */
DECL|variable|ports
r_static
r_int
id|ports
(braket
id|MAX_MASQ_APP_PORTS
)braket
op_assign
(brace
l_int|21
)brace
suffix:semicolon
multiline_comment|/* I rely on the trailing items being set to zero */
DECL|variable|masq_incarnations
r_struct
id|ip_masq_app
op_star
id|masq_incarnations
(braket
id|MAX_MASQ_APP_PORTS
)braket
suffix:semicolon
multiline_comment|/*&n; *&t;Debug level&n; */
DECL|variable|debug
r_static
r_int
id|debug
op_assign
l_int|0
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|ports
comma
l_string|&quot;1-&quot;
id|__MODULE_STRING
c_func
(paren
id|MAX_MASQ_APP_PORTS
)paren
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|debug
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
multiline_comment|/*&t;Dummy variable */
DECL|variable|masq_ftp_pasv
r_static
r_int
id|masq_ftp_pasv
suffix:semicolon
r_static
r_int
DECL|function|masq_ftp_init_1
id|masq_ftp_init_1
(paren
r_struct
id|ip_masq_app
op_star
id|mapp
comma
r_struct
id|ip_masq
op_star
id|ms
)paren
(brace
id|MOD_INC_USE_COUNT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_int
DECL|function|masq_ftp_done_1
id|masq_ftp_done_1
(paren
r_struct
id|ip_masq_app
op_star
id|mapp
comma
r_struct
id|ip_masq
op_star
id|ms
)paren
(brace
id|MOD_DEC_USE_COUNT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_int
DECL|function|masq_ftp_out
id|masq_ftp_out
(paren
r_struct
id|ip_masq_app
op_star
id|mapp
comma
r_struct
id|ip_masq
op_star
id|ms
comma
r_struct
id|sk_buff
op_star
op_star
id|skb_p
comma
id|__u32
id|maddr
)paren
(brace
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
r_struct
id|iphdr
op_star
id|iph
suffix:semicolon
r_struct
id|tcphdr
op_star
id|th
suffix:semicolon
r_char
op_star
id|p
comma
op_star
id|data
comma
op_star
id|data_limit
suffix:semicolon
r_int
r_char
id|p1
comma
id|p2
comma
id|p3
comma
id|p4
comma
id|p5
comma
id|p6
suffix:semicolon
id|__u32
id|from
suffix:semicolon
id|__u16
id|port
suffix:semicolon
r_struct
id|ip_masq
op_star
id|n_ms
suffix:semicolon
r_char
id|buf
(braket
l_int|24
)braket
suffix:semicolon
multiline_comment|/* xxx.xxx.xxx.xxx,ppp,ppp&bslash;000 */
r_int
id|buf_len
suffix:semicolon
r_int
id|diff
suffix:semicolon
id|skb
op_assign
op_star
id|skb_p
suffix:semicolon
id|iph
op_assign
id|skb-&gt;nh.iph
suffix:semicolon
id|th
op_assign
(paren
r_struct
id|tcphdr
op_star
)paren
op_amp
(paren
(paren
(paren
r_char
op_star
)paren
id|iph
)paren
(braket
id|iph-&gt;ihl
op_star
l_int|4
)braket
)paren
suffix:semicolon
id|data
op_assign
(paren
r_char
op_star
)paren
op_amp
id|th
(braket
l_int|1
)braket
suffix:semicolon
id|data_limit
op_assign
id|skb-&gt;h.raw
op_plus
id|skb-&gt;len
op_minus
l_int|18
suffix:semicolon
r_if
c_cond
(paren
id|skb-&gt;len
op_ge
l_int|6
op_logical_and
(paren
id|memcmp
c_func
(paren
id|data
comma
l_string|&quot;PASV&bslash;r&bslash;n&quot;
comma
l_int|6
)paren
op_eq
l_int|0
op_logical_or
id|memcmp
c_func
(paren
id|data
comma
l_string|&quot;pasv&bslash;r&bslash;n&quot;
comma
l_int|6
)paren
op_eq
l_int|0
)paren
)paren
id|ms-&gt;app_data
op_assign
op_amp
id|masq_ftp_pasv
suffix:semicolon
r_while
c_loop
(paren
id|data
OL
id|data_limit
)paren
(brace
r_if
c_cond
(paren
id|memcmp
c_func
(paren
id|data
comma
l_string|&quot;PORT &quot;
comma
l_int|5
)paren
op_logical_and
id|memcmp
c_func
(paren
id|data
comma
l_string|&quot;port &quot;
comma
l_int|5
)paren
)paren
(brace
id|data
op_increment
suffix:semicolon
r_continue
suffix:semicolon
)brace
id|p
op_assign
id|data
op_plus
l_int|5
suffix:semicolon
id|p1
op_assign
id|simple_strtoul
c_func
(paren
id|data
op_plus
l_int|5
comma
op_amp
id|data
comma
l_int|10
)paren
suffix:semicolon
r_if
c_cond
(paren
op_star
id|data
op_ne
l_char|&squot;,&squot;
)paren
r_continue
suffix:semicolon
id|p2
op_assign
id|simple_strtoul
c_func
(paren
id|data
op_plus
l_int|1
comma
op_amp
id|data
comma
l_int|10
)paren
suffix:semicolon
r_if
c_cond
(paren
op_star
id|data
op_ne
l_char|&squot;,&squot;
)paren
r_continue
suffix:semicolon
id|p3
op_assign
id|simple_strtoul
c_func
(paren
id|data
op_plus
l_int|1
comma
op_amp
id|data
comma
l_int|10
)paren
suffix:semicolon
r_if
c_cond
(paren
op_star
id|data
op_ne
l_char|&squot;,&squot;
)paren
r_continue
suffix:semicolon
id|p4
op_assign
id|simple_strtoul
c_func
(paren
id|data
op_plus
l_int|1
comma
op_amp
id|data
comma
l_int|10
)paren
suffix:semicolon
r_if
c_cond
(paren
op_star
id|data
op_ne
l_char|&squot;,&squot;
)paren
r_continue
suffix:semicolon
id|p5
op_assign
id|simple_strtoul
c_func
(paren
id|data
op_plus
l_int|1
comma
op_amp
id|data
comma
l_int|10
)paren
suffix:semicolon
r_if
c_cond
(paren
op_star
id|data
op_ne
l_char|&squot;,&squot;
)paren
r_continue
suffix:semicolon
id|p6
op_assign
id|simple_strtoul
c_func
(paren
id|data
op_plus
l_int|1
comma
op_amp
id|data
comma
l_int|10
)paren
suffix:semicolon
r_if
c_cond
(paren
op_star
id|data
op_ne
l_char|&squot;&bslash;r&squot;
op_logical_and
op_star
id|data
op_ne
l_char|&squot;&bslash;n&squot;
)paren
r_continue
suffix:semicolon
id|from
op_assign
(paren
id|p1
op_lshift
l_int|24
)paren
op_or
(paren
id|p2
op_lshift
l_int|16
)paren
op_or
(paren
id|p3
op_lshift
l_int|8
)paren
op_or
id|p4
suffix:semicolon
id|port
op_assign
(paren
id|p5
op_lshift
l_int|8
)paren
op_or
id|p6
suffix:semicolon
id|IP_MASQ_DEBUG
c_func
(paren
l_int|1
op_minus
id|debug
comma
l_string|&quot;PORT %X:%X detected&bslash;n&quot;
comma
id|from
comma
id|port
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t; * Now update or create an masquerade entry for it&n;&t;&t; */
id|IP_MASQ_DEBUG
c_func
(paren
l_int|1
op_minus
id|debug
comma
l_string|&quot;protocol %d %lX:%X %X:%X&bslash;n&quot;
comma
id|iph-&gt;protocol
comma
id|htonl
c_func
(paren
id|from
)paren
comma
id|htons
c_func
(paren
id|port
)paren
comma
id|iph-&gt;daddr
comma
l_int|0
)paren
suffix:semicolon
id|n_ms
op_assign
id|ip_masq_out_get
c_func
(paren
id|iph-&gt;protocol
comma
id|htonl
c_func
(paren
id|from
)paren
comma
id|htons
c_func
(paren
id|port
)paren
comma
id|iph-&gt;daddr
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|n_ms
)paren
(brace
id|n_ms
op_assign
id|ip_masq_new
c_func
(paren
id|IPPROTO_TCP
comma
id|maddr
comma
l_int|0
comma
id|htonl
c_func
(paren
id|from
)paren
comma
id|htons
c_func
(paren
id|port
)paren
comma
id|iph-&gt;daddr
comma
l_int|0
comma
id|IP_MASQ_F_NO_DPORT
)paren
suffix:semicolon
r_if
c_cond
(paren
id|n_ms
op_eq
l_int|NULL
)paren
r_return
l_int|0
suffix:semicolon
id|ip_masq_control_add
c_func
(paren
id|n_ms
comma
id|ms
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;&t;&t; * Replace the old PORT with the new one&n;&t;&t; */
id|from
op_assign
id|ntohl
c_func
(paren
id|n_ms-&gt;maddr
)paren
suffix:semicolon
id|port
op_assign
id|ntohs
c_func
(paren
id|n_ms-&gt;mport
)paren
suffix:semicolon
id|sprintf
c_func
(paren
id|buf
comma
l_string|&quot;%d,%d,%d,%d,%d,%d&quot;
comma
id|from
op_rshift
l_int|24
op_amp
l_int|255
comma
id|from
op_rshift
l_int|16
op_amp
l_int|255
comma
id|from
op_rshift
l_int|8
op_amp
l_int|255
comma
id|from
op_amp
l_int|255
comma
id|port
op_rshift
l_int|8
op_amp
l_int|255
comma
id|port
op_amp
l_int|255
)paren
suffix:semicolon
id|buf_len
op_assign
id|strlen
c_func
(paren
id|buf
)paren
suffix:semicolon
id|IP_MASQ_DEBUG
c_func
(paren
l_int|1
op_minus
id|debug
comma
l_string|&quot;new PORT %X:%X&bslash;n&quot;
comma
id|from
comma
id|port
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t; * Calculate required delta-offset to keep TCP happy&n;&t;&t; */
id|diff
op_assign
id|buf_len
op_minus
(paren
id|data
op_minus
id|p
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t; *&t;No shift.&n;&t;&t; */
r_if
c_cond
(paren
id|diff
op_eq
l_int|0
)paren
(brace
multiline_comment|/*&n;&t;&t;&t; * simple case, just replace the old PORT cmd&n; &t;&t;&t; */
id|memcpy
c_func
(paren
id|p
comma
id|buf
comma
id|buf_len
)paren
suffix:semicolon
)brace
r_else
(brace
op_star
id|skb_p
op_assign
id|ip_masq_skb_replace
c_func
(paren
id|skb
comma
id|GFP_ATOMIC
comma
id|p
comma
id|data
op_minus
id|p
comma
id|buf
comma
id|buf_len
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;                 * &t;Move tunnel to listen state&n;                 */
id|ip_masq_listen
c_func
(paren
id|n_ms
)paren
suffix:semicolon
id|ip_masq_put
c_func
(paren
id|n_ms
)paren
suffix:semicolon
r_return
id|diff
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * Look at incoming ftp packets to catch the response to a PASV command.  When&n; * we see one we build a masquerading entry for the client address, client port&n; * 0 (unknown at the moment), the server address and the server port.  Mark the&n; * current masquerade entry as a control channel and point the new entry at the&n; * control entry.  All this work just for ftp keepalive across masquerading.&n; *&n; * The incoming packet should be something like&n; * &quot;227 Entering Passive Mode (xxx,xxx,xxx,xxx,ppp,ppp)&quot;.&n; * xxx,xxx,xxx,xxx is the server address, ppp,ppp is the server port number.&n; * ncftp 2.3.0 cheats by skipping the leading number then going 22 bytes into&n; * the data so we do the same.  If it&squot;s good enough for ncftp then it&squot;s good&n; * enough for me.&n; *&n; * In this case, the client is the source machine being masqueraded, the server&n; * is the destination for ftp requests.  It all depends on your point of view ...&n; */
r_int
DECL|function|masq_ftp_in
id|masq_ftp_in
(paren
r_struct
id|ip_masq_app
op_star
id|mapp
comma
r_struct
id|ip_masq
op_star
id|ms
comma
r_struct
id|sk_buff
op_star
op_star
id|skb_p
comma
id|__u32
id|maddr
)paren
(brace
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
r_struct
id|iphdr
op_star
id|iph
suffix:semicolon
r_struct
id|tcphdr
op_star
id|th
suffix:semicolon
r_char
op_star
id|data
comma
op_star
id|data_limit
suffix:semicolon
r_int
r_char
id|p1
comma
id|p2
comma
id|p3
comma
id|p4
comma
id|p5
comma
id|p6
suffix:semicolon
id|__u32
id|to
suffix:semicolon
id|__u16
id|port
suffix:semicolon
r_struct
id|ip_masq
op_star
id|n_ms
suffix:semicolon
r_if
c_cond
(paren
id|ms-&gt;app_data
op_ne
op_amp
id|masq_ftp_pasv
)paren
r_return
l_int|0
suffix:semicolon
multiline_comment|/* quick exit if no outstanding PASV */
id|skb
op_assign
op_star
id|skb_p
suffix:semicolon
id|iph
op_assign
id|skb-&gt;nh.iph
suffix:semicolon
id|th
op_assign
(paren
r_struct
id|tcphdr
op_star
)paren
op_amp
(paren
(paren
(paren
r_char
op_star
)paren
id|iph
)paren
(braket
id|iph-&gt;ihl
op_star
l_int|4
)braket
)paren
suffix:semicolon
id|data
op_assign
(paren
r_char
op_star
)paren
op_amp
id|th
(braket
l_int|1
)braket
suffix:semicolon
id|data_limit
op_assign
id|skb-&gt;h.raw
op_plus
id|skb-&gt;len
suffix:semicolon
r_while
c_loop
(paren
id|data
OL
id|data_limit
op_logical_and
op_star
id|data
op_ne
l_char|&squot; &squot;
)paren
op_increment
id|data
suffix:semicolon
r_while
c_loop
(paren
id|data
OL
id|data_limit
op_logical_and
op_star
id|data
op_eq
l_char|&squot; &squot;
)paren
op_increment
id|data
suffix:semicolon
id|data
op_add_assign
l_int|22
suffix:semicolon
r_if
c_cond
(paren
id|data
op_ge
id|data_limit
op_logical_or
op_star
id|data
op_ne
l_char|&squot;(&squot;
)paren
r_return
l_int|0
suffix:semicolon
id|p1
op_assign
id|simple_strtoul
c_func
(paren
id|data
op_plus
l_int|1
comma
op_amp
id|data
comma
l_int|10
)paren
suffix:semicolon
r_if
c_cond
(paren
id|data
op_ge
id|data_limit
op_logical_or
op_star
id|data
op_ne
l_char|&squot;,&squot;
)paren
r_return
l_int|0
suffix:semicolon
id|p2
op_assign
id|simple_strtoul
c_func
(paren
id|data
op_plus
l_int|1
comma
op_amp
id|data
comma
l_int|10
)paren
suffix:semicolon
r_if
c_cond
(paren
id|data
op_ge
id|data_limit
op_logical_or
op_star
id|data
op_ne
l_char|&squot;,&squot;
)paren
r_return
l_int|0
suffix:semicolon
id|p3
op_assign
id|simple_strtoul
c_func
(paren
id|data
op_plus
l_int|1
comma
op_amp
id|data
comma
l_int|10
)paren
suffix:semicolon
r_if
c_cond
(paren
id|data
op_ge
id|data_limit
op_logical_or
op_star
id|data
op_ne
l_char|&squot;,&squot;
)paren
r_return
l_int|0
suffix:semicolon
id|p4
op_assign
id|simple_strtoul
c_func
(paren
id|data
op_plus
l_int|1
comma
op_amp
id|data
comma
l_int|10
)paren
suffix:semicolon
r_if
c_cond
(paren
id|data
op_ge
id|data_limit
op_logical_or
op_star
id|data
op_ne
l_char|&squot;,&squot;
)paren
r_return
l_int|0
suffix:semicolon
id|p5
op_assign
id|simple_strtoul
c_func
(paren
id|data
op_plus
l_int|1
comma
op_amp
id|data
comma
l_int|10
)paren
suffix:semicolon
r_if
c_cond
(paren
id|data
op_ge
id|data_limit
op_logical_or
op_star
id|data
op_ne
l_char|&squot;,&squot;
)paren
r_return
l_int|0
suffix:semicolon
id|p6
op_assign
id|simple_strtoul
c_func
(paren
id|data
op_plus
l_int|1
comma
op_amp
id|data
comma
l_int|10
)paren
suffix:semicolon
r_if
c_cond
(paren
id|data
op_ge
id|data_limit
op_logical_or
op_star
id|data
op_ne
l_char|&squot;)&squot;
)paren
r_return
l_int|0
suffix:semicolon
id|to
op_assign
(paren
id|p1
op_lshift
l_int|24
)paren
op_or
(paren
id|p2
op_lshift
l_int|16
)paren
op_or
(paren
id|p3
op_lshift
l_int|8
)paren
op_or
id|p4
suffix:semicolon
id|port
op_assign
(paren
id|p5
op_lshift
l_int|8
)paren
op_or
id|p6
suffix:semicolon
multiline_comment|/*&n;&t; * Now update or create an masquerade entry for it&n;&t; */
id|IP_MASQ_DEBUG
c_func
(paren
l_int|1
op_minus
id|debug
comma
l_string|&quot;PASV response %lX:%X %X:%X detected&bslash;n&quot;
comma
id|ntohl
c_func
(paren
id|ms-&gt;saddr
)paren
comma
l_int|0
comma
id|to
comma
id|port
)paren
suffix:semicolon
id|n_ms
op_assign
id|ip_masq_out_get
c_func
(paren
id|iph-&gt;protocol
comma
id|ms-&gt;saddr
comma
l_int|0
comma
id|htonl
c_func
(paren
id|to
)paren
comma
id|htons
c_func
(paren
id|port
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|n_ms
)paren
(brace
id|n_ms
op_assign
id|ip_masq_new
c_func
(paren
id|IPPROTO_TCP
comma
id|maddr
comma
l_int|0
comma
id|ms-&gt;saddr
comma
l_int|0
comma
id|htonl
c_func
(paren
id|to
)paren
comma
id|htons
c_func
(paren
id|port
)paren
comma
id|IP_MASQ_F_NO_SPORT
)paren
suffix:semicolon
r_if
c_cond
(paren
id|n_ms
op_eq
l_int|NULL
)paren
r_return
l_int|0
suffix:semicolon
id|ip_masq_control_add
c_func
(paren
id|n_ms
comma
id|ms
)paren
suffix:semicolon
)brace
macro_line|#if 0&t;/* v0.12 state processing */
multiline_comment|/*&n;&t; * keep for a bit longer than tcp_fin, client may not issue open&n;&t; * to server port before tcp_fin_timeout.&n;&t; */
id|n_ms-&gt;timeout
op_assign
id|ip_masq_expire-&gt;tcp_fin_timeout
op_star
l_int|3
suffix:semicolon
macro_line|#endif
id|ms-&gt;app_data
op_assign
l_int|NULL
suffix:semicolon
id|ip_masq_put
c_func
(paren
id|n_ms
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
multiline_comment|/* no diff required for incoming packets, thank goodness */
)brace
DECL|variable|ip_masq_ftp
r_struct
id|ip_masq_app
id|ip_masq_ftp
op_assign
(brace
l_int|NULL
comma
multiline_comment|/* next */
l_string|&quot;ftp&quot;
comma
multiline_comment|/* name */
l_int|0
comma
multiline_comment|/* type */
l_int|0
comma
multiline_comment|/* n_attach */
id|masq_ftp_init_1
comma
multiline_comment|/* ip_masq_init_1 */
id|masq_ftp_done_1
comma
multiline_comment|/* ip_masq_done_1 */
id|masq_ftp_out
comma
multiline_comment|/* pkt_out */
id|masq_ftp_in
comma
multiline_comment|/* pkt_in */
)brace
suffix:semicolon
multiline_comment|/*&n; * &t;ip_masq_ftp initialization&n; */
DECL|function|__initfunc
id|__initfunc
c_func
(paren
r_int
id|ip_masq_ftp_init
c_func
(paren
r_void
)paren
)paren
(brace
r_int
id|i
comma
id|j
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
(paren
id|i
OL
id|MAX_MASQ_APP_PORTS
)paren
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|ports
(braket
id|i
)braket
)paren
(brace
r_if
c_cond
(paren
(paren
id|masq_incarnations
(braket
id|i
)braket
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|ip_masq_app
)paren
comma
id|GFP_KERNEL
)paren
)paren
op_eq
l_int|NULL
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|memcpy
c_func
(paren
id|masq_incarnations
(braket
id|i
)braket
comma
op_amp
id|ip_masq_ftp
comma
r_sizeof
(paren
r_struct
id|ip_masq_app
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|j
op_assign
id|register_ip_masq_app
c_func
(paren
id|masq_incarnations
(braket
id|i
)braket
comma
id|IPPROTO_TCP
comma
id|ports
(braket
id|i
)braket
)paren
)paren
)paren
(brace
r_return
id|j
suffix:semicolon
)brace
id|IP_MASQ_DEBUG
c_func
(paren
l_int|1
op_minus
id|debug
comma
l_string|&quot;Ftp: loaded support on port[%d] = %d&bslash;n&quot;
comma
id|i
comma
id|ports
(braket
id|i
)braket
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* To be safe, force the incarnation table entry to NULL */
id|masq_incarnations
(braket
id|i
)braket
op_assign
l_int|NULL
suffix:semicolon
)brace
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * &t;ip_masq_ftp fin.&n; */
DECL|function|ip_masq_ftp_done
r_int
id|ip_masq_ftp_done
c_func
(paren
r_void
)paren
(brace
r_int
id|i
comma
id|j
comma
id|k
suffix:semicolon
id|k
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
(paren
id|i
OL
id|MAX_MASQ_APP_PORTS
)paren
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|masq_incarnations
(braket
id|i
)braket
)paren
(brace
r_if
c_cond
(paren
(paren
id|j
op_assign
id|unregister_ip_masq_app
c_func
(paren
id|masq_incarnations
(braket
id|i
)braket
)paren
)paren
)paren
(brace
id|k
op_assign
id|j
suffix:semicolon
)brace
r_else
(brace
id|kfree
c_func
(paren
id|masq_incarnations
(braket
id|i
)braket
)paren
suffix:semicolon
id|masq_incarnations
(braket
id|i
)braket
op_assign
l_int|NULL
suffix:semicolon
id|IP_MASQ_DEBUG
c_func
(paren
l_int|1
op_minus
id|debug
comma
l_string|&quot;Ftp: unloaded support on port[%d] = %d&bslash;n&quot;
comma
id|i
comma
id|ports
(braket
id|i
)braket
)paren
suffix:semicolon
)brace
)brace
)brace
r_return
id|k
suffix:semicolon
)brace
macro_line|#ifdef MODULE
id|EXPORT_NO_SYMBOLS
suffix:semicolon
DECL|function|init_module
r_int
id|init_module
c_func
(paren
r_void
)paren
(brace
r_if
c_cond
(paren
id|ip_masq_ftp_init
c_func
(paren
)paren
op_ne
l_int|0
)paren
r_return
op_minus
id|EIO
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|cleanup_module
r_void
id|cleanup_module
c_func
(paren
r_void
)paren
(brace
r_if
c_cond
(paren
id|ip_masq_ftp_done
c_func
(paren
)paren
op_ne
l_int|0
)paren
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;ip_masq_ftp: can&squot;t remove module&quot;
)paren
suffix:semicolon
)brace
macro_line|#endif /* MODULE */
eof
