multiline_comment|/*&n; *&t;&t;IP_MASQ_VDOLIVE  - VDO Live masquerading module&n; *&n; *&n; * Version:&t;@(#)$Id: ip_masq_vdolive.c,v 1.4 1998/10/06 04:49:07 davem Exp $&n; *&n; * Author:&t;Nigel Metheringham &lt;Nigel.Metheringham@ThePLAnet.net&gt;&n; *&t;&t;PLAnet Online Ltd&n; *&n; * Fixes:&t;Minor changes for 2.1 by&n; *&t;&t;Steven Clarke &lt;Steven.Clarke@ThePlanet.Net&gt;, Planet Online Ltd&n; *&n; *              Add missing #include &lt;linux/string.h&gt;&n; *              Horst von Brand &lt;vonbrand@sleipnir.valparaiso.cl&gt;&n; *&n; *&t;This program is free software; you can redistribute it and/or&n; *&t;modify it under the terms of the GNU General Public License&n; *&t;as published by the Free Software Foundation; either version&n; *&t;2 of the License, or (at your option) any later version.&n; *&n; * Thanks:&n; *&t;Thank you to VDOnet Corporation for allowing me access to&n; *&t;a protocol description without an NDA.  This means that&n; *&t;this module can be distributed as source - a great help!&n; *&t;&n; */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;asm/system.h&gt;
macro_line|#include &lt;linux/skbuff.h&gt;
macro_line|#include &lt;linux/in.h&gt;
macro_line|#include &lt;linux/ip.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;net/protocol.h&gt;
macro_line|#include &lt;net/tcp.h&gt;
macro_line|#include &lt;net/ip_masq.h&gt;
DECL|struct|vdolive_priv_data
r_struct
id|vdolive_priv_data
(brace
multiline_comment|/* Ports used */
DECL|member|origport
r_int
r_int
id|origport
suffix:semicolon
DECL|member|masqport
r_int
r_int
id|masqport
suffix:semicolon
multiline_comment|/* State of decode */
DECL|member|state
r_int
r_int
id|state
suffix:semicolon
)brace
suffix:semicolon
multiline_comment|/* &n; * List of ports (up to MAX_MASQ_APP_PORTS) to be handled by helper&n; * First port is set to the default port.&n; */
DECL|variable|ports
r_static
r_int
id|ports
(braket
id|MAX_MASQ_APP_PORTS
)braket
op_assign
(brace
l_int|7000
)brace
suffix:semicolon
multiline_comment|/* I rely on the trailing items being set to zero */
DECL|variable|masq_incarnations
r_struct
id|ip_masq_app
op_star
id|masq_incarnations
(braket
id|MAX_MASQ_APP_PORTS
)braket
suffix:semicolon
multiline_comment|/*&n; *     Debug level&n; */
macro_line|#ifdef CONFIG_IP_MASQ_DEBUG
DECL|variable|debug
r_static
r_int
id|debug
op_assign
l_int|0
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|debug
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
macro_line|#endif
id|MODULE_PARM
c_func
(paren
id|ports
comma
l_string|&quot;1-&quot;
id|__MODULE_STRING
c_func
(paren
id|MAX_MASQ_APP_PORTS
)paren
l_string|&quot;i&quot;
)paren
suffix:semicolon
r_static
r_int
DECL|function|masq_vdolive_init_1
id|masq_vdolive_init_1
(paren
r_struct
id|ip_masq_app
op_star
id|mapp
comma
r_struct
id|ip_masq
op_star
id|ms
)paren
(brace
id|MOD_INC_USE_COUNT
suffix:semicolon
r_if
c_cond
(paren
(paren
id|ms-&gt;app_data
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|vdolive_priv_data
)paren
comma
id|GFP_ATOMIC
)paren
)paren
op_eq
l_int|NULL
)paren
id|IP_MASQ_DEBUG
c_func
(paren
l_int|1
op_minus
id|debug
comma
l_string|&quot;VDOlive: No memory for application data&bslash;n&quot;
)paren
suffix:semicolon
r_else
(brace
r_struct
id|vdolive_priv_data
op_star
id|priv
op_assign
(paren
r_struct
id|vdolive_priv_data
op_star
)paren
id|ms-&gt;app_data
suffix:semicolon
id|priv-&gt;origport
op_assign
l_int|0
suffix:semicolon
id|priv-&gt;masqport
op_assign
l_int|0
suffix:semicolon
id|priv-&gt;state
op_assign
l_int|0
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_int
DECL|function|masq_vdolive_done_1
id|masq_vdolive_done_1
(paren
r_struct
id|ip_masq_app
op_star
id|mapp
comma
r_struct
id|ip_masq
op_star
id|ms
)paren
(brace
id|MOD_DEC_USE_COUNT
suffix:semicolon
r_if
c_cond
(paren
id|ms-&gt;app_data
)paren
id|kfree_s
c_func
(paren
id|ms-&gt;app_data
comma
r_sizeof
(paren
r_struct
id|vdolive_priv_data
)paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_int
DECL|function|masq_vdolive_out
id|masq_vdolive_out
(paren
r_struct
id|ip_masq_app
op_star
id|mapp
comma
r_struct
id|ip_masq
op_star
id|ms
comma
r_struct
id|sk_buff
op_star
op_star
id|skb_p
comma
id|__u32
id|maddr
)paren
(brace
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
r_struct
id|iphdr
op_star
id|iph
suffix:semicolon
r_struct
id|tcphdr
op_star
id|th
suffix:semicolon
r_char
op_star
id|data
comma
op_star
id|data_limit
suffix:semicolon
r_int
r_int
id|tagval
suffix:semicolon
multiline_comment|/* This should be a 32 bit quantity */
r_struct
id|ip_masq
op_star
id|n_ms
suffix:semicolon
r_struct
id|vdolive_priv_data
op_star
id|priv
op_assign
(paren
r_struct
id|vdolive_priv_data
op_star
)paren
id|ms-&gt;app_data
suffix:semicolon
multiline_comment|/* This doesn&squot;t work at all if no priv data was allocated on startup */
r_if
c_cond
(paren
op_logical_neg
id|priv
)paren
r_return
l_int|0
suffix:semicolon
multiline_comment|/* Everything running correctly already */
r_if
c_cond
(paren
id|priv-&gt;state
op_eq
l_int|3
)paren
r_return
l_int|0
suffix:semicolon
id|skb
op_assign
op_star
id|skb_p
suffix:semicolon
id|iph
op_assign
id|skb-&gt;nh.iph
suffix:semicolon
id|th
op_assign
(paren
r_struct
id|tcphdr
op_star
)paren
op_amp
(paren
(paren
(paren
r_char
op_star
)paren
id|iph
)paren
(braket
id|iph-&gt;ihl
op_star
l_int|4
)braket
)paren
suffix:semicolon
id|data
op_assign
(paren
r_char
op_star
)paren
op_amp
id|th
(braket
l_int|1
)braket
suffix:semicolon
id|data_limit
op_assign
id|skb-&gt;h.raw
op_plus
id|skb-&gt;len
suffix:semicolon
r_if
c_cond
(paren
id|data
op_plus
l_int|8
OG
id|data_limit
)paren
(brace
id|IP_MASQ_DEBUG
c_func
(paren
l_int|1
op_minus
id|debug
comma
l_string|&quot;VDOlive: packet too short for ID %p %p&bslash;n&quot;
comma
id|data
comma
id|data_limit
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|memcpy
c_func
(paren
op_amp
id|tagval
comma
id|data
op_plus
l_int|4
comma
l_int|4
)paren
suffix:semicolon
id|IP_MASQ_DEBUG
c_func
(paren
l_int|1
op_minus
id|debug
comma
l_string|&quot;VDOlive: packet seen, tag %ld, in initial state %d&bslash;n&quot;
comma
id|ntohl
c_func
(paren
id|tagval
)paren
comma
id|priv-&gt;state
)paren
suffix:semicolon
multiline_comment|/* Check for leading packet ID */
r_if
c_cond
(paren
(paren
id|ntohl
c_func
(paren
id|tagval
)paren
op_ne
l_int|6
)paren
op_logical_and
(paren
id|ntohl
c_func
(paren
id|tagval
)paren
op_ne
l_int|1
)paren
)paren
(brace
id|IP_MASQ_DEBUG
c_func
(paren
l_int|1
op_minus
id|debug
comma
l_string|&quot;VDOlive: unrecognised tag %ld, in initial state %d&bslash;n&quot;
comma
id|ntohl
c_func
(paren
id|tagval
)paren
comma
id|priv-&gt;state
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Check packet is long enough for data - ignore if not */
r_if
c_cond
(paren
(paren
id|ntohl
c_func
(paren
id|tagval
)paren
op_eq
l_int|6
)paren
op_logical_and
(paren
id|data
op_plus
l_int|36
OG
id|data_limit
)paren
)paren
(brace
id|IP_MASQ_DEBUG
c_func
(paren
l_int|1
op_minus
id|debug
comma
l_string|&quot;VDOlive: initial packet too short %p %p&bslash;n&quot;
comma
id|data
comma
id|data_limit
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
(paren
id|ntohl
c_func
(paren
id|tagval
)paren
op_eq
l_int|1
)paren
op_logical_and
(paren
id|data
op_plus
l_int|20
OG
id|data_limit
)paren
)paren
(brace
id|IP_MASQ_DEBUG
c_func
(paren
l_int|1
op_minus
id|debug
comma
l_string|&quot;VDOlive: secondary packet too short %p %p&bslash;n&quot;
comma
id|data
comma
id|data_limit
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Adjust data pointers */
multiline_comment|/*&n;&t; * I could check the complete protocol version tag &n;&t; * in here however I am just going to look for the&n;&t; * &quot;VDO Live&quot; tag in the hope that this part will&n;&t; * remain constant even if the version changes&n;&t; */
r_if
c_cond
(paren
id|ntohl
c_func
(paren
id|tagval
)paren
op_eq
l_int|6
)paren
(brace
id|data
op_add_assign
l_int|24
suffix:semicolon
id|IP_MASQ_DEBUG
c_func
(paren
l_int|1
op_minus
id|debug
comma
l_string|&quot;VDOlive: initial packet found&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_else
(brace
id|data
op_add_assign
l_int|8
suffix:semicolon
id|IP_MASQ_DEBUG
c_func
(paren
l_int|1
op_minus
id|debug
comma
l_string|&quot;VDOlive: secondary packet found&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|memcmp
c_func
(paren
id|data
comma
l_string|&quot;VDO Live&quot;
comma
l_int|8
)paren
op_ne
l_int|0
)paren
(brace
id|IP_MASQ_DEBUG
c_func
(paren
l_int|1
op_minus
id|debug
comma
l_string|&quot;VDOlive: did not find tag&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* &n;&t; * The port number is the next word after the tag.&n;&t; * VDOlive encodes all of these values&n;&t; * in 32 bit words, so in this case I am&n;&t; * skipping the first 2 bytes of the next&n;&t; * word to get to the relevant 16 bits&n;&t; */
id|data
op_add_assign
l_int|10
suffix:semicolon
multiline_comment|/*&n;&t; * If we have not seen the port already,&n;&t; * set the masquerading tunnel up&n;&t; */
r_if
c_cond
(paren
op_logical_neg
id|priv-&gt;origport
)paren
(brace
id|memcpy
c_func
(paren
op_amp
id|priv-&gt;origport
comma
id|data
comma
l_int|2
)paren
suffix:semicolon
id|IP_MASQ_DEBUG
c_func
(paren
l_int|1
op_minus
id|debug
comma
l_string|&quot;VDOlive: found port %d&bslash;n&quot;
comma
id|ntohs
c_func
(paren
id|priv-&gt;origport
)paren
)paren
suffix:semicolon
multiline_comment|/* Open up a tunnel */
id|n_ms
op_assign
id|ip_masq_new
c_func
(paren
id|IPPROTO_UDP
comma
id|maddr
comma
l_int|0
comma
id|ms-&gt;saddr
comma
id|priv-&gt;origport
comma
id|ms-&gt;daddr
comma
l_int|0
comma
id|IP_MASQ_F_NO_DPORT
)paren
suffix:semicolon
r_if
c_cond
(paren
id|n_ms
op_eq
l_int|NULL
)paren
(brace
id|ip_masq_put
c_func
(paren
id|n_ms
)paren
suffix:semicolon
id|IP_MASQ_DEBUG
c_func
(paren
l_int|1
op_minus
id|debug
comma
l_string|&quot;VDOlive: unable to build UDP tunnel for %x:%x&bslash;n&quot;
comma
id|ms-&gt;saddr
comma
id|priv-&gt;origport
)paren
suffix:semicolon
multiline_comment|/* Leave state as unset */
id|priv-&gt;origport
op_assign
l_int|0
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|ip_masq_listen
c_func
(paren
id|n_ms
)paren
suffix:semicolon
id|ip_masq_put
c_func
(paren
id|ms
)paren
suffix:semicolon
id|priv-&gt;masqport
op_assign
id|n_ms-&gt;mport
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|memcmp
c_func
(paren
id|data
comma
op_amp
(paren
id|priv-&gt;origport
)paren
comma
l_int|2
)paren
)paren
(brace
id|IP_MASQ_DEBUG
c_func
(paren
l_int|1
op_minus
id|debug
comma
l_string|&quot;VDOlive: ports do not match&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* Write the port in anyhow!!! */
)brace
multiline_comment|/*&n;&t; * Write masq port into packet&n;&t; */
id|memcpy
c_func
(paren
id|data
comma
op_amp
(paren
id|priv-&gt;masqport
)paren
comma
l_int|2
)paren
suffix:semicolon
id|IP_MASQ_DEBUG
c_func
(paren
l_int|1
op_minus
id|debug
comma
l_string|&quot;VDOlive: rewrote port %d to %d, server %08X&bslash;n&quot;
comma
id|ntohs
c_func
(paren
id|priv-&gt;origport
)paren
comma
id|ntohs
c_func
(paren
id|priv-&gt;masqport
)paren
comma
id|ms-&gt;saddr
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Set state bit to make which bit has been done&n;&t; */
id|priv-&gt;state
op_or_assign
(paren
id|ntohl
c_func
(paren
id|tagval
)paren
op_eq
l_int|6
)paren
ques
c_cond
l_int|1
suffix:colon
l_int|2
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|variable|ip_masq_vdolive
r_struct
id|ip_masq_app
id|ip_masq_vdolive
op_assign
(brace
l_int|NULL
comma
multiline_comment|/* next */
l_string|&quot;VDOlive&quot;
comma
multiline_comment|/* name */
l_int|0
comma
multiline_comment|/* type */
l_int|0
comma
multiline_comment|/* n_attach */
id|masq_vdolive_init_1
comma
multiline_comment|/* ip_masq_init_1 */
id|masq_vdolive_done_1
comma
multiline_comment|/* ip_masq_done_1 */
id|masq_vdolive_out
comma
multiline_comment|/* pkt_out */
l_int|NULL
multiline_comment|/* pkt_in */
)brace
suffix:semicolon
multiline_comment|/*&n; * &t;ip_masq_vdolive initialization&n; */
DECL|function|__initfunc
id|__initfunc
c_func
(paren
r_int
id|ip_masq_vdolive_init
c_func
(paren
r_void
)paren
)paren
(brace
r_int
id|i
comma
id|j
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
(paren
id|i
OL
id|MAX_MASQ_APP_PORTS
)paren
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|ports
(braket
id|i
)braket
)paren
(brace
r_if
c_cond
(paren
(paren
id|masq_incarnations
(braket
id|i
)braket
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|ip_masq_app
)paren
comma
id|GFP_KERNEL
)paren
)paren
op_eq
l_int|NULL
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|memcpy
c_func
(paren
id|masq_incarnations
(braket
id|i
)braket
comma
op_amp
id|ip_masq_vdolive
comma
r_sizeof
(paren
r_struct
id|ip_masq_app
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|j
op_assign
id|register_ip_masq_app
c_func
(paren
id|masq_incarnations
(braket
id|i
)braket
comma
id|IPPROTO_TCP
comma
id|ports
(braket
id|i
)braket
)paren
)paren
)paren
(brace
r_return
id|j
suffix:semicolon
)brace
id|IP_MASQ_DEBUG
c_func
(paren
l_int|1
op_minus
id|debug
comma
l_string|&quot;RealAudio: loaded support on port[%d] = %d&bslash;n&quot;
comma
id|i
comma
id|ports
(braket
id|i
)braket
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* To be safe, force the incarnation table entry to NULL */
id|masq_incarnations
(braket
id|i
)braket
op_assign
l_int|NULL
suffix:semicolon
)brace
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * &t;ip_masq_vdolive fin.&n; */
DECL|function|ip_masq_vdolive_done
r_int
id|ip_masq_vdolive_done
c_func
(paren
r_void
)paren
(brace
r_int
id|i
comma
id|j
comma
id|k
suffix:semicolon
id|k
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
(paren
id|i
OL
id|MAX_MASQ_APP_PORTS
)paren
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|masq_incarnations
(braket
id|i
)braket
)paren
(brace
r_if
c_cond
(paren
(paren
id|j
op_assign
id|unregister_ip_masq_app
c_func
(paren
id|masq_incarnations
(braket
id|i
)braket
)paren
)paren
)paren
(brace
id|k
op_assign
id|j
suffix:semicolon
)brace
r_else
(brace
id|kfree
c_func
(paren
id|masq_incarnations
(braket
id|i
)braket
)paren
suffix:semicolon
id|masq_incarnations
(braket
id|i
)braket
op_assign
l_int|NULL
suffix:semicolon
id|IP_MASQ_DEBUG
c_func
(paren
l_int|1
op_minus
id|debug
comma
l_string|&quot;VDOlive: unloaded support on port[%d] = %d&bslash;n&quot;
comma
id|i
comma
id|ports
(braket
id|i
)braket
)paren
suffix:semicolon
)brace
)brace
)brace
r_return
id|k
suffix:semicolon
)brace
macro_line|#ifdef MODULE
id|EXPORT_NO_SYMBOLS
suffix:semicolon
DECL|function|init_module
r_int
id|init_module
c_func
(paren
r_void
)paren
(brace
r_if
c_cond
(paren
id|ip_masq_vdolive_init
c_func
(paren
)paren
op_ne
l_int|0
)paren
r_return
op_minus
id|EIO
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|cleanup_module
r_void
id|cleanup_module
c_func
(paren
r_void
)paren
(brace
r_if
c_cond
(paren
id|ip_masq_vdolive_done
c_func
(paren
)paren
op_ne
l_int|0
)paren
id|IP_MASQ_DEBUG
c_func
(paren
l_int|1
op_minus
id|debug
comma
l_string|&quot;ip_masq_vdolive: can&squot;t remove module&quot;
)paren
suffix:semicolon
)brace
macro_line|#endif /* MODULE */
eof
