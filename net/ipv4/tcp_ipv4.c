multiline_comment|/*&n; * INET&t;&t;An implementation of the TCP/IP protocol suite for the LINUX&n; *&t;&t;operating system.  INET is implemented using the  BSD Socket&n; *&t;&t;interface as the means of communication with the user level.&n; *&n; *&t;&t;Implementation of the Transmission Control Protocol(TCP).&n; *&n; * Version:&t;$Id: tcp_ipv4.c,v 1.77 1997/12/13 21:53:00 kuznet Exp $&n; *&n; *&t;&t;IPv4 specific functions&n; *&n; *&n; *&t;&t;code split from:&n; *&t;&t;linux/ipv4/tcp.c&n; *&t;&t;linux/ipv4/tcp_input.c&n; *&t;&t;linux/ipv4/tcp_output.c&n; *&n; *&t;&t;See tcp.c for author information&n; *&n; *&t;This program is free software; you can redistribute it and/or&n; *      modify it under the terms of the GNU General Public License&n; *      as published by the Free Software Foundation; either version&n; *      2 of the License, or (at your option) any later version.&n; */
multiline_comment|/*&n; * Changes:&n; *&t;&t;David S. Miller&t;:&t;New socket lookup architecture.&n; *&t;&t;&t;&t;&t;This code is dedicated to John Dyson.&n; *&t;&t;David S. Miller :&t;Change semantics of established hash,&n; *&t;&t;&t;&t;&t;half is devoted to TIME_WAIT sockets&n; *&t;&t;&t;&t;&t;and the rest go in the other half.&n; *&t;&t;Andi Kleen :&t;&t;Add support for syncookies and fixed&n; *&t;&t;&t;&t;&t;some bugs: ip options weren&squot;t passed to&n; *&t;&t;&t;&t;&t;the TCP layer, missed a check for an ACK bit.&n; *&t;&t;Andi Kleen :&t;&t;Implemented fast path mtu discovery.&n; *&t;     &t;&t;&t;&t;Fixed many serious bugs in the&n; *&t;&t;&t;&t;&t;open_request handling and moved&n; *&t;&t;&t;&t;&t;most of it into the af independent code.&n; *&t;&t;&t;&t;&t;Added tail drop and some other bugfixes.&n; *&t;&t;&t;&t;&t;Added new listen sematics (ifdefed by&n; *&t;&t;&t;&t;&t;NEW_LISTEN for now)&n; *&t;Juan Jose Ciarlante:&t;&t;ip_dynaddr bits&n; */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/fcntl.h&gt;
macro_line|#include &lt;linux/random.h&gt;
macro_line|#include &lt;linux/ipsec.h&gt;
macro_line|#include &lt;net/icmp.h&gt;
macro_line|#include &lt;net/tcp.h&gt;
macro_line|#include &lt;net/ipv6.h&gt;
macro_line|#include &lt;asm/segment.h&gt;
macro_line|#include &lt;linux/inet.h&gt;
r_extern
r_int
id|sysctl_tcp_sack
suffix:semicolon
r_extern
r_int
id|sysctl_tcp_tsack
suffix:semicolon
r_extern
r_int
id|sysctl_tcp_timestamps
suffix:semicolon
r_extern
r_int
id|sysctl_tcp_window_scaling
suffix:semicolon
r_extern
r_int
id|sysctl_tcp_syncookies
suffix:semicolon
r_extern
r_int
id|sysctl_ip_dynaddr
suffix:semicolon
multiline_comment|/* Check TCP sequence numbers in ICMP packets. */
DECL|macro|ICMP_PARANOIA
mdefine_line|#define ICMP_PARANOIA 1 
macro_line|#ifndef ICMP_PARANOIA
DECL|macro|ICMP_MIN_LENGTH
mdefine_line|#define ICMP_MIN_LENGTH 4
macro_line|#else
DECL|macro|ICMP_MIN_LENGTH
mdefine_line|#define ICMP_MIN_LENGTH 8
macro_line|#endif
r_static
r_void
id|tcp_v4_send_reset
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
)paren
suffix:semicolon
r_void
id|tcp_v4_send_check
c_func
(paren
r_struct
id|sock
op_star
id|sk
comma
r_struct
id|tcphdr
op_star
id|th
comma
r_int
id|len
comma
r_struct
id|sk_buff
op_star
id|skb
)paren
suffix:semicolon
multiline_comment|/* This is for sockets with full identity only.  Sockets here will always&n; * be without wildcards and will have the following invariant:&n; *          TCP_ESTABLISHED &lt;= sk-&gt;state &lt; TCP_CLOSE&n; *&n; * First half of the table is for sockets not in TIME_WAIT, second half&n; * is for TIME_WAIT sockets only.&n; */
DECL|variable|tcp_established_hash
r_struct
id|sock
op_star
id|tcp_established_hash
(braket
id|TCP_HTABLE_SIZE
)braket
suffix:semicolon
multiline_comment|/* All sockets in TCP_LISTEN state will be in here.  This is the only table&n; * where wildcard&squot;d TCP sockets can exist.  Hash function here is just local&n; * port number.&n; */
DECL|variable|tcp_listening_hash
r_struct
id|sock
op_star
id|tcp_listening_hash
(braket
id|TCP_LHTABLE_SIZE
)braket
suffix:semicolon
multiline_comment|/* Ok, let&squot;s try this, I give up, we do need a local binding&n; * TCP hash as well as the others for fast bind/connect.&n; */
DECL|variable|tcp_bound_hash
r_struct
id|sock
op_star
id|tcp_bound_hash
(braket
id|TCP_BHTABLE_SIZE
)braket
suffix:semicolon
multiline_comment|/*&n; * This array holds the first and last local port number.&n; * For high-usage systems, use sysctl to change this to&n; * 32768-61000&n; */
DECL|variable|sysctl_local_port_range
r_int
id|sysctl_local_port_range
(braket
l_int|2
)braket
op_assign
(brace
l_int|1024
comma
l_int|4999
)brace
suffix:semicolon
DECL|function|tcp_hashfn
r_static
id|__inline__
r_int
id|tcp_hashfn
c_func
(paren
id|__u32
id|laddr
comma
id|__u16
id|lport
comma
id|__u32
id|faddr
comma
id|__u16
id|fport
)paren
(brace
r_return
(paren
(paren
id|laddr
op_xor
id|lport
)paren
op_xor
(paren
id|faddr
op_xor
id|fport
)paren
)paren
op_amp
(paren
(paren
id|TCP_HTABLE_SIZE
op_div
l_int|2
)paren
op_minus
l_int|1
)paren
suffix:semicolon
)brace
DECL|function|tcp_sk_hashfn
r_static
id|__inline__
r_int
id|tcp_sk_hashfn
c_func
(paren
r_struct
id|sock
op_star
id|sk
)paren
(brace
id|__u32
id|laddr
op_assign
id|sk-&gt;rcv_saddr
suffix:semicolon
id|__u16
id|lport
op_assign
id|sk-&gt;num
suffix:semicolon
id|__u32
id|faddr
op_assign
id|sk-&gt;daddr
suffix:semicolon
id|__u16
id|fport
op_assign
id|sk-&gt;dummy_th.dest
suffix:semicolon
r_return
id|tcp_hashfn
c_func
(paren
id|laddr
comma
id|lport
comma
id|faddr
comma
id|fport
)paren
suffix:semicolon
)brace
DECL|function|tcp_v4_verify_bind
r_static
r_int
id|tcp_v4_verify_bind
c_func
(paren
r_struct
id|sock
op_star
id|sk
comma
r_int
r_int
id|snum
)paren
(brace
r_struct
id|sock
op_star
id|sk2
suffix:semicolon
r_int
id|retval
op_assign
l_int|0
comma
id|sk_reuse
op_assign
id|sk-&gt;reuse
suffix:semicolon
id|SOCKHASH_LOCK
c_func
(paren
)paren
suffix:semicolon
id|sk2
op_assign
id|tcp_bound_hash
(braket
id|tcp_bhashfn
c_func
(paren
id|snum
)paren
)braket
suffix:semicolon
r_for
c_loop
(paren
suffix:semicolon
id|sk2
op_ne
l_int|NULL
suffix:semicolon
id|sk2
op_assign
id|sk2-&gt;bind_next
)paren
(brace
r_if
c_cond
(paren
(paren
id|sk2-&gt;num
op_eq
id|snum
)paren
op_logical_and
(paren
id|sk2
op_ne
id|sk
)paren
)paren
(brace
r_int
r_char
id|state
op_assign
id|sk2-&gt;state
suffix:semicolon
r_int
id|sk2_reuse
op_assign
id|sk2-&gt;reuse
suffix:semicolon
multiline_comment|/* Two sockets can be bound to the same port if they&squot;re&n;&t;&t;&t; * bound to different interfaces.&n;&t;&t;&t; */
r_if
c_cond
(paren
id|sk-&gt;bound_dev_if
op_ne
id|sk2-&gt;bound_dev_if
)paren
(brace
r_continue
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|sk2-&gt;rcv_saddr
op_logical_or
op_logical_neg
id|sk-&gt;rcv_saddr
)paren
(brace
r_if
c_cond
(paren
(paren
op_logical_neg
id|sk2_reuse
)paren
op_logical_or
(paren
op_logical_neg
id|sk_reuse
)paren
op_logical_or
(paren
id|state
op_eq
id|TCP_LISTEN
)paren
)paren
(brace
id|retval
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
r_else
r_if
c_cond
(paren
id|sk2-&gt;rcv_saddr
op_eq
id|sk-&gt;rcv_saddr
)paren
(brace
r_if
c_cond
(paren
(paren
op_logical_neg
id|sk_reuse
)paren
op_logical_or
(paren
op_logical_neg
id|sk2_reuse
)paren
op_logical_or
(paren
id|state
op_eq
id|TCP_LISTEN
)paren
)paren
(brace
id|retval
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
)brace
)brace
id|SOCKHASH_UNLOCK
c_func
(paren
)paren
suffix:semicolon
r_return
id|retval
suffix:semicolon
)brace
DECL|function|tcp_lport_inuse
r_static
id|__inline__
r_int
id|tcp_lport_inuse
c_func
(paren
r_int
id|num
)paren
(brace
r_struct
id|sock
op_star
id|sk
op_assign
id|tcp_bound_hash
(braket
id|tcp_bhashfn
c_func
(paren
id|num
)paren
)braket
suffix:semicolon
r_for
c_loop
(paren
suffix:semicolon
id|sk
op_ne
l_int|NULL
suffix:semicolon
id|sk
op_assign
id|sk-&gt;bind_next
)paren
(brace
r_if
c_cond
(paren
id|sk-&gt;num
op_eq
id|num
)paren
(brace
r_return
l_int|1
suffix:semicolon
)brace
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Find a &quot;good&quot; local port, this is family independant.&n; * There are several strategies working in unison here to&n; * get the best possible performance.  The current socket&n; * load is kept track of, if it is zero there is a strong&n; * likely hood that there is a zero length chain we will&n; * find with a small amount of searching, else the load is&n; * what we shoot for for when the chains all have at least&n; * one entry.  The base helps us walk the chains in an&n; * order such that a good chain is found as quickly as possible.  -DaveM&n; */
DECL|function|tcp_good_socknum
r_int
r_int
id|tcp_good_socknum
c_func
(paren
r_void
)paren
(brace
r_static
r_int
id|start
op_assign
l_int|0
suffix:semicolon
r_static
r_int
id|binding_contour
op_assign
l_int|0
suffix:semicolon
r_int
id|best
op_assign
l_int|0
suffix:semicolon
r_int
id|size
op_assign
l_int|32767
suffix:semicolon
multiline_comment|/* a big num. */
r_int
id|retval
op_assign
l_int|0
comma
id|i
comma
id|end
comma
id|bc
suffix:semicolon
id|SOCKHASH_LOCK
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|start
OG
id|sysctl_local_port_range
(braket
l_int|1
)braket
op_logical_or
id|start
OL
id|sysctl_local_port_range
(braket
l_int|0
)braket
)paren
id|start
op_assign
id|sysctl_local_port_range
(braket
l_int|0
)braket
suffix:semicolon
id|i
op_assign
id|tcp_bhashfn
c_func
(paren
id|start
)paren
suffix:semicolon
id|end
op_assign
id|i
op_plus
id|TCP_BHTABLE_SIZE
suffix:semicolon
id|bc
op_assign
id|binding_contour
suffix:semicolon
r_do
(brace
r_struct
id|sock
op_star
id|sk
op_assign
id|tcp_bound_hash
(braket
id|i
op_amp
(paren
id|TCP_BHTABLE_SIZE
op_minus
l_int|1
)paren
)braket
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|sk
)paren
(brace
multiline_comment|/* find the smallest value no smaller than start&n;                         * that has this hash value.&n;                         */
id|retval
op_assign
id|tcp_bhashnext
c_func
(paren
id|start
op_minus
l_int|1
comma
id|i
op_amp
(paren
id|TCP_BHTABLE_SIZE
op_minus
l_int|1
)paren
)paren
suffix:semicolon
multiline_comment|/* Check for decreasing load. */
r_if
c_cond
(paren
id|bc
op_ne
l_int|0
)paren
id|binding_contour
op_assign
l_int|0
suffix:semicolon
r_goto
id|done
suffix:semicolon
)brace
r_else
(brace
r_int
id|j
op_assign
l_int|0
suffix:semicolon
r_do
(brace
id|sk
op_assign
id|sk-&gt;bind_next
suffix:semicolon
)brace
r_while
c_loop
(paren
op_increment
id|j
OL
id|size
op_logical_and
id|sk
)paren
suffix:semicolon
r_if
c_cond
(paren
id|j
OL
id|size
)paren
(brace
id|best
op_assign
id|i
op_amp
(paren
id|TCP_BHTABLE_SIZE
op_minus
l_int|1
)paren
suffix:semicolon
id|size
op_assign
id|j
suffix:semicolon
r_if
c_cond
(paren
id|bc
op_logical_and
id|size
op_le
id|bc
)paren
r_goto
id|verify
suffix:semicolon
)brace
)brace
)brace
r_while
c_loop
(paren
op_increment
id|i
op_ne
id|end
)paren
(brace
suffix:semicolon
)brace
id|i
op_assign
id|best
suffix:semicolon
multiline_comment|/* Socket load is increasing, adjust our load average. */
id|binding_contour
op_assign
id|size
suffix:semicolon
id|verify
suffix:colon
r_if
c_cond
(paren
id|size
OL
id|binding_contour
)paren
id|binding_contour
op_assign
id|size
suffix:semicolon
id|retval
op_assign
id|tcp_bhashnext
c_func
(paren
id|start
op_minus
l_int|1
comma
id|i
)paren
suffix:semicolon
id|best
op_assign
id|retval
suffix:semicolon
multiline_comment|/* mark the starting point to avoid infinite loops */
r_while
c_loop
(paren
id|tcp_lport_inuse
c_func
(paren
id|retval
)paren
)paren
(brace
id|retval
op_assign
id|tcp_bhashnext
c_func
(paren
id|retval
comma
id|i
)paren
suffix:semicolon
r_if
c_cond
(paren
id|retval
OG
id|sysctl_local_port_range
(braket
l_int|1
)braket
)paren
multiline_comment|/* Upper bound */
id|retval
op_assign
id|tcp_bhashnext
c_func
(paren
id|sysctl_local_port_range
(braket
l_int|0
)braket
comma
id|i
)paren
suffix:semicolon
r_if
c_cond
(paren
id|retval
op_eq
id|best
)paren
(brace
multiline_comment|/* This hash chain is full. No answer. */
id|retval
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
id|done
suffix:colon
id|start
op_assign
(paren
id|retval
op_plus
l_int|1
)paren
suffix:semicolon
id|SOCKHASH_UNLOCK
c_func
(paren
)paren
suffix:semicolon
r_return
id|retval
suffix:semicolon
)brace
DECL|function|tcp_v4_hash
r_static
r_void
id|tcp_v4_hash
c_func
(paren
r_struct
id|sock
op_star
id|sk
)paren
(brace
r_int
r_char
id|state
suffix:semicolon
id|SOCKHASH_LOCK
c_func
(paren
)paren
suffix:semicolon
id|state
op_assign
id|sk-&gt;state
suffix:semicolon
r_if
c_cond
(paren
id|state
op_ne
id|TCP_CLOSE
op_logical_or
op_logical_neg
id|sk-&gt;dead
)paren
(brace
r_struct
id|sock
op_star
op_star
id|skp
suffix:semicolon
r_if
c_cond
(paren
id|state
op_eq
id|TCP_LISTEN
)paren
(brace
id|skp
op_assign
op_amp
id|tcp_listening_hash
(braket
id|tcp_sk_listen_hashfn
c_func
(paren
id|sk
)paren
)braket
suffix:semicolon
)brace
r_else
id|skp
op_assign
op_amp
id|tcp_established_hash
(braket
id|tcp_sk_hashfn
c_func
(paren
id|sk
)paren
)braket
suffix:semicolon
r_if
c_cond
(paren
(paren
id|sk-&gt;next
op_assign
op_star
id|skp
)paren
op_ne
l_int|NULL
)paren
(brace
(paren
op_star
id|skp
)paren
op_member_access_from_pointer
id|pprev
op_assign
op_amp
id|sk-&gt;next
suffix:semicolon
)brace
op_star
id|skp
op_assign
id|sk
suffix:semicolon
id|sk-&gt;pprev
op_assign
id|skp
suffix:semicolon
id|tcp_sk_bindify
c_func
(paren
id|sk
)paren
suffix:semicolon
)brace
id|SOCKHASH_UNLOCK
c_func
(paren
)paren
suffix:semicolon
)brace
DECL|function|tcp_v4_unhash
r_static
r_void
id|tcp_v4_unhash
c_func
(paren
r_struct
id|sock
op_star
id|sk
)paren
(brace
id|SOCKHASH_LOCK
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sk-&gt;pprev
)paren
(brace
r_if
c_cond
(paren
id|sk-&gt;next
)paren
(brace
id|sk-&gt;next-&gt;pprev
op_assign
id|sk-&gt;pprev
suffix:semicolon
)brace
op_star
id|sk-&gt;pprev
op_assign
id|sk-&gt;next
suffix:semicolon
id|sk-&gt;pprev
op_assign
l_int|NULL
suffix:semicolon
id|tcp_sk_unbindify
c_func
(paren
id|sk
)paren
suffix:semicolon
)brace
id|SOCKHASH_UNLOCK
c_func
(paren
)paren
suffix:semicolon
)brace
DECL|function|tcp_v4_rehash
r_static
r_void
id|tcp_v4_rehash
c_func
(paren
r_struct
id|sock
op_star
id|sk
)paren
(brace
r_int
r_char
id|state
suffix:semicolon
id|SOCKHASH_LOCK
c_func
(paren
)paren
suffix:semicolon
id|state
op_assign
id|sk-&gt;state
suffix:semicolon
r_if
c_cond
(paren
id|sk-&gt;pprev
)paren
(brace
r_if
c_cond
(paren
id|sk-&gt;next
)paren
(brace
id|sk-&gt;next-&gt;pprev
op_assign
id|sk-&gt;pprev
suffix:semicolon
)brace
op_star
id|sk-&gt;pprev
op_assign
id|sk-&gt;next
suffix:semicolon
id|sk-&gt;pprev
op_assign
l_int|NULL
suffix:semicolon
id|tcp_sk_unbindify
c_func
(paren
id|sk
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|state
op_ne
id|TCP_CLOSE
op_logical_or
op_logical_neg
id|sk-&gt;dead
)paren
(brace
r_struct
id|sock
op_star
op_star
id|skp
suffix:semicolon
r_if
c_cond
(paren
id|state
op_eq
id|TCP_LISTEN
)paren
(brace
id|skp
op_assign
op_amp
id|tcp_listening_hash
(braket
id|tcp_sk_listen_hashfn
c_func
(paren
id|sk
)paren
)braket
suffix:semicolon
)brace
r_else
(brace
r_int
id|hash
op_assign
id|tcp_sk_hashfn
c_func
(paren
id|sk
)paren
suffix:semicolon
r_if
c_cond
(paren
id|state
op_eq
id|TCP_TIME_WAIT
)paren
(brace
id|hash
op_add_assign
(paren
id|TCP_HTABLE_SIZE
op_div
l_int|2
)paren
suffix:semicolon
)brace
id|skp
op_assign
op_amp
id|tcp_established_hash
(braket
id|hash
)braket
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|sk-&gt;next
op_assign
op_star
id|skp
)paren
op_ne
l_int|NULL
)paren
(brace
(paren
op_star
id|skp
)paren
op_member_access_from_pointer
id|pprev
op_assign
op_amp
id|sk-&gt;next
suffix:semicolon
)brace
op_star
id|skp
op_assign
id|sk
suffix:semicolon
id|sk-&gt;pprev
op_assign
id|skp
suffix:semicolon
id|tcp_sk_bindify
c_func
(paren
id|sk
)paren
suffix:semicolon
)brace
id|SOCKHASH_UNLOCK
c_func
(paren
)paren
suffix:semicolon
)brace
multiline_comment|/* Don&squot;t inline this cruft.  Here are some nice properties to&n; * exploit here.  The BSD API does not allow a listening TCP&n; * to specify the remote port nor the remote address for the&n; * connection.  So always assume those are both wildcarded&n; * during the search since they can never be otherwise.&n; */
DECL|function|tcp_v4_lookup_listener
r_static
r_struct
id|sock
op_star
id|tcp_v4_lookup_listener
c_func
(paren
id|u32
id|daddr
comma
r_int
r_int
id|hnum
comma
r_int
id|dif
)paren
(brace
r_struct
id|sock
op_star
id|sk
suffix:semicolon
r_struct
id|sock
op_star
id|result
op_assign
l_int|NULL
suffix:semicolon
r_int
id|score
comma
id|hiscore
suffix:semicolon
id|hiscore
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|sk
op_assign
id|tcp_listening_hash
(braket
id|tcp_lhashfn
c_func
(paren
id|hnum
)paren
)braket
suffix:semicolon
id|sk
suffix:semicolon
id|sk
op_assign
id|sk-&gt;next
)paren
(brace
r_if
c_cond
(paren
id|sk-&gt;num
op_eq
id|hnum
)paren
(brace
id|__u32
id|rcv_saddr
op_assign
id|sk-&gt;rcv_saddr
suffix:semicolon
id|score
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|rcv_saddr
)paren
(brace
r_if
c_cond
(paren
id|rcv_saddr
op_ne
id|daddr
)paren
r_continue
suffix:semicolon
id|score
op_increment
suffix:semicolon
)brace
r_if
c_cond
(paren
id|sk-&gt;bound_dev_if
)paren
(brace
r_if
c_cond
(paren
id|sk-&gt;bound_dev_if
op_ne
id|dif
)paren
r_continue
suffix:semicolon
id|score
op_increment
suffix:semicolon
)brace
r_if
c_cond
(paren
id|score
op_eq
l_int|3
)paren
r_return
id|sk
suffix:semicolon
r_if
c_cond
(paren
id|score
OG
id|hiscore
)paren
(brace
id|hiscore
op_assign
id|score
suffix:semicolon
id|result
op_assign
id|sk
suffix:semicolon
)brace
)brace
)brace
r_return
id|result
suffix:semicolon
)brace
multiline_comment|/* Sockets in TCP_CLOSE state are _always_ taken out of the hash, so&n; * we need not check it for TCP lookups anymore, thanks Alexey. -DaveM&n; */
DECL|function|__tcp_v4_lookup
r_static
r_inline
r_struct
id|sock
op_star
id|__tcp_v4_lookup
c_func
(paren
r_struct
id|tcphdr
op_star
id|th
comma
id|u32
id|saddr
comma
id|u16
id|sport
comma
id|u32
id|daddr
comma
id|u16
id|dport
comma
r_int
id|dif
)paren
(brace
r_int
r_int
id|hnum
op_assign
id|ntohs
c_func
(paren
id|dport
)paren
suffix:semicolon
r_struct
id|sock
op_star
id|sk
suffix:semicolon
r_int
id|hash
op_assign
id|tcp_hashfn
c_func
(paren
id|daddr
comma
id|hnum
comma
id|saddr
comma
id|sport
)paren
suffix:semicolon
multiline_comment|/* Optimize here for direct hit, only listening connections can&n;&t; * have wildcards anyways.  It is assumed that this code only&n;&t; * gets called from within NET_BH.&n;&t; */
r_for
c_loop
(paren
id|sk
op_assign
id|tcp_established_hash
(braket
id|hash
)braket
suffix:semicolon
id|sk
suffix:semicolon
id|sk
op_assign
id|sk-&gt;next
)paren
r_if
c_cond
(paren
id|sk-&gt;daddr
op_eq
id|saddr
op_logical_and
multiline_comment|/* remote address */
id|sk-&gt;dummy_th.dest
op_eq
id|sport
op_logical_and
multiline_comment|/* remote port    */
id|sk-&gt;num
op_eq
id|hnum
op_logical_and
multiline_comment|/* local port     */
id|sk-&gt;rcv_saddr
op_eq
id|daddr
op_logical_and
multiline_comment|/* local address  */
(paren
op_logical_neg
id|sk-&gt;bound_dev_if
op_logical_or
id|sk-&gt;bound_dev_if
op_eq
id|dif
)paren
)paren
(brace
r_goto
id|hit
suffix:semicolon
)brace
multiline_comment|/* You sunk my battleship! */
multiline_comment|/* Must check for a TIME_WAIT&squot;er before going to listener hash. */
r_for
c_loop
(paren
id|sk
op_assign
id|tcp_established_hash
(braket
id|hash
op_plus
(paren
id|TCP_HTABLE_SIZE
op_div
l_int|2
)paren
)braket
suffix:semicolon
id|sk
suffix:semicolon
id|sk
op_assign
id|sk-&gt;next
)paren
r_if
c_cond
(paren
id|sk-&gt;daddr
op_eq
id|saddr
op_logical_and
multiline_comment|/* remote address */
id|sk-&gt;dummy_th.dest
op_eq
id|sport
op_logical_and
multiline_comment|/* remote port    */
id|sk-&gt;num
op_eq
id|hnum
op_logical_and
multiline_comment|/* local port     */
id|sk-&gt;rcv_saddr
op_eq
id|daddr
op_logical_and
multiline_comment|/* local address  */
(paren
op_logical_neg
id|sk-&gt;bound_dev_if
op_logical_or
id|sk-&gt;bound_dev_if
op_eq
id|dif
)paren
)paren
(brace
r_goto
id|hit
suffix:semicolon
)brace
id|sk
op_assign
id|tcp_v4_lookup_listener
c_func
(paren
id|daddr
comma
id|hnum
comma
id|dif
)paren
suffix:semicolon
id|hit
suffix:colon
r_return
id|sk
suffix:semicolon
)brace
DECL|function|tcp_v4_lookup
id|__inline__
r_struct
id|sock
op_star
id|tcp_v4_lookup
c_func
(paren
id|u32
id|saddr
comma
id|u16
id|sport
comma
id|u32
id|daddr
comma
id|u16
id|dport
comma
r_int
id|dif
)paren
(brace
r_return
id|__tcp_v4_lookup
c_func
(paren
l_int|0
comma
id|saddr
comma
id|sport
comma
id|daddr
comma
id|dport
comma
id|dif
)paren
suffix:semicolon
)brace
macro_line|#ifdef CONFIG_IP_TRANSPARENT_PROXY
DECL|macro|secondlist
mdefine_line|#define secondlist(hpnum, sk, fpass) &bslash;&n;({ struct sock *s1; if(!(sk) &amp;&amp; (fpass)--) &bslash;&n;&t;s1 = tcp_bound_hash[tcp_bhashfn(hpnum)]; &bslash;&n;   else &bslash;&n;&t;s1 = (sk); &bslash;&n;   s1; &bslash;&n;})
DECL|macro|tcp_v4_proxy_loop_init
mdefine_line|#define tcp_v4_proxy_loop_init(hnum, hpnum, sk, fpass) &bslash;&n;&t;secondlist((hpnum), tcp_bound_hash[tcp_bhashfn(hnum)],(fpass))
DECL|macro|tcp_v4_proxy_loop_next
mdefine_line|#define tcp_v4_proxy_loop_next(hnum, hpnum, sk, fpass) &bslash;&n;&t;secondlist((hpnum),(sk)-&gt;bind_next,(fpass))
DECL|function|tcp_v4_proxy_lookup
r_static
r_struct
id|sock
op_star
id|tcp_v4_proxy_lookup
c_func
(paren
r_int
r_int
id|num
comma
r_int
r_int
id|raddr
comma
r_int
r_int
id|rnum
comma
r_int
r_int
id|laddr
comma
r_struct
id|device
op_star
id|dev
comma
r_int
r_int
id|pnum
comma
r_int
id|dif
)paren
(brace
r_struct
id|sock
op_star
id|s
comma
op_star
id|result
op_assign
l_int|NULL
suffix:semicolon
r_int
id|badness
op_assign
op_minus
l_int|1
suffix:semicolon
id|u32
id|paddr
op_assign
l_int|0
suffix:semicolon
r_int
r_int
id|hnum
op_assign
id|ntohs
c_func
(paren
id|num
)paren
suffix:semicolon
r_int
r_int
id|hpnum
op_assign
id|ntohs
c_func
(paren
id|pnum
)paren
suffix:semicolon
r_int
id|firstpass
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|dev
op_logical_and
id|dev-&gt;ip_ptr
)paren
(brace
r_struct
id|in_device
op_star
id|idev
op_assign
id|dev-&gt;ip_ptr
suffix:semicolon
r_if
c_cond
(paren
id|idev-&gt;ifa_list
)paren
(brace
id|paddr
op_assign
id|idev-&gt;ifa_list-&gt;ifa_local
suffix:semicolon
)brace
)brace
multiline_comment|/* This code must run only from NET_BH. */
r_for
c_loop
(paren
id|s
op_assign
id|tcp_v4_proxy_loop_init
c_func
(paren
id|hnum
comma
id|hpnum
comma
id|s
comma
id|firstpass
)paren
suffix:semicolon
id|s
op_ne
l_int|NULL
suffix:semicolon
id|s
op_assign
id|tcp_v4_proxy_loop_next
c_func
(paren
id|hnum
comma
id|hpnum
comma
id|s
comma
id|firstpass
)paren
)paren
(brace
r_if
c_cond
(paren
id|s-&gt;num
op_eq
id|hnum
op_logical_or
id|s-&gt;num
op_eq
id|hpnum
)paren
(brace
r_int
id|score
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|s-&gt;dead
op_logical_and
(paren
id|s-&gt;state
op_eq
id|TCP_CLOSE
)paren
)paren
(brace
r_continue
suffix:semicolon
)brace
r_if
c_cond
(paren
id|s-&gt;rcv_saddr
)paren
(brace
r_if
c_cond
(paren
(paren
id|s-&gt;num
op_ne
id|hpnum
op_logical_or
id|s-&gt;rcv_saddr
op_ne
id|paddr
)paren
op_logical_and
(paren
id|s-&gt;num
op_ne
id|hnum
op_logical_or
id|s-&gt;rcv_saddr
op_ne
id|laddr
)paren
)paren
(brace
r_continue
suffix:semicolon
)brace
id|score
op_increment
suffix:semicolon
)brace
r_if
c_cond
(paren
id|s-&gt;daddr
)paren
(brace
r_if
c_cond
(paren
id|s-&gt;daddr
op_ne
id|raddr
)paren
(brace
r_continue
suffix:semicolon
)brace
id|score
op_increment
suffix:semicolon
)brace
r_if
c_cond
(paren
id|s-&gt;dummy_th.dest
)paren
(brace
r_if
c_cond
(paren
id|s-&gt;dummy_th.dest
op_ne
id|rnum
)paren
(brace
r_continue
suffix:semicolon
)brace
id|score
op_increment
suffix:semicolon
)brace
r_if
c_cond
(paren
id|s-&gt;bound_dev_if
)paren
(brace
r_if
c_cond
(paren
id|s-&gt;bound_dev_if
op_ne
id|dif
)paren
(brace
r_continue
suffix:semicolon
)brace
id|score
op_increment
suffix:semicolon
)brace
r_if
c_cond
(paren
id|score
op_eq
l_int|4
op_logical_and
id|s-&gt;num
op_eq
id|hnum
)paren
(brace
id|result
op_assign
id|s
suffix:semicolon
r_break
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|score
OG
id|badness
op_logical_and
(paren
id|s-&gt;num
op_eq
id|hpnum
op_logical_or
id|s-&gt;rcv_saddr
)paren
)paren
(brace
id|result
op_assign
id|s
suffix:semicolon
id|badness
op_assign
id|score
suffix:semicolon
)brace
)brace
)brace
r_return
id|result
suffix:semicolon
)brace
DECL|macro|secondlist
macro_line|#undef secondlist
DECL|macro|tcp_v4_proxy_loop_init
macro_line|#undef tcp_v4_proxy_loop_init
DECL|macro|tcp_v4_proxy_loop_next
macro_line|#undef tcp_v4_proxy_loop_next
macro_line|#endif
DECL|function|tcp_v4_init_sequence
r_static
r_inline
id|__u32
id|tcp_v4_init_sequence
c_func
(paren
r_struct
id|sock
op_star
id|sk
comma
r_struct
id|sk_buff
op_star
id|skb
)paren
(brace
r_return
id|secure_tcp_sequence_number
c_func
(paren
id|sk-&gt;saddr
comma
id|sk-&gt;daddr
comma
id|skb-&gt;h.th-&gt;dest
comma
id|skb-&gt;h.th-&gt;source
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;From tcp.c&n; */
multiline_comment|/*&n; * Check that a TCP address is unique, don&squot;t allow multiple&n; * connects to/from the same address&n; */
DECL|function|tcp_unique_address
r_static
r_int
id|tcp_unique_address
c_func
(paren
id|u32
id|saddr
comma
id|u16
id|snum
comma
id|u32
id|daddr
comma
id|u16
id|dnum
)paren
(brace
r_int
id|retval
op_assign
l_int|1
comma
id|hashent
op_assign
id|tcp_hashfn
c_func
(paren
id|saddr
comma
id|snum
comma
id|daddr
comma
id|dnum
)paren
suffix:semicolon
r_struct
id|sock
op_star
id|sk
suffix:semicolon
multiline_comment|/* Make sure we are allowed to connect here.&n;&t; * But freeze the hash while we snoop around.&n;&t; */
id|SOCKHASH_LOCK
c_func
(paren
)paren
suffix:semicolon
id|sk
op_assign
id|tcp_established_hash
(braket
id|hashent
)braket
suffix:semicolon
r_for
c_loop
(paren
suffix:semicolon
id|sk
op_ne
l_int|NULL
suffix:semicolon
id|sk
op_assign
id|sk-&gt;next
)paren
(brace
r_if
c_cond
(paren
id|sk-&gt;daddr
op_eq
id|daddr
op_logical_and
multiline_comment|/* remote address */
id|sk-&gt;dummy_th.dest
op_eq
id|dnum
op_logical_and
multiline_comment|/* remote port */
id|sk-&gt;num
op_eq
id|snum
op_logical_and
multiline_comment|/* local port */
id|sk-&gt;saddr
op_eq
id|saddr
)paren
(brace
multiline_comment|/* local address */
id|retval
op_assign
l_int|0
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
)brace
multiline_comment|/* Must check TIME_WAIT&squot;ers too. */
id|sk
op_assign
id|tcp_established_hash
(braket
id|hashent
op_plus
(paren
id|TCP_HTABLE_SIZE
op_div
l_int|2
)paren
)braket
suffix:semicolon
r_for
c_loop
(paren
suffix:semicolon
id|sk
op_ne
l_int|NULL
suffix:semicolon
id|sk
op_assign
id|sk-&gt;next
)paren
(brace
r_if
c_cond
(paren
id|sk-&gt;daddr
op_eq
id|daddr
op_logical_and
multiline_comment|/* remote address */
id|sk-&gt;dummy_th.dest
op_eq
id|dnum
op_logical_and
multiline_comment|/* remote port */
id|sk-&gt;num
op_eq
id|snum
op_logical_and
multiline_comment|/* local port */
id|sk-&gt;saddr
op_eq
id|saddr
)paren
(brace
multiline_comment|/* local address */
id|retval
op_assign
l_int|0
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
)brace
id|out
suffix:colon
id|SOCKHASH_UNLOCK
c_func
(paren
)paren
suffix:semicolon
r_return
id|retval
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;This will initiate an outgoing connection. &n; */
DECL|function|tcp_v4_connect
r_int
id|tcp_v4_connect
c_func
(paren
r_struct
id|sock
op_star
id|sk
comma
r_struct
id|sockaddr
op_star
id|uaddr
comma
r_int
id|addr_len
)paren
(brace
r_struct
id|sk_buff
op_star
id|buff
suffix:semicolon
r_int
id|tmp
suffix:semicolon
r_struct
id|tcphdr
op_star
id|th
suffix:semicolon
r_struct
id|rtable
op_star
id|rt
suffix:semicolon
r_struct
id|tcp_opt
op_star
id|tp
op_assign
op_amp
(paren
id|sk-&gt;tp_pinfo.af_tcp
)paren
suffix:semicolon
r_struct
id|sockaddr_in
op_star
id|usin
op_assign
(paren
r_struct
id|sockaddr_in
op_star
)paren
id|uaddr
suffix:semicolon
r_if
c_cond
(paren
id|sk-&gt;state
op_ne
id|TCP_CLOSE
)paren
r_return
op_minus
id|EISCONN
suffix:semicolon
multiline_comment|/* Don&squot;t allow a double connect. */
r_if
c_cond
(paren
id|sk-&gt;daddr
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|addr_len
OL
r_sizeof
(paren
r_struct
id|sockaddr_in
)paren
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|usin-&gt;sin_family
op_ne
id|AF_INET
)paren
(brace
r_static
r_int
id|complained
suffix:semicolon
r_if
c_cond
(paren
id|usin-&gt;sin_family
)paren
r_return
op_minus
id|EAFNOSUPPORT
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|complained
op_increment
)paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%s forgot to set AF_INET in &quot;
id|__FUNCTION__
l_string|&quot;&bslash;n&quot;
comma
id|current-&gt;comm
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|sk-&gt;dst_cache
)paren
(brace
id|dst_release
c_func
(paren
id|sk-&gt;dst_cache
)paren
suffix:semicolon
id|sk-&gt;dst_cache
op_assign
l_int|NULL
suffix:semicolon
)brace
id|tmp
op_assign
id|ip_route_connect
c_func
(paren
op_amp
id|rt
comma
id|usin-&gt;sin_addr.s_addr
comma
id|sk-&gt;saddr
comma
id|RT_TOS
c_func
(paren
id|sk-&gt;ip_tos
)paren
op_or
(paren
id|sk-&gt;localroute
op_logical_or
l_int|0
)paren
comma
id|sk-&gt;bound_dev_if
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tmp
OL
l_int|0
)paren
r_return
id|tmp
suffix:semicolon
r_if
c_cond
(paren
id|rt-&gt;rt_flags
op_amp
(paren
id|RTCF_MULTICAST
op_or
id|RTCF_BROADCAST
)paren
)paren
(brace
id|ip_rt_put
c_func
(paren
id|rt
)paren
suffix:semicolon
r_return
op_minus
id|ENETUNREACH
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|tcp_unique_address
c_func
(paren
id|rt-&gt;rt_src
comma
id|sk-&gt;num
comma
id|rt-&gt;rt_dst
comma
id|usin-&gt;sin_port
)paren
)paren
(brace
id|ip_rt_put
c_func
(paren
id|rt
)paren
suffix:semicolon
r_return
op_minus
id|EADDRNOTAVAIL
suffix:semicolon
)brace
id|lock_sock
c_func
(paren
id|sk
)paren
suffix:semicolon
multiline_comment|/* Do this early, so there is less state to unwind on failure. */
id|buff
op_assign
id|sock_wmalloc
c_func
(paren
id|sk
comma
id|MAX_SYN_SIZE
comma
l_int|0
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|buff
op_eq
l_int|NULL
)paren
(brace
id|release_sock
c_func
(paren
id|sk
)paren
suffix:semicolon
id|ip_rt_put
c_func
(paren
id|rt
)paren
suffix:semicolon
r_return
op_minus
id|ENOBUFS
suffix:semicolon
)brace
id|sk-&gt;dst_cache
op_assign
op_amp
id|rt-&gt;u.dst
suffix:semicolon
id|sk-&gt;daddr
op_assign
id|rt-&gt;rt_dst
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|sk-&gt;saddr
)paren
id|sk-&gt;saddr
op_assign
id|rt-&gt;rt_src
suffix:semicolon
id|sk-&gt;rcv_saddr
op_assign
id|sk-&gt;saddr
suffix:semicolon
r_if
c_cond
(paren
id|sk-&gt;priority
op_eq
l_int|0
)paren
id|sk-&gt;priority
op_assign
id|rt-&gt;u.dst.priority
suffix:semicolon
id|sk-&gt;dummy_th.dest
op_assign
id|usin-&gt;sin_port
suffix:semicolon
id|sk-&gt;write_seq
op_assign
id|secure_tcp_sequence_number
c_func
(paren
id|sk-&gt;saddr
comma
id|sk-&gt;daddr
comma
id|sk-&gt;dummy_th.source
comma
id|usin-&gt;sin_port
)paren
suffix:semicolon
id|tp-&gt;snd_wnd
op_assign
l_int|0
suffix:semicolon
id|tp-&gt;snd_wl1
op_assign
l_int|0
suffix:semicolon
id|tp-&gt;snd_wl2
op_assign
id|sk-&gt;write_seq
suffix:semicolon
id|tp-&gt;snd_una
op_assign
id|sk-&gt;write_seq
suffix:semicolon
id|tp-&gt;rcv_nxt
op_assign
l_int|0
suffix:semicolon
id|sk-&gt;err
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Put in the IP header and routing stuff. */
id|tmp
op_assign
id|ip_build_header
c_func
(paren
id|buff
comma
id|sk
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tmp
OL
l_int|0
)paren
(brace
multiline_comment|/* Caller has done ip_rt_put(rt) and set sk-&gt;dst_cache&n;&t;&t; * to NULL.  We must unwind the half built TCP socket&n;&t;&t; * state so that this failure does not create a &quot;stillborn&quot;&n;&t;&t; * sock (ie. future re-tries of connect() would fail).&n;&t;&t; */
id|sk-&gt;daddr
op_assign
l_int|0
suffix:semicolon
id|sk-&gt;saddr
op_assign
id|sk-&gt;rcv_saddr
op_assign
l_int|0
suffix:semicolon
id|kfree_skb
c_func
(paren
id|buff
comma
id|FREE_WRITE
)paren
suffix:semicolon
id|release_sock
c_func
(paren
id|sk
)paren
suffix:semicolon
r_return
op_minus
id|ENETUNREACH
suffix:semicolon
)brace
multiline_comment|/* No failure conditions can result past this point. */
id|th
op_assign
(paren
r_struct
id|tcphdr
op_star
)paren
id|skb_put
c_func
(paren
id|buff
comma
r_sizeof
(paren
r_struct
id|tcphdr
)paren
)paren
suffix:semicolon
id|buff-&gt;h.th
op_assign
id|th
suffix:semicolon
id|memcpy
c_func
(paren
id|th
comma
(paren
r_void
op_star
)paren
op_amp
(paren
id|sk-&gt;dummy_th
)paren
comma
r_sizeof
(paren
op_star
id|th
)paren
)paren
suffix:semicolon
id|buff-&gt;seq
op_assign
id|sk-&gt;write_seq
op_increment
suffix:semicolon
id|th-&gt;seq
op_assign
id|htonl
c_func
(paren
id|buff-&gt;seq
)paren
suffix:semicolon
id|tp-&gt;snd_nxt
op_assign
id|sk-&gt;write_seq
suffix:semicolon
id|buff-&gt;end_seq
op_assign
id|sk-&gt;write_seq
suffix:semicolon
id|th-&gt;ack
op_assign
l_int|0
suffix:semicolon
id|th-&gt;syn
op_assign
l_int|1
suffix:semicolon
id|sk-&gt;mtu
op_assign
id|rt-&gt;u.dst.pmtu
suffix:semicolon
r_if
c_cond
(paren
(paren
id|sk-&gt;ip_pmtudisc
op_eq
id|IP_PMTUDISC_DONT
op_logical_or
(paren
id|sk-&gt;ip_pmtudisc
op_eq
id|IP_PMTUDISC_WANT
op_logical_and
id|rt-&gt;rt_flags
op_amp
id|RTCF_NOPMTUDISC
)paren
)paren
op_logical_and
id|rt-&gt;u.dst.pmtu
OG
l_int|576
)paren
id|sk-&gt;mtu
op_assign
l_int|576
suffix:semicolon
r_if
c_cond
(paren
id|sk-&gt;mtu
OL
l_int|64
)paren
(brace
id|sk-&gt;mtu
op_assign
l_int|64
suffix:semicolon
)brace
multiline_comment|/* Sanity limit */
r_if
c_cond
(paren
id|sk-&gt;user_mss
)paren
id|sk-&gt;mss
op_assign
id|sk-&gt;user_mss
suffix:semicolon
r_else
id|sk-&gt;mss
op_assign
(paren
id|sk-&gt;mtu
op_minus
r_sizeof
(paren
r_struct
id|iphdr
)paren
op_minus
r_sizeof
(paren
r_struct
id|tcphdr
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sk-&gt;mss
OL
l_int|1
)paren
(brace
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;intial sk-&gt;mss below 1&bslash;n&quot;
)paren
suffix:semicolon
id|sk-&gt;mss
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* Sanity limit */
)brace
id|tp-&gt;window_clamp
op_assign
id|rt-&gt;u.dst.window
suffix:semicolon
id|tcp_select_initial_window
c_func
(paren
id|sock_rspace
c_func
(paren
id|sk
)paren
op_div
l_int|2
comma
id|sk-&gt;mss
comma
op_amp
id|tp-&gt;rcv_wnd
comma
op_amp
id|tp-&gt;window_clamp
comma
id|sysctl_tcp_window_scaling
comma
op_amp
id|tp-&gt;rcv_wscale
)paren
suffix:semicolon
id|th-&gt;window
op_assign
id|htons
c_func
(paren
id|tp-&gt;rcv_wnd
)paren
suffix:semicolon
id|tmp
op_assign
id|tcp_syn_build_options
c_func
(paren
id|buff
comma
id|sk-&gt;mss
comma
id|sysctl_tcp_sack
comma
id|sysctl_tcp_timestamps
comma
id|sysctl_tcp_window_scaling
comma
id|tp-&gt;rcv_wscale
)paren
suffix:semicolon
id|buff-&gt;csum
op_assign
l_int|0
suffix:semicolon
id|th-&gt;doff
op_assign
(paren
r_sizeof
(paren
op_star
id|th
)paren
op_plus
id|tmp
)paren
op_rshift
l_int|2
suffix:semicolon
id|tcp_v4_send_check
c_func
(paren
id|sk
comma
id|th
comma
r_sizeof
(paren
r_struct
id|tcphdr
)paren
op_plus
id|tmp
comma
id|buff
)paren
suffix:semicolon
id|tcp_set_state
c_func
(paren
id|sk
comma
id|TCP_SYN_SENT
)paren
suffix:semicolon
multiline_comment|/* Socket identity change complete, no longer&n;&t; * in TCP_CLOSE, so rehash.&n;&t; */
id|tcp_v4_rehash
c_func
(paren
id|sk
)paren
suffix:semicolon
id|tp-&gt;rto
op_assign
id|rt-&gt;u.dst.rtt
suffix:semicolon
id|tcp_init_xmit_timers
c_func
(paren
id|sk
)paren
suffix:semicolon
multiline_comment|/* Now works the right way instead of a hacked initial setting. */
id|tp-&gt;retransmits
op_assign
l_int|0
suffix:semicolon
id|skb_queue_tail
c_func
(paren
op_amp
id|sk-&gt;write_queue
comma
id|buff
)paren
suffix:semicolon
id|tp-&gt;packets_out
op_increment
suffix:semicolon
id|buff-&gt;when
op_assign
id|jiffies
suffix:semicolon
id|ip_queue_xmit
c_func
(paren
id|skb_clone
c_func
(paren
id|buff
comma
id|GFP_KERNEL
)paren
)paren
suffix:semicolon
multiline_comment|/* Timer for repeating the SYN until an answer. */
id|tcp_reset_xmit_timer
c_func
(paren
id|sk
comma
id|TIME_RETRANS
comma
id|tp-&gt;rto
)paren
suffix:semicolon
id|tcp_statistics.TcpActiveOpens
op_increment
suffix:semicolon
id|tcp_statistics.TcpOutSegs
op_increment
suffix:semicolon
id|release_sock
c_func
(paren
id|sk
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|tcp_v4_sendmsg
r_static
r_int
id|tcp_v4_sendmsg
c_func
(paren
r_struct
id|sock
op_star
id|sk
comma
r_struct
id|msghdr
op_star
id|msg
comma
r_int
id|len
)paren
(brace
r_int
id|retval
op_assign
op_minus
id|EINVAL
suffix:semicolon
multiline_comment|/* Do sanity checking for sendmsg/sendto/send. */
r_if
c_cond
(paren
id|msg-&gt;msg_flags
op_amp
op_complement
(paren
id|MSG_OOB
op_or
id|MSG_DONTROUTE
op_or
id|MSG_DONTWAIT
)paren
)paren
r_goto
id|out
suffix:semicolon
r_if
c_cond
(paren
id|msg-&gt;msg_name
)paren
(brace
r_struct
id|sockaddr_in
op_star
id|addr
op_assign
(paren
r_struct
id|sockaddr_in
op_star
)paren
id|msg-&gt;msg_name
suffix:semicolon
r_if
c_cond
(paren
id|msg-&gt;msg_namelen
OL
r_sizeof
(paren
op_star
id|addr
)paren
)paren
r_goto
id|out
suffix:semicolon
r_if
c_cond
(paren
id|addr-&gt;sin_family
op_logical_and
id|addr-&gt;sin_family
op_ne
id|AF_INET
)paren
r_goto
id|out
suffix:semicolon
id|retval
op_assign
op_minus
id|ENOTCONN
suffix:semicolon
r_if
c_cond
(paren
id|sk-&gt;state
op_eq
id|TCP_CLOSE
)paren
(brace
r_goto
id|out
suffix:semicolon
)brace
id|retval
op_assign
op_minus
id|EISCONN
suffix:semicolon
r_if
c_cond
(paren
id|addr-&gt;sin_port
op_ne
id|sk-&gt;dummy_th.dest
)paren
r_goto
id|out
suffix:semicolon
r_if
c_cond
(paren
id|addr-&gt;sin_addr.s_addr
op_ne
id|sk-&gt;daddr
)paren
r_goto
id|out
suffix:semicolon
)brace
id|lock_sock
c_func
(paren
id|sk
)paren
suffix:semicolon
id|retval
op_assign
id|tcp_do_sendmsg
c_func
(paren
id|sk
comma
id|msg-&gt;msg_iovlen
comma
id|msg-&gt;msg_iov
comma
id|msg-&gt;msg_flags
)paren
suffix:semicolon
id|release_sock
c_func
(paren
id|sk
)paren
suffix:semicolon
id|out
suffix:colon
r_return
id|retval
suffix:semicolon
)brace
multiline_comment|/*&n; * Do a linear search in the socket open_request list. &n; * This should be replaced with a global hash table.&n; */
DECL|function|tcp_v4_search_req
r_static
r_struct
id|open_request
op_star
id|tcp_v4_search_req
c_func
(paren
r_struct
id|tcp_opt
op_star
id|tp
comma
r_struct
id|iphdr
op_star
id|iph
comma
r_struct
id|tcphdr
op_star
id|th
comma
r_struct
id|open_request
op_star
op_star
id|prevp
)paren
(brace
r_struct
id|open_request
op_star
id|req
comma
op_star
id|prev
suffix:semicolon
id|__u16
id|rport
op_assign
id|th-&gt;source
suffix:semicolon
multiline_comment|/*&t;assumption: the socket is not in use.&n;&t; *&t;as we checked the user count on tcp_rcv and we&squot;re&n;&t; *&t;running from a soft interrupt.&n;&t; */
id|prev
op_assign
(paren
r_struct
id|open_request
op_star
)paren
(paren
op_amp
id|tp-&gt;syn_wait_queue
)paren
suffix:semicolon
r_for
c_loop
(paren
id|req
op_assign
id|prev-&gt;dl_next
suffix:semicolon
id|req
suffix:semicolon
id|req
op_assign
id|req-&gt;dl_next
)paren
(brace
r_if
c_cond
(paren
id|req-&gt;af.v4_req.rmt_addr
op_eq
id|iph-&gt;saddr
op_logical_and
id|req-&gt;af.v4_req.loc_addr
op_eq
id|iph-&gt;daddr
op_logical_and
id|req-&gt;rmt_port
op_eq
id|rport
)paren
(brace
op_star
id|prevp
op_assign
id|prev
suffix:semicolon
r_return
id|req
suffix:semicolon
)brace
id|prev
op_assign
id|req
suffix:semicolon
)brace
r_return
l_int|NULL
suffix:semicolon
)brace
multiline_comment|/* &n; * This routine does path mtu discovery as defined in RFC1197.&n; */
DECL|function|do_pmtu_discovery
r_static
r_inline
r_void
id|do_pmtu_discovery
c_func
(paren
r_struct
id|sock
op_star
id|sk
comma
r_struct
id|iphdr
op_star
id|ip
)paren
(brace
r_int
id|new_mtu
suffix:semicolon
r_struct
id|tcp_opt
op_star
id|tp
op_assign
op_amp
id|sk-&gt;tp_pinfo.af_tcp
suffix:semicolon
multiline_comment|/* Don&squot;t interested in TCP_LISTEN and open_requests (SYN-ACKs&n;&t; * send out by Linux are always &lt;576bytes so they should go through&n;&t; * unfragmented).&n;&t; */
r_if
c_cond
(paren
id|sk-&gt;state
op_eq
id|TCP_LISTEN
)paren
r_return
suffix:semicolon
multiline_comment|/* We don&squot;t check in the destentry if pmtu discovery is forbidden&n;&t; * on this route. We just assume that no packet_to_big packets&n;&t; * are send back when pmtu discovery is not active.&n;     &t; * There is a small race when the user changes this flag in the&n;&t; * route, but I think that&squot;s acceptable.&n;&t; */
r_if
c_cond
(paren
id|sk-&gt;ip_pmtudisc
op_ne
id|IP_PMTUDISC_DONT
op_logical_and
id|sk-&gt;dst_cache
)paren
(brace
id|new_mtu
op_assign
id|sk-&gt;dst_cache-&gt;pmtu
op_minus
(paren
id|ip-&gt;ihl
op_lshift
l_int|2
)paren
op_minus
id|tp-&gt;tcp_header_len
suffix:semicolon
r_if
c_cond
(paren
id|new_mtu
template_param
l_int|0
)paren
(brace
id|sk-&gt;mss
op_assign
id|new_mtu
suffix:semicolon
multiline_comment|/* Resend the TCP packet because it&squot;s  &n;&t;&t;&t; * clear that the old packet has been&n;&t;&t;&t; * dropped. This is the new &quot;fast&quot; path mtu&n;&t;&t;&t; * discovery.&n;&t;&t;&t; */
r_if
c_cond
(paren
op_logical_neg
id|sk-&gt;sock_readers
)paren
id|tcp_simple_retransmit
c_func
(paren
id|sk
)paren
suffix:semicolon
)brace
)brace
)brace
multiline_comment|/*&n; * This routine is called by the ICMP module when it gets some&n; * sort of error condition.  If err &lt; 0 then the socket should&n; * be closed and the error returned to the user.  If err &gt; 0&n; * it&squot;s just the icmp type &lt;&lt; 8 | icmp code.  After adjustment&n; * header points to the first 8 bytes of the tcp header.  We need&n; * to find the appropriate port.&n; */
DECL|function|tcp_v4_err
r_void
id|tcp_v4_err
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_int
r_char
op_star
id|dp
comma
r_int
id|len
)paren
(brace
r_struct
id|iphdr
op_star
id|iph
op_assign
(paren
r_struct
id|iphdr
op_star
)paren
id|dp
suffix:semicolon
r_struct
id|tcphdr
op_star
id|th
suffix:semicolon
r_struct
id|tcp_opt
op_star
id|tp
suffix:semicolon
r_int
id|type
op_assign
id|skb-&gt;h.icmph-&gt;type
suffix:semicolon
r_int
id|code
op_assign
id|skb-&gt;h.icmph-&gt;code
suffix:semicolon
r_struct
id|sock
op_star
id|sk
suffix:semicolon
r_int
id|opening
suffix:semicolon
macro_line|#ifdef ICMP_PARANOIA
id|__u32
id|seq
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|len
OL
(paren
id|iph-&gt;ihl
op_lshift
l_int|2
)paren
op_plus
id|ICMP_MIN_LENGTH
)paren
(brace
id|icmp_statistics.IcmpInErrors
op_increment
suffix:semicolon
r_return
suffix:semicolon
)brace
id|th
op_assign
(paren
r_struct
id|tcphdr
op_star
)paren
(paren
id|dp
op_plus
(paren
id|iph-&gt;ihl
op_lshift
l_int|2
)paren
)paren
suffix:semicolon
id|sk
op_assign
id|tcp_v4_lookup
c_func
(paren
id|iph-&gt;daddr
comma
id|th-&gt;dest
comma
id|iph-&gt;saddr
comma
id|th-&gt;source
comma
id|skb-&gt;dev-&gt;ifindex
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sk
op_eq
l_int|NULL
)paren
(brace
id|icmp_statistics.IcmpInErrors
op_increment
suffix:semicolon
r_return
suffix:semicolon
)brace
id|tp
op_assign
op_amp
id|sk-&gt;tp_pinfo.af_tcp
suffix:semicolon
macro_line|#ifdef ICMP_PARANOIA
id|seq
op_assign
id|ntohl
c_func
(paren
id|th-&gt;seq
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sk-&gt;state
op_ne
id|TCP_LISTEN
op_logical_and
op_logical_neg
id|between
c_func
(paren
id|seq
comma
id|tp-&gt;snd_una
comma
id|max
c_func
(paren
id|tp-&gt;snd_una
op_plus
l_int|32768
comma
id|tp-&gt;snd_nxt
)paren
)paren
)paren
(brace
r_if
c_cond
(paren
id|net_ratelimit
c_func
(paren
)paren
)paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;icmp packet outside the tcp window:&quot;
l_string|&quot; s:%d %u,%u,%u&bslash;n&quot;
comma
(paren
r_int
)paren
id|sk-&gt;state
comma
id|seq
comma
id|tp-&gt;snd_una
comma
id|tp-&gt;snd_nxt
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
macro_line|#endif
r_switch
c_cond
(paren
id|type
)paren
(brace
r_case
id|ICMP_SOURCE_QUENCH
suffix:colon
id|tp-&gt;snd_ssthresh
op_assign
id|max
c_func
(paren
id|tp-&gt;snd_cwnd
op_rshift
l_int|1
comma
l_int|2
)paren
suffix:semicolon
id|tp-&gt;snd_cwnd
op_assign
id|tp-&gt;snd_ssthresh
suffix:semicolon
id|tp-&gt;high_seq
op_assign
id|tp-&gt;snd_nxt
suffix:semicolon
r_return
suffix:semicolon
r_case
id|ICMP_PARAMETERPROB
suffix:colon
id|sk-&gt;err
op_assign
id|EPROTO
suffix:semicolon
id|sk
op_member_access_from_pointer
id|error_report
c_func
(paren
id|sk
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ICMP_DEST_UNREACH
suffix:colon
r_if
c_cond
(paren
id|code
op_eq
id|ICMP_FRAG_NEEDED
)paren
(brace
multiline_comment|/* PMTU discovery (RFC1191) */
id|do_pmtu_discovery
c_func
(paren
id|sk
comma
id|iph
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_break
suffix:semicolon
)brace
multiline_comment|/* If we&squot;ve already connected we will keep trying&n;&t; * until we time out, or the user gives up.&n;&t; */
r_if
c_cond
(paren
id|code
OG
id|NR_ICMP_UNREACH
)paren
r_return
suffix:semicolon
id|opening
op_assign
l_int|0
suffix:semicolon
r_switch
c_cond
(paren
id|sk-&gt;state
)paren
(brace
r_struct
id|open_request
op_star
id|req
comma
op_star
id|prev
suffix:semicolon
r_case
id|TCP_LISTEN
suffix:colon
multiline_comment|/* Prevent race conditions with accept() - &n;&t;&t; * ICMP is unreliable. &n;&t;&t; */
r_if
c_cond
(paren
id|sk-&gt;sock_readers
)paren
(brace
multiline_comment|/* XXX: add a counter here to profile this. &n;&t;&t;&t; * If too many ICMPs get dropped on busy&n;&t;&t;&t; * servers this needs to be solved differently.&n;&t;&t;&t; */
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|th-&gt;syn
op_logical_and
op_logical_neg
id|th-&gt;ack
)paren
r_return
suffix:semicolon
id|req
op_assign
id|tcp_v4_search_req
c_func
(paren
id|tp
comma
id|iph
comma
id|th
comma
op_amp
id|prev
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|req
)paren
r_return
suffix:semicolon
macro_line|#ifdef ICMP_PARANOIA
r_if
c_cond
(paren
id|seq
op_ne
id|req-&gt;snt_isn
)paren
(brace
r_if
c_cond
(paren
id|net_ratelimit
c_func
(paren
)paren
)paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;icmp packet for openreq &quot;
l_string|&quot;with wrong seq number:%d:%d&bslash;n&quot;
comma
id|seq
comma
id|req-&gt;snt_isn
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
macro_line|#endif
r_if
c_cond
(paren
id|req-&gt;sk
)paren
(brace
multiline_comment|/* not yet accept()ed */
id|sk
op_assign
id|req-&gt;sk
suffix:semicolon
multiline_comment|/* report error in accept */
)brace
r_else
(brace
id|tcp_synq_unlink
c_func
(paren
id|tp
comma
id|req
comma
id|prev
)paren
suffix:semicolon
id|req
op_member_access_from_pointer
r_class
op_member_access_from_pointer
id|destructor
c_func
(paren
id|req
)paren
suffix:semicolon
id|tcp_openreq_free
c_func
(paren
id|req
)paren
suffix:semicolon
)brace
multiline_comment|/* FALL THOUGH */
r_case
id|TCP_SYN_SENT
suffix:colon
r_case
id|TCP_SYN_RECV
suffix:colon
id|opening
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|icmp_err_convert
(braket
id|code
)braket
dot
id|fatal
op_logical_or
id|opening
)paren
(brace
id|sk-&gt;err
op_assign
id|icmp_err_convert
(braket
id|code
)braket
dot
id|errno
suffix:semicolon
r_if
c_cond
(paren
id|opening
)paren
(brace
id|tcp_statistics.TcpAttemptFails
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|sk-&gt;state
op_ne
id|TCP_LISTEN
)paren
id|tcp_set_state
c_func
(paren
id|sk
comma
id|TCP_CLOSE
)paren
suffix:semicolon
id|sk
op_member_access_from_pointer
id|error_report
c_func
(paren
id|sk
)paren
suffix:semicolon
multiline_comment|/* Wake people up to see the error (see connect in sock.c) */
)brace
)brace
r_else
multiline_comment|/* Only an error on timeout */
id|sk-&gt;err_soft
op_assign
id|icmp_err_convert
(braket
id|code
)braket
dot
id|errno
suffix:semicolon
)brace
multiline_comment|/* This routine computes an IPv4 TCP checksum. */
DECL|function|tcp_v4_send_check
r_void
id|tcp_v4_send_check
c_func
(paren
r_struct
id|sock
op_star
id|sk
comma
r_struct
id|tcphdr
op_star
id|th
comma
r_int
id|len
comma
r_struct
id|sk_buff
op_star
id|skb
)paren
(brace
id|th-&gt;check
op_assign
l_int|0
suffix:semicolon
id|th-&gt;check
op_assign
id|tcp_v4_check
c_func
(paren
id|th
comma
id|len
comma
id|sk-&gt;saddr
comma
id|sk-&gt;daddr
comma
id|csum_partial
c_func
(paren
(paren
r_char
op_star
)paren
id|th
comma
id|th-&gt;doff
op_lshift
l_int|2
comma
id|skb-&gt;csum
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;This routine will send an RST to the other tcp.&n; *&n; *&t;Someone asks: why I NEVER use socket parameters (TOS, TTL etc.)&n; *&t;&t;      for reset.&n; *&t;Answer: if a packet caused RST, it is not for a socket&n; *&t;&t;existing in our system, if it is matched to a socket,&n; *&t;&t;it is just duplicate segment or bug in other side&squot;s TCP.&n; *&t;&t;So that we build reply only basing on parameters&n; *&t;&t;arrived with segment.&n; *&t;Exception: precedence violation. We do not implement it in any case.&n; */
DECL|function|tcp_v4_send_reset
r_static
r_void
id|tcp_v4_send_reset
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
)paren
(brace
r_struct
id|tcphdr
op_star
id|th
op_assign
id|skb-&gt;h.th
suffix:semicolon
r_struct
id|sk_buff
op_star
id|skb1
suffix:semicolon
r_struct
id|tcphdr
op_star
id|th1
suffix:semicolon
r_if
c_cond
(paren
id|th-&gt;rst
)paren
r_return
suffix:semicolon
id|skb1
op_assign
id|ip_reply
c_func
(paren
id|skb
comma
r_sizeof
(paren
r_struct
id|tcphdr
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|skb1
op_eq
l_int|NULL
)paren
r_return
suffix:semicolon
id|skb1-&gt;h.th
op_assign
id|th1
op_assign
(paren
r_struct
id|tcphdr
op_star
)paren
id|skb_put
c_func
(paren
id|skb1
comma
r_sizeof
(paren
r_struct
id|tcphdr
)paren
)paren
suffix:semicolon
id|memset
c_func
(paren
id|th1
comma
l_int|0
comma
r_sizeof
(paren
op_star
id|th1
)paren
)paren
suffix:semicolon
multiline_comment|/* Swap the send and the receive. */
id|th1-&gt;dest
op_assign
id|th-&gt;source
suffix:semicolon
id|th1-&gt;source
op_assign
id|th-&gt;dest
suffix:semicolon
id|th1-&gt;doff
op_assign
r_sizeof
(paren
op_star
id|th1
)paren
op_div
l_int|4
suffix:semicolon
id|th1-&gt;rst
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|th-&gt;ack
)paren
id|th1-&gt;seq
op_assign
id|th-&gt;ack_seq
suffix:semicolon
r_else
(brace
id|th1-&gt;ack
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|th-&gt;syn
)paren
id|th1-&gt;ack_seq
op_assign
id|th-&gt;seq
suffix:semicolon
r_else
id|th1-&gt;ack_seq
op_assign
id|htonl
c_func
(paren
id|ntohl
c_func
(paren
id|th-&gt;seq
)paren
op_plus
l_int|1
)paren
suffix:semicolon
)brace
id|skb1-&gt;csum
op_assign
id|csum_partial
c_func
(paren
(paren
id|u8
op_star
)paren
id|th1
comma
r_sizeof
(paren
op_star
id|th1
)paren
comma
l_int|0
)paren
suffix:semicolon
id|th1-&gt;check
op_assign
id|tcp_v4_check
c_func
(paren
id|th1
comma
r_sizeof
(paren
op_star
id|th1
)paren
comma
id|skb1-&gt;nh.iph-&gt;saddr
comma
id|skb1-&gt;nh.iph-&gt;daddr
comma
id|skb1-&gt;csum
)paren
suffix:semicolon
multiline_comment|/* FIXME: should this carry an options packet? */
id|ip_queue_xmit
c_func
(paren
id|skb1
)paren
suffix:semicolon
id|tcp_statistics.TcpOutSegs
op_increment
suffix:semicolon
id|tcp_statistics.TcpOutRsts
op_increment
suffix:semicolon
)brace
macro_line|#ifdef CONFIG_IP_TRANSPARENT_PROXY
multiline_comment|/*&n; *&t;Check whether a received TCP packet might be for one of our&n; *&t;connections.&n; */
DECL|function|tcp_chkaddr
r_int
id|tcp_chkaddr
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
)paren
(brace
r_struct
id|iphdr
op_star
id|iph
op_assign
id|skb-&gt;nh.iph
suffix:semicolon
r_struct
id|tcphdr
op_star
id|th
op_assign
(paren
r_struct
id|tcphdr
op_star
)paren
(paren
id|skb-&gt;nh.raw
op_plus
id|iph-&gt;ihl
op_star
l_int|4
)paren
suffix:semicolon
r_struct
id|sock
op_star
id|sk
suffix:semicolon
id|sk
op_assign
id|tcp_v4_lookup
c_func
(paren
id|iph-&gt;saddr
comma
id|th-&gt;source
comma
id|iph-&gt;daddr
comma
id|th-&gt;dest
comma
id|skb-&gt;dev-&gt;ifindex
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|sk
)paren
r_return
l_int|0
suffix:semicolon
multiline_comment|/* 0 means accept all LOCAL addresses here, not all the world... */
r_if
c_cond
(paren
id|sk-&gt;rcv_saddr
op_eq
l_int|0
)paren
r_return
l_int|0
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
macro_line|#endif
DECL|function|tcp_v4_send_synack
r_static
r_void
id|tcp_v4_send_synack
c_func
(paren
r_struct
id|sock
op_star
id|sk
comma
r_struct
id|open_request
op_star
id|req
)paren
(brace
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
r_struct
id|tcphdr
op_star
id|th
suffix:semicolon
r_int
id|tmp
suffix:semicolon
r_int
id|mss
suffix:semicolon
id|skb
op_assign
id|sock_wmalloc
c_func
(paren
id|sk
comma
id|MAX_SYN_SIZE
comma
l_int|1
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
id|skb
op_eq
l_int|NULL
)paren
r_return
suffix:semicolon
r_if
c_cond
(paren
id|ip_build_pkt
c_func
(paren
id|skb
comma
id|sk
comma
id|req-&gt;af.v4_req.loc_addr
comma
id|req-&gt;af.v4_req.rmt_addr
comma
id|req-&gt;af.v4_req.opt
)paren
OL
l_int|0
)paren
(brace
id|kfree_skb
c_func
(paren
id|skb
comma
id|FREE_WRITE
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|mss
op_assign
(paren
id|skb-&gt;dst-&gt;pmtu
op_minus
r_sizeof
(paren
r_struct
id|iphdr
)paren
op_minus
r_sizeof
(paren
r_struct
id|tcphdr
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sk-&gt;user_mss
)paren
id|mss
op_assign
id|min
c_func
(paren
id|mss
comma
id|sk-&gt;user_mss
)paren
suffix:semicolon
id|skb-&gt;h.th
op_assign
id|th
op_assign
(paren
r_struct
id|tcphdr
op_star
)paren
id|skb_put
c_func
(paren
id|skb
comma
r_sizeof
(paren
r_struct
id|tcphdr
)paren
)paren
suffix:semicolon
multiline_comment|/* Don&squot;t offer more than they did.&n;&t; * This way we don&squot;t have to memorize who said what.&n;&t; * FIXME: maybe this should be changed for better performance&n;&t; * with syncookies.&n;&t; */
id|req-&gt;mss
op_assign
id|min
c_func
(paren
id|mss
comma
id|req-&gt;mss
)paren
suffix:semicolon
r_if
c_cond
(paren
id|req-&gt;mss
OL
l_int|1
)paren
(brace
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;initial req-&gt;mss below 1&bslash;n&quot;
)paren
suffix:semicolon
id|req-&gt;mss
op_assign
l_int|1
suffix:semicolon
)brace
multiline_comment|/* Yuck, make this header setup more efficient... -DaveM */
id|memset
c_func
(paren
id|th
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|tcphdr
)paren
)paren
suffix:semicolon
id|th-&gt;syn
op_assign
l_int|1
suffix:semicolon
id|th-&gt;ack
op_assign
l_int|1
suffix:semicolon
id|th-&gt;source
op_assign
id|sk-&gt;dummy_th.source
suffix:semicolon
id|th-&gt;dest
op_assign
id|req-&gt;rmt_port
suffix:semicolon
id|skb-&gt;seq
op_assign
id|req-&gt;snt_isn
suffix:semicolon
id|skb-&gt;end_seq
op_assign
id|skb-&gt;seq
op_plus
l_int|1
suffix:semicolon
id|th-&gt;seq
op_assign
id|htonl
c_func
(paren
id|skb-&gt;seq
)paren
suffix:semicolon
id|th-&gt;ack_seq
op_assign
id|htonl
c_func
(paren
id|req-&gt;rcv_isn
op_plus
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|req-&gt;rcv_wnd
op_eq
l_int|0
)paren
(brace
multiline_comment|/* ignored for retransmitted syns */
id|__u8
id|rcv_wscale
suffix:semicolon
multiline_comment|/* Set this up on the first call only */
id|req-&gt;window_clamp
op_assign
id|skb-&gt;dst-&gt;window
suffix:semicolon
id|tcp_select_initial_window
c_func
(paren
id|sock_rspace
c_func
(paren
id|sk
)paren
op_div
l_int|2
comma
id|req-&gt;mss
comma
op_amp
id|req-&gt;rcv_wnd
comma
op_amp
id|req-&gt;window_clamp
comma
id|req-&gt;wscale_ok
comma
op_amp
id|rcv_wscale
)paren
suffix:semicolon
id|req-&gt;rcv_wscale
op_assign
id|rcv_wscale
suffix:semicolon
)brace
id|th-&gt;window
op_assign
id|htons
c_func
(paren
id|req-&gt;rcv_wnd
)paren
suffix:semicolon
multiline_comment|/* XXX Partial csum of 4 byte quantity is itself! -DaveM&n;&t; * Yes, but it&squot;s a bit harder to special case now. It&squot;s&n;&t; * now computed inside the tcp_v4_send_check() to clean up&n;&t; * updating the options fields in the mainline send code.&n;&t; * If someone thinks this is really bad let me know and&n;&t; * I&squot;ll try to do it a different way. -- erics&n;&t; */
id|tmp
op_assign
id|tcp_syn_build_options
c_func
(paren
id|skb
comma
id|req-&gt;mss
comma
id|req-&gt;sack_ok
comma
id|req-&gt;tstamp_ok
comma
id|req-&gt;wscale_ok
comma
id|req-&gt;rcv_wscale
)paren
suffix:semicolon
id|skb-&gt;csum
op_assign
l_int|0
suffix:semicolon
id|th-&gt;doff
op_assign
(paren
r_sizeof
(paren
op_star
id|th
)paren
op_plus
id|tmp
)paren
op_rshift
l_int|2
suffix:semicolon
id|th-&gt;check
op_assign
id|tcp_v4_check
c_func
(paren
id|th
comma
r_sizeof
(paren
op_star
id|th
)paren
op_plus
id|tmp
comma
id|req-&gt;af.v4_req.loc_addr
comma
id|req-&gt;af.v4_req.rmt_addr
comma
id|csum_partial
c_func
(paren
(paren
r_char
op_star
)paren
id|th
comma
r_sizeof
(paren
op_star
id|th
)paren
op_plus
id|tmp
comma
id|skb-&gt;csum
)paren
)paren
suffix:semicolon
id|ip_queue_xmit
c_func
(paren
id|skb
)paren
suffix:semicolon
id|tcp_statistics.TcpOutSegs
op_increment
suffix:semicolon
)brace
DECL|function|tcp_v4_or_free
r_static
r_void
id|tcp_v4_or_free
c_func
(paren
r_struct
id|open_request
op_star
id|req
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|req-&gt;sk
op_logical_and
id|req-&gt;af.v4_req.opt
)paren
(brace
id|kfree_s
c_func
(paren
id|req-&gt;af.v4_req.opt
comma
r_sizeof
(paren
r_struct
id|ip_options
)paren
op_plus
id|req-&gt;af.v4_req.opt-&gt;optlen
)paren
suffix:semicolon
)brace
)brace
DECL|function|syn_flood_warning
r_static
r_inline
r_void
id|syn_flood_warning
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
)paren
(brace
r_static
r_int
r_int
id|warntime
suffix:semicolon
r_if
c_cond
(paren
id|jiffies
op_minus
id|warntime
OG
id|HZ
op_star
l_int|60
)paren
(brace
id|warntime
op_assign
id|jiffies
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;possible SYN flooding on port %d. Sending cookies.&bslash;n&quot;
comma
id|ntohs
c_func
(paren
id|skb-&gt;h.th-&gt;dest
)paren
)paren
suffix:semicolon
)brace
)brace
DECL|variable|sysctl_max_syn_backlog
r_int
id|sysctl_max_syn_backlog
op_assign
l_int|1024
suffix:semicolon
DECL|variable|sysctl_tcp_syn_taildrop
r_int
id|sysctl_tcp_syn_taildrop
op_assign
l_int|1
suffix:semicolon
DECL|variable|or_ipv4
r_struct
id|or_calltable
id|or_ipv4
op_assign
(brace
id|tcp_v4_send_synack
comma
id|tcp_v4_or_free
comma
id|tcp_v4_send_reset
)brace
suffix:semicolon
macro_line|#ifdef NEW_LISTEN
DECL|macro|BACKLOG
mdefine_line|#define BACKLOG(sk) ((sk)-&gt;tp_pinfo.af_tcp.syn_backlog) /* lvalue! */
DECL|macro|BACKLOGMAX
mdefine_line|#define BACKLOGMAX(sk) sysctl_max_syn_backlog
macro_line|#else
DECL|macro|BACKLOG
mdefine_line|#define BACKLOG(sk) ((sk)-&gt;ack_backlog)
DECL|macro|BACKLOGMAX
mdefine_line|#define BACKLOGMAX(sk) ((sk)-&gt;max_ack_backlog)
macro_line|#endif
DECL|function|tcp_v4_conn_request
r_int
id|tcp_v4_conn_request
c_func
(paren
r_struct
id|sock
op_star
id|sk
comma
r_struct
id|sk_buff
op_star
id|skb
comma
r_void
op_star
id|ptr
comma
id|__u32
id|isn
)paren
(brace
r_struct
id|ip_options
op_star
id|opt
op_assign
(paren
r_struct
id|ip_options
op_star
)paren
id|ptr
suffix:semicolon
r_struct
id|tcp_opt
id|tp
suffix:semicolon
r_struct
id|open_request
op_star
id|req
suffix:semicolon
r_struct
id|tcphdr
op_star
id|th
op_assign
id|skb-&gt;h.th
suffix:semicolon
id|__u32
id|saddr
op_assign
id|skb-&gt;nh.iph-&gt;saddr
suffix:semicolon
id|__u32
id|daddr
op_assign
id|skb-&gt;nh.iph-&gt;daddr
suffix:semicolon
macro_line|#ifdef CONFIG_SYN_COOKIES
r_int
id|want_cookie
op_assign
l_int|0
suffix:semicolon
macro_line|#else
mdefine_line|#define want_cookie 0 /* Argh, why doesn&squot;t gcc optimize this :( */
macro_line|#endif
multiline_comment|/* If the socket is dead, don&squot;t accept the connection.&t;*/
r_if
c_cond
(paren
id|sk-&gt;dead
)paren
r_goto
id|dead
suffix:semicolon
multiline_comment|/* XXX: Check against a global syn pool counter. */
r_if
c_cond
(paren
id|BACKLOG
c_func
(paren
id|sk
)paren
OG
id|BACKLOGMAX
c_func
(paren
id|sk
)paren
)paren
(brace
macro_line|#ifdef CONFIG_SYN_COOKIES
r_if
c_cond
(paren
id|sysctl_tcp_syncookies
)paren
(brace
id|syn_flood_warning
c_func
(paren
id|skb
)paren
suffix:semicolon
id|want_cookie
op_assign
l_int|1
suffix:semicolon
)brace
r_else
macro_line|#endif
r_if
c_cond
(paren
id|sysctl_tcp_syn_taildrop
)paren
(brace
r_struct
id|open_request
op_star
id|req
suffix:semicolon
id|req
op_assign
id|tcp_synq_unlink_tail
c_func
(paren
op_amp
id|sk-&gt;tp_pinfo.af_tcp
)paren
suffix:semicolon
id|tcp_openreq_free
c_func
(paren
id|req
)paren
suffix:semicolon
id|tcp_statistics.TcpAttemptFails
op_increment
suffix:semicolon
)brace
r_else
(brace
r_goto
id|error
suffix:semicolon
)brace
)brace
r_else
(brace
r_if
c_cond
(paren
id|isn
op_eq
l_int|0
)paren
id|isn
op_assign
id|tcp_v4_init_sequence
c_func
(paren
id|sk
comma
id|skb
)paren
suffix:semicolon
id|BACKLOG
c_func
(paren
id|sk
)paren
op_increment
suffix:semicolon
)brace
id|req
op_assign
id|tcp_openreq_alloc
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|req
op_eq
l_int|NULL
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|want_cookie
)paren
id|BACKLOG
c_func
(paren
id|sk
)paren
op_decrement
suffix:semicolon
r_goto
id|error
suffix:semicolon
)brace
id|req-&gt;rcv_wnd
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* So that tcp_send_synack() knows! */
id|req-&gt;rcv_isn
op_assign
id|skb-&gt;seq
suffix:semicolon
id|tp.tstamp_ok
op_assign
id|tp.sack_ok
op_assign
id|tp.wscale_ok
op_assign
id|tp.snd_wscale
op_assign
l_int|0
suffix:semicolon
id|tp.in_mss
op_assign
l_int|536
suffix:semicolon
id|tcp_parse_options
c_func
(paren
id|th
comma
op_amp
id|tp
comma
id|want_cookie
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tp.saw_tstamp
)paren
id|req-&gt;ts_recent
op_assign
id|tp.rcv_tsval
suffix:semicolon
id|req-&gt;mss
op_assign
id|tp.in_mss
suffix:semicolon
id|req-&gt;tstamp_ok
op_assign
id|tp.tstamp_ok
suffix:semicolon
id|req-&gt;sack_ok
op_assign
id|tp.sack_ok
suffix:semicolon
id|req-&gt;snd_wscale
op_assign
id|tp.snd_wscale
suffix:semicolon
id|req-&gt;wscale_ok
op_assign
id|tp.wscale_ok
suffix:semicolon
id|req-&gt;rmt_port
op_assign
id|th-&gt;source
suffix:semicolon
id|req-&gt;af.v4_req.loc_addr
op_assign
id|daddr
suffix:semicolon
id|req-&gt;af.v4_req.rmt_addr
op_assign
id|saddr
suffix:semicolon
multiline_comment|/* Note that we ignore the isn passed from the TIME_WAIT&n;&t; * state here. That&squot;s the price we pay for cookies.&n;&t; */
r_if
c_cond
(paren
id|want_cookie
)paren
id|isn
op_assign
id|cookie_v4_init_sequence
c_func
(paren
id|sk
comma
id|skb
comma
op_amp
id|req-&gt;mss
)paren
suffix:semicolon
id|req-&gt;snt_isn
op_assign
id|isn
suffix:semicolon
multiline_comment|/* IPv4 options */
id|req-&gt;af.v4_req.opt
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
id|opt
op_logical_and
id|opt-&gt;optlen
)paren
(brace
r_int
id|opt_size
op_assign
r_sizeof
(paren
r_struct
id|ip_options
)paren
op_plus
id|opt-&gt;optlen
suffix:semicolon
id|req-&gt;af.v4_req.opt
op_assign
id|kmalloc
c_func
(paren
id|opt_size
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
id|req-&gt;af.v4_req.opt
)paren
(brace
r_if
c_cond
(paren
id|ip_options_echo
c_func
(paren
id|req-&gt;af.v4_req.opt
comma
id|skb
)paren
)paren
(brace
id|kfree_s
c_func
(paren
id|req-&gt;af.v4_req.opt
comma
id|opt_size
)paren
suffix:semicolon
id|req-&gt;af.v4_req.opt
op_assign
l_int|NULL
suffix:semicolon
)brace
)brace
)brace
id|req
op_member_access_from_pointer
r_class
op_assign
op_amp
id|or_ipv4
suffix:semicolon
id|req-&gt;retrans
op_assign
l_int|0
suffix:semicolon
id|req-&gt;sk
op_assign
l_int|NULL
suffix:semicolon
id|tcp_v4_send_synack
c_func
(paren
id|sk
comma
id|req
)paren
suffix:semicolon
r_if
c_cond
(paren
id|want_cookie
)paren
(brace
r_if
c_cond
(paren
id|req-&gt;af.v4_req.opt
)paren
id|kfree
c_func
(paren
id|req-&gt;af.v4_req.opt
)paren
suffix:semicolon
id|tcp_openreq_free
c_func
(paren
id|req
)paren
suffix:semicolon
)brace
r_else
(brace
id|req-&gt;expires
op_assign
id|jiffies
op_plus
id|TCP_TIMEOUT_INIT
suffix:semicolon
id|tcp_inc_slow_timer
c_func
(paren
id|TCP_SLT_SYNACK
)paren
suffix:semicolon
id|tcp_synq_queue
c_func
(paren
op_amp
id|sk-&gt;tp_pinfo.af_tcp
comma
id|req
)paren
suffix:semicolon
)brace
id|sk
op_member_access_from_pointer
id|data_ready
c_func
(paren
id|sk
comma
l_int|0
)paren
suffix:semicolon
m_exit
suffix:colon
r_return
l_int|0
suffix:semicolon
id|dead
suffix:colon
id|SOCK_DEBUG
c_func
(paren
id|sk
comma
l_string|&quot;Reset on %p: Connect on dead socket.&bslash;n&quot;
comma
id|sk
)paren
suffix:semicolon
id|tcp_statistics.TcpAttemptFails
op_increment
suffix:semicolon
r_return
op_minus
id|ENOTCONN
suffix:semicolon
id|error
suffix:colon
id|tcp_statistics.TcpAttemptFails
op_increment
suffix:semicolon
r_goto
m_exit
suffix:semicolon
)brace
DECL|function|tcp_v4_syn_recv_sock
r_struct
id|sock
op_star
id|tcp_v4_syn_recv_sock
c_func
(paren
r_struct
id|sock
op_star
id|sk
comma
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|open_request
op_star
id|req
comma
r_struct
id|dst_entry
op_star
id|dst
)paren
(brace
r_struct
id|tcp_opt
op_star
id|newtp
suffix:semicolon
r_struct
id|sock
op_star
id|newsk
suffix:semicolon
r_int
id|snd_mss
suffix:semicolon
macro_line|#ifdef NEW_LISTEN
r_if
c_cond
(paren
id|sk-&gt;ack_backlog
OG
id|sk-&gt;max_ack_backlog
)paren
r_goto
m_exit
suffix:semicolon
multiline_comment|/* head drop */
macro_line|#endif
id|newsk
op_assign
id|sk_alloc
c_func
(paren
id|AF_INET
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|newsk
)paren
r_goto
m_exit
suffix:semicolon
macro_line|#ifdef NEW_LISTEN
id|sk-&gt;ack_backlog
op_increment
suffix:semicolon
macro_line|#endif
id|memcpy
c_func
(paren
id|newsk
comma
id|sk
comma
r_sizeof
(paren
op_star
id|newsk
)paren
)paren
suffix:semicolon
multiline_comment|/* Or else we die! -DaveM */
id|newsk-&gt;sklist_next
op_assign
l_int|NULL
suffix:semicolon
id|newsk-&gt;opt
op_assign
id|req-&gt;af.v4_req.opt
suffix:semicolon
id|skb_queue_head_init
c_func
(paren
op_amp
id|newsk-&gt;write_queue
)paren
suffix:semicolon
id|skb_queue_head_init
c_func
(paren
op_amp
id|newsk-&gt;receive_queue
)paren
suffix:semicolon
id|skb_queue_head_init
c_func
(paren
op_amp
id|newsk-&gt;out_of_order_queue
)paren
suffix:semicolon
id|skb_queue_head_init
c_func
(paren
op_amp
id|newsk-&gt;error_queue
)paren
suffix:semicolon
multiline_comment|/* Unused */
id|newtp
op_assign
op_amp
(paren
id|newsk-&gt;tp_pinfo.af_tcp
)paren
suffix:semicolon
id|newtp-&gt;send_head
op_assign
l_int|NULL
suffix:semicolon
id|newtp-&gt;retrans_head
op_assign
l_int|NULL
suffix:semicolon
id|newtp-&gt;pending
op_assign
l_int|0
suffix:semicolon
id|skb_queue_head_init
c_func
(paren
op_amp
id|newsk-&gt;back_log
)paren
suffix:semicolon
id|newsk-&gt;prot
op_member_access_from_pointer
id|init
c_func
(paren
id|newsk
)paren
suffix:semicolon
id|newtp-&gt;snd_cwnd_cnt
op_assign
l_int|0
suffix:semicolon
id|newtp-&gt;backoff
op_assign
l_int|0
suffix:semicolon
id|newsk-&gt;proc
op_assign
l_int|0
suffix:semicolon
id|newsk-&gt;done
op_assign
l_int|0
suffix:semicolon
id|newsk-&gt;pair
op_assign
l_int|NULL
suffix:semicolon
id|atomic_set
c_func
(paren
op_amp
id|newsk-&gt;wmem_alloc
comma
l_int|0
)paren
suffix:semicolon
id|atomic_set
c_func
(paren
op_amp
id|newsk-&gt;rmem_alloc
comma
l_int|0
)paren
suffix:semicolon
id|newsk-&gt;localroute
op_assign
id|sk-&gt;localroute
suffix:semicolon
id|newsk-&gt;err
op_assign
l_int|0
suffix:semicolon
id|newsk-&gt;shutdown
op_assign
l_int|0
suffix:semicolon
id|newsk-&gt;ack_backlog
op_assign
l_int|0
suffix:semicolon
id|newtp-&gt;fin_seq
op_assign
id|req-&gt;rcv_isn
suffix:semicolon
id|newsk-&gt;syn_seq
op_assign
id|req-&gt;rcv_isn
suffix:semicolon
id|newsk-&gt;state
op_assign
id|TCP_SYN_RECV
suffix:semicolon
id|newsk-&gt;timeout
op_assign
l_int|0
suffix:semicolon
id|newsk-&gt;write_seq
op_assign
id|req-&gt;snt_isn
suffix:semicolon
id|newtp-&gt;snd_wnd
op_assign
id|ntohs
c_func
(paren
id|skb-&gt;h.th-&gt;window
)paren
suffix:semicolon
id|newtp-&gt;max_window
op_assign
id|newtp-&gt;snd_wnd
suffix:semicolon
id|newtp-&gt;snd_wl1
op_assign
id|req-&gt;rcv_isn
suffix:semicolon
id|newtp-&gt;snd_wl2
op_assign
id|newsk-&gt;write_seq
suffix:semicolon
id|newtp-&gt;snd_una
op_assign
id|newsk-&gt;write_seq
op_increment
suffix:semicolon
id|newtp-&gt;snd_nxt
op_assign
id|newsk-&gt;write_seq
suffix:semicolon
id|newsk-&gt;urg_data
op_assign
l_int|0
suffix:semicolon
id|newtp-&gt;packets_out
op_assign
l_int|0
suffix:semicolon
id|newtp-&gt;retransmits
op_assign
l_int|0
suffix:semicolon
id|newsk-&gt;linger
op_assign
l_int|0
suffix:semicolon
id|newsk-&gt;destroy
op_assign
l_int|0
suffix:semicolon
id|init_timer
c_func
(paren
op_amp
id|newsk-&gt;timer
)paren
suffix:semicolon
id|newsk-&gt;timer.data
op_assign
(paren
r_int
r_int
)paren
id|newsk
suffix:semicolon
id|newsk-&gt;timer.function
op_assign
op_amp
id|net_timer
suffix:semicolon
id|tcp_init_xmit_timers
c_func
(paren
id|newsk
)paren
suffix:semicolon
id|newsk-&gt;dummy_th.source
op_assign
id|sk-&gt;dummy_th.source
suffix:semicolon
id|newsk-&gt;dummy_th.dest
op_assign
id|req-&gt;rmt_port
suffix:semicolon
id|newsk-&gt;sock_readers
op_assign
l_int|0
suffix:semicolon
id|newtp-&gt;last_ack_sent
op_assign
id|newtp-&gt;rcv_nxt
op_assign
id|req-&gt;rcv_isn
op_plus
l_int|1
suffix:semicolon
id|newtp-&gt;rcv_wup
op_assign
id|req-&gt;rcv_isn
op_plus
l_int|1
suffix:semicolon
id|newsk-&gt;copied_seq
op_assign
id|req-&gt;rcv_isn
op_plus
l_int|1
suffix:semicolon
id|newsk-&gt;socket
op_assign
l_int|NULL
suffix:semicolon
id|newsk-&gt;daddr
op_assign
id|req-&gt;af.v4_req.rmt_addr
suffix:semicolon
id|newsk-&gt;saddr
op_assign
id|req-&gt;af.v4_req.loc_addr
suffix:semicolon
id|newsk-&gt;rcv_saddr
op_assign
id|req-&gt;af.v4_req.loc_addr
suffix:semicolon
multiline_comment|/* options / mss / route_cache */
r_if
c_cond
(paren
id|dst
op_eq
l_int|NULL
)paren
(brace
r_struct
id|rtable
op_star
id|rt
suffix:semicolon
r_if
c_cond
(paren
id|ip_route_output
c_func
(paren
op_amp
id|rt
comma
id|newsk-&gt;opt
op_logical_and
id|newsk-&gt;opt-&gt;srr
ques
c_cond
id|newsk-&gt;opt-&gt;faddr
suffix:colon
id|newsk-&gt;daddr
comma
id|newsk-&gt;saddr
comma
id|newsk-&gt;ip_tos
comma
l_int|0
)paren
)paren
(brace
id|sk_free
c_func
(paren
id|newsk
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
id|dst
op_assign
op_amp
id|rt-&gt;u.dst
suffix:semicolon
)brace
id|newsk-&gt;dst_cache
op_assign
id|dst
suffix:semicolon
id|snd_mss
op_assign
id|dst-&gt;pmtu
suffix:semicolon
multiline_comment|/* FIXME: is mtu really the same as snd_mss? */
id|newsk-&gt;mtu
op_assign
id|snd_mss
suffix:semicolon
multiline_comment|/* FIXME: where does mtu get used after this? */
multiline_comment|/* sanity check */
r_if
c_cond
(paren
id|newsk-&gt;mtu
OL
l_int|64
)paren
id|newsk-&gt;mtu
op_assign
l_int|64
suffix:semicolon
id|newtp-&gt;sack_ok
op_assign
id|req-&gt;sack_ok
suffix:semicolon
id|newtp-&gt;tstamp_ok
op_assign
id|req-&gt;tstamp_ok
suffix:semicolon
id|newtp-&gt;window_clamp
op_assign
id|req-&gt;window_clamp
suffix:semicolon
id|newtp-&gt;rcv_wnd
op_assign
id|req-&gt;rcv_wnd
suffix:semicolon
id|newtp-&gt;wscale_ok
op_assign
id|req-&gt;wscale_ok
suffix:semicolon
r_if
c_cond
(paren
id|newtp-&gt;wscale_ok
)paren
(brace
id|newtp-&gt;snd_wscale
op_assign
id|req-&gt;snd_wscale
suffix:semicolon
id|newtp-&gt;rcv_wscale
op_assign
id|req-&gt;rcv_wscale
suffix:semicolon
)brace
r_else
(brace
id|newtp-&gt;snd_wscale
op_assign
id|newtp-&gt;rcv_wscale
op_assign
l_int|0
suffix:semicolon
id|newtp-&gt;window_clamp
op_assign
id|min
c_func
(paren
id|newtp-&gt;window_clamp
comma
l_int|65535
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|newtp-&gt;tstamp_ok
)paren
(brace
id|newtp-&gt;ts_recent
op_assign
id|req-&gt;ts_recent
suffix:semicolon
id|newtp-&gt;ts_recent_stamp
op_assign
id|jiffies
suffix:semicolon
id|newtp-&gt;tcp_header_len
op_assign
r_sizeof
(paren
r_struct
id|tcphdr
)paren
op_plus
l_int|12
suffix:semicolon
multiline_comment|/* FIXME: define constant! */
id|newsk-&gt;dummy_th.doff
op_add_assign
l_int|3
suffix:semicolon
)brace
r_else
(brace
id|newtp-&gt;tcp_header_len
op_assign
r_sizeof
(paren
r_struct
id|tcphdr
)paren
suffix:semicolon
)brace
id|snd_mss
op_sub_assign
r_sizeof
(paren
r_struct
id|iphdr
)paren
op_plus
r_sizeof
(paren
r_struct
id|tcphdr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sk-&gt;user_mss
)paren
id|snd_mss
op_assign
id|min
c_func
(paren
id|snd_mss
comma
id|sk-&gt;user_mss
)paren
suffix:semicolon
multiline_comment|/* Make sure our mtu is adjusted for headers. */
id|newsk-&gt;mss
op_assign
id|min
c_func
(paren
id|req-&gt;mss
comma
id|snd_mss
)paren
op_plus
r_sizeof
(paren
r_struct
id|tcphdr
)paren
op_minus
id|newtp-&gt;tcp_header_len
suffix:semicolon
id|tcp_v4_hash
c_func
(paren
id|newsk
)paren
suffix:semicolon
id|add_to_prot_sklist
c_func
(paren
id|newsk
)paren
suffix:semicolon
r_return
id|newsk
suffix:semicolon
m_exit
suffix:colon
r_if
c_cond
(paren
id|dst
)paren
id|dst_release
c_func
(paren
id|dst
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
DECL|function|tcp_v4_rst_req
r_static
r_void
id|tcp_v4_rst_req
c_func
(paren
r_struct
id|sock
op_star
id|sk
comma
r_struct
id|sk_buff
op_star
id|skb
)paren
(brace
r_struct
id|tcp_opt
op_star
id|tp
op_assign
op_amp
id|sk-&gt;tp_pinfo.af_tcp
suffix:semicolon
r_struct
id|open_request
op_star
id|req
comma
op_star
id|prev
suffix:semicolon
id|req
op_assign
id|tcp_v4_search_req
c_func
(paren
id|tp
comma
id|skb-&gt;nh.iph
comma
id|skb-&gt;h.th
comma
op_amp
id|prev
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|req
)paren
r_return
suffix:semicolon
multiline_comment|/* Sequence number check required by RFC793 */
r_if
c_cond
(paren
id|before
c_func
(paren
id|skb-&gt;seq
comma
id|req-&gt;snt_isn
)paren
op_logical_or
id|after
c_func
(paren
id|skb-&gt;seq
comma
id|req-&gt;snt_isn
op_plus
l_int|1
)paren
)paren
r_return
suffix:semicolon
id|tcp_synq_unlink
c_func
(paren
id|tp
comma
id|req
comma
id|prev
)paren
suffix:semicolon
id|req
op_member_access_from_pointer
r_class
op_member_access_from_pointer
id|destructor
c_func
(paren
id|req
)paren
suffix:semicolon
id|tcp_openreq_free
c_func
(paren
id|req
)paren
suffix:semicolon
)brace
multiline_comment|/* Check for embryonic sockets (open_requests) We check packets with&n; * only the SYN bit set against the open_request queue too: This&n; * increases connection latency a bit, but is required to detect&n; * retransmitted SYNs.  &n; */
DECL|function|tcp_v4_hnd_req
r_static
r_inline
r_struct
id|sock
op_star
id|tcp_v4_hnd_req
c_func
(paren
r_struct
id|sock
op_star
id|sk
comma
r_struct
id|sk_buff
op_star
id|skb
)paren
(brace
r_struct
id|tcphdr
op_star
id|th
op_assign
id|skb-&gt;h.th
suffix:semicolon
id|u32
id|flg
op_assign
(paren
(paren
id|u32
op_star
)paren
id|th
)paren
(braket
l_int|3
)braket
suffix:semicolon
multiline_comment|/* Check for RST */
r_if
c_cond
(paren
id|flg
op_amp
id|__constant_htonl
c_func
(paren
l_int|0x00040000
)paren
)paren
(brace
id|tcp_v4_rst_req
c_func
(paren
id|sk
comma
id|skb
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
multiline_comment|/* Check for SYN|ACK */
r_if
c_cond
(paren
id|flg
op_amp
id|__constant_htonl
c_func
(paren
l_int|0x00120000
)paren
)paren
(brace
r_struct
id|open_request
op_star
id|req
comma
op_star
id|dummy
suffix:semicolon
r_struct
id|tcp_opt
op_star
id|tp
op_assign
op_amp
(paren
id|sk-&gt;tp_pinfo.af_tcp
)paren
suffix:semicolon
multiline_comment|/* Find possible connection requests. */
id|req
op_assign
id|tcp_v4_search_req
c_func
(paren
id|tp
comma
id|skb-&gt;nh.iph
comma
id|th
comma
op_amp
id|dummy
)paren
suffix:semicolon
r_if
c_cond
(paren
id|req
)paren
(brace
id|sk
op_assign
id|tcp_check_req
c_func
(paren
id|sk
comma
id|skb
comma
id|req
)paren
suffix:semicolon
)brace
macro_line|#ifdef CONFIG_SYN_COOKIES
r_else
(brace
id|sk
op_assign
id|cookie_v4_check
c_func
(paren
id|sk
comma
id|skb
comma
op_amp
(paren
id|IPCB
c_func
(paren
id|skb
)paren
op_member_access_from_pointer
id|opt
)paren
)paren
suffix:semicolon
)brace
macro_line|#endif
)brace
r_return
id|sk
suffix:semicolon
)brace
DECL|function|tcp_v4_do_rcv
r_int
id|tcp_v4_do_rcv
c_func
(paren
r_struct
id|sock
op_star
id|sk
comma
r_struct
id|sk_buff
op_star
id|skb
)paren
(brace
macro_line|#ifdef CONFIG_FILTER
r_if
c_cond
(paren
id|sk-&gt;filter
)paren
(brace
r_if
c_cond
(paren
id|sk_filter
c_func
(paren
id|skb
comma
id|sk-&gt;filter_data
comma
id|sk-&gt;filter
)paren
)paren
r_return
op_minus
id|EPERM
suffix:semicolon
multiline_comment|/* Toss packet */
)brace
macro_line|#endif /* CONFIG_FILTER */
id|skb_set_owner_r
c_func
(paren
id|skb
comma
id|sk
)paren
suffix:semicolon
multiline_comment|/*&n;&t; *&t;socket locking is here for SMP purposes as backlog rcv&n;&t; *&t;is currently called with bh processing disabled.&n;&t; */
id|lock_sock
c_func
(paren
id|sk
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sk-&gt;state
op_eq
id|TCP_ESTABLISHED
)paren
(brace
multiline_comment|/* Fast path */
r_if
c_cond
(paren
id|tcp_rcv_established
c_func
(paren
id|sk
comma
id|skb
comma
id|skb-&gt;h.th
comma
id|skb-&gt;len
)paren
)paren
r_goto
id|reset
suffix:semicolon
id|release_sock
c_func
(paren
id|sk
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|sk-&gt;state
op_eq
id|TCP_LISTEN
)paren
(brace
r_struct
id|sock
op_star
id|nsk
suffix:semicolon
id|nsk
op_assign
id|tcp_v4_hnd_req
c_func
(paren
id|sk
comma
id|skb
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|nsk
)paren
r_goto
id|discard
suffix:semicolon
id|lock_sock
c_func
(paren
id|nsk
)paren
suffix:semicolon
id|release_sock
c_func
(paren
id|sk
)paren
suffix:semicolon
id|sk
op_assign
id|nsk
suffix:semicolon
)brace
r_if
c_cond
(paren
id|tcp_rcv_state_process
c_func
(paren
id|sk
comma
id|skb
comma
id|skb-&gt;h.th
comma
op_amp
(paren
id|IPCB
c_func
(paren
id|skb
)paren
op_member_access_from_pointer
id|opt
)paren
comma
id|skb-&gt;len
)paren
)paren
r_goto
id|reset
suffix:semicolon
id|release_sock
c_func
(paren
id|sk
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
id|reset
suffix:colon
id|tcp_v4_send_reset
c_func
(paren
id|skb
)paren
suffix:semicolon
id|discard
suffix:colon
id|kfree_skb
c_func
(paren
id|skb
comma
id|FREE_READ
)paren
suffix:semicolon
multiline_comment|/* Be careful here. If this function gets more complicated and&n;&t; * gcc suffers from register pressure on the x86, sk (in %ebx) &n;&t; * might be destroyed here. This current version compiles correctly,&n;&t; * but you have been warned.&n;&t; */
id|release_sock
c_func
(paren
id|sk
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;From tcp_input.c&n; */
DECL|function|tcp_v4_rcv
r_int
id|tcp_v4_rcv
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_int
r_int
id|len
)paren
(brace
r_struct
id|tcphdr
op_star
id|th
suffix:semicolon
r_struct
id|sock
op_star
id|sk
suffix:semicolon
r_if
c_cond
(paren
id|skb-&gt;pkt_type
op_ne
id|PACKET_HOST
)paren
r_goto
id|discard_it
suffix:semicolon
id|th
op_assign
id|skb-&gt;h.th
suffix:semicolon
multiline_comment|/* Pull up the IP header. */
id|__skb_pull
c_func
(paren
id|skb
comma
id|skb-&gt;h.raw
op_minus
id|skb-&gt;data
)paren
suffix:semicolon
multiline_comment|/* Count it even if it&squot;s bad */
id|tcp_statistics.TcpInSegs
op_increment
suffix:semicolon
multiline_comment|/* Try to use the device checksum if provided. */
r_switch
c_cond
(paren
id|skb-&gt;ip_summed
)paren
(brace
r_case
id|CHECKSUM_NONE
suffix:colon
id|skb-&gt;csum
op_assign
id|csum_partial
c_func
(paren
(paren
r_char
op_star
)paren
id|th
comma
id|len
comma
l_int|0
)paren
suffix:semicolon
r_case
id|CHECKSUM_HW
suffix:colon
r_if
c_cond
(paren
id|tcp_v4_check
c_func
(paren
id|th
comma
id|len
comma
id|skb-&gt;nh.iph-&gt;saddr
comma
id|skb-&gt;nh.iph-&gt;daddr
comma
id|skb-&gt;csum
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;TCPv4 bad checksum from %d.%d.%d.%d:%04x to %d.%d.%d.%d:%04x, len=%d/%d/%d&bslash;n&quot;
comma
id|NIPQUAD
c_func
(paren
id|skb-&gt;nh.iph-&gt;saddr
)paren
comma
id|ntohs
c_func
(paren
id|th-&gt;source
)paren
comma
id|NIPQUAD
c_func
(paren
id|skb-&gt;nh.iph-&gt;daddr
)paren
comma
id|ntohs
c_func
(paren
id|th-&gt;dest
)paren
comma
id|len
comma
id|skb-&gt;len
comma
id|ntohs
c_func
(paren
id|skb-&gt;nh.iph-&gt;tot_len
)paren
)paren
suffix:semicolon
id|tcp_statistics.TcpInErrs
op_increment
suffix:semicolon
r_goto
id|discard_it
suffix:semicolon
)brace
r_default
suffix:colon
(brace
)brace
multiline_comment|/* CHECKSUM_UNNECESSARY */
)brace
macro_line|#ifdef CONFIG_IP_TRANSPARENT_PROXY
r_if
c_cond
(paren
id|IPCB
c_func
(paren
id|skb
)paren
op_member_access_from_pointer
id|redirport
)paren
id|sk
op_assign
id|tcp_v4_proxy_lookup
c_func
(paren
id|th-&gt;dest
comma
id|skb-&gt;nh.iph-&gt;saddr
comma
id|th-&gt;source
comma
id|skb-&gt;nh.iph-&gt;daddr
comma
id|skb-&gt;dev
comma
id|IPCB
c_func
(paren
id|skb
)paren
op_member_access_from_pointer
id|redirport
comma
id|skb-&gt;dev-&gt;ifindex
)paren
suffix:semicolon
r_else
macro_line|#endif
id|sk
op_assign
id|__tcp_v4_lookup
c_func
(paren
id|th
comma
id|skb-&gt;nh.iph-&gt;saddr
comma
id|th-&gt;source
comma
id|skb-&gt;nh.iph-&gt;daddr
comma
id|th-&gt;dest
comma
id|skb-&gt;dev-&gt;ifindex
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|sk
)paren
r_goto
id|no_tcp_socket
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ipsec_sk_policy
c_func
(paren
id|sk
comma
id|skb
)paren
)paren
(brace
r_goto
id|discard_it
suffix:semicolon
)brace
id|skb-&gt;seq
op_assign
id|ntohl
c_func
(paren
id|th-&gt;seq
)paren
suffix:semicolon
id|skb-&gt;end_seq
op_assign
id|skb-&gt;seq
op_plus
id|th-&gt;syn
op_plus
id|th-&gt;fin
op_plus
id|len
op_minus
id|th-&gt;doff
op_star
l_int|4
suffix:semicolon
id|skb-&gt;ack_seq
op_assign
id|ntohl
c_func
(paren
id|th-&gt;ack_seq
)paren
suffix:semicolon
id|skb-&gt;used
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|sk-&gt;sock_readers
)paren
r_return
id|tcp_v4_do_rcv
c_func
(paren
id|sk
comma
id|skb
)paren
suffix:semicolon
id|__skb_queue_tail
c_func
(paren
op_amp
id|sk-&gt;back_log
comma
id|skb
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
id|no_tcp_socket
suffix:colon
id|tcp_v4_send_reset
c_func
(paren
id|skb
)paren
suffix:semicolon
id|discard_it
suffix:colon
multiline_comment|/* Discard frame. */
id|kfree_skb
c_func
(paren
id|skb
comma
id|FREE_READ
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|tcp_v4_build_header
r_int
id|tcp_v4_build_header
c_func
(paren
r_struct
id|sock
op_star
id|sk
comma
r_struct
id|sk_buff
op_star
id|skb
)paren
(brace
r_return
id|ip_build_header
c_func
(paren
id|skb
comma
id|sk
)paren
suffix:semicolon
)brace
DECL|function|tcp_v4_rebuild_header
r_int
id|tcp_v4_rebuild_header
c_func
(paren
r_struct
id|sock
op_star
id|sk
comma
r_struct
id|sk_buff
op_star
id|skb
)paren
(brace
r_struct
id|rtable
op_star
id|rt
suffix:semicolon
r_struct
id|iphdr
op_star
id|iph
suffix:semicolon
r_struct
id|tcphdr
op_star
id|th
suffix:semicolon
r_int
id|size
suffix:semicolon
r_int
id|want_rewrite
op_assign
id|sysctl_ip_dynaddr
op_logical_and
id|sk-&gt;state
op_eq
id|TCP_SYN_SENT
suffix:semicolon
multiline_comment|/* Check route */
id|rt
op_assign
(paren
r_struct
id|rtable
op_star
)paren
id|skb-&gt;dst
suffix:semicolon
multiline_comment|/* Force route checking if want_rewrite */
multiline_comment|/* The idea is good, the implementation is disguisting.&n;&t;   Well, if I made bind on this socket, you cannot randomly ovewrite&n;&t;   its source address. --ANK&n;&t; */
r_if
c_cond
(paren
id|want_rewrite
)paren
(brace
r_int
id|tmp
suffix:semicolon
id|__u32
id|old_saddr
op_assign
id|rt-&gt;rt_src
suffix:semicolon
multiline_comment|/* Query new route */
id|tmp
op_assign
id|ip_route_connect
c_func
(paren
op_amp
id|rt
comma
id|rt-&gt;rt_dst
comma
l_int|0
comma
id|RT_TOS
c_func
(paren
id|sk-&gt;ip_tos
)paren
op_or
(paren
id|sk-&gt;localroute
op_logical_or
l_int|0
)paren
comma
id|sk-&gt;bound_dev_if
)paren
suffix:semicolon
multiline_comment|/* Only useful if different source addrs */
r_if
c_cond
(paren
id|tmp
op_eq
l_int|0
op_logical_or
id|rt-&gt;rt_src
op_ne
id|old_saddr
)paren
(brace
id|dst_release
c_func
(paren
id|skb-&gt;dst
)paren
suffix:semicolon
id|skb-&gt;dst
op_assign
op_amp
id|rt-&gt;u.dst
suffix:semicolon
)brace
r_else
(brace
id|want_rewrite
op_assign
l_int|0
suffix:semicolon
id|dst_release
c_func
(paren
op_amp
id|rt-&gt;u.dst
)paren
suffix:semicolon
)brace
)brace
r_else
r_if
c_cond
(paren
id|rt-&gt;u.dst.obsolete
)paren
(brace
r_int
id|err
suffix:semicolon
id|err
op_assign
id|ip_route_output
c_func
(paren
op_amp
id|rt
comma
id|rt-&gt;rt_dst
comma
id|rt-&gt;rt_src
comma
id|rt-&gt;key.tos
comma
id|rt-&gt;key.oif
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
(brace
id|sk-&gt;err_soft
op_assign
op_minus
id|err
suffix:semicolon
id|sk
op_member_access_from_pointer
id|error_report
c_func
(paren
id|skb-&gt;sk
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|dst_release
c_func
(paren
id|skb-&gt;dst
)paren
suffix:semicolon
id|skb-&gt;dst
op_assign
op_amp
id|rt-&gt;u.dst
suffix:semicolon
)brace
id|iph
op_assign
id|skb-&gt;nh.iph
suffix:semicolon
id|th
op_assign
id|skb-&gt;h.th
suffix:semicolon
id|size
op_assign
id|skb-&gt;tail
op_minus
id|skb-&gt;h.raw
suffix:semicolon
r_if
c_cond
(paren
id|want_rewrite
)paren
(brace
id|__u32
id|new_saddr
op_assign
id|rt-&gt;rt_src
suffix:semicolon
multiline_comment|/*&n;                 *&t;Ouch!, this should not happen.&n;                 */
r_if
c_cond
(paren
op_logical_neg
id|sk-&gt;saddr
op_logical_or
op_logical_neg
id|sk-&gt;rcv_saddr
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;tcp_v4_rebuild_header(): not valid sock addrs: saddr=%08lX rcv_saddr=%08lX&bslash;n&quot;
comma
id|ntohl
c_func
(paren
id|sk-&gt;saddr
)paren
comma
id|ntohl
c_func
(paren
id|sk-&gt;rcv_saddr
)paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n;&t;&t; *&t;Maybe whe are in a skb chain loop and socket address has&n;&t;&t; *&t;yet been &squot;damaged&squot;.&n;&t;&t; */
r_if
c_cond
(paren
id|new_saddr
op_ne
id|sk-&gt;saddr
)paren
(brace
r_if
c_cond
(paren
id|sysctl_ip_dynaddr
OG
l_int|1
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;tcp_v4_rebuild_header(): shifting sk-&gt;saddr from %d.%d.%d.%d to %d.%d.%d.%d&bslash;n&quot;
comma
id|NIPQUAD
c_func
(paren
id|sk-&gt;saddr
)paren
comma
id|NIPQUAD
c_func
(paren
id|new_saddr
)paren
)paren
suffix:semicolon
)brace
id|sk-&gt;saddr
op_assign
id|new_saddr
suffix:semicolon
id|sk-&gt;rcv_saddr
op_assign
id|new_saddr
suffix:semicolon
multiline_comment|/* sk-&gt;prot-&gt;rehash(sk); */
id|tcp_v4_rehash
c_func
(paren
id|sk
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|new_saddr
op_ne
id|iph-&gt;saddr
)paren
(brace
r_if
c_cond
(paren
id|sysctl_ip_dynaddr
OG
l_int|1
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;tcp_v4_rebuild_header(): shifting iph-&gt;saddr from %d.%d.%d.%d to %d.%d.%d.%d&bslash;n&quot;
comma
id|NIPQUAD
c_func
(paren
id|iph-&gt;saddr
)paren
comma
id|NIPQUAD
c_func
(paren
id|new_saddr
)paren
)paren
suffix:semicolon
)brace
id|iph-&gt;saddr
op_assign
id|new_saddr
suffix:semicolon
id|ip_send_check
c_func
(paren
id|iph
)paren
suffix:semicolon
)brace
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|tcp_v4_get_sock
r_static
r_struct
id|sock
op_star
id|tcp_v4_get_sock
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|tcphdr
op_star
id|th
)paren
(brace
r_return
id|tcp_v4_lookup
c_func
(paren
id|skb-&gt;nh.iph-&gt;saddr
comma
id|th-&gt;source
comma
id|skb-&gt;nh.iph-&gt;daddr
comma
id|th-&gt;dest
comma
id|skb-&gt;dev-&gt;ifindex
)paren
suffix:semicolon
)brace
DECL|function|v4_addr2sockaddr
r_static
r_void
id|v4_addr2sockaddr
c_func
(paren
r_struct
id|sock
op_star
id|sk
comma
r_struct
id|sockaddr
op_star
id|uaddr
)paren
(brace
r_struct
id|sockaddr_in
op_star
id|sin
op_assign
(paren
r_struct
id|sockaddr_in
op_star
)paren
id|uaddr
suffix:semicolon
id|sin-&gt;sin_family
op_assign
id|AF_INET
suffix:semicolon
id|sin-&gt;sin_addr.s_addr
op_assign
id|sk-&gt;daddr
suffix:semicolon
id|sin-&gt;sin_port
op_assign
id|sk-&gt;dummy_th.dest
suffix:semicolon
)brace
DECL|variable|ipv4_specific
r_struct
id|tcp_func
id|ipv4_specific
op_assign
(brace
id|tcp_v4_build_header
comma
id|ip_queue_xmit
comma
id|tcp_v4_send_check
comma
id|tcp_v4_rebuild_header
comma
id|tcp_v4_conn_request
comma
id|tcp_v4_syn_recv_sock
comma
id|tcp_v4_get_sock
comma
id|ip_setsockopt
comma
id|ip_getsockopt
comma
id|v4_addr2sockaddr
comma
r_sizeof
(paren
r_struct
id|sockaddr_in
)paren
)brace
suffix:semicolon
DECL|function|tcp_v4_init_sock
r_static
r_int
id|tcp_v4_init_sock
c_func
(paren
r_struct
id|sock
op_star
id|sk
)paren
(brace
r_struct
id|tcp_opt
op_star
id|tp
op_assign
op_amp
(paren
id|sk-&gt;tp_pinfo.af_tcp
)paren
suffix:semicolon
id|skb_queue_head_init
c_func
(paren
op_amp
id|sk-&gt;out_of_order_queue
)paren
suffix:semicolon
id|tcp_init_xmit_timers
c_func
(paren
id|sk
)paren
suffix:semicolon
id|tp-&gt;srtt
op_assign
l_int|0
suffix:semicolon
id|tp-&gt;rto
op_assign
id|TCP_TIMEOUT_INIT
suffix:semicolon
multiline_comment|/*TCP_WRITE_TIME*/
id|tp-&gt;mdev
op_assign
id|TCP_TIMEOUT_INIT
suffix:semicolon
id|tp-&gt;ato
op_assign
l_int|0
suffix:semicolon
id|tp-&gt;iat
op_assign
(paren
id|HZ
op_div
l_int|5
)paren
op_lshift
l_int|3
suffix:semicolon
multiline_comment|/* FIXME: tie this to sk-&gt;rcvbuf? (May be unnecessary) */
multiline_comment|/* tp-&gt;rcv_wnd = 8192; */
id|tp-&gt;tstamp_ok
op_assign
l_int|0
suffix:semicolon
id|tp-&gt;sack_ok
op_assign
l_int|0
suffix:semicolon
id|tp-&gt;wscale_ok
op_assign
l_int|0
suffix:semicolon
id|tp-&gt;in_mss
op_assign
l_int|536
suffix:semicolon
id|tp-&gt;snd_wscale
op_assign
l_int|0
suffix:semicolon
id|tp-&gt;sacks
op_assign
l_int|0
suffix:semicolon
id|tp-&gt;saw_tstamp
op_assign
l_int|0
suffix:semicolon
id|tp-&gt;syn_backlog
op_assign
l_int|0
suffix:semicolon
multiline_comment|/*&n;&t; * See draft-stevens-tcpca-spec-01 for discussion of the&n;&t; * initialization of these values.&n;&t; */
id|tp-&gt;snd_cwnd
op_assign
l_int|1
suffix:semicolon
id|tp-&gt;snd_ssthresh
op_assign
l_int|0x7fffffff
suffix:semicolon
multiline_comment|/* Infinity */
id|sk-&gt;priority
op_assign
l_int|1
suffix:semicolon
id|sk-&gt;state
op_assign
id|TCP_CLOSE
suffix:semicolon
id|sk-&gt;max_ack_backlog
op_assign
id|SOMAXCONN
suffix:semicolon
id|sk-&gt;mtu
op_assign
l_int|576
suffix:semicolon
id|sk-&gt;mss
op_assign
l_int|536
suffix:semicolon
multiline_comment|/* Speed up by setting some standard state for the dummy_th. */
id|sk-&gt;dummy_th.ack
op_assign
l_int|1
suffix:semicolon
id|sk-&gt;dummy_th.doff
op_assign
r_sizeof
(paren
r_struct
id|tcphdr
)paren
op_rshift
l_int|2
suffix:semicolon
multiline_comment|/* Init SYN queue. */
id|tcp_synq_init
c_func
(paren
id|tp
)paren
suffix:semicolon
id|sk-&gt;tp_pinfo.af_tcp.af_specific
op_assign
op_amp
id|ipv4_specific
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|tcp_v4_destroy_sock
r_static
r_int
id|tcp_v4_destroy_sock
c_func
(paren
r_struct
id|sock
op_star
id|sk
)paren
(brace
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
id|tcp_clear_xmit_timers
c_func
(paren
id|sk
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sk-&gt;keepopen
)paren
id|tcp_dec_slow_timer
c_func
(paren
id|TCP_SLT_KEEPALIVE
)paren
suffix:semicolon
multiline_comment|/* Cleanup up the write buffer. */
r_while
c_loop
(paren
(paren
id|skb
op_assign
id|skb_dequeue
c_func
(paren
op_amp
id|sk-&gt;write_queue
)paren
)paren
op_ne
l_int|NULL
)paren
(brace
id|kfree_skb
c_func
(paren
id|skb
comma
id|FREE_WRITE
)paren
suffix:semicolon
)brace
multiline_comment|/* Cleans up our, hopefuly empty, out_of_order_queue. */
r_while
c_loop
(paren
(paren
id|skb
op_assign
id|skb_dequeue
c_func
(paren
op_amp
id|sk-&gt;out_of_order_queue
)paren
)paren
op_ne
l_int|NULL
)paren
(brace
id|kfree_skb
c_func
(paren
id|skb
comma
id|FREE_READ
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|variable|tcp_prot
r_struct
id|proto
id|tcp_prot
op_assign
(brace
(paren
r_struct
id|sock
op_star
)paren
op_amp
id|tcp_prot
comma
multiline_comment|/* sklist_next */
(paren
r_struct
id|sock
op_star
)paren
op_amp
id|tcp_prot
comma
multiline_comment|/* sklist_prev */
id|tcp_close
comma
multiline_comment|/* close */
id|tcp_v4_connect
comma
multiline_comment|/* connect */
id|tcp_accept
comma
multiline_comment|/* accept */
l_int|NULL
comma
multiline_comment|/* retransmit */
id|tcp_write_wakeup
comma
multiline_comment|/* write_wakeup */
id|tcp_read_wakeup
comma
multiline_comment|/* read_wakeup */
id|tcp_poll
comma
multiline_comment|/* poll */
id|tcp_ioctl
comma
multiline_comment|/* ioctl */
id|tcp_v4_init_sock
comma
multiline_comment|/* init */
id|tcp_v4_destroy_sock
comma
multiline_comment|/* destroy */
id|tcp_shutdown
comma
multiline_comment|/* shutdown */
id|tcp_setsockopt
comma
multiline_comment|/* setsockopt */
id|tcp_getsockopt
comma
multiline_comment|/* getsockopt */
id|tcp_v4_sendmsg
comma
multiline_comment|/* sendmsg */
id|tcp_recvmsg
comma
multiline_comment|/* recvmsg */
l_int|NULL
comma
multiline_comment|/* bind */
id|tcp_v4_do_rcv
comma
multiline_comment|/* backlog_rcv */
id|tcp_v4_hash
comma
multiline_comment|/* hash */
id|tcp_v4_unhash
comma
multiline_comment|/* unhash */
id|tcp_v4_rehash
comma
multiline_comment|/* rehash */
id|tcp_good_socknum
comma
multiline_comment|/* good_socknum */
id|tcp_v4_verify_bind
comma
multiline_comment|/* verify_bind */
l_int|128
comma
multiline_comment|/* max_header */
l_int|0
comma
multiline_comment|/* retransmits */
l_string|&quot;TCP&quot;
comma
multiline_comment|/* name */
l_int|0
comma
multiline_comment|/* inuse */
l_int|0
multiline_comment|/* highestinuse */
)brace
suffix:semicolon
eof
