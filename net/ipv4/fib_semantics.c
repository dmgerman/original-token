multiline_comment|/*&n; * INET&t;&t;An implementation of the TCP/IP protocol suite for the LINUX&n; *&t;&t;operating system.  INET is implemented using the  BSD Socket&n; *&t;&t;interface as the means of communication with the user level.&n; *&n; *&t;&t;IPv4 Forwarding Information Base: semantics.&n; *&n; * Version:&t;$Id: fib_semantics.c,v 1.17 2000/08/19 23:22:56 davem Exp $&n; *&n; * Authors:&t;Alexey Kuznetsov, &lt;kuznet@ms2.inr.ac.ru&gt;&n; *&n; *&t;&t;This program is free software; you can redistribute it and/or&n; *&t;&t;modify it under the terms of the GNU General Public License&n; *&t;&t;as published by the Free Software Foundation; either version&n; *&t;&t;2 of the License, or (at your option) any later version.&n; */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;asm/uaccess.h&gt;
macro_line|#include &lt;asm/system.h&gt;
macro_line|#include &lt;asm/bitops.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/mm.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/socket.h&gt;
macro_line|#include &lt;linux/sockios.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/in.h&gt;
macro_line|#include &lt;linux/inet.h&gt;
macro_line|#include &lt;linux/netdevice.h&gt;
macro_line|#include &lt;linux/if_arp.h&gt;
macro_line|#include &lt;linux/proc_fs.h&gt;
macro_line|#include &lt;linux/skbuff.h&gt;
macro_line|#include &lt;linux/netlink.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;net/ip.h&gt;
macro_line|#include &lt;net/protocol.h&gt;
macro_line|#include &lt;net/route.h&gt;
macro_line|#include &lt;net/tcp.h&gt;
macro_line|#include &lt;net/sock.h&gt;
macro_line|#include &lt;net/ip_fib.h&gt;
DECL|macro|FSprintk
mdefine_line|#define FSprintk(a...)
DECL|variable|fib_info_list
r_static
r_struct
id|fib_info
op_star
id|fib_info_list
suffix:semicolon
DECL|variable|fib_info_lock
r_static
id|rwlock_t
id|fib_info_lock
op_assign
id|RW_LOCK_UNLOCKED
suffix:semicolon
DECL|variable|fib_info_cnt
r_int
id|fib_info_cnt
suffix:semicolon
DECL|macro|for_fib_info
mdefine_line|#define for_fib_info() { struct fib_info *fi; &bslash;&n;&t;for (fi = fib_info_list; fi; fi = fi-&gt;fib_next)
DECL|macro|endfor_fib_info
mdefine_line|#define endfor_fib_info() }
macro_line|#ifdef CONFIG_IP_ROUTE_MULTIPATH
DECL|macro|for_nexthops
mdefine_line|#define for_nexthops(fi) { int nhsel; const struct fib_nh * nh; &bslash;&n;for (nhsel=0, nh = (fi)-&gt;fib_nh; nhsel &lt; (fi)-&gt;fib_nhs; nh++, nhsel++)
DECL|macro|change_nexthops
mdefine_line|#define change_nexthops(fi) { int nhsel; struct fib_nh * nh; &bslash;&n;for (nhsel=0, nh = (struct fib_nh*)((fi)-&gt;fib_nh); nhsel &lt; (fi)-&gt;fib_nhs; nh++, nhsel++)
macro_line|#else /* CONFIG_IP_ROUTE_MULTIPATH */
multiline_comment|/* Hope, that gcc will optimize it to get rid of dummy loop */
DECL|macro|for_nexthops
mdefine_line|#define for_nexthops(fi) { int nhsel=0; const struct fib_nh * nh = (fi)-&gt;fib_nh; &bslash;&n;for (nhsel=0; nhsel &lt; 1; nhsel++)
DECL|macro|change_nexthops
mdefine_line|#define change_nexthops(fi) { int nhsel=0; struct fib_nh * nh = (struct fib_nh*)((fi)-&gt;fib_nh); &bslash;&n;for (nhsel=0; nhsel &lt; 1; nhsel++)
macro_line|#endif /* CONFIG_IP_ROUTE_MULTIPATH */
DECL|macro|endfor_nexthops
mdefine_line|#define endfor_nexthops(fi) }
r_static
r_struct
(brace
DECL|member|error
r_int
id|error
suffix:semicolon
DECL|member|scope
id|u8
id|scope
suffix:semicolon
DECL|variable|fib_props
)brace
id|fib_props
(braket
id|RTA_MAX
op_plus
l_int|1
)braket
op_assign
(brace
(brace
l_int|0
comma
id|RT_SCOPE_NOWHERE
)brace
comma
multiline_comment|/* RTN_UNSPEC */
(brace
l_int|0
comma
id|RT_SCOPE_UNIVERSE
)brace
comma
multiline_comment|/* RTN_UNICAST */
(brace
l_int|0
comma
id|RT_SCOPE_HOST
)brace
comma
multiline_comment|/* RTN_LOCAL */
(brace
l_int|0
comma
id|RT_SCOPE_LINK
)brace
comma
multiline_comment|/* RTN_BROADCAST */
(brace
l_int|0
comma
id|RT_SCOPE_LINK
)brace
comma
multiline_comment|/* RTN_ANYCAST */
(brace
l_int|0
comma
id|RT_SCOPE_UNIVERSE
)brace
comma
multiline_comment|/* RTN_MULTICAST */
(brace
op_minus
id|EINVAL
comma
id|RT_SCOPE_UNIVERSE
)brace
comma
multiline_comment|/* RTN_BLACKHOLE */
(brace
op_minus
id|EHOSTUNREACH
comma
id|RT_SCOPE_UNIVERSE
)brace
comma
multiline_comment|/* RTN_UNREACHABLE */
(brace
op_minus
id|EACCES
comma
id|RT_SCOPE_UNIVERSE
)brace
comma
multiline_comment|/* RTN_PROHIBIT */
(brace
op_minus
id|EAGAIN
comma
id|RT_SCOPE_UNIVERSE
)brace
comma
multiline_comment|/* RTN_THROW */
macro_line|#ifdef CONFIG_IP_ROUTE_NAT
(brace
l_int|0
comma
id|RT_SCOPE_HOST
)brace
comma
multiline_comment|/* RTN_NAT */
macro_line|#else
(brace
op_minus
id|EINVAL
comma
id|RT_SCOPE_NOWHERE
)brace
comma
multiline_comment|/* RTN_NAT */
macro_line|#endif
(brace
op_minus
id|EINVAL
comma
id|RT_SCOPE_NOWHERE
)brace
multiline_comment|/* RTN_XRESOLVE */
)brace
suffix:semicolon
multiline_comment|/* Release a nexthop info record */
DECL|function|free_fib_info
r_void
id|free_fib_info
c_func
(paren
r_struct
id|fib_info
op_star
id|fi
)paren
(brace
r_if
c_cond
(paren
id|fi-&gt;fib_dead
op_eq
l_int|0
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;Freeing alive fib_info %p&bslash;n&quot;
comma
id|fi
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|change_nexthops
c_func
(paren
id|fi
)paren
(brace
r_if
c_cond
(paren
id|nh-&gt;nh_dev
)paren
id|dev_put
c_func
(paren
id|nh-&gt;nh_dev
)paren
suffix:semicolon
id|nh-&gt;nh_dev
op_assign
l_int|NULL
suffix:semicolon
)brace
id|endfor_nexthops
c_func
(paren
id|fi
)paren
suffix:semicolon
id|fib_info_cnt
op_decrement
suffix:semicolon
id|kfree
c_func
(paren
id|fi
)paren
suffix:semicolon
)brace
DECL|function|fib_release_info
r_void
id|fib_release_info
c_func
(paren
r_struct
id|fib_info
op_star
id|fi
)paren
(brace
id|write_lock
c_func
(paren
op_amp
id|fib_info_lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|fi
op_logical_and
op_decrement
id|fi-&gt;fib_treeref
op_eq
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|fi-&gt;fib_next
)paren
id|fi-&gt;fib_next-&gt;fib_prev
op_assign
id|fi-&gt;fib_prev
suffix:semicolon
r_if
c_cond
(paren
id|fi-&gt;fib_prev
)paren
id|fi-&gt;fib_prev-&gt;fib_next
op_assign
id|fi-&gt;fib_next
suffix:semicolon
r_if
c_cond
(paren
id|fi
op_eq
id|fib_info_list
)paren
id|fib_info_list
op_assign
id|fi-&gt;fib_next
suffix:semicolon
id|fi-&gt;fib_dead
op_assign
l_int|1
suffix:semicolon
id|fib_info_put
c_func
(paren
id|fi
)paren
suffix:semicolon
)brace
id|write_unlock
c_func
(paren
op_amp
id|fib_info_lock
)paren
suffix:semicolon
)brace
DECL|function|nh_comp
r_extern
id|__inline__
r_int
id|nh_comp
c_func
(paren
r_const
r_struct
id|fib_info
op_star
id|fi
comma
r_const
r_struct
id|fib_info
op_star
id|ofi
)paren
(brace
r_const
r_struct
id|fib_nh
op_star
id|onh
op_assign
id|ofi-&gt;fib_nh
suffix:semicolon
id|for_nexthops
c_func
(paren
id|fi
)paren
(brace
r_if
c_cond
(paren
id|nh-&gt;nh_oif
op_ne
id|onh-&gt;nh_oif
op_logical_or
id|nh-&gt;nh_gw
op_ne
id|onh-&gt;nh_gw
op_logical_or
id|nh-&gt;nh_scope
op_ne
id|onh-&gt;nh_scope
op_logical_or
macro_line|#ifdef CONFIG_IP_ROUTE_MULTIPATH
id|nh-&gt;nh_weight
op_ne
id|onh-&gt;nh_weight
op_logical_or
macro_line|#endif
macro_line|#ifdef CONFIG_NET_CLS_ROUTE
id|nh-&gt;nh_tclassid
op_ne
id|onh-&gt;nh_tclassid
op_logical_or
macro_line|#endif
(paren
(paren
id|nh-&gt;nh_flags
op_xor
id|onh-&gt;nh_flags
)paren
op_amp
op_complement
id|RTNH_F_DEAD
)paren
)paren
r_return
op_minus
l_int|1
suffix:semicolon
id|onh
op_increment
suffix:semicolon
)brace
id|endfor_nexthops
c_func
(paren
id|fi
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|fib_find_info
r_extern
id|__inline__
r_struct
id|fib_info
op_star
id|fib_find_info
c_func
(paren
r_const
r_struct
id|fib_info
op_star
id|nfi
)paren
(brace
id|for_fib_info
c_func
(paren
)paren
(brace
r_if
c_cond
(paren
id|fi-&gt;fib_nhs
op_ne
id|nfi-&gt;fib_nhs
)paren
r_continue
suffix:semicolon
r_if
c_cond
(paren
id|nfi-&gt;fib_protocol
op_eq
id|fi-&gt;fib_protocol
op_logical_and
id|nfi-&gt;fib_prefsrc
op_eq
id|fi-&gt;fib_prefsrc
op_logical_and
id|nfi-&gt;fib_priority
op_eq
id|fi-&gt;fib_priority
op_logical_and
id|memcmp
c_func
(paren
id|nfi-&gt;fib_metrics
comma
id|fi-&gt;fib_metrics
comma
r_sizeof
(paren
id|fi-&gt;fib_metrics
)paren
)paren
op_eq
l_int|0
op_logical_and
(paren
(paren
id|nfi-&gt;fib_flags
op_xor
id|fi-&gt;fib_flags
)paren
op_amp
op_complement
id|RTNH_F_DEAD
)paren
op_eq
l_int|0
op_logical_and
(paren
id|nfi-&gt;fib_nhs
op_eq
l_int|0
op_logical_or
id|nh_comp
c_func
(paren
id|fi
comma
id|nfi
)paren
op_eq
l_int|0
)paren
)paren
r_return
id|fi
suffix:semicolon
)brace
id|endfor_fib_info
c_func
(paren
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
multiline_comment|/* Check, that the gateway is already configured.&n;   Used only by redirect accept routine.&n; */
DECL|function|ip_fib_check_default
r_int
id|ip_fib_check_default
c_func
(paren
id|u32
id|gw
comma
r_struct
id|net_device
op_star
id|dev
)paren
(brace
id|read_lock
c_func
(paren
op_amp
id|fib_info_lock
)paren
suffix:semicolon
id|for_fib_info
c_func
(paren
)paren
(brace
r_if
c_cond
(paren
id|fi-&gt;fib_flags
op_amp
id|RTNH_F_DEAD
)paren
r_continue
suffix:semicolon
id|for_nexthops
c_func
(paren
id|fi
)paren
(brace
r_if
c_cond
(paren
id|nh-&gt;nh_dev
op_eq
id|dev
op_logical_and
id|nh-&gt;nh_gw
op_eq
id|gw
op_logical_and
op_logical_neg
(paren
id|nh-&gt;nh_flags
op_amp
id|RTNH_F_DEAD
)paren
)paren
(brace
id|read_unlock
c_func
(paren
op_amp
id|fib_info_lock
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
)brace
id|endfor_nexthops
c_func
(paren
id|fi
)paren
suffix:semicolon
)brace
id|endfor_fib_info
c_func
(paren
)paren
suffix:semicolon
id|read_unlock
c_func
(paren
op_amp
id|fib_info_lock
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
macro_line|#ifdef CONFIG_IP_ROUTE_MULTIPATH
DECL|function|fib_get_attr32
r_static
id|u32
id|fib_get_attr32
c_func
(paren
r_struct
id|rtattr
op_star
id|attr
comma
r_int
id|attrlen
comma
r_int
id|type
)paren
(brace
r_while
c_loop
(paren
id|RTA_OK
c_func
(paren
id|attr
comma
id|attrlen
)paren
)paren
(brace
r_if
c_cond
(paren
id|attr-&gt;rta_type
op_eq
id|type
)paren
r_return
op_star
(paren
id|u32
op_star
)paren
id|RTA_DATA
c_func
(paren
id|attr
)paren
suffix:semicolon
id|attr
op_assign
id|RTA_NEXT
c_func
(paren
id|attr
comma
id|attrlen
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_int
DECL|function|fib_count_nexthops
id|fib_count_nexthops
c_func
(paren
r_struct
id|rtattr
op_star
id|rta
)paren
(brace
r_int
id|nhs
op_assign
l_int|0
suffix:semicolon
r_struct
id|rtnexthop
op_star
id|nhp
op_assign
id|RTA_DATA
c_func
(paren
id|rta
)paren
suffix:semicolon
r_int
id|nhlen
op_assign
id|RTA_PAYLOAD
c_func
(paren
id|rta
)paren
suffix:semicolon
r_while
c_loop
(paren
id|nhlen
op_ge
(paren
r_int
)paren
r_sizeof
(paren
r_struct
id|rtnexthop
)paren
)paren
(brace
r_if
c_cond
(paren
(paren
id|nhlen
op_sub_assign
id|nhp-&gt;rtnh_len
)paren
OL
l_int|0
)paren
r_return
l_int|0
suffix:semicolon
id|nhs
op_increment
suffix:semicolon
id|nhp
op_assign
id|RTNH_NEXT
c_func
(paren
id|nhp
)paren
suffix:semicolon
)brace
suffix:semicolon
r_return
id|nhs
suffix:semicolon
)brace
r_static
r_int
DECL|function|fib_get_nhs
id|fib_get_nhs
c_func
(paren
r_struct
id|fib_info
op_star
id|fi
comma
r_const
r_struct
id|rtattr
op_star
id|rta
comma
r_const
r_struct
id|rtmsg
op_star
id|r
)paren
(brace
r_struct
id|rtnexthop
op_star
id|nhp
op_assign
id|RTA_DATA
c_func
(paren
id|rta
)paren
suffix:semicolon
r_int
id|nhlen
op_assign
id|RTA_PAYLOAD
c_func
(paren
id|rta
)paren
suffix:semicolon
id|change_nexthops
c_func
(paren
id|fi
)paren
(brace
r_int
id|attrlen
op_assign
id|nhlen
op_minus
r_sizeof
(paren
r_struct
id|rtnexthop
)paren
suffix:semicolon
r_if
c_cond
(paren
id|attrlen
OL
l_int|0
op_logical_or
(paren
id|nhlen
op_sub_assign
id|nhp-&gt;rtnh_len
)paren
OL
l_int|0
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|nh-&gt;nh_flags
op_assign
(paren
id|r-&gt;rtm_flags
op_amp
op_complement
l_int|0xFF
)paren
op_or
id|nhp-&gt;rtnh_flags
suffix:semicolon
id|nh-&gt;nh_oif
op_assign
id|nhp-&gt;rtnh_ifindex
suffix:semicolon
id|nh-&gt;nh_weight
op_assign
id|nhp-&gt;rtnh_hops
op_plus
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|attrlen
)paren
(brace
id|nh-&gt;nh_gw
op_assign
id|fib_get_attr32
c_func
(paren
id|RTNH_DATA
c_func
(paren
id|nhp
)paren
comma
id|attrlen
comma
id|RTA_GATEWAY
)paren
suffix:semicolon
macro_line|#ifdef CONFIG_NET_CLS_ROUTE
id|nh-&gt;nh_tclassid
op_assign
id|fib_get_attr32
c_func
(paren
id|RTNH_DATA
c_func
(paren
id|nhp
)paren
comma
id|attrlen
comma
id|RTA_FLOW
)paren
suffix:semicolon
macro_line|#endif
)brace
id|nhp
op_assign
id|RTNH_NEXT
c_func
(paren
id|nhp
)paren
suffix:semicolon
)brace
id|endfor_nexthops
c_func
(paren
id|fi
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#endif
DECL|function|fib_nh_match
r_int
id|fib_nh_match
c_func
(paren
r_struct
id|rtmsg
op_star
id|r
comma
r_struct
id|nlmsghdr
op_star
id|nlh
comma
r_struct
id|kern_rta
op_star
id|rta
comma
r_struct
id|fib_info
op_star
id|fi
)paren
(brace
macro_line|#ifdef CONFIG_IP_ROUTE_MULTIPATH
r_struct
id|rtnexthop
op_star
id|nhp
suffix:semicolon
r_int
id|nhlen
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|rta-&gt;rta_priority
op_logical_and
op_star
id|rta-&gt;rta_priority
op_ne
id|fi-&gt;fib_priority
)paren
r_return
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|rta-&gt;rta_oif
op_logical_or
id|rta-&gt;rta_gw
)paren
(brace
r_if
c_cond
(paren
(paren
op_logical_neg
id|rta-&gt;rta_oif
op_logical_or
op_star
id|rta-&gt;rta_oif
op_eq
id|fi-&gt;fib_nh-&gt;nh_oif
)paren
op_logical_and
(paren
op_logical_neg
id|rta-&gt;rta_gw
op_logical_or
id|memcmp
c_func
(paren
id|rta-&gt;rta_gw
comma
op_amp
id|fi-&gt;fib_nh-&gt;nh_gw
comma
l_int|4
)paren
op_eq
l_int|0
)paren
)paren
r_return
l_int|0
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
macro_line|#ifdef CONFIG_IP_ROUTE_MULTIPATH
r_if
c_cond
(paren
id|rta-&gt;rta_mp
op_eq
l_int|NULL
)paren
r_return
l_int|0
suffix:semicolon
id|nhp
op_assign
id|RTA_DATA
c_func
(paren
id|rta-&gt;rta_mp
)paren
suffix:semicolon
id|nhlen
op_assign
id|RTA_PAYLOAD
c_func
(paren
id|rta-&gt;rta_mp
)paren
suffix:semicolon
id|for_nexthops
c_func
(paren
id|fi
)paren
(brace
r_int
id|attrlen
op_assign
id|nhlen
op_minus
r_sizeof
(paren
r_struct
id|rtnexthop
)paren
suffix:semicolon
id|u32
id|gw
suffix:semicolon
r_if
c_cond
(paren
id|attrlen
OL
l_int|0
op_logical_or
(paren
id|nhlen
op_sub_assign
id|nhp-&gt;rtnh_len
)paren
OL
l_int|0
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|nhp-&gt;rtnh_ifindex
op_logical_and
id|nhp-&gt;rtnh_ifindex
op_ne
id|nh-&gt;nh_oif
)paren
r_return
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|attrlen
)paren
(brace
id|gw
op_assign
id|fib_get_attr32
c_func
(paren
id|RTNH_DATA
c_func
(paren
id|nhp
)paren
comma
id|attrlen
comma
id|RTA_GATEWAY
)paren
suffix:semicolon
r_if
c_cond
(paren
id|gw
op_logical_and
id|gw
op_ne
id|nh-&gt;nh_gw
)paren
r_return
l_int|1
suffix:semicolon
macro_line|#ifdef CONFIG_NET_CLS_ROUTE
id|gw
op_assign
id|fib_get_attr32
c_func
(paren
id|RTNH_DATA
c_func
(paren
id|nhp
)paren
comma
id|attrlen
comma
id|RTA_FLOW
)paren
suffix:semicolon
r_if
c_cond
(paren
id|gw
op_logical_and
id|gw
op_ne
id|nh-&gt;nh_tclassid
)paren
r_return
l_int|1
suffix:semicolon
macro_line|#endif
)brace
id|nhp
op_assign
id|RTNH_NEXT
c_func
(paren
id|nhp
)paren
suffix:semicolon
)brace
id|endfor_nexthops
c_func
(paren
id|fi
)paren
suffix:semicolon
macro_line|#endif
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n;   Picture&n;   -------&n;&n;   Semantics of nexthop is very messy by historical reasons.&n;   We have to take into account, that:&n;   a) gateway can be actually local interface address,&n;      so that gatewayed route is direct.&n;   b) gateway must be on-link address, possibly&n;      described not by an ifaddr, but also by a direct route.&n;   c) If both gateway and interface are specified, they should not&n;      contradict.&n;   d) If we use tunnel routes, gateway could be not on-link.&n;&n;   Attempt to reconcile all of these (alas, self-contradictory) conditions&n;   results in pretty ugly and hairy code with obscure logic.&n;&n;   I choosed to generalized it instead, so that the size&n;   of code does not increase practically, but it becomes&n;   much more general.&n;   Every prefix is assigned a &quot;scope&quot; value: &quot;host&quot; is local address,&n;   &quot;link&quot; is direct route,&n;   [ ... &quot;site&quot; ... &quot;interior&quot; ... ]&n;   and &quot;universe&quot; is true gateway route with global meaning.&n;&n;   Every prefix refers to a set of &quot;nexthop&quot;s (gw, oif),&n;   where gw must have narrower scope. This recursion stops&n;   when gw has LOCAL scope or if &quot;nexthop&quot; is declared ONLINK,&n;   which means that gw is forced to be on link.&n;&n;   Code is still hairy, but now it is apparently logically&n;   consistent and very flexible. F.e. as by-product it allows&n;   to co-exists in peace independent exterior and interior&n;   routing processes.&n;&n;   Normally it looks as following.&n;&n;   {universe prefix}  -&gt; (gw, oif) [scope link]&n;                          |&n;&t;&t;&t;  |-&gt; {link prefix} -&gt; (gw, oif) [scope local]&n;&t;&t;&t;                        |&n;&t;&t;&t;&t;&t;&t;|-&gt; {local prefix} (terminal node)&n; */
DECL|function|fib_check_nh
r_static
r_int
id|fib_check_nh
c_func
(paren
r_const
r_struct
id|rtmsg
op_star
id|r
comma
r_struct
id|fib_info
op_star
id|fi
comma
r_struct
id|fib_nh
op_star
id|nh
)paren
(brace
r_int
id|err
suffix:semicolon
r_if
c_cond
(paren
id|nh-&gt;nh_gw
)paren
(brace
r_struct
id|rt_key
id|key
suffix:semicolon
r_struct
id|fib_result
id|res
suffix:semicolon
macro_line|#ifdef CONFIG_IP_ROUTE_PERVASIVE
r_if
c_cond
(paren
id|nh-&gt;nh_flags
op_amp
id|RTNH_F_PERVASIVE
)paren
r_return
l_int|0
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|nh-&gt;nh_flags
op_amp
id|RTNH_F_ONLINK
)paren
(brace
r_struct
id|net_device
op_star
id|dev
suffix:semicolon
r_if
c_cond
(paren
id|r-&gt;rtm_scope
op_ge
id|RT_SCOPE_LINK
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|inet_addr_type
c_func
(paren
id|nh-&gt;nh_gw
)paren
op_ne
id|RTN_UNICAST
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
(paren
id|dev
op_assign
id|__dev_get_by_index
c_func
(paren
id|nh-&gt;nh_oif
)paren
)paren
op_eq
l_int|NULL
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|dev-&gt;flags
op_amp
id|IFF_UP
)paren
)paren
r_return
op_minus
id|ENETDOWN
suffix:semicolon
id|nh-&gt;nh_dev
op_assign
id|dev
suffix:semicolon
id|atomic_inc
c_func
(paren
op_amp
id|dev-&gt;refcnt
)paren
suffix:semicolon
id|nh-&gt;nh_scope
op_assign
id|RT_SCOPE_LINK
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|memset
c_func
(paren
op_amp
id|key
comma
l_int|0
comma
r_sizeof
(paren
id|key
)paren
)paren
suffix:semicolon
id|key.dst
op_assign
id|nh-&gt;nh_gw
suffix:semicolon
id|key.oif
op_assign
id|nh-&gt;nh_oif
suffix:semicolon
id|key.scope
op_assign
id|r-&gt;rtm_scope
op_plus
l_int|1
suffix:semicolon
multiline_comment|/* It is not necessary, but requires a bit of thinking */
r_if
c_cond
(paren
id|key.scope
OL
id|RT_SCOPE_LINK
)paren
id|key.scope
op_assign
id|RT_SCOPE_LINK
suffix:semicolon
r_if
c_cond
(paren
(paren
id|err
op_assign
id|fib_lookup
c_func
(paren
op_amp
id|key
comma
op_amp
id|res
)paren
)paren
op_ne
l_int|0
)paren
r_return
id|err
suffix:semicolon
id|nh-&gt;nh_scope
op_assign
id|res.scope
suffix:semicolon
id|nh-&gt;nh_oif
op_assign
id|FIB_RES_OIF
c_func
(paren
id|res
)paren
suffix:semicolon
id|nh-&gt;nh_dev
op_assign
id|FIB_RES_DEV
c_func
(paren
id|res
)paren
suffix:semicolon
r_if
c_cond
(paren
id|nh-&gt;nh_dev
)paren
id|atomic_inc
c_func
(paren
op_amp
id|nh-&gt;nh_dev-&gt;refcnt
)paren
suffix:semicolon
id|fib_res_put
c_func
(paren
op_amp
id|res
)paren
suffix:semicolon
)brace
r_else
(brace
r_struct
id|in_device
op_star
id|in_dev
suffix:semicolon
r_if
c_cond
(paren
id|nh-&gt;nh_flags
op_amp
(paren
id|RTNH_F_PERVASIVE
op_or
id|RTNH_F_ONLINK
)paren
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|in_dev
op_assign
id|inetdev_by_index
c_func
(paren
id|nh-&gt;nh_oif
)paren
suffix:semicolon
r_if
c_cond
(paren
id|in_dev
op_eq
l_int|NULL
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|in_dev-&gt;dev-&gt;flags
op_amp
id|IFF_UP
)paren
)paren
(brace
id|in_dev_put
c_func
(paren
id|in_dev
)paren
suffix:semicolon
r_return
op_minus
id|ENETDOWN
suffix:semicolon
)brace
id|nh-&gt;nh_dev
op_assign
id|in_dev-&gt;dev
suffix:semicolon
id|atomic_inc
c_func
(paren
op_amp
id|nh-&gt;nh_dev-&gt;refcnt
)paren
suffix:semicolon
id|nh-&gt;nh_scope
op_assign
id|RT_SCOPE_HOST
suffix:semicolon
id|in_dev_put
c_func
(paren
id|in_dev
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
r_struct
id|fib_info
op_star
DECL|function|fib_create_info
id|fib_create_info
c_func
(paren
r_const
r_struct
id|rtmsg
op_star
id|r
comma
r_struct
id|kern_rta
op_star
id|rta
comma
r_const
r_struct
id|nlmsghdr
op_star
id|nlh
comma
r_int
op_star
id|errp
)paren
(brace
r_int
id|err
suffix:semicolon
r_struct
id|fib_info
op_star
id|fi
op_assign
l_int|NULL
suffix:semicolon
r_struct
id|fib_info
op_star
id|ofi
suffix:semicolon
macro_line|#ifdef CONFIG_IP_ROUTE_MULTIPATH
r_int
id|nhs
op_assign
l_int|1
suffix:semicolon
macro_line|#else
r_const
r_int
id|nhs
op_assign
l_int|1
suffix:semicolon
macro_line|#endif
multiline_comment|/* Fast check to catch the most weird cases */
r_if
c_cond
(paren
id|fib_props
(braket
id|r-&gt;rtm_type
)braket
dot
id|scope
OG
id|r-&gt;rtm_scope
)paren
r_goto
id|err_inval
suffix:semicolon
macro_line|#ifdef CONFIG_IP_ROUTE_MULTIPATH
r_if
c_cond
(paren
id|rta-&gt;rta_mp
)paren
(brace
id|nhs
op_assign
id|fib_count_nexthops
c_func
(paren
id|rta-&gt;rta_mp
)paren
suffix:semicolon
r_if
c_cond
(paren
id|nhs
op_eq
l_int|0
)paren
r_goto
id|err_inval
suffix:semicolon
)brace
macro_line|#endif
id|fi
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
op_star
id|fi
)paren
op_plus
id|nhs
op_star
r_sizeof
(paren
r_struct
id|fib_nh
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
id|err
op_assign
op_minus
id|ENOBUFS
suffix:semicolon
r_if
c_cond
(paren
id|fi
op_eq
l_int|NULL
)paren
r_goto
id|failure
suffix:semicolon
id|fib_info_cnt
op_increment
suffix:semicolon
id|memset
c_func
(paren
id|fi
comma
l_int|0
comma
r_sizeof
(paren
op_star
id|fi
)paren
op_plus
id|nhs
op_star
r_sizeof
(paren
r_struct
id|fib_nh
)paren
)paren
suffix:semicolon
id|fi-&gt;fib_protocol
op_assign
id|r-&gt;rtm_protocol
suffix:semicolon
id|fi-&gt;fib_nhs
op_assign
id|nhs
suffix:semicolon
id|fi-&gt;fib_flags
op_assign
id|r-&gt;rtm_flags
suffix:semicolon
r_if
c_cond
(paren
id|rta-&gt;rta_priority
)paren
id|fi-&gt;fib_priority
op_assign
op_star
id|rta-&gt;rta_priority
suffix:semicolon
r_if
c_cond
(paren
id|rta-&gt;rta_mx
)paren
(brace
r_int
id|attrlen
op_assign
id|RTA_PAYLOAD
c_func
(paren
id|rta-&gt;rta_mx
)paren
suffix:semicolon
r_struct
id|rtattr
op_star
id|attr
op_assign
id|RTA_DATA
c_func
(paren
id|rta-&gt;rta_mx
)paren
suffix:semicolon
r_while
c_loop
(paren
id|RTA_OK
c_func
(paren
id|attr
comma
id|attrlen
)paren
)paren
(brace
r_int
id|flavor
op_assign
id|attr-&gt;rta_type
suffix:semicolon
r_if
c_cond
(paren
id|flavor
)paren
(brace
r_if
c_cond
(paren
id|flavor
OG
id|RTAX_MAX
)paren
r_goto
id|err_inval
suffix:semicolon
id|fi-&gt;fib_metrics
(braket
id|flavor
op_minus
l_int|1
)braket
op_assign
op_star
(paren
r_int
op_star
)paren
id|RTA_DATA
c_func
(paren
id|attr
)paren
suffix:semicolon
)brace
id|attr
op_assign
id|RTA_NEXT
c_func
(paren
id|attr
comma
id|attrlen
)paren
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|rta-&gt;rta_prefsrc
)paren
id|memcpy
c_func
(paren
op_amp
id|fi-&gt;fib_prefsrc
comma
id|rta-&gt;rta_prefsrc
comma
l_int|4
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rta-&gt;rta_mp
)paren
(brace
macro_line|#ifdef CONFIG_IP_ROUTE_MULTIPATH
r_if
c_cond
(paren
(paren
id|err
op_assign
id|fib_get_nhs
c_func
(paren
id|fi
comma
id|rta-&gt;rta_mp
comma
id|r
)paren
)paren
op_ne
l_int|0
)paren
r_goto
id|failure
suffix:semicolon
r_if
c_cond
(paren
id|rta-&gt;rta_oif
op_logical_and
id|fi-&gt;fib_nh-&gt;nh_oif
op_ne
op_star
id|rta-&gt;rta_oif
)paren
r_goto
id|err_inval
suffix:semicolon
r_if
c_cond
(paren
id|rta-&gt;rta_gw
op_logical_and
id|memcmp
c_func
(paren
op_amp
id|fi-&gt;fib_nh-&gt;nh_gw
comma
id|rta-&gt;rta_gw
comma
l_int|4
)paren
)paren
r_goto
id|err_inval
suffix:semicolon
macro_line|#ifdef CONFIG_NET_CLS_ROUTE
r_if
c_cond
(paren
id|rta-&gt;rta_flow
op_logical_and
id|memcmp
c_func
(paren
op_amp
id|fi-&gt;fib_nh-&gt;nh_tclassid
comma
id|rta-&gt;rta_flow
comma
l_int|4
)paren
)paren
r_goto
id|err_inval
suffix:semicolon
macro_line|#endif
macro_line|#else
r_goto
id|err_inval
suffix:semicolon
macro_line|#endif
)brace
r_else
(brace
r_struct
id|fib_nh
op_star
id|nh
op_assign
id|fi-&gt;fib_nh
suffix:semicolon
r_if
c_cond
(paren
id|rta-&gt;rta_oif
)paren
id|nh-&gt;nh_oif
op_assign
op_star
id|rta-&gt;rta_oif
suffix:semicolon
r_if
c_cond
(paren
id|rta-&gt;rta_gw
)paren
id|memcpy
c_func
(paren
op_amp
id|nh-&gt;nh_gw
comma
id|rta-&gt;rta_gw
comma
l_int|4
)paren
suffix:semicolon
macro_line|#ifdef CONFIG_NET_CLS_ROUTE
r_if
c_cond
(paren
id|rta-&gt;rta_flow
)paren
id|memcpy
c_func
(paren
op_amp
id|nh-&gt;nh_tclassid
comma
id|rta-&gt;rta_flow
comma
l_int|4
)paren
suffix:semicolon
macro_line|#endif
id|nh-&gt;nh_flags
op_assign
id|r-&gt;rtm_flags
suffix:semicolon
macro_line|#ifdef CONFIG_IP_ROUTE_MULTIPATH
id|nh-&gt;nh_weight
op_assign
l_int|1
suffix:semicolon
macro_line|#endif
)brace
macro_line|#ifdef CONFIG_IP_ROUTE_NAT
r_if
c_cond
(paren
id|r-&gt;rtm_type
op_eq
id|RTN_NAT
)paren
(brace
r_if
c_cond
(paren
id|rta-&gt;rta_gw
op_eq
l_int|NULL
op_logical_or
id|nhs
op_ne
l_int|1
op_logical_or
id|rta-&gt;rta_oif
)paren
r_goto
id|err_inval
suffix:semicolon
id|memcpy
c_func
(paren
op_amp
id|fi-&gt;fib_nh-&gt;nh_gw
comma
id|rta-&gt;rta_gw
comma
l_int|4
)paren
suffix:semicolon
r_goto
id|link_it
suffix:semicolon
)brace
macro_line|#endif
r_if
c_cond
(paren
id|fib_props
(braket
id|r-&gt;rtm_type
)braket
dot
id|error
)paren
(brace
r_if
c_cond
(paren
id|rta-&gt;rta_gw
op_logical_or
id|rta-&gt;rta_oif
op_logical_or
id|rta-&gt;rta_mp
)paren
r_goto
id|err_inval
suffix:semicolon
r_goto
id|link_it
suffix:semicolon
)brace
r_if
c_cond
(paren
id|r-&gt;rtm_scope
OG
id|RT_SCOPE_HOST
)paren
r_goto
id|err_inval
suffix:semicolon
r_if
c_cond
(paren
id|r-&gt;rtm_scope
op_eq
id|RT_SCOPE_HOST
)paren
(brace
r_struct
id|fib_nh
op_star
id|nh
op_assign
id|fi-&gt;fib_nh
suffix:semicolon
multiline_comment|/* Local address is added. */
r_if
c_cond
(paren
id|nhs
op_ne
l_int|1
op_logical_or
id|nh-&gt;nh_gw
)paren
r_goto
id|err_inval
suffix:semicolon
id|nh-&gt;nh_scope
op_assign
id|RT_SCOPE_NOWHERE
suffix:semicolon
id|nh-&gt;nh_dev
op_assign
id|dev_get_by_index
c_func
(paren
id|fi-&gt;fib_nh-&gt;nh_oif
)paren
suffix:semicolon
id|err
op_assign
op_minus
id|ENODEV
suffix:semicolon
r_if
c_cond
(paren
id|nh-&gt;nh_dev
op_eq
l_int|NULL
)paren
r_goto
id|failure
suffix:semicolon
)brace
r_else
(brace
id|change_nexthops
c_func
(paren
id|fi
)paren
(brace
r_if
c_cond
(paren
(paren
id|err
op_assign
id|fib_check_nh
c_func
(paren
id|r
comma
id|fi
comma
id|nh
)paren
)paren
op_ne
l_int|0
)paren
r_goto
id|failure
suffix:semicolon
)brace
id|endfor_nexthops
c_func
(paren
id|fi
)paren
)brace
r_if
c_cond
(paren
id|fi-&gt;fib_prefsrc
)paren
(brace
r_if
c_cond
(paren
id|r-&gt;rtm_type
op_ne
id|RTN_LOCAL
op_logical_or
id|rta-&gt;rta_dst
op_eq
l_int|NULL
op_logical_or
id|memcmp
c_func
(paren
op_amp
id|fi-&gt;fib_prefsrc
comma
id|rta-&gt;rta_dst
comma
l_int|4
)paren
)paren
r_if
c_cond
(paren
id|inet_addr_type
c_func
(paren
id|fi-&gt;fib_prefsrc
)paren
op_ne
id|RTN_LOCAL
)paren
r_goto
id|err_inval
suffix:semicolon
)brace
id|link_it
suffix:colon
r_if
c_cond
(paren
(paren
id|ofi
op_assign
id|fib_find_info
c_func
(paren
id|fi
)paren
)paren
op_ne
l_int|NULL
)paren
(brace
id|fi-&gt;fib_dead
op_assign
l_int|1
suffix:semicolon
id|free_fib_info
c_func
(paren
id|fi
)paren
suffix:semicolon
id|ofi-&gt;fib_treeref
op_increment
suffix:semicolon
r_return
id|ofi
suffix:semicolon
)brace
id|fi-&gt;fib_treeref
op_increment
suffix:semicolon
id|atomic_inc
c_func
(paren
op_amp
id|fi-&gt;fib_clntref
)paren
suffix:semicolon
id|write_lock
c_func
(paren
op_amp
id|fib_info_lock
)paren
suffix:semicolon
id|fi-&gt;fib_next
op_assign
id|fib_info_list
suffix:semicolon
id|fi-&gt;fib_prev
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
id|fib_info_list
)paren
id|fib_info_list-&gt;fib_prev
op_assign
id|fi
suffix:semicolon
id|fib_info_list
op_assign
id|fi
suffix:semicolon
id|write_unlock
c_func
(paren
op_amp
id|fib_info_lock
)paren
suffix:semicolon
r_return
id|fi
suffix:semicolon
id|err_inval
suffix:colon
id|err
op_assign
op_minus
id|EINVAL
suffix:semicolon
id|failure
suffix:colon
op_star
id|errp
op_assign
id|err
suffix:semicolon
r_if
c_cond
(paren
id|fi
)paren
(brace
id|fi-&gt;fib_dead
op_assign
l_int|1
suffix:semicolon
id|free_fib_info
c_func
(paren
id|fi
)paren
suffix:semicolon
)brace
r_return
l_int|NULL
suffix:semicolon
)brace
r_int
DECL|function|fib_semantic_match
id|fib_semantic_match
c_func
(paren
r_int
id|type
comma
r_struct
id|fib_info
op_star
id|fi
comma
r_const
r_struct
id|rt_key
op_star
id|key
comma
r_struct
id|fib_result
op_star
id|res
)paren
(brace
r_int
id|err
op_assign
id|fib_props
(braket
id|type
)braket
dot
id|error
suffix:semicolon
r_if
c_cond
(paren
id|err
op_eq
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|fi-&gt;fib_flags
op_amp
id|RTNH_F_DEAD
)paren
r_return
l_int|1
suffix:semicolon
id|res-&gt;fi
op_assign
id|fi
suffix:semicolon
r_switch
c_cond
(paren
id|type
)paren
(brace
macro_line|#ifdef CONFIG_IP_ROUTE_NAT
r_case
id|RTN_NAT
suffix:colon
id|FIB_RES_RESET
c_func
(paren
op_star
id|res
)paren
suffix:semicolon
id|atomic_inc
c_func
(paren
op_amp
id|fi-&gt;fib_clntref
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
macro_line|#endif
r_case
id|RTN_UNICAST
suffix:colon
r_case
id|RTN_LOCAL
suffix:colon
r_case
id|RTN_BROADCAST
suffix:colon
r_case
id|RTN_ANYCAST
suffix:colon
r_case
id|RTN_MULTICAST
suffix:colon
id|for_nexthops
c_func
(paren
id|fi
)paren
(brace
r_if
c_cond
(paren
id|nh-&gt;nh_flags
op_amp
id|RTNH_F_DEAD
)paren
r_continue
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|key-&gt;oif
op_logical_or
id|key-&gt;oif
op_eq
id|nh-&gt;nh_oif
)paren
r_break
suffix:semicolon
)brace
macro_line|#ifdef CONFIG_IP_ROUTE_MULTIPATH
r_if
c_cond
(paren
id|nhsel
OL
id|fi-&gt;fib_nhs
)paren
(brace
id|res-&gt;nh_sel
op_assign
id|nhsel
suffix:semicolon
id|atomic_inc
c_func
(paren
op_amp
id|fi-&gt;fib_clntref
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#else
r_if
c_cond
(paren
id|nhsel
OL
l_int|1
)paren
(brace
id|atomic_inc
c_func
(paren
op_amp
id|fi-&gt;fib_clntref
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#endif
id|endfor_nexthops
c_func
(paren
id|fi
)paren
suffix:semicolon
id|res-&gt;fi
op_assign
l_int|NULL
suffix:semicolon
r_return
l_int|1
suffix:semicolon
r_default
suffix:colon
id|res-&gt;fi
op_assign
l_int|NULL
suffix:semicolon
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;impossible 102&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
)brace
r_return
id|err
suffix:semicolon
)brace
multiline_comment|/* Find appropriate source address to this destination */
DECL|function|__fib_res_prefsrc
id|u32
id|__fib_res_prefsrc
c_func
(paren
r_struct
id|fib_result
op_star
id|res
)paren
(brace
r_return
id|inet_select_addr
c_func
(paren
id|FIB_RES_DEV
c_func
(paren
op_star
id|res
)paren
comma
id|FIB_RES_GW
c_func
(paren
op_star
id|res
)paren
comma
id|res-&gt;scope
)paren
suffix:semicolon
)brace
macro_line|#ifdef CONFIG_RTNETLINK
r_int
DECL|function|fib_dump_info
id|fib_dump_info
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
id|u32
id|pid
comma
id|u32
id|seq
comma
r_int
id|event
comma
id|u8
id|tb_id
comma
id|u8
id|type
comma
id|u8
id|scope
comma
r_void
op_star
id|dst
comma
r_int
id|dst_len
comma
id|u8
id|tos
comma
r_struct
id|fib_info
op_star
id|fi
)paren
(brace
r_struct
id|rtmsg
op_star
id|rtm
suffix:semicolon
r_struct
id|nlmsghdr
op_star
id|nlh
suffix:semicolon
r_int
r_char
op_star
id|b
op_assign
id|skb-&gt;tail
suffix:semicolon
id|nlh
op_assign
id|NLMSG_PUT
c_func
(paren
id|skb
comma
id|pid
comma
id|seq
comma
id|event
comma
r_sizeof
(paren
op_star
id|rtm
)paren
)paren
suffix:semicolon
id|rtm
op_assign
id|NLMSG_DATA
c_func
(paren
id|nlh
)paren
suffix:semicolon
id|rtm-&gt;rtm_family
op_assign
id|AF_INET
suffix:semicolon
id|rtm-&gt;rtm_dst_len
op_assign
id|dst_len
suffix:semicolon
id|rtm-&gt;rtm_src_len
op_assign
l_int|0
suffix:semicolon
id|rtm-&gt;rtm_tos
op_assign
id|tos
suffix:semicolon
id|rtm-&gt;rtm_table
op_assign
id|tb_id
suffix:semicolon
id|rtm-&gt;rtm_type
op_assign
id|type
suffix:semicolon
id|rtm-&gt;rtm_flags
op_assign
id|fi-&gt;fib_flags
suffix:semicolon
id|rtm-&gt;rtm_scope
op_assign
id|scope
suffix:semicolon
r_if
c_cond
(paren
id|rtm-&gt;rtm_dst_len
)paren
id|RTA_PUT
c_func
(paren
id|skb
comma
id|RTA_DST
comma
l_int|4
comma
id|dst
)paren
suffix:semicolon
id|rtm-&gt;rtm_protocol
op_assign
id|fi-&gt;fib_protocol
suffix:semicolon
r_if
c_cond
(paren
id|fi-&gt;fib_priority
)paren
id|RTA_PUT
c_func
(paren
id|skb
comma
id|RTA_PRIORITY
comma
l_int|4
comma
op_amp
id|fi-&gt;fib_priority
)paren
suffix:semicolon
macro_line|#ifdef CONFIG_NET_CLS_ROUTE
r_if
c_cond
(paren
id|fi-&gt;fib_nh
(braket
l_int|0
)braket
dot
id|nh_tclassid
)paren
id|RTA_PUT
c_func
(paren
id|skb
comma
id|RTA_FLOW
comma
l_int|4
comma
op_amp
id|fi-&gt;fib_nh
(braket
l_int|0
)braket
dot
id|nh_tclassid
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|rtnetlink_put_metrics
c_func
(paren
id|skb
comma
id|fi-&gt;fib_metrics
)paren
OL
l_int|0
)paren
r_goto
id|rtattr_failure
suffix:semicolon
r_if
c_cond
(paren
id|fi-&gt;fib_prefsrc
)paren
id|RTA_PUT
c_func
(paren
id|skb
comma
id|RTA_PREFSRC
comma
l_int|4
comma
op_amp
id|fi-&gt;fib_prefsrc
)paren
suffix:semicolon
r_if
c_cond
(paren
id|fi-&gt;fib_nhs
op_eq
l_int|1
)paren
(brace
r_if
c_cond
(paren
id|fi-&gt;fib_nh-&gt;nh_gw
)paren
id|RTA_PUT
c_func
(paren
id|skb
comma
id|RTA_GATEWAY
comma
l_int|4
comma
op_amp
id|fi-&gt;fib_nh-&gt;nh_gw
)paren
suffix:semicolon
r_if
c_cond
(paren
id|fi-&gt;fib_nh-&gt;nh_oif
)paren
id|RTA_PUT
c_func
(paren
id|skb
comma
id|RTA_OIF
comma
r_sizeof
(paren
r_int
)paren
comma
op_amp
id|fi-&gt;fib_nh-&gt;nh_oif
)paren
suffix:semicolon
)brace
macro_line|#ifdef CONFIG_IP_ROUTE_MULTIPATH
r_if
c_cond
(paren
id|fi-&gt;fib_nhs
OG
l_int|1
)paren
(brace
r_struct
id|rtnexthop
op_star
id|nhp
suffix:semicolon
r_struct
id|rtattr
op_star
id|mp_head
suffix:semicolon
r_if
c_cond
(paren
id|skb_tailroom
c_func
(paren
id|skb
)paren
op_le
id|RTA_SPACE
c_func
(paren
l_int|0
)paren
)paren
r_goto
id|rtattr_failure
suffix:semicolon
id|mp_head
op_assign
(paren
r_struct
id|rtattr
op_star
)paren
id|skb_put
c_func
(paren
id|skb
comma
id|RTA_SPACE
c_func
(paren
l_int|0
)paren
)paren
suffix:semicolon
id|for_nexthops
c_func
(paren
id|fi
)paren
(brace
r_if
c_cond
(paren
id|skb_tailroom
c_func
(paren
id|skb
)paren
OL
id|RTA_ALIGN
c_func
(paren
id|RTA_ALIGN
c_func
(paren
r_sizeof
(paren
op_star
id|nhp
)paren
)paren
op_plus
l_int|4
)paren
)paren
r_goto
id|rtattr_failure
suffix:semicolon
id|nhp
op_assign
(paren
r_struct
id|rtnexthop
op_star
)paren
id|skb_put
c_func
(paren
id|skb
comma
id|RTA_ALIGN
c_func
(paren
r_sizeof
(paren
op_star
id|nhp
)paren
)paren
)paren
suffix:semicolon
id|nhp-&gt;rtnh_flags
op_assign
id|nh-&gt;nh_flags
op_amp
l_int|0xFF
suffix:semicolon
id|nhp-&gt;rtnh_hops
op_assign
id|nh-&gt;nh_weight
op_minus
l_int|1
suffix:semicolon
id|nhp-&gt;rtnh_ifindex
op_assign
id|nh-&gt;nh_oif
suffix:semicolon
r_if
c_cond
(paren
id|nh-&gt;nh_gw
)paren
id|RTA_PUT
c_func
(paren
id|skb
comma
id|RTA_GATEWAY
comma
l_int|4
comma
op_amp
id|nh-&gt;nh_gw
)paren
suffix:semicolon
id|nhp-&gt;rtnh_len
op_assign
id|skb-&gt;tail
op_minus
(paren
r_int
r_char
op_star
)paren
id|nhp
suffix:semicolon
)brace
id|endfor_nexthops
c_func
(paren
id|fi
)paren
suffix:semicolon
id|mp_head-&gt;rta_type
op_assign
id|RTA_MULTIPATH
suffix:semicolon
id|mp_head-&gt;rta_len
op_assign
id|skb-&gt;tail
op_minus
(paren
id|u8
op_star
)paren
id|mp_head
suffix:semicolon
)brace
macro_line|#endif
id|nlh-&gt;nlmsg_len
op_assign
id|skb-&gt;tail
op_minus
id|b
suffix:semicolon
r_return
id|skb-&gt;len
suffix:semicolon
id|nlmsg_failure
suffix:colon
id|rtattr_failure
suffix:colon
id|skb_trim
c_func
(paren
id|skb
comma
id|b
op_minus
id|skb-&gt;data
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
macro_line|#endif /* CONFIG_RTNETLINK */
macro_line|#ifndef CONFIG_IP_NOSIOCRT
r_int
DECL|function|fib_convert_rtentry
id|fib_convert_rtentry
c_func
(paren
r_int
id|cmd
comma
r_struct
id|nlmsghdr
op_star
id|nl
comma
r_struct
id|rtmsg
op_star
id|rtm
comma
r_struct
id|kern_rta
op_star
id|rta
comma
r_struct
id|rtentry
op_star
id|r
)paren
(brace
r_int
id|plen
suffix:semicolon
id|u32
op_star
id|ptr
suffix:semicolon
id|memset
c_func
(paren
id|rtm
comma
l_int|0
comma
r_sizeof
(paren
op_star
id|rtm
)paren
)paren
suffix:semicolon
id|memset
c_func
(paren
id|rta
comma
l_int|0
comma
r_sizeof
(paren
op_star
id|rta
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|r-&gt;rt_dst.sa_family
op_ne
id|AF_INET
)paren
r_return
op_minus
id|EAFNOSUPPORT
suffix:semicolon
multiline_comment|/* Check mask for validity:&n;&t;   a) it must be contiguous.&n;&t;   b) destination must have all host bits clear.&n;&t;   c) if application forgot to set correct family (AF_INET),&n;&t;      reject request unless it is absolutely clear i.e.&n;&t;      both family and mask are zero.&n;&t; */
id|plen
op_assign
l_int|32
suffix:semicolon
id|ptr
op_assign
op_amp
(paren
(paren
r_struct
id|sockaddr_in
op_star
)paren
op_amp
id|r-&gt;rt_dst
)paren
op_member_access_from_pointer
id|sin_addr.s_addr
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|r-&gt;rt_flags
op_amp
id|RTF_HOST
)paren
)paren
(brace
id|u32
id|mask
op_assign
(paren
(paren
r_struct
id|sockaddr_in
op_star
)paren
op_amp
id|r-&gt;rt_genmask
)paren
op_member_access_from_pointer
id|sin_addr.s_addr
suffix:semicolon
r_if
c_cond
(paren
id|r-&gt;rt_genmask.sa_family
op_ne
id|AF_INET
)paren
(brace
r_if
c_cond
(paren
id|mask
op_logical_or
id|r-&gt;rt_genmask.sa_family
)paren
r_return
op_minus
id|EAFNOSUPPORT
suffix:semicolon
)brace
r_if
c_cond
(paren
id|bad_mask
c_func
(paren
id|mask
comma
op_star
id|ptr
)paren
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|plen
op_assign
id|inet_mask_len
c_func
(paren
id|mask
)paren
suffix:semicolon
)brace
id|nl-&gt;nlmsg_flags
op_assign
id|NLM_F_REQUEST
suffix:semicolon
id|nl-&gt;nlmsg_pid
op_assign
l_int|0
suffix:semicolon
id|nl-&gt;nlmsg_seq
op_assign
l_int|0
suffix:semicolon
id|nl-&gt;nlmsg_len
op_assign
id|NLMSG_LENGTH
c_func
(paren
r_sizeof
(paren
op_star
id|rtm
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cmd
op_eq
id|SIOCDELRT
)paren
(brace
id|nl-&gt;nlmsg_type
op_assign
id|RTM_DELROUTE
suffix:semicolon
id|nl-&gt;nlmsg_flags
op_assign
l_int|0
suffix:semicolon
)brace
r_else
(brace
id|nl-&gt;nlmsg_type
op_assign
id|RTM_NEWROUTE
suffix:semicolon
id|nl-&gt;nlmsg_flags
op_assign
id|NLM_F_REQUEST
op_or
id|NLM_F_CREATE
suffix:semicolon
id|rtm-&gt;rtm_protocol
op_assign
id|RTPROT_BOOT
suffix:semicolon
)brace
id|rtm-&gt;rtm_dst_len
op_assign
id|plen
suffix:semicolon
id|rta-&gt;rta_dst
op_assign
id|ptr
suffix:semicolon
r_if
c_cond
(paren
id|r-&gt;rt_metric
)paren
(brace
op_star
(paren
id|u32
op_star
)paren
op_amp
id|r-&gt;rt_pad3
op_assign
id|r-&gt;rt_metric
op_minus
l_int|1
suffix:semicolon
id|rta-&gt;rta_priority
op_assign
(paren
id|u32
op_star
)paren
op_amp
id|r-&gt;rt_pad3
suffix:semicolon
)brace
r_if
c_cond
(paren
id|r-&gt;rt_flags
op_amp
id|RTF_REJECT
)paren
(brace
id|rtm-&gt;rtm_scope
op_assign
id|RT_SCOPE_HOST
suffix:semicolon
id|rtm-&gt;rtm_type
op_assign
id|RTN_UNREACHABLE
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|rtm-&gt;rtm_scope
op_assign
id|RT_SCOPE_NOWHERE
suffix:semicolon
id|rtm-&gt;rtm_type
op_assign
id|RTN_UNICAST
suffix:semicolon
r_if
c_cond
(paren
id|r-&gt;rt_dev
)paren
(brace
r_char
op_star
id|colon
suffix:semicolon
r_struct
id|net_device
op_star
id|dev
suffix:semicolon
r_char
id|devname
(braket
id|IFNAMSIZ
)braket
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
id|devname
comma
id|r-&gt;rt_dev
comma
id|IFNAMSIZ
op_minus
l_int|1
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
id|devname
(braket
id|IFNAMSIZ
op_minus
l_int|1
)braket
op_assign
l_int|0
suffix:semicolon
id|colon
op_assign
id|strchr
c_func
(paren
id|devname
comma
l_char|&squot;:&squot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|colon
)paren
op_star
id|colon
op_assign
l_int|0
suffix:semicolon
id|dev
op_assign
id|__dev_get_by_name
c_func
(paren
id|devname
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dev
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
id|rta-&gt;rta_oif
op_assign
op_amp
id|dev-&gt;ifindex
suffix:semicolon
r_if
c_cond
(paren
id|colon
)paren
(brace
r_struct
id|in_ifaddr
op_star
id|ifa
suffix:semicolon
r_struct
id|in_device
op_star
id|in_dev
op_assign
id|__in_dev_get
c_func
(paren
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|in_dev
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
op_star
id|colon
op_assign
l_char|&squot;:&squot;
suffix:semicolon
r_for
c_loop
(paren
id|ifa
op_assign
id|in_dev-&gt;ifa_list
suffix:semicolon
id|ifa
suffix:semicolon
id|ifa
op_assign
id|ifa-&gt;ifa_next
)paren
r_if
c_cond
(paren
id|strcmp
c_func
(paren
id|ifa-&gt;ifa_label
comma
id|devname
)paren
op_eq
l_int|0
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
id|ifa
op_eq
l_int|NULL
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
id|rta-&gt;rta_prefsrc
op_assign
op_amp
id|ifa-&gt;ifa_local
suffix:semicolon
)brace
)brace
id|ptr
op_assign
op_amp
(paren
(paren
r_struct
id|sockaddr_in
op_star
)paren
op_amp
id|r-&gt;rt_gateway
)paren
op_member_access_from_pointer
id|sin_addr.s_addr
suffix:semicolon
r_if
c_cond
(paren
id|r-&gt;rt_gateway.sa_family
op_eq
id|AF_INET
op_logical_and
op_star
id|ptr
)paren
(brace
id|rta-&gt;rta_gw
op_assign
id|ptr
suffix:semicolon
r_if
c_cond
(paren
id|r-&gt;rt_flags
op_amp
id|RTF_GATEWAY
op_logical_and
id|inet_addr_type
c_func
(paren
op_star
id|ptr
)paren
op_eq
id|RTN_UNICAST
)paren
id|rtm-&gt;rtm_scope
op_assign
id|RT_SCOPE_UNIVERSE
suffix:semicolon
)brace
r_if
c_cond
(paren
id|cmd
op_eq
id|SIOCDELRT
)paren
r_return
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|r-&gt;rt_flags
op_amp
id|RTF_GATEWAY
op_logical_and
id|rta-&gt;rta_gw
op_eq
l_int|NULL
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|rtm-&gt;rtm_scope
op_eq
id|RT_SCOPE_NOWHERE
)paren
id|rtm-&gt;rtm_scope
op_assign
id|RT_SCOPE_LINK
suffix:semicolon
r_if
c_cond
(paren
id|r-&gt;rt_flags
op_amp
(paren
id|RTF_MTU
op_or
id|RTF_WINDOW
op_or
id|RTF_IRTT
)paren
)paren
(brace
r_struct
id|rtattr
op_star
id|rec
suffix:semicolon
r_struct
id|rtattr
op_star
id|mx
op_assign
id|kmalloc
c_func
(paren
id|RTA_LENGTH
c_func
(paren
l_int|3
op_star
id|RTA_LENGTH
c_func
(paren
l_int|4
)paren
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mx
op_eq
l_int|NULL
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|rta-&gt;rta_mx
op_assign
id|mx
suffix:semicolon
id|mx-&gt;rta_type
op_assign
id|RTA_METRICS
suffix:semicolon
id|mx-&gt;rta_len
op_assign
id|RTA_LENGTH
c_func
(paren
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|r-&gt;rt_flags
op_amp
id|RTF_MTU
)paren
(brace
id|rec
op_assign
(paren
r_void
op_star
)paren
(paren
(paren
r_char
op_star
)paren
id|mx
op_plus
id|RTA_ALIGN
c_func
(paren
id|mx-&gt;rta_len
)paren
)paren
suffix:semicolon
id|rec-&gt;rta_type
op_assign
id|RTAX_ADVMSS
suffix:semicolon
id|rec-&gt;rta_len
op_assign
id|RTA_LENGTH
c_func
(paren
l_int|4
)paren
suffix:semicolon
id|mx-&gt;rta_len
op_add_assign
id|RTA_LENGTH
c_func
(paren
l_int|4
)paren
suffix:semicolon
op_star
(paren
id|u32
op_star
)paren
id|RTA_DATA
c_func
(paren
id|rec
)paren
op_assign
id|r-&gt;rt_mtu
op_minus
l_int|40
suffix:semicolon
)brace
r_if
c_cond
(paren
id|r-&gt;rt_flags
op_amp
id|RTF_WINDOW
)paren
(brace
id|rec
op_assign
(paren
r_void
op_star
)paren
(paren
(paren
r_char
op_star
)paren
id|mx
op_plus
id|RTA_ALIGN
c_func
(paren
id|mx-&gt;rta_len
)paren
)paren
suffix:semicolon
id|rec-&gt;rta_type
op_assign
id|RTAX_WINDOW
suffix:semicolon
id|rec-&gt;rta_len
op_assign
id|RTA_LENGTH
c_func
(paren
l_int|4
)paren
suffix:semicolon
id|mx-&gt;rta_len
op_add_assign
id|RTA_LENGTH
c_func
(paren
l_int|4
)paren
suffix:semicolon
op_star
(paren
id|u32
op_star
)paren
id|RTA_DATA
c_func
(paren
id|rec
)paren
op_assign
id|r-&gt;rt_window
suffix:semicolon
)brace
r_if
c_cond
(paren
id|r-&gt;rt_flags
op_amp
id|RTF_IRTT
)paren
(brace
id|rec
op_assign
(paren
r_void
op_star
)paren
(paren
(paren
r_char
op_star
)paren
id|mx
op_plus
id|RTA_ALIGN
c_func
(paren
id|mx-&gt;rta_len
)paren
)paren
suffix:semicolon
id|rec-&gt;rta_type
op_assign
id|RTAX_RTT
suffix:semicolon
id|rec-&gt;rta_len
op_assign
id|RTA_LENGTH
c_func
(paren
l_int|4
)paren
suffix:semicolon
id|mx-&gt;rta_len
op_add_assign
id|RTA_LENGTH
c_func
(paren
l_int|4
)paren
suffix:semicolon
op_star
(paren
id|u32
op_star
)paren
id|RTA_DATA
c_func
(paren
id|rec
)paren
op_assign
id|r-&gt;rt_irtt
op_lshift
l_int|3
suffix:semicolon
)brace
)brace
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#endif
multiline_comment|/*&n;   Update FIB if:&n;   - local address disappeared -&gt; we must delete all the entries&n;     referring to it.&n;   - device went down -&gt; we must shutdown all nexthops going via it.&n; */
DECL|function|fib_sync_down
r_int
id|fib_sync_down
c_func
(paren
id|u32
id|local
comma
r_struct
id|net_device
op_star
id|dev
comma
r_int
id|force
)paren
(brace
r_int
id|ret
op_assign
l_int|0
suffix:semicolon
r_int
id|scope
op_assign
id|RT_SCOPE_NOWHERE
suffix:semicolon
r_if
c_cond
(paren
id|force
)paren
id|scope
op_assign
op_minus
l_int|1
suffix:semicolon
id|for_fib_info
c_func
(paren
)paren
(brace
r_if
c_cond
(paren
id|local
op_logical_and
id|fi-&gt;fib_prefsrc
op_eq
id|local
)paren
(brace
id|fi-&gt;fib_flags
op_or_assign
id|RTNH_F_DEAD
suffix:semicolon
id|ret
op_increment
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|dev
op_logical_and
id|fi-&gt;fib_nhs
)paren
(brace
r_int
id|dead
op_assign
l_int|0
suffix:semicolon
id|change_nexthops
c_func
(paren
id|fi
)paren
(brace
r_if
c_cond
(paren
id|nh-&gt;nh_flags
op_amp
id|RTNH_F_DEAD
)paren
id|dead
op_increment
suffix:semicolon
r_else
r_if
c_cond
(paren
id|nh-&gt;nh_dev
op_eq
id|dev
op_logical_and
id|nh-&gt;nh_scope
op_ne
id|scope
)paren
(brace
id|nh-&gt;nh_flags
op_or_assign
id|RTNH_F_DEAD
suffix:semicolon
macro_line|#ifdef CONFIG_IP_ROUTE_MULTIPATH
id|fi-&gt;fib_power
op_sub_assign
id|nh-&gt;nh_power
suffix:semicolon
id|nh-&gt;nh_power
op_assign
l_int|0
suffix:semicolon
macro_line|#endif
id|dead
op_increment
suffix:semicolon
)brace
)brace
id|endfor_nexthops
c_func
(paren
id|fi
)paren
r_if
c_cond
(paren
id|dead
op_eq
id|fi-&gt;fib_nhs
)paren
(brace
id|fi-&gt;fib_flags
op_or_assign
id|RTNH_F_DEAD
suffix:semicolon
id|ret
op_increment
suffix:semicolon
)brace
)brace
)brace
id|endfor_fib_info
c_func
(paren
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
macro_line|#ifdef CONFIG_IP_ROUTE_MULTIPATH
multiline_comment|/*&n;   Dead device goes up. We wake up dead nexthops.&n;   It takes sense only on multipath routes.&n; */
DECL|function|fib_sync_up
r_int
id|fib_sync_up
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_int
id|ret
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|dev-&gt;flags
op_amp
id|IFF_UP
)paren
)paren
r_return
l_int|0
suffix:semicolon
id|for_fib_info
c_func
(paren
)paren
(brace
r_int
id|alive
op_assign
l_int|0
suffix:semicolon
id|change_nexthops
c_func
(paren
id|fi
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|nh-&gt;nh_flags
op_amp
id|RTNH_F_DEAD
)paren
)paren
(brace
id|alive
op_increment
suffix:semicolon
r_continue
suffix:semicolon
)brace
r_if
c_cond
(paren
id|nh-&gt;nh_dev
op_eq
l_int|NULL
op_logical_or
op_logical_neg
(paren
id|nh-&gt;nh_dev-&gt;flags
op_amp
id|IFF_UP
)paren
)paren
r_continue
suffix:semicolon
r_if
c_cond
(paren
id|nh-&gt;nh_dev
op_ne
id|dev
op_logical_or
id|__in_dev_get
c_func
(paren
id|dev
)paren
op_eq
l_int|NULL
)paren
r_continue
suffix:semicolon
id|alive
op_increment
suffix:semicolon
id|nh-&gt;nh_power
op_assign
l_int|0
suffix:semicolon
id|nh-&gt;nh_flags
op_and_assign
op_complement
id|RTNH_F_DEAD
suffix:semicolon
)brace
id|endfor_nexthops
c_func
(paren
id|fi
)paren
r_if
c_cond
(paren
id|alive
OG
l_int|0
)paren
(brace
id|fi-&gt;fib_flags
op_and_assign
op_complement
id|RTNH_F_DEAD
suffix:semicolon
id|ret
op_increment
suffix:semicolon
)brace
)brace
id|endfor_fib_info
c_func
(paren
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
multiline_comment|/*&n;   The algorithm is suboptimal, but it provides really&n;   fair weighted route distribution.&n; */
DECL|function|fib_select_multipath
r_void
id|fib_select_multipath
c_func
(paren
r_const
r_struct
id|rt_key
op_star
id|key
comma
r_struct
id|fib_result
op_star
id|res
)paren
(brace
r_struct
id|fib_info
op_star
id|fi
op_assign
id|res-&gt;fi
suffix:semicolon
r_int
id|w
suffix:semicolon
r_if
c_cond
(paren
id|fi-&gt;fib_power
op_le
l_int|0
)paren
(brace
r_int
id|power
op_assign
l_int|0
suffix:semicolon
id|change_nexthops
c_func
(paren
id|fi
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|nh-&gt;nh_flags
op_amp
id|RTNH_F_DEAD
)paren
)paren
(brace
id|power
op_add_assign
id|nh-&gt;nh_weight
suffix:semicolon
id|nh-&gt;nh_power
op_assign
id|nh-&gt;nh_weight
suffix:semicolon
)brace
)brace
id|endfor_nexthops
c_func
(paren
id|fi
)paren
suffix:semicolon
id|fi-&gt;fib_power
op_assign
id|power
suffix:semicolon
macro_line|#if 1
r_if
c_cond
(paren
id|power
op_le
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_CRIT
l_string|&quot;impossible 777&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
macro_line|#endif
)brace
multiline_comment|/* w should be random number [0..fi-&gt;fib_power-1],&n;&t;   it is pretty bad approximation.&n;&t; */
id|w
op_assign
id|jiffies
op_mod
id|fi-&gt;fib_power
suffix:semicolon
id|change_nexthops
c_func
(paren
id|fi
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|nh-&gt;nh_flags
op_amp
id|RTNH_F_DEAD
)paren
op_logical_and
id|nh-&gt;nh_power
)paren
(brace
r_if
c_cond
(paren
(paren
id|w
op_sub_assign
id|nh-&gt;nh_power
)paren
op_le
l_int|0
)paren
(brace
id|nh-&gt;nh_power
op_decrement
suffix:semicolon
id|fi-&gt;fib_power
op_decrement
suffix:semicolon
id|res-&gt;nh_sel
op_assign
id|nhsel
suffix:semicolon
r_return
suffix:semicolon
)brace
)brace
)brace
id|endfor_nexthops
c_func
(paren
id|fi
)paren
suffix:semicolon
macro_line|#if 1
id|printk
c_func
(paren
id|KERN_CRIT
l_string|&quot;impossible 888&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
r_return
suffix:semicolon
)brace
macro_line|#endif
macro_line|#ifdef CONFIG_PROC_FS
DECL|function|fib_flag_trans
r_static
r_int
id|fib_flag_trans
c_func
(paren
r_int
id|type
comma
r_int
id|dead
comma
id|u32
id|mask
comma
r_struct
id|fib_info
op_star
id|fi
)paren
(brace
r_static
r_int
id|type2flags
(braket
id|RTN_MAX
op_plus
l_int|1
)braket
op_assign
(brace
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
id|RTF_REJECT
comma
id|RTF_REJECT
comma
l_int|0
comma
l_int|0
comma
l_int|0
)brace
suffix:semicolon
r_int
id|flags
op_assign
id|type2flags
(braket
id|type
)braket
suffix:semicolon
r_if
c_cond
(paren
id|fi
op_logical_and
id|fi-&gt;fib_nh-&gt;nh_gw
)paren
id|flags
op_or_assign
id|RTF_GATEWAY
suffix:semicolon
r_if
c_cond
(paren
id|mask
op_eq
l_int|0xFFFFFFFF
)paren
id|flags
op_or_assign
id|RTF_HOST
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dead
)paren
id|flags
op_or_assign
id|RTF_UP
suffix:semicolon
r_return
id|flags
suffix:semicolon
)brace
DECL|function|fib_node_get_info
r_void
id|fib_node_get_info
c_func
(paren
r_int
id|type
comma
r_int
id|dead
comma
r_struct
id|fib_info
op_star
id|fi
comma
id|u32
id|prefix
comma
id|u32
id|mask
comma
r_char
op_star
id|buffer
)paren
(brace
r_int
id|len
suffix:semicolon
r_int
id|flags
op_assign
id|fib_flag_trans
c_func
(paren
id|type
comma
id|dead
comma
id|mask
comma
id|fi
)paren
suffix:semicolon
r_if
c_cond
(paren
id|fi
)paren
(brace
id|len
op_assign
id|sprintf
c_func
(paren
id|buffer
comma
l_string|&quot;%s&bslash;t%08X&bslash;t%08X&bslash;t%04X&bslash;t%d&bslash;t%u&bslash;t%d&bslash;t%08X&bslash;t%d&bslash;t%u&bslash;t%u&quot;
comma
id|fi-&gt;fib_dev
ques
c_cond
id|fi-&gt;fib_dev-&gt;name
suffix:colon
l_string|&quot;*&quot;
comma
id|prefix
comma
id|fi-&gt;fib_nh-&gt;nh_gw
comma
id|flags
comma
l_int|0
comma
l_int|0
comma
id|fi-&gt;fib_priority
comma
id|mask
comma
id|fi-&gt;fib_advmss
op_plus
l_int|40
comma
id|fi-&gt;fib_window
comma
id|fi-&gt;fib_rtt
op_rshift
l_int|3
)paren
suffix:semicolon
)brace
r_else
(brace
id|len
op_assign
id|sprintf
c_func
(paren
id|buffer
comma
l_string|&quot;*&bslash;t%08X&bslash;t%08X&bslash;t%04X&bslash;t%d&bslash;t%u&bslash;t%d&bslash;t%08X&bslash;t%d&bslash;t%u&bslash;t%u&quot;
comma
id|prefix
comma
l_int|0
comma
id|flags
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
id|mask
comma
l_int|0
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
)brace
id|memset
c_func
(paren
id|buffer
op_plus
id|len
comma
l_char|&squot; &squot;
comma
l_int|127
op_minus
id|len
)paren
suffix:semicolon
id|buffer
(braket
l_int|127
)braket
op_assign
l_char|&squot;&bslash;n&squot;
suffix:semicolon
)brace
macro_line|#endif
eof
