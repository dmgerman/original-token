multiline_comment|/*&n; *&t;&t;IP_MASQ_RAUDIO  - Real Audio masquerading module&n; *&n; *&n; * Version:&t;@(#)$Id: ip_masq_raudio.c,v 1.3 1996/05/20 13:24:26 nigel Exp $&n; *&n; * Author:&t;Nigel Metheringham&n; *&t;&t;[strongly based on ftp module by Juan Jose Ciarlante &amp; Wouter Gadeyne]&n; *&t;&t;[Real Audio information taken from Progressive Networks firewall docs]&n; *&n; *&n; *&n; *&n; *&t;This program is free software; you can redistribute it and/or&n; *&t;modify it under the terms of the GNU General Public License&n; *&t;as published by the Free Software Foundation; either version&n; *&t;2 of the License, or (at your option) any later version.&n; *&n; *&n; * Limitations&n; *&t;The IP Masquerading proxies at present do not have access to a processed&n; *&t;data stream.  Hence for a protocol like the Real Audio control protocol,&n; *&t;which depends on knowing where you are in the data stream, you either&n; *&t;to keep a *lot* of state in your proxy, or you cheat and simplify the&n; *&t;problem [needless to say I did the latter].&n; *&n; *&t;This proxy only handles data in the first packet.  Everything else is&n; *&t;passed transparently.  This means it should work under all normal&n; *&t;circumstances, but it could be fooled by new data formats or a&n; *&t;malicious application!&n; *&n; *&t;At present the &quot;first packet&quot; is defined as a packet starting with&n; *&t;the protocol ID string - &quot;PNA&quot;.&n; *&t;When the link is up there appears to be enough control data &n; *&t;crossing the control link to keep it open even if a long audio&n; *&t;piece is playing.&n; *&t;&n; */
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;asm/system.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/skbuff.h&gt;
macro_line|#include &lt;linux/in.h&gt;
macro_line|#include &lt;linux/ip.h&gt;
macro_line|#include &lt;net/protocol.h&gt;
macro_line|#include &lt;net/tcp.h&gt;
macro_line|#include &lt;net/ip_masq.h&gt;
macro_line|#ifndef DEBUG_CONFIG_IP_MASQ_RAUDIO
DECL|macro|DEBUG_CONFIG_IP_MASQ_RAUDIO
mdefine_line|#define DEBUG_CONFIG_IP_MASQ_RAUDIO 0
macro_line|#endif
DECL|struct|raudio_priv_data
r_struct
id|raudio_priv_data
(brace
multiline_comment|/* Associated data connection - setup but not used at present */
DECL|member|data_conn
r_struct
id|ip_masq
op_star
id|data_conn
suffix:semicolon
multiline_comment|/* Have we seen and performed setup */
DECL|member|seen_start
r_int
id|seen_start
suffix:semicolon
)brace
suffix:semicolon
r_static
r_int
DECL|function|masq_raudio_init_1
id|masq_raudio_init_1
(paren
r_struct
id|ip_masq_app
op_star
id|mapp
comma
r_struct
id|ip_masq
op_star
id|ms
)paren
(brace
id|MOD_INC_USE_COUNT
suffix:semicolon
r_if
c_cond
(paren
(paren
id|ms-&gt;app_data
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|raudio_priv_data
)paren
comma
id|GFP_ATOMIC
)paren
)paren
op_eq
l_int|NULL
)paren
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;RealAudio: No memory for application data&bslash;n&quot;
)paren
suffix:semicolon
r_else
(brace
r_struct
id|raudio_priv_data
op_star
id|priv
op_assign
(paren
r_struct
id|raudio_priv_data
op_star
)paren
id|ms-&gt;app_data
suffix:semicolon
id|priv-&gt;seen_start
op_assign
l_int|0
suffix:semicolon
id|priv-&gt;data_conn
op_assign
l_int|NULL
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_int
DECL|function|masq_raudio_done_1
id|masq_raudio_done_1
(paren
r_struct
id|ip_masq_app
op_star
id|mapp
comma
r_struct
id|ip_masq
op_star
id|ms
)paren
(brace
id|MOD_DEC_USE_COUNT
suffix:semicolon
r_if
c_cond
(paren
id|ms-&gt;app_data
)paren
id|kfree_s
c_func
(paren
id|ms-&gt;app_data
comma
r_sizeof
(paren
r_struct
id|raudio_priv_data
)paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_int
DECL|function|masq_raudio_out
id|masq_raudio_out
(paren
r_struct
id|ip_masq_app
op_star
id|mapp
comma
r_struct
id|ip_masq
op_star
id|ms
comma
r_struct
id|sk_buff
op_star
op_star
id|skb_p
comma
r_struct
id|device
op_star
id|dev
)paren
(brace
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
r_struct
id|iphdr
op_star
id|iph
suffix:semicolon
r_struct
id|tcphdr
op_star
id|th
suffix:semicolon
r_char
op_star
id|p
comma
op_star
id|data
comma
op_star
id|data_limit
suffix:semicolon
r_struct
id|ip_masq
op_star
id|n_ms
suffix:semicolon
r_int
r_int
id|version
comma
id|msg_id
comma
id|msg_len
comma
id|udp_port
suffix:semicolon
r_struct
id|raudio_priv_data
op_star
id|priv
op_assign
(paren
r_struct
id|raudio_priv_data
op_star
)paren
id|ms-&gt;app_data
suffix:semicolon
multiline_comment|/* Everything running correctly already */
r_if
c_cond
(paren
id|priv
op_logical_and
id|priv-&gt;seen_start
)paren
r_return
l_int|0
suffix:semicolon
id|skb
op_assign
op_star
id|skb_p
suffix:semicolon
id|iph
op_assign
id|skb-&gt;nh.iph
suffix:semicolon
id|th
op_assign
(paren
r_struct
id|tcphdr
op_star
)paren
op_amp
(paren
(paren
(paren
r_char
op_star
)paren
id|iph
)paren
(braket
id|iph-&gt;ihl
op_star
l_int|4
)braket
)paren
suffix:semicolon
id|data
op_assign
(paren
r_char
op_star
)paren
op_amp
id|th
(braket
l_int|1
)braket
suffix:semicolon
id|data_limit
op_assign
id|skb-&gt;h.raw
op_plus
id|skb-&gt;len
op_minus
l_int|18
suffix:semicolon
multiline_comment|/* Check to see if this is the first packet with protocol ID */
r_if
c_cond
(paren
id|memcmp
c_func
(paren
id|data
comma
l_string|&quot;PNA&quot;
comma
l_int|3
)paren
)paren
(brace
macro_line|#if DEBUG_CONFIG_IP_MASQ_RAUDIO
id|printk
c_func
(paren
l_string|&quot;RealAudio: not initial protocol packet - ignored&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
r_return
l_int|0
suffix:semicolon
)brace
id|data
op_add_assign
l_int|3
suffix:semicolon
id|memcpy
c_func
(paren
op_amp
id|version
comma
id|data
comma
l_int|2
)paren
suffix:semicolon
macro_line|#if DEBUG_CONFIG_IP_MASQ_RAUDIO
id|printk
c_func
(paren
l_string|&quot;RealAudio: initial seen - protocol version %d&bslash;n&quot;
comma
id|ntohs
c_func
(paren
id|version
)paren
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|priv
)paren
id|priv-&gt;seen_start
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|ntohs
c_func
(paren
id|version
)paren
op_ge
l_int|256
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;RealAudio: version (%d) not supported&bslash;n&quot;
comma
id|ntohs
c_func
(paren
id|version
)paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|data
op_add_assign
l_int|2
suffix:semicolon
r_while
c_loop
(paren
id|data
OL
id|data_limit
)paren
(brace
id|memcpy
c_func
(paren
op_amp
id|msg_id
comma
id|data
comma
l_int|2
)paren
suffix:semicolon
id|data
op_add_assign
l_int|2
suffix:semicolon
id|memcpy
c_func
(paren
op_amp
id|msg_len
comma
id|data
comma
l_int|2
)paren
suffix:semicolon
id|data
op_add_assign
l_int|2
suffix:semicolon
macro_line|#if DEBUG_CONFIG_IP_MASQ_RAUDIO
id|printk
c_func
(paren
l_string|&quot;RealAudio: msg %d - %d byte&bslash;n&quot;
comma
id|ntohs
c_func
(paren
id|msg_id
)paren
comma
id|ntohs
c_func
(paren
id|msg_len
)paren
)paren
suffix:semicolon
macro_line|#endif
id|p
op_assign
id|data
suffix:semicolon
id|data
op_add_assign
id|ntohs
c_func
(paren
id|msg_len
)paren
suffix:semicolon
r_if
c_cond
(paren
id|data
OG
id|data_limit
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;RealAudio: Packet too short for data&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ntohs
c_func
(paren
id|msg_id
)paren
op_eq
l_int|1
)paren
(brace
multiline_comment|/* This is a message detailing the UDP port to be used */
id|memcpy
c_func
(paren
op_amp
id|udp_port
comma
id|p
comma
l_int|2
)paren
suffix:semicolon
id|n_ms
op_assign
id|ip_masq_new
c_func
(paren
id|dev
comma
id|IPPROTO_UDP
comma
id|ms-&gt;saddr
comma
id|udp_port
comma
id|ms-&gt;daddr
comma
l_int|0
comma
id|IP_MASQ_F_NO_DPORT
)paren
suffix:semicolon
r_if
c_cond
(paren
id|n_ms
op_eq
l_int|NULL
)paren
r_return
l_int|0
suffix:semicolon
id|memcpy
c_func
(paren
id|p
comma
op_amp
(paren
id|n_ms-&gt;mport
)paren
comma
l_int|2
)paren
suffix:semicolon
macro_line|#if DEBUG_CONFIG_IP_MASQ_RAUDIO
id|printk
c_func
(paren
l_string|&quot;RealAudio: rewrote UDP port %d -&gt; %d&bslash;n&quot;
comma
id|ntohs
c_func
(paren
id|udp_port
)paren
comma
id|ntohs
c_func
(paren
id|n_ms-&gt;mport
)paren
)paren
suffix:semicolon
macro_line|#endif
id|ip_masq_set_expire
c_func
(paren
id|n_ms
comma
id|ip_masq_expire-&gt;udp_timeout
)paren
suffix:semicolon
multiline_comment|/* Make ref in application data to data connection */
r_if
c_cond
(paren
id|priv
)paren
id|priv-&gt;data_conn
op_assign
id|n_ms
suffix:semicolon
multiline_comment|/* &n;&t;&t;&t; * There is nothing else useful we can do&n;&t;&t;&t; * Maybe a development could do more, but for now&n;&t;&t;&t; * we exit gracefully!&n;&t;&t;&t; */
r_return
l_int|0
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|ntohs
c_func
(paren
id|msg_id
)paren
op_eq
l_int|0
)paren
r_return
l_int|0
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|variable|ip_masq_raudio
r_struct
id|ip_masq_app
id|ip_masq_raudio
op_assign
(brace
l_int|NULL
comma
multiline_comment|/* next */
l_string|&quot;RealAudio&quot;
comma
multiline_comment|/* name */
l_int|0
comma
multiline_comment|/* type */
l_int|0
comma
multiline_comment|/* n_attach */
id|masq_raudio_init_1
comma
multiline_comment|/* ip_masq_init_1 */
id|masq_raudio_done_1
comma
multiline_comment|/* ip_masq_done_1 */
id|masq_raudio_out
comma
multiline_comment|/* pkt_out */
l_int|NULL
multiline_comment|/* pkt_in */
)brace
suffix:semicolon
multiline_comment|/*&n; * &t;ip_masq_raudio initialization&n; */
DECL|function|ip_masq_raudio_init
r_int
id|ip_masq_raudio_init
c_func
(paren
r_void
)paren
(brace
r_return
id|register_ip_masq_app
c_func
(paren
op_amp
id|ip_masq_raudio
comma
id|IPPROTO_TCP
comma
l_int|7070
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * &t;ip_masq_raudio fin.&n; */
DECL|function|ip_masq_raudio_done
r_int
id|ip_masq_raudio_done
c_func
(paren
r_void
)paren
(brace
r_return
id|unregister_ip_masq_app
c_func
(paren
op_amp
id|ip_masq_raudio
)paren
suffix:semicolon
)brace
macro_line|#ifdef MODULE
DECL|function|init_module
r_int
id|init_module
c_func
(paren
r_void
)paren
(brace
r_if
c_cond
(paren
id|ip_masq_raudio_init
c_func
(paren
)paren
op_ne
l_int|0
)paren
r_return
op_minus
id|EIO
suffix:semicolon
id|register_symtab
c_func
(paren
l_int|0
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|cleanup_module
r_void
id|cleanup_module
c_func
(paren
r_void
)paren
(brace
r_if
c_cond
(paren
id|ip_masq_raudio_done
c_func
(paren
)paren
op_ne
l_int|0
)paren
id|printk
c_func
(paren
l_string|&quot;ip_masq_raudio: can&squot;t remove module&quot;
)paren
suffix:semicolon
)brace
macro_line|#endif /* MODULE */
eof
