multiline_comment|/*&n; *&t;IP firewalling code. This is taken from 4.4BSD. Please note the &n; *&t;copyright message below. As per the GPL it must be maintained&n; *&t;and the licenses thus do not conflict. While this port is subject&n; *&t;to the GPL I also place my modifications under the original &n; *&t;license in recognition of the original copyright. &n; *&t;&t;&t;&t;-- Alan Cox.&n; *&n; *&t;Ported from BSD to Linux,&n; *&t;&t;Alan Cox 22/Nov/1994.&n; *&t;Zeroing /proc and other additions&n; *&t;&t;Jos Vos 4/Feb/1995.&n; *&t;Merged and included the FreeBSD-Current changes at Ugen&squot;s request&n; *&t;(but hey it&squot;s a lot cleaner now). Ugen would prefer in some ways&n; *&t;we waited for his final product but since Linux 1.2.0 is about to&n; *&t;appear it&squot;s not practical - Read: It works, it&squot;s not clean but please&n; *&t;don&squot;t consider it to be his standard of finished work.&n; *&t;&t;Alan Cox 12/Feb/1995&n; *&t;Porting bidirectional entries from BSD, fixing accounting issues,&n; *&t;adding struct ip_fwpkt for checking packets with interface address&n; *&t;&t;Jos Vos 5/Mar/1995.&n; *&t;Established connections (ACK check), ACK check on bidirectional rules,&n; *&t;ICMP type check.&n; *&t;&t;Wilfred Mollenvanger 7/7/1995.&n; *&n; * Masquerading functionality&n; *&n; * Copyright (c) 1994 Pauline Middelink&n; *&n; * The pieces which added masquerading functionality are totaly&n; * my responsibility and have nothing to with the original authors&n; * copyright or doing.&n; *&n; * Parts distributed under GPL.&n; *&n; * Fixes:&n; *&t;Pauline Middelink&t;:&t;Added masquerading.&n; *&t;Alan Cox&t;&t;:&t;Fixed an error in the merge.&n; *&n; *&t;All the real work was done by .....&n; *&n; */
multiline_comment|/*&n; * Copyright (c) 1993 Daniel Boulet&n; * Copyright (c) 1994 Ugen J.S.Antsilevich&n; *&n; * Redistribution and use in source forms, with and without modification,&n; * are permitted provided that this entire comment appears intact.&n; *&n; * Redistribution in binary form may occur without any restrictions.&n; * Obviously, it would be nice if you gave credit where credit is due&n; * but requiring it would be too onerous.&n; *&n; * This software is provided ``AS IS&squot;&squot; without any warranties of any kind.&n; */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;asm/segment.h&gt;
macro_line|#include &lt;asm/system.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/socket.h&gt;
macro_line|#include &lt;linux/sockios.h&gt;
macro_line|#include &lt;linux/in.h&gt;
macro_line|#include &lt;linux/inet.h&gt;
macro_line|#include &lt;linux/netdevice.h&gt;
macro_line|#include &lt;linux/icmp.h&gt;
macro_line|#include &lt;linux/udp.h&gt;
macro_line|#include &lt;net/ip.h&gt;
macro_line|#include &lt;net/protocol.h&gt;
macro_line|#include &lt;net/route.h&gt;
macro_line|#include &lt;net/tcp.h&gt;
macro_line|#include &lt;net/udp.h&gt;
macro_line|#include &lt;linux/skbuff.h&gt;
macro_line|#include &lt;net/sock.h&gt;
macro_line|#include &lt;net/icmp.h&gt;
macro_line|#include &lt;linux/ip_fw.h&gt;
macro_line|#include &lt;net/checksum.h&gt;
macro_line|#include &lt;linux/proc_fs.h&gt;
multiline_comment|/*&n; *&t;Implement IP packet firewall&n; */
macro_line|#ifdef CONFIG_IPFIREWALL_DEBUG 
DECL|macro|dprintf1
mdefine_line|#define dprintf1(a)&t;&t;printk(a)
DECL|macro|dprintf2
mdefine_line|#define dprintf2(a1,a2)&t;&t;printk(a1,a2)
DECL|macro|dprintf3
mdefine_line|#define dprintf3(a1,a2,a3)&t;printk(a1,a2,a3)
DECL|macro|dprintf4
mdefine_line|#define dprintf4(a1,a2,a3,a4)&t;printk(a1,a2,a3,a4)
macro_line|#else
DECL|macro|dprintf1
mdefine_line|#define dprintf1(a)&t;
DECL|macro|dprintf2
mdefine_line|#define dprintf2(a1,a2)
DECL|macro|dprintf3
mdefine_line|#define dprintf3(a1,a2,a3)
DECL|macro|dprintf4
mdefine_line|#define dprintf4(a1,a2,a3,a4)
macro_line|#endif
DECL|macro|print_ip
mdefine_line|#define print_ip(a)&t; printk(&quot;%ld.%ld.%ld.%ld&quot;,(ntohl(a)&gt;&gt;24)&amp;0xFF,&bslash;&n;&t;&t;&t;&t;&t;      (ntohl(a)&gt;&gt;16)&amp;0xFF,&bslash;&n;&t;&t;&t;&t;&t;      (ntohl(a)&gt;&gt;8)&amp;0xFF,&bslash;&n;&t;&t;&t;&t;&t;      (ntohl(a))&amp;0xFF);
macro_line|#ifdef IPFIREWALL_DEBUG
DECL|macro|dprint_ip
mdefine_line|#define dprint_ip(a)&t;print_ip(a)
macro_line|#else
DECL|macro|dprint_ip
mdefine_line|#define dprint_ip(a)&t;
macro_line|#endif
macro_line|#ifdef CONFIG_IP_FIREWALL
DECL|variable|ip_fw_fwd_chain
r_struct
id|ip_fw
op_star
id|ip_fw_fwd_chain
suffix:semicolon
DECL|variable|ip_fw_blk_chain
r_struct
id|ip_fw
op_star
id|ip_fw_blk_chain
suffix:semicolon
DECL|variable|ip_fw_blk_policy
r_int
id|ip_fw_blk_policy
op_assign
id|IP_FW_F_ACCEPT
suffix:semicolon
DECL|variable|ip_fw_fwd_policy
r_int
id|ip_fw_fwd_policy
op_assign
id|IP_FW_F_ACCEPT
suffix:semicolon
macro_line|#endif
macro_line|#ifdef CONFIG_IP_ACCT
DECL|variable|ip_acct_chain
r_struct
id|ip_fw
op_star
id|ip_acct_chain
suffix:semicolon
macro_line|#endif
DECL|macro|IP_INFO_BLK
mdefine_line|#define IP_INFO_BLK&t;0
DECL|macro|IP_INFO_FWD
mdefine_line|#define IP_INFO_FWD&t;1
DECL|macro|IP_INFO_ACCT
mdefine_line|#define IP_INFO_ACCT&t;2
macro_line|#ifdef CONFIG_IP_MASQUERADE
multiline_comment|/*&n; *&t;Implement IP packet masquerading&n; */
DECL|variable|masq_port
r_static
r_int
r_int
id|masq_port
op_assign
id|PORT_MASQ_BEGIN
suffix:semicolon
DECL|variable|strProt
r_static
r_const
r_char
op_star
id|strProt
(braket
)braket
op_assign
(brace
l_string|&quot;UDP&quot;
comma
l_string|&quot;TCP&quot;
)brace
suffix:semicolon
DECL|variable|ip_msq_hosts
r_struct
id|ip_masq
op_star
id|ip_msq_hosts
suffix:semicolon
macro_line|#endif
multiline_comment|/*&n; *&t;Returns 1 if the port is matched by the vector, 0 otherwise&n; */
DECL|function|port_match
r_extern
r_inline
r_int
id|port_match
c_func
(paren
r_int
r_int
op_star
id|portptr
comma
r_int
id|nports
comma
r_int
r_int
id|port
comma
r_int
id|range_flag
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|nports
)paren
r_return
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|range_flag
)paren
(brace
r_if
c_cond
(paren
id|portptr
(braket
l_int|0
)braket
op_le
id|port
op_logical_and
id|port
op_le
id|portptr
(braket
l_int|1
)braket
)paren
(brace
r_return
l_int|1
suffix:semicolon
)brace
id|nports
op_sub_assign
l_int|2
suffix:semicolon
id|portptr
op_add_assign
l_int|2
suffix:semicolon
)brace
r_while
c_loop
(paren
id|nports
op_decrement
OG
l_int|0
)paren
(brace
r_if
c_cond
(paren
op_star
id|portptr
op_increment
op_eq
id|port
)paren
(brace
r_return
l_int|1
suffix:semicolon
)brace
)brace
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#if defined(CONFIG_IP_ACCT) || defined(CONFIG_IP_FIREWALL)
multiline_comment|/*&n; *&t;Returns 0 if packet should be dropped, 1 if it should be accepted,&n; *&t;and -1 if an ICMP host unreachable packet should be sent.&n; *&t;Also does accounting so you can feed it the accounting chain.&n; *&t;If opt is set to 1, it means that we do this for accounting&n; *&t;purposes (searches all entries and handles fragments different).&n; *&t;If opt is set to 2, it doesn&squot;t count a matching packet, which&n; *&t;is used when calling this for checking purposes (IP_FW_CHK_*).&n; */
DECL|function|ip_fw_chk
r_int
id|ip_fw_chk
c_func
(paren
r_struct
id|iphdr
op_star
id|ip
comma
r_struct
id|device
op_star
id|rif
comma
r_struct
id|ip_fw
op_star
id|chain
comma
r_int
id|policy
comma
r_int
id|opt
)paren
(brace
r_struct
id|ip_fw
op_star
id|f
suffix:semicolon
r_struct
id|tcphdr
op_star
id|tcp
op_assign
(paren
r_struct
id|tcphdr
op_star
)paren
(paren
(paren
r_int
r_int
op_star
)paren
id|ip
op_plus
id|ip-&gt;ihl
)paren
suffix:semicolon
r_struct
id|udphdr
op_star
id|udp
op_assign
(paren
r_struct
id|udphdr
op_star
)paren
(paren
(paren
r_int
r_int
op_star
)paren
id|ip
op_plus
id|ip-&gt;ihl
)paren
suffix:semicolon
r_struct
id|icmphdr
op_star
id|icmp
op_assign
(paren
r_struct
id|icmphdr
op_star
)paren
(paren
(paren
r_int
r_int
op_star
)paren
id|ip
op_plus
id|ip-&gt;ihl
)paren
suffix:semicolon
id|__u32
id|src
comma
id|dst
suffix:semicolon
id|__u16
id|src_port
op_assign
l_int|0
comma
id|dst_port
op_assign
l_int|0
comma
id|icmp_type
op_assign
l_int|0
suffix:semicolon
r_int
r_int
id|f_prt
op_assign
l_int|0
comma
id|prt
suffix:semicolon
r_char
id|notcpsyn
op_assign
l_int|1
comma
id|notcpack
op_assign
l_int|1
comma
id|frag1
comma
id|match
suffix:semicolon
r_int
r_int
id|f_flag
suffix:semicolon
multiline_comment|/*&n;&t; *&t;If the chain is empty follow policy. The BSD one&n;&t; *&t;accepts anything giving you a time window while&n;&t; *&t;flushing and rebuilding the tables.&n;&t; */
id|src
op_assign
id|ip-&gt;saddr
suffix:semicolon
id|dst
op_assign
id|ip-&gt;daddr
suffix:semicolon
multiline_comment|/* &n;&t; *&t;This way we handle fragmented packets.&n;&t; *&t;we ignore all fragments but the first one&n;&t; *&t;so the whole packet can&squot;t be reassembled.&n;&t; *&t;This way we relay on the full info which&n;&t; *&t;stored only in first packet.&n;&t; *&n;&t; *&t;Note that this theoretically allows partial packet&n;&t; *&t;spoofing. Not very dangerous but paranoid people may&n;&t; *&t;wish to play with this. It also allows the so called&n;&t; *&t;&quot;fragment bomb&quot; denial of service attack on some types&n;&t; *&t;of system.&n;&t; */
id|frag1
op_assign
(paren
(paren
id|ntohs
c_func
(paren
id|ip-&gt;frag_off
)paren
op_amp
id|IP_OFFSET
)paren
op_eq
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|frag1
op_logical_and
(paren
id|opt
op_ne
l_int|1
)paren
op_logical_and
(paren
id|ip-&gt;protocol
op_eq
id|IPPROTO_TCP
op_logical_or
id|ip-&gt;protocol
op_eq
id|IPPROTO_UDP
)paren
)paren
r_return
l_int|1
suffix:semicolon
id|src
op_assign
id|ip-&gt;saddr
suffix:semicolon
id|dst
op_assign
id|ip-&gt;daddr
suffix:semicolon
multiline_comment|/*&n;&t; *&t;If we got interface from which packet came&n;&t; *&t;we can use the address directly. This is unlike&n;&t; *&t;4.4BSD derived systems that have an address chain&n;&t; *&t;per device. We have a device per address with dummy&n;&t; *&t;devices instead.&n;&t; */
id|dprintf1
c_func
(paren
l_string|&quot;Packet &quot;
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|ip-&gt;protocol
)paren
(brace
r_case
id|IPPROTO_TCP
suffix:colon
id|dprintf1
c_func
(paren
l_string|&quot;TCP &quot;
)paren
suffix:semicolon
multiline_comment|/* ports stay 0 if it is not the first fragment */
r_if
c_cond
(paren
id|frag1
)paren
(brace
id|src_port
op_assign
id|ntohs
c_func
(paren
id|tcp-&gt;source
)paren
suffix:semicolon
id|dst_port
op_assign
id|ntohs
c_func
(paren
id|tcp-&gt;dest
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tcp-&gt;ack
)paren
(brace
multiline_comment|/* We *DO* have ACK, value FALSE */
id|notcpack
op_assign
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|tcp-&gt;syn
op_logical_and
id|notcpack
)paren
(brace
multiline_comment|/* We *DO* have SYN, value FALSE */
id|notcpsyn
op_assign
l_int|0
suffix:semicolon
)brace
)brace
id|prt
op_assign
id|IP_FW_F_TCP
suffix:semicolon
r_break
suffix:semicolon
r_case
id|IPPROTO_UDP
suffix:colon
id|dprintf1
c_func
(paren
l_string|&quot;UDP &quot;
)paren
suffix:semicolon
multiline_comment|/* ports stay 0 if it is not the first fragment */
r_if
c_cond
(paren
id|frag1
)paren
(brace
id|src_port
op_assign
id|ntohs
c_func
(paren
id|udp-&gt;source
)paren
suffix:semicolon
id|dst_port
op_assign
id|ntohs
c_func
(paren
id|udp-&gt;dest
)paren
suffix:semicolon
)brace
id|prt
op_assign
id|IP_FW_F_UDP
suffix:semicolon
r_break
suffix:semicolon
r_case
id|IPPROTO_ICMP
suffix:colon
id|icmp_type
op_assign
(paren
id|__u16
)paren
(paren
id|icmp-&gt;type
)paren
suffix:semicolon
id|dprintf2
c_func
(paren
l_string|&quot;ICMP:%d &quot;
comma
id|icmp_type
)paren
suffix:semicolon
id|prt
op_assign
id|IP_FW_F_ICMP
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|dprintf2
c_func
(paren
l_string|&quot;p=%d &quot;
comma
id|ip-&gt;protocol
)paren
suffix:semicolon
id|prt
op_assign
id|IP_FW_F_ALL
suffix:semicolon
r_break
suffix:semicolon
)brace
macro_line|#ifdef CONFIG_IP_FIREWALL_DEBUG
id|dprint_ip
c_func
(paren
id|ip-&gt;saddr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ip-&gt;protocol
op_eq
id|IPPROTO_TCP
op_logical_or
id|ip-&gt;protocol
op_eq
id|IPPROTO_UDP
)paren
multiline_comment|/* This will print 0 when it is not the first fragment! */
id|dprintf2
c_func
(paren
l_string|&quot;:%d &quot;
comma
id|src_port
)paren
suffix:semicolon
id|dprint_ip
c_func
(paren
id|ip-&gt;daddr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ip-&gt;protocol
op_eq
id|IPPROTO_TCP
op_logical_or
id|ip-&gt;protocol
op_eq
id|IPPROTO_UDP
)paren
multiline_comment|/* This will print 0 when it is not the first fragment! */
id|dprintf2
c_func
(paren
l_string|&quot;:%d &quot;
comma
id|dst_port
)paren
suffix:semicolon
id|dprintf1
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif&t;
r_for
c_loop
(paren
id|f
op_assign
id|chain
suffix:semicolon
id|f
suffix:semicolon
id|f
op_assign
id|f-&gt;fw_next
)paren
(brace
multiline_comment|/*&n;&t;&t; *&t;This is a bit simpler as we don&squot;t have to walk&n;&t;&t; *&t;an interface chain as you do in BSD - same logic&n;&t;&t; *&t;however.&n;&t;&t; */
multiline_comment|/*&n;&t;&t; *&t;Match can become 0x01 (a &quot;normal&quot; match was found),&n;&t;&t; *&t;0x02 (a reverse match was found), and 0x03 (the&n;&t;&t; *&t;IP addresses match in both directions).&n;&t;&t; *&t;Now we know in which direction(s) we should look&n;&t;&t; *&t;for a match for the TCP/UDP ports.  Both directions&n;&t;&t; *&t;might match (e.g., when both addresses are on the&n;&t;&t; *&t;same network for which an address/mask is given), but&n;&t;&t; *&t;the ports might only match in one direction.&n;&t;&t; *&t;This was obviously wrong in the original BSD code.&n;&t;&t; */
id|match
op_assign
l_int|0x00
suffix:semicolon
r_if
c_cond
(paren
(paren
id|src
op_amp
id|f-&gt;fw_smsk.s_addr
)paren
op_eq
id|f-&gt;fw_src.s_addr
op_logical_and
(paren
id|dst
op_amp
id|f-&gt;fw_dmsk.s_addr
)paren
op_eq
id|f-&gt;fw_dst.s_addr
)paren
multiline_comment|/* normal direction */
id|match
op_or_assign
l_int|0x01
suffix:semicolon
r_if
c_cond
(paren
(paren
id|f-&gt;fw_flg
op_amp
id|IP_FW_F_BIDIR
)paren
op_logical_and
(paren
id|dst
op_amp
id|f-&gt;fw_smsk.s_addr
)paren
op_eq
id|f-&gt;fw_src.s_addr
op_logical_and
(paren
id|src
op_amp
id|f-&gt;fw_dmsk.s_addr
)paren
op_eq
id|f-&gt;fw_dst.s_addr
)paren
multiline_comment|/* reverse direction */
id|match
op_or_assign
l_int|0x02
suffix:semicolon
r_if
c_cond
(paren
id|match
)paren
(brace
multiline_comment|/*&n;&t;&t;&t; *&t;Look for a VIA match &n;&t;&t;&t; */
r_if
c_cond
(paren
id|f-&gt;fw_via.s_addr
op_logical_and
id|rif
)paren
(brace
r_if
c_cond
(paren
id|rif-&gt;pa_addr
op_ne
id|f-&gt;fw_via.s_addr
)paren
(brace
r_continue
suffix:semicolon
)brace
multiline_comment|/* Mismatch */
)brace
multiline_comment|/*&n;&t;&t;&t; *&t;Drop through - this is a match&n;&t;&t;&t; */
)brace
r_else
r_continue
suffix:semicolon
multiline_comment|/*&n;&t;&t; *&t;Ok the chain addresses match.&n;&t;&t; */
id|f_prt
op_assign
id|f-&gt;fw_flg
op_amp
id|IP_FW_F_KIND
suffix:semicolon
r_if
c_cond
(paren
id|f_prt
op_ne
id|IP_FW_F_ALL
)paren
(brace
multiline_comment|/*&n;&t;&t;&t; * This is actually buggy as if you set SYN flag &n;&t;&t;&t; * on UDP or ICMP firewall it will never work,but &n;&t;&t;&t; * actually it is a concern of software which sets&n;&t;&t;&t; * firewall entries.&n;&t;&t;&t; */
r_if
c_cond
(paren
(paren
id|f-&gt;fw_flg
op_amp
id|IP_FW_F_TCPSYN
)paren
op_logical_and
id|notcpsyn
)paren
(brace
r_continue
suffix:semicolon
)brace
multiline_comment|/*&n;&t;&t;&t; * When a bidirectional rule is used we only check&n;&t;&t;&t; * for ack bits on reverse matches. This way it&squot;s&n;&t;&t;&t; * easy to set up rules which only allow connections&n;&t;&t;&t; * initiated from &quot;normal&quot; match adresses.&n;&t;&t;&t; */
r_if
c_cond
(paren
(paren
id|f-&gt;fw_flg
op_amp
id|IP_FW_F_TCPACK
)paren
op_logical_and
id|notcpack
)paren
r_if
c_cond
(paren
id|f-&gt;fw_flg
op_amp
id|IP_FW_F_BIDIR
)paren
(brace
r_if
c_cond
(paren
id|match
op_amp
l_int|0x02
)paren
(brace
r_continue
suffix:semicolon
)brace
)brace
r_else
r_continue
suffix:semicolon
multiline_comment|/*&n;&t;&t;&t; *&t;Specific firewall - packet&squot;s protocol&n;&t;&t;&t; *&t;must match firewall&squot;s.&n;&t;&t;&t; */
r_if
c_cond
(paren
id|prt
op_ne
id|f_prt
)paren
(brace
r_continue
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|prt
op_eq
id|IP_FW_F_ICMP
op_logical_and
op_logical_neg
id|port_match
c_func
(paren
op_amp
id|f-&gt;fw_pts
(braket
l_int|0
)braket
comma
id|f-&gt;fw_nsp
comma
id|icmp_type
comma
id|f-&gt;fw_flg
op_amp
id|IP_FW_F_SRNG
)paren
)paren
op_logical_or
op_logical_neg
(paren
id|prt
op_eq
id|IP_FW_F_ICMP
op_logical_or
(paren
(paren
id|match
op_amp
l_int|0x01
)paren
op_logical_and
id|port_match
c_func
(paren
op_amp
id|f-&gt;fw_pts
(braket
l_int|0
)braket
comma
id|f-&gt;fw_nsp
comma
id|src_port
comma
id|f-&gt;fw_flg
op_amp
id|IP_FW_F_SRNG
)paren
op_logical_and
id|port_match
c_func
(paren
op_amp
id|f-&gt;fw_pts
(braket
id|f-&gt;fw_nsp
)braket
comma
id|f-&gt;fw_ndp
comma
id|dst_port
comma
id|f-&gt;fw_flg
op_amp
id|IP_FW_F_DRNG
)paren
)paren
op_logical_or
(paren
(paren
id|match
op_amp
l_int|0x02
)paren
op_logical_and
id|port_match
c_func
(paren
op_amp
id|f-&gt;fw_pts
(braket
l_int|0
)braket
comma
id|f-&gt;fw_nsp
comma
id|dst_port
comma
id|f-&gt;fw_flg
op_amp
id|IP_FW_F_SRNG
)paren
op_logical_and
id|port_match
c_func
(paren
op_amp
id|f-&gt;fw_pts
(braket
id|f-&gt;fw_nsp
)braket
comma
id|f-&gt;fw_ndp
comma
id|src_port
comma
id|f-&gt;fw_flg
op_amp
id|IP_FW_F_DRNG
)paren
)paren
)paren
)paren
(brace
r_continue
suffix:semicolon
)brace
)brace
macro_line|#ifdef CONFIG_IP_FIREWALL_VERBOSE
multiline_comment|/*&n;&t;&t; * VERY ugly piece of code which actually&n;&t;&t; * makes kernel printf for denied packets...&n;&t;&t; */
r_if
c_cond
(paren
id|f-&gt;fw_flg
op_amp
id|IP_FW_F_PRN
)paren
(brace
r_if
c_cond
(paren
id|opt
op_ne
l_int|1
)paren
(brace
r_if
c_cond
(paren
id|f-&gt;fw_flg
op_amp
id|IP_FW_F_ACCEPT
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;Accept &quot;
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|f-&gt;fw_flg
op_amp
id|IP_FW_F_ICMPRPL
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;Reject &quot;
)paren
suffix:semicolon
)brace
r_else
id|printk
c_func
(paren
l_string|&quot;Deny &quot;
)paren
suffix:semicolon
)brace
r_switch
c_cond
(paren
id|ip-&gt;protocol
)paren
(brace
r_case
id|IPPROTO_TCP
suffix:colon
id|printk
c_func
(paren
l_string|&quot;TCP &quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|IPPROTO_UDP
suffix:colon
id|printk
c_func
(paren
l_string|&quot;UDP &quot;
)paren
suffix:semicolon
r_case
id|IPPROTO_ICMP
suffix:colon
id|printk
c_func
(paren
l_string|&quot;ICMP &quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|printk
c_func
(paren
l_string|&quot;p=%d &quot;
comma
id|ip-&gt;protocol
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|print_ip
c_func
(paren
id|ip-&gt;saddr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ip-&gt;protocol
op_eq
id|IPPROTO_TCP
op_logical_or
id|ip-&gt;protocol
op_eq
id|IPPROTO_UDP
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;:%d&quot;
comma
id|src_port
)paren
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot; &quot;
)paren
suffix:semicolon
id|print_ip
c_func
(paren
id|ip-&gt;daddr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ip-&gt;protocol
op_eq
id|IPPROTO_TCP
op_logical_or
id|ip-&gt;protocol
op_eq
id|IPPROTO_UDP
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;:%d&quot;
comma
id|dst_port
)paren
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
)brace
macro_line|#endif&t;&t;
r_if
c_cond
(paren
id|opt
op_ne
l_int|2
)paren
(brace
id|f-&gt;fw_bcnt
op_add_assign
id|ntohs
c_func
(paren
id|ip-&gt;tot_len
)paren
suffix:semicolon
id|f-&gt;fw_pcnt
op_increment
suffix:semicolon
)brace
r_if
c_cond
(paren
id|opt
op_ne
l_int|1
)paren
r_break
suffix:semicolon
)brace
multiline_comment|/* Loop */
r_if
c_cond
(paren
id|opt
op_eq
l_int|1
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * We rely on policy defined in the rejecting entry or, if no match&n;&t; * was found, we rely on the general policy variable for this type&n;&t; * of firewall.&n;&t; */
r_if
c_cond
(paren
id|f
op_ne
l_int|NULL
)paren
(brace
multiline_comment|/* A match was found */
id|f_flag
op_assign
id|f-&gt;fw_flg
suffix:semicolon
)brace
r_else
id|f_flag
op_assign
id|policy
suffix:semicolon
r_if
c_cond
(paren
id|f_flag
op_amp
id|IP_FW_F_ACCEPT
)paren
(brace
r_return
(paren
(paren
id|f_flag
op_amp
id|IP_FW_F_MASQ
)paren
ques
c_cond
l_int|2
suffix:colon
l_int|1
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|f_flag
op_amp
id|IP_FW_F_ICMPRPL
)paren
(brace
r_return
op_minus
l_int|1
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#ifdef CONFIG_IP_MASQUERADE
DECL|function|masq_expire
r_static
r_void
id|masq_expire
c_func
(paren
r_int
r_int
id|data
)paren
(brace
r_struct
id|ip_masq
op_star
id|ms
op_assign
(paren
r_struct
id|ip_masq
op_star
)paren
id|data
suffix:semicolon
r_struct
id|ip_masq
op_star
id|old
comma
op_star
id|cur
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
macro_line|#ifdef DEBUG_MASQ
id|printk
c_func
(paren
l_string|&quot;Masqueraded %s %lX:%X expired&bslash;n&quot;
comma
id|strProt
(braket
id|ms-&gt;protocol
op_eq
id|IPPROTO_TCP
)braket
comma
id|ntohl
c_func
(paren
id|ms-&gt;src
)paren
comma
id|ntohs
c_func
(paren
id|ms-&gt;sport
)paren
)paren
suffix:semicolon
macro_line|#endif
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* delete from list of hosts */
id|old
op_assign
l_int|NULL
suffix:semicolon
id|cur
op_assign
id|ip_msq_hosts
suffix:semicolon
r_while
c_loop
(paren
id|cur
op_ne
l_int|NULL
)paren
(brace
r_if
c_cond
(paren
id|cur
op_eq
id|ms
)paren
(brace
r_if
c_cond
(paren
id|old
op_eq
l_int|NULL
)paren
id|ip_msq_hosts
op_assign
id|ms-&gt;next
suffix:semicolon
r_else
id|old-&gt;next
op_assign
id|ms-&gt;next
suffix:semicolon
id|kfree_s
c_func
(paren
id|ms
comma
r_sizeof
(paren
op_star
id|ms
)paren
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|old
op_assign
id|cur
suffix:semicolon
id|cur
op_assign
id|cur-&gt;next
suffix:semicolon
)brace
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Create a new masquerade list entry, also allocate an&n; * unused mport, keeping the portnumber between the&n; * given boundaries MASQ_BEGIN and MASQ_END.&n; *&n; * FIXME: possible deadlock if all free ports are exhausted! &n; */
DECL|function|alloc_masq_entry
r_static
r_struct
id|ip_masq
op_star
id|alloc_masq_entry
c_func
(paren
r_void
)paren
(brace
r_struct
id|ip_masq
op_star
id|ms
comma
op_star
id|mst
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|ms
op_assign
(paren
r_struct
id|ip_masq
op_star
)paren
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|ip_masq
)paren
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ms
op_eq
l_int|NULL
)paren
r_return
l_int|NULL
suffix:semicolon
id|memset
c_func
(paren
id|ms
comma
l_int|0
comma
r_sizeof
(paren
op_star
id|ms
)paren
)paren
suffix:semicolon
id|init_timer
c_func
(paren
op_amp
id|ms-&gt;timer
)paren
suffix:semicolon
id|ms-&gt;timer.data
op_assign
(paren
r_int
r_int
)paren
id|ms
suffix:semicolon
id|ms-&gt;timer.function
op_assign
id|masq_expire
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
r_do
(brace
multiline_comment|/* Try the next available port number */
id|ms-&gt;mport
op_assign
id|htons
c_func
(paren
id|masq_port
op_increment
)paren
suffix:semicolon
r_if
c_cond
(paren
id|masq_port
op_eq
id|PORT_MASQ_END
)paren
id|masq_port
op_assign
id|PORT_MASQ_BEGIN
suffix:semicolon
multiline_comment|/* Now hunt through the used ports to see if&n;&t;&t; * this port is in use... */
id|mst
op_assign
id|ip_msq_hosts
suffix:semicolon
r_while
c_loop
(paren
id|mst
op_logical_and
id|mst-&gt;mport
op_ne
id|ms-&gt;mport
)paren
id|mst
op_assign
id|mst-&gt;next
suffix:semicolon
)brace
r_while
c_loop
(paren
id|mst
op_ne
l_int|NULL
)paren
suffix:semicolon
multiline_comment|/* add new entry in front of list to minimize lookup-time */
id|ms-&gt;next
op_assign
id|ip_msq_hosts
suffix:semicolon
id|ip_msq_hosts
op_assign
id|ms
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
id|ms
suffix:semicolon
)brace
multiline_comment|/*&n; * When passing an FTP &squot;PORT&squot; command, try to replace the IP&n; * address with an newly assigned (masquereded) port on this&n; * host, so the ftp-data connect FROM the site will succeed...&n; *&n; * Also, when the size of the packet changes, create an delta&n; * offset, which will be added to every th-&gt;seq (and subtracted for&n; * (th-&gt;acqseq) whose seq &gt; init_seq.&n; *&n; * Not for the faint of heart!&n; */
DECL|function|revamp
r_static
r_struct
id|sk_buff
op_star
id|revamp
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|device
op_star
id|dev
comma
r_struct
id|ip_masq
op_star
id|ftp
)paren
(brace
r_struct
id|iphdr
op_star
id|iph
op_assign
id|skb-&gt;h.iph
suffix:semicolon
r_struct
id|tcphdr
op_star
id|th
op_assign
(paren
r_struct
id|tcphdr
op_star
)paren
op_amp
(paren
(paren
(paren
r_char
op_star
)paren
id|iph
)paren
(braket
id|iph-&gt;ihl
op_star
l_int|4
)braket
)paren
suffix:semicolon
r_struct
id|sk_buff
op_star
id|skb2
suffix:semicolon
r_char
op_star
id|p
comma
op_star
id|data
op_assign
(paren
r_char
op_star
)paren
op_amp
id|th
(braket
l_int|1
)braket
suffix:semicolon
r_int
r_char
id|p1
comma
id|p2
comma
id|p3
comma
id|p4
comma
id|p5
comma
id|p6
suffix:semicolon
r_int
r_int
id|from
suffix:semicolon
r_int
r_int
id|port
suffix:semicolon
r_struct
id|ip_masq
op_star
id|ms
suffix:semicolon
r_char
id|buf
(braket
l_int|20
)braket
suffix:semicolon
multiline_comment|/* xxx.xxx.xxx.xxx&bslash;r&bslash;n */
multiline_comment|/*&n;&t; * Adjust seq and ack_seq with delta-offset for&n;&t; * the packets AFTER this one...&n;&t; */
r_if
c_cond
(paren
id|ftp-&gt;delta
op_logical_and
id|after
c_func
(paren
id|ftp-&gt;init_seq
comma
id|th-&gt;seq
)paren
)paren
(brace
id|th-&gt;seq
op_add_assign
id|ftp-&gt;delta
suffix:semicolon
multiline_comment|/* &t;&t;th-&gt;ack_seq += ftp-&gt;delta;*/
)brace
r_while
c_loop
(paren
id|skb-&gt;len
op_minus
(paren
(paren
r_int
r_char
op_star
)paren
id|data
op_minus
id|skb-&gt;h.raw
)paren
OG
l_int|18
)paren
(brace
r_if
c_cond
(paren
id|memcmp
c_func
(paren
id|data
comma
l_string|&quot;PORT &quot;
comma
l_int|5
)paren
op_ne
l_int|0
op_logical_and
id|memcmp
c_func
(paren
id|data
comma
l_string|&quot;port &quot;
comma
l_int|5
)paren
op_ne
l_int|0
)paren
(brace
id|data
op_add_assign
l_int|5
suffix:semicolon
r_continue
suffix:semicolon
)brace
id|p
op_assign
id|data
op_plus
l_int|5
suffix:semicolon
id|p1
op_assign
id|simple_strtoul
c_func
(paren
id|data
op_plus
l_int|5
comma
op_amp
id|data
comma
l_int|10
)paren
suffix:semicolon
r_if
c_cond
(paren
op_star
id|data
op_ne
l_char|&squot;,&squot;
)paren
r_continue
suffix:semicolon
id|p2
op_assign
id|simple_strtoul
c_func
(paren
id|data
op_plus
l_int|1
comma
op_amp
id|data
comma
l_int|10
)paren
suffix:semicolon
r_if
c_cond
(paren
op_star
id|data
op_ne
l_char|&squot;,&squot;
)paren
r_continue
suffix:semicolon
id|p3
op_assign
id|simple_strtoul
c_func
(paren
id|data
op_plus
l_int|1
comma
op_amp
id|data
comma
l_int|10
)paren
suffix:semicolon
r_if
c_cond
(paren
op_star
id|data
op_ne
l_char|&squot;,&squot;
)paren
r_continue
suffix:semicolon
id|p4
op_assign
id|simple_strtoul
c_func
(paren
id|data
op_plus
l_int|1
comma
op_amp
id|data
comma
l_int|10
)paren
suffix:semicolon
r_if
c_cond
(paren
op_star
id|data
op_ne
l_char|&squot;,&squot;
)paren
r_continue
suffix:semicolon
id|p5
op_assign
id|simple_strtoul
c_func
(paren
id|data
op_plus
l_int|1
comma
op_amp
id|data
comma
l_int|10
)paren
suffix:semicolon
r_if
c_cond
(paren
op_star
id|data
op_ne
l_char|&squot;,&squot;
)paren
r_continue
suffix:semicolon
id|p6
op_assign
id|simple_strtoul
c_func
(paren
id|data
op_plus
l_int|1
comma
op_amp
id|data
comma
l_int|10
)paren
suffix:semicolon
r_if
c_cond
(paren
op_star
id|data
op_ne
l_char|&squot;&bslash;r&squot;
op_logical_and
op_star
id|data
op_ne
l_char|&squot;&bslash;n&squot;
)paren
r_continue
suffix:semicolon
id|from
op_assign
(paren
id|p1
op_lshift
l_int|24
)paren
op_or
(paren
id|p2
op_lshift
l_int|16
)paren
op_or
(paren
id|p3
op_lshift
l_int|8
)paren
op_or
id|p4
suffix:semicolon
id|port
op_assign
(paren
id|p5
op_lshift
l_int|8
)paren
op_or
id|p6
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;PORT %lX:%X detected&bslash;n&quot;
comma
id|from
comma
id|port
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t; * Now create an masquerade entry for it&n;&t;&t; */
id|ms
op_assign
id|alloc_masq_entry
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ms
op_eq
l_int|NULL
)paren
r_return
id|skb
suffix:semicolon
id|ms-&gt;protocol
op_assign
id|IPPROTO_TCP
suffix:semicolon
id|ms-&gt;src
op_assign
id|htonl
c_func
(paren
id|from
)paren
suffix:semicolon
multiline_comment|/* derived from PORT cmd */
id|ms-&gt;sport
op_assign
id|htons
c_func
(paren
id|port
)paren
suffix:semicolon
multiline_comment|/* derived from PORT cmd */
id|ms-&gt;dst
op_assign
id|iph-&gt;daddr
suffix:semicolon
id|ms-&gt;dport
op_assign
id|htons
c_func
(paren
l_int|20
)paren
suffix:semicolon
multiline_comment|/* ftp-data */
id|ms-&gt;timer.expires
op_assign
id|jiffies
op_plus
id|MASQUERADE_EXPIRE_TCP_FIN
suffix:semicolon
id|add_timer
c_func
(paren
op_amp
id|ms-&gt;timer
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t; * Replace the old PORT with the new one&n;&t;&t; */
id|from
op_assign
id|ntohl
c_func
(paren
id|dev-&gt;pa_addr
)paren
suffix:semicolon
id|port
op_assign
id|ntohs
c_func
(paren
id|ms-&gt;mport
)paren
suffix:semicolon
id|sprintf
c_func
(paren
id|buf
comma
l_string|&quot;%ld,%ld,%ld,%ld,%d,%d&quot;
comma
id|from
op_rshift
l_int|24
op_amp
l_int|255
comma
id|from
op_rshift
l_int|16
op_amp
l_int|255
comma
id|from
op_rshift
l_int|8
op_amp
l_int|255
comma
id|from
op_amp
l_int|255
comma
id|port
op_rshift
l_int|8
op_amp
l_int|255
comma
id|port
op_amp
l_int|255
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t; * Calculate required delta-offset to keep TCP happy&n;&t;&t; */
id|ftp-&gt;delta
op_add_assign
id|strlen
c_func
(paren
id|buf
)paren
op_minus
(paren
id|data
op_minus
id|p
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ftp-&gt;delta
op_eq
l_int|0
)paren
(brace
multiline_comment|/*&n;&t;&t;&t; * simple case, just replace the old PORT cmd&n; &t;&t;&t; */
id|ftp-&gt;init_seq
op_assign
l_int|0
suffix:semicolon
id|memcpy
c_func
(paren
id|p
comma
id|buf
comma
id|strlen
c_func
(paren
id|buf
)paren
)paren
suffix:semicolon
r_return
id|skb
suffix:semicolon
)brace
multiline_comment|/*&n; &t;&t; * Sizes differ, make a copy&n; &t;&t; */
id|printk
c_func
(paren
l_string|&quot;MASQUERADE: resizing needed for %d bytes (%ld)&bslash;n&quot;
comma
id|ftp-&gt;delta
comma
id|skb-&gt;len
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ftp-&gt;init_seq
)paren
id|ftp-&gt;init_seq
op_assign
id|th-&gt;seq
suffix:semicolon
id|skb2
op_assign
id|alloc_skb
c_func
(paren
id|MAX_HEADER
op_plus
id|skb-&gt;len
op_plus
id|ftp-&gt;delta
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
id|skb2
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;MASQUERADE: No memory available&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|skb
suffix:semicolon
)brace
id|skb2-&gt;free
op_assign
id|skb-&gt;free
suffix:semicolon
id|skb_reserve
c_func
(paren
id|skb2
comma
id|MAX_HEADER
)paren
suffix:semicolon
id|skb_put
c_func
(paren
id|skb2
comma
id|skb-&gt;len
op_plus
id|ftp-&gt;delta
)paren
suffix:semicolon
id|skb2-&gt;h.raw
op_assign
op_amp
id|skb2-&gt;data
(braket
id|skb-&gt;h.raw
op_minus
id|skb-&gt;data
)braket
suffix:semicolon
multiline_comment|/*&n; &t;&t; *&t;Copy the packet data into the new buffer.&n; &t;&t; *&t;Thereby replacing the PORT cmd.&n; &t;&t; */
id|memcpy
c_func
(paren
id|skb2-&gt;data
comma
id|skb-&gt;data
comma
(paren
id|p
op_minus
(paren
r_char
op_star
)paren
id|skb-&gt;data
)paren
)paren
suffix:semicolon
id|memcpy
c_func
(paren
op_amp
id|skb2-&gt;data
(braket
(paren
id|p
op_minus
(paren
r_char
op_star
)paren
id|skb-&gt;data
)paren
)braket
comma
id|buf
comma
id|strlen
c_func
(paren
id|buf
)paren
)paren
suffix:semicolon
id|memcpy
c_func
(paren
op_amp
id|skb2-&gt;data
(braket
(paren
id|p
op_minus
(paren
r_char
op_star
)paren
id|skb-&gt;data
)paren
op_plus
id|strlen
c_func
(paren
id|buf
)paren
)braket
comma
id|data
comma
id|skb-&gt;len
op_minus
(paren
(paren
r_char
op_star
)paren
id|skb-&gt;h.raw
op_minus
id|data
)paren
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t; * Problem, how to replace the new skb with old one,&n;&t;&t; * preferably inplace, so all the pointers in the&n;&t;&t; * calling tree keep ok :(&n;&t;&t; */
id|kfree_skb
c_func
(paren
id|skb
comma
id|FREE_WRITE
)paren
suffix:semicolon
r_return
id|skb2
suffix:semicolon
)brace
r_return
id|skb
suffix:semicolon
)brace
DECL|function|recalc_check
r_static
r_void
id|recalc_check
c_func
(paren
r_struct
id|udphdr
op_star
id|uh
comma
r_int
r_int
id|saddr
comma
r_int
r_int
id|daddr
comma
r_int
id|len
)paren
(brace
id|uh-&gt;check
op_assign
l_int|0
suffix:semicolon
id|uh-&gt;check
op_assign
id|csum_tcpudp_magic
c_func
(paren
id|saddr
comma
id|daddr
comma
id|len
comma
id|IPPROTO_UDP
comma
id|csum_partial
c_func
(paren
(paren
r_char
op_star
)paren
id|uh
comma
id|len
comma
l_int|0
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|uh-&gt;check
op_eq
l_int|0
)paren
(brace
id|uh-&gt;check
op_assign
l_int|0xFFFF
suffix:semicolon
)brace
)brace
DECL|function|ip_fw_masquerade
r_void
id|ip_fw_masquerade
c_func
(paren
r_struct
id|sk_buff
op_star
op_star
id|skb_ptr
comma
r_struct
id|device
op_star
id|dev
)paren
(brace
r_struct
id|sk_buff
op_star
id|skb
op_assign
op_star
id|skb_ptr
suffix:semicolon
r_struct
id|iphdr
op_star
id|iph
op_assign
id|skb-&gt;h.iph
suffix:semicolon
r_int
r_int
op_star
id|portptr
suffix:semicolon
r_struct
id|ip_masq
op_star
id|ms
suffix:semicolon
r_int
id|size
suffix:semicolon
multiline_comment|/*&n;&t; * We can only masquerade protocols with ports...&n;&t; */
r_if
c_cond
(paren
id|iph-&gt;protocol
op_ne
id|IPPROTO_UDP
op_logical_and
id|iph-&gt;protocol
op_ne
id|IPPROTO_TCP
)paren
r_return
suffix:semicolon
multiline_comment|/*&n;&t; *&t;Now hunt the list to see if we have an old entry&n;&t; */
id|portptr
op_assign
(paren
r_int
r_int
op_star
)paren
op_amp
(paren
(paren
(paren
r_char
op_star
)paren
id|iph
)paren
(braket
id|iph-&gt;ihl
op_star
l_int|4
)braket
)paren
suffix:semicolon
id|ms
op_assign
id|ip_msq_hosts
suffix:semicolon
macro_line|#ifdef DEBUG_MASQ
id|printk
c_func
(paren
l_string|&quot;Outgoing %s %lX:%X -&gt; %lX:%X&bslash;n&quot;
comma
id|strProt
(braket
id|iph-&gt;protocol
op_eq
id|IPPROTO_TCP
)braket
comma
id|ntohl
c_func
(paren
id|iph-&gt;saddr
)paren
comma
id|ntohs
c_func
(paren
id|portptr
(braket
l_int|0
)braket
)paren
comma
id|ntohl
c_func
(paren
id|iph-&gt;daddr
)paren
comma
id|ntohs
c_func
(paren
id|portptr
(braket
l_int|1
)braket
)paren
)paren
suffix:semicolon
macro_line|#endif
r_while
c_loop
(paren
id|ms
op_ne
l_int|NULL
)paren
(brace
r_if
c_cond
(paren
id|iph-&gt;protocol
op_eq
id|ms-&gt;protocol
op_logical_and
id|iph-&gt;saddr
op_eq
id|ms-&gt;src
op_logical_and
id|iph-&gt;daddr
op_eq
id|ms-&gt;dst
op_logical_and
id|portptr
(braket
l_int|0
)braket
op_eq
id|ms-&gt;sport
op_logical_and
id|portptr
(braket
l_int|1
)braket
op_eq
id|ms-&gt;dport
)paren
(brace
id|del_timer
c_func
(paren
op_amp
id|ms-&gt;timer
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|ms
op_assign
id|ms-&gt;next
suffix:semicolon
)brace
multiline_comment|/*&n;&t; *&t;Nope, not found, create a new entry for it&n;&t; */
r_if
c_cond
(paren
id|ms
op_eq
l_int|NULL
)paren
(brace
id|ms
op_assign
id|alloc_masq_entry
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ms
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;MASQUERADE: no memory left !&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|ms-&gt;protocol
op_assign
id|iph-&gt;protocol
suffix:semicolon
id|ms-&gt;src
op_assign
id|iph-&gt;saddr
suffix:semicolon
id|ms-&gt;dst
op_assign
id|iph-&gt;daddr
suffix:semicolon
id|ms-&gt;sport
op_assign
id|portptr
(braket
l_int|0
)braket
suffix:semicolon
id|ms-&gt;dport
op_assign
id|portptr
(braket
l_int|1
)braket
suffix:semicolon
)brace
multiline_comment|/*&n; &t; *&t;Change the fragments origin&n; &t; */
id|size
op_assign
id|skb-&gt;len
op_minus
(paren
(paren
r_int
r_char
op_star
)paren
id|portptr
op_minus
id|skb-&gt;h.raw
)paren
suffix:semicolon
id|iph-&gt;saddr
op_assign
id|dev-&gt;pa_addr
suffix:semicolon
multiline_comment|/* my own address */
id|portptr
(braket
l_int|0
)braket
op_assign
id|ms-&gt;mport
suffix:semicolon
multiline_comment|/*&n; &t; *&t;Adjust packet accordingly to protocol&n; &t; */
r_if
c_cond
(paren
id|iph-&gt;protocol
op_eq
id|IPPROTO_UDP
)paren
(brace
id|ms-&gt;timer.expires
op_assign
id|jiffies
op_plus
id|MASQUERADE_EXPIRE_UDP
suffix:semicolon
id|recalc_check
c_func
(paren
(paren
r_struct
id|udphdr
op_star
)paren
id|portptr
comma
id|iph-&gt;saddr
comma
id|iph-&gt;daddr
comma
id|size
)paren
suffix:semicolon
)brace
r_else
(brace
r_struct
id|tcphdr
op_star
id|th
suffix:semicolon
r_if
c_cond
(paren
id|portptr
(braket
l_int|1
)braket
op_eq
id|htons
c_func
(paren
l_int|21
)paren
)paren
(brace
id|skb
op_assign
id|revamp
c_func
(paren
op_star
id|skb_ptr
comma
id|dev
comma
id|ms
)paren
suffix:semicolon
op_star
id|skb_ptr
op_assign
id|skb
suffix:semicolon
id|iph
op_assign
id|skb-&gt;h.iph
suffix:semicolon
id|portptr
op_assign
(paren
r_int
r_int
op_star
)paren
op_amp
(paren
(paren
(paren
r_char
op_star
)paren
id|iph
)paren
(braket
id|iph-&gt;ihl
op_star
l_int|4
)braket
)paren
suffix:semicolon
)brace
id|th
op_assign
(paren
r_struct
id|tcphdr
op_star
)paren
id|portptr
suffix:semicolon
multiline_comment|/*&n; &t;&t; *&t;Timeout depends if FIN packet was seen&n; &t;&t; */
r_if
c_cond
(paren
id|ms-&gt;sawfin
op_logical_or
id|th-&gt;fin
)paren
(brace
id|ms-&gt;timer.expires
op_assign
id|jiffies
op_plus
id|MASQUERADE_EXPIRE_TCP_FIN
suffix:semicolon
id|ms-&gt;sawfin
op_assign
l_int|1
suffix:semicolon
)brace
r_else
id|ms-&gt;timer.expires
op_assign
id|jiffies
op_plus
id|MASQUERADE_EXPIRE_TCP
suffix:semicolon
id|tcp_send_check
c_func
(paren
id|th
comma
id|iph-&gt;saddr
comma
id|iph-&gt;daddr
comma
id|size
comma
id|skb-&gt;sk
)paren
suffix:semicolon
)brace
id|add_timer
c_func
(paren
op_amp
id|ms-&gt;timer
)paren
suffix:semicolon
id|ip_send_check
c_func
(paren
id|iph
)paren
suffix:semicolon
macro_line|#ifdef DEBUG_MASQ
id|printk
c_func
(paren
l_string|&quot;O-routed from %lX:%X over %s&bslash;n&quot;
comma
id|ntohl
c_func
(paren
id|dev-&gt;pa_addr
)paren
comma
id|ntohs
c_func
(paren
id|ms-&gt;mport
)paren
comma
id|dev-&gt;name
)paren
suffix:semicolon
macro_line|#endif
)brace
multiline_comment|/*&n;  *&t;Check if it&squot;s an masqueraded port, look it up,&n;  *&t;and send it on it&squot;s way...&n;  *&n;  *&t;Better not have many hosts using the designated portrange&n;  *&t;as &squot;normal&squot; ports, or you&squot;ll be spending lots of time in&n;  *&t;this function.&n;  */
DECL|function|ip_fw_demasquerade
r_int
id|ip_fw_demasquerade
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb_ptr
)paren
(brace
r_struct
id|iphdr
op_star
id|iph
op_assign
id|skb_ptr-&gt;h.iph
suffix:semicolon
r_int
r_int
op_star
id|portptr
suffix:semicolon
r_struct
id|ip_masq
op_star
id|ms
suffix:semicolon
r_struct
id|tcphdr
op_star
id|th
op_assign
(paren
r_struct
id|tcphdr
op_star
)paren
(paren
id|skb_ptr-&gt;h.raw
op_plus
(paren
id|iph-&gt;ihl
op_lshift
l_int|2
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|iph-&gt;protocol
op_ne
id|IPPROTO_UDP
op_logical_and
id|iph-&gt;protocol
op_ne
id|IPPROTO_TCP
)paren
r_return
l_int|0
suffix:semicolon
id|portptr
op_assign
(paren
r_int
r_int
op_star
)paren
op_amp
(paren
(paren
(paren
r_char
op_star
)paren
id|iph
)paren
(braket
id|iph-&gt;ihl
op_star
l_int|4
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ntohs
c_func
(paren
id|portptr
(braket
l_int|1
)braket
)paren
template_param
id|PORT_MASQ_END
)paren
r_return
l_int|0
suffix:semicolon
macro_line|#ifdef DEBUG_MASQ
id|printk
c_func
(paren
l_string|&quot;Incoming %s %lX:%X -&gt; %lX:%X&bslash;n&quot;
comma
id|strProt
(braket
id|iph-&gt;protocol
op_eq
id|IPPROTO_TCP
)braket
comma
id|ntohl
c_func
(paren
id|iph-&gt;saddr
)paren
comma
id|ntohs
c_func
(paren
id|portptr
(braket
l_int|0
)braket
)paren
comma
id|ntohl
c_func
(paren
id|iph-&gt;daddr
)paren
comma
id|ntohs
c_func
(paren
id|portptr
(braket
l_int|1
)braket
)paren
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/*&n; &t; * reroute to original host:port if found...&n; &t; *&n; &t; * NB. Cannot check destination address, just for the incoming port.&n; &t; * reason: archie.doc.ac.uk has 6 interfaces, you send to&n; &t; * phoenix and get a reply from any other interface(==dst)!&n; &t; *&n; &t; * [Only for UDP] - AC&n; &t; */
id|ms
op_assign
id|ip_msq_hosts
suffix:semicolon
r_while
c_loop
(paren
id|ms
op_ne
l_int|NULL
)paren
(brace
r_if
c_cond
(paren
id|iph-&gt;protocol
op_eq
id|ms-&gt;protocol
op_logical_and
(paren
id|iph-&gt;saddr
op_eq
id|ms-&gt;dst
op_logical_or
id|iph-&gt;protocol
op_eq
id|IPPROTO_UDP
)paren
op_logical_and
id|portptr
(braket
l_int|0
)braket
op_eq
id|ms-&gt;dport
op_logical_and
id|portptr
(braket
l_int|1
)braket
op_eq
id|ms-&gt;mport
)paren
(brace
r_int
id|size
op_assign
id|skb_ptr-&gt;len
op_minus
(paren
(paren
r_int
r_char
op_star
)paren
id|portptr
op_minus
id|skb_ptr-&gt;h.raw
)paren
suffix:semicolon
id|iph-&gt;daddr
op_assign
id|ms-&gt;src
suffix:semicolon
id|portptr
(braket
l_int|1
)braket
op_assign
id|ms-&gt;sport
suffix:semicolon
multiline_comment|/*&n; &t;&t;&t; * Yug! adjust UDP/TCP and IP checksums&n; &t;&t;&t; */
r_if
c_cond
(paren
id|iph-&gt;protocol
op_eq
id|IPPROTO_UDP
)paren
id|recalc_check
c_func
(paren
(paren
r_struct
id|udphdr
op_star
)paren
id|portptr
comma
id|iph-&gt;saddr
comma
id|iph-&gt;daddr
comma
id|size
)paren
suffix:semicolon
r_else
(brace
multiline_comment|/*&n;&t;&t;&t;&t; * Adjust seq and ack_seq with delta-offset for&n;&t;&t;&t;&t; * the packets AFTER this one...&n;&t;&t;&t;&t; */
r_if
c_cond
(paren
id|ms-&gt;delta
op_logical_and
id|after
c_func
(paren
id|ms-&gt;init_seq
comma
id|th-&gt;ack_seq
)paren
)paren
(brace
multiline_comment|/*&t;&t;&t;&t;&t;th-&gt;seq += ms-&gt;delta;*/
id|th-&gt;ack_seq
op_sub_assign
id|ms-&gt;delta
suffix:semicolon
)brace
id|tcp_send_check
c_func
(paren
(paren
r_struct
id|tcphdr
op_star
)paren
id|portptr
comma
id|iph-&gt;saddr
comma
id|iph-&gt;daddr
comma
id|size
comma
id|skb_ptr-&gt;sk
)paren
suffix:semicolon
)brace
id|ip_send_check
c_func
(paren
id|iph
)paren
suffix:semicolon
macro_line|#ifdef DEBUG_MASQ
id|printk
c_func
(paren
l_string|&quot;I-routed to %lX:%X&bslash;n&quot;
comma
id|ntohl
c_func
(paren
id|iph-&gt;daddr
)paren
comma
id|ntohs
c_func
(paren
id|portptr
(braket
l_int|1
)braket
)paren
)paren
suffix:semicolon
macro_line|#endif
r_return
l_int|1
suffix:semicolon
)brace
id|ms
op_assign
id|ms-&gt;next
suffix:semicolon
)brace
multiline_comment|/* sorry, all this trouble for a no-hit :) */
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#endif
DECL|function|zero_fw_chain
r_static
r_void
id|zero_fw_chain
c_func
(paren
r_struct
id|ip_fw
op_star
id|chainptr
)paren
(brace
r_struct
id|ip_fw
op_star
id|ctmp
op_assign
id|chainptr
suffix:semicolon
r_while
c_loop
(paren
id|ctmp
)paren
(brace
id|ctmp-&gt;fw_pcnt
op_assign
l_int|0L
suffix:semicolon
id|ctmp-&gt;fw_bcnt
op_assign
l_int|0L
suffix:semicolon
id|ctmp
op_assign
id|ctmp-&gt;fw_next
suffix:semicolon
)brace
)brace
DECL|function|free_fw_chain
r_static
r_void
id|free_fw_chain
c_func
(paren
r_struct
id|ip_fw
op_star
r_volatile
op_star
id|chainptr
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
r_while
c_loop
(paren
op_star
id|chainptr
op_ne
l_int|NULL
)paren
(brace
r_struct
id|ip_fw
op_star
id|ftmp
suffix:semicolon
id|ftmp
op_assign
op_star
id|chainptr
suffix:semicolon
op_star
id|chainptr
op_assign
id|ftmp-&gt;fw_next
suffix:semicolon
id|kfree_s
c_func
(paren
id|ftmp
comma
r_sizeof
(paren
op_star
id|ftmp
)paren
)paren
suffix:semicolon
)brace
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
multiline_comment|/* Volatiles to keep some of the compiler versions amused */
DECL|function|add_to_chain
r_static
r_int
id|add_to_chain
c_func
(paren
r_struct
id|ip_fw
op_star
r_volatile
op_star
id|chainptr
comma
r_struct
id|ip_fw
op_star
id|frwl
)paren
(brace
r_struct
id|ip_fw
op_star
id|ftmp
suffix:semicolon
r_struct
id|ip_fw
op_star
id|chtmp
op_assign
l_int|NULL
suffix:semicolon
r_struct
id|ip_fw
op_star
r_volatile
id|chtmp_prev
op_assign
l_int|NULL
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_int
r_int
id|m_src_mask
comma
id|m_dst_mask
suffix:semicolon
r_int
r_int
id|n_sa
comma
id|n_da
comma
id|o_sa
comma
id|o_da
comma
id|o_sm
comma
id|o_dm
comma
id|n_sm
comma
id|n_dm
suffix:semicolon
r_int
r_int
id|n_sr
comma
id|n_dr
comma
id|o_sr
comma
id|o_dr
suffix:semicolon
r_int
r_int
id|oldkind
comma
id|newkind
suffix:semicolon
r_int
id|addb4
op_assign
l_int|0
suffix:semicolon
r_int
id|n_o
comma
id|n_n
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|ftmp
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|ip_fw
)paren
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ftmp
op_eq
l_int|NULL
)paren
(brace
macro_line|#ifdef DEBUG_CONFIG_IP_FIREWALL
id|printk
c_func
(paren
l_string|&quot;ip_fw_ctl:  malloc said no&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
r_return
id|ENOMEM
suffix:semicolon
)brace
id|memcpy
c_func
(paren
id|ftmp
comma
id|frwl
comma
r_sizeof
(paren
r_struct
id|ip_fw
)paren
)paren
suffix:semicolon
id|ftmp-&gt;fw_pcnt
op_assign
l_int|0L
suffix:semicolon
id|ftmp-&gt;fw_bcnt
op_assign
l_int|0L
suffix:semicolon
id|ftmp-&gt;fw_next
op_assign
l_int|NULL
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_star
id|chainptr
op_eq
l_int|NULL
)paren
(brace
op_star
id|chainptr
op_assign
id|ftmp
suffix:semicolon
)brace
r_else
(brace
id|chtmp_prev
op_assign
l_int|NULL
suffix:semicolon
r_for
c_loop
(paren
id|chtmp
op_assign
op_star
id|chainptr
suffix:semicolon
id|chtmp
op_ne
l_int|NULL
suffix:semicolon
id|chtmp
op_assign
id|chtmp-&gt;fw_next
)paren
(brace
id|addb4
op_assign
l_int|0
suffix:semicolon
id|newkind
op_assign
id|ftmp-&gt;fw_flg
op_amp
id|IP_FW_F_KIND
suffix:semicolon
id|oldkind
op_assign
id|chtmp-&gt;fw_flg
op_amp
id|IP_FW_F_KIND
suffix:semicolon
r_if
c_cond
(paren
id|newkind
op_ne
id|IP_FW_F_ALL
op_logical_and
id|oldkind
op_ne
id|IP_FW_F_ALL
op_logical_and
id|oldkind
op_ne
id|newkind
)paren
(brace
id|chtmp_prev
op_assign
id|chtmp
suffix:semicolon
r_continue
suffix:semicolon
)brace
multiline_comment|/*&n;&t;&t;&t; *&t;Very very *UGLY* code...&n;&t;&t;&t; *&t;Sorry,but i had to do this....&n;&t;&t;&t; */
id|n_sa
op_assign
id|ntohl
c_func
(paren
id|ftmp-&gt;fw_src.s_addr
)paren
suffix:semicolon
id|n_da
op_assign
id|ntohl
c_func
(paren
id|ftmp-&gt;fw_dst.s_addr
)paren
suffix:semicolon
id|n_sm
op_assign
id|ntohl
c_func
(paren
id|ftmp-&gt;fw_smsk.s_addr
)paren
suffix:semicolon
id|n_dm
op_assign
id|ntohl
c_func
(paren
id|ftmp-&gt;fw_dmsk.s_addr
)paren
suffix:semicolon
id|o_sa
op_assign
id|ntohl
c_func
(paren
id|chtmp-&gt;fw_src.s_addr
)paren
suffix:semicolon
id|o_da
op_assign
id|ntohl
c_func
(paren
id|chtmp-&gt;fw_dst.s_addr
)paren
suffix:semicolon
id|o_sm
op_assign
id|ntohl
c_func
(paren
id|chtmp-&gt;fw_smsk.s_addr
)paren
suffix:semicolon
id|o_dm
op_assign
id|ntohl
c_func
(paren
id|chtmp-&gt;fw_dmsk.s_addr
)paren
suffix:semicolon
id|m_src_mask
op_assign
id|o_sm
op_amp
id|n_sm
suffix:semicolon
id|m_dst_mask
op_assign
id|o_dm
op_amp
id|n_dm
suffix:semicolon
r_if
c_cond
(paren
(paren
id|o_sa
op_amp
id|m_src_mask
)paren
op_eq
(paren
id|n_sa
op_amp
id|m_src_mask
)paren
)paren
(brace
r_if
c_cond
(paren
id|n_sm
OG
id|o_sm
)paren
id|addb4
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|n_sm
OL
id|o_sm
)paren
id|addb4
op_decrement
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|o_da
op_amp
id|m_dst_mask
)paren
op_eq
(paren
id|n_da
op_amp
id|m_dst_mask
)paren
)paren
(brace
r_if
c_cond
(paren
id|n_dm
OG
id|o_dm
)paren
id|addb4
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|n_dm
OL
id|o_dm
)paren
id|addb4
op_decrement
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
(paren
id|o_da
op_amp
id|o_dm
)paren
op_eq
(paren
id|n_da
op_amp
id|n_dm
)paren
)paren
op_logical_and
(paren
(paren
id|o_sa
op_amp
id|o_sm
)paren
op_eq
(paren
id|n_sa
op_amp
id|n_sm
)paren
)paren
)paren
(brace
r_if
c_cond
(paren
id|newkind
op_ne
id|IP_FW_F_ALL
op_logical_and
id|oldkind
op_eq
id|IP_FW_F_ALL
)paren
id|addb4
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|newkind
op_eq
id|oldkind
op_logical_and
(paren
id|oldkind
op_eq
id|IP_FW_F_TCP
op_logical_or
id|oldkind
op_eq
id|IP_FW_F_UDP
)paren
)paren
(brace
multiline_comment|/*&n;&t;&t;&t;&t;&t; * &t;Here the main idea is to check the size&n;&t;&t;&t;&t;&t; * &t;of port range which the frwl covers&n;&t;&t;&t;&t;&t; * &t;We actually don&squot;t check their values but&n;&t;&t;&t;&t;&t; *&t;just the wideness of range they have&n;&t;&t;&t;&t;&t; *&t;so that less wide ranges or single ports&n;&t;&t;&t;&t;&t; *&t;go first and wide ranges go later. No ports&n;&t;&t;&t;&t;&t; *&t;at all treated as a range of maximum number&n;&t;&t;&t;&t;&t; *&t;of ports.&n;&t;&t;&t;&t;&t; */
r_if
c_cond
(paren
id|ftmp-&gt;fw_flg
op_amp
id|IP_FW_F_SRNG
)paren
id|n_sr
op_assign
id|ftmp-&gt;fw_pts
(braket
l_int|1
)braket
op_minus
id|ftmp-&gt;fw_pts
(braket
l_int|0
)braket
suffix:semicolon
r_else
id|n_sr
op_assign
(paren
id|ftmp-&gt;fw_nsp
)paren
ques
c_cond
id|ftmp-&gt;fw_nsp
suffix:colon
l_int|0xFFFF
suffix:semicolon
r_if
c_cond
(paren
id|chtmp-&gt;fw_flg
op_amp
id|IP_FW_F_SRNG
)paren
id|o_sr
op_assign
id|chtmp-&gt;fw_pts
(braket
l_int|1
)braket
op_minus
id|chtmp-&gt;fw_pts
(braket
l_int|0
)braket
suffix:semicolon
r_else
id|o_sr
op_assign
(paren
id|chtmp-&gt;fw_nsp
)paren
ques
c_cond
id|chtmp-&gt;fw_nsp
suffix:colon
l_int|0xFFFF
suffix:semicolon
r_if
c_cond
(paren
id|n_sr
OL
id|o_sr
)paren
id|addb4
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|n_sr
OG
id|o_sr
)paren
id|addb4
op_decrement
suffix:semicolon
id|n_n
op_assign
id|ftmp-&gt;fw_nsp
suffix:semicolon
id|n_o
op_assign
id|chtmp-&gt;fw_nsp
suffix:semicolon
multiline_comment|/*&n;&t;&t;&t;&t;&t; * Actually this cannot happen as the frwl control&n;&t;&t;&t;&t;&t; * procedure checks for number of ports in source and&n;&t;&t;&t;&t;&t; * destination range but we will try to be more safe.&n;&t;&t;&t;&t;&t; */
r_if
c_cond
(paren
(paren
id|n_n
OG
(paren
id|IP_FW_MAX_PORTS
op_minus
l_int|2
)paren
)paren
op_logical_or
(paren
id|n_o
OG
(paren
id|IP_FW_MAX_PORTS
op_minus
l_int|2
)paren
)paren
)paren
r_goto
id|skip_check
suffix:semicolon
r_if
c_cond
(paren
id|ftmp-&gt;fw_flg
op_amp
id|IP_FW_F_DRNG
)paren
id|n_dr
op_assign
id|ftmp-&gt;fw_pts
(braket
id|n_n
op_plus
l_int|1
)braket
op_minus
id|ftmp-&gt;fw_pts
(braket
id|n_n
)braket
suffix:semicolon
r_else
id|n_dr
op_assign
(paren
id|ftmp-&gt;fw_ndp
)paren
ques
c_cond
id|ftmp-&gt;fw_ndp
suffix:colon
l_int|0xFFFF
suffix:semicolon
r_if
c_cond
(paren
id|chtmp-&gt;fw_flg
op_amp
id|IP_FW_F_DRNG
)paren
id|o_dr
op_assign
id|chtmp-&gt;fw_pts
(braket
id|n_o
op_plus
l_int|1
)braket
op_minus
id|chtmp-&gt;fw_pts
(braket
id|n_o
)braket
suffix:semicolon
r_else
id|o_dr
op_assign
(paren
id|chtmp-&gt;fw_ndp
)paren
ques
c_cond
id|chtmp-&gt;fw_ndp
suffix:colon
l_int|0xFFFF
suffix:semicolon
r_if
c_cond
(paren
id|n_dr
OL
id|o_dr
)paren
id|addb4
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|n_dr
OG
id|o_dr
)paren
id|addb4
op_decrement
suffix:semicolon
id|skip_check
suffix:colon
)brace
multiline_comment|/* finally look at the interface address */
r_if
c_cond
(paren
(paren
id|addb4
op_eq
l_int|0
)paren
op_logical_and
id|ftmp-&gt;fw_via.s_addr
op_logical_and
op_logical_neg
(paren
id|chtmp-&gt;fw_via.s_addr
)paren
)paren
id|addb4
op_increment
suffix:semicolon
)brace
r_if
c_cond
(paren
id|addb4
OG
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|chtmp_prev
)paren
(brace
id|chtmp_prev-&gt;fw_next
op_assign
id|ftmp
suffix:semicolon
id|ftmp-&gt;fw_next
op_assign
id|chtmp
suffix:semicolon
)brace
r_else
(brace
op_star
id|chainptr
op_assign
id|ftmp
suffix:semicolon
id|ftmp-&gt;fw_next
op_assign
id|chtmp
suffix:semicolon
)brace
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|chtmp_prev
op_assign
id|chtmp
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|chtmp_prev
)paren
id|chtmp_prev-&gt;fw_next
op_assign
id|ftmp
suffix:semicolon
r_else
op_star
id|chainptr
op_assign
id|ftmp
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|del_from_chain
r_static
r_int
id|del_from_chain
c_func
(paren
r_struct
id|ip_fw
op_star
r_volatile
op_star
id|chainptr
comma
r_struct
id|ip_fw
op_star
id|frwl
)paren
(brace
r_struct
id|ip_fw
op_star
id|ftmp
comma
op_star
id|ltmp
suffix:semicolon
r_int
r_int
id|tport1
comma
id|tport2
comma
id|tmpnum
suffix:semicolon
r_char
id|matches
comma
id|was_found
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|ftmp
op_assign
op_star
id|chainptr
suffix:semicolon
r_if
c_cond
(paren
id|ftmp
op_eq
l_int|NULL
)paren
(brace
macro_line|#ifdef DEBUG_CONFIG_IP_FIREWALL
id|printk
c_func
(paren
l_string|&quot;ip_fw_ctl:  chain is empty&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
id|EINVAL
suffix:semicolon
)brace
id|ltmp
op_assign
l_int|NULL
suffix:semicolon
id|was_found
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
id|ftmp
op_ne
l_int|NULL
)paren
(brace
id|matches
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|ftmp-&gt;fw_src.s_addr
op_ne
id|frwl-&gt;fw_src.s_addr
op_logical_or
id|ftmp-&gt;fw_dst.s_addr
op_ne
id|frwl-&gt;fw_dst.s_addr
op_logical_or
id|ftmp-&gt;fw_smsk.s_addr
op_ne
id|frwl-&gt;fw_smsk.s_addr
op_logical_or
id|ftmp-&gt;fw_dmsk.s_addr
op_ne
id|frwl-&gt;fw_dmsk.s_addr
op_logical_or
id|ftmp-&gt;fw_via.s_addr
op_ne
id|frwl-&gt;fw_via.s_addr
op_logical_or
id|ftmp-&gt;fw_flg
op_ne
id|frwl-&gt;fw_flg
)paren
id|matches
op_assign
l_int|0
suffix:semicolon
id|tport1
op_assign
id|ftmp-&gt;fw_nsp
op_plus
id|ftmp-&gt;fw_ndp
suffix:semicolon
id|tport2
op_assign
id|frwl-&gt;fw_nsp
op_plus
id|frwl-&gt;fw_ndp
suffix:semicolon
r_if
c_cond
(paren
id|tport1
op_ne
id|tport2
)paren
id|matches
op_assign
l_int|0
suffix:semicolon
r_else
r_if
c_cond
(paren
id|tport1
op_ne
l_int|0
)paren
(brace
r_for
c_loop
(paren
id|tmpnum
op_assign
l_int|0
suffix:semicolon
id|tmpnum
OL
id|tport1
op_logical_and
id|tmpnum
OL
id|IP_FW_MAX_PORTS
suffix:semicolon
id|tmpnum
op_increment
)paren
r_if
c_cond
(paren
id|ftmp-&gt;fw_pts
(braket
id|tmpnum
)braket
op_ne
id|frwl-&gt;fw_pts
(braket
id|tmpnum
)braket
)paren
id|matches
op_assign
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|matches
)paren
(brace
id|was_found
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|ltmp
)paren
(brace
id|ltmp-&gt;fw_next
op_assign
id|ftmp-&gt;fw_next
suffix:semicolon
id|kfree_s
c_func
(paren
id|ftmp
comma
r_sizeof
(paren
op_star
id|ftmp
)paren
)paren
suffix:semicolon
id|ftmp
op_assign
id|ltmp-&gt;fw_next
suffix:semicolon
)brace
r_else
(brace
op_star
id|chainptr
op_assign
id|ftmp-&gt;fw_next
suffix:semicolon
id|kfree_s
c_func
(paren
id|ftmp
comma
r_sizeof
(paren
op_star
id|ftmp
)paren
)paren
suffix:semicolon
id|ftmp
op_assign
op_star
id|chainptr
suffix:semicolon
)brace
)brace
r_else
(brace
id|ltmp
op_assign
id|ftmp
suffix:semicolon
id|ftmp
op_assign
id|ftmp-&gt;fw_next
suffix:semicolon
)brace
)brace
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|was_found
)paren
r_return
l_int|0
suffix:semicolon
r_else
r_return
id|EINVAL
suffix:semicolon
)brace
macro_line|#endif  /* CONFIG_IP_ACCT || CONFIG_IP_FIREWALL */
DECL|function|check_ipfw_struct
r_struct
id|ip_fw
op_star
id|check_ipfw_struct
c_func
(paren
r_struct
id|ip_fw
op_star
id|frwl
comma
r_int
id|len
)paren
(brace
r_if
c_cond
(paren
id|len
op_ne
r_sizeof
(paren
r_struct
id|ip_fw
)paren
)paren
(brace
macro_line|#ifdef DEBUG_CONFIG_IP_FIREWALL
id|printk
c_func
(paren
l_string|&quot;ip_fw_ctl: len=%d, want %d&bslash;n&quot;
comma
id|len
comma
r_sizeof
(paren
r_struct
id|ip_fw
)paren
)paren
suffix:semicolon
macro_line|#endif
r_return
l_int|NULL
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|frwl-&gt;fw_flg
op_amp
op_complement
id|IP_FW_F_MASK
)paren
op_ne
l_int|0
)paren
(brace
macro_line|#ifdef DEBUG_CONFIG_IP_FIREWALL
id|printk
c_func
(paren
l_string|&quot;ip_fw_ctl: undefined flag bits set (flags=%x)&bslash;n&quot;
comma
id|frwl-&gt;fw_flg
)paren
suffix:semicolon
macro_line|#endif
r_return
l_int|NULL
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|frwl-&gt;fw_flg
op_amp
id|IP_FW_F_SRNG
)paren
op_logical_and
id|frwl-&gt;fw_nsp
OL
l_int|2
)paren
(brace
macro_line|#ifdef DEBUG_CONFIG_IP_FIREWALL
id|printk
c_func
(paren
l_string|&quot;ip_fw_ctl: src range set but fw_nsp=%d&bslash;n&quot;
comma
id|frwl-&gt;fw_nsp
)paren
suffix:semicolon
macro_line|#endif
r_return
l_int|NULL
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|frwl-&gt;fw_flg
op_amp
id|IP_FW_F_DRNG
)paren
op_logical_and
id|frwl-&gt;fw_ndp
OL
l_int|2
)paren
(brace
macro_line|#ifdef DEBUG_CONFIG_IP_FIREWALL
id|printk
c_func
(paren
l_string|&quot;ip_fw_ctl: dst range set but fw_ndp=%d&bslash;n&quot;
comma
id|frwl-&gt;fw_ndp
)paren
suffix:semicolon
macro_line|#endif
r_return
l_int|NULL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|frwl-&gt;fw_nsp
op_plus
id|frwl-&gt;fw_ndp
OG
id|IP_FW_MAX_PORTS
)paren
(brace
macro_line|#ifdef DEBUG_CONFIG_IP_FIREWALL
id|printk
c_func
(paren
l_string|&quot;ip_fw_ctl: too many ports (%d+%d)&bslash;n&quot;
comma
id|frwl-&gt;fw_nsp
comma
id|frwl-&gt;fw_ndp
)paren
suffix:semicolon
macro_line|#endif
r_return
l_int|NULL
suffix:semicolon
)brace
r_return
id|frwl
suffix:semicolon
)brace
macro_line|#ifdef CONFIG_IP_ACCT
macro_line|#if 0
r_void
id|ip_acct_cnt
c_func
(paren
r_struct
id|iphdr
op_star
id|iph
comma
r_struct
id|device
op_star
id|dev
comma
r_struct
id|ip_fw
op_star
id|f
)paren
(brace
(paren
r_void
)paren
id|ip_fw_chk
c_func
(paren
id|iph
comma
id|dev
comma
id|f
comma
l_int|0
comma
l_int|1
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
macro_line|#endif
DECL|function|ip_acct_ctl
r_int
id|ip_acct_ctl
c_func
(paren
r_int
id|stage
comma
r_void
op_star
id|m
comma
r_int
id|len
)paren
(brace
r_if
c_cond
(paren
id|stage
op_eq
id|IP_ACCT_FLUSH
)paren
(brace
id|free_fw_chain
c_func
(paren
op_amp
id|ip_acct_chain
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|stage
op_eq
id|IP_ACCT_ZERO
)paren
(brace
id|zero_fw_chain
c_func
(paren
id|ip_acct_chain
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|stage
op_eq
id|IP_ACCT_ADD
op_logical_or
id|stage
op_eq
id|IP_ACCT_DEL
)paren
(brace
r_struct
id|ip_fw
op_star
id|frwl
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|frwl
op_assign
id|check_ipfw_struct
c_func
(paren
id|m
comma
id|len
)paren
)paren
)paren
r_return
(paren
id|EINVAL
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|stage
)paren
(brace
r_case
id|IP_ACCT_ADD
suffix:colon
r_return
id|add_to_chain
c_func
(paren
op_amp
id|ip_acct_chain
comma
id|frwl
)paren
suffix:semicolon
r_case
id|IP_ACCT_DEL
suffix:colon
r_return
id|del_from_chain
c_func
(paren
op_amp
id|ip_acct_chain
comma
id|frwl
)paren
suffix:semicolon
r_default
suffix:colon
multiline_comment|/*&n; &t;&t;&t;&t; *&t;Should be panic but... (Why ??? - AC)&n;&t;&t;&t;&t; */
macro_line|#ifdef DEBUG_CONFIG_IP_FIREWALL
id|printk
c_func
(paren
l_string|&quot;ip_acct_ctl:  unknown request %d&bslash;n&quot;
comma
id|stage
)paren
suffix:semicolon
macro_line|#endif
r_return
id|EINVAL
suffix:semicolon
)brace
)brace
macro_line|#ifdef DEBUG_CONFIG_IP_FIREWALL
id|printk
c_func
(paren
l_string|&quot;ip_acct_ctl:  unknown request %d&bslash;n&quot;
comma
id|stage
)paren
suffix:semicolon
macro_line|#endif
r_return
id|EINVAL
suffix:semicolon
)brace
macro_line|#endif
macro_line|#ifdef CONFIG_IP_FIREWALL
DECL|function|ip_fw_ctl
r_int
id|ip_fw_ctl
c_func
(paren
r_int
id|stage
comma
r_void
op_star
id|m
comma
r_int
id|len
)paren
(brace
r_int
id|ret
suffix:semicolon
r_if
c_cond
(paren
id|stage
op_eq
id|IP_FW_FLUSH_BLK
)paren
(brace
id|free_fw_chain
c_func
(paren
op_amp
id|ip_fw_blk_chain
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|stage
op_eq
id|IP_FW_FLUSH_FWD
)paren
(brace
id|free_fw_chain
c_func
(paren
op_amp
id|ip_fw_fwd_chain
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|stage
op_eq
id|IP_FW_ZERO_BLK
)paren
(brace
id|zero_fw_chain
c_func
(paren
id|ip_fw_blk_chain
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|stage
op_eq
id|IP_FW_ZERO_FWD
)paren
(brace
id|zero_fw_chain
c_func
(paren
id|ip_fw_fwd_chain
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|stage
op_eq
id|IP_FW_POLICY_BLK
op_logical_or
id|stage
op_eq
id|IP_FW_POLICY_FWD
)paren
(brace
r_int
op_star
id|tmp_policy_ptr
suffix:semicolon
id|tmp_policy_ptr
op_assign
(paren
r_int
op_star
)paren
id|m
suffix:semicolon
r_if
c_cond
(paren
id|stage
op_eq
id|IP_FW_POLICY_BLK
)paren
id|ip_fw_blk_policy
op_assign
op_star
id|tmp_policy_ptr
suffix:semicolon
r_else
id|ip_fw_fwd_policy
op_assign
op_star
id|tmp_policy_ptr
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|stage
op_eq
id|IP_FW_CHK_BLK
op_logical_or
id|stage
op_eq
id|IP_FW_CHK_FWD
)paren
(brace
r_struct
id|device
id|viadev
suffix:semicolon
r_struct
id|ip_fwpkt
op_star
id|ipfwp
suffix:semicolon
r_struct
id|iphdr
op_star
id|ip
suffix:semicolon
r_if
c_cond
(paren
id|len
OL
r_sizeof
(paren
r_struct
id|ip_fwpkt
)paren
)paren
(brace
macro_line|#ifdef DEBUG_CONFIG_IP_FIREWALL
id|printk
c_func
(paren
l_string|&quot;ip_fw_ctl: length=%d, expected %d&bslash;n&quot;
comma
id|len
comma
r_sizeof
(paren
r_struct
id|ip_fwpkt
)paren
)paren
suffix:semicolon
macro_line|#endif
r_return
id|EINVAL
suffix:semicolon
)brace
id|ipfwp
op_assign
(paren
r_struct
id|ip_fwpkt
op_star
)paren
id|m
suffix:semicolon
id|ip
op_assign
op_amp
(paren
id|ipfwp-&gt;fwp_iph
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ip-&gt;ihl
op_ne
r_sizeof
(paren
r_struct
id|iphdr
)paren
op_div
r_sizeof
(paren
r_int
)paren
)paren
(brace
macro_line|#ifdef DEBUG_CONFIG_IP_FIREWALL
id|printk
c_func
(paren
l_string|&quot;ip_fw_ctl: ip-&gt;ihl=%d, want %d&bslash;n&quot;
comma
id|ip-&gt;ihl
comma
r_sizeof
(paren
r_struct
id|iphdr
)paren
op_div
r_sizeof
(paren
r_int
)paren
)paren
suffix:semicolon
macro_line|#endif
r_return
id|EINVAL
suffix:semicolon
)brace
id|viadev.pa_addr
op_assign
id|ipfwp-&gt;fwp_via.s_addr
suffix:semicolon
r_if
c_cond
(paren
(paren
id|ret
op_assign
id|ip_fw_chk
c_func
(paren
id|ip
comma
op_amp
id|viadev
comma
id|stage
op_eq
id|IP_FW_CHK_BLK
ques
c_cond
id|ip_fw_blk_chain
suffix:colon
id|ip_fw_fwd_chain
comma
id|stage
op_eq
id|IP_FW_CHK_BLK
ques
c_cond
id|ip_fw_blk_policy
suffix:colon
id|ip_fw_fwd_policy
comma
l_int|2
)paren
)paren
OG
l_int|0
)paren
r_return
l_int|0
suffix:semicolon
r_else
r_if
c_cond
(paren
id|ret
op_eq
op_minus
l_int|1
)paren
r_return
id|ECONNREFUSED
suffix:semicolon
r_else
r_return
id|ETIMEDOUT
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;Here we really working hard-adding new elements&n; *&t;to blocking/forwarding chains or deleting &squot;em&n; */
r_if
c_cond
(paren
id|stage
op_eq
id|IP_FW_ADD_BLK
op_logical_or
id|stage
op_eq
id|IP_FW_ADD_FWD
op_logical_or
id|stage
op_eq
id|IP_FW_DEL_BLK
op_logical_or
id|stage
op_eq
id|IP_FW_DEL_FWD
)paren
(brace
r_struct
id|ip_fw
op_star
id|frwl
suffix:semicolon
id|frwl
op_assign
id|check_ipfw_struct
c_func
(paren
id|m
comma
id|len
)paren
suffix:semicolon
r_if
c_cond
(paren
id|frwl
op_eq
l_int|NULL
)paren
r_return
(paren
id|EINVAL
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|stage
)paren
(brace
r_case
id|IP_FW_ADD_BLK
suffix:colon
r_return
id|add_to_chain
c_func
(paren
op_amp
id|ip_fw_blk_chain
comma
id|frwl
)paren
suffix:semicolon
r_case
id|IP_FW_ADD_FWD
suffix:colon
r_return
id|add_to_chain
c_func
(paren
op_amp
id|ip_fw_fwd_chain
comma
id|frwl
)paren
suffix:semicolon
r_case
id|IP_FW_DEL_BLK
suffix:colon
r_return
id|del_from_chain
c_func
(paren
op_amp
id|ip_fw_blk_chain
comma
id|frwl
)paren
suffix:semicolon
r_case
id|IP_FW_DEL_FWD
suffix:colon
r_return
id|del_from_chain
c_func
(paren
op_amp
id|ip_fw_fwd_chain
comma
id|frwl
)paren
suffix:semicolon
r_default
suffix:colon
multiline_comment|/*&n;&t; &t;&t; *&t;Should be panic but... (Why are BSD people panic obsessed ??)&n;&t;&t;&t; */
macro_line|#ifdef DEBUG_CONFIG_IP_FIREWALL
id|printk
c_func
(paren
l_string|&quot;ip_fw_ctl:  unknown request %d&bslash;n&quot;
comma
id|stage
)paren
suffix:semicolon
macro_line|#endif
r_return
id|EINVAL
suffix:semicolon
)brace
)brace
macro_line|#ifdef DEBUG_CONFIG_IP_FIREWALL
id|printk
c_func
(paren
l_string|&quot;ip_fw_ctl:  unknown request %d&bslash;n&quot;
comma
id|stage
)paren
suffix:semicolon
macro_line|#endif
r_return
id|EINVAL
suffix:semicolon
)brace
macro_line|#endif /* CONFIG_IP_FIREWALL */
macro_line|#if defined(CONFIG_IP_FIREWALL) || defined(CONFIG_IP_ACCT)
DECL|function|ip_chain_procinfo
r_static
r_int
id|ip_chain_procinfo
c_func
(paren
r_int
id|stage
comma
r_char
op_star
id|buffer
comma
r_char
op_star
op_star
id|start
comma
id|off_t
id|offset
comma
r_int
id|length
comma
r_int
id|reset
)paren
(brace
id|off_t
id|pos
op_assign
l_int|0
comma
id|begin
op_assign
l_int|0
suffix:semicolon
r_struct
id|ip_fw
op_star
id|i
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_int
id|len
comma
id|p
suffix:semicolon
r_switch
c_cond
(paren
id|stage
)paren
(brace
macro_line|#ifdef CONFIG_IP_FIREWALL
r_case
id|IP_INFO_BLK
suffix:colon
id|i
op_assign
id|ip_fw_blk_chain
suffix:semicolon
id|len
op_assign
id|sprintf
c_func
(paren
id|buffer
comma
l_string|&quot;IP firewall block rules, default %d&bslash;n&quot;
comma
id|ip_fw_blk_policy
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|IP_INFO_FWD
suffix:colon
id|i
op_assign
id|ip_fw_fwd_chain
suffix:semicolon
id|len
op_assign
id|sprintf
c_func
(paren
id|buffer
comma
l_string|&quot;IP firewall forward rules, default %d&bslash;n&quot;
comma
id|ip_fw_fwd_policy
)paren
suffix:semicolon
r_break
suffix:semicolon
macro_line|#endif
macro_line|#ifdef CONFIG_IP_ACCT
r_case
id|IP_INFO_ACCT
suffix:colon
id|i
op_assign
id|ip_acct_chain
suffix:semicolon
id|len
op_assign
id|sprintf
c_func
(paren
id|buffer
comma
l_string|&quot;IP accounting rules&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
macro_line|#endif
r_default
suffix:colon
multiline_comment|/* this should never be reached, but safety first... */
id|i
op_assign
l_int|NULL
suffix:semicolon
id|len
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
)brace
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
r_while
c_loop
(paren
id|i
op_ne
l_int|NULL
)paren
(brace
id|len
op_add_assign
id|sprintf
c_func
(paren
id|buffer
op_plus
id|len
comma
l_string|&quot;%08lX/%08lX-&gt;%08lX/%08lX %08lX %X &quot;
comma
id|ntohl
c_func
(paren
id|i-&gt;fw_src.s_addr
)paren
comma
id|ntohl
c_func
(paren
id|i-&gt;fw_smsk.s_addr
)paren
comma
id|ntohl
c_func
(paren
id|i-&gt;fw_dst.s_addr
)paren
comma
id|ntohl
c_func
(paren
id|i-&gt;fw_dmsk.s_addr
)paren
comma
id|ntohl
c_func
(paren
id|i-&gt;fw_via.s_addr
)paren
comma
id|i-&gt;fw_flg
)paren
suffix:semicolon
id|len
op_add_assign
id|sprintf
c_func
(paren
id|buffer
op_plus
id|len
comma
l_string|&quot;%u %u %-9lu %-9lu&quot;
comma
id|i-&gt;fw_nsp
comma
id|i-&gt;fw_ndp
comma
id|i-&gt;fw_pcnt
comma
id|i-&gt;fw_bcnt
)paren
suffix:semicolon
r_for
c_loop
(paren
id|p
op_assign
l_int|0
suffix:semicolon
id|p
OL
id|IP_FW_MAX_PORTS
suffix:semicolon
id|p
op_increment
)paren
id|len
op_add_assign
id|sprintf
c_func
(paren
id|buffer
op_plus
id|len
comma
l_string|&quot; %u&quot;
comma
id|i-&gt;fw_pts
(braket
id|p
)braket
)paren
suffix:semicolon
id|buffer
(braket
id|len
op_increment
)braket
op_assign
l_char|&squot;&bslash;n&squot;
suffix:semicolon
id|buffer
(braket
id|len
)braket
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
id|pos
op_assign
id|begin
op_plus
id|len
suffix:semicolon
r_if
c_cond
(paren
id|pos
OL
id|offset
)paren
(brace
id|len
op_assign
l_int|0
suffix:semicolon
id|begin
op_assign
id|pos
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|reset
)paren
(brace
multiline_comment|/* This needs to be done at this specific place! */
id|i-&gt;fw_pcnt
op_assign
l_int|0L
suffix:semicolon
id|i-&gt;fw_bcnt
op_assign
l_int|0L
suffix:semicolon
)brace
r_if
c_cond
(paren
id|pos
OG
id|offset
op_plus
id|length
)paren
(brace
r_break
suffix:semicolon
)brace
id|i
op_assign
id|i-&gt;fw_next
suffix:semicolon
)brace
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
op_star
id|start
op_assign
id|buffer
op_plus
(paren
id|offset
op_minus
id|begin
)paren
suffix:semicolon
id|len
op_sub_assign
(paren
id|offset
op_minus
id|begin
)paren
suffix:semicolon
r_if
c_cond
(paren
id|len
OG
id|length
)paren
(brace
id|len
op_assign
id|length
suffix:semicolon
)brace
r_return
id|len
suffix:semicolon
)brace
macro_line|#endif
macro_line|#ifdef CONFIG_IP_ACCT
DECL|function|ip_acct_procinfo
r_static
r_int
id|ip_acct_procinfo
c_func
(paren
r_char
op_star
id|buffer
comma
r_char
op_star
op_star
id|start
comma
id|off_t
id|offset
comma
r_int
id|length
comma
r_int
id|reset
)paren
(brace
r_return
id|ip_chain_procinfo
c_func
(paren
id|IP_INFO_ACCT
comma
id|buffer
comma
id|start
comma
id|offset
comma
id|length
comma
id|reset
)paren
suffix:semicolon
)brace
macro_line|#endif
macro_line|#ifdef CONFIG_IP_FIREWALL
DECL|function|ip_fw_blk_procinfo
r_static
r_int
id|ip_fw_blk_procinfo
c_func
(paren
r_char
op_star
id|buffer
comma
r_char
op_star
op_star
id|start
comma
id|off_t
id|offset
comma
r_int
id|length
comma
r_int
id|reset
)paren
(brace
r_return
id|ip_chain_procinfo
c_func
(paren
id|IP_INFO_BLK
comma
id|buffer
comma
id|start
comma
id|offset
comma
id|length
comma
id|reset
)paren
suffix:semicolon
)brace
DECL|function|ip_fw_fwd_procinfo
r_static
r_int
id|ip_fw_fwd_procinfo
c_func
(paren
r_char
op_star
id|buffer
comma
r_char
op_star
op_star
id|start
comma
id|off_t
id|offset
comma
r_int
id|length
comma
r_int
id|reset
)paren
(brace
r_return
id|ip_chain_procinfo
c_func
(paren
id|IP_INFO_FWD
comma
id|buffer
comma
id|start
comma
id|offset
comma
id|length
comma
id|reset
)paren
suffix:semicolon
)brace
macro_line|#endif
macro_line|#ifdef CONFIG_IP_MASQUERADE
DECL|function|ip_msqhst_procinfo
r_static
r_int
id|ip_msqhst_procinfo
c_func
(paren
r_char
op_star
id|buffer
comma
r_char
op_star
op_star
id|start
comma
id|off_t
id|offset
comma
r_int
id|length
)paren
(brace
id|off_t
id|pos
op_assign
l_int|0
comma
id|begin
op_assign
l_int|0
suffix:semicolon
r_struct
id|ip_masq
op_star
id|ms
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_int
id|len
op_assign
l_int|0
suffix:semicolon
id|len
op_assign
id|sprintf
c_func
(paren
id|buffer
comma
l_string|&quot;Prc FromIP   FPrt ToIP     TPrt Masq Init-seq Delta Expires&bslash;n&quot;
)paren
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|ms
op_assign
id|ip_msq_hosts
suffix:semicolon
r_while
c_loop
(paren
id|ms
op_ne
l_int|NULL
)paren
(brace
r_int
id|timer_active
op_assign
id|del_timer
c_func
(paren
op_amp
id|ms-&gt;timer
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|timer_active
)paren
id|ms-&gt;timer.expires
op_assign
id|jiffies
suffix:semicolon
id|len
op_add_assign
id|sprintf
c_func
(paren
id|buffer
op_plus
id|len
comma
l_string|&quot;%s %08lX:%04X %08lX:%04X %04X %08X %5d %lu&bslash;n&quot;
comma
id|strProt
(braket
id|ms-&gt;protocol
op_eq
id|IPPROTO_TCP
)braket
comma
id|ntohl
c_func
(paren
id|ms-&gt;src
)paren
comma
id|ntohs
c_func
(paren
id|ms-&gt;sport
)paren
comma
id|ntohl
c_func
(paren
id|ms-&gt;dst
)paren
comma
id|ntohs
c_func
(paren
id|ms-&gt;dport
)paren
comma
id|ntohs
c_func
(paren
id|ms-&gt;mport
)paren
comma
id|ms-&gt;init_seq
comma
id|ms-&gt;delta
comma
id|ms-&gt;timer.expires
op_minus
id|jiffies
)paren
suffix:semicolon
r_if
c_cond
(paren
id|timer_active
)paren
id|add_timer
c_func
(paren
op_amp
id|ms-&gt;timer
)paren
suffix:semicolon
id|pos
op_assign
id|begin
op_plus
id|len
suffix:semicolon
r_if
c_cond
(paren
id|pos
OL
id|offset
)paren
(brace
id|len
op_assign
l_int|0
suffix:semicolon
id|begin
op_assign
id|pos
suffix:semicolon
)brace
r_if
c_cond
(paren
id|pos
OG
id|offset
op_plus
id|length
)paren
(brace
r_break
suffix:semicolon
)brace
id|ms
op_assign
id|ms-&gt;next
suffix:semicolon
)brace
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
op_star
id|start
op_assign
id|buffer
op_plus
(paren
id|offset
op_minus
id|begin
)paren
suffix:semicolon
id|len
op_sub_assign
(paren
id|offset
op_minus
id|begin
)paren
suffix:semicolon
r_if
c_cond
(paren
id|len
OG
id|length
)paren
(brace
id|len
op_assign
id|length
suffix:semicolon
)brace
r_return
id|len
suffix:semicolon
)brace
macro_line|#endif
DECL|function|ip_fw_init
r_void
id|ip_fw_init
c_func
(paren
r_void
)paren
(brace
macro_line|#ifdef CONFIG_IP_ACCT
id|proc_net_register
c_func
(paren
op_amp
(paren
r_struct
id|proc_dir_entry
)paren
(brace
id|PROC_NET_IPACCT
comma
id|ip_acct_procinfo
comma
l_int|7
comma
l_string|&quot;ip_acct&quot;
)brace
)paren
suffix:semicolon
macro_line|#endif
macro_line|#ifdef CONFIG_IP_FIREWALL
id|proc_net_register
c_func
(paren
op_amp
(paren
r_struct
id|proc_dir_entry
)paren
(brace
id|PROC_NET_IPFWBLK
comma
id|ip_fw_blk_procinfo
comma
l_int|8
comma
l_string|&quot;ip_block&quot;
)brace
)paren
suffix:semicolon
id|proc_net_register
c_func
(paren
op_amp
(paren
r_struct
id|proc_dir_entry
)paren
(brace
id|PROC_NET_IPFWFWD
comma
id|ip_fw_fwd_procinfo
comma
l_int|10
comma
l_string|&quot;ip_forward&quot;
)brace
)paren
suffix:semicolon
macro_line|#endif
macro_line|#ifdef CONFIG_IP_MASQUERADE
id|proc_net_register
c_func
(paren
op_amp
(paren
r_struct
id|proc_dir_entry
)paren
(brace
id|PROC_NET_IPMSQHST
comma
id|ip_msqhst_procinfo
comma
l_int|13
comma
l_string|&quot;ip_masquerade&quot;
)brace
)paren
suffix:semicolon
macro_line|#endif
)brace
eof
