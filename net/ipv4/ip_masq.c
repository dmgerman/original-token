multiline_comment|/*&n; *&n; * &t;Masquerading functionality&n; *&n; * &t;Copyright (c) 1994 Pauline Middelink&n; *&n; *&t;$Id: ip_masq.c,v 1.35 1999/06/29 12:35:46 davem Exp $&n; *&n; *&n; *&t;See ip_fw.c for original log&n; *&n; * Fixes:&n; *&t;Juan Jose Ciarlante&t;:&t;Modularized application masquerading (see ip_masq_app.c)&n; *&t;Juan Jose Ciarlante&t;:&t;New struct ip_masq_seq that holds output/input delta seq.&n; *&t;Juan Jose Ciarlante&t;:&t;Added hashed lookup by proto,maddr,mport and proto,saddr,sport&n; *&t;Juan Jose Ciarlante&t;:&t;Fixed deadlock if free ports get exhausted&n; *&t;Juan Jose Ciarlante&t;:&t;Added NO_ADDR status flag.&n; *&t;Richard Lynch&t;&t;:&t;Added IP Autoforward&n; *&t;Nigel Metheringham&t;:&t;Added ICMP handling for demasquerade&n; *&t;Nigel Metheringham&t;:&t;Checksum checking of masqueraded data&n; *&t;Nigel Metheringham&t;:&t;Better handling of timeouts of TCP conns&n; *&t;Delian Delchev&t;&t;:&t;Added support for ICMP requests and replys&n; *&t;Nigel Metheringham&t;:&t;ICMP in ICMP handling, tidy ups, bug fixes, made ICMP optional&n; *&t;Juan Jose Ciarlante&t;:&t;re-assign maddr if no packet received from outside&n; *&t;Juan Jose Ciarlante&t;:&t;ported to 2.1 tree&n; *&t;Juan Jose Ciarlante&t;:&t;reworked control connections&n; *&t;Steven Clarke&t;&t;:&t;Added Port Forwarding&n; *&t;Juan Jose Ciarlante&t;:&t;Just ONE ip_masq_new (!)&n; *&t;Juan Jose Ciarlante&t;:&t;IP masq modules support&n; *&t;Juan Jose Ciarlante&t;:&t;don&squot;t go into search loop if mport specified&n; *&t;Juan Jose Ciarlante&t;:&t;locking&n; *&t;Steven Clarke&t;&t;:&t;IP_MASQ_S_xx state design&n; *&t;Juan Jose Ciarlante&t;:&t;IP_MASQ_S state implementation &n; *&t;Juan Jose Ciarlante&t;: &t;xx_get() clears timer, _put() inserts it&n; *&t;Juan Jose Ciarlante&t;: &t;create /proc/net/ip_masq/ &n; *&t;Juan Jose Ciarlante&t;: &t;reworked checksums (save payload csum if possible)&n; *&t;Juan Jose Ciarlante&t;: &t;added missing ip_fw_masquerade checksum&n; *&t;Juan Jose Ciarlante&t;: &t;csum savings&n; *&t;Juan Jose Ciarlante&t;: &t;added user-space tunnel creation/del, etc&n; *&t;Juan Jose Ciarlante&t;: &t;(last) moved to ip_masq_user runtime module&n; *&t;Juan Jose Ciarlante&t;: &t;user timeout handling again&n; *&t;Juan Jose Ciarlante&t;: &t;make new modules support optional&n; *&t;Juan Jose Ciarlante&t;: &t;u-space context =&gt; locks reworked&n; *&t;Juan Jose Ciarlante&t;: &t;fixed stupid SMP locking bug&n; *&t;Juan Jose Ciarlante&t;: &t;fixed &quot;tap&quot;ing in demasq path by copy-on-w&n; *&t;Juan Jose Ciarlante&t;: &t;make masq_proto_doff() robust against fake sized/corrupted packets&n; *&t;Kai Bankett&t;&t;:&t;do not toss other IP protos in proto_doff()&n; *&t;Dan Kegel&t;&t;:&t;pointed correct NAT behavior for UDP streams&n; *&t;&n; */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#ifdef CONFIG_KMOD
macro_line|#include &lt;linux/kmod.h&gt;
macro_line|#endif
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/skbuff.h&gt;
macro_line|#include &lt;asm/system.h&gt;
macro_line|#include &lt;linux/stat.h&gt;
macro_line|#include &lt;linux/proc_fs.h&gt;
macro_line|#include &lt;linux/in.h&gt;
macro_line|#include &lt;linux/ip.h&gt;
macro_line|#include &lt;linux/inet.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;net/protocol.h&gt;
macro_line|#include &lt;net/icmp.h&gt;
macro_line|#include &lt;net/tcp.h&gt;
macro_line|#include &lt;net/udp.h&gt;
macro_line|#include &lt;net/checksum.h&gt;
macro_line|#include &lt;net/ip_masq.h&gt;
macro_line|#ifdef CONFIG_IP_MASQUERADE_MOD
macro_line|#include &lt;net/ip_masq_mod.h&gt;
macro_line|#endif
macro_line|#include &lt;linux/sysctl.h&gt;
macro_line|#include &lt;linux/ip_fw.h&gt;
macro_line|#include &lt;linux/ip_masq.h&gt;
DECL|variable|sysctl_ip_masq_debug
r_int
id|sysctl_ip_masq_debug
op_assign
l_int|0
suffix:semicolon
multiline_comment|/*&n; *&t;Exported wrapper &n; */
DECL|function|ip_masq_get_debug_level
r_int
id|ip_masq_get_debug_level
c_func
(paren
r_void
)paren
(brace
r_return
id|sysctl_ip_masq_debug
suffix:semicolon
)brace
DECL|variable|ip_masq_user_hook
r_struct
id|ip_masq_hook
op_star
id|ip_masq_user_hook
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/*&n; *&t;Timeout table[state]&n; */
multiline_comment|/* static int masq_timeout_table[IP_MASQ_S_LAST+1] = { */
DECL|variable|masq_timeout_table
r_static
r_struct
id|ip_masq_timeout_table
id|masq_timeout_table
op_assign
(brace
id|ATOMIC_INIT
c_func
(paren
l_int|0
)paren
comma
multiline_comment|/* refcnt */
l_int|0
comma
multiline_comment|/* scale  */
(brace
l_int|30
op_star
l_int|60
op_star
id|HZ
comma
multiline_comment|/*&t;IP_MASQ_S_NONE,&t;*/
l_int|15
op_star
l_int|60
op_star
id|HZ
comma
multiline_comment|/*&t;IP_MASQ_S_ESTABLISHED,&t;*/
l_int|2
op_star
l_int|60
op_star
id|HZ
comma
multiline_comment|/*&t;IP_MASQ_S_SYN_SENT,&t;*/
l_int|1
op_star
l_int|60
op_star
id|HZ
comma
multiline_comment|/*&t;IP_MASQ_S_SYN_RECV,&t;*/
l_int|2
op_star
l_int|60
op_star
id|HZ
comma
multiline_comment|/*&t;IP_MASQ_S_FIN_WAIT,&t;*/
l_int|2
op_star
l_int|60
op_star
id|HZ
comma
multiline_comment|/*&t;IP_MASQ_S_TIME_WAIT,&t;*/
l_int|10
op_star
id|HZ
comma
multiline_comment|/*&t;IP_MASQ_S_CLOSE,&t;*/
l_int|60
op_star
id|HZ
comma
multiline_comment|/*&t;IP_MASQ_S_CLOSE_WAIT,&t;*/
l_int|30
op_star
id|HZ
comma
multiline_comment|/*&t;IP_MASQ_S_LAST_ACK,&t;*/
l_int|2
op_star
l_int|60
op_star
id|HZ
comma
multiline_comment|/*&t;IP_MASQ_S_LISTEN,&t;*/
l_int|5
op_star
l_int|60
op_star
id|HZ
comma
multiline_comment|/*&t;IP_MASQ_S_UDP,&t;*/
l_int|1
op_star
l_int|60
op_star
id|HZ
comma
multiline_comment|/*&t;IP_MASQ_S_ICMP,&t;*/
l_int|2
op_star
id|HZ
comma
multiline_comment|/*&t;IP_MASQ_S_LAST&t;*/
)brace
comma
multiline_comment|/* timeout */
)brace
suffix:semicolon
DECL|macro|MASQUERADE_EXPIRE_RETRY
mdefine_line|#define MASQUERADE_EXPIRE_RETRY      masq_timeout_table.timeout[IP_MASQ_S_TIME_WAIT]
DECL|variable|state_name_table
r_static
r_const
r_char
op_star
id|state_name_table
(braket
id|IP_MASQ_S_LAST
op_plus
l_int|1
)braket
op_assign
(brace
l_string|&quot;NONE&quot;
comma
multiline_comment|/*&t;IP_MASQ_S_NONE,&t;*/
l_string|&quot;ESTABLISHED&quot;
comma
multiline_comment|/*&t;IP_MASQ_S_ESTABLISHED,&t;*/
l_string|&quot;SYN_SENT&quot;
comma
multiline_comment|/*&t;IP_MASQ_S_SYN_SENT,&t;*/
l_string|&quot;SYN_RECV&quot;
comma
multiline_comment|/*&t;IP_MASQ_S_SYN_RECV,&t;*/
l_string|&quot;FIN_WAIT&quot;
comma
multiline_comment|/*&t;IP_MASQ_S_FIN_WAIT,&t;*/
l_string|&quot;TIME_WAIT&quot;
comma
multiline_comment|/*&t;IP_MASQ_S_TIME_WAIT,&t;*/
l_string|&quot;CLOSE&quot;
comma
multiline_comment|/*&t;IP_MASQ_S_CLOSE,&t;*/
l_string|&quot;CLOSE_WAIT&quot;
comma
multiline_comment|/*&t;IP_MASQ_S_CLOSE_WAIT,&t;*/
l_string|&quot;LAST_ACK&quot;
comma
multiline_comment|/*&t;IP_MASQ_S_LAST_ACK,&t;*/
l_string|&quot;LISTEN&quot;
comma
multiline_comment|/*&t;IP_MASQ_S_LISTEN,&t;*/
l_string|&quot;UDP&quot;
comma
multiline_comment|/*&t;IP_MASQ_S_UDP,&t;*/
l_string|&quot;ICMP&quot;
comma
multiline_comment|/*&t;IP_MASQ_S_ICMP,&t;*/
l_string|&quot;BUG!&quot;
comma
multiline_comment|/*&t;IP_MASQ_S_LAST&t;*/
)brace
suffix:semicolon
DECL|macro|mNO
mdefine_line|#define mNO IP_MASQ_S_NONE
DECL|macro|mES
mdefine_line|#define mES IP_MASQ_S_ESTABLISHED
DECL|macro|mSS
mdefine_line|#define mSS IP_MASQ_S_SYN_SENT
DECL|macro|mSR
mdefine_line|#define mSR IP_MASQ_S_SYN_RECV
DECL|macro|mFW
mdefine_line|#define mFW IP_MASQ_S_FIN_WAIT
DECL|macro|mTW
mdefine_line|#define mTW IP_MASQ_S_TIME_WAIT
DECL|macro|mCL
mdefine_line|#define mCL IP_MASQ_S_CLOSE
DECL|macro|mCW
mdefine_line|#define mCW IP_MASQ_S_CLOSE_WAIT
DECL|macro|mLA
mdefine_line|#define mLA IP_MASQ_S_LAST_ACK
DECL|macro|mLI
mdefine_line|#define mLI IP_MASQ_S_LISTEN
DECL|struct|masq_tcp_states_t
r_struct
id|masq_tcp_states_t
(brace
DECL|member|next_state
r_int
id|next_state
(braket
id|IP_MASQ_S_LAST
)braket
suffix:semicolon
multiline_comment|/* should be _LAST_TCP */
)brace
suffix:semicolon
DECL|function|ip_masq_state_name
r_const
r_char
op_star
id|ip_masq_state_name
c_func
(paren
r_int
id|state
)paren
(brace
r_if
c_cond
(paren
id|state
op_ge
id|IP_MASQ_S_LAST
)paren
r_return
l_string|&quot;ERR!&quot;
suffix:semicolon
r_return
id|state_name_table
(braket
id|state
)braket
suffix:semicolon
)brace
DECL|variable|masq_tcp_states
r_struct
id|masq_tcp_states_t
id|masq_tcp_states
(braket
)braket
op_assign
(brace
multiline_comment|/*&t;INPUT */
multiline_comment|/* &t;  mNO, mES, mSS, mSR, mFW, mTW, mCL, mCW, mLA, mLI &t;*/
multiline_comment|/*syn*/
(brace
(brace
id|mSR
comma
id|mES
comma
id|mES
comma
id|mSR
comma
id|mSR
comma
id|mSR
comma
id|mSR
comma
id|mSR
comma
id|mSR
comma
id|mSR
)brace
)brace
comma
multiline_comment|/*fin*/
(brace
(brace
id|mCL
comma
id|mCW
comma
id|mSS
comma
id|mTW
comma
id|mTW
comma
id|mTW
comma
id|mCL
comma
id|mCW
comma
id|mLA
comma
id|mLI
)brace
)brace
comma
multiline_comment|/*ack*/
(brace
(brace
id|mCL
comma
id|mES
comma
id|mSS
comma
id|mSR
comma
id|mFW
comma
id|mTW
comma
id|mCL
comma
id|mCW
comma
id|mCL
comma
id|mLI
)brace
)brace
comma
multiline_comment|/*rst*/
(brace
(brace
id|mCL
comma
id|mCL
comma
id|mCL
comma
id|mSR
comma
id|mCL
comma
id|mCL
comma
id|mCL
comma
id|mCL
comma
id|mLA
comma
id|mLI
)brace
)brace
comma
multiline_comment|/*&t;OUTPUT */
multiline_comment|/* &t;  mNO, mES, mSS, mSR, mFW, mTW, mCL, mCW, mLA, mLI &t;*/
multiline_comment|/*syn*/
(brace
(brace
id|mSS
comma
id|mES
comma
id|mSS
comma
id|mES
comma
id|mSS
comma
id|mSS
comma
id|mSS
comma
id|mSS
comma
id|mSS
comma
id|mLI
)brace
)brace
comma
multiline_comment|/*fin*/
(brace
(brace
id|mTW
comma
id|mFW
comma
id|mSS
comma
id|mTW
comma
id|mFW
comma
id|mTW
comma
id|mCL
comma
id|mTW
comma
id|mLA
comma
id|mLI
)brace
)brace
comma
multiline_comment|/*ack*/
(brace
(brace
id|mES
comma
id|mES
comma
id|mSS
comma
id|mSR
comma
id|mFW
comma
id|mTW
comma
id|mCL
comma
id|mCW
comma
id|mLA
comma
id|mES
)brace
)brace
comma
multiline_comment|/*rst*/
(brace
(brace
id|mCL
comma
id|mCL
comma
id|mSS
comma
id|mCL
comma
id|mCL
comma
id|mTW
comma
id|mCL
comma
id|mCL
comma
id|mCL
comma
id|mCL
)brace
)brace
comma
)brace
suffix:semicolon
DECL|function|masq_tcp_state_idx
r_static
id|__inline__
r_int
id|masq_tcp_state_idx
c_func
(paren
r_struct
id|tcphdr
op_star
id|th
comma
r_int
id|output
)paren
(brace
multiline_comment|/*&n;&t; *&t;[0-3]: input states, [4-7]: output.&n;&t; */
r_if
c_cond
(paren
id|output
)paren
id|output
op_assign
l_int|4
suffix:semicolon
r_if
c_cond
(paren
id|th-&gt;rst
)paren
r_return
id|output
op_plus
l_int|3
suffix:semicolon
r_if
c_cond
(paren
id|th-&gt;syn
)paren
r_return
id|output
op_plus
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|th-&gt;fin
)paren
r_return
id|output
op_plus
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|th-&gt;ack
)paren
r_return
id|output
op_plus
l_int|2
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
DECL|function|masq_set_state_timeout
r_static
r_int
id|masq_set_state_timeout
c_func
(paren
r_struct
id|ip_masq
op_star
id|ms
comma
r_int
id|state
)paren
(brace
r_struct
id|ip_masq_timeout_table
op_star
id|mstim
op_assign
id|ms-&gt;timeout_table
suffix:semicolon
r_int
id|scale
suffix:semicolon
multiline_comment|/*&n;&t; *&t;Use default timeout table if no specific for this entry&n;&t; */
r_if
c_cond
(paren
op_logical_neg
id|mstim
)paren
id|mstim
op_assign
op_amp
id|masq_timeout_table
suffix:semicolon
id|ms-&gt;timeout
op_assign
id|mstim-&gt;timeout
(braket
id|ms-&gt;state
op_assign
id|state
)braket
suffix:semicolon
id|scale
op_assign
id|mstim-&gt;scale
suffix:semicolon
r_if
c_cond
(paren
id|scale
OL
l_int|0
)paren
id|ms-&gt;timeout
op_rshift_assign
op_minus
id|scale
suffix:semicolon
r_else
r_if
c_cond
(paren
id|scale
OG
l_int|0
)paren
id|ms-&gt;timeout
op_lshift_assign
id|scale
suffix:semicolon
r_return
id|state
suffix:semicolon
)brace
DECL|function|masq_tcp_state
r_static
r_int
id|masq_tcp_state
c_func
(paren
r_struct
id|ip_masq
op_star
id|ms
comma
r_int
id|output
comma
r_struct
id|tcphdr
op_star
id|th
)paren
(brace
r_int
id|state_idx
suffix:semicolon
r_int
id|new_state
op_assign
id|IP_MASQ_S_CLOSE
suffix:semicolon
r_if
c_cond
(paren
(paren
id|state_idx
op_assign
id|masq_tcp_state_idx
c_func
(paren
id|th
comma
id|output
)paren
)paren
OL
l_int|0
)paren
(brace
id|IP_MASQ_DEBUG
c_func
(paren
l_int|1
comma
l_string|&quot;masq_state_idx(%d)=%d!!!&bslash;n&quot;
comma
id|output
comma
id|state_idx
)paren
suffix:semicolon
r_goto
id|tcp_state_out
suffix:semicolon
)brace
id|new_state
op_assign
id|masq_tcp_states
(braket
id|state_idx
)braket
dot
id|next_state
(braket
id|ms-&gt;state
)braket
suffix:semicolon
id|tcp_state_out
suffix:colon
r_if
c_cond
(paren
id|new_state
op_ne
id|ms-&gt;state
)paren
id|IP_MASQ_DEBUG
c_func
(paren
l_int|1
comma
l_string|&quot;%s %s [%c%c%c%c] %08lX:%04X-%08lX:%04X state: %s-&gt;%s&bslash;n&quot;
comma
id|masq_proto_name
c_func
(paren
id|ms-&gt;protocol
)paren
comma
id|output
ques
c_cond
l_string|&quot;output&quot;
suffix:colon
l_string|&quot;input &quot;
comma
id|th-&gt;syn
ques
c_cond
l_char|&squot;S&squot;
suffix:colon
l_char|&squot;.&squot;
comma
id|th-&gt;fin
ques
c_cond
l_char|&squot;F&squot;
suffix:colon
l_char|&squot;.&squot;
comma
id|th-&gt;ack
ques
c_cond
l_char|&squot;A&squot;
suffix:colon
l_char|&squot;.&squot;
comma
id|th-&gt;rst
ques
c_cond
l_char|&squot;R&squot;
suffix:colon
l_char|&squot;.&squot;
comma
id|ntohl
c_func
(paren
id|ms-&gt;saddr
)paren
comma
id|ntohs
c_func
(paren
id|ms-&gt;sport
)paren
comma
id|ntohl
c_func
(paren
id|ms-&gt;daddr
)paren
comma
id|ntohs
c_func
(paren
id|ms-&gt;dport
)paren
comma
id|ip_masq_state_name
c_func
(paren
id|ms-&gt;state
)paren
comma
id|ip_masq_state_name
c_func
(paren
id|new_state
)paren
)paren
suffix:semicolon
r_return
id|masq_set_state_timeout
c_func
(paren
id|ms
comma
id|new_state
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;Handle state transitions&n; */
DECL|function|masq_set_state
r_static
r_int
id|masq_set_state
c_func
(paren
r_struct
id|ip_masq
op_star
id|ms
comma
r_int
id|output
comma
r_struct
id|iphdr
op_star
id|iph
comma
r_void
op_star
id|tp
)paren
(brace
r_switch
c_cond
(paren
id|iph-&gt;protocol
)paren
(brace
r_case
id|IPPROTO_ICMP
suffix:colon
r_return
id|masq_set_state_timeout
c_func
(paren
id|ms
comma
id|IP_MASQ_S_ICMP
)paren
suffix:semicolon
r_case
id|IPPROTO_UDP
suffix:colon
r_return
id|masq_set_state_timeout
c_func
(paren
id|ms
comma
id|IP_MASQ_S_UDP
)paren
suffix:semicolon
r_case
id|IPPROTO_TCP
suffix:colon
r_return
id|masq_tcp_state
c_func
(paren
id|ms
comma
id|output
comma
id|tp
)paren
suffix:semicolon
)brace
r_return
op_minus
l_int|1
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;Set LISTEN timeout. (ip_masq_put will setup timer)&n; */
DECL|function|ip_masq_listen
r_int
id|ip_masq_listen
c_func
(paren
r_struct
id|ip_masq
op_star
id|ms
)paren
(brace
id|masq_set_state_timeout
c_func
(paren
id|ms
comma
id|IP_MASQ_S_LISTEN
)paren
suffix:semicolon
r_return
id|ms-&gt;timeout
suffix:semicolon
)brace
multiline_comment|/* &n; *&t;Dynamic address rewriting &n; */
r_extern
r_int
id|sysctl_ip_dynaddr
suffix:semicolon
multiline_comment|/*&n; *&t;Lookup lock&n; */
DECL|variable|__ip_masq_lock
id|rwlock_t
id|__ip_masq_lock
op_assign
id|RW_LOCK_UNLOCKED
suffix:semicolon
multiline_comment|/*&n; *&t;Implement IP packet masquerading&n; */
multiline_comment|/*&n; * Converts an ICMP reply code into the equivalent request code&n; */
DECL|function|icmp_type_request
r_static
id|__inline__
r_const
id|__u8
id|icmp_type_request
c_func
(paren
id|__u8
id|type
)paren
(brace
r_switch
c_cond
(paren
id|type
)paren
(brace
r_case
id|ICMP_ECHOREPLY
suffix:colon
r_return
id|ICMP_ECHO
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ICMP_TIMESTAMPREPLY
suffix:colon
r_return
id|ICMP_TIMESTAMP
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ICMP_INFO_REPLY
suffix:colon
r_return
id|ICMP_INFO_REQUEST
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ICMP_ADDRESSREPLY
suffix:colon
r_return
id|ICMP_ADDRESS
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
r_return
(paren
l_int|255
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
multiline_comment|/*&n; * Helper macros - attempt to make code clearer! &n; */
multiline_comment|/* ID used in ICMP lookups */
DECL|macro|icmp_id
mdefine_line|#define icmp_id(icmph)&t;&t;((icmph-&gt;un).echo.id)
multiline_comment|/* (port) hash value using in ICMP lookups for requests */
DECL|macro|icmp_hv_req
mdefine_line|#define icmp_hv_req(icmph)&t;((__u16)(icmph-&gt;code+(__u16)(icmph-&gt;type&lt;&lt;8)))
multiline_comment|/* (port) hash value using in ICMP lookups for replies */
DECL|macro|icmp_hv_rep
mdefine_line|#define icmp_hv_rep(icmph)&t;((__u16)(icmph-&gt;code+(__u16)(icmp_type_request(icmph-&gt;type)&lt;&lt;8)))
multiline_comment|/*&n; *&t;Last masq_port number in use.&n; *&t;Will cycle in MASQ_PORT boundaries.&n; */
DECL|variable|masq_port
r_static
id|__u16
id|masq_port
op_assign
id|PORT_MASQ_BEGIN
suffix:semicolon
DECL|variable|masq_port_lock
r_static
id|spinlock_t
id|masq_port_lock
op_assign
id|SPIN_LOCK_UNLOCKED
suffix:semicolon
multiline_comment|/*&n; *&t;free ports counters (UDP &amp; TCP)&n; *&n; *&t;Their value is _less_ or _equal_ to actual free ports:&n; *&t;same masq port, diff masq addr (firewall iface address) allocated&n; *&t;entries are accounted but their actually don&squot;t eat a more than 1 port.&n; *&n; *&t;Greater values could lower MASQ_EXPIRATION setting as a way to&n; *&t;manage &squot;masq_entries resource&squot;.&n; *&n; *&t;By default we will reuse masq.port iff (output) connection&n; *&t;(5-upla) if not duplicated. &n; *&t;This may break midentd and others ...&n; */
macro_line|#ifdef CONFIG_IP_MASQ_NREUSE
DECL|macro|PORT_MASQ_MUL
mdefine_line|#define PORT_MASQ_MUL 1
macro_line|#else
DECL|macro|PORT_MASQ_MUL
mdefine_line|#define PORT_MASQ_MUL 10
macro_line|#endif
multiline_comment|/*&n; *&t;At the moment, hardcore in sync with masq_proto_num&n; */
DECL|variable|ip_masq_free_ports
id|atomic_t
id|ip_masq_free_ports
(braket
l_int|3
)braket
op_assign
(brace
id|ATOMIC_INIT
c_func
(paren
(paren
id|PORT_MASQ_END
op_minus
id|PORT_MASQ_BEGIN
)paren
op_star
id|PORT_MASQ_MUL
)paren
comma
multiline_comment|/* UDP */
id|ATOMIC_INIT
c_func
(paren
(paren
id|PORT_MASQ_END
op_minus
id|PORT_MASQ_BEGIN
)paren
op_star
id|PORT_MASQ_MUL
)paren
comma
multiline_comment|/* TCP */
id|ATOMIC_INIT
c_func
(paren
(paren
id|PORT_MASQ_END
op_minus
id|PORT_MASQ_BEGIN
)paren
op_star
id|PORT_MASQ_MUL
)paren
comma
multiline_comment|/* ICMP */
)brace
suffix:semicolon
multiline_comment|/*&n; *&t;Counts entries that have been requested with specific mport.&n; *&t;Used for incoming packets to &quot;relax&quot; input rule (port in MASQ range).&n; */
DECL|variable|mport_count
id|atomic_t
id|mport_count
op_assign
id|ATOMIC_INIT
c_func
(paren
l_int|0
)paren
suffix:semicolon
DECL|variable|ip_masq_get_debug_level
id|EXPORT_SYMBOL
c_func
(paren
id|ip_masq_get_debug_level
)paren
suffix:semicolon
DECL|variable|ip_masq_new
id|EXPORT_SYMBOL
c_func
(paren
id|ip_masq_new
)paren
suffix:semicolon
DECL|variable|ip_masq_listen
id|EXPORT_SYMBOL
c_func
(paren
id|ip_masq_listen
)paren
suffix:semicolon
DECL|variable|ip_masq_free_ports
id|EXPORT_SYMBOL
c_func
(paren
id|ip_masq_free_ports
)paren
suffix:semicolon
DECL|variable|ip_masq_out_get
id|EXPORT_SYMBOL
c_func
(paren
id|ip_masq_out_get
)paren
suffix:semicolon
DECL|variable|ip_masq_in_get
id|EXPORT_SYMBOL
c_func
(paren
id|ip_masq_in_get
)paren
suffix:semicolon
DECL|variable|ip_masq_put
id|EXPORT_SYMBOL
c_func
(paren
id|ip_masq_put
)paren
suffix:semicolon
DECL|variable|ip_masq_control_add
id|EXPORT_SYMBOL
c_func
(paren
id|ip_masq_control_add
)paren
suffix:semicolon
DECL|variable|ip_masq_control_del
id|EXPORT_SYMBOL
c_func
(paren
id|ip_masq_control_del
)paren
suffix:semicolon
DECL|variable|ip_masq_control_get
id|EXPORT_SYMBOL
c_func
(paren
id|ip_masq_control_get
)paren
suffix:semicolon
DECL|variable|ip_masq_user_hook
id|EXPORT_SYMBOL
c_func
(paren
id|ip_masq_user_hook
)paren
suffix:semicolon
DECL|variable|ip_masq_m_tab
id|EXPORT_SYMBOL
c_func
(paren
id|ip_masq_m_tab
)paren
suffix:semicolon
DECL|variable|ip_masq_state_name
id|EXPORT_SYMBOL
c_func
(paren
id|ip_masq_state_name
)paren
suffix:semicolon
DECL|variable|ip_masq_select_addr
id|EXPORT_SYMBOL
c_func
(paren
id|ip_masq_select_addr
)paren
suffix:semicolon
DECL|variable|__ip_masq_lock
id|EXPORT_SYMBOL
c_func
(paren
id|__ip_masq_lock
)paren
suffix:semicolon
multiline_comment|/*&n; *&t;2 ip_masq hash tables: for input and output pkts lookups.&n; */
DECL|variable|ip_masq_m_tab
r_struct
id|ip_masq
op_star
id|ip_masq_m_tab
(braket
id|IP_MASQ_TAB_SIZE
)braket
suffix:semicolon
DECL|variable|ip_masq_s_tab
r_struct
id|ip_masq
op_star
id|ip_masq_s_tab
(braket
id|IP_MASQ_TAB_SIZE
)braket
suffix:semicolon
multiline_comment|/*&n; * timeouts&n; */
macro_line|#if 000 /* FIXED timeout handling */
r_static
r_struct
id|ip_fw_masq
id|ip_masq_dummy
op_assign
(brace
id|MASQUERADE_EXPIRE_TCP
comma
id|MASQUERADE_EXPIRE_TCP_FIN
comma
id|MASQUERADE_EXPIRE_UDP
)brace
suffix:semicolon
id|EXPORT_SYMBOL
c_func
(paren
id|ip_masq_expire
)paren
suffix:semicolon
r_struct
id|ip_fw_masq
op_star
id|ip_masq_expire
op_assign
op_amp
id|ip_masq_dummy
suffix:semicolon
macro_line|#endif
multiline_comment|/*&n; *&t;These flags enable non-strict d{addr,port} checks&n; *&t;Given that both (in/out) lookup tables are hashed&n; *&t;by m{addr,port} and s{addr,port} this is quite easy &n; */
DECL|macro|MASQ_DADDR_PASS
mdefine_line|#define MASQ_DADDR_PASS&t;(IP_MASQ_F_NO_DADDR|IP_MASQ_F_DLOOSE)
DECL|macro|MASQ_DPORT_PASS
mdefine_line|#define MASQ_DPORT_PASS&t;(IP_MASQ_F_NO_DPORT|IP_MASQ_F_DLOOSE)
multiline_comment|/*&n; *&t;By default enable dest loose semantics&n; */
DECL|macro|CONFIG_IP_MASQ_LOOSE_DEFAULT
mdefine_line|#define CONFIG_IP_MASQ_LOOSE_DEFAULT 1
multiline_comment|/*&n; * &t;Set masq expiration (deletion) and adds timer,&n; *&t;if timeout==0 cancel expiration.&n; *&t;Warning: it does not check/delete previous timer!&n; */
DECL|function|__ip_masq_set_expire
r_static
r_void
id|__ip_masq_set_expire
c_func
(paren
r_struct
id|ip_masq
op_star
id|ms
comma
r_int
r_int
id|tout
)paren
(brace
r_if
c_cond
(paren
id|tout
)paren
(brace
id|ms-&gt;timer.expires
op_assign
id|jiffies
op_plus
id|tout
suffix:semicolon
id|add_timer
c_func
(paren
op_amp
id|ms-&gt;timer
)paren
suffix:semicolon
)brace
r_else
(brace
id|del_timer
c_func
(paren
op_amp
id|ms-&gt;timer
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/*&n; *&t;Returns hash value&n; */
r_static
id|__inline__
r_int
DECL|function|ip_masq_hash_key
id|ip_masq_hash_key
c_func
(paren
r_int
id|proto
comma
id|__u32
id|addr
comma
id|__u16
id|port
)paren
(brace
r_return
(paren
id|proto
op_xor
id|ntohl
c_func
(paren
id|addr
)paren
op_xor
id|ntohs
c_func
(paren
id|port
)paren
)paren
op_amp
(paren
id|IP_MASQ_TAB_SIZE
op_minus
l_int|1
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;Hashes ip_masq by its proto,addrs,ports.&n; *&t;should be called with locked tables.&n; *&t;returns bool success.&n; */
DECL|function|ip_masq_hash
r_static
r_int
id|ip_masq_hash
c_func
(paren
r_struct
id|ip_masq
op_star
id|ms
)paren
(brace
r_int
id|hash
suffix:semicolon
r_if
c_cond
(paren
id|ms-&gt;flags
op_amp
id|IP_MASQ_F_HASHED
)paren
(brace
id|IP_MASQ_ERR
c_func
(paren
l_string|&quot;ip_masq_hash(): request for already hashed, called from %p&bslash;n&quot;
comma
id|__builtin_return_address
c_func
(paren
l_int|0
)paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n;         *&t;Hash by proto,m{addr,port}&n;         */
id|hash
op_assign
id|ip_masq_hash_key
c_func
(paren
id|ms-&gt;protocol
comma
id|ms-&gt;maddr
comma
id|ms-&gt;mport
)paren
suffix:semicolon
id|ms-&gt;m_link
op_assign
id|ip_masq_m_tab
(braket
id|hash
)braket
suffix:semicolon
id|atomic_inc
c_func
(paren
op_amp
id|ms-&gt;refcnt
)paren
suffix:semicolon
id|ip_masq_m_tab
(braket
id|hash
)braket
op_assign
id|ms
suffix:semicolon
multiline_comment|/*&n;         *&t;Hash by proto,s{addr,port}&n;         */
id|hash
op_assign
id|ip_masq_hash_key
c_func
(paren
id|ms-&gt;protocol
comma
id|ms-&gt;saddr
comma
id|ms-&gt;sport
)paren
suffix:semicolon
id|ms-&gt;s_link
op_assign
id|ip_masq_s_tab
(braket
id|hash
)braket
suffix:semicolon
id|atomic_inc
c_func
(paren
op_amp
id|ms-&gt;refcnt
)paren
suffix:semicolon
id|ip_masq_s_tab
(braket
id|hash
)braket
op_assign
id|ms
suffix:semicolon
id|ms-&gt;flags
op_or_assign
id|IP_MASQ_F_HASHED
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;UNhashes ip_masq from ip_masq_[ms]_tables.&n; *&t;should be called with locked tables.&n; *&t;returns bool success.&n; */
DECL|function|ip_masq_unhash
r_static
r_int
id|ip_masq_unhash
c_func
(paren
r_struct
id|ip_masq
op_star
id|ms
)paren
(brace
r_int
id|hash
suffix:semicolon
r_struct
id|ip_masq
op_star
op_star
id|ms_p
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|ms-&gt;flags
op_amp
id|IP_MASQ_F_HASHED
)paren
)paren
(brace
id|IP_MASQ_ERR
c_func
(paren
l_string|&quot;ip_masq_unhash(): request for unhash flagged, called from %p&bslash;n&quot;
comma
id|__builtin_return_address
c_func
(paren
l_int|0
)paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n;         *&t;UNhash by m{addr,port}&n;         */
id|hash
op_assign
id|ip_masq_hash_key
c_func
(paren
id|ms-&gt;protocol
comma
id|ms-&gt;maddr
comma
id|ms-&gt;mport
)paren
suffix:semicolon
r_for
c_loop
(paren
id|ms_p
op_assign
op_amp
id|ip_masq_m_tab
(braket
id|hash
)braket
suffix:semicolon
op_star
id|ms_p
suffix:semicolon
id|ms_p
op_assign
op_amp
(paren
op_star
id|ms_p
)paren
op_member_access_from_pointer
id|m_link
)paren
r_if
c_cond
(paren
id|ms
op_eq
(paren
op_star
id|ms_p
)paren
)paren
(brace
id|atomic_dec
c_func
(paren
op_amp
id|ms-&gt;refcnt
)paren
suffix:semicolon
op_star
id|ms_p
op_assign
id|ms-&gt;m_link
suffix:semicolon
r_break
suffix:semicolon
)brace
multiline_comment|/*&n;         *&t;UNhash by s{addr,port}&n;         */
id|hash
op_assign
id|ip_masq_hash_key
c_func
(paren
id|ms-&gt;protocol
comma
id|ms-&gt;saddr
comma
id|ms-&gt;sport
)paren
suffix:semicolon
r_for
c_loop
(paren
id|ms_p
op_assign
op_amp
id|ip_masq_s_tab
(braket
id|hash
)braket
suffix:semicolon
op_star
id|ms_p
suffix:semicolon
id|ms_p
op_assign
op_amp
(paren
op_star
id|ms_p
)paren
op_member_access_from_pointer
id|s_link
)paren
r_if
c_cond
(paren
id|ms
op_eq
(paren
op_star
id|ms_p
)paren
)paren
(brace
id|atomic_dec
c_func
(paren
op_amp
id|ms-&gt;refcnt
)paren
suffix:semicolon
op_star
id|ms_p
op_assign
id|ms-&gt;s_link
suffix:semicolon
r_break
suffix:semicolon
)brace
id|ms-&gt;flags
op_and_assign
op_complement
id|IP_MASQ_F_HASHED
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;Returns ip_masq associated with supplied parameters, either&n; *&t;broken out of the ip/tcp headers or directly supplied for those&n; *&t;pathological protocols with address/port in the data stream&n; *&t;(ftp, irc).  addresses and ports are in network order.&n; *&t;called for pkts coming from OUTside-to-INside the firewall.&n; *&n; *&t;s_addr, s_port: pkt source address (foreign host)&n; *&t;d_addr, d_port: pkt dest address (firewall)&n; *&n; * &t;NB. Cannot check destination address, just for the incoming port.&n; * &t;reason: archie.doc.ac.uk has 6 interfaces, you send to&n; * &t;phoenix and get a reply from any other interface(==dst)!&n; *&n; * &t;[Only for UDP] - AC&n; *&t;&n; *&t;Caller must lock tables&n; */
DECL|function|__ip_masq_in_get
r_static
r_struct
id|ip_masq
op_star
id|__ip_masq_in_get
c_func
(paren
r_int
id|protocol
comma
id|__u32
id|s_addr
comma
id|__u16
id|s_port
comma
id|__u32
id|d_addr
comma
id|__u16
id|d_port
)paren
(brace
r_int
id|hash
suffix:semicolon
r_struct
id|ip_masq
op_star
id|ms
op_assign
l_int|NULL
suffix:semicolon
id|hash
op_assign
id|ip_masq_hash_key
c_func
(paren
id|protocol
comma
id|d_addr
comma
id|d_port
)paren
suffix:semicolon
r_for
c_loop
(paren
id|ms
op_assign
id|ip_masq_m_tab
(braket
id|hash
)braket
suffix:semicolon
id|ms
suffix:semicolon
id|ms
op_assign
id|ms-&gt;m_link
)paren
(brace
r_if
c_cond
(paren
id|protocol
op_eq
id|ms-&gt;protocol
op_logical_and
(paren
id|d_addr
op_eq
id|ms-&gt;maddr
op_logical_and
id|d_port
op_eq
id|ms-&gt;mport
)paren
op_logical_and
(paren
id|s_addr
op_eq
id|ms-&gt;daddr
op_logical_or
id|ms-&gt;flags
op_amp
id|MASQ_DADDR_PASS
)paren
op_logical_and
(paren
id|s_port
op_eq
id|ms-&gt;dport
op_logical_or
id|ms-&gt;flags
op_amp
id|MASQ_DPORT_PASS
)paren
)paren
(brace
id|IP_MASQ_DEBUG
c_func
(paren
l_int|2
comma
l_string|&quot;look/in %d %08X:%04hX-&gt;%08X:%04hX OK&bslash;n&quot;
comma
id|protocol
comma
id|s_addr
comma
id|s_port
comma
id|d_addr
comma
id|d_port
)paren
suffix:semicolon
id|atomic_inc
c_func
(paren
op_amp
id|ms-&gt;refcnt
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
)brace
id|IP_MASQ_DEBUG
c_func
(paren
l_int|2
comma
l_string|&quot;look/in %d %08X:%04hX-&gt;%08X:%04hX fail&bslash;n&quot;
comma
id|protocol
comma
id|s_addr
comma
id|s_port
comma
id|d_addr
comma
id|d_port
)paren
suffix:semicolon
id|out
suffix:colon
r_return
id|ms
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;Returns ip_masq associated with supplied parameters, either&n; *&t;broken out of the ip/tcp headers or directly supplied for those&n; *&t;pathological protocols with address/port in the data stream&n; *&t;(ftp, irc).  addresses and ports are in network order.&n; *&t;called for pkts coming from inside-to-OUTside the firewall.&n; *&n; *&t;Normally we know the source address and port but for some protocols&n; *&t;(e.g. ftp PASV) we do not know the source port initially.  Alas the&n; *&t;hash is keyed on source port so if the first lookup fails then try again&n; *&t;with a zero port, this time only looking at entries marked &quot;no source&n; *&t;port&quot;.&n; *&t;&n; *&t;Caller must lock tables&n; */
DECL|function|__ip_masq_out_get
r_static
r_struct
id|ip_masq
op_star
id|__ip_masq_out_get
c_func
(paren
r_int
id|protocol
comma
id|__u32
id|s_addr
comma
id|__u16
id|s_port
comma
id|__u32
id|d_addr
comma
id|__u16
id|d_port
)paren
(brace
r_int
id|hash
suffix:semicolon
r_struct
id|ip_masq
op_star
id|ms
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/*&t;&n;&t; *&t;Check for &quot;full&quot; addressed entries&n;&t; */
id|hash
op_assign
id|ip_masq_hash_key
c_func
(paren
id|protocol
comma
id|s_addr
comma
id|s_port
)paren
suffix:semicolon
r_for
c_loop
(paren
id|ms
op_assign
id|ip_masq_s_tab
(braket
id|hash
)braket
suffix:semicolon
id|ms
suffix:semicolon
id|ms
op_assign
id|ms-&gt;s_link
)paren
(brace
r_if
c_cond
(paren
id|protocol
op_eq
id|ms-&gt;protocol
op_logical_and
id|s_addr
op_eq
id|ms-&gt;saddr
op_logical_and
id|s_port
op_eq
id|ms-&gt;sport
op_logical_and
(paren
id|d_addr
op_eq
id|ms-&gt;daddr
op_logical_or
id|ms-&gt;flags
op_amp
id|MASQ_DADDR_PASS
)paren
op_logical_and
(paren
id|d_port
op_eq
id|ms-&gt;dport
op_logical_or
id|ms-&gt;flags
op_amp
id|MASQ_DPORT_PASS
)paren
)paren
(brace
id|IP_MASQ_DEBUG
c_func
(paren
l_int|2
comma
l_string|&quot;lk/out1 %d %08X:%04hX-&gt;%08X:%04hX OK&bslash;n&quot;
comma
id|protocol
comma
id|s_addr
comma
id|s_port
comma
id|d_addr
comma
id|d_port
)paren
suffix:semicolon
id|atomic_inc
c_func
(paren
op_amp
id|ms-&gt;refcnt
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
)brace
multiline_comment|/*&t;&n;&t; *&t;Check for NO_SPORT entries&n;&t; */
id|hash
op_assign
id|ip_masq_hash_key
c_func
(paren
id|protocol
comma
id|s_addr
comma
l_int|0
)paren
suffix:semicolon
r_for
c_loop
(paren
id|ms
op_assign
id|ip_masq_s_tab
(braket
id|hash
)braket
suffix:semicolon
id|ms
suffix:semicolon
id|ms
op_assign
id|ms-&gt;s_link
)paren
(brace
r_if
c_cond
(paren
id|ms-&gt;flags
op_amp
id|IP_MASQ_F_NO_SPORT
op_logical_and
id|protocol
op_eq
id|ms-&gt;protocol
op_logical_and
id|s_addr
op_eq
id|ms-&gt;saddr
op_logical_and
(paren
id|d_addr
op_eq
id|ms-&gt;daddr
op_logical_or
id|ms-&gt;flags
op_amp
id|MASQ_DADDR_PASS
)paren
op_logical_and
(paren
id|d_port
op_eq
id|ms-&gt;dport
op_logical_or
id|ms-&gt;flags
op_amp
id|MASQ_DPORT_PASS
)paren
)paren
(brace
id|IP_MASQ_DEBUG
c_func
(paren
l_int|2
comma
l_string|&quot;lk/out2 %d %08X:%04hX-&gt;%08X:%04hX OK&bslash;n&quot;
comma
id|protocol
comma
id|s_addr
comma
id|s_port
comma
id|d_addr
comma
id|d_port
)paren
suffix:semicolon
id|atomic_inc
c_func
(paren
op_amp
id|ms-&gt;refcnt
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
)brace
id|IP_MASQ_DEBUG
c_func
(paren
l_int|2
comma
l_string|&quot;lk/out1 %d %08X:%04hX-&gt;%08X:%04hX fail&bslash;n&quot;
comma
id|protocol
comma
id|s_addr
comma
id|s_port
comma
id|d_addr
comma
id|d_port
)paren
suffix:semicolon
id|out
suffix:colon
r_return
id|ms
suffix:semicolon
)brace
macro_line|#ifdef CONFIG_IP_MASQ_NREUSE
multiline_comment|/*&n; *&t;Returns ip_masq for given proto,m_addr,m_port.&n; *      called by allocation routine to find an unused m_port.&n; *&t;&n; *&t;Caller must lock tables&n; */
DECL|function|__ip_masq_getbym
r_static
r_struct
id|ip_masq
op_star
id|__ip_masq_getbym
c_func
(paren
r_int
id|protocol
comma
id|__u32
id|m_addr
comma
id|__u16
id|m_port
)paren
(brace
r_int
id|hash
suffix:semicolon
r_struct
id|ip_masq
op_star
id|ms
op_assign
l_int|NULL
suffix:semicolon
id|hash
op_assign
id|ip_masq_hash_key
c_func
(paren
id|protocol
comma
id|m_addr
comma
id|m_port
)paren
suffix:semicolon
r_for
c_loop
(paren
id|ms
op_assign
id|ip_masq_m_tab
(braket
id|hash
)braket
suffix:semicolon
id|ms
suffix:semicolon
id|ms
op_assign
id|ms-&gt;m_link
)paren
(brace
r_if
c_cond
(paren
id|protocol
op_eq
id|ms-&gt;protocol
op_logical_and
(paren
id|m_addr
op_eq
id|ms-&gt;maddr
op_logical_and
id|m_port
op_eq
id|ms-&gt;mport
)paren
)paren
(brace
id|atomic_inc
c_func
(paren
op_amp
id|ms-&gt;refcnt
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
)brace
id|out
suffix:colon
r_return
id|ms
suffix:semicolon
)brace
macro_line|#endif
DECL|function|ip_masq_out_get
r_struct
id|ip_masq
op_star
id|ip_masq_out_get
c_func
(paren
r_int
id|protocol
comma
id|__u32
id|s_addr
comma
id|__u16
id|s_port
comma
id|__u32
id|d_addr
comma
id|__u16
id|d_port
)paren
(brace
r_struct
id|ip_masq
op_star
id|ms
suffix:semicolon
id|read_lock
c_func
(paren
op_amp
id|__ip_masq_lock
)paren
suffix:semicolon
id|ms
op_assign
id|__ip_masq_out_get
c_func
(paren
id|protocol
comma
id|s_addr
comma
id|s_port
comma
id|d_addr
comma
id|d_port
)paren
suffix:semicolon
id|read_unlock
c_func
(paren
op_amp
id|__ip_masq_lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ms
)paren
id|__ip_masq_set_expire
c_func
(paren
id|ms
comma
l_int|0
)paren
suffix:semicolon
r_return
id|ms
suffix:semicolon
)brace
DECL|function|ip_masq_in_get
r_struct
id|ip_masq
op_star
id|ip_masq_in_get
c_func
(paren
r_int
id|protocol
comma
id|__u32
id|s_addr
comma
id|__u16
id|s_port
comma
id|__u32
id|d_addr
comma
id|__u16
id|d_port
)paren
(brace
r_struct
id|ip_masq
op_star
id|ms
suffix:semicolon
id|read_lock
c_func
(paren
op_amp
id|__ip_masq_lock
)paren
suffix:semicolon
id|ms
op_assign
id|__ip_masq_in_get
c_func
(paren
id|protocol
comma
id|s_addr
comma
id|s_port
comma
id|d_addr
comma
id|d_port
)paren
suffix:semicolon
id|read_unlock
c_func
(paren
op_amp
id|__ip_masq_lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ms
)paren
id|__ip_masq_set_expire
c_func
(paren
id|ms
comma
l_int|0
)paren
suffix:semicolon
r_return
id|ms
suffix:semicolon
)brace
DECL|function|__ip_masq_put
r_static
id|__inline__
r_void
id|__ip_masq_put
c_func
(paren
r_struct
id|ip_masq
op_star
id|ms
)paren
(brace
id|atomic_dec
c_func
(paren
op_amp
id|ms-&gt;refcnt
)paren
suffix:semicolon
)brace
DECL|function|ip_masq_put
r_void
id|ip_masq_put
c_func
(paren
r_struct
id|ip_masq
op_star
id|ms
)paren
(brace
multiline_comment|/*&n;&t; *&t;Decrement refcnt&n;&t; */
id|__ip_masq_put
c_func
(paren
id|ms
)paren
suffix:semicolon
multiline_comment|/*&n;&t; *&t;if refcnt==2  (2 hashes)&t;&n;&t; */
r_if
c_cond
(paren
id|atomic_read
c_func
(paren
op_amp
id|ms-&gt;refcnt
)paren
op_eq
l_int|2
)paren
(brace
id|__ip_masq_set_expire
c_func
(paren
id|ms
comma
id|ms-&gt;timeout
)paren
suffix:semicolon
)brace
r_else
(brace
id|IP_MASQ_DEBUG
c_func
(paren
l_int|0
comma
l_string|&quot;did not set timer with refcnt=%d, called from %p&bslash;n&quot;
comma
id|atomic_read
c_func
(paren
op_amp
id|ms-&gt;refcnt
)paren
comma
id|__builtin_return_address
c_func
(paren
l_int|0
)paren
)paren
suffix:semicolon
)brace
)brace
DECL|function|masq_expire
r_static
r_void
id|masq_expire
c_func
(paren
r_int
r_int
id|data
)paren
(brace
r_struct
id|ip_masq
op_star
id|ms
op_assign
(paren
r_struct
id|ip_masq
op_star
)paren
id|data
suffix:semicolon
id|ms-&gt;timeout
op_assign
id|MASQUERADE_EXPIRE_RETRY
suffix:semicolon
multiline_comment|/*&n;&t; *&t;hey, I&squot;m using it&n;&t; */
id|atomic_inc
c_func
(paren
op_amp
id|ms-&gt;refcnt
)paren
suffix:semicolon
id|IP_MASQ_DEBUG
c_func
(paren
l_int|1
comma
l_string|&quot;Masqueraded %s %08lX:%04X expired&bslash;n&quot;
comma
id|masq_proto_name
c_func
(paren
id|ms-&gt;protocol
)paren
comma
id|ntohl
c_func
(paren
id|ms-&gt;saddr
)paren
comma
id|ntohs
c_func
(paren
id|ms-&gt;sport
)paren
)paren
suffix:semicolon
id|write_lock
c_func
(paren
op_amp
id|__ip_masq_lock
)paren
suffix:semicolon
macro_line|#if 0000
multiline_comment|/*&n;&t; *&t;Already locked, do bounce ...&n;&t; */
r_if
c_cond
(paren
id|ip_masq_nlocks
c_func
(paren
op_amp
id|__ip_masq_lock
)paren
op_ne
l_int|1
)paren
(brace
r_goto
id|masq_expire_later
suffix:semicolon
)brace
macro_line|#endif
multiline_comment|/*&n;&t; * &t;do I control anybody?&n;&t; */
r_if
c_cond
(paren
id|atomic_read
c_func
(paren
op_amp
id|ms-&gt;n_control
)paren
)paren
r_goto
id|masq_expire_later
suffix:semicolon
multiline_comment|/* &t;&n;&t; *&t;does anybody controls me?&n;&t; */
r_if
c_cond
(paren
id|ms-&gt;control
)paren
id|ip_masq_control_del
c_func
(paren
id|ms
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ip_masq_unhash
c_func
(paren
id|ms
)paren
)paren
(brace
r_if
c_cond
(paren
id|ms-&gt;flags
op_amp
id|IP_MASQ_F_MPORT
)paren
(brace
id|atomic_dec
c_func
(paren
op_amp
id|mport_count
)paren
suffix:semicolon
)brace
r_else
(brace
id|atomic_inc
c_func
(paren
id|ip_masq_free_ports
op_plus
id|masq_proto_num
c_func
(paren
id|ms-&gt;protocol
)paren
)paren
suffix:semicolon
)brace
id|ip_masq_unbind_app
c_func
(paren
id|ms
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;&t; *&t;refcnt==1 implies I&squot;m the only one referrer&n;&t; */
r_if
c_cond
(paren
id|atomic_read
c_func
(paren
op_amp
id|ms-&gt;refcnt
)paren
op_eq
l_int|1
)paren
(brace
id|kfree_s
c_func
(paren
id|ms
comma
r_sizeof
(paren
op_star
id|ms
)paren
)paren
suffix:semicolon
id|MOD_DEC_USE_COUNT
suffix:semicolon
r_goto
id|masq_expire_out
suffix:semicolon
)brace
id|masq_expire_later
suffix:colon
id|IP_MASQ_DEBUG
c_func
(paren
l_int|0
comma
l_string|&quot;masq_expire delayed: %s %08lX:%04X-&gt;%08lX:%04X masq.refcnt-1=%d masq.n_control=%d&bslash;n&quot;
comma
id|masq_proto_name
c_func
(paren
id|ms-&gt;protocol
)paren
comma
id|ntohl
c_func
(paren
id|ms-&gt;saddr
)paren
comma
id|ntohs
c_func
(paren
id|ms-&gt;sport
)paren
comma
id|ntohl
c_func
(paren
id|ms-&gt;daddr
)paren
comma
id|ntohs
c_func
(paren
id|ms-&gt;dport
)paren
comma
id|atomic_read
c_func
(paren
op_amp
id|ms-&gt;refcnt
)paren
op_minus
l_int|1
comma
id|atomic_read
c_func
(paren
op_amp
id|ms-&gt;n_control
)paren
)paren
suffix:semicolon
id|ip_masq_put
c_func
(paren
id|ms
)paren
suffix:semicolon
id|masq_expire_out
suffix:colon
id|write_unlock
c_func
(paren
op_amp
id|__ip_masq_lock
)paren
suffix:semicolon
)brace
DECL|function|get_next_mport
r_static
id|__u16
id|get_next_mport
c_func
(paren
r_void
)paren
(brace
id|__u16
id|mport
suffix:semicolon
id|spin_lock_irq
c_func
(paren
op_amp
id|masq_port_lock
)paren
suffix:semicolon
multiline_comment|/*&n;&t; *&t;Try the next available port number&n;&t; */
id|mport
op_assign
id|htons
c_func
(paren
id|masq_port
op_increment
)paren
suffix:semicolon
r_if
c_cond
(paren
id|masq_port
op_eq
id|PORT_MASQ_END
)paren
id|masq_port
op_assign
id|PORT_MASQ_BEGIN
suffix:semicolon
id|spin_unlock_irq
c_func
(paren
op_amp
id|masq_port_lock
)paren
suffix:semicolon
r_return
id|mport
suffix:semicolon
)brace
multiline_comment|/*&n; * &t;Create a new masquerade list entry, also allocate an&n; * &t;unused mport, keeping the portnumber between the&n; * &t;given boundaries MASQ_BEGIN and MASQ_END.&n; *&n; * &t;Be careful, it can be called from u-space&n; */
DECL|function|ip_masq_new
r_struct
id|ip_masq
op_star
id|ip_masq_new
c_func
(paren
r_int
id|proto
comma
id|__u32
id|maddr
comma
id|__u16
id|mport
comma
id|__u32
id|saddr
comma
id|__u16
id|sport
comma
id|__u32
id|daddr
comma
id|__u16
id|dport
comma
r_int
id|mflags
)paren
(brace
r_struct
id|ip_masq
op_star
id|ms
comma
op_star
id|mst
suffix:semicolon
r_int
id|ports_tried
suffix:semicolon
id|atomic_t
op_star
id|free_ports_p
op_assign
l_int|NULL
suffix:semicolon
r_static
r_int
id|n_fails
op_assign
l_int|0
suffix:semicolon
r_int
id|prio
suffix:semicolon
r_if
c_cond
(paren
id|masq_proto_num
c_func
(paren
id|proto
)paren
op_ne
op_minus
l_int|1
op_logical_and
id|mport
op_eq
l_int|0
)paren
(brace
id|free_ports_p
op_assign
id|ip_masq_free_ports
op_plus
id|masq_proto_num
c_func
(paren
id|proto
)paren
suffix:semicolon
r_if
c_cond
(paren
id|atomic_read
c_func
(paren
id|free_ports_p
)paren
op_eq
l_int|0
)paren
(brace
r_if
c_cond
(paren
op_increment
id|n_fails
OL
l_int|5
)paren
id|IP_MASQ_ERR
c_func
(paren
l_string|&quot;ip_masq_new(proto=%s): no free ports.&bslash;n&quot;
comma
id|masq_proto_name
c_func
(paren
id|proto
)paren
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
)brace
id|prio
op_assign
(paren
id|mflags
op_amp
id|IP_MASQ_F_USER
)paren
ques
c_cond
id|GFP_KERNEL
suffix:colon
id|GFP_ATOMIC
suffix:semicolon
id|ms
op_assign
(paren
r_struct
id|ip_masq
op_star
)paren
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|ip_masq
)paren
comma
id|prio
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ms
op_eq
l_int|NULL
)paren
(brace
r_if
c_cond
(paren
op_increment
id|n_fails
OL
l_int|5
)paren
id|IP_MASQ_ERR
c_func
(paren
l_string|&quot;ip_masq_new(proto=%s): no memory available.&bslash;n&quot;
comma
id|masq_proto_name
c_func
(paren
id|proto
)paren
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
id|MOD_INC_USE_COUNT
suffix:semicolon
id|memset
c_func
(paren
id|ms
comma
l_int|0
comma
r_sizeof
(paren
op_star
id|ms
)paren
)paren
suffix:semicolon
id|init_timer
c_func
(paren
op_amp
id|ms-&gt;timer
)paren
suffix:semicolon
id|ms-&gt;timer.data
op_assign
(paren
r_int
r_int
)paren
id|ms
suffix:semicolon
id|ms-&gt;timer.function
op_assign
id|masq_expire
suffix:semicolon
id|ms-&gt;protocol
op_assign
id|proto
suffix:semicolon
id|ms-&gt;saddr
op_assign
id|saddr
suffix:semicolon
id|ms-&gt;sport
op_assign
id|sport
suffix:semicolon
id|ms-&gt;daddr
op_assign
id|daddr
suffix:semicolon
id|ms-&gt;dport
op_assign
id|dport
suffix:semicolon
id|ms-&gt;flags
op_assign
id|mflags
suffix:semicolon
id|ms-&gt;app_data
op_assign
l_int|NULL
suffix:semicolon
id|ms-&gt;control
op_assign
l_int|NULL
suffix:semicolon
id|atomic_set
c_func
(paren
op_amp
id|ms-&gt;n_control
comma
l_int|0
)paren
suffix:semicolon
id|atomic_set
c_func
(paren
op_amp
id|ms-&gt;refcnt
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|proto
op_eq
id|IPPROTO_UDP
op_logical_and
op_logical_neg
id|mport
)paren
macro_line|#ifdef CONFIG_IP_MASQ_LOOSE_DEFAULT
multiline_comment|/*&n;&t;&t; *&t;Flag this tunnel as &quot;dest loose&quot;&n;&t;&t; *&t;&n;&t;&t; */
id|ms-&gt;flags
op_or_assign
id|IP_MASQ_F_DLOOSE
suffix:semicolon
macro_line|#else
id|ms-&gt;flags
op_or_assign
id|IP_MASQ_F_NO_DADDR
suffix:semicolon
macro_line|#endif
multiline_comment|/* get masq address from rif */
id|ms-&gt;maddr
op_assign
id|maddr
suffix:semicolon
multiline_comment|/*&n;         *&t;This flag will allow masq. addr (ms-&gt;maddr)&n;         *&t;to follow forwarding interface address.&n;         */
id|ms-&gt;flags
op_or_assign
id|IP_MASQ_F_NO_REPLY
suffix:semicolon
multiline_comment|/*&n;&t; * &t;We want a specific mport. Be careful.&n;&t; */
r_if
c_cond
(paren
id|masq_proto_num
c_func
(paren
id|proto
)paren
op_eq
op_minus
l_int|1
op_logical_or
id|mport
)paren
(brace
id|ms-&gt;mport
op_assign
id|mport
suffix:semicolon
multiline_comment|/* &n;&t;&t; *&t;Check 5-upla uniqueness&n;&t;&t; */
r_if
c_cond
(paren
id|mflags
op_amp
id|IP_MASQ_F_USER
)paren
id|write_lock_bh
c_func
(paren
op_amp
id|__ip_masq_lock
)paren
suffix:semicolon
r_else
id|write_lock
c_func
(paren
op_amp
id|__ip_masq_lock
)paren
suffix:semicolon
id|mst
op_assign
id|__ip_masq_in_get
c_func
(paren
id|proto
comma
id|daddr
comma
id|dport
comma
id|maddr
comma
id|mport
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mst
op_eq
l_int|NULL
)paren
(brace
id|ms-&gt;flags
op_or_assign
id|IP_MASQ_F_MPORT
suffix:semicolon
id|atomic_inc
c_func
(paren
op_amp
id|mport_count
)paren
suffix:semicolon
id|ip_masq_hash
c_func
(paren
id|ms
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mflags
op_amp
id|IP_MASQ_F_USER
)paren
id|write_unlock_bh
c_func
(paren
op_amp
id|__ip_masq_lock
)paren
suffix:semicolon
r_else
id|write_unlock
c_func
(paren
op_amp
id|__ip_masq_lock
)paren
suffix:semicolon
id|ip_masq_bind_app
c_func
(paren
id|ms
)paren
suffix:semicolon
id|atomic_inc
c_func
(paren
op_amp
id|ms-&gt;refcnt
)paren
suffix:semicolon
id|masq_set_state_timeout
c_func
(paren
id|ms
comma
id|IP_MASQ_S_NONE
)paren
suffix:semicolon
r_return
id|ms
suffix:semicolon
)brace
r_if
c_cond
(paren
id|mflags
op_amp
id|IP_MASQ_F_USER
)paren
id|write_unlock_bh
c_func
(paren
op_amp
id|__ip_masq_lock
)paren
suffix:semicolon
r_else
id|write_unlock
c_func
(paren
op_amp
id|__ip_masq_lock
)paren
suffix:semicolon
id|__ip_masq_put
c_func
(paren
id|mst
)paren
suffix:semicolon
id|IP_MASQ_ERR
c_func
(paren
l_string|&quot;Already used connection: %s, %d.%d.%d.%d:%d =&gt; %d.%d.%d.%d:%d, called from %p&bslash;n&quot;
comma
id|masq_proto_name
c_func
(paren
id|proto
)paren
comma
id|NIPQUAD
c_func
(paren
id|maddr
)paren
comma
id|ntohs
c_func
(paren
id|mport
)paren
comma
id|NIPQUAD
c_func
(paren
id|daddr
)paren
comma
id|ntohs
c_func
(paren
id|dport
)paren
comma
id|__builtin_return_address
c_func
(paren
l_int|0
)paren
)paren
suffix:semicolon
r_goto
id|mport_nono
suffix:semicolon
)brace
r_for
c_loop
(paren
id|ports_tried
op_assign
l_int|0
suffix:semicolon
(paren
id|atomic_read
c_func
(paren
id|free_ports_p
)paren
op_logical_and
(paren
id|ports_tried
op_le
(paren
id|PORT_MASQ_END
op_minus
id|PORT_MASQ_BEGIN
)paren
)paren
)paren
suffix:semicolon
id|ports_tried
op_increment
)paren
(brace
id|mport
op_assign
id|ms-&gt;mport
op_assign
id|get_next_mport
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t; *&t;lookup to find out if this connection is used.&n;&t;&t; */
r_if
c_cond
(paren
id|mflags
op_amp
id|IP_MASQ_F_USER
)paren
id|write_lock_bh
c_func
(paren
op_amp
id|__ip_masq_lock
)paren
suffix:semicolon
r_else
id|write_lock
c_func
(paren
op_amp
id|__ip_masq_lock
)paren
suffix:semicolon
macro_line|#ifdef CONFIG_IP_MASQ_NREUSE
id|mst
op_assign
id|__ip_masq_getbym
c_func
(paren
id|proto
comma
id|maddr
comma
id|mport
)paren
suffix:semicolon
macro_line|#else
id|mst
op_assign
id|__ip_masq_in_get
c_func
(paren
id|proto
comma
id|daddr
comma
id|dport
comma
id|maddr
comma
id|mport
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|mst
op_eq
l_int|NULL
)paren
(brace
r_if
c_cond
(paren
id|atomic_read
c_func
(paren
id|free_ports_p
)paren
op_eq
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|mflags
op_amp
id|IP_MASQ_F_USER
)paren
id|write_unlock_bh
c_func
(paren
op_amp
id|__ip_masq_lock
)paren
suffix:semicolon
r_else
id|write_unlock
c_func
(paren
op_amp
id|__ip_masq_lock
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|atomic_dec
c_func
(paren
id|free_ports_p
)paren
suffix:semicolon
id|ip_masq_hash
c_func
(paren
id|ms
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mflags
op_amp
id|IP_MASQ_F_USER
)paren
id|write_unlock_bh
c_func
(paren
op_amp
id|__ip_masq_lock
)paren
suffix:semicolon
r_else
id|write_unlock
c_func
(paren
op_amp
id|__ip_masq_lock
)paren
suffix:semicolon
id|ip_masq_bind_app
c_func
(paren
id|ms
)paren
suffix:semicolon
id|n_fails
op_assign
l_int|0
suffix:semicolon
id|atomic_inc
c_func
(paren
op_amp
id|ms-&gt;refcnt
)paren
suffix:semicolon
id|masq_set_state_timeout
c_func
(paren
id|ms
comma
id|IP_MASQ_S_NONE
)paren
suffix:semicolon
r_return
id|ms
suffix:semicolon
)brace
r_if
c_cond
(paren
id|mflags
op_amp
id|IP_MASQ_F_USER
)paren
id|write_unlock_bh
c_func
(paren
op_amp
id|__ip_masq_lock
)paren
suffix:semicolon
r_else
id|write_unlock
c_func
(paren
op_amp
id|__ip_masq_lock
)paren
suffix:semicolon
id|__ip_masq_put
c_func
(paren
id|mst
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
op_increment
id|n_fails
OL
l_int|5
)paren
id|IP_MASQ_ERR
c_func
(paren
l_string|&quot;ip_masq_new(proto=%s): could not get free masq entry (free=%d).&bslash;n&quot;
comma
id|masq_proto_name
c_func
(paren
id|ms-&gt;protocol
)paren
comma
id|atomic_read
c_func
(paren
id|free_ports_p
)paren
)paren
suffix:semicolon
id|mport_nono
suffix:colon
id|kfree_s
c_func
(paren
id|ms
comma
r_sizeof
(paren
op_star
id|ms
)paren
)paren
suffix:semicolon
id|MOD_DEC_USE_COUNT
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;Get transport protocol data offset, check against size&n; *&t;return:&n; *&t;&t;0  if other IP proto&n; *&t;&t;-1 if error&n; */
DECL|function|proto_doff
r_static
id|__inline__
r_int
id|proto_doff
c_func
(paren
r_int
id|proto
comma
r_char
op_star
id|th
comma
r_int
id|size
)paren
(brace
r_int
id|ret
op_assign
op_minus
l_int|1
suffix:semicolon
r_switch
c_cond
(paren
id|proto
)paren
(brace
r_case
id|IPPROTO_ICMP
suffix:colon
r_if
c_cond
(paren
id|size
op_ge
r_sizeof
(paren
r_struct
id|icmphdr
)paren
)paren
id|ret
op_assign
r_sizeof
(paren
r_struct
id|icmphdr
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|IPPROTO_UDP
suffix:colon
r_if
c_cond
(paren
id|size
op_ge
r_sizeof
(paren
r_struct
id|udphdr
)paren
)paren
id|ret
op_assign
r_sizeof
(paren
r_struct
id|udphdr
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|IPPROTO_TCP
suffix:colon
multiline_comment|/*&n;&t;&t;&t;*&t;Is this case, this check _also_ avoids&n;&t;&t;&t;*&t;touching an invalid pointer if &n;&t;&t;&t;*&t;size is invalid&n;&t;&t;&t;*/
r_if
c_cond
(paren
id|size
op_ge
r_sizeof
(paren
r_struct
id|tcphdr
)paren
)paren
(brace
id|ret
op_assign
(paren
(paren
r_struct
id|tcphdr
op_star
)paren
id|th
)paren
op_member_access_from_pointer
id|doff
op_lshift
l_int|2
suffix:semicolon
r_if
c_cond
(paren
id|ret
OG
id|size
)paren
(brace
id|ret
op_assign
op_minus
l_int|1
suffix:semicolon
)brace
)brace
r_break
suffix:semicolon
r_default
suffix:colon
multiline_comment|/* &t;Other proto: nothing to say, by now :) */
id|ret
op_assign
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ret
OL
l_int|0
)paren
id|IP_MASQ_DEBUG
c_func
(paren
l_int|0
comma
l_string|&quot;mess proto_doff for proto=%d, size =%d&bslash;n&quot;
comma
id|proto
comma
id|size
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
DECL|function|ip_fw_masquerade
r_int
id|ip_fw_masquerade
c_func
(paren
r_struct
id|sk_buff
op_star
op_star
id|skb_p
comma
id|__u32
id|maddr
)paren
(brace
r_struct
id|sk_buff
op_star
id|skb
op_assign
op_star
id|skb_p
suffix:semicolon
r_struct
id|iphdr
op_star
id|iph
op_assign
id|skb-&gt;nh.iph
suffix:semicolon
r_union
id|ip_masq_tphdr
id|h
suffix:semicolon
r_struct
id|ip_masq
op_star
id|ms
suffix:semicolon
r_int
id|size
suffix:semicolon
multiline_comment|/* &n;&t; * &t;doff holds transport protocol data offset&n;&t; *&t;csum holds its checksum&n;&t; *&t;csum_ok says if csum is valid&n;&t; */
r_int
id|doff
op_assign
l_int|0
suffix:semicolon
r_int
id|csum
op_assign
l_int|0
suffix:semicolon
r_int
id|csum_ok
op_assign
l_int|0
suffix:semicolon
multiline_comment|/*&n;&t; * We can only masquerade protocols with ports... and hack some ICMPs&n;&t; */
id|h.raw
op_assign
(paren
r_char
op_star
)paren
id|iph
op_plus
id|iph-&gt;ihl
op_star
l_int|4
suffix:semicolon
id|size
op_assign
id|ntohs
c_func
(paren
id|iph-&gt;tot_len
)paren
op_minus
(paren
id|iph-&gt;ihl
op_star
l_int|4
)paren
suffix:semicolon
id|doff
op_assign
id|proto_doff
c_func
(paren
id|iph-&gt;protocol
comma
id|h.raw
comma
id|size
)paren
suffix:semicolon
r_if
c_cond
(paren
id|doff
op_le
l_int|0
)paren
(brace
multiline_comment|/*&t;&n;&t;&t; *&t;Output path: do not pass other IP protos nor&n;&t;&t; *&t;invalid packets.&n;&t;&t; */
r_return
op_minus
l_int|1
suffix:semicolon
)brace
r_switch
c_cond
(paren
id|iph-&gt;protocol
)paren
(brace
r_case
id|IPPROTO_ICMP
suffix:colon
r_return
id|ip_fw_masq_icmp
c_func
(paren
id|skb_p
comma
id|maddr
)paren
suffix:semicolon
r_case
id|IPPROTO_UDP
suffix:colon
r_if
c_cond
(paren
id|h.uh-&gt;check
op_eq
l_int|0
)paren
multiline_comment|/* No UDP checksum */
r_break
suffix:semicolon
r_case
id|IPPROTO_TCP
suffix:colon
multiline_comment|/* Make sure packet is in the masq range */
id|IP_MASQ_DEBUG
c_func
(paren
l_int|3
comma
l_string|&quot;O-pkt: %s size=%d&bslash;n&quot;
comma
id|masq_proto_name
c_func
(paren
id|iph-&gt;protocol
)paren
comma
id|size
)paren
suffix:semicolon
macro_line|#ifdef CONFIG_IP_MASQ_DEBUG
r_if
c_cond
(paren
id|ip_masq_get_debug_level
c_func
(paren
)paren
OG
l_int|3
)paren
(brace
id|skb-&gt;ip_summed
op_assign
id|CHECKSUM_NONE
suffix:semicolon
)brace
macro_line|#endif
multiline_comment|/* Check that the checksum is OK */
r_switch
c_cond
(paren
id|skb-&gt;ip_summed
)paren
(brace
r_case
id|CHECKSUM_NONE
suffix:colon
(brace
id|csum
op_assign
id|csum_partial
c_func
(paren
id|h.raw
op_plus
id|doff
comma
id|size
op_minus
id|doff
comma
l_int|0
)paren
suffix:semicolon
id|IP_MASQ_DEBUG
c_func
(paren
l_int|3
comma
l_string|&quot;O-pkt: %s I-datacsum=%d&bslash;n&quot;
comma
id|masq_proto_name
c_func
(paren
id|iph-&gt;protocol
)paren
comma
id|csum
)paren
suffix:semicolon
id|skb-&gt;csum
op_assign
id|csum_partial
c_func
(paren
id|h.raw
comma
id|doff
comma
id|csum
)paren
suffix:semicolon
)brace
r_case
id|CHECKSUM_HW
suffix:colon
r_if
c_cond
(paren
id|csum_tcpudp_magic
c_func
(paren
id|iph-&gt;saddr
comma
id|iph-&gt;daddr
comma
id|size
comma
id|iph-&gt;protocol
comma
id|skb-&gt;csum
)paren
)paren
(brace
id|IP_MASQ_DEBUG
c_func
(paren
l_int|0
comma
l_string|&quot;Outgoing failed %s checksum from %d.%d.%d.%d (size=%d)!&bslash;n&quot;
comma
id|masq_proto_name
c_func
(paren
id|iph-&gt;protocol
)paren
comma
id|NIPQUAD
c_func
(paren
id|iph-&gt;saddr
)paren
comma
id|size
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
r_default
suffix:colon
(brace
)brace
multiline_comment|/* CHECKSUM_UNNECESSARY */
)brace
r_break
suffix:semicolon
r_default
suffix:colon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
multiline_comment|/*&n;&t; *&t;Now hunt the list to see if we have an old entry&n;&t; */
multiline_comment|/* h.raw = (char*) iph + iph-&gt;ihl * 4; */
id|IP_MASQ_DEBUG
c_func
(paren
l_int|2
comma
l_string|&quot;Outgoing %s %08lX:%04X -&gt; %08lX:%04X&bslash;n&quot;
comma
id|masq_proto_name
c_func
(paren
id|iph-&gt;protocol
)paren
comma
id|ntohl
c_func
(paren
id|iph-&gt;saddr
)paren
comma
id|ntohs
c_func
(paren
id|h.portp
(braket
l_int|0
)braket
)paren
comma
id|ntohl
c_func
(paren
id|iph-&gt;daddr
)paren
comma
id|ntohs
c_func
(paren
id|h.portp
(braket
l_int|1
)braket
)paren
)paren
suffix:semicolon
id|ms
op_assign
id|ip_masq_out_get_iph
c_func
(paren
id|iph
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ms
op_ne
l_int|NULL
)paren
(brace
multiline_comment|/*&n;                 *&t;If sysctl !=0 and no pkt has been received yet&n;                 *&t;in this tunnel and routing iface address has changed...&n;                 *&t; &quot;You are welcome, diald&quot;.&n;                 */
r_if
c_cond
(paren
id|sysctl_ip_dynaddr
op_logical_and
id|ms-&gt;flags
op_amp
id|IP_MASQ_F_NO_REPLY
op_logical_and
id|maddr
op_ne
id|ms-&gt;maddr
)paren
(brace
r_if
c_cond
(paren
id|sysctl_ip_dynaddr
OG
l_int|1
)paren
(brace
id|IP_MASQ_INFO
c_func
(paren
l_string|&quot;ip_fw_masquerade(): change masq.addr from %d.%d.%d.%d to %d.%d.%d.%d&bslash;n&quot;
comma
id|NIPQUAD
c_func
(paren
id|ms-&gt;maddr
)paren
comma
id|NIPQUAD
c_func
(paren
id|maddr
)paren
)paren
suffix:semicolon
)brace
id|write_lock
c_func
(paren
op_amp
id|__ip_masq_lock
)paren
suffix:semicolon
id|ip_masq_unhash
c_func
(paren
id|ms
)paren
suffix:semicolon
id|ms-&gt;maddr
op_assign
id|maddr
suffix:semicolon
id|ip_masq_hash
c_func
(paren
id|ms
)paren
suffix:semicolon
id|write_unlock
c_func
(paren
op_amp
id|__ip_masq_lock
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;&t;&t; *      Set sport if not defined yet (e.g. ftp PASV).  Because&n;&t;&t; *&t;masq entries are hashed on sport, unhash with old value&n;&t;&t; *&t;and hash with new.&n;&t;&t; */
r_if
c_cond
(paren
id|ms-&gt;flags
op_amp
id|IP_MASQ_F_NO_SPORT
op_logical_and
id|ms-&gt;protocol
op_eq
id|IPPROTO_TCP
)paren
(brace
id|ms-&gt;flags
op_and_assign
op_complement
id|IP_MASQ_F_NO_SPORT
suffix:semicolon
id|write_lock
c_func
(paren
op_amp
id|__ip_masq_lock
)paren
suffix:semicolon
id|ip_masq_unhash
c_func
(paren
id|ms
)paren
suffix:semicolon
id|ms-&gt;sport
op_assign
id|h.portp
(braket
l_int|0
)braket
suffix:semicolon
id|ip_masq_hash
c_func
(paren
id|ms
)paren
suffix:semicolon
multiline_comment|/* hash on new sport */
id|write_unlock
c_func
(paren
op_amp
id|__ip_masq_lock
)paren
suffix:semicolon
id|IP_MASQ_DEBUG
c_func
(paren
l_int|1
comma
l_string|&quot;ip_fw_masquerade(): filled sport=%d&bslash;n&quot;
comma
id|ntohs
c_func
(paren
id|ms-&gt;sport
)paren
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ms-&gt;flags
op_amp
id|IP_MASQ_F_DLOOSE
)paren
(brace
multiline_comment|/*&n;&t;&t;&t; *&t;update dest loose values&n;&t;&t;&t; */
id|ms-&gt;dport
op_assign
id|h.portp
(braket
l_int|1
)braket
suffix:semicolon
id|ms-&gt;daddr
op_assign
id|iph-&gt;daddr
suffix:semicolon
)brace
)brace
r_else
(brace
multiline_comment|/*&n;&t;&t; *&t;Nope, not found, create a new entry for it&n;&t;&t; */
macro_line|#ifdef CONFIG_IP_MASQUERADE_MOD
r_if
c_cond
(paren
op_logical_neg
(paren
id|ms
op_assign
id|ip_masq_mod_out_create
c_func
(paren
id|skb
comma
id|iph
comma
id|maddr
)paren
)paren
)paren
macro_line|#endif
id|ms
op_assign
id|ip_masq_new
c_func
(paren
id|iph-&gt;protocol
comma
id|maddr
comma
l_int|0
comma
id|iph-&gt;saddr
comma
id|h.portp
(braket
l_int|0
)braket
comma
id|iph-&gt;daddr
comma
id|h.portp
(braket
l_int|1
)braket
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ms
op_eq
l_int|NULL
)paren
r_return
op_minus
l_int|1
suffix:semicolon
)brace
multiline_comment|/*&n; &t; * &t;Call module&squot;s output update hook&n;&t; */
macro_line|#ifdef CONFIG_IP_MASQUERADE_MOD
id|ip_masq_mod_out_update
c_func
(paren
id|skb
comma
id|iph
comma
id|ms
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/*&n; &t; *&t;Change the fragments origin&n; &t; */
id|size
op_assign
id|skb-&gt;len
op_minus
(paren
id|h.raw
op_minus
id|skb-&gt;nh.raw
)paren
suffix:semicolon
multiline_comment|/*&n;         *&t;Set iph addr and port from ip_masq obj.&n;         */
id|iph-&gt;saddr
op_assign
id|ms-&gt;maddr
suffix:semicolon
id|h.portp
(braket
l_int|0
)braket
op_assign
id|ms-&gt;mport
suffix:semicolon
multiline_comment|/*&n;&t; *&t;Invalidate csum saving if tunnel has masq helper&n;&t; */
r_if
c_cond
(paren
id|ms-&gt;app
)paren
id|csum_ok
op_assign
l_int|0
suffix:semicolon
multiline_comment|/*&n; &t; *&t;Attempt ip_masq_app call.&n;         *&t;will fix ip_masq and iph seq stuff&n; &t; */
r_if
c_cond
(paren
id|ip_masq_app_pkt_out
c_func
(paren
id|ms
comma
id|skb_p
comma
id|maddr
)paren
op_ne
l_int|0
)paren
(brace
multiline_comment|/*&n;                 *&t;skb has possibly changed, update pointers.&n;                 */
id|skb
op_assign
op_star
id|skb_p
suffix:semicolon
id|iph
op_assign
id|skb-&gt;nh.iph
suffix:semicolon
id|h.raw
op_assign
(paren
r_char
op_star
)paren
id|iph
op_plus
id|iph-&gt;ihl
op_star
l_int|4
suffix:semicolon
id|size
op_assign
id|skb-&gt;len
op_minus
(paren
id|h.raw
op_minus
id|skb-&gt;nh.raw
)paren
suffix:semicolon
multiline_comment|/* doff should have not changed */
)brace
multiline_comment|/*&n; &t; *&t;Adjust packet accordingly to protocol&n; &t; */
multiline_comment|/*&n;&t; *&t;Transport&squot;s payload partial csum&n;&t; */
r_if
c_cond
(paren
op_logical_neg
id|csum_ok
)paren
(brace
id|csum
op_assign
id|csum_partial
c_func
(paren
id|h.raw
op_plus
id|doff
comma
id|size
op_minus
id|doff
comma
l_int|0
)paren
suffix:semicolon
)brace
id|skb-&gt;csum
op_assign
id|csum
suffix:semicolon
id|IP_MASQ_DEBUG
c_func
(paren
l_int|3
comma
l_string|&quot;O-pkt: %s size=%d O-datacsum=%d&bslash;n&quot;
comma
id|masq_proto_name
c_func
(paren
id|iph-&gt;protocol
)paren
comma
id|size
comma
id|csum
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * &t;Protocol csum&n;&t; */
r_switch
c_cond
(paren
id|iph-&gt;protocol
)paren
(brace
r_case
id|IPPROTO_TCP
suffix:colon
id|h.th-&gt;check
op_assign
l_int|0
suffix:semicolon
id|h.th-&gt;check
op_assign
id|csum_tcpudp_magic
c_func
(paren
id|iph-&gt;saddr
comma
id|iph-&gt;daddr
comma
id|size
comma
id|iph-&gt;protocol
comma
id|csum_partial
c_func
(paren
id|h.raw
comma
id|doff
comma
id|csum
)paren
)paren
suffix:semicolon
id|IP_MASQ_DEBUG
c_func
(paren
l_int|3
comma
l_string|&quot;O-pkt: %s O-csum=%d (+%d)&bslash;n&quot;
comma
id|masq_proto_name
c_func
(paren
id|iph-&gt;protocol
)paren
comma
id|h.th-&gt;check
comma
(paren
r_char
op_star
)paren
op_amp
(paren
id|h.th-&gt;check
)paren
op_minus
(paren
r_char
op_star
)paren
id|h.raw
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|IPPROTO_UDP
suffix:colon
id|h.uh-&gt;check
op_assign
l_int|0
suffix:semicolon
id|h.uh-&gt;check
op_assign
id|csum_tcpudp_magic
c_func
(paren
id|iph-&gt;saddr
comma
id|iph-&gt;daddr
comma
id|size
comma
id|iph-&gt;protocol
comma
id|csum_partial
c_func
(paren
id|h.raw
comma
id|doff
comma
id|csum
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|h.uh-&gt;check
op_eq
l_int|0
)paren
id|h.uh-&gt;check
op_assign
l_int|0xFFFF
suffix:semicolon
id|IP_MASQ_DEBUG
c_func
(paren
l_int|3
comma
l_string|&quot;O-pkt: %s O-csum=%d (+%d)&bslash;n&quot;
comma
id|masq_proto_name
c_func
(paren
id|iph-&gt;protocol
)paren
comma
id|h.uh-&gt;check
comma
(paren
r_char
op_star
)paren
op_amp
(paren
id|h.uh-&gt;check
)paren
op_minus
(paren
r_char
op_star
)paren
id|h.raw
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|ip_send_check
c_func
(paren
id|iph
)paren
suffix:semicolon
id|IP_MASQ_DEBUG
c_func
(paren
l_int|2
comma
l_string|&quot;O-routed from %08lX:%04X with masq.addr %08lX&bslash;n&quot;
comma
id|ntohl
c_func
(paren
id|ms-&gt;maddr
)paren
comma
id|ntohs
c_func
(paren
id|ms-&gt;mport
)paren
comma
id|ntohl
c_func
(paren
id|maddr
)paren
)paren
suffix:semicolon
id|masq_set_state
c_func
(paren
id|ms
comma
l_int|1
comma
id|iph
comma
id|h.portp
)paren
suffix:semicolon
id|ip_masq_put
c_func
(paren
id|ms
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;Restore original addresses and ports in the original IP&n; *&t;datagram if the failing packet has been [de]masqueraded.&n; *&t;This is ugly in the extreme.  We no longer have the original&n; *&t;packet so we have to reconstruct it from the failing packet&n; *&t;plus data in the masq tables.  The resulting &quot;original data&quot;&n; *&t;should be good enough to tell the sender which session to&n; *&t;throttle.  Relies on far too much knowledge of masq internals,&n; *&t;there ought to be a better way - KAO 990303.&n; *&n; *&t;Moved here from icmp.c - JJC.&n; *&t;Already known: type == ICMP_DEST_UNREACH, IPSKB_MASQUERADED&n; *&t;skb-&gt;nh.iph points to original header.&n; *&n; *&t;Must try both OUT and IN tables; we could add a flag&n; *&t;ala IPSKB_MASQUERADED to avoid 2nd tables lookup, but this is VERY&n; *&t;unlike because routing makes mtu decision before reaching &n; *&t;ip_fw_masquerade().&n; *&t;&n; */
DECL|function|ip_fw_unmasq_icmp
r_int
id|ip_fw_unmasq_icmp
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
)paren
(brace
r_struct
id|ip_masq
op_star
id|ms
suffix:semicolon
r_struct
id|iphdr
op_star
id|iph
op_assign
id|skb-&gt;nh.iph
suffix:semicolon
id|__u16
op_star
id|portp
op_assign
(paren
id|__u16
op_star
)paren
op_amp
(paren
(paren
(paren
r_char
op_star
)paren
id|iph
)paren
(braket
id|iph-&gt;ihl
op_star
l_int|4
)braket
)paren
suffix:semicolon
multiline_comment|/* &n;&t; *&t;Always called from _bh context: use read_[un]lock()&n;&t; */
multiline_comment|/*&n;&t; * &t;Peek &quot;out&quot; table, this packet has bounced:&n;&t; *&t;out-&gt;in(frag_needed!)-&gt;OUT[icmp]&n;&t; *&n;&t; *&t;iph-&gt;daddr is IN host&n;&t; *&t;iph-&gt;saddr is OUT host&n;&t; */
id|read_lock
c_func
(paren
op_amp
id|__ip_masq_lock
)paren
suffix:semicolon
id|ms
op_assign
id|__ip_masq_out_get
c_func
(paren
id|iph-&gt;protocol
comma
id|iph-&gt;daddr
comma
id|portp
(braket
l_int|1
)braket
comma
id|iph-&gt;saddr
comma
id|portp
(braket
l_int|0
)braket
)paren
suffix:semicolon
id|read_unlock
c_func
(paren
op_amp
id|__ip_masq_lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ms
)paren
(brace
id|IP_MASQ_DEBUG
c_func
(paren
l_int|1
comma
l_string|&quot;Incoming frag_need rewrited from %d.%d.%d.%d to %d.%d.%d.%d&bslash;n&quot;
comma
id|NIPQUAD
c_func
(paren
id|iph-&gt;daddr
)paren
comma
id|NIPQUAD
c_func
(paren
id|ms-&gt;maddr
)paren
)paren
suffix:semicolon
id|iph-&gt;daddr
op_assign
id|ms-&gt;maddr
suffix:semicolon
id|portp
(braket
l_int|1
)braket
op_assign
id|ms-&gt;mport
suffix:semicolon
id|__ip_masq_put
c_func
(paren
id|ms
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * &t;Peek &quot;in&quot; table&n;&t; *&t;in-&gt;out(frag_needed!)-&gt;IN[icmp]&n;&t; *&n;&t; *&t;iph-&gt;daddr is OUT host&n;&t; *&t;iph-&gt;saddr is MASQ host&n;&t; *&n;&t; */
id|read_lock
c_func
(paren
op_amp
id|__ip_masq_lock
)paren
suffix:semicolon
id|ms
op_assign
id|__ip_masq_in_get
c_func
(paren
id|iph-&gt;protocol
comma
id|iph-&gt;daddr
comma
id|portp
(braket
l_int|1
)braket
comma
id|iph-&gt;saddr
comma
id|portp
(braket
l_int|0
)braket
)paren
suffix:semicolon
id|read_unlock
c_func
(paren
op_amp
id|__ip_masq_lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ms
)paren
(brace
id|IP_MASQ_DEBUG
c_func
(paren
l_int|1
comma
l_string|&quot;Outgoing frag_need rewrited from %d.%d.%d.%d to %d.%d.%d.%d&bslash;n&quot;
comma
id|NIPQUAD
c_func
(paren
id|iph-&gt;saddr
)paren
comma
id|NIPQUAD
c_func
(paren
id|ms-&gt;saddr
)paren
)paren
suffix:semicolon
id|iph-&gt;saddr
op_assign
id|ms-&gt;saddr
suffix:semicolon
id|portp
(braket
l_int|0
)braket
op_assign
id|ms-&gt;sport
suffix:semicolon
id|__ip_masq_put
c_func
(paren
id|ms
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;Handle ICMP messages in forward direction.&n; *&t;Find any that might be relevant, check against existing connections,&n; *&t;forward to masqueraded host if relevant.&n; *&t;Currently handles error types - unreachable, quench, ttl exceeded&n; */
DECL|function|ip_fw_masq_icmp
r_int
id|ip_fw_masq_icmp
c_func
(paren
r_struct
id|sk_buff
op_star
op_star
id|skb_p
comma
id|__u32
id|maddr
)paren
(brace
r_struct
id|sk_buff
op_star
id|skb
op_assign
op_star
id|skb_p
suffix:semicolon
r_struct
id|iphdr
op_star
id|iph
op_assign
id|skb-&gt;nh.iph
suffix:semicolon
r_struct
id|icmphdr
op_star
id|icmph
op_assign
(paren
r_struct
id|icmphdr
op_star
)paren
(paren
(paren
r_char
op_star
)paren
id|iph
op_plus
(paren
id|iph-&gt;ihl
op_lshift
l_int|2
)paren
)paren
suffix:semicolon
r_struct
id|iphdr
op_star
id|ciph
suffix:semicolon
multiline_comment|/* The ip header contained within the ICMP */
id|__u16
op_star
id|pptr
suffix:semicolon
multiline_comment|/* port numbers from TCP/UDP contained header */
r_struct
id|ip_masq
op_star
id|ms
suffix:semicolon
r_int
r_int
id|len
op_assign
id|ntohs
c_func
(paren
id|iph-&gt;tot_len
)paren
op_minus
(paren
id|iph-&gt;ihl
op_star
l_int|4
)paren
suffix:semicolon
id|IP_MASQ_DEBUG
c_func
(paren
l_int|2
comma
l_string|&quot;Incoming forward ICMP (%d,%d) %lX -&gt; %lX&bslash;n&quot;
comma
id|icmph-&gt;type
comma
id|ntohs
c_func
(paren
id|icmp_id
c_func
(paren
id|icmph
)paren
)paren
comma
id|ntohl
c_func
(paren
id|iph-&gt;saddr
)paren
comma
id|ntohl
c_func
(paren
id|iph-&gt;daddr
)paren
)paren
suffix:semicolon
macro_line|#ifdef CONFIG_IP_MASQUERADE_ICMP&t;&t;
r_if
c_cond
(paren
(paren
id|icmph-&gt;type
op_eq
id|ICMP_ECHO
)paren
op_logical_or
(paren
id|icmph-&gt;type
op_eq
id|ICMP_TIMESTAMP
)paren
op_logical_or
(paren
id|icmph-&gt;type
op_eq
id|ICMP_INFO_REQUEST
)paren
op_logical_or
(paren
id|icmph-&gt;type
op_eq
id|ICMP_ADDRESS
)paren
)paren
(brace
id|IP_MASQ_DEBUG
c_func
(paren
l_int|2
comma
l_string|&quot;icmp request rcv %lX-&gt;%lX  id %d type %d&bslash;n&quot;
comma
id|ntohl
c_func
(paren
id|iph-&gt;saddr
)paren
comma
id|ntohl
c_func
(paren
id|iph-&gt;daddr
)paren
comma
id|ntohs
c_func
(paren
id|icmp_id
c_func
(paren
id|icmph
)paren
)paren
comma
id|icmph-&gt;type
)paren
suffix:semicolon
id|ms
op_assign
id|ip_masq_out_get
c_func
(paren
id|iph-&gt;protocol
comma
id|iph-&gt;saddr
comma
id|icmp_id
c_func
(paren
id|icmph
)paren
comma
id|iph-&gt;daddr
comma
id|icmp_hv_req
c_func
(paren
id|icmph
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ms
op_eq
l_int|NULL
)paren
(brace
id|ms
op_assign
id|ip_masq_new
c_func
(paren
id|iph-&gt;protocol
comma
id|maddr
comma
l_int|0
comma
id|iph-&gt;saddr
comma
id|icmp_id
c_func
(paren
id|icmph
)paren
comma
id|iph-&gt;daddr
comma
id|icmp_hv_req
c_func
(paren
id|icmph
)paren
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ms
op_eq
l_int|NULL
)paren
r_return
(paren
op_minus
l_int|1
)paren
suffix:semicolon
id|IP_MASQ_DEBUG
c_func
(paren
l_int|1
comma
l_string|&quot;Created new icmp entry&bslash;n&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/* Rewrite source address */
multiline_comment|/*&n;                 *&t;If sysctl !=0 and no pkt has been received yet&n;                 *&t;in this tunnel and routing iface address has changed...&n;                 *&t; &quot;You are welcome, diald&quot;.&n;                 */
r_if
c_cond
(paren
id|sysctl_ip_dynaddr
op_logical_and
id|ms-&gt;flags
op_amp
id|IP_MASQ_F_NO_REPLY
op_logical_and
id|maddr
op_ne
id|ms-&gt;maddr
)paren
(brace
r_if
c_cond
(paren
id|sysctl_ip_dynaddr
OG
l_int|1
)paren
(brace
id|IP_MASQ_INFO
c_func
(paren
l_string|&quot;ip_fw_masq_icmp(): change masq.addr %d.%d.%d.%d to %d.%d.%d.%d&quot;
comma
id|NIPQUAD
c_func
(paren
id|ms-&gt;maddr
)paren
comma
id|NIPQUAD
c_func
(paren
id|maddr
)paren
)paren
suffix:semicolon
)brace
id|write_lock
c_func
(paren
op_amp
id|__ip_masq_lock
)paren
suffix:semicolon
id|ip_masq_unhash
c_func
(paren
id|ms
)paren
suffix:semicolon
id|ms-&gt;maddr
op_assign
id|maddr
suffix:semicolon
id|ip_masq_hash
c_func
(paren
id|ms
)paren
suffix:semicolon
id|write_unlock
c_func
(paren
op_amp
id|__ip_masq_lock
)paren
suffix:semicolon
)brace
id|iph-&gt;saddr
op_assign
id|ms-&gt;maddr
suffix:semicolon
id|ip_send_check
c_func
(paren
id|iph
)paren
suffix:semicolon
multiline_comment|/* Rewrite port (id) */
(paren
id|icmph-&gt;un
)paren
dot
id|echo.id
op_assign
id|ms-&gt;mport
suffix:semicolon
id|icmph-&gt;checksum
op_assign
l_int|0
suffix:semicolon
id|icmph-&gt;checksum
op_assign
id|ip_compute_csum
c_func
(paren
(paren
r_int
r_char
op_star
)paren
id|icmph
comma
id|len
)paren
suffix:semicolon
id|IP_MASQ_DEBUG
c_func
(paren
l_int|2
comma
l_string|&quot;icmp request rwt %lX-&gt;%lX id %d type %d&bslash;n&quot;
comma
id|ntohl
c_func
(paren
id|iph-&gt;saddr
)paren
comma
id|ntohl
c_func
(paren
id|iph-&gt;daddr
)paren
comma
id|ntohs
c_func
(paren
id|icmp_id
c_func
(paren
id|icmph
)paren
)paren
comma
id|icmph-&gt;type
)paren
suffix:semicolon
id|masq_set_state
c_func
(paren
id|ms
comma
l_int|1
comma
id|iph
comma
id|icmph
)paren
suffix:semicolon
id|ip_masq_put
c_func
(paren
id|ms
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
macro_line|#endif
multiline_comment|/*&n;&t; * Work through seeing if this is for us.&n;&t; * These checks are supposed to be in an order that&n;&t; * means easy things are checked first to speed up&n;&t; * processing.... however this means that some&n;&t; * packets will manage to get a long way down this&n;&t; * stack and then be rejected, but thats life&n;&t; */
r_if
c_cond
(paren
(paren
id|icmph-&gt;type
op_ne
id|ICMP_DEST_UNREACH
)paren
op_logical_and
(paren
id|icmph-&gt;type
op_ne
id|ICMP_SOURCE_QUENCH
)paren
op_logical_and
(paren
id|icmph-&gt;type
op_ne
id|ICMP_TIME_EXCEEDED
)paren
)paren
r_return
l_int|0
suffix:semicolon
multiline_comment|/* Now find the contained IP header */
id|ciph
op_assign
(paren
r_struct
id|iphdr
op_star
)paren
(paren
id|icmph
op_plus
l_int|1
)paren
suffix:semicolon
macro_line|#ifdef CONFIG_IP_MASQUERADE_ICMP
r_if
c_cond
(paren
id|ciph-&gt;protocol
op_eq
id|IPPROTO_ICMP
)paren
(brace
multiline_comment|/*&n;&t;&t; * This section handles ICMP errors for ICMP packets&n;&t;&t; */
r_struct
id|icmphdr
op_star
id|cicmph
op_assign
(paren
r_struct
id|icmphdr
op_star
)paren
(paren
(paren
r_char
op_star
)paren
id|ciph
op_plus
(paren
id|ciph-&gt;ihl
op_lshift
l_int|2
)paren
)paren
suffix:semicolon
id|IP_MASQ_DEBUG
c_func
(paren
l_int|2
comma
l_string|&quot;fw icmp/icmp rcv %lX-&gt;%lX id %d type %d&bslash;n&quot;
comma
id|ntohl
c_func
(paren
id|ciph-&gt;saddr
)paren
comma
id|ntohl
c_func
(paren
id|ciph-&gt;daddr
)paren
comma
id|ntohs
c_func
(paren
id|icmp_id
c_func
(paren
id|cicmph
)paren
)paren
comma
id|cicmph-&gt;type
)paren
suffix:semicolon
id|read_lock
c_func
(paren
op_amp
id|__ip_masq_lock
)paren
suffix:semicolon
id|ms
op_assign
id|__ip_masq_out_get
c_func
(paren
id|ciph-&gt;protocol
comma
id|ciph-&gt;daddr
comma
id|icmp_id
c_func
(paren
id|cicmph
)paren
comma
id|ciph-&gt;saddr
comma
id|icmp_hv_rep
c_func
(paren
id|cicmph
)paren
)paren
suffix:semicolon
id|read_unlock
c_func
(paren
op_amp
id|__ip_masq_lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ms
op_eq
l_int|NULL
)paren
r_return
l_int|0
suffix:semicolon
multiline_comment|/* Now we do real damage to this packet...! */
multiline_comment|/* First change the source IP address, and recalc checksum */
id|iph-&gt;saddr
op_assign
id|ms-&gt;maddr
suffix:semicolon
id|ip_send_check
c_func
(paren
id|iph
)paren
suffix:semicolon
multiline_comment|/* Now change the *dest* address in the contained IP */
id|ciph-&gt;daddr
op_assign
id|ms-&gt;maddr
suffix:semicolon
id|__ip_masq_put
c_func
(paren
id|ms
)paren
suffix:semicolon
id|ip_send_check
c_func
(paren
id|ciph
)paren
suffix:semicolon
multiline_comment|/* Change the ID to the masqed one! */
(paren
id|cicmph-&gt;un
)paren
dot
id|echo.id
op_assign
id|ms-&gt;mport
suffix:semicolon
multiline_comment|/* And finally the ICMP checksum */
id|icmph-&gt;checksum
op_assign
l_int|0
suffix:semicolon
id|icmph-&gt;checksum
op_assign
id|ip_compute_csum
c_func
(paren
(paren
r_int
r_char
op_star
)paren
id|icmph
comma
id|len
)paren
suffix:semicolon
id|IP_MASQ_DEBUG
c_func
(paren
l_int|2
comma
l_string|&quot;fw icmp/icmp rwt %lX-&gt;%lX id %d type %d&bslash;n&quot;
comma
id|ntohl
c_func
(paren
id|ciph-&gt;saddr
)paren
comma
id|ntohl
c_func
(paren
id|ciph-&gt;daddr
)paren
comma
id|ntohs
c_func
(paren
id|icmp_id
c_func
(paren
id|cicmph
)paren
)paren
comma
id|cicmph-&gt;type
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
macro_line|#endif /* CONFIG_IP_MASQUERADE_ICMP */
multiline_comment|/* We are only interested ICMPs generated from TCP or UDP packets */
r_if
c_cond
(paren
(paren
id|ciph-&gt;protocol
op_ne
id|IPPROTO_UDP
)paren
op_logical_and
(paren
id|ciph-&gt;protocol
op_ne
id|IPPROTO_TCP
)paren
)paren
r_return
l_int|0
suffix:semicolon
multiline_comment|/*&n;&t; * Find the ports involved - this packet was&n;&t; * incoming so the ports are right way round&n;&t; * (but reversed relative to outer IP header!)&n;&t; */
id|pptr
op_assign
(paren
id|__u16
op_star
)paren
op_amp
(paren
(paren
(paren
r_char
op_star
)paren
id|ciph
)paren
(braket
id|ciph-&gt;ihl
op_star
l_int|4
)braket
)paren
suffix:semicolon
macro_line|#if 0
r_if
c_cond
(paren
id|ntohs
c_func
(paren
id|pptr
(braket
l_int|1
)braket
)paren
template_param
id|PORT_MASQ_END
)paren
r_return
l_int|0
suffix:semicolon
macro_line|#endif
multiline_comment|/* Ensure the checksum is correct */
r_if
c_cond
(paren
id|ip_compute_csum
c_func
(paren
(paren
r_int
r_char
op_star
)paren
id|icmph
comma
id|len
)paren
)paren
(brace
multiline_comment|/* Failed checksum! */
id|IP_MASQ_DEBUG
c_func
(paren
l_int|0
comma
l_string|&quot;forward ICMP: failed checksum from %d.%d.%d.%d!&bslash;n&quot;
comma
id|NIPQUAD
c_func
(paren
id|iph-&gt;saddr
)paren
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|IP_MASQ_DEBUG
c_func
(paren
l_int|2
comma
l_string|&quot;Handling forward ICMP for %08lX:%04X -&gt; %08lX:%04X&bslash;n&quot;
comma
id|ntohl
c_func
(paren
id|ciph-&gt;saddr
)paren
comma
id|ntohs
c_func
(paren
id|pptr
(braket
l_int|0
)braket
)paren
comma
id|ntohl
c_func
(paren
id|ciph-&gt;daddr
)paren
comma
id|ntohs
c_func
(paren
id|pptr
(braket
l_int|1
)braket
)paren
)paren
suffix:semicolon
macro_line|#if 0
multiline_comment|/* This is pretty much what __ip_masq_in_get_iph() does */
id|ms
op_assign
id|__ip_masq_in_get
c_func
(paren
id|ciph-&gt;protocol
comma
id|ciph-&gt;saddr
comma
id|pptr
(braket
l_int|0
)braket
comma
id|ciph-&gt;daddr
comma
id|pptr
(braket
l_int|1
)braket
)paren
suffix:semicolon
macro_line|#endif
id|read_lock
c_func
(paren
op_amp
id|__ip_masq_lock
)paren
suffix:semicolon
id|ms
op_assign
id|__ip_masq_out_get
c_func
(paren
id|ciph-&gt;protocol
comma
id|ciph-&gt;daddr
comma
id|pptr
(braket
l_int|1
)braket
comma
id|ciph-&gt;saddr
comma
id|pptr
(braket
l_int|0
)braket
)paren
suffix:semicolon
id|read_unlock
c_func
(paren
op_amp
id|__ip_masq_lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ms
op_eq
l_int|NULL
)paren
r_return
l_int|0
suffix:semicolon
multiline_comment|/* Now we do real damage to this packet...! */
multiline_comment|/* First change the source IP address, and recalc checksum */
id|iph-&gt;saddr
op_assign
id|ms-&gt;maddr
suffix:semicolon
id|ip_send_check
c_func
(paren
id|iph
)paren
suffix:semicolon
multiline_comment|/* Now change the *dest* address in the contained IP */
id|ciph-&gt;daddr
op_assign
id|ms-&gt;maddr
suffix:semicolon
id|ip_send_check
c_func
(paren
id|ciph
)paren
suffix:semicolon
multiline_comment|/* the TCP/UDP dest port - cannot redo check */
id|pptr
(braket
l_int|1
)braket
op_assign
id|ms-&gt;mport
suffix:semicolon
id|__ip_masq_put
c_func
(paren
id|ms
)paren
suffix:semicolon
multiline_comment|/* And finally the ICMP checksum */
id|icmph-&gt;checksum
op_assign
l_int|0
suffix:semicolon
id|icmph-&gt;checksum
op_assign
id|ip_compute_csum
c_func
(paren
(paren
r_int
r_char
op_star
)paren
id|icmph
comma
id|len
)paren
suffix:semicolon
id|IP_MASQ_DEBUG
c_func
(paren
l_int|2
comma
l_string|&quot;Rewrote forward ICMP to %08lX:%04X -&gt; %08lX:%04X&bslash;n&quot;
comma
id|ntohl
c_func
(paren
id|ciph-&gt;saddr
)paren
comma
id|ntohs
c_func
(paren
id|pptr
(braket
l_int|0
)braket
)paren
comma
id|ntohl
c_func
(paren
id|ciph-&gt;daddr
)paren
comma
id|ntohs
c_func
(paren
id|pptr
(braket
l_int|1
)braket
)paren
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;Own skb_cow() beast, tweaked for rewriting commonly&n; *&t;used pointers in masq code&n; */
DECL|function|masq_skb_cow
r_static
r_struct
id|sk_buff
op_star
id|masq_skb_cow
c_func
(paren
r_struct
id|sk_buff
op_star
op_star
id|skb_p
comma
r_struct
id|iphdr
op_star
op_star
id|iph_p
comma
r_int
r_char
op_star
op_star
id|t_p
)paren
(brace
r_struct
id|sk_buff
op_star
id|skb
op_assign
(paren
op_star
id|skb_p
)paren
suffix:semicolon
r_if
c_cond
(paren
id|skb_cloned
c_func
(paren
id|skb
)paren
)paren
(brace
id|skb
op_assign
id|skb_copy
c_func
(paren
id|skb
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
id|skb
)paren
(brace
multiline_comment|/*&n;&t;&t;&t; *&t;skb changed, update other pointers&n;&t;&t;&t; */
r_struct
id|iphdr
op_star
id|iph
op_assign
id|skb-&gt;nh.iph
suffix:semicolon
id|kfree_skb
c_func
(paren
op_star
id|skb_p
)paren
suffix:semicolon
op_star
id|skb_p
op_assign
id|skb
suffix:semicolon
op_star
id|iph_p
op_assign
id|iph
suffix:semicolon
op_star
id|t_p
op_assign
(paren
r_char
op_star
)paren
id|iph
op_plus
id|iph-&gt;ihl
op_star
l_int|4
suffix:semicolon
)brace
)brace
r_return
id|skb
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;Handle ICMP messages in reverse (demasquerade) direction.&n; *&t;Find any that might be relevant, check against existing connections,&n; *&t;forward to masqueraded host if relevant.&n; *&t;Currently handles error types - unreachable, quench, ttl exceeded&n; */
DECL|function|ip_fw_demasq_icmp
r_int
id|ip_fw_demasq_icmp
c_func
(paren
r_struct
id|sk_buff
op_star
op_star
id|skb_p
)paren
(brace
r_struct
id|sk_buff
op_star
id|skb
op_assign
op_star
id|skb_p
suffix:semicolon
r_struct
id|iphdr
op_star
id|iph
op_assign
id|skb-&gt;nh.iph
suffix:semicolon
r_struct
id|icmphdr
op_star
id|icmph
op_assign
(paren
r_struct
id|icmphdr
op_star
)paren
(paren
(paren
r_char
op_star
)paren
id|iph
op_plus
(paren
id|iph-&gt;ihl
op_lshift
l_int|2
)paren
)paren
suffix:semicolon
r_struct
id|iphdr
op_star
id|ciph
suffix:semicolon
multiline_comment|/* The ip header contained within the ICMP */
id|__u16
op_star
id|pptr
suffix:semicolon
multiline_comment|/* port numbers from TCP/UDP contained header */
r_struct
id|ip_masq
op_star
id|ms
suffix:semicolon
r_int
r_int
id|len
op_assign
id|ntohs
c_func
(paren
id|iph-&gt;tot_len
)paren
op_minus
(paren
id|iph-&gt;ihl
op_star
l_int|4
)paren
suffix:semicolon
id|IP_MASQ_DEBUG
c_func
(paren
l_int|2
comma
l_string|&quot;icmp in/rev (%d,%d) %lX -&gt; %lX&bslash;n&quot;
comma
id|icmph-&gt;type
comma
id|ntohs
c_func
(paren
id|icmp_id
c_func
(paren
id|icmph
)paren
)paren
comma
id|ntohl
c_func
(paren
id|iph-&gt;saddr
)paren
comma
id|ntohl
c_func
(paren
id|iph-&gt;daddr
)paren
)paren
suffix:semicolon
macro_line|#ifdef CONFIG_IP_MASQUERADE_ICMP&t;&t;
r_if
c_cond
(paren
(paren
id|icmph-&gt;type
op_eq
id|ICMP_ECHOREPLY
)paren
op_logical_or
(paren
id|icmph-&gt;type
op_eq
id|ICMP_TIMESTAMPREPLY
)paren
op_logical_or
(paren
id|icmph-&gt;type
op_eq
id|ICMP_INFO_REPLY
)paren
op_logical_or
(paren
id|icmph-&gt;type
op_eq
id|ICMP_ADDRESSREPLY
)paren
)paren
(brace
id|IP_MASQ_DEBUG
c_func
(paren
l_int|2
comma
l_string|&quot;icmp reply rcv %lX-&gt;%lX id %d type %d, req %d&bslash;n&quot;
comma
id|ntohl
c_func
(paren
id|iph-&gt;saddr
)paren
comma
id|ntohl
c_func
(paren
id|iph-&gt;daddr
)paren
comma
id|ntohs
c_func
(paren
id|icmp_id
c_func
(paren
id|icmph
)paren
)paren
comma
id|icmph-&gt;type
comma
id|icmp_type_request
c_func
(paren
id|icmph-&gt;type
)paren
)paren
suffix:semicolon
id|ms
op_assign
id|ip_masq_in_get
c_func
(paren
id|iph-&gt;protocol
comma
id|iph-&gt;saddr
comma
id|icmp_hv_rep
c_func
(paren
id|icmph
)paren
comma
id|iph-&gt;daddr
comma
id|icmp_id
c_func
(paren
id|icmph
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ms
op_eq
l_int|NULL
)paren
r_return
l_int|0
suffix:semicolon
multiline_comment|/*&n;                 *&t;got reply, so clear flag&n;                 */
id|ms-&gt;flags
op_and_assign
op_complement
id|IP_MASQ_F_NO_REPLY
suffix:semicolon
r_if
c_cond
(paren
(paren
id|skb
op_assign
id|masq_skb_cow
c_func
(paren
id|skb_p
comma
op_amp
id|iph
comma
(paren
r_int
r_char
op_star
op_star
)paren
op_amp
id|icmph
)paren
)paren
op_eq
l_int|NULL
)paren
(brace
id|ip_masq_put
c_func
(paren
id|ms
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
multiline_comment|/* Reset source address */
id|iph-&gt;daddr
op_assign
id|ms-&gt;saddr
suffix:semicolon
multiline_comment|/* Redo IP header checksum */
id|ip_send_check
c_func
(paren
id|iph
)paren
suffix:semicolon
multiline_comment|/* Set ID to fake port number */
(paren
id|icmph-&gt;un
)paren
dot
id|echo.id
op_assign
id|ms-&gt;sport
suffix:semicolon
multiline_comment|/* Reset ICMP checksum and set expiry */
id|icmph-&gt;checksum
op_assign
l_int|0
suffix:semicolon
id|icmph-&gt;checksum
op_assign
id|ip_compute_csum
c_func
(paren
(paren
r_int
r_char
op_star
)paren
id|icmph
comma
id|len
)paren
suffix:semicolon
id|IP_MASQ_DEBUG
c_func
(paren
l_int|2
comma
l_string|&quot;icmp reply rwt %lX-&gt;%lX id %d type %d&bslash;n&quot;
comma
id|ntohl
c_func
(paren
id|iph-&gt;saddr
)paren
comma
id|ntohl
c_func
(paren
id|iph-&gt;daddr
)paren
comma
id|ntohs
c_func
(paren
id|icmp_id
c_func
(paren
id|icmph
)paren
)paren
comma
id|icmph-&gt;type
)paren
suffix:semicolon
id|masq_set_state
c_func
(paren
id|ms
comma
l_int|0
comma
id|iph
comma
id|icmph
)paren
suffix:semicolon
id|ip_masq_put
c_func
(paren
id|ms
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
r_else
(brace
macro_line|#endif
r_if
c_cond
(paren
(paren
id|icmph-&gt;type
op_ne
id|ICMP_DEST_UNREACH
)paren
op_logical_and
(paren
id|icmph-&gt;type
op_ne
id|ICMP_SOURCE_QUENCH
)paren
op_logical_and
(paren
id|icmph-&gt;type
op_ne
id|ICMP_TIME_EXCEEDED
)paren
)paren
r_return
l_int|0
suffix:semicolon
macro_line|#ifdef CONFIG_IP_MASQUERADE_ICMP
)brace
macro_line|#endif
multiline_comment|/*&n;&t; * If we get here we have an ICMP error of one of the above 3 types&n;&t; * Now find the contained IP header&n;&t; */
id|ciph
op_assign
(paren
r_struct
id|iphdr
op_star
)paren
(paren
id|icmph
op_plus
l_int|1
)paren
suffix:semicolon
macro_line|#ifdef CONFIG_IP_MASQUERADE_ICMP
r_if
c_cond
(paren
id|ciph-&gt;protocol
op_eq
id|IPPROTO_ICMP
)paren
(brace
multiline_comment|/*&n;&t;&t; * This section handles ICMP errors for ICMP packets&n;&t;&t; *&n;&t;&t; * First get a new ICMP header structure out of the IP packet&n;&t;&t; */
r_struct
id|icmphdr
op_star
id|cicmph
op_assign
(paren
r_struct
id|icmphdr
op_star
)paren
(paren
(paren
r_char
op_star
)paren
id|ciph
op_plus
(paren
id|ciph-&gt;ihl
op_lshift
l_int|2
)paren
)paren
suffix:semicolon
id|IP_MASQ_DEBUG
c_func
(paren
l_int|2
comma
l_string|&quot;rv icmp/icmp rcv %lX-&gt;%lX id %d type %d&bslash;n&quot;
comma
id|ntohl
c_func
(paren
id|ciph-&gt;saddr
)paren
comma
id|ntohl
c_func
(paren
id|ciph-&gt;daddr
)paren
comma
id|ntohs
c_func
(paren
id|icmp_id
c_func
(paren
id|cicmph
)paren
)paren
comma
id|cicmph-&gt;type
)paren
suffix:semicolon
id|read_lock
c_func
(paren
op_amp
id|__ip_masq_lock
)paren
suffix:semicolon
id|ms
op_assign
id|__ip_masq_in_get
c_func
(paren
id|ciph-&gt;protocol
comma
id|ciph-&gt;daddr
comma
id|icmp_hv_req
c_func
(paren
id|cicmph
)paren
comma
id|ciph-&gt;saddr
comma
id|icmp_id
c_func
(paren
id|cicmph
)paren
)paren
suffix:semicolon
id|read_unlock
c_func
(paren
op_amp
id|__ip_masq_lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ms
op_eq
l_int|NULL
)paren
r_return
l_int|0
suffix:semicolon
r_if
c_cond
(paren
(paren
id|skb
op_assign
id|masq_skb_cow
c_func
(paren
id|skb_p
comma
op_amp
id|iph
comma
(paren
r_int
r_char
op_star
op_star
)paren
op_amp
id|icmph
)paren
)paren
op_eq
l_int|NULL
)paren
(brace
id|__ip_masq_put
c_func
(paren
id|ms
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|ciph
op_assign
(paren
r_struct
id|iphdr
op_star
)paren
(paren
id|icmph
op_plus
l_int|1
)paren
suffix:semicolon
id|cicmph
op_assign
(paren
r_struct
id|icmphdr
op_star
)paren
(paren
(paren
r_char
op_star
)paren
id|ciph
op_plus
(paren
id|ciph-&gt;ihl
op_lshift
l_int|2
)paren
)paren
suffix:semicolon
multiline_comment|/* Now we do real damage to this packet...! */
multiline_comment|/* First change the dest IP address, and recalc checksum */
id|iph-&gt;daddr
op_assign
id|ms-&gt;saddr
suffix:semicolon
id|ip_send_check
c_func
(paren
id|iph
)paren
suffix:semicolon
multiline_comment|/* Now change the *source* address in the contained IP */
id|ciph-&gt;saddr
op_assign
id|ms-&gt;saddr
suffix:semicolon
id|ip_send_check
c_func
(paren
id|ciph
)paren
suffix:semicolon
multiline_comment|/* Change the ID to the original one! */
(paren
id|cicmph-&gt;un
)paren
dot
id|echo.id
op_assign
id|ms-&gt;sport
suffix:semicolon
id|__ip_masq_put
c_func
(paren
id|ms
)paren
suffix:semicolon
multiline_comment|/* And finally the ICMP checksum */
id|icmph-&gt;checksum
op_assign
l_int|0
suffix:semicolon
id|icmph-&gt;checksum
op_assign
id|ip_compute_csum
c_func
(paren
(paren
r_int
r_char
op_star
)paren
id|icmph
comma
id|len
)paren
suffix:semicolon
id|IP_MASQ_DEBUG
c_func
(paren
l_int|2
comma
l_string|&quot;rv icmp/icmp rwt %lX-&gt;%lX id %d type %d&bslash;n&quot;
comma
id|ntohl
c_func
(paren
id|ciph-&gt;saddr
)paren
comma
id|ntohl
c_func
(paren
id|ciph-&gt;daddr
)paren
comma
id|ntohs
c_func
(paren
id|icmp_id
c_func
(paren
id|cicmph
)paren
)paren
comma
id|cicmph-&gt;type
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
macro_line|#endif /* CONFIG_IP_MASQUERADE_ICMP */
multiline_comment|/* We are only interested ICMPs generated from TCP or UDP packets */
r_if
c_cond
(paren
(paren
id|ciph-&gt;protocol
op_ne
id|IPPROTO_UDP
)paren
op_logical_and
(paren
id|ciph-&gt;protocol
op_ne
id|IPPROTO_TCP
)paren
)paren
r_return
l_int|0
suffix:semicolon
multiline_comment|/*&n;&t; * Find the ports involved - remember this packet was&n;&t; * *outgoing* so the ports are reversed (and addresses)&n;&t; */
id|pptr
op_assign
(paren
id|__u16
op_star
)paren
op_amp
(paren
(paren
(paren
r_char
op_star
)paren
id|ciph
)paren
(braket
id|ciph-&gt;ihl
op_star
l_int|4
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ntohs
c_func
(paren
id|pptr
(braket
l_int|0
)braket
)paren
template_param
id|PORT_MASQ_END
)paren
r_return
l_int|0
suffix:semicolon
multiline_comment|/* Ensure the checksum is correct */
r_if
c_cond
(paren
id|ip_compute_csum
c_func
(paren
(paren
r_int
r_char
op_star
)paren
id|icmph
comma
id|len
)paren
)paren
(brace
multiline_comment|/* Failed checksum! */
id|IP_MASQ_ERR
c_func
(paren
l_string|&quot;reverse ICMP: failed checksum from %d.%d.%d.%d!&bslash;n&quot;
comma
id|NIPQUAD
c_func
(paren
id|iph-&gt;saddr
)paren
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|IP_MASQ_DEBUG
c_func
(paren
l_int|2
comma
l_string|&quot;Handling reverse ICMP for %08lX:%04X -&gt; %08lX:%04X&bslash;n&quot;
comma
id|ntohl
c_func
(paren
id|ciph-&gt;saddr
)paren
comma
id|ntohs
c_func
(paren
id|pptr
(braket
l_int|0
)braket
)paren
comma
id|ntohl
c_func
(paren
id|ciph-&gt;daddr
)paren
comma
id|ntohs
c_func
(paren
id|pptr
(braket
l_int|1
)braket
)paren
)paren
suffix:semicolon
multiline_comment|/* This is pretty much what __ip_masq_in_get_iph() does, except params are wrong way round */
id|read_lock
c_func
(paren
op_amp
id|__ip_masq_lock
)paren
suffix:semicolon
id|ms
op_assign
id|__ip_masq_in_get
c_func
(paren
id|ciph-&gt;protocol
comma
id|ciph-&gt;daddr
comma
id|pptr
(braket
l_int|1
)braket
comma
id|ciph-&gt;saddr
comma
id|pptr
(braket
l_int|0
)braket
)paren
suffix:semicolon
id|read_unlock
c_func
(paren
op_amp
id|__ip_masq_lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ms
op_eq
l_int|NULL
)paren
r_return
l_int|0
suffix:semicolon
r_if
c_cond
(paren
(paren
id|skb
op_assign
id|masq_skb_cow
c_func
(paren
id|skb_p
comma
op_amp
id|iph
comma
(paren
r_int
r_char
op_star
op_star
)paren
op_amp
id|icmph
)paren
)paren
op_eq
l_int|NULL
)paren
(brace
id|__ip_masq_put
c_func
(paren
id|ms
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|ciph
op_assign
(paren
r_struct
id|iphdr
op_star
)paren
(paren
id|icmph
op_plus
l_int|1
)paren
suffix:semicolon
id|pptr
op_assign
(paren
id|__u16
op_star
)paren
op_amp
(paren
(paren
(paren
r_char
op_star
)paren
id|ciph
)paren
(braket
id|ciph-&gt;ihl
op_star
l_int|4
)braket
)paren
suffix:semicolon
multiline_comment|/* Now we do real damage to this packet...! */
multiline_comment|/* First change the dest IP address, and recalc checksum */
id|iph-&gt;daddr
op_assign
id|ms-&gt;saddr
suffix:semicolon
id|ip_send_check
c_func
(paren
id|iph
)paren
suffix:semicolon
multiline_comment|/* Now change the *source* address in the contained IP */
id|ciph-&gt;saddr
op_assign
id|ms-&gt;saddr
suffix:semicolon
id|ip_send_check
c_func
(paren
id|ciph
)paren
suffix:semicolon
multiline_comment|/* the TCP/UDP source port - cannot redo check */
id|pptr
(braket
l_int|0
)braket
op_assign
id|ms-&gt;sport
suffix:semicolon
id|__ip_masq_put
c_func
(paren
id|ms
)paren
suffix:semicolon
multiline_comment|/* And finally the ICMP checksum */
id|icmph-&gt;checksum
op_assign
l_int|0
suffix:semicolon
id|icmph-&gt;checksum
op_assign
id|ip_compute_csum
c_func
(paren
(paren
r_int
r_char
op_star
)paren
id|icmph
comma
id|len
)paren
suffix:semicolon
id|IP_MASQ_DEBUG
c_func
(paren
l_int|2
comma
l_string|&quot;Rewrote reverse ICMP to %08lX:%04X -&gt; %08lX:%04X&bslash;n&quot;
comma
id|ntohl
c_func
(paren
id|ciph-&gt;saddr
)paren
comma
id|ntohs
c_func
(paren
id|pptr
(braket
l_int|0
)braket
)paren
comma
id|ntohl
c_func
(paren
id|ciph-&gt;daddr
)paren
comma
id|ntohs
c_func
(paren
id|pptr
(braket
l_int|1
)braket
)paren
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
multiline_comment|/*&n;  *&t;Check if it&squot;s an masqueraded port, look it up,&n;  *&t;and send it on its way...&n;  *&n;  *&t;Better not have many hosts using the designated portrange&n;  *&t;as &squot;normal&squot; ports, or you&squot;ll be spending many time in&n;  *&t;this function.&n;  */
DECL|function|ip_fw_demasquerade
r_int
id|ip_fw_demasquerade
c_func
(paren
r_struct
id|sk_buff
op_star
op_star
id|skb_p
)paren
(brace
r_struct
id|sk_buff
op_star
id|skb
op_assign
op_star
id|skb_p
suffix:semicolon
r_struct
id|iphdr
op_star
id|iph
op_assign
id|skb-&gt;nh.iph
suffix:semicolon
r_union
id|ip_masq_tphdr
id|h
suffix:semicolon
r_struct
id|ip_masq
op_star
id|ms
suffix:semicolon
r_int
r_int
id|size
suffix:semicolon
r_int
id|doff
op_assign
l_int|0
suffix:semicolon
r_int
id|csum
op_assign
l_int|0
suffix:semicolon
r_int
id|csum_ok
op_assign
l_int|0
suffix:semicolon
id|__u32
id|maddr
suffix:semicolon
multiline_comment|/*&n;&t; *&t;Big tappo: only PACKET_HOST (nor loopback neither mcasts)&n;&t; *&t;... don&squot;t know why 1st test DOES NOT include 2nd (?)&n;&t; */
r_if
c_cond
(paren
id|skb-&gt;pkt_type
op_ne
id|PACKET_HOST
op_logical_or
id|skb-&gt;dev
op_eq
op_amp
id|loopback_dev
)paren
(brace
id|IP_MASQ_DEBUG
c_func
(paren
l_int|2
comma
l_string|&quot;ip_fw_demasquerade(): packet type=%d proto=%d daddr=%d.%d.%d.%d ignored&bslash;n&quot;
comma
id|skb-&gt;pkt_type
comma
id|iph-&gt;protocol
comma
id|NIPQUAD
c_func
(paren
id|iph-&gt;daddr
)paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|h.raw
op_assign
(paren
r_char
op_star
)paren
id|iph
op_plus
id|iph-&gt;ihl
op_star
l_int|4
suffix:semicolon
multiline_comment|/*&n;&t; *&t;IP payload size&n;&t; */
id|size
op_assign
id|ntohs
c_func
(paren
id|iph-&gt;tot_len
)paren
op_minus
(paren
id|iph-&gt;ihl
op_star
l_int|4
)paren
suffix:semicolon
id|doff
op_assign
id|proto_doff
c_func
(paren
id|iph-&gt;protocol
comma
id|h.raw
comma
id|size
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|doff
)paren
(brace
r_case
l_int|0
suffix:colon
multiline_comment|/*&n;&t;&t;&t; *&t;Input path: other IP protos Ok, will&n;&t;&t;&t; *&t;reach local sockets path.&n;&t;&t;&t; */
r_return
l_int|0
suffix:semicolon
r_case
op_minus
l_int|1
suffix:colon
id|IP_MASQ_DEBUG
c_func
(paren
l_int|0
comma
l_string|&quot;I-pkt invalid packet data size&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|maddr
op_assign
id|iph-&gt;daddr
suffix:semicolon
r_switch
c_cond
(paren
id|iph-&gt;protocol
)paren
(brace
r_case
id|IPPROTO_ICMP
suffix:colon
r_return
id|ip_fw_demasq_icmp
c_func
(paren
id|skb_p
)paren
suffix:semicolon
r_case
id|IPPROTO_TCP
suffix:colon
r_case
id|IPPROTO_UDP
suffix:colon
multiline_comment|/* &n;&t;&t; *&t;Make sure packet is in the masq range &n;&t;&t; *&t;... or some mod-ule relaxes input range&n;&t;&t; *&t;... or there is still some `special&squot; mport opened&n;&t;&t; */
r_if
c_cond
(paren
(paren
id|ntohs
c_func
(paren
id|h.portp
(braket
l_int|1
)braket
)paren
template_param
id|PORT_MASQ_END
)paren
macro_line|#ifdef CONFIG_IP_MASQUERADE_MOD
op_logical_and
(paren
id|ip_masq_mod_in_rule
c_func
(paren
id|skb
comma
id|iph
)paren
op_ne
l_int|1
)paren
macro_line|#endif
op_logical_and
id|atomic_read
c_func
(paren
op_amp
id|mport_count
)paren
op_eq
l_int|0
)paren
r_return
l_int|0
suffix:semicolon
multiline_comment|/* Check that the checksum is OK */
r_if
c_cond
(paren
(paren
id|iph-&gt;protocol
op_eq
id|IPPROTO_UDP
)paren
op_logical_and
(paren
id|h.uh-&gt;check
op_eq
l_int|0
)paren
)paren
multiline_comment|/* No UDP checksum */
r_break
suffix:semicolon
macro_line|#ifdef CONFIG_IP_MASQ_DEBUG
r_if
c_cond
(paren
id|ip_masq_get_debug_level
c_func
(paren
)paren
OG
l_int|3
)paren
(brace
id|skb-&gt;ip_summed
op_assign
id|CHECKSUM_NONE
suffix:semicolon
)brace
macro_line|#endif
r_switch
c_cond
(paren
id|skb-&gt;ip_summed
)paren
(brace
r_case
id|CHECKSUM_NONE
suffix:colon
id|csum
op_assign
id|csum_partial
c_func
(paren
id|h.raw
op_plus
id|doff
comma
id|size
op_minus
id|doff
comma
l_int|0
)paren
suffix:semicolon
id|csum_ok
op_increment
suffix:semicolon
id|skb-&gt;csum
op_assign
id|csum_partial
c_func
(paren
id|h.raw
comma
id|doff
comma
id|csum
)paren
suffix:semicolon
r_case
id|CHECKSUM_HW
suffix:colon
r_if
c_cond
(paren
id|csum_tcpudp_magic
c_func
(paren
id|iph-&gt;saddr
comma
id|iph-&gt;daddr
comma
id|size
comma
id|iph-&gt;protocol
comma
id|skb-&gt;csum
)paren
)paren
(brace
id|IP_MASQ_DEBUG
c_func
(paren
l_int|0
comma
l_string|&quot;Incoming failed %s checksum from %d.%d.%d.%d (size=%d)!&bslash;n&quot;
comma
id|masq_proto_name
c_func
(paren
id|iph-&gt;protocol
)paren
comma
id|NIPQUAD
c_func
(paren
id|iph-&gt;saddr
)paren
comma
id|size
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
r_default
suffix:colon
(brace
)brace
multiline_comment|/* CHECKSUM_UNNECESSARY */
)brace
r_break
suffix:semicolon
r_default
suffix:colon
r_return
l_int|0
suffix:semicolon
)brace
id|IP_MASQ_DEBUG
c_func
(paren
l_int|2
comma
l_string|&quot;Incoming %s %08lX:%04X -&gt; %08lX:%04X&bslash;n&quot;
comma
id|masq_proto_name
c_func
(paren
id|iph-&gt;protocol
)paren
comma
id|ntohl
c_func
(paren
id|iph-&gt;saddr
)paren
comma
id|ntohs
c_func
(paren
id|h.portp
(braket
l_int|0
)braket
)paren
comma
id|ntohl
c_func
(paren
id|iph-&gt;daddr
)paren
comma
id|ntohs
c_func
(paren
id|h.portp
(braket
l_int|1
)braket
)paren
)paren
suffix:semicolon
multiline_comment|/*&n; &t; * reroute to original host:port if found...&n;         */
id|ms
op_assign
id|ip_masq_in_get_iph
c_func
(paren
id|iph
)paren
suffix:semicolon
multiline_comment|/*&n; &t; * &t;Give additional modules a chance to create an entry&n;&t; */
macro_line|#ifdef CONFIG_IP_MASQUERADE_MOD
r_if
c_cond
(paren
op_logical_neg
id|ms
)paren
id|ms
op_assign
id|ip_masq_mod_in_create
c_func
(paren
id|skb
comma
id|iph
comma
id|maddr
)paren
suffix:semicolon
multiline_comment|/*&n; &t; * &t;Call module&squot;s input update hook&n;&t; */
id|ip_masq_mod_in_update
c_func
(paren
id|skb
comma
id|iph
comma
id|ms
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|ms
op_ne
l_int|NULL
)paren
(brace
multiline_comment|/*&n;                 *&t;got reply, so clear flag&n;                 */
id|ms-&gt;flags
op_and_assign
op_complement
id|IP_MASQ_F_NO_REPLY
suffix:semicolon
multiline_comment|/*&n;&t;&t; *&t;Set daddr,dport if not defined yet&n;&t;&t; *&t;and tunnel is not setup as &quot;dest loose&quot;&n;                 */
r_if
c_cond
(paren
id|ms-&gt;flags
op_amp
id|IP_MASQ_F_DLOOSE
)paren
(brace
multiline_comment|/*&n;&t;&t;&t; *&t;update dest loose values&n;&t;&t;&t; */
id|ms-&gt;dport
op_assign
id|h.portp
(braket
l_int|0
)braket
suffix:semicolon
id|ms-&gt;daddr
op_assign
id|iph-&gt;saddr
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|ms-&gt;flags
op_amp
id|IP_MASQ_F_NO_DPORT
)paren
(brace
multiline_comment|/*  &amp;&amp; ms-&gt;protocol == IPPROTO_TCP ) { */
id|ms-&gt;flags
op_and_assign
op_complement
id|IP_MASQ_F_NO_DPORT
suffix:semicolon
id|ms-&gt;dport
op_assign
id|h.portp
(braket
l_int|0
)braket
suffix:semicolon
id|IP_MASQ_DEBUG
c_func
(paren
l_int|1
comma
l_string|&quot;ip_fw_demasquerade(): filled dport=%d&bslash;n&quot;
comma
id|ntohs
c_func
(paren
id|ms-&gt;dport
)paren
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ms-&gt;flags
op_amp
id|IP_MASQ_F_NO_DADDR
)paren
(brace
multiline_comment|/*  &amp;&amp; ms-&gt;protocol == IPPROTO_TCP)  { */
id|ms-&gt;flags
op_and_assign
op_complement
id|IP_MASQ_F_NO_DADDR
suffix:semicolon
id|ms-&gt;daddr
op_assign
id|iph-&gt;saddr
suffix:semicolon
id|IP_MASQ_DEBUG
c_func
(paren
l_int|1
comma
l_string|&quot;ip_fw_demasquerade(): filled daddr=%lX&bslash;n&quot;
comma
id|ntohl
c_func
(paren
id|ms-&gt;daddr
)paren
)paren
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
(paren
id|skb
op_assign
id|masq_skb_cow
c_func
(paren
id|skb_p
comma
op_amp
id|iph
comma
op_amp
id|h.raw
)paren
)paren
op_eq
l_int|NULL
)paren
(brace
id|ip_masq_put
c_func
(paren
id|ms
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|iph-&gt;daddr
op_assign
id|ms-&gt;saddr
suffix:semicolon
id|h.portp
(braket
l_int|1
)braket
op_assign
id|ms-&gt;sport
suffix:semicolon
multiline_comment|/*&n;&t;&t; *&t;Invalidate csum saving if tunnel has masq helper&n;&t;&t; */
r_if
c_cond
(paren
id|ms-&gt;app
)paren
id|csum_ok
op_assign
l_int|0
suffix:semicolon
multiline_comment|/*&n;                 *&t;Attempt ip_masq_app call.&n;                 *&t;will fix ip_masq and iph ack_seq stuff&n;                 */
r_if
c_cond
(paren
id|ip_masq_app_pkt_in
c_func
(paren
id|ms
comma
id|skb_p
comma
id|maddr
)paren
op_ne
l_int|0
)paren
(brace
multiline_comment|/*&n;                         *&t;skb has changed, update pointers.&n;                         */
id|skb
op_assign
op_star
id|skb_p
suffix:semicolon
id|iph
op_assign
id|skb-&gt;nh.iph
suffix:semicolon
id|h.raw
op_assign
(paren
r_char
op_star
)paren
id|iph
op_plus
id|iph-&gt;ihl
op_star
l_int|4
suffix:semicolon
id|size
op_assign
id|ntohs
c_func
(paren
id|iph-&gt;tot_len
)paren
op_minus
(paren
id|iph-&gt;ihl
op_star
l_int|4
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;                 * Yug! adjust UDP/TCP checksums&n;&t;&t; */
multiline_comment|/*&n;&t;&t; *&t;Transport&squot;s payload partial csum&n;&t;&t; */
r_if
c_cond
(paren
op_logical_neg
id|csum_ok
)paren
(brace
id|csum
op_assign
id|csum_partial
c_func
(paren
id|h.raw
op_plus
id|doff
comma
id|size
op_minus
id|doff
comma
l_int|0
)paren
suffix:semicolon
)brace
id|skb-&gt;csum
op_assign
id|csum
suffix:semicolon
multiline_comment|/*&n;&t;&t; * &t;Protocol csum&n;&t;&t; */
r_switch
c_cond
(paren
id|iph-&gt;protocol
)paren
(brace
r_case
id|IPPROTO_TCP
suffix:colon
id|h.th-&gt;check
op_assign
l_int|0
suffix:semicolon
id|h.th-&gt;check
op_assign
id|csum_tcpudp_magic
c_func
(paren
id|iph-&gt;saddr
comma
id|iph-&gt;daddr
comma
id|size
comma
id|iph-&gt;protocol
comma
id|csum_partial
c_func
(paren
id|h.raw
comma
id|doff
comma
id|csum
)paren
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|IPPROTO_UDP
suffix:colon
id|h.uh-&gt;check
op_assign
l_int|0
suffix:semicolon
id|h.uh-&gt;check
op_assign
id|csum_tcpudp_magic
c_func
(paren
id|iph-&gt;saddr
comma
id|iph-&gt;daddr
comma
id|size
comma
id|iph-&gt;protocol
comma
id|csum_partial
c_func
(paren
id|h.raw
comma
id|doff
comma
id|csum
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|h.uh-&gt;check
op_eq
l_int|0
)paren
id|h.uh-&gt;check
op_assign
l_int|0xFFFF
suffix:semicolon
r_break
suffix:semicolon
)brace
id|ip_send_check
c_func
(paren
id|iph
)paren
suffix:semicolon
id|IP_MASQ_DEBUG
c_func
(paren
l_int|2
comma
l_string|&quot;I-routed to %08lX:%04X&bslash;n&quot;
comma
id|ntohl
c_func
(paren
id|iph-&gt;daddr
)paren
comma
id|ntohs
c_func
(paren
id|h.portp
(braket
l_int|1
)braket
)paren
)paren
suffix:semicolon
id|masq_set_state
(paren
id|ms
comma
l_int|0
comma
id|iph
comma
id|h.portp
)paren
suffix:semicolon
id|ip_masq_put
c_func
(paren
id|ms
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
multiline_comment|/* sorry, all this trouble for a no-hit :) */
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|ip_masq_control_add
r_void
id|ip_masq_control_add
c_func
(paren
r_struct
id|ip_masq
op_star
id|ms
comma
r_struct
id|ip_masq
op_star
id|ctl_ms
)paren
(brace
r_if
c_cond
(paren
id|ms-&gt;control
)paren
(brace
id|IP_MASQ_ERR
c_func
(paren
l_string|&quot;request control ADD for already controlled: %d.%d.%d.%d:%d to %d.%d.%d.%d:%d&bslash;n&quot;
comma
id|NIPQUAD
c_func
(paren
id|ms-&gt;saddr
)paren
comma
id|ntohs
c_func
(paren
id|ms-&gt;sport
)paren
comma
id|NIPQUAD
c_func
(paren
id|ms-&gt;daddr
)paren
comma
id|ntohs
c_func
(paren
id|ms-&gt;dport
)paren
)paren
suffix:semicolon
id|ip_masq_control_del
c_func
(paren
id|ms
)paren
suffix:semicolon
)brace
id|IP_MASQ_DEBUG
c_func
(paren
l_int|1
comma
l_string|&quot;ADDing control for: ms.dst=%d.%d.%d.%d:%d ctl_ms.dst=%d.%d.%d.%d:%d&bslash;n&quot;
comma
id|NIPQUAD
c_func
(paren
id|ms-&gt;daddr
)paren
comma
id|ntohs
c_func
(paren
id|ms-&gt;dport
)paren
comma
id|NIPQUAD
c_func
(paren
id|ctl_ms-&gt;daddr
)paren
comma
id|ntohs
c_func
(paren
id|ctl_ms-&gt;dport
)paren
)paren
suffix:semicolon
id|ms-&gt;control
op_assign
id|ctl_ms
suffix:semicolon
id|atomic_inc
c_func
(paren
op_amp
id|ctl_ms-&gt;n_control
)paren
suffix:semicolon
)brace
DECL|function|ip_masq_control_del
r_void
id|ip_masq_control_del
c_func
(paren
r_struct
id|ip_masq
op_star
id|ms
)paren
(brace
r_struct
id|ip_masq
op_star
id|ctl_ms
op_assign
id|ms-&gt;control
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ctl_ms
)paren
(brace
id|IP_MASQ_ERR
c_func
(paren
l_string|&quot;request control DEL for uncontrolled: %d.%d.%d.%d:%d to %d.%d.%d.%d:%d&bslash;n&quot;
comma
id|NIPQUAD
c_func
(paren
id|ms-&gt;saddr
)paren
comma
id|ntohs
c_func
(paren
id|ms-&gt;sport
)paren
comma
id|NIPQUAD
c_func
(paren
id|ms-&gt;daddr
)paren
comma
id|ntohs
c_func
(paren
id|ms-&gt;dport
)paren
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|IP_MASQ_DEBUG
c_func
(paren
l_int|1
comma
l_string|&quot;DELeting control for: ms.dst=%d.%d.%d.%d:%d ctl_ms.dst=%d.%d.%d.%d:%d&bslash;n&quot;
comma
id|NIPQUAD
c_func
(paren
id|ms-&gt;daddr
)paren
comma
id|ntohs
c_func
(paren
id|ms-&gt;dport
)paren
comma
id|NIPQUAD
c_func
(paren
id|ctl_ms-&gt;daddr
)paren
comma
id|ntohs
c_func
(paren
id|ctl_ms-&gt;dport
)paren
)paren
suffix:semicolon
id|ms-&gt;control
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
id|atomic_read
c_func
(paren
op_amp
id|ctl_ms-&gt;n_control
)paren
op_eq
l_int|0
)paren
(brace
id|IP_MASQ_ERR
c_func
(paren
l_string|&quot;BUG control DEL with n=0 : %d.%d.%d.%d:%d to %d.%d.%d.%d:%d&bslash;n&quot;
comma
id|NIPQUAD
c_func
(paren
id|ms-&gt;saddr
)paren
comma
id|ntohs
c_func
(paren
id|ms-&gt;sport
)paren
comma
id|NIPQUAD
c_func
(paren
id|ms-&gt;daddr
)paren
comma
id|ntohs
c_func
(paren
id|ms-&gt;dport
)paren
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|atomic_dec
c_func
(paren
op_amp
id|ctl_ms-&gt;n_control
)paren
suffix:semicolon
)brace
DECL|function|ip_masq_control_get
r_struct
id|ip_masq
op_star
id|ip_masq_control_get
c_func
(paren
r_struct
id|ip_masq
op_star
id|ms
)paren
(brace
r_return
id|ms-&gt;control
suffix:semicolon
)brace
macro_line|#ifdef CONFIG_PROC_FS
multiline_comment|/*&n; *&t;/proc/net entries&n; *&t;From userspace&n; */
DECL|function|ip_msqhst_procinfo
r_static
r_int
id|ip_msqhst_procinfo
c_func
(paren
r_char
op_star
id|buffer
comma
r_char
op_star
op_star
id|start
comma
id|off_t
id|offset
comma
r_int
id|length
comma
r_int
id|unused
)paren
(brace
id|off_t
id|pos
op_assign
l_int|0
comma
id|begin
suffix:semicolon
r_struct
id|ip_masq
op_star
id|ms
suffix:semicolon
r_char
id|temp
(braket
l_int|129
)braket
suffix:semicolon
r_int
id|idx
op_assign
l_int|0
suffix:semicolon
r_int
id|len
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|offset
OL
l_int|128
)paren
(brace
id|sprintf
c_func
(paren
id|temp
comma
l_string|&quot;Prc FromIP   FPrt ToIP     TPrt Masq Init-seq  Delta PDelta Expires (free=%d,%d,%d)&quot;
comma
id|atomic_read
c_func
(paren
id|ip_masq_free_ports
)paren
comma
id|atomic_read
c_func
(paren
id|ip_masq_free_ports
op_plus
l_int|1
)paren
comma
id|atomic_read
c_func
(paren
id|ip_masq_free_ports
op_plus
l_int|2
)paren
)paren
suffix:semicolon
id|len
op_assign
id|sprintf
c_func
(paren
id|buffer
comma
l_string|&quot;%-127s&bslash;n&quot;
comma
id|temp
)paren
suffix:semicolon
)brace
id|pos
op_assign
l_int|128
suffix:semicolon
r_for
c_loop
(paren
id|idx
op_assign
l_int|0
suffix:semicolon
id|idx
OL
id|IP_MASQ_TAB_SIZE
suffix:semicolon
id|idx
op_increment
)paren
(brace
multiline_comment|/*&n;&t; *&t;Lock is actually only need in next loop &n;&t; *&t;we are called from uspace: must stop bh.&n;&t; */
id|read_lock_bh
c_func
(paren
op_amp
id|__ip_masq_lock
)paren
suffix:semicolon
r_for
c_loop
(paren
id|ms
op_assign
id|ip_masq_m_tab
(braket
id|idx
)braket
suffix:semicolon
id|ms
suffix:semicolon
id|ms
op_assign
id|ms-&gt;m_link
)paren
(brace
id|pos
op_add_assign
l_int|128
suffix:semicolon
r_if
c_cond
(paren
id|pos
op_le
id|offset
)paren
(brace
id|len
op_assign
l_int|0
suffix:semicolon
r_continue
suffix:semicolon
)brace
multiline_comment|/*&n;&t;&t; *&t;We have locked the tables, no need to del/add timers&n;&t;&t; *&t;nor cli()  8)&n;&t;&t; */
id|sprintf
c_func
(paren
id|temp
comma
l_string|&quot;%s %08lX:%04X %08lX:%04X %04X %08X %6d %6d %7lu&quot;
comma
id|masq_proto_name
c_func
(paren
id|ms-&gt;protocol
)paren
comma
id|ntohl
c_func
(paren
id|ms-&gt;saddr
)paren
comma
id|ntohs
c_func
(paren
id|ms-&gt;sport
)paren
comma
id|ntohl
c_func
(paren
id|ms-&gt;daddr
)paren
comma
id|ntohs
c_func
(paren
id|ms-&gt;dport
)paren
comma
id|ntohs
c_func
(paren
id|ms-&gt;mport
)paren
comma
id|ms-&gt;out_seq.init_seq
comma
id|ms-&gt;out_seq.delta
comma
id|ms-&gt;out_seq.previous_delta
comma
id|ms-&gt;timer.expires
op_minus
id|jiffies
)paren
suffix:semicolon
id|len
op_add_assign
id|sprintf
c_func
(paren
id|buffer
op_plus
id|len
comma
l_string|&quot;%-127s&bslash;n&quot;
comma
id|temp
)paren
suffix:semicolon
r_if
c_cond
(paren
id|len
op_ge
id|length
)paren
(brace
id|read_unlock_bh
c_func
(paren
op_amp
id|__ip_masq_lock
)paren
suffix:semicolon
r_goto
id|done
suffix:semicolon
)brace
)brace
id|read_unlock_bh
c_func
(paren
op_amp
id|__ip_masq_lock
)paren
suffix:semicolon
)brace
id|done
suffix:colon
id|begin
op_assign
id|len
op_minus
(paren
id|pos
op_minus
id|offset
)paren
suffix:semicolon
op_star
id|start
op_assign
id|buffer
op_plus
id|begin
suffix:semicolon
id|len
op_sub_assign
id|begin
suffix:semicolon
r_if
c_cond
(paren
id|len
OG
id|length
)paren
(brace
id|len
op_assign
id|length
suffix:semicolon
)brace
r_return
id|len
suffix:semicolon
)brace
macro_line|#endif
multiline_comment|/* &n; *&t;Timeouts handling by ipfwadm/ipchains&n; * &t;From ip_fw.c&n; */
DECL|function|ip_fw_masq_timeouts
r_int
id|ip_fw_masq_timeouts
c_func
(paren
r_void
op_star
id|m
comma
r_int
id|len
)paren
(brace
r_struct
id|ip_fw_masq
op_star
id|masq
suffix:semicolon
r_int
id|ret
op_assign
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|len
op_ne
r_sizeof
(paren
r_struct
id|ip_fw_masq
)paren
)paren
(brace
id|IP_MASQ_DEBUG
c_func
(paren
l_int|1
comma
l_string|&quot;ip_fw_masq_timeouts: length %d, expected %d&bslash;n&quot;
comma
id|len
comma
r_sizeof
(paren
r_struct
id|ip_fw_masq
)paren
)paren
suffix:semicolon
)brace
r_else
(brace
id|masq
op_assign
(paren
r_struct
id|ip_fw_masq
op_star
)paren
id|m
suffix:semicolon
r_if
c_cond
(paren
id|masq-&gt;tcp_timeout
)paren
id|masq_timeout_table.timeout
(braket
id|IP_MASQ_S_ESTABLISHED
)braket
op_assign
id|masq-&gt;tcp_timeout
suffix:semicolon
r_if
c_cond
(paren
id|masq-&gt;tcp_fin_timeout
)paren
id|masq_timeout_table.timeout
(braket
id|IP_MASQ_S_FIN_WAIT
)braket
op_assign
id|masq-&gt;tcp_fin_timeout
suffix:semicolon
r_if
c_cond
(paren
id|masq-&gt;udp_timeout
)paren
id|masq_timeout_table.timeout
(braket
id|IP_MASQ_S_UDP
)braket
op_assign
id|masq-&gt;udp_timeout
suffix:semicolon
id|ret
op_assign
l_int|0
suffix:semicolon
)brace
r_return
id|ret
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;Module autoloading stuff&n; */
DECL|function|ip_masq_user_check_hook
r_static
r_int
id|ip_masq_user_check_hook
c_func
(paren
r_void
)paren
(brace
macro_line|#ifdef CONFIG_KMOD
r_if
c_cond
(paren
id|ip_masq_user_hook
op_eq
l_int|NULL
)paren
(brace
id|IP_MASQ_DEBUG
c_func
(paren
l_int|1
comma
l_string|&quot;About to request &bslash;&quot;ip_masq_user&bslash;&quot; module&bslash;n&quot;
)paren
suffix:semicolon
id|request_module
c_func
(paren
l_string|&quot;ip_masq_user&quot;
)paren
suffix:semicolon
)brace
macro_line|#endif /* CONFIG_KMOD */
r_return
(paren
id|ip_masq_user_hook
op_ne
l_int|NULL
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;user module hook- info&n; */
DECL|function|ip_masq_user_info
r_static
r_int
id|ip_masq_user_info
c_func
(paren
r_char
op_star
id|buffer
comma
r_char
op_star
op_star
id|start
comma
id|off_t
id|offset
comma
r_int
id|len
comma
r_int
op_star
id|eof
comma
r_void
op_star
id|data
)paren
(brace
r_int
id|ret
op_assign
op_minus
id|ENOPKG
suffix:semicolon
r_if
c_cond
(paren
id|ip_masq_user_check_hook
c_func
(paren
)paren
)paren
(brace
id|ret
op_assign
id|ip_masq_user_hook
op_member_access_from_pointer
id|info
c_func
(paren
id|buffer
comma
id|start
comma
id|offset
comma
id|len
comma
(paren
r_int
)paren
id|data
)paren
suffix:semicolon
)brace
r_return
id|ret
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;user module hook- entry mgmt&n; */
DECL|function|ip_masq_user_ctl
r_static
r_int
id|ip_masq_user_ctl
c_func
(paren
r_int
id|optname
comma
r_void
op_star
id|arg
comma
r_int
id|arglen
)paren
(brace
r_int
id|ret
op_assign
op_minus
id|ENOPKG
suffix:semicolon
r_if
c_cond
(paren
id|ip_masq_user_check_hook
c_func
(paren
)paren
)paren
(brace
id|ret
op_assign
id|ip_masq_user_hook
op_member_access_from_pointer
id|ctl
c_func
(paren
id|optname
comma
id|arg
comma
id|arglen
)paren
suffix:semicolon
)brace
r_return
id|ret
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;Control from ip_sockglue&n; *&t;MAIN ENTRY point from userspace (apart from /proc *info entries)&n; *&t;Returns errno&n; */
DECL|function|ip_masq_uctl
r_int
id|ip_masq_uctl
c_func
(paren
r_int
id|optname
comma
r_char
op_star
id|optval
comma
r_int
id|optlen
)paren
(brace
r_struct
id|ip_masq_ctl
id|masq_ctl
suffix:semicolon
r_int
id|ret
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|optlen
OG
r_sizeof
(paren
id|masq_ctl
)paren
)paren
(brace
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|masq_ctl
comma
id|optval
comma
id|optlen
)paren
)paren
(brace
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
id|IP_MASQ_DEBUG
c_func
(paren
l_int|1
comma
l_string|&quot;ip_masq_ctl(optname=%d, optlen=%d, target=%d, cmd=%d)&bslash;n&quot;
comma
id|optname
comma
id|optlen
comma
id|masq_ctl.m_target
comma
id|masq_ctl.m_cmd
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|masq_ctl.m_target
)paren
(brace
r_case
id|IP_MASQ_TARGET_USER
suffix:colon
id|ret
op_assign
id|ip_masq_user_ctl
c_func
(paren
id|optname
comma
op_amp
id|masq_ctl
comma
id|optlen
)paren
suffix:semicolon
r_break
suffix:semicolon
macro_line|#ifdef CONFIG_IP_MASQUERADE_MOD
r_case
id|IP_MASQ_TARGET_MOD
suffix:colon
id|ret
op_assign
id|ip_masq_mod_ctl
c_func
(paren
id|optname
comma
op_amp
id|masq_ctl
comma
id|optlen
)paren
suffix:semicolon
r_break
suffix:semicolon
macro_line|#endif
)brace
multiline_comment|/* &t;&n;&t; *&t;If ret&gt;0, copy to user space &n;&t; */
r_if
c_cond
(paren
id|ret
OG
l_int|0
op_logical_and
id|ret
op_le
r_sizeof
(paren
id|masq_ctl
)paren
)paren
(brace
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
id|optval
comma
op_amp
id|masq_ctl
comma
id|ret
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
id|ret
op_assign
l_int|0
suffix:semicolon
)brace
r_return
id|ret
suffix:semicolon
)brace
macro_line|#ifdef CONFIG_PROC_FS
DECL|variable|proc_net_ip_masq
r_static
r_struct
id|proc_dir_entry
op_star
id|proc_net_ip_masq
op_assign
l_int|NULL
suffix:semicolon
macro_line|#ifdef MODULE
DECL|function|ip_masq_proc_count
r_static
r_void
id|ip_masq_proc_count
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_int
id|fill
)paren
(brace
r_if
c_cond
(paren
id|fill
)paren
id|MOD_INC_USE_COUNT
suffix:semicolon
r_else
id|MOD_DEC_USE_COUNT
suffix:semicolon
)brace
macro_line|#endif
DECL|function|ip_masq_proc_register
r_int
id|ip_masq_proc_register
c_func
(paren
r_struct
id|proc_dir_entry
op_star
id|ent
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|proc_net_ip_masq
)paren
r_return
op_minus
l_int|1
suffix:semicolon
id|IP_MASQ_DEBUG
c_func
(paren
l_int|1
comma
l_string|&quot;registering &bslash;&quot;/proc/net/ip_masq/%s&bslash;&quot; entry&bslash;n&quot;
comma
id|ent-&gt;name
)paren
suffix:semicolon
r_return
id|proc_register
c_func
(paren
id|proc_net_ip_masq
comma
id|ent
)paren
suffix:semicolon
)brace
DECL|function|ip_masq_proc_unregister
r_void
id|ip_masq_proc_unregister
c_func
(paren
r_struct
id|proc_dir_entry
op_star
id|ent
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|proc_net_ip_masq
)paren
r_return
suffix:semicolon
id|IP_MASQ_DEBUG
c_func
(paren
l_int|1
comma
l_string|&quot;unregistering &bslash;&quot;/proc/net/ip_masq/%s&bslash;&quot; entry&bslash;n&quot;
comma
id|ent-&gt;name
)paren
suffix:semicolon
id|proc_unregister
c_func
(paren
id|proc_net_ip_masq
comma
id|ent-&gt;low_ino
)paren
suffix:semicolon
)brace
DECL|function|__initfunc
id|__initfunc
c_func
(paren
r_static
r_void
id|masq_proc_init
c_func
(paren
r_void
)paren
)paren
(brace
id|IP_MASQ_DEBUG
c_func
(paren
l_int|1
comma
l_string|&quot;registering /proc/net/ip_masq&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|proc_net_ip_masq
)paren
(brace
r_struct
id|proc_dir_entry
op_star
id|ent
suffix:semicolon
id|ent
op_assign
id|create_proc_entry
c_func
(paren
l_string|&quot;net/ip_masq&quot;
comma
id|S_IFDIR
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ent
)paren
(brace
macro_line|#ifdef MODULE
id|ent-&gt;fill_inode
op_assign
id|ip_masq_proc_count
suffix:semicolon
macro_line|#endif
id|proc_net_ip_masq
op_assign
id|ent
suffix:semicolon
)brace
r_else
(brace
id|IP_MASQ_ERR
c_func
(paren
l_string|&quot;Could not create &bslash;&quot;/proc/net/ip_masq&bslash;&quot; entry&bslash;n&quot;
)paren
suffix:semicolon
)brace
)brace
)brace
macro_line|#endif&t;/* CONFIG_PROC_FS */
multiline_comment|/*&n; *&t;Wrapper over inet_select_addr()&n; */
DECL|function|ip_masq_select_addr
id|u32
id|ip_masq_select_addr
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
id|u32
id|dst
comma
r_int
id|scope
)paren
(brace
r_return
id|inet_select_addr
c_func
(paren
id|dev
comma
id|dst
comma
id|scope
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;Initialize ip masquerading&n; */
DECL|function|__initfunc
id|__initfunc
c_func
(paren
r_int
id|ip_masq_init
c_func
(paren
r_void
)paren
)paren
(brace
macro_line|#ifdef CONFIG_PROC_FS        
id|proc_net_register
c_func
(paren
op_amp
(paren
r_struct
id|proc_dir_entry
)paren
(brace
id|PROC_NET_IPMSQHST
comma
l_int|13
comma
l_string|&quot;ip_masquerade&quot;
comma
id|S_IFREG
op_or
id|S_IRUGO
comma
l_int|1
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
op_amp
id|proc_net_inode_operations
comma
id|ip_msqhst_procinfo
)brace
)paren
suffix:semicolon
id|masq_proc_init
c_func
(paren
)paren
suffix:semicolon
id|ip_masq_proc_register
c_func
(paren
op_amp
(paren
r_struct
id|proc_dir_entry
)paren
(brace
l_int|0
comma
l_int|3
comma
l_string|&quot;tcp&quot;
comma
id|S_IFREG
op_or
id|S_IRUGO
comma
l_int|1
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
op_amp
id|proc_net_inode_operations
comma
l_int|NULL
comma
multiline_comment|/* get_info */
l_int|NULL
comma
multiline_comment|/* fill_inode */
l_int|NULL
comma
l_int|NULL
comma
l_int|NULL
comma
(paren
r_char
op_star
)paren
id|IPPROTO_TCP
comma
id|ip_masq_user_info
)brace
)paren
suffix:semicolon
id|ip_masq_proc_register
c_func
(paren
op_amp
(paren
r_struct
id|proc_dir_entry
)paren
(brace
l_int|0
comma
l_int|3
comma
l_string|&quot;udp&quot;
comma
id|S_IFREG
op_or
id|S_IRUGO
comma
l_int|1
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
op_amp
id|proc_net_inode_operations
comma
l_int|NULL
comma
multiline_comment|/* get_info */
l_int|NULL
comma
multiline_comment|/* fill_inode */
l_int|NULL
comma
l_int|NULL
comma
l_int|NULL
comma
(paren
r_char
op_star
)paren
id|IPPROTO_UDP
comma
id|ip_masq_user_info
)brace
)paren
suffix:semicolon
id|ip_masq_proc_register
c_func
(paren
op_amp
(paren
r_struct
id|proc_dir_entry
)paren
(brace
l_int|0
comma
l_int|4
comma
l_string|&quot;icmp&quot;
comma
id|S_IFREG
op_or
id|S_IRUGO
comma
l_int|1
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
op_amp
id|proc_net_inode_operations
comma
l_int|NULL
comma
multiline_comment|/* get_info */
l_int|NULL
comma
multiline_comment|/* fill_inode */
l_int|NULL
comma
l_int|NULL
comma
l_int|NULL
comma
(paren
r_char
op_star
)paren
id|IPPROTO_ICMP
comma
id|ip_masq_user_info
)brace
)paren
suffix:semicolon
macro_line|#endif&t;
macro_line|#ifdef CONFIG_IP_MASQUERADE_IPAUTOFW
id|ip_autofw_init
c_func
(paren
)paren
suffix:semicolon
macro_line|#endif
macro_line|#ifdef CONFIG_IP_MASQUERADE_IPPORTFW
id|ip_portfw_init
c_func
(paren
)paren
suffix:semicolon
macro_line|#endif
macro_line|#ifdef CONFIG_IP_MASQUERADE_MFW
id|ip_mfw_init
c_func
(paren
)paren
suffix:semicolon
macro_line|#endif
id|ip_masq_app_init
c_func
(paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
eof
