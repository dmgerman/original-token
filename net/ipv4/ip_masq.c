multiline_comment|/*&n; *&n; * &t;Masquerading functionality&n; *&n; * &t;Copyright (c) 1994 Pauline Middelink&n; *&n; *&t;See ip_fw.c for original log&n; *&n; * Fixes:&n; *&t;Juan Jose Ciarlante&t;:&t;Modularized application masquerading (see ip_masq_app.c)&n; *&t;Juan Jose Ciarlante&t;:&t;New struct ip_masq_seq that holds output/input delta seq.&n; *&t;Juan Jose Ciarlante&t;:&t;Added hashed lookup by proto,maddr,mport and proto,saddr,sport&n; *&t;Juan Jose Ciarlante&t;:&t;Fixed deadlock if free ports get exhausted&n; *&t;Juan Jose Ciarlante&t;:&t;Added NO_ADDR status flag.&n; *&n; *&t;&n; */
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/skbuff.h&gt;
macro_line|#include &lt;asm/system.h&gt;
macro_line|#include &lt;linux/stat.h&gt;
macro_line|#include &lt;linux/proc_fs.h&gt;
macro_line|#include &lt;linux/in.h&gt;
macro_line|#include &lt;linux/ip.h&gt;
macro_line|#include &lt;net/protocol.h&gt;
macro_line|#include &lt;net/tcp.h&gt;
macro_line|#include &lt;net/udp.h&gt;
macro_line|#include &lt;net/ip_masq.h&gt;
DECL|macro|IP_MASQ_TAB_SIZE
mdefine_line|#define IP_MASQ_TAB_SIZE 256    /* must be power of 2 */
multiline_comment|/*&n; *&t;Implement IP packet masquerading&n; */
DECL|variable|strProt
r_static
r_const
r_char
op_star
id|strProt
(braket
)braket
op_assign
(brace
l_string|&quot;UDP&quot;
comma
l_string|&quot;TCP&quot;
)brace
suffix:semicolon
DECL|function|masq_proto_name
r_static
id|__inline__
r_const
r_char
op_star
id|masq_proto_name
c_func
(paren
r_int
id|proto
)paren
(brace
r_return
id|strProt
(braket
id|proto
op_eq
id|IPPROTO_TCP
)braket
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;Last masq_port number in use.&n; *&t;Will cycle in MASQ_PORT boundaries.&n; */
DECL|variable|masq_port
r_static
id|__u16
id|masq_port
op_assign
id|PORT_MASQ_BEGIN
suffix:semicolon
multiline_comment|/*&n; *&t;free ports counters (UDP &amp; TCP)&n; *&n; *&t;Their value is _less_ or _equal_ to actual free ports:&n; *&t;same masq port, diff masq addr (firewall iface address) allocated&n; *&t;entries are accounted but their actually don&squot;t eat a more than 1 port.&n; *&n; *&t;Greater values could lower MASQ_EXPIRATION setting as a way to&n; *&t;manage &squot;masq_entries resource&squot;.&n; *&t;&n; */
DECL|variable|ip_masq_free_ports
r_int
id|ip_masq_free_ports
(braket
l_int|2
)braket
op_assign
(brace
id|PORT_MASQ_END
op_minus
id|PORT_MASQ_BEGIN
comma
multiline_comment|/* UDP */
id|PORT_MASQ_END
op_minus
id|PORT_MASQ_BEGIN
multiline_comment|/* TCP */
)brace
suffix:semicolon
DECL|variable|ip_masq_syms
r_static
r_struct
id|symbol_table
id|ip_masq_syms
op_assign
(brace
macro_line|#include &lt;linux/symtab_begin.h&gt;
id|X
c_func
(paren
id|ip_masq_new
)paren
comma
id|X
c_func
(paren
id|ip_masq_set_expire
)paren
comma
id|X
c_func
(paren
id|ip_masq_free_ports
)paren
comma
id|X
c_func
(paren
id|ip_masq_expire
)paren
comma
id|X
c_func
(paren
id|ip_masq_out_get_2
)paren
comma
macro_line|#include &lt;linux/symtab_end.h&gt;
)brace
suffix:semicolon
multiline_comment|/*&n; *&t;2 ip_masq hash tables: for input and output pkts lookups.&n; */
DECL|variable|ip_masq_m_tab
r_struct
id|ip_masq
op_star
id|ip_masq_m_tab
(braket
id|IP_MASQ_TAB_SIZE
)braket
suffix:semicolon
DECL|variable|ip_masq_s_tab
r_struct
id|ip_masq
op_star
id|ip_masq_s_tab
(braket
id|IP_MASQ_TAB_SIZE
)braket
suffix:semicolon
multiline_comment|/*&n; * timeouts&n; */
DECL|variable|ip_masq_dummy
r_static
r_struct
id|ip_fw_masq
id|ip_masq_dummy
op_assign
(brace
id|MASQUERADE_EXPIRE_TCP
comma
id|MASQUERADE_EXPIRE_TCP_FIN
comma
id|MASQUERADE_EXPIRE_UDP
)brace
suffix:semicolon
DECL|variable|ip_masq_expire
r_struct
id|ip_fw_masq
op_star
id|ip_masq_expire
op_assign
op_amp
id|ip_masq_dummy
suffix:semicolon
multiline_comment|/*&n; *&t;Returns hash value&n; */
r_static
id|__inline__
r_int
DECL|function|ip_masq_hash_key
id|ip_masq_hash_key
c_func
(paren
r_int
id|proto
comma
id|__u32
id|addr
comma
id|__u16
id|port
)paren
(brace
r_return
(paren
id|proto
op_xor
id|ntohl
c_func
(paren
id|addr
)paren
op_xor
id|ntohs
c_func
(paren
id|port
)paren
)paren
op_amp
(paren
id|IP_MASQ_TAB_SIZE
op_minus
l_int|1
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;Hashes ip_masq by its proto,addrs,ports.&n; *&t;should be called with masked interrupts.&n; *&t;returns bool success.&n; */
r_static
id|__inline__
r_int
DECL|function|ip_masq_hash
id|ip_masq_hash
c_func
(paren
r_struct
id|ip_masq
op_star
id|ms
)paren
(brace
r_int
id|hash
suffix:semicolon
r_if
c_cond
(paren
id|ms-&gt;flags
op_amp
id|IP_MASQ_F_HASHED
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;ip_masq_hash(): request for already hashed&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n;         *&t;Hash by proto,m{addr,port}&n;         */
id|hash
op_assign
id|ip_masq_hash_key
c_func
(paren
id|ms-&gt;protocol
comma
id|ms-&gt;maddr
comma
id|ms-&gt;mport
)paren
suffix:semicolon
id|ms-&gt;m_link
op_assign
id|ip_masq_m_tab
(braket
id|hash
)braket
suffix:semicolon
id|ip_masq_m_tab
(braket
id|hash
)braket
op_assign
id|ms
suffix:semicolon
multiline_comment|/*&n;         *&t;Hash by proto,s{addr,port}&n;         */
id|hash
op_assign
id|ip_masq_hash_key
c_func
(paren
id|ms-&gt;protocol
comma
id|ms-&gt;saddr
comma
id|ms-&gt;sport
)paren
suffix:semicolon
id|ms-&gt;s_link
op_assign
id|ip_masq_s_tab
(braket
id|hash
)braket
suffix:semicolon
id|ip_masq_s_tab
(braket
id|hash
)braket
op_assign
id|ms
suffix:semicolon
id|ms-&gt;flags
op_or_assign
id|IP_MASQ_F_HASHED
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;UNhashes ip_masq from ip_masq_[ms]_tables.&n; *&t;should be called with masked interrupts.&n; *&t;returns bool success.&n; */
DECL|function|ip_masq_unhash
r_static
id|__inline__
r_int
id|ip_masq_unhash
c_func
(paren
r_struct
id|ip_masq
op_star
id|ms
)paren
(brace
r_int
id|hash
suffix:semicolon
r_struct
id|ip_masq
op_star
op_star
id|ms_p
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|ms-&gt;flags
op_amp
id|IP_MASQ_F_HASHED
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;ip_masq_unhash(): request for unhash flagged&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n;         *&t;UNhash by m{addr,port}&n;         */
id|hash
op_assign
id|ip_masq_hash_key
c_func
(paren
id|ms-&gt;protocol
comma
id|ms-&gt;maddr
comma
id|ms-&gt;mport
)paren
suffix:semicolon
r_for
c_loop
(paren
id|ms_p
op_assign
op_amp
id|ip_masq_m_tab
(braket
id|hash
)braket
suffix:semicolon
op_star
id|ms_p
suffix:semicolon
id|ms_p
op_assign
op_amp
(paren
op_star
id|ms_p
)paren
op_member_access_from_pointer
id|m_link
)paren
r_if
c_cond
(paren
id|ms
op_eq
(paren
op_star
id|ms_p
)paren
)paren
(brace
op_star
id|ms_p
op_assign
id|ms-&gt;m_link
suffix:semicolon
r_break
suffix:semicolon
)brace
multiline_comment|/*&n;         *&t;UNhash by s{addr,port}&n;         */
id|hash
op_assign
id|ip_masq_hash_key
c_func
(paren
id|ms-&gt;protocol
comma
id|ms-&gt;saddr
comma
id|ms-&gt;sport
)paren
suffix:semicolon
r_for
c_loop
(paren
id|ms_p
op_assign
op_amp
id|ip_masq_s_tab
(braket
id|hash
)braket
suffix:semicolon
op_star
id|ms_p
suffix:semicolon
id|ms_p
op_assign
op_amp
(paren
op_star
id|ms_p
)paren
op_member_access_from_pointer
id|s_link
)paren
r_if
c_cond
(paren
id|ms
op_eq
(paren
op_star
id|ms_p
)paren
)paren
(brace
op_star
id|ms_p
op_assign
id|ms-&gt;s_link
suffix:semicolon
r_break
suffix:semicolon
)brace
id|ms-&gt;flags
op_and_assign
op_complement
id|IP_MASQ_F_HASHED
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;Returns ip_masq associated with addresses found in iph.&n; *&t;called for pkts coming from outside-to-INside the firewall&n; *&n; * &t;NB. Cannot check destination address, just for the incoming port.&n; * &t;reason: archie.doc.ac.uk has 6 interfaces, you send to&n; * &t;phoenix and get a reply from any other interface(==dst)!&n; *&n; * &t;[Only for UDP] - AC&n; */
r_struct
id|ip_masq
op_star
DECL|function|ip_masq_in_get
id|ip_masq_in_get
c_func
(paren
r_struct
id|iphdr
op_star
id|iph
)paren
(brace
r_int
id|hash
suffix:semicolon
r_struct
id|ip_masq
op_star
id|ms
suffix:semicolon
id|__u16
op_star
id|portptr
suffix:semicolon
r_int
id|protocol
suffix:semicolon
id|__u32
id|s_addr
comma
id|d_addr
suffix:semicolon
id|__u16
id|s_port
comma
id|d_port
suffix:semicolon
id|portptr
op_assign
(paren
id|__u16
op_star
)paren
op_amp
(paren
(paren
(paren
r_char
op_star
)paren
id|iph
)paren
(braket
id|iph-&gt;ihl
op_star
l_int|4
)braket
)paren
suffix:semicolon
id|protocol
op_assign
id|iph-&gt;protocol
suffix:semicolon
id|s_addr
op_assign
id|iph-&gt;saddr
suffix:semicolon
id|s_port
op_assign
id|portptr
(braket
l_int|0
)braket
suffix:semicolon
id|d_addr
op_assign
id|iph-&gt;daddr
suffix:semicolon
id|d_port
op_assign
id|portptr
(braket
l_int|1
)braket
suffix:semicolon
id|hash
op_assign
id|ip_masq_hash_key
c_func
(paren
id|protocol
comma
id|d_addr
comma
id|d_port
)paren
suffix:semicolon
r_for
c_loop
(paren
id|ms
op_assign
id|ip_masq_m_tab
(braket
id|hash
)braket
suffix:semicolon
id|ms
suffix:semicolon
id|ms
op_assign
id|ms-&gt;m_link
)paren
(brace
r_if
c_cond
(paren
id|protocol
op_eq
id|ms-&gt;protocol
op_logical_and
(paren
id|s_addr
op_eq
id|ms-&gt;daddr
op_logical_or
id|ms-&gt;flags
op_amp
id|IP_MASQ_F_NO_DADDR
)paren
op_logical_and
(paren
id|s_port
op_eq
id|ms-&gt;dport
op_logical_or
id|ms-&gt;flags
op_amp
id|IP_MASQ_F_NO_DPORT
)paren
op_logical_and
(paren
id|d_addr
op_eq
id|ms-&gt;maddr
op_logical_and
id|d_port
op_eq
id|ms-&gt;mport
)paren
)paren
r_return
id|ms
suffix:semicolon
)brace
r_return
l_int|NULL
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;Returns ip_masq associated with addresses found in iph.&n; *&t;called for pkts coming from inside-to-OUTside the firewall.&n; */
r_struct
id|ip_masq
op_star
DECL|function|ip_masq_out_get
id|ip_masq_out_get
c_func
(paren
r_struct
id|iphdr
op_star
id|iph
)paren
(brace
id|__u16
op_star
id|portptr
suffix:semicolon
r_int
id|protocol
suffix:semicolon
id|__u32
id|s_addr
comma
id|d_addr
suffix:semicolon
id|__u16
id|s_port
comma
id|d_port
suffix:semicolon
id|portptr
op_assign
(paren
id|__u16
op_star
)paren
op_amp
(paren
(paren
(paren
r_char
op_star
)paren
id|iph
)paren
(braket
id|iph-&gt;ihl
op_star
l_int|4
)braket
)paren
suffix:semicolon
id|protocol
op_assign
id|iph-&gt;protocol
suffix:semicolon
id|s_addr
op_assign
id|iph-&gt;saddr
suffix:semicolon
id|s_port
op_assign
id|portptr
(braket
l_int|0
)braket
suffix:semicolon
id|d_addr
op_assign
id|iph-&gt;daddr
suffix:semicolon
id|d_port
op_assign
id|portptr
(braket
l_int|1
)braket
suffix:semicolon
r_return
id|ip_masq_out_get_2
c_func
(paren
id|protocol
comma
id|s_addr
comma
id|s_port
comma
id|d_addr
comma
id|d_port
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;Returns ip_masq associated with supplied parameters, either&n; *&t;broken out of the ip/tcp headers or directly supplied for those&n; *&t;pathological protocols with address/port in the data stream&n; *&t;(ftp, irc).  addresses and ports are in network order.&n; *&t;called for pkts coming from inside-to-OUTside the firewall.&n; */
r_struct
id|ip_masq
op_star
DECL|function|ip_masq_out_get_2
id|ip_masq_out_get_2
c_func
(paren
r_int
id|protocol
comma
id|__u32
id|s_addr
comma
id|__u16
id|s_port
comma
id|__u32
id|d_addr
comma
id|__u16
id|d_port
)paren
(brace
r_int
id|hash
suffix:semicolon
r_struct
id|ip_masq
op_star
id|ms
suffix:semicolon
id|hash
op_assign
id|ip_masq_hash_key
c_func
(paren
id|protocol
comma
id|s_addr
comma
id|s_port
)paren
suffix:semicolon
r_for
c_loop
(paren
id|ms
op_assign
id|ip_masq_s_tab
(braket
id|hash
)braket
suffix:semicolon
id|ms
suffix:semicolon
id|ms
op_assign
id|ms-&gt;s_link
)paren
(brace
r_if
c_cond
(paren
id|protocol
op_eq
id|ms-&gt;protocol
op_logical_and
id|s_addr
op_eq
id|ms-&gt;saddr
op_logical_and
id|s_port
op_eq
id|ms-&gt;sport
op_logical_and
id|d_addr
op_eq
id|ms-&gt;daddr
op_logical_and
id|d_port
op_eq
id|ms-&gt;dport
)paren
r_return
id|ms
suffix:semicolon
)brace
r_return
l_int|NULL
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;Returns ip_masq for given proto,m_addr,m_port.&n; *      called by allocation routine to find an unused m_port.&n; */
r_struct
id|ip_masq
op_star
DECL|function|ip_masq_getbym
id|ip_masq_getbym
c_func
(paren
r_int
id|protocol
comma
id|__u32
id|m_addr
comma
id|__u16
id|m_port
)paren
(brace
r_int
id|hash
suffix:semicolon
r_struct
id|ip_masq
op_star
id|ms
suffix:semicolon
id|hash
op_assign
id|ip_masq_hash_key
c_func
(paren
id|protocol
comma
id|m_addr
comma
id|m_port
)paren
suffix:semicolon
r_for
c_loop
(paren
id|ms
op_assign
id|ip_masq_m_tab
(braket
id|hash
)braket
suffix:semicolon
id|ms
suffix:semicolon
id|ms
op_assign
id|ms-&gt;m_link
)paren
(brace
r_if
c_cond
(paren
id|protocol
op_eq
id|ms-&gt;protocol
op_logical_and
(paren
id|m_addr
op_eq
id|ms-&gt;maddr
op_logical_and
id|m_port
op_eq
id|ms-&gt;mport
)paren
)paren
r_return
id|ms
suffix:semicolon
)brace
r_return
l_int|NULL
suffix:semicolon
)brace
DECL|function|masq_expire
r_static
r_void
id|masq_expire
c_func
(paren
r_int
r_int
id|data
)paren
(brace
r_struct
id|ip_masq
op_star
id|ms
op_assign
(paren
r_struct
id|ip_masq
op_star
)paren
id|data
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
macro_line|#ifdef DEBUG_CONFIG_IP_MASQUERADE
id|printk
c_func
(paren
l_string|&quot;Masqueraded %s %lX:%X expired&bslash;n&quot;
comma
id|masq_proto_name
c_func
(paren
id|ms-&gt;protocol
)paren
comma
id|ntohl
c_func
(paren
id|ms-&gt;src
)paren
comma
id|ntohs
c_func
(paren
id|ms-&gt;sport
)paren
)paren
suffix:semicolon
macro_line|#endif
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ip_masq_unhash
c_func
(paren
id|ms
)paren
)paren
(brace
id|ip_masq_free_ports
(braket
id|ms-&gt;protocol
op_eq
id|IPPROTO_TCP
)braket
op_increment
suffix:semicolon
id|ip_masq_unbind_app
c_func
(paren
id|ms
)paren
suffix:semicolon
id|kfree_s
c_func
(paren
id|ms
comma
r_sizeof
(paren
op_star
id|ms
)paren
)paren
suffix:semicolon
)brace
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * &t;Create a new masquerade list entry, also allocate an&n; * &t;unused mport, keeping the portnumber between the&n; * &t;given boundaries MASQ_BEGIN and MASQ_END.&n; */
DECL|function|ip_masq_new
r_struct
id|ip_masq
op_star
id|ip_masq_new
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
r_int
id|proto
comma
id|__u32
id|saddr
comma
id|__u16
id|sport
comma
id|__u32
id|daddr
comma
id|__u16
id|dport
comma
r_int
id|mflags
)paren
(brace
r_struct
id|ip_masq
op_star
id|ms
comma
op_star
id|mst
suffix:semicolon
r_int
id|ports_tried
comma
op_star
id|free_ports_p
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_static
r_int
id|n_fails
op_assign
l_int|0
suffix:semicolon
id|free_ports_p
op_assign
op_amp
id|ip_masq_free_ports
(braket
id|proto
op_eq
id|IPPROTO_TCP
)braket
suffix:semicolon
r_if
c_cond
(paren
op_star
id|free_ports_p
op_eq
l_int|0
)paren
(brace
r_if
c_cond
(paren
op_increment
id|n_fails
OL
l_int|5
)paren
id|printk
c_func
(paren
l_string|&quot;ip_masq_new(proto=%s): no free ports.&bslash;n&quot;
comma
id|masq_proto_name
c_func
(paren
id|proto
)paren
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
id|ms
op_assign
(paren
r_struct
id|ip_masq
op_star
)paren
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|ip_masq
)paren
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ms
op_eq
l_int|NULL
)paren
(brace
r_if
c_cond
(paren
op_increment
id|n_fails
OL
l_int|5
)paren
id|printk
c_func
(paren
l_string|&quot;ip_masq_new(proto=%s): no memory available.&bslash;n&quot;
comma
id|masq_proto_name
c_func
(paren
id|proto
)paren
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
id|memset
c_func
(paren
id|ms
comma
l_int|0
comma
r_sizeof
(paren
op_star
id|ms
)paren
)paren
suffix:semicolon
id|init_timer
c_func
(paren
op_amp
id|ms-&gt;timer
)paren
suffix:semicolon
id|ms-&gt;timer.data
op_assign
(paren
r_int
r_int
)paren
id|ms
suffix:semicolon
id|ms-&gt;timer.function
op_assign
id|masq_expire
suffix:semicolon
id|ms-&gt;protocol
op_assign
id|proto
suffix:semicolon
id|ms-&gt;saddr
op_assign
id|saddr
suffix:semicolon
id|ms-&gt;sport
op_assign
id|sport
suffix:semicolon
id|ms-&gt;daddr
op_assign
id|daddr
suffix:semicolon
id|ms-&gt;dport
op_assign
id|dport
suffix:semicolon
id|ms-&gt;flags
op_assign
id|mflags
suffix:semicolon
id|ms-&gt;app_data
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
id|proto
op_eq
id|IPPROTO_UDP
)paren
id|ms-&gt;flags
op_or_assign
id|IP_MASQ_F_NO_DADDR
suffix:semicolon
multiline_comment|/* get masq address from rif */
id|ms-&gt;maddr
op_assign
id|dev-&gt;pa_addr
suffix:semicolon
r_for
c_loop
(paren
id|ports_tried
op_assign
l_int|0
suffix:semicolon
id|ports_tried
OL
op_star
id|free_ports_p
suffix:semicolon
id|ports_tried
op_increment
)paren
(brace
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/*&n;                 *&t;Try the next available port number&n;                 */
id|ms-&gt;mport
op_assign
id|htons
c_func
(paren
id|masq_port
op_increment
)paren
suffix:semicolon
r_if
c_cond
(paren
id|masq_port
op_eq
id|PORT_MASQ_END
)paren
id|masq_port
op_assign
id|PORT_MASQ_BEGIN
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
multiline_comment|/*&n;                 *&t;lookup to find out if this port is used.&n;                 */
id|mst
op_assign
id|ip_masq_getbym
c_func
(paren
id|proto
comma
id|ms-&gt;maddr
comma
id|ms-&gt;mport
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mst
op_eq
l_int|NULL
)paren
(brace
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_star
id|free_ports_p
op_eq
l_int|0
)paren
(brace
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
(paren
op_star
id|free_ports_p
)paren
op_decrement
suffix:semicolon
id|ip_masq_hash
c_func
(paren
id|ms
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|ip_masq_bind_app
c_func
(paren
id|ms
)paren
suffix:semicolon
id|n_fails
op_assign
l_int|0
suffix:semicolon
r_return
id|ms
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
op_increment
id|n_fails
OL
l_int|5
)paren
id|printk
c_func
(paren
l_string|&quot;ip_masq_new(proto=%s): could not get free masq entry (free=%d).&bslash;n&quot;
comma
id|masq_proto_name
c_func
(paren
id|ms-&gt;protocol
)paren
comma
op_star
id|free_ports_p
)paren
suffix:semicolon
id|kfree_s
c_func
(paren
id|ms
comma
r_sizeof
(paren
op_star
id|ms
)paren
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
multiline_comment|/*&n; * &t;Set masq expiration (deletion) and adds timer,&n; *&t;if timeout==0 cancel expiration.&n; *&t;Warning: it does not check/delete previous timer!&n; */
DECL|function|ip_masq_set_expire
r_void
id|ip_masq_set_expire
c_func
(paren
r_struct
id|ip_masq
op_star
id|ms
comma
r_int
r_int
id|tout
)paren
(brace
r_if
c_cond
(paren
id|tout
)paren
(brace
id|ms-&gt;timer.expires
op_assign
id|jiffies
op_plus
id|tout
suffix:semicolon
id|add_timer
c_func
(paren
op_amp
id|ms-&gt;timer
)paren
suffix:semicolon
)brace
r_else
(brace
id|del_timer
c_func
(paren
op_amp
id|ms-&gt;timer
)paren
suffix:semicolon
)brace
)brace
DECL|function|recalc_check
r_static
r_void
id|recalc_check
c_func
(paren
r_struct
id|udphdr
op_star
id|uh
comma
id|__u32
id|saddr
comma
id|__u32
id|daddr
comma
r_int
id|len
)paren
(brace
id|uh-&gt;check
op_assign
l_int|0
suffix:semicolon
id|uh-&gt;check
op_assign
id|csum_tcpudp_magic
c_func
(paren
id|saddr
comma
id|daddr
comma
id|len
comma
id|IPPROTO_UDP
comma
id|csum_partial
c_func
(paren
(paren
r_char
op_star
)paren
id|uh
comma
id|len
comma
l_int|0
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|uh-&gt;check
op_eq
l_int|0
)paren
(brace
id|uh-&gt;check
op_assign
l_int|0xFFFF
suffix:semicolon
)brace
)brace
DECL|function|ip_fw_masquerade
r_void
id|ip_fw_masquerade
c_func
(paren
r_struct
id|sk_buff
op_star
op_star
id|skb_ptr
comma
r_struct
id|device
op_star
id|dev
)paren
(brace
r_struct
id|sk_buff
op_star
id|skb
op_assign
op_star
id|skb_ptr
suffix:semicolon
r_struct
id|iphdr
op_star
id|iph
op_assign
id|skb-&gt;h.iph
suffix:semicolon
id|__u16
op_star
id|portptr
suffix:semicolon
r_struct
id|ip_masq
op_star
id|ms
suffix:semicolon
r_int
id|size
suffix:semicolon
r_int
r_int
id|timeout
suffix:semicolon
multiline_comment|/*&n;&t; * We can only masquerade protocols with ports...&n;&t; */
r_if
c_cond
(paren
id|iph-&gt;protocol
op_ne
id|IPPROTO_UDP
op_logical_and
id|iph-&gt;protocol
op_ne
id|IPPROTO_TCP
)paren
r_return
suffix:semicolon
multiline_comment|/*&n;&t; *&t;Now hunt the list to see if we have an old entry&n;&t; */
id|portptr
op_assign
(paren
id|__u16
op_star
)paren
op_amp
(paren
(paren
(paren
r_char
op_star
)paren
id|iph
)paren
(braket
id|iph-&gt;ihl
op_star
l_int|4
)braket
)paren
suffix:semicolon
macro_line|#ifdef DEBUG_CONFIG_IP_MASQUERADE
id|printk
c_func
(paren
l_string|&quot;Outgoing %s %lX:%X -&gt; %lX:%X&bslash;n&quot;
comma
id|masq_proto_name
c_func
(paren
id|iph-&gt;protocol
)paren
comma
id|ntohl
c_func
(paren
id|iph-&gt;saddr
)paren
comma
id|ntohs
c_func
(paren
id|portptr
(braket
l_int|0
)braket
)paren
comma
id|ntohl
c_func
(paren
id|iph-&gt;daddr
)paren
comma
id|ntohs
c_func
(paren
id|portptr
(braket
l_int|1
)braket
)paren
)paren
suffix:semicolon
macro_line|#endif
id|ms
op_assign
id|ip_masq_out_get
c_func
(paren
id|iph
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ms
op_ne
l_int|NULL
)paren
id|ip_masq_set_expire
c_func
(paren
id|ms
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/*&n;&t; *&t;Nope, not found, create a new entry for it&n;&t; */
r_if
c_cond
(paren
id|ms
op_eq
l_int|NULL
)paren
(brace
id|ms
op_assign
id|ip_masq_new
c_func
(paren
id|dev
comma
id|iph-&gt;protocol
comma
id|iph-&gt;saddr
comma
id|portptr
(braket
l_int|0
)braket
comma
id|iph-&gt;daddr
comma
id|portptr
(braket
l_int|1
)braket
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ms
op_eq
l_int|NULL
)paren
r_return
suffix:semicolon
)brace
multiline_comment|/*&n; &t; *&t;Change the fragments origin&n; &t; */
id|size
op_assign
id|skb-&gt;len
op_minus
(paren
(paren
r_int
r_char
op_star
)paren
id|portptr
op_minus
id|skb-&gt;h.raw
)paren
suffix:semicolon
multiline_comment|/*&n;         *&t;Set iph addr and port from ip_masq obj.&n;         */
id|iph-&gt;saddr
op_assign
id|ms-&gt;maddr
suffix:semicolon
id|portptr
(braket
l_int|0
)braket
op_assign
id|ms-&gt;mport
suffix:semicolon
multiline_comment|/*&n; &t; *&t;Attempt ip_masq_app call.&n;         *&t;will fix ip_masq and iph seq stuff&n; &t; */
r_if
c_cond
(paren
id|ip_masq_app_pkt_out
c_func
(paren
id|ms
comma
id|skb_ptr
comma
id|dev
)paren
op_ne
l_int|0
)paren
(brace
multiline_comment|/*&n;                 *&t;skb has possibly changed, update pointers.&n;                 */
id|skb
op_assign
op_star
id|skb_ptr
suffix:semicolon
id|iph
op_assign
id|skb-&gt;h.iph
suffix:semicolon
id|portptr
op_assign
(paren
id|__u16
op_star
)paren
op_amp
(paren
(paren
(paren
r_char
op_star
)paren
id|iph
)paren
(braket
id|iph-&gt;ihl
op_star
l_int|4
)braket
)paren
suffix:semicolon
id|size
op_assign
id|skb-&gt;len
op_minus
(paren
(paren
r_int
r_char
op_star
)paren
id|portptr
op_minus
id|skb-&gt;h.raw
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; &t; *&t;Adjust packet accordingly to protocol&n; &t; */
r_if
c_cond
(paren
id|iph-&gt;protocol
op_eq
id|IPPROTO_UDP
)paren
(brace
id|timeout
op_assign
id|ip_masq_expire-&gt;udp_timeout
suffix:semicolon
id|recalc_check
c_func
(paren
(paren
r_struct
id|udphdr
op_star
)paren
id|portptr
comma
id|iph-&gt;saddr
comma
id|iph-&gt;daddr
comma
id|size
)paren
suffix:semicolon
)brace
r_else
(brace
r_struct
id|tcphdr
op_star
id|th
suffix:semicolon
id|th
op_assign
(paren
r_struct
id|tcphdr
op_star
)paren
id|portptr
suffix:semicolon
multiline_comment|/*&n; &t;&t; *&t;Timeout depends if FIN packet was seen&n;&t;&t; *&t;Very short timeout if RST packet seen.&n; &t;&t; */
r_if
c_cond
(paren
id|ms-&gt;flags
op_amp
id|IP_MASQ_F_SAW_RST
op_logical_or
id|th-&gt;rst
)paren
(brace
id|timeout
op_assign
l_int|1
suffix:semicolon
id|ms-&gt;flags
op_or_assign
id|IP_MASQ_F_SAW_RST
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|ms-&gt;flags
op_amp
id|IP_MASQ_F_SAW_FIN
op_logical_or
id|th-&gt;fin
)paren
(brace
id|timeout
op_assign
id|ip_masq_expire-&gt;tcp_fin_timeout
suffix:semicolon
id|ms-&gt;flags
op_or_assign
id|IP_MASQ_F_SAW_FIN
suffix:semicolon
)brace
r_else
id|timeout
op_assign
id|ip_masq_expire-&gt;tcp_timeout
suffix:semicolon
id|skb-&gt;csum
op_assign
id|csum_partial
c_func
(paren
(paren
r_void
op_star
)paren
(paren
id|th
op_plus
l_int|1
)paren
comma
id|size
op_minus
r_sizeof
(paren
op_star
id|th
)paren
comma
l_int|0
)paren
suffix:semicolon
id|tcp_send_check
c_func
(paren
id|th
comma
id|iph-&gt;saddr
comma
id|iph-&gt;daddr
comma
id|size
comma
id|skb
)paren
suffix:semicolon
)brace
id|ip_masq_set_expire
c_func
(paren
id|ms
comma
id|timeout
)paren
suffix:semicolon
id|ip_send_check
c_func
(paren
id|iph
)paren
suffix:semicolon
macro_line|#ifdef DEBUG_CONFIG_IP_MASQUERADE
id|printk
c_func
(paren
l_string|&quot;O-routed from %lX:%X over %s&bslash;n&quot;
comma
id|ntohl
c_func
(paren
id|ms-&gt;maddr
)paren
comma
id|ntohs
c_func
(paren
id|ms-&gt;mport
)paren
comma
id|dev-&gt;name
)paren
suffix:semicolon
macro_line|#endif
)brace
multiline_comment|/*&n;  *&t;Check if it&squot;s an masqueraded port, look it up,&n;  *&t;and send it on it&squot;s way...&n;  *&n;  *&t;Better not have many hosts using the designated portrange&n;  *&t;as &squot;normal&squot; ports, or you&squot;ll be spending many time in&n;  *&t;this function.&n;  */
DECL|function|ip_fw_demasquerade
r_int
id|ip_fw_demasquerade
c_func
(paren
r_struct
id|sk_buff
op_star
op_star
id|skb_p
comma
r_struct
id|device
op_star
id|dev
)paren
(brace
r_struct
id|sk_buff
op_star
id|skb
op_assign
op_star
id|skb_p
suffix:semicolon
r_struct
id|iphdr
op_star
id|iph
op_assign
id|skb-&gt;h.iph
suffix:semicolon
id|__u16
op_star
id|portptr
suffix:semicolon
r_struct
id|ip_masq
op_star
id|ms
suffix:semicolon
r_int
r_int
id|frag
suffix:semicolon
r_if
c_cond
(paren
id|iph-&gt;protocol
op_ne
id|IPPROTO_UDP
op_logical_and
id|iph-&gt;protocol
op_ne
id|IPPROTO_TCP
)paren
r_return
l_int|0
suffix:semicolon
multiline_comment|/*&n;   &t; * Toss fragments, since we handle them in ip_rcv()&n;&t; */
id|frag
op_assign
id|ntohs
c_func
(paren
id|iph-&gt;frag_off
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|frag
op_amp
id|IP_MF
)paren
op_ne
l_int|0
op_logical_or
(paren
id|frag
op_amp
id|IP_OFFSET
)paren
op_ne
l_int|0
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
id|portptr
op_assign
(paren
id|__u16
op_star
)paren
op_amp
(paren
(paren
(paren
r_char
op_star
)paren
id|iph
)paren
(braket
id|iph-&gt;ihl
op_star
l_int|4
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ntohs
c_func
(paren
id|portptr
(braket
l_int|1
)braket
)paren
template_param
id|PORT_MASQ_END
)paren
r_return
l_int|0
suffix:semicolon
macro_line|#ifdef DEBUG_CONFIG_IP_MASQUERADE
id|printk
c_func
(paren
l_string|&quot;Incoming %s %lX:%X -&gt; %lX:%X&bslash;n&quot;
comma
id|masq_proto_name
c_func
(paren
id|iph-&gt;protocol
)paren
comma
id|ntohl
c_func
(paren
id|iph-&gt;saddr
)paren
comma
id|ntohs
c_func
(paren
id|portptr
(braket
l_int|0
)braket
)paren
comma
id|ntohl
c_func
(paren
id|iph-&gt;daddr
)paren
comma
id|ntohs
c_func
(paren
id|portptr
(braket
l_int|1
)braket
)paren
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/*&n; &t; * reroute to original host:port if found...&n;         */
id|ms
op_assign
id|ip_masq_in_get
c_func
(paren
id|iph
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ms
op_ne
l_int|NULL
)paren
(brace
r_int
id|size
suffix:semicolon
multiline_comment|/*&n;                 *&t;Set dport if not defined yet.&n;                 */
r_if
c_cond
(paren
id|ms-&gt;flags
op_amp
id|IP_MASQ_F_NO_DPORT
op_logical_and
id|ms-&gt;protocol
op_eq
id|IPPROTO_TCP
)paren
(brace
id|ms-&gt;flags
op_and_assign
op_complement
id|IP_MASQ_F_NO_DPORT
suffix:semicolon
id|ms-&gt;dport
op_assign
id|portptr
(braket
l_int|0
)braket
suffix:semicolon
macro_line|#if DEBUG_CONFIG_IP_MASQUERADE
id|printk
c_func
(paren
l_string|&quot;ip_fw_demasquerade(): filled dport=%d&bslash;n&quot;
comma
id|ntohs
c_func
(paren
id|ms-&gt;dport
)paren
)paren
suffix:semicolon
macro_line|#endif
)brace
r_if
c_cond
(paren
id|ms-&gt;flags
op_amp
id|IP_MASQ_F_NO_DADDR
op_logical_and
id|ms-&gt;protocol
op_eq
id|IPPROTO_TCP
)paren
(brace
id|ms-&gt;flags
op_and_assign
op_complement
id|IP_MASQ_F_NO_DADDR
suffix:semicolon
id|ms-&gt;daddr
op_assign
id|iph-&gt;saddr
suffix:semicolon
macro_line|#if DEBUG_CONFIG_IP_MASQUERADE
id|printk
c_func
(paren
l_string|&quot;ip_fw_demasquerade(): filled daddr=%X&bslash;n&quot;
comma
id|ntohs
c_func
(paren
id|ms-&gt;daddr
)paren
)paren
suffix:semicolon
macro_line|#endif
)brace
id|size
op_assign
id|skb-&gt;len
op_minus
(paren
(paren
r_int
r_char
op_star
)paren
id|portptr
op_minus
id|skb-&gt;h.raw
)paren
suffix:semicolon
id|iph-&gt;daddr
op_assign
id|ms-&gt;saddr
suffix:semicolon
id|portptr
(braket
l_int|1
)braket
op_assign
id|ms-&gt;sport
suffix:semicolon
multiline_comment|/*&n;                 *&t;Attempt ip_masq_app call.&n;                 *&t;will fix ip_masq and iph ack_seq stuff&n;                 */
r_if
c_cond
(paren
id|ip_masq_app_pkt_in
c_func
(paren
id|ms
comma
id|skb_p
comma
id|dev
)paren
op_ne
l_int|0
)paren
(brace
multiline_comment|/*&n;                         *&t;skb has changed, update pointers.&n;                         */
id|skb
op_assign
op_star
id|skb_p
suffix:semicolon
id|iph
op_assign
id|skb-&gt;h.iph
suffix:semicolon
id|portptr
op_assign
(paren
id|__u16
op_star
)paren
op_amp
(paren
(paren
(paren
r_char
op_star
)paren
id|iph
)paren
(braket
id|iph-&gt;ihl
op_star
l_int|4
)braket
)paren
suffix:semicolon
id|size
op_assign
id|skb-&gt;len
op_minus
(paren
(paren
r_int
r_char
op_star
)paren
id|portptr
op_minus
id|skb-&gt;h.raw
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;                 * Yug! adjust UDP/TCP and IP checksums, also update&n;&t;&t; * UDP timeouts since you cannot depend on traffic&n;&t;&t; * going through the other way to hold the timeout open.&n;&t;&t; * (With TCP the ACK packets hold the tunnel open).&n;&t;&t; * If a TCP RST is seen collapse the tunnel!&n;                 */
r_if
c_cond
(paren
id|iph-&gt;protocol
op_eq
id|IPPROTO_UDP
)paren
(brace
r_int
r_int
id|timeout
suffix:semicolon
id|recalc_check
c_func
(paren
(paren
r_struct
id|udphdr
op_star
)paren
id|portptr
comma
id|iph-&gt;saddr
comma
id|iph-&gt;daddr
comma
id|size
)paren
suffix:semicolon
id|ip_masq_set_expire
c_func
(paren
id|ms
comma
l_int|0
)paren
suffix:semicolon
id|ip_masq_set_expire
c_func
(paren
id|ms
comma
id|ip_masq_expire-&gt;udp_timeout
)paren
suffix:semicolon
)brace
r_else
(brace
r_struct
id|tcphdr
op_star
id|th
suffix:semicolon
id|skb-&gt;csum
op_assign
id|csum_partial
c_func
(paren
(paren
r_void
op_star
)paren
(paren
(paren
(paren
r_struct
id|tcphdr
op_star
)paren
id|portptr
)paren
op_plus
l_int|1
)paren
comma
id|size
op_minus
r_sizeof
(paren
r_struct
id|tcphdr
)paren
comma
l_int|0
)paren
suffix:semicolon
id|tcp_send_check
c_func
(paren
(paren
r_struct
id|tcphdr
op_star
)paren
id|portptr
comma
id|iph-&gt;saddr
comma
id|iph-&gt;daddr
comma
id|size
comma
id|skb
)paren
suffix:semicolon
multiline_comment|/* Check if TCP RST */
id|th
op_assign
(paren
r_struct
id|tcphdr
op_star
)paren
id|portptr
suffix:semicolon
r_if
c_cond
(paren
id|th-&gt;rst
)paren
(brace
id|ip_masq_set_expire
c_func
(paren
id|ms
comma
l_int|0
)paren
suffix:semicolon
id|ms-&gt;flags
op_or_assign
id|IP_MASQ_F_SAW_RST
suffix:semicolon
id|ip_masq_set_expire
c_func
(paren
id|ms
comma
l_int|1
)paren
suffix:semicolon
)brace
)brace
id|ip_send_check
c_func
(paren
id|iph
)paren
suffix:semicolon
macro_line|#ifdef DEBUG_CONFIG_IP_MASQUERADE
id|printk
c_func
(paren
l_string|&quot;I-routed to %lX:%X&bslash;n&quot;
comma
id|ntohl
c_func
(paren
id|iph-&gt;daddr
)paren
comma
id|ntohs
c_func
(paren
id|portptr
(braket
l_int|1
)braket
)paren
)paren
suffix:semicolon
macro_line|#endif
r_return
l_int|1
suffix:semicolon
)brace
multiline_comment|/* sorry, all this trouble for a no-hit :) */
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;/proc/net entry&n; */
DECL|function|ip_msqhst_procinfo
r_static
r_int
id|ip_msqhst_procinfo
c_func
(paren
r_char
op_star
id|buffer
comma
r_char
op_star
op_star
id|start
comma
id|off_t
id|offset
comma
r_int
id|length
comma
r_int
id|unused
)paren
(brace
id|off_t
id|pos
op_assign
l_int|0
comma
id|begin
suffix:semicolon
r_struct
id|ip_masq
op_star
id|ms
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_char
id|temp
(braket
l_int|129
)braket
suffix:semicolon
r_int
id|idx
op_assign
l_int|0
suffix:semicolon
r_int
id|len
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|offset
OL
l_int|128
)paren
(brace
id|sprintf
c_func
(paren
id|temp
comma
l_string|&quot;Prc FromIP   FPrt ToIP     TPrt Masq Init-seq  Delta PDelta Expires (free=%d,%d)&quot;
comma
id|ip_masq_free_ports
(braket
l_int|0
)braket
comma
id|ip_masq_free_ports
(braket
l_int|1
)braket
)paren
suffix:semicolon
id|len
op_assign
id|sprintf
c_func
(paren
id|buffer
comma
l_string|&quot;%-127s&bslash;n&quot;
comma
id|temp
)paren
suffix:semicolon
)brace
id|pos
op_assign
l_int|128
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|idx
op_assign
l_int|0
suffix:semicolon
id|idx
OL
id|IP_MASQ_TAB_SIZE
suffix:semicolon
id|idx
op_increment
)paren
r_for
c_loop
(paren
id|ms
op_assign
id|ip_masq_m_tab
(braket
id|idx
)braket
suffix:semicolon
id|ms
suffix:semicolon
id|ms
op_assign
id|ms-&gt;m_link
)paren
(brace
r_int
id|timer_active
suffix:semicolon
id|pos
op_add_assign
l_int|128
suffix:semicolon
r_if
c_cond
(paren
id|pos
op_le
id|offset
)paren
r_continue
suffix:semicolon
id|timer_active
op_assign
id|del_timer
c_func
(paren
op_amp
id|ms-&gt;timer
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|timer_active
)paren
id|ms-&gt;timer.expires
op_assign
id|jiffies
suffix:semicolon
id|sprintf
c_func
(paren
id|temp
comma
l_string|&quot;%s %08lX:%04X %08lX:%04X %04X %08X %6d %6d %7lu&quot;
comma
id|masq_proto_name
c_func
(paren
id|ms-&gt;protocol
)paren
comma
id|ntohl
c_func
(paren
id|ms-&gt;saddr
)paren
comma
id|ntohs
c_func
(paren
id|ms-&gt;sport
)paren
comma
id|ntohl
c_func
(paren
id|ms-&gt;daddr
)paren
comma
id|ntohs
c_func
(paren
id|ms-&gt;dport
)paren
comma
id|ntohs
c_func
(paren
id|ms-&gt;mport
)paren
comma
id|ms-&gt;out_seq.init_seq
comma
id|ms-&gt;out_seq.delta
comma
id|ms-&gt;out_seq.previous_delta
comma
id|ms-&gt;timer.expires
op_minus
id|jiffies
)paren
suffix:semicolon
r_if
c_cond
(paren
id|timer_active
)paren
id|add_timer
c_func
(paren
op_amp
id|ms-&gt;timer
)paren
suffix:semicolon
id|len
op_add_assign
id|sprintf
c_func
(paren
id|buffer
op_plus
id|len
comma
l_string|&quot;%-127s&bslash;n&quot;
comma
id|temp
)paren
suffix:semicolon
r_if
c_cond
(paren
id|len
op_ge
id|length
)paren
(brace
r_goto
id|done
suffix:semicolon
)brace
)brace
id|done
suffix:colon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|begin
op_assign
id|len
op_minus
(paren
id|pos
op_minus
id|offset
)paren
suffix:semicolon
op_star
id|start
op_assign
id|buffer
op_plus
id|begin
suffix:semicolon
id|len
op_sub_assign
id|begin
suffix:semicolon
r_if
c_cond
(paren
id|len
OG
id|length
)paren
(brace
id|len
op_assign
id|length
suffix:semicolon
)brace
r_return
id|len
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;Initialize ip masquerading&n; */
DECL|function|ip_masq_init
r_int
id|ip_masq_init
c_func
(paren
r_void
)paren
(brace
id|register_symtab
(paren
op_amp
id|ip_masq_syms
)paren
suffix:semicolon
id|proc_net_register
c_func
(paren
op_amp
(paren
r_struct
id|proc_dir_entry
)paren
(brace
id|PROC_NET_IPMSQHST
comma
l_int|13
comma
l_string|&quot;ip_masquerade&quot;
comma
id|S_IFREG
op_or
id|S_IRUGO
comma
l_int|1
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
op_amp
id|proc_net_inode_operations
comma
id|ip_msqhst_procinfo
)brace
)paren
suffix:semicolon
id|ip_masq_app_init
c_func
(paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
eof
