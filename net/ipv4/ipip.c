multiline_comment|/*&n; *&t;Linux NET3:&t;IP/IP protocol decoder. &n; *&n; *&t;Version: $Id: ipip.c,v 1.41 2000/11/28 13:13:27 davem Exp $&n; *&n; *&t;Authors:&n; *&t;&t;Sam Lantinga (slouken@cs.ucdavis.edu)  02/01/95&n; *&n; *&t;Fixes:&n; *&t;&t;Alan Cox&t;:&t;Merged and made usable non modular (its so tiny its silly as&n; *&t;&t;&t;&t;&t;a module taking up 2 pages).&n; *&t;&t;Alan Cox&t;: &t;Fixed bug with 1.3.18 and IPIP not working (now needs to set skb-&gt;h.iph)&n; *&t;&t;&t;&t;&t;to keep ip_forward happy.&n; *&t;&t;Alan Cox&t;:&t;More fixes for 1.3.21, and firewall fix. Maybe this will work soon 8).&n; *&t;&t;Kai Schulte&t;:&t;Fixed #defines for IP_FIREWALL-&gt;FIREWALL&n; *              David Woodhouse :       Perform some basic ICMP handling.&n; *                                      IPIP Routing without decapsulation.&n; *              Carlos Picoto   :       GRE over IP support&n; *&t;&t;Alexey Kuznetsov:&t;Reworked. Really, now it is truncated version of ipv4/ip_gre.c.&n; *&t;&t;&t;&t;&t;I do not want to merge them together.&n; *&n; *&t;This program is free software; you can redistribute it and/or&n; *&t;modify it under the terms of the GNU General Public License&n; *&t;as published by the Free Software Foundation; either version&n; *&t;2 of the License, or (at your option) any later version.&n; *&n; */
multiline_comment|/* tunnel.c: an IP tunnel driver&n;&n;&t;The purpose of this driver is to provide an IP tunnel through&n;&t;which you can tunnel network traffic transparently across subnets.&n;&n;&t;This was written by looking at Nick Holloway&squot;s dummy driver&n;&t;Thanks for the great code!&n;&n;&t;&t;-Sam Lantinga&t;(slouken@cs.ucdavis.edu)  02/01/95&n;&t;&t;&n;&t;Minor tweaks:&n;&t;&t;Cleaned up the code a little and added some pre-1.3.0 tweaks.&n;&t;&t;dev-&gt;hard_header/hard_header_len changed to use no headers.&n;&t;&t;Comments/bracketing tweaked.&n;&t;&t;Made the tunnels use dev-&gt;name not tunnel: when error reporting.&n;&t;&t;Added tx_dropped stat&n;&t;&t;&n;&t;&t;-Alan Cox&t;(Alan.Cox@linux.org) 21 March 95&n;&n;&t;Reworked:&n;&t;&t;Changed to tunnel to destination gateway in addition to the&n;&t;&t;&t;tunnel&squot;s pointopoint address&n;&t;&t;Almost completely rewritten&n;&t;&t;Note:  There is currently no firewall or ICMP handling done.&n;&n;&t;&t;-Sam Lantinga&t;(slouken@cs.ucdavis.edu) 02/13/96&n;&t;&t;&n;*/
multiline_comment|/* Things I wish I had known when writing the tunnel driver:&n;&n;&t;When the tunnel_xmit() function is called, the skb contains the&n;&t;packet to be sent (plus a great deal of extra info), and dev&n;&t;contains the tunnel device that _we_ are.&n;&n;&t;When we are passed a packet, we are expected to fill in the&n;&t;source address with our source IP address.&n;&n;&t;What is the proper way to allocate, copy and free a buffer?&n;&t;After you allocate it, it is a &quot;0 length&quot; chunk of memory&n;&t;starting at zero.  If you want to add headers to the buffer&n;&t;later, you&squot;ll have to call &quot;skb_reserve(skb, amount)&quot; with&n;&t;the amount of memory you want reserved.  Then, you call&n;&t;&quot;skb_put(skb, amount)&quot; with the amount of space you want in&n;&t;the buffer.  skb_put() returns a pointer to the top (#0) of&n;&t;that buffer.  skb-&gt;len is set to the amount of space you have&n;&t;&quot;allocated&quot; with skb_put().  You can then write up to skb-&gt;len&n;&t;bytes to that buffer.  If you need more, you can call skb_put()&n;&t;again with the additional amount of space you need.  You can&n;&t;find out how much more space you can allocate by calling &n;&t;&quot;skb_tailroom(skb)&quot;.&n;&t;Now, to add header space, call &quot;skb_push(skb, header_len)&quot;.&n;&t;This creates space at the beginning of the buffer and returns&n;&t;a pointer to this new space.  If later you need to strip a&n;&t;header from a buffer, call &quot;skb_pull(skb, header_len)&quot;.&n;&t;skb_headroom() will return how much space is left at the top&n;&t;of the buffer (before the main data).  Remember, this headroom&n;&t;space must be reserved before the skb_put() function is called.&n;&t;*/
multiline_comment|/*&n;   This version of net/ipv4/ipip.c is cloned of net/ipv4/ip_gre.c&n;&n;   For comments look at net/ipv4/ip_gre.c --ANK&n; */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;asm/uaccess.h&gt;
macro_line|#include &lt;linux/skbuff.h&gt;
macro_line|#include &lt;linux/netdevice.h&gt;
macro_line|#include &lt;linux/in.h&gt;
macro_line|#include &lt;linux/tcp.h&gt;
macro_line|#include &lt;linux/udp.h&gt;
macro_line|#include &lt;linux/if_arp.h&gt;
macro_line|#include &lt;linux/mroute.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/netfilter_ipv4.h&gt;
macro_line|#include &lt;net/sock.h&gt;
macro_line|#include &lt;net/ip.h&gt;
macro_line|#include &lt;net/icmp.h&gt;
macro_line|#include &lt;net/protocol.h&gt;
macro_line|#include &lt;net/ipip.h&gt;
macro_line|#include &lt;net/inet_ecn.h&gt;
DECL|macro|HASH_SIZE
mdefine_line|#define HASH_SIZE  16
DECL|macro|HASH
mdefine_line|#define HASH(addr) ((addr^(addr&gt;&gt;4))&amp;0xF)
r_static
r_int
id|ipip_fb_tunnel_init
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_int
id|ipip_tunnel_init
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
DECL|variable|ipip_fb_tunnel_dev
r_static
r_struct
id|net_device
id|ipip_fb_tunnel_dev
op_assign
(brace
l_string|&quot;tunl0&quot;
comma
l_int|0x0
comma
l_int|0x0
comma
l_int|0x0
comma
l_int|0x0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|NULL
comma
id|ipip_fb_tunnel_init
comma
)brace
suffix:semicolon
DECL|variable|ipip_fb_tunnel
r_static
r_struct
id|ip_tunnel
id|ipip_fb_tunnel
op_assign
(brace
l_int|NULL
comma
op_amp
id|ipip_fb_tunnel_dev
comma
(brace
l_int|0
comma
)brace
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
(brace
l_string|&quot;tunl0&quot;
comma
)brace
)brace
suffix:semicolon
DECL|variable|tunnels_r_l
r_static
r_struct
id|ip_tunnel
op_star
id|tunnels_r_l
(braket
id|HASH_SIZE
)braket
suffix:semicolon
DECL|variable|tunnels_r
r_static
r_struct
id|ip_tunnel
op_star
id|tunnels_r
(braket
id|HASH_SIZE
)braket
suffix:semicolon
DECL|variable|tunnels_l
r_static
r_struct
id|ip_tunnel
op_star
id|tunnels_l
(braket
id|HASH_SIZE
)braket
suffix:semicolon
DECL|variable|tunnels_wc
r_static
r_struct
id|ip_tunnel
op_star
id|tunnels_wc
(braket
l_int|1
)braket
suffix:semicolon
DECL|variable|tunnels
r_static
r_struct
id|ip_tunnel
op_star
op_star
id|tunnels
(braket
l_int|4
)braket
op_assign
(brace
id|tunnels_wc
comma
id|tunnels_l
comma
id|tunnels_r
comma
id|tunnels_r_l
)brace
suffix:semicolon
DECL|variable|ipip_lock
r_static
id|rwlock_t
id|ipip_lock
op_assign
id|RW_LOCK_UNLOCKED
suffix:semicolon
DECL|function|ipip_tunnel_lookup
r_static
r_struct
id|ip_tunnel
op_star
id|ipip_tunnel_lookup
c_func
(paren
id|u32
id|remote
comma
id|u32
id|local
)paren
(brace
r_int
id|h0
op_assign
id|HASH
c_func
(paren
id|remote
)paren
suffix:semicolon
r_int
id|h1
op_assign
id|HASH
c_func
(paren
id|local
)paren
suffix:semicolon
r_struct
id|ip_tunnel
op_star
id|t
suffix:semicolon
r_for
c_loop
(paren
id|t
op_assign
id|tunnels_r_l
(braket
id|h0
op_xor
id|h1
)braket
suffix:semicolon
id|t
suffix:semicolon
id|t
op_assign
id|t-&gt;next
)paren
(brace
r_if
c_cond
(paren
id|local
op_eq
id|t-&gt;parms.iph.saddr
op_logical_and
id|remote
op_eq
id|t-&gt;parms.iph.daddr
op_logical_and
(paren
id|t-&gt;dev-&gt;flags
op_amp
id|IFF_UP
)paren
)paren
r_return
id|t
suffix:semicolon
)brace
r_for
c_loop
(paren
id|t
op_assign
id|tunnels_r
(braket
id|h0
)braket
suffix:semicolon
id|t
suffix:semicolon
id|t
op_assign
id|t-&gt;next
)paren
(brace
r_if
c_cond
(paren
id|remote
op_eq
id|t-&gt;parms.iph.daddr
op_logical_and
(paren
id|t-&gt;dev-&gt;flags
op_amp
id|IFF_UP
)paren
)paren
r_return
id|t
suffix:semicolon
)brace
r_for
c_loop
(paren
id|t
op_assign
id|tunnels_l
(braket
id|h1
)braket
suffix:semicolon
id|t
suffix:semicolon
id|t
op_assign
id|t-&gt;next
)paren
(brace
r_if
c_cond
(paren
id|local
op_eq
id|t-&gt;parms.iph.saddr
op_logical_and
(paren
id|t-&gt;dev-&gt;flags
op_amp
id|IFF_UP
)paren
)paren
r_return
id|t
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|t
op_assign
id|tunnels_wc
(braket
l_int|0
)braket
)paren
op_ne
l_int|NULL
op_logical_and
(paren
id|t-&gt;dev-&gt;flags
op_amp
id|IFF_UP
)paren
)paren
r_return
id|t
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
DECL|function|ipip_bucket
r_static
r_struct
id|ip_tunnel
op_star
op_star
id|ipip_bucket
c_func
(paren
r_struct
id|ip_tunnel
op_star
id|t
)paren
(brace
id|u32
id|remote
op_assign
id|t-&gt;parms.iph.daddr
suffix:semicolon
id|u32
id|local
op_assign
id|t-&gt;parms.iph.saddr
suffix:semicolon
r_int
id|h
op_assign
l_int|0
suffix:semicolon
r_int
id|prio
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|remote
)paren
(brace
id|prio
op_or_assign
l_int|2
suffix:semicolon
id|h
op_xor_assign
id|HASH
c_func
(paren
id|remote
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|local
)paren
(brace
id|prio
op_or_assign
l_int|1
suffix:semicolon
id|h
op_xor_assign
id|HASH
c_func
(paren
id|local
)paren
suffix:semicolon
)brace
r_return
op_amp
id|tunnels
(braket
id|prio
)braket
(braket
id|h
)braket
suffix:semicolon
)brace
DECL|function|ipip_tunnel_unlink
r_static
r_void
id|ipip_tunnel_unlink
c_func
(paren
r_struct
id|ip_tunnel
op_star
id|t
)paren
(brace
r_struct
id|ip_tunnel
op_star
op_star
id|tp
suffix:semicolon
r_for
c_loop
(paren
id|tp
op_assign
id|ipip_bucket
c_func
(paren
id|t
)paren
suffix:semicolon
op_star
id|tp
suffix:semicolon
id|tp
op_assign
op_amp
(paren
op_star
id|tp
)paren
op_member_access_from_pointer
id|next
)paren
(brace
r_if
c_cond
(paren
id|t
op_eq
op_star
id|tp
)paren
(brace
id|write_lock_bh
c_func
(paren
op_amp
id|ipip_lock
)paren
suffix:semicolon
op_star
id|tp
op_assign
id|t-&gt;next
suffix:semicolon
id|write_unlock_bh
c_func
(paren
op_amp
id|ipip_lock
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
)brace
DECL|function|ipip_tunnel_link
r_static
r_void
id|ipip_tunnel_link
c_func
(paren
r_struct
id|ip_tunnel
op_star
id|t
)paren
(brace
r_struct
id|ip_tunnel
op_star
op_star
id|tp
op_assign
id|ipip_bucket
c_func
(paren
id|t
)paren
suffix:semicolon
id|t-&gt;next
op_assign
op_star
id|tp
suffix:semicolon
id|write_lock_bh
c_func
(paren
op_amp
id|ipip_lock
)paren
suffix:semicolon
op_star
id|tp
op_assign
id|t
suffix:semicolon
id|write_unlock_bh
c_func
(paren
op_amp
id|ipip_lock
)paren
suffix:semicolon
)brace
DECL|function|ipip_tunnel_locate
r_struct
id|ip_tunnel
op_star
id|ipip_tunnel_locate
c_func
(paren
r_struct
id|ip_tunnel_parm
op_star
id|parms
comma
r_int
id|create
)paren
(brace
id|u32
id|remote
op_assign
id|parms-&gt;iph.daddr
suffix:semicolon
id|u32
id|local
op_assign
id|parms-&gt;iph.saddr
suffix:semicolon
r_struct
id|ip_tunnel
op_star
id|t
comma
op_star
op_star
id|tp
comma
op_star
id|nt
suffix:semicolon
r_struct
id|net_device
op_star
id|dev
suffix:semicolon
r_int
id|h
op_assign
l_int|0
suffix:semicolon
r_int
id|prio
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|remote
)paren
(brace
id|prio
op_or_assign
l_int|2
suffix:semicolon
id|h
op_xor_assign
id|HASH
c_func
(paren
id|remote
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|local
)paren
(brace
id|prio
op_or_assign
l_int|1
suffix:semicolon
id|h
op_xor_assign
id|HASH
c_func
(paren
id|local
)paren
suffix:semicolon
)brace
r_for
c_loop
(paren
id|tp
op_assign
op_amp
id|tunnels
(braket
id|prio
)braket
(braket
id|h
)braket
suffix:semicolon
(paren
id|t
op_assign
op_star
id|tp
)paren
op_ne
l_int|NULL
suffix:semicolon
id|tp
op_assign
op_amp
id|t-&gt;next
)paren
(brace
r_if
c_cond
(paren
id|local
op_eq
id|t-&gt;parms.iph.saddr
op_logical_and
id|remote
op_eq
id|t-&gt;parms.iph.daddr
)paren
r_return
id|t
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|create
)paren
r_return
l_int|NULL
suffix:semicolon
id|MOD_INC_USE_COUNT
suffix:semicolon
id|dev
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
op_star
id|dev
)paren
op_plus
r_sizeof
(paren
op_star
id|t
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dev
op_eq
l_int|NULL
)paren
(brace
id|MOD_DEC_USE_COUNT
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
id|memset
c_func
(paren
id|dev
comma
l_int|0
comma
r_sizeof
(paren
op_star
id|dev
)paren
op_plus
r_sizeof
(paren
op_star
id|t
)paren
)paren
suffix:semicolon
id|dev-&gt;priv
op_assign
(paren
r_void
op_star
)paren
(paren
id|dev
op_plus
l_int|1
)paren
suffix:semicolon
id|nt
op_assign
(paren
r_struct
id|ip_tunnel
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|nt-&gt;dev
op_assign
id|dev
suffix:semicolon
id|dev-&gt;init
op_assign
id|ipip_tunnel_init
suffix:semicolon
id|dev-&gt;features
op_or_assign
id|NETIF_F_DYNALLOC
suffix:semicolon
id|memcpy
c_func
(paren
op_amp
id|nt-&gt;parms
comma
id|parms
comma
r_sizeof
(paren
op_star
id|parms
)paren
)paren
suffix:semicolon
id|strcpy
c_func
(paren
id|dev-&gt;name
comma
id|nt-&gt;parms.name
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;name
(braket
l_int|0
)braket
op_eq
l_int|0
)paren
(brace
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|1
suffix:semicolon
id|i
OL
l_int|100
suffix:semicolon
id|i
op_increment
)paren
(brace
id|sprintf
c_func
(paren
id|dev-&gt;name
comma
l_string|&quot;tunl%d&quot;
comma
id|i
)paren
suffix:semicolon
r_if
c_cond
(paren
id|__dev_get_by_name
c_func
(paren
id|dev-&gt;name
)paren
op_eq
l_int|NULL
)paren
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|i
op_eq
l_int|100
)paren
r_goto
id|failed
suffix:semicolon
id|memcpy
c_func
(paren
id|parms-&gt;name
comma
id|dev-&gt;name
comma
id|IFNAMSIZ
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|register_netdevice
c_func
(paren
id|dev
)paren
OL
l_int|0
)paren
r_goto
id|failed
suffix:semicolon
id|dev_hold
c_func
(paren
id|dev
)paren
suffix:semicolon
id|ipip_tunnel_link
c_func
(paren
id|nt
)paren
suffix:semicolon
multiline_comment|/* Do not decrement MOD_USE_COUNT here. */
r_return
id|nt
suffix:semicolon
id|failed
suffix:colon
id|kfree
c_func
(paren
id|dev
)paren
suffix:semicolon
id|MOD_DEC_USE_COUNT
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
DECL|function|ipip_tunnel_destructor
r_static
r_void
id|ipip_tunnel_destructor
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_if
c_cond
(paren
id|dev
op_ne
op_amp
id|ipip_fb_tunnel_dev
)paren
(brace
id|MOD_DEC_USE_COUNT
suffix:semicolon
)brace
)brace
DECL|function|ipip_tunnel_uninit
r_static
r_void
id|ipip_tunnel_uninit
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_if
c_cond
(paren
id|dev
op_eq
op_amp
id|ipip_fb_tunnel_dev
)paren
(brace
id|write_lock_bh
c_func
(paren
op_amp
id|ipip_lock
)paren
suffix:semicolon
id|tunnels_wc
(braket
l_int|0
)braket
op_assign
l_int|NULL
suffix:semicolon
id|write_unlock_bh
c_func
(paren
op_amp
id|ipip_lock
)paren
suffix:semicolon
id|dev_put
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
r_else
(brace
id|ipip_tunnel_unlink
c_func
(paren
(paren
r_struct
id|ip_tunnel
op_star
)paren
id|dev-&gt;priv
)paren
suffix:semicolon
id|dev_put
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
)brace
DECL|function|ipip_err
r_void
id|ipip_err
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_int
r_char
op_star
id|dp
comma
r_int
id|len
)paren
(brace
macro_line|#ifndef I_WISH_WORLD_WERE_PERFECT
multiline_comment|/* It is not :-( All the routers (except for Linux) return only&n;   8 bytes of packet payload. It means, that precise relaying of&n;   ICMP in the real Internet is absolutely infeasible.&n; */
r_struct
id|iphdr
op_star
id|iph
op_assign
(paren
r_struct
id|iphdr
op_star
)paren
id|dp
suffix:semicolon
r_int
id|type
op_assign
id|skb-&gt;h.icmph-&gt;type
suffix:semicolon
r_int
id|code
op_assign
id|skb-&gt;h.icmph-&gt;code
suffix:semicolon
r_struct
id|ip_tunnel
op_star
id|t
suffix:semicolon
r_if
c_cond
(paren
id|len
OL
r_sizeof
(paren
r_struct
id|iphdr
)paren
)paren
r_return
suffix:semicolon
r_switch
c_cond
(paren
id|type
)paren
(brace
r_default
suffix:colon
r_case
id|ICMP_PARAMETERPROB
suffix:colon
r_return
suffix:semicolon
r_case
id|ICMP_DEST_UNREACH
suffix:colon
r_switch
c_cond
(paren
id|code
)paren
(brace
r_case
id|ICMP_SR_FAILED
suffix:colon
r_case
id|ICMP_PORT_UNREACH
suffix:colon
multiline_comment|/* Impossible event. */
r_return
suffix:semicolon
r_case
id|ICMP_FRAG_NEEDED
suffix:colon
multiline_comment|/* Soft state for pmtu is maintained by IP core. */
r_return
suffix:semicolon
r_default
suffix:colon
multiline_comment|/* All others are translated to HOST_UNREACH.&n;&t;&t;&t;   rfc2003 contains &quot;deep thoughts&quot; about NET_UNREACH,&n;&t;&t;&t;   I believe they are just ether pollution. --ANK&n;&t;&t;&t; */
r_break
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|ICMP_TIME_EXCEEDED
suffix:colon
r_if
c_cond
(paren
id|code
op_ne
id|ICMP_EXC_TTL
)paren
r_return
suffix:semicolon
r_break
suffix:semicolon
)brace
id|read_lock
c_func
(paren
op_amp
id|ipip_lock
)paren
suffix:semicolon
id|t
op_assign
id|ipip_tunnel_lookup
c_func
(paren
id|iph-&gt;daddr
comma
id|iph-&gt;saddr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|t
op_eq
l_int|NULL
op_logical_or
id|t-&gt;parms.iph.daddr
op_eq
l_int|0
)paren
r_goto
id|out
suffix:semicolon
r_if
c_cond
(paren
id|t-&gt;parms.iph.ttl
op_eq
l_int|0
op_logical_and
id|type
op_eq
id|ICMP_TIME_EXCEEDED
)paren
r_goto
id|out
suffix:semicolon
r_if
c_cond
(paren
id|jiffies
op_minus
id|t-&gt;err_time
OL
id|IPTUNNEL_ERR_TIMEO
)paren
id|t-&gt;err_count
op_increment
suffix:semicolon
r_else
id|t-&gt;err_count
op_assign
l_int|1
suffix:semicolon
id|t-&gt;err_time
op_assign
id|jiffies
suffix:semicolon
id|out
suffix:colon
id|read_unlock
c_func
(paren
op_amp
id|ipip_lock
)paren
suffix:semicolon
r_return
suffix:semicolon
macro_line|#else
r_struct
id|iphdr
op_star
id|iph
op_assign
(paren
r_struct
id|iphdr
op_star
)paren
id|dp
suffix:semicolon
r_int
id|hlen
op_assign
id|iph-&gt;ihl
op_lshift
l_int|2
suffix:semicolon
r_struct
id|iphdr
op_star
id|eiph
suffix:semicolon
r_int
id|type
op_assign
id|skb-&gt;h.icmph-&gt;type
suffix:semicolon
r_int
id|code
op_assign
id|skb-&gt;h.icmph-&gt;code
suffix:semicolon
r_int
id|rel_type
op_assign
l_int|0
suffix:semicolon
r_int
id|rel_code
op_assign
l_int|0
suffix:semicolon
r_int
id|rel_info
op_assign
l_int|0
suffix:semicolon
r_struct
id|sk_buff
op_star
id|skb2
suffix:semicolon
r_struct
id|rtable
op_star
id|rt
suffix:semicolon
r_if
c_cond
(paren
id|len
OL
id|hlen
op_plus
r_sizeof
(paren
r_struct
id|iphdr
)paren
)paren
r_return
suffix:semicolon
id|eiph
op_assign
(paren
r_struct
id|iphdr
op_star
)paren
(paren
id|dp
op_plus
id|hlen
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|type
)paren
(brace
r_default
suffix:colon
r_return
suffix:semicolon
r_case
id|ICMP_PARAMETERPROB
suffix:colon
r_if
c_cond
(paren
id|skb-&gt;h.icmph-&gt;un.gateway
OL
id|hlen
)paren
r_return
suffix:semicolon
multiline_comment|/* So... This guy found something strange INSIDE encapsulated&n;&t;&t;   packet. Well, he is fool, but what can we do ?&n;&t;&t; */
id|rel_type
op_assign
id|ICMP_PARAMETERPROB
suffix:semicolon
id|rel_info
op_assign
id|skb-&gt;h.icmph-&gt;un.gateway
op_minus
id|hlen
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ICMP_DEST_UNREACH
suffix:colon
r_switch
c_cond
(paren
id|code
)paren
(brace
r_case
id|ICMP_SR_FAILED
suffix:colon
r_case
id|ICMP_PORT_UNREACH
suffix:colon
multiline_comment|/* Impossible event. */
r_return
suffix:semicolon
r_case
id|ICMP_FRAG_NEEDED
suffix:colon
multiline_comment|/* And it is the only really necesary thing :-) */
id|rel_info
op_assign
id|ntohs
c_func
(paren
id|skb-&gt;h.icmph-&gt;un.frag.mtu
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rel_info
OL
id|hlen
op_plus
l_int|68
)paren
r_return
suffix:semicolon
id|rel_info
op_sub_assign
id|hlen
suffix:semicolon
multiline_comment|/* BSD 4.2 MORE DOES NOT EXIST IN NATURE. */
r_if
c_cond
(paren
id|rel_info
OG
id|ntohs
c_func
(paren
id|eiph-&gt;tot_len
)paren
)paren
r_return
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
multiline_comment|/* All others are translated to HOST_UNREACH.&n;&t;&t;&t;   rfc2003 contains &quot;deep thoughts&quot; about NET_UNREACH,&n;&t;&t;&t;   I believe, it is just ether pollution. --ANK&n;&t;&t;&t; */
id|rel_type
op_assign
id|ICMP_DEST_UNREACH
suffix:semicolon
id|rel_code
op_assign
id|ICMP_HOST_UNREACH
suffix:semicolon
r_break
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|ICMP_TIME_EXCEEDED
suffix:colon
r_if
c_cond
(paren
id|code
op_ne
id|ICMP_EXC_TTL
)paren
r_return
suffix:semicolon
r_break
suffix:semicolon
)brace
multiline_comment|/* Prepare fake skb to feed it to icmp_send */
id|skb2
op_assign
id|skb_clone
c_func
(paren
id|skb
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
id|skb2
op_eq
l_int|NULL
)paren
r_return
suffix:semicolon
id|dst_release
c_func
(paren
id|skb2-&gt;dst
)paren
suffix:semicolon
id|skb2-&gt;dst
op_assign
l_int|NULL
suffix:semicolon
id|skb_pull
c_func
(paren
id|skb2
comma
id|skb-&gt;data
op_minus
(paren
id|u8
op_star
)paren
id|eiph
)paren
suffix:semicolon
id|skb2-&gt;nh.raw
op_assign
id|skb2-&gt;data
suffix:semicolon
multiline_comment|/* Try to guess incoming interface */
r_if
c_cond
(paren
id|ip_route_output
c_func
(paren
op_amp
id|rt
comma
id|eiph-&gt;saddr
comma
l_int|0
comma
id|RT_TOS
c_func
(paren
id|eiph-&gt;tos
)paren
comma
l_int|0
)paren
)paren
(brace
id|kfree_skb
c_func
(paren
id|skb2
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|skb2-&gt;dev
op_assign
id|rt-&gt;u.dst.dev
suffix:semicolon
multiline_comment|/* route &quot;incoming&quot; packet */
r_if
c_cond
(paren
id|rt-&gt;rt_flags
op_amp
id|RTCF_LOCAL
)paren
(brace
id|ip_rt_put
c_func
(paren
id|rt
)paren
suffix:semicolon
id|rt
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
id|ip_route_output
c_func
(paren
op_amp
id|rt
comma
id|eiph-&gt;daddr
comma
id|eiph-&gt;saddr
comma
id|eiph-&gt;tos
comma
l_int|0
)paren
op_logical_or
id|rt-&gt;u.dst.dev-&gt;type
op_ne
id|ARPHRD_IPGRE
)paren
(brace
id|ip_rt_put
c_func
(paren
id|rt
)paren
suffix:semicolon
id|kfree_skb
c_func
(paren
id|skb2
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
)brace
r_else
(brace
id|ip_rt_put
c_func
(paren
id|rt
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ip_route_input
c_func
(paren
id|skb2
comma
id|eiph-&gt;daddr
comma
id|eiph-&gt;saddr
comma
id|eiph-&gt;tos
comma
id|skb2-&gt;dev
)paren
op_logical_or
id|skb2-&gt;dst-&gt;dev-&gt;type
op_ne
id|ARPHRD_IPGRE
)paren
(brace
id|kfree_skb
c_func
(paren
id|skb2
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
)brace
multiline_comment|/* change mtu on this route */
r_if
c_cond
(paren
id|type
op_eq
id|ICMP_DEST_UNREACH
op_logical_and
id|code
op_eq
id|ICMP_FRAG_NEEDED
)paren
(brace
r_if
c_cond
(paren
id|rel_info
OG
id|skb2-&gt;dst-&gt;pmtu
)paren
(brace
id|kfree_skb
c_func
(paren
id|skb2
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|skb2-&gt;dst-&gt;pmtu
op_assign
id|rel_info
suffix:semicolon
id|rel_info
op_assign
id|htonl
c_func
(paren
id|rel_info
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|type
op_eq
id|ICMP_TIME_EXCEEDED
)paren
(brace
r_struct
id|ip_tunnel
op_star
id|t
op_assign
(paren
r_struct
id|ip_tunnel
op_star
)paren
id|skb2-&gt;dev-&gt;priv
suffix:semicolon
r_if
c_cond
(paren
id|t-&gt;parms.iph.ttl
)paren
(brace
id|rel_type
op_assign
id|ICMP_DEST_UNREACH
suffix:semicolon
id|rel_code
op_assign
id|ICMP_HOST_UNREACH
suffix:semicolon
)brace
)brace
id|icmp_send
c_func
(paren
id|skb2
comma
id|rel_type
comma
id|rel_code
comma
id|rel_info
)paren
suffix:semicolon
id|kfree_skb
c_func
(paren
id|skb2
)paren
suffix:semicolon
r_return
suffix:semicolon
macro_line|#endif
)brace
DECL|function|ipip_ecn_decapsulate
r_static
r_inline
r_void
id|ipip_ecn_decapsulate
c_func
(paren
r_struct
id|iphdr
op_star
id|iph
comma
r_struct
id|sk_buff
op_star
id|skb
)paren
(brace
r_if
c_cond
(paren
id|INET_ECN_is_ce
c_func
(paren
id|iph-&gt;tos
)paren
op_logical_and
id|INET_ECN_is_not_ce
c_func
(paren
id|skb-&gt;nh.iph-&gt;tos
)paren
)paren
id|IP_ECN_set_ce
c_func
(paren
id|iph
)paren
suffix:semicolon
)brace
DECL|function|ipip_rcv
r_int
id|ipip_rcv
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_int
r_int
id|len
)paren
(brace
r_struct
id|iphdr
op_star
id|iph
suffix:semicolon
r_struct
id|ip_tunnel
op_star
id|tunnel
suffix:semicolon
id|iph
op_assign
id|skb-&gt;nh.iph
suffix:semicolon
id|skb-&gt;mac.raw
op_assign
id|skb-&gt;nh.raw
suffix:semicolon
id|skb-&gt;nh.raw
op_assign
id|skb_pull
c_func
(paren
id|skb
comma
id|skb-&gt;h.raw
op_minus
id|skb-&gt;data
)paren
suffix:semicolon
id|memset
c_func
(paren
op_amp
(paren
id|IPCB
c_func
(paren
id|skb
)paren
op_member_access_from_pointer
id|opt
)paren
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|ip_options
)paren
)paren
suffix:semicolon
id|skb-&gt;protocol
op_assign
id|__constant_htons
c_func
(paren
id|ETH_P_IP
)paren
suffix:semicolon
id|skb-&gt;ip_summed
op_assign
l_int|0
suffix:semicolon
id|skb-&gt;pkt_type
op_assign
id|PACKET_HOST
suffix:semicolon
id|read_lock
c_func
(paren
op_amp
id|ipip_lock
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|tunnel
op_assign
id|ipip_tunnel_lookup
c_func
(paren
id|iph-&gt;saddr
comma
id|iph-&gt;daddr
)paren
)paren
op_ne
l_int|NULL
)paren
(brace
id|tunnel-&gt;stat.rx_packets
op_increment
suffix:semicolon
id|tunnel-&gt;stat.rx_bytes
op_add_assign
id|skb-&gt;len
suffix:semicolon
id|skb-&gt;dev
op_assign
id|tunnel-&gt;dev
suffix:semicolon
id|dst_release
c_func
(paren
id|skb-&gt;dst
)paren
suffix:semicolon
id|skb-&gt;dst
op_assign
l_int|NULL
suffix:semicolon
macro_line|#ifdef CONFIG_NETFILTER
id|nf_conntrack_put
c_func
(paren
id|skb-&gt;nfct
)paren
suffix:semicolon
id|skb-&gt;nfct
op_assign
l_int|NULL
suffix:semicolon
macro_line|#ifdef CONFIG_NETFILTER_DEBUG
id|skb-&gt;nf_debug
op_assign
l_int|0
suffix:semicolon
macro_line|#endif
macro_line|#endif
id|ipip_ecn_decapsulate
c_func
(paren
id|iph
comma
id|skb
)paren
suffix:semicolon
id|netif_rx
c_func
(paren
id|skb
)paren
suffix:semicolon
id|read_unlock
c_func
(paren
op_amp
id|ipip_lock
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|read_unlock
c_func
(paren
op_amp
id|ipip_lock
)paren
suffix:semicolon
id|icmp_send
c_func
(paren
id|skb
comma
id|ICMP_DEST_UNREACH
comma
id|ICMP_PROT_UNREACH
comma
l_int|0
)paren
suffix:semicolon
id|kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Need this wrapper because NF_HOOK takes the function address */
DECL|function|do_ip_send
r_static
r_inline
r_int
id|do_ip_send
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
)paren
(brace
r_return
id|ip_send
c_func
(paren
id|skb
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;This function assumes it is being called from dev_queue_xmit()&n; *&t;and that skb is filled properly by that function.&n; */
DECL|function|ipip_tunnel_xmit
r_static
r_int
id|ipip_tunnel_xmit
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|ip_tunnel
op_star
id|tunnel
op_assign
(paren
r_struct
id|ip_tunnel
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_struct
id|net_device_stats
op_star
id|stats
op_assign
op_amp
id|tunnel-&gt;stat
suffix:semicolon
r_struct
id|iphdr
op_star
id|tiph
op_assign
op_amp
id|tunnel-&gt;parms.iph
suffix:semicolon
id|u8
id|tos
op_assign
id|tunnel-&gt;parms.iph.tos
suffix:semicolon
id|u16
id|df
op_assign
id|tiph-&gt;frag_off
suffix:semicolon
r_struct
id|rtable
op_star
id|rt
suffix:semicolon
multiline_comment|/* Route to the other host */
r_struct
id|net_device
op_star
id|tdev
suffix:semicolon
multiline_comment|/* Device to other host */
r_struct
id|iphdr
op_star
id|old_iph
op_assign
id|skb-&gt;nh.iph
suffix:semicolon
r_struct
id|iphdr
op_star
id|iph
suffix:semicolon
multiline_comment|/* Our new IP header */
r_int
id|max_headroom
suffix:semicolon
multiline_comment|/* The extra header space needed */
id|u32
id|dst
op_assign
id|tiph-&gt;daddr
suffix:semicolon
r_int
id|mtu
suffix:semicolon
r_if
c_cond
(paren
id|tunnel-&gt;recursion
op_increment
)paren
(brace
id|tunnel-&gt;stat.collisions
op_increment
suffix:semicolon
r_goto
id|tx_error
suffix:semicolon
)brace
r_if
c_cond
(paren
id|skb-&gt;protocol
op_ne
id|__constant_htons
c_func
(paren
id|ETH_P_IP
)paren
)paren
r_goto
id|tx_error
suffix:semicolon
r_if
c_cond
(paren
id|tos
op_amp
l_int|1
)paren
id|tos
op_assign
id|old_iph-&gt;tos
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dst
)paren
(brace
multiline_comment|/* NBMA tunnel */
r_if
c_cond
(paren
(paren
id|rt
op_assign
(paren
r_struct
id|rtable
op_star
)paren
id|skb-&gt;dst
)paren
op_eq
l_int|NULL
)paren
(brace
id|tunnel-&gt;stat.tx_fifo_errors
op_increment
suffix:semicolon
r_goto
id|tx_error
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|dst
op_assign
id|rt-&gt;rt_gateway
)paren
op_eq
l_int|0
)paren
r_goto
id|tx_error_icmp
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ip_route_output
c_func
(paren
op_amp
id|rt
comma
id|dst
comma
id|tiph-&gt;saddr
comma
id|RT_TOS
c_func
(paren
id|tos
)paren
comma
id|tunnel-&gt;parms.link
)paren
)paren
(brace
id|tunnel-&gt;stat.tx_carrier_errors
op_increment
suffix:semicolon
r_goto
id|tx_error_icmp
suffix:semicolon
)brace
id|tdev
op_assign
id|rt-&gt;u.dst.dev
suffix:semicolon
r_if
c_cond
(paren
id|tdev
op_eq
id|dev
)paren
(brace
id|ip_rt_put
c_func
(paren
id|rt
)paren
suffix:semicolon
id|tunnel-&gt;stat.collisions
op_increment
suffix:semicolon
r_goto
id|tx_error
suffix:semicolon
)brace
id|mtu
op_assign
id|rt-&gt;u.dst.pmtu
op_minus
r_sizeof
(paren
r_struct
id|iphdr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mtu
OL
l_int|68
)paren
(brace
id|tunnel-&gt;stat.collisions
op_increment
suffix:semicolon
id|ip_rt_put
c_func
(paren
id|rt
)paren
suffix:semicolon
r_goto
id|tx_error
suffix:semicolon
)brace
r_if
c_cond
(paren
id|skb-&gt;dst
op_logical_and
id|mtu
OL
id|skb-&gt;dst-&gt;pmtu
)paren
id|skb-&gt;dst-&gt;pmtu
op_assign
id|mtu
suffix:semicolon
id|df
op_or_assign
(paren
id|old_iph-&gt;frag_off
op_amp
id|__constant_htons
c_func
(paren
id|IP_DF
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|old_iph-&gt;frag_off
op_amp
id|__constant_htons
c_func
(paren
id|IP_DF
)paren
)paren
op_logical_and
id|mtu
OL
id|ntohs
c_func
(paren
id|old_iph-&gt;tot_len
)paren
)paren
(brace
id|icmp_send
c_func
(paren
id|skb
comma
id|ICMP_DEST_UNREACH
comma
id|ICMP_FRAG_NEEDED
comma
id|htonl
c_func
(paren
id|mtu
)paren
)paren
suffix:semicolon
id|ip_rt_put
c_func
(paren
id|rt
)paren
suffix:semicolon
r_goto
id|tx_error
suffix:semicolon
)brace
r_if
c_cond
(paren
id|tunnel-&gt;err_count
OG
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|jiffies
op_minus
id|tunnel-&gt;err_time
OL
id|IPTUNNEL_ERR_TIMEO
)paren
(brace
id|tunnel-&gt;err_count
op_decrement
suffix:semicolon
id|dst_link_failure
c_func
(paren
id|skb
)paren
suffix:semicolon
)brace
r_else
id|tunnel-&gt;err_count
op_assign
l_int|0
suffix:semicolon
)brace
id|skb-&gt;h.raw
op_assign
id|skb-&gt;nh.raw
suffix:semicolon
multiline_comment|/*&n;&t; * Okay, now see if we can stuff it in the buffer as-is.&n;&t; */
id|max_headroom
op_assign
(paren
(paren
(paren
id|tdev-&gt;hard_header_len
op_plus
l_int|15
)paren
op_amp
op_complement
l_int|15
)paren
op_plus
r_sizeof
(paren
r_struct
id|iphdr
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|skb_headroom
c_func
(paren
id|skb
)paren
OL
id|max_headroom
op_logical_or
id|skb_cloned
c_func
(paren
id|skb
)paren
op_logical_or
id|skb_shared
c_func
(paren
id|skb
)paren
)paren
(brace
r_struct
id|sk_buff
op_star
id|new_skb
op_assign
id|skb_realloc_headroom
c_func
(paren
id|skb
comma
id|max_headroom
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|new_skb
)paren
(brace
id|ip_rt_put
c_func
(paren
id|rt
)paren
suffix:semicolon
id|stats-&gt;tx_dropped
op_increment
suffix:semicolon
id|dev_kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
id|tunnel-&gt;recursion
op_decrement
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|skb-&gt;sk
)paren
id|skb_set_owner_w
c_func
(paren
id|new_skb
comma
id|skb-&gt;sk
)paren
suffix:semicolon
id|dev_kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
id|skb
op_assign
id|new_skb
suffix:semicolon
)brace
id|skb-&gt;nh.raw
op_assign
id|skb_push
c_func
(paren
id|skb
comma
r_sizeof
(paren
r_struct
id|iphdr
)paren
)paren
suffix:semicolon
id|memset
c_func
(paren
op_amp
(paren
id|IPCB
c_func
(paren
id|skb
)paren
op_member_access_from_pointer
id|opt
)paren
comma
l_int|0
comma
r_sizeof
(paren
id|IPCB
c_func
(paren
id|skb
)paren
op_member_access_from_pointer
id|opt
)paren
)paren
suffix:semicolon
id|dst_release
c_func
(paren
id|skb-&gt;dst
)paren
suffix:semicolon
id|skb-&gt;dst
op_assign
op_amp
id|rt-&gt;u.dst
suffix:semicolon
multiline_comment|/*&n;&t; *&t;Push down and install the IPIP header.&n;&t; */
id|iph
op_assign
id|skb-&gt;nh.iph
suffix:semicolon
id|iph-&gt;version
op_assign
l_int|4
suffix:semicolon
id|iph-&gt;ihl
op_assign
r_sizeof
(paren
r_struct
id|iphdr
)paren
op_rshift
l_int|2
suffix:semicolon
id|iph-&gt;frag_off
op_assign
id|df
suffix:semicolon
id|iph-&gt;protocol
op_assign
id|IPPROTO_IPIP
suffix:semicolon
id|iph-&gt;tos
op_assign
id|INET_ECN_encapsulate
c_func
(paren
id|tos
comma
id|old_iph-&gt;tos
)paren
suffix:semicolon
id|iph-&gt;daddr
op_assign
id|rt-&gt;rt_dst
suffix:semicolon
id|iph-&gt;saddr
op_assign
id|rt-&gt;rt_src
suffix:semicolon
r_if
c_cond
(paren
(paren
id|iph-&gt;ttl
op_assign
id|tiph-&gt;ttl
)paren
op_eq
l_int|0
)paren
id|iph-&gt;ttl
op_assign
id|old_iph-&gt;ttl
suffix:semicolon
macro_line|#ifdef CONFIG_NETFILTER
id|nf_conntrack_put
c_func
(paren
id|skb-&gt;nfct
)paren
suffix:semicolon
id|skb-&gt;nfct
op_assign
l_int|NULL
suffix:semicolon
macro_line|#ifdef CONFIG_NETFILTER_DEBUG
id|skb-&gt;nf_debug
op_assign
l_int|0
suffix:semicolon
macro_line|#endif
macro_line|#endif
id|IPTUNNEL_XMIT
c_func
(paren
)paren
suffix:semicolon
id|tunnel-&gt;recursion
op_decrement
suffix:semicolon
r_return
l_int|0
suffix:semicolon
id|tx_error_icmp
suffix:colon
id|dst_link_failure
c_func
(paren
id|skb
)paren
suffix:semicolon
id|tx_error
suffix:colon
id|stats-&gt;tx_errors
op_increment
suffix:semicolon
id|dev_kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
id|tunnel-&gt;recursion
op_decrement
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_int
DECL|function|ipip_tunnel_ioctl
id|ipip_tunnel_ioctl
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_struct
id|ifreq
op_star
id|ifr
comma
r_int
id|cmd
)paren
(brace
r_int
id|err
op_assign
l_int|0
suffix:semicolon
r_struct
id|ip_tunnel_parm
id|p
suffix:semicolon
r_struct
id|ip_tunnel
op_star
id|t
suffix:semicolon
id|MOD_INC_USE_COUNT
suffix:semicolon
r_switch
c_cond
(paren
id|cmd
)paren
(brace
r_case
id|SIOCGETTUNNEL
suffix:colon
id|t
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
id|dev
op_eq
op_amp
id|ipip_fb_tunnel_dev
)paren
(brace
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|p
comma
id|ifr-&gt;ifr_ifru.ifru_data
comma
r_sizeof
(paren
id|p
)paren
)paren
)paren
(brace
id|err
op_assign
op_minus
id|EFAULT
suffix:semicolon
r_break
suffix:semicolon
)brace
id|t
op_assign
id|ipip_tunnel_locate
c_func
(paren
op_amp
id|p
comma
l_int|0
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|t
op_eq
l_int|NULL
)paren
id|t
op_assign
(paren
r_struct
id|ip_tunnel
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|memcpy
c_func
(paren
op_amp
id|p
comma
op_amp
id|t-&gt;parms
comma
r_sizeof
(paren
id|p
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
id|ifr-&gt;ifr_ifru.ifru_data
comma
op_amp
id|p
comma
r_sizeof
(paren
id|p
)paren
)paren
)paren
id|err
op_assign
op_minus
id|EFAULT
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SIOCADDTUNNEL
suffix:colon
r_case
id|SIOCCHGTUNNEL
suffix:colon
id|err
op_assign
op_minus
id|EPERM
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|capable
c_func
(paren
id|CAP_NET_ADMIN
)paren
)paren
r_goto
id|done
suffix:semicolon
id|err
op_assign
op_minus
id|EFAULT
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|p
comma
id|ifr-&gt;ifr_ifru.ifru_data
comma
r_sizeof
(paren
id|p
)paren
)paren
)paren
r_goto
id|done
suffix:semicolon
id|err
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|p.iph.version
op_ne
l_int|4
op_logical_or
id|p.iph.protocol
op_ne
id|IPPROTO_IPIP
op_logical_or
id|p.iph.ihl
op_ne
l_int|5
op_logical_or
(paren
id|p.iph.frag_off
op_amp
id|__constant_htons
c_func
(paren
op_complement
id|IP_DF
)paren
)paren
)paren
r_goto
id|done
suffix:semicolon
r_if
c_cond
(paren
id|p.iph.ttl
)paren
id|p.iph.frag_off
op_or_assign
id|__constant_htons
c_func
(paren
id|IP_DF
)paren
suffix:semicolon
id|t
op_assign
id|ipip_tunnel_locate
c_func
(paren
op_amp
id|p
comma
id|cmd
op_eq
id|SIOCADDTUNNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dev
op_ne
op_amp
id|ipip_fb_tunnel_dev
op_logical_and
id|cmd
op_eq
id|SIOCCHGTUNNEL
op_logical_and
id|t
op_ne
op_amp
id|ipip_fb_tunnel
)paren
(brace
r_if
c_cond
(paren
id|t
op_ne
l_int|NULL
)paren
(brace
r_if
c_cond
(paren
id|t-&gt;dev
op_ne
id|dev
)paren
(brace
id|err
op_assign
op_minus
id|EEXIST
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
r_else
(brace
r_if
c_cond
(paren
(paren
(paren
id|dev-&gt;flags
op_amp
id|IFF_POINTOPOINT
)paren
op_logical_and
op_logical_neg
id|p.iph.daddr
)paren
op_logical_or
(paren
op_logical_neg
(paren
id|dev-&gt;flags
op_amp
id|IFF_POINTOPOINT
)paren
op_logical_and
id|p.iph.daddr
)paren
)paren
(brace
id|err
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_break
suffix:semicolon
)brace
id|t
op_assign
(paren
r_struct
id|ip_tunnel
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|ipip_tunnel_unlink
c_func
(paren
id|t
)paren
suffix:semicolon
id|t-&gt;parms.iph.saddr
op_assign
id|p.iph.saddr
suffix:semicolon
id|t-&gt;parms.iph.daddr
op_assign
id|p.iph.daddr
suffix:semicolon
id|memcpy
c_func
(paren
id|dev-&gt;dev_addr
comma
op_amp
id|p.iph.saddr
comma
l_int|4
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|dev-&gt;broadcast
comma
op_amp
id|p.iph.daddr
comma
l_int|4
)paren
suffix:semicolon
id|ipip_tunnel_link
c_func
(paren
id|t
)paren
suffix:semicolon
id|netdev_state_change
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|t
)paren
(brace
id|err
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|cmd
op_eq
id|SIOCCHGTUNNEL
)paren
(brace
id|t-&gt;parms.iph.ttl
op_assign
id|p.iph.ttl
suffix:semicolon
id|t-&gt;parms.iph.tos
op_assign
id|p.iph.tos
suffix:semicolon
id|t-&gt;parms.iph.frag_off
op_assign
id|p.iph.frag_off
suffix:semicolon
)brace
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
id|ifr-&gt;ifr_ifru.ifru_data
comma
op_amp
id|t-&gt;parms
comma
r_sizeof
(paren
id|p
)paren
)paren
)paren
id|err
op_assign
op_minus
id|EFAULT
suffix:semicolon
)brace
r_else
id|err
op_assign
(paren
id|cmd
op_eq
id|SIOCADDTUNNEL
ques
c_cond
op_minus
id|ENOBUFS
suffix:colon
op_minus
id|ENOENT
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SIOCDELTUNNEL
suffix:colon
id|err
op_assign
op_minus
id|EPERM
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|capable
c_func
(paren
id|CAP_NET_ADMIN
)paren
)paren
r_goto
id|done
suffix:semicolon
r_if
c_cond
(paren
id|dev
op_eq
op_amp
id|ipip_fb_tunnel_dev
)paren
(brace
id|err
op_assign
op_minus
id|EFAULT
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|p
comma
id|ifr-&gt;ifr_ifru.ifru_data
comma
r_sizeof
(paren
id|p
)paren
)paren
)paren
r_goto
id|done
suffix:semicolon
id|err
op_assign
op_minus
id|ENOENT
suffix:semicolon
r_if
c_cond
(paren
(paren
id|t
op_assign
id|ipip_tunnel_locate
c_func
(paren
op_amp
id|p
comma
l_int|0
)paren
)paren
op_eq
l_int|NULL
)paren
r_goto
id|done
suffix:semicolon
id|err
op_assign
op_minus
id|EPERM
suffix:semicolon
r_if
c_cond
(paren
id|t
op_eq
op_amp
id|ipip_fb_tunnel
)paren
r_goto
id|done
suffix:semicolon
)brace
id|err
op_assign
id|unregister_netdevice
c_func
(paren
id|dev
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|err
op_assign
op_minus
id|EINVAL
suffix:semicolon
)brace
id|done
suffix:colon
id|MOD_DEC_USE_COUNT
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
DECL|function|ipip_tunnel_get_stats
r_static
r_struct
id|net_device_stats
op_star
id|ipip_tunnel_get_stats
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_return
op_amp
(paren
(paren
(paren
r_struct
id|ip_tunnel
op_star
)paren
id|dev-&gt;priv
)paren
op_member_access_from_pointer
id|stat
)paren
suffix:semicolon
)brace
DECL|function|ipip_tunnel_change_mtu
r_static
r_int
id|ipip_tunnel_change_mtu
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_int
id|new_mtu
)paren
(brace
r_if
c_cond
(paren
id|new_mtu
template_param
l_int|0xFFF8
op_minus
r_sizeof
(paren
r_struct
id|iphdr
)paren
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|dev-&gt;mtu
op_assign
id|new_mtu
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|ipip_tunnel_init_gen
r_static
r_void
id|ipip_tunnel_init_gen
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|ip_tunnel
op_star
id|t
op_assign
(paren
r_struct
id|ip_tunnel
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|dev-&gt;uninit
op_assign
id|ipip_tunnel_uninit
suffix:semicolon
id|dev-&gt;destructor
op_assign
id|ipip_tunnel_destructor
suffix:semicolon
id|dev-&gt;hard_start_xmit
op_assign
id|ipip_tunnel_xmit
suffix:semicolon
id|dev-&gt;get_stats
op_assign
id|ipip_tunnel_get_stats
suffix:semicolon
id|dev-&gt;do_ioctl
op_assign
id|ipip_tunnel_ioctl
suffix:semicolon
id|dev-&gt;change_mtu
op_assign
id|ipip_tunnel_change_mtu
suffix:semicolon
id|dev_init_buffers
c_func
(paren
id|dev
)paren
suffix:semicolon
id|dev-&gt;type
op_assign
id|ARPHRD_TUNNEL
suffix:semicolon
id|dev-&gt;hard_header_len
op_assign
id|LL_MAX_HEADER
op_plus
r_sizeof
(paren
r_struct
id|iphdr
)paren
suffix:semicolon
id|dev-&gt;mtu
op_assign
l_int|1500
op_minus
r_sizeof
(paren
r_struct
id|iphdr
)paren
suffix:semicolon
id|dev-&gt;flags
op_assign
id|IFF_NOARP
suffix:semicolon
id|dev-&gt;iflink
op_assign
l_int|0
suffix:semicolon
id|dev-&gt;addr_len
op_assign
l_int|4
suffix:semicolon
id|memcpy
c_func
(paren
id|dev-&gt;dev_addr
comma
op_amp
id|t-&gt;parms.iph.saddr
comma
l_int|4
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|dev-&gt;broadcast
comma
op_amp
id|t-&gt;parms.iph.daddr
comma
l_int|4
)paren
suffix:semicolon
)brace
DECL|function|ipip_tunnel_init
r_static
r_int
id|ipip_tunnel_init
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|net_device
op_star
id|tdev
op_assign
l_int|NULL
suffix:semicolon
r_struct
id|ip_tunnel
op_star
id|tunnel
suffix:semicolon
r_struct
id|iphdr
op_star
id|iph
suffix:semicolon
id|tunnel
op_assign
(paren
r_struct
id|ip_tunnel
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|iph
op_assign
op_amp
id|tunnel-&gt;parms.iph
suffix:semicolon
id|ipip_tunnel_init_gen
c_func
(paren
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|iph-&gt;daddr
)paren
(brace
r_struct
id|rtable
op_star
id|rt
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ip_route_output
c_func
(paren
op_amp
id|rt
comma
id|iph-&gt;daddr
comma
id|iph-&gt;saddr
comma
id|RT_TOS
c_func
(paren
id|iph-&gt;tos
)paren
comma
id|tunnel-&gt;parms.link
)paren
)paren
(brace
id|tdev
op_assign
id|rt-&gt;u.dst.dev
suffix:semicolon
id|ip_rt_put
c_func
(paren
id|rt
)paren
suffix:semicolon
)brace
id|dev-&gt;flags
op_or_assign
id|IFF_POINTOPOINT
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|tdev
op_logical_and
id|tunnel-&gt;parms.link
)paren
id|tdev
op_assign
id|__dev_get_by_index
c_func
(paren
id|tunnel-&gt;parms.link
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tdev
)paren
(brace
id|dev-&gt;hard_header_len
op_assign
id|tdev-&gt;hard_header_len
op_plus
r_sizeof
(paren
r_struct
id|iphdr
)paren
suffix:semicolon
id|dev-&gt;mtu
op_assign
id|tdev-&gt;mtu
op_minus
r_sizeof
(paren
r_struct
id|iphdr
)paren
suffix:semicolon
)brace
id|dev-&gt;iflink
op_assign
id|tunnel-&gt;parms.link
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#ifdef MODULE
DECL|function|ipip_fb_tunnel_open
r_static
r_int
id|ipip_fb_tunnel_open
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
id|MOD_INC_USE_COUNT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|ipip_fb_tunnel_close
r_static
r_int
id|ipip_fb_tunnel_close
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
id|MOD_DEC_USE_COUNT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#endif
DECL|function|ipip_fb_tunnel_init
r_int
id|__init
id|ipip_fb_tunnel_init
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|iphdr
op_star
id|iph
suffix:semicolon
id|ipip_tunnel_init_gen
c_func
(paren
id|dev
)paren
suffix:semicolon
macro_line|#ifdef MODULE
id|dev-&gt;open
op_assign
id|ipip_fb_tunnel_open
suffix:semicolon
id|dev-&gt;stop
op_assign
id|ipip_fb_tunnel_close
suffix:semicolon
macro_line|#endif
id|iph
op_assign
op_amp
id|ipip_fb_tunnel.parms.iph
suffix:semicolon
id|iph-&gt;version
op_assign
l_int|4
suffix:semicolon
id|iph-&gt;protocol
op_assign
id|IPPROTO_IPIP
suffix:semicolon
id|iph-&gt;ihl
op_assign
l_int|5
suffix:semicolon
id|dev_hold
c_func
(paren
id|dev
)paren
suffix:semicolon
id|tunnels_wc
(braket
l_int|0
)braket
op_assign
op_amp
id|ipip_fb_tunnel
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|variable|ipip_protocol
r_static
r_struct
id|inet_protocol
id|ipip_protocol
op_assign
(brace
id|ipip_rcv
comma
multiline_comment|/* IPIP handler          */
id|ipip_err
comma
multiline_comment|/* TUNNEL error control */
l_int|0
comma
multiline_comment|/* next                 */
id|IPPROTO_IPIP
comma
multiline_comment|/* protocol ID          */
l_int|0
comma
multiline_comment|/* copy                 */
l_int|NULL
comma
multiline_comment|/* data                 */
l_string|&quot;IPIP&quot;
multiline_comment|/* name                 */
)brace
suffix:semicolon
macro_line|#ifdef MODULE
DECL|function|init_module
r_int
id|init_module
c_func
(paren
r_void
)paren
macro_line|#else
r_int
id|__init
id|ipip_init
c_func
(paren
r_void
)paren
macro_line|#endif
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;IPv4 over IPv4 tunneling driver&bslash;n&quot;
)paren
suffix:semicolon
id|ipip_fb_tunnel_dev.priv
op_assign
(paren
r_void
op_star
)paren
op_amp
id|ipip_fb_tunnel
suffix:semicolon
macro_line|#ifdef MODULE
id|register_netdev
c_func
(paren
op_amp
id|ipip_fb_tunnel_dev
)paren
suffix:semicolon
macro_line|#else
id|rtnl_lock
c_func
(paren
)paren
suffix:semicolon
id|register_netdevice
c_func
(paren
op_amp
id|ipip_fb_tunnel_dev
)paren
suffix:semicolon
id|rtnl_unlock
c_func
(paren
)paren
suffix:semicolon
macro_line|#endif
id|inet_add_protocol
c_func
(paren
op_amp
id|ipip_protocol
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#ifdef MODULE
DECL|function|cleanup_module
r_void
id|cleanup_module
c_func
(paren
r_void
)paren
(brace
r_if
c_cond
(paren
id|inet_del_protocol
c_func
(paren
op_amp
id|ipip_protocol
)paren
OL
l_int|0
)paren
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;ipip close: can&squot;t remove protocol&bslash;n&quot;
)paren
suffix:semicolon
id|unregister_netdevice
c_func
(paren
op_amp
id|ipip_fb_tunnel_dev
)paren
suffix:semicolon
)brace
macro_line|#endif
eof
