multiline_comment|/*&n; *&t;&t;IP_MASQ_AUTOFW auto forwarding module&n; *&n; *&n; * Version:&t;@(#)ip_masq_autofw.c  0.02      97/10/22&n; *&n; * Author:&t;Richard Lynch&n; *&n; *&t;This program is free software; you can redistribute it and/or&n; *&t;modify it under the terms of the GNU General Public License&n; *&t;as published by the Free Software Foundation; either version&n; *&t;2 of the License, or (at your option) any later version.&n; *&n; *&n; * Fixes:&n; *&t;Juan Jose Ciarlante&t;: created this new file from ip_masq.c and ip_fw.c&n; *&t;Juan Jose Ciarlante&t;: modularized &n; *&t;Juan Jose Ciarlante&t;: use GFP_KERNEL when creating entries&n; *&t;Juan Jose Ciarlante&t;: call del_timer() when freeing entries (!)&n; *  FIXME:&n; *&t;- implement refcnt&n; *&n; */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/slab.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;asm/system.h&gt;
macro_line|#include &lt;linux/stat.h&gt;
macro_line|#include &lt;linux/proc_fs.h&gt;
macro_line|#include &lt;linux/if.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/ip_fw.h&gt;
macro_line|#include &lt;net/ip_masq.h&gt;
macro_line|#include &lt;net/ip_masq_mod.h&gt;
macro_line|#include &lt;net/ip_autofw.h&gt;
multiline_comment|/*&n; *&t;Debug level&n; */
DECL|variable|debug
r_static
r_int
id|debug
op_assign
l_int|0
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|ports
comma
l_string|&quot;1-&quot;
id|__MODULE_STRING
c_func
(paren
id|MAX_MASQ_APP_PORTS
)paren
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|debug
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
multiline_comment|/*&n; *&t;Auto-forwarding table&n; */
DECL|variable|ip_autofw_hosts
r_static
r_struct
id|ip_autofw
op_star
id|ip_autofw_hosts
op_assign
l_int|NULL
suffix:semicolon
DECL|variable|mmod_self
r_static
r_struct
id|ip_masq_mod
op_star
id|mmod_self
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/*&n; *&t;Check if a masq entry should be created for a packet&n; */
DECL|function|ip_autofw_check_range
r_static
id|__inline__
r_struct
id|ip_autofw
op_star
id|ip_autofw_check_range
(paren
id|__u32
id|where
comma
id|__u16
id|port
comma
id|__u16
id|protocol
comma
r_int
id|reqact
)paren
(brace
r_struct
id|ip_autofw
op_star
id|af
suffix:semicolon
id|af
op_assign
id|ip_autofw_hosts
suffix:semicolon
id|port
op_assign
id|ntohs
c_func
(paren
id|port
)paren
suffix:semicolon
r_while
c_loop
(paren
id|af
)paren
(brace
r_if
c_cond
(paren
id|af-&gt;type
op_eq
id|IP_FWD_RANGE
op_logical_and
id|port
op_ge
id|af-&gt;low
op_logical_and
id|port
op_le
id|af-&gt;high
op_logical_and
id|protocol
op_eq
id|af-&gt;protocol
op_logical_and
multiline_comment|/*&n;&t;&t;      *&t;&t;It&squot;s ok to create masq entries after &n;&t;&t;      *&t;&t;the timeout if we&squot;re in insecure mode &n;&t;&t;      */
(paren
id|af-&gt;flags
op_amp
id|IP_AUTOFW_ACTIVE
op_logical_or
op_logical_neg
id|reqact
op_logical_or
op_logical_neg
(paren
id|af-&gt;flags
op_amp
id|IP_AUTOFW_SECURE
)paren
)paren
op_logical_and
(paren
op_logical_neg
(paren
id|af-&gt;flags
op_amp
id|IP_AUTOFW_SECURE
)paren
op_logical_or
id|af-&gt;lastcontact
op_eq
id|where
op_logical_or
op_logical_neg
id|reqact
)paren
)paren
r_return
id|af
suffix:semicolon
id|af
op_assign
id|af-&gt;next
suffix:semicolon
)brace
r_return
l_int|NULL
suffix:semicolon
)brace
DECL|function|ip_autofw_check_port
r_static
id|__inline__
r_struct
id|ip_autofw
op_star
id|ip_autofw_check_port
(paren
id|__u16
id|port
comma
id|__u16
id|protocol
)paren
(brace
r_struct
id|ip_autofw
op_star
id|af
suffix:semicolon
id|af
op_assign
id|ip_autofw_hosts
suffix:semicolon
id|port
op_assign
id|ntohs
c_func
(paren
id|port
)paren
suffix:semicolon
r_while
c_loop
(paren
id|af
)paren
(brace
r_if
c_cond
(paren
id|af-&gt;type
op_eq
id|IP_FWD_PORT
op_logical_and
id|port
op_eq
id|af-&gt;visible
op_logical_and
id|protocol
op_eq
id|af-&gt;protocol
)paren
r_return
id|af
suffix:semicolon
id|af
op_assign
id|af-&gt;next
suffix:semicolon
)brace
r_return
l_int|NULL
suffix:semicolon
)brace
DECL|function|ip_autofw_check_direct
r_static
id|__inline__
r_struct
id|ip_autofw
op_star
id|ip_autofw_check_direct
(paren
id|__u16
id|port
comma
id|__u16
id|protocol
)paren
(brace
r_struct
id|ip_autofw
op_star
id|af
suffix:semicolon
id|af
op_assign
id|ip_autofw_hosts
suffix:semicolon
id|port
op_assign
id|ntohs
c_func
(paren
id|port
)paren
suffix:semicolon
r_while
c_loop
(paren
id|af
)paren
(brace
r_if
c_cond
(paren
id|af-&gt;type
op_eq
id|IP_FWD_DIRECT
op_logical_and
id|af-&gt;low
op_le
id|port
op_logical_and
id|af-&gt;high
op_ge
id|port
)paren
r_return
id|af
suffix:semicolon
id|af
op_assign
id|af-&gt;next
suffix:semicolon
)brace
r_return
l_int|NULL
suffix:semicolon
)brace
DECL|function|ip_autofw_update_out
r_static
id|__inline__
r_void
id|ip_autofw_update_out
(paren
id|__u32
id|who
comma
id|__u32
id|where
comma
id|__u16
id|port
comma
id|__u16
id|protocol
)paren
(brace
r_struct
id|ip_autofw
op_star
id|af
suffix:semicolon
id|af
op_assign
id|ip_autofw_hosts
suffix:semicolon
id|port
op_assign
id|ntohs
c_func
(paren
id|port
)paren
suffix:semicolon
r_while
c_loop
(paren
id|af
)paren
(brace
r_if
c_cond
(paren
id|af-&gt;type
op_eq
id|IP_FWD_RANGE
op_logical_and
id|af-&gt;ctlport
op_eq
id|port
op_logical_and
id|af-&gt;ctlproto
op_eq
id|protocol
)paren
(brace
r_if
c_cond
(paren
id|af-&gt;flags
op_amp
id|IP_AUTOFW_USETIME
)paren
(brace
id|mod_timer
c_func
(paren
op_amp
id|af-&gt;timer
comma
id|jiffies
op_plus
id|IP_AUTOFW_EXPIRE
)paren
suffix:semicolon
)brace
id|af-&gt;flags
op_or_assign
id|IP_AUTOFW_ACTIVE
suffix:semicolon
id|af-&gt;lastcontact
op_assign
id|where
suffix:semicolon
id|af-&gt;where
op_assign
id|who
suffix:semicolon
)brace
id|af
op_assign
id|af-&gt;next
suffix:semicolon
)brace
)brace
macro_line|#if 0
r_static
id|__inline__
r_void
id|ip_autofw_update_in
(paren
id|__u32
id|where
comma
id|__u16
id|port
comma
id|__u16
id|protocol
)paren
(brace
r_struct
id|ip_autofw
op_star
id|af
suffix:semicolon
id|af
op_assign
id|ip_autofw_check_range
c_func
(paren
id|where
comma
id|port
comma
id|protocol
)paren
suffix:semicolon
r_if
c_cond
(paren
id|af
)paren
(brace
id|mod_timer
c_func
(paren
op_amp
id|af-&gt;timer
comma
id|jiffies
op_plus
id|IP_AUTOFW_EXPIRE
)paren
suffix:semicolon
)brace
)brace
macro_line|#endif
DECL|function|ip_autofw_expire
r_static
id|__inline__
r_void
id|ip_autofw_expire
c_func
(paren
r_int
r_int
id|data
)paren
(brace
r_struct
id|ip_autofw
op_star
id|af
suffix:semicolon
id|af
op_assign
(paren
r_struct
id|ip_autofw
op_star
)paren
id|data
suffix:semicolon
id|af-&gt;flags
op_and_assign
op_complement
id|IP_AUTOFW_ACTIVE
suffix:semicolon
id|af-&gt;timer.expires
op_assign
l_int|0
suffix:semicolon
id|af-&gt;lastcontact
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|af-&gt;flags
op_amp
id|IP_AUTOFW_SECURE
)paren
id|af-&gt;where
op_assign
l_int|0
suffix:semicolon
)brace
DECL|function|ip_autofw_add
r_static
id|__inline__
r_int
id|ip_autofw_add
c_func
(paren
r_struct
id|ip_autofw
op_star
id|af
)paren
(brace
r_struct
id|ip_autofw
op_star
id|newaf
suffix:semicolon
id|init_timer
c_func
(paren
op_amp
id|af-&gt;timer
)paren
suffix:semicolon
id|newaf
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|ip_autofw
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|newaf
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;ip_autofw_add:  malloc said no&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|ENOMEM
suffix:semicolon
)brace
id|MOD_INC_USE_COUNT
suffix:semicolon
id|memcpy
c_func
(paren
id|newaf
comma
id|af
comma
r_sizeof
(paren
r_struct
id|ip_autofw
)paren
)paren
suffix:semicolon
id|newaf-&gt;timer.data
op_assign
(paren
r_int
r_int
)paren
id|newaf
suffix:semicolon
id|newaf-&gt;timer.function
op_assign
id|ip_autofw_expire
suffix:semicolon
id|newaf-&gt;timer.expires
op_assign
l_int|0
suffix:semicolon
id|newaf-&gt;lastcontact
op_assign
l_int|0
suffix:semicolon
id|newaf-&gt;next
op_assign
id|ip_autofw_hosts
suffix:semicolon
id|ip_autofw_hosts
op_assign
id|newaf
suffix:semicolon
id|ip_masq_mod_inc_nent
c_func
(paren
id|mmod_self
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|ip_autofw_del
r_static
id|__inline__
r_int
id|ip_autofw_del
c_func
(paren
r_struct
id|ip_autofw
op_star
id|af
)paren
(brace
r_struct
id|ip_autofw
op_star
op_star
id|af_p
comma
op_star
id|curr
suffix:semicolon
r_for
c_loop
(paren
id|af_p
op_assign
op_amp
id|ip_autofw_hosts
comma
id|curr
op_assign
op_star
id|af_p
suffix:semicolon
(paren
id|curr
op_assign
op_star
id|af_p
)paren
suffix:semicolon
id|af_p
op_assign
op_amp
(paren
op_star
id|af_p
)paren
op_member_access_from_pointer
id|next
)paren
(brace
r_if
c_cond
(paren
id|af-&gt;type
op_eq
id|curr-&gt;type
op_logical_and
id|af-&gt;low
op_eq
id|curr-&gt;low
op_logical_and
id|af-&gt;high
op_eq
id|curr-&gt;high
op_logical_and
id|af-&gt;hidden
op_eq
id|curr-&gt;hidden
op_logical_and
id|af-&gt;visible
op_eq
id|curr-&gt;visible
op_logical_and
id|af-&gt;protocol
op_eq
id|curr-&gt;protocol
op_logical_and
id|af-&gt;where
op_eq
id|curr-&gt;where
op_logical_and
id|af-&gt;ctlproto
op_eq
id|curr-&gt;ctlproto
op_logical_and
id|af-&gt;ctlport
op_eq
id|curr-&gt;ctlport
)paren
(brace
id|ip_masq_mod_dec_nent
c_func
(paren
id|mmod_self
)paren
suffix:semicolon
op_star
id|af_p
op_assign
id|curr-&gt;next
suffix:semicolon
r_if
c_cond
(paren
id|af-&gt;flags
op_amp
id|IP_AUTOFW_ACTIVE
)paren
id|del_timer
c_func
(paren
op_amp
id|curr-&gt;timer
)paren
suffix:semicolon
id|kfree_s
c_func
(paren
id|curr
comma
r_sizeof
(paren
r_struct
id|ip_autofw
)paren
)paren
suffix:semicolon
id|MOD_DEC_USE_COUNT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|curr
op_assign
id|curr-&gt;next
suffix:semicolon
)brace
r_return
id|EINVAL
suffix:semicolon
)brace
DECL|function|ip_autofw_flush
r_static
id|__inline__
r_int
id|ip_autofw_flush
c_func
(paren
r_void
)paren
(brace
r_struct
id|ip_autofw
op_star
id|af
suffix:semicolon
r_while
c_loop
(paren
id|ip_autofw_hosts
)paren
(brace
id|af
op_assign
id|ip_autofw_hosts
suffix:semicolon
id|ip_masq_mod_dec_nent
c_func
(paren
id|mmod_self
)paren
suffix:semicolon
id|ip_autofw_hosts
op_assign
id|ip_autofw_hosts-&gt;next
suffix:semicolon
r_if
c_cond
(paren
id|af-&gt;flags
op_amp
id|IP_AUTOFW_ACTIVE
)paren
id|del_timer
c_func
(paren
op_amp
id|af-&gt;timer
)paren
suffix:semicolon
id|kfree_s
c_func
(paren
id|af
comma
r_sizeof
(paren
r_struct
id|ip_autofw
)paren
)paren
suffix:semicolon
id|MOD_DEC_USE_COUNT
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;Methods for registered object&n; */
DECL|function|autofw_ctl
r_static
r_int
id|autofw_ctl
c_func
(paren
r_int
id|optname
comma
r_struct
id|ip_fw_masqctl
op_star
id|mctl
comma
r_int
id|optlen
)paren
(brace
r_struct
id|ip_autofw
op_star
id|af
op_assign
(paren
r_struct
id|ip_autofw
op_star
)paren
id|mctl-&gt;u.mod.data
suffix:semicolon
r_switch
c_cond
(paren
id|optname
)paren
(brace
r_case
id|IP_FW_MASQ_ADD
suffix:colon
r_if
c_cond
(paren
id|optlen
OL
r_sizeof
(paren
op_star
id|af
)paren
)paren
r_return
id|EINVAL
suffix:semicolon
r_return
id|ip_autofw_add
c_func
(paren
id|af
)paren
suffix:semicolon
r_case
id|IP_FW_MASQ_DEL
suffix:colon
r_if
c_cond
(paren
id|optlen
OL
r_sizeof
(paren
op_star
id|af
)paren
)paren
r_return
id|EINVAL
suffix:semicolon
r_return
id|ip_autofw_del
c_func
(paren
id|af
)paren
suffix:semicolon
r_case
id|IP_FW_MASQ_FLUSH
suffix:colon
r_return
id|ip_autofw_flush
c_func
(paren
)paren
suffix:semicolon
)brace
r_return
id|EINVAL
suffix:semicolon
)brace
DECL|function|autofw_out_update
r_static
r_int
id|autofw_out_update
c_func
(paren
r_struct
id|iphdr
op_star
id|iph
comma
id|__u16
op_star
id|portp
comma
r_struct
id|ip_masq
op_star
id|ms
)paren
(brace
multiline_comment|/* &n;&t; *&t;Update any ipautofw entries ...&n;&t; */
id|ip_autofw_update_out
c_func
(paren
id|iph-&gt;saddr
comma
id|iph-&gt;daddr
comma
id|portp
(braket
l_int|1
)braket
comma
id|iph-&gt;protocol
)paren
suffix:semicolon
r_return
id|IP_MASQ_MOD_NOP
suffix:semicolon
)brace
DECL|function|autofw_out_create
r_static
r_struct
id|ip_masq
op_star
id|autofw_out_create
c_func
(paren
r_struct
id|iphdr
op_star
id|iph
comma
id|__u16
op_star
id|portp
comma
id|__u32
id|maddr
)paren
(brace
multiline_comment|/*&n;&t; *&t;If the source port is supposed to match the masq port, then&n;&t; *  &t;make it so &n;&t; */
r_if
c_cond
(paren
id|ip_autofw_check_direct
c_func
(paren
id|portp
(braket
l_int|1
)braket
comma
id|iph-&gt;protocol
)paren
)paren
(brace
r_return
id|ip_masq_new
c_func
(paren
id|iph-&gt;protocol
comma
id|maddr
comma
id|portp
(braket
l_int|0
)braket
comma
id|iph-&gt;saddr
comma
id|portp
(braket
l_int|0
)braket
comma
id|iph-&gt;daddr
comma
id|portp
(braket
l_int|1
)braket
comma
l_int|0
)paren
suffix:semicolon
)brace
r_return
l_int|NULL
suffix:semicolon
)brace
macro_line|#if 0
r_static
r_int
id|autofw_in_update
c_func
(paren
r_struct
id|iphdr
op_star
id|iph
comma
id|__u16
op_star
id|portp
comma
r_struct
id|ip_masq
op_star
id|ms
)paren
(brace
id|ip_autofw_update_in
c_func
(paren
id|iph-&gt;saddr
comma
id|portp
(braket
l_int|1
)braket
comma
id|iph-&gt;protocol
)paren
suffix:semicolon
r_return
id|IP_MASQ_MOD_NOP
suffix:semicolon
)brace
macro_line|#endif
DECL|function|autofw_in_rule
r_static
r_int
id|autofw_in_rule
c_func
(paren
r_struct
id|iphdr
op_star
id|iph
comma
id|__u16
op_star
id|portp
)paren
(brace
r_return
(paren
id|ip_autofw_check_range
c_func
(paren
id|iph-&gt;saddr
comma
id|portp
(braket
l_int|1
)braket
comma
id|iph-&gt;protocol
comma
l_int|0
)paren
op_logical_or
id|ip_autofw_check_direct
c_func
(paren
id|portp
(braket
l_int|1
)braket
comma
id|iph-&gt;protocol
)paren
op_logical_or
id|ip_autofw_check_port
c_func
(paren
id|portp
(braket
l_int|1
)braket
comma
id|iph-&gt;protocol
)paren
)paren
suffix:semicolon
)brace
DECL|function|autofw_in_create
r_static
r_struct
id|ip_masq
op_star
id|autofw_in_create
c_func
(paren
r_struct
id|iphdr
op_star
id|iph
comma
id|__u16
op_star
id|portp
comma
id|__u32
id|maddr
)paren
(brace
r_struct
id|ip_autofw
op_star
id|af
suffix:semicolon
r_if
c_cond
(paren
(paren
id|af
op_assign
id|ip_autofw_check_range
c_func
(paren
id|iph-&gt;saddr
comma
id|portp
(braket
l_int|1
)braket
comma
id|iph-&gt;protocol
comma
l_int|0
)paren
)paren
)paren
(brace
id|IP_MASQ_DEBUG
c_func
(paren
l_int|1
op_minus
id|debug
comma
l_string|&quot;autofw_check_range HIT&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|ip_masq_new
c_func
(paren
id|iph-&gt;protocol
comma
id|maddr
comma
id|portp
(braket
l_int|1
)braket
comma
id|af-&gt;where
comma
id|portp
(braket
l_int|1
)braket
comma
id|iph-&gt;saddr
comma
id|portp
(braket
l_int|0
)braket
comma
l_int|0
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|af
op_assign
id|ip_autofw_check_port
c_func
(paren
id|portp
(braket
l_int|1
)braket
comma
id|iph-&gt;protocol
)paren
)paren
)paren
(brace
id|IP_MASQ_DEBUG
c_func
(paren
l_int|1
op_minus
id|debug
comma
l_string|&quot;autofw_check_port HIT&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|ip_masq_new
c_func
(paren
id|iph-&gt;protocol
comma
id|maddr
comma
id|htons
c_func
(paren
id|af-&gt;visible
)paren
comma
id|af-&gt;where
comma
id|htons
c_func
(paren
id|af-&gt;hidden
)paren
comma
id|iph-&gt;saddr
comma
id|portp
(braket
l_int|0
)braket
comma
l_int|0
)paren
suffix:semicolon
)brace
r_return
l_int|NULL
suffix:semicolon
)brace
macro_line|#ifdef CONFIG_PROC_FS
DECL|function|autofw_procinfo
r_static
r_int
id|autofw_procinfo
c_func
(paren
r_char
op_star
id|buffer
comma
r_char
op_star
op_star
id|start
comma
id|off_t
id|offset
comma
r_int
id|length
comma
r_int
id|unused
)paren
(brace
id|off_t
id|pos
op_assign
l_int|0
comma
id|begin
op_assign
l_int|0
suffix:semicolon
r_struct
id|ip_autofw
op_star
id|af
suffix:semicolon
r_int
id|len
op_assign
l_int|0
suffix:semicolon
id|len
op_assign
id|sprintf
c_func
(paren
id|buffer
comma
l_string|&quot;Type Prot Low  High Vis  Hid  Where    Last     CPto CPrt Timer Flags&bslash;n&quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|af
op_assign
id|ip_autofw_hosts
suffix:semicolon
id|af
suffix:semicolon
id|af
op_assign
id|af-&gt;next
)paren
(brace
id|len
op_add_assign
id|sprintf
c_func
(paren
id|buffer
op_plus
id|len
comma
l_string|&quot;%4X %4X %04X-%04X/%04X %04X %08lX %08lX %04X %04X %6lu %4X&bslash;n&quot;
comma
id|af-&gt;type
comma
id|af-&gt;protocol
comma
id|af-&gt;low
comma
id|af-&gt;high
comma
id|af-&gt;visible
comma
id|af-&gt;hidden
comma
id|ntohl
c_func
(paren
id|af-&gt;where
)paren
comma
id|ntohl
c_func
(paren
id|af-&gt;lastcontact
)paren
comma
id|af-&gt;ctlproto
comma
id|af-&gt;ctlport
comma
(paren
id|af-&gt;timer.expires
OL
id|jiffies
ques
c_cond
l_int|0
suffix:colon
id|af-&gt;timer.expires
op_minus
id|jiffies
)paren
comma
id|af-&gt;flags
)paren
suffix:semicolon
id|pos
op_assign
id|begin
op_plus
id|len
suffix:semicolon
r_if
c_cond
(paren
id|pos
OL
id|offset
)paren
(brace
id|len
op_assign
l_int|0
suffix:semicolon
id|begin
op_assign
id|pos
suffix:semicolon
)brace
r_if
c_cond
(paren
id|pos
OG
id|offset
op_plus
id|length
)paren
(brace
r_break
suffix:semicolon
)brace
)brace
op_star
id|start
op_assign
id|buffer
op_plus
(paren
id|offset
op_minus
id|begin
)paren
suffix:semicolon
id|len
op_sub_assign
(paren
id|offset
op_minus
id|begin
)paren
suffix:semicolon
r_if
c_cond
(paren
id|len
OG
id|length
)paren
(brace
id|len
op_assign
id|length
suffix:semicolon
)brace
r_return
id|len
suffix:semicolon
)brace
DECL|variable|autofw_proc_entry
r_static
r_struct
id|proc_dir_entry
id|autofw_proc_entry
op_assign
(brace
l_int|0
comma
l_int|0
comma
l_int|NULL
comma
id|S_IFREG
op_or
id|S_IRUGO
comma
l_int|1
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
op_amp
id|proc_net_inode_operations
comma
id|autofw_procinfo
)brace
suffix:semicolon
DECL|macro|proc_ent
mdefine_line|#define proc_ent &amp;autofw_proc_entry
macro_line|#else /* !CONFIG_PROC_FS */
DECL|macro|proc_ent
mdefine_line|#define proc_ent NULL
macro_line|#endif
DECL|macro|autofw_in_update
mdefine_line|#define&t;autofw_in_update NULL
DECL|macro|autofw_out_rule
mdefine_line|#define autofw_out_rule NULL
DECL|macro|autofw_mod_init
mdefine_line|#define autofw_mod_init NULL
DECL|macro|autofw_mod_done
mdefine_line|#define autofw_mod_done NULL
DECL|variable|autofw_mod
r_static
r_struct
id|ip_masq_mod
id|autofw_mod
op_assign
(brace
l_int|NULL
comma
multiline_comment|/* next */
l_int|NULL
comma
multiline_comment|/* next_reg */
l_string|&quot;autofw&quot;
comma
multiline_comment|/* name */
id|ATOMIC_INIT
c_func
(paren
l_int|0
)paren
comma
multiline_comment|/* nent */
id|ATOMIC_INIT
c_func
(paren
l_int|0
)paren
comma
multiline_comment|/* refcnt */
id|proc_ent
comma
id|autofw_ctl
comma
id|autofw_mod_init
comma
id|autofw_mod_done
comma
id|autofw_in_rule
comma
id|autofw_in_update
comma
id|autofw_in_create
comma
id|autofw_out_rule
comma
id|autofw_out_update
comma
id|autofw_out_create
comma
)brace
suffix:semicolon
DECL|function|__initfunc
id|__initfunc
c_func
(paren
r_int
id|ip_autofw_init
c_func
(paren
r_void
)paren
)paren
(brace
r_return
id|register_ip_masq_mod
(paren
(paren
id|mmod_self
op_assign
op_amp
id|autofw_mod
)paren
)paren
suffix:semicolon
)brace
DECL|function|ip_autofw_done
r_int
id|ip_autofw_done
c_func
(paren
r_void
)paren
(brace
r_return
id|unregister_ip_masq_mod
c_func
(paren
op_amp
id|autofw_mod
)paren
suffix:semicolon
)brace
macro_line|#ifdef MODULE
id|EXPORT_NO_SYMBOLS
suffix:semicolon
DECL|function|init_module
r_int
id|init_module
c_func
(paren
r_void
)paren
(brace
r_if
c_cond
(paren
id|ip_autofw_init
c_func
(paren
)paren
op_ne
l_int|0
)paren
r_return
op_minus
id|EIO
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|cleanup_module
r_void
id|cleanup_module
c_func
(paren
r_void
)paren
(brace
r_if
c_cond
(paren
id|ip_autofw_done
c_func
(paren
)paren
op_ne
l_int|0
)paren
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;ip_autofw_done(): can&squot;t remove module&quot;
)paren
suffix:semicolon
)brace
macro_line|#endif /* MODULE */
eof
