multiline_comment|/*&n; *&t;Linux NET3:&t;GRE over IP protocol decoder. &n; *&n; *&t;Authors: Alexey Kuznetsov (kuznet@ms2.inr.ac.ru)&n; *&n; *&t;This program is free software; you can redistribute it and/or&n; *&t;modify it under the terms of the GNU General Public License&n; *&t;as published by the Free Software Foundation; either version&n; *&t;2 of the License, or (at your option) any later version.&n; *&n; */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;asm/uaccess.h&gt;
macro_line|#include &lt;linux/skbuff.h&gt;
macro_line|#include &lt;linux/netdevice.h&gt;
macro_line|#include &lt;linux/in.h&gt;
macro_line|#include &lt;linux/tcp.h&gt;
macro_line|#include &lt;linux/udp.h&gt;
macro_line|#include &lt;linux/if_arp.h&gt;
macro_line|#include &lt;linux/mroute.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/in6.h&gt;
macro_line|#include &lt;linux/inetdevice.h&gt;
macro_line|#include &lt;linux/igmp.h&gt;
macro_line|#include &lt;linux/netfilter_ipv4.h&gt;
macro_line|#include &lt;net/sock.h&gt;
macro_line|#include &lt;net/ip.h&gt;
macro_line|#include &lt;net/icmp.h&gt;
macro_line|#include &lt;net/protocol.h&gt;
macro_line|#include &lt;net/ipip.h&gt;
macro_line|#include &lt;net/arp.h&gt;
macro_line|#include &lt;net/checksum.h&gt;
macro_line|#include &lt;net/inet_ecn.h&gt;
macro_line|#ifdef CONFIG_IPV6
macro_line|#include &lt;net/ipv6.h&gt;
macro_line|#include &lt;net/ip6_fib.h&gt;
macro_line|#include &lt;net/ip6_route.h&gt;
macro_line|#endif
multiline_comment|/*&n;   Problems &amp; solutions&n;   --------------------&n;&n;   1. The most important issue is detecting local dead loops.&n;   They would cause complete host lockup in transmit, which&n;   would be &quot;resolved&quot; by stack overflow or, if queueing is enabled,&n;   with infinite looping in net_bh.&n;&n;   We cannot track such dead loops during route installation,&n;   it is infeasible task. The most general solutions would be&n;   to keep skb-&gt;encapsulation counter (sort of local ttl),&n;   and silently drop packet when it expires. It is the best&n;   solution, but it supposes maintaing new variable in ALL&n;   skb, even if no tunneling is used.&n;&n;   Current solution: t-&gt;recursion lock breaks dead loops. It looks &n;   like dev-&gt;tbusy flag, but I preferred new variable, because&n;   the semantics is different. One day, when hard_start_xmit&n;   will be multithreaded we will have to use skb-&gt;encapsulation.&n;&n;&n;&n;   2. Networking dead loops would not kill routers, but would really&n;   kill network. IP hop limit plays role of &quot;t-&gt;recursion&quot; in this case,&n;   if we copy it from packet being encapsulated to upper header.&n;   It is very good solution, but it introduces two problems:&n;&n;   - Routing protocols, using packets with ttl=1 (OSPF, RIP2),&n;     do not work over tunnels.&n;   - traceroute does not work. I planned to relay ICMP from tunnel,&n;     so that this problem would be solved and traceroute output&n;     would even more informative. This idea appeared to be wrong:&n;     only Linux complies to rfc1812 now (yes, guys, Linux is the only&n;     true router now :-)), all routers (at least, in neighbourhood of mine)&n;     return only 8 bytes of payload. It is the end.&n;&n;   Hence, if we want that OSPF worked or traceroute said something reasonable,&n;   we should search for another solution.&n;&n;   One of them is to parse packet trying to detect inner encapsulation&n;   made by our node. It is difficult or even impossible, especially,&n;   taking into account fragmentation. TO be short, tt is not solution at all.&n;&n;   Current solution: The solution was UNEXPECTEDLY SIMPLE.&n;   We force DF flag on tunnels with preconfigured hop limit,&n;   that is ALL. :-) Well, it does not remove the problem completely,&n;   but exponential growth of network traffic is changed to linear&n;   (branches, that exceed pmtu are pruned) and tunnel mtu&n;   fastly degrades to value &lt;68, where looping stops.&n;   Yes, it is not good if there exists a router in the loop,&n;   which does not force DF, even when encapsulating packets have DF set.&n;   But it is not our problem! Nobody could accuse us, we made&n;   all that we could make. Even if it is your gated who injected&n;   fatal route to network, even if it were you who configured&n;   fatal static route: you are innocent. :-)&n;&n;&n;&n;   3. Really, ipv4/ipip.c, ipv4/ip_gre.c and ipv6/sit.c contain&n;   practically identical code. It would be good to glue them&n;   together, but it is not very evident, how to make them modular.&n;   sit is integral part of IPv6, ipip and gre are naturally modular.&n;   We could extract common parts (hash table, ioctl etc)&n;   to a separate module (ip_tunnel.c).&n;&n;   Alexey Kuznetsov.&n; */
r_static
r_int
id|ipgre_tunnel_init
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
multiline_comment|/* Fallback tunnel: no source, no destination, no key, no options */
r_static
r_int
id|ipgre_fb_tunnel_init
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
DECL|variable|ipgre_fb_tunnel_dev
r_static
r_struct
id|net_device
id|ipgre_fb_tunnel_dev
op_assign
(brace
l_string|&quot;gre0&quot;
comma
l_int|0x0
comma
l_int|0x0
comma
l_int|0x0
comma
l_int|0x0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|NULL
comma
id|ipgre_fb_tunnel_init
comma
)brace
suffix:semicolon
DECL|variable|ipgre_fb_tunnel
r_static
r_struct
id|ip_tunnel
id|ipgre_fb_tunnel
op_assign
(brace
l_int|NULL
comma
op_amp
id|ipgre_fb_tunnel_dev
comma
(brace
l_int|0
comma
)brace
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
(brace
l_string|&quot;gre0&quot;
comma
)brace
)brace
suffix:semicolon
multiline_comment|/* Tunnel hash table */
multiline_comment|/*&n;   4 hash tables:&n;&n;   3: (remote,local)&n;   2: (remote,*)&n;   1: (*,local)&n;   0: (*,*)&n;&n;   We require exact key match i.e. if a key is present in packet&n;   it will match only tunnel with the same key; if it is not present,&n;   it will match only keyless tunnel.&n;&n;   All keysless packets, if not matched configured keyless tunnels&n;   will match fallback tunnel.&n; */
DECL|macro|HASH_SIZE
mdefine_line|#define HASH_SIZE  16
DECL|macro|HASH
mdefine_line|#define HASH(addr) ((addr^(addr&gt;&gt;4))&amp;0xF)
DECL|variable|tunnels
r_static
r_struct
id|ip_tunnel
op_star
id|tunnels
(braket
l_int|4
)braket
(braket
id|HASH_SIZE
)braket
suffix:semicolon
DECL|macro|tunnels_r_l
mdefine_line|#define tunnels_r_l&t;(tunnels[3])
DECL|macro|tunnels_r
mdefine_line|#define tunnels_r&t;(tunnels[2])
DECL|macro|tunnels_l
mdefine_line|#define tunnels_l&t;(tunnels[1])
DECL|macro|tunnels_wc
mdefine_line|#define tunnels_wc&t;(tunnels[0])
DECL|variable|ipgre_lock
r_static
id|rwlock_t
id|ipgre_lock
op_assign
id|RW_LOCK_UNLOCKED
suffix:semicolon
multiline_comment|/* Given src, dst and key, find approriate for input tunnel. */
DECL|function|ipgre_tunnel_lookup
r_static
r_struct
id|ip_tunnel
op_star
id|ipgre_tunnel_lookup
c_func
(paren
id|u32
id|remote
comma
id|u32
id|local
comma
id|u32
id|key
)paren
(brace
r_int
id|h0
op_assign
id|HASH
c_func
(paren
id|remote
)paren
suffix:semicolon
r_int
id|h1
op_assign
id|HASH
c_func
(paren
id|key
)paren
suffix:semicolon
r_struct
id|ip_tunnel
op_star
id|t
suffix:semicolon
r_for
c_loop
(paren
id|t
op_assign
id|tunnels_r_l
(braket
id|h0
op_xor
id|h1
)braket
suffix:semicolon
id|t
suffix:semicolon
id|t
op_assign
id|t-&gt;next
)paren
(brace
r_if
c_cond
(paren
id|local
op_eq
id|t-&gt;parms.iph.saddr
op_logical_and
id|remote
op_eq
id|t-&gt;parms.iph.daddr
)paren
(brace
r_if
c_cond
(paren
id|t-&gt;parms.i_key
op_eq
id|key
op_logical_and
(paren
id|t-&gt;dev-&gt;flags
op_amp
id|IFF_UP
)paren
)paren
r_return
id|t
suffix:semicolon
)brace
)brace
r_for
c_loop
(paren
id|t
op_assign
id|tunnels_r
(braket
id|h0
op_xor
id|h1
)braket
suffix:semicolon
id|t
suffix:semicolon
id|t
op_assign
id|t-&gt;next
)paren
(brace
r_if
c_cond
(paren
id|remote
op_eq
id|t-&gt;parms.iph.daddr
)paren
(brace
r_if
c_cond
(paren
id|t-&gt;parms.i_key
op_eq
id|key
op_logical_and
(paren
id|t-&gt;dev-&gt;flags
op_amp
id|IFF_UP
)paren
)paren
r_return
id|t
suffix:semicolon
)brace
)brace
r_for
c_loop
(paren
id|t
op_assign
id|tunnels_l
(braket
id|h1
)braket
suffix:semicolon
id|t
suffix:semicolon
id|t
op_assign
id|t-&gt;next
)paren
(brace
r_if
c_cond
(paren
id|local
op_eq
id|t-&gt;parms.iph.saddr
op_logical_or
(paren
id|local
op_eq
id|t-&gt;parms.iph.daddr
op_logical_and
id|MULTICAST
c_func
(paren
id|local
)paren
)paren
)paren
(brace
r_if
c_cond
(paren
id|t-&gt;parms.i_key
op_eq
id|key
op_logical_and
(paren
id|t-&gt;dev-&gt;flags
op_amp
id|IFF_UP
)paren
)paren
r_return
id|t
suffix:semicolon
)brace
)brace
r_for
c_loop
(paren
id|t
op_assign
id|tunnels_wc
(braket
id|h1
)braket
suffix:semicolon
id|t
suffix:semicolon
id|t
op_assign
id|t-&gt;next
)paren
(brace
r_if
c_cond
(paren
id|t-&gt;parms.i_key
op_eq
id|key
op_logical_and
(paren
id|t-&gt;dev-&gt;flags
op_amp
id|IFF_UP
)paren
)paren
r_return
id|t
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ipgre_fb_tunnel_dev.flags
op_amp
id|IFF_UP
)paren
r_return
op_amp
id|ipgre_fb_tunnel
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
DECL|function|ipgre_bucket
r_static
r_struct
id|ip_tunnel
op_star
op_star
id|ipgre_bucket
c_func
(paren
r_struct
id|ip_tunnel
op_star
id|t
)paren
(brace
id|u32
id|remote
op_assign
id|t-&gt;parms.iph.daddr
suffix:semicolon
id|u32
id|local
op_assign
id|t-&gt;parms.iph.saddr
suffix:semicolon
id|u32
id|key
op_assign
id|t-&gt;parms.i_key
suffix:semicolon
r_int
id|h
op_assign
id|HASH
c_func
(paren
id|key
)paren
suffix:semicolon
r_int
id|prio
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|local
)paren
id|prio
op_or_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|remote
op_logical_and
op_logical_neg
id|MULTICAST
c_func
(paren
id|remote
)paren
)paren
(brace
id|prio
op_or_assign
l_int|2
suffix:semicolon
id|h
op_xor_assign
id|HASH
c_func
(paren
id|remote
)paren
suffix:semicolon
)brace
r_return
op_amp
id|tunnels
(braket
id|prio
)braket
(braket
id|h
)braket
suffix:semicolon
)brace
DECL|function|ipgre_tunnel_link
r_static
r_void
id|ipgre_tunnel_link
c_func
(paren
r_struct
id|ip_tunnel
op_star
id|t
)paren
(brace
r_struct
id|ip_tunnel
op_star
op_star
id|tp
op_assign
id|ipgre_bucket
c_func
(paren
id|t
)paren
suffix:semicolon
id|t-&gt;next
op_assign
op_star
id|tp
suffix:semicolon
id|write_lock_bh
c_func
(paren
op_amp
id|ipgre_lock
)paren
suffix:semicolon
op_star
id|tp
op_assign
id|t
suffix:semicolon
id|write_unlock_bh
c_func
(paren
op_amp
id|ipgre_lock
)paren
suffix:semicolon
)brace
DECL|function|ipgre_tunnel_unlink
r_static
r_void
id|ipgre_tunnel_unlink
c_func
(paren
r_struct
id|ip_tunnel
op_star
id|t
)paren
(brace
r_struct
id|ip_tunnel
op_star
op_star
id|tp
suffix:semicolon
r_for
c_loop
(paren
id|tp
op_assign
id|ipgre_bucket
c_func
(paren
id|t
)paren
suffix:semicolon
op_star
id|tp
suffix:semicolon
id|tp
op_assign
op_amp
(paren
op_star
id|tp
)paren
op_member_access_from_pointer
id|next
)paren
(brace
r_if
c_cond
(paren
id|t
op_eq
op_star
id|tp
)paren
(brace
id|write_lock_bh
c_func
(paren
op_amp
id|ipgre_lock
)paren
suffix:semicolon
op_star
id|tp
op_assign
id|t-&gt;next
suffix:semicolon
id|write_unlock_bh
c_func
(paren
op_amp
id|ipgre_lock
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
)brace
DECL|function|ipgre_tunnel_locate
r_static
r_struct
id|ip_tunnel
op_star
id|ipgre_tunnel_locate
c_func
(paren
r_struct
id|ip_tunnel_parm
op_star
id|parms
comma
r_int
id|create
)paren
(brace
id|u32
id|remote
op_assign
id|parms-&gt;iph.daddr
suffix:semicolon
id|u32
id|local
op_assign
id|parms-&gt;iph.saddr
suffix:semicolon
id|u32
id|key
op_assign
id|parms-&gt;i_key
suffix:semicolon
r_struct
id|ip_tunnel
op_star
id|t
comma
op_star
op_star
id|tp
comma
op_star
id|nt
suffix:semicolon
r_struct
id|net_device
op_star
id|dev
suffix:semicolon
r_int
id|h
op_assign
id|HASH
c_func
(paren
id|key
)paren
suffix:semicolon
r_int
id|prio
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|local
)paren
id|prio
op_or_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|remote
op_logical_and
op_logical_neg
id|MULTICAST
c_func
(paren
id|remote
)paren
)paren
(brace
id|prio
op_or_assign
l_int|2
suffix:semicolon
id|h
op_xor_assign
id|HASH
c_func
(paren
id|remote
)paren
suffix:semicolon
)brace
r_for
c_loop
(paren
id|tp
op_assign
op_amp
id|tunnels
(braket
id|prio
)braket
(braket
id|h
)braket
suffix:semicolon
(paren
id|t
op_assign
op_star
id|tp
)paren
op_ne
l_int|NULL
suffix:semicolon
id|tp
op_assign
op_amp
id|t-&gt;next
)paren
(brace
r_if
c_cond
(paren
id|local
op_eq
id|t-&gt;parms.iph.saddr
op_logical_and
id|remote
op_eq
id|t-&gt;parms.iph.daddr
)paren
(brace
r_if
c_cond
(paren
id|key
op_eq
id|t-&gt;parms.i_key
)paren
r_return
id|t
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
op_logical_neg
id|create
)paren
r_return
l_int|NULL
suffix:semicolon
id|MOD_INC_USE_COUNT
suffix:semicolon
id|dev
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
op_star
id|dev
)paren
op_plus
r_sizeof
(paren
op_star
id|t
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dev
op_eq
l_int|NULL
)paren
(brace
id|MOD_DEC_USE_COUNT
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
id|memset
c_func
(paren
id|dev
comma
l_int|0
comma
r_sizeof
(paren
op_star
id|dev
)paren
op_plus
r_sizeof
(paren
op_star
id|t
)paren
)paren
suffix:semicolon
id|dev-&gt;priv
op_assign
(paren
r_void
op_star
)paren
(paren
id|dev
op_plus
l_int|1
)paren
suffix:semicolon
id|nt
op_assign
(paren
r_struct
id|ip_tunnel
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|nt-&gt;dev
op_assign
id|dev
suffix:semicolon
id|dev-&gt;init
op_assign
id|ipgre_tunnel_init
suffix:semicolon
id|dev-&gt;features
op_or_assign
id|NETIF_F_DYNALLOC
suffix:semicolon
id|memcpy
c_func
(paren
op_amp
id|nt-&gt;parms
comma
id|parms
comma
r_sizeof
(paren
op_star
id|parms
)paren
)paren
suffix:semicolon
id|strcpy
c_func
(paren
id|dev-&gt;name
comma
id|nt-&gt;parms.name
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;name
(braket
l_int|0
)braket
op_eq
l_int|0
)paren
(brace
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|1
suffix:semicolon
id|i
OL
l_int|100
suffix:semicolon
id|i
op_increment
)paren
(brace
id|sprintf
c_func
(paren
id|dev-&gt;name
comma
l_string|&quot;gre%d&quot;
comma
id|i
)paren
suffix:semicolon
r_if
c_cond
(paren
id|__dev_get_by_name
c_func
(paren
id|dev-&gt;name
)paren
op_eq
l_int|NULL
)paren
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|i
op_eq
l_int|100
)paren
r_goto
id|failed
suffix:semicolon
id|memcpy
c_func
(paren
id|parms-&gt;name
comma
id|dev-&gt;name
comma
id|IFNAMSIZ
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|register_netdevice
c_func
(paren
id|dev
)paren
OL
l_int|0
)paren
r_goto
id|failed
suffix:semicolon
id|dev_hold
c_func
(paren
id|dev
)paren
suffix:semicolon
id|ipgre_tunnel_link
c_func
(paren
id|nt
)paren
suffix:semicolon
multiline_comment|/* Do not decrement MOD_USE_COUNT here. */
r_return
id|nt
suffix:semicolon
id|failed
suffix:colon
id|kfree
c_func
(paren
id|dev
)paren
suffix:semicolon
id|MOD_DEC_USE_COUNT
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
DECL|function|ipgre_tunnel_destructor
r_static
r_void
id|ipgre_tunnel_destructor
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_if
c_cond
(paren
id|dev
op_ne
op_amp
id|ipgre_fb_tunnel_dev
)paren
(brace
id|MOD_DEC_USE_COUNT
suffix:semicolon
)brace
)brace
DECL|function|ipgre_tunnel_uninit
r_static
r_void
id|ipgre_tunnel_uninit
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
id|ipgre_tunnel_unlink
c_func
(paren
(paren
r_struct
id|ip_tunnel
op_star
)paren
id|dev-&gt;priv
)paren
suffix:semicolon
id|dev_put
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
DECL|function|ipgre_err
r_void
id|ipgre_err
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_int
r_char
op_star
id|dp
comma
r_int
id|len
)paren
(brace
macro_line|#ifndef I_WISH_WORLD_WERE_PERFECT
multiline_comment|/* It is not :-( All the routers (except for Linux) return only&n;   8 bytes of packet payload. It means, that precise relaying of&n;   ICMP in the real Internet is absolutely infeasible.&n;&n;   Moreover, Cisco &quot;wise men&quot; put GRE key to the third word&n;   in GRE header. It makes impossible maintaining even soft state for keyed&n;   GRE tunnels with enabled checksum. Tell them &quot;thank you&quot;.&n;&n;   Well, I wonder, rfc1812 was written by Cisco employee,&n;   what the hell these idiots break standrads established&n;   by themself???&n; */
r_struct
id|iphdr
op_star
id|iph
op_assign
(paren
r_struct
id|iphdr
op_star
)paren
id|dp
suffix:semicolon
id|u16
op_star
id|p
op_assign
(paren
id|u16
op_star
)paren
(paren
id|dp
op_plus
(paren
id|iph-&gt;ihl
op_lshift
l_int|2
)paren
)paren
suffix:semicolon
r_int
id|grehlen
op_assign
(paren
id|iph-&gt;ihl
op_lshift
l_int|2
)paren
op_plus
l_int|4
suffix:semicolon
r_int
id|type
op_assign
id|skb-&gt;h.icmph-&gt;type
suffix:semicolon
r_int
id|code
op_assign
id|skb-&gt;h.icmph-&gt;code
suffix:semicolon
r_struct
id|ip_tunnel
op_star
id|t
suffix:semicolon
id|u16
id|flags
suffix:semicolon
id|flags
op_assign
id|p
(braket
l_int|0
)braket
suffix:semicolon
r_if
c_cond
(paren
id|flags
op_amp
(paren
id|GRE_CSUM
op_or
id|GRE_KEY
op_or
id|GRE_SEQ
op_or
id|GRE_ROUTING
op_or
id|GRE_VERSION
)paren
)paren
(brace
r_if
c_cond
(paren
id|flags
op_amp
(paren
id|GRE_VERSION
op_or
id|GRE_ROUTING
)paren
)paren
r_return
suffix:semicolon
r_if
c_cond
(paren
id|flags
op_amp
id|GRE_KEY
)paren
(brace
id|grehlen
op_add_assign
l_int|4
suffix:semicolon
r_if
c_cond
(paren
id|flags
op_amp
id|GRE_CSUM
)paren
id|grehlen
op_add_assign
l_int|4
suffix:semicolon
)brace
)brace
multiline_comment|/* If only 8 bytes returned, keyed message will be dropped here */
r_if
c_cond
(paren
id|len
OL
id|grehlen
)paren
r_return
suffix:semicolon
r_switch
c_cond
(paren
id|type
)paren
(brace
r_default
suffix:colon
r_case
id|ICMP_PARAMETERPROB
suffix:colon
r_return
suffix:semicolon
r_case
id|ICMP_DEST_UNREACH
suffix:colon
r_switch
c_cond
(paren
id|code
)paren
(brace
r_case
id|ICMP_SR_FAILED
suffix:colon
r_case
id|ICMP_PORT_UNREACH
suffix:colon
multiline_comment|/* Impossible event. */
r_return
suffix:semicolon
r_case
id|ICMP_FRAG_NEEDED
suffix:colon
multiline_comment|/* Soft state for pmtu is maintained by IP core. */
r_return
suffix:semicolon
r_default
suffix:colon
multiline_comment|/* All others are translated to HOST_UNREACH.&n;&t;&t;&t;   rfc2003 contains &quot;deep thoughts&quot; about NET_UNREACH,&n;&t;&t;&t;   I believe they are just ether pollution. --ANK&n;&t;&t;&t; */
r_break
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|ICMP_TIME_EXCEEDED
suffix:colon
r_if
c_cond
(paren
id|code
op_ne
id|ICMP_EXC_TTL
)paren
r_return
suffix:semicolon
r_break
suffix:semicolon
)brace
id|read_lock
c_func
(paren
op_amp
id|ipgre_lock
)paren
suffix:semicolon
id|t
op_assign
id|ipgre_tunnel_lookup
c_func
(paren
id|iph-&gt;daddr
comma
id|iph-&gt;saddr
comma
(paren
id|flags
op_amp
id|GRE_KEY
)paren
ques
c_cond
op_star
(paren
(paren
(paren
id|u32
op_star
)paren
id|p
)paren
op_plus
(paren
id|grehlen
op_rshift
l_int|2
)paren
op_minus
l_int|1
)paren
suffix:colon
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|t
op_eq
l_int|NULL
op_logical_or
id|t-&gt;parms.iph.daddr
op_eq
l_int|0
op_logical_or
id|MULTICAST
c_func
(paren
id|t-&gt;parms.iph.daddr
)paren
)paren
r_goto
id|out
suffix:semicolon
r_if
c_cond
(paren
id|t-&gt;parms.iph.ttl
op_eq
l_int|0
op_logical_and
id|type
op_eq
id|ICMP_TIME_EXCEEDED
)paren
r_goto
id|out
suffix:semicolon
r_if
c_cond
(paren
id|jiffies
op_minus
id|t-&gt;err_time
OL
id|IPTUNNEL_ERR_TIMEO
)paren
id|t-&gt;err_count
op_increment
suffix:semicolon
r_else
id|t-&gt;err_count
op_assign
l_int|1
suffix:semicolon
id|t-&gt;err_time
op_assign
id|jiffies
suffix:semicolon
id|out
suffix:colon
id|read_unlock
c_func
(paren
op_amp
id|ipgre_lock
)paren
suffix:semicolon
r_return
suffix:semicolon
macro_line|#else
r_struct
id|iphdr
op_star
id|iph
op_assign
(paren
r_struct
id|iphdr
op_star
)paren
id|dp
suffix:semicolon
r_struct
id|iphdr
op_star
id|eiph
suffix:semicolon
id|u16
op_star
id|p
op_assign
(paren
id|u16
op_star
)paren
(paren
id|dp
op_plus
(paren
id|iph-&gt;ihl
op_lshift
l_int|2
)paren
)paren
suffix:semicolon
r_int
id|type
op_assign
id|skb-&gt;h.icmph-&gt;type
suffix:semicolon
r_int
id|code
op_assign
id|skb-&gt;h.icmph-&gt;code
suffix:semicolon
r_int
id|rel_type
op_assign
l_int|0
suffix:semicolon
r_int
id|rel_code
op_assign
l_int|0
suffix:semicolon
r_int
id|rel_info
op_assign
l_int|0
suffix:semicolon
id|u16
id|flags
suffix:semicolon
r_int
id|grehlen
op_assign
(paren
id|iph-&gt;ihl
op_lshift
l_int|2
)paren
op_plus
l_int|4
suffix:semicolon
r_struct
id|sk_buff
op_star
id|skb2
suffix:semicolon
r_struct
id|rtable
op_star
id|rt
suffix:semicolon
r_if
c_cond
(paren
id|p
(braket
l_int|1
)braket
op_ne
id|__constant_htons
c_func
(paren
id|ETH_P_IP
)paren
)paren
r_return
suffix:semicolon
id|flags
op_assign
id|p
(braket
l_int|0
)braket
suffix:semicolon
r_if
c_cond
(paren
id|flags
op_amp
(paren
id|GRE_CSUM
op_or
id|GRE_KEY
op_or
id|GRE_SEQ
op_or
id|GRE_ROUTING
op_or
id|GRE_VERSION
)paren
)paren
(brace
r_if
c_cond
(paren
id|flags
op_amp
(paren
id|GRE_VERSION
op_or
id|GRE_ROUTING
)paren
)paren
r_return
suffix:semicolon
r_if
c_cond
(paren
id|flags
op_amp
id|GRE_CSUM
)paren
id|grehlen
op_add_assign
l_int|4
suffix:semicolon
r_if
c_cond
(paren
id|flags
op_amp
id|GRE_KEY
)paren
id|grehlen
op_add_assign
l_int|4
suffix:semicolon
r_if
c_cond
(paren
id|flags
op_amp
id|GRE_SEQ
)paren
id|grehlen
op_add_assign
l_int|4
suffix:semicolon
)brace
r_if
c_cond
(paren
id|len
OL
id|grehlen
op_plus
r_sizeof
(paren
r_struct
id|iphdr
)paren
)paren
r_return
suffix:semicolon
id|eiph
op_assign
(paren
r_struct
id|iphdr
op_star
)paren
(paren
id|dp
op_plus
id|grehlen
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|type
)paren
(brace
r_default
suffix:colon
r_return
suffix:semicolon
r_case
id|ICMP_PARAMETERPROB
suffix:colon
r_if
c_cond
(paren
id|skb-&gt;h.icmph-&gt;un.gateway
OL
(paren
id|iph-&gt;ihl
op_lshift
l_int|2
)paren
)paren
r_return
suffix:semicolon
multiline_comment|/* So... This guy found something strange INSIDE encapsulated&n;&t;&t;   packet. Well, he is fool, but what can we do ?&n;&t;&t; */
id|rel_type
op_assign
id|ICMP_PARAMETERPROB
suffix:semicolon
id|rel_info
op_assign
id|skb-&gt;h.icmph-&gt;un.gateway
op_minus
id|grehlen
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ICMP_DEST_UNREACH
suffix:colon
r_switch
c_cond
(paren
id|code
)paren
(brace
r_case
id|ICMP_SR_FAILED
suffix:colon
r_case
id|ICMP_PORT_UNREACH
suffix:colon
multiline_comment|/* Impossible event. */
r_return
suffix:semicolon
r_case
id|ICMP_FRAG_NEEDED
suffix:colon
multiline_comment|/* And it is the only really necesary thing :-) */
id|rel_info
op_assign
id|ntohs
c_func
(paren
id|skb-&gt;h.icmph-&gt;un.frag.mtu
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rel_info
OL
id|grehlen
op_plus
l_int|68
)paren
r_return
suffix:semicolon
id|rel_info
op_sub_assign
id|grehlen
suffix:semicolon
multiline_comment|/* BSD 4.2 MORE DOES NOT EXIST IN NATURE. */
r_if
c_cond
(paren
id|rel_info
OG
id|ntohs
c_func
(paren
id|eiph-&gt;tot_len
)paren
)paren
r_return
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
multiline_comment|/* All others are translated to HOST_UNREACH.&n;&t;&t;&t;   rfc2003 contains &quot;deep thoughts&quot; about NET_UNREACH,&n;&t;&t;&t;   I believe, it is just ether pollution. --ANK&n;&t;&t;&t; */
id|rel_type
op_assign
id|ICMP_DEST_UNREACH
suffix:semicolon
id|rel_code
op_assign
id|ICMP_HOST_UNREACH
suffix:semicolon
r_break
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|ICMP_TIME_EXCEEDED
suffix:colon
r_if
c_cond
(paren
id|code
op_ne
id|ICMP_EXC_TTL
)paren
r_return
suffix:semicolon
r_break
suffix:semicolon
)brace
multiline_comment|/* Prepare fake skb to feed it to icmp_send */
id|skb2
op_assign
id|skb_clone
c_func
(paren
id|skb
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
id|skb2
op_eq
l_int|NULL
)paren
r_return
suffix:semicolon
id|dst_release
c_func
(paren
id|skb2-&gt;dst
)paren
suffix:semicolon
id|skb2-&gt;dst
op_assign
l_int|NULL
suffix:semicolon
id|skb_pull
c_func
(paren
id|skb2
comma
id|skb-&gt;data
op_minus
(paren
id|u8
op_star
)paren
id|eiph
)paren
suffix:semicolon
id|skb2-&gt;nh.raw
op_assign
id|skb2-&gt;data
suffix:semicolon
multiline_comment|/* Try to guess incoming interface */
r_if
c_cond
(paren
id|ip_route_output
c_func
(paren
op_amp
id|rt
comma
id|eiph-&gt;saddr
comma
l_int|0
comma
id|RT_TOS
c_func
(paren
id|eiph-&gt;tos
)paren
comma
l_int|0
)paren
)paren
(brace
id|kfree_skb
c_func
(paren
id|skb2
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|skb2-&gt;dev
op_assign
id|rt-&gt;u.dst.dev
suffix:semicolon
multiline_comment|/* route &quot;incoming&quot; packet */
r_if
c_cond
(paren
id|rt-&gt;rt_flags
op_amp
id|RTCF_LOCAL
)paren
(brace
id|ip_rt_put
c_func
(paren
id|rt
)paren
suffix:semicolon
id|rt
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
id|ip_route_output
c_func
(paren
op_amp
id|rt
comma
id|eiph-&gt;daddr
comma
id|eiph-&gt;saddr
comma
id|eiph-&gt;tos
comma
l_int|0
)paren
op_logical_or
id|rt-&gt;u.dst.dev-&gt;type
op_ne
id|ARPHRD_IPGRE
)paren
(brace
id|ip_rt_put
c_func
(paren
id|rt
)paren
suffix:semicolon
id|kfree_skb
c_func
(paren
id|skb2
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
)brace
r_else
(brace
id|ip_rt_put
c_func
(paren
id|rt
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ip_route_input
c_func
(paren
id|skb2
comma
id|eiph-&gt;daddr
comma
id|eiph-&gt;saddr
comma
id|eiph-&gt;tos
comma
id|skb2-&gt;dev
)paren
op_logical_or
id|skb2-&gt;dst-&gt;dev-&gt;type
op_ne
id|ARPHRD_IPGRE
)paren
(brace
id|kfree_skb
c_func
(paren
id|skb2
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
)brace
multiline_comment|/* change mtu on this route */
r_if
c_cond
(paren
id|type
op_eq
id|ICMP_DEST_UNREACH
op_logical_and
id|code
op_eq
id|ICMP_FRAG_NEEDED
)paren
(brace
r_if
c_cond
(paren
id|rel_info
OG
id|skb2-&gt;dst-&gt;pmtu
)paren
(brace
id|kfree_skb
c_func
(paren
id|skb2
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|skb2-&gt;dst-&gt;pmtu
op_assign
id|rel_info
suffix:semicolon
id|rel_info
op_assign
id|htonl
c_func
(paren
id|rel_info
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|type
op_eq
id|ICMP_TIME_EXCEEDED
)paren
(brace
r_struct
id|ip_tunnel
op_star
id|t
op_assign
(paren
r_struct
id|ip_tunnel
op_star
)paren
id|skb2-&gt;dev-&gt;priv
suffix:semicolon
r_if
c_cond
(paren
id|t-&gt;parms.iph.ttl
)paren
(brace
id|rel_type
op_assign
id|ICMP_DEST_UNREACH
suffix:semicolon
id|rel_code
op_assign
id|ICMP_HOST_UNREACH
suffix:semicolon
)brace
)brace
id|icmp_send
c_func
(paren
id|skb2
comma
id|rel_type
comma
id|rel_code
comma
id|rel_info
)paren
suffix:semicolon
id|kfree_skb
c_func
(paren
id|skb2
)paren
suffix:semicolon
macro_line|#endif
)brace
DECL|function|ipgre_ecn_decapsulate
r_static
r_inline
r_void
id|ipgre_ecn_decapsulate
c_func
(paren
r_struct
id|iphdr
op_star
id|iph
comma
r_struct
id|sk_buff
op_star
id|skb
)paren
(brace
r_if
c_cond
(paren
id|INET_ECN_is_ce
c_func
(paren
id|iph-&gt;tos
)paren
)paren
(brace
r_if
c_cond
(paren
id|skb-&gt;protocol
op_eq
id|__constant_htons
c_func
(paren
id|ETH_P_IP
)paren
)paren
(brace
r_if
c_cond
(paren
id|INET_ECN_is_not_ce
c_func
(paren
id|skb-&gt;nh.iph-&gt;tos
)paren
)paren
id|IP_ECN_set_ce
c_func
(paren
id|skb-&gt;nh.iph
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|skb-&gt;protocol
op_eq
id|__constant_htons
c_func
(paren
id|ETH_P_IPV6
)paren
)paren
(brace
r_if
c_cond
(paren
id|INET_ECN_is_not_ce
c_func
(paren
id|ip6_get_dsfield
c_func
(paren
id|skb-&gt;nh.ipv6h
)paren
)paren
)paren
id|IP6_ECN_set_ce
c_func
(paren
id|skb-&gt;nh.ipv6h
)paren
suffix:semicolon
)brace
)brace
)brace
r_static
r_inline
id|u8
DECL|function|ipgre_ecn_encapsulate
id|ipgre_ecn_encapsulate
c_func
(paren
id|u8
id|tos
comma
r_struct
id|iphdr
op_star
id|old_iph
comma
r_struct
id|sk_buff
op_star
id|skb
)paren
(brace
macro_line|#ifdef CONFIG_INET_ECN
id|u8
id|inner
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|skb-&gt;protocol
op_eq
id|__constant_htons
c_func
(paren
id|ETH_P_IP
)paren
)paren
id|inner
op_assign
id|old_iph-&gt;tos
suffix:semicolon
r_else
r_if
c_cond
(paren
id|skb-&gt;protocol
op_eq
id|__constant_htons
c_func
(paren
id|ETH_P_IPV6
)paren
)paren
id|inner
op_assign
id|ip6_get_dsfield
c_func
(paren
(paren
r_struct
id|ipv6hdr
op_star
)paren
id|old_iph
)paren
suffix:semicolon
r_return
id|INET_ECN_encapsulate
c_func
(paren
id|tos
comma
id|inner
)paren
suffix:semicolon
macro_line|#else
r_return
id|tos
suffix:semicolon
macro_line|#endif
)brace
DECL|function|ipgre_rcv
r_int
id|ipgre_rcv
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_int
r_int
id|len
)paren
(brace
r_struct
id|iphdr
op_star
id|iph
op_assign
id|skb-&gt;nh.iph
suffix:semicolon
id|u8
op_star
id|h
op_assign
id|skb-&gt;h.raw
suffix:semicolon
id|u16
id|flags
op_assign
op_star
(paren
id|u16
op_star
)paren
id|h
suffix:semicolon
id|u16
id|csum
op_assign
l_int|0
suffix:semicolon
id|u32
id|key
op_assign
l_int|0
suffix:semicolon
id|u32
id|seqno
op_assign
l_int|0
suffix:semicolon
r_struct
id|ip_tunnel
op_star
id|tunnel
suffix:semicolon
r_int
id|offset
op_assign
l_int|4
suffix:semicolon
r_if
c_cond
(paren
id|flags
op_amp
(paren
id|GRE_CSUM
op_or
id|GRE_KEY
op_or
id|GRE_ROUTING
op_or
id|GRE_SEQ
op_or
id|GRE_VERSION
)paren
)paren
(brace
multiline_comment|/* - Version must be 0.&n;&t;&t;   - We do not support routing headers.&n;&t;&t; */
r_if
c_cond
(paren
id|flags
op_amp
(paren
id|GRE_VERSION
op_or
id|GRE_ROUTING
)paren
)paren
r_goto
id|drop_nolock
suffix:semicolon
r_if
c_cond
(paren
id|flags
op_amp
id|GRE_CSUM
)paren
(brace
id|csum
op_assign
id|ip_compute_csum
c_func
(paren
id|h
comma
id|len
)paren
suffix:semicolon
id|offset
op_add_assign
l_int|4
suffix:semicolon
)brace
r_if
c_cond
(paren
id|flags
op_amp
id|GRE_KEY
)paren
(brace
id|key
op_assign
op_star
(paren
id|u32
op_star
)paren
(paren
id|h
op_plus
id|offset
)paren
suffix:semicolon
id|offset
op_add_assign
l_int|4
suffix:semicolon
)brace
r_if
c_cond
(paren
id|flags
op_amp
id|GRE_SEQ
)paren
(brace
id|seqno
op_assign
id|ntohl
c_func
(paren
op_star
(paren
id|u32
op_star
)paren
(paren
id|h
op_plus
id|offset
)paren
)paren
suffix:semicolon
id|offset
op_add_assign
l_int|4
suffix:semicolon
)brace
)brace
id|read_lock
c_func
(paren
op_amp
id|ipgre_lock
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|tunnel
op_assign
id|ipgre_tunnel_lookup
c_func
(paren
id|iph-&gt;saddr
comma
id|iph-&gt;daddr
comma
id|key
)paren
)paren
op_ne
l_int|NULL
)paren
(brace
id|skb-&gt;mac.raw
op_assign
id|skb-&gt;nh.raw
suffix:semicolon
id|skb-&gt;nh.raw
op_assign
id|skb_pull
c_func
(paren
id|skb
comma
id|h
op_plus
id|offset
op_minus
id|skb-&gt;data
)paren
suffix:semicolon
id|memset
c_func
(paren
op_amp
(paren
id|IPCB
c_func
(paren
id|skb
)paren
op_member_access_from_pointer
id|opt
)paren
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|ip_options
)paren
)paren
suffix:semicolon
id|skb-&gt;ip_summed
op_assign
l_int|0
suffix:semicolon
id|skb-&gt;protocol
op_assign
op_star
(paren
id|u16
op_star
)paren
(paren
id|h
op_plus
l_int|2
)paren
suffix:semicolon
id|skb-&gt;pkt_type
op_assign
id|PACKET_HOST
suffix:semicolon
macro_line|#ifdef CONFIG_NET_IPGRE_BROADCAST
r_if
c_cond
(paren
id|MULTICAST
c_func
(paren
id|iph-&gt;daddr
)paren
)paren
(brace
multiline_comment|/* Looped back packet, drop it! */
r_if
c_cond
(paren
(paren
(paren
r_struct
id|rtable
op_star
)paren
id|skb-&gt;dst
)paren
op_member_access_from_pointer
id|key.iif
op_eq
l_int|0
)paren
r_goto
id|drop
suffix:semicolon
id|tunnel-&gt;stat.multicast
op_increment
suffix:semicolon
id|skb-&gt;pkt_type
op_assign
id|PACKET_BROADCAST
suffix:semicolon
)brace
macro_line|#endif
r_if
c_cond
(paren
(paren
(paren
id|flags
op_amp
id|GRE_CSUM
)paren
op_logical_and
id|csum
)paren
op_logical_or
(paren
op_logical_neg
(paren
id|flags
op_amp
id|GRE_CSUM
)paren
op_logical_and
id|tunnel-&gt;parms.i_flags
op_amp
id|GRE_CSUM
)paren
)paren
(brace
id|tunnel-&gt;stat.rx_crc_errors
op_increment
suffix:semicolon
id|tunnel-&gt;stat.rx_errors
op_increment
suffix:semicolon
r_goto
id|drop
suffix:semicolon
)brace
r_if
c_cond
(paren
id|tunnel-&gt;parms.i_flags
op_amp
id|GRE_SEQ
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|flags
op_amp
id|GRE_SEQ
)paren
op_logical_or
(paren
id|tunnel-&gt;i_seqno
op_logical_and
(paren
id|s32
)paren
(paren
id|seqno
op_minus
id|tunnel-&gt;i_seqno
)paren
OL
l_int|0
)paren
)paren
(brace
id|tunnel-&gt;stat.rx_fifo_errors
op_increment
suffix:semicolon
id|tunnel-&gt;stat.rx_errors
op_increment
suffix:semicolon
r_goto
id|drop
suffix:semicolon
)brace
id|tunnel-&gt;i_seqno
op_assign
id|seqno
op_plus
l_int|1
suffix:semicolon
)brace
id|tunnel-&gt;stat.rx_packets
op_increment
suffix:semicolon
id|tunnel-&gt;stat.rx_bytes
op_add_assign
id|skb-&gt;len
suffix:semicolon
id|skb-&gt;dev
op_assign
id|tunnel-&gt;dev
suffix:semicolon
id|dst_release
c_func
(paren
id|skb-&gt;dst
)paren
suffix:semicolon
id|skb-&gt;dst
op_assign
l_int|NULL
suffix:semicolon
macro_line|#ifdef CONFIG_NETFILTER
id|nf_conntrack_put
c_func
(paren
id|skb-&gt;nfct
)paren
suffix:semicolon
id|skb-&gt;nfct
op_assign
l_int|NULL
suffix:semicolon
macro_line|#ifdef CONFIG_NETFILTER_DEBUG
id|skb-&gt;nf_debug
op_assign
l_int|0
suffix:semicolon
macro_line|#endif
macro_line|#endif
id|ipgre_ecn_decapsulate
c_func
(paren
id|iph
comma
id|skb
)paren
suffix:semicolon
id|netif_rx
c_func
(paren
id|skb
)paren
suffix:semicolon
id|read_unlock
c_func
(paren
op_amp
id|ipgre_lock
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|icmp_send
c_func
(paren
id|skb
comma
id|ICMP_DEST_UNREACH
comma
id|ICMP_PROT_UNREACH
comma
l_int|0
)paren
suffix:semicolon
id|drop
suffix:colon
id|read_unlock
c_func
(paren
op_amp
id|ipgre_lock
)paren
suffix:semicolon
id|drop_nolock
suffix:colon
id|kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Need this wrapper because NF_HOOK takes the function address */
DECL|function|do_ip_send
r_static
r_inline
r_int
id|do_ip_send
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
)paren
(brace
r_return
id|ip_send
c_func
(paren
id|skb
)paren
suffix:semicolon
)brace
DECL|function|ipgre_tunnel_xmit
r_static
r_int
id|ipgre_tunnel_xmit
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|ip_tunnel
op_star
id|tunnel
op_assign
(paren
r_struct
id|ip_tunnel
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_struct
id|net_device_stats
op_star
id|stats
op_assign
op_amp
id|tunnel-&gt;stat
suffix:semicolon
r_struct
id|iphdr
op_star
id|old_iph
op_assign
id|skb-&gt;nh.iph
suffix:semicolon
r_struct
id|iphdr
op_star
id|tiph
suffix:semicolon
id|u8
id|tos
suffix:semicolon
id|u16
id|df
suffix:semicolon
r_struct
id|rtable
op_star
id|rt
suffix:semicolon
multiline_comment|/* Route to the other host */
r_struct
id|net_device
op_star
id|tdev
suffix:semicolon
multiline_comment|/* Device to other host */
r_struct
id|iphdr
op_star
id|iph
suffix:semicolon
multiline_comment|/* Our new IP header */
r_int
id|max_headroom
suffix:semicolon
multiline_comment|/* The extra header space needed */
r_int
id|gre_hlen
suffix:semicolon
id|u32
id|dst
suffix:semicolon
r_int
id|mtu
suffix:semicolon
r_if
c_cond
(paren
id|tunnel-&gt;recursion
op_increment
)paren
(brace
id|tunnel-&gt;stat.collisions
op_increment
suffix:semicolon
r_goto
id|tx_error
suffix:semicolon
)brace
r_if
c_cond
(paren
id|dev-&gt;hard_header
)paren
(brace
id|gre_hlen
op_assign
l_int|0
suffix:semicolon
id|tiph
op_assign
(paren
r_struct
id|iphdr
op_star
)paren
id|skb-&gt;data
suffix:semicolon
)brace
r_else
(brace
id|gre_hlen
op_assign
id|tunnel-&gt;hlen
suffix:semicolon
id|tiph
op_assign
op_amp
id|tunnel-&gt;parms.iph
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|dst
op_assign
id|tiph-&gt;daddr
)paren
op_eq
l_int|0
)paren
(brace
multiline_comment|/* NBMA tunnel */
r_if
c_cond
(paren
id|skb-&gt;dst
op_eq
l_int|NULL
)paren
(brace
id|tunnel-&gt;stat.tx_fifo_errors
op_increment
suffix:semicolon
r_goto
id|tx_error
suffix:semicolon
)brace
r_if
c_cond
(paren
id|skb-&gt;protocol
op_eq
id|__constant_htons
c_func
(paren
id|ETH_P_IP
)paren
)paren
(brace
id|rt
op_assign
(paren
r_struct
id|rtable
op_star
)paren
id|skb-&gt;dst
suffix:semicolon
r_if
c_cond
(paren
(paren
id|dst
op_assign
id|rt-&gt;rt_gateway
)paren
op_eq
l_int|0
)paren
r_goto
id|tx_error_icmp
suffix:semicolon
)brace
macro_line|#ifdef CONFIG_IPV6
r_else
r_if
c_cond
(paren
id|skb-&gt;protocol
op_eq
id|__constant_htons
c_func
(paren
id|ETH_P_IPV6
)paren
)paren
(brace
r_struct
id|in6_addr
op_star
id|addr6
suffix:semicolon
r_int
id|addr_type
suffix:semicolon
r_struct
id|neighbour
op_star
id|neigh
op_assign
id|skb-&gt;dst-&gt;neighbour
suffix:semicolon
r_if
c_cond
(paren
id|neigh
op_eq
l_int|NULL
)paren
r_goto
id|tx_error
suffix:semicolon
id|addr6
op_assign
(paren
r_struct
id|in6_addr
op_star
)paren
op_amp
id|neigh-&gt;primary_key
suffix:semicolon
id|addr_type
op_assign
id|ipv6_addr_type
c_func
(paren
id|addr6
)paren
suffix:semicolon
r_if
c_cond
(paren
id|addr_type
op_eq
id|IPV6_ADDR_ANY
)paren
(brace
id|addr6
op_assign
op_amp
id|skb-&gt;nh.ipv6h-&gt;daddr
suffix:semicolon
id|addr_type
op_assign
id|ipv6_addr_type
c_func
(paren
id|addr6
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|addr_type
op_amp
id|IPV6_ADDR_COMPATv4
)paren
op_eq
l_int|0
)paren
r_goto
id|tx_error_icmp
suffix:semicolon
id|dst
op_assign
id|addr6-&gt;s6_addr32
(braket
l_int|3
)braket
suffix:semicolon
)brace
macro_line|#endif
r_else
r_goto
id|tx_error
suffix:semicolon
)brace
id|tos
op_assign
id|tiph-&gt;tos
suffix:semicolon
r_if
c_cond
(paren
id|tos
op_amp
l_int|1
)paren
(brace
r_if
c_cond
(paren
id|skb-&gt;protocol
op_eq
id|__constant_htons
c_func
(paren
id|ETH_P_IP
)paren
)paren
id|tos
op_assign
id|old_iph-&gt;tos
suffix:semicolon
id|tos
op_and_assign
op_complement
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ip_route_output
c_func
(paren
op_amp
id|rt
comma
id|dst
comma
id|tiph-&gt;saddr
comma
id|RT_TOS
c_func
(paren
id|tos
)paren
comma
id|tunnel-&gt;parms.link
)paren
)paren
(brace
id|tunnel-&gt;stat.tx_carrier_errors
op_increment
suffix:semicolon
r_goto
id|tx_error
suffix:semicolon
)brace
id|tdev
op_assign
id|rt-&gt;u.dst.dev
suffix:semicolon
r_if
c_cond
(paren
id|tdev
op_eq
id|dev
)paren
(brace
id|ip_rt_put
c_func
(paren
id|rt
)paren
suffix:semicolon
id|tunnel-&gt;stat.collisions
op_increment
suffix:semicolon
r_goto
id|tx_error
suffix:semicolon
)brace
id|df
op_assign
id|tiph-&gt;frag_off
suffix:semicolon
id|mtu
op_assign
id|rt-&gt;u.dst.pmtu
op_minus
id|tunnel-&gt;hlen
suffix:semicolon
r_if
c_cond
(paren
id|skb-&gt;protocol
op_eq
id|__constant_htons
c_func
(paren
id|ETH_P_IP
)paren
)paren
(brace
r_if
c_cond
(paren
id|skb-&gt;dst
op_logical_and
id|mtu
OL
id|skb-&gt;dst-&gt;pmtu
op_logical_and
id|mtu
op_ge
l_int|68
)paren
id|skb-&gt;dst-&gt;pmtu
op_assign
id|mtu
suffix:semicolon
id|df
op_or_assign
(paren
id|old_iph-&gt;frag_off
op_amp
id|__constant_htons
c_func
(paren
id|IP_DF
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|old_iph-&gt;frag_off
op_amp
id|__constant_htons
c_func
(paren
id|IP_DF
)paren
)paren
op_logical_and
id|mtu
OL
id|ntohs
c_func
(paren
id|old_iph-&gt;tot_len
)paren
)paren
(brace
id|icmp_send
c_func
(paren
id|skb
comma
id|ICMP_DEST_UNREACH
comma
id|ICMP_FRAG_NEEDED
comma
id|htonl
c_func
(paren
id|mtu
)paren
)paren
suffix:semicolon
id|ip_rt_put
c_func
(paren
id|rt
)paren
suffix:semicolon
r_goto
id|tx_error
suffix:semicolon
)brace
)brace
macro_line|#ifdef CONFIG_IPV6
r_else
r_if
c_cond
(paren
id|skb-&gt;protocol
op_eq
id|__constant_htons
c_func
(paren
id|ETH_P_IPV6
)paren
)paren
(brace
r_struct
id|rt6_info
op_star
id|rt6
op_assign
(paren
r_struct
id|rt6_info
op_star
)paren
id|skb-&gt;dst
suffix:semicolon
r_if
c_cond
(paren
id|rt6
op_logical_and
id|mtu
OL
id|rt6-&gt;u.dst.pmtu
op_logical_and
id|mtu
op_ge
id|IPV6_MIN_MTU
)paren
(brace
r_if
c_cond
(paren
(paren
id|tunnel-&gt;parms.iph.daddr
op_logical_and
op_logical_neg
id|MULTICAST
c_func
(paren
id|tunnel-&gt;parms.iph.daddr
)paren
)paren
op_logical_or
id|rt6-&gt;rt6i_dst.plen
op_eq
l_int|128
)paren
(brace
id|rt6-&gt;rt6i_flags
op_or_assign
id|RTF_MODIFIED
suffix:semicolon
id|skb-&gt;dst-&gt;pmtu
op_assign
id|mtu
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|mtu
op_ge
id|IPV6_MIN_MTU
op_logical_and
id|mtu
OL
id|skb-&gt;len
op_minus
id|tunnel-&gt;hlen
op_plus
id|gre_hlen
)paren
(brace
id|icmpv6_send
c_func
(paren
id|skb
comma
id|ICMPV6_PKT_TOOBIG
comma
l_int|0
comma
id|mtu
comma
id|dev
)paren
suffix:semicolon
id|ip_rt_put
c_func
(paren
id|rt
)paren
suffix:semicolon
r_goto
id|tx_error
suffix:semicolon
)brace
)brace
macro_line|#endif
r_if
c_cond
(paren
id|tunnel-&gt;err_count
OG
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|jiffies
op_minus
id|tunnel-&gt;err_time
OL
id|IPTUNNEL_ERR_TIMEO
)paren
(brace
id|tunnel-&gt;err_count
op_decrement
suffix:semicolon
id|dst_link_failure
c_func
(paren
id|skb
)paren
suffix:semicolon
)brace
r_else
id|tunnel-&gt;err_count
op_assign
l_int|0
suffix:semicolon
)brace
id|skb-&gt;h.raw
op_assign
id|skb-&gt;nh.raw
suffix:semicolon
id|max_headroom
op_assign
(paren
(paren
id|tdev-&gt;hard_header_len
op_plus
l_int|15
)paren
op_amp
op_complement
l_int|15
)paren
op_plus
id|gre_hlen
suffix:semicolon
r_if
c_cond
(paren
id|skb_headroom
c_func
(paren
id|skb
)paren
OL
id|max_headroom
op_logical_or
id|skb_cloned
c_func
(paren
id|skb
)paren
op_logical_or
id|skb_shared
c_func
(paren
id|skb
)paren
)paren
(brace
r_struct
id|sk_buff
op_star
id|new_skb
op_assign
id|skb_realloc_headroom
c_func
(paren
id|skb
comma
id|max_headroom
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|new_skb
)paren
(brace
id|ip_rt_put
c_func
(paren
id|rt
)paren
suffix:semicolon
id|stats-&gt;tx_dropped
op_increment
suffix:semicolon
id|dev_kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
id|tunnel-&gt;recursion
op_decrement
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|skb-&gt;sk
)paren
id|skb_set_owner_w
c_func
(paren
id|new_skb
comma
id|skb-&gt;sk
)paren
suffix:semicolon
id|dev_kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
id|skb
op_assign
id|new_skb
suffix:semicolon
)brace
id|skb-&gt;nh.raw
op_assign
id|skb_push
c_func
(paren
id|skb
comma
id|gre_hlen
)paren
suffix:semicolon
id|memset
c_func
(paren
op_amp
(paren
id|IPCB
c_func
(paren
id|skb
)paren
op_member_access_from_pointer
id|opt
)paren
comma
l_int|0
comma
r_sizeof
(paren
id|IPCB
c_func
(paren
id|skb
)paren
op_member_access_from_pointer
id|opt
)paren
)paren
suffix:semicolon
id|dst_release
c_func
(paren
id|skb-&gt;dst
)paren
suffix:semicolon
id|skb-&gt;dst
op_assign
op_amp
id|rt-&gt;u.dst
suffix:semicolon
multiline_comment|/*&n;&t; *&t;Push down and install the IPIP header.&n;&t; */
id|iph
op_assign
id|skb-&gt;nh.iph
suffix:semicolon
id|iph-&gt;version
op_assign
l_int|4
suffix:semicolon
id|iph-&gt;ihl
op_assign
r_sizeof
(paren
r_struct
id|iphdr
)paren
op_rshift
l_int|2
suffix:semicolon
id|iph-&gt;frag_off
op_assign
id|df
suffix:semicolon
id|iph-&gt;protocol
op_assign
id|IPPROTO_GRE
suffix:semicolon
id|iph-&gt;tos
op_assign
id|ipgre_ecn_encapsulate
c_func
(paren
id|tos
comma
id|old_iph
comma
id|skb
)paren
suffix:semicolon
id|iph-&gt;daddr
op_assign
id|rt-&gt;rt_dst
suffix:semicolon
id|iph-&gt;saddr
op_assign
id|rt-&gt;rt_src
suffix:semicolon
r_if
c_cond
(paren
(paren
id|iph-&gt;ttl
op_assign
id|tiph-&gt;ttl
)paren
op_eq
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|skb-&gt;protocol
op_eq
id|__constant_htons
c_func
(paren
id|ETH_P_IP
)paren
)paren
id|iph-&gt;ttl
op_assign
id|old_iph-&gt;ttl
suffix:semicolon
macro_line|#ifdef CONFIG_IPV6
r_else
r_if
c_cond
(paren
id|skb-&gt;protocol
op_eq
id|__constant_htons
c_func
(paren
id|ETH_P_IPV6
)paren
)paren
id|iph-&gt;ttl
op_assign
(paren
(paren
r_struct
id|ipv6hdr
op_star
)paren
id|old_iph
)paren
op_member_access_from_pointer
id|hop_limit
suffix:semicolon
macro_line|#endif
r_else
id|iph-&gt;ttl
op_assign
id|sysctl_ip_default_ttl
suffix:semicolon
)brace
(paren
(paren
id|u16
op_star
)paren
(paren
id|iph
op_plus
l_int|1
)paren
)paren
(braket
l_int|0
)braket
op_assign
id|tunnel-&gt;parms.o_flags
suffix:semicolon
(paren
(paren
id|u16
op_star
)paren
(paren
id|iph
op_plus
l_int|1
)paren
)paren
(braket
l_int|1
)braket
op_assign
id|skb-&gt;protocol
suffix:semicolon
r_if
c_cond
(paren
id|tunnel-&gt;parms.o_flags
op_amp
(paren
id|GRE_KEY
op_or
id|GRE_CSUM
op_or
id|GRE_SEQ
)paren
)paren
(brace
id|u32
op_star
id|ptr
op_assign
(paren
id|u32
op_star
)paren
(paren
(paren
(paren
id|u8
op_star
)paren
id|iph
)paren
op_plus
id|tunnel-&gt;hlen
op_minus
l_int|4
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tunnel-&gt;parms.o_flags
op_amp
id|GRE_SEQ
)paren
(brace
op_increment
id|tunnel-&gt;o_seqno
suffix:semicolon
op_star
id|ptr
op_assign
id|htonl
c_func
(paren
id|tunnel-&gt;o_seqno
)paren
suffix:semicolon
id|ptr
op_decrement
suffix:semicolon
)brace
r_if
c_cond
(paren
id|tunnel-&gt;parms.o_flags
op_amp
id|GRE_KEY
)paren
(brace
op_star
id|ptr
op_assign
id|tunnel-&gt;parms.o_key
suffix:semicolon
id|ptr
op_decrement
suffix:semicolon
)brace
r_if
c_cond
(paren
id|tunnel-&gt;parms.o_flags
op_amp
id|GRE_CSUM
)paren
(brace
op_star
id|ptr
op_assign
l_int|0
suffix:semicolon
op_star
(paren
id|__u16
op_star
)paren
id|ptr
op_assign
id|ip_compute_csum
c_func
(paren
(paren
r_void
op_star
)paren
(paren
id|iph
op_plus
l_int|1
)paren
comma
id|skb-&gt;len
op_minus
r_sizeof
(paren
r_struct
id|iphdr
)paren
)paren
suffix:semicolon
)brace
)brace
macro_line|#ifdef CONFIG_NETFILTER
id|nf_conntrack_put
c_func
(paren
id|skb-&gt;nfct
)paren
suffix:semicolon
id|skb-&gt;nfct
op_assign
l_int|NULL
suffix:semicolon
macro_line|#ifdef CONFIG_NETFILTER_DEBUG
id|skb-&gt;nf_debug
op_assign
l_int|0
suffix:semicolon
macro_line|#endif
macro_line|#endif
id|IPTUNNEL_XMIT
c_func
(paren
)paren
suffix:semicolon
id|tunnel-&gt;recursion
op_decrement
suffix:semicolon
r_return
l_int|0
suffix:semicolon
id|tx_error_icmp
suffix:colon
id|dst_link_failure
c_func
(paren
id|skb
)paren
suffix:semicolon
id|tx_error
suffix:colon
id|stats-&gt;tx_errors
op_increment
suffix:semicolon
id|dev_kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
id|tunnel-&gt;recursion
op_decrement
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_int
DECL|function|ipgre_tunnel_ioctl
id|ipgre_tunnel_ioctl
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_struct
id|ifreq
op_star
id|ifr
comma
r_int
id|cmd
)paren
(brace
r_int
id|err
op_assign
l_int|0
suffix:semicolon
r_struct
id|ip_tunnel_parm
id|p
suffix:semicolon
r_struct
id|ip_tunnel
op_star
id|t
suffix:semicolon
id|MOD_INC_USE_COUNT
suffix:semicolon
r_switch
c_cond
(paren
id|cmd
)paren
(brace
r_case
id|SIOCGETTUNNEL
suffix:colon
id|t
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
id|dev
op_eq
op_amp
id|ipgre_fb_tunnel_dev
)paren
(brace
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|p
comma
id|ifr-&gt;ifr_ifru.ifru_data
comma
r_sizeof
(paren
id|p
)paren
)paren
)paren
(brace
id|err
op_assign
op_minus
id|EFAULT
suffix:semicolon
r_break
suffix:semicolon
)brace
id|t
op_assign
id|ipgre_tunnel_locate
c_func
(paren
op_amp
id|p
comma
l_int|0
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|t
op_eq
l_int|NULL
)paren
id|t
op_assign
(paren
r_struct
id|ip_tunnel
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|memcpy
c_func
(paren
op_amp
id|p
comma
op_amp
id|t-&gt;parms
comma
r_sizeof
(paren
id|p
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
id|ifr-&gt;ifr_ifru.ifru_data
comma
op_amp
id|p
comma
r_sizeof
(paren
id|p
)paren
)paren
)paren
id|err
op_assign
op_minus
id|EFAULT
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SIOCADDTUNNEL
suffix:colon
r_case
id|SIOCCHGTUNNEL
suffix:colon
id|err
op_assign
op_minus
id|EPERM
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|capable
c_func
(paren
id|CAP_NET_ADMIN
)paren
)paren
r_goto
id|done
suffix:semicolon
id|err
op_assign
op_minus
id|EFAULT
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|p
comma
id|ifr-&gt;ifr_ifru.ifru_data
comma
r_sizeof
(paren
id|p
)paren
)paren
)paren
r_goto
id|done
suffix:semicolon
id|err
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|p.iph.version
op_ne
l_int|4
op_logical_or
id|p.iph.protocol
op_ne
id|IPPROTO_GRE
op_logical_or
id|p.iph.ihl
op_ne
l_int|5
op_logical_or
(paren
id|p.iph.frag_off
op_amp
id|__constant_htons
c_func
(paren
op_complement
id|IP_DF
)paren
)paren
op_logical_or
(paren
(paren
id|p.i_flags
op_or
id|p.o_flags
)paren
op_amp
(paren
id|GRE_VERSION
op_or
id|GRE_ROUTING
)paren
)paren
)paren
r_goto
id|done
suffix:semicolon
r_if
c_cond
(paren
id|p.iph.ttl
)paren
id|p.iph.frag_off
op_or_assign
id|__constant_htons
c_func
(paren
id|IP_DF
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|p.i_flags
op_amp
id|GRE_KEY
)paren
)paren
id|p.i_key
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|p.o_flags
op_amp
id|GRE_KEY
)paren
)paren
id|p.o_key
op_assign
l_int|0
suffix:semicolon
id|t
op_assign
id|ipgre_tunnel_locate
c_func
(paren
op_amp
id|p
comma
id|cmd
op_eq
id|SIOCADDTUNNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dev
op_ne
op_amp
id|ipgre_fb_tunnel_dev
op_logical_and
id|cmd
op_eq
id|SIOCCHGTUNNEL
op_logical_and
id|t
op_ne
op_amp
id|ipgre_fb_tunnel
)paren
(brace
r_if
c_cond
(paren
id|t
op_ne
l_int|NULL
)paren
(brace
r_if
c_cond
(paren
id|t-&gt;dev
op_ne
id|dev
)paren
(brace
id|err
op_assign
op_minus
id|EEXIST
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
r_else
(brace
r_int
id|nflags
op_assign
l_int|0
suffix:semicolon
id|t
op_assign
(paren
r_struct
id|ip_tunnel
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_if
c_cond
(paren
id|MULTICAST
c_func
(paren
id|p.iph.daddr
)paren
)paren
id|nflags
op_assign
id|IFF_BROADCAST
suffix:semicolon
r_else
r_if
c_cond
(paren
id|p.iph.daddr
)paren
id|nflags
op_assign
id|IFF_POINTOPOINT
suffix:semicolon
r_if
c_cond
(paren
(paren
id|dev-&gt;flags
op_xor
id|nflags
)paren
op_amp
(paren
id|IFF_POINTOPOINT
op_or
id|IFF_BROADCAST
)paren
)paren
(brace
id|err
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_break
suffix:semicolon
)brace
id|ipgre_tunnel_unlink
c_func
(paren
id|t
)paren
suffix:semicolon
id|t-&gt;parms.iph.saddr
op_assign
id|p.iph.saddr
suffix:semicolon
id|t-&gt;parms.iph.daddr
op_assign
id|p.iph.daddr
suffix:semicolon
id|t-&gt;parms.i_key
op_assign
id|p.i_key
suffix:semicolon
id|t-&gt;parms.o_key
op_assign
id|p.o_key
suffix:semicolon
id|memcpy
c_func
(paren
id|dev-&gt;dev_addr
comma
op_amp
id|p.iph.saddr
comma
l_int|4
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|dev-&gt;broadcast
comma
op_amp
id|p.iph.daddr
comma
l_int|4
)paren
suffix:semicolon
id|ipgre_tunnel_link
c_func
(paren
id|t
)paren
suffix:semicolon
id|netdev_state_change
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|t
)paren
(brace
id|err
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|cmd
op_eq
id|SIOCCHGTUNNEL
)paren
(brace
id|t-&gt;parms.iph.ttl
op_assign
id|p.iph.ttl
suffix:semicolon
id|t-&gt;parms.iph.tos
op_assign
id|p.iph.tos
suffix:semicolon
id|t-&gt;parms.iph.frag_off
op_assign
id|p.iph.frag_off
suffix:semicolon
)brace
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
id|ifr-&gt;ifr_ifru.ifru_data
comma
op_amp
id|t-&gt;parms
comma
r_sizeof
(paren
id|p
)paren
)paren
)paren
id|err
op_assign
op_minus
id|EFAULT
suffix:semicolon
)brace
r_else
id|err
op_assign
(paren
id|cmd
op_eq
id|SIOCADDTUNNEL
ques
c_cond
op_minus
id|ENOBUFS
suffix:colon
op_minus
id|ENOENT
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SIOCDELTUNNEL
suffix:colon
id|err
op_assign
op_minus
id|EPERM
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|capable
c_func
(paren
id|CAP_NET_ADMIN
)paren
)paren
r_goto
id|done
suffix:semicolon
r_if
c_cond
(paren
id|dev
op_eq
op_amp
id|ipgre_fb_tunnel_dev
)paren
(brace
id|err
op_assign
op_minus
id|EFAULT
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|p
comma
id|ifr-&gt;ifr_ifru.ifru_data
comma
r_sizeof
(paren
id|p
)paren
)paren
)paren
r_goto
id|done
suffix:semicolon
id|err
op_assign
op_minus
id|ENOENT
suffix:semicolon
r_if
c_cond
(paren
(paren
id|t
op_assign
id|ipgre_tunnel_locate
c_func
(paren
op_amp
id|p
comma
l_int|0
)paren
)paren
op_eq
l_int|NULL
)paren
r_goto
id|done
suffix:semicolon
id|err
op_assign
op_minus
id|EPERM
suffix:semicolon
r_if
c_cond
(paren
id|t
op_eq
op_amp
id|ipgre_fb_tunnel
)paren
r_goto
id|done
suffix:semicolon
)brace
id|err
op_assign
id|unregister_netdevice
c_func
(paren
id|dev
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|err
op_assign
op_minus
id|EINVAL
suffix:semicolon
)brace
id|done
suffix:colon
id|MOD_DEC_USE_COUNT
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
DECL|function|ipgre_tunnel_get_stats
r_static
r_struct
id|net_device_stats
op_star
id|ipgre_tunnel_get_stats
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_return
op_amp
(paren
(paren
(paren
r_struct
id|ip_tunnel
op_star
)paren
id|dev-&gt;priv
)paren
op_member_access_from_pointer
id|stat
)paren
suffix:semicolon
)brace
DECL|function|ipgre_tunnel_change_mtu
r_static
r_int
id|ipgre_tunnel_change_mtu
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_int
id|new_mtu
)paren
(brace
r_struct
id|ip_tunnel
op_star
id|tunnel
op_assign
(paren
r_struct
id|ip_tunnel
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_if
c_cond
(paren
id|new_mtu
template_param
l_int|0xFFF8
op_minus
id|tunnel-&gt;hlen
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|dev-&gt;mtu
op_assign
id|new_mtu
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#ifdef CONFIG_NET_IPGRE_BROADCAST
multiline_comment|/* Nice toy. Unfortunately, useless in real life :-)&n;   It allows to construct virtual multiprotocol broadcast &quot;LAN&quot;&n;   over the Internet, provided multicast routing is tuned.&n;&n;&n;   I have no idea was this bicycle invented before me,&n;   so that I had to set ARPHRD_IPGRE to a random value.&n;   I have an impression, that Cisco could make something similar,&n;   but this feature is apparently missing in IOS&lt;=11.2(8).&n;   &n;   I set up 10.66.66/24 and fec0:6666:6666::0/96 as virtual networks&n;   with broadcast 224.66.66.66. If you have access to mbone, play with me :-)&n;&n;   ping -t 255 224.66.66.66&n;&n;   If nobody answers, mbone does not work.&n;&n;   ip tunnel add Universe mode gre remote 224.66.66.66 local &lt;Your_real_addr&gt; ttl 255&n;   ip addr add 10.66.66.&lt;somewhat&gt;/24 dev Universe&n;   ifconfig Universe up&n;   ifconfig Universe add fe80::&lt;Your_real_addr&gt;/10&n;   ifconfig Universe add fec0:6666:6666::&lt;Your_real_addr&gt;/96&n;   ftp 10.66.66.66&n;   ...&n;   ftp fec0:6666:6666::193.233.7.65&n;   ...&n;&n; */
DECL|function|ipgre_header
r_static
r_int
id|ipgre_header
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|net_device
op_star
id|dev
comma
r_int
r_int
id|type
comma
r_void
op_star
id|daddr
comma
r_void
op_star
id|saddr
comma
r_int
id|len
)paren
(brace
r_struct
id|ip_tunnel
op_star
id|t
op_assign
(paren
r_struct
id|ip_tunnel
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_struct
id|iphdr
op_star
id|iph
op_assign
(paren
r_struct
id|iphdr
op_star
)paren
id|skb_push
c_func
(paren
id|skb
comma
id|t-&gt;hlen
)paren
suffix:semicolon
id|u16
op_star
id|p
op_assign
(paren
id|u16
op_star
)paren
(paren
id|iph
op_plus
l_int|1
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|iph
comma
op_amp
id|t-&gt;parms.iph
comma
r_sizeof
(paren
r_struct
id|iphdr
)paren
)paren
suffix:semicolon
id|p
(braket
l_int|0
)braket
op_assign
id|t-&gt;parms.o_flags
suffix:semicolon
id|p
(braket
l_int|1
)braket
op_assign
id|htons
c_func
(paren
id|type
)paren
suffix:semicolon
multiline_comment|/*&n;&t; *&t;Set the source hardware address. &n;&t; */
r_if
c_cond
(paren
id|saddr
)paren
id|memcpy
c_func
(paren
op_amp
id|iph-&gt;saddr
comma
id|saddr
comma
l_int|4
)paren
suffix:semicolon
r_if
c_cond
(paren
id|daddr
)paren
(brace
id|memcpy
c_func
(paren
op_amp
id|iph-&gt;daddr
comma
id|daddr
comma
l_int|4
)paren
suffix:semicolon
r_return
id|t-&gt;hlen
suffix:semicolon
)brace
r_if
c_cond
(paren
id|iph-&gt;daddr
op_logical_and
op_logical_neg
id|MULTICAST
c_func
(paren
id|iph-&gt;daddr
)paren
)paren
r_return
id|t-&gt;hlen
suffix:semicolon
r_return
op_minus
id|t-&gt;hlen
suffix:semicolon
)brace
DECL|function|ipgre_open
r_static
r_int
id|ipgre_open
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|ip_tunnel
op_star
id|t
op_assign
(paren
r_struct
id|ip_tunnel
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|MOD_INC_USE_COUNT
suffix:semicolon
r_if
c_cond
(paren
id|MULTICAST
c_func
(paren
id|t-&gt;parms.iph.daddr
)paren
)paren
(brace
r_struct
id|rtable
op_star
id|rt
suffix:semicolon
r_if
c_cond
(paren
id|ip_route_output
c_func
(paren
op_amp
id|rt
comma
id|t-&gt;parms.iph.daddr
comma
id|t-&gt;parms.iph.saddr
comma
id|RT_TOS
c_func
(paren
id|t-&gt;parms.iph.tos
)paren
comma
id|t-&gt;parms.link
)paren
)paren
(brace
id|MOD_DEC_USE_COUNT
suffix:semicolon
r_return
op_minus
id|EADDRNOTAVAIL
suffix:semicolon
)brace
id|dev
op_assign
id|rt-&gt;u.dst.dev
suffix:semicolon
id|ip_rt_put
c_func
(paren
id|rt
)paren
suffix:semicolon
r_if
c_cond
(paren
id|__in_dev_get
c_func
(paren
id|dev
)paren
op_eq
l_int|NULL
)paren
(brace
id|MOD_DEC_USE_COUNT
suffix:semicolon
r_return
op_minus
id|EADDRNOTAVAIL
suffix:semicolon
)brace
id|t-&gt;mlink
op_assign
id|dev-&gt;ifindex
suffix:semicolon
id|ip_mc_inc_group
c_func
(paren
id|__in_dev_get
c_func
(paren
id|dev
)paren
comma
id|t-&gt;parms.iph.daddr
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|ipgre_close
r_static
r_int
id|ipgre_close
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|ip_tunnel
op_star
id|t
op_assign
(paren
r_struct
id|ip_tunnel
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_if
c_cond
(paren
id|MULTICAST
c_func
(paren
id|t-&gt;parms.iph.daddr
)paren
op_logical_and
id|t-&gt;mlink
)paren
(brace
r_struct
id|in_device
op_star
id|in_dev
op_assign
id|inetdev_by_index
c_func
(paren
id|t-&gt;mlink
)paren
suffix:semicolon
r_if
c_cond
(paren
id|in_dev
)paren
(brace
id|ip_mc_dec_group
c_func
(paren
id|in_dev
comma
id|t-&gt;parms.iph.daddr
)paren
suffix:semicolon
id|in_dev_put
c_func
(paren
id|in_dev
)paren
suffix:semicolon
)brace
)brace
id|MOD_DEC_USE_COUNT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#endif
DECL|function|ipgre_tunnel_init_gen
r_static
r_void
id|ipgre_tunnel_init_gen
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|ip_tunnel
op_star
id|t
op_assign
(paren
r_struct
id|ip_tunnel
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|dev-&gt;uninit
op_assign
id|ipgre_tunnel_uninit
suffix:semicolon
id|dev-&gt;destructor
op_assign
id|ipgre_tunnel_destructor
suffix:semicolon
id|dev-&gt;hard_start_xmit
op_assign
id|ipgre_tunnel_xmit
suffix:semicolon
id|dev-&gt;get_stats
op_assign
id|ipgre_tunnel_get_stats
suffix:semicolon
id|dev-&gt;do_ioctl
op_assign
id|ipgre_tunnel_ioctl
suffix:semicolon
id|dev-&gt;change_mtu
op_assign
id|ipgre_tunnel_change_mtu
suffix:semicolon
id|dev_init_buffers
c_func
(paren
id|dev
)paren
suffix:semicolon
id|dev-&gt;type
op_assign
id|ARPHRD_IPGRE
suffix:semicolon
id|dev-&gt;hard_header_len
op_assign
id|LL_MAX_HEADER
op_plus
r_sizeof
(paren
r_struct
id|iphdr
)paren
op_plus
l_int|4
suffix:semicolon
id|dev-&gt;mtu
op_assign
l_int|1500
op_minus
r_sizeof
(paren
r_struct
id|iphdr
)paren
op_minus
l_int|4
suffix:semicolon
id|dev-&gt;flags
op_assign
id|IFF_NOARP
suffix:semicolon
id|dev-&gt;iflink
op_assign
l_int|0
suffix:semicolon
id|dev-&gt;addr_len
op_assign
l_int|4
suffix:semicolon
id|memcpy
c_func
(paren
id|dev-&gt;dev_addr
comma
op_amp
id|t-&gt;parms.iph.saddr
comma
l_int|4
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|dev-&gt;broadcast
comma
op_amp
id|t-&gt;parms.iph.daddr
comma
l_int|4
)paren
suffix:semicolon
)brace
DECL|function|ipgre_tunnel_init
r_static
r_int
id|ipgre_tunnel_init
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|net_device
op_star
id|tdev
op_assign
l_int|NULL
suffix:semicolon
r_struct
id|ip_tunnel
op_star
id|tunnel
suffix:semicolon
r_struct
id|iphdr
op_star
id|iph
suffix:semicolon
r_int
id|hlen
op_assign
id|LL_MAX_HEADER
suffix:semicolon
r_int
id|mtu
op_assign
l_int|1500
suffix:semicolon
r_int
id|addend
op_assign
r_sizeof
(paren
r_struct
id|iphdr
)paren
op_plus
l_int|4
suffix:semicolon
id|tunnel
op_assign
(paren
r_struct
id|ip_tunnel
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|iph
op_assign
op_amp
id|tunnel-&gt;parms.iph
suffix:semicolon
id|ipgre_tunnel_init_gen
c_func
(paren
id|dev
)paren
suffix:semicolon
multiline_comment|/* Guess output device to choose reasonable mtu and hard_header_len */
r_if
c_cond
(paren
id|iph-&gt;daddr
)paren
(brace
r_struct
id|rtable
op_star
id|rt
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ip_route_output
c_func
(paren
op_amp
id|rt
comma
id|iph-&gt;daddr
comma
id|iph-&gt;saddr
comma
id|RT_TOS
c_func
(paren
id|iph-&gt;tos
)paren
comma
id|tunnel-&gt;parms.link
)paren
)paren
(brace
id|tdev
op_assign
id|rt-&gt;u.dst.dev
suffix:semicolon
id|ip_rt_put
c_func
(paren
id|rt
)paren
suffix:semicolon
)brace
id|dev-&gt;flags
op_or_assign
id|IFF_POINTOPOINT
suffix:semicolon
macro_line|#ifdef CONFIG_NET_IPGRE_BROADCAST
r_if
c_cond
(paren
id|MULTICAST
c_func
(paren
id|iph-&gt;daddr
)paren
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|iph-&gt;saddr
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|dev-&gt;flags
op_assign
id|IFF_BROADCAST
suffix:semicolon
id|dev-&gt;hard_header
op_assign
id|ipgre_header
suffix:semicolon
id|dev-&gt;open
op_assign
id|ipgre_open
suffix:semicolon
id|dev-&gt;stop
op_assign
id|ipgre_close
suffix:semicolon
)brace
macro_line|#endif
)brace
r_if
c_cond
(paren
op_logical_neg
id|tdev
op_logical_and
id|tunnel-&gt;parms.link
)paren
id|tdev
op_assign
id|__dev_get_by_index
c_func
(paren
id|tunnel-&gt;parms.link
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tdev
)paren
(brace
id|hlen
op_assign
id|tdev-&gt;hard_header_len
suffix:semicolon
id|mtu
op_assign
id|tdev-&gt;mtu
suffix:semicolon
)brace
id|dev-&gt;iflink
op_assign
id|tunnel-&gt;parms.link
suffix:semicolon
multiline_comment|/* Precalculate GRE options length */
r_if
c_cond
(paren
id|tunnel-&gt;parms.o_flags
op_amp
(paren
id|GRE_CSUM
op_or
id|GRE_KEY
op_or
id|GRE_SEQ
)paren
)paren
(brace
r_if
c_cond
(paren
id|tunnel-&gt;parms.o_flags
op_amp
id|GRE_CSUM
)paren
id|addend
op_add_assign
l_int|4
suffix:semicolon
r_if
c_cond
(paren
id|tunnel-&gt;parms.o_flags
op_amp
id|GRE_KEY
)paren
id|addend
op_add_assign
l_int|4
suffix:semicolon
r_if
c_cond
(paren
id|tunnel-&gt;parms.o_flags
op_amp
id|GRE_SEQ
)paren
id|addend
op_add_assign
l_int|4
suffix:semicolon
)brace
id|dev-&gt;hard_header_len
op_assign
id|hlen
op_plus
id|addend
suffix:semicolon
id|dev-&gt;mtu
op_assign
id|mtu
op_minus
id|addend
suffix:semicolon
id|tunnel-&gt;hlen
op_assign
id|addend
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#ifdef MODULE
DECL|function|ipgre_fb_tunnel_open
r_static
r_int
id|ipgre_fb_tunnel_open
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
id|MOD_INC_USE_COUNT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|ipgre_fb_tunnel_close
r_static
r_int
id|ipgre_fb_tunnel_close
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
id|MOD_DEC_USE_COUNT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#endif
DECL|function|ipgre_fb_tunnel_init
r_int
id|__init
id|ipgre_fb_tunnel_init
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|ip_tunnel
op_star
id|tunnel
op_assign
(paren
r_struct
id|ip_tunnel
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_struct
id|iphdr
op_star
id|iph
suffix:semicolon
id|ipgre_tunnel_init_gen
c_func
(paren
id|dev
)paren
suffix:semicolon
macro_line|#ifdef MODULE
id|dev-&gt;open
op_assign
id|ipgre_fb_tunnel_open
suffix:semicolon
id|dev-&gt;stop
op_assign
id|ipgre_fb_tunnel_close
suffix:semicolon
macro_line|#endif
id|iph
op_assign
op_amp
id|ipgre_fb_tunnel.parms.iph
suffix:semicolon
id|iph-&gt;version
op_assign
l_int|4
suffix:semicolon
id|iph-&gt;protocol
op_assign
id|IPPROTO_GRE
suffix:semicolon
id|iph-&gt;ihl
op_assign
l_int|5
suffix:semicolon
id|tunnel-&gt;hlen
op_assign
r_sizeof
(paren
r_struct
id|iphdr
)paren
op_plus
l_int|4
suffix:semicolon
id|dev_hold
c_func
(paren
id|dev
)paren
suffix:semicolon
id|tunnels_wc
(braket
l_int|0
)braket
op_assign
op_amp
id|ipgre_fb_tunnel
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|variable|ipgre_protocol
r_static
r_struct
id|inet_protocol
id|ipgre_protocol
op_assign
(brace
id|ipgre_rcv
comma
multiline_comment|/* GRE handler          */
id|ipgre_err
comma
multiline_comment|/* TUNNEL error control */
l_int|0
comma
multiline_comment|/* next                 */
id|IPPROTO_GRE
comma
multiline_comment|/* protocol ID          */
l_int|0
comma
multiline_comment|/* copy                 */
l_int|NULL
comma
multiline_comment|/* data                 */
l_string|&quot;GRE&quot;
multiline_comment|/* name                 */
)brace
suffix:semicolon
multiline_comment|/*&n; *&t;And now the modules code and kernel interface.&n; */
macro_line|#ifdef MODULE
DECL|function|init_module
r_int
id|init_module
c_func
(paren
r_void
)paren
macro_line|#else
r_int
id|__init
id|ipgre_init
c_func
(paren
r_void
)paren
macro_line|#endif
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;GRE over IPv4 tunneling driver&bslash;n&quot;
)paren
suffix:semicolon
id|ipgre_fb_tunnel_dev.priv
op_assign
(paren
r_void
op_star
)paren
op_amp
id|ipgre_fb_tunnel
suffix:semicolon
macro_line|#ifdef MODULE
id|register_netdev
c_func
(paren
op_amp
id|ipgre_fb_tunnel_dev
)paren
suffix:semicolon
macro_line|#else
id|rtnl_lock
c_func
(paren
)paren
suffix:semicolon
id|register_netdevice
c_func
(paren
op_amp
id|ipgre_fb_tunnel_dev
)paren
suffix:semicolon
id|rtnl_unlock
c_func
(paren
)paren
suffix:semicolon
macro_line|#endif
id|inet_add_protocol
c_func
(paren
op_amp
id|ipgre_protocol
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#ifdef MODULE
DECL|function|cleanup_module
r_void
id|cleanup_module
c_func
(paren
r_void
)paren
(brace
r_if
c_cond
(paren
id|inet_del_protocol
c_func
(paren
op_amp
id|ipgre_protocol
)paren
OL
l_int|0
)paren
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;ipgre close: can&squot;t remove protocol&bslash;n&quot;
)paren
suffix:semicolon
id|unregister_netdev
c_func
(paren
op_amp
id|ipgre_fb_tunnel_dev
)paren
suffix:semicolon
)brace
macro_line|#endif
eof
