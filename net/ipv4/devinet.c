multiline_comment|/*&n; *&t;NET3&t;IP device support routines.&n; *&n; *&t;&t;This program is free software; you can redistribute it and/or&n; *&t;&t;modify it under the terms of the GNU General Public License&n; *&t;&t;as published by the Free Software Foundation; either version&n; *&t;&t;2 of the License, or (at your option) any later version.&n; *&n; *&t;Derived from the IP parts of dev.c 1.0.19&n; * &t;&t;Authors:&t;Ross Biro, &lt;bir7@leland.Stanford.Edu&gt;&n; *&t;&t;&t;&t;Fred N. van Kempen, &lt;waltje@uWalt.NL.Mugnet.ORG&gt;&n; *&t;&t;&t;&t;Mark Evans, &lt;evansmp@uhura.aston.ac.uk&gt;&n; *&n; *&t;Additional Authors:&n; *&t;&t;Alan Cox, &lt;gw4pts@gw4pts.ampr.org&gt;&n; */
macro_line|#include &lt;linux/config.h&gt;&t;/* For CONFIG_IP_CLASSLESS */
macro_line|#include &lt;asm/uaccess.h&gt;
macro_line|#include &lt;asm/system.h&gt;
macro_line|#include &lt;asm/bitops.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/mm.h&gt;
macro_line|#include &lt;linux/socket.h&gt;
macro_line|#include &lt;linux/sockios.h&gt;
macro_line|#include &lt;linux/in.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/interrupt.h&gt;
macro_line|#include &lt;linux/if_ether.h&gt;
macro_line|#include &lt;linux/inet.h&gt;
macro_line|#include &lt;linux/netdevice.h&gt;
macro_line|#include &lt;linux/etherdevice.h&gt;
macro_line|#include &lt;linux/if_arp.h&gt;
macro_line|#include &lt;net/ip.h&gt;
macro_line|#include &lt;net/route.h&gt;
macro_line|#include &lt;net/protocol.h&gt;
macro_line|#include &lt;net/tcp.h&gt;
macro_line|#include &lt;linux/skbuff.h&gt;
macro_line|#include &lt;net/sock.h&gt;
macro_line|#include &lt;net/arp.h&gt;
macro_line|#include &lt;linux/notifier.h&gt;
macro_line|#include &lt;linux/net_alias.h&gt;
macro_line|#ifdef CONFIG_KERNELD
macro_line|#include &lt;linux/kerneld.h&gt;
macro_line|#endif
r_extern
r_struct
id|notifier_block
op_star
id|netdev_chain
suffix:semicolon
multiline_comment|/* &n; *&t;Determine a default network mask, based on the IP address. &n; */
DECL|function|ip_get_mask
r_static
r_int
r_int
id|ip_get_mask
c_func
(paren
r_int
r_int
id|addr
)paren
(brace
r_int
r_int
id|dst
suffix:semicolon
r_if
c_cond
(paren
id|ZERONET
c_func
(paren
id|addr
)paren
)paren
r_return
l_int|0L
suffix:semicolon
multiline_comment|/* special case */
id|dst
op_assign
id|ntohl
c_func
(paren
id|addr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|IN_CLASSA
c_func
(paren
id|dst
)paren
)paren
r_return
id|htonl
c_func
(paren
id|IN_CLASSA_NET
)paren
suffix:semicolon
r_if
c_cond
(paren
id|IN_CLASSB
c_func
(paren
id|dst
)paren
)paren
r_return
id|htonl
c_func
(paren
id|IN_CLASSB_NET
)paren
suffix:semicolon
r_if
c_cond
(paren
id|IN_CLASSC
c_func
(paren
id|dst
)paren
)paren
r_return
id|htonl
c_func
(paren
id|IN_CLASSC_NET
)paren
suffix:semicolon
multiline_comment|/*&n;  &t; *&t;Something else, probably a multicast. &n;  &t; */
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;This checks bitmasks for the ioctl calls for devices.&n; */
DECL|function|bad_mask
r_static
r_inline
r_int
id|bad_mask
c_func
(paren
r_int
r_int
id|mask
comma
r_int
r_int
id|addr
)paren
(brace
r_if
c_cond
(paren
id|addr
op_amp
(paren
id|mask
op_assign
op_complement
id|mask
)paren
)paren
r_return
l_int|1
suffix:semicolon
id|mask
op_assign
id|ntohl
c_func
(paren
id|mask
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mask
op_amp
(paren
id|mask
op_plus
l_int|1
)paren
)paren
r_return
l_int|1
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|devinet_ioctl
r_int
id|devinet_ioctl
c_func
(paren
r_int
r_int
id|cmd
comma
r_void
op_star
id|arg
)paren
(brace
r_struct
id|ifreq
id|ifr
suffix:semicolon
r_struct
id|device
op_star
id|dev
suffix:semicolon
id|__u32
id|addr
suffix:semicolon
macro_line|#ifdef CONFIG_NET_ALIAS
r_int
id|err
suffix:semicolon
macro_line|#endif
multiline_comment|/*&n;&t; *&t;Fetch the caller&squot;s info block into kernel space&n;&t; */
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|ifr
comma
id|arg
comma
r_sizeof
(paren
r_struct
id|ifreq
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
multiline_comment|/*&n;&t; *&t;See which interface the caller is talking about. &n;&t; */
multiline_comment|/*&n;&t; *&n;&t; *&t;net_alias_dev_get(): dev_get() with added alias naming magic.&n;&t; *&t;only allow alias creation/deletion if (getset==SIOCSIFADDR)&n;&t; *&n;&t; */
macro_line|#ifdef CONFIG_KERNELD
id|dev_load
c_func
(paren
id|ifr.ifr_name
)paren
suffix:semicolon
macro_line|#endif&t;
macro_line|#ifdef CONFIG_NET_ALIAS
r_if
c_cond
(paren
(paren
id|dev
op_assign
id|net_alias_dev_get
c_func
(paren
id|ifr.ifr_name
comma
id|cmd
op_eq
id|SIOCSIFADDR
comma
op_amp
id|err
comma
l_int|NULL
comma
l_int|NULL
)paren
)paren
op_eq
l_int|NULL
)paren
r_return
id|err
suffix:semicolon
macro_line|#else
r_if
c_cond
(paren
(paren
id|dev
op_assign
id|dev_get
c_func
(paren
id|ifr.ifr_name
)paren
)paren
op_eq
l_int|NULL
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|cmd
op_ne
id|SIOCSIFADDR
op_logical_and
id|dev-&gt;family
op_ne
id|AF_INET
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_switch
c_cond
(paren
id|cmd
)paren
(brace
r_case
id|SIOCGIFADDR
suffix:colon
multiline_comment|/* Get interface address (and family) */
r_if
c_cond
(paren
id|ifr.ifr_addr.sa_family
op_eq
id|AF_UNSPEC
)paren
(brace
id|memcpy
c_func
(paren
id|ifr.ifr_hwaddr.sa_data
comma
id|dev-&gt;dev_addr
comma
id|MAX_ADDR_LEN
)paren
suffix:semicolon
id|ifr.ifr_hwaddr.sa_family
op_assign
id|dev-&gt;type
suffix:semicolon
)brace
r_else
(brace
(paren
r_struct
id|sockaddr_in
op_star
)paren
op_amp
id|ifr.ifr_addr.sin_addr.s_addr
op_assign
id|dev-&gt;pa_addr
suffix:semicolon
(paren
r_struct
id|sockaddr_in
op_star
)paren
op_amp
id|ifr.ifr_addr.sin_family
op_assign
id|dev-&gt;family
suffix:semicolon
(paren
r_struct
id|sockaddr_in
op_star
)paren
op_amp
id|ifr.ifr_addr.sin_port
op_assign
l_int|0
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|SIOCSIFADDR
suffix:colon
multiline_comment|/* Set interface address (and family) */
r_if
c_cond
(paren
op_logical_neg
id|suser
c_func
(paren
)paren
)paren
r_return
op_minus
id|EPERM
suffix:semicolon
multiline_comment|/*&n;&t;&t;&t; *&t;BSDism. SIOCSIFADDR family=AF_UNSPEC sets the&n;&t;&t;&t; *&t;physical address. We can cope with this now.&n;&t;&t;&t; */
r_if
c_cond
(paren
id|ifr.ifr_addr.sa_family
op_eq
id|AF_UNSPEC
)paren
(brace
r_int
id|ret
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;set_mac_address
op_eq
l_int|NULL
)paren
(brace
r_return
op_minus
id|EOPNOTSUPP
suffix:semicolon
)brace
id|ret
op_assign
id|dev
op_member_access_from_pointer
id|set_mac_address
c_func
(paren
id|dev
comma
op_amp
id|ifr.ifr_addr
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ret
)paren
id|notifier_call_chain
c_func
(paren
op_amp
id|netdev_chain
comma
id|NETDEV_CHANGEADDR
comma
id|dev
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ifr.ifr_addr.sa_family
op_ne
id|AF_INET
)paren
(brace
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|addr
op_assign
(paren
r_struct
id|sockaddr_in
op_star
)paren
op_amp
id|ifr.ifr_addr.sin_addr.s_addr
suffix:semicolon
id|dev_lock_wait
c_func
(paren
)paren
suffix:semicolon
id|dev_lock_list
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;family
op_eq
id|AF_INET
op_logical_and
id|addr
op_eq
id|dev-&gt;pa_addr
)paren
(brace
id|dev_unlock_list
c_func
(paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|dev-&gt;flags
op_amp
id|IFF_UP
)paren
id|notifier_call_chain
c_func
(paren
op_amp
id|netdev_chain
comma
id|NETDEV_DOWN
comma
id|dev
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t;&t; *&t;if dev is an alias, must rehash to update&n;&t;&t;&t; *&t;address change&n;&t;&t;&t; */
macro_line|#ifdef CONFIG_NET_ALIAS
r_if
c_cond
(paren
id|net_alias_is
c_func
(paren
id|dev
)paren
)paren
id|net_alias_dev_rehash
c_func
(paren
id|dev
comma
op_amp
id|ifr.ifr_addr
)paren
suffix:semicolon
macro_line|#endif
id|dev-&gt;pa_addr
op_assign
id|addr
suffix:semicolon
id|dev-&gt;ip_flags
op_or_assign
id|IFF_IP_ADDR_OK
suffix:semicolon
id|dev-&gt;ip_flags
op_and_assign
op_complement
(paren
id|IFF_IP_BRD_OK
op_or
id|IFF_IP_MASK_OK
)paren
suffix:semicolon
id|dev-&gt;family
op_assign
id|AF_INET
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;flags
op_amp
id|IFF_POINTOPOINT
)paren
(brace
id|dev-&gt;pa_mask
op_assign
l_int|0xFFFFFFFF
suffix:semicolon
id|dev-&gt;pa_brdaddr
op_assign
l_int|0xFFFFFFFF
suffix:semicolon
)brace
r_else
(brace
id|dev-&gt;pa_mask
op_assign
id|ip_get_mask
c_func
(paren
id|dev-&gt;pa_addr
)paren
suffix:semicolon
id|dev-&gt;pa_brdaddr
op_assign
id|dev-&gt;pa_addr
op_or
op_complement
id|dev-&gt;pa_mask
suffix:semicolon
)brace
r_if
c_cond
(paren
id|dev-&gt;flags
op_amp
id|IFF_UP
)paren
id|notifier_call_chain
c_func
(paren
op_amp
id|netdev_chain
comma
id|NETDEV_UP
comma
id|dev
)paren
suffix:semicolon
id|dev_unlock_list
c_func
(paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
r_case
id|SIOCGIFBRDADDR
suffix:colon
multiline_comment|/* Get the broadcast address */
(paren
r_struct
id|sockaddr_in
op_star
)paren
op_amp
id|ifr.ifr_broadaddr.sin_addr.s_addr
op_assign
id|dev-&gt;pa_brdaddr
suffix:semicolon
(paren
r_struct
id|sockaddr_in
op_star
)paren
op_amp
id|ifr.ifr_broadaddr.sin_family
op_assign
id|dev-&gt;family
suffix:semicolon
(paren
r_struct
id|sockaddr_in
op_star
)paren
op_amp
id|ifr.ifr_broadaddr.sin_port
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SIOCSIFBRDADDR
suffix:colon
multiline_comment|/* Set the broadcast address */
r_if
c_cond
(paren
op_logical_neg
id|suser
c_func
(paren
)paren
)paren
r_return
op_minus
id|EPERM
suffix:semicolon
id|addr
op_assign
(paren
r_struct
id|sockaddr_in
op_star
)paren
op_amp
id|ifr.ifr_broadaddr.sin_addr.s_addr
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;flags
op_amp
id|IFF_UP
)paren
id|ip_rt_change_broadcast
c_func
(paren
id|dev
comma
id|addr
)paren
suffix:semicolon
id|dev-&gt;pa_brdaddr
op_assign
id|addr
suffix:semicolon
id|dev-&gt;ip_flags
op_or_assign
id|IFF_IP_BRD_OK
suffix:semicolon
r_return
l_int|0
suffix:semicolon
r_case
id|SIOCGIFDSTADDR
suffix:colon
multiline_comment|/* Get the destination address (for point-to-point links) */
(paren
r_struct
id|sockaddr_in
op_star
)paren
op_amp
id|ifr.ifr_dstaddr.sin_addr.s_addr
op_assign
id|dev-&gt;pa_dstaddr
suffix:semicolon
(paren
r_struct
id|sockaddr_in
op_star
)paren
op_amp
id|ifr.ifr_dstaddr.sin_family
op_assign
id|dev-&gt;family
suffix:semicolon
(paren
r_struct
id|sockaddr_in
op_star
)paren
op_amp
id|ifr.ifr_dstaddr.sin_port
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SIOCSIFDSTADDR
suffix:colon
multiline_comment|/* Set the destination address (for point-to-point links) */
r_if
c_cond
(paren
op_logical_neg
id|suser
c_func
(paren
)paren
)paren
r_return
op_minus
id|EPERM
suffix:semicolon
id|addr
op_assign
(paren
r_struct
id|sockaddr_in
op_star
)paren
op_amp
id|ifr.ifr_dstaddr.sin_addr.s_addr
suffix:semicolon
r_if
c_cond
(paren
id|addr
op_eq
id|dev-&gt;pa_dstaddr
)paren
r_return
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;flags
op_amp
id|IFF_UP
)paren
id|ip_rt_change_dstaddr
c_func
(paren
id|dev
comma
id|addr
)paren
suffix:semicolon
id|dev-&gt;pa_dstaddr
op_assign
id|addr
suffix:semicolon
r_return
l_int|0
suffix:semicolon
r_case
id|SIOCGIFNETMASK
suffix:colon
multiline_comment|/* Get the netmask for the interface */
(paren
r_struct
id|sockaddr_in
op_star
)paren
op_amp
id|ifr.ifr_netmask.sin_addr.s_addr
op_assign
id|dev-&gt;pa_mask
suffix:semicolon
(paren
r_struct
id|sockaddr_in
op_star
)paren
op_amp
id|ifr.ifr_netmask.sin_family
op_assign
id|dev-&gt;family
suffix:semicolon
(paren
r_struct
id|sockaddr_in
op_star
)paren
op_amp
id|ifr.ifr_netmask.sin_port
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SIOCSIFNETMASK
suffix:colon
multiline_comment|/* Set the netmask for the interface */
r_if
c_cond
(paren
op_logical_neg
id|suser
c_func
(paren
)paren
)paren
r_return
op_minus
id|EPERM
suffix:semicolon
id|addr
op_assign
(paren
r_struct
id|sockaddr_in
op_star
)paren
op_amp
id|ifr.ifr_netmask.sin_addr.s_addr
suffix:semicolon
r_if
c_cond
(paren
id|addr
op_eq
id|dev-&gt;pa_mask
)paren
(brace
id|dev-&gt;ip_flags
op_or_assign
id|IFF_IP_MASK_OK
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n;&t;&t;&t; *&t;The mask we set must be legal.&n;&t;&t;&t; */
r_if
c_cond
(paren
id|bad_mask
c_func
(paren
id|addr
comma
l_int|0
)paren
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|addr
op_eq
id|htonl
c_func
(paren
l_int|0xFFFFFFFE
)paren
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;flags
op_amp
id|IFF_UP
)paren
id|ip_rt_change_netmask
c_func
(paren
id|dev
comma
id|addr
)paren
suffix:semicolon
id|dev-&gt;pa_mask
op_assign
id|addr
suffix:semicolon
id|dev-&gt;ip_flags
op_or_assign
id|IFF_IP_MASK_OK
suffix:semicolon
id|dev-&gt;ip_flags
op_and_assign
op_complement
id|IFF_IP_BRD_OK
suffix:semicolon
r_return
l_int|0
suffix:semicolon
r_default
suffix:colon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
id|arg
comma
op_amp
id|ifr
comma
r_sizeof
(paren
r_struct
id|ifreq
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
eof
