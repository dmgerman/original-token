multiline_comment|/*&n; * INET&t;&t;An implementation of the TCP/IP protocol suite for the LINUX&n; *&t;&t;operating system.  INET is implemented using the  BSD Socket&n; *&t;&t;interface as the means of communication with the user level.&n; *&n; *&t;&t;ROUTE - implementation of the IP router.&n; *&n; * Version:&t;$Id: route.c,v 1.36 1997/12/17 20:14:18 kuznet Exp $&n; *&n; * Authors:&t;Ross Biro, &lt;bir7@leland.Stanford.Edu&gt;&n; *&t;&t;Fred N. van Kempen, &lt;waltje@uWalt.NL.Mugnet.ORG&gt;&n; *&t;&t;Alan Cox, &lt;gw4pts@gw4pts.ampr.org&gt;&n; *&t;&t;Linus Torvalds, &lt;Linus.Torvalds@helsinki.fi&gt;&n; *&t;&t;Alexey Kuznetsov, &lt;kuznet@ms2.inr.ac.ru&gt;&n; *&n; * Fixes:&n; *&t;&t;Alan Cox&t;:&t;Verify area fixes.&n; *&t;&t;Alan Cox&t;:&t;cli() protects routing changes&n; *&t;&t;Rui Oliveira&t;:&t;ICMP routing table updates&n; *&t;&t;(rco@di.uminho.pt)&t;Routing table insertion and update&n; *&t;&t;Linus Torvalds&t;:&t;Rewrote bits to be sensible&n; *&t;&t;Alan Cox&t;:&t;Added BSD route gw semantics&n; *&t;&t;Alan Cox&t;:&t;Super /proc &gt;4K &n; *&t;&t;Alan Cox&t;:&t;MTU in route table&n; *&t;&t;Alan Cox&t;: &t;MSS actually. Also added the window&n; *&t;&t;&t;&t;&t;clamper.&n; *&t;&t;Sam Lantinga&t;:&t;Fixed route matching in rt_del()&n; *&t;&t;Alan Cox&t;:&t;Routing cache support.&n; *&t;&t;Alan Cox&t;:&t;Removed compatibility cruft.&n; *&t;&t;Alan Cox&t;:&t;RTF_REJECT support.&n; *&t;&t;Alan Cox&t;:&t;TCP irtt support.&n; *&t;&t;Jonathan Naylor&t;:&t;Added Metric support.&n; *&t;Miquel van Smoorenburg&t;:&t;BSD API fixes.&n; *&t;Miquel van Smoorenburg&t;:&t;Metrics.&n; *&t;&t;Alan Cox&t;:&t;Use __u32 properly&n; *&t;&t;Alan Cox&t;:&t;Aligned routing errors more closely with BSD&n; *&t;&t;&t;&t;&t;our system is still very different.&n; *&t;&t;Alan Cox&t;:&t;Faster /proc handling&n; *&t;Alexey Kuznetsov&t;:&t;Massive rework to support tree based routing,&n; *&t;&t;&t;&t;&t;routing caches and better behaviour.&n; *&t;&t;&n; *&t;&t;Olaf Erb&t;:&t;irtt wasn&squot;t being copied right.&n; *&t;&t;Bjorn Ekwall&t;:&t;Kerneld route support.&n; *&t;&t;Alan Cox&t;:&t;Multicast fixed (I hope)&n; * &t;&t;Pavel Krauz&t;:&t;Limited broadcast fixed&n; *&t;Alexey Kuznetsov&t;:&t;End of old history. Splitted to fib.c and&n; *&t;&t;&t;&t;&t;route.c and rewritten from scratch.&n; *&t;&t;Andi Kleen&t;:&t;Load-limit warning messages.&n; *&t;Vitaly E. Lavrov&t;:&t;Transparent proxy revived after year coma.&n; *&n; *&t;&t;This program is free software; you can redistribute it and/or&n; *&t;&t;modify it under the terms of the GNU General Public License&n; *&t;&t;as published by the Free Software Foundation; either version&n; *&t;&t;2 of the License, or (at your option) any later version.&n; */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;asm/uaccess.h&gt;
macro_line|#include &lt;asm/system.h&gt;
macro_line|#include &lt;asm/bitops.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/mm.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/socket.h&gt;
macro_line|#include &lt;linux/sockios.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/in.h&gt;
macro_line|#include &lt;linux/inet.h&gt;
macro_line|#include &lt;linux/netdevice.h&gt;
macro_line|#include &lt;linux/proc_fs.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/skbuff.h&gt;
macro_line|#include &lt;linux/rtnetlink.h&gt;
macro_line|#include &lt;linux/inetdevice.h&gt;
macro_line|#include &lt;linux/igmp.h&gt;
macro_line|#include &lt;linux/pkt_sched.h&gt;
macro_line|#include &lt;linux/mroute.h&gt;
macro_line|#include &lt;net/protocol.h&gt;
macro_line|#include &lt;net/ip.h&gt;
macro_line|#include &lt;net/route.h&gt;
macro_line|#include &lt;net/sock.h&gt;
macro_line|#include &lt;net/ip_fib.h&gt;
macro_line|#include &lt;net/arp.h&gt;
macro_line|#include &lt;net/tcp.h&gt;
macro_line|#include &lt;net/icmp.h&gt;
DECL|macro|RTprint
mdefine_line|#define RTprint(a...)&t;printk(KERN_DEBUG a)
DECL|variable|rt_flush_timer
r_static
r_struct
id|timer_list
id|rt_flush_timer
op_assign
(brace
l_int|NULL
comma
l_int|NULL
comma
l_int|0
comma
l_int|0L
comma
l_int|NULL
)brace
suffix:semicolon
DECL|variable|rt_periodic_timer
r_static
r_struct
id|timer_list
id|rt_periodic_timer
op_assign
(brace
l_int|NULL
comma
l_int|NULL
comma
l_int|0
comma
l_int|0L
comma
l_int|NULL
)brace
suffix:semicolon
multiline_comment|/*&n; *&t;Interface to generic destination cache.&n; */
r_static
r_struct
id|dst_entry
op_star
id|ipv4_dst_check
c_func
(paren
r_struct
id|dst_entry
op_star
id|dst
comma
id|u32
)paren
suffix:semicolon
r_static
r_struct
id|dst_entry
op_star
id|ipv4_dst_reroute
c_func
(paren
r_struct
id|dst_entry
op_star
id|dst
comma
r_struct
id|sk_buff
op_star
)paren
suffix:semicolon
r_static
r_struct
id|dst_entry
op_star
id|ipv4_negative_advice
c_func
(paren
r_struct
id|dst_entry
op_star
)paren
suffix:semicolon
DECL|variable|ipv4_dst_ops
r_struct
id|dst_ops
id|ipv4_dst_ops
op_assign
(brace
id|AF_INET
comma
id|__constant_htons
c_func
(paren
id|ETH_P_IP
)paren
comma
id|ipv4_dst_check
comma
id|ipv4_dst_reroute
comma
l_int|NULL
comma
id|ipv4_negative_advice
)brace
suffix:semicolon
DECL|variable|ip_tos2prio
id|__u8
id|ip_tos2prio
(braket
l_int|16
)braket
op_assign
(brace
id|TC_PRIO_FILLER
comma
id|TC_PRIO_BESTEFFORT
comma
id|TC_PRIO_FILLER
comma
id|TC_PRIO_FILLER
comma
id|TC_PRIO_BULK
comma
id|TC_PRIO_FILLER
comma
id|TC_PRIO_BULK
comma
id|TC_PRIO_FILLER
comma
id|TC_PRIO_INTERACTIVE
comma
id|TC_PRIO_FILLER
comma
id|TC_PRIO_INTERACTIVE
comma
id|TC_PRIO_FILLER
comma
id|TC_PRIO_INTERACTIVE_BULK
comma
id|TC_PRIO_FILLER
comma
id|TC_PRIO_INTERACTIVE_BULK
comma
id|TC_PRIO_FILLER
)brace
suffix:semicolon
multiline_comment|/*&n; * Route cache.&n; */
DECL|variable|rt_cache_size
r_static
id|atomic_t
id|rt_cache_size
op_assign
id|ATOMIC_INIT
c_func
(paren
l_int|0
)paren
suffix:semicolon
DECL|variable|rt_hash_table
r_static
r_struct
id|rtable
op_star
id|rt_hash_table
(braket
id|RT_HASH_DIVISOR
)braket
suffix:semicolon
r_static
r_struct
id|rtable
op_star
id|rt_intern_hash
c_func
(paren
r_int
id|hash
comma
r_struct
id|rtable
op_star
id|rth
comma
id|u16
id|protocol
)paren
suffix:semicolon
DECL|function|rt_hash_code
r_static
id|__inline__
r_int
id|rt_hash_code
c_func
(paren
id|u32
id|daddr
comma
id|u32
id|saddr
comma
id|u8
id|tos
)paren
(brace
r_int
id|hash
op_assign
(paren
(paren
id|daddr
op_amp
l_int|0xF0F0F0F0
)paren
op_rshift
l_int|4
)paren
op_or
(paren
(paren
id|daddr
op_amp
l_int|0x0F0F0F0F
)paren
op_lshift
l_int|4
)paren
suffix:semicolon
id|hash
op_assign
id|hash
op_xor
id|saddr
op_xor
id|tos
suffix:semicolon
id|hash
op_assign
id|hash
op_xor
(paren
id|hash
op_rshift
l_int|16
)paren
suffix:semicolon
r_return
(paren
id|hash
op_xor
(paren
id|hash
op_rshift
l_int|8
)paren
)paren
op_amp
l_int|0xFF
suffix:semicolon
)brace
macro_line|#ifdef CONFIG_PROC_FS
DECL|function|rt_cache_get_info
r_static
r_int
id|rt_cache_get_info
c_func
(paren
r_char
op_star
id|buffer
comma
r_char
op_star
op_star
id|start
comma
id|off_t
id|offset
comma
r_int
id|length
comma
r_int
id|dummy
)paren
(brace
r_int
id|len
op_assign
l_int|0
suffix:semicolon
id|off_t
id|pos
op_assign
l_int|0
suffix:semicolon
r_char
id|temp
(braket
l_int|129
)braket
suffix:semicolon
r_struct
id|rtable
op_star
id|r
suffix:semicolon
r_int
id|i
suffix:semicolon
id|pos
op_assign
l_int|128
suffix:semicolon
r_if
c_cond
(paren
id|offset
OL
l_int|128
)paren
(brace
id|sprintf
c_func
(paren
id|buffer
comma
l_string|&quot;%-127s&bslash;n&quot;
comma
l_string|&quot;Iface&bslash;tDestination&bslash;tGateway &bslash;tFlags&bslash;t&bslash;tRefCnt&bslash;tUse&bslash;tMetric&bslash;tSource&bslash;t&bslash;tMTU&bslash;tWindow&bslash;tIRTT&bslash;tTOS&bslash;tHHRef&bslash;tHHUptod&bslash;tSpecDst&quot;
)paren
suffix:semicolon
id|len
op_assign
l_int|128
suffix:semicolon
)brace
id|start_bh_atomic
c_func
(paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|RT_HASH_DIVISOR
suffix:semicolon
id|i
op_increment
)paren
(brace
r_for
c_loop
(paren
id|r
op_assign
id|rt_hash_table
(braket
id|i
)braket
suffix:semicolon
id|r
suffix:semicolon
id|r
op_assign
id|r-&gt;u.rt_next
)paren
(brace
multiline_comment|/*&n;&t;&t;&t; *&t;Spin through entries until we are ready&n;&t;&t;&t; */
id|pos
op_add_assign
l_int|128
suffix:semicolon
r_if
c_cond
(paren
id|pos
op_le
id|offset
)paren
(brace
id|len
op_assign
l_int|0
suffix:semicolon
r_continue
suffix:semicolon
)brace
id|sprintf
c_func
(paren
id|temp
comma
l_string|&quot;%s&bslash;t%08lX&bslash;t%08lX&bslash;t%8X&bslash;t%d&bslash;t%u&bslash;t%d&bslash;t%08lX&bslash;t%d&bslash;t%u&bslash;t%u&bslash;t%02X&bslash;t%d&bslash;t%1d&bslash;t%08X&quot;
comma
id|r-&gt;u.dst.dev
ques
c_cond
id|r-&gt;u.dst.dev-&gt;name
suffix:colon
l_string|&quot;*&quot;
comma
(paren
r_int
r_int
)paren
id|r-&gt;rt_dst
comma
(paren
r_int
r_int
)paren
id|r-&gt;rt_gateway
comma
id|r-&gt;rt_flags
comma
id|atomic_read
c_func
(paren
op_amp
id|r-&gt;u.dst.use
)paren
comma
id|atomic_read
c_func
(paren
op_amp
id|r-&gt;u.dst.refcnt
)paren
comma
l_int|0
comma
(paren
r_int
r_int
)paren
id|r-&gt;rt_src
comma
(paren
r_int
)paren
id|r-&gt;u.dst.pmtu
comma
id|r-&gt;u.dst.window
comma
(paren
r_int
)paren
id|r-&gt;u.dst.rtt
comma
id|r-&gt;key.tos
comma
id|r-&gt;u.dst.hh
ques
c_cond
id|atomic_read
c_func
(paren
op_amp
id|r-&gt;u.dst.hh-&gt;hh_refcnt
)paren
suffix:colon
op_minus
l_int|1
comma
id|r-&gt;u.dst.hh
ques
c_cond
(paren
id|r-&gt;u.dst.hh-&gt;hh_output
op_eq
id|ip_acct_output
)paren
suffix:colon
l_int|0
comma
id|r-&gt;rt_spec_dst
)paren
suffix:semicolon
id|sprintf
c_func
(paren
id|buffer
op_plus
id|len
comma
l_string|&quot;%-127s&bslash;n&quot;
comma
id|temp
)paren
suffix:semicolon
id|len
op_add_assign
l_int|128
suffix:semicolon
r_if
c_cond
(paren
id|pos
op_ge
id|offset
op_plus
id|length
)paren
r_goto
id|done
suffix:semicolon
)brace
)brace
id|done
suffix:colon
id|end_bh_atomic
c_func
(paren
)paren
suffix:semicolon
op_star
id|start
op_assign
id|buffer
op_plus
id|len
op_minus
(paren
id|pos
op_minus
id|offset
)paren
suffix:semicolon
id|len
op_assign
id|pos
op_minus
id|offset
suffix:semicolon
r_if
c_cond
(paren
id|len
OG
id|length
)paren
id|len
op_assign
id|length
suffix:semicolon
r_return
id|len
suffix:semicolon
)brace
macro_line|#endif
DECL|function|rt_free
r_static
r_void
id|__inline__
id|rt_free
c_func
(paren
r_struct
id|rtable
op_star
id|rt
)paren
(brace
id|dst_free
c_func
(paren
op_amp
id|rt-&gt;u.dst
)paren
suffix:semicolon
)brace
DECL|function|rt_check_expire
r_static
r_void
id|rt_check_expire
c_func
(paren
r_int
r_int
id|dummy
)paren
(brace
r_int
id|i
suffix:semicolon
r_static
r_int
id|rover
suffix:semicolon
r_struct
id|rtable
op_star
id|rth
comma
op_star
op_star
id|rthp
suffix:semicolon
r_int
r_int
id|now
op_assign
id|jiffies
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|RT_HASH_DIVISOR
op_div
l_int|5
suffix:semicolon
id|i
op_increment
)paren
(brace
id|rover
op_assign
(paren
id|rover
op_plus
l_int|1
)paren
op_amp
(paren
id|RT_HASH_DIVISOR
op_minus
l_int|1
)paren
suffix:semicolon
id|rthp
op_assign
op_amp
id|rt_hash_table
(braket
id|rover
)braket
suffix:semicolon
r_while
c_loop
(paren
(paren
id|rth
op_assign
op_star
id|rthp
)paren
op_ne
l_int|NULL
)paren
(brace
r_struct
id|rtable
op_star
id|rth_next
op_assign
id|rth-&gt;u.rt_next
suffix:semicolon
multiline_comment|/*&n;&t;&t;&t; * Cleanup aged off entries.&n;&t;&t;&t; */
r_if
c_cond
(paren
op_logical_neg
id|atomic_read
c_func
(paren
op_amp
id|rth-&gt;u.dst.use
)paren
op_logical_and
(paren
id|now
op_minus
id|rth-&gt;u.dst.lastuse
OG
id|RT_CACHE_TIMEOUT
)paren
)paren
(brace
op_star
id|rthp
op_assign
id|rth_next
suffix:semicolon
id|atomic_dec
c_func
(paren
op_amp
id|rt_cache_size
)paren
suffix:semicolon
macro_line|#if RT_CACHE_DEBUG &gt;= 2
id|printk
c_func
(paren
l_string|&quot;rt_check_expire clean %02x@%08x&bslash;n&quot;
comma
id|rover
comma
id|rth-&gt;rt_dst
)paren
suffix:semicolon
macro_line|#endif
id|rt_free
c_func
(paren
id|rth
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|rth_next
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
id|rth_next-&gt;u.dst.lastuse
op_minus
id|rth-&gt;u.dst.lastuse
OG
id|RT_CACHE_BUBBLE_THRESHOLD
op_logical_or
(paren
id|rth-&gt;u.dst.lastuse
op_minus
id|rth_next-&gt;u.dst.lastuse
OL
l_int|0
op_logical_and
id|atomic_read
c_func
(paren
op_amp
id|rth-&gt;u.dst.refcnt
)paren
OL
id|atomic_read
c_func
(paren
op_amp
id|rth_next-&gt;u.dst.refcnt
)paren
)paren
)paren
(brace
macro_line|#if RT_CACHE_DEBUG &gt;= 2
id|printk
c_func
(paren
l_string|&quot;rt_check_expire bubbled %02x@%08x&lt;-&gt;%08x&bslash;n&quot;
comma
id|rover
comma
id|rth-&gt;rt_dst
comma
id|rth_next-&gt;rt_dst
)paren
suffix:semicolon
macro_line|#endif
op_star
id|rthp
op_assign
id|rth_next
suffix:semicolon
id|rth-&gt;u.rt_next
op_assign
id|rth_next-&gt;u.rt_next
suffix:semicolon
id|rth_next-&gt;u.rt_next
op_assign
id|rth
suffix:semicolon
id|rthp
op_assign
op_amp
id|rth_next-&gt;u.rt_next
suffix:semicolon
r_continue
suffix:semicolon
)brace
id|rthp
op_assign
op_amp
id|rth-&gt;u.rt_next
suffix:semicolon
)brace
)brace
id|rt_periodic_timer.expires
op_assign
id|now
op_plus
id|RT_GC_INTERVAL
suffix:semicolon
id|add_timer
c_func
(paren
op_amp
id|rt_periodic_timer
)paren
suffix:semicolon
)brace
DECL|function|rt_run_flush
r_static
r_void
id|rt_run_flush
c_func
(paren
r_int
r_int
id|dummy
)paren
(brace
r_int
id|i
suffix:semicolon
r_struct
id|rtable
op_star
id|rth
comma
op_star
id|next
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|RT_HASH_DIVISOR
suffix:semicolon
id|i
op_increment
)paren
(brace
r_int
id|nr
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
(paren
id|rth
op_assign
id|xchg
c_func
(paren
op_amp
id|rt_hash_table
(braket
id|i
)braket
comma
l_int|NULL
)paren
)paren
op_eq
l_int|NULL
)paren
r_continue
suffix:semicolon
r_for
c_loop
(paren
suffix:semicolon
id|rth
suffix:semicolon
id|rth
op_assign
id|next
)paren
(brace
id|next
op_assign
id|rth-&gt;u.rt_next
suffix:semicolon
id|atomic_dec
c_func
(paren
op_amp
id|rt_cache_size
)paren
suffix:semicolon
id|nr
op_increment
suffix:semicolon
id|rth-&gt;u.rt_next
op_assign
l_int|NULL
suffix:semicolon
id|rt_free
c_func
(paren
id|rth
)paren
suffix:semicolon
)brace
macro_line|#if RT_CACHE_DEBUG &gt;= 2
r_if
c_cond
(paren
id|nr
OG
l_int|0
)paren
id|printk
c_func
(paren
l_string|&quot;rt_cache_flush: %d@%02x&bslash;n&quot;
comma
id|nr
comma
id|i
)paren
suffix:semicolon
macro_line|#endif
)brace
)brace
DECL|function|rt_cache_flush
r_void
id|rt_cache_flush
c_func
(paren
r_int
id|delay
)paren
(brace
id|start_bh_atomic
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|delay
op_logical_and
id|rt_flush_timer.function
op_logical_and
id|rt_flush_timer.expires
op_minus
id|jiffies
OL
id|delay
)paren
(brace
id|end_bh_atomic
c_func
(paren
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|rt_flush_timer.function
)paren
(brace
id|del_timer
c_func
(paren
op_amp
id|rt_flush_timer
)paren
suffix:semicolon
id|rt_flush_timer.function
op_assign
l_int|NULL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|delay
op_eq
l_int|0
)paren
(brace
id|end_bh_atomic
c_func
(paren
)paren
suffix:semicolon
id|rt_run_flush
c_func
(paren
l_int|0
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|rt_flush_timer.function
op_assign
id|rt_run_flush
suffix:semicolon
id|rt_flush_timer.expires
op_assign
id|jiffies
op_plus
id|delay
suffix:semicolon
id|add_timer
c_func
(paren
op_amp
id|rt_flush_timer
)paren
suffix:semicolon
id|end_bh_atomic
c_func
(paren
)paren
suffix:semicolon
)brace
DECL|function|rt_garbage_collect
r_static
r_void
id|rt_garbage_collect
c_func
(paren
r_void
)paren
(brace
r_int
id|i
suffix:semicolon
r_static
r_int
id|expire
op_assign
id|RT_CACHE_TIMEOUT
op_rshift
l_int|1
suffix:semicolon
r_static
r_int
r_int
id|last_gc
suffix:semicolon
r_struct
id|rtable
op_star
id|rth
comma
op_star
op_star
id|rthp
suffix:semicolon
r_int
r_int
id|now
suffix:semicolon
id|start_bh_atomic
c_func
(paren
)paren
suffix:semicolon
id|now
op_assign
id|jiffies
suffix:semicolon
multiline_comment|/*&n;&t; * Garbage collection is pretty expensive,&n;&t; * do not make it too frequently, but just increase expire strength.&n;&t; */
r_if
c_cond
(paren
id|now
op_minus
id|last_gc
OL
l_int|1
op_star
id|HZ
)paren
(brace
id|expire
op_rshift_assign
l_int|1
suffix:semicolon
id|end_bh_atomic
c_func
(paren
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|expire
op_increment
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|RT_HASH_DIVISOR
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|rt_hash_table
(braket
id|i
)braket
)paren
r_continue
suffix:semicolon
r_for
c_loop
(paren
id|rthp
op_assign
op_amp
id|rt_hash_table
(braket
id|i
)braket
suffix:semicolon
(paren
id|rth
op_assign
op_star
id|rthp
)paren
suffix:semicolon
id|rthp
op_assign
op_amp
id|rth-&gt;u.rt_next
)paren
(brace
r_if
c_cond
(paren
id|atomic_read
c_func
(paren
op_amp
id|rth-&gt;u.dst.use
)paren
op_logical_or
id|now
op_minus
id|rth-&gt;u.dst.lastuse
OL
id|expire
)paren
r_continue
suffix:semicolon
id|atomic_dec
c_func
(paren
op_amp
id|rt_cache_size
)paren
suffix:semicolon
op_star
id|rthp
op_assign
id|rth-&gt;u.rt_next
suffix:semicolon
id|rth-&gt;u.rt_next
op_assign
l_int|NULL
suffix:semicolon
id|rt_free
c_func
(paren
id|rth
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
id|last_gc
op_assign
id|now
suffix:semicolon
r_if
c_cond
(paren
id|atomic_read
c_func
(paren
op_amp
id|rt_cache_size
)paren
OL
id|RT_CACHE_MAX_SIZE
)paren
id|expire
op_assign
id|RT_CACHE_TIMEOUT
op_rshift
l_int|1
suffix:semicolon
r_else
id|expire
op_rshift_assign
l_int|1
suffix:semicolon
id|end_bh_atomic
c_func
(paren
)paren
suffix:semicolon
)brace
DECL|function|rt_intern_hash
r_static
r_struct
id|rtable
op_star
id|rt_intern_hash
c_func
(paren
r_int
id|hash
comma
r_struct
id|rtable
op_star
id|rt
comma
id|u16
id|protocol
)paren
(brace
r_struct
id|rtable
op_star
id|rth
comma
op_star
op_star
id|rthp
suffix:semicolon
r_int
r_int
id|now
op_assign
id|jiffies
suffix:semicolon
id|rt-&gt;u.dst.priority
op_assign
id|rt_tos2priority
c_func
(paren
id|rt-&gt;key.tos
)paren
suffix:semicolon
id|start_bh_atomic
c_func
(paren
)paren
suffix:semicolon
id|rthp
op_assign
op_amp
id|rt_hash_table
(braket
id|hash
)braket
suffix:semicolon
r_while
c_loop
(paren
(paren
id|rth
op_assign
op_star
id|rthp
)paren
op_ne
l_int|NULL
)paren
(brace
r_if
c_cond
(paren
id|memcmp
c_func
(paren
op_amp
id|rth-&gt;key
comma
op_amp
id|rt-&gt;key
comma
r_sizeof
(paren
id|rt-&gt;key
)paren
)paren
op_eq
l_int|0
)paren
(brace
multiline_comment|/* Put it first */
op_star
id|rthp
op_assign
id|rth-&gt;u.rt_next
suffix:semicolon
id|rth-&gt;u.rt_next
op_assign
id|rt_hash_table
(braket
id|hash
)braket
suffix:semicolon
id|rt_hash_table
(braket
id|hash
)braket
op_assign
id|rth
suffix:semicolon
id|atomic_inc
c_func
(paren
op_amp
id|rth-&gt;u.dst.refcnt
)paren
suffix:semicolon
id|atomic_inc
c_func
(paren
op_amp
id|rth-&gt;u.dst.use
)paren
suffix:semicolon
id|rth-&gt;u.dst.lastuse
op_assign
id|now
suffix:semicolon
id|end_bh_atomic
c_func
(paren
)paren
suffix:semicolon
id|ip_rt_put
c_func
(paren
id|rt
)paren
suffix:semicolon
id|rt_free
c_func
(paren
id|rt
)paren
suffix:semicolon
r_return
id|rth
suffix:semicolon
)brace
id|rthp
op_assign
op_amp
id|rth-&gt;u.rt_next
suffix:semicolon
)brace
multiline_comment|/* Try to bind route ro arp only if it is output&n;&t;   route or unicast forwarding path.&n;&t; */
r_if
c_cond
(paren
id|rt-&gt;rt_type
op_eq
id|RTN_UNICAST
op_logical_or
id|rt-&gt;key.iif
op_eq
l_int|0
)paren
id|arp_bind_neighbour
c_func
(paren
op_amp
id|rt-&gt;u.dst
)paren
suffix:semicolon
r_if
c_cond
(paren
id|atomic_read
c_func
(paren
op_amp
id|rt_cache_size
)paren
op_ge
id|RT_CACHE_MAX_SIZE
)paren
id|rt_garbage_collect
c_func
(paren
)paren
suffix:semicolon
id|rt-&gt;u.rt_next
op_assign
id|rt_hash_table
(braket
id|hash
)braket
suffix:semicolon
macro_line|#if RT_CACHE_DEBUG &gt;= 2
r_if
c_cond
(paren
id|rt-&gt;u.rt_next
)paren
(brace
r_struct
id|rtable
op_star
id|trt
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;rt_cache @%02x: %08x&quot;
comma
id|hash
comma
id|rt-&gt;rt_dst
)paren
suffix:semicolon
r_for
c_loop
(paren
id|trt
op_assign
id|rt-&gt;u.rt_next
suffix:semicolon
id|trt
suffix:semicolon
id|trt
op_assign
id|trt-&gt;u.rt_next
)paren
id|printk
c_func
(paren
l_string|&quot; . %08x&quot;
comma
id|trt-&gt;rt_dst
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
)brace
macro_line|#endif
id|rt_hash_table
(braket
id|hash
)braket
op_assign
id|rt
suffix:semicolon
id|atomic_inc
c_func
(paren
op_amp
id|rt_cache_size
)paren
suffix:semicolon
id|end_bh_atomic
c_func
(paren
)paren
suffix:semicolon
r_return
id|rt
suffix:semicolon
)brace
DECL|function|ip_rt_redirect
r_void
id|ip_rt_redirect
c_func
(paren
id|u32
id|old_gw
comma
id|u32
id|daddr
comma
id|u32
id|new_gw
comma
id|u32
id|saddr
comma
id|u8
id|tos
comma
r_struct
id|device
op_star
id|dev
)paren
(brace
r_int
id|i
comma
id|k
suffix:semicolon
r_struct
id|in_device
op_star
id|in_dev
op_assign
id|dev-&gt;ip_ptr
suffix:semicolon
r_struct
id|rtable
op_star
id|rth
comma
op_star
op_star
id|rthp
suffix:semicolon
id|u32
id|skeys
(braket
l_int|2
)braket
op_assign
(brace
id|saddr
comma
l_int|0
)brace
suffix:semicolon
r_int
id|ikeys
(braket
l_int|2
)braket
op_assign
(brace
id|dev-&gt;ifindex
comma
l_int|0
)brace
suffix:semicolon
id|tos
op_and_assign
id|IPTOS_TOS_MASK
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|in_dev
op_logical_or
id|new_gw
op_eq
id|old_gw
op_logical_or
op_logical_neg
id|IN_DEV_RX_REDIRECTS
c_func
(paren
id|in_dev
)paren
op_logical_or
id|MULTICAST
c_func
(paren
id|new_gw
)paren
op_logical_or
id|BADCLASS
c_func
(paren
id|new_gw
)paren
op_logical_or
id|ZERONET
c_func
(paren
id|new_gw
)paren
)paren
r_goto
id|reject_redirect
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|IN_DEV_SHARED_MEDIA
c_func
(paren
id|in_dev
)paren
)paren
(brace
r_if
c_cond
(paren
id|ip_fib_check_default
c_func
(paren
id|new_gw
comma
id|dev
)paren
)paren
r_goto
id|reject_redirect
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|inet_addr_type
c_func
(paren
id|new_gw
)paren
op_ne
id|RTN_UNICAST
)paren
r_goto
id|reject_redirect
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|2
suffix:semicolon
id|i
op_increment
)paren
(brace
r_for
c_loop
(paren
id|k
op_assign
l_int|0
suffix:semicolon
id|k
OL
l_int|2
suffix:semicolon
id|k
op_increment
)paren
(brace
r_int
id|hash
op_assign
id|rt_hash_code
c_func
(paren
id|daddr
comma
id|skeys
(braket
id|i
)braket
op_xor
(paren
id|ikeys
(braket
id|k
)braket
op_lshift
l_int|5
)paren
comma
id|tos
)paren
suffix:semicolon
id|rthp
op_assign
op_amp
id|rt_hash_table
(braket
id|hash
)braket
suffix:semicolon
r_while
c_loop
(paren
(paren
id|rth
op_assign
op_star
id|rthp
)paren
op_ne
l_int|NULL
)paren
(brace
r_struct
id|rtable
op_star
id|rt
suffix:semicolon
r_if
c_cond
(paren
id|rth-&gt;key.dst
op_ne
id|daddr
op_logical_or
id|rth-&gt;key.src
op_ne
id|skeys
(braket
id|i
)braket
op_logical_or
id|rth-&gt;key.tos
op_ne
id|tos
op_logical_or
id|rth-&gt;key.oif
op_ne
id|ikeys
(braket
id|k
)braket
op_logical_or
id|rth-&gt;key.iif
op_ne
l_int|0
)paren
(brace
id|rthp
op_assign
op_amp
id|rth-&gt;u.rt_next
suffix:semicolon
r_continue
suffix:semicolon
)brace
r_if
c_cond
(paren
id|rth-&gt;rt_dst
op_ne
id|daddr
op_logical_or
id|rth-&gt;rt_src
op_ne
id|saddr
op_logical_or
id|rth-&gt;u.dst.error
op_logical_or
id|rth-&gt;rt_gateway
op_ne
id|old_gw
op_logical_or
id|rth-&gt;u.dst.dev
op_ne
id|dev
)paren
r_break
suffix:semicolon
id|rt
op_assign
id|dst_alloc
c_func
(paren
r_sizeof
(paren
r_struct
id|rtable
)paren
comma
op_amp
id|ipv4_dst_ops
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rt
op_eq
l_int|NULL
)paren
r_return
suffix:semicolon
multiline_comment|/*&n;&t;&t;&t;&t; * Copy all the information.&n;&t;&t;&t;&t; */
op_star
id|rt
op_assign
op_star
id|rth
suffix:semicolon
id|atomic_set
c_func
(paren
op_amp
id|rt-&gt;u.dst.refcnt
comma
l_int|1
)paren
suffix:semicolon
id|atomic_set
c_func
(paren
op_amp
id|rt-&gt;u.dst.use
comma
l_int|1
)paren
suffix:semicolon
id|rt-&gt;u.dst.lastuse
op_assign
id|jiffies
suffix:semicolon
id|rt-&gt;u.dst.neighbour
op_assign
l_int|NULL
suffix:semicolon
id|rt-&gt;u.dst.hh
op_assign
l_int|NULL
suffix:semicolon
id|rt-&gt;rt_flags
op_or_assign
id|RTCF_REDIRECTED
suffix:semicolon
multiline_comment|/* Gateway is different ... */
id|rt-&gt;rt_gateway
op_assign
id|new_gw
suffix:semicolon
multiline_comment|/* Redirect received -&gt; path was valid */
id|dst_confirm
c_func
(paren
op_amp
id|rth-&gt;u.dst
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|arp_bind_neighbour
c_func
(paren
op_amp
id|rt-&gt;u.dst
)paren
op_logical_or
op_logical_neg
(paren
id|rt-&gt;u.dst.neighbour-&gt;nud_state
op_amp
id|NUD_VALID
)paren
)paren
(brace
r_if
c_cond
(paren
id|rt-&gt;u.dst.neighbour
)paren
id|neigh_event_send
c_func
(paren
id|rt-&gt;u.dst.neighbour
comma
l_int|NULL
)paren
suffix:semicolon
id|ip_rt_put
c_func
(paren
id|rt
)paren
suffix:semicolon
id|rt_free
c_func
(paren
id|rt
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
op_star
id|rthp
op_assign
id|rth-&gt;u.rt_next
suffix:semicolon
id|rt_free
c_func
(paren
id|rth
)paren
suffix:semicolon
id|rt
op_assign
id|rt_intern_hash
c_func
(paren
id|hash
comma
id|rt
comma
id|ETH_P_IP
)paren
suffix:semicolon
id|ip_rt_put
c_func
(paren
id|rt
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
)brace
r_return
suffix:semicolon
id|reject_redirect
suffix:colon
macro_line|#ifdef CONFIG_IP_ROUTE_VERBOSE
r_if
c_cond
(paren
id|ipv4_config.log_martians
op_logical_and
id|net_ratelimit
c_func
(paren
)paren
)paren
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;Redirect from %lX/%s to %lX ignored.&quot;
l_string|&quot;Path = %lX -&gt; %lX, tos %02x&bslash;n&quot;
comma
id|ntohl
c_func
(paren
id|old_gw
)paren
comma
id|dev-&gt;name
comma
id|ntohl
c_func
(paren
id|new_gw
)paren
comma
id|ntohl
c_func
(paren
id|saddr
)paren
comma
id|ntohl
c_func
(paren
id|daddr
)paren
comma
id|tos
)paren
suffix:semicolon
macro_line|#endif
)brace
DECL|function|ipv4_negative_advice
r_static
r_struct
id|dst_entry
op_star
id|ipv4_negative_advice
c_func
(paren
r_struct
id|dst_entry
op_star
id|dst
)paren
(brace
r_struct
id|rtable
op_star
id|rt
op_assign
(paren
r_struct
id|rtable
op_star
)paren
id|dst
suffix:semicolon
r_if
c_cond
(paren
id|rt
op_ne
l_int|NULL
)paren
(brace
r_if
c_cond
(paren
id|dst-&gt;obsolete
op_logical_or
id|rt-&gt;rt_flags
op_amp
id|RTCF_REDIRECTED
)paren
(brace
macro_line|#if RT_CACHE_DEBUG &gt;= 1
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;ip_rt_advice: redirect to %08x/%02x dropped&bslash;n&quot;
comma
id|rt-&gt;rt_dst
comma
id|rt-&gt;key.tos
)paren
suffix:semicolon
macro_line|#endif
id|ip_rt_put
c_func
(paren
id|rt
)paren
suffix:semicolon
id|rt_cache_flush
c_func
(paren
l_int|0
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
)brace
r_return
id|dst
suffix:semicolon
)brace
multiline_comment|/*&n; * Algorithm:&n; *&t;1. The first RT_REDIRECT_NUMBER redirects are sent&n; *&t;   with exponential backoff, then we stop sending them at all,&n; *&t;   assuming that the host ignores our redirects.&n; *&t;2. If we did not see packets requiring redirects&n; *&t;   during RT_REDIRECT_SILENCE, we assume that the host&n; *&t;   forgot redirected route and start to send redirects again.&n; *&n; * This algorithm is much cheaper and more intelligent than dumb load limiting&n; * in icmp.c.&n; *&n; * NOTE. Do not forget to inhibit load limiting for redirects (redundant)&n; * and &quot;frag. need&quot; (breaks PMTU discovery) in icmp.c.&n; */
DECL|function|ip_rt_send_redirect
r_void
id|ip_rt_send_redirect
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
)paren
(brace
r_struct
id|rtable
op_star
id|rt
op_assign
(paren
r_struct
id|rtable
op_star
)paren
id|skb-&gt;dst
suffix:semicolon
multiline_comment|/* No redirected packets during RT_REDIRECT_SILENCE;&n;&t; * reset the algorithm.&n;&t; */
r_if
c_cond
(paren
id|jiffies
op_minus
id|rt-&gt;last_error
OG
id|RT_REDIRECT_SILENCE
)paren
id|rt-&gt;errors
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Too many ignored redirects; do not send anything&n;&t; * set last_error to the last seen redirected packet.&n;&t; */
r_if
c_cond
(paren
id|rt-&gt;errors
op_ge
id|RT_REDIRECT_NUMBER
)paren
(brace
id|rt-&gt;last_error
op_assign
id|jiffies
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/* Check for load limit; set last_error to the latest sent&n;&t; * redirect.&n;&t; */
r_if
c_cond
(paren
id|jiffies
op_minus
id|rt-&gt;last_error
OG
(paren
id|RT_REDIRECT_LOAD
op_lshift
id|rt-&gt;errors
)paren
)paren
(brace
id|icmp_send
c_func
(paren
id|skb
comma
id|ICMP_REDIRECT
comma
id|ICMP_REDIR_HOST
comma
id|rt-&gt;rt_gateway
)paren
suffix:semicolon
id|rt-&gt;last_error
op_assign
id|jiffies
suffix:semicolon
op_increment
id|rt-&gt;errors
suffix:semicolon
macro_line|#ifdef CONFIG_IP_ROUTE_VERBOSE
r_if
c_cond
(paren
id|ipv4_config.log_martians
op_logical_and
id|rt-&gt;errors
op_eq
id|RT_REDIRECT_NUMBER
op_logical_and
id|net_ratelimit
c_func
(paren
)paren
)paren
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;host %08x/if%d ignores redirects for %08x to %08x.&bslash;n&quot;
comma
id|rt-&gt;rt_src
comma
id|rt-&gt;rt_iif
comma
id|rt-&gt;rt_dst
comma
id|rt-&gt;rt_gateway
)paren
suffix:semicolon
macro_line|#endif
)brace
)brace
DECL|function|ip_error
r_static
r_int
id|ip_error
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
)paren
(brace
r_struct
id|rtable
op_star
id|rt
op_assign
(paren
r_struct
id|rtable
op_star
)paren
id|skb-&gt;dst
suffix:semicolon
r_int
id|code
suffix:semicolon
r_switch
c_cond
(paren
id|rt-&gt;u.dst.error
)paren
(brace
r_case
id|EINVAL
suffix:colon
r_default
suffix:colon
id|kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
r_case
id|EHOSTUNREACH
suffix:colon
id|code
op_assign
id|ICMP_HOST_UNREACH
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ENETUNREACH
suffix:colon
id|code
op_assign
id|ICMP_NET_UNREACH
suffix:semicolon
r_break
suffix:semicolon
r_case
id|EACCES
suffix:colon
id|code
op_assign
id|ICMP_PKT_FILTERED
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|jiffies
op_minus
id|rt-&gt;last_error
OG
id|RT_ERROR_LOAD
)paren
(brace
id|icmp_send
c_func
(paren
id|skb
comma
id|ICMP_DEST_UNREACH
comma
id|code
comma
l_int|0
)paren
suffix:semicolon
id|rt-&gt;last_error
op_assign
id|jiffies
suffix:semicolon
)brace
id|kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;The last two values are not from the RFC but&n; *&t;are needed for AMPRnet AX.25 paths.&n; */
DECL|variable|mtu_plateau
r_static
r_int
r_int
id|mtu_plateau
(braket
)braket
op_assign
(brace
l_int|32000
comma
l_int|17914
comma
l_int|8166
comma
l_int|4352
comma
l_int|2002
comma
l_int|1492
comma
l_int|576
comma
l_int|296
comma
l_int|216
comma
l_int|128
)brace
suffix:semicolon
DECL|function|guess_mtu
r_static
id|__inline__
r_int
r_int
id|guess_mtu
c_func
(paren
r_int
r_int
id|old_mtu
)paren
(brace
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
r_sizeof
(paren
id|mtu_plateau
)paren
op_div
r_sizeof
(paren
id|mtu_plateau
(braket
l_int|0
)braket
)paren
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
id|old_mtu
OG
id|mtu_plateau
(braket
id|i
)braket
)paren
r_return
id|mtu_plateau
(braket
id|i
)braket
suffix:semicolon
r_return
l_int|68
suffix:semicolon
)brace
DECL|function|ip_rt_frag_needed
r_int
r_int
id|ip_rt_frag_needed
c_func
(paren
r_struct
id|iphdr
op_star
id|iph
comma
r_int
r_int
id|new_mtu
)paren
(brace
r_int
id|i
suffix:semicolon
r_int
r_int
id|old_mtu
op_assign
id|ntohs
c_func
(paren
id|iph-&gt;tot_len
)paren
suffix:semicolon
r_struct
id|rtable
op_star
id|rth
suffix:semicolon
id|u32
id|skeys
(braket
l_int|2
)braket
op_assign
(brace
id|iph-&gt;saddr
comma
l_int|0
comma
)brace
suffix:semicolon
id|u32
id|daddr
op_assign
id|iph-&gt;daddr
suffix:semicolon
id|u8
id|tos
op_assign
id|iph-&gt;tos
op_amp
id|IPTOS_TOS_MASK
suffix:semicolon
r_int
r_int
id|est_mtu
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|ipv4_config.no_pmtu_disc
)paren
r_return
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|2
suffix:semicolon
id|i
op_increment
)paren
(brace
r_int
id|hash
op_assign
id|rt_hash_code
c_func
(paren
id|daddr
comma
id|skeys
(braket
id|i
)braket
comma
id|tos
)paren
suffix:semicolon
r_for
c_loop
(paren
id|rth
op_assign
id|rt_hash_table
(braket
id|hash
)braket
suffix:semicolon
id|rth
suffix:semicolon
id|rth
op_assign
id|rth-&gt;u.rt_next
)paren
(brace
r_if
c_cond
(paren
id|rth-&gt;key.dst
op_eq
id|daddr
op_logical_and
id|rth-&gt;key.src
op_eq
id|skeys
(braket
id|i
)braket
op_logical_and
id|rth-&gt;rt_dst
op_eq
id|daddr
op_logical_and
id|rth-&gt;rt_src
op_eq
id|iph-&gt;saddr
op_logical_and
id|rth-&gt;key.tos
op_eq
id|tos
op_logical_and
id|rth-&gt;key.iif
op_eq
l_int|0
op_logical_and
op_logical_neg
(paren
id|rth-&gt;rt_flags
op_amp
id|RTCF_NOPMTUDISC
)paren
)paren
(brace
r_int
r_int
id|mtu
op_assign
id|new_mtu
suffix:semicolon
r_if
c_cond
(paren
id|new_mtu
OL
l_int|68
op_logical_or
id|new_mtu
op_ge
id|old_mtu
)paren
(brace
multiline_comment|/* BSD 4.2 compatibility hack :-( */
r_if
c_cond
(paren
id|mtu
op_eq
l_int|0
op_logical_and
id|old_mtu
op_ge
id|rth-&gt;u.dst.pmtu
op_logical_and
id|old_mtu
op_ge
l_int|68
op_plus
(paren
id|iph-&gt;ihl
op_lshift
l_int|2
)paren
)paren
id|old_mtu
op_sub_assign
id|iph-&gt;ihl
op_lshift
l_int|2
suffix:semicolon
id|mtu
op_assign
id|guess_mtu
c_func
(paren
id|old_mtu
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|mtu
OL
id|rth-&gt;u.dst.pmtu
)paren
(brace
multiline_comment|/* New mtu received -&gt; path was valid */
id|dst_confirm
c_func
(paren
op_amp
id|rth-&gt;u.dst
)paren
suffix:semicolon
id|rth-&gt;u.dst.pmtu
op_assign
id|mtu
suffix:semicolon
id|est_mtu
op_assign
id|mtu
suffix:semicolon
)brace
)brace
)brace
)brace
r_return
id|est_mtu
suffix:semicolon
)brace
DECL|function|ipv4_dst_check
r_static
r_struct
id|dst_entry
op_star
id|ipv4_dst_check
c_func
(paren
r_struct
id|dst_entry
op_star
id|dst
comma
id|u32
id|cookie
)paren
(brace
id|dst_release
c_func
(paren
id|dst
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
DECL|function|ipv4_dst_reroute
r_static
r_struct
id|dst_entry
op_star
id|ipv4_dst_reroute
c_func
(paren
r_struct
id|dst_entry
op_star
id|dst
comma
r_struct
id|sk_buff
op_star
id|skb
)paren
(brace
r_return
l_int|NULL
suffix:semicolon
)brace
DECL|function|ip_rt_bug
r_static
r_int
id|ip_rt_bug
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
)paren
(brace
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;ip_rt_bug: %08x -&gt; %08x, %s&bslash;n&quot;
comma
id|skb-&gt;nh.iph-&gt;saddr
comma
id|skb-&gt;nh.iph-&gt;daddr
comma
id|skb-&gt;dev
ques
c_cond
id|skb-&gt;dev-&gt;name
suffix:colon
l_string|&quot;?&quot;
)paren
suffix:semicolon
id|kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n;   We do not cache source address of outgoing interface,&n;   because it is used only by IP RR, TS and SRR options,&n;   so that it out of fast path.&n;&n;   BTW remember: &quot;addr&quot; is allowed to be not aligned&n;   in IP options!&n; */
DECL|function|ip_rt_get_source
r_void
id|ip_rt_get_source
c_func
(paren
id|u8
op_star
id|addr
comma
r_struct
id|rtable
op_star
id|rt
)paren
(brace
id|u32
id|src
suffix:semicolon
r_struct
id|fib_result
id|res
suffix:semicolon
r_if
c_cond
(paren
id|rt-&gt;key.iif
op_eq
l_int|0
)paren
(brace
id|memcpy
c_func
(paren
id|addr
comma
op_amp
id|rt-&gt;rt_src
comma
l_int|4
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|fib_lookup
c_func
(paren
op_amp
id|rt-&gt;key
comma
op_amp
id|res
)paren
op_eq
l_int|0
)paren
(brace
id|src
op_assign
id|FIB_RES_PREFSRC
c_func
(paren
id|res
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|addr
comma
op_amp
id|src
comma
l_int|4
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|src
op_assign
id|inet_select_addr
c_func
(paren
id|rt-&gt;u.dst.dev
comma
id|rt-&gt;rt_gateway
comma
id|RT_SCOPE_UNIVERSE
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|addr
comma
op_amp
id|src
comma
l_int|4
)paren
suffix:semicolon
)brace
r_static
r_int
DECL|function|ip_route_input_mc
id|ip_route_input_mc
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
id|u32
id|daddr
comma
id|u32
id|saddr
comma
id|u8
id|tos
comma
r_struct
id|device
op_star
id|dev
comma
r_int
id|our
)paren
(brace
r_int
id|hash
suffix:semicolon
r_struct
id|rtable
op_star
id|rth
suffix:semicolon
id|u32
id|spec_dst
suffix:semicolon
r_struct
id|in_device
op_star
id|in_dev
op_assign
id|dev-&gt;ip_ptr
suffix:semicolon
multiline_comment|/* Primary sanity checks. */
r_if
c_cond
(paren
id|MULTICAST
c_func
(paren
id|saddr
)paren
op_logical_or
id|BADCLASS
c_func
(paren
id|saddr
)paren
op_logical_or
id|LOOPBACK
c_func
(paren
id|saddr
)paren
op_logical_or
id|in_dev
op_eq
l_int|NULL
op_logical_or
id|skb-&gt;protocol
op_ne
id|__constant_htons
c_func
(paren
id|ETH_P_IP
)paren
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|ZERONET
c_func
(paren
id|saddr
)paren
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|LOCAL_MCAST
c_func
(paren
id|daddr
)paren
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|spec_dst
op_assign
id|inet_select_addr
c_func
(paren
id|dev
comma
l_int|0
comma
id|RT_SCOPE_LINK
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|fib_validate_source
c_func
(paren
id|saddr
comma
l_int|0
comma
id|tos
comma
l_int|0
comma
id|dev
comma
op_amp
id|spec_dst
)paren
OL
l_int|0
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|rth
op_assign
id|dst_alloc
c_func
(paren
r_sizeof
(paren
r_struct
id|rtable
)paren
comma
op_amp
id|ipv4_dst_ops
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|rth
)paren
r_return
op_minus
id|ENOBUFS
suffix:semicolon
id|rth-&gt;u.dst.output
op_assign
id|ip_rt_bug
suffix:semicolon
id|atomic_set
c_func
(paren
op_amp
id|rth-&gt;u.dst.use
comma
l_int|1
)paren
suffix:semicolon
id|rth-&gt;key.dst
op_assign
id|daddr
suffix:semicolon
id|rth-&gt;rt_dst
op_assign
id|daddr
suffix:semicolon
id|rth-&gt;key.tos
op_assign
id|tos
suffix:semicolon
id|rth-&gt;key.src
op_assign
id|saddr
suffix:semicolon
id|rth-&gt;rt_src
op_assign
id|saddr
suffix:semicolon
macro_line|#ifdef CONFIG_IP_ROUTE_NAT
id|rth-&gt;rt_dst_map
op_assign
id|daddr
suffix:semicolon
id|rth-&gt;rt_src_map
op_assign
id|saddr
suffix:semicolon
macro_line|#endif
id|rth-&gt;rt_iif
op_assign
id|rth-&gt;key.iif
op_assign
id|dev-&gt;ifindex
suffix:semicolon
id|rth-&gt;u.dst.dev
op_assign
op_amp
id|loopback_dev
suffix:semicolon
id|rth-&gt;key.oif
op_assign
l_int|0
suffix:semicolon
id|rth-&gt;rt_gateway
op_assign
id|daddr
suffix:semicolon
id|rth-&gt;rt_spec_dst
op_assign
id|spec_dst
suffix:semicolon
id|rth-&gt;rt_type
op_assign
id|RTN_MULTICAST
suffix:semicolon
id|rth-&gt;rt_flags
op_assign
id|RTCF_MULTICAST
suffix:semicolon
r_if
c_cond
(paren
id|our
)paren
(brace
id|rth-&gt;u.dst.input
op_assign
id|ip_local_deliver
suffix:semicolon
id|rth-&gt;rt_flags
op_or_assign
id|RTCF_LOCAL
suffix:semicolon
)brace
macro_line|#ifdef CONFIG_IP_MROUTE
r_if
c_cond
(paren
op_logical_neg
id|LOCAL_MCAST
c_func
(paren
id|daddr
)paren
op_logical_and
id|IN_DEV_MFORWARD
c_func
(paren
id|in_dev
)paren
)paren
id|rth-&gt;u.dst.input
op_assign
id|ip_mr_input
suffix:semicolon
macro_line|#endif
id|hash
op_assign
id|rt_hash_code
c_func
(paren
id|daddr
comma
id|saddr
op_xor
(paren
id|dev-&gt;ifindex
op_lshift
l_int|5
)paren
comma
id|tos
)paren
suffix:semicolon
id|skb-&gt;dst
op_assign
(paren
r_struct
id|dst_entry
op_star
)paren
id|rt_intern_hash
c_func
(paren
id|hash
comma
id|rth
comma
l_int|0
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;NOTE. We drop all the packets that has local source&n; *&t;addresses, because every properly looped back packet&n; *&t;must have correct destination already attached by output routine.&n; *&n; *&t;Such approach solves two big problems:&n; *&t;1. Not simplex devices are handled properly.&n; *&t;2. IP spoofing attempts are filtered with 100% of guarantee.&n; */
DECL|function|ip_route_input_slow
r_int
id|ip_route_input_slow
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
id|u32
id|daddr
comma
id|u32
id|saddr
comma
id|u8
id|tos
comma
r_struct
id|device
op_star
id|dev
)paren
(brace
r_struct
id|rt_key
id|key
suffix:semicolon
r_struct
id|fib_result
id|res
suffix:semicolon
r_struct
id|in_device
op_star
id|in_dev
op_assign
id|dev-&gt;ip_ptr
suffix:semicolon
r_struct
id|in_device
op_star
id|out_dev
suffix:semicolon
r_int
id|flags
op_assign
l_int|0
suffix:semicolon
r_struct
id|rtable
op_star
id|rth
suffix:semicolon
r_int
id|hash
suffix:semicolon
id|u32
id|spec_dst
suffix:semicolon
r_int
id|err
op_assign
op_minus
id|EINVAL
suffix:semicolon
multiline_comment|/*&n;&t; *&t;IP on this device is disabled.&n;&t; */
r_if
c_cond
(paren
op_logical_neg
id|in_dev
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|key.dst
op_assign
id|daddr
suffix:semicolon
id|key.src
op_assign
id|saddr
suffix:semicolon
id|key.tos
op_assign
id|tos
suffix:semicolon
id|key.iif
op_assign
id|dev-&gt;ifindex
suffix:semicolon
id|key.oif
op_assign
l_int|0
suffix:semicolon
id|key.scope
op_assign
id|RT_SCOPE_UNIVERSE
suffix:semicolon
id|hash
op_assign
id|rt_hash_code
c_func
(paren
id|daddr
comma
id|saddr
op_xor
(paren
id|key.iif
op_lshift
l_int|5
)paren
comma
id|tos
)paren
suffix:semicolon
multiline_comment|/* Check for the most weird martians, which can be not detected&n;&t;   by fib_lookup.&n;&t; */
r_if
c_cond
(paren
id|MULTICAST
c_func
(paren
id|saddr
)paren
op_logical_or
id|BADCLASS
c_func
(paren
id|saddr
)paren
op_logical_or
id|LOOPBACK
c_func
(paren
id|saddr
)paren
)paren
r_goto
id|martian_source
suffix:semicolon
r_if
c_cond
(paren
id|daddr
op_eq
l_int|0xFFFFFFFF
)paren
r_goto
id|brd_input
suffix:semicolon
multiline_comment|/* Accept zero addresses only to limited broadcast;&n;&t; * I even do not know to fix it or not. Waiting for complains :-)&n;&t; */
r_if
c_cond
(paren
id|ZERONET
c_func
(paren
id|saddr
)paren
)paren
r_goto
id|martian_source
suffix:semicolon
r_if
c_cond
(paren
id|BADCLASS
c_func
(paren
id|daddr
)paren
op_logical_or
id|ZERONET
c_func
(paren
id|daddr
)paren
op_logical_or
id|LOOPBACK
c_func
(paren
id|daddr
)paren
)paren
r_goto
id|martian_destination
suffix:semicolon
multiline_comment|/*&n;&t; *&t;Now we are ready to route packet.&n;&t; */
r_if
c_cond
(paren
(paren
id|err
op_assign
id|fib_lookup
c_func
(paren
op_amp
id|key
comma
op_amp
id|res
)paren
)paren
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|IN_DEV_FORWARD
c_func
(paren
id|in_dev
)paren
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_goto
id|no_route
suffix:semicolon
)brace
macro_line|#ifdef CONFIG_IP_ROUTE_NAT
multiline_comment|/* Policy is applied before mapping destination,&n;&t;   but rerouting after map should be made with old source.&n;&t; */
r_if
c_cond
(paren
l_int|1
)paren
(brace
id|u32
id|src_map
op_assign
id|saddr
suffix:semicolon
r_if
c_cond
(paren
id|res.r
)paren
id|src_map
op_assign
id|fib_rules_policy
c_func
(paren
id|saddr
comma
op_amp
id|res
comma
op_amp
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|res.type
op_eq
id|RTN_NAT
)paren
(brace
id|key.dst
op_assign
id|fib_rules_map_destination
c_func
(paren
id|daddr
comma
op_amp
id|res
)paren
suffix:semicolon
r_if
c_cond
(paren
id|fib_lookup
c_func
(paren
op_amp
id|key
comma
op_amp
id|res
)paren
op_logical_or
id|res.type
op_ne
id|RTN_UNICAST
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|flags
op_or_assign
id|RTCF_DNAT
suffix:semicolon
)brace
id|key.src
op_assign
id|src_map
suffix:semicolon
)brace
macro_line|#endif
r_if
c_cond
(paren
id|res.type
op_eq
id|RTN_BROADCAST
)paren
r_goto
id|brd_input
suffix:semicolon
r_if
c_cond
(paren
id|res.type
op_eq
id|RTN_LOCAL
)paren
(brace
id|spec_dst
op_assign
id|daddr
suffix:semicolon
r_if
c_cond
(paren
id|inet_addr_type
c_func
(paren
id|saddr
)paren
op_ne
id|RTN_UNICAST
)paren
r_goto
id|martian_source
suffix:semicolon
r_goto
id|local_input
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|IN_DEV_FORWARD
c_func
(paren
id|in_dev
)paren
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|res.type
op_ne
id|RTN_UNICAST
)paren
r_goto
id|martian_destination
suffix:semicolon
macro_line|#ifdef CONFIG_IP_ROUTE_MULTIPATH
r_if
c_cond
(paren
id|res.fi-&gt;fib_nhs
OG
l_int|1
op_logical_and
id|key.oif
op_eq
l_int|0
)paren
id|fib_select_multipath
c_func
(paren
op_amp
id|key
comma
op_amp
id|res
)paren
suffix:semicolon
macro_line|#endif
id|out_dev
op_assign
id|FIB_RES_DEV
c_func
(paren
id|res
)paren
op_member_access_from_pointer
id|ip_ptr
suffix:semicolon
id|err
op_assign
id|fib_validate_source
c_func
(paren
id|saddr
comma
id|daddr
comma
id|tos
comma
id|FIB_RES_OIF
c_func
(paren
id|res
)paren
comma
id|dev
comma
op_amp
id|spec_dst
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
OL
l_int|0
)paren
r_goto
id|martian_source
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
id|flags
op_or_assign
id|RTCF_DIRECTSRC
suffix:semicolon
r_if
c_cond
(paren
id|out_dev
op_eq
id|in_dev
op_logical_and
id|err
op_logical_and
op_logical_neg
(paren
id|flags
op_amp
id|RTCF_NAT
)paren
op_logical_and
(paren
id|IN_DEV_SHARED_MEDIA
c_func
(paren
id|out_dev
)paren
op_logical_or
id|inet_addr_onlink
c_func
(paren
id|out_dev
comma
id|saddr
comma
id|FIB_RES_GW
c_func
(paren
id|res
)paren
)paren
)paren
)paren
id|flags
op_or_assign
id|RTCF_DOREDIRECT
suffix:semicolon
r_if
c_cond
(paren
id|skb-&gt;protocol
op_ne
id|__constant_htons
c_func
(paren
id|ETH_P_IP
)paren
)paren
(brace
multiline_comment|/* Not IP (i.e. ARP). Do not make route for invalid&n;&t;&t; * destination AND it is not translated destination.&n;&t;&t; */
r_if
c_cond
(paren
id|out_dev
op_eq
id|in_dev
op_logical_and
op_logical_neg
(paren
id|flags
op_amp
id|RTCF_DNAT
)paren
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|rth
op_assign
id|dst_alloc
c_func
(paren
r_sizeof
(paren
r_struct
id|rtable
)paren
comma
op_amp
id|ipv4_dst_ops
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|rth
)paren
r_return
op_minus
id|ENOBUFS
suffix:semicolon
id|atomic_set
c_func
(paren
op_amp
id|rth-&gt;u.dst.use
comma
l_int|1
)paren
suffix:semicolon
id|rth-&gt;key.dst
op_assign
id|daddr
suffix:semicolon
id|rth-&gt;rt_dst
op_assign
id|daddr
suffix:semicolon
id|rth-&gt;key.tos
op_assign
id|tos
suffix:semicolon
id|rth-&gt;key.src
op_assign
id|saddr
suffix:semicolon
id|rth-&gt;rt_src
op_assign
id|saddr
suffix:semicolon
id|rth-&gt;rt_gateway
op_assign
id|daddr
suffix:semicolon
macro_line|#ifdef CONFIG_IP_ROUTE_NAT
id|rth-&gt;rt_src_map
op_assign
id|key.src
suffix:semicolon
id|rth-&gt;rt_dst_map
op_assign
id|key.dst
suffix:semicolon
r_if
c_cond
(paren
id|flags
op_amp
id|RTCF_DNAT
)paren
id|rth-&gt;rt_gateway
op_assign
id|key.dst
suffix:semicolon
macro_line|#endif
id|rth-&gt;rt_iif
op_assign
id|rth-&gt;key.iif
op_assign
id|dev-&gt;ifindex
suffix:semicolon
id|rth-&gt;u.dst.dev
op_assign
id|out_dev-&gt;dev
suffix:semicolon
id|rth-&gt;key.oif
op_assign
l_int|0
suffix:semicolon
id|rth-&gt;rt_spec_dst
op_assign
id|spec_dst
suffix:semicolon
id|rth-&gt;u.dst.input
op_assign
id|ip_forward
suffix:semicolon
id|rth-&gt;u.dst.output
op_assign
id|ip_output
suffix:semicolon
id|rth-&gt;u.dst.pmtu
op_assign
id|res.fi-&gt;fib_mtu
ques
c_cond
suffix:colon
id|out_dev-&gt;dev-&gt;mtu
suffix:semicolon
id|rth-&gt;u.dst.window
op_assign
id|res.fi-&gt;fib_window
ques
c_cond
suffix:colon
l_int|0
suffix:semicolon
id|rth-&gt;u.dst.rtt
op_assign
id|res.fi-&gt;fib_rtt
ques
c_cond
suffix:colon
id|TCP_TIMEOUT_INIT
suffix:semicolon
id|rth-&gt;u.dst.rate_last
op_assign
id|rth-&gt;u.dst.rate_tokens
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|FIB_RES_GW
c_func
(paren
id|res
)paren
op_logical_and
id|FIB_RES_NH
c_func
(paren
id|res
)paren
dot
id|nh_scope
op_eq
id|RT_SCOPE_LINK
)paren
id|rth-&gt;rt_gateway
op_assign
id|FIB_RES_GW
c_func
(paren
id|res
)paren
suffix:semicolon
id|rth-&gt;rt_flags
op_assign
id|flags
suffix:semicolon
id|rth-&gt;rt_type
op_assign
id|res.type
suffix:semicolon
macro_line|#ifdef CONFIG_NET_FASTROUTE
r_if
c_cond
(paren
id|netdev_fastroute
op_logical_and
op_logical_neg
(paren
id|flags
op_amp
(paren
id|RTCF_NAT
op_or
id|RTCF_MASQ
op_or
id|RTCF_DOREDIRECT
)paren
)paren
)paren
(brace
r_struct
id|device
op_star
id|odev
op_assign
id|rth-&gt;u.dst.dev
suffix:semicolon
r_if
c_cond
(paren
id|odev
op_ne
id|dev
op_logical_and
id|dev-&gt;accept_fastpath
op_logical_and
id|odev-&gt;mtu
op_ge
id|dev-&gt;mtu
op_logical_and
id|dev
op_member_access_from_pointer
id|accept_fastpath
c_func
(paren
id|dev
comma
op_amp
id|rth-&gt;u.dst
)paren
op_eq
l_int|0
)paren
id|rth-&gt;rt_flags
op_or_assign
id|RTCF_FAST
suffix:semicolon
)brace
macro_line|#endif
id|skb-&gt;dst
op_assign
(paren
r_struct
id|dst_entry
op_star
)paren
id|rt_intern_hash
c_func
(paren
id|hash
comma
id|rth
comma
id|ntohs
c_func
(paren
id|skb-&gt;protocol
)paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
id|brd_input
suffix:colon
r_if
c_cond
(paren
id|skb-&gt;protocol
op_ne
id|__constant_htons
c_func
(paren
id|ETH_P_IP
)paren
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|ZERONET
c_func
(paren
id|saddr
)paren
)paren
(brace
id|spec_dst
op_assign
id|inet_select_addr
c_func
(paren
id|dev
comma
l_int|0
comma
id|RT_SCOPE_LINK
)paren
suffix:semicolon
)brace
r_else
(brace
id|err
op_assign
id|fib_validate_source
c_func
(paren
id|saddr
comma
l_int|0
comma
id|tos
comma
l_int|0
comma
id|dev
comma
op_amp
id|spec_dst
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
OL
l_int|0
)paren
r_goto
id|martian_source
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
id|flags
op_or_assign
id|RTCF_DIRECTSRC
suffix:semicolon
)brace
id|flags
op_or_assign
id|RTCF_BROADCAST
suffix:semicolon
id|local_input
suffix:colon
id|rth
op_assign
id|dst_alloc
c_func
(paren
r_sizeof
(paren
r_struct
id|rtable
)paren
comma
op_amp
id|ipv4_dst_ops
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|rth
)paren
r_return
op_minus
id|ENOBUFS
suffix:semicolon
id|rth-&gt;u.dst.output
op_assign
id|ip_rt_bug
suffix:semicolon
id|atomic_set
c_func
(paren
op_amp
id|rth-&gt;u.dst.use
comma
l_int|1
)paren
suffix:semicolon
id|rth-&gt;key.dst
op_assign
id|daddr
suffix:semicolon
id|rth-&gt;rt_dst
op_assign
id|daddr
suffix:semicolon
id|rth-&gt;key.tos
op_assign
id|tos
suffix:semicolon
id|rth-&gt;key.src
op_assign
id|saddr
suffix:semicolon
id|rth-&gt;rt_src
op_assign
id|saddr
suffix:semicolon
macro_line|#ifdef CONFIG_IP_ROUTE_NAT
id|rth-&gt;rt_dst_map
op_assign
id|key.dst
suffix:semicolon
id|rth-&gt;rt_src_map
op_assign
id|key.src
suffix:semicolon
macro_line|#endif
id|rth-&gt;rt_iif
op_assign
id|rth-&gt;key.iif
op_assign
id|dev-&gt;ifindex
suffix:semicolon
id|rth-&gt;u.dst.dev
op_assign
op_amp
id|loopback_dev
suffix:semicolon
id|rth-&gt;key.oif
op_assign
l_int|0
suffix:semicolon
id|rth-&gt;rt_gateway
op_assign
id|daddr
suffix:semicolon
id|rth-&gt;rt_spec_dst
op_assign
id|spec_dst
suffix:semicolon
id|rth-&gt;u.dst.input
op_assign
id|ip_local_deliver
suffix:semicolon
r_if
c_cond
(paren
id|res.type
op_eq
id|RTN_UNREACHABLE
)paren
(brace
id|rth-&gt;u.dst.input
op_assign
id|ip_error
suffix:semicolon
id|rth-&gt;u.dst.error
op_assign
id|err
suffix:semicolon
)brace
id|rth-&gt;rt_flags
op_assign
id|flags
op_or
id|RTCF_LOCAL
suffix:semicolon
id|rth-&gt;rt_type
op_assign
id|res.type
suffix:semicolon
id|skb-&gt;dst
op_assign
(paren
r_struct
id|dst_entry
op_star
)paren
id|rt_intern_hash
c_func
(paren
id|hash
comma
id|rth
comma
l_int|0
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
id|no_route
suffix:colon
id|spec_dst
op_assign
id|inet_select_addr
c_func
(paren
id|dev
comma
l_int|0
comma
id|RT_SCOPE_UNIVERSE
)paren
suffix:semicolon
id|res.type
op_assign
id|RTN_UNREACHABLE
suffix:semicolon
r_goto
id|local_input
suffix:semicolon
multiline_comment|/*&n;&t; *&t;Do not cache martian addresses: they should be logged (RFC1812)&n;&t; */
id|martian_destination
suffix:colon
macro_line|#ifdef CONFIG_IP_ROUTE_VERBOSE
r_if
c_cond
(paren
id|ipv4_config.log_martians
op_logical_and
id|net_ratelimit
c_func
(paren
)paren
)paren
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;martian destination %08x from %08x, dev %s&bslash;n&quot;
comma
id|daddr
comma
id|saddr
comma
id|dev-&gt;name
)paren
suffix:semicolon
macro_line|#endif
r_return
op_minus
id|EINVAL
suffix:semicolon
id|martian_source
suffix:colon
macro_line|#ifdef CONFIG_IP_ROUTE_VERBOSE
r_if
c_cond
(paren
id|ipv4_config.log_martians
op_logical_and
id|net_ratelimit
c_func
(paren
)paren
)paren
(brace
multiline_comment|/*&n;&t;&t; *&t;RFC1812 recommenadtion, if source is martian,&n;&t;&t; *&t;the only hint is MAC header.&n;&t;&t; */
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;martian source %08x for %08x, dev %s&bslash;n&quot;
comma
id|saddr
comma
id|daddr
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;hard_header_len
)paren
(brace
r_int
id|i
suffix:semicolon
r_int
r_char
op_star
id|p
op_assign
id|skb-&gt;mac.raw
suffix:semicolon
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;ll header:&quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|dev-&gt;hard_header_len
suffix:semicolon
id|i
op_increment
comma
id|p
op_increment
)paren
id|printk
c_func
(paren
l_string|&quot; %02x&quot;
comma
op_star
id|p
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
)brace
)brace
macro_line|#endif
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
DECL|function|ip_route_input
r_int
id|ip_route_input
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
id|u32
id|daddr
comma
id|u32
id|saddr
comma
id|u8
id|tos
comma
r_struct
id|device
op_star
id|dev
)paren
(brace
r_struct
id|rtable
op_star
id|rth
suffix:semicolon
r_int
id|hash
suffix:semicolon
r_int
id|iif
op_assign
id|dev-&gt;ifindex
suffix:semicolon
id|tos
op_and_assign
id|IPTOS_TOS_MASK
suffix:semicolon
id|hash
op_assign
id|rt_hash_code
c_func
(paren
id|daddr
comma
id|saddr
op_xor
(paren
id|iif
op_lshift
l_int|5
)paren
comma
id|tos
)paren
suffix:semicolon
r_for
c_loop
(paren
id|rth
op_assign
id|rt_hash_table
(braket
id|hash
)braket
suffix:semicolon
id|rth
suffix:semicolon
id|rth
op_assign
id|rth-&gt;u.rt_next
)paren
(brace
r_if
c_cond
(paren
id|rth-&gt;key.dst
op_eq
id|daddr
op_logical_and
id|rth-&gt;key.src
op_eq
id|saddr
op_logical_and
id|rth-&gt;key.iif
op_eq
id|iif
op_logical_and
id|rth-&gt;key.oif
op_eq
l_int|0
op_logical_and
id|rth-&gt;key.tos
op_eq
id|tos
)paren
(brace
id|rth-&gt;u.dst.lastuse
op_assign
id|jiffies
suffix:semicolon
id|atomic_inc
c_func
(paren
op_amp
id|rth-&gt;u.dst.use
)paren
suffix:semicolon
id|atomic_inc
c_func
(paren
op_amp
id|rth-&gt;u.dst.refcnt
)paren
suffix:semicolon
id|skb-&gt;dst
op_assign
(paren
r_struct
id|dst_entry
op_star
)paren
id|rth
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
)brace
multiline_comment|/* Multicast recognition logic is moved from route cache to here.&n;&t;   The problem was that too many ethernet cards have broken/missing&n;&t;   hardware multicast filters :-( As result the host on multicasting&n;&t;   network acquires a lot of useless route cache entries, sort of&n;&t;   SDR messages from all the world. Now we try to get rid of them.&n;&t;   Really, provided software IP multicast filter is organized&n;&t;   reasonably (at least, hashed), it does not result in a slowdown&n;&t;   comparing with route cache reject entries.&n;&t;   Note, that multicast routers are not affected, because&n;&t;   route cache entry is created eventually.&n;&t; */
r_if
c_cond
(paren
id|MULTICAST
c_func
(paren
id|daddr
)paren
)paren
(brace
r_int
id|our
op_assign
id|ip_check_mc
c_func
(paren
id|dev
comma
id|daddr
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|our
macro_line|#ifdef CONFIG_IP_MROUTE
op_logical_and
(paren
id|LOCAL_MCAST
c_func
(paren
id|daddr
)paren
op_logical_or
op_logical_neg
id|dev-&gt;ip_ptr
op_logical_or
op_logical_neg
id|IN_DEV_MFORWARD
c_func
(paren
(paren
r_struct
id|in_device
op_star
)paren
id|dev-&gt;ip_ptr
)paren
)paren
macro_line|#endif
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_return
id|ip_route_input_mc
c_func
(paren
id|skb
comma
id|daddr
comma
id|saddr
comma
id|tos
comma
id|dev
comma
id|our
)paren
suffix:semicolon
)brace
r_return
id|ip_route_input_slow
c_func
(paren
id|skb
comma
id|daddr
comma
id|saddr
comma
id|tos
comma
id|dev
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Major route resolver routine.&n; */
DECL|function|ip_route_output_slow
r_int
id|ip_route_output_slow
c_func
(paren
r_struct
id|rtable
op_star
op_star
id|rp
comma
id|u32
id|daddr
comma
id|u32
id|saddr
comma
id|u32
id|tos
comma
r_int
id|oif
)paren
(brace
r_struct
id|rt_key
id|key
suffix:semicolon
r_struct
id|fib_result
id|res
suffix:semicolon
r_int
id|flags
op_assign
l_int|0
suffix:semicolon
r_struct
id|rtable
op_star
id|rth
suffix:semicolon
r_struct
id|device
op_star
id|dev_out
op_assign
l_int|NULL
suffix:semicolon
r_int
id|hash
suffix:semicolon
macro_line|#ifdef CONFIG_IP_TRANSPARENT_PROXY
id|u32
id|nochecksrc
op_assign
(paren
id|tos
op_amp
id|RTO_TPROXY
)paren
suffix:semicolon
macro_line|#endif
id|tos
op_and_assign
id|IPTOS_TOS_MASK
op_or
id|RTO_ONLINK
suffix:semicolon
id|key.dst
op_assign
id|daddr
suffix:semicolon
id|key.src
op_assign
id|saddr
suffix:semicolon
id|key.tos
op_assign
id|tos
op_amp
id|IPTOS_TOS_MASK
suffix:semicolon
id|key.iif
op_assign
id|loopback_dev.ifindex
suffix:semicolon
id|key.oif
op_assign
id|oif
suffix:semicolon
id|key.scope
op_assign
(paren
id|tos
op_amp
id|RTO_ONLINK
)paren
ques
c_cond
id|RT_SCOPE_LINK
suffix:colon
id|RT_SCOPE_UNIVERSE
suffix:semicolon
id|res.fi
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
id|saddr
)paren
(brace
r_if
c_cond
(paren
id|MULTICAST
c_func
(paren
id|saddr
)paren
op_logical_or
id|BADCLASS
c_func
(paren
id|saddr
)paren
op_logical_or
id|ZERONET
c_func
(paren
id|saddr
)paren
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
multiline_comment|/* It is equivalent to inet_addr_type(saddr) == RTN_LOCAL */
id|dev_out
op_assign
id|ip_dev_find
c_func
(paren
id|saddr
)paren
suffix:semicolon
macro_line|#ifdef CONFIG_IP_TRANSPARENT_PROXY
multiline_comment|/* If address is not local, test for transparent proxy flag;&n;&t;&t;   if address is local --- clear the flag.&n;&t;&t; */
r_if
c_cond
(paren
id|dev_out
op_eq
l_int|NULL
)paren
(brace
r_if
c_cond
(paren
id|nochecksrc
op_eq
l_int|0
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|flags
op_or_assign
id|RTCF_TPROXY
suffix:semicolon
)brace
macro_line|#else
r_if
c_cond
(paren
id|dev_out
op_eq
l_int|NULL
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
macro_line|#endif
multiline_comment|/* I removed check for oif == dev_out-&gt;oif here.&n;&t;&t;   It was wrong by three reasons:&n;&t;&t;   1. ip_dev_find(saddr) can return wrong iface, if saddr is&n;&t;&t;      assigned to multiple interfaces.&n;&t;&t;   2. Moreover, we are allowed to send packets with saddr&n;&t;&t;      of another iface. --ANK&n;&t;&t; */
r_if
c_cond
(paren
id|oif
op_eq
l_int|0
op_logical_and
macro_line|#ifdef CONFIG_IP_TRANSPARENT_PROXY
id|dev_out
op_logical_and
macro_line|#endif
(paren
id|MULTICAST
c_func
(paren
id|daddr
)paren
op_logical_or
id|daddr
op_eq
l_int|0xFFFFFFFF
)paren
)paren
(brace
multiline_comment|/* Special hack: user can direct multicasts&n;&t;&t;&t;   and limited broadcast via necessary interface&n;&t;&t;&t;   without fiddling with IP_MULTICAST_IF or IP_TXINFO.&n;&t;&t;&t;   This hack is not just for fun, it allows&n;&t;&t;&t;   vic,vat and friends to work.&n;&t;&t;&t;   They bind socket to loopback, set ttl to zero&n;&t;&t;&t;   and expect that it will work.&n;&t;&t;&t;   From the viewpoint of routing cache they are broken,&n;&t;&t;&t;   because we are not allowed to build multicast path&n;&t;&t;&t;   with loopback source addr (look, routing cache&n;&t;&t;&t;   cannot know, that ttl is zero, so that packet&n;&t;&t;&t;   will not leave this host and route is valid).&n;&t;&t;&t;   Luckily, this hack is good workaround.&n;&t;&t;&t; */
id|key.oif
op_assign
id|dev_out-&gt;ifindex
suffix:semicolon
r_goto
id|make_route
suffix:semicolon
)brace
id|dev_out
op_assign
l_int|NULL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|oif
)paren
(brace
id|dev_out
op_assign
id|dev_get_by_index
c_func
(paren
id|oif
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dev_out
op_eq
l_int|NULL
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
r_if
c_cond
(paren
id|dev_out-&gt;ip_ptr
op_eq
l_int|NULL
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
multiline_comment|/* Wrong error code */
r_if
c_cond
(paren
id|LOCAL_MCAST
c_func
(paren
id|daddr
)paren
op_logical_or
id|daddr
op_eq
l_int|0xFFFFFFFF
)paren
(brace
id|key.src
op_assign
id|inet_select_addr
c_func
(paren
id|dev_out
comma
l_int|0
comma
id|RT_SCOPE_LINK
)paren
suffix:semicolon
r_goto
id|make_route
suffix:semicolon
)brace
r_if
c_cond
(paren
id|MULTICAST
c_func
(paren
id|daddr
)paren
)paren
(brace
id|key.src
op_assign
id|inet_select_addr
c_func
(paren
id|dev_out
comma
l_int|0
comma
id|key.scope
)paren
suffix:semicolon
r_goto
id|make_route
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|daddr
)paren
id|key.src
op_assign
id|inet_select_addr
c_func
(paren
id|dev_out
comma
l_int|0
comma
id|RT_SCOPE_HOST
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|key.dst
)paren
(brace
id|key.dst
op_assign
id|key.src
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|key.dst
)paren
id|key.dst
op_assign
id|key.src
op_assign
id|htonl
c_func
(paren
id|INADDR_LOOPBACK
)paren
suffix:semicolon
id|dev_out
op_assign
op_amp
id|loopback_dev
suffix:semicolon
id|key.oif
op_assign
id|loopback_dev.ifindex
suffix:semicolon
id|flags
op_or_assign
id|RTCF_LOCAL
suffix:semicolon
r_goto
id|make_route
suffix:semicolon
)brace
r_if
c_cond
(paren
id|fib_lookup
c_func
(paren
op_amp
id|key
comma
op_amp
id|res
)paren
)paren
(brace
id|res.fi
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
id|oif
)paren
(brace
multiline_comment|/* Apparently, routing tables are wrong. Assume,&n;&t;&t;&t;   that the destination is on link.&n;&n;&t;&t;&t;   WHY? DW.&n;&t;&t;&t;   Because we are allowed to send to iface&n;&t;&t;&t;   even if it has NO routes and NO assigned&n;&t;&t;&t;   addresses. When oif is specified, routing&n;&t;&t;&t;   tables are looked up with only one purpose:&n;&t;&t;&t;   to catch if destination is gatewayed, rather than&n;&t;&t;&t;   direct. Moreover, if MSG_DONTROUTE is set,&n;&t;&t;&t;   we send packet, no matter of routing tables&n;&t;&t;&t;   of ifaddr state. --ANK&n;&n;&n;&t;&t;&t;   We could make it even if oif is unknown,&n;&t;&t;&t;   likely IPv6, but we do not.&n;&t;&t;&t; */
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;Dest not on link. Forcing...&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|key.src
op_eq
l_int|0
)paren
id|key.src
op_assign
id|inet_select_addr
c_func
(paren
id|dev_out
comma
l_int|0
comma
id|RT_SCOPE_LINK
)paren
suffix:semicolon
r_goto
id|make_route
suffix:semicolon
)brace
r_return
op_minus
id|ENETUNREACH
suffix:semicolon
)brace
r_if
c_cond
(paren
id|res.type
op_eq
id|RTN_NAT
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|key.src
)paren
(brace
id|key.src
op_assign
id|FIB_RES_PREFSRC
c_func
(paren
id|res
)paren
suffix:semicolon
macro_line|#ifdef CONFIG_IP_MULTIPLE_TABLES
multiline_comment|/*&n;&t;&t; * &quot;Stabilization&quot; of route.&n;&t;&t; * This step is necessary, if locally originated packets&n;&t;&t; * are subjected to policy routing, otherwise we could get&n;&t;&t; * route flapping.&n;&t;&t; */
r_if
c_cond
(paren
id|fib_lookup
c_func
(paren
op_amp
id|key
comma
op_amp
id|res
)paren
)paren
r_return
op_minus
id|ENETUNREACH
suffix:semicolon
macro_line|#endif
)brace
macro_line|#ifdef CONFIG_IP_ROUTE_MULTIPATH
r_if
c_cond
(paren
id|res.fi-&gt;fib_nhs
OG
l_int|1
op_logical_and
id|key.oif
op_eq
l_int|0
)paren
id|fib_select_multipath
c_func
(paren
op_amp
id|key
comma
op_amp
id|res
)paren
suffix:semicolon
macro_line|#endif
id|dev_out
op_assign
id|FIB_RES_DEV
c_func
(paren
id|res
)paren
suffix:semicolon
r_if
c_cond
(paren
id|res.type
op_eq
id|RTN_LOCAL
)paren
(brace
id|dev_out
op_assign
op_amp
id|loopback_dev
suffix:semicolon
id|key.oif
op_assign
id|dev_out-&gt;ifindex
suffix:semicolon
id|res.fi
op_assign
l_int|NULL
suffix:semicolon
id|flags
op_or_assign
id|RTCF_LOCAL
suffix:semicolon
)brace
id|key.oif
op_assign
id|dev_out-&gt;ifindex
suffix:semicolon
id|make_route
suffix:colon
r_if
c_cond
(paren
id|LOOPBACK
c_func
(paren
id|key.src
)paren
op_logical_and
op_logical_neg
(paren
id|dev_out-&gt;flags
op_amp
id|IFF_LOOPBACK
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;this guy talks to %08x from loopback&bslash;n&quot;
comma
id|key.dst
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|key.dst
op_eq
l_int|0xFFFFFFFF
)paren
id|res.type
op_assign
id|RTN_BROADCAST
suffix:semicolon
r_else
r_if
c_cond
(paren
id|MULTICAST
c_func
(paren
id|key.dst
)paren
)paren
id|res.type
op_assign
id|RTN_MULTICAST
suffix:semicolon
r_else
r_if
c_cond
(paren
id|BADCLASS
c_func
(paren
id|key.dst
)paren
op_logical_or
id|ZERONET
c_func
(paren
id|key.dst
)paren
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|res.type
op_eq
id|RTN_BROADCAST
)paren
(brace
id|flags
op_or_assign
id|RTCF_BROADCAST
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|dev_out-&gt;flags
op_amp
id|IFF_LOOPBACK
)paren
op_logical_and
id|dev_out-&gt;flags
op_amp
id|IFF_BROADCAST
)paren
id|flags
op_or_assign
id|RTCF_LOCAL
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|res.type
op_eq
id|RTN_MULTICAST
)paren
(brace
id|flags
op_or_assign
id|RTCF_MULTICAST
suffix:semicolon
r_if
c_cond
(paren
id|ip_check_mc
c_func
(paren
id|dev_out
comma
id|daddr
)paren
)paren
id|flags
op_or_assign
id|RTCF_LOCAL
suffix:semicolon
)brace
id|rth
op_assign
id|dst_alloc
c_func
(paren
r_sizeof
(paren
r_struct
id|rtable
)paren
comma
op_amp
id|ipv4_dst_ops
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|rth
)paren
r_return
op_minus
id|ENOBUFS
suffix:semicolon
id|atomic_set
c_func
(paren
op_amp
id|rth-&gt;u.dst.use
comma
l_int|1
)paren
suffix:semicolon
id|rth-&gt;key.dst
op_assign
id|daddr
suffix:semicolon
id|rth-&gt;key.tos
op_assign
id|tos
suffix:semicolon
id|rth-&gt;key.src
op_assign
id|saddr
suffix:semicolon
id|rth-&gt;key.iif
op_assign
l_int|0
suffix:semicolon
id|rth-&gt;key.oif
op_assign
id|oif
suffix:semicolon
id|rth-&gt;rt_dst
op_assign
id|key.dst
suffix:semicolon
id|rth-&gt;rt_src
op_assign
id|key.src
suffix:semicolon
macro_line|#ifdef CONFIG_IP_ROUTE_NAT
id|rth-&gt;rt_dst_map
op_assign
id|key.dst
suffix:semicolon
id|rth-&gt;rt_src_map
op_assign
id|key.src
suffix:semicolon
macro_line|#endif
id|rth-&gt;rt_iif
op_assign
id|dev_out-&gt;ifindex
suffix:semicolon
id|rth-&gt;u.dst.dev
op_assign
id|dev_out
suffix:semicolon
id|rth-&gt;rt_gateway
op_assign
id|key.dst
suffix:semicolon
id|rth-&gt;rt_spec_dst
op_assign
id|key.src
suffix:semicolon
id|rth-&gt;u.dst.output
op_assign
id|ip_output
suffix:semicolon
r_if
c_cond
(paren
id|flags
op_amp
id|RTCF_LOCAL
)paren
(brace
id|rth-&gt;u.dst.input
op_assign
id|ip_local_deliver
suffix:semicolon
id|rth-&gt;rt_spec_dst
op_assign
id|key.dst
suffix:semicolon
)brace
r_if
c_cond
(paren
id|flags
op_amp
(paren
id|RTCF_BROADCAST
op_or
id|RTCF_MULTICAST
)paren
)paren
(brace
id|rth-&gt;rt_spec_dst
op_assign
id|key.src
suffix:semicolon
r_if
c_cond
(paren
id|flags
op_amp
id|RTCF_LOCAL
op_logical_and
op_logical_neg
(paren
id|dev_out-&gt;flags
op_amp
id|IFF_LOOPBACK
)paren
)paren
id|rth-&gt;u.dst.output
op_assign
id|ip_mc_output
suffix:semicolon
macro_line|#ifdef CONFIG_IP_MROUTE
r_if
c_cond
(paren
id|res.type
op_eq
id|RTN_MULTICAST
op_logical_and
id|dev_out-&gt;ip_ptr
)paren
(brace
r_struct
id|in_device
op_star
id|in_dev
op_assign
id|dev_out-&gt;ip_ptr
suffix:semicolon
r_if
c_cond
(paren
id|IN_DEV_MFORWARD
c_func
(paren
id|in_dev
)paren
op_logical_and
op_logical_neg
id|LOCAL_MCAST
c_func
(paren
id|daddr
)paren
)paren
(brace
id|rth-&gt;u.dst.input
op_assign
id|ip_mr_input
suffix:semicolon
id|rth-&gt;u.dst.output
op_assign
id|ip_mc_output
suffix:semicolon
)brace
)brace
macro_line|#endif
)brace
r_if
c_cond
(paren
id|res.fi
)paren
(brace
r_if
c_cond
(paren
id|FIB_RES_GW
c_func
(paren
id|res
)paren
op_logical_and
id|FIB_RES_NH
c_func
(paren
id|res
)paren
dot
id|nh_scope
op_eq
id|RT_SCOPE_LINK
)paren
id|rth-&gt;rt_gateway
op_assign
id|FIB_RES_GW
c_func
(paren
id|res
)paren
suffix:semicolon
id|rth-&gt;u.dst.pmtu
op_assign
id|res.fi-&gt;fib_mtu
ques
c_cond
suffix:colon
id|dev_out-&gt;mtu
suffix:semicolon
id|rth-&gt;u.dst.window
op_assign
id|res.fi-&gt;fib_window
ques
c_cond
suffix:colon
l_int|0
suffix:semicolon
id|rth-&gt;u.dst.rtt
op_assign
id|res.fi-&gt;fib_rtt
ques
c_cond
suffix:colon
id|TCP_TIMEOUT_INIT
suffix:semicolon
)brace
r_else
(brace
id|rth-&gt;u.dst.pmtu
op_assign
id|dev_out-&gt;mtu
suffix:semicolon
id|rth-&gt;u.dst.window
op_assign
l_int|0
suffix:semicolon
id|rth-&gt;u.dst.rtt
op_assign
id|TCP_TIMEOUT_INIT
suffix:semicolon
)brace
id|rth-&gt;u.dst.rate_last
op_assign
id|rth-&gt;u.dst.rate_tokens
op_assign
l_int|0
suffix:semicolon
id|rth-&gt;rt_flags
op_assign
id|flags
suffix:semicolon
id|rth-&gt;rt_type
op_assign
id|res.type
suffix:semicolon
id|hash
op_assign
id|rt_hash_code
c_func
(paren
id|daddr
comma
id|saddr
op_xor
(paren
id|oif
op_lshift
l_int|5
)paren
comma
id|tos
)paren
suffix:semicolon
op_star
id|rp
op_assign
id|rt_intern_hash
c_func
(paren
id|hash
comma
id|rth
comma
id|ETH_P_IP
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|ip_route_output
r_int
id|ip_route_output
c_func
(paren
r_struct
id|rtable
op_star
op_star
id|rp
comma
id|u32
id|daddr
comma
id|u32
id|saddr
comma
id|u32
id|tos
comma
r_int
id|oif
)paren
(brace
r_int
id|hash
suffix:semicolon
r_struct
id|rtable
op_star
id|rth
suffix:semicolon
id|hash
op_assign
id|rt_hash_code
c_func
(paren
id|daddr
comma
id|saddr
op_xor
(paren
id|oif
op_lshift
l_int|5
)paren
comma
id|tos
)paren
suffix:semicolon
id|start_bh_atomic
c_func
(paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|rth
op_assign
id|rt_hash_table
(braket
id|hash
)braket
suffix:semicolon
id|rth
suffix:semicolon
id|rth
op_assign
id|rth-&gt;u.rt_next
)paren
(brace
r_if
c_cond
(paren
id|rth-&gt;key.dst
op_eq
id|daddr
op_logical_and
id|rth-&gt;key.src
op_eq
id|saddr
op_logical_and
id|rth-&gt;key.iif
op_eq
l_int|0
op_logical_and
id|rth-&gt;key.oif
op_eq
id|oif
op_logical_and
macro_line|#ifndef CONFIG_IP_TRANSPARENT_PROXY
id|rth-&gt;key.tos
op_eq
id|tos
macro_line|#else
op_logical_neg
(paren
(paren
id|rth-&gt;key.tos
op_xor
id|tos
)paren
op_amp
(paren
id|IPTOS_TOS_MASK
op_or
id|RTO_ONLINK
)paren
)paren
op_logical_and
(paren
(paren
id|tos
op_amp
id|RTO_TPROXY
)paren
op_logical_or
op_logical_neg
(paren
id|rth-&gt;rt_flags
op_amp
id|RTCF_TPROXY
)paren
)paren
macro_line|#endif
)paren
(brace
id|rth-&gt;u.dst.lastuse
op_assign
id|jiffies
suffix:semicolon
id|atomic_inc
c_func
(paren
op_amp
id|rth-&gt;u.dst.use
)paren
suffix:semicolon
id|atomic_inc
c_func
(paren
op_amp
id|rth-&gt;u.dst.refcnt
)paren
suffix:semicolon
id|end_bh_atomic
c_func
(paren
)paren
suffix:semicolon
op_star
id|rp
op_assign
id|rth
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
)brace
id|end_bh_atomic
c_func
(paren
)paren
suffix:semicolon
r_return
id|ip_route_output_slow
c_func
(paren
id|rp
comma
id|daddr
comma
id|saddr
comma
id|tos
comma
id|oif
)paren
suffix:semicolon
)brace
macro_line|#ifdef CONFIG_RTNETLINK
DECL|function|inet_rtm_getroute
r_int
id|inet_rtm_getroute
c_func
(paren
r_struct
id|sk_buff
op_star
id|in_skb
comma
r_struct
id|nlmsghdr
op_star
id|nlh
comma
r_void
op_star
id|arg
)paren
(brace
r_struct
id|kern_rta
op_star
id|rta
op_assign
id|arg
suffix:semicolon
r_struct
id|rtmsg
op_star
id|rtm
op_assign
id|NLMSG_DATA
c_func
(paren
id|nlh
)paren
suffix:semicolon
r_struct
id|rtable
op_star
id|rt
op_assign
l_int|NULL
suffix:semicolon
id|u32
id|dst
op_assign
l_int|0
suffix:semicolon
id|u32
id|src
op_assign
l_int|0
suffix:semicolon
r_int
id|err
suffix:semicolon
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
r_struct
id|rta_cacheinfo
id|ci
suffix:semicolon
id|u8
op_star
id|o
suffix:semicolon
id|skb
op_assign
id|alloc_skb
c_func
(paren
id|NLMSG_GOODSIZE
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|skb
op_eq
l_int|NULL
)paren
r_return
op_minus
id|ENOBUFS
suffix:semicolon
multiline_comment|/* Reserve room for dummy headers, this skb can pass&n;&t;   through good chunk of routing engine.&n;&t; */
id|skb-&gt;mac.raw
op_assign
id|skb-&gt;data
suffix:semicolon
id|skb_reserve
c_func
(paren
id|skb
comma
id|MAX_HEADER
op_plus
r_sizeof
(paren
r_struct
id|iphdr
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rta-&gt;rta_dst
)paren
id|memcpy
c_func
(paren
op_amp
id|dst
comma
id|rta-&gt;rta_dst
comma
l_int|4
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rta-&gt;rta_src
)paren
id|memcpy
c_func
(paren
op_amp
id|src
comma
id|rta-&gt;rta_src
comma
l_int|4
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rta-&gt;rta_iif
)paren
(brace
r_struct
id|device
op_star
id|dev
suffix:semicolon
id|dev
op_assign
id|dev_get_by_index
c_func
(paren
op_star
id|rta-&gt;rta_iif
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dev
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
id|skb-&gt;protocol
op_assign
id|__constant_htons
c_func
(paren
id|ETH_P_IP
)paren
suffix:semicolon
id|skb-&gt;dev
op_assign
id|dev
suffix:semicolon
id|start_bh_atomic
c_func
(paren
)paren
suffix:semicolon
id|err
op_assign
id|ip_route_input
c_func
(paren
id|skb
comma
id|dst
comma
id|src
comma
id|rtm-&gt;rtm_tos
comma
id|dev
)paren
suffix:semicolon
id|end_bh_atomic
c_func
(paren
)paren
suffix:semicolon
id|rt
op_assign
(paren
r_struct
id|rtable
op_star
)paren
id|skb-&gt;dst
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|err
op_logical_and
id|rt-&gt;u.dst.error
)paren
id|err
op_assign
id|rt-&gt;u.dst.error
suffix:semicolon
)brace
r_else
(brace
id|err
op_assign
id|ip_route_output
c_func
(paren
op_amp
id|rt
comma
id|dst
comma
id|src
comma
id|rtm-&gt;rtm_tos
comma
id|rta-&gt;rta_oif
ques
c_cond
op_star
id|rta-&gt;rta_oif
suffix:colon
l_int|0
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|err
)paren
(brace
id|kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
id|skb-&gt;dst
op_assign
op_amp
id|rt-&gt;u.dst
suffix:semicolon
r_if
c_cond
(paren
id|rtm-&gt;rtm_flags
op_amp
id|RTM_F_NOTIFY
)paren
id|rt-&gt;rt_flags
op_or_assign
id|RTCF_NOTIFY
suffix:semicolon
id|nlh
op_assign
id|NLMSG_PUT
c_func
(paren
id|skb
comma
id|NETLINK_CB
c_func
(paren
id|in_skb
)paren
dot
id|pid
comma
id|nlh-&gt;nlmsg_seq
comma
id|RTM_NEWROUTE
comma
r_sizeof
(paren
op_star
id|rtm
)paren
)paren
suffix:semicolon
id|rtm
op_assign
id|NLMSG_DATA
c_func
(paren
id|nlh
)paren
suffix:semicolon
id|nlh-&gt;nlmsg_flags
op_assign
l_int|0
suffix:semicolon
id|rtm-&gt;rtm_family
op_assign
id|AF_INET
suffix:semicolon
id|rtm-&gt;rtm_dst_len
op_assign
l_int|32
suffix:semicolon
id|rtm-&gt;rtm_src_len
op_assign
l_int|32
suffix:semicolon
id|rtm-&gt;rtm_tos
op_assign
id|rt-&gt;key.tos
suffix:semicolon
id|rtm-&gt;rtm_table
op_assign
id|RT_TABLE_MAIN
suffix:semicolon
id|rtm-&gt;rtm_type
op_assign
id|rt-&gt;rt_type
suffix:semicolon
id|rtm-&gt;rtm_scope
op_assign
id|RT_SCOPE_UNIVERSE
suffix:semicolon
id|rtm-&gt;rtm_protocol
op_assign
id|RTPROT_UNSPEC
suffix:semicolon
id|rtm-&gt;rtm_flags
op_assign
(paren
id|rt-&gt;rt_flags
op_amp
op_complement
l_int|0xFFFF
)paren
op_or
id|RTM_F_CLONED
suffix:semicolon
id|rtm-&gt;rtm_nhs
op_assign
l_int|0
suffix:semicolon
id|o
op_assign
id|skb-&gt;tail
suffix:semicolon
id|RTA_PUT
c_func
(paren
id|skb
comma
id|RTA_DST
comma
l_int|4
comma
op_amp
id|rt-&gt;rt_dst
)paren
suffix:semicolon
id|RTA_PUT
c_func
(paren
id|skb
comma
id|RTA_SRC
comma
l_int|4
comma
op_amp
id|rt-&gt;rt_src
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rt-&gt;u.dst.dev
)paren
id|RTA_PUT
c_func
(paren
id|skb
comma
id|RTA_OIF
comma
r_sizeof
(paren
r_int
)paren
comma
op_amp
id|rt-&gt;u.dst.dev-&gt;ifindex
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rt-&gt;rt_dst
op_ne
id|rt-&gt;rt_gateway
)paren
id|RTA_PUT
c_func
(paren
id|skb
comma
id|RTA_GATEWAY
comma
l_int|4
comma
op_amp
id|rt-&gt;rt_gateway
)paren
suffix:semicolon
id|RTA_PUT
c_func
(paren
id|skb
comma
id|RTA_MTU
comma
r_sizeof
(paren
r_int
)paren
comma
op_amp
id|rt-&gt;u.dst.pmtu
)paren
suffix:semicolon
id|RTA_PUT
c_func
(paren
id|skb
comma
id|RTA_WINDOW
comma
r_sizeof
(paren
r_int
)paren
comma
op_amp
id|rt-&gt;u.dst.window
)paren
suffix:semicolon
id|RTA_PUT
c_func
(paren
id|skb
comma
id|RTA_RTT
comma
r_sizeof
(paren
r_int
)paren
comma
op_amp
id|rt-&gt;u.dst.rtt
)paren
suffix:semicolon
id|RTA_PUT
c_func
(paren
id|skb
comma
id|RTA_PREFSRC
comma
l_int|4
comma
op_amp
id|rt-&gt;rt_spec_dst
)paren
suffix:semicolon
id|ci.rta_lastuse
op_assign
id|jiffies
op_minus
id|rt-&gt;u.dst.lastuse
suffix:semicolon
id|ci.rta_used
op_assign
id|atomic_read
c_func
(paren
op_amp
id|rt-&gt;u.dst.refcnt
)paren
suffix:semicolon
id|ci.rta_clntref
op_assign
id|atomic_read
c_func
(paren
op_amp
id|rt-&gt;u.dst.use
)paren
suffix:semicolon
id|ci.rta_expires
op_assign
l_int|0
suffix:semicolon
id|ci.rta_error
op_assign
id|rt-&gt;u.dst.error
suffix:semicolon
id|RTA_PUT
c_func
(paren
id|skb
comma
id|RTA_CACHEINFO
comma
r_sizeof
(paren
id|ci
)paren
comma
op_amp
id|ci
)paren
suffix:semicolon
id|rtm-&gt;rtm_optlen
op_assign
id|skb-&gt;tail
op_minus
id|o
suffix:semicolon
r_if
c_cond
(paren
id|rta-&gt;rta_iif
)paren
(brace
macro_line|#ifdef CONFIG_IP_MROUTE
r_if
c_cond
(paren
id|MULTICAST
c_func
(paren
id|dst
)paren
op_logical_and
op_logical_neg
id|LOCAL_MCAST
c_func
(paren
id|dst
)paren
op_logical_and
id|ipv4_config.multicast_route
)paren
(brace
id|NETLINK_CB
c_func
(paren
id|skb
)paren
dot
id|pid
op_assign
id|NETLINK_CB
c_func
(paren
id|in_skb
)paren
dot
id|pid
suffix:semicolon
id|err
op_assign
id|ipmr_get_route
c_func
(paren
id|skb
comma
id|rtm
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
op_le
l_int|0
)paren
r_return
id|err
suffix:semicolon
)brace
r_else
macro_line|#endif
(brace
id|RTA_PUT
c_func
(paren
id|skb
comma
id|RTA_IIF
comma
l_int|4
comma
id|rta-&gt;rta_iif
)paren
suffix:semicolon
id|rtm-&gt;rtm_optlen
op_assign
id|skb-&gt;tail
op_minus
id|o
suffix:semicolon
)brace
)brace
id|nlh-&gt;nlmsg_len
op_assign
id|skb-&gt;tail
op_minus
(paren
id|u8
op_star
)paren
id|nlh
suffix:semicolon
id|err
op_assign
id|netlink_unicast
c_func
(paren
id|rtnl
comma
id|skb
comma
id|NETLINK_CB
c_func
(paren
id|in_skb
)paren
dot
id|pid
comma
id|MSG_DONTWAIT
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
OL
l_int|0
)paren
r_return
id|err
suffix:semicolon
r_return
l_int|0
suffix:semicolon
id|nlmsg_failure
suffix:colon
id|rtattr_failure
suffix:colon
id|kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
r_return
op_minus
id|EMSGSIZE
suffix:semicolon
)brace
macro_line|#endif /* CONFIG_RTNETLINK */
DECL|function|ip_rt_multicast_event
r_void
id|ip_rt_multicast_event
c_func
(paren
r_struct
id|in_device
op_star
id|in_dev
)paren
(brace
id|rt_cache_flush
c_func
(paren
l_int|1
op_star
id|HZ
)paren
suffix:semicolon
)brace
DECL|function|__initfunc
id|__initfunc
c_func
(paren
r_void
id|ip_rt_init
c_func
(paren
r_void
)paren
)paren
(brace
id|devinet_init
c_func
(paren
)paren
suffix:semicolon
id|ip_fib_init
c_func
(paren
)paren
suffix:semicolon
id|rt_periodic_timer.function
op_assign
id|rt_check_expire
suffix:semicolon
multiline_comment|/* All the timers, started at system startup tend&n;&t;   to synchronize. Perturb it a bit.&n;&t; */
id|rt_periodic_timer.expires
op_assign
id|jiffies
op_plus
id|net_random
c_func
(paren
)paren
op_mod
id|RT_GC_INTERVAL
op_plus
id|RT_GC_INTERVAL
suffix:semicolon
id|add_timer
c_func
(paren
op_amp
id|rt_periodic_timer
)paren
suffix:semicolon
macro_line|#ifdef CONFIG_PROC_FS
id|proc_net_register
c_func
(paren
op_amp
(paren
r_struct
id|proc_dir_entry
)paren
(brace
id|PROC_NET_RTCACHE
comma
l_int|8
comma
l_string|&quot;rt_cache&quot;
comma
id|S_IFREG
op_or
id|S_IRUGO
comma
l_int|1
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
op_amp
id|proc_net_inode_operations
comma
id|rt_cache_get_info
)brace
)paren
suffix:semicolon
macro_line|#endif
)brace
eof
