multiline_comment|/*&n; *&t;&t;IP_MASQ_FTP CUSeeMe masquerading module&n; *&n; *&n; * Version:&t;@(#)$Id: ip_masq_cuseeme.c,v 1.3 1998/08/29 23:51:18 davem Exp $&n; *&n; * Author:&t;Richard Lynch&n; *&t;&t;&n; *&n; * Fixes:&n; *&t;Richard Lynch     &t;:&t;Updated patch to conform to new module&n; *&t;&t;&t;&t;&t;specifications&n; *&t;Nigel Metheringham&t;:&t;Multiple port support&n; *&t;Michael Owings&t;&t;:&t;Fixed broken init code&n; *&t;&t;&t;&t;&t;Added code to update inbound&n; *&t;&t;&t;&t;&t;packets with correct local addresses.&n; *&t;&t;&t;&t;&t;Fixes audio and &quot;chat&quot; problems&n; *&t;&t;&t;&t;&t;Thanx to the CU-SeeMe Consortium for&n; *&t;&t;&t;&t;&t;technical docs&n; *&t;Steven Clarke&t;&t;:&t;Small changes for 2.1&t;&n; *&n; *&n; *&n; *&t;This program is free software; you can redistribute it and/or&n; *&t;modify it under the terms of the GNU General Public License&n; *&t;as published by the Free Software Foundation; either version&n; *&t;2 of the License, or (at your option) any later version.&n; *&t;&n; * Multiple Port Support&n; *&t;The helper can be made to handle up to MAX_MASQ_APP_PORTS (normally 12)&n; *&t;with the port numbers being defined at module load time.  The module&n; *&t;uses the symbol &quot;ports&quot; to define a list of monitored ports, which can&n; *&t;be specified on the insmod command line as&n; *&t;&t;ports=x1,x2,x3...&n; *&t;where x[n] are integer port numbers.  This option can be put into&n; *&t;/etc/conf.modules (or /etc/modules.conf depending on your config)&n; *&t;where modload will pick it up should you use modload to load your&n; *&t;modules.&n; *&t;&n; */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;asm/system.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/skbuff.h&gt;
macro_line|#include &lt;linux/in.h&gt;
macro_line|#include &lt;linux/ip.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;net/protocol.h&gt;
macro_line|#include &lt;net/udp.h&gt;
multiline_comment|/* #define IP_MASQ_NDEBUG */
macro_line|#include &lt;net/ip_masq.h&gt;
macro_line|#pragma pack(1)
multiline_comment|/* CU-SeeMe Data Header */
r_typedef
r_struct
(brace
DECL|member|dest_family
id|u_short
id|dest_family
suffix:semicolon
DECL|member|dest_port
id|u_short
id|dest_port
suffix:semicolon
DECL|member|dest_addr
id|u_long
id|dest_addr
suffix:semicolon
DECL|member|family
r_int
id|family
suffix:semicolon
DECL|member|port
id|u_short
id|port
suffix:semicolon
DECL|member|addr
id|u_long
id|addr
suffix:semicolon
DECL|member|seq
id|u_long
id|seq
suffix:semicolon
DECL|member|msg
id|u_short
id|msg
suffix:semicolon
DECL|member|data_type
id|u_short
id|data_type
suffix:semicolon
DECL|member|packet_len
id|u_short
id|packet_len
suffix:semicolon
DECL|typedef|cu_header
)brace
id|cu_header
suffix:semicolon
multiline_comment|/* Open Continue Header */
r_typedef
r_struct
(brace
DECL|member|cu_head
id|cu_header
id|cu_head
suffix:semicolon
DECL|member|client_count
id|u_short
id|client_count
suffix:semicolon
multiline_comment|/* Number of client info structs */
DECL|member|seq_no
id|u_long
id|seq_no
suffix:semicolon
DECL|member|user_name
r_char
id|user_name
(braket
l_int|20
)braket
suffix:semicolon
DECL|member|stuff
r_char
id|stuff
(braket
l_int|4
)braket
suffix:semicolon
multiline_comment|/* flags,  version stuff,  etc */
DECL|typedef|oc_header
)brace
id|oc_header
suffix:semicolon
multiline_comment|/* client info structures */
r_typedef
r_struct
(brace
DECL|member|address
id|u_long
id|address
suffix:semicolon
multiline_comment|/* Client address */
DECL|member|stuff
r_char
id|stuff
(braket
l_int|8
)braket
suffix:semicolon
multiline_comment|/* Flags, pruning bitfield,  packet counts etc */
DECL|typedef|client_info
)brace
id|client_info
suffix:semicolon
macro_line|#pragma pack()
multiline_comment|/*&n; * List of ports (up to MAX_MASQ_APP_PORTS) to be handled by helper&n; * First port is set to the default port.&n; */
DECL|variable|ports
r_static
r_int
id|ports
(braket
id|MAX_MASQ_APP_PORTS
)braket
op_assign
(brace
l_int|7648
)brace
suffix:semicolon
multiline_comment|/* I rely on the trailing items being set to zero */
DECL|variable|masq_incarnations
r_struct
id|ip_masq_app
op_star
id|masq_incarnations
(braket
id|MAX_MASQ_APP_PORTS
)braket
suffix:semicolon
multiline_comment|/*&n; *     Debug level&n; */
macro_line|#ifdef CONFIG_IP_MASQ_DEBUG
DECL|variable|debug
r_static
r_int
id|debug
op_assign
l_int|0
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|debug
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
macro_line|#endif
id|MODULE_PARM
c_func
(paren
id|ports
comma
l_string|&quot;1-&quot;
id|__MODULE_STRING
c_func
(paren
id|MAX_MASQ_APP_PORTS
)paren
l_string|&quot;i&quot;
)paren
suffix:semicolon
r_static
r_int
DECL|function|masq_cuseeme_init_1
id|masq_cuseeme_init_1
(paren
r_struct
id|ip_masq_app
op_star
id|mapp
comma
r_struct
id|ip_masq
op_star
id|ms
)paren
(brace
id|MOD_INC_USE_COUNT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_int
DECL|function|masq_cuseeme_done_1
id|masq_cuseeme_done_1
(paren
r_struct
id|ip_masq_app
op_star
id|mapp
comma
r_struct
id|ip_masq
op_star
id|ms
)paren
(brace
id|MOD_DEC_USE_COUNT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_int
DECL|function|masq_cuseeme_out
id|masq_cuseeme_out
(paren
r_struct
id|ip_masq_app
op_star
id|mapp
comma
r_struct
id|ip_masq
op_star
id|ms
comma
r_struct
id|sk_buff
op_star
op_star
id|skb_p
comma
id|__u32
id|maddr
)paren
(brace
r_struct
id|sk_buff
op_star
id|skb
op_assign
op_star
id|skb_p
suffix:semicolon
r_struct
id|iphdr
op_star
id|iph
op_assign
id|skb-&gt;nh.iph
suffix:semicolon
r_struct
id|udphdr
op_star
id|uh
op_assign
(paren
r_struct
id|udphdr
op_star
)paren
op_amp
(paren
(paren
(paren
r_char
op_star
)paren
id|iph
)paren
(braket
id|iph-&gt;ihl
op_star
l_int|4
)braket
)paren
suffix:semicolon
id|cu_header
op_star
id|cu_head
suffix:semicolon
r_char
op_star
id|data
op_assign
(paren
r_char
op_star
)paren
op_amp
id|uh
(braket
l_int|1
)braket
suffix:semicolon
r_if
c_cond
(paren
id|skb-&gt;len
op_minus
(paren
(paren
r_int
r_char
op_star
)paren
id|data
op_minus
id|skb-&gt;h.raw
)paren
op_ge
r_sizeof
(paren
id|cu_header
)paren
)paren
(brace
id|cu_head
op_assign
(paren
id|cu_header
op_star
)paren
id|data
suffix:semicolon
multiline_comment|/* cu_head-&gt;port   = ms-&gt;mport; */
r_if
c_cond
(paren
id|cu_head-&gt;addr
)paren
(brace
id|cu_head-&gt;addr
op_assign
(paren
id|u_long
)paren
id|maddr
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ntohs
c_func
(paren
id|cu_head-&gt;data_type
)paren
op_eq
l_int|257
)paren
(brace
id|IP_MASQ_DEBUG
c_func
(paren
l_int|1
op_minus
id|debug
comma
l_string|&quot;Sending talk packet!&bslash;n&quot;
)paren
suffix:semicolon
)brace
)brace
r_return
l_int|0
suffix:semicolon
)brace
r_int
DECL|function|masq_cuseeme_in
id|masq_cuseeme_in
(paren
r_struct
id|ip_masq_app
op_star
id|mapp
comma
r_struct
id|ip_masq
op_star
id|ms
comma
r_struct
id|sk_buff
op_star
op_star
id|skb_p
comma
id|__u32
id|maddr
)paren
(brace
r_struct
id|sk_buff
op_star
id|skb
op_assign
op_star
id|skb_p
suffix:semicolon
r_struct
id|iphdr
op_star
id|iph
op_assign
id|skb-&gt;nh.iph
suffix:semicolon
r_struct
id|udphdr
op_star
id|uh
op_assign
(paren
r_struct
id|udphdr
op_star
)paren
op_amp
(paren
(paren
(paren
r_char
op_star
)paren
id|iph
)paren
(braket
id|iph-&gt;ihl
op_star
l_int|4
)braket
)paren
suffix:semicolon
id|cu_header
op_star
id|cu_head
suffix:semicolon
id|oc_header
op_star
id|oc
suffix:semicolon
id|client_info
op_star
id|ci
suffix:semicolon
r_char
op_star
id|data
op_assign
(paren
r_char
op_star
)paren
op_amp
id|uh
(braket
l_int|1
)braket
suffix:semicolon
id|u_short
id|len
op_assign
id|skb-&gt;len
op_minus
(paren
(paren
r_int
r_char
op_star
)paren
id|data
op_minus
id|skb-&gt;h.raw
)paren
suffix:semicolon
r_int
id|i
comma
id|off
suffix:semicolon
r_if
c_cond
(paren
id|len
op_ge
r_sizeof
(paren
id|cu_header
)paren
)paren
(brace
id|cu_head
op_assign
(paren
id|cu_header
op_star
)paren
id|data
suffix:semicolon
r_if
c_cond
(paren
id|cu_head-&gt;dest_addr
)paren
(brace
multiline_comment|/* Correct destination address */
id|cu_head-&gt;dest_addr
op_assign
(paren
id|u_long
)paren
id|ms-&gt;saddr
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ntohs
c_func
(paren
id|cu_head-&gt;data_type
)paren
op_eq
l_int|101
op_logical_and
id|len
OG
r_sizeof
(paren
id|oc_header
)paren
)paren
(brace
id|oc
op_assign
(paren
id|oc_header
op_star
)paren
id|data
suffix:semicolon
multiline_comment|/* Spin (grovel) thru client_info structs till we find our own */
id|off
op_assign
r_sizeof
(paren
id|oc_header
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
(paren
id|i
OL
id|oc-&gt;client_count
op_logical_and
id|off
op_plus
r_sizeof
(paren
id|client_info
)paren
op_le
id|len
)paren
suffix:semicolon
id|i
op_increment
)paren
(brace
id|ci
op_assign
(paren
id|client_info
op_star
)paren
(paren
id|data
op_plus
id|off
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ci-&gt;address
op_eq
(paren
id|u_long
)paren
id|maddr
)paren
(brace
multiline_comment|/* Update w/ our real ip address and exit */
id|ci-&gt;address
op_assign
(paren
id|u_long
)paren
id|ms-&gt;saddr
suffix:semicolon
r_break
suffix:semicolon
)brace
r_else
id|off
op_add_assign
r_sizeof
(paren
id|client_info
)paren
suffix:semicolon
)brace
)brace
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|variable|ip_masq_cuseeme
r_struct
id|ip_masq_app
id|ip_masq_cuseeme
op_assign
(brace
l_int|NULL
comma
multiline_comment|/* next */
l_string|&quot;cuseeme&quot;
comma
l_int|0
comma
multiline_comment|/* type */
l_int|0
comma
multiline_comment|/* n_attach */
id|masq_cuseeme_init_1
comma
multiline_comment|/* ip_masq_init_1 */
id|masq_cuseeme_done_1
comma
multiline_comment|/* ip_masq_done_1 */
id|masq_cuseeme_out
comma
multiline_comment|/* pkt_out */
id|masq_cuseeme_in
multiline_comment|/* pkt_in */
)brace
suffix:semicolon
multiline_comment|/*&n; * &t;ip_masq_cuseeme initialization&n; */
DECL|function|__initfunc
id|__initfunc
c_func
(paren
r_int
id|ip_masq_cuseeme_init
c_func
(paren
r_void
)paren
)paren
(brace
r_int
id|i
comma
id|j
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
(paren
id|i
OL
id|MAX_MASQ_APP_PORTS
)paren
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|ports
(braket
id|i
)braket
)paren
(brace
r_if
c_cond
(paren
(paren
id|masq_incarnations
(braket
id|i
)braket
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|ip_masq_app
)paren
comma
id|GFP_KERNEL
)paren
)paren
op_eq
l_int|NULL
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|memcpy
c_func
(paren
id|masq_incarnations
(braket
id|i
)braket
comma
op_amp
id|ip_masq_cuseeme
comma
r_sizeof
(paren
r_struct
id|ip_masq_app
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|j
op_assign
id|register_ip_masq_app
c_func
(paren
id|masq_incarnations
(braket
id|i
)braket
comma
id|IPPROTO_UDP
comma
id|ports
(braket
id|i
)braket
)paren
)paren
)paren
(brace
r_return
id|j
suffix:semicolon
)brace
macro_line|#if DEBUG_CONFIG_IP_MASQ_CUSEEME
id|IP_MASQ_DEBUG
c_func
(paren
l_int|1
op_minus
id|debug
comma
l_string|&quot;CuSeeMe: loaded support on port[%d] = %d&bslash;n&quot;
comma
id|i
comma
id|ports
(braket
id|i
)braket
)paren
suffix:semicolon
macro_line|#endif
)brace
r_else
(brace
multiline_comment|/* To be safe, force the incarnation table entry to NULL */
id|masq_incarnations
(braket
id|i
)braket
op_assign
l_int|NULL
suffix:semicolon
)brace
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * &t;ip_masq_cuseeme fin.&n; */
DECL|function|ip_masq_cuseeme_done
r_int
id|ip_masq_cuseeme_done
c_func
(paren
r_void
)paren
(brace
r_int
id|i
comma
id|j
comma
id|k
suffix:semicolon
id|k
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
(paren
id|i
OL
id|MAX_MASQ_APP_PORTS
)paren
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|masq_incarnations
(braket
id|i
)braket
)paren
(brace
r_if
c_cond
(paren
(paren
id|j
op_assign
id|unregister_ip_masq_app
c_func
(paren
id|masq_incarnations
(braket
id|i
)braket
)paren
)paren
)paren
(brace
id|k
op_assign
id|j
suffix:semicolon
)brace
r_else
(brace
id|kfree
c_func
(paren
id|masq_incarnations
(braket
id|i
)braket
)paren
suffix:semicolon
id|masq_incarnations
(braket
id|i
)braket
op_assign
l_int|NULL
suffix:semicolon
id|IP_MASQ_DEBUG
c_func
(paren
l_int|1
op_minus
id|debug
comma
l_string|&quot;CuSeeMe: unloaded support on port[%d] = %d&bslash;n&quot;
comma
id|i
comma
id|ports
(braket
id|i
)braket
)paren
suffix:semicolon
)brace
)brace
)brace
r_return
id|k
suffix:semicolon
)brace
macro_line|#ifdef MODULE
id|EXPORT_NO_SYMBOLS
suffix:semicolon
DECL|function|init_module
r_int
id|init_module
c_func
(paren
r_void
)paren
(brace
r_if
c_cond
(paren
id|ip_masq_cuseeme_init
c_func
(paren
)paren
op_ne
l_int|0
)paren
r_return
op_minus
id|EIO
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|cleanup_module
r_void
id|cleanup_module
c_func
(paren
r_void
)paren
(brace
r_if
c_cond
(paren
id|ip_masq_cuseeme_done
c_func
(paren
)paren
op_ne
l_int|0
)paren
id|IP_MASQ_DEBUG
c_func
(paren
l_int|1
op_minus
id|debug
comma
l_string|&quot;ip_masq_cuseeme: can&squot;t remove module&quot;
)paren
suffix:semicolon
)brace
macro_line|#endif /* MODULE */
eof
