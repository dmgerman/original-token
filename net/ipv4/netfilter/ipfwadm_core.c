multiline_comment|/* Minor modifications to fit on compatibility framework:&n;   Rusty.Russell@rustcorp.com.au&n;*/
macro_line|#include &lt;linux/config.h&gt;
DECL|macro|CONFIG_IP_FIREWALL
mdefine_line|#define CONFIG_IP_FIREWALL
DECL|macro|CONFIG_IP_FIREWALL_VERBOSE
mdefine_line|#define CONFIG_IP_FIREWALL_VERBOSE
DECL|macro|CONFIG_IP_MASQUERADE
mdefine_line|#define CONFIG_IP_MASQUERADE
DECL|macro|CONFIG_IP_ACCT
mdefine_line|#define CONFIG_IP_ACCT
DECL|macro|CONFIG_IP_TRANSPARENT_PROXY
mdefine_line|#define CONFIG_IP_TRANSPARENT_PROXY
macro_line|#if defined(CONFIG_NETLINK_DEV) || defined(CONFIG_NETLINK_DEV_MODULE)
DECL|macro|CONFIG_IP_FIREWALL_NETLINK
mdefine_line|#define CONFIG_IP_FIREWALL_NETLINK
macro_line|#endif
multiline_comment|/*&n; *&t;IP firewalling code. This is taken from 4.4BSD. Please note the&n; *&t;copyright message below. As per the GPL it must be maintained&n; *&t;and the licenses thus do not conflict. While this port is subject&n; *&t;to the GPL I also place my modifications under the original&n; *&t;license in recognition of the original copyright.&n; *&t;&t;&t;&t;-- Alan Cox.&n; *&n; *&t;$Id: ipfwadm_core.c,v 1.4 2000/07/26 01:04:21 davem Exp $&n; *&n; *&t;Ported from BSD to Linux,&n; *&t;&t;Alan Cox 22/Nov/1994.&n; *&t;Zeroing /proc and other additions&n; *&t;&t;Jos Vos 4/Feb/1995.&n; *&t;Merged and included the FreeBSD-Current changes at Ugen&squot;s request&n; *&t;(but hey it&squot;s a lot cleaner now). Ugen would prefer in some ways&n; *&t;we waited for his final product but since Linux 1.2.0 is about to&n; *&t;appear it&squot;s not practical - Read: It works, it&squot;s not clean but please&n; *&t;don&squot;t consider it to be his standard of finished work.&n; *&t;&t;Alan Cox 12/Feb/1995&n; *&t;Porting bidirectional entries from BSD, fixing accounting issues,&n; *&t;adding struct ip_fwpkt for checking packets with interface address&n; *&t;&t;Jos Vos 5/Mar/1995.&n; *&t;Established connections (ACK check), ACK check on bidirectional rules,&n; *&t;ICMP type check.&n; *&t;&t;Wilfred Mollenvanger 7/7/1995.&n; *&t;TCP attack protection.&n; *&t;&t;Alan Cox 25/8/95, based on information from bugtraq.&n; *&t;ICMP type printk, IP_FW_F_APPEND&n; *&t;&t;Bernd Eckenfels 1996-01-31&n; *&t;Split blocking chain into input and output chains, add new &quot;insert&quot; and&n; *&t;&quot;append&quot; commands to replace semi-intelligent &quot;add&quot; command, let &quot;delete&quot;.&n; *&t;only delete the first matching entry, use 0xFFFF (0xFF) as ports (ICMP&n; *&t;types) when counting packets being 2nd and further fragments.&n; *&t;&t;Jos Vos &lt;jos@xos.nl&gt; 8/2/1996.&n; *&t;Add support for matching on device names.&n; *&t;&t;Jos Vos &lt;jos@xos.nl&gt; 15/2/1996.&n; *&t;Transparent proxying support.&n; *&t;&t;Willy Konynenberg &lt;willy@xos.nl&gt; 10/5/96.&n; *&t;Make separate accounting on incoming and outgoing packets possible.&n; *&t;&t;Jos Vos &lt;jos@xos.nl&gt; 18/5/1996.&n; *&t;Added trap out of bad frames.&n; *&t;&t;Alan Cox &lt;alan@cymru.net&gt; 17/11/1996&n; *&n; *&n; * Masquerading functionality&n; *&n; * Copyright (c) 1994 Pauline Middelink&n; *&n; * The pieces which added masquerading functionality are totally&n; * my responsibility and have nothing to with the original authors&n; * copyright or doing.&n; *&n; * Parts distributed under GPL.&n; *&n; * Fixes:&n; *&t;Pauline Middelink&t;:&t;Added masquerading.&n; *&t;Alan Cox&t;&t;:&t;Fixed an error in the merge.&n; *&t;Thomas Quinot&t;&t;:&t;Fixed port spoofing.&n; *&t;Alan Cox&t;&t;:&t;Cleaned up retransmits in spoofing.&n; *&t;Alan Cox&t;&t;:&t;Cleaned up length setting.&n; *&t;Wouter Gadeyne&t;&t;:&t;Fixed masquerading support of ftp PORT commands&n; *&n; *&t;Juan Jose Ciarlante&t;:&t;Masquerading code moved to ip_masq.c&n; *&t;Andi Kleen :&t;&t;Print frag_offsets and the ip flags properly.&n; *&n; *&t;All the real work was done by .....&n; *&n; */
multiline_comment|/*&n; * Copyright (c) 1993 Daniel Boulet&n; * Copyright (c) 1994 Ugen J.S.Antsilevich&n; *&n; * Redistribution and use in source forms, with and without modification,&n; * are permitted provided that this entire comment appears intact.&n; *&n; * Redistribution in binary form may occur without any restrictions.&n; * Obviously, it would be nice if you gave credit where credit is due&n; * but requiring it would be too onerous.&n; *&n; * This software is provided ``AS IS&squot;&squot; without any warranties of any kind.&n; */
macro_line|#include &lt;asm/uaccess.h&gt;
macro_line|#include &lt;asm/system.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/socket.h&gt;
macro_line|#include &lt;linux/sockios.h&gt;
macro_line|#include &lt;linux/in.h&gt;
macro_line|#include &lt;linux/inet.h&gt;
macro_line|#include &lt;linux/netdevice.h&gt;
macro_line|#include &lt;linux/icmp.h&gt;
macro_line|#include &lt;linux/udp.h&gt;
macro_line|#include &lt;net/ip.h&gt;
macro_line|#include &lt;net/protocol.h&gt;
macro_line|#include &lt;net/route.h&gt;
macro_line|#include &lt;net/tcp.h&gt;
macro_line|#include &lt;net/udp.h&gt;
macro_line|#include &lt;net/sock.h&gt;
macro_line|#include &lt;net/icmp.h&gt;
macro_line|#include &lt;linux/netlink.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/netfilter_ipv4/ipfwadm_core.h&gt;
macro_line|#include &lt;linux/netfilter_ipv4/compat_firewall.h&gt;
macro_line|#include &lt;net/checksum.h&gt;
macro_line|#include &lt;linux/proc_fs.h&gt;
macro_line|#include &lt;linux/stat.h&gt;
macro_line|#include &lt;linux/version.h&gt;
multiline_comment|/*&n; *&t;Implement IP packet firewall&n; */
macro_line|#ifdef DEBUG_IP_FIREWALL
DECL|macro|dprintf1
mdefine_line|#define dprintf1(a)&t;&t;printk(a)
DECL|macro|dprintf2
mdefine_line|#define dprintf2(a1,a2)&t;&t;printk(a1,a2)
DECL|macro|dprintf3
mdefine_line|#define dprintf3(a1,a2,a3)&t;printk(a1,a2,a3)
DECL|macro|dprintf4
mdefine_line|#define dprintf4(a1,a2,a3,a4)&t;printk(a1,a2,a3,a4)
macro_line|#else
DECL|macro|dprintf1
mdefine_line|#define dprintf1(a)
DECL|macro|dprintf2
mdefine_line|#define dprintf2(a1,a2)
DECL|macro|dprintf3
mdefine_line|#define dprintf3(a1,a2,a3)
DECL|macro|dprintf4
mdefine_line|#define dprintf4(a1,a2,a3,a4)
macro_line|#endif
DECL|macro|print_ip
mdefine_line|#define print_ip(a)&t; printk(&quot;%u.%u.%u.%u&quot;, NIPQUAD(a));
macro_line|#ifdef DEBUG_IP_FIREWALL
DECL|macro|dprint_ip
mdefine_line|#define dprint_ip(a)&t;print_ip(a)
macro_line|#else
DECL|macro|dprint_ip
mdefine_line|#define dprint_ip(a)
macro_line|#endif
macro_line|#if defined(CONFIG_IP_ACCT) || defined(CONFIG_IP_FIREWALL)
DECL|variable|ip_fw_fwd_chain
r_struct
id|ip_fw
op_star
id|ip_fw_fwd_chain
suffix:semicolon
DECL|variable|ip_fw_in_chain
r_struct
id|ip_fw
op_star
id|ip_fw_in_chain
suffix:semicolon
DECL|variable|ip_fw_out_chain
r_struct
id|ip_fw
op_star
id|ip_fw_out_chain
suffix:semicolon
DECL|variable|ip_acct_chain
r_struct
id|ip_fw
op_star
id|ip_acct_chain
suffix:semicolon
DECL|variable|ip_masq_chain
r_struct
id|ip_fw
op_star
id|ip_masq_chain
suffix:semicolon
DECL|variable|chains
r_static
r_struct
id|ip_fw
op_star
op_star
id|chains
(braket
)braket
op_assign
(brace
op_amp
id|ip_fw_fwd_chain
comma
op_amp
id|ip_fw_in_chain
comma
op_amp
id|ip_fw_out_chain
comma
op_amp
id|ip_acct_chain
comma
op_amp
id|ip_masq_chain
)brace
suffix:semicolon
macro_line|#endif /* CONFIG_IP_ACCT || CONFIG_IP_FIREWALL */
macro_line|#ifdef CONFIG_IP_FIREWALL
DECL|variable|ip_fw_fwd_policy
r_int
id|ip_fw_fwd_policy
op_assign
id|IP_FW_F_ACCEPT
suffix:semicolon
DECL|variable|ip_fw_in_policy
r_int
id|ip_fw_in_policy
op_assign
id|IP_FW_F_ACCEPT
suffix:semicolon
DECL|variable|ip_fw_out_policy
r_int
id|ip_fw_out_policy
op_assign
id|IP_FW_F_ACCEPT
suffix:semicolon
DECL|variable|policies
r_static
r_int
op_star
id|policies
(braket
)braket
op_assign
(brace
op_amp
id|ip_fw_fwd_policy
comma
op_amp
id|ip_fw_in_policy
comma
op_amp
id|ip_fw_out_policy
)brace
suffix:semicolon
macro_line|#endif
macro_line|#ifdef CONFIG_IP_FIREWALL_NETLINK
DECL|variable|ipfwsk
r_struct
id|sock
op_star
id|ipfwsk
suffix:semicolon
macro_line|#endif
multiline_comment|/*&n; *&t;Returns 1 if the port is matched by the vector, 0 otherwise&n; */
DECL|function|port_match
r_extern
r_inline
r_int
id|port_match
c_func
(paren
r_int
r_int
op_star
id|portptr
comma
r_int
id|nports
comma
r_int
r_int
id|port
comma
r_int
id|range_flag
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|nports
)paren
r_return
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|range_flag
)paren
(brace
r_if
c_cond
(paren
id|portptr
(braket
l_int|0
)braket
op_le
id|port
op_logical_and
id|port
op_le
id|portptr
(braket
l_int|1
)braket
)paren
(brace
r_return
l_int|1
suffix:semicolon
)brace
id|nports
op_sub_assign
l_int|2
suffix:semicolon
id|portptr
op_add_assign
l_int|2
suffix:semicolon
)brace
r_while
c_loop
(paren
id|nports
op_decrement
OG
l_int|0
)paren
(brace
r_if
c_cond
(paren
op_star
id|portptr
op_increment
op_eq
id|port
)paren
(brace
r_return
l_int|1
suffix:semicolon
)brace
)brace
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#if defined(CONFIG_IP_ACCT) || defined(CONFIG_IP_FIREWALL)
macro_line|#ifdef CONFIG_IP_FIREWALL_VERBOSE
multiline_comment|/*&n; *&t;VERY ugly piece of code which actually makes kernel printf for&n; * &t;matching packets.&n; */
DECL|function|chain_name
r_static
r_char
op_star
id|chain_name
c_func
(paren
r_struct
id|ip_fw
op_star
id|chain
comma
r_int
id|mode
)paren
(brace
r_switch
c_cond
(paren
id|mode
)paren
(brace
r_case
id|IP_FW_MODE_ACCT_IN
suffix:colon
r_return
l_string|&quot;acct in&quot;
suffix:semicolon
r_case
id|IP_FW_MODE_ACCT_OUT
suffix:colon
r_return
l_string|&quot;acct out&quot;
suffix:semicolon
r_default
suffix:colon
(brace
)brace
r_if
c_cond
(paren
id|chain
op_eq
id|ip_fw_fwd_chain
)paren
r_return
l_string|&quot;fw-fwd&quot;
suffix:semicolon
r_else
r_if
c_cond
(paren
id|chain
op_eq
id|ip_fw_in_chain
)paren
r_return
l_string|&quot;fw-in&quot;
suffix:semicolon
r_else
r_return
l_string|&quot;fw-out&quot;
suffix:semicolon
)brace
)brace
DECL|function|rule_name
r_static
r_char
op_star
id|rule_name
c_func
(paren
r_struct
id|ip_fw
op_star
id|f
comma
r_int
id|mode
comma
r_char
op_star
id|buf
)paren
(brace
r_if
c_cond
(paren
id|mode
op_eq
id|IP_FW_MODE_ACCT_IN
op_logical_or
id|mode
op_eq
id|IP_FW_MODE_ACCT_OUT
)paren
r_return
l_string|&quot;&quot;
suffix:semicolon
r_if
c_cond
(paren
id|f-&gt;fw_flg
op_amp
id|IP_FW_F_ACCEPT
)paren
(brace
r_if
c_cond
(paren
id|f-&gt;fw_flg
op_amp
id|IP_FW_F_REDIR
)paren
(brace
id|sprintf
c_func
(paren
id|buf
comma
l_string|&quot;acc/r%d &quot;
comma
id|f-&gt;fw_pts
(braket
id|f-&gt;fw_nsp
op_plus
id|f-&gt;fw_ndp
)braket
)paren
suffix:semicolon
r_return
id|buf
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|f-&gt;fw_flg
op_amp
id|IP_FW_F_MASQ
)paren
(brace
r_return
l_string|&quot;acc/masq &quot;
suffix:semicolon
)brace
r_else
r_return
l_string|&quot;acc &quot;
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|f-&gt;fw_flg
op_amp
id|IP_FW_F_ICMPRPL
)paren
(brace
r_return
l_string|&quot;rej &quot;
suffix:semicolon
)brace
r_else
(brace
r_return
l_string|&quot;deny &quot;
suffix:semicolon
)brace
)brace
DECL|function|print_packet
r_static
r_void
id|print_packet
c_func
(paren
r_struct
id|iphdr
op_star
id|ip
comma
id|u16
id|src_port
comma
id|u16
id|dst_port
comma
id|u16
id|icmp_type
comma
r_char
op_star
id|chain
comma
r_char
op_star
id|rule
comma
r_char
op_star
id|devname
)paren
(brace
id|__u32
op_star
id|opt
op_assign
(paren
id|__u32
op_star
)paren
(paren
id|ip
op_plus
l_int|1
)paren
suffix:semicolon
r_int
id|opti
suffix:semicolon
id|__u16
id|foff
op_assign
id|ntohs
c_func
(paren
id|ip-&gt;frag_off
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;IP %s %s%s&quot;
comma
id|chain
comma
id|rule
comma
id|devname
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|ip-&gt;protocol
)paren
(brace
r_case
id|IPPROTO_TCP
suffix:colon
id|printk
c_func
(paren
l_string|&quot; TCP &quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|IPPROTO_UDP
suffix:colon
id|printk
c_func
(paren
l_string|&quot; UDP &quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|IPPROTO_ICMP
suffix:colon
id|printk
c_func
(paren
l_string|&quot; ICMP/%d &quot;
comma
id|icmp_type
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|printk
c_func
(paren
l_string|&quot; PROTO=%d &quot;
comma
id|ip-&gt;protocol
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|print_ip
c_func
(paren
id|ip-&gt;saddr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ip-&gt;protocol
op_eq
id|IPPROTO_TCP
op_logical_or
id|ip-&gt;protocol
op_eq
id|IPPROTO_UDP
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;:%hu&quot;
comma
id|src_port
)paren
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot; &quot;
)paren
suffix:semicolon
id|print_ip
c_func
(paren
id|ip-&gt;daddr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ip-&gt;protocol
op_eq
id|IPPROTO_TCP
op_logical_or
id|ip-&gt;protocol
op_eq
id|IPPROTO_UDP
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;:%hu&quot;
comma
id|dst_port
)paren
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot; L=%hu S=0x%2.2hX I=%hu FO=0x%4.4hX T=%hu&quot;
comma
id|ntohs
c_func
(paren
id|ip-&gt;tot_len
)paren
comma
id|ip-&gt;tos
comma
id|ntohs
c_func
(paren
id|ip-&gt;id
)paren
comma
id|foff
op_amp
id|IP_OFFSET
comma
id|ip-&gt;ttl
)paren
suffix:semicolon
r_if
c_cond
(paren
id|foff
op_amp
id|IP_DF
)paren
id|printk
c_func
(paren
l_string|&quot; DF=1&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|foff
op_amp
id|IP_MF
)paren
id|printk
c_func
(paren
l_string|&quot; MF=1&quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|opti
op_assign
l_int|0
suffix:semicolon
id|opti
OL
(paren
id|ip-&gt;ihl
op_minus
r_sizeof
(paren
r_struct
id|iphdr
)paren
op_div
l_int|4
)paren
suffix:semicolon
id|opti
op_increment
)paren
id|printk
c_func
(paren
l_string|&quot; O=0x%8.8X&quot;
comma
op_star
id|opt
op_increment
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
)brace
macro_line|#endif
multiline_comment|/*&n; *&t;Returns one of the generic firewall policies, like FW_ACCEPT.&n; *&t;Also does accounting so you can feed it the accounting chain.&n; *&n; *&t;The modes is either IP_FW_MODE_FW (normal firewall mode),&n; *&t;IP_FW_MODE_ACCT_IN or IP_FW_MODE_ACCT_OUT (accounting mode,&n; *&t;steps through the entire chain and handles fragments&n; *&t;differently), or IP_FW_MODE_CHK (handles user-level check,&n; *&t;counters are not updated).&n; */
DECL|function|ip_fw_chk
r_int
id|ip_fw_chk
c_func
(paren
r_struct
id|iphdr
op_star
id|ip
comma
r_struct
id|net_device
op_star
id|rif
comma
id|__u16
op_star
id|redirport
comma
r_struct
id|ip_fw
op_star
id|chain
comma
r_int
id|policy
comma
r_int
id|mode
)paren
(brace
r_struct
id|ip_fw
op_star
id|f
suffix:semicolon
r_struct
id|tcphdr
op_star
id|tcp
op_assign
(paren
r_struct
id|tcphdr
op_star
)paren
(paren
(paren
id|__u32
op_star
)paren
id|ip
op_plus
id|ip-&gt;ihl
)paren
suffix:semicolon
r_struct
id|udphdr
op_star
id|udp
op_assign
(paren
r_struct
id|udphdr
op_star
)paren
(paren
(paren
id|__u32
op_star
)paren
id|ip
op_plus
id|ip-&gt;ihl
)paren
suffix:semicolon
r_struct
id|icmphdr
op_star
id|icmp
op_assign
(paren
r_struct
id|icmphdr
op_star
)paren
(paren
(paren
id|__u32
op_star
)paren
id|ip
op_plus
id|ip-&gt;ihl
)paren
suffix:semicolon
id|__u32
id|src
comma
id|dst
suffix:semicolon
id|__u16
id|src_port
op_assign
l_int|0xFFFF
comma
id|dst_port
op_assign
l_int|0xFFFF
comma
id|icmp_type
op_assign
l_int|0xFF
suffix:semicolon
r_int
r_int
id|f_prt
op_assign
l_int|0
comma
id|prt
suffix:semicolon
r_char
id|notcpsyn
op_assign
l_int|0
comma
id|notcpack
op_assign
l_int|0
comma
id|match
suffix:semicolon
r_int
r_int
id|offset
suffix:semicolon
r_int
id|answer
suffix:semicolon
r_int
r_char
id|tosand
comma
id|tosxor
suffix:semicolon
multiline_comment|/*&n;&t; *&t;If the chain is empty follow policy. The BSD one&n;&t; *&t;accepts anything giving you a time window while&n;&t; *&t;flushing and rebuilding the tables.&n;&t; */
id|src
op_assign
id|ip-&gt;saddr
suffix:semicolon
id|dst
op_assign
id|ip-&gt;daddr
suffix:semicolon
multiline_comment|/*&n;&t; *&t;This way we handle fragmented packets.&n;&t; *&t;we ignore all fragments but the first one&n;&t; *&t;so the whole packet can&squot;t be reassembled.&n;&t; *&t;This way we relay on the full info which&n;&t; *&t;stored only in first packet.&n;&t; *&n;&t; *&t;Note that this theoretically allows partial packet&n;&t; *&t;spoofing. Not very dangerous but paranoid people may&n;&t; *&t;wish to play with this. It also allows the so called&n;&t; *&t;&quot;fragment bomb&quot; denial of service attack on some types&n;&t; *&t;of system.&n;&t; */
id|offset
op_assign
id|ntohs
c_func
(paren
id|ip-&gt;frag_off
)paren
op_amp
id|IP_OFFSET
suffix:semicolon
multiline_comment|/*&n;&t; *&t;Don&squot;t allow a fragment of TCP 8 bytes in. Nobody&n;&t; *&t;normal causes this. Its a cracker trying to break&n;&t; *&t;in by doing a flag overwrite to pass the direction&n;&t; *&t;checks.&n;&t; */
r_if
c_cond
(paren
id|offset
op_eq
l_int|1
op_logical_and
id|ip-&gt;protocol
op_eq
id|IPPROTO_TCP
)paren
r_return
id|FW_BLOCK
suffix:semicolon
r_if
c_cond
(paren
id|offset
op_ne
l_int|0
op_logical_and
op_logical_neg
(paren
id|mode
op_amp
(paren
id|IP_FW_MODE_ACCT_IN
op_or
id|IP_FW_MODE_ACCT_OUT
)paren
)paren
op_logical_and
(paren
id|ip-&gt;protocol
op_eq
id|IPPROTO_TCP
op_logical_or
id|ip-&gt;protocol
op_eq
id|IPPROTO_UDP
op_logical_or
id|ip-&gt;protocol
op_eq
id|IPPROTO_ICMP
)paren
)paren
r_return
id|FW_ACCEPT
suffix:semicolon
multiline_comment|/*&n;&t; *&t; Header fragment for TCP is too small to check the bits.&n;&t; */
r_if
c_cond
(paren
id|ip-&gt;protocol
op_eq
id|IPPROTO_TCP
op_logical_and
(paren
id|ip-&gt;ihl
op_lshift
l_int|2
)paren
op_plus
l_int|16
OG
id|ntohs
c_func
(paren
id|ip-&gt;tot_len
)paren
)paren
(brace
r_return
id|FW_BLOCK
suffix:semicolon
)brace
multiline_comment|/*&n;&t; *&t;Too short.&n;&t; *&n;&t; *&t;But only too short for a packet with ports...&n;&t; */
r_else
r_if
c_cond
(paren
(paren
id|ntohs
c_func
(paren
id|ip-&gt;tot_len
)paren
OL
l_int|8
op_plus
(paren
id|ip-&gt;ihl
op_lshift
l_int|2
)paren
)paren
op_logical_and
(paren
id|ip-&gt;protocol
op_eq
id|IPPROTO_TCP
op_logical_or
id|ip-&gt;protocol
op_eq
id|IPPROTO_UDP
)paren
)paren
(brace
r_return
id|FW_BLOCK
suffix:semicolon
)brace
id|src
op_assign
id|ip-&gt;saddr
suffix:semicolon
id|dst
op_assign
id|ip-&gt;daddr
suffix:semicolon
multiline_comment|/*&n;&t; *&t;If we got interface from which packet came&n;&t; *&t;we can use the address directly. This is unlike&n;&t; *&t;4.4BSD derived systems that have an address chain&n;&t; *&t;per device. We have a device per address with dummy&n;&t; *&t;devices instead.&n;&t; */
id|dprintf1
c_func
(paren
l_string|&quot;Packet &quot;
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|ip-&gt;protocol
)paren
(brace
r_case
id|IPPROTO_TCP
suffix:colon
id|dprintf1
c_func
(paren
l_string|&quot;TCP &quot;
)paren
suffix:semicolon
multiline_comment|/* ports stay 0xFFFF if it is not the first fragment */
r_if
c_cond
(paren
op_logical_neg
id|offset
)paren
(brace
id|src_port
op_assign
id|ntohs
c_func
(paren
id|tcp-&gt;source
)paren
suffix:semicolon
id|dst_port
op_assign
id|ntohs
c_func
(paren
id|tcp-&gt;dest
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|tcp-&gt;ack
op_logical_and
op_logical_neg
id|tcp-&gt;rst
)paren
(brace
multiline_comment|/* We do NOT have ACK, value TRUE */
id|notcpack
op_assign
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|tcp-&gt;syn
op_logical_or
op_logical_neg
id|notcpack
)paren
(brace
multiline_comment|/* We do NOT have SYN, value TRUE */
id|notcpsyn
op_assign
l_int|1
suffix:semicolon
)brace
)brace
id|prt
op_assign
id|IP_FW_F_TCP
suffix:semicolon
r_break
suffix:semicolon
r_case
id|IPPROTO_UDP
suffix:colon
id|dprintf1
c_func
(paren
l_string|&quot;UDP &quot;
)paren
suffix:semicolon
multiline_comment|/* ports stay 0xFFFF if it is not the first fragment */
r_if
c_cond
(paren
op_logical_neg
id|offset
)paren
(brace
id|src_port
op_assign
id|ntohs
c_func
(paren
id|udp-&gt;source
)paren
suffix:semicolon
id|dst_port
op_assign
id|ntohs
c_func
(paren
id|udp-&gt;dest
)paren
suffix:semicolon
)brace
id|prt
op_assign
id|IP_FW_F_UDP
suffix:semicolon
r_break
suffix:semicolon
r_case
id|IPPROTO_ICMP
suffix:colon
multiline_comment|/* icmp_type stays 255 if it is not the first fragment */
r_if
c_cond
(paren
op_logical_neg
id|offset
)paren
id|icmp_type
op_assign
(paren
id|__u16
)paren
(paren
id|icmp-&gt;type
)paren
suffix:semicolon
id|dprintf2
c_func
(paren
l_string|&quot;ICMP:%d &quot;
comma
id|icmp_type
)paren
suffix:semicolon
id|prt
op_assign
id|IP_FW_F_ICMP
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|dprintf2
c_func
(paren
l_string|&quot;p=%d &quot;
comma
id|ip-&gt;protocol
)paren
suffix:semicolon
id|prt
op_assign
id|IP_FW_F_ALL
suffix:semicolon
r_break
suffix:semicolon
)brace
macro_line|#ifdef DEBUG_IP_FIREWALL
id|dprint_ip
c_func
(paren
id|ip-&gt;saddr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ip-&gt;protocol
op_eq
id|IPPROTO_TCP
op_logical_or
id|ip-&gt;protocol
op_eq
id|IPPROTO_UDP
)paren
multiline_comment|/* This will print 65535 when it is not the first fragment! */
id|dprintf2
c_func
(paren
l_string|&quot;:%d &quot;
comma
id|src_port
)paren
suffix:semicolon
id|dprint_ip
c_func
(paren
id|ip-&gt;daddr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ip-&gt;protocol
op_eq
id|IPPROTO_TCP
op_logical_or
id|ip-&gt;protocol
op_eq
id|IPPROTO_UDP
)paren
multiline_comment|/* This will print 65535 when it is not the first fragment! */
id|dprintf2
c_func
(paren
l_string|&quot;:%d &quot;
comma
id|dst_port
)paren
suffix:semicolon
id|dprintf1
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
r_for
c_loop
(paren
id|f
op_assign
id|chain
suffix:semicolon
id|f
suffix:semicolon
id|f
op_assign
id|f-&gt;fw_next
)paren
(brace
multiline_comment|/*&n;&t;&t; *&t;This is a bit simpler as we don&squot;t have to walk&n;&t;&t; *&t;an interface chain as you do in BSD - same logic&n;&t;&t; *&t;however.&n;&t;&t; */
multiline_comment|/*&n;&t;&t; *&t;Match can become 0x01 (a &quot;normal&quot; match was found),&n;&t;&t; *&t;0x02 (a reverse match was found), and 0x03 (the&n;&t;&t; *&t;IP addresses match in both directions).&n;&t;&t; *&t;Now we know in which direction(s) we should look&n;&t;&t; *&t;for a match for the TCP/UDP ports.  Both directions&n;&t;&t; *&t;might match (e.g., when both addresses are on the&n;&t;&t; *&t;same network for which an address/mask is given), but&n;&t;&t; *&t;the ports might only match in one direction.&n;&t;&t; *&t;This was obviously wrong in the original BSD code.&n;&t;&t; */
id|match
op_assign
l_int|0x00
suffix:semicolon
r_if
c_cond
(paren
(paren
id|src
op_amp
id|f-&gt;fw_smsk.s_addr
)paren
op_eq
id|f-&gt;fw_src.s_addr
op_logical_and
(paren
id|dst
op_amp
id|f-&gt;fw_dmsk.s_addr
)paren
op_eq
id|f-&gt;fw_dst.s_addr
)paren
multiline_comment|/* normal direction */
id|match
op_or_assign
l_int|0x01
suffix:semicolon
r_if
c_cond
(paren
(paren
id|f-&gt;fw_flg
op_amp
id|IP_FW_F_BIDIR
)paren
op_logical_and
(paren
id|dst
op_amp
id|f-&gt;fw_smsk.s_addr
)paren
op_eq
id|f-&gt;fw_src.s_addr
op_logical_and
(paren
id|src
op_amp
id|f-&gt;fw_dmsk.s_addr
)paren
op_eq
id|f-&gt;fw_dst.s_addr
)paren
multiline_comment|/* reverse direction */
id|match
op_or_assign
l_int|0x02
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|match
)paren
r_continue
suffix:semicolon
multiline_comment|/*&n;&t;&t; *&t;Look for a VIA device match&n;&t;&t; */
r_if
c_cond
(paren
id|f-&gt;fw_viadev
)paren
(brace
r_if
c_cond
(paren
id|rif
op_ne
id|f-&gt;fw_viadev
)paren
(brace
r_continue
suffix:semicolon
)brace
multiline_comment|/* Mismatch */
)brace
multiline_comment|/* This looks stupid, because we scan almost static&n;&t;&t;   list, searching for static key. However, this way seems&n;&t;&t;   to be only reasonable way of handling fw_via rules&n;&t;&t;   (btw bsd makes the same thing).&n;&n;&t;&t;   It will not affect performance if you will follow&n;&t;&t;   the following simple rules:&n;&n;&t;&t;   - if inteface is aliased, ALWAYS specify fw_viadev,&n;&t;&t;     so that previous check will guarantee, that we will&n;&t;&t;     not waste time when packet arrive on another interface.&n;&n;&t;&t;   - avoid using fw_via.s_addr if fw_via.s_addr is owned&n;&t;&t;     by an aliased interface.&n;&n;&t;&t;                                                       --ANK&n;&t;&t; */
r_if
c_cond
(paren
id|f-&gt;fw_via.s_addr
op_logical_and
id|rif
)paren
(brace
r_struct
id|in_ifaddr
op_star
id|ifa
suffix:semicolon
r_if
c_cond
(paren
id|rif-&gt;ip_ptr
op_eq
l_int|NULL
)paren
r_continue
suffix:semicolon
multiline_comment|/* Mismatch */
r_for
c_loop
(paren
id|ifa
op_assign
(paren
(paren
r_struct
id|in_device
op_star
)paren
(paren
id|rif-&gt;ip_ptr
)paren
)paren
op_member_access_from_pointer
id|ifa_list
suffix:semicolon
id|ifa
suffix:semicolon
id|ifa
op_assign
id|ifa-&gt;ifa_next
)paren
(brace
r_if
c_cond
(paren
id|ifa-&gt;ifa_local
op_eq
id|f-&gt;fw_via.s_addr
)paren
r_goto
id|ifa_ok
suffix:semicolon
)brace
r_continue
suffix:semicolon
multiline_comment|/* Mismatch */
id|ifa_ok
suffix:colon
)brace
multiline_comment|/*&n;&t;&t; *&t;Ok the chain addresses match.&n;&t;&t; */
macro_line|#ifdef CONFIG_IP_ACCT
multiline_comment|/*&n;&t;&t; *&t;See if we&squot;re in accounting mode and only want to&n;&t;&t; *&t;count incoming or outgoing packets.&n;&t;&t; */
r_if
c_cond
(paren
id|mode
op_amp
(paren
id|IP_FW_MODE_ACCT_IN
op_or
id|IP_FW_MODE_ACCT_OUT
)paren
op_logical_and
(paren
(paren
id|mode
op_eq
id|IP_FW_MODE_ACCT_IN
op_logical_and
id|f-&gt;fw_flg
op_amp
id|IP_FW_F_ACCTOUT
)paren
op_logical_or
(paren
id|mode
op_eq
id|IP_FW_MODE_ACCT_OUT
op_logical_and
id|f-&gt;fw_flg
op_amp
id|IP_FW_F_ACCTIN
)paren
)paren
)paren
r_continue
suffix:semicolon
macro_line|#endif
multiline_comment|/*&n;&t;&t; * For all non-TCP packets and/or non-first fragments,&n;&t;&t; * notcpsyn and notcpack will always be FALSE,&n;&t;&t; * so the IP_FW_F_TCPSYN and IP_FW_F_TCPACK flags&n;&t;&t; * are actually ignored for these packets.&n;&t;&t; */
r_if
c_cond
(paren
(paren
id|f-&gt;fw_flg
op_amp
id|IP_FW_F_TCPSYN
)paren
op_logical_and
id|notcpsyn
)paren
(brace
r_continue
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|f-&gt;fw_flg
op_amp
id|IP_FW_F_TCPACK
)paren
op_logical_and
id|notcpack
)paren
(brace
r_continue
suffix:semicolon
)brace
id|f_prt
op_assign
id|f-&gt;fw_flg
op_amp
id|IP_FW_F_KIND
suffix:semicolon
r_if
c_cond
(paren
id|f_prt
op_ne
id|IP_FW_F_ALL
)paren
(brace
multiline_comment|/*&n;&t;&t;&t; *&t;Specific firewall - packet&squot;s protocol&n;&t;&t;&t; *&t;must match firewall&squot;s.&n;&t;&t;&t; */
r_if
c_cond
(paren
id|prt
op_ne
id|f_prt
)paren
(brace
r_continue
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|prt
op_eq
id|IP_FW_F_ICMP
op_logical_and
op_logical_neg
id|port_match
c_func
(paren
op_amp
id|f-&gt;fw_pts
(braket
l_int|0
)braket
comma
id|f-&gt;fw_nsp
comma
id|icmp_type
comma
id|f-&gt;fw_flg
op_amp
id|IP_FW_F_SRNG
)paren
)paren
op_logical_or
op_logical_neg
(paren
id|prt
op_eq
id|IP_FW_F_ICMP
op_logical_or
(paren
(paren
id|match
op_amp
l_int|0x01
)paren
op_logical_and
id|port_match
c_func
(paren
op_amp
id|f-&gt;fw_pts
(braket
l_int|0
)braket
comma
id|f-&gt;fw_nsp
comma
id|src_port
comma
id|f-&gt;fw_flg
op_amp
id|IP_FW_F_SRNG
)paren
op_logical_and
id|port_match
c_func
(paren
op_amp
id|f-&gt;fw_pts
(braket
id|f-&gt;fw_nsp
)braket
comma
id|f-&gt;fw_ndp
comma
id|dst_port
comma
id|f-&gt;fw_flg
op_amp
id|IP_FW_F_DRNG
)paren
)paren
op_logical_or
(paren
(paren
id|match
op_amp
l_int|0x02
)paren
op_logical_and
id|port_match
c_func
(paren
op_amp
id|f-&gt;fw_pts
(braket
l_int|0
)braket
comma
id|f-&gt;fw_nsp
comma
id|dst_port
comma
id|f-&gt;fw_flg
op_amp
id|IP_FW_F_SRNG
)paren
op_logical_and
id|port_match
c_func
(paren
op_amp
id|f-&gt;fw_pts
(braket
id|f-&gt;fw_nsp
)braket
comma
id|f-&gt;fw_ndp
comma
id|src_port
comma
id|f-&gt;fw_flg
op_amp
id|IP_FW_F_DRNG
)paren
)paren
)paren
)paren
(brace
r_continue
suffix:semicolon
)brace
)brace
macro_line|#ifdef CONFIG_IP_FIREWALL_VERBOSE
r_if
c_cond
(paren
id|f-&gt;fw_flg
op_amp
id|IP_FW_F_PRN
)paren
(brace
r_char
id|buf
(braket
l_int|16
)braket
suffix:semicolon
id|print_packet
c_func
(paren
id|ip
comma
id|src_port
comma
id|dst_port
comma
id|icmp_type
comma
id|chain_name
c_func
(paren
id|chain
comma
id|mode
)paren
comma
id|rule_name
c_func
(paren
id|f
comma
id|mode
comma
id|buf
)paren
comma
id|rif
ques
c_cond
id|rif-&gt;name
suffix:colon
l_string|&quot;-&quot;
)paren
suffix:semicolon
)brace
macro_line|#endif
r_if
c_cond
(paren
id|mode
op_ne
id|IP_FW_MODE_CHK
)paren
(brace
id|f-&gt;fw_bcnt
op_add_assign
id|ntohs
c_func
(paren
id|ip-&gt;tot_len
)paren
suffix:semicolon
id|f-&gt;fw_pcnt
op_increment
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|mode
op_amp
(paren
id|IP_FW_MODE_ACCT_IN
op_or
id|IP_FW_MODE_ACCT_OUT
)paren
)paren
)paren
r_break
suffix:semicolon
)brace
multiline_comment|/* Loop */
r_if
c_cond
(paren
op_logical_neg
(paren
id|mode
op_amp
(paren
id|IP_FW_MODE_ACCT_IN
op_or
id|IP_FW_MODE_ACCT_OUT
)paren
)paren
)paren
(brace
multiline_comment|/*&n;&t;&t; * We rely on policy defined in the rejecting entry or, if no match&n;&t;&t; * was found, we rely on the general policy variable for this type&n;&t;&t; * of firewall.&n;&t;&t; */
r_if
c_cond
(paren
id|f
op_ne
l_int|NULL
)paren
(brace
id|policy
op_assign
id|f-&gt;fw_flg
suffix:semicolon
id|tosand
op_assign
id|f-&gt;fw_tosand
suffix:semicolon
id|tosxor
op_assign
id|f-&gt;fw_tosxor
suffix:semicolon
)brace
r_else
(brace
id|tosand
op_assign
l_int|0xFF
suffix:semicolon
id|tosxor
op_assign
l_int|0x00
suffix:semicolon
)brace
r_if
c_cond
(paren
id|policy
op_amp
id|IP_FW_F_ACCEPT
)paren
(brace
multiline_comment|/* Adjust priority and recompute checksum */
id|__u8
id|old_tos
op_assign
id|ip-&gt;tos
suffix:semicolon
id|ip-&gt;tos
op_assign
(paren
id|old_tos
op_amp
id|tosand
)paren
op_xor
id|tosxor
suffix:semicolon
r_if
c_cond
(paren
id|ip-&gt;tos
op_ne
id|old_tos
)paren
id|ip_send_check
c_func
(paren
id|ip
)paren
suffix:semicolon
macro_line|#ifdef CONFIG_IP_TRANSPARENT_PROXY
r_if
c_cond
(paren
id|policy
op_amp
id|IP_FW_F_REDIR
)paren
(brace
r_if
c_cond
(paren
id|redirport
)paren
r_if
c_cond
(paren
(paren
op_star
id|redirport
op_assign
id|htons
c_func
(paren
id|f-&gt;fw_pts
(braket
id|f-&gt;fw_nsp
op_plus
id|f-&gt;fw_ndp
)braket
)paren
)paren
op_eq
l_int|0
)paren
(brace
multiline_comment|/* Wildcard redirection.&n;&t;&t;&t;&t;&t;&t; * Note that redirport will become&n;&t;&t;&t;&t;&t;&t; * 0xFFFF for non-TCP/UDP packets.&n;&t;&t;&t;&t;&t;&t; */
op_star
id|redirport
op_assign
id|htons
c_func
(paren
id|dst_port
)paren
suffix:semicolon
)brace
id|answer
op_assign
id|FW_REDIRECT
suffix:semicolon
)brace
r_else
macro_line|#endif
macro_line|#ifdef CONFIG_IP_MASQUERADE
r_if
c_cond
(paren
id|policy
op_amp
id|IP_FW_F_MASQ
)paren
id|answer
op_assign
id|FW_MASQUERADE
suffix:semicolon
r_else
macro_line|#endif
id|answer
op_assign
id|FW_ACCEPT
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|policy
op_amp
id|IP_FW_F_ICMPRPL
)paren
(brace
id|answer
op_assign
id|FW_REJECT
suffix:semicolon
)brace
r_else
id|answer
op_assign
id|FW_BLOCK
suffix:semicolon
macro_line|#ifdef CONFIG_IP_FIREWALL_NETLINK
r_if
c_cond
(paren
(paren
id|policy
op_amp
id|IP_FW_F_PRN
)paren
op_logical_and
(paren
id|answer
op_eq
id|FW_REJECT
op_logical_or
id|answer
op_eq
id|FW_BLOCK
)paren
)paren
(brace
r_struct
id|sk_buff
op_star
id|skb
op_assign
id|alloc_skb
c_func
(paren
l_int|128
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
id|skb
)paren
(brace
r_int
id|len
op_assign
id|min
c_func
(paren
l_int|128
comma
id|ntohs
c_func
(paren
id|ip-&gt;tot_len
)paren
)paren
suffix:semicolon
id|skb_put
c_func
(paren
id|skb
comma
id|len
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|skb-&gt;data
comma
id|ip
comma
id|len
)paren
suffix:semicolon
r_if
c_cond
(paren
id|netlink_post
c_func
(paren
id|NETLINK_FIREWALL
comma
id|skb
)paren
)paren
(brace
id|kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
)brace
)brace
)brace
macro_line|#endif
r_return
id|answer
suffix:semicolon
)brace
r_else
multiline_comment|/* we&squot;re doing accounting, always ok */
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|zero_fw_chain
r_static
r_void
id|zero_fw_chain
c_func
(paren
r_struct
id|ip_fw
op_star
id|chainptr
)paren
(brace
r_struct
id|ip_fw
op_star
id|ctmp
op_assign
id|chainptr
suffix:semicolon
r_while
c_loop
(paren
id|ctmp
)paren
(brace
id|ctmp-&gt;fw_pcnt
op_assign
l_int|0L
suffix:semicolon
id|ctmp-&gt;fw_bcnt
op_assign
l_int|0L
suffix:semicolon
id|ctmp
op_assign
id|ctmp-&gt;fw_next
suffix:semicolon
)brace
)brace
DECL|function|free_fw_chain
r_static
r_void
id|free_fw_chain
c_func
(paren
r_struct
id|ip_fw
op_star
r_volatile
op_star
id|chainptr
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
r_while
c_loop
(paren
op_star
id|chainptr
op_ne
l_int|NULL
)paren
(brace
r_struct
id|ip_fw
op_star
id|ftmp
suffix:semicolon
id|ftmp
op_assign
op_star
id|chainptr
suffix:semicolon
op_star
id|chainptr
op_assign
id|ftmp-&gt;fw_next
suffix:semicolon
id|kfree
c_func
(paren
id|ftmp
)paren
suffix:semicolon
)brace
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
multiline_comment|/* Volatiles to keep some of the compiler versions amused */
DECL|function|insert_in_chain
r_static
r_int
id|insert_in_chain
c_func
(paren
r_struct
id|ip_fw
op_star
r_volatile
op_star
id|chainptr
comma
r_struct
id|ip_fw
op_star
id|frwl
comma
r_int
id|len
)paren
(brace
r_struct
id|ip_fw
op_star
id|ftmp
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|ftmp
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|ip_fw
)paren
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ftmp
op_eq
l_int|NULL
)paren
(brace
macro_line|#ifdef DEBUG_IP_FIREWALL
id|printk
c_func
(paren
l_string|&quot;ip_fw_ctl:  malloc said no&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
r_return
id|ENOMEM
suffix:semicolon
)brace
id|memcpy
c_func
(paren
id|ftmp
comma
id|frwl
comma
id|len
)paren
suffix:semicolon
multiline_comment|/*&n;&t; *&t;Allow the more recent &quot;minimise cost&quot; flag to be&n;&t; *&t;set. [Rob van Nieuwkerk]&n;&t; */
id|ftmp-&gt;fw_tosand
op_or_assign
l_int|0x01
suffix:semicolon
id|ftmp-&gt;fw_tosxor
op_and_assign
l_int|0xFE
suffix:semicolon
id|ftmp-&gt;fw_pcnt
op_assign
l_int|0L
suffix:semicolon
id|ftmp-&gt;fw_bcnt
op_assign
l_int|0L
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|ftmp-&gt;fw_vianame
)paren
(braket
l_int|0
)braket
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|ftmp-&gt;fw_viadev
op_assign
id|dev_get_by_name
c_func
(paren
id|ftmp-&gt;fw_vianame
)paren
)paren
)paren
id|ftmp-&gt;fw_viadev
op_assign
(paren
r_struct
id|net_device
op_star
)paren
op_minus
l_int|1
suffix:semicolon
)brace
r_else
id|ftmp-&gt;fw_viadev
op_assign
l_int|NULL
suffix:semicolon
id|ftmp-&gt;fw_next
op_assign
op_star
id|chainptr
suffix:semicolon
op_star
id|chainptr
op_assign
id|ftmp
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|append_to_chain
r_static
r_int
id|append_to_chain
c_func
(paren
r_struct
id|ip_fw
op_star
r_volatile
op_star
id|chainptr
comma
r_struct
id|ip_fw
op_star
id|frwl
comma
r_int
id|len
)paren
(brace
r_struct
id|ip_fw
op_star
id|ftmp
suffix:semicolon
r_struct
id|ip_fw
op_star
id|chtmp
op_assign
l_int|NULL
suffix:semicolon
r_struct
id|ip_fw
op_star
r_volatile
id|chtmp_prev
op_assign
l_int|NULL
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|ftmp
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|ip_fw
)paren
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ftmp
op_eq
l_int|NULL
)paren
(brace
macro_line|#ifdef DEBUG_IP_FIREWALL
id|printk
c_func
(paren
l_string|&quot;ip_fw_ctl:  malloc said no&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
r_return
id|ENOMEM
suffix:semicolon
)brace
id|memcpy
c_func
(paren
id|ftmp
comma
id|frwl
comma
id|len
)paren
suffix:semicolon
multiline_comment|/*&n;&t; *&t;Allow the more recent &quot;minimise cost&quot; flag to be&n;&t; *&t;set. [Rob van Nieuwkerk]&n;&t; */
id|ftmp-&gt;fw_tosand
op_or_assign
l_int|0x01
suffix:semicolon
id|ftmp-&gt;fw_tosxor
op_and_assign
l_int|0xFE
suffix:semicolon
id|ftmp-&gt;fw_pcnt
op_assign
l_int|0L
suffix:semicolon
id|ftmp-&gt;fw_bcnt
op_assign
l_int|0L
suffix:semicolon
id|ftmp-&gt;fw_next
op_assign
l_int|NULL
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|ftmp-&gt;fw_vianame
)paren
(braket
l_int|0
)braket
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|ftmp-&gt;fw_viadev
op_assign
id|dev_get_by_name
c_func
(paren
id|ftmp-&gt;fw_vianame
)paren
)paren
)paren
id|ftmp-&gt;fw_viadev
op_assign
(paren
r_struct
id|net_device
op_star
)paren
op_minus
l_int|1
suffix:semicolon
)brace
r_else
id|ftmp-&gt;fw_viadev
op_assign
l_int|NULL
suffix:semicolon
id|chtmp_prev
op_assign
l_int|NULL
suffix:semicolon
r_for
c_loop
(paren
id|chtmp
op_assign
op_star
id|chainptr
suffix:semicolon
id|chtmp
op_ne
l_int|NULL
suffix:semicolon
id|chtmp
op_assign
id|chtmp-&gt;fw_next
)paren
id|chtmp_prev
op_assign
id|chtmp
suffix:semicolon
r_if
c_cond
(paren
id|chtmp_prev
)paren
id|chtmp_prev-&gt;fw_next
op_assign
id|ftmp
suffix:semicolon
r_else
op_star
id|chainptr
op_assign
id|ftmp
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|del_from_chain
r_static
r_int
id|del_from_chain
c_func
(paren
r_struct
id|ip_fw
op_star
r_volatile
op_star
id|chainptr
comma
r_struct
id|ip_fw
op_star
id|frwl
)paren
(brace
r_struct
id|ip_fw
op_star
id|ftmp
comma
op_star
id|ltmp
suffix:semicolon
r_int
r_int
id|tport1
comma
id|tport2
comma
id|tmpnum
suffix:semicolon
r_char
id|matches
comma
id|was_found
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|ftmp
op_assign
op_star
id|chainptr
suffix:semicolon
r_if
c_cond
(paren
id|ftmp
op_eq
l_int|NULL
)paren
(brace
macro_line|#ifdef DEBUG_IP_FIREWALL
id|printk
c_func
(paren
l_string|&quot;ip_fw_ctl:  chain is empty&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
id|EINVAL
suffix:semicolon
)brace
id|ltmp
op_assign
l_int|NULL
suffix:semicolon
id|was_found
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
op_logical_neg
id|was_found
op_logical_and
id|ftmp
op_ne
l_int|NULL
)paren
(brace
id|matches
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|ftmp-&gt;fw_src.s_addr
op_ne
id|frwl-&gt;fw_src.s_addr
op_logical_or
id|ftmp-&gt;fw_dst.s_addr
op_ne
id|frwl-&gt;fw_dst.s_addr
op_logical_or
id|ftmp-&gt;fw_smsk.s_addr
op_ne
id|frwl-&gt;fw_smsk.s_addr
op_logical_or
id|ftmp-&gt;fw_dmsk.s_addr
op_ne
id|frwl-&gt;fw_dmsk.s_addr
op_logical_or
id|ftmp-&gt;fw_via.s_addr
op_ne
id|frwl-&gt;fw_via.s_addr
op_logical_or
id|ftmp-&gt;fw_flg
op_ne
id|frwl-&gt;fw_flg
)paren
id|matches
op_assign
l_int|0
suffix:semicolon
id|tport1
op_assign
id|ftmp-&gt;fw_nsp
op_plus
id|ftmp-&gt;fw_ndp
suffix:semicolon
id|tport2
op_assign
id|frwl-&gt;fw_nsp
op_plus
id|frwl-&gt;fw_ndp
suffix:semicolon
r_if
c_cond
(paren
id|tport1
op_ne
id|tport2
)paren
id|matches
op_assign
l_int|0
suffix:semicolon
r_else
r_if
c_cond
(paren
id|tport1
op_ne
l_int|0
)paren
(brace
r_for
c_loop
(paren
id|tmpnum
op_assign
l_int|0
suffix:semicolon
id|tmpnum
OL
id|tport1
op_logical_and
id|tmpnum
OL
id|IP_FW_MAX_PORTS
suffix:semicolon
id|tmpnum
op_increment
)paren
r_if
c_cond
(paren
id|ftmp-&gt;fw_pts
(braket
id|tmpnum
)braket
op_ne
id|frwl-&gt;fw_pts
(braket
id|tmpnum
)braket
)paren
id|matches
op_assign
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|strncmp
c_func
(paren
id|ftmp-&gt;fw_vianame
comma
id|frwl-&gt;fw_vianame
comma
id|IFNAMSIZ
)paren
)paren
id|matches
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|matches
)paren
(brace
id|was_found
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|ltmp
)paren
(brace
id|ltmp-&gt;fw_next
op_assign
id|ftmp-&gt;fw_next
suffix:semicolon
id|kfree
c_func
(paren
id|ftmp
)paren
suffix:semicolon
id|ftmp
op_assign
id|ltmp-&gt;fw_next
suffix:semicolon
)brace
r_else
(brace
op_star
id|chainptr
op_assign
id|ftmp-&gt;fw_next
suffix:semicolon
id|kfree
c_func
(paren
id|ftmp
)paren
suffix:semicolon
id|ftmp
op_assign
op_star
id|chainptr
suffix:semicolon
)brace
)brace
r_else
(brace
id|ltmp
op_assign
id|ftmp
suffix:semicolon
id|ftmp
op_assign
id|ftmp-&gt;fw_next
suffix:semicolon
)brace
)brace
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|was_found
)paren
r_return
l_int|0
suffix:semicolon
r_else
r_return
id|EINVAL
suffix:semicolon
)brace
macro_line|#endif  /* CONFIG_IP_ACCT || CONFIG_IP_FIREWALL */
DECL|function|check_ipfw_struct
r_struct
id|ip_fw
op_star
id|check_ipfw_struct
c_func
(paren
r_struct
id|ip_fw
op_star
id|frwl
comma
r_int
id|len
)paren
(brace
r_if
c_cond
(paren
id|len
op_ne
r_sizeof
(paren
r_struct
id|ip_fw
)paren
)paren
(brace
macro_line|#ifdef DEBUG_IP_FIREWALL
id|printk
c_func
(paren
l_string|&quot;ip_fw_ctl: len=%d, want %d&bslash;n&quot;
comma
id|len
comma
r_sizeof
(paren
r_struct
id|ip_fw
)paren
)paren
suffix:semicolon
macro_line|#endif
r_return
l_int|NULL
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|frwl-&gt;fw_flg
op_amp
op_complement
id|IP_FW_F_MASK
)paren
op_ne
l_int|0
)paren
(brace
macro_line|#ifdef DEBUG_IP_FIREWALL
id|printk
c_func
(paren
l_string|&quot;ip_fw_ctl: undefined flag bits set (flags=%x)&bslash;n&quot;
comma
id|frwl-&gt;fw_flg
)paren
suffix:semicolon
macro_line|#endif
r_return
l_int|NULL
suffix:semicolon
)brace
macro_line|#ifndef CONFIG_IP_TRANSPARENT_PROXY
r_if
c_cond
(paren
id|frwl-&gt;fw_flg
op_amp
id|IP_FW_F_REDIR
)paren
(brace
macro_line|#ifdef DEBUG_IP_FIREWALL
id|printk
c_func
(paren
l_string|&quot;ip_fw_ctl: unsupported flag IP_FW_F_REDIR&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
r_return
l_int|NULL
suffix:semicolon
)brace
macro_line|#endif
macro_line|#ifndef CONFIG_IP_MASQUERADE
r_if
c_cond
(paren
id|frwl-&gt;fw_flg
op_amp
id|IP_FW_F_MASQ
)paren
(brace
macro_line|#ifdef DEBUG_IP_FIREWALL
id|printk
c_func
(paren
l_string|&quot;ip_fw_ctl: unsupported flag IP_FW_F_MASQ&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
r_return
l_int|NULL
suffix:semicolon
)brace
macro_line|#endif
r_if
c_cond
(paren
(paren
id|frwl-&gt;fw_flg
op_amp
id|IP_FW_F_SRNG
)paren
op_logical_and
id|frwl-&gt;fw_nsp
OL
l_int|2
)paren
(brace
macro_line|#ifdef DEBUG_IP_FIREWALL
id|printk
c_func
(paren
l_string|&quot;ip_fw_ctl: src range set but fw_nsp=%d&bslash;n&quot;
comma
id|frwl-&gt;fw_nsp
)paren
suffix:semicolon
macro_line|#endif
r_return
l_int|NULL
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|frwl-&gt;fw_flg
op_amp
id|IP_FW_F_DRNG
)paren
op_logical_and
id|frwl-&gt;fw_ndp
OL
l_int|2
)paren
(brace
macro_line|#ifdef DEBUG_IP_FIREWALL
id|printk
c_func
(paren
l_string|&quot;ip_fw_ctl: dst range set but fw_ndp=%d&bslash;n&quot;
comma
id|frwl-&gt;fw_ndp
)paren
suffix:semicolon
macro_line|#endif
r_return
l_int|NULL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|frwl-&gt;fw_nsp
op_plus
id|frwl-&gt;fw_ndp
OG
(paren
id|frwl-&gt;fw_flg
op_amp
id|IP_FW_F_REDIR
ques
c_cond
id|IP_FW_MAX_PORTS
op_minus
l_int|1
suffix:colon
id|IP_FW_MAX_PORTS
)paren
)paren
(brace
macro_line|#ifdef DEBUG_IP_FIREWALL
id|printk
c_func
(paren
l_string|&quot;ip_fw_ctl: too many ports (%d+%d)&bslash;n&quot;
comma
id|frwl-&gt;fw_nsp
comma
id|frwl-&gt;fw_ndp
)paren
suffix:semicolon
macro_line|#endif
r_return
l_int|NULL
suffix:semicolon
)brace
r_return
id|frwl
suffix:semicolon
)brace
macro_line|#ifdef CONFIG_IP_ACCT
DECL|function|ip_acct_ctl
r_int
id|ip_acct_ctl
c_func
(paren
r_int
id|stage
comma
r_void
op_star
id|m
comma
r_int
id|len
)paren
(brace
r_if
c_cond
(paren
id|stage
op_eq
id|IP_ACCT_FLUSH
)paren
(brace
id|free_fw_chain
c_func
(paren
op_amp
id|ip_acct_chain
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|stage
op_eq
id|IP_ACCT_ZERO
)paren
(brace
id|zero_fw_chain
c_func
(paren
id|ip_acct_chain
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|stage
op_eq
id|IP_ACCT_INSERT
op_logical_or
id|stage
op_eq
id|IP_ACCT_APPEND
op_logical_or
id|stage
op_eq
id|IP_ACCT_DELETE
)paren
(brace
r_struct
id|ip_fw
op_star
id|frwl
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|frwl
op_assign
id|check_ipfw_struct
c_func
(paren
id|m
comma
id|len
)paren
)paren
)paren
r_return
(paren
id|EINVAL
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|stage
)paren
(brace
r_case
id|IP_ACCT_INSERT
suffix:colon
r_return
id|insert_in_chain
c_func
(paren
op_amp
id|ip_acct_chain
comma
id|frwl
comma
id|len
)paren
suffix:semicolon
r_case
id|IP_ACCT_APPEND
suffix:colon
r_return
id|append_to_chain
c_func
(paren
op_amp
id|ip_acct_chain
comma
id|frwl
comma
id|len
)paren
suffix:semicolon
r_case
id|IP_ACCT_DELETE
suffix:colon
r_return
id|del_from_chain
c_func
(paren
op_amp
id|ip_acct_chain
comma
id|frwl
)paren
suffix:semicolon
r_default
suffix:colon
multiline_comment|/*&n; &t;&t;&t;&t; *&t;Should be panic but... (Why ??? - AC)&n;&t;&t;&t;&t; */
macro_line|#ifdef DEBUG_IP_FIREWALL
id|printk
c_func
(paren
l_string|&quot;ip_acct_ctl:  unknown request %d&bslash;n&quot;
comma
id|stage
)paren
suffix:semicolon
macro_line|#endif
r_return
id|EINVAL
suffix:semicolon
)brace
)brace
macro_line|#ifdef DEBUG_IP_FIREWALL
id|printk
c_func
(paren
l_string|&quot;ip_acct_ctl:  unknown request %d&bslash;n&quot;
comma
id|stage
)paren
suffix:semicolon
macro_line|#endif
r_return
id|EINVAL
suffix:semicolon
)brace
macro_line|#endif
macro_line|#ifdef CONFIG_IP_FIREWALL
DECL|function|ip_fw_ctl
r_int
id|ip_fw_ctl
c_func
(paren
r_int
id|stage
comma
r_void
op_star
id|m
comma
r_int
id|len
)paren
(brace
r_int
id|cmd
comma
id|fwtype
suffix:semicolon
id|cmd
op_assign
id|stage
op_amp
id|IP_FW_COMMAND
suffix:semicolon
id|fwtype
op_assign
(paren
id|stage
op_amp
id|IP_FW_TYPE
)paren
op_rshift
id|IP_FW_SHIFT
suffix:semicolon
r_if
c_cond
(paren
id|cmd
op_eq
id|IP_FW_FLUSH
)paren
(brace
id|free_fw_chain
c_func
(paren
id|chains
(braket
id|fwtype
)braket
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|cmd
op_eq
id|IP_FW_ZERO
)paren
(brace
id|zero_fw_chain
c_func
(paren
op_star
id|chains
(braket
id|fwtype
)braket
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|cmd
op_eq
id|IP_FW_POLICY
)paren
(brace
r_int
op_star
id|tmp_policy_ptr
suffix:semicolon
id|tmp_policy_ptr
op_assign
(paren
r_int
op_star
)paren
id|m
suffix:semicolon
op_star
id|policies
(braket
id|fwtype
)braket
op_assign
op_star
id|tmp_policy_ptr
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|cmd
op_eq
id|IP_FW_CHECK
)paren
(brace
r_struct
id|net_device
op_star
id|viadev
suffix:semicolon
r_struct
id|ip_fwpkt
op_star
id|ipfwp
suffix:semicolon
r_struct
id|iphdr
op_star
id|ip
suffix:semicolon
r_if
c_cond
(paren
id|len
op_ne
r_sizeof
(paren
r_struct
id|ip_fwpkt
)paren
)paren
(brace
macro_line|#ifdef DEBUG_IP_FIREWALL
id|printk
c_func
(paren
l_string|&quot;ip_fw_ctl: length=%d, expected %d&bslash;n&quot;
comma
id|len
comma
r_sizeof
(paren
r_struct
id|ip_fwpkt
)paren
)paren
suffix:semicolon
macro_line|#endif
r_return
id|EINVAL
suffix:semicolon
)brace
id|ipfwp
op_assign
(paren
r_struct
id|ip_fwpkt
op_star
)paren
id|m
suffix:semicolon
id|ip
op_assign
op_amp
(paren
id|ipfwp-&gt;fwp_iph
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|viadev
op_assign
id|dev_get_by_name
c_func
(paren
id|ipfwp-&gt;fwp_vianame
)paren
)paren
)paren
(brace
macro_line|#ifdef DEBUG_IP_FIREWALL
id|printk
c_func
(paren
l_string|&quot;ip_fw_ctl: invalid device &bslash;&quot;%s&bslash;&quot;&bslash;n&quot;
comma
id|ipfwp-&gt;fwp_vianame
)paren
suffix:semicolon
macro_line|#endif
r_return
id|EINVAL
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|ip-&gt;ihl
op_ne
r_sizeof
(paren
r_struct
id|iphdr
)paren
op_div
r_sizeof
(paren
r_int
)paren
)paren
(brace
macro_line|#ifdef DEBUG_IP_FIREWALL
id|printk
c_func
(paren
l_string|&quot;ip_fw_ctl: ip-&gt;ihl=%d, want %d&bslash;n&quot;
comma
id|ip-&gt;ihl
comma
r_sizeof
(paren
r_struct
id|iphdr
)paren
op_div
r_sizeof
(paren
r_int
)paren
)paren
suffix:semicolon
macro_line|#endif
r_return
id|EINVAL
suffix:semicolon
)brace
r_switch
c_cond
(paren
id|ip_fw_chk
c_func
(paren
id|ip
comma
id|viadev
comma
l_int|NULL
comma
op_star
id|chains
(braket
id|fwtype
)braket
comma
op_star
id|policies
(braket
id|fwtype
)braket
comma
id|IP_FW_MODE_CHK
)paren
)paren
(brace
r_case
id|FW_ACCEPT
suffix:colon
r_return
l_int|0
suffix:semicolon
r_case
id|FW_REDIRECT
suffix:colon
r_return
id|ECONNABORTED
suffix:semicolon
r_case
id|FW_MASQUERADE
suffix:colon
r_return
id|ECONNRESET
suffix:semicolon
r_case
id|FW_REJECT
suffix:colon
r_return
id|ECONNREFUSED
suffix:semicolon
r_default
suffix:colon
multiline_comment|/* FW_BLOCK */
r_return
id|ETIMEDOUT
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|cmd
op_eq
id|IP_FW_MASQ_TIMEOUTS
)paren
r_return
id|ip_fw_masq_timeouts
c_func
(paren
id|m
comma
id|len
)paren
suffix:semicolon
multiline_comment|/*&n; *&t;Here we really working hard-adding new elements&n; *&t;to blocking/forwarding chains or deleting &squot;em&n; */
r_if
c_cond
(paren
id|cmd
op_eq
id|IP_FW_INSERT
op_logical_or
id|cmd
op_eq
id|IP_FW_APPEND
op_logical_or
id|cmd
op_eq
id|IP_FW_DELETE
)paren
(brace
r_struct
id|ip_fw
op_star
id|frwl
suffix:semicolon
r_int
id|fwtype
suffix:semicolon
id|frwl
op_assign
id|check_ipfw_struct
c_func
(paren
id|m
comma
id|len
)paren
suffix:semicolon
r_if
c_cond
(paren
id|frwl
op_eq
l_int|NULL
)paren
r_return
(paren
id|EINVAL
)paren
suffix:semicolon
id|fwtype
op_assign
(paren
id|stage
op_amp
id|IP_FW_TYPE
)paren
op_rshift
id|IP_FW_SHIFT
suffix:semicolon
r_switch
c_cond
(paren
id|cmd
)paren
(brace
r_case
id|IP_FW_INSERT
suffix:colon
r_return
id|insert_in_chain
c_func
(paren
id|chains
(braket
id|fwtype
)braket
comma
id|frwl
comma
id|len
)paren
suffix:semicolon
r_case
id|IP_FW_APPEND
suffix:colon
r_return
id|append_to_chain
c_func
(paren
id|chains
(braket
id|fwtype
)braket
comma
id|frwl
comma
id|len
)paren
suffix:semicolon
r_case
id|IP_FW_DELETE
suffix:colon
r_return
id|del_from_chain
c_func
(paren
id|chains
(braket
id|fwtype
)braket
comma
id|frwl
)paren
suffix:semicolon
r_default
suffix:colon
multiline_comment|/*&n;&t; &t;&t; *&t;Should be panic but... (Why are BSD people panic obsessed ??)&n;&t;&t;&t; */
macro_line|#ifdef DEBUG_IP_FIREWALL
id|printk
c_func
(paren
l_string|&quot;ip_fw_ctl:  unknown request %d&bslash;n&quot;
comma
id|stage
)paren
suffix:semicolon
macro_line|#endif
r_return
id|EINVAL
suffix:semicolon
)brace
)brace
macro_line|#ifdef DEBUG_IP_FIREWALL
id|printk
c_func
(paren
l_string|&quot;ip_fw_ctl:  unknown request %d&bslash;n&quot;
comma
id|stage
)paren
suffix:semicolon
macro_line|#endif
r_return
id|ENOPROTOOPT
suffix:semicolon
)brace
macro_line|#endif /* CONFIG_IP_FIREWALL */
macro_line|#if defined(CONFIG_IP_FIREWALL) || defined(CONFIG_IP_ACCT)
DECL|function|ip_chain_procinfo
r_static
r_int
id|ip_chain_procinfo
c_func
(paren
r_int
id|stage
comma
r_char
op_star
id|buffer
comma
r_char
op_star
op_star
id|start
comma
id|off_t
id|offset
comma
r_int
id|length
comma
r_int
id|reset
)paren
(brace
id|off_t
id|pos
op_assign
l_int|0
comma
id|begin
op_assign
l_int|0
suffix:semicolon
r_struct
id|ip_fw
op_star
id|i
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_int
id|len
comma
id|p
suffix:semicolon
r_int
id|last_len
op_assign
l_int|0
suffix:semicolon
r_switch
c_cond
(paren
id|stage
)paren
(brace
macro_line|#ifdef CONFIG_IP_FIREWALL
r_case
id|IP_FW_IN
suffix:colon
id|i
op_assign
id|ip_fw_in_chain
suffix:semicolon
id|len
op_assign
id|sprintf
c_func
(paren
id|buffer
comma
l_string|&quot;IP firewall input rules, default %d&bslash;n&quot;
comma
id|ip_fw_in_policy
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|IP_FW_OUT
suffix:colon
id|i
op_assign
id|ip_fw_out_chain
suffix:semicolon
id|len
op_assign
id|sprintf
c_func
(paren
id|buffer
comma
l_string|&quot;IP firewall output rules, default %d&bslash;n&quot;
comma
id|ip_fw_out_policy
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|IP_FW_FWD
suffix:colon
id|i
op_assign
id|ip_fw_fwd_chain
suffix:semicolon
id|len
op_assign
id|sprintf
c_func
(paren
id|buffer
comma
l_string|&quot;IP firewall forward rules, default %d&bslash;n&quot;
comma
id|ip_fw_fwd_policy
)paren
suffix:semicolon
r_break
suffix:semicolon
macro_line|#endif
macro_line|#ifdef CONFIG_IP_ACCT
r_case
id|IP_FW_ACCT
suffix:colon
id|i
op_assign
id|ip_acct_chain
suffix:semicolon
id|len
op_assign
id|sprintf
c_func
(paren
id|buffer
comma
l_string|&quot;IP accounting rules&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
macro_line|#endif
r_default
suffix:colon
multiline_comment|/* this should never be reached, but safety first... */
id|i
op_assign
l_int|NULL
suffix:semicolon
id|len
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
)brace
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
r_while
c_loop
(paren
id|i
op_ne
l_int|NULL
)paren
(brace
id|len
op_add_assign
id|sprintf
c_func
(paren
id|buffer
op_plus
id|len
comma
l_string|&quot;%08X/%08X-&gt;%08X/%08X %.16s %08X %X &quot;
comma
id|ntohl
c_func
(paren
id|i-&gt;fw_src.s_addr
)paren
comma
id|ntohl
c_func
(paren
id|i-&gt;fw_smsk.s_addr
)paren
comma
id|ntohl
c_func
(paren
id|i-&gt;fw_dst.s_addr
)paren
comma
id|ntohl
c_func
(paren
id|i-&gt;fw_dmsk.s_addr
)paren
comma
(paren
id|i-&gt;fw_vianame
)paren
(braket
l_int|0
)braket
ques
c_cond
id|i-&gt;fw_vianame
suffix:colon
l_string|&quot;-&quot;
comma
id|ntohl
c_func
(paren
id|i-&gt;fw_via.s_addr
)paren
comma
id|i-&gt;fw_flg
)paren
suffix:semicolon
multiline_comment|/* 10 is enough for a 32 bit box but the counters are 64bit on&n;&t;&t;   the Alpha and Ultrapenguin */
id|len
op_add_assign
id|sprintf
c_func
(paren
id|buffer
op_plus
id|len
comma
l_string|&quot;%u %u %-20lu %-20lu&quot;
comma
id|i-&gt;fw_nsp
comma
id|i-&gt;fw_ndp
comma
id|i-&gt;fw_pcnt
comma
id|i-&gt;fw_bcnt
)paren
suffix:semicolon
r_for
c_loop
(paren
id|p
op_assign
l_int|0
suffix:semicolon
id|p
OL
id|IP_FW_MAX_PORTS
suffix:semicolon
id|p
op_increment
)paren
id|len
op_add_assign
id|sprintf
c_func
(paren
id|buffer
op_plus
id|len
comma
l_string|&quot; %u&quot;
comma
id|i-&gt;fw_pts
(braket
id|p
)braket
)paren
suffix:semicolon
id|len
op_add_assign
id|sprintf
c_func
(paren
id|buffer
op_plus
id|len
comma
l_string|&quot; A%02X X%02X&quot;
comma
id|i-&gt;fw_tosand
comma
id|i-&gt;fw_tosxor
)paren
suffix:semicolon
id|buffer
(braket
id|len
op_increment
)braket
op_assign
l_char|&squot;&bslash;n&squot;
suffix:semicolon
id|buffer
(braket
id|len
)braket
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
id|pos
op_assign
id|begin
op_plus
id|len
suffix:semicolon
r_if
c_cond
(paren
id|pos
OL
id|offset
)paren
(brace
id|len
op_assign
l_int|0
suffix:semicolon
id|begin
op_assign
id|pos
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|pos
OG
id|offset
op_plus
id|length
)paren
(brace
id|len
op_assign
id|last_len
suffix:semicolon
r_break
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|reset
)paren
(brace
multiline_comment|/* This needs to be done at this specific place! */
id|i-&gt;fw_pcnt
op_assign
l_int|0L
suffix:semicolon
id|i-&gt;fw_bcnt
op_assign
l_int|0L
suffix:semicolon
)brace
id|last_len
op_assign
id|len
suffix:semicolon
id|i
op_assign
id|i-&gt;fw_next
suffix:semicolon
)brace
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
op_star
id|start
op_assign
id|buffer
op_plus
(paren
id|offset
op_minus
id|begin
)paren
suffix:semicolon
id|len
op_sub_assign
(paren
id|offset
op_minus
id|begin
)paren
suffix:semicolon
r_if
c_cond
(paren
id|len
OG
id|length
)paren
(brace
id|len
op_assign
id|length
suffix:semicolon
)brace
r_return
id|len
suffix:semicolon
)brace
macro_line|#endif
macro_line|#ifdef CONFIG_IP_ACCT
DECL|function|ip_acct_procinfo
r_static
r_int
id|ip_acct_procinfo
c_func
(paren
r_char
op_star
id|buffer
comma
r_char
op_star
op_star
id|start
comma
id|off_t
id|offset
comma
r_int
id|length
macro_line|#if LINUX_VERSION_CODE &lt; KERNEL_VERSION(2,3,29)
comma
r_int
id|reset
macro_line|#endif
)paren
(brace
macro_line|#if LINUX_VERSION_CODE &gt;= KERNEL_VERSION(2,3,29)
multiline_comment|/* FIXME: No more `atomic&squot; read and reset.  Wonderful 8-( --RR */
r_int
id|reset
op_assign
l_int|0
suffix:semicolon
macro_line|#endif
r_return
id|ip_chain_procinfo
c_func
(paren
id|IP_FW_ACCT
comma
id|buffer
comma
id|start
comma
id|offset
comma
id|length
comma
id|reset
)paren
suffix:semicolon
)brace
macro_line|#endif
macro_line|#ifdef CONFIG_IP_FIREWALL
DECL|function|ip_fw_in_procinfo
r_static
r_int
id|ip_fw_in_procinfo
c_func
(paren
r_char
op_star
id|buffer
comma
r_char
op_star
op_star
id|start
comma
id|off_t
id|offset
comma
r_int
id|length
macro_line|#if LINUX_VERSION_CODE &lt; KERNEL_VERSION(2,3,29)
comma
r_int
id|reset
macro_line|#endif
)paren
(brace
macro_line|#if LINUX_VERSION_CODE &gt;= KERNEL_VERSION(2,3,29)
multiline_comment|/* FIXME: No more `atomic&squot; read and reset.  Wonderful 8-( --RR */
r_int
id|reset
op_assign
l_int|0
suffix:semicolon
macro_line|#endif
r_return
id|ip_chain_procinfo
c_func
(paren
id|IP_FW_IN
comma
id|buffer
comma
id|start
comma
id|offset
comma
id|length
comma
id|reset
)paren
suffix:semicolon
)brace
DECL|function|ip_fw_out_procinfo
r_static
r_int
id|ip_fw_out_procinfo
c_func
(paren
r_char
op_star
id|buffer
comma
r_char
op_star
op_star
id|start
comma
id|off_t
id|offset
comma
r_int
id|length
macro_line|#if LINUX_VERSION_CODE &lt; KERNEL_VERSION(2,3,29)
comma
r_int
id|reset
macro_line|#endif
)paren
(brace
macro_line|#if LINUX_VERSION_CODE &gt;= KERNEL_VERSION(2,3,29)
multiline_comment|/* FIXME: No more `atomic&squot; read and reset.  Wonderful 8-( --RR */
r_int
id|reset
op_assign
l_int|0
suffix:semicolon
macro_line|#endif
r_return
id|ip_chain_procinfo
c_func
(paren
id|IP_FW_OUT
comma
id|buffer
comma
id|start
comma
id|offset
comma
id|length
comma
id|reset
)paren
suffix:semicolon
)brace
DECL|function|ip_fw_fwd_procinfo
r_static
r_int
id|ip_fw_fwd_procinfo
c_func
(paren
r_char
op_star
id|buffer
comma
r_char
op_star
op_star
id|start
comma
id|off_t
id|offset
comma
r_int
id|length
macro_line|#if LINUX_VERSION_CODE &lt; KERNEL_VERSION(2,3,29)
comma
r_int
id|reset
macro_line|#endif
)paren
(brace
macro_line|#if LINUX_VERSION_CODE &gt;= KERNEL_VERSION(2,3,29)
multiline_comment|/* FIXME: No more `atomic&squot; read and reset.  Wonderful 8-( --RR */
r_int
id|reset
op_assign
l_int|0
suffix:semicolon
macro_line|#endif
r_return
id|ip_chain_procinfo
c_func
(paren
id|IP_FW_FWD
comma
id|buffer
comma
id|start
comma
id|offset
comma
id|length
comma
id|reset
)paren
suffix:semicolon
)brace
macro_line|#endif
macro_line|#ifdef CONFIG_IP_FIREWALL
multiline_comment|/*&n; *&t;Interface to the generic firewall chains.&n; */
DECL|function|ipfw_input_check
r_int
id|ipfw_input_check
c_func
(paren
r_struct
id|firewall_ops
op_star
id|this
comma
r_int
id|pf
comma
r_struct
id|net_device
op_star
id|dev
comma
r_void
op_star
id|phdr
comma
r_void
op_star
id|arg
comma
r_struct
id|sk_buff
op_star
op_star
id|pskb
)paren
(brace
r_return
id|ip_fw_chk
c_func
(paren
id|phdr
comma
id|dev
comma
id|arg
comma
id|ip_fw_in_chain
comma
id|ip_fw_in_policy
comma
id|IP_FW_MODE_FW
)paren
suffix:semicolon
)brace
DECL|function|ipfw_output_check
r_int
id|ipfw_output_check
c_func
(paren
r_struct
id|firewall_ops
op_star
id|this
comma
r_int
id|pf
comma
r_struct
id|net_device
op_star
id|dev
comma
r_void
op_star
id|phdr
comma
r_void
op_star
id|arg
comma
r_struct
id|sk_buff
op_star
op_star
id|pskb
)paren
(brace
r_return
id|ip_fw_chk
c_func
(paren
id|phdr
comma
id|dev
comma
id|arg
comma
id|ip_fw_out_chain
comma
id|ip_fw_out_policy
comma
id|IP_FW_MODE_FW
)paren
suffix:semicolon
)brace
DECL|function|ipfw_forward_check
r_int
id|ipfw_forward_check
c_func
(paren
r_struct
id|firewall_ops
op_star
id|this
comma
r_int
id|pf
comma
r_struct
id|net_device
op_star
id|dev
comma
r_void
op_star
id|phdr
comma
r_void
op_star
id|arg
comma
r_struct
id|sk_buff
op_star
op_star
id|pskb
)paren
(brace
r_return
id|ip_fw_chk
c_func
(paren
id|phdr
comma
id|dev
comma
id|arg
comma
id|ip_fw_fwd_chain
comma
id|ip_fw_fwd_policy
comma
id|IP_FW_MODE_FW
)paren
suffix:semicolon
)brace
macro_line|#ifdef CONFIG_IP_ACCT
DECL|function|ipfw_acct_in
r_int
id|ipfw_acct_in
c_func
(paren
r_struct
id|firewall_ops
op_star
id|this
comma
r_int
id|pf
comma
r_struct
id|net_device
op_star
id|dev
comma
r_void
op_star
id|phdr
comma
r_void
op_star
id|arg
comma
r_struct
id|sk_buff
op_star
op_star
id|pskb
)paren
(brace
r_return
id|ip_fw_chk
c_func
(paren
id|phdr
comma
id|dev
comma
l_int|NULL
comma
id|ip_acct_chain
comma
l_int|0
comma
id|IP_FW_MODE_ACCT_IN
)paren
suffix:semicolon
)brace
DECL|function|ipfw_acct_out
r_int
id|ipfw_acct_out
c_func
(paren
r_struct
id|firewall_ops
op_star
id|this
comma
r_int
id|pf
comma
r_struct
id|net_device
op_star
id|dev
comma
r_void
op_star
id|phdr
comma
r_void
op_star
id|arg
comma
r_struct
id|sk_buff
op_star
op_star
id|pskb
)paren
(brace
r_return
id|ip_fw_chk
c_func
(paren
id|phdr
comma
id|dev
comma
l_int|NULL
comma
id|ip_acct_chain
comma
l_int|0
comma
id|IP_FW_MODE_ACCT_OUT
)paren
suffix:semicolon
)brace
macro_line|#endif
DECL|variable|ipfw_ops
r_struct
id|firewall_ops
id|ipfw_ops
op_assign
(brace
l_int|NULL
comma
id|ipfw_forward_check
comma
id|ipfw_input_check
comma
id|ipfw_output_check
comma
macro_line|#ifdef CONFIG_IP_ACCT
id|ipfw_acct_in
comma
id|ipfw_acct_out
macro_line|#else
l_int|NULL
comma
l_int|NULL
macro_line|#endif
)brace
suffix:semicolon
macro_line|#endif
macro_line|#if defined(CONFIG_IP_ACCT) || defined(CONFIG_IP_FIREWALL)
DECL|function|ipfw_device_event
r_int
id|ipfw_device_event
c_func
(paren
r_struct
id|notifier_block
op_star
id|this
comma
r_int
r_int
id|event
comma
r_void
op_star
id|ptr
)paren
(brace
r_struct
id|net_device
op_star
id|dev
op_assign
id|ptr
suffix:semicolon
r_char
op_star
id|devname
op_assign
id|dev-&gt;name
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_struct
id|ip_fw
op_star
id|fw
suffix:semicolon
r_int
id|chn
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|event
op_eq
id|NETDEV_UP
)paren
(brace
r_for
c_loop
(paren
id|chn
op_assign
l_int|0
suffix:semicolon
id|chn
OL
id|IP_FW_CHAINS
suffix:semicolon
id|chn
op_increment
)paren
r_for
c_loop
(paren
id|fw
op_assign
op_star
id|chains
(braket
id|chn
)braket
suffix:semicolon
id|fw
suffix:semicolon
id|fw
op_assign
id|fw-&gt;fw_next
)paren
r_if
c_cond
(paren
(paren
id|fw-&gt;fw_vianame
)paren
(braket
l_int|0
)braket
op_logical_and
op_logical_neg
id|strncmp
c_func
(paren
id|devname
comma
id|fw-&gt;fw_vianame
comma
id|IFNAMSIZ
)paren
)paren
id|fw-&gt;fw_viadev
op_assign
id|dev
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|event
op_eq
id|NETDEV_DOWN
)paren
(brace
r_for
c_loop
(paren
id|chn
op_assign
l_int|0
suffix:semicolon
id|chn
OL
id|IP_FW_CHAINS
suffix:semicolon
id|chn
op_increment
)paren
r_for
c_loop
(paren
id|fw
op_assign
op_star
id|chains
(braket
id|chn
)braket
suffix:semicolon
id|fw
suffix:semicolon
id|fw
op_assign
id|fw-&gt;fw_next
)paren
multiline_comment|/* we could compare just the pointers ... */
r_if
c_cond
(paren
(paren
id|fw-&gt;fw_vianame
)paren
(braket
l_int|0
)braket
op_logical_and
op_logical_neg
id|strncmp
c_func
(paren
id|devname
comma
id|fw-&gt;fw_vianame
comma
id|IFNAMSIZ
)paren
)paren
id|fw-&gt;fw_viadev
op_assign
(paren
r_struct
id|net_device
op_star
)paren
op_minus
l_int|1
suffix:semicolon
)brace
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
id|NOTIFY_DONE
suffix:semicolon
)brace
DECL|variable|ipfw_dev_notifier
r_static
r_struct
id|notifier_block
id|ipfw_dev_notifier
op_assign
initialization_block
suffix:semicolon
macro_line|#endif
DECL|function|ipfw_init_or_cleanup
r_int
id|ipfw_init_or_cleanup
c_func
(paren
r_int
id|init
)paren
(brace
r_int
id|ret
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|init
)paren
r_goto
id|cleanup
suffix:semicolon
id|ret
op_assign
id|register_firewall
c_func
(paren
id|PF_INET
comma
op_amp
id|ipfw_ops
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
OL
l_int|0
)paren
r_goto
id|cleanup_nothing
suffix:semicolon
macro_line|#ifdef CONFIG_IP_ACCT
id|proc_net_create
c_func
(paren
l_string|&quot;ip_acct&quot;
comma
id|S_IFREG
op_or
id|S_IRUGO
op_or
id|S_IWUSR
comma
id|ip_acct_procinfo
)paren
suffix:semicolon
macro_line|#endif
id|proc_net_create
c_func
(paren
l_string|&quot;ip_input&quot;
comma
id|S_IFREG
op_or
id|S_IRUGO
op_or
id|S_IWUSR
comma
id|ip_fw_in_procinfo
)paren
suffix:semicolon
id|proc_net_create
c_func
(paren
l_string|&quot;ip_output&quot;
comma
id|S_IFREG
op_or
id|S_IRUGO
op_or
id|S_IWUSR
comma
id|ip_fw_out_procinfo
)paren
suffix:semicolon
id|proc_net_create
c_func
(paren
l_string|&quot;ip_forward&quot;
comma
id|S_IFREG
op_or
id|S_IRUGO
op_or
id|S_IWUSR
comma
id|ip_fw_fwd_procinfo
)paren
suffix:semicolon
multiline_comment|/* Register for device up/down reports */
id|register_netdevice_notifier
c_func
(paren
op_amp
id|ipfw_dev_notifier
)paren
suffix:semicolon
macro_line|#ifdef CONFIG_IP_FIREWALL_NETLINK
id|ipfwsk
op_assign
id|netlink_kernel_create
c_func
(paren
id|NETLINK_FIREWALL
comma
l_int|NULL
)paren
suffix:semicolon
macro_line|#endif
r_return
id|ret
suffix:semicolon
id|cleanup
suffix:colon
macro_line|#ifdef CONFIG_IP_FIREWALL_NETLINK
id|sock_release
c_func
(paren
id|ipfwsk-&gt;socket
)paren
suffix:semicolon
macro_line|#endif
id|unregister_netdevice_notifier
c_func
(paren
op_amp
id|ipfw_dev_notifier
)paren
suffix:semicolon
macro_line|#ifdef CONFIG_IP_ACCT
id|proc_net_remove
c_func
(paren
l_string|&quot;ip_acct&quot;
)paren
suffix:semicolon
macro_line|#endif
id|proc_net_remove
c_func
(paren
l_string|&quot;ip_input&quot;
)paren
suffix:semicolon
id|proc_net_remove
c_func
(paren
l_string|&quot;ip_output&quot;
)paren
suffix:semicolon
id|proc_net_remove
c_func
(paren
l_string|&quot;ip_forward&quot;
)paren
suffix:semicolon
id|free_fw_chain
c_func
(paren
id|chains
(braket
id|IP_FW_FWD
)braket
)paren
suffix:semicolon
id|free_fw_chain
c_func
(paren
id|chains
(braket
id|IP_FW_IN
)braket
)paren
suffix:semicolon
id|free_fw_chain
c_func
(paren
id|chains
(braket
id|IP_FW_OUT
)braket
)paren
suffix:semicolon
id|free_fw_chain
c_func
(paren
id|chains
(braket
id|IP_FW_ACCT
)braket
)paren
suffix:semicolon
id|unregister_firewall
c_func
(paren
id|PF_INET
comma
op_amp
id|ipfw_ops
)paren
suffix:semicolon
id|cleanup_nothing
suffix:colon
r_return
id|ret
suffix:semicolon
)brace
eof
