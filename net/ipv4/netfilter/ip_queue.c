multiline_comment|/*&n; * This is a module which is used for queueing IPv4 packets and&n; * communicating with userspace via netlink.&n; *&n; * (C) 2000 James Morris&n; */
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/skbuff.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/ip.h&gt;
macro_line|#include &lt;linux/notifier.h&gt;
macro_line|#include &lt;linux/netdevice.h&gt;
macro_line|#include &lt;linux/netfilter.h&gt;
macro_line|#include &lt;linux/netlink.h&gt;
macro_line|#include &lt;linux/spinlock.h&gt;
macro_line|#include &lt;linux/smp_lock.h&gt;
macro_line|#include &lt;linux/rtnetlink.h&gt;
macro_line|#include &lt;linux/sysctl.h&gt;
macro_line|#include &lt;linux/proc_fs.h&gt;
macro_line|#include &lt;net/sock.h&gt;
macro_line|#include &lt;linux/netfilter_ipv4/ip_queue.h&gt;
id|EXPORT_NO_SYMBOLS
suffix:semicolon
DECL|macro|IPQ_THR_NAME
mdefine_line|#define IPQ_THR_NAME &quot;kipq&quot;
DECL|macro|IPQ_NAME
mdefine_line|#define IPQ_NAME &quot;ip_queue&quot;
DECL|macro|IPQ_QMAX_DEFAULT
mdefine_line|#define IPQ_QMAX_DEFAULT 1024
DECL|macro|IPQ_PROC_FS_NAME
mdefine_line|#define IPQ_PROC_FS_NAME &quot;ip_queue&quot;
DECL|macro|NET_IPQ_QMAX
mdefine_line|#define NET_IPQ_QMAX 2088
DECL|macro|NET_IPQ_QMAX_NAME
mdefine_line|#define NET_IPQ_QMAX_NAME &quot;ip_queue_maxlen&quot;
DECL|struct|ipq_queue_element
r_typedef
r_struct
id|ipq_queue_element
(brace
DECL|member|list
r_struct
id|list_head
id|list
suffix:semicolon
multiline_comment|/* Links element into queue */
DECL|member|state
r_int
r_char
id|state
suffix:semicolon
multiline_comment|/* State of this element */
DECL|member|verdict
r_int
id|verdict
suffix:semicolon
multiline_comment|/* Current verdict */
DECL|member|info
r_struct
id|nf_info
op_star
id|info
suffix:semicolon
multiline_comment|/* Extra info from netfilter */
DECL|member|skb
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
multiline_comment|/* Packet inside */
DECL|typedef|ipq_queue_element_t
)brace
id|ipq_queue_element_t
suffix:semicolon
DECL|typedef|ipq_send_cb_t
r_typedef
r_int
(paren
op_star
id|ipq_send_cb_t
)paren
(paren
id|ipq_queue_element_t
op_star
id|e
)paren
suffix:semicolon
DECL|struct|ipq_peer
r_typedef
r_struct
id|ipq_peer
(brace
DECL|member|pid
id|pid_t
id|pid
suffix:semicolon
multiline_comment|/* PID of userland peer */
DECL|member|died
r_int
r_char
id|died
suffix:semicolon
multiline_comment|/* We think the peer died */
DECL|member|copy_mode
r_int
r_char
id|copy_mode
suffix:semicolon
multiline_comment|/* Copy packet as well as metadata? */
DECL|member|copy_range
r_int
id|copy_range
suffix:semicolon
multiline_comment|/* Range past metadata to copy */
DECL|member|send
id|ipq_send_cb_t
id|send
suffix:semicolon
multiline_comment|/* Callback for sending data to peer */
DECL|typedef|ipq_peer_t
)brace
id|ipq_peer_t
suffix:semicolon
DECL|struct|ipq_thread
r_typedef
r_struct
id|ipq_thread
(brace
DECL|member|pid
id|pid_t
id|pid
suffix:semicolon
multiline_comment|/* PID of kernel thread */
DECL|member|terminate
r_int
r_char
id|terminate
suffix:semicolon
multiline_comment|/* Termination flag */
DECL|member|running
r_int
r_char
id|running
suffix:semicolon
multiline_comment|/* Running flag */
DECL|member|wq
id|wait_queue_head_t
id|wq
suffix:semicolon
multiline_comment|/* I/O wait queue */
DECL|member|process
r_void
(paren
op_star
id|process
)paren
(paren
r_void
op_star
id|data
)paren
suffix:semicolon
multiline_comment|/* Queue processing function */
DECL|typedef|ipq_thread_t
)brace
id|ipq_thread_t
suffix:semicolon
DECL|struct|ipq_queue
r_typedef
r_struct
id|ipq_queue
(brace
DECL|member|len
r_int
id|len
suffix:semicolon
multiline_comment|/* Current queue len */
DECL|member|maxlen
r_int
op_star
id|maxlen
suffix:semicolon
multiline_comment|/* Maximum queue len, via sysctl */
DECL|member|state
r_int
r_char
id|state
suffix:semicolon
multiline_comment|/* Current queue state */
DECL|member|list
r_struct
id|list_head
id|list
suffix:semicolon
multiline_comment|/* Head of packet queue */
DECL|member|lock
id|spinlock_t
id|lock
suffix:semicolon
multiline_comment|/* Queue spinlock */
DECL|member|peer
id|ipq_peer_t
id|peer
suffix:semicolon
multiline_comment|/* Userland peer */
DECL|member|thread
id|ipq_thread_t
id|thread
suffix:semicolon
multiline_comment|/* Thread context */
DECL|typedef|ipq_queue_t
)brace
id|ipq_queue_t
suffix:semicolon
multiline_comment|/****************************************************************************&n;*&n;* Kernel thread&n;*&n;****************************************************************************/
DECL|function|ipq_thread_init
r_static
r_void
id|ipq_thread_init
c_func
(paren
r_char
op_star
id|thread_name
)paren
(brace
id|lock_kernel
c_func
(paren
)paren
suffix:semicolon
id|exit_files
c_func
(paren
id|current
)paren
suffix:semicolon
id|daemonize
c_func
(paren
)paren
suffix:semicolon
id|strcpy
c_func
(paren
id|current-&gt;comm
comma
id|thread_name
)paren
suffix:semicolon
id|unlock_kernel
c_func
(paren
)paren
suffix:semicolon
id|spin_lock_irq
c_func
(paren
op_amp
id|current-&gt;sigmask_lock
)paren
suffix:semicolon
id|flush_signals
c_func
(paren
id|current
)paren
suffix:semicolon
id|sigfillset
c_func
(paren
op_amp
id|current-&gt;blocked
)paren
suffix:semicolon
id|recalc_sigpending
c_func
(paren
id|current
)paren
suffix:semicolon
id|spin_unlock_irq
c_func
(paren
op_amp
id|current-&gt;sigmask_lock
)paren
suffix:semicolon
)brace
DECL|function|ipq_thread_start
r_static
r_int
id|ipq_thread_start
c_func
(paren
r_void
op_star
id|data
)paren
(brace
id|ipq_queue_t
op_star
id|q
op_assign
(paren
id|ipq_queue_t
op_star
)paren
id|data
suffix:semicolon
id|q-&gt;thread.running
op_assign
l_int|1
suffix:semicolon
id|ipq_thread_init
c_func
(paren
id|IPQ_THR_NAME
)paren
suffix:semicolon
id|q-&gt;thread.pid
op_assign
id|current-&gt;pid
suffix:semicolon
r_while
c_loop
(paren
op_logical_neg
id|q-&gt;thread.terminate
)paren
(brace
id|interruptible_sleep_on
c_func
(paren
op_amp
id|q-&gt;thread.wq
)paren
suffix:semicolon
id|q-&gt;thread
dot
id|process
c_func
(paren
id|q
)paren
suffix:semicolon
)brace
id|q-&gt;thread.running
op_assign
l_int|0
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|ipq_thread_stop
r_static
r_void
id|ipq_thread_stop
c_func
(paren
id|ipq_queue_t
op_star
id|q
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|q-&gt;thread.pid
op_logical_or
id|q-&gt;thread.running
)paren
)paren
r_return
suffix:semicolon
id|q-&gt;state
op_assign
id|IPQ_QS_FLUSH
suffix:semicolon
id|q-&gt;thread.terminate
op_assign
l_int|1
suffix:semicolon
id|wake_up_interruptible
c_func
(paren
op_amp
id|q-&gt;thread.wq
)paren
suffix:semicolon
id|current-&gt;state
op_assign
id|TASK_INTERRUPTIBLE
suffix:semicolon
r_while
c_loop
(paren
id|q-&gt;thread.running
)paren
(brace
id|schedule_timeout
c_func
(paren
id|HZ
op_div
l_int|10
)paren
suffix:semicolon
id|current-&gt;state
op_assign
id|TASK_RUNNING
suffix:semicolon
)brace
)brace
DECL|function|ipq_thread_create
r_static
r_int
id|ipq_thread_create
c_func
(paren
id|ipq_queue_t
op_star
id|q
)paren
(brace
r_int
id|status
op_assign
id|kernel_thread
c_func
(paren
id|ipq_thread_start
comma
id|q
comma
l_int|0
)paren
suffix:semicolon
r_return
(paren
id|status
OL
l_int|0
)paren
ques
c_cond
id|status
suffix:colon
l_int|0
suffix:semicolon
)brace
multiline_comment|/****************************************************************************&n; *&n; * Packet queue&n; *&n; ****************************************************************************/
multiline_comment|/* Must be called under spinlock */
r_static
id|__inline__
r_void
DECL|function|ipq_dequeue
id|ipq_dequeue
c_func
(paren
id|ipq_queue_t
op_star
id|q
comma
id|ipq_queue_element_t
op_star
id|e
)paren
(brace
id|list_del
c_func
(paren
op_amp
id|e-&gt;list
)paren
suffix:semicolon
id|nf_reinject
c_func
(paren
id|e-&gt;skb
comma
id|e-&gt;info
comma
id|e-&gt;verdict
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|e
)paren
suffix:semicolon
id|q-&gt;len
op_decrement
suffix:semicolon
)brace
multiline_comment|/* Must be called under spinlock */
r_static
id|__inline__
r_void
DECL|function|ipq_queue_drop
id|ipq_queue_drop
c_func
(paren
id|ipq_queue_t
op_star
id|q
comma
id|ipq_queue_element_t
op_star
id|e
)paren
(brace
id|e-&gt;verdict
op_assign
id|NF_DROP
suffix:semicolon
id|ipq_dequeue
c_func
(paren
id|q
comma
id|e
)paren
suffix:semicolon
)brace
r_static
r_int
DECL|function|ipq_notify_peer
id|ipq_notify_peer
c_func
(paren
id|ipq_queue_t
op_star
id|q
comma
id|ipq_queue_element_t
op_star
id|e
)paren
(brace
r_int
id|status
op_assign
id|q-&gt;peer
dot
id|send
c_func
(paren
id|e
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
op_ge
l_int|0
)paren
(brace
id|e-&gt;state
op_assign
id|IPQ_PS_WAITING
suffix:semicolon
r_return
id|status
suffix:semicolon
)brace
r_if
c_cond
(paren
id|status
op_eq
op_minus
id|ERESTARTSYS
op_logical_or
id|status
op_eq
op_minus
id|EAGAIN
)paren
r_return
l_int|0
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: error notifying peer %d, resetting &quot;
l_string|&quot;state and flushing queue&bslash;n&quot;
comma
id|IPQ_NAME
comma
id|q-&gt;peer.pid
)paren
suffix:semicolon
id|q-&gt;state
op_assign
id|IPQ_QS_FLUSH
suffix:semicolon
id|q-&gt;peer.died
op_assign
l_int|1
suffix:semicolon
id|q-&gt;peer.pid
op_assign
l_int|0
suffix:semicolon
id|q-&gt;peer.copy_mode
op_assign
id|IPQ_COPY_META
suffix:semicolon
id|q-&gt;peer.copy_range
op_assign
l_int|0
suffix:semicolon
r_return
id|status
suffix:semicolon
)brace
r_static
r_void
DECL|function|ipq_queue_process
id|ipq_queue_process
c_func
(paren
r_void
op_star
id|data
)paren
(brace
r_struct
id|list_head
op_star
id|i
suffix:semicolon
id|ipq_queue_t
op_star
id|q
op_assign
(paren
id|ipq_queue_t
op_star
)paren
id|data
suffix:semicolon
id|restart
suffix:colon
r_if
c_cond
(paren
id|q-&gt;state
op_eq
id|IPQ_QS_HOLD
)paren
r_return
suffix:semicolon
id|spin_lock_bh
c_func
(paren
op_amp
id|q-&gt;lock
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
id|q-&gt;list.prev
suffix:semicolon
id|i
op_ne
op_amp
id|q-&gt;list
suffix:semicolon
id|i
op_assign
id|i-&gt;prev
)paren
(brace
id|ipq_queue_element_t
op_star
id|e
op_assign
(paren
id|ipq_queue_element_t
op_star
)paren
id|i
suffix:semicolon
r_if
c_cond
(paren
id|q-&gt;state
op_eq
id|IPQ_QS_FLUSH
)paren
(brace
id|QDEBUG
c_func
(paren
l_string|&quot;flushing packet %p&bslash;n&quot;
comma
id|e
)paren
suffix:semicolon
id|ipq_queue_drop
c_func
(paren
id|q
comma
id|e
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
r_switch
c_cond
(paren
id|e-&gt;state
)paren
(brace
r_case
id|IPQ_PS_NEW
suffix:colon
(brace
r_int
id|status
op_assign
id|ipq_notify_peer
c_func
(paren
id|q
comma
id|e
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
OL
l_int|0
)paren
(brace
id|spin_unlock_bh
c_func
(paren
op_amp
id|q-&gt;lock
)paren
suffix:semicolon
r_goto
id|restart
suffix:semicolon
)brace
r_break
suffix:semicolon
)brace
r_case
id|IPQ_PS_VERDICT
suffix:colon
id|ipq_dequeue
c_func
(paren
id|q
comma
id|e
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|IPQ_PS_WAITING
suffix:colon
r_break
suffix:semicolon
r_default
suffix:colon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: dropping stuck packet %p &quot;
l_string|&quot;with ps=%d qs=%d&bslash;n&quot;
comma
id|IPQ_NAME
comma
id|e
comma
id|e-&gt;state
comma
id|q-&gt;state
)paren
suffix:semicolon
id|ipq_queue_drop
c_func
(paren
id|q
comma
id|e
)paren
suffix:semicolon
)brace
)brace
id|spin_unlock_bh
c_func
(paren
op_amp
id|q-&gt;lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|q-&gt;state
op_eq
id|IPQ_QS_FLUSH
)paren
id|q-&gt;state
op_assign
id|IPQ_QS_HOLD
suffix:semicolon
)brace
r_static
id|ipq_queue_t
op_star
DECL|function|ipq_queue_create
id|ipq_queue_create
c_func
(paren
id|nf_queue_outfn_t
id|outfn
comma
id|ipq_send_cb_t
id|send_cb
comma
r_int
op_star
id|errp
comma
r_int
op_star
id|sysctl_qmax
)paren
(brace
r_int
id|status
suffix:semicolon
id|ipq_queue_t
op_star
id|q
suffix:semicolon
op_star
id|errp
op_assign
l_int|0
suffix:semicolon
id|q
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
id|ipq_queue_t
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|q
op_eq
l_int|NULL
)paren
(brace
op_star
id|errp
op_assign
op_minus
id|ENOMEM
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
id|q-&gt;thread.terminate
op_assign
l_int|0
suffix:semicolon
id|q-&gt;thread.running
op_assign
l_int|0
suffix:semicolon
id|q-&gt;thread.process
op_assign
id|ipq_queue_process
suffix:semicolon
id|init_waitqueue_head
c_func
(paren
op_amp
id|q-&gt;thread.wq
)paren
suffix:semicolon
id|q-&gt;peer.pid
op_assign
l_int|0
suffix:semicolon
id|q-&gt;peer.died
op_assign
l_int|0
suffix:semicolon
id|q-&gt;peer.copy_mode
op_assign
id|IPQ_COPY_META
suffix:semicolon
id|q-&gt;peer.copy_range
op_assign
l_int|0
suffix:semicolon
id|q-&gt;peer.send
op_assign
id|send_cb
suffix:semicolon
id|q-&gt;len
op_assign
l_int|0
suffix:semicolon
id|q-&gt;maxlen
op_assign
id|sysctl_qmax
suffix:semicolon
id|q-&gt;state
op_assign
id|IPQ_QS_HOLD
suffix:semicolon
id|INIT_LIST_HEAD
c_func
(paren
op_amp
id|q-&gt;list
)paren
suffix:semicolon
id|spin_lock_init
c_func
(paren
op_amp
id|q-&gt;lock
)paren
suffix:semicolon
id|status
op_assign
id|nf_register_queue_handler
c_func
(paren
id|PF_INET
comma
id|outfn
comma
id|q
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
OL
l_int|0
)paren
(brace
op_star
id|errp
op_assign
op_minus
id|EBUSY
suffix:semicolon
id|kfree
c_func
(paren
id|q
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
id|status
op_assign
id|ipq_thread_create
c_func
(paren
id|q
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
OL
l_int|0
)paren
(brace
id|nf_unregister_queue_handler
c_func
(paren
id|PF_INET
)paren
suffix:semicolon
op_star
id|errp
op_assign
id|status
suffix:semicolon
id|kfree
c_func
(paren
id|q
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
r_return
id|q
suffix:semicolon
)brace
r_static
r_int
DECL|function|ipq_enqueue
id|ipq_enqueue
c_func
(paren
id|ipq_queue_t
op_star
id|q
comma
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|nf_info
op_star
id|info
)paren
(brace
id|ipq_queue_element_t
op_star
id|e
op_assign
l_int|NULL
suffix:semicolon
id|e
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
op_star
id|e
)paren
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
id|e
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: out of memory in %s&bslash;n&quot;
comma
id|IPQ_NAME
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|e-&gt;state
op_assign
id|IPQ_PS_NEW
suffix:semicolon
id|e-&gt;verdict
op_assign
id|NF_DROP
suffix:semicolon
id|e-&gt;info
op_assign
id|info
suffix:semicolon
id|e-&gt;skb
op_assign
id|skb
suffix:semicolon
id|spin_lock_bh
c_func
(paren
op_amp
id|q-&gt;lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|q-&gt;len
op_ge
op_star
id|q-&gt;maxlen
)paren
(brace
id|spin_unlock_bh
c_func
(paren
op_amp
id|q-&gt;lock
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: queue full at %d entries, &quot;
l_string|&quot;dropping packet.&bslash;n&quot;
comma
id|IPQ_NAME
comma
id|q-&gt;len
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|e
)paren
suffix:semicolon
id|nf_reinject
c_func
(paren
id|skb
comma
id|info
comma
id|NF_DROP
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|list_add
c_func
(paren
op_amp
id|e-&gt;list
comma
op_amp
id|q-&gt;list
)paren
suffix:semicolon
id|q-&gt;len
op_increment
suffix:semicolon
id|spin_unlock_bh
c_func
(paren
op_amp
id|q-&gt;lock
)paren
suffix:semicolon
id|wake_up_interruptible
c_func
(paren
op_amp
id|q-&gt;thread.wq
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* FIXME: need to find a way to notify user during module unload */
r_static
r_void
DECL|function|ipq_queue_destroy
id|ipq_queue_destroy
c_func
(paren
id|ipq_queue_t
op_star
id|q
)paren
(brace
id|ipq_thread_stop
c_func
(paren
id|q
)paren
suffix:semicolon
id|nf_unregister_queue_handler
c_func
(paren
id|PF_INET
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|q
)paren
suffix:semicolon
)brace
r_static
r_int
DECL|function|ipq_queue_mangle_ipv4
id|ipq_queue_mangle_ipv4
c_func
(paren
r_int
r_char
op_star
id|buf
comma
id|ipq_verdict_msg_t
op_star
id|v
comma
id|ipq_queue_element_t
op_star
id|e
)paren
(brace
r_struct
id|iphdr
op_star
id|user_iph
op_assign
(paren
r_struct
id|iphdr
op_star
)paren
id|buf
suffix:semicolon
r_if
c_cond
(paren
id|v-&gt;data_len
OL
r_sizeof
(paren
op_star
id|user_iph
)paren
)paren
r_return
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|e-&gt;skb-&gt;nh.iph-&gt;check
op_ne
id|user_iph-&gt;check
)paren
(brace
r_int
id|diff
op_assign
id|v-&gt;data_len
op_minus
id|e-&gt;skb-&gt;len
suffix:semicolon
r_if
c_cond
(paren
id|diff
OL
l_int|0
)paren
id|skb_trim
c_func
(paren
id|e-&gt;skb
comma
id|v-&gt;data_len
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
id|diff
OG
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|v-&gt;data_len
OG
l_int|0xFFFF
)paren
(brace
id|e-&gt;verdict
op_assign
id|NF_DROP
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|diff
OG
id|skb_tailroom
c_func
(paren
id|e-&gt;skb
)paren
)paren
(brace
r_struct
id|sk_buff
op_star
id|newskb
suffix:semicolon
multiline_comment|/* Ack, we waste a memcpy() of data here */
id|newskb
op_assign
id|skb_copy_expand
c_func
(paren
id|e-&gt;skb
comma
id|skb_headroom
c_func
(paren
id|e-&gt;skb
)paren
comma
id|diff
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
id|newskb
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: OOM in %s, &quot;
l_string|&quot;dropping packet&bslash;n&quot;
comma
id|IPQ_THR_NAME
comma
id|__FUNCTION__
)paren
suffix:semicolon
id|e-&gt;verdict
op_assign
id|NF_DROP
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|kfree_skb
c_func
(paren
id|e-&gt;skb
)paren
suffix:semicolon
id|e-&gt;skb
op_assign
id|newskb
suffix:semicolon
)brace
id|skb_put
c_func
(paren
id|e-&gt;skb
comma
id|diff
)paren
suffix:semicolon
)brace
id|memcpy
c_func
(paren
id|e-&gt;skb-&gt;data
comma
id|buf
comma
id|v-&gt;data_len
)paren
suffix:semicolon
id|e-&gt;skb-&gt;nfcache
op_or_assign
id|NFC_ALTERED
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_int
DECL|function|ipq_queue_set_verdict
id|ipq_queue_set_verdict
c_func
(paren
id|ipq_queue_t
op_star
id|q
comma
id|ipq_verdict_msg_t
op_star
id|v
comma
r_int
r_char
op_star
id|buf
comma
r_int
r_int
id|len
)paren
(brace
r_struct
id|list_head
op_star
id|i
suffix:semicolon
r_if
c_cond
(paren
id|v-&gt;value
template_param
id|NF_MAX_VERDICT
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|spin_lock_bh
c_func
(paren
op_amp
id|q-&gt;lock
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
id|q-&gt;list.next
suffix:semicolon
id|i
op_ne
op_amp
id|q-&gt;list
suffix:semicolon
id|i
op_assign
id|i-&gt;next
)paren
(brace
id|ipq_queue_element_t
op_star
id|e
op_assign
(paren
id|ipq_queue_element_t
op_star
)paren
id|i
suffix:semicolon
r_if
c_cond
(paren
id|v-&gt;id
op_eq
(paren
r_int
r_int
)paren
id|e
)paren
(brace
r_int
id|status
op_assign
l_int|0
suffix:semicolon
id|e-&gt;state
op_assign
id|IPQ_PS_VERDICT
suffix:semicolon
id|e-&gt;verdict
op_assign
id|v-&gt;value
suffix:semicolon
r_if
c_cond
(paren
id|buf
op_logical_and
id|v-&gt;data_len
op_eq
id|len
)paren
id|status
op_assign
id|ipq_queue_mangle_ipv4
c_func
(paren
id|buf
comma
id|v
comma
id|e
)paren
suffix:semicolon
id|spin_unlock_bh
c_func
(paren
op_amp
id|q-&gt;lock
)paren
suffix:semicolon
r_return
id|status
suffix:semicolon
)brace
)brace
id|spin_unlock_bh
c_func
(paren
op_amp
id|q-&gt;lock
)paren
suffix:semicolon
r_return
op_minus
id|ENOENT
suffix:semicolon
)brace
r_static
r_int
DECL|function|ipq_receive_peer
id|ipq_receive_peer
c_func
(paren
id|ipq_queue_t
op_star
id|q
comma
id|ipq_peer_msg_t
op_star
id|m
comma
r_int
r_char
id|type
comma
r_int
r_int
id|len
)paren
(brace
r_if
c_cond
(paren
id|q-&gt;state
op_eq
id|IPQ_QS_FLUSH
)paren
r_return
op_minus
id|EBUSY
suffix:semicolon
r_if
c_cond
(paren
id|len
OL
r_sizeof
(paren
id|ipq_peer_msg_t
)paren
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_switch
c_cond
(paren
id|type
)paren
(brace
r_case
id|IPQM_MODE
suffix:colon
r_switch
c_cond
(paren
id|m-&gt;msg.mode.value
)paren
(brace
r_case
id|IPQ_COPY_NONE
suffix:colon
id|q-&gt;peer.copy_mode
op_assign
id|IPQ_COPY_NONE
suffix:semicolon
id|q-&gt;peer.copy_range
op_assign
l_int|0
suffix:semicolon
id|q-&gt;state
op_assign
id|IPQ_QS_FLUSH
suffix:semicolon
r_break
suffix:semicolon
r_case
id|IPQ_COPY_META
suffix:colon
r_if
c_cond
(paren
id|q-&gt;state
op_eq
id|IPQ_QS_FLUSH
)paren
r_return
op_minus
id|EAGAIN
suffix:semicolon
id|q-&gt;peer.copy_mode
op_assign
id|IPQ_COPY_META
suffix:semicolon
id|q-&gt;peer.copy_range
op_assign
l_int|0
suffix:semicolon
id|q-&gt;state
op_assign
id|IPQ_QS_COPY
suffix:semicolon
r_break
suffix:semicolon
r_case
id|IPQ_COPY_PACKET
suffix:colon
r_if
c_cond
(paren
id|q-&gt;state
op_eq
id|IPQ_QS_FLUSH
)paren
r_return
op_minus
id|EAGAIN
suffix:semicolon
id|q-&gt;peer.copy_mode
op_assign
id|IPQ_COPY_PACKET
suffix:semicolon
id|q-&gt;peer.copy_range
op_assign
id|m-&gt;msg.mode.range
suffix:semicolon
id|q-&gt;state
op_assign
id|IPQ_QS_COPY
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|IPQM_VERDICT
suffix:colon
(brace
r_int
id|status
suffix:semicolon
r_int
r_char
op_star
id|data
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
id|m-&gt;msg.verdict.value
OG
id|NF_MAX_VERDICT
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|m-&gt;msg.verdict.data_len
)paren
id|data
op_assign
(paren
r_int
r_char
op_star
)paren
id|m
op_plus
r_sizeof
(paren
op_star
id|m
)paren
suffix:semicolon
id|status
op_assign
id|ipq_queue_set_verdict
c_func
(paren
id|q
comma
op_amp
id|m-&gt;msg.verdict
comma
id|data
comma
id|len
op_minus
r_sizeof
(paren
op_star
id|m
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
OL
l_int|0
)paren
r_return
id|status
suffix:semicolon
r_break
suffix:semicolon
)brace
r_default
suffix:colon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|wake_up_interruptible
c_func
(paren
op_amp
id|q-&gt;thread.wq
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/****************************************************************************&n; *&n; * Netfilter interface&n; *&n; ****************************************************************************/
multiline_comment|/*&n; * Packets arrive here from netfilter for queuing to userspace.&n; * All of them must be fed back via nf_reinject() or Alexey will kill Rusty.&n; */
r_static
r_int
DECL|function|receive_netfilter
id|receive_netfilter
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|nf_info
op_star
id|info
comma
r_void
op_star
id|data
)paren
(brace
id|ipq_queue_t
op_star
id|q
op_assign
(paren
id|ipq_queue_t
op_star
)paren
id|data
suffix:semicolon
r_if
c_cond
(paren
id|q-&gt;state
op_eq
id|IPQ_QS_FLUSH
)paren
r_return
op_minus
id|EBUSY
suffix:semicolon
r_return
id|ipq_enqueue
c_func
(paren
id|q
comma
id|skb
comma
id|info
)paren
suffix:semicolon
)brace
multiline_comment|/****************************************************************************&n; *&n; * Netlink interface.&n; *&n; ****************************************************************************/
r_static
r_struct
id|sk_buff
op_star
id|netlink_build_message
c_func
(paren
id|ipq_queue_element_t
op_star
id|e
comma
r_int
op_star
id|errp
)paren
suffix:semicolon
r_extern
id|__inline__
r_void
id|receive_user_skb
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
)paren
suffix:semicolon
r_static
r_int
id|netlink_send_peer
c_func
(paren
id|ipq_queue_element_t
op_star
id|e
)paren
suffix:semicolon
DECL|variable|nfnl
r_static
r_struct
id|sock
op_star
id|nfnl
op_assign
l_int|NULL
suffix:semicolon
DECL|variable|nlq
id|ipq_queue_t
op_star
id|nlq
op_assign
l_int|NULL
suffix:semicolon
r_static
r_int
DECL|function|netlink_send_peer
id|netlink_send_peer
c_func
(paren
id|ipq_queue_element_t
op_star
id|e
)paren
(brace
r_int
id|status
op_assign
l_int|0
suffix:semicolon
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|nlq-&gt;peer.pid
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|skb
op_assign
id|netlink_build_message
c_func
(paren
id|e
comma
op_amp
id|status
)paren
suffix:semicolon
r_if
c_cond
(paren
id|skb
op_eq
l_int|NULL
)paren
r_return
id|status
suffix:semicolon
r_return
id|netlink_unicast
c_func
(paren
id|nfnl
comma
id|skb
comma
id|nlq-&gt;peer.pid
comma
l_int|0
)paren
suffix:semicolon
)brace
r_static
r_struct
id|sk_buff
op_star
DECL|function|netlink_build_message
id|netlink_build_message
c_func
(paren
id|ipq_queue_element_t
op_star
id|e
comma
r_int
op_star
id|errp
)paren
(brace
r_int
r_char
op_star
id|old_tail
suffix:semicolon
r_int
id|size
op_assign
l_int|0
suffix:semicolon
r_int
id|data_len
op_assign
l_int|0
suffix:semicolon
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
id|ipq_packet_msg_t
op_star
id|pm
suffix:semicolon
r_struct
id|nlmsghdr
op_star
id|nlh
suffix:semicolon
r_switch
c_cond
(paren
id|nlq-&gt;peer.copy_mode
)paren
(brace
r_int
id|copy_range
suffix:semicolon
r_case
id|IPQ_COPY_META
suffix:colon
id|size
op_assign
id|NLMSG_SPACE
c_func
(paren
r_sizeof
(paren
op_star
id|pm
)paren
)paren
suffix:semicolon
id|data_len
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_case
id|IPQ_COPY_PACKET
suffix:colon
id|copy_range
op_assign
id|nlq-&gt;peer.copy_range
suffix:semicolon
r_if
c_cond
(paren
id|copy_range
op_eq
l_int|0
op_logical_or
id|copy_range
OG
id|e-&gt;skb-&gt;len
)paren
id|data_len
op_assign
id|e-&gt;skb-&gt;len
suffix:semicolon
r_else
id|data_len
op_assign
id|copy_range
suffix:semicolon
id|size
op_assign
id|NLMSG_SPACE
c_func
(paren
r_sizeof
(paren
op_star
id|pm
)paren
op_plus
id|data_len
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|IPQ_COPY_NONE
suffix:colon
r_default
suffix:colon
op_star
id|errp
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
id|skb
op_assign
id|alloc_skb
c_func
(paren
id|size
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|skb
)paren
r_goto
id|nlmsg_failure
suffix:semicolon
id|old_tail
op_assign
id|skb-&gt;tail
suffix:semicolon
id|nlh
op_assign
id|NLMSG_PUT
c_func
(paren
id|skb
comma
l_int|0
comma
l_int|0
comma
id|IPQM_PACKET
comma
id|size
op_minus
r_sizeof
(paren
op_star
id|nlh
)paren
)paren
suffix:semicolon
id|pm
op_assign
id|NLMSG_DATA
c_func
(paren
id|nlh
)paren
suffix:semicolon
id|memset
c_func
(paren
id|pm
comma
l_int|0
comma
r_sizeof
(paren
op_star
id|pm
)paren
)paren
suffix:semicolon
id|pm-&gt;packet_id
op_assign
(paren
r_int
r_int
)paren
id|e
suffix:semicolon
id|pm-&gt;data_len
op_assign
id|data_len
suffix:semicolon
id|pm-&gt;timestamp_sec
op_assign
id|e-&gt;skb-&gt;stamp.tv_sec
suffix:semicolon
id|pm-&gt;timestamp_usec
op_assign
id|e-&gt;skb-&gt;stamp.tv_usec
suffix:semicolon
id|pm-&gt;hook
op_assign
id|e-&gt;info-&gt;hook
suffix:semicolon
r_if
c_cond
(paren
id|e-&gt;info-&gt;indev
)paren
id|strcpy
c_func
(paren
id|pm-&gt;indev_name
comma
id|e-&gt;info-&gt;indev-&gt;name
)paren
suffix:semicolon
r_else
id|pm-&gt;indev_name
(braket
l_int|0
)braket
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
r_if
c_cond
(paren
id|e-&gt;info-&gt;outdev
)paren
id|strcpy
c_func
(paren
id|pm-&gt;outdev_name
comma
id|e-&gt;info-&gt;outdev-&gt;name
)paren
suffix:semicolon
r_else
id|pm-&gt;outdev_name
(braket
l_int|0
)braket
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
r_if
c_cond
(paren
id|data_len
)paren
id|memcpy
c_func
(paren
op_increment
id|pm
comma
id|e-&gt;skb-&gt;data
comma
id|data_len
)paren
suffix:semicolon
id|nlh-&gt;nlmsg_len
op_assign
id|skb-&gt;tail
op_minus
id|old_tail
suffix:semicolon
id|NETLINK_CB
c_func
(paren
id|skb
)paren
dot
id|dst_groups
op_assign
l_int|0
suffix:semicolon
r_return
id|skb
suffix:semicolon
id|nlmsg_failure
suffix:colon
r_if
c_cond
(paren
id|skb
)paren
id|kfree
c_func
(paren
id|skb
)paren
suffix:semicolon
op_star
id|errp
op_assign
l_int|0
suffix:semicolon
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: error creating netlink message&bslash;n&quot;
comma
id|IPQ_NAME
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
DECL|macro|RCV_SKB_FAIL
mdefine_line|#define RCV_SKB_FAIL(err) do { netlink_ack(skb, nlh, (err)); return; } while (0);
multiline_comment|/*&n; * FIXME: ping old peer if we detect a new peer then resend.&n; */
r_extern
id|__inline__
r_void
DECL|function|receive_user_skb
id|receive_user_skb
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
)paren
(brace
r_int
id|status
comma
id|type
suffix:semicolon
r_struct
id|nlmsghdr
op_star
id|nlh
suffix:semicolon
id|nlh
op_assign
(paren
r_struct
id|nlmsghdr
op_star
)paren
id|skb-&gt;data
suffix:semicolon
r_if
c_cond
(paren
id|nlh-&gt;nlmsg_len
OL
r_sizeof
(paren
op_star
id|nlh
)paren
op_logical_or
id|skb-&gt;len
OL
id|nlh-&gt;nlmsg_len
op_logical_or
id|nlh-&gt;nlmsg_pid
op_le
l_int|0
op_logical_or
op_logical_neg
(paren
id|nlh-&gt;nlmsg_flags
op_amp
id|NLM_F_REQUEST
)paren
op_logical_or
id|nlh-&gt;nlmsg_flags
op_amp
id|NLM_F_MULTI
)paren
id|RCV_SKB_FAIL
c_func
(paren
op_minus
id|EINVAL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|nlh-&gt;nlmsg_flags
op_amp
id|MSG_TRUNC
)paren
id|RCV_SKB_FAIL
c_func
(paren
op_minus
id|ECOMM
)paren
suffix:semicolon
id|type
op_assign
id|nlh-&gt;nlmsg_type
suffix:semicolon
r_if
c_cond
(paren
id|type
OL
id|NLMSG_NOOP
op_logical_or
id|type
op_ge
id|IPQM_MAX
)paren
id|RCV_SKB_FAIL
c_func
(paren
op_minus
id|EINVAL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|type
op_le
id|IPQM_BASE
)paren
r_return
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|cap_raised
c_func
(paren
id|NETLINK_CB
c_func
(paren
id|skb
)paren
dot
id|eff_cap
comma
id|CAP_NET_ADMIN
)paren
)paren
(brace
id|RCV_SKB_FAIL
c_func
(paren
op_minus
id|EPERM
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|nlq-&gt;peer.pid
op_logical_and
op_logical_neg
id|nlq-&gt;peer.died
op_logical_and
(paren
id|nlq-&gt;peer.pid
op_ne
id|nlh-&gt;nlmsg_pid
)paren
)paren
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: peer pid changed from %d to %d&bslash;n&quot;
comma
id|IPQ_NAME
comma
id|nlq-&gt;peer.pid
comma
id|nlh-&gt;nlmsg_pid
)paren
suffix:semicolon
id|nlq-&gt;peer.pid
op_assign
id|nlh-&gt;nlmsg_pid
suffix:semicolon
id|nlq-&gt;peer.died
op_assign
l_int|0
suffix:semicolon
id|status
op_assign
id|ipq_receive_peer
c_func
(paren
id|nlq
comma
id|NLMSG_DATA
c_func
(paren
id|nlh
)paren
comma
id|type
comma
id|skb-&gt;len
op_minus
id|NLMSG_LENGTH
c_func
(paren
l_int|0
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
OL
l_int|0
)paren
id|RCV_SKB_FAIL
c_func
(paren
id|status
)paren
suffix:semicolon
r_if
c_cond
(paren
id|nlh-&gt;nlmsg_flags
op_amp
id|NLM_F_ACK
)paren
id|netlink_ack
c_func
(paren
id|skb
comma
id|nlh
comma
l_int|0
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/* Note: we are only dealing with single part messages at the moment. */
r_static
r_void
DECL|function|receive_user_sk
id|receive_user_sk
c_func
(paren
r_struct
id|sock
op_star
id|sk
comma
r_int
id|len
)paren
(brace
r_do
(brace
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
r_if
c_cond
(paren
id|rtnl_shlock_nowait
c_func
(paren
)paren
)paren
r_return
suffix:semicolon
r_while
c_loop
(paren
(paren
id|skb
op_assign
id|skb_dequeue
c_func
(paren
op_amp
id|sk-&gt;receive_queue
)paren
)paren
op_ne
l_int|NULL
)paren
(brace
id|receive_user_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
id|kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
)brace
id|up
c_func
(paren
op_amp
id|rtnl_sem
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
id|nfnl
op_logical_and
id|nfnl-&gt;receive_queue.qlen
)paren
suffix:semicolon
)brace
multiline_comment|/****************************************************************************&n; *&n; * System events&n; *&n; ****************************************************************************/
r_static
r_int
DECL|function|receive_event
id|receive_event
c_func
(paren
r_struct
id|notifier_block
op_star
id|this
comma
r_int
r_int
id|event
comma
r_void
op_star
id|ptr
)paren
(brace
r_if
c_cond
(paren
id|event
op_eq
id|NETDEV_UNREGISTER
)paren
r_if
c_cond
(paren
id|nlq
)paren
id|ipq_thread_stop
c_func
(paren
id|nlq
)paren
suffix:semicolon
r_return
id|NOTIFY_DONE
suffix:semicolon
)brace
DECL|variable|ipq_dev_notifier
r_struct
id|notifier_block
id|ipq_dev_notifier
op_assign
(brace
id|receive_event
comma
l_int|NULL
comma
l_int|0
)brace
suffix:semicolon
multiline_comment|/****************************************************************************&n; *&n; * Sysctl - queue tuning.&n; *&n; ****************************************************************************/
DECL|variable|sysctl_maxlen
r_static
r_int
id|sysctl_maxlen
op_assign
id|IPQ_QMAX_DEFAULT
suffix:semicolon
DECL|variable|ipq_sysctl_header
r_static
r_struct
id|ctl_table_header
op_star
id|ipq_sysctl_header
suffix:semicolon
DECL|variable|ipq_table
r_static
id|ctl_table
id|ipq_table
(braket
)braket
op_assign
(brace
(brace
id|NET_IPQ_QMAX
comma
id|NET_IPQ_QMAX_NAME
comma
op_amp
id|sysctl_maxlen
comma
r_sizeof
(paren
id|sysctl_maxlen
)paren
comma
l_int|0644
comma
l_int|NULL
comma
id|proc_dointvec
)brace
comma
(brace
l_int|0
)brace
)brace
suffix:semicolon
DECL|variable|ipq_dir_table
r_static
id|ctl_table
id|ipq_dir_table
(braket
)braket
op_assign
(brace
(brace
id|NET_IPV4
comma
l_string|&quot;ipv4&quot;
comma
l_int|NULL
comma
l_int|0
comma
l_int|0555
comma
id|ipq_table
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
)brace
comma
(brace
l_int|0
)brace
)brace
suffix:semicolon
DECL|variable|ipq_root_table
r_static
id|ctl_table
id|ipq_root_table
(braket
)braket
op_assign
(brace
(brace
id|CTL_NET
comma
l_string|&quot;net&quot;
comma
l_int|NULL
comma
l_int|0
comma
l_int|0555
comma
id|ipq_dir_table
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
)brace
comma
(brace
l_int|0
)brace
)brace
suffix:semicolon
multiline_comment|/****************************************************************************&n; *&n; * Procfs - debugging info.&n; *&n; ****************************************************************************/
r_static
r_int
DECL|function|ipq_get_info
id|ipq_get_info
c_func
(paren
r_char
op_star
id|buffer
comma
r_char
op_star
op_star
id|start
comma
id|off_t
id|offset
comma
r_int
id|length
)paren
(brace
r_int
id|len
suffix:semicolon
id|spin_lock_bh
c_func
(paren
op_amp
id|nlq-&gt;lock
)paren
suffix:semicolon
id|len
op_assign
id|sprintf
c_func
(paren
id|buffer
comma
l_string|&quot;Thread pid        : %d&bslash;n&quot;
l_string|&quot;Thread terminate  : %d&bslash;n&quot;
l_string|&quot;Thread running    : %d&bslash;n&quot;
l_string|&quot;Peer pid          : %d&bslash;n&quot;
l_string|&quot;Peer died         : %d&bslash;n&quot;
l_string|&quot;Peer copy mode    : %d&bslash;n&quot;
l_string|&quot;Peer copy range   : %d&bslash;n&quot;
l_string|&quot;Queue length      : %d&bslash;n&quot;
l_string|&quot;Queue max. length : %d&bslash;n&quot;
l_string|&quot;Queue state       : %d&bslash;n&quot;
comma
id|nlq-&gt;thread.pid
comma
id|nlq-&gt;thread.terminate
comma
id|nlq-&gt;thread.running
comma
id|nlq-&gt;peer.pid
comma
id|nlq-&gt;peer.died
comma
id|nlq-&gt;peer.copy_mode
comma
id|nlq-&gt;peer.copy_range
comma
id|nlq-&gt;len
comma
op_star
id|nlq-&gt;maxlen
comma
id|nlq-&gt;state
)paren
suffix:semicolon
id|spin_unlock_bh
c_func
(paren
op_amp
id|nlq-&gt;lock
)paren
suffix:semicolon
op_star
id|start
op_assign
id|buffer
op_plus
id|offset
suffix:semicolon
id|len
op_sub_assign
id|offset
suffix:semicolon
r_if
c_cond
(paren
id|len
OG
id|length
)paren
id|len
op_assign
id|length
suffix:semicolon
r_else
r_if
c_cond
(paren
id|len
OL
l_int|0
)paren
id|len
op_assign
l_int|0
suffix:semicolon
r_return
id|len
suffix:semicolon
)brace
multiline_comment|/****************************************************************************&n; *&n; * Module stuff.&n; *&n; ****************************************************************************/
DECL|function|init
r_static
r_int
id|__init
id|init
c_func
(paren
r_void
)paren
(brace
r_int
id|status
op_assign
l_int|0
suffix:semicolon
id|nfnl
op_assign
id|netlink_kernel_create
c_func
(paren
id|NETLINK_FIREWALL
comma
id|receive_user_sk
)paren
suffix:semicolon
r_if
c_cond
(paren
id|nfnl
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: initialisation failed: unable to &quot;
l_string|&quot;create kernel netlink socket&bslash;n&quot;
comma
id|IPQ_NAME
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|nlq
op_assign
id|ipq_queue_create
c_func
(paren
id|receive_netfilter
comma
id|netlink_send_peer
comma
op_amp
id|status
comma
op_amp
id|sysctl_maxlen
)paren
suffix:semicolon
r_if
c_cond
(paren
id|nlq
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: initialisation failed: unable to &quot;
l_string|&quot;initialise queue&bslash;n&quot;
comma
id|IPQ_NAME
)paren
suffix:semicolon
id|sock_release
c_func
(paren
id|nfnl-&gt;socket
)paren
suffix:semicolon
r_return
id|status
suffix:semicolon
)brace
id|register_netdevice_notifier
c_func
(paren
op_amp
id|ipq_dev_notifier
)paren
suffix:semicolon
id|proc_net_create
c_func
(paren
id|IPQ_PROC_FS_NAME
comma
l_int|0
comma
id|ipq_get_info
)paren
suffix:semicolon
id|ipq_sysctl_header
op_assign
id|register_sysctl_table
c_func
(paren
id|ipq_root_table
comma
l_int|0
)paren
suffix:semicolon
r_return
id|status
suffix:semicolon
)brace
DECL|function|fini
r_static
r_void
id|__exit
id|fini
c_func
(paren
r_void
)paren
(brace
id|unregister_sysctl_table
c_func
(paren
id|ipq_sysctl_header
)paren
suffix:semicolon
id|proc_net_remove
c_func
(paren
id|IPQ_PROC_FS_NAME
)paren
suffix:semicolon
id|unregister_netdevice_notifier
c_func
(paren
op_amp
id|ipq_dev_notifier
)paren
suffix:semicolon
id|ipq_queue_destroy
c_func
(paren
id|nlq
)paren
suffix:semicolon
id|sock_release
c_func
(paren
id|nfnl-&gt;socket
)paren
suffix:semicolon
)brace
id|MODULE_DESCRIPTION
c_func
(paren
l_string|&quot;IPv4 packet queue handler&quot;
)paren
suffix:semicolon
DECL|variable|init
id|module_init
c_func
(paren
id|init
)paren
suffix:semicolon
DECL|variable|fini
id|module_exit
c_func
(paren
id|fini
)paren
suffix:semicolon
eof
