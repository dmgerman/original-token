macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/netfilter.h&gt;
macro_line|#include &lt;linux/ip.h&gt;
macro_line|#include &lt;linux/tcp.h&gt;
macro_line|#include &lt;linux/if.h&gt;
macro_line|#include &lt;linux/netfilter_ipv4/ip_nat.h&gt;
macro_line|#include &lt;linux/netfilter_ipv4/ip_nat_rule.h&gt;
macro_line|#include &lt;linux/netfilter_ipv4/ip_nat_protocol.h&gt;
r_static
r_int
DECL|function|tcp_in_range
id|tcp_in_range
c_func
(paren
r_const
r_struct
id|ip_conntrack_tuple
op_star
id|tuple
comma
r_enum
id|ip_nat_manip_type
id|maniptype
comma
r_const
r_union
id|ip_conntrack_manip_proto
op_star
id|min
comma
r_const
r_union
id|ip_conntrack_manip_proto
op_star
id|max
)paren
(brace
id|u_int16_t
id|port
suffix:semicolon
r_if
c_cond
(paren
id|maniptype
op_eq
id|IP_NAT_MANIP_SRC
)paren
id|port
op_assign
id|tuple-&gt;src.u.tcp.port
suffix:semicolon
r_else
id|port
op_assign
id|tuple-&gt;dst.u.tcp.port
suffix:semicolon
r_return
id|ntohs
c_func
(paren
id|port
)paren
op_ge
id|ntohs
c_func
(paren
id|min-&gt;tcp.port
)paren
op_logical_and
id|ntohs
c_func
(paren
id|port
)paren
op_le
id|ntohs
c_func
(paren
id|max-&gt;tcp.port
)paren
suffix:semicolon
)brace
r_static
r_int
DECL|function|tcp_unique_tuple
id|tcp_unique_tuple
c_func
(paren
r_struct
id|ip_conntrack_tuple
op_star
id|tuple
comma
r_const
r_struct
id|ip_nat_range
op_star
id|range
comma
r_enum
id|ip_nat_manip_type
id|maniptype
comma
r_const
r_struct
id|ip_conntrack
op_star
id|conntrack
)paren
(brace
r_static
id|u_int16_t
id|port
op_assign
l_int|0
comma
op_star
id|portptr
suffix:semicolon
r_int
r_int
id|range_size
comma
id|min
comma
id|i
suffix:semicolon
r_if
c_cond
(paren
id|maniptype
op_eq
id|IP_NAT_MANIP_SRC
)paren
id|portptr
op_assign
op_amp
id|tuple-&gt;src.u.tcp.port
suffix:semicolon
r_else
id|portptr
op_assign
op_amp
id|tuple-&gt;dst.u.tcp.port
suffix:semicolon
multiline_comment|/* If no range specified... */
r_if
c_cond
(paren
op_logical_neg
(paren
id|range-&gt;flags
op_amp
id|IP_NAT_RANGE_PROTO_SPECIFIED
)paren
)paren
(brace
multiline_comment|/* If it&squot;s dst rewrite, can&squot;t change port */
r_if
c_cond
(paren
id|maniptype
op_eq
id|IP_NAT_MANIP_DST
)paren
r_return
l_int|0
suffix:semicolon
multiline_comment|/* Map privileged onto privileged. */
r_if
c_cond
(paren
id|ntohs
c_func
(paren
op_star
id|portptr
)paren
OL
l_int|1024
)paren
(brace
multiline_comment|/* Loose convention: &gt;&gt; 512 is credential passing */
r_if
c_cond
(paren
id|ntohs
c_func
(paren
op_star
id|portptr
)paren
OL
l_int|512
)paren
(brace
id|min
op_assign
l_int|1
suffix:semicolon
id|range_size
op_assign
l_int|511
op_minus
id|min
op_plus
l_int|1
suffix:semicolon
)brace
r_else
(brace
id|min
op_assign
l_int|600
suffix:semicolon
id|range_size
op_assign
l_int|1023
op_minus
id|min
op_plus
l_int|1
suffix:semicolon
)brace
)brace
r_else
(brace
id|min
op_assign
l_int|1024
suffix:semicolon
id|range_size
op_assign
l_int|65535
op_minus
l_int|1024
op_plus
l_int|1
suffix:semicolon
)brace
)brace
r_else
(brace
id|min
op_assign
id|ntohs
c_func
(paren
id|range-&gt;min.tcp.port
)paren
suffix:semicolon
id|range_size
op_assign
id|ntohs
c_func
(paren
id|range-&gt;max.tcp.port
)paren
op_minus
id|min
op_plus
l_int|1
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|range_size
suffix:semicolon
id|i
op_increment
comma
id|port
op_increment
)paren
(brace
op_star
id|portptr
op_assign
id|htons
c_func
(paren
id|min
op_plus
id|port
op_mod
id|range_size
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ip_nat_used_tuple
c_func
(paren
id|tuple
comma
id|conntrack
)paren
)paren
(brace
r_return
l_int|1
suffix:semicolon
)brace
)brace
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_void
DECL|function|tcp_manip_pkt
id|tcp_manip_pkt
c_func
(paren
r_struct
id|iphdr
op_star
id|iph
comma
r_int
id|len
comma
r_const
r_struct
id|ip_conntrack_manip
op_star
id|manip
comma
r_enum
id|ip_nat_manip_type
id|maniptype
)paren
(brace
r_struct
id|tcphdr
op_star
id|hdr
op_assign
(paren
r_struct
id|tcphdr
op_star
)paren
(paren
(paren
id|u_int32_t
op_star
)paren
id|iph
op_plus
id|iph-&gt;ihl
)paren
suffix:semicolon
id|u_int32_t
id|oldip
suffix:semicolon
id|u_int16_t
op_star
id|portptr
suffix:semicolon
r_if
c_cond
(paren
id|maniptype
op_eq
id|IP_NAT_MANIP_SRC
)paren
(brace
multiline_comment|/* Get rid of src ip and src pt */
id|oldip
op_assign
id|iph-&gt;saddr
suffix:semicolon
id|portptr
op_assign
op_amp
id|hdr-&gt;source
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* Get rid of dst ip and dst pt */
id|oldip
op_assign
id|iph-&gt;daddr
suffix:semicolon
id|portptr
op_assign
op_amp
id|hdr-&gt;dest
suffix:semicolon
)brace
id|hdr-&gt;check
op_assign
id|ip_nat_cheat_check
c_func
(paren
op_complement
id|oldip
comma
id|manip-&gt;ip
comma
id|ip_nat_cheat_check
c_func
(paren
op_star
id|portptr
op_xor
l_int|0xFFFF
comma
id|manip-&gt;u.tcp.port
comma
id|hdr-&gt;check
)paren
)paren
suffix:semicolon
op_star
id|portptr
op_assign
id|manip-&gt;u.tcp.port
suffix:semicolon
)brace
r_static
r_int
r_int
DECL|function|tcp_print
id|tcp_print
c_func
(paren
r_char
op_star
id|buffer
comma
r_const
r_struct
id|ip_conntrack_tuple
op_star
id|match
comma
r_const
r_struct
id|ip_conntrack_tuple
op_star
id|mask
)paren
(brace
r_int
r_int
id|len
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|mask-&gt;src.u.tcp.port
)paren
id|len
op_add_assign
id|sprintf
c_func
(paren
id|buffer
op_plus
id|len
comma
l_string|&quot;srcpt=%u &quot;
comma
id|ntohs
c_func
(paren
id|match-&gt;src.u.tcp.port
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mask-&gt;dst.u.tcp.port
)paren
id|len
op_add_assign
id|sprintf
c_func
(paren
id|buffer
op_plus
id|len
comma
l_string|&quot;dstpt=%u &quot;
comma
id|ntohs
c_func
(paren
id|match-&gt;dst.u.tcp.port
)paren
)paren
suffix:semicolon
r_return
id|len
suffix:semicolon
)brace
r_static
r_int
r_int
DECL|function|tcp_print_range
id|tcp_print_range
c_func
(paren
r_char
op_star
id|buffer
comma
r_const
r_struct
id|ip_nat_range
op_star
id|range
)paren
(brace
r_if
c_cond
(paren
id|range-&gt;min.tcp.port
op_ne
l_int|0
op_logical_or
id|range-&gt;max.tcp.port
op_ne
l_int|0xFFFF
)paren
(brace
r_if
c_cond
(paren
id|range-&gt;min.tcp.port
op_eq
id|range-&gt;max.tcp.port
)paren
r_return
id|sprintf
c_func
(paren
id|buffer
comma
l_string|&quot;port %u &quot;
comma
id|ntohs
c_func
(paren
id|range-&gt;min.tcp.port
)paren
)paren
suffix:semicolon
r_else
r_return
id|sprintf
c_func
(paren
id|buffer
comma
l_string|&quot;ports %u-%u &quot;
comma
id|ntohs
c_func
(paren
id|range-&gt;min.tcp.port
)paren
comma
id|ntohs
c_func
(paren
id|range-&gt;max.tcp.port
)paren
)paren
suffix:semicolon
)brace
r_else
r_return
l_int|0
suffix:semicolon
)brace
DECL|variable|ip_nat_protocol_tcp
r_struct
id|ip_nat_protocol
id|ip_nat_protocol_tcp
op_assign
(brace
(brace
l_int|NULL
comma
l_int|NULL
)brace
comma
l_string|&quot;TCP&quot;
comma
id|IPPROTO_TCP
comma
id|tcp_manip_pkt
comma
id|tcp_in_range
comma
id|tcp_unique_tuple
comma
id|tcp_print
comma
id|tcp_print_range
)brace
suffix:semicolon
eof
