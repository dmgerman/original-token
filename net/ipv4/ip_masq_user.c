multiline_comment|/*&n; *&t;IP_MASQ_USER user space control module&n; *&n; *&n; *&t;$Id: ip_masq_user.c,v 1.1 1998/08/29 23:51:08 davem Exp $&n; */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/skbuff.h&gt;
macro_line|#include &lt;asm/system.h&gt;
macro_line|#include &lt;linux/stat.h&gt;
macro_line|#include &lt;linux/proc_fs.h&gt;
macro_line|#include &lt;linux/in.h&gt;
macro_line|#include &lt;linux/ip.h&gt;
macro_line|#include &lt;linux/inet.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;net/protocol.h&gt;
macro_line|#include &lt;net/icmp.h&gt;
macro_line|#include &lt;net/tcp.h&gt;
macro_line|#include &lt;net/udp.h&gt;
macro_line|#include &lt;net/checksum.h&gt;
macro_line|#include &lt;net/ip_masq.h&gt;
macro_line|#include &lt;net/ip_masq_mod.h&gt;
macro_line|#include &lt;linux/sysctl.h&gt;
macro_line|#include &lt;linux/ip_fw.h&gt;
macro_line|#include &lt;linux/ip_masq.h&gt;
multiline_comment|/*&n; *&t;Debug level&n; */
DECL|variable|debug
r_static
r_int
id|debug
op_assign
l_int|0
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|ports
comma
l_string|&quot;1-&quot;
id|__MODULE_STRING
c_func
(paren
id|MAX_MASQ_APP_PORTS
)paren
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|debug
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
multiline_comment|/*&n;static int check_5uple (struct ip_masq_user *ums) {&n;&t;return 0;&n;}&n;*/
DECL|function|masq_user_k2u
r_static
r_void
id|masq_user_k2u
c_func
(paren
r_const
r_struct
id|ip_masq
op_star
id|ms
comma
r_struct
id|ip_masq_user
op_star
id|ums
)paren
(brace
id|ums-&gt;protocol
op_assign
id|ms-&gt;protocol
suffix:semicolon
id|ums-&gt;daddr
op_assign
id|ms-&gt;daddr
suffix:semicolon
id|ums-&gt;dport
op_assign
id|ms-&gt;dport
suffix:semicolon
id|ums-&gt;maddr
op_assign
id|ms-&gt;maddr
suffix:semicolon
id|ums-&gt;mport
op_assign
id|ms-&gt;mport
suffix:semicolon
id|ums-&gt;saddr
op_assign
id|ms-&gt;saddr
suffix:semicolon
id|ums-&gt;sport
op_assign
id|ms-&gt;sport
suffix:semicolon
id|ums-&gt;timeout
op_assign
id|ms-&gt;timeout
suffix:semicolon
)brace
DECL|function|ip_masq_user_maddr
r_static
r_int
id|ip_masq_user_maddr
c_func
(paren
r_struct
id|ip_masq_user
op_star
id|ums
)paren
(brace
r_struct
id|net_device
op_star
id|dev
suffix:semicolon
r_struct
id|rtable
op_star
id|rt
suffix:semicolon
r_int
id|ret
op_assign
op_minus
id|EINVAL
suffix:semicolon
id|u32
id|rt_daddr
comma
id|rt_saddr
suffix:semicolon
id|u32
id|tos
suffix:semicolon
multiline_comment|/*&n;&t; *&t;Did specify masq address.&n;&t; */
r_if
c_cond
(paren
id|ums-&gt;maddr
)paren
r_return
l_int|0
suffix:semicolon
multiline_comment|/*&n;&t; *&t;Select address to use for routing query&n;&t; */
id|rt_daddr
op_assign
id|ums-&gt;rt_daddr
ques
c_cond
id|ums-&gt;rt_daddr
suffix:colon
id|ums-&gt;daddr
suffix:semicolon
id|rt_saddr
op_assign
id|ums-&gt;rt_saddr
ques
c_cond
id|ums-&gt;rt_saddr
suffix:colon
id|ums-&gt;saddr
suffix:semicolon
multiline_comment|/*&n;&t; *&t;No address for routing, cannot continue&n;&t; */
r_if
c_cond
(paren
id|rt_daddr
op_eq
l_int|0
)paren
(brace
id|IP_MASQ_DEBUG
c_func
(paren
l_int|1
op_minus
id|debug
comma
l_string|&quot;cannot setup maddr with daddr=%lX, rt_addr=%lX&bslash;n&quot;
comma
id|ntohl
c_func
(paren
id|ums-&gt;daddr
)paren
comma
id|ntohl
c_func
(paren
id|ums-&gt;rt_daddr
)paren
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
multiline_comment|/*&n;&t; *&t;Find out rt device &n;&t; */
id|rt_saddr
op_assign
l_int|0
suffix:semicolon
id|tos
op_assign
id|RT_TOS
c_func
(paren
id|ums-&gt;ip_tos
)paren
op_or
id|RTO_CONN
suffix:semicolon
r_if
c_cond
(paren
(paren
id|ret
op_assign
id|ip_route_output
c_func
(paren
op_amp
id|rt
comma
id|rt_daddr
comma
id|rt_saddr
comma
id|tos
comma
l_int|0
multiline_comment|/* dev */
)paren
)paren
)paren
(brace
id|IP_MASQ_DEBUG
c_func
(paren
l_int|0
op_minus
id|debug
comma
l_string|&quot;could not setup maddr for routing daddr=%lX, saddr=%lX&bslash;n&quot;
comma
id|ntohl
c_func
(paren
id|rt_daddr
)paren
comma
id|ntohl
c_func
(paren
id|rt_saddr
)paren
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
id|dev
op_assign
id|rt-&gt;u.dst.dev
suffix:semicolon
id|ums-&gt;maddr
op_assign
id|ip_masq_select_addr
c_func
(paren
id|dev
comma
id|rt-&gt;rt_gateway
comma
id|RT_SCOPE_UNIVERSE
)paren
suffix:semicolon
id|IP_MASQ_DEBUG
c_func
(paren
l_int|1
op_minus
id|debug
comma
l_string|&quot;did setup maddr=%lX&bslash;n&quot;
comma
id|ntohl
c_func
(paren
id|ums-&gt;maddr
)paren
)paren
suffix:semicolon
id|ip_rt_put
c_func
(paren
id|rt
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;Create new entry (from uspace)&n; */
DECL|function|ip_masq_user_new
r_static
r_int
id|ip_masq_user_new
c_func
(paren
r_struct
id|ip_masq_user
op_star
id|ums
)paren
(brace
r_struct
id|ip_masq
op_star
id|ms
op_assign
l_int|NULL
suffix:semicolon
r_int
id|mflags
op_assign
l_int|0
suffix:semicolon
r_int
id|ret
suffix:semicolon
r_if
c_cond
(paren
id|masq_proto_num
(paren
id|ums-&gt;protocol
)paren
op_eq
op_minus
l_int|1
)paren
(brace
r_return
id|EPROTONOSUPPORT
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ums-&gt;dport
op_eq
l_int|0
)paren
(brace
id|ums-&gt;flags
op_or_assign
id|IP_MASQ_USER_F_LISTEN
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ums-&gt;flags
op_or
id|IP_MASQ_USER_F_LISTEN
)paren
(brace
r_if
c_cond
(paren
(paren
id|ums-&gt;saddr
op_eq
l_int|0
)paren
op_logical_or
(paren
id|ums-&gt;sport
op_eq
l_int|0
)paren
)paren
(brace
r_return
id|EINVAL
suffix:semicolon
)brace
id|mflags
op_or_assign
(paren
id|IP_MASQ_F_NO_DPORT
op_or
id|IP_MASQ_F_NO_DADDR
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|ret
op_assign
id|ip_masq_user_maddr
c_func
(paren
id|ums
)paren
)paren
OL
l_int|0
)paren
(brace
r_return
op_minus
id|ret
suffix:semicolon
)brace
id|mflags
op_or_assign
id|IP_MASQ_F_USER
suffix:semicolon
id|ms
op_assign
id|ip_masq_new
c_func
(paren
id|ums-&gt;protocol
comma
id|ums-&gt;maddr
comma
id|ums-&gt;mport
comma
id|ums-&gt;saddr
comma
id|ums-&gt;sport
comma
id|ums-&gt;daddr
comma
id|ums-&gt;dport
comma
id|mflags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ms
op_eq
l_int|NULL
)paren
(brace
multiline_comment|/*&n;&t;&t; *&t;FIXME: ip_masq_new() should return errno&n;&t;&t; */
r_return
id|EBUSY
suffix:semicolon
)brace
multiline_comment|/*&n;&t; *&t;Setup timeouts for this new entry&n;&t; */
r_if
c_cond
(paren
id|ums-&gt;timeout
)paren
(brace
id|ms-&gt;timeout
op_assign
id|ums-&gt;timeout
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|ums-&gt;flags
op_or
id|IP_MASQ_USER_F_LISTEN
)paren
(brace
id|ip_masq_listen
c_func
(paren
id|ms
)paren
suffix:semicolon
)brace
id|masq_user_k2u
c_func
(paren
id|ms
comma
id|ums
)paren
suffix:semicolon
id|ip_masq_put
c_func
(paren
id|ms
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* &n; *&t;Delete existing entry&n; */
DECL|function|ip_masq_user_del
r_static
r_int
id|ip_masq_user_del
c_func
(paren
r_struct
id|ip_masq_user
op_star
id|ums
)paren
(brace
r_struct
id|ip_masq
op_star
id|ms
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
id|masq_proto_num
(paren
id|ums-&gt;protocol
)paren
op_eq
op_minus
l_int|1
)paren
(brace
r_return
id|EPROTONOSUPPORT
suffix:semicolon
)brace
id|start_bh_atomic
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ums-&gt;mport
op_logical_and
id|ums-&gt;maddr
)paren
(brace
id|ms
op_assign
id|ip_masq_in_get
c_func
(paren
id|ums-&gt;protocol
comma
id|ums-&gt;daddr
comma
id|ums-&gt;dport
comma
id|ums-&gt;maddr
comma
id|ums-&gt;mport
)paren
suffix:semicolon
id|end_bh_atomic
c_func
(paren
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|ums-&gt;sport
op_logical_and
id|ums-&gt;saddr
)paren
(brace
id|ms
op_assign
id|ip_masq_out_get
c_func
(paren
id|ums-&gt;protocol
comma
id|ums-&gt;saddr
comma
id|ums-&gt;sport
comma
id|ums-&gt;daddr
comma
id|ums-&gt;dport
)paren
suffix:semicolon
id|end_bh_atomic
c_func
(paren
)paren
suffix:semicolon
)brace
r_else
r_return
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|ms
op_eq
l_int|NULL
)paren
(brace
r_return
id|ESRCH
suffix:semicolon
)brace
multiline_comment|/*&n;&t; *&t;got (locked) entry, setup almost tiny timeout :) and  &n;&t; *&t;give away&n;&t; *&n;&t; *&t;FIXME: should use something better than S_CLOSE&n;&t; */
id|ms-&gt;timeout
op_assign
id|IP_MASQ_S_CLOSE
suffix:semicolon
id|masq_user_k2u
c_func
(paren
id|ms
comma
id|ums
)paren
suffix:semicolon
id|ip_masq_put
c_func
(paren
id|ms
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|ip_masq_user_locked_get
r_static
r_struct
id|ip_masq
op_star
id|ip_masq_user_locked_get
(paren
r_struct
id|ip_masq_user
op_star
id|ums
comma
r_int
op_star
id|err
)paren
(brace
r_struct
id|ip_masq
op_star
id|ms
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
id|masq_proto_num
(paren
id|ums-&gt;protocol
)paren
op_eq
op_minus
l_int|1
)paren
(brace
op_star
id|err
op_assign
id|EPROTONOSUPPORT
suffix:semicolon
)brace
id|start_bh_atomic
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ums-&gt;mport
op_logical_and
id|ums-&gt;maddr
)paren
(brace
id|ms
op_assign
id|ip_masq_in_get
c_func
(paren
id|ums-&gt;protocol
comma
id|ums-&gt;daddr
comma
id|ums-&gt;dport
comma
id|ums-&gt;maddr
comma
id|ums-&gt;mport
)paren
suffix:semicolon
id|end_bh_atomic
c_func
(paren
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|ums-&gt;sport
op_logical_and
id|ums-&gt;saddr
)paren
(brace
id|ms
op_assign
id|ip_masq_out_get
c_func
(paren
id|ums-&gt;protocol
comma
id|ums-&gt;saddr
comma
id|ums-&gt;sport
comma
id|ums-&gt;daddr
comma
id|ums-&gt;dport
)paren
suffix:semicolon
id|end_bh_atomic
c_func
(paren
)paren
suffix:semicolon
)brace
r_else
op_star
id|err
op_assign
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|ms
op_eq
l_int|NULL
)paren
op_star
id|err
op_assign
id|ESRCH
suffix:semicolon
r_return
id|ms
suffix:semicolon
)brace
multiline_comment|/*&n; * &t;Get existing entry (complete full tunnel info)&n; */
DECL|function|ip_masq_user_get
r_static
r_int
id|ip_masq_user_get
c_func
(paren
r_struct
id|ip_masq_user
op_star
id|ums
)paren
(brace
r_struct
id|ip_masq
op_star
id|ms
op_assign
l_int|NULL
suffix:semicolon
r_int
id|err
suffix:semicolon
id|ms
op_assign
id|ip_masq_user_locked_get
c_func
(paren
id|ums
comma
op_amp
id|err
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ms
op_eq
l_int|NULL
)paren
r_return
id|err
suffix:semicolon
id|masq_user_k2u
c_func
(paren
id|ms
comma
id|ums
)paren
suffix:semicolon
id|ip_masq_put
c_func
(paren
id|ms
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* &n; *&t;Set (some, valid) entry parameters&n; */
DECL|function|ip_masq_user_set
r_static
r_int
id|ip_masq_user_set
c_func
(paren
r_struct
id|ip_masq_user
op_star
id|ums
)paren
(brace
r_struct
id|ip_masq
op_star
id|ms
op_assign
l_int|NULL
suffix:semicolon
r_int
id|err
suffix:semicolon
id|ms
op_assign
id|ip_masq_user_locked_get
c_func
(paren
id|ums
comma
op_amp
id|err
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ms
op_eq
l_int|NULL
)paren
r_return
id|err
suffix:semicolon
multiline_comment|/*&n;&t; *&t;FIXME: must allow selecting what you want to set&n;&t; */
id|ms-&gt;timeout
op_assign
id|ums-&gt;timeout
suffix:semicolon
id|masq_user_k2u
c_func
(paren
id|ms
comma
id|ums
)paren
suffix:semicolon
id|ip_masq_put
c_func
(paren
id|ms
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;Entry point&n; *&t;ret value:&n; *&t;&t;&lt;0   err&n; *&t;&t;==0  ok&n; *&t;&t;&gt;0   ok, copy to user&n; */
DECL|function|ip_masq_user_ctl
r_static
r_int
id|ip_masq_user_ctl
c_func
(paren
r_int
id|optname
comma
r_struct
id|ip_masq_ctl
op_star
id|mctl
comma
r_int
id|optlen
)paren
(brace
r_struct
id|ip_masq_user
op_star
id|ums
op_assign
op_amp
id|mctl-&gt;u.user
suffix:semicolon
r_int
id|ret
op_assign
id|EINVAL
suffix:semicolon
r_int
id|arglen
op_assign
id|optlen
op_minus
id|IP_MASQ_CTL_BSIZE
suffix:semicolon
r_int
id|cmd
suffix:semicolon
id|IP_MASQ_DEBUG
c_func
(paren
l_int|1
op_minus
id|debug
comma
l_string|&quot;ip_masq_user_ctl(len=%d/%d|%d/%d)&bslash;n&quot;
comma
id|arglen
comma
r_sizeof
(paren
op_star
id|ums
)paren
comma
id|optlen
comma
r_sizeof
(paren
op_star
id|mctl
)paren
)paren
suffix:semicolon
multiline_comment|/*&n;&t; *&t;Yes, I&squot;m a bad guy ...&n;&t; */
r_if
c_cond
(paren
id|arglen
op_ne
r_sizeof
(paren
op_star
id|ums
)paren
op_logical_and
id|optlen
op_ne
r_sizeof
(paren
op_star
id|mctl
)paren
)paren
r_return
id|EINVAL
suffix:semicolon
id|MOD_INC_USE_COUNT
suffix:semicolon
multiline_comment|/* &n;&t; *&t;Don&squot;t trust the lusers - plenty of error checking! &n;&t; */
id|cmd
op_assign
id|mctl-&gt;m_cmd
suffix:semicolon
id|IP_MASQ_DEBUG
c_func
(paren
l_int|1
op_minus
id|debug
comma
l_string|&quot;ip_masq_user_ctl(cmd=%d)&bslash;n&quot;
comma
id|cmd
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|mctl-&gt;m_cmd
)paren
(brace
r_case
id|IP_MASQ_CMD_ADD
suffix:colon
r_case
id|IP_MASQ_CMD_INSERT
suffix:colon
id|ret
op_assign
id|ip_masq_user_new
c_func
(paren
id|ums
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|IP_MASQ_CMD_DEL
suffix:colon
id|ret
op_assign
id|ip_masq_user_del
c_func
(paren
id|ums
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|IP_MASQ_CMD_SET
suffix:colon
id|ret
op_assign
id|ip_masq_user_set
c_func
(paren
id|ums
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|IP_MASQ_CMD_GET
suffix:colon
id|ret
op_assign
id|ip_masq_user_get
c_func
(paren
id|ums
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
multiline_comment|/*&n;&t; *&t;For all of the above, return masq tunnel info&n;&t; */
id|ret
op_assign
op_minus
id|ret
suffix:semicolon
r_if
c_cond
(paren
id|ret
op_eq
l_int|0
)paren
(brace
id|ret
op_assign
r_sizeof
(paren
op_star
id|ums
)paren
op_plus
id|IP_MASQ_CTL_BSIZE
suffix:semicolon
id|IP_MASQ_DEBUG
c_func
(paren
l_int|1
op_minus
id|debug
comma
l_string|&quot;will return %d bytes to user&bslash;n&quot;
comma
id|ret
)paren
suffix:semicolon
)brace
id|MOD_DEC_USE_COUNT
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
macro_line|#ifdef CONFIG_PROC_FS
DECL|function|ip_masq_user_info
r_static
r_int
id|ip_masq_user_info
c_func
(paren
r_char
op_star
id|buffer
comma
r_char
op_star
op_star
id|start
comma
id|off_t
id|offset
comma
r_int
id|length
comma
r_int
id|proto
)paren
(brace
id|off_t
id|pos
op_assign
l_int|0
comma
id|begin
suffix:semicolon
r_struct
id|ip_masq
op_star
id|ms
suffix:semicolon
r_char
id|temp
(braket
l_int|129
)braket
suffix:semicolon
r_int
id|idx
op_assign
l_int|0
suffix:semicolon
r_int
id|len
op_assign
l_int|0
suffix:semicolon
r_int
id|magic_control
suffix:semicolon
id|MOD_INC_USE_COUNT
suffix:semicolon
id|IP_MASQ_DEBUG
c_func
(paren
l_int|1
op_minus
id|debug
comma
l_string|&quot;Entered user_info with proto=%d&bslash;n&quot;
comma
id|proto
)paren
suffix:semicolon
r_if
c_cond
(paren
id|offset
OL
l_int|128
)paren
(brace
id|sprintf
c_func
(paren
id|temp
comma
l_string|&quot;Prot SrcIP    SPrt DstIP    DPrt MAddr    MPrt State        Flgs Ref Ctl Expires (free=%d,%d,%d)&quot;
comma
id|atomic_read
c_func
(paren
id|ip_masq_free_ports
)paren
comma
id|atomic_read
c_func
(paren
id|ip_masq_free_ports
op_plus
l_int|1
)paren
comma
id|atomic_read
c_func
(paren
id|ip_masq_free_ports
op_plus
l_int|2
)paren
)paren
suffix:semicolon
id|len
op_assign
id|sprintf
c_func
(paren
id|buffer
comma
l_string|&quot;%-127s&bslash;n&quot;
comma
id|temp
)paren
suffix:semicolon
)brace
id|pos
op_assign
l_int|128
suffix:semicolon
r_for
c_loop
(paren
id|idx
op_assign
l_int|0
suffix:semicolon
id|idx
OL
id|IP_MASQ_TAB_SIZE
suffix:semicolon
id|idx
op_increment
)paren
(brace
multiline_comment|/*&n;&t; *&t;Lock is actually only need in next loop &n;&t; *&t;we are called from uspace: must stop bh.&n;&t; */
id|read_lock_bh
c_func
(paren
op_amp
id|__ip_masq_lock
)paren
suffix:semicolon
r_for
c_loop
(paren
id|ms
op_assign
id|ip_masq_m_tab
(braket
id|idx
)braket
suffix:semicolon
id|ms
suffix:semicolon
id|ms
op_assign
id|ms-&gt;m_link
)paren
(brace
r_if
c_cond
(paren
id|ms-&gt;protocol
op_ne
id|proto
)paren
(brace
r_continue
suffix:semicolon
)brace
id|pos
op_add_assign
l_int|128
suffix:semicolon
r_if
c_cond
(paren
id|pos
op_le
id|offset
)paren
(brace
id|len
op_assign
l_int|0
suffix:semicolon
r_continue
suffix:semicolon
)brace
multiline_comment|/*&n;&t;&t; *&t;We have locked the tables, no need to del/add timers&n;&t;&t; *&t;nor cli()  8)&n;&t;&t; */
id|magic_control
op_assign
id|atomic_read
c_func
(paren
op_amp
id|ms-&gt;n_control
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|magic_control
op_logical_and
id|ms-&gt;control
)paren
id|magic_control
op_assign
op_minus
l_int|1
suffix:semicolon
id|sprintf
c_func
(paren
id|temp
comma
l_string|&quot;%-4s %08lX:%04X %08lX:%04X %08lX:%04X %-12s %3X %4d %3d %7lu&quot;
comma
id|masq_proto_name
c_func
(paren
id|ms-&gt;protocol
)paren
comma
id|ntohl
c_func
(paren
id|ms-&gt;saddr
)paren
comma
id|ntohs
c_func
(paren
id|ms-&gt;sport
)paren
comma
id|ntohl
c_func
(paren
id|ms-&gt;daddr
)paren
comma
id|ntohs
c_func
(paren
id|ms-&gt;dport
)paren
comma
id|ntohl
c_func
(paren
id|ms-&gt;maddr
)paren
comma
id|ntohs
c_func
(paren
id|ms-&gt;mport
)paren
comma
id|ip_masq_state_name
c_func
(paren
id|ms-&gt;state
)paren
comma
id|ms-&gt;flags
comma
id|atomic_read
c_func
(paren
op_amp
id|ms-&gt;refcnt
)paren
comma
id|magic_control
comma
(paren
id|ms-&gt;timer.expires
op_minus
id|jiffies
)paren
op_div
id|HZ
)paren
suffix:semicolon
id|len
op_add_assign
id|sprintf
c_func
(paren
id|buffer
op_plus
id|len
comma
l_string|&quot;%-127s&bslash;n&quot;
comma
id|temp
)paren
suffix:semicolon
r_if
c_cond
(paren
id|len
op_ge
id|length
)paren
(brace
id|read_unlock_bh
c_func
(paren
op_amp
id|__ip_masq_lock
)paren
suffix:semicolon
r_goto
id|done
suffix:semicolon
)brace
)brace
id|read_unlock_bh
c_func
(paren
op_amp
id|__ip_masq_lock
)paren
suffix:semicolon
)brace
id|done
suffix:colon
r_if
c_cond
(paren
id|len
)paren
(brace
id|begin
op_assign
id|len
op_minus
(paren
id|pos
op_minus
id|offset
)paren
suffix:semicolon
op_star
id|start
op_assign
id|buffer
op_plus
id|begin
suffix:semicolon
id|len
op_sub_assign
id|begin
suffix:semicolon
)brace
r_if
c_cond
(paren
id|len
OG
id|length
)paren
(brace
id|len
op_assign
id|length
suffix:semicolon
)brace
id|MOD_DEC_USE_COUNT
suffix:semicolon
r_return
id|len
suffix:semicolon
)brace
macro_line|#else
DECL|macro|ip_masq_user_info
mdefine_line|#define ip_masq_user_info&t;NULL
macro_line|#endif
DECL|variable|ip_masq_user
r_static
r_struct
id|ip_masq_hook
id|ip_masq_user
op_assign
(brace
id|ip_masq_user_ctl
comma
id|ip_masq_user_info
)brace
suffix:semicolon
DECL|function|ip_masq_user_init
r_int
id|ip_masq_user_init
c_func
(paren
r_void
)paren
(brace
r_if
c_cond
(paren
id|ip_masq_user_hook
op_ne
l_int|NULL
)paren
r_return
op_minus
id|EEXIST
suffix:semicolon
id|ip_masq_user_hook
op_assign
op_amp
id|ip_masq_user
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|ip_masq_user_done
r_int
id|ip_masq_user_done
c_func
(paren
r_void
)paren
(brace
r_if
c_cond
(paren
id|ip_masq_user_hook
op_eq
l_int|NULL
)paren
r_return
id|ENOENT
suffix:semicolon
id|ip_masq_user_hook
op_assign
l_int|NULL
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#ifdef MODULE
id|EXPORT_NO_SYMBOLS
suffix:semicolon
DECL|function|init_module
r_int
id|init_module
c_func
(paren
r_void
)paren
(brace
r_if
c_cond
(paren
id|ip_masq_user_init
c_func
(paren
)paren
op_ne
l_int|0
)paren
r_return
op_minus
id|EIO
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|cleanup_module
r_void
id|cleanup_module
c_func
(paren
r_void
)paren
(brace
r_if
c_cond
(paren
id|ip_masq_user_done
c_func
(paren
)paren
op_ne
l_int|0
)paren
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;ip_masq_user_done(): can&squot;t remove module&quot;
)paren
suffix:semicolon
)brace
macro_line|#endif /* MODULE */
eof
