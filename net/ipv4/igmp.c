multiline_comment|/*&n; *&t;Linux NET3:&t;Internet Group Management Protocol  [IGMP]&n; *&n; *&t;This code implements the IGMP protocol as defined in RFC1112. There has&n; *&t;been a further revision of this protocol since which is now supported.&n; *&n; *&t;If you have trouble with this module be careful what gcc you have used,&n; *&t;the older version didn&squot;t come out right using gcc 2.5.8, the newer one&n; *&t;seems to fall out with gcc 2.6.2.&n; *&n; *&t;Version: $Id: igmp.c,v 1.41 2000/08/31 23:39:12 davem Exp $&n; *&n; *&t;Authors:&n; *&t;&t;Alan Cox &lt;Alan.Cox@linux.org&gt;&n; *&n; *&t;This program is free software; you can redistribute it and/or&n; *&t;modify it under the terms of the GNU General Public License&n; *&t;as published by the Free Software Foundation; either version&n; *&t;2 of the License, or (at your option) any later version.&n; *&n; *&t;Fixes:&n; *&n; *&t;&t;Alan Cox&t;:&t;Added lots of __inline__ to optimise&n; *&t;&t;&t;&t;&t;the memory usage of all the tiny little&n; *&t;&t;&t;&t;&t;functions.&n; *&t;&t;Alan Cox&t;:&t;Dumped the header building experiment.&n; *&t;&t;Alan Cox&t;:&t;Minor tweaks ready for multicast routing&n; *&t;&t;&t;&t;&t;and extended IGMP protocol.&n; *&t;&t;Alan Cox&t;:&t;Removed a load of inline directives. Gcc 2.5.8&n; *&t;&t;&t;&t;&t;writes utterly bogus code otherwise (sigh)&n; *&t;&t;&t;&t;&t;fixed IGMP loopback to behave in the manner&n; *&t;&t;&t;&t;&t;desired by mrouted, fixed the fact it has been&n; *&t;&t;&t;&t;&t;broken since 1.3.6 and cleaned up a few minor&n; *&t;&t;&t;&t;&t;points.&n; *&n; *&t;&t;Chih-Jen Chang&t;:&t;Tried to revise IGMP to Version 2&n; *&t;&t;Tsu-Sheng Tsao&t;&t;E-mail: chihjenc@scf.usc.edu and tsusheng@scf.usc.edu&n; *&t;&t;&t;&t;&t;The enhancements are mainly based on Steve Deering&squot;s &n; * &t;&t;&t;&t;&t;ipmulti-3.5 source code.&n; *&t;&t;Chih-Jen Chang&t;:&t;Added the igmp_get_mrouter_info and&n; *&t;&t;Tsu-Sheng Tsao&t;&t;igmp_set_mrouter_info to keep track of&n; *&t;&t;&t;&t;&t;the mrouted version on that device.&n; *&t;&t;Chih-Jen Chang&t;:&t;Added the max_resp_time parameter to&n; *&t;&t;Tsu-Sheng Tsao&t;&t;igmp_heard_query(). Using this parameter&n; *&t;&t;&t;&t;&t;to identify the multicast router version&n; *&t;&t;&t;&t;&t;and do what the IGMP version 2 specified.&n; *&t;&t;Chih-Jen Chang&t;:&t;Added a timer to revert to IGMP V2 router&n; *&t;&t;Tsu-Sheng Tsao&t;&t;if the specified time expired.&n; *&t;&t;Alan Cox&t;:&t;Stop IGMP from 0.0.0.0 being accepted.&n; *&t;&t;Alan Cox&t;:&t;Use GFP_ATOMIC in the right places.&n; *&t;&t;Christian Daudt :&t;igmp timer wasn&squot;t set for local group&n; *&t;&t;&t;&t;&t;memberships but was being deleted, &n; *&t;&t;&t;&t;&t;which caused a &quot;del_timer() called &n; *&t;&t;&t;&t;&t;from %p with timer not initialized&bslash;n&quot;&n; *&t;&t;&t;&t;&t;message (960131).&n; *&t;&t;Christian Daudt :&t;removed del_timer from &n; *&t;&t;&t;&t;&t;igmp_timer_expire function (960205).&n; *             Christian Daudt :       igmp_heard_report now only calls&n; *                                     igmp_timer_expire if tm-&gt;running is&n; *                                     true (960216).&n; *&t;&t;Malcolm Beattie :&t;ttl comparison wrong in igmp_rcv made&n; *&t;&t;&t;&t;&t;igmp_heard_query never trigger. Expiry&n; *&t;&t;&t;&t;&t;miscalculation fixed in igmp_heard_query&n; *&t;&t;&t;&t;&t;and random() made to return unsigned to&n; *&t;&t;&t;&t;&t;prevent negative expiry times.&n; *&t;&t;Alexey Kuznetsov:&t;Wrong group leaving behaviour, backport&n; *&t;&t;&t;&t;&t;fix from pending 2.1.x patches.&n; *&t;&t;Alan Cox:&t;&t;Forget to enable FDDI support earlier.&n; *&t;&t;Alexey Kuznetsov:&t;Fixed leaving groups on device down.&n; *&t;&t;Alexey Kuznetsov:&t;Accordance to igmp-v2-06 draft.&n; */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;asm/uaccess.h&gt;
macro_line|#include &lt;asm/system.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/socket.h&gt;
macro_line|#include &lt;linux/sockios.h&gt;
macro_line|#include &lt;linux/in.h&gt;
macro_line|#include &lt;linux/inet.h&gt;
macro_line|#include &lt;linux/netdevice.h&gt;
macro_line|#include &lt;linux/skbuff.h&gt;
macro_line|#include &lt;linux/inetdevice.h&gt;
macro_line|#include &lt;linux/igmp.h&gt;
macro_line|#include &lt;linux/if_arp.h&gt;
macro_line|#include &lt;linux/rtnetlink.h&gt;
macro_line|#include &lt;net/ip.h&gt;
macro_line|#include &lt;net/protocol.h&gt;
macro_line|#include &lt;net/route.h&gt;
macro_line|#include &lt;net/sock.h&gt;
macro_line|#include &lt;net/checksum.h&gt;
macro_line|#include &lt;linux/netfilter_ipv4.h&gt;
macro_line|#ifdef CONFIG_IP_MROUTE
macro_line|#include &lt;linux/mroute.h&gt;
macro_line|#endif
DECL|macro|IP_MAX_MEMBERSHIPS
mdefine_line|#define IP_MAX_MEMBERSHIPS 20
macro_line|#ifdef CONFIG_IP_MULTICAST
multiline_comment|/* Parameter names and values are taken from igmp-v2-06 draft */
DECL|macro|IGMP_V1_Router_Present_Timeout
mdefine_line|#define IGMP_V1_Router_Present_Timeout&t;&t;(400*HZ)
DECL|macro|IGMP_Unsolicited_Report_Interval
mdefine_line|#define IGMP_Unsolicited_Report_Interval&t;(10*HZ)
DECL|macro|IGMP_Query_Response_Interval
mdefine_line|#define IGMP_Query_Response_Interval&t;&t;(10*HZ)
DECL|macro|IGMP_Unsolicited_Report_Count
mdefine_line|#define IGMP_Unsolicited_Report_Count&t;&t;2
DECL|macro|IGMP_Initial_Report_Delay
mdefine_line|#define IGMP_Initial_Report_Delay&t;&t;(1*HZ)
multiline_comment|/* IGMP_Initial_Report_Delay is not from IGMP specs!&n; * IGMP specs require to report membership immediately after&n; * joining a group, but we delay the first report by a&n; * small interval. It seems more natural and still does not&n; * contradict to specs provided this delay is small enough.&n; */
DECL|macro|IGMP_V1_SEEN
mdefine_line|#define IGMP_V1_SEEN(in_dev) ((in_dev)-&gt;mr_v1_seen &amp;&amp; (long)(jiffies - (in_dev)-&gt;mr_v1_seen) &lt; 0)
macro_line|#endif
DECL|function|ip_ma_put
r_static
r_void
id|ip_ma_put
c_func
(paren
r_struct
id|ip_mc_list
op_star
id|im
)paren
(brace
r_if
c_cond
(paren
id|atomic_dec_and_test
c_func
(paren
op_amp
id|im-&gt;refcnt
)paren
)paren
(brace
id|in_dev_put
c_func
(paren
id|im-&gt;interface
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|im
)paren
suffix:semicolon
)brace
)brace
macro_line|#ifdef CONFIG_IP_MULTICAST
multiline_comment|/*&n; *&t;Timer management&n; */
DECL|function|igmp_stop_timer
r_static
id|__inline__
r_void
id|igmp_stop_timer
c_func
(paren
r_struct
id|ip_mc_list
op_star
id|im
)paren
(brace
id|spin_lock_bh
c_func
(paren
op_amp
id|im-&gt;lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|del_timer
c_func
(paren
op_amp
id|im-&gt;timer
)paren
)paren
id|atomic_dec
c_func
(paren
op_amp
id|im-&gt;refcnt
)paren
suffix:semicolon
id|im-&gt;tm_running
op_assign
l_int|0
suffix:semicolon
id|im-&gt;reporter
op_assign
l_int|0
suffix:semicolon
id|im-&gt;unsolicit_count
op_assign
l_int|0
suffix:semicolon
id|spin_unlock_bh
c_func
(paren
op_amp
id|im-&gt;lock
)paren
suffix:semicolon
)brace
multiline_comment|/* It must be called with locked im-&gt;lock */
DECL|function|igmp_start_timer
r_static
r_void
id|igmp_start_timer
c_func
(paren
r_struct
id|ip_mc_list
op_star
id|im
comma
r_int
id|max_delay
)paren
(brace
r_int
id|tv
op_assign
id|net_random
c_func
(paren
)paren
op_mod
id|max_delay
suffix:semicolon
id|im-&gt;tm_running
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|mod_timer
c_func
(paren
op_amp
id|im-&gt;timer
comma
id|jiffies
op_plus
id|tv
op_plus
l_int|2
)paren
)paren
id|atomic_inc
c_func
(paren
op_amp
id|im-&gt;refcnt
)paren
suffix:semicolon
)brace
DECL|function|igmp_mod_timer
r_static
r_void
id|igmp_mod_timer
c_func
(paren
r_struct
id|ip_mc_list
op_star
id|im
comma
r_int
id|max_delay
)paren
(brace
id|spin_lock_bh
c_func
(paren
op_amp
id|im-&gt;lock
)paren
suffix:semicolon
id|im-&gt;unsolicit_count
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|del_timer
c_func
(paren
op_amp
id|im-&gt;timer
)paren
)paren
(brace
r_if
c_cond
(paren
(paren
r_int
)paren
(paren
id|im-&gt;timer.expires
op_minus
id|jiffies
)paren
OL
id|max_delay
)paren
(brace
id|add_timer
c_func
(paren
op_amp
id|im-&gt;timer
)paren
suffix:semicolon
id|im-&gt;tm_running
op_assign
l_int|1
suffix:semicolon
id|spin_unlock_bh
c_func
(paren
op_amp
id|im-&gt;lock
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|atomic_dec
c_func
(paren
op_amp
id|im-&gt;refcnt
)paren
suffix:semicolon
)brace
id|igmp_start_timer
c_func
(paren
id|im
comma
id|max_delay
)paren
suffix:semicolon
id|spin_unlock_bh
c_func
(paren
op_amp
id|im-&gt;lock
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;Send an IGMP report.&n; */
DECL|macro|IGMP_SIZE
mdefine_line|#define IGMP_SIZE (sizeof(struct igmphdr)+sizeof(struct iphdr)+4)
multiline_comment|/* Don&squot;t just hand NF_HOOK skb-&gt;dst-&gt;output, in case netfilter hook&n;   changes route */
r_static
r_inline
r_int
DECL|function|output_maybe_reroute
id|output_maybe_reroute
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
)paren
(brace
r_return
id|skb-&gt;dst
op_member_access_from_pointer
id|output
c_func
(paren
id|skb
)paren
suffix:semicolon
)brace
DECL|function|igmp_send_report
r_static
r_int
id|igmp_send_report
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
id|u32
id|group
comma
r_int
id|type
)paren
(brace
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
r_struct
id|iphdr
op_star
id|iph
suffix:semicolon
r_struct
id|igmphdr
op_star
id|ih
suffix:semicolon
r_struct
id|rtable
op_star
id|rt
suffix:semicolon
id|u32
id|dst
suffix:semicolon
multiline_comment|/* According to IGMPv2 specs, LEAVE messages are&n;&t; * sent to all-routers group.&n;&t; */
id|dst
op_assign
id|group
suffix:semicolon
r_if
c_cond
(paren
id|type
op_eq
id|IGMP_HOST_LEAVE_MESSAGE
)paren
id|dst
op_assign
id|IGMP_ALL_ROUTER
suffix:semicolon
r_if
c_cond
(paren
id|ip_route_output
c_func
(paren
op_amp
id|rt
comma
id|dst
comma
l_int|0
comma
l_int|0
comma
id|dev-&gt;ifindex
)paren
)paren
r_return
op_minus
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|rt-&gt;rt_src
op_eq
l_int|0
)paren
(brace
id|ip_rt_put
c_func
(paren
id|rt
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|skb
op_assign
id|alloc_skb
c_func
(paren
id|IGMP_SIZE
op_plus
id|dev-&gt;hard_header_len
op_plus
l_int|15
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
id|skb
op_eq
l_int|NULL
)paren
(brace
id|ip_rt_put
c_func
(paren
id|rt
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|skb-&gt;dst
op_assign
op_amp
id|rt-&gt;u.dst
suffix:semicolon
id|skb_reserve
c_func
(paren
id|skb
comma
(paren
id|dev-&gt;hard_header_len
op_plus
l_int|15
)paren
op_amp
op_complement
l_int|15
)paren
suffix:semicolon
id|skb-&gt;nh.iph
op_assign
id|iph
op_assign
(paren
r_struct
id|iphdr
op_star
)paren
id|skb_put
c_func
(paren
id|skb
comma
r_sizeof
(paren
r_struct
id|iphdr
)paren
op_plus
l_int|4
)paren
suffix:semicolon
id|iph-&gt;version
op_assign
l_int|4
suffix:semicolon
id|iph-&gt;ihl
op_assign
(paren
r_sizeof
(paren
r_struct
id|iphdr
)paren
op_plus
l_int|4
)paren
op_rshift
l_int|2
suffix:semicolon
id|iph-&gt;tos
op_assign
l_int|0
suffix:semicolon
id|iph-&gt;frag_off
op_assign
id|__constant_htons
c_func
(paren
id|IP_DF
)paren
suffix:semicolon
id|iph-&gt;ttl
op_assign
l_int|1
suffix:semicolon
id|iph-&gt;daddr
op_assign
id|dst
suffix:semicolon
id|iph-&gt;saddr
op_assign
id|rt-&gt;rt_src
suffix:semicolon
id|iph-&gt;protocol
op_assign
id|IPPROTO_IGMP
suffix:semicolon
id|iph-&gt;tot_len
op_assign
id|htons
c_func
(paren
id|IGMP_SIZE
)paren
suffix:semicolon
id|ip_select_ident
c_func
(paren
id|iph
comma
op_amp
id|rt-&gt;u.dst
)paren
suffix:semicolon
(paren
(paren
id|u8
op_star
)paren
op_amp
id|iph
(braket
l_int|1
)braket
)paren
(braket
l_int|0
)braket
op_assign
id|IPOPT_RA
suffix:semicolon
(paren
(paren
id|u8
op_star
)paren
op_amp
id|iph
(braket
l_int|1
)braket
)paren
(braket
l_int|1
)braket
op_assign
l_int|4
suffix:semicolon
(paren
(paren
id|u8
op_star
)paren
op_amp
id|iph
(braket
l_int|1
)braket
)paren
(braket
l_int|2
)braket
op_assign
l_int|0
suffix:semicolon
(paren
(paren
id|u8
op_star
)paren
op_amp
id|iph
(braket
l_int|1
)braket
)paren
(braket
l_int|3
)braket
op_assign
l_int|0
suffix:semicolon
id|ip_send_check
c_func
(paren
id|iph
)paren
suffix:semicolon
id|ih
op_assign
(paren
r_struct
id|igmphdr
op_star
)paren
id|skb_put
c_func
(paren
id|skb
comma
r_sizeof
(paren
r_struct
id|igmphdr
)paren
)paren
suffix:semicolon
id|ih-&gt;type
op_assign
id|type
suffix:semicolon
id|ih-&gt;code
op_assign
l_int|0
suffix:semicolon
id|ih-&gt;csum
op_assign
l_int|0
suffix:semicolon
id|ih-&gt;group
op_assign
id|group
suffix:semicolon
id|ih-&gt;csum
op_assign
id|ip_compute_csum
c_func
(paren
(paren
r_void
op_star
)paren
id|ih
comma
r_sizeof
(paren
r_struct
id|igmphdr
)paren
)paren
suffix:semicolon
r_return
id|NF_HOOK
c_func
(paren
id|PF_INET
comma
id|NF_IP_LOCAL_OUT
comma
id|skb
comma
l_int|NULL
comma
id|rt-&gt;u.dst.dev
comma
id|output_maybe_reroute
)paren
suffix:semicolon
)brace
DECL|function|igmp_timer_expire
r_static
r_void
id|igmp_timer_expire
c_func
(paren
r_int
r_int
id|data
)paren
(brace
r_struct
id|ip_mc_list
op_star
id|im
op_assign
(paren
r_struct
id|ip_mc_list
op_star
)paren
id|data
suffix:semicolon
r_struct
id|in_device
op_star
id|in_dev
op_assign
id|im-&gt;interface
suffix:semicolon
r_int
id|err
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|im-&gt;lock
)paren
suffix:semicolon
id|im-&gt;tm_running
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|IGMP_V1_SEEN
c_func
(paren
id|in_dev
)paren
)paren
id|err
op_assign
id|igmp_send_report
c_func
(paren
id|in_dev-&gt;dev
comma
id|im-&gt;multiaddr
comma
id|IGMP_HOST_MEMBERSHIP_REPORT
)paren
suffix:semicolon
r_else
id|err
op_assign
id|igmp_send_report
c_func
(paren
id|in_dev-&gt;dev
comma
id|im-&gt;multiaddr
comma
id|IGMP_HOST_NEW_MEMBERSHIP_REPORT
)paren
suffix:semicolon
multiline_comment|/* Failed. Retry later. */
r_if
c_cond
(paren
id|err
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|in_dev-&gt;dead
)paren
id|igmp_start_timer
c_func
(paren
id|im
comma
id|IGMP_Unsolicited_Report_Interval
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
r_if
c_cond
(paren
id|im-&gt;unsolicit_count
)paren
(brace
id|im-&gt;unsolicit_count
op_decrement
suffix:semicolon
id|igmp_start_timer
c_func
(paren
id|im
comma
id|IGMP_Unsolicited_Report_Interval
)paren
suffix:semicolon
)brace
id|im-&gt;reporter
op_assign
l_int|1
suffix:semicolon
id|out
suffix:colon
id|spin_unlock
c_func
(paren
op_amp
id|im-&gt;lock
)paren
suffix:semicolon
id|ip_ma_put
c_func
(paren
id|im
)paren
suffix:semicolon
)brace
DECL|function|igmp_heard_report
r_static
r_void
id|igmp_heard_report
c_func
(paren
r_struct
id|in_device
op_star
id|in_dev
comma
id|u32
id|group
)paren
(brace
r_struct
id|ip_mc_list
op_star
id|im
suffix:semicolon
multiline_comment|/* Timers are only set for non-local groups */
r_if
c_cond
(paren
id|group
op_eq
id|IGMP_ALL_HOSTS
)paren
r_return
suffix:semicolon
id|read_lock
c_func
(paren
op_amp
id|in_dev-&gt;lock
)paren
suffix:semicolon
r_for
c_loop
(paren
id|im
op_assign
id|in_dev-&gt;mc_list
suffix:semicolon
id|im
op_ne
l_int|NULL
suffix:semicolon
id|im
op_assign
id|im-&gt;next
)paren
(brace
r_if
c_cond
(paren
id|im-&gt;multiaddr
op_eq
id|group
)paren
(brace
id|igmp_stop_timer
c_func
(paren
id|im
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
id|read_unlock
c_func
(paren
op_amp
id|in_dev-&gt;lock
)paren
suffix:semicolon
)brace
DECL|function|igmp_heard_query
r_static
r_void
id|igmp_heard_query
c_func
(paren
r_struct
id|in_device
op_star
id|in_dev
comma
r_int
r_char
id|max_resp_time
comma
id|u32
id|group
)paren
(brace
r_struct
id|ip_mc_list
op_star
id|im
suffix:semicolon
r_int
id|max_delay
suffix:semicolon
id|max_delay
op_assign
id|max_resp_time
op_star
(paren
id|HZ
op_div
id|IGMP_TIMER_SCALE
)paren
suffix:semicolon
r_if
c_cond
(paren
id|max_resp_time
op_eq
l_int|0
)paren
(brace
multiline_comment|/* Alas, old v1 router presents here. */
id|max_delay
op_assign
id|IGMP_Query_Response_Interval
suffix:semicolon
id|in_dev-&gt;mr_v1_seen
op_assign
id|jiffies
op_plus
id|IGMP_V1_Router_Present_Timeout
suffix:semicolon
id|group
op_assign
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * - Start the timers in all of our membership records&n;&t; *   that the query applies to for the interface on&n;&t; *   which the query arrived excl. those that belong&n;&t; *   to a &quot;local&quot; group (224.0.0.X)&n;&t; * - For timers already running check if they need to&n;&t; *   be reset.&n;&t; * - Use the igmp-&gt;igmp_code field as the maximum&n;&t; *   delay possible&n;&t; */
id|read_lock
c_func
(paren
op_amp
id|in_dev-&gt;lock
)paren
suffix:semicolon
r_for
c_loop
(paren
id|im
op_assign
id|in_dev-&gt;mc_list
suffix:semicolon
id|im
op_ne
l_int|NULL
suffix:semicolon
id|im
op_assign
id|im-&gt;next
)paren
(brace
r_if
c_cond
(paren
id|group
op_logical_and
id|group
op_ne
id|im-&gt;multiaddr
)paren
r_continue
suffix:semicolon
r_if
c_cond
(paren
id|im-&gt;multiaddr
op_eq
id|IGMP_ALL_HOSTS
)paren
r_continue
suffix:semicolon
id|igmp_mod_timer
c_func
(paren
id|im
comma
id|max_delay
)paren
suffix:semicolon
)brace
id|read_unlock
c_func
(paren
op_amp
id|in_dev-&gt;lock
)paren
suffix:semicolon
)brace
DECL|function|igmp_rcv
r_int
id|igmp_rcv
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_int
r_int
id|len
)paren
(brace
multiline_comment|/* This basically follows the spec line by line -- see RFC1112 */
r_struct
id|igmphdr
op_star
id|ih
op_assign
id|skb-&gt;h.igmph
suffix:semicolon
r_struct
id|in_device
op_star
id|in_dev
op_assign
id|in_dev_get
c_func
(paren
id|skb-&gt;dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|in_dev
op_eq
l_int|NULL
)paren
(brace
id|kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|len
OL
r_sizeof
(paren
r_struct
id|igmphdr
)paren
op_logical_or
id|ip_compute_csum
c_func
(paren
(paren
r_void
op_star
)paren
id|ih
comma
id|len
)paren
)paren
(brace
id|in_dev_put
c_func
(paren
id|in_dev
)paren
suffix:semicolon
id|kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_switch
c_cond
(paren
id|ih-&gt;type
)paren
(brace
r_case
id|IGMP_HOST_MEMBERSHIP_QUERY
suffix:colon
id|igmp_heard_query
c_func
(paren
id|in_dev
comma
id|ih-&gt;code
comma
id|ih-&gt;group
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|IGMP_HOST_MEMBERSHIP_REPORT
suffix:colon
r_case
id|IGMP_HOST_NEW_MEMBERSHIP_REPORT
suffix:colon
multiline_comment|/* Is it our report looped back? */
r_if
c_cond
(paren
(paren
(paren
r_struct
id|rtable
op_star
)paren
id|skb-&gt;dst
)paren
op_member_access_from_pointer
id|key.iif
op_eq
l_int|0
)paren
r_break
suffix:semicolon
id|igmp_heard_report
c_func
(paren
id|in_dev
comma
id|ih-&gt;group
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|IGMP_PIM
suffix:colon
macro_line|#ifdef CONFIG_IP_PIMSM_V1
id|in_dev_put
c_func
(paren
id|in_dev
)paren
suffix:semicolon
r_return
id|pim_rcv_v1
c_func
(paren
id|skb
comma
id|len
)paren
suffix:semicolon
macro_line|#endif
r_case
id|IGMP_DVMRP
suffix:colon
r_case
id|IGMP_TRACE
suffix:colon
r_case
id|IGMP_HOST_LEAVE_MESSAGE
suffix:colon
r_case
id|IGMP_MTRACE
suffix:colon
r_case
id|IGMP_MTRACE_RESP
suffix:colon
r_break
suffix:semicolon
r_default
suffix:colon
id|NETDEBUG
c_func
(paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;New IGMP type=%d, why we do not know about it?&bslash;n&quot;
comma
id|ih-&gt;type
)paren
)paren
suffix:semicolon
)brace
id|in_dev_put
c_func
(paren
id|in_dev
)paren
suffix:semicolon
id|kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#endif
multiline_comment|/*&n; *&t;Add a filter to a device&n; */
DECL|function|ip_mc_filter_add
r_static
r_void
id|ip_mc_filter_add
c_func
(paren
r_struct
id|in_device
op_star
id|in_dev
comma
id|u32
id|addr
)paren
(brace
r_char
id|buf
(braket
id|MAX_ADDR_LEN
)braket
suffix:semicolon
r_struct
id|net_device
op_star
id|dev
op_assign
id|in_dev-&gt;dev
suffix:semicolon
multiline_comment|/* Checking for IFF_MULTICAST here is WRONG-WRONG-WRONG.&n;&t;   We will get multicast token leakage, when IFF_MULTICAST&n;&t;   is changed. This check should be done in dev-&gt;set_multicast_list&n;&t;   routine. Something sort of:&n;&t;   if (dev-&gt;mc_list &amp;&amp; dev-&gt;flags&amp;IFF_MULTICAST) { do it; }&n;&t;   --ANK&n;&t;   */
r_if
c_cond
(paren
id|arp_mc_map
c_func
(paren
id|addr
comma
id|buf
comma
id|dev
comma
l_int|0
)paren
op_eq
l_int|0
)paren
id|dev_mc_add
c_func
(paren
id|dev
comma
id|buf
comma
id|dev-&gt;addr_len
comma
l_int|0
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;Remove a filter from a device&n; */
DECL|function|ip_mc_filter_del
r_static
r_void
id|ip_mc_filter_del
c_func
(paren
r_struct
id|in_device
op_star
id|in_dev
comma
id|u32
id|addr
)paren
(brace
r_char
id|buf
(braket
id|MAX_ADDR_LEN
)braket
suffix:semicolon
r_struct
id|net_device
op_star
id|dev
op_assign
id|in_dev-&gt;dev
suffix:semicolon
r_if
c_cond
(paren
id|arp_mc_map
c_func
(paren
id|addr
comma
id|buf
comma
id|dev
comma
l_int|0
)paren
op_eq
l_int|0
)paren
id|dev_mc_delete
c_func
(paren
id|dev
comma
id|buf
comma
id|dev-&gt;addr_len
comma
l_int|0
)paren
suffix:semicolon
)brace
DECL|function|igmp_group_dropped
r_static
r_void
id|igmp_group_dropped
c_func
(paren
r_struct
id|ip_mc_list
op_star
id|im
)paren
(brace
macro_line|#ifdef CONFIG_IP_MULTICAST
r_int
id|reporter
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|im-&gt;loaded
)paren
(brace
id|im-&gt;loaded
op_assign
l_int|0
suffix:semicolon
id|ip_mc_filter_del
c_func
(paren
id|im-&gt;interface
comma
id|im-&gt;multiaddr
)paren
suffix:semicolon
)brace
macro_line|#ifdef CONFIG_IP_MULTICAST
r_if
c_cond
(paren
id|im-&gt;multiaddr
op_eq
id|IGMP_ALL_HOSTS
)paren
r_return
suffix:semicolon
id|reporter
op_assign
id|im-&gt;reporter
suffix:semicolon
id|igmp_stop_timer
c_func
(paren
id|im
)paren
suffix:semicolon
r_if
c_cond
(paren
id|reporter
op_logical_and
op_logical_neg
id|IGMP_V1_SEEN
c_func
(paren
id|im-&gt;interface
)paren
)paren
id|igmp_send_report
c_func
(paren
id|im-&gt;interface-&gt;dev
comma
id|im-&gt;multiaddr
comma
id|IGMP_HOST_LEAVE_MESSAGE
)paren
suffix:semicolon
macro_line|#endif
)brace
DECL|function|igmp_group_added
r_static
r_void
id|igmp_group_added
c_func
(paren
r_struct
id|ip_mc_list
op_star
id|im
)paren
(brace
r_if
c_cond
(paren
id|im-&gt;loaded
op_eq
l_int|0
)paren
(brace
id|im-&gt;loaded
op_assign
l_int|1
suffix:semicolon
id|ip_mc_filter_add
c_func
(paren
id|im-&gt;interface
comma
id|im-&gt;multiaddr
)paren
suffix:semicolon
)brace
macro_line|#ifdef CONFIG_IP_MULTICAST
r_if
c_cond
(paren
id|im-&gt;multiaddr
op_eq
id|IGMP_ALL_HOSTS
)paren
r_return
suffix:semicolon
id|spin_lock_bh
c_func
(paren
op_amp
id|im-&gt;lock
)paren
suffix:semicolon
id|igmp_start_timer
c_func
(paren
id|im
comma
id|IGMP_Initial_Report_Delay
)paren
suffix:semicolon
id|spin_unlock_bh
c_func
(paren
op_amp
id|im-&gt;lock
)paren
suffix:semicolon
macro_line|#endif
)brace
multiline_comment|/*&n; *&t;Multicast list managers&n; */
multiline_comment|/*&n; *&t;A socket has joined a multicast group on device dev.&n; */
DECL|function|ip_mc_inc_group
r_void
id|ip_mc_inc_group
c_func
(paren
r_struct
id|in_device
op_star
id|in_dev
comma
id|u32
id|addr
)paren
(brace
r_struct
id|ip_mc_list
op_star
id|im
suffix:semicolon
id|ASSERT_RTNL
c_func
(paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|im
op_assign
id|in_dev-&gt;mc_list
suffix:semicolon
id|im
suffix:semicolon
id|im
op_assign
id|im-&gt;next
)paren
(brace
r_if
c_cond
(paren
id|im-&gt;multiaddr
op_eq
id|addr
)paren
(brace
id|im-&gt;users
op_increment
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
)brace
id|im
op_assign
(paren
r_struct
id|ip_mc_list
op_star
)paren
id|kmalloc
c_func
(paren
r_sizeof
(paren
op_star
id|im
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|im
)paren
r_goto
id|out
suffix:semicolon
id|im-&gt;users
op_assign
l_int|1
suffix:semicolon
id|im-&gt;interface
op_assign
id|in_dev
suffix:semicolon
id|in_dev_hold
c_func
(paren
id|in_dev
)paren
suffix:semicolon
id|im-&gt;multiaddr
op_assign
id|addr
suffix:semicolon
id|atomic_set
c_func
(paren
op_amp
id|im-&gt;refcnt
comma
l_int|1
)paren
suffix:semicolon
id|spin_lock_init
c_func
(paren
op_amp
id|im-&gt;lock
)paren
suffix:semicolon
macro_line|#ifdef  CONFIG_IP_MULTICAST
id|im-&gt;tm_running
op_assign
l_int|0
suffix:semicolon
id|init_timer
c_func
(paren
op_amp
id|im-&gt;timer
)paren
suffix:semicolon
id|im-&gt;timer.data
op_assign
(paren
r_int
r_int
)paren
id|im
suffix:semicolon
id|im-&gt;timer.function
op_assign
op_amp
id|igmp_timer_expire
suffix:semicolon
id|im-&gt;unsolicit_count
op_assign
id|IGMP_Unsolicited_Report_Count
suffix:semicolon
id|im-&gt;reporter
op_assign
l_int|0
suffix:semicolon
id|im-&gt;loaded
op_assign
l_int|0
suffix:semicolon
macro_line|#endif
id|write_lock_bh
c_func
(paren
op_amp
id|in_dev-&gt;lock
)paren
suffix:semicolon
id|im-&gt;next
op_assign
id|in_dev-&gt;mc_list
suffix:semicolon
id|in_dev-&gt;mc_list
op_assign
id|im
suffix:semicolon
id|write_unlock_bh
c_func
(paren
op_amp
id|in_dev-&gt;lock
)paren
suffix:semicolon
id|igmp_group_added
c_func
(paren
id|im
)paren
suffix:semicolon
r_if
c_cond
(paren
id|in_dev-&gt;dev-&gt;flags
op_amp
id|IFF_UP
)paren
id|ip_rt_multicast_event
c_func
(paren
id|in_dev
)paren
suffix:semicolon
id|out
suffix:colon
r_return
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;A socket has left a multicast group on device dev&n; */
DECL|function|ip_mc_dec_group
r_int
id|ip_mc_dec_group
c_func
(paren
r_struct
id|in_device
op_star
id|in_dev
comma
id|u32
id|addr
)paren
(brace
r_int
id|err
op_assign
op_minus
id|ESRCH
suffix:semicolon
r_struct
id|ip_mc_list
op_star
id|i
comma
op_star
op_star
id|ip
suffix:semicolon
id|ASSERT_RTNL
c_func
(paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|ip
op_assign
op_amp
id|in_dev-&gt;mc_list
suffix:semicolon
(paren
id|i
op_assign
op_star
id|ip
)paren
op_ne
l_int|NULL
suffix:semicolon
id|ip
op_assign
op_amp
id|i-&gt;next
)paren
(brace
r_if
c_cond
(paren
id|i-&gt;multiaddr
op_eq
id|addr
)paren
(brace
r_if
c_cond
(paren
op_decrement
id|i-&gt;users
op_eq
l_int|0
)paren
(brace
id|write_lock_bh
c_func
(paren
op_amp
id|in_dev-&gt;lock
)paren
suffix:semicolon
op_star
id|ip
op_assign
id|i-&gt;next
suffix:semicolon
id|write_unlock_bh
c_func
(paren
op_amp
id|in_dev-&gt;lock
)paren
suffix:semicolon
id|igmp_group_dropped
c_func
(paren
id|i
)paren
suffix:semicolon
r_if
c_cond
(paren
id|in_dev-&gt;dev-&gt;flags
op_amp
id|IFF_UP
)paren
id|ip_rt_multicast_event
c_func
(paren
id|in_dev
)paren
suffix:semicolon
id|ip_ma_put
c_func
(paren
id|i
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|err
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
r_return
op_minus
id|ESRCH
suffix:semicolon
)brace
multiline_comment|/* Device going down */
DECL|function|ip_mc_down
r_void
id|ip_mc_down
c_func
(paren
r_struct
id|in_device
op_star
id|in_dev
)paren
(brace
r_struct
id|ip_mc_list
op_star
id|i
suffix:semicolon
id|ASSERT_RTNL
c_func
(paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
id|in_dev-&gt;mc_list
suffix:semicolon
id|i
suffix:semicolon
id|i
op_assign
id|i-&gt;next
)paren
id|igmp_group_dropped
c_func
(paren
id|i
)paren
suffix:semicolon
id|ip_mc_dec_group
c_func
(paren
id|in_dev
comma
id|IGMP_ALL_HOSTS
)paren
suffix:semicolon
)brace
multiline_comment|/* Device going up */
DECL|function|ip_mc_up
r_void
id|ip_mc_up
c_func
(paren
r_struct
id|in_device
op_star
id|in_dev
)paren
(brace
r_struct
id|ip_mc_list
op_star
id|i
suffix:semicolon
id|ASSERT_RTNL
c_func
(paren
)paren
suffix:semicolon
id|ip_mc_inc_group
c_func
(paren
id|in_dev
comma
id|IGMP_ALL_HOSTS
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
id|in_dev-&gt;mc_list
suffix:semicolon
id|i
suffix:semicolon
id|i
op_assign
id|i-&gt;next
)paren
id|igmp_group_added
c_func
(paren
id|i
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;Device is about to be destroyed: clean up.&n; */
DECL|function|ip_mc_destroy_dev
r_void
id|ip_mc_destroy_dev
c_func
(paren
r_struct
id|in_device
op_star
id|in_dev
)paren
(brace
r_struct
id|ip_mc_list
op_star
id|i
suffix:semicolon
id|ASSERT_RTNL
c_func
(paren
)paren
suffix:semicolon
id|write_lock_bh
c_func
(paren
op_amp
id|in_dev-&gt;lock
)paren
suffix:semicolon
r_while
c_loop
(paren
(paren
id|i
op_assign
id|in_dev-&gt;mc_list
)paren
op_ne
l_int|NULL
)paren
(brace
id|in_dev-&gt;mc_list
op_assign
id|i-&gt;next
suffix:semicolon
id|write_unlock_bh
c_func
(paren
op_amp
id|in_dev-&gt;lock
)paren
suffix:semicolon
id|igmp_group_dropped
c_func
(paren
id|i
)paren
suffix:semicolon
id|ip_ma_put
c_func
(paren
id|i
)paren
suffix:semicolon
id|write_lock_bh
c_func
(paren
op_amp
id|in_dev-&gt;lock
)paren
suffix:semicolon
)brace
id|write_unlock_bh
c_func
(paren
op_amp
id|in_dev-&gt;lock
)paren
suffix:semicolon
)brace
DECL|function|ip_mc_find_dev
r_static
r_struct
id|in_device
op_star
id|ip_mc_find_dev
c_func
(paren
r_struct
id|ip_mreqn
op_star
id|imr
)paren
(brace
r_struct
id|rtable
op_star
id|rt
suffix:semicolon
r_struct
id|net_device
op_star
id|dev
op_assign
l_int|NULL
suffix:semicolon
r_struct
id|in_device
op_star
id|idev
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
id|imr-&gt;imr_address.s_addr
)paren
(brace
id|dev
op_assign
id|ip_dev_find
c_func
(paren
id|imr-&gt;imr_address.s_addr
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dev
)paren
r_return
l_int|NULL
suffix:semicolon
id|__dev_put
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|dev
op_logical_and
op_logical_neg
id|ip_route_output
c_func
(paren
op_amp
id|rt
comma
id|imr-&gt;imr_multiaddr.s_addr
comma
l_int|0
comma
l_int|0
comma
l_int|0
)paren
)paren
(brace
id|dev
op_assign
id|rt-&gt;u.dst.dev
suffix:semicolon
id|ip_rt_put
c_func
(paren
id|rt
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|dev
)paren
(brace
id|imr-&gt;imr_ifindex
op_assign
id|dev-&gt;ifindex
suffix:semicolon
id|idev
op_assign
id|__in_dev_get
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
r_return
id|idev
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;Join a socket to a group&n; */
DECL|variable|sysctl_igmp_max_memberships
r_int
id|sysctl_igmp_max_memberships
op_assign
id|IP_MAX_MEMBERSHIPS
suffix:semicolon
DECL|function|ip_mc_join_group
r_int
id|ip_mc_join_group
c_func
(paren
r_struct
id|sock
op_star
id|sk
comma
r_struct
id|ip_mreqn
op_star
id|imr
)paren
(brace
r_int
id|err
suffix:semicolon
id|u32
id|addr
op_assign
id|imr-&gt;imr_multiaddr.s_addr
suffix:semicolon
r_struct
id|ip_mc_socklist
op_star
id|iml
comma
op_star
id|i
suffix:semicolon
r_struct
id|in_device
op_star
id|in_dev
suffix:semicolon
r_int
id|count
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|MULTICAST
c_func
(paren
id|addr
)paren
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|rtnl_shlock
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|imr-&gt;imr_ifindex
)paren
id|in_dev
op_assign
id|ip_mc_find_dev
c_func
(paren
id|imr
)paren
suffix:semicolon
r_else
(brace
id|in_dev
op_assign
id|inetdev_by_index
c_func
(paren
id|imr-&gt;imr_ifindex
)paren
suffix:semicolon
r_if
c_cond
(paren
id|in_dev
)paren
id|__in_dev_put
c_func
(paren
id|in_dev
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|in_dev
)paren
(brace
id|iml
op_assign
l_int|NULL
suffix:semicolon
id|err
op_assign
op_minus
id|ENODEV
suffix:semicolon
r_goto
id|done
suffix:semicolon
)brace
id|iml
op_assign
(paren
r_struct
id|ip_mc_socklist
op_star
)paren
id|sock_kmalloc
c_func
(paren
id|sk
comma
r_sizeof
(paren
op_star
id|iml
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
id|err
op_assign
op_minus
id|EADDRINUSE
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
id|sk-&gt;protinfo.af_inet.mc_list
suffix:semicolon
id|i
suffix:semicolon
id|i
op_assign
id|i-&gt;next
)paren
(brace
r_if
c_cond
(paren
id|memcmp
c_func
(paren
op_amp
id|i-&gt;multi
comma
id|imr
comma
r_sizeof
(paren
op_star
id|imr
)paren
)paren
op_eq
l_int|0
)paren
(brace
multiline_comment|/* New style additions are reference counted */
r_if
c_cond
(paren
id|imr-&gt;imr_address.s_addr
op_eq
l_int|0
)paren
(brace
id|i-&gt;count
op_increment
suffix:semicolon
id|err
op_assign
l_int|0
suffix:semicolon
)brace
r_goto
id|done
suffix:semicolon
)brace
id|count
op_increment
suffix:semicolon
)brace
id|err
op_assign
op_minus
id|ENOBUFS
suffix:semicolon
r_if
c_cond
(paren
id|iml
op_eq
l_int|NULL
op_logical_or
id|count
op_ge
id|sysctl_igmp_max_memberships
)paren
r_goto
id|done
suffix:semicolon
id|memcpy
c_func
(paren
op_amp
id|iml-&gt;multi
comma
id|imr
comma
r_sizeof
(paren
op_star
id|imr
)paren
)paren
suffix:semicolon
id|iml-&gt;next
op_assign
id|sk-&gt;protinfo.af_inet.mc_list
suffix:semicolon
id|iml-&gt;count
op_assign
l_int|1
suffix:semicolon
id|sk-&gt;protinfo.af_inet.mc_list
op_assign
id|iml
suffix:semicolon
id|ip_mc_inc_group
c_func
(paren
id|in_dev
comma
id|addr
)paren
suffix:semicolon
id|iml
op_assign
l_int|NULL
suffix:semicolon
id|err
op_assign
l_int|0
suffix:semicolon
id|done
suffix:colon
id|rtnl_shunlock
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|iml
)paren
id|sock_kfree_s
c_func
(paren
id|sk
comma
id|iml
comma
r_sizeof
(paren
op_star
id|iml
)paren
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;Ask a socket to leave a group.&n; */
DECL|function|ip_mc_leave_group
r_int
id|ip_mc_leave_group
c_func
(paren
r_struct
id|sock
op_star
id|sk
comma
r_struct
id|ip_mreqn
op_star
id|imr
)paren
(brace
r_struct
id|ip_mc_socklist
op_star
id|iml
comma
op_star
op_star
id|imlp
suffix:semicolon
id|rtnl_lock
c_func
(paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|imlp
op_assign
op_amp
id|sk-&gt;protinfo.af_inet.mc_list
suffix:semicolon
(paren
id|iml
op_assign
op_star
id|imlp
)paren
op_ne
l_int|NULL
suffix:semicolon
id|imlp
op_assign
op_amp
id|iml-&gt;next
)paren
(brace
r_if
c_cond
(paren
id|iml-&gt;multi.imr_multiaddr.s_addr
op_eq
id|imr-&gt;imr_multiaddr.s_addr
op_logical_and
id|iml-&gt;multi.imr_address.s_addr
op_eq
id|imr-&gt;imr_address.s_addr
op_logical_and
(paren
op_logical_neg
id|imr-&gt;imr_ifindex
op_logical_or
id|iml-&gt;multi.imr_ifindex
op_eq
id|imr-&gt;imr_ifindex
)paren
)paren
(brace
r_struct
id|in_device
op_star
id|in_dev
suffix:semicolon
r_if
c_cond
(paren
op_decrement
id|iml-&gt;count
)paren
(brace
id|rtnl_unlock
c_func
(paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
op_star
id|imlp
op_assign
id|iml-&gt;next
suffix:semicolon
id|in_dev
op_assign
id|inetdev_by_index
c_func
(paren
id|iml-&gt;multi.imr_ifindex
)paren
suffix:semicolon
r_if
c_cond
(paren
id|in_dev
)paren
(brace
id|ip_mc_dec_group
c_func
(paren
id|in_dev
comma
id|imr-&gt;imr_multiaddr.s_addr
)paren
suffix:semicolon
id|in_dev_put
c_func
(paren
id|in_dev
)paren
suffix:semicolon
)brace
id|rtnl_unlock
c_func
(paren
)paren
suffix:semicolon
id|sock_kfree_s
c_func
(paren
id|sk
comma
id|iml
comma
r_sizeof
(paren
op_star
id|iml
)paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
)brace
id|rtnl_unlock
c_func
(paren
)paren
suffix:semicolon
r_return
op_minus
id|EADDRNOTAVAIL
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;A socket is closing.&n; */
DECL|function|ip_mc_drop_socket
r_void
id|ip_mc_drop_socket
c_func
(paren
r_struct
id|sock
op_star
id|sk
)paren
(brace
r_struct
id|ip_mc_socklist
op_star
id|iml
suffix:semicolon
r_if
c_cond
(paren
id|sk-&gt;protinfo.af_inet.mc_list
op_eq
l_int|NULL
)paren
r_return
suffix:semicolon
id|rtnl_lock
c_func
(paren
)paren
suffix:semicolon
r_while
c_loop
(paren
(paren
id|iml
op_assign
id|sk-&gt;protinfo.af_inet.mc_list
)paren
op_ne
l_int|NULL
)paren
(brace
r_struct
id|in_device
op_star
id|in_dev
suffix:semicolon
id|sk-&gt;protinfo.af_inet.mc_list
op_assign
id|iml-&gt;next
suffix:semicolon
r_if
c_cond
(paren
(paren
id|in_dev
op_assign
id|inetdev_by_index
c_func
(paren
id|iml-&gt;multi.imr_ifindex
)paren
)paren
op_ne
l_int|NULL
)paren
(brace
id|ip_mc_dec_group
c_func
(paren
id|in_dev
comma
id|iml-&gt;multi.imr_multiaddr.s_addr
)paren
suffix:semicolon
id|in_dev_put
c_func
(paren
id|in_dev
)paren
suffix:semicolon
)brace
id|sock_kfree_s
c_func
(paren
id|sk
comma
id|iml
comma
r_sizeof
(paren
op_star
id|iml
)paren
)paren
suffix:semicolon
)brace
id|rtnl_unlock
c_func
(paren
)paren
suffix:semicolon
)brace
DECL|function|ip_check_mc
r_int
id|ip_check_mc
c_func
(paren
r_struct
id|in_device
op_star
id|in_dev
comma
id|u32
id|mc_addr
)paren
(brace
r_struct
id|ip_mc_list
op_star
id|im
suffix:semicolon
id|read_lock
c_func
(paren
op_amp
id|in_dev-&gt;lock
)paren
suffix:semicolon
r_for
c_loop
(paren
id|im
op_assign
id|in_dev-&gt;mc_list
suffix:semicolon
id|im
suffix:semicolon
id|im
op_assign
id|im-&gt;next
)paren
(brace
r_if
c_cond
(paren
id|im-&gt;multiaddr
op_eq
id|mc_addr
)paren
(brace
id|read_unlock
c_func
(paren
op_amp
id|in_dev-&gt;lock
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
)brace
id|read_unlock
c_func
(paren
op_amp
id|in_dev-&gt;lock
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#ifdef CONFIG_IP_MULTICAST
DECL|function|ip_mc_procinfo
r_int
id|ip_mc_procinfo
c_func
(paren
r_char
op_star
id|buffer
comma
r_char
op_star
op_star
id|start
comma
id|off_t
id|offset
comma
r_int
id|length
)paren
(brace
id|off_t
id|pos
op_assign
l_int|0
comma
id|begin
op_assign
l_int|0
suffix:semicolon
r_struct
id|ip_mc_list
op_star
id|im
suffix:semicolon
r_int
id|len
op_assign
l_int|0
suffix:semicolon
r_struct
id|net_device
op_star
id|dev
suffix:semicolon
id|len
op_assign
id|sprintf
c_func
(paren
id|buffer
comma
l_string|&quot;Idx&bslash;tDevice    : Count Querier&bslash;tGroup    Users Timer&bslash;tReporter&bslash;n&quot;
)paren
suffix:semicolon
id|read_lock
c_func
(paren
op_amp
id|dev_base_lock
)paren
suffix:semicolon
r_for
c_loop
(paren
id|dev
op_assign
id|dev_base
suffix:semicolon
id|dev
suffix:semicolon
id|dev
op_assign
id|dev-&gt;next
)paren
(brace
r_struct
id|in_device
op_star
id|in_dev
op_assign
id|in_dev_get
c_func
(paren
id|dev
)paren
suffix:semicolon
r_char
op_star
id|querier
op_assign
l_string|&quot;NONE&quot;
suffix:semicolon
r_if
c_cond
(paren
id|in_dev
op_eq
l_int|NULL
)paren
r_continue
suffix:semicolon
id|querier
op_assign
id|IGMP_V1_SEEN
c_func
(paren
id|in_dev
)paren
ques
c_cond
l_string|&quot;V1&quot;
suffix:colon
l_string|&quot;V2&quot;
suffix:semicolon
id|len
op_add_assign
id|sprintf
c_func
(paren
id|buffer
op_plus
id|len
comma
l_string|&quot;%d&bslash;t%-10s: %5d %7s&bslash;n&quot;
comma
id|dev-&gt;ifindex
comma
id|dev-&gt;name
comma
id|dev-&gt;mc_count
comma
id|querier
)paren
suffix:semicolon
id|read_lock
c_func
(paren
op_amp
id|in_dev-&gt;lock
)paren
suffix:semicolon
r_for
c_loop
(paren
id|im
op_assign
id|in_dev-&gt;mc_list
suffix:semicolon
id|im
suffix:semicolon
id|im
op_assign
id|im-&gt;next
)paren
(brace
id|len
op_add_assign
id|sprintf
c_func
(paren
id|buffer
op_plus
id|len
comma
l_string|&quot;&bslash;t&bslash;t&bslash;t&bslash;t%08lX %5d %d:%08lX&bslash;t&bslash;t%d&bslash;n&quot;
comma
id|im-&gt;multiaddr
comma
id|im-&gt;users
comma
id|im-&gt;tm_running
comma
id|im-&gt;timer.expires
op_minus
id|jiffies
comma
id|im-&gt;reporter
)paren
suffix:semicolon
id|pos
op_assign
id|begin
op_plus
id|len
suffix:semicolon
r_if
c_cond
(paren
id|pos
OL
id|offset
)paren
(brace
id|len
op_assign
l_int|0
suffix:semicolon
id|begin
op_assign
id|pos
suffix:semicolon
)brace
r_if
c_cond
(paren
id|pos
OG
id|offset
op_plus
id|length
)paren
(brace
id|read_unlock
c_func
(paren
op_amp
id|in_dev-&gt;lock
)paren
suffix:semicolon
id|in_dev_put
c_func
(paren
id|in_dev
)paren
suffix:semicolon
r_goto
id|done
suffix:semicolon
)brace
)brace
id|read_unlock
c_func
(paren
op_amp
id|in_dev-&gt;lock
)paren
suffix:semicolon
id|in_dev_put
c_func
(paren
id|in_dev
)paren
suffix:semicolon
)brace
id|done
suffix:colon
id|read_unlock
c_func
(paren
op_amp
id|dev_base_lock
)paren
suffix:semicolon
op_star
id|start
op_assign
id|buffer
op_plus
(paren
id|offset
op_minus
id|begin
)paren
suffix:semicolon
id|len
op_sub_assign
(paren
id|offset
op_minus
id|begin
)paren
suffix:semicolon
r_if
c_cond
(paren
id|len
OG
id|length
)paren
(brace
id|len
op_assign
id|length
suffix:semicolon
)brace
r_if
c_cond
(paren
id|len
OL
l_int|0
)paren
(brace
id|len
op_assign
l_int|0
suffix:semicolon
)brace
r_return
id|len
suffix:semicolon
)brace
macro_line|#endif
eof
