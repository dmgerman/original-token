multiline_comment|/*&n; *&t;&t;IP_MASQ_APP application masquerading module&n; *&n; *&n; * Version:&t;@(#)ip_masq_app.c  0.03      03/96&n; *&n; * Author:&t;Juan Jose Ciarlante, &lt;jjciarla@raiz.uncu.edu.ar&gt;&n; *&n; *&n; *&t;This program is free software; you can redistribute it and/or&n; *&t;modify it under the terms of the GNU General Public License&n; *&t;as published by the Free Software Foundation; either version&n; *&t;2 of the License, or (at your option) any later version.&n; *&n; * Fixes:&n; *&t;JJC&t;&t;: Implemented also input pkt hook&n; *&n; *&n; * FIXME:&n; *&t;- ip_masq_skb_replace(): use same skb if space available.&n; *&t;&n; */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/skbuff.h&gt;
macro_line|#include &lt;linux/in.h&gt;
macro_line|#include &lt;linux/ip.h&gt;
macro_line|#include &lt;net/protocol.h&gt;
macro_line|#include &lt;net/tcp.h&gt;
macro_line|#include &lt;net/udp.h&gt;
macro_line|#include &lt;asm/system.h&gt;
macro_line|#include &lt;linux/stat.h&gt;
macro_line|#include &lt;linux/proc_fs.h&gt;
macro_line|#include &lt;net/ip_masq.h&gt;
DECL|variable|strProt
r_static
r_const
r_char
op_star
id|strProt
(braket
)braket
op_assign
(brace
l_string|&quot;UDP&quot;
comma
l_string|&quot;TCP&quot;
)brace
suffix:semicolon
DECL|function|masq_proto_name
r_static
id|__inline__
r_const
r_char
op_star
id|masq_proto_name
c_func
(paren
r_int
id|proto
)paren
(brace
r_return
id|strProt
(braket
id|proto
op_eq
id|IPPROTO_TCP
)braket
suffix:semicolon
)brace
DECL|macro|IP_MASQ_APP_TAB_SIZE
mdefine_line|#define IP_MASQ_APP_TAB_SIZE  16 /* must be power of 2 */
DECL|macro|IP_MASQ_APP_HASH
mdefine_line|#define IP_MASQ_APP_HASH(proto, port) ((port^proto) &amp; (IP_MASQ_APP_TAB_SIZE-1))
DECL|macro|IP_MASQ_APP_TYPE
mdefine_line|#define IP_MASQ_APP_TYPE(proto, port) ( proto&lt;&lt;16 | port )
DECL|macro|IP_MASQ_APP_PORT
mdefine_line|#define IP_MASQ_APP_PORT(type)        ( type &amp; 0xffff )
DECL|macro|IP_MASQ_APP_PROTO
mdefine_line|#define IP_MASQ_APP_PROTO(type)       ( (type&gt;&gt;16) &amp; 0x00ff )
DECL|variable|ip_masq_app_syms
r_static
r_struct
id|symbol_table
id|ip_masq_app_syms
op_assign
(brace
macro_line|#include &lt;linux/symtab_begin.h&gt;
id|X
c_func
(paren
id|register_ip_masq_app
)paren
comma
id|X
c_func
(paren
id|unregister_ip_masq_app
)paren
comma
id|X
c_func
(paren
id|ip_masq_skb_replace
)paren
comma
macro_line|#include &lt;linux/symtab_end.h&gt;
)brace
suffix:semicolon
multiline_comment|/*&n; * &t;will hold masq app. hashed list heads&n; */
DECL|variable|ip_masq_app_base
r_struct
id|ip_masq_app
op_star
id|ip_masq_app_base
(braket
id|IP_MASQ_APP_TAB_SIZE
)braket
suffix:semicolon
multiline_comment|/*&n; * &t;ip_masq_app registration routine&n; *&t;port: host byte order.&n; */
DECL|function|register_ip_masq_app
r_int
id|register_ip_masq_app
c_func
(paren
r_struct
id|ip_masq_app
op_star
id|mapp
comma
r_int
r_int
id|proto
comma
id|__u16
id|port
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
r_int
id|hash
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|mapp
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;register_ip_masq_app(): NULL arg&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|mapp-&gt;type
op_assign
id|IP_MASQ_APP_TYPE
c_func
(paren
id|proto
comma
id|port
)paren
suffix:semicolon
id|mapp-&gt;n_attach
op_assign
l_int|0
suffix:semicolon
id|hash
op_assign
id|IP_MASQ_APP_HASH
c_func
(paren
id|proto
comma
id|port
)paren
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|mapp-&gt;next
op_assign
id|ip_masq_app_base
(braket
id|hash
)braket
suffix:semicolon
id|ip_masq_app_base
(braket
id|hash
)braket
op_assign
id|mapp
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * &t;ip_masq_app unreg. routine.&n; */
DECL|function|unregister_ip_masq_app
r_int
id|unregister_ip_masq_app
c_func
(paren
r_struct
id|ip_masq_app
op_star
id|mapp
)paren
(brace
r_struct
id|ip_masq_app
op_star
op_star
id|mapp_p
suffix:semicolon
r_int
id|hash
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|mapp
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;unregister_ip_masq_app(): NULL arg&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
multiline_comment|/*&n;         * only allow unregistration if it has no attachments&n;         */
r_if
c_cond
(paren
id|mapp-&gt;n_attach
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;unregister_ip_masq_app(): has %d attachments. failed&bslash;n&quot;
comma
id|mapp-&gt;n_attach
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|hash
op_assign
id|IP_MASQ_APP_HASH
c_func
(paren
id|IP_MASQ_APP_PROTO
c_func
(paren
id|mapp-&gt;type
)paren
comma
id|IP_MASQ_APP_PORT
c_func
(paren
id|mapp-&gt;type
)paren
)paren
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|mapp_p
op_assign
op_amp
id|ip_masq_app_base
(braket
id|hash
)braket
suffix:semicolon
op_star
id|mapp_p
suffix:semicolon
id|mapp_p
op_assign
op_amp
(paren
op_star
id|mapp_p
)paren
op_member_access_from_pointer
id|next
)paren
r_if
c_cond
(paren
id|mapp
op_eq
(paren
op_star
id|mapp_p
)paren
)paren
(brace
op_star
id|mapp_p
op_assign
id|mapp-&gt;next
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;unregister_ip_masq_app(proto=%s,port=%u): not hashed!&bslash;n&quot;
comma
id|masq_proto_name
c_func
(paren
id|IP_MASQ_APP_PROTO
c_func
(paren
id|mapp-&gt;type
)paren
)paren
comma
id|IP_MASQ_APP_PORT
c_func
(paren
id|mapp-&gt;type
)paren
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;get ip_masq_app object by its proto and port (net byte order).&n; */
DECL|function|ip_masq_app_get
r_struct
id|ip_masq_app
op_star
id|ip_masq_app_get
c_func
(paren
r_int
r_int
id|proto
comma
id|__u16
id|port
)paren
(brace
r_struct
id|ip_masq_app
op_star
id|mapp
suffix:semicolon
r_int
id|hash
suffix:semicolon
r_int
id|type
suffix:semicolon
id|port
op_assign
id|ntohs
c_func
(paren
id|port
)paren
suffix:semicolon
id|type
op_assign
id|IP_MASQ_APP_TYPE
c_func
(paren
id|proto
comma
id|port
)paren
suffix:semicolon
id|hash
op_assign
id|IP_MASQ_APP_HASH
c_func
(paren
id|proto
comma
id|port
)paren
suffix:semicolon
r_for
c_loop
(paren
id|mapp
op_assign
id|ip_masq_app_base
(braket
id|hash
)braket
suffix:semicolon
id|mapp
suffix:semicolon
id|mapp
op_assign
id|mapp-&gt;next
)paren
(brace
r_if
c_cond
(paren
id|type
op_eq
id|mapp-&gt;type
)paren
r_return
id|mapp
suffix:semicolon
)brace
r_return
l_int|NULL
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;ip_masq_app object binding related funcs.&n; */
multiline_comment|/*&n; * &t;change ip_masq_app object&squot;s number of bindings&n; */
DECL|function|ip_masq_app_bind_chg
r_static
id|__inline__
r_int
id|ip_masq_app_bind_chg
c_func
(paren
r_struct
id|ip_masq_app
op_star
id|mapp
comma
r_int
id|delta
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
r_int
id|n_at
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|mapp
)paren
r_return
op_minus
l_int|1
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|n_at
op_assign
id|mapp-&gt;n_attach
op_plus
id|delta
suffix:semicolon
r_if
c_cond
(paren
id|n_at
OL
l_int|0
)paren
(brace
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;ip_masq_app: tried to set n_attach &lt; 0 for (proto=%s,port==%d) ip_masq_app object.&bslash;n&quot;
comma
id|masq_proto_name
c_func
(paren
id|IP_MASQ_APP_PROTO
c_func
(paren
id|mapp-&gt;type
)paren
)paren
comma
id|IP_MASQ_APP_PORT
c_func
(paren
id|mapp-&gt;type
)paren
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|mapp-&gt;n_attach
op_assign
id|n_at
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;Bind ip_masq to its ip_masq_app based on proto and dport ALREADY&n; *&t;set in ip_masq struct. Also calls constructor.&n; */
DECL|function|ip_masq_bind_app
r_struct
id|ip_masq_app
op_star
id|ip_masq_bind_app
c_func
(paren
r_struct
id|ip_masq
op_star
id|ms
)paren
(brace
r_struct
id|ip_masq_app
op_star
id|mapp
suffix:semicolon
id|mapp
op_assign
id|ip_masq_app_get
c_func
(paren
id|ms-&gt;protocol
comma
id|ms-&gt;dport
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mapp
op_ne
l_int|NULL
)paren
(brace
multiline_comment|/*&n;                 *&t;don&squot;t allow binding if already bound&n;                 */
r_if
c_cond
(paren
id|ms-&gt;app
op_ne
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;ip_masq_bind_app() called for already bound object.&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|ms-&gt;app
suffix:semicolon
)brace
id|ms-&gt;app
op_assign
id|mapp
suffix:semicolon
r_if
c_cond
(paren
id|mapp-&gt;masq_init_1
)paren
id|mapp
op_member_access_from_pointer
id|masq_init_1
c_func
(paren
id|mapp
comma
id|ms
)paren
suffix:semicolon
id|ip_masq_app_bind_chg
c_func
(paren
id|mapp
comma
op_plus
l_int|1
)paren
suffix:semicolon
)brace
r_return
id|mapp
suffix:semicolon
)brace
multiline_comment|/*&n; * &t;Unbind ms from type object and call ms destructor (does not kfree()).&n; */
DECL|function|ip_masq_unbind_app
r_int
id|ip_masq_unbind_app
c_func
(paren
r_struct
id|ip_masq
op_star
id|ms
)paren
(brace
r_struct
id|ip_masq_app
op_star
id|mapp
suffix:semicolon
id|mapp
op_assign
id|ms-&gt;app
suffix:semicolon
r_if
c_cond
(paren
id|mapp
op_ne
l_int|NULL
)paren
(brace
r_if
c_cond
(paren
id|mapp-&gt;masq_done_1
)paren
id|mapp
op_member_access_from_pointer
id|masq_done_1
c_func
(paren
id|mapp
comma
id|ms
)paren
suffix:semicolon
id|ms-&gt;app
op_assign
l_int|NULL
suffix:semicolon
id|ip_masq_app_bind_chg
c_func
(paren
id|mapp
comma
op_minus
l_int|1
)paren
suffix:semicolon
)brace
r_return
(paren
id|mapp
op_ne
l_int|NULL
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;Fixes th-&gt;seq based on ip_masq_seq info.&n; */
DECL|function|masq_fix_seq
r_static
id|__inline__
r_void
id|masq_fix_seq
c_func
(paren
r_const
r_struct
id|ip_masq_seq
op_star
id|ms_seq
comma
r_struct
id|tcphdr
op_star
id|th
)paren
(brace
id|__u32
id|seq
suffix:semicolon
id|seq
op_assign
id|ntohl
c_func
(paren
id|th-&gt;seq
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * &t;Adjust seq with delta-offset for all packets after&n;         * &t;the most recent resized pkt seq and with previous_delta offset&n;         *&t;for all packets&t;before most recent resized pkt seq.&n;&t; */
r_if
c_cond
(paren
id|ms_seq-&gt;delta
op_logical_or
id|ms_seq-&gt;previous_delta
)paren
(brace
r_if
c_cond
(paren
id|after
c_func
(paren
id|seq
comma
id|ms_seq-&gt;init_seq
)paren
)paren
(brace
id|th-&gt;seq
op_assign
id|htonl
c_func
(paren
id|seq
op_plus
id|ms_seq-&gt;delta
)paren
suffix:semicolon
macro_line|#if DEBUG_CONFIG_IP_MASQ_APP
id|printk
c_func
(paren
l_string|&quot;masq_fix_seq() : added delta (%d) to seq&bslash;n&quot;
comma
id|ms_seq-&gt;delta
)paren
suffix:semicolon
macro_line|#endif
)brace
r_else
(brace
id|th-&gt;seq
op_assign
id|htonl
c_func
(paren
id|seq
op_plus
id|ms_seq-&gt;previous_delta
)paren
suffix:semicolon
macro_line|#if DEBUG_CONFIG_IP_MASQ_APP
id|printk
c_func
(paren
l_string|&quot;masq_fix_seq() : added previous_delta (%d) to seq&bslash;n&quot;
comma
id|ms_seq-&gt;previous_delta
)paren
suffix:semicolon
macro_line|#endif
)brace
)brace
)brace
multiline_comment|/*&n; *&t;Fixes th-&gt;ack_seq based on ip_masq_seq info.&n; */
DECL|function|masq_fix_ack_seq
r_static
id|__inline__
r_void
id|masq_fix_ack_seq
c_func
(paren
r_const
r_struct
id|ip_masq_seq
op_star
id|ms_seq
comma
r_struct
id|tcphdr
op_star
id|th
)paren
(brace
id|__u32
id|ack_seq
suffix:semicolon
id|ack_seq
op_assign
id|ntohl
c_func
(paren
id|th-&gt;ack_seq
)paren
suffix:semicolon
multiline_comment|/*&n;         * Adjust ack_seq with delta-offset for&n;         * the packets AFTER most recent resized pkt has caused a shift&n;         * for packets before most recent resized pkt, use previous_delta&n;         */
r_if
c_cond
(paren
id|ms_seq-&gt;delta
op_logical_or
id|ms_seq-&gt;previous_delta
)paren
(brace
r_if
c_cond
(paren
id|after
c_func
(paren
id|ack_seq
comma
id|ms_seq-&gt;init_seq
)paren
)paren
(brace
id|th-&gt;ack_seq
op_assign
id|htonl
c_func
(paren
id|ack_seq
op_minus
id|ms_seq-&gt;delta
)paren
suffix:semicolon
macro_line|#if DEBUG_CONFIG_IP_MASQ_APP
id|printk
c_func
(paren
l_string|&quot;masq_fix_ack_seq() : subtracted delta (%d) from ack_seq&bslash;n&quot;
comma
id|ms_seq-&gt;delta
)paren
suffix:semicolon
macro_line|#endif
)brace
r_else
(brace
id|th-&gt;ack_seq
op_assign
id|htonl
c_func
(paren
id|ack_seq
op_minus
id|ms_seq-&gt;previous_delta
)paren
suffix:semicolon
macro_line|#if DEBUG_CONFIG_IP_MASQ_APP
id|printk
c_func
(paren
l_string|&quot;masq_fix_ack_seq() : subtracted previous_delta (%d) from ack_seq&bslash;n&quot;
comma
id|ms_seq-&gt;previous_delta
)paren
suffix:semicolon
macro_line|#endif
)brace
)brace
)brace
multiline_comment|/*&n; *&t;Updates ip_masq_seq if pkt has been resized&n; *&t;Assumes already checked proto==IPPROTO_TCP and diff!=0.&n; */
DECL|function|masq_seq_update
r_static
id|__inline__
r_void
id|masq_seq_update
c_func
(paren
r_struct
id|ip_masq
op_star
id|ms
comma
r_struct
id|ip_masq_seq
op_star
id|ms_seq
comma
r_int
id|mflag
comma
id|__u32
id|seq
comma
r_int
id|diff
)paren
(brace
multiline_comment|/* if (diff == 0) return; */
r_if
c_cond
(paren
op_logical_neg
(paren
id|ms-&gt;flags
op_amp
id|mflag
)paren
op_logical_or
id|after
c_func
(paren
id|seq
comma
id|ms_seq-&gt;init_seq
)paren
)paren
(brace
id|ms_seq-&gt;previous_delta
op_assign
id|ms_seq-&gt;delta
suffix:semicolon
id|ms_seq-&gt;delta
op_add_assign
id|diff
suffix:semicolon
id|ms_seq-&gt;init_seq
op_assign
id|seq
suffix:semicolon
id|ms-&gt;flags
op_or_assign
id|mflag
suffix:semicolon
)brace
)brace
multiline_comment|/*&n; *&t;Output pkt hook. Will call bound ip_masq_app specific function&n; *&t;called by ip_fw_masquerade(), assumes previously checked ms!=NULL&n; *&t;returns (new - old) skb-&gt;len diff.&n; */
DECL|function|ip_masq_app_pkt_out
r_int
id|ip_masq_app_pkt_out
c_func
(paren
r_struct
id|ip_masq
op_star
id|ms
comma
r_struct
id|sk_buff
op_star
op_star
id|skb_p
comma
r_struct
id|device
op_star
id|dev
)paren
(brace
r_struct
id|ip_masq_app
op_star
id|mapp
suffix:semicolon
r_struct
id|iphdr
op_star
id|iph
suffix:semicolon
r_struct
id|tcphdr
op_star
id|th
suffix:semicolon
r_int
id|diff
suffix:semicolon
id|__u32
id|seq
suffix:semicolon
multiline_comment|/*&n;         *&t;check if application masquerading is bound to&n;         *&t;this ip_masq.&n;         *&t;assumes that once an ip_masq is bound,&n;         *&t;it will not be unbound during its life.&n;         */
r_if
c_cond
(paren
(paren
id|mapp
op_assign
id|ms-&gt;app
)paren
op_eq
l_int|NULL
)paren
r_return
l_int|0
suffix:semicolon
id|iph
op_assign
(paren
op_star
id|skb_p
)paren
op_member_access_from_pointer
id|h.iph
suffix:semicolon
id|th
op_assign
(paren
r_struct
id|tcphdr
op_star
)paren
op_amp
(paren
(paren
(paren
r_char
op_star
)paren
id|iph
)paren
(braket
id|iph-&gt;ihl
op_star
l_int|4
)braket
)paren
suffix:semicolon
multiline_comment|/*&n;         *&t;Remember seq number in case this pkt gets resized&n;         */
id|seq
op_assign
id|ntohl
c_func
(paren
id|th-&gt;seq
)paren
suffix:semicolon
multiline_comment|/*&n;         *&t;Fix seq stuff if flagged as so.&n;         */
r_if
c_cond
(paren
id|ms-&gt;protocol
op_eq
id|IPPROTO_TCP
)paren
(brace
r_if
c_cond
(paren
id|ms-&gt;flags
op_amp
id|IP_MASQ_F_OUT_SEQ
)paren
id|masq_fix_seq
c_func
(paren
op_amp
id|ms-&gt;out_seq
comma
id|th
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ms-&gt;flags
op_amp
id|IP_MASQ_F_IN_SEQ
)paren
id|masq_fix_ack_seq
c_func
(paren
op_amp
id|ms-&gt;in_seq
comma
id|th
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;         *&t;Call private output hook function &n;         */
r_if
c_cond
(paren
id|mapp-&gt;pkt_out
op_eq
l_int|NULL
)paren
r_return
l_int|0
suffix:semicolon
id|diff
op_assign
id|mapp
op_member_access_from_pointer
id|pkt_out
c_func
(paren
id|mapp
comma
id|ms
comma
id|skb_p
comma
id|dev
)paren
suffix:semicolon
multiline_comment|/*&n;         *&t;Update ip_masq seq stuff if len has changed.&n;         */
r_if
c_cond
(paren
id|diff
op_ne
l_int|0
op_logical_and
id|ms-&gt;protocol
op_eq
id|IPPROTO_TCP
)paren
id|masq_seq_update
c_func
(paren
id|ms
comma
op_amp
id|ms-&gt;out_seq
comma
id|IP_MASQ_F_OUT_SEQ
comma
id|seq
comma
id|diff
)paren
suffix:semicolon
r_return
id|diff
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;Input pkt hook. Will call bound ip_masq_app specific function&n; *&t;called by ip_fw_demasquerade(), assumes previously checked ms!=NULL.&n; *&t;returns (new - old) skb-&gt;len diff.&n; */
DECL|function|ip_masq_app_pkt_in
r_int
id|ip_masq_app_pkt_in
c_func
(paren
r_struct
id|ip_masq
op_star
id|ms
comma
r_struct
id|sk_buff
op_star
op_star
id|skb_p
comma
r_struct
id|device
op_star
id|dev
)paren
(brace
r_struct
id|ip_masq_app
op_star
id|mapp
suffix:semicolon
r_struct
id|iphdr
op_star
id|iph
suffix:semicolon
r_struct
id|tcphdr
op_star
id|th
suffix:semicolon
r_int
id|diff
suffix:semicolon
id|__u32
id|seq
suffix:semicolon
multiline_comment|/*&n;         *&t;check if application masquerading is bound to&n;         *&t;this ip_masq.&n;         *&t;assumes that once an ip_masq is bound,&n;         *&t;it will not be unbound during its life.&n;         */
r_if
c_cond
(paren
(paren
id|mapp
op_assign
id|ms-&gt;app
)paren
op_eq
l_int|NULL
)paren
r_return
l_int|0
suffix:semicolon
id|iph
op_assign
(paren
op_star
id|skb_p
)paren
op_member_access_from_pointer
id|h.iph
suffix:semicolon
id|th
op_assign
(paren
r_struct
id|tcphdr
op_star
)paren
op_amp
(paren
(paren
(paren
r_char
op_star
)paren
id|iph
)paren
(braket
id|iph-&gt;ihl
op_star
l_int|4
)braket
)paren
suffix:semicolon
multiline_comment|/*&n;         *&t;Remember seq number in case this pkt gets resized&n;         */
id|seq
op_assign
id|ntohl
c_func
(paren
id|th-&gt;seq
)paren
suffix:semicolon
multiline_comment|/*&n;         *&t;Fix seq stuff if flagged as so.&n;         */
r_if
c_cond
(paren
id|ms-&gt;protocol
op_eq
id|IPPROTO_TCP
)paren
(brace
r_if
c_cond
(paren
id|ms-&gt;flags
op_amp
id|IP_MASQ_F_IN_SEQ
)paren
id|masq_fix_seq
c_func
(paren
op_amp
id|ms-&gt;in_seq
comma
id|th
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ms-&gt;flags
op_amp
id|IP_MASQ_F_OUT_SEQ
)paren
id|masq_fix_ack_seq
c_func
(paren
op_amp
id|ms-&gt;out_seq
comma
id|th
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;         *&t;Call private input hook function &n;         */
r_if
c_cond
(paren
id|mapp-&gt;pkt_in
op_eq
l_int|NULL
)paren
r_return
l_int|0
suffix:semicolon
id|diff
op_assign
id|mapp
op_member_access_from_pointer
id|pkt_in
c_func
(paren
id|mapp
comma
id|ms
comma
id|skb_p
comma
id|dev
)paren
suffix:semicolon
multiline_comment|/*&n;         *&t;Update ip_masq seq stuff if len has changed.&n;         */
r_if
c_cond
(paren
id|diff
op_ne
l_int|0
op_logical_and
id|ms-&gt;protocol
op_eq
id|IPPROTO_TCP
)paren
id|masq_seq_update
c_func
(paren
id|ms
comma
op_amp
id|ms-&gt;in_seq
comma
id|IP_MASQ_F_IN_SEQ
comma
id|seq
comma
id|diff
)paren
suffix:semicolon
r_return
id|diff
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;/proc/ip_masq_app entry function&n; */
DECL|function|ip_masq_app_getinfo
r_int
id|ip_masq_app_getinfo
c_func
(paren
r_char
op_star
id|buffer
comma
r_char
op_star
op_star
id|start
comma
id|off_t
id|offset
comma
r_int
id|length
comma
r_int
id|dummy
)paren
(brace
id|off_t
id|pos
op_assign
l_int|0
comma
id|begin
op_assign
l_int|0
suffix:semicolon
r_int
id|len
op_assign
l_int|0
suffix:semicolon
r_struct
id|ip_masq_app
op_star
id|mapp
suffix:semicolon
r_int
id|idx
suffix:semicolon
r_if
c_cond
(paren
id|offset
OL
l_int|40
)paren
id|len
op_assign
id|sprintf
c_func
(paren
id|buffer
comma
l_string|&quot;%-39s&bslash;n&quot;
comma
l_string|&quot;prot port    n_attach name&quot;
)paren
suffix:semicolon
id|pos
op_assign
l_int|40
suffix:semicolon
r_for
c_loop
(paren
id|idx
op_assign
l_int|0
suffix:semicolon
id|idx
OL
id|IP_MASQ_APP_TAB_SIZE
suffix:semicolon
id|idx
op_increment
)paren
r_for
c_loop
(paren
id|mapp
op_assign
id|ip_masq_app_base
(braket
id|idx
)braket
suffix:semicolon
id|mapp
suffix:semicolon
id|mapp
op_assign
id|mapp-&gt;next
)paren
(brace
multiline_comment|/* &n;&t;&t;&t; * If you change the length of this sprintf, then all&n;&t;&t;&t; * the length calculations need fixing too!&n;&t;&t;&t; * Line length = 40 (3 + 2 + 7 + 1 + 7 + 1 + 2 + 17)&n;&t;&t;&t; */
id|pos
op_add_assign
l_int|40
suffix:semicolon
r_if
c_cond
(paren
id|pos
OL
id|offset
)paren
r_continue
suffix:semicolon
id|len
op_add_assign
id|sprintf
c_func
(paren
id|buffer
op_plus
id|len
comma
l_string|&quot;%-3s  %-7u %-7d  %-17s&bslash;n&quot;
comma
id|masq_proto_name
c_func
(paren
id|IP_MASQ_APP_PROTO
c_func
(paren
id|mapp-&gt;type
)paren
)paren
comma
id|IP_MASQ_APP_PORT
c_func
(paren
id|mapp-&gt;type
)paren
comma
id|mapp-&gt;n_attach
comma
id|mapp-&gt;name
)paren
suffix:semicolon
r_if
c_cond
(paren
id|len
op_ge
id|length
)paren
(brace
r_goto
id|done
suffix:semicolon
)brace
)brace
id|done
suffix:colon
id|begin
op_assign
id|len
op_minus
(paren
id|pos
op_minus
id|offset
)paren
suffix:semicolon
op_star
id|start
op_assign
id|buffer
op_plus
id|begin
suffix:semicolon
id|len
op_sub_assign
id|begin
suffix:semicolon
r_if
c_cond
(paren
id|len
OG
id|length
)paren
id|len
op_assign
id|length
suffix:semicolon
r_return
id|len
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;Initialization routine&n; */
DECL|function|ip_masq_app_init
r_int
id|ip_masq_app_init
c_func
(paren
r_void
)paren
(brace
id|register_symtab
(paren
op_amp
id|ip_masq_app_syms
)paren
suffix:semicolon
macro_line|#ifdef CONFIG_PROC_FS        
id|proc_net_register
c_func
(paren
op_amp
(paren
r_struct
id|proc_dir_entry
)paren
(brace
id|PROC_NET_IP_MASQ_APP
comma
l_int|11
comma
l_string|&quot;ip_masq_app&quot;
comma
id|S_IFREG
op_or
id|S_IRUGO
comma
l_int|1
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
op_amp
id|proc_net_inode_operations
comma
id|ip_masq_app_getinfo
)brace
)paren
suffix:semicolon
macro_line|#endif        
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;Replace a segment (of skb-&gt;data) with a new one.&n; *&t;FIXME: Should re-use same skb if space available, this could&n; *&t;       be done if n_len &lt; o_len, unless some extra space&n; *&t;       were already allocated at driver level :P .&n; */
DECL|function|skb_replace
r_static
r_struct
id|sk_buff
op_star
id|skb_replace
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_int
id|pri
comma
r_char
op_star
id|o_buf
comma
r_int
id|o_len
comma
r_char
op_star
id|n_buf
comma
r_int
id|n_len
)paren
(brace
r_int
id|maxsize
comma
id|diff
comma
id|o_offset
suffix:semicolon
r_struct
id|sk_buff
op_star
id|n_skb
suffix:semicolon
id|maxsize
op_assign
id|skb-&gt;truesize
op_minus
r_sizeof
(paren
r_struct
id|sk_buff
)paren
suffix:semicolon
id|diff
op_assign
id|n_len
op_minus
id|o_len
suffix:semicolon
id|o_offset
op_assign
id|o_buf
op_minus
(paren
r_char
op_star
)paren
id|skb-&gt;data
suffix:semicolon
r_if
c_cond
(paren
id|maxsize
op_le
id|n_len
)paren
(brace
r_if
c_cond
(paren
id|diff
op_ne
l_int|0
)paren
(brace
id|memcpy
c_func
(paren
id|skb-&gt;data
op_plus
id|o_offset
op_plus
id|n_len
comma
id|o_buf
op_plus
id|o_len
comma
id|skb-&gt;len
op_minus
(paren
id|o_offset
op_plus
id|o_len
)paren
)paren
suffix:semicolon
)brace
id|memcpy
c_func
(paren
id|skb-&gt;data
op_plus
id|o_offset
comma
id|n_buf
comma
id|n_len
)paren
suffix:semicolon
id|n_skb
op_assign
id|skb
suffix:semicolon
id|skb-&gt;len
op_assign
id|n_len
suffix:semicolon
id|skb-&gt;end
op_assign
id|skb-&gt;head
op_plus
id|n_len
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/*&n;                 * &t;Sizes differ, make a copy&n;                 */
id|n_skb
op_assign
id|alloc_skb
c_func
(paren
id|MAX_HEADER
op_plus
id|skb-&gt;len
op_plus
id|diff
comma
id|pri
)paren
suffix:semicolon
r_if
c_cond
(paren
id|n_skb
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;skb_replace(): no room left (from %p)&bslash;n&quot;
comma
id|__builtin_return_address
c_func
(paren
l_int|0
)paren
)paren
suffix:semicolon
r_return
id|skb
suffix:semicolon
)brace
id|n_skb-&gt;free
op_assign
id|skb-&gt;free
suffix:semicolon
id|skb_reserve
c_func
(paren
id|n_skb
comma
id|MAX_HEADER
)paren
suffix:semicolon
id|skb_put
c_func
(paren
id|n_skb
comma
id|skb-&gt;len
op_plus
id|diff
)paren
suffix:semicolon
id|n_skb-&gt;h.raw
op_assign
id|n_skb-&gt;data
op_plus
(paren
id|skb-&gt;h.raw
op_minus
id|skb-&gt;data
)paren
suffix:semicolon
multiline_comment|/*&n;                 * Copy pkt in new buffer&n;                 */
id|memcpy
c_func
(paren
id|n_skb-&gt;data
comma
id|skb-&gt;data
comma
id|o_offset
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|n_skb-&gt;data
op_plus
id|o_offset
comma
id|n_buf
comma
id|n_len
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|n_skb-&gt;data
op_plus
id|o_offset
op_plus
id|n_len
comma
id|o_buf
op_plus
id|o_len
comma
id|skb-&gt;len
op_minus
(paren
id|o_offset
op_plus
id|o_len
)paren
)paren
suffix:semicolon
multiline_comment|/*&n;                 * Problem, how to replace the new skb with old one,&n;                 * preferably inplace&n;                 */
id|kfree_skb
c_func
(paren
id|skb
comma
id|FREE_WRITE
)paren
suffix:semicolon
)brace
r_return
id|n_skb
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;calls skb_replace() and update ip header if new skb was allocated&n; */
DECL|function|ip_masq_skb_replace
r_struct
id|sk_buff
op_star
id|ip_masq_skb_replace
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_int
id|pri
comma
r_char
op_star
id|o_buf
comma
r_int
id|o_len
comma
r_char
op_star
id|n_buf
comma
r_int
id|n_len
)paren
(brace
r_int
id|diff
suffix:semicolon
r_struct
id|sk_buff
op_star
id|n_skb
suffix:semicolon
r_int
id|skb_len
suffix:semicolon
id|diff
op_assign
id|n_len
op_minus
id|o_len
suffix:semicolon
id|n_skb
op_assign
id|skb_replace
c_func
(paren
id|skb
comma
id|pri
comma
id|o_buf
comma
id|o_len
comma
id|n_buf
comma
id|n_len
)paren
suffix:semicolon
id|skb_len
op_assign
id|skb-&gt;len
suffix:semicolon
r_if
c_cond
(paren
id|diff
)paren
(brace
r_struct
id|iphdr
op_star
id|iph
suffix:semicolon
macro_line|#if DEBUG_CONFIG_IP_MASQ_APP
id|printk
c_func
(paren
l_string|&quot;masq_skb_replace(): pkt resized for %d bytes (len=%ld)&bslash;n&quot;
comma
id|diff
comma
id|skb-&gt;len
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/*&n;                 * &t;update ip header&n;                 */
id|iph
op_assign
id|n_skb-&gt;h.iph
suffix:semicolon
id|iph-&gt;check
op_assign
l_int|0
suffix:semicolon
id|iph-&gt;check
op_assign
id|ip_fast_csum
c_func
(paren
(paren
r_int
r_char
op_star
)paren
id|iph
comma
id|iph-&gt;ihl
)paren
suffix:semicolon
id|iph-&gt;tot_len
op_assign
id|htons
c_func
(paren
id|skb_len
op_plus
id|diff
)paren
suffix:semicolon
)brace
r_return
id|n_skb
suffix:semicolon
)brace
eof
