multiline_comment|/*&n; *&t;&t;IP_MASQ_QUAKE quake masquerading module&n; *&n; *&n; * Version:&t;@(#)ip_masq_quake.c 0.02   22/02/97&n; *&n; * Author:&t;Harald Hoyer mailto:HarryH@Royal.Net&n; *&t;&t;&n; *&n; * Fixes: &n; *      Harald Hoyer            :       Unofficial Quake Specs found at &n; *                                 http://www.gamers.org/dEngine/quake/spec/ &n; *      Harald Hoyer            :       Check for QUAKE-STRING&n; *&n; *&t;This program is free software; you can redistribute it and/or&n; *&t;modify it under the terms of the GNU General Public License&n; *&t;as published by the Free Software Foundation; either version&n; *&t;2 of the License, or (at your option) any later version.&n; *  &n; *  &n; */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;asm/system.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/skbuff.h&gt;
macro_line|#include &lt;linux/in.h&gt;
macro_line|#include &lt;linux/ip.h&gt;
macro_line|#include &lt;net/protocol.h&gt;
macro_line|#include &lt;net/udp.h&gt;
macro_line|#include &lt;net/ip_masq.h&gt;
DECL|macro|DEBUG_CONFIG_IP_MASQ_QUAKE
mdefine_line|#define DEBUG_CONFIG_IP_MASQ_QUAKE 0
r_typedef
r_struct
(brace
DECL|member|type
id|__u16
id|type
suffix:semicolon
singleline_comment|// (Little Endian) Type of message.
DECL|member|length
id|__u16
id|length
suffix:semicolon
singleline_comment|// (Little Endian) Length of message, header included. 
DECL|member|message
r_char
id|message
(braket
l_int|0
)braket
suffix:semicolon
singleline_comment|// The contents of the message.
DECL|typedef|QUAKEHEADER
)brace
id|QUAKEHEADER
suffix:semicolon
DECL|struct|quake_priv_data
r_struct
id|quake_priv_data
(brace
multiline_comment|/* Have we seen a client connect message */
DECL|member|cl_connect
r_char
id|cl_connect
suffix:semicolon
)brace
suffix:semicolon
r_static
r_int
DECL|function|masq_quake_init_1
id|masq_quake_init_1
(paren
r_struct
id|ip_masq_app
op_star
id|mapp
comma
r_struct
id|ip_masq
op_star
id|ms
)paren
(brace
id|MOD_INC_USE_COUNT
suffix:semicolon
r_if
c_cond
(paren
(paren
id|ms-&gt;app_data
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|quake_priv_data
)paren
comma
id|GFP_ATOMIC
)paren
)paren
op_eq
l_int|NULL
)paren
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;Quake: No memory for application data&bslash;n&quot;
)paren
suffix:semicolon
r_else
(brace
r_struct
id|quake_priv_data
op_star
id|priv
op_assign
(paren
r_struct
id|quake_priv_data
op_star
)paren
id|ms-&gt;app_data
suffix:semicolon
id|priv-&gt;cl_connect
op_assign
l_int|0
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_int
DECL|function|masq_quake_done_1
id|masq_quake_done_1
(paren
r_struct
id|ip_masq_app
op_star
id|mapp
comma
r_struct
id|ip_masq
op_star
id|ms
)paren
(brace
id|MOD_DEC_USE_COUNT
suffix:semicolon
r_if
c_cond
(paren
id|ms-&gt;app_data
)paren
id|kfree_s
c_func
(paren
id|ms-&gt;app_data
comma
r_sizeof
(paren
r_struct
id|quake_priv_data
)paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_int
DECL|function|masq_quake_in
id|masq_quake_in
(paren
r_struct
id|ip_masq_app
op_star
id|mapp
comma
r_struct
id|ip_masq
op_star
id|ms
comma
r_struct
id|sk_buff
op_star
op_star
id|skb_p
comma
r_struct
id|device
op_star
id|dev
)paren
(brace
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
r_struct
id|iphdr
op_star
id|iph
suffix:semicolon
r_struct
id|udphdr
op_star
id|uh
suffix:semicolon
id|QUAKEHEADER
op_star
id|qh
suffix:semicolon
id|__u16
id|udp_port
suffix:semicolon
r_char
op_star
id|data
suffix:semicolon
r_int
r_char
id|code
suffix:semicolon
r_struct
id|quake_priv_data
op_star
id|priv
op_assign
(paren
r_struct
id|quake_priv_data
op_star
)paren
id|ms-&gt;app_data
suffix:semicolon
r_if
c_cond
(paren
id|priv-&gt;cl_connect
op_eq
op_minus
l_int|1
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
id|skb
op_assign
op_star
id|skb_p
suffix:semicolon
id|iph
op_assign
id|skb-&gt;nh.iph
suffix:semicolon
id|uh
op_assign
(paren
r_struct
id|udphdr
op_star
)paren
op_amp
(paren
(paren
(paren
r_char
op_star
)paren
id|iph
)paren
(braket
id|iph-&gt;ihl
op_star
l_int|4
)braket
)paren
suffix:semicolon
multiline_comment|/* Check for lenght */
r_if
c_cond
(paren
id|ntohs
c_func
(paren
id|uh-&gt;len
)paren
OL
l_int|5
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
id|qh
op_assign
(paren
id|QUAKEHEADER
op_star
)paren
op_amp
id|uh
(braket
l_int|1
)braket
suffix:semicolon
r_if
c_cond
(paren
id|qh-&gt;type
op_ne
l_int|0x0080
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
id|code
op_assign
id|qh-&gt;message
(braket
l_int|0
)braket
suffix:semicolon
macro_line|#if DEBUG_CONFIG_IP_MASQ_QUAKE
id|printk
c_func
(paren
l_string|&quot;Quake_in: code = %d &bslash;n&quot;
comma
(paren
r_int
)paren
id|code
)paren
suffix:semicolon
macro_line|#endif
r_switch
c_cond
(paren
id|code
)paren
(brace
r_case
l_int|0x01
suffix:colon
multiline_comment|/* Connection Request */
r_if
c_cond
(paren
id|ntohs
c_func
(paren
id|qh-&gt;length
)paren
OL
l_int|0x0c
)paren
(brace
macro_line|#if DEBUG_CONFIG_IP_MASQ_QUAKE
id|printk
c_func
(paren
l_string|&quot;Quake_in: length &lt; 0xc &bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
r_return
l_int|0
suffix:semicolon
)brace
id|data
op_assign
op_amp
id|qh-&gt;message
(braket
l_int|1
)braket
suffix:semicolon
multiline_comment|/* Check for stomping string */
r_if
c_cond
(paren
id|memcmp
c_func
(paren
id|data
comma
l_string|&quot;QUAKE&bslash;0&bslash;3&quot;
comma
l_int|7
)paren
)paren
(brace
macro_line|#if DEBUG_CONFIG_IP_MASQ_QUAKE
id|printk
c_func
(paren
l_string|&quot;Quake_out: memcmp failed &bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
r_return
l_int|0
suffix:semicolon
)brace
r_else
(brace
id|priv-&gt;cl_connect
op_assign
l_int|1
suffix:semicolon
macro_line|#if DEBUG_CONFIG_IP_MASQ_QUAKE
id|printk
c_func
(paren
l_string|&quot;Quake_out: memcmp ok &bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
)brace
r_break
suffix:semicolon
r_case
l_int|0x81
suffix:colon
multiline_comment|/* Accept Connection */
r_if
c_cond
(paren
(paren
id|ntohs
c_func
(paren
id|qh-&gt;length
)paren
OL
l_int|0x09
)paren
op_logical_or
(paren
id|priv-&gt;cl_connect
op_eq
l_int|0
)paren
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
id|data
op_assign
op_amp
id|qh-&gt;message
(braket
l_int|1
)braket
suffix:semicolon
id|memcpy
c_func
(paren
op_amp
id|udp_port
comma
id|data
comma
l_int|2
)paren
suffix:semicolon
id|ms-&gt;dport
op_assign
id|htons
c_func
(paren
id|udp_port
)paren
suffix:semicolon
macro_line|#if DEBUG_CONFIG_IP_MASQ_QUAKE
id|printk
c_func
(paren
l_string|&quot;Quake_in: in_rewrote UDP port %d &bslash;n&quot;
comma
id|udp_port
)paren
suffix:semicolon
macro_line|#endif
id|priv-&gt;cl_connect
op_assign
op_minus
l_int|1
suffix:semicolon
r_break
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
r_int
DECL|function|masq_quake_out
id|masq_quake_out
(paren
r_struct
id|ip_masq_app
op_star
id|mapp
comma
r_struct
id|ip_masq
op_star
id|ms
comma
r_struct
id|sk_buff
op_star
op_star
id|skb_p
comma
r_struct
id|device
op_star
id|dev
)paren
(brace
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
r_struct
id|iphdr
op_star
id|iph
suffix:semicolon
r_struct
id|udphdr
op_star
id|uh
suffix:semicolon
id|QUAKEHEADER
op_star
id|qh
suffix:semicolon
id|__u16
id|udp_port
suffix:semicolon
r_char
op_star
id|data
suffix:semicolon
r_int
r_char
id|code
suffix:semicolon
r_struct
id|ip_masq
op_star
id|n_ms
suffix:semicolon
r_struct
id|quake_priv_data
op_star
id|priv
op_assign
(paren
r_struct
id|quake_priv_data
op_star
)paren
id|ms-&gt;app_data
suffix:semicolon
r_if
c_cond
(paren
id|priv-&gt;cl_connect
op_eq
op_minus
l_int|1
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
id|skb
op_assign
op_star
id|skb_p
suffix:semicolon
id|iph
op_assign
id|skb-&gt;nh.iph
suffix:semicolon
id|uh
op_assign
(paren
r_struct
id|udphdr
op_star
)paren
op_amp
(paren
(paren
(paren
r_char
op_star
)paren
id|iph
)paren
(braket
id|iph-&gt;ihl
op_star
l_int|4
)braket
)paren
suffix:semicolon
multiline_comment|/* Check for lenght */
r_if
c_cond
(paren
id|ntohs
c_func
(paren
id|uh-&gt;len
)paren
OL
l_int|5
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
id|qh
op_assign
(paren
id|QUAKEHEADER
op_star
)paren
op_amp
id|uh
(braket
l_int|1
)braket
suffix:semicolon
macro_line|#if DEBUG_CONFIG_IP_MASQ_QUAKE
id|printk
c_func
(paren
l_string|&quot;Quake_out: qh-&gt;type = %d &bslash;n&quot;
comma
(paren
r_int
)paren
id|qh-&gt;type
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|qh-&gt;type
op_ne
l_int|0x0080
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
id|code
op_assign
id|qh-&gt;message
(braket
l_int|0
)braket
suffix:semicolon
macro_line|#if DEBUG_CONFIG_IP_MASQ_QUAKE
id|printk
c_func
(paren
l_string|&quot;Quake_out: code = %d &bslash;n&quot;
comma
(paren
r_int
)paren
id|code
)paren
suffix:semicolon
macro_line|#endif
r_switch
c_cond
(paren
id|code
)paren
(brace
r_case
l_int|0x01
suffix:colon
multiline_comment|/* Connection Request */
r_if
c_cond
(paren
id|ntohs
c_func
(paren
id|qh-&gt;length
)paren
OL
l_int|0x0c
)paren
(brace
macro_line|#if DEBUG_CONFIG_IP_MASQ_QUAKE
id|printk
c_func
(paren
l_string|&quot;Quake_out: length &lt; 0xc &bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
r_return
l_int|0
suffix:semicolon
)brace
id|data
op_assign
op_amp
id|qh-&gt;message
(braket
l_int|1
)braket
suffix:semicolon
multiline_comment|/* Check for stomping string */
r_if
c_cond
(paren
id|memcmp
c_func
(paren
id|data
comma
l_string|&quot;QUAKE&bslash;0&bslash;3&quot;
comma
l_int|7
)paren
)paren
(brace
macro_line|#if DEBUG_CONFIG_IP_MASQ_QUAKE
id|printk
c_func
(paren
l_string|&quot;Quake_out: memcmp failed &bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
r_return
l_int|0
suffix:semicolon
)brace
r_else
(brace
id|priv-&gt;cl_connect
op_assign
l_int|1
suffix:semicolon
macro_line|#if DEBUG_CONFIG_IP_MASQ_QUAKE
id|printk
c_func
(paren
l_string|&quot;Quake_out: memcmp ok &bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
)brace
r_break
suffix:semicolon
r_case
l_int|0x81
suffix:colon
multiline_comment|/* Accept Connection */
r_if
c_cond
(paren
(paren
id|ntohs
c_func
(paren
id|qh-&gt;length
)paren
OL
l_int|0x09
)paren
op_logical_or
(paren
id|priv-&gt;cl_connect
op_eq
l_int|0
)paren
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
id|data
op_assign
op_amp
id|qh-&gt;message
(braket
l_int|1
)braket
suffix:semicolon
id|memcpy
c_func
(paren
op_amp
id|udp_port
comma
id|data
comma
l_int|2
)paren
suffix:semicolon
id|n_ms
op_assign
id|ip_masq_new
c_func
(paren
id|dev
comma
id|IPPROTO_UDP
comma
id|ms-&gt;saddr
comma
id|htons
c_func
(paren
id|udp_port
)paren
comma
id|ms-&gt;daddr
comma
id|ms-&gt;dport
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|n_ms
op_eq
l_int|NULL
)paren
r_return
l_int|0
suffix:semicolon
macro_line|#if DEBUG_CONFIG_IP_MASQ_QUAKE
id|printk
c_func
(paren
l_string|&quot;Quake_out: out_rewrote UDP port %d -&gt; %d&bslash;n&quot;
comma
id|udp_port
comma
id|ntohs
c_func
(paren
id|n_ms-&gt;mport
)paren
)paren
suffix:semicolon
macro_line|#endif
id|udp_port
op_assign
id|ntohs
c_func
(paren
id|n_ms-&gt;mport
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|data
comma
op_amp
id|udp_port
comma
l_int|2
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|variable|ip_masq_quake
r_struct
id|ip_masq_app
id|ip_masq_quake
op_assign
(brace
l_int|NULL
comma
multiline_comment|/* next */
l_string|&quot;Quake_26&quot;
comma
multiline_comment|/* name */
l_int|0
comma
multiline_comment|/* type */
l_int|0
comma
multiline_comment|/* n_attach */
id|masq_quake_init_1
comma
multiline_comment|/* ip_masq_init_1 */
id|masq_quake_done_1
comma
multiline_comment|/* ip_masq_done_1 */
id|masq_quake_out
comma
multiline_comment|/* pkt_out */
id|masq_quake_in
multiline_comment|/* pkt_in */
)brace
suffix:semicolon
DECL|variable|ip_masq_quakenew
r_struct
id|ip_masq_app
id|ip_masq_quakenew
op_assign
(brace
l_int|NULL
comma
multiline_comment|/* next */
l_string|&quot;Quake_27&quot;
comma
multiline_comment|/* name */
l_int|0
comma
multiline_comment|/* type */
l_int|0
comma
multiline_comment|/* n_attach */
id|masq_quake_init_1
comma
multiline_comment|/* ip_masq_init_1 */
id|masq_quake_done_1
comma
multiline_comment|/* ip_masq_done_1 */
id|masq_quake_out
comma
multiline_comment|/* pkt_out */
id|masq_quake_in
multiline_comment|/* pkt_in */
)brace
suffix:semicolon
multiline_comment|/*&n; * &t;ip_masq_quake initialization&n; */
DECL|function|ip_masq_quake_init
r_int
id|ip_masq_quake_init
c_func
(paren
r_void
)paren
(brace
r_return
(paren
id|register_ip_masq_app
c_func
(paren
op_amp
id|ip_masq_quake
comma
id|IPPROTO_UDP
comma
l_int|26000
)paren
op_plus
id|register_ip_masq_app
c_func
(paren
op_amp
id|ip_masq_quakenew
comma
id|IPPROTO_UDP
comma
l_int|27000
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * &t;ip_masq_quake fin.&n; */
DECL|function|ip_masq_quake_done
r_int
id|ip_masq_quake_done
c_func
(paren
r_void
)paren
(brace
r_return
(paren
id|unregister_ip_masq_app
c_func
(paren
op_amp
id|ip_masq_quake
)paren
op_plus
id|unregister_ip_masq_app
c_func
(paren
op_amp
id|ip_masq_quakenew
)paren
)paren
suffix:semicolon
)brace
macro_line|#ifdef MODULE
id|EXPORT_NO_SYMBOLS
suffix:semicolon
DECL|function|init_module
r_int
id|init_module
c_func
(paren
r_void
)paren
(brace
r_if
c_cond
(paren
id|ip_masq_quake_init
c_func
(paren
)paren
op_ne
l_int|0
)paren
r_return
op_minus
id|EIO
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|cleanup_module
r_void
id|cleanup_module
c_func
(paren
r_void
)paren
(brace
r_if
c_cond
(paren
id|ip_masq_quake_done
c_func
(paren
)paren
op_ne
l_int|0
)paren
id|printk
c_func
(paren
l_string|&quot;ip_masq_quake: can&squot;t remove module&quot;
)paren
suffix:semicolon
)brace
macro_line|#endif /* MODULE */
eof
