multiline_comment|/*&n; *&t;&t;IP_MASQ_MOD masq modules support&n; *&n; *&n; * Author:&t;Juan Jose Ciarlante, &lt;jjciarla@raiz.uncu.edu.ar&gt;&n; *&n; * &t;$Id: ip_masq_mod.c,v 1.4 1998/03/27 07:02:45 davem Exp $&n; *&n; *&t;This program is free software; you can redistribute it and/or&n; *&t;modify it under the terms of the GNU General Public License&n; *&t;as published by the Free Software Foundation; either version&n; *&t;2 of the License, or (at your option) any later version.&n; *&n; * Changes:&n; *&t;&t;Cyrus Durgin:&t;&t;fixed kerneld stuff for kmod.&n; */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;net/ip_masq.h&gt;
macro_line|#include &lt;net/ip_masq_mod.h&gt;
macro_line|#ifdef CONFIG_KMOD
macro_line|#include &lt;linux/kmod.h&gt;
macro_line|#endif
DECL|variable|register_ip_masq_mod
id|EXPORT_SYMBOL
c_func
(paren
id|register_ip_masq_mod
)paren
suffix:semicolon
DECL|variable|unregister_ip_masq_mod
id|EXPORT_SYMBOL
c_func
(paren
id|unregister_ip_masq_mod
)paren
suffix:semicolon
DECL|variable|ip_masq_mod_lkp_link
id|EXPORT_SYMBOL
c_func
(paren
id|ip_masq_mod_lkp_link
)paren
suffix:semicolon
DECL|variable|ip_masq_mod_lkp_unlink
id|EXPORT_SYMBOL
c_func
(paren
id|ip_masq_mod_lkp_unlink
)paren
suffix:semicolon
multiline_comment|/*&n; *&t;Base pointer for registered modules&n; */
DECL|variable|ip_masq_mod_reg_base
r_struct
id|ip_masq_mod
op_star
id|ip_masq_mod_reg_base
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/*&n; *&t;Base pointer for lookup (subset of above, a module could be&n; *&t;registered, but it could have no active rule); will avoid&n; *&t;unnecessary lookups.&n; */
DECL|variable|ip_masq_mod_lkp_base
r_struct
id|ip_masq_mod
op_star
id|ip_masq_mod_lkp_base
op_assign
l_int|NULL
suffix:semicolon
DECL|function|ip_masq_mod_register_proc
r_int
id|ip_masq_mod_register_proc
c_func
(paren
r_struct
id|ip_masq_mod
op_star
id|mmod
)paren
(brace
macro_line|#ifdef CONFIG_PROC_FS        
r_int
id|ret
suffix:semicolon
r_struct
id|proc_dir_entry
op_star
id|ent
op_assign
id|mmod-&gt;mmod_proc_ent
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ent
)paren
r_return
l_int|0
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ent-&gt;name
)paren
(brace
id|ent-&gt;name
op_assign
id|mmod-&gt;mmod_name
suffix:semicolon
id|ent-&gt;namelen
op_assign
id|strlen
(paren
id|mmod-&gt;mmod_name
)paren
suffix:semicolon
)brace
id|ret
op_assign
id|proc_net_register
c_func
(paren
id|ent
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
)paren
id|mmod-&gt;mmod_proc_ent
op_assign
l_int|NULL
suffix:semicolon
r_return
id|ret
suffix:semicolon
macro_line|#else
r_return
l_int|0
suffix:semicolon
macro_line|#endif
)brace
DECL|function|ip_masq_mod_unregister_proc
r_void
id|ip_masq_mod_unregister_proc
c_func
(paren
r_struct
id|ip_masq_mod
op_star
id|mmod
)paren
(brace
macro_line|#ifdef CONFIG_PROC_FS        
r_struct
id|proc_dir_entry
op_star
id|ent
op_assign
id|mmod-&gt;mmod_proc_ent
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ent
)paren
r_return
suffix:semicolon
id|proc_unregister
c_func
(paren
id|proc_net
comma
id|ent-&gt;low_ino
)paren
suffix:semicolon
macro_line|#endif
)brace
multiline_comment|/*&n; *&t;Link/unlink object for lookups&n; */
DECL|function|ip_masq_mod_lkp_unlink
r_int
id|ip_masq_mod_lkp_unlink
c_func
(paren
r_struct
id|ip_masq_mod
op_star
id|mmod
)paren
(brace
r_struct
id|ip_masq_mod
op_star
op_star
id|mmod_p
suffix:semicolon
id|start_bh_atomic
c_func
(paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|mmod_p
op_assign
op_amp
id|ip_masq_mod_lkp_base
suffix:semicolon
op_star
id|mmod_p
suffix:semicolon
id|mmod_p
op_assign
op_amp
(paren
op_star
id|mmod_p
)paren
op_member_access_from_pointer
id|next
)paren
r_if
c_cond
(paren
id|mmod
op_eq
(paren
op_star
id|mmod_p
)paren
)paren
(brace
op_star
id|mmod_p
op_assign
id|mmod-&gt;next
suffix:semicolon
id|mmod-&gt;next
op_assign
l_int|NULL
suffix:semicolon
id|end_bh_atomic
c_func
(paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|end_bh_atomic
c_func
(paren
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
DECL|function|ip_masq_mod_lkp_link
r_int
id|ip_masq_mod_lkp_link
c_func
(paren
r_struct
id|ip_masq_mod
op_star
id|mmod
)paren
(brace
id|start_bh_atomic
c_func
(paren
)paren
suffix:semicolon
id|mmod-&gt;next
op_assign
id|ip_masq_mod_lkp_base
suffix:semicolon
id|ip_masq_mod_lkp_base
op_assign
id|mmod
suffix:semicolon
id|end_bh_atomic
c_func
(paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|register_ip_masq_mod
r_int
id|register_ip_masq_mod
c_func
(paren
r_struct
id|ip_masq_mod
op_star
id|mmod
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|mmod
)paren
(brace
id|IP_MASQ_ERR
c_func
(paren
l_string|&quot;register_ip_masq_mod(): NULL arg&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|mmod-&gt;mmod_name
)paren
(brace
id|IP_MASQ_ERR
c_func
(paren
l_string|&quot;register_ip_masq_mod(): NULL mmod_name&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|ip_masq_mod_register_proc
c_func
(paren
id|mmod
)paren
suffix:semicolon
id|mmod-&gt;next_reg
op_assign
id|ip_masq_mod_reg_base
suffix:semicolon
id|ip_masq_mod_reg_base
op_assign
id|mmod
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|unregister_ip_masq_mod
r_int
id|unregister_ip_masq_mod
c_func
(paren
r_struct
id|ip_masq_mod
op_star
id|mmod
)paren
(brace
r_struct
id|ip_masq_mod
op_star
op_star
id|mmod_p
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|mmod
)paren
(brace
id|IP_MASQ_ERR
c_func
(paren
l_string|&quot;unregister_ip_masq_mod(): NULL arg&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * &t;Only allow unregistration if it is not referenced&n;&t; */
r_if
c_cond
(paren
id|atomic_read
c_func
(paren
op_amp
id|mmod-&gt;refcnt
)paren
)paren
(brace
id|IP_MASQ_ERR
c_func
(paren
l_string|&quot;unregister_ip_masq_mod(): is in use by %d guys. failed&bslash;n&quot;
comma
id|atomic_read
c_func
(paren
op_amp
id|mmod-&gt;refcnt
)paren
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
multiline_comment|/*&t;&n;&t; *&t;Must be already unlinked from lookup list&n;&t; */
r_if
c_cond
(paren
id|mmod-&gt;next
)paren
(brace
id|IP_MASQ_WARNING
c_func
(paren
l_string|&quot;MASQ: unregistering &bslash;&quot;%s&bslash;&quot; while in lookup list.fixed.&quot;
comma
id|mmod-&gt;mmod_name
)paren
suffix:semicolon
id|ip_masq_mod_lkp_unlink
c_func
(paren
id|mmod
)paren
suffix:semicolon
)brace
r_for
c_loop
(paren
id|mmod_p
op_assign
op_amp
id|ip_masq_mod_reg_base
suffix:semicolon
op_star
id|mmod_p
suffix:semicolon
id|mmod_p
op_assign
op_amp
(paren
op_star
id|mmod_p
)paren
op_member_access_from_pointer
id|next_reg
)paren
r_if
c_cond
(paren
id|mmod
op_eq
(paren
op_star
id|mmod_p
)paren
)paren
(brace
id|ip_masq_mod_unregister_proc
c_func
(paren
id|mmod
)paren
suffix:semicolon
op_star
id|mmod_p
op_assign
id|mmod-&gt;next_reg
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|IP_MASQ_ERR
c_func
(paren
l_string|&quot;unregister_ip_masq_mod(%s): not linked &bslash;n&quot;
comma
id|mmod-&gt;mmod_name
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
DECL|function|ip_masq_mod_in_rule
r_int
id|ip_masq_mod_in_rule
c_func
(paren
r_struct
id|iphdr
op_star
id|iph
comma
id|__u16
op_star
id|portp
)paren
(brace
r_struct
id|ip_masq_mod
op_star
id|mmod
suffix:semicolon
r_int
id|ret
suffix:semicolon
r_for
c_loop
(paren
id|mmod
op_assign
id|ip_masq_mod_lkp_base
suffix:semicolon
id|mmod
suffix:semicolon
id|mmod
op_assign
id|mmod-&gt;next
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|mmod-&gt;mmod_in_rule
)paren
r_continue
suffix:semicolon
r_switch
c_cond
(paren
id|ret
op_assign
id|mmod
op_member_access_from_pointer
id|mmod_in_rule
c_func
(paren
id|iph
comma
id|portp
)paren
)paren
(brace
r_case
id|IP_MASQ_MOD_NOP
suffix:colon
r_continue
suffix:semicolon
r_case
id|IP_MASQ_MOD_ACCEPT
suffix:colon
r_return
l_int|1
suffix:semicolon
r_case
id|IP_MASQ_MOD_REJECT
suffix:colon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|ip_masq_mod_out_rule
r_int
id|ip_masq_mod_out_rule
c_func
(paren
r_struct
id|iphdr
op_star
id|iph
comma
id|__u16
op_star
id|portp
)paren
(brace
r_struct
id|ip_masq_mod
op_star
id|mmod
suffix:semicolon
r_int
id|ret
suffix:semicolon
r_for
c_loop
(paren
id|mmod
op_assign
id|ip_masq_mod_lkp_base
suffix:semicolon
id|mmod
suffix:semicolon
id|mmod
op_assign
id|mmod-&gt;next
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|mmod-&gt;mmod_out_rule
)paren
r_continue
suffix:semicolon
r_switch
c_cond
(paren
id|ret
op_assign
id|mmod
op_member_access_from_pointer
id|mmod_out_rule
c_func
(paren
id|iph
comma
id|portp
)paren
)paren
(brace
r_case
id|IP_MASQ_MOD_NOP
suffix:colon
r_continue
suffix:semicolon
r_case
id|IP_MASQ_MOD_ACCEPT
suffix:colon
r_return
l_int|1
suffix:semicolon
r_case
id|IP_MASQ_MOD_REJECT
suffix:colon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|ip_masq_mod_in_create
r_struct
id|ip_masq
op_star
id|ip_masq_mod_in_create
c_func
(paren
r_struct
id|iphdr
op_star
id|iph
comma
id|__u16
op_star
id|portp
comma
id|__u32
id|maddr
)paren
(brace
r_struct
id|ip_masq_mod
op_star
id|mmod
suffix:semicolon
r_struct
id|ip_masq
op_star
id|ms
suffix:semicolon
r_for
c_loop
(paren
id|mmod
op_assign
id|ip_masq_mod_lkp_base
suffix:semicolon
id|mmod
suffix:semicolon
id|mmod
op_assign
id|mmod-&gt;next
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|mmod-&gt;mmod_in_create
)paren
r_continue
suffix:semicolon
r_if
c_cond
(paren
(paren
id|ms
op_assign
id|mmod
op_member_access_from_pointer
id|mmod_in_create
c_func
(paren
id|iph
comma
id|portp
comma
id|maddr
)paren
)paren
)paren
(brace
r_return
id|ms
suffix:semicolon
)brace
)brace
r_return
l_int|NULL
suffix:semicolon
)brace
DECL|function|ip_masq_mod_out_create
r_struct
id|ip_masq
op_star
id|ip_masq_mod_out_create
c_func
(paren
r_struct
id|iphdr
op_star
id|iph
comma
id|__u16
op_star
id|portp
comma
id|__u32
id|maddr
)paren
(brace
r_struct
id|ip_masq_mod
op_star
id|mmod
suffix:semicolon
r_struct
id|ip_masq
op_star
id|ms
suffix:semicolon
r_for
c_loop
(paren
id|mmod
op_assign
id|ip_masq_mod_lkp_base
suffix:semicolon
id|mmod
suffix:semicolon
id|mmod
op_assign
id|mmod-&gt;next
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|mmod-&gt;mmod_out_create
)paren
r_continue
suffix:semicolon
r_if
c_cond
(paren
(paren
id|ms
op_assign
id|mmod
op_member_access_from_pointer
id|mmod_out_create
c_func
(paren
id|iph
comma
id|portp
comma
id|maddr
)paren
)paren
)paren
(brace
r_return
id|ms
suffix:semicolon
)brace
)brace
r_return
l_int|NULL
suffix:semicolon
)brace
DECL|function|ip_masq_mod_in_update
r_int
id|ip_masq_mod_in_update
c_func
(paren
r_struct
id|iphdr
op_star
id|iph
comma
id|__u16
op_star
id|portp
comma
r_struct
id|ip_masq
op_star
id|ms
)paren
(brace
r_struct
id|ip_masq_mod
op_star
id|mmod
suffix:semicolon
r_int
id|ret
suffix:semicolon
r_for
c_loop
(paren
id|mmod
op_assign
id|ip_masq_mod_lkp_base
suffix:semicolon
id|mmod
suffix:semicolon
id|mmod
op_assign
id|mmod-&gt;next
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|mmod-&gt;mmod_in_update
)paren
r_continue
suffix:semicolon
r_switch
c_cond
(paren
id|ret
op_assign
id|mmod
op_member_access_from_pointer
id|mmod_in_update
c_func
(paren
id|iph
comma
id|ms
)paren
)paren
(brace
r_case
id|IP_MASQ_MOD_NOP
suffix:colon
r_continue
suffix:semicolon
r_case
id|IP_MASQ_MOD_ACCEPT
suffix:colon
r_return
l_int|1
suffix:semicolon
r_case
id|IP_MASQ_MOD_REJECT
suffix:colon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|ip_masq_mod_out_update
r_int
id|ip_masq_mod_out_update
c_func
(paren
r_struct
id|iphdr
op_star
id|iph
comma
id|__u16
op_star
id|portp
comma
r_struct
id|ip_masq
op_star
id|ms
)paren
(brace
r_struct
id|ip_masq_mod
op_star
id|mmod
suffix:semicolon
r_int
id|ret
suffix:semicolon
r_for
c_loop
(paren
id|mmod
op_assign
id|ip_masq_mod_lkp_base
suffix:semicolon
id|mmod
suffix:semicolon
id|mmod
op_assign
id|mmod-&gt;next
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|mmod-&gt;mmod_out_update
)paren
r_continue
suffix:semicolon
r_switch
c_cond
(paren
id|ret
op_assign
id|mmod
op_member_access_from_pointer
id|mmod_out_update
c_func
(paren
id|iph
comma
id|portp
comma
id|ms
)paren
)paren
(brace
r_case
id|IP_MASQ_MOD_NOP
suffix:colon
r_continue
suffix:semicolon
r_case
id|IP_MASQ_MOD_ACCEPT
suffix:colon
r_return
l_int|1
suffix:semicolon
r_case
id|IP_MASQ_MOD_REJECT
suffix:colon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|ip_masq_mod_getbyname
r_struct
id|ip_masq_mod
op_star
id|ip_masq_mod_getbyname
c_func
(paren
r_const
r_char
op_star
id|mmod_name
)paren
(brace
r_struct
id|ip_masq_mod
op_star
id|mmod
suffix:semicolon
id|IP_MASQ_DEBUG
c_func
(paren
l_int|1
comma
l_string|&quot;searching mmod_name &bslash;&quot;%s&bslash;&quot;&bslash;n&quot;
comma
id|mmod_name
)paren
suffix:semicolon
r_for
c_loop
(paren
id|mmod
op_assign
id|ip_masq_mod_reg_base
suffix:semicolon
id|mmod
suffix:semicolon
id|mmod
op_assign
id|mmod-&gt;next_reg
)paren
(brace
r_if
c_cond
(paren
id|mmod-&gt;mmod_ctl
op_logical_and
op_star
(paren
id|mmod_name
)paren
op_logical_and
(paren
id|strcmp
c_func
(paren
id|mmod_name
comma
id|mmod-&gt;mmod_name
)paren
op_eq
l_int|0
)paren
)paren
(brace
multiline_comment|/* HIT */
r_return
id|mmod
suffix:semicolon
)brace
)brace
r_return
l_int|NULL
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;Module control entry&n; */
DECL|function|ip_masq_mod_ctl
r_int
id|ip_masq_mod_ctl
c_func
(paren
r_int
id|optname
comma
r_struct
id|ip_fw_masqctl
op_star
id|mctl
comma
r_int
id|optlen
)paren
(brace
r_struct
id|ip_masq_mod
op_star
id|mmod
suffix:semicolon
macro_line|#ifdef CONFIG_KMOD
r_char
id|kmod_name
(braket
id|IP_MASQ_MOD_NMAX
op_plus
l_int|8
)braket
suffix:semicolon
macro_line|#endif
multiline_comment|/* tappo */
id|mctl-&gt;u.mod.name
(braket
id|IP_MASQ_MOD_NMAX
op_minus
l_int|1
)braket
op_assign
l_int|0
suffix:semicolon
id|mmod
op_assign
id|ip_masq_mod_getbyname
c_func
(paren
id|mctl-&gt;u.mod.name
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mmod
)paren
r_return
id|mmod
op_member_access_from_pointer
id|mmod_ctl
c_func
(paren
id|optname
comma
id|mctl
comma
id|optlen
)paren
suffix:semicolon
macro_line|#ifdef CONFIG_KMOD
id|sprintf
c_func
(paren
id|kmod_name
comma
l_string|&quot;ip_masq_%s&quot;
comma
id|mctl-&gt;u.mod.name
)paren
suffix:semicolon
id|IP_MASQ_DEBUG
c_func
(paren
l_int|1
comma
l_string|&quot;About to request &bslash;&quot;%s&bslash;&quot; module&bslash;n&quot;
comma
id|kmod_name
)paren
suffix:semicolon
multiline_comment|/* &n;&t; *&t;Let sleep for a while ...&n;&t; */
id|request_module
c_func
(paren
id|kmod_name
)paren
suffix:semicolon
id|mmod
op_assign
id|ip_masq_mod_getbyname
c_func
(paren
id|mctl-&gt;u.mod.name
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mmod
)paren
r_return
id|mmod
op_member_access_from_pointer
id|mmod_ctl
c_func
(paren
id|optname
comma
id|mctl
comma
id|optlen
)paren
suffix:semicolon
macro_line|#endif
r_return
id|ESRCH
suffix:semicolon
)brace
eof
