multiline_comment|/*&n; *&t;&t;IP_MASQ_PORTFW masquerading module&n; *&n; *&n; *&t;$Id: ip_masq_portfw.c,v 1.4 1999/06/29 12:35:53 davem Exp $&n; *&n; * Author:&t;Steven Clarke &lt;steven.clarke@monmouth.demon.co.uk&gt;&n; *&n; * Fixes:&t;&n; *&t;Juan Jose Ciarlante&t;: created this new file from ip_masq.c and ip_fw.c&n; *&t;Juan Jose Ciarlante&t;: modularized &n; *&t;Juan Jose Ciarlante &t;: use GFP_KERNEL&n; *&t;Juan Jose Ciarlante &t;: locking&n; *&n; */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/list.h&gt;
macro_line|#include &lt;net/ip.h&gt;
macro_line|#include &lt;linux/ip_fw.h&gt;
macro_line|#include &lt;linux/ip_masq.h&gt;
macro_line|#include &lt;net/ip_masq.h&gt;
macro_line|#include &lt;net/ip_masq_mod.h&gt;
macro_line|#include &lt;linux/proc_fs.h&gt;
macro_line|#include &lt;linux/init.h&gt;
DECL|macro|IP_PORTFW_PORT_MIN
mdefine_line|#define IP_PORTFW_PORT_MIN 1
DECL|macro|IP_PORTFW_PORT_MAX
mdefine_line|#define IP_PORTFW_PORT_MAX 60999
DECL|struct|ip_portfw
r_struct
id|ip_portfw
(brace
DECL|member|list
r_struct
id|list_head
id|list
suffix:semicolon
DECL|member|laddr
DECL|member|raddr
id|__u32
id|laddr
comma
id|raddr
suffix:semicolon
DECL|member|lport
DECL|member|rport
id|__u16
id|lport
comma
id|rport
suffix:semicolon
DECL|member|pref_cnt
id|atomic_t
id|pref_cnt
suffix:semicolon
multiline_comment|/* pref &quot;counter&quot; down to 0 */
DECL|member|pref
r_int
id|pref
suffix:semicolon
multiline_comment|/* user set pref */
)brace
suffix:semicolon
DECL|variable|mmod_self
r_static
r_struct
id|ip_masq_mod
op_star
id|mmod_self
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/*&n; *&t;Debug level&n; */
macro_line|#ifdef CONFIG_IP_MASQ_DEBUG
DECL|variable|debug
r_static
r_int
id|debug
op_assign
l_int|0
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|debug
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/*&n; *&t;Lock&n; */
DECL|variable|portfw_lock
r_static
id|spinlock_t
id|portfw_lock
op_assign
id|SPIN_LOCK_UNLOCKED
suffix:semicolon
DECL|variable|portfw_list
r_static
r_struct
id|list_head
id|portfw_list
(braket
l_int|2
)braket
suffix:semicolon
DECL|function|portfw_idx
r_static
id|__inline__
r_int
id|portfw_idx
c_func
(paren
r_int
id|protocol
)paren
(brace
r_return
(paren
id|protocol
op_eq
id|IPPROTO_TCP
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; *&n; *&t;Delete forwarding entry(s):&n; *&t;called from _DEL, u-space.&n; *&t;. &quot;relaxed&quot; match, except for lport&n; *&n; */
DECL|function|ip_portfw_del
r_static
id|__inline__
r_int
id|ip_portfw_del
c_func
(paren
id|__u16
id|protocol
comma
id|__u16
id|lport
comma
id|__u32
id|laddr
comma
id|__u16
id|rport
comma
id|__u32
id|raddr
)paren
(brace
r_int
id|prot
op_assign
id|portfw_idx
c_func
(paren
id|protocol
)paren
suffix:semicolon
r_struct
id|ip_portfw
op_star
id|n
suffix:semicolon
r_struct
id|list_head
op_star
id|entry
suffix:semicolon
r_struct
id|list_head
op_star
id|list
op_assign
op_amp
id|portfw_list
(braket
id|prot
)braket
suffix:semicolon
r_int
id|nent
suffix:semicolon
id|nent
op_assign
id|atomic_read
c_func
(paren
op_amp
id|mmod_self-&gt;mmod_nent
)paren
suffix:semicolon
id|write_lock_bh
c_func
(paren
op_amp
id|portfw_lock
)paren
suffix:semicolon
r_for
c_loop
(paren
id|entry
op_assign
id|list-&gt;next
suffix:semicolon
id|entry
op_ne
id|list
suffix:semicolon
id|entry
op_assign
id|entry-&gt;next
)paren
(brace
id|n
op_assign
id|list_entry
c_func
(paren
id|entry
comma
r_struct
id|ip_portfw
comma
id|list
)paren
suffix:semicolon
r_if
c_cond
(paren
id|n-&gt;lport
op_eq
id|lport
op_logical_and
(paren
op_logical_neg
id|laddr
op_logical_or
id|n-&gt;laddr
op_eq
id|laddr
)paren
op_logical_and
(paren
op_logical_neg
id|raddr
op_logical_or
id|n-&gt;raddr
op_eq
id|raddr
)paren
op_logical_and
(paren
op_logical_neg
id|rport
op_logical_or
id|n-&gt;rport
op_eq
id|rport
)paren
)paren
(brace
id|list_del
c_func
(paren
id|entry
)paren
suffix:semicolon
id|ip_masq_mod_dec_nent
c_func
(paren
id|mmod_self
)paren
suffix:semicolon
id|kfree_s
c_func
(paren
id|n
comma
r_sizeof
(paren
r_struct
id|ip_portfw
)paren
)paren
suffix:semicolon
id|MOD_DEC_USE_COUNT
suffix:semicolon
)brace
)brace
id|write_unlock_bh
c_func
(paren
op_amp
id|portfw_lock
)paren
suffix:semicolon
r_return
id|nent
op_eq
id|atomic_read
c_func
(paren
op_amp
id|mmod_self-&gt;mmod_nent
)paren
ques
c_cond
id|ESRCH
suffix:colon
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;Flush tables&n; *&t;called from _FLUSH, u-space.&n; */
DECL|function|ip_portfw_flush
r_static
id|__inline__
r_void
id|ip_portfw_flush
c_func
(paren
r_void
)paren
(brace
r_int
id|prot
suffix:semicolon
r_struct
id|list_head
op_star
id|l
suffix:semicolon
r_struct
id|list_head
op_star
id|e
suffix:semicolon
r_struct
id|ip_portfw
op_star
id|n
suffix:semicolon
id|write_lock_bh
c_func
(paren
op_amp
id|portfw_lock
)paren
suffix:semicolon
r_for
c_loop
(paren
id|prot
op_assign
l_int|0
suffix:semicolon
id|prot
OL
l_int|2
suffix:semicolon
id|prot
op_increment
)paren
(brace
id|l
op_assign
op_amp
id|portfw_list
(braket
id|prot
)braket
suffix:semicolon
r_while
c_loop
(paren
(paren
id|e
op_assign
id|l-&gt;next
)paren
op_ne
id|l
)paren
(brace
id|ip_masq_mod_dec_nent
c_func
(paren
id|mmod_self
)paren
suffix:semicolon
id|n
op_assign
id|list_entry
(paren
id|e
comma
r_struct
id|ip_portfw
comma
id|list
)paren
suffix:semicolon
id|list_del
c_func
(paren
id|e
)paren
suffix:semicolon
id|kfree_s
c_func
(paren
id|n
comma
r_sizeof
(paren
op_star
id|n
)paren
)paren
suffix:semicolon
id|MOD_DEC_USE_COUNT
suffix:semicolon
)brace
)brace
id|write_unlock_bh
c_func
(paren
op_amp
id|portfw_lock
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;Lookup routine for lport,laddr match&n; *&t;must be called with locked tables&n; */
DECL|function|ip_portfw_lookup
r_static
id|__inline__
r_struct
id|ip_portfw
op_star
id|ip_portfw_lookup
c_func
(paren
id|__u16
id|protocol
comma
id|__u16
id|lport
comma
id|__u32
id|laddr
comma
id|__u32
op_star
id|daddr_p
comma
id|__u16
op_star
id|dport_p
)paren
(brace
r_int
id|prot
op_assign
id|portfw_idx
c_func
(paren
id|protocol
)paren
suffix:semicolon
r_struct
id|ip_portfw
op_star
id|n
op_assign
l_int|NULL
suffix:semicolon
r_struct
id|list_head
op_star
id|l
comma
op_star
id|e
suffix:semicolon
id|l
op_assign
op_amp
id|portfw_list
(braket
id|prot
)braket
suffix:semicolon
r_for
c_loop
(paren
id|e
op_assign
id|l-&gt;next
suffix:semicolon
id|e
op_ne
id|l
suffix:semicolon
id|e
op_assign
id|e-&gt;next
)paren
(brace
id|n
op_assign
id|list_entry
c_func
(paren
id|e
comma
r_struct
id|ip_portfw
comma
id|list
)paren
suffix:semicolon
r_if
c_cond
(paren
id|lport
op_eq
id|n-&gt;lport
op_logical_and
id|laddr
op_eq
id|n-&gt;laddr
)paren
(brace
multiline_comment|/* Please be nice, don&squot;t pass only a NULL dport */
r_if
c_cond
(paren
id|daddr_p
)paren
(brace
op_star
id|daddr_p
op_assign
id|n-&gt;raddr
suffix:semicolon
op_star
id|dport_p
op_assign
id|n-&gt;rport
suffix:semicolon
)brace
r_goto
id|out
suffix:semicolon
)brace
)brace
id|n
op_assign
l_int|NULL
suffix:semicolon
id|out
suffix:colon
r_return
id|n
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;Edit routine for lport,[laddr], [raddr], [rport] match&n; *&t;By now, only called from u-space&n; */
DECL|function|ip_portfw_edit
r_static
id|__inline__
r_int
id|ip_portfw_edit
c_func
(paren
id|__u16
id|protocol
comma
id|__u16
id|lport
comma
id|__u32
id|laddr
comma
id|__u16
id|rport
comma
id|__u32
id|raddr
comma
r_int
id|pref
)paren
(brace
r_int
id|prot
op_assign
id|portfw_idx
c_func
(paren
id|protocol
)paren
suffix:semicolon
r_struct
id|ip_portfw
op_star
id|n
op_assign
l_int|NULL
suffix:semicolon
r_struct
id|list_head
op_star
id|l
comma
op_star
id|e
suffix:semicolon
r_int
id|count
op_assign
l_int|0
suffix:semicolon
id|read_lock_bh
c_func
(paren
op_amp
id|portfw_lock
)paren
suffix:semicolon
id|l
op_assign
op_amp
id|portfw_list
(braket
id|prot
)braket
suffix:semicolon
r_for
c_loop
(paren
id|e
op_assign
id|l-&gt;next
suffix:semicolon
id|e
op_ne
id|l
suffix:semicolon
id|e
op_assign
id|e-&gt;next
)paren
(brace
id|n
op_assign
id|list_entry
c_func
(paren
id|e
comma
r_struct
id|ip_portfw
comma
id|list
)paren
suffix:semicolon
r_if
c_cond
(paren
id|lport
op_eq
id|n-&gt;lport
op_logical_and
(paren
op_logical_neg
id|laddr
op_logical_or
id|laddr
op_eq
id|n-&gt;laddr
)paren
op_logical_and
(paren
op_logical_neg
id|rport
op_logical_or
id|rport
op_eq
id|n-&gt;rport
)paren
op_logical_and
(paren
op_logical_neg
id|raddr
op_logical_or
id|raddr
op_eq
id|n-&gt;raddr
)paren
)paren
(brace
id|n-&gt;pref
op_assign
id|pref
suffix:semicolon
id|atomic_set
c_func
(paren
op_amp
id|n-&gt;pref_cnt
comma
id|pref
)paren
suffix:semicolon
id|count
op_increment
suffix:semicolon
)brace
)brace
id|read_unlock_bh
c_func
(paren
op_amp
id|portfw_lock
)paren
suffix:semicolon
r_return
id|count
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;Add/edit en entry&n; *&t;called from _ADD, u-space.&n; *&t;must return 0 or +errno&n; */
DECL|function|ip_portfw_add
r_static
id|__inline__
r_int
id|ip_portfw_add
c_func
(paren
id|__u16
id|protocol
comma
id|__u16
id|lport
comma
id|__u32
id|laddr
comma
id|__u16
id|rport
comma
id|__u32
id|raddr
comma
r_int
id|pref
)paren
(brace
r_struct
id|ip_portfw
op_star
id|npf
suffix:semicolon
r_int
id|prot
op_assign
id|portfw_idx
c_func
(paren
id|protocol
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pref
op_le
l_int|0
)paren
r_return
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|ip_portfw_edit
c_func
(paren
id|protocol
comma
id|lport
comma
id|laddr
comma
id|rport
comma
id|raddr
comma
id|pref
)paren
)paren
(brace
multiline_comment|/*&n;&t;&t; *&t;Edit ok ...&n;&t;&t; */
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* may block ... */
id|npf
op_assign
(paren
r_struct
id|ip_portfw
op_star
)paren
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|ip_portfw
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|npf
)paren
r_return
id|ENOMEM
suffix:semicolon
id|MOD_INC_USE_COUNT
suffix:semicolon
id|memset
c_func
(paren
id|npf
comma
l_int|0
comma
r_sizeof
(paren
op_star
id|npf
)paren
)paren
suffix:semicolon
id|npf-&gt;laddr
op_assign
id|laddr
suffix:semicolon
id|npf-&gt;lport
op_assign
id|lport
suffix:semicolon
id|npf-&gt;rport
op_assign
id|rport
suffix:semicolon
id|npf-&gt;raddr
op_assign
id|raddr
suffix:semicolon
id|npf-&gt;pref
op_assign
id|pref
suffix:semicolon
id|atomic_set
c_func
(paren
op_amp
id|npf-&gt;pref_cnt
comma
id|npf-&gt;pref
)paren
suffix:semicolon
id|INIT_LIST_HEAD
c_func
(paren
op_amp
id|npf-&gt;list
)paren
suffix:semicolon
id|write_lock_bh
c_func
(paren
op_amp
id|portfw_lock
)paren
suffix:semicolon
multiline_comment|/*&n;&t; *&t;Add at head&n;&t; */
id|list_add
c_func
(paren
op_amp
id|npf-&gt;list
comma
op_amp
id|portfw_list
(braket
id|prot
)braket
)paren
suffix:semicolon
id|write_unlock_bh
c_func
(paren
op_amp
id|portfw_lock
)paren
suffix:semicolon
id|ip_masq_mod_inc_nent
c_func
(paren
id|mmod_self
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|portfw_ctl
r_static
id|__inline__
r_int
id|portfw_ctl
c_func
(paren
r_int
id|optname
comma
r_struct
id|ip_masq_ctl
op_star
id|mctl
comma
r_int
id|optlen
)paren
(brace
r_struct
id|ip_portfw_user
op_star
id|mm
op_assign
op_amp
id|mctl-&gt;u.portfw_user
suffix:semicolon
r_int
id|ret
op_assign
id|EINVAL
suffix:semicolon
r_int
id|arglen
op_assign
id|optlen
op_minus
id|IP_MASQ_CTL_BSIZE
suffix:semicolon
r_int
id|cmd
suffix:semicolon
id|IP_MASQ_DEBUG
c_func
(paren
l_int|1
op_minus
id|debug
comma
l_string|&quot;ip_masq_user_ctl(len=%d/%d|%d/%d)&bslash;n&quot;
comma
id|arglen
comma
r_sizeof
(paren
op_star
id|mm
)paren
comma
id|optlen
comma
r_sizeof
(paren
op_star
id|mctl
)paren
)paren
suffix:semicolon
multiline_comment|/*&n;&t; *&t;Yes, I&squot;m a bad guy ...&n;&t; */
r_if
c_cond
(paren
id|arglen
op_ne
r_sizeof
(paren
op_star
id|mm
)paren
op_logical_and
id|optlen
op_ne
r_sizeof
(paren
op_star
id|mctl
)paren
)paren
r_return
id|EINVAL
suffix:semicolon
multiline_comment|/* &n;&t; *&t;Don&squot;t trust the lusers - plenty of error checking! &n;&t; */
id|cmd
op_assign
id|mctl-&gt;m_cmd
suffix:semicolon
id|IP_MASQ_DEBUG
c_func
(paren
l_int|1
op_minus
id|debug
comma
l_string|&quot;ip_masq_portfw_ctl(cmd=%d)&bslash;n&quot;
comma
id|cmd
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|cmd
)paren
(brace
r_case
id|IP_MASQ_CMD_NONE
suffix:colon
r_return
l_int|0
suffix:semicolon
r_case
id|IP_MASQ_CMD_FLUSH
suffix:colon
r_break
suffix:semicolon
r_default
suffix:colon
(brace
)brace
r_if
c_cond
(paren
id|htons
c_func
(paren
id|mm-&gt;lport
)paren
template_param
id|IP_PORTFW_PORT_MAX
)paren
r_return
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|mm-&gt;protocol
op_ne
id|IPPROTO_TCP
op_logical_and
id|mm-&gt;protocol
op_ne
id|IPPROTO_UDP
)paren
r_return
id|EINVAL
suffix:semicolon
)brace
r_switch
c_cond
(paren
id|cmd
)paren
(brace
r_case
id|IP_MASQ_CMD_ADD
suffix:colon
id|ret
op_assign
id|ip_portfw_add
c_func
(paren
id|mm-&gt;protocol
comma
id|mm-&gt;lport
comma
id|mm-&gt;laddr
comma
id|mm-&gt;rport
comma
id|mm-&gt;raddr
comma
id|mm-&gt;pref
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|IP_MASQ_CMD_DEL
suffix:colon
id|ret
op_assign
id|ip_portfw_del
c_func
(paren
id|mm-&gt;protocol
comma
id|mm-&gt;lport
comma
id|mm-&gt;laddr
comma
id|mm-&gt;rport
comma
id|mm-&gt;raddr
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|IP_MASQ_CMD_FLUSH
suffix:colon
id|ip_portfw_flush
c_func
(paren
)paren
suffix:semicolon
id|ret
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
)brace
r_return
id|ret
suffix:semicolon
)brace
macro_line|#ifdef CONFIG_PROC_FS
DECL|function|portfw_procinfo
r_static
r_int
id|portfw_procinfo
c_func
(paren
r_char
op_star
id|buffer
comma
r_char
op_star
op_star
id|start
comma
id|off_t
id|offset
comma
r_int
id|length
comma
r_int
id|unused
)paren
(brace
id|off_t
id|pos
op_assign
l_int|0
comma
id|begin
suffix:semicolon
r_struct
id|ip_portfw
op_star
id|pf
suffix:semicolon
r_struct
id|list_head
op_star
id|l
comma
op_star
id|e
suffix:semicolon
r_char
id|temp
(braket
l_int|65
)braket
suffix:semicolon
r_int
id|ind
suffix:semicolon
r_int
id|len
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|offset
OL
l_int|64
)paren
(brace
id|sprintf
c_func
(paren
id|temp
comma
l_string|&quot;Prot LAddr    LPort &gt; RAddr    RPort PrCnt  Pref&quot;
)paren
suffix:semicolon
id|len
op_assign
id|sprintf
c_func
(paren
id|buffer
comma
l_string|&quot;%-63s&bslash;n&quot;
comma
id|temp
)paren
suffix:semicolon
)brace
id|pos
op_assign
l_int|64
suffix:semicolon
id|read_lock_bh
c_func
(paren
op_amp
id|portfw_lock
)paren
suffix:semicolon
r_for
c_loop
(paren
id|ind
op_assign
l_int|0
suffix:semicolon
id|ind
OL
l_int|2
suffix:semicolon
id|ind
op_increment
)paren
(brace
id|l
op_assign
op_amp
id|portfw_list
(braket
id|ind
)braket
suffix:semicolon
r_for
c_loop
(paren
id|e
op_assign
id|l-&gt;next
suffix:semicolon
id|e
op_ne
id|l
suffix:semicolon
id|e
op_assign
id|e-&gt;next
)paren
(brace
id|pf
op_assign
id|list_entry
c_func
(paren
id|e
comma
r_struct
id|ip_portfw
comma
id|list
)paren
suffix:semicolon
id|pos
op_add_assign
l_int|64
suffix:semicolon
r_if
c_cond
(paren
id|pos
op_le
id|offset
)paren
(brace
id|len
op_assign
l_int|0
suffix:semicolon
r_continue
suffix:semicolon
)brace
id|sprintf
c_func
(paren
id|temp
comma
l_string|&quot;%s  %08lX %5u &gt; %08lX %5u %5d %5d&quot;
comma
id|ind
ques
c_cond
l_string|&quot;TCP&quot;
suffix:colon
l_string|&quot;UDP&quot;
comma
id|ntohl
c_func
(paren
id|pf-&gt;laddr
)paren
comma
id|ntohs
c_func
(paren
id|pf-&gt;lport
)paren
comma
id|ntohl
c_func
(paren
id|pf-&gt;raddr
)paren
comma
id|ntohs
c_func
(paren
id|pf-&gt;rport
)paren
comma
id|atomic_read
c_func
(paren
op_amp
id|pf-&gt;pref_cnt
)paren
comma
id|pf-&gt;pref
)paren
suffix:semicolon
id|len
op_add_assign
id|sprintf
c_func
(paren
id|buffer
op_plus
id|len
comma
l_string|&quot;%-63s&bslash;n&quot;
comma
id|temp
)paren
suffix:semicolon
r_if
c_cond
(paren
id|len
op_ge
id|length
)paren
r_goto
id|done
suffix:semicolon
)brace
)brace
id|done
suffix:colon
id|read_unlock_bh
c_func
(paren
op_amp
id|portfw_lock
)paren
suffix:semicolon
id|begin
op_assign
id|len
op_minus
(paren
id|pos
op_minus
id|offset
)paren
suffix:semicolon
op_star
id|start
op_assign
id|buffer
op_plus
id|begin
suffix:semicolon
id|len
op_sub_assign
id|begin
suffix:semicolon
r_if
c_cond
(paren
id|len
OG
id|length
)paren
(brace
id|len
op_assign
id|length
suffix:semicolon
)brace
r_return
id|len
suffix:semicolon
)brace
DECL|variable|portfw_proc_entry
r_static
r_struct
id|proc_dir_entry
id|portfw_proc_entry
op_assign
(brace
multiline_comment|/* &t;&t;0, 0, NULL&quot;, */
l_int|0
comma
l_int|6
comma
l_string|&quot;portfw&quot;
comma
multiline_comment|/* Just for compatibility, for now ... */
id|S_IFREG
op_or
id|S_IRUGO
comma
l_int|1
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
op_amp
id|proc_net_inode_operations
comma
id|portfw_procinfo
)brace
suffix:semicolon
DECL|macro|proc_ent
mdefine_line|#define proc_ent &amp;portfw_proc_entry
macro_line|#else /* !CONFIG_PROC_FS */
DECL|macro|proc_ent
mdefine_line|#define proc_ent NULL
macro_line|#endif
DECL|function|portfw_in_rule
r_static
r_int
id|portfw_in_rule
c_func
(paren
r_const
r_struct
id|sk_buff
op_star
id|skb
comma
r_const
r_struct
id|iphdr
op_star
id|iph
)paren
(brace
r_const
id|__u16
op_star
id|portp
op_assign
(paren
id|__u16
op_star
)paren
op_amp
(paren
(paren
(paren
r_char
op_star
)paren
id|iph
)paren
(braket
id|iph-&gt;ihl
op_star
l_int|4
)braket
)paren
suffix:semicolon
macro_line|#ifdef CONFIG_IP_MASQ_DEBUG
r_struct
id|rtable
op_star
id|rt
op_assign
(paren
r_struct
id|rtable
op_star
)paren
id|skb-&gt;dst
suffix:semicolon
macro_line|#endif
r_struct
id|ip_portfw
op_star
id|pfw
suffix:semicolon
id|IP_MASQ_DEBUG
c_func
(paren
l_int|2
comma
l_string|&quot;portfw_in_rule(): skb:= dev=%s (index=%d), rt_iif=%d, rt_flags=0x%x rt_dev___=%s daddr=%d.%d.%d.%d dport=%d&bslash;n&quot;
comma
id|skb-&gt;dev-&gt;name
comma
id|skb-&gt;dev-&gt;ifindex
comma
id|rt-&gt;rt_iif
comma
id|rt-&gt;rt_flags
comma
id|rt-&gt;u.dst.dev-&gt;name
comma
id|NIPQUAD
c_func
(paren
id|iph-&gt;daddr
)paren
comma
id|ntohs
c_func
(paren
id|portp
(braket
l_int|1
)braket
)paren
)paren
suffix:semicolon
id|read_lock
c_func
(paren
op_amp
id|portfw_lock
)paren
suffix:semicolon
id|pfw
op_assign
id|ip_portfw_lookup
c_func
(paren
id|iph-&gt;protocol
comma
id|portp
(braket
l_int|1
)braket
comma
id|iph-&gt;daddr
comma
l_int|NULL
comma
l_int|NULL
)paren
suffix:semicolon
id|read_unlock
c_func
(paren
op_amp
id|portfw_lock
)paren
suffix:semicolon
r_return
(paren
id|pfw
op_ne
l_int|0
)paren
suffix:semicolon
)brace
DECL|function|portfw_in_create
r_static
r_struct
id|ip_masq
op_star
id|portfw_in_create
c_func
(paren
r_const
r_struct
id|sk_buff
op_star
id|skb
comma
r_const
r_struct
id|iphdr
op_star
id|iph
comma
id|__u32
id|maddr
)paren
(brace
multiline_comment|/* &n;&t; *&t;If no entry exists in the masquerading table&n; &t; * &t;and the port is involved&n;&t; *  &t;in port forwarding, create a new masq entry &n;&t; */
id|__u32
id|raddr
suffix:semicolon
id|__u16
id|rport
suffix:semicolon
r_const
id|__u16
op_star
id|portp
op_assign
(paren
id|__u16
op_star
)paren
op_amp
(paren
(paren
(paren
r_char
op_star
)paren
id|iph
)paren
(braket
id|iph-&gt;ihl
op_star
l_int|4
)braket
)paren
suffix:semicolon
r_struct
id|ip_masq
op_star
id|ms
op_assign
l_int|NULL
suffix:semicolon
r_struct
id|ip_portfw
op_star
id|pf
suffix:semicolon
multiline_comment|/*&n;&t; *&t;Lock for writing.&n;&t; */
id|write_lock
c_func
(paren
op_amp
id|portfw_lock
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|pf
op_assign
id|ip_portfw_lookup
c_func
(paren
id|iph-&gt;protocol
comma
id|portp
(braket
l_int|1
)braket
comma
id|iph-&gt;daddr
comma
op_amp
id|raddr
comma
op_amp
id|rport
)paren
)paren
)paren
(brace
id|ms
op_assign
id|ip_masq_new
c_func
(paren
id|iph-&gt;protocol
comma
id|iph-&gt;daddr
comma
id|portp
(braket
l_int|1
)braket
comma
id|raddr
comma
id|rport
comma
id|iph-&gt;saddr
comma
id|portp
(braket
l_int|0
)braket
comma
l_int|0
)paren
suffix:semicolon
id|ip_masq_listen
c_func
(paren
id|ms
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ms
op_logical_or
id|atomic_read
c_func
(paren
op_amp
id|mmod_self-&gt;mmod_nent
)paren
op_le
l_int|1
multiline_comment|/* || ip_masq_nlocks(&amp;portfw_lock) != 1 */
)paren
multiline_comment|/*&n;&t;&t;&t;&t; *&t;Maybe later...&n;&t;&t;&t;&t; */
r_goto
id|out
suffix:semicolon
multiline_comment|/*&n;&t;&t; *&t;Entry created, lock==1.&n;&t;&t; *&t;if pref_cnt == 0, move&n;&t;&t; *&t;entry at _tail_.&n;&t;&t; *&t;This is a simple load balance scheduling&n;&t;&t; */
r_if
c_cond
(paren
id|atomic_dec_and_test
c_func
(paren
op_amp
id|pf-&gt;pref_cnt
)paren
)paren
(brace
id|atomic_set
c_func
(paren
op_amp
id|pf-&gt;pref_cnt
comma
id|pf-&gt;pref
)paren
suffix:semicolon
id|list_del
c_func
(paren
op_amp
id|pf-&gt;list
)paren
suffix:semicolon
id|list_add
c_func
(paren
op_amp
id|pf-&gt;list
comma
id|portfw_list
(braket
id|portfw_idx
c_func
(paren
id|iph-&gt;protocol
)paren
)braket
dot
id|prev
)paren
suffix:semicolon
)brace
)brace
id|out
suffix:colon
id|write_unlock
c_func
(paren
op_amp
id|portfw_lock
)paren
suffix:semicolon
r_return
id|ms
suffix:semicolon
)brace
DECL|macro|portfw_in_update
mdefine_line|#define portfw_in_update&t;NULL
DECL|macro|portfw_out_rule
mdefine_line|#define portfw_out_rule&t;&t;NULL
DECL|macro|portfw_out_create
mdefine_line|#define portfw_out_create&t;NULL
DECL|macro|portfw_out_update
mdefine_line|#define portfw_out_update&t;NULL
DECL|variable|portfw_mod
r_static
r_struct
id|ip_masq_mod
id|portfw_mod
op_assign
(brace
l_int|NULL
comma
multiline_comment|/* next */
l_int|NULL
comma
multiline_comment|/* next_reg */
l_string|&quot;portfw&quot;
comma
multiline_comment|/* name */
id|ATOMIC_INIT
c_func
(paren
l_int|0
)paren
comma
multiline_comment|/* nent */
id|ATOMIC_INIT
c_func
(paren
l_int|0
)paren
comma
multiline_comment|/* refcnt */
id|proc_ent
comma
id|portfw_ctl
comma
l_int|NULL
comma
multiline_comment|/* masq_mod_init */
l_int|NULL
comma
multiline_comment|/* masq_mod_done */
id|portfw_in_rule
comma
id|portfw_in_update
comma
id|portfw_in_create
comma
id|portfw_out_rule
comma
id|portfw_out_update
comma
id|portfw_out_create
comma
)brace
suffix:semicolon
DECL|function|__initfunc
id|__initfunc
c_func
(paren
r_int
id|ip_portfw_init
c_func
(paren
r_void
)paren
)paren
(brace
id|INIT_LIST_HEAD
c_func
(paren
op_amp
id|portfw_list
(braket
l_int|0
)braket
)paren
suffix:semicolon
id|INIT_LIST_HEAD
c_func
(paren
op_amp
id|portfw_list
(braket
l_int|1
)braket
)paren
suffix:semicolon
r_return
id|register_ip_masq_mod
(paren
(paren
id|mmod_self
op_assign
op_amp
id|portfw_mod
)paren
)paren
suffix:semicolon
)brace
DECL|function|ip_portfw_done
r_int
id|ip_portfw_done
c_func
(paren
r_void
)paren
(brace
r_return
id|unregister_ip_masq_mod
c_func
(paren
op_amp
id|portfw_mod
)paren
suffix:semicolon
)brace
macro_line|#ifdef MODULE
id|EXPORT_NO_SYMBOLS
suffix:semicolon
DECL|function|init_module
r_int
id|init_module
c_func
(paren
r_void
)paren
(brace
r_if
c_cond
(paren
id|ip_portfw_init
c_func
(paren
)paren
op_ne
l_int|0
)paren
r_return
op_minus
id|EIO
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|cleanup_module
r_void
id|cleanup_module
c_func
(paren
r_void
)paren
(brace
r_if
c_cond
(paren
id|ip_portfw_done
c_func
(paren
)paren
op_ne
l_int|0
)paren
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;ip_portfw_done(): can&squot;t remove module&quot;
)paren
suffix:semicolon
)brace
macro_line|#endif /* MODULE */
eof
