multiline_comment|/*&n; *  $Id: ipconfig.c,v 1.34 2000/07/26 01:04:18 davem Exp $&n; *&n; *  Automatic Configuration of IP -- use BOOTP or RARP or user-supplied&n; *  information to configure own IP address and routes.&n; *&n; *  Copyright (C) 1996--1998 Martin Mares &lt;mj@atrey.karlin.mff.cuni.cz&gt;&n; *&n; *  Derived from network configuration code in fs/nfs/nfsroot.c,&n; *  originally Copyright (C) 1995, 1996 Gero Kuhlmann and me.&n; *&n; *  BOOTP rewritten to construct and analyse packets itself instead&n; *  of misusing the IP layer. num_bugs_causing_wrong_arp_replies--;&n; *&t;&t;&t;&t;&t;     -- MJ, December 1998&n; *  &n; *  Fixed ip_auto_config_setup calling at startup in the new &quot;Linker Magic&quot;&n; *  initialization scheme.&n; *&t;- Arnaldo Carvalho de Melo &lt;acme@conectiva.com.br&gt;, 08/11/1999&n; */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/random.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/utsname.h&gt;
macro_line|#include &lt;linux/in.h&gt;
macro_line|#include &lt;linux/if.h&gt;
macro_line|#include &lt;linux/inet.h&gt;
macro_line|#include &lt;linux/netdevice.h&gt;
macro_line|#include &lt;linux/if_arp.h&gt;
macro_line|#include &lt;linux/skbuff.h&gt;
macro_line|#include &lt;linux/ip.h&gt;
macro_line|#include &lt;linux/socket.h&gt;
macro_line|#include &lt;linux/route.h&gt;
macro_line|#include &lt;linux/udp.h&gt;
macro_line|#include &lt;net/arp.h&gt;
macro_line|#include &lt;net/ip.h&gt;
macro_line|#include &lt;net/ipconfig.h&gt;
macro_line|#include &lt;asm/uaccess.h&gt;
macro_line|#include &lt;asm/checksum.h&gt;
multiline_comment|/* Define this to allow debugging output */
DECL|macro|IPCONFIG_DEBUG
macro_line|#undef IPCONFIG_DEBUG
macro_line|#ifdef IPCONFIG_DEBUG
DECL|macro|DBG
mdefine_line|#define DBG(x) printk x
macro_line|#else
DECL|macro|DBG
mdefine_line|#define DBG(x) do { } while(0)
macro_line|#endif
multiline_comment|/* Define the timeout for waiting for a RARP/BOOTP reply */
DECL|macro|CONF_BASE_TIMEOUT
mdefine_line|#define CONF_BASE_TIMEOUT&t;(HZ*5)&t;/* Initial timeout: 5 seconds */
DECL|macro|CONF_RETRIES
mdefine_line|#define CONF_RETRIES&t; &t;10&t;/* 10 retries */
DECL|macro|CONF_TIMEOUT_RANDOM
mdefine_line|#define CONF_TIMEOUT_RANDOM&t;(HZ)&t;/* Maximum amount of randomization */
DECL|macro|CONF_TIMEOUT_MULT
mdefine_line|#define CONF_TIMEOUT_MULT&t;*5/4&t;/* Rate of timeout growth */
DECL|macro|CONF_TIMEOUT_MAX
mdefine_line|#define CONF_TIMEOUT_MAX&t;(HZ*30)&t;/* Maximum allowed timeout */
multiline_comment|/* IP configuration */
DECL|variable|__initdata
r_static
r_char
id|user_dev_name
(braket
id|IFNAMSIZ
)braket
id|__initdata
op_assign
(brace
l_int|0
comma
)brace
suffix:semicolon
multiline_comment|/* Name of user-selected boot device */
DECL|variable|__initdata
id|u32
id|ic_myaddr
id|__initdata
op_assign
id|INADDR_NONE
suffix:semicolon
multiline_comment|/* My IP address */
DECL|variable|__initdata
id|u32
id|ic_servaddr
id|__initdata
op_assign
id|INADDR_NONE
suffix:semicolon
multiline_comment|/* Server IP address */
DECL|variable|__initdata
id|u32
id|ic_gateway
id|__initdata
op_assign
id|INADDR_NONE
suffix:semicolon
multiline_comment|/* Gateway IP address */
DECL|variable|__initdata
id|u32
id|ic_netmask
id|__initdata
op_assign
id|INADDR_NONE
suffix:semicolon
multiline_comment|/* Netmask for local subnet */
DECL|variable|__initdata
r_int
id|ic_enable
id|__initdata
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* Automatic IP configuration enabled */
DECL|variable|__initdata
r_int
id|ic_host_name_set
id|__initdata
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Host name configured manually */
DECL|variable|__initdata
r_int
id|ic_set_manually
id|__initdata
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* IPconfig parameters set manually */
DECL|variable|__initdata
id|u32
id|root_server_addr
id|__initdata
op_assign
id|INADDR_NONE
suffix:semicolon
multiline_comment|/* Address of boot server */
DECL|variable|__initdata
id|u8
id|root_server_path
(braket
l_int|256
)braket
id|__initdata
op_assign
(brace
l_int|0
comma
)brace
suffix:semicolon
multiline_comment|/* Path to mount as root */
macro_line|#if defined(CONFIG_IP_PNP_BOOTP) || defined(CONFIG_IP_PNP_RARP)
DECL|macro|CONFIG_IP_PNP_DYNAMIC
mdefine_line|#define CONFIG_IP_PNP_DYNAMIC
DECL|variable|__initdata
r_int
id|ic_proto_enabled
id|__initdata
op_assign
l_int|0
multiline_comment|/* Protocols enabled */
macro_line|#ifdef CONFIG_IP_PNP_BOOTP
op_or
id|IC_BOOTP
macro_line|#endif
macro_line|#ifdef CONFIG_IP_PNP_RARP
op_or
id|IC_RARP
macro_line|#endif
suffix:semicolon
DECL|variable|__initdata
r_static
r_int
id|ic_got_reply
id|__initdata
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Protocol(s) we got reply from */
macro_line|#else
DECL|variable|__initdata
r_static
r_int
id|ic_proto_enabled
id|__initdata
op_assign
l_int|0
suffix:semicolon
macro_line|#endif
DECL|variable|__initdata
r_static
r_int
id|ic_proto_have_if
id|__initdata
op_assign
l_int|0
suffix:semicolon
multiline_comment|/*&n; *&t;Network devices&n; */
DECL|struct|ic_device
r_struct
id|ic_device
(brace
DECL|member|next
r_struct
id|ic_device
op_star
id|next
suffix:semicolon
DECL|member|dev
r_struct
id|net_device
op_star
id|dev
suffix:semicolon
DECL|member|flags
r_int
r_int
id|flags
suffix:semicolon
DECL|member|able
r_int
id|able
suffix:semicolon
)brace
suffix:semicolon
DECL|variable|__initdata
r_static
r_struct
id|ic_device
op_star
id|ic_first_dev
id|__initdata
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/* List of open device */
DECL|variable|__initdata
r_static
r_struct
id|net_device
op_star
id|ic_dev
id|__initdata
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/* Selected device */
DECL|function|ic_open_devs
r_static
r_int
id|__init
id|ic_open_devs
c_func
(paren
r_void
)paren
(brace
r_struct
id|ic_device
op_star
id|d
comma
op_star
op_star
id|last
suffix:semicolon
r_struct
id|net_device
op_star
id|dev
suffix:semicolon
r_int
r_int
id|oflags
suffix:semicolon
id|last
op_assign
op_amp
id|ic_first_dev
suffix:semicolon
id|rtnl_shlock
c_func
(paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|dev
op_assign
id|dev_base
suffix:semicolon
id|dev
suffix:semicolon
id|dev
op_assign
id|dev-&gt;next
)paren
(brace
r_if
c_cond
(paren
id|user_dev_name
(braket
l_int|0
)braket
ques
c_cond
op_logical_neg
id|strcmp
c_func
(paren
id|dev-&gt;name
comma
id|user_dev_name
)paren
suffix:colon
(paren
op_logical_neg
(paren
id|dev-&gt;flags
op_amp
id|IFF_LOOPBACK
)paren
op_logical_and
(paren
id|dev-&gt;flags
op_amp
(paren
id|IFF_POINTOPOINT
op_or
id|IFF_BROADCAST
)paren
)paren
op_logical_and
id|strncmp
c_func
(paren
id|dev-&gt;name
comma
l_string|&quot;dummy&quot;
comma
l_int|5
)paren
)paren
)paren
(brace
r_int
id|able
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;mtu
op_ge
l_int|364
)paren
id|able
op_or_assign
id|IC_BOOTP
suffix:semicolon
r_else
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;BOOTP: Ignoring device %s, MTU %d too small&quot;
comma
id|dev-&gt;name
comma
id|dev-&gt;mtu
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|dev-&gt;flags
op_amp
id|IFF_NOARP
)paren
)paren
id|able
op_or_assign
id|IC_RARP
suffix:semicolon
id|able
op_and_assign
id|ic_proto_enabled
suffix:semicolon
r_if
c_cond
(paren
id|ic_proto_enabled
op_logical_and
op_logical_neg
id|able
)paren
r_continue
suffix:semicolon
id|oflags
op_assign
id|dev-&gt;flags
suffix:semicolon
r_if
c_cond
(paren
id|dev_change_flags
c_func
(paren
id|dev
comma
id|oflags
op_or
id|IFF_UP
)paren
OL
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;IP-Config: Failed to open %s&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|d
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|ic_device
)paren
comma
id|GFP_KERNEL
)paren
)paren
)paren
r_return
op_minus
l_int|1
suffix:semicolon
id|d-&gt;dev
op_assign
id|dev
suffix:semicolon
op_star
id|last
op_assign
id|d
suffix:semicolon
id|last
op_assign
op_amp
id|d-&gt;next
suffix:semicolon
id|d-&gt;flags
op_assign
id|oflags
suffix:semicolon
id|d-&gt;able
op_assign
id|able
suffix:semicolon
id|ic_proto_have_if
op_or_assign
id|able
suffix:semicolon
id|DBG
c_func
(paren
(paren
l_string|&quot;IP-Config: Opened %s (able=%d)&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|able
)paren
)paren
suffix:semicolon
)brace
)brace
id|rtnl_shunlock
c_func
(paren
)paren
suffix:semicolon
op_star
id|last
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ic_first_dev
)paren
(brace
r_if
c_cond
(paren
id|user_dev_name
(braket
l_int|0
)braket
)paren
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;IP-Config: Device `%s&squot; not found.&bslash;n&quot;
comma
id|user_dev_name
)paren
suffix:semicolon
r_else
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;IP-Config: No network devices available.&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|ic_close_devs
r_static
r_void
id|__init
id|ic_close_devs
c_func
(paren
r_void
)paren
(brace
r_struct
id|ic_device
op_star
id|d
comma
op_star
id|next
suffix:semicolon
r_struct
id|net_device
op_star
id|dev
suffix:semicolon
id|rtnl_shlock
c_func
(paren
)paren
suffix:semicolon
id|next
op_assign
id|ic_first_dev
suffix:semicolon
r_while
c_loop
(paren
(paren
id|d
op_assign
id|next
)paren
)paren
(brace
id|next
op_assign
id|d-&gt;next
suffix:semicolon
id|dev
op_assign
id|d-&gt;dev
suffix:semicolon
r_if
c_cond
(paren
id|dev
op_ne
id|ic_dev
)paren
(brace
id|DBG
c_func
(paren
(paren
l_string|&quot;IP-Config: Downing %s&bslash;n&quot;
comma
id|dev-&gt;name
)paren
)paren
suffix:semicolon
id|dev_change_flags
c_func
(paren
id|dev
comma
id|d-&gt;flags
)paren
suffix:semicolon
)brace
id|kfree
c_func
(paren
id|d
)paren
suffix:semicolon
)brace
id|rtnl_shunlock
c_func
(paren
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;Interface to various network functions.&n; */
r_static
r_inline
r_void
DECL|function|set_sockaddr
id|set_sockaddr
c_func
(paren
r_struct
id|sockaddr_in
op_star
id|sin
comma
id|u32
id|addr
comma
id|u16
id|port
)paren
(brace
id|sin-&gt;sin_family
op_assign
id|AF_INET
suffix:semicolon
id|sin-&gt;sin_addr.s_addr
op_assign
id|addr
suffix:semicolon
id|sin-&gt;sin_port
op_assign
id|port
suffix:semicolon
)brace
DECL|function|ic_dev_ioctl
r_static
r_int
id|__init
id|ic_dev_ioctl
c_func
(paren
r_int
r_int
id|cmd
comma
r_struct
id|ifreq
op_star
id|arg
)paren
(brace
r_int
id|res
suffix:semicolon
id|mm_segment_t
id|oldfs
op_assign
id|get_fs
c_func
(paren
)paren
suffix:semicolon
id|set_fs
c_func
(paren
id|get_ds
c_func
(paren
)paren
)paren
suffix:semicolon
id|res
op_assign
id|devinet_ioctl
c_func
(paren
id|cmd
comma
id|arg
)paren
suffix:semicolon
id|set_fs
c_func
(paren
id|oldfs
)paren
suffix:semicolon
r_return
id|res
suffix:semicolon
)brace
DECL|function|ic_route_ioctl
r_static
r_int
id|__init
id|ic_route_ioctl
c_func
(paren
r_int
r_int
id|cmd
comma
r_struct
id|rtentry
op_star
id|arg
)paren
(brace
r_int
id|res
suffix:semicolon
id|mm_segment_t
id|oldfs
op_assign
id|get_fs
c_func
(paren
)paren
suffix:semicolon
id|set_fs
c_func
(paren
id|get_ds
c_func
(paren
)paren
)paren
suffix:semicolon
id|res
op_assign
id|ip_rt_ioctl
c_func
(paren
id|cmd
comma
id|arg
)paren
suffix:semicolon
id|set_fs
c_func
(paren
id|oldfs
)paren
suffix:semicolon
r_return
id|res
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;Set up interface addresses and routes.&n; */
DECL|function|ic_setup_if
r_static
r_int
id|__init
id|ic_setup_if
c_func
(paren
r_void
)paren
(brace
r_struct
id|ifreq
id|ir
suffix:semicolon
r_struct
id|sockaddr_in
op_star
id|sin
op_assign
(paren
r_void
op_star
)paren
op_amp
id|ir.ifr_ifru.ifru_addr
suffix:semicolon
r_int
id|err
suffix:semicolon
id|memset
c_func
(paren
op_amp
id|ir
comma
l_int|0
comma
r_sizeof
(paren
id|ir
)paren
)paren
suffix:semicolon
id|strcpy
c_func
(paren
id|ir.ifr_ifrn.ifrn_name
comma
id|ic_dev-&gt;name
)paren
suffix:semicolon
id|set_sockaddr
c_func
(paren
id|sin
comma
id|ic_myaddr
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|err
op_assign
id|ic_dev_ioctl
c_func
(paren
id|SIOCSIFADDR
comma
op_amp
id|ir
)paren
)paren
OL
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;IP-Config: Unable to set interface address (%d).&bslash;n&quot;
comma
id|err
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|set_sockaddr
c_func
(paren
id|sin
comma
id|ic_netmask
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|err
op_assign
id|ic_dev_ioctl
c_func
(paren
id|SIOCSIFNETMASK
comma
op_amp
id|ir
)paren
)paren
OL
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;IP-Config: Unable to set interface netmask (%d).&bslash;n&quot;
comma
id|err
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|set_sockaddr
c_func
(paren
id|sin
comma
id|ic_myaddr
op_or
op_complement
id|ic_netmask
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|err
op_assign
id|ic_dev_ioctl
c_func
(paren
id|SIOCSIFBRDADDR
comma
op_amp
id|ir
)paren
)paren
OL
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;IP-Config: Unable to set interface broadcast address (%d).&bslash;n&quot;
comma
id|err
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|ic_setup_routes
r_static
r_int
id|__init
id|ic_setup_routes
c_func
(paren
r_void
)paren
(brace
multiline_comment|/* No need to setup device routes, only the default route... */
r_if
c_cond
(paren
id|ic_gateway
op_ne
id|INADDR_NONE
)paren
(brace
r_struct
id|rtentry
id|rm
suffix:semicolon
r_int
id|err
suffix:semicolon
id|memset
c_func
(paren
op_amp
id|rm
comma
l_int|0
comma
r_sizeof
(paren
id|rm
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|ic_gateway
op_xor
id|ic_myaddr
)paren
op_amp
id|ic_netmask
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;IP-Config: Gateway not on directly connected network.&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|set_sockaddr
c_func
(paren
(paren
r_struct
id|sockaddr_in
op_star
)paren
op_amp
id|rm.rt_dst
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
id|set_sockaddr
c_func
(paren
(paren
r_struct
id|sockaddr_in
op_star
)paren
op_amp
id|rm.rt_genmask
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
id|set_sockaddr
c_func
(paren
(paren
r_struct
id|sockaddr_in
op_star
)paren
op_amp
id|rm.rt_gateway
comma
id|ic_gateway
comma
l_int|0
)paren
suffix:semicolon
id|rm.rt_flags
op_assign
id|RTF_UP
op_or
id|RTF_GATEWAY
suffix:semicolon
r_if
c_cond
(paren
(paren
id|err
op_assign
id|ic_route_ioctl
c_func
(paren
id|SIOCADDRT
comma
op_amp
id|rm
)paren
)paren
OL
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;IP-Config: Cannot add default route (%d).&bslash;n&quot;
comma
id|err
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;Fill in default values for all missing parameters.&n; */
DECL|function|ic_defaults
r_static
r_int
id|__init
id|ic_defaults
c_func
(paren
r_void
)paren
(brace
multiline_comment|/*&n;&t; *&t;At this point we have no userspace running so need not&n;&t; *&t;claim locks on system_utsname&n;&t; */
r_if
c_cond
(paren
op_logical_neg
id|ic_host_name_set
)paren
id|strcpy
c_func
(paren
id|system_utsname.nodename
comma
id|in_ntoa
c_func
(paren
id|ic_myaddr
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|root_server_addr
op_eq
id|INADDR_NONE
)paren
id|root_server_addr
op_assign
id|ic_servaddr
suffix:semicolon
r_if
c_cond
(paren
id|ic_netmask
op_eq
id|INADDR_NONE
)paren
(brace
r_if
c_cond
(paren
id|IN_CLASSA
c_func
(paren
id|ntohl
c_func
(paren
id|ic_myaddr
)paren
)paren
)paren
id|ic_netmask
op_assign
id|htonl
c_func
(paren
id|IN_CLASSA_NET
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
id|IN_CLASSB
c_func
(paren
id|ntohl
c_func
(paren
id|ic_myaddr
)paren
)paren
)paren
id|ic_netmask
op_assign
id|htonl
c_func
(paren
id|IN_CLASSB_NET
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
id|IN_CLASSC
c_func
(paren
id|ntohl
c_func
(paren
id|ic_myaddr
)paren
)paren
)paren
id|ic_netmask
op_assign
id|htonl
c_func
(paren
id|IN_CLASSC_NET
)paren
suffix:semicolon
r_else
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;IP-Config: Unable to guess netmask for address %u.%u.%u.%u&bslash;n&quot;
comma
id|NIPQUAD
c_func
(paren
id|ic_myaddr
)paren
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;IP-Config: Guessing netmask %u.%u.%u.%u&bslash;n&quot;
comma
id|NIPQUAD
c_func
(paren
id|ic_netmask
)paren
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;RARP support.&n; */
macro_line|#ifdef CONFIG_IP_PNP_RARP
r_static
r_int
id|ic_rarp_recv
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|net_device
op_star
id|dev
comma
r_struct
id|packet_type
op_star
id|pt
)paren
suffix:semicolon
DECL|variable|__initdata
r_static
r_struct
id|packet_type
id|rarp_packet_type
id|__initdata
op_assign
(brace
id|__constant_htons
c_func
(paren
id|ETH_P_RARP
)paren
comma
l_int|NULL
comma
multiline_comment|/* Listen to all devices */
id|ic_rarp_recv
comma
l_int|NULL
comma
l_int|NULL
)brace
suffix:semicolon
DECL|function|ic_rarp_init
r_static
r_inline
r_void
id|ic_rarp_init
c_func
(paren
r_void
)paren
(brace
id|dev_add_pack
c_func
(paren
op_amp
id|rarp_packet_type
)paren
suffix:semicolon
)brace
DECL|function|ic_rarp_cleanup
r_static
r_inline
r_void
id|ic_rarp_cleanup
c_func
(paren
r_void
)paren
(brace
id|dev_remove_pack
c_func
(paren
op_amp
id|rarp_packet_type
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; *  Process received RARP packet.&n; */
r_static
r_int
id|__init
DECL|function|ic_rarp_recv
id|ic_rarp_recv
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|net_device
op_star
id|dev
comma
r_struct
id|packet_type
op_star
id|pt
)paren
(brace
r_struct
id|arphdr
op_star
id|rarp
op_assign
(paren
r_struct
id|arphdr
op_star
)paren
id|skb-&gt;h.raw
suffix:semicolon
r_int
r_char
op_star
id|rarp_ptr
op_assign
(paren
r_int
r_char
op_star
)paren
(paren
id|rarp
op_plus
l_int|1
)paren
suffix:semicolon
r_int
r_int
id|sip
comma
id|tip
suffix:semicolon
r_int
r_char
op_star
id|sha
comma
op_star
id|tha
suffix:semicolon
multiline_comment|/* s for &quot;source&quot;, t for &quot;target&quot; */
multiline_comment|/* If we already have a reply, just drop the packet */
r_if
c_cond
(paren
id|ic_got_reply
)paren
r_goto
id|drop
suffix:semicolon
multiline_comment|/* If this test doesn&squot;t pass, it&squot;s not IP, or we should ignore it anyway */
r_if
c_cond
(paren
id|rarp-&gt;ar_hln
op_ne
id|dev-&gt;addr_len
op_logical_or
id|dev-&gt;type
op_ne
id|ntohs
c_func
(paren
id|rarp-&gt;ar_hrd
)paren
)paren
r_goto
id|drop
suffix:semicolon
multiline_comment|/* If it&squot;s not a RARP reply, delete it. */
r_if
c_cond
(paren
id|rarp-&gt;ar_op
op_ne
id|htons
c_func
(paren
id|ARPOP_RREPLY
)paren
)paren
r_goto
id|drop
suffix:semicolon
multiline_comment|/* If it&squot;s not Ethernet, delete it. */
r_if
c_cond
(paren
id|rarp-&gt;ar_pro
op_ne
id|htons
c_func
(paren
id|ETH_P_IP
)paren
)paren
r_goto
id|drop
suffix:semicolon
multiline_comment|/* Extract variable-width fields */
id|sha
op_assign
id|rarp_ptr
suffix:semicolon
id|rarp_ptr
op_add_assign
id|dev-&gt;addr_len
suffix:semicolon
id|memcpy
c_func
(paren
op_amp
id|sip
comma
id|rarp_ptr
comma
l_int|4
)paren
suffix:semicolon
id|rarp_ptr
op_add_assign
l_int|4
suffix:semicolon
id|tha
op_assign
id|rarp_ptr
suffix:semicolon
id|rarp_ptr
op_add_assign
id|dev-&gt;addr_len
suffix:semicolon
id|memcpy
c_func
(paren
op_amp
id|tip
comma
id|rarp_ptr
comma
l_int|4
)paren
suffix:semicolon
multiline_comment|/* Discard packets which are not meant for us. */
r_if
c_cond
(paren
id|memcmp
c_func
(paren
id|tha
comma
id|dev-&gt;dev_addr
comma
id|dev-&gt;addr_len
)paren
)paren
r_goto
id|drop
suffix:semicolon
multiline_comment|/* Discard packets which are not from specified server. */
r_if
c_cond
(paren
id|ic_servaddr
op_ne
id|INADDR_NONE
op_logical_and
id|ic_servaddr
op_ne
id|sip
)paren
r_goto
id|drop
suffix:semicolon
multiline_comment|/* Victory! The packet is what we were looking for! */
r_if
c_cond
(paren
op_logical_neg
id|ic_got_reply
)paren
(brace
id|ic_got_reply
op_assign
id|IC_RARP
suffix:semicolon
id|ic_dev
op_assign
id|dev
suffix:semicolon
r_if
c_cond
(paren
id|ic_myaddr
op_eq
id|INADDR_NONE
)paren
id|ic_myaddr
op_assign
id|tip
suffix:semicolon
id|ic_servaddr
op_assign
id|sip
suffix:semicolon
)brace
multiline_comment|/* And throw the packet out... */
id|drop
suffix:colon
id|kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; *  Send RARP request packet over all devices which allow RARP.&n; */
DECL|function|ic_rarp_send
r_static
r_void
id|__init
id|ic_rarp_send
c_func
(paren
r_void
)paren
(brace
r_struct
id|ic_device
op_star
id|d
suffix:semicolon
r_for
c_loop
(paren
id|d
op_assign
id|ic_first_dev
suffix:semicolon
id|d
suffix:semicolon
id|d
op_assign
id|d-&gt;next
)paren
r_if
c_cond
(paren
id|d-&gt;able
op_amp
id|IC_RARP
)paren
(brace
r_struct
id|net_device
op_star
id|dev
op_assign
id|d-&gt;dev
suffix:semicolon
id|arp_send
c_func
(paren
id|ARPOP_RREQUEST
comma
id|ETH_P_RARP
comma
l_int|0
comma
id|dev
comma
l_int|0
comma
l_int|NULL
comma
id|dev-&gt;dev_addr
comma
id|dev-&gt;dev_addr
)paren
suffix:semicolon
)brace
)brace
macro_line|#endif
multiline_comment|/*&n; *&t;BOOTP support.&n; */
macro_line|#ifdef CONFIG_IP_PNP_BOOTP
DECL|struct|bootp_pkt
r_struct
id|bootp_pkt
(brace
multiline_comment|/* BOOTP packet format */
DECL|member|iph
r_struct
id|iphdr
id|iph
suffix:semicolon
multiline_comment|/* IP header */
DECL|member|udph
r_struct
id|udphdr
id|udph
suffix:semicolon
multiline_comment|/* UDP header */
DECL|member|op
id|u8
id|op
suffix:semicolon
multiline_comment|/* 1=request, 2=reply */
DECL|member|htype
id|u8
id|htype
suffix:semicolon
multiline_comment|/* HW address type */
DECL|member|hlen
id|u8
id|hlen
suffix:semicolon
multiline_comment|/* HW address length */
DECL|member|hops
id|u8
id|hops
suffix:semicolon
multiline_comment|/* Used only by gateways */
DECL|member|xid
id|u32
id|xid
suffix:semicolon
multiline_comment|/* Transaction ID */
DECL|member|secs
id|u16
id|secs
suffix:semicolon
multiline_comment|/* Seconds since we started */
DECL|member|flags
id|u16
id|flags
suffix:semicolon
multiline_comment|/* Just what it says */
DECL|member|client_ip
id|u32
id|client_ip
suffix:semicolon
multiline_comment|/* Client&squot;s IP address if known */
DECL|member|your_ip
id|u32
id|your_ip
suffix:semicolon
multiline_comment|/* Assigned IP address */
DECL|member|server_ip
id|u32
id|server_ip
suffix:semicolon
multiline_comment|/* Server&squot;s IP address */
DECL|member|relay_ip
id|u32
id|relay_ip
suffix:semicolon
multiline_comment|/* IP address of BOOTP relay */
DECL|member|hw_addr
id|u8
id|hw_addr
(braket
l_int|16
)braket
suffix:semicolon
multiline_comment|/* Client&squot;s HW address */
DECL|member|serv_name
id|u8
id|serv_name
(braket
l_int|64
)braket
suffix:semicolon
multiline_comment|/* Server host name */
DECL|member|boot_file
id|u8
id|boot_file
(braket
l_int|128
)braket
suffix:semicolon
multiline_comment|/* Name of boot file */
DECL|member|vendor_area
id|u8
id|vendor_area
(braket
l_int|128
)braket
suffix:semicolon
multiline_comment|/* Area for extensions */
)brace
suffix:semicolon
DECL|macro|BOOTP_REQUEST
mdefine_line|#define BOOTP_REQUEST 1
DECL|macro|BOOTP_REPLY
mdefine_line|#define BOOTP_REPLY 2
DECL|variable|ic_bootp_xid
r_static
id|u32
id|ic_bootp_xid
suffix:semicolon
r_static
r_int
id|ic_bootp_recv
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|net_device
op_star
id|dev
comma
r_struct
id|packet_type
op_star
id|pt
)paren
suffix:semicolon
DECL|variable|__initdata
r_static
r_struct
id|packet_type
id|bootp_packet_type
id|__initdata
op_assign
(brace
id|__constant_htons
c_func
(paren
id|ETH_P_IP
)paren
comma
l_int|NULL
comma
multiline_comment|/* Listen to all devices */
id|ic_bootp_recv
comma
l_int|NULL
comma
l_int|NULL
)brace
suffix:semicolon
multiline_comment|/*&n; *  Initialize BOOTP extension fields in the request.&n; */
DECL|function|ic_bootp_init_ext
r_static
r_void
id|__init
id|ic_bootp_init_ext
c_func
(paren
id|u8
op_star
id|e
)paren
(brace
op_star
id|e
op_increment
op_assign
l_int|99
suffix:semicolon
multiline_comment|/* RFC1048 Magic Cookie */
op_star
id|e
op_increment
op_assign
l_int|130
suffix:semicolon
op_star
id|e
op_increment
op_assign
l_int|83
suffix:semicolon
op_star
id|e
op_increment
op_assign
l_int|99
suffix:semicolon
op_star
id|e
op_increment
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* Subnet mask request */
op_star
id|e
op_increment
op_assign
l_int|4
suffix:semicolon
id|e
op_add_assign
l_int|4
suffix:semicolon
op_star
id|e
op_increment
op_assign
l_int|3
suffix:semicolon
multiline_comment|/* Default gateway request */
op_star
id|e
op_increment
op_assign
l_int|4
suffix:semicolon
id|e
op_add_assign
l_int|4
suffix:semicolon
op_star
id|e
op_increment
op_assign
l_int|12
suffix:semicolon
multiline_comment|/* Host name request */
op_star
id|e
op_increment
op_assign
l_int|32
suffix:semicolon
id|e
op_add_assign
l_int|32
suffix:semicolon
op_star
id|e
op_increment
op_assign
l_int|40
suffix:semicolon
multiline_comment|/* NIS Domain name request */
op_star
id|e
op_increment
op_assign
l_int|32
suffix:semicolon
id|e
op_add_assign
l_int|32
suffix:semicolon
op_star
id|e
op_increment
op_assign
l_int|17
suffix:semicolon
multiline_comment|/* Boot path */
op_star
id|e
op_increment
op_assign
l_int|32
suffix:semicolon
id|e
op_add_assign
l_int|32
suffix:semicolon
op_star
id|e
op_assign
l_int|255
suffix:semicolon
multiline_comment|/* End of the list */
)brace
multiline_comment|/*&n; *  Initialize the BOOTP mechanism.&n; */
DECL|function|ic_bootp_init
r_static
r_inline
r_void
id|ic_bootp_init
c_func
(paren
r_void
)paren
(brace
id|get_random_bytes
c_func
(paren
op_amp
id|ic_bootp_xid
comma
r_sizeof
(paren
id|u32
)paren
)paren
suffix:semicolon
id|DBG
c_func
(paren
(paren
l_string|&quot;BOOTP: XID=%08x&bslash;n&quot;
comma
id|ic_bootp_xid
)paren
)paren
suffix:semicolon
id|dev_add_pack
c_func
(paren
op_amp
id|bootp_packet_type
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; *  BOOTP cleanup.&n; */
DECL|function|ic_bootp_cleanup
r_static
r_inline
r_void
id|ic_bootp_cleanup
c_func
(paren
r_void
)paren
(brace
id|dev_remove_pack
c_func
(paren
op_amp
id|bootp_packet_type
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; *  Send BOOTP request to single interface.&n; */
DECL|function|ic_bootp_send_if
r_static
r_void
id|__init
id|ic_bootp_send_if
c_func
(paren
r_struct
id|ic_device
op_star
id|d
comma
id|u32
id|jiffies
)paren
(brace
r_struct
id|net_device
op_star
id|dev
op_assign
id|d-&gt;dev
suffix:semicolon
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
r_struct
id|bootp_pkt
op_star
id|b
suffix:semicolon
r_int
id|hh_len
op_assign
(paren
id|dev-&gt;hard_header_len
op_plus
l_int|15
)paren
op_amp
op_complement
l_int|15
suffix:semicolon
r_struct
id|iphdr
op_star
id|h
suffix:semicolon
multiline_comment|/* Allocate packet */
id|skb
op_assign
id|alloc_skb
c_func
(paren
r_sizeof
(paren
r_struct
id|bootp_pkt
)paren
op_plus
id|hh_len
op_plus
l_int|15
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|skb
)paren
r_return
suffix:semicolon
id|skb_reserve
c_func
(paren
id|skb
comma
id|hh_len
)paren
suffix:semicolon
id|b
op_assign
(paren
r_struct
id|bootp_pkt
op_star
)paren
id|skb_put
c_func
(paren
id|skb
comma
r_sizeof
(paren
r_struct
id|bootp_pkt
)paren
)paren
suffix:semicolon
id|memset
c_func
(paren
id|b
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|bootp_pkt
)paren
)paren
suffix:semicolon
multiline_comment|/* Construct IP header */
id|skb-&gt;nh.iph
op_assign
id|h
op_assign
op_amp
id|b-&gt;iph
suffix:semicolon
id|h-&gt;version
op_assign
l_int|4
suffix:semicolon
id|h-&gt;ihl
op_assign
l_int|5
suffix:semicolon
id|h-&gt;tot_len
op_assign
id|htons
c_func
(paren
r_sizeof
(paren
r_struct
id|bootp_pkt
)paren
)paren
suffix:semicolon
id|h-&gt;frag_off
op_assign
id|htons
c_func
(paren
id|IP_DF
)paren
suffix:semicolon
id|h-&gt;ttl
op_assign
l_int|64
suffix:semicolon
id|h-&gt;protocol
op_assign
id|IPPROTO_UDP
suffix:semicolon
id|h-&gt;daddr
op_assign
id|INADDR_BROADCAST
suffix:semicolon
id|h-&gt;check
op_assign
id|ip_fast_csum
c_func
(paren
(paren
r_int
r_char
op_star
)paren
id|h
comma
id|h-&gt;ihl
)paren
suffix:semicolon
multiline_comment|/* Construct UDP header */
id|b-&gt;udph.source
op_assign
id|htons
c_func
(paren
l_int|68
)paren
suffix:semicolon
id|b-&gt;udph.dest
op_assign
id|htons
c_func
(paren
l_int|67
)paren
suffix:semicolon
id|b-&gt;udph.len
op_assign
id|htons
c_func
(paren
r_sizeof
(paren
r_struct
id|bootp_pkt
)paren
op_minus
r_sizeof
(paren
r_struct
id|iphdr
)paren
)paren
suffix:semicolon
multiline_comment|/* UDP checksum not calculated -- explicitly allowed in BOOTP RFC */
multiline_comment|/* Construct BOOTP header */
id|b-&gt;op
op_assign
id|BOOTP_REQUEST
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;type
OL
l_int|256
)paren
multiline_comment|/* check for false types */
id|b-&gt;htype
op_assign
id|dev-&gt;type
suffix:semicolon
r_else
r_if
c_cond
(paren
id|dev-&gt;type
op_eq
id|ARPHRD_IEEE802_TR
)paren
multiline_comment|/* fix for token ring */
id|b-&gt;htype
op_assign
id|ARPHRD_IEEE802
suffix:semicolon
r_else
(brace
id|printk
c_func
(paren
l_string|&quot;Unknown ARP type 0x%04x for device %s&bslash;n&quot;
comma
id|dev-&gt;type
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|b-&gt;htype
op_assign
id|dev-&gt;type
suffix:semicolon
multiline_comment|/* can cause undefined behavior */
)brace
id|b-&gt;hlen
op_assign
id|dev-&gt;addr_len
suffix:semicolon
id|memcpy
c_func
(paren
id|b-&gt;hw_addr
comma
id|dev-&gt;dev_addr
comma
id|dev-&gt;addr_len
)paren
suffix:semicolon
id|b-&gt;secs
op_assign
id|htons
c_func
(paren
id|jiffies
op_div
id|HZ
)paren
suffix:semicolon
id|b-&gt;xid
op_assign
id|ic_bootp_xid
suffix:semicolon
id|ic_bootp_init_ext
c_func
(paren
id|b-&gt;vendor_area
)paren
suffix:semicolon
multiline_comment|/* Chain packet down the line... */
id|skb-&gt;dev
op_assign
id|dev
suffix:semicolon
id|skb-&gt;protocol
op_assign
id|__constant_htons
c_func
(paren
id|ETH_P_IP
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|dev-&gt;hard_header
op_logical_and
id|dev
op_member_access_from_pointer
id|hard_header
c_func
(paren
id|skb
comma
id|dev
comma
id|ntohs
c_func
(paren
id|skb-&gt;protocol
)paren
comma
id|dev-&gt;broadcast
comma
id|dev-&gt;dev_addr
comma
id|skb-&gt;len
)paren
OL
l_int|0
)paren
op_logical_or
id|dev_queue_xmit
c_func
(paren
id|skb
)paren
OL
l_int|0
)paren
id|printk
c_func
(paren
l_string|&quot;E&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; *  Send BOOTP requests to all interfaces.&n; */
DECL|function|ic_bootp_send
r_static
r_void
id|__init
id|ic_bootp_send
c_func
(paren
id|u32
id|jiffies
)paren
(brace
r_struct
id|ic_device
op_star
id|d
suffix:semicolon
r_for
c_loop
(paren
id|d
op_assign
id|ic_first_dev
suffix:semicolon
id|d
suffix:semicolon
id|d
op_assign
id|d-&gt;next
)paren
r_if
c_cond
(paren
id|d-&gt;able
op_amp
id|IC_BOOTP
)paren
id|ic_bootp_send_if
c_func
(paren
id|d
comma
id|jiffies
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; *  Copy BOOTP-supplied string if not already set.&n; */
DECL|function|ic_bootp_string
r_static
r_int
id|__init
id|ic_bootp_string
c_func
(paren
r_char
op_star
id|dest
comma
r_char
op_star
id|src
comma
r_int
id|len
comma
r_int
id|max
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|len
)paren
r_return
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|len
OG
id|max
op_minus
l_int|1
)paren
id|len
op_assign
id|max
op_minus
l_int|1
suffix:semicolon
id|strncpy
c_func
(paren
id|dest
comma
id|src
comma
id|len
)paren
suffix:semicolon
id|dest
(braket
id|len
)braket
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
multiline_comment|/*&n; *  Process BOOTP extension.&n; */
DECL|function|ic_do_bootp_ext
r_static
r_void
id|__init
id|ic_do_bootp_ext
c_func
(paren
id|u8
op_star
id|ext
)paren
(brace
macro_line|#ifdef IPCONFIG_DEBUG
id|u8
op_star
id|c
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;BOOTP: Got extension %02x&quot;
comma
op_star
id|ext
)paren
suffix:semicolon
r_for
c_loop
(paren
id|c
op_assign
id|ext
op_plus
l_int|2
suffix:semicolon
id|c
OL
id|ext
op_plus
l_int|2
op_plus
id|ext
(braket
l_int|1
)braket
suffix:semicolon
id|c
op_increment
)paren
(brace
id|printk
c_func
(paren
l_string|&quot; %02x&quot;
comma
op_star
id|c
)paren
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
r_switch
c_cond
(paren
op_star
id|ext
op_increment
)paren
(brace
r_case
l_int|1
suffix:colon
multiline_comment|/* Subnet mask */
r_if
c_cond
(paren
id|ic_netmask
op_eq
id|INADDR_NONE
)paren
id|memcpy
c_func
(paren
op_amp
id|ic_netmask
comma
id|ext
op_plus
l_int|1
comma
l_int|4
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|3
suffix:colon
multiline_comment|/* Default gateway */
r_if
c_cond
(paren
id|ic_gateway
op_eq
id|INADDR_NONE
)paren
id|memcpy
c_func
(paren
op_amp
id|ic_gateway
comma
id|ext
op_plus
l_int|1
comma
l_int|4
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|12
suffix:colon
multiline_comment|/* Host name */
id|ic_bootp_string
c_func
(paren
id|system_utsname.nodename
comma
id|ext
op_plus
l_int|1
comma
op_star
id|ext
comma
id|__NEW_UTS_LEN
)paren
suffix:semicolon
id|ic_host_name_set
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|40
suffix:colon
multiline_comment|/* NIS Domain name */
id|ic_bootp_string
c_func
(paren
id|system_utsname.domainname
comma
id|ext
op_plus
l_int|1
comma
op_star
id|ext
comma
id|__NEW_UTS_LEN
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|17
suffix:colon
multiline_comment|/* Root path */
r_if
c_cond
(paren
op_logical_neg
id|root_server_path
(braket
l_int|0
)braket
)paren
id|ic_bootp_string
c_func
(paren
id|root_server_path
comma
id|ext
op_plus
l_int|1
comma
op_star
id|ext
comma
r_sizeof
(paren
id|root_server_path
)paren
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
multiline_comment|/*&n; *  Receive BOOTP reply.&n; */
DECL|function|ic_bootp_recv
r_static
r_int
id|__init
id|ic_bootp_recv
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|net_device
op_star
id|dev
comma
r_struct
id|packet_type
op_star
id|pt
)paren
(brace
r_struct
id|bootp_pkt
op_star
id|b
op_assign
(paren
r_struct
id|bootp_pkt
op_star
)paren
id|skb-&gt;nh.iph
suffix:semicolon
r_struct
id|iphdr
op_star
id|h
op_assign
op_amp
id|b-&gt;iph
suffix:semicolon
r_int
id|len
suffix:semicolon
multiline_comment|/* If we already have a reply, just drop the packet */
r_if
c_cond
(paren
id|ic_got_reply
)paren
r_goto
id|drop
suffix:semicolon
multiline_comment|/* Check whether it&squot;s a BOOTP packet */
r_if
c_cond
(paren
id|skb-&gt;pkt_type
op_eq
id|PACKET_OTHERHOST
op_logical_or
id|skb-&gt;len
OL
r_sizeof
(paren
r_struct
id|udphdr
)paren
op_plus
r_sizeof
(paren
r_struct
id|iphdr
)paren
op_logical_or
id|h-&gt;ihl
op_ne
l_int|5
op_logical_or
id|h-&gt;version
op_ne
l_int|4
op_logical_or
id|ip_fast_csum
c_func
(paren
(paren
r_char
op_star
)paren
id|h
comma
id|h-&gt;ihl
)paren
op_ne
l_int|0
op_logical_or
id|skb-&gt;len
OL
id|ntohs
c_func
(paren
id|h-&gt;tot_len
)paren
op_logical_or
id|h-&gt;protocol
op_ne
id|IPPROTO_UDP
op_logical_or
id|b-&gt;udph.source
op_ne
id|htons
c_func
(paren
l_int|67
)paren
op_logical_or
id|b-&gt;udph.dest
op_ne
id|htons
c_func
(paren
l_int|68
)paren
op_logical_or
id|ntohs
c_func
(paren
id|h-&gt;tot_len
)paren
OL
id|ntohs
c_func
(paren
id|b-&gt;udph.len
)paren
op_plus
r_sizeof
(paren
r_struct
id|iphdr
)paren
)paren
r_goto
id|drop
suffix:semicolon
multiline_comment|/* Fragments are not supported */
r_if
c_cond
(paren
id|h-&gt;frag_off
op_amp
id|htons
c_func
(paren
id|IP_OFFSET
op_or
id|IP_MF
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;BOOTP: Ignoring fragmented reply.&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|drop
suffix:semicolon
)brace
multiline_comment|/* Is it a reply to our BOOTP request? */
id|len
op_assign
id|ntohs
c_func
(paren
id|b-&gt;udph.len
)paren
op_minus
r_sizeof
(paren
r_struct
id|udphdr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|len
OL
l_int|300
op_logical_or
multiline_comment|/* See RFC 951:2.1 */
id|b-&gt;op
op_ne
id|BOOTP_REPLY
op_logical_or
id|b-&gt;xid
op_ne
id|ic_bootp_xid
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;?&quot;
)paren
suffix:semicolon
r_goto
id|drop
suffix:semicolon
)brace
multiline_comment|/* Extract basic fields */
id|ic_myaddr
op_assign
id|b-&gt;your_ip
suffix:semicolon
id|ic_servaddr
op_assign
id|b-&gt;server_ip
suffix:semicolon
id|ic_got_reply
op_assign
id|IC_BOOTP
suffix:semicolon
id|ic_dev
op_assign
id|dev
suffix:semicolon
multiline_comment|/* Parse extensions */
r_if
c_cond
(paren
id|b-&gt;vendor_area
(braket
l_int|0
)braket
op_eq
l_int|99
op_logical_and
multiline_comment|/* Check magic cookie */
id|b-&gt;vendor_area
(braket
l_int|1
)braket
op_eq
l_int|130
op_logical_and
id|b-&gt;vendor_area
(braket
l_int|2
)braket
op_eq
l_int|83
op_logical_and
id|b-&gt;vendor_area
(braket
l_int|3
)braket
op_eq
l_int|99
)paren
(brace
id|u8
op_star
id|ext
op_assign
op_amp
id|b-&gt;vendor_area
(braket
l_int|4
)braket
suffix:semicolon
id|u8
op_star
id|end
op_assign
(paren
id|u8
op_star
)paren
id|b
op_plus
id|ntohs
c_func
(paren
id|b-&gt;iph.tot_len
)paren
suffix:semicolon
r_while
c_loop
(paren
id|ext
OL
id|end
op_logical_and
op_star
id|ext
op_ne
l_int|0xff
)paren
(brace
r_if
c_cond
(paren
op_star
id|ext
op_eq
l_int|0
)paren
multiline_comment|/* Padding */
id|ext
op_increment
suffix:semicolon
r_else
(brace
id|u8
op_star
id|opt
op_assign
id|ext
suffix:semicolon
id|ext
op_add_assign
id|ext
(braket
l_int|1
)braket
op_plus
l_int|2
suffix:semicolon
r_if
c_cond
(paren
id|ext
op_le
id|end
)paren
id|ic_do_bootp_ext
c_func
(paren
id|opt
)paren
suffix:semicolon
)brace
)brace
)brace
r_if
c_cond
(paren
id|ic_gateway
op_eq
id|INADDR_NONE
op_logical_and
id|b-&gt;relay_ip
)paren
id|ic_gateway
op_assign
id|b-&gt;relay_ip
suffix:semicolon
id|drop
suffix:colon
id|kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#endif
multiline_comment|/*&n; *&t;Dynamic IP configuration -- BOOTP and RARP.&n; */
macro_line|#ifdef CONFIG_IP_PNP_DYNAMIC
DECL|function|ic_dynamic
r_static
r_int
id|__init
id|ic_dynamic
c_func
(paren
r_void
)paren
(brace
r_int
id|retries
suffix:semicolon
r_int
r_int
id|timeout
comma
id|jiff
suffix:semicolon
r_int
r_int
id|start_jiffies
suffix:semicolon
r_int
id|do_rarp
op_assign
id|ic_proto_have_if
op_amp
id|IC_RARP
suffix:semicolon
r_int
id|do_bootp
op_assign
id|ic_proto_have_if
op_amp
id|IC_BOOTP
suffix:semicolon
multiline_comment|/*&n;&t; * If neither BOOTP nor RARP was selected, return with an error. This&n;&t; * routine gets only called when some pieces of information are mis-&n;&t; * sing, and without BOOTP and RARP we are not able to get that in-&n;&t; * formation.&n;&t; */
r_if
c_cond
(paren
op_logical_neg
id|ic_proto_enabled
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;IP-Config: Incomplete network configuration information.&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
macro_line|#ifdef CONFIG_IP_PNP_BOOTP
r_if
c_cond
(paren
(paren
id|ic_proto_enabled
op_xor
id|ic_proto_have_if
)paren
op_amp
id|IC_BOOTP
)paren
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;BOOTP: No suitable device found.&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
macro_line|#ifdef CONFIG_IP_PNP_RARP
r_if
c_cond
(paren
(paren
id|ic_proto_enabled
op_xor
id|ic_proto_have_if
)paren
op_amp
id|IC_RARP
)paren
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;RARP: No suitable device found.&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
op_logical_neg
id|ic_proto_have_if
)paren
multiline_comment|/* Error message already printed */
r_return
op_minus
l_int|1
suffix:semicolon
multiline_comment|/*&n;&t; * Setup RARP and BOOTP protocols&n;&t; */
macro_line|#ifdef CONFIG_IP_PNP_RARP
r_if
c_cond
(paren
id|do_rarp
)paren
id|ic_rarp_init
c_func
(paren
)paren
suffix:semicolon
macro_line|#endif
macro_line|#ifdef CONFIG_IP_PNP_BOOTP
r_if
c_cond
(paren
id|do_bootp
)paren
id|ic_bootp_init
c_func
(paren
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/*&n;&t; * Send requests and wait, until we get an answer. This loop&n;&t; * seems to be a terrible waste of CPU time, but actually there is&n;&t; * only one process running at all, so we don&squot;t need to use any&n;&t; * scheduler functions.&n;&t; * [Actually we could now, but the nothing else running note still &n;&t; *  applies.. - AC]&n;&t; */
id|printk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;Sending %s%s%s requests...&quot;
comma
id|do_bootp
ques
c_cond
l_string|&quot;BOOTP&quot;
suffix:colon
l_string|&quot;&quot;
comma
id|do_bootp
op_logical_and
id|do_rarp
ques
c_cond
l_string|&quot; and &quot;
suffix:colon
l_string|&quot;&quot;
comma
id|do_rarp
ques
c_cond
l_string|&quot;RARP&quot;
suffix:colon
l_string|&quot;&quot;
)paren
suffix:semicolon
id|start_jiffies
op_assign
id|jiffies
suffix:semicolon
id|retries
op_assign
id|CONF_RETRIES
suffix:semicolon
id|get_random_bytes
c_func
(paren
op_amp
id|timeout
comma
r_sizeof
(paren
id|timeout
)paren
)paren
suffix:semicolon
id|timeout
op_assign
id|CONF_BASE_TIMEOUT
op_plus
(paren
id|timeout
op_mod
(paren
r_int
)paren
id|CONF_TIMEOUT_RANDOM
)paren
suffix:semicolon
r_for
c_loop
(paren
suffix:semicolon
suffix:semicolon
)paren
(brace
macro_line|#ifdef CONFIG_IP_PNP_BOOTP
r_if
c_cond
(paren
id|do_bootp
)paren
id|ic_bootp_send
c_func
(paren
id|jiffies
op_minus
id|start_jiffies
)paren
suffix:semicolon
macro_line|#endif
macro_line|#ifdef CONFIG_IP_PNP_RARP
r_if
c_cond
(paren
id|do_rarp
)paren
id|ic_rarp_send
c_func
(paren
)paren
suffix:semicolon
macro_line|#endif
id|printk
c_func
(paren
l_string|&quot;.&quot;
)paren
suffix:semicolon
id|jiff
op_assign
id|jiffies
op_plus
id|timeout
suffix:semicolon
r_while
c_loop
(paren
id|jiffies
OL
id|jiff
op_logical_and
op_logical_neg
id|ic_got_reply
)paren
id|barrier
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ic_got_reply
)paren
(brace
id|printk
c_func
(paren
l_string|&quot; OK&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
op_decrement
id|retries
)paren
(brace
id|printk
c_func
(paren
l_string|&quot; timed out!&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|timeout
op_assign
id|timeout
id|CONF_TIMEOUT_MULT
suffix:semicolon
r_if
c_cond
(paren
id|timeout
OG
id|CONF_TIMEOUT_MAX
)paren
id|timeout
op_assign
id|CONF_TIMEOUT_MAX
suffix:semicolon
)brace
macro_line|#ifdef CONFIG_IP_PNP_RARP
r_if
c_cond
(paren
id|do_rarp
)paren
id|ic_rarp_cleanup
c_func
(paren
)paren
suffix:semicolon
macro_line|#endif
macro_line|#ifdef CONFIG_IP_PNP_BOOTP
r_if
c_cond
(paren
id|do_bootp
)paren
id|ic_bootp_cleanup
c_func
(paren
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
op_logical_neg
id|ic_got_reply
)paren
r_return
op_minus
l_int|1
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;IP-Config: Got %s answer from %u.%u.%u.%u, &quot;
comma
(paren
id|ic_got_reply
op_amp
id|IC_BOOTP
)paren
ques
c_cond
l_string|&quot;BOOTP&quot;
suffix:colon
l_string|&quot;RARP&quot;
comma
id|NIPQUAD
c_func
(paren
id|ic_servaddr
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;my address is %u.%u.%u.%u&bslash;n&quot;
comma
id|NIPQUAD
c_func
(paren
id|ic_myaddr
)paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#endif
multiline_comment|/*&n; *&t;IP Autoconfig dispatcher.&n; */
DECL|function|ip_auto_config
r_static
r_int
id|__init
id|ip_auto_config
c_func
(paren
r_void
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|ic_enable
)paren
r_return
l_int|0
suffix:semicolon
id|DBG
c_func
(paren
(paren
l_string|&quot;IP-Config: Entered.&bslash;n&quot;
)paren
)paren
suffix:semicolon
multiline_comment|/* Setup all network devices */
r_if
c_cond
(paren
id|ic_open_devs
c_func
(paren
)paren
OL
l_int|0
)paren
r_return
op_minus
l_int|1
suffix:semicolon
multiline_comment|/*&n;&t; * If the config information is insufficient (e.g., our IP address or&n;&t; * IP address of the boot server is missing or we have multiple network&n;&t; * interfaces and no default was set), use BOOTP or RARP to get the&n;&t; * missing values.&n;&t; */
r_if
c_cond
(paren
id|ic_myaddr
op_eq
id|INADDR_NONE
op_logical_or
macro_line|#ifdef CONFIG_ROOT_NFS
(paren
id|root_server_addr
op_eq
id|INADDR_NONE
op_logical_and
id|ic_servaddr
op_eq
id|INADDR_NONE
)paren
op_logical_or
macro_line|#endif
id|ic_first_dev-&gt;next
)paren
(brace
macro_line|#ifdef CONFIG_IP_PNP_DYNAMIC
r_if
c_cond
(paren
id|ic_dynamic
c_func
(paren
)paren
OL
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;IP-Config: Auto-configuration of network failed.&bslash;n&quot;
)paren
suffix:semicolon
id|ic_close_devs
c_func
(paren
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
macro_line|#else
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;IP-Config: Incomplete network configuration information.&bslash;n&quot;
)paren
suffix:semicolon
id|ic_close_devs
c_func
(paren
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
macro_line|#endif
)brace
r_else
(brace
id|ic_dev
op_assign
id|ic_first_dev-&gt;dev
suffix:semicolon
multiline_comment|/* Device selected manually or only one device -&gt; use it */
)brace
multiline_comment|/*&n;&t; * Use defaults whereever applicable.&n;&t; */
r_if
c_cond
(paren
id|ic_defaults
c_func
(paren
)paren
OL
l_int|0
)paren
r_return
op_minus
l_int|1
suffix:semicolon
multiline_comment|/*&n;&t; * Close all network devices except the device we&squot;ve&n;&t; * autoconfigured and set up routes.&n;&t; */
id|ic_close_devs
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ic_setup_if
c_func
(paren
)paren
OL
l_int|0
op_logical_or
id|ic_setup_routes
c_func
(paren
)paren
OL
l_int|0
)paren
r_return
op_minus
l_int|1
suffix:semicolon
id|DBG
c_func
(paren
(paren
l_string|&quot;IP-Config: device=%s, local=%08x, server=%08x, boot=%08x, gw=%08x, mask=%08x&bslash;n&quot;
comma
id|ic_dev-&gt;name
comma
id|ic_myaddr
comma
id|ic_servaddr
comma
id|root_server_addr
comma
id|ic_gateway
comma
id|ic_netmask
)paren
)paren
suffix:semicolon
id|DBG
c_func
(paren
(paren
l_string|&quot;IP-Config: host=%s, domain=%s, path=`%s&squot;&bslash;n&quot;
comma
id|system_utsname.nodename
comma
id|system_utsname.domainname
comma
id|root_server_path
)paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|variable|ip_auto_config
id|module_init
c_func
(paren
id|ip_auto_config
)paren
suffix:semicolon
multiline_comment|/*&n; *  Decode any IP configuration options in the &quot;ip=&quot; or &quot;nfsaddrs=&quot; kernel&n; *  command line parameter. It consists of option fields separated by colons in&n; *  the following order:&n; *&n; *  &lt;client-ip&gt;:&lt;server-ip&gt;:&lt;gw-ip&gt;:&lt;netmask&gt;:&lt;host name&gt;:&lt;device&gt;:&lt;bootp|rarp&gt;&n; *&n; *  Any of the fields can be empty which means to use a default value:&n; *&t;&lt;client-ip&gt;&t;- address given by BOOTP or RARP&n; *&t;&lt;server-ip&gt;&t;- address of host returning BOOTP or RARP packet&n; *&t;&lt;gw-ip&gt;&t;&t;- none, or the address returned by BOOTP&n; *&t;&lt;netmask&gt;&t;- automatically determined from &lt;client-ip&gt;, or the&n; *&t;&t;&t;  one returned by BOOTP&n; *&t;&lt;host name&gt;&t;- &lt;client-ip&gt; in ASCII notation, or the name returned&n; *&t;&t;&t;  by BOOTP&n; *&t;&lt;device&gt;&t;- use all available devices&n; *&t;&lt;bootp|rarp|both|off&gt; - use both protocols to determine my own address&n; */
DECL|function|ic_proto_name
r_static
r_int
id|__init
id|ic_proto_name
c_func
(paren
r_char
op_star
id|name
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|strcmp
c_func
(paren
id|name
comma
l_string|&quot;off&quot;
)paren
)paren
(brace
id|ic_proto_enabled
op_assign
l_int|0
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
macro_line|#ifdef CONFIG_IP_PNP_BOOTP
r_else
r_if
c_cond
(paren
op_logical_neg
id|strcmp
c_func
(paren
id|name
comma
l_string|&quot;bootp&quot;
)paren
)paren
(brace
id|ic_proto_enabled
op_and_assign
op_complement
id|IC_RARP
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
macro_line|#endif
macro_line|#ifdef CONFIG_IP_PNP_RARP
r_else
r_if
c_cond
(paren
op_logical_neg
id|strcmp
c_func
(paren
id|name
comma
l_string|&quot;rarp&quot;
)paren
)paren
(brace
id|ic_proto_enabled
op_and_assign
op_complement
id|IC_BOOTP
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
macro_line|#endif
macro_line|#ifdef CONFIG_IP_PNP_DYNAMIC
r_else
r_if
c_cond
(paren
op_logical_neg
id|strcmp
c_func
(paren
id|name
comma
l_string|&quot;both&quot;
)paren
)paren
(brace
r_return
l_int|1
suffix:semicolon
)brace
macro_line|#endif
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|ip_auto_config_setup
r_static
r_int
id|__init
id|ip_auto_config_setup
c_func
(paren
r_char
op_star
id|addrs
)paren
(brace
r_char
op_star
id|cp
comma
op_star
id|ip
comma
op_star
id|dp
suffix:semicolon
r_int
id|num
op_assign
l_int|0
suffix:semicolon
id|ic_set_manually
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|strcmp
c_func
(paren
id|addrs
comma
l_string|&quot;off&quot;
)paren
)paren
(brace
id|ic_enable
op_assign
l_int|0
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ic_proto_name
c_func
(paren
id|addrs
)paren
)paren
r_return
l_int|1
suffix:semicolon
multiline_comment|/* Parse the whole string */
id|ip
op_assign
id|addrs
suffix:semicolon
r_while
c_loop
(paren
id|ip
op_logical_and
op_star
id|ip
)paren
(brace
r_if
c_cond
(paren
(paren
id|cp
op_assign
id|strchr
c_func
(paren
id|ip
comma
l_char|&squot;:&squot;
)paren
)paren
)paren
op_star
id|cp
op_increment
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
r_if
c_cond
(paren
id|strlen
c_func
(paren
id|ip
)paren
OG
l_int|0
)paren
(brace
id|DBG
c_func
(paren
(paren
l_string|&quot;IP-Config: Parameter #%d: `%s&squot;&bslash;n&quot;
comma
id|num
comma
id|ip
)paren
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|num
)paren
(brace
r_case
l_int|0
suffix:colon
r_if
c_cond
(paren
(paren
id|ic_myaddr
op_assign
id|in_aton
c_func
(paren
id|ip
)paren
)paren
op_eq
id|INADDR_ANY
)paren
id|ic_myaddr
op_assign
id|INADDR_NONE
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|1
suffix:colon
r_if
c_cond
(paren
(paren
id|ic_servaddr
op_assign
id|in_aton
c_func
(paren
id|ip
)paren
)paren
op_eq
id|INADDR_ANY
)paren
id|ic_servaddr
op_assign
id|INADDR_NONE
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|2
suffix:colon
r_if
c_cond
(paren
(paren
id|ic_gateway
op_assign
id|in_aton
c_func
(paren
id|ip
)paren
)paren
op_eq
id|INADDR_ANY
)paren
id|ic_gateway
op_assign
id|INADDR_NONE
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|3
suffix:colon
r_if
c_cond
(paren
(paren
id|ic_netmask
op_assign
id|in_aton
c_func
(paren
id|ip
)paren
)paren
op_eq
id|INADDR_ANY
)paren
id|ic_netmask
op_assign
id|INADDR_NONE
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|4
suffix:colon
r_if
c_cond
(paren
(paren
id|dp
op_assign
id|strchr
c_func
(paren
id|ip
comma
l_char|&squot;.&squot;
)paren
)paren
)paren
(brace
op_star
id|dp
op_increment
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
id|strncpy
c_func
(paren
id|system_utsname.domainname
comma
id|dp
comma
id|__NEW_UTS_LEN
)paren
suffix:semicolon
id|system_utsname.domainname
(braket
id|__NEW_UTS_LEN
)braket
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
)brace
id|strncpy
c_func
(paren
id|system_utsname.nodename
comma
id|ip
comma
id|__NEW_UTS_LEN
)paren
suffix:semicolon
id|system_utsname.nodename
(braket
id|__NEW_UTS_LEN
)braket
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
id|ic_host_name_set
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|5
suffix:colon
id|strncpy
c_func
(paren
id|user_dev_name
comma
id|ip
comma
id|IFNAMSIZ
)paren
suffix:semicolon
id|user_dev_name
(braket
id|IFNAMSIZ
op_minus
l_int|1
)braket
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|6
suffix:colon
id|ic_proto_name
c_func
(paren
id|ip
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
id|ip
op_assign
id|cp
suffix:semicolon
id|num
op_increment
suffix:semicolon
)brace
r_return
l_int|1
suffix:semicolon
)brace
DECL|function|nfsaddrs_config_setup
r_static
r_int
id|__init
id|nfsaddrs_config_setup
c_func
(paren
r_char
op_star
id|addrs
)paren
(brace
r_return
id|ip_auto_config_setup
c_func
(paren
id|addrs
)paren
suffix:semicolon
)brace
id|__setup
c_func
(paren
l_string|&quot;ip=&quot;
comma
id|ip_auto_config_setup
)paren
suffix:semicolon
id|__setup
c_func
(paren
l_string|&quot;nfsaddrs=&quot;
comma
id|nfsaddrs_config_setup
)paren
suffix:semicolon
eof
