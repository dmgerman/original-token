macro_line|#include &lt;stdio.h&gt;&t;/* fprintf */
macro_line|#include &lt;stdlib.h&gt;&t;/* contains exit */
macro_line|#include &lt;sys/types.h&gt;&t;/* unistd.h needs this */
macro_line|#include &lt;unistd.h&gt;&t;/* contains read/write */
macro_line|#include &lt;fcntl.h&gt;
DECL|macro|MINIX_HEADER
mdefine_line|#define MINIX_HEADER 32
DECL|macro|GCC_HEADER
mdefine_line|#define GCC_HEADER 1024
DECL|function|die
r_void
id|die
c_func
(paren
r_char
op_star
id|str
)paren
(brace
id|fprintf
c_func
(paren
id|stderr
comma
l_string|&quot;%s&bslash;n&quot;
comma
id|str
)paren
suffix:semicolon
m_exit
(paren
l_int|1
)paren
suffix:semicolon
)brace
DECL|function|usage
r_void
id|usage
c_func
(paren
r_void
)paren
(brace
id|die
c_func
(paren
l_string|&quot;Usage: build boot system [&gt; image]&quot;
)paren
suffix:semicolon
)brace
DECL|function|main
r_int
id|main
c_func
(paren
r_int
id|argc
comma
r_char
op_star
op_star
id|argv
)paren
(brace
r_int
id|i
comma
id|c
comma
id|id
suffix:semicolon
r_char
id|buf
(braket
l_int|1024
)braket
suffix:semicolon
r_if
c_cond
(paren
id|argc
op_ne
l_int|3
)paren
id|usage
c_func
(paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
r_sizeof
id|buf
suffix:semicolon
id|i
op_increment
)paren
id|buf
(braket
id|i
)braket
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
(paren
id|id
op_assign
id|open
c_func
(paren
id|argv
(braket
l_int|1
)braket
comma
id|O_RDONLY
comma
l_int|0
)paren
)paren
OL
l_int|0
)paren
id|die
c_func
(paren
l_string|&quot;Unable to open &squot;boot&squot;&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|read
c_func
(paren
id|id
comma
id|buf
comma
id|MINIX_HEADER
)paren
op_ne
id|MINIX_HEADER
)paren
id|die
c_func
(paren
l_string|&quot;Unable to read header of &squot;boot&squot;&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
(paren
r_int
op_star
)paren
id|buf
)paren
(braket
l_int|0
)braket
op_ne
l_int|0x04100301
)paren
id|die
c_func
(paren
l_string|&quot;Non-Minix header of &squot;boot&squot;&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
(paren
r_int
op_star
)paren
id|buf
)paren
(braket
l_int|1
)braket
op_ne
id|MINIX_HEADER
)paren
id|die
c_func
(paren
l_string|&quot;Non-Minix header of &squot;boot&squot;&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
(paren
r_int
op_star
)paren
id|buf
)paren
(braket
l_int|3
)braket
op_ne
l_int|0
)paren
id|die
c_func
(paren
l_string|&quot;Illegal data segment in &squot;boot&squot;&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
(paren
r_int
op_star
)paren
id|buf
)paren
(braket
l_int|4
)braket
op_ne
l_int|0
)paren
id|die
c_func
(paren
l_string|&quot;Illegal bss in &squot;boot&squot;&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
(paren
r_int
op_star
)paren
id|buf
)paren
(braket
l_int|5
)braket
op_ne
l_int|0
)paren
id|die
c_func
(paren
l_string|&quot;Non-Minix header of &squot;boot&squot;&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
(paren
r_int
op_star
)paren
id|buf
)paren
(braket
l_int|7
)braket
op_ne
l_int|0
)paren
id|die
c_func
(paren
l_string|&quot;Illegal symbol table in &squot;boot&squot;&quot;
)paren
suffix:semicolon
id|i
op_assign
id|read
c_func
(paren
id|id
comma
id|buf
comma
r_sizeof
id|buf
)paren
suffix:semicolon
id|fprintf
c_func
(paren
id|stderr
comma
l_string|&quot;Boot sector %d bytes.&bslash;n&quot;
comma
id|i
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
OG
l_int|510
)paren
id|die
c_func
(paren
l_string|&quot;Boot block may not exceed 510 bytes&quot;
)paren
suffix:semicolon
id|buf
(braket
l_int|510
)braket
op_assign
l_int|0x55
suffix:semicolon
id|buf
(braket
l_int|511
)braket
op_assign
l_int|0xAA
suffix:semicolon
id|i
op_assign
id|write
c_func
(paren
l_int|1
comma
id|buf
comma
l_int|512
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
op_ne
l_int|512
)paren
id|die
c_func
(paren
l_string|&quot;Write call failed&quot;
)paren
suffix:semicolon
id|close
(paren
id|id
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|id
op_assign
id|open
c_func
(paren
id|argv
(braket
l_int|2
)braket
comma
id|O_RDONLY
comma
l_int|0
)paren
)paren
OL
l_int|0
)paren
id|die
c_func
(paren
l_string|&quot;Unable to open &squot;system&squot;&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|read
c_func
(paren
id|id
comma
id|buf
comma
id|GCC_HEADER
)paren
op_ne
id|GCC_HEADER
)paren
id|die
c_func
(paren
l_string|&quot;Unable to read header of &squot;system&squot;&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
(paren
r_int
op_star
)paren
id|buf
)paren
(braket
l_int|5
)braket
op_ne
l_int|0
)paren
id|die
c_func
(paren
l_string|&quot;Non-GCC header of &squot;system&squot;&quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
(paren
id|c
op_assign
id|read
c_func
(paren
id|id
comma
id|buf
comma
r_sizeof
id|buf
)paren
)paren
OG
l_int|0
suffix:semicolon
id|i
op_add_assign
id|c
)paren
r_if
c_cond
(paren
id|write
c_func
(paren
l_int|1
comma
id|buf
comma
id|c
)paren
op_ne
id|c
)paren
id|die
c_func
(paren
l_string|&quot;Write call failed&quot;
)paren
suffix:semicolon
id|close
c_func
(paren
id|id
)paren
suffix:semicolon
id|fprintf
c_func
(paren
id|stderr
comma
l_string|&quot;System %d bytes.&bslash;n&quot;
comma
id|i
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
eof
