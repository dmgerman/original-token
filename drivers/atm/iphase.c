multiline_comment|/******************************************************************************&n;         iphase.c: Device driver for Interphase ATM PCI adapter cards &n;                    Author: Peter Wang  &lt;pwang@iphase.com&gt;            &n;                   Interphase Corporation  &lt;www.iphase.com&gt;           &n;                               Version: 1.0                           &n;*******************************************************************************&n;      &n;      This software may be used and distributed according to the terms&n;      of the GNU Public License (GPL), incorporated herein by reference.&n;      Drivers based on this skeleton fall under the GPL and must retain&n;      the authorship (implicit copyright) notice.&n;&n;      This program is distributed in the hope that it will be useful, but&n;      WITHOUT ANY WARRANTY; without even the implied warranty of&n;      MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU&n;      General Public License for more details.&n;      &n;      Modified from an incomplete driver for Interphase 5575 1KVC 1M card which &n;      was originally written by Monalisa Agrawal at UNH. Now this driver &n;      supports a variety of varients of Interphase ATM PCI (i)Chip adapter &n;      card family (See www.iphase.com/products/ClassSheet.cfm?ClassID=ATM) &n;      in terms of PHY type, the size of control memory and the size of &n;      packet memory. The followings are the change log and history:&n;     &n;          Bugfix the Mona&squot;s UBR driver.&n;          Modify the basic memory allocation and dma logic.&n;          Port the driver to the latest kernel from 2.0.46.&n;          Complete the ABR logic of the driver, and added the ABR work-&n;              around for the hardware anormalies.&n;          Add the CBR support.&n;&t;  Add the flow control logic to the driver to allow rate-limit VC.&n;          Add 4K VC support to the board with 512K control memory.&n;          Add the support of all the variants of the Interphase ATM PCI &n;          (i)Chip adapter cards including x575 (155M OC3 and UTP155), x525&n;          (25M UTP25) and x531 (DS3 and E3).&n;          Add SMP support.&n;&n;      Support and updates available at: ftp://ftp.iphase.com/pub/atm&n;&n;*******************************************************************************/
macro_line|#ifdef IA_MODULE
DECL|macro|MODULE
mdefine_line|#define MODULE
macro_line|#endif
macro_line|#include &lt;linux/version.h&gt;
macro_line|#include &lt;linux/module.h&gt;  
macro_line|#include &lt;linux/kernel.h&gt;  
macro_line|#include &lt;linux/mm.h&gt;  
macro_line|#include &lt;linux/pci.h&gt;  
macro_line|#include &lt;linux/errno.h&gt;  
macro_line|#include &lt;linux/atm.h&gt;  
macro_line|#include &lt;linux/atmdev.h&gt;  
macro_line|#include &lt;linux/sonet.h&gt;  
macro_line|#include &lt;linux/skbuff.h&gt;  
macro_line|#include &lt;linux/time.h&gt;  
macro_line|#include &lt;linux/sched.h&gt; /* for xtime */  
macro_line|#include &lt;linux/delay.h&gt;  
macro_line|#include &lt;linux/uio.h&gt;  
macro_line|#include &lt;linux/init.h&gt;  
macro_line|#include &lt;asm/system.h&gt;  
macro_line|#include &lt;asm/io.h&gt;  
macro_line|#include &lt;asm/atomic.h&gt;  
macro_line|#include &lt;asm/uaccess.h&gt;  
macro_line|#include &lt;asm/string.h&gt;  
macro_line|#include &lt;asm/byteorder.h&gt;  
macro_line|#include &lt;math.h&gt;  
macro_line|#include &lt;linux/vmalloc.h&gt;  
macro_line|#include &quot;iphase.h&quot;&t;&t;  
macro_line|#include &quot;suni.h&quot;&t;&t;  
DECL|macro|swap
mdefine_line|#define swap(x) (((x &amp; 0xff) &lt;&lt; 8) | ((x &amp; 0xff00) &gt;&gt; 8))  
DECL|struct|suni_priv
r_struct
id|suni_priv
(brace
DECL|member|sonet_stats
r_struct
id|k_sonet_stats
id|sonet_stats
suffix:semicolon
multiline_comment|/* link diagnostics */
DECL|member|loop_mode
r_int
r_char
id|loop_mode
suffix:semicolon
multiline_comment|/* loopback mode */
DECL|member|dev
r_struct
id|atm_dev
op_star
id|dev
suffix:semicolon
multiline_comment|/* device back-pointer */
DECL|member|next
r_struct
id|suni_priv
op_star
id|next
suffix:semicolon
multiline_comment|/* next SUNI */
)brace
suffix:semicolon
DECL|macro|PRIV
mdefine_line|#define PRIV(dev) ((struct suni_priv *) dev-&gt;phy_data)
r_static
r_int
r_char
id|ia_phy_get
c_func
(paren
r_struct
id|atm_dev
op_star
id|dev
comma
r_int
r_int
id|addr
)paren
suffix:semicolon
DECL|variable|ia_dev
r_static
id|IADEV
op_star
id|ia_dev
(braket
l_int|8
)braket
op_assign
(brace
l_int|NULL
comma
l_int|NULL
comma
l_int|NULL
comma
l_int|NULL
comma
l_int|NULL
comma
l_int|NULL
comma
l_int|NULL
comma
l_int|NULL
)brace
suffix:semicolon
DECL|variable|_ia_dev
r_static
r_struct
id|atm_dev
op_star
id|_ia_dev
(braket
l_int|8
)braket
op_assign
(brace
l_int|NULL
comma
l_int|NULL
comma
l_int|NULL
comma
l_int|NULL
comma
l_int|NULL
comma
l_int|NULL
comma
l_int|NULL
comma
l_int|NULL
)brace
suffix:semicolon
DECL|variable|iadev_count
r_static
r_int
id|iadev_count
op_assign
l_int|0
suffix:semicolon
r_static
r_void
id|ia_led_timer
c_func
(paren
r_int
r_int
id|arg
)paren
suffix:semicolon
DECL|variable|ia_timer
r_static
r_struct
id|timer_list
id|ia_timer
op_assign
(brace
id|function
suffix:colon
id|ia_led_timer
)brace
suffix:semicolon
DECL|variable|vcc_close_que
r_struct
id|atm_vcc
op_star
id|vcc_close_que
(braket
l_int|100
)braket
suffix:semicolon
DECL|variable|IA_TX_BUF
DECL|variable|IA_TX_BUF_SZ
r_static
r_int
id|IA_TX_BUF
op_assign
id|DFL_TX_BUFFERS
comma
id|IA_TX_BUF_SZ
op_assign
id|DFL_TX_BUF_SZ
suffix:semicolon
DECL|variable|IA_RX_BUF
DECL|variable|IA_RX_BUF_SZ
r_static
r_int
id|IA_RX_BUF
op_assign
id|DFL_RX_BUFFERS
comma
id|IA_RX_BUF_SZ
op_assign
id|DFL_RX_BUF_SZ
suffix:semicolon
DECL|variable|IADebugFlag
r_static
id|u32
id|IADebugFlag
op_assign
multiline_comment|/* IF_IADBG_ERR | IF_IADBG_CBR| IF_IADBG_INIT_ADAPTER&n;            |IF_IADBG_ABR | IF_IADBG_EVENT*/
l_int|0
suffix:semicolon
macro_line|#ifdef MODULE
id|MODULE_PARM
c_func
(paren
id|IA_TX_BUF
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|IA_TX_BUF_SZ
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|IA_RX_BUF
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|IA_RX_BUF_SZ
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|IADebugFlag
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/**************************** IA_LIB **********************************/
DECL|function|ia_init_rtn_q
r_static
r_void
id|ia_init_rtn_q
(paren
id|IARTN_Q
op_star
id|que
)paren
(brace
id|que-&gt;next
op_assign
l_int|NULL
suffix:semicolon
id|que-&gt;tail
op_assign
l_int|NULL
suffix:semicolon
)brace
DECL|function|ia_enque_head_rtn_q
r_static
r_void
id|ia_enque_head_rtn_q
(paren
id|IARTN_Q
op_star
id|que
comma
id|IARTN_Q
op_star
id|data
)paren
(brace
id|data-&gt;next
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
id|que-&gt;next
op_eq
l_int|NULL
)paren
id|que-&gt;next
op_assign
id|que-&gt;tail
op_assign
id|data
suffix:semicolon
r_else
(brace
id|data-&gt;next
op_assign
id|que-&gt;next
suffix:semicolon
id|que-&gt;next
op_assign
id|data
suffix:semicolon
)brace
r_return
suffix:semicolon
)brace
DECL|function|ia_enque_rtn_q
r_static
r_int
id|ia_enque_rtn_q
(paren
id|IARTN_Q
op_star
id|que
comma
r_struct
id|desc_tbl_t
id|data
)paren
(brace
id|IARTN_Q
op_star
id|entry
suffix:semicolon
id|entry
op_assign
(paren
id|IARTN_Q
op_star
)paren
id|kmalloc
c_func
(paren
r_sizeof
(paren
id|IARTN_Q
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|entry
)paren
r_return
op_minus
l_int|1
suffix:semicolon
id|entry-&gt;data
op_assign
id|data
suffix:semicolon
id|entry-&gt;next
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
id|que-&gt;next
op_eq
l_int|NULL
)paren
id|que-&gt;next
op_assign
id|que-&gt;tail
op_assign
id|entry
suffix:semicolon
r_else
(brace
id|que-&gt;tail-&gt;next
op_assign
id|entry
suffix:semicolon
id|que-&gt;tail
op_assign
id|que-&gt;tail-&gt;next
suffix:semicolon
)brace
r_return
l_int|1
suffix:semicolon
)brace
DECL|function|ia_deque_rtn_q
r_static
id|IARTN_Q
op_star
id|ia_deque_rtn_q
(paren
id|IARTN_Q
op_star
id|que
)paren
(brace
id|IARTN_Q
op_star
id|tmpdata
suffix:semicolon
r_if
c_cond
(paren
id|que-&gt;next
op_eq
l_int|NULL
)paren
r_return
l_int|NULL
suffix:semicolon
id|tmpdata
op_assign
id|que-&gt;next
suffix:semicolon
r_if
c_cond
(paren
id|que-&gt;next
op_eq
id|que-&gt;tail
)paren
id|que-&gt;next
op_assign
id|que-&gt;tail
op_assign
l_int|NULL
suffix:semicolon
r_else
id|que-&gt;next
op_assign
id|que-&gt;next-&gt;next
suffix:semicolon
r_return
id|tmpdata
suffix:semicolon
)brace
DECL|function|ia_hack_tcq
r_static
r_void
id|ia_hack_tcq
c_func
(paren
id|IADEV
op_star
id|dev
)paren
(brace
id|u_short
id|desc1
suffix:semicolon
id|u_short
id|tcq_wr
suffix:semicolon
r_struct
id|ia_vcc
op_star
id|iavcc_r
op_assign
l_int|NULL
suffix:semicolon
r_extern
r_void
id|desc_dbg
c_func
(paren
id|IADEV
op_star
id|iadev
)paren
suffix:semicolon
id|tcq_wr
op_assign
id|readl
c_func
(paren
id|dev-&gt;seg_reg
op_plus
id|TCQ_WR_PTR
)paren
op_amp
l_int|0xffff
suffix:semicolon
r_while
c_loop
(paren
id|dev-&gt;host_tcq_wr
op_ne
id|tcq_wr
)paren
(brace
id|desc1
op_assign
op_star
(paren
id|u_short
op_star
)paren
(paren
id|dev-&gt;seg_ram
op_plus
id|dev-&gt;host_tcq_wr
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|desc1
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
op_logical_neg
id|dev-&gt;desc_tbl
(braket
id|desc1
op_minus
l_int|1
)braket
dot
id|timestamp
)paren
(brace
id|IF_ABR
c_func
(paren
id|printk
c_func
(paren
l_string|&quot; Desc %d is reset at %ld&bslash;n&quot;
comma
id|desc1
op_minus
l_int|1
comma
id|jiffies
)paren
suffix:semicolon
)paren
op_star
(paren
id|u_short
op_star
)paren
(paren
id|dev-&gt;seg_ram
op_plus
id|dev-&gt;host_tcq_wr
)paren
op_assign
l_int|0
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|dev-&gt;desc_tbl
(braket
id|desc1
op_minus
l_int|1
)braket
dot
id|timestamp
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|iavcc_r
op_assign
id|dev-&gt;desc_tbl
(braket
id|desc1
op_minus
l_int|1
)braket
dot
id|iavcc
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;IA: Fatal err in get_desc&bslash;n&quot;
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
id|iavcc_r-&gt;vc_desc_cnt
op_decrement
suffix:semicolon
id|dev-&gt;desc_tbl
(braket
id|desc1
op_minus
l_int|1
)braket
dot
id|timestamp
op_assign
l_int|0
suffix:semicolon
id|IF_EVENT
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;ia_hack: return_q skb = 0x%x desc = %d&bslash;n&quot;
comma
(paren
id|u32
)paren
id|dev-&gt;desc_tbl
(braket
id|desc1
op_minus
l_int|1
)braket
dot
id|txskb
comma
id|desc1
)paren
suffix:semicolon
)paren
r_if
c_cond
(paren
id|iavcc_r-&gt;pcr
OL
id|dev-&gt;rate_limit
)paren
(brace
id|IA_SKB_STATE
(paren
id|dev-&gt;desc_tbl
(braket
id|desc1
op_minus
l_int|1
)braket
dot
id|txskb
)paren
op_or_assign
id|IA_TX_DONE
suffix:semicolon
r_if
c_cond
(paren
id|ia_enque_rtn_q
c_func
(paren
op_amp
id|dev-&gt;tx_return_q
comma
id|dev-&gt;desc_tbl
(braket
id|desc1
op_minus
l_int|1
)braket
)paren
OL
l_int|0
)paren
id|printk
c_func
(paren
l_string|&quot;ia_hack_tcq: No memory available&bslash;n&quot;
)paren
suffix:semicolon
)brace
id|dev-&gt;desc_tbl
(braket
id|desc1
op_minus
l_int|1
)braket
dot
id|iavcc
op_assign
l_int|NULL
suffix:semicolon
id|dev-&gt;desc_tbl
(braket
id|desc1
op_minus
l_int|1
)braket
dot
id|txskb
op_assign
l_int|NULL
suffix:semicolon
)brace
id|dev-&gt;host_tcq_wr
op_add_assign
l_int|2
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;host_tcq_wr
OG
id|dev-&gt;ffL.tcq_ed
)paren
id|dev-&gt;host_tcq_wr
op_assign
id|dev-&gt;ffL.tcq_st
suffix:semicolon
)brace
)brace
multiline_comment|/* ia_hack_tcq */
DECL|function|get_desc
r_static
id|u16
id|get_desc
(paren
id|IADEV
op_star
id|dev
comma
r_struct
id|ia_vcc
op_star
id|iavcc
)paren
(brace
id|u_short
id|desc_num
comma
id|i
suffix:semicolon
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
r_struct
id|ia_vcc
op_star
id|iavcc_r
op_assign
l_int|NULL
suffix:semicolon
r_int
r_int
id|delta
suffix:semicolon
r_static
r_int
r_int
id|timer
op_assign
l_int|0
suffix:semicolon
r_int
id|ltimeout
suffix:semicolon
r_extern
r_void
id|desc_dbg
c_func
(paren
id|IADEV
op_star
id|iadev
)paren
suffix:semicolon
id|ia_hack_tcq
(paren
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
(paren
id|jiffies
op_minus
id|timer
)paren
OG
l_int|50
)paren
op_logical_or
(paren
(paren
id|dev-&gt;ffL.tcq_rd
op_eq
id|dev-&gt;host_tcq_wr
)paren
)paren
)paren
(brace
id|timer
op_assign
id|jiffies
suffix:semicolon
id|i
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
id|i
OL
id|dev-&gt;num_tx_desc
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|dev-&gt;desc_tbl
(braket
id|i
)braket
dot
id|timestamp
)paren
(brace
id|i
op_increment
suffix:semicolon
r_continue
suffix:semicolon
)brace
id|ltimeout
op_assign
id|dev-&gt;desc_tbl
(braket
id|i
)braket
dot
id|iavcc-&gt;ltimeout
suffix:semicolon
id|delta
op_assign
id|jiffies
op_minus
id|dev-&gt;desc_tbl
(braket
id|i
)braket
dot
id|timestamp
suffix:semicolon
r_if
c_cond
(paren
id|delta
op_ge
id|ltimeout
)paren
(brace
id|IF_ABR
c_func
(paren
id|printk
c_func
(paren
"&quot;"
id|RECOVER
id|run
op_logical_neg
op_logical_neg
id|desc_tbl
op_mod
id|d
op_assign
op_mod
id|d
id|delta
op_assign
op_mod
id|ld
comma
id|time
op_assign
op_mod
id|ld
"&bslash;"
id|n
"&quot;"
comma
id|i
comma
id|dev-&gt;desc_tbl
(braket
id|i
)braket
dot
id|timestamp
comma
id|delta
comma
id|jiffies
)paren
suffix:semicolon
)paren
r_if
c_cond
(paren
id|dev-&gt;ffL.tcq_rd
op_eq
id|dev-&gt;ffL.tcq_st
)paren
id|dev-&gt;ffL.tcq_rd
op_assign
id|dev-&gt;ffL.tcq_ed
suffix:semicolon
r_else
id|dev-&gt;ffL.tcq_rd
op_sub_assign
l_int|2
suffix:semicolon
op_star
(paren
id|u_short
op_star
)paren
(paren
id|dev-&gt;seg_ram
op_plus
id|dev-&gt;ffL.tcq_rd
)paren
op_assign
id|i
op_plus
l_int|1
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|skb
op_assign
id|dev-&gt;desc_tbl
(braket
id|i
)braket
dot
id|txskb
)paren
op_logical_or
op_logical_neg
(paren
id|iavcc_r
op_assign
id|dev-&gt;desc_tbl
(braket
id|i
)braket
dot
id|iavcc
)paren
)paren
id|printk
c_func
(paren
l_string|&quot;Fatal err, desc table vcc or skb is NULL&bslash;n&quot;
)paren
suffix:semicolon
r_else
id|iavcc_r-&gt;vc_desc_cnt
op_decrement
suffix:semicolon
id|dev-&gt;desc_tbl
(braket
id|i
)braket
dot
id|timestamp
op_assign
l_int|0
suffix:semicolon
id|dev-&gt;desc_tbl
(braket
id|i
)braket
dot
id|iavcc
op_assign
l_int|NULL
suffix:semicolon
id|dev-&gt;desc_tbl
(braket
id|i
)braket
dot
id|txskb
op_assign
l_int|NULL
suffix:semicolon
)brace
id|i
op_increment
suffix:semicolon
)brace
multiline_comment|/* while */
)brace
r_if
c_cond
(paren
id|dev-&gt;ffL.tcq_rd
op_eq
id|dev-&gt;host_tcq_wr
)paren
r_return
l_int|0xFFFF
suffix:semicolon
multiline_comment|/* Get the next available descriptor number from TCQ */
id|desc_num
op_assign
op_star
(paren
id|u_short
op_star
)paren
(paren
id|dev-&gt;seg_ram
op_plus
id|dev-&gt;ffL.tcq_rd
)paren
suffix:semicolon
r_while
c_loop
(paren
op_logical_neg
id|desc_num
op_logical_or
(paren
id|dev-&gt;desc_tbl
(braket
id|desc_num
op_minus
l_int|1
)braket
)paren
dot
id|timestamp
)paren
(brace
id|dev-&gt;ffL.tcq_rd
op_add_assign
l_int|2
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;ffL.tcq_rd
OG
id|dev-&gt;ffL.tcq_ed
)paren
id|dev-&gt;ffL.tcq_rd
op_assign
id|dev-&gt;ffL.tcq_st
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;ffL.tcq_rd
op_eq
id|dev-&gt;host_tcq_wr
)paren
r_return
l_int|0xFFFF
suffix:semicolon
id|desc_num
op_assign
op_star
(paren
id|u_short
op_star
)paren
(paren
id|dev-&gt;seg_ram
op_plus
id|dev-&gt;ffL.tcq_rd
)paren
suffix:semicolon
)brace
multiline_comment|/* get system time */
id|dev-&gt;desc_tbl
(braket
id|desc_num
op_minus
l_int|1
)braket
dot
id|timestamp
op_assign
id|jiffies
suffix:semicolon
r_return
id|desc_num
suffix:semicolon
)brace
DECL|function|clear_lockup
r_static
r_void
id|clear_lockup
(paren
r_struct
id|atm_vcc
op_star
id|vcc
comma
id|IADEV
op_star
id|dev
)paren
(brace
id|u_char
id|foundLockUp
suffix:semicolon
id|vcstatus_t
op_star
id|vcstatus
suffix:semicolon
id|u_short
op_star
id|shd_tbl
suffix:semicolon
id|u_short
id|tempCellSlot
comma
id|tempFract
suffix:semicolon
r_struct
id|main_vc
op_star
id|abr_vc
op_assign
(paren
r_struct
id|main_vc
op_star
)paren
id|dev-&gt;MAIN_VC_TABLE_ADDR
suffix:semicolon
r_struct
id|ext_vc
op_star
id|eabr_vc
op_assign
(paren
r_struct
id|ext_vc
op_star
)paren
id|dev-&gt;EXT_VC_TABLE_ADDR
suffix:semicolon
id|u_int
id|i
suffix:semicolon
r_if
c_cond
(paren
id|vcc-&gt;qos.txtp.traffic_class
op_eq
id|ATM_ABR
)paren
(brace
id|vcstatus
op_assign
(paren
id|vcstatus_t
op_star
)paren
op_amp
(paren
id|dev-&gt;testTable
(braket
id|vcc-&gt;vci
)braket
op_member_access_from_pointer
id|vc_status
)paren
suffix:semicolon
id|vcstatus-&gt;cnt
op_increment
suffix:semicolon
id|foundLockUp
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|vcstatus-&gt;cnt
op_eq
l_int|0x05
)paren
(brace
id|abr_vc
op_add_assign
id|vcc-&gt;vci
suffix:semicolon
id|eabr_vc
op_add_assign
id|vcc-&gt;vci
suffix:semicolon
r_if
c_cond
(paren
id|eabr_vc-&gt;last_desc
)paren
(brace
r_if
c_cond
(paren
(paren
id|abr_vc-&gt;status
op_amp
l_int|0x07
)paren
op_eq
id|ABR_STATE
multiline_comment|/* 0x2 */
)paren
(brace
multiline_comment|/* Wait for 10 Micro sec */
id|udelay
c_func
(paren
l_int|10
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|eabr_vc-&gt;last_desc
)paren
op_logical_and
(paren
(paren
id|abr_vc-&gt;status
op_amp
l_int|0x07
)paren
op_eq
id|ABR_STATE
)paren
)paren
id|foundLockUp
op_assign
l_int|1
suffix:semicolon
)brace
r_else
(brace
id|tempCellSlot
op_assign
id|abr_vc-&gt;last_cell_slot
suffix:semicolon
id|tempFract
op_assign
id|abr_vc-&gt;fraction
suffix:semicolon
r_if
c_cond
(paren
(paren
id|tempCellSlot
op_eq
id|dev-&gt;testTable
(braket
id|vcc-&gt;vci
)braket
op_member_access_from_pointer
id|lastTime
)paren
op_logical_and
(paren
id|tempFract
op_eq
id|dev-&gt;testTable
(braket
id|vcc-&gt;vci
)braket
op_member_access_from_pointer
id|fract
)paren
)paren
(brace
id|foundLockUp
op_assign
l_int|1
suffix:semicolon
)brace
id|dev-&gt;testTable
(braket
id|vcc-&gt;vci
)braket
op_member_access_from_pointer
id|lastTime
op_assign
id|tempCellSlot
suffix:semicolon
id|dev-&gt;testTable
(braket
id|vcc-&gt;vci
)braket
op_member_access_from_pointer
id|fract
op_assign
id|tempFract
suffix:semicolon
)brace
)brace
multiline_comment|/* last descriptor */
id|vcstatus-&gt;cnt
op_assign
l_int|0
suffix:semicolon
)brace
multiline_comment|/* vcstatus-&gt;cnt */
r_if
c_cond
(paren
id|foundLockUp
)paren
(brace
id|IF_ABR
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;LOCK UP found&bslash;n&quot;
)paren
suffix:semicolon
)paren
id|writew
c_func
(paren
l_int|0xFFFD
comma
id|dev-&gt;seg_reg
op_plus
id|MODE_REG_0
)paren
suffix:semicolon
multiline_comment|/* Wait for 10 Micro sec */
id|udelay
c_func
(paren
l_int|10
)paren
suffix:semicolon
id|abr_vc-&gt;status
op_and_assign
l_int|0xFFF8
suffix:semicolon
id|abr_vc-&gt;status
op_or_assign
l_int|0x0001
suffix:semicolon
multiline_comment|/* state is idle */
id|shd_tbl
op_assign
(paren
id|u_short
op_star
)paren
id|dev-&gt;ABR_SCHED_TABLE_ADDR
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
(paren
(paren
id|i
OL
id|dev-&gt;num_vc
)paren
op_logical_and
(paren
id|shd_tbl
(braket
id|i
)braket
)paren
)paren
suffix:semicolon
id|i
op_increment
)paren
(brace
suffix:semicolon
)brace
r_if
c_cond
(paren
id|i
OL
id|dev-&gt;num_vc
)paren
id|shd_tbl
(braket
id|i
)braket
op_assign
id|vcc-&gt;vci
suffix:semicolon
r_else
id|IF_ERR
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;ABR Seg. may not continue on VC %x&bslash;n&quot;
comma
id|vcc-&gt;vci
)paren
suffix:semicolon
)paren
id|writew
c_func
(paren
id|T_ONLINE
comma
id|dev-&gt;seg_reg
op_plus
id|MODE_REG_0
)paren
suffix:semicolon
id|writew
c_func
(paren
op_complement
(paren
id|TRANSMIT_DONE
op_or
id|TCQ_NOT_EMPTY
)paren
comma
id|dev-&gt;seg_reg
op_plus
id|SEG_MASK_REG
)paren
suffix:semicolon
id|writew
c_func
(paren
id|TRANSMIT_DONE
comma
id|dev-&gt;seg_reg
op_plus
id|SEG_INTR_STATUS_REG
)paren
suffix:semicolon
id|vcstatus-&gt;cnt
op_assign
l_int|0
suffix:semicolon
)brace
multiline_comment|/* foundLockUp */
)brace
multiline_comment|/* if an ABR VC */
)brace
multiline_comment|/*&n;** Conversion of 24-bit cellrate (cells/sec) to 16-bit floating point format.&n;**&n;**  +----+----+------------------+-------------------------------+&n;**  |  R | NZ |  5-bit exponent  |        9-bit mantissa         |&n;**  +----+----+------------------+-------------------------------+&n;** &n;**    R = reserverd (written as 0)&n;**    NZ = 0 if 0 cells/sec; 1 otherwise&n;**&n;**    if NZ = 1, rate = 1.mmmmmmmmm x 2^(eeeee) cells/sec&n;*/
r_static
id|u16
DECL|function|cellrate_to_float
id|cellrate_to_float
c_func
(paren
id|u32
id|cr
)paren
(brace
DECL|macro|NZ
mdefine_line|#define&t;NZ &t;&t;0x4000
DECL|macro|M_BITS
mdefine_line|#define&t;M_BITS&t;&t;9&t;&t;/* Number of bits in mantissa */
DECL|macro|E_BITS
mdefine_line|#define&t;E_BITS&t;&t;5&t;&t;/* Number of bits in exponent */
DECL|macro|M_MASK
mdefine_line|#define&t;M_MASK&t;&t;0x1ff&t;&t;
DECL|macro|E_MASK
mdefine_line|#define&t;E_MASK&t;&t;0x1f
id|u16
id|flot
suffix:semicolon
id|u32
id|tmp
op_assign
id|cr
op_amp
l_int|0x00ffffff
suffix:semicolon
r_int
id|i
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|cr
op_eq
l_int|0
)paren
r_return
l_int|0
suffix:semicolon
r_while
c_loop
(paren
id|tmp
op_ne
l_int|1
)paren
(brace
id|tmp
op_rshift_assign
l_int|1
suffix:semicolon
id|i
op_increment
suffix:semicolon
)brace
r_if
c_cond
(paren
id|i
op_eq
id|M_BITS
)paren
id|flot
op_assign
id|NZ
op_or
(paren
id|i
op_lshift
id|M_BITS
)paren
op_or
(paren
id|cr
op_amp
id|M_MASK
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
id|i
OL
id|M_BITS
)paren
id|flot
op_assign
id|NZ
op_or
(paren
id|i
op_lshift
id|M_BITS
)paren
op_or
(paren
(paren
id|cr
op_lshift
(paren
id|M_BITS
op_minus
id|i
)paren
)paren
op_amp
id|M_MASK
)paren
suffix:semicolon
r_else
id|flot
op_assign
id|NZ
op_or
(paren
id|i
op_lshift
id|M_BITS
)paren
op_or
(paren
(paren
id|cr
op_rshift
(paren
id|i
op_minus
id|M_BITS
)paren
)paren
op_amp
id|M_MASK
)paren
suffix:semicolon
r_return
id|flot
suffix:semicolon
)brace
macro_line|#if 0
multiline_comment|/*&n;** Conversion of 16-bit floating point format to 24-bit cellrate (cells/sec).&n;*/
r_static
id|u32
id|float_to_cellrate
c_func
(paren
id|u16
id|rate
)paren
(brace
id|u32
id|exp
comma
id|mantissa
comma
id|cps
suffix:semicolon
r_if
c_cond
(paren
(paren
id|rate
op_amp
id|NZ
)paren
op_eq
l_int|0
)paren
r_return
l_int|0
suffix:semicolon
id|exp
op_assign
(paren
id|rate
op_rshift
id|M_BITS
)paren
op_amp
id|E_MASK
suffix:semicolon
id|mantissa
op_assign
id|rate
op_amp
id|M_MASK
suffix:semicolon
r_if
c_cond
(paren
id|exp
op_eq
l_int|0
)paren
r_return
l_int|1
suffix:semicolon
id|cps
op_assign
(paren
l_int|1
op_lshift
id|M_BITS
)paren
op_or
id|mantissa
suffix:semicolon
r_if
c_cond
(paren
id|exp
op_eq
id|M_BITS
)paren
id|cps
op_assign
id|cps
suffix:semicolon
r_else
r_if
c_cond
(paren
id|exp
OG
id|M_BITS
)paren
id|cps
op_lshift_assign
(paren
id|exp
op_minus
id|M_BITS
)paren
suffix:semicolon
r_else
id|cps
op_rshift_assign
(paren
id|M_BITS
op_minus
id|exp
)paren
suffix:semicolon
r_return
id|cps
suffix:semicolon
)brace
macro_line|#endif 
DECL|function|init_abr_vc
r_static
r_void
id|init_abr_vc
(paren
id|IADEV
op_star
id|dev
comma
id|srv_cls_param_t
op_star
id|srv_p
)paren
(brace
id|srv_p-&gt;class_type
op_assign
id|ATM_ABR
suffix:semicolon
id|srv_p-&gt;pcr
op_assign
id|dev-&gt;LineRate
suffix:semicolon
id|srv_p-&gt;mcr
op_assign
l_int|0
suffix:semicolon
id|srv_p-&gt;icr
op_assign
l_int|0x055cb7
suffix:semicolon
id|srv_p-&gt;tbe
op_assign
l_int|0xffffff
suffix:semicolon
id|srv_p-&gt;frtt
op_assign
l_int|0x3a
suffix:semicolon
id|srv_p-&gt;rif
op_assign
l_int|0xf
suffix:semicolon
id|srv_p-&gt;rdf
op_assign
l_int|0xb
suffix:semicolon
id|srv_p-&gt;nrm
op_assign
l_int|0x4
suffix:semicolon
id|srv_p-&gt;trm
op_assign
l_int|0x7
suffix:semicolon
id|srv_p-&gt;cdf
op_assign
l_int|0x3
suffix:semicolon
id|srv_p-&gt;adtf
op_assign
l_int|50
suffix:semicolon
)brace
r_static
r_int
DECL|function|ia_open_abr_vc
id|ia_open_abr_vc
c_func
(paren
id|IADEV
op_star
id|dev
comma
id|srv_cls_param_t
op_star
id|srv_p
comma
r_struct
id|atm_vcc
op_star
id|vcc
comma
id|u8
id|flag
)paren
(brace
id|f_vc_abr_entry
op_star
id|f_abr_vc
suffix:semicolon
id|r_vc_abr_entry
op_star
id|r_abr_vc
suffix:semicolon
id|u32
id|icr
suffix:semicolon
id|u8
id|trm
comma
id|nrm
comma
id|crm
suffix:semicolon
id|u16
id|adtf
comma
id|air
comma
op_star
id|ptr16
suffix:semicolon
id|f_abr_vc
op_assign
(paren
id|f_vc_abr_entry
op_star
)paren
id|dev-&gt;MAIN_VC_TABLE_ADDR
suffix:semicolon
id|f_abr_vc
op_add_assign
id|vcc-&gt;vci
suffix:semicolon
r_switch
c_cond
(paren
id|flag
)paren
(brace
r_case
l_int|1
suffix:colon
multiline_comment|/* FFRED initialization */
macro_line|#if 0  /* sanity check */
r_if
c_cond
(paren
id|srv_p-&gt;pcr
op_eq
l_int|0
)paren
r_return
id|INVALID_PCR
suffix:semicolon
r_if
c_cond
(paren
id|srv_p-&gt;pcr
OG
id|dev-&gt;LineRate
)paren
id|srv_p-&gt;pcr
op_assign
id|dev-&gt;LineRate
suffix:semicolon
r_if
c_cond
(paren
(paren
id|srv_p-&gt;mcr
op_plus
id|dev-&gt;sum_mcr
)paren
OG
id|dev-&gt;LineRate
)paren
r_return
id|MCR_UNAVAILABLE
suffix:semicolon
r_if
c_cond
(paren
id|srv_p-&gt;mcr
OG
id|srv_p-&gt;pcr
)paren
r_return
id|INVALID_MCR
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|srv_p-&gt;icr
)paren
)paren
id|srv_p-&gt;icr
op_assign
id|srv_p-&gt;pcr
suffix:semicolon
r_if
c_cond
(paren
(paren
id|srv_p-&gt;icr
OL
id|srv_p-&gt;mcr
)paren
op_logical_or
(paren
id|srv_p-&gt;icr
OG
id|srv_p-&gt;pcr
)paren
)paren
r_return
id|INVALID_ICR
suffix:semicolon
r_if
c_cond
(paren
(paren
id|srv_p-&gt;tbe
OL
id|MIN_TBE
)paren
op_logical_or
(paren
id|srv_p-&gt;tbe
OG
id|MAX_TBE
)paren
)paren
r_return
id|INVALID_TBE
suffix:semicolon
r_if
c_cond
(paren
(paren
id|srv_p-&gt;frtt
OL
id|MIN_FRTT
)paren
op_logical_or
(paren
id|srv_p-&gt;frtt
OG
id|MAX_FRTT
)paren
)paren
r_return
id|INVALID_FRTT
suffix:semicolon
r_if
c_cond
(paren
id|srv_p-&gt;nrm
OG
id|MAX_NRM
)paren
r_return
id|INVALID_NRM
suffix:semicolon
r_if
c_cond
(paren
id|srv_p-&gt;trm
OG
id|MAX_TRM
)paren
r_return
id|INVALID_TRM
suffix:semicolon
r_if
c_cond
(paren
id|srv_p-&gt;adtf
OG
id|MAX_ADTF
)paren
r_return
id|INVALID_ADTF
suffix:semicolon
r_else
r_if
c_cond
(paren
id|srv_p-&gt;adtf
op_eq
l_int|0
)paren
id|srv_p-&gt;adtf
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|srv_p-&gt;cdf
OG
id|MAX_CDF
)paren
r_return
id|INVALID_CDF
suffix:semicolon
r_if
c_cond
(paren
id|srv_p-&gt;rif
OG
id|MAX_RIF
)paren
r_return
id|INVALID_RIF
suffix:semicolon
r_if
c_cond
(paren
id|srv_p-&gt;rdf
OG
id|MAX_RDF
)paren
r_return
id|INVALID_RDF
suffix:semicolon
macro_line|#endif
id|memset
(paren
(paren
id|caddr_t
)paren
id|f_abr_vc
comma
l_int|0
comma
r_sizeof
(paren
id|f_vc_abr_entry
)paren
)paren
suffix:semicolon
id|f_abr_vc-&gt;f_vc_type
op_assign
id|ABR
suffix:semicolon
id|nrm
op_assign
l_int|2
op_lshift
id|srv_p-&gt;nrm
suffix:semicolon
multiline_comment|/* (2 ** (srv_p-&gt;nrm +1)) */
multiline_comment|/* i.e 2**n = 2 &lt;&lt; (n-1) */
id|f_abr_vc-&gt;f_nrm
op_assign
id|nrm
op_lshift
l_int|8
op_or
id|nrm
suffix:semicolon
id|trm
op_assign
l_int|100000
op_div
(paren
l_int|2
op_lshift
(paren
l_int|16
op_minus
id|srv_p-&gt;trm
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|trm
op_eq
l_int|0
)paren
id|trm
op_assign
l_int|1
suffix:semicolon
id|f_abr_vc-&gt;f_nrmexp
op_assign
(paren
(paren
(paren
id|srv_p-&gt;nrm
op_plus
l_int|1
)paren
op_amp
l_int|0x0f
)paren
op_lshift
l_int|12
)paren
op_or
(paren
id|MRM
op_lshift
l_int|8
)paren
op_or
id|trm
suffix:semicolon
id|crm
op_assign
id|srv_p-&gt;tbe
op_div
id|nrm
suffix:semicolon
r_if
c_cond
(paren
id|crm
op_eq
l_int|0
)paren
id|crm
op_assign
l_int|1
suffix:semicolon
id|f_abr_vc-&gt;f_crm
op_assign
id|crm
op_amp
l_int|0xff
suffix:semicolon
id|f_abr_vc-&gt;f_pcr
op_assign
id|cellrate_to_float
c_func
(paren
id|srv_p-&gt;pcr
)paren
suffix:semicolon
id|icr
op_assign
id|MIN
c_func
(paren
id|srv_p-&gt;icr
comma
(paren
id|srv_p-&gt;tbe
OG
id|srv_p-&gt;frtt
)paren
ques
c_cond
(paren
(paren
id|srv_p-&gt;tbe
op_div
id|srv_p-&gt;frtt
)paren
op_star
l_int|1000000
)paren
suffix:colon
(paren
l_int|1000000
op_div
(paren
id|srv_p-&gt;frtt
op_div
id|srv_p-&gt;tbe
)paren
)paren
)paren
suffix:semicolon
id|f_abr_vc-&gt;f_icr
op_assign
id|cellrate_to_float
c_func
(paren
id|icr
)paren
suffix:semicolon
id|adtf
op_assign
(paren
l_int|10000
op_star
id|srv_p-&gt;adtf
)paren
op_div
l_int|8192
suffix:semicolon
r_if
c_cond
(paren
id|adtf
op_eq
l_int|0
)paren
id|adtf
op_assign
l_int|1
suffix:semicolon
id|f_abr_vc-&gt;f_cdf
op_assign
(paren
(paren
l_int|7
op_minus
id|srv_p-&gt;cdf
)paren
op_lshift
l_int|12
op_or
id|adtf
)paren
op_amp
l_int|0xfff
suffix:semicolon
id|f_abr_vc-&gt;f_mcr
op_assign
id|cellrate_to_float
c_func
(paren
id|srv_p-&gt;mcr
)paren
suffix:semicolon
id|f_abr_vc-&gt;f_acr
op_assign
id|f_abr_vc-&gt;f_icr
suffix:semicolon
id|f_abr_vc-&gt;f_status
op_assign
l_int|0x0042
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0
suffix:colon
multiline_comment|/* RFRED initialization */
id|ptr16
op_assign
(paren
id|u_short
op_star
)paren
(paren
id|dev-&gt;reass_ram
op_plus
id|REASS_TABLE
op_star
id|dev-&gt;memSize
)paren
suffix:semicolon
op_star
(paren
id|ptr16
op_plus
id|vcc-&gt;vci
)paren
op_assign
id|NO_AAL5_PKT
op_or
id|REASS_ABR
suffix:semicolon
id|r_abr_vc
op_assign
(paren
id|r_vc_abr_entry
op_star
)paren
(paren
id|dev-&gt;reass_ram
op_plus
id|ABR_VC_TABLE
op_star
id|dev-&gt;memSize
)paren
suffix:semicolon
id|r_abr_vc
op_add_assign
id|vcc-&gt;vci
suffix:semicolon
id|r_abr_vc-&gt;r_status_rdf
op_assign
(paren
l_int|15
op_minus
id|srv_p-&gt;rdf
)paren
op_amp
l_int|0x000f
suffix:semicolon
id|air
op_assign
id|srv_p-&gt;pcr
op_lshift
(paren
l_int|15
op_minus
id|srv_p-&gt;rif
)paren
suffix:semicolon
r_if
c_cond
(paren
id|air
op_eq
l_int|0
)paren
id|air
op_assign
l_int|1
suffix:semicolon
id|r_abr_vc-&gt;r_air
op_assign
id|cellrate_to_float
c_func
(paren
id|air
)paren
suffix:semicolon
id|dev-&gt;testTable
(braket
id|vcc-&gt;vci
)braket
op_member_access_from_pointer
id|vc_status
op_assign
id|VC_ACTIVE
op_or
id|VC_ABR
suffix:semicolon
id|dev-&gt;sum_mcr
op_add_assign
id|srv_p-&gt;mcr
suffix:semicolon
id|dev-&gt;n_abr
op_increment
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
r_break
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|ia_cbr_setup
r_static
r_int
id|ia_cbr_setup
(paren
id|IADEV
op_star
id|dev
comma
r_struct
id|atm_vcc
op_star
id|vcc
)paren
(brace
id|u32
id|rateLow
op_assign
l_int|0
comma
id|rateHigh
comma
id|rate
suffix:semicolon
r_int
id|entries
suffix:semicolon
r_struct
id|ia_vcc
op_star
id|ia_vcc
suffix:semicolon
r_int
id|idealSlot
op_assign
l_int|0
comma
id|testSlot
comma
id|toBeAssigned
comma
id|inc
suffix:semicolon
id|u32
id|spacing
suffix:semicolon
id|u16
op_star
id|SchedTbl
comma
op_star
id|TstSchedTbl
suffix:semicolon
id|u16
id|cbrVC
comma
id|vcIndex
suffix:semicolon
id|u32
id|fracSlot
op_assign
l_int|0
suffix:semicolon
id|u32
id|sp_mod
op_assign
l_int|0
suffix:semicolon
id|u32
id|sp_mod2
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* IpAdjustTrafficParams */
r_if
c_cond
(paren
id|vcc-&gt;qos.txtp.max_pcr
op_le
l_int|0
)paren
(brace
id|IF_ERR
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;PCR for CBR not defined&bslash;n&quot;
)paren
suffix:semicolon
)paren
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|rate
op_assign
id|vcc-&gt;qos.txtp.max_pcr
suffix:semicolon
id|entries
op_assign
id|rate
op_div
id|dev-&gt;Granularity
suffix:semicolon
id|IF_CBR
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;CBR: CBR entries=0x%x for rate=0x%x &amp; Gran=0x%x&bslash;n&quot;
comma
id|entries
comma
id|rate
comma
id|dev-&gt;Granularity
)paren
suffix:semicolon
)paren
r_if
c_cond
(paren
id|entries
OL
l_int|1
)paren
id|IF_CBR
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;CBR: Bandwidth smaller than granularity of CBR table&bslash;n&quot;
)paren
suffix:semicolon
)paren
id|rateLow
op_assign
id|entries
op_star
id|dev-&gt;Granularity
suffix:semicolon
id|rateHigh
op_assign
(paren
id|entries
op_plus
l_int|1
)paren
op_star
id|dev-&gt;Granularity
suffix:semicolon
r_if
c_cond
(paren
l_int|3
op_star
(paren
id|rate
op_minus
id|rateLow
)paren
OG
(paren
id|rateHigh
op_minus
id|rate
)paren
)paren
id|entries
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|entries
OG
id|dev-&gt;CbrRemEntries
)paren
(brace
id|IF_CBR
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;CBR: Not enough bandwidth to support this PCR.&bslash;n&quot;
)paren
suffix:semicolon
)paren
id|IF_CBR
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;Entries = 0x%x, CbrRemEntries = 0x%x.&bslash;n&quot;
comma
id|entries
comma
id|dev-&gt;CbrRemEntries
)paren
suffix:semicolon
)paren
r_return
op_minus
id|EBUSY
suffix:semicolon
)brace
id|ia_vcc
op_assign
id|INPH_IA_VCC
c_func
(paren
id|vcc
)paren
suffix:semicolon
id|ia_vcc-&gt;NumCbrEntry
op_assign
id|entries
suffix:semicolon
id|dev-&gt;sum_mcr
op_add_assign
id|entries
op_star
id|dev-&gt;Granularity
suffix:semicolon
multiline_comment|/* IaFFrednInsertCbrSched */
singleline_comment|// Starting at an arbitrary location, place the entries into the table
singleline_comment|// as smoothly as possible
id|cbrVC
op_assign
l_int|0
suffix:semicolon
id|spacing
op_assign
id|dev-&gt;CbrTotEntries
op_div
id|entries
suffix:semicolon
id|sp_mod
op_assign
id|dev-&gt;CbrTotEntries
op_mod
id|entries
suffix:semicolon
singleline_comment|// get modulo
id|toBeAssigned
op_assign
id|entries
suffix:semicolon
id|fracSlot
op_assign
l_int|0
suffix:semicolon
id|vcIndex
op_assign
id|vcc-&gt;vci
suffix:semicolon
id|IF_CBR
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;Vci=0x%x,Spacing=0x%x,Sp_mod=0x%x&bslash;n&quot;
comma
id|vcIndex
comma
id|spacing
comma
id|sp_mod
)paren
suffix:semicolon
)paren
r_while
c_loop
(paren
id|toBeAssigned
)paren
(brace
singleline_comment|// If this is the first time, start the table loading for this connection
singleline_comment|// as close to entryPoint as possible.
r_if
c_cond
(paren
id|toBeAssigned
op_eq
id|entries
)paren
(brace
id|idealSlot
op_assign
id|dev-&gt;CbrEntryPt
suffix:semicolon
id|dev-&gt;CbrEntryPt
op_add_assign
l_int|2
suffix:semicolon
singleline_comment|// Adding 2 helps to prevent clumping
r_if
c_cond
(paren
id|dev-&gt;CbrEntryPt
op_ge
id|dev-&gt;CbrTotEntries
)paren
id|dev-&gt;CbrEntryPt
op_sub_assign
id|dev-&gt;CbrTotEntries
suffix:semicolon
singleline_comment|// Wrap if necessary
)brace
r_else
(brace
id|idealSlot
op_add_assign
(paren
id|u32
)paren
(paren
id|spacing
op_plus
id|fracSlot
)paren
suffix:semicolon
singleline_comment|// Point to the next location
singleline_comment|// in the table that would be  smoothest
id|fracSlot
op_assign
(paren
(paren
id|sp_mod
op_plus
id|sp_mod2
)paren
op_div
id|entries
)paren
suffix:semicolon
singleline_comment|// get new integer part
id|sp_mod2
op_assign
(paren
(paren
id|sp_mod
op_plus
id|sp_mod2
)paren
op_mod
id|entries
)paren
suffix:semicolon
singleline_comment|// calc new fractional part
)brace
r_if
c_cond
(paren
id|idealSlot
op_ge
(paren
r_int
)paren
id|dev-&gt;CbrTotEntries
)paren
id|idealSlot
op_sub_assign
id|dev-&gt;CbrTotEntries
suffix:semicolon
singleline_comment|// Continuously check around this ideal value until a null
singleline_comment|// location is encountered.
id|SchedTbl
op_assign
(paren
id|u16
op_star
)paren
(paren
id|dev-&gt;seg_ram
op_plus
id|CBR_SCHED_TABLE
op_star
id|dev-&gt;memSize
)paren
suffix:semicolon
id|inc
op_assign
l_int|0
suffix:semicolon
id|testSlot
op_assign
id|idealSlot
suffix:semicolon
id|TstSchedTbl
op_assign
(paren
id|u16
op_star
)paren
(paren
id|SchedTbl
op_plus
id|testSlot
)paren
suffix:semicolon
singleline_comment|//set index and read in value
id|IF_CBR
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;CBR Testslot 0x%x AT Location 0x%x, NumToAssign=%d&bslash;n&quot;
comma
id|testSlot
comma
(paren
id|u32
)paren
id|TstSchedTbl
comma
id|toBeAssigned
)paren
suffix:semicolon
)paren
id|memcpy
c_func
(paren
(paren
id|caddr_t
)paren
op_amp
id|cbrVC
comma
(paren
id|caddr_t
)paren
id|TstSchedTbl
comma
r_sizeof
(paren
id|u16
)paren
)paren
suffix:semicolon
r_while
c_loop
(paren
id|cbrVC
)paren
singleline_comment|// If another VC at this location, we have to keep looking
(brace
id|inc
op_increment
suffix:semicolon
id|testSlot
op_assign
id|idealSlot
op_minus
id|inc
suffix:semicolon
r_if
c_cond
(paren
id|testSlot
OL
l_int|0
)paren
(brace
singleline_comment|// Wrap if necessary
id|testSlot
op_add_assign
id|dev-&gt;CbrTotEntries
suffix:semicolon
id|IF_CBR
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;Testslot Wrap. STable Start=0x%x,Testslot=%d&bslash;n&quot;
comma
(paren
id|u32
)paren
id|SchedTbl
comma
id|testSlot
)paren
suffix:semicolon
)paren
)brace
id|TstSchedTbl
op_assign
(paren
id|u16
op_star
)paren
(paren
id|SchedTbl
op_plus
id|testSlot
)paren
suffix:semicolon
singleline_comment|// set table index
id|memcpy
c_func
(paren
(paren
id|caddr_t
)paren
op_amp
id|cbrVC
comma
(paren
id|caddr_t
)paren
id|TstSchedTbl
comma
r_sizeof
(paren
id|u16
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|cbrVC
)paren
r_break
suffix:semicolon
id|testSlot
op_assign
id|idealSlot
op_plus
id|inc
suffix:semicolon
r_if
c_cond
(paren
id|testSlot
op_ge
(paren
r_int
)paren
id|dev-&gt;CbrTotEntries
)paren
(brace
singleline_comment|// Wrap if necessary
id|testSlot
op_sub_assign
id|dev-&gt;CbrTotEntries
suffix:semicolon
id|IF_CBR
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;TotCbrEntries=%d&quot;
comma
id|dev-&gt;CbrTotEntries
)paren
suffix:semicolon
)paren
id|IF_CBR
c_func
(paren
id|printk
c_func
(paren
l_string|&quot; Testslot=0x%x ToBeAssgned=%d&bslash;n&quot;
comma
id|testSlot
comma
id|toBeAssigned
)paren
suffix:semicolon
)paren
)brace
singleline_comment|// set table index and read in value
id|TstSchedTbl
op_assign
(paren
id|u16
op_star
)paren
(paren
id|SchedTbl
op_plus
id|testSlot
)paren
suffix:semicolon
id|IF_CBR
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;Reading CBR Tbl from 0x%x, CbrVal=0x%x Iteration %d&bslash;n&quot;
comma
(paren
id|u32
)paren
id|TstSchedTbl
comma
id|cbrVC
comma
id|inc
)paren
suffix:semicolon
)paren
id|memcpy
c_func
(paren
(paren
id|caddr_t
)paren
op_amp
id|cbrVC
comma
(paren
id|caddr_t
)paren
id|TstSchedTbl
comma
r_sizeof
(paren
id|u16
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/* while */
singleline_comment|// Move this VCI number into this location of the CBR Sched table.
id|memcpy
c_func
(paren
(paren
id|caddr_t
)paren
id|TstSchedTbl
comma
(paren
id|caddr_t
)paren
op_amp
id|vcIndex
comma
r_sizeof
(paren
id|u16
)paren
)paren
suffix:semicolon
id|dev-&gt;CbrRemEntries
op_decrement
suffix:semicolon
id|toBeAssigned
op_decrement
suffix:semicolon
)brace
multiline_comment|/* while */
multiline_comment|/* IaFFrednCbrEnable */
id|dev-&gt;NumEnabledCBR
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;NumEnabledCBR
op_eq
l_int|1
)paren
(brace
id|writew
c_func
(paren
(paren
id|CBR_EN
op_or
id|UBR_EN
op_or
id|ABR_EN
op_or
(paren
l_int|0x23
op_lshift
l_int|2
)paren
)paren
comma
id|dev-&gt;seg_reg
op_plus
id|STPARMS
)paren
suffix:semicolon
id|IF_CBR
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;CBR is enabled&bslash;n&quot;
)paren
suffix:semicolon
)paren
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|ia_cbrVc_close
r_static
r_void
id|ia_cbrVc_close
(paren
r_struct
id|atm_vcc
op_star
id|vcc
)paren
(brace
id|IADEV
op_star
id|iadev
suffix:semicolon
id|u16
op_star
id|SchedTbl
comma
id|NullVci
op_assign
l_int|0
suffix:semicolon
id|u32
id|i
comma
id|NumFound
suffix:semicolon
id|iadev
op_assign
id|INPH_IA_DEV
c_func
(paren
id|vcc-&gt;dev
)paren
suffix:semicolon
id|iadev-&gt;NumEnabledCBR
op_decrement
suffix:semicolon
id|SchedTbl
op_assign
(paren
id|u16
op_star
)paren
(paren
id|iadev-&gt;seg_ram
op_plus
id|CBR_SCHED_TABLE
op_star
id|iadev-&gt;memSize
)paren
suffix:semicolon
r_if
c_cond
(paren
id|iadev-&gt;NumEnabledCBR
op_eq
l_int|0
)paren
(brace
id|writew
c_func
(paren
(paren
id|UBR_EN
op_or
id|ABR_EN
op_or
(paren
l_int|0x23
op_lshift
l_int|2
)paren
)paren
comma
id|iadev-&gt;seg_reg
op_plus
id|STPARMS
)paren
suffix:semicolon
id|IF_CBR
(paren
id|printk
c_func
(paren
l_string|&quot;CBR support disabled&bslash;n&quot;
)paren
suffix:semicolon
)paren
)brace
id|NumFound
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|iadev-&gt;CbrTotEntries
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
op_star
id|SchedTbl
op_eq
id|vcc-&gt;vci
)paren
(brace
id|iadev-&gt;CbrRemEntries
op_increment
suffix:semicolon
op_star
id|SchedTbl
op_assign
id|NullVci
suffix:semicolon
id|IF_CBR
c_func
(paren
id|NumFound
op_increment
suffix:semicolon
)paren
)brace
id|SchedTbl
op_increment
suffix:semicolon
)brace
id|IF_CBR
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;Exit ia_cbrVc_close, NumRemoved=%d&bslash;n&quot;
comma
id|NumFound
)paren
suffix:semicolon
)paren
)brace
DECL|function|ia_avail_descs
r_static
r_int
id|ia_avail_descs
c_func
(paren
id|IADEV
op_star
id|iadev
)paren
(brace
r_int
id|tmp
op_assign
l_int|0
suffix:semicolon
id|ia_hack_tcq
c_func
(paren
id|iadev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|iadev-&gt;host_tcq_wr
op_ge
id|iadev-&gt;ffL.tcq_rd
)paren
id|tmp
op_assign
(paren
id|iadev-&gt;host_tcq_wr
op_minus
id|iadev-&gt;ffL.tcq_rd
)paren
op_div
l_int|2
suffix:semicolon
r_else
id|tmp
op_assign
(paren
id|iadev-&gt;ffL.tcq_ed
op_minus
id|iadev-&gt;ffL.tcq_rd
op_plus
l_int|2
op_plus
id|iadev-&gt;host_tcq_wr
op_minus
id|iadev-&gt;ffL.tcq_st
)paren
op_div
l_int|2
suffix:semicolon
r_return
id|tmp
suffix:semicolon
)brace
DECL|function|ia_que_tx
r_static
r_int
id|ia_que_tx
(paren
id|IADEV
op_star
id|iadev
)paren
(brace
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
r_int
id|num_desc
suffix:semicolon
r_struct
id|atm_vcc
op_star
id|vcc
suffix:semicolon
r_struct
id|ia_vcc
op_star
id|iavcc
suffix:semicolon
r_static
r_int
id|ia_pkt_tx
(paren
r_struct
id|atm_vcc
op_star
id|vcc
comma
r_struct
id|sk_buff
op_star
id|skb
)paren
suffix:semicolon
id|num_desc
op_assign
id|ia_avail_descs
c_func
(paren
id|iadev
)paren
suffix:semicolon
r_while
c_loop
(paren
id|num_desc
op_logical_and
(paren
id|skb
op_assign
id|skb_dequeue
c_func
(paren
op_amp
id|iadev-&gt;tx_backlog
)paren
)paren
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|vcc
op_assign
id|ATM_SKB
c_func
(paren
id|skb
)paren
op_member_access_from_pointer
id|vcc
)paren
)paren
(brace
id|dev_kfree_skb_any
c_func
(paren
id|skb
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;ia_que_tx: Null vcc&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|test_bit
c_func
(paren
id|ATM_VF_READY
comma
op_amp
id|vcc-&gt;flags
)paren
)paren
(brace
id|dev_kfree_skb_any
c_func
(paren
id|skb
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;Free the SKB on closed vci %d &bslash;n&quot;
comma
id|vcc-&gt;vci
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|iavcc
op_assign
id|INPH_IA_VCC
c_func
(paren
id|vcc
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ia_pkt_tx
(paren
id|vcc
comma
id|skb
)paren
)paren
(brace
id|skb_queue_head
c_func
(paren
op_amp
id|iadev-&gt;tx_backlog
comma
id|skb
)paren
suffix:semicolon
)brace
id|num_desc
op_decrement
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|ia_tx_poll
r_void
id|ia_tx_poll
(paren
id|IADEV
op_star
id|iadev
)paren
(brace
r_struct
id|atm_vcc
op_star
id|vcc
op_assign
l_int|NULL
suffix:semicolon
r_struct
id|sk_buff
op_star
id|skb
op_assign
l_int|NULL
comma
op_star
id|skb1
op_assign
l_int|NULL
suffix:semicolon
r_struct
id|ia_vcc
op_star
id|iavcc
suffix:semicolon
id|IARTN_Q
op_star
id|rtne
suffix:semicolon
id|ia_hack_tcq
c_func
(paren
id|iadev
)paren
suffix:semicolon
r_while
c_loop
(paren
(paren
id|rtne
op_assign
id|ia_deque_rtn_q
c_func
(paren
op_amp
id|iadev-&gt;tx_return_q
)paren
)paren
)paren
(brace
id|skb
op_assign
id|rtne-&gt;data.txskb
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|skb
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;ia_tx_poll: skb is null&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|vcc
op_assign
id|ATM_SKB
c_func
(paren
id|skb
)paren
op_member_access_from_pointer
id|vcc
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|vcc
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;ia_tx_poll: vcc is null&bslash;n&quot;
)paren
suffix:semicolon
id|dev_kfree_skb_any
c_func
(paren
id|skb
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|iavcc
op_assign
id|INPH_IA_VCC
c_func
(paren
id|vcc
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|iavcc
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;ia_tx_poll: iavcc is null&bslash;n&quot;
)paren
suffix:semicolon
id|dev_kfree_skb_any
c_func
(paren
id|skb
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|skb1
op_assign
id|skb_dequeue
c_func
(paren
op_amp
id|iavcc-&gt;txing_skb
)paren
suffix:semicolon
r_while
c_loop
(paren
id|skb1
op_logical_and
(paren
id|skb1
op_ne
id|skb
)paren
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|IA_SKB_STATE
c_func
(paren
id|skb1
)paren
op_amp
id|IA_TX_DONE
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;IA_tx_intr: Vci %d lost pkt!!!&bslash;n&quot;
comma
id|vcc-&gt;vci
)paren
suffix:semicolon
)brace
id|IF_ERR
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;Release the SKB not match&bslash;n&quot;
)paren
suffix:semicolon
)paren
r_if
c_cond
(paren
id|vcc
op_logical_and
(paren
id|vcc-&gt;pop
)paren
op_logical_and
(paren
id|skb1-&gt;len
op_ne
l_int|0
)paren
)paren
(brace
id|vcc
op_member_access_from_pointer
id|pop
c_func
(paren
id|vcc
comma
id|skb1
)paren
suffix:semicolon
id|IF_EVENT
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;Tansmit Done - skb 0x%lx return&bslash;n&quot;
comma
(paren
r_int
)paren
id|skb1
)paren
suffix:semicolon
)paren
)brace
r_else
id|dev_kfree_skb_any
c_func
(paren
id|skb1
)paren
suffix:semicolon
id|skb1
op_assign
id|skb_dequeue
c_func
(paren
op_amp
id|iavcc-&gt;txing_skb
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|skb1
)paren
(brace
id|IF_EVENT
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;IA: Vci %d - skb not found requed&bslash;n&quot;
comma
id|vcc-&gt;vci
)paren
suffix:semicolon
)paren
id|ia_enque_head_rtn_q
(paren
op_amp
id|iadev-&gt;tx_return_q
comma
id|rtne
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|vcc
op_logical_and
(paren
id|vcc-&gt;pop
)paren
op_logical_and
(paren
id|skb-&gt;len
op_ne
l_int|0
)paren
)paren
(brace
id|vcc
op_member_access_from_pointer
id|pop
c_func
(paren
id|vcc
comma
id|skb
)paren
suffix:semicolon
id|IF_EVENT
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;Tx Done - skb 0x%lx return&bslash;n&quot;
comma
(paren
r_int
)paren
id|skb
)paren
suffix:semicolon
)paren
)brace
r_else
id|dev_kfree_skb_any
c_func
(paren
id|skb
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|rtne
)paren
suffix:semicolon
)brace
id|ia_que_tx
c_func
(paren
id|iadev
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
macro_line|#if 0
r_static
r_void
id|ia_eeprom_put
(paren
id|IADEV
op_star
id|iadev
comma
id|u32
id|addr
comma
id|u_short
id|val
)paren
(brace
id|u32
id|t
suffix:semicolon
r_int
id|i
suffix:semicolon
multiline_comment|/*&n;&t; * Issue a command to enable writes to the NOVRAM&n;&t; */
id|NVRAM_CMD
(paren
id|EXTEND
op_plus
id|EWEN
)paren
suffix:semicolon
id|NVRAM_CLR_CE
suffix:semicolon
multiline_comment|/*&n;&t; * issue the write command&n;&t; */
id|NVRAM_CMD
c_func
(paren
id|IAWRITE
op_plus
id|addr
)paren
suffix:semicolon
multiline_comment|/* &n;&t; * Send the data, starting with D15, then D14, and so on for 16 bits&n;&t; */
r_for
c_loop
(paren
id|i
op_assign
l_int|15
suffix:semicolon
id|i
op_ge
l_int|0
suffix:semicolon
id|i
op_decrement
)paren
(brace
id|NVRAM_CLKOUT
(paren
id|val
op_amp
l_int|0x8000
)paren
suffix:semicolon
id|val
op_lshift_assign
l_int|1
suffix:semicolon
)brace
id|NVRAM_CLR_CE
suffix:semicolon
id|CFG_OR
c_func
(paren
id|NVCE
)paren
suffix:semicolon
id|t
op_assign
id|readl
c_func
(paren
id|iadev-&gt;reg
op_plus
id|IPHASE5575_EEPROM_ACCESS
)paren
suffix:semicolon
r_while
c_loop
(paren
op_logical_neg
(paren
id|t
op_amp
id|NVDO
)paren
)paren
id|t
op_assign
id|readl
c_func
(paren
id|iadev-&gt;reg
op_plus
id|IPHASE5575_EEPROM_ACCESS
)paren
suffix:semicolon
id|NVRAM_CLR_CE
suffix:semicolon
multiline_comment|/*&n;&t; * disable writes again&n;&t; */
id|NVRAM_CMD
c_func
(paren
id|EXTEND
op_plus
id|EWDS
)paren
id|NVRAM_CLR_CE
suffix:semicolon
id|CFG_AND
c_func
(paren
op_complement
id|NVDI
)paren
suffix:semicolon
)brace
macro_line|#endif
DECL|function|ia_eeprom_get
r_static
id|u16
id|ia_eeprom_get
(paren
id|IADEV
op_star
id|iadev
comma
id|u32
id|addr
)paren
(brace
id|u_short
id|val
suffix:semicolon
id|u32
id|t
suffix:semicolon
r_int
id|i
suffix:semicolon
multiline_comment|/*&n;&t; * Read the first bit that was clocked with the falling edge of the&n;&t; * the last command data clock&n;&t; */
id|NVRAM_CMD
c_func
(paren
id|IAREAD
op_plus
id|addr
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Now read the rest of the bits, the next bit read is D14, then D13,&n;&t; * and so on.&n;&t; */
id|val
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|15
suffix:semicolon
id|i
op_ge
l_int|0
suffix:semicolon
id|i
op_decrement
)paren
(brace
id|NVRAM_CLKIN
c_func
(paren
id|t
)paren
suffix:semicolon
id|val
op_or_assign
(paren
id|t
op_lshift
id|i
)paren
suffix:semicolon
)brace
id|NVRAM_CLR_CE
suffix:semicolon
id|CFG_AND
c_func
(paren
op_complement
id|NVDI
)paren
suffix:semicolon
r_return
id|val
suffix:semicolon
)brace
DECL|function|ia_hw_type
r_static
r_void
id|ia_hw_type
c_func
(paren
id|IADEV
op_star
id|iadev
)paren
(brace
id|u_short
id|memType
op_assign
id|ia_eeprom_get
c_func
(paren
id|iadev
comma
l_int|25
)paren
suffix:semicolon
id|iadev-&gt;memType
op_assign
id|memType
suffix:semicolon
r_if
c_cond
(paren
(paren
id|memType
op_amp
id|MEM_SIZE_MASK
)paren
op_eq
id|MEM_SIZE_1M
)paren
(brace
id|iadev-&gt;num_tx_desc
op_assign
id|IA_TX_BUF
suffix:semicolon
id|iadev-&gt;tx_buf_sz
op_assign
id|IA_TX_BUF_SZ
suffix:semicolon
id|iadev-&gt;num_rx_desc
op_assign
id|IA_RX_BUF
suffix:semicolon
id|iadev-&gt;rx_buf_sz
op_assign
id|IA_RX_BUF_SZ
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
(paren
id|memType
op_amp
id|MEM_SIZE_MASK
)paren
op_eq
id|MEM_SIZE_512K
)paren
(brace
r_if
c_cond
(paren
id|IA_TX_BUF
op_eq
id|DFL_TX_BUFFERS
)paren
id|iadev-&gt;num_tx_desc
op_assign
id|IA_TX_BUF
op_div
l_int|2
suffix:semicolon
r_else
id|iadev-&gt;num_tx_desc
op_assign
id|IA_TX_BUF
suffix:semicolon
id|iadev-&gt;tx_buf_sz
op_assign
id|IA_TX_BUF_SZ
suffix:semicolon
r_if
c_cond
(paren
id|IA_RX_BUF
op_eq
id|DFL_RX_BUFFERS
)paren
id|iadev-&gt;num_rx_desc
op_assign
id|IA_RX_BUF
op_div
l_int|2
suffix:semicolon
r_else
id|iadev-&gt;num_rx_desc
op_assign
id|IA_RX_BUF
suffix:semicolon
id|iadev-&gt;rx_buf_sz
op_assign
id|IA_RX_BUF_SZ
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|IA_TX_BUF
op_eq
id|DFL_TX_BUFFERS
)paren
id|iadev-&gt;num_tx_desc
op_assign
id|IA_TX_BUF
op_div
l_int|8
suffix:semicolon
r_else
id|iadev-&gt;num_tx_desc
op_assign
id|IA_TX_BUF
suffix:semicolon
id|iadev-&gt;tx_buf_sz
op_assign
id|IA_TX_BUF_SZ
suffix:semicolon
r_if
c_cond
(paren
id|IA_RX_BUF
op_eq
id|DFL_RX_BUFFERS
)paren
id|iadev-&gt;num_rx_desc
op_assign
id|IA_RX_BUF
op_div
l_int|8
suffix:semicolon
r_else
id|iadev-&gt;num_rx_desc
op_assign
id|IA_RX_BUF
suffix:semicolon
id|iadev-&gt;rx_buf_sz
op_assign
id|IA_RX_BUF_SZ
suffix:semicolon
)brace
id|iadev-&gt;rx_pkt_ram
op_assign
id|TX_PACKET_RAM
op_plus
(paren
id|iadev-&gt;num_tx_desc
op_star
id|iadev-&gt;tx_buf_sz
)paren
suffix:semicolon
id|IF_INIT
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;BUF: tx=%d,sz=%d rx=%d sz= %d rx_pkt_ram=%d&bslash;n&quot;
comma
id|iadev-&gt;num_tx_desc
comma
id|iadev-&gt;tx_buf_sz
comma
id|iadev-&gt;num_rx_desc
comma
id|iadev-&gt;rx_buf_sz
comma
id|iadev-&gt;rx_pkt_ram
)paren
suffix:semicolon
)paren
macro_line|#if 0
r_if
c_cond
(paren
(paren
id|memType
op_amp
id|FE_MASK
)paren
op_eq
id|FE_SINGLE_MODE
)paren
(brace
id|iadev-&gt;phy_type
op_assign
id|PHY_OC3C_S
suffix:semicolon
r_else
r_if
c_cond
(paren
(paren
id|memType
op_amp
id|FE_MASK
)paren
op_eq
id|FE_UTP_OPTION
)paren
id|iadev-&gt;phy_type
op_assign
id|PHY_UTP155
suffix:semicolon
r_else
id|iadev-&gt;phy_type
op_assign
id|PHY_OC3C_M
suffix:semicolon
macro_line|#endif
id|iadev-&gt;phy_type
op_assign
id|memType
op_amp
id|FE_MASK
suffix:semicolon
id|IF_INIT
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;memType = 0x%x iadev-&gt;phy_type = 0x%x&bslash;n&quot;
comma
id|memType
comma
id|iadev-&gt;phy_type
)paren
suffix:semicolon
)paren
r_if
c_cond
(paren
id|iadev-&gt;phy_type
op_eq
id|FE_25MBIT_PHY
)paren
id|iadev-&gt;LineRate
op_assign
(paren
id|u32
)paren
(paren
(paren
(paren
l_int|25600000
op_div
l_int|8
)paren
op_star
l_int|26
)paren
op_div
(paren
l_int|27
op_star
l_int|53
)paren
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
id|iadev-&gt;phy_type
op_eq
id|FE_DS3_PHY
)paren
id|iadev-&gt;LineRate
op_assign
(paren
id|u32
)paren
(paren
(paren
(paren
l_int|44736000
op_div
l_int|8
)paren
op_star
l_int|26
)paren
op_div
(paren
l_int|27
op_star
l_int|53
)paren
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
id|iadev-&gt;phy_type
op_eq
id|FE_E3_PHY
)paren
id|iadev-&gt;LineRate
op_assign
(paren
id|u32
)paren
(paren
(paren
(paren
l_int|34368000
op_div
l_int|8
)paren
op_star
l_int|26
)paren
op_div
(paren
l_int|27
op_star
l_int|53
)paren
)paren
suffix:semicolon
r_else
id|iadev-&gt;LineRate
op_assign
(paren
id|u32
)paren
(paren
id|ATM_OC3_PCR
)paren
suffix:semicolon
id|IF_INIT
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;iadev-&gt;LineRate = %d &bslash;n&quot;
comma
id|iadev-&gt;LineRate
)paren
suffix:semicolon
)paren
)brace
DECL|function|IaFrontEndIntr
r_static
r_void
id|IaFrontEndIntr
c_func
(paren
id|IADEV
op_star
id|iadev
)paren
(brace
r_volatile
id|IA_SUNI
op_star
id|suni
suffix:semicolon
r_volatile
id|ia_mb25_t
op_star
id|mb25
suffix:semicolon
r_volatile
id|suni_pm7345_t
op_star
id|suni_pm7345
suffix:semicolon
id|u32
id|intr_status
suffix:semicolon
id|u_int
id|frmr_intr
suffix:semicolon
r_if
c_cond
(paren
id|iadev-&gt;phy_type
op_amp
id|FE_25MBIT_PHY
)paren
(brace
id|mb25
op_assign
(paren
id|ia_mb25_t
op_star
)paren
id|iadev-&gt;phy
suffix:semicolon
id|iadev-&gt;carrier_detect
op_assign
id|Boolean
c_func
(paren
id|mb25-&gt;mb25_intr_status
op_amp
id|MB25_IS_GSB
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|iadev-&gt;phy_type
op_amp
id|FE_DS3_PHY
)paren
(brace
id|suni_pm7345
op_assign
(paren
id|suni_pm7345_t
op_star
)paren
id|iadev-&gt;phy
suffix:semicolon
multiline_comment|/* clear FRMR interrupts */
id|frmr_intr
op_assign
id|suni_pm7345-&gt;suni_ds3_frm_intr_stat
suffix:semicolon
id|iadev-&gt;carrier_detect
op_assign
id|Boolean
c_func
(paren
op_logical_neg
(paren
id|suni_pm7345-&gt;suni_ds3_frm_stat
op_amp
id|SUNI_DS3_LOSV
)paren
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|iadev-&gt;phy_type
op_amp
id|FE_E3_PHY
)paren
(brace
id|suni_pm7345
op_assign
(paren
id|suni_pm7345_t
op_star
)paren
id|iadev-&gt;phy
suffix:semicolon
id|frmr_intr
op_assign
id|suni_pm7345-&gt;suni_e3_frm_maint_intr_ind
suffix:semicolon
id|iadev-&gt;carrier_detect
op_assign
id|Boolean
c_func
(paren
op_logical_neg
(paren
id|suni_pm7345-&gt;suni_e3_frm_fram_intr_ind_stat
op_amp
id|SUNI_E3_LOS
)paren
)paren
suffix:semicolon
)brace
r_else
(brace
id|suni
op_assign
(paren
id|IA_SUNI
op_star
)paren
id|iadev-&gt;phy
suffix:semicolon
id|intr_status
op_assign
id|suni-&gt;suni_rsop_status
op_amp
l_int|0xff
suffix:semicolon
id|iadev-&gt;carrier_detect
op_assign
id|Boolean
c_func
(paren
op_logical_neg
(paren
id|suni-&gt;suni_rsop_status
op_amp
id|SUNI_LOSV
)paren
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|iadev-&gt;carrier_detect
)paren
id|printk
c_func
(paren
l_string|&quot;IA: SUNI carrier detected&bslash;n&quot;
)paren
suffix:semicolon
r_else
id|printk
c_func
(paren
l_string|&quot;IA: SUNI carrier lost signal&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
DECL|function|ia_mb25_init
r_void
id|ia_mb25_init
(paren
id|IADEV
op_star
id|iadev
)paren
(brace
r_volatile
id|ia_mb25_t
op_star
id|mb25
op_assign
(paren
id|ia_mb25_t
op_star
)paren
id|iadev-&gt;phy
suffix:semicolon
macro_line|#if 0
id|mb25-&gt;mb25_master_ctrl
op_assign
id|MB25_MC_DRIC
op_or
id|MB25_MC_DREC
op_or
id|MB25_MC_ENABLED
suffix:semicolon
macro_line|#endif
id|mb25-&gt;mb25_master_ctrl
op_assign
id|MB25_MC_DRIC
op_or
id|MB25_MC_DREC
suffix:semicolon
id|mb25-&gt;mb25_diag_control
op_assign
l_int|0
suffix:semicolon
multiline_comment|/*&n;    * Initialize carrier detect state&n;    */
id|iadev-&gt;carrier_detect
op_assign
id|Boolean
c_func
(paren
id|mb25-&gt;mb25_intr_status
op_amp
id|MB25_IS_GSB
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
DECL|function|ia_suni_pm7345_init
r_void
id|ia_suni_pm7345_init
(paren
id|IADEV
op_star
id|iadev
)paren
(brace
r_volatile
id|suni_pm7345_t
op_star
id|suni_pm7345
op_assign
(paren
id|suni_pm7345_t
op_star
)paren
id|iadev-&gt;phy
suffix:semicolon
r_if
c_cond
(paren
id|iadev-&gt;phy_type
op_amp
id|FE_DS3_PHY
)paren
(brace
id|iadev-&gt;carrier_detect
op_assign
id|Boolean
c_func
(paren
op_logical_neg
(paren
id|suni_pm7345-&gt;suni_ds3_frm_stat
op_amp
id|SUNI_DS3_LOSV
)paren
)paren
suffix:semicolon
id|suni_pm7345-&gt;suni_ds3_frm_intr_enbl
op_assign
l_int|0x17
suffix:semicolon
id|suni_pm7345-&gt;suni_ds3_frm_cfg
op_assign
l_int|1
suffix:semicolon
id|suni_pm7345-&gt;suni_ds3_tran_cfg
op_assign
l_int|1
suffix:semicolon
id|suni_pm7345-&gt;suni_config
op_assign
l_int|0
suffix:semicolon
id|suni_pm7345-&gt;suni_splr_cfg
op_assign
l_int|0
suffix:semicolon
id|suni_pm7345-&gt;suni_splt_cfg
op_assign
l_int|0
suffix:semicolon
)brace
r_else
(brace
id|iadev-&gt;carrier_detect
op_assign
id|Boolean
c_func
(paren
op_logical_neg
(paren
id|suni_pm7345-&gt;suni_e3_frm_fram_intr_ind_stat
op_amp
id|SUNI_E3_LOS
)paren
)paren
suffix:semicolon
id|suni_pm7345-&gt;suni_e3_frm_fram_options
op_assign
l_int|0x4
suffix:semicolon
id|suni_pm7345-&gt;suni_e3_frm_maint_options
op_assign
l_int|0x20
suffix:semicolon
id|suni_pm7345-&gt;suni_e3_frm_fram_intr_enbl
op_assign
l_int|0x1d
suffix:semicolon
id|suni_pm7345-&gt;suni_e3_frm_maint_intr_enbl
op_assign
l_int|0x30
suffix:semicolon
id|suni_pm7345-&gt;suni_e3_tran_stat_diag_options
op_assign
l_int|0x0
suffix:semicolon
id|suni_pm7345-&gt;suni_e3_tran_fram_options
op_assign
l_int|0x1
suffix:semicolon
id|suni_pm7345-&gt;suni_config
op_assign
id|SUNI_PM7345_E3ENBL
suffix:semicolon
id|suni_pm7345-&gt;suni_splr_cfg
op_assign
l_int|0x41
suffix:semicolon
id|suni_pm7345-&gt;suni_splt_cfg
op_assign
l_int|0x41
suffix:semicolon
)brace
multiline_comment|/*&n;    * Enable RSOP loss of signal interrupt.&n;    */
id|suni_pm7345-&gt;suni_intr_enbl
op_assign
l_int|0x28
suffix:semicolon
multiline_comment|/*&n;    * Clear error counters&n;    */
id|suni_pm7345-&gt;suni_id_reset
op_assign
l_int|0
suffix:semicolon
multiline_comment|/*&n;    * Clear &quot;PMCTST&quot; in master test register.&n;    */
id|suni_pm7345-&gt;suni_master_test
op_assign
l_int|0
suffix:semicolon
id|suni_pm7345-&gt;suni_rxcp_ctrl
op_assign
l_int|0x2c
suffix:semicolon
id|suni_pm7345-&gt;suni_rxcp_fctrl
op_assign
l_int|0x81
suffix:semicolon
id|suni_pm7345-&gt;suni_rxcp_idle_pat_h1
op_assign
l_int|0
suffix:semicolon
id|suni_pm7345-&gt;suni_rxcp_idle_pat_h2
op_assign
l_int|0
suffix:semicolon
id|suni_pm7345-&gt;suni_rxcp_idle_pat_h3
op_assign
l_int|0
suffix:semicolon
id|suni_pm7345-&gt;suni_rxcp_idle_pat_h4
op_assign
l_int|1
suffix:semicolon
id|suni_pm7345-&gt;suni_rxcp_idle_mask_h1
op_assign
l_int|0xff
suffix:semicolon
id|suni_pm7345-&gt;suni_rxcp_idle_mask_h2
op_assign
l_int|0xff
suffix:semicolon
id|suni_pm7345-&gt;suni_rxcp_idle_mask_h3
op_assign
l_int|0xff
suffix:semicolon
id|suni_pm7345-&gt;suni_rxcp_idle_mask_h4
op_assign
l_int|0xfe
suffix:semicolon
id|suni_pm7345-&gt;suni_rxcp_cell_pat_h1
op_assign
l_int|0
suffix:semicolon
id|suni_pm7345-&gt;suni_rxcp_cell_pat_h2
op_assign
l_int|0
suffix:semicolon
id|suni_pm7345-&gt;suni_rxcp_cell_pat_h3
op_assign
l_int|0
suffix:semicolon
id|suni_pm7345-&gt;suni_rxcp_cell_pat_h4
op_assign
l_int|1
suffix:semicolon
id|suni_pm7345-&gt;suni_rxcp_cell_mask_h1
op_assign
l_int|0xff
suffix:semicolon
id|suni_pm7345-&gt;suni_rxcp_cell_mask_h2
op_assign
l_int|0xff
suffix:semicolon
id|suni_pm7345-&gt;suni_rxcp_cell_mask_h3
op_assign
l_int|0xff
suffix:semicolon
id|suni_pm7345-&gt;suni_rxcp_cell_mask_h4
op_assign
l_int|0xff
suffix:semicolon
id|suni_pm7345-&gt;suni_txcp_ctrl
op_assign
l_int|0xa4
suffix:semicolon
id|suni_pm7345-&gt;suni_txcp_intr_en_sts
op_assign
l_int|0x10
suffix:semicolon
id|suni_pm7345-&gt;suni_txcp_idle_pat_h5
op_assign
l_int|0x55
suffix:semicolon
id|suni_pm7345-&gt;suni_config
op_and_assign
op_complement
(paren
id|SUNI_PM7345_LLB
op_or
id|SUNI_PM7345_CLB
op_or
id|SUNI_PM7345_DLB
op_or
id|SUNI_PM7345_PLB
)paren
suffix:semicolon
macro_line|#ifdef __SNMP__
id|suni_pm7345-&gt;suni_rxcp_intr_en_sts
op_or_assign
id|SUNI_OOCDE
suffix:semicolon
macro_line|#endif __SNMP__
r_return
suffix:semicolon
)brace
multiline_comment|/***************************** IA_LIB END *****************************/
multiline_comment|/* pwang_test debug utility */
DECL|variable|tcnter
DECL|variable|rcnter
r_int
id|tcnter
op_assign
l_int|0
comma
id|rcnter
op_assign
l_int|0
suffix:semicolon
DECL|function|xdump
r_void
id|xdump
c_func
(paren
id|u_char
op_star
id|cp
comma
r_int
id|length
comma
r_char
op_star
id|prefix
)paren
(brace
r_int
id|col
comma
id|count
suffix:semicolon
id|u_char
id|prntBuf
(braket
l_int|120
)braket
suffix:semicolon
id|u_char
op_star
id|pBuf
op_assign
id|prntBuf
suffix:semicolon
id|count
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
id|count
OL
id|length
)paren
(brace
id|pBuf
op_add_assign
id|sprintf
c_func
(paren
id|pBuf
comma
l_string|&quot;%s&quot;
comma
id|prefix
)paren
suffix:semicolon
r_for
c_loop
(paren
id|col
op_assign
l_int|0
suffix:semicolon
id|count
op_plus
id|col
OL
id|length
op_logical_and
id|col
OL
l_int|16
suffix:semicolon
id|col
op_increment
)paren
(brace
r_if
c_cond
(paren
id|col
op_ne
l_int|0
op_logical_and
(paren
id|col
op_mod
l_int|4
)paren
op_eq
l_int|0
)paren
id|pBuf
op_add_assign
id|sprintf
c_func
(paren
id|pBuf
comma
l_string|&quot; &quot;
)paren
suffix:semicolon
id|pBuf
op_add_assign
id|sprintf
c_func
(paren
id|pBuf
comma
l_string|&quot;%02X &quot;
comma
id|cp
(braket
id|count
op_plus
id|col
)braket
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
id|col
op_increment
OL
l_int|16
)paren
(brace
multiline_comment|/* pad end of buffer with blanks */
r_if
c_cond
(paren
(paren
id|col
op_mod
l_int|4
)paren
op_eq
l_int|0
)paren
id|sprintf
c_func
(paren
id|pBuf
comma
l_string|&quot; &quot;
)paren
suffix:semicolon
id|pBuf
op_add_assign
id|sprintf
c_func
(paren
id|pBuf
comma
l_string|&quot;   &quot;
)paren
suffix:semicolon
)brace
id|pBuf
op_add_assign
id|sprintf
c_func
(paren
id|pBuf
comma
l_string|&quot;  &quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|col
op_assign
l_int|0
suffix:semicolon
id|count
op_plus
id|col
OL
id|length
op_logical_and
id|col
OL
l_int|16
suffix:semicolon
id|col
op_increment
)paren
(brace
r_if
c_cond
(paren
id|isprint
c_func
(paren
(paren
r_int
)paren
id|cp
(braket
id|count
op_plus
id|col
)braket
)paren
)paren
id|pBuf
op_add_assign
id|sprintf
c_func
(paren
id|pBuf
comma
l_string|&quot;%c&quot;
comma
id|cp
(braket
id|count
op_plus
id|col
)braket
)paren
suffix:semicolon
r_else
id|pBuf
op_add_assign
id|sprintf
c_func
(paren
id|pBuf
comma
l_string|&quot;.&quot;
)paren
suffix:semicolon
)brace
id|sprintf
c_func
(paren
id|pBuf
comma
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
singleline_comment|// SPrint(prntBuf);
id|printk
c_func
(paren
id|prntBuf
)paren
suffix:semicolon
id|count
op_add_assign
id|col
suffix:semicolon
id|pBuf
op_assign
id|prntBuf
suffix:semicolon
)brace
)brace
multiline_comment|/* close xdump(... */
DECL|variable|ia_boards
r_static
r_struct
id|atm_dev
op_star
id|ia_boards
op_assign
l_int|NULL
suffix:semicolon
DECL|macro|ACTUAL_RAM_BASE
mdefine_line|#define ACTUAL_RAM_BASE &bslash;&n;&t;RAM_BASE*((iadev-&gt;mem)/(128 * 1024))  
DECL|macro|ACTUAL_SEG_RAM_BASE
mdefine_line|#define ACTUAL_SEG_RAM_BASE &bslash;&n;&t;IPHASE5575_FRAG_CONTROL_RAM_BASE*((iadev-&gt;mem)/(128 * 1024))  
DECL|macro|ACTUAL_REASS_RAM_BASE
mdefine_line|#define ACTUAL_REASS_RAM_BASE &bslash;&n;&t;IPHASE5575_REASS_CONTROL_RAM_BASE*((iadev-&gt;mem)/(128 * 1024))  
multiline_comment|/*-- some utilities and memory allocation stuff will come here -------------*/
DECL|function|desc_dbg
r_void
id|desc_dbg
c_func
(paren
id|IADEV
op_star
id|iadev
)paren
(brace
id|u_short
id|tcq_wr_ptr
comma
id|tcq_st_ptr
comma
id|tcq_ed_ptr
suffix:semicolon
id|u32
id|tmp
comma
id|i
suffix:semicolon
singleline_comment|// regval = readl((u32)ia_cmds-&gt;maddr);
id|tcq_wr_ptr
op_assign
id|readw
c_func
(paren
id|iadev-&gt;seg_reg
op_plus
id|TCQ_WR_PTR
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;B_tcq_wr = 0x%x desc = %d last desc = %d&bslash;n&quot;
comma
id|tcq_wr_ptr
comma
id|readw
c_func
(paren
id|iadev-&gt;seg_ram
op_plus
id|tcq_wr_ptr
)paren
comma
id|readw
c_func
(paren
id|iadev-&gt;seg_ram
op_plus
id|tcq_wr_ptr
op_minus
l_int|2
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot; host_tcq_wr = 0x%x  host_tcq_rd = 0x%x &bslash;n&quot;
comma
id|iadev-&gt;host_tcq_wr
comma
id|iadev-&gt;ffL.tcq_rd
)paren
suffix:semicolon
id|tcq_st_ptr
op_assign
id|readw
c_func
(paren
id|iadev-&gt;seg_reg
op_plus
id|TCQ_ST_ADR
)paren
suffix:semicolon
id|tcq_ed_ptr
op_assign
id|readw
c_func
(paren
id|iadev-&gt;seg_reg
op_plus
id|TCQ_ED_ADR
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;tcq_st_ptr = 0x%x    tcq_ed_ptr = 0x%x &bslash;n&quot;
comma
id|tcq_st_ptr
comma
id|tcq_ed_ptr
)paren
suffix:semicolon
id|i
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
id|tcq_st_ptr
op_ne
id|tcq_ed_ptr
)paren
(brace
id|tmp
op_assign
id|iadev-&gt;seg_ram
op_plus
id|tcq_st_ptr
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;TCQ slot %d desc = %d  Addr = 0x%x&bslash;n&quot;
comma
id|i
op_increment
comma
id|readw
c_func
(paren
id|tmp
)paren
comma
id|tmp
)paren
suffix:semicolon
id|tcq_st_ptr
op_add_assign
l_int|2
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|iadev-&gt;num_tx_desc
suffix:semicolon
id|i
op_increment
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;Desc_tbl[%d] = %d &bslash;n&quot;
comma
id|i
comma
id|iadev-&gt;desc_tbl
(braket
id|i
)braket
dot
id|timestamp
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/*----------------------------- Recieving side stuff --------------------------*/
DECL|function|rx_excp_rcvd
r_static
r_void
id|rx_excp_rcvd
c_func
(paren
r_struct
id|atm_dev
op_star
id|dev
)paren
(brace
macro_line|#if 0 /* closing the receiving size will cause too many excp int */  
id|IADEV
op_star
id|iadev
suffix:semicolon
id|u_short
id|state
suffix:semicolon
id|u_short
id|excpq_rd_ptr
suffix:semicolon
singleline_comment|//u_short *ptr;  
r_int
id|vci
comma
id|error
op_assign
l_int|1
suffix:semicolon
id|iadev
op_assign
id|INPH_IA_DEV
c_func
(paren
id|dev
)paren
suffix:semicolon
id|state
op_assign
id|readl
c_func
(paren
id|iadev-&gt;reass_reg
op_plus
id|STATE_REG
)paren
op_amp
l_int|0xffff
suffix:semicolon
r_while
c_loop
(paren
(paren
id|state
op_amp
id|EXCPQ_EMPTY
)paren
op_ne
id|EXCPQ_EMPTY
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;state = %x &bslash;n&quot;
comma
id|state
)paren
suffix:semicolon
id|excpq_rd_ptr
op_assign
id|readw
c_func
(paren
id|iadev-&gt;reass_reg
op_plus
id|EXCP_Q_RD_PTR
)paren
op_amp
l_int|0xffff
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;state = %x excpq_rd_ptr = %x &bslash;n&quot;
comma
id|state
comma
id|excpq_rd_ptr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|excpq_rd_ptr
op_eq
op_star
(paren
id|u16
op_star
)paren
(paren
id|iadev-&gt;reass_reg
op_plus
id|EXCP_Q_WR_PTR
)paren
)paren
id|IF_ERR
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;excpq_rd_ptr is wrong!!!&bslash;n&quot;
)paren
suffix:semicolon
)paren
singleline_comment|// TODO: update exception stat
id|vci
op_assign
id|readw
c_func
(paren
id|iadev-&gt;reass_ram
op_plus
id|excpq_rd_ptr
)paren
suffix:semicolon
id|error
op_assign
id|readw
c_func
(paren
id|iadev-&gt;reass_ram
op_plus
id|excpq_rd_ptr
op_plus
l_int|2
)paren
op_amp
l_int|0x0007
suffix:semicolon
singleline_comment|// pwang_test
id|excpq_rd_ptr
op_add_assign
l_int|4
suffix:semicolon
r_if
c_cond
(paren
id|excpq_rd_ptr
OG
(paren
id|readw
c_func
(paren
id|iadev-&gt;reass_reg
op_plus
id|EXCP_Q_ED_ADR
)paren
op_amp
l_int|0xffff
)paren
)paren
id|excpq_rd_ptr
op_assign
id|readw
c_func
(paren
id|iadev-&gt;reass_reg
op_plus
id|EXCP_Q_ST_ADR
)paren
op_amp
l_int|0xffff
suffix:semicolon
id|writew
c_func
(paren
id|excpq_rd_ptr
comma
id|iadev-&gt;reass_reg
op_plus
id|EXCP_Q_RD_PTR
)paren
suffix:semicolon
id|state
op_assign
id|readl
c_func
(paren
id|iadev-&gt;reass_reg
op_plus
id|STATE_REG
)paren
op_amp
l_int|0xffff
suffix:semicolon
)brace
macro_line|#endif
)brace
DECL|function|free_desc
r_static
r_void
id|free_desc
c_func
(paren
r_struct
id|atm_dev
op_star
id|dev
comma
r_int
id|desc
)paren
(brace
id|IADEV
op_star
id|iadev
suffix:semicolon
id|iadev
op_assign
id|INPH_IA_DEV
c_func
(paren
id|dev
)paren
suffix:semicolon
id|writew
c_func
(paren
id|desc
comma
id|iadev-&gt;reass_ram
op_plus
id|iadev-&gt;rfL.fdq_wr
)paren
suffix:semicolon
id|iadev-&gt;rfL.fdq_wr
op_add_assign
l_int|2
suffix:semicolon
r_if
c_cond
(paren
id|iadev-&gt;rfL.fdq_wr
OG
id|iadev-&gt;rfL.fdq_ed
)paren
id|iadev-&gt;rfL.fdq_wr
op_assign
id|iadev-&gt;rfL.fdq_st
suffix:semicolon
id|writew
c_func
(paren
id|iadev-&gt;rfL.fdq_wr
comma
id|iadev-&gt;reass_reg
op_plus
id|FREEQ_WR_PTR
)paren
suffix:semicolon
)brace
DECL|function|rx_pkt
r_static
r_int
id|rx_pkt
c_func
(paren
r_struct
id|atm_dev
op_star
id|dev
)paren
(brace
id|IADEV
op_star
id|iadev
suffix:semicolon
r_struct
id|atm_vcc
op_star
id|vcc
suffix:semicolon
r_int
r_int
id|status
suffix:semicolon
r_struct
id|rx_buf_desc
op_star
id|buf_desc_ptr
suffix:semicolon
r_int
id|desc
suffix:semicolon
r_struct
id|dle
op_star
id|wr_ptr
suffix:semicolon
r_int
id|len
suffix:semicolon
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
id|u_int
id|buf_addr
comma
id|dma_addr
suffix:semicolon
id|iadev
op_assign
id|INPH_IA_DEV
c_func
(paren
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|iadev-&gt;rfL.pcq_rd
op_eq
(paren
id|readw
c_func
(paren
id|iadev-&gt;reass_reg
op_plus
id|PCQ_WR_PTR
)paren
op_amp
l_int|0xffff
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
id|DEV_LABEL
l_string|&quot;(itf %d) Receive queue empty&bslash;n&quot;
comma
id|dev-&gt;number
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
multiline_comment|/* mask 1st 3 bits to get the actual descno. */
id|desc
op_assign
id|readw
c_func
(paren
id|iadev-&gt;reass_ram
op_plus
id|iadev-&gt;rfL.pcq_rd
)paren
op_amp
l_int|0x1fff
suffix:semicolon
id|IF_RX
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;reass_ram = 0x%x iadev-&gt;rfL.pcq_rd = 0x%x desc = %d&bslash;n&quot;
comma
id|iadev-&gt;reass_ram
comma
id|iadev-&gt;rfL.pcq_rd
comma
id|desc
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot; pcq_wr_ptr = 0x%x&bslash;n&quot;
comma
id|readw
c_func
(paren
id|iadev-&gt;reass_reg
op_plus
id|PCQ_WR_PTR
)paren
op_amp
l_int|0xffff
)paren
suffix:semicolon
)paren
multiline_comment|/* update the read pointer  - maybe we shud do this in the end*/
r_if
c_cond
(paren
id|iadev-&gt;rfL.pcq_rd
op_eq
id|iadev-&gt;rfL.pcq_ed
)paren
id|iadev-&gt;rfL.pcq_rd
op_assign
id|iadev-&gt;rfL.pcq_st
suffix:semicolon
r_else
id|iadev-&gt;rfL.pcq_rd
op_add_assign
l_int|2
suffix:semicolon
id|writew
c_func
(paren
id|iadev-&gt;rfL.pcq_rd
comma
id|iadev-&gt;reass_reg
op_plus
id|PCQ_RD_PTR
)paren
suffix:semicolon
multiline_comment|/* get the buffer desc entry.  &n;&t;&t;update stuff. - doesn&squot;t seem to be any update necessary  &n;&t;*/
id|buf_desc_ptr
op_assign
(paren
r_struct
id|rx_buf_desc
op_star
)paren
id|iadev-&gt;RX_DESC_BASE_ADDR
suffix:semicolon
multiline_comment|/* make the ptr point to the corresponding buffer desc entry */
id|buf_desc_ptr
op_add_assign
id|desc
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|desc
op_logical_or
(paren
id|desc
OG
id|iadev-&gt;num_rx_desc
)paren
op_logical_or
(paren
(paren
id|buf_desc_ptr-&gt;vc_index
op_amp
l_int|0xffff
)paren
OG
id|iadev-&gt;num_vc
)paren
)paren
(brace
id|free_desc
c_func
(paren
id|dev
comma
id|desc
)paren
suffix:semicolon
id|IF_ERR
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;IA: bad descriptor desc = %d &bslash;n&quot;
comma
id|desc
)paren
suffix:semicolon
)paren
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|vcc
op_assign
id|iadev-&gt;rx_open
(braket
id|buf_desc_ptr-&gt;vc_index
op_amp
l_int|0xffff
)braket
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|vcc
)paren
(brace
id|free_desc
c_func
(paren
id|dev
comma
id|desc
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;IA: null vcc, drop PDU&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
multiline_comment|/* might want to check the status bits for errors */
id|status
op_assign
(paren
id|u_short
)paren
(paren
id|buf_desc_ptr-&gt;desc_mode
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
(paren
id|RX_CER
op_or
id|RX_PTE
op_or
id|RX_OFL
)paren
)paren
(brace
id|atomic_inc
c_func
(paren
op_amp
id|vcc-&gt;stats-&gt;rx_err
)paren
suffix:semicolon
id|IF_ERR
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;IA: bad packet, dropping it&quot;
)paren
suffix:semicolon
)paren
r_if
c_cond
(paren
id|status
op_amp
id|RX_CER
)paren
(brace
id|IF_ERR
c_func
(paren
id|printk
c_func
(paren
l_string|&quot; cause: packet CRC error&bslash;n&quot;
)paren
suffix:semicolon
)paren
)brace
r_else
r_if
c_cond
(paren
id|status
op_amp
id|RX_PTE
)paren
(brace
id|IF_ERR
c_func
(paren
id|printk
c_func
(paren
l_string|&quot; cause: packet time out&bslash;n&quot;
)paren
suffix:semicolon
)paren
)brace
r_else
(brace
id|IF_ERR
c_func
(paren
id|printk
c_func
(paren
l_string|&quot; cause: buffer over flow&bslash;n&quot;
)paren
suffix:semicolon
)paren
)brace
id|free_desc
c_func
(paren
id|dev
comma
id|desc
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*  &n;&t;&t;build DLE.&t;  &n;&t;*/
id|buf_addr
op_assign
(paren
id|buf_desc_ptr-&gt;buf_start_hi
op_lshift
l_int|16
)paren
op_or
id|buf_desc_ptr-&gt;buf_start_lo
suffix:semicolon
id|dma_addr
op_assign
(paren
id|buf_desc_ptr-&gt;dma_start_hi
op_lshift
l_int|16
)paren
op_or
id|buf_desc_ptr-&gt;dma_start_lo
suffix:semicolon
id|len
op_assign
id|dma_addr
op_minus
id|buf_addr
suffix:semicolon
r_if
c_cond
(paren
id|len
OG
id|iadev-&gt;rx_buf_sz
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;Over %d bytes sdu received, dropped!!!&bslash;n&quot;
comma
id|iadev-&gt;rx_buf_sz
)paren
suffix:semicolon
id|atomic_inc
c_func
(paren
op_amp
id|vcc-&gt;stats-&gt;rx_err
)paren
suffix:semicolon
id|free_desc
c_func
(paren
id|dev
comma
id|desc
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#if LINUX_VERSION_CODE &gt;= 0x20312
r_if
c_cond
(paren
op_logical_neg
(paren
id|skb
op_assign
id|atm_alloc_charge
c_func
(paren
id|vcc
comma
id|len
comma
id|GFP_ATOMIC
)paren
)paren
)paren
(brace
macro_line|#else
r_if
c_cond
(paren
id|atm_charge
c_func
(paren
id|vcc
comma
id|atm_pdu2truesize
c_func
(paren
id|len
)paren
)paren
)paren
(brace
multiline_comment|/* lets allocate an skb for now */
id|skb
op_assign
id|alloc_skb
c_func
(paren
id|len
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|skb
)paren
(brace
id|IF_ERR
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;can&squot;t allocate memory for recv, drop pkt!&bslash;n&quot;
)paren
suffix:semicolon
)paren
id|atomic_inc
c_func
(paren
op_amp
id|vcc-&gt;stats-&gt;rx_drop
)paren
suffix:semicolon
id|atm_return
c_func
(paren
id|vcc
comma
id|atm_pdu2truesize
c_func
(paren
id|len
)paren
)paren
suffix:semicolon
id|free_desc
c_func
(paren
id|dev
comma
id|desc
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
)brace
r_else
(brace
id|IF_EVENT
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;IA: Rx over the rx_quota %ld&bslash;n&quot;
comma
id|vcc-&gt;rx_quota
)paren
suffix:semicolon
)paren
macro_line|#endif
r_if
c_cond
(paren
id|vcc-&gt;vci
OL
l_int|32
)paren
id|printk
c_func
(paren
l_string|&quot;Drop control packets&bslash;n&quot;
)paren
suffix:semicolon
id|free_desc
c_func
(paren
id|dev
comma
id|desc
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|skb_put
c_func
(paren
id|skb
comma
id|len
)paren
suffix:semicolon
singleline_comment|// pwang_test
id|ATM_SKB
c_func
(paren
id|skb
)paren
op_member_access_from_pointer
id|vcc
op_assign
id|vcc
suffix:semicolon
id|ATM_SKB
c_func
(paren
id|skb
)paren
op_member_access_from_pointer
id|iovcnt
op_assign
l_int|0
suffix:semicolon
id|ATM_DESC
c_func
(paren
id|skb
)paren
op_assign
id|desc
suffix:semicolon
id|skb_queue_tail
c_func
(paren
op_amp
id|iadev-&gt;rx_dma_q
comma
id|skb
)paren
suffix:semicolon
multiline_comment|/* Build the DLE structure */
id|wr_ptr
op_assign
id|iadev-&gt;rx_dle_q.write
suffix:semicolon
id|wr_ptr-&gt;sys_pkt_addr
op_assign
id|virt_to_bus
c_func
(paren
id|skb-&gt;data
)paren
suffix:semicolon
id|wr_ptr-&gt;local_pkt_addr
op_assign
id|buf_addr
suffix:semicolon
id|wr_ptr-&gt;bytes
op_assign
id|len
suffix:semicolon
multiline_comment|/* We don&squot;t know this do we ?? */
id|wr_ptr-&gt;mode
op_assign
id|DMA_INT_ENABLE
suffix:semicolon
multiline_comment|/* shud take care of wrap around here too. */
r_if
c_cond
(paren
op_increment
id|wr_ptr
op_eq
id|iadev-&gt;rx_dle_q.end
)paren
(brace
id|wr_ptr
op_assign
id|iadev-&gt;rx_dle_q.start
suffix:semicolon
)brace
id|iadev-&gt;rx_dle_q.write
op_assign
id|wr_ptr
suffix:semicolon
id|udelay
c_func
(paren
l_int|1
)paren
suffix:semicolon
multiline_comment|/* Increment transaction counter */
id|writel
c_func
(paren
l_int|1
comma
id|iadev-&gt;dma
op_plus
id|IPHASE5575_RX_COUNTER
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|rx_intr
r_static
r_void
id|rx_intr
c_func
(paren
r_struct
id|atm_dev
op_star
id|dev
)paren
(brace
id|IADEV
op_star
id|iadev
suffix:semicolon
id|u_short
id|status
suffix:semicolon
id|u_short
id|state
comma
id|i
suffix:semicolon
id|iadev
op_assign
id|INPH_IA_DEV
c_func
(paren
id|dev
)paren
suffix:semicolon
id|status
op_assign
id|readl
c_func
(paren
id|iadev-&gt;reass_reg
op_plus
id|REASS_INTR_STATUS_REG
)paren
op_amp
l_int|0xffff
suffix:semicolon
id|IF_EVENT
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;rx_intr: status = 0x%x&bslash;n&quot;
comma
id|status
)paren
suffix:semicolon
)paren
r_if
c_cond
(paren
id|status
op_amp
id|RX_PKT_RCVD
)paren
(brace
multiline_comment|/* do something */
multiline_comment|/* Basically recvd an interrupt for receving a packet.  &n;&t;A descriptor would have been written to the packet complete   &n;&t;queue. Get all the descriptors and set up dma to move the   &n;&t;packets till the packet complete queue is empty..  &n;&t;*/
id|state
op_assign
id|readl
c_func
(paren
id|iadev-&gt;reass_reg
op_plus
id|STATE_REG
)paren
op_amp
l_int|0xffff
suffix:semicolon
id|IF_EVENT
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;Rx intr status: RX_PKT_RCVD %08x&bslash;n&quot;
comma
id|status
)paren
suffix:semicolon
)paren
r_while
c_loop
(paren
op_logical_neg
(paren
id|state
op_amp
id|PCQ_EMPTY
)paren
)paren
(brace
id|rx_pkt
c_func
(paren
id|dev
)paren
suffix:semicolon
id|state
op_assign
id|readl
c_func
(paren
id|iadev-&gt;reass_reg
op_plus
id|STATE_REG
)paren
op_amp
l_int|0xffff
suffix:semicolon
)brace
id|iadev-&gt;rxing
op_assign
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|status
op_amp
id|RX_FREEQ_EMPT
)paren
(brace
r_if
c_cond
(paren
id|iadev-&gt;rxing
)paren
(brace
id|iadev-&gt;rx_tmp_cnt
op_assign
id|iadev-&gt;rx_pkt_cnt
suffix:semicolon
id|iadev-&gt;rx_tmp_jif
op_assign
id|jiffies
suffix:semicolon
id|iadev-&gt;rxing
op_assign
l_int|0
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
(paren
(paren
id|jiffies
op_minus
id|iadev-&gt;rx_tmp_jif
)paren
OG
l_int|50
)paren
op_logical_and
(paren
(paren
id|iadev-&gt;rx_pkt_cnt
op_minus
id|iadev-&gt;rx_tmp_cnt
)paren
op_eq
l_int|0
)paren
)paren
(brace
r_for
c_loop
(paren
id|i
op_assign
l_int|1
suffix:semicolon
id|i
op_le
id|iadev-&gt;num_rx_desc
suffix:semicolon
id|i
op_increment
)paren
id|free_desc
c_func
(paren
id|dev
comma
id|i
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;Test logic RUN!!!!&bslash;n&quot;
)paren
suffix:semicolon
id|writew
c_func
(paren
op_complement
(paren
id|RX_FREEQ_EMPT
op_or
id|RX_EXCP_RCVD
)paren
comma
id|iadev-&gt;reass_reg
op_plus
id|REASS_MASK_REG
)paren
suffix:semicolon
id|iadev-&gt;rxing
op_assign
l_int|1
suffix:semicolon
)brace
id|IF_EVENT
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;Rx intr status: RX_FREEQ_EMPT %08x&bslash;n&quot;
comma
id|status
)paren
suffix:semicolon
)paren
)brace
r_if
c_cond
(paren
id|status
op_amp
id|RX_EXCP_RCVD
)paren
(brace
multiline_comment|/* probably need to handle the exception queue also. */
id|IF_EVENT
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;Rx intr status: RX_EXCP_RCVD %08x&bslash;n&quot;
comma
id|status
)paren
suffix:semicolon
)paren
id|rx_excp_rcvd
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|status
op_amp
id|RX_RAW_RCVD
)paren
(brace
multiline_comment|/* need to handle the raw incoming cells. This deepnds on   &n;&t;whether we have programmed to receive the raw cells or not.  &n;&t;Else ignore. */
id|IF_EVENT
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;Rx intr status:  RX_RAW_RCVD %08x&bslash;n&quot;
comma
id|status
)paren
suffix:semicolon
)paren
)brace
)brace
DECL|function|rx_dle_intr
r_static
r_void
id|rx_dle_intr
c_func
(paren
r_struct
id|atm_dev
op_star
id|dev
)paren
(brace
id|IADEV
op_star
id|iadev
suffix:semicolon
r_struct
id|atm_vcc
op_star
id|vcc
suffix:semicolon
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
r_int
id|desc
suffix:semicolon
id|u_short
id|state
suffix:semicolon
r_struct
id|dle
op_star
id|dle
comma
op_star
id|cur_dle
suffix:semicolon
id|u_int
id|dle_lp
suffix:semicolon
id|iadev
op_assign
id|INPH_IA_DEV
c_func
(paren
id|dev
)paren
suffix:semicolon
multiline_comment|/* free all the dles done, that is just update our own dle read pointer   &n;&t;- do we really need to do this. Think not. */
multiline_comment|/* DMA is done, just get all the recevie buffers from the rx dma queue  &n;&t;and push them up to the higher layer protocol. Also free the desc  &n;&t;associated with the buffer. */
id|dle
op_assign
id|iadev-&gt;rx_dle_q.read
suffix:semicolon
id|dle_lp
op_assign
id|readl
c_func
(paren
id|iadev-&gt;dma
op_plus
id|IPHASE5575_RX_LIST_ADDR
)paren
op_amp
(paren
r_sizeof
(paren
r_struct
id|dle
)paren
op_star
id|DLE_ENTRIES
op_minus
l_int|1
)paren
suffix:semicolon
id|cur_dle
op_assign
(paren
r_struct
id|dle
op_star
)paren
(paren
id|iadev-&gt;rx_dle_q.start
op_plus
(paren
id|dle_lp
op_rshift
l_int|4
)paren
)paren
suffix:semicolon
r_while
c_loop
(paren
id|dle
op_ne
id|cur_dle
)paren
(brace
multiline_comment|/* free the DMAed skb */
id|skb
op_assign
id|skb_dequeue
c_func
(paren
op_amp
id|iadev-&gt;rx_dma_q
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|skb
)paren
r_goto
id|INCR_DLE
suffix:semicolon
id|desc
op_assign
id|ATM_DESC
c_func
(paren
id|skb
)paren
suffix:semicolon
id|free_desc
c_func
(paren
id|dev
comma
id|desc
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|skb-&gt;len
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;rx_dle_intr: skb len 0&bslash;n&quot;
)paren
suffix:semicolon
id|dev_kfree_skb_any
c_func
(paren
id|skb
)paren
suffix:semicolon
)brace
r_else
(brace
r_struct
id|cpcs_trailer
op_star
id|trailer
suffix:semicolon
id|u_short
id|length
suffix:semicolon
r_struct
id|ia_vcc
op_star
id|ia_vcc
suffix:semicolon
multiline_comment|/* no VCC related housekeeping done as yet. lets see */
id|vcc
op_assign
id|ATM_SKB
c_func
(paren
id|skb
)paren
op_member_access_from_pointer
id|vcc
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|vcc
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;IA: null vcc&bslash;n&quot;
)paren
suffix:semicolon
id|atomic_inc
c_func
(paren
op_amp
id|vcc-&gt;stats-&gt;rx_err
)paren
suffix:semicolon
id|dev_kfree_skb_any
c_func
(paren
id|skb
)paren
suffix:semicolon
r_goto
id|INCR_DLE
suffix:semicolon
)brace
id|ia_vcc
op_assign
id|INPH_IA_VCC
c_func
(paren
id|vcc
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ia_vcc
op_eq
l_int|NULL
)paren
(brace
id|atomic_inc
c_func
(paren
op_amp
id|vcc-&gt;stats-&gt;rx_err
)paren
suffix:semicolon
id|dev_kfree_skb_any
c_func
(paren
id|skb
)paren
suffix:semicolon
macro_line|#if LINUX_VERSION_CODE &gt;= 0x20312
id|atm_return
c_func
(paren
id|vcc
comma
id|atm_guess_pdu2truesize
c_func
(paren
id|skb-&gt;len
)paren
)paren
suffix:semicolon
macro_line|#else
id|atm_return
c_func
(paren
id|vcc
comma
id|atm_pdu2truesize
c_func
(paren
id|skb-&gt;len
)paren
)paren
suffix:semicolon
macro_line|#endif
r_goto
id|INCR_DLE
suffix:semicolon
)brace
singleline_comment|// get real pkt length  pwang_test
id|trailer
op_assign
(paren
r_struct
id|cpcs_trailer
op_star
)paren
(paren
(paren
id|u_char
op_star
)paren
id|skb-&gt;data
op_plus
id|skb-&gt;len
op_minus
r_sizeof
(paren
r_struct
id|cpcs_trailer
)paren
)paren
suffix:semicolon
id|length
op_assign
id|swap
c_func
(paren
id|trailer-&gt;length
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|length
OG
id|iadev-&gt;rx_buf_sz
)paren
op_logical_or
(paren
id|length
OG
(paren
id|skb-&gt;len
op_minus
r_sizeof
(paren
r_struct
id|cpcs_trailer
)paren
)paren
)paren
)paren
(brace
id|atomic_inc
c_func
(paren
op_amp
id|vcc-&gt;stats-&gt;rx_err
)paren
suffix:semicolon
id|dev_kfree_skb_any
c_func
(paren
id|skb
)paren
suffix:semicolon
id|IF_ERR
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;rx_dle_intr: Bad  AAL5 trailer %d (skb len %d)&quot;
comma
id|length
comma
id|skb-&gt;len
)paren
suffix:semicolon
)paren
macro_line|#if LINUX_VERSION_CODE &gt;= 0x20312
id|atm_return
c_func
(paren
id|vcc
comma
id|atm_guess_pdu2truesize
c_func
(paren
id|skb-&gt;len
)paren
)paren
suffix:semicolon
macro_line|#else
id|atm_return
c_func
(paren
id|vcc
comma
id|atm_pdu2truesize
c_func
(paren
id|skb-&gt;len
)paren
)paren
suffix:semicolon
macro_line|#endif 
r_goto
id|INCR_DLE
suffix:semicolon
)brace
id|skb_trim
c_func
(paren
id|skb
comma
id|length
)paren
suffix:semicolon
multiline_comment|/* Display the packet */
id|IF_RXPKT
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;&bslash;nDmad Recvd data: len = %d &bslash;n&quot;
comma
id|skb-&gt;len
)paren
suffix:semicolon
id|xdump
c_func
(paren
id|skb-&gt;data
comma
id|skb-&gt;len
comma
l_string|&quot;RX: &quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
)paren
id|IF_RX
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;rx_dle_intr: skb push&quot;
)paren
suffix:semicolon
)paren
id|vcc
op_member_access_from_pointer
id|push
c_func
(paren
id|vcc
comma
id|skb
)paren
suffix:semicolon
id|atomic_inc
c_func
(paren
op_amp
id|vcc-&gt;stats-&gt;rx
)paren
suffix:semicolon
id|iadev-&gt;rx_pkt_cnt
op_increment
suffix:semicolon
)brace
id|INCR_DLE
suffix:colon
r_if
c_cond
(paren
op_increment
id|dle
op_eq
id|iadev-&gt;rx_dle_q.end
)paren
id|dle
op_assign
id|iadev-&gt;rx_dle_q.start
suffix:semicolon
)brace
id|iadev-&gt;rx_dle_q.read
op_assign
id|dle
suffix:semicolon
multiline_comment|/* if the interrupts are masked because there were no free desc available,  &n;&t;&t;unmask them now. */
r_if
c_cond
(paren
op_logical_neg
id|iadev-&gt;rxing
)paren
(brace
id|state
op_assign
id|readl
c_func
(paren
id|iadev-&gt;reass_reg
op_plus
id|STATE_REG
)paren
op_amp
l_int|0xffff
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|state
op_amp
id|FREEQ_EMPTY
)paren
)paren
(brace
id|state
op_assign
id|readl
c_func
(paren
id|iadev-&gt;reass_reg
op_plus
id|REASS_MASK_REG
)paren
op_amp
l_int|0xffff
suffix:semicolon
id|writel
c_func
(paren
id|state
op_amp
op_complement
(paren
id|RX_FREEQ_EMPT
op_or
multiline_comment|/* RX_EXCP_RCVD |*/
id|RX_PKT_RCVD
)paren
comma
id|iadev-&gt;reass_reg
op_plus
id|REASS_MASK_REG
)paren
suffix:semicolon
id|iadev-&gt;rxing
op_increment
suffix:semicolon
)brace
)brace
)brace
DECL|function|open_rx
r_static
r_int
id|open_rx
c_func
(paren
r_struct
id|atm_vcc
op_star
id|vcc
)paren
(brace
id|IADEV
op_star
id|iadev
suffix:semicolon
id|u_short
op_star
id|vc_table
suffix:semicolon
id|u_short
op_star
id|reass_ptr
suffix:semicolon
id|IF_EVENT
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;iadev: open_rx %d.%d&bslash;n&quot;
comma
id|vcc-&gt;vpi
comma
id|vcc-&gt;vci
)paren
suffix:semicolon
)paren
r_if
c_cond
(paren
id|vcc-&gt;qos.rxtp.traffic_class
op_eq
id|ATM_NONE
)paren
r_return
l_int|0
suffix:semicolon
id|iadev
op_assign
id|INPH_IA_DEV
c_func
(paren
id|vcc-&gt;dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|vcc-&gt;qos.rxtp.traffic_class
op_eq
id|ATM_ABR
)paren
(brace
r_if
c_cond
(paren
id|iadev-&gt;phy_type
op_amp
id|FE_25MBIT_PHY
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;IA:  ABR not support&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
)brace
multiline_comment|/* Make only this VCI in the vc table valid and let all   &n;&t;&t;others be invalid entries */
id|vc_table
op_assign
(paren
id|u_short
op_star
)paren
(paren
id|iadev-&gt;reass_ram
op_plus
id|RX_VC_TABLE
op_star
id|iadev-&gt;memSize
)paren
suffix:semicolon
id|vc_table
op_add_assign
id|vcc-&gt;vci
suffix:semicolon
multiline_comment|/* mask the last 6 bits and OR it with 3 for 1K VCs */
op_star
id|vc_table
op_assign
id|vcc-&gt;vci
op_lshift
l_int|6
suffix:semicolon
multiline_comment|/* Also keep a list of open rx vcs so that we can attach them with  &n;&t;&t;incoming PDUs later. */
r_if
c_cond
(paren
(paren
id|vcc-&gt;qos.rxtp.traffic_class
op_eq
id|ATM_ABR
)paren
op_logical_or
(paren
id|vcc-&gt;qos.txtp.traffic_class
op_eq
id|ATM_ABR
)paren
)paren
(brace
id|srv_cls_param_t
id|srv_p
suffix:semicolon
id|init_abr_vc
c_func
(paren
id|iadev
comma
op_amp
id|srv_p
)paren
suffix:semicolon
id|ia_open_abr_vc
c_func
(paren
id|iadev
comma
op_amp
id|srv_p
comma
id|vcc
comma
l_int|0
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* for UBR  later may need to add CBR logic */
id|reass_ptr
op_assign
(paren
id|u_short
op_star
)paren
(paren
id|iadev-&gt;reass_ram
op_plus
id|REASS_TABLE
op_star
id|iadev-&gt;memSize
)paren
suffix:semicolon
id|reass_ptr
op_add_assign
id|vcc-&gt;vci
suffix:semicolon
op_star
id|reass_ptr
op_assign
id|NO_AAL5_PKT
suffix:semicolon
)brace
r_if
c_cond
(paren
id|iadev-&gt;rx_open
(braket
id|vcc-&gt;vci
)braket
)paren
id|printk
c_func
(paren
id|KERN_CRIT
id|DEV_LABEL
l_string|&quot;(itf %d): VCI %d already open&bslash;n&quot;
comma
id|vcc-&gt;dev-&gt;number
comma
id|vcc-&gt;vci
)paren
suffix:semicolon
id|iadev-&gt;rx_open
(braket
id|vcc-&gt;vci
)braket
op_assign
id|vcc
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|rx_init
r_static
r_int
id|rx_init
c_func
(paren
r_struct
id|atm_dev
op_star
id|dev
)paren
(brace
id|IADEV
op_star
id|iadev
suffix:semicolon
r_struct
id|rx_buf_desc
op_star
id|buf_desc_ptr
suffix:semicolon
r_int
r_int
id|rx_pkt_start
op_assign
l_int|0
suffix:semicolon
id|u32
op_star
id|dle_addr
suffix:semicolon
r_struct
id|abr_vc_table
op_star
id|abr_vc_table
suffix:semicolon
id|u16
op_star
id|vc_table
suffix:semicolon
id|u16
op_star
id|reass_table
suffix:semicolon
id|u16
op_star
id|ptr16
suffix:semicolon
r_int
id|i
comma
id|j
comma
id|vcsize_sel
suffix:semicolon
id|u_short
id|freeq_st_adr
suffix:semicolon
id|u_short
op_star
id|freeq_start
suffix:semicolon
id|iadev
op_assign
id|INPH_IA_DEV
c_func
(paren
id|dev
)paren
suffix:semicolon
singleline_comment|//    spin_lock_init(&amp;iadev-&gt;rx_lock); 
multiline_comment|/* I need to initialize the DLEs somewhere. Lets see what I   &n;&t;&t;need to do for this, hmmm...  &n;&t;&t;- allocate memory for 256 DLEs. make sure that it starts  &n;&t;&t;on a 4k byte address boundary. Program the start address   &n;&t;&t;in Receive List address register.  ..... to do for TX also  &n;&t;   To make sure that it is a 4k byte boundary - allocate 8k and find   &n;&t;&t;4k byte boundary within.  &n;&t;&t;( (addr + (4k-1)) &amp; ~(4k-1) )  &n;&t;*/
multiline_comment|/* allocate 8k bytes */
id|dle_addr
op_assign
(paren
id|u32
op_star
)paren
id|kmalloc
c_func
(paren
l_int|2
op_star
r_sizeof
(paren
r_struct
id|dle
)paren
op_star
id|DLE_ENTRIES
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dle_addr
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
id|DEV_LABEL
l_string|&quot;can&squot;t allocate DLEs&bslash;n&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/* find 4k byte boundary within the 8k allocated */
id|dle_addr
op_assign
(paren
id|u32
op_star
)paren
(paren
(paren
(paren
id|u32
)paren
id|dle_addr
op_plus
(paren
l_int|4096
op_minus
l_int|1
)paren
)paren
op_amp
op_complement
(paren
l_int|4096
op_minus
l_int|1
)paren
)paren
suffix:semicolon
id|iadev-&gt;rx_dle_q.start
op_assign
(paren
r_struct
id|dle
op_star
)paren
id|dle_addr
suffix:semicolon
id|iadev-&gt;rx_dle_q.read
op_assign
id|iadev-&gt;rx_dle_q.start
suffix:semicolon
id|iadev-&gt;rx_dle_q.write
op_assign
id|iadev-&gt;rx_dle_q.start
suffix:semicolon
id|iadev-&gt;rx_dle_q.end
op_assign
(paren
r_struct
id|dle
op_star
)paren
(paren
(paren
id|u32
)paren
id|dle_addr
op_plus
r_sizeof
(paren
r_struct
id|dle
)paren
op_star
id|DLE_ENTRIES
)paren
suffix:semicolon
multiline_comment|/* the end of the dle q points to the entry after the last  &n;&t;DLE that can be used. */
multiline_comment|/* write the upper 20 bits of the start address to rx list address register */
id|writel
c_func
(paren
id|virt_to_bus
c_func
(paren
id|dle_addr
)paren
op_amp
l_int|0xfffff000
comma
id|iadev-&gt;dma
op_plus
id|IPHASE5575_RX_LIST_ADDR
)paren
suffix:semicolon
id|IF_INIT
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;Tx Dle list addr: 0x%08x value: 0x%0x&bslash;n&quot;
comma
(paren
id|u32
)paren
(paren
id|iadev-&gt;dma
op_plus
id|IPHASE5575_TX_LIST_ADDR
)paren
comma
op_star
(paren
id|u32
op_star
)paren
(paren
id|iadev-&gt;dma
op_plus
id|IPHASE5575_TX_LIST_ADDR
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;Rx Dle list addr: 0x%08x value: 0x%0x&bslash;n&quot;
comma
(paren
id|u32
)paren
(paren
id|iadev-&gt;dma
op_plus
id|IPHASE5575_RX_LIST_ADDR
)paren
comma
op_star
(paren
id|u32
op_star
)paren
(paren
id|iadev-&gt;dma
op_plus
id|IPHASE5575_RX_LIST_ADDR
)paren
)paren
suffix:semicolon
)paren
id|writew
c_func
(paren
l_int|0xffff
comma
id|iadev-&gt;reass_reg
op_plus
id|REASS_MASK_REG
)paren
suffix:semicolon
id|writew
c_func
(paren
l_int|0
comma
id|iadev-&gt;reass_reg
op_plus
id|MODE_REG
)paren
suffix:semicolon
id|writew
c_func
(paren
id|RESET_REASS
comma
id|iadev-&gt;reass_reg
op_plus
id|REASS_COMMAND_REG
)paren
suffix:semicolon
multiline_comment|/* Receive side control memory map  &n;&t;   -------------------------------  &n;  &n;&t;&t;Buffer descr&t;0x0000 (736 - 23K)  &n;&t;&t;VP Table&t;0x5c00 (256 - 512)  &n;&t;&t;Except q&t;0x5e00 (128 - 512)  &n;&t;&t;Free buffer q&t;0x6000 (1K - 2K)  &n;&t;&t;Packet comp q&t;0x6800 (1K - 2K)  &n;&t;&t;Reass Table&t;0x7000 (1K - 2K)  &n;&t;&t;VC Table&t;0x7800 (1K - 2K)  &n;&t;&t;ABR VC Table&t;0x8000 (1K - 32K)  &n;&t;*/
multiline_comment|/* Base address for Buffer Descriptor Table */
id|writew
c_func
(paren
id|RX_DESC_BASE
op_rshift
l_int|16
comma
id|iadev-&gt;reass_reg
op_plus
id|REASS_DESC_BASE
)paren
suffix:semicolon
multiline_comment|/* Set the buffer size register */
id|writew
c_func
(paren
id|iadev-&gt;rx_buf_sz
comma
id|iadev-&gt;reass_reg
op_plus
id|BUF_SIZE
)paren
suffix:semicolon
multiline_comment|/* Initialize each entry in the Buffer Descriptor Table */
id|iadev-&gt;RX_DESC_BASE_ADDR
op_assign
id|iadev-&gt;reass_ram
op_plus
id|RX_DESC_BASE
op_star
id|iadev-&gt;memSize
suffix:semicolon
id|buf_desc_ptr
op_assign
(paren
r_struct
id|rx_buf_desc
op_star
)paren
id|iadev-&gt;RX_DESC_BASE_ADDR
suffix:semicolon
id|memset
c_func
(paren
(paren
id|caddr_t
)paren
id|buf_desc_ptr
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|rx_buf_desc
)paren
)paren
suffix:semicolon
id|buf_desc_ptr
op_increment
suffix:semicolon
id|rx_pkt_start
op_assign
id|iadev-&gt;rx_pkt_ram
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|1
suffix:semicolon
id|i
op_le
id|iadev-&gt;num_rx_desc
suffix:semicolon
id|i
op_increment
)paren
(brace
id|memset
c_func
(paren
(paren
id|caddr_t
)paren
id|buf_desc_ptr
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|rx_buf_desc
)paren
)paren
suffix:semicolon
id|buf_desc_ptr-&gt;buf_start_hi
op_assign
id|rx_pkt_start
op_rshift
l_int|16
suffix:semicolon
id|buf_desc_ptr-&gt;buf_start_lo
op_assign
id|rx_pkt_start
op_amp
l_int|0x0000ffff
suffix:semicolon
id|buf_desc_ptr
op_increment
suffix:semicolon
id|rx_pkt_start
op_add_assign
id|iadev-&gt;rx_buf_sz
suffix:semicolon
)brace
id|IF_INIT
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;Rx Buffer desc ptr: 0x%0x&bslash;n&quot;
comma
(paren
id|u32
)paren
(paren
id|buf_desc_ptr
)paren
)paren
suffix:semicolon
)paren
id|i
op_assign
id|FREE_BUF_DESC_Q
op_star
id|iadev-&gt;memSize
suffix:semicolon
id|writew
c_func
(paren
id|i
op_rshift
l_int|16
comma
id|iadev-&gt;reass_reg
op_plus
id|REASS_QUEUE_BASE
)paren
suffix:semicolon
id|writew
c_func
(paren
id|i
comma
id|iadev-&gt;reass_reg
op_plus
id|FREEQ_ST_ADR
)paren
suffix:semicolon
id|writew
c_func
(paren
id|i
op_plus
id|iadev-&gt;num_rx_desc
op_star
r_sizeof
(paren
id|u_short
)paren
comma
id|iadev-&gt;reass_reg
op_plus
id|FREEQ_ED_ADR
)paren
suffix:semicolon
id|writew
c_func
(paren
id|i
comma
id|iadev-&gt;reass_reg
op_plus
id|FREEQ_RD_PTR
)paren
suffix:semicolon
id|writew
c_func
(paren
id|i
op_plus
id|iadev-&gt;num_rx_desc
op_star
r_sizeof
(paren
id|u_short
)paren
comma
id|iadev-&gt;reass_reg
op_plus
id|FREEQ_WR_PTR
)paren
suffix:semicolon
multiline_comment|/* Fill the FREEQ with all the free descriptors. */
id|freeq_st_adr
op_assign
id|readw
c_func
(paren
id|iadev-&gt;reass_reg
op_plus
id|FREEQ_ST_ADR
)paren
suffix:semicolon
id|freeq_start
op_assign
(paren
id|u_short
op_star
)paren
(paren
id|iadev-&gt;reass_ram
op_plus
id|freeq_st_adr
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|1
suffix:semicolon
id|i
op_le
id|iadev-&gt;num_rx_desc
suffix:semicolon
id|i
op_increment
)paren
(brace
op_star
id|freeq_start
op_assign
(paren
id|u_short
)paren
id|i
suffix:semicolon
id|freeq_start
op_increment
suffix:semicolon
)brace
id|IF_INIT
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;freeq_start: 0x%0x&bslash;n&quot;
comma
(paren
id|u32
)paren
id|freeq_start
)paren
suffix:semicolon
)paren
multiline_comment|/* Packet Complete Queue */
id|i
op_assign
(paren
id|PKT_COMP_Q
op_star
id|iadev-&gt;memSize
)paren
op_amp
l_int|0xffff
suffix:semicolon
id|writew
c_func
(paren
id|i
comma
id|iadev-&gt;reass_reg
op_plus
id|PCQ_ST_ADR
)paren
suffix:semicolon
id|writew
c_func
(paren
id|i
op_plus
id|iadev-&gt;num_vc
op_star
r_sizeof
(paren
id|u_short
)paren
comma
id|iadev-&gt;reass_reg
op_plus
id|PCQ_ED_ADR
)paren
suffix:semicolon
id|writew
c_func
(paren
id|i
comma
id|iadev-&gt;reass_reg
op_plus
id|PCQ_RD_PTR
)paren
suffix:semicolon
id|writew
c_func
(paren
id|i
comma
id|iadev-&gt;reass_reg
op_plus
id|PCQ_WR_PTR
)paren
suffix:semicolon
multiline_comment|/* Exception Queue */
id|i
op_assign
(paren
id|EXCEPTION_Q
op_star
id|iadev-&gt;memSize
)paren
op_amp
l_int|0xffff
suffix:semicolon
id|writew
c_func
(paren
id|i
comma
id|iadev-&gt;reass_reg
op_plus
id|EXCP_Q_ST_ADR
)paren
suffix:semicolon
id|writew
c_func
(paren
id|i
op_plus
id|NUM_RX_EXCP
op_star
r_sizeof
(paren
id|RX_ERROR_Q
)paren
comma
id|iadev-&gt;reass_reg
op_plus
id|EXCP_Q_ED_ADR
)paren
suffix:semicolon
id|writew
c_func
(paren
id|i
comma
id|iadev-&gt;reass_reg
op_plus
id|EXCP_Q_RD_PTR
)paren
suffix:semicolon
id|writew
c_func
(paren
id|i
comma
id|iadev-&gt;reass_reg
op_plus
id|EXCP_Q_WR_PTR
)paren
suffix:semicolon
multiline_comment|/* Load local copy of FREEQ and PCQ ptrs */
id|iadev-&gt;rfL.fdq_st
op_assign
id|readw
c_func
(paren
id|iadev-&gt;reass_reg
op_plus
id|FREEQ_ST_ADR
)paren
op_amp
l_int|0xffff
suffix:semicolon
id|iadev-&gt;rfL.fdq_ed
op_assign
id|readw
c_func
(paren
id|iadev-&gt;reass_reg
op_plus
id|FREEQ_ED_ADR
)paren
op_amp
l_int|0xffff
suffix:semicolon
id|iadev-&gt;rfL.fdq_rd
op_assign
id|readw
c_func
(paren
id|iadev-&gt;reass_reg
op_plus
id|FREEQ_RD_PTR
)paren
op_amp
l_int|0xffff
suffix:semicolon
id|iadev-&gt;rfL.fdq_wr
op_assign
id|readw
c_func
(paren
id|iadev-&gt;reass_reg
op_plus
id|FREEQ_WR_PTR
)paren
op_amp
l_int|0xffff
suffix:semicolon
id|iadev-&gt;rfL.pcq_st
op_assign
id|readw
c_func
(paren
id|iadev-&gt;reass_reg
op_plus
id|PCQ_ST_ADR
)paren
op_amp
l_int|0xffff
suffix:semicolon
id|iadev-&gt;rfL.pcq_ed
op_assign
id|readw
c_func
(paren
id|iadev-&gt;reass_reg
op_plus
id|PCQ_ED_ADR
)paren
op_amp
l_int|0xffff
suffix:semicolon
id|iadev-&gt;rfL.pcq_rd
op_assign
id|readw
c_func
(paren
id|iadev-&gt;reass_reg
op_plus
id|PCQ_RD_PTR
)paren
op_amp
l_int|0xffff
suffix:semicolon
id|iadev-&gt;rfL.pcq_wr
op_assign
id|readw
c_func
(paren
id|iadev-&gt;reass_reg
op_plus
id|PCQ_WR_PTR
)paren
op_amp
l_int|0xffff
suffix:semicolon
id|IF_INIT
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;INIT:pcq_st:0x%x pcq_ed:0x%x pcq_rd:0x%x pcq_wr:0x%x&quot;
comma
id|iadev-&gt;rfL.pcq_st
comma
id|iadev-&gt;rfL.pcq_ed
comma
id|iadev-&gt;rfL.pcq_rd
comma
id|iadev-&gt;rfL.pcq_wr
)paren
suffix:semicolon
)paren
multiline_comment|/* just for check - no VP TBL */
multiline_comment|/* VP Table */
multiline_comment|/* writew(0x0b80, iadev-&gt;reass_reg+VP_LKUP_BASE); */
multiline_comment|/* initialize VP Table for invalid VPIs  &n;&t;&t;- I guess we can write all 1s or 0x000f in the entire memory  &n;&t;&t;  space or something similar.  &n;&t;*/
multiline_comment|/* This seems to work and looks right to me too !!! */
id|i
op_assign
id|REASS_TABLE
op_star
id|iadev-&gt;memSize
suffix:semicolon
id|writew
c_func
(paren
(paren
id|i
op_rshift
l_int|3
)paren
comma
id|iadev-&gt;reass_reg
op_plus
id|REASS_TABLE_BASE
)paren
suffix:semicolon
multiline_comment|/* initialize Reassembly table to I don&squot;t know what ???? */
id|reass_table
op_assign
(paren
id|u16
op_star
)paren
(paren
id|iadev-&gt;reass_ram
op_plus
id|i
)paren
suffix:semicolon
id|j
op_assign
id|REASS_TABLE_SZ
op_star
id|iadev-&gt;memSize
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|j
suffix:semicolon
id|i
op_increment
)paren
(brace
op_star
id|reass_table
op_increment
op_assign
id|NO_AAL5_PKT
suffix:semicolon
)brace
id|i
op_assign
l_int|8
op_star
l_int|1024
suffix:semicolon
id|vcsize_sel
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
id|i
op_ne
id|iadev-&gt;num_vc
)paren
(brace
id|i
op_div_assign
l_int|2
suffix:semicolon
id|vcsize_sel
op_increment
suffix:semicolon
)brace
id|i
op_assign
id|RX_VC_TABLE
op_star
id|iadev-&gt;memSize
suffix:semicolon
id|writew
c_func
(paren
(paren
(paren
id|i
op_rshift
l_int|3
)paren
op_amp
l_int|0xfff8
)paren
op_or
id|vcsize_sel
comma
id|iadev-&gt;reass_reg
op_plus
id|VC_LKUP_BASE
)paren
suffix:semicolon
id|vc_table
op_assign
(paren
id|u16
op_star
)paren
(paren
id|iadev-&gt;reass_ram
op_plus
id|RX_VC_TABLE
op_star
id|iadev-&gt;memSize
)paren
suffix:semicolon
id|j
op_assign
id|RX_VC_TABLE_SZ
op_star
id|iadev-&gt;memSize
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|j
suffix:semicolon
id|i
op_increment
)paren
(brace
multiline_comment|/* shift the reassembly pointer by 3 + lower 3 bits of   &n;&t;&t;vc_lkup_base register (=3 for 1K VCs) and the last byte   &n;&t;&t;is those low 3 bits.   &n;&t;&t;Shall program this later.  &n;&t;&t;*/
op_star
id|vc_table
op_assign
(paren
id|i
op_lshift
l_int|6
)paren
op_or
l_int|15
suffix:semicolon
multiline_comment|/* for invalid VCI */
id|vc_table
op_increment
suffix:semicolon
)brace
multiline_comment|/* ABR VC table */
id|i
op_assign
id|ABR_VC_TABLE
op_star
id|iadev-&gt;memSize
suffix:semicolon
id|writew
c_func
(paren
id|i
op_rshift
l_int|3
comma
id|iadev-&gt;reass_reg
op_plus
id|ABR_LKUP_BASE
)paren
suffix:semicolon
id|i
op_assign
id|ABR_VC_TABLE
op_star
id|iadev-&gt;memSize
suffix:semicolon
id|abr_vc_table
op_assign
(paren
r_struct
id|abr_vc_table
op_star
)paren
(paren
id|iadev-&gt;reass_ram
op_plus
id|i
)paren
suffix:semicolon
id|j
op_assign
id|REASS_TABLE_SZ
op_star
id|iadev-&gt;memSize
suffix:semicolon
id|memset
(paren
(paren
r_char
op_star
)paren
id|abr_vc_table
comma
l_int|0
comma
id|j
op_star
r_sizeof
(paren
r_struct
id|abr_vc_table
)paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|j
suffix:semicolon
id|i
op_increment
)paren
(brace
id|abr_vc_table-&gt;rdf
op_assign
l_int|0x0003
suffix:semicolon
id|abr_vc_table-&gt;air
op_assign
l_int|0x5eb1
suffix:semicolon
id|abr_vc_table
op_increment
suffix:semicolon
)brace
multiline_comment|/* Initialize other registers */
multiline_comment|/* VP Filter Register set for VC Reassembly only */
id|writew
c_func
(paren
l_int|0xff00
comma
id|iadev-&gt;reass_reg
op_plus
id|VP_FILTER
)paren
suffix:semicolon
id|writew
c_func
(paren
l_int|0
comma
id|iadev-&gt;reass_reg
op_plus
id|XTRA_RM_OFFSET
)paren
suffix:semicolon
id|writew
c_func
(paren
l_int|0x1
comma
id|iadev-&gt;reass_reg
op_plus
id|PROTOCOL_ID
)paren
suffix:semicolon
multiline_comment|/* Packet Timeout Count  related Registers : &n;&t;   Set packet timeout to occur in about 3 seconds&n;&t;   Set Packet Aging Interval count register to overflow in about 4 us&n; &t;*/
id|writew
c_func
(paren
l_int|0xF6F8
comma
id|iadev-&gt;reass_reg
op_plus
id|PKT_TM_CNT
)paren
suffix:semicolon
id|ptr16
op_assign
(paren
id|u16
op_star
)paren
id|j
suffix:semicolon
id|i
op_assign
(paren
(paren
id|u32
)paren
id|ptr16
op_rshift
l_int|6
)paren
op_amp
l_int|0xff
suffix:semicolon
id|ptr16
op_add_assign
id|j
op_minus
l_int|1
suffix:semicolon
id|i
op_or_assign
(paren
(paren
(paren
id|u32
)paren
id|ptr16
op_lshift
l_int|2
)paren
op_amp
l_int|0xff00
)paren
suffix:semicolon
id|writew
c_func
(paren
id|i
comma
id|iadev-&gt;reass_reg
op_plus
id|TMOUT_RANGE
)paren
suffix:semicolon
multiline_comment|/* initiate the desc_tble */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|iadev-&gt;num_tx_desc
suffix:semicolon
id|i
op_increment
)paren
(brace
id|iadev-&gt;desc_tbl
(braket
id|i
)braket
dot
id|timestamp
op_assign
l_int|0
suffix:semicolon
)brace
multiline_comment|/* to clear the interrupt status register - read it */
id|readw
c_func
(paren
id|iadev-&gt;reass_reg
op_plus
id|REASS_INTR_STATUS_REG
)paren
suffix:semicolon
multiline_comment|/* Mask Register - clear it */
id|writew
c_func
(paren
op_complement
(paren
id|RX_FREEQ_EMPT
op_or
id|RX_PKT_RCVD
)paren
comma
id|iadev-&gt;reass_reg
op_plus
id|REASS_MASK_REG
)paren
suffix:semicolon
id|skb_queue_head_init
c_func
(paren
op_amp
id|iadev-&gt;rx_dma_q
)paren
suffix:semicolon
id|iadev-&gt;rx_free_desc_qhead
op_assign
l_int|NULL
suffix:semicolon
id|iadev-&gt;rx_open
op_assign
(paren
r_struct
id|atm_vcc
op_star
op_star
)paren
id|kmalloc
c_func
(paren
l_int|4
op_star
id|iadev-&gt;num_vc
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|iadev-&gt;rx_open
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
id|DEV_LABEL
l_string|&quot;itf %d couldn&squot;t get free page&bslash;n&quot;
comma
id|dev-&gt;number
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|memset
c_func
(paren
id|iadev-&gt;rx_open
comma
l_int|0
comma
l_int|4
op_star
id|iadev-&gt;num_vc
)paren
suffix:semicolon
id|iadev-&gt;rxing
op_assign
l_int|1
suffix:semicolon
id|iadev-&gt;rx_pkt_cnt
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Mode Register */
id|writew
c_func
(paren
id|R_ONLINE
comma
id|iadev-&gt;reass_reg
op_plus
id|MODE_REG
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*  &n;&t;The memory map suggested in appendix A and the coding for it.   &n;&t;Keeping it around just in case we change our mind later.  &n;  &n;&t;&t;Buffer descr&t;0x0000 (128 - 4K)  &n;&t;&t;UBR sched&t;0x1000 (1K - 4K)  &n;&t;&t;UBR Wait q&t;0x2000 (1K - 4K)  &n;&t;&t;Commn queues&t;0x3000 Packet Ready, Trasmit comp(0x3100)  &n;&t;&t;&t;&t;&t;(128 - 256) each  &n;&t;&t;extended VC&t;0x4000 (1K - 8K)  &n;&t;&t;ABR sched&t;0x6000&t;and ABR wait queue (1K - 2K) each  &n;&t;&t;CBR sched&t;0x7000 (as needed)  &n;&t;&t;VC table&t;0x8000 (1K - 32K)  &n;*/
DECL|function|tx_intr
r_static
r_void
id|tx_intr
c_func
(paren
r_struct
id|atm_dev
op_star
id|dev
)paren
(brace
id|IADEV
op_star
id|iadev
suffix:semicolon
r_int
r_int
id|status
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|iadev
op_assign
id|INPH_IA_DEV
c_func
(paren
id|dev
)paren
suffix:semicolon
id|status
op_assign
id|readl
c_func
(paren
id|iadev-&gt;seg_reg
op_plus
id|SEG_INTR_STATUS_REG
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
id|TRANSMIT_DONE
)paren
(brace
id|IF_EVENT
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;Tansmit Done Intr logic run&bslash;n&quot;
)paren
suffix:semicolon
)paren
id|spin_lock_irqsave
c_func
(paren
op_amp
id|iadev-&gt;tx_lock
comma
id|flags
)paren
suffix:semicolon
id|ia_tx_poll
c_func
(paren
id|iadev
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|iadev-&gt;tx_lock
comma
id|flags
)paren
suffix:semicolon
id|writew
c_func
(paren
id|TRANSMIT_DONE
comma
id|iadev-&gt;seg_reg
op_plus
id|SEG_INTR_STATUS_REG
)paren
suffix:semicolon
r_if
c_cond
(paren
id|iadev-&gt;close_pending
)paren
id|wake_up
c_func
(paren
op_amp
id|iadev-&gt;close_wait
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|status
op_amp
id|TCQ_NOT_EMPTY
)paren
(brace
id|IF_EVENT
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;TCQ_NOT_EMPTY int received&bslash;n&quot;
)paren
suffix:semicolon
)paren
)brace
)brace
DECL|function|tx_dle_intr
r_static
r_void
id|tx_dle_intr
c_func
(paren
r_struct
id|atm_dev
op_star
id|dev
)paren
(brace
id|IADEV
op_star
id|iadev
suffix:semicolon
r_struct
id|dle
op_star
id|dle
comma
op_star
id|cur_dle
suffix:semicolon
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
r_struct
id|atm_vcc
op_star
id|vcc
suffix:semicolon
r_struct
id|ia_vcc
op_star
id|iavcc
suffix:semicolon
id|u_int
id|dle_lp
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|iadev
op_assign
id|INPH_IA_DEV
c_func
(paren
id|dev
)paren
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|iadev-&gt;tx_lock
comma
id|flags
)paren
suffix:semicolon
id|dle
op_assign
id|iadev-&gt;tx_dle_q.read
suffix:semicolon
id|dle_lp
op_assign
id|readl
c_func
(paren
id|iadev-&gt;dma
op_plus
id|IPHASE5575_TX_LIST_ADDR
)paren
op_amp
(paren
r_sizeof
(paren
r_struct
id|dle
)paren
op_star
id|DLE_ENTRIES
op_minus
l_int|1
)paren
suffix:semicolon
id|cur_dle
op_assign
(paren
r_struct
id|dle
op_star
)paren
(paren
id|iadev-&gt;tx_dle_q.start
op_plus
(paren
id|dle_lp
op_rshift
l_int|4
)paren
)paren
suffix:semicolon
r_while
c_loop
(paren
id|dle
op_ne
id|cur_dle
)paren
(brace
multiline_comment|/* free the DMAed skb */
id|skb
op_assign
id|skb_dequeue
c_func
(paren
op_amp
id|iadev-&gt;tx_dma_q
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|skb
)paren
r_break
suffix:semicolon
id|vcc
op_assign
id|ATM_SKB
c_func
(paren
id|skb
)paren
op_member_access_from_pointer
id|vcc
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|vcc
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;tx_dle_intr: vcc is null&bslash;n&quot;
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|iadev-&gt;tx_lock
comma
id|flags
)paren
suffix:semicolon
id|dev_kfree_skb_any
c_func
(paren
id|skb
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|iavcc
op_assign
id|INPH_IA_VCC
c_func
(paren
id|vcc
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|iavcc
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;tx_dle_intr: iavcc is null&bslash;n&quot;
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|iadev-&gt;tx_lock
comma
id|flags
)paren
suffix:semicolon
id|dev_kfree_skb_any
c_func
(paren
id|skb
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|vcc-&gt;qos.txtp.pcr
op_ge
id|iadev-&gt;rate_limit
)paren
(brace
r_if
c_cond
(paren
(paren
id|vcc-&gt;pop
)paren
op_logical_and
(paren
id|skb-&gt;len
op_ne
l_int|0
)paren
)paren
(brace
id|vcc
op_member_access_from_pointer
id|pop
c_func
(paren
id|vcc
comma
id|skb
)paren
suffix:semicolon
)brace
r_else
(brace
id|dev_kfree_skb_any
c_func
(paren
id|skb
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
multiline_comment|/* Hold the rate-limited skb for flow control */
id|IA_SKB_STATE
c_func
(paren
id|skb
)paren
op_or_assign
id|IA_DLED
suffix:semicolon
id|skb_queue_tail
c_func
(paren
op_amp
id|iavcc-&gt;txing_skb
comma
id|skb
)paren
suffix:semicolon
)brace
id|IF_EVENT
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;tx_dle_intr: enque skb = 0x%x &bslash;n&quot;
comma
(paren
id|u32
)paren
id|skb
)paren
suffix:semicolon
)paren
r_if
c_cond
(paren
op_increment
id|dle
op_eq
id|iadev-&gt;tx_dle_q.end
)paren
id|dle
op_assign
id|iadev-&gt;tx_dle_q.start
suffix:semicolon
)brace
id|iadev-&gt;tx_dle_q.read
op_assign
id|dle
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|iadev-&gt;tx_lock
comma
id|flags
)paren
suffix:semicolon
)brace
DECL|function|open_tx
r_static
r_int
id|open_tx
c_func
(paren
r_struct
id|atm_vcc
op_star
id|vcc
)paren
(brace
r_struct
id|ia_vcc
op_star
id|ia_vcc
suffix:semicolon
id|IADEV
op_star
id|iadev
suffix:semicolon
r_struct
id|main_vc
op_star
id|vc
suffix:semicolon
r_struct
id|ext_vc
op_star
id|evc
suffix:semicolon
r_int
id|ret
suffix:semicolon
id|IF_EVENT
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;iadev: open_tx entered vcc-&gt;vci = %d&bslash;n&quot;
comma
id|vcc-&gt;vci
)paren
suffix:semicolon
)paren
r_if
c_cond
(paren
id|vcc-&gt;qos.txtp.traffic_class
op_eq
id|ATM_NONE
)paren
r_return
l_int|0
suffix:semicolon
id|iadev
op_assign
id|INPH_IA_DEV
c_func
(paren
id|vcc-&gt;dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|iadev-&gt;phy_type
op_amp
id|FE_25MBIT_PHY
)paren
(brace
r_if
c_cond
(paren
id|vcc-&gt;qos.txtp.traffic_class
op_eq
id|ATM_ABR
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;IA:  ABR not support&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|vcc-&gt;qos.txtp.traffic_class
op_eq
id|ATM_CBR
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;IA:  CBR not support&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
)brace
id|ia_vcc
op_assign
id|INPH_IA_VCC
c_func
(paren
id|vcc
)paren
suffix:semicolon
id|memset
c_func
(paren
(paren
id|caddr_t
)paren
id|ia_vcc
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|ia_vcc
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|vcc-&gt;qos.txtp.max_sdu
OG
(paren
id|iadev-&gt;tx_buf_sz
op_minus
r_sizeof
(paren
r_struct
id|cpcs_trailer
)paren
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;IA:  SDU size over the configured SDU size %d&bslash;n&quot;
comma
id|iadev-&gt;tx_buf_sz
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|ia_vcc
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|ia_vcc-&gt;vc_desc_cnt
op_assign
l_int|0
suffix:semicolon
id|ia_vcc-&gt;txing
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* find pcr */
r_if
c_cond
(paren
id|vcc-&gt;qos.txtp.max_pcr
op_eq
id|ATM_MAX_PCR
)paren
id|vcc-&gt;qos.txtp.pcr
op_assign
id|iadev-&gt;LineRate
suffix:semicolon
r_else
r_if
c_cond
(paren
(paren
id|vcc-&gt;qos.txtp.max_pcr
op_eq
l_int|0
)paren
op_logical_and
(paren
id|vcc-&gt;qos.txtp.pcr
op_le
l_int|0
)paren
)paren
id|vcc-&gt;qos.txtp.pcr
op_assign
id|iadev-&gt;LineRate
suffix:semicolon
r_else
r_if
c_cond
(paren
(paren
id|vcc-&gt;qos.txtp.max_pcr
OG
id|vcc-&gt;qos.txtp.pcr
)paren
op_logical_and
(paren
id|vcc-&gt;qos.txtp.max_pcr
OG
l_int|0
)paren
)paren
id|vcc-&gt;qos.txtp.pcr
op_assign
id|vcc-&gt;qos.txtp.max_pcr
suffix:semicolon
r_if
c_cond
(paren
id|vcc-&gt;qos.txtp.pcr
OG
id|iadev-&gt;LineRate
)paren
id|vcc-&gt;qos.txtp.pcr
op_assign
id|iadev-&gt;LineRate
suffix:semicolon
id|ia_vcc-&gt;pcr
op_assign
id|vcc-&gt;qos.txtp.pcr
suffix:semicolon
r_if
c_cond
(paren
id|ia_vcc-&gt;pcr
OG
(paren
id|iadev-&gt;LineRate
op_div
l_int|6
)paren
)paren
id|ia_vcc-&gt;ltimeout
op_assign
id|HZ
op_div
l_int|10
suffix:semicolon
r_else
r_if
c_cond
(paren
id|ia_vcc-&gt;pcr
OG
(paren
id|iadev-&gt;LineRate
op_div
l_int|130
)paren
)paren
id|ia_vcc-&gt;ltimeout
op_assign
id|HZ
suffix:semicolon
r_else
r_if
c_cond
(paren
id|ia_vcc-&gt;pcr
op_le
l_int|170
)paren
id|ia_vcc-&gt;ltimeout
op_assign
l_int|16
op_star
id|HZ
suffix:semicolon
r_else
id|ia_vcc-&gt;ltimeout
op_assign
l_int|2700
op_star
id|HZ
op_div
id|ia_vcc-&gt;pcr
suffix:semicolon
r_if
c_cond
(paren
id|ia_vcc-&gt;pcr
OL
id|iadev-&gt;rate_limit
)paren
id|skb_queue_head_init
(paren
op_amp
id|ia_vcc-&gt;txing_skb
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ia_vcc-&gt;pcr
OL
id|iadev-&gt;rate_limit
)paren
(brace
r_if
c_cond
(paren
id|vcc-&gt;qos.txtp.max_sdu
op_ne
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|ia_vcc-&gt;pcr
OG
l_int|60000
)paren
id|vcc-&gt;sk-&gt;sndbuf
op_assign
id|vcc-&gt;qos.txtp.max_sdu
op_star
l_int|5
suffix:semicolon
r_else
r_if
c_cond
(paren
id|ia_vcc-&gt;pcr
OG
l_int|2000
)paren
id|vcc-&gt;sk-&gt;sndbuf
op_assign
id|vcc-&gt;qos.txtp.max_sdu
op_star
l_int|4
suffix:semicolon
r_else
id|vcc-&gt;sk-&gt;sndbuf
op_assign
l_int|3
op_star
id|vcc-&gt;qos.txtp.max_sdu
suffix:semicolon
)brace
r_else
id|vcc-&gt;sk-&gt;sndbuf
op_assign
l_int|24576
suffix:semicolon
)brace
id|vc
op_assign
(paren
r_struct
id|main_vc
op_star
)paren
id|iadev-&gt;MAIN_VC_TABLE_ADDR
suffix:semicolon
id|evc
op_assign
(paren
r_struct
id|ext_vc
op_star
)paren
id|iadev-&gt;EXT_VC_TABLE_ADDR
suffix:semicolon
id|vc
op_add_assign
id|vcc-&gt;vci
suffix:semicolon
id|evc
op_add_assign
id|vcc-&gt;vci
suffix:semicolon
id|memset
c_func
(paren
(paren
id|caddr_t
)paren
id|vc
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|main_vc
)paren
)paren
suffix:semicolon
id|memset
c_func
(paren
(paren
id|caddr_t
)paren
id|evc
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|ext_vc
)paren
)paren
suffix:semicolon
multiline_comment|/* store the most significant 4 bits of vci as the last 4 bits   &n;&t;&t;of first part of atm header.  &n;&t;   store the last 12 bits of vci as first 12 bits of the second  &n;&t;&t;part of the atm header.  &n;&t;*/
id|evc-&gt;atm_hdr1
op_assign
(paren
id|vcc-&gt;vci
op_rshift
l_int|12
)paren
op_amp
l_int|0x000f
suffix:semicolon
id|evc-&gt;atm_hdr2
op_assign
(paren
id|vcc-&gt;vci
op_amp
l_int|0x0fff
)paren
op_lshift
l_int|4
suffix:semicolon
multiline_comment|/* check the following for different traffic classes */
r_if
c_cond
(paren
id|vcc-&gt;qos.txtp.traffic_class
op_eq
id|ATM_UBR
)paren
(brace
id|vc-&gt;type
op_assign
id|UBR
suffix:semicolon
id|vc-&gt;status
op_assign
id|CRC_APPEND
suffix:semicolon
id|vc-&gt;acr
op_assign
id|cellrate_to_float
c_func
(paren
id|iadev-&gt;LineRate
)paren
suffix:semicolon
r_if
c_cond
(paren
id|vcc-&gt;qos.txtp.pcr
OG
l_int|0
)paren
id|vc-&gt;acr
op_assign
id|cellrate_to_float
c_func
(paren
id|vcc-&gt;qos.txtp.pcr
)paren
suffix:semicolon
id|IF_UBR
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;UBR: txtp.pcr = 0x%x f_rate = 0x%x&bslash;n&quot;
comma
id|vcc-&gt;qos.txtp.max_pcr
comma
id|vc-&gt;acr
)paren
suffix:semicolon
)paren
)brace
r_else
r_if
c_cond
(paren
id|vcc-&gt;qos.txtp.traffic_class
op_eq
id|ATM_ABR
)paren
(brace
id|srv_cls_param_t
id|srv_p
suffix:semicolon
id|IF_ABR
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;Tx ABR VCC&bslash;n&quot;
)paren
suffix:semicolon
)paren
id|init_abr_vc
c_func
(paren
id|iadev
comma
op_amp
id|srv_p
)paren
suffix:semicolon
r_if
c_cond
(paren
id|vcc-&gt;qos.txtp.pcr
OG
l_int|0
)paren
id|srv_p.pcr
op_assign
id|vcc-&gt;qos.txtp.pcr
suffix:semicolon
r_if
c_cond
(paren
id|vcc-&gt;qos.txtp.min_pcr
OG
l_int|0
)paren
(brace
r_int
id|tmpsum
op_assign
id|iadev-&gt;sum_mcr
op_plus
id|iadev-&gt;sum_cbr
op_plus
id|vcc-&gt;qos.txtp.min_pcr
suffix:semicolon
r_if
c_cond
(paren
id|tmpsum
OG
id|iadev-&gt;LineRate
)paren
r_return
op_minus
id|EBUSY
suffix:semicolon
id|srv_p.mcr
op_assign
id|vcc-&gt;qos.txtp.min_pcr
suffix:semicolon
id|iadev-&gt;sum_mcr
op_add_assign
id|vcc-&gt;qos.txtp.min_pcr
suffix:semicolon
)brace
r_else
id|srv_p.mcr
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|vcc-&gt;qos.txtp.icr
)paren
id|srv_p.icr
op_assign
id|vcc-&gt;qos.txtp.icr
suffix:semicolon
r_if
c_cond
(paren
id|vcc-&gt;qos.txtp.tbe
)paren
id|srv_p.tbe
op_assign
id|vcc-&gt;qos.txtp.tbe
suffix:semicolon
r_if
c_cond
(paren
id|vcc-&gt;qos.txtp.frtt
)paren
id|srv_p.frtt
op_assign
id|vcc-&gt;qos.txtp.frtt
suffix:semicolon
r_if
c_cond
(paren
id|vcc-&gt;qos.txtp.rif
)paren
id|srv_p.rif
op_assign
id|vcc-&gt;qos.txtp.rif
suffix:semicolon
r_if
c_cond
(paren
id|vcc-&gt;qos.txtp.rdf
)paren
id|srv_p.rdf
op_assign
id|vcc-&gt;qos.txtp.rdf
suffix:semicolon
r_if
c_cond
(paren
id|vcc-&gt;qos.txtp.nrm_pres
)paren
id|srv_p.nrm
op_assign
id|vcc-&gt;qos.txtp.nrm
suffix:semicolon
r_if
c_cond
(paren
id|vcc-&gt;qos.txtp.trm_pres
)paren
id|srv_p.trm
op_assign
id|vcc-&gt;qos.txtp.trm
suffix:semicolon
r_if
c_cond
(paren
id|vcc-&gt;qos.txtp.adtf_pres
)paren
id|srv_p.adtf
op_assign
id|vcc-&gt;qos.txtp.adtf
suffix:semicolon
r_if
c_cond
(paren
id|vcc-&gt;qos.txtp.cdf_pres
)paren
id|srv_p.cdf
op_assign
id|vcc-&gt;qos.txtp.cdf
suffix:semicolon
r_if
c_cond
(paren
id|srv_p.icr
OG
id|srv_p.pcr
)paren
id|srv_p.icr
op_assign
id|srv_p.pcr
suffix:semicolon
id|IF_ABR
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;ABR:vcc-&gt;qos.txtp.max_pcr = %d  mcr = %d&bslash;n&quot;
comma
id|srv_p.pcr
comma
id|srv_p.mcr
)paren
suffix:semicolon
)paren
id|ia_open_abr_vc
c_func
(paren
id|iadev
comma
op_amp
id|srv_p
comma
id|vcc
comma
l_int|1
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|vcc-&gt;qos.txtp.traffic_class
op_eq
id|ATM_CBR
)paren
(brace
r_if
c_cond
(paren
id|iadev-&gt;phy_type
op_amp
id|FE_25MBIT_PHY
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;IA:  CBR not support&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|vcc-&gt;qos.txtp.max_pcr
OG
id|iadev-&gt;LineRate
)paren
(brace
id|IF_CBR
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;PCR is not availble&bslash;n&quot;
)paren
suffix:semicolon
)paren
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|vc-&gt;type
op_assign
id|CBR
suffix:semicolon
id|vc-&gt;status
op_assign
id|CRC_APPEND
suffix:semicolon
r_if
c_cond
(paren
(paren
id|ret
op_assign
id|ia_cbr_setup
(paren
id|iadev
comma
id|vcc
)paren
)paren
OL
l_int|0
)paren
(brace
r_return
id|ret
suffix:semicolon
)brace
)brace
r_else
id|printk
c_func
(paren
l_string|&quot;iadev:  Non UBR, ABR and CBR traffic not supportedn&quot;
)paren
suffix:semicolon
id|iadev-&gt;testTable
(braket
id|vcc-&gt;vci
)braket
op_member_access_from_pointer
id|vc_status
op_or_assign
id|VC_ACTIVE
suffix:semicolon
id|IF_EVENT
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;ia open_tx returning &bslash;n&quot;
)paren
suffix:semicolon
)paren
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|tx_init
r_static
r_int
id|tx_init
c_func
(paren
r_struct
id|atm_dev
op_star
id|dev
)paren
(brace
id|IADEV
op_star
id|iadev
suffix:semicolon
r_struct
id|tx_buf_desc
op_star
id|buf_desc_ptr
suffix:semicolon
r_int
r_int
id|tx_pkt_start
suffix:semicolon
id|u32
op_star
id|dle_addr
suffix:semicolon
r_int
id|i
suffix:semicolon
id|u_short
id|tcq_st_adr
suffix:semicolon
id|u_short
op_star
id|tcq_start
suffix:semicolon
id|u_short
id|prq_st_adr
suffix:semicolon
id|u_short
op_star
id|prq_start
suffix:semicolon
r_struct
id|main_vc
op_star
id|vc
suffix:semicolon
r_struct
id|ext_vc
op_star
id|evc
suffix:semicolon
id|u_short
id|tmp16
suffix:semicolon
id|u32
id|vcsize_sel
suffix:semicolon
id|iadev
op_assign
id|INPH_IA_DEV
c_func
(paren
id|dev
)paren
suffix:semicolon
id|spin_lock_init
c_func
(paren
op_amp
id|iadev-&gt;tx_lock
)paren
suffix:semicolon
id|IF_INIT
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;Tx MASK REG: 0x%0x&bslash;n&quot;
comma
id|readw
c_func
(paren
id|iadev-&gt;seg_reg
op_plus
id|SEG_MASK_REG
)paren
)paren
suffix:semicolon
)paren
multiline_comment|/*---------- Initializing Transmit DLEs ----------*/
multiline_comment|/* allocating 8k memory for transmit DLEs */
id|dle_addr
op_assign
(paren
id|u32
op_star
)paren
id|kmalloc
c_func
(paren
l_int|2
op_star
r_sizeof
(paren
r_struct
id|dle
)paren
op_star
id|DLE_ENTRIES
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dle_addr
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
id|DEV_LABEL
l_string|&quot;can&squot;t allocate TX DLEs&bslash;n&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/* find 4k byte boundary within the 8k allocated */
id|dle_addr
op_assign
(paren
id|u32
op_star
)paren
(paren
(paren
(paren
id|u32
)paren
id|dle_addr
op_plus
(paren
l_int|4096
op_minus
l_int|1
)paren
)paren
op_amp
op_complement
(paren
l_int|4096
op_minus
l_int|1
)paren
)paren
suffix:semicolon
id|iadev-&gt;tx_dle_q.start
op_assign
(paren
r_struct
id|dle
op_star
)paren
id|dle_addr
suffix:semicolon
id|iadev-&gt;tx_dle_q.read
op_assign
id|iadev-&gt;tx_dle_q.start
suffix:semicolon
id|iadev-&gt;tx_dle_q.write
op_assign
id|iadev-&gt;tx_dle_q.start
suffix:semicolon
id|iadev-&gt;tx_dle_q.end
op_assign
(paren
r_struct
id|dle
op_star
)paren
(paren
(paren
id|u32
)paren
id|dle_addr
op_plus
r_sizeof
(paren
r_struct
id|dle
)paren
op_star
id|DLE_ENTRIES
)paren
suffix:semicolon
multiline_comment|/* write the upper 20 bits of the start address to tx list address register */
id|writel
c_func
(paren
id|virt_to_bus
c_func
(paren
id|dle_addr
)paren
op_amp
l_int|0xfffff000
comma
id|iadev-&gt;dma
op_plus
id|IPHASE5575_TX_LIST_ADDR
)paren
suffix:semicolon
id|writew
c_func
(paren
l_int|0xffff
comma
id|iadev-&gt;seg_reg
op_plus
id|SEG_MASK_REG
)paren
suffix:semicolon
id|writew
c_func
(paren
l_int|0
comma
id|iadev-&gt;seg_reg
op_plus
id|MODE_REG_0
)paren
suffix:semicolon
id|writew
c_func
(paren
id|RESET_SEG
comma
id|iadev-&gt;seg_reg
op_plus
id|SEG_COMMAND_REG
)paren
suffix:semicolon
id|iadev-&gt;MAIN_VC_TABLE_ADDR
op_assign
id|iadev-&gt;seg_ram
op_plus
id|MAIN_VC_TABLE
op_star
id|iadev-&gt;memSize
suffix:semicolon
id|iadev-&gt;EXT_VC_TABLE_ADDR
op_assign
id|iadev-&gt;seg_ram
op_plus
id|EXT_VC_TABLE
op_star
id|iadev-&gt;memSize
suffix:semicolon
id|iadev-&gt;ABR_SCHED_TABLE_ADDR
op_assign
id|iadev-&gt;seg_ram
op_plus
id|ABR_SCHED_TABLE
op_star
id|iadev-&gt;memSize
suffix:semicolon
multiline_comment|/*  &n;&t;   Transmit side control memory map  &n;&t;   --------------------------------    &n;&t; Buffer descr &t;0x0000 (128 - 4K)  &n;&t; Commn queues&t;0x1000&t;Transmit comp, Packet ready(0x1400)   &n;&t;&t;&t;&t;&t;(512 - 1K) each  &n;&t;&t;&t;&t;&t;TCQ - 4K, PRQ - 5K  &n;&t; CBR Table &t;0x1800 (as needed) - 6K  &n;&t; UBR Table&t;0x3000 (1K - 4K) - 12K  &n;&t; UBR Wait queue&t;0x4000 (1K - 4K) - 16K  &n;&t; ABR sched&t;0x5000&t;and ABR wait queue (1K - 2K) each  &n;&t;&t;&t;&t;ABR Tbl - 20K, ABR Wq - 22K   &n;&t; extended VC&t;0x6000 (1K - 8K) - 24K  &n;&t; VC Table&t;0x8000 (1K - 32K) - 32K  &n;&t;  &n;&t;Between 0x2000 (8K) and 0x3000 (12K) there is 4K space left for VBR Tbl  &n;&t;and Wait q, which can be allotted later.  &n;&t;*/
multiline_comment|/* Buffer Descriptor Table Base address */
id|writew
c_func
(paren
id|TX_DESC_BASE
comma
id|iadev-&gt;seg_reg
op_plus
id|SEG_DESC_BASE
)paren
suffix:semicolon
multiline_comment|/* initialize each entry in the buffer descriptor table */
id|buf_desc_ptr
op_assign
(paren
r_struct
id|tx_buf_desc
op_star
)paren
(paren
id|iadev-&gt;seg_ram
op_plus
id|TX_DESC_BASE
)paren
suffix:semicolon
id|memset
c_func
(paren
(paren
id|caddr_t
)paren
id|buf_desc_ptr
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|tx_buf_desc
)paren
)paren
suffix:semicolon
id|buf_desc_ptr
op_increment
suffix:semicolon
id|tx_pkt_start
op_assign
id|TX_PACKET_RAM
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|1
suffix:semicolon
id|i
op_le
id|iadev-&gt;num_tx_desc
suffix:semicolon
id|i
op_increment
)paren
(brace
id|memset
c_func
(paren
(paren
id|caddr_t
)paren
id|buf_desc_ptr
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|tx_buf_desc
)paren
)paren
suffix:semicolon
id|buf_desc_ptr-&gt;desc_mode
op_assign
id|AAL5
suffix:semicolon
id|buf_desc_ptr-&gt;buf_start_hi
op_assign
id|tx_pkt_start
op_rshift
l_int|16
suffix:semicolon
id|buf_desc_ptr-&gt;buf_start_lo
op_assign
id|tx_pkt_start
op_amp
l_int|0x0000ffff
suffix:semicolon
id|buf_desc_ptr
op_increment
suffix:semicolon
id|tx_pkt_start
op_add_assign
id|iadev-&gt;tx_buf_sz
suffix:semicolon
)brace
id|iadev-&gt;tx_buf
op_assign
(paren
id|caddr_t
op_star
)paren
id|kmalloc
c_func
(paren
id|iadev-&gt;num_tx_desc
op_star
r_sizeof
(paren
id|caddr_t
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|iadev-&gt;tx_buf
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
id|DEV_LABEL
l_string|&quot; couldn&squot;t get mem&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EAGAIN
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|iadev-&gt;num_tx_desc
suffix:semicolon
id|i
op_increment
)paren
(brace
id|iadev-&gt;tx_buf
(braket
id|i
)braket
op_assign
(paren
id|caddr_t
)paren
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|cpcs_trailer
)paren
comma
id|GFP_KERNEL
op_or
id|GFP_DMA
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|iadev-&gt;tx_buf
(braket
id|i
)braket
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
id|DEV_LABEL
l_string|&quot; couldn&squot;t get freepage&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EAGAIN
suffix:semicolon
)brace
)brace
id|iadev-&gt;desc_tbl
op_assign
(paren
r_struct
id|desc_tbl_t
op_star
)paren
id|kmalloc
c_func
(paren
id|iadev-&gt;num_tx_desc
op_star
r_sizeof
(paren
r_struct
id|desc_tbl_t
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
multiline_comment|/* Communication Queues base address */
id|i
op_assign
id|TX_COMP_Q
op_star
id|iadev-&gt;memSize
suffix:semicolon
id|writew
c_func
(paren
id|i
op_rshift
l_int|16
comma
id|iadev-&gt;seg_reg
op_plus
id|SEG_QUEUE_BASE
)paren
suffix:semicolon
multiline_comment|/* Transmit Complete Queue */
id|writew
c_func
(paren
id|i
comma
id|iadev-&gt;seg_reg
op_plus
id|TCQ_ST_ADR
)paren
suffix:semicolon
id|writew
c_func
(paren
id|i
comma
id|iadev-&gt;seg_reg
op_plus
id|TCQ_RD_PTR
)paren
suffix:semicolon
id|writew
c_func
(paren
id|i
op_plus
id|iadev-&gt;num_tx_desc
op_star
r_sizeof
(paren
id|u_short
)paren
comma
id|iadev-&gt;seg_reg
op_plus
id|TCQ_WR_PTR
)paren
suffix:semicolon
id|iadev-&gt;host_tcq_wr
op_assign
id|i
op_plus
id|iadev-&gt;num_tx_desc
op_star
r_sizeof
(paren
id|u_short
)paren
suffix:semicolon
id|writew
c_func
(paren
id|i
op_plus
l_int|2
op_star
id|iadev-&gt;num_tx_desc
op_star
r_sizeof
(paren
id|u_short
)paren
comma
id|iadev-&gt;seg_reg
op_plus
id|TCQ_ED_ADR
)paren
suffix:semicolon
multiline_comment|/* Fill the TCQ with all the free descriptors. */
id|tcq_st_adr
op_assign
id|readw
c_func
(paren
id|iadev-&gt;seg_reg
op_plus
id|TCQ_ST_ADR
)paren
suffix:semicolon
id|tcq_start
op_assign
(paren
id|u_short
op_star
)paren
(paren
id|iadev-&gt;seg_ram
op_plus
id|tcq_st_adr
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|1
suffix:semicolon
id|i
op_le
id|iadev-&gt;num_tx_desc
suffix:semicolon
id|i
op_increment
)paren
(brace
op_star
id|tcq_start
op_assign
(paren
id|u_short
)paren
id|i
suffix:semicolon
id|tcq_start
op_increment
suffix:semicolon
)brace
multiline_comment|/* Packet Ready Queue */
id|i
op_assign
id|PKT_RDY_Q
op_star
id|iadev-&gt;memSize
suffix:semicolon
id|writew
c_func
(paren
id|i
comma
id|iadev-&gt;seg_reg
op_plus
id|PRQ_ST_ADR
)paren
suffix:semicolon
id|writew
c_func
(paren
id|i
op_plus
l_int|2
op_star
id|iadev-&gt;num_tx_desc
op_star
r_sizeof
(paren
id|u_short
)paren
comma
id|iadev-&gt;seg_reg
op_plus
id|PRQ_ED_ADR
)paren
suffix:semicolon
id|writew
c_func
(paren
id|i
comma
id|iadev-&gt;seg_reg
op_plus
id|PRQ_RD_PTR
)paren
suffix:semicolon
id|writew
c_func
(paren
id|i
comma
id|iadev-&gt;seg_reg
op_plus
id|PRQ_WR_PTR
)paren
suffix:semicolon
multiline_comment|/* Load local copy of PRQ and TCQ ptrs */
id|iadev-&gt;ffL.prq_st
op_assign
id|readw
c_func
(paren
id|iadev-&gt;seg_reg
op_plus
id|PRQ_ST_ADR
)paren
op_amp
l_int|0xffff
suffix:semicolon
id|iadev-&gt;ffL.prq_ed
op_assign
id|readw
c_func
(paren
id|iadev-&gt;seg_reg
op_plus
id|PRQ_ED_ADR
)paren
op_amp
l_int|0xffff
suffix:semicolon
id|iadev-&gt;ffL.prq_wr
op_assign
id|readw
c_func
(paren
id|iadev-&gt;seg_reg
op_plus
id|PRQ_WR_PTR
)paren
op_amp
l_int|0xffff
suffix:semicolon
id|iadev-&gt;ffL.tcq_st
op_assign
id|readw
c_func
(paren
id|iadev-&gt;seg_reg
op_plus
id|TCQ_ST_ADR
)paren
op_amp
l_int|0xffff
suffix:semicolon
id|iadev-&gt;ffL.tcq_ed
op_assign
id|readw
c_func
(paren
id|iadev-&gt;seg_reg
op_plus
id|TCQ_ED_ADR
)paren
op_amp
l_int|0xffff
suffix:semicolon
id|iadev-&gt;ffL.tcq_rd
op_assign
id|readw
c_func
(paren
id|iadev-&gt;seg_reg
op_plus
id|TCQ_RD_PTR
)paren
op_amp
l_int|0xffff
suffix:semicolon
multiline_comment|/* Just for safety initializing the queue to have desc 1 always */
multiline_comment|/* Fill the PRQ with all the free descriptors. */
id|prq_st_adr
op_assign
id|readw
c_func
(paren
id|iadev-&gt;seg_reg
op_plus
id|PRQ_ST_ADR
)paren
suffix:semicolon
id|prq_start
op_assign
(paren
id|u_short
op_star
)paren
(paren
id|iadev-&gt;seg_ram
op_plus
id|prq_st_adr
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|1
suffix:semicolon
id|i
op_le
id|iadev-&gt;num_tx_desc
suffix:semicolon
id|i
op_increment
)paren
(brace
op_star
id|prq_start
op_assign
(paren
id|u_short
)paren
l_int|0
suffix:semicolon
multiline_comment|/* desc 1 in all entries */
id|prq_start
op_increment
suffix:semicolon
)brace
multiline_comment|/* CBR Table */
id|IF_INIT
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;Start CBR Init&bslash;n&quot;
)paren
suffix:semicolon
)paren
macro_line|#if 1  /* for 1K VC board, CBR_PTR_BASE is 0 */
id|writew
c_func
(paren
l_int|0
comma
id|iadev-&gt;seg_reg
op_plus
id|CBR_PTR_BASE
)paren
suffix:semicolon
macro_line|#else /* Charlie&squot;s logic is wrong ? */
id|tmp16
op_assign
(paren
id|iadev-&gt;seg_ram
op_plus
id|CBR_SCHED_TABLE
op_star
id|iadev-&gt;memSize
)paren
op_rshift
l_int|17
suffix:semicolon
id|IF_INIT
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;cbr_ptr_base = 0x%x &quot;
comma
id|tmp16
)paren
suffix:semicolon
)paren
id|writew
c_func
(paren
id|tmp16
comma
id|iadev-&gt;seg_reg
op_plus
id|CBR_PTR_BASE
)paren
suffix:semicolon
macro_line|#endif
id|IF_INIT
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;value in register = 0x%x&bslash;n&quot;
comma
id|readw
c_func
(paren
id|iadev-&gt;seg_reg
op_plus
id|CBR_PTR_BASE
)paren
)paren
suffix:semicolon
)paren
id|tmp16
op_assign
(paren
id|CBR_SCHED_TABLE
op_star
id|iadev-&gt;memSize
)paren
op_rshift
l_int|1
suffix:semicolon
id|writew
c_func
(paren
id|tmp16
comma
id|iadev-&gt;seg_reg
op_plus
id|CBR_TAB_BEG
)paren
suffix:semicolon
id|IF_INIT
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;cbr_tab_beg = 0x%x in reg = 0x%x &bslash;n&quot;
comma
id|tmp16
comma
id|readw
c_func
(paren
id|iadev-&gt;seg_reg
op_plus
id|CBR_TAB_BEG
)paren
)paren
suffix:semicolon
)paren
id|writew
c_func
(paren
id|tmp16
comma
id|iadev-&gt;seg_reg
op_plus
id|CBR_TAB_END
op_plus
l_int|1
)paren
suffix:semicolon
singleline_comment|// CBR_PTR;
id|tmp16
op_assign
(paren
id|CBR_SCHED_TABLE
op_star
id|iadev-&gt;memSize
op_plus
id|iadev-&gt;num_vc
op_star
l_int|6
op_minus
l_int|2
)paren
op_rshift
l_int|1
suffix:semicolon
id|writew
c_func
(paren
id|tmp16
comma
id|iadev-&gt;seg_reg
op_plus
id|CBR_TAB_END
)paren
suffix:semicolon
id|IF_INIT
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;iadev-&gt;seg_reg = 0x%x CBR_PTR_BASE = 0x%x&bslash;n&quot;
comma
(paren
id|u32
)paren
id|iadev-&gt;seg_reg
comma
id|readw
c_func
(paren
id|iadev-&gt;seg_reg
op_plus
id|CBR_PTR_BASE
)paren
)paren
suffix:semicolon
)paren
id|IF_INIT
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;CBR_TAB_BEG = 0x%x, CBR_TAB_END = 0x%x, CBR_PTR = 0x%x&bslash;n&quot;
comma
id|readw
c_func
(paren
id|iadev-&gt;seg_reg
op_plus
id|CBR_TAB_BEG
)paren
comma
id|readw
c_func
(paren
id|iadev-&gt;seg_reg
op_plus
id|CBR_TAB_END
)paren
comma
id|readw
c_func
(paren
id|iadev-&gt;seg_reg
op_plus
id|CBR_TAB_END
op_plus
l_int|1
)paren
)paren
suffix:semicolon
)paren
id|tmp16
op_assign
(paren
id|iadev-&gt;seg_ram
op_plus
id|CBR_SCHED_TABLE
op_star
id|iadev-&gt;memSize
)paren
suffix:semicolon
multiline_comment|/* Initialize the CBR Schedualing Table */
id|memset
c_func
(paren
(paren
id|caddr_t
)paren
(paren
id|iadev-&gt;seg_ram
op_plus
id|CBR_SCHED_TABLE
op_star
id|iadev-&gt;memSize
)paren
comma
l_int|0
comma
id|iadev-&gt;num_vc
op_star
l_int|6
)paren
suffix:semicolon
id|iadev-&gt;CbrRemEntries
op_assign
id|iadev-&gt;CbrTotEntries
op_assign
id|iadev-&gt;num_vc
op_star
l_int|3
suffix:semicolon
id|iadev-&gt;CbrEntryPt
op_assign
l_int|0
suffix:semicolon
id|iadev-&gt;Granularity
op_assign
id|MAX_ATM_155
op_div
id|iadev-&gt;CbrTotEntries
suffix:semicolon
id|iadev-&gt;NumEnabledCBR
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* UBR scheduling Table and wait queue */
multiline_comment|/* initialize all bytes of UBR scheduler table and wait queue to 0   &n;&t;&t;- SCHEDSZ is 1K (# of entries).  &n;&t;&t;- UBR Table size is 4K  &n;&t;&t;- UBR wait queue is 4K  &n;&t;   since the table and wait queues are contiguous, all the bytes   &n;&t;   can be intialized by one memeset.  &n;&t;*/
id|vcsize_sel
op_assign
l_int|0
suffix:semicolon
id|i
op_assign
l_int|8
op_star
l_int|1024
suffix:semicolon
r_while
c_loop
(paren
id|i
op_ne
id|iadev-&gt;num_vc
)paren
(brace
id|i
op_div_assign
l_int|2
suffix:semicolon
id|vcsize_sel
op_increment
suffix:semicolon
)brace
id|i
op_assign
id|MAIN_VC_TABLE
op_star
id|iadev-&gt;memSize
suffix:semicolon
id|writew
c_func
(paren
id|vcsize_sel
op_or
(paren
(paren
id|i
op_rshift
l_int|8
)paren
op_amp
l_int|0xfff8
)paren
comma
id|iadev-&gt;seg_reg
op_plus
id|VCT_BASE
)paren
suffix:semicolon
id|i
op_assign
id|EXT_VC_TABLE
op_star
id|iadev-&gt;memSize
suffix:semicolon
id|writew
c_func
(paren
(paren
id|i
op_rshift
l_int|8
)paren
op_amp
l_int|0xfffe
comma
id|iadev-&gt;seg_reg
op_plus
id|VCTE_BASE
)paren
suffix:semicolon
id|i
op_assign
id|UBR_SCHED_TABLE
op_star
id|iadev-&gt;memSize
suffix:semicolon
id|writew
c_func
(paren
(paren
id|i
op_amp
l_int|0xffff
)paren
op_rshift
l_int|11
comma
id|iadev-&gt;seg_reg
op_plus
id|UBR_SBPTR_BASE
)paren
suffix:semicolon
id|i
op_assign
id|UBR_WAIT_Q
op_star
id|iadev-&gt;memSize
suffix:semicolon
id|writew
c_func
(paren
(paren
id|i
op_rshift
l_int|7
)paren
op_amp
l_int|0xffff
comma
id|iadev-&gt;seg_reg
op_plus
id|UBRWQ_BASE
)paren
suffix:semicolon
id|memset
c_func
(paren
(paren
id|caddr_t
)paren
(paren
id|iadev-&gt;seg_ram
op_plus
id|UBR_SCHED_TABLE
op_star
id|iadev-&gt;memSize
)paren
comma
l_int|0
comma
id|iadev-&gt;num_vc
op_star
l_int|8
)paren
suffix:semicolon
multiline_comment|/* ABR scheduling Table(0x5000-0x57ff) and wait queue(0x5800-0x5fff)*/
multiline_comment|/* initialize all bytes of ABR scheduler table and wait queue to 0   &n;&t;&t;- SCHEDSZ is 1K (# of entries).  &n;&t;&t;- ABR Table size is 2K  &n;&t;&t;- ABR wait queue is 2K  &n;&t;   since the table and wait queues are contiguous, all the bytes   &n;&t;   can be intialized by one memeset.  &n;&t;*/
id|i
op_assign
id|ABR_SCHED_TABLE
op_star
id|iadev-&gt;memSize
suffix:semicolon
id|writew
c_func
(paren
(paren
id|i
op_rshift
l_int|11
)paren
op_amp
l_int|0xffff
comma
id|iadev-&gt;seg_reg
op_plus
id|ABR_SBPTR_BASE
)paren
suffix:semicolon
id|i
op_assign
id|ABR_WAIT_Q
op_star
id|iadev-&gt;memSize
suffix:semicolon
id|writew
c_func
(paren
(paren
id|i
op_rshift
l_int|7
)paren
op_amp
l_int|0xffff
comma
id|iadev-&gt;seg_reg
op_plus
id|ABRWQ_BASE
)paren
suffix:semicolon
id|i
op_assign
id|ABR_SCHED_TABLE
op_star
id|iadev-&gt;memSize
suffix:semicolon
id|memset
c_func
(paren
(paren
id|caddr_t
)paren
(paren
id|iadev-&gt;seg_ram
op_plus
id|i
)paren
comma
l_int|0
comma
id|iadev-&gt;num_vc
op_star
l_int|4
)paren
suffix:semicolon
id|vc
op_assign
(paren
r_struct
id|main_vc
op_star
)paren
id|iadev-&gt;MAIN_VC_TABLE_ADDR
suffix:semicolon
id|evc
op_assign
(paren
r_struct
id|ext_vc
op_star
)paren
id|iadev-&gt;EXT_VC_TABLE_ADDR
suffix:semicolon
id|iadev-&gt;testTable
op_assign
(paren
r_struct
id|testTable_t
op_star
op_star
)paren
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_int
)paren
op_star
id|iadev-&gt;num_vc
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|iadev-&gt;testTable
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;Get freepage  failed&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EAGAIN
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|iadev-&gt;num_vc
suffix:semicolon
id|i
op_increment
)paren
(brace
id|memset
c_func
(paren
(paren
id|caddr_t
)paren
id|vc
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|main_vc
)paren
)paren
suffix:semicolon
id|memset
c_func
(paren
(paren
id|caddr_t
)paren
id|evc
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|ext_vc
)paren
)paren
suffix:semicolon
id|iadev-&gt;testTable
(braket
id|i
)braket
op_assign
(paren
r_struct
id|testTable_t
op_star
)paren
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|testTable_t
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
id|iadev-&gt;testTable
(braket
id|i
)braket
op_member_access_from_pointer
id|lastTime
op_assign
l_int|0
suffix:semicolon
id|iadev-&gt;testTable
(braket
id|i
)braket
op_member_access_from_pointer
id|fract
op_assign
l_int|0
suffix:semicolon
id|iadev-&gt;testTable
(braket
id|i
)braket
op_member_access_from_pointer
id|vc_status
op_assign
id|VC_UBR
suffix:semicolon
id|vc
op_increment
suffix:semicolon
id|evc
op_increment
suffix:semicolon
)brace
multiline_comment|/* Other Initialization */
multiline_comment|/* Max Rate Register */
r_if
c_cond
(paren
id|iadev-&gt;phy_type
op_amp
id|FE_25MBIT_PHY
)paren
(brace
id|writew
c_func
(paren
id|RATE25
comma
id|iadev-&gt;seg_reg
op_plus
id|MAXRATE
)paren
suffix:semicolon
id|writew
c_func
(paren
(paren
id|UBR_EN
op_or
(paren
l_int|0x23
op_lshift
l_int|2
)paren
)paren
comma
id|iadev-&gt;seg_reg
op_plus
id|STPARMS
)paren
suffix:semicolon
)brace
r_else
(brace
id|writew
c_func
(paren
id|cellrate_to_float
c_func
(paren
id|iadev-&gt;LineRate
)paren
comma
id|iadev-&gt;seg_reg
op_plus
id|MAXRATE
)paren
suffix:semicolon
id|writew
c_func
(paren
(paren
id|UBR_EN
op_or
id|ABR_EN
op_or
(paren
l_int|0x23
op_lshift
l_int|2
)paren
)paren
comma
id|iadev-&gt;seg_reg
op_plus
id|STPARMS
)paren
suffix:semicolon
)brace
multiline_comment|/* Set Idle Header Reigisters to be sure */
id|writew
c_func
(paren
l_int|0
comma
id|iadev-&gt;seg_reg
op_plus
id|IDLEHEADHI
)paren
suffix:semicolon
id|writew
c_func
(paren
l_int|0
comma
id|iadev-&gt;seg_reg
op_plus
id|IDLEHEADLO
)paren
suffix:semicolon
multiline_comment|/* Program ABR UBR Priority Register  as  PRI_ABR_UBR_EQUAL */
id|writew
c_func
(paren
l_int|0xaa00
comma
id|iadev-&gt;seg_reg
op_plus
id|ABRUBR_ARB
)paren
suffix:semicolon
id|iadev-&gt;close_pending
op_assign
l_int|0
suffix:semicolon
macro_line|#if LINUX_VERSION_CODE &gt;= 0x20303
id|init_waitqueue_head
c_func
(paren
op_amp
id|iadev-&gt;close_wait
)paren
suffix:semicolon
id|init_waitqueue_head
c_func
(paren
op_amp
id|iadev-&gt;timeout_wait
)paren
suffix:semicolon
macro_line|#else
id|iadev-&gt;close_wait
op_assign
l_int|NULL
suffix:semicolon
id|iadev-&gt;timeout_wait
op_assign
l_int|NULL
suffix:semicolon
macro_line|#endif 
id|skb_queue_head_init
c_func
(paren
op_amp
id|iadev-&gt;tx_dma_q
)paren
suffix:semicolon
id|ia_init_rtn_q
c_func
(paren
op_amp
id|iadev-&gt;tx_return_q
)paren
suffix:semicolon
multiline_comment|/* RM Cell Protocol ID and Message Type */
id|writew
c_func
(paren
id|RM_TYPE_4_0
comma
id|iadev-&gt;seg_reg
op_plus
id|RM_TYPE
)paren
suffix:semicolon
id|skb_queue_head_init
(paren
op_amp
id|iadev-&gt;tx_backlog
)paren
suffix:semicolon
multiline_comment|/* Mode Register 1 */
id|writew
c_func
(paren
id|MODE_REG_1_VAL
comma
id|iadev-&gt;seg_reg
op_plus
id|MODE_REG_1
)paren
suffix:semicolon
multiline_comment|/* Mode Register 0 */
id|writew
c_func
(paren
id|T_ONLINE
comma
id|iadev-&gt;seg_reg
op_plus
id|MODE_REG_0
)paren
suffix:semicolon
multiline_comment|/* Interrupt Status Register - read to clear */
id|readw
c_func
(paren
id|iadev-&gt;seg_reg
op_plus
id|SEG_INTR_STATUS_REG
)paren
suffix:semicolon
multiline_comment|/* Interrupt Mask Reg- don&squot;t mask TCQ_NOT_EMPTY interrupt generation */
id|writew
c_func
(paren
op_complement
(paren
id|TRANSMIT_DONE
op_or
id|TCQ_NOT_EMPTY
)paren
comma
id|iadev-&gt;seg_reg
op_plus
id|SEG_MASK_REG
)paren
suffix:semicolon
id|writew
c_func
(paren
id|TRANSMIT_DONE
comma
id|iadev-&gt;seg_reg
op_plus
id|SEG_INTR_STATUS_REG
)paren
suffix:semicolon
id|iadev-&gt;tx_pkt_cnt
op_assign
l_int|0
suffix:semicolon
id|iadev-&gt;rate_limit
op_assign
id|iadev-&gt;LineRate
op_div
l_int|3
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|ia_int
r_static
r_void
id|ia_int
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_struct
id|atm_dev
op_star
id|dev
suffix:semicolon
id|IADEV
op_star
id|iadev
suffix:semicolon
r_int
r_int
id|status
suffix:semicolon
id|dev
op_assign
id|dev_id
suffix:semicolon
id|iadev
op_assign
id|INPH_IA_DEV
c_func
(paren
id|dev
)paren
suffix:semicolon
r_while
c_loop
(paren
(paren
id|status
op_assign
id|readl
c_func
(paren
id|iadev-&gt;reg
op_plus
id|IPHASE5575_BUS_STATUS_REG
)paren
op_amp
l_int|0x7f
)paren
)paren
(brace
id|IF_EVENT
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;ia_int: status = 0x%x&bslash;n&quot;
comma
id|status
)paren
suffix:semicolon
)paren
r_if
c_cond
(paren
id|status
op_amp
id|STAT_REASSINT
)paren
(brace
multiline_comment|/* do something */
id|IF_EVENT
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;REASSINT Bus status reg: %08x&bslash;n&quot;
comma
id|status
)paren
suffix:semicolon
)paren
id|rx_intr
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|status
op_amp
id|STAT_DLERINT
)paren
(brace
multiline_comment|/* Clear this bit by writing a 1 to it. */
op_star
(paren
id|u_int
op_star
)paren
(paren
id|iadev-&gt;reg
op_plus
id|IPHASE5575_BUS_STATUS_REG
)paren
op_assign
id|STAT_DLERINT
suffix:semicolon
id|rx_dle_intr
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|status
op_amp
id|STAT_SEGINT
)paren
(brace
multiline_comment|/* do something */
id|IF_EVENT
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;IA: tx_intr &bslash;n&quot;
)paren
suffix:semicolon
)paren
id|tx_intr
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|status
op_amp
id|STAT_DLETINT
)paren
(brace
op_star
(paren
id|u_int
op_star
)paren
(paren
id|iadev-&gt;reg
op_plus
id|IPHASE5575_BUS_STATUS_REG
)paren
op_assign
id|STAT_DLETINT
suffix:semicolon
id|tx_dle_intr
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|status
op_amp
(paren
id|STAT_FEINT
op_or
id|STAT_ERRINT
op_or
id|STAT_MARKINT
)paren
)paren
(brace
r_if
c_cond
(paren
id|status
op_amp
id|STAT_FEINT
)paren
id|IaFrontEndIntr
c_func
(paren
id|iadev
)paren
suffix:semicolon
)brace
)brace
)brace
multiline_comment|/*----------------------------- entries --------------------------------*/
DECL|function|get_esi
r_static
r_int
id|get_esi
c_func
(paren
r_struct
id|atm_dev
op_star
id|dev
)paren
(brace
id|IADEV
op_star
id|iadev
suffix:semicolon
r_int
id|i
suffix:semicolon
id|u32
id|mac1
suffix:semicolon
id|u16
id|mac2
suffix:semicolon
id|iadev
op_assign
id|INPH_IA_DEV
c_func
(paren
id|dev
)paren
suffix:semicolon
id|mac1
op_assign
id|cpu_to_be32
c_func
(paren
id|le32_to_cpu
c_func
(paren
id|readl
c_func
(paren
id|iadev-&gt;reg
op_plus
id|IPHASE5575_MAC1
)paren
)paren
)paren
suffix:semicolon
id|mac2
op_assign
id|cpu_to_be16
c_func
(paren
id|le16_to_cpu
c_func
(paren
id|readl
c_func
(paren
id|iadev-&gt;reg
op_plus
id|IPHASE5575_MAC2
)paren
)paren
)paren
suffix:semicolon
id|IF_INIT
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;ESI: 0x%08x%04x&bslash;n&quot;
comma
id|mac1
comma
id|mac2
)paren
suffix:semicolon
)paren
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|MAC1_LEN
suffix:semicolon
id|i
op_increment
)paren
id|dev-&gt;esi
(braket
id|i
)braket
op_assign
id|mac1
op_rshift
(paren
l_int|8
op_star
(paren
id|MAC1_LEN
op_minus
l_int|1
op_minus
id|i
)paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|MAC2_LEN
suffix:semicolon
id|i
op_increment
)paren
id|dev-&gt;esi
(braket
id|i
op_plus
id|MAC1_LEN
)braket
op_assign
id|mac2
op_rshift
(paren
l_int|8
op_star
(paren
id|MAC2_LEN
op_minus
l_int|1
op_minus
id|i
)paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|reset_sar
r_static
r_int
id|reset_sar
c_func
(paren
r_struct
id|atm_dev
op_star
id|dev
)paren
(brace
id|IADEV
op_star
id|iadev
suffix:semicolon
r_int
id|i
comma
id|error
op_assign
l_int|1
suffix:semicolon
r_int
r_int
id|pci
(braket
l_int|64
)braket
suffix:semicolon
id|iadev
op_assign
id|INPH_IA_DEV
c_func
(paren
id|dev
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|64
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
(paren
id|error
op_assign
id|pci_read_config_dword
c_func
(paren
id|iadev-&gt;pci
comma
id|i
op_star
l_int|4
comma
op_amp
id|pci
(braket
id|i
)braket
)paren
)paren
op_ne
id|PCIBIOS_SUCCESSFUL
)paren
r_return
id|error
suffix:semicolon
id|writel
c_func
(paren
l_int|0
comma
id|iadev-&gt;reg
op_plus
id|IPHASE5575_EXT_RESET
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|64
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
(paren
id|error
op_assign
id|pci_write_config_dword
c_func
(paren
id|iadev-&gt;pci
comma
id|i
op_star
l_int|4
comma
id|pci
(braket
id|i
)braket
)paren
)paren
op_ne
id|PCIBIOS_SUCCESSFUL
)paren
r_return
id|error
suffix:semicolon
id|udelay
c_func
(paren
l_int|5
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#if LINUX_VERSION_CODE &gt;= 0x20312
DECL|function|ia_init
r_static
r_int
id|__init
id|ia_init
c_func
(paren
r_struct
id|atm_dev
op_star
id|dev
)paren
macro_line|#else
id|__initfunc
c_func
(paren
r_static
r_int
id|ia_init
c_func
(paren
r_struct
id|atm_dev
op_star
id|dev
)paren
)paren
macro_line|#endif  
(brace
id|IADEV
op_star
id|iadev
suffix:semicolon
r_int
r_int
id|real_base
comma
id|base
suffix:semicolon
r_int
r_int
id|command
suffix:semicolon
r_int
r_char
id|revision
suffix:semicolon
r_int
id|error
comma
id|i
suffix:semicolon
multiline_comment|/* The device has been identified and registered. Now we read   &n;&t;   necessary configuration info like memory base address,   &n;&t;   interrupt number etc */
id|IF_INIT
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;&gt;ia_init&bslash;n&quot;
)paren
suffix:semicolon
)paren
id|dev-&gt;ci_range.vpi_bits
op_assign
l_int|0
suffix:semicolon
id|dev-&gt;ci_range.vci_bits
op_assign
id|NR_VCI_LD
suffix:semicolon
id|iadev
op_assign
id|INPH_IA_DEV
c_func
(paren
id|dev
)paren
suffix:semicolon
id|real_base
op_assign
id|pci_resource_start
(paren
id|iadev-&gt;pci
comma
l_int|0
)paren
suffix:semicolon
id|iadev-&gt;irq
op_assign
id|iadev-&gt;pci-&gt;irq
suffix:semicolon
r_if
c_cond
(paren
(paren
id|error
op_assign
id|pci_read_config_word
c_func
(paren
id|iadev-&gt;pci
comma
id|PCI_COMMAND
comma
op_amp
id|command
)paren
)paren
op_logical_or
(paren
id|error
op_assign
id|pci_read_config_byte
c_func
(paren
id|iadev-&gt;pci
comma
id|PCI_REVISION_ID
comma
op_amp
id|revision
)paren
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
id|DEV_LABEL
l_string|&quot;(itf %d): init error 0x%x&bslash;n&quot;
comma
id|dev-&gt;number
comma
id|error
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|IF_INIT
c_func
(paren
id|printk
c_func
(paren
id|DEV_LABEL
l_string|&quot;(itf %d): rev.%d,realbase=0x%lx,irq=%d&bslash;n&quot;
comma
id|dev-&gt;number
comma
id|revision
comma
id|real_base
comma
id|iadev-&gt;irq
)paren
suffix:semicolon
)paren
multiline_comment|/* find mapping size of board */
id|iadev-&gt;pci_map_size
op_assign
id|pci_resource_len
c_func
(paren
id|iadev-&gt;pci
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|iadev-&gt;pci_map_size
op_eq
l_int|0x100000
)paren
(brace
id|iadev-&gt;num_vc
op_assign
l_int|4096
suffix:semicolon
id|dev-&gt;ci_range.vci_bits
op_assign
id|NR_VCI_4K_LD
suffix:semicolon
id|iadev-&gt;memSize
op_assign
l_int|4
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|iadev-&gt;pci_map_size
op_eq
l_int|0x40000
)paren
(brace
id|iadev-&gt;num_vc
op_assign
l_int|1024
suffix:semicolon
id|iadev-&gt;memSize
op_assign
l_int|1
suffix:semicolon
)brace
r_else
(brace
id|printk
c_func
(paren
l_string|&quot;Unknown pci_map_size = 0x%x&bslash;n&quot;
comma
id|iadev-&gt;pci_map_size
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|IF_INIT
c_func
(paren
id|printk
(paren
id|DEV_LABEL
l_string|&quot;map size: %i&bslash;n&quot;
comma
id|iadev-&gt;pci_map_size
)paren
suffix:semicolon
)paren
multiline_comment|/* enable bus mastering */
id|pci_set_master
c_func
(paren
id|iadev-&gt;pci
)paren
suffix:semicolon
multiline_comment|/*  &n;&t; * Delay at least 1us before doing any mem accesses (how &squot;bout 10?)  &n;&t; */
id|udelay
c_func
(paren
l_int|10
)paren
suffix:semicolon
multiline_comment|/* mapping the physical address to a virtual address in address space */
id|base
op_assign
(paren
r_int
r_int
)paren
id|ioremap
c_func
(paren
(paren
r_int
r_int
)paren
id|real_base
comma
id|iadev-&gt;pci_map_size
)paren
suffix:semicolon
multiline_comment|/* ioremap is not resolved ??? */
r_if
c_cond
(paren
op_logical_neg
id|base
)paren
(brace
id|printk
c_func
(paren
id|DEV_LABEL
l_string|&quot; (itf %d): can&squot;t set up page mapping&bslash;n&quot;
comma
id|dev-&gt;number
)paren
suffix:semicolon
r_return
id|error
suffix:semicolon
)brace
id|IF_INIT
c_func
(paren
id|printk
c_func
(paren
id|DEV_LABEL
l_string|&quot; (itf %d): rev.%d,base=0x%lx,irq=%d&bslash;n&quot;
comma
id|dev-&gt;number
comma
id|revision
comma
id|base
comma
id|iadev-&gt;irq
)paren
suffix:semicolon
)paren
multiline_comment|/* filling the iphase dev structure */
id|iadev-&gt;mem
op_assign
id|iadev-&gt;pci_map_size
op_div
l_int|2
suffix:semicolon
id|iadev-&gt;base_diff
op_assign
id|real_base
op_minus
id|base
suffix:semicolon
id|iadev-&gt;real_base
op_assign
id|real_base
suffix:semicolon
id|iadev-&gt;base
op_assign
id|base
suffix:semicolon
multiline_comment|/* Bus Interface Control Registers */
id|iadev-&gt;reg
op_assign
(paren
id|u32
op_star
)paren
(paren
id|base
op_plus
id|REG_BASE
)paren
suffix:semicolon
multiline_comment|/* Segmentation Control Registers */
id|iadev-&gt;seg_reg
op_assign
(paren
id|u32
op_star
)paren
(paren
id|base
op_plus
id|SEG_BASE
)paren
suffix:semicolon
multiline_comment|/* Reassembly Control Registers */
id|iadev-&gt;reass_reg
op_assign
(paren
id|u32
op_star
)paren
(paren
id|base
op_plus
id|REASS_BASE
)paren
suffix:semicolon
multiline_comment|/* Front end/ DMA control registers */
id|iadev-&gt;phy
op_assign
(paren
id|u32
op_star
)paren
(paren
id|base
op_plus
id|PHY_BASE
)paren
suffix:semicolon
id|iadev-&gt;dma
op_assign
(paren
id|u32
op_star
)paren
(paren
id|base
op_plus
id|PHY_BASE
)paren
suffix:semicolon
multiline_comment|/* RAM - Segmentation RAm and Reassembly RAM */
id|iadev-&gt;ram
op_assign
(paren
id|u32
op_star
)paren
(paren
id|base
op_plus
id|ACTUAL_RAM_BASE
)paren
suffix:semicolon
id|iadev-&gt;seg_ram
op_assign
(paren
id|base
op_plus
id|ACTUAL_SEG_RAM_BASE
)paren
suffix:semicolon
id|iadev-&gt;reass_ram
op_assign
(paren
id|base
op_plus
id|ACTUAL_REASS_RAM_BASE
)paren
suffix:semicolon
multiline_comment|/* lets print out the above */
id|IF_INIT
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;Base addrs: %08x %08x %08x &bslash;n %08x %08x %08x %08x&bslash;n&quot;
comma
(paren
id|u32
)paren
id|iadev-&gt;reg
comma
(paren
id|u32
)paren
id|iadev-&gt;seg_reg
comma
(paren
id|u32
)paren
id|iadev-&gt;reass_reg
comma
(paren
id|u32
)paren
id|iadev-&gt;phy
comma
(paren
id|u32
)paren
id|iadev-&gt;ram
comma
(paren
id|u32
)paren
id|iadev-&gt;seg_ram
comma
(paren
id|u32
)paren
id|iadev-&gt;reass_ram
)paren
suffix:semicolon
)paren
multiline_comment|/* lets try reading the MAC address */
id|error
op_assign
id|get_esi
c_func
(paren
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
)paren
r_return
id|error
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;IA: &quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|ESI_LEN
suffix:semicolon
id|i
op_increment
)paren
id|printk
c_func
(paren
l_string|&quot;%s%02X&quot;
comma
id|i
ques
c_cond
l_string|&quot;-&quot;
suffix:colon
l_string|&quot;&quot;
comma
id|dev-&gt;esi
(braket
id|i
)braket
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* reset SAR */
r_if
c_cond
(paren
id|reset_sar
c_func
(paren
id|dev
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;IA: reset SAR fail, please try again&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|ia_update_stats
r_static
r_void
id|ia_update_stats
c_func
(paren
id|IADEV
op_star
id|iadev
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|iadev-&gt;carrier_detect
)paren
r_return
suffix:semicolon
id|iadev-&gt;rx_cell_cnt
op_add_assign
id|readw
c_func
(paren
id|iadev-&gt;reass_reg
op_plus
id|CELL_CTR0
)paren
op_amp
l_int|0xffff
suffix:semicolon
id|iadev-&gt;rx_cell_cnt
op_add_assign
(paren
id|readw
c_func
(paren
id|iadev-&gt;reass_reg
op_plus
id|CELL_CTR1
)paren
op_amp
l_int|0xffff
)paren
op_lshift
l_int|16
suffix:semicolon
id|iadev-&gt;drop_rxpkt
op_add_assign
id|readw
c_func
(paren
id|iadev-&gt;reass_reg
op_plus
id|DRP_PKT_CNTR
)paren
op_amp
l_int|0xffff
suffix:semicolon
id|iadev-&gt;drop_rxcell
op_add_assign
id|readw
c_func
(paren
id|iadev-&gt;reass_reg
op_plus
id|ERR_CNTR
)paren
op_amp
l_int|0xffff
suffix:semicolon
id|iadev-&gt;tx_cell_cnt
op_add_assign
id|readw
c_func
(paren
id|iadev-&gt;seg_reg
op_plus
id|CELL_CTR_LO_AUTO
)paren
op_amp
l_int|0xffff
suffix:semicolon
id|iadev-&gt;tx_cell_cnt
op_add_assign
(paren
id|readw
c_func
(paren
id|iadev-&gt;seg_reg
op_plus
id|CELL_CTR_HIGH_AUTO
)paren
op_amp
l_int|0xffff
)paren
op_lshift
l_int|16
suffix:semicolon
r_return
suffix:semicolon
)brace
DECL|function|ia_led_timer
r_static
r_void
id|ia_led_timer
c_func
(paren
r_int
r_int
id|arg
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
r_static
id|u_char
id|blinking
(braket
l_int|8
)braket
op_assign
(brace
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
)brace
suffix:semicolon
id|u_char
id|i
suffix:semicolon
r_static
id|u32
id|ctrl_reg
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|iadev_count
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|ia_dev
(braket
id|i
)braket
)paren
(brace
id|ctrl_reg
op_assign
id|readl
c_func
(paren
id|ia_dev
(braket
id|i
)braket
op_member_access_from_pointer
id|reg
op_plus
id|IPHASE5575_BUS_CONTROL_REG
)paren
suffix:semicolon
r_if
c_cond
(paren
id|blinking
(braket
id|i
)braket
op_eq
l_int|0
)paren
(brace
id|blinking
(braket
id|i
)braket
op_increment
suffix:semicolon
id|ctrl_reg
op_and_assign
(paren
op_complement
id|CTRL_LED
)paren
suffix:semicolon
id|writel
c_func
(paren
id|ctrl_reg
comma
id|ia_dev
(braket
id|i
)braket
op_member_access_from_pointer
id|reg
op_plus
id|IPHASE5575_BUS_CONTROL_REG
)paren
suffix:semicolon
id|ia_update_stats
c_func
(paren
id|ia_dev
(braket
id|i
)braket
)paren
suffix:semicolon
)brace
r_else
(brace
id|blinking
(braket
id|i
)braket
op_assign
l_int|0
suffix:semicolon
id|ctrl_reg
op_or_assign
id|CTRL_LED
suffix:semicolon
id|writel
c_func
(paren
id|ctrl_reg
comma
id|ia_dev
(braket
id|i
)braket
op_member_access_from_pointer
id|reg
op_plus
id|IPHASE5575_BUS_CONTROL_REG
)paren
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|ia_dev
(braket
id|i
)braket
op_member_access_from_pointer
id|tx_lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ia_dev
(braket
id|i
)braket
op_member_access_from_pointer
id|close_pending
)paren
id|wake_up
c_func
(paren
op_amp
id|ia_dev
(braket
id|i
)braket
op_member_access_from_pointer
id|close_wait
)paren
suffix:semicolon
id|ia_tx_poll
c_func
(paren
id|ia_dev
(braket
id|i
)braket
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|ia_dev
(braket
id|i
)braket
op_member_access_from_pointer
id|tx_lock
comma
id|flags
)paren
suffix:semicolon
)brace
)brace
)brace
id|mod_timer
c_func
(paren
op_amp
id|ia_timer
comma
id|jiffies
op_plus
id|HZ
op_div
l_int|4
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
DECL|function|ia_phy_put
r_static
r_void
id|ia_phy_put
c_func
(paren
r_struct
id|atm_dev
op_star
id|dev
comma
r_int
r_char
id|value
comma
r_int
r_int
id|addr
)paren
(brace
id|writel
c_func
(paren
id|value
comma
id|INPH_IA_DEV
c_func
(paren
id|dev
)paren
op_member_access_from_pointer
id|phy
op_plus
id|addr
)paren
suffix:semicolon
)brace
DECL|function|ia_phy_get
r_static
r_int
r_char
id|ia_phy_get
c_func
(paren
r_struct
id|atm_dev
op_star
id|dev
comma
r_int
r_int
id|addr
)paren
(brace
r_return
id|readl
c_func
(paren
id|INPH_IA_DEV
c_func
(paren
id|dev
)paren
op_member_access_from_pointer
id|phy
op_plus
id|addr
)paren
suffix:semicolon
)brace
macro_line|#if LINUX_VERSION_CODE &gt;= 0x20312
DECL|function|ia_start
r_static
r_int
id|__init
id|ia_start
c_func
(paren
r_struct
id|atm_dev
op_star
id|dev
)paren
macro_line|#else
id|__initfunc
c_func
(paren
r_static
r_int
id|ia_start
c_func
(paren
r_struct
id|atm_dev
op_star
id|dev
)paren
)paren
macro_line|#endif  
(brace
id|IADEV
op_star
id|iadev
suffix:semicolon
r_int
id|error
op_assign
l_int|1
suffix:semicolon
r_int
r_char
id|phy
suffix:semicolon
id|u32
id|ctrl_reg
suffix:semicolon
id|IF_EVENT
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;&gt;ia_start&bslash;n&quot;
)paren
suffix:semicolon
)paren
id|iadev
op_assign
id|INPH_IA_DEV
c_func
(paren
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|request_irq
c_func
(paren
id|iadev-&gt;irq
comma
op_amp
id|ia_int
comma
id|SA_SHIRQ
comma
id|DEV_LABEL
comma
id|dev
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
id|DEV_LABEL
l_string|&quot;(itf %d): IRQ%d is already in use&bslash;n&quot;
comma
id|dev-&gt;number
comma
id|iadev-&gt;irq
)paren
suffix:semicolon
r_return
op_minus
id|EAGAIN
suffix:semicolon
)brace
multiline_comment|/* @@@ should release IRQ on error */
multiline_comment|/* enabling memory + master */
r_if
c_cond
(paren
(paren
id|error
op_assign
id|pci_write_config_word
c_func
(paren
id|iadev-&gt;pci
comma
id|PCI_COMMAND
comma
id|PCI_COMMAND_MEMORY
op_or
id|PCI_COMMAND_MASTER
)paren
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
id|DEV_LABEL
l_string|&quot;(itf %d): can&squot;t enable memory+&quot;
l_string|&quot;master (0x%x)&bslash;n&quot;
comma
id|dev-&gt;number
comma
id|error
)paren
suffix:semicolon
id|free_irq
c_func
(paren
id|iadev-&gt;irq
comma
id|dev
)paren
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
id|udelay
c_func
(paren
l_int|10
)paren
suffix:semicolon
multiline_comment|/* Maybe we should reset the front end, initialize Bus Interface Control   &n;&t;&t;Registers and see. */
id|IF_INIT
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;Bus ctrl reg: %08x&bslash;n&quot;
comma
id|readl
c_func
(paren
id|iadev-&gt;reg
op_plus
id|IPHASE5575_BUS_CONTROL_REG
)paren
)paren
suffix:semicolon
)paren
id|ctrl_reg
op_assign
id|readl
c_func
(paren
id|iadev-&gt;reg
op_plus
id|IPHASE5575_BUS_CONTROL_REG
)paren
suffix:semicolon
id|ctrl_reg
op_assign
(paren
id|ctrl_reg
op_amp
(paren
id|CTRL_LED
op_or
id|CTRL_FE_RST
)paren
)paren
op_or
id|CTRL_B8
op_or
id|CTRL_B16
op_or
id|CTRL_B32
op_or
id|CTRL_B48
op_or
id|CTRL_B64
op_or
id|CTRL_B128
op_or
id|CTRL_ERRMASK
op_or
id|CTRL_DLETMASK
multiline_comment|/* shud be removed l8r */
op_or
id|CTRL_DLERMASK
op_or
id|CTRL_SEGMASK
op_or
id|CTRL_REASSMASK
op_or
id|CTRL_FEMASK
op_or
id|CTRL_CSPREEMPT
suffix:semicolon
id|writel
c_func
(paren
id|ctrl_reg
comma
id|iadev-&gt;reg
op_plus
id|IPHASE5575_BUS_CONTROL_REG
)paren
suffix:semicolon
id|IF_INIT
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;Bus ctrl reg after initializing: %08x&bslash;n&quot;
comma
id|readl
c_func
(paren
id|iadev-&gt;reg
op_plus
id|IPHASE5575_BUS_CONTROL_REG
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;Bus status reg after init: %08x&bslash;n&quot;
comma
id|readl
c_func
(paren
id|iadev-&gt;reg
op_plus
id|IPHASE5575_BUS_STATUS_REG
)paren
)paren
suffix:semicolon
)paren
id|ia_hw_type
c_func
(paren
id|iadev
)paren
suffix:semicolon
id|error
op_assign
id|tx_init
c_func
(paren
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
)paren
(brace
id|free_irq
c_func
(paren
id|iadev-&gt;irq
comma
id|dev
)paren
suffix:semicolon
r_return
id|error
suffix:semicolon
)brace
id|error
op_assign
id|rx_init
c_func
(paren
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
)paren
(brace
id|free_irq
c_func
(paren
id|iadev-&gt;irq
comma
id|dev
)paren
suffix:semicolon
r_return
id|error
suffix:semicolon
)brace
id|ctrl_reg
op_assign
id|readl
c_func
(paren
id|iadev-&gt;reg
op_plus
id|IPHASE5575_BUS_CONTROL_REG
)paren
suffix:semicolon
id|writel
c_func
(paren
id|ctrl_reg
op_or
id|CTRL_FE_RST
comma
id|iadev-&gt;reg
op_plus
id|IPHASE5575_BUS_CONTROL_REG
)paren
suffix:semicolon
id|IF_INIT
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;Bus ctrl reg after initializing: %08x&bslash;n&quot;
comma
id|readl
c_func
(paren
id|iadev-&gt;reg
op_plus
id|IPHASE5575_BUS_CONTROL_REG
)paren
)paren
suffix:semicolon
)paren
id|phy
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* resolve compiler complaint */
id|IF_INIT
(paren
r_if
(paren
(paren
id|phy
op_assign
id|ia_phy_get
c_func
(paren
id|dev
comma
l_int|0
)paren
)paren
op_eq
l_int|0x30
)paren
id|printk
c_func
(paren
l_string|&quot;IA: pm5346,rev.%d&bslash;n&quot;
comma
id|phy
op_amp
l_int|0x0f
)paren
suffix:semicolon
r_else
id|printk
c_func
(paren
l_string|&quot;IA: utopia,rev.%0x&bslash;n&quot;
comma
id|phy
)paren
suffix:semicolon
)paren
r_if
c_cond
(paren
id|iadev-&gt;phy_type
op_amp
id|FE_25MBIT_PHY
)paren
(brace
id|ia_mb25_init
c_func
(paren
id|iadev
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|iadev-&gt;phy_type
op_amp
(paren
id|FE_DS3_PHY
op_or
id|FE_E3_PHY
)paren
)paren
(brace
id|ia_suni_pm7345_init
c_func
(paren
id|iadev
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|error
op_assign
id|suni_init
c_func
(paren
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
)paren
(brace
id|free_irq
c_func
(paren
id|iadev-&gt;irq
comma
id|dev
)paren
suffix:semicolon
r_return
id|error
suffix:semicolon
)brace
multiline_comment|/* Enable interrupt on loss of signal SUNI_RSOP_CIE 0x10&n;           SUNI_RSOP_CIE_LOSE - 0x04&n;        */
id|ia_phy_put
c_func
(paren
id|dev
comma
id|ia_phy_get
c_func
(paren
id|dev
comma
l_int|0x10
)paren
op_or
l_int|0x04
comma
l_int|0x10
)paren
suffix:semicolon
macro_line|#ifndef MODULE
id|error
op_assign
id|dev-&gt;phy
op_member_access_from_pointer
id|start
c_func
(paren
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
)paren
(brace
id|free_irq
c_func
(paren
id|iadev-&gt;irq
comma
id|dev
)paren
suffix:semicolon
r_return
id|error
suffix:semicolon
)brace
macro_line|#endif
multiline_comment|/* Get iadev-&gt;carrier_detect status */
id|IaFrontEndIntr
c_func
(paren
id|iadev
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|ia_close
r_static
r_void
id|ia_close
c_func
(paren
r_struct
id|atm_vcc
op_star
id|vcc
)paren
(brace
id|u16
op_star
id|vc_table
suffix:semicolon
id|IADEV
op_star
id|iadev
suffix:semicolon
r_struct
id|ia_vcc
op_star
id|ia_vcc
suffix:semicolon
r_struct
id|sk_buff
op_star
id|skb
op_assign
l_int|NULL
suffix:semicolon
r_struct
id|sk_buff_head
id|tmp_tx_backlog
comma
id|tmp_vcc_backlog
suffix:semicolon
r_int
r_int
id|closetime
comma
id|flags
suffix:semicolon
r_int
id|ctimeout
suffix:semicolon
id|iadev
op_assign
id|INPH_IA_DEV
c_func
(paren
id|vcc-&gt;dev
)paren
suffix:semicolon
id|ia_vcc
op_assign
id|INPH_IA_VCC
c_func
(paren
id|vcc
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ia_vcc
)paren
r_return
suffix:semicolon
id|IF_EVENT
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;ia_close: ia_vcc-&gt;vc_desc_cnt = %d  vci = %d&bslash;n&quot;
comma
id|ia_vcc-&gt;vc_desc_cnt
comma
id|vcc-&gt;vci
)paren
suffix:semicolon
)paren
id|clear_bit
c_func
(paren
id|ATM_VF_READY
comma
op_amp
id|vcc-&gt;flags
)paren
suffix:semicolon
id|skb_queue_head_init
(paren
op_amp
id|tmp_tx_backlog
)paren
suffix:semicolon
id|skb_queue_head_init
(paren
op_amp
id|tmp_vcc_backlog
)paren
suffix:semicolon
r_if
c_cond
(paren
id|vcc-&gt;qos.txtp.traffic_class
op_ne
id|ATM_NONE
)paren
(brace
id|iadev-&gt;close_pending
op_increment
suffix:semicolon
id|sleep_on_timeout
c_func
(paren
op_amp
id|iadev-&gt;timeout_wait
comma
l_int|50
)paren
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|iadev-&gt;tx_lock
comma
id|flags
)paren
suffix:semicolon
r_while
c_loop
(paren
(paren
id|skb
op_assign
id|skb_dequeue
c_func
(paren
op_amp
id|iadev-&gt;tx_backlog
)paren
)paren
)paren
(brace
r_if
c_cond
(paren
id|ATM_SKB
c_func
(paren
id|skb
)paren
op_member_access_from_pointer
id|vcc
op_eq
id|vcc
)paren
(brace
r_if
c_cond
(paren
id|vcc-&gt;pop
)paren
id|vcc
op_member_access_from_pointer
id|pop
c_func
(paren
id|vcc
comma
id|skb
)paren
suffix:semicolon
r_else
id|dev_kfree_skb_any
c_func
(paren
id|skb
)paren
suffix:semicolon
)brace
r_else
id|skb_queue_tail
c_func
(paren
op_amp
id|tmp_tx_backlog
comma
id|skb
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
(paren
id|skb
op_assign
id|skb_dequeue
c_func
(paren
op_amp
id|tmp_tx_backlog
)paren
)paren
)paren
(brace
id|skb_queue_tail
c_func
(paren
op_amp
id|iadev-&gt;tx_backlog
comma
id|skb
)paren
suffix:semicolon
)brace
id|IF_EVENT
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;IA TX Done decs_cnt = %d&bslash;n&quot;
comma
id|ia_vcc-&gt;vc_desc_cnt
)paren
suffix:semicolon
)paren
id|closetime
op_assign
id|jiffies
suffix:semicolon
id|ctimeout
op_assign
l_int|300000
op_div
id|ia_vcc-&gt;pcr
suffix:semicolon
r_if
c_cond
(paren
id|ctimeout
op_eq
l_int|0
)paren
id|ctimeout
op_assign
l_int|1
suffix:semicolon
r_while
c_loop
(paren
id|ia_vcc-&gt;vc_desc_cnt
OG
l_int|0
)paren
(brace
r_if
c_cond
(paren
(paren
id|jiffies
op_minus
id|closetime
)paren
op_ge
id|ctimeout
)paren
r_break
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|iadev-&gt;tx_lock
comma
id|flags
)paren
suffix:semicolon
id|sleep_on
c_func
(paren
op_amp
id|iadev-&gt;close_wait
)paren
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|iadev-&gt;tx_lock
comma
id|flags
)paren
suffix:semicolon
)brace
id|iadev-&gt;close_pending
op_decrement
suffix:semicolon
id|iadev-&gt;testTable
(braket
id|vcc-&gt;vci
)braket
op_member_access_from_pointer
id|lastTime
op_assign
l_int|0
suffix:semicolon
id|iadev-&gt;testTable
(braket
id|vcc-&gt;vci
)braket
op_member_access_from_pointer
id|fract
op_assign
l_int|0
suffix:semicolon
id|iadev-&gt;testTable
(braket
id|vcc-&gt;vci
)braket
op_member_access_from_pointer
id|vc_status
op_assign
id|VC_UBR
suffix:semicolon
r_if
c_cond
(paren
id|vcc-&gt;qos.txtp.traffic_class
op_eq
id|ATM_ABR
)paren
(brace
r_if
c_cond
(paren
id|vcc-&gt;qos.txtp.min_pcr
OG
l_int|0
)paren
id|iadev-&gt;sum_mcr
op_sub_assign
id|vcc-&gt;qos.txtp.min_pcr
suffix:semicolon
)brace
r_if
c_cond
(paren
id|vcc-&gt;qos.txtp.traffic_class
op_eq
id|ATM_CBR
)paren
(brace
id|ia_vcc
op_assign
id|INPH_IA_VCC
c_func
(paren
id|vcc
)paren
suffix:semicolon
id|iadev-&gt;sum_mcr
op_sub_assign
id|ia_vcc-&gt;NumCbrEntry
op_star
id|iadev-&gt;Granularity
suffix:semicolon
id|ia_cbrVc_close
(paren
id|vcc
)paren
suffix:semicolon
)brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|iadev-&gt;tx_lock
comma
id|flags
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|vcc-&gt;qos.rxtp.traffic_class
op_ne
id|ATM_NONE
)paren
(brace
singleline_comment|// reset reass table
id|vc_table
op_assign
(paren
id|u16
op_star
)paren
(paren
id|iadev-&gt;reass_ram
op_plus
id|REASS_TABLE
op_star
id|iadev-&gt;memSize
)paren
suffix:semicolon
id|vc_table
op_add_assign
id|vcc-&gt;vci
suffix:semicolon
op_star
id|vc_table
op_assign
id|NO_AAL5_PKT
suffix:semicolon
singleline_comment|// reset vc table
id|vc_table
op_assign
(paren
id|u16
op_star
)paren
(paren
id|iadev-&gt;reass_ram
op_plus
id|RX_VC_TABLE
op_star
id|iadev-&gt;memSize
)paren
suffix:semicolon
id|vc_table
op_add_assign
id|vcc-&gt;vci
suffix:semicolon
op_star
id|vc_table
op_assign
(paren
id|vcc-&gt;vci
op_lshift
l_int|6
)paren
op_or
l_int|15
suffix:semicolon
r_if
c_cond
(paren
id|vcc-&gt;qos.rxtp.traffic_class
op_eq
id|ATM_ABR
)paren
(brace
r_struct
id|abr_vc_table
op_star
id|abr_vc_table
op_assign
(paren
r_struct
id|abr_vc_table
op_star
)paren
(paren
id|iadev-&gt;reass_ram
op_plus
id|ABR_VC_TABLE
op_star
id|iadev-&gt;memSize
)paren
suffix:semicolon
id|abr_vc_table
op_add_assign
id|vcc-&gt;vci
suffix:semicolon
id|abr_vc_table-&gt;rdf
op_assign
l_int|0x0003
suffix:semicolon
id|abr_vc_table-&gt;air
op_assign
l_int|0x5eb1
suffix:semicolon
)brace
singleline_comment|// Drain the packets
id|rx_dle_intr
c_func
(paren
id|vcc-&gt;dev
)paren
suffix:semicolon
id|iadev-&gt;rx_open
(braket
id|vcc-&gt;vci
)braket
op_assign
l_int|0
suffix:semicolon
)brace
id|kfree
c_func
(paren
id|INPH_IA_VCC
c_func
(paren
id|vcc
)paren
)paren
suffix:semicolon
id|ia_vcc
op_assign
l_int|NULL
suffix:semicolon
id|INPH_IA_VCC
c_func
(paren
id|vcc
)paren
op_assign
l_int|NULL
suffix:semicolon
id|clear_bit
c_func
(paren
id|ATM_VF_ADDR
comma
op_amp
id|vcc-&gt;flags
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
DECL|function|ia_open
r_static
r_int
id|ia_open
c_func
(paren
r_struct
id|atm_vcc
op_star
id|vcc
comma
r_int
id|vpi
comma
r_int
id|vci
)paren
(brace
id|IADEV
op_star
id|iadev
suffix:semicolon
r_struct
id|ia_vcc
op_star
id|ia_vcc
suffix:semicolon
r_int
id|error
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|test_bit
c_func
(paren
id|ATM_VF_PARTIAL
comma
op_amp
id|vcc-&gt;flags
)paren
)paren
(brace
id|IF_EVENT
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;ia: not partially allocated resources&bslash;n&quot;
)paren
suffix:semicolon
)paren
id|INPH_IA_VCC
c_func
(paren
id|vcc
)paren
op_assign
l_int|NULL
suffix:semicolon
)brace
id|iadev
op_assign
id|INPH_IA_DEV
c_func
(paren
id|vcc-&gt;dev
)paren
suffix:semicolon
id|error
op_assign
id|atm_find_ci
c_func
(paren
id|vcc
comma
op_amp
id|vpi
comma
op_amp
id|vci
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;iadev: atm_find_ci returned error %d&bslash;n&quot;
comma
id|error
)paren
suffix:semicolon
r_return
id|error
suffix:semicolon
)brace
id|vcc-&gt;vpi
op_assign
id|vpi
suffix:semicolon
id|vcc-&gt;vci
op_assign
id|vci
suffix:semicolon
r_if
c_cond
(paren
id|vci
op_ne
id|ATM_VPI_UNSPEC
op_logical_and
id|vpi
op_ne
id|ATM_VCI_UNSPEC
)paren
(brace
id|IF_EVENT
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;iphase open: unspec part&bslash;n&quot;
)paren
suffix:semicolon
)paren
id|set_bit
c_func
(paren
id|ATM_VF_ADDR
comma
op_amp
id|vcc-&gt;flags
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|vcc-&gt;qos.aal
op_ne
id|ATM_AAL5
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|IF_EVENT
c_func
(paren
id|printk
c_func
(paren
id|DEV_LABEL
l_string|&quot;(itf %d): open %d.%d&bslash;n&quot;
comma
id|vcc-&gt;dev-&gt;number
comma
id|vcc-&gt;vpi
comma
id|vcc-&gt;vci
)paren
suffix:semicolon
)paren
multiline_comment|/* Device dependent initialization */
id|ia_vcc
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|ia_vcc
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ia_vcc
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|INPH_IA_VCC
c_func
(paren
id|vcc
)paren
op_assign
id|ia_vcc
suffix:semicolon
r_if
c_cond
(paren
(paren
id|error
op_assign
id|open_rx
c_func
(paren
id|vcc
)paren
)paren
)paren
(brace
id|IF_EVENT
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;iadev: error in open_rx, closing&bslash;n&quot;
)paren
suffix:semicolon
)paren
id|ia_close
c_func
(paren
id|vcc
)paren
suffix:semicolon
r_return
id|error
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|error
op_assign
id|open_tx
c_func
(paren
id|vcc
)paren
)paren
)paren
(brace
id|IF_EVENT
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;iadev: error in open_tx, closing&bslash;n&quot;
)paren
suffix:semicolon
)paren
id|ia_close
c_func
(paren
id|vcc
)paren
suffix:semicolon
r_return
id|error
suffix:semicolon
)brace
id|set_bit
c_func
(paren
id|ATM_VF_READY
comma
op_amp
id|vcc-&gt;flags
)paren
suffix:semicolon
macro_line|#ifndef MODULE
(brace
r_static
id|u8
id|first
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|first
)paren
(brace
id|ia_timer.expires
op_assign
id|jiffies
op_plus
l_int|3
op_star
id|HZ
suffix:semicolon
id|add_timer
c_func
(paren
op_amp
id|ia_timer
)paren
suffix:semicolon
id|first
op_assign
l_int|0
suffix:semicolon
)brace
)brace
macro_line|#endif
id|IF_EVENT
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;ia open returning&bslash;n&quot;
)paren
suffix:semicolon
)paren
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|ia_change_qos
r_static
r_int
id|ia_change_qos
c_func
(paren
r_struct
id|atm_vcc
op_star
id|vcc
comma
r_struct
id|atm_qos
op_star
id|qos
comma
r_int
id|flags
)paren
(brace
id|IF_EVENT
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;&gt;ia_change_qos&bslash;n&quot;
)paren
suffix:semicolon
)paren
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|ia_ioctl
r_static
r_int
id|ia_ioctl
c_func
(paren
r_struct
id|atm_dev
op_star
id|dev
comma
r_int
r_int
id|cmd
comma
r_void
op_star
id|arg
)paren
(brace
id|IA_CMDBUF
id|ia_cmds
suffix:semicolon
id|IADEV
op_star
id|iadev
suffix:semicolon
r_int
id|i
comma
id|board
suffix:semicolon
id|u16
op_star
id|tmps
suffix:semicolon
id|IF_EVENT
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;&gt;ia_ioctl&bslash;n&quot;
)paren
suffix:semicolon
)paren
r_if
c_cond
(paren
id|cmd
op_ne
id|IA_CMD
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|dev-&gt;phy-&gt;ioctl
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_return
id|dev-&gt;phy
op_member_access_from_pointer
id|ioctl
c_func
(paren
id|dev
comma
id|cmd
comma
id|arg
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|ia_cmds
comma
id|arg
comma
r_sizeof
id|ia_cmds
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
id|board
op_assign
id|ia_cmds.status
suffix:semicolon
r_if
c_cond
(paren
(paren
id|board
OL
l_int|0
)paren
op_logical_or
(paren
id|board
OG
id|iadev_count
)paren
)paren
id|board
op_assign
l_int|0
suffix:semicolon
id|iadev
op_assign
id|ia_dev
(braket
id|board
)braket
suffix:semicolon
r_switch
c_cond
(paren
id|ia_cmds.cmd
)paren
(brace
r_case
id|MEMDUMP
suffix:colon
(brace
r_switch
c_cond
(paren
id|ia_cmds.sub_cmd
)paren
(brace
r_case
id|MEMDUMP_DEV
suffix:colon
r_if
c_cond
(paren
op_logical_neg
id|capable
c_func
(paren
id|CAP_NET_ADMIN
)paren
)paren
r_return
op_minus
id|EPERM
suffix:semicolon
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
id|ia_cmds.buf
comma
id|iadev
comma
r_sizeof
(paren
id|IADEV
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
id|ia_cmds.status
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MEMDUMP_SEGREG
suffix:colon
r_if
c_cond
(paren
op_logical_neg
id|capable
c_func
(paren
id|CAP_NET_ADMIN
)paren
)paren
r_return
op_minus
id|EPERM
suffix:semicolon
id|tmps
op_assign
(paren
id|u16
op_star
)paren
id|ia_cmds.buf
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|0x80
suffix:semicolon
id|i
op_add_assign
l_int|2
comma
id|tmps
op_increment
)paren
r_if
c_cond
(paren
id|put_user
c_func
(paren
op_star
(paren
id|u16
op_star
)paren
(paren
id|iadev-&gt;seg_reg
op_plus
id|i
)paren
comma
id|tmps
)paren
)paren
(brace
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
id|ia_cmds.status
op_assign
l_int|0
suffix:semicolon
id|ia_cmds.len
op_assign
l_int|0x80
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MEMDUMP_REASSREG
suffix:colon
r_if
c_cond
(paren
op_logical_neg
id|capable
c_func
(paren
id|CAP_NET_ADMIN
)paren
)paren
r_return
op_minus
id|EPERM
suffix:semicolon
id|tmps
op_assign
(paren
id|u16
op_star
)paren
id|ia_cmds.buf
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|0x80
suffix:semicolon
id|i
op_add_assign
l_int|2
comma
id|tmps
op_increment
)paren
r_if
c_cond
(paren
id|put_user
c_func
(paren
op_star
(paren
id|u16
op_star
)paren
(paren
id|iadev-&gt;reass_reg
op_plus
id|i
)paren
comma
id|tmps
)paren
)paren
(brace
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
id|ia_cmds.status
op_assign
l_int|0
suffix:semicolon
id|ia_cmds.len
op_assign
l_int|0x80
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MEMDUMP_FFL
suffix:colon
(brace
id|ia_regs_t
id|regs_local
suffix:semicolon
id|ffredn_t
op_star
id|ffL
op_assign
op_amp
id|regs_local.ffredn
suffix:semicolon
id|rfredn_t
op_star
id|rfL
op_assign
op_amp
id|regs_local.rfredn
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|capable
c_func
(paren
id|CAP_NET_ADMIN
)paren
)paren
r_return
op_minus
id|EPERM
suffix:semicolon
multiline_comment|/* Copy real rfred registers into the local copy */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
(paren
r_sizeof
(paren
id|rfredn_t
)paren
)paren
op_div
l_int|4
suffix:semicolon
id|i
op_increment
)paren
(paren
(paren
id|u_int
op_star
)paren
id|rfL
)paren
(braket
id|i
)braket
op_assign
(paren
(paren
id|u_int
op_star
)paren
id|iadev-&gt;reass_reg
)paren
(braket
id|i
)braket
op_amp
l_int|0xffff
suffix:semicolon
multiline_comment|/* Copy real ffred registers into the local copy */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
(paren
r_sizeof
(paren
id|ffredn_t
)paren
)paren
op_div
l_int|4
suffix:semicolon
id|i
op_increment
)paren
(paren
(paren
id|u_int
op_star
)paren
id|ffL
)paren
(braket
id|i
)braket
op_assign
(paren
(paren
id|u_int
op_star
)paren
id|iadev-&gt;seg_reg
)paren
(braket
id|i
)braket
op_amp
l_int|0xffff
suffix:semicolon
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
id|ia_cmds.buf
comma
op_amp
id|regs_local
comma
r_sizeof
(paren
id|ia_regs_t
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;Board %d registers dumped&bslash;n&quot;
comma
id|board
)paren
suffix:semicolon
id|ia_cmds.status
op_assign
l_int|0
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|READ_REG
suffix:colon
(brace
r_if
c_cond
(paren
op_logical_neg
id|capable
c_func
(paren
id|CAP_NET_ADMIN
)paren
)paren
r_return
op_minus
id|EPERM
suffix:semicolon
id|desc_dbg
c_func
(paren
id|iadev
)paren
suffix:semicolon
id|ia_cmds.status
op_assign
l_int|0
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
l_int|0x6
suffix:colon
(brace
id|ia_cmds.status
op_assign
l_int|0
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;skb = 0x%lx&bslash;n&quot;
comma
(paren
r_int
)paren
id|skb_peek
c_func
(paren
op_amp
id|iadev-&gt;tx_backlog
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;rtn_q: 0x%lx&bslash;n&quot;
comma
(paren
r_int
)paren
id|ia_deque_rtn_q
c_func
(paren
op_amp
id|iadev-&gt;tx_return_q
)paren
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
l_int|0x8
suffix:colon
(brace
r_struct
id|k_sonet_stats
op_star
id|stats
suffix:semicolon
id|stats
op_assign
op_amp
id|PRIV
c_func
(paren
id|_ia_dev
(braket
id|board
)braket
)paren
op_member_access_from_pointer
id|sonet_stats
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;section_bip: %d&bslash;n&quot;
comma
id|atomic_read
c_func
(paren
op_amp
id|stats-&gt;section_bip
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;line_bip   : %d&bslash;n&quot;
comma
id|atomic_read
c_func
(paren
op_amp
id|stats-&gt;line_bip
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;path_bip   : %d&bslash;n&quot;
comma
id|atomic_read
c_func
(paren
op_amp
id|stats-&gt;path_bip
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;line_febe  : %d&bslash;n&quot;
comma
id|atomic_read
c_func
(paren
op_amp
id|stats-&gt;line_febe
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;path_febe  : %d&bslash;n&quot;
comma
id|atomic_read
c_func
(paren
op_amp
id|stats-&gt;path_febe
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;corr_hcs   : %d&bslash;n&quot;
comma
id|atomic_read
c_func
(paren
op_amp
id|stats-&gt;corr_hcs
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;uncorr_hcs : %d&bslash;n&quot;
comma
id|atomic_read
c_func
(paren
op_amp
id|stats-&gt;uncorr_hcs
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;tx_cells   : %d&bslash;n&quot;
comma
id|atomic_read
c_func
(paren
op_amp
id|stats-&gt;tx_cells
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;rx_cells   : %d&bslash;n&quot;
comma
id|atomic_read
c_func
(paren
op_amp
id|stats-&gt;rx_cells
)paren
)paren
suffix:semicolon
)brace
id|ia_cmds.status
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x9
suffix:colon
r_if
c_cond
(paren
op_logical_neg
id|capable
c_func
(paren
id|CAP_NET_ADMIN
)paren
)paren
r_return
op_minus
id|EPERM
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|1
suffix:semicolon
id|i
op_le
id|iadev-&gt;num_rx_desc
suffix:semicolon
id|i
op_increment
)paren
id|free_desc
c_func
(paren
id|_ia_dev
(braket
id|board
)braket
comma
id|i
)paren
suffix:semicolon
id|writew
c_func
(paren
op_complement
(paren
id|RX_FREEQ_EMPT
op_or
id|RX_EXCP_RCVD
)paren
comma
id|iadev-&gt;reass_reg
op_plus
id|REASS_MASK_REG
)paren
suffix:semicolon
id|iadev-&gt;rxing
op_assign
l_int|1
suffix:semicolon
id|ia_cmds.status
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0xb
suffix:colon
r_if
c_cond
(paren
op_logical_neg
id|capable
c_func
(paren
id|CAP_NET_ADMIN
)paren
)paren
r_return
op_minus
id|EPERM
suffix:semicolon
id|IaFrontEndIntr
c_func
(paren
id|iadev
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0xa
suffix:colon
r_if
c_cond
(paren
op_logical_neg
id|capable
c_func
(paren
id|CAP_NET_ADMIN
)paren
)paren
r_return
op_minus
id|EPERM
suffix:semicolon
(brace
id|ia_cmds.status
op_assign
l_int|0
suffix:semicolon
id|IADebugFlag
op_assign
id|ia_cmds.maddr
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;New debug option loaded&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_default
suffix:colon
id|ia_cmds.status
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
r_break
suffix:semicolon
r_default
suffix:colon
r_break
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|ia_getsockopt
r_static
r_int
id|ia_getsockopt
c_func
(paren
r_struct
id|atm_vcc
op_star
id|vcc
comma
r_int
id|level
comma
r_int
id|optname
comma
r_void
op_star
id|optval
comma
r_int
id|optlen
)paren
(brace
id|IF_EVENT
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;&gt;ia_getsockopt&bslash;n&quot;
)paren
suffix:semicolon
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
DECL|function|ia_setsockopt
r_static
r_int
id|ia_setsockopt
c_func
(paren
r_struct
id|atm_vcc
op_star
id|vcc
comma
r_int
id|level
comma
r_int
id|optname
comma
r_void
op_star
id|optval
comma
r_int
id|optlen
)paren
(brace
id|IF_EVENT
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;&gt;ia_setsockopt&bslash;n&quot;
)paren
suffix:semicolon
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
DECL|function|ia_pkt_tx
r_static
r_int
id|ia_pkt_tx
(paren
r_struct
id|atm_vcc
op_star
id|vcc
comma
r_struct
id|sk_buff
op_star
id|skb
)paren
(brace
id|IADEV
op_star
id|iadev
suffix:semicolon
r_struct
id|dle
op_star
id|wr_ptr
suffix:semicolon
r_struct
id|tx_buf_desc
op_star
id|buf_desc_ptr
suffix:semicolon
r_int
id|desc
suffix:semicolon
r_int
id|comp_code
suffix:semicolon
r_int
r_int
id|addr
suffix:semicolon
r_int
id|total_len
comma
id|pad
comma
id|last
suffix:semicolon
r_struct
id|cpcs_trailer
op_star
id|trailer
suffix:semicolon
r_struct
id|ia_vcc
op_star
id|iavcc
suffix:semicolon
id|iadev
op_assign
id|INPH_IA_DEV
c_func
(paren
id|vcc-&gt;dev
)paren
suffix:semicolon
id|iavcc
op_assign
id|INPH_IA_VCC
c_func
(paren
id|vcc
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|iavcc-&gt;txing
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;discard packet on closed VC&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|vcc-&gt;pop
)paren
id|vcc
op_member_access_from_pointer
id|pop
c_func
(paren
id|vcc
comma
id|skb
)paren
suffix:semicolon
r_else
id|dev_kfree_skb_any
c_func
(paren
id|skb
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|skb-&gt;len
OG
id|iadev-&gt;tx_buf_sz
op_minus
l_int|8
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;Transmit size over tx buffer size&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|vcc-&gt;pop
)paren
id|vcc
op_member_access_from_pointer
id|pop
c_func
(paren
id|vcc
comma
id|skb
)paren
suffix:semicolon
r_else
id|dev_kfree_skb_any
c_func
(paren
id|skb
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|u32
)paren
id|skb-&gt;data
op_amp
l_int|3
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;Misaligned SKB&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|vcc-&gt;pop
)paren
id|vcc
op_member_access_from_pointer
id|pop
c_func
(paren
id|vcc
comma
id|skb
)paren
suffix:semicolon
r_else
id|dev_kfree_skb_any
c_func
(paren
id|skb
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Get a descriptor number from our free descriptor queue  &n;&t;   We get the descr number from the TCQ now, since I am using  &n;&t;   the TCQ as a free buffer queue. Initially TCQ will be   &n;&t;   initialized with all the descriptors and is hence, full.  &n;&t;*/
id|desc
op_assign
id|get_desc
(paren
id|iadev
comma
id|iavcc
)paren
suffix:semicolon
r_if
c_cond
(paren
id|desc
op_eq
l_int|0xffff
)paren
r_return
l_int|1
suffix:semicolon
id|comp_code
op_assign
id|desc
op_rshift
l_int|13
suffix:semicolon
id|desc
op_and_assign
l_int|0x1fff
suffix:semicolon
r_if
c_cond
(paren
(paren
id|desc
op_eq
l_int|0
)paren
op_logical_or
(paren
id|desc
OG
id|iadev-&gt;num_tx_desc
)paren
)paren
(brace
id|IF_ERR
c_func
(paren
id|printk
c_func
(paren
id|DEV_LABEL
l_string|&quot;invalid desc for send: %d&bslash;n&quot;
comma
id|desc
)paren
suffix:semicolon
)paren
id|atomic_inc
c_func
(paren
op_amp
id|vcc-&gt;stats-&gt;tx
)paren
suffix:semicolon
r_if
c_cond
(paren
id|vcc-&gt;pop
)paren
id|vcc
op_member_access_from_pointer
id|pop
c_func
(paren
id|vcc
comma
id|skb
)paren
suffix:semicolon
r_else
id|dev_kfree_skb_any
c_func
(paren
id|skb
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
multiline_comment|/* return SUCCESS */
)brace
r_if
c_cond
(paren
id|comp_code
)paren
(brace
id|IF_ERR
c_func
(paren
id|printk
c_func
(paren
id|DEV_LABEL
l_string|&quot;send desc:%d completion code %d error&bslash;n&quot;
comma
id|desc
comma
id|comp_code
)paren
suffix:semicolon
)paren
)brace
multiline_comment|/* remember the desc and vcc mapping */
id|iavcc-&gt;vc_desc_cnt
op_increment
suffix:semicolon
id|iadev-&gt;desc_tbl
(braket
id|desc
op_minus
l_int|1
)braket
dot
id|iavcc
op_assign
id|iavcc
suffix:semicolon
id|iadev-&gt;desc_tbl
(braket
id|desc
op_minus
l_int|1
)braket
dot
id|txskb
op_assign
id|skb
suffix:semicolon
id|IA_SKB_STATE
c_func
(paren
id|skb
)paren
op_assign
l_int|0
suffix:semicolon
id|iadev-&gt;ffL.tcq_rd
op_add_assign
l_int|2
suffix:semicolon
r_if
c_cond
(paren
id|iadev-&gt;ffL.tcq_rd
OG
id|iadev-&gt;ffL.tcq_ed
)paren
id|iadev-&gt;ffL.tcq_rd
op_assign
id|iadev-&gt;ffL.tcq_st
suffix:semicolon
id|writew
c_func
(paren
id|iadev-&gt;ffL.tcq_rd
comma
id|iadev-&gt;seg_reg
op_plus
id|TCQ_RD_PTR
)paren
suffix:semicolon
multiline_comment|/* Put the descriptor number in the packet ready queue  &n;&t;&t;and put the updated write pointer in the DLE field   &n;&t;*/
op_star
(paren
id|u16
op_star
)paren
(paren
id|iadev-&gt;seg_ram
op_plus
id|iadev-&gt;ffL.prq_wr
)paren
op_assign
id|desc
suffix:semicolon
id|iadev-&gt;ffL.prq_wr
op_add_assign
l_int|2
suffix:semicolon
r_if
c_cond
(paren
id|iadev-&gt;ffL.prq_wr
OG
id|iadev-&gt;ffL.prq_ed
)paren
id|iadev-&gt;ffL.prq_wr
op_assign
id|iadev-&gt;ffL.prq_st
suffix:semicolon
multiline_comment|/* Figure out the exact length of the packet and padding required to &n;           make it  aligned on a 48 byte boundary.  */
id|total_len
op_assign
id|skb-&gt;len
op_plus
r_sizeof
(paren
r_struct
id|cpcs_trailer
)paren
suffix:semicolon
id|last
op_assign
id|total_len
op_minus
(paren
id|total_len
op_div
l_int|48
)paren
op_star
l_int|48
suffix:semicolon
id|pad
op_assign
l_int|48
op_minus
id|last
suffix:semicolon
id|total_len
op_assign
id|pad
op_plus
id|total_len
suffix:semicolon
id|IF_TX
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;ia packet len:%d padding:%d&bslash;n&quot;
comma
id|total_len
comma
id|pad
)paren
suffix:semicolon
)paren
multiline_comment|/* Put the packet in a tx buffer */
r_if
c_cond
(paren
op_logical_neg
id|iadev-&gt;tx_buf
(braket
id|desc
op_minus
l_int|1
)braket
)paren
id|printk
c_func
(paren
l_string|&quot;couldn&squot;t get free page&bslash;n&quot;
)paren
suffix:semicolon
id|IF_TX
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;Sent: skb = 0x%x skb-&gt;data: 0x%x len: %d, desc: %d&bslash;n&quot;
comma
(paren
id|u32
)paren
id|skb
comma
(paren
id|u32
)paren
id|skb-&gt;data
comma
id|skb-&gt;len
comma
id|desc
)paren
suffix:semicolon
)paren
id|addr
op_assign
id|virt_to_bus
c_func
(paren
id|skb-&gt;data
)paren
suffix:semicolon
id|trailer
op_assign
(paren
r_struct
id|cpcs_trailer
op_star
)paren
id|iadev-&gt;tx_buf
(braket
id|desc
op_minus
l_int|1
)braket
suffix:semicolon
id|trailer-&gt;control
op_assign
l_int|0
suffix:semicolon
multiline_comment|/*big endian*/
id|trailer-&gt;length
op_assign
(paren
(paren
id|skb-&gt;len
op_amp
l_int|0xff
)paren
op_lshift
l_int|8
)paren
op_or
(paren
(paren
id|skb-&gt;len
op_amp
l_int|0xff00
)paren
op_rshift
l_int|8
)paren
suffix:semicolon
id|trailer-&gt;crc32
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* not needed - dummy bytes */
multiline_comment|/* Display the packet */
id|IF_TXPKT
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;Sent data: len = %d MsgNum = %d&bslash;n&quot;
comma
id|skb-&gt;len
comma
id|tcnter
op_increment
)paren
suffix:semicolon
id|xdump
c_func
(paren
id|skb-&gt;data
comma
id|skb-&gt;len
comma
l_string|&quot;TX: &quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
)paren
multiline_comment|/* Build the buffer descriptor */
id|buf_desc_ptr
op_assign
(paren
r_struct
id|tx_buf_desc
op_star
)paren
(paren
id|iadev-&gt;seg_ram
op_plus
id|TX_DESC_BASE
)paren
suffix:semicolon
id|buf_desc_ptr
op_add_assign
id|desc
suffix:semicolon
multiline_comment|/* points to the corresponding entry */
id|buf_desc_ptr-&gt;desc_mode
op_assign
id|AAL5
op_or
id|EOM_EN
op_or
id|APP_CRC32
op_or
id|CMPL_INT
suffix:semicolon
id|writew
c_func
(paren
id|TRANSMIT_DONE
comma
id|iadev-&gt;seg_reg
op_plus
id|SEG_INTR_STATUS_REG
)paren
suffix:semicolon
id|buf_desc_ptr-&gt;vc_index
op_assign
id|vcc-&gt;vci
suffix:semicolon
id|buf_desc_ptr-&gt;bytes
op_assign
id|total_len
suffix:semicolon
r_if
c_cond
(paren
id|vcc-&gt;qos.txtp.traffic_class
op_eq
id|ATM_ABR
)paren
id|clear_lockup
(paren
id|vcc
comma
id|iadev
)paren
suffix:semicolon
multiline_comment|/* Build the DLE structure */
id|wr_ptr
op_assign
id|iadev-&gt;tx_dle_q.write
suffix:semicolon
id|memset
c_func
(paren
(paren
id|caddr_t
)paren
id|wr_ptr
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|dle
)paren
)paren
suffix:semicolon
id|wr_ptr-&gt;sys_pkt_addr
op_assign
id|addr
suffix:semicolon
id|wr_ptr-&gt;local_pkt_addr
op_assign
(paren
id|buf_desc_ptr-&gt;buf_start_hi
op_lshift
l_int|16
)paren
op_or
id|buf_desc_ptr-&gt;buf_start_lo
suffix:semicolon
multiline_comment|/* wr_ptr-&gt;bytes = swap(total_len);&t;didn&squot;t seem to affect ?? */
id|wr_ptr-&gt;bytes
op_assign
id|skb-&gt;len
suffix:semicolon
multiline_comment|/* hw bug - DLEs of 0x2d, 0x2e, 0x2f cause DMA lockup */
r_if
c_cond
(paren
(paren
id|wr_ptr-&gt;bytes
op_rshift
l_int|2
)paren
op_eq
l_int|0xb
)paren
id|wr_ptr-&gt;bytes
op_assign
l_int|0x30
suffix:semicolon
id|wr_ptr-&gt;mode
op_assign
id|TX_DLE_PSI
suffix:semicolon
id|wr_ptr-&gt;prq_wr_ptr_data
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* end is not to be used for the DLE q */
r_if
c_cond
(paren
op_increment
id|wr_ptr
op_eq
id|iadev-&gt;tx_dle_q.end
)paren
id|wr_ptr
op_assign
id|iadev-&gt;tx_dle_q.start
suffix:semicolon
multiline_comment|/* Build trailer dle */
id|wr_ptr-&gt;sys_pkt_addr
op_assign
id|virt_to_bus
c_func
(paren
id|iadev-&gt;tx_buf
(braket
id|desc
op_minus
l_int|1
)braket
)paren
suffix:semicolon
id|wr_ptr-&gt;local_pkt_addr
op_assign
(paren
(paren
id|buf_desc_ptr-&gt;buf_start_hi
op_lshift
l_int|16
)paren
op_or
id|buf_desc_ptr-&gt;buf_start_lo
)paren
op_plus
id|total_len
op_minus
r_sizeof
(paren
r_struct
id|cpcs_trailer
)paren
suffix:semicolon
id|wr_ptr-&gt;bytes
op_assign
r_sizeof
(paren
r_struct
id|cpcs_trailer
)paren
suffix:semicolon
id|wr_ptr-&gt;mode
op_assign
id|DMA_INT_ENABLE
suffix:semicolon
id|wr_ptr-&gt;prq_wr_ptr_data
op_assign
id|iadev-&gt;ffL.prq_wr
suffix:semicolon
multiline_comment|/* end is not to be used for the DLE q */
r_if
c_cond
(paren
op_increment
id|wr_ptr
op_eq
id|iadev-&gt;tx_dle_q.end
)paren
id|wr_ptr
op_assign
id|iadev-&gt;tx_dle_q.start
suffix:semicolon
id|iadev-&gt;tx_dle_q.write
op_assign
id|wr_ptr
suffix:semicolon
id|ATM_DESC
c_func
(paren
id|skb
)paren
op_assign
id|vcc-&gt;vci
suffix:semicolon
id|skb_queue_tail
c_func
(paren
op_amp
id|iadev-&gt;tx_dma_q
comma
id|skb
)paren
suffix:semicolon
id|atomic_inc
c_func
(paren
op_amp
id|vcc-&gt;stats-&gt;tx
)paren
suffix:semicolon
id|iadev-&gt;tx_pkt_cnt
op_increment
suffix:semicolon
multiline_comment|/* Increment transaction counter */
id|writel
c_func
(paren
l_int|2
comma
id|iadev-&gt;dma
op_plus
id|IPHASE5575_TX_COUNTER
)paren
suffix:semicolon
macro_line|#if 0        
multiline_comment|/* add flow control logic */
r_if
c_cond
(paren
id|atomic_read
c_func
(paren
op_amp
id|vcc-&gt;stats-&gt;tx
)paren
op_mod
l_int|20
op_eq
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|iavcc-&gt;vc_desc_cnt
OG
l_int|10
)paren
(brace
id|vcc-&gt;tx_quota
op_assign
id|vcc-&gt;tx_quota
op_star
l_int|3
op_div
l_int|4
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;Tx1:  vcc-&gt;tx_quota = %d &bslash;n&quot;
comma
(paren
id|u32
)paren
id|vcc-&gt;tx_quota
)paren
suffix:semicolon
id|iavcc-&gt;flow_inc
op_assign
op_minus
l_int|1
suffix:semicolon
id|iavcc-&gt;saved_tx_quota
op_assign
id|vcc-&gt;tx_quota
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
(paren
id|iavcc-&gt;flow_inc
OL
l_int|0
)paren
op_logical_and
(paren
id|iavcc-&gt;vc_desc_cnt
OL
l_int|3
)paren
)paren
(brace
singleline_comment|// vcc-&gt;tx_quota = 3 * iavcc-&gt;saved_tx_quota / 4;
id|printk
c_func
(paren
l_string|&quot;Tx2:  vcc-&gt;tx_quota = %d &bslash;n&quot;
comma
(paren
id|u32
)paren
id|vcc-&gt;tx_quota
)paren
suffix:semicolon
id|iavcc-&gt;flow_inc
op_assign
l_int|0
suffix:semicolon
)brace
)brace
macro_line|#endif
id|IF_TX
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;ia send done&bslash;n&quot;
)paren
suffix:semicolon
)paren
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|ia_send
r_static
r_int
id|ia_send
c_func
(paren
r_struct
id|atm_vcc
op_star
id|vcc
comma
r_struct
id|sk_buff
op_star
id|skb
)paren
(brace
id|IADEV
op_star
id|iadev
suffix:semicolon
r_struct
id|ia_vcc
op_star
id|iavcc
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|iadev
op_assign
id|INPH_IA_DEV
c_func
(paren
id|vcc-&gt;dev
)paren
suffix:semicolon
id|iavcc
op_assign
id|INPH_IA_VCC
c_func
(paren
id|vcc
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
op_logical_neg
id|skb
)paren
op_logical_or
(paren
id|skb-&gt;len
OG
(paren
id|iadev-&gt;tx_buf_sz
op_minus
r_sizeof
(paren
r_struct
id|cpcs_trailer
)paren
)paren
)paren
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|skb
)paren
id|printk
c_func
(paren
id|KERN_CRIT
l_string|&quot;null skb in ia_send&bslash;n&quot;
)paren
suffix:semicolon
r_else
id|dev_kfree_skb_any
c_func
(paren
id|skb
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|spin_lock_irqsave
c_func
(paren
op_amp
id|iadev-&gt;tx_lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|test_bit
c_func
(paren
id|ATM_VF_READY
comma
op_amp
id|vcc-&gt;flags
)paren
)paren
(brace
id|dev_kfree_skb_any
c_func
(paren
id|skb
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|iadev-&gt;tx_lock
comma
id|flags
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|ATM_SKB
c_func
(paren
id|skb
)paren
op_member_access_from_pointer
id|vcc
op_assign
id|vcc
suffix:semicolon
r_if
c_cond
(paren
id|skb_peek
c_func
(paren
op_amp
id|iadev-&gt;tx_backlog
)paren
)paren
(brace
id|skb_queue_tail
c_func
(paren
op_amp
id|iadev-&gt;tx_backlog
comma
id|skb
)paren
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|ia_pkt_tx
(paren
id|vcc
comma
id|skb
)paren
)paren
(brace
id|skb_queue_tail
c_func
(paren
op_amp
id|iadev-&gt;tx_backlog
comma
id|skb
)paren
suffix:semicolon
)brace
)brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|iadev-&gt;tx_lock
comma
id|flags
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|ia_sg_send
r_static
r_int
id|ia_sg_send
c_func
(paren
r_struct
id|atm_vcc
op_star
id|vcc
comma
r_int
r_int
id|start
comma
r_int
r_int
id|size
)paren
(brace
id|IF_EVENT
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;&gt;ia_sg_send&bslash;n&quot;
)paren
suffix:semicolon
)paren
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|ia_proc_read
r_static
r_int
id|ia_proc_read
c_func
(paren
r_struct
id|atm_dev
op_star
id|dev
comma
id|loff_t
op_star
id|pos
comma
r_char
op_star
id|page
)paren
(brace
r_int
id|left
op_assign
op_star
id|pos
comma
id|n
suffix:semicolon
r_char
op_star
id|tmpPtr
suffix:semicolon
id|IADEV
op_star
id|iadev
op_assign
id|INPH_IA_DEV
c_func
(paren
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|left
op_decrement
)paren
(brace
r_if
c_cond
(paren
id|iadev-&gt;phy_type
op_eq
id|FE_25MBIT_PHY
)paren
(brace
id|n
op_assign
id|sprintf
c_func
(paren
id|page
comma
l_string|&quot;  Board Type         :  Iphase5525-1KVC-128K&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|n
suffix:semicolon
)brace
r_if
c_cond
(paren
id|iadev-&gt;phy_type
op_eq
id|FE_DS3_PHY
)paren
id|n
op_assign
id|sprintf
c_func
(paren
id|page
comma
l_string|&quot;  Board Type         :  Iphase-ATM-DS3&quot;
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
id|iadev-&gt;phy_type
op_eq
id|FE_E3_PHY
)paren
id|n
op_assign
id|sprintf
c_func
(paren
id|page
comma
l_string|&quot;  Board Type         :  Iphase-ATM-E3&quot;
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
id|iadev-&gt;phy_type
op_eq
id|FE_UTP_OPTION
)paren
id|n
op_assign
id|sprintf
c_func
(paren
id|page
comma
l_string|&quot;  Board Type         :  Iphase-ATM-UTP155&quot;
)paren
suffix:semicolon
r_else
id|n
op_assign
id|sprintf
c_func
(paren
id|page
comma
l_string|&quot;  Board Type         :  Iphase-ATM-OC3&quot;
)paren
suffix:semicolon
id|tmpPtr
op_assign
id|page
op_plus
id|n
suffix:semicolon
r_if
c_cond
(paren
id|iadev-&gt;pci_map_size
op_eq
l_int|0x40000
)paren
id|n
op_add_assign
id|sprintf
c_func
(paren
id|tmpPtr
comma
l_string|&quot;-1KVC-&quot;
)paren
suffix:semicolon
r_else
id|n
op_add_assign
id|sprintf
c_func
(paren
id|tmpPtr
comma
l_string|&quot;-4KVC-&quot;
)paren
suffix:semicolon
id|tmpPtr
op_assign
id|page
op_plus
id|n
suffix:semicolon
r_if
c_cond
(paren
(paren
id|iadev-&gt;memType
op_amp
id|MEM_SIZE_MASK
)paren
op_eq
id|MEM_SIZE_1M
)paren
id|n
op_add_assign
id|sprintf
c_func
(paren
id|tmpPtr
comma
l_string|&quot;1M  &bslash;n&quot;
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
(paren
id|iadev-&gt;memType
op_amp
id|MEM_SIZE_MASK
)paren
op_eq
id|MEM_SIZE_512K
)paren
id|n
op_add_assign
id|sprintf
c_func
(paren
id|tmpPtr
comma
l_string|&quot;512K&bslash;n&quot;
)paren
suffix:semicolon
r_else
id|n
op_add_assign
id|sprintf
c_func
(paren
id|tmpPtr
comma
l_string|&quot;128K&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|n
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|left
)paren
(brace
r_return
id|sprintf
c_func
(paren
id|page
comma
l_string|&quot;  Number of Tx Buffer:  %u&bslash;n&quot;
l_string|&quot;  Size of Tx Buffer  :  %u&bslash;n&quot;
l_string|&quot;  Number of Rx Buffer:  %u&bslash;n&quot;
l_string|&quot;  Size of Rx Buffer  :  %u&bslash;n&quot;
l_string|&quot;  Packets Receiverd  :  %u&bslash;n&quot;
l_string|&quot;  Packets Transmitted:  %u&bslash;n&quot;
l_string|&quot;  Cells Received     :  %u&bslash;n&quot;
l_string|&quot;  Cells Transmitted  :  %u&bslash;n&quot;
l_string|&quot;  Board Dropped Cells:  %u&bslash;n&quot;
l_string|&quot;  Board Dropped Pkts :  %u&bslash;n&quot;
comma
id|iadev-&gt;num_tx_desc
comma
id|iadev-&gt;tx_buf_sz
comma
id|iadev-&gt;num_rx_desc
comma
id|iadev-&gt;rx_buf_sz
comma
id|iadev-&gt;rx_pkt_cnt
comma
id|iadev-&gt;tx_pkt_cnt
comma
id|iadev-&gt;rx_cell_cnt
comma
id|iadev-&gt;tx_cell_cnt
comma
id|iadev-&gt;drop_rxcell
comma
id|iadev-&gt;drop_rxpkt
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|variable|ops
r_static
r_const
r_struct
id|atmdev_ops
id|ops
op_assign
(brace
id|open
suffix:colon
id|ia_open
comma
id|close
suffix:colon
id|ia_close
comma
id|ioctl
suffix:colon
id|ia_ioctl
comma
id|getsockopt
suffix:colon
id|ia_getsockopt
comma
id|setsockopt
suffix:colon
id|ia_setsockopt
comma
id|send
suffix:colon
id|ia_send
comma
id|sg_send
suffix:colon
id|ia_sg_send
comma
id|phy_put
suffix:colon
id|ia_phy_put
comma
id|phy_get
suffix:colon
id|ia_phy_get
comma
id|change_qos
suffix:colon
id|ia_change_qos
comma
id|proc_read
suffix:colon
id|ia_proc_read
comma
id|owner
suffix:colon
id|THIS_MODULE
comma
)brace
suffix:semicolon
macro_line|#if LINUX_VERSION_CODE &gt;= 0x20312
DECL|function|ia_detect
r_int
id|__init
id|ia_detect
c_func
(paren
r_void
)paren
macro_line|#else
id|__initfunc
c_func
(paren
r_int
id|ia_detect
c_func
(paren
r_void
)paren
)paren
macro_line|#endif 
(brace
r_struct
id|atm_dev
op_star
id|dev
suffix:semicolon
id|IADEV
op_star
id|iadev
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_int
id|index
op_assign
l_int|0
suffix:semicolon
r_struct
id|pci_dev
op_star
id|prev_dev
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pci_present
c_func
(paren
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
id|DEV_LABEL
l_string|&quot; driver but no PCI BIOS ?&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|iadev
op_assign
(paren
id|IADEV
op_star
)paren
id|kmalloc
c_func
(paren
r_sizeof
(paren
id|IADEV
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|iadev
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|memset
c_func
(paren
(paren
r_char
op_star
)paren
id|iadev
comma
l_int|0
comma
r_sizeof
(paren
id|IADEV
)paren
)paren
suffix:semicolon
id|prev_dev
op_assign
l_int|NULL
suffix:semicolon
r_while
c_loop
(paren
(paren
id|iadev-&gt;pci
op_assign
id|pci_find_device
c_func
(paren
id|PCI_VENDOR_ID_IPHASE
comma
id|PCI_DEVICE_ID_IPHASE_5575
comma
id|prev_dev
)paren
)paren
)paren
(brace
id|IF_INIT
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;ia detected at bus:%d dev: %d function:%d&bslash;n&quot;
comma
id|iadev-&gt;pci-&gt;bus-&gt;number
comma
id|PCI_SLOT
c_func
(paren
id|iadev-&gt;pci-&gt;devfn
)paren
comma
id|PCI_FUNC
c_func
(paren
id|iadev-&gt;pci-&gt;devfn
)paren
)paren
suffix:semicolon
)paren
r_if
c_cond
(paren
id|pci_enable_device
c_func
(paren
id|iadev-&gt;pci
)paren
)paren
r_break
suffix:semicolon
id|dev
op_assign
id|atm_dev_register
c_func
(paren
id|DEV_LABEL
comma
op_amp
id|ops
comma
op_minus
l_int|1
comma
l_int|NULL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dev
)paren
r_break
suffix:semicolon
id|IF_INIT
c_func
(paren
id|printk
c_func
(paren
id|DEV_LABEL
l_string|&quot;registered at (itf :%d)&bslash;n&quot;
comma
id|dev-&gt;number
)paren
suffix:semicolon
)paren
id|INPH_IA_DEV
c_func
(paren
id|dev
)paren
op_assign
id|iadev
suffix:semicolon
singleline_comment|// TODO: multi_board using ia_boards logic in cleanup_module
id|ia_dev
(braket
id|index
)braket
op_assign
id|iadev
suffix:semicolon
id|_ia_dev
(braket
id|index
)braket
op_assign
id|dev
suffix:semicolon
id|IF_INIT
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;dev_id = 0x%x iadev-&gt;LineRate = %d &bslash;n&quot;
comma
(paren
id|u32
)paren
id|dev
comma
id|iadev-&gt;LineRate
)paren
suffix:semicolon
)paren
id|iadev_count
op_increment
suffix:semicolon
id|spin_lock_init
c_func
(paren
op_amp
id|iadev-&gt;misc_lock
)paren
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|iadev-&gt;misc_lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ia_init
c_func
(paren
id|dev
)paren
op_logical_or
id|ia_start
c_func
(paren
id|dev
)paren
)paren
(brace
id|atm_dev_deregister
c_func
(paren
id|dev
)paren
suffix:semicolon
id|IF_INIT
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;IA register failed!&bslash;n&quot;
)paren
suffix:semicolon
)paren
id|ia_dev
(braket
id|index
)braket
op_assign
l_int|NULL
suffix:semicolon
id|_ia_dev
(braket
id|index
)braket
op_assign
l_int|NULL
suffix:semicolon
id|iadev_count
op_decrement
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|iadev-&gt;misc_lock
comma
id|flags
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|iadev-&gt;misc_lock
comma
id|flags
)paren
suffix:semicolon
id|IF_EVENT
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;iadev_count = %d&bslash;n&quot;
comma
id|iadev_count
)paren
suffix:semicolon
)paren
id|prev_dev
op_assign
id|iadev-&gt;pci
suffix:semicolon
id|iadev-&gt;next_board
op_assign
id|ia_boards
suffix:semicolon
id|ia_boards
op_assign
id|dev
suffix:semicolon
id|iadev
op_assign
(paren
id|IADEV
op_star
)paren
id|kmalloc
c_func
(paren
r_sizeof
(paren
id|IADEV
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|iadev
)paren
r_break
suffix:semicolon
id|memset
c_func
(paren
(paren
r_char
op_star
)paren
id|iadev
comma
l_int|0
comma
r_sizeof
(paren
id|IADEV
)paren
)paren
suffix:semicolon
id|index
op_increment
suffix:semicolon
id|dev
op_assign
l_int|NULL
suffix:semicolon
)brace
r_return
id|index
suffix:semicolon
)brace
macro_line|#ifdef MODULE  
DECL|function|init_module
r_int
id|init_module
c_func
(paren
r_void
)paren
(brace
id|IF_EVENT
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;&gt;ia init_module&bslash;n&quot;
)paren
suffix:semicolon
)paren
r_if
c_cond
(paren
op_logical_neg
id|ia_detect
c_func
(paren
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
id|DEV_LABEL
l_string|&quot;: no adapter found&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENXIO
suffix:semicolon
)brace
id|ia_timer.expires
op_assign
id|jiffies
op_plus
l_int|3
op_star
id|HZ
suffix:semicolon
id|add_timer
c_func
(paren
op_amp
id|ia_timer
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|cleanup_module
r_void
id|cleanup_module
c_func
(paren
r_void
)paren
(brace
r_struct
id|atm_dev
op_star
id|dev
suffix:semicolon
id|IADEV
op_star
id|iadev
suffix:semicolon
r_int
r_int
id|command
suffix:semicolon
r_int
id|i
comma
id|j
op_assign
l_int|0
suffix:semicolon
id|IF_EVENT
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;&gt;ia cleanup_module&bslash;n&quot;
)paren
suffix:semicolon
)paren
r_if
c_cond
(paren
id|MOD_IN_USE
)paren
id|printk
c_func
(paren
l_string|&quot;ia: module in use&bslash;n&quot;
)paren
suffix:semicolon
id|del_timer
c_func
(paren
op_amp
id|ia_timer
)paren
suffix:semicolon
r_while
c_loop
(paren
id|ia_dev
(braket
id|j
)braket
)paren
(brace
id|dev
op_assign
id|ia_boards
suffix:semicolon
id|iadev
op_assign
id|INPH_IA_DEV
c_func
(paren
id|dev
)paren
suffix:semicolon
id|ia_boards
op_assign
id|iadev-&gt;next_board
suffix:semicolon
multiline_comment|/* disable interrupt of lost signal */
id|ia_phy_put
c_func
(paren
id|dev
comma
id|ia_phy_get
c_func
(paren
id|dev
comma
l_int|0x10
)paren
op_amp
op_complement
(paren
l_int|0x4
)paren
comma
l_int|0x10
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|1
)paren
suffix:semicolon
multiline_comment|/* De-register device */
id|atm_dev_deregister
c_func
(paren
id|dev
)paren
suffix:semicolon
id|IF_EVENT
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;iav deregistered at (itf:%d)&bslash;n&quot;
comma
id|dev-&gt;number
)paren
suffix:semicolon
)paren
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|iadev-&gt;num_tx_desc
suffix:semicolon
id|i
op_increment
)paren
id|kfree
c_func
(paren
id|iadev-&gt;tx_buf
(braket
id|i
)braket
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|iadev-&gt;tx_buf
)paren
suffix:semicolon
multiline_comment|/* Disable memory mapping and busmastering */
r_if
c_cond
(paren
id|pci_read_config_word
c_func
(paren
id|iadev-&gt;pci
comma
id|PCI_COMMAND
comma
op_amp
id|command
)paren
op_ne
l_int|0
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;ia: can&squot;t read PCI_COMMAND.&bslash;n&quot;
)paren
suffix:semicolon
)brace
id|command
op_and_assign
op_complement
(paren
id|PCI_COMMAND_MEMORY
op_or
id|PCI_COMMAND_MASTER
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pci_write_config_word
c_func
(paren
id|iadev-&gt;pci
comma
id|PCI_COMMAND
comma
id|command
)paren
op_ne
l_int|0
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;ia: can&squot;t write PCI_COMMAND.&bslash;n&quot;
)paren
suffix:semicolon
)brace
id|free_irq
c_func
(paren
id|iadev-&gt;irq
comma
id|dev
)paren
suffix:semicolon
id|iounmap
c_func
(paren
(paren
r_void
op_star
)paren
id|iadev-&gt;base
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|iadev
)paren
suffix:semicolon
id|j
op_increment
suffix:semicolon
)brace
multiline_comment|/* and voila whatever we tried seems to work. I don&squot;t know if it will  &n;&t;&t;fix suni errors though. Really doubt that. */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|8
suffix:semicolon
id|i
op_increment
)paren
(brace
id|ia_dev
(braket
id|i
)braket
op_assign
l_int|NULL
suffix:semicolon
id|_ia_dev
(braket
id|i
)braket
op_assign
l_int|NULL
suffix:semicolon
)brace
)brace
macro_line|#endif  
eof
