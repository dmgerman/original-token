multiline_comment|/*&n;  $Id: fore200e_mkfirm.c,v 1.1 2000/02/21 16:04:32 davem Exp $&n;&n;  mkfirm.c: generates a C readable file from a binary firmware image&n;&n;  Christophe Lizzi (lizzi@{csti.fr, cnam.fr}), June 1999.&n;  &n;  This software may be used and distributed according to the terms&n;  of the GNU General Public License, incorporated herein by reference.&n;*/
macro_line|#include &lt;stdio.h&gt;
macro_line|#include &lt;sys/types.h&gt;
macro_line|#include &lt;sys/time.h&gt;
DECL|variable|default_basename
r_char
op_star
id|default_basename
op_assign
l_string|&quot;pca200e&quot;
suffix:semicolon
multiline_comment|/* was initially written for the PCA-200E firmware */
DECL|variable|default_infname
r_char
op_star
id|default_infname
op_assign
l_string|&quot;&lt;stdin&gt;&quot;
suffix:semicolon
DECL|variable|default_outfname
r_char
op_star
id|default_outfname
op_assign
l_string|&quot;&lt;stdout&gt;&quot;
suffix:semicolon
DECL|variable|progname
r_char
op_star
id|progname
suffix:semicolon
DECL|variable|verbose
r_int
id|verbose
op_assign
l_int|0
suffix:semicolon
DECL|variable|inkernel
r_int
id|inkernel
op_assign
l_int|0
suffix:semicolon
DECL|function|usage
r_void
id|usage
c_func
(paren
r_void
)paren
(brace
id|fprintf
c_func
(paren
id|stderr
comma
l_string|&quot;%s: [-v] [-k] [-b basename ] [-i firmware.bin] [-o firmware.c]&bslash;n&quot;
comma
id|progname
)paren
suffix:semicolon
m_exit
(paren
op_minus
l_int|1
)paren
suffix:semicolon
)brace
DECL|function|main
r_int
id|main
c_func
(paren
r_int
id|argc
comma
r_char
op_star
op_star
id|argv
)paren
(brace
id|time_t
id|now
suffix:semicolon
r_char
op_star
id|infname
op_assign
l_int|NULL
suffix:semicolon
r_char
op_star
id|outfname
op_assign
l_int|NULL
suffix:semicolon
r_char
op_star
id|basename
op_assign
l_int|NULL
suffix:semicolon
id|FILE
op_star
id|infile
suffix:semicolon
id|FILE
op_star
id|outfile
suffix:semicolon
r_int
id|firmsize
suffix:semicolon
r_int
id|c
suffix:semicolon
id|progname
op_assign
op_star
(paren
id|argv
op_increment
)paren
suffix:semicolon
r_while
c_loop
(paren
id|argc
OG
l_int|1
)paren
(brace
r_if
c_cond
(paren
(paren
op_star
id|argv
)paren
(braket
l_int|0
)braket
op_eq
l_char|&squot;-&squot;
)paren
(brace
r_switch
c_cond
(paren
(paren
op_star
id|argv
)paren
(braket
l_int|1
)braket
)paren
(brace
r_case
l_char|&squot;i&squot;
suffix:colon
r_if
c_cond
(paren
id|argc
op_decrement
OL
l_int|3
)paren
id|usage
c_func
(paren
)paren
suffix:semicolon
id|infname
op_assign
op_star
(paren
op_increment
id|argv
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_char|&squot;o&squot;
suffix:colon
r_if
c_cond
(paren
id|argc
op_decrement
OL
l_int|3
)paren
id|usage
c_func
(paren
)paren
suffix:semicolon
id|outfname
op_assign
op_star
(paren
op_increment
id|argv
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_char|&squot;b&squot;
suffix:colon
r_if
c_cond
(paren
id|argc
op_decrement
OL
l_int|3
)paren
id|usage
c_func
(paren
)paren
suffix:semicolon
id|basename
op_assign
op_star
(paren
op_increment
id|argv
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_char|&squot;v&squot;
suffix:colon
id|verbose
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
r_case
l_char|&squot;k&squot;
suffix:colon
id|inkernel
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|usage
c_func
(paren
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
id|usage
c_func
(paren
)paren
suffix:semicolon
)brace
id|argc
op_decrement
suffix:semicolon
id|argv
op_increment
suffix:semicolon
)brace
r_if
c_cond
(paren
id|infname
op_ne
l_int|NULL
)paren
(brace
id|infile
op_assign
id|fopen
c_func
(paren
id|infname
comma
l_string|&quot;r&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|infile
op_eq
l_int|NULL
)paren
(brace
id|fprintf
c_func
(paren
id|stderr
comma
l_string|&quot;%s: can&squot;t open %s for reading&bslash;n&quot;
comma
id|progname
comma
id|infname
)paren
suffix:semicolon
m_exit
(paren
op_minus
l_int|2
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
id|infile
op_assign
id|stdin
suffix:semicolon
id|infname
op_assign
id|default_infname
suffix:semicolon
)brace
r_if
c_cond
(paren
id|outfname
)paren
(brace
id|outfile
op_assign
id|fopen
c_func
(paren
id|outfname
comma
l_string|&quot;w&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|outfile
op_eq
l_int|NULL
)paren
(brace
id|fprintf
c_func
(paren
id|stderr
comma
l_string|&quot;%s: can&squot;t open %s for writing&bslash;n&quot;
comma
id|progname
comma
id|outfname
)paren
suffix:semicolon
m_exit
(paren
op_minus
l_int|3
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
id|outfile
op_assign
id|stdout
suffix:semicolon
id|outfname
op_assign
id|default_outfname
suffix:semicolon
)brace
r_if
c_cond
(paren
id|basename
op_eq
l_int|NULL
)paren
id|basename
op_assign
id|default_basename
suffix:semicolon
r_if
c_cond
(paren
id|verbose
)paren
(brace
id|fprintf
c_func
(paren
id|stderr
comma
l_string|&quot;%s: input file = %s&bslash;n&quot;
comma
id|progname
comma
id|infname
)paren
suffix:semicolon
id|fprintf
c_func
(paren
id|stderr
comma
l_string|&quot;%s: output file = %s&bslash;n&quot;
comma
id|progname
comma
id|outfname
)paren
suffix:semicolon
id|fprintf
c_func
(paren
id|stderr
comma
l_string|&quot;%s: firmware basename = %s&bslash;n&quot;
comma
id|progname
comma
id|basename
)paren
suffix:semicolon
)brace
id|time
c_func
(paren
op_amp
id|now
)paren
suffix:semicolon
id|fprintf
c_func
(paren
id|outfile
comma
l_string|&quot;/*&bslash;n  generated by %s from %s on %s&quot;
l_string|&quot;  DO NOT EDIT!&bslash;n*/&bslash;n&bslash;n&quot;
comma
id|progname
comma
id|infname
comma
id|ctime
c_func
(paren
op_amp
id|now
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|inkernel
)paren
id|fprintf
c_func
(paren
id|outfile
comma
l_string|&quot;#include &lt;linux/init.h&gt;&bslash;n&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* XXX force 32 bit alignment? */
id|fprintf
c_func
(paren
id|outfile
comma
l_string|&quot;const unsigned char%s %s_data[] = {&bslash;n&quot;
comma
id|inkernel
ques
c_cond
l_string|&quot; __initdata&quot;
suffix:colon
l_string|&quot;&quot;
comma
id|basename
)paren
suffix:semicolon
id|c
op_assign
id|getc
c_func
(paren
id|infile
)paren
suffix:semicolon
id|fprintf
c_func
(paren
id|outfile
comma
l_string|&quot;&bslash;t0x%02x&quot;
comma
id|c
)paren
suffix:semicolon
id|firmsize
op_assign
l_int|1
suffix:semicolon
r_while
c_loop
(paren
(paren
id|c
op_assign
id|getc
c_func
(paren
id|infile
)paren
)paren
op_ge
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|firmsize
op_increment
op_mod
l_int|8
)paren
id|fprintf
c_func
(paren
id|outfile
comma
l_string|&quot;, 0x%02x&quot;
comma
id|c
)paren
suffix:semicolon
r_else
id|fprintf
c_func
(paren
id|outfile
comma
l_string|&quot;,&bslash;n&bslash;t0x%02x&quot;
comma
id|c
)paren
suffix:semicolon
)brace
id|fprintf
c_func
(paren
id|outfile
comma
l_string|&quot;&bslash;n};&bslash;n&bslash;n&quot;
)paren
suffix:semicolon
id|fprintf
c_func
(paren
id|outfile
comma
l_string|&quot;const unsigned int%s %s_size = %u;&bslash;n&quot;
comma
id|inkernel
ques
c_cond
l_string|&quot; __initdata&quot;
suffix:colon
l_string|&quot;&quot;
comma
id|basename
comma
id|firmsize
)paren
suffix:semicolon
r_if
c_cond
(paren
id|infile
op_ne
id|stdin
)paren
id|fclose
c_func
(paren
id|infile
)paren
suffix:semicolon
r_if
c_cond
(paren
id|outfile
op_ne
id|stdout
)paren
id|fclose
c_func
(paren
id|outfile
)paren
suffix:semicolon
r_if
c_cond
(paren
id|verbose
)paren
(brace
id|fprintf
c_func
(paren
id|stderr
comma
l_string|&quot;%s: firmware size = %u&bslash;n&quot;
comma
id|progname
comma
id|firmsize
)paren
suffix:semicolon
)brace
m_exit
(paren
l_int|0
)paren
suffix:semicolon
)brace
eof
