multiline_comment|/* drivers/atm/uPD98402.c - NEC uPD98402 (PHY) declarations */
multiline_comment|/* Written 1995-2000 by Werner Almesberger, EPFL LRC/ICA */
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/sched.h&gt; /* for jiffies */
macro_line|#include &lt;linux/mm.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/atmdev.h&gt;
macro_line|#include &lt;linux/sonet.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;asm/uaccess.h&gt;
macro_line|#include &lt;asm/atomic.h&gt;
macro_line|#include &quot;uPD98402.h&quot;
macro_line|#if 0
mdefine_line|#define DPRINTK(format,args...) printk(KERN_DEBUG format,##args)
macro_line|#else
DECL|macro|DPRINTK
mdefine_line|#define DPRINTK(format,args...)
macro_line|#endif
DECL|struct|uPD98402_priv
r_struct
id|uPD98402_priv
(brace
DECL|member|sonet_stats
r_struct
id|k_sonet_stats
id|sonet_stats
suffix:semicolon
multiline_comment|/* link diagnostics */
DECL|member|framing
r_int
r_char
id|framing
suffix:semicolon
multiline_comment|/* SONET/SDH framing */
DECL|member|loop_mode
r_int
id|loop_mode
suffix:semicolon
multiline_comment|/* loopback mode */
)brace
suffix:semicolon
DECL|macro|PRIV
mdefine_line|#define PRIV(dev) ((struct uPD98402_priv *) dev-&gt;phy_data)
DECL|macro|PUT
mdefine_line|#define PUT(val,reg) dev-&gt;ops-&gt;phy_put(dev,val,uPD98402_##reg)
DECL|macro|GET
mdefine_line|#define GET(reg) dev-&gt;ops-&gt;phy_get(dev,uPD98402_##reg)
DECL|function|fetch_stats
r_static
r_int
id|fetch_stats
c_func
(paren
r_struct
id|atm_dev
op_star
id|dev
comma
r_struct
id|sonet_stats
op_star
id|arg
comma
r_int
id|zero
)paren
(brace
r_struct
id|sonet_stats
id|tmp
suffix:semicolon
r_int
id|error
op_assign
l_int|0
suffix:semicolon
id|atomic_add
c_func
(paren
id|GET
c_func
(paren
id|HECCT
)paren
comma
op_amp
id|PRIV
c_func
(paren
id|dev
)paren
op_member_access_from_pointer
id|sonet_stats.uncorr_hcs
)paren
suffix:semicolon
id|sonet_copy_stats
c_func
(paren
op_amp
id|PRIV
c_func
(paren
id|dev
)paren
op_member_access_from_pointer
id|sonet_stats
comma
op_amp
id|tmp
)paren
suffix:semicolon
r_if
c_cond
(paren
id|arg
)paren
id|error
op_assign
id|copy_to_user
c_func
(paren
id|arg
comma
op_amp
id|tmp
comma
r_sizeof
(paren
id|tmp
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|zero
op_logical_and
op_logical_neg
id|error
)paren
(brace
multiline_comment|/* unused fields are reported as -1, but we must not &quot;adjust&quot;&n;&t;&t;   them */
id|tmp.corr_hcs
op_assign
id|tmp.tx_cells
op_assign
id|tmp.rx_cells
op_assign
l_int|0
suffix:semicolon
id|sonet_subtract_stats
c_func
(paren
op_amp
id|PRIV
c_func
(paren
id|dev
)paren
op_member_access_from_pointer
id|sonet_stats
comma
op_amp
id|tmp
)paren
suffix:semicolon
)brace
r_return
id|error
ques
c_cond
op_minus
id|EFAULT
suffix:colon
l_int|0
suffix:semicolon
)brace
DECL|function|set_framing
r_static
r_int
id|set_framing
c_func
(paren
r_struct
id|atm_dev
op_star
id|dev
comma
r_int
r_char
id|framing
)paren
(brace
r_static
r_const
r_int
r_char
id|sonet
(braket
)braket
op_assign
(brace
l_int|1
comma
l_int|2
comma
l_int|3
comma
l_int|0
)brace
suffix:semicolon
r_static
r_const
r_int
r_char
id|sdh
(braket
)braket
op_assign
(brace
l_int|1
comma
l_int|0
comma
l_int|0
comma
l_int|2
)brace
suffix:semicolon
r_const
r_char
op_star
id|set
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_switch
c_cond
(paren
id|framing
)paren
(brace
r_case
id|SONET_FRAME_SONET
suffix:colon
id|set
op_assign
id|sonet
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SONET_FRAME_SDH
suffix:colon
id|set
op_assign
id|sdh
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|PUT
c_func
(paren
id|set
(braket
l_int|0
)braket
comma
id|C11T
)paren
suffix:semicolon
id|PUT
c_func
(paren
id|set
(braket
l_int|1
)braket
comma
id|C12T
)paren
suffix:semicolon
id|PUT
c_func
(paren
id|set
(braket
l_int|2
)braket
comma
id|C13T
)paren
suffix:semicolon
id|PUT
c_func
(paren
(paren
id|GET
c_func
(paren
id|MDR
)paren
op_amp
op_complement
id|uPD98402_MDR_SS_MASK
)paren
op_or
(paren
id|set
(braket
l_int|3
)braket
op_lshift
id|uPD98402_MDR_SS_SHIFT
)paren
comma
id|MDR
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|get_sense
r_static
r_int
id|get_sense
c_func
(paren
r_struct
id|atm_dev
op_star
id|dev
comma
id|u8
op_star
id|arg
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
r_int
id|error
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|error
op_assign
id|put_user
c_func
(paren
id|GET
c_func
(paren
id|C11R
)paren
comma
id|arg
)paren
op_logical_or
id|put_user
c_func
(paren
id|GET
c_func
(paren
id|C12R
)paren
comma
id|arg
op_plus
l_int|1
)paren
op_logical_or
id|put_user
c_func
(paren
id|GET
c_func
(paren
id|C13R
)paren
comma
id|arg
op_plus
l_int|2
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|error
op_assign
id|error
op_logical_or
id|put_user
c_func
(paren
l_int|0xff
comma
id|arg
op_plus
l_int|3
)paren
op_logical_or
id|put_user
c_func
(paren
l_int|0xff
comma
id|arg
op_plus
l_int|4
)paren
op_logical_or
id|put_user
c_func
(paren
l_int|0xff
comma
id|arg
op_plus
l_int|5
)paren
suffix:semicolon
r_return
id|error
ques
c_cond
op_minus
id|EFAULT
suffix:colon
l_int|0
suffix:semicolon
)brace
DECL|function|set_loopback
r_static
r_int
id|set_loopback
c_func
(paren
r_struct
id|atm_dev
op_star
id|dev
comma
r_int
id|mode
)paren
(brace
r_int
r_char
id|mode_reg
suffix:semicolon
id|mode_reg
op_assign
id|GET
c_func
(paren
id|MDR
)paren
op_amp
op_complement
(paren
id|uPD98402_MDR_TPLP
op_or
id|uPD98402_MDR_ALP
op_or
id|uPD98402_MDR_RPLP
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|__ATM_LM_XTLOC
c_func
(paren
id|mode
)paren
)paren
(brace
r_case
id|__ATM_LM_NONE
suffix:colon
r_break
suffix:semicolon
r_case
id|__ATM_LM_PHY
suffix:colon
id|mode_reg
op_or_assign
id|uPD98402_MDR_TPLP
suffix:semicolon
r_break
suffix:semicolon
r_case
id|__ATM_LM_ATM
suffix:colon
id|mode_reg
op_or_assign
id|uPD98402_MDR_ALP
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_switch
c_cond
(paren
id|__ATM_LM_XTRMT
c_func
(paren
id|mode
)paren
)paren
(brace
r_case
id|__ATM_LM_NONE
suffix:colon
r_break
suffix:semicolon
r_case
id|__ATM_LM_PHY
suffix:colon
id|mode_reg
op_or_assign
id|uPD98402_MDR_RPLP
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|PUT
c_func
(paren
id|mode_reg
comma
id|MDR
)paren
suffix:semicolon
id|PRIV
c_func
(paren
id|dev
)paren
op_member_access_from_pointer
id|loop_mode
op_assign
id|mode
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|uPD98402_ioctl
r_static
r_int
id|uPD98402_ioctl
c_func
(paren
r_struct
id|atm_dev
op_star
id|dev
comma
r_int
r_int
id|cmd
comma
r_void
op_star
id|arg
)paren
(brace
r_switch
c_cond
(paren
id|cmd
)paren
(brace
r_case
id|SONET_GETSTATZ
suffix:colon
r_case
id|SONET_GETSTAT
suffix:colon
r_return
id|fetch_stats
c_func
(paren
id|dev
comma
(paren
r_struct
id|sonet_stats
op_star
)paren
id|arg
comma
id|cmd
op_eq
id|SONET_GETSTATZ
)paren
suffix:semicolon
r_case
id|SONET_SETFRAMING
suffix:colon
r_return
id|set_framing
c_func
(paren
id|dev
comma
(paren
r_int
)paren
(paren
r_int
)paren
id|arg
)paren
suffix:semicolon
r_case
id|SONET_GETFRAMING
suffix:colon
r_return
id|put_user
c_func
(paren
id|PRIV
c_func
(paren
id|dev
)paren
op_member_access_from_pointer
id|framing
comma
(paren
r_int
op_star
)paren
id|arg
)paren
ques
c_cond
op_minus
id|EFAULT
suffix:colon
l_int|0
suffix:semicolon
r_case
id|SONET_GETFRSENSE
suffix:colon
r_return
id|get_sense
c_func
(paren
id|dev
comma
id|arg
)paren
suffix:semicolon
r_case
id|ATM_SETLOOP
suffix:colon
r_return
id|set_loopback
c_func
(paren
id|dev
comma
(paren
r_int
)paren
(paren
r_int
)paren
id|arg
)paren
suffix:semicolon
r_case
id|ATM_GETLOOP
suffix:colon
r_return
id|put_user
c_func
(paren
id|PRIV
c_func
(paren
id|dev
)paren
op_member_access_from_pointer
id|loop_mode
comma
(paren
r_int
op_star
)paren
id|arg
)paren
ques
c_cond
op_minus
id|EFAULT
suffix:colon
l_int|0
suffix:semicolon
r_case
id|ATM_QUERYLOOP
suffix:colon
r_return
id|put_user
c_func
(paren
id|ATM_LM_LOC_PHY
op_or
id|ATM_LM_LOC_ATM
op_or
id|ATM_LM_RMT_PHY
comma
(paren
r_int
op_star
)paren
id|arg
)paren
ques
c_cond
op_minus
id|EFAULT
suffix:colon
l_int|0
suffix:semicolon
r_default
suffix:colon
r_return
op_minus
id|ENOIOCTLCMD
suffix:semicolon
)brace
)brace
DECL|macro|ADD_LIMITED
mdefine_line|#define ADD_LIMITED(s,v) &bslash;&n;    { atomic_add(GET(v),&amp;PRIV(dev)-&gt;sonet_stats.s); &bslash;&n;    if (atomic_read(&amp;PRIV(dev)-&gt;sonet_stats.s) &lt; 0) &bslash;&n;&t;atomic_set(&amp;PRIV(dev)-&gt;sonet_stats.s,INT_MAX); }
DECL|function|stat_event
r_static
r_void
id|stat_event
c_func
(paren
r_struct
id|atm_dev
op_star
id|dev
)paren
(brace
r_int
r_char
id|events
suffix:semicolon
id|events
op_assign
id|GET
c_func
(paren
id|PCR
)paren
suffix:semicolon
r_if
c_cond
(paren
id|events
op_amp
id|uPD98402_PFM_PFEB
)paren
id|ADD_LIMITED
c_func
(paren
id|path_febe
comma
id|PFECB
)paren
suffix:semicolon
r_if
c_cond
(paren
id|events
op_amp
id|uPD98402_PFM_LFEB
)paren
id|ADD_LIMITED
c_func
(paren
id|line_febe
comma
id|LECCT
)paren
suffix:semicolon
r_if
c_cond
(paren
id|events
op_amp
id|uPD98402_PFM_B3E
)paren
id|ADD_LIMITED
c_func
(paren
id|path_bip
comma
id|B3ECT
)paren
suffix:semicolon
r_if
c_cond
(paren
id|events
op_amp
id|uPD98402_PFM_B2E
)paren
id|ADD_LIMITED
c_func
(paren
id|line_bip
comma
id|B2ECT
)paren
suffix:semicolon
r_if
c_cond
(paren
id|events
op_amp
id|uPD98402_PFM_B1E
)paren
id|ADD_LIMITED
c_func
(paren
id|section_bip
comma
id|B1ECT
)paren
suffix:semicolon
)brace
DECL|macro|ADD_LIMITED
macro_line|#undef ADD_LIMITED
DECL|function|uPD98402_int
r_static
r_void
id|uPD98402_int
c_func
(paren
r_struct
id|atm_dev
op_star
id|dev
)paren
(brace
r_static
r_int
r_int
id|silence
op_assign
l_int|0
suffix:semicolon
r_int
r_char
id|reason
suffix:semicolon
r_while
c_loop
(paren
(paren
id|reason
op_assign
id|GET
c_func
(paren
id|PICR
)paren
)paren
)paren
(brace
r_if
c_cond
(paren
id|reason
op_amp
id|uPD98402_INT_LOS
)paren
id|printk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;%s(itf %d): signal lost&bslash;n&quot;
comma
id|dev-&gt;type
comma
id|dev-&gt;number
)paren
suffix:semicolon
r_if
c_cond
(paren
id|reason
op_amp
id|uPD98402_INT_PFM
)paren
id|stat_event
c_func
(paren
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|reason
op_amp
id|uPD98402_INT_PCO
)paren
(brace
(paren
r_void
)paren
id|GET
c_func
(paren
id|PCOCR
)paren
suffix:semicolon
multiline_comment|/* clear interrupt cause */
id|atomic_add
c_func
(paren
id|GET
c_func
(paren
id|HECCT
)paren
comma
op_amp
id|PRIV
c_func
(paren
id|dev
)paren
op_member_access_from_pointer
id|sonet_stats.uncorr_hcs
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|reason
op_amp
id|uPD98402_INT_RFO
)paren
op_logical_and
(paren
id|time_after
c_func
(paren
id|jiffies
comma
id|silence
)paren
op_logical_or
id|silence
op_eq
l_int|0
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s(itf %d): uPD98402 receive &quot;
l_string|&quot;FIFO overflow&bslash;n&quot;
comma
id|dev-&gt;type
comma
id|dev-&gt;number
)paren
suffix:semicolon
id|silence
op_assign
(paren
id|jiffies
op_plus
id|HZ
op_div
l_int|2
)paren
op_or
l_int|1
suffix:semicolon
)brace
)brace
)brace
DECL|function|uPD98402_start
r_static
r_int
id|uPD98402_start
c_func
(paren
r_struct
id|atm_dev
op_star
id|dev
)paren
(brace
id|DPRINTK
c_func
(paren
l_string|&quot;phy_start&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|PRIV
c_func
(paren
id|dev
)paren
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|uPD98402_priv
)paren
comma
id|GFP_KERNEL
)paren
)paren
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|memset
c_func
(paren
op_amp
id|PRIV
c_func
(paren
id|dev
)paren
op_member_access_from_pointer
id|sonet_stats
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|k_sonet_stats
)paren
)paren
suffix:semicolon
(paren
r_void
)paren
id|GET
c_func
(paren
id|PCR
)paren
suffix:semicolon
multiline_comment|/* clear performance events */
id|PUT
c_func
(paren
id|uPD98402_PFM_FJ
comma
id|PCMR
)paren
suffix:semicolon
multiline_comment|/* ignore frequency adj */
(paren
r_void
)paren
id|GET
c_func
(paren
id|PCOCR
)paren
suffix:semicolon
multiline_comment|/* clear overflows */
id|PUT
c_func
(paren
op_complement
id|uPD98402_PCO_HECC
comma
id|PCOMR
)paren
suffix:semicolon
(paren
r_void
)paren
id|GET
c_func
(paren
id|PICR
)paren
suffix:semicolon
multiline_comment|/* clear interrupts */
id|PUT
c_func
(paren
op_complement
(paren
id|uPD98402_INT_PFM
op_or
id|uPD98402_INT_ALM
op_or
id|uPD98402_INT_RFO
op_or
id|uPD98402_INT_LOS
)paren
comma
id|PIMR
)paren
suffix:semicolon
multiline_comment|/* enable them */
(paren
r_void
)paren
id|fetch_stats
c_func
(paren
id|dev
comma
l_int|NULL
comma
l_int|1
)paren
suffix:semicolon
multiline_comment|/* clear kernel counters */
id|atomic_set
c_func
(paren
op_amp
id|PRIV
c_func
(paren
id|dev
)paren
op_member_access_from_pointer
id|sonet_stats.corr_hcs
comma
op_minus
l_int|1
)paren
suffix:semicolon
id|atomic_set
c_func
(paren
op_amp
id|PRIV
c_func
(paren
id|dev
)paren
op_member_access_from_pointer
id|sonet_stats.tx_cells
comma
op_minus
l_int|1
)paren
suffix:semicolon
id|atomic_set
c_func
(paren
op_amp
id|PRIV
c_func
(paren
id|dev
)paren
op_member_access_from_pointer
id|sonet_stats.rx_cells
comma
op_minus
l_int|1
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|uPD98402_stop
r_static
r_int
id|uPD98402_stop
c_func
(paren
r_struct
id|atm_dev
op_star
id|dev
)paren
(brace
multiline_comment|/* let SAR driver worry about stopping interrupts */
id|kfree
c_func
(paren
id|PRIV
c_func
(paren
id|dev
)paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|variable|uPD98402_ops
r_static
r_const
r_struct
id|atmphy_ops
id|uPD98402_ops
op_assign
(brace
id|start
suffix:colon
id|uPD98402_start
comma
id|ioctl
suffix:colon
id|uPD98402_ioctl
comma
id|interrupt
suffix:colon
id|uPD98402_int
comma
id|stop
suffix:colon
id|uPD98402_stop
comma
)brace
suffix:semicolon
DECL|function|uPD98402_init
r_int
id|__init
id|uPD98402_init
c_func
(paren
r_struct
id|atm_dev
op_star
id|dev
)paren
(brace
id|DPRINTK
c_func
(paren
l_string|&quot;phy_init&bslash;n&quot;
)paren
suffix:semicolon
id|dev-&gt;phy
op_assign
op_amp
id|uPD98402_ops
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#ifdef MODULE
DECL|variable|uPD98402_init
id|EXPORT_SYMBOL
c_func
(paren
id|uPD98402_init
)paren
suffix:semicolon
DECL|function|init_module
r_int
id|init_module
c_func
(paren
r_void
)paren
(brace
id|MOD_INC_USE_COUNT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|cleanup_module
r_void
id|cleanup_module
c_func
(paren
r_void
)paren
(brace
multiline_comment|/* Nay */
)brace
macro_line|#endif
eof
