multiline_comment|/* drivers/atm/zatm.c - ZeitNet ZN122x device driver */
multiline_comment|/* Written 1995-2000 by Werner Almesberger, EPFL LRC/ICA */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/mm.h&gt;
macro_line|#include &lt;linux/pci.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/atm.h&gt;
macro_line|#include &lt;linux/atmdev.h&gt;
macro_line|#include &lt;linux/sonet.h&gt;
macro_line|#include &lt;linux/skbuff.h&gt;
macro_line|#include &lt;linux/netdevice.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;linux/ioport.h&gt; /* for request_region */
macro_line|#include &lt;linux/uio.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/atm_zatm.h&gt;
macro_line|#include &lt;linux/capability.h&gt;
macro_line|#include &lt;linux/bitops.h&gt;
macro_line|#include &lt;asm/byteorder.h&gt;
macro_line|#include &lt;asm/system.h&gt;
macro_line|#include &lt;asm/string.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/atomic.h&gt;
macro_line|#include &lt;asm/uaccess.h&gt;
macro_line|#include &quot;uPD98401.h&quot;
macro_line|#include &quot;uPD98402.h&quot;
macro_line|#include &quot;zeprom.h&quot;
macro_line|#include &quot;zatm.h&quot;
multiline_comment|/*&n; * TODO:&n; *&n; * Minor features&n; *  - support 64 kB SDUs (will have to use multibuffer batches then :-( )&n; *  - proper use of CDV, credit = max(1,CDVT*PCR)&n; *  - AAL0&n; *  - better receive timestamps&n; *  - OAM&n; */
macro_line|#if 0
mdefine_line|#define DPRINTK(format,args...) printk(KERN_DEBUG format,##args)
macro_line|#else
DECL|macro|DPRINTK
mdefine_line|#define DPRINTK(format,args...)
macro_line|#endif
macro_line|#ifndef CONFIG_ATM_ZATM_DEBUG
DECL|macro|NULLCHECK
mdefine_line|#define NULLCHECK(x)
DECL|macro|EVENT
mdefine_line|#define EVENT(s,a,b)
DECL|function|event_dump
r_static
r_void
id|event_dump
c_func
(paren
r_void
)paren
(brace
)brace
macro_line|#else
multiline_comment|/* &n; * NULL pointer checking&n; */
DECL|macro|NULLCHECK
mdefine_line|#define NULLCHECK(x) &bslash;&n;  if ((unsigned long) (x) &lt; 0x30) printk(KERN_CRIT #x &quot;==0x%x&bslash;n&quot;, (int) (x))
multiline_comment|/*&n; * Very extensive activity logging. Greatly improves bug detection speed but&n; * costs a few Mbps if enabled.&n; */
DECL|macro|EV
mdefine_line|#define EV 64
DECL|variable|ev
r_static
r_const
r_char
op_star
id|ev
(braket
id|EV
)braket
suffix:semicolon
DECL|variable|ev_a
DECL|variable|ev_b
r_static
r_int
r_int
id|ev_a
(braket
id|EV
)braket
comma
id|ev_b
(braket
id|EV
)braket
suffix:semicolon
DECL|variable|ec
r_static
r_int
id|ec
op_assign
l_int|0
suffix:semicolon
DECL|function|EVENT
r_static
r_void
id|EVENT
c_func
(paren
r_const
r_char
op_star
id|s
comma
r_int
r_int
id|a
comma
r_int
r_int
id|b
)paren
(brace
id|ev
(braket
id|ec
)braket
op_assign
id|s
suffix:semicolon
id|ev_a
(braket
id|ec
)braket
op_assign
id|a
suffix:semicolon
id|ev_b
(braket
id|ec
)braket
op_assign
id|b
suffix:semicolon
id|ec
op_assign
(paren
id|ec
op_plus
l_int|1
)paren
op_mod
id|EV
suffix:semicolon
)brace
DECL|function|event_dump
r_static
r_void
id|event_dump
c_func
(paren
r_void
)paren
(brace
r_int
id|n
comma
id|i
suffix:semicolon
id|printk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;----- event dump follows -----&bslash;n&quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|n
op_assign
l_int|0
suffix:semicolon
id|n
OL
id|EV
suffix:semicolon
id|n
op_increment
)paren
(brace
id|i
op_assign
(paren
id|ec
op_plus
id|n
)paren
op_mod
id|EV
suffix:semicolon
id|printk
c_func
(paren
id|KERN_NOTICE
)paren
suffix:semicolon
id|printk
c_func
(paren
id|ev
(braket
id|i
)braket
ques
c_cond
id|ev
(braket
id|i
)braket
suffix:colon
l_string|&quot;(null)&quot;
comma
id|ev_a
(braket
id|i
)braket
comma
id|ev_b
(braket
id|i
)braket
)paren
suffix:semicolon
)brace
id|printk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;----- event dump ends here -----&bslash;n&quot;
)paren
suffix:semicolon
)brace
macro_line|#endif /* CONFIG_ATM_ZATM_DEBUG */
DECL|macro|RING_BUSY
mdefine_line|#define RING_BUSY&t;1&t;/* indication from do_tx that PDU has to be&n;&t;&t;&t;&t;   backlogged */
DECL|variable|zatm_boards
r_static
r_struct
id|atm_dev
op_star
id|zatm_boards
op_assign
l_int|NULL
suffix:semicolon
DECL|variable|dummy
r_static
r_int
r_int
id|dummy
(braket
l_int|2
)braket
op_assign
(brace
l_int|0
comma
l_int|0
)brace
suffix:semicolon
DECL|macro|zin_n
mdefine_line|#define zin_n(r) inl(zatm_dev-&gt;base+r*4)
DECL|macro|zin
mdefine_line|#define zin(r) inl(zatm_dev-&gt;base+uPD98401_##r*4)
DECL|macro|zout
mdefine_line|#define zout(v,r) outl(v,zatm_dev-&gt;base+uPD98401_##r*4)
DECL|macro|zwait
mdefine_line|#define zwait while (zin(CMR) &amp; uPD98401_BUSY)
multiline_comment|/* RX0, RX1, TX0, TX1 */
DECL|variable|mbx_entries
r_static
r_const
r_int
id|mbx_entries
(braket
id|NR_MBX
)braket
op_assign
(brace
l_int|1024
comma
l_int|1024
comma
l_int|1024
comma
l_int|1024
)brace
suffix:semicolon
DECL|variable|mbx_esize
r_static
r_const
r_int
id|mbx_esize
(braket
id|NR_MBX
)braket
op_assign
(brace
l_int|16
comma
l_int|16
comma
l_int|4
comma
l_int|4
)brace
suffix:semicolon
multiline_comment|/* entry size in bytes */
DECL|macro|MBX_SIZE
mdefine_line|#define MBX_SIZE(i) (mbx_entries[i]*mbx_esize[i])
multiline_comment|/*-------------------------------- utilities --------------------------------*/
DECL|function|zpokel
r_static
r_void
id|zpokel
c_func
(paren
r_struct
id|zatm_dev
op_star
id|zatm_dev
comma
id|u32
id|value
comma
id|u32
id|addr
)paren
(brace
id|zwait
suffix:semicolon
id|zout
c_func
(paren
id|value
comma
id|CER
)paren
suffix:semicolon
id|zout
c_func
(paren
id|uPD98401_IND_ACC
op_or
id|uPD98401_IA_BALL
op_or
(paren
id|uPD98401_IA_TGT_CM
op_lshift
id|uPD98401_IA_TGT_SHIFT
)paren
op_or
id|addr
comma
id|CMR
)paren
suffix:semicolon
)brace
DECL|function|zpeekl
r_static
id|u32
id|zpeekl
c_func
(paren
r_struct
id|zatm_dev
op_star
id|zatm_dev
comma
id|u32
id|addr
)paren
(brace
id|zwait
suffix:semicolon
id|zout
c_func
(paren
id|uPD98401_IND_ACC
op_or
id|uPD98401_IA_BALL
op_or
id|uPD98401_IA_RW
op_or
(paren
id|uPD98401_IA_TGT_CM
op_lshift
id|uPD98401_IA_TGT_SHIFT
)paren
op_or
id|addr
comma
id|CMR
)paren
suffix:semicolon
id|zwait
suffix:semicolon
r_return
id|zin
c_func
(paren
id|CER
)paren
suffix:semicolon
)brace
multiline_comment|/*------------------------------- free lists --------------------------------*/
multiline_comment|/*&n; * Free buffer head structure:&n; *   [0] pointer to buffer (for SAR)&n; *   [1] buffer descr link pointer (for SAR)&n; *   [2] back pointer to skb (for poll_rx)&n; *   [3] data&n; *   ...&n; */
DECL|struct|rx_buffer_head
r_struct
id|rx_buffer_head
(brace
DECL|member|buffer
id|u32
id|buffer
suffix:semicolon
multiline_comment|/* pointer to buffer (for SAR) */
DECL|member|link
id|u32
id|link
suffix:semicolon
multiline_comment|/* buffer descriptor link pointer (for SAR) */
DECL|member|skb
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
multiline_comment|/* back pointer to skb (for poll_rx) */
)brace
suffix:semicolon
DECL|function|refill_pool
r_static
r_void
id|refill_pool
c_func
(paren
r_struct
id|atm_dev
op_star
id|dev
comma
r_int
id|pool
)paren
(brace
r_struct
id|zatm_dev
op_star
id|zatm_dev
suffix:semicolon
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
r_struct
id|rx_buffer_head
op_star
id|first
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_int
id|align
comma
id|offset
comma
id|free
comma
id|count
comma
id|size
suffix:semicolon
id|EVENT
c_func
(paren
l_string|&quot;refill_pool&bslash;n&quot;
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
id|zatm_dev
op_assign
id|ZATM_DEV
c_func
(paren
id|dev
)paren
suffix:semicolon
id|size
op_assign
(paren
l_int|64
op_lshift
(paren
id|pool
op_le
id|ZATM_AAL5_POOL_BASE
ques
c_cond
l_int|0
suffix:colon
id|pool
op_minus
id|ZATM_AAL5_POOL_BASE
)paren
)paren
op_plus
r_sizeof
(paren
r_struct
id|rx_buffer_head
)paren
suffix:semicolon
r_if
c_cond
(paren
id|size
OL
id|PAGE_SIZE
)paren
(brace
id|align
op_assign
l_int|32
suffix:semicolon
multiline_comment|/* for 32 byte alignment */
id|offset
op_assign
r_sizeof
(paren
r_struct
id|rx_buffer_head
)paren
suffix:semicolon
)brace
r_else
(brace
id|align
op_assign
l_int|4096
suffix:semicolon
id|offset
op_assign
id|zatm_dev-&gt;pool_info
(braket
id|pool
)braket
dot
id|offset
op_plus
r_sizeof
(paren
r_struct
id|rx_buffer_head
)paren
suffix:semicolon
)brace
id|size
op_add_assign
id|align
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|free
op_assign
id|zpeekl
c_func
(paren
id|zatm_dev
comma
id|zatm_dev-&gt;pool_base
op_plus
l_int|2
op_star
id|pool
)paren
op_amp
id|uPD98401_RXFP_REMAIN
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|free
op_ge
id|zatm_dev-&gt;pool_info
(braket
id|pool
)braket
dot
id|low_water
)paren
r_return
suffix:semicolon
id|EVENT
c_func
(paren
l_string|&quot;starting ... POOL: 0x%x, 0x%x&bslash;n&quot;
comma
id|zpeekl
c_func
(paren
id|zatm_dev
comma
id|zatm_dev-&gt;pool_base
op_plus
l_int|2
op_star
id|pool
)paren
comma
id|zpeekl
c_func
(paren
id|zatm_dev
comma
id|zatm_dev-&gt;pool_base
op_plus
l_int|2
op_star
id|pool
op_plus
l_int|1
)paren
)paren
suffix:semicolon
id|EVENT
c_func
(paren
l_string|&quot;dummy: 0x%08lx, 0x%08lx&bslash;n&quot;
comma
id|dummy
(braket
l_int|0
)braket
comma
id|dummy
(braket
l_int|1
)braket
)paren
suffix:semicolon
id|count
op_assign
l_int|0
suffix:semicolon
id|first
op_assign
l_int|NULL
suffix:semicolon
r_while
c_loop
(paren
id|free
OL
id|zatm_dev-&gt;pool_info
(braket
id|pool
)braket
dot
id|high_water
)paren
(brace
r_struct
id|rx_buffer_head
op_star
id|head
suffix:semicolon
id|skb
op_assign
id|alloc_skb
c_func
(paren
id|size
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|skb
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
id|DEV_LABEL
l_string|&quot;(Itf %d): got no new &quot;
l_string|&quot;skb (%d) with %d free&bslash;n&quot;
comma
id|dev-&gt;number
comma
id|size
comma
id|free
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|skb_reserve
c_func
(paren
id|skb
comma
(paren
r_int
r_char
op_star
)paren
(paren
(paren
(paren
(paren
r_int
r_int
)paren
id|skb-&gt;data
op_plus
id|align
op_plus
id|offset
op_minus
l_int|1
)paren
op_amp
op_complement
(paren
r_int
r_int
)paren
(paren
id|align
op_minus
l_int|1
)paren
)paren
op_minus
id|offset
)paren
op_minus
id|skb-&gt;data
)paren
suffix:semicolon
id|head
op_assign
(paren
r_struct
id|rx_buffer_head
op_star
)paren
id|skb-&gt;data
suffix:semicolon
id|skb_reserve
c_func
(paren
id|skb
comma
r_sizeof
(paren
r_struct
id|rx_buffer_head
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|first
)paren
id|first
op_assign
id|head
suffix:semicolon
id|count
op_increment
suffix:semicolon
id|head-&gt;buffer
op_assign
id|virt_to_bus
c_func
(paren
id|skb-&gt;data
)paren
suffix:semicolon
id|head-&gt;link
op_assign
l_int|0
suffix:semicolon
id|head-&gt;skb
op_assign
id|skb
suffix:semicolon
id|EVENT
c_func
(paren
l_string|&quot;enq skb 0x%08lx/0x%08lx&bslash;n&quot;
comma
(paren
r_int
r_int
)paren
id|skb
comma
(paren
r_int
r_int
)paren
id|head
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|zatm_dev-&gt;last_free
(braket
id|pool
)braket
)paren
(paren
(paren
r_struct
id|rx_buffer_head
op_star
)paren
(paren
id|zatm_dev-&gt;last_free
(braket
id|pool
)braket
op_member_access_from_pointer
id|data
)paren
)paren
(braket
op_minus
l_int|1
)braket
dot
id|link
op_assign
id|virt_to_bus
c_func
(paren
id|head
)paren
suffix:semicolon
id|zatm_dev-&gt;last_free
(braket
id|pool
)braket
op_assign
id|skb
suffix:semicolon
id|skb_queue_tail
c_func
(paren
op_amp
id|zatm_dev-&gt;pool
(braket
id|pool
)braket
comma
id|skb
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|free
op_increment
suffix:semicolon
)brace
r_if
c_cond
(paren
id|first
)paren
(brace
id|cli
c_func
(paren
)paren
suffix:semicolon
id|zwait
suffix:semicolon
id|zout
c_func
(paren
id|virt_to_bus
c_func
(paren
id|first
)paren
comma
id|CER
)paren
suffix:semicolon
id|zout
c_func
(paren
id|uPD98401_ADD_BAT
op_or
(paren
id|pool
op_lshift
id|uPD98401_POOL_SHIFT
)paren
op_or
id|count
comma
id|CMR
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|EVENT
(paren
l_string|&quot;POOL: 0x%x, 0x%x&bslash;n&quot;
comma
id|zpeekl
c_func
(paren
id|zatm_dev
comma
id|zatm_dev-&gt;pool_base
op_plus
l_int|2
op_star
id|pool
)paren
comma
id|zpeekl
c_func
(paren
id|zatm_dev
comma
id|zatm_dev-&gt;pool_base
op_plus
l_int|2
op_star
id|pool
op_plus
l_int|1
)paren
)paren
suffix:semicolon
id|EVENT
c_func
(paren
l_string|&quot;dummy: 0x%08lx, 0x%08lx&bslash;n&quot;
comma
id|dummy
(braket
l_int|0
)braket
comma
id|dummy
(braket
l_int|1
)braket
)paren
suffix:semicolon
)brace
)brace
DECL|function|drain_free
r_static
r_void
id|drain_free
c_func
(paren
r_struct
id|atm_dev
op_star
id|dev
comma
r_int
id|pool
)paren
(brace
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
r_while
c_loop
(paren
(paren
id|skb
op_assign
id|skb_dequeue
c_func
(paren
op_amp
id|ZATM_DEV
c_func
(paren
id|dev
)paren
op_member_access_from_pointer
id|pool
(braket
id|pool
)braket
)paren
)paren
)paren
id|kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
)brace
DECL|function|pool_index
r_static
r_int
id|pool_index
c_func
(paren
r_int
id|max_pdu
)paren
(brace
r_int
id|i
suffix:semicolon
r_if
c_cond
(paren
id|max_pdu
op_mod
id|ATM_CELL_PAYLOAD
)paren
id|printk
c_func
(paren
id|KERN_ERR
id|DEV_LABEL
l_string|&quot;: driver error in pool_index: &quot;
l_string|&quot;max_pdu is %d&bslash;n&quot;
comma
id|max_pdu
)paren
suffix:semicolon
r_if
c_cond
(paren
id|max_pdu
OG
l_int|65536
)paren
r_return
op_minus
l_int|1
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
(paren
l_int|64
op_lshift
id|i
)paren
OL
id|max_pdu
suffix:semicolon
id|i
op_increment
)paren
suffix:semicolon
r_return
id|i
op_plus
id|ZATM_AAL5_POOL_BASE
suffix:semicolon
)brace
multiline_comment|/* use_pool isn&squot;t reentrant */
DECL|function|use_pool
r_static
r_void
id|use_pool
c_func
(paren
r_struct
id|atm_dev
op_star
id|dev
comma
r_int
id|pool
)paren
(brace
r_struct
id|zatm_dev
op_star
id|zatm_dev
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_int
id|size
suffix:semicolon
id|zatm_dev
op_assign
id|ZATM_DEV
c_func
(paren
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|zatm_dev-&gt;pool_info
(braket
id|pool
)braket
dot
id|ref_count
op_increment
)paren
)paren
(brace
id|skb_queue_head_init
c_func
(paren
op_amp
id|zatm_dev-&gt;pool
(braket
id|pool
)braket
)paren
suffix:semicolon
id|size
op_assign
id|pool
op_minus
id|ZATM_AAL5_POOL_BASE
suffix:semicolon
r_if
c_cond
(paren
id|size
OL
l_int|0
)paren
id|size
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* 64B... */
r_else
r_if
c_cond
(paren
id|size
OG
l_int|10
)paren
id|size
op_assign
l_int|10
suffix:semicolon
multiline_comment|/* ... 64kB */
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|zpokel
c_func
(paren
id|zatm_dev
comma
(paren
(paren
id|zatm_dev-&gt;pool_info
(braket
id|pool
)braket
dot
id|low_water
op_div
l_int|4
)paren
op_lshift
id|uPD98401_RXFP_ALERT_SHIFT
)paren
op_or
(paren
l_int|1
op_lshift
id|uPD98401_RXFP_BTSZ_SHIFT
)paren
op_or
(paren
id|size
op_lshift
id|uPD98401_RXFP_BFSZ_SHIFT
)paren
comma
id|zatm_dev-&gt;pool_base
op_plus
id|pool
op_star
l_int|2
)paren
suffix:semicolon
id|zpokel
c_func
(paren
id|zatm_dev
comma
(paren
r_int
r_int
)paren
id|dummy
comma
id|zatm_dev-&gt;pool_base
op_plus
id|pool
op_star
l_int|2
op_plus
l_int|1
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|zatm_dev-&gt;last_free
(braket
id|pool
)braket
op_assign
l_int|NULL
suffix:semicolon
id|refill_pool
c_func
(paren
id|dev
comma
id|pool
)paren
suffix:semicolon
)brace
id|DPRINTK
c_func
(paren
l_string|&quot;pool %d: %d&bslash;n&quot;
comma
id|pool
comma
id|zatm_dev-&gt;pool_info
(braket
id|pool
)braket
dot
id|ref_count
)paren
suffix:semicolon
)brace
DECL|function|unuse_pool
r_static
r_void
id|unuse_pool
c_func
(paren
r_struct
id|atm_dev
op_star
id|dev
comma
r_int
id|pool
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
(paren
op_decrement
id|ZATM_DEV
c_func
(paren
id|dev
)paren
op_member_access_from_pointer
id|pool_info
(braket
id|pool
)braket
dot
id|ref_count
)paren
)paren
id|drain_free
c_func
(paren
id|dev
comma
id|pool
)paren
suffix:semicolon
)brace
DECL|function|zatm_feedback
r_static
r_void
id|zatm_feedback
c_func
(paren
r_struct
id|atm_vcc
op_star
id|vcc
comma
r_struct
id|sk_buff
op_star
id|skb
comma
r_int
r_int
id|start
comma
r_int
r_int
id|dest
comma
r_int
id|len
)paren
(brace
r_struct
id|zatm_pool_info
op_star
id|pool
suffix:semicolon
r_int
r_int
id|offset
comma
id|flags
suffix:semicolon
id|DPRINTK
c_func
(paren
l_string|&quot;start 0x%08lx dest 0x%08lx len %d&bslash;n&quot;
comma
id|start
comma
id|dest
comma
id|len
)paren
suffix:semicolon
r_if
c_cond
(paren
id|len
OL
id|PAGE_SIZE
)paren
r_return
suffix:semicolon
id|pool
op_assign
op_amp
id|ZATM_DEV
c_func
(paren
id|vcc-&gt;dev
)paren
op_member_access_from_pointer
id|pool_info
(braket
id|ZATM_VCC
c_func
(paren
id|vcc
)paren
op_member_access_from_pointer
id|pool
)braket
suffix:semicolon
id|offset
op_assign
(paren
id|dest
op_minus
id|start
)paren
op_amp
(paren
id|PAGE_SIZE
op_minus
l_int|1
)paren
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|offset
op_logical_or
id|pool-&gt;offset
op_eq
id|offset
)paren
(brace
id|pool-&gt;next_cnt
op_assign
l_int|0
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|offset
op_ne
id|pool-&gt;next_off
)paren
(brace
id|pool-&gt;next_off
op_assign
id|offset
suffix:semicolon
id|pool-&gt;next_cnt
op_assign
l_int|0
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
op_increment
id|pool-&gt;next_cnt
op_ge
id|pool-&gt;next_thres
)paren
(brace
id|pool-&gt;offset
op_assign
id|pool-&gt;next_off
suffix:semicolon
id|pool-&gt;next_cnt
op_assign
l_int|0
suffix:semicolon
)brace
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
multiline_comment|/*----------------------- high-precision timestamps -------------------------*/
macro_line|#ifdef CONFIG_ATM_ZATM_EXACT_TS
DECL|variable|sync_timer
r_static
r_struct
id|timer_list
id|sync_timer
suffix:semicolon
multiline_comment|/*&n; * Note: the exact time is not normalized, i.e. tv_usec can be &gt; 1000000.&n; * This must be handled by higher layers.&n; */
DECL|function|exact_time
r_static
r_inline
r_struct
id|timeval
id|exact_time
c_func
(paren
r_struct
id|zatm_dev
op_star
id|zatm_dev
comma
id|u32
id|ticks
)paren
(brace
r_struct
id|timeval
id|tmp
suffix:semicolon
id|tmp
op_assign
id|zatm_dev-&gt;last_time
suffix:semicolon
id|tmp.tv_usec
op_add_assign
(paren
(paren
id|s64
)paren
(paren
id|ticks
op_minus
id|zatm_dev-&gt;last_clk
)paren
op_star
(paren
id|s64
)paren
id|zatm_dev-&gt;factor
)paren
op_rshift
id|TIMER_SHIFT
suffix:semicolon
r_return
id|tmp
suffix:semicolon
)brace
DECL|function|zatm_clock_sync
r_static
r_void
id|zatm_clock_sync
c_func
(paren
r_int
r_int
id|dummy
)paren
(brace
r_struct
id|atm_dev
op_star
id|atm_dev
suffix:semicolon
r_struct
id|zatm_dev
op_star
id|zatm_dev
suffix:semicolon
r_for
c_loop
(paren
id|atm_dev
op_assign
id|zatm_boards
suffix:semicolon
id|atm_dev
suffix:semicolon
id|atm_dev
op_assign
id|zatm_dev-&gt;more
)paren
(brace
r_int
r_int
id|flags
comma
id|interval
suffix:semicolon
r_int
id|diff
suffix:semicolon
r_struct
id|timeval
id|now
comma
id|expected
suffix:semicolon
id|u32
id|ticks
suffix:semicolon
id|zatm_dev
op_assign
id|ZATM_DEV
c_func
(paren
id|atm_dev
)paren
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|ticks
op_assign
id|zpeekl
c_func
(paren
id|zatm_dev
comma
id|uPD98401_TSR
)paren
suffix:semicolon
id|do_gettimeofday
c_func
(paren
op_amp
id|now
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|expected
op_assign
id|exact_time
c_func
(paren
id|zatm_dev
comma
id|ticks
)paren
suffix:semicolon
id|diff
op_assign
l_int|1000000
op_star
(paren
id|expected.tv_sec
op_minus
id|now.tv_sec
)paren
op_plus
(paren
id|expected.tv_usec
op_minus
id|now.tv_usec
)paren
suffix:semicolon
id|zatm_dev-&gt;timer_history
(braket
id|zatm_dev-&gt;th_curr
)braket
dot
id|real
op_assign
id|now
suffix:semicolon
id|zatm_dev-&gt;timer_history
(braket
id|zatm_dev-&gt;th_curr
)braket
dot
id|expected
op_assign
id|expected
suffix:semicolon
id|zatm_dev-&gt;th_curr
op_assign
(paren
id|zatm_dev-&gt;th_curr
op_plus
l_int|1
)paren
op_amp
(paren
id|ZATM_TIMER_HISTORY_SIZE
op_minus
l_int|1
)paren
suffix:semicolon
id|interval
op_assign
l_int|1000000
op_star
(paren
id|now.tv_sec
op_minus
id|zatm_dev-&gt;last_real_time.tv_sec
)paren
op_plus
(paren
id|now.tv_usec
op_minus
id|zatm_dev-&gt;last_real_time.tv_usec
)paren
suffix:semicolon
r_if
c_cond
(paren
id|diff
op_ge
op_minus
id|ADJ_REP_THRES
op_logical_and
id|diff
op_le
id|ADJ_REP_THRES
)paren
id|zatm_dev-&gt;timer_diffs
op_assign
l_int|0
suffix:semicolon
r_else
macro_line|#ifndef AGGRESSIVE_DEBUGGING
r_if
c_cond
(paren
op_increment
id|zatm_dev-&gt;timer_diffs
op_ge
id|ADJ_MSG_THRES
)paren
macro_line|#endif
(brace
id|zatm_dev-&gt;timer_diffs
op_assign
l_int|0
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
id|DEV_LABEL
l_string|&quot;: TSR update after %ld us:&quot;
l_string|&quot; calculation differed by %d us&bslash;n&quot;
comma
id|interval
comma
id|diff
)paren
suffix:semicolon
macro_line|#ifdef AGGRESSIVE_DEBUGGING
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;  %d.%08d -&gt; %d.%08d (%lu)&bslash;n&quot;
comma
id|zatm_dev-&gt;last_real_time.tv_sec
comma
id|zatm_dev-&gt;last_real_time.tv_usec
comma
id|now.tv_sec
comma
id|now.tv_usec
comma
id|interval
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;  %u -&gt; %u (%d)&bslash;n&quot;
comma
id|zatm_dev-&gt;last_clk
comma
id|ticks
comma
id|ticks
op_minus
id|zatm_dev-&gt;last_clk
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;  factor %u&bslash;n&quot;
comma
id|zatm_dev-&gt;factor
)paren
suffix:semicolon
macro_line|#endif
)brace
r_if
c_cond
(paren
id|diff
template_param
id|ADJ_IGN_THRES
)paren
(brace
multiline_comment|/* filter out any major changes (e.g. time zone setup and&n;&t;&t;       such) */
id|zatm_dev-&gt;last_time
op_assign
id|now
suffix:semicolon
id|zatm_dev-&gt;factor
op_assign
(paren
l_int|1000
op_lshift
id|TIMER_SHIFT
)paren
op_div
(paren
id|zatm_dev-&gt;khz
op_plus
l_int|1
)paren
suffix:semicolon
)brace
r_else
(brace
id|zatm_dev-&gt;last_time
op_assign
id|expected
suffix:semicolon
multiline_comment|/*&n;&t;&t;&t; * Is the accuracy of udelay really only about 1:300 on&n;&t;&t;&t; * a 90 MHz Pentium ? Well, the following line avoids&n;&t;&t;&t; * the problem, but ...&n;&t;&t;&t; *&n;&t;&t;&t; * What it does is simply:&n;&t;&t;&t; *&n;&t;&t;&t; * zatm_dev-&gt;factor = (interval &lt;&lt; TIMER_SHIFT)/&n;&t;&t;&t; *     (ticks-zatm_dev-&gt;last_clk);&n;&t;&t;&t; */
DECL|macro|S
mdefine_line|#define S(x) #x&t;&t;/* &quot;stringification&quot; ... */
DECL|macro|SX
mdefine_line|#define SX(x) S(x)
id|asm
c_func
(paren
l_string|&quot;movl %2,%%ebx&bslash;n&bslash;t&quot;
l_string|&quot;subl %3,%%ebx&bslash;n&bslash;t&quot;
l_string|&quot;xorl %%edx,%%edx&bslash;n&bslash;t&quot;
l_string|&quot;shldl $&quot;
id|SX
c_func
(paren
id|TIMER_SHIFT
)paren
l_string|&quot;,%1,%%edx&bslash;n&bslash;t&quot;
l_string|&quot;shl $&quot;
id|SX
c_func
(paren
id|TIMER_SHIFT
)paren
l_string|&quot;,%1&bslash;n&bslash;t&quot;
l_string|&quot;divl %%ebx&bslash;n&bslash;t&quot;
suffix:colon
l_string|&quot;=a&quot;
(paren
id|zatm_dev-&gt;factor
)paren
suffix:colon
l_string|&quot;0&quot;
(paren
id|interval
op_minus
id|diff
)paren
comma
l_string|&quot;g&quot;
(paren
id|ticks
)paren
comma
l_string|&quot;g&quot;
(paren
id|zatm_dev-&gt;last_clk
)paren
suffix:colon
l_string|&quot;ebx&quot;
comma
l_string|&quot;edx&quot;
comma
l_string|&quot;cc&quot;
)paren
suffix:semicolon
DECL|macro|S
macro_line|#undef S
DECL|macro|SX
macro_line|#undef SX
macro_line|#ifdef AGGRESSIVE_DEBUGGING
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;  (%ld &lt;&lt; %d)/(%u-%u) = %u&bslash;n&quot;
comma
id|interval
comma
id|TIMER_SHIFT
comma
id|ticks
comma
id|zatm_dev-&gt;last_clk
comma
id|zatm_dev-&gt;factor
)paren
suffix:semicolon
macro_line|#endif
)brace
id|zatm_dev-&gt;last_real_time
op_assign
id|now
suffix:semicolon
id|zatm_dev-&gt;last_clk
op_assign
id|ticks
suffix:semicolon
)brace
id|mod_timer
c_func
(paren
op_amp
id|sync_timer
comma
id|sync_timer.expires
op_plus
id|POLL_INTERVAL
op_star
id|HZ
)paren
suffix:semicolon
)brace
DECL|function|zatm_clock_init
r_static
r_void
id|__init
id|zatm_clock_init
c_func
(paren
r_struct
id|zatm_dev
op_star
id|zatm_dev
)paren
(brace
r_static
r_int
id|start_timer
op_assign
l_int|1
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|zatm_dev-&gt;factor
op_assign
(paren
l_int|1000
op_lshift
id|TIMER_SHIFT
)paren
op_div
(paren
id|zatm_dev-&gt;khz
op_plus
l_int|1
)paren
suffix:semicolon
id|zatm_dev-&gt;timer_diffs
op_assign
l_int|0
suffix:semicolon
id|memset
c_func
(paren
id|zatm_dev-&gt;timer_history
comma
l_int|0
comma
r_sizeof
(paren
id|zatm_dev-&gt;timer_history
)paren
)paren
suffix:semicolon
id|zatm_dev-&gt;th_curr
op_assign
l_int|0
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|do_gettimeofday
c_func
(paren
op_amp
id|zatm_dev-&gt;last_time
)paren
suffix:semicolon
id|zatm_dev-&gt;last_clk
op_assign
id|zpeekl
c_func
(paren
id|zatm_dev
comma
id|uPD98401_TSR
)paren
suffix:semicolon
r_if
c_cond
(paren
id|start_timer
)paren
(brace
id|start_timer
op_assign
l_int|0
suffix:semicolon
id|init_timer
c_func
(paren
op_amp
id|sync_timer
)paren
suffix:semicolon
id|sync_timer.expires
op_assign
id|jiffies
op_plus
id|POLL_INTERVAL
op_star
id|HZ
suffix:semicolon
id|sync_timer.function
op_assign
id|zatm_clock_sync
suffix:semicolon
id|add_timer
c_func
(paren
op_amp
id|sync_timer
)paren
suffix:semicolon
)brace
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
macro_line|#endif
multiline_comment|/*----------------------------------- RX ------------------------------------*/
macro_line|#if 0
r_static
r_void
id|exception
c_func
(paren
r_struct
id|atm_vcc
op_star
id|vcc
)paren
(brace
r_static
r_int
id|count
op_assign
l_int|0
suffix:semicolon
r_struct
id|zatm_dev
op_star
id|zatm_dev
op_assign
id|ZATM_DEV
c_func
(paren
id|vcc-&gt;dev
)paren
suffix:semicolon
r_struct
id|zatm_vcc
op_star
id|zatm_vcc
op_assign
id|ZATM_VCC
c_func
(paren
id|vcc
)paren
suffix:semicolon
r_int
r_int
op_star
id|qrp
suffix:semicolon
r_int
id|i
suffix:semicolon
r_if
c_cond
(paren
id|count
op_increment
OG
l_int|2
)paren
r_return
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|8
suffix:semicolon
id|i
op_increment
)paren
id|printk
c_func
(paren
l_string|&quot;TX%d: 0x%08lx&bslash;n&quot;
comma
id|i
comma
id|zpeekl
c_func
(paren
id|zatm_dev
comma
id|zatm_vcc-&gt;tx_chan
op_star
id|VC_SIZE
op_div
l_int|4
op_plus
id|i
)paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|5
suffix:semicolon
id|i
op_increment
)paren
id|printk
c_func
(paren
l_string|&quot;SH%d: 0x%08lx&bslash;n&quot;
comma
id|i
comma
id|zpeekl
c_func
(paren
id|zatm_dev
comma
id|uPD98401_IM
c_func
(paren
id|zatm_vcc-&gt;shaper
)paren
op_plus
l_int|16
op_star
id|i
)paren
)paren
suffix:semicolon
id|qrp
op_assign
(paren
r_int
r_int
op_star
)paren
id|zpeekl
c_func
(paren
id|zatm_dev
comma
id|zatm_vcc-&gt;tx_chan
op_star
id|VC_SIZE
op_div
l_int|4
op_plus
id|uPD98401_TXVC_QRP
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;qrp=0x%08lx&bslash;n&quot;
comma
(paren
r_int
r_int
)paren
id|qrp
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|4
suffix:semicolon
id|i
op_increment
)paren
id|printk
c_func
(paren
l_string|&quot;QRP[%d]: 0x%08lx&quot;
comma
id|i
comma
id|qrp
(braket
id|i
)braket
)paren
suffix:semicolon
)brace
macro_line|#endif
DECL|variable|err_txt
r_static
r_const
r_char
op_star
id|err_txt
(braket
)braket
op_assign
(brace
l_string|&quot;No error&quot;
comma
l_string|&quot;RX buf underflow&quot;
comma
l_string|&quot;RX FIFO overrun&quot;
comma
l_string|&quot;Maximum len violation&quot;
comma
l_string|&quot;CRC error&quot;
comma
l_string|&quot;User abort&quot;
comma
l_string|&quot;Length violation&quot;
comma
l_string|&quot;T1 error&quot;
comma
l_string|&quot;Deactivated&quot;
comma
l_string|&quot;???&quot;
comma
l_string|&quot;???&quot;
comma
l_string|&quot;???&quot;
comma
l_string|&quot;???&quot;
comma
l_string|&quot;???&quot;
comma
l_string|&quot;???&quot;
comma
l_string|&quot;???&quot;
)brace
suffix:semicolon
DECL|function|poll_rx
r_static
r_void
id|poll_rx
c_func
(paren
r_struct
id|atm_dev
op_star
id|dev
comma
r_int
id|mbx
)paren
(brace
r_struct
id|zatm_dev
op_star
id|zatm_dev
suffix:semicolon
r_int
r_int
id|pos
suffix:semicolon
id|u32
id|x
suffix:semicolon
r_int
id|error
suffix:semicolon
id|EVENT
c_func
(paren
l_string|&quot;poll_rx&bslash;n&quot;
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
id|zatm_dev
op_assign
id|ZATM_DEV
c_func
(paren
id|dev
)paren
suffix:semicolon
id|pos
op_assign
(paren
id|zatm_dev-&gt;mbx_start
(braket
id|mbx
)braket
op_amp
op_complement
l_int|0xffffUL
)paren
op_or
id|zin
c_func
(paren
id|MTA
c_func
(paren
id|mbx
)paren
)paren
suffix:semicolon
r_while
c_loop
(paren
id|x
op_assign
id|zin
c_func
(paren
id|MWA
c_func
(paren
id|mbx
)paren
)paren
comma
(paren
id|pos
op_amp
l_int|0xffff
)paren
op_ne
id|x
)paren
(brace
id|u32
op_star
id|here
suffix:semicolon
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
r_struct
id|atm_vcc
op_star
id|vcc
suffix:semicolon
r_int
id|cells
comma
id|size
comma
id|chan
suffix:semicolon
id|EVENT
c_func
(paren
l_string|&quot;MBX: host 0x%lx, nic 0x%x&bslash;n&quot;
comma
id|pos
comma
id|x
)paren
suffix:semicolon
id|here
op_assign
(paren
id|u32
op_star
)paren
id|pos
suffix:semicolon
r_if
c_cond
(paren
(paren
(paren
id|pos
op_add_assign
l_int|16
)paren
op_amp
l_int|0xffff
)paren
op_eq
id|zatm_dev-&gt;mbx_end
(braket
id|mbx
)braket
)paren
id|pos
op_assign
id|zatm_dev-&gt;mbx_start
(braket
id|mbx
)braket
suffix:semicolon
id|cells
op_assign
id|here
(braket
l_int|0
)braket
op_amp
id|uPD98401_AAL5_SIZE
suffix:semicolon
macro_line|#if 0
id|printk
c_func
(paren
l_string|&quot;RX IND: 0x%x, 0x%x, 0x%x, 0x%x&bslash;n&quot;
comma
id|here
(braket
l_int|0
)braket
comma
id|here
(braket
l_int|1
)braket
comma
id|here
(braket
l_int|2
)braket
comma
id|here
(braket
l_int|3
)braket
)paren
suffix:semicolon
(brace
r_int
r_int
op_star
id|x
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;POOL: 0x%08x, 0x%08x&bslash;n&quot;
comma
id|zpeekl
c_func
(paren
id|zatm_dev
comma
id|zatm_dev-&gt;pool_base
)paren
comma
id|zpeekl
c_func
(paren
id|zatm_dev
comma
id|zatm_dev-&gt;pool_base
op_plus
l_int|1
)paren
)paren
suffix:semicolon
id|x
op_assign
(paren
r_int
r_int
op_star
)paren
id|here
(braket
l_int|2
)braket
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;[0..3] = 0x%08lx, 0x%08lx, 0x%08lx, 0x%08lx&bslash;n&quot;
comma
id|x
(braket
l_int|0
)braket
comma
id|x
(braket
l_int|1
)braket
comma
id|x
(braket
l_int|2
)braket
comma
id|x
(braket
l_int|3
)braket
)paren
suffix:semicolon
)brace
macro_line|#endif
id|error
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|here
(braket
l_int|3
)braket
op_amp
id|uPD98401_AAL5_ERR
)paren
(brace
id|error
op_assign
(paren
id|here
(braket
l_int|3
)braket
op_amp
id|uPD98401_AAL5_ES
)paren
op_rshift
id|uPD98401_AAL5_ES_SHIFT
suffix:semicolon
r_if
c_cond
(paren
id|error
op_eq
id|uPD98401_AAL5_ES_DEACT
op_logical_or
id|error
op_eq
id|uPD98401_AAL5_ES_FREE
)paren
r_continue
suffix:semicolon
)brace
id|EVENT
c_func
(paren
l_string|&quot;error code 0x%x/0x%x&bslash;n&quot;
comma
(paren
id|here
(braket
l_int|3
)braket
op_amp
id|uPD98401_AAL5_ES
)paren
op_rshift
id|uPD98401_AAL5_ES_SHIFT
comma
id|error
)paren
suffix:semicolon
id|skb
op_assign
(paren
(paren
r_struct
id|rx_buffer_head
op_star
)paren
id|bus_to_virt
c_func
(paren
id|here
(braket
l_int|2
)braket
)paren
)paren
op_member_access_from_pointer
id|skb
suffix:semicolon
macro_line|#ifdef CONFIG_ATM_ZATM_EXACT_TS
id|skb-&gt;stamp
op_assign
id|exact_time
c_func
(paren
id|zatm_dev
comma
id|here
(braket
l_int|1
)braket
)paren
suffix:semicolon
macro_line|#else
id|skb-&gt;stamp
op_assign
id|xtime
suffix:semicolon
macro_line|#endif
macro_line|#if 0
id|printk
c_func
(paren
l_string|&quot;[-3..0] 0x%08lx 0x%08lx 0x%08lx 0x%08lx&bslash;n&quot;
comma
(paren
(paren
r_int
op_star
)paren
id|skb-&gt;data
)paren
(braket
op_minus
l_int|3
)braket
comma
(paren
(paren
r_int
op_star
)paren
id|skb-&gt;data
)paren
(braket
op_minus
l_int|2
)braket
comma
(paren
(paren
r_int
op_star
)paren
id|skb-&gt;data
)paren
(braket
op_minus
l_int|1
)braket
comma
(paren
(paren
r_int
op_star
)paren
id|skb-&gt;data
)paren
(braket
l_int|0
)braket
)paren
suffix:semicolon
macro_line|#endif
id|EVENT
c_func
(paren
l_string|&quot;skb 0x%lx, here 0x%lx&bslash;n&quot;
comma
(paren
r_int
r_int
)paren
id|skb
comma
(paren
r_int
r_int
)paren
id|here
)paren
suffix:semicolon
macro_line|#if 0
id|printk
c_func
(paren
l_string|&quot;dummy: 0x%08lx, 0x%08lx&bslash;n&quot;
comma
id|dummy
(braket
l_int|0
)braket
comma
id|dummy
(braket
l_int|1
)braket
)paren
suffix:semicolon
macro_line|#endif
id|size
op_assign
id|error
ques
c_cond
l_int|0
suffix:colon
id|ntohs
c_func
(paren
(paren
(paren
id|u16
op_star
)paren
id|skb-&gt;data
)paren
(braket
id|cells
op_star
id|ATM_CELL_PAYLOAD
op_div
r_sizeof
(paren
id|u16
)paren
op_minus
l_int|3
)braket
)paren
suffix:semicolon
id|EVENT
c_func
(paren
l_string|&quot;got skb 0x%lx, size %d&bslash;n&quot;
comma
(paren
r_int
r_int
)paren
id|skb
comma
id|size
)paren
suffix:semicolon
id|chan
op_assign
(paren
id|here
(braket
l_int|3
)braket
op_amp
id|uPD98401_AAL5_CHAN
)paren
op_rshift
id|uPD98401_AAL5_CHAN_SHIFT
suffix:semicolon
r_if
c_cond
(paren
id|chan
OL
id|zatm_dev-&gt;chans
op_logical_and
id|zatm_dev-&gt;rx_map
(braket
id|chan
)braket
)paren
(brace
id|vcc
op_assign
id|zatm_dev-&gt;rx_map
(braket
id|chan
)braket
suffix:semicolon
r_if
c_cond
(paren
id|skb
op_eq
id|zatm_dev-&gt;last_free
(braket
id|ZATM_VCC
c_func
(paren
id|vcc
)paren
op_member_access_from_pointer
id|pool
)braket
)paren
id|zatm_dev-&gt;last_free
(braket
id|ZATM_VCC
c_func
(paren
id|vcc
)paren
op_member_access_from_pointer
id|pool
)braket
op_assign
l_int|NULL
suffix:semicolon
id|skb_unlink
c_func
(paren
id|skb
)paren
suffix:semicolon
)brace
r_else
(brace
id|printk
c_func
(paren
id|KERN_ERR
id|DEV_LABEL
l_string|&quot;(itf %d): RX indication &quot;
l_string|&quot;for non-existing channel&bslash;n&quot;
comma
id|dev-&gt;number
)paren
suffix:semicolon
id|size
op_assign
l_int|0
suffix:semicolon
id|vcc
op_assign
l_int|NULL
suffix:semicolon
id|event_dump
c_func
(paren
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|error
)paren
(brace
r_static
r_int
r_int
id|silence
op_assign
l_int|0
suffix:semicolon
r_static
r_int
id|last_error
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|error
op_ne
id|last_error
op_logical_or
id|time_after
c_func
(paren
id|jiffies
comma
id|silence
)paren
op_logical_or
id|silence
op_eq
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
id|DEV_LABEL
l_string|&quot;(itf %d): &quot;
l_string|&quot;chan %d error %s&bslash;n&quot;
comma
id|dev-&gt;number
comma
id|chan
comma
id|err_txt
(braket
id|error
)braket
)paren
suffix:semicolon
id|last_error
op_assign
id|error
suffix:semicolon
id|silence
op_assign
(paren
id|jiffies
op_plus
l_int|2
op_star
id|HZ
)paren
op_or
l_int|1
suffix:semicolon
)brace
id|size
op_assign
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|size
op_logical_and
(paren
id|size
OG
id|cells
op_star
id|ATM_CELL_PAYLOAD
op_minus
id|ATM_AAL5_TRAILER
op_logical_or
id|size
op_le
(paren
id|cells
op_minus
l_int|1
)paren
op_star
id|ATM_CELL_PAYLOAD
op_minus
id|ATM_AAL5_TRAILER
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
id|DEV_LABEL
l_string|&quot;(itf %d): size %d with %d &quot;
l_string|&quot;cells&bslash;n&quot;
comma
id|dev-&gt;number
comma
id|size
comma
id|cells
)paren
suffix:semicolon
id|size
op_assign
l_int|0
suffix:semicolon
id|event_dump
c_func
(paren
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|size
OG
id|ATM_MAX_AAL5_PDU
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
id|DEV_LABEL
l_string|&quot;(itf %d): size too big &quot;
l_string|&quot;(%d)&bslash;n&quot;
comma
id|dev-&gt;number
comma
id|size
)paren
suffix:semicolon
id|size
op_assign
l_int|0
suffix:semicolon
id|event_dump
c_func
(paren
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|size
)paren
(brace
id|dev_kfree_skb_irq
c_func
(paren
id|skb
)paren
suffix:semicolon
r_if
c_cond
(paren
id|vcc
)paren
id|atomic_inc
c_func
(paren
op_amp
id|vcc-&gt;stats-&gt;rx_err
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|atm_charge
c_func
(paren
id|vcc
comma
id|skb-&gt;truesize
)paren
)paren
(brace
id|dev_kfree_skb_irq
c_func
(paren
id|skb
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
id|skb-&gt;len
op_assign
id|size
suffix:semicolon
id|ATM_SKB
c_func
(paren
id|skb
)paren
op_member_access_from_pointer
id|vcc
op_assign
id|vcc
suffix:semicolon
id|vcc
op_member_access_from_pointer
id|push
c_func
(paren
id|vcc
comma
id|skb
)paren
suffix:semicolon
id|atomic_inc
c_func
(paren
op_amp
id|vcc-&gt;stats-&gt;rx
)paren
suffix:semicolon
)brace
id|zout
c_func
(paren
id|pos
op_amp
l_int|0xffff
comma
id|MTA
c_func
(paren
id|mbx
)paren
)paren
suffix:semicolon
macro_line|#if 0 /* probably a stupid idea */
id|refill_pool
c_func
(paren
id|dev
comma
id|zatm_vcc-&gt;pool
)paren
suffix:semicolon
multiline_comment|/* maybe this saves us a few interrupts */
macro_line|#endif
)brace
DECL|function|open_rx_first
r_static
r_int
id|open_rx_first
c_func
(paren
r_struct
id|atm_vcc
op_star
id|vcc
)paren
(brace
r_struct
id|zatm_dev
op_star
id|zatm_dev
suffix:semicolon
r_struct
id|zatm_vcc
op_star
id|zatm_vcc
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_int
r_int
id|chan
suffix:semicolon
r_int
id|cells
suffix:semicolon
id|DPRINTK
c_func
(paren
l_string|&quot;open_rx_first (0x%x)&bslash;n&quot;
comma
id|inb_p
c_func
(paren
l_int|0xc053
)paren
)paren
suffix:semicolon
id|zatm_dev
op_assign
id|ZATM_DEV
c_func
(paren
id|vcc-&gt;dev
)paren
suffix:semicolon
id|zatm_vcc
op_assign
id|ZATM_VCC
c_func
(paren
id|vcc
)paren
suffix:semicolon
id|zatm_vcc-&gt;rx_chan
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|vcc-&gt;qos.rxtp.traffic_class
op_eq
id|ATM_NONE
)paren
r_return
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|vcc-&gt;qos.aal
op_eq
id|ATM_AAL5
)paren
(brace
r_if
c_cond
(paren
id|vcc-&gt;qos.rxtp.max_sdu
OG
l_int|65464
)paren
id|vcc-&gt;qos.rxtp.max_sdu
op_assign
l_int|65464
suffix:semicolon
multiline_comment|/* fix this - we may want to receive 64kB SDUs&n;&t;&t;&t;   later */
id|cells
op_assign
(paren
id|vcc-&gt;qos.rxtp.max_sdu
op_plus
id|ATM_AAL5_TRAILER
op_plus
id|ATM_CELL_PAYLOAD
op_minus
l_int|1
)paren
op_div
id|ATM_CELL_PAYLOAD
suffix:semicolon
id|zatm_vcc-&gt;pool
op_assign
id|pool_index
c_func
(paren
id|cells
op_star
id|ATM_CELL_PAYLOAD
)paren
suffix:semicolon
)brace
r_else
(brace
id|cells
op_assign
l_int|1
suffix:semicolon
id|zatm_vcc-&gt;pool
op_assign
id|ZATM_AAL0_POOL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|zatm_vcc-&gt;pool
OL
l_int|0
)paren
r_return
op_minus
id|EMSGSIZE
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|zwait
suffix:semicolon
id|zout
c_func
(paren
id|uPD98401_OPEN_CHAN
comma
id|CMR
)paren
suffix:semicolon
id|zwait
suffix:semicolon
id|DPRINTK
c_func
(paren
l_string|&quot;0x%x 0x%x&bslash;n&quot;
comma
id|zin
c_func
(paren
id|CMR
)paren
comma
id|zin
c_func
(paren
id|CER
)paren
)paren
suffix:semicolon
id|chan
op_assign
(paren
id|zin
c_func
(paren
id|CMR
)paren
op_amp
id|uPD98401_CHAN_ADDR
)paren
op_rshift
id|uPD98401_CHAN_ADDR_SHIFT
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|DPRINTK
c_func
(paren
l_string|&quot;chan is %d&bslash;n&quot;
comma
id|chan
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|chan
)paren
r_return
op_minus
id|EAGAIN
suffix:semicolon
id|use_pool
c_func
(paren
id|vcc-&gt;dev
comma
id|zatm_vcc-&gt;pool
)paren
suffix:semicolon
id|DPRINTK
c_func
(paren
l_string|&quot;pool %d&bslash;n&quot;
comma
id|zatm_vcc-&gt;pool
)paren
suffix:semicolon
multiline_comment|/* set up VC descriptor */
id|cli
c_func
(paren
)paren
suffix:semicolon
id|zpokel
c_func
(paren
id|zatm_dev
comma
id|zatm_vcc-&gt;pool
op_lshift
id|uPD98401_RXVC_POOL_SHIFT
comma
id|chan
op_star
id|VC_SIZE
op_div
l_int|4
)paren
suffix:semicolon
id|zpokel
c_func
(paren
id|zatm_dev
comma
id|uPD98401_RXVC_OD
op_or
(paren
id|vcc-&gt;qos.aal
op_eq
id|ATM_AAL5
ques
c_cond
id|uPD98401_RXVC_AR
suffix:colon
l_int|0
)paren
op_or
id|cells
comma
id|chan
op_star
id|VC_SIZE
op_div
l_int|4
op_plus
l_int|1
)paren
suffix:semicolon
id|zpokel
c_func
(paren
id|zatm_dev
comma
l_int|0
comma
id|chan
op_star
id|VC_SIZE
op_div
l_int|4
op_plus
l_int|2
)paren
suffix:semicolon
id|zatm_vcc-&gt;rx_chan
op_assign
id|chan
suffix:semicolon
id|zatm_dev-&gt;rx_map
(braket
id|chan
)braket
op_assign
id|vcc
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|open_rx_second
r_static
r_int
id|open_rx_second
c_func
(paren
r_struct
id|atm_vcc
op_star
id|vcc
)paren
(brace
r_struct
id|zatm_dev
op_star
id|zatm_dev
suffix:semicolon
r_struct
id|zatm_vcc
op_star
id|zatm_vcc
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_int
id|pos
comma
id|shift
suffix:semicolon
id|DPRINTK
c_func
(paren
l_string|&quot;open_rx_second (0x%x)&bslash;n&quot;
comma
id|inb_p
c_func
(paren
l_int|0xc053
)paren
)paren
suffix:semicolon
id|zatm_dev
op_assign
id|ZATM_DEV
c_func
(paren
id|vcc-&gt;dev
)paren
suffix:semicolon
id|zatm_vcc
op_assign
id|ZATM_VCC
c_func
(paren
id|vcc
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|zatm_vcc-&gt;rx_chan
)paren
r_return
l_int|0
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* should also handle VPI @@@ */
id|pos
op_assign
id|vcc-&gt;vci
op_rshift
l_int|1
suffix:semicolon
id|shift
op_assign
(paren
l_int|1
op_minus
(paren
id|vcc-&gt;vci
op_amp
l_int|1
)paren
)paren
op_lshift
l_int|4
suffix:semicolon
id|zpokel
c_func
(paren
id|zatm_dev
comma
(paren
id|zpeekl
c_func
(paren
id|zatm_dev
comma
id|pos
)paren
op_amp
op_complement
(paren
l_int|0xffff
op_lshift
id|shift
)paren
)paren
op_or
(paren
(paren
id|zatm_vcc-&gt;rx_chan
op_or
id|uPD98401_RXLT_ENBL
)paren
op_lshift
id|shift
)paren
comma
id|pos
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|close_rx
r_static
r_void
id|close_rx
c_func
(paren
r_struct
id|atm_vcc
op_star
id|vcc
)paren
(brace
r_struct
id|zatm_dev
op_star
id|zatm_dev
suffix:semicolon
r_struct
id|zatm_vcc
op_star
id|zatm_vcc
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_int
id|pos
comma
id|shift
suffix:semicolon
id|zatm_vcc
op_assign
id|ZATM_VCC
c_func
(paren
id|vcc
)paren
suffix:semicolon
id|zatm_dev
op_assign
id|ZATM_DEV
c_func
(paren
id|vcc-&gt;dev
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|zatm_vcc-&gt;rx_chan
)paren
r_return
suffix:semicolon
id|DPRINTK
c_func
(paren
l_string|&quot;close_rx&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* disable receiver */
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|vcc-&gt;vpi
op_ne
id|ATM_VPI_UNSPEC
op_logical_and
id|vcc-&gt;vci
op_ne
id|ATM_VCI_UNSPEC
)paren
(brace
id|cli
c_func
(paren
)paren
suffix:semicolon
id|pos
op_assign
id|vcc-&gt;vci
op_rshift
l_int|1
suffix:semicolon
id|shift
op_assign
(paren
l_int|1
op_minus
(paren
id|vcc-&gt;vci
op_amp
l_int|1
)paren
)paren
op_lshift
l_int|4
suffix:semicolon
id|zpokel
c_func
(paren
id|zatm_dev
comma
id|zpeekl
c_func
(paren
id|zatm_dev
comma
id|pos
)paren
op_amp
op_complement
(paren
l_int|0xffff
op_lshift
id|shift
)paren
comma
id|pos
)paren
suffix:semicolon
id|zwait
suffix:semicolon
id|zout
c_func
(paren
id|uPD98401_NOP
comma
id|CMR
)paren
suffix:semicolon
id|zwait
suffix:semicolon
id|zout
c_func
(paren
id|uPD98401_NOP
comma
id|CMR
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
id|cli
c_func
(paren
)paren
suffix:semicolon
id|zwait
suffix:semicolon
id|zout
c_func
(paren
id|uPD98401_DEACT_CHAN
op_or
id|uPD98401_CHAN_RT
op_or
(paren
id|zatm_vcc-&gt;rx_chan
op_lshift
id|uPD98401_CHAN_ADDR_SHIFT
)paren
comma
id|CMR
)paren
suffix:semicolon
id|zwait
suffix:semicolon
id|udelay
c_func
(paren
l_int|10
)paren
suffix:semicolon
multiline_comment|/* why oh why ... ? */
id|zout
c_func
(paren
id|uPD98401_CLOSE_CHAN
op_or
id|uPD98401_CHAN_RT
op_or
(paren
id|zatm_vcc-&gt;rx_chan
op_lshift
id|uPD98401_CHAN_ADDR_SHIFT
)paren
comma
id|CMR
)paren
suffix:semicolon
id|zwait
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|zin
c_func
(paren
id|CMR
)paren
op_amp
id|uPD98401_CHAN_ADDR
)paren
)paren
id|printk
c_func
(paren
id|KERN_CRIT
id|DEV_LABEL
l_string|&quot;(itf %d): can&squot;t close RX channel &quot;
l_string|&quot;%d&bslash;n&quot;
comma
id|vcc-&gt;dev-&gt;number
comma
id|zatm_vcc-&gt;rx_chan
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|zatm_dev-&gt;rx_map
(braket
id|zatm_vcc-&gt;rx_chan
)braket
op_assign
l_int|NULL
suffix:semicolon
id|zatm_vcc-&gt;rx_chan
op_assign
l_int|0
suffix:semicolon
id|unuse_pool
c_func
(paren
id|vcc-&gt;dev
comma
id|zatm_vcc-&gt;pool
)paren
suffix:semicolon
)brace
DECL|function|start_rx
r_static
r_int
id|start_rx
c_func
(paren
r_struct
id|atm_dev
op_star
id|dev
)paren
(brace
r_struct
id|zatm_dev
op_star
id|zatm_dev
suffix:semicolon
r_int
id|size
comma
id|i
suffix:semicolon
id|DPRINTK
c_func
(paren
l_string|&quot;start_rx&bslash;n&quot;
)paren
suffix:semicolon
id|zatm_dev
op_assign
id|ZATM_DEV
c_func
(paren
id|dev
)paren
suffix:semicolon
id|size
op_assign
r_sizeof
(paren
r_struct
id|atm_vcc
op_star
)paren
op_star
id|zatm_dev-&gt;chans
suffix:semicolon
id|zatm_dev-&gt;rx_map
op_assign
(paren
r_struct
id|atm_vcc
op_star
op_star
)paren
id|kmalloc
c_func
(paren
id|size
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|zatm_dev-&gt;rx_map
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|memset
c_func
(paren
id|zatm_dev-&gt;rx_map
comma
l_int|0
comma
id|size
)paren
suffix:semicolon
multiline_comment|/* set VPI/VCI split (use all VCIs and give what&squot;s left to VPIs) */
id|zpokel
c_func
(paren
id|zatm_dev
comma
(paren
l_int|1
op_lshift
id|dev-&gt;ci_range.vci_bits
)paren
op_minus
l_int|1
comma
id|uPD98401_VRR
)paren
suffix:semicolon
multiline_comment|/* prepare free buffer pools */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
op_le
id|ZATM_LAST_POOL
suffix:semicolon
id|i
op_increment
)paren
(brace
id|zatm_dev-&gt;pool_info
(braket
id|i
)braket
dot
id|ref_count
op_assign
l_int|0
suffix:semicolon
id|zatm_dev-&gt;pool_info
(braket
id|i
)braket
dot
id|rqa_count
op_assign
l_int|0
suffix:semicolon
id|zatm_dev-&gt;pool_info
(braket
id|i
)braket
dot
id|rqu_count
op_assign
l_int|0
suffix:semicolon
id|zatm_dev-&gt;pool_info
(braket
id|i
)braket
dot
id|low_water
op_assign
id|LOW_MARK
suffix:semicolon
id|zatm_dev-&gt;pool_info
(braket
id|i
)braket
dot
id|high_water
op_assign
id|HIGH_MARK
suffix:semicolon
id|zatm_dev-&gt;pool_info
(braket
id|i
)braket
dot
id|offset
op_assign
l_int|0
suffix:semicolon
id|zatm_dev-&gt;pool_info
(braket
id|i
)braket
dot
id|next_off
op_assign
l_int|0
suffix:semicolon
id|zatm_dev-&gt;pool_info
(braket
id|i
)braket
dot
id|next_cnt
op_assign
l_int|0
suffix:semicolon
id|zatm_dev-&gt;pool_info
(braket
id|i
)braket
dot
id|next_thres
op_assign
id|OFF_CNG_THRES
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*----------------------------------- TX ------------------------------------*/
DECL|function|do_tx
r_static
r_int
id|do_tx
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
)paren
(brace
r_struct
id|atm_vcc
op_star
id|vcc
suffix:semicolon
r_struct
id|zatm_dev
op_star
id|zatm_dev
suffix:semicolon
r_struct
id|zatm_vcc
op_star
id|zatm_vcc
suffix:semicolon
id|u32
op_star
id|dsc
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|EVENT
c_func
(paren
l_string|&quot;do_tx&bslash;n&quot;
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
id|DPRINTK
c_func
(paren
l_string|&quot;sending skb %p&bslash;n&quot;
comma
id|skb
)paren
suffix:semicolon
id|vcc
op_assign
id|ATM_SKB
c_func
(paren
id|skb
)paren
op_member_access_from_pointer
id|vcc
suffix:semicolon
id|zatm_dev
op_assign
id|ZATM_DEV
c_func
(paren
id|vcc-&gt;dev
)paren
suffix:semicolon
id|zatm_vcc
op_assign
id|ZATM_VCC
c_func
(paren
id|vcc
)paren
suffix:semicolon
id|EVENT
c_func
(paren
l_string|&quot;iovcnt=%d&bslash;n&quot;
comma
id|ATM_SKB
c_func
(paren
id|skb
)paren
op_member_access_from_pointer
id|iovcnt
comma
l_int|0
)paren
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ATM_SKB
c_func
(paren
id|skb
)paren
op_member_access_from_pointer
id|iovcnt
)paren
(brace
r_if
c_cond
(paren
id|zatm_vcc-&gt;txing
op_eq
id|RING_ENTRIES
op_minus
l_int|1
)paren
(brace
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
id|RING_BUSY
suffix:semicolon
)brace
id|zatm_vcc-&gt;txing
op_increment
suffix:semicolon
id|dsc
op_assign
id|zatm_vcc-&gt;ring
op_plus
id|zatm_vcc-&gt;ring_curr
suffix:semicolon
id|zatm_vcc-&gt;ring_curr
op_assign
(paren
id|zatm_vcc-&gt;ring_curr
op_plus
id|RING_WORDS
)paren
op_amp
(paren
id|RING_ENTRIES
op_star
id|RING_WORDS
op_minus
l_int|1
)paren
suffix:semicolon
id|dsc
(braket
l_int|1
)braket
op_assign
l_int|0
suffix:semicolon
id|dsc
(braket
l_int|2
)braket
op_assign
id|skb-&gt;len
suffix:semicolon
id|dsc
(braket
l_int|3
)braket
op_assign
id|virt_to_bus
c_func
(paren
id|skb-&gt;data
)paren
suffix:semicolon
id|mb
c_func
(paren
)paren
suffix:semicolon
id|dsc
(braket
l_int|0
)braket
op_assign
id|uPD98401_TXPD_V
op_or
id|uPD98401_TXPD_DP
op_or
id|uPD98401_TXPD_SM
op_or
(paren
id|vcc-&gt;qos.aal
op_eq
id|ATM_AAL5
ques
c_cond
id|uPD98401_TXPD_AAL5
suffix:colon
l_int|0
op_or
(paren
id|ATM_SKB
c_func
(paren
id|skb
)paren
op_member_access_from_pointer
id|atm_options
op_amp
id|ATM_ATMOPT_CLP
ques
c_cond
id|uPD98401_CLPM_1
suffix:colon
id|uPD98401_CLPM_0
)paren
)paren
suffix:semicolon
id|EVENT
c_func
(paren
l_string|&quot;dsc (0x%lx)&bslash;n&quot;
comma
(paren
r_int
r_int
)paren
id|dsc
comma
l_int|0
)paren
suffix:semicolon
)brace
r_else
(brace
id|printk
c_func
(paren
l_string|&quot;NONONONOO!!!!&bslash;n&quot;
)paren
suffix:semicolon
id|dsc
op_assign
l_int|NULL
suffix:semicolon
macro_line|#if 0
id|u32
op_star
id|put
suffix:semicolon
r_int
id|i
suffix:semicolon
id|dsc
op_assign
(paren
id|u32
op_star
)paren
id|kmalloc
c_func
(paren
id|uPD98401_TXPD_SIZE
op_star
l_int|2
op_plus
id|uPD98401_TXBD_SIZE
op_star
id|ATM_SKB
c_func
(paren
id|skb
)paren
op_member_access_from_pointer
id|iovcnt
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dsc
)paren
(brace
r_if
c_cond
(paren
id|vcc-&gt;pop
)paren
id|vcc
op_member_access_from_pointer
id|pop
c_func
(paren
id|vcc
comma
id|skb
)paren
suffix:semicolon
r_else
id|dev_kfree_skb_irq
c_func
(paren
id|skb
)paren
suffix:semicolon
r_return
op_minus
id|EAGAIN
suffix:semicolon
)brace
multiline_comment|/* @@@ should check alignment */
id|put
op_assign
id|dsc
op_plus
l_int|8
suffix:semicolon
id|dsc
(braket
l_int|0
)braket
op_assign
id|uPD98401_TXPD_V
op_or
id|uPD98401_TXPD_DP
op_or
(paren
id|vcc-&gt;aal
op_eq
id|ATM_AAL5
ques
c_cond
id|uPD98401_TXPD_AAL5
suffix:colon
l_int|0
op_or
(paren
id|ATM_SKB
c_func
(paren
id|skb
)paren
op_member_access_from_pointer
id|atm_options
op_amp
id|ATM_ATMOPT_CLP
ques
c_cond
id|uPD98401_CLPM_1
suffix:colon
id|uPD98401_CLPM_0
)paren
)paren
suffix:semicolon
id|dsc
(braket
l_int|1
)braket
op_assign
l_int|0
suffix:semicolon
id|dsc
(braket
l_int|2
)braket
op_assign
id|ATM_SKB
c_func
(paren
id|skb
)paren
op_member_access_from_pointer
id|iovcnt
op_star
id|uPD98401_TXBD_SIZE
suffix:semicolon
id|dsc
(braket
l_int|3
)braket
op_assign
id|virt_to_bus
c_func
(paren
id|put
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|ATM_SKB
c_func
(paren
id|skb
)paren
op_member_access_from_pointer
id|iovcnt
suffix:semicolon
id|i
op_increment
)paren
(brace
op_star
id|put
op_increment
op_assign
(paren
(paren
r_struct
id|iovec
op_star
)paren
id|skb-&gt;data
)paren
(braket
id|i
)braket
dot
id|iov_len
suffix:semicolon
op_star
id|put
op_increment
op_assign
id|virt_to_bus
c_func
(paren
(paren
(paren
r_struct
id|iovec
op_star
)paren
id|skb-&gt;data
)paren
(braket
id|i
)braket
dot
id|iov_base
)paren
suffix:semicolon
)brace
id|put
(braket
op_minus
l_int|2
)braket
op_or_assign
id|uPD98401_TXBD_LAST
suffix:semicolon
macro_line|#endif
)brace
id|ZATM_PRV_DSC
c_func
(paren
id|skb
)paren
op_assign
id|dsc
suffix:semicolon
id|skb_queue_tail
c_func
(paren
op_amp
id|zatm_vcc-&gt;tx_queue
comma
id|skb
)paren
suffix:semicolon
id|DPRINTK
c_func
(paren
l_string|&quot;QRP=0x%08lx&bslash;n&quot;
comma
id|zpeekl
c_func
(paren
id|zatm_dev
comma
id|zatm_vcc-&gt;tx_chan
op_star
id|VC_SIZE
op_div
l_int|4
op_plus
id|uPD98401_TXVC_QRP
)paren
)paren
suffix:semicolon
id|zwait
suffix:semicolon
id|zout
c_func
(paren
id|uPD98401_TX_READY
op_or
(paren
id|zatm_vcc-&gt;tx_chan
op_lshift
id|uPD98401_CHAN_ADDR_SHIFT
)paren
comma
id|CMR
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|EVENT
c_func
(paren
l_string|&quot;done&bslash;n&quot;
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|dequeue_tx
r_static
r_inline
r_void
id|dequeue_tx
c_func
(paren
r_struct
id|atm_vcc
op_star
id|vcc
)paren
(brace
r_struct
id|zatm_vcc
op_star
id|zatm_vcc
suffix:semicolon
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
id|EVENT
c_func
(paren
l_string|&quot;dequeue_tx&bslash;n&quot;
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
id|zatm_vcc
op_assign
id|ZATM_VCC
c_func
(paren
id|vcc
)paren
suffix:semicolon
id|skb
op_assign
id|skb_dequeue
c_func
(paren
op_amp
id|zatm_vcc-&gt;tx_queue
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|skb
)paren
(brace
id|printk
c_func
(paren
id|KERN_CRIT
id|DEV_LABEL
l_string|&quot;(itf %d): dequeue_tx but not &quot;
l_string|&quot;txing&bslash;n&quot;
comma
id|vcc-&gt;dev-&gt;number
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
macro_line|#if 0 /* @@@ would fail on CLP */
r_if
c_cond
(paren
op_star
id|ZATM_PRV_DSC
c_func
(paren
id|skb
)paren
op_ne
(paren
id|uPD98401_TXPD_V
op_or
id|uPD98401_TXPD_DP
op_or
id|uPD98401_TXPD_SM
op_or
id|uPD98401_TXPD_AAL5
)paren
)paren
id|printk
c_func
(paren
l_string|&quot;@#*$!!!!  (%08x)&bslash;n&quot;
comma
op_star
id|ZATM_PRV_DSC
c_func
(paren
id|skb
)paren
)paren
suffix:semicolon
macro_line|#endif
op_star
id|ZATM_PRV_DSC
c_func
(paren
id|skb
)paren
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* mark as invalid */
id|zatm_vcc-&gt;txing
op_decrement
suffix:semicolon
r_if
c_cond
(paren
id|vcc-&gt;pop
)paren
id|vcc
op_member_access_from_pointer
id|pop
c_func
(paren
id|vcc
comma
id|skb
)paren
suffix:semicolon
r_else
id|dev_kfree_skb_irq
c_func
(paren
id|skb
)paren
suffix:semicolon
r_while
c_loop
(paren
(paren
id|skb
op_assign
id|skb_dequeue
c_func
(paren
op_amp
id|zatm_vcc-&gt;backlog
)paren
)paren
)paren
r_if
c_cond
(paren
id|do_tx
c_func
(paren
id|skb
)paren
op_eq
id|RING_BUSY
)paren
(brace
id|skb_queue_head
c_func
(paren
op_amp
id|zatm_vcc-&gt;backlog
comma
id|skb
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|atomic_inc
c_func
(paren
op_amp
id|vcc-&gt;stats-&gt;tx
)paren
suffix:semicolon
id|wake_up
c_func
(paren
op_amp
id|zatm_vcc-&gt;tx_wait
)paren
suffix:semicolon
)brace
DECL|function|poll_tx
r_static
r_void
id|poll_tx
c_func
(paren
r_struct
id|atm_dev
op_star
id|dev
comma
r_int
id|mbx
)paren
(brace
r_struct
id|zatm_dev
op_star
id|zatm_dev
suffix:semicolon
r_int
r_int
id|pos
suffix:semicolon
id|u32
id|x
suffix:semicolon
id|EVENT
c_func
(paren
l_string|&quot;poll_tx&bslash;n&quot;
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
id|zatm_dev
op_assign
id|ZATM_DEV
c_func
(paren
id|dev
)paren
suffix:semicolon
id|pos
op_assign
(paren
id|zatm_dev-&gt;mbx_start
(braket
id|mbx
)braket
op_amp
op_complement
l_int|0xffffUL
)paren
op_or
id|zin
c_func
(paren
id|MTA
c_func
(paren
id|mbx
)paren
)paren
suffix:semicolon
r_while
c_loop
(paren
id|x
op_assign
id|zin
c_func
(paren
id|MWA
c_func
(paren
id|mbx
)paren
)paren
comma
(paren
id|pos
op_amp
l_int|0xffff
)paren
op_ne
id|x
)paren
(brace
r_int
id|chan
suffix:semicolon
macro_line|#if 1
id|u32
id|data
comma
op_star
id|addr
suffix:semicolon
id|EVENT
c_func
(paren
l_string|&quot;MBX: host 0x%lx, nic 0x%x&bslash;n&quot;
comma
id|pos
comma
id|x
)paren
suffix:semicolon
id|addr
op_assign
(paren
id|u32
op_star
)paren
id|pos
suffix:semicolon
id|data
op_assign
op_star
id|addr
suffix:semicolon
id|chan
op_assign
(paren
id|data
op_amp
id|uPD98401_TXI_CONN
)paren
op_rshift
id|uPD98401_TXI_CONN_SHIFT
suffix:semicolon
id|EVENT
c_func
(paren
l_string|&quot;addr = 0x%lx, data = 0x%08x,&quot;
comma
(paren
r_int
r_int
)paren
id|addr
comma
id|data
)paren
suffix:semicolon
id|EVENT
c_func
(paren
l_string|&quot;chan = %d&bslash;n&quot;
comma
id|chan
comma
l_int|0
)paren
suffix:semicolon
macro_line|#else
id|NO
op_logical_neg
id|chan
op_assign
(paren
id|zatm_dev-&gt;mbx_start
(braket
id|mbx
)braket
(braket
id|pos
op_rshift
l_int|2
)braket
op_amp
id|uPD98401_TXI_CONN
)paren
op_rshift
id|uPD98401_TXI_CONN_SHIFT
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|chan
OL
id|zatm_dev-&gt;chans
op_logical_and
id|zatm_dev-&gt;tx_map
(braket
id|chan
)braket
)paren
id|dequeue_tx
c_func
(paren
id|zatm_dev-&gt;tx_map
(braket
id|chan
)braket
)paren
suffix:semicolon
r_else
(brace
id|printk
c_func
(paren
id|KERN_CRIT
id|DEV_LABEL
l_string|&quot;(itf %d): TX indication &quot;
l_string|&quot;for non-existing channel %d&bslash;n&quot;
comma
id|dev-&gt;number
comma
id|chan
)paren
suffix:semicolon
id|event_dump
c_func
(paren
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
(paren
id|pos
op_add_assign
l_int|4
)paren
op_amp
l_int|0xffff
)paren
op_eq
id|zatm_dev-&gt;mbx_end
(braket
id|mbx
)braket
)paren
id|pos
op_assign
id|zatm_dev-&gt;mbx_start
(braket
id|mbx
)braket
suffix:semicolon
)brace
id|zout
c_func
(paren
id|pos
op_amp
l_int|0xffff
comma
id|MTA
c_func
(paren
id|mbx
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * BUG BUG BUG: Doesn&squot;t handle &quot;new-style&quot; rate specification yet.&n; */
DECL|function|alloc_shaper
r_static
r_int
id|alloc_shaper
c_func
(paren
r_struct
id|atm_dev
op_star
id|dev
comma
r_int
op_star
id|pcr
comma
r_int
id|min
comma
r_int
id|max
comma
r_int
id|ubr
)paren
(brace
r_struct
id|zatm_dev
op_star
id|zatm_dev
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_int
r_int
id|i
comma
id|m
comma
id|c
suffix:semicolon
r_int
id|shaper
suffix:semicolon
id|DPRINTK
c_func
(paren
l_string|&quot;alloc_shaper (min = %d, max = %d)&bslash;n&quot;
comma
id|min
comma
id|max
)paren
suffix:semicolon
id|zatm_dev
op_assign
id|ZATM_DEV
c_func
(paren
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|zatm_dev-&gt;free_shapers
)paren
r_return
op_minus
id|EAGAIN
suffix:semicolon
r_for
c_loop
(paren
id|shaper
op_assign
l_int|0
suffix:semicolon
op_logical_neg
(paren
(paren
id|zatm_dev-&gt;free_shapers
op_rshift
id|shaper
)paren
op_amp
l_int|1
)paren
suffix:semicolon
id|shaper
op_increment
)paren
suffix:semicolon
id|zatm_dev-&gt;free_shapers
op_and_assign
op_complement
l_int|1
op_lshift
id|shaper
suffix:semicolon
r_if
c_cond
(paren
id|ubr
)paren
(brace
id|c
op_assign
l_int|5
suffix:semicolon
id|i
op_assign
id|m
op_assign
l_int|1
suffix:semicolon
id|zatm_dev-&gt;ubr_ref_cnt
op_increment
suffix:semicolon
id|zatm_dev-&gt;ubr
op_assign
id|shaper
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|min
)paren
(brace
r_if
c_cond
(paren
id|min
op_le
l_int|255
)paren
(brace
id|i
op_assign
id|min
suffix:semicolon
id|m
op_assign
id|ATM_OC3_PCR
suffix:semicolon
)brace
r_else
(brace
id|i
op_assign
l_int|255
suffix:semicolon
id|m
op_assign
id|ATM_OC3_PCR
op_star
l_int|255
op_div
id|min
suffix:semicolon
)brace
)brace
r_else
(brace
r_if
c_cond
(paren
id|max
OG
id|zatm_dev-&gt;tx_bw
)paren
id|max
op_assign
id|zatm_dev-&gt;tx_bw
suffix:semicolon
r_if
c_cond
(paren
id|max
op_le
l_int|255
)paren
(brace
id|i
op_assign
id|max
suffix:semicolon
id|m
op_assign
id|ATM_OC3_PCR
suffix:semicolon
)brace
r_else
(brace
id|i
op_assign
l_int|255
suffix:semicolon
id|m
op_assign
(paren
id|ATM_OC3_PCR
op_star
l_int|255
op_plus
id|max
op_minus
l_int|1
)paren
op_div
id|max
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|i
OG
id|m
)paren
(brace
id|printk
c_func
(paren
id|KERN_CRIT
id|DEV_LABEL
l_string|&quot;shaper algorithm botched &quot;
l_string|&quot;[%d,%d] -&gt; i=%ld,m=%ld&bslash;n&quot;
comma
id|min
comma
id|max
comma
id|i
comma
id|m
)paren
suffix:semicolon
id|m
op_assign
id|i
suffix:semicolon
)brace
op_star
id|pcr
op_assign
id|i
op_star
id|ATM_OC3_PCR
op_div
id|m
suffix:semicolon
id|c
op_assign
l_int|20
suffix:semicolon
multiline_comment|/* @@@ should use max_cdv ! */
r_if
c_cond
(paren
(paren
id|min
op_logical_and
op_star
id|pcr
OL
id|min
)paren
op_logical_or
(paren
id|max
op_logical_and
op_star
id|pcr
OG
id|max
)paren
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|zatm_dev-&gt;tx_bw
OL
op_star
id|pcr
)paren
r_return
op_minus
id|EAGAIN
suffix:semicolon
id|zatm_dev-&gt;tx_bw
op_sub_assign
op_star
id|pcr
suffix:semicolon
)brace
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|DPRINTK
c_func
(paren
l_string|&quot;i = %d, m = %d, PCR = %d&bslash;n&quot;
comma
id|i
comma
id|m
comma
op_star
id|pcr
)paren
suffix:semicolon
id|zpokel
c_func
(paren
id|zatm_dev
comma
(paren
id|i
op_lshift
id|uPD98401_IM_I_SHIFT
)paren
op_or
id|m
comma
id|uPD98401_IM
c_func
(paren
id|shaper
)paren
)paren
suffix:semicolon
id|zpokel
c_func
(paren
id|zatm_dev
comma
id|c
op_lshift
id|uPD98401_PC_C_SHIFT
comma
id|uPD98401_PC
c_func
(paren
id|shaper
)paren
)paren
suffix:semicolon
id|zpokel
c_func
(paren
id|zatm_dev
comma
l_int|0
comma
id|uPD98401_X
c_func
(paren
id|shaper
)paren
)paren
suffix:semicolon
id|zpokel
c_func
(paren
id|zatm_dev
comma
l_int|0
comma
id|uPD98401_Y
c_func
(paren
id|shaper
)paren
)paren
suffix:semicolon
id|zpokel
c_func
(paren
id|zatm_dev
comma
id|uPD98401_PS_E
comma
id|uPD98401_PS
c_func
(paren
id|shaper
)paren
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
id|shaper
suffix:semicolon
)brace
DECL|function|dealloc_shaper
r_static
r_void
id|dealloc_shaper
c_func
(paren
r_struct
id|atm_dev
op_star
id|dev
comma
r_int
id|shaper
)paren
(brace
r_struct
id|zatm_dev
op_star
id|zatm_dev
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|zatm_dev
op_assign
id|ZATM_DEV
c_func
(paren
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|shaper
op_eq
id|zatm_dev-&gt;ubr
)paren
(brace
r_if
c_cond
(paren
op_decrement
id|zatm_dev-&gt;ubr_ref_cnt
)paren
r_return
suffix:semicolon
id|zatm_dev-&gt;ubr
op_assign
op_minus
l_int|1
suffix:semicolon
)brace
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|zpokel
c_func
(paren
id|zatm_dev
comma
id|zpeekl
c_func
(paren
id|zatm_dev
comma
id|uPD98401_PS
c_func
(paren
id|shaper
)paren
)paren
op_amp
op_complement
id|uPD98401_PS_E
comma
id|uPD98401_PS
c_func
(paren
id|shaper
)paren
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|zatm_dev-&gt;free_shapers
op_or_assign
l_int|1
op_lshift
id|shaper
suffix:semicolon
)brace
DECL|function|close_tx
r_static
r_void
id|close_tx
c_func
(paren
r_struct
id|atm_vcc
op_star
id|vcc
)paren
(brace
r_struct
id|zatm_dev
op_star
id|zatm_dev
suffix:semicolon
r_struct
id|zatm_vcc
op_star
id|zatm_vcc
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_int
id|chan
suffix:semicolon
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
r_int
id|once
op_assign
l_int|1
suffix:semicolon
id|zatm_vcc
op_assign
id|ZATM_VCC
c_func
(paren
id|vcc
)paren
suffix:semicolon
id|zatm_dev
op_assign
id|ZATM_DEV
c_func
(paren
id|vcc-&gt;dev
)paren
suffix:semicolon
id|chan
op_assign
id|zatm_vcc-&gt;tx_chan
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|chan
)paren
r_return
suffix:semicolon
id|DPRINTK
c_func
(paren
l_string|&quot;close_tx&bslash;n&quot;
)paren
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
r_while
c_loop
(paren
id|skb_peek
c_func
(paren
op_amp
id|zatm_vcc-&gt;backlog
)paren
)paren
(brace
r_if
c_cond
(paren
id|once
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;waiting for backlog to drain ...&bslash;n&quot;
)paren
suffix:semicolon
id|event_dump
c_func
(paren
)paren
suffix:semicolon
id|once
op_assign
l_int|0
suffix:semicolon
)brace
id|sleep_on
c_func
(paren
op_amp
id|zatm_vcc-&gt;tx_wait
)paren
suffix:semicolon
)brace
id|once
op_assign
l_int|1
suffix:semicolon
r_while
c_loop
(paren
(paren
id|skb
op_assign
id|skb_peek
c_func
(paren
op_amp
id|zatm_vcc-&gt;tx_queue
)paren
)paren
)paren
(brace
r_if
c_cond
(paren
id|once
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;waiting for TX queue to drain ... %p&bslash;n&quot;
comma
id|skb
)paren
suffix:semicolon
id|event_dump
c_func
(paren
)paren
suffix:semicolon
id|once
op_assign
l_int|0
suffix:semicolon
)brace
id|DPRINTK
c_func
(paren
l_string|&quot;waiting for TX queue to drain ... %p&bslash;n&quot;
comma
id|skb
)paren
suffix:semicolon
id|sleep_on
c_func
(paren
op_amp
id|zatm_vcc-&gt;tx_wait
)paren
suffix:semicolon
)brace
macro_line|#if 0
id|zwait
suffix:semicolon
id|zout
c_func
(paren
id|uPD98401_DEACT_CHAN
op_or
(paren
id|chan
op_lshift
id|uPD98401_CHAN_ADDR_SHIFT
)paren
comma
id|CMR
)paren
suffix:semicolon
macro_line|#endif
id|zwait
suffix:semicolon
id|zout
c_func
(paren
id|uPD98401_CLOSE_CHAN
op_or
(paren
id|chan
op_lshift
id|uPD98401_CHAN_ADDR_SHIFT
)paren
comma
id|CMR
)paren
suffix:semicolon
id|zwait
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|zin
c_func
(paren
id|CMR
)paren
op_amp
id|uPD98401_CHAN_ADDR
)paren
)paren
id|printk
c_func
(paren
id|KERN_CRIT
id|DEV_LABEL
l_string|&quot;(itf %d): can&squot;t close TX channel &quot;
l_string|&quot;%d&bslash;n&quot;
comma
id|vcc-&gt;dev-&gt;number
comma
id|chan
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|zatm_vcc-&gt;tx_chan
op_assign
l_int|0
suffix:semicolon
id|zatm_dev-&gt;tx_map
(braket
id|chan
)braket
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
id|zatm_vcc-&gt;shaper
op_ne
id|zatm_dev-&gt;ubr
)paren
(brace
id|zatm_dev-&gt;tx_bw
op_add_assign
id|vcc-&gt;qos.txtp.min_pcr
suffix:semicolon
id|dealloc_shaper
c_func
(paren
id|vcc-&gt;dev
comma
id|zatm_vcc-&gt;shaper
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|zatm_vcc-&gt;ring
)paren
id|kfree
c_func
(paren
id|zatm_vcc-&gt;ring
)paren
suffix:semicolon
)brace
DECL|function|open_tx_first
r_static
r_int
id|open_tx_first
c_func
(paren
r_struct
id|atm_vcc
op_star
id|vcc
)paren
(brace
r_struct
id|zatm_dev
op_star
id|zatm_dev
suffix:semicolon
r_struct
id|zatm_vcc
op_star
id|zatm_vcc
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|u32
op_star
id|loop
suffix:semicolon
r_int
r_int
id|chan
suffix:semicolon
r_int
id|pcr
comma
id|unlimited
suffix:semicolon
id|DPRINTK
c_func
(paren
l_string|&quot;open_tx_first&bslash;n&quot;
)paren
suffix:semicolon
id|zatm_dev
op_assign
id|ZATM_DEV
c_func
(paren
id|vcc-&gt;dev
)paren
suffix:semicolon
id|zatm_vcc
op_assign
id|ZATM_VCC
c_func
(paren
id|vcc
)paren
suffix:semicolon
id|zatm_vcc-&gt;tx_chan
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|vcc-&gt;qos.txtp.traffic_class
op_eq
id|ATM_NONE
)paren
r_return
l_int|0
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|zwait
suffix:semicolon
id|zout
c_func
(paren
id|uPD98401_OPEN_CHAN
comma
id|CMR
)paren
suffix:semicolon
id|zwait
suffix:semicolon
id|DPRINTK
c_func
(paren
l_string|&quot;0x%x 0x%x&bslash;n&quot;
comma
id|zin
c_func
(paren
id|CMR
)paren
comma
id|zin
c_func
(paren
id|CER
)paren
)paren
suffix:semicolon
id|chan
op_assign
(paren
id|zin
c_func
(paren
id|CMR
)paren
op_amp
id|uPD98401_CHAN_ADDR
)paren
op_rshift
id|uPD98401_CHAN_ADDR_SHIFT
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|DPRINTK
c_func
(paren
l_string|&quot;chan is %d&bslash;n&quot;
comma
id|chan
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|chan
)paren
r_return
op_minus
id|EAGAIN
suffix:semicolon
id|unlimited
op_assign
id|vcc-&gt;qos.txtp.traffic_class
op_eq
id|ATM_UBR
op_logical_and
(paren
op_logical_neg
id|vcc-&gt;qos.txtp.max_pcr
op_logical_or
id|vcc-&gt;qos.txtp.max_pcr
op_eq
id|ATM_MAX_PCR
op_logical_or
id|vcc-&gt;qos.txtp.max_pcr
op_ge
id|ATM_OC3_PCR
)paren
suffix:semicolon
r_if
c_cond
(paren
id|unlimited
op_logical_and
id|zatm_dev-&gt;ubr
op_ne
op_minus
l_int|1
)paren
id|zatm_vcc-&gt;shaper
op_assign
id|zatm_dev-&gt;ubr
suffix:semicolon
r_else
(brace
r_if
c_cond
(paren
id|unlimited
)paren
id|vcc-&gt;qos.txtp.max_sdu
op_assign
id|ATM_MAX_AAL5_PDU
suffix:semicolon
r_if
c_cond
(paren
(paren
id|zatm_vcc-&gt;shaper
op_assign
id|alloc_shaper
c_func
(paren
id|vcc-&gt;dev
comma
op_amp
id|pcr
comma
id|vcc-&gt;qos.txtp.min_pcr
comma
id|vcc-&gt;qos.txtp.max_pcr
comma
id|unlimited
)paren
)paren
OL
l_int|0
)paren
(brace
id|close_tx
c_func
(paren
id|vcc
)paren
suffix:semicolon
r_return
id|zatm_vcc-&gt;shaper
suffix:semicolon
)brace
r_if
c_cond
(paren
id|pcr
OG
id|ATM_OC3_PCR
)paren
id|pcr
op_assign
id|ATM_OC3_PCR
suffix:semicolon
id|vcc-&gt;qos.txtp.min_pcr
op_assign
id|vcc-&gt;qos.txtp.max_pcr
op_assign
id|pcr
suffix:semicolon
)brace
id|zatm_vcc-&gt;tx_chan
op_assign
id|chan
suffix:semicolon
id|skb_queue_head_init
c_func
(paren
op_amp
id|zatm_vcc-&gt;tx_queue
)paren
suffix:semicolon
id|init_waitqueue_head
c_func
(paren
op_amp
id|zatm_vcc-&gt;tx_wait
)paren
suffix:semicolon
multiline_comment|/* initialize ring */
id|zatm_vcc-&gt;ring
op_assign
id|kmalloc
c_func
(paren
id|RING_SIZE
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|zatm_vcc-&gt;ring
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|memset
c_func
(paren
id|zatm_vcc-&gt;ring
comma
l_int|0
comma
id|RING_SIZE
)paren
suffix:semicolon
id|loop
op_assign
id|zatm_vcc-&gt;ring
op_plus
id|RING_ENTRIES
op_star
id|RING_WORDS
suffix:semicolon
id|loop
(braket
l_int|0
)braket
op_assign
id|uPD98401_TXPD_V
suffix:semicolon
id|loop
(braket
l_int|1
)braket
op_assign
id|loop
(braket
l_int|2
)braket
op_assign
l_int|0
suffix:semicolon
id|loop
(braket
l_int|3
)braket
op_assign
id|virt_to_bus
c_func
(paren
id|zatm_vcc-&gt;ring
)paren
suffix:semicolon
id|zatm_vcc-&gt;ring_curr
op_assign
l_int|0
suffix:semicolon
id|zatm_vcc-&gt;txing
op_assign
l_int|0
suffix:semicolon
id|skb_queue_head_init
c_func
(paren
op_amp
id|zatm_vcc-&gt;backlog
)paren
suffix:semicolon
id|zpokel
c_func
(paren
id|zatm_dev
comma
id|virt_to_bus
c_func
(paren
id|zatm_vcc-&gt;ring
)paren
comma
id|chan
op_star
id|VC_SIZE
op_div
l_int|4
op_plus
id|uPD98401_TXVC_QRP
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|open_tx_second
r_static
r_int
id|open_tx_second
c_func
(paren
r_struct
id|atm_vcc
op_star
id|vcc
)paren
(brace
r_struct
id|zatm_dev
op_star
id|zatm_dev
suffix:semicolon
r_struct
id|zatm_vcc
op_star
id|zatm_vcc
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|DPRINTK
c_func
(paren
l_string|&quot;open_tx_second&bslash;n&quot;
)paren
suffix:semicolon
id|zatm_dev
op_assign
id|ZATM_DEV
c_func
(paren
id|vcc-&gt;dev
)paren
suffix:semicolon
id|zatm_vcc
op_assign
id|ZATM_VCC
c_func
(paren
id|vcc
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|zatm_vcc-&gt;tx_chan
)paren
r_return
l_int|0
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
multiline_comment|/* set up VC descriptor */
id|cli
c_func
(paren
)paren
suffix:semicolon
id|zpokel
c_func
(paren
id|zatm_dev
comma
l_int|0
comma
id|zatm_vcc-&gt;tx_chan
op_star
id|VC_SIZE
op_div
l_int|4
)paren
suffix:semicolon
id|zpokel
c_func
(paren
id|zatm_dev
comma
id|uPD98401_TXVC_L
op_or
(paren
id|zatm_vcc-&gt;shaper
op_lshift
id|uPD98401_TXVC_SHP_SHIFT
)paren
op_or
(paren
id|vcc-&gt;vpi
op_lshift
id|uPD98401_TXVC_VPI_SHIFT
)paren
op_or
id|vcc-&gt;vci
comma
id|zatm_vcc-&gt;tx_chan
op_star
id|VC_SIZE
op_div
l_int|4
op_plus
l_int|1
)paren
suffix:semicolon
id|zpokel
c_func
(paren
id|zatm_dev
comma
l_int|0
comma
id|zatm_vcc-&gt;tx_chan
op_star
id|VC_SIZE
op_div
l_int|4
op_plus
l_int|2
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|zatm_dev-&gt;tx_map
(braket
id|zatm_vcc-&gt;tx_chan
)braket
op_assign
id|vcc
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|start_tx
r_static
r_int
id|start_tx
c_func
(paren
r_struct
id|atm_dev
op_star
id|dev
)paren
(brace
r_struct
id|zatm_dev
op_star
id|zatm_dev
suffix:semicolon
r_int
id|i
suffix:semicolon
id|DPRINTK
c_func
(paren
l_string|&quot;start_tx&bslash;n&quot;
)paren
suffix:semicolon
id|zatm_dev
op_assign
id|ZATM_DEV
c_func
(paren
id|dev
)paren
suffix:semicolon
id|zatm_dev-&gt;tx_map
op_assign
(paren
r_struct
id|atm_vcc
op_star
op_star
)paren
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|atm_vcc
op_star
)paren
op_star
id|zatm_dev-&gt;chans
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|zatm_dev-&gt;tx_map
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|zatm_dev-&gt;tx_bw
op_assign
id|ATM_OC3_PCR
suffix:semicolon
id|zatm_dev-&gt;free_shapers
op_assign
(paren
l_int|1
op_lshift
id|NR_SHAPERS
)paren
op_minus
l_int|1
suffix:semicolon
id|zatm_dev-&gt;ubr
op_assign
op_minus
l_int|1
suffix:semicolon
id|zatm_dev-&gt;ubr_ref_cnt
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* initialize shapers */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|NR_SHAPERS
suffix:semicolon
id|i
op_increment
)paren
id|zpokel
c_func
(paren
id|zatm_dev
comma
l_int|0
comma
id|uPD98401_PS
c_func
(paren
id|i
)paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*------------------------------- interrupts --------------------------------*/
DECL|function|zatm_int
r_static
r_void
id|zatm_int
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_struct
id|atm_dev
op_star
id|dev
suffix:semicolon
r_struct
id|zatm_dev
op_star
id|zatm_dev
suffix:semicolon
id|u32
id|reason
suffix:semicolon
id|dev
op_assign
id|dev_id
suffix:semicolon
id|zatm_dev
op_assign
id|ZATM_DEV
c_func
(paren
id|dev
)paren
suffix:semicolon
r_while
c_loop
(paren
(paren
id|reason
op_assign
id|zin
c_func
(paren
id|GSR
)paren
)paren
)paren
(brace
id|EVENT
c_func
(paren
l_string|&quot;reason 0x%x&bslash;n&quot;
comma
id|reason
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|reason
op_amp
id|uPD98401_INT_PI
)paren
(brace
id|EVENT
c_func
(paren
l_string|&quot;PHY int&bslash;n&quot;
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
id|dev-&gt;phy
op_member_access_from_pointer
id|interrupt
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|reason
op_amp
id|uPD98401_INT_RQA
)paren
(brace
r_int
r_int
id|pools
suffix:semicolon
r_int
id|i
suffix:semicolon
id|pools
op_assign
id|zin
c_func
(paren
id|RQA
)paren
suffix:semicolon
id|EVENT
c_func
(paren
l_string|&quot;RQA (0x%08x)&bslash;n&quot;
comma
id|pools
comma
l_int|0
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|pools
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|pools
op_amp
l_int|1
)paren
(brace
id|refill_pool
c_func
(paren
id|dev
comma
id|i
)paren
suffix:semicolon
id|zatm_dev-&gt;pool_info
(braket
id|i
)braket
dot
id|rqa_count
op_increment
suffix:semicolon
)brace
id|pools
op_rshift_assign
l_int|1
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|reason
op_amp
id|uPD98401_INT_RQU
)paren
(brace
r_int
r_int
id|pools
suffix:semicolon
r_int
id|i
suffix:semicolon
id|pools
op_assign
id|zin
c_func
(paren
id|RQU
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_WARNING
id|DEV_LABEL
l_string|&quot;(itf %d): RQU 0x%08lx&bslash;n&quot;
comma
id|dev-&gt;number
comma
id|pools
)paren
suffix:semicolon
id|event_dump
c_func
(paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|pools
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|pools
op_amp
l_int|1
)paren
(brace
id|refill_pool
c_func
(paren
id|dev
comma
id|i
)paren
suffix:semicolon
id|zatm_dev-&gt;pool_info
(braket
id|i
)braket
dot
id|rqu_count
op_increment
suffix:semicolon
)brace
id|pools
op_rshift_assign
l_int|1
suffix:semicolon
)brace
)brace
multiline_comment|/* don&squot;t handle RD */
r_if
c_cond
(paren
id|reason
op_amp
id|uPD98401_INT_SPE
)paren
id|printk
c_func
(paren
id|KERN_ALERT
id|DEV_LABEL
l_string|&quot;(itf %d): system parity &quot;
l_string|&quot;error at 0x%08x&bslash;n&quot;
comma
id|dev-&gt;number
comma
id|zin
c_func
(paren
id|ADDR
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|reason
op_amp
id|uPD98401_INT_CPE
)paren
id|printk
c_func
(paren
id|KERN_ALERT
id|DEV_LABEL
l_string|&quot;(itf %d): control memory &quot;
l_string|&quot;parity error at 0x%08x&bslash;n&quot;
comma
id|dev-&gt;number
comma
id|zin
c_func
(paren
id|ADDR
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|reason
op_amp
id|uPD98401_INT_SBE
)paren
(brace
id|printk
c_func
(paren
id|KERN_ALERT
id|DEV_LABEL
l_string|&quot;(itf %d): system bus &quot;
l_string|&quot;error at 0x%08x&bslash;n&quot;
comma
id|dev-&gt;number
comma
id|zin
c_func
(paren
id|ADDR
)paren
)paren
suffix:semicolon
id|event_dump
c_func
(paren
)paren
suffix:semicolon
)brace
multiline_comment|/* don&squot;t handle IND */
r_if
c_cond
(paren
id|reason
op_amp
id|uPD98401_INT_MF
)paren
(brace
id|printk
c_func
(paren
id|KERN_CRIT
id|DEV_LABEL
l_string|&quot;(itf %d): mailbox full &quot;
l_string|&quot;(0x%x)&bslash;n&quot;
comma
id|dev-&gt;number
comma
(paren
id|reason
op_amp
id|uPD98401_INT_MF
)paren
op_rshift
id|uPD98401_INT_MF_SHIFT
)paren
suffix:semicolon
id|event_dump
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* @@@ should try to recover */
)brace
r_if
c_cond
(paren
id|reason
op_amp
id|uPD98401_INT_MM
)paren
(brace
r_if
c_cond
(paren
id|reason
op_amp
l_int|1
)paren
id|poll_rx
c_func
(paren
id|dev
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|reason
op_amp
l_int|2
)paren
id|poll_rx
c_func
(paren
id|dev
comma
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|reason
op_amp
l_int|4
)paren
id|poll_tx
c_func
(paren
id|dev
comma
l_int|2
)paren
suffix:semicolon
r_if
c_cond
(paren
id|reason
op_amp
l_int|8
)paren
id|poll_tx
c_func
(paren
id|dev
comma
l_int|3
)paren
suffix:semicolon
)brace
multiline_comment|/* @@@ handle RCRn */
)brace
)brace
multiline_comment|/*----------------------------- (E)EPROM access -----------------------------*/
DECL|function|eprom_set
r_static
r_void
id|__init
id|eprom_set
c_func
(paren
r_struct
id|zatm_dev
op_star
id|zatm_dev
comma
r_int
r_int
id|value
comma
r_int
r_int
id|cmd
)paren
(brace
r_int
id|error
suffix:semicolon
r_if
c_cond
(paren
(paren
id|error
op_assign
id|pci_write_config_dword
c_func
(paren
id|zatm_dev-&gt;pci_dev
comma
id|cmd
comma
id|value
)paren
)paren
)paren
id|printk
c_func
(paren
id|KERN_ERR
id|DEV_LABEL
l_string|&quot;: PCI write failed (0x%02x)&bslash;n&quot;
comma
id|error
)paren
suffix:semicolon
)brace
DECL|function|eprom_get
r_static
r_int
r_int
id|__init
id|eprom_get
c_func
(paren
r_struct
id|zatm_dev
op_star
id|zatm_dev
comma
r_int
r_int
id|cmd
)paren
(brace
r_int
r_int
id|value
suffix:semicolon
r_int
id|error
suffix:semicolon
r_if
c_cond
(paren
(paren
id|error
op_assign
id|pci_read_config_dword
c_func
(paren
id|zatm_dev-&gt;pci_dev
comma
id|cmd
comma
op_amp
id|value
)paren
)paren
)paren
id|printk
c_func
(paren
id|KERN_ERR
id|DEV_LABEL
l_string|&quot;: PCI read failed (0x%02x)&bslash;n&quot;
comma
id|error
)paren
suffix:semicolon
r_return
id|value
suffix:semicolon
)brace
DECL|function|eprom_put_bits
r_static
r_void
id|__init
id|eprom_put_bits
c_func
(paren
r_struct
id|zatm_dev
op_star
id|zatm_dev
comma
r_int
r_int
id|data
comma
r_int
id|bits
comma
r_int
r_int
id|cmd
)paren
(brace
r_int
r_int
id|value
suffix:semicolon
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
id|bits
op_minus
l_int|1
suffix:semicolon
id|i
op_ge
l_int|0
suffix:semicolon
id|i
op_decrement
)paren
(brace
id|value
op_assign
id|ZEPROM_CS
op_or
(paren
(paren
(paren
id|data
op_rshift
id|i
)paren
op_amp
l_int|1
)paren
ques
c_cond
id|ZEPROM_DI
suffix:colon
l_int|0
)paren
suffix:semicolon
id|eprom_set
c_func
(paren
id|zatm_dev
comma
id|value
comma
id|cmd
)paren
suffix:semicolon
id|eprom_set
c_func
(paren
id|zatm_dev
comma
id|value
op_or
id|ZEPROM_SK
comma
id|cmd
)paren
suffix:semicolon
id|eprom_set
c_func
(paren
id|zatm_dev
comma
id|value
comma
id|cmd
)paren
suffix:semicolon
)brace
)brace
DECL|function|eprom_get_byte
r_static
r_void
id|__init
id|eprom_get_byte
c_func
(paren
r_struct
id|zatm_dev
op_star
id|zatm_dev
comma
r_int
r_char
op_star
id|byte
comma
r_int
r_int
id|cmd
)paren
(brace
r_int
id|i
suffix:semicolon
op_star
id|byte
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|8
suffix:semicolon
id|i
suffix:semicolon
id|i
op_decrement
)paren
(brace
id|eprom_set
c_func
(paren
id|zatm_dev
comma
id|ZEPROM_CS
comma
id|cmd
)paren
suffix:semicolon
id|eprom_set
c_func
(paren
id|zatm_dev
comma
id|ZEPROM_CS
op_or
id|ZEPROM_SK
comma
id|cmd
)paren
suffix:semicolon
op_star
id|byte
op_lshift_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|eprom_get
c_func
(paren
id|zatm_dev
comma
id|cmd
)paren
op_amp
id|ZEPROM_DO
)paren
op_star
id|byte
op_or_assign
l_int|1
suffix:semicolon
id|eprom_set
c_func
(paren
id|zatm_dev
comma
id|ZEPROM_CS
comma
id|cmd
)paren
suffix:semicolon
)brace
)brace
DECL|function|eprom_try_esi
r_static
r_int
r_char
id|__init
id|eprom_try_esi
c_func
(paren
r_struct
id|atm_dev
op_star
id|dev
comma
r_int
r_int
id|cmd
comma
r_int
id|offset
comma
r_int
id|swap
)paren
(brace
r_int
r_char
id|buf
(braket
id|ZEPROM_SIZE
)braket
suffix:semicolon
r_struct
id|zatm_dev
op_star
id|zatm_dev
suffix:semicolon
r_int
id|i
suffix:semicolon
id|zatm_dev
op_assign
id|ZATM_DEV
c_func
(paren
id|dev
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|ZEPROM_SIZE
suffix:semicolon
id|i
op_add_assign
l_int|2
)paren
(brace
id|eprom_set
c_func
(paren
id|zatm_dev
comma
id|ZEPROM_CS
comma
id|cmd
)paren
suffix:semicolon
multiline_comment|/* select EPROM */
id|eprom_put_bits
c_func
(paren
id|zatm_dev
comma
id|ZEPROM_CMD_READ
comma
id|ZEPROM_CMD_LEN
comma
id|cmd
)paren
suffix:semicolon
id|eprom_put_bits
c_func
(paren
id|zatm_dev
comma
id|i
op_rshift
l_int|1
comma
id|ZEPROM_ADDR_LEN
comma
id|cmd
)paren
suffix:semicolon
id|eprom_get_byte
c_func
(paren
id|zatm_dev
comma
id|buf
op_plus
id|i
op_plus
id|swap
comma
id|cmd
)paren
suffix:semicolon
id|eprom_get_byte
c_func
(paren
id|zatm_dev
comma
id|buf
op_plus
id|i
op_plus
l_int|1
op_minus
id|swap
comma
id|cmd
)paren
suffix:semicolon
id|eprom_set
c_func
(paren
id|zatm_dev
comma
l_int|0
comma
id|cmd
)paren
suffix:semicolon
multiline_comment|/* deselect EPROM */
)brace
id|memcpy
c_func
(paren
id|dev-&gt;esi
comma
id|buf
op_plus
id|offset
comma
id|ESI_LEN
)paren
suffix:semicolon
r_return
id|memcmp
c_func
(paren
id|dev-&gt;esi
comma
l_string|&quot;&bslash;0&bslash;0&bslash;0&bslash;0&bslash;0&quot;
comma
id|ESI_LEN
)paren
suffix:semicolon
multiline_comment|/* assumes ESI_LEN == 6 */
)brace
DECL|function|eprom_get_esi
r_static
r_void
id|__init
id|eprom_get_esi
c_func
(paren
r_struct
id|atm_dev
op_star
id|dev
)paren
(brace
r_if
c_cond
(paren
id|eprom_try_esi
c_func
(paren
id|dev
comma
id|ZEPROM_V1_REG
comma
id|ZEPROM_V1_ESI_OFF
comma
l_int|1
)paren
)paren
r_return
suffix:semicolon
(paren
r_void
)paren
id|eprom_try_esi
c_func
(paren
id|dev
comma
id|ZEPROM_V2_REG
comma
id|ZEPROM_V2_ESI_OFF
comma
l_int|0
)paren
suffix:semicolon
)brace
multiline_comment|/*--------------------------------- entries ---------------------------------*/
DECL|function|zatm_init
r_static
r_int
id|__init
id|zatm_init
c_func
(paren
r_struct
id|atm_dev
op_star
id|dev
)paren
(brace
r_struct
id|zatm_dev
op_star
id|zatm_dev
suffix:semicolon
r_struct
id|pci_dev
op_star
id|pci_dev
suffix:semicolon
r_int
r_int
id|command
suffix:semicolon
r_int
r_char
id|revision
suffix:semicolon
r_int
id|error
comma
id|i
comma
id|last
suffix:semicolon
r_int
r_int
id|t0
comma
id|t1
comma
id|t2
suffix:semicolon
id|DPRINTK
c_func
(paren
l_string|&quot;&gt;zatm_init&bslash;n&quot;
)paren
suffix:semicolon
id|zatm_dev
op_assign
id|ZATM_DEV
c_func
(paren
id|dev
)paren
suffix:semicolon
id|pci_dev
op_assign
id|zatm_dev-&gt;pci_dev
suffix:semicolon
id|zatm_dev-&gt;base
op_assign
id|pci_resource_start
c_func
(paren
id|pci_dev
comma
l_int|0
)paren
suffix:semicolon
id|zatm_dev-&gt;irq
op_assign
id|pci_dev-&gt;irq
suffix:semicolon
r_if
c_cond
(paren
(paren
id|error
op_assign
id|pci_read_config_word
c_func
(paren
id|pci_dev
comma
id|PCI_COMMAND
comma
op_amp
id|command
)paren
)paren
op_logical_or
(paren
id|error
op_assign
id|pci_read_config_byte
c_func
(paren
id|pci_dev
comma
id|PCI_REVISION_ID
comma
op_amp
id|revision
)paren
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
id|DEV_LABEL
l_string|&quot;(itf %d): init error 0x%02x&bslash;n&quot;
comma
id|dev-&gt;number
comma
id|error
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|error
op_assign
id|pci_write_config_word
c_func
(paren
id|pci_dev
comma
id|PCI_COMMAND
comma
id|command
op_or
id|PCI_COMMAND_IO
op_or
id|PCI_COMMAND_MASTER
)paren
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
id|DEV_LABEL
l_string|&quot;(itf %d): can&squot;t enable IO (0x%02x)&quot;
l_string|&quot;&bslash;n&quot;
comma
id|dev-&gt;number
comma
id|error
)paren
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
id|eprom_get_esi
c_func
(paren
id|dev
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_NOTICE
id|DEV_LABEL
l_string|&quot;(itf %d): rev.%d,base=0x%x,irq=%d,&quot;
comma
id|dev-&gt;number
comma
id|revision
comma
id|zatm_dev-&gt;base
comma
id|zatm_dev-&gt;irq
)paren
suffix:semicolon
multiline_comment|/* reset uPD98401 */
id|zout
c_func
(paren
l_int|0
comma
id|SWR
)paren
suffix:semicolon
r_while
c_loop
(paren
op_logical_neg
(paren
id|zin
c_func
(paren
id|GSR
)paren
op_amp
id|uPD98401_INT_IND
)paren
)paren
suffix:semicolon
id|zout
c_func
(paren
id|uPD98401_GMR_ONE
multiline_comment|/*uPD98401_BURST4*/
comma
id|GMR
)paren
suffix:semicolon
id|last
op_assign
id|MAX_CRAM_SIZE
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
id|last
op_minus
id|RAM_INCREMENT
suffix:semicolon
id|i
op_ge
l_int|0
suffix:semicolon
id|i
op_sub_assign
id|RAM_INCREMENT
)paren
(brace
id|zpokel
c_func
(paren
id|zatm_dev
comma
l_int|0x55555555
comma
id|i
)paren
suffix:semicolon
r_if
c_cond
(paren
id|zpeekl
c_func
(paren
id|zatm_dev
comma
id|i
)paren
op_ne
l_int|0x55555555
)paren
id|last
op_assign
id|i
suffix:semicolon
r_else
(brace
id|zpokel
c_func
(paren
id|zatm_dev
comma
l_int|0xAAAAAAAA
comma
id|i
)paren
suffix:semicolon
r_if
c_cond
(paren
id|zpeekl
c_func
(paren
id|zatm_dev
comma
id|i
)paren
op_ne
l_int|0xAAAAAAAA
)paren
id|last
op_assign
id|i
suffix:semicolon
r_else
id|zpokel
c_func
(paren
id|zatm_dev
comma
id|i
comma
id|i
)paren
suffix:semicolon
)brace
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|last
suffix:semicolon
id|i
op_add_assign
id|RAM_INCREMENT
)paren
r_if
c_cond
(paren
id|zpeekl
c_func
(paren
id|zatm_dev
comma
id|i
)paren
op_ne
id|i
)paren
r_break
suffix:semicolon
id|zatm_dev-&gt;mem
op_assign
id|i
op_lshift
l_int|2
suffix:semicolon
r_while
c_loop
(paren
id|i
)paren
id|zpokel
c_func
(paren
id|zatm_dev
comma
l_int|0
comma
op_decrement
id|i
)paren
suffix:semicolon
multiline_comment|/* reset again to rebuild memory pointers */
id|zout
c_func
(paren
l_int|0
comma
id|SWR
)paren
suffix:semicolon
r_while
c_loop
(paren
op_logical_neg
(paren
id|zin
c_func
(paren
id|GSR
)paren
op_amp
id|uPD98401_INT_IND
)paren
)paren
suffix:semicolon
id|zout
c_func
(paren
id|uPD98401_GMR_ONE
op_or
id|uPD98401_BURST8
op_or
id|uPD98401_BURST4
op_or
id|uPD98401_BURST2
op_or
id|uPD98401_GMR_PM
op_or
id|uPD98401_GMR_DR
comma
id|GMR
)paren
suffix:semicolon
multiline_comment|/* TODO: should shrink allocation now */
id|printk
c_func
(paren
l_string|&quot;mem=%dkB,%s (&quot;
comma
id|zatm_dev-&gt;mem
op_rshift
l_int|10
comma
id|zatm_dev-&gt;copper
ques
c_cond
l_string|&quot;UTP&quot;
suffix:colon
l_string|&quot;MMF&quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|ESI_LEN
suffix:semicolon
id|i
op_increment
)paren
id|printk
c_func
(paren
l_string|&quot;%02X%s&quot;
comma
id|dev-&gt;esi
(braket
id|i
)braket
comma
id|i
op_eq
id|ESI_LEN
op_minus
l_int|1
ques
c_cond
l_string|&quot;)&bslash;n&quot;
suffix:colon
l_string|&quot;-&quot;
)paren
suffix:semicolon
r_do
(brace
r_int
r_int
id|flags
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|t0
op_assign
id|zpeekl
c_func
(paren
id|zatm_dev
comma
id|uPD98401_TSR
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|10
)paren
suffix:semicolon
id|t1
op_assign
id|zpeekl
c_func
(paren
id|zatm_dev
comma
id|uPD98401_TSR
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|1010
)paren
suffix:semicolon
id|t2
op_assign
id|zpeekl
c_func
(paren
id|zatm_dev
comma
id|uPD98401_TSR
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
id|t0
OG
id|t1
op_logical_or
id|t1
OG
id|t2
)paren
suffix:semicolon
multiline_comment|/* loop if wrapping ... */
id|zatm_dev-&gt;khz
op_assign
id|t2
op_minus
l_int|2
op_star
id|t1
op_plus
id|t0
suffix:semicolon
id|printk
c_func
(paren
id|KERN_NOTICE
id|DEV_LABEL
l_string|&quot;(itf %d): uPD98401 %d.%d at %d.%03d &quot;
l_string|&quot;MHz&bslash;n&quot;
comma
id|dev-&gt;number
comma
(paren
id|zin
c_func
(paren
id|VER
)paren
op_amp
id|uPD98401_MAJOR
)paren
op_rshift
id|uPD98401_MAJOR_SHIFT
comma
id|zin
c_func
(paren
id|VER
)paren
op_amp
id|uPD98401_MINOR
comma
id|zatm_dev-&gt;khz
op_div
l_int|1000
comma
id|zatm_dev-&gt;khz
op_mod
l_int|1000
)paren
suffix:semicolon
macro_line|#ifdef CONFIG_ATM_ZATM_EXACT_TS
id|zatm_clock_init
c_func
(paren
id|zatm_dev
)paren
suffix:semicolon
macro_line|#endif
r_return
id|uPD98402_init
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
DECL|function|zatm_start
r_static
r_int
id|__init
id|zatm_start
c_func
(paren
r_struct
id|atm_dev
op_star
id|dev
)paren
(brace
r_struct
id|zatm_dev
op_star
id|zatm_dev
suffix:semicolon
r_int
r_int
id|curr
suffix:semicolon
r_int
id|pools
comma
id|vccs
comma
id|rx
suffix:semicolon
r_int
id|error
comma
id|i
comma
id|ld
suffix:semicolon
id|DPRINTK
c_func
(paren
l_string|&quot;zatm_start&bslash;n&quot;
)paren
suffix:semicolon
id|zatm_dev
op_assign
id|ZATM_DEV
c_func
(paren
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|request_irq
c_func
(paren
id|zatm_dev-&gt;irq
comma
op_amp
id|zatm_int
comma
id|SA_SHIRQ
comma
id|DEV_LABEL
comma
id|dev
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
id|DEV_LABEL
l_string|&quot;(itf %d): IRQ%d is already in use&bslash;n&quot;
comma
id|dev-&gt;number
comma
id|zatm_dev-&gt;irq
)paren
suffix:semicolon
r_return
op_minus
id|EAGAIN
suffix:semicolon
)brace
id|request_region
c_func
(paren
id|zatm_dev-&gt;base
comma
id|uPD98401_PORTS
comma
id|DEV_LABEL
)paren
suffix:semicolon
multiline_comment|/* define memory regions */
id|pools
op_assign
id|NR_POOLS
suffix:semicolon
r_if
c_cond
(paren
id|NR_SHAPERS
op_star
id|SHAPER_SIZE
OG
id|pools
op_star
id|POOL_SIZE
)paren
id|pools
op_assign
id|NR_SHAPERS
op_star
id|SHAPER_SIZE
op_div
id|POOL_SIZE
suffix:semicolon
id|vccs
op_assign
(paren
id|zatm_dev-&gt;mem
op_minus
id|NR_SHAPERS
op_star
id|SHAPER_SIZE
op_minus
id|pools
op_star
id|POOL_SIZE
)paren
op_div
(paren
l_int|2
op_star
id|VC_SIZE
op_plus
id|RX_SIZE
)paren
suffix:semicolon
id|ld
op_assign
op_minus
l_int|1
suffix:semicolon
r_for
c_loop
(paren
id|rx
op_assign
l_int|1
suffix:semicolon
id|rx
OL
id|vccs
suffix:semicolon
id|rx
op_lshift_assign
l_int|1
)paren
id|ld
op_increment
suffix:semicolon
id|dev-&gt;ci_range.vpi_bits
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* @@@ no VPI for now */
id|dev-&gt;ci_range.vci_bits
op_assign
id|ld
suffix:semicolon
id|dev-&gt;link_rate
op_assign
id|ATM_OC3_PCR
suffix:semicolon
id|zatm_dev-&gt;chans
op_assign
id|vccs
suffix:semicolon
multiline_comment|/* ??? */
id|curr
op_assign
id|rx
op_star
id|RX_SIZE
op_div
l_int|4
suffix:semicolon
id|DPRINTK
c_func
(paren
l_string|&quot;RX pool 0x%08lx&bslash;n&quot;
comma
id|curr
)paren
suffix:semicolon
id|zpokel
c_func
(paren
id|zatm_dev
comma
id|curr
comma
id|uPD98401_PMA
)paren
suffix:semicolon
multiline_comment|/* receive pool */
id|zatm_dev-&gt;pool_base
op_assign
id|curr
suffix:semicolon
id|curr
op_add_assign
id|pools
op_star
id|POOL_SIZE
op_div
l_int|4
suffix:semicolon
id|DPRINTK
c_func
(paren
l_string|&quot;Shapers 0x%08lx&bslash;n&quot;
comma
id|curr
)paren
suffix:semicolon
id|zpokel
c_func
(paren
id|zatm_dev
comma
id|curr
comma
id|uPD98401_SMA
)paren
suffix:semicolon
multiline_comment|/* shapers */
id|curr
op_add_assign
id|NR_SHAPERS
op_star
id|SHAPER_SIZE
op_div
l_int|4
suffix:semicolon
id|DPRINTK
c_func
(paren
l_string|&quot;Free    0x%08lx&bslash;n&quot;
comma
id|curr
)paren
suffix:semicolon
id|zpokel
c_func
(paren
id|zatm_dev
comma
id|curr
comma
id|uPD98401_TOS
)paren
suffix:semicolon
multiline_comment|/* free pool */
id|printk
c_func
(paren
id|KERN_INFO
id|DEV_LABEL
l_string|&quot;(itf %d): %d shapers, %d pools, %d RX, &quot;
l_string|&quot;%ld VCs&bslash;n&quot;
comma
id|dev-&gt;number
comma
id|NR_SHAPERS
comma
id|pools
comma
id|rx
comma
(paren
id|zatm_dev-&gt;mem
op_minus
id|curr
op_star
l_int|4
)paren
op_div
id|VC_SIZE
)paren
suffix:semicolon
multiline_comment|/* create mailboxes */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|NR_MBX
suffix:semicolon
id|i
op_increment
)paren
id|zatm_dev-&gt;mbx_start
(braket
id|i
)braket
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|NR_MBX
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
id|mbx_entries
(braket
id|i
)braket
)paren
(brace
r_int
r_int
id|here
suffix:semicolon
id|here
op_assign
(paren
r_int
r_int
)paren
id|kmalloc
c_func
(paren
l_int|2
op_star
id|MBX_SIZE
c_func
(paren
id|i
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|here
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
r_if
c_cond
(paren
(paren
id|here
op_xor
(paren
id|here
op_plus
id|MBX_SIZE
c_func
(paren
id|i
)paren
)paren
)paren
op_amp
op_complement
l_int|0xffffUL
)paren
multiline_comment|/* paranoia */
id|here
op_assign
(paren
id|here
op_amp
op_complement
l_int|0xffffUL
)paren
op_plus
l_int|0x10000
suffix:semicolon
r_if
c_cond
(paren
(paren
id|here
op_xor
id|virt_to_bus
c_func
(paren
(paren
r_void
op_star
)paren
id|here
)paren
)paren
op_amp
l_int|0xffff
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
id|DEV_LABEL
l_string|&quot;(itf %d): system &quot;
l_string|&quot;bus incompatible with driver&bslash;n&quot;
comma
id|dev-&gt;number
)paren
suffix:semicolon
id|kfree
c_func
(paren
(paren
r_void
op_star
)paren
id|here
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
id|DPRINTK
c_func
(paren
l_string|&quot;mbx@0x%08lx-0x%08lx&bslash;n&quot;
comma
id|here
comma
id|here
op_plus
id|MBX_SIZE
c_func
(paren
id|i
)paren
)paren
suffix:semicolon
id|zatm_dev-&gt;mbx_start
(braket
id|i
)braket
op_assign
id|here
suffix:semicolon
id|zatm_dev-&gt;mbx_end
(braket
id|i
)braket
op_assign
(paren
id|here
op_plus
id|MBX_SIZE
c_func
(paren
id|i
)paren
)paren
op_amp
l_int|0xffff
suffix:semicolon
id|zout
c_func
(paren
id|virt_to_bus
c_func
(paren
(paren
r_void
op_star
)paren
id|here
)paren
op_rshift
l_int|16
comma
id|MSH
c_func
(paren
id|i
)paren
)paren
suffix:semicolon
id|zout
c_func
(paren
id|virt_to_bus
c_func
(paren
(paren
r_void
op_star
)paren
id|here
)paren
comma
id|MSL
c_func
(paren
id|i
)paren
)paren
suffix:semicolon
id|zout
c_func
(paren
(paren
id|here
op_plus
id|MBX_SIZE
c_func
(paren
id|i
)paren
)paren
op_amp
l_int|0xffff
comma
id|MBA
c_func
(paren
id|i
)paren
)paren
suffix:semicolon
id|zout
c_func
(paren
id|here
op_amp
l_int|0xffff
comma
id|MTA
c_func
(paren
id|i
)paren
)paren
suffix:semicolon
id|zout
c_func
(paren
id|here
op_amp
l_int|0xffff
comma
id|MWA
c_func
(paren
id|i
)paren
)paren
suffix:semicolon
)brace
id|error
op_assign
id|start_tx
c_func
(paren
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
)paren
r_return
id|error
suffix:semicolon
id|error
op_assign
id|start_rx
c_func
(paren
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
)paren
r_return
id|error
suffix:semicolon
id|error
op_assign
id|dev-&gt;phy
op_member_access_from_pointer
id|start
c_func
(paren
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
)paren
r_return
id|error
suffix:semicolon
id|zout
c_func
(paren
l_int|0xffffffff
comma
id|IMR
)paren
suffix:semicolon
multiline_comment|/* enable interrupts */
multiline_comment|/* enable TX &amp; RX */
id|zout
c_func
(paren
id|zin
c_func
(paren
id|GMR
)paren
op_or
id|uPD98401_GMR_SE
op_or
id|uPD98401_GMR_RE
comma
id|GMR
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|zatm_close
r_static
r_void
id|zatm_close
c_func
(paren
r_struct
id|atm_vcc
op_star
id|vcc
)paren
(brace
id|DPRINTK
c_func
(paren
l_string|&quot;&gt;zatm_close&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ZATM_VCC
c_func
(paren
id|vcc
)paren
)paren
r_return
suffix:semicolon
id|clear_bit
c_func
(paren
id|ATM_VF_READY
comma
op_amp
id|vcc-&gt;flags
)paren
suffix:semicolon
id|close_rx
c_func
(paren
id|vcc
)paren
suffix:semicolon
id|EVENT
c_func
(paren
l_string|&quot;close_tx&bslash;n&quot;
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
id|close_tx
c_func
(paren
id|vcc
)paren
suffix:semicolon
id|DPRINTK
c_func
(paren
l_string|&quot;zatm_close: done waiting&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* deallocate memory */
id|kfree
c_func
(paren
id|ZATM_VCC
c_func
(paren
id|vcc
)paren
)paren
suffix:semicolon
id|ZATM_VCC
c_func
(paren
id|vcc
)paren
op_assign
l_int|NULL
suffix:semicolon
id|clear_bit
c_func
(paren
id|ATM_VF_ADDR
comma
op_amp
id|vcc-&gt;flags
)paren
suffix:semicolon
)brace
DECL|function|zatm_open
r_static
r_int
id|zatm_open
c_func
(paren
r_struct
id|atm_vcc
op_star
id|vcc
comma
r_int
id|vpi
comma
r_int
id|vci
)paren
(brace
r_struct
id|zatm_dev
op_star
id|zatm_dev
suffix:semicolon
r_struct
id|zatm_vcc
op_star
id|zatm_vcc
suffix:semicolon
r_int
id|error
suffix:semicolon
id|DPRINTK
c_func
(paren
l_string|&quot;&gt;zatm_open&bslash;n&quot;
)paren
suffix:semicolon
id|zatm_dev
op_assign
id|ZATM_DEV
c_func
(paren
id|vcc-&gt;dev
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|test_bit
c_func
(paren
id|ATM_VF_PARTIAL
comma
op_amp
id|vcc-&gt;flags
)paren
)paren
id|ZATM_VCC
c_func
(paren
id|vcc
)paren
op_assign
l_int|NULL
suffix:semicolon
id|error
op_assign
id|atm_find_ci
c_func
(paren
id|vcc
comma
op_amp
id|vpi
comma
op_amp
id|vci
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
)paren
r_return
id|error
suffix:semicolon
id|vcc-&gt;vpi
op_assign
id|vpi
suffix:semicolon
id|vcc-&gt;vci
op_assign
id|vci
suffix:semicolon
r_if
c_cond
(paren
id|vci
op_ne
id|ATM_VPI_UNSPEC
op_logical_and
id|vpi
op_ne
id|ATM_VCI_UNSPEC
)paren
id|set_bit
c_func
(paren
id|ATM_VF_ADDR
comma
op_amp
id|vcc-&gt;flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|vcc-&gt;qos.aal
op_ne
id|ATM_AAL5
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
multiline_comment|/* @@@ AAL0 */
id|DPRINTK
c_func
(paren
id|DEV_LABEL
l_string|&quot;(itf %d): open %d.%d&bslash;n&quot;
comma
id|vcc-&gt;dev-&gt;number
comma
id|vcc-&gt;vpi
comma
id|vcc-&gt;vci
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|test_bit
c_func
(paren
id|ATM_VF_PARTIAL
comma
op_amp
id|vcc-&gt;flags
)paren
)paren
(brace
id|zatm_vcc
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|zatm_vcc
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|zatm_vcc
)paren
(brace
id|clear_bit
c_func
(paren
id|ATM_VF_ADDR
comma
op_amp
id|vcc-&gt;flags
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|ZATM_VCC
c_func
(paren
id|vcc
)paren
op_assign
id|zatm_vcc
suffix:semicolon
id|ZATM_VCC
c_func
(paren
id|vcc
)paren
op_member_access_from_pointer
id|tx_chan
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* for zatm_close after open_rx */
r_if
c_cond
(paren
(paren
id|error
op_assign
id|open_rx_first
c_func
(paren
id|vcc
)paren
)paren
)paren
(brace
id|zatm_close
c_func
(paren
id|vcc
)paren
suffix:semicolon
r_return
id|error
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|error
op_assign
id|open_tx_first
c_func
(paren
id|vcc
)paren
)paren
)paren
(brace
id|zatm_close
c_func
(paren
id|vcc
)paren
suffix:semicolon
r_return
id|error
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|vci
op_eq
id|ATM_VPI_UNSPEC
op_logical_or
id|vpi
op_eq
id|ATM_VCI_UNSPEC
)paren
r_return
l_int|0
suffix:semicolon
r_if
c_cond
(paren
(paren
id|error
op_assign
id|open_rx_second
c_func
(paren
id|vcc
)paren
)paren
)paren
(brace
id|zatm_close
c_func
(paren
id|vcc
)paren
suffix:semicolon
r_return
id|error
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|error
op_assign
id|open_tx_second
c_func
(paren
id|vcc
)paren
)paren
)paren
(brace
id|zatm_close
c_func
(paren
id|vcc
)paren
suffix:semicolon
r_return
id|error
suffix:semicolon
)brace
id|set_bit
c_func
(paren
id|ATM_VF_READY
comma
op_amp
id|vcc-&gt;flags
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|zatm_change_qos
r_static
r_int
id|zatm_change_qos
c_func
(paren
r_struct
id|atm_vcc
op_star
id|vcc
comma
r_struct
id|atm_qos
op_star
id|qos
comma
r_int
id|flags
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;Not yet implemented&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENOSYS
suffix:semicolon
multiline_comment|/* @@@ */
)brace
DECL|function|zatm_ioctl
r_static
r_int
id|zatm_ioctl
c_func
(paren
r_struct
id|atm_dev
op_star
id|dev
comma
r_int
r_int
id|cmd
comma
r_void
op_star
id|arg
)paren
(brace
r_struct
id|zatm_dev
op_star
id|zatm_dev
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|zatm_dev
op_assign
id|ZATM_DEV
c_func
(paren
id|dev
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|cmd
)paren
(brace
r_case
id|ZATM_GETPOOLZ
suffix:colon
r_if
c_cond
(paren
op_logical_neg
id|capable
c_func
(paren
id|CAP_NET_ADMIN
)paren
)paren
r_return
op_minus
id|EPERM
suffix:semicolon
multiline_comment|/* fall through */
r_case
id|ZATM_GETPOOL
suffix:colon
(brace
r_struct
id|zatm_pool_info
id|info
suffix:semicolon
r_int
id|pool
suffix:semicolon
r_if
c_cond
(paren
id|get_user
c_func
(paren
id|pool
comma
op_amp
(paren
(paren
r_struct
id|zatm_pool_req
op_star
)paren
id|arg
)paren
op_member_access_from_pointer
id|pool_num
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_if
c_cond
(paren
id|pool
template_param
id|ZATM_LAST_POOL
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|info
op_assign
id|zatm_dev-&gt;pool_info
(braket
id|pool
)braket
suffix:semicolon
r_if
c_cond
(paren
id|cmd
op_eq
id|ZATM_GETPOOLZ
)paren
(brace
id|zatm_dev-&gt;pool_info
(braket
id|pool
)braket
dot
id|rqa_count
op_assign
l_int|0
suffix:semicolon
id|zatm_dev-&gt;pool_info
(braket
id|pool
)braket
dot
id|rqu_count
op_assign
l_int|0
suffix:semicolon
)brace
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
id|copy_to_user
c_func
(paren
op_amp
(paren
(paren
r_struct
id|zatm_pool_req
op_star
)paren
id|arg
)paren
op_member_access_from_pointer
id|info
comma
op_amp
id|info
comma
r_sizeof
(paren
id|info
)paren
)paren
ques
c_cond
op_minus
id|EFAULT
suffix:colon
l_int|0
suffix:semicolon
)brace
r_case
id|ZATM_SETPOOL
suffix:colon
(brace
r_struct
id|zatm_pool_info
id|info
suffix:semicolon
r_int
id|pool
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|capable
c_func
(paren
id|CAP_NET_ADMIN
)paren
)paren
r_return
op_minus
id|EPERM
suffix:semicolon
r_if
c_cond
(paren
id|get_user
c_func
(paren
id|pool
comma
op_amp
(paren
(paren
r_struct
id|zatm_pool_req
op_star
)paren
id|arg
)paren
op_member_access_from_pointer
id|pool_num
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_if
c_cond
(paren
id|pool
template_param
id|ZATM_LAST_POOL
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|info
comma
op_amp
(paren
(paren
r_struct
id|zatm_pool_req
op_star
)paren
id|arg
)paren
op_member_access_from_pointer
id|info
comma
r_sizeof
(paren
id|info
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|info.low_water
)paren
id|info.low_water
op_assign
id|zatm_dev
op_member_access_from_pointer
id|pool_info
(braket
id|pool
)braket
dot
id|low_water
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|info.high_water
)paren
id|info.high_water
op_assign
id|zatm_dev
op_member_access_from_pointer
id|pool_info
(braket
id|pool
)braket
dot
id|high_water
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|info.next_thres
)paren
id|info.next_thres
op_assign
id|zatm_dev
op_member_access_from_pointer
id|pool_info
(braket
id|pool
)braket
dot
id|next_thres
suffix:semicolon
r_if
c_cond
(paren
id|info.low_water
op_ge
id|info.high_water
op_logical_or
id|info.low_water
OL
l_int|0
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|zatm_dev-&gt;pool_info
(braket
id|pool
)braket
dot
id|low_water
op_assign
id|info.low_water
suffix:semicolon
id|zatm_dev-&gt;pool_info
(braket
id|pool
)braket
dot
id|high_water
op_assign
id|info.high_water
suffix:semicolon
id|zatm_dev-&gt;pool_info
(braket
id|pool
)braket
dot
id|next_thres
op_assign
id|info.next_thres
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#ifdef CONFIG_ATM_ZATM_EXACT_TS
r_case
id|ZATM_GETTHIST
suffix:colon
(brace
r_int
id|i
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|ZATM_TIMER_HISTORY_SIZE
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|copy_to_user
c_func
(paren
(paren
r_struct
id|zatm_t_hist
op_star
)paren
id|arg
op_plus
id|i
comma
op_amp
id|zatm_dev-&gt;timer_history
(braket
(paren
id|zatm_dev-&gt;th_curr
op_plus
id|i
)paren
op_amp
(paren
id|ZATM_TIMER_HISTORY_SIZE
op_minus
l_int|1
)paren
)braket
comma
r_sizeof
(paren
r_struct
id|zatm_t_hist
)paren
)paren
)paren
r_continue
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#endif
r_default
suffix:colon
(brace
)brace
r_if
c_cond
(paren
op_logical_neg
id|dev-&gt;phy-&gt;ioctl
)paren
r_return
op_minus
id|ENOIOCTLCMD
suffix:semicolon
r_return
id|dev-&gt;phy
op_member_access_from_pointer
id|ioctl
c_func
(paren
id|dev
comma
id|cmd
comma
id|arg
)paren
suffix:semicolon
)brace
)brace
DECL|function|zatm_getsockopt
r_static
r_int
id|zatm_getsockopt
c_func
(paren
r_struct
id|atm_vcc
op_star
id|vcc
comma
r_int
id|level
comma
r_int
id|optname
comma
r_void
op_star
id|optval
comma
r_int
id|optlen
)paren
(brace
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
DECL|function|zatm_setsockopt
r_static
r_int
id|zatm_setsockopt
c_func
(paren
r_struct
id|atm_vcc
op_star
id|vcc
comma
r_int
id|level
comma
r_int
id|optname
comma
r_void
op_star
id|optval
comma
r_int
id|optlen
)paren
(brace
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
macro_line|#if 0
r_static
r_int
id|zatm_sg_send
c_func
(paren
r_struct
id|atm_vcc
op_star
id|vcc
comma
r_int
r_int
id|start
comma
r_int
r_int
id|size
)paren
(brace
r_return
id|vcc-&gt;aal
op_eq
id|ATM_AAL5
suffix:semicolon
multiline_comment|/* @@@ should check size and maybe alignment*/
)brace
macro_line|#endif
DECL|function|zatm_send
r_static
r_int
id|zatm_send
c_func
(paren
r_struct
id|atm_vcc
op_star
id|vcc
comma
r_struct
id|sk_buff
op_star
id|skb
)paren
(brace
r_int
id|error
suffix:semicolon
id|EVENT
c_func
(paren
l_string|&quot;&gt;zatm_send 0x%lx&bslash;n&quot;
comma
(paren
r_int
r_int
)paren
id|skb
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ZATM_VCC
c_func
(paren
id|vcc
)paren
op_member_access_from_pointer
id|tx_chan
op_logical_or
op_logical_neg
id|test_bit
c_func
(paren
id|ATM_VF_READY
comma
op_amp
id|vcc-&gt;flags
)paren
)paren
(brace
r_if
c_cond
(paren
id|vcc-&gt;pop
)paren
id|vcc
op_member_access_from_pointer
id|pop
c_func
(paren
id|vcc
comma
id|skb
)paren
suffix:semicolon
r_else
id|dev_kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|skb
)paren
(brace
id|printk
c_func
(paren
id|KERN_CRIT
l_string|&quot;!skb in zatm_send ?&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|vcc-&gt;pop
)paren
id|vcc
op_member_access_from_pointer
id|pop
c_func
(paren
id|vcc
comma
id|skb
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|ATM_SKB
c_func
(paren
id|skb
)paren
op_member_access_from_pointer
id|vcc
op_assign
id|vcc
suffix:semicolon
id|error
op_assign
id|do_tx
c_func
(paren
id|skb
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
op_ne
id|RING_BUSY
)paren
r_return
id|error
suffix:semicolon
id|skb_queue_tail
c_func
(paren
op_amp
id|ZATM_VCC
c_func
(paren
id|vcc
)paren
op_member_access_from_pointer
id|backlog
comma
id|skb
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|zatm_phy_put
r_static
r_void
id|zatm_phy_put
c_func
(paren
r_struct
id|atm_dev
op_star
id|dev
comma
r_int
r_char
id|value
comma
r_int
r_int
id|addr
)paren
(brace
r_struct
id|zatm_dev
op_star
id|zatm_dev
suffix:semicolon
id|zatm_dev
op_assign
id|ZATM_DEV
c_func
(paren
id|dev
)paren
suffix:semicolon
id|zwait
suffix:semicolon
id|zout
c_func
(paren
id|value
comma
id|CER
)paren
suffix:semicolon
id|zout
c_func
(paren
id|uPD98401_IND_ACC
op_or
id|uPD98401_IA_B0
op_or
(paren
id|uPD98401_IA_TGT_PHY
op_lshift
id|uPD98401_IA_TGT_SHIFT
)paren
op_or
id|addr
comma
id|CMR
)paren
suffix:semicolon
)brace
DECL|function|zatm_phy_get
r_static
r_int
r_char
id|zatm_phy_get
c_func
(paren
r_struct
id|atm_dev
op_star
id|dev
comma
r_int
r_int
id|addr
)paren
(brace
r_struct
id|zatm_dev
op_star
id|zatm_dev
suffix:semicolon
id|zatm_dev
op_assign
id|ZATM_DEV
c_func
(paren
id|dev
)paren
suffix:semicolon
id|zwait
suffix:semicolon
id|zout
c_func
(paren
id|uPD98401_IND_ACC
op_or
id|uPD98401_IA_B0
op_or
id|uPD98401_IA_RW
op_or
(paren
id|uPD98401_IA_TGT_PHY
op_lshift
id|uPD98401_IA_TGT_SHIFT
)paren
op_or
id|addr
comma
id|CMR
)paren
suffix:semicolon
id|zwait
suffix:semicolon
r_return
id|zin
c_func
(paren
id|CER
)paren
op_amp
l_int|0xff
suffix:semicolon
)brace
DECL|variable|ops
r_static
r_const
r_struct
id|atmdev_ops
id|ops
op_assign
(brace
id|open
suffix:colon
id|zatm_open
comma
id|close
suffix:colon
id|zatm_close
comma
id|ioctl
suffix:colon
id|zatm_ioctl
comma
id|getsockopt
suffix:colon
id|zatm_getsockopt
comma
id|setsockopt
suffix:colon
id|zatm_setsockopt
comma
id|send
suffix:colon
id|zatm_send
comma
multiline_comment|/*zatm_sg_send*/
id|phy_put
suffix:colon
id|zatm_phy_put
comma
id|phy_get
suffix:colon
id|zatm_phy_get
comma
id|feedback
suffix:colon
id|zatm_feedback
comma
id|change_qos
suffix:colon
id|zatm_change_qos
comma
)brace
suffix:semicolon
DECL|function|zatm_detect
r_int
id|__init
id|zatm_detect
c_func
(paren
r_void
)paren
(brace
r_struct
id|atm_dev
op_star
id|dev
suffix:semicolon
r_struct
id|zatm_dev
op_star
id|zatm_dev
suffix:semicolon
r_int
id|devs
comma
id|type
suffix:semicolon
id|zatm_dev
op_assign
(paren
r_struct
id|zatm_dev
op_star
)paren
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|zatm_dev
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|zatm_dev
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|devs
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|type
op_assign
l_int|0
suffix:semicolon
id|type
OL
l_int|2
suffix:semicolon
id|type
op_increment
)paren
(brace
r_struct
id|pci_dev
op_star
id|pci_dev
suffix:semicolon
id|pci_dev
op_assign
l_int|NULL
suffix:semicolon
r_while
c_loop
(paren
(paren
id|pci_dev
op_assign
id|pci_find_device
c_func
(paren
id|PCI_VENDOR_ID_ZEITNET
comma
id|type
ques
c_cond
id|PCI_DEVICE_ID_ZEITNET_1225
suffix:colon
id|PCI_DEVICE_ID_ZEITNET_1221
comma
id|pci_dev
)paren
)paren
)paren
(brace
r_if
c_cond
(paren
id|pci_enable_device
c_func
(paren
id|pci_dev
)paren
)paren
r_break
suffix:semicolon
id|dev
op_assign
id|atm_dev_register
c_func
(paren
id|DEV_LABEL
comma
op_amp
id|ops
comma
op_minus
l_int|1
comma
l_int|NULL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dev
)paren
r_break
suffix:semicolon
id|zatm_dev-&gt;pci_dev
op_assign
id|pci_dev
suffix:semicolon
id|ZATM_DEV
c_func
(paren
id|dev
)paren
op_assign
id|zatm_dev
suffix:semicolon
id|zatm_dev-&gt;copper
op_assign
id|type
suffix:semicolon
r_if
c_cond
(paren
id|zatm_init
c_func
(paren
id|dev
)paren
op_logical_or
id|zatm_start
c_func
(paren
id|dev
)paren
)paren
(brace
id|atm_dev_deregister
c_func
(paren
id|dev
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|zatm_dev-&gt;more
op_assign
id|zatm_boards
suffix:semicolon
id|zatm_boards
op_assign
id|dev
suffix:semicolon
id|devs
op_increment
suffix:semicolon
id|zatm_dev
op_assign
(paren
r_struct
id|zatm_dev
op_star
)paren
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|zatm_dev
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|zatm_dev
)paren
r_break
suffix:semicolon
)brace
)brace
r_return
id|devs
suffix:semicolon
)brace
macro_line|#ifdef MODULE
DECL|function|init_module
r_int
id|init_module
c_func
(paren
r_void
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|zatm_detect
c_func
(paren
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
id|DEV_LABEL
l_string|&quot;: no adapter found&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENXIO
suffix:semicolon
)brace
id|MOD_INC_USE_COUNT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|cleanup_module
r_void
id|cleanup_module
c_func
(paren
r_void
)paren
(brace
multiline_comment|/*&n;&t; * Well, there&squot;s no way to get rid of the driver yet, so we don&squot;t&n;&t; * have to clean up, right ? :-)&n;&t; */
)brace
macro_line|#endif
eof
