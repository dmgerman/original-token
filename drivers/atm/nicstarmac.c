multiline_comment|/*&n; * this file included by nicstar.c&n; */
multiline_comment|/*&n; * nicstarmac.c&n; * Read this ForeRunner&squot;s MAC address from eprom/eeprom&n; */
DECL|macro|CYCLE_DELAY
mdefine_line|#define CYCLE_DELAY 5
multiline_comment|/* This was the original definition&n;#define osp_MicroDelay(microsec) &bslash;&n;    do { int _i = 4*microsec; while (--_i &gt; 0) { __SLOW_DOWN_IO; }} while (0)&n;*/
DECL|macro|osp_MicroDelay
mdefine_line|#define osp_MicroDelay(microsec) {unsigned long useconds = (microsec); &bslash;&n;                                  udelay((useconds));}
multiline_comment|/* The following tables represent the timing diagrams found in&n; * the Data Sheet for the Xicor X25020 EEProm.  The #defines below&n; * represent the bits in the NICStAR&squot;s General Purpose register&n; * that must be toggled for the corresponding actions on the EEProm&n; * to occur.&n; */
multiline_comment|/* Write Data To EEProm from SI line on rising edge of CLK */
multiline_comment|/* Read Data From EEProm on falling edge of CLK */
DECL|macro|CS_HIGH
mdefine_line|#define CS_HIGH&t;&t;0x0002&t;&t;/* Chip select high */
DECL|macro|CS_LOW
mdefine_line|#define CS_LOW&t;&t;0x0000&t;&t;/* Chip select low (active low)*/
DECL|macro|CLK_HIGH
mdefine_line|#define CLK_HIGH&t;0x0004&t;&t;/* Clock high */
DECL|macro|CLK_LOW
mdefine_line|#define CLK_LOW&t;&t;0x0000&t;&t;/* Clock low  */
DECL|macro|SI_HIGH
mdefine_line|#define SI_HIGH&t;&t;0x0001&t;&t;/* Serial input data high */
DECL|macro|SI_LOW
mdefine_line|#define SI_LOW&t;&t;0x0000&t;&t;/* Serial input data low */
multiline_comment|/* Read Status Register = 0000 0101b */
DECL|variable|rdsrtab
r_static
id|u_int32_t
id|rdsrtab
(braket
)braket
op_assign
(brace
id|CS_HIGH
op_or
id|CLK_HIGH
comma
id|CS_LOW
op_or
id|CLK_LOW
comma
id|CLK_HIGH
comma
multiline_comment|/* 0 */
id|CLK_LOW
comma
id|CLK_HIGH
comma
multiline_comment|/* 0 */
id|CLK_LOW
comma
id|CLK_HIGH
comma
multiline_comment|/* 0 */
id|CLK_LOW
comma
id|CLK_HIGH
comma
multiline_comment|/* 0 */
id|CLK_LOW
comma
id|CLK_HIGH
comma
multiline_comment|/* 0 */
id|CLK_LOW
op_or
id|SI_HIGH
comma
id|CLK_HIGH
op_or
id|SI_HIGH
comma
multiline_comment|/* 1 */
id|CLK_LOW
op_or
id|SI_LOW
comma
id|CLK_HIGH
comma
multiline_comment|/* 0 */
id|CLK_LOW
op_or
id|SI_HIGH
comma
id|CLK_HIGH
op_or
id|SI_HIGH
multiline_comment|/* 1 */
)brace
suffix:semicolon
multiline_comment|/* Read from EEPROM = 0000 0011b */
DECL|variable|readtab
r_static
id|u_int32_t
id|readtab
(braket
)braket
op_assign
(brace
multiline_comment|/*&n;    CS_HIGH | CLK_HIGH, &n;    */
id|CS_LOW
op_or
id|CLK_LOW
comma
id|CLK_HIGH
comma
multiline_comment|/* 0 */
id|CLK_LOW
comma
id|CLK_HIGH
comma
multiline_comment|/* 0 */
id|CLK_LOW
comma
id|CLK_HIGH
comma
multiline_comment|/* 0 */
id|CLK_LOW
comma
id|CLK_HIGH
comma
multiline_comment|/* 0 */
id|CLK_LOW
comma
id|CLK_HIGH
comma
multiline_comment|/* 0 */
id|CLK_LOW
comma
id|CLK_HIGH
comma
multiline_comment|/* 0 */
id|CLK_LOW
op_or
id|SI_HIGH
comma
id|CLK_HIGH
op_or
id|SI_HIGH
comma
multiline_comment|/* 1 */
id|CLK_LOW
op_or
id|SI_HIGH
comma
id|CLK_HIGH
op_or
id|SI_HIGH
multiline_comment|/* 1 */
)brace
suffix:semicolon
multiline_comment|/* Clock to read from/write to the eeprom */
DECL|variable|clocktab
r_static
id|u_int32_t
id|clocktab
(braket
)braket
op_assign
(brace
id|CLK_LOW
comma
id|CLK_HIGH
comma
id|CLK_LOW
comma
id|CLK_HIGH
comma
id|CLK_LOW
comma
id|CLK_HIGH
comma
id|CLK_LOW
comma
id|CLK_HIGH
comma
id|CLK_LOW
comma
id|CLK_HIGH
comma
id|CLK_LOW
comma
id|CLK_HIGH
comma
id|CLK_LOW
comma
id|CLK_HIGH
comma
id|CLK_LOW
comma
id|CLK_HIGH
comma
id|CLK_LOW
)brace
suffix:semicolon
DECL|macro|NICSTAR_REG_WRITE
mdefine_line|#define NICSTAR_REG_WRITE(bs, reg, val) &bslash;&n;&t;while ( readl(bs + STAT) &amp; 0x0200 ) ; &bslash;&n;&t;writel((val),(base)+(reg))
DECL|macro|NICSTAR_REG_READ
mdefine_line|#define NICSTAR_REG_READ(bs, reg) &bslash;&n;&t;readl((base)+(reg))
DECL|macro|NICSTAR_REG_GENERAL_PURPOSE
mdefine_line|#define NICSTAR_REG_GENERAL_PURPOSE GP
multiline_comment|/*&n; * This routine will clock the Read_Status_reg function into the X2520&n; * eeprom, then pull the result from bit 16 of the NicSTaR&squot;s General Purpose &n; * register.  &n; */
id|u_int32_t
DECL|function|nicstar_read_eprom_status
id|nicstar_read_eprom_status
c_func
(paren
id|virt_addr_t
id|base
)paren
(brace
id|u_int32_t
id|val
suffix:semicolon
id|u_int32_t
id|rbyte
suffix:semicolon
r_int32
id|i
comma
id|j
suffix:semicolon
multiline_comment|/* Send read instruction */
id|val
op_assign
id|NICSTAR_REG_READ
c_func
(paren
id|base
comma
id|NICSTAR_REG_GENERAL_PURPOSE
)paren
op_amp
l_int|0xFFFFFFF0
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
r_sizeof
id|rdsrtab
op_div
r_sizeof
id|rdsrtab
(braket
l_int|0
)braket
suffix:semicolon
id|i
op_increment
)paren
(brace
id|NICSTAR_REG_WRITE
c_func
(paren
id|base
comma
id|NICSTAR_REG_GENERAL_PURPOSE
comma
(paren
id|val
op_or
id|rdsrtab
(braket
id|i
)braket
)paren
)paren
suffix:semicolon
id|osp_MicroDelay
c_func
(paren
id|CYCLE_DELAY
)paren
suffix:semicolon
)brace
multiline_comment|/* Done sending instruction - now pull data off of bit 16, MSB first */
multiline_comment|/* Data clocked out of eeprom on falling edge of clock */
id|rbyte
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|7
comma
id|j
op_assign
l_int|0
suffix:semicolon
id|i
op_ge
l_int|0
suffix:semicolon
id|i
op_decrement
)paren
(brace
id|NICSTAR_REG_WRITE
c_func
(paren
id|base
comma
id|NICSTAR_REG_GENERAL_PURPOSE
comma
(paren
id|val
op_or
id|clocktab
(braket
id|j
op_increment
)braket
)paren
)paren
suffix:semicolon
id|rbyte
op_or_assign
(paren
(paren
(paren
id|NICSTAR_REG_READ
c_func
(paren
id|base
comma
id|NICSTAR_REG_GENERAL_PURPOSE
)paren
op_amp
l_int|0x00010000
)paren
op_rshift
l_int|16
)paren
op_lshift
id|i
)paren
suffix:semicolon
id|NICSTAR_REG_WRITE
c_func
(paren
id|base
comma
id|NICSTAR_REG_GENERAL_PURPOSE
comma
(paren
id|val
op_or
id|clocktab
(braket
id|j
op_increment
)braket
)paren
)paren
suffix:semicolon
id|osp_MicroDelay
c_func
(paren
id|CYCLE_DELAY
)paren
suffix:semicolon
)brace
id|NICSTAR_REG_WRITE
c_func
(paren
id|base
comma
id|NICSTAR_REG_GENERAL_PURPOSE
comma
l_int|2
)paren
suffix:semicolon
id|osp_MicroDelay
c_func
(paren
id|CYCLE_DELAY
)paren
suffix:semicolon
r_return
id|rbyte
suffix:semicolon
)brace
multiline_comment|/*&n; * This routine will clock the Read_data function into the X2520&n; * eeprom, followed by the address to read from, through the NicSTaR&squot;s General&n; * Purpose register.  &n; */
r_static
id|u_int8_t
DECL|function|read_eprom_byte
id|read_eprom_byte
c_func
(paren
id|u_int32_t
id|base
comma
id|u_int8_t
id|offset
)paren
(brace
id|u_int32_t
id|val
op_assign
l_int|0
suffix:semicolon
r_int
id|i
comma
id|j
op_assign
l_int|0
suffix:semicolon
id|u_int8_t
id|tempread
op_assign
l_int|0
suffix:semicolon
id|val
op_assign
id|NICSTAR_REG_READ
c_func
(paren
id|base
comma
id|NICSTAR_REG_GENERAL_PURPOSE
)paren
op_amp
l_int|0xFFFFFFF0
suffix:semicolon
multiline_comment|/* Send READ instruction */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
r_sizeof
id|readtab
op_div
r_sizeof
id|readtab
(braket
l_int|0
)braket
suffix:semicolon
id|i
op_increment
)paren
(brace
id|NICSTAR_REG_WRITE
c_func
(paren
id|base
comma
id|NICSTAR_REG_GENERAL_PURPOSE
comma
(paren
id|val
op_or
id|readtab
(braket
id|i
)braket
)paren
)paren
suffix:semicolon
id|osp_MicroDelay
c_func
(paren
id|CYCLE_DELAY
)paren
suffix:semicolon
)brace
multiline_comment|/* Next, we need to send the byte address to read from */
r_for
c_loop
(paren
id|i
op_assign
l_int|7
suffix:semicolon
id|i
op_ge
l_int|0
suffix:semicolon
id|i
op_decrement
)paren
(brace
id|NICSTAR_REG_WRITE
c_func
(paren
id|base
comma
id|NICSTAR_REG_GENERAL_PURPOSE
comma
(paren
id|val
op_or
id|clocktab
(braket
id|j
op_increment
)braket
op_or
(paren
(paren
id|offset
op_rshift
id|i
)paren
op_amp
l_int|1
)paren
)paren
)paren
suffix:semicolon
id|osp_MicroDelay
c_func
(paren
id|CYCLE_DELAY
)paren
suffix:semicolon
id|NICSTAR_REG_WRITE
c_func
(paren
id|base
comma
id|NICSTAR_REG_GENERAL_PURPOSE
comma
(paren
id|val
op_or
id|clocktab
(braket
id|j
op_increment
)braket
op_or
(paren
(paren
id|offset
op_rshift
id|i
)paren
op_amp
l_int|1
)paren
)paren
)paren
suffix:semicolon
id|osp_MicroDelay
c_func
(paren
id|CYCLE_DELAY
)paren
suffix:semicolon
)brace
id|j
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Now, we can read data from the eeprom by clocking it in */
r_for
c_loop
(paren
id|i
op_assign
l_int|7
suffix:semicolon
id|i
op_ge
l_int|0
suffix:semicolon
id|i
op_decrement
)paren
(brace
id|NICSTAR_REG_WRITE
c_func
(paren
id|base
comma
id|NICSTAR_REG_GENERAL_PURPOSE
comma
(paren
id|val
op_or
id|clocktab
(braket
id|j
op_increment
)braket
)paren
)paren
suffix:semicolon
id|osp_MicroDelay
c_func
(paren
id|CYCLE_DELAY
)paren
suffix:semicolon
id|tempread
op_or_assign
(paren
(paren
(paren
id|NICSTAR_REG_READ
c_func
(paren
id|base
comma
id|NICSTAR_REG_GENERAL_PURPOSE
)paren
op_amp
l_int|0x00010000
)paren
op_rshift
l_int|16
)paren
op_lshift
id|i
)paren
suffix:semicolon
id|NICSTAR_REG_WRITE
c_func
(paren
id|base
comma
id|NICSTAR_REG_GENERAL_PURPOSE
comma
(paren
id|val
op_or
id|clocktab
(braket
id|j
op_increment
)braket
)paren
)paren
suffix:semicolon
id|osp_MicroDelay
c_func
(paren
id|CYCLE_DELAY
)paren
suffix:semicolon
)brace
id|NICSTAR_REG_WRITE
c_func
(paren
id|base
comma
id|NICSTAR_REG_GENERAL_PURPOSE
comma
l_int|2
)paren
suffix:semicolon
id|osp_MicroDelay
c_func
(paren
id|CYCLE_DELAY
)paren
suffix:semicolon
r_return
id|tempread
suffix:semicolon
)brace
r_void
DECL|function|nicstar_init_eprom
id|nicstar_init_eprom
c_func
(paren
id|virt_addr_t
id|base
)paren
(brace
id|u_int32_t
id|val
suffix:semicolon
multiline_comment|/*&n;     * turn chip select off&n;     */
id|val
op_assign
id|NICSTAR_REG_READ
c_func
(paren
id|base
comma
id|NICSTAR_REG_GENERAL_PURPOSE
)paren
op_amp
l_int|0xFFFFFFF0
suffix:semicolon
id|NICSTAR_REG_WRITE
c_func
(paren
id|base
comma
id|NICSTAR_REG_GENERAL_PURPOSE
comma
(paren
id|val
op_or
id|CS_HIGH
op_or
id|CLK_HIGH
)paren
)paren
suffix:semicolon
id|osp_MicroDelay
c_func
(paren
id|CYCLE_DELAY
)paren
suffix:semicolon
id|NICSTAR_REG_WRITE
c_func
(paren
id|base
comma
id|NICSTAR_REG_GENERAL_PURPOSE
comma
(paren
id|val
op_or
id|CS_HIGH
op_or
id|CLK_LOW
)paren
)paren
suffix:semicolon
id|osp_MicroDelay
c_func
(paren
id|CYCLE_DELAY
)paren
suffix:semicolon
id|NICSTAR_REG_WRITE
c_func
(paren
id|base
comma
id|NICSTAR_REG_GENERAL_PURPOSE
comma
(paren
id|val
op_or
id|CS_HIGH
op_or
id|CLK_HIGH
)paren
)paren
suffix:semicolon
id|osp_MicroDelay
c_func
(paren
id|CYCLE_DELAY
)paren
suffix:semicolon
id|NICSTAR_REG_WRITE
c_func
(paren
id|base
comma
id|NICSTAR_REG_GENERAL_PURPOSE
comma
(paren
id|val
op_or
id|CS_HIGH
op_or
id|CLK_LOW
)paren
)paren
suffix:semicolon
id|osp_MicroDelay
c_func
(paren
id|CYCLE_DELAY
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * This routine will be the interface to the ReadPromByte function&n; * above.&n; */
r_void
DECL|function|nicstar_read_eprom
id|nicstar_read_eprom
c_func
(paren
id|virt_addr_t
id|base
comma
id|u_int8_t
id|prom_offset
comma
id|u_int8_t
op_star
id|buffer
comma
id|u_int32_t
id|nbytes
)paren
(brace
id|u_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|nbytes
suffix:semicolon
id|i
op_increment
)paren
(brace
id|buffer
(braket
id|i
)braket
op_assign
id|read_eprom_byte
c_func
(paren
id|base
comma
id|prom_offset
)paren
suffix:semicolon
op_increment
id|prom_offset
suffix:semicolon
id|osp_MicroDelay
c_func
(paren
id|CYCLE_DELAY
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/*&n;void osp_MicroDelay(int x) {&n;    &n;}&n;*/
eof
