multiline_comment|/******************************************************************************&n; *&n; * nicstar.c&n; *&n; * Device driver supporting CBR for IDT 77201/77211 &quot;NICStAR&quot; based cards.&n; *&n; * IMPORTANT: The included file nicstarmac.c was NOT WRITTEN BY ME.&n; *            It was taken from the frle-0.22 device driver.&n; *            As the file doesn&squot;t have a copyright notice, in the file&n; *            nicstarmac.copyright I put the copyright notice from the&n; *            frle-0.22 device driver.&n; *            Some code is based on the nicstar driver by M. Welsh.&n; *&n; * Author: Rui Prior (rprior@inescn.pt)&n; * PowerPC support by Jay Talbott (jay_talbott@mcg.mot.com) April 1999&n; *&n; *&n; * (C) INESC 1999&n; *&n; *&n; ******************************************************************************/
multiline_comment|/**** IMPORTANT INFORMATION ***************************************************&n; *&n; * There are currently three types of spinlocks:&n; *&n; * 1 - Per card interrupt spinlock (to protect structures and such)&n; * 2 - Per SCQ scq spinlock&n; * 3 - Per card resource spinlock (to access registers, etc.)&n; *&n; * These must NEVER be grabbed in reverse order.&n; *&n; ******************************************************************************/
multiline_comment|/* Header files ***************************************************************/
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/skbuff.h&gt;
macro_line|#include &lt;linux/atmdev.h&gt;
macro_line|#include &lt;linux/atm.h&gt;
macro_line|#include &lt;linux/pci.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/timer.h&gt;
macro_line|#include &lt;linux/interrupt.h&gt;
macro_line|#include &lt;linux/bitops.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/uaccess.h&gt;
macro_line|#include &lt;asm/atomic.h&gt;
macro_line|#include &quot;nicstar.h&quot;
macro_line|#include &quot;nicstarmac.h&quot;
macro_line|#ifdef CONFIG_ATM_NICSTAR_USE_SUNI
macro_line|#include &quot;suni.h&quot;
macro_line|#endif /* CONFIG_ATM_NICSTAR_USE_SUNI */
macro_line|#ifdef CONFIG_ATM_NICSTAR_USE_IDT77105
macro_line|#include &quot;idt77105.h&quot;
macro_line|#endif /* CONFIG_ATM_NICSTAR_USE_IDT77105 */
multiline_comment|/* Additional code ************************************************************/
macro_line|#include &quot;nicstarmac.c&quot;
multiline_comment|/* Configurable parameters ****************************************************/
DECL|macro|PHY_LOOPBACK
macro_line|#undef PHY_LOOPBACK
DECL|macro|TX_DEBUG
macro_line|#undef TX_DEBUG
DECL|macro|RX_DEBUG
macro_line|#undef RX_DEBUG
DECL|macro|GENERAL_DEBUG
macro_line|#undef GENERAL_DEBUG
DECL|macro|EXTRA_DEBUG
macro_line|#undef EXTRA_DEBUG
DECL|macro|NS_USE_DESTRUCTORS
macro_line|#undef NS_USE_DESTRUCTORS /* For now keep this undefined unless you know&n;                             you&squot;re going to use only raw ATM */
multiline_comment|/* Do not touch these *********************************************************/
macro_line|#ifdef TX_DEBUG
DECL|macro|TXPRINTK
mdefine_line|#define TXPRINTK(args...) printk(args)
macro_line|#else
DECL|macro|TXPRINTK
mdefine_line|#define TXPRINTK(args...)
macro_line|#endif /* TX_DEBUG */
macro_line|#ifdef RX_DEBUG
DECL|macro|RXPRINTK
mdefine_line|#define RXPRINTK(args...) printk(args)
macro_line|#else
DECL|macro|RXPRINTK
mdefine_line|#define RXPRINTK(args...)
macro_line|#endif /* RX_DEBUG */
macro_line|#ifdef GENERAL_DEBUG
DECL|macro|PRINTK
mdefine_line|#define PRINTK(args...) printk(args)
macro_line|#else
DECL|macro|PRINTK
mdefine_line|#define PRINTK(args...)
macro_line|#endif /* GENERAL_DEBUG */
macro_line|#ifdef EXTRA_DEBUG
DECL|macro|XPRINTK
mdefine_line|#define XPRINTK(args...) printk(args)
macro_line|#else
DECL|macro|XPRINTK
mdefine_line|#define XPRINTK(args...)
macro_line|#endif /* EXTRA_DEBUG */
multiline_comment|/* Macros *********************************************************************/
DECL|macro|MAX
mdefine_line|#define MAX(a,b) ((a) &gt; (b) ? (a) : (b))
DECL|macro|MIN
mdefine_line|#define MIN(a,b) ((a) &lt; (b) ? (a) : (b))
DECL|macro|CMD_BUSY
mdefine_line|#define CMD_BUSY(card) (readl((card)-&gt;membase + STAT) &amp; NS_STAT_CMDBZ)
DECL|macro|NS_DELAY
mdefine_line|#define NS_DELAY mdelay(1)
DECL|macro|ALIGN_BUS_ADDR
mdefine_line|#define ALIGN_BUS_ADDR(addr, alignment) &bslash;&n;        ((((u32) (addr)) + (((u32) (alignment)) - 1)) &amp; ~(((u32) (alignment)) - 1))
DECL|macro|ALIGN_ADDRESS
mdefine_line|#define ALIGN_ADDRESS(addr, alignment) &bslash;&n;        bus_to_virt(ALIGN_BUS_ADDR(virt_to_bus(addr), alignment))
DECL|macro|CEIL
macro_line|#undef CEIL(d)
macro_line|#ifndef ATM_SKB
DECL|macro|ATM_SKB
mdefine_line|#define ATM_SKB(s) (&amp;(s)-&gt;atm)
macro_line|#endif
multiline_comment|/* Spinlock debugging stuff */
macro_line|#ifdef NS_DEBUG_SPINLOCKS /* See nicstar.h */
DECL|macro|ns_grab_int_lock
mdefine_line|#define ns_grab_int_lock(card,flags) &bslash;&n; do { &bslash;&n;    unsigned long nsdsf, nsdsf2; &bslash;&n;    local_irq_save(flags); &bslash;&n;    save_flags(nsdsf); cli();&bslash;&n;    if (nsdsf &amp; (1&lt;&lt;9)) printk (&quot;nicstar.c: ints %sabled -&gt; enabled.&bslash;n&quot;, &bslash;&n;                                (flags)&amp;(1&lt;&lt;9)?&quot;en&quot;:&quot;dis&quot;); &bslash;&n;    if (spin_is_locked(&amp;(card)-&gt;int_lock) &amp;&amp; &bslash;&n;        (card)-&gt;cpu_int == smp_processor_id()) { &bslash;&n;       printk(&quot;nicstar.c: line %d (cpu %d) int_lock already locked at line %d (cpu %d)&bslash;n&quot;, &bslash;&n;              __LINE__, smp_processor_id(), (card)-&gt;has_int_lock, &bslash;&n;              (card)-&gt;cpu_int); &bslash;&n;       printk(&quot;nicstar.c: ints were %sabled.&bslash;n&quot;, ((flags)&amp;(1&lt;&lt;9)?&quot;en&quot;:&quot;dis&quot;)); &bslash;&n;    } &bslash;&n;    if (spin_is_locked(&amp;(card)-&gt;res_lock) &amp;&amp; &bslash;&n;        (card)-&gt;cpu_res == smp_processor_id()) { &bslash;&n;       printk(&quot;nicstar.c: line %d (cpu %d) res_lock locked at line %d (cpu %d)(trying int)&bslash;n&quot;, &bslash;&n;              __LINE__, smp_processor_id(), (card)-&gt;has_res_lock, &bslash;&n;              (card)-&gt;cpu_res); &bslash;&n;       printk(&quot;nicstar.c: ints were %sabled.&bslash;n&quot;, ((flags)&amp;(1&lt;&lt;9)?&quot;en&quot;:&quot;dis&quot;)); &bslash;&n;    } &bslash;&n;    spin_lock_irq(&amp;(card)-&gt;int_lock); &bslash;&n;    (card)-&gt;has_int_lock = __LINE__; &bslash;&n;    (card)-&gt;cpu_int = smp_processor_id(); &bslash;&n;    restore_flags(nsdsf); } while (0)
DECL|macro|ns_grab_res_lock
mdefine_line|#define ns_grab_res_lock(card,flags) &bslash;&n; do { &bslash;&n;    unsigned long nsdsf, nsdsf2; &bslash;&n;    local_irq_save(flags); &bslash;&n;    save_flags(nsdsf); cli();&bslash;&n;    if (nsdsf &amp; (1&lt;&lt;9)) printk (&quot;nicstar.c: ints %sabled -&gt; enabled.&bslash;n&quot;, &bslash;&n;                                (flags)&amp;(1&lt;&lt;9)?&quot;en&quot;:&quot;dis&quot;); &bslash;&n;    if (spin_is_locked(&amp;(card)-&gt;res_lock) &amp;&amp; &bslash;&n;        (card)-&gt;cpu_res == smp_processor_id()) { &bslash;&n;       printk(&quot;nicstar.c: line %d (cpu %d) res_lock already locked at line %d (cpu %d)&bslash;n&quot;, &bslash;&n;              __LINE__, smp_processor_id(), (card)-&gt;has_res_lock, &bslash;&n;              (card)-&gt;cpu_res); &bslash;&n;       printk(&quot;nicstar.c: ints were %sabled.&bslash;n&quot;, ((flags)&amp;(1&lt;&lt;9)?&quot;en&quot;:&quot;dis&quot;)); &bslash;&n;    } &bslash;&n;    spin_lock_irq(&amp;(card)-&gt;res_lock); &bslash;&n;    (card)-&gt;has_res_lock = __LINE__; &bslash;&n;    (card)-&gt;cpu_res = smp_processor_id(); &bslash;&n;    restore_flags(nsdsf); } while (0)
DECL|macro|ns_grab_scq_lock
mdefine_line|#define ns_grab_scq_lock(card,scq,flags) &bslash;&n; do { &bslash;&n;    unsigned long nsdsf, nsdsf2; &bslash;&n;    local_irq_save(flags); &bslash;&n;    save_flags(nsdsf); cli();&bslash;&n;    if (nsdsf &amp; (1&lt;&lt;9)) printk (&quot;nicstar.c: ints %sabled -&gt; enabled.&bslash;n&quot;, &bslash;&n;                                (flags)&amp;(1&lt;&lt;9)?&quot;en&quot;:&quot;dis&quot;); &bslash;&n;    if (spin_is_locked(&amp;(scq)-&gt;lock) &amp;&amp; &bslash;&n;        (scq)-&gt;cpu_lock == smp_processor_id()) { &bslash;&n;       printk(&quot;nicstar.c: line %d (cpu %d) this scq_lock already locked at line %d (cpu %d)&bslash;n&quot;, &bslash;&n;              __LINE__, smp_processor_id(), (scq)-&gt;has_lock, &bslash;&n;              (scq)-&gt;cpu_lock); &bslash;&n;       printk(&quot;nicstar.c: ints were %sabled.&bslash;n&quot;, ((flags)&amp;(1&lt;&lt;9)?&quot;en&quot;:&quot;dis&quot;)); &bslash;&n;    } &bslash;&n;    if (spin_is_locked(&amp;(card)-&gt;res_lock) &amp;&amp; &bslash;&n;        (card)-&gt;cpu_res == smp_processor_id()) { &bslash;&n;       printk(&quot;nicstar.c: line %d (cpu %d) res_lock locked at line %d (cpu %d)(trying scq)&bslash;n&quot;, &bslash;&n;              __LINE__, smp_processor_id(), (card)-&gt;has_res_lock, &bslash;&n;              (card)-&gt;cpu_res); &bslash;&n;       printk(&quot;nicstar.c: ints were %sabled.&bslash;n&quot;, ((flags)&amp;(1&lt;&lt;9)?&quot;en&quot;:&quot;dis&quot;)); &bslash;&n;    } &bslash;&n;    spin_lock_irq(&amp;(scq)-&gt;lock); &bslash;&n;    (scq)-&gt;has_lock = __LINE__; &bslash;&n;    (scq)-&gt;cpu_lock = smp_processor_id(); &bslash;&n;    restore_flags(nsdsf); } while (0)
macro_line|#else /* !NS_DEBUG_SPINLOCKS */
DECL|macro|ns_grab_int_lock
mdefine_line|#define ns_grab_int_lock(card,flags) &bslash;&n;        spin_lock_irqsave(&amp;(card)-&gt;int_lock,(flags))
DECL|macro|ns_grab_res_lock
mdefine_line|#define ns_grab_res_lock(card,flags) &bslash;&n;        spin_lock_irqsave(&amp;(card)-&gt;res_lock,(flags))
DECL|macro|ns_grab_scq_lock
mdefine_line|#define ns_grab_scq_lock(card,scq,flags) &bslash;&n;        spin_lock_irqsave(&amp;(scq)-&gt;lock,flags)
macro_line|#endif /* NS_DEBUG_SPINLOCKS */
multiline_comment|/* Version definition *********************************************************/
multiline_comment|/*&n;#include &lt;linux/version.h&gt;&n;char kernel_version[] = UTS_RELEASE;&n;*/
multiline_comment|/* Function declarations ******************************************************/
r_static
id|u32
id|ns_read_sram
c_func
(paren
id|ns_dev
op_star
id|card
comma
id|u32
id|sram_address
)paren
suffix:semicolon
r_static
r_void
id|ns_write_sram
c_func
(paren
id|ns_dev
op_star
id|card
comma
id|u32
id|sram_address
comma
id|u32
op_star
id|value
comma
r_int
id|count
)paren
suffix:semicolon
r_static
r_int
id|ns_init_card
c_func
(paren
r_int
id|i
comma
r_struct
id|pci_dev
op_star
id|pcidev
)paren
suffix:semicolon
r_static
r_void
id|ns_init_card_error
c_func
(paren
id|ns_dev
op_star
id|card
comma
r_int
id|error
)paren
suffix:semicolon
r_static
id|scq_info
op_star
id|get_scq
c_func
(paren
r_int
id|size
comma
id|u32
id|scd
)paren
suffix:semicolon
r_static
r_void
id|free_scq
c_func
(paren
id|scq_info
op_star
id|scq
comma
r_struct
id|atm_vcc
op_star
id|vcc
)paren
suffix:semicolon
r_static
r_void
id|push_rxbufs
c_func
(paren
id|ns_dev
op_star
id|card
comma
id|u32
id|type
comma
id|u32
id|handle1
comma
id|u32
id|addr1
comma
id|u32
id|handle2
comma
id|u32
id|addr2
)paren
suffix:semicolon
r_static
r_void
id|ns_irq_handler
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
suffix:semicolon
r_static
r_int
id|ns_open
c_func
(paren
r_struct
id|atm_vcc
op_star
id|vcc
comma
r_int
id|vpi
comma
r_int
id|vci
)paren
suffix:semicolon
r_static
r_void
id|ns_close
c_func
(paren
r_struct
id|atm_vcc
op_star
id|vcc
)paren
suffix:semicolon
r_static
r_void
id|fill_tst
c_func
(paren
id|ns_dev
op_star
id|card
comma
r_int
id|n
comma
id|vc_map
op_star
id|vc
)paren
suffix:semicolon
r_static
r_int
id|ns_send
c_func
(paren
r_struct
id|atm_vcc
op_star
id|vcc
comma
r_struct
id|sk_buff
op_star
id|skb
)paren
suffix:semicolon
r_static
r_int
id|push_scqe
c_func
(paren
id|ns_dev
op_star
id|card
comma
id|vc_map
op_star
id|vc
comma
id|scq_info
op_star
id|scq
comma
id|ns_scqe
op_star
id|tbd
comma
r_struct
id|sk_buff
op_star
id|skb
)paren
suffix:semicolon
r_static
r_void
id|process_tsq
c_func
(paren
id|ns_dev
op_star
id|card
)paren
suffix:semicolon
r_static
r_void
id|drain_scq
c_func
(paren
id|ns_dev
op_star
id|card
comma
id|scq_info
op_star
id|scq
comma
r_int
id|pos
)paren
suffix:semicolon
r_static
r_void
id|process_rsq
c_func
(paren
id|ns_dev
op_star
id|card
)paren
suffix:semicolon
r_static
r_void
id|dequeue_rx
c_func
(paren
id|ns_dev
op_star
id|card
comma
id|ns_rsqe
op_star
id|rsqe
)paren
suffix:semicolon
macro_line|#ifdef NS_USE_DESTRUCTORS
r_static
r_void
id|ns_sb_destructor
c_func
(paren
r_struct
id|sk_buff
op_star
id|sb
)paren
suffix:semicolon
r_static
r_void
id|ns_lb_destructor
c_func
(paren
r_struct
id|sk_buff
op_star
id|lb
)paren
suffix:semicolon
r_static
r_void
id|ns_hb_destructor
c_func
(paren
r_struct
id|sk_buff
op_star
id|hb
)paren
suffix:semicolon
macro_line|#endif /* NS_USE_DESTRUCTORS */
r_static
r_void
id|recycle_rx_buf
c_func
(paren
id|ns_dev
op_star
id|card
comma
r_struct
id|sk_buff
op_star
id|skb
)paren
suffix:semicolon
r_static
r_void
id|recycle_iovec_rx_bufs
c_func
(paren
id|ns_dev
op_star
id|card
comma
r_struct
id|iovec
op_star
id|iov
comma
r_int
id|count
)paren
suffix:semicolon
r_static
r_void
id|recycle_iov_buf
c_func
(paren
id|ns_dev
op_star
id|card
comma
r_struct
id|sk_buff
op_star
id|iovb
)paren
suffix:semicolon
r_static
r_void
id|dequeue_sm_buf
c_func
(paren
id|ns_dev
op_star
id|card
comma
r_struct
id|sk_buff
op_star
id|sb
)paren
suffix:semicolon
r_static
r_void
id|dequeue_lg_buf
c_func
(paren
id|ns_dev
op_star
id|card
comma
r_struct
id|sk_buff
op_star
id|lb
)paren
suffix:semicolon
r_static
r_int
id|ns_proc_read
c_func
(paren
r_struct
id|atm_dev
op_star
id|dev
comma
id|loff_t
op_star
id|pos
comma
r_char
op_star
id|page
)paren
suffix:semicolon
r_static
r_int
id|ns_ioctl
c_func
(paren
r_struct
id|atm_dev
op_star
id|dev
comma
r_int
r_int
id|cmd
comma
r_void
op_star
id|arg
)paren
suffix:semicolon
r_static
r_void
id|which_list
c_func
(paren
id|ns_dev
op_star
id|card
comma
r_struct
id|sk_buff
op_star
id|skb
)paren
suffix:semicolon
r_static
r_void
id|ns_poll
c_func
(paren
r_int
r_int
id|arg
)paren
suffix:semicolon
r_static
r_int
id|ns_parse_mac
c_func
(paren
r_char
op_star
id|mac
comma
r_int
r_char
op_star
id|esi
)paren
suffix:semicolon
r_static
r_int
id|ns_h2i
c_func
(paren
r_char
id|c
)paren
suffix:semicolon
r_static
r_void
id|ns_phy_put
c_func
(paren
r_struct
id|atm_dev
op_star
id|dev
comma
r_int
r_char
id|value
comma
r_int
r_int
id|addr
)paren
suffix:semicolon
r_static
r_int
r_char
id|ns_phy_get
c_func
(paren
r_struct
id|atm_dev
op_star
id|dev
comma
r_int
r_int
id|addr
)paren
suffix:semicolon
multiline_comment|/* Global variables ***********************************************************/
DECL|variable|cards
r_static
r_struct
id|ns_dev
op_star
id|cards
(braket
id|NS_MAX_CARDS
)braket
suffix:semicolon
DECL|variable|num_cards
r_static
r_int
id|num_cards
suffix:semicolon
DECL|variable|atm_ops
r_static
r_struct
id|atmdev_ops
id|atm_ops
op_assign
(brace
id|open
suffix:colon
id|ns_open
comma
id|close
suffix:colon
id|ns_close
comma
id|ioctl
suffix:colon
id|ns_ioctl
comma
id|send
suffix:colon
id|ns_send
comma
id|phy_put
suffix:colon
id|ns_phy_put
comma
id|phy_get
suffix:colon
id|ns_phy_get
comma
id|proc_read
suffix:colon
id|ns_proc_read
comma
id|owner
suffix:colon
id|THIS_MODULE
comma
)brace
suffix:semicolon
DECL|variable|ns_timer
r_static
r_struct
id|timer_list
id|ns_timer
suffix:semicolon
DECL|variable|mac
r_static
r_char
op_star
id|mac
(braket
id|NS_MAX_CARDS
)braket
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|mac
comma
l_string|&quot;1-&quot;
id|__MODULE_STRING
c_func
(paren
id|NS_MAX_CARDS
)paren
l_string|&quot;s&quot;
)paren
suffix:semicolon
multiline_comment|/* Functions*******************************************************************/
macro_line|#ifdef MODULE
DECL|function|init_module
r_int
id|init_module
c_func
(paren
r_void
)paren
(brace
r_int
id|i
suffix:semicolon
r_int
id|error
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Initialized to remove compile warning */
r_struct
id|pci_dev
op_star
id|pcidev
suffix:semicolon
id|XPRINTK
c_func
(paren
l_string|&quot;nicstar: init_module() called.&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pci_present
c_func
(paren
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;nicstar: no PCI subsystem found.&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|NS_MAX_CARDS
suffix:semicolon
id|i
op_increment
)paren
(brace
id|cards
(braket
id|i
)braket
op_assign
l_int|NULL
suffix:semicolon
)brace
id|pcidev
op_assign
l_int|NULL
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|NS_MAX_CARDS
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
(paren
id|pcidev
op_assign
id|pci_find_device
c_func
(paren
id|PCI_VENDOR_ID_IDT
comma
id|PCI_DEVICE_ID_IDT_IDT77201
comma
id|pcidev
)paren
)paren
op_eq
l_int|NULL
)paren
r_break
suffix:semicolon
id|error
op_assign
id|ns_init_card
c_func
(paren
id|i
comma
id|pcidev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
)paren
id|cards
(braket
id|i
op_decrement
)braket
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/* Try to find another card but don&squot;t increment index */
)brace
r_if
c_cond
(paren
id|i
op_eq
l_int|0
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|error
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;nicstar: no cards found.&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENXIO
suffix:semicolon
)brace
r_else
r_return
op_minus
id|EIO
suffix:semicolon
)brace
id|TXPRINTK
c_func
(paren
l_string|&quot;nicstar: TX debug enabled.&bslash;n&quot;
)paren
suffix:semicolon
id|RXPRINTK
c_func
(paren
l_string|&quot;nicstar: RX debug enabled.&bslash;n&quot;
)paren
suffix:semicolon
id|PRINTK
c_func
(paren
l_string|&quot;nicstar: General debug enabled.&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#ifdef PHY_LOOPBACK
id|printk
c_func
(paren
l_string|&quot;nicstar: using PHY loopback.&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif /* PHY_LOOPBACK */
id|XPRINTK
c_func
(paren
l_string|&quot;nicstar: init_module() returned.&bslash;n&quot;
)paren
suffix:semicolon
id|init_timer
c_func
(paren
op_amp
id|ns_timer
)paren
suffix:semicolon
id|ns_timer.expires
op_assign
id|jiffies
op_plus
id|NS_POLL_PERIOD
suffix:semicolon
id|ns_timer.data
op_assign
l_int|0UL
suffix:semicolon
id|ns_timer.function
op_assign
id|ns_poll
suffix:semicolon
id|add_timer
c_func
(paren
op_amp
id|ns_timer
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|cleanup_module
r_void
id|cleanup_module
c_func
(paren
r_void
)paren
(brace
r_int
id|i
comma
id|j
suffix:semicolon
r_int
r_int
id|pci_command
suffix:semicolon
id|ns_dev
op_star
id|card
suffix:semicolon
r_struct
id|sk_buff
op_star
id|hb
suffix:semicolon
r_struct
id|sk_buff
op_star
id|iovb
suffix:semicolon
r_struct
id|sk_buff
op_star
id|lb
suffix:semicolon
r_struct
id|sk_buff
op_star
id|sb
suffix:semicolon
id|XPRINTK
c_func
(paren
l_string|&quot;nicstar: cleanup_module() called.&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|MOD_IN_USE
)paren
id|printk
c_func
(paren
l_string|&quot;nicstar: module in use, remove delayed.&bslash;n&quot;
)paren
suffix:semicolon
id|del_timer
c_func
(paren
op_amp
id|ns_timer
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|NS_MAX_CARDS
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|cards
(braket
id|i
)braket
op_eq
l_int|NULL
)paren
r_continue
suffix:semicolon
id|card
op_assign
id|cards
(braket
id|i
)braket
suffix:semicolon
macro_line|#ifdef CONFIG_ATM_NICSTAR_USE_IDT77105
r_if
c_cond
(paren
id|card-&gt;max_pcr
op_eq
id|ATM_25_PCR
)paren
(brace
id|idt77105_stop
c_func
(paren
id|card-&gt;atmdev
)paren
suffix:semicolon
)brace
macro_line|#endif /* CONFIG_ATM_NICSTAR_USE_IDT77105 */
multiline_comment|/* Stop everything */
id|writel
c_func
(paren
l_int|0x00000000
comma
id|card-&gt;membase
op_plus
id|CFG
)paren
suffix:semicolon
multiline_comment|/* De-register device */
id|atm_dev_deregister
c_func
(paren
id|card-&gt;atmdev
)paren
suffix:semicolon
multiline_comment|/* Disable memory mapping and busmastering */
r_if
c_cond
(paren
id|pci_read_config_word
c_func
(paren
id|card-&gt;pcidev
comma
id|PCI_COMMAND
comma
op_amp
id|pci_command
)paren
op_ne
l_int|0
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;nicstar%d: can&squot;t read PCI_COMMAND.&bslash;n&quot;
comma
id|i
)paren
suffix:semicolon
)brace
id|pci_command
op_and_assign
op_complement
(paren
id|PCI_COMMAND_MEMORY
op_or
id|PCI_COMMAND_MASTER
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pci_write_config_word
c_func
(paren
id|card-&gt;pcidev
comma
id|PCI_COMMAND
comma
id|pci_command
)paren
op_ne
l_int|0
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;nicstar%d: can&squot;t write PCI_COMMAND.&bslash;n&quot;
comma
id|i
)paren
suffix:semicolon
)brace
multiline_comment|/* Free up resources */
id|j
op_assign
l_int|0
suffix:semicolon
id|PRINTK
c_func
(paren
l_string|&quot;nicstar%d: freeing %d huge buffers.&bslash;n&quot;
comma
id|i
comma
id|card-&gt;hbpool.count
)paren
suffix:semicolon
r_while
c_loop
(paren
(paren
id|hb
op_assign
id|skb_dequeue
c_func
(paren
op_amp
id|card-&gt;hbpool.queue
)paren
)paren
op_ne
l_int|NULL
)paren
(brace
id|dev_kfree_skb_any
c_func
(paren
id|hb
)paren
suffix:semicolon
id|j
op_increment
suffix:semicolon
)brace
id|PRINTK
c_func
(paren
l_string|&quot;nicstar%d: %d huge buffers freed.&bslash;n&quot;
comma
id|i
comma
id|j
)paren
suffix:semicolon
id|j
op_assign
l_int|0
suffix:semicolon
id|PRINTK
c_func
(paren
l_string|&quot;nicstar%d: freeing %d iovec buffers.&bslash;n&quot;
comma
id|i
comma
id|card-&gt;iovpool.count
)paren
suffix:semicolon
r_while
c_loop
(paren
(paren
id|iovb
op_assign
id|skb_dequeue
c_func
(paren
op_amp
id|card-&gt;iovpool.queue
)paren
)paren
op_ne
l_int|NULL
)paren
(brace
id|dev_kfree_skb_any
c_func
(paren
id|iovb
)paren
suffix:semicolon
id|j
op_increment
suffix:semicolon
)brace
id|PRINTK
c_func
(paren
l_string|&quot;nicstar%d: %d iovec buffers freed.&bslash;n&quot;
comma
id|i
comma
id|j
)paren
suffix:semicolon
r_while
c_loop
(paren
(paren
id|lb
op_assign
id|skb_dequeue
c_func
(paren
op_amp
id|card-&gt;lbpool.queue
)paren
)paren
op_ne
l_int|NULL
)paren
id|dev_kfree_skb_any
c_func
(paren
id|lb
)paren
suffix:semicolon
r_while
c_loop
(paren
(paren
id|sb
op_assign
id|skb_dequeue
c_func
(paren
op_amp
id|card-&gt;sbpool.queue
)paren
)paren
op_ne
l_int|NULL
)paren
id|dev_kfree_skb_any
c_func
(paren
id|sb
)paren
suffix:semicolon
id|free_scq
c_func
(paren
id|card-&gt;scq0
comma
l_int|NULL
)paren
suffix:semicolon
r_for
c_loop
(paren
id|j
op_assign
l_int|0
suffix:semicolon
id|j
OL
id|NS_FRSCD_NUM
suffix:semicolon
id|j
op_increment
)paren
(brace
r_if
c_cond
(paren
id|card-&gt;scd2vc
(braket
id|j
)braket
op_ne
l_int|NULL
)paren
id|free_scq
c_func
(paren
id|card-&gt;scd2vc
(braket
id|j
)braket
op_member_access_from_pointer
id|scq
comma
id|card-&gt;scd2vc
(braket
id|j
)braket
op_member_access_from_pointer
id|tx_vcc
)paren
suffix:semicolon
)brace
id|kfree
c_func
(paren
id|card-&gt;rsq.org
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|card-&gt;tsq.org
)paren
suffix:semicolon
id|free_irq
c_func
(paren
id|card-&gt;pcidev-&gt;irq
comma
id|card
)paren
suffix:semicolon
id|iounmap
c_func
(paren
(paren
r_void
op_star
)paren
id|card-&gt;membase
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|card
)paren
suffix:semicolon
)brace
id|XPRINTK
c_func
(paren
l_string|&quot;nicstar: cleanup_module() returned.&bslash;n&quot;
)paren
suffix:semicolon
)brace
macro_line|#else
DECL|function|nicstar_detect
r_int
id|__init
id|nicstar_detect
c_func
(paren
r_void
)paren
(brace
r_int
id|i
suffix:semicolon
r_int
id|error
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Initialized to remove compile warning */
r_struct
id|pci_dev
op_star
id|pcidev
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pci_present
c_func
(paren
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;nicstar: no PCI subsystem found.&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|NS_MAX_CARDS
suffix:semicolon
id|i
op_increment
)paren
(brace
id|cards
(braket
id|i
)braket
op_assign
l_int|NULL
suffix:semicolon
)brace
id|pcidev
op_assign
l_int|NULL
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|NS_MAX_CARDS
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
(paren
id|pcidev
op_assign
id|pci_find_device
c_func
(paren
id|PCI_VENDOR_ID_IDT
comma
id|PCI_DEVICE_ID_IDT_IDT77201
comma
id|pcidev
)paren
)paren
op_eq
l_int|NULL
)paren
r_break
suffix:semicolon
id|error
op_assign
id|ns_init_card
c_func
(paren
id|i
comma
id|pcidev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
)paren
id|cards
(braket
id|i
op_decrement
)braket
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/* Try to find another card but don&squot;t increment index */
)brace
r_if
c_cond
(paren
id|i
op_eq
l_int|0
op_logical_and
id|error
)paren
r_return
op_minus
id|EIO
suffix:semicolon
id|TXPRINTK
c_func
(paren
l_string|&quot;nicstar: TX debug enabled.&bslash;n&quot;
)paren
suffix:semicolon
id|RXPRINTK
c_func
(paren
l_string|&quot;nicstar: RX debug enabled.&bslash;n&quot;
)paren
suffix:semicolon
id|PRINTK
c_func
(paren
l_string|&quot;nicstar: General debug enabled.&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#ifdef PHY_LOOPBACK
id|printk
c_func
(paren
l_string|&quot;nicstar: using PHY loopback.&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif /* PHY_LOOPBACK */
id|XPRINTK
c_func
(paren
l_string|&quot;nicstar: init_module() returned.&bslash;n&quot;
)paren
suffix:semicolon
id|init_timer
c_func
(paren
op_amp
id|ns_timer
)paren
suffix:semicolon
id|ns_timer.expires
op_assign
id|jiffies
op_plus
id|NS_POLL_PERIOD
suffix:semicolon
id|ns_timer.data
op_assign
l_int|0UL
suffix:semicolon
id|ns_timer.function
op_assign
id|ns_poll
suffix:semicolon
id|add_timer
c_func
(paren
op_amp
id|ns_timer
)paren
suffix:semicolon
r_return
id|i
suffix:semicolon
)brace
macro_line|#endif /* MODULE */
DECL|function|ns_read_sram
r_static
id|u32
id|ns_read_sram
c_func
(paren
id|ns_dev
op_star
id|card
comma
id|u32
id|sram_address
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
id|u32
id|data
suffix:semicolon
id|sram_address
op_lshift_assign
l_int|2
suffix:semicolon
id|sram_address
op_and_assign
l_int|0x0007FFFC
suffix:semicolon
multiline_comment|/* address must be dword aligned */
id|sram_address
op_or_assign
l_int|0x50000000
suffix:semicolon
multiline_comment|/* SRAM read command */
id|ns_grab_res_lock
c_func
(paren
id|card
comma
id|flags
)paren
suffix:semicolon
r_while
c_loop
(paren
id|CMD_BUSY
c_func
(paren
id|card
)paren
)paren
suffix:semicolon
id|writel
c_func
(paren
id|sram_address
comma
id|card-&gt;membase
op_plus
id|CMD
)paren
suffix:semicolon
r_while
c_loop
(paren
id|CMD_BUSY
c_func
(paren
id|card
)paren
)paren
suffix:semicolon
id|data
op_assign
id|readl
c_func
(paren
id|card-&gt;membase
op_plus
id|DR0
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|card-&gt;res_lock
comma
id|flags
)paren
suffix:semicolon
r_return
id|data
suffix:semicolon
)brace
DECL|function|ns_write_sram
r_static
r_void
id|ns_write_sram
c_func
(paren
id|ns_dev
op_star
id|card
comma
id|u32
id|sram_address
comma
id|u32
op_star
id|value
comma
r_int
id|count
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
r_int
id|i
comma
id|c
suffix:semicolon
id|count
op_decrement
suffix:semicolon
multiline_comment|/* count range now is 0..3 instead of 1..4 */
id|c
op_assign
id|count
suffix:semicolon
id|c
op_lshift_assign
l_int|2
suffix:semicolon
multiline_comment|/* to use increments of 4 */
id|ns_grab_res_lock
c_func
(paren
id|card
comma
id|flags
)paren
suffix:semicolon
r_while
c_loop
(paren
id|CMD_BUSY
c_func
(paren
id|card
)paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
op_le
id|c
suffix:semicolon
id|i
op_add_assign
l_int|4
)paren
id|writel
c_func
(paren
op_star
(paren
id|value
op_increment
)paren
comma
id|card-&gt;membase
op_plus
id|i
)paren
suffix:semicolon
multiline_comment|/* Note: DR# registers are the first 4 dwords in nicstar&squot;s memspace,&n;            so card-&gt;membase + DR0 == card-&gt;membase */
id|sram_address
op_lshift_assign
l_int|2
suffix:semicolon
id|sram_address
op_and_assign
l_int|0x0007FFFC
suffix:semicolon
id|sram_address
op_or_assign
(paren
l_int|0x40000000
op_or
id|count
)paren
suffix:semicolon
id|writel
c_func
(paren
id|sram_address
comma
id|card-&gt;membase
op_plus
id|CMD
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|card-&gt;res_lock
comma
id|flags
)paren
suffix:semicolon
)brace
DECL|function|ns_init_card
r_static
r_int
id|ns_init_card
c_func
(paren
r_int
id|i
comma
r_struct
id|pci_dev
op_star
id|pcidev
)paren
(brace
r_int
id|j
suffix:semicolon
r_struct
id|ns_dev
op_star
id|card
op_assign
l_int|NULL
suffix:semicolon
r_int
r_int
id|pci_command
suffix:semicolon
r_int
r_char
id|pci_latency
suffix:semicolon
r_int
id|error
suffix:semicolon
id|u32
id|data
suffix:semicolon
id|u32
id|u32d
(braket
l_int|4
)braket
suffix:semicolon
id|u32
id|ns_cfg_rctsize
suffix:semicolon
r_int
id|bcount
suffix:semicolon
id|error
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|pci_enable_device
c_func
(paren
id|pcidev
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;nicstar%d: can&squot;t enable PCI device&bslash;n&quot;
comma
id|i
)paren
suffix:semicolon
id|error
op_assign
l_int|2
suffix:semicolon
id|ns_init_card_error
c_func
(paren
id|card
comma
id|error
)paren
suffix:semicolon
r_return
id|error
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|card
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
id|ns_dev
)paren
comma
id|GFP_KERNEL
)paren
)paren
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;nicstar%d: can&squot;t allocate memory for device structure.&bslash;n&quot;
comma
id|i
)paren
suffix:semicolon
id|error
op_assign
l_int|2
suffix:semicolon
id|ns_init_card_error
c_func
(paren
id|card
comma
id|error
)paren
suffix:semicolon
r_return
id|error
suffix:semicolon
)brace
id|cards
(braket
id|i
)braket
op_assign
id|card
suffix:semicolon
id|spin_lock_init
c_func
(paren
op_amp
id|card-&gt;int_lock
)paren
suffix:semicolon
id|spin_lock_init
c_func
(paren
op_amp
id|card-&gt;res_lock
)paren
suffix:semicolon
id|card-&gt;index
op_assign
id|i
suffix:semicolon
id|card-&gt;atmdev
op_assign
l_int|NULL
suffix:semicolon
id|card-&gt;pcidev
op_assign
id|pcidev
suffix:semicolon
id|card-&gt;membase
op_assign
id|pci_resource_start
c_func
(paren
id|pcidev
comma
l_int|1
)paren
suffix:semicolon
macro_line|#ifdef __powerpc__
multiline_comment|/* Compensate for different memory map between host CPU and PCI bus.&n;      Shouldn&squot;t we use a macro for this? */
id|card-&gt;membase
op_add_assign
id|KERNELBASE
suffix:semicolon
macro_line|#endif /* __powerpc__ */
id|card-&gt;membase
op_assign
(paren
r_int
r_int
)paren
id|ioremap
c_func
(paren
id|card-&gt;membase
comma
id|NS_IOREMAP_SIZE
)paren
suffix:semicolon
r_if
c_cond
(paren
id|card-&gt;membase
op_eq
l_int|0
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;nicstar%d: can&squot;t ioremap() membase.&bslash;n&quot;
comma
id|i
)paren
suffix:semicolon
id|error
op_assign
l_int|3
suffix:semicolon
id|ns_init_card_error
c_func
(paren
id|card
comma
id|error
)paren
suffix:semicolon
r_return
id|error
suffix:semicolon
)brace
id|PRINTK
c_func
(paren
l_string|&quot;nicstar%d: membase at 0x%x.&bslash;n&quot;
comma
id|i
comma
id|card-&gt;membase
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pci_read_config_word
c_func
(paren
id|pcidev
comma
id|PCI_COMMAND
comma
op_amp
id|pci_command
)paren
op_ne
l_int|0
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;nicstar%d: can&squot;t read PCI_COMMAND.&bslash;n&quot;
comma
id|i
)paren
suffix:semicolon
id|error
op_assign
l_int|4
suffix:semicolon
id|ns_init_card_error
c_func
(paren
id|card
comma
id|error
)paren
suffix:semicolon
r_return
id|error
suffix:semicolon
)brace
id|pci_command
op_or_assign
(paren
id|PCI_COMMAND_MEMORY
op_or
id|PCI_COMMAND_MASTER
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pci_write_config_word
c_func
(paren
id|pcidev
comma
id|PCI_COMMAND
comma
id|pci_command
)paren
op_ne
l_int|0
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;nicstar%d: can&squot;t write PCI_COMMAND.&bslash;n&quot;
comma
id|i
)paren
suffix:semicolon
id|error
op_assign
l_int|5
suffix:semicolon
id|ns_init_card_error
c_func
(paren
id|card
comma
id|error
)paren
suffix:semicolon
r_return
id|error
suffix:semicolon
)brace
r_if
c_cond
(paren
id|pci_read_config_byte
c_func
(paren
id|pcidev
comma
id|PCI_LATENCY_TIMER
comma
op_amp
id|pci_latency
)paren
op_ne
l_int|0
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;nicstar%d: can&squot;t read PCI latency timer.&bslash;n&quot;
comma
id|i
)paren
suffix:semicolon
id|error
op_assign
l_int|6
suffix:semicolon
id|ns_init_card_error
c_func
(paren
id|card
comma
id|error
)paren
suffix:semicolon
r_return
id|error
suffix:semicolon
)brace
macro_line|#ifdef NS_PCI_LATENCY
r_if
c_cond
(paren
id|pci_latency
OL
id|NS_PCI_LATENCY
)paren
(brace
id|PRINTK
c_func
(paren
l_string|&quot;nicstar%d: setting PCI latency timer to %d.&bslash;n&quot;
comma
id|i
comma
id|NS_PCI_LATENCY
)paren
suffix:semicolon
r_for
c_loop
(paren
id|j
op_assign
l_int|1
suffix:semicolon
id|j
OL
l_int|4
suffix:semicolon
id|j
op_increment
)paren
(brace
r_if
c_cond
(paren
id|pci_write_config_byte
c_func
(paren
id|pcidev
comma
id|PCI_LATENCY_TIMER
comma
id|NS_PCI_LATENCY
)paren
op_ne
l_int|0
)paren
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|j
op_eq
l_int|4
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;nicstar%d: can&squot;t set PCI latency timer to %d.&bslash;n&quot;
comma
id|i
comma
id|NS_PCI_LATENCY
)paren
suffix:semicolon
id|error
op_assign
l_int|7
suffix:semicolon
id|ns_init_card_error
c_func
(paren
id|card
comma
id|error
)paren
suffix:semicolon
r_return
id|error
suffix:semicolon
)brace
)brace
macro_line|#endif /* NS_PCI_LATENCY */
multiline_comment|/* Clear timer overflow */
id|data
op_assign
id|readl
c_func
(paren
id|card-&gt;membase
op_plus
id|STAT
)paren
suffix:semicolon
r_if
c_cond
(paren
id|data
op_amp
id|NS_STAT_TMROF
)paren
id|writel
c_func
(paren
id|NS_STAT_TMROF
comma
id|card-&gt;membase
op_plus
id|STAT
)paren
suffix:semicolon
multiline_comment|/* Software reset */
id|writel
c_func
(paren
id|NS_CFG_SWRST
comma
id|card-&gt;membase
op_plus
id|CFG
)paren
suffix:semicolon
id|NS_DELAY
suffix:semicolon
id|writel
c_func
(paren
l_int|0x00000000
comma
id|card-&gt;membase
op_plus
id|CFG
)paren
suffix:semicolon
multiline_comment|/* PHY reset */
id|writel
c_func
(paren
l_int|0x00000008
comma
id|card-&gt;membase
op_plus
id|GP
)paren
suffix:semicolon
id|NS_DELAY
suffix:semicolon
id|writel
c_func
(paren
l_int|0x00000001
comma
id|card-&gt;membase
op_plus
id|GP
)paren
suffix:semicolon
id|NS_DELAY
suffix:semicolon
r_while
c_loop
(paren
id|CMD_BUSY
c_func
(paren
id|card
)paren
)paren
suffix:semicolon
id|writel
c_func
(paren
id|NS_CMD_WRITE_UTILITY
op_or
l_int|0x00000100
comma
id|card-&gt;membase
op_plus
id|CMD
)paren
suffix:semicolon
multiline_comment|/* Sync UTOPIA with SAR clock */
id|NS_DELAY
suffix:semicolon
multiline_comment|/* Detect PHY type */
r_while
c_loop
(paren
id|CMD_BUSY
c_func
(paren
id|card
)paren
)paren
suffix:semicolon
id|writel
c_func
(paren
id|NS_CMD_READ_UTILITY
op_or
l_int|0x00000200
comma
id|card-&gt;membase
op_plus
id|CMD
)paren
suffix:semicolon
r_while
c_loop
(paren
id|CMD_BUSY
c_func
(paren
id|card
)paren
)paren
suffix:semicolon
id|data
op_assign
id|readl
c_func
(paren
id|card-&gt;membase
op_plus
id|DR0
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|data
)paren
(brace
r_case
l_int|0x00000009
suffix:colon
id|printk
c_func
(paren
l_string|&quot;nicstar%d: PHY seems to be 25 Mbps.&bslash;n&quot;
comma
id|i
)paren
suffix:semicolon
id|card-&gt;max_pcr
op_assign
id|ATM_25_PCR
suffix:semicolon
r_while
c_loop
(paren
id|CMD_BUSY
c_func
(paren
id|card
)paren
)paren
(brace
suffix:semicolon
)brace
id|writel
c_func
(paren
l_int|0x00000008
comma
id|card-&gt;membase
op_plus
id|DR0
)paren
suffix:semicolon
id|writel
c_func
(paren
id|NS_CMD_WRITE_UTILITY
op_or
l_int|0x00000200
comma
id|card-&gt;membase
op_plus
id|CMD
)paren
suffix:semicolon
multiline_comment|/* Clear an eventual pending interrupt */
id|writel
c_func
(paren
id|NS_STAT_SFBQF
comma
id|card-&gt;membase
op_plus
id|STAT
)paren
suffix:semicolon
macro_line|#ifdef PHY_LOOPBACK
r_while
c_loop
(paren
id|CMD_BUSY
c_func
(paren
id|card
)paren
)paren
(brace
suffix:semicolon
)brace
id|writel
c_func
(paren
l_int|0x00000022
comma
id|card-&gt;membase
op_plus
id|DR0
)paren
suffix:semicolon
id|writel
c_func
(paren
id|NS_CMD_WRITE_UTILITY
op_or
l_int|0x00000202
comma
id|card-&gt;membase
op_plus
id|CMD
)paren
suffix:semicolon
macro_line|#endif /* PHY_LOOPBACK */
r_break
suffix:semicolon
r_case
l_int|0x00000030
suffix:colon
r_case
l_int|0x00000031
suffix:colon
id|printk
c_func
(paren
l_string|&quot;nicstar%d: PHY seems to be 155 Mbps.&bslash;n&quot;
comma
id|i
)paren
suffix:semicolon
id|card-&gt;max_pcr
op_assign
id|ATM_OC3_PCR
suffix:semicolon
macro_line|#ifdef PHY_LOOPBACK
r_while
c_loop
(paren
id|CMD_BUSY
c_func
(paren
id|card
)paren
)paren
(brace
suffix:semicolon
)brace
id|writel
c_func
(paren
l_int|0x00000002
comma
id|card-&gt;membase
op_plus
id|DR0
)paren
suffix:semicolon
id|writel
c_func
(paren
id|NS_CMD_WRITE_UTILITY
op_or
l_int|0x00000205
comma
id|card-&gt;membase
op_plus
id|CMD
)paren
suffix:semicolon
macro_line|#endif /* PHY_LOOPBACK */
r_break
suffix:semicolon
r_default
suffix:colon
id|printk
c_func
(paren
l_string|&quot;nicstar%d: unknown PHY type (0x%08X).&bslash;n&quot;
comma
id|i
comma
id|data
)paren
suffix:semicolon
id|error
op_assign
l_int|8
suffix:semicolon
id|ns_init_card_error
c_func
(paren
id|card
comma
id|error
)paren
suffix:semicolon
r_return
id|error
suffix:semicolon
)brace
id|writel
c_func
(paren
l_int|0x00000000
comma
id|card-&gt;membase
op_plus
id|GP
)paren
suffix:semicolon
multiline_comment|/* Determine SRAM size */
id|data
op_assign
l_int|0x76543210
suffix:semicolon
id|ns_write_sram
c_func
(paren
id|card
comma
l_int|0x1C003
comma
op_amp
id|data
comma
l_int|1
)paren
suffix:semicolon
id|data
op_assign
l_int|0x89ABCDEF
suffix:semicolon
id|ns_write_sram
c_func
(paren
id|card
comma
l_int|0x14003
comma
op_amp
id|data
comma
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ns_read_sram
c_func
(paren
id|card
comma
l_int|0x14003
)paren
op_eq
l_int|0x89ABCDEF
op_logical_and
id|ns_read_sram
c_func
(paren
id|card
comma
l_int|0x1C003
)paren
op_eq
l_int|0x76543210
)paren
id|card-&gt;sram_size
op_assign
l_int|128
suffix:semicolon
r_else
id|card-&gt;sram_size
op_assign
l_int|32
suffix:semicolon
id|PRINTK
c_func
(paren
l_string|&quot;nicstar%d: %dK x 32bit SRAM size.&bslash;n&quot;
comma
id|i
comma
id|card-&gt;sram_size
)paren
suffix:semicolon
id|card-&gt;rct_size
op_assign
id|NS_MAX_RCTSIZE
suffix:semicolon
macro_line|#if (NS_MAX_RCTSIZE == 4096)
r_if
c_cond
(paren
id|card-&gt;sram_size
op_eq
l_int|128
)paren
id|printk
c_func
(paren
l_string|&quot;nicstar%d: limiting maximum VCI. See NS_MAX_RCTSIZE in nicstar.h&bslash;n&quot;
comma
id|i
)paren
suffix:semicolon
macro_line|#elif (NS_MAX_RCTSIZE == 16384)
r_if
c_cond
(paren
id|card-&gt;sram_size
op_eq
l_int|32
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;nicstar%d: wasting memory. See NS_MAX_RCTSIZE in nicstar.h&bslash;n&quot;
comma
id|i
)paren
suffix:semicolon
id|card-&gt;rct_size
op_assign
l_int|4096
suffix:semicolon
)brace
macro_line|#else
macro_line|#error NS_MAX_RCTSIZE must be either 4096 or 16384 in nicstar.c
macro_line|#endif
id|card-&gt;vpibits
op_assign
id|NS_VPIBITS
suffix:semicolon
r_if
c_cond
(paren
id|card-&gt;rct_size
op_eq
l_int|4096
)paren
id|card-&gt;vcibits
op_assign
l_int|12
op_minus
id|NS_VPIBITS
suffix:semicolon
r_else
multiline_comment|/* card-&gt;rct_size == 16384 */
id|card-&gt;vcibits
op_assign
l_int|14
op_minus
id|NS_VPIBITS
suffix:semicolon
multiline_comment|/* Initialize the nicstar eeprom/eprom stuff, for the MAC addr */
r_if
c_cond
(paren
id|mac
(braket
id|i
)braket
op_eq
l_int|NULL
)paren
id|nicstar_init_eprom
c_func
(paren
id|card-&gt;membase
)paren
suffix:semicolon
r_if
c_cond
(paren
id|request_irq
c_func
(paren
id|pcidev-&gt;irq
comma
op_amp
id|ns_irq_handler
comma
id|SA_INTERRUPT
op_or
id|SA_SHIRQ
comma
l_string|&quot;nicstar&quot;
comma
id|card
)paren
op_ne
l_int|0
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;nicstar%d: can&squot;t allocate IRQ %d.&bslash;n&quot;
comma
id|i
comma
id|pcidev-&gt;irq
)paren
suffix:semicolon
id|error
op_assign
l_int|9
suffix:semicolon
id|ns_init_card_error
c_func
(paren
id|card
comma
id|error
)paren
suffix:semicolon
r_return
id|error
suffix:semicolon
)brace
multiline_comment|/* Set the VPI/VCI MSb mask to zero so we can receive OAM cells */
id|writel
c_func
(paren
l_int|0x00000000
comma
id|card-&gt;membase
op_plus
id|VPM
)paren
suffix:semicolon
multiline_comment|/* Initialize TSQ */
id|card-&gt;tsq.org
op_assign
id|kmalloc
c_func
(paren
id|NS_TSQSIZE
op_plus
id|NS_TSQ_ALIGNMENT
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|card-&gt;tsq.org
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;nicstar%d: can&squot;t allocate TSQ.&bslash;n&quot;
comma
id|i
)paren
suffix:semicolon
id|error
op_assign
l_int|10
suffix:semicolon
id|ns_init_card_error
c_func
(paren
id|card
comma
id|error
)paren
suffix:semicolon
r_return
id|error
suffix:semicolon
)brace
id|card-&gt;tsq.base
op_assign
(paren
id|ns_tsi
op_star
)paren
id|ALIGN_ADDRESS
c_func
(paren
id|card-&gt;tsq.org
comma
id|NS_TSQ_ALIGNMENT
)paren
suffix:semicolon
id|card-&gt;tsq.next
op_assign
id|card-&gt;tsq.base
suffix:semicolon
id|card-&gt;tsq.last
op_assign
id|card-&gt;tsq.base
op_plus
(paren
id|NS_TSQ_NUM_ENTRIES
op_minus
l_int|1
)paren
suffix:semicolon
r_for
c_loop
(paren
id|j
op_assign
l_int|0
suffix:semicolon
id|j
OL
id|NS_TSQ_NUM_ENTRIES
suffix:semicolon
id|j
op_increment
)paren
id|ns_tsi_init
c_func
(paren
id|card-&gt;tsq.base
op_plus
id|j
)paren
suffix:semicolon
id|writel
c_func
(paren
l_int|0x00000000
comma
id|card-&gt;membase
op_plus
id|TSQH
)paren
suffix:semicolon
id|writel
c_func
(paren
(paren
id|u32
)paren
id|virt_to_bus
c_func
(paren
id|card-&gt;tsq.base
)paren
comma
id|card-&gt;membase
op_plus
id|TSQB
)paren
suffix:semicolon
id|PRINTK
c_func
(paren
l_string|&quot;nicstar%d: TSQ base at 0x%x  0x%x  0x%x.&bslash;n&quot;
comma
id|i
comma
(paren
id|u32
)paren
id|card-&gt;tsq.base
comma
(paren
id|u32
)paren
id|virt_to_bus
c_func
(paren
id|card-&gt;tsq.base
)paren
comma
id|readl
c_func
(paren
id|card-&gt;membase
op_plus
id|TSQB
)paren
)paren
suffix:semicolon
multiline_comment|/* Initialize RSQ */
id|card-&gt;rsq.org
op_assign
id|kmalloc
c_func
(paren
id|NS_RSQSIZE
op_plus
id|NS_RSQ_ALIGNMENT
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|card-&gt;rsq.org
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;nicstar%d: can&squot;t allocate RSQ.&bslash;n&quot;
comma
id|i
)paren
suffix:semicolon
id|error
op_assign
l_int|11
suffix:semicolon
id|ns_init_card_error
c_func
(paren
id|card
comma
id|error
)paren
suffix:semicolon
r_return
id|error
suffix:semicolon
)brace
id|card-&gt;rsq.base
op_assign
(paren
id|ns_rsqe
op_star
)paren
id|ALIGN_ADDRESS
c_func
(paren
id|card-&gt;rsq.org
comma
id|NS_RSQ_ALIGNMENT
)paren
suffix:semicolon
id|card-&gt;rsq.next
op_assign
id|card-&gt;rsq.base
suffix:semicolon
id|card-&gt;rsq.last
op_assign
id|card-&gt;rsq.base
op_plus
(paren
id|NS_RSQ_NUM_ENTRIES
op_minus
l_int|1
)paren
suffix:semicolon
r_for
c_loop
(paren
id|j
op_assign
l_int|0
suffix:semicolon
id|j
OL
id|NS_RSQ_NUM_ENTRIES
suffix:semicolon
id|j
op_increment
)paren
id|ns_rsqe_init
c_func
(paren
id|card-&gt;rsq.base
op_plus
id|j
)paren
suffix:semicolon
id|writel
c_func
(paren
l_int|0x00000000
comma
id|card-&gt;membase
op_plus
id|RSQH
)paren
suffix:semicolon
id|writel
c_func
(paren
(paren
id|u32
)paren
id|virt_to_bus
c_func
(paren
id|card-&gt;rsq.base
)paren
comma
id|card-&gt;membase
op_plus
id|RSQB
)paren
suffix:semicolon
id|PRINTK
c_func
(paren
l_string|&quot;nicstar%d: RSQ base at 0x%x.&bslash;n&quot;
comma
id|i
comma
(paren
id|u32
)paren
id|card-&gt;rsq.base
)paren
suffix:semicolon
multiline_comment|/* Initialize SCQ0, the only VBR SCQ used */
id|card-&gt;scq1
op_assign
(paren
id|scq_info
op_star
)paren
l_int|NULL
suffix:semicolon
id|card-&gt;scq2
op_assign
(paren
id|scq_info
op_star
)paren
l_int|NULL
suffix:semicolon
id|card-&gt;scq0
op_assign
id|get_scq
c_func
(paren
id|VBR_SCQSIZE
comma
id|NS_VRSCD0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|card-&gt;scq0
op_eq
(paren
id|scq_info
op_star
)paren
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;nicstar%d: can&squot;t get SCQ0.&bslash;n&quot;
comma
id|i
)paren
suffix:semicolon
id|error
op_assign
l_int|12
suffix:semicolon
id|ns_init_card_error
c_func
(paren
id|card
comma
id|error
)paren
suffix:semicolon
r_return
id|error
suffix:semicolon
)brace
id|u32d
(braket
l_int|0
)braket
op_assign
(paren
id|u32
)paren
id|virt_to_bus
c_func
(paren
id|card-&gt;scq0-&gt;base
)paren
suffix:semicolon
id|u32d
(braket
l_int|1
)braket
op_assign
(paren
id|u32
)paren
l_int|0x00000000
suffix:semicolon
id|u32d
(braket
l_int|2
)braket
op_assign
(paren
id|u32
)paren
l_int|0xffffffff
suffix:semicolon
id|u32d
(braket
l_int|3
)braket
op_assign
(paren
id|u32
)paren
l_int|0x00000000
suffix:semicolon
id|ns_write_sram
c_func
(paren
id|card
comma
id|NS_VRSCD0
comma
id|u32d
comma
l_int|4
)paren
suffix:semicolon
id|ns_write_sram
c_func
(paren
id|card
comma
id|NS_VRSCD1
comma
id|u32d
comma
l_int|4
)paren
suffix:semicolon
multiline_comment|/* These last two won&squot;t be used */
id|ns_write_sram
c_func
(paren
id|card
comma
id|NS_VRSCD2
comma
id|u32d
comma
l_int|4
)paren
suffix:semicolon
multiline_comment|/* but are initialized, just in case... */
id|card-&gt;scq0-&gt;scd
op_assign
id|NS_VRSCD0
suffix:semicolon
id|PRINTK
c_func
(paren
l_string|&quot;nicstar%d: VBR-SCQ0 base at 0x%x.&bslash;n&quot;
comma
id|i
comma
(paren
id|u32
)paren
id|card-&gt;scq0-&gt;base
)paren
suffix:semicolon
multiline_comment|/* Initialize TSTs */
id|card-&gt;tst_addr
op_assign
id|NS_TST0
suffix:semicolon
id|card-&gt;tst_free_entries
op_assign
id|NS_TST_NUM_ENTRIES
suffix:semicolon
id|data
op_assign
id|NS_TST_OPCODE_VARIABLE
suffix:semicolon
r_for
c_loop
(paren
id|j
op_assign
l_int|0
suffix:semicolon
id|j
OL
id|NS_TST_NUM_ENTRIES
suffix:semicolon
id|j
op_increment
)paren
id|ns_write_sram
c_func
(paren
id|card
comma
id|NS_TST0
op_plus
id|j
comma
op_amp
id|data
comma
l_int|1
)paren
suffix:semicolon
id|data
op_assign
id|ns_tste_make
c_func
(paren
id|NS_TST_OPCODE_END
comma
id|NS_TST0
)paren
suffix:semicolon
id|ns_write_sram
c_func
(paren
id|card
comma
id|NS_TST0
op_plus
id|NS_TST_NUM_ENTRIES
comma
op_amp
id|data
comma
l_int|1
)paren
suffix:semicolon
r_for
c_loop
(paren
id|j
op_assign
l_int|0
suffix:semicolon
id|j
OL
id|NS_TST_NUM_ENTRIES
suffix:semicolon
id|j
op_increment
)paren
id|ns_write_sram
c_func
(paren
id|card
comma
id|NS_TST1
op_plus
id|j
comma
op_amp
id|data
comma
l_int|1
)paren
suffix:semicolon
id|data
op_assign
id|ns_tste_make
c_func
(paren
id|NS_TST_OPCODE_END
comma
id|NS_TST1
)paren
suffix:semicolon
id|ns_write_sram
c_func
(paren
id|card
comma
id|NS_TST1
op_plus
id|NS_TST_NUM_ENTRIES
comma
op_amp
id|data
comma
l_int|1
)paren
suffix:semicolon
r_for
c_loop
(paren
id|j
op_assign
l_int|0
suffix:semicolon
id|j
OL
id|NS_TST_NUM_ENTRIES
suffix:semicolon
id|j
op_increment
)paren
id|card-&gt;tste2vc
(braket
id|j
)braket
op_assign
l_int|NULL
suffix:semicolon
id|writel
c_func
(paren
id|NS_TST0
op_lshift
l_int|2
comma
id|card-&gt;membase
op_plus
id|TSTB
)paren
suffix:semicolon
multiline_comment|/* Initialize RCT. AAL type is set on opening the VC. */
macro_line|#ifdef RCQ_SUPPORT
id|u32d
(braket
l_int|0
)braket
op_assign
id|NS_RCTE_RAWCELLINTEN
suffix:semicolon
macro_line|#else
id|u32d
(braket
l_int|0
)braket
op_assign
l_int|0x00000000
suffix:semicolon
macro_line|#endif RCQ_SUPPORT
id|u32d
(braket
l_int|1
)braket
op_assign
l_int|0x00000000
suffix:semicolon
id|u32d
(braket
l_int|2
)braket
op_assign
l_int|0x00000000
suffix:semicolon
id|u32d
(braket
l_int|3
)braket
op_assign
l_int|0xFFFFFFFF
suffix:semicolon
r_for
c_loop
(paren
id|j
op_assign
l_int|0
suffix:semicolon
id|j
OL
id|card-&gt;rct_size
suffix:semicolon
id|j
op_increment
)paren
id|ns_write_sram
c_func
(paren
id|card
comma
id|j
op_star
l_int|4
comma
id|u32d
comma
l_int|4
)paren
suffix:semicolon
id|memset
c_func
(paren
id|card-&gt;vcmap
comma
l_int|0
comma
id|NS_MAX_RCTSIZE
op_star
r_sizeof
(paren
id|vc_map
)paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|j
op_assign
l_int|0
suffix:semicolon
id|j
OL
id|NS_FRSCD_NUM
suffix:semicolon
id|j
op_increment
)paren
id|card-&gt;scd2vc
(braket
id|j
)braket
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/* Initialize buffer levels */
id|card-&gt;sbnr.min
op_assign
id|MIN_SB
suffix:semicolon
id|card-&gt;sbnr.init
op_assign
id|NUM_SB
suffix:semicolon
id|card-&gt;sbnr.max
op_assign
id|MAX_SB
suffix:semicolon
id|card-&gt;lbnr.min
op_assign
id|MIN_LB
suffix:semicolon
id|card-&gt;lbnr.init
op_assign
id|NUM_LB
suffix:semicolon
id|card-&gt;lbnr.max
op_assign
id|MAX_LB
suffix:semicolon
id|card-&gt;iovnr.min
op_assign
id|MIN_IOVB
suffix:semicolon
id|card-&gt;iovnr.init
op_assign
id|NUM_IOVB
suffix:semicolon
id|card-&gt;iovnr.max
op_assign
id|MAX_IOVB
suffix:semicolon
id|card-&gt;hbnr.min
op_assign
id|MIN_HB
suffix:semicolon
id|card-&gt;hbnr.init
op_assign
id|NUM_HB
suffix:semicolon
id|card-&gt;hbnr.max
op_assign
id|MAX_HB
suffix:semicolon
id|card-&gt;sm_handle
op_assign
l_int|0x00000000
suffix:semicolon
id|card-&gt;sm_addr
op_assign
l_int|0x00000000
suffix:semicolon
id|card-&gt;lg_handle
op_assign
l_int|0x00000000
suffix:semicolon
id|card-&gt;lg_addr
op_assign
l_int|0x00000000
suffix:semicolon
id|card-&gt;efbie
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* To prevent push_rxbufs from enabling the interrupt */
multiline_comment|/* Pre-allocate some huge buffers */
id|skb_queue_head_init
c_func
(paren
op_amp
id|card-&gt;hbpool.queue
)paren
suffix:semicolon
id|card-&gt;hbpool.count
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|j
op_assign
l_int|0
suffix:semicolon
id|j
OL
id|NUM_HB
suffix:semicolon
id|j
op_increment
)paren
(brace
r_struct
id|sk_buff
op_star
id|hb
suffix:semicolon
id|hb
op_assign
id|alloc_skb
c_func
(paren
id|NS_HBUFSIZE
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|hb
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;nicstar%d: can&squot;t allocate %dth of %d huge buffers.&bslash;n&quot;
comma
id|i
comma
id|j
comma
id|NUM_HB
)paren
suffix:semicolon
id|error
op_assign
l_int|13
suffix:semicolon
id|ns_init_card_error
c_func
(paren
id|card
comma
id|error
)paren
suffix:semicolon
r_return
id|error
suffix:semicolon
)brace
id|skb_queue_tail
c_func
(paren
op_amp
id|card-&gt;hbpool.queue
comma
id|hb
)paren
suffix:semicolon
id|card-&gt;hbpool.count
op_increment
suffix:semicolon
)brace
multiline_comment|/* Allocate large buffers */
id|skb_queue_head_init
c_func
(paren
op_amp
id|card-&gt;lbpool.queue
)paren
suffix:semicolon
id|card-&gt;lbpool.count
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Not used */
r_for
c_loop
(paren
id|j
op_assign
l_int|0
suffix:semicolon
id|j
OL
id|NUM_LB
suffix:semicolon
id|j
op_increment
)paren
(brace
r_struct
id|sk_buff
op_star
id|lb
suffix:semicolon
id|lb
op_assign
id|alloc_skb
c_func
(paren
id|NS_LGSKBSIZE
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|lb
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;nicstar%d: can&squot;t allocate %dth of %d large buffers.&bslash;n&quot;
comma
id|i
comma
id|j
comma
id|NUM_LB
)paren
suffix:semicolon
id|error
op_assign
l_int|14
suffix:semicolon
id|ns_init_card_error
c_func
(paren
id|card
comma
id|error
)paren
suffix:semicolon
r_return
id|error
suffix:semicolon
)brace
id|skb_queue_tail
c_func
(paren
op_amp
id|card-&gt;lbpool.queue
comma
id|lb
)paren
suffix:semicolon
id|skb_reserve
c_func
(paren
id|lb
comma
id|NS_SMBUFSIZE
)paren
suffix:semicolon
id|push_rxbufs
c_func
(paren
id|card
comma
id|BUF_LG
comma
(paren
id|u32
)paren
id|lb
comma
(paren
id|u32
)paren
id|virt_to_bus
c_func
(paren
id|lb-&gt;data
)paren
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* Due to the implementation of push_rxbufs() this is 1, not 0 */
r_if
c_cond
(paren
id|j
op_eq
l_int|1
)paren
(brace
id|card-&gt;rcbuf
op_assign
id|lb
suffix:semicolon
id|card-&gt;rawch
op_assign
(paren
id|u32
)paren
id|virt_to_bus
c_func
(paren
id|lb-&gt;data
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* Test for strange behaviour which leads to crashes */
r_if
c_cond
(paren
(paren
id|bcount
op_assign
id|ns_stat_lfbqc_get
c_func
(paren
id|readl
c_func
(paren
id|card-&gt;membase
op_plus
id|STAT
)paren
)paren
)paren
OL
id|card-&gt;lbnr.min
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;nicstar%d: Strange... Just allocated %d large buffers and lfbqc = %d.&bslash;n&quot;
comma
id|i
comma
id|j
comma
id|bcount
)paren
suffix:semicolon
id|error
op_assign
l_int|14
suffix:semicolon
id|ns_init_card_error
c_func
(paren
id|card
comma
id|error
)paren
suffix:semicolon
r_return
id|error
suffix:semicolon
)brace
multiline_comment|/* Allocate small buffers */
id|skb_queue_head_init
c_func
(paren
op_amp
id|card-&gt;sbpool.queue
)paren
suffix:semicolon
id|card-&gt;sbpool.count
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Not used */
r_for
c_loop
(paren
id|j
op_assign
l_int|0
suffix:semicolon
id|j
OL
id|NUM_SB
suffix:semicolon
id|j
op_increment
)paren
(brace
r_struct
id|sk_buff
op_star
id|sb
suffix:semicolon
id|sb
op_assign
id|alloc_skb
c_func
(paren
id|NS_SMSKBSIZE
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sb
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;nicstar%d: can&squot;t allocate %dth of %d small buffers.&bslash;n&quot;
comma
id|i
comma
id|j
comma
id|NUM_SB
)paren
suffix:semicolon
id|error
op_assign
l_int|15
suffix:semicolon
id|ns_init_card_error
c_func
(paren
id|card
comma
id|error
)paren
suffix:semicolon
r_return
id|error
suffix:semicolon
)brace
id|skb_queue_tail
c_func
(paren
op_amp
id|card-&gt;sbpool.queue
comma
id|sb
)paren
suffix:semicolon
id|skb_reserve
c_func
(paren
id|sb
comma
id|NS_AAL0_HEADER
)paren
suffix:semicolon
id|push_rxbufs
c_func
(paren
id|card
comma
id|BUF_SM
comma
(paren
id|u32
)paren
id|sb
comma
(paren
id|u32
)paren
id|virt_to_bus
c_func
(paren
id|sb-&gt;data
)paren
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
)brace
multiline_comment|/* Test for strange behaviour which leads to crashes */
r_if
c_cond
(paren
(paren
id|bcount
op_assign
id|ns_stat_sfbqc_get
c_func
(paren
id|readl
c_func
(paren
id|card-&gt;membase
op_plus
id|STAT
)paren
)paren
)paren
OL
id|card-&gt;sbnr.min
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;nicstar%d: Strange... Just allocated %d small buffers and sfbqc = %d.&bslash;n&quot;
comma
id|i
comma
id|j
comma
id|bcount
)paren
suffix:semicolon
id|error
op_assign
l_int|15
suffix:semicolon
id|ns_init_card_error
c_func
(paren
id|card
comma
id|error
)paren
suffix:semicolon
r_return
id|error
suffix:semicolon
)brace
multiline_comment|/* Allocate iovec buffers */
id|skb_queue_head_init
c_func
(paren
op_amp
id|card-&gt;iovpool.queue
)paren
suffix:semicolon
id|card-&gt;iovpool.count
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|j
op_assign
l_int|0
suffix:semicolon
id|j
OL
id|NUM_IOVB
suffix:semicolon
id|j
op_increment
)paren
(brace
r_struct
id|sk_buff
op_star
id|iovb
suffix:semicolon
id|iovb
op_assign
id|alloc_skb
c_func
(paren
id|NS_IOVBUFSIZE
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|iovb
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;nicstar%d: can&squot;t allocate %dth of %d iovec buffers.&bslash;n&quot;
comma
id|i
comma
id|j
comma
id|NUM_IOVB
)paren
suffix:semicolon
id|error
op_assign
l_int|16
suffix:semicolon
id|ns_init_card_error
c_func
(paren
id|card
comma
id|error
)paren
suffix:semicolon
r_return
id|error
suffix:semicolon
)brace
id|skb_queue_tail
c_func
(paren
op_amp
id|card-&gt;iovpool.queue
comma
id|iovb
)paren
suffix:semicolon
id|card-&gt;iovpool.count
op_increment
suffix:semicolon
)brace
id|card-&gt;intcnt
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Configure NICStAR */
r_if
c_cond
(paren
id|card-&gt;rct_size
op_eq
l_int|4096
)paren
id|ns_cfg_rctsize
op_assign
id|NS_CFG_RCTSIZE_4096_ENTRIES
suffix:semicolon
r_else
multiline_comment|/* (card-&gt;rct_size == 16384) */
id|ns_cfg_rctsize
op_assign
id|NS_CFG_RCTSIZE_16384_ENTRIES
suffix:semicolon
id|card-&gt;efbie
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* Register device */
id|card-&gt;atmdev
op_assign
id|atm_dev_register
c_func
(paren
l_string|&quot;nicstar&quot;
comma
op_amp
id|atm_ops
comma
op_minus
l_int|1
comma
l_int|NULL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|card-&gt;atmdev
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;nicstar%d: can&squot;t register device.&bslash;n&quot;
comma
id|i
)paren
suffix:semicolon
id|error
op_assign
l_int|17
suffix:semicolon
id|ns_init_card_error
c_func
(paren
id|card
comma
id|error
)paren
suffix:semicolon
r_return
id|error
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ns_parse_mac
c_func
(paren
id|mac
(braket
id|i
)braket
comma
id|card-&gt;atmdev-&gt;esi
)paren
)paren
id|nicstar_read_eprom
c_func
(paren
id|card-&gt;membase
comma
id|NICSTAR_EPROM_MAC_ADDR_OFFSET
comma
id|card-&gt;atmdev-&gt;esi
comma
l_int|6
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;nicstar%d: MAC address %02X:%02X:%02X:%02X:%02X:%02X&bslash;n&quot;
comma
id|i
comma
id|card-&gt;atmdev-&gt;esi
(braket
l_int|0
)braket
comma
id|card-&gt;atmdev-&gt;esi
(braket
l_int|1
)braket
comma
id|card-&gt;atmdev-&gt;esi
(braket
l_int|2
)braket
comma
id|card-&gt;atmdev-&gt;esi
(braket
l_int|3
)braket
comma
id|card-&gt;atmdev-&gt;esi
(braket
l_int|4
)braket
comma
id|card-&gt;atmdev-&gt;esi
(braket
l_int|5
)braket
)paren
suffix:semicolon
id|card-&gt;atmdev-&gt;dev_data
op_assign
id|card
suffix:semicolon
id|card-&gt;atmdev-&gt;ci_range.vpi_bits
op_assign
id|card-&gt;vpibits
suffix:semicolon
id|card-&gt;atmdev-&gt;ci_range.vci_bits
op_assign
id|card-&gt;vcibits
suffix:semicolon
id|card-&gt;atmdev-&gt;link_rate
op_assign
id|card-&gt;max_pcr
suffix:semicolon
id|card-&gt;atmdev-&gt;phy
op_assign
l_int|NULL
suffix:semicolon
macro_line|#ifdef CONFIG_ATM_NICSTAR_USE_SUNI
r_if
c_cond
(paren
id|card-&gt;max_pcr
op_eq
id|ATM_OC3_PCR
)paren
(brace
id|suni_init
c_func
(paren
id|card-&gt;atmdev
)paren
suffix:semicolon
id|MOD_INC_USE_COUNT
suffix:semicolon
multiline_comment|/* Can&squot;t remove the nicstar driver or the suni driver would oops */
)brace
macro_line|#endif /* CONFIG_ATM_NICSTAR_USE_SUNI */
macro_line|#ifdef CONFIG_ATM_NICSTAR_USE_IDT77105
r_if
c_cond
(paren
id|card-&gt;max_pcr
op_eq
id|ATM_25_PCR
)paren
(brace
id|idt77105_init
c_func
(paren
id|card-&gt;atmdev
)paren
suffix:semicolon
multiline_comment|/* Note that for the IDT77105 PHY we don&squot;t need the awful&n;       * module count hack that the SUNI needs because we can&n;       * stop the &squot;105 when the nicstar module is cleaned up.&n;       */
)brace
macro_line|#endif /* CONFIG_ATM_NICSTAR_USE_IDT77105 */
r_if
c_cond
(paren
id|card-&gt;atmdev-&gt;phy
op_logical_and
id|card-&gt;atmdev-&gt;phy-&gt;start
)paren
id|card-&gt;atmdev-&gt;phy
op_member_access_from_pointer
id|start
c_func
(paren
id|card-&gt;atmdev
)paren
suffix:semicolon
id|writel
c_func
(paren
id|NS_CFG_RXPATH
op_or
id|NS_CFG_SMBUFSIZE
op_or
id|NS_CFG_LGBUFSIZE
op_or
id|NS_CFG_EFBIE
op_or
id|NS_CFG_RSQSIZE
op_or
id|NS_CFG_VPIBITS
op_or
id|ns_cfg_rctsize
op_or
id|NS_CFG_RXINT_NODELAY
op_or
id|NS_CFG_RAWIE
op_or
multiline_comment|/* Only enabled if RCQ_SUPPORT */
id|NS_CFG_RSQAFIE
op_or
id|NS_CFG_TXEN
op_or
id|NS_CFG_TXIE
op_or
id|NS_CFG_TSQFIE_OPT
op_or
multiline_comment|/* Only enabled if ENABLE_TSQFIE */
id|NS_CFG_PHYIE
comma
id|card-&gt;membase
op_plus
id|CFG
)paren
suffix:semicolon
id|num_cards
op_increment
suffix:semicolon
r_return
id|error
suffix:semicolon
)brace
DECL|function|ns_init_card_error
r_static
r_void
id|ns_init_card_error
c_func
(paren
id|ns_dev
op_star
id|card
comma
r_int
id|error
)paren
(brace
r_if
c_cond
(paren
id|error
op_ge
l_int|17
)paren
(brace
id|writel
c_func
(paren
l_int|0x00000000
comma
id|card-&gt;membase
op_plus
id|CFG
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|error
op_ge
l_int|16
)paren
(brace
r_struct
id|sk_buff
op_star
id|iovb
suffix:semicolon
r_while
c_loop
(paren
(paren
id|iovb
op_assign
id|skb_dequeue
c_func
(paren
op_amp
id|card-&gt;iovpool.queue
)paren
)paren
op_ne
l_int|NULL
)paren
id|dev_kfree_skb_any
c_func
(paren
id|iovb
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|error
op_ge
l_int|15
)paren
(brace
r_struct
id|sk_buff
op_star
id|sb
suffix:semicolon
r_while
c_loop
(paren
(paren
id|sb
op_assign
id|skb_dequeue
c_func
(paren
op_amp
id|card-&gt;sbpool.queue
)paren
)paren
op_ne
l_int|NULL
)paren
id|dev_kfree_skb_any
c_func
(paren
id|sb
)paren
suffix:semicolon
id|free_scq
c_func
(paren
id|card-&gt;scq0
comma
l_int|NULL
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|error
op_ge
l_int|14
)paren
(brace
r_struct
id|sk_buff
op_star
id|lb
suffix:semicolon
r_while
c_loop
(paren
(paren
id|lb
op_assign
id|skb_dequeue
c_func
(paren
op_amp
id|card-&gt;lbpool.queue
)paren
)paren
op_ne
l_int|NULL
)paren
id|dev_kfree_skb_any
c_func
(paren
id|lb
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|error
op_ge
l_int|13
)paren
(brace
r_struct
id|sk_buff
op_star
id|hb
suffix:semicolon
r_while
c_loop
(paren
(paren
id|hb
op_assign
id|skb_dequeue
c_func
(paren
op_amp
id|card-&gt;hbpool.queue
)paren
)paren
op_ne
l_int|NULL
)paren
id|dev_kfree_skb_any
c_func
(paren
id|hb
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|error
op_ge
l_int|12
)paren
(brace
id|kfree
c_func
(paren
id|card-&gt;rsq.org
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|error
op_ge
l_int|11
)paren
(brace
id|kfree
c_func
(paren
id|card-&gt;tsq.org
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|error
op_ge
l_int|10
)paren
(brace
id|free_irq
c_func
(paren
id|card-&gt;pcidev-&gt;irq
comma
id|card
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|error
op_ge
l_int|4
)paren
(brace
id|iounmap
c_func
(paren
(paren
r_void
op_star
)paren
id|card-&gt;membase
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|error
op_ge
l_int|3
)paren
(brace
id|kfree
c_func
(paren
id|card
)paren
suffix:semicolon
)brace
)brace
DECL|function|get_scq
r_static
id|scq_info
op_star
id|get_scq
c_func
(paren
r_int
id|size
comma
id|u32
id|scd
)paren
(brace
id|scq_info
op_star
id|scq
suffix:semicolon
r_int
id|i
suffix:semicolon
r_if
c_cond
(paren
id|size
op_ne
id|VBR_SCQSIZE
op_logical_and
id|size
op_ne
id|CBR_SCQSIZE
)paren
r_return
(paren
id|scq_info
op_star
)paren
l_int|NULL
suffix:semicolon
id|scq
op_assign
(paren
id|scq_info
op_star
)paren
id|kmalloc
c_func
(paren
r_sizeof
(paren
id|scq_info
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|scq
op_eq
(paren
id|scq_info
op_star
)paren
l_int|NULL
)paren
r_return
(paren
id|scq_info
op_star
)paren
l_int|NULL
suffix:semicolon
id|scq-&gt;org
op_assign
id|kmalloc
c_func
(paren
l_int|2
op_star
id|size
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|scq-&gt;org
op_eq
l_int|NULL
)paren
(brace
id|kfree
c_func
(paren
id|scq
)paren
suffix:semicolon
r_return
(paren
id|scq_info
op_star
)paren
l_int|NULL
suffix:semicolon
)brace
id|scq-&gt;skb
op_assign
(paren
r_struct
id|sk_buff
op_star
op_star
)paren
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|sk_buff
op_star
)paren
op_star
(paren
id|size
op_div
id|NS_SCQE_SIZE
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|scq-&gt;skb
op_eq
(paren
r_struct
id|sk_buff
op_star
op_star
)paren
l_int|NULL
)paren
(brace
id|kfree
c_func
(paren
id|scq-&gt;org
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|scq
)paren
suffix:semicolon
r_return
(paren
id|scq_info
op_star
)paren
l_int|NULL
suffix:semicolon
)brace
id|scq-&gt;num_entries
op_assign
id|size
op_div
id|NS_SCQE_SIZE
suffix:semicolon
id|scq-&gt;base
op_assign
(paren
id|ns_scqe
op_star
)paren
id|ALIGN_ADDRESS
c_func
(paren
id|scq-&gt;org
comma
id|size
)paren
suffix:semicolon
id|scq-&gt;next
op_assign
id|scq-&gt;base
suffix:semicolon
id|scq-&gt;last
op_assign
id|scq-&gt;base
op_plus
(paren
id|scq-&gt;num_entries
op_minus
l_int|1
)paren
suffix:semicolon
id|scq-&gt;tail
op_assign
id|scq-&gt;last
suffix:semicolon
id|scq-&gt;scd
op_assign
id|scd
suffix:semicolon
id|scq-&gt;num_entries
op_assign
id|size
op_div
id|NS_SCQE_SIZE
suffix:semicolon
id|scq-&gt;tbd_count
op_assign
l_int|0
suffix:semicolon
id|init_waitqueue_head
c_func
(paren
op_amp
id|scq-&gt;scqfull_waitq
)paren
suffix:semicolon
id|scq-&gt;full
op_assign
l_int|0
suffix:semicolon
id|spin_lock_init
c_func
(paren
op_amp
id|scq-&gt;lock
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|scq-&gt;num_entries
suffix:semicolon
id|i
op_increment
)paren
id|scq-&gt;skb
(braket
id|i
)braket
op_assign
l_int|NULL
suffix:semicolon
r_return
id|scq
suffix:semicolon
)brace
multiline_comment|/* For variable rate SCQ vcc must be NULL */
DECL|function|free_scq
r_static
r_void
id|free_scq
c_func
(paren
id|scq_info
op_star
id|scq
comma
r_struct
id|atm_vcc
op_star
id|vcc
)paren
(brace
r_int
id|i
suffix:semicolon
r_if
c_cond
(paren
id|scq-&gt;num_entries
op_eq
id|VBR_SCQ_NUM_ENTRIES
)paren
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|scq-&gt;num_entries
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|scq-&gt;skb
(braket
id|i
)braket
op_ne
l_int|NULL
)paren
(brace
id|vcc
op_assign
id|ATM_SKB
c_func
(paren
id|scq-&gt;skb
(braket
id|i
)braket
)paren
op_member_access_from_pointer
id|vcc
suffix:semicolon
r_if
c_cond
(paren
id|vcc-&gt;pop
op_ne
l_int|NULL
)paren
id|vcc
op_member_access_from_pointer
id|pop
c_func
(paren
id|vcc
comma
id|scq-&gt;skb
(braket
id|i
)braket
)paren
suffix:semicolon
r_else
id|dev_kfree_skb_any
c_func
(paren
id|scq-&gt;skb
(braket
id|i
)braket
)paren
suffix:semicolon
)brace
)brace
r_else
multiline_comment|/* vcc must be != NULL */
(brace
r_if
c_cond
(paren
id|vcc
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;nicstar: free_scq() called with vcc == NULL for fixed rate scq.&quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|scq-&gt;num_entries
suffix:semicolon
id|i
op_increment
)paren
id|dev_kfree_skb_any
c_func
(paren
id|scq-&gt;skb
(braket
id|i
)braket
)paren
suffix:semicolon
)brace
r_else
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|scq-&gt;num_entries
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|scq-&gt;skb
(braket
id|i
)braket
op_ne
l_int|NULL
)paren
(brace
r_if
c_cond
(paren
id|vcc-&gt;pop
op_ne
l_int|NULL
)paren
id|vcc
op_member_access_from_pointer
id|pop
c_func
(paren
id|vcc
comma
id|scq-&gt;skb
(braket
id|i
)braket
)paren
suffix:semicolon
r_else
id|dev_kfree_skb_any
c_func
(paren
id|scq-&gt;skb
(braket
id|i
)braket
)paren
suffix:semicolon
)brace
)brace
)brace
id|kfree
c_func
(paren
id|scq-&gt;skb
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|scq-&gt;org
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|scq
)paren
suffix:semicolon
)brace
multiline_comment|/* The handles passed must be pointers to the sk_buff containing the small&n;   or large buffer(s) cast to u32. */
DECL|function|push_rxbufs
r_static
r_void
id|push_rxbufs
c_func
(paren
id|ns_dev
op_star
id|card
comma
id|u32
id|type
comma
id|u32
id|handle1
comma
id|u32
id|addr1
comma
id|u32
id|handle2
comma
id|u32
id|addr2
)paren
(brace
id|u32
id|stat
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
macro_line|#ifdef GENERAL_DEBUG
r_if
c_cond
(paren
op_logical_neg
id|addr1
)paren
id|printk
c_func
(paren
l_string|&quot;nicstar%d: push_rxbufs called with addr1 = 0.&bslash;n&quot;
comma
id|card-&gt;index
)paren
suffix:semicolon
macro_line|#endif /* GENERAL_DEBUG */
id|stat
op_assign
id|readl
c_func
(paren
id|card-&gt;membase
op_plus
id|STAT
)paren
suffix:semicolon
id|card-&gt;sbfqc
op_assign
id|ns_stat_sfbqc_get
c_func
(paren
id|stat
)paren
suffix:semicolon
id|card-&gt;lbfqc
op_assign
id|ns_stat_lfbqc_get
c_func
(paren
id|stat
)paren
suffix:semicolon
r_if
c_cond
(paren
id|type
op_eq
id|BUF_SM
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|addr2
)paren
(brace
r_if
c_cond
(paren
id|card-&gt;sm_addr
)paren
(brace
id|addr2
op_assign
id|card-&gt;sm_addr
suffix:semicolon
id|handle2
op_assign
id|card-&gt;sm_handle
suffix:semicolon
id|card-&gt;sm_addr
op_assign
l_int|0x00000000
suffix:semicolon
id|card-&gt;sm_handle
op_assign
l_int|0x00000000
suffix:semicolon
)brace
r_else
multiline_comment|/* (!sm_addr) */
(brace
id|card-&gt;sm_addr
op_assign
id|addr1
suffix:semicolon
id|card-&gt;sm_handle
op_assign
id|handle1
suffix:semicolon
)brace
)brace
)brace
r_else
multiline_comment|/* type == BUF_LG */
(brace
r_if
c_cond
(paren
op_logical_neg
id|addr2
)paren
(brace
r_if
c_cond
(paren
id|card-&gt;lg_addr
)paren
(brace
id|addr2
op_assign
id|card-&gt;lg_addr
suffix:semicolon
id|handle2
op_assign
id|card-&gt;lg_handle
suffix:semicolon
id|card-&gt;lg_addr
op_assign
l_int|0x00000000
suffix:semicolon
id|card-&gt;lg_handle
op_assign
l_int|0x00000000
suffix:semicolon
)brace
r_else
multiline_comment|/* (!lg_addr) */
(brace
id|card-&gt;lg_addr
op_assign
id|addr1
suffix:semicolon
id|card-&gt;lg_handle
op_assign
id|handle1
suffix:semicolon
)brace
)brace
)brace
r_if
c_cond
(paren
id|addr2
)paren
(brace
r_if
c_cond
(paren
id|type
op_eq
id|BUF_SM
)paren
(brace
r_if
c_cond
(paren
id|card-&gt;sbfqc
op_ge
id|card-&gt;sbnr.max
)paren
(brace
id|skb_unlink
c_func
(paren
(paren
r_struct
id|sk_buff
op_star
)paren
id|handle1
)paren
suffix:semicolon
id|dev_kfree_skb_any
c_func
(paren
(paren
r_struct
id|sk_buff
op_star
)paren
id|handle1
)paren
suffix:semicolon
id|skb_unlink
c_func
(paren
(paren
r_struct
id|sk_buff
op_star
)paren
id|handle2
)paren
suffix:semicolon
id|dev_kfree_skb_any
c_func
(paren
(paren
r_struct
id|sk_buff
op_star
)paren
id|handle2
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_else
id|card-&gt;sbfqc
op_add_assign
l_int|2
suffix:semicolon
)brace
r_else
multiline_comment|/* (type == BUF_LG) */
(brace
r_if
c_cond
(paren
id|card-&gt;lbfqc
op_ge
id|card-&gt;lbnr.max
)paren
(brace
id|skb_unlink
c_func
(paren
(paren
r_struct
id|sk_buff
op_star
)paren
id|handle1
)paren
suffix:semicolon
id|dev_kfree_skb_any
c_func
(paren
(paren
r_struct
id|sk_buff
op_star
)paren
id|handle1
)paren
suffix:semicolon
id|skb_unlink
c_func
(paren
(paren
r_struct
id|sk_buff
op_star
)paren
id|handle2
)paren
suffix:semicolon
id|dev_kfree_skb_any
c_func
(paren
(paren
r_struct
id|sk_buff
op_star
)paren
id|handle2
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_else
id|card-&gt;lbfqc
op_add_assign
l_int|2
suffix:semicolon
)brace
id|ns_grab_res_lock
c_func
(paren
id|card
comma
id|flags
)paren
suffix:semicolon
r_while
c_loop
(paren
id|CMD_BUSY
c_func
(paren
id|card
)paren
)paren
suffix:semicolon
id|writel
c_func
(paren
id|addr2
comma
id|card-&gt;membase
op_plus
id|DR3
)paren
suffix:semicolon
id|writel
c_func
(paren
id|handle2
comma
id|card-&gt;membase
op_plus
id|DR2
)paren
suffix:semicolon
id|writel
c_func
(paren
id|addr1
comma
id|card-&gt;membase
op_plus
id|DR1
)paren
suffix:semicolon
id|writel
c_func
(paren
id|handle1
comma
id|card-&gt;membase
op_plus
id|DR0
)paren
suffix:semicolon
id|writel
c_func
(paren
id|NS_CMD_WRITE_FREEBUFQ
op_or
(paren
id|u32
)paren
id|type
comma
id|card-&gt;membase
op_plus
id|CMD
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|card-&gt;res_lock
comma
id|flags
)paren
suffix:semicolon
id|XPRINTK
c_func
(paren
l_string|&quot;nicstar%d: Pushing %s buffers at 0x%x and 0x%x.&bslash;n&quot;
comma
id|card-&gt;index
comma
(paren
id|type
op_eq
id|BUF_SM
ques
c_cond
l_string|&quot;small&quot;
suffix:colon
l_string|&quot;large&quot;
)paren
comma
id|addr1
comma
id|addr2
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|card-&gt;efbie
op_logical_and
id|card-&gt;sbfqc
op_ge
id|card-&gt;sbnr.min
op_logical_and
id|card-&gt;lbfqc
op_ge
id|card-&gt;lbnr.min
)paren
(brace
id|card-&gt;efbie
op_assign
l_int|1
suffix:semicolon
id|writel
c_func
(paren
(paren
id|readl
c_func
(paren
id|card-&gt;membase
op_plus
id|CFG
)paren
op_or
id|NS_CFG_EFBIE
)paren
comma
id|card-&gt;membase
op_plus
id|CFG
)paren
suffix:semicolon
)brace
r_return
suffix:semicolon
)brace
DECL|function|ns_irq_handler
r_static
r_void
id|ns_irq_handler
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
id|u32
id|stat_r
suffix:semicolon
id|ns_dev
op_star
id|card
suffix:semicolon
r_struct
id|atm_dev
op_star
id|dev
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|card
op_assign
(paren
id|ns_dev
op_star
)paren
id|dev_id
suffix:semicolon
id|dev
op_assign
id|card-&gt;atmdev
suffix:semicolon
id|card-&gt;intcnt
op_increment
suffix:semicolon
id|PRINTK
c_func
(paren
l_string|&quot;nicstar%d: NICStAR generated an interrupt&bslash;n&quot;
comma
id|card-&gt;index
)paren
suffix:semicolon
id|ns_grab_int_lock
c_func
(paren
id|card
comma
id|flags
)paren
suffix:semicolon
id|stat_r
op_assign
id|readl
c_func
(paren
id|card-&gt;membase
op_plus
id|STAT
)paren
suffix:semicolon
multiline_comment|/* Transmit Status Indicator has been written to T. S. Queue */
r_if
c_cond
(paren
id|stat_r
op_amp
id|NS_STAT_TSIF
)paren
(brace
id|TXPRINTK
c_func
(paren
l_string|&quot;nicstar%d: TSI interrupt&bslash;n&quot;
comma
id|card-&gt;index
)paren
suffix:semicolon
id|process_tsq
c_func
(paren
id|card
)paren
suffix:semicolon
id|writel
c_func
(paren
id|NS_STAT_TSIF
comma
id|card-&gt;membase
op_plus
id|STAT
)paren
suffix:semicolon
)brace
multiline_comment|/* Incomplete CS-PDU has been transmitted */
r_if
c_cond
(paren
id|stat_r
op_amp
id|NS_STAT_TXICP
)paren
(brace
id|writel
c_func
(paren
id|NS_STAT_TXICP
comma
id|card-&gt;membase
op_plus
id|STAT
)paren
suffix:semicolon
id|TXPRINTK
c_func
(paren
l_string|&quot;nicstar%d: Incomplete CS-PDU transmitted.&bslash;n&quot;
comma
id|card-&gt;index
)paren
suffix:semicolon
)brace
multiline_comment|/* Transmit Status Queue 7/8 full */
r_if
c_cond
(paren
id|stat_r
op_amp
id|NS_STAT_TSQF
)paren
(brace
id|writel
c_func
(paren
id|NS_STAT_TSQF
comma
id|card-&gt;membase
op_plus
id|STAT
)paren
suffix:semicolon
id|PRINTK
c_func
(paren
l_string|&quot;nicstar%d: TSQ full.&bslash;n&quot;
comma
id|card-&gt;index
)paren
suffix:semicolon
id|process_tsq
c_func
(paren
id|card
)paren
suffix:semicolon
)brace
multiline_comment|/* Timer overflow */
r_if
c_cond
(paren
id|stat_r
op_amp
id|NS_STAT_TMROF
)paren
(brace
id|writel
c_func
(paren
id|NS_STAT_TMROF
comma
id|card-&gt;membase
op_plus
id|STAT
)paren
suffix:semicolon
id|PRINTK
c_func
(paren
l_string|&quot;nicstar%d: Timer overflow.&bslash;n&quot;
comma
id|card-&gt;index
)paren
suffix:semicolon
)brace
multiline_comment|/* PHY device interrupt signal active */
r_if
c_cond
(paren
id|stat_r
op_amp
id|NS_STAT_PHYI
)paren
(brace
id|writel
c_func
(paren
id|NS_STAT_PHYI
comma
id|card-&gt;membase
op_plus
id|STAT
)paren
suffix:semicolon
id|PRINTK
c_func
(paren
l_string|&quot;nicstar%d: PHY interrupt.&bslash;n&quot;
comma
id|card-&gt;index
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;phy
op_logical_and
id|dev-&gt;phy-&gt;interrupt
)paren
(brace
id|dev-&gt;phy
op_member_access_from_pointer
id|interrupt
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* Small Buffer Queue is full */
r_if
c_cond
(paren
id|stat_r
op_amp
id|NS_STAT_SFBQF
)paren
(brace
id|writel
c_func
(paren
id|NS_STAT_SFBQF
comma
id|card-&gt;membase
op_plus
id|STAT
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;nicstar%d: Small free buffer queue is full.&bslash;n&quot;
comma
id|card-&gt;index
)paren
suffix:semicolon
)brace
multiline_comment|/* Large Buffer Queue is full */
r_if
c_cond
(paren
id|stat_r
op_amp
id|NS_STAT_LFBQF
)paren
(brace
id|writel
c_func
(paren
id|NS_STAT_LFBQF
comma
id|card-&gt;membase
op_plus
id|STAT
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;nicstar%d: Large free buffer queue is full.&bslash;n&quot;
comma
id|card-&gt;index
)paren
suffix:semicolon
)brace
multiline_comment|/* Receive Status Queue is full */
r_if
c_cond
(paren
id|stat_r
op_amp
id|NS_STAT_RSQF
)paren
(brace
id|writel
c_func
(paren
id|NS_STAT_RSQF
comma
id|card-&gt;membase
op_plus
id|STAT
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;nicstar%d: RSQ full.&bslash;n&quot;
comma
id|card-&gt;index
)paren
suffix:semicolon
id|process_rsq
c_func
(paren
id|card
)paren
suffix:semicolon
)brace
multiline_comment|/* Complete CS-PDU received */
r_if
c_cond
(paren
id|stat_r
op_amp
id|NS_STAT_EOPDU
)paren
(brace
id|RXPRINTK
c_func
(paren
l_string|&quot;nicstar%d: End of CS-PDU received.&bslash;n&quot;
comma
id|card-&gt;index
)paren
suffix:semicolon
id|process_rsq
c_func
(paren
id|card
)paren
suffix:semicolon
id|writel
c_func
(paren
id|NS_STAT_EOPDU
comma
id|card-&gt;membase
op_plus
id|STAT
)paren
suffix:semicolon
)brace
multiline_comment|/* Raw cell received */
r_if
c_cond
(paren
id|stat_r
op_amp
id|NS_STAT_RAWCF
)paren
(brace
id|writel
c_func
(paren
id|NS_STAT_RAWCF
comma
id|card-&gt;membase
op_plus
id|STAT
)paren
suffix:semicolon
macro_line|#ifndef RCQ_SUPPORT
id|printk
c_func
(paren
l_string|&quot;nicstar%d: Raw cell received and no support yet...&bslash;n&quot;
comma
id|card-&gt;index
)paren
suffix:semicolon
macro_line|#endif /* RCQ_SUPPORT */
multiline_comment|/* NOTE: the following procedure may keep a raw cell pending untill the&n;               next interrupt. As this preliminary support is only meant to&n;               avoid buffer leakage, this is not an issue. */
r_while
c_loop
(paren
id|readl
c_func
(paren
id|card-&gt;membase
op_plus
id|RAWCT
)paren
op_ne
id|card-&gt;rawch
)paren
(brace
id|ns_rcqe
op_star
id|rawcell
suffix:semicolon
id|rawcell
op_assign
(paren
id|ns_rcqe
op_star
)paren
id|bus_to_virt
c_func
(paren
id|card-&gt;rawch
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ns_rcqe_islast
c_func
(paren
id|rawcell
)paren
)paren
(brace
r_struct
id|sk_buff
op_star
id|oldbuf
suffix:semicolon
id|oldbuf
op_assign
id|card-&gt;rcbuf
suffix:semicolon
id|card-&gt;rcbuf
op_assign
(paren
r_struct
id|sk_buff
op_star
)paren
id|ns_rcqe_nextbufhandle
c_func
(paren
id|rawcell
)paren
suffix:semicolon
id|card-&gt;rawch
op_assign
(paren
id|u32
)paren
id|virt_to_bus
c_func
(paren
id|card-&gt;rcbuf-&gt;data
)paren
suffix:semicolon
id|recycle_rx_buf
c_func
(paren
id|card
comma
id|oldbuf
)paren
suffix:semicolon
)brace
r_else
id|card-&gt;rawch
op_add_assign
id|NS_RCQE_SIZE
suffix:semicolon
)brace
)brace
multiline_comment|/* Small buffer queue is empty */
r_if
c_cond
(paren
id|stat_r
op_amp
id|NS_STAT_SFBQE
)paren
(brace
r_int
id|i
suffix:semicolon
r_struct
id|sk_buff
op_star
id|sb
suffix:semicolon
id|writel
c_func
(paren
id|NS_STAT_SFBQE
comma
id|card-&gt;membase
op_plus
id|STAT
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;nicstar%d: Small free buffer queue empty.&bslash;n&quot;
comma
id|card-&gt;index
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|card-&gt;sbnr.min
suffix:semicolon
id|i
op_increment
)paren
(brace
id|sb
op_assign
id|alloc_skb
c_func
(paren
id|NS_SMSKBSIZE
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sb
op_eq
l_int|NULL
)paren
(brace
id|writel
c_func
(paren
id|readl
c_func
(paren
id|card-&gt;membase
op_plus
id|CFG
)paren
op_amp
op_complement
id|NS_CFG_EFBIE
comma
id|card-&gt;membase
op_plus
id|CFG
)paren
suffix:semicolon
id|card-&gt;efbie
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
)brace
id|skb_queue_tail
c_func
(paren
op_amp
id|card-&gt;sbpool.queue
comma
id|sb
)paren
suffix:semicolon
id|skb_reserve
c_func
(paren
id|sb
comma
id|NS_AAL0_HEADER
)paren
suffix:semicolon
id|push_rxbufs
c_func
(paren
id|card
comma
id|BUF_SM
comma
(paren
id|u32
)paren
id|sb
comma
(paren
id|u32
)paren
id|virt_to_bus
c_func
(paren
id|sb-&gt;data
)paren
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
)brace
id|card-&gt;sbfqc
op_assign
id|i
suffix:semicolon
id|process_rsq
c_func
(paren
id|card
)paren
suffix:semicolon
)brace
multiline_comment|/* Large buffer queue empty */
r_if
c_cond
(paren
id|stat_r
op_amp
id|NS_STAT_LFBQE
)paren
(brace
r_int
id|i
suffix:semicolon
r_struct
id|sk_buff
op_star
id|lb
suffix:semicolon
id|writel
c_func
(paren
id|NS_STAT_LFBQE
comma
id|card-&gt;membase
op_plus
id|STAT
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;nicstar%d: Large free buffer queue empty.&bslash;n&quot;
comma
id|card-&gt;index
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|card-&gt;lbnr.min
suffix:semicolon
id|i
op_increment
)paren
(brace
id|lb
op_assign
id|alloc_skb
c_func
(paren
id|NS_LGSKBSIZE
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
id|lb
op_eq
l_int|NULL
)paren
(brace
id|writel
c_func
(paren
id|readl
c_func
(paren
id|card-&gt;membase
op_plus
id|CFG
)paren
op_amp
op_complement
id|NS_CFG_EFBIE
comma
id|card-&gt;membase
op_plus
id|CFG
)paren
suffix:semicolon
id|card-&gt;efbie
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
)brace
id|skb_queue_tail
c_func
(paren
op_amp
id|card-&gt;lbpool.queue
comma
id|lb
)paren
suffix:semicolon
id|skb_reserve
c_func
(paren
id|lb
comma
id|NS_SMBUFSIZE
)paren
suffix:semicolon
id|push_rxbufs
c_func
(paren
id|card
comma
id|BUF_LG
comma
(paren
id|u32
)paren
id|lb
comma
(paren
id|u32
)paren
id|virt_to_bus
c_func
(paren
id|lb-&gt;data
)paren
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
)brace
id|card-&gt;lbfqc
op_assign
id|i
suffix:semicolon
id|process_rsq
c_func
(paren
id|card
)paren
suffix:semicolon
)brace
multiline_comment|/* Receive Status Queue is 7/8 full */
r_if
c_cond
(paren
id|stat_r
op_amp
id|NS_STAT_RSQAF
)paren
(brace
id|writel
c_func
(paren
id|NS_STAT_RSQAF
comma
id|card-&gt;membase
op_plus
id|STAT
)paren
suffix:semicolon
id|RXPRINTK
c_func
(paren
l_string|&quot;nicstar%d: RSQ almost full.&bslash;n&quot;
comma
id|card-&gt;index
)paren
suffix:semicolon
id|process_rsq
c_func
(paren
id|card
)paren
suffix:semicolon
)brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|card-&gt;int_lock
comma
id|flags
)paren
suffix:semicolon
id|PRINTK
c_func
(paren
l_string|&quot;nicstar%d: end of interrupt service&bslash;n&quot;
comma
id|card-&gt;index
)paren
suffix:semicolon
)brace
DECL|function|ns_open
r_static
r_int
id|ns_open
c_func
(paren
r_struct
id|atm_vcc
op_star
id|vcc
comma
r_int
id|vpi
comma
r_int
id|vci
)paren
(brace
id|ns_dev
op_star
id|card
suffix:semicolon
id|vc_map
op_star
id|vc
suffix:semicolon
r_int
id|error
suffix:semicolon
r_int
r_int
id|tmpl
comma
id|modl
suffix:semicolon
r_int
id|tcr
comma
id|tcra
suffix:semicolon
multiline_comment|/* target cell rate, and absolute value */
r_int
id|n
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Number of entries in the TST. Initialized to remove&n;                           the compiler warning. */
id|u32
id|u32d
(braket
l_int|4
)braket
suffix:semicolon
r_int
id|frscdi
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Index of the SCD. Initialized to remove the compiler&n;                           warning. How I wish compilers were clever enough to&n;&t;&t;&t;   tell which variables can truly be used&n;&t;&t;&t;   uninitialized... */
r_int
id|inuse
suffix:semicolon
multiline_comment|/* tx or rx vc already in use by another vcc */
id|card
op_assign
(paren
id|ns_dev
op_star
)paren
id|vcc-&gt;dev-&gt;dev_data
suffix:semicolon
id|PRINTK
c_func
(paren
l_string|&quot;nicstar%d: opening vpi.vci %d.%d &bslash;n&quot;
comma
id|card-&gt;index
comma
(paren
r_int
)paren
id|vpi
comma
id|vci
)paren
suffix:semicolon
r_if
c_cond
(paren
id|vcc-&gt;qos.aal
op_ne
id|ATM_AAL5
op_logical_and
id|vcc-&gt;qos.aal
op_ne
id|ATM_AAL0
)paren
(brace
id|PRINTK
c_func
(paren
l_string|&quot;nicstar%d: unsupported AAL.&bslash;n&quot;
comma
id|card-&gt;index
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|error
op_assign
id|atm_find_ci
c_func
(paren
id|vcc
comma
op_amp
id|vpi
comma
op_amp
id|vci
)paren
)paren
)paren
(brace
id|PRINTK
c_func
(paren
l_string|&quot;nicstar%d: error in atm_find_ci().&bslash;n&quot;
comma
id|card-&gt;index
)paren
suffix:semicolon
r_return
id|error
suffix:semicolon
)brace
id|vc
op_assign
op_amp
(paren
id|card-&gt;vcmap
(braket
id|vpi
op_lshift
id|card-&gt;vcibits
op_or
id|vci
)braket
)paren
suffix:semicolon
id|vcc-&gt;vpi
op_assign
id|vpi
suffix:semicolon
id|vcc-&gt;vci
op_assign
id|vci
suffix:semicolon
id|vcc-&gt;dev_data
op_assign
id|vc
suffix:semicolon
id|inuse
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|vcc-&gt;qos.txtp.traffic_class
op_ne
id|ATM_NONE
op_logical_and
id|vc-&gt;tx
)paren
id|inuse
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|vcc-&gt;qos.rxtp.traffic_class
op_ne
id|ATM_NONE
op_logical_and
id|vc-&gt;rx
)paren
id|inuse
op_add_assign
l_int|2
suffix:semicolon
r_if
c_cond
(paren
id|inuse
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;nicstar%d: %s vci already in use.&bslash;n&quot;
comma
id|card-&gt;index
comma
id|inuse
op_eq
l_int|1
ques
c_cond
l_string|&quot;tx&quot;
suffix:colon
id|inuse
op_eq
l_int|2
ques
c_cond
l_string|&quot;rx&quot;
suffix:colon
l_string|&quot;tx and rx&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|set_bit
c_func
(paren
id|ATM_VF_ADDR
comma
op_amp
id|vcc-&gt;flags
)paren
suffix:semicolon
multiline_comment|/* NOTE: You are not allowed to modify an open connection&squot;s QOS. To change&n;      that, remove the ATM_VF_PARTIAL flag checking. There may be other changes&n;      needed to do that. */
r_if
c_cond
(paren
op_logical_neg
id|test_bit
c_func
(paren
id|ATM_VF_PARTIAL
comma
op_amp
id|vcc-&gt;flags
)paren
)paren
(brace
id|scq_info
op_star
id|scq
suffix:semicolon
id|set_bit
c_func
(paren
id|ATM_VF_PARTIAL
comma
op_amp
id|vcc-&gt;flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|vcc-&gt;qos.txtp.traffic_class
op_eq
id|ATM_CBR
)paren
(brace
multiline_comment|/* Check requested cell rate and availability of SCD */
r_if
c_cond
(paren
id|vcc-&gt;qos.txtp.max_pcr
op_eq
l_int|0
op_logical_and
id|vcc-&gt;qos.txtp.pcr
op_eq
l_int|0
op_logical_and
id|vcc-&gt;qos.txtp.min_pcr
op_eq
l_int|0
)paren
(brace
id|PRINTK
c_func
(paren
l_string|&quot;nicstar%d: trying to open a CBR vc with cell rate = 0 &bslash;n&quot;
comma
id|card-&gt;index
)paren
suffix:semicolon
id|clear_bit
c_func
(paren
id|ATM_VF_PARTIAL
comma
op_amp
id|vcc-&gt;flags
)paren
suffix:semicolon
id|clear_bit
c_func
(paren
id|ATM_VF_ADDR
comma
op_amp
id|vcc-&gt;flags
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|tcr
op_assign
id|atm_pcr_goal
c_func
(paren
op_amp
(paren
id|vcc-&gt;qos.txtp
)paren
)paren
suffix:semicolon
id|tcra
op_assign
id|tcr
op_ge
l_int|0
ques
c_cond
id|tcr
suffix:colon
op_minus
id|tcr
suffix:semicolon
id|PRINTK
c_func
(paren
l_string|&quot;nicstar%d: target cell rate = %d.&bslash;n&quot;
comma
id|card-&gt;index
comma
id|vcc-&gt;qos.txtp.max_pcr
)paren
suffix:semicolon
id|tmpl
op_assign
(paren
r_int
r_int
)paren
id|tcra
op_star
(paren
r_int
r_int
)paren
id|NS_TST_NUM_ENTRIES
suffix:semicolon
id|modl
op_assign
id|tmpl
op_mod
id|card-&gt;max_pcr
suffix:semicolon
id|n
op_assign
(paren
r_int
)paren
(paren
id|tmpl
op_div
id|card-&gt;max_pcr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tcr
OG
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|modl
OG
l_int|0
)paren
id|n
op_increment
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|tcr
op_eq
l_int|0
)paren
(brace
r_if
c_cond
(paren
(paren
id|n
op_assign
(paren
id|card-&gt;tst_free_entries
op_minus
id|NS_TST_RESERVED
)paren
)paren
op_le
l_int|0
)paren
(brace
id|PRINTK
c_func
(paren
l_string|&quot;nicstar%d: no CBR bandwidth free.&bslash;n&quot;
comma
id|card-&gt;index
)paren
suffix:semicolon
id|clear_bit
c_func
(paren
id|ATM_VF_PARTIAL
comma
op_amp
id|vcc-&gt;flags
)paren
suffix:semicolon
id|clear_bit
c_func
(paren
id|ATM_VF_ADDR
comma
op_amp
id|vcc-&gt;flags
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|n
op_eq
l_int|0
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;nicstar%d: selected bandwidth &lt; granularity.&bslash;n&quot;
comma
id|card-&gt;index
)paren
suffix:semicolon
id|clear_bit
c_func
(paren
id|ATM_VF_PARTIAL
comma
op_amp
id|vcc-&gt;flags
)paren
suffix:semicolon
id|clear_bit
c_func
(paren
id|ATM_VF_ADDR
comma
op_amp
id|vcc-&gt;flags
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|n
OG
(paren
id|card-&gt;tst_free_entries
op_minus
id|NS_TST_RESERVED
)paren
)paren
(brace
id|PRINTK
c_func
(paren
l_string|&quot;nicstar%d: not enough free CBR bandwidth.&bslash;n&quot;
comma
id|card-&gt;index
)paren
suffix:semicolon
id|clear_bit
c_func
(paren
id|ATM_VF_PARTIAL
comma
op_amp
id|vcc-&gt;flags
)paren
suffix:semicolon
id|clear_bit
c_func
(paren
id|ATM_VF_ADDR
comma
op_amp
id|vcc-&gt;flags
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_else
id|card-&gt;tst_free_entries
op_sub_assign
id|n
suffix:semicolon
id|XPRINTK
c_func
(paren
l_string|&quot;nicstar%d: writing %d tst entries.&bslash;n&quot;
comma
id|card-&gt;index
comma
id|n
)paren
suffix:semicolon
r_for
c_loop
(paren
id|frscdi
op_assign
l_int|0
suffix:semicolon
id|frscdi
OL
id|NS_FRSCD_NUM
suffix:semicolon
id|frscdi
op_increment
)paren
(brace
r_if
c_cond
(paren
id|card-&gt;scd2vc
(braket
id|frscdi
)braket
op_eq
l_int|NULL
)paren
(brace
id|card-&gt;scd2vc
(braket
id|frscdi
)braket
op_assign
id|vc
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|frscdi
op_eq
id|NS_FRSCD_NUM
)paren
(brace
id|PRINTK
c_func
(paren
l_string|&quot;nicstar%d: no SCD available for CBR channel.&bslash;n&quot;
comma
id|card-&gt;index
)paren
suffix:semicolon
id|card-&gt;tst_free_entries
op_add_assign
id|n
suffix:semicolon
id|clear_bit
c_func
(paren
id|ATM_VF_PARTIAL
comma
op_amp
id|vcc-&gt;flags
)paren
suffix:semicolon
id|clear_bit
c_func
(paren
id|ATM_VF_ADDR
comma
op_amp
id|vcc-&gt;flags
)paren
suffix:semicolon
r_return
op_minus
id|EBUSY
suffix:semicolon
)brace
id|vc-&gt;cbr_scd
op_assign
id|NS_FRSCD
op_plus
id|frscdi
op_star
id|NS_FRSCD_SIZE
suffix:semicolon
id|scq
op_assign
id|get_scq
c_func
(paren
id|CBR_SCQSIZE
comma
id|vc-&gt;cbr_scd
)paren
suffix:semicolon
r_if
c_cond
(paren
id|scq
op_eq
(paren
id|scq_info
op_star
)paren
l_int|NULL
)paren
(brace
id|PRINTK
c_func
(paren
l_string|&quot;nicstar%d: can&squot;t get fixed rate SCQ.&bslash;n&quot;
comma
id|card-&gt;index
)paren
suffix:semicolon
id|card-&gt;scd2vc
(braket
id|frscdi
)braket
op_assign
l_int|NULL
suffix:semicolon
id|card-&gt;tst_free_entries
op_add_assign
id|n
suffix:semicolon
id|clear_bit
c_func
(paren
id|ATM_VF_PARTIAL
comma
op_amp
id|vcc-&gt;flags
)paren
suffix:semicolon
id|clear_bit
c_func
(paren
id|ATM_VF_ADDR
comma
op_amp
id|vcc-&gt;flags
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|vc-&gt;scq
op_assign
id|scq
suffix:semicolon
id|u32d
(braket
l_int|0
)braket
op_assign
(paren
id|u32
)paren
id|virt_to_bus
c_func
(paren
id|scq-&gt;base
)paren
suffix:semicolon
id|u32d
(braket
l_int|1
)braket
op_assign
(paren
id|u32
)paren
l_int|0x00000000
suffix:semicolon
id|u32d
(braket
l_int|2
)braket
op_assign
(paren
id|u32
)paren
l_int|0xffffffff
suffix:semicolon
id|u32d
(braket
l_int|3
)braket
op_assign
(paren
id|u32
)paren
l_int|0x00000000
suffix:semicolon
id|ns_write_sram
c_func
(paren
id|card
comma
id|vc-&gt;cbr_scd
comma
id|u32d
comma
l_int|4
)paren
suffix:semicolon
id|fill_tst
c_func
(paren
id|card
comma
id|n
comma
id|vc
)paren
suffix:semicolon
)brace
r_else
multiline_comment|/* not CBR */
(brace
id|vc-&gt;cbr_scd
op_assign
l_int|0x00000000
suffix:semicolon
id|vc-&gt;scq
op_assign
id|card-&gt;scq0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|vcc-&gt;qos.txtp.traffic_class
op_ne
id|ATM_NONE
)paren
(brace
id|vc-&gt;tx
op_assign
l_int|1
suffix:semicolon
id|vc-&gt;tx_vcc
op_assign
id|vcc
suffix:semicolon
id|vc-&gt;tbd_count
op_assign
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|vcc-&gt;qos.rxtp.traffic_class
op_ne
id|ATM_NONE
)paren
(brace
id|u32
id|status
suffix:semicolon
id|vc-&gt;rx
op_assign
l_int|1
suffix:semicolon
id|vc-&gt;rx_vcc
op_assign
id|vcc
suffix:semicolon
id|vc-&gt;rx_iov
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/* Open the connection in hardware */
r_if
c_cond
(paren
id|vcc-&gt;qos.aal
op_eq
id|ATM_AAL5
)paren
id|status
op_assign
id|NS_RCTE_AAL5
op_or
id|NS_RCTE_CONNECTOPEN
suffix:semicolon
r_else
multiline_comment|/* vcc-&gt;qos.aal == ATM_AAL0 */
id|status
op_assign
id|NS_RCTE_AAL0
op_or
id|NS_RCTE_CONNECTOPEN
suffix:semicolon
macro_line|#ifdef RCQ_SUPPORT
id|status
op_or_assign
id|NS_RCTE_RAWCELLINTEN
suffix:semicolon
macro_line|#endif /* RCQ_SUPPORT */
id|ns_write_sram
c_func
(paren
id|card
comma
id|NS_RCT
op_plus
(paren
id|vpi
op_lshift
id|card-&gt;vcibits
op_or
id|vci
)paren
op_star
id|NS_RCT_ENTRY_SIZE
comma
op_amp
id|status
comma
l_int|1
)paren
suffix:semicolon
)brace
)brace
id|set_bit
c_func
(paren
id|ATM_VF_READY
comma
op_amp
id|vcc-&gt;flags
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|ns_close
r_static
r_void
id|ns_close
c_func
(paren
r_struct
id|atm_vcc
op_star
id|vcc
)paren
(brace
id|vc_map
op_star
id|vc
suffix:semicolon
id|ns_dev
op_star
id|card
suffix:semicolon
id|u32
id|data
suffix:semicolon
r_int
id|i
suffix:semicolon
id|vc
op_assign
id|vcc-&gt;dev_data
suffix:semicolon
id|card
op_assign
id|vcc-&gt;dev-&gt;dev_data
suffix:semicolon
id|PRINTK
c_func
(paren
l_string|&quot;nicstar%d: closing vpi.vci %d.%d &bslash;n&quot;
comma
id|card-&gt;index
comma
(paren
r_int
)paren
id|vcc-&gt;vpi
comma
id|vcc-&gt;vci
)paren
suffix:semicolon
id|clear_bit
c_func
(paren
id|ATM_VF_READY
comma
op_amp
id|vcc-&gt;flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|vcc-&gt;qos.rxtp.traffic_class
op_ne
id|ATM_NONE
)paren
(brace
id|u32
id|addr
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|addr
op_assign
id|NS_RCT
op_plus
(paren
id|vcc-&gt;vpi
op_lshift
id|card-&gt;vcibits
op_or
id|vcc-&gt;vci
)paren
op_star
id|NS_RCT_ENTRY_SIZE
suffix:semicolon
id|ns_grab_res_lock
c_func
(paren
id|card
comma
id|flags
)paren
suffix:semicolon
r_while
c_loop
(paren
id|CMD_BUSY
c_func
(paren
id|card
)paren
)paren
(brace
suffix:semicolon
)brace
id|writel
c_func
(paren
id|NS_CMD_CLOSE_CONNECTION
op_or
id|addr
op_lshift
l_int|2
comma
id|card-&gt;membase
op_plus
id|CMD
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|card-&gt;res_lock
comma
id|flags
)paren
suffix:semicolon
id|vc-&gt;rx
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|vc-&gt;rx_iov
op_ne
l_int|NULL
)paren
(brace
r_struct
id|sk_buff
op_star
id|iovb
suffix:semicolon
id|u32
id|stat
suffix:semicolon
id|stat
op_assign
id|readl
c_func
(paren
id|card-&gt;membase
op_plus
id|STAT
)paren
suffix:semicolon
id|card-&gt;sbfqc
op_assign
id|ns_stat_sfbqc_get
c_func
(paren
id|stat
)paren
suffix:semicolon
id|card-&gt;lbfqc
op_assign
id|ns_stat_lfbqc_get
c_func
(paren
id|stat
)paren
suffix:semicolon
id|PRINTK
c_func
(paren
l_string|&quot;nicstar%d: closing a VC with pending rx buffers.&bslash;n&quot;
comma
id|card-&gt;index
)paren
suffix:semicolon
id|iovb
op_assign
id|vc-&gt;rx_iov
suffix:semicolon
id|recycle_iovec_rx_bufs
c_func
(paren
id|card
comma
(paren
r_struct
id|iovec
op_star
)paren
id|iovb-&gt;data
comma
id|ATM_SKB
c_func
(paren
id|iovb
)paren
op_member_access_from_pointer
id|iovcnt
)paren
suffix:semicolon
id|ATM_SKB
c_func
(paren
id|iovb
)paren
op_member_access_from_pointer
id|iovcnt
op_assign
l_int|0
suffix:semicolon
id|ATM_SKB
c_func
(paren
id|iovb
)paren
op_member_access_from_pointer
id|vcc
op_assign
l_int|NULL
suffix:semicolon
id|ns_grab_int_lock
c_func
(paren
id|card
comma
id|flags
)paren
suffix:semicolon
id|recycle_iov_buf
c_func
(paren
id|card
comma
id|iovb
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|card-&gt;int_lock
comma
id|flags
)paren
suffix:semicolon
id|vc-&gt;rx_iov
op_assign
l_int|NULL
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|vcc-&gt;qos.txtp.traffic_class
op_ne
id|ATM_NONE
)paren
(brace
id|vc-&gt;tx
op_assign
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|vcc-&gt;qos.txtp.traffic_class
op_eq
id|ATM_CBR
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
id|ns_scqe
op_star
id|scqep
suffix:semicolon
id|scq_info
op_star
id|scq
suffix:semicolon
id|scq
op_assign
id|vc-&gt;scq
suffix:semicolon
r_for
c_loop
(paren
suffix:semicolon
suffix:semicolon
)paren
(brace
id|ns_grab_scq_lock
c_func
(paren
id|card
comma
id|scq
comma
id|flags
)paren
suffix:semicolon
id|scqep
op_assign
id|scq-&gt;next
suffix:semicolon
r_if
c_cond
(paren
id|scqep
op_eq
id|scq-&gt;base
)paren
id|scqep
op_assign
id|scq-&gt;last
suffix:semicolon
r_else
id|scqep
op_decrement
suffix:semicolon
r_if
c_cond
(paren
id|scqep
op_eq
id|scq-&gt;tail
)paren
(brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|scq-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
multiline_comment|/* If the last entry is not a TSR, place one in the SCQ in order to&n;            be able to completely drain it and then close. */
r_if
c_cond
(paren
op_logical_neg
id|ns_scqe_is_tsr
c_func
(paren
id|scqep
)paren
op_logical_and
id|scq-&gt;tail
op_ne
id|scq-&gt;next
)paren
(brace
id|ns_scqe
id|tsr
suffix:semicolon
id|u32
id|scdi
comma
id|scqi
suffix:semicolon
id|u32
id|data
suffix:semicolon
r_int
id|index
suffix:semicolon
id|tsr.word_1
op_assign
id|ns_tsr_mkword_1
c_func
(paren
id|NS_TSR_INTENABLE
)paren
suffix:semicolon
id|scdi
op_assign
(paren
id|vc-&gt;cbr_scd
op_minus
id|NS_FRSCD
)paren
op_div
id|NS_FRSCD_SIZE
suffix:semicolon
id|scqi
op_assign
id|scq-&gt;next
op_minus
id|scq-&gt;base
suffix:semicolon
id|tsr.word_2
op_assign
id|ns_tsr_mkword_2
c_func
(paren
id|scdi
comma
id|scqi
)paren
suffix:semicolon
id|tsr.word_3
op_assign
l_int|0x00000000
suffix:semicolon
id|tsr.word_4
op_assign
l_int|0x00000000
suffix:semicolon
op_star
id|scq-&gt;next
op_assign
id|tsr
suffix:semicolon
id|index
op_assign
(paren
r_int
)paren
id|scqi
suffix:semicolon
id|scq-&gt;skb
(braket
id|index
)braket
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
id|scq-&gt;next
op_eq
id|scq-&gt;last
)paren
id|scq-&gt;next
op_assign
id|scq-&gt;base
suffix:semicolon
r_else
id|scq-&gt;next
op_increment
suffix:semicolon
id|data
op_assign
(paren
id|u32
)paren
id|virt_to_bus
c_func
(paren
id|scq-&gt;next
)paren
suffix:semicolon
id|ns_write_sram
c_func
(paren
id|card
comma
id|scq-&gt;scd
comma
op_amp
id|data
comma
l_int|1
)paren
suffix:semicolon
)brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|scq-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|schedule
c_func
(paren
)paren
suffix:semicolon
)brace
multiline_comment|/* Free all TST entries */
id|data
op_assign
id|NS_TST_OPCODE_VARIABLE
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|NS_TST_NUM_ENTRIES
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|card-&gt;tste2vc
(braket
id|i
)braket
op_eq
id|vc
)paren
(brace
id|ns_write_sram
c_func
(paren
id|card
comma
id|card-&gt;tst_addr
op_plus
id|i
comma
op_amp
id|data
comma
l_int|1
)paren
suffix:semicolon
id|card-&gt;tste2vc
(braket
id|i
)braket
op_assign
l_int|NULL
suffix:semicolon
id|card-&gt;tst_free_entries
op_increment
suffix:semicolon
)brace
)brace
id|card-&gt;scd2vc
(braket
(paren
id|vc-&gt;cbr_scd
op_minus
id|NS_FRSCD
)paren
op_div
id|NS_FRSCD_SIZE
)braket
op_assign
l_int|NULL
suffix:semicolon
id|free_scq
c_func
(paren
id|vc-&gt;scq
comma
id|vcc
)paren
suffix:semicolon
)brace
id|vcc-&gt;dev_data
op_assign
l_int|NULL
suffix:semicolon
id|clear_bit
c_func
(paren
id|ATM_VF_PARTIAL
comma
op_amp
id|vcc-&gt;flags
)paren
suffix:semicolon
id|clear_bit
c_func
(paren
id|ATM_VF_ADDR
comma
op_amp
id|vcc-&gt;flags
)paren
suffix:semicolon
macro_line|#ifdef RX_DEBUG
(brace
id|u32
id|stat
comma
id|cfg
suffix:semicolon
id|stat
op_assign
id|readl
c_func
(paren
id|card-&gt;membase
op_plus
id|STAT
)paren
suffix:semicolon
id|cfg
op_assign
id|readl
c_func
(paren
id|card-&gt;membase
op_plus
id|CFG
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;STAT = 0x%08X  CFG = 0x%08X  &bslash;n&quot;
comma
id|stat
comma
id|cfg
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;TSQ: base = 0x%08X  next = 0x%08X  last = 0x%08X  TSQT = 0x%08X &bslash;n&quot;
comma
(paren
id|u32
)paren
id|card-&gt;tsq.base
comma
(paren
id|u32
)paren
id|card-&gt;tsq.next
comma
(paren
id|u32
)paren
id|card-&gt;tsq.last
comma
id|readl
c_func
(paren
id|card-&gt;membase
op_plus
id|TSQT
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;RSQ: base = 0x%08X  next = 0x%08X  last = 0x%08X  RSQT = 0x%08X &bslash;n&quot;
comma
(paren
id|u32
)paren
id|card-&gt;rsq.base
comma
(paren
id|u32
)paren
id|card-&gt;rsq.next
comma
(paren
id|u32
)paren
id|card-&gt;rsq.last
comma
id|readl
c_func
(paren
id|card-&gt;membase
op_plus
id|RSQT
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;Empty free buffer queue interrupt %s &bslash;n&quot;
comma
id|card-&gt;efbie
ques
c_cond
l_string|&quot;enabled&quot;
suffix:colon
l_string|&quot;disabled&quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;SBCNT = %d  count = %d   LBCNT = %d count = %d &bslash;n&quot;
comma
id|ns_stat_sfbqc_get
c_func
(paren
id|stat
)paren
comma
id|card-&gt;sbpool.count
comma
id|ns_stat_lfbqc_get
c_func
(paren
id|stat
)paren
comma
id|card-&gt;lbpool.count
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;hbpool.count = %d  iovpool.count = %d &bslash;n&quot;
comma
id|card-&gt;hbpool.count
comma
id|card-&gt;iovpool.count
)paren
suffix:semicolon
)brace
macro_line|#endif /* RX_DEBUG */
)brace
DECL|function|fill_tst
r_static
r_void
id|fill_tst
c_func
(paren
id|ns_dev
op_star
id|card
comma
r_int
id|n
comma
id|vc_map
op_star
id|vc
)paren
(brace
id|u32
id|new_tst
suffix:semicolon
r_int
r_int
id|cl
suffix:semicolon
r_int
id|e
comma
id|r
suffix:semicolon
id|u32
id|data
suffix:semicolon
multiline_comment|/* It would be very complicated to keep the two TSTs synchronized while&n;      assuring that writes are only made to the inactive TST. So, for now I&n;      will use only one TST. If problems occur, I will change this again */
id|new_tst
op_assign
id|card-&gt;tst_addr
suffix:semicolon
multiline_comment|/* Fill procedure */
r_for
c_loop
(paren
id|e
op_assign
l_int|0
suffix:semicolon
id|e
OL
id|NS_TST_NUM_ENTRIES
suffix:semicolon
id|e
op_increment
)paren
(brace
r_if
c_cond
(paren
id|card-&gt;tste2vc
(braket
id|e
)braket
op_eq
l_int|NULL
)paren
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|e
op_eq
id|NS_TST_NUM_ENTRIES
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;nicstar%d: No free TST entries found. &bslash;n&quot;
comma
id|card-&gt;index
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|r
op_assign
id|n
suffix:semicolon
id|cl
op_assign
id|NS_TST_NUM_ENTRIES
suffix:semicolon
id|data
op_assign
id|ns_tste_make
c_func
(paren
id|NS_TST_OPCODE_FIXED
comma
id|vc-&gt;cbr_scd
)paren
suffix:semicolon
r_while
c_loop
(paren
id|r
OG
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|cl
op_ge
id|NS_TST_NUM_ENTRIES
op_logical_and
id|card-&gt;tste2vc
(braket
id|e
)braket
op_eq
l_int|NULL
)paren
(brace
id|card-&gt;tste2vc
(braket
id|e
)braket
op_assign
id|vc
suffix:semicolon
id|ns_write_sram
c_func
(paren
id|card
comma
id|new_tst
op_plus
id|e
comma
op_amp
id|data
comma
l_int|1
)paren
suffix:semicolon
id|cl
op_sub_assign
id|NS_TST_NUM_ENTRIES
suffix:semicolon
id|r
op_decrement
suffix:semicolon
)brace
r_if
c_cond
(paren
op_increment
id|e
op_eq
id|NS_TST_NUM_ENTRIES
)paren
(brace
id|e
op_assign
l_int|0
suffix:semicolon
)brace
id|cl
op_add_assign
id|n
suffix:semicolon
)brace
multiline_comment|/* End of fill procedure */
id|data
op_assign
id|ns_tste_make
c_func
(paren
id|NS_TST_OPCODE_END
comma
id|new_tst
)paren
suffix:semicolon
id|ns_write_sram
c_func
(paren
id|card
comma
id|new_tst
op_plus
id|NS_TST_NUM_ENTRIES
comma
op_amp
id|data
comma
l_int|1
)paren
suffix:semicolon
id|ns_write_sram
c_func
(paren
id|card
comma
id|card-&gt;tst_addr
op_plus
id|NS_TST_NUM_ENTRIES
comma
op_amp
id|data
comma
l_int|1
)paren
suffix:semicolon
id|card-&gt;tst_addr
op_assign
id|new_tst
suffix:semicolon
)brace
DECL|function|ns_send
r_static
r_int
id|ns_send
c_func
(paren
r_struct
id|atm_vcc
op_star
id|vcc
comma
r_struct
id|sk_buff
op_star
id|skb
)paren
(brace
id|ns_dev
op_star
id|card
suffix:semicolon
id|vc_map
op_star
id|vc
suffix:semicolon
id|scq_info
op_star
id|scq
suffix:semicolon
r_int
r_int
id|buflen
suffix:semicolon
id|ns_scqe
id|scqe
suffix:semicolon
id|u32
id|flags
suffix:semicolon
multiline_comment|/* TBD flags, not CPU flags */
id|card
op_assign
id|vcc-&gt;dev-&gt;dev_data
suffix:semicolon
id|TXPRINTK
c_func
(paren
l_string|&quot;nicstar%d: ns_send() called.&bslash;n&quot;
comma
id|card-&gt;index
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|vc
op_assign
(paren
id|vc_map
op_star
)paren
id|vcc-&gt;dev_data
)paren
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;nicstar%d: vcc-&gt;dev_data == NULL on ns_send().&bslash;n&quot;
comma
id|card-&gt;index
)paren
suffix:semicolon
id|atomic_inc
c_func
(paren
op_amp
id|vcc-&gt;stats-&gt;tx_err
)paren
suffix:semicolon
id|dev_kfree_skb_any
c_func
(paren
id|skb
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|vc-&gt;tx
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;nicstar%d: Trying to transmit on a non-tx VC.&bslash;n&quot;
comma
id|card-&gt;index
)paren
suffix:semicolon
id|atomic_inc
c_func
(paren
op_amp
id|vcc-&gt;stats-&gt;tx_err
)paren
suffix:semicolon
id|dev_kfree_skb_any
c_func
(paren
id|skb
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|vcc-&gt;qos.aal
op_ne
id|ATM_AAL5
op_logical_and
id|vcc-&gt;qos.aal
op_ne
id|ATM_AAL0
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;nicstar%d: Only AAL0 and AAL5 are supported.&bslash;n&quot;
comma
id|card-&gt;index
)paren
suffix:semicolon
id|atomic_inc
c_func
(paren
op_amp
id|vcc-&gt;stats-&gt;tx_err
)paren
suffix:semicolon
id|dev_kfree_skb_any
c_func
(paren
id|skb
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ATM_SKB
c_func
(paren
id|skb
)paren
op_member_access_from_pointer
id|iovcnt
op_ne
l_int|0
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;nicstar%d: No scatter-gather yet.&bslash;n&quot;
comma
id|card-&gt;index
)paren
suffix:semicolon
id|atomic_inc
c_func
(paren
op_amp
id|vcc-&gt;stats-&gt;tx_err
)paren
suffix:semicolon
id|dev_kfree_skb_any
c_func
(paren
id|skb
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|ATM_SKB
c_func
(paren
id|skb
)paren
op_member_access_from_pointer
id|vcc
op_assign
id|vcc
suffix:semicolon
r_if
c_cond
(paren
id|vcc-&gt;qos.aal
op_eq
id|ATM_AAL5
)paren
(brace
id|buflen
op_assign
(paren
id|skb-&gt;len
op_plus
l_int|47
op_plus
l_int|8
)paren
op_div
l_int|48
op_star
l_int|48
suffix:semicolon
multiline_comment|/* Multiple of 48 */
id|flags
op_assign
id|NS_TBD_AAL5
suffix:semicolon
id|scqe.word_2
op_assign
id|cpu_to_le32
c_func
(paren
(paren
id|u32
)paren
id|virt_to_bus
c_func
(paren
id|skb-&gt;data
)paren
)paren
suffix:semicolon
id|scqe.word_3
op_assign
id|cpu_to_le32
c_func
(paren
(paren
id|u32
)paren
id|skb-&gt;len
)paren
suffix:semicolon
id|scqe.word_4
op_assign
id|ns_tbd_mkword_4
c_func
(paren
l_int|0
comma
(paren
id|u32
)paren
id|vcc-&gt;vpi
comma
(paren
id|u32
)paren
id|vcc-&gt;vci
comma
l_int|0
comma
id|ATM_SKB
c_func
(paren
id|skb
)paren
op_member_access_from_pointer
id|atm_options
op_amp
id|ATM_ATMOPT_CLP
ques
c_cond
l_int|1
suffix:colon
l_int|0
)paren
suffix:semicolon
id|flags
op_or_assign
id|NS_TBD_EOPDU
suffix:semicolon
)brace
r_else
multiline_comment|/* (vcc-&gt;qos.aal == ATM_AAL0) */
(brace
id|buflen
op_assign
id|ATM_CELL_PAYLOAD
suffix:semicolon
multiline_comment|/* i.e., 48 bytes */
id|flags
op_assign
id|NS_TBD_AAL0
suffix:semicolon
id|scqe.word_2
op_assign
id|cpu_to_le32
c_func
(paren
(paren
id|u32
)paren
id|virt_to_bus
c_func
(paren
id|skb-&gt;data
)paren
op_plus
id|NS_AAL0_HEADER
)paren
suffix:semicolon
id|scqe.word_3
op_assign
id|cpu_to_le32
c_func
(paren
l_int|0x00000000
)paren
suffix:semicolon
r_if
c_cond
(paren
op_star
id|skb-&gt;data
op_amp
l_int|0x02
)paren
multiline_comment|/* Payload type 1 - end of pdu */
id|flags
op_or_assign
id|NS_TBD_EOPDU
suffix:semicolon
id|scqe.word_4
op_assign
id|cpu_to_le32
c_func
(paren
op_star
(paren
(paren
id|u32
op_star
)paren
id|skb-&gt;data
)paren
op_amp
op_complement
id|NS_TBD_VC_MASK
)paren
suffix:semicolon
multiline_comment|/* Force the VPI/VCI to be the same as in VCC struct */
id|scqe.word_4
op_or_assign
id|cpu_to_le32
c_func
(paren
(paren
(paren
(paren
id|u32
)paren
id|vcc-&gt;vpi
)paren
op_lshift
id|NS_TBD_VPI_SHIFT
op_or
(paren
(paren
id|u32
)paren
id|vcc-&gt;vci
)paren
op_lshift
id|NS_TBD_VCI_SHIFT
)paren
op_amp
id|NS_TBD_VC_MASK
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|vcc-&gt;qos.txtp.traffic_class
op_eq
id|ATM_CBR
)paren
(brace
id|scqe.word_1
op_assign
id|ns_tbd_mkword_1_novbr
c_func
(paren
id|flags
comma
(paren
id|u32
)paren
id|buflen
)paren
suffix:semicolon
id|scq
op_assign
(paren
(paren
id|vc_map
op_star
)paren
id|vcc-&gt;dev_data
)paren
op_member_access_from_pointer
id|scq
suffix:semicolon
)brace
r_else
(brace
id|scqe.word_1
op_assign
id|ns_tbd_mkword_1
c_func
(paren
id|flags
comma
(paren
id|u32
)paren
l_int|1
comma
(paren
id|u32
)paren
l_int|1
comma
(paren
id|u32
)paren
id|buflen
)paren
suffix:semicolon
id|scq
op_assign
id|card-&gt;scq0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|push_scqe
c_func
(paren
id|card
comma
id|vc
comma
id|scq
comma
op_amp
id|scqe
comma
id|skb
)paren
op_ne
l_int|0
)paren
(brace
id|atomic_inc
c_func
(paren
op_amp
id|vcc-&gt;stats-&gt;tx_err
)paren
suffix:semicolon
id|dev_kfree_skb_any
c_func
(paren
id|skb
)paren
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
id|atomic_inc
c_func
(paren
op_amp
id|vcc-&gt;stats-&gt;tx
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|push_scqe
r_static
r_int
id|push_scqe
c_func
(paren
id|ns_dev
op_star
id|card
comma
id|vc_map
op_star
id|vc
comma
id|scq_info
op_star
id|scq
comma
id|ns_scqe
op_star
id|tbd
comma
r_struct
id|sk_buff
op_star
id|skb
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
id|ns_scqe
id|tsr
suffix:semicolon
id|u32
id|scdi
comma
id|scqi
suffix:semicolon
r_int
id|scq_is_vbr
suffix:semicolon
id|u32
id|data
suffix:semicolon
r_int
id|index
suffix:semicolon
id|ns_grab_scq_lock
c_func
(paren
id|card
comma
id|scq
comma
id|flags
)paren
suffix:semicolon
r_while
c_loop
(paren
id|scq-&gt;tail
op_eq
id|scq-&gt;next
)paren
(brace
r_if
c_cond
(paren
id|in_interrupt
c_func
(paren
)paren
)paren
(brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|scq-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;nicstar%d: Error pushing TBD.&bslash;n&quot;
comma
id|card-&gt;index
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
id|scq-&gt;full
op_assign
l_int|1
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|scq-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|interruptible_sleep_on_timeout
c_func
(paren
op_amp
id|scq-&gt;scqfull_waitq
comma
id|SCQFULL_TIMEOUT
)paren
suffix:semicolon
id|ns_grab_scq_lock
c_func
(paren
id|card
comma
id|scq
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|scq-&gt;full
)paren
(brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|scq-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;nicstar%d: Timeout pushing TBD.&bslash;n&quot;
comma
id|card-&gt;index
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
)brace
op_star
id|scq-&gt;next
op_assign
op_star
id|tbd
suffix:semicolon
id|index
op_assign
(paren
r_int
)paren
(paren
id|scq-&gt;next
op_minus
id|scq-&gt;base
)paren
suffix:semicolon
id|scq-&gt;skb
(braket
id|index
)braket
op_assign
id|skb
suffix:semicolon
id|XPRINTK
c_func
(paren
l_string|&quot;nicstar%d: sending skb at 0x%x (pos %d).&bslash;n&quot;
comma
id|card-&gt;index
comma
(paren
id|u32
)paren
id|skb
comma
id|index
)paren
suffix:semicolon
id|XPRINTK
c_func
(paren
l_string|&quot;nicstar%d: TBD written:&bslash;n0x%x&bslash;n0x%x&bslash;n0x%x&bslash;n0x%x&bslash;n at 0x%x.&bslash;n&quot;
comma
id|card-&gt;index
comma
id|le32_to_cpu
c_func
(paren
id|tbd-&gt;word_1
)paren
comma
id|le32_to_cpu
c_func
(paren
id|tbd-&gt;word_2
)paren
comma
id|le32_to_cpu
c_func
(paren
id|tbd-&gt;word_3
)paren
comma
id|le32_to_cpu
c_func
(paren
id|tbd-&gt;word_4
)paren
comma
(paren
id|u32
)paren
id|scq-&gt;next
)paren
suffix:semicolon
r_if
c_cond
(paren
id|scq-&gt;next
op_eq
id|scq-&gt;last
)paren
id|scq-&gt;next
op_assign
id|scq-&gt;base
suffix:semicolon
r_else
id|scq-&gt;next
op_increment
suffix:semicolon
id|vc-&gt;tbd_count
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|scq-&gt;num_entries
op_eq
id|VBR_SCQ_NUM_ENTRIES
)paren
(brace
id|scq-&gt;tbd_count
op_increment
suffix:semicolon
id|scq_is_vbr
op_assign
l_int|1
suffix:semicolon
)brace
r_else
id|scq_is_vbr
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|vc-&gt;tbd_count
op_ge
id|MAX_TBD_PER_VC
op_logical_or
id|scq-&gt;tbd_count
op_ge
id|MAX_TBD_PER_SCQ
)paren
(brace
r_int
id|has_run
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
id|scq-&gt;tail
op_eq
id|scq-&gt;next
)paren
(brace
r_if
c_cond
(paren
id|in_interrupt
c_func
(paren
)paren
)paren
(brace
id|data
op_assign
(paren
id|u32
)paren
id|virt_to_bus
c_func
(paren
id|scq-&gt;next
)paren
suffix:semicolon
id|ns_write_sram
c_func
(paren
id|card
comma
id|scq-&gt;scd
comma
op_amp
id|data
comma
l_int|1
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|scq-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;nicstar%d: Error pushing TSR.&bslash;n&quot;
comma
id|card-&gt;index
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|scq-&gt;full
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|has_run
op_increment
)paren
r_break
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|scq-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|interruptible_sleep_on_timeout
c_func
(paren
op_amp
id|scq-&gt;scqfull_waitq
comma
id|SCQFULL_TIMEOUT
)paren
suffix:semicolon
id|ns_grab_scq_lock
c_func
(paren
id|card
comma
id|scq
comma
id|flags
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|scq-&gt;full
)paren
(brace
id|tsr.word_1
op_assign
id|ns_tsr_mkword_1
c_func
(paren
id|NS_TSR_INTENABLE
)paren
suffix:semicolon
r_if
c_cond
(paren
id|scq_is_vbr
)paren
id|scdi
op_assign
id|NS_TSR_SCDISVBR
suffix:semicolon
r_else
id|scdi
op_assign
(paren
id|vc-&gt;cbr_scd
op_minus
id|NS_FRSCD
)paren
op_div
id|NS_FRSCD_SIZE
suffix:semicolon
id|scqi
op_assign
id|scq-&gt;next
op_minus
id|scq-&gt;base
suffix:semicolon
id|tsr.word_2
op_assign
id|ns_tsr_mkword_2
c_func
(paren
id|scdi
comma
id|scqi
)paren
suffix:semicolon
id|tsr.word_3
op_assign
l_int|0x00000000
suffix:semicolon
id|tsr.word_4
op_assign
l_int|0x00000000
suffix:semicolon
op_star
id|scq-&gt;next
op_assign
id|tsr
suffix:semicolon
id|index
op_assign
(paren
r_int
)paren
id|scqi
suffix:semicolon
id|scq-&gt;skb
(braket
id|index
)braket
op_assign
l_int|NULL
suffix:semicolon
id|XPRINTK
c_func
(paren
l_string|&quot;nicstar%d: TSR written:&bslash;n0x%x&bslash;n0x%x&bslash;n0x%x&bslash;n0x%x&bslash;n at 0x%x.&bslash;n&quot;
comma
id|card-&gt;index
comma
id|le32_to_cpu
c_func
(paren
id|tsr.word_1
)paren
comma
id|le32_to_cpu
c_func
(paren
id|tsr.word_2
)paren
comma
id|le32_to_cpu
c_func
(paren
id|tsr.word_3
)paren
comma
id|le32_to_cpu
c_func
(paren
id|tsr.word_4
)paren
comma
(paren
id|u32
)paren
id|scq-&gt;next
)paren
suffix:semicolon
r_if
c_cond
(paren
id|scq-&gt;next
op_eq
id|scq-&gt;last
)paren
id|scq-&gt;next
op_assign
id|scq-&gt;base
suffix:semicolon
r_else
id|scq-&gt;next
op_increment
suffix:semicolon
id|vc-&gt;tbd_count
op_assign
l_int|0
suffix:semicolon
id|scq-&gt;tbd_count
op_assign
l_int|0
suffix:semicolon
)brace
r_else
id|PRINTK
c_func
(paren
l_string|&quot;nicstar%d: Timeout pushing TSR.&bslash;n&quot;
comma
id|card-&gt;index
)paren
suffix:semicolon
)brace
id|data
op_assign
(paren
id|u32
)paren
id|virt_to_bus
c_func
(paren
id|scq-&gt;next
)paren
suffix:semicolon
id|ns_write_sram
c_func
(paren
id|card
comma
id|scq-&gt;scd
comma
op_amp
id|data
comma
l_int|1
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|scq-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|process_tsq
r_static
r_void
id|process_tsq
c_func
(paren
id|ns_dev
op_star
id|card
)paren
(brace
id|u32
id|scdi
suffix:semicolon
id|scq_info
op_star
id|scq
suffix:semicolon
id|ns_tsi
op_star
id|previous
op_assign
l_int|NULL
comma
op_star
id|one_ahead
comma
op_star
id|two_ahead
suffix:semicolon
r_int
id|serviced_entries
suffix:semicolon
multiline_comment|/* flag indicating at least on entry was serviced */
id|serviced_entries
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|card-&gt;tsq.next
op_eq
id|card-&gt;tsq.last
)paren
id|one_ahead
op_assign
id|card-&gt;tsq.base
suffix:semicolon
r_else
id|one_ahead
op_assign
id|card-&gt;tsq.next
op_plus
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|one_ahead
op_eq
id|card-&gt;tsq.last
)paren
id|two_ahead
op_assign
id|card-&gt;tsq.base
suffix:semicolon
r_else
id|two_ahead
op_assign
id|one_ahead
op_plus
l_int|1
suffix:semicolon
r_while
c_loop
(paren
op_logical_neg
id|ns_tsi_isempty
c_func
(paren
id|card-&gt;tsq.next
)paren
op_logical_or
op_logical_neg
id|ns_tsi_isempty
c_func
(paren
id|one_ahead
)paren
op_logical_or
op_logical_neg
id|ns_tsi_isempty
c_func
(paren
id|two_ahead
)paren
)paren
multiline_comment|/* At most two empty, as stated in the 77201 errata */
(brace
id|serviced_entries
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* Skip the one or two possible empty entries */
r_while
c_loop
(paren
id|ns_tsi_isempty
c_func
(paren
id|card-&gt;tsq.next
)paren
)paren
(brace
r_if
c_cond
(paren
id|card-&gt;tsq.next
op_eq
id|card-&gt;tsq.last
)paren
id|card-&gt;tsq.next
op_assign
id|card-&gt;tsq.base
suffix:semicolon
r_else
id|card-&gt;tsq.next
op_increment
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|ns_tsi_tmrof
c_func
(paren
id|card-&gt;tsq.next
)paren
)paren
(brace
id|scdi
op_assign
id|ns_tsi_getscdindex
c_func
(paren
id|card-&gt;tsq.next
)paren
suffix:semicolon
r_if
c_cond
(paren
id|scdi
op_eq
id|NS_TSI_SCDISVBR
)paren
id|scq
op_assign
id|card-&gt;scq0
suffix:semicolon
r_else
(brace
r_if
c_cond
(paren
id|card-&gt;scd2vc
(braket
id|scdi
)braket
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;nicstar%d: could not find VC from SCD index.&bslash;n&quot;
comma
id|card-&gt;index
)paren
suffix:semicolon
id|ns_tsi_init
c_func
(paren
id|card-&gt;tsq.next
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|scq
op_assign
id|card-&gt;scd2vc
(braket
id|scdi
)braket
op_member_access_from_pointer
id|scq
suffix:semicolon
)brace
id|drain_scq
c_func
(paren
id|card
comma
id|scq
comma
id|ns_tsi_getscqpos
c_func
(paren
id|card-&gt;tsq.next
)paren
)paren
suffix:semicolon
id|scq-&gt;full
op_assign
l_int|0
suffix:semicolon
id|wake_up_interruptible
c_func
(paren
op_amp
(paren
id|scq-&gt;scqfull_waitq
)paren
)paren
suffix:semicolon
)brace
id|ns_tsi_init
c_func
(paren
id|card-&gt;tsq.next
)paren
suffix:semicolon
id|previous
op_assign
id|card-&gt;tsq.next
suffix:semicolon
r_if
c_cond
(paren
id|card-&gt;tsq.next
op_eq
id|card-&gt;tsq.last
)paren
id|card-&gt;tsq.next
op_assign
id|card-&gt;tsq.base
suffix:semicolon
r_else
id|card-&gt;tsq.next
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|card-&gt;tsq.next
op_eq
id|card-&gt;tsq.last
)paren
id|one_ahead
op_assign
id|card-&gt;tsq.base
suffix:semicolon
r_else
id|one_ahead
op_assign
id|card-&gt;tsq.next
op_plus
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|one_ahead
op_eq
id|card-&gt;tsq.last
)paren
id|two_ahead
op_assign
id|card-&gt;tsq.base
suffix:semicolon
r_else
id|two_ahead
op_assign
id|one_ahead
op_plus
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|serviced_entries
)paren
(brace
id|writel
c_func
(paren
(paren
(paren
(paren
id|u32
)paren
id|previous
)paren
op_minus
(paren
(paren
id|u32
)paren
id|card-&gt;tsq.base
)paren
)paren
comma
id|card-&gt;membase
op_plus
id|TSQH
)paren
suffix:semicolon
)brace
)brace
DECL|function|drain_scq
r_static
r_void
id|drain_scq
c_func
(paren
id|ns_dev
op_star
id|card
comma
id|scq_info
op_star
id|scq
comma
r_int
id|pos
)paren
(brace
r_struct
id|atm_vcc
op_star
id|vcc
suffix:semicolon
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
r_int
id|i
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|XPRINTK
c_func
(paren
l_string|&quot;nicstar%d: drain_scq() called, scq at 0x%x, pos %d.&bslash;n&quot;
comma
id|card-&gt;index
comma
(paren
id|u32
)paren
id|scq
comma
id|pos
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pos
op_ge
id|scq-&gt;num_entries
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;nicstar%d: Bad index on drain_scq().&bslash;n&quot;
comma
id|card-&gt;index
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|ns_grab_scq_lock
c_func
(paren
id|card
comma
id|scq
comma
id|flags
)paren
suffix:semicolon
id|i
op_assign
(paren
r_int
)paren
(paren
id|scq-&gt;tail
op_minus
id|scq-&gt;base
)paren
suffix:semicolon
r_if
c_cond
(paren
op_increment
id|i
op_eq
id|scq-&gt;num_entries
)paren
id|i
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
id|i
op_ne
id|pos
)paren
(brace
id|skb
op_assign
id|scq-&gt;skb
(braket
id|i
)braket
suffix:semicolon
id|XPRINTK
c_func
(paren
l_string|&quot;nicstar%d: freeing skb at 0x%x (index %d).&bslash;n&quot;
comma
id|card-&gt;index
comma
(paren
id|u32
)paren
id|skb
comma
id|i
)paren
suffix:semicolon
r_if
c_cond
(paren
id|skb
op_ne
l_int|NULL
)paren
(brace
id|vcc
op_assign
id|ATM_SKB
c_func
(paren
id|skb
)paren
op_member_access_from_pointer
id|vcc
suffix:semicolon
r_if
c_cond
(paren
id|vcc-&gt;pop
op_ne
l_int|NULL
)paren
(brace
id|vcc
op_member_access_from_pointer
id|pop
c_func
(paren
id|vcc
comma
id|skb
)paren
suffix:semicolon
)brace
r_else
(brace
id|dev_kfree_skb_irq
c_func
(paren
id|skb
)paren
suffix:semicolon
)brace
id|scq-&gt;skb
(braket
id|i
)braket
op_assign
l_int|NULL
suffix:semicolon
)brace
r_if
c_cond
(paren
op_increment
id|i
op_eq
id|scq-&gt;num_entries
)paren
id|i
op_assign
l_int|0
suffix:semicolon
)brace
id|scq-&gt;tail
op_assign
id|scq-&gt;base
op_plus
id|pos
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|scq-&gt;lock
comma
id|flags
)paren
suffix:semicolon
)brace
DECL|function|process_rsq
r_static
r_void
id|process_rsq
c_func
(paren
id|ns_dev
op_star
id|card
)paren
(brace
id|ns_rsqe
op_star
id|previous
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ns_rsqe_valid
c_func
(paren
id|card-&gt;rsq.next
)paren
)paren
r_return
suffix:semicolon
r_while
c_loop
(paren
id|ns_rsqe_valid
c_func
(paren
id|card-&gt;rsq.next
)paren
)paren
(brace
id|dequeue_rx
c_func
(paren
id|card
comma
id|card-&gt;rsq.next
)paren
suffix:semicolon
id|ns_rsqe_init
c_func
(paren
id|card-&gt;rsq.next
)paren
suffix:semicolon
id|previous
op_assign
id|card-&gt;rsq.next
suffix:semicolon
r_if
c_cond
(paren
id|card-&gt;rsq.next
op_eq
id|card-&gt;rsq.last
)paren
id|card-&gt;rsq.next
op_assign
id|card-&gt;rsq.base
suffix:semicolon
r_else
id|card-&gt;rsq.next
op_increment
suffix:semicolon
)brace
id|writel
c_func
(paren
(paren
(paren
(paren
id|u32
)paren
id|previous
)paren
op_minus
(paren
(paren
id|u32
)paren
id|card-&gt;rsq.base
)paren
)paren
comma
id|card-&gt;membase
op_plus
id|RSQH
)paren
suffix:semicolon
)brace
DECL|function|dequeue_rx
r_static
r_void
id|dequeue_rx
c_func
(paren
id|ns_dev
op_star
id|card
comma
id|ns_rsqe
op_star
id|rsqe
)paren
(brace
id|u32
id|vpi
comma
id|vci
suffix:semicolon
id|vc_map
op_star
id|vc
suffix:semicolon
r_struct
id|sk_buff
op_star
id|iovb
suffix:semicolon
r_struct
id|iovec
op_star
id|iov
suffix:semicolon
r_struct
id|atm_vcc
op_star
id|vcc
suffix:semicolon
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
r_int
r_int
id|aal5_len
suffix:semicolon
r_int
id|len
suffix:semicolon
id|u32
id|stat
suffix:semicolon
id|stat
op_assign
id|readl
c_func
(paren
id|card-&gt;membase
op_plus
id|STAT
)paren
suffix:semicolon
id|card-&gt;sbfqc
op_assign
id|ns_stat_sfbqc_get
c_func
(paren
id|stat
)paren
suffix:semicolon
id|card-&gt;lbfqc
op_assign
id|ns_stat_lfbqc_get
c_func
(paren
id|stat
)paren
suffix:semicolon
id|skb
op_assign
(paren
r_struct
id|sk_buff
op_star
)paren
id|le32_to_cpu
c_func
(paren
id|rsqe-&gt;buffer_handle
)paren
suffix:semicolon
id|vpi
op_assign
id|ns_rsqe_vpi
c_func
(paren
id|rsqe
)paren
suffix:semicolon
id|vci
op_assign
id|ns_rsqe_vci
c_func
(paren
id|rsqe
)paren
suffix:semicolon
r_if
c_cond
(paren
id|vpi
op_ge
l_int|1UL
op_lshift
id|card-&gt;vpibits
op_logical_or
id|vci
op_ge
l_int|1UL
op_lshift
id|card-&gt;vcibits
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;nicstar%d: SDU received for out-of-range vc %d.%d.&bslash;n&quot;
comma
id|card-&gt;index
comma
id|vpi
comma
id|vci
)paren
suffix:semicolon
id|recycle_rx_buf
c_func
(paren
id|card
comma
id|skb
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|vc
op_assign
op_amp
(paren
id|card-&gt;vcmap
(braket
id|vpi
op_lshift
id|card-&gt;vcibits
op_or
id|vci
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|vc-&gt;rx
)paren
(brace
id|RXPRINTK
c_func
(paren
l_string|&quot;nicstar%d: SDU received on non-rx vc %d.%d.&bslash;n&quot;
comma
id|card-&gt;index
comma
id|vpi
comma
id|vci
)paren
suffix:semicolon
id|recycle_rx_buf
c_func
(paren
id|card
comma
id|skb
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|vcc
op_assign
id|vc-&gt;rx_vcc
suffix:semicolon
r_if
c_cond
(paren
id|vcc-&gt;qos.aal
op_eq
id|ATM_AAL0
)paren
(brace
r_struct
id|sk_buff
op_star
id|sb
suffix:semicolon
r_int
r_char
op_star
id|cell
suffix:semicolon
r_int
id|i
suffix:semicolon
id|cell
op_assign
id|skb-&gt;data
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
id|ns_rsqe_cellcount
c_func
(paren
id|rsqe
)paren
suffix:semicolon
id|i
suffix:semicolon
id|i
op_decrement
)paren
(brace
r_if
c_cond
(paren
(paren
id|sb
op_assign
id|alloc_skb
c_func
(paren
id|NS_SMSKBSIZE
comma
id|GFP_ATOMIC
)paren
)paren
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;nicstar%d: Can&squot;t allocate buffers for aal0.&bslash;n&quot;
comma
id|card-&gt;index
)paren
suffix:semicolon
id|atomic_add
c_func
(paren
id|i
comma
op_amp
id|vcc-&gt;stats-&gt;rx_drop
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|atm_charge
c_func
(paren
id|vcc
comma
id|sb-&gt;truesize
)paren
)paren
(brace
id|RXPRINTK
c_func
(paren
l_string|&quot;nicstar%d: atm_charge() dropped aal0 packets.&bslash;n&quot;
comma
id|card-&gt;index
)paren
suffix:semicolon
id|atomic_add
c_func
(paren
id|i
op_minus
l_int|1
comma
op_amp
id|vcc-&gt;stats-&gt;rx_drop
)paren
suffix:semicolon
multiline_comment|/* already increased by 1 */
id|dev_kfree_skb_any
c_func
(paren
id|sb
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
multiline_comment|/* Rebuild the header */
op_star
(paren
(paren
id|u32
op_star
)paren
id|sb-&gt;data
)paren
op_assign
id|le32_to_cpu
c_func
(paren
id|rsqe-&gt;word_1
)paren
op_lshift
l_int|4
op_or
(paren
id|ns_rsqe_clp
c_func
(paren
id|rsqe
)paren
ques
c_cond
l_int|0x00000001
suffix:colon
l_int|0x00000000
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
op_eq
l_int|1
op_logical_and
id|ns_rsqe_eopdu
c_func
(paren
id|rsqe
)paren
)paren
op_star
(paren
(paren
id|u32
op_star
)paren
id|sb-&gt;data
)paren
op_or_assign
l_int|0x00000002
suffix:semicolon
id|skb_put
c_func
(paren
id|sb
comma
id|NS_AAL0_HEADER
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|sb-&gt;tail
comma
id|cell
comma
id|ATM_CELL_PAYLOAD
)paren
suffix:semicolon
id|skb_put
c_func
(paren
id|sb
comma
id|ATM_CELL_PAYLOAD
)paren
suffix:semicolon
id|ATM_SKB
c_func
(paren
id|sb
)paren
op_member_access_from_pointer
id|vcc
op_assign
id|vcc
suffix:semicolon
id|sb-&gt;stamp
op_assign
id|xtime
suffix:semicolon
id|vcc
op_member_access_from_pointer
id|push
c_func
(paren
id|vcc
comma
id|sb
)paren
suffix:semicolon
id|atomic_inc
c_func
(paren
op_amp
id|vcc-&gt;stats-&gt;rx
)paren
suffix:semicolon
id|cell
op_add_assign
id|ATM_CELL_PAYLOAD
suffix:semicolon
)brace
id|recycle_rx_buf
c_func
(paren
id|card
comma
id|skb
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/* To reach this point, the AAL layer can only be AAL5 */
r_if
c_cond
(paren
(paren
id|iovb
op_assign
id|vc-&gt;rx_iov
)paren
op_eq
l_int|NULL
)paren
(brace
id|iovb
op_assign
id|skb_dequeue
c_func
(paren
op_amp
(paren
id|card-&gt;iovpool.queue
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|iovb
op_eq
l_int|NULL
)paren
multiline_comment|/* No buffers in the queue */
(brace
id|iovb
op_assign
id|alloc_skb
c_func
(paren
id|NS_IOVBUFSIZE
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
id|iovb
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;nicstar%d: Out of iovec buffers.&bslash;n&quot;
comma
id|card-&gt;index
)paren
suffix:semicolon
id|atomic_inc
c_func
(paren
op_amp
id|vcc-&gt;stats-&gt;rx_drop
)paren
suffix:semicolon
id|recycle_rx_buf
c_func
(paren
id|card
comma
id|skb
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
)brace
r_else
r_if
c_cond
(paren
op_decrement
id|card-&gt;iovpool.count
OL
id|card-&gt;iovnr.min
)paren
(brace
r_struct
id|sk_buff
op_star
id|new_iovb
suffix:semicolon
r_if
c_cond
(paren
(paren
id|new_iovb
op_assign
id|alloc_skb
c_func
(paren
id|NS_IOVBUFSIZE
comma
id|GFP_ATOMIC
)paren
)paren
op_ne
l_int|NULL
)paren
(brace
id|skb_queue_tail
c_func
(paren
op_amp
id|card-&gt;iovpool.queue
comma
id|new_iovb
)paren
suffix:semicolon
id|card-&gt;iovpool.count
op_increment
suffix:semicolon
)brace
)brace
id|vc-&gt;rx_iov
op_assign
id|iovb
suffix:semicolon
id|ATM_SKB
c_func
(paren
id|iovb
)paren
op_member_access_from_pointer
id|iovcnt
op_assign
l_int|0
suffix:semicolon
id|iovb-&gt;len
op_assign
l_int|0
suffix:semicolon
id|iovb-&gt;tail
op_assign
id|iovb-&gt;data
op_assign
id|iovb-&gt;head
suffix:semicolon
id|ATM_SKB
c_func
(paren
id|iovb
)paren
op_member_access_from_pointer
id|vcc
op_assign
id|vcc
suffix:semicolon
multiline_comment|/* IMPORTANT: a pointer to the sk_buff containing the small or large&n;                    buffer is stored as iovec base, NOT a pointer to the &n;&t;            small or large buffer itself. */
)brace
r_else
r_if
c_cond
(paren
id|ATM_SKB
c_func
(paren
id|iovb
)paren
op_member_access_from_pointer
id|iovcnt
op_ge
id|NS_MAX_IOVECS
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;nicstar%d: received too big AAL5 SDU.&bslash;n&quot;
comma
id|card-&gt;index
)paren
suffix:semicolon
id|atomic_inc
c_func
(paren
op_amp
id|vcc-&gt;stats-&gt;rx_err
)paren
suffix:semicolon
id|recycle_iovec_rx_bufs
c_func
(paren
id|card
comma
(paren
r_struct
id|iovec
op_star
)paren
id|iovb-&gt;data
comma
id|NS_MAX_IOVECS
)paren
suffix:semicolon
id|ATM_SKB
c_func
(paren
id|iovb
)paren
op_member_access_from_pointer
id|iovcnt
op_assign
l_int|0
suffix:semicolon
id|iovb-&gt;len
op_assign
l_int|0
suffix:semicolon
id|iovb-&gt;tail
op_assign
id|iovb-&gt;data
op_assign
id|iovb-&gt;head
suffix:semicolon
id|ATM_SKB
c_func
(paren
id|iovb
)paren
op_member_access_from_pointer
id|vcc
op_assign
id|vcc
suffix:semicolon
)brace
id|iov
op_assign
op_amp
(paren
(paren
r_struct
id|iovec
op_star
)paren
id|iovb-&gt;data
)paren
(braket
id|ATM_SKB
c_func
(paren
id|iovb
)paren
op_member_access_from_pointer
id|iovcnt
op_increment
)braket
suffix:semicolon
id|iov-&gt;iov_base
op_assign
(paren
r_void
op_star
)paren
id|skb
suffix:semicolon
id|iov-&gt;iov_len
op_assign
id|ns_rsqe_cellcount
c_func
(paren
id|rsqe
)paren
op_star
l_int|48
suffix:semicolon
id|iovb-&gt;len
op_add_assign
id|iov-&gt;iov_len
suffix:semicolon
r_if
c_cond
(paren
id|ATM_SKB
c_func
(paren
id|iovb
)paren
op_member_access_from_pointer
id|iovcnt
op_eq
l_int|1
)paren
(brace
r_if
c_cond
(paren
id|skb-&gt;list
op_ne
op_amp
id|card-&gt;sbpool.queue
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;nicstar%d: Expected a small buffer, and this is not one.&bslash;n&quot;
comma
id|card-&gt;index
)paren
suffix:semicolon
id|which_list
c_func
(paren
id|card
comma
id|skb
)paren
suffix:semicolon
id|atomic_inc
c_func
(paren
op_amp
id|vcc-&gt;stats-&gt;rx_err
)paren
suffix:semicolon
id|recycle_rx_buf
c_func
(paren
id|card
comma
id|skb
)paren
suffix:semicolon
id|vc-&gt;rx_iov
op_assign
l_int|NULL
suffix:semicolon
id|recycle_iov_buf
c_func
(paren
id|card
comma
id|iovb
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
)brace
r_else
multiline_comment|/* ATM_SKB(iovb)-&gt;iovcnt &gt;= 2 */
(brace
r_if
c_cond
(paren
id|skb-&gt;list
op_ne
op_amp
id|card-&gt;lbpool.queue
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;nicstar%d: Expected a large buffer, and this is not one.&bslash;n&quot;
comma
id|card-&gt;index
)paren
suffix:semicolon
id|which_list
c_func
(paren
id|card
comma
id|skb
)paren
suffix:semicolon
id|atomic_inc
c_func
(paren
op_amp
id|vcc-&gt;stats-&gt;rx_err
)paren
suffix:semicolon
id|recycle_iovec_rx_bufs
c_func
(paren
id|card
comma
(paren
r_struct
id|iovec
op_star
)paren
id|iovb-&gt;data
comma
id|ATM_SKB
c_func
(paren
id|iovb
)paren
op_member_access_from_pointer
id|iovcnt
)paren
suffix:semicolon
id|vc-&gt;rx_iov
op_assign
l_int|NULL
suffix:semicolon
id|recycle_iov_buf
c_func
(paren
id|card
comma
id|iovb
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|ns_rsqe_eopdu
c_func
(paren
id|rsqe
)paren
)paren
(brace
multiline_comment|/* This works correctly regardless of the endianness of the host */
r_int
r_char
op_star
id|L1L2
op_assign
(paren
r_int
r_char
op_star
)paren
(paren
(paren
id|u32
)paren
id|skb-&gt;data
op_plus
id|iov-&gt;iov_len
op_minus
l_int|6
)paren
suffix:semicolon
id|aal5_len
op_assign
id|L1L2
(braket
l_int|0
)braket
op_lshift
l_int|8
op_or
id|L1L2
(braket
l_int|1
)braket
suffix:semicolon
id|len
op_assign
(paren
id|aal5_len
op_eq
l_int|0x0000
)paren
ques
c_cond
l_int|0x10000
suffix:colon
id|aal5_len
suffix:semicolon
r_if
c_cond
(paren
id|ns_rsqe_crcerr
c_func
(paren
id|rsqe
)paren
op_logical_or
id|len
op_plus
l_int|8
OG
id|iovb-&gt;len
op_logical_or
id|len
op_plus
(paren
l_int|47
op_plus
l_int|8
)paren
OL
id|iovb-&gt;len
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;nicstar%d: AAL5 CRC error&quot;
comma
id|card-&gt;index
)paren
suffix:semicolon
r_if
c_cond
(paren
id|len
op_plus
l_int|8
OG
id|iovb-&gt;len
op_logical_or
id|len
op_plus
(paren
l_int|47
op_plus
l_int|8
)paren
OL
id|iovb-&gt;len
)paren
id|printk
c_func
(paren
l_string|&quot; - PDU size mismatch.&bslash;n&quot;
)paren
suffix:semicolon
r_else
id|printk
c_func
(paren
l_string|&quot;.&bslash;n&quot;
)paren
suffix:semicolon
id|atomic_inc
c_func
(paren
op_amp
id|vcc-&gt;stats-&gt;rx_err
)paren
suffix:semicolon
id|recycle_iovec_rx_bufs
c_func
(paren
id|card
comma
(paren
r_struct
id|iovec
op_star
)paren
id|iovb-&gt;data
comma
id|ATM_SKB
c_func
(paren
id|iovb
)paren
op_member_access_from_pointer
id|iovcnt
)paren
suffix:semicolon
id|vc-&gt;rx_iov
op_assign
l_int|NULL
suffix:semicolon
id|recycle_iov_buf
c_func
(paren
id|card
comma
id|iovb
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/* By this point we (hopefully) have a complete SDU without errors. */
r_if
c_cond
(paren
id|ATM_SKB
c_func
(paren
id|iovb
)paren
op_member_access_from_pointer
id|iovcnt
op_eq
l_int|1
)paren
multiline_comment|/* Just a small buffer */
(brace
multiline_comment|/* skb points to a small buffer */
r_if
c_cond
(paren
op_logical_neg
id|atm_charge
c_func
(paren
id|vcc
comma
id|skb-&gt;truesize
)paren
)paren
(brace
id|push_rxbufs
c_func
(paren
id|card
comma
id|BUF_SM
comma
(paren
id|u32
)paren
id|skb
comma
(paren
id|u32
)paren
id|virt_to_bus
c_func
(paren
id|skb-&gt;data
)paren
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
)brace
r_else
(brace
id|skb_put
c_func
(paren
id|skb
comma
id|len
)paren
suffix:semicolon
id|dequeue_sm_buf
c_func
(paren
id|card
comma
id|skb
)paren
suffix:semicolon
macro_line|#ifdef NS_USE_DESTRUCTORS
id|skb-&gt;destructor
op_assign
id|ns_sb_destructor
suffix:semicolon
macro_line|#endif /* NS_USE_DESTRUCTORS */
id|ATM_SKB
c_func
(paren
id|skb
)paren
op_member_access_from_pointer
id|vcc
op_assign
id|vcc
suffix:semicolon
id|skb-&gt;stamp
op_assign
id|xtime
suffix:semicolon
id|vcc
op_member_access_from_pointer
id|push
c_func
(paren
id|vcc
comma
id|skb
)paren
suffix:semicolon
id|atomic_inc
c_func
(paren
op_amp
id|vcc-&gt;stats-&gt;rx
)paren
suffix:semicolon
)brace
)brace
r_else
r_if
c_cond
(paren
id|ATM_SKB
c_func
(paren
id|iovb
)paren
op_member_access_from_pointer
id|iovcnt
op_eq
l_int|2
)paren
multiline_comment|/* One small plus one large buffer */
(brace
r_struct
id|sk_buff
op_star
id|sb
suffix:semicolon
id|sb
op_assign
(paren
r_struct
id|sk_buff
op_star
)paren
(paren
id|iov
op_minus
l_int|1
)paren
op_member_access_from_pointer
id|iov_base
suffix:semicolon
multiline_comment|/* skb points to a large buffer */
r_if
c_cond
(paren
id|len
op_le
id|NS_SMBUFSIZE
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|atm_charge
c_func
(paren
id|vcc
comma
id|sb-&gt;truesize
)paren
)paren
(brace
id|push_rxbufs
c_func
(paren
id|card
comma
id|BUF_SM
comma
(paren
id|u32
)paren
id|sb
comma
(paren
id|u32
)paren
id|virt_to_bus
c_func
(paren
id|sb-&gt;data
)paren
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
)brace
r_else
(brace
id|skb_put
c_func
(paren
id|sb
comma
id|len
)paren
suffix:semicolon
id|dequeue_sm_buf
c_func
(paren
id|card
comma
id|sb
)paren
suffix:semicolon
macro_line|#ifdef NS_USE_DESTRUCTORS
id|sb-&gt;destructor
op_assign
id|ns_sb_destructor
suffix:semicolon
macro_line|#endif /* NS_USE_DESTRUCTORS */
id|ATM_SKB
c_func
(paren
id|sb
)paren
op_member_access_from_pointer
id|vcc
op_assign
id|vcc
suffix:semicolon
id|sb-&gt;stamp
op_assign
id|xtime
suffix:semicolon
id|vcc
op_member_access_from_pointer
id|push
c_func
(paren
id|vcc
comma
id|sb
)paren
suffix:semicolon
id|atomic_inc
c_func
(paren
op_amp
id|vcc-&gt;stats-&gt;rx
)paren
suffix:semicolon
)brace
id|push_rxbufs
c_func
(paren
id|card
comma
id|BUF_LG
comma
(paren
id|u32
)paren
id|skb
comma
(paren
id|u32
)paren
id|virt_to_bus
c_func
(paren
id|skb-&gt;data
)paren
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
)brace
r_else
multiline_comment|/* len &gt; NS_SMBUFSIZE, the usual case */
(brace
r_if
c_cond
(paren
op_logical_neg
id|atm_charge
c_func
(paren
id|vcc
comma
id|skb-&gt;truesize
)paren
)paren
(brace
id|push_rxbufs
c_func
(paren
id|card
comma
id|BUF_LG
comma
(paren
id|u32
)paren
id|skb
comma
(paren
id|u32
)paren
id|virt_to_bus
c_func
(paren
id|skb-&gt;data
)paren
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
)brace
r_else
(brace
id|dequeue_lg_buf
c_func
(paren
id|card
comma
id|skb
)paren
suffix:semicolon
macro_line|#ifdef NS_USE_DESTRUCTORS
id|skb-&gt;destructor
op_assign
id|ns_lb_destructor
suffix:semicolon
macro_line|#endif /* NS_USE_DESTRUCTORS */
id|skb_push
c_func
(paren
id|skb
comma
id|NS_SMBUFSIZE
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|skb-&gt;data
comma
id|sb-&gt;data
comma
id|NS_SMBUFSIZE
)paren
suffix:semicolon
id|skb_put
c_func
(paren
id|skb
comma
id|len
op_minus
id|NS_SMBUFSIZE
)paren
suffix:semicolon
id|ATM_SKB
c_func
(paren
id|skb
)paren
op_member_access_from_pointer
id|vcc
op_assign
id|vcc
suffix:semicolon
id|skb-&gt;stamp
op_assign
id|xtime
suffix:semicolon
id|vcc
op_member_access_from_pointer
id|push
c_func
(paren
id|vcc
comma
id|skb
)paren
suffix:semicolon
id|atomic_inc
c_func
(paren
op_amp
id|vcc-&gt;stats-&gt;rx
)paren
suffix:semicolon
)brace
id|push_rxbufs
c_func
(paren
id|card
comma
id|BUF_SM
comma
(paren
id|u32
)paren
id|sb
comma
(paren
id|u32
)paren
id|virt_to_bus
c_func
(paren
id|sb-&gt;data
)paren
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
)brace
)brace
r_else
multiline_comment|/* Must push a huge buffer */
(brace
r_struct
id|sk_buff
op_star
id|hb
comma
op_star
id|sb
comma
op_star
id|lb
suffix:semicolon
r_int
id|remaining
comma
id|tocopy
suffix:semicolon
r_int
id|j
suffix:semicolon
id|hb
op_assign
id|skb_dequeue
c_func
(paren
op_amp
(paren
id|card-&gt;hbpool.queue
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|hb
op_eq
l_int|NULL
)paren
multiline_comment|/* No buffers in the queue */
(brace
id|hb
op_assign
id|alloc_skb
c_func
(paren
id|NS_HBUFSIZE
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
id|hb
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;nicstar%d: Out of huge buffers.&bslash;n&quot;
comma
id|card-&gt;index
)paren
suffix:semicolon
id|atomic_inc
c_func
(paren
op_amp
id|vcc-&gt;stats-&gt;rx_drop
)paren
suffix:semicolon
id|recycle_iovec_rx_bufs
c_func
(paren
id|card
comma
(paren
r_struct
id|iovec
op_star
)paren
id|iovb-&gt;data
comma
id|ATM_SKB
c_func
(paren
id|iovb
)paren
op_member_access_from_pointer
id|iovcnt
)paren
suffix:semicolon
id|vc-&gt;rx_iov
op_assign
l_int|NULL
suffix:semicolon
id|recycle_iov_buf
c_func
(paren
id|card
comma
id|iovb
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|card-&gt;hbpool.count
OL
id|card-&gt;hbnr.min
)paren
(brace
r_struct
id|sk_buff
op_star
id|new_hb
suffix:semicolon
r_if
c_cond
(paren
(paren
id|new_hb
op_assign
id|alloc_skb
c_func
(paren
id|NS_HBUFSIZE
comma
id|GFP_ATOMIC
)paren
)paren
op_ne
l_int|NULL
)paren
(brace
id|skb_queue_tail
c_func
(paren
op_amp
id|card-&gt;hbpool.queue
comma
id|new_hb
)paren
suffix:semicolon
id|card-&gt;hbpool.count
op_increment
suffix:semicolon
)brace
)brace
)brace
r_else
r_if
c_cond
(paren
op_decrement
id|card-&gt;hbpool.count
OL
id|card-&gt;hbnr.min
)paren
(brace
r_struct
id|sk_buff
op_star
id|new_hb
suffix:semicolon
r_if
c_cond
(paren
(paren
id|new_hb
op_assign
id|alloc_skb
c_func
(paren
id|NS_HBUFSIZE
comma
id|GFP_ATOMIC
)paren
)paren
op_ne
l_int|NULL
)paren
(brace
id|skb_queue_tail
c_func
(paren
op_amp
id|card-&gt;hbpool.queue
comma
id|new_hb
)paren
suffix:semicolon
id|card-&gt;hbpool.count
op_increment
suffix:semicolon
)brace
r_if
c_cond
(paren
id|card-&gt;hbpool.count
OL
id|card-&gt;hbnr.min
)paren
(brace
r_if
c_cond
(paren
(paren
id|new_hb
op_assign
id|alloc_skb
c_func
(paren
id|NS_HBUFSIZE
comma
id|GFP_ATOMIC
)paren
)paren
op_ne
l_int|NULL
)paren
(brace
id|skb_queue_tail
c_func
(paren
op_amp
id|card-&gt;hbpool.queue
comma
id|new_hb
)paren
suffix:semicolon
id|card-&gt;hbpool.count
op_increment
suffix:semicolon
)brace
)brace
)brace
id|iov
op_assign
(paren
r_struct
id|iovec
op_star
)paren
id|iovb-&gt;data
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|atm_charge
c_func
(paren
id|vcc
comma
id|hb-&gt;truesize
)paren
)paren
(brace
id|recycle_iovec_rx_bufs
c_func
(paren
id|card
comma
id|iov
comma
id|ATM_SKB
c_func
(paren
id|iovb
)paren
op_member_access_from_pointer
id|iovcnt
)paren
suffix:semicolon
r_if
c_cond
(paren
id|card-&gt;hbpool.count
OL
id|card-&gt;hbnr.max
)paren
(brace
id|skb_queue_tail
c_func
(paren
op_amp
id|card-&gt;hbpool.queue
comma
id|hb
)paren
suffix:semicolon
id|card-&gt;hbpool.count
op_increment
suffix:semicolon
)brace
r_else
id|dev_kfree_skb_any
c_func
(paren
id|hb
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* Copy the small buffer to the huge buffer */
id|sb
op_assign
(paren
r_struct
id|sk_buff
op_star
)paren
id|iov-&gt;iov_base
suffix:semicolon
id|memcpy
c_func
(paren
id|hb-&gt;data
comma
id|sb-&gt;data
comma
id|iov-&gt;iov_len
)paren
suffix:semicolon
id|skb_put
c_func
(paren
id|hb
comma
id|iov-&gt;iov_len
)paren
suffix:semicolon
id|remaining
op_assign
id|len
op_minus
id|iov-&gt;iov_len
suffix:semicolon
id|iov
op_increment
suffix:semicolon
multiline_comment|/* Free the small buffer */
id|push_rxbufs
c_func
(paren
id|card
comma
id|BUF_SM
comma
(paren
id|u32
)paren
id|sb
comma
(paren
id|u32
)paren
id|virt_to_bus
c_func
(paren
id|sb-&gt;data
)paren
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* Copy all large buffers to the huge buffer and free them */
r_for
c_loop
(paren
id|j
op_assign
l_int|1
suffix:semicolon
id|j
OL
id|ATM_SKB
c_func
(paren
id|iovb
)paren
op_member_access_from_pointer
id|iovcnt
suffix:semicolon
id|j
op_increment
)paren
(brace
id|lb
op_assign
(paren
r_struct
id|sk_buff
op_star
)paren
id|iov-&gt;iov_base
suffix:semicolon
id|tocopy
op_assign
id|MIN
c_func
(paren
id|remaining
comma
id|iov-&gt;iov_len
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|hb-&gt;tail
comma
id|lb-&gt;data
comma
id|tocopy
)paren
suffix:semicolon
id|skb_put
c_func
(paren
id|hb
comma
id|tocopy
)paren
suffix:semicolon
id|iov
op_increment
suffix:semicolon
id|remaining
op_sub_assign
id|tocopy
suffix:semicolon
id|push_rxbufs
c_func
(paren
id|card
comma
id|BUF_LG
comma
(paren
id|u32
)paren
id|lb
comma
(paren
id|u32
)paren
id|virt_to_bus
c_func
(paren
id|lb-&gt;data
)paren
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
)brace
macro_line|#ifdef EXTRA_DEBUG
r_if
c_cond
(paren
id|remaining
op_ne
l_int|0
op_logical_or
id|hb-&gt;len
op_ne
id|len
)paren
id|printk
c_func
(paren
l_string|&quot;nicstar%d: Huge buffer len mismatch.&bslash;n&quot;
comma
id|card-&gt;index
)paren
suffix:semicolon
macro_line|#endif /* EXTRA_DEBUG */
id|ATM_SKB
c_func
(paren
id|hb
)paren
op_member_access_from_pointer
id|vcc
op_assign
id|vcc
suffix:semicolon
macro_line|#ifdef NS_USE_DESTRUCTORS
id|hb-&gt;destructor
op_assign
id|ns_hb_destructor
suffix:semicolon
macro_line|#endif /* NS_USE_DESTRUCTORS */
id|hb-&gt;stamp
op_assign
id|xtime
suffix:semicolon
id|vcc
op_member_access_from_pointer
id|push
c_func
(paren
id|vcc
comma
id|hb
)paren
suffix:semicolon
id|atomic_inc
c_func
(paren
op_amp
id|vcc-&gt;stats-&gt;rx
)paren
suffix:semicolon
)brace
)brace
id|vc-&gt;rx_iov
op_assign
l_int|NULL
suffix:semicolon
id|recycle_iov_buf
c_func
(paren
id|card
comma
id|iovb
)paren
suffix:semicolon
)brace
)brace
macro_line|#ifdef NS_USE_DESTRUCTORS
DECL|function|ns_sb_destructor
r_static
r_void
id|ns_sb_destructor
c_func
(paren
r_struct
id|sk_buff
op_star
id|sb
)paren
(brace
id|ns_dev
op_star
id|card
suffix:semicolon
id|u32
id|stat
suffix:semicolon
id|card
op_assign
(paren
id|ns_dev
op_star
)paren
id|ATM_SKB
c_func
(paren
id|sb
)paren
op_member_access_from_pointer
id|vcc-&gt;dev-&gt;dev_data
suffix:semicolon
id|stat
op_assign
id|readl
c_func
(paren
id|card-&gt;membase
op_plus
id|STAT
)paren
suffix:semicolon
id|card-&gt;sbfqc
op_assign
id|ns_stat_sfbqc_get
c_func
(paren
id|stat
)paren
suffix:semicolon
id|card-&gt;lbfqc
op_assign
id|ns_stat_lfbqc_get
c_func
(paren
id|stat
)paren
suffix:semicolon
r_do
(brace
id|sb
op_assign
id|alloc_skb
c_func
(paren
id|NS_SMSKBSIZE
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sb
op_eq
l_int|NULL
)paren
r_break
suffix:semicolon
id|skb_queue_tail
c_func
(paren
op_amp
id|card-&gt;sbpool.queue
comma
id|sb
)paren
suffix:semicolon
id|skb_reserve
c_func
(paren
id|sb
comma
id|NS_AAL0_HEADER
)paren
suffix:semicolon
id|push_rxbufs
c_func
(paren
id|card
comma
id|BUF_SM
comma
(paren
id|u32
)paren
id|sb
comma
(paren
id|u32
)paren
id|virt_to_bus
c_func
(paren
id|sb-&gt;data
)paren
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
id|card-&gt;sbfqc
OL
id|card-&gt;sbnr.min
)paren
suffix:semicolon
)brace
DECL|function|ns_lb_destructor
r_static
r_void
id|ns_lb_destructor
c_func
(paren
r_struct
id|sk_buff
op_star
id|lb
)paren
(brace
id|ns_dev
op_star
id|card
suffix:semicolon
id|u32
id|stat
suffix:semicolon
id|card
op_assign
(paren
id|ns_dev
op_star
)paren
id|ATM_SKB
c_func
(paren
id|lb
)paren
op_member_access_from_pointer
id|vcc-&gt;dev-&gt;dev_data
suffix:semicolon
id|stat
op_assign
id|readl
c_func
(paren
id|card-&gt;membase
op_plus
id|STAT
)paren
suffix:semicolon
id|card-&gt;sbfqc
op_assign
id|ns_stat_sfbqc_get
c_func
(paren
id|stat
)paren
suffix:semicolon
id|card-&gt;lbfqc
op_assign
id|ns_stat_lfbqc_get
c_func
(paren
id|stat
)paren
suffix:semicolon
r_do
(brace
id|lb
op_assign
id|alloc_skb
c_func
(paren
id|NS_LGSKBSIZE
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|lb
op_eq
l_int|NULL
)paren
r_break
suffix:semicolon
id|skb_queue_tail
c_func
(paren
op_amp
id|card-&gt;lbpool.queue
comma
id|lb
)paren
suffix:semicolon
id|skb_reserve
c_func
(paren
id|lb
comma
id|NS_SMBUFSIZE
)paren
suffix:semicolon
id|push_rxbufs
c_func
(paren
id|card
comma
id|BUF_LG
comma
(paren
id|u32
)paren
id|lb
comma
(paren
id|u32
)paren
id|virt_to_bus
c_func
(paren
id|lb-&gt;data
)paren
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
id|card-&gt;lbfqc
OL
id|card-&gt;lbnr.min
)paren
suffix:semicolon
)brace
DECL|function|ns_hb_destructor
r_static
r_void
id|ns_hb_destructor
c_func
(paren
r_struct
id|sk_buff
op_star
id|hb
)paren
(brace
id|ns_dev
op_star
id|card
suffix:semicolon
id|card
op_assign
(paren
id|ns_dev
op_star
)paren
id|ATM_SKB
c_func
(paren
id|hb
)paren
op_member_access_from_pointer
id|vcc-&gt;dev-&gt;dev_data
suffix:semicolon
r_while
c_loop
(paren
id|card-&gt;hbpool.count
OL
id|card-&gt;hbnr.init
)paren
(brace
id|hb
op_assign
id|alloc_skb
c_func
(paren
id|NS_HBUFSIZE
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|hb
op_eq
l_int|NULL
)paren
r_break
suffix:semicolon
id|skb_queue_tail
c_func
(paren
op_amp
id|card-&gt;hbpool.queue
comma
id|hb
)paren
suffix:semicolon
id|card-&gt;hbpool.count
op_increment
suffix:semicolon
)brace
)brace
macro_line|#endif /* NS_USE_DESTRUCTORS */
DECL|function|recycle_rx_buf
r_static
r_void
id|recycle_rx_buf
c_func
(paren
id|ns_dev
op_star
id|card
comma
r_struct
id|sk_buff
op_star
id|skb
)paren
(brace
r_if
c_cond
(paren
id|skb-&gt;list
op_eq
op_amp
id|card-&gt;sbpool.queue
)paren
id|push_rxbufs
c_func
(paren
id|card
comma
id|BUF_SM
comma
(paren
id|u32
)paren
id|skb
comma
(paren
id|u32
)paren
id|virt_to_bus
c_func
(paren
id|skb-&gt;data
)paren
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
id|skb-&gt;list
op_eq
op_amp
id|card-&gt;lbpool.queue
)paren
id|push_rxbufs
c_func
(paren
id|card
comma
id|BUF_LG
comma
(paren
id|u32
)paren
id|skb
comma
(paren
id|u32
)paren
id|virt_to_bus
c_func
(paren
id|skb-&gt;data
)paren
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
r_else
(brace
id|printk
c_func
(paren
l_string|&quot;nicstar%d: What kind of rx buffer is this?&bslash;n&quot;
comma
id|card-&gt;index
)paren
suffix:semicolon
id|dev_kfree_skb_any
c_func
(paren
id|skb
)paren
suffix:semicolon
)brace
)brace
DECL|function|recycle_iovec_rx_bufs
r_static
r_void
id|recycle_iovec_rx_bufs
c_func
(paren
id|ns_dev
op_star
id|card
comma
r_struct
id|iovec
op_star
id|iov
comma
r_int
id|count
)paren
(brace
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
r_for
c_loop
(paren
suffix:semicolon
id|count
OG
l_int|0
suffix:semicolon
id|count
op_decrement
)paren
(brace
id|skb
op_assign
(paren
r_struct
id|sk_buff
op_star
)paren
(paren
id|iov
op_increment
)paren
op_member_access_from_pointer
id|iov_base
suffix:semicolon
r_if
c_cond
(paren
id|skb-&gt;list
op_eq
op_amp
id|card-&gt;sbpool.queue
)paren
id|push_rxbufs
c_func
(paren
id|card
comma
id|BUF_SM
comma
(paren
id|u32
)paren
id|skb
comma
(paren
id|u32
)paren
id|virt_to_bus
c_func
(paren
id|skb-&gt;data
)paren
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
id|skb-&gt;list
op_eq
op_amp
id|card-&gt;lbpool.queue
)paren
id|push_rxbufs
c_func
(paren
id|card
comma
id|BUF_LG
comma
(paren
id|u32
)paren
id|skb
comma
(paren
id|u32
)paren
id|virt_to_bus
c_func
(paren
id|skb-&gt;data
)paren
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
r_else
(brace
id|printk
c_func
(paren
l_string|&quot;nicstar%d: What kind of rx buffer is this?&bslash;n&quot;
comma
id|card-&gt;index
)paren
suffix:semicolon
id|dev_kfree_skb_any
c_func
(paren
id|skb
)paren
suffix:semicolon
)brace
)brace
)brace
DECL|function|recycle_iov_buf
r_static
r_void
id|recycle_iov_buf
c_func
(paren
id|ns_dev
op_star
id|card
comma
r_struct
id|sk_buff
op_star
id|iovb
)paren
(brace
r_if
c_cond
(paren
id|card-&gt;iovpool.count
OL
id|card-&gt;iovnr.max
)paren
(brace
id|skb_queue_tail
c_func
(paren
op_amp
id|card-&gt;iovpool.queue
comma
id|iovb
)paren
suffix:semicolon
id|card-&gt;iovpool.count
op_increment
suffix:semicolon
)brace
r_else
id|dev_kfree_skb_any
c_func
(paren
id|iovb
)paren
suffix:semicolon
)brace
DECL|function|dequeue_sm_buf
r_static
r_void
id|dequeue_sm_buf
c_func
(paren
id|ns_dev
op_star
id|card
comma
r_struct
id|sk_buff
op_star
id|sb
)paren
(brace
id|skb_unlink
c_func
(paren
id|sb
)paren
suffix:semicolon
macro_line|#ifdef NS_USE_DESTRUCTORS
r_if
c_cond
(paren
id|card-&gt;sbfqc
OL
id|card-&gt;sbnr.min
)paren
macro_line|#else
r_if
c_cond
(paren
id|card-&gt;sbfqc
OL
id|card-&gt;sbnr.init
)paren
(brace
r_struct
id|sk_buff
op_star
id|new_sb
suffix:semicolon
r_if
c_cond
(paren
(paren
id|new_sb
op_assign
id|alloc_skb
c_func
(paren
id|NS_SMSKBSIZE
comma
id|GFP_ATOMIC
)paren
)paren
op_ne
l_int|NULL
)paren
(brace
id|skb_queue_tail
c_func
(paren
op_amp
id|card-&gt;sbpool.queue
comma
id|new_sb
)paren
suffix:semicolon
id|skb_reserve
c_func
(paren
id|new_sb
comma
id|NS_AAL0_HEADER
)paren
suffix:semicolon
id|push_rxbufs
c_func
(paren
id|card
comma
id|BUF_SM
comma
(paren
id|u32
)paren
id|new_sb
comma
(paren
id|u32
)paren
id|virt_to_bus
c_func
(paren
id|new_sb-&gt;data
)paren
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|card-&gt;sbfqc
OL
id|card-&gt;sbnr.init
)paren
macro_line|#endif /* NS_USE_DESTRUCTORS */
(brace
r_struct
id|sk_buff
op_star
id|new_sb
suffix:semicolon
r_if
c_cond
(paren
(paren
id|new_sb
op_assign
id|alloc_skb
c_func
(paren
id|NS_SMSKBSIZE
comma
id|GFP_ATOMIC
)paren
)paren
op_ne
l_int|NULL
)paren
(brace
id|skb_queue_tail
c_func
(paren
op_amp
id|card-&gt;sbpool.queue
comma
id|new_sb
)paren
suffix:semicolon
id|skb_reserve
c_func
(paren
id|new_sb
comma
id|NS_AAL0_HEADER
)paren
suffix:semicolon
id|push_rxbufs
c_func
(paren
id|card
comma
id|BUF_SM
comma
(paren
id|u32
)paren
id|new_sb
comma
(paren
id|u32
)paren
id|virt_to_bus
c_func
(paren
id|new_sb-&gt;data
)paren
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
)brace
)brace
)brace
DECL|function|dequeue_lg_buf
r_static
r_void
id|dequeue_lg_buf
c_func
(paren
id|ns_dev
op_star
id|card
comma
r_struct
id|sk_buff
op_star
id|lb
)paren
(brace
id|skb_unlink
c_func
(paren
id|lb
)paren
suffix:semicolon
macro_line|#ifdef NS_USE_DESTRUCTORS
r_if
c_cond
(paren
id|card-&gt;lbfqc
OL
id|card-&gt;lbnr.min
)paren
macro_line|#else
r_if
c_cond
(paren
id|card-&gt;lbfqc
OL
id|card-&gt;lbnr.init
)paren
(brace
r_struct
id|sk_buff
op_star
id|new_lb
suffix:semicolon
r_if
c_cond
(paren
(paren
id|new_lb
op_assign
id|alloc_skb
c_func
(paren
id|NS_LGSKBSIZE
comma
id|GFP_ATOMIC
)paren
)paren
op_ne
l_int|NULL
)paren
(brace
id|skb_queue_tail
c_func
(paren
op_amp
id|card-&gt;lbpool.queue
comma
id|new_lb
)paren
suffix:semicolon
id|skb_reserve
c_func
(paren
id|new_lb
comma
id|NS_SMBUFSIZE
)paren
suffix:semicolon
id|push_rxbufs
c_func
(paren
id|card
comma
id|BUF_LG
comma
(paren
id|u32
)paren
id|new_lb
comma
(paren
id|u32
)paren
id|virt_to_bus
c_func
(paren
id|new_lb-&gt;data
)paren
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|card-&gt;lbfqc
OL
id|card-&gt;lbnr.init
)paren
macro_line|#endif /* NS_USE_DESTRUCTORS */
(brace
r_struct
id|sk_buff
op_star
id|new_lb
suffix:semicolon
r_if
c_cond
(paren
(paren
id|new_lb
op_assign
id|alloc_skb
c_func
(paren
id|NS_LGSKBSIZE
comma
id|GFP_ATOMIC
)paren
)paren
op_ne
l_int|NULL
)paren
(brace
id|skb_queue_tail
c_func
(paren
op_amp
id|card-&gt;lbpool.queue
comma
id|new_lb
)paren
suffix:semicolon
id|skb_reserve
c_func
(paren
id|new_lb
comma
id|NS_SMBUFSIZE
)paren
suffix:semicolon
id|push_rxbufs
c_func
(paren
id|card
comma
id|BUF_LG
comma
(paren
id|u32
)paren
id|new_lb
comma
(paren
id|u32
)paren
id|virt_to_bus
c_func
(paren
id|new_lb-&gt;data
)paren
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
)brace
)brace
)brace
DECL|function|ns_proc_read
r_static
r_int
id|ns_proc_read
c_func
(paren
r_struct
id|atm_dev
op_star
id|dev
comma
id|loff_t
op_star
id|pos
comma
r_char
op_star
id|page
)paren
(brace
id|u32
id|stat
suffix:semicolon
id|ns_dev
op_star
id|card
suffix:semicolon
r_int
id|left
suffix:semicolon
id|left
op_assign
(paren
r_int
)paren
op_star
id|pos
suffix:semicolon
id|card
op_assign
(paren
id|ns_dev
op_star
)paren
id|dev-&gt;dev_data
suffix:semicolon
id|stat
op_assign
id|readl
c_func
(paren
id|card-&gt;membase
op_plus
id|STAT
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|left
op_decrement
)paren
r_return
id|sprintf
c_func
(paren
id|page
comma
l_string|&quot;Pool   count    min   init    max &bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|left
op_decrement
)paren
r_return
id|sprintf
c_func
(paren
id|page
comma
l_string|&quot;Small  %5d  %5d  %5d  %5d &bslash;n&quot;
comma
id|ns_stat_sfbqc_get
c_func
(paren
id|stat
)paren
comma
id|card-&gt;sbnr.min
comma
id|card-&gt;sbnr.init
comma
id|card-&gt;sbnr.max
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|left
op_decrement
)paren
r_return
id|sprintf
c_func
(paren
id|page
comma
l_string|&quot;Large  %5d  %5d  %5d  %5d &bslash;n&quot;
comma
id|ns_stat_lfbqc_get
c_func
(paren
id|stat
)paren
comma
id|card-&gt;lbnr.min
comma
id|card-&gt;lbnr.init
comma
id|card-&gt;lbnr.max
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|left
op_decrement
)paren
r_return
id|sprintf
c_func
(paren
id|page
comma
l_string|&quot;Huge   %5d  %5d  %5d  %5d &bslash;n&quot;
comma
id|card-&gt;hbpool.count
comma
id|card-&gt;hbnr.min
comma
id|card-&gt;hbnr.init
comma
id|card-&gt;hbnr.max
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|left
op_decrement
)paren
r_return
id|sprintf
c_func
(paren
id|page
comma
l_string|&quot;Iovec  %5d  %5d  %5d  %5d &bslash;n&quot;
comma
id|card-&gt;iovpool.count
comma
id|card-&gt;iovnr.min
comma
id|card-&gt;iovnr.init
comma
id|card-&gt;iovnr.max
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|left
op_decrement
)paren
(brace
r_int
id|retval
suffix:semicolon
id|retval
op_assign
id|sprintf
c_func
(paren
id|page
comma
l_string|&quot;Interrupt counter: %u &bslash;n&quot;
comma
id|card-&gt;intcnt
)paren
suffix:semicolon
id|card-&gt;intcnt
op_assign
l_int|0
suffix:semicolon
r_return
id|retval
suffix:semicolon
)brace
macro_line|#if 0
multiline_comment|/* Dump 25.6 Mbps PHY registers */
multiline_comment|/* Now there&squot;s a 25.6 Mbps PHY driver this code isn&squot;t needed. I left it&n;      here just in case it&squot;s needed for debugging. */
r_if
c_cond
(paren
id|card-&gt;max_pcr
op_eq
id|ATM_25_PCR
op_logical_and
op_logical_neg
id|left
op_decrement
)paren
(brace
id|u32
id|phy_regs
(braket
l_int|4
)braket
suffix:semicolon
id|u32
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|4
suffix:semicolon
id|i
op_increment
)paren
(brace
r_while
c_loop
(paren
id|CMD_BUSY
c_func
(paren
id|card
)paren
)paren
suffix:semicolon
id|writel
c_func
(paren
id|NS_CMD_READ_UTILITY
op_or
l_int|0x00000200
op_or
id|i
comma
id|card-&gt;membase
op_plus
id|CMD
)paren
suffix:semicolon
r_while
c_loop
(paren
id|CMD_BUSY
c_func
(paren
id|card
)paren
)paren
suffix:semicolon
id|phy_regs
(braket
id|i
)braket
op_assign
id|readl
c_func
(paren
id|card-&gt;membase
op_plus
id|DR0
)paren
op_amp
l_int|0x000000FF
suffix:semicolon
)brace
r_return
id|sprintf
c_func
(paren
id|page
comma
l_string|&quot;PHY regs: 0x%02X 0x%02X 0x%02X 0x%02X &bslash;n&quot;
comma
id|phy_regs
(braket
l_int|0
)braket
comma
id|phy_regs
(braket
l_int|1
)braket
comma
id|phy_regs
(braket
l_int|2
)braket
comma
id|phy_regs
(braket
l_int|3
)braket
)paren
suffix:semicolon
)brace
macro_line|#endif /* 0 - Dump 25.6 Mbps PHY registers */
macro_line|#if 0
multiline_comment|/* Dump TST */
r_if
c_cond
(paren
id|left
op_decrement
OL
id|NS_TST_NUM_ENTRIES
)paren
(brace
r_if
c_cond
(paren
id|card-&gt;tste2vc
(braket
id|left
op_plus
l_int|1
)braket
op_eq
l_int|NULL
)paren
r_return
id|sprintf
c_func
(paren
id|page
comma
l_string|&quot;%5d - VBR/UBR &bslash;n&quot;
comma
id|left
op_plus
l_int|1
)paren
suffix:semicolon
r_else
r_return
id|sprintf
c_func
(paren
id|page
comma
l_string|&quot;%5d - %d %d &bslash;n&quot;
comma
id|left
op_plus
l_int|1
comma
id|card-&gt;tste2vc
(braket
id|left
op_plus
l_int|1
)braket
op_member_access_from_pointer
id|tx_vcc-&gt;vpi
comma
id|card-&gt;tste2vc
(braket
id|left
op_plus
l_int|1
)braket
op_member_access_from_pointer
id|tx_vcc-&gt;vci
)paren
suffix:semicolon
)brace
macro_line|#endif /* 0 */
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|ns_ioctl
r_static
r_int
id|ns_ioctl
c_func
(paren
r_struct
id|atm_dev
op_star
id|dev
comma
r_int
r_int
id|cmd
comma
r_void
op_star
id|arg
)paren
(brace
id|ns_dev
op_star
id|card
suffix:semicolon
id|pool_levels
id|pl
suffix:semicolon
r_int
id|btype
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|card
op_assign
id|dev-&gt;dev_data
suffix:semicolon
r_switch
c_cond
(paren
id|cmd
)paren
(brace
r_case
id|NS_GETPSTAT
suffix:colon
r_if
c_cond
(paren
id|get_user
c_func
(paren
id|pl.buftype
comma
op_amp
(paren
(paren
id|pool_levels
op_star
)paren
id|arg
)paren
op_member_access_from_pointer
id|buftype
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_switch
c_cond
(paren
id|pl.buftype
)paren
(brace
r_case
id|NS_BUFTYPE_SMALL
suffix:colon
id|pl.count
op_assign
id|ns_stat_sfbqc_get
c_func
(paren
id|readl
c_func
(paren
id|card-&gt;membase
op_plus
id|STAT
)paren
)paren
suffix:semicolon
id|pl.level.min
op_assign
id|card-&gt;sbnr.min
suffix:semicolon
id|pl.level.init
op_assign
id|card-&gt;sbnr.init
suffix:semicolon
id|pl.level.max
op_assign
id|card-&gt;sbnr.max
suffix:semicolon
r_break
suffix:semicolon
r_case
id|NS_BUFTYPE_LARGE
suffix:colon
id|pl.count
op_assign
id|ns_stat_lfbqc_get
c_func
(paren
id|readl
c_func
(paren
id|card-&gt;membase
op_plus
id|STAT
)paren
)paren
suffix:semicolon
id|pl.level.min
op_assign
id|card-&gt;lbnr.min
suffix:semicolon
id|pl.level.init
op_assign
id|card-&gt;lbnr.init
suffix:semicolon
id|pl.level.max
op_assign
id|card-&gt;lbnr.max
suffix:semicolon
r_break
suffix:semicolon
r_case
id|NS_BUFTYPE_HUGE
suffix:colon
id|pl.count
op_assign
id|card-&gt;hbpool.count
suffix:semicolon
id|pl.level.min
op_assign
id|card-&gt;hbnr.min
suffix:semicolon
id|pl.level.init
op_assign
id|card-&gt;hbnr.init
suffix:semicolon
id|pl.level.max
op_assign
id|card-&gt;hbnr.max
suffix:semicolon
r_break
suffix:semicolon
r_case
id|NS_BUFTYPE_IOVEC
suffix:colon
id|pl.count
op_assign
id|card-&gt;iovpool.count
suffix:semicolon
id|pl.level.min
op_assign
id|card-&gt;iovnr.min
suffix:semicolon
id|pl.level.init
op_assign
id|card-&gt;iovnr.init
suffix:semicolon
id|pl.level.max
op_assign
id|card-&gt;iovnr.max
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
r_return
op_minus
id|ENOIOCTLCMD
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|copy_to_user
c_func
(paren
(paren
id|pool_levels
op_star
)paren
id|arg
comma
op_amp
id|pl
comma
r_sizeof
(paren
id|pl
)paren
)paren
)paren
r_return
(paren
r_sizeof
(paren
id|pl
)paren
)paren
suffix:semicolon
r_else
r_return
op_minus
id|EFAULT
suffix:semicolon
r_case
id|NS_SETBUFLEV
suffix:colon
r_if
c_cond
(paren
op_logical_neg
id|capable
c_func
(paren
id|CAP_NET_ADMIN
)paren
)paren
r_return
op_minus
id|EPERM
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|pl
comma
(paren
id|pool_levels
op_star
)paren
id|arg
comma
r_sizeof
(paren
id|pl
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_if
c_cond
(paren
id|pl.level.min
op_ge
id|pl.level.init
op_logical_or
id|pl.level.init
op_ge
id|pl.level.max
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|pl.level.min
op_eq
l_int|0
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_switch
c_cond
(paren
id|pl.buftype
)paren
(brace
r_case
id|NS_BUFTYPE_SMALL
suffix:colon
r_if
c_cond
(paren
id|pl.level.max
OG
id|TOP_SB
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|card-&gt;sbnr.min
op_assign
id|pl.level.min
suffix:semicolon
id|card-&gt;sbnr.init
op_assign
id|pl.level.init
suffix:semicolon
id|card-&gt;sbnr.max
op_assign
id|pl.level.max
suffix:semicolon
r_break
suffix:semicolon
r_case
id|NS_BUFTYPE_LARGE
suffix:colon
r_if
c_cond
(paren
id|pl.level.max
OG
id|TOP_LB
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|card-&gt;lbnr.min
op_assign
id|pl.level.min
suffix:semicolon
id|card-&gt;lbnr.init
op_assign
id|pl.level.init
suffix:semicolon
id|card-&gt;lbnr.max
op_assign
id|pl.level.max
suffix:semicolon
r_break
suffix:semicolon
r_case
id|NS_BUFTYPE_HUGE
suffix:colon
r_if
c_cond
(paren
id|pl.level.max
OG
id|TOP_HB
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|card-&gt;hbnr.min
op_assign
id|pl.level.min
suffix:semicolon
id|card-&gt;hbnr.init
op_assign
id|pl.level.init
suffix:semicolon
id|card-&gt;hbnr.max
op_assign
id|pl.level.max
suffix:semicolon
r_break
suffix:semicolon
r_case
id|NS_BUFTYPE_IOVEC
suffix:colon
r_if
c_cond
(paren
id|pl.level.max
OG
id|TOP_IOVB
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|card-&gt;iovnr.min
op_assign
id|pl.level.min
suffix:semicolon
id|card-&gt;iovnr.init
op_assign
id|pl.level.init
suffix:semicolon
id|card-&gt;iovnr.max
op_assign
id|pl.level.max
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
r_case
id|NS_ADJBUFLEV
suffix:colon
r_if
c_cond
(paren
op_logical_neg
id|capable
c_func
(paren
id|CAP_NET_ADMIN
)paren
)paren
r_return
op_minus
id|EPERM
suffix:semicolon
id|btype
op_assign
(paren
r_int
)paren
id|arg
suffix:semicolon
multiline_comment|/* an int is the same size as a pointer */
r_switch
c_cond
(paren
id|btype
)paren
(brace
r_case
id|NS_BUFTYPE_SMALL
suffix:colon
r_while
c_loop
(paren
id|card-&gt;sbfqc
OL
id|card-&gt;sbnr.init
)paren
(brace
r_struct
id|sk_buff
op_star
id|sb
suffix:semicolon
id|sb
op_assign
id|alloc_skb
c_func
(paren
id|NS_SMSKBSIZE
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sb
op_eq
l_int|NULL
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|skb_queue_tail
c_func
(paren
op_amp
id|card-&gt;sbpool.queue
comma
id|sb
)paren
suffix:semicolon
id|skb_reserve
c_func
(paren
id|sb
comma
id|NS_AAL0_HEADER
)paren
suffix:semicolon
id|push_rxbufs
c_func
(paren
id|card
comma
id|BUF_SM
comma
(paren
id|u32
)paren
id|sb
comma
(paren
id|u32
)paren
id|virt_to_bus
c_func
(paren
id|sb-&gt;data
)paren
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|NS_BUFTYPE_LARGE
suffix:colon
r_while
c_loop
(paren
id|card-&gt;lbfqc
OL
id|card-&gt;lbnr.init
)paren
(brace
r_struct
id|sk_buff
op_star
id|lb
suffix:semicolon
id|lb
op_assign
id|alloc_skb
c_func
(paren
id|NS_LGSKBSIZE
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|lb
op_eq
l_int|NULL
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|skb_queue_tail
c_func
(paren
op_amp
id|card-&gt;lbpool.queue
comma
id|lb
)paren
suffix:semicolon
id|skb_reserve
c_func
(paren
id|lb
comma
id|NS_SMBUFSIZE
)paren
suffix:semicolon
id|push_rxbufs
c_func
(paren
id|card
comma
id|BUF_LG
comma
(paren
id|u32
)paren
id|lb
comma
(paren
id|u32
)paren
id|virt_to_bus
c_func
(paren
id|lb-&gt;data
)paren
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|NS_BUFTYPE_HUGE
suffix:colon
r_while
c_loop
(paren
id|card-&gt;hbpool.count
OG
id|card-&gt;hbnr.init
)paren
(brace
r_struct
id|sk_buff
op_star
id|hb
suffix:semicolon
id|ns_grab_int_lock
c_func
(paren
id|card
comma
id|flags
)paren
suffix:semicolon
id|hb
op_assign
id|skb_dequeue
c_func
(paren
op_amp
id|card-&gt;hbpool.queue
)paren
suffix:semicolon
id|card-&gt;hbpool.count
op_decrement
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|card-&gt;int_lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|hb
op_eq
l_int|NULL
)paren
id|printk
c_func
(paren
l_string|&quot;nicstar%d: huge buffer count inconsistent.&bslash;n&quot;
comma
id|card-&gt;index
)paren
suffix:semicolon
r_else
id|dev_kfree_skb_any
c_func
(paren
id|hb
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
id|card-&gt;hbpool.count
OL
id|card-&gt;hbnr.init
)paren
(brace
r_struct
id|sk_buff
op_star
id|hb
suffix:semicolon
id|hb
op_assign
id|alloc_skb
c_func
(paren
id|NS_HBUFSIZE
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|hb
op_eq
l_int|NULL
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|ns_grab_int_lock
c_func
(paren
id|card
comma
id|flags
)paren
suffix:semicolon
id|skb_queue_tail
c_func
(paren
op_amp
id|card-&gt;hbpool.queue
comma
id|hb
)paren
suffix:semicolon
id|card-&gt;hbpool.count
op_increment
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|card-&gt;int_lock
comma
id|flags
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|NS_BUFTYPE_IOVEC
suffix:colon
r_while
c_loop
(paren
id|card-&gt;iovpool.count
OG
id|card-&gt;iovnr.init
)paren
(brace
r_struct
id|sk_buff
op_star
id|iovb
suffix:semicolon
id|ns_grab_int_lock
c_func
(paren
id|card
comma
id|flags
)paren
suffix:semicolon
id|iovb
op_assign
id|skb_dequeue
c_func
(paren
op_amp
id|card-&gt;iovpool.queue
)paren
suffix:semicolon
id|card-&gt;iovpool.count
op_decrement
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|card-&gt;int_lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|iovb
op_eq
l_int|NULL
)paren
id|printk
c_func
(paren
l_string|&quot;nicstar%d: iovec buffer count inconsistent.&bslash;n&quot;
comma
id|card-&gt;index
)paren
suffix:semicolon
r_else
id|dev_kfree_skb_any
c_func
(paren
id|iovb
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
id|card-&gt;iovpool.count
OL
id|card-&gt;iovnr.init
)paren
(brace
r_struct
id|sk_buff
op_star
id|iovb
suffix:semicolon
id|iovb
op_assign
id|alloc_skb
c_func
(paren
id|NS_IOVBUFSIZE
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|iovb
op_eq
l_int|NULL
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|ns_grab_int_lock
c_func
(paren
id|card
comma
id|flags
)paren
suffix:semicolon
id|skb_queue_tail
c_func
(paren
op_amp
id|card-&gt;iovpool.queue
comma
id|iovb
)paren
suffix:semicolon
id|card-&gt;iovpool.count
op_increment
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|card-&gt;int_lock
comma
id|flags
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_default
suffix:colon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
r_default
suffix:colon
(brace
)brace
r_if
c_cond
(paren
id|dev-&gt;phy
op_logical_and
id|dev-&gt;phy-&gt;ioctl
)paren
(brace
r_return
id|dev-&gt;phy
op_member_access_from_pointer
id|ioctl
c_func
(paren
id|dev
comma
id|cmd
comma
id|arg
)paren
suffix:semicolon
)brace
r_else
(brace
id|printk
c_func
(paren
l_string|&quot;nicstar%d: %s == NULL &bslash;n&quot;
comma
id|card-&gt;index
comma
id|dev-&gt;phy
ques
c_cond
l_string|&quot;dev-&gt;phy-&gt;ioctl&quot;
suffix:colon
l_string|&quot;dev-&gt;phy&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENOIOCTLCMD
suffix:semicolon
)brace
)brace
)brace
DECL|function|which_list
r_static
r_void
id|which_list
c_func
(paren
id|ns_dev
op_star
id|card
comma
r_struct
id|sk_buff
op_star
id|skb
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;It&squot;s a %s buffer.&bslash;n&quot;
comma
id|skb-&gt;list
op_eq
op_amp
id|card-&gt;sbpool.queue
ques
c_cond
l_string|&quot;small&quot;
suffix:colon
id|skb-&gt;list
op_eq
op_amp
id|card-&gt;lbpool.queue
ques
c_cond
l_string|&quot;large&quot;
suffix:colon
id|skb-&gt;list
op_eq
op_amp
id|card-&gt;hbpool.queue
ques
c_cond
l_string|&quot;huge&quot;
suffix:colon
id|skb-&gt;list
op_eq
op_amp
id|card-&gt;iovpool.queue
ques
c_cond
l_string|&quot;iovec&quot;
suffix:colon
l_string|&quot;unknown&quot;
)paren
suffix:semicolon
)brace
DECL|function|ns_poll
r_static
r_void
id|ns_poll
c_func
(paren
r_int
r_int
id|arg
)paren
(brace
r_int
id|i
suffix:semicolon
id|ns_dev
op_star
id|card
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|u32
id|stat_r
comma
id|stat_w
suffix:semicolon
id|PRINTK
c_func
(paren
l_string|&quot;nicstar: Entering ns_poll().&bslash;n&quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|num_cards
suffix:semicolon
id|i
op_increment
)paren
(brace
id|card
op_assign
id|cards
(braket
id|i
)braket
suffix:semicolon
r_if
c_cond
(paren
id|spin_is_locked
c_func
(paren
op_amp
id|card-&gt;int_lock
)paren
)paren
(brace
multiline_comment|/* Probably it isn&squot;t worth spinning */
r_continue
suffix:semicolon
)brace
id|ns_grab_int_lock
c_func
(paren
id|card
comma
id|flags
)paren
suffix:semicolon
id|stat_w
op_assign
l_int|0
suffix:semicolon
id|stat_r
op_assign
id|readl
c_func
(paren
id|card-&gt;membase
op_plus
id|STAT
)paren
suffix:semicolon
r_if
c_cond
(paren
id|stat_r
op_amp
id|NS_STAT_TSIF
)paren
id|stat_w
op_or_assign
id|NS_STAT_TSIF
suffix:semicolon
r_if
c_cond
(paren
id|stat_r
op_amp
id|NS_STAT_EOPDU
)paren
id|stat_w
op_or_assign
id|NS_STAT_EOPDU
suffix:semicolon
id|process_tsq
c_func
(paren
id|card
)paren
suffix:semicolon
id|process_rsq
c_func
(paren
id|card
)paren
suffix:semicolon
id|writel
c_func
(paren
id|stat_w
comma
id|card-&gt;membase
op_plus
id|STAT
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|card-&gt;int_lock
comma
id|flags
)paren
suffix:semicolon
)brace
id|mod_timer
c_func
(paren
op_amp
id|ns_timer
comma
id|jiffies
op_plus
id|NS_POLL_PERIOD
)paren
suffix:semicolon
id|PRINTK
c_func
(paren
l_string|&quot;nicstar: Leaving ns_poll().&bslash;n&quot;
)paren
suffix:semicolon
)brace
DECL|function|ns_parse_mac
r_static
r_int
id|ns_parse_mac
c_func
(paren
r_char
op_star
id|mac
comma
r_int
r_char
op_star
id|esi
)paren
(brace
r_int
id|i
comma
id|j
suffix:semicolon
r_int
id|byte1
comma
id|byte0
suffix:semicolon
r_if
c_cond
(paren
id|mac
op_eq
l_int|NULL
op_logical_or
id|esi
op_eq
l_int|NULL
)paren
r_return
op_minus
l_int|1
suffix:semicolon
id|j
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|6
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
(paren
id|byte1
op_assign
id|ns_h2i
c_func
(paren
id|mac
(braket
id|j
op_increment
)braket
)paren
)paren
OL
l_int|0
)paren
r_return
op_minus
l_int|1
suffix:semicolon
r_if
c_cond
(paren
(paren
id|byte0
op_assign
id|ns_h2i
c_func
(paren
id|mac
(braket
id|j
op_increment
)braket
)paren
)paren
OL
l_int|0
)paren
r_return
op_minus
l_int|1
suffix:semicolon
id|esi
(braket
id|i
)braket
op_assign
(paren
r_int
r_char
)paren
(paren
id|byte1
op_star
l_int|16
op_plus
id|byte0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
OL
l_int|5
)paren
(brace
r_if
c_cond
(paren
id|mac
(braket
id|j
op_increment
)braket
op_ne
l_char|&squot;:&squot;
)paren
r_return
op_minus
l_int|1
suffix:semicolon
)brace
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|ns_h2i
r_static
r_int
id|ns_h2i
c_func
(paren
r_char
id|c
)paren
(brace
r_if
c_cond
(paren
id|c
op_ge
l_char|&squot;0&squot;
op_logical_and
id|c
op_le
l_char|&squot;9&squot;
)paren
r_return
(paren
r_int
)paren
(paren
id|c
op_minus
l_char|&squot;0&squot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|c
op_ge
l_char|&squot;A&squot;
op_logical_and
id|c
op_le
l_char|&squot;F&squot;
)paren
r_return
(paren
r_int
)paren
(paren
id|c
op_minus
l_char|&squot;A&squot;
op_plus
l_int|10
)paren
suffix:semicolon
r_if
c_cond
(paren
id|c
op_ge
l_char|&squot;a&squot;
op_logical_and
id|c
op_le
l_char|&squot;f&squot;
)paren
r_return
(paren
r_int
)paren
(paren
id|c
op_minus
l_char|&squot;a&squot;
op_plus
l_int|10
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
DECL|function|ns_phy_put
r_static
r_void
id|ns_phy_put
c_func
(paren
r_struct
id|atm_dev
op_star
id|dev
comma
r_int
r_char
id|value
comma
r_int
r_int
id|addr
)paren
(brace
id|ns_dev
op_star
id|card
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|card
op_assign
id|dev-&gt;dev_data
suffix:semicolon
id|ns_grab_res_lock
c_func
(paren
id|card
comma
id|flags
)paren
suffix:semicolon
r_while
c_loop
(paren
id|CMD_BUSY
c_func
(paren
id|card
)paren
)paren
(brace
suffix:semicolon
)brace
id|writel
c_func
(paren
(paren
r_int
r_int
)paren
id|value
comma
id|card-&gt;membase
op_plus
id|DR0
)paren
suffix:semicolon
id|writel
c_func
(paren
id|NS_CMD_WRITE_UTILITY
op_or
l_int|0x00000200
op_or
(paren
id|addr
op_amp
l_int|0x000000FF
)paren
comma
id|card-&gt;membase
op_plus
id|CMD
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|card-&gt;res_lock
comma
id|flags
)paren
suffix:semicolon
)brace
DECL|function|ns_phy_get
r_static
r_int
r_char
id|ns_phy_get
c_func
(paren
r_struct
id|atm_dev
op_star
id|dev
comma
r_int
r_int
id|addr
)paren
(brace
id|ns_dev
op_star
id|card
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_int
r_int
id|data
suffix:semicolon
id|card
op_assign
id|dev-&gt;dev_data
suffix:semicolon
id|ns_grab_res_lock
c_func
(paren
id|card
comma
id|flags
)paren
suffix:semicolon
r_while
c_loop
(paren
id|CMD_BUSY
c_func
(paren
id|card
)paren
)paren
(brace
suffix:semicolon
)brace
id|writel
c_func
(paren
id|NS_CMD_READ_UTILITY
op_or
l_int|0x00000200
op_or
(paren
id|addr
op_amp
l_int|0x000000FF
)paren
comma
id|card-&gt;membase
op_plus
id|CMD
)paren
suffix:semicolon
r_while
c_loop
(paren
id|CMD_BUSY
c_func
(paren
id|card
)paren
)paren
(brace
suffix:semicolon
)brace
id|data
op_assign
id|readl
c_func
(paren
id|card-&gt;membase
op_plus
id|DR0
)paren
op_amp
l_int|0x000000FF
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|card-&gt;res_lock
comma
id|flags
)paren
suffix:semicolon
r_return
(paren
r_int
r_char
)paren
id|data
suffix:semicolon
)brace
eof
