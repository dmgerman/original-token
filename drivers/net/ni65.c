multiline_comment|/*&n; * ni6510 (am7990 &squot;lance&squot; chip) driver for Linux-net-3 by MH&n; * Alphacode v0.51 (96/02/20) for 1.3.66 (or later)&n; *&n; * copyright (c) 1994,1995,1996 by M.Hipp&n; *&n; * This is an extension to the Linux operating system, and is covered by the&n; * same Gnu Public License that covers the Linux-kernel.&n; *&n; * comments/bugs/suggestions can be sent to:&n; *   Michael Hipp&n; *   email: Michael.Hipp@student.uni-tuebingen.de&n; *&n; * sources:&n; *   some things are from the &squot;ni6510-packet-driver for dos by Russ Nelson&squot;&n; *   and from the original drivers by D.Becker&n; *&n; * known problems:&n; *   on some PCI boards (including my own) the card/board/ISA-bridge has&n; *   problems with bus master DMA. This results in lotsa overruns.&n; *   It may help to &squot;#define RCV_PARANOIA_CHECK&squot;&n; *   or just play with your BIOS options to optimize ISA-DMA access.&n; *&n; * credits:&n; *   thanx to Jason Sullivan for sending me a ni6510 card!&n; *&n; * simple performance test:&n; *   8.1 seconds for getting a 8MB file via FTP -&gt; near 1MB/s&n; */
multiline_comment|/*&n; * 96.Feb.19: fixed a few bugs .. cleanups .. tested for 1.3.66&n; *            hopefully no more 16MB limit&n; *&n; * 95.Nov.18: multicast tweaked (AC).&n; *&n; * 94.Aug.22: changes in xmit_intr (ack more than one xmitted-packet), ni65_send_packet (p-&gt;lock) (MH)&n; *&n; * 94,July.16: fixed bugs in recv_skb and skb-alloc stuff  (MH)&n; */
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/ptrace.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/ioport.h&gt;
macro_line|#include &lt;linux/malloc.h&gt;
macro_line|#include &lt;linux/interrupt.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;asm/bitops.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/dma.h&gt;
macro_line|#include &lt;linux/netdevice.h&gt;
macro_line|#include &lt;linux/etherdevice.h&gt;
macro_line|#include &lt;linux/skbuff.h&gt;
macro_line|#include &quot;ni65.h&quot;
multiline_comment|/*&n; * the current setting allows max. perforamnce&n; * for &squot;RCV_PARANOIA_CHECK&squot; read the &squot;known problems&squot; part in &n; * the header of this file&n; */
DECL|macro|RCV_VIA_SKB
mdefine_line|#define RCV_VIA_SKB
DECL|macro|RCV_PARANOIA_CHECK
macro_line|#undef RCV_PARANOIA_CHECK
DECL|macro|XMT_VIA_SKB
mdefine_line|#define XMT_VIA_SKB
multiline_comment|/*&n; * a few card specific defines&n; */
DECL|macro|NI65_TOTAL_SIZE
mdefine_line|#define NI65_TOTAL_SIZE    16
DECL|macro|NI65_ADDR0
mdefine_line|#define NI65_ADDR0 0x02
DECL|macro|NI65_ADDR1
mdefine_line|#define NI65_ADDR1 0x07
DECL|macro|NI65_ADDR2
mdefine_line|#define NI65_ADDR2 0x01
DECL|macro|NI65_ID0
mdefine_line|#define NI65_ID0   0x00
DECL|macro|NI65_ID1
mdefine_line|#define NI65_ID1   0x55
DECL|macro|PORT
mdefine_line|#define PORT dev-&gt;base_addr
multiline_comment|/*&n; * buffer configuration&n; */
DECL|macro|RMDNUM
mdefine_line|#define RMDNUM 8
DECL|macro|RMDNUMMASK
mdefine_line|#define RMDNUMMASK 0x60000000 /* log2(RMDNUM)&lt;&lt;29 */
DECL|macro|TMDNUM
mdefine_line|#define TMDNUM 4
DECL|macro|TMDNUMMASK
mdefine_line|#define TMDNUMMASK 0x40000000 /* log2(TMDNUM)&lt;&lt;29 */
DECL|macro|R_BUF_SIZE
mdefine_line|#define R_BUF_SIZE 1536
DECL|macro|T_BUF_SIZE
mdefine_line|#define T_BUF_SIZE 1536
multiline_comment|/*&n; * lance register defines&n; */
DECL|macro|L_DATAREG
mdefine_line|#define L_DATAREG 0x00
DECL|macro|L_ADDRREG
mdefine_line|#define L_ADDRREG 0x02
DECL|macro|L_RESET
mdefine_line|#define L_RESET   0x04
DECL|macro|L_CONFIG
mdefine_line|#define L_CONFIG  0x05
DECL|macro|L_EBASE
mdefine_line|#define L_EBASE   0x08
multiline_comment|/* &n; * to access the am7990-regs, you have to write&n; * reg-number into L_ADDRREG, then you can access it using L_DATAREG&n; */
DECL|macro|CSR0
mdefine_line|#define CSR0 0x00
DECL|macro|CSR1
mdefine_line|#define CSR1 0x01
DECL|macro|CSR2
mdefine_line|#define CSR2 0x02
DECL|macro|CSR3
mdefine_line|#define CSR3 0x03
DECL|macro|writereg
mdefine_line|#define writereg(val,reg) {outw(reg,PORT+L_ADDRREG);inw(PORT+L_ADDRREG); &bslash;&n;                           outw(val,PORT+L_DATAREG);inw(PORT+L_DATAREG);}
DECL|macro|readreg
mdefine_line|#define readreg(reg) (outw(reg,PORT+L_ADDRREG),inw(PORT+L_ADDRREG),&bslash;&n;                       inw(PORT+L_DATAREG))
DECL|macro|writedatareg
mdefine_line|#define writedatareg(val) {outw(val,PORT+L_DATAREG);inw(PORT+L_DATAREG);}
r_static
r_int
id|ni65_probe1
c_func
(paren
r_struct
id|device
op_star
op_star
id|dev
comma
r_int
)paren
suffix:semicolon
r_static
r_void
id|ni65_interrupt
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
suffix:semicolon
r_static
r_void
id|ni65_recv_intr
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
r_int
)paren
suffix:semicolon
r_static
r_void
id|ni65_xmit_intr
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
r_int
)paren
suffix:semicolon
r_static
r_int
id|ni65_open
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_int
id|ni65_am7990_reinit
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_int
id|ni65_send_packet
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_int
id|ni65_close
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_struct
id|enet_statistics
op_star
id|ni65_get_stats
c_func
(paren
r_struct
id|device
op_star
)paren
suffix:semicolon
r_static
r_void
id|set_multicast_list
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
suffix:semicolon
DECL|struct|priv
r_struct
id|priv
(brace
DECL|member|rmdhead
r_struct
id|rmd
id|rmdhead
(braket
id|RMDNUM
)braket
suffix:semicolon
DECL|member|tmdhead
r_struct
id|tmd
id|tmdhead
(braket
id|TMDNUM
)braket
suffix:semicolon
DECL|member|ib
r_struct
id|init_block
id|ib
suffix:semicolon
DECL|member|rmdnum
r_int
id|rmdnum
suffix:semicolon
DECL|member|tmdnum
DECL|member|tmdlast
r_int
id|tmdnum
comma
id|tmdlast
suffix:semicolon
macro_line|#ifdef RCV_VIA_SKB
DECL|member|recv_skb
r_struct
id|sk_buff
op_star
id|recv_skb
(braket
id|RMDNUM
)braket
suffix:semicolon
macro_line|#else
DECL|member|recvbounce
r_void
op_star
id|recvbounce
(braket
id|RMDNUM
)braket
suffix:semicolon
macro_line|#endif
macro_line|#ifdef XMT_VIA_SKB
DECL|member|tmd_skb
r_struct
id|sk_buff
op_star
id|tmd_skb
(braket
id|TMDNUM
)braket
suffix:semicolon
macro_line|#endif
DECL|member|tmdbounce
r_void
op_star
id|tmdbounce
(braket
id|TMDNUM
)braket
suffix:semicolon
DECL|member|lock
DECL|member|xmit_queued
r_int
id|lock
comma
id|xmit_queued
suffix:semicolon
DECL|member|stats
r_struct
id|enet_statistics
id|stats
suffix:semicolon
)brace
suffix:semicolon
DECL|variable|irqtab
r_static
r_int
id|irqtab
(braket
)braket
op_assign
(brace
l_int|9
comma
l_int|12
comma
l_int|15
comma
l_int|5
)brace
suffix:semicolon
multiline_comment|/* irq config-translate */
DECL|variable|dmatab
r_static
r_int
id|dmatab
(braket
)braket
op_assign
(brace
l_int|0
comma
l_int|3
comma
l_int|5
comma
l_int|6
)brace
suffix:semicolon
multiline_comment|/* dma config-translate */
DECL|variable|debuglevel
r_static
r_int
id|debuglevel
op_assign
l_int|0
suffix:semicolon
multiline_comment|/*&n; * open (most done by init) &n; */
DECL|function|ni65_open
r_static
r_int
id|ni65_open
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
r_if
c_cond
(paren
id|ni65_am7990_reinit
c_func
(paren
id|dev
)paren
)paren
(brace
id|dev-&gt;tbusy
op_assign
l_int|0
suffix:semicolon
id|dev-&gt;interrupt
op_assign
l_int|0
suffix:semicolon
id|dev-&gt;start
op_assign
l_int|1
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_else
(brace
id|dev-&gt;start
op_assign
l_int|0
suffix:semicolon
r_return
op_minus
id|EAGAIN
suffix:semicolon
)brace
)brace
DECL|function|ni65_close
r_static
r_int
id|ni65_close
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
id|outw
c_func
(paren
l_int|0
comma
id|PORT
op_plus
id|L_RESET
)paren
suffix:semicolon
multiline_comment|/* that&squot;s the hard way */
id|dev-&gt;tbusy
op_assign
l_int|1
suffix:semicolon
id|dev-&gt;start
op_assign
l_int|0
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* &n; * Probe The Card (not the lance-chip) &n; * and set hardaddress&n; */
DECL|function|ni65_probe
r_int
id|ni65_probe
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
r_int
op_star
id|port
suffix:semicolon
r_static
r_int
id|ports
(braket
)braket
op_assign
(brace
l_int|0x300
comma
l_int|0x320
comma
l_int|0x340
comma
l_int|0x360
comma
l_int|0
)brace
suffix:semicolon
r_if
c_cond
(paren
id|dev
)paren
(brace
r_int
id|base_addr
op_assign
id|dev-&gt;base_addr
suffix:semicolon
r_if
c_cond
(paren
id|base_addr
OG
l_int|0x1ff
)paren
multiline_comment|/* Check a single specified location. */
r_return
id|ni65_probe1
c_func
(paren
op_amp
id|dev
comma
id|base_addr
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
id|base_addr
OG
l_int|0
)paren
multiline_comment|/* Don&squot;t probe at all. */
r_return
op_minus
id|ENXIO
suffix:semicolon
id|dev-&gt;base_addr
op_assign
id|base_addr
suffix:semicolon
)brace
r_for
c_loop
(paren
id|port
op_assign
id|ports
suffix:semicolon
op_star
id|port
suffix:semicolon
id|port
op_increment
)paren
(brace
r_int
id|ioaddr
op_assign
op_star
id|port
suffix:semicolon
r_if
c_cond
(paren
id|check_region
c_func
(paren
id|ioaddr
comma
id|NI65_TOTAL_SIZE
)paren
)paren
r_continue
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|inb
c_func
(paren
id|ioaddr
op_plus
id|L_EBASE
op_plus
l_int|6
)paren
op_eq
id|NI65_ID0
)paren
op_logical_or
op_logical_neg
(paren
id|inb
c_func
(paren
id|ioaddr
op_plus
id|L_EBASE
op_plus
l_int|7
)paren
op_eq
id|NI65_ID1
)paren
)paren
(brace
r_continue
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ni65_probe1
c_func
(paren
op_amp
id|dev
comma
id|ioaddr
)paren
op_eq
l_int|0
)paren
r_return
l_int|0
suffix:semicolon
)brace
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
DECL|function|ni65_init
r_int
id|ni65_init
c_func
(paren
r_void
)paren
(brace
id|ni65_probe
c_func
(paren
l_int|NULL
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|ni65_probe1
r_static
r_int
id|ni65_probe1
c_func
(paren
r_struct
id|device
op_star
op_star
id|dev1
comma
r_int
id|ioaddr
)paren
(brace
r_int
id|i
suffix:semicolon
r_int
r_char
op_star
id|ptr
suffix:semicolon
r_struct
id|priv
op_star
id|p
suffix:semicolon
r_struct
id|device
op_star
id|dev
op_assign
op_star
id|dev1
suffix:semicolon
r_if
c_cond
(paren
id|inb
c_func
(paren
id|ioaddr
op_plus
id|L_EBASE
op_plus
l_int|0
)paren
op_ne
id|NI65_ADDR0
op_logical_or
id|inb
c_func
(paren
id|ioaddr
op_plus
id|L_EBASE
op_plus
l_int|1
)paren
op_ne
id|NI65_ADDR1
op_logical_or
id|inb
c_func
(paren
id|ioaddr
op_plus
id|L_EBASE
op_plus
l_int|2
)paren
op_ne
id|NI65_ADDR2
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%s: wrong Hardaddress &bslash;n&quot;
comma
id|dev
ques
c_cond
id|dev-&gt;name
suffix:colon
l_string|&quot;ni6510&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|dev
)paren
(brace
id|dev
op_assign
id|init_etherdev
c_func
(paren
l_int|0
comma
l_int|0
)paren
suffix:semicolon
op_star
id|dev1
op_assign
id|dev
suffix:semicolon
)brace
id|dev-&gt;base_addr
op_assign
id|ioaddr
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|6
suffix:semicolon
id|i
op_increment
)paren
(brace
id|dev-&gt;dev_addr
(braket
id|i
)braket
op_assign
id|inb
c_func
(paren
id|PORT
op_plus
id|L_EBASE
op_plus
id|i
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|dev-&gt;irq
op_eq
l_int|0
)paren
(brace
id|dev-&gt;irq
op_assign
id|irqtab
(braket
(paren
id|inw
c_func
(paren
id|PORT
op_plus
id|L_CONFIG
)paren
op_rshift
l_int|2
)paren
op_amp
l_int|3
)braket
suffix:semicolon
)brace
r_if
c_cond
(paren
id|dev-&gt;dma
op_eq
l_int|0
)paren
(brace
id|dev-&gt;dma
op_assign
id|dmatab
(braket
id|inw
c_func
(paren
id|PORT
op_plus
id|L_CONFIG
)paren
op_amp
l_int|3
)braket
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;%s: %s found at %#3lx, IRQ %d DMA %d.&bslash;n&quot;
comma
id|dev-&gt;name
comma
l_string|&quot;ni6510&quot;
comma
id|dev-&gt;base_addr
comma
id|dev-&gt;irq
comma
id|dev-&gt;dma
)paren
suffix:semicolon
(brace
r_int
id|irqval
op_assign
id|request_irq
c_func
(paren
id|dev-&gt;irq
comma
op_amp
id|ni65_interrupt
comma
l_int|0
comma
l_string|&quot;ni6510&quot;
comma
l_int|NULL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|irqval
)paren
(brace
id|printk
(paren
l_string|&quot;%s: unable to get IRQ %d (irqval=%d).&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|dev-&gt;irq
comma
id|irqval
)paren
suffix:semicolon
r_return
op_minus
id|EAGAIN
suffix:semicolon
)brace
r_if
c_cond
(paren
id|request_dma
c_func
(paren
id|dev-&gt;dma
comma
l_string|&quot;ni6510&quot;
)paren
op_ne
l_int|0
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%s: Can&squot;t request dma-channel %d&bslash;n&quot;
comma
id|dev-&gt;name
comma
(paren
r_int
)paren
id|dev-&gt;dma
)paren
suffix:semicolon
id|free_irq
c_func
(paren
id|dev-&gt;irq
comma
l_int|NULL
)paren
suffix:semicolon
r_return
op_minus
id|EAGAIN
suffix:semicolon
)brace
)brace
id|irq2dev_map
(braket
id|dev-&gt;irq
)braket
op_assign
id|dev
suffix:semicolon
multiline_comment|/* &n;   * Grab the region so we can find another board if autoIRQ fails. &n;   */
id|request_region
c_func
(paren
id|ioaddr
comma
id|NI65_TOTAL_SIZE
comma
l_string|&quot;ni6510&quot;
)paren
suffix:semicolon
id|dev-&gt;open
op_assign
id|ni65_open
suffix:semicolon
id|dev-&gt;stop
op_assign
id|ni65_close
suffix:semicolon
id|dev-&gt;hard_start_xmit
op_assign
id|ni65_send_packet
suffix:semicolon
id|dev-&gt;get_stats
op_assign
id|ni65_get_stats
suffix:semicolon
id|dev-&gt;set_multicast_list
op_assign
id|set_multicast_list
suffix:semicolon
id|ether_setup
c_func
(paren
id|dev
)paren
suffix:semicolon
id|dev-&gt;interrupt
op_assign
l_int|0
suffix:semicolon
id|dev-&gt;tbusy
op_assign
l_int|0
suffix:semicolon
id|dev-&gt;start
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* &n;   * we need 8-aligned memory ..&n;   */
id|ptr
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|priv
)paren
op_plus
l_int|8
comma
id|GFP_KERNEL
op_or
id|GFP_DMA
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ptr
)paren
(brace
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|ptr
op_assign
(paren
r_int
r_char
op_star
)paren
(paren
(paren
(paren
r_int
r_int
)paren
id|ptr
op_plus
l_int|7
)paren
op_amp
op_complement
l_int|0x7
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
r_int
r_int
)paren
id|ptr
op_plus
r_sizeof
(paren
r_struct
id|priv
)paren
OG
l_int|0x1000000
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%s: Can&squot;t alloc buffer in lower 16MB!&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_return
op_minus
id|EAGAIN
suffix:semicolon
)brace
id|p
op_assign
id|dev-&gt;priv
op_assign
(paren
r_struct
id|priv
op_star
)paren
id|ptr
suffix:semicolon
id|memset
c_func
(paren
(paren
r_char
op_star
)paren
id|dev-&gt;priv
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|priv
)paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|TMDNUM
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
(paren
id|ptr
op_assign
id|kmalloc
c_func
(paren
id|T_BUF_SIZE
comma
id|GFP_KERNEL
op_or
id|GFP_DMA
)paren
)paren
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%s: Can&squot;t alloc Xmit-Mem.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
r_int
r_int
)paren
(paren
id|ptr
op_plus
id|T_BUF_SIZE
)paren
OG
l_int|0x1000000
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%s: Can&squot;t alloc Xmit-Mem in lower 16MB!&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_return
op_minus
id|EAGAIN
suffix:semicolon
)brace
id|p-&gt;tmdbounce
(braket
id|i
)braket
op_assign
id|ptr
suffix:semicolon
macro_line|#ifdef XMT_VIA_SKB
id|p-&gt;tmd_skb
(braket
id|i
)braket
op_assign
l_int|NULL
suffix:semicolon
macro_line|#endif
)brace
macro_line|#ifdef RCV_VIA_SKB
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|RMDNUM
suffix:semicolon
id|i
op_increment
)paren
(brace
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|skb
op_assign
id|dev_alloc_skb
c_func
(paren
id|R_BUF_SIZE
op_plus
l_int|2
)paren
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%s: unable to alloc recv-mem&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|skb-&gt;dev
op_assign
id|dev
suffix:semicolon
id|skb_reserve
c_func
(paren
id|skb
comma
l_int|2
)paren
suffix:semicolon
id|skb_put
c_func
(paren
id|skb
comma
id|R_BUF_SIZE
)paren
suffix:semicolon
multiline_comment|/* grab the whole space .. (not necessary) */
r_if
c_cond
(paren
(paren
r_int
r_int
)paren
(paren
id|skb-&gt;data
op_plus
id|R_BUF_SIZE
)paren
OG
l_int|0x1000000
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%s: unable to alloc receive-memory in lower 16MB!&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_return
op_minus
id|EAGAIN
suffix:semicolon
)brace
id|p-&gt;recv_skb
(braket
id|i
)braket
op_assign
id|skb
suffix:semicolon
)brace
macro_line|#else
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|RMDNUM
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|p-&gt;recvbounce
(braket
id|i
)braket
op_assign
id|kmalloc
c_func
(paren
id|R_BUF_SIZE
comma
id|GFP_KERNEL
op_or
id|GFP_DMA
)paren
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%s: unable to alloc recv-mem&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
r_int
r_int
)paren
id|p-&gt;recvbounce
(braket
id|i
)braket
op_plus
id|R_BUF_SIZE
OG
l_int|0x1000000
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%s: unable to alloc receive-memory in lower 16MB!&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_return
op_minus
id|EAGAIN
suffix:semicolon
)brace
)brace
macro_line|#endif
r_return
l_int|0
suffix:semicolon
multiline_comment|/* we&squot;ve found everything */
)brace
multiline_comment|/* &n; * init lance (write init-values .. init-buffers) (open-helper)&n; */
DECL|function|ni65_am7990_reinit
r_static
r_int
id|ni65_am7990_reinit
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
r_int
id|i
suffix:semicolon
r_struct
id|priv
op_star
id|p
op_assign
(paren
r_struct
id|priv
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|p-&gt;lock
op_assign
l_int|0
suffix:semicolon
id|p-&gt;xmit_queued
op_assign
l_int|0
suffix:semicolon
id|disable_dma
c_func
(paren
id|dev-&gt;dma
)paren
suffix:semicolon
multiline_comment|/* I&squot;ve never worked with dma, but we do it like the packetdriver */
id|set_dma_mode
c_func
(paren
id|dev-&gt;dma
comma
id|DMA_MODE_CASCADE
)paren
suffix:semicolon
id|enable_dma
c_func
(paren
id|dev-&gt;dma
)paren
suffix:semicolon
id|outw
c_func
(paren
l_int|0
comma
id|PORT
op_plus
id|L_RESET
)paren
suffix:semicolon
multiline_comment|/* first: reset the card */
r_if
c_cond
(paren
id|inw
c_func
(paren
id|PORT
op_plus
id|L_DATAREG
)paren
op_ne
l_int|0x4
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: can&squot;t RESET ni6510 card: %04x&bslash;n&quot;
comma
id|dev-&gt;name
comma
(paren
r_int
)paren
id|inw
c_func
(paren
id|PORT
op_plus
id|L_DATAREG
)paren
)paren
suffix:semicolon
id|disable_dma
c_func
(paren
id|dev-&gt;dma
)paren
suffix:semicolon
id|free_dma
c_func
(paren
id|dev-&gt;dma
)paren
suffix:semicolon
id|free_irq
c_func
(paren
id|dev-&gt;irq
comma
l_int|NULL
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|p-&gt;tmdnum
op_assign
l_int|0
suffix:semicolon
id|p-&gt;tmdlast
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|TMDNUM
suffix:semicolon
id|i
op_increment
)paren
(brace
r_struct
id|tmd
op_star
id|tmdp
op_assign
id|p-&gt;tmdhead
op_plus
id|i
suffix:semicolon
macro_line|#ifdef XMT_VIA_SKB
r_if
c_cond
(paren
id|p-&gt;tmd_skb
(braket
id|i
)braket
)paren
(brace
id|dev_kfree_skb
c_func
(paren
id|p-&gt;tmd_skb
(braket
id|i
)braket
comma
id|FREE_WRITE
)paren
suffix:semicolon
id|p-&gt;tmd_skb
(braket
id|i
)braket
op_assign
l_int|NULL
suffix:semicolon
)brace
macro_line|#endif
id|tmdp-&gt;u.buffer
op_assign
l_int|0x0
suffix:semicolon
id|tmdp-&gt;u.s.status
op_assign
id|XMIT_START
op_or
id|XMIT_END
suffix:semicolon
id|tmdp-&gt;blen
op_assign
id|tmdp-&gt;status2
op_assign
l_int|0
suffix:semicolon
)brace
id|p-&gt;rmdnum
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|RMDNUM
suffix:semicolon
id|i
op_increment
)paren
(brace
r_struct
id|rmd
op_star
id|rmdp
op_assign
id|p-&gt;rmdhead
op_plus
id|i
suffix:semicolon
macro_line|#ifdef RCV_VIA_SKB
id|rmdp-&gt;u.buffer
op_assign
(paren
r_int
r_int
)paren
id|p-&gt;recv_skb
(braket
id|i
)braket
op_member_access_from_pointer
id|data
suffix:semicolon
macro_line|#else
id|rmdp-&gt;u.buffer
op_assign
(paren
r_int
r_int
)paren
id|p-&gt;recvbounce
(braket
id|i
)braket
suffix:semicolon
macro_line|#endif
id|rmdp-&gt;blen
op_assign
op_minus
(paren
id|R_BUF_SIZE
op_minus
l_int|8
)paren
suffix:semicolon
id|rmdp-&gt;mlen
op_assign
l_int|0
suffix:semicolon
id|rmdp-&gt;u.s.status
op_assign
id|RCV_OWN
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|6
suffix:semicolon
id|i
op_increment
)paren
(brace
id|p-&gt;ib.eaddr
(braket
id|i
)braket
op_assign
id|dev-&gt;dev_addr
(braket
id|i
)braket
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|8
suffix:semicolon
id|i
op_increment
)paren
(brace
id|p-&gt;ib.filter
(braket
id|i
)braket
op_assign
l_int|0x0
suffix:semicolon
)brace
id|p-&gt;ib.mode
op_assign
l_int|0x0
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;flags
op_amp
id|IFF_PROMISC
)paren
(brace
id|p-&gt;ib.mode
op_assign
id|M_PROM
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|dev-&gt;mc_count
op_logical_or
id|dev-&gt;flags
op_amp
id|IFF_ALLMULTI
)paren
(brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|8
suffix:semicolon
id|i
op_increment
)paren
(brace
id|p-&gt;ib.filter
(braket
id|i
)braket
op_assign
l_int|0xff
suffix:semicolon
)brace
)brace
id|p-&gt;ib.trp
op_assign
(paren
r_int
r_int
)paren
id|p-&gt;tmdhead
op_or
id|TMDNUMMASK
suffix:semicolon
id|p-&gt;ib.rrp
op_assign
(paren
r_int
r_int
)paren
id|p-&gt;rmdhead
op_or
id|RMDNUMMASK
suffix:semicolon
id|writereg
c_func
(paren
l_int|0
comma
id|CSR3
)paren
suffix:semicolon
multiline_comment|/* busmaster/no word-swap */
id|writereg
c_func
(paren
(paren
r_int
r_int
)paren
(paren
(paren
(paren
r_int
r_int
)paren
op_amp
(paren
id|p-&gt;ib
)paren
)paren
op_amp
l_int|0xffff
)paren
comma
id|CSR1
)paren
suffix:semicolon
id|writereg
c_func
(paren
(paren
r_int
r_int
)paren
(paren
(paren
(paren
r_int
r_int
)paren
op_amp
(paren
id|p-&gt;ib
)paren
)paren
op_rshift
l_int|16
)paren
comma
id|CSR2
)paren
suffix:semicolon
id|writereg
c_func
(paren
id|CSR0_INIT
comma
id|CSR0
)paren
suffix:semicolon
multiline_comment|/* this changes L_ADDRREG to CSR0 */
multiline_comment|/*&n;   * NOW, WE WILL NEVER CHANGE THE L_ADDRREG, CSR0 IS ALWAYS SELECTED &n;   */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|32
suffix:semicolon
id|i
op_increment
)paren
(brace
id|__delay
c_func
(paren
(paren
id|loops_per_sec
op_rshift
l_int|8
)paren
)paren
suffix:semicolon
multiline_comment|/* wait a while */
r_if
c_cond
(paren
id|inw
c_func
(paren
id|PORT
op_plus
id|L_DATAREG
)paren
op_amp
id|CSR0_IDON
)paren
(brace
r_break
suffix:semicolon
)brace
multiline_comment|/* init ok ? */
)brace
r_if
c_cond
(paren
id|i
op_eq
l_int|32
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: can&squot;t init am7990/lance, status: %04x&bslash;n&quot;
comma
id|dev-&gt;name
comma
(paren
r_int
)paren
id|inw
c_func
(paren
id|PORT
op_plus
id|L_DATAREG
)paren
)paren
suffix:semicolon
id|disable_dma
c_func
(paren
id|dev-&gt;dma
)paren
suffix:semicolon
id|free_dma
c_func
(paren
id|dev-&gt;dma
)paren
suffix:semicolon
id|free_irq
c_func
(paren
id|dev-&gt;irq
comma
l_int|NULL
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
multiline_comment|/* false */
)brace
id|writedatareg
c_func
(paren
id|CSR0_CLRALL
op_or
id|CSR0_INEA
op_or
id|CSR0_STRT
)paren
suffix:semicolon
multiline_comment|/* start lance , enable interrupts */
r_return
l_int|1
suffix:semicolon
multiline_comment|/* OK */
)brace
multiline_comment|/* &n; * interrupt handler  &n; */
DECL|function|ni65_interrupt
r_static
r_void
id|ni65_interrupt
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_int
id|csr0
suffix:semicolon
r_struct
id|device
op_star
id|dev
op_assign
(paren
r_struct
id|device
op_star
)paren
id|irq2dev_map
(braket
id|irq
)braket
suffix:semicolon
r_int
id|bcnt
op_assign
l_int|32
suffix:semicolon
r_if
c_cond
(paren
id|dev
op_eq
l_int|NULL
)paren
(brace
id|printk
(paren
id|KERN_ERR
l_string|&quot;ni65_interrupt(): irq %d for unknown device.&bslash;n&quot;
comma
id|irq
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|dev-&gt;interrupt
op_assign
l_int|1
suffix:semicolon
r_while
c_loop
(paren
op_decrement
id|bcnt
)paren
(brace
id|csr0
op_assign
id|inw
c_func
(paren
id|PORT
op_plus
id|L_DATAREG
)paren
suffix:semicolon
id|writedatareg
c_func
(paren
id|csr0
op_amp
id|CSR0_CLRALL
)paren
suffix:semicolon
multiline_comment|/* ack interrupts, disable int. */
r_if
c_cond
(paren
op_logical_neg
(paren
id|csr0
op_amp
(paren
id|CSR0_ERR
op_or
id|CSR0_RINT
op_or
id|CSR0_TINT
)paren
)paren
)paren
(brace
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|csr0
op_amp
id|CSR0_ERR
)paren
(brace
r_struct
id|priv
op_star
id|p
op_assign
(paren
r_struct
id|priv
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_if
c_cond
(paren
id|csr0
op_amp
id|CSR0_BABL
)paren
(brace
id|p-&gt;stats.tx_errors
op_increment
suffix:semicolon
)brace
r_if
c_cond
(paren
id|csr0
op_amp
id|CSR0_MISS
)paren
(brace
id|p-&gt;stats.rx_errors
op_increment
suffix:semicolon
)brace
r_if
c_cond
(paren
id|csr0
op_amp
id|CSR0_MERR
)paren
(brace
id|writedatareg
c_func
(paren
id|CSR0_STOP
)paren
suffix:semicolon
id|writedatareg
c_func
(paren
id|CSR0_STRT
)paren
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|csr0
op_amp
id|CSR0_RINT
)paren
(brace
multiline_comment|/* RECV-int? */
id|ni65_recv_intr
c_func
(paren
id|dev
comma
id|csr0
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|csr0
op_amp
id|CSR0_TINT
)paren
(brace
multiline_comment|/* XMIT-int? */
id|ni65_xmit_intr
c_func
(paren
id|dev
comma
id|csr0
)paren
suffix:semicolon
)brace
)brace
macro_line|#ifdef RCV_PARANOIA_CHECK
(brace
r_struct
id|priv
op_star
id|p
op_assign
(paren
r_struct
id|priv
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_int
id|i
comma
id|f
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|RMDNUM
suffix:semicolon
id|i
op_increment
)paren
(brace
r_struct
id|rmd
op_star
id|rmdp
op_assign
id|p-&gt;rmdhead
op_plus
(paren
(paren
id|p-&gt;rmdnum
op_minus
id|i
op_minus
l_int|1
)paren
op_amp
(paren
id|RMDNUM
op_minus
l_int|1
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|rmdp-&gt;u.s.status
op_amp
id|RCV_OWN
)paren
)paren
(brace
id|f
op_assign
l_int|1
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|f
)paren
(brace
r_break
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|i
OL
id|RMDNUM
)paren
(brace
id|p-&gt;rmdnum
op_assign
(paren
id|p-&gt;rmdnum
op_plus
l_int|8
op_minus
id|i
)paren
op_amp
(paren
id|RMDNUM
op_minus
l_int|1
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: Ooops, receive ring currupted&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|ni65_recv_intr
c_func
(paren
id|dev
comma
id|csr0
)paren
suffix:semicolon
)brace
)brace
macro_line|#endif
r_if
c_cond
(paren
id|csr0
op_amp
(paren
id|CSR0_RXON
op_or
id|CSR0_TXON
)paren
op_ne
(paren
id|CSR0_RXON
op_or
id|CSR0_TXON
)paren
)paren
(brace
id|writedatareg
c_func
(paren
id|CSR0_STOP
)paren
suffix:semicolon
id|writedatareg
c_func
(paren
id|CSR0_STRT
op_or
id|CSR0_INEA
)paren
suffix:semicolon
)brace
r_else
id|writedatareg
c_func
(paren
id|CSR0_INEA
)paren
suffix:semicolon
id|dev-&gt;interrupt
op_assign
l_int|0
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/*&n; * We have received an Xmit-Interrupt ..&n; * send a new packet if necessary&n; */
DECL|function|ni65_xmit_intr
r_static
r_void
id|ni65_xmit_intr
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
r_int
id|csr0
)paren
(brace
r_struct
id|priv
op_star
id|p
op_assign
(paren
r_struct
id|priv
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_while
c_loop
(paren
id|p-&gt;xmit_queued
)paren
(brace
r_struct
id|tmd
op_star
id|tmdp
op_assign
id|p-&gt;tmdhead
op_plus
id|p-&gt;tmdlast
suffix:semicolon
r_int
id|tmdstat
op_assign
id|tmdp-&gt;u.s.status
suffix:semicolon
r_if
c_cond
(paren
id|tmdstat
op_amp
id|XMIT_OWN
)paren
(brace
r_break
suffix:semicolon
)brace
macro_line|#ifdef XMT_VIA_SKB
r_if
c_cond
(paren
id|p-&gt;tmd_skb
(braket
id|p-&gt;tmdlast
)braket
)paren
(brace
id|dev_kfree_skb
c_func
(paren
id|p-&gt;tmd_skb
(braket
id|p-&gt;tmdlast
)braket
comma
id|FREE_WRITE
)paren
suffix:semicolon
id|p-&gt;tmd_skb
(braket
id|p-&gt;tmdlast
)braket
op_assign
l_int|NULL
suffix:semicolon
)brace
macro_line|#endif
r_if
c_cond
(paren
id|tmdstat
op_amp
id|XMIT_ERR
)paren
(brace
macro_line|#if 0
r_if
c_cond
(paren
id|tmdp-&gt;status2
op_amp
id|XMIT_TDRMASK
op_logical_and
id|debuglevel
OG
l_int|3
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: tdr-problems (e.g. no resistor)&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
)brace
macro_line|#endif
multiline_comment|/* checking some errors */
r_if
c_cond
(paren
id|tmdp-&gt;status2
op_amp
id|XMIT_RTRY
)paren
(brace
id|p-&gt;stats.tx_aborted_errors
op_increment
suffix:semicolon
)brace
r_if
c_cond
(paren
id|tmdp-&gt;status2
op_amp
id|XMIT_LCAR
)paren
(brace
id|p-&gt;stats.tx_carrier_errors
op_increment
suffix:semicolon
)brace
r_if
c_cond
(paren
id|tmdp-&gt;status2
op_amp
(paren
id|XMIT_BUFF
op_or
id|XMIT_UFLO
)paren
)paren
(brace
id|p-&gt;stats.tx_fifo_errors
op_increment
suffix:semicolon
id|writedatareg
c_func
(paren
id|CSR0_STOP
)paren
suffix:semicolon
id|writedatareg
c_func
(paren
id|CSR0_STRT
)paren
suffix:semicolon
r_if
c_cond
(paren
id|debuglevel
OG
l_int|1
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: Xmit FIFO/BUFF error&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|debuglevel
OG
l_int|2
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: xmit-error: %04x %02x-%04x&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|csr0
comma
(paren
r_int
)paren
id|tmdstat
comma
(paren
r_int
)paren
id|tmdp-&gt;status2
)paren
suffix:semicolon
)brace
id|p-&gt;stats.tx_errors
op_increment
suffix:semicolon
id|tmdp-&gt;status2
op_assign
l_int|0
suffix:semicolon
)brace
r_else
id|p-&gt;stats.tx_packets
op_increment
suffix:semicolon
id|p-&gt;tmdlast
op_assign
(paren
id|p-&gt;tmdlast
op_plus
l_int|1
)paren
op_amp
(paren
id|TMDNUM
op_minus
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|p-&gt;tmdlast
op_eq
id|p-&gt;tmdnum
)paren
(brace
id|p-&gt;xmit_queued
op_assign
l_int|0
suffix:semicolon
)brace
)brace
id|dev-&gt;tbusy
op_assign
l_int|0
suffix:semicolon
id|mark_bh
c_func
(paren
id|NET_BH
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * We have received a packet&n; */
DECL|function|ni65_recv_intr
r_static
r_void
id|ni65_recv_intr
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
r_int
id|csr0
)paren
(brace
r_struct
id|rmd
op_star
id|rmdp
suffix:semicolon
r_int
id|rmdstat
comma
id|len
suffix:semicolon
r_struct
id|priv
op_star
id|p
op_assign
(paren
r_struct
id|priv
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|rmdp
op_assign
id|p-&gt;rmdhead
op_plus
id|p-&gt;rmdnum
suffix:semicolon
r_while
c_loop
(paren
op_logical_neg
(paren
(paren
id|rmdstat
op_assign
id|rmdp-&gt;u.s.status
)paren
op_amp
id|RCV_OWN
)paren
)paren
(brace
r_if
c_cond
(paren
(paren
id|rmdstat
op_amp
(paren
id|RCV_START
op_or
id|RCV_END
op_or
id|RCV_ERR
)paren
)paren
op_ne
(paren
id|RCV_START
op_or
id|RCV_END
)paren
)paren
multiline_comment|/* error or oversized? */
(brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|rmdstat
op_amp
id|RCV_ERR
)paren
)paren
(brace
r_if
c_cond
(paren
id|rmdstat
op_amp
id|RCV_START
)paren
(brace
id|p-&gt;stats.rx_length_errors
op_increment
suffix:semicolon
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: recv, packet too long: %d&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|rmdp-&gt;mlen
op_amp
l_int|0x0fff
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: receive-error: %04x, lance-status: %04x/%04x&bslash;n&quot;
comma
id|dev-&gt;name
comma
(paren
r_int
)paren
id|rmdstat
comma
id|csr0
comma
(paren
r_int
)paren
id|inw
c_func
(paren
id|PORT
op_plus
id|L_DATAREG
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rmdstat
op_amp
id|RCV_FRAM
)paren
(brace
id|p-&gt;stats.rx_frame_errors
op_increment
suffix:semicolon
)brace
r_if
c_cond
(paren
id|rmdstat
op_amp
id|RCV_OFLO
)paren
(brace
id|p-&gt;stats.rx_over_errors
op_increment
suffix:semicolon
)brace
r_if
c_cond
(paren
id|rmdstat
op_amp
(paren
id|RCV_OFLO
op_or
id|RCV_BUF_ERR
)paren
)paren
(brace
id|writedatareg
c_func
(paren
id|CSR0_STOP
)paren
suffix:semicolon
id|writedatareg
c_func
(paren
id|CSR0_STRT
)paren
suffix:semicolon
r_if
c_cond
(paren
id|debuglevel
OG
l_int|1
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: Rcv FIFO/BUFF error.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|rmdstat
op_amp
id|RCV_CRC
)paren
(brace
id|p-&gt;stats.rx_crc_errors
op_increment
suffix:semicolon
)brace
)brace
id|rmdp-&gt;u.s.status
op_assign
id|RCV_OWN
suffix:semicolon
multiline_comment|/* change owner */
id|p-&gt;stats.rx_errors
op_increment
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
(paren
id|len
op_assign
(paren
id|rmdp-&gt;mlen
op_amp
l_int|0x0fff
)paren
op_minus
l_int|4
)paren
op_ge
l_int|60
)paren
(brace
macro_line|#ifdef RCV_VIA_SKB
r_struct
id|sk_buff
op_star
id|skb
op_assign
id|dev_alloc_skb
c_func
(paren
id|R_BUF_SIZE
op_plus
l_int|2
)paren
suffix:semicolon
macro_line|#else
r_struct
id|sk_buff
op_star
id|skb
op_assign
id|dev_alloc_skb
c_func
(paren
id|len
op_plus
l_int|2
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|skb
)paren
(brace
id|skb_reserve
c_func
(paren
id|skb
comma
l_int|2
)paren
suffix:semicolon
id|skb-&gt;dev
op_assign
id|dev
suffix:semicolon
macro_line|#ifdef RCV_VIA_SKB
r_if
c_cond
(paren
(paren
r_int
r_int
)paren
(paren
id|skb-&gt;data
op_plus
id|R_BUF_SIZE
)paren
OG
l_int|0x1000000
)paren
(brace
id|skb_put
c_func
(paren
id|skb
comma
id|len
)paren
suffix:semicolon
id|eth_copy_and_sum
c_func
(paren
id|skb
comma
(paren
r_int
r_char
op_star
)paren
(paren
id|p-&gt;recv_skb
(braket
id|p-&gt;rmdnum
)braket
op_member_access_from_pointer
id|data
)paren
comma
id|len
comma
l_int|0
)paren
suffix:semicolon
)brace
r_else
(brace
r_struct
id|sk_buff
op_star
id|skb1
op_assign
id|p-&gt;recv_skb
(braket
id|p-&gt;rmdnum
)braket
suffix:semicolon
id|skb_put
c_func
(paren
id|skb
comma
id|R_BUF_SIZE
)paren
suffix:semicolon
id|p-&gt;recv_skb
(braket
id|p-&gt;rmdnum
)braket
op_assign
id|skb
suffix:semicolon
id|rmdp-&gt;u.buffer
op_assign
(paren
r_int
r_int
)paren
id|skb-&gt;data
suffix:semicolon
id|skb
op_assign
id|skb1
suffix:semicolon
id|skb_trim
c_func
(paren
id|skb
comma
id|len
)paren
suffix:semicolon
)brace
macro_line|#else
id|skb_put
c_func
(paren
id|skb
comma
id|len
)paren
suffix:semicolon
id|eth_copy_and_sum
c_func
(paren
id|skb
comma
(paren
r_int
r_char
op_star
)paren
id|p-&gt;recvbounce
(braket
id|p-&gt;rmdnum
)braket
comma
id|len
comma
l_int|0
)paren
suffix:semicolon
macro_line|#endif
id|rmdp-&gt;u.s.status
op_assign
id|RCV_OWN
suffix:semicolon
id|p-&gt;stats.rx_packets
op_increment
suffix:semicolon
id|skb-&gt;protocol
op_assign
id|eth_type_trans
c_func
(paren
id|skb
comma
id|dev
)paren
suffix:semicolon
id|netif_rx
c_func
(paren
id|skb
)paren
suffix:semicolon
)brace
r_else
(brace
id|rmdp-&gt;u.s.status
op_assign
id|RCV_OWN
suffix:semicolon
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: can&squot;t alloc new sk_buff&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|p-&gt;stats.rx_dropped
op_increment
suffix:semicolon
)brace
)brace
r_else
(brace
id|rmdp-&gt;u.s.status
op_assign
id|RCV_OWN
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: received runt packet&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|p-&gt;stats.rx_errors
op_increment
suffix:semicolon
)brace
id|p-&gt;rmdnum
op_assign
(paren
id|p-&gt;rmdnum
op_plus
l_int|1
)paren
op_amp
(paren
id|RMDNUM
op_minus
l_int|1
)paren
suffix:semicolon
id|rmdp
op_assign
id|p-&gt;rmdhead
op_plus
id|p-&gt;rmdnum
suffix:semicolon
)brace
)brace
multiline_comment|/*&n; * kick xmitter ..&n; */
DECL|function|ni65_send_packet
r_static
r_int
id|ni65_send_packet
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|device
op_star
id|dev
)paren
(brace
r_struct
id|priv
op_star
id|p
op_assign
(paren
r_struct
id|priv
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;tbusy
)paren
(brace
r_int
id|tickssofar
op_assign
id|jiffies
op_minus
id|dev-&gt;trans_start
suffix:semicolon
r_if
c_cond
(paren
id|tickssofar
OL
l_int|5
)paren
r_return
l_int|1
suffix:semicolon
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: xmitter timed out, try to restart!&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|ni65_am7990_reinit
c_func
(paren
id|dev
)paren
suffix:semicolon
id|dev-&gt;tbusy
op_assign
l_int|0
suffix:semicolon
id|dev-&gt;trans_start
op_assign
id|jiffies
suffix:semicolon
)brace
r_if
c_cond
(paren
id|skb
op_eq
l_int|NULL
)paren
(brace
id|dev_tint
c_func
(paren
id|dev
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|skb-&gt;len
op_le
l_int|0
)paren
r_return
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|set_bit
c_func
(paren
l_int|0
comma
(paren
r_void
op_star
)paren
op_amp
id|dev-&gt;tbusy
)paren
op_ne
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: Transmitter access conflict.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|set_bit
c_func
(paren
l_int|0
comma
(paren
r_void
op_star
)paren
op_amp
id|p-&gt;lock
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: Queue was locked.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
(brace
r_int
id|len
op_assign
id|ETH_ZLEN
OL
id|skb-&gt;len
ques
c_cond
id|skb-&gt;len
suffix:colon
id|ETH_ZLEN
suffix:semicolon
r_struct
id|tmd
op_star
id|tmdp
op_assign
id|p-&gt;tmdhead
op_plus
id|p-&gt;tmdnum
suffix:semicolon
r_int
id|flags
suffix:semicolon
macro_line|#ifdef XMT_VIA_SKB
r_if
c_cond
(paren
(paren
r_int
r_int
)paren
(paren
id|skb-&gt;data
op_plus
id|skb-&gt;len
)paren
OG
l_int|0x1000000
)paren
(brace
macro_line|#endif
id|tmdp-&gt;u.buffer
op_assign
(paren
r_int
r_int
)paren
id|p-&gt;tmdbounce
(braket
id|p-&gt;tmdnum
)braket
suffix:semicolon
id|memcpy
c_func
(paren
(paren
r_char
op_star
)paren
id|tmdp-&gt;u.buffer
comma
(paren
r_char
op_star
)paren
id|skb-&gt;data
comma
(paren
id|skb-&gt;len
OG
id|T_BUF_SIZE
)paren
ques
c_cond
id|T_BUF_SIZE
suffix:colon
id|skb-&gt;len
)paren
suffix:semicolon
id|dev_kfree_skb
(paren
id|skb
comma
id|FREE_WRITE
)paren
suffix:semicolon
macro_line|#ifdef XMT_VIA_SKB
)brace
r_else
(brace
id|tmdp-&gt;u.buffer
op_assign
(paren
r_int
r_int
)paren
id|skb-&gt;data
suffix:semicolon
id|p-&gt;tmd_skb
(braket
id|p-&gt;tmdnum
)braket
op_assign
id|skb
suffix:semicolon
)brace
macro_line|#endif
id|tmdp-&gt;blen
op_assign
op_minus
id|len
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|tmdp-&gt;u.s.status
op_assign
id|XMIT_OWN
op_or
id|XMIT_START
op_or
id|XMIT_END
suffix:semicolon
id|writedatareg
c_func
(paren
id|CSR0_TDMD
op_or
id|CSR0_INEA
)paren
suffix:semicolon
multiline_comment|/* enable xmit &amp; interrupt */
id|p-&gt;xmit_queued
op_assign
l_int|1
suffix:semicolon
id|p-&gt;tmdnum
op_assign
(paren
id|p-&gt;tmdnum
op_plus
l_int|1
)paren
op_amp
(paren
id|TMDNUM
op_minus
l_int|1
)paren
suffix:semicolon
id|dev-&gt;tbusy
op_assign
(paren
id|p-&gt;tmdnum
op_eq
id|p-&gt;tmdlast
)paren
ques
c_cond
l_int|1
suffix:colon
l_int|0
suffix:semicolon
id|p-&gt;lock
op_assign
l_int|0
suffix:semicolon
id|dev-&gt;trans_start
op_assign
id|jiffies
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|ni65_get_stats
r_static
r_struct
id|enet_statistics
op_star
id|ni65_get_stats
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
r_return
op_amp
(paren
(paren
r_struct
id|priv
op_star
)paren
id|dev-&gt;priv
)paren
op_member_access_from_pointer
id|stats
suffix:semicolon
)brace
DECL|function|set_multicast_list
r_static
r_void
id|set_multicast_list
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|ni65_am7990_reinit
c_func
(paren
id|dev
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: Can&squot;t switch card into MC mode!&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
)brace
id|dev-&gt;tbusy
op_assign
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * END of ni65.c &n; */
eof
