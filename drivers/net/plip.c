multiline_comment|/* $Id: plip.c,v 1.15 1995/10/03 01:47:09 gniibe Exp $ */
multiline_comment|/* PLIP: A parallel port &quot;network&quot; driver for Linux. */
multiline_comment|/* This driver is for parallel port with 5-bit cable (LapLink (R) cable). */
multiline_comment|/*&n; * Authors:&t;Donald Becker,  &lt;becker@super.org&gt;&n; *&t;&t;Tommy Thorn, &lt;thorn@daimi.aau.dk&gt;&n; *&t;&t;Tanabe Hiroyasu, &lt;hiro@sanpo.t.u-tokyo.ac.jp&gt;&n; *&t;&t;Alan Cox, &lt;gw4pts@gw4pts.ampr.org&gt;&n; *&t;&t;Peter Bauer, &lt;100136.3530@compuserve.com&gt;&n; *&t;&t;Niibe Yutaka, &lt;gniibe@mri.co.jp&gt;&n; *&n; *&t;&t;Modularization and ifreq/ifmap support by Alan Cox.&n; *&t;&t;Rewritten by Niibe Yutaka.&n; *&n; * Fixes:&n; *&t;&t;9-Sep-95 Philip Blundell &lt;pjb27@cam.ac.uk&gt;&n; *&t;&t;  - only claim 3 bytes of I/O space for port at 0x3bc&n; *&t;&t;  - treat NULL return from register_netdev() as success in&n; *&t;&t;    init_module()&n; *&t;&t;  - added message if driver loaded as a module but no&n; *&t;&t;    interfaces present.&n; *&t;&t;  - release claimed I/O ports if malloc() fails during init.&n; *&t;&t;&n; *&t;&t;Niibe Yutaka&n; *&t;&t;  - Module initialization.  You can specify I/O addr and IRQ:&n; *&t;&t;&t;# insmod plip.o io=0x3bc irq=7&n; *&t;&t;  - MTU fix.&n; *&t;&t;  - Make sure other end is OK, before sending a packet.&n; *&n; *&t;&t;This program is free software; you can redistribute it and/or&n; *&t;&t;modify it under the terms of the GNU General Public License&n; *&t;&t;as published by the Free Software Foundation; either version&n; *&t;&t;2 of the License, or (at your option) any later version.&n; */
multiline_comment|/*&n; * Original version and the name &squot;PLIP&squot; from Donald Becker &lt;becker@super.org&gt;&n; * inspired by Russ Nelson&squot;s parallel port packet driver.&n; *&n; * NOTE:&n; *     Tanabe Hiroyasu had changed the protocol, and it was in Linux v1.0.&n; *     Because of the necessity to communicate to DOS machines with the&n; *     Crynwr packet driver, Peter Bauer changed the protocol again&n; *     back to original protocol.&n; *&n; *     This version follows original PLIP protocol. &n; *     So, this PLIP can&squot;t communicate the PLIP of Linux v1.0.&n; */
multiline_comment|/*&n; *     To use with DOS box, please do (Turn on ARP switch):&n; *&t;# ifconfig plip[0-2] arp&n; */
DECL|variable|version
r_static
r_const
r_char
op_star
id|version
op_assign
l_string|&quot;NET3 PLIP version 2.1 gniibe@mri.co.jp&bslash;n&quot;
suffix:semicolon
multiline_comment|/*&n;  Sources:&n;&t;Ideas and protocols came from Russ Nelson&squot;s &lt;nelson@crynwr.com&gt;&n;&t;&quot;parallel.asm&quot; parallel port packet driver.&n;&n;  The &quot;Crynwr&quot; parallel port standard specifies the following protocol:&n;    Trigger by sending &squot;0x08&squot; (this cause interrupt on other end)&n;    count-low octet&n;    count-high octet&n;    ... data octets&n;    checksum octet&n;  Each octet is sent as &lt;wait for rx. &squot;0x1?&squot;&gt; &lt;send 0x10+(octet&amp;0x0F)&gt;&n;&t;&t;&t;&lt;wait for rx. &squot;0x0?&squot;&gt; &lt;send 0x00+((octet&gt;&gt;4)&amp;0x0F)&gt;&n;&n;  The packet is encapsulated as if it were ethernet.&n;&n;  The cable used is a de facto standard parallel null cable -- sold as&n;  a &quot;LapLink&quot; cable by various places.  You&squot;ll need a 12-conductor cable to&n;  make one yourself.  The wiring is:&n;    SLCTIN&t;17 - 17&n;    GROUND&t;25 - 25&n;    D0-&gt;ERROR&t;2 - 15&t;&t;15 - 2&n;    D1-&gt;SLCT&t;3 - 13&t;&t;13 - 3&n;    D2-&gt;PAPOUT&t;4 - 12&t;&t;12 - 4&n;    D3-&gt;ACK&t;5 - 10&t;&t;10 - 5&n;    D4-&gt;BUSY&t;6 - 11&t;&t;11 - 6&n;  Do not connect the other pins.  They are&n;    D5,D6,D7 are 7,8,9&n;    STROBE is 1, FEED is 14, INIT is 16&n;    extra grounds are 18,19,20,21,22,23,24&n;*/
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/fcntl.h&gt;
macro_line|#include &lt;linux/interrupt.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/ptrace.h&gt;
macro_line|#include &lt;linux/if_ether.h&gt;
macro_line|#include &lt;asm/system.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;linux/in.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;linux/lp.h&gt;
macro_line|#include &lt;linux/netdevice.h&gt;
macro_line|#include &lt;linux/etherdevice.h&gt;
macro_line|#include &lt;linux/skbuff.h&gt;
macro_line|#include &lt;linux/if_plip.h&gt;
macro_line|#include &lt;linux/tqueue.h&gt;
macro_line|#include &lt;linux/ioport.h&gt;
macro_line|#include &lt;asm/bitops.h&gt;
macro_line|#include &lt;asm/irq.h&gt;
macro_line|#include &lt;asm/byteorder.h&gt;
multiline_comment|/* Use 0 for production, 1 for verification, &gt;2 for debug */
macro_line|#ifndef NET_DEBUG
DECL|macro|NET_DEBUG
mdefine_line|#define NET_DEBUG 1
macro_line|#endif
DECL|variable|net_debug
r_static
r_int
r_int
id|net_debug
op_assign
id|NET_DEBUG
suffix:semicolon
multiline_comment|/* In micro second */
DECL|macro|PLIP_DELAY_UNIT
mdefine_line|#define PLIP_DELAY_UNIT&t;&t;   1
multiline_comment|/* Connection time out = PLIP_TRIGGER_WAIT * PLIP_DELAY_UNIT usec */
DECL|macro|PLIP_TRIGGER_WAIT
mdefine_line|#define PLIP_TRIGGER_WAIT&t; 500
multiline_comment|/* Nibble time out = PLIP_NIBBLE_WAIT * PLIP_DELAY_UNIT usec */
DECL|macro|PLIP_NIBBLE_WAIT
mdefine_line|#define PLIP_NIBBLE_WAIT        3000
DECL|macro|PAR_INTR_ON
mdefine_line|#define PAR_INTR_ON&t;&t;(LP_PINITP|LP_PSELECP|LP_PINTEN)
DECL|macro|PAR_INTR_OFF
mdefine_line|#define PAR_INTR_OFF&t;&t;(LP_PINITP|LP_PSELECP)
DECL|macro|PAR_DATA
mdefine_line|#define PAR_DATA(dev)&t;&t;((dev)-&gt;base_addr+0)
DECL|macro|PAR_STATUS
mdefine_line|#define PAR_STATUS(dev)&t;&t;((dev)-&gt;base_addr+1)
DECL|macro|PAR_CONTROL
mdefine_line|#define PAR_CONTROL(dev)&t;((dev)-&gt;base_addr+2)
multiline_comment|/* Bottom halfs */
r_static
r_void
id|plip_kick_bh
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_void
id|plip_bh
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
suffix:semicolon
multiline_comment|/* Interrupt handler */
r_static
r_void
id|plip_interrupt
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
suffix:semicolon
multiline_comment|/* Functions for DEV methods */
r_static
r_int
id|plip_rebuild_header
c_func
(paren
r_void
op_star
id|buff
comma
r_struct
id|device
op_star
id|dev
comma
r_int
r_int
id|raddr
comma
r_struct
id|sk_buff
op_star
id|skb
)paren
suffix:semicolon
r_static
r_int
id|plip_tx_packet
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_int
id|plip_open
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_int
id|plip_close
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_struct
id|enet_statistics
op_star
id|plip_get_stats
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_int
id|plip_config
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
r_struct
id|ifmap
op_star
id|map
)paren
suffix:semicolon
r_static
r_int
id|plip_ioctl
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
r_struct
id|ifreq
op_star
id|ifr
comma
r_int
id|cmd
)paren
suffix:semicolon
"&f;"
DECL|enum|plip_connection_state
r_enum
id|plip_connection_state
(brace
DECL|enumerator|PLIP_CN_NONE
id|PLIP_CN_NONE
op_assign
l_int|0
comma
DECL|enumerator|PLIP_CN_RECEIVE
id|PLIP_CN_RECEIVE
comma
DECL|enumerator|PLIP_CN_SEND
id|PLIP_CN_SEND
comma
DECL|enumerator|PLIP_CN_CLOSING
id|PLIP_CN_CLOSING
comma
DECL|enumerator|PLIP_CN_ERROR
id|PLIP_CN_ERROR
)brace
suffix:semicolon
DECL|enum|plip_packet_state
r_enum
id|plip_packet_state
(brace
DECL|enumerator|PLIP_PK_DONE
id|PLIP_PK_DONE
op_assign
l_int|0
comma
DECL|enumerator|PLIP_PK_TRIGGER
id|PLIP_PK_TRIGGER
comma
DECL|enumerator|PLIP_PK_LENGTH_LSB
id|PLIP_PK_LENGTH_LSB
comma
DECL|enumerator|PLIP_PK_LENGTH_MSB
id|PLIP_PK_LENGTH_MSB
comma
DECL|enumerator|PLIP_PK_DATA
id|PLIP_PK_DATA
comma
DECL|enumerator|PLIP_PK_CHECKSUM
id|PLIP_PK_CHECKSUM
)brace
suffix:semicolon
DECL|enum|plip_nibble_state
r_enum
id|plip_nibble_state
(brace
DECL|enumerator|PLIP_NB_BEGIN
id|PLIP_NB_BEGIN
comma
DECL|enumerator|PLIP_NB_1
id|PLIP_NB_1
comma
DECL|enumerator|PLIP_NB_2
id|PLIP_NB_2
comma
)brace
suffix:semicolon
DECL|struct|plip_local
r_struct
id|plip_local
(brace
DECL|member|state
r_enum
id|plip_packet_state
id|state
suffix:semicolon
DECL|member|nibble
r_enum
id|plip_nibble_state
id|nibble
suffix:semicolon
r_union
(brace
r_struct
(brace
macro_line|#if defined(__LITTLE_ENDIAN)
DECL|member|lsb
r_int
r_char
id|lsb
suffix:semicolon
DECL|member|msb
r_int
r_char
id|msb
suffix:semicolon
macro_line|#elif defined(__BIG_ENDIAN)
r_int
r_char
id|msb
suffix:semicolon
r_int
r_char
id|lsb
suffix:semicolon
macro_line|#else
macro_line|#error&t;&quot;Please fix the endianness defines in &lt;asm/byteorder.h&gt;&quot;
macro_line|#endif&t;&t;&t;&t;&t;&t;
DECL|member|b
)brace
id|b
suffix:semicolon
DECL|member|h
r_int
r_int
id|h
suffix:semicolon
DECL|member|length
)brace
id|length
suffix:semicolon
DECL|member|byte
r_int
r_int
id|byte
suffix:semicolon
DECL|member|checksum
r_int
r_char
id|checksum
suffix:semicolon
DECL|member|data
r_int
r_char
id|data
suffix:semicolon
DECL|member|skb
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
)brace
suffix:semicolon
DECL|struct|net_local
r_struct
id|net_local
(brace
DECL|member|enet_stats
r_struct
id|enet_statistics
id|enet_stats
suffix:semicolon
DECL|member|immediate
r_struct
id|tq_struct
id|immediate
suffix:semicolon
DECL|member|deferred
r_struct
id|tq_struct
id|deferred
suffix:semicolon
DECL|member|snd_data
r_struct
id|plip_local
id|snd_data
suffix:semicolon
DECL|member|rcv_data
r_struct
id|plip_local
id|rcv_data
suffix:semicolon
DECL|member|trigger
r_int
r_int
id|trigger
suffix:semicolon
DECL|member|nibble
r_int
r_int
id|nibble
suffix:semicolon
DECL|member|connection
r_enum
id|plip_connection_state
id|connection
suffix:semicolon
DECL|member|timeout_count
r_int
r_int
id|timeout_count
suffix:semicolon
DECL|member|is_deferred
r_char
id|is_deferred
suffix:semicolon
DECL|member|orig_rebuild_header
r_int
(paren
op_star
id|orig_rebuild_header
)paren
(paren
r_void
op_star
id|eth
comma
r_struct
id|device
op_star
id|dev
comma
r_int
r_int
id|raddr
comma
r_struct
id|sk_buff
op_star
id|skb
)paren
suffix:semicolon
)brace
suffix:semicolon
"&f;"
multiline_comment|/* Entry point of PLIP driver.&n;   Probe the hardware, and register/initialize the driver. */
r_int
DECL|function|plip_init
id|plip_init
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
r_struct
id|net_local
op_star
id|nl
suffix:semicolon
r_int
id|iosize
op_assign
(paren
id|PAR_DATA
c_func
(paren
id|dev
)paren
op_eq
l_int|0x3bc
)paren
ques
c_cond
l_int|3
suffix:colon
l_int|8
suffix:semicolon
multiline_comment|/* Check region before the probe */
r_if
c_cond
(paren
id|check_region
c_func
(paren
id|PAR_DATA
c_func
(paren
id|dev
)paren
comma
id|iosize
)paren
OL
l_int|0
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
multiline_comment|/* Check that there is something at base_addr. */
id|outb
c_func
(paren
l_int|0
comma
id|PAR_DATA
c_func
(paren
id|dev
)paren
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|1000
)paren
suffix:semicolon
r_if
c_cond
(paren
id|inb
c_func
(paren
id|PAR_DATA
c_func
(paren
id|dev
)paren
)paren
op_ne
l_int|0
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
id|printk
c_func
(paren
id|version
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;%s: Parallel port at %#3lx, &quot;
comma
id|dev-&gt;name
comma
id|dev-&gt;base_addr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;irq
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;using assigned IRQ %d.&bslash;n&quot;
comma
id|dev-&gt;irq
)paren
suffix:semicolon
)brace
r_else
(brace
r_int
id|irq
op_assign
l_int|0
suffix:semicolon
macro_line|#ifdef MODULE
multiline_comment|/* dev-&gt;irq==0 means autoprobe, but we don&squot;t try to do so&n;&t;&t;   with module.  We can change it by ifconfig */
macro_line|#else
r_int
r_int
id|irqs
op_assign
id|probe_irq_on
c_func
(paren
)paren
suffix:semicolon
id|outb
c_func
(paren
l_int|0x00
comma
id|PAR_CONTROL
c_func
(paren
id|dev
)paren
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|1000
)paren
suffix:semicolon
id|outb
c_func
(paren
id|PAR_INTR_OFF
comma
id|PAR_CONTROL
c_func
(paren
id|dev
)paren
)paren
suffix:semicolon
id|outb
c_func
(paren
id|PAR_INTR_ON
comma
id|PAR_CONTROL
c_func
(paren
id|dev
)paren
)paren
suffix:semicolon
id|outb
c_func
(paren
id|PAR_INTR_OFF
comma
id|PAR_CONTROL
c_func
(paren
id|dev
)paren
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|1000
)paren
suffix:semicolon
id|irq
op_assign
id|probe_irq_off
c_func
(paren
id|irqs
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|irq
OG
l_int|0
)paren
(brace
id|dev-&gt;irq
op_assign
id|irq
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;using probed IRQ %d.&bslash;n&quot;
comma
id|dev-&gt;irq
)paren
suffix:semicolon
)brace
r_else
id|printk
c_func
(paren
l_string|&quot;failed to detect IRQ(%d) --&quot;
l_string|&quot; Please set IRQ by ifconfig.&bslash;n&quot;
comma
id|irq
)paren
suffix:semicolon
)brace
id|request_region
c_func
(paren
id|PAR_DATA
c_func
(paren
id|dev
)paren
comma
id|iosize
comma
id|dev-&gt;name
)paren
suffix:semicolon
multiline_comment|/* Fill in the generic fields of the device structure. */
id|ether_setup
c_func
(paren
id|dev
)paren
suffix:semicolon
multiline_comment|/* Then, override parts of it */
id|dev-&gt;hard_start_xmit
op_assign
id|plip_tx_packet
suffix:semicolon
id|dev-&gt;open
op_assign
id|plip_open
suffix:semicolon
id|dev-&gt;stop
op_assign
id|plip_close
suffix:semicolon
id|dev-&gt;get_stats
op_assign
id|plip_get_stats
suffix:semicolon
id|dev-&gt;set_config
op_assign
id|plip_config
suffix:semicolon
id|dev-&gt;do_ioctl
op_assign
id|plip_ioctl
suffix:semicolon
id|dev-&gt;flags
op_assign
id|IFF_POINTOPOINT
op_or
id|IFF_NOARP
suffix:semicolon
multiline_comment|/* Set the private structure */
id|dev-&gt;priv
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|net_local
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;priv
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: out of memory&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|release_region
c_func
(paren
id|PAR_DATA
c_func
(paren
id|dev
)paren
comma
id|iosize
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|memset
c_func
(paren
id|dev-&gt;priv
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|net_local
)paren
)paren
suffix:semicolon
id|nl
op_assign
(paren
r_struct
id|net_local
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|nl-&gt;orig_rebuild_header
op_assign
id|dev-&gt;rebuild_header
suffix:semicolon
id|dev-&gt;rebuild_header
op_assign
id|plip_rebuild_header
suffix:semicolon
multiline_comment|/* Initialize constants */
id|nl-&gt;trigger
op_assign
id|PLIP_TRIGGER_WAIT
suffix:semicolon
id|nl-&gt;nibble
op_assign
id|PLIP_NIBBLE_WAIT
suffix:semicolon
multiline_comment|/* Initialize task queue structures */
id|nl-&gt;immediate.next
op_assign
l_int|NULL
suffix:semicolon
id|nl-&gt;immediate.sync
op_assign
l_int|0
suffix:semicolon
id|nl-&gt;immediate.routine
op_assign
(paren
r_void
op_star
)paren
(paren
r_void
op_star
)paren
id|plip_bh
suffix:semicolon
id|nl-&gt;immediate.data
op_assign
id|dev
suffix:semicolon
id|nl-&gt;deferred.next
op_assign
l_int|NULL
suffix:semicolon
id|nl-&gt;deferred.sync
op_assign
l_int|0
suffix:semicolon
id|nl-&gt;deferred.routine
op_assign
(paren
r_void
op_star
)paren
(paren
r_void
op_star
)paren
id|plip_kick_bh
suffix:semicolon
id|nl-&gt;deferred.data
op_assign
id|dev
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
"&f;"
multiline_comment|/* Bottom half handler for the delayed request.&n;   This routine is kicked by do_timer().&n;   Request `plip_bh&squot; to be invoked. */
r_static
r_void
DECL|function|plip_kick_bh
id|plip_kick_bh
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
r_struct
id|net_local
op_star
id|nl
op_assign
(paren
r_struct
id|net_local
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_if
c_cond
(paren
id|nl-&gt;is_deferred
)paren
(brace
id|queue_task
c_func
(paren
op_amp
id|nl-&gt;immediate
comma
op_amp
id|tq_immediate
)paren
suffix:semicolon
id|mark_bh
c_func
(paren
id|IMMEDIATE_BH
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* Forward declarations of internal routines */
r_static
r_int
id|plip_none
c_func
(paren
r_struct
id|device
op_star
comma
r_struct
id|net_local
op_star
comma
r_struct
id|plip_local
op_star
comma
r_struct
id|plip_local
op_star
)paren
suffix:semicolon
r_static
r_int
id|plip_receive_packet
c_func
(paren
r_struct
id|device
op_star
comma
r_struct
id|net_local
op_star
comma
r_struct
id|plip_local
op_star
comma
r_struct
id|plip_local
op_star
)paren
suffix:semicolon
r_static
r_int
id|plip_send_packet
c_func
(paren
r_struct
id|device
op_star
comma
r_struct
id|net_local
op_star
comma
r_struct
id|plip_local
op_star
comma
r_struct
id|plip_local
op_star
)paren
suffix:semicolon
r_static
r_int
id|plip_connection_close
c_func
(paren
r_struct
id|device
op_star
comma
r_struct
id|net_local
op_star
comma
r_struct
id|plip_local
op_star
comma
r_struct
id|plip_local
op_star
)paren
suffix:semicolon
r_static
r_int
id|plip_error
c_func
(paren
r_struct
id|device
op_star
comma
r_struct
id|net_local
op_star
comma
r_struct
id|plip_local
op_star
comma
r_struct
id|plip_local
op_star
)paren
suffix:semicolon
r_static
r_int
id|plip_bh_timeout_error
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
r_struct
id|net_local
op_star
id|nl
comma
r_struct
id|plip_local
op_star
id|snd
comma
r_struct
id|plip_local
op_star
id|rcv
comma
r_int
id|error
)paren
suffix:semicolon
DECL|macro|OK
mdefine_line|#define OK        0
DECL|macro|TIMEOUT
mdefine_line|#define TIMEOUT   1
DECL|macro|ERROR
mdefine_line|#define ERROR     2
DECL|typedef|plip_func
r_typedef
r_int
(paren
op_star
id|plip_func
)paren
(paren
r_struct
id|device
op_star
id|dev
comma
r_struct
id|net_local
op_star
id|nl
comma
r_struct
id|plip_local
op_star
id|snd
comma
r_struct
id|plip_local
op_star
id|rcv
)paren
suffix:semicolon
DECL|variable|connection_state_table
r_static
id|plip_func
id|connection_state_table
(braket
)braket
op_assign
(brace
id|plip_none
comma
id|plip_receive_packet
comma
id|plip_send_packet
comma
id|plip_connection_close
comma
id|plip_error
)brace
suffix:semicolon
multiline_comment|/* Bottom half handler of PLIP. */
r_static
r_void
DECL|function|plip_bh
id|plip_bh
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
r_struct
id|net_local
op_star
id|nl
op_assign
(paren
r_struct
id|net_local
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_struct
id|plip_local
op_star
id|snd
op_assign
op_amp
id|nl-&gt;snd_data
suffix:semicolon
r_struct
id|plip_local
op_star
id|rcv
op_assign
op_amp
id|nl-&gt;rcv_data
suffix:semicolon
id|plip_func
id|f
suffix:semicolon
r_int
id|r
suffix:semicolon
id|nl-&gt;is_deferred
op_assign
l_int|0
suffix:semicolon
id|f
op_assign
id|connection_state_table
(braket
id|nl-&gt;connection
)braket
suffix:semicolon
r_if
c_cond
(paren
(paren
id|r
op_assign
(paren
op_star
id|f
)paren
(paren
id|dev
comma
id|nl
comma
id|snd
comma
id|rcv
)paren
)paren
op_ne
id|OK
op_logical_and
(paren
id|r
op_assign
id|plip_bh_timeout_error
c_func
(paren
id|dev
comma
id|nl
comma
id|snd
comma
id|rcv
comma
id|r
)paren
)paren
op_ne
id|OK
)paren
(brace
id|nl-&gt;is_deferred
op_assign
l_int|1
suffix:semicolon
id|queue_task
c_func
(paren
op_amp
id|nl-&gt;deferred
comma
op_amp
id|tq_timer
)paren
suffix:semicolon
)brace
)brace
r_static
r_int
DECL|function|plip_bh_timeout_error
id|plip_bh_timeout_error
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
r_struct
id|net_local
op_star
id|nl
comma
r_struct
id|plip_local
op_star
id|snd
comma
r_struct
id|plip_local
op_star
id|rcv
comma
r_int
id|error
)paren
(brace
r_int
r_char
id|c0
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|nl-&gt;connection
op_eq
id|PLIP_CN_SEND
)paren
(brace
r_if
c_cond
(paren
id|error
op_ne
id|ERROR
)paren
(brace
multiline_comment|/* Timeout */
id|nl-&gt;timeout_count
op_increment
suffix:semicolon
r_if
c_cond
(paren
(paren
id|snd-&gt;state
op_eq
id|PLIP_PK_TRIGGER
op_logical_and
id|nl-&gt;timeout_count
op_le
l_int|10
)paren
op_logical_or
id|nl-&gt;timeout_count
op_le
l_int|3
)paren
(brace
id|sti
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* Try again later */
r_return
id|TIMEOUT
suffix:semicolon
)brace
id|c0
op_assign
id|inb
c_func
(paren
id|PAR_STATUS
c_func
(paren
id|dev
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;%s: transmit timeout(%d,%02x)&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|snd-&gt;state
comma
id|c0
)paren
suffix:semicolon
)brace
id|nl-&gt;enet_stats.tx_errors
op_increment
suffix:semicolon
id|nl-&gt;enet_stats.tx_aborted_errors
op_increment
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|nl-&gt;connection
op_eq
id|PLIP_CN_RECEIVE
)paren
(brace
r_if
c_cond
(paren
id|rcv-&gt;state
op_eq
id|PLIP_PK_TRIGGER
)paren
(brace
multiline_comment|/* Transmission was interrupted. */
id|sti
c_func
(paren
)paren
suffix:semicolon
r_return
id|OK
suffix:semicolon
)brace
r_if
c_cond
(paren
id|error
op_ne
id|ERROR
)paren
(brace
multiline_comment|/* Timeout */
r_if
c_cond
(paren
op_increment
id|nl-&gt;timeout_count
op_le
l_int|3
)paren
(brace
id|sti
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* Try again later */
r_return
id|TIMEOUT
suffix:semicolon
)brace
id|c0
op_assign
id|inb
c_func
(paren
id|PAR_STATUS
c_func
(paren
id|dev
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;%s: receive timeout(%d,%02x)&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|rcv-&gt;state
comma
id|c0
)paren
suffix:semicolon
)brace
id|nl-&gt;enet_stats.rx_dropped
op_increment
suffix:semicolon
)brace
id|rcv-&gt;state
op_assign
id|PLIP_PK_DONE
suffix:semicolon
r_if
c_cond
(paren
id|rcv-&gt;skb
)paren
(brace
id|rcv-&gt;skb-&gt;free
op_assign
l_int|1
suffix:semicolon
id|kfree_skb
c_func
(paren
id|rcv-&gt;skb
comma
id|FREE_READ
)paren
suffix:semicolon
id|rcv-&gt;skb
op_assign
l_int|NULL
suffix:semicolon
)brace
id|snd-&gt;state
op_assign
id|PLIP_PK_DONE
suffix:semicolon
r_if
c_cond
(paren
id|snd-&gt;skb
)paren
(brace
id|dev_kfree_skb
c_func
(paren
id|snd-&gt;skb
comma
id|FREE_WRITE
)paren
suffix:semicolon
id|snd-&gt;skb
op_assign
l_int|NULL
suffix:semicolon
)brace
id|disable_irq
c_func
(paren
id|dev-&gt;irq
)paren
suffix:semicolon
id|outb
c_func
(paren
id|PAR_INTR_OFF
comma
id|PAR_CONTROL
c_func
(paren
id|dev
)paren
)paren
suffix:semicolon
id|dev-&gt;tbusy
op_assign
l_int|1
suffix:semicolon
id|nl-&gt;connection
op_assign
id|PLIP_CN_ERROR
suffix:semicolon
id|outb
c_func
(paren
l_int|0x00
comma
id|PAR_DATA
c_func
(paren
id|dev
)paren
)paren
suffix:semicolon
id|sti
c_func
(paren
)paren
suffix:semicolon
r_return
id|TIMEOUT
suffix:semicolon
)brace
"&f;"
r_static
r_int
DECL|function|plip_none
id|plip_none
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
r_struct
id|net_local
op_star
id|nl
comma
r_struct
id|plip_local
op_star
id|snd
comma
r_struct
id|plip_local
op_star
id|rcv
)paren
(brace
r_return
id|OK
suffix:semicolon
)brace
multiline_comment|/* PLIP_RECEIVE --- receive a byte(two nibbles)&n;   Returns OK on success, TIMEOUT on timeout */
r_inline
r_static
r_int
DECL|function|plip_receive
id|plip_receive
c_func
(paren
r_int
r_int
id|nibble_timeout
comma
r_int
r_int
id|status_addr
comma
r_enum
id|plip_nibble_state
op_star
id|ns_p
comma
r_int
r_char
op_star
id|data_p
)paren
(brace
r_int
r_char
id|c0
comma
id|c1
suffix:semicolon
r_int
r_int
id|cx
suffix:semicolon
r_switch
c_cond
(paren
op_star
id|ns_p
)paren
(brace
r_case
id|PLIP_NB_BEGIN
suffix:colon
id|cx
op_assign
id|nibble_timeout
suffix:semicolon
r_while
c_loop
(paren
l_int|1
)paren
(brace
id|c0
op_assign
id|inb
c_func
(paren
id|status_addr
)paren
suffix:semicolon
id|udelay
c_func
(paren
id|PLIP_DELAY_UNIT
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|c0
op_amp
l_int|0x80
)paren
op_eq
l_int|0
)paren
(brace
id|c1
op_assign
id|inb
c_func
(paren
id|status_addr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|c0
op_eq
id|c1
)paren
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
op_decrement
id|cx
op_eq
l_int|0
)paren
r_return
id|TIMEOUT
suffix:semicolon
)brace
op_star
id|data_p
op_assign
(paren
id|c0
op_rshift
l_int|3
)paren
op_amp
l_int|0x0f
suffix:semicolon
id|outb
c_func
(paren
l_int|0x10
comma
op_decrement
id|status_addr
)paren
suffix:semicolon
multiline_comment|/* send ACK */
id|status_addr
op_increment
suffix:semicolon
op_star
id|ns_p
op_assign
id|PLIP_NB_1
suffix:semicolon
r_case
id|PLIP_NB_1
suffix:colon
id|cx
op_assign
id|nibble_timeout
suffix:semicolon
r_while
c_loop
(paren
l_int|1
)paren
(brace
id|c0
op_assign
id|inb
c_func
(paren
id|status_addr
)paren
suffix:semicolon
id|udelay
c_func
(paren
id|PLIP_DELAY_UNIT
)paren
suffix:semicolon
r_if
c_cond
(paren
id|c0
op_amp
l_int|0x80
)paren
(brace
id|c1
op_assign
id|inb
c_func
(paren
id|status_addr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|c0
op_eq
id|c1
)paren
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
op_decrement
id|cx
op_eq
l_int|0
)paren
r_return
id|TIMEOUT
suffix:semicolon
)brace
op_star
id|data_p
op_or_assign
(paren
id|c0
op_lshift
l_int|1
)paren
op_amp
l_int|0xf0
suffix:semicolon
id|outb
c_func
(paren
l_int|0x00
comma
op_decrement
id|status_addr
)paren
suffix:semicolon
multiline_comment|/* send ACK */
id|status_addr
op_increment
suffix:semicolon
op_star
id|ns_p
op_assign
id|PLIP_NB_BEGIN
suffix:semicolon
r_case
id|PLIP_NB_2
suffix:colon
r_break
suffix:semicolon
)brace
r_return
id|OK
suffix:semicolon
)brace
multiline_comment|/* PLIP_RECEIVE_PACKET --- receive a packet */
r_static
r_int
DECL|function|plip_receive_packet
id|plip_receive_packet
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
r_struct
id|net_local
op_star
id|nl
comma
r_struct
id|plip_local
op_star
id|snd
comma
r_struct
id|plip_local
op_star
id|rcv
)paren
(brace
r_int
r_int
id|status_addr
op_assign
id|PAR_STATUS
c_func
(paren
id|dev
)paren
suffix:semicolon
r_int
r_int
id|nibble_timeout
op_assign
id|nl-&gt;nibble
suffix:semicolon
r_int
r_char
op_star
id|lbuf
suffix:semicolon
r_switch
c_cond
(paren
id|rcv-&gt;state
)paren
(brace
r_case
id|PLIP_PK_TRIGGER
suffix:colon
id|disable_irq
c_func
(paren
id|dev-&gt;irq
)paren
suffix:semicolon
id|outb
c_func
(paren
id|PAR_INTR_OFF
comma
id|PAR_CONTROL
c_func
(paren
id|dev
)paren
)paren
suffix:semicolon
id|dev-&gt;interrupt
op_assign
l_int|0
suffix:semicolon
id|outb
c_func
(paren
l_int|0x01
comma
id|PAR_DATA
c_func
(paren
id|dev
)paren
)paren
suffix:semicolon
multiline_comment|/* send ACK */
r_if
c_cond
(paren
id|net_debug
OG
l_int|2
)paren
id|printk
c_func
(paren
l_string|&quot;%s: receive start&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|rcv-&gt;state
op_assign
id|PLIP_PK_LENGTH_LSB
suffix:semicolon
id|rcv-&gt;nibble
op_assign
id|PLIP_NB_BEGIN
suffix:semicolon
r_case
id|PLIP_PK_LENGTH_LSB
suffix:colon
r_if
c_cond
(paren
id|snd-&gt;state
op_ne
id|PLIP_PK_DONE
)paren
(brace
r_if
c_cond
(paren
id|plip_receive
c_func
(paren
id|nl-&gt;trigger
comma
id|status_addr
comma
op_amp
id|rcv-&gt;nibble
comma
op_amp
id|rcv-&gt;length.b.lsb
)paren
)paren
(brace
multiline_comment|/* collision, here dev-&gt;tbusy == 1 */
id|rcv-&gt;state
op_assign
id|PLIP_PK_DONE
suffix:semicolon
id|nl-&gt;is_deferred
op_assign
l_int|1
suffix:semicolon
id|nl-&gt;connection
op_assign
id|PLIP_CN_SEND
suffix:semicolon
id|queue_task
c_func
(paren
op_amp
id|nl-&gt;deferred
comma
op_amp
id|tq_timer
)paren
suffix:semicolon
id|outb
c_func
(paren
id|PAR_INTR_ON
comma
id|PAR_CONTROL
c_func
(paren
id|dev
)paren
)paren
suffix:semicolon
id|enable_irq
c_func
(paren
id|dev-&gt;irq
)paren
suffix:semicolon
r_return
id|OK
suffix:semicolon
)brace
)brace
r_else
(brace
r_if
c_cond
(paren
id|plip_receive
c_func
(paren
id|nibble_timeout
comma
id|status_addr
comma
op_amp
id|rcv-&gt;nibble
comma
op_amp
id|rcv-&gt;length.b.lsb
)paren
)paren
r_return
id|TIMEOUT
suffix:semicolon
)brace
id|rcv-&gt;state
op_assign
id|PLIP_PK_LENGTH_MSB
suffix:semicolon
r_case
id|PLIP_PK_LENGTH_MSB
suffix:colon
r_if
c_cond
(paren
id|plip_receive
c_func
(paren
id|nibble_timeout
comma
id|status_addr
comma
op_amp
id|rcv-&gt;nibble
comma
op_amp
id|rcv-&gt;length.b.msb
)paren
)paren
r_return
id|TIMEOUT
suffix:semicolon
r_if
c_cond
(paren
id|rcv-&gt;length.h
OG
id|dev-&gt;mtu
op_plus
id|dev-&gt;hard_header_len
op_logical_or
id|rcv-&gt;length.h
OL
l_int|8
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%s: bogus packet size %d.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|rcv-&gt;length.h
)paren
suffix:semicolon
r_return
id|ERROR
suffix:semicolon
)brace
multiline_comment|/* Malloc up new buffer. */
id|rcv-&gt;skb
op_assign
id|dev_alloc_skb
c_func
(paren
id|rcv-&gt;length.h
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rcv-&gt;skb
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%s: Memory squeeze.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_return
id|ERROR
suffix:semicolon
)brace
id|skb_put
c_func
(paren
id|rcv-&gt;skb
comma
id|rcv-&gt;length.h
)paren
suffix:semicolon
id|rcv-&gt;skb-&gt;dev
op_assign
id|dev
suffix:semicolon
id|rcv-&gt;state
op_assign
id|PLIP_PK_DATA
suffix:semicolon
id|rcv-&gt;byte
op_assign
l_int|0
suffix:semicolon
id|rcv-&gt;checksum
op_assign
l_int|0
suffix:semicolon
r_case
id|PLIP_PK_DATA
suffix:colon
id|lbuf
op_assign
id|rcv-&gt;skb-&gt;data
suffix:semicolon
r_do
r_if
c_cond
(paren
id|plip_receive
c_func
(paren
id|nibble_timeout
comma
id|status_addr
comma
op_amp
id|rcv-&gt;nibble
comma
op_amp
id|lbuf
(braket
id|rcv-&gt;byte
)braket
)paren
)paren
r_return
id|TIMEOUT
suffix:semicolon
r_while
c_loop
(paren
op_increment
id|rcv-&gt;byte
OL
id|rcv-&gt;length.h
)paren
suffix:semicolon
r_do
id|rcv-&gt;checksum
op_add_assign
id|lbuf
(braket
op_decrement
id|rcv-&gt;byte
)braket
suffix:semicolon
r_while
c_loop
(paren
id|rcv-&gt;byte
)paren
suffix:semicolon
id|rcv-&gt;state
op_assign
id|PLIP_PK_CHECKSUM
suffix:semicolon
r_case
id|PLIP_PK_CHECKSUM
suffix:colon
r_if
c_cond
(paren
id|plip_receive
c_func
(paren
id|nibble_timeout
comma
id|status_addr
comma
op_amp
id|rcv-&gt;nibble
comma
op_amp
id|rcv-&gt;data
)paren
)paren
r_return
id|TIMEOUT
suffix:semicolon
r_if
c_cond
(paren
id|rcv-&gt;data
op_ne
id|rcv-&gt;checksum
)paren
(brace
id|nl-&gt;enet_stats.rx_crc_errors
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|net_debug
)paren
id|printk
c_func
(paren
l_string|&quot;%s: checksum error&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_return
id|ERROR
suffix:semicolon
)brace
id|rcv-&gt;state
op_assign
id|PLIP_PK_DONE
suffix:semicolon
r_case
id|PLIP_PK_DONE
suffix:colon
multiline_comment|/* Inform the upper layer for the arrival of a packet. */
id|rcv-&gt;skb-&gt;protocol
op_assign
id|eth_type_trans
c_func
(paren
id|rcv-&gt;skb
comma
id|dev
)paren
suffix:semicolon
id|netif_rx
c_func
(paren
id|rcv-&gt;skb
)paren
suffix:semicolon
id|nl-&gt;enet_stats.rx_packets
op_increment
suffix:semicolon
id|rcv-&gt;skb
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
id|net_debug
OG
l_int|2
)paren
id|printk
c_func
(paren
l_string|&quot;%s: receive end&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
multiline_comment|/* Close the connection. */
id|outb
(paren
l_int|0x00
comma
id|PAR_DATA
c_func
(paren
id|dev
)paren
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|snd-&gt;state
op_ne
id|PLIP_PK_DONE
)paren
(brace
id|nl-&gt;connection
op_assign
id|PLIP_CN_SEND
suffix:semicolon
id|sti
c_func
(paren
)paren
suffix:semicolon
id|queue_task
c_func
(paren
op_amp
id|nl-&gt;immediate
comma
op_amp
id|tq_immediate
)paren
suffix:semicolon
id|outb
c_func
(paren
id|PAR_INTR_ON
comma
id|PAR_CONTROL
c_func
(paren
id|dev
)paren
)paren
suffix:semicolon
id|enable_irq
c_func
(paren
id|dev-&gt;irq
)paren
suffix:semicolon
r_return
id|OK
suffix:semicolon
)brace
r_else
(brace
id|nl-&gt;connection
op_assign
id|PLIP_CN_NONE
suffix:semicolon
id|sti
c_func
(paren
)paren
suffix:semicolon
id|outb
c_func
(paren
id|PAR_INTR_ON
comma
id|PAR_CONTROL
c_func
(paren
id|dev
)paren
)paren
suffix:semicolon
id|enable_irq
c_func
(paren
id|dev-&gt;irq
)paren
suffix:semicolon
r_return
id|OK
suffix:semicolon
)brace
)brace
r_return
id|OK
suffix:semicolon
)brace
multiline_comment|/* PLIP_SEND --- send a byte (two nibbles) &n;   Returns OK on success, TIMEOUT when timeout    */
r_inline
r_static
r_int
DECL|function|plip_send
id|plip_send
c_func
(paren
r_int
r_int
id|nibble_timeout
comma
r_int
r_int
id|data_addr
comma
r_enum
id|plip_nibble_state
op_star
id|ns_p
comma
r_int
r_char
id|data
)paren
(brace
r_int
r_char
id|c0
suffix:semicolon
r_int
r_int
id|cx
suffix:semicolon
r_switch
c_cond
(paren
op_star
id|ns_p
)paren
(brace
r_case
id|PLIP_NB_BEGIN
suffix:colon
id|outb
c_func
(paren
(paren
id|data
op_amp
l_int|0x0f
)paren
comma
id|data_addr
)paren
suffix:semicolon
op_star
id|ns_p
op_assign
id|PLIP_NB_1
suffix:semicolon
r_case
id|PLIP_NB_1
suffix:colon
id|outb
c_func
(paren
l_int|0x10
op_or
(paren
id|data
op_amp
l_int|0x0f
)paren
comma
id|data_addr
)paren
suffix:semicolon
id|cx
op_assign
id|nibble_timeout
suffix:semicolon
id|data_addr
op_increment
suffix:semicolon
r_while
c_loop
(paren
l_int|1
)paren
(brace
id|c0
op_assign
id|inb
c_func
(paren
id|data_addr
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|c0
op_amp
l_int|0x80
)paren
op_eq
l_int|0
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
op_decrement
id|cx
op_eq
l_int|0
)paren
r_return
id|TIMEOUT
suffix:semicolon
id|udelay
c_func
(paren
id|PLIP_DELAY_UNIT
)paren
suffix:semicolon
)brace
id|outb
c_func
(paren
l_int|0x10
op_or
(paren
id|data
op_rshift
l_int|4
)paren
comma
op_decrement
id|data_addr
)paren
suffix:semicolon
op_star
id|ns_p
op_assign
id|PLIP_NB_2
suffix:semicolon
r_case
id|PLIP_NB_2
suffix:colon
id|outb
c_func
(paren
(paren
id|data
op_rshift
l_int|4
)paren
comma
id|data_addr
)paren
suffix:semicolon
id|data_addr
op_increment
suffix:semicolon
id|cx
op_assign
id|nibble_timeout
suffix:semicolon
r_while
c_loop
(paren
l_int|1
)paren
(brace
id|c0
op_assign
id|inb
c_func
(paren
id|data_addr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|c0
op_amp
l_int|0x80
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
op_decrement
id|cx
op_eq
l_int|0
)paren
r_return
id|TIMEOUT
suffix:semicolon
id|udelay
c_func
(paren
id|PLIP_DELAY_UNIT
)paren
suffix:semicolon
)brace
id|data_addr
op_decrement
suffix:semicolon
op_star
id|ns_p
op_assign
id|PLIP_NB_BEGIN
suffix:semicolon
r_return
id|OK
suffix:semicolon
)brace
r_return
id|OK
suffix:semicolon
)brace
multiline_comment|/* PLIP_SEND_PACKET --- send a packet */
r_static
r_int
DECL|function|plip_send_packet
id|plip_send_packet
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
r_struct
id|net_local
op_star
id|nl
comma
r_struct
id|plip_local
op_star
id|snd
comma
r_struct
id|plip_local
op_star
id|rcv
)paren
(brace
r_int
r_int
id|data_addr
op_assign
id|PAR_DATA
c_func
(paren
id|dev
)paren
suffix:semicolon
r_int
r_int
id|nibble_timeout
op_assign
id|nl-&gt;nibble
suffix:semicolon
r_int
r_char
op_star
id|lbuf
suffix:semicolon
r_int
r_char
id|c0
suffix:semicolon
r_int
r_int
id|cx
suffix:semicolon
r_if
c_cond
(paren
id|snd-&gt;skb
op_eq
l_int|NULL
op_logical_or
(paren
id|lbuf
op_assign
id|snd-&gt;skb-&gt;data
)paren
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%s: send skb lost&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|snd-&gt;state
op_assign
id|PLIP_PK_DONE
suffix:semicolon
id|snd-&gt;skb
op_assign
l_int|NULL
suffix:semicolon
r_return
id|ERROR
suffix:semicolon
)brace
r_switch
c_cond
(paren
id|snd-&gt;state
)paren
(brace
r_case
id|PLIP_PK_TRIGGER
suffix:colon
r_if
c_cond
(paren
(paren
id|inb
c_func
(paren
id|PAR_STATUS
c_func
(paren
id|dev
)paren
)paren
op_amp
l_int|0xf8
)paren
op_ne
l_int|0x80
)paren
r_return
id|TIMEOUT
suffix:semicolon
multiline_comment|/* Trigger remote rx interrupt. */
id|outb
c_func
(paren
l_int|0x08
comma
id|data_addr
)paren
suffix:semicolon
id|cx
op_assign
id|nl-&gt;trigger
suffix:semicolon
r_while
c_loop
(paren
l_int|1
)paren
(brace
id|udelay
c_func
(paren
id|PLIP_DELAY_UNIT
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|nl-&gt;connection
op_eq
id|PLIP_CN_RECEIVE
)paren
(brace
id|sti
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* interrupted */
id|nl-&gt;enet_stats.collisions
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|net_debug
OG
l_int|1
)paren
id|printk
c_func
(paren
l_string|&quot;%s: collision.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_return
id|OK
suffix:semicolon
)brace
id|c0
op_assign
id|inb
c_func
(paren
id|PAR_STATUS
c_func
(paren
id|dev
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|c0
op_amp
l_int|0x08
)paren
(brace
id|disable_irq
c_func
(paren
id|dev-&gt;irq
)paren
suffix:semicolon
id|outb
c_func
(paren
id|PAR_INTR_OFF
comma
id|PAR_CONTROL
c_func
(paren
id|dev
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|net_debug
OG
l_int|2
)paren
id|printk
c_func
(paren
l_string|&quot;%s: send start&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|snd-&gt;state
op_assign
id|PLIP_PK_LENGTH_LSB
suffix:semicolon
id|snd-&gt;nibble
op_assign
id|PLIP_NB_BEGIN
suffix:semicolon
id|nl-&gt;timeout_count
op_assign
l_int|0
suffix:semicolon
id|sti
c_func
(paren
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|sti
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_decrement
id|cx
op_eq
l_int|0
)paren
(brace
id|outb
c_func
(paren
l_int|0x00
comma
id|data_addr
)paren
suffix:semicolon
r_return
id|TIMEOUT
suffix:semicolon
)brace
)brace
r_case
id|PLIP_PK_LENGTH_LSB
suffix:colon
r_if
c_cond
(paren
id|plip_send
c_func
(paren
id|nibble_timeout
comma
id|data_addr
comma
op_amp
id|snd-&gt;nibble
comma
id|snd-&gt;length.b.lsb
)paren
)paren
r_return
id|TIMEOUT
suffix:semicolon
id|snd-&gt;state
op_assign
id|PLIP_PK_LENGTH_MSB
suffix:semicolon
r_case
id|PLIP_PK_LENGTH_MSB
suffix:colon
r_if
c_cond
(paren
id|plip_send
c_func
(paren
id|nibble_timeout
comma
id|data_addr
comma
op_amp
id|snd-&gt;nibble
comma
id|snd-&gt;length.b.msb
)paren
)paren
r_return
id|TIMEOUT
suffix:semicolon
id|snd-&gt;state
op_assign
id|PLIP_PK_DATA
suffix:semicolon
id|snd-&gt;byte
op_assign
l_int|0
suffix:semicolon
id|snd-&gt;checksum
op_assign
l_int|0
suffix:semicolon
r_case
id|PLIP_PK_DATA
suffix:colon
r_do
r_if
c_cond
(paren
id|plip_send
c_func
(paren
id|nibble_timeout
comma
id|data_addr
comma
op_amp
id|snd-&gt;nibble
comma
id|lbuf
(braket
id|snd-&gt;byte
)braket
)paren
)paren
r_return
id|TIMEOUT
suffix:semicolon
r_while
c_loop
(paren
op_increment
id|snd-&gt;byte
OL
id|snd-&gt;length.h
)paren
suffix:semicolon
r_do
id|snd-&gt;checksum
op_add_assign
id|lbuf
(braket
op_decrement
id|snd-&gt;byte
)braket
suffix:semicolon
r_while
c_loop
(paren
id|snd-&gt;byte
)paren
suffix:semicolon
id|snd-&gt;state
op_assign
id|PLIP_PK_CHECKSUM
suffix:semicolon
r_case
id|PLIP_PK_CHECKSUM
suffix:colon
r_if
c_cond
(paren
id|plip_send
c_func
(paren
id|nibble_timeout
comma
id|data_addr
comma
op_amp
id|snd-&gt;nibble
comma
id|snd-&gt;checksum
)paren
)paren
r_return
id|TIMEOUT
suffix:semicolon
id|dev_kfree_skb
c_func
(paren
id|snd-&gt;skb
comma
id|FREE_WRITE
)paren
suffix:semicolon
id|nl-&gt;enet_stats.tx_packets
op_increment
suffix:semicolon
id|snd-&gt;state
op_assign
id|PLIP_PK_DONE
suffix:semicolon
r_case
id|PLIP_PK_DONE
suffix:colon
multiline_comment|/* Close the connection */
id|outb
(paren
l_int|0x00
comma
id|data_addr
)paren
suffix:semicolon
id|snd-&gt;skb
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
id|net_debug
OG
l_int|2
)paren
id|printk
c_func
(paren
l_string|&quot;%s: send end&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|nl-&gt;connection
op_assign
id|PLIP_CN_CLOSING
suffix:semicolon
id|nl-&gt;is_deferred
op_assign
l_int|1
suffix:semicolon
id|queue_task
c_func
(paren
op_amp
id|nl-&gt;deferred
comma
op_amp
id|tq_timer
)paren
suffix:semicolon
id|outb
c_func
(paren
id|PAR_INTR_ON
comma
id|PAR_CONTROL
c_func
(paren
id|dev
)paren
)paren
suffix:semicolon
id|enable_irq
c_func
(paren
id|dev-&gt;irq
)paren
suffix:semicolon
r_return
id|OK
suffix:semicolon
)brace
r_return
id|OK
suffix:semicolon
)brace
r_static
r_int
DECL|function|plip_connection_close
id|plip_connection_close
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
r_struct
id|net_local
op_star
id|nl
comma
r_struct
id|plip_local
op_star
id|snd
comma
r_struct
id|plip_local
op_star
id|rcv
)paren
(brace
id|cli
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|nl-&gt;connection
op_eq
id|PLIP_CN_CLOSING
)paren
(brace
id|nl-&gt;connection
op_assign
id|PLIP_CN_NONE
suffix:semicolon
id|dev-&gt;tbusy
op_assign
l_int|0
suffix:semicolon
id|mark_bh
c_func
(paren
id|NET_BH
)paren
suffix:semicolon
)brace
id|sti
c_func
(paren
)paren
suffix:semicolon
r_return
id|OK
suffix:semicolon
)brace
multiline_comment|/* PLIP_ERROR --- wait till other end settled */
r_static
r_int
DECL|function|plip_error
id|plip_error
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
r_struct
id|net_local
op_star
id|nl
comma
r_struct
id|plip_local
op_star
id|snd
comma
r_struct
id|plip_local
op_star
id|rcv
)paren
(brace
r_int
r_char
id|status
suffix:semicolon
id|status
op_assign
id|inb
c_func
(paren
id|PAR_STATUS
c_func
(paren
id|dev
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|status
op_amp
l_int|0xf8
)paren
op_eq
l_int|0x80
)paren
(brace
r_if
c_cond
(paren
id|net_debug
OG
l_int|2
)paren
id|printk
c_func
(paren
l_string|&quot;%s: reset interface.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|nl-&gt;connection
op_assign
id|PLIP_CN_NONE
suffix:semicolon
id|dev-&gt;tbusy
op_assign
l_int|0
suffix:semicolon
id|dev-&gt;interrupt
op_assign
l_int|0
suffix:semicolon
id|outb
c_func
(paren
id|PAR_INTR_ON
comma
id|PAR_CONTROL
c_func
(paren
id|dev
)paren
)paren
suffix:semicolon
id|enable_irq
c_func
(paren
id|dev-&gt;irq
)paren
suffix:semicolon
id|mark_bh
c_func
(paren
id|NET_BH
)paren
suffix:semicolon
)brace
r_else
(brace
id|nl-&gt;is_deferred
op_assign
l_int|1
suffix:semicolon
id|queue_task
c_func
(paren
op_amp
id|nl-&gt;deferred
comma
op_amp
id|tq_timer
)paren
suffix:semicolon
)brace
r_return
id|OK
suffix:semicolon
)brace
"&f;"
multiline_comment|/* Handle the parallel port interrupts. */
r_static
r_void
DECL|function|plip_interrupt
id|plip_interrupt
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_struct
id|device
op_star
id|dev
op_assign
(paren
r_struct
id|device
op_star
)paren
id|irq2dev_map
(braket
id|irq
)braket
suffix:semicolon
r_struct
id|net_local
op_star
id|nl
op_assign
(paren
r_struct
id|net_local
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_struct
id|plip_local
op_star
id|rcv
op_assign
op_amp
id|nl-&gt;rcv_data
suffix:semicolon
r_int
r_char
id|c0
suffix:semicolon
r_if
c_cond
(paren
id|dev
op_eq
l_int|NULL
)paren
(brace
id|printk
(paren
l_string|&quot;plip_interrupt: irq %d for unknown device.&bslash;n&quot;
comma
id|irq
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|dev-&gt;interrupt
)paren
r_return
suffix:semicolon
id|c0
op_assign
id|inb
c_func
(paren
id|PAR_STATUS
c_func
(paren
id|dev
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|c0
op_amp
l_int|0xf8
)paren
op_ne
l_int|0xc0
)paren
(brace
r_if
c_cond
(paren
id|net_debug
OG
l_int|1
)paren
id|printk
c_func
(paren
l_string|&quot;%s: spurious interrupt&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|dev-&gt;interrupt
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|net_debug
OG
l_int|3
)paren
id|printk
c_func
(paren
l_string|&quot;%s: interrupt.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|nl-&gt;connection
)paren
(brace
r_case
id|PLIP_CN_CLOSING
suffix:colon
id|dev-&gt;tbusy
op_assign
l_int|0
suffix:semicolon
r_case
id|PLIP_CN_NONE
suffix:colon
r_case
id|PLIP_CN_SEND
suffix:colon
id|dev-&gt;last_rx
op_assign
id|jiffies
suffix:semicolon
id|rcv-&gt;state
op_assign
id|PLIP_PK_TRIGGER
suffix:semicolon
id|nl-&gt;connection
op_assign
id|PLIP_CN_RECEIVE
suffix:semicolon
id|nl-&gt;timeout_count
op_assign
l_int|0
suffix:semicolon
id|queue_task
c_func
(paren
op_amp
id|nl-&gt;immediate
comma
op_amp
id|tq_immediate
)paren
suffix:semicolon
id|mark_bh
c_func
(paren
id|IMMEDIATE_BH
)paren
suffix:semicolon
id|sti
c_func
(paren
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|PLIP_CN_RECEIVE
suffix:colon
id|sti
c_func
(paren
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;%s: receive interrupt when receiving packet&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|PLIP_CN_ERROR
suffix:colon
id|sti
c_func
(paren
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;%s: receive interrupt in error state&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
"&f;"
multiline_comment|/* We don&squot;t need to send arp, for plip is point-to-point. */
r_static
r_int
DECL|function|plip_rebuild_header
id|plip_rebuild_header
c_func
(paren
r_void
op_star
id|buff
comma
r_struct
id|device
op_star
id|dev
comma
r_int
r_int
id|dst
comma
r_struct
id|sk_buff
op_star
id|skb
)paren
(brace
r_struct
id|net_local
op_star
id|nl
op_assign
(paren
r_struct
id|net_local
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_struct
id|ethhdr
op_star
id|eth
op_assign
(paren
r_struct
id|ethhdr
op_star
)paren
id|buff
suffix:semicolon
r_int
id|i
suffix:semicolon
r_if
c_cond
(paren
(paren
id|dev-&gt;flags
op_amp
id|IFF_NOARP
)paren
op_eq
l_int|0
)paren
r_return
id|nl
op_member_access_from_pointer
id|orig_rebuild_header
c_func
(paren
id|buff
comma
id|dev
comma
id|dst
comma
id|skb
)paren
suffix:semicolon
r_if
c_cond
(paren
id|eth-&gt;h_proto
op_ne
id|htons
c_func
(paren
id|ETH_P_IP
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;plip_rebuild_header: Don&squot;t know how to resolve type %d addresses?&bslash;n&quot;
comma
(paren
r_int
)paren
id|eth-&gt;h_proto
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|eth-&gt;h_source
comma
id|dev-&gt;dev_addr
comma
id|dev-&gt;addr_len
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|ETH_ALEN
op_minus
r_sizeof
(paren
r_int
r_int
)paren
suffix:semicolon
id|i
op_increment
)paren
id|eth-&gt;h_dest
(braket
id|i
)braket
op_assign
l_int|0xfc
suffix:semicolon
id|memcpy
c_func
(paren
op_amp
(paren
id|eth-&gt;h_dest
(braket
id|i
)braket
)paren
comma
op_amp
id|dst
comma
r_sizeof
(paren
r_int
r_int
)paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_int
DECL|function|plip_tx_packet
id|plip_tx_packet
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|device
op_star
id|dev
)paren
(brace
r_struct
id|net_local
op_star
id|nl
op_assign
(paren
r_struct
id|net_local
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_struct
id|plip_local
op_star
id|snd
op_assign
op_amp
id|nl-&gt;snd_data
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;tbusy
)paren
r_return
l_int|1
suffix:semicolon
multiline_comment|/* If some higher layer thinks we&squot;ve missed an tx-done interrupt&n;&t;   we are passed NULL. Caution: dev_tint() handles the cli()/sti()&n;&t;   itself. */
r_if
c_cond
(paren
id|skb
op_eq
l_int|NULL
)paren
(brace
id|dev_tint
c_func
(paren
id|dev
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|set_bit
c_func
(paren
l_int|0
comma
(paren
r_void
op_star
)paren
op_amp
id|dev-&gt;tbusy
)paren
op_ne
l_int|0
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%s: Transmitter access conflict.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|skb-&gt;len
OG
id|dev-&gt;mtu
op_plus
id|dev-&gt;hard_header_len
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%s: packet too big, %d.&bslash;n&quot;
comma
id|dev-&gt;name
comma
(paren
r_int
)paren
id|skb-&gt;len
)paren
suffix:semicolon
id|dev-&gt;tbusy
op_assign
l_int|0
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|net_debug
OG
l_int|2
)paren
id|printk
c_func
(paren
l_string|&quot;%s: send request&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|dev-&gt;trans_start
op_assign
id|jiffies
suffix:semicolon
id|snd-&gt;skb
op_assign
id|skb
suffix:semicolon
id|snd-&gt;length.h
op_assign
id|skb-&gt;len
suffix:semicolon
id|snd-&gt;state
op_assign
id|PLIP_PK_TRIGGER
suffix:semicolon
r_if
c_cond
(paren
id|nl-&gt;connection
op_eq
id|PLIP_CN_NONE
)paren
(brace
id|nl-&gt;connection
op_assign
id|PLIP_CN_SEND
suffix:semicolon
id|nl-&gt;timeout_count
op_assign
l_int|0
suffix:semicolon
)brace
id|queue_task
c_func
(paren
op_amp
id|nl-&gt;immediate
comma
op_amp
id|tq_immediate
)paren
suffix:semicolon
id|mark_bh
c_func
(paren
id|IMMEDIATE_BH
)paren
suffix:semicolon
id|sti
c_func
(paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Open/initialize the board.  This is called (in the current kernel)&n;   sometime after booting when the &squot;ifconfig&squot; program is run.&n;&n;   This routine gets exclusive access to the parallel port by allocating&n;   its IRQ line.&n; */
r_static
r_int
DECL|function|plip_open
id|plip_open
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
r_struct
id|net_local
op_star
id|nl
op_assign
(paren
r_struct
id|net_local
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_int
id|i
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;irq
op_eq
l_int|0
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%s: IRQ is not set.  Please set it by ifconfig.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_return
op_minus
id|EAGAIN
suffix:semicolon
)brace
id|cli
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|request_irq
c_func
(paren
id|dev-&gt;irq
comma
id|plip_interrupt
comma
l_int|0
comma
id|dev-&gt;name
comma
l_int|NULL
)paren
op_ne
l_int|0
)paren
(brace
id|sti
c_func
(paren
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;%s: couldn&squot;t get IRQ %d.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|dev-&gt;irq
)paren
suffix:semicolon
r_return
op_minus
id|EAGAIN
suffix:semicolon
)brace
id|irq2dev_map
(braket
id|dev-&gt;irq
)braket
op_assign
id|dev
suffix:semicolon
id|sti
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* Clear the data port. */
id|outb
(paren
l_int|0x00
comma
id|PAR_DATA
c_func
(paren
id|dev
)paren
)paren
suffix:semicolon
multiline_comment|/* Enable rx interrupt. */
id|outb
c_func
(paren
id|PAR_INTR_ON
comma
id|PAR_CONTROL
c_func
(paren
id|dev
)paren
)paren
suffix:semicolon
multiline_comment|/* Initialize the state machine. */
id|nl-&gt;rcv_data.state
op_assign
id|nl-&gt;snd_data.state
op_assign
id|PLIP_PK_DONE
suffix:semicolon
id|nl-&gt;rcv_data.skb
op_assign
id|nl-&gt;snd_data.skb
op_assign
l_int|NULL
suffix:semicolon
id|nl-&gt;connection
op_assign
id|PLIP_CN_NONE
suffix:semicolon
id|nl-&gt;is_deferred
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Fill in the MAC-level header. */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|ETH_ALEN
op_minus
r_sizeof
(paren
r_int
r_int
)paren
suffix:semicolon
id|i
op_increment
)paren
id|dev-&gt;dev_addr
(braket
id|i
)braket
op_assign
l_int|0xfc
suffix:semicolon
id|memcpy
c_func
(paren
op_amp
(paren
id|dev-&gt;dev_addr
(braket
id|i
)braket
)paren
comma
op_amp
id|dev-&gt;pa_addr
comma
r_sizeof
(paren
r_int
r_int
)paren
)paren
suffix:semicolon
id|dev-&gt;interrupt
op_assign
l_int|0
suffix:semicolon
id|dev-&gt;start
op_assign
l_int|1
suffix:semicolon
id|dev-&gt;tbusy
op_assign
l_int|0
suffix:semicolon
id|MOD_INC_USE_COUNT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* The inverse routine to plip_open (). */
r_static
r_int
DECL|function|plip_close
id|plip_close
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
r_struct
id|net_local
op_star
id|nl
op_assign
(paren
r_struct
id|net_local
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_struct
id|plip_local
op_star
id|snd
op_assign
op_amp
id|nl-&gt;snd_data
suffix:semicolon
r_struct
id|plip_local
op_star
id|rcv
op_assign
op_amp
id|nl-&gt;rcv_data
suffix:semicolon
id|dev-&gt;tbusy
op_assign
l_int|1
suffix:semicolon
id|dev-&gt;start
op_assign
l_int|0
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|free_irq
c_func
(paren
id|dev-&gt;irq
comma
l_int|NULL
)paren
suffix:semicolon
id|irq2dev_map
(braket
id|dev-&gt;irq
)braket
op_assign
l_int|NULL
suffix:semicolon
id|nl-&gt;is_deferred
op_assign
l_int|0
suffix:semicolon
id|nl-&gt;connection
op_assign
id|PLIP_CN_NONE
suffix:semicolon
id|sti
c_func
(paren
)paren
suffix:semicolon
id|outb
c_func
(paren
l_int|0x00
comma
id|PAR_DATA
c_func
(paren
id|dev
)paren
)paren
suffix:semicolon
id|snd-&gt;state
op_assign
id|PLIP_PK_DONE
suffix:semicolon
r_if
c_cond
(paren
id|snd-&gt;skb
)paren
(brace
id|dev_kfree_skb
c_func
(paren
id|snd-&gt;skb
comma
id|FREE_WRITE
)paren
suffix:semicolon
id|snd-&gt;skb
op_assign
l_int|NULL
suffix:semicolon
)brace
id|rcv-&gt;state
op_assign
id|PLIP_PK_DONE
suffix:semicolon
r_if
c_cond
(paren
id|rcv-&gt;skb
)paren
(brace
id|rcv-&gt;skb-&gt;free
op_assign
l_int|1
suffix:semicolon
id|kfree_skb
c_func
(paren
id|rcv-&gt;skb
comma
id|FREE_READ
)paren
suffix:semicolon
id|rcv-&gt;skb
op_assign
l_int|NULL
suffix:semicolon
)brace
multiline_comment|/* Reset. */
id|outb
c_func
(paren
l_int|0x00
comma
id|PAR_CONTROL
c_func
(paren
id|dev
)paren
)paren
suffix:semicolon
id|MOD_DEC_USE_COUNT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_struct
id|enet_statistics
op_star
DECL|function|plip_get_stats
id|plip_get_stats
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
r_struct
id|net_local
op_star
id|nl
op_assign
(paren
r_struct
id|net_local
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_struct
id|enet_statistics
op_star
id|r
op_assign
op_amp
id|nl-&gt;enet_stats
suffix:semicolon
r_return
id|r
suffix:semicolon
)brace
r_static
r_int
DECL|function|plip_config
id|plip_config
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
r_struct
id|ifmap
op_star
id|map
)paren
(brace
r_if
c_cond
(paren
id|dev-&gt;flags
op_amp
id|IFF_UP
)paren
r_return
op_minus
id|EBUSY
suffix:semicolon
r_if
c_cond
(paren
id|map-&gt;base_addr
op_ne
(paren
r_int
r_int
)paren
op_minus
l_int|1
op_logical_and
id|map-&gt;base_addr
op_ne
id|dev-&gt;base_addr
)paren
id|printk
c_func
(paren
l_string|&quot;%s: You cannot change base_addr of this interface (ignored).&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_if
c_cond
(paren
id|map-&gt;irq
op_ne
(paren
r_int
r_char
)paren
op_minus
l_int|1
)paren
id|dev-&gt;irq
op_assign
id|map-&gt;irq
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_int
DECL|function|plip_ioctl
id|plip_ioctl
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
r_struct
id|ifreq
op_star
id|rq
comma
r_int
id|cmd
)paren
(brace
r_struct
id|net_local
op_star
id|nl
op_assign
(paren
r_struct
id|net_local
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_struct
id|plipconf
op_star
id|pc
op_assign
(paren
r_struct
id|plipconf
op_star
)paren
op_amp
id|rq-&gt;ifr_data
suffix:semicolon
r_switch
c_cond
(paren
id|pc-&gt;pcmd
)paren
(brace
r_case
id|PLIP_GET_TIMEOUT
suffix:colon
id|pc-&gt;trigger
op_assign
id|nl-&gt;trigger
suffix:semicolon
id|pc-&gt;nibble
op_assign
id|nl-&gt;nibble
suffix:semicolon
r_break
suffix:semicolon
r_case
id|PLIP_SET_TIMEOUT
suffix:colon
id|nl-&gt;trigger
op_assign
id|pc-&gt;trigger
suffix:semicolon
id|nl-&gt;nibble
op_assign
id|pc-&gt;nibble
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
r_return
op_minus
id|EOPNOTSUPP
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
"&f;"
macro_line|#ifdef MODULE
DECL|variable|io
r_static
r_int
id|io
(braket
)braket
op_assign
(brace
l_int|0
comma
l_int|0
comma
l_int|0
)brace
suffix:semicolon
DECL|variable|irq
r_static
r_int
id|irq
(braket
)braket
op_assign
(brace
l_int|0
comma
l_int|0
comma
l_int|0
)brace
suffix:semicolon
DECL|variable|dev_plip
r_static
r_struct
id|device
id|dev_plip
(braket
)braket
op_assign
(brace
(brace
l_string|&quot;plip0&quot;
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
multiline_comment|/* memory */
l_int|0x3BC
comma
l_int|5
comma
multiline_comment|/* base, irq */
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|NULL
comma
id|plip_init
)brace
comma
(brace
l_string|&quot;plip1&quot;
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
multiline_comment|/* memory */
l_int|0x378
comma
l_int|7
comma
multiline_comment|/* base, irq */
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|NULL
comma
id|plip_init
)brace
comma
(brace
l_string|&quot;plip2&quot;
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
multiline_comment|/* memory */
l_int|0x278
comma
l_int|2
comma
multiline_comment|/* base, irq */
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|NULL
comma
id|plip_init
)brace
)brace
suffix:semicolon
r_int
DECL|function|init_module
id|init_module
c_func
(paren
r_void
)paren
(brace
r_int
id|no_parameters
op_assign
l_int|1
suffix:semicolon
r_int
id|devices
op_assign
l_int|0
suffix:semicolon
r_int
id|i
suffix:semicolon
multiline_comment|/* When user feeds parameters, use them */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|3
suffix:semicolon
id|i
op_increment
)paren
(brace
r_int
id|specified
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|io
(braket
id|i
)braket
op_ne
l_int|0
)paren
(brace
id|dev_plip
(braket
id|i
)braket
dot
id|base_addr
op_assign
id|io
(braket
id|i
)braket
suffix:semicolon
id|specified
op_increment
suffix:semicolon
)brace
r_if
c_cond
(paren
id|irq
(braket
id|i
)braket
op_ne
l_int|0
)paren
(brace
id|dev_plip
(braket
id|i
)braket
dot
id|irq
op_assign
id|irq
(braket
id|i
)braket
suffix:semicolon
id|specified
op_increment
suffix:semicolon
)brace
r_if
c_cond
(paren
id|specified
)paren
(brace
r_if
c_cond
(paren
id|register_netdev
c_func
(paren
op_amp
id|dev_plip
(braket
id|i
)braket
)paren
op_ne
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;plip%d: Not found&bslash;n&quot;
comma
id|i
)paren
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
id|no_parameters
op_assign
l_int|0
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
op_logical_neg
id|no_parameters
)paren
r_return
l_int|0
suffix:semicolon
multiline_comment|/* No parameters.  Default action is probing all interfaces. */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|3
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|register_netdev
c_func
(paren
op_amp
id|dev_plip
(braket
id|i
)braket
)paren
op_eq
l_int|0
)paren
id|devices
op_increment
suffix:semicolon
)brace
r_if
c_cond
(paren
id|devices
op_eq
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;plip: no interfaces found&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
r_void
DECL|function|cleanup_module
id|cleanup_module
c_func
(paren
r_void
)paren
(brace
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|3
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|dev_plip
(braket
id|i
)braket
dot
id|priv
)paren
(brace
id|unregister_netdev
c_func
(paren
op_amp
id|dev_plip
(braket
id|i
)braket
)paren
suffix:semicolon
id|release_region
c_func
(paren
id|PAR_DATA
c_func
(paren
op_amp
id|dev_plip
(braket
id|i
)braket
)paren
comma
(paren
id|PAR_DATA
c_func
(paren
op_amp
id|dev_plip
(braket
id|i
)braket
)paren
op_eq
l_int|0x3bc
)paren
ques
c_cond
l_int|3
suffix:colon
l_int|8
)paren
suffix:semicolon
id|kfree_s
c_func
(paren
id|dev_plip
(braket
id|i
)braket
dot
id|priv
comma
r_sizeof
(paren
r_struct
id|net_local
)paren
)paren
suffix:semicolon
id|dev_plip
(braket
id|i
)braket
dot
id|priv
op_assign
l_int|NULL
suffix:semicolon
)brace
)brace
)brace
macro_line|#endif /* MODULE */
"&f;"
multiline_comment|/*&n; * Local variables:&n; * compile-command: &quot;gcc -DMODULE -DMODVERSIONS -D__KERNEL__ -Wall -Wstrict-prototypes -O2 -g -fomit-frame-pointer -pipe -m486 -c plip.c&quot;&n; * End:&n; */
eof
