multiline_comment|/*  de4x5.c: A DIGITAL DE425/DE434/DE435/DE500 ethernet driver for Linux.&n;&n;    Copyright 1994, 1995 Digital Equipment Corporation.&n;&n;    This software may be used and distributed according to the terms of&n;    the GNU Public License, incorporated herein by reference.&n;&n;    This driver is written for the Digital Equipment Corporation series&n;    of EtherWORKS ethernet cards:&n;&n;&t;DE425 TP/COAX EISA&n;&t;DE434 TP PCI&n;&t;DE435 TP/COAX/AUI PCI&n;&t;DE500 10/100 PCI Fasternet&n;&n;    The driver has been tested on a relatively busy network using the DE425,&n;    DE434, DE435 and DE500 cards and benchmarked with &squot;ttcp&squot;: it transferred&n;    16M of data to a DECstation 5000/200 as follows:&n;&n;                TCP           UDP&n;             TX     RX     TX     RX&n;    DE425   1030k  997k   1170k  1128k&n;    DE434   1063k  995k   1170k  1125k&n;    DE435   1063k  995k   1170k  1125k&n;    DE500   1063k  998k   1170k  1125k  in 10Mb/s mode&n;&n;    All  values are typical (in   kBytes/sec) from a  sample  of 4 for  each&n;    measurement. Their error is +/-20k on a quiet (private) network and also&n;    depend on what load the CPU has.&n;&n;    The author may    be  reached as davies@wanton.lkg.dec.com  or   Digital&n;    Equipment Corporation, 550 King Street, Littleton MA 01460.&n;&n;    =========================================================================&n;    This driver has been written  substantially  from scratch, although  its&n;    inheritance of style and stack interface from &squot;ewrk3.c&squot; and in turn from&n;    Donald Becker&squot;s &squot;lance.c&squot; should be obvious.&n;&n;    Upto 15 EISA cards can be supported under this driver, limited primarily&n;    by the available IRQ lines.  I have  checked different configurations of&n;    multiple depca, EtherWORKS 3 cards and de4x5 cards and  have not found a&n;    problem yet (provided you have at least depca.c v0.38) ...&n;&n;    PCI support  has been added  to allow the  driver to work with the DE434&n;    and  DE435 cards. The I/O  accesses  are a  bit of a   kludge due to the&n;    differences  in the  EISA and PCI    CSR address offsets  from the  base&n;    address.&n;&n;    The ability to load  this driver as a loadable  module has been included&n;    and  used extensively during the  driver development (to save those long&n;    reboot sequences).  Loadable module support under  PCI has been achieved&n;    by letting any I/O address less than 0x1000 be assigned as:&n;&n;                       0xghh&n;&n;    where g is the bus number (usually 0 until the BIOS&squot;s get fixed)&n;         hh is the device number (max is 32 per bus).&n;&n;    Essentially, the I/O address and IRQ information  are ignored and filled&n;    in later by  the PCI BIOS   during the PCI  probe.  Note  that the board&n;    should be in the system at boot time so that its I/O address and IRQ are&n;    allocated by the PCI BIOS automatically. The special case of device 0 on&n;    bus 0  is  not allowed  as  the probe  will think   you&squot;re autoprobing a&n;    module.&n;&n;    To utilise this ability, you have to do 8 things:&n;&n;    0) have a copy of the loadable modules code installed on your system.&n;    1) copy de4x5.c from the  /linux/drivers/net directory to your favourite&n;    temporary directory.&n;    2) edit the  source code near  line 2762 to reflect  the I/O address and&n;    IRQ you&squot;re using, or assign these when loading by:&n;&n;                   insmod de4x5.o irq=x io=y&n;&n;    3) compile  de4x5.c, but include -DMODULE in  the command line to ensure&n;    that the correct bits are compiled (see end of source code).&n;    4) if you are wanting to add a new  card, goto 5. Otherwise, recompile a&n;    kernel with the de4x5 configuration turned off and reboot.&n;    5) insmod de4x5.o&n;    6) run the net startup bits for your new eth?? interface manually &n;    (usually /etc/rc.inet[12] at boot time). &n;    7) enjoy!&n;&n;    Note that autoprobing is not allowed in loadable modules - the system is&n;    already up and running and you&squot;re messing with interrupts.&n;&n;    To unload a module, turn off the associated interface &n;    &squot;ifconfig eth?? down&squot; then &squot;rmmod de4x5&squot;.&n;&n;    Automedia detection is included so that in  principal you can disconnect&n;    from, e.g.  TP, reconnect  to BNC  and  things will still work  (after a&n;    pause whilst the   driver figures out   where its media went).  My tests&n;    using ping showed that it appears to work....&n;&n;    A compile time  switch to allow  Znyx  recognition has been  added. This&n;    &quot;feature&quot; is in no way supported nor tested  in this driver and the user&n;    may use it at his/her sole discretion.  I have had 2 conflicting reports&n;    that  my driver  will or   won&squot;t  work with   Znyx. Try Donald  Becker&squot;s&n;    &squot;tulip.c&squot; if this driver doesn&squot;t work for  you. I will not be supporting&n;    Znyx cards since I have no information on them  and can&squot;t test them in a&n;    system.&n;&n;    TO DO:&n;    ------&n;&n;&n;    Revision History&n;    ----------------&n;&n;    Version   Date        Description&n;  &n;      0.1     17-Nov-94   Initial writing. ALPHA code release.&n;      0.2     13-Jan-95   Added PCI support for DE435&squot;s.&n;      0.21    19-Jan-95   Added auto media detection.&n;      0.22    10-Feb-95   Fix interrupt handler call &lt;chris@cosy.sbg.ac.at&gt;.&n;                          Fix recognition bug reported by &lt;bkm@star.rl.ac.uk&gt;.&n;&t;&t;&t;  Add request/release_region code.&n;&t;&t;&t;  Add loadable modules support for PCI.&n;&t;&t;&t;  Clean up loadable modules support.&n;      0.23    28-Feb-95   Added DC21041 and DC21140 support. &n;                          Fix missed frame counter value and initialisation.&n;&t;&t;&t;  Fixed EISA probe.&n;      0.24    11-Apr-95   Change delay routine to use &lt;linux/udelay&gt;.&n;                          Change TX_BUFFS_AVAIL macro.&n;&t;&t;&t;  Change media autodetection to allow manual setting.&n;&t;&t;&t;  Completed DE500 (DC21140) support.&n;      0.241   18-Apr-95   Interim release without DE500 Autosense Algorithm.&n;      0.242   10-May-95   Minor changes&n;      0.30    12-Jun-95   Timer fix for DC21140&n;                          Portability changes.&n;&t;&t;&t;  Add ALPHA changes from &lt;jestabro@ant.tay1.dec.com&gt;.&n;&t;&t;&t;  Add DE500 semi automatic autosense.&n;&t;&t;&t;  Add Link Fail interrupt TP failure detection.&n;&t;&t;&t;  Add timer based link change detection.&n;&t;&t;&t;  Plugged a memory leak in de4x5_queue_pkt().&n;      0.31    13-Jun-95   Fixed PCI stuff for 1.3.1&n;      0.32    26-Jun-95   Added verify_area() calls in de4x5_ioctl() from&n;                          suggestion by &lt;heiko@colossus.escape.de&gt;&n;&n;    =========================================================================&n;*/
DECL|variable|version
r_static
r_const
r_char
op_star
id|version
op_assign
l_string|&quot;de4x5.c:v0.32 6/26/95 davies@wanton.lkg.dec.com&bslash;n&quot;
suffix:semicolon
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/interrupt.h&gt;
macro_line|#include &lt;linux/ptrace.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/ioport.h&gt;
macro_line|#include &lt;linux/malloc.h&gt;
macro_line|#include &lt;linux/bios32.h&gt;
macro_line|#include &lt;linux/pci.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;asm/bitops.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/dma.h&gt;
macro_line|#include &lt;asm/segment.h&gt;
macro_line|#include &lt;linux/netdevice.h&gt;
macro_line|#include &lt;linux/etherdevice.h&gt;
macro_line|#include &lt;linux/skbuff.h&gt;
macro_line|#include &lt;linux/time.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/unistd.h&gt;
macro_line|#include &quot;de4x5.h&quot;
macro_line|#ifdef DE4X5_DEBUG
DECL|variable|de4x5_debug
r_static
r_int
id|de4x5_debug
op_assign
id|DE4X5_DEBUG
suffix:semicolon
macro_line|#else
DECL|variable|de4x5_debug
r_static
r_int
id|de4x5_debug
op_assign
l_int|1
suffix:semicolon
macro_line|#endif
macro_line|#ifdef DE4X5_AUTOSENSE              /* Should be done on a per adapter basis */
DECL|variable|de4x5_autosense
r_static
r_int
id|de4x5_autosense
op_assign
id|DE4X5_AUTOSENSE
suffix:semicolon
macro_line|#else
DECL|variable|de4x5_autosense
r_static
r_int
id|de4x5_autosense
op_assign
id|AUTO
suffix:semicolon
multiline_comment|/* Do auto media/mode sensing */
macro_line|#endif
macro_line|#ifdef DE4X5_FULL_DUPLEX            /* Should be done on a per adapter basis */
DECL|variable|de4x5_full_duplex
r_static
id|s32
id|de4x5_full_duplex
op_assign
l_int|1
suffix:semicolon
macro_line|#else
DECL|variable|de4x5_full_duplex
r_static
id|s32
id|de4x5_full_duplex
op_assign
l_int|0
suffix:semicolon
macro_line|#endif
DECL|macro|DE4X5_NDA
mdefine_line|#define DE4X5_NDA 0xffe0            /* No Device (I/O) Address */
multiline_comment|/*&n;** Ethernet PROM defines&n;*/
DECL|macro|PROBE_LENGTH
mdefine_line|#define PROBE_LENGTH    32
DECL|macro|ETH_PROM_SIG
mdefine_line|#define ETH_PROM_SIG    0xAA5500FFUL
multiline_comment|/*&n;** Ethernet Info&n;*/
DECL|macro|PKT_BUF_SZ
mdefine_line|#define PKT_BUF_SZ&t;1536            /* Buffer size for each Tx/Rx buffer */
DECL|macro|MAX_PKT_SZ
mdefine_line|#define MAX_PKT_SZ   &t;1514            /* Maximum ethernet packet length */
DECL|macro|MAX_DAT_SZ
mdefine_line|#define MAX_DAT_SZ   &t;1500            /* Maximum ethernet data length */
DECL|macro|MIN_DAT_SZ
mdefine_line|#define MIN_DAT_SZ   &t;1               /* Minimum ethernet data length */
DECL|macro|PKT_HDR_LEN
mdefine_line|#define PKT_HDR_LEN     14              /* Addresses and data length info */
DECL|macro|FAKE_FRAME_LEN
mdefine_line|#define FAKE_FRAME_LEN  (MAX_PKT_SZ + 1)
DECL|macro|QUEUE_PKT_TIMEOUT
mdefine_line|#define QUEUE_PKT_TIMEOUT (3*HZ)        /* 3 second timeout */
DECL|macro|CRC_POLYNOMIAL_BE
mdefine_line|#define CRC_POLYNOMIAL_BE 0x04c11db7UL   /* Ethernet CRC, big endian */
DECL|macro|CRC_POLYNOMIAL_LE
mdefine_line|#define CRC_POLYNOMIAL_LE 0xedb88320UL   /* Ethernet CRC, little endian */
multiline_comment|/*&n;** EISA bus defines&n;*/
DECL|macro|DE4X5_EISA_IO_PORTS
mdefine_line|#define DE4X5_EISA_IO_PORTS   0x0c00     /* I/O port base address, slot 0 */
DECL|macro|DE4X5_EISA_TOTAL_SIZE
mdefine_line|#define DE4X5_EISA_TOTAL_SIZE 0xfff      /* I/O address extent */
DECL|macro|MAX_EISA_SLOTS
mdefine_line|#define MAX_EISA_SLOTS 16
DECL|macro|EISA_SLOT_INC
mdefine_line|#define EISA_SLOT_INC 0x1000
DECL|macro|DE4X5_SIGNATURE
mdefine_line|#define DE4X5_SIGNATURE {&quot;DE425&quot;,&quot;&quot;}
DECL|macro|DE4X5_NAME_LENGTH
mdefine_line|#define DE4X5_NAME_LENGTH 8
multiline_comment|/*&n;** PCI Bus defines&n;*/
DECL|macro|PCI_MAX_BUS_NUM
mdefine_line|#define PCI_MAX_BUS_NUM 8
DECL|macro|DE4X5_PCI_TOTAL_SIZE
mdefine_line|#define DE4X5_PCI_TOTAL_SIZE 0x80        /* I/O address extent */
DECL|macro|DE4X5_CLASS_CODE
mdefine_line|#define DE4X5_CLASS_CODE     0x00020000  /* Network controller, Ethernet */
multiline_comment|/*&n;** Memory Alignment. Each descriptor is 4 longwords long. To force a&n;** particular alignment on the TX descriptor, adjust DESC_SKIP_LEN and&n;** DESC_ALIGN. ALIGN aligns the start address of the private memory area&n;** and hence the RX descriptor ring&squot;s first entry. &n;*/
DECL|macro|ALIGN4
mdefine_line|#define ALIGN4      ((u_long)4 - 1)    /* 1 longword align */
DECL|macro|ALIGN8
mdefine_line|#define ALIGN8      ((u_long)8 - 1)    /* 2 longword align */
DECL|macro|ALIGN16
mdefine_line|#define ALIGN16     ((u_long)16 - 1)   /* 4 longword align */
DECL|macro|ALIGN32
mdefine_line|#define ALIGN32     ((u_long)32 - 1)   /* 8 longword align */
DECL|macro|ALIGN64
mdefine_line|#define ALIGN64     ((u_long)64 - 1)   /* 16 longword align */
DECL|macro|ALIGN128
mdefine_line|#define ALIGN128    ((u_long)128 - 1)  /* 32 longword align */
DECL|macro|ALIGN
mdefine_line|#define ALIGN         ALIGN32          /* Keep the DC21040 happy... */
DECL|macro|CACHE_ALIGN
mdefine_line|#define CACHE_ALIGN   CAL_16LONG
DECL|macro|DESC_SKIP_LEN
mdefine_line|#define DESC_SKIP_LEN DSL_0            /* Must agree with DESC_ALIGN */
multiline_comment|/*#define DESC_ALIGN    u32 dummy[4]; / * Must agree with DESC_SKIP_LEN */
DECL|macro|DESC_ALIGN
mdefine_line|#define DESC_ALIGN
macro_line|#ifndef IS_NOT_DEC                     /* See README.de4x5 for using this */
DECL|variable|is_not_dec
r_static
r_int
id|is_not_dec
op_assign
l_int|0
suffix:semicolon
macro_line|#else
DECL|variable|is_not_dec
r_static
r_int
id|is_not_dec
op_assign
l_int|1
suffix:semicolon
macro_line|#endif
multiline_comment|/*&n;** DE4X5 IRQ ENABLE/DISABLE&n;*/
DECL|macro|ENABLE_IRQs
mdefine_line|#define ENABLE_IRQs { &bslash;&n;    imr |= lp-&gt;irq_en;&bslash;&n;    outl(imr, DE4X5_IMR);                   /* Enable the IRQs */&bslash;&n;}
DECL|macro|DISABLE_IRQs
mdefine_line|#define DISABLE_IRQs {&bslash;&n;    imr = inl(DE4X5_IMR);&bslash;&n;    imr &amp;= ~lp-&gt;irq_en;&bslash;&n;    outl(imr, DE4X5_IMR);                   /* Disable the IRQs */&bslash;&n;}
DECL|macro|UNMASK_IRQs
mdefine_line|#define UNMASK_IRQs {&bslash;&n;    imr |= lp-&gt;irq_mask;&bslash;&n;    outl(imr, DE4X5_IMR);                   /* Unmask the IRQs */&bslash;&n;}
DECL|macro|MASK_IRQs
mdefine_line|#define MASK_IRQs {&bslash;&n;    imr = inl(DE4X5_IMR);&bslash;&n;    imr &amp;= ~lp-&gt;irq_mask;&bslash;&n;    outl(imr, DE4X5_IMR);                   /* Mask the IRQs */&bslash;&n;}
multiline_comment|/*&n;** DE4X5 START/STOP&n;*/
DECL|macro|START_DE4X5
mdefine_line|#define START_DE4X5 {&bslash;&n;    omr = inl(DE4X5_OMR);&bslash;&n;    omr |= OMR_ST | OMR_SR;&bslash;&n;    outl(omr, DE4X5_OMR);                   /* Enable the TX and/or RX */&bslash;&n;}
DECL|macro|STOP_DE4X5
mdefine_line|#define STOP_DE4X5 {&bslash;&n;    omr = inl(DE4X5_OMR);&bslash;&n;    omr &amp;= ~(OMR_ST|OMR_SR);&bslash;&n;    outl(omr, DE4X5_OMR);                   /* Disable the TX and/or RX */ &bslash;&n;}
multiline_comment|/*&n;** DE4X5 SIA RESET&n;*/
DECL|macro|RESET_SIA
mdefine_line|#define RESET_SIA outl(0, DE4X5_SICR);      /* Reset SIA connectivity regs */
multiline_comment|/*&n;** DE500 AUTOSENSE TIMER INTERVAL (MILLISECS)&n;*/
DECL|macro|DE4X5_AUTOSENSE_MS
mdefine_line|#define DE4X5_AUTOSENSE_MS  250
multiline_comment|/*&n;** SROM Structure&n;*/
DECL|struct|de4x5_srom
r_struct
id|de4x5_srom
(brace
DECL|member|reserved
r_char
id|reserved
(braket
l_int|18
)braket
suffix:semicolon
DECL|member|version
r_char
id|version
suffix:semicolon
DECL|member|num_adapters
r_char
id|num_adapters
suffix:semicolon
DECL|member|ieee_addr
r_char
id|ieee_addr
(braket
l_int|6
)braket
suffix:semicolon
DECL|member|info
r_char
id|info
(braket
l_int|100
)braket
suffix:semicolon
DECL|member|chksum
r_int
id|chksum
suffix:semicolon
)brace
suffix:semicolon
multiline_comment|/*&n;** DE4X5 Descriptors. Make sure that all the RX buffers are contiguous&n;** and have sizes of both a power of 2 and a multiple of 4.&n;** A size of 256 bytes for each buffer could be chosen because over 90% of&n;** all packets in our network are &lt;256 bytes long and 64 longword alignment&n;** is possible. 1536 showed better &squot;ttcp&squot; performance. Take your pick. 32 TX&n;** descriptors are needed for machines with an ALPHA CPU.&n;*/
DECL|macro|NUM_RX_DESC
mdefine_line|#define NUM_RX_DESC 8                        /* Number of RX descriptors */
DECL|macro|NUM_TX_DESC
mdefine_line|#define NUM_TX_DESC 32                       /* Number of TX descriptors */
DECL|macro|BUFF_ALLOC_RETRIES
mdefine_line|#define BUFF_ALLOC_RETRIES 10                /* In case of memory shortage */
DECL|macro|RX_BUFF_SZ
mdefine_line|#define RX_BUFF_SZ 1536                      /* Power of 2 for kmalloc and */
multiline_comment|/* Multiple of 4 for DC21040 */
DECL|struct|de4x5_desc
r_struct
id|de4x5_desc
(brace
DECL|member|status
r_volatile
id|s32
id|status
suffix:semicolon
DECL|member|des1
id|u32
id|des1
suffix:semicolon
DECL|member|buf
id|u32
id|buf
suffix:semicolon
DECL|member|next
id|u32
id|next
suffix:semicolon
id|DESC_ALIGN
)brace
suffix:semicolon
multiline_comment|/*&n;** The DE4X5 private structure&n;*/
DECL|macro|DE4X5_PKT_STAT_SZ
mdefine_line|#define DE4X5_PKT_STAT_SZ 16
DECL|macro|DE4X5_PKT_BIN_SZ
mdefine_line|#define DE4X5_PKT_BIN_SZ  128                /* Should be &gt;=100 unless you&n;                                                increase DE4X5_PKT_STAT_SZ */
DECL|struct|de4x5_private
r_struct
id|de4x5_private
(brace
DECL|member|adapter_name
r_char
id|adapter_name
(braket
l_int|80
)braket
suffix:semicolon
multiline_comment|/* Adapter name */
DECL|member|rx_ring
r_struct
id|de4x5_desc
id|rx_ring
(braket
id|NUM_RX_DESC
)braket
suffix:semicolon
multiline_comment|/* RX descriptor ring */
DECL|member|tx_ring
r_struct
id|de4x5_desc
id|tx_ring
(braket
id|NUM_TX_DESC
)braket
suffix:semicolon
multiline_comment|/* TX descriptor ring */
DECL|member|skb
r_struct
id|sk_buff
op_star
id|skb
(braket
id|NUM_TX_DESC
)braket
suffix:semicolon
multiline_comment|/* TX skb for freeing when sent */
DECL|member|rx_new
DECL|member|rx_old
r_int
id|rx_new
comma
id|rx_old
suffix:semicolon
multiline_comment|/* RX descriptor ring pointers */
DECL|member|tx_new
DECL|member|tx_old
r_int
id|tx_new
comma
id|tx_old
suffix:semicolon
multiline_comment|/* TX descriptor ring pointers */
DECL|member|setup_frame
r_char
id|setup_frame
(braket
id|SETUP_FRAME_LEN
)braket
suffix:semicolon
multiline_comment|/* Holds MCA and PA info. */
DECL|member|stats
r_struct
id|enet_statistics
id|stats
suffix:semicolon
multiline_comment|/* Public stats */
r_struct
(brace
DECL|member|bins
id|u_int
id|bins
(braket
id|DE4X5_PKT_STAT_SZ
)braket
suffix:semicolon
multiline_comment|/* Private stats counters */
DECL|member|unicast
id|u_int
id|unicast
suffix:semicolon
DECL|member|multicast
id|u_int
id|multicast
suffix:semicolon
DECL|member|broadcast
id|u_int
id|broadcast
suffix:semicolon
DECL|member|excessive_collisions
id|u_int
id|excessive_collisions
suffix:semicolon
DECL|member|tx_underruns
id|u_int
id|tx_underruns
suffix:semicolon
DECL|member|excessive_underruns
id|u_int
id|excessive_underruns
suffix:semicolon
DECL|member|pktStats
)brace
id|pktStats
suffix:semicolon
DECL|member|rxRingSize
r_char
id|rxRingSize
suffix:semicolon
DECL|member|txRingSize
r_char
id|txRingSize
suffix:semicolon
DECL|member|bus
r_int
id|bus
suffix:semicolon
multiline_comment|/* EISA or PCI */
DECL|member|bus_num
r_int
id|bus_num
suffix:semicolon
multiline_comment|/* PCI Bus number */
DECL|member|chipset
r_int
id|chipset
suffix:semicolon
multiline_comment|/* DC21040, DC21041 or DC21140 */
DECL|member|irq_mask
id|s32
id|irq_mask
suffix:semicolon
multiline_comment|/* Interrupt Mask (Enable) bits */
DECL|member|irq_en
id|s32
id|irq_en
suffix:semicolon
multiline_comment|/* Summary interrupt bits */
DECL|member|media
r_int
id|media
suffix:semicolon
multiline_comment|/* Media (eg TP), mode (eg 100B)*/
DECL|member|linkProb
r_int
id|linkProb
suffix:semicolon
multiline_comment|/* Possible Link Problem */
DECL|member|autosense
r_int
id|autosense
suffix:semicolon
multiline_comment|/* Allow/disallow autosensing */
DECL|member|tx_enable
r_int
id|tx_enable
suffix:semicolon
multiline_comment|/* Enable descriptor polling */
DECL|member|lostMedia
r_int
id|lostMedia
suffix:semicolon
multiline_comment|/* Possibly lost media */
DECL|member|setup_f
r_int
id|setup_f
suffix:semicolon
multiline_comment|/* Setup frame filtering type */
)brace
suffix:semicolon
multiline_comment|/*&n;** The transmit ring full condition is described by the tx_old and tx_new&n;** pointers by:&n;**    tx_old            = tx_new    Empty ring&n;**    tx_old            = tx_new+1  Full ring&n;**    tx_old+txRingSize = tx_new+1  Full ring  (wrapped condition)&n;*/
DECL|macro|TX_BUFFS_AVAIL
mdefine_line|#define TX_BUFFS_AVAIL ((lp-&gt;tx_old&lt;=lp-&gt;tx_new)?&bslash;&n;&t;&t;&t; lp-&gt;tx_old+lp-&gt;txRingSize-lp-&gt;tx_new-1:&bslash;&n;                         lp-&gt;tx_old               -lp-&gt;tx_new-1)
multiline_comment|/*&n;** Public Functions&n;*/
r_static
r_int
id|de4x5_open
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_int
id|de4x5_queue_pkt
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_void
id|de4x5_interrupt
c_func
(paren
r_int
id|irq
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
suffix:semicolon
r_static
r_int
id|de4x5_close
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_struct
id|enet_statistics
op_star
id|de4x5_get_stats
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_void
id|set_multicast_list
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
r_int
id|num_addrs
comma
r_void
op_star
id|addrs
)paren
suffix:semicolon
r_static
r_int
id|de4x5_ioctl
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
r_struct
id|ifreq
op_star
id|rq
comma
r_int
id|cmd
)paren
suffix:semicolon
multiline_comment|/*&n;** Private functions&n;*/
r_static
r_int
id|de4x5_hw_init
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
id|u_long
id|iobase
)paren
suffix:semicolon
r_static
r_int
id|de4x5_init
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_int
id|de4x5_rx
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_int
id|de4x5_tx
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_int
id|de4x5_ast
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_int
id|autoconf_media
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_void
id|create_packet
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
r_char
op_star
id|frame
comma
r_int
id|len
)paren
suffix:semicolon
r_static
r_void
id|dce_us_delay
c_func
(paren
id|u32
id|usec
)paren
suffix:semicolon
r_static
r_void
id|dce_ms_delay
c_func
(paren
id|u32
id|msec
)paren
suffix:semicolon
r_static
r_void
id|load_packet
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
r_char
op_star
id|buf
comma
id|u32
id|flags
comma
r_struct
id|sk_buff
op_star
id|skb
)paren
suffix:semicolon
r_static
r_void
id|dc21040_autoconf
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_void
id|dc21041_autoconf
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_void
id|dc21140_autoconf
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_int
id|test_media
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
id|s32
id|irqs
comma
id|s32
id|irq_mask
comma
id|s32
id|csr13
comma
id|s32
id|csr14
comma
id|s32
id|csr15
comma
id|s32
id|msec
)paren
suffix:semicolon
multiline_comment|/*static int     test_sym_link(struct device *dev, u32 msec);*/
r_static
r_int
id|ping_media
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_void
id|reset_init_sia
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
id|s32
id|sicr
comma
id|s32
id|strr
comma
id|s32
id|sigr
)paren
suffix:semicolon
r_static
r_int
id|test_ans
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
id|s32
id|irqs
comma
id|s32
id|irq_mask
comma
id|s32
id|msec
)paren
suffix:semicolon
r_static
r_void
id|load_ms_timer
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
id|u32
id|msec
)paren
suffix:semicolon
r_static
r_int
id|EISA_signature
c_func
(paren
r_char
op_star
id|name
comma
id|s32
id|eisa_id
)paren
suffix:semicolon
r_static
r_int
id|DevicePresent
c_func
(paren
id|u_long
id|iobase
)paren
suffix:semicolon
r_static
r_int
id|srom_rd
c_func
(paren
id|u_long
id|address
comma
id|u_char
id|offset
)paren
suffix:semicolon
r_static
r_void
id|srom_latch
c_func
(paren
id|u_int
id|command
comma
id|u_long
id|address
)paren
suffix:semicolon
r_static
r_void
id|srom_command
c_func
(paren
id|u_int
id|command
comma
id|u_long
id|address
)paren
suffix:semicolon
r_static
r_void
id|srom_address
c_func
(paren
id|u_int
id|command
comma
id|u_long
id|address
comma
id|u_char
id|offset
)paren
suffix:semicolon
r_static
r_int
id|srom_data
c_func
(paren
id|u_int
id|command
comma
id|u_long
id|address
)paren
suffix:semicolon
multiline_comment|/*static void    srom_busy(u_int command, u_long address);*/
r_static
r_void
id|sendto_srom
c_func
(paren
id|u_int
id|command
comma
id|u_long
id|addr
)paren
suffix:semicolon
r_static
r_int
id|getfrom_srom
c_func
(paren
id|u_long
id|addr
)paren
suffix:semicolon
r_static
r_void
id|SetMulticastFilter
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
r_int
id|num_addrs
comma
r_char
op_star
id|addrs
)paren
suffix:semicolon
r_static
r_int
id|get_hw_addr
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_void
id|eisa_probe
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
id|u_long
id|iobase
)paren
suffix:semicolon
r_static
r_void
id|pci_probe
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
id|u_long
id|iobase
)paren
suffix:semicolon
r_static
r_struct
id|device
op_star
id|alloc_device
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
id|u_long
id|iobase
)paren
suffix:semicolon
r_static
r_char
op_star
id|build_setup_frame
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
r_int
id|mode
)paren
suffix:semicolon
r_static
r_void
id|disable_ast
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_void
id|enable_ast
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
id|u32
id|time_out
)paren
suffix:semicolon
r_static
r_void
id|kick_tx
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
suffix:semicolon
macro_line|#ifdef MODULE
r_int
id|init_module
c_func
(paren
r_void
)paren
suffix:semicolon
r_void
id|cleanup_module
c_func
(paren
r_void
)paren
suffix:semicolon
DECL|variable|autoprobed
DECL|variable|loading_module
r_static
r_int
id|autoprobed
op_assign
l_int|1
comma
id|loading_module
op_assign
l_int|1
suffix:semicolon
macro_line|# else
DECL|variable|de4x5_irq
r_static
r_int
r_char
id|de4x5_irq
(braket
)braket
op_assign
(brace
l_int|5
comma
l_int|9
comma
l_int|10
comma
l_int|11
)brace
suffix:semicolon
DECL|variable|autoprobed
DECL|variable|loading_module
r_static
r_int
id|autoprobed
op_assign
l_int|0
comma
id|loading_module
op_assign
l_int|0
suffix:semicolon
macro_line|#endif /* MODULE */
DECL|variable|name
r_static
r_char
id|name
(braket
id|DE4X5_NAME_LENGTH
op_plus
l_int|1
)braket
suffix:semicolon
DECL|variable|num_de4x5s
DECL|variable|num_eth
r_static
r_int
id|num_de4x5s
op_assign
l_int|0
comma
id|num_eth
op_assign
l_int|0
suffix:semicolon
multiline_comment|/*&n;** Kludge to get around the fact that the CSR addresses have different&n;** offsets in the PCI and EISA boards. Also note that the ethernet address&n;** PROM is accessed differently.&n;*/
DECL|struct|bus_type
r_static
r_struct
id|bus_type
(brace
DECL|member|bus
r_int
id|bus
suffix:semicolon
DECL|member|bus_num
r_int
id|bus_num
suffix:semicolon
DECL|member|device
r_int
id|device
suffix:semicolon
DECL|member|chipset
r_int
id|chipset
suffix:semicolon
DECL|member|srom
r_struct
id|de4x5_srom
id|srom
suffix:semicolon
DECL|member|autosense
r_int
id|autosense
suffix:semicolon
DECL|variable|bus
)brace
id|bus
suffix:semicolon
multiline_comment|/*&n;** Miscellaneous defines...&n;*/
DECL|macro|RESET_DE4X5
mdefine_line|#define RESET_DE4X5 {&bslash;&n;    int i;&bslash;&n;    i=inl(DE4X5_BMR);&bslash;&n;    dce_ms_delay(1);&bslash;&n;    outl(i | BMR_SWR, DE4X5_BMR);&bslash;&n;    dce_ms_delay(1);&bslash;&n;    outl(i, DE4X5_BMR);&bslash;&n;    dce_ms_delay(1);&bslash;&n;    for (i=0;i&lt;5;i++) {inl(DE4X5_BMR); dce_ms_delay(1);}&bslash;&n;    dce_ms_delay(1);&bslash;&n;}
"&f;"
DECL|function|de4x5_probe
r_int
id|de4x5_probe
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
r_int
id|tmp
op_assign
id|num_de4x5s
comma
id|status
op_assign
op_minus
id|ENODEV
suffix:semicolon
id|u_long
id|iobase
op_assign
id|dev-&gt;base_addr
suffix:semicolon
r_if
c_cond
(paren
(paren
id|iobase
op_eq
l_int|0
)paren
op_logical_and
id|loading_module
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;Autoprobing is not supported when loading a module based driver.&bslash;n&quot;
)paren
suffix:semicolon
id|status
op_assign
op_minus
id|EIO
suffix:semicolon
)brace
r_else
(brace
id|eisa_probe
c_func
(paren
id|dev
comma
id|iobase
)paren
suffix:semicolon
id|pci_probe
c_func
(paren
id|dev
comma
id|iobase
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|tmp
op_eq
id|num_de4x5s
)paren
op_logical_and
(paren
id|iobase
op_ne
l_int|0
)paren
op_logical_and
id|loading_module
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%s: de4x5_probe() cannot find device at 0x%04lx.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|iobase
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;    ** Walk the device list to check that at least one device&n;    ** initialised OK&n;    */
r_for
c_loop
(paren
suffix:semicolon
(paren
id|dev-&gt;priv
op_eq
l_int|NULL
)paren
op_logical_and
(paren
id|dev-&gt;next
op_ne
l_int|NULL
)paren
suffix:semicolon
id|dev
op_assign
id|dev-&gt;next
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;priv
)paren
id|status
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|iobase
op_eq
l_int|0
)paren
id|autoprobed
op_assign
l_int|1
suffix:semicolon
)brace
r_return
id|status
suffix:semicolon
)brace
r_static
r_int
DECL|function|de4x5_hw_init
id|de4x5_hw_init
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
id|u_long
id|iobase
)paren
(brace
r_struct
id|bus_type
op_star
id|lp
op_assign
op_amp
id|bus
suffix:semicolon
r_int
id|tmpbus
comma
id|tmpchs
comma
id|i
comma
id|j
comma
id|status
op_assign
l_int|0
suffix:semicolon
r_char
op_star
id|tmp
suffix:semicolon
multiline_comment|/* Ensure we&squot;re not sleeping */
r_if
c_cond
(paren
id|lp-&gt;chipset
op_eq
id|DC21041
)paren
(brace
id|outl
c_func
(paren
l_int|0
comma
id|PCI_CFDA
)paren
suffix:semicolon
id|dce_ms_delay
c_func
(paren
l_int|10
)paren
suffix:semicolon
)brace
id|RESET_DE4X5
suffix:semicolon
r_if
c_cond
(paren
(paren
id|inl
c_func
(paren
id|DE4X5_STS
)paren
op_amp
(paren
id|STS_TS
op_or
id|STS_RS
)paren
)paren
op_eq
l_int|0
)paren
(brace
multiline_comment|/* &n;    ** Now find out what kind of DC21040/DC21041/DC21140 board we have.&n;    */
r_if
c_cond
(paren
id|lp-&gt;bus
op_eq
id|PCI
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|is_not_dec
)paren
(brace
r_if
c_cond
(paren
(paren
id|lp-&gt;chipset
op_eq
id|DC21040
)paren
op_logical_or
(paren
id|lp-&gt;chipset
op_eq
id|DC21041
)paren
)paren
(brace
id|strcpy
c_func
(paren
id|name
comma
l_string|&quot;DE435&quot;
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|lp-&gt;chipset
op_eq
id|DC21140
)paren
(brace
id|strcpy
c_func
(paren
id|name
comma
l_string|&quot;DE500&quot;
)paren
suffix:semicolon
multiline_comment|/* Must read the SROM here! */
)brace
)brace
r_else
(brace
id|strcpy
c_func
(paren
id|name
comma
l_string|&quot;UNKNOWN&quot;
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
id|EISA_signature
c_func
(paren
id|name
comma
id|EISA_ID0
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
op_star
id|name
op_ne
l_char|&squot;&bslash;0&squot;
)paren
(brace
multiline_comment|/* found a board signature */
id|dev-&gt;base_addr
op_assign
id|iobase
suffix:semicolon
r_if
c_cond
(paren
id|lp-&gt;bus
op_eq
id|EISA
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%s: %s at %04lx (EISA slot %ld)&quot;
comma
id|dev-&gt;name
comma
id|name
comma
id|iobase
comma
(paren
(paren
id|iobase
op_rshift
l_int|12
)paren
op_amp
l_int|0x0f
)paren
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* PCI port address */
id|printk
c_func
(paren
l_string|&quot;%s: %s at %04lx (PCI bus %d, device %d)&quot;
comma
id|dev-&gt;name
comma
id|name
comma
id|iobase
comma
id|lp-&gt;bus_num
comma
id|lp-&gt;device
)paren
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;, h/w address &quot;
)paren
suffix:semicolon
id|status
op_assign
id|get_hw_addr
c_func
(paren
id|dev
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|ETH_ALEN
op_minus
l_int|1
suffix:semicolon
id|i
op_increment
)paren
(brace
multiline_comment|/* get the ethernet addr. */
id|printk
c_func
(paren
l_string|&quot;%2.2x:&quot;
comma
id|dev-&gt;dev_addr
(braket
id|i
)braket
)paren
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;%2.2x,&bslash;n&quot;
comma
id|dev-&gt;dev_addr
(braket
id|i
)braket
)paren
suffix:semicolon
id|tmpbus
op_assign
id|lp-&gt;bus
suffix:semicolon
id|tmpchs
op_assign
id|lp-&gt;chipset
suffix:semicolon
r_if
c_cond
(paren
id|status
op_eq
l_int|0
)paren
(brace
r_struct
id|de4x5_private
op_star
id|lp
suffix:semicolon
multiline_comment|/* &n;&t;** Reserve a section of kernel memory for the adapter&n;&t;** private area and the TX/RX descriptor rings.&n;&t;*/
id|dev-&gt;priv
op_assign
(paren
r_void
op_star
)paren
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|de4x5_private
)paren
op_plus
id|ALIGN
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;priv
op_eq
l_int|NULL
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
multiline_comment|/*&n;&t;** Align to a longword boundary&n;&t;*/
id|dev-&gt;priv
op_assign
(paren
r_void
op_star
)paren
(paren
(paren
(paren
id|u_long
)paren
id|dev-&gt;priv
op_plus
id|ALIGN
)paren
op_amp
op_complement
id|ALIGN
)paren
suffix:semicolon
id|lp
op_assign
(paren
r_struct
id|de4x5_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|memset
c_func
(paren
id|dev-&gt;priv
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|de4x5_private
)paren
)paren
suffix:semicolon
id|lp-&gt;bus
op_assign
id|tmpbus
suffix:semicolon
id|lp-&gt;chipset
op_assign
id|tmpchs
suffix:semicolon
multiline_comment|/*&n;&t;** Choose autosensing&n;&t;*/
r_if
c_cond
(paren
id|de4x5_autosense
op_amp
id|AUTO
)paren
(brace
id|lp-&gt;autosense
op_assign
id|AUTO
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|lp-&gt;chipset
op_ne
id|DC21140
)paren
(brace
r_if
c_cond
(paren
(paren
id|lp-&gt;chipset
op_eq
id|DC21040
)paren
op_logical_and
(paren
id|de4x5_autosense
op_amp
id|TP_NW
)paren
)paren
(brace
id|de4x5_autosense
op_assign
id|TP
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|lp-&gt;chipset
op_eq
id|DC21041
)paren
op_logical_and
(paren
id|de4x5_autosense
op_amp
id|BNC_AUI
)paren
)paren
(brace
id|de4x5_autosense
op_assign
id|BNC
suffix:semicolon
)brace
id|lp-&gt;autosense
op_assign
id|de4x5_autosense
op_amp
l_int|0x001f
suffix:semicolon
)brace
r_else
(brace
id|lp-&gt;autosense
op_assign
id|de4x5_autosense
op_amp
l_int|0x00c0
suffix:semicolon
)brace
)brace
id|sprintf
c_func
(paren
id|lp-&gt;adapter_name
comma
l_string|&quot;%s (%s)&quot;
comma
id|name
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|request_region
c_func
(paren
id|iobase
comma
(paren
id|lp-&gt;bus
op_eq
id|PCI
ques
c_cond
id|DE4X5_PCI_TOTAL_SIZE
suffix:colon
id|DE4X5_EISA_TOTAL_SIZE
)paren
comma
id|lp-&gt;adapter_name
)paren
suffix:semicolon
multiline_comment|/*&n;&t;** Allocate contiguous receive buffers, long word aligned. &n;&t;** This could be a possible memory leak if the private area&n;&t;** is ever hosed.&n;&t;*/
r_for
c_loop
(paren
id|tmp
op_assign
l_int|NULL
comma
id|j
op_assign
l_int|0
suffix:semicolon
(paren
id|j
OL
id|BUFF_ALLOC_RETRIES
)paren
op_logical_and
(paren
id|tmp
op_eq
l_int|NULL
)paren
suffix:semicolon
id|j
op_increment
)paren
(brace
r_if
c_cond
(paren
(paren
id|tmp
op_assign
(paren
r_void
op_star
)paren
id|kmalloc
c_func
(paren
id|RX_BUFF_SZ
op_star
id|NUM_RX_DESC
op_plus
id|ALIGN
comma
id|GFP_KERNEL
)paren
)paren
op_ne
l_int|NULL
)paren
(brace
id|tmp
op_assign
(paren
r_char
op_star
)paren
(paren
(paren
(paren
id|u_long
)paren
id|tmp
op_plus
id|ALIGN
)paren
op_amp
op_complement
id|ALIGN
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|NUM_RX_DESC
suffix:semicolon
id|i
op_increment
)paren
(brace
id|lp-&gt;rx_ring
(braket
id|i
)braket
dot
id|status
op_assign
l_int|0
suffix:semicolon
id|lp-&gt;rx_ring
(braket
id|i
)braket
dot
id|des1
op_assign
id|RX_BUFF_SZ
suffix:semicolon
id|lp-&gt;rx_ring
(braket
id|i
)braket
dot
id|buf
op_assign
id|virt_to_bus
c_func
(paren
id|tmp
op_plus
id|i
op_star
id|RX_BUFF_SZ
)paren
suffix:semicolon
id|lp-&gt;rx_ring
(braket
id|i
)braket
dot
id|next
op_assign
(paren
id|u32
)paren
l_int|NULL
suffix:semicolon
)brace
id|barrier
c_func
(paren
)paren
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|tmp
op_ne
l_int|NULL
)paren
(brace
id|lp-&gt;rxRingSize
op_assign
id|NUM_RX_DESC
suffix:semicolon
id|lp-&gt;txRingSize
op_assign
id|NUM_TX_DESC
suffix:semicolon
multiline_comment|/* Write the end of list marker to the descriptor lists */
id|lp-&gt;rx_ring
(braket
id|lp-&gt;rxRingSize
op_minus
l_int|1
)braket
dot
id|des1
op_or_assign
id|RD_RER
suffix:semicolon
id|lp-&gt;tx_ring
(braket
id|lp-&gt;txRingSize
op_minus
l_int|1
)braket
dot
id|des1
op_or_assign
id|TD_TER
suffix:semicolon
multiline_comment|/* Tell the adapter where the TX/RX rings are located. */
id|outl
c_func
(paren
id|virt_to_bus
c_func
(paren
id|lp-&gt;rx_ring
)paren
comma
id|DE4X5_RRBA
)paren
suffix:semicolon
id|outl
c_func
(paren
id|virt_to_bus
c_func
(paren
id|lp-&gt;tx_ring
)paren
comma
id|DE4X5_TRBA
)paren
suffix:semicolon
multiline_comment|/* Initialise the IRQ mask and Enable/Disable */
id|lp-&gt;irq_mask
op_assign
id|IMR_RIM
op_or
id|IMR_TIM
op_or
id|IMR_TUM
suffix:semicolon
id|lp-&gt;irq_en
op_assign
id|IMR_NIM
op_or
id|IMR_AIM
suffix:semicolon
id|lp-&gt;tx_enable
op_assign
id|TRUE
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;irq
OL
l_int|2
)paren
(brace
macro_line|#ifndef MODULE
r_int
r_char
id|irqnum
suffix:semicolon
id|s32
id|omr
suffix:semicolon
id|autoirq_setup
c_func
(paren
l_int|0
)paren
suffix:semicolon
id|omr
op_assign
id|inl
c_func
(paren
id|DE4X5_OMR
)paren
suffix:semicolon
id|outl
c_func
(paren
id|IMR_AIM
op_or
id|IMR_RUM
comma
id|DE4X5_IMR
)paren
suffix:semicolon
multiline_comment|/* Unmask RUM interrupt */
id|outl
c_func
(paren
id|OMR_SR
op_or
id|omr
comma
id|DE4X5_OMR
)paren
suffix:semicolon
multiline_comment|/* Start RX w/no descriptors */
id|irqnum
op_assign
id|autoirq_report
c_func
(paren
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|irqnum
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;      and failed to detect IRQ line.&bslash;n&quot;
)paren
suffix:semicolon
id|status
op_assign
op_minus
id|ENXIO
suffix:semicolon
)brace
r_else
(brace
r_for
c_loop
(paren
id|dev-&gt;irq
op_assign
l_int|0
comma
id|i
op_assign
l_int|0
suffix:semicolon
(paren
id|i
OL
r_sizeof
(paren
id|de4x5_irq
)paren
)paren
op_logical_and
(paren
op_logical_neg
id|dev-&gt;irq
)paren
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|irqnum
op_eq
id|de4x5_irq
(braket
id|i
)braket
)paren
(brace
id|dev-&gt;irq
op_assign
id|irqnum
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;      and uses IRQ%d.&bslash;n&quot;
comma
id|dev-&gt;irq
)paren
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
op_logical_neg
id|dev-&gt;irq
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;      but incorrect IRQ line detected.&bslash;n&quot;
)paren
suffix:semicolon
id|status
op_assign
op_minus
id|ENXIO
suffix:semicolon
)brace
)brace
id|outl
c_func
(paren
l_int|0
comma
id|DE4X5_IMR
)paren
suffix:semicolon
multiline_comment|/* Re-mask RUM interrupt */
macro_line|#endif /* MODULE */
)brace
r_else
(brace
id|printk
c_func
(paren
l_string|&quot;      and requires IRQ%d (not probed).&bslash;n&quot;
comma
id|dev-&gt;irq
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
id|printk
c_func
(paren
l_string|&quot;%s: Kernel could not allocate RX buffer memory.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|status
op_assign
op_minus
id|ENXIO
suffix:semicolon
)brace
r_if
c_cond
(paren
id|status
)paren
id|release_region
c_func
(paren
id|iobase
comma
(paren
id|lp-&gt;bus
op_eq
id|PCI
ques
c_cond
id|DE4X5_PCI_TOTAL_SIZE
suffix:colon
id|DE4X5_EISA_TOTAL_SIZE
)paren
)paren
suffix:semicolon
)brace
r_else
(brace
id|printk
c_func
(paren
l_string|&quot;      which has an Ethernet PROM CRC error.&bslash;n&quot;
)paren
suffix:semicolon
id|status
op_assign
op_minus
id|ENXIO
suffix:semicolon
)brace
)brace
r_else
(brace
id|status
op_assign
op_minus
id|ENXIO
suffix:semicolon
)brace
)brace
r_else
(brace
id|status
op_assign
op_minus
id|ENXIO
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|status
)paren
(brace
r_if
c_cond
(paren
id|de4x5_debug
OG
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|version
)paren
suffix:semicolon
)brace
multiline_comment|/* The DE4X5-specific entries in the device structure. */
id|dev-&gt;open
op_assign
op_amp
id|de4x5_open
suffix:semicolon
id|dev-&gt;hard_start_xmit
op_assign
op_amp
id|de4x5_queue_pkt
suffix:semicolon
id|dev-&gt;stop
op_assign
op_amp
id|de4x5_close
suffix:semicolon
id|dev-&gt;get_stats
op_assign
op_amp
id|de4x5_get_stats
suffix:semicolon
macro_line|#ifdef HAVE_MULTICAST
id|dev-&gt;set_multicast_list
op_assign
op_amp
id|set_multicast_list
suffix:semicolon
macro_line|#endif
id|dev-&gt;do_ioctl
op_assign
op_amp
id|de4x5_ioctl
suffix:semicolon
id|dev-&gt;mem_start
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Fill in the generic field of the device structure. */
id|ether_setup
c_func
(paren
id|dev
)paren
suffix:semicolon
multiline_comment|/* Let the adapter sleep to save power */
r_if
c_cond
(paren
id|lp-&gt;chipset
op_eq
id|DC21041
)paren
(brace
id|outl
c_func
(paren
l_int|0
comma
id|DE4X5_SICR
)paren
suffix:semicolon
id|outl
c_func
(paren
id|CFDA_PSM
comma
id|PCI_CFDA
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
multiline_comment|/* Incorrectly initialised hardware */
r_struct
id|de4x5_private
op_star
id|lp
op_assign
(paren
r_struct
id|de4x5_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_if
c_cond
(paren
id|lp
)paren
(brace
id|kfree_s
c_func
(paren
id|bus_to_virt
c_func
(paren
id|lp-&gt;rx_ring
(braket
l_int|0
)braket
dot
id|buf
)paren
comma
id|RX_BUFF_SZ
op_star
id|NUM_RX_DESC
op_plus
id|ALIGN
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|dev-&gt;priv
)paren
(brace
id|kfree_s
c_func
(paren
id|dev-&gt;priv
comma
r_sizeof
(paren
r_struct
id|de4x5_private
)paren
op_plus
id|ALIGN
)paren
suffix:semicolon
id|dev-&gt;priv
op_assign
l_int|NULL
suffix:semicolon
)brace
)brace
r_return
id|status
suffix:semicolon
)brace
"&f;"
r_static
r_int
DECL|function|de4x5_open
id|de4x5_open
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
r_struct
id|de4x5_private
op_star
id|lp
op_assign
(paren
r_struct
id|de4x5_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|u_long
id|iobase
op_assign
id|dev-&gt;base_addr
suffix:semicolon
r_int
id|i
comma
id|status
op_assign
l_int|0
suffix:semicolon
id|s32
id|imr
comma
id|omr
comma
id|sts
suffix:semicolon
multiline_comment|/*&n;  ** Wake up the adapter&n;  */
r_if
c_cond
(paren
id|lp-&gt;chipset
op_eq
id|DC21041
)paren
(brace
id|outl
c_func
(paren
l_int|0
comma
id|PCI_CFDA
)paren
suffix:semicolon
id|dce_ms_delay
c_func
(paren
l_int|10
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|request_irq
c_func
(paren
id|dev-&gt;irq
comma
(paren
r_void
op_star
)paren
id|de4x5_interrupt
comma
l_int|0
comma
id|lp-&gt;adapter_name
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;de4x5_open(): Requested IRQ%d is busy&bslash;n&quot;
comma
id|dev-&gt;irq
)paren
suffix:semicolon
id|status
op_assign
op_minus
id|EAGAIN
suffix:semicolon
)brace
r_else
(brace
id|irq2dev_map
(braket
id|dev-&gt;irq
)braket
op_assign
id|dev
suffix:semicolon
multiline_comment|/* &n;    ** Re-initialize the DE4X5... &n;    */
id|status
op_assign
id|de4x5_init
c_func
(paren
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|de4x5_debug
OG
l_int|1
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%s: de4x5 open with irq %d&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|dev-&gt;irq
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;&bslash;tphysical address: &quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|6
suffix:semicolon
id|i
op_increment
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%2.2x:&quot;
comma
(paren
r_int
)paren
id|dev-&gt;dev_addr
(braket
id|i
)braket
)paren
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;Descriptor head addresses:&bslash;n&quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;&bslash;t0x%8.8lx  0x%8.8lx&bslash;n&quot;
comma
(paren
id|u_long
)paren
id|lp-&gt;rx_ring
comma
(paren
id|u_long
)paren
id|lp-&gt;tx_ring
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;Descriptor addresses:&bslash;nRX: &quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|lp-&gt;rxRingSize
op_minus
l_int|1
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|i
OL
l_int|3
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;0x%8.8lx  &quot;
comma
(paren
id|u_long
)paren
op_amp
id|lp-&gt;rx_ring
(braket
id|i
)braket
dot
id|status
)paren
suffix:semicolon
)brace
)brace
id|printk
c_func
(paren
l_string|&quot;...0x%8.8lx&bslash;n&quot;
comma
(paren
id|u_long
)paren
op_amp
id|lp-&gt;rx_ring
(braket
id|i
)braket
dot
id|status
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;TX: &quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|lp-&gt;txRingSize
op_minus
l_int|1
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|i
OL
l_int|3
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;0x%8.8lx  &quot;
comma
(paren
id|u_long
)paren
op_amp
id|lp-&gt;tx_ring
(braket
id|i
)braket
dot
id|status
)paren
suffix:semicolon
)brace
)brace
id|printk
c_func
(paren
l_string|&quot;...0x%8.8lx&bslash;n&quot;
comma
(paren
id|u_long
)paren
op_amp
id|lp-&gt;tx_ring
(braket
id|i
)braket
dot
id|status
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;Descriptor buffers:&bslash;nRX: &quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|lp-&gt;rxRingSize
op_minus
l_int|1
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|i
OL
l_int|3
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;0x%8.8x  &quot;
comma
id|lp-&gt;rx_ring
(braket
id|i
)braket
dot
id|buf
)paren
suffix:semicolon
)brace
)brace
id|printk
c_func
(paren
l_string|&quot;...0x%8.8x&bslash;n&quot;
comma
id|lp-&gt;rx_ring
(braket
id|i
)braket
dot
id|buf
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;TX: &quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|lp-&gt;txRingSize
op_minus
l_int|1
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|i
OL
l_int|3
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;0x%8.8x  &quot;
comma
id|lp-&gt;tx_ring
(braket
id|i
)braket
dot
id|buf
)paren
suffix:semicolon
)brace
)brace
id|printk
c_func
(paren
l_string|&quot;...0x%8.8x&bslash;n&quot;
comma
id|lp-&gt;tx_ring
(braket
id|i
)braket
dot
id|buf
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;Ring size: &bslash;nRX: %d&bslash;nTX: %d&bslash;n&quot;
comma
(paren
r_int
)paren
id|lp-&gt;rxRingSize
comma
(paren
r_int
)paren
id|lp-&gt;txRingSize
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;&bslash;tstatus:  %d&bslash;n&quot;
comma
id|status
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|status
)paren
(brace
id|dev-&gt;tbusy
op_assign
l_int|0
suffix:semicolon
id|dev-&gt;start
op_assign
l_int|1
suffix:semicolon
id|dev-&gt;interrupt
op_assign
id|UNMASK_INTERRUPTS
suffix:semicolon
id|dev-&gt;trans_start
op_assign
id|jiffies
suffix:semicolon
id|START_DE4X5
suffix:semicolon
multiline_comment|/* Unmask and enable DE4X5 board interrupts */
id|imr
op_assign
l_int|0
suffix:semicolon
id|UNMASK_IRQs
suffix:semicolon
multiline_comment|/* Reset any pending (stale) interrupts */
id|sts
op_assign
id|inl
c_func
(paren
id|DE4X5_STS
)paren
suffix:semicolon
id|outl
c_func
(paren
id|sts
comma
id|DE4X5_STS
)paren
suffix:semicolon
id|ENABLE_IRQs
suffix:semicolon
)brace
r_if
c_cond
(paren
id|de4x5_debug
OG
l_int|1
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;&bslash;tsts:  0x%08x&bslash;n&quot;
comma
id|inl
c_func
(paren
id|DE4X5_STS
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;&bslash;tbmr:  0x%08x&bslash;n&quot;
comma
id|inl
c_func
(paren
id|DE4X5_BMR
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;&bslash;timr:  0x%08x&bslash;n&quot;
comma
id|inl
c_func
(paren
id|DE4X5_IMR
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;&bslash;tomr:  0x%08x&bslash;n&quot;
comma
id|inl
c_func
(paren
id|DE4X5_OMR
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;&bslash;tsisr: 0x%08x&bslash;n&quot;
comma
id|inl
c_func
(paren
id|DE4X5_SISR
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;&bslash;tsicr: 0x%08x&bslash;n&quot;
comma
id|inl
c_func
(paren
id|DE4X5_SICR
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;&bslash;tstrr: 0x%08x&bslash;n&quot;
comma
id|inl
c_func
(paren
id|DE4X5_STRR
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;&bslash;tsigr: 0x%08x&bslash;n&quot;
comma
id|inl
c_func
(paren
id|DE4X5_SIGR
)paren
)paren
suffix:semicolon
)brace
)brace
id|MOD_INC_USE_COUNT
suffix:semicolon
r_return
id|status
suffix:semicolon
)brace
multiline_comment|/*&n;** Initialize the DE4X5 operating conditions. NB: a chip problem with the&n;** DC21140 requires using perfect filtering mode for that chip. Since I can&squot;t&n;** see why I&squot;d want &gt; 14 multicast addresses, I may change all chips to use&n;** the perfect filtering mode. Keep the DMA burst length at 8: there seems&n;** to be data corruption problems if it is larger (UDP errors seen from a&n;** ttcp source).&n;*/
r_static
r_int
DECL|function|de4x5_init
id|de4x5_init
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
r_struct
id|de4x5_private
op_star
id|lp
op_assign
(paren
r_struct
id|de4x5_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|u_long
id|iobase
op_assign
id|dev-&gt;base_addr
suffix:semicolon
r_int
id|i
comma
id|j
comma
id|status
op_assign
l_int|0
suffix:semicolon
id|s32
id|bmr
comma
id|omr
suffix:semicolon
multiline_comment|/* Lock out other processes whilst setting up the hardware */
id|set_bit
c_func
(paren
l_int|0
comma
(paren
r_void
op_star
)paren
op_amp
id|dev-&gt;tbusy
)paren
suffix:semicolon
id|RESET_DE4X5
suffix:semicolon
id|bmr
op_assign
id|inl
c_func
(paren
id|DE4X5_BMR
)paren
suffix:semicolon
id|bmr
op_or_assign
id|PBL_8
op_or
id|DESC_SKIP_LEN
op_or
id|CACHE_ALIGN
suffix:semicolon
id|outl
c_func
(paren
id|bmr
comma
id|DE4X5_BMR
)paren
suffix:semicolon
r_if
c_cond
(paren
id|lp-&gt;chipset
op_ne
id|DC21140
)paren
(brace
id|omr
op_assign
id|TR_96
suffix:semicolon
id|lp-&gt;setup_f
op_assign
id|HASH_PERF
suffix:semicolon
)brace
r_else
(brace
id|omr
op_assign
id|OMR_SDP
op_or
id|OMR_SF
suffix:semicolon
id|lp-&gt;setup_f
op_assign
id|PERFECT
suffix:semicolon
)brace
id|outl
c_func
(paren
id|virt_to_bus
c_func
(paren
id|lp-&gt;rx_ring
)paren
comma
id|DE4X5_RRBA
)paren
suffix:semicolon
id|outl
c_func
(paren
id|virt_to_bus
c_func
(paren
id|lp-&gt;tx_ring
)paren
comma
id|DE4X5_TRBA
)paren
suffix:semicolon
id|lp-&gt;rx_new
op_assign
id|lp-&gt;rx_old
op_assign
l_int|0
suffix:semicolon
id|lp-&gt;tx_new
op_assign
id|lp-&gt;tx_old
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|lp-&gt;rxRingSize
suffix:semicolon
id|i
op_increment
)paren
(brace
id|lp-&gt;rx_ring
(braket
id|i
)braket
dot
id|status
op_assign
id|R_OWN
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|lp-&gt;txRingSize
suffix:semicolon
id|i
op_increment
)paren
(brace
id|lp-&gt;tx_ring
(braket
id|i
)braket
dot
id|status
op_assign
l_int|0
suffix:semicolon
)brace
id|barrier
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* Build the setup frame depending on filtering mode */
id|SetMulticastFilter
c_func
(paren
id|dev
comma
l_int|0
comma
l_int|NULL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|lp-&gt;chipset
op_ne
id|DC21140
)paren
(brace
id|load_packet
c_func
(paren
id|dev
comma
id|lp-&gt;setup_frame
comma
id|HASH_F
op_or
id|TD_SET
op_or
id|SETUP_FRAME_LEN
comma
l_int|NULL
)paren
suffix:semicolon
)brace
r_else
(brace
id|load_packet
c_func
(paren
id|dev
comma
id|lp-&gt;setup_frame
comma
id|PERFECT_F
op_or
id|TD_SET
op_or
id|SETUP_FRAME_LEN
comma
l_int|NULL
)paren
suffix:semicolon
)brace
id|outl
c_func
(paren
id|omr
op_or
id|OMR_ST
comma
id|DE4X5_OMR
)paren
suffix:semicolon
multiline_comment|/* Poll for completion of setup frame (interrupts are disabled for now) */
r_for
c_loop
(paren
id|j
op_assign
l_int|0
comma
id|i
op_assign
id|jiffies
suffix:semicolon
(paren
id|i
op_le
id|jiffies
op_plus
id|HZ
op_div
l_int|100
)paren
op_logical_and
(paren
id|j
op_eq
l_int|0
)paren
suffix:semicolon
)paren
(brace
r_if
c_cond
(paren
id|lp-&gt;tx_ring
(braket
id|lp-&gt;tx_new
)braket
dot
id|status
op_ge
l_int|0
)paren
id|j
op_assign
l_int|1
suffix:semicolon
)brace
id|outl
c_func
(paren
id|omr
comma
id|DE4X5_OMR
)paren
suffix:semicolon
multiline_comment|/* Stop everything! */
r_if
c_cond
(paren
id|j
op_eq
l_int|0
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%s: Setup frame timed out, status %08x&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|inl
c_func
(paren
id|DE4X5_STS
)paren
)paren
suffix:semicolon
id|status
op_assign
op_minus
id|EIO
suffix:semicolon
)brace
id|lp-&gt;tx_new
op_assign
(paren
op_increment
id|lp-&gt;tx_new
)paren
op_mod
id|lp-&gt;txRingSize
suffix:semicolon
id|lp-&gt;tx_old
op_assign
id|lp-&gt;tx_new
suffix:semicolon
multiline_comment|/* Autoconfigure the connected port */
r_if
c_cond
(paren
id|autoconf_media
c_func
(paren
id|dev
)paren
op_eq
l_int|0
)paren
(brace
id|status
op_assign
op_minus
id|EIO
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* &n;** Writes a socket buffer address to the next available transmit descriptor&n;*/
r_static
r_int
DECL|function|de4x5_queue_pkt
id|de4x5_queue_pkt
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|device
op_star
id|dev
)paren
(brace
r_struct
id|de4x5_private
op_star
id|lp
op_assign
(paren
r_struct
id|de4x5_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|u_long
id|iobase
op_assign
id|dev-&gt;base_addr
suffix:semicolon
r_int
id|i
comma
id|status
op_assign
l_int|0
suffix:semicolon
id|s32
id|imr
comma
id|omr
comma
id|sts
suffix:semicolon
multiline_comment|/*&n;  ** Clean out the TX ring asynchronously to interrupts - sometimes the&n;  ** interrupts are lost by delayed descriptor status updates relative to&n;  ** the irq assertion, especially with a busy PCI bus.&n;  */
r_if
c_cond
(paren
id|set_bit
c_func
(paren
l_int|0
comma
(paren
r_void
op_star
)paren
op_amp
id|dev-&gt;tbusy
)paren
op_eq
l_int|0
)paren
(brace
id|cli
c_func
(paren
)paren
suffix:semicolon
id|de4x5_tx
c_func
(paren
id|dev
)paren
suffix:semicolon
id|dev-&gt;tbusy
op_assign
l_int|0
suffix:semicolon
id|sti
c_func
(paren
)paren
suffix:semicolon
)brace
multiline_comment|/* &n;  ** Transmitter timeout, possibly serious problems.&n;  ** The &squot;lostMedia&squot; threshold accounts for transient errors that&n;  ** were noticed when switching media.&n;  */
r_if
c_cond
(paren
id|dev-&gt;tbusy
op_logical_or
(paren
id|lp-&gt;lostMedia
OG
id|LOST_MEDIA_THRESHOLD
)paren
)paren
(brace
id|u_long
id|tickssofar
op_assign
id|jiffies
op_minus
id|dev-&gt;trans_start
suffix:semicolon
r_if
c_cond
(paren
(paren
id|tickssofar
OL
id|QUEUE_PKT_TIMEOUT
)paren
op_logical_and
(paren
id|lp-&gt;lostMedia
op_le
id|LOST_MEDIA_THRESHOLD
)paren
)paren
(brace
id|status
op_assign
op_minus
l_int|1
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|de4x5_debug
op_ge
l_int|1
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%s: transmit timed out, status %08x, tbusy:%ld, lostMedia:%d tickssofar:%ld, resetting.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|inl
c_func
(paren
id|DE4X5_STS
)paren
comma
id|dev-&gt;tbusy
comma
id|lp-&gt;lostMedia
comma
id|tickssofar
)paren
suffix:semicolon
)brace
multiline_comment|/* Stop and reset the TX and RX... */
id|STOP_DE4X5
suffix:semicolon
multiline_comment|/* Re-queue any skb&squot;s. */
r_for
c_loop
(paren
id|i
op_assign
id|lp-&gt;tx_old
suffix:semicolon
id|i
op_ne
id|lp-&gt;tx_new
suffix:semicolon
id|i
op_assign
(paren
op_increment
id|i
)paren
op_mod
id|lp-&gt;txRingSize
)paren
(brace
r_if
c_cond
(paren
id|lp-&gt;skb
(braket
id|i
)braket
op_ne
l_int|NULL
)paren
(brace
r_if
c_cond
(paren
id|lp-&gt;skb
(braket
id|i
)braket
op_member_access_from_pointer
id|len
op_ne
id|FAKE_FRAME_LEN
)paren
(brace
r_if
c_cond
(paren
id|lp-&gt;tx_ring
(braket
id|i
)braket
dot
id|status
op_eq
id|T_OWN
)paren
(brace
id|dev_queue_xmit
c_func
(paren
id|lp-&gt;skb
(braket
id|i
)braket
comma
id|dev
comma
id|SOPRI_NORMAL
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* already sent */
id|dev_kfree_skb
c_func
(paren
id|lp-&gt;skb
(braket
id|i
)braket
comma
id|FREE_WRITE
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
id|dev_kfree_skb
c_func
(paren
id|lp-&gt;skb
(braket
id|i
)braket
comma
id|FREE_WRITE
)paren
suffix:semicolon
)brace
id|lp-&gt;skb
(braket
id|i
)braket
op_assign
l_int|NULL
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|skb-&gt;len
op_ne
id|FAKE_FRAME_LEN
)paren
(brace
id|dev_queue_xmit
c_func
(paren
id|skb
comma
id|dev
comma
id|SOPRI_NORMAL
)paren
suffix:semicolon
)brace
r_else
(brace
id|dev_kfree_skb
c_func
(paren
id|skb
comma
id|FREE_WRITE
)paren
suffix:semicolon
)brace
multiline_comment|/* Initialise the hardware */
id|status
op_assign
id|de4x5_init
c_func
(paren
id|dev
)paren
suffix:semicolon
multiline_comment|/* Unmask DE4X5 board interrupts */
r_if
c_cond
(paren
op_logical_neg
id|status
)paren
(brace
multiline_comment|/* Start here to clean stale interrupts later */
id|dev-&gt;interrupt
op_assign
id|UNMASK_INTERRUPTS
suffix:semicolon
id|dev-&gt;start
op_assign
l_int|1
suffix:semicolon
id|dev-&gt;tbusy
op_assign
l_int|0
suffix:semicolon
id|dev-&gt;trans_start
op_assign
id|jiffies
suffix:semicolon
id|START_DE4X5
suffix:semicolon
multiline_comment|/* Unmask DE4X5 board interrupts */
id|imr
op_assign
l_int|0
suffix:semicolon
id|UNMASK_IRQs
suffix:semicolon
multiline_comment|/* Clear any pending (stale) interrupts */
id|sts
op_assign
id|inl
c_func
(paren
id|DE4X5_STS
)paren
suffix:semicolon
id|outl
c_func
(paren
id|sts
comma
id|DE4X5_STS
)paren
suffix:semicolon
id|ENABLE_IRQs
suffix:semicolon
)brace
r_else
(brace
id|printk
c_func
(paren
l_string|&quot;%s: hardware initialisation failure, status %08x.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|inl
c_func
(paren
id|DE4X5_STS
)paren
)paren
suffix:semicolon
)brace
)brace
)brace
r_else
r_if
c_cond
(paren
id|skb
op_eq
l_int|NULL
)paren
(brace
id|dev_tint
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|skb-&gt;len
op_eq
id|FAKE_FRAME_LEN
)paren
(brace
multiline_comment|/* Don&squot;t TX a fake frame! */
id|dev_kfree_skb
c_func
(paren
id|skb
comma
id|FREE_WRITE
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|skb-&gt;len
OG
l_int|0
)paren
(brace
multiline_comment|/* Enforce 1 process per h/w access */
r_if
c_cond
(paren
id|set_bit
c_func
(paren
l_int|0
comma
(paren
r_void
op_star
)paren
op_amp
id|dev-&gt;tbusy
)paren
op_ne
l_int|0
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%s: Transmitter access conflict.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|status
op_assign
op_minus
l_int|1
suffix:semicolon
multiline_comment|/* Re-queue packet */
)brace
r_else
(brace
id|cli
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|TX_BUFFS_AVAIL
)paren
(brace
multiline_comment|/* Fill in a Tx ring entry */
id|load_packet
c_func
(paren
id|dev
comma
id|skb-&gt;data
comma
id|TD_IC
op_or
id|TD_LS
op_or
id|TD_FS
op_or
id|skb-&gt;len
comma
id|skb
)paren
suffix:semicolon
r_if
c_cond
(paren
id|lp-&gt;tx_enable
)paren
(brace
id|outl
c_func
(paren
id|POLL_DEMAND
comma
id|DE4X5_TPD
)paren
suffix:semicolon
multiline_comment|/* Start the TX */
)brace
id|lp-&gt;tx_new
op_assign
(paren
op_increment
id|lp-&gt;tx_new
)paren
op_mod
id|lp-&gt;txRingSize
suffix:semicolon
multiline_comment|/* Ensure a wrap */
id|dev-&gt;trans_start
op_assign
id|jiffies
suffix:semicolon
r_if
c_cond
(paren
id|TX_BUFFS_AVAIL
)paren
(brace
id|dev-&gt;tbusy
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Another pkt may be queued */
)brace
)brace
r_else
(brace
multiline_comment|/* Ring full - re-queue */
id|status
op_assign
op_minus
l_int|1
suffix:semicolon
)brace
id|sti
c_func
(paren
)paren
suffix:semicolon
)brace
)brace
r_return
id|status
suffix:semicolon
)brace
multiline_comment|/*&n;** The DE4X5 interrupt handler. &n;** &n;** I/O Read/Writes through intermediate PCI bridges are never &squot;posted&squot;,&n;** so that the asserted interrupt always has some real data to work with -&n;** if these I/O accesses are ever changed to memory accesses, ensure the&n;** STS write is read immediately to complete the transaction if the adapter&n;** is not on bus 0. Lost interrupts can still occur when the PCI bus load&n;** is high and descriptor status bits cannot be set before the associated&n;** interrupt is asserted and this routine entered.&n;*/
r_static
r_void
DECL|function|de4x5_interrupt
id|de4x5_interrupt
c_func
(paren
r_int
id|irq
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_struct
id|device
op_star
id|dev
op_assign
(paren
r_struct
id|device
op_star
)paren
(paren
id|irq2dev_map
(braket
id|irq
)braket
)paren
suffix:semicolon
r_struct
id|de4x5_private
op_star
id|lp
suffix:semicolon
id|s32
id|imr
comma
id|omr
comma
id|sts
suffix:semicolon
id|u_long
id|iobase
suffix:semicolon
r_if
c_cond
(paren
id|dev
op_eq
l_int|NULL
)paren
(brace
id|printk
(paren
l_string|&quot;de4x5_interrupt(): irq %d for unknown device.&bslash;n&quot;
comma
id|irq
)paren
suffix:semicolon
)brace
r_else
(brace
id|lp
op_assign
(paren
r_struct
id|de4x5_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|iobase
op_assign
id|dev-&gt;base_addr
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;interrupt
)paren
id|printk
c_func
(paren
l_string|&quot;%s: Re-entering the interrupt handler.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|DISABLE_IRQs
suffix:semicolon
multiline_comment|/* Ensure non re-entrancy */
id|dev-&gt;interrupt
op_assign
id|MASK_INTERRUPTS
suffix:semicolon
r_while
c_loop
(paren
(paren
id|sts
op_assign
id|inl
c_func
(paren
id|DE4X5_STS
)paren
)paren
op_amp
id|lp-&gt;irq_mask
)paren
(brace
multiline_comment|/* Read IRQ status */
id|outl
c_func
(paren
id|sts
comma
id|DE4X5_STS
)paren
suffix:semicolon
multiline_comment|/* Reset the board interrupts */
r_if
c_cond
(paren
id|sts
op_amp
(paren
id|STS_RI
op_or
id|STS_RU
)paren
)paren
multiline_comment|/* Rx interrupt (packet[s] arrived) */
id|de4x5_rx
c_func
(paren
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sts
op_amp
(paren
id|STS_TI
op_or
id|STS_TU
)paren
)paren
multiline_comment|/* Tx interrupt (packet sent) */
id|de4x5_tx
c_func
(paren
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sts
op_amp
id|STS_TM
)paren
multiline_comment|/* Autosense tick */
id|de4x5_ast
c_func
(paren
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sts
op_amp
id|STS_LNF
)paren
(brace
multiline_comment|/* TP Link has failed */
id|lp-&gt;lostMedia
op_assign
id|LOST_MEDIA_THRESHOLD
op_plus
l_int|1
suffix:semicolon
id|lp-&gt;irq_mask
op_and_assign
op_complement
id|IMR_LFM
suffix:semicolon
id|kick_tx
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|sts
op_amp
id|STS_SE
)paren
(brace
multiline_comment|/* Bus Error */
id|STOP_DE4X5
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;%s: Fatal bus error occured, sts=%#8x, device stopped.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|sts
)paren
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|TX_BUFFS_AVAIL
op_logical_and
id|dev-&gt;tbusy
)paren
(brace
multiline_comment|/* Any resources available? */
id|dev-&gt;tbusy
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Clear TX busy flag */
id|mark_bh
c_func
(paren
id|NET_BH
)paren
suffix:semicolon
)brace
id|dev-&gt;interrupt
op_assign
id|UNMASK_INTERRUPTS
suffix:semicolon
id|ENABLE_IRQs
suffix:semicolon
)brace
r_return
suffix:semicolon
)brace
r_static
r_int
DECL|function|de4x5_rx
id|de4x5_rx
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
r_struct
id|de4x5_private
op_star
id|lp
op_assign
(paren
r_struct
id|de4x5_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_int
id|i
comma
id|entry
suffix:semicolon
id|s32
id|status
suffix:semicolon
r_char
op_star
id|buf
suffix:semicolon
r_for
c_loop
(paren
id|entry
op_assign
id|lp-&gt;rx_new
suffix:semicolon
id|lp-&gt;rx_ring
(braket
id|entry
)braket
dot
id|status
op_ge
l_int|0
suffix:semicolon
id|entry
op_assign
id|lp-&gt;rx_new
)paren
(brace
id|status
op_assign
id|lp-&gt;rx_ring
(braket
id|entry
)braket
dot
id|status
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
id|RD_FS
)paren
(brace
multiline_comment|/* Remember the start of frame */
id|lp-&gt;rx_old
op_assign
id|entry
suffix:semicolon
)brace
r_if
c_cond
(paren
id|status
op_amp
id|RD_LS
)paren
(brace
multiline_comment|/* Valid frame status */
r_if
c_cond
(paren
id|status
op_amp
id|RD_ES
)paren
(brace
multiline_comment|/* There was an error. */
id|lp-&gt;stats.rx_errors
op_increment
suffix:semicolon
multiline_comment|/* Update the error stats. */
r_if
c_cond
(paren
id|status
op_amp
(paren
id|RD_RF
op_or
id|RD_TL
)paren
)paren
id|lp-&gt;stats.rx_frame_errors
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
id|RD_CE
)paren
id|lp-&gt;stats.rx_crc_errors
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
id|RD_OF
)paren
id|lp-&gt;stats.rx_fifo_errors
op_increment
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* A valid frame received */
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
r_int
id|pkt_len
op_assign
(paren
r_int
)paren
(paren
id|lp-&gt;rx_ring
(braket
id|entry
)braket
dot
id|status
op_rshift
l_int|16
)paren
op_minus
l_int|4
suffix:semicolon
r_if
c_cond
(paren
(paren
id|skb
op_assign
id|dev_alloc_skb
c_func
(paren
id|pkt_len
op_plus
l_int|2
)paren
)paren
op_ne
l_int|NULL
)paren
(brace
id|skb-&gt;dev
op_assign
id|dev
suffix:semicolon
id|skb_reserve
c_func
(paren
id|skb
comma
l_int|2
)paren
suffix:semicolon
multiline_comment|/* Align */
r_if
c_cond
(paren
id|entry
OL
id|lp-&gt;rx_old
)paren
(brace
multiline_comment|/* Wrapped buffer */
r_int
id|len
op_assign
(paren
id|lp-&gt;rxRingSize
op_minus
id|lp-&gt;rx_old
)paren
op_star
id|RX_BUFF_SZ
suffix:semicolon
id|memcpy
c_func
(paren
id|skb_put
c_func
(paren
id|skb
comma
id|len
)paren
comma
id|bus_to_virt
c_func
(paren
id|lp-&gt;rx_ring
(braket
id|lp-&gt;rx_old
)braket
dot
id|buf
)paren
comma
id|len
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|skb_put
c_func
(paren
id|skb
comma
id|pkt_len
op_minus
id|len
)paren
comma
id|bus_to_virt
c_func
(paren
id|lp-&gt;rx_ring
(braket
l_int|0
)braket
dot
id|buf
)paren
comma
id|pkt_len
op_minus
id|len
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* Linear buffer */
id|memcpy
c_func
(paren
id|skb_put
c_func
(paren
id|skb
comma
id|pkt_len
)paren
comma
id|bus_to_virt
c_func
(paren
id|lp-&gt;rx_ring
(braket
id|lp-&gt;rx_old
)braket
dot
id|buf
)paren
comma
id|pkt_len
)paren
suffix:semicolon
)brace
multiline_comment|/* Push up the protocol stack */
id|skb-&gt;protocol
op_assign
id|eth_type_trans
c_func
(paren
id|skb
comma
id|dev
)paren
suffix:semicolon
id|netif_rx
c_func
(paren
id|skb
)paren
suffix:semicolon
multiline_comment|/* Update stats */
id|lp-&gt;stats.rx_packets
op_increment
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|1
suffix:semicolon
id|i
OL
id|DE4X5_PKT_STAT_SZ
op_minus
l_int|1
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|pkt_len
OL
(paren
id|i
op_star
id|DE4X5_PKT_BIN_SZ
)paren
)paren
(brace
id|lp-&gt;pktStats.bins
(braket
id|i
)braket
op_increment
suffix:semicolon
id|i
op_assign
id|DE4X5_PKT_STAT_SZ
suffix:semicolon
)brace
)brace
id|buf
op_assign
id|skb-&gt;data
suffix:semicolon
multiline_comment|/* Look at the dest addr */
r_if
c_cond
(paren
id|buf
(braket
l_int|0
)braket
op_amp
l_int|0x01
)paren
(brace
multiline_comment|/* Multicast/Broadcast */
r_if
c_cond
(paren
(paren
op_star
(paren
id|s32
op_star
)paren
op_amp
id|buf
(braket
l_int|0
)braket
op_eq
op_minus
l_int|1
)paren
op_logical_and
(paren
op_star
(paren
id|s16
op_star
)paren
op_amp
id|buf
(braket
l_int|4
)braket
op_eq
op_minus
l_int|1
)paren
)paren
(brace
id|lp-&gt;pktStats.broadcast
op_increment
suffix:semicolon
)brace
r_else
(brace
id|lp-&gt;pktStats.multicast
op_increment
suffix:semicolon
)brace
)brace
r_else
r_if
c_cond
(paren
(paren
op_star
(paren
id|s32
op_star
)paren
op_amp
id|buf
(braket
l_int|0
)braket
op_eq
op_star
(paren
id|s32
op_star
)paren
op_amp
id|dev-&gt;dev_addr
(braket
l_int|0
)braket
)paren
op_logical_and
(paren
op_star
(paren
id|s16
op_star
)paren
op_amp
id|buf
(braket
l_int|4
)braket
op_eq
op_star
(paren
id|s16
op_star
)paren
op_amp
id|dev-&gt;dev_addr
(braket
l_int|4
)braket
)paren
)paren
(brace
id|lp-&gt;pktStats.unicast
op_increment
suffix:semicolon
)brace
id|lp-&gt;pktStats.bins
(braket
l_int|0
)braket
op_increment
suffix:semicolon
multiline_comment|/* Duplicates stats.rx_packets */
r_if
c_cond
(paren
id|lp-&gt;pktStats.bins
(braket
l_int|0
)braket
op_eq
l_int|0
)paren
(brace
multiline_comment|/* Reset counters */
id|memset
c_func
(paren
(paren
r_char
op_star
)paren
op_amp
id|lp-&gt;pktStats
comma
l_int|0
comma
r_sizeof
(paren
id|lp-&gt;pktStats
)paren
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
id|printk
c_func
(paren
l_string|&quot;%s: Insufficient memory; nuking packet.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|lp-&gt;stats.rx_dropped
op_increment
suffix:semicolon
multiline_comment|/* Really, deferred. */
r_break
suffix:semicolon
)brace
)brace
multiline_comment|/* Change buffer ownership for this last frame, back to the adapter */
r_for
c_loop
(paren
suffix:semicolon
id|lp-&gt;rx_old
op_ne
id|entry
suffix:semicolon
id|lp-&gt;rx_old
op_assign
(paren
op_increment
id|lp-&gt;rx_old
)paren
op_mod
id|lp-&gt;rxRingSize
)paren
(brace
id|lp-&gt;rx_ring
(braket
id|lp-&gt;rx_old
)braket
dot
id|status
op_assign
id|R_OWN
suffix:semicolon
id|barrier
c_func
(paren
)paren
suffix:semicolon
)brace
id|lp-&gt;rx_ring
(braket
id|entry
)braket
dot
id|status
op_assign
id|R_OWN
suffix:semicolon
id|barrier
c_func
(paren
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;    ** Update entry information&n;    */
id|lp-&gt;rx_new
op_assign
(paren
op_increment
id|lp-&gt;rx_new
)paren
op_mod
id|lp-&gt;rxRingSize
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n;** Buffer sent - check for TX buffer errors.&n;*/
r_static
r_int
DECL|function|de4x5_tx
id|de4x5_tx
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
r_struct
id|de4x5_private
op_star
id|lp
op_assign
(paren
r_struct
id|de4x5_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|u_long
id|iobase
op_assign
id|dev-&gt;base_addr
suffix:semicolon
r_int
id|entry
suffix:semicolon
id|s32
id|status
suffix:semicolon
r_for
c_loop
(paren
id|entry
op_assign
id|lp-&gt;tx_old
suffix:semicolon
id|entry
op_ne
id|lp-&gt;tx_new
suffix:semicolon
id|entry
op_assign
id|lp-&gt;tx_old
)paren
(brace
id|status
op_assign
id|lp-&gt;tx_ring
(braket
id|entry
)braket
dot
id|status
suffix:semicolon
r_if
c_cond
(paren
id|status
OL
l_int|0
)paren
(brace
multiline_comment|/* Buffer not sent yet */
r_break
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|status
op_amp
id|TD_ES
)paren
(brace
multiline_comment|/* An error happened */
id|lp-&gt;stats.tx_errors
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
id|TD_NC
)paren
id|lp-&gt;stats.tx_carrier_errors
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
id|TD_LC
)paren
id|lp-&gt;stats.tx_window_errors
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
id|TD_UF
)paren
id|lp-&gt;stats.tx_fifo_errors
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
id|TD_LC
)paren
id|lp-&gt;stats.collisions
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
id|TD_EC
)paren
id|lp-&gt;pktStats.excessive_collisions
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
id|TD_DE
)paren
id|lp-&gt;stats.tx_aborted_errors
op_increment
suffix:semicolon
r_if
c_cond
(paren
(paren
id|status
op_ne
l_int|0x7fffffff
)paren
op_logical_and
multiline_comment|/* Not setup frame */
(paren
id|status
op_amp
(paren
id|TD_LO
op_or
id|TD_NC
op_or
id|TD_EC
op_or
id|TD_LF
)paren
)paren
)paren
(brace
id|lp-&gt;lostMedia
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|lp-&gt;lostMedia
OG
id|LOST_MEDIA_THRESHOLD
)paren
(brace
multiline_comment|/* Trip autosense */
id|kick_tx
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
id|outl
c_func
(paren
id|POLL_DEMAND
comma
id|DE4X5_TPD
)paren
suffix:semicolon
multiline_comment|/* Restart a stalled TX */
)brace
)brace
r_else
(brace
multiline_comment|/* Packet sent */
id|lp-&gt;stats.tx_packets
op_increment
suffix:semicolon
id|lp-&gt;lostMedia
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Remove transient problem */
)brace
multiline_comment|/* Free the buffer if it&squot;s not a setup frame. */
r_if
c_cond
(paren
id|lp-&gt;skb
(braket
id|entry
)braket
op_ne
l_int|NULL
)paren
(brace
id|dev_kfree_skb
c_func
(paren
id|lp-&gt;skb
(braket
id|entry
)braket
comma
id|FREE_WRITE
)paren
suffix:semicolon
id|lp-&gt;skb
(braket
id|entry
)braket
op_assign
l_int|NULL
suffix:semicolon
)brace
multiline_comment|/* Update all the pointers */
id|lp-&gt;tx_old
op_assign
(paren
op_increment
id|lp-&gt;tx_old
)paren
op_mod
id|lp-&gt;txRingSize
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_int
DECL|function|de4x5_ast
id|de4x5_ast
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
r_struct
id|de4x5_private
op_star
id|lp
op_assign
(paren
r_struct
id|de4x5_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|u_long
id|iobase
op_assign
id|dev-&gt;base_addr
suffix:semicolon
id|s32
id|gep
suffix:semicolon
id|disable_ast
c_func
(paren
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|lp-&gt;chipset
op_eq
id|DC21140
)paren
(brace
id|gep
op_assign
id|inl
c_func
(paren
id|DE4X5_GEP
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
(paren
id|lp-&gt;media
op_eq
id|_100Mb
)paren
op_logical_and
(paren
id|gep
op_amp
id|GEP_SLNK
)paren
)paren
op_logical_or
(paren
(paren
id|lp-&gt;media
op_eq
id|_10Mb
)paren
op_logical_and
(paren
id|gep
op_amp
id|GEP_LNP
)paren
)paren
op_logical_or
(paren
(paren
id|lp-&gt;media
op_eq
id|_10Mb
)paren
op_logical_and
op_logical_neg
(paren
id|gep
op_amp
id|GEP_SLNK
)paren
)paren
op_logical_or
(paren
id|lp-&gt;media
op_eq
id|NC
)paren
)paren
(brace
r_if
c_cond
(paren
id|lp-&gt;linkProb
op_logical_or
(paren
(paren
id|lp-&gt;media
op_eq
id|NC
)paren
op_logical_and
(paren
op_logical_neg
(paren
id|gep
op_amp
id|GEP_LNP
)paren
)paren
)paren
)paren
(brace
id|lp-&gt;lostMedia
op_assign
id|LOST_MEDIA_THRESHOLD
op_plus
l_int|1
suffix:semicolon
id|lp-&gt;linkProb
op_assign
l_int|0
suffix:semicolon
id|kick_tx
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
r_else
(brace
r_switch
c_cond
(paren
id|lp-&gt;media
)paren
(brace
r_case
id|NC
suffix:colon
id|lp-&gt;linkProb
op_assign
l_int|0
suffix:semicolon
id|enable_ast
c_func
(paren
id|dev
comma
id|DE4X5_AUTOSENSE_MS
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|_10Mb
suffix:colon
id|lp-&gt;linkProb
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* Flag a potential problem */
id|enable_ast
c_func
(paren
id|dev
comma
l_int|1500
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|_100Mb
suffix:colon
id|lp-&gt;linkProb
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* Flag a potential problem */
id|enable_ast
c_func
(paren
id|dev
comma
l_int|4000
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
)brace
r_else
(brace
id|lp-&gt;linkProb
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Link OK */
id|enable_ast
c_func
(paren
id|dev
comma
id|DE4X5_AUTOSENSE_MS
)paren
suffix:semicolon
)brace
)brace
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_int
DECL|function|de4x5_close
id|de4x5_close
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
r_struct
id|de4x5_private
op_star
id|lp
op_assign
(paren
r_struct
id|de4x5_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|u_long
id|iobase
op_assign
id|dev-&gt;base_addr
suffix:semicolon
id|s32
id|imr
comma
id|omr
suffix:semicolon
id|dev-&gt;start
op_assign
l_int|0
suffix:semicolon
id|dev-&gt;tbusy
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|de4x5_debug
OG
l_int|1
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%s: Shutting down ethercard, status was %8.8x.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|inl
c_func
(paren
id|DE4X5_STS
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/* &n;  ** We stop the DE4X5 here... mask interrupts and stop TX &amp; RX&n;  */
id|DISABLE_IRQs
suffix:semicolon
id|STOP_DE4X5
suffix:semicolon
multiline_comment|/*&n;  ** Free the associated irq&n;  */
id|free_irq
c_func
(paren
id|dev-&gt;irq
)paren
suffix:semicolon
id|irq2dev_map
(braket
id|dev-&gt;irq
)braket
op_assign
l_int|0
suffix:semicolon
id|MOD_DEC_USE_COUNT
suffix:semicolon
multiline_comment|/* Put the adapter to sleep to save power */
r_if
c_cond
(paren
id|lp-&gt;chipset
op_eq
id|DC21041
)paren
(brace
id|outl
c_func
(paren
l_int|0
comma
id|DE4X5_SICR
)paren
suffix:semicolon
id|outl
c_func
(paren
id|CFDA_PSM
comma
id|PCI_CFDA
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_struct
id|enet_statistics
op_star
DECL|function|de4x5_get_stats
id|de4x5_get_stats
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
r_struct
id|de4x5_private
op_star
id|lp
op_assign
(paren
r_struct
id|de4x5_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|u_long
id|iobase
op_assign
id|dev-&gt;base_addr
suffix:semicolon
id|lp-&gt;stats.rx_missed_errors
op_assign
(paren
r_int
)paren
(paren
id|inl
c_func
(paren
id|DE4X5_MFC
)paren
op_amp
(paren
id|MFC_OVFL
op_or
id|MFC_CNTR
)paren
)paren
suffix:semicolon
r_return
op_amp
id|lp-&gt;stats
suffix:semicolon
)brace
DECL|function|load_packet
r_static
r_void
id|load_packet
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
r_char
op_star
id|buf
comma
id|u32
id|flags
comma
r_struct
id|sk_buff
op_star
id|skb
)paren
(brace
r_struct
id|de4x5_private
op_star
id|lp
op_assign
(paren
r_struct
id|de4x5_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|lp-&gt;tx_ring
(braket
id|lp-&gt;tx_new
)braket
dot
id|buf
op_assign
id|virt_to_bus
c_func
(paren
id|buf
)paren
suffix:semicolon
id|lp-&gt;tx_ring
(braket
id|lp-&gt;tx_new
)braket
dot
id|des1
op_and_assign
id|TD_TER
suffix:semicolon
id|lp-&gt;tx_ring
(braket
id|lp-&gt;tx_new
)braket
dot
id|des1
op_or_assign
id|flags
suffix:semicolon
id|lp-&gt;skb
(braket
id|lp-&gt;tx_new
)braket
op_assign
id|skb
suffix:semicolon
id|barrier
c_func
(paren
)paren
suffix:semicolon
id|lp-&gt;tx_ring
(braket
id|lp-&gt;tx_new
)braket
dot
id|status
op_assign
id|T_OWN
suffix:semicolon
id|barrier
c_func
(paren
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/*&n;** Set or clear the multicast filter for this adaptor.&n;** num_addrs == -1&t;Promiscuous mode, receive all packets - now supported.&n;**                      Can also use the ioctls.&n;** num_addrs == 0&t;Normal mode, clear multicast list&n;** num_addrs &gt; 0&t;Multicast mode, receive normal and MC packets, and do&n;** &t;&t;&t;best-effort filtering.&n;** num_addrs == HASH_TABLE_LEN&n;**&t;                Set all multicast bits (pass all multicasts).&n;*/
r_static
r_void
DECL|function|set_multicast_list
id|set_multicast_list
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
r_int
id|num_addrs
comma
r_void
op_star
id|addrs
)paren
(brace
r_struct
id|de4x5_private
op_star
id|lp
op_assign
(paren
r_struct
id|de4x5_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|u_long
id|iobase
op_assign
id|dev-&gt;base_addr
suffix:semicolon
multiline_comment|/* First, double check that the adapter is open */
r_if
c_cond
(paren
id|irq2dev_map
(braket
id|dev-&gt;irq
)braket
op_ne
l_int|NULL
)paren
(brace
r_if
c_cond
(paren
id|num_addrs
op_ge
l_int|0
)paren
(brace
id|SetMulticastFilter
c_func
(paren
id|dev
comma
id|num_addrs
comma
(paren
r_char
op_star
)paren
id|addrs
)paren
suffix:semicolon
r_if
c_cond
(paren
id|lp-&gt;setup_f
op_eq
id|HASH_PERF
)paren
(brace
id|load_packet
c_func
(paren
id|dev
comma
id|lp-&gt;setup_frame
comma
id|TD_IC
op_or
id|HASH_F
op_or
id|TD_SET
op_or
id|SETUP_FRAME_LEN
comma
l_int|NULL
)paren
suffix:semicolon
)brace
r_else
(brace
id|load_packet
c_func
(paren
id|dev
comma
id|lp-&gt;setup_frame
comma
id|TD_IC
op_or
id|PERFECT_F
op_or
id|TD_SET
op_or
id|SETUP_FRAME_LEN
comma
l_int|NULL
)paren
suffix:semicolon
)brace
id|lp-&gt;tx_new
op_assign
(paren
op_increment
id|lp-&gt;tx_new
)paren
op_mod
id|lp-&gt;txRingSize
suffix:semicolon
id|outl
c_func
(paren
id|POLL_DEMAND
comma
id|DE4X5_TPD
)paren
suffix:semicolon
multiline_comment|/* Start the TX */
id|dev-&gt;trans_start
op_assign
id|jiffies
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* set promiscuous mode */
id|u32
id|omr
suffix:semicolon
id|omr
op_assign
id|inl
c_func
(paren
id|DE4X5_OMR
)paren
suffix:semicolon
id|omr
op_or_assign
id|OMR_PR
suffix:semicolon
id|outl
c_func
(paren
id|omr
comma
id|DE4X5_OMR
)paren
suffix:semicolon
)brace
)brace
r_return
suffix:semicolon
)brace
multiline_comment|/*&n;** Calculate the hash code and update the logical address filter&n;** from a list of ethernet multicast addresses.&n;** Little endian crc one liner from Matt Thomas, DEC.&n;*/
DECL|function|SetMulticastFilter
r_static
r_void
id|SetMulticastFilter
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
r_int
id|num_addrs
comma
r_char
op_star
id|addrs
)paren
(brace
r_struct
id|de4x5_private
op_star
id|lp
op_assign
(paren
r_struct
id|de4x5_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|u_long
id|iobase
op_assign
id|dev-&gt;base_addr
suffix:semicolon
r_int
id|i
comma
id|j
comma
id|bit
comma
id|byte
suffix:semicolon
id|u16
id|hashcode
suffix:semicolon
id|u32
id|omr
comma
id|crc
comma
id|poly
op_assign
id|CRC_POLYNOMIAL_LE
suffix:semicolon
r_char
op_star
id|pa
suffix:semicolon
id|omr
op_assign
id|inl
c_func
(paren
id|DE4X5_OMR
)paren
suffix:semicolon
id|pa
op_assign
id|build_setup_frame
c_func
(paren
id|dev
comma
id|ALL
)paren
suffix:semicolon
multiline_comment|/* Build the basic frame */
r_if
c_cond
(paren
id|lp-&gt;setup_f
op_eq
id|HASH_PERF
)paren
(brace
r_if
c_cond
(paren
id|num_addrs
op_eq
id|HASH_TABLE_LEN
)paren
(brace
multiline_comment|/* Pass all multicasts */
id|omr
op_or_assign
id|OMR_PM
suffix:semicolon
)brace
r_else
(brace
id|omr
op_and_assign
op_complement
id|OMR_PM
suffix:semicolon
multiline_comment|/* Now update the MCA table */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|num_addrs
suffix:semicolon
id|i
op_increment
)paren
(brace
multiline_comment|/* for each address in the list */
r_if
c_cond
(paren
(paren
op_star
id|addrs
op_amp
l_int|0x01
)paren
op_eq
l_int|1
)paren
(brace
multiline_comment|/* multicast address? */
id|crc
op_assign
l_int|0xffffffff
suffix:semicolon
multiline_comment|/* init CRC for each address */
r_for
c_loop
(paren
id|byte
op_assign
l_int|0
suffix:semicolon
id|byte
OL
id|ETH_ALEN
suffix:semicolon
id|byte
op_increment
)paren
(brace
multiline_comment|/* for each address byte */
multiline_comment|/* process each address bit */
r_for
c_loop
(paren
id|bit
op_assign
op_star
id|addrs
op_increment
comma
id|j
op_assign
l_int|0
suffix:semicolon
id|j
OL
l_int|8
suffix:semicolon
id|j
op_increment
comma
id|bit
op_rshift_assign
l_int|1
)paren
(brace
id|crc
op_assign
(paren
id|crc
op_rshift
l_int|1
)paren
op_xor
(paren
(paren
(paren
id|crc
op_xor
id|bit
)paren
op_amp
l_int|0x01
)paren
ques
c_cond
id|poly
suffix:colon
l_int|0
)paren
suffix:semicolon
)brace
)brace
id|hashcode
op_assign
id|crc
op_amp
id|HASH_BITS
suffix:semicolon
multiline_comment|/* hashcode is 9 LSb of CRC */
id|byte
op_assign
id|hashcode
op_rshift
l_int|3
suffix:semicolon
multiline_comment|/* bit[3-8] -&gt; byte in filter */
id|bit
op_assign
l_int|1
op_lshift
(paren
id|hashcode
op_amp
l_int|0x07
)paren
suffix:semicolon
multiline_comment|/* bit[0-2] -&gt; bit in byte */
id|byte
op_lshift_assign
l_int|1
suffix:semicolon
multiline_comment|/* calc offset into setup frame */
r_if
c_cond
(paren
id|byte
op_amp
l_int|0x02
)paren
(brace
id|byte
op_sub_assign
l_int|1
suffix:semicolon
)brace
id|lp-&gt;setup_frame
(braket
id|byte
)braket
op_or_assign
id|bit
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* skip this address */
id|addrs
op_add_assign
id|ETH_ALEN
suffix:semicolon
)brace
)brace
)brace
)brace
r_else
(brace
multiline_comment|/* Perfect filtering */
id|omr
op_and_assign
op_complement
id|OMR_PM
suffix:semicolon
r_for
c_loop
(paren
id|j
op_assign
l_int|0
suffix:semicolon
id|j
OL
id|num_addrs
suffix:semicolon
id|j
op_increment
)paren
(brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|ETH_ALEN
suffix:semicolon
id|i
op_increment
)paren
(brace
op_star
(paren
id|pa
op_plus
(paren
id|i
op_amp
l_int|1
)paren
)paren
op_assign
op_star
id|addrs
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|i
op_amp
l_int|0x01
)paren
id|pa
op_add_assign
l_int|4
suffix:semicolon
)brace
)brace
)brace
r_if
c_cond
(paren
id|num_addrs
op_eq
l_int|0
)paren
id|omr
op_and_assign
op_complement
id|OMR_PR
suffix:semicolon
id|outl
c_func
(paren
id|omr
comma
id|DE4X5_OMR
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/*&n;** EISA bus I/O device probe. Probe from slot 1 since slot 0 is usually&n;** the motherboard. Upto 15 EISA devices are supported.&n;*/
DECL|function|eisa_probe
r_static
r_void
id|eisa_probe
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
id|u_long
id|ioaddr
)paren
(brace
r_int
id|i
comma
id|maxSlots
comma
id|status
suffix:semicolon
id|u_short
id|vendor
comma
id|device
suffix:semicolon
id|s32
id|cfid
suffix:semicolon
id|u_long
id|iobase
suffix:semicolon
r_struct
id|bus_type
op_star
id|lp
op_assign
op_amp
id|bus
suffix:semicolon
r_char
id|name
(braket
id|DE4X5_STRLEN
)braket
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ioaddr
op_logical_and
id|autoprobed
)paren
r_return
suffix:semicolon
multiline_comment|/* Been here before ! */
r_if
c_cond
(paren
(paren
id|ioaddr
OL
l_int|0x1000
)paren
op_logical_and
(paren
id|ioaddr
OG
l_int|0
)paren
)paren
r_return
suffix:semicolon
multiline_comment|/* PCI MODULE special */
id|lp-&gt;bus
op_assign
id|EISA
suffix:semicolon
r_if
c_cond
(paren
id|ioaddr
op_eq
l_int|0
)paren
(brace
multiline_comment|/* Autoprobing */
id|iobase
op_assign
id|EISA_SLOT_INC
suffix:semicolon
multiline_comment|/* Get the first slot address */
id|i
op_assign
l_int|1
suffix:semicolon
id|maxSlots
op_assign
id|MAX_EISA_SLOTS
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* Probe a specific location */
id|iobase
op_assign
id|ioaddr
suffix:semicolon
id|i
op_assign
(paren
id|ioaddr
op_rshift
l_int|12
)paren
suffix:semicolon
id|maxSlots
op_assign
id|i
op_plus
l_int|1
suffix:semicolon
)brace
r_for
c_loop
(paren
id|status
op_assign
op_minus
id|ENODEV
suffix:semicolon
(paren
id|i
OL
id|maxSlots
)paren
op_logical_and
(paren
id|dev
op_ne
l_int|NULL
)paren
suffix:semicolon
id|i
op_increment
comma
id|iobase
op_add_assign
id|EISA_SLOT_INC
)paren
(brace
r_if
c_cond
(paren
id|EISA_signature
c_func
(paren
id|name
comma
id|EISA_ID
)paren
)paren
(brace
id|cfid
op_assign
id|inl
c_func
(paren
id|PCI_CFID
)paren
suffix:semicolon
id|device
op_assign
(paren
id|u_short
)paren
(paren
id|cfid
op_rshift
l_int|16
)paren
suffix:semicolon
id|vendor
op_assign
(paren
id|u_short
)paren
id|cfid
suffix:semicolon
id|lp-&gt;bus
op_assign
id|EISA
suffix:semicolon
id|lp-&gt;chipset
op_assign
id|device
suffix:semicolon
r_if
c_cond
(paren
id|DevicePresent
c_func
(paren
id|EISA_APROM
)paren
op_eq
l_int|0
)paren
(brace
multiline_comment|/* Write the PCI Configuration Registers */
id|outl
c_func
(paren
id|PCI_COMMAND_IO
op_or
id|PCI_COMMAND_MASTER
comma
id|PCI_CFCS
)paren
suffix:semicolon
id|outl
c_func
(paren
l_int|0x00004000
comma
id|PCI_CFLT
)paren
suffix:semicolon
id|outl
c_func
(paren
id|iobase
comma
id|PCI_CBIO
)paren
suffix:semicolon
r_if
c_cond
(paren
id|check_region
c_func
(paren
id|iobase
comma
id|DE4X5_EISA_TOTAL_SIZE
)paren
op_eq
l_int|0
)paren
(brace
r_if
c_cond
(paren
(paren
id|dev
op_assign
id|alloc_device
c_func
(paren
id|dev
comma
id|iobase
)paren
)paren
op_ne
l_int|NULL
)paren
(brace
r_if
c_cond
(paren
(paren
id|status
op_assign
id|de4x5_hw_init
c_func
(paren
id|dev
comma
id|iobase
)paren
)paren
op_eq
l_int|0
)paren
(brace
id|num_de4x5s
op_increment
suffix:semicolon
)brace
id|num_eth
op_increment
suffix:semicolon
)brace
)brace
r_else
r_if
c_cond
(paren
id|autoprobed
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%s: region already allocated at 0x%04lx.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|iobase
)paren
suffix:semicolon
)brace
)brace
)brace
)brace
r_return
suffix:semicolon
)brace
multiline_comment|/*&n;** PCI bus I/O device probe&n;** NB: PCI I/O accesses and Bus Mastering are enabled by the PCI BIOS, not&n;** the driver. Some PCI BIOS&squot;s, pre V2.1, need the slot + features to be&n;** enabled by the user first in the set up utility. Hence we just check for&n;** enabled features and silently ignore the card if they&squot;re not.&n;**&n;** STOP PRESS: Some BIOS&squot;s __require__ the driver to enable the bus mastering&n;** bit. Here, check for I/O accesses and then set BM. If you put the card in&n;** a non BM slot, you&squot;re on your own (and complain to the PC vendor that your&n;** PC doesn&squot;t conform to the PCI standard)!&n;*/
DECL|macro|PCI_DEVICE
mdefine_line|#define PCI_DEVICE    (dev_num &lt;&lt; 3)
DECL|macro|PCI_LAST_DEV
mdefine_line|#define PCI_LAST_DEV  32
DECL|function|pci_probe
r_static
r_void
id|pci_probe
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
id|u_long
id|ioaddr
)paren
(brace
id|u_char
id|irq
suffix:semicolon
id|u_char
id|pb
comma
id|pbus
comma
id|dev_num
comma
id|dnum
comma
id|dev_fn
suffix:semicolon
id|u_short
id|vendor
comma
id|device
comma
id|index
comma
id|status
suffix:semicolon
id|u_int
r_class
op_assign
id|DE4X5_CLASS_CODE
suffix:semicolon
id|u_int
id|iobase
suffix:semicolon
r_struct
id|bus_type
op_star
id|lp
op_assign
op_amp
id|bus
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ioaddr
op_logical_and
id|autoprobed
)paren
r_return
suffix:semicolon
multiline_comment|/* Been here before ! */
r_if
c_cond
(paren
id|pcibios_present
c_func
(paren
)paren
)paren
(brace
id|lp-&gt;bus
op_assign
id|PCI
suffix:semicolon
r_if
c_cond
(paren
id|ioaddr
OL
l_int|0x1000
)paren
(brace
id|pbus
op_assign
(paren
id|u_short
)paren
(paren
id|ioaddr
op_rshift
l_int|8
)paren
suffix:semicolon
id|dnum
op_assign
(paren
id|u_short
)paren
(paren
id|ioaddr
op_amp
l_int|0xff
)paren
suffix:semicolon
)brace
r_else
(brace
id|pbus
op_assign
l_int|0
suffix:semicolon
id|dnum
op_assign
l_int|0
suffix:semicolon
)brace
r_for
c_loop
(paren
id|index
op_assign
l_int|0
suffix:semicolon
(paren
id|pcibios_find_class
c_func
(paren
r_class
comma
id|index
comma
op_amp
id|pb
comma
op_amp
id|dev_fn
)paren
op_ne
id|PCIBIOS_DEVICE_NOT_FOUND
)paren
suffix:semicolon
id|index
op_increment
)paren
(brace
id|dev_num
op_assign
id|PCI_SLOT
c_func
(paren
id|dev_fn
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
op_logical_neg
id|pbus
op_logical_and
op_logical_neg
id|dnum
)paren
op_logical_or
(paren
(paren
id|pbus
op_eq
id|pb
)paren
op_logical_and
(paren
id|dnum
op_eq
id|dev_num
)paren
)paren
)paren
(brace
id|pcibios_read_config_word
c_func
(paren
id|pb
comma
id|PCI_DEVICE
comma
id|PCI_VENDOR_ID
comma
op_amp
id|vendor
)paren
suffix:semicolon
id|pcibios_read_config_word
c_func
(paren
id|pb
comma
id|PCI_DEVICE
comma
id|PCI_DEVICE_ID
comma
op_amp
id|device
)paren
suffix:semicolon
r_if
c_cond
(paren
id|is_DC21040
op_logical_or
id|is_DC21041
op_logical_or
id|is_DC21140
)paren
(brace
multiline_comment|/* Set the device number information */
id|lp-&gt;device
op_assign
id|dev_num
suffix:semicolon
id|lp-&gt;bus_num
op_assign
id|pb
suffix:semicolon
multiline_comment|/* Set the chipset information */
id|lp-&gt;chipset
op_assign
id|device
suffix:semicolon
multiline_comment|/* Get the board I/O address */
id|pcibios_read_config_dword
c_func
(paren
id|pb
comma
id|PCI_DEVICE
comma
id|PCI_BASE_ADDRESS_0
comma
op_amp
id|iobase
)paren
suffix:semicolon
id|iobase
op_and_assign
id|CBIO_MASK
suffix:semicolon
multiline_comment|/* Fetch the IRQ to be used */
id|pcibios_read_config_byte
c_func
(paren
id|pb
comma
id|PCI_DEVICE
comma
id|PCI_INTERRUPT_LINE
comma
op_amp
id|irq
)paren
suffix:semicolon
multiline_comment|/* Check if I/O accesses and Bus Mastering are enabled */
id|pcibios_read_config_word
c_func
(paren
id|pb
comma
id|PCI_DEVICE
comma
id|PCI_COMMAND
comma
op_amp
id|status
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
id|PCI_COMMAND_IO
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|status
op_amp
id|PCI_COMMAND_MASTER
)paren
)paren
(brace
id|status
op_or_assign
id|PCI_COMMAND_MASTER
suffix:semicolon
id|pcibios_write_config_word
c_func
(paren
id|pb
comma
id|PCI_DEVICE
comma
id|PCI_COMMAND
comma
id|status
)paren
suffix:semicolon
id|pcibios_read_config_word
c_func
(paren
id|pb
comma
id|PCI_DEVICE
comma
id|PCI_COMMAND
comma
op_amp
id|status
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|status
op_amp
id|PCI_COMMAND_MASTER
)paren
(brace
r_if
c_cond
(paren
(paren
id|DevicePresent
c_func
(paren
id|DE4X5_APROM
)paren
op_eq
l_int|0
)paren
op_logical_or
id|is_not_dec
)paren
(brace
r_if
c_cond
(paren
id|check_region
c_func
(paren
id|iobase
comma
id|DE4X5_PCI_TOTAL_SIZE
)paren
op_eq
l_int|0
)paren
(brace
r_if
c_cond
(paren
(paren
id|dev
op_assign
id|alloc_device
c_func
(paren
id|dev
comma
id|iobase
)paren
)paren
op_ne
l_int|NULL
)paren
(brace
id|dev-&gt;irq
op_assign
id|irq
suffix:semicolon
r_if
c_cond
(paren
(paren
id|status
op_assign
id|de4x5_hw_init
c_func
(paren
id|dev
comma
id|iobase
)paren
)paren
op_eq
l_int|0
)paren
(brace
id|num_de4x5s
op_increment
suffix:semicolon
)brace
id|num_eth
op_increment
suffix:semicolon
)brace
)brace
r_else
r_if
c_cond
(paren
id|autoprobed
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%s: region already allocated at 0x%04x.&bslash;n&quot;
comma
id|dev-&gt;name
comma
(paren
id|u_short
)paren
id|iobase
)paren
suffix:semicolon
)brace
)brace
)brace
)brace
)brace
)brace
)brace
)brace
r_return
suffix:semicolon
)brace
multiline_comment|/*&n;** Allocate the device by pointing to the next available space in the&n;** device structure. Should one not be available, it is created.&n;*/
DECL|function|alloc_device
r_static
r_struct
id|device
op_star
id|alloc_device
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
id|u_long
id|iobase
)paren
(brace
r_int
id|addAutoProbe
op_assign
l_int|0
suffix:semicolon
r_struct
id|device
op_star
id|tmp
op_assign
l_int|NULL
comma
op_star
id|ret
suffix:semicolon
r_int
(paren
op_star
id|init
)paren
(paren
r_struct
id|device
op_star
)paren
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/*&n;  ** Check the device structures for an end of list or unused device&n;  */
r_if
c_cond
(paren
op_logical_neg
id|loading_module
)paren
(brace
r_while
c_loop
(paren
id|dev-&gt;next
op_ne
l_int|NULL
)paren
(brace
r_if
c_cond
(paren
(paren
id|dev-&gt;base_addr
op_eq
id|DE4X5_NDA
)paren
op_logical_or
(paren
id|dev-&gt;base_addr
op_eq
l_int|0
)paren
)paren
r_break
suffix:semicolon
id|dev
op_assign
id|dev-&gt;next
suffix:semicolon
multiline_comment|/* walk through eth device list */
id|num_eth
op_increment
suffix:semicolon
multiline_comment|/* increment eth device number */
)brace
multiline_comment|/*&n;    ** If an autoprobe is requested for another device, we must re-insert&n;    ** the request later in the list. Remember the current position first.&n;    */
r_if
c_cond
(paren
(paren
id|dev-&gt;base_addr
op_eq
l_int|0
)paren
op_logical_and
(paren
id|num_de4x5s
OG
l_int|0
)paren
)paren
(brace
id|addAutoProbe
op_increment
suffix:semicolon
id|tmp
op_assign
id|dev-&gt;next
suffix:semicolon
multiline_comment|/* point to the next device */
id|init
op_assign
id|dev-&gt;init
suffix:semicolon
multiline_comment|/* remember the probe function */
)brace
multiline_comment|/*&n;    ** If at end of list and can&squot;t use current entry, malloc one up. &n;    ** If memory could not be allocated, print an error message.&n;    */
r_if
c_cond
(paren
(paren
id|dev-&gt;next
op_eq
l_int|NULL
)paren
op_logical_and
op_logical_neg
(paren
(paren
id|dev-&gt;base_addr
op_eq
id|DE4X5_NDA
)paren
op_logical_or
(paren
id|dev-&gt;base_addr
op_eq
l_int|0
)paren
)paren
)paren
(brace
id|dev-&gt;next
op_assign
(paren
r_struct
id|device
op_star
)paren
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|device
)paren
op_plus
l_int|8
comma
id|GFP_KERNEL
)paren
suffix:semicolon
id|dev
op_assign
id|dev-&gt;next
suffix:semicolon
multiline_comment|/* point to the new device */
r_if
c_cond
(paren
id|dev
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;eth%d: Device not initialised, insufficient memory&bslash;n&quot;
comma
id|num_eth
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/*&n;&t;** If the memory was allocated, point to the new memory area&n;&t;** and initialize it (name, I/O address, next device (NULL) and&n;&t;** initialisation probe routine).&n;&t;*/
id|dev-&gt;name
op_assign
(paren
r_char
op_star
)paren
(paren
id|dev
op_plus
r_sizeof
(paren
r_struct
id|device
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|num_eth
OG
l_int|9999
)paren
(brace
id|sprintf
c_func
(paren
id|dev-&gt;name
comma
l_string|&quot;eth????&quot;
)paren
suffix:semicolon
multiline_comment|/* New device name */
)brace
r_else
(brace
id|sprintf
c_func
(paren
id|dev-&gt;name
comma
l_string|&quot;eth%d&quot;
comma
id|num_eth
)paren
suffix:semicolon
multiline_comment|/* New device name */
)brace
id|dev-&gt;base_addr
op_assign
id|iobase
suffix:semicolon
multiline_comment|/* assign the io address */
id|dev-&gt;next
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/* mark the end of list */
id|dev-&gt;init
op_assign
op_amp
id|de4x5_probe
suffix:semicolon
multiline_comment|/* initialisation routine */
id|num_de4x5s
op_increment
suffix:semicolon
)brace
)brace
id|ret
op_assign
id|dev
suffix:semicolon
multiline_comment|/* return current struct, or NULL */
multiline_comment|/*&n;    ** Now figure out what to do with the autoprobe that has to be inserted.&n;    ** Firstly, search the (possibly altered) list for an empty space.&n;    */
r_if
c_cond
(paren
id|ret
op_ne
l_int|NULL
)paren
(brace
r_if
c_cond
(paren
id|addAutoProbe
)paren
(brace
r_for
c_loop
(paren
suffix:semicolon
(paren
id|tmp-&gt;next
op_ne
l_int|NULL
)paren
op_logical_and
(paren
id|tmp-&gt;base_addr
op_ne
id|DE4X5_NDA
)paren
suffix:semicolon
id|tmp
op_assign
id|tmp-&gt;next
)paren
suffix:semicolon
multiline_comment|/*&n;&t;** If no more device structures and can&squot;t use the current one, malloc&n;&t;** one up. If memory could not be allocated, print an error message.&n;&t;*/
r_if
c_cond
(paren
(paren
id|tmp-&gt;next
op_eq
l_int|NULL
)paren
op_logical_and
op_logical_neg
(paren
id|tmp-&gt;base_addr
op_eq
id|DE4X5_NDA
)paren
)paren
(brace
id|tmp-&gt;next
op_assign
(paren
r_struct
id|device
op_star
)paren
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|device
)paren
op_plus
l_int|8
comma
id|GFP_KERNEL
)paren
suffix:semicolon
id|tmp
op_assign
id|tmp-&gt;next
suffix:semicolon
multiline_comment|/* point to the new device */
r_if
c_cond
(paren
id|tmp
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%s: Insufficient memory to extend the device list.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/*&n;&t;    ** If the memory was allocated, point to the new memory area&n;&t;    ** and initialize it (name, I/O address, next device (NULL) and&n;&t;    ** initialisation probe routine).&n;&t;    */
id|tmp-&gt;name
op_assign
(paren
r_char
op_star
)paren
(paren
id|tmp
op_plus
r_sizeof
(paren
r_struct
id|device
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|num_eth
OG
l_int|9999
)paren
(brace
id|sprintf
c_func
(paren
id|tmp-&gt;name
comma
l_string|&quot;eth????&quot;
)paren
suffix:semicolon
multiline_comment|/* New device name */
)brace
r_else
(brace
id|sprintf
c_func
(paren
id|tmp-&gt;name
comma
l_string|&quot;eth%d&quot;
comma
id|num_eth
)paren
suffix:semicolon
multiline_comment|/* New device name */
)brace
id|tmp-&gt;base_addr
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* re-insert the io address */
id|tmp-&gt;next
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/* mark the end of list */
id|tmp-&gt;init
op_assign
id|init
suffix:semicolon
multiline_comment|/* initialisation routine */
)brace
)brace
r_else
(brace
multiline_comment|/* structure already exists */
id|tmp-&gt;base_addr
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* re-insert the io address */
)brace
)brace
)brace
)brace
r_else
(brace
id|ret
op_assign
id|dev
suffix:semicolon
)brace
r_return
id|ret
suffix:semicolon
)brace
multiline_comment|/*&n;** Auto configure the media here rather than setting the port at compile&n;** time. This routine is called by de4x5_init() when a loss of media is&n;** detected (excessive collisions, loss of carrier, no carrier or link fail&n;** [TP]) to check whether the user has been sneaky and changed the port on us.&n;*/
DECL|function|autoconf_media
r_static
r_int
id|autoconf_media
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
r_struct
id|de4x5_private
op_star
id|lp
op_assign
(paren
r_struct
id|de4x5_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|u_long
id|iobase
op_assign
id|dev-&gt;base_addr
suffix:semicolon
id|lp-&gt;tx_enable
op_assign
id|YES
suffix:semicolon
r_if
c_cond
(paren
id|de4x5_debug
OG
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|lp-&gt;chipset
op_ne
id|DC21140
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%s: Searching for media... &quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
)brace
r_else
(brace
id|printk
c_func
(paren
l_string|&quot;%s: Searching for mode... &quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|lp-&gt;chipset
op_eq
id|DC21040
)paren
(brace
id|lp-&gt;media
op_assign
(paren
id|lp-&gt;autosense
op_eq
id|AUTO
ques
c_cond
id|TP
suffix:colon
id|lp-&gt;autosense
)paren
suffix:semicolon
id|dc21040_autoconf
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|lp-&gt;chipset
op_eq
id|DC21041
)paren
(brace
id|lp-&gt;media
op_assign
(paren
id|lp-&gt;autosense
op_eq
id|AUTO
ques
c_cond
id|TP_NW
suffix:colon
id|lp-&gt;autosense
)paren
suffix:semicolon
id|dc21041_autoconf
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|lp-&gt;chipset
op_eq
id|DC21140
)paren
(brace
id|disable_ast
c_func
(paren
id|dev
)paren
suffix:semicolon
id|lp-&gt;media
op_assign
(paren
id|lp-&gt;autosense
op_eq
id|AUTO
ques
c_cond
id|_10Mb
suffix:colon
id|lp-&gt;autosense
)paren
suffix:semicolon
id|dc21140_autoconf
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|de4x5_debug
OG
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|lp-&gt;chipset
op_ne
id|DC21140
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;media is %s&bslash;n&quot;
comma
(paren
id|lp-&gt;media
op_eq
id|NC
ques
c_cond
l_string|&quot;unconnected!&quot;
suffix:colon
(paren
id|lp-&gt;media
op_eq
id|TP
ques
c_cond
l_string|&quot;TP.&quot;
suffix:colon
(paren
id|lp-&gt;media
op_eq
id|ANS
ques
c_cond
l_string|&quot;TP/Nway.&quot;
suffix:colon
(paren
id|lp-&gt;media
op_eq
id|BNC
ques
c_cond
l_string|&quot;BNC.&quot;
suffix:colon
(paren
id|lp-&gt;media
op_eq
id|AUI
ques
c_cond
l_string|&quot;AUI.&quot;
suffix:colon
l_string|&quot;BNC/AUI.&quot;
)paren
)paren
)paren
)paren
)paren
)paren
suffix:semicolon
)brace
r_else
(brace
id|printk
c_func
(paren
l_string|&quot;mode is %s&bslash;n&quot;
comma
(paren
id|lp-&gt;media
op_eq
id|NC
ques
c_cond
l_string|&quot;link down.&quot;
suffix:colon
(paren
id|lp-&gt;media
op_eq
id|_100Mb
ques
c_cond
l_string|&quot;100Mb/s.&quot;
suffix:colon
(paren
id|lp-&gt;media
op_eq
id|_10Mb
ques
c_cond
l_string|&quot;10Mb/s.&quot;
suffix:colon
l_string|&quot;&bslash;?&bslash;?&bslash;?&quot;
)paren
)paren
)paren
)paren
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|lp-&gt;media
)paren
(brace
id|lp-&gt;lostMedia
op_assign
l_int|0
suffix:semicolon
id|inl
c_func
(paren
id|DE4X5_MFC
)paren
suffix:semicolon
multiline_comment|/* Zero the lost frames counter */
r_if
c_cond
(paren
(paren
id|lp-&gt;media
op_eq
id|TP
)paren
op_logical_or
(paren
id|lp-&gt;media
op_eq
id|ANS
)paren
)paren
(brace
id|lp-&gt;irq_mask
op_or_assign
id|IMR_LFM
suffix:semicolon
)brace
)brace
id|dce_ms_delay
c_func
(paren
l_int|10
)paren
suffix:semicolon
r_return
(paren
id|lp-&gt;media
)paren
suffix:semicolon
)brace
DECL|function|dc21040_autoconf
r_static
r_void
id|dc21040_autoconf
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
r_struct
id|de4x5_private
op_star
id|lp
op_assign
(paren
r_struct
id|de4x5_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|u_long
id|iobase
op_assign
id|dev-&gt;base_addr
suffix:semicolon
r_int
id|i
comma
id|linkBad
suffix:semicolon
id|s32
id|sisr
op_assign
l_int|0
comma
id|t_3s
op_assign
l_int|3000
suffix:semicolon
r_switch
c_cond
(paren
id|lp-&gt;media
)paren
(brace
r_case
id|TP
suffix:colon
id|reset_init_sia
c_func
(paren
id|dev
comma
l_int|0x8f01
comma
l_int|0xffff
comma
l_int|0x0000
)paren
suffix:semicolon
r_for
c_loop
(paren
id|linkBad
op_assign
l_int|1
comma
id|i
op_assign
l_int|0
suffix:semicolon
(paren
id|i
OL
id|t_3s
)paren
op_logical_and
id|linkBad
op_logical_and
op_logical_neg
(paren
id|sisr
op_amp
id|SISR_NCR
)paren
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
(paren
(paren
id|sisr
op_assign
id|inl
c_func
(paren
id|DE4X5_SISR
)paren
)paren
op_amp
id|SISR_LKF
)paren
op_eq
l_int|0
)paren
id|linkBad
op_assign
l_int|0
suffix:semicolon
id|dce_ms_delay
c_func
(paren
l_int|1
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|linkBad
op_logical_and
(paren
id|lp-&gt;autosense
op_eq
id|AUTO
)paren
)paren
(brace
id|lp-&gt;media
op_assign
id|BNC_AUI
suffix:semicolon
id|dc21040_autoconf
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|BNC
suffix:colon
r_case
id|AUI
suffix:colon
r_case
id|BNC_AUI
suffix:colon
id|reset_init_sia
c_func
(paren
id|dev
comma
l_int|0x8f09
comma
l_int|0x0705
comma
l_int|0x0006
)paren
suffix:semicolon
id|dce_ms_delay
c_func
(paren
l_int|500
)paren
suffix:semicolon
id|linkBad
op_assign
id|ping_media
c_func
(paren
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|linkBad
op_logical_and
(paren
id|lp-&gt;autosense
op_eq
id|AUTO
)paren
)paren
(brace
id|lp-&gt;media
op_assign
id|EXT_SIA
suffix:semicolon
id|dc21040_autoconf
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|EXT_SIA
suffix:colon
id|reset_init_sia
c_func
(paren
id|dev
comma
l_int|0x3041
comma
l_int|0x0000
comma
l_int|0x0006
)paren
suffix:semicolon
id|dce_ms_delay
c_func
(paren
l_int|500
)paren
suffix:semicolon
id|linkBad
op_assign
id|ping_media
c_func
(paren
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|linkBad
op_logical_and
(paren
id|lp-&gt;autosense
op_eq
id|AUTO
)paren
)paren
(brace
id|lp-&gt;media
op_assign
id|NC
suffix:semicolon
id|dc21040_autoconf
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|NC
suffix:colon
macro_line|#ifndef __alpha__
id|reset_init_sia
c_func
(paren
id|dev
comma
l_int|0x8f01
comma
l_int|0xffff
comma
l_int|0x0000
)paren
suffix:semicolon
r_break
suffix:semicolon
macro_line|#else
multiline_comment|/* JAE: for Alpha, default to BNC/AUI, *not* TP */
id|reset_init_sia
c_func
(paren
id|dev
comma
l_int|0x8f09
comma
l_int|0x0705
comma
l_int|0x0006
)paren
suffix:semicolon
macro_line|#endif  /* i386 */
)brace
r_return
suffix:semicolon
)brace
multiline_comment|/*&n;** Autoconfigure the media when using the DC21041. AUI needs to be tested&n;** before BNC, because the BNC port will indicate activity if it&squot;s not&n;** terminated correctly. The only way to test for that is to place a loopback&n;** packet onto the network and watch for errors.&n;*/
DECL|function|dc21041_autoconf
r_static
r_void
id|dc21041_autoconf
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
r_struct
id|de4x5_private
op_star
id|lp
op_assign
(paren
r_struct
id|de4x5_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|u_long
id|iobase
op_assign
id|dev-&gt;base_addr
suffix:semicolon
id|s32
id|sts
comma
id|irqs
comma
id|irq_mask
comma
id|omr
suffix:semicolon
r_switch
c_cond
(paren
id|lp-&gt;media
)paren
(brace
r_case
id|TP_NW
suffix:colon
id|omr
op_assign
id|inl
c_func
(paren
id|DE4X5_OMR
)paren
suffix:semicolon
multiline_comment|/* Set up full duplex for the autonegotiate */
id|outl
c_func
(paren
id|omr
op_or
id|OMR_FD
comma
id|DE4X5_OMR
)paren
suffix:semicolon
id|irqs
op_assign
id|STS_LNF
op_or
id|STS_LNP
suffix:semicolon
id|irq_mask
op_assign
id|IMR_LFM
op_or
id|IMR_LPM
suffix:semicolon
id|sts
op_assign
id|test_media
c_func
(paren
id|dev
comma
id|irqs
comma
id|irq_mask
comma
l_int|0xef01
comma
l_int|0xffff
comma
l_int|0x0008
comma
l_int|2400
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sts
op_amp
id|STS_LNP
)paren
(brace
id|lp-&gt;media
op_assign
id|ANS
suffix:semicolon
)brace
r_else
(brace
id|lp-&gt;media
op_assign
id|AUI
suffix:semicolon
)brace
id|dc21041_autoconf
c_func
(paren
id|dev
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ANS
suffix:colon
id|irqs
op_assign
id|STS_LNP
suffix:semicolon
id|irq_mask
op_assign
id|IMR_LPM
suffix:semicolon
id|sts
op_assign
id|test_ans
c_func
(paren
id|dev
comma
id|irqs
comma
id|irq_mask
comma
l_int|3000
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|sts
op_amp
id|STS_LNP
)paren
op_logical_and
(paren
id|lp-&gt;autosense
op_eq
id|AUTO
)paren
)paren
(brace
id|lp-&gt;media
op_assign
id|TP
suffix:semicolon
id|dc21041_autoconf
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|TP
suffix:colon
id|omr
op_assign
id|inl
c_func
(paren
id|DE4X5_OMR
)paren
suffix:semicolon
multiline_comment|/* Set up half duplex for TP */
id|outl
c_func
(paren
id|omr
op_amp
op_complement
id|OMR_FD
comma
id|DE4X5_OMR
)paren
suffix:semicolon
id|irqs
op_assign
id|STS_LNF
op_or
id|STS_LNP
suffix:semicolon
id|irq_mask
op_assign
id|IMR_LFM
op_or
id|IMR_LPM
suffix:semicolon
id|sts
op_assign
id|test_media
c_func
(paren
id|dev
comma
id|irqs
comma
id|irq_mask
comma
l_int|0xef01
comma
l_int|0xff3f
comma
l_int|0x0008
comma
l_int|2400
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|sts
op_amp
id|STS_LNP
)paren
op_logical_and
(paren
id|lp-&gt;autosense
op_eq
id|AUTO
)paren
)paren
(brace
r_if
c_cond
(paren
id|inl
c_func
(paren
id|DE4X5_SISR
)paren
op_amp
id|SISR_NRA
)paren
(brace
multiline_comment|/* Non selected port activity */
id|lp-&gt;media
op_assign
id|AUI
suffix:semicolon
)brace
r_else
(brace
id|lp-&gt;media
op_assign
id|BNC
suffix:semicolon
)brace
id|dc21041_autoconf
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|AUI
suffix:colon
id|omr
op_assign
id|inl
c_func
(paren
id|DE4X5_OMR
)paren
suffix:semicolon
multiline_comment|/* Set up half duplex for AUI */
id|outl
c_func
(paren
id|omr
op_amp
op_complement
id|OMR_FD
comma
id|DE4X5_OMR
)paren
suffix:semicolon
id|irqs
op_assign
l_int|0
suffix:semicolon
id|irq_mask
op_assign
l_int|0
suffix:semicolon
id|sts
op_assign
id|test_media
c_func
(paren
id|dev
comma
id|irqs
comma
id|irq_mask
comma
l_int|0xef09
comma
l_int|0xf7fd
comma
l_int|0x000e
comma
l_int|1000
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|inl
c_func
(paren
id|DE4X5_SISR
)paren
op_amp
id|SISR_SRA
)paren
op_logical_and
(paren
id|lp-&gt;autosense
op_eq
id|AUTO
)paren
)paren
(brace
id|lp-&gt;media
op_assign
id|BNC
suffix:semicolon
id|dc21041_autoconf
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|BNC
suffix:colon
id|omr
op_assign
id|inl
c_func
(paren
id|DE4X5_OMR
)paren
suffix:semicolon
multiline_comment|/* Set up half duplex for BNC */
id|outl
c_func
(paren
id|omr
op_amp
op_complement
id|OMR_FD
comma
id|DE4X5_OMR
)paren
suffix:semicolon
id|irqs
op_assign
l_int|0
suffix:semicolon
id|irq_mask
op_assign
l_int|0
suffix:semicolon
id|sts
op_assign
id|test_media
c_func
(paren
id|dev
comma
id|irqs
comma
id|irq_mask
comma
l_int|0xef09
comma
l_int|0xf7fd
comma
l_int|0x0006
comma
l_int|1000
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|inl
c_func
(paren
id|DE4X5_SISR
)paren
op_amp
id|SISR_SRA
)paren
op_logical_and
(paren
id|lp-&gt;autosense
op_eq
id|AUTO
)paren
)paren
(brace
id|lp-&gt;media
op_assign
id|NC
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* Ensure media connected */
r_if
c_cond
(paren
id|ping_media
c_func
(paren
id|dev
)paren
)paren
id|lp-&gt;media
op_assign
id|NC
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|NC
suffix:colon
id|omr
op_assign
id|inl
c_func
(paren
id|DE4X5_OMR
)paren
suffix:semicolon
multiline_comment|/* Set up full duplex for the autonegotiate */
id|outl
c_func
(paren
id|omr
op_or
id|OMR_FD
comma
id|DE4X5_OMR
)paren
suffix:semicolon
id|reset_init_sia
c_func
(paren
id|dev
comma
l_int|0xef01
comma
l_int|0xffff
comma
l_int|0x0008
)paren
suffix:semicolon
multiline_comment|/* Initialise the SIA */
r_break
suffix:semicolon
)brace
r_return
suffix:semicolon
)brace
multiline_comment|/*&n;** Reduced feature version (temporary I hope)&n;*/
DECL|function|dc21140_autoconf
r_static
r_void
id|dc21140_autoconf
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
r_struct
id|de4x5_private
op_star
id|lp
op_assign
(paren
r_struct
id|de4x5_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|u_long
id|iobase
op_assign
id|dev-&gt;base_addr
suffix:semicolon
id|s32
id|omr
suffix:semicolon
r_switch
c_cond
(paren
id|lp-&gt;media
)paren
(brace
r_case
id|_100Mb
suffix:colon
multiline_comment|/* Set 100Mb/s, MII Port with PCS Function and Scrambler */
id|omr
op_assign
(paren
id|inl
c_func
(paren
id|DE4X5_OMR
)paren
op_amp
op_complement
(paren
id|OMR_PS
op_or
id|OMR_HBD
op_or
id|OMR_TTM
op_or
id|OMR_PCS
op_or
id|OMR_SCR
)paren
)paren
suffix:semicolon
id|omr
op_or_assign
(paren
id|de4x5_full_duplex
ques
c_cond
id|OMR_FD
suffix:colon
l_int|0
)paren
suffix:semicolon
multiline_comment|/* Set up Full Duplex */
id|outl
c_func
(paren
id|omr
op_or
id|OMR_PS
op_or
id|OMR_HBD
op_or
id|OMR_PCS
op_or
id|OMR_SCR
comma
id|DE4X5_OMR
)paren
suffix:semicolon
id|outl
c_func
(paren
id|GEP_FDXD
op_or
id|GEP_MODE
comma
id|DE4X5_GEP
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|_10Mb
suffix:colon
multiline_comment|/* Set conventional 10Mb/s ENDEC interface */
id|omr
op_assign
(paren
id|inl
c_func
(paren
id|DE4X5_OMR
)paren
op_amp
op_complement
(paren
id|OMR_PS
op_or
id|OMR_HBD
op_or
id|OMR_TTM
op_or
id|OMR_PCS
op_or
id|OMR_SCR
)paren
)paren
suffix:semicolon
id|omr
op_or_assign
(paren
id|de4x5_full_duplex
ques
c_cond
id|OMR_FD
suffix:colon
l_int|0
)paren
suffix:semicolon
multiline_comment|/* Set up Full Duplex */
id|outl
c_func
(paren
id|omr
op_or
id|OMR_TTM
comma
id|DE4X5_OMR
)paren
suffix:semicolon
id|outl
c_func
(paren
id|GEP_FDXD
comma
id|DE4X5_GEP
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_return
suffix:semicolon
)brace
r_static
r_int
DECL|function|test_media
id|test_media
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
id|s32
id|irqs
comma
id|s32
id|irq_mask
comma
id|s32
id|csr13
comma
id|s32
id|csr14
comma
id|s32
id|csr15
comma
id|s32
id|msec
)paren
(brace
r_struct
id|de4x5_private
op_star
id|lp
op_assign
(paren
r_struct
id|de4x5_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|u_long
id|iobase
op_assign
id|dev-&gt;base_addr
suffix:semicolon
id|s32
id|sts
comma
id|time
comma
id|csr12
suffix:semicolon
id|reset_init_sia
c_func
(paren
id|dev
comma
id|csr13
comma
id|csr14
comma
id|csr15
)paren
suffix:semicolon
multiline_comment|/* Set link_fail_inhibit_timer */
id|load_ms_timer
c_func
(paren
id|dev
comma
id|msec
)paren
suffix:semicolon
multiline_comment|/* clear all pending interrupts */
id|sts
op_assign
id|inl
c_func
(paren
id|DE4X5_STS
)paren
suffix:semicolon
id|outl
c_func
(paren
id|sts
comma
id|DE4X5_STS
)paren
suffix:semicolon
multiline_comment|/* clear csr12 NRA and SRA bits */
id|csr12
op_assign
id|inl
c_func
(paren
id|DE4X5_SISR
)paren
suffix:semicolon
id|outl
c_func
(paren
id|csr12
comma
id|DE4X5_SISR
)paren
suffix:semicolon
multiline_comment|/* Poll for timeout - timer interrupt doesn&squot;t work correctly */
r_do
(brace
id|time
op_assign
id|inl
c_func
(paren
id|DE4X5_GPT
)paren
op_amp
id|GPT_VAL
suffix:semicolon
id|sts
op_assign
id|inl
c_func
(paren
id|DE4X5_STS
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
(paren
id|time
op_ne
l_int|0
)paren
op_logical_and
op_logical_neg
(paren
id|sts
op_amp
id|irqs
)paren
)paren
suffix:semicolon
id|sts
op_assign
id|inl
c_func
(paren
id|DE4X5_STS
)paren
suffix:semicolon
r_return
id|sts
suffix:semicolon
)brace
multiline_comment|/*&n;static int test_sym_link(struct device *dev, u32 msec)&n;{&n;  struct de4x5_private *lp = (struct de4x5_private *)dev-&gt;priv;&n;  u_long iobase = dev-&gt;base_addr;&n;  u32 gep, time;&n;&n;  / * Set link_fail_inhibit_timer * /&n;  load_ms_timer(dev, msec);&n;&n;  / * Poll for timeout or SYM_LINK=0 * /&n;  do {&n;    time = inl(DE4X5_GPT) &amp; GPT_VAL;&n;    gep = inl(DE4X5_GEP) &amp; (GEP_SLNK | GEP_LNP);&n;  } while ((time &gt; 0) &amp;&amp; (gep &amp; GEP_SLNK));&n;&n;  return gep;&n;}&n;*/
multiline_comment|/*&n;** Send a packet onto the media and watch for send errors that indicate the&n;** media is bad or unconnected.&n;*/
DECL|function|ping_media
r_static
r_int
id|ping_media
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
r_struct
id|de4x5_private
op_star
id|lp
op_assign
(paren
r_struct
id|de4x5_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|u_long
id|iobase
op_assign
id|dev-&gt;base_addr
suffix:semicolon
r_int
id|i
comma
id|entry
comma
id|linkBad
suffix:semicolon
id|s32
id|omr
comma
id|t_3s
op_assign
l_int|4000
suffix:semicolon
r_char
id|frame
(braket
l_int|64
)braket
suffix:semicolon
id|create_packet
c_func
(paren
id|dev
comma
id|frame
comma
r_sizeof
(paren
id|frame
)paren
)paren
suffix:semicolon
id|entry
op_assign
id|lp-&gt;tx_new
suffix:semicolon
multiline_comment|/* Remember the ring position */
id|load_packet
c_func
(paren
id|dev
comma
id|frame
comma
id|TD_LS
op_or
id|TD_FS
op_or
r_sizeof
(paren
id|frame
)paren
comma
l_int|NULL
)paren
suffix:semicolon
id|omr
op_assign
id|inl
c_func
(paren
id|DE4X5_OMR
)paren
suffix:semicolon
id|outl
c_func
(paren
id|omr
op_or
id|OMR_ST
comma
id|DE4X5_OMR
)paren
suffix:semicolon
id|lp-&gt;tx_new
op_assign
(paren
op_increment
id|lp-&gt;tx_new
)paren
op_mod
id|lp-&gt;txRingSize
suffix:semicolon
id|lp-&gt;tx_old
op_assign
id|lp-&gt;tx_new
suffix:semicolon
multiline_comment|/* Poll for completion of frame (interrupts are disabled for now)... */
r_for
c_loop
(paren
id|linkBad
op_assign
l_int|1
comma
id|i
op_assign
l_int|0
suffix:semicolon
(paren
id|i
OL
id|t_3s
)paren
op_logical_and
id|linkBad
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
(paren
id|inl
c_func
(paren
id|DE4X5_SISR
)paren
op_amp
id|SISR_NCR
)paren
op_eq
l_int|1
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
id|lp-&gt;tx_ring
(braket
id|entry
)braket
dot
id|status
op_ge
l_int|0
)paren
id|linkBad
op_assign
l_int|0
suffix:semicolon
id|dce_ms_delay
c_func
(paren
l_int|1
)paren
suffix:semicolon
)brace
id|outl
c_func
(paren
id|omr
comma
id|DE4X5_OMR
)paren
suffix:semicolon
r_return
(paren
(paren
id|linkBad
op_logical_or
(paren
id|lp-&gt;tx_ring
(braket
id|entry
)braket
dot
id|status
op_amp
id|TD_ES
)paren
)paren
ques
c_cond
l_int|1
suffix:colon
l_int|0
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;** Check the Auto Negotiation State. Return OK when a link pass interrupt&n;** is received and the auto-negotiation status is NWAY OK.&n;*/
DECL|function|test_ans
r_static
r_int
id|test_ans
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
id|s32
id|irqs
comma
id|s32
id|irq_mask
comma
id|s32
id|msec
)paren
(brace
r_struct
id|de4x5_private
op_star
id|lp
op_assign
(paren
r_struct
id|de4x5_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|u_long
id|iobase
op_assign
id|dev-&gt;base_addr
suffix:semicolon
id|s32
id|sts
comma
id|ans
suffix:semicolon
id|outl
c_func
(paren
id|irq_mask
comma
id|DE4X5_IMR
)paren
suffix:semicolon
multiline_comment|/* Set timeout limit */
id|load_ms_timer
c_func
(paren
id|dev
comma
id|msec
)paren
suffix:semicolon
multiline_comment|/* clear all pending interrupts */
id|sts
op_assign
id|inl
c_func
(paren
id|DE4X5_STS
)paren
suffix:semicolon
id|outl
c_func
(paren
id|sts
comma
id|DE4X5_STS
)paren
suffix:semicolon
multiline_comment|/* Poll for interrupts */
r_do
(brace
id|ans
op_assign
id|inl
c_func
(paren
id|DE4X5_SISR
)paren
op_amp
id|SISR_ANS
suffix:semicolon
id|sts
op_assign
id|inl
c_func
(paren
id|DE4X5_STS
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
op_logical_neg
(paren
id|sts
op_amp
id|irqs
)paren
op_logical_and
(paren
id|ans
op_xor
id|ANS_NWOK
)paren
op_ne
l_int|0
)paren
suffix:semicolon
r_return
(paren
(paren
id|sts
op_amp
id|STS_LNP
)paren
op_logical_and
(paren
(paren
id|ans
op_xor
id|ANS_NWOK
)paren
op_eq
l_int|0
)paren
ques
c_cond
id|STS_LNP
suffix:colon
l_int|0
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;**&n;*/
DECL|function|reset_init_sia
r_static
r_void
id|reset_init_sia
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
id|s32
id|sicr
comma
id|s32
id|strr
comma
id|s32
id|sigr
)paren
(brace
r_struct
id|de4x5_private
op_star
id|lp
op_assign
(paren
r_struct
id|de4x5_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|u_long
id|iobase
op_assign
id|dev-&gt;base_addr
suffix:semicolon
id|RESET_SIA
suffix:semicolon
id|outl
c_func
(paren
id|sigr
comma
id|DE4X5_SIGR
)paren
suffix:semicolon
id|outl
c_func
(paren
id|strr
comma
id|DE4X5_STRR
)paren
suffix:semicolon
id|outl
c_func
(paren
id|sicr
comma
id|DE4X5_SICR
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/*&n;** Load the timer on the DC21041 and 21140. Max time is 13.42 secs.&n;*/
DECL|function|load_ms_timer
r_static
r_void
id|load_ms_timer
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
id|u32
id|msec
)paren
(brace
r_struct
id|de4x5_private
op_star
id|lp
op_assign
(paren
r_struct
id|de4x5_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|u_long
id|iobase
op_assign
id|dev-&gt;base_addr
suffix:semicolon
id|s32
id|i
op_assign
l_int|2048
comma
id|j
suffix:semicolon
r_if
c_cond
(paren
id|lp-&gt;chipset
op_eq
id|DC21140
)paren
(brace
id|j
op_assign
id|inl
c_func
(paren
id|DE4X5_OMR
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|j
op_amp
id|OMR_TTM
)paren
op_logical_and
(paren
id|j
op_amp
id|OMR_PS
)paren
)paren
(brace
multiline_comment|/* 10Mb/s MII */
id|i
op_assign
l_int|8192
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
(paren
op_complement
id|j
op_amp
id|OMR_TTM
)paren
op_logical_and
(paren
id|j
op_amp
id|OMR_PS
)paren
)paren
(brace
multiline_comment|/* 100Mb/s MII */
id|i
op_assign
l_int|819
suffix:semicolon
)brace
)brace
id|outl
c_func
(paren
(paren
id|s32
)paren
(paren
id|msec
op_star
l_int|10000
)paren
op_div
id|i
comma
id|DE4X5_GPT
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/*&n;** Create an Ethernet packet with an invalid CRC&n;*/
DECL|function|create_packet
r_static
r_void
id|create_packet
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
r_char
op_star
id|frame
comma
r_int
id|len
)paren
(brace
r_int
id|i
suffix:semicolon
r_char
op_star
id|buf
op_assign
id|frame
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|ETH_ALEN
suffix:semicolon
id|i
op_increment
)paren
(brace
multiline_comment|/* Use this source address */
op_star
id|buf
op_increment
op_assign
id|dev-&gt;dev_addr
(braket
id|i
)braket
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|ETH_ALEN
suffix:semicolon
id|i
op_increment
)paren
(brace
multiline_comment|/* Use this destination address */
op_star
id|buf
op_increment
op_assign
id|dev-&gt;dev_addr
(braket
id|i
)braket
suffix:semicolon
)brace
op_star
id|buf
op_increment
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Packet length (2 bytes) */
op_star
id|buf
op_increment
op_assign
l_int|1
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/*&n;** Known delay in microseconds&n;*/
DECL|function|dce_us_delay
r_static
r_void
id|dce_us_delay
c_func
(paren
id|u32
id|usec
)paren
(brace
id|udelay
c_func
(paren
id|usec
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/*&n;** Known delay in milliseconds, in millisecond steps.&n;*/
DECL|function|dce_ms_delay
r_static
r_void
id|dce_ms_delay
c_func
(paren
id|u32
id|msec
)paren
(brace
id|u_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|msec
suffix:semicolon
id|i
op_increment
)paren
(brace
id|dce_us_delay
c_func
(paren
l_int|1000
)paren
suffix:semicolon
)brace
r_return
suffix:semicolon
)brace
multiline_comment|/*&n;** Look for a particular board name in the EISA configuration space&n;*/
DECL|function|EISA_signature
r_static
r_int
id|EISA_signature
c_func
(paren
r_char
op_star
id|name
comma
id|s32
id|eisa_id
)paren
(brace
id|u_int
id|i
suffix:semicolon
r_const
r_char
op_star
id|signatures
(braket
)braket
op_assign
id|DE4X5_SIGNATURE
suffix:semicolon
r_char
id|ManCode
(braket
id|DE4X5_STRLEN
)braket
suffix:semicolon
r_union
(brace
id|s32
id|ID
suffix:semicolon
r_char
id|Id
(braket
l_int|4
)braket
suffix:semicolon
)brace
id|Eisa
suffix:semicolon
r_int
id|status
op_assign
l_int|0
suffix:semicolon
op_star
id|name
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
id|Eisa.ID
op_assign
id|inl
c_func
(paren
id|eisa_id
)paren
suffix:semicolon
id|ManCode
(braket
l_int|0
)braket
op_assign
(paren
(paren
(paren
id|Eisa.Id
(braket
l_int|0
)braket
op_rshift
l_int|2
)paren
op_amp
l_int|0x1f
)paren
op_plus
l_int|0x40
)paren
suffix:semicolon
id|ManCode
(braket
l_int|1
)braket
op_assign
(paren
(paren
(paren
id|Eisa.Id
(braket
l_int|1
)braket
op_amp
l_int|0xe0
)paren
op_rshift
l_int|5
)paren
op_plus
(paren
(paren
id|Eisa.Id
(braket
l_int|0
)braket
op_amp
l_int|0x03
)paren
op_lshift
l_int|3
)paren
op_plus
l_int|0x40
)paren
suffix:semicolon
id|ManCode
(braket
l_int|2
)braket
op_assign
(paren
(paren
(paren
id|Eisa.Id
(braket
l_int|2
)braket
op_rshift
l_int|4
)paren
op_amp
l_int|0x0f
)paren
op_plus
l_int|0x30
)paren
suffix:semicolon
id|ManCode
(braket
l_int|3
)braket
op_assign
(paren
(paren
id|Eisa.Id
(braket
l_int|2
)braket
op_amp
l_int|0x0f
)paren
op_plus
l_int|0x30
)paren
suffix:semicolon
id|ManCode
(braket
l_int|4
)braket
op_assign
(paren
(paren
(paren
id|Eisa.Id
(braket
l_int|3
)braket
op_rshift
l_int|4
)paren
op_amp
l_int|0x0f
)paren
op_plus
l_int|0x30
)paren
suffix:semicolon
id|ManCode
(braket
l_int|5
)braket
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
(paren
op_star
id|signatures
(braket
id|i
)braket
op_ne
l_char|&squot;&bslash;0&squot;
)paren
op_logical_and
(paren
op_star
id|name
op_eq
l_char|&squot;&bslash;0&squot;
)paren
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|strstr
c_func
(paren
id|ManCode
comma
id|signatures
(braket
id|i
)braket
)paren
op_ne
l_int|NULL
)paren
(brace
id|strcpy
c_func
(paren
id|name
comma
id|ManCode
)paren
suffix:semicolon
id|status
op_assign
l_int|1
suffix:semicolon
)brace
)brace
r_return
id|status
suffix:semicolon
multiline_comment|/* return the device name string */
)brace
multiline_comment|/*&n;** Look for a special sequence in the Ethernet station address PROM that&n;** is common across all DIGITAL network adapter products.&n;** &n;** Search the Ethernet address ROM for the signature. Since the ROM address&n;** counter can start at an arbitrary point, the search must include the entire&n;** probe sequence length plus the (length_of_the_signature - 1).&n;** Stop the search IMMEDIATELY after the signature is found so that the&n;** PROM address counter is correctly positioned at the start of the&n;** ethernet address for later read out.&n;*/
DECL|function|DevicePresent
r_static
r_int
id|DevicePresent
c_func
(paren
id|u_long
id|aprom_addr
)paren
(brace
r_union
(brace
r_struct
(brace
id|u32
id|a
suffix:semicolon
id|u32
id|b
suffix:semicolon
)brace
id|llsig
suffix:semicolon
r_char
id|Sig
(braket
r_sizeof
(paren
id|u32
)paren
op_lshift
l_int|1
)braket
suffix:semicolon
)brace
id|dev
suffix:semicolon
r_char
id|data
suffix:semicolon
r_int
id|i
comma
id|j
comma
id|tmp
comma
id|status
op_assign
l_int|0
suffix:semicolon
r_int
id|sigLength
suffix:semicolon
r_struct
id|bus_type
op_star
id|lp
op_assign
op_amp
id|bus
suffix:semicolon
id|dev.llsig.a
op_assign
id|ETH_PROM_SIG
suffix:semicolon
id|dev.llsig.b
op_assign
id|ETH_PROM_SIG
suffix:semicolon
id|sigLength
op_assign
r_sizeof
(paren
id|u32
)paren
op_lshift
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|lp-&gt;chipset
op_eq
id|DC21040
)paren
(brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
comma
id|j
op_assign
l_int|0
suffix:semicolon
(paren
id|j
OL
id|sigLength
)paren
op_logical_and
(paren
id|i
OL
id|PROBE_LENGTH
op_plus
id|sigLength
op_minus
l_int|1
)paren
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|lp-&gt;bus
op_eq
id|PCI
)paren
(brace
r_while
c_loop
(paren
(paren
id|tmp
op_assign
id|inl
c_func
(paren
id|aprom_addr
)paren
)paren
OL
l_int|0
)paren
suffix:semicolon
id|data
op_assign
(paren
r_char
)paren
id|tmp
suffix:semicolon
)brace
r_else
(brace
id|data
op_assign
id|inb
c_func
(paren
id|aprom_addr
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|dev.Sig
(braket
id|j
)braket
op_eq
id|data
)paren
(brace
multiline_comment|/* track signature */
id|j
op_increment
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* lost signature; begin search again */
r_if
c_cond
(paren
id|data
op_eq
id|dev.Sig
(braket
l_int|0
)braket
)paren
(brace
id|j
op_assign
l_int|1
suffix:semicolon
)brace
r_else
(brace
id|j
op_assign
l_int|0
suffix:semicolon
)brace
)brace
)brace
r_if
c_cond
(paren
id|j
op_ne
id|sigLength
)paren
(brace
id|status
op_assign
op_minus
id|ENODEV
suffix:semicolon
multiline_comment|/* search failed */
)brace
)brace
r_else
(brace
multiline_comment|/* use new srom */
r_int
op_star
id|p
op_assign
(paren
r_int
op_star
)paren
op_amp
id|lp-&gt;srom
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
(paren
r_sizeof
(paren
r_struct
id|de4x5_srom
)paren
op_rshift
l_int|1
)paren
suffix:semicolon
id|i
op_increment
)paren
(brace
op_star
id|p
op_increment
op_assign
id|srom_rd
c_func
(paren
id|aprom_addr
comma
id|i
)paren
suffix:semicolon
)brace
)brace
r_return
id|status
suffix:semicolon
)brace
DECL|function|get_hw_addr
r_static
r_int
id|get_hw_addr
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
id|u_long
id|iobase
op_assign
id|dev-&gt;base_addr
suffix:semicolon
r_int
id|i
comma
id|k
comma
id|tmp
comma
id|status
op_assign
l_int|0
suffix:semicolon
id|u_short
id|j
comma
id|chksum
suffix:semicolon
r_struct
id|bus_type
op_star
id|lp
op_assign
op_amp
id|bus
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
comma
id|k
op_assign
l_int|0
comma
id|j
op_assign
l_int|0
suffix:semicolon
id|j
OL
l_int|3
suffix:semicolon
id|j
op_increment
)paren
(brace
id|k
op_lshift_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|k
OG
l_int|0xffff
)paren
id|k
op_sub_assign
l_int|0xffff
suffix:semicolon
r_if
c_cond
(paren
id|lp-&gt;bus
op_eq
id|PCI
)paren
(brace
r_if
c_cond
(paren
id|lp-&gt;chipset
op_eq
id|DC21040
)paren
(brace
r_while
c_loop
(paren
(paren
id|tmp
op_assign
id|inl
c_func
(paren
id|DE4X5_APROM
)paren
)paren
OL
l_int|0
)paren
suffix:semicolon
id|k
op_add_assign
(paren
id|u_char
)paren
id|tmp
suffix:semicolon
id|dev-&gt;dev_addr
(braket
id|i
op_increment
)braket
op_assign
(paren
id|u_char
)paren
id|tmp
suffix:semicolon
r_while
c_loop
(paren
(paren
id|tmp
op_assign
id|inl
c_func
(paren
id|DE4X5_APROM
)paren
)paren
OL
l_int|0
)paren
suffix:semicolon
id|k
op_add_assign
(paren
id|u_short
)paren
(paren
id|tmp
op_lshift
l_int|8
)paren
suffix:semicolon
id|dev-&gt;dev_addr
(braket
id|i
op_increment
)braket
op_assign
(paren
id|u_char
)paren
id|tmp
suffix:semicolon
)brace
r_else
(brace
id|dev-&gt;dev_addr
(braket
id|i
)braket
op_assign
(paren
id|u_char
)paren
id|lp-&gt;srom.ieee_addr
(braket
id|i
)braket
suffix:semicolon
id|i
op_increment
suffix:semicolon
id|dev-&gt;dev_addr
(braket
id|i
)braket
op_assign
(paren
id|u_char
)paren
id|lp-&gt;srom.ieee_addr
(braket
id|i
)braket
suffix:semicolon
id|i
op_increment
suffix:semicolon
)brace
)brace
r_else
(brace
id|k
op_add_assign
(paren
id|u_char
)paren
(paren
id|tmp
op_assign
id|inb
c_func
(paren
id|EISA_APROM
)paren
)paren
suffix:semicolon
id|dev-&gt;dev_addr
(braket
id|i
op_increment
)braket
op_assign
(paren
id|u_char
)paren
id|tmp
suffix:semicolon
id|k
op_add_assign
(paren
id|u_short
)paren
(paren
(paren
id|tmp
op_assign
id|inb
c_func
(paren
id|EISA_APROM
)paren
)paren
op_lshift
l_int|8
)paren
suffix:semicolon
id|dev-&gt;dev_addr
(braket
id|i
op_increment
)braket
op_assign
(paren
id|u_char
)paren
id|tmp
suffix:semicolon
)brace
r_if
c_cond
(paren
id|k
OG
l_int|0xffff
)paren
id|k
op_sub_assign
l_int|0xffff
suffix:semicolon
)brace
r_if
c_cond
(paren
id|k
op_eq
l_int|0xffff
)paren
id|k
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|lp-&gt;bus
op_eq
id|PCI
)paren
(brace
r_if
c_cond
(paren
id|lp-&gt;chipset
op_eq
id|DC21040
)paren
(brace
r_while
c_loop
(paren
(paren
id|tmp
op_assign
id|inl
c_func
(paren
id|DE4X5_APROM
)paren
)paren
OL
l_int|0
)paren
suffix:semicolon
id|chksum
op_assign
(paren
id|u_char
)paren
id|tmp
suffix:semicolon
r_while
c_loop
(paren
(paren
id|tmp
op_assign
id|inl
c_func
(paren
id|DE4X5_APROM
)paren
)paren
OL
l_int|0
)paren
suffix:semicolon
id|chksum
op_or_assign
(paren
id|u_short
)paren
(paren
id|tmp
op_lshift
l_int|8
)paren
suffix:semicolon
r_if
c_cond
(paren
id|k
op_ne
id|chksum
)paren
id|status
op_assign
op_minus
l_int|1
suffix:semicolon
)brace
)brace
r_else
(brace
id|chksum
op_assign
(paren
id|u_char
)paren
id|inb
c_func
(paren
id|EISA_APROM
)paren
suffix:semicolon
id|chksum
op_or_assign
(paren
id|u_short
)paren
(paren
id|inb
c_func
(paren
id|EISA_APROM
)paren
op_lshift
l_int|8
)paren
suffix:semicolon
r_if
c_cond
(paren
id|k
op_ne
id|chksum
)paren
id|status
op_assign
op_minus
l_int|1
suffix:semicolon
)brace
r_return
id|status
suffix:semicolon
)brace
multiline_comment|/*&n;** SROM Read&n;*/
DECL|function|srom_rd
r_static
r_int
id|srom_rd
c_func
(paren
id|u_long
id|addr
comma
id|u_char
id|offset
)paren
(brace
id|sendto_srom
c_func
(paren
id|SROM_RD
op_or
id|SROM_SR
comma
id|addr
)paren
suffix:semicolon
id|srom_latch
c_func
(paren
id|SROM_RD
op_or
id|SROM_SR
op_or
id|DT_CS
comma
id|addr
)paren
suffix:semicolon
id|srom_command
c_func
(paren
id|SROM_RD
op_or
id|SROM_SR
op_or
id|DT_IN
op_or
id|DT_CS
comma
id|addr
)paren
suffix:semicolon
id|srom_address
c_func
(paren
id|SROM_RD
op_or
id|SROM_SR
op_or
id|DT_CS
comma
id|addr
comma
id|offset
)paren
suffix:semicolon
r_return
id|srom_data
c_func
(paren
id|SROM_RD
op_or
id|SROM_SR
op_or
id|DT_CS
comma
id|addr
)paren
suffix:semicolon
)brace
DECL|function|srom_latch
r_static
r_void
id|srom_latch
c_func
(paren
id|u_int
id|command
comma
id|u_long
id|addr
)paren
(brace
id|sendto_srom
c_func
(paren
id|command
comma
id|addr
)paren
suffix:semicolon
id|sendto_srom
c_func
(paren
id|command
op_or
id|DT_CLK
comma
id|addr
)paren
suffix:semicolon
id|sendto_srom
c_func
(paren
id|command
comma
id|addr
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
DECL|function|srom_command
r_static
r_void
id|srom_command
c_func
(paren
id|u_int
id|command
comma
id|u_long
id|addr
)paren
(brace
id|srom_latch
c_func
(paren
id|command
comma
id|addr
)paren
suffix:semicolon
id|srom_latch
c_func
(paren
id|command
comma
id|addr
)paren
suffix:semicolon
id|srom_latch
c_func
(paren
(paren
id|command
op_amp
l_int|0x0000ff00
)paren
op_or
id|DT_CS
comma
id|addr
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
DECL|function|srom_address
r_static
r_void
id|srom_address
c_func
(paren
id|u_int
id|command
comma
id|u_long
id|addr
comma
id|u_char
id|offset
)paren
(brace
r_int
id|i
suffix:semicolon
r_char
id|a
suffix:semicolon
id|a
op_assign
(paren
r_char
)paren
(paren
id|offset
op_lshift
l_int|2
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|6
suffix:semicolon
id|i
op_increment
comma
id|a
op_lshift_assign
l_int|1
)paren
(brace
id|srom_latch
c_func
(paren
id|command
op_or
(paren
(paren
id|a
OL
l_int|0
)paren
ques
c_cond
id|DT_IN
suffix:colon
l_int|0
)paren
comma
id|addr
)paren
suffix:semicolon
)brace
id|dce_us_delay
c_func
(paren
l_int|1
)paren
suffix:semicolon
id|i
op_assign
(paren
id|getfrom_srom
c_func
(paren
id|addr
)paren
op_rshift
l_int|3
)paren
op_amp
l_int|0x01
suffix:semicolon
r_if
c_cond
(paren
id|i
op_ne
l_int|0
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;Bad SROM address phase.....&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/*    printk(&quot;.&quot;);*/
)brace
r_return
suffix:semicolon
)brace
DECL|function|srom_data
r_static
r_int
id|srom_data
c_func
(paren
id|u_int
id|command
comma
id|u_long
id|addr
)paren
(brace
r_int
id|i
suffix:semicolon
r_int
id|word
op_assign
l_int|0
suffix:semicolon
id|s32
id|tmp
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|16
suffix:semicolon
id|i
op_increment
)paren
(brace
id|sendto_srom
c_func
(paren
id|command
op_or
id|DT_CLK
comma
id|addr
)paren
suffix:semicolon
id|tmp
op_assign
id|getfrom_srom
c_func
(paren
id|addr
)paren
suffix:semicolon
id|sendto_srom
c_func
(paren
id|command
comma
id|addr
)paren
suffix:semicolon
id|word
op_assign
(paren
id|word
op_lshift
l_int|1
)paren
op_or
(paren
(paren
id|tmp
op_rshift
l_int|3
)paren
op_amp
l_int|0x01
)paren
suffix:semicolon
)brace
id|sendto_srom
c_func
(paren
id|command
op_amp
l_int|0x0000ff00
comma
id|addr
)paren
suffix:semicolon
r_return
id|word
suffix:semicolon
)brace
multiline_comment|/*&n;static void srom_busy(u_int command, u_long addr)&n;{&n;  sendto_srom((command &amp; 0x0000ff00) | DT_CS, addr);&n;&n;  while (!((getfrom_srom(addr) &gt;&gt; 3) &amp; 0x01)) {&n;    dce_ms_delay(1);&n;  }&n;&n;  sendto_srom(command &amp; 0x0000ff00, addr);&n;&n;  return;&n;}&n;*/
DECL|function|sendto_srom
r_static
r_void
id|sendto_srom
c_func
(paren
id|u_int
id|command
comma
id|u_long
id|addr
)paren
(brace
id|outl
c_func
(paren
id|command
comma
id|addr
)paren
suffix:semicolon
id|dce_us_delay
c_func
(paren
l_int|1
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
DECL|function|getfrom_srom
r_static
r_int
id|getfrom_srom
c_func
(paren
id|u_long
id|addr
)paren
(brace
id|s32
id|tmp
suffix:semicolon
id|tmp
op_assign
id|inl
c_func
(paren
id|addr
)paren
suffix:semicolon
id|dce_us_delay
c_func
(paren
l_int|1
)paren
suffix:semicolon
r_return
id|tmp
suffix:semicolon
)brace
DECL|function|build_setup_frame
r_static
r_char
op_star
id|build_setup_frame
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
r_int
id|mode
)paren
(brace
r_struct
id|de4x5_private
op_star
id|lp
op_assign
(paren
r_struct
id|de4x5_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_int
id|i
suffix:semicolon
r_char
op_star
id|pa
op_assign
id|lp-&gt;setup_frame
suffix:semicolon
multiline_comment|/* Initialise the setup frame */
r_if
c_cond
(paren
id|mode
op_eq
id|ALL
)paren
(brace
id|memset
c_func
(paren
id|lp-&gt;setup_frame
comma
l_int|0
comma
id|SETUP_FRAME_LEN
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|lp-&gt;setup_f
op_eq
id|HASH_PERF
)paren
(brace
r_for
c_loop
(paren
id|pa
op_assign
id|lp-&gt;setup_frame
op_plus
id|IMPERF_PA_OFFSET
comma
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|ETH_ALEN
suffix:semicolon
id|i
op_increment
)paren
(brace
op_star
(paren
id|pa
op_plus
id|i
)paren
op_assign
id|dev-&gt;dev_addr
(braket
id|i
)braket
suffix:semicolon
multiline_comment|/* Host address */
r_if
c_cond
(paren
id|i
op_amp
l_int|0x01
)paren
id|pa
op_add_assign
l_int|2
suffix:semicolon
)brace
op_star
(paren
id|lp-&gt;setup_frame
op_plus
(paren
id|HASH_TABLE_LEN
op_rshift
l_int|3
)paren
op_minus
l_int|3
)paren
op_assign
l_int|0x80
suffix:semicolon
multiline_comment|/* B&squot;cast address */
)brace
r_else
(brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|ETH_ALEN
suffix:semicolon
id|i
op_increment
)paren
(brace
multiline_comment|/* Host address */
op_star
(paren
id|pa
op_plus
(paren
id|i
op_amp
l_int|1
)paren
)paren
op_assign
id|dev-&gt;dev_addr
(braket
id|i
)braket
suffix:semicolon
r_if
c_cond
(paren
id|i
op_amp
l_int|0x01
)paren
id|pa
op_add_assign
l_int|4
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|ETH_ALEN
suffix:semicolon
id|i
op_increment
)paren
(brace
multiline_comment|/* Broadcast address */
op_star
(paren
id|pa
op_plus
(paren
id|i
op_amp
l_int|1
)paren
)paren
op_assign
(paren
r_char
)paren
l_int|0xff
suffix:semicolon
r_if
c_cond
(paren
id|i
op_amp
l_int|0x01
)paren
id|pa
op_add_assign
l_int|4
suffix:semicolon
)brace
)brace
r_return
id|pa
suffix:semicolon
multiline_comment|/* Points to the next entry */
)brace
DECL|function|enable_ast
r_static
r_void
id|enable_ast
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
id|u32
id|time_out
)paren
(brace
r_struct
id|de4x5_private
op_star
id|lp
op_assign
(paren
r_struct
id|de4x5_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|u_long
id|iobase
op_assign
id|dev-&gt;base_addr
suffix:semicolon
id|lp-&gt;irq_mask
op_or_assign
id|IMR_TMM
suffix:semicolon
id|outl
c_func
(paren
id|lp-&gt;irq_mask
comma
id|DE4X5_IMR
)paren
suffix:semicolon
id|load_ms_timer
c_func
(paren
id|dev
comma
id|time_out
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
DECL|function|disable_ast
r_static
r_void
id|disable_ast
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
r_struct
id|de4x5_private
op_star
id|lp
op_assign
(paren
r_struct
id|de4x5_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|u_long
id|iobase
op_assign
id|dev-&gt;base_addr
suffix:semicolon
id|lp-&gt;irq_mask
op_and_assign
op_complement
id|IMR_TMM
suffix:semicolon
id|outl
c_func
(paren
id|lp-&gt;irq_mask
comma
id|DE4X5_IMR
)paren
suffix:semicolon
id|load_ms_timer
c_func
(paren
id|dev
comma
l_int|0
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
DECL|function|kick_tx
r_static
r_void
id|kick_tx
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
r_if
c_cond
(paren
(paren
id|skb
op_assign
id|alloc_skb
c_func
(paren
l_int|0
comma
id|GFP_ATOMIC
)paren
)paren
op_ne
l_int|NULL
)paren
(brace
id|skb-&gt;len
op_assign
id|FAKE_FRAME_LEN
suffix:semicolon
id|skb-&gt;arp
op_assign
l_int|1
suffix:semicolon
id|skb-&gt;dev
op_assign
id|dev
suffix:semicolon
id|dev_queue_xmit
c_func
(paren
id|skb
comma
id|dev
comma
id|SOPRI_NORMAL
)paren
suffix:semicolon
)brace
r_return
suffix:semicolon
)brace
multiline_comment|/*&n;** Perform IOCTL call functions here. Some are privileged operations and the&n;** effective uid is checked in those cases.&n;*/
DECL|function|de4x5_ioctl
r_static
r_int
id|de4x5_ioctl
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
r_struct
id|ifreq
op_star
id|rq
comma
r_int
id|cmd
)paren
(brace
r_struct
id|de4x5_private
op_star
id|lp
op_assign
(paren
r_struct
id|de4x5_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_struct
id|de4x5_ioctl
op_star
id|ioc
op_assign
(paren
r_struct
id|de4x5_ioctl
op_star
)paren
op_amp
id|rq-&gt;ifr_data
suffix:semicolon
id|u_long
id|iobase
op_assign
id|dev-&gt;base_addr
suffix:semicolon
r_int
id|i
comma
id|j
comma
id|status
op_assign
l_int|0
suffix:semicolon
id|s32
id|omr
suffix:semicolon
r_union
(brace
id|u8
id|addr
(braket
(paren
id|HASH_TABLE_LEN
op_star
id|ETH_ALEN
)paren
)braket
suffix:semicolon
id|u16
id|sval
(braket
(paren
id|HASH_TABLE_LEN
op_star
id|ETH_ALEN
)paren
op_rshift
l_int|1
)braket
suffix:semicolon
id|u32
id|lval
(braket
(paren
id|HASH_TABLE_LEN
op_star
id|ETH_ALEN
)paren
op_rshift
l_int|2
)braket
suffix:semicolon
)brace
id|tmp
suffix:semicolon
r_switch
c_cond
(paren
id|ioc-&gt;cmd
)paren
(brace
r_case
id|DE4X5_GET_HWADDR
suffix:colon
multiline_comment|/* Get the hardware address */
id|ioc-&gt;len
op_assign
id|ETH_ALEN
suffix:semicolon
id|status
op_assign
id|verify_area
c_func
(paren
id|VERIFY_WRITE
comma
(paren
r_void
op_star
)paren
id|ioc-&gt;data
comma
id|ioc-&gt;len
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
)paren
r_break
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|ETH_ALEN
suffix:semicolon
id|i
op_increment
)paren
(brace
id|tmp.addr
(braket
id|i
)braket
op_assign
id|dev-&gt;dev_addr
(braket
id|i
)braket
suffix:semicolon
)brace
id|memcpy_tofs
c_func
(paren
id|ioc-&gt;data
comma
id|tmp.addr
comma
id|ioc-&gt;len
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|DE4X5_SET_HWADDR
suffix:colon
multiline_comment|/* Set the hardware address */
id|status
op_assign
id|verify_area
c_func
(paren
id|VERIFY_READ
comma
(paren
r_void
op_star
)paren
id|ioc-&gt;data
comma
id|ETH_ALEN
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
)paren
r_break
suffix:semicolon
id|status
op_assign
op_minus
id|EPERM
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|suser
c_func
(paren
)paren
)paren
r_break
suffix:semicolon
id|status
op_assign
l_int|0
suffix:semicolon
id|memcpy_fromfs
c_func
(paren
id|tmp.addr
comma
id|ioc-&gt;data
comma
id|ETH_ALEN
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|ETH_ALEN
suffix:semicolon
id|i
op_increment
)paren
(brace
id|dev-&gt;dev_addr
(braket
id|i
)braket
op_assign
id|tmp.addr
(braket
id|i
)braket
suffix:semicolon
)brace
id|build_setup_frame
c_func
(paren
id|dev
comma
id|PHYS_ADDR_ONLY
)paren
suffix:semicolon
multiline_comment|/* Set up the descriptor and give ownership to the card */
r_while
c_loop
(paren
id|set_bit
c_func
(paren
l_int|0
comma
(paren
r_void
op_star
)paren
op_amp
id|dev-&gt;tbusy
)paren
op_ne
l_int|0
)paren
suffix:semicolon
multiline_comment|/* Wait for lock to free*/
r_if
c_cond
(paren
id|lp-&gt;setup_f
op_eq
id|HASH_PERF
)paren
(brace
id|load_packet
c_func
(paren
id|dev
comma
id|lp-&gt;setup_frame
comma
id|TD_IC
op_or
id|HASH_F
op_or
id|TD_SET
op_or
id|SETUP_FRAME_LEN
comma
l_int|NULL
)paren
suffix:semicolon
)brace
r_else
(brace
id|load_packet
c_func
(paren
id|dev
comma
id|lp-&gt;setup_frame
comma
id|TD_IC
op_or
id|PERFECT_F
op_or
id|TD_SET
op_or
id|SETUP_FRAME_LEN
comma
l_int|NULL
)paren
suffix:semicolon
)brace
id|lp-&gt;tx_new
op_assign
(paren
op_increment
id|lp-&gt;tx_new
)paren
op_mod
id|lp-&gt;txRingSize
suffix:semicolon
id|outl
c_func
(paren
id|POLL_DEMAND
comma
id|DE4X5_TPD
)paren
suffix:semicolon
multiline_comment|/* Start the TX */
id|dev-&gt;tbusy
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Unlock the TX ring */
r_break
suffix:semicolon
r_case
id|DE4X5_SET_PROM
suffix:colon
multiline_comment|/* Set Promiscuous Mode */
r_if
c_cond
(paren
id|suser
c_func
(paren
)paren
)paren
(brace
id|omr
op_assign
id|inl
c_func
(paren
id|DE4X5_OMR
)paren
suffix:semicolon
id|omr
op_or_assign
id|OMR_PR
suffix:semicolon
id|outl
c_func
(paren
id|omr
comma
id|DE4X5_OMR
)paren
suffix:semicolon
)brace
r_else
(brace
id|status
op_assign
op_minus
id|EPERM
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|DE4X5_CLR_PROM
suffix:colon
multiline_comment|/* Clear Promiscuous Mode */
r_if
c_cond
(paren
id|suser
c_func
(paren
)paren
)paren
(brace
id|omr
op_assign
id|inl
c_func
(paren
id|DE4X5_OMR
)paren
suffix:semicolon
id|omr
op_and_assign
op_complement
id|OMR_PR
suffix:semicolon
id|outb
c_func
(paren
id|omr
comma
id|DE4X5_OMR
)paren
suffix:semicolon
)brace
r_else
(brace
id|status
op_assign
op_minus
id|EPERM
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|DE4X5_SAY_BOO
suffix:colon
multiline_comment|/* Say &quot;Boo!&quot; to the kernel log file */
id|printk
c_func
(paren
l_string|&quot;%s: Boo!&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|DE4X5_GET_MCA
suffix:colon
multiline_comment|/* Get the multicast address table */
id|ioc-&gt;len
op_assign
(paren
id|HASH_TABLE_LEN
op_rshift
l_int|3
)paren
suffix:semicolon
id|status
op_assign
id|verify_area
c_func
(paren
id|VERIFY_WRITE
comma
id|ioc-&gt;data
comma
id|ioc-&gt;len
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
)paren
r_break
suffix:semicolon
id|memcpy_tofs
c_func
(paren
id|ioc-&gt;data
comma
id|lp-&gt;setup_frame
comma
id|ioc-&gt;len
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|DE4X5_SET_MCA
suffix:colon
multiline_comment|/* Set a multicast address */
r_if
c_cond
(paren
id|suser
c_func
(paren
)paren
)paren
(brace
r_if
c_cond
(paren
id|ioc-&gt;len
op_ne
id|HASH_TABLE_LEN
)paren
(brace
multiline_comment|/* MCA changes */
r_if
c_cond
(paren
op_logical_neg
(paren
id|status
op_assign
id|verify_area
c_func
(paren
id|VERIFY_READ
comma
(paren
r_void
op_star
)paren
id|ioc-&gt;data
comma
id|ETH_ALEN
op_star
id|ioc-&gt;len
)paren
)paren
)paren
(brace
id|memcpy_fromfs
c_func
(paren
id|tmp.addr
comma
id|ioc-&gt;data
comma
id|ETH_ALEN
op_star
id|ioc-&gt;len
)paren
suffix:semicolon
id|set_multicast_list
c_func
(paren
id|dev
comma
id|ioc-&gt;len
comma
id|tmp.addr
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
id|set_multicast_list
c_func
(paren
id|dev
comma
id|ioc-&gt;len
comma
l_int|NULL
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
id|status
op_assign
op_minus
id|EPERM
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|DE4X5_CLR_MCA
suffix:colon
multiline_comment|/* Clear all multicast addresses */
r_if
c_cond
(paren
id|suser
c_func
(paren
)paren
)paren
(brace
id|set_multicast_list
c_func
(paren
id|dev
comma
l_int|0
comma
l_int|NULL
)paren
suffix:semicolon
)brace
r_else
(brace
id|status
op_assign
op_minus
id|EPERM
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|DE4X5_MCA_EN
suffix:colon
multiline_comment|/* Enable pass all multicast addressing */
r_if
c_cond
(paren
id|suser
c_func
(paren
)paren
)paren
(brace
id|omr
op_assign
id|inl
c_func
(paren
id|DE4X5_OMR
)paren
suffix:semicolon
id|omr
op_or_assign
id|OMR_PM
suffix:semicolon
id|outl
c_func
(paren
id|omr
comma
id|DE4X5_OMR
)paren
suffix:semicolon
)brace
r_else
(brace
id|status
op_assign
op_minus
id|EPERM
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|DE4X5_GET_STATS
suffix:colon
multiline_comment|/* Get the driver statistics */
id|ioc-&gt;len
op_assign
r_sizeof
(paren
id|lp-&gt;pktStats
)paren
suffix:semicolon
id|status
op_assign
id|verify_area
c_func
(paren
id|VERIFY_WRITE
comma
(paren
r_void
op_star
)paren
id|ioc-&gt;data
comma
id|ioc-&gt;len
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
)paren
r_break
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|memcpy_tofs
c_func
(paren
id|ioc-&gt;data
comma
op_amp
id|lp-&gt;pktStats
comma
id|ioc-&gt;len
)paren
suffix:semicolon
id|sti
c_func
(paren
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|DE4X5_CLR_STATS
suffix:colon
multiline_comment|/* Zero out the driver statistics */
r_if
c_cond
(paren
id|suser
c_func
(paren
)paren
)paren
(brace
id|cli
c_func
(paren
)paren
suffix:semicolon
id|memset
c_func
(paren
op_amp
id|lp-&gt;pktStats
comma
l_int|0
comma
r_sizeof
(paren
id|lp-&gt;pktStats
)paren
)paren
suffix:semicolon
id|sti
c_func
(paren
)paren
suffix:semicolon
)brace
r_else
(brace
id|status
op_assign
op_minus
id|EPERM
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|DE4X5_GET_OMR
suffix:colon
multiline_comment|/* Get the OMR Register contents */
id|tmp.addr
(braket
l_int|0
)braket
op_assign
id|inl
c_func
(paren
id|DE4X5_OMR
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|status
op_assign
id|verify_area
c_func
(paren
id|VERIFY_WRITE
comma
(paren
r_void
op_star
)paren
id|ioc-&gt;data
comma
l_int|1
)paren
)paren
)paren
(brace
id|memcpy_tofs
c_func
(paren
id|ioc-&gt;data
comma
id|tmp.addr
comma
l_int|1
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|DE4X5_SET_OMR
suffix:colon
multiline_comment|/* Set the OMR Register contents */
r_if
c_cond
(paren
id|suser
c_func
(paren
)paren
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|status
op_assign
id|verify_area
c_func
(paren
id|VERIFY_READ
comma
(paren
r_void
op_star
)paren
id|ioc-&gt;data
comma
l_int|1
)paren
)paren
)paren
(brace
id|memcpy_fromfs
c_func
(paren
id|tmp.addr
comma
id|ioc-&gt;data
comma
l_int|1
)paren
suffix:semicolon
id|outl
c_func
(paren
id|tmp.addr
(braket
l_int|0
)braket
comma
id|DE4X5_OMR
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
id|status
op_assign
op_minus
id|EPERM
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|DE4X5_GET_REG
suffix:colon
multiline_comment|/* Get the DE4X5 Registers */
id|j
op_assign
l_int|0
suffix:semicolon
id|tmp.lval
(braket
l_int|0
)braket
op_assign
id|inl
c_func
(paren
id|DE4X5_STS
)paren
suffix:semicolon
id|j
op_add_assign
l_int|4
suffix:semicolon
id|tmp.lval
(braket
l_int|1
)braket
op_assign
id|inl
c_func
(paren
id|DE4X5_BMR
)paren
suffix:semicolon
id|j
op_add_assign
l_int|4
suffix:semicolon
id|tmp.lval
(braket
l_int|2
)braket
op_assign
id|inl
c_func
(paren
id|DE4X5_IMR
)paren
suffix:semicolon
id|j
op_add_assign
l_int|4
suffix:semicolon
id|tmp.lval
(braket
l_int|3
)braket
op_assign
id|inl
c_func
(paren
id|DE4X5_OMR
)paren
suffix:semicolon
id|j
op_add_assign
l_int|4
suffix:semicolon
id|tmp.lval
(braket
l_int|4
)braket
op_assign
id|inl
c_func
(paren
id|DE4X5_SISR
)paren
suffix:semicolon
id|j
op_add_assign
l_int|4
suffix:semicolon
id|tmp.lval
(braket
l_int|5
)braket
op_assign
id|inl
c_func
(paren
id|DE4X5_SICR
)paren
suffix:semicolon
id|j
op_add_assign
l_int|4
suffix:semicolon
id|tmp.lval
(braket
l_int|6
)braket
op_assign
id|inl
c_func
(paren
id|DE4X5_STRR
)paren
suffix:semicolon
id|j
op_add_assign
l_int|4
suffix:semicolon
id|tmp.lval
(braket
l_int|7
)braket
op_assign
id|inl
c_func
(paren
id|DE4X5_SIGR
)paren
suffix:semicolon
id|j
op_add_assign
l_int|4
suffix:semicolon
id|ioc-&gt;len
op_assign
id|j
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|status
op_assign
id|verify_area
c_func
(paren
id|VERIFY_WRITE
comma
(paren
r_void
op_star
)paren
id|ioc-&gt;data
comma
id|ioc-&gt;len
)paren
)paren
)paren
(brace
id|memcpy_tofs
c_func
(paren
id|ioc-&gt;data
comma
id|tmp.addr
comma
id|ioc-&gt;len
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
DECL|macro|DE4X5_DUMP
mdefine_line|#define DE4X5_DUMP              0x0f /* Dump the DE4X5 Status */
r_case
id|DE4X5_DUMP
suffix:colon
id|j
op_assign
l_int|0
suffix:semicolon
id|tmp.addr
(braket
id|j
op_increment
)braket
op_assign
id|dev-&gt;irq
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|ETH_ALEN
suffix:semicolon
id|i
op_increment
)paren
(brace
id|tmp.addr
(braket
id|j
op_increment
)braket
op_assign
id|dev-&gt;dev_addr
(braket
id|i
)braket
suffix:semicolon
)brace
id|tmp.addr
(braket
id|j
op_increment
)braket
op_assign
id|lp-&gt;rxRingSize
suffix:semicolon
id|tmp.lval
(braket
id|j
op_rshift
l_int|2
)braket
op_assign
(paren
r_int
)paren
id|lp-&gt;rx_ring
suffix:semicolon
id|j
op_add_assign
l_int|4
suffix:semicolon
id|tmp.lval
(braket
id|j
op_rshift
l_int|2
)braket
op_assign
(paren
r_int
)paren
id|lp-&gt;tx_ring
suffix:semicolon
id|j
op_add_assign
l_int|4
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|lp-&gt;rxRingSize
op_minus
l_int|1
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|i
OL
l_int|3
)paren
(brace
id|tmp.lval
(braket
id|j
op_rshift
l_int|2
)braket
op_assign
(paren
r_int
)paren
op_amp
id|lp-&gt;rx_ring
(braket
id|i
)braket
dot
id|status
suffix:semicolon
id|j
op_add_assign
l_int|4
suffix:semicolon
)brace
)brace
id|tmp.lval
(braket
id|j
op_rshift
l_int|2
)braket
op_assign
(paren
r_int
)paren
op_amp
id|lp-&gt;rx_ring
(braket
id|i
)braket
dot
id|status
suffix:semicolon
id|j
op_add_assign
l_int|4
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|lp-&gt;txRingSize
op_minus
l_int|1
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|i
OL
l_int|3
)paren
(brace
id|tmp.lval
(braket
id|j
op_rshift
l_int|2
)braket
op_assign
(paren
r_int
)paren
op_amp
id|lp-&gt;tx_ring
(braket
id|i
)braket
dot
id|status
suffix:semicolon
id|j
op_add_assign
l_int|4
suffix:semicolon
)brace
)brace
id|tmp.lval
(braket
id|j
op_rshift
l_int|2
)braket
op_assign
(paren
r_int
)paren
op_amp
id|lp-&gt;tx_ring
(braket
id|i
)braket
dot
id|status
suffix:semicolon
id|j
op_add_assign
l_int|4
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|lp-&gt;rxRingSize
op_minus
l_int|1
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|i
OL
l_int|3
)paren
(brace
id|tmp.lval
(braket
id|j
op_rshift
l_int|2
)braket
op_assign
(paren
id|s32
)paren
id|lp-&gt;rx_ring
(braket
id|i
)braket
dot
id|buf
suffix:semicolon
id|j
op_add_assign
l_int|4
suffix:semicolon
)brace
)brace
id|tmp.lval
(braket
id|j
op_rshift
l_int|2
)braket
op_assign
(paren
id|s32
)paren
id|lp-&gt;rx_ring
(braket
id|i
)braket
dot
id|buf
suffix:semicolon
id|j
op_add_assign
l_int|4
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|lp-&gt;txRingSize
op_minus
l_int|1
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|i
OL
l_int|3
)paren
(brace
id|tmp.lval
(braket
id|j
op_rshift
l_int|2
)braket
op_assign
(paren
id|s32
)paren
id|lp-&gt;tx_ring
(braket
id|i
)braket
dot
id|buf
suffix:semicolon
id|j
op_add_assign
l_int|4
suffix:semicolon
)brace
)brace
id|tmp.lval
(braket
id|j
op_rshift
l_int|2
)braket
op_assign
(paren
id|s32
)paren
id|lp-&gt;tx_ring
(braket
id|i
)braket
dot
id|buf
suffix:semicolon
id|j
op_add_assign
l_int|4
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|lp-&gt;rxRingSize
suffix:semicolon
id|i
op_increment
)paren
(brace
id|tmp.lval
(braket
id|j
op_rshift
l_int|2
)braket
op_assign
id|lp-&gt;rx_ring
(braket
id|i
)braket
dot
id|status
suffix:semicolon
id|j
op_add_assign
l_int|4
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|lp-&gt;txRingSize
suffix:semicolon
id|i
op_increment
)paren
(brace
id|tmp.lval
(braket
id|j
op_rshift
l_int|2
)braket
op_assign
id|lp-&gt;tx_ring
(braket
id|i
)braket
dot
id|status
suffix:semicolon
id|j
op_add_assign
l_int|4
suffix:semicolon
)brace
id|tmp.lval
(braket
id|j
op_rshift
l_int|2
)braket
op_assign
id|inl
c_func
(paren
id|DE4X5_STS
)paren
suffix:semicolon
id|j
op_add_assign
l_int|4
suffix:semicolon
id|tmp.lval
(braket
id|j
op_rshift
l_int|2
)braket
op_assign
id|inl
c_func
(paren
id|DE4X5_BMR
)paren
suffix:semicolon
id|j
op_add_assign
l_int|4
suffix:semicolon
id|tmp.lval
(braket
id|j
op_rshift
l_int|2
)braket
op_assign
id|inl
c_func
(paren
id|DE4X5_IMR
)paren
suffix:semicolon
id|j
op_add_assign
l_int|4
suffix:semicolon
id|tmp.lval
(braket
id|j
op_rshift
l_int|2
)braket
op_assign
id|inl
c_func
(paren
id|DE4X5_OMR
)paren
suffix:semicolon
id|j
op_add_assign
l_int|4
suffix:semicolon
id|tmp.lval
(braket
id|j
op_rshift
l_int|2
)braket
op_assign
id|inl
c_func
(paren
id|DE4X5_SISR
)paren
suffix:semicolon
id|j
op_add_assign
l_int|4
suffix:semicolon
id|tmp.lval
(braket
id|j
op_rshift
l_int|2
)braket
op_assign
id|inl
c_func
(paren
id|DE4X5_SICR
)paren
suffix:semicolon
id|j
op_add_assign
l_int|4
suffix:semicolon
id|tmp.lval
(braket
id|j
op_rshift
l_int|2
)braket
op_assign
id|inl
c_func
(paren
id|DE4X5_STRR
)paren
suffix:semicolon
id|j
op_add_assign
l_int|4
suffix:semicolon
id|tmp.lval
(braket
id|j
op_rshift
l_int|2
)braket
op_assign
id|inl
c_func
(paren
id|DE4X5_SIGR
)paren
suffix:semicolon
id|j
op_add_assign
l_int|4
suffix:semicolon
id|tmp.addr
(braket
id|j
op_increment
)braket
op_assign
id|lp-&gt;txRingSize
suffix:semicolon
id|tmp.addr
(braket
id|j
op_increment
)braket
op_assign
id|dev-&gt;tbusy
suffix:semicolon
id|ioc-&gt;len
op_assign
id|j
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|status
op_assign
id|verify_area
c_func
(paren
id|VERIFY_WRITE
comma
(paren
r_void
op_star
)paren
id|ioc-&gt;data
comma
id|ioc-&gt;len
)paren
)paren
)paren
(brace
id|memcpy_tofs
c_func
(paren
id|ioc-&gt;data
comma
id|tmp.addr
comma
id|ioc-&gt;len
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_default
suffix:colon
id|status
op_assign
op_minus
id|EOPNOTSUPP
suffix:semicolon
)brace
r_return
id|status
suffix:semicolon
)brace
macro_line|#ifdef MODULE
DECL|variable|devicename
r_static
r_char
id|devicename
(braket
l_int|9
)braket
op_assign
(brace
l_int|0
comma
)brace
suffix:semicolon
DECL|variable|thisDE4X5
r_static
r_struct
id|device
id|thisDE4X5
op_assign
(brace
id|devicename
comma
multiline_comment|/* device name is inserted by linux/drivers/net/net_init.c */
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0x2000
comma
l_int|10
comma
multiline_comment|/* I/O address, IRQ */
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|NULL
comma
id|de4x5_probe
)brace
suffix:semicolon
DECL|variable|io
r_static
r_int
id|io
op_assign
l_int|0x000b
suffix:semicolon
multiline_comment|/* EDIT THESE LINES FOR YOUR CONFIGURATION */
DECL|variable|irq
r_static
r_int
id|irq
op_assign
l_int|10
suffix:semicolon
multiline_comment|/* or use the insmod io= irq= options &t;&t;*/
r_int
DECL|function|init_module
id|init_module
c_func
(paren
r_void
)paren
(brace
id|thisDE4X5.base_addr
op_assign
id|io
suffix:semicolon
id|thisDE4X5.irq
op_assign
id|irq
suffix:semicolon
r_if
c_cond
(paren
id|register_netdev
c_func
(paren
op_amp
id|thisDE4X5
)paren
op_ne
l_int|0
)paren
r_return
op_minus
id|EIO
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_void
DECL|function|cleanup_module
id|cleanup_module
c_func
(paren
r_void
)paren
(brace
r_struct
id|de4x5_private
op_star
id|lp
op_assign
(paren
r_struct
id|de4x5_private
op_star
)paren
id|thisDE4X5.priv
suffix:semicolon
r_if
c_cond
(paren
id|lp
)paren
(brace
id|kfree_s
c_func
(paren
id|bus_to_virt
c_func
(paren
id|lp-&gt;rx_ring
(braket
l_int|0
)braket
dot
id|buf
)paren
comma
id|RX_BUFF_SZ
op_star
id|NUM_RX_DESC
op_plus
id|ALIGN
)paren
suffix:semicolon
)brace
id|kfree_s
c_func
(paren
id|thisDE4X5.priv
comma
r_sizeof
(paren
r_struct
id|de4x5_private
)paren
op_plus
id|ALIGN
)paren
suffix:semicolon
id|thisDE4X5.priv
op_assign
l_int|NULL
suffix:semicolon
id|release_region
c_func
(paren
id|thisDE4X5.base_addr
comma
(paren
id|lp-&gt;bus
op_eq
id|PCI
ques
c_cond
id|DE4X5_PCI_TOTAL_SIZE
suffix:colon
id|DE4X5_EISA_TOTAL_SIZE
)paren
)paren
suffix:semicolon
id|unregister_netdev
c_func
(paren
op_amp
id|thisDE4X5
)paren
suffix:semicolon
)brace
macro_line|#endif /* MODULE */
"&f;"
multiline_comment|/*&n; * Local variables:&n; *  kernel-compile-command: &quot;gcc -D__KERNEL__ -I/usr/src/linux/net/inet -Wall -Wstrict-prototypes -O2 -m486 -c de4x5.c&quot;&n; *&n; *  module-compile-command: &quot;gcc -D__KERNEL__ -DMODULE -I/usr/src/linux/net/inet -Wall -Wstrict-prototypes -O2 -m486 -c de4x5.c&quot;&n; * End:&n; */
eof
