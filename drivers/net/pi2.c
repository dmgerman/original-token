multiline_comment|/*&n;   pi2.c: Driver for the Ottawa Amateur Radio Club PI and PI2 interface.&n;   Copyright (c) 1994 David Perry&n;&n;   This program is free software; you can redistribute it and/or modify&n;   it under the terms of the GNU General Public License version 2, as&n;   published by the Free Software Foundation.&n;&n;   This program is distributed in the hope that it will be useful, but&n;   WITHOUT ANY WARRANTY; without even the implied warranty of&n;   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU&n;   General Public License for more details.&n;&n;   You should have received a copy of the GNU General Public License&n;   along with this program; if not, write to the Free Software Foundation,&n;   Inc., 675 Mass Ave, Cambridge MA 02139, USA.&n;&n;   The file skeleton.c by Donald Becker was used as a starting point&n;   for this driver.&n;&n;   Revision History&n;&n;   April 6, 1994  (dp) Created&n;&t;&t;       version 0.0 ALPHA&n;   April 10, 1994 (dp) Included cleanup, suggestions from J. P. Morrison.&n;                       version 0.1 ALPHA&n;   April 13, 1994 (dp) Included address probing from JPM, autoirq&n;&t;&t;       version 0.2 ALPHA&n;   April 14, 1994 (ac) Sketched in the NET3 changes.&n;   April 17, 1994 (dp) Finished the NET3 changes. Used init_etherdev()&n;&t;&t;       instead of kmalloc() to ensure that DMA buffers will&n;&t;&t;       reside under the 16 meg line.&n;&t;&t;       version 0.4 ALPHA&n;   April 18, 1994 (dp) Now using the kernel provided sk_buff handling functions.&n;&t;&t;       Fixed a nasty problem with DMA.&n;&t;&t;       version 0.5 ALPHA&n;   June 6, 1994 (ac)   Fixed to match the buffer locking changes. Added a hack to&n;   &t;&t;       fix a funny I see (search for HACK) and fixed the calls in&n;   &t;&t;       init() so it doesn&squot;t migrate module based ethernet cards up&n;   &t;&t;       to eth2 Took out the old module ideas as they are no longer&n;   &t;&t;       relevant to the PI driver.&n;   July 16, 1994 (dp)  Fixed the B channel rx overrun problem ac referred to&n;   &t;&t;       above. Also added a bit of a hack to improve the maximum&n;   &t;               baud rate on the B channel (Search for STUFF2). Included&n;   &t;&t;       ioctl stuff from John Paul Morrison. version 0.6 ALPHA&n;   Feb 9, 1995 (dp)    Updated for 1.1.90 kernel&n;                       version 0.7 ALPHA&n;   Apr 6, 1995 (ac)    Tweaks for NET3 pre snapshot 002 AX.25&n;   April 23, 1995 (dp) Fixed ioctl so it works properly with piconfig program&n;                       when changing the baud rate or clock mode.&n;                       version 0.8 ALPHA&n;   July 17, 1995 (ac)  Finally polishing of AX25.030+ support&n;   Oct  29, 1995 (ac)  A couple of minor fixes before this, and this release changes&n;   &t;&t;       to the proper set_mac_address semantics which will break&n;   &t;&t;       a few programs I suspect.&n;   Aug  18, 1996 (jsn) Converted to be used as a module.&n;   Dec  13, 1996 (jsn) Fixed to match Linux networking changes.&n;*/
multiline_comment|/* The following #define invokes a hack that will improve performance (baud)&n;   for the B port. The up side is it makes 9600 baud work ok on the B port.&n;   It may do 38400, depending on the host. The down side is it burns up&n;   CPU cycles with ints locked for up to 1 character time, at the beginning&n;   of each transmitted packet. If this causes you to lose sleep, #undefine it.&n;*/
multiline_comment|/*#define STUFF2 1*/
multiline_comment|/* The default configuration */
DECL|macro|PI_DMA
mdefine_line|#define PI_DMA 3
DECL|macro|DEF_A_SPEED
mdefine_line|#define DEF_A_SPEED 0&t;&t;/* 0 means external clock */
DECL|macro|DEF_A_TXDELAY
mdefine_line|#define DEF_A_TXDELAY 15&t;/* 15 mS transmit delay */
DECL|macro|DEF_A_PERSIST
mdefine_line|#define DEF_A_PERSIST 128&t;/* 50% persistence */
DECL|macro|DEF_A_SLOTIME
mdefine_line|#define DEF_A_SLOTIME 15&t;/* 15 mS slot time */
DECL|macro|DEF_A_SQUELDELAY
mdefine_line|#define DEF_A_SQUELDELAY 1&t;/* 1 mS squelch delay - allows fcs and flag */
DECL|macro|DEF_A_CLOCKMODE
mdefine_line|#define DEF_A_CLOCKMODE 0&t;/* clock mode - 0 is normal */
DECL|macro|DEF_B_SPEED
mdefine_line|#define DEF_B_SPEED 1200&t;/* 1200 baud */
DECL|macro|DEF_B_TXDELAY
mdefine_line|#define DEF_B_TXDELAY 40&t;/* 400 mS */
DECL|macro|DEF_B_PERSIST
mdefine_line|#define DEF_B_PERSIST 128&t;/* 50% */
DECL|macro|DEF_B_SLOTIME
mdefine_line|#define DEF_B_SLOTIME 30&t;/* 300 mS */
DECL|macro|DEF_B_SQUELDELAY
mdefine_line|#define DEF_B_SQUELDELAY 3&t;/* 30 mS */
DECL|macro|DEF_B_CLOCKMODE
mdefine_line|#define DEF_B_CLOCKMODE 0&t;/* Normal clock mode */
multiline_comment|/* The following #define is only really required for the PI card, not&n;   the PI2 - but it&squot;s safer to leave it in. */
DECL|macro|REALLY_SLOW_IO
mdefine_line|#define REALLY_SLOW_IO 1
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/fcntl.h&gt;
macro_line|#include &lt;linux/interrupt.h&gt;
macro_line|#include &lt;linux/ptrace.h&gt;
macro_line|#include &lt;linux/ioport.h&gt;
macro_line|#include &lt;linux/in.h&gt;
macro_line|#include &lt;linux/malloc.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;asm/system.h&gt;
macro_line|#include &lt;asm/bitops.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/dma.h&gt;
macro_line|#include &lt;asm/uaccess.h&gt;
macro_line|#include &lt;linux/inet.h&gt;
macro_line|#include &lt;linux/netdevice.h&gt;
macro_line|#include &lt;linux/etherdevice.h&gt;
macro_line|#include &lt;linux/skbuff.h&gt;
macro_line|#include &lt;linux/timer.h&gt;
macro_line|#include &lt;linux/if_arp.h&gt;
macro_line|#include &lt;linux/pi2.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &quot;z8530.h&quot;
macro_line|#include &lt;net/ax25.h&gt;
DECL|struct|mbuf
r_struct
id|mbuf
(brace
DECL|member|next
r_struct
id|mbuf
op_star
id|next
suffix:semicolon
DECL|member|cnt
r_int
id|cnt
suffix:semicolon
DECL|member|data
r_char
id|data
(braket
l_int|0
)braket
suffix:semicolon
)brace
suffix:semicolon
multiline_comment|/*&n; *&t;The actual devices we will use&n; */
multiline_comment|/*&n; *&t;PI device declarations.&n; */
DECL|function|pi0_preprobe
r_static
r_int
(def_block
id|pi0_preprobe
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
)def_block
multiline_comment|/* Dummy probe function */
DECL|variable|pi0a
r_static
r_struct
id|device
id|pi0a
op_assign
(brace
l_string|&quot;pi0a&quot;
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|NULL
comma
id|pi0_preprobe
)brace
suffix:semicolon
DECL|variable|pi0b
r_static
r_struct
id|device
id|pi0b
op_assign
(brace
l_string|&quot;pi0b&quot;
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|NULL
comma
id|pi0_preprobe
)brace
suffix:semicolon
multiline_comment|/* The number of low I/O ports used by the card. */
DECL|macro|PI_TOTAL_SIZE
mdefine_line|#define PI_TOTAL_SIZE&t;8
multiline_comment|/* Index to functions, as function prototypes. */
r_static
r_int
id|pi_probe
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
r_int
id|card_type
)paren
suffix:semicolon
r_static
r_int
id|pi_open
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_int
id|pi_send_packet
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_void
id|pi_interrupt
c_func
(paren
r_int
id|reg_ptr
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
suffix:semicolon
r_static
r_int
id|pi_close
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_int
id|pi_ioctl
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
r_struct
id|ifreq
op_star
id|ifr
comma
r_int
id|cmd
)paren
suffix:semicolon
r_static
r_struct
id|net_device_stats
op_star
id|pi_get_stats
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_void
id|rts
c_func
(paren
r_struct
id|pi_local
op_star
id|lp
comma
r_int
id|x
)paren
suffix:semicolon
r_static
r_void
id|b_rxint
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
r_struct
id|pi_local
op_star
id|lp
)paren
suffix:semicolon
r_static
r_void
id|b_txint
c_func
(paren
r_struct
id|pi_local
op_star
id|lp
)paren
suffix:semicolon
r_static
r_void
id|b_exint
c_func
(paren
r_struct
id|pi_local
op_star
id|lp
)paren
suffix:semicolon
r_static
r_void
id|a_rxint
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
r_struct
id|pi_local
op_star
id|lp
)paren
suffix:semicolon
r_static
r_void
id|a_txint
c_func
(paren
r_struct
id|pi_local
op_star
id|lp
)paren
suffix:semicolon
r_static
r_void
id|a_exint
c_func
(paren
r_struct
id|pi_local
op_star
id|lp
)paren
suffix:semicolon
r_static
r_char
op_star
id|get_dma_buffer
c_func
(paren
r_int
r_int
op_star
id|mem_ptr
)paren
suffix:semicolon
r_static
r_int
id|valid_dma_page
c_func
(paren
r_int
r_int
id|addr
comma
r_int
r_int
id|dev_buffsize
)paren
suffix:semicolon
DECL|variable|ax25_bcast
r_static
r_char
id|ax25_bcast
(braket
l_int|7
)braket
op_assign
(brace
l_char|&squot;Q&squot;
op_lshift
l_int|1
comma
l_char|&squot;S&squot;
op_lshift
l_int|1
comma
l_char|&squot;T&squot;
op_lshift
l_int|1
comma
l_char|&squot; &squot;
op_lshift
l_int|1
comma
l_char|&squot; &squot;
op_lshift
l_int|1
comma
l_char|&squot; &squot;
op_lshift
l_int|1
comma
l_char|&squot;0&squot;
op_lshift
l_int|1
)brace
suffix:semicolon
DECL|variable|ax25_test
r_static
r_char
id|ax25_test
(braket
l_int|7
)braket
op_assign
(brace
l_char|&squot;L&squot;
op_lshift
l_int|1
comma
l_char|&squot;I&squot;
op_lshift
l_int|1
comma
l_char|&squot;N&squot;
op_lshift
l_int|1
comma
l_char|&squot;U&squot;
op_lshift
l_int|1
comma
l_char|&squot;X&squot;
op_lshift
l_int|1
comma
l_char|&squot; &squot;
op_lshift
l_int|1
comma
l_char|&squot;1&squot;
op_lshift
l_int|1
)brace
suffix:semicolon
DECL|variable|ext2_secrm_seed
r_static
r_int
id|ext2_secrm_seed
op_assign
l_int|152
suffix:semicolon
multiline_comment|/* Random generator base */
DECL|function|random
r_extern
r_inline
r_int
r_char
id|random
c_func
(paren
r_void
)paren
(brace
r_return
(paren
r_int
r_char
)paren
(paren
id|ext2_secrm_seed
op_assign
id|ext2_secrm_seed
op_star
l_int|69069l
op_plus
l_int|1
)paren
suffix:semicolon
)brace
DECL|function|wrtscc
r_extern
r_inline
r_void
id|wrtscc
c_func
(paren
r_int
id|cbase
comma
r_int
id|ctl
comma
r_int
id|sccreg
comma
r_int
id|val
)paren
(brace
multiline_comment|/* assume caller disables interrupts! */
id|outb_p
c_func
(paren
l_int|0
comma
id|cbase
op_plus
id|DMAEN
)paren
suffix:semicolon
multiline_comment|/* Disable DMA while we touch the scc */
id|outb_p
c_func
(paren
id|sccreg
comma
id|ctl
)paren
suffix:semicolon
multiline_comment|/* Select register */
id|outb_p
c_func
(paren
id|val
comma
id|ctl
)paren
suffix:semicolon
multiline_comment|/* Output value */
id|outb_p
c_func
(paren
l_int|1
comma
id|cbase
op_plus
id|DMAEN
)paren
suffix:semicolon
multiline_comment|/* Enable DMA */
)brace
DECL|function|rdscc
r_extern
r_inline
r_int
id|rdscc
c_func
(paren
r_int
id|cbase
comma
r_int
id|ctl
comma
r_int
id|sccreg
)paren
(brace
r_int
id|retval
suffix:semicolon
multiline_comment|/* assume caller disables interrupts! */
id|outb_p
c_func
(paren
l_int|0
comma
id|cbase
op_plus
id|DMAEN
)paren
suffix:semicolon
multiline_comment|/* Disable DMA while we touch the scc */
id|outb_p
c_func
(paren
id|sccreg
comma
id|ctl
)paren
suffix:semicolon
multiline_comment|/* Select register */
id|retval
op_assign
id|inb_p
c_func
(paren
id|ctl
)paren
suffix:semicolon
id|outb_p
c_func
(paren
l_int|1
comma
id|cbase
op_plus
id|DMAEN
)paren
suffix:semicolon
multiline_comment|/* Enable DMA */
r_return
id|retval
suffix:semicolon
)brace
DECL|function|switchbuffers
r_static
r_void
id|switchbuffers
c_func
(paren
r_struct
id|pi_local
op_star
id|lp
)paren
(brace
r_if
c_cond
(paren
id|lp-&gt;rcvbuf
op_eq
id|lp-&gt;rxdmabuf1
)paren
id|lp-&gt;rcvbuf
op_assign
id|lp-&gt;rxdmabuf2
suffix:semicolon
r_else
id|lp-&gt;rcvbuf
op_assign
id|lp-&gt;rxdmabuf1
suffix:semicolon
)brace
DECL|function|hardware_send_packet
r_static
r_void
id|hardware_send_packet
c_func
(paren
r_struct
id|pi_local
op_star
id|lp
comma
r_struct
id|sk_buff
op_star
id|skb
)paren
(brace
r_char
id|kickflag
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|lp-&gt;stats.tx_packets
op_increment
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|kickflag
op_assign
(paren
id|skb_peek
c_func
(paren
op_amp
id|lp-&gt;sndq
)paren
op_eq
l_int|NULL
)paren
op_logical_and
(paren
id|lp-&gt;sndbuf
op_eq
l_int|NULL
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|skb_queue_tail
c_func
(paren
op_amp
id|lp-&gt;sndq
comma
id|skb
)paren
suffix:semicolon
r_if
c_cond
(paren
id|kickflag
)paren
(brace
multiline_comment|/* simulate interrupt to xmit */
r_switch
c_cond
(paren
id|lp-&gt;base
op_amp
l_int|2
)paren
(brace
r_case
l_int|2
suffix:colon
id|a_txint
c_func
(paren
id|lp
)paren
suffix:semicolon
multiline_comment|/* process interrupt */
r_break
suffix:semicolon
r_case
l_int|0
suffix:colon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|lp-&gt;tstate
op_eq
id|IDLE
)paren
id|b_txint
c_func
(paren
id|lp
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
)brace
DECL|function|setup_rx_dma
r_static
r_void
id|setup_rx_dma
c_func
(paren
r_struct
id|pi_local
op_star
id|lp
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
r_int
id|cmd
suffix:semicolon
r_int
r_int
id|dma_abs
suffix:semicolon
r_int
id|dmachan
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|dma_abs
op_assign
(paren
r_int
r_int
)paren
(paren
id|lp-&gt;rcvbuf-&gt;data
)paren
suffix:semicolon
id|dmachan
op_assign
id|lp-&gt;dmachan
suffix:semicolon
id|cmd
op_assign
id|lp-&gt;base
op_plus
id|CTL
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|valid_dma_page
c_func
(paren
id|dma_abs
comma
id|DMA_BUFF_SIZE
op_plus
r_sizeof
(paren
r_struct
id|mbuf
)paren
)paren
)paren
(brace
id|panic
c_func
(paren
l_string|&quot;PI: RX buffer violates DMA boundary!&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/* Get ready for RX DMA */
id|wrtscc
c_func
(paren
id|lp-&gt;cardbase
comma
id|cmd
comma
id|R1
comma
id|WT_FN_RDYFN
op_or
id|WT_RDY_RT
op_or
id|INT_ERR_Rx
op_or
id|EXT_INT_ENAB
)paren
suffix:semicolon
id|disable_dma
c_func
(paren
id|dmachan
)paren
suffix:semicolon
id|clear_dma_ff
c_func
(paren
id|dmachan
)paren
suffix:semicolon
multiline_comment|/* Set DMA mode register to single transfers, incrementing address,&n;     *  auto init, writes&n;     */
id|set_dma_mode
c_func
(paren
id|dmachan
comma
id|DMA_MODE_READ
op_or
l_int|0x10
)paren
suffix:semicolon
id|set_dma_addr
c_func
(paren
id|dmachan
comma
id|dma_abs
)paren
suffix:semicolon
id|set_dma_count
c_func
(paren
id|dmachan
comma
id|lp-&gt;bufsiz
)paren
suffix:semicolon
id|enable_dma
c_func
(paren
id|dmachan
)paren
suffix:semicolon
multiline_comment|/* If a packet is already coming in, this line is supposed to&n;&t;   avoid receiving a partial packet.&n;     */
id|wrtscc
c_func
(paren
id|lp-&gt;cardbase
comma
id|cmd
comma
id|R0
comma
id|RES_Rx_CRC
)paren
suffix:semicolon
multiline_comment|/* Enable RX dma */
id|wrtscc
c_func
(paren
id|lp-&gt;cardbase
comma
id|cmd
comma
id|R1
comma
id|WT_RDY_ENAB
op_or
id|WT_FN_RDYFN
op_or
id|WT_RDY_RT
op_or
id|INT_ERR_Rx
op_or
id|EXT_INT_ENAB
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
DECL|function|setup_tx_dma
r_static
r_void
id|setup_tx_dma
c_func
(paren
r_struct
id|pi_local
op_star
id|lp
comma
r_int
id|length
)paren
(brace
r_int
r_int
id|dma_abs
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_int
r_int
id|dmachan
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|dmachan
op_assign
id|lp-&gt;dmachan
suffix:semicolon
id|dma_abs
op_assign
(paren
r_int
r_int
)paren
(paren
id|lp-&gt;txdmabuf
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|valid_dma_page
c_func
(paren
id|dma_abs
comma
id|DMA_BUFF_SIZE
op_plus
r_sizeof
(paren
r_struct
id|mbuf
)paren
)paren
)paren
(brace
id|panic
c_func
(paren
l_string|&quot;PI: TX buffer violates DMA boundary!&quot;
)paren
suffix:semicolon
)brace
id|disable_dma
c_func
(paren
id|dmachan
)paren
suffix:semicolon
multiline_comment|/* Set DMA mode register to single transfers, incrementing address,&n;     *  no auto init, reads&n;     */
id|set_dma_mode
c_func
(paren
id|dmachan
comma
id|DMA_MODE_WRITE
)paren
suffix:semicolon
id|clear_dma_ff
c_func
(paren
id|dmachan
)paren
suffix:semicolon
id|set_dma_addr
c_func
(paren
id|dmachan
comma
id|dma_abs
)paren
suffix:semicolon
multiline_comment|/* output byte count */
id|set_dma_count
c_func
(paren
id|dmachan
comma
id|length
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
DECL|function|tdelay
r_static
r_void
id|tdelay
c_func
(paren
r_struct
id|pi_local
op_star
id|lp
comma
r_int
id|time
)paren
(brace
r_int
id|port
suffix:semicolon
r_int
r_int
id|t1
suffix:semicolon
r_int
r_char
id|sc
suffix:semicolon
r_if
c_cond
(paren
id|lp-&gt;base
op_amp
l_int|2
)paren
(brace
multiline_comment|/* If A channel */
id|sc
op_assign
id|SC1
suffix:semicolon
id|t1
op_assign
id|time
suffix:semicolon
id|port
op_assign
id|lp-&gt;cardbase
op_plus
id|TMR1
suffix:semicolon
)brace
r_else
(brace
id|sc
op_assign
id|SC2
suffix:semicolon
id|t1
op_assign
l_int|10
op_star
id|time
suffix:semicolon
multiline_comment|/* 10s of milliseconds for the B channel */
id|port
op_assign
id|lp-&gt;cardbase
op_plus
id|TMR2
suffix:semicolon
id|wrtscc
c_func
(paren
id|lp-&gt;cardbase
comma
id|lp-&gt;base
op_plus
id|CTL
comma
id|R1
comma
id|INT_ALL_Rx
op_or
id|EXT_INT_ENAB
)paren
suffix:semicolon
)brace
multiline_comment|/* Setup timer sc */
id|outb_p
c_func
(paren
id|sc
op_or
id|LSB_MSB
op_or
id|MODE0
comma
id|lp-&gt;cardbase
op_plus
id|TMRCMD
)paren
suffix:semicolon
multiline_comment|/* times 2 to make millisecs */
id|outb_p
c_func
(paren
(paren
id|t1
op_lshift
l_int|1
)paren
op_amp
l_int|0xFF
comma
id|port
)paren
suffix:semicolon
id|outb_p
c_func
(paren
(paren
id|t1
op_rshift
l_int|7
)paren
op_amp
l_int|0xFF
comma
id|port
)paren
suffix:semicolon
multiline_comment|/* Enable correct int for timeout */
id|wrtscc
c_func
(paren
id|lp-&gt;cardbase
comma
id|lp-&gt;base
op_plus
id|CTL
comma
id|R15
comma
id|CTSIE
)paren
suffix:semicolon
id|wrtscc
c_func
(paren
id|lp-&gt;cardbase
comma
id|lp-&gt;base
op_plus
id|CTL
comma
id|R0
comma
id|RES_EXT_INT
)paren
suffix:semicolon
)brace
DECL|function|a_txint
r_static
r_void
id|a_txint
c_func
(paren
r_struct
id|pi_local
op_star
id|lp
)paren
(brace
r_int
id|cmd
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|cmd
op_assign
id|CTL
op_plus
id|lp-&gt;base
suffix:semicolon
r_switch
c_cond
(paren
id|lp-&gt;tstate
)paren
(brace
r_case
id|IDLE
suffix:colon
multiline_comment|/* Transmitter idle. Find a frame for transmission */
r_if
c_cond
(paren
(paren
id|lp-&gt;sndbuf
op_assign
id|skb_dequeue
c_func
(paren
op_amp
id|lp-&gt;sndq
)paren
)paren
op_eq
l_int|NULL
)paren
(brace
id|rts
c_func
(paren
id|lp
comma
id|OFF
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/* If a buffer to send, we drop thru here */
r_case
id|DEFER
suffix:colon
multiline_comment|/* we may have deferred prev xmit attempt */
multiline_comment|/* Check DCD - debounce it&n;         * See Intel Microcommunications Handbook, p2-308&n;         */
id|wrtscc
c_func
(paren
id|lp-&gt;cardbase
comma
id|cmd
comma
id|R0
comma
id|RES_EXT_INT
)paren
suffix:semicolon
id|wrtscc
c_func
(paren
id|lp-&gt;cardbase
comma
id|cmd
comma
id|R0
comma
id|RES_EXT_INT
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|rdscc
c_func
(paren
id|lp-&gt;cardbase
comma
id|cmd
comma
id|R0
)paren
op_amp
id|DCD
)paren
op_ne
l_int|0
)paren
(brace
id|lp-&gt;tstate
op_assign
id|DEFER
suffix:semicolon
id|tdelay
c_func
(paren
id|lp
comma
l_int|100
)paren
suffix:semicolon
multiline_comment|/* defer until DCD transition or timeout */
id|wrtscc
c_func
(paren
id|lp-&gt;cardbase
comma
id|cmd
comma
id|R15
comma
id|CTSIE
op_or
id|DCDIE
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|random
c_func
(paren
)paren
OG
id|lp-&gt;persist
)paren
(brace
id|lp-&gt;tstate
op_assign
id|DEFER
suffix:semicolon
id|tdelay
c_func
(paren
id|lp
comma
id|lp-&gt;slotime
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/* Assert RTS early minimize collision window */
id|wrtscc
c_func
(paren
id|lp-&gt;cardbase
comma
id|cmd
comma
id|R5
comma
id|TxCRC_ENAB
op_or
id|RTS
op_or
id|Tx8
)paren
suffix:semicolon
id|rts
c_func
(paren
id|lp
comma
id|ON
)paren
suffix:semicolon
multiline_comment|/* Transmitter on */
id|lp-&gt;tstate
op_assign
id|ST_TXDELAY
suffix:semicolon
id|tdelay
c_func
(paren
id|lp
comma
id|lp-&gt;txdelay
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
suffix:semicolon
r_default
suffix:colon
r_break
suffix:semicolon
)brace
multiline_comment|/* end switch(lp-&gt;state) */
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
multiline_comment|/*a_txint */
DECL|function|a_exint
r_static
r_void
id|a_exint
c_func
(paren
r_struct
id|pi_local
op_star
id|lp
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
r_int
id|cmd
suffix:semicolon
r_char
id|st
suffix:semicolon
r_int
id|length
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* disable interrupts */
id|st
op_assign
id|rdscc
c_func
(paren
id|lp-&gt;cardbase
comma
id|lp-&gt;base
op_plus
id|CTL
comma
id|R0
)paren
suffix:semicolon
multiline_comment|/* Fetch status */
multiline_comment|/* reset external status latch */
id|wrtscc
c_func
(paren
id|lp-&gt;cardbase
comma
id|CTL
op_plus
id|lp-&gt;base
comma
id|R0
comma
id|RES_EXT_INT
)paren
suffix:semicolon
id|cmd
op_assign
id|lp-&gt;base
op_plus
id|CTL
suffix:semicolon
r_if
c_cond
(paren
(paren
id|lp-&gt;rstate
op_ge
id|ACTIVE
)paren
op_logical_and
(paren
id|st
op_amp
id|BRK_ABRT
)paren
)paren
(brace
id|setup_rx_dma
c_func
(paren
id|lp
)paren
suffix:semicolon
id|lp-&gt;rstate
op_assign
id|ACTIVE
suffix:semicolon
)brace
r_switch
c_cond
(paren
id|lp-&gt;tstate
)paren
(brace
r_case
id|ACTIVE
suffix:colon
id|kfree_skb
c_func
(paren
id|lp-&gt;sndbuf
comma
id|FREE_WRITE
)paren
suffix:semicolon
id|lp-&gt;sndbuf
op_assign
l_int|NULL
suffix:semicolon
id|lp-&gt;tstate
op_assign
id|FLAGOUT
suffix:semicolon
id|tdelay
c_func
(paren
id|lp
comma
id|lp-&gt;squeldelay
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|FLAGOUT
suffix:colon
r_if
c_cond
(paren
(paren
id|lp-&gt;sndbuf
op_assign
id|skb_dequeue
c_func
(paren
op_amp
id|lp-&gt;sndq
)paren
)paren
op_eq
l_int|NULL
)paren
(brace
multiline_comment|/* Nothing to send - return to receive mode */
id|lp-&gt;tstate
op_assign
id|IDLE
suffix:semicolon
id|rts
c_func
(paren
id|lp
comma
id|OFF
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/* NOTE - fall through if more to send */
r_case
id|ST_TXDELAY
suffix:colon
multiline_comment|/* Disable DMA chan */
id|disable_dma
c_func
(paren
id|lp-&gt;dmachan
)paren
suffix:semicolon
multiline_comment|/* Set up for TX dma */
id|wrtscc
c_func
(paren
id|lp-&gt;cardbase
comma
id|cmd
comma
id|R1
comma
id|WT_FN_RDYFN
op_or
id|EXT_INT_ENAB
)paren
suffix:semicolon
multiline_comment|/* Get all chars */
multiline_comment|/* Strip KISS control byte */
id|length
op_assign
id|lp-&gt;sndbuf-&gt;len
op_minus
l_int|1
suffix:semicolon
id|memcpy
c_func
(paren
id|lp-&gt;txdmabuf
comma
op_amp
id|lp-&gt;sndbuf-&gt;data
(braket
l_int|1
)braket
comma
id|length
)paren
suffix:semicolon
multiline_comment|/* Setup DMA controller for tx */
id|setup_tx_dma
c_func
(paren
id|lp
comma
id|length
)paren
suffix:semicolon
multiline_comment|/* select transmit interrupts to enable */
multiline_comment|/* Allow DMA on chan */
id|enable_dma
c_func
(paren
id|lp-&gt;dmachan
)paren
suffix:semicolon
multiline_comment|/* reset CRC, Txint pend*/
id|wrtscc
c_func
(paren
id|lp-&gt;cardbase
comma
id|cmd
comma
id|R0
comma
id|RES_Tx_CRC
op_or
id|RES_Tx_P
)paren
suffix:semicolon
multiline_comment|/* allow Underrun int only */
id|wrtscc
c_func
(paren
id|lp-&gt;cardbase
comma
id|cmd
comma
id|R15
comma
id|TxUIE
)paren
suffix:semicolon
multiline_comment|/* Enable TX DMA */
id|wrtscc
c_func
(paren
id|lp-&gt;cardbase
comma
id|cmd
comma
id|R1
comma
id|WT_RDY_ENAB
op_or
id|WT_FN_RDYFN
op_or
id|EXT_INT_ENAB
)paren
suffix:semicolon
multiline_comment|/* Send CRC on underrun */
id|wrtscc
c_func
(paren
id|lp-&gt;cardbase
comma
id|cmd
comma
id|R0
comma
id|RES_EOM_L
)paren
suffix:semicolon
multiline_comment|/* packet going out now */
id|lp-&gt;tstate
op_assign
id|ACTIVE
suffix:semicolon
r_break
suffix:semicolon
r_case
id|DEFER
suffix:colon
multiline_comment|/* we have deferred prev xmit attempt&n;         * See Intel Microcommunications Handbook, p2-308&n;         */
id|wrtscc
c_func
(paren
id|lp-&gt;cardbase
comma
id|cmd
comma
id|R0
comma
id|RES_EXT_INT
)paren
suffix:semicolon
id|wrtscc
c_func
(paren
id|lp-&gt;cardbase
comma
id|cmd
comma
id|R0
comma
id|RES_EXT_INT
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|rdscc
c_func
(paren
id|lp-&gt;cardbase
comma
id|cmd
comma
id|R0
)paren
op_amp
id|DCD
)paren
op_ne
l_int|0
)paren
(brace
id|lp-&gt;tstate
op_assign
id|DEFER
suffix:semicolon
id|tdelay
c_func
(paren
id|lp
comma
l_int|100
)paren
suffix:semicolon
multiline_comment|/* Defer until dcd transition or 100mS timeout */
id|wrtscc
c_func
(paren
id|lp-&gt;cardbase
comma
id|CTL
op_plus
id|lp-&gt;base
comma
id|R15
comma
id|CTSIE
op_or
id|DCDIE
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|random
c_func
(paren
)paren
OG
id|lp-&gt;persist
)paren
(brace
id|lp-&gt;tstate
op_assign
id|DEFER
suffix:semicolon
id|tdelay
c_func
(paren
id|lp
comma
id|lp-&gt;slotime
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/* Assert RTS early minimize collision window */
id|wrtscc
c_func
(paren
id|lp-&gt;cardbase
comma
id|cmd
comma
id|R5
comma
id|TxCRC_ENAB
op_or
id|RTS
op_or
id|Tx8
)paren
suffix:semicolon
id|rts
c_func
(paren
id|lp
comma
id|ON
)paren
suffix:semicolon
multiline_comment|/* Transmitter on */
id|lp-&gt;tstate
op_assign
id|ST_TXDELAY
suffix:semicolon
id|tdelay
c_func
(paren
id|lp
comma
id|lp-&gt;txdelay
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/* switch(lp-&gt;tstate) */
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
multiline_comment|/* a_exint() */
multiline_comment|/* Receive interrupt handler for the A channel&n; */
DECL|function|a_rxint
r_static
r_void
id|a_rxint
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
r_struct
id|pi_local
op_star
id|lp
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
r_int
id|cmd
suffix:semicolon
r_int
id|bytecount
suffix:semicolon
r_char
id|rse
suffix:semicolon
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
r_int
id|sksize
comma
id|pkt_len
suffix:semicolon
r_struct
id|mbuf
op_star
id|cur_buf
suffix:semicolon
r_int
r_char
op_star
id|cfix
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* disable interrupts */
id|cmd
op_assign
id|lp-&gt;base
op_plus
id|CTL
suffix:semicolon
id|rse
op_assign
id|rdscc
c_func
(paren
id|lp-&gt;cardbase
comma
id|cmd
comma
id|R1
)paren
suffix:semicolon
multiline_comment|/* Get special condition bits from R1 */
r_if
c_cond
(paren
id|rse
op_amp
id|Rx_OVR
)paren
id|lp-&gt;rstate
op_assign
id|RXERROR
suffix:semicolon
r_if
c_cond
(paren
id|rse
op_amp
id|END_FR
)paren
(brace
multiline_comment|/* If end of frame */
multiline_comment|/* figure length of frame from 8237 */
id|clear_dma_ff
c_func
(paren
id|lp-&gt;dmachan
)paren
suffix:semicolon
id|bytecount
op_assign
id|lp-&gt;bufsiz
op_minus
id|get_dma_residue
c_func
(paren
id|lp-&gt;dmachan
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|rse
op_amp
id|CRC_ERR
)paren
op_logical_or
(paren
id|lp-&gt;rstate
OG
id|ACTIVE
)paren
op_logical_or
(paren
id|bytecount
OL
l_int|10
)paren
)paren
(brace
r_if
c_cond
(paren
(paren
id|bytecount
op_ge
l_int|10
)paren
op_logical_and
(paren
id|rse
op_amp
id|CRC_ERR
)paren
)paren
(brace
id|lp-&gt;stats.rx_crc_errors
op_increment
suffix:semicolon
)brace
r_if
c_cond
(paren
id|lp-&gt;rstate
op_eq
id|RXERROR
)paren
(brace
id|lp-&gt;stats.rx_errors
op_increment
suffix:semicolon
id|lp-&gt;stats.rx_over_errors
op_increment
suffix:semicolon
)brace
multiline_comment|/* Reset buffer pointers */
id|lp-&gt;rstate
op_assign
id|ACTIVE
suffix:semicolon
id|setup_rx_dma
c_func
(paren
id|lp
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* Here we have a valid frame */
multiline_comment|/* Toss 2 crc bytes , add one for KISS */
id|pkt_len
op_assign
id|lp-&gt;rcvbuf-&gt;cnt
op_assign
id|bytecount
op_minus
l_int|2
op_plus
l_int|1
suffix:semicolon
multiline_comment|/* Get buffer for next frame */
id|cur_buf
op_assign
id|lp-&gt;rcvbuf
suffix:semicolon
id|switchbuffers
c_func
(paren
id|lp
)paren
suffix:semicolon
id|setup_rx_dma
c_func
(paren
id|lp
)paren
suffix:semicolon
multiline_comment|/* Malloc up new buffer. */
id|sksize
op_assign
id|pkt_len
suffix:semicolon
id|skb
op_assign
id|dev_alloc_skb
c_func
(paren
id|sksize
)paren
suffix:semicolon
r_if
c_cond
(paren
id|skb
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;PI: %s: Memory squeeze, dropping packet.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|lp-&gt;stats.rx_dropped
op_increment
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|skb-&gt;dev
op_assign
id|dev
suffix:semicolon
multiline_comment|/* KISS kludge -  prefix with a 0 byte */
id|cfix
op_assign
id|skb_put
c_func
(paren
id|skb
comma
id|pkt_len
)paren
suffix:semicolon
op_star
id|cfix
op_increment
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* &squot;skb-&gt;data&squot; points to the start of sk_buff data area. */
id|memcpy
c_func
(paren
id|cfix
comma
(paren
r_char
op_star
)paren
id|cur_buf-&gt;data
comma
id|pkt_len
op_minus
l_int|1
)paren
suffix:semicolon
id|skb-&gt;protocol
op_assign
id|htons
c_func
(paren
id|ETH_P_AX25
)paren
suffix:semicolon
id|skb-&gt;mac.raw
op_assign
id|skb-&gt;data
suffix:semicolon
id|netif_rx
c_func
(paren
id|skb
)paren
suffix:semicolon
id|lp-&gt;stats.rx_packets
op_increment
suffix:semicolon
)brace
multiline_comment|/* end good frame */
)brace
multiline_comment|/* end EOF check */
id|wrtscc
c_func
(paren
id|lp-&gt;cardbase
comma
id|lp-&gt;base
op_plus
id|CTL
comma
id|R0
comma
id|ERR_RES
)paren
suffix:semicolon
multiline_comment|/* error reset */
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
DECL|function|b_rxint
r_static
r_void
id|b_rxint
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
r_struct
id|pi_local
op_star
id|lp
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
r_int
id|cmd
suffix:semicolon
r_char
id|rse
suffix:semicolon
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
r_int
id|sksize
suffix:semicolon
r_int
id|pkt_len
suffix:semicolon
r_int
r_char
op_star
id|cfix
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* disable interrupts */
id|cmd
op_assign
id|CTL
op_plus
id|lp-&gt;base
suffix:semicolon
id|rse
op_assign
id|rdscc
c_func
(paren
id|lp-&gt;cardbase
comma
id|cmd
comma
id|R1
)paren
suffix:semicolon
multiline_comment|/* get status byte from R1 */
r_if
c_cond
(paren
(paren
id|rdscc
c_func
(paren
id|lp-&gt;cardbase
comma
id|cmd
comma
id|R0
)paren
)paren
op_amp
id|Rx_CH_AV
)paren
(brace
multiline_comment|/* there is a char to be stored&n;         * read special condition bits before reading the data char&n;         */
r_if
c_cond
(paren
id|rse
op_amp
id|Rx_OVR
)paren
(brace
multiline_comment|/* Rx overrun - toss buffer */
multiline_comment|/* reset buffer pointers */
id|lp-&gt;rcp
op_assign
id|lp-&gt;rcvbuf-&gt;data
suffix:semicolon
id|lp-&gt;rcvbuf-&gt;cnt
op_assign
l_int|0
suffix:semicolon
id|lp-&gt;rstate
op_assign
id|RXERROR
suffix:semicolon
multiline_comment|/* set error flag */
id|lp-&gt;stats.rx_errors
op_increment
suffix:semicolon
id|lp-&gt;stats.rx_over_errors
op_increment
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|lp-&gt;rcvbuf-&gt;cnt
op_ge
id|lp-&gt;bufsiz
)paren
(brace
multiline_comment|/* Too large -- toss buffer */
multiline_comment|/* reset buffer pointers */
id|lp-&gt;rcp
op_assign
id|lp-&gt;rcvbuf-&gt;data
suffix:semicolon
id|lp-&gt;rcvbuf-&gt;cnt
op_assign
l_int|0
suffix:semicolon
id|lp-&gt;rstate
op_assign
id|TOOBIG
suffix:semicolon
multiline_comment|/* when set, chars are not stored */
)brace
multiline_comment|/* ok, we can store the received character now */
r_if
c_cond
(paren
id|lp-&gt;rstate
op_eq
id|ACTIVE
)paren
(brace
multiline_comment|/* If no errors... */
op_star
id|lp-&gt;rcp
op_increment
op_assign
id|rdscc
c_func
(paren
id|lp-&gt;cardbase
comma
id|cmd
comma
id|R8
)paren
suffix:semicolon
multiline_comment|/* char to rcv buff */
id|lp-&gt;rcvbuf-&gt;cnt
op_increment
suffix:semicolon
multiline_comment|/* bump count */
)brace
r_else
(brace
multiline_comment|/* got to empty FIFO */
(paren
r_void
)paren
id|rdscc
c_func
(paren
id|lp-&gt;cardbase
comma
id|cmd
comma
id|R8
)paren
suffix:semicolon
id|wrtscc
c_func
(paren
id|lp-&gt;cardbase
comma
id|cmd
comma
id|R0
comma
id|ERR_RES
)paren
suffix:semicolon
multiline_comment|/* reset err latch */
id|lp-&gt;rstate
op_assign
id|ACTIVE
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|rse
op_amp
id|END_FR
)paren
(brace
multiline_comment|/* END OF FRAME -- Make sure Rx was active */
r_if
c_cond
(paren
id|lp-&gt;rcvbuf-&gt;cnt
OG
l_int|0
)paren
(brace
r_if
c_cond
(paren
(paren
id|rse
op_amp
id|CRC_ERR
)paren
op_logical_or
(paren
id|lp-&gt;rstate
OG
id|ACTIVE
)paren
op_logical_or
(paren
id|lp-&gt;rcvbuf-&gt;cnt
OL
l_int|10
)paren
)paren
(brace
r_if
c_cond
(paren
(paren
id|lp-&gt;rcvbuf-&gt;cnt
op_ge
l_int|10
)paren
op_logical_and
(paren
id|rse
op_amp
id|CRC_ERR
)paren
)paren
(brace
id|lp-&gt;stats.rx_crc_errors
op_increment
suffix:semicolon
)brace
id|lp-&gt;rcp
op_assign
id|lp-&gt;rcvbuf-&gt;data
suffix:semicolon
id|lp-&gt;rcvbuf-&gt;cnt
op_assign
l_int|0
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* Here we have a valid frame */
id|pkt_len
op_assign
id|lp-&gt;rcvbuf-&gt;cnt
op_sub_assign
l_int|2
suffix:semicolon
multiline_comment|/* Toss 2 crc bytes */
id|pkt_len
op_add_assign
l_int|1
suffix:semicolon
multiline_comment|/* Make room for KISS control byte */
multiline_comment|/* Malloc up new buffer. */
id|sksize
op_assign
id|pkt_len
suffix:semicolon
id|skb
op_assign
id|dev_alloc_skb
c_func
(paren
id|sksize
)paren
suffix:semicolon
r_if
c_cond
(paren
id|skb
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;PI: %s: Memory squeeze, dropping packet.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|lp-&gt;stats.rx_dropped
op_increment
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|skb-&gt;dev
op_assign
id|dev
suffix:semicolon
multiline_comment|/* KISS kludge -  prefix with a 0 byte */
id|cfix
op_assign
id|skb_put
c_func
(paren
id|skb
comma
id|pkt_len
)paren
suffix:semicolon
op_star
id|cfix
op_increment
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* &squot;skb-&gt;data&squot; points to the start of sk_buff data area. */
id|memcpy
c_func
(paren
id|cfix
comma
id|lp-&gt;rcvbuf-&gt;data
comma
id|pkt_len
op_minus
l_int|1
)paren
suffix:semicolon
id|skb-&gt;protocol
op_assign
id|ntohs
c_func
(paren
id|ETH_P_AX25
)paren
suffix:semicolon
id|skb-&gt;mac.raw
op_assign
id|skb-&gt;data
suffix:semicolon
id|netif_rx
c_func
(paren
id|skb
)paren
suffix:semicolon
id|lp-&gt;stats.rx_packets
op_increment
suffix:semicolon
multiline_comment|/* packet queued - initialize buffer for next frame */
id|lp-&gt;rcp
op_assign
id|lp-&gt;rcvbuf-&gt;data
suffix:semicolon
id|lp-&gt;rcvbuf-&gt;cnt
op_assign
l_int|0
suffix:semicolon
)brace
multiline_comment|/* end good frame queued */
)brace
multiline_comment|/* end check for active receive upon EOF */
id|lp-&gt;rstate
op_assign
id|ACTIVE
suffix:semicolon
multiline_comment|/* and clear error status */
)brace
multiline_comment|/* end EOF check */
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
DECL|function|b_txint
r_static
r_void
id|b_txint
c_func
(paren
r_struct
id|pi_local
op_star
id|lp
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
r_int
id|cmd
suffix:semicolon
r_int
r_char
id|c
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|cmd
op_assign
id|CTL
op_plus
id|lp-&gt;base
suffix:semicolon
r_switch
c_cond
(paren
id|lp-&gt;tstate
)paren
(brace
r_case
id|CRCOUT
suffix:colon
id|lp-&gt;tstate
op_assign
id|FLAGOUT
suffix:semicolon
id|tdelay
c_func
(paren
id|lp
comma
id|lp-&gt;squeldelay
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
suffix:semicolon
r_case
id|IDLE
suffix:colon
multiline_comment|/* Transmitter idle. Find a frame for transmission */
r_if
c_cond
(paren
(paren
id|lp-&gt;sndbuf
op_assign
id|skb_dequeue
c_func
(paren
op_amp
id|lp-&gt;sndq
)paren
)paren
op_eq
l_int|NULL
)paren
(brace
multiline_comment|/* Nothing to send - return to receive mode&n;             * Tx OFF now - flag should have gone&n;             */
id|rts
c_func
(paren
id|lp
comma
id|OFF
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|lp-&gt;txptr
op_assign
id|lp-&gt;sndbuf-&gt;data
suffix:semicolon
id|lp-&gt;txptr
op_increment
suffix:semicolon
multiline_comment|/* Ignore KISS control byte */
id|lp-&gt;txcnt
op_assign
(paren
r_int
)paren
id|lp-&gt;sndbuf-&gt;len
op_minus
l_int|1
suffix:semicolon
multiline_comment|/* If a buffer to send, we drop thru here */
r_case
id|DEFER
suffix:colon
multiline_comment|/* we may have deferred prev xmit attempt */
multiline_comment|/* Check DCD - debounce it */
multiline_comment|/* See Intel Microcommunications Handbook, p2-308 */
id|wrtscc
c_func
(paren
id|lp-&gt;cardbase
comma
id|cmd
comma
id|R0
comma
id|RES_EXT_INT
)paren
suffix:semicolon
id|wrtscc
c_func
(paren
id|lp-&gt;cardbase
comma
id|cmd
comma
id|R0
comma
id|RES_EXT_INT
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|rdscc
c_func
(paren
id|lp-&gt;cardbase
comma
id|cmd
comma
id|R0
)paren
op_amp
id|DCD
)paren
op_ne
l_int|0
)paren
(brace
id|lp-&gt;tstate
op_assign
id|DEFER
suffix:semicolon
id|tdelay
c_func
(paren
id|lp
comma
l_int|100
)paren
suffix:semicolon
multiline_comment|/* defer until DCD transition or timeout */
id|wrtscc
c_func
(paren
id|lp-&gt;cardbase
comma
id|cmd
comma
id|R15
comma
id|CTSIE
op_or
id|DCDIE
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|random
c_func
(paren
)paren
OG
id|lp-&gt;persist
)paren
(brace
id|lp-&gt;tstate
op_assign
id|DEFER
suffix:semicolon
id|tdelay
c_func
(paren
id|lp
comma
id|lp-&gt;slotime
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|rts
c_func
(paren
id|lp
comma
id|ON
)paren
suffix:semicolon
multiline_comment|/* Transmitter on */
id|lp-&gt;tstate
op_assign
id|ST_TXDELAY
suffix:semicolon
id|tdelay
c_func
(paren
id|lp
comma
id|lp-&gt;txdelay
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
suffix:semicolon
r_case
id|ACTIVE
suffix:colon
multiline_comment|/* Here we are actively sending a frame */
r_if
c_cond
(paren
id|lp-&gt;txcnt
op_decrement
)paren
(brace
id|c
op_assign
op_star
id|lp-&gt;txptr
op_increment
suffix:semicolon
multiline_comment|/* next char is gone */
id|wrtscc
c_func
(paren
id|lp-&gt;cardbase
comma
id|cmd
comma
id|R8
comma
id|c
)paren
suffix:semicolon
multiline_comment|/* stuffing a char satisfies Interrupt condition */
)brace
r_else
(brace
multiline_comment|/* No more to send */
id|kfree_skb
c_func
(paren
id|lp-&gt;sndbuf
comma
id|FREE_WRITE
)paren
suffix:semicolon
id|lp-&gt;sndbuf
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
(paren
id|rdscc
c_func
(paren
id|lp-&gt;cardbase
comma
id|cmd
comma
id|R0
)paren
op_amp
l_int|0x40
)paren
)paren
(brace
multiline_comment|/* Did we underrun? */
multiline_comment|/* unexpected underrun */
id|lp-&gt;stats.tx_errors
op_increment
suffix:semicolon
id|lp-&gt;stats.tx_fifo_errors
op_increment
suffix:semicolon
id|wrtscc
c_func
(paren
id|lp-&gt;cardbase
comma
id|cmd
comma
id|R0
comma
id|SEND_ABORT
)paren
suffix:semicolon
id|lp-&gt;tstate
op_assign
id|FLAGOUT
suffix:semicolon
id|tdelay
c_func
(paren
id|lp
comma
id|lp-&gt;squeldelay
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|lp-&gt;tstate
op_assign
id|UNDERRUN
suffix:semicolon
multiline_comment|/* Now we expect to underrun */
multiline_comment|/* Send flags on underrun */
r_if
c_cond
(paren
id|lp-&gt;speed
)paren
(brace
multiline_comment|/* If internally clocked */
id|wrtscc
c_func
(paren
id|lp-&gt;cardbase
comma
id|cmd
comma
id|R10
comma
id|CRCPS
op_or
id|NRZI
)paren
suffix:semicolon
)brace
r_else
(brace
id|wrtscc
c_func
(paren
id|lp-&gt;cardbase
comma
id|cmd
comma
id|R10
comma
id|CRCPS
)paren
suffix:semicolon
)brace
id|wrtscc
c_func
(paren
id|lp-&gt;cardbase
comma
id|cmd
comma
id|R0
comma
id|RES_Tx_P
)paren
suffix:semicolon
multiline_comment|/* reset Tx Int Pend */
)brace
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
suffix:semicolon
multiline_comment|/* back to wait for interrupt */
)brace
multiline_comment|/* end switch */
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
multiline_comment|/* Pi SIO External/Status interrupts (for the B channel)&n; * This can be caused by a receiver abort, or a Tx UNDERRUN/EOM.&n; * Receiver automatically goes to Hunt on an abort.&n; *&n; * If the Tx Underrun interrupt hits, change state and&n; * issue a reset command for it, and return.&n; */
DECL|function|b_exint
r_static
r_void
id|b_exint
c_func
(paren
r_struct
id|pi_local
op_star
id|lp
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
r_char
id|st
suffix:semicolon
r_int
id|cmd
suffix:semicolon
r_char
id|c
suffix:semicolon
id|cmd
op_assign
id|CTL
op_plus
id|lp-&gt;base
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* disable interrupts */
id|st
op_assign
id|rdscc
c_func
(paren
id|lp-&gt;cardbase
comma
id|cmd
comma
id|R0
)paren
suffix:semicolon
multiline_comment|/* Fetch status */
multiline_comment|/* reset external status latch */
id|wrtscc
c_func
(paren
id|lp-&gt;cardbase
comma
id|cmd
comma
id|R0
comma
id|RES_EXT_INT
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|lp-&gt;tstate
)paren
(brace
r_case
id|ACTIVE
suffix:colon
multiline_comment|/* Unexpected underrun */
id|kfree_skb
c_func
(paren
id|lp-&gt;sndbuf
comma
id|FREE_WRITE
)paren
suffix:semicolon
id|lp-&gt;sndbuf
op_assign
l_int|NULL
suffix:semicolon
id|wrtscc
c_func
(paren
id|lp-&gt;cardbase
comma
id|cmd
comma
id|R0
comma
id|SEND_ABORT
)paren
suffix:semicolon
id|lp-&gt;tstate
op_assign
id|FLAGOUT
suffix:semicolon
id|lp-&gt;stats.tx_errors
op_increment
suffix:semicolon
id|lp-&gt;stats.tx_fifo_errors
op_increment
suffix:semicolon
id|tdelay
c_func
(paren
id|lp
comma
id|lp-&gt;squeldelay
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
suffix:semicolon
r_case
id|UNDERRUN
suffix:colon
id|lp-&gt;tstate
op_assign
id|CRCOUT
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
suffix:semicolon
r_case
id|FLAGOUT
suffix:colon
multiline_comment|/* Find a frame for transmission */
r_if
c_cond
(paren
(paren
id|lp-&gt;sndbuf
op_assign
id|skb_dequeue
c_func
(paren
op_amp
id|lp-&gt;sndq
)paren
)paren
op_eq
l_int|NULL
)paren
(brace
multiline_comment|/* Nothing to send - return to receive mode&n;             * Tx OFF now - flag should have gone&n;             */
id|rts
c_func
(paren
id|lp
comma
id|OFF
)paren
suffix:semicolon
id|lp-&gt;tstate
op_assign
id|IDLE
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|lp-&gt;txptr
op_assign
id|lp-&gt;sndbuf-&gt;data
suffix:semicolon
id|lp-&gt;txptr
op_increment
suffix:semicolon
multiline_comment|/* Ignore KISS control byte */
id|lp-&gt;txcnt
op_assign
(paren
r_int
)paren
id|lp-&gt;sndbuf-&gt;len
op_minus
l_int|1
suffix:semicolon
multiline_comment|/* Get first char to send */
id|lp-&gt;txcnt
op_decrement
suffix:semicolon
id|c
op_assign
op_star
id|lp-&gt;txptr
op_increment
suffix:semicolon
id|wrtscc
c_func
(paren
id|lp-&gt;cardbase
comma
id|cmd
comma
id|R0
comma
id|RES_Tx_CRC
)paren
suffix:semicolon
multiline_comment|/* reset for next frame */
multiline_comment|/* Send abort on underrun */
r_if
c_cond
(paren
id|lp-&gt;speed
)paren
(brace
multiline_comment|/* If internally clocked */
id|wrtscc
c_func
(paren
id|lp-&gt;cardbase
comma
id|cmd
comma
id|R10
comma
id|CRCPS
op_or
id|NRZI
op_or
id|ABUNDER
)paren
suffix:semicolon
)brace
r_else
(brace
id|wrtscc
c_func
(paren
id|lp-&gt;cardbase
comma
id|cmd
comma
id|R10
comma
id|CRCPS
op_or
id|ABUNDER
)paren
suffix:semicolon
)brace
id|wrtscc
c_func
(paren
id|lp-&gt;cardbase
comma
id|cmd
comma
id|R8
comma
id|c
)paren
suffix:semicolon
multiline_comment|/* First char out now */
id|wrtscc
c_func
(paren
id|lp-&gt;cardbase
comma
id|cmd
comma
id|R0
comma
id|RES_EOM_L
)paren
suffix:semicolon
multiline_comment|/* Reset end of message latch */
macro_line|#ifdef STUFF2
multiline_comment|/* stuff an extra one if we can */
r_if
c_cond
(paren
id|lp-&gt;txcnt
)paren
(brace
id|lp-&gt;txcnt
op_decrement
suffix:semicolon
id|c
op_assign
op_star
id|lp-&gt;txptr
op_increment
suffix:semicolon
multiline_comment|/* Wait for tx buffer empty */
r_while
c_loop
(paren
(paren
id|rdscc
c_func
(paren
id|lp-&gt;cardbase
comma
id|cmd
comma
id|R0
)paren
op_amp
l_int|0x04
)paren
op_eq
l_int|0
)paren
(brace
suffix:semicolon
)brace
id|wrtscc
c_func
(paren
id|lp-&gt;cardbase
comma
id|cmd
comma
id|R8
comma
id|c
)paren
suffix:semicolon
)brace
macro_line|#endif
multiline_comment|/* select transmit interrupts to enable */
id|wrtscc
c_func
(paren
id|lp-&gt;cardbase
comma
id|cmd
comma
id|R15
comma
id|TxUIE
)paren
suffix:semicolon
multiline_comment|/* allow Underrun int only */
id|wrtscc
c_func
(paren
id|lp-&gt;cardbase
comma
id|cmd
comma
id|R0
comma
id|RES_EXT_INT
)paren
suffix:semicolon
id|wrtscc
c_func
(paren
id|lp-&gt;cardbase
comma
id|cmd
comma
id|R1
comma
id|TxINT_ENAB
op_or
id|EXT_INT_ENAB
)paren
suffix:semicolon
multiline_comment|/* Tx/Ext ints */
id|lp-&gt;tstate
op_assign
id|ACTIVE
suffix:semicolon
multiline_comment|/* char going out now */
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
suffix:semicolon
r_case
id|DEFER
suffix:colon
multiline_comment|/* Check DCD - debounce it&n;         * See Intel Microcommunications Handbook, p2-308&n;         */
id|wrtscc
c_func
(paren
id|lp-&gt;cardbase
comma
id|cmd
comma
id|R0
comma
id|RES_EXT_INT
)paren
suffix:semicolon
id|wrtscc
c_func
(paren
id|lp-&gt;cardbase
comma
id|cmd
comma
id|R0
comma
id|RES_EXT_INT
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|rdscc
c_func
(paren
id|lp-&gt;cardbase
comma
id|cmd
comma
id|R0
)paren
op_amp
id|DCD
)paren
op_ne
l_int|0
)paren
(brace
id|lp-&gt;tstate
op_assign
id|DEFER
suffix:semicolon
id|tdelay
c_func
(paren
id|lp
comma
l_int|100
)paren
suffix:semicolon
multiline_comment|/* defer until DCD transition or timeout */
id|wrtscc
c_func
(paren
id|lp-&gt;cardbase
comma
id|cmd
comma
id|R15
comma
id|CTSIE
op_or
id|DCDIE
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|random
c_func
(paren
)paren
OG
id|lp-&gt;persist
)paren
(brace
id|lp-&gt;tstate
op_assign
id|DEFER
suffix:semicolon
id|tdelay
c_func
(paren
id|lp
comma
id|lp-&gt;slotime
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|rts
c_func
(paren
id|lp
comma
id|ON
)paren
suffix:semicolon
multiline_comment|/* Transmitter on */
id|lp-&gt;tstate
op_assign
id|ST_TXDELAY
suffix:semicolon
id|tdelay
c_func
(paren
id|lp
comma
id|lp-&gt;txdelay
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
suffix:semicolon
r_case
id|ST_TXDELAY
suffix:colon
multiline_comment|/* Get first char to send */
id|lp-&gt;txcnt
op_decrement
suffix:semicolon
id|c
op_assign
op_star
id|lp-&gt;txptr
op_increment
suffix:semicolon
id|wrtscc
c_func
(paren
id|lp-&gt;cardbase
comma
id|cmd
comma
id|R0
comma
id|RES_Tx_CRC
)paren
suffix:semicolon
multiline_comment|/* reset for next frame */
multiline_comment|/* Send abort on underrun */
r_if
c_cond
(paren
id|lp-&gt;speed
)paren
(brace
multiline_comment|/* If internally clocked */
id|wrtscc
c_func
(paren
id|lp-&gt;cardbase
comma
id|cmd
comma
id|R10
comma
id|CRCPS
op_or
id|NRZI
op_or
id|ABUNDER
)paren
suffix:semicolon
)brace
r_else
(brace
id|wrtscc
c_func
(paren
id|lp-&gt;cardbase
comma
id|cmd
comma
id|R10
comma
id|CRCPS
op_or
id|ABUNDER
)paren
suffix:semicolon
)brace
id|wrtscc
c_func
(paren
id|lp-&gt;cardbase
comma
id|cmd
comma
id|R8
comma
id|c
)paren
suffix:semicolon
multiline_comment|/* First char out now */
id|wrtscc
c_func
(paren
id|lp-&gt;cardbase
comma
id|cmd
comma
id|R0
comma
id|RES_EOM_L
)paren
suffix:semicolon
multiline_comment|/* Reset end of message latch */
macro_line|#ifdef STUFF2
multiline_comment|/* stuff an extra one if we can */
r_if
c_cond
(paren
id|lp-&gt;txcnt
)paren
(brace
id|lp-&gt;txcnt
op_decrement
suffix:semicolon
id|c
op_assign
op_star
id|lp-&gt;txptr
op_increment
suffix:semicolon
multiline_comment|/* Wait for tx buffer empty */
r_while
c_loop
(paren
(paren
id|rdscc
c_func
(paren
id|lp-&gt;cardbase
comma
id|cmd
comma
id|R0
)paren
op_amp
l_int|0x04
)paren
op_eq
l_int|0
)paren
(brace
suffix:semicolon
)brace
id|wrtscc
c_func
(paren
id|lp-&gt;cardbase
comma
id|cmd
comma
id|R8
comma
id|c
)paren
suffix:semicolon
)brace
macro_line|#endif
multiline_comment|/* select transmit interrupts to enable */
id|wrtscc
c_func
(paren
id|lp-&gt;cardbase
comma
id|cmd
comma
id|R15
comma
id|TxUIE
)paren
suffix:semicolon
multiline_comment|/* allow Underrun int only */
id|wrtscc
c_func
(paren
id|lp-&gt;cardbase
comma
id|cmd
comma
id|R0
comma
id|RES_EXT_INT
)paren
suffix:semicolon
multiline_comment|/* Tx/Extern ints on */
id|wrtscc
c_func
(paren
id|lp-&gt;cardbase
comma
id|cmd
comma
id|R1
comma
id|TxINT_ENAB
op_or
id|EXT_INT_ENAB
)paren
suffix:semicolon
id|lp-&gt;tstate
op_assign
id|ACTIVE
suffix:semicolon
multiline_comment|/* char going out now */
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/* Receive Mode only&n;     * This triggers when hunt mode is entered, &amp; since an ABORT&n;     * automatically enters hunt mode, we use that to clean up&n;     * any waiting garbage&n;     */
r_if
c_cond
(paren
(paren
id|lp-&gt;rstate
op_eq
id|ACTIVE
)paren
op_logical_and
(paren
id|st
op_amp
id|BRK_ABRT
)paren
)paren
(brace
(paren
r_void
)paren
id|rdscc
c_func
(paren
id|lp-&gt;cardbase
comma
id|cmd
comma
id|R8
)paren
suffix:semicolon
(paren
r_void
)paren
id|rdscc
c_func
(paren
id|lp-&gt;cardbase
comma
id|cmd
comma
id|R8
)paren
suffix:semicolon
(paren
r_void
)paren
id|rdscc
c_func
(paren
id|lp-&gt;cardbase
comma
id|cmd
comma
id|R8
)paren
suffix:semicolon
id|lp-&gt;rcp
op_assign
id|lp-&gt;rcvbuf-&gt;data
suffix:semicolon
id|lp-&gt;rcvbuf-&gt;cnt
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* rewind on DCD transition */
)brace
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
multiline_comment|/* Probe for a PI card. */
multiline_comment|/* This routine also initializes the timer chip */
DECL|function|__initfunc
id|__initfunc
c_func
(paren
r_static
r_int
id|hw_probe
c_func
(paren
r_int
id|ioaddr
)paren
)paren
(brace
r_int
id|time
op_assign
l_int|1000
suffix:semicolon
multiline_comment|/* Number of milliseconds for test */
r_int
r_int
id|start_time
comma
id|end_time
suffix:semicolon
r_int
id|base
comma
id|tmr0
comma
id|tmr1
comma
id|tmrcmd
suffix:semicolon
r_int
id|a
op_assign
l_int|1
suffix:semicolon
r_int
id|b
op_assign
l_int|1
suffix:semicolon
id|base
op_assign
id|ioaddr
op_amp
l_int|0x3f0
suffix:semicolon
id|tmr0
op_assign
id|TMR0
op_plus
id|base
suffix:semicolon
id|tmr1
op_assign
id|TMR1
op_plus
id|base
suffix:semicolon
id|tmrcmd
op_assign
id|TMRCMD
op_plus
id|base
suffix:semicolon
multiline_comment|/* Set up counter chip timer 0 for 500 uS period square wave */
multiline_comment|/* assuming a 3.68 mhz clock for now */
id|outb_p
c_func
(paren
id|SC0
op_or
id|LSB_MSB
op_or
id|MODE3
comma
id|tmrcmd
)paren
suffix:semicolon
id|outb_p
c_func
(paren
l_int|922
op_amp
l_int|0xFF
comma
id|tmr0
)paren
suffix:semicolon
id|outb_p
c_func
(paren
l_int|922
op_rshift
l_int|8
comma
id|tmr0
)paren
suffix:semicolon
multiline_comment|/* Setup timer control word for timer 1*/
id|outb_p
c_func
(paren
id|SC1
op_or
id|LSB_MSB
op_or
id|MODE0
comma
id|tmrcmd
)paren
suffix:semicolon
id|outb_p
c_func
(paren
(paren
id|time
op_lshift
l_int|1
)paren
op_amp
l_int|0xFF
comma
id|tmr1
)paren
suffix:semicolon
id|outb_p
c_func
(paren
(paren
id|time
op_rshift
l_int|7
)paren
op_amp
l_int|0XFF
comma
id|tmr1
)paren
suffix:semicolon
multiline_comment|/* wait until counter reg is loaded */
r_do
(brace
multiline_comment|/* Latch count for reading */
id|outb_p
c_func
(paren
id|SC1
comma
id|tmrcmd
)paren
suffix:semicolon
id|a
op_assign
id|inb_p
c_func
(paren
id|tmr1
)paren
suffix:semicolon
id|b
op_assign
id|inb_p
c_func
(paren
id|tmr1
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
id|b
op_eq
l_int|0
)paren
suffix:semicolon
id|start_time
op_assign
id|jiffies
suffix:semicolon
r_while
c_loop
(paren
id|b
op_ne
l_int|0
)paren
(brace
multiline_comment|/* Latch count for reading */
id|outb_p
c_func
(paren
id|SC1
comma
id|tmrcmd
)paren
suffix:semicolon
id|a
op_assign
id|inb_p
c_func
(paren
id|tmr1
)paren
suffix:semicolon
id|b
op_assign
id|inb_p
c_func
(paren
id|tmr1
)paren
suffix:semicolon
id|end_time
op_assign
id|jiffies
suffix:semicolon
multiline_comment|/* Don&squot;t wait forever - there may be no card here */
r_if
c_cond
(paren
(paren
id|end_time
op_minus
id|start_time
)paren
OG
l_int|200
)paren
r_return
l_int|0
suffix:semicolon
multiline_comment|/* No card found */
)brace
id|end_time
op_assign
id|jiffies
suffix:semicolon
multiline_comment|/* 87 jiffies, for a 3.68 mhz clock, half that for a double speed clock */
r_if
c_cond
(paren
(paren
id|end_time
op_minus
id|start_time
)paren
OG
l_int|65
)paren
(brace
r_return
(paren
l_int|1
)paren
suffix:semicolon
multiline_comment|/* PI card found */
)brace
r_else
(brace
multiline_comment|/* Faster crystal - tmr0 needs adjusting */
multiline_comment|/* Set up counter chip */
multiline_comment|/* 500 uS square wave */
id|outb_p
c_func
(paren
id|SC0
op_or
id|LSB_MSB
op_or
id|MODE3
comma
id|tmrcmd
)paren
suffix:semicolon
id|outb_p
c_func
(paren
l_int|1844
op_amp
l_int|0xFF
comma
id|tmr0
)paren
suffix:semicolon
id|outb_p
c_func
(paren
l_int|1844
op_rshift
l_int|8
comma
id|tmr0
)paren
suffix:semicolon
r_return
(paren
l_int|2
)paren
suffix:semicolon
multiline_comment|/* PI2 card found */
)brace
)brace
DECL|function|rts
r_static
r_void
id|rts
c_func
(paren
r_struct
id|pi_local
op_star
id|lp
comma
r_int
id|x
)paren
(brace
r_int
id|tc
suffix:semicolon
r_int
id|br
suffix:semicolon
r_int
id|cmd
suffix:semicolon
r_int
id|dummy
suffix:semicolon
multiline_comment|/* assumes interrupts are off */
id|cmd
op_assign
id|CTL
op_plus
id|lp-&gt;base
suffix:semicolon
multiline_comment|/* Reprogram BRG and turn on transmitter to send flags */
r_if
c_cond
(paren
id|x
op_eq
id|ON
)paren
(brace
multiline_comment|/* Turn Tx ON and Receive OFF */
multiline_comment|/* Exints off first to avoid abort int */
id|wrtscc
c_func
(paren
id|lp-&gt;cardbase
comma
id|cmd
comma
id|R15
comma
l_int|0
)paren
suffix:semicolon
id|wrtscc
c_func
(paren
id|lp-&gt;cardbase
comma
id|cmd
comma
id|R3
comma
id|Rx8
)paren
suffix:semicolon
multiline_comment|/* Rx off */
id|lp-&gt;rstate
op_assign
id|IDLE
suffix:semicolon
r_if
c_cond
(paren
id|cmd
op_amp
l_int|2
)paren
(brace
multiline_comment|/* if channel a */
multiline_comment|/* Set up for TX dma */
id|wrtscc
c_func
(paren
id|lp-&gt;cardbase
comma
id|cmd
comma
id|R1
comma
id|WT_FN_RDYFN
op_or
id|EXT_INT_ENAB
)paren
suffix:semicolon
)brace
r_else
(brace
id|wrtscc
c_func
(paren
id|lp-&gt;cardbase
comma
id|cmd
comma
id|R1
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* No interrupts */
)brace
r_if
c_cond
(paren
op_logical_neg
id|lp-&gt;clockmode
)paren
(brace
r_if
c_cond
(paren
id|lp-&gt;speed
)paren
(brace
multiline_comment|/* if internally clocked */
id|br
op_assign
id|lp-&gt;speed
suffix:semicolon
multiline_comment|/* get desired speed */
id|tc
op_assign
(paren
id|lp-&gt;xtal
op_div
id|br
)paren
op_minus
l_int|2
suffix:semicolon
multiline_comment|/* calc 1X BRG divisor */
id|wrtscc
c_func
(paren
id|lp-&gt;cardbase
comma
id|cmd
comma
id|R12
comma
id|tc
op_amp
l_int|0xFF
)paren
suffix:semicolon
multiline_comment|/* lower byte */
id|wrtscc
c_func
(paren
id|lp-&gt;cardbase
comma
id|cmd
comma
id|R13
comma
(paren
id|tc
op_rshift
l_int|8
)paren
op_amp
l_int|0xFF
)paren
suffix:semicolon
multiline_comment|/* upper byte */
)brace
)brace
id|wrtscc
c_func
(paren
id|lp-&gt;cardbase
comma
id|cmd
comma
id|R5
comma
id|TxCRC_ENAB
op_or
id|RTS
op_or
id|TxENAB
op_or
id|Tx8
op_or
id|DTR
)paren
suffix:semicolon
multiline_comment|/* Transmitter now on */
)brace
r_else
(brace
multiline_comment|/* Tx OFF and Rx ON */
id|lp-&gt;tstate
op_assign
id|IDLE
suffix:semicolon
id|wrtscc
c_func
(paren
id|lp-&gt;cardbase
comma
id|cmd
comma
id|R5
comma
id|Tx8
op_or
id|DTR
)paren
suffix:semicolon
multiline_comment|/*  TX off */
r_if
c_cond
(paren
op_logical_neg
id|lp-&gt;clockmode
)paren
(brace
r_if
c_cond
(paren
id|lp-&gt;speed
)paren
(brace
multiline_comment|/* if internally clocked */
multiline_comment|/* Reprogram BRG for 32x clock for receive DPLL */
multiline_comment|/* BRG off, keep Pclk source */
id|wrtscc
c_func
(paren
id|lp-&gt;cardbase
comma
id|cmd
comma
id|R14
comma
id|BRSRC
)paren
suffix:semicolon
id|br
op_assign
id|lp-&gt;speed
suffix:semicolon
multiline_comment|/* get desired speed */
multiline_comment|/* calc 32X BRG divisor */
id|tc
op_assign
(paren
(paren
id|lp-&gt;xtal
op_div
l_int|32
)paren
op_div
id|br
)paren
op_minus
l_int|2
suffix:semicolon
id|wrtscc
c_func
(paren
id|lp-&gt;cardbase
comma
id|cmd
comma
id|R12
comma
id|tc
op_amp
l_int|0xFF
)paren
suffix:semicolon
multiline_comment|/* lower byte */
id|wrtscc
c_func
(paren
id|lp-&gt;cardbase
comma
id|cmd
comma
id|R13
comma
(paren
id|tc
op_rshift
l_int|8
)paren
op_amp
l_int|0xFF
)paren
suffix:semicolon
multiline_comment|/* upper byte */
multiline_comment|/* SEARCH mode, BRG source */
id|wrtscc
c_func
(paren
id|lp-&gt;cardbase
comma
id|cmd
comma
id|R14
comma
id|BRSRC
op_or
id|SEARCH
)paren
suffix:semicolon
multiline_comment|/* Enable the BRG */
id|wrtscc
c_func
(paren
id|lp-&gt;cardbase
comma
id|cmd
comma
id|R14
comma
id|BRSRC
op_or
id|BRENABL
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* Flush rx fifo */
id|wrtscc
c_func
(paren
id|lp-&gt;cardbase
comma
id|cmd
comma
id|R3
comma
id|Rx8
)paren
suffix:semicolon
multiline_comment|/* Make sure rx is off */
id|wrtscc
c_func
(paren
id|lp-&gt;cardbase
comma
id|cmd
comma
id|R0
comma
id|ERR_RES
)paren
suffix:semicolon
multiline_comment|/* reset err latch */
id|dummy
op_assign
id|rdscc
c_func
(paren
id|lp-&gt;cardbase
comma
id|cmd
comma
id|R1
)paren
suffix:semicolon
multiline_comment|/* get status byte from R1 */
(paren
r_void
)paren
id|rdscc
c_func
(paren
id|lp-&gt;cardbase
comma
id|cmd
comma
id|R8
)paren
suffix:semicolon
(paren
r_void
)paren
id|rdscc
c_func
(paren
id|lp-&gt;cardbase
comma
id|cmd
comma
id|R8
)paren
suffix:semicolon
(paren
r_void
)paren
id|rdscc
c_func
(paren
id|lp-&gt;cardbase
comma
id|cmd
comma
id|R8
)paren
suffix:semicolon
multiline_comment|/* Now, turn on the receiver and hunt for a flag */
id|wrtscc
c_func
(paren
id|lp-&gt;cardbase
comma
id|cmd
comma
id|R3
comma
id|RxENABLE
op_or
id|Rx8
)paren
suffix:semicolon
id|lp-&gt;rstate
op_assign
id|ACTIVE
suffix:semicolon
multiline_comment|/* Normal state */
r_if
c_cond
(paren
id|cmd
op_amp
l_int|2
)paren
(brace
multiline_comment|/* if channel a */
id|setup_rx_dma
c_func
(paren
id|lp
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* reset buffer pointers */
id|lp-&gt;rcp
op_assign
id|lp-&gt;rcvbuf-&gt;data
suffix:semicolon
id|lp-&gt;rcvbuf-&gt;cnt
op_assign
l_int|0
suffix:semicolon
id|wrtscc
c_func
(paren
id|lp-&gt;cardbase
comma
id|cmd
comma
id|R1
comma
(paren
id|INT_ALL_Rx
op_or
id|EXT_INT_ENAB
)paren
)paren
suffix:semicolon
)brace
id|wrtscc
c_func
(paren
id|lp-&gt;cardbase
comma
id|cmd
comma
id|R15
comma
id|BRKIE
)paren
suffix:semicolon
multiline_comment|/* allow ABORT int */
)brace
)brace
DECL|function|scc_init
r_static
r_void
id|scc_init
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
r_struct
id|pi_local
op_star
id|lp
op_assign
(paren
r_struct
id|pi_local
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_int
id|tc
suffix:semicolon
r_int
id|br
suffix:semicolon
r_register
r_int
id|cmd
suffix:semicolon
multiline_comment|/* Initialize 8530 channel for SDLC operation */
id|cmd
op_assign
id|CTL
op_plus
id|lp-&gt;base
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|cmd
op_amp
id|CHANA
)paren
(brace
r_case
id|CHANA
suffix:colon
id|wrtscc
c_func
(paren
id|lp-&gt;cardbase
comma
id|cmd
comma
id|R9
comma
id|CHRA
)paren
suffix:semicolon
multiline_comment|/* Reset channel A */
id|wrtscc
c_func
(paren
id|lp-&gt;cardbase
comma
id|cmd
comma
id|R2
comma
l_int|0xff
)paren
suffix:semicolon
multiline_comment|/* Initialize interrupt vector */
r_break
suffix:semicolon
r_default
suffix:colon
id|wrtscc
c_func
(paren
id|lp-&gt;cardbase
comma
id|cmd
comma
id|R9
comma
id|CHRB
)paren
suffix:semicolon
multiline_comment|/* Reset channel B */
r_break
suffix:semicolon
)brace
multiline_comment|/* Deselect all Rx and Tx interrupts */
id|wrtscc
c_func
(paren
id|lp-&gt;cardbase
comma
id|cmd
comma
id|R1
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* Turn off external interrupts (like CTS/CD) */
id|wrtscc
c_func
(paren
id|lp-&gt;cardbase
comma
id|cmd
comma
id|R15
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* X1 clock, SDLC mode */
id|wrtscc
c_func
(paren
id|lp-&gt;cardbase
comma
id|cmd
comma
id|R4
comma
id|SDLC
op_or
id|X1CLK
)paren
suffix:semicolon
multiline_comment|/* Tx/Rx parameters */
r_if
c_cond
(paren
id|lp-&gt;speed
)paren
(brace
multiline_comment|/* Use internal clocking */
id|wrtscc
c_func
(paren
id|lp-&gt;cardbase
comma
id|cmd
comma
id|R10
comma
id|CRCPS
op_or
id|NRZI
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|lp-&gt;clockmode
)paren
multiline_comment|/* Tx Clk from BRG. Rcv Clk from DPLL, TRxC pin outputs DPLL */
id|wrtscc
c_func
(paren
id|lp-&gt;cardbase
comma
id|cmd
comma
id|R11
comma
id|TCBR
op_or
id|RCDPLL
op_or
id|TRxCDP
op_or
id|TRxCOI
)paren
suffix:semicolon
r_else
multiline_comment|/* Tx Clk from DPLL, Rcv Clk from DPLL, TRxC Outputs BRG */
id|wrtscc
c_func
(paren
id|lp-&gt;cardbase
comma
id|cmd
comma
id|R11
comma
id|TCDPLL
op_or
id|RCDPLL
op_or
id|TRxCBR
op_or
id|TRxCOI
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* Use external clocking */
id|wrtscc
c_func
(paren
id|lp-&gt;cardbase
comma
id|cmd
comma
id|R10
comma
id|CRCPS
)paren
suffix:semicolon
multiline_comment|/* Tx Clk from Trxcl. Rcv Clk from Rtxcl, TRxC pin is input */
id|wrtscc
c_func
(paren
id|lp-&gt;cardbase
comma
id|cmd
comma
id|R11
comma
id|TCTRxCP
)paren
suffix:semicolon
)brace
multiline_comment|/* Null out SDLC start address */
id|wrtscc
c_func
(paren
id|lp-&gt;cardbase
comma
id|cmd
comma
id|R6
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* SDLC flag */
id|wrtscc
c_func
(paren
id|lp-&gt;cardbase
comma
id|cmd
comma
id|R7
comma
id|FLAG
)paren
suffix:semicolon
multiline_comment|/* Set up the Transmitter but don&squot;t enable it&n;     *  DTR, 8 bit TX chars only&n;     */
id|wrtscc
c_func
(paren
id|lp-&gt;cardbase
comma
id|cmd
comma
id|R5
comma
id|Tx8
op_or
id|DTR
)paren
suffix:semicolon
multiline_comment|/* Receiver initial setup */
id|wrtscc
c_func
(paren
id|lp-&gt;cardbase
comma
id|cmd
comma
id|R3
comma
id|Rx8
)paren
suffix:semicolon
multiline_comment|/* 8 bits/char */
multiline_comment|/* Setting up BRG now - turn it off first */
id|wrtscc
c_func
(paren
id|lp-&gt;cardbase
comma
id|cmd
comma
id|R14
comma
id|BRSRC
)paren
suffix:semicolon
multiline_comment|/* BRG off, keep Pclk source */
multiline_comment|/* set the 32x time constant for the BRG in Receive mode */
r_if
c_cond
(paren
id|lp-&gt;speed
)paren
(brace
id|br
op_assign
id|lp-&gt;speed
suffix:semicolon
multiline_comment|/* get desired speed */
id|tc
op_assign
(paren
(paren
id|lp-&gt;xtal
op_div
l_int|32
)paren
op_div
id|br
)paren
op_minus
l_int|2
suffix:semicolon
multiline_comment|/* calc 32X BRG divisor */
)brace
r_else
(brace
id|tc
op_assign
l_int|14
suffix:semicolon
)brace
id|wrtscc
c_func
(paren
id|lp-&gt;cardbase
comma
id|cmd
comma
id|R12
comma
id|tc
op_amp
l_int|0xFF
)paren
suffix:semicolon
multiline_comment|/* lower byte */
id|wrtscc
c_func
(paren
id|lp-&gt;cardbase
comma
id|cmd
comma
id|R13
comma
(paren
id|tc
op_rshift
l_int|8
)paren
op_amp
l_int|0xFF
)paren
suffix:semicolon
multiline_comment|/* upper byte */
multiline_comment|/* Following subroutine sets up and ENABLES the receiver */
id|rts
c_func
(paren
id|lp
comma
id|OFF
)paren
suffix:semicolon
multiline_comment|/* TX OFF and RX ON */
r_if
c_cond
(paren
id|lp-&gt;speed
)paren
(brace
multiline_comment|/* DPLL frm BRG, BRG src PCLK */
id|wrtscc
c_func
(paren
id|lp-&gt;cardbase
comma
id|cmd
comma
id|R14
comma
id|BRSRC
op_or
id|SSBR
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* DPLL frm rtxc,BRG src PCLK */
id|wrtscc
c_func
(paren
id|lp-&gt;cardbase
comma
id|cmd
comma
id|R14
comma
id|BRSRC
op_or
id|SSRTxC
)paren
suffix:semicolon
)brace
id|wrtscc
c_func
(paren
id|lp-&gt;cardbase
comma
id|cmd
comma
id|R14
comma
id|BRSRC
op_or
id|SEARCH
)paren
suffix:semicolon
multiline_comment|/* SEARCH mode, keep BRG src */
id|wrtscc
c_func
(paren
id|lp-&gt;cardbase
comma
id|cmd
comma
id|R14
comma
id|BRSRC
op_or
id|BRENABL
)paren
suffix:semicolon
multiline_comment|/* Enable the BRG */
r_if
c_cond
(paren
op_logical_neg
(paren
id|cmd
op_amp
l_int|2
)paren
)paren
multiline_comment|/* if channel b */
id|wrtscc
c_func
(paren
id|lp-&gt;cardbase
comma
id|cmd
comma
id|R1
comma
(paren
id|INT_ALL_Rx
op_or
id|EXT_INT_ENAB
)paren
)paren
suffix:semicolon
id|wrtscc
c_func
(paren
id|lp-&gt;cardbase
comma
id|cmd
comma
id|R15
comma
id|BRKIE
)paren
suffix:semicolon
multiline_comment|/* ABORT int */
multiline_comment|/* Now, turn on the receiver and hunt for a flag */
id|wrtscc
c_func
(paren
id|lp-&gt;cardbase
comma
id|cmd
comma
id|R3
comma
id|RxENABLE
op_or
id|RxCRC_ENAB
op_or
id|Rx8
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
DECL|function|chipset_init
r_static
r_void
id|chipset_init
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
r_int
id|cardbase
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|cardbase
op_assign
id|dev-&gt;base_addr
op_amp
l_int|0x3f0
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|wrtscc
c_func
(paren
id|cardbase
comma
id|dev-&gt;base_addr
op_plus
id|CTL
comma
id|R9
comma
id|FHWRES
)paren
suffix:semicolon
multiline_comment|/* Hardware reset */
multiline_comment|/* Disable interrupts with master interrupt ctrl reg */
id|wrtscc
c_func
(paren
id|cardbase
comma
id|dev-&gt;base_addr
op_plus
id|CTL
comma
id|R9
comma
l_int|0
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
DECL|function|__initfunc
id|__initfunc
c_func
(paren
r_int
id|pi_init
c_func
(paren
r_void
)paren
)paren
(brace
r_int
op_star
id|port
suffix:semicolon
r_int
id|ioaddr
op_assign
l_int|0
suffix:semicolon
r_int
id|card_type
op_assign
l_int|0
suffix:semicolon
r_int
id|ports
(braket
)braket
op_assign
(brace
l_int|0x380
comma
l_int|0x300
comma
l_int|0x320
comma
l_int|0x340
comma
l_int|0x360
comma
l_int|0x3a0
comma
l_int|0
)brace
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;PI: V0.8 ALPHA April 23 1995 David Perry (dp@hydra.carleton.ca)&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* Only one card supported for now */
r_for
c_loop
(paren
id|port
op_assign
op_amp
id|ports
(braket
l_int|0
)braket
suffix:semicolon
op_star
id|port
op_logical_and
op_logical_neg
id|card_type
suffix:semicolon
id|port
op_increment
)paren
(brace
id|ioaddr
op_assign
op_star
id|port
suffix:semicolon
r_if
c_cond
(paren
id|check_region
c_func
(paren
id|ioaddr
comma
id|PI_TOTAL_SIZE
)paren
op_eq
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;PI: Probing for card at address %#3x&bslash;n&quot;
comma
id|ioaddr
)paren
suffix:semicolon
id|card_type
op_assign
id|hw_probe
c_func
(paren
id|ioaddr
)paren
suffix:semicolon
)brace
)brace
r_switch
c_cond
(paren
id|card_type
)paren
(brace
r_case
l_int|1
suffix:colon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;PI: Found a PI card at address %#3x&bslash;n&quot;
comma
id|ioaddr
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|2
suffix:colon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;PI: Found a PI2 card at address %#3x&bslash;n&quot;
comma
id|ioaddr
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;PI: ERROR: No card found&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
multiline_comment|/* Link a couple of device structures into the chain */
multiline_comment|/* For the A port */
multiline_comment|/* Allocate space for 4 buffers even though we only need 3,&n;       because one of them may cross a DMA page boundary and&n;       be rejected by get_dma_buffer().&n;    */
id|register_netdev
c_func
(paren
op_amp
id|pi0a
)paren
suffix:semicolon
id|pi0a.priv
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|pi_local
)paren
op_plus
(paren
id|DMA_BUFF_SIZE
op_plus
r_sizeof
(paren
r_struct
id|mbuf
)paren
)paren
op_star
l_int|4
comma
id|GFP_KERNEL
op_or
id|GFP_DMA
)paren
suffix:semicolon
id|pi0a.dma
op_assign
id|PI_DMA
suffix:semicolon
id|pi0a.base_addr
op_assign
id|ioaddr
op_plus
l_int|2
suffix:semicolon
id|pi0a.irq
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* And the B port */
id|register_netdev
c_func
(paren
op_amp
id|pi0b
)paren
suffix:semicolon
id|pi0b.base_addr
op_assign
id|ioaddr
suffix:semicolon
id|pi0b.irq
op_assign
l_int|0
suffix:semicolon
id|pi0b.priv
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|pi_local
)paren
op_plus
(paren
id|DMA_BUFF_SIZE
op_plus
r_sizeof
(paren
r_struct
id|mbuf
)paren
)paren
op_star
l_int|4
comma
id|GFP_KERNEL
op_or
id|GFP_DMA
)paren
suffix:semicolon
multiline_comment|/* Now initialize them */
id|pi_probe
c_func
(paren
op_amp
id|pi0a
comma
id|card_type
)paren
suffix:semicolon
id|pi_probe
c_func
(paren
op_amp
id|pi0b
comma
id|card_type
)paren
suffix:semicolon
id|pi0b.irq
op_assign
id|pi0a.irq
suffix:semicolon
multiline_comment|/* IRQ is shared */
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|valid_dma_page
r_static
r_int
id|valid_dma_page
c_func
(paren
r_int
r_int
id|addr
comma
r_int
r_int
id|dev_buffsize
)paren
(brace
r_if
c_cond
(paren
(paren
(paren
id|addr
op_amp
l_int|0xffff
)paren
op_plus
id|dev_buffsize
)paren
op_le
l_int|0x10000
)paren
r_return
l_int|1
suffix:semicolon
r_else
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|pi_set_mac_address
r_static
r_int
id|pi_set_mac_address
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
r_void
op_star
id|addr
)paren
(brace
r_struct
id|sockaddr
op_star
id|sa
op_assign
(paren
r_struct
id|sockaddr
op_star
)paren
id|addr
suffix:semicolon
id|memcpy
c_func
(paren
id|dev-&gt;dev_addr
comma
id|sa-&gt;sa_data
comma
id|dev-&gt;addr_len
)paren
suffix:semicolon
multiline_comment|/* addr is an AX.25 shifted ASCII */
r_return
l_int|0
suffix:semicolon
multiline_comment|/* mac address */
)brace
multiline_comment|/* Allocate a buffer which does not cross a DMA page boundary */
r_static
r_char
op_star
DECL|function|get_dma_buffer
id|get_dma_buffer
c_func
(paren
r_int
r_int
op_star
id|mem_ptr
)paren
(brace
r_char
op_star
id|ret
suffix:semicolon
id|ret
op_assign
(paren
r_char
op_star
)paren
op_star
id|mem_ptr
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|valid_dma_page
c_func
(paren
op_star
id|mem_ptr
comma
id|DMA_BUFF_SIZE
op_plus
r_sizeof
(paren
r_struct
id|mbuf
)paren
)paren
)paren
(brace
op_star
id|mem_ptr
op_add_assign
(paren
id|DMA_BUFF_SIZE
op_plus
r_sizeof
(paren
r_struct
id|mbuf
)paren
)paren
suffix:semicolon
id|ret
op_assign
(paren
r_char
op_star
)paren
op_star
id|mem_ptr
suffix:semicolon
)brace
op_star
id|mem_ptr
op_add_assign
(paren
id|DMA_BUFF_SIZE
op_plus
r_sizeof
(paren
r_struct
id|mbuf
)paren
)paren
suffix:semicolon
r_return
(paren
id|ret
)paren
suffix:semicolon
)brace
DECL|function|pi_probe
r_static
r_int
id|pi_probe
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
r_int
id|card_type
)paren
(brace
r_int
id|ioaddr
suffix:semicolon
r_struct
id|pi_local
op_star
id|lp
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_int
r_int
id|mem_ptr
suffix:semicolon
id|ioaddr
op_assign
id|dev-&gt;base_addr
suffix:semicolon
multiline_comment|/* Initialize the device structure. */
multiline_comment|/* Must be done before chipset_init */
multiline_comment|/* Make certain the data structures used by the PI2 are aligned. */
id|dev-&gt;priv
op_assign
(paren
r_void
op_star
)paren
(paren
(paren
(paren
r_int
)paren
id|dev-&gt;priv
op_plus
l_int|7
)paren
op_amp
op_complement
l_int|7
)paren
suffix:semicolon
id|lp
op_assign
(paren
r_struct
id|pi_local
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|memset
c_func
(paren
id|dev-&gt;priv
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|pi_local
)paren
)paren
suffix:semicolon
multiline_comment|/* Allocate some buffers which do not cross DMA page boundaries */
id|mem_ptr
op_assign
(paren
r_int
r_int
)paren
id|dev-&gt;priv
op_plus
r_sizeof
(paren
r_struct
id|pi_local
)paren
suffix:semicolon
id|lp-&gt;txdmabuf
op_assign
id|get_dma_buffer
c_func
(paren
op_amp
id|mem_ptr
)paren
suffix:semicolon
id|lp-&gt;rxdmabuf1
op_assign
(paren
r_struct
id|mbuf
op_star
)paren
id|get_dma_buffer
c_func
(paren
op_amp
id|mem_ptr
)paren
suffix:semicolon
id|lp-&gt;rxdmabuf2
op_assign
(paren
r_struct
id|mbuf
op_star
)paren
id|get_dma_buffer
c_func
(paren
op_amp
id|mem_ptr
)paren
suffix:semicolon
multiline_comment|/* Initialize rx buffer */
id|lp-&gt;rcvbuf
op_assign
id|lp-&gt;rxdmabuf1
suffix:semicolon
id|lp-&gt;rcp
op_assign
id|lp-&gt;rcvbuf-&gt;data
suffix:semicolon
id|lp-&gt;rcvbuf-&gt;cnt
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Initialize the transmit queue head structure */
id|skb_queue_head_init
c_func
(paren
op_amp
id|lp-&gt;sndq
)paren
suffix:semicolon
multiline_comment|/* These need to be initialized before scc_init is called. */
r_if
c_cond
(paren
id|card_type
op_eq
l_int|1
)paren
id|lp-&gt;xtal
op_assign
(paren
r_int
r_int
)paren
id|SINGLE
op_div
l_int|2
suffix:semicolon
r_else
id|lp-&gt;xtal
op_assign
(paren
r_int
r_int
)paren
id|DOUBLE
op_div
l_int|2
suffix:semicolon
id|lp-&gt;base
op_assign
id|dev-&gt;base_addr
suffix:semicolon
id|lp-&gt;cardbase
op_assign
id|dev-&gt;base_addr
op_amp
l_int|0x3f0
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;base_addr
op_amp
id|CHANA
)paren
(brace
id|lp-&gt;speed
op_assign
id|DEF_A_SPEED
suffix:semicolon
multiline_comment|/* default channel access Params */
id|lp-&gt;txdelay
op_assign
id|DEF_A_TXDELAY
suffix:semicolon
id|lp-&gt;persist
op_assign
id|DEF_A_PERSIST
suffix:semicolon
id|lp-&gt;slotime
op_assign
id|DEF_A_SLOTIME
suffix:semicolon
id|lp-&gt;squeldelay
op_assign
id|DEF_A_SQUELDELAY
suffix:semicolon
id|lp-&gt;clockmode
op_assign
id|DEF_A_CLOCKMODE
suffix:semicolon
)brace
r_else
(brace
id|lp-&gt;speed
op_assign
id|DEF_B_SPEED
suffix:semicolon
multiline_comment|/* default channel access Params */
id|lp-&gt;txdelay
op_assign
id|DEF_B_TXDELAY
suffix:semicolon
id|lp-&gt;persist
op_assign
id|DEF_B_PERSIST
suffix:semicolon
id|lp-&gt;slotime
op_assign
id|DEF_B_SLOTIME
suffix:semicolon
id|lp-&gt;squeldelay
op_assign
id|DEF_B_SQUELDELAY
suffix:semicolon
id|lp-&gt;clockmode
op_assign
id|DEF_B_CLOCKMODE
suffix:semicolon
)brace
id|lp-&gt;bufsiz
op_assign
id|DMA_BUFF_SIZE
suffix:semicolon
id|lp-&gt;tstate
op_assign
id|IDLE
suffix:semicolon
id|chipset_init
c_func
(paren
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;base_addr
op_amp
id|CHANA
)paren
(brace
multiline_comment|/* Do these things only for the A port */
multiline_comment|/* Note that a single IRQ services 2 devices (A and B channels) */
id|lp-&gt;dmachan
op_assign
id|dev-&gt;dma
suffix:semicolon
r_if
c_cond
(paren
id|lp-&gt;dmachan
template_param
l_int|3
)paren
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;PI: DMA channel %d out of range&bslash;n&quot;
comma
id|lp-&gt;dmachan
)paren
suffix:semicolon
multiline_comment|/* chipset_init() was already called */
r_if
c_cond
(paren
id|dev-&gt;irq
OL
l_int|2
)paren
(brace
id|autoirq_setup
c_func
(paren
l_int|0
)paren
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|wrtscc
c_func
(paren
id|lp-&gt;cardbase
comma
id|CTL
op_plus
id|lp-&gt;base
comma
id|R1
comma
id|EXT_INT_ENAB
)paren
suffix:semicolon
multiline_comment|/* enable PI card interrupts */
id|wrtscc
c_func
(paren
id|lp-&gt;cardbase
comma
id|CTL
op_plus
id|lp-&gt;base
comma
id|R9
comma
id|MIE
op_or
id|NV
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
multiline_comment|/* request a timer interrupt for 1 mS hence */
id|tdelay
c_func
(paren
id|lp
comma
l_int|1
)paren
suffix:semicolon
multiline_comment|/* 20 &quot;jiffies&quot; should be plenty of time... */
id|dev-&gt;irq
op_assign
id|autoirq_report
c_func
(paren
l_int|20
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dev-&gt;irq
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;PI: Failed to detect IRQ line.&bslash;n&quot;
)paren
suffix:semicolon
)brace
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|wrtscc
c_func
(paren
id|lp-&gt;cardbase
comma
id|dev-&gt;base_addr
op_plus
id|CTL
comma
id|R9
comma
id|FHWRES
)paren
suffix:semicolon
multiline_comment|/* Hardware reset */
multiline_comment|/* Disable interrupts with master interrupt ctrl reg */
id|wrtscc
c_func
(paren
id|lp-&gt;cardbase
comma
id|dev-&gt;base_addr
op_plus
id|CTL
comma
id|R9
comma
l_int|0
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;PI: Autodetected IRQ %d, assuming DMA %d.&bslash;n&quot;
comma
id|dev-&gt;irq
comma
id|dev-&gt;dma
)paren
suffix:semicolon
multiline_comment|/* This board has jumpered interrupts. Snarf the interrupt vector&n;&t;&t;   now.  There is no point in waiting since no other device can use&n;&t;&t;   the interrupt, and this marks the &squot;irqaction&squot; as busy. */
(brace
r_int
id|irqval
op_assign
id|request_irq
c_func
(paren
id|dev-&gt;irq
comma
op_amp
id|pi_interrupt
comma
l_int|0
comma
l_string|&quot;pi2&quot;
comma
l_int|NULL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|irqval
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;PI: unable to get IRQ %d (irqval=%d).&bslash;n&quot;
comma
id|dev-&gt;irq
comma
id|irqval
)paren
suffix:semicolon
r_return
id|EAGAIN
suffix:semicolon
)brace
)brace
multiline_comment|/* Grab the region */
id|request_region
c_func
(paren
id|ioaddr
op_amp
l_int|0x3f0
comma
id|PI_TOTAL_SIZE
comma
l_string|&quot;pi2&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/* Only for A port */
id|dev-&gt;open
op_assign
id|pi_open
suffix:semicolon
id|dev-&gt;stop
op_assign
id|pi_close
suffix:semicolon
id|dev-&gt;do_ioctl
op_assign
id|pi_ioctl
suffix:semicolon
id|dev-&gt;hard_start_xmit
op_assign
id|pi_send_packet
suffix:semicolon
id|dev-&gt;get_stats
op_assign
id|pi_get_stats
suffix:semicolon
multiline_comment|/* Fill in the fields of the device structure */
id|dev_init_buffers
c_func
(paren
id|dev
)paren
suffix:semicolon
macro_line|#if defined(CONFIG_AX25) || defined(CONFIG_AX25_MODULE)
id|dev-&gt;hard_header
op_assign
id|ax25_encapsulate
suffix:semicolon
id|dev-&gt;rebuild_header
op_assign
id|ax25_rebuild_header
suffix:semicolon
macro_line|#endif
id|dev-&gt;set_mac_address
op_assign
id|pi_set_mac_address
suffix:semicolon
id|dev-&gt;type
op_assign
id|ARPHRD_AX25
suffix:semicolon
multiline_comment|/* AF_AX25 device */
id|dev-&gt;hard_header_len
op_assign
l_int|73
suffix:semicolon
multiline_comment|/* We do digipeaters now */
id|dev-&gt;mtu
op_assign
l_int|1500
suffix:semicolon
multiline_comment|/* eth_mtu is the default */
id|dev-&gt;addr_len
op_assign
l_int|7
suffix:semicolon
multiline_comment|/* sizeof an ax.25 address */
id|memcpy
c_func
(paren
id|dev-&gt;broadcast
comma
id|ax25_bcast
comma
l_int|7
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|dev-&gt;dev_addr
comma
id|ax25_test
comma
l_int|7
)paren
suffix:semicolon
multiline_comment|/* New-style flags. */
id|dev-&gt;flags
op_assign
l_int|0
suffix:semicolon
id|dev-&gt;family
op_assign
id|AF_INET
suffix:semicolon
id|dev-&gt;pa_addr
op_assign
l_int|0
suffix:semicolon
id|dev-&gt;pa_brdaddr
op_assign
l_int|0
suffix:semicolon
id|dev-&gt;pa_mask
op_assign
l_int|0
suffix:semicolon
id|dev-&gt;pa_alen
op_assign
l_int|4
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Open/initialize the board.  This is called (in the current kernel)&n;   sometime after booting when the &squot;ifconfig&squot; program is run.&n;&n;   This routine should set everything up anew at each open, even&n;   registers that &quot;should&quot; only need to be set once at boot, so that&n;   there is non-reboot way to recover if something goes wrong.&n;   */
DECL|function|pi_open
r_static
r_int
id|pi_open
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
r_static
id|first_time
op_assign
l_int|1
suffix:semicolon
r_struct
id|pi_local
op_star
id|lp
op_assign
(paren
r_struct
id|pi_local
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;base_addr
op_amp
l_int|2
)paren
(brace
multiline_comment|/* if A channel */
r_if
c_cond
(paren
id|first_time
)paren
(brace
r_if
c_cond
(paren
id|request_dma
c_func
(paren
id|dev-&gt;dma
comma
l_string|&quot;pi2&quot;
)paren
)paren
(brace
id|free_irq
c_func
(paren
id|dev-&gt;irq
comma
l_int|NULL
)paren
suffix:semicolon
r_return
op_minus
id|EAGAIN
suffix:semicolon
)brace
id|irq2dev_map
(braket
id|dev-&gt;irq
)braket
op_assign
id|dev
suffix:semicolon
)brace
multiline_comment|/* Reset the hardware here. */
id|chipset_init
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
id|lp-&gt;tstate
op_assign
id|IDLE
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;base_addr
op_amp
l_int|2
)paren
(brace
multiline_comment|/* if A channel */
id|scc_init
c_func
(paren
id|dev
)paren
suffix:semicolon
multiline_comment|/* Called once for each channel */
id|scc_init
c_func
(paren
id|dev-&gt;next
)paren
suffix:semicolon
)brace
multiline_comment|/* master interrupt enable */
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|wrtscc
c_func
(paren
id|lp-&gt;cardbase
comma
id|CTL
op_plus
id|lp-&gt;base
comma
id|R9
comma
id|MIE
op_or
id|NV
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|lp-&gt;open_time
op_assign
id|jiffies
suffix:semicolon
id|dev-&gt;tbusy
op_assign
l_int|0
suffix:semicolon
id|dev-&gt;interrupt
op_assign
l_int|0
suffix:semicolon
id|dev-&gt;start
op_assign
l_int|1
suffix:semicolon
id|first_time
op_assign
l_int|0
suffix:semicolon
id|MOD_INC_USE_COUNT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|pi_send_packet
r_static
r_int
id|pi_send_packet
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|device
op_star
id|dev
)paren
(brace
r_struct
id|pi_local
op_star
id|lp
op_assign
(paren
r_struct
id|pi_local
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|hardware_send_packet
c_func
(paren
id|lp
comma
id|skb
)paren
suffix:semicolon
id|dev-&gt;trans_start
op_assign
id|jiffies
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* The typical workload of the driver:&n;   Handle the network interface interrupts. */
DECL|function|pi_interrupt
r_static
r_void
id|pi_interrupt
c_func
(paren
r_int
id|reg_ptr
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
multiline_comment|/*    int irq = -(((struct pt_regs *) reg_ptr)-&gt;orig_eax + 2);*/
r_struct
id|pi_local
op_star
id|lp
suffix:semicolon
r_int
id|st
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
multiline_comment|/*    dev_b = dev_a-&gt;next;&t; Relies on the order defined in Space.c */
macro_line|#if 0
r_if
c_cond
(paren
id|dev_a
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;PI: pi_interrupt(): irq %d for unknown device.&bslash;n&quot;
comma
id|irq
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
macro_line|#endif
multiline_comment|/* Read interrupt status register (only valid from channel A)&n;     * Process all pending interrupts in while loop&n;     */
id|lp
op_assign
(paren
r_struct
id|pi_local
op_star
)paren
id|pi0a.priv
suffix:semicolon
multiline_comment|/* Assume channel A */
r_while
c_loop
(paren
(paren
id|st
op_assign
id|rdscc
c_func
(paren
id|lp-&gt;cardbase
comma
id|pi0a.base_addr
op_or
id|CHANA
op_or
id|CTL
comma
id|R3
)paren
)paren
op_ne
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|st
op_amp
id|CHBTxIP
)paren
(brace
multiline_comment|/* Channel B Transmit Int Pending */
id|lp
op_assign
(paren
r_struct
id|pi_local
op_star
)paren
id|pi0b.priv
suffix:semicolon
id|b_txint
c_func
(paren
id|lp
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|st
op_amp
id|CHARxIP
)paren
(brace
multiline_comment|/* Channel A Rcv Interrupt Pending */
id|lp
op_assign
(paren
r_struct
id|pi_local
op_star
)paren
id|pi0a.priv
suffix:semicolon
id|a_rxint
c_func
(paren
op_amp
id|pi0a
comma
id|lp
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|st
op_amp
id|CHATxIP
)paren
(brace
multiline_comment|/* Channel A Transmit Int Pending */
id|lp
op_assign
(paren
r_struct
id|pi_local
op_star
)paren
id|pi0a.priv
suffix:semicolon
id|a_txint
c_func
(paren
id|lp
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|st
op_amp
id|CHAEXT
)paren
(brace
multiline_comment|/* Channel A External Status Int */
id|lp
op_assign
(paren
r_struct
id|pi_local
op_star
)paren
id|pi0a.priv
suffix:semicolon
id|a_exint
c_func
(paren
id|lp
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|st
op_amp
id|CHBRxIP
)paren
(brace
multiline_comment|/* Channel B Rcv Interrupt Pending */
id|lp
op_assign
(paren
r_struct
id|pi_local
op_star
)paren
id|pi0b.priv
suffix:semicolon
id|b_rxint
c_func
(paren
op_amp
id|pi0b
comma
id|lp
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|st
op_amp
id|CHBEXT
)paren
(brace
multiline_comment|/* Channel B External Status Int */
id|lp
op_assign
(paren
r_struct
id|pi_local
op_star
)paren
id|pi0b.priv
suffix:semicolon
id|b_exint
c_func
(paren
id|lp
)paren
suffix:semicolon
)brace
multiline_comment|/* Reset highest interrupt under service */
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|wrtscc
c_func
(paren
id|lp-&gt;cardbase
comma
id|lp-&gt;base
op_plus
id|CTL
comma
id|R0
comma
id|RES_H_IUS
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
multiline_comment|/* End of while loop on int processing */
r_return
suffix:semicolon
)brace
multiline_comment|/* The inverse routine to pi_open(). */
DECL|function|pi_close
r_static
r_int
id|pi_close
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
r_struct
id|pi_local
op_star
id|lp
suffix:semicolon
r_struct
id|sk_buff
op_star
id|ptr
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|lp
op_assign
(paren
r_struct
id|pi_local
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|ptr
op_assign
l_int|NULL
suffix:semicolon
id|chipset_init
c_func
(paren
id|dev
)paren
suffix:semicolon
multiline_comment|/* reset the scc */
id|disable_dma
c_func
(paren
id|lp-&gt;dmachan
)paren
suffix:semicolon
id|lp-&gt;open_time
op_assign
l_int|0
suffix:semicolon
id|dev-&gt;tbusy
op_assign
l_int|1
suffix:semicolon
id|dev-&gt;start
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Free any buffers left in the hardware transmit queue */
r_while
c_loop
(paren
(paren
id|ptr
op_assign
id|skb_dequeue
c_func
(paren
op_amp
id|lp-&gt;sndq
)paren
)paren
op_ne
l_int|NULL
)paren
id|kfree_skb
c_func
(paren
id|ptr
comma
id|FREE_WRITE
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|MOD_DEC_USE_COUNT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|pi_ioctl
r_static
r_int
id|pi_ioctl
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
r_struct
id|ifreq
op_star
id|ifr
comma
r_int
id|cmd
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
r_struct
id|pi_req
id|rq
suffix:semicolon
r_struct
id|pi_local
op_star
id|lp
op_assign
(paren
r_struct
id|pi_local
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_int
id|ret
op_assign
id|verify_area
c_func
(paren
id|VERIFY_WRITE
comma
id|ifr-&gt;ifr_data
comma
r_sizeof
(paren
r_struct
id|pi_req
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
)paren
r_return
id|ret
suffix:semicolon
r_if
c_cond
(paren
id|cmd
op_ne
id|SIOCDEVPRIVATE
)paren
(brace
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|copy_from_user
c_func
(paren
op_amp
id|rq
comma
id|ifr-&gt;ifr_data
comma
r_sizeof
(paren
r_struct
id|pi_req
)paren
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|rq.cmd
)paren
(brace
r_case
id|SIOCSPIPARAM
suffix:colon
r_if
c_cond
(paren
op_logical_neg
id|suser
c_func
(paren
)paren
)paren
r_return
op_minus
id|EPERM
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|lp-&gt;txdelay
op_assign
id|rq.txdelay
suffix:semicolon
id|lp-&gt;persist
op_assign
id|rq.persist
suffix:semicolon
id|lp-&gt;slotime
op_assign
id|rq.slotime
suffix:semicolon
id|lp-&gt;squeldelay
op_assign
id|rq.squeldelay
suffix:semicolon
id|lp-&gt;clockmode
op_assign
id|rq.clockmode
suffix:semicolon
id|lp-&gt;speed
op_assign
id|rq.speed
suffix:semicolon
id|pi_open
c_func
(paren
op_amp
id|pi0a
)paren
suffix:semicolon
multiline_comment|/* both channels get reset %%% */
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|ret
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SIOCSPIDMA
suffix:colon
r_if
c_cond
(paren
op_logical_neg
id|suser
c_func
(paren
)paren
)paren
r_return
op_minus
id|EPERM
suffix:semicolon
id|ret
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;base_addr
op_amp
l_int|2
)paren
(brace
multiline_comment|/* if A channel */
r_if
c_cond
(paren
id|rq.dmachan
template_param
l_int|3
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|pi_close
c_func
(paren
id|dev
)paren
suffix:semicolon
id|free_dma
c_func
(paren
id|lp-&gt;dmachan
)paren
suffix:semicolon
id|dev-&gt;dma
op_assign
id|lp-&gt;dmachan
op_assign
id|rq.dmachan
suffix:semicolon
r_if
c_cond
(paren
id|request_dma
c_func
(paren
id|lp-&gt;dmachan
comma
l_string|&quot;pi2&quot;
)paren
)paren
id|ret
op_assign
op_minus
id|EAGAIN
suffix:semicolon
id|pi_open
c_func
(paren
id|dev
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|SIOCSPIIRQ
suffix:colon
id|ret
op_assign
op_minus
id|EINVAL
suffix:semicolon
multiline_comment|/* add this later */
r_break
suffix:semicolon
r_case
id|SIOCGPIPARAM
suffix:colon
r_case
id|SIOCGPIDMA
suffix:colon
r_case
id|SIOCGPIIRQ
suffix:colon
id|rq.speed
op_assign
id|lp-&gt;speed
suffix:semicolon
id|rq.txdelay
op_assign
id|lp-&gt;txdelay
suffix:semicolon
id|rq.persist
op_assign
id|lp-&gt;persist
suffix:semicolon
id|rq.slotime
op_assign
id|lp-&gt;slotime
suffix:semicolon
id|rq.squeldelay
op_assign
id|lp-&gt;squeldelay
suffix:semicolon
id|rq.clockmode
op_assign
id|lp-&gt;clockmode
suffix:semicolon
id|rq.dmachan
op_assign
id|lp-&gt;dmachan
suffix:semicolon
id|rq.irq
op_assign
id|dev-&gt;irq
suffix:semicolon
id|copy_to_user
c_func
(paren
id|ifr-&gt;ifr_data
comma
op_amp
id|rq
comma
r_sizeof
(paren
r_struct
id|pi_req
)paren
)paren
suffix:semicolon
id|ret
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|ret
op_assign
op_minus
id|EINVAL
suffix:semicolon
)brace
r_return
id|ret
suffix:semicolon
)brace
multiline_comment|/* Get the current statistics.&t;This may be called with the card open or&n;   closed. */
DECL|function|pi_get_stats
r_static
r_struct
id|net_device_stats
op_star
id|pi_get_stats
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
r_struct
id|pi_local
op_star
id|lp
op_assign
(paren
r_struct
id|pi_local
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_return
op_amp
id|lp-&gt;stats
suffix:semicolon
)brace
macro_line|#ifdef MODULE
id|EXPORT_NO_SYMBOLS
suffix:semicolon
id|MODULE_AUTHOR
c_func
(paren
l_string|&quot;David Perry &lt;dp@hydra.carleton.ca&gt;&quot;
)paren
suffix:semicolon
id|MODULE_DESCRIPTION
c_func
(paren
l_string|&quot;AX.25 driver for the Ottawa PI and PI/2 HDLC cards&quot;
)paren
suffix:semicolon
DECL|function|init_module
r_int
id|init_module
c_func
(paren
r_void
)paren
(brace
r_return
id|pi_init
c_func
(paren
)paren
suffix:semicolon
)brace
DECL|function|cleanup_module
r_void
id|cleanup_module
c_func
(paren
r_void
)paren
(brace
id|free_irq
c_func
(paren
id|pi0a.irq
comma
l_int|NULL
)paren
suffix:semicolon
multiline_comment|/* IRQs and IO Ports are shared */
id|release_region
c_func
(paren
id|pi0a.base_addr
op_amp
l_int|0x3f0
comma
id|PI_TOTAL_SIZE
)paren
suffix:semicolon
id|irq2dev_map
(braket
id|pi0a.irq
)braket
op_assign
l_int|NULL
suffix:semicolon
id|kfree
c_func
(paren
id|pi0a.priv
)paren
suffix:semicolon
id|pi0a.priv
op_assign
l_int|NULL
suffix:semicolon
id|unregister_netdev
c_func
(paren
op_amp
id|pi0a
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|pi0b.priv
)paren
suffix:semicolon
id|pi0b.priv
op_assign
l_int|NULL
suffix:semicolon
id|unregister_netdev
c_func
(paren
op_amp
id|pi0b
)paren
suffix:semicolon
)brace
macro_line|#endif
eof
