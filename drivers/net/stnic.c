multiline_comment|/* stnic.c : A SH7750 specific part of driver for NS DP83902A ST-NIC.&n; *&n; * This file is subject to the terms and conditions of the GNU General Public&n; * License.  See the file &quot;COPYING&quot; in the main directory of this archive&n; * for more details.&n; *&n; * Copyright (C) 1999 kaz Kojima&n; */
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/ioport.h&gt;
macro_line|#include &lt;linux/netdevice.h&gt;
macro_line|#include &lt;linux/etherdevice.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;asm/system.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/hitachi_se.h&gt;
macro_line|#include &lt;asm/machvec.h&gt;
macro_line|#include &quot;8390.h&quot;
DECL|macro|byte
mdefine_line|#define byte&t;unsigned char
DECL|macro|half
mdefine_line|#define half&t;unsigned short
DECL|macro|word
mdefine_line|#define word&t;unsigned int
DECL|macro|vbyte
mdefine_line|#define vbyte&t;volatile unsigned char
DECL|macro|vhalf
mdefine_line|#define vhalf&t;volatile unsigned short
DECL|macro|vword
mdefine_line|#define vword&t;volatile unsigned int
DECL|macro|STNIC_RUN
mdefine_line|#define STNIC_RUN&t;0x01&t;/* 1 == Run, 0 == reset. */
DECL|macro|START_PG
mdefine_line|#define START_PG&t;0&t;/* First page of TX buffer */
DECL|macro|STOP_PG
mdefine_line|#define STOP_PG&t;&t;128&t;/* Last page +1 of RX ring */
multiline_comment|/* Alias */
DECL|macro|STNIC_CR
mdefine_line|#define STNIC_CR&t;E8390_CMD
DECL|macro|PG0_RSAR0
mdefine_line|#define PG0_RSAR0&t;EN0_RSARLO
DECL|macro|PG0_RSAR1
mdefine_line|#define PG0_RSAR1&t;EN0_RSARHI
DECL|macro|PG0_RBCR0
mdefine_line|#define PG0_RBCR0&t;EN0_RCNTLO
DECL|macro|PG0_RBCR1
mdefine_line|#define PG0_RBCR1&t;EN0_RCNTHI
DECL|macro|CR_RRD
mdefine_line|#define CR_RRD&t;&t;E8390_RREAD
DECL|macro|CR_RWR
mdefine_line|#define CR_RWR&t;&t;E8390_RWRITE
DECL|macro|CR_PG0
mdefine_line|#define CR_PG0&t;&t;E8390_PAGE0
DECL|macro|CR_STA
mdefine_line|#define CR_STA&t;&t;E8390_START
DECL|macro|CR_RDMA
mdefine_line|#define CR_RDMA&t;&t;E8390_NODMA
multiline_comment|/* FIXME! YOU MUST SET YOUR OWN ETHER ADDRESS.  */
DECL|variable|stnic_eadr
r_static
id|byte
id|stnic_eadr
(braket
l_int|6
)braket
op_assign
(brace
l_int|0x00
comma
l_int|0xc0
comma
l_int|0x6e
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x07
)brace
suffix:semicolon
DECL|variable|stnic_dev
r_static
r_struct
id|net_device
op_star
id|stnic_dev
suffix:semicolon
r_static
r_int
id|stnic_open
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_int
id|stnic_close
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_void
id|stnic_reset
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_void
id|stnic_get_hdr
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_struct
id|e8390_pkt_hdr
op_star
id|hdr
comma
r_int
id|ring_page
)paren
suffix:semicolon
r_static
r_void
id|stnic_block_input
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_int
id|count
comma
r_struct
id|sk_buff
op_star
id|skb
comma
r_int
id|ring_offset
)paren
suffix:semicolon
r_static
r_void
id|stnic_block_output
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_int
id|count
comma
r_const
r_int
r_char
op_star
id|buf
comma
r_int
id|start_page
)paren
suffix:semicolon
r_static
r_void
id|stnic_init
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
multiline_comment|/* SH7750 specific read/write io. */
r_static
r_inline
r_void
DECL|function|STNIC_DELAY
id|STNIC_DELAY
(paren
r_void
)paren
(brace
id|vword
id|trash
suffix:semicolon
id|trash
op_assign
op_star
(paren
id|vword
op_star
)paren
l_int|0xa0000000
suffix:semicolon
id|trash
op_assign
op_star
(paren
id|vword
op_star
)paren
l_int|0xa0000000
suffix:semicolon
)brace
r_static
r_inline
id|byte
DECL|function|STNIC_READ
id|STNIC_READ
(paren
r_int
id|reg
)paren
(brace
id|byte
id|val
suffix:semicolon
id|val
op_assign
(paren
op_star
(paren
id|vhalf
op_star
)paren
(paren
id|PA_83902
op_plus
(paren
(paren
id|reg
)paren
op_lshift
l_int|1
)paren
)paren
op_rshift
l_int|8
)paren
op_amp
l_int|0xff
suffix:semicolon
id|STNIC_DELAY
(paren
)paren
suffix:semicolon
r_return
id|val
suffix:semicolon
)brace
r_static
r_inline
r_void
DECL|function|STNIC_WRITE
id|STNIC_WRITE
(paren
r_int
id|reg
comma
id|byte
id|val
)paren
(brace
op_star
(paren
id|vhalf
op_star
)paren
(paren
id|PA_83902
op_plus
(paren
(paren
id|reg
)paren
op_lshift
l_int|1
)paren
)paren
op_assign
(paren
(paren
id|half
)paren
(paren
id|val
)paren
op_lshift
l_int|8
)paren
suffix:semicolon
id|STNIC_DELAY
(paren
)paren
suffix:semicolon
)brace
"&f;"
DECL|function|stnic_probe
r_int
id|__init
id|stnic_probe
c_func
(paren
r_void
)paren
(brace
r_struct
id|net_device
op_star
id|dev
suffix:semicolon
r_int
id|i
suffix:semicolon
multiline_comment|/* If we are not running on a SolutionEngine, give up now */
r_if
c_cond
(paren
op_logical_neg
id|MACH_SE
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
multiline_comment|/* New style probing API */
id|dev
op_assign
id|init_etherdev
(paren
l_int|NULL
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dev
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|SET_MODULE_OWNER
c_func
(paren
id|dev
)paren
suffix:semicolon
id|stnic_dev
op_assign
id|dev
suffix:semicolon
multiline_comment|/* Allocate dev-&gt;priv and fill in 8390 specific dev fields. */
r_if
c_cond
(paren
id|ethdev_init
(paren
id|dev
)paren
)paren
(brace
id|printk
(paren
l_string|&quot;Unable to get memory for dev-&gt;priv.&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|ETHER_ADDR_LEN
suffix:semicolon
id|i
op_increment
)paren
id|dev-&gt;dev_addr
(braket
id|i
)braket
op_assign
id|stnic_eadr
(braket
id|i
)braket
suffix:semicolon
multiline_comment|/* Set the base address to point to the NIC, not the &quot;real&quot; base! */
id|dev-&gt;base_addr
op_assign
l_int|0x1000
suffix:semicolon
id|dev-&gt;irq
op_assign
id|IRQ_STNIC
suffix:semicolon
id|dev-&gt;open
op_assign
op_amp
id|stnic_open
suffix:semicolon
id|dev-&gt;stop
op_assign
op_amp
id|stnic_close
suffix:semicolon
multiline_comment|/* Snarf the interrupt now.  There&squot;s no point in waiting since we cannot&n;     share and the board will usually be enabled. */
id|i
op_assign
id|request_irq
(paren
id|dev-&gt;irq
comma
id|ei_interrupt
comma
l_int|0
comma
id|dev-&gt;name
comma
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
)paren
(brace
id|printk
(paren
l_string|&quot; unable to get IRQ %d.&bslash;n&quot;
comma
id|dev-&gt;irq
)paren
suffix:semicolon
id|unregister_netdev
c_func
(paren
id|dev
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|dev-&gt;priv
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|dev
)paren
suffix:semicolon
r_return
id|i
suffix:semicolon
)brace
id|ei_status.name
op_assign
id|dev-&gt;name
suffix:semicolon
id|ei_status.word16
op_assign
l_int|1
suffix:semicolon
id|ei_status.tx_start_page
op_assign
id|START_PG
suffix:semicolon
id|ei_status.rx_start_page
op_assign
id|START_PG
op_plus
id|TX_PAGES
suffix:semicolon
id|ei_status.stop_page
op_assign
id|STOP_PG
suffix:semicolon
id|ei_status.reset_8390
op_assign
op_amp
id|stnic_reset
suffix:semicolon
id|ei_status.get_8390_hdr
op_assign
op_amp
id|stnic_get_hdr
suffix:semicolon
id|ei_status.block_input
op_assign
op_amp
id|stnic_block_input
suffix:semicolon
id|ei_status.block_output
op_assign
op_amp
id|stnic_block_output
suffix:semicolon
id|stnic_init
(paren
id|dev
)paren
suffix:semicolon
id|printk
(paren
id|KERN_INFO
l_string|&quot;NS ST-NIC 83902A&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_int
DECL|function|stnic_open
id|stnic_open
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
macro_line|#if 0
id|printk
(paren
l_string|&quot;stnic open&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
id|ei_open
(paren
id|dev
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_int
DECL|function|stnic_close
id|stnic_close
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
id|ei_close
(paren
id|dev
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_void
DECL|function|stnic_reset
id|stnic_reset
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
op_star
(paren
id|vhalf
op_star
)paren
id|PA_83902_RST
op_assign
l_int|0
suffix:semicolon
id|udelay
(paren
l_int|5
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ei_debug
OG
l_int|1
)paren
id|printk
c_func
(paren
l_string|&quot;8390 reset done (%ld).&bslash;n&quot;
comma
id|jiffies
)paren
suffix:semicolon
op_star
(paren
id|vhalf
op_star
)paren
id|PA_83902_RST
op_assign
op_complement
l_int|0
suffix:semicolon
id|udelay
(paren
l_int|5
)paren
suffix:semicolon
)brace
r_static
r_void
DECL|function|stnic_get_hdr
id|stnic_get_hdr
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_struct
id|e8390_pkt_hdr
op_star
id|hdr
comma
r_int
id|ring_page
)paren
(brace
id|half
id|buf
(braket
l_int|2
)braket
suffix:semicolon
id|STNIC_WRITE
(paren
id|PG0_RSAR0
comma
l_int|0
)paren
suffix:semicolon
id|STNIC_WRITE
(paren
id|PG0_RSAR1
comma
id|ring_page
)paren
suffix:semicolon
id|STNIC_WRITE
(paren
id|PG0_RBCR0
comma
l_int|4
)paren
suffix:semicolon
id|STNIC_WRITE
(paren
id|PG0_RBCR1
comma
l_int|0
)paren
suffix:semicolon
id|STNIC_WRITE
(paren
id|STNIC_CR
comma
id|CR_RRD
op_or
id|CR_PG0
op_or
id|CR_STA
)paren
suffix:semicolon
id|buf
(braket
l_int|0
)braket
op_assign
op_star
(paren
id|vhalf
op_star
)paren
id|PA_83902_IF
suffix:semicolon
id|STNIC_DELAY
(paren
)paren
suffix:semicolon
id|buf
(braket
l_int|1
)braket
op_assign
op_star
(paren
id|vhalf
op_star
)paren
id|PA_83902_IF
suffix:semicolon
id|STNIC_DELAY
(paren
)paren
suffix:semicolon
id|hdr-&gt;next
op_assign
id|buf
(braket
l_int|0
)braket
op_rshift
l_int|8
suffix:semicolon
id|hdr-&gt;status
op_assign
id|buf
(braket
l_int|0
)braket
op_amp
l_int|0xff
suffix:semicolon
macro_line|#ifdef __LITTLE_ENDIAN__
id|hdr-&gt;count
op_assign
id|buf
(braket
l_int|1
)braket
suffix:semicolon
macro_line|#else
id|hdr-&gt;count
op_assign
(paren
(paren
id|buf
(braket
l_int|1
)braket
op_rshift
l_int|8
)paren
op_amp
l_int|0xff
)paren
op_or
(paren
id|buf
(braket
l_int|1
)braket
op_lshift
l_int|8
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|ei_debug
OG
l_int|1
)paren
id|printk
(paren
l_string|&quot;ring %x status %02x next %02x count %04x.&bslash;n&quot;
comma
id|ring_page
comma
id|hdr-&gt;status
comma
id|hdr-&gt;next
comma
id|hdr-&gt;count
)paren
suffix:semicolon
id|STNIC_WRITE
(paren
id|STNIC_CR
comma
id|CR_RDMA
op_or
id|CR_PG0
op_or
id|CR_STA
)paren
suffix:semicolon
)brace
multiline_comment|/* Block input and output, similar to the Crynwr packet driver. If you are&n;   porting to a new ethercard look at the packet driver source for hints.&n;   The HP LAN doesn&squot;t use shared memory -- we put the packet&n;   out through the &quot;remote DMA&quot; dataport. */
r_static
r_void
DECL|function|stnic_block_input
id|stnic_block_input
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_int
id|length
comma
r_struct
id|sk_buff
op_star
id|skb
comma
r_int
id|offset
)paren
(brace
r_char
op_star
id|buf
op_assign
id|skb-&gt;data
suffix:semicolon
id|half
id|val
suffix:semicolon
id|STNIC_WRITE
(paren
id|PG0_RSAR0
comma
id|offset
op_amp
l_int|0xff
)paren
suffix:semicolon
id|STNIC_WRITE
(paren
id|PG0_RSAR1
comma
id|offset
op_rshift
l_int|8
)paren
suffix:semicolon
id|STNIC_WRITE
(paren
id|PG0_RBCR0
comma
id|length
op_amp
l_int|0xff
)paren
suffix:semicolon
id|STNIC_WRITE
(paren
id|PG0_RBCR1
comma
id|length
op_rshift
l_int|8
)paren
suffix:semicolon
id|STNIC_WRITE
(paren
id|STNIC_CR
comma
id|CR_RRD
op_or
id|CR_PG0
op_or
id|CR_STA
)paren
suffix:semicolon
r_if
c_cond
(paren
id|length
op_amp
l_int|1
)paren
id|length
op_increment
suffix:semicolon
r_while
c_loop
(paren
id|length
OG
l_int|0
)paren
(brace
id|val
op_assign
op_star
(paren
id|vhalf
op_star
)paren
id|PA_83902_IF
suffix:semicolon
macro_line|#ifdef __LITTLE_ENDIAN__
op_star
id|buf
op_increment
op_assign
id|val
op_amp
l_int|0xff
suffix:semicolon
op_star
id|buf
op_increment
op_assign
id|val
op_rshift
l_int|8
suffix:semicolon
macro_line|#else
op_star
id|buf
op_increment
op_assign
id|val
op_rshift
l_int|8
suffix:semicolon
op_star
id|buf
op_increment
op_assign
id|val
op_amp
l_int|0xff
suffix:semicolon
macro_line|#endif
id|STNIC_DELAY
(paren
)paren
suffix:semicolon
id|length
op_sub_assign
r_sizeof
(paren
id|half
)paren
suffix:semicolon
)brace
id|STNIC_WRITE
(paren
id|STNIC_CR
comma
id|CR_RDMA
op_or
id|CR_PG0
op_or
id|CR_STA
)paren
suffix:semicolon
)brace
r_static
r_void
DECL|function|stnic_block_output
id|stnic_block_output
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_int
id|length
comma
r_const
r_int
r_char
op_star
id|buf
comma
r_int
id|output_page
)paren
(brace
macro_line|#if 0
id|STNIC_WRITE
(paren
id|PG0_RBCR0
comma
l_int|1
)paren
suffix:semicolon
id|STNIC_WRITE
(paren
id|STNIC_CR
comma
id|CR_RRD
op_or
id|CR_PG0
op_or
id|CR_STA
)paren
suffix:semicolon
macro_line|#else  /* XXX: I don&squot;t know why but this works.  -- gniibe  */
id|STNIC_WRITE
(paren
id|PG0_RBCR0
comma
l_int|0x42
)paren
suffix:semicolon
id|STNIC_WRITE
(paren
id|PG0_RBCR1
comma
l_int|0x00
)paren
suffix:semicolon
id|STNIC_WRITE
(paren
id|PG0_RBCR0
comma
l_int|0x42
)paren
suffix:semicolon
id|STNIC_WRITE
(paren
id|PG0_RBCR1
comma
l_int|0x00
)paren
suffix:semicolon
id|STNIC_WRITE
(paren
id|STNIC_CR
comma
id|CR_RRD
op_or
id|CR_PG0
op_or
id|CR_STA
)paren
suffix:semicolon
id|STNIC_DELAY
(paren
)paren
suffix:semicolon
macro_line|#endif
id|STNIC_WRITE
(paren
id|PG0_RSAR0
comma
l_int|0
)paren
suffix:semicolon
id|STNIC_WRITE
(paren
id|PG0_RSAR1
comma
id|output_page
)paren
suffix:semicolon
id|STNIC_WRITE
(paren
id|PG0_RBCR0
comma
id|length
op_amp
l_int|0xff
)paren
suffix:semicolon
id|STNIC_WRITE
(paren
id|PG0_RBCR1
comma
id|length
op_rshift
l_int|8
)paren
suffix:semicolon
id|STNIC_WRITE
(paren
id|STNIC_CR
comma
id|CR_RWR
op_or
id|CR_PG0
op_or
id|CR_STA
)paren
suffix:semicolon
r_if
c_cond
(paren
id|length
op_amp
l_int|1
)paren
id|length
op_increment
suffix:semicolon
r_while
c_loop
(paren
id|length
OG
l_int|0
)paren
(brace
macro_line|#ifdef __LITTLE_ENDIAN__
op_star
(paren
id|vhalf
op_star
)paren
id|PA_83902_IF
op_assign
(paren
(paren
id|half
)paren
id|buf
(braket
l_int|1
)braket
op_lshift
l_int|8
)paren
op_or
id|buf
(braket
l_int|0
)braket
suffix:semicolon
macro_line|#else
op_star
(paren
id|vhalf
op_star
)paren
id|PA_83902_IF
op_assign
(paren
(paren
id|half
)paren
id|buf
(braket
l_int|0
)braket
op_lshift
l_int|8
)paren
op_or
id|buf
(braket
l_int|1
)braket
suffix:semicolon
macro_line|#endif
id|STNIC_DELAY
(paren
)paren
suffix:semicolon
id|buf
op_add_assign
r_sizeof
(paren
id|half
)paren
suffix:semicolon
id|length
op_sub_assign
r_sizeof
(paren
id|half
)paren
suffix:semicolon
)brace
id|STNIC_WRITE
(paren
id|STNIC_CR
comma
id|CR_RDMA
op_or
id|CR_PG0
op_or
id|CR_STA
)paren
suffix:semicolon
)brace
multiline_comment|/* This function resets the STNIC if something screws up.  */
r_static
r_void
DECL|function|stnic_init
id|stnic_init
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
id|stnic_reset
(paren
id|dev
)paren
suffix:semicolon
id|NS8390_init
(paren
id|dev
comma
l_int|0
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/* Hardware interrupt handler.  */
r_extern
r_void
id|ei_interrupt
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
suffix:semicolon
r_void
DECL|function|do_stnic_intr
id|do_stnic_intr
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
id|ei_interrupt
(paren
l_int|0
comma
id|stnic_dev
comma
id|regs
)paren
suffix:semicolon
)brace
DECL|variable|stnic_probe
id|module_init
c_func
(paren
id|stnic_probe
)paren
suffix:semicolon
multiline_comment|/* No cleanup routine. */
eof
