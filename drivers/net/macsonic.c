multiline_comment|/*&n; * macsonic.c&n; *&n; * (C) 1998 Alan Cox&n; *&n; * Debugging Andreas Ehliar, Michael Schmitz&n; *&n; * Based on code&n; * (C) 1996 by Thomas Bogendoerfer (tsbogend@bigbug.franken.de)&n; * &n; * This driver is based on work from Andreas Busse, but most of&n; * the code is rewritten.&n; * &n; * (C) 1995 by Andreas Busse (andy@waldorf-gmbh.de)&n; *&n; * A driver for the Mac onboard Sonic ethernet chip.&n; *&n; * 98/12/21 MSch: judged from tests on Q800, it&squot;s basically working, &n; *&t;&t;  but eating up both receive and transmit resources&n; *&t;&t;  and duplicating packets. Needs more testing.&n; *&n; * 99/01/03 MSch: upgraded to version 0.92 of the core driver, fixed.&n; */
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/ctype.h&gt;
macro_line|#include &lt;linux/fcntl.h&gt;
macro_line|#include &lt;linux/interrupt.h&gt;
macro_line|#include &lt;linux/ptrace.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/ioport.h&gt;
macro_line|#include &lt;linux/in.h&gt;
macro_line|#include &lt;linux/malloc.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;linux/nubus.h&gt;
macro_line|#include &lt;asm/bootinfo.h&gt;
macro_line|#include &lt;asm/system.h&gt;
macro_line|#include &lt;asm/bitops.h&gt;
macro_line|#include &lt;asm/pgtable.h&gt;
macro_line|#include &lt;asm/segment.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/hwtest.h&gt;
macro_line|#include &lt;asm/dma.h&gt;
macro_line|#include &lt;asm/macintosh.h&gt;
macro_line|#include &lt;asm/macints.h&gt;
macro_line|#include &lt;asm/mac_via.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/netdevice.h&gt;
macro_line|#include &lt;linux/etherdevice.h&gt;
macro_line|#include &lt;linux/skbuff.h&gt;
macro_line|#include &lt;linux/module.h&gt;
DECL|macro|SREGS_PAD
mdefine_line|#define SREGS_PAD(n)    u16 n;
macro_line|#include &quot;sonic.h&quot;
DECL|variable|sonic_debug
r_static
r_int
id|sonic_debug
op_assign
l_int|0
suffix:semicolon
DECL|variable|sonic_version_printed
r_static
r_int
id|sonic_version_printed
op_assign
l_int|0
suffix:semicolon
r_extern
r_int
id|macsonic_probe
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_extern
r_int
id|mac_onboard_sonic_probe
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_extern
r_int
id|mac_nubus_sonic_probe
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
multiline_comment|/* For onboard SONIC */
DECL|macro|ONBOARD_SONIC_REGISTERS
mdefine_line|#define ONBOARD_SONIC_REGISTERS&t;0x50F0A000
DECL|macro|ONBOARD_SONIC_PROM_BASE
mdefine_line|#define ONBOARD_SONIC_PROM_BASE&t;0x50f08000
DECL|enum|macsonic_type
r_enum
id|macsonic_type
(brace
DECL|enumerator|MACSONIC_DUODOCK
id|MACSONIC_DUODOCK
comma
DECL|enumerator|MACSONIC_APPLE
id|MACSONIC_APPLE
comma
DECL|enumerator|MACSONIC_APPLE16
id|MACSONIC_APPLE16
comma
DECL|enumerator|MACSONIC_DAYNA
id|MACSONIC_DAYNA
comma
DECL|enumerator|MACSONIC_DAYNALINK
id|MACSONIC_DAYNALINK
)brace
suffix:semicolon
multiline_comment|/* For the built-in SONIC in the Duo Dock */
DECL|macro|DUODOCK_SONIC_REGISTERS
mdefine_line|#define DUODOCK_SONIC_REGISTERS 0xe10000
DECL|macro|DUODOCK_SONIC_PROM_BASE
mdefine_line|#define DUODOCK_SONIC_PROM_BASE 0xe12000
multiline_comment|/* For Apple-style NuBus SONIC */
DECL|macro|APPLE_SONIC_REGISTERS
mdefine_line|#define APPLE_SONIC_REGISTERS&t;0
DECL|macro|APPLE_SONIC_PROM_BASE
mdefine_line|#define APPLE_SONIC_PROM_BASE&t;0x40000
multiline_comment|/* Daynalink LC SONIC */
DECL|macro|DAYNALINK_PROM_BASE
mdefine_line|#define DAYNALINK_PROM_BASE 0x400000
multiline_comment|/* For Dayna-style NuBus SONIC (haven&squot;t seen one yet) */
DECL|macro|DAYNA_SONIC_REGISTERS
mdefine_line|#define DAYNA_SONIC_REGISTERS   0x180000
multiline_comment|/* This is what OpenBSD says.  However, this is definitely in NuBus&n;   ROM space so we should be able to get it by walking the NuBus&n;   resource directories */
DECL|macro|DAYNA_SONIC_MAC_ADDR
mdefine_line|#define DAYNA_SONIC_MAC_ADDR&t;0xffe004
DECL|macro|SONIC_READ_PROM
mdefine_line|#define SONIC_READ_PROM(addr) readb(prom_addr+addr)
DECL|function|macsonic_probe
r_int
id|__init
id|macsonic_probe
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_int
id|rv
suffix:semicolon
multiline_comment|/* This will catch fatal stuff like -ENOMEM as well as success */
r_if
c_cond
(paren
(paren
id|rv
op_assign
id|mac_onboard_sonic_probe
c_func
(paren
id|dev
)paren
)paren
op_ne
op_minus
id|ENODEV
)paren
r_return
id|rv
suffix:semicolon
r_return
id|mac_nubus_sonic_probe
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * For reversing the PROM address&n; */
DECL|variable|nibbletab
r_static
r_int
r_char
id|nibbletab
(braket
)braket
op_assign
(brace
l_int|0
comma
l_int|8
comma
l_int|4
comma
l_int|12
comma
l_int|2
comma
l_int|10
comma
l_int|6
comma
l_int|14
comma
l_int|1
comma
l_int|9
comma
l_int|5
comma
l_int|13
comma
l_int|3
comma
l_int|11
comma
l_int|7
comma
l_int|15
)brace
suffix:semicolon
DECL|function|bit_reverse_addr
r_static
r_inline
r_void
id|bit_reverse_addr
c_func
(paren
r_int
r_char
id|addr
(braket
l_int|6
)braket
)paren
(brace
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|6
suffix:semicolon
id|i
op_increment
)paren
(brace
id|addr
(braket
id|i
)braket
op_assign
(paren
(paren
id|nibbletab
(braket
id|addr
(braket
id|i
)braket
op_amp
l_int|0xf
)braket
op_lshift
l_int|4
)paren
op_or
id|nibbletab
(braket
(paren
id|addr
(braket
id|i
)braket
op_rshift
l_int|4
)paren
op_amp
l_int|0xf
)braket
)paren
suffix:semicolon
)brace
)brace
DECL|function|macsonic_init
r_int
id|__init
id|macsonic_init
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|sonic_local
op_star
id|lp
op_assign
(paren
r_struct
id|sonic_local
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_int
id|i
suffix:semicolon
multiline_comment|/* Allocate the entire chunk of memory for the descriptors.&n;           Note that this cannot cross a 64K boundary. */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|20
suffix:semicolon
id|i
op_increment
)paren
(brace
r_int
r_int
id|desc_base
comma
id|desc_top
suffix:semicolon
r_if
c_cond
(paren
(paren
id|lp-&gt;sonic_desc
op_assign
id|kmalloc
c_func
(paren
id|SIZEOF_SONIC_DESC
op_star
id|SONIC_BUS_SCALE
c_func
(paren
id|lp-&gt;dma_bitmode
)paren
comma
id|GFP_DMA
)paren
)paren
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: couldn&squot;t allocate descriptor buffers&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
)brace
id|desc_base
op_assign
(paren
r_int
r_int
)paren
id|lp-&gt;sonic_desc
suffix:semicolon
id|desc_top
op_assign
id|desc_base
op_plus
id|SIZEOF_SONIC_DESC
op_star
id|SONIC_BUS_SCALE
c_func
(paren
id|lp-&gt;dma_bitmode
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|desc_top
op_amp
l_int|0xffff
)paren
op_ge
(paren
id|desc_base
op_amp
l_int|0xffff
)paren
)paren
r_break
suffix:semicolon
multiline_comment|/* Hmm. try again (FIXME: does this actually work?) */
id|kfree
c_func
(paren
id|lp-&gt;sonic_desc
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%s: didn&squot;t get continguous chunk [%08lx - %08lx], trying again&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|desc_base
comma
id|desc_top
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|lp-&gt;sonic_desc
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: tried 20 times to allocate descriptor buffers, giving up.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
multiline_comment|/* Now set up the pointers to point to the appropriate places */
id|lp-&gt;cda
op_assign
id|lp-&gt;sonic_desc
suffix:semicolon
id|lp-&gt;tda
op_assign
id|lp-&gt;cda
op_plus
(paren
id|SIZEOF_SONIC_CDA
op_star
id|SONIC_BUS_SCALE
c_func
(paren
id|lp-&gt;dma_bitmode
)paren
)paren
suffix:semicolon
id|lp-&gt;rda
op_assign
id|lp-&gt;tda
op_plus
(paren
id|SIZEOF_SONIC_TD
op_star
id|SONIC_NUM_TDS
op_star
id|SONIC_BUS_SCALE
c_func
(paren
id|lp-&gt;dma_bitmode
)paren
)paren
suffix:semicolon
id|lp-&gt;rra
op_assign
id|lp-&gt;rda
op_plus
(paren
id|SIZEOF_SONIC_RD
op_star
id|SONIC_NUM_RDS
op_star
id|SONIC_BUS_SCALE
c_func
(paren
id|lp-&gt;dma_bitmode
)paren
)paren
suffix:semicolon
multiline_comment|/* FIXME, maybe we should use skbs */
r_if
c_cond
(paren
(paren
id|lp-&gt;rba
op_assign
(paren
r_char
op_star
)paren
id|kmalloc
c_func
(paren
id|SONIC_NUM_RRS
op_star
id|SONIC_RBSIZE
comma
id|GFP_DMA
)paren
)paren
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: couldn&squot;t allocate receive buffers&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
(brace
r_int
id|rs
comma
id|ds
suffix:semicolon
multiline_comment|/* almost always 12*4096, but let&squot;s not take chances */
id|rs
op_assign
(paren
(paren
id|SONIC_NUM_RRS
op_star
id|SONIC_RBSIZE
op_plus
l_int|4095
)paren
op_div
l_int|4096
)paren
op_star
l_int|4096
suffix:semicolon
multiline_comment|/* almost always under a page, but let&squot;s not take chances */
id|ds
op_assign
(paren
(paren
id|SIZEOF_SONIC_DESC
op_plus
l_int|4095
)paren
op_div
l_int|4096
)paren
op_star
l_int|4096
suffix:semicolon
id|kernel_set_cachemode
c_func
(paren
id|lp-&gt;rba
comma
id|rs
comma
id|IOMAP_NOCACHE_SER
)paren
suffix:semicolon
id|kernel_set_cachemode
c_func
(paren
id|lp-&gt;sonic_desc
comma
id|ds
comma
id|IOMAP_NOCACHE_SER
)paren
suffix:semicolon
)brace
macro_line|#if 0
id|flush_cache_all
c_func
(paren
)paren
suffix:semicolon
macro_line|#endif
id|dev-&gt;open
op_assign
id|sonic_open
suffix:semicolon
id|dev-&gt;stop
op_assign
id|sonic_close
suffix:semicolon
id|dev-&gt;hard_start_xmit
op_assign
id|sonic_send_packet
suffix:semicolon
id|dev-&gt;get_stats
op_assign
id|sonic_get_stats
suffix:semicolon
id|dev-&gt;set_multicast_list
op_assign
op_amp
id|sonic_multicast_list
suffix:semicolon
multiline_comment|/*&n;&t; * clear tally counter&n;&t; */
id|sonic_write
c_func
(paren
id|dev
comma
id|SONIC_CRCT
comma
l_int|0xffff
)paren
suffix:semicolon
id|sonic_write
c_func
(paren
id|dev
comma
id|SONIC_FAET
comma
l_int|0xffff
)paren
suffix:semicolon
id|sonic_write
c_func
(paren
id|dev
comma
id|SONIC_MPT
comma
l_int|0xffff
)paren
suffix:semicolon
multiline_comment|/* Fill in the fields of the device structure with ethernet values. */
id|ether_setup
c_func
(paren
id|dev
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|mac_onboard_sonic_ethernet_addr
r_int
id|__init
id|mac_onboard_sonic_ethernet_addr
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_const
r_int
id|prom_addr
op_assign
id|ONBOARD_SONIC_PROM_BASE
suffix:semicolon
r_int
id|i
suffix:semicolon
multiline_comment|/* On NuBus boards we can sometimes look in the ROM resources.&n;&t;   No such luck for comm-slot/onboard. */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|6
suffix:semicolon
id|i
op_increment
)paren
(brace
id|dev-&gt;dev_addr
(braket
id|i
)braket
op_assign
id|SONIC_READ_PROM
c_func
(paren
id|i
)paren
suffix:semicolon
)brace
multiline_comment|/* Most of the time, the address is bit-reversed.  The NetBSD&n;&t;   source has a rather long and detailed historical account of&n;&t;   why this is so. */
r_if
c_cond
(paren
id|memcmp
c_func
(paren
id|dev-&gt;dev_addr
comma
l_string|&quot;&bslash;x08&bslash;x00&bslash;x07&quot;
comma
l_int|3
)paren
op_logical_and
id|memcmp
c_func
(paren
id|dev-&gt;dev_addr
comma
l_string|&quot;&bslash;x00&bslash;xA0&bslash;x40&quot;
comma
l_int|3
)paren
op_logical_and
id|memcmp
c_func
(paren
id|dev-&gt;dev_addr
comma
l_string|&quot;&bslash;x00&bslash;x05&bslash;x02&quot;
comma
l_int|3
)paren
)paren
id|bit_reverse_addr
c_func
(paren
id|dev-&gt;dev_addr
)paren
suffix:semicolon
r_else
r_return
l_int|0
suffix:semicolon
multiline_comment|/* If we still have what seems to be a bogus address, we&squot;ll&n;           look in the CAM.  The top entry should be ours. */
multiline_comment|/* Danger! This only works if MacOS has already initialized&n;           the card... */
r_if
c_cond
(paren
id|memcmp
c_func
(paren
id|dev-&gt;dev_addr
comma
l_string|&quot;&bslash;x08&bslash;x00&bslash;x07&quot;
comma
l_int|3
)paren
op_logical_and
id|memcmp
c_func
(paren
id|dev-&gt;dev_addr
comma
l_string|&quot;&bslash;x00&bslash;xA0&bslash;x40&quot;
comma
l_int|3
)paren
op_logical_and
id|memcmp
c_func
(paren
id|dev-&gt;dev_addr
comma
l_string|&quot;&bslash;x00&bslash;x05&bslash;x02&quot;
comma
l_int|3
)paren
)paren
(brace
r_int
r_int
id|val
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;macsonic: PROM seems to be wrong, trying CAM entry 15&bslash;n&quot;
)paren
suffix:semicolon
id|sonic_write
c_func
(paren
id|dev
comma
id|SONIC_CMD
comma
id|SONIC_CR_RST
)paren
suffix:semicolon
id|sonic_write
c_func
(paren
id|dev
comma
id|SONIC_CEP
comma
l_int|15
)paren
suffix:semicolon
id|val
op_assign
id|sonic_read
c_func
(paren
id|dev
comma
id|SONIC_CAP2
)paren
suffix:semicolon
id|dev-&gt;dev_addr
(braket
l_int|5
)braket
op_assign
id|val
op_rshift
l_int|8
suffix:semicolon
id|dev-&gt;dev_addr
(braket
l_int|4
)braket
op_assign
id|val
op_amp
l_int|0xff
suffix:semicolon
id|val
op_assign
id|sonic_read
c_func
(paren
id|dev
comma
id|SONIC_CAP1
)paren
suffix:semicolon
id|dev-&gt;dev_addr
(braket
l_int|3
)braket
op_assign
id|val
op_rshift
l_int|8
suffix:semicolon
id|dev-&gt;dev_addr
(braket
l_int|2
)braket
op_assign
id|val
op_amp
l_int|0xff
suffix:semicolon
id|val
op_assign
id|sonic_read
c_func
(paren
id|dev
comma
id|SONIC_CAP0
)paren
suffix:semicolon
id|dev-&gt;dev_addr
(braket
l_int|1
)braket
op_assign
id|val
op_rshift
l_int|8
suffix:semicolon
id|dev-&gt;dev_addr
(braket
l_int|0
)braket
op_assign
id|val
op_amp
l_int|0xff
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;HW Address from CAM 15: &quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|6
suffix:semicolon
id|i
op_increment
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%2.2x&quot;
comma
id|dev-&gt;dev_addr
(braket
id|i
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
OL
l_int|5
)paren
id|printk
c_func
(paren
l_string|&quot;:&quot;
)paren
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_else
r_return
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|memcmp
c_func
(paren
id|dev-&gt;dev_addr
comma
l_string|&quot;&bslash;x08&bslash;x00&bslash;x07&quot;
comma
l_int|3
)paren
op_logical_and
id|memcmp
c_func
(paren
id|dev-&gt;dev_addr
comma
l_string|&quot;&bslash;x00&bslash;xA0&bslash;x40&quot;
comma
l_int|3
)paren
op_logical_and
id|memcmp
c_func
(paren
id|dev-&gt;dev_addr
comma
l_string|&quot;&bslash;x00&bslash;x05&bslash;x02&quot;
comma
l_int|3
)paren
)paren
(brace
multiline_comment|/*&n;&t;&t; * Still nonsense ... messed up someplace!&n;&t;&t; */
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;macsonic: ERROR (INVALID MAC)&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
r_else
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|mac_onboard_sonic_probe
r_int
id|__init
id|mac_onboard_sonic_probe
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
multiline_comment|/* Bwahahaha */
r_static
r_int
id|once_is_more_than_enough
op_assign
l_int|0
suffix:semicolon
r_struct
id|sonic_local
op_star
id|lp
suffix:semicolon
r_int
id|i
suffix:semicolon
r_if
c_cond
(paren
id|once_is_more_than_enough
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
id|once_is_more_than_enough
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|MACH_IS_MAC
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;Checking for internal Macintosh ethernet (SONIC).. &quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|macintosh_config-&gt;ether_type
op_ne
id|MAC_ETHER_SONIC
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;none.&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
multiline_comment|/* Bogus probing, on the models which may or may not have&n;&t;   Ethernet (BTW, the Ethernet *is* always at the same&n;&t;   address, and nothing else lives there, at least if Apple&squot;s&n;&t;   documentation is to be believed) */
r_if
c_cond
(paren
id|macintosh_config-&gt;ident
op_eq
id|MAC_MODEL_Q630
op_logical_or
id|macintosh_config-&gt;ident
op_eq
id|MAC_MODEL_P588
op_logical_or
id|macintosh_config-&gt;ident
op_eq
id|MAC_MODEL_C610
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
r_int
id|card_present
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|card_present
op_assign
id|hwreg_present
c_func
(paren
(paren
r_void
op_star
)paren
id|ONBOARD_SONIC_REGISTERS
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|card_present
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;none.&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
)brace
id|printk
c_func
(paren
l_string|&quot;yes&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dev
)paren
(brace
id|dev
op_assign
id|init_etherdev
c_func
(paren
id|dev
comma
r_sizeof
(paren
r_struct
id|sonic_local
)paren
)paren
suffix:semicolon
multiline_comment|/* methinks this will always be true but better safe than sorry */
r_if
c_cond
(paren
id|dev-&gt;priv
op_eq
l_int|NULL
)paren
id|dev-&gt;priv
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|sonic_local
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
)brace
r_else
(brace
id|dev
op_assign
id|init_etherdev
c_func
(paren
l_int|NULL
comma
r_sizeof
(paren
r_struct
id|sonic_local
)paren
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|dev
op_eq
l_int|NULL
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|lp
op_assign
(paren
r_struct
id|sonic_local
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|memset
c_func
(paren
id|lp
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|sonic_local
)paren
)paren
suffix:semicolon
multiline_comment|/* Danger!  My arms are flailing wildly!  You *must* set this&n;           before using sonic_read() */
id|dev-&gt;base_addr
op_assign
id|ONBOARD_SONIC_REGISTERS
suffix:semicolon
r_if
c_cond
(paren
id|via_alt_mapping
)paren
id|dev-&gt;irq
op_assign
id|IRQ_AUTO_3
suffix:semicolon
r_else
id|dev-&gt;irq
op_assign
id|IRQ_NUBUS_9
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|sonic_version_printed
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s&quot;
comma
id|version
)paren
suffix:semicolon
id|sonic_version_printed
op_assign
l_int|1
suffix:semicolon
)brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: onboard / comm-slot SONIC at 0x%08lx&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|dev-&gt;base_addr
)paren
suffix:semicolon
multiline_comment|/* Now do a song and dance routine in an attempt to determine&n;           the bus width */
multiline_comment|/* The PowerBook&squot;s SONIC is 16 bit always. */
r_if
c_cond
(paren
id|macintosh_config-&gt;ident
op_eq
id|MAC_MODEL_PB520
)paren
(brace
id|lp-&gt;reg_offset
op_assign
l_int|0
suffix:semicolon
id|lp-&gt;dma_bitmode
op_assign
l_int|0
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* Some of the comm-slot cards are 16 bit.  But some&n;                   of them are not.  The 32-bit cards use offset 2 and&n;                   pad with zeroes or sometimes ones (I think...)&n;                   Therefore, if we try offset 0 and get a silicon&n;                   revision of 0, we assume 16 bit. */
r_int
id|sr
suffix:semicolon
multiline_comment|/* Technically this is not necessary since we zeroed&n;                   it above */
id|lp-&gt;reg_offset
op_assign
l_int|0
suffix:semicolon
id|lp-&gt;dma_bitmode
op_assign
l_int|0
suffix:semicolon
id|sr
op_assign
id|sonic_read
c_func
(paren
id|dev
comma
id|SONIC_SR
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sr
op_eq
l_int|0
op_logical_or
id|sr
op_eq
l_int|0xffff
)paren
(brace
id|lp-&gt;reg_offset
op_assign
l_int|2
suffix:semicolon
multiline_comment|/* 83932 is 0x0004, 83934 is 0x0100 or 0x0101 */
id|sr
op_assign
id|sonic_read
c_func
(paren
id|dev
comma
id|SONIC_SR
)paren
suffix:semicolon
id|lp-&gt;dma_bitmode
op_assign
l_int|1
suffix:semicolon
)brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: revision 0x%04x, using %d bit DMA and register offset %d&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|sr
comma
id|lp-&gt;dma_bitmode
ques
c_cond
l_int|32
suffix:colon
l_int|16
comma
id|lp-&gt;reg_offset
)paren
suffix:semicolon
)brace
multiline_comment|/* Software reset, then initialize control registers. */
id|sonic_write
c_func
(paren
id|dev
comma
id|SONIC_CMD
comma
id|SONIC_CR_RST
)paren
suffix:semicolon
id|sonic_write
c_func
(paren
id|dev
comma
id|SONIC_DCR
comma
id|SONIC_DCR_BMS
op_or
id|SONIC_DCR_RFT1
op_or
id|SONIC_DCR_TFT0
op_or
id|SONIC_DCR_EXBUS
op_or
(paren
id|lp-&gt;dma_bitmode
ques
c_cond
id|SONIC_DCR_DW
suffix:colon
l_int|0
)paren
)paren
suffix:semicolon
multiline_comment|/* This *must* be written back to in order to restore the&n;           extended programmable output bits */
id|sonic_write
c_func
(paren
id|dev
comma
id|SONIC_DCR2
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* Clear *and* disable interrupts to be on the safe side */
id|sonic_write
c_func
(paren
id|dev
comma
id|SONIC_ISR
comma
l_int|0x7fff
)paren
suffix:semicolon
id|sonic_write
c_func
(paren
id|dev
comma
id|SONIC_IMR
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* Now look for the MAC address. */
r_if
c_cond
(paren
id|mac_onboard_sonic_ethernet_addr
c_func
(paren
id|dev
)paren
op_ne
l_int|0
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;MAC &quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|6
suffix:semicolon
id|i
op_increment
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%2.2x&quot;
comma
id|dev-&gt;dev_addr
(braket
id|i
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
OL
l_int|5
)paren
id|printk
c_func
(paren
l_string|&quot;:&quot;
)paren
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot; IRQ %d&bslash;n&quot;
comma
id|dev-&gt;irq
)paren
suffix:semicolon
multiline_comment|/* Shared init code */
r_return
id|macsonic_init
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
DECL|function|mac_nubus_sonic_ethernet_addr
r_int
id|__init
id|mac_nubus_sonic_ethernet_addr
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_int
r_int
id|prom_addr
comma
r_int
id|id
)paren
(brace
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|6
suffix:semicolon
id|i
op_increment
)paren
(brace
id|dev-&gt;dev_addr
(braket
id|i
)braket
op_assign
id|SONIC_READ_PROM
c_func
(paren
id|i
)paren
suffix:semicolon
)brace
multiline_comment|/* For now we are going to assume that they&squot;re all bit-reversed */
id|bit_reverse_addr
c_func
(paren
id|dev-&gt;dev_addr
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|macsonic_ident
r_int
id|__init
id|macsonic_ident
c_func
(paren
r_struct
id|nubus_dev
op_star
id|ndev
)paren
(brace
r_if
c_cond
(paren
id|ndev-&gt;dr_hw
op_eq
id|NUBUS_DRHW_ASANTE_LC
op_logical_and
id|ndev-&gt;dr_sw
op_eq
id|NUBUS_DRSW_SONIC_LC
)paren
r_return
id|MACSONIC_DAYNALINK
suffix:semicolon
r_if
c_cond
(paren
id|ndev-&gt;dr_hw
op_eq
id|NUBUS_DRHW_SONIC
op_logical_and
id|ndev-&gt;dr_sw
op_eq
id|NUBUS_DRSW_APPLE
)paren
(brace
multiline_comment|/* There has to be a better way to do this... */
r_if
c_cond
(paren
id|strstr
c_func
(paren
id|ndev-&gt;board-&gt;name
comma
l_string|&quot;DuoDock&quot;
)paren
)paren
r_return
id|MACSONIC_DUODOCK
suffix:semicolon
r_else
r_return
id|MACSONIC_APPLE
suffix:semicolon
)brace
r_return
op_minus
l_int|1
suffix:semicolon
)brace
DECL|function|mac_nubus_sonic_probe
r_int
id|__init
id|mac_nubus_sonic_probe
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_static
r_int
id|slots
op_assign
l_int|0
suffix:semicolon
r_struct
id|nubus_dev
op_star
id|ndev
op_assign
l_int|NULL
suffix:semicolon
r_struct
id|sonic_local
op_star
id|lp
suffix:semicolon
r_int
r_int
id|base_addr
comma
id|prom_addr
suffix:semicolon
id|u16
id|sonic_dcr
suffix:semicolon
r_int
id|id
suffix:semicolon
r_int
id|i
suffix:semicolon
r_int
id|reg_offset
comma
id|dma_bitmode
suffix:semicolon
multiline_comment|/* Find the first SONIC that hasn&squot;t been initialized already */
r_while
c_loop
(paren
(paren
id|ndev
op_assign
id|nubus_find_type
c_func
(paren
id|NUBUS_CAT_NETWORK
comma
id|NUBUS_TYPE_ETHERNET
comma
id|ndev
)paren
)paren
op_ne
l_int|NULL
)paren
(brace
multiline_comment|/* Have we seen it already? */
r_if
c_cond
(paren
id|slots
op_amp
(paren
l_int|1
op_lshift
id|ndev-&gt;board-&gt;slot
)paren
)paren
r_continue
suffix:semicolon
id|slots
op_or_assign
l_int|1
op_lshift
id|ndev-&gt;board-&gt;slot
suffix:semicolon
multiline_comment|/* Is it one of ours? */
r_if
c_cond
(paren
(paren
id|id
op_assign
id|macsonic_ident
c_func
(paren
id|ndev
)paren
)paren
op_ne
op_minus
l_int|1
)paren
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ndev
op_eq
l_int|NULL
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
r_switch
c_cond
(paren
id|id
)paren
(brace
r_case
id|MACSONIC_DUODOCK
suffix:colon
id|base_addr
op_assign
id|ndev-&gt;board-&gt;slot_addr
op_plus
id|DUODOCK_SONIC_REGISTERS
suffix:semicolon
id|prom_addr
op_assign
id|ndev-&gt;board-&gt;slot_addr
op_plus
id|DUODOCK_SONIC_PROM_BASE
suffix:semicolon
id|sonic_dcr
op_assign
id|SONIC_DCR_EXBUS
op_or
id|SONIC_DCR_RFT0
op_or
id|SONIC_DCR_RFT1
op_or
id|SONIC_DCR_TFT0
suffix:semicolon
id|reg_offset
op_assign
l_int|2
suffix:semicolon
id|dma_bitmode
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MACSONIC_APPLE
suffix:colon
id|base_addr
op_assign
id|ndev-&gt;board-&gt;slot_addr
op_plus
id|APPLE_SONIC_REGISTERS
suffix:semicolon
id|prom_addr
op_assign
id|ndev-&gt;board-&gt;slot_addr
op_plus
id|APPLE_SONIC_PROM_BASE
suffix:semicolon
id|sonic_dcr
op_assign
id|SONIC_DCR_BMS
op_or
id|SONIC_DCR_RFT1
op_or
id|SONIC_DCR_TFT0
suffix:semicolon
id|reg_offset
op_assign
l_int|0
suffix:semicolon
id|dma_bitmode
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MACSONIC_APPLE16
suffix:colon
id|base_addr
op_assign
id|ndev-&gt;board-&gt;slot_addr
op_plus
id|APPLE_SONIC_REGISTERS
suffix:semicolon
id|prom_addr
op_assign
id|ndev-&gt;board-&gt;slot_addr
op_plus
id|APPLE_SONIC_PROM_BASE
suffix:semicolon
id|sonic_dcr
op_assign
id|SONIC_DCR_EXBUS
op_or
id|SONIC_DCR_RFT1
op_or
id|SONIC_DCR_TFT0
op_or
id|SONIC_DCR_PO1
op_or
id|SONIC_DCR_BMS
suffix:semicolon
id|reg_offset
op_assign
l_int|0
suffix:semicolon
id|dma_bitmode
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MACSONIC_DAYNALINK
suffix:colon
id|base_addr
op_assign
id|ndev-&gt;board-&gt;slot_addr
op_plus
id|APPLE_SONIC_REGISTERS
suffix:semicolon
id|prom_addr
op_assign
id|ndev-&gt;board-&gt;slot_addr
op_plus
id|DAYNALINK_PROM_BASE
suffix:semicolon
id|sonic_dcr
op_assign
id|SONIC_DCR_RFT1
op_or
id|SONIC_DCR_TFT0
op_or
id|SONIC_DCR_PO1
op_or
id|SONIC_DCR_BMS
suffix:semicolon
id|reg_offset
op_assign
l_int|0
suffix:semicolon
id|dma_bitmode
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MACSONIC_DAYNA
suffix:colon
id|base_addr
op_assign
id|ndev-&gt;board-&gt;slot_addr
op_plus
id|DAYNA_SONIC_REGISTERS
suffix:semicolon
id|prom_addr
op_assign
id|ndev-&gt;board-&gt;slot_addr
op_plus
id|DAYNA_SONIC_MAC_ADDR
suffix:semicolon
id|sonic_dcr
op_assign
id|SONIC_DCR_BMS
op_or
id|SONIC_DCR_RFT1
op_or
id|SONIC_DCR_TFT0
op_or
id|SONIC_DCR_PO1
suffix:semicolon
id|reg_offset
op_assign
l_int|0
suffix:semicolon
id|dma_bitmode
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;macsonic: WTF, id is %d&bslash;n&quot;
comma
id|id
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
r_if
c_cond
(paren
id|dev
)paren
(brace
id|dev
op_assign
id|init_etherdev
c_func
(paren
id|dev
comma
r_sizeof
(paren
r_struct
id|sonic_local
)paren
)paren
suffix:semicolon
multiline_comment|/* methinks this will always be true but better safe than sorry */
r_if
c_cond
(paren
id|dev-&gt;priv
op_eq
l_int|NULL
)paren
id|dev-&gt;priv
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|sonic_local
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
)brace
r_else
(brace
id|dev
op_assign
id|init_etherdev
c_func
(paren
l_int|NULL
comma
r_sizeof
(paren
r_struct
id|sonic_local
)paren
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|dev
op_eq
l_int|NULL
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|lp
op_assign
(paren
r_struct
id|sonic_local
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|memset
c_func
(paren
id|lp
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|sonic_local
)paren
)paren
suffix:semicolon
multiline_comment|/* Danger!  My arms are flailing wildly!  You *must* set this&n;           before using sonic_read() */
id|lp-&gt;reg_offset
op_assign
id|reg_offset
suffix:semicolon
id|lp-&gt;dma_bitmode
op_assign
id|dma_bitmode
suffix:semicolon
id|dev-&gt;base_addr
op_assign
id|base_addr
suffix:semicolon
id|dev-&gt;irq
op_assign
id|SLOT2IRQ
c_func
(paren
id|ndev-&gt;board-&gt;slot
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|sonic_version_printed
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s&quot;
comma
id|version
)paren
suffix:semicolon
id|sonic_version_printed
op_assign
l_int|1
suffix:semicolon
)brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: %s in slot %X&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|ndev-&gt;board-&gt;name
comma
id|ndev-&gt;board-&gt;slot
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: revision 0x%04x, using %d bit DMA and register offset %d&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|sonic_read
c_func
(paren
id|dev
comma
id|SONIC_SR
)paren
comma
id|dma_bitmode
ques
c_cond
l_int|32
suffix:colon
l_int|16
comma
id|reg_offset
)paren
suffix:semicolon
multiline_comment|/* Software reset, then initialize control registers. */
id|sonic_write
c_func
(paren
id|dev
comma
id|SONIC_CMD
comma
id|SONIC_CR_RST
)paren
suffix:semicolon
id|sonic_write
c_func
(paren
id|dev
comma
id|SONIC_DCR
comma
id|sonic_dcr
op_or
(paren
id|dma_bitmode
ques
c_cond
id|SONIC_DCR_DW
suffix:colon
l_int|0
)paren
)paren
suffix:semicolon
multiline_comment|/* Clear *and* disable interrupts to be on the safe side */
id|sonic_write
c_func
(paren
id|dev
comma
id|SONIC_ISR
comma
l_int|0x7fff
)paren
suffix:semicolon
id|sonic_write
c_func
(paren
id|dev
comma
id|SONIC_IMR
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* Now look for the MAC address. */
r_if
c_cond
(paren
id|mac_nubus_sonic_ethernet_addr
c_func
(paren
id|dev
comma
id|prom_addr
comma
id|id
)paren
op_ne
l_int|0
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;MAC &quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|6
suffix:semicolon
id|i
op_increment
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%2.2x&quot;
comma
id|dev-&gt;dev_addr
(braket
id|i
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
OL
l_int|5
)paren
id|printk
c_func
(paren
l_string|&quot;:&quot;
)paren
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot; IRQ %d&bslash;n&quot;
comma
id|dev-&gt;irq
)paren
suffix:semicolon
multiline_comment|/* Shared init code */
r_return
id|macsonic_init
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
macro_line|#ifdef MODULE
DECL|variable|namespace
r_static
r_char
r_namespace
(braket
l_int|16
)braket
op_assign
l_string|&quot;&quot;
suffix:semicolon
DECL|variable|dev_macsonic
r_static
r_struct
id|net_device
id|dev_macsonic
op_assign
(brace
l_int|NULL
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|NULL
comma
l_int|NULL
)brace
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|sonic_debug
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|EXPORT_NO_SYMBOLS
suffix:semicolon
r_int
DECL|function|init_module
id|init_module
c_func
(paren
r_void
)paren
(brace
id|dev_macsonic.name
op_assign
r_namespace
suffix:semicolon
id|dev_macsonic.init
op_assign
id|macsonic_probe
suffix:semicolon
r_if
c_cond
(paren
id|register_netdev
c_func
(paren
op_amp
id|dev_macsonic
)paren
op_ne
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;macsonic.c: No card found&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENXIO
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
r_void
DECL|function|cleanup_module
id|cleanup_module
c_func
(paren
r_void
)paren
(brace
r_if
c_cond
(paren
id|dev_macsonic.priv
op_ne
l_int|NULL
)paren
(brace
id|unregister_netdev
c_func
(paren
op_amp
id|dev_macsonic
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|dev_macsonic.priv
)paren
suffix:semicolon
id|dev_macsonic.priv
op_assign
l_int|NULL
suffix:semicolon
)brace
)brace
macro_line|#endif /* MODULE */
DECL|macro|vdma_alloc
mdefine_line|#define vdma_alloc(foo, bar) ((u32)foo)
DECL|macro|vdma_free
mdefine_line|#define vdma_free(baz)
DECL|macro|sonic_chiptomem
mdefine_line|#define sonic_chiptomem(bat) (bat)
DECL|macro|PHYSADDR
mdefine_line|#define PHYSADDR(quux) (quux)
macro_line|#include &quot;sonic.c&quot;
multiline_comment|/*&n; * Local variables:&n; *  compile-command: &quot;m68k-linux-gcc -D__KERNEL__ -I../../include -Wall -Wstrict-prototypes -O2 -fomit-frame-pointer -pipe -fno-strength-reduce -ffixed-a2 -DMODULE -DMODVERSIONS -include ../../include/linux/modversions.h   -c -o macsonic.o macsonic.c&quot;&n; *  version-control: t&n; *  kept-new-versions: 5&n; *  c-indent-level: 8&n; *  tab-width: 8&n; * End:&n; *&n; */
eof
