multiline_comment|/*&n;   ** hp100.c &n;   ** HP CASCADE Architecture Driver for 100VG-AnyLan Network Adapters&n;   **&n;   ** $Id: hp100.c,v 1.14 1997/11/16 13:57:28 alan Exp $&n;   **&n;   ** Based on the HP100 driver written by Jaroslav Kysela &lt;perex@jcu.cz&gt;&n;   ** Extended for new busmaster capable chipsets by &n;   ** Siegfried &quot;Frieder&quot; Loeffler (dg1sek) &lt;floeff@mathematik.uni-stuttgart.de&gt;&n;   **&n;   ** Maintained by: Jaroslav Kysela &lt;perex@jcu.cz&gt;&n;   ** &n;   ** This driver has only been tested with&n;   ** -- HP J2585B 10/100 Mbit/s PCI Busmaster&n;   ** -- HP J2585A 10/100 Mbit/s PCI &n;   ** -- HP J2970  10 Mbit/s PCI Combo 10base-T/BNC&n;   ** -- HP J2973  10 Mbit/s PCI 10base-T&n;   ** -- HP J2573  10/100 ISA&n;   ** -- Compex ReadyLink ENET100-VG4  10/100 Mbit/s PCI / EISA&n;   ** &n;   ** but it should also work with the other CASCADE based adapters.&n;   **&n;   ** TODO:&n;   **       -  J2573 seems to hang sometimes when in shared memory mode.&n;   **       -  Mode for Priority TX&n;   **       -  Check PCI registers, performance might be improved?&n;   **       -  To reduce interrupt load in busmaster, one could switch off&n;   **          the interrupts that are used to refill the queues whenever the&n;   **          queues are filled up to more than a certain threshold.&n;   **&n;   **&n;   ** This source/code is public free; you can distribute it and/or modify &n;   ** it under terms of the GNU General Public License (published by the&n;   ** Free Software Foundation) either version two of this License, or any &n;   ** later version.&n;   **&n; */
DECL|macro|HP100_DEFAULT_PRIORITY_TX
mdefine_line|#define HP100_DEFAULT_PRIORITY_TX 0
DECL|macro|HP100_DEBUG
macro_line|#undef HP100_DEBUG
DECL|macro|HP100_DEBUG_B
macro_line|#undef HP100_DEBUG_B&t;&t;/* Trace  */
DECL|macro|HP100_DEBUG_BM
macro_line|#undef HP100_DEBUG_BM&t;&t;/* Debug busmaster code (PDL stuff) */
DECL|macro|HP100_DEBUG_TRAINING
macro_line|#undef HP100_DEBUG_TRAINING&t;/* Debug login-to-hub procedure */
DECL|macro|HP100_DEBUG_TX
macro_line|#undef HP100_DEBUG_TX
DECL|macro|HP100_DEBUG_IRQ
macro_line|#undef HP100_DEBUG_IRQ
DECL|macro|HP100_DEBUG_RX
macro_line|#undef HP100_DEBUG_RX
macro_line|#include &lt;linux/version.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/ioport.h&gt;
macro_line|#include &lt;linux/malloc.h&gt;
macro_line|#include &lt;linux/interrupt.h&gt;
macro_line|#include &lt;linux/pci.h&gt;
macro_line|#include &lt;linux/bios32.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;asm/bitops.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;linux/netdevice.h&gt;
macro_line|#include &lt;linux/etherdevice.h&gt;
macro_line|#include &lt;linux/skbuff.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/config.h&gt;&t;/* for CONFIG_PCI */
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#if LINUX_VERSION_CODE &lt; 0x020100
DECL|macro|ioremap
mdefine_line|#define ioremap vremap
DECL|macro|iounmap
mdefine_line|#define iounmap vfree
DECL|typedef|hp100_stats_t
r_typedef
r_struct
id|enet_statistics
id|hp100_stats_t
suffix:semicolon
macro_line|#else
DECL|macro|LINUX_2_1
mdefine_line|#define LINUX_2_1
DECL|typedef|hp100_stats_t
r_typedef
r_struct
id|net_device_stats
id|hp100_stats_t
suffix:semicolon
macro_line|#endif
macro_line|#include &quot;hp100.h&quot;
multiline_comment|/*&n; *  defines&n; */
DECL|macro|HP100_BUS_ISA
mdefine_line|#define HP100_BUS_ISA     0
DECL|macro|HP100_BUS_EISA
mdefine_line|#define HP100_BUS_EISA    1
DECL|macro|HP100_BUS_PCI
mdefine_line|#define HP100_BUS_PCI     2
macro_line|#ifndef PCI_DEVICE_ID_HP_J2585B
DECL|macro|PCI_DEVICE_ID_HP_J2585B
mdefine_line|#define PCI_DEVICE_ID_HP_J2585B 0x1031
macro_line|#endif
macro_line|#ifndef PCI_VENDOR_ID_COMPEX
DECL|macro|PCI_VENDOR_ID_COMPEX
mdefine_line|#define PCI_VENDOR_ID_COMPEX 0x11f6
macro_line|#endif
macro_line|#ifndef PCI_DEVICE_ID_COMPEX_ENET100VG4
DECL|macro|PCI_DEVICE_ID_COMPEX_ENET100VG4
mdefine_line|#define PCI_DEVICE_ID_COMPEX_ENET100VG4 0x0112
macro_line|#endif
DECL|macro|HP100_REGION_SIZE
mdefine_line|#define HP100_REGION_SIZE  0x20&t;/* for ioports */
DECL|macro|HP100_MAX_PACKET_SIZE
mdefine_line|#define HP100_MAX_PACKET_SIZE  (1536+4)
DECL|macro|HP100_MIN_PACKET_SIZE
mdefine_line|#define HP100_MIN_PACKET_SIZE  60
macro_line|#ifndef HP100_DEFAULT_RX_RATIO
multiline_comment|/* default - 75% onboard memory on the card are used for RX packets */
DECL|macro|HP100_DEFAULT_RX_RATIO
mdefine_line|#define HP100_DEFAULT_RX_RATIO  75
macro_line|#endif
macro_line|#ifndef HP100_DEFAULT_PRIORITY_TX
multiline_comment|/* default - don&squot;t enable transmit outgoing packets as priority */
DECL|macro|HP100_DEFAULT_PRIORITY_TX
mdefine_line|#define HP100_DEFAULT_PRIORITY_TX 0
macro_line|#endif
multiline_comment|/*&n; *  structures&n; */
DECL|struct|hp100_eisa_id
r_struct
id|hp100_eisa_id
(brace
DECL|member|id
id|u_int
id|id
suffix:semicolon
DECL|member|name
r_const
r_char
op_star
id|name
suffix:semicolon
DECL|member|bus
id|u_char
id|bus
suffix:semicolon
)brace
suffix:semicolon
DECL|struct|hp100_private
r_struct
id|hp100_private
(brace
DECL|member|id
r_struct
id|hp100_eisa_id
op_star
id|id
suffix:semicolon
DECL|member|chip
id|u_short
id|chip
suffix:semicolon
DECL|member|soft_model
id|u_short
id|soft_model
suffix:semicolon
DECL|member|memory_size
id|u_int
id|memory_size
suffix:semicolon
DECL|member|rx_ratio
id|u_short
id|rx_ratio
suffix:semicolon
multiline_comment|/* 1 - 99 */
DECL|member|priority_tx
id|u_short
id|priority_tx
suffix:semicolon
multiline_comment|/* != 0 - priority tx */
DECL|member|mode
id|u_short
id|mode
suffix:semicolon
multiline_comment|/* PIO, Shared Mem or Busmaster */
DECL|member|bus
id|u_char
id|bus
suffix:semicolon
DECL|member|pci_bus
id|u_char
id|pci_bus
suffix:semicolon
DECL|member|pci_device_fn
id|u_char
id|pci_device_fn
suffix:semicolon
DECL|member|mem_mapped
r_int
id|mem_mapped
suffix:semicolon
multiline_comment|/* memory mapped access */
DECL|member|mem_ptr_virt
id|u_int
op_star
id|mem_ptr_virt
suffix:semicolon
multiline_comment|/* virtual memory mapped area, maybe NULL */
DECL|member|mem_ptr_phys
id|u_int
op_star
id|mem_ptr_phys
suffix:semicolon
multiline_comment|/* physical memory mapped area */
DECL|member|lan_type
r_int
id|lan_type
suffix:semicolon
multiline_comment|/* 10Mb/s, 100Mb/s or -1 (error) */
DECL|member|hub_status
r_int
id|hub_status
suffix:semicolon
multiline_comment|/* was login to hub successful? */
DECL|member|mac1_mode
id|u_char
id|mac1_mode
suffix:semicolon
DECL|member|mac2_mode
id|u_char
id|mac2_mode
suffix:semicolon
DECL|member|stats
id|hp100_stats_t
id|stats
suffix:semicolon
multiline_comment|/* Rings for busmaster mode: */
DECL|member|rxrhead
id|hp100_ring_t
op_star
id|rxrhead
suffix:semicolon
multiline_comment|/* Head (oldest) index into rxring */
DECL|member|rxrtail
id|hp100_ring_t
op_star
id|rxrtail
suffix:semicolon
multiline_comment|/* Tail (newest) index into rxring */
DECL|member|txrhead
id|hp100_ring_t
op_star
id|txrhead
suffix:semicolon
multiline_comment|/* Head (oldest) index into txring */
DECL|member|txrtail
id|hp100_ring_t
op_star
id|txrtail
suffix:semicolon
multiline_comment|/* Tail (newest) index into txring */
DECL|member|rxring
id|hp100_ring_t
id|rxring
(braket
id|MAX_RX_PDL
)braket
suffix:semicolon
DECL|member|txring
id|hp100_ring_t
id|txring
(braket
id|MAX_TX_PDL
)braket
suffix:semicolon
DECL|member|page_vaddr
id|u_int
op_star
id|page_vaddr
suffix:semicolon
multiline_comment|/* Virtual address of allocated page */
DECL|member|page_vaddr_algn
id|u_int
op_star
id|page_vaddr_algn
suffix:semicolon
multiline_comment|/* Aligned virtual address of allocated page */
DECL|member|rxrcommit
r_int
id|rxrcommit
suffix:semicolon
multiline_comment|/* # Rx PDLs commited to adapter */
DECL|member|txrcommit
r_int
id|txrcommit
suffix:semicolon
multiline_comment|/* # Tx PDLs commited to adapter */
)brace
suffix:semicolon
multiline_comment|/*&n; *  variables&n; */
DECL|variable|hp100_eisa_ids
r_static
r_struct
id|hp100_eisa_id
id|hp100_eisa_ids
(braket
)braket
op_assign
(brace
multiline_comment|/* 10/100 EISA card with revision A Cascade chip */
(brace
l_int|0x80F1F022
comma
l_string|&quot;HP J2577 rev A&quot;
comma
id|HP100_BUS_EISA
)brace
comma
multiline_comment|/* 10/100 ISA card with revision A Cascade chip */
(brace
l_int|0x50F1F022
comma
l_string|&quot;HP J2573 rev A&quot;
comma
id|HP100_BUS_ISA
)brace
comma
multiline_comment|/* 10 only EISA card with Cascade chip */
(brace
l_int|0x2019F022
comma
l_string|&quot;HP 27248B&quot;
comma
id|HP100_BUS_EISA
)brace
comma
multiline_comment|/* 10/100 EISA card with Cascade chip */
(brace
l_int|0x4019F022
comma
l_string|&quot;HP J2577&quot;
comma
id|HP100_BUS_EISA
)brace
comma
multiline_comment|/* 10/100 ISA card with Cascade chip */
(brace
l_int|0x5019F022
comma
l_string|&quot;HP J2573&quot;
comma
id|HP100_BUS_ISA
)brace
comma
multiline_comment|/* 10/100 PCI card - old J2585A */
(brace
l_int|0x1030103c
comma
l_string|&quot;HP J2585A&quot;
comma
id|HP100_BUS_PCI
)brace
comma
multiline_comment|/* 10/100 PCI card - new J2585B - master capable */
(brace
l_int|0x1041103c
comma
l_string|&quot;HP J2585B&quot;
comma
id|HP100_BUS_PCI
)brace
comma
multiline_comment|/* 10 Mbit Combo Adapter */
(brace
l_int|0x1042103c
comma
l_string|&quot;HP J2970&quot;
comma
id|HP100_BUS_PCI
)brace
comma
multiline_comment|/* 10 Mbit 10baseT Adapter */
(brace
l_int|0x1040103c
comma
l_string|&quot;HP J2973&quot;
comma
id|HP100_BUS_PCI
)brace
comma
multiline_comment|/* 10/100 EISA card from Compex */
(brace
l_int|0x0103180e
comma
l_string|&quot;ReadyLink ENET100-VG4&quot;
comma
id|HP100_BUS_EISA
)brace
comma
multiline_comment|/* 10/100 PCI card from Compex (J2585A compatible) */
(brace
l_int|0x011211f6
comma
l_string|&quot;ReadyLink ENET100-VG4&quot;
comma
id|HP100_BUS_PCI
)brace
)brace
suffix:semicolon
DECL|variable|hp100_rx_ratio
r_static
r_int
id|hp100_rx_ratio
op_assign
id|HP100_DEFAULT_RX_RATIO
suffix:semicolon
DECL|variable|hp100_priority_tx
r_static
r_int
id|hp100_priority_tx
op_assign
id|HP100_DEFAULT_PRIORITY_TX
suffix:semicolon
DECL|variable|hp100_mode
r_static
r_int
id|hp100_mode
op_assign
l_int|1
suffix:semicolon
macro_line|#ifdef LINUX_2_1
id|MODULE_PARM
c_func
(paren
id|hp100_rx_ratio
comma
l_string|&quot;1i&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|hp100_priority_tx
comma
l_string|&quot;1i&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|hp100_mode
comma
l_string|&quot;1i&quot;
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/*&n; *  prototypes&n; */
r_static
r_int
id|hp100_probe1
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
r_int
id|ioaddr
comma
id|u_char
id|bus
comma
id|u_char
id|pci_bus
comma
id|u_char
id|pci_device_fn
)paren
suffix:semicolon
r_static
r_int
id|hp100_open
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_int
id|hp100_close
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_int
id|hp100_start_xmit
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_int
id|hp100_start_xmit_bm
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_void
id|hp100_rx
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
suffix:semicolon
r_static
id|hp100_stats_t
op_star
id|hp100_get_stats
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_void
id|hp100_update_stats
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_void
id|hp100_clear_stats
c_func
(paren
r_int
id|ioaddr
)paren
suffix:semicolon
r_static
r_void
id|hp100_set_multicast_list
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_void
id|hp100_interrupt
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
suffix:semicolon
r_static
r_void
id|hp100_start_interface
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_void
id|hp100_stop_interface
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_void
id|hp100_load_eeprom
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_int
id|hp100_sense_lan
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_int
id|hp100_login_to_vg_hub
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
id|u_short
id|force_relogin
)paren
suffix:semicolon
r_static
r_int
id|hp100_down_vg_link
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_void
id|hp100_cascade_reset
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
id|u_short
id|enable
)paren
suffix:semicolon
r_static
r_void
id|hp100_BM_shutdown
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_void
id|hp100_mmuinit
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_void
id|hp100_init_pdls
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_int
id|hp100_init_rxpdl
c_func
(paren
r_register
id|hp100_ring_t
op_star
id|ringptr
comma
r_register
id|u_int
op_star
id|pdlptr
)paren
suffix:semicolon
r_static
r_int
id|hp100_init_txpdl
c_func
(paren
r_register
id|hp100_ring_t
op_star
id|ringptr
comma
r_register
id|u_int
op_star
id|pdlptr
)paren
suffix:semicolon
r_static
r_void
id|hp100_rxfill
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_void
id|hp100_hwinit
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_void
id|hp100_clean_txring
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
suffix:semicolon
macro_line|#ifdef HP100_DEBUG
r_static
r_void
id|hp100_RegisterDump
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/* TODO: This function should not really be needed in a good design... */
DECL|function|wait
r_static
r_void
id|wait
c_func
(paren
r_void
)paren
(brace
id|udelay
c_func
(paren
l_int|1000
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; *  probe functions&n; *  These functions should - if possible - avoid doing write operations&n; *  since this could cause problems when the card is not installed.&n; */
DECL|function|__initfunc
id|__initfunc
c_func
(paren
r_int
id|hp100_probe
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
)paren
(brace
r_int
id|base_addr
op_assign
id|dev
ques
c_cond
id|dev-&gt;base_addr
suffix:colon
l_int|0
suffix:semicolon
r_int
id|ioaddr
op_assign
l_int|0
suffix:semicolon
macro_line|#ifdef CONFIG_PCI
r_int
id|pci_start_index
op_assign
l_int|0
suffix:semicolon
macro_line|#endif
macro_line|#ifdef HP100_DEBUG_B
id|hp100_outw
c_func
(paren
l_int|0x4200
comma
id|TRACE
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;hp100: probe&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|base_addr
OG
l_int|0xff
)paren
(brace
multiline_comment|/* Check a single specified location. */
r_if
c_cond
(paren
id|check_region
c_func
(paren
id|base_addr
comma
id|HP100_REGION_SIZE
)paren
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|base_addr
OL
l_int|0x400
)paren
r_return
id|hp100_probe1
c_func
(paren
id|dev
comma
id|base_addr
comma
id|HP100_BUS_ISA
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
r_else
r_return
id|hp100_probe1
c_func
(paren
id|dev
comma
id|base_addr
comma
id|HP100_BUS_EISA
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
)brace
r_else
macro_line|#ifdef CONFIG_PCI
r_if
c_cond
(paren
id|base_addr
OG
l_int|0
op_logical_and
id|base_addr
OL
l_int|8
op_plus
l_int|1
)paren
id|pci_start_index
op_assign
l_int|0x100
op_or
(paren
id|base_addr
op_minus
l_int|1
)paren
suffix:semicolon
r_else
macro_line|#endif
r_if
c_cond
(paren
id|base_addr
op_ne
l_int|0
)paren
r_return
op_minus
id|ENXIO
suffix:semicolon
multiline_comment|/* at first - scan PCI bus(es) */
macro_line|#ifdef CONFIG_PCI
r_if
c_cond
(paren
id|pcibios_present
c_func
(paren
)paren
)paren
(brace
r_int
id|pci_index
suffix:semicolon
macro_line|#ifdef HP100_DEBUG_PCI
id|printk
c_func
(paren
l_string|&quot;hp100: PCI BIOS is present, checking for devices..&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
r_for
c_loop
(paren
id|pci_index
op_assign
id|pci_start_index
op_amp
l_int|7
suffix:semicolon
id|pci_index
OL
l_int|8
suffix:semicolon
id|pci_index
op_increment
)paren
(brace
id|u_char
id|pci_bus
comma
id|pci_device_fn
suffix:semicolon
id|u_short
id|pci_command
suffix:semicolon
r_if
c_cond
(paren
(paren
id|pcibios_find_device
c_func
(paren
id|PCI_VENDOR_ID_HP
comma
id|PCI_DEVICE_ID_HP_J2585A
comma
id|pci_index
comma
op_amp
id|pci_bus
comma
op_amp
id|pci_device_fn
)paren
op_ne
l_int|0
)paren
op_logical_and
(paren
id|pcibios_find_device
c_func
(paren
id|PCI_VENDOR_ID_HP
comma
id|PCI_DEVICE_ID_HP_J2585B
comma
id|pci_index
comma
op_amp
id|pci_bus
comma
op_amp
id|pci_device_fn
)paren
op_ne
l_int|0
)paren
op_logical_and
(paren
id|pcibios_find_device
c_func
(paren
id|PCI_VENDOR_ID_COMPEX
comma
id|PCI_DEVICE_ID_COMPEX_ENET100VG4
comma
id|pci_index
comma
op_amp
id|pci_bus
comma
op_amp
id|pci_device_fn
)paren
op_ne
l_int|0
)paren
)paren
r_break
suffix:semicolon
id|pcibios_read_config_dword
c_func
(paren
id|pci_bus
comma
id|pci_device_fn
comma
id|PCI_BASE_ADDRESS_0
comma
op_amp
id|ioaddr
)paren
suffix:semicolon
id|ioaddr
op_and_assign
op_complement
l_int|3
suffix:semicolon
multiline_comment|/* remove I/O space marker in bit 0. */
r_if
c_cond
(paren
id|check_region
c_func
(paren
id|ioaddr
comma
id|HP100_REGION_SIZE
)paren
)paren
r_continue
suffix:semicolon
id|pcibios_read_config_word
c_func
(paren
id|pci_bus
comma
id|pci_device_fn
comma
id|PCI_COMMAND
comma
op_amp
id|pci_command
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|pci_command
op_amp
id|PCI_COMMAND_MASTER
)paren
)paren
(brace
macro_line|#ifdef HP100_DEBUG
id|printk
c_func
(paren
l_string|&quot;hp100: PCI Master Bit has not been set. Setting...&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
id|pci_command
op_or_assign
id|PCI_COMMAND_MASTER
suffix:semicolon
id|pcibios_write_config_word
c_func
(paren
id|pci_bus
comma
id|pci_device_fn
comma
id|PCI_COMMAND
comma
id|pci_command
)paren
suffix:semicolon
)brace
macro_line|#ifdef HP100_DEBUG
id|printk
c_func
(paren
l_string|&quot;hp100: PCI adapter found at 0x%x&bslash;n&quot;
comma
id|ioaddr
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|hp100_probe1
c_func
(paren
id|dev
comma
id|ioaddr
comma
id|HP100_BUS_PCI
comma
id|pci_bus
comma
id|pci_device_fn
)paren
op_eq
l_int|0
)paren
r_return
l_int|0
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|pci_start_index
OG
l_int|0
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
macro_line|#endif&t;&t;&t;&t;/* CONFIG_PCI */
multiline_comment|/* Second: Probe all EISA possible port regions (if EISA bus present) */
r_for
c_loop
(paren
id|ioaddr
op_assign
l_int|0x1c38
suffix:semicolon
id|EISA_bus
op_logical_and
id|ioaddr
OL
l_int|0x10000
suffix:semicolon
id|ioaddr
op_add_assign
l_int|0x400
)paren
(brace
r_if
c_cond
(paren
id|check_region
c_func
(paren
id|ioaddr
comma
id|HP100_REGION_SIZE
)paren
)paren
r_continue
suffix:semicolon
r_if
c_cond
(paren
id|hp100_probe1
c_func
(paren
id|dev
comma
id|ioaddr
comma
id|HP100_BUS_EISA
comma
l_int|0
comma
l_int|0
)paren
op_eq
l_int|0
)paren
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Third Probe all ISA possible port regions */
r_for
c_loop
(paren
id|ioaddr
op_assign
l_int|0x100
suffix:semicolon
id|ioaddr
OL
l_int|0x400
suffix:semicolon
id|ioaddr
op_add_assign
l_int|0x20
)paren
(brace
r_if
c_cond
(paren
id|check_region
c_func
(paren
id|ioaddr
comma
id|HP100_REGION_SIZE
)paren
)paren
r_continue
suffix:semicolon
r_if
c_cond
(paren
id|hp100_probe1
c_func
(paren
id|dev
comma
id|ioaddr
comma
id|HP100_BUS_ISA
comma
l_int|0
comma
l_int|0
)paren
op_eq
l_int|0
)paren
r_return
l_int|0
suffix:semicolon
)brace
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
"&f;"
DECL|function|__initfunc
id|__initfunc
c_func
(paren
r_static
r_int
id|hp100_probe1
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
r_int
id|ioaddr
comma
id|u_char
id|bus
comma
id|u_char
id|pci_bus
comma
id|u_char
id|pci_device_fn
)paren
)paren
(brace
r_int
id|i
suffix:semicolon
id|u_char
id|uc
comma
id|uc_1
suffix:semicolon
id|u_int
id|eisa_id
suffix:semicolon
id|u_int
id|chip
suffix:semicolon
id|u_int
id|memory_size
op_assign
l_int|0
suffix:semicolon
r_int
id|mem_mapped
suffix:semicolon
id|u_int
op_star
id|mem_ptr_phys
comma
op_star
id|mem_ptr_virt
suffix:semicolon
r_struct
id|hp100_private
op_star
id|lp
suffix:semicolon
r_struct
id|hp100_eisa_id
op_star
id|eid
suffix:semicolon
macro_line|#ifdef HP100_DEBUG_B
id|hp100_outw
c_func
(paren
l_int|0x4201
comma
id|TRACE
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;hp100: probe1&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|dev
op_eq
l_int|NULL
)paren
(brace
macro_line|#ifdef HP100_DEBUG
id|printk
c_func
(paren
l_string|&quot;hp100_probe1: dev == NULL ?&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
r_return
id|EIO
suffix:semicolon
)brace
r_if
c_cond
(paren
id|hp100_inw
c_func
(paren
id|HW_ID
)paren
op_ne
id|HP100_HW_ID_CASCADE
)paren
(brace
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
r_else
(brace
id|chip
op_assign
id|hp100_inw
c_func
(paren
id|PAGING
)paren
op_amp
id|HP100_CHIPID_MASK
suffix:semicolon
macro_line|#ifdef HP100_DEBUG
r_if
c_cond
(paren
id|chip
op_eq
id|HP100_CHIPID_SHASTA
)paren
id|printk
c_func
(paren
l_string|&quot;hp100: Shasta Chip detected. (This is a pre 802.12 chip)&bslash;n&quot;
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
id|chip
op_eq
id|HP100_CHIPID_RAINIER
)paren
id|printk
c_func
(paren
l_string|&quot;hp100: Rainier Chip detected. (This is a pre 802.12 chip)&bslash;n&quot;
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
id|chip
op_eq
id|HP100_CHIPID_LASSEN
)paren
id|printk
c_func
(paren
l_string|&quot;hp100: Lassen Chip detected.&bslash;n&quot;
)paren
suffix:semicolon
r_else
id|printk
c_func
(paren
l_string|&quot;hp100: Warning: Unknown CASCADE chip (id=0x%.4x).&bslash;n&quot;
comma
id|chip
)paren
suffix:semicolon
macro_line|#endif
)brace
id|dev-&gt;base_addr
op_assign
id|ioaddr
suffix:semicolon
id|hp100_page
c_func
(paren
id|ID_MAC_ADDR
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
id|uc
op_assign
id|eisa_id
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|4
suffix:semicolon
id|i
op_increment
)paren
(brace
id|eisa_id
op_rshift_assign
l_int|8
suffix:semicolon
id|uc_1
op_assign
id|hp100_inb
c_func
(paren
id|BOARD_ID
op_plus
id|i
)paren
suffix:semicolon
id|eisa_id
op_or_assign
id|uc_1
op_lshift
l_int|24
suffix:semicolon
id|uc
op_add_assign
id|uc_1
suffix:semicolon
)brace
id|uc
op_add_assign
id|hp100_inb
c_func
(paren
id|BOARD_ID
op_plus
l_int|4
)paren
suffix:semicolon
r_if
c_cond
(paren
id|uc
op_ne
l_int|0xff
)paren
(brace
multiline_comment|/* bad checksum? */
id|printk
c_func
(paren
l_string|&quot;hp100_probe: bad EISA ID checksum at base port 0x%x&bslash;n&quot;
comma
id|ioaddr
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
r_sizeof
(paren
id|hp100_eisa_ids
)paren
op_div
r_sizeof
(paren
r_struct
id|hp100_eisa_id
)paren
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
(paren
id|hp100_eisa_ids
(braket
id|i
)braket
dot
id|id
op_amp
l_int|0xf0ffffff
)paren
op_eq
(paren
id|eisa_id
op_amp
l_int|0xf0ffffff
)paren
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
id|i
op_ge
r_sizeof
(paren
id|hp100_eisa_ids
)paren
op_div
r_sizeof
(paren
r_struct
id|hp100_eisa_id
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;hp100_probe1: card at port 0x%x isn&squot;t known (id = 0x%x)&bslash;n&quot;
comma
id|ioaddr
comma
id|eisa_id
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
id|eid
op_assign
op_amp
id|hp100_eisa_ids
(braket
id|i
)braket
suffix:semicolon
r_if
c_cond
(paren
(paren
id|eid-&gt;id
op_amp
l_int|0x0f000000
)paren
OL
(paren
id|eisa_id
op_amp
l_int|0x0f000000
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;hp100_probe1: newer version of card %s at port 0x%x - unsupported&bslash;n&quot;
comma
id|eid-&gt;name
comma
id|ioaddr
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
id|uc
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|7
suffix:semicolon
id|i
op_increment
)paren
id|uc
op_add_assign
id|hp100_inb
c_func
(paren
id|LAN_ADDR
op_plus
id|i
)paren
suffix:semicolon
r_if
c_cond
(paren
id|uc
op_ne
l_int|0xff
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;hp100_probe1: bad lan address checksum (card %s at port 0x%x)&bslash;n&quot;
comma
id|eid-&gt;name
comma
id|ioaddr
)paren
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
multiline_comment|/* Determine driver operation mode&n;&n;&t; * Use the variable &quot;hp100_mode&quot; upon insmod or as kernel parameter to&n;&t; * force driver modes:&n;&t; * hp100_mode=1 -&gt; default, use busmaster mode if configured.&n;&t; * hp100_mode=2 -&gt; enable shared memory mode &n;&t; * hp100_mode=3 -&gt; force use of i/o mapped mode.&n;&t; * hp100_mode=4 -&gt; same as 1, but re-set the enable bit on the card.&n;&t; */
r_if
c_cond
(paren
id|hp100_mode
op_eq
l_int|3
)paren
(brace
id|hp100_outw
c_func
(paren
id|HP100_MEM_EN
op_or
id|HP100_RESET_LB
comma
id|OPTION_LSW
)paren
suffix:semicolon
id|hp100_outw
c_func
(paren
id|HP100_IO_EN
op_or
id|HP100_SET_LB
comma
id|OPTION_LSW
)paren
suffix:semicolon
id|hp100_outw
c_func
(paren
id|HP100_BM_WRITE
op_or
id|HP100_BM_READ
op_or
id|HP100_RESET_HB
comma
id|OPTION_LSW
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;hp100: IO mapped mode forced.&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|hp100_mode
op_eq
l_int|2
)paren
(brace
id|hp100_outw
c_func
(paren
id|HP100_MEM_EN
op_or
id|HP100_SET_LB
comma
id|OPTION_LSW
)paren
suffix:semicolon
id|hp100_outw
c_func
(paren
id|HP100_IO_EN
op_or
id|HP100_SET_LB
comma
id|OPTION_LSW
)paren
suffix:semicolon
id|hp100_outw
c_func
(paren
id|HP100_BM_WRITE
op_or
id|HP100_BM_READ
op_or
id|HP100_RESET_HB
comma
id|OPTION_LSW
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;hp100: Shared memory mode requested.&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|hp100_mode
op_eq
l_int|4
)paren
(brace
r_if
c_cond
(paren
id|chip
op_eq
id|HP100_CHIPID_LASSEN
)paren
(brace
id|hp100_outw
c_func
(paren
id|HP100_BM_WRITE
op_or
id|HP100_BM_READ
op_or
id|HP100_SET_HB
comma
id|OPTION_LSW
)paren
suffix:semicolon
id|hp100_outw
c_func
(paren
id|HP100_IO_EN
op_or
id|HP100_MEM_EN
op_or
id|HP100_RESET_LB
comma
id|OPTION_LSW
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;hp100: Busmaster mode requested.&bslash;n&quot;
)paren
suffix:semicolon
)brace
id|hp100_mode
op_assign
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|hp100_mode
op_eq
l_int|1
)paren
(brace
multiline_comment|/* default behaviour */
r_if
c_cond
(paren
(paren
id|hp100_inw
c_func
(paren
id|OPTION_LSW
)paren
op_amp
id|HP100_IO_EN
)paren
op_logical_and
(paren
op_complement
id|hp100_inw
c_func
(paren
id|OPTION_LSW
)paren
op_amp
id|HP100_MEM_EN
)paren
op_logical_and
(paren
op_complement
id|hp100_inw
c_func
(paren
id|OPTION_LSW
)paren
op_amp
(paren
id|HP100_BM_WRITE
op_or
id|HP100_BM_READ
)paren
)paren
)paren
(brace
macro_line|#ifdef HP100_DEBUG
id|printk
c_func
(paren
l_string|&quot;hp100: IO_EN bit is set on card.&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
id|hp100_mode
op_assign
l_int|3
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
(paren
id|chip
op_eq
id|HP100_CHIPID_LASSEN
)paren
op_logical_and
(paren
(paren
id|hp100_inw
c_func
(paren
id|OPTION_LSW
)paren
op_amp
(paren
id|HP100_BM_WRITE
op_or
id|HP100_BM_READ
)paren
)paren
op_eq
(paren
id|HP100_BM_WRITE
op_or
id|HP100_BM_READ
)paren
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;hp100: Busmaster mode enabled.&bslash;n&quot;
)paren
suffix:semicolon
id|hp100_outw
c_func
(paren
id|HP100_MEM_EN
op_or
id|HP100_IO_EN
op_or
id|HP100_RESET_LB
comma
id|OPTION_LSW
)paren
suffix:semicolon
)brace
r_else
(brace
macro_line|#ifdef HP100_DEBUG
id|printk
c_func
(paren
l_string|&quot;hp100: Card not configured for BM or BM not supported with this card. Trying shared memory mode.&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/* In this case, try shared memory mode */
id|hp100_mode
op_assign
l_int|2
suffix:semicolon
id|hp100_outw
c_func
(paren
id|HP100_MEM_EN
op_or
id|HP100_SET_LB
comma
id|OPTION_LSW
)paren
suffix:semicolon
multiline_comment|/* hp100_outw(HP100_IO_EN|HP100_RESET_LB, OPTION_LSW); */
)brace
)brace
multiline_comment|/* Check for shared memory on the card, eventually remap it */
id|hp100_page
c_func
(paren
id|HW_MAP
)paren
suffix:semicolon
id|mem_mapped
op_assign
(paren
(paren
id|hp100_inw
c_func
(paren
id|OPTION_LSW
)paren
op_amp
(paren
id|HP100_MEM_EN
)paren
)paren
op_ne
l_int|0
)paren
suffix:semicolon
id|mem_ptr_phys
op_assign
id|mem_ptr_virt
op_assign
l_int|NULL
suffix:semicolon
id|memory_size
op_assign
(paren
l_int|8192
op_lshift
(paren
(paren
id|hp100_inb
c_func
(paren
id|SRAM
)paren
op_rshift
l_int|5
)paren
op_amp
l_int|0x07
)paren
)paren
suffix:semicolon
multiline_comment|/* For memory mapped or busmaster mode, we want the memory address */
r_if
c_cond
(paren
id|mem_mapped
op_logical_or
(paren
id|hp100_mode
op_eq
l_int|1
)paren
)paren
(brace
id|mem_ptr_phys
op_assign
(paren
id|u_int
op_star
)paren
(paren
id|hp100_inw
c_func
(paren
id|MEM_MAP_LSW
)paren
op_or
(paren
id|hp100_inw
c_func
(paren
id|MEM_MAP_MSW
)paren
op_lshift
l_int|16
)paren
)paren
suffix:semicolon
(paren
id|u_int
)paren
id|mem_ptr_phys
op_and_assign
op_complement
l_int|0x1fff
suffix:semicolon
multiline_comment|/* 8k alignment */
r_if
c_cond
(paren
id|bus
op_eq
id|HP100_BUS_ISA
op_logical_and
(paren
(paren
id|u_long
)paren
id|mem_ptr_phys
op_amp
op_complement
l_int|0xfffff
)paren
op_ne
l_int|0
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;hp100: Can only use programmed i/o mode.&bslash;n&quot;
)paren
suffix:semicolon
id|mem_ptr_phys
op_assign
l_int|NULL
suffix:semicolon
id|mem_mapped
op_assign
l_int|0
suffix:semicolon
id|hp100_mode
op_assign
l_int|3
suffix:semicolon
multiline_comment|/* Use programmed i/o */
)brace
multiline_comment|/* We do not need access to shared memory in busmaster mode */
multiline_comment|/* However in slave mode we need to remap high (&gt;1GB) card memory  */
r_if
c_cond
(paren
id|hp100_mode
op_ne
l_int|1
)paren
(brace
multiline_comment|/* = not busmaster */
r_if
c_cond
(paren
id|bus
op_eq
id|HP100_BUS_PCI
)paren
(brace
multiline_comment|/* We try with smaller memory sizes, if ioremap fails */
r_for
c_loop
(paren
suffix:semicolon
id|memory_size
OG
l_int|16383
suffix:semicolon
id|memory_size
op_assign
id|memory_size
op_div
l_int|2
)paren
(brace
r_if
c_cond
(paren
(paren
id|mem_ptr_virt
op_assign
id|ioremap
c_func
(paren
(paren
id|u_long
)paren
id|mem_ptr_phys
comma
id|memory_size
)paren
)paren
op_eq
l_int|NULL
)paren
(brace
macro_line|#ifdef HP100_DEBUG
id|printk
c_func
(paren
l_string|&quot;hp100: ioremap for 0x%x bytes high PCI memory at 0x%lx failed&bslash;n&quot;
comma
id|memory_size
comma
(paren
id|u_long
)paren
id|mem_ptr_phys
)paren
suffix:semicolon
macro_line|#endif
)brace
r_else
(brace
macro_line|#ifdef HP100_DEBUG
id|printk
c_func
(paren
l_string|&quot;hp100: remapped 0x%x bytes high PCI memory at 0x%lx to 0x%lx.&bslash;n&quot;
comma
id|memory_size
comma
(paren
id|u_long
)paren
id|mem_ptr_phys
comma
(paren
id|u_long
)paren
id|mem_ptr_virt
)paren
suffix:semicolon
macro_line|#endif
r_break
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|mem_ptr_virt
op_eq
l_int|NULL
)paren
(brace
multiline_comment|/* all ioremap tries failed */
id|printk
c_func
(paren
l_string|&quot;hp100: Failed to ioremap the PCI card memory. Will have to use i/o mapped mode.&bslash;n&quot;
)paren
suffix:semicolon
id|hp100_mode
op_assign
l_int|3
suffix:semicolon
id|memory_size
op_assign
(paren
l_int|8192
op_lshift
(paren
(paren
id|hp100_inb
c_func
(paren
id|SRAM
)paren
op_rshift
l_int|5
)paren
op_amp
l_int|0x07
)paren
)paren
suffix:semicolon
)brace
)brace
)brace
)brace
r_if
c_cond
(paren
id|hp100_mode
op_eq
l_int|3
)paren
(brace
multiline_comment|/* io mapped forced */
id|mem_mapped
op_assign
l_int|0
suffix:semicolon
id|mem_ptr_phys
op_assign
id|mem_ptr_virt
op_assign
l_int|NULL
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;hp100: Using (slow) programmed i/o mode.&bslash;n&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/* Initialise the &quot;private&quot; data structure for this card. */
r_if
c_cond
(paren
(paren
id|dev-&gt;priv
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|hp100_private
)paren
comma
id|GFP_KERNEL
)paren
)paren
op_eq
l_int|NULL
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|memset
c_func
(paren
id|dev-&gt;priv
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|hp100_private
)paren
)paren
suffix:semicolon
id|lp
op_assign
(paren
r_struct
id|hp100_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|lp-&gt;id
op_assign
id|eid
suffix:semicolon
id|lp-&gt;chip
op_assign
id|chip
suffix:semicolon
id|lp-&gt;mode
op_assign
id|hp100_mode
suffix:semicolon
id|lp-&gt;pci_bus
op_assign
id|pci_bus
suffix:semicolon
id|lp-&gt;bus
op_assign
id|bus
suffix:semicolon
id|lp-&gt;pci_device_fn
op_assign
id|pci_device_fn
suffix:semicolon
id|lp-&gt;priority_tx
op_assign
id|hp100_priority_tx
suffix:semicolon
id|lp-&gt;rx_ratio
op_assign
id|hp100_rx_ratio
suffix:semicolon
id|lp-&gt;mem_ptr_phys
op_assign
id|mem_ptr_phys
suffix:semicolon
id|lp-&gt;mem_ptr_virt
op_assign
id|mem_ptr_virt
suffix:semicolon
id|hp100_page
c_func
(paren
id|ID_MAC_ADDR
)paren
suffix:semicolon
id|lp-&gt;soft_model
op_assign
id|hp100_inb
c_func
(paren
id|SOFT_MODEL
)paren
suffix:semicolon
id|lp-&gt;mac1_mode
op_assign
id|HP100_MAC1MODE3
suffix:semicolon
id|lp-&gt;mac2_mode
op_assign
id|HP100_MAC2MODE3
suffix:semicolon
id|dev-&gt;base_addr
op_assign
id|ioaddr
suffix:semicolon
id|lp-&gt;memory_size
op_assign
id|memory_size
suffix:semicolon
id|lp-&gt;rx_ratio
op_assign
id|hp100_rx_ratio
suffix:semicolon
multiline_comment|/* can be conf&squot;d with insmod */
multiline_comment|/* memory region for programmed i/o */
id|request_region
c_func
(paren
id|dev-&gt;base_addr
comma
id|HP100_REGION_SIZE
comma
id|eid-&gt;name
)paren
suffix:semicolon
id|dev-&gt;open
op_assign
id|hp100_open
suffix:semicolon
id|dev-&gt;stop
op_assign
id|hp100_close
suffix:semicolon
r_if
c_cond
(paren
id|lp-&gt;mode
op_eq
l_int|1
)paren
multiline_comment|/* busmaster */
id|dev-&gt;hard_start_xmit
op_assign
id|hp100_start_xmit_bm
suffix:semicolon
r_else
id|dev-&gt;hard_start_xmit
op_assign
id|hp100_start_xmit
suffix:semicolon
id|dev-&gt;get_stats
op_assign
id|hp100_get_stats
suffix:semicolon
id|dev-&gt;set_multicast_list
op_assign
op_amp
id|hp100_set_multicast_list
suffix:semicolon
multiline_comment|/* Ask the card for which IRQ line it is configured */
id|hp100_page
c_func
(paren
id|HW_MAP
)paren
suffix:semicolon
id|dev-&gt;irq
op_assign
id|hp100_inb
c_func
(paren
id|IRQ_CHANNEL
)paren
op_amp
id|HP100_IRQMASK
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;irq
op_eq
l_int|2
)paren
id|dev-&gt;irq
op_assign
l_int|9
suffix:semicolon
r_if
c_cond
(paren
id|lp-&gt;mode
op_eq
l_int|1
)paren
multiline_comment|/* busmaster */
id|dev-&gt;dma
op_assign
l_int|4
suffix:semicolon
multiline_comment|/* Ask the card for its MAC address and store it for later use. */
id|hp100_page
c_func
(paren
id|ID_MAC_ADDR
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
id|uc
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|6
suffix:semicolon
id|i
op_increment
)paren
id|dev-&gt;dev_addr
(braket
id|i
)braket
op_assign
id|hp100_inb
c_func
(paren
id|LAN_ADDR
op_plus
id|i
)paren
suffix:semicolon
multiline_comment|/* Reset statistics (counters) */
id|hp100_clear_stats
c_func
(paren
id|ioaddr
)paren
suffix:semicolon
id|ether_setup
c_func
(paren
id|dev
)paren
suffix:semicolon
multiline_comment|/* If busmaster mode is wanted, a dma-capable memory area is needed for&n;&t; * the rx and tx PDLs &n;&t; * PCI cards can access the whole PC memory. Therefore GFP_DMA is not&n;&t; * needed for the allocation of the memory area. &n;&t; */
multiline_comment|/* TODO: We do not need this with old cards, where PDLs are stored&n;&t; * in the cards shared memory area. But currently, busmaster has been&n;&t; * implemented/tested only with the lassen chip anyway... */
r_if
c_cond
(paren
id|lp-&gt;mode
op_eq
l_int|1
)paren
(brace
multiline_comment|/* busmaster */
multiline_comment|/* Get physically continous memory for TX &amp; RX PDLs    */
r_if
c_cond
(paren
(paren
id|lp-&gt;page_vaddr
op_assign
id|kmalloc
c_func
(paren
id|MAX_RINGSIZE
op_plus
l_int|0x0f
comma
id|GFP_KERNEL
)paren
)paren
op_eq
l_int|NULL
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|lp-&gt;page_vaddr_algn
op_assign
(paren
(paren
id|u_int
op_star
)paren
(paren
(paren
(paren
id|u_int
)paren
(paren
id|lp-&gt;page_vaddr
)paren
op_plus
l_int|0x0f
)paren
op_amp
op_complement
l_int|0x0f
)paren
)paren
suffix:semicolon
id|memset
c_func
(paren
id|lp-&gt;page_vaddr
comma
l_int|0
comma
id|MAX_RINGSIZE
op_plus
l_int|0x0f
)paren
suffix:semicolon
macro_line|#ifdef HP100_DEBUG_BM
id|printk
c_func
(paren
l_string|&quot;hp100: Reserved DMA memory from 0x%x to 0x%x&bslash;n&quot;
comma
(paren
id|u_int
)paren
id|lp-&gt;page_vaddr_algn
comma
(paren
id|u_int
)paren
id|lp-&gt;page_vaddr_algn
op_plus
id|MAX_RINGSIZE
)paren
suffix:semicolon
macro_line|#endif
id|lp-&gt;rxrcommit
op_assign
id|lp-&gt;txrcommit
op_assign
l_int|0
suffix:semicolon
id|lp-&gt;rxrhead
op_assign
id|lp-&gt;rxrtail
op_assign
op_amp
(paren
id|lp-&gt;rxring
(braket
l_int|0
)braket
)paren
suffix:semicolon
id|lp-&gt;txrhead
op_assign
id|lp-&gt;txrtail
op_assign
op_amp
(paren
id|lp-&gt;txring
(braket
l_int|0
)braket
)paren
suffix:semicolon
)brace
multiline_comment|/* Initialise the card. */
multiline_comment|/* (I&squot;m not really sure if it&squot;s a good idea to do this during probing, but &n;&t; * like this it&squot;s assured that the lan connection type can be sensed&n;&t; * correctly)&n;&t; */
id|hp100_hwinit
c_func
(paren
id|dev
)paren
suffix:semicolon
multiline_comment|/* Try to find out which kind of LAN the card is connected to. */
id|lp-&gt;lan_type
op_assign
id|hp100_sense_lan
c_func
(paren
id|dev
)paren
suffix:semicolon
multiline_comment|/* Print out a message what about what we think we have probed. */
id|printk
c_func
(paren
l_string|&quot;hp100: %s: %s at 0x%x, IRQ %d, &quot;
comma
id|dev-&gt;name
comma
id|lp-&gt;id-&gt;name
comma
id|ioaddr
comma
id|dev-&gt;irq
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|bus
)paren
(brace
r_case
id|HP100_BUS_EISA
suffix:colon
id|printk
c_func
(paren
l_string|&quot;EISA&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|HP100_BUS_PCI
suffix:colon
id|printk
c_func
(paren
l_string|&quot;PCI&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|printk
c_func
(paren
l_string|&quot;ISA&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot; bus, %dk SRAM (rx/tx %d%%).&bslash;n&quot;
comma
id|lp-&gt;memory_size
op_rshift
l_int|10
comma
id|lp-&gt;rx_ratio
)paren
suffix:semicolon
r_if
c_cond
(paren
id|lp-&gt;mode
op_eq
l_int|2
)paren
(brace
multiline_comment|/* memory mapped */
id|printk
c_func
(paren
l_string|&quot;%s: Memory area at 0x%lx-0x%lx&quot;
comma
id|dev-&gt;name
comma
(paren
id|u_long
)paren
id|mem_ptr_phys
comma
(paren
id|u_long
)paren
id|mem_ptr_phys
op_plus
(paren
id|u_long
)paren
id|lp-&gt;memory_size
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mem_ptr_virt
)paren
id|printk
c_func
(paren
l_string|&quot; (virtual base 0x%lx)&quot;
comma
(paren
id|u_long
)paren
id|mem_ptr_virt
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;.&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* Set for info when doing ifconfig */
id|dev-&gt;mem_start
op_assign
(paren
id|u_long
)paren
id|mem_ptr_phys
suffix:semicolon
id|dev-&gt;mem_end
op_assign
(paren
id|u_long
)paren
id|mem_ptr_phys
op_plus
(paren
id|u_long
)paren
id|lp-&gt;memory_size
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;%s: &quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_if
c_cond
(paren
id|lp-&gt;lan_type
op_ne
id|HP100_LAN_ERR
)paren
id|printk
c_func
(paren
l_string|&quot;Adapter is attached to &quot;
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|lp-&gt;lan_type
)paren
(brace
r_case
id|HP100_LAN_100
suffix:colon
id|printk
c_func
(paren
l_string|&quot;100Mb/s Voice Grade AnyLAN network.&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|HP100_LAN_10
suffix:colon
id|printk
c_func
(paren
l_string|&quot;10Mb/s network.&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|printk
c_func
(paren
l_string|&quot;Warning! Link down.&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
"&f;"
multiline_comment|/* This procedure puts the card into a stable init state */
DECL|function|hp100_hwinit
r_static
r_void
id|hp100_hwinit
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
r_int
id|ioaddr
op_assign
id|dev-&gt;base_addr
suffix:semicolon
r_struct
id|hp100_private
op_star
id|lp
op_assign
(paren
r_struct
id|hp100_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
macro_line|#ifdef HP100_DEBUG_B
id|hp100_outw
c_func
(paren
l_int|0x4202
comma
id|TRACE
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;hp100: hwinit&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/* Initialise the card. -------------------------------------------- */
multiline_comment|/* Clear all pending Ints and disable Ints */
id|hp100_page
c_func
(paren
id|PERFORMANCE
)paren
suffix:semicolon
id|hp100_outw
c_func
(paren
l_int|0xfefe
comma
id|IRQ_MASK
)paren
suffix:semicolon
multiline_comment|/* mask off all ints */
id|hp100_outw
c_func
(paren
l_int|0xffff
comma
id|IRQ_STATUS
)paren
suffix:semicolon
multiline_comment|/* clear all pending ints */
id|hp100_outw
c_func
(paren
id|HP100_INT_EN
op_or
id|HP100_RESET_LB
comma
id|OPTION_LSW
)paren
suffix:semicolon
id|hp100_outw
c_func
(paren
id|HP100_TRI_INT
op_or
id|HP100_SET_HB
comma
id|OPTION_LSW
)paren
suffix:semicolon
r_if
c_cond
(paren
id|lp-&gt;mode
op_eq
l_int|1
)paren
(brace
id|hp100_BM_shutdown
c_func
(paren
id|dev
)paren
suffix:semicolon
multiline_comment|/* disables BM, puts cascade in reset */
id|wait
c_func
(paren
)paren
suffix:semicolon
)brace
r_else
(brace
id|hp100_outw
c_func
(paren
id|HP100_INT_EN
op_or
id|HP100_RESET_LB
comma
id|OPTION_LSW
)paren
suffix:semicolon
id|hp100_cascade_reset
c_func
(paren
id|dev
comma
id|TRUE
)paren
suffix:semicolon
id|hp100_page
c_func
(paren
id|MAC_CTRL
)paren
suffix:semicolon
id|hp100_andb
c_func
(paren
op_complement
(paren
id|HP100_RX_EN
op_or
id|HP100_TX_EN
)paren
comma
id|MAC_CFG_1
)paren
suffix:semicolon
)brace
multiline_comment|/* Initiate EEPROM reload */
id|hp100_load_eeprom
c_func
(paren
id|dev
)paren
suffix:semicolon
id|wait
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* Go into reset again. */
id|hp100_cascade_reset
c_func
(paren
id|dev
comma
id|TRUE
)paren
suffix:semicolon
multiline_comment|/* Set Option Registers to a safe state  */
id|hp100_outw
c_func
(paren
id|HP100_DEBUG_EN
op_or
id|HP100_RX_HDR
op_or
id|HP100_EE_EN
op_or
id|HP100_BM_WRITE
op_or
id|HP100_BM_READ
op_or
id|HP100_RESET_HB
op_or
id|HP100_FAKE_INT
op_or
id|HP100_INT_EN
op_or
id|HP100_MEM_EN
op_or
id|HP100_IO_EN
op_or
id|HP100_RESET_LB
comma
id|OPTION_LSW
)paren
suffix:semicolon
id|hp100_outw
c_func
(paren
id|HP100_TRI_INT
op_or
id|HP100_MMAP_DIS
op_or
id|HP100_SET_HB
comma
id|OPTION_LSW
)paren
suffix:semicolon
id|hp100_outb
c_func
(paren
id|HP100_PRIORITY_TX
op_or
id|HP100_ADV_NXT_PKT
op_or
id|HP100_TX_CMD
op_or
id|HP100_RESET_LB
comma
id|OPTION_MSW
)paren
suffix:semicolon
multiline_comment|/* TODO: Configure MMU for Ram Test. */
multiline_comment|/* TODO: Ram Test. */
multiline_comment|/* Re-check if adapter is still at same i/o location      */
multiline_comment|/* (If the base i/o in eeprom has been changed but the    */
multiline_comment|/* registers had not been changed, a reload of the eeprom */
multiline_comment|/* would move the adapter to the address stored in eeprom */
multiline_comment|/* TODO: Code to implement. */
multiline_comment|/* Until here it was code from HWdiscover procedure. */
multiline_comment|/* Next comes code from mmuinit procedure of SCO BM driver which is&n;&t; * called from HWconfigure in the SCO driver.  */
multiline_comment|/* Initialise MMU, eventually switch on Busmaster Mode, initialise &n;&t; * multicast filter...&n;&t; */
id|hp100_mmuinit
c_func
(paren
id|dev
)paren
suffix:semicolon
multiline_comment|/* We don&squot;t turn the interrupts on here - this is done by start_interface. */
id|wait
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* TODO: Do we really need this? */
multiline_comment|/* Enable Hardware (e.g. unreset) */
id|hp100_cascade_reset
c_func
(paren
id|dev
comma
id|FALSE
)paren
suffix:semicolon
multiline_comment|/* ------- initialisation complete ----------- */
multiline_comment|/* Finally try to log in the Hub if there may be a VG connection. */
r_if
c_cond
(paren
id|lp-&gt;lan_type
op_ne
id|HP100_LAN_10
)paren
id|hp100_login_to_vg_hub
c_func
(paren
id|dev
comma
id|FALSE
)paren
suffix:semicolon
multiline_comment|/* relogin */
)brace
"&f;"
multiline_comment|/* &n; * mmuinit - Reinitialise Cascade MMU and MAC settings.&n; * Note: Must already be in reset and leaves card in reset. &n; */
DECL|function|hp100_mmuinit
r_static
r_void
id|hp100_mmuinit
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
r_int
id|ioaddr
op_assign
id|dev-&gt;base_addr
suffix:semicolon
r_struct
id|hp100_private
op_star
id|lp
op_assign
(paren
r_struct
id|hp100_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_int
id|i
suffix:semicolon
macro_line|#ifdef HP100_DEBUG_B
id|hp100_outw
c_func
(paren
l_int|0x4203
comma
id|TRACE
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;hp100: mmuinit&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
macro_line|#ifdef HP100_DEBUG
r_if
c_cond
(paren
l_int|0
op_ne
(paren
id|hp100_inw
c_func
(paren
id|OPTION_LSW
)paren
op_amp
id|HP100_HW_RST
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;hp100: Not in reset when entering mmuinit. Fix me.&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
macro_line|#endif
multiline_comment|/* Make sure IRQs are masked off and ack&squot;ed. */
id|hp100_page
c_func
(paren
id|PERFORMANCE
)paren
suffix:semicolon
id|hp100_outw
c_func
(paren
l_int|0xfefe
comma
id|IRQ_MASK
)paren
suffix:semicolon
multiline_comment|/* mask off all ints */
id|hp100_outw
c_func
(paren
l_int|0xffff
comma
id|IRQ_STATUS
)paren
suffix:semicolon
multiline_comment|/* ack IRQ */
multiline_comment|/*&n;&t; * Enable Hardware &n;&t; * - Clear Debug En, Rx Hdr Pipe, EE En, I/O En, Fake Int and Intr En&n;&t; * - Set Tri-State Int, Bus Master Rd/Wr, and Mem Map Disable&n;&t; * - Clear Priority, Advance Pkt and Xmit Cmd&n;&t; */
id|hp100_outw
c_func
(paren
id|HP100_DEBUG_EN
op_or
id|HP100_RX_HDR
op_or
id|HP100_EE_EN
op_or
id|HP100_RESET_HB
op_or
id|HP100_IO_EN
op_or
id|HP100_FAKE_INT
op_or
id|HP100_INT_EN
op_or
id|HP100_RESET_LB
comma
id|OPTION_LSW
)paren
suffix:semicolon
id|hp100_outw
c_func
(paren
id|HP100_TRI_INT
op_or
id|HP100_SET_HB
comma
id|OPTION_LSW
)paren
suffix:semicolon
r_if
c_cond
(paren
id|lp-&gt;mode
op_eq
l_int|1
)paren
(brace
multiline_comment|/* busmaster */
id|hp100_outw
c_func
(paren
id|HP100_BM_WRITE
op_or
id|HP100_BM_READ
op_or
id|HP100_MMAP_DIS
op_or
id|HP100_SET_HB
comma
id|OPTION_LSW
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|lp-&gt;mode
op_eq
l_int|2
)paren
(brace
multiline_comment|/* memory mapped */
id|hp100_outw
c_func
(paren
id|HP100_BM_WRITE
op_or
id|HP100_BM_READ
op_or
id|HP100_RESET_HB
comma
id|OPTION_LSW
)paren
suffix:semicolon
id|hp100_outw
c_func
(paren
id|HP100_MMAP_DIS
op_or
id|HP100_RESET_HB
comma
id|OPTION_LSW
)paren
suffix:semicolon
id|hp100_outw
c_func
(paren
id|HP100_MEM_EN
op_or
id|HP100_SET_LB
comma
id|OPTION_LSW
)paren
suffix:semicolon
id|hp100_outw
c_func
(paren
id|HP100_IO_EN
op_or
id|HP100_SET_LB
comma
id|OPTION_LSW
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|lp-&gt;mode
op_eq
l_int|3
)paren
(brace
multiline_comment|/* i/o mapped mode */
id|hp100_outw
c_func
(paren
id|HP100_MMAP_DIS
op_or
id|HP100_SET_HB
op_or
id|HP100_IO_EN
op_or
id|HP100_SET_LB
comma
id|OPTION_LSW
)paren
suffix:semicolon
)brace
id|hp100_page
c_func
(paren
id|HW_MAP
)paren
suffix:semicolon
id|hp100_outb
c_func
(paren
l_int|0
comma
id|EARLYRXCFG
)paren
suffix:semicolon
id|hp100_outw
c_func
(paren
l_int|0
comma
id|EARLYTXCFG
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Enable Bus Master mode&n;&t; */
r_if
c_cond
(paren
id|lp-&gt;mode
op_eq
l_int|1
)paren
(brace
multiline_comment|/* busmaster */
multiline_comment|/* Experimental: Set some PCI configuration bits */
id|hp100_page
c_func
(paren
id|HW_MAP
)paren
suffix:semicolon
id|hp100_andb
c_func
(paren
op_complement
id|HP100_PDL_USE3
comma
id|MODECTRL1
)paren
suffix:semicolon
multiline_comment|/* BM engine read maximum */
id|hp100_andb
c_func
(paren
op_complement
id|HP100_TX_DUALQ
comma
id|MODECTRL1
)paren
suffix:semicolon
multiline_comment|/* No Queue for Priority TX */
multiline_comment|/* PCI Bus failures should result in a Misc. Interrupt */
id|hp100_orb
c_func
(paren
id|HP100_EN_BUS_FAIL
comma
id|MODECTRL2
)paren
suffix:semicolon
id|hp100_outw
c_func
(paren
id|HP100_BM_READ
op_or
id|HP100_BM_WRITE
op_or
id|HP100_SET_HB
comma
id|OPTION_LSW
)paren
suffix:semicolon
id|hp100_page
c_func
(paren
id|HW_MAP
)paren
suffix:semicolon
multiline_comment|/* Use Burst Mode and switch on PAGE_CK */
id|hp100_orb
c_func
(paren
id|HP100_BM_BURST_RD
op_or
id|HP100_BM_BURST_WR
comma
id|BM
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|lp-&gt;chip
op_eq
id|HP100_CHIPID_RAINIER
)paren
op_logical_or
(paren
id|lp-&gt;chip
op_eq
id|HP100_CHIPID_SHASTA
)paren
)paren
id|hp100_orb
c_func
(paren
id|HP100_BM_PAGE_CK
comma
id|BM
)paren
suffix:semicolon
id|hp100_orb
c_func
(paren
id|HP100_BM_MASTER
comma
id|BM
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* not busmaster */
id|hp100_page
c_func
(paren
id|HW_MAP
)paren
suffix:semicolon
id|hp100_andb
c_func
(paren
op_complement
id|HP100_BM_MASTER
comma
id|BM
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * Divide card memory into regions for Rx, Tx and, if non-ETR chip, PDLs&n;&t; */
id|hp100_page
c_func
(paren
id|MMU_CFG
)paren
suffix:semicolon
r_if
c_cond
(paren
id|lp-&gt;mode
op_eq
l_int|1
)paren
(brace
multiline_comment|/* only needed for Busmaster */
r_int
id|xmit_stop
comma
id|recv_stop
suffix:semicolon
r_if
c_cond
(paren
(paren
id|lp-&gt;chip
op_eq
id|HP100_CHIPID_RAINIER
)paren
op_logical_or
(paren
id|lp-&gt;chip
op_eq
id|HP100_CHIPID_SHASTA
)paren
)paren
(brace
r_int
id|pdl_stop
suffix:semicolon
multiline_comment|/*&n;&t;&t;&t; * Each pdl is 508 bytes long. (63 frags * 4 bytes for address and&n;&t;&t;&t; * 4 bytes for for header). We will leave NUM_RXPDLS * 508 (rounded&n;&t;&t;&t; * to the next higher 1k boundary) bytes for the rx-pdl&squot;s&n;&t;&t;&t; * Note: For non-etr chips the transmit stop register must be&n;&t;&t;&t; * programmed on a 1k boundary, i.e. bits 9:0 must be zero. &n;&t;&t;&t; */
id|pdl_stop
op_assign
id|lp-&gt;memory_size
suffix:semicolon
id|xmit_stop
op_assign
(paren
id|pdl_stop
op_minus
l_int|508
op_star
(paren
id|MAX_RX_PDL
)paren
op_minus
l_int|16
)paren
op_amp
op_complement
(paren
l_int|0x03ff
)paren
suffix:semicolon
id|recv_stop
op_assign
(paren
id|xmit_stop
op_star
(paren
id|lp-&gt;rx_ratio
)paren
op_div
l_int|100
)paren
op_amp
op_complement
(paren
l_int|0x03ff
)paren
suffix:semicolon
id|hp100_outw
c_func
(paren
(paren
id|pdl_stop
op_rshift
l_int|4
)paren
op_minus
l_int|1
comma
id|PDL_MEM_STOP
)paren
suffix:semicolon
macro_line|#ifdef HP100_DEBUG_BM
id|printk
c_func
(paren
l_string|&quot;hp100: PDL_STOP = 0x%x&bslash;n&quot;
comma
id|pdl_stop
)paren
suffix:semicolon
macro_line|#endif
)brace
r_else
(brace
multiline_comment|/* ETR chip (Lassen) in busmaster mode */
id|xmit_stop
op_assign
(paren
id|lp-&gt;memory_size
)paren
op_minus
l_int|1
suffix:semicolon
id|recv_stop
op_assign
(paren
(paren
id|lp-&gt;memory_size
op_star
id|lp-&gt;rx_ratio
)paren
op_div
l_int|100
)paren
op_amp
op_complement
(paren
l_int|0x03ff
)paren
suffix:semicolon
)brace
id|hp100_outw
c_func
(paren
id|xmit_stop
op_rshift
l_int|4
comma
id|TX_MEM_STOP
)paren
suffix:semicolon
id|hp100_outw
c_func
(paren
id|recv_stop
op_rshift
l_int|4
comma
id|RX_MEM_STOP
)paren
suffix:semicolon
macro_line|#ifdef HP100_DEBUG_BM
id|printk
c_func
(paren
l_string|&quot;hp100: TX_STOP  = 0x%x&bslash;n&quot;
comma
id|xmit_stop
op_rshift
l_int|4
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;hp100: RX_STOP  = 0x%x&bslash;n&quot;
comma
id|recv_stop
op_rshift
l_int|4
)paren
suffix:semicolon
macro_line|#endif
)brace
r_else
(brace
multiline_comment|/* Slave modes (memory mapped and programmed io)  */
id|hp100_outw
c_func
(paren
(paren
(paren
(paren
id|lp-&gt;memory_size
op_star
id|lp-&gt;rx_ratio
)paren
op_div
l_int|100
)paren
op_rshift
l_int|4
)paren
comma
id|RX_MEM_STOP
)paren
suffix:semicolon
id|hp100_outw
c_func
(paren
(paren
(paren
id|lp-&gt;memory_size
op_minus
l_int|1
)paren
op_rshift
l_int|4
)paren
comma
id|TX_MEM_STOP
)paren
suffix:semicolon
macro_line|#ifdef HP100_DEBUG
id|printk
c_func
(paren
l_string|&quot;hp100: TX_MEM_STOP: 0x%x&bslash;n&quot;
comma
id|hp100_inw
c_func
(paren
id|TX_MEM_STOP
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;hp100: RX_MEM_STOP: 0x%x&bslash;n&quot;
comma
id|hp100_inw
c_func
(paren
id|RX_MEM_STOP
)paren
)paren
suffix:semicolon
macro_line|#endif
)brace
multiline_comment|/* Write MAC address into page 1 */
id|hp100_page
c_func
(paren
id|MAC_ADDRESS
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|6
suffix:semicolon
id|i
op_increment
)paren
id|hp100_outb
c_func
(paren
id|dev-&gt;dev_addr
(braket
id|i
)braket
comma
id|MAC_ADDR
op_plus
id|i
)paren
suffix:semicolon
multiline_comment|/* Zero the multicast hash registers */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|8
suffix:semicolon
id|i
op_increment
)paren
id|hp100_outb
c_func
(paren
l_int|0x0
comma
id|HASH_BYTE0
op_plus
id|i
)paren
suffix:semicolon
multiline_comment|/* Set up MAC defaults */
id|hp100_page
c_func
(paren
id|MAC_CTRL
)paren
suffix:semicolon
multiline_comment|/* Go to LAN Page and zero all filter bits */
multiline_comment|/* Zero accept error, accept multicast, accept broadcast and accept */
multiline_comment|/* all directed packet bits */
id|hp100_andb
c_func
(paren
op_complement
(paren
id|HP100_RX_EN
op_or
id|HP100_TX_EN
op_or
id|HP100_ACC_ERRORED
op_or
id|HP100_ACC_MC
op_or
id|HP100_ACC_BC
op_or
id|HP100_ACC_PHY
)paren
comma
id|MAC_CFG_1
)paren
suffix:semicolon
id|hp100_outb
c_func
(paren
l_int|0x00
comma
id|MAC_CFG_2
)paren
suffix:semicolon
multiline_comment|/* Zero the frame format bit. This works around a training bug in the */
multiline_comment|/* new hubs. */
id|hp100_outb
c_func
(paren
l_int|0x00
comma
id|VG_LAN_CFG_2
)paren
suffix:semicolon
multiline_comment|/* (use 802.3) */
r_if
c_cond
(paren
id|lp-&gt;priority_tx
)paren
id|hp100_outb
c_func
(paren
id|HP100_PRIORITY_TX
op_or
id|HP100_SET_LB
comma
id|OPTION_MSW
)paren
suffix:semicolon
r_else
id|hp100_outb
c_func
(paren
id|HP100_PRIORITY_TX
op_or
id|HP100_RESET_LB
comma
id|OPTION_MSW
)paren
suffix:semicolon
id|hp100_outb
c_func
(paren
id|HP100_ADV_NXT_PKT
op_or
id|HP100_TX_CMD
op_or
id|HP100_RESET_LB
comma
id|OPTION_MSW
)paren
suffix:semicolon
multiline_comment|/* If busmaster, initialize the PDLs */
r_if
c_cond
(paren
id|lp-&gt;mode
op_eq
l_int|1
)paren
id|hp100_init_pdls
c_func
(paren
id|dev
)paren
suffix:semicolon
multiline_comment|/* Go to performance page and initalize isr and imr registers */
id|hp100_page
c_func
(paren
id|PERFORMANCE
)paren
suffix:semicolon
id|hp100_outw
c_func
(paren
l_int|0xfefe
comma
id|IRQ_MASK
)paren
suffix:semicolon
multiline_comment|/* mask off all ints */
id|hp100_outw
c_func
(paren
l_int|0xffff
comma
id|IRQ_STATUS
)paren
suffix:semicolon
multiline_comment|/* ack IRQ */
)brace
"&f;"
multiline_comment|/*&n; *  open/close functions&n; */
DECL|function|hp100_open
r_static
r_int
id|hp100_open
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
r_struct
id|hp100_private
op_star
id|lp
op_assign
(paren
r_struct
id|hp100_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
macro_line|#ifdef HP100_DEBUG_B
r_int
id|ioaddr
op_assign
id|dev-&gt;base_addr
suffix:semicolon
macro_line|#endif
macro_line|#ifdef HP100_DEBUG_B
id|hp100_outw
c_func
(paren
l_int|0x4204
comma
id|TRACE
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;hp100: open&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/* New: if bus is PCI or EISA, interrupts might be shared interrupts */
r_if
c_cond
(paren
(paren
id|lp-&gt;bus
op_eq
id|HP100_BUS_PCI
)paren
op_logical_or
(paren
id|lp-&gt;bus
op_eq
id|HP100_BUS_EISA
)paren
)paren
(brace
r_if
c_cond
(paren
id|request_irq
c_func
(paren
id|dev-&gt;irq
comma
id|hp100_interrupt
comma
id|SA_SHIRQ
comma
id|lp-&gt;id-&gt;name
comma
id|dev
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%s: unable to get IRQ %d&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|dev-&gt;irq
)paren
suffix:semicolon
r_return
op_minus
id|EAGAIN
suffix:semicolon
)brace
)brace
r_else
r_if
c_cond
(paren
id|request_irq
c_func
(paren
id|dev-&gt;irq
comma
id|hp100_interrupt
comma
id|SA_INTERRUPT
comma
id|lp-&gt;id-&gt;name
comma
id|dev
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%s: unable to get IRQ %d&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|dev-&gt;irq
)paren
suffix:semicolon
r_return
op_minus
id|EAGAIN
suffix:semicolon
)brace
id|MOD_INC_USE_COUNT
suffix:semicolon
id|dev-&gt;tbusy
op_assign
l_int|0
suffix:semicolon
id|dev-&gt;trans_start
op_assign
id|jiffies
suffix:semicolon
id|dev-&gt;interrupt
op_assign
l_int|0
suffix:semicolon
id|dev-&gt;start
op_assign
l_int|1
suffix:semicolon
id|lp-&gt;lan_type
op_assign
id|hp100_sense_lan
c_func
(paren
id|dev
)paren
suffix:semicolon
id|lp-&gt;mac1_mode
op_assign
id|HP100_MAC1MODE3
suffix:semicolon
id|lp-&gt;mac2_mode
op_assign
id|HP100_MAC2MODE3
suffix:semicolon
id|hp100_stop_interface
c_func
(paren
id|dev
)paren
suffix:semicolon
id|hp100_hwinit
c_func
(paren
id|dev
)paren
suffix:semicolon
id|hp100_start_interface
c_func
(paren
id|dev
)paren
suffix:semicolon
multiline_comment|/* sets mac modes, enables interrupts */
r_return
l_int|0
suffix:semicolon
)brace
"&f;"
multiline_comment|/* The close function is called when the interface is to be brought down */
DECL|function|hp100_close
r_static
r_int
id|hp100_close
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
r_int
id|ioaddr
op_assign
id|dev-&gt;base_addr
suffix:semicolon
r_struct
id|hp100_private
op_star
id|lp
op_assign
(paren
r_struct
id|hp100_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
macro_line|#ifdef HP100_DEBUG_B
id|hp100_outw
c_func
(paren
l_int|0x4205
comma
id|TRACE
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;hp100:close&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
id|hp100_page
c_func
(paren
id|PERFORMANCE
)paren
suffix:semicolon
id|hp100_outw
c_func
(paren
l_int|0xfefe
comma
id|IRQ_MASK
)paren
suffix:semicolon
multiline_comment|/* mask off all IRQs */
id|hp100_stop_interface
c_func
(paren
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|lp-&gt;lan_type
op_eq
id|HP100_LAN_100
)paren
id|lp-&gt;hub_status
op_assign
id|hp100_login_to_vg_hub
c_func
(paren
id|dev
comma
id|FALSE
)paren
suffix:semicolon
id|dev-&gt;tbusy
op_assign
l_int|1
suffix:semicolon
id|dev-&gt;start
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
(paren
id|lp-&gt;bus
op_eq
id|HP100_BUS_PCI
)paren
op_logical_or
(paren
id|lp-&gt;bus
op_eq
id|HP100_BUS_EISA
)paren
)paren
id|free_irq
c_func
(paren
id|dev-&gt;irq
comma
id|dev
)paren
suffix:semicolon
r_else
id|free_irq
c_func
(paren
id|dev-&gt;irq
comma
l_int|NULL
)paren
suffix:semicolon
id|MOD_DEC_USE_COUNT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
"&f;"
multiline_comment|/*&n; * Configure the PDL Rx rings and LAN &n; */
DECL|function|hp100_init_pdls
r_static
r_void
id|hp100_init_pdls
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
r_struct
id|hp100_private
op_star
id|lp
op_assign
(paren
r_struct
id|hp100_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|hp100_ring_t
op_star
id|ringptr
suffix:semicolon
id|u_int
op_star
id|pageptr
suffix:semicolon
r_int
id|i
suffix:semicolon
macro_line|#ifdef HP100_DEBUG_B
r_int
id|ioaddr
op_assign
id|dev-&gt;base_addr
suffix:semicolon
macro_line|#endif
macro_line|#ifdef HP100_DEBUG_B
id|hp100_outw
c_func
(paren
l_int|0x4206
comma
id|TRACE
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;hp100: init pdls&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
l_int|0
op_eq
id|lp-&gt;page_vaddr_algn
)paren
id|printk
c_func
(paren
l_string|&quot;hp100: Warning: lp-&gt;page_vaddr_algn not initialised!&bslash;n&quot;
)paren
suffix:semicolon
r_else
(brace
multiline_comment|/* pageptr shall point into the DMA accessible memory region  */
multiline_comment|/* we use this pointer to status the upper limit of allocated */
multiline_comment|/* memory in the allocated page. */
multiline_comment|/* note: align the pointers to the pci cache line size */
id|memset
c_func
(paren
id|lp-&gt;page_vaddr_algn
comma
l_int|0
comma
id|MAX_RINGSIZE
)paren
suffix:semicolon
multiline_comment|/* Zero  Rx/Tx ring page */
id|pageptr
op_assign
id|lp-&gt;page_vaddr_algn
suffix:semicolon
id|lp-&gt;rxrcommit
op_assign
l_int|0
suffix:semicolon
id|ringptr
op_assign
id|lp-&gt;rxrhead
op_assign
id|lp-&gt;rxrtail
op_assign
op_amp
(paren
id|lp-&gt;rxring
(braket
l_int|0
)braket
)paren
suffix:semicolon
multiline_comment|/* Initialise Rx Ring */
r_for
c_loop
(paren
id|i
op_assign
id|MAX_RX_PDL
op_minus
l_int|1
suffix:semicolon
id|i
op_ge
l_int|0
suffix:semicolon
id|i
op_decrement
)paren
(brace
id|lp-&gt;rxring
(braket
id|i
)braket
dot
id|next
op_assign
id|ringptr
suffix:semicolon
id|ringptr
op_assign
op_amp
(paren
id|lp-&gt;rxring
(braket
id|i
)braket
)paren
suffix:semicolon
id|pageptr
op_add_assign
id|hp100_init_rxpdl
c_func
(paren
id|ringptr
comma
id|pageptr
)paren
suffix:semicolon
)brace
multiline_comment|/* Initialise Tx Ring */
id|lp-&gt;txrcommit
op_assign
l_int|0
suffix:semicolon
id|ringptr
op_assign
id|lp-&gt;txrhead
op_assign
id|lp-&gt;txrtail
op_assign
op_amp
(paren
id|lp-&gt;txring
(braket
l_int|0
)braket
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
id|MAX_TX_PDL
op_minus
l_int|1
suffix:semicolon
id|i
op_ge
l_int|0
suffix:semicolon
id|i
op_decrement
)paren
(brace
id|lp-&gt;txring
(braket
id|i
)braket
dot
id|next
op_assign
id|ringptr
suffix:semicolon
id|ringptr
op_assign
op_amp
(paren
id|lp-&gt;txring
(braket
id|i
)braket
)paren
suffix:semicolon
id|pageptr
op_add_assign
id|hp100_init_txpdl
c_func
(paren
id|ringptr
comma
id|pageptr
)paren
suffix:semicolon
)brace
)brace
)brace
"&f;"
multiline_comment|/* These functions &quot;format&quot; the entries in the pdl structure   */
multiline_comment|/* They return how much memory the fragments need.            */
DECL|function|hp100_init_rxpdl
r_static
r_int
id|hp100_init_rxpdl
c_func
(paren
r_register
id|hp100_ring_t
op_star
id|ringptr
comma
r_register
id|u32
op_star
id|pdlptr
)paren
(brace
multiline_comment|/* pdlptr is starting adress for this pdl */
r_if
c_cond
(paren
l_int|0
op_ne
(paren
(paren
(paren
r_int
)paren
id|pdlptr
)paren
op_amp
l_int|0xf
)paren
)paren
id|printk
c_func
(paren
l_string|&quot;hp100: Init rxpdl: Unaligned pdlptr 0x%x.&bslash;n&quot;
comma
(paren
r_int
)paren
id|pdlptr
)paren
suffix:semicolon
id|ringptr-&gt;pdl
op_assign
id|pdlptr
op_plus
l_int|1
suffix:semicolon
id|ringptr-&gt;pdl_paddr
op_assign
id|virt_to_bus
c_func
(paren
id|pdlptr
op_plus
l_int|1
)paren
suffix:semicolon
id|ringptr-&gt;skb
op_assign
(paren
r_void
op_star
)paren
l_int|NULL
suffix:semicolon
multiline_comment|/* &n;&t; * Write address and length of first PDL Fragment (which is used for&n;&t; * storing the RX-Header&n;&t; * We use the 4 bytes _before_ the PDH in the pdl memory area to &n;&t; * store this information. (PDH is at offset 0x04)&n;&t; */
multiline_comment|/* Note that pdlptr+1 and not pdlptr is the pointer to the PDH */
op_star
(paren
id|pdlptr
op_plus
l_int|2
)paren
op_assign
(paren
id|u_int
)paren
id|virt_to_bus
c_func
(paren
id|pdlptr
)paren
suffix:semicolon
multiline_comment|/* Address Frag 1 */
op_star
(paren
id|pdlptr
op_plus
l_int|3
)paren
op_assign
l_int|4
suffix:semicolon
multiline_comment|/* Length  Frag 1 */
r_return
(paren
(paren
(paren
(paren
id|MAX_RX_FRAG
op_star
l_int|2
op_plus
l_int|2
)paren
op_plus
l_int|3
)paren
op_div
l_int|4
)paren
op_star
l_int|4
)paren
suffix:semicolon
)brace
DECL|function|hp100_init_txpdl
r_static
r_int
id|hp100_init_txpdl
c_func
(paren
r_register
id|hp100_ring_t
op_star
id|ringptr
comma
r_register
id|u32
op_star
id|pdlptr
)paren
(brace
r_if
c_cond
(paren
l_int|0
op_ne
(paren
(paren
(paren
r_int
)paren
id|pdlptr
)paren
op_amp
l_int|0xf
)paren
)paren
id|printk
c_func
(paren
l_string|&quot;hp100: Init txpdl: Unaligned pdlptr 0x%x.&bslash;n&quot;
comma
(paren
r_int
)paren
id|pdlptr
)paren
suffix:semicolon
id|ringptr-&gt;pdl
op_assign
id|pdlptr
suffix:semicolon
multiline_comment|/* +1; */
id|ringptr-&gt;pdl_paddr
op_assign
id|virt_to_bus
c_func
(paren
id|pdlptr
)paren
suffix:semicolon
multiline_comment|/* +1 */
id|ringptr-&gt;skb
op_assign
(paren
r_void
op_star
)paren
l_int|NULL
suffix:semicolon
r_return
(paren
(paren
(paren
(paren
id|MAX_TX_FRAG
op_star
l_int|2
op_plus
l_int|2
)paren
op_plus
l_int|3
)paren
op_div
l_int|4
)paren
op_star
l_int|4
)paren
suffix:semicolon
)brace
"&f;"
multiline_comment|/*&n; * hp100_build_rx_pdl allocates an skb_buff of maximum size plus two bytes &n; * for possible odd word alignment rounding up to next dword and set PDL&n; * address for fragment#2 &n; * Returns: 0 if unable to allocate skb_buff&n; *          1 if successful&n; */
DECL|function|hp100_build_rx_pdl
r_int
id|hp100_build_rx_pdl
c_func
(paren
id|hp100_ring_t
op_star
id|ringptr
comma
r_struct
id|device
op_star
id|dev
)paren
(brace
macro_line|#ifdef HP100_DEBUG_B
r_int
id|ioaddr
op_assign
id|dev-&gt;base_addr
suffix:semicolon
macro_line|#endif
macro_line|#ifdef HP100_DEBUG_BM
id|u_int
op_star
id|p
suffix:semicolon
macro_line|#endif
macro_line|#ifdef HP100_DEBUG_B
id|hp100_outw
c_func
(paren
l_int|0x4207
comma
id|TRACE
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;hp100: build rx pdl&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/* Allocate skb buffer of maximum size */
multiline_comment|/* Note: This depends on the alloc_skb functions allocating more &n;&t; * space than requested, i.e. aligning to 16bytes */
id|ringptr-&gt;skb
op_assign
id|dev_alloc_skb
c_func
(paren
(paren
(paren
id|MAX_ETHER_SIZE
op_plus
l_int|2
op_plus
l_int|3
)paren
op_div
l_int|4
)paren
op_star
l_int|4
)paren
suffix:semicolon
r_if
c_cond
(paren
l_int|NULL
op_ne
id|ringptr-&gt;skb
)paren
(brace
multiline_comment|/* &n;&t;&t; * Reserve 2 bytes at the head of the buffer to land the IP header&n;&t;&t; * on a long word boundary (According to the Network Driver section&n;&t;&t; * in the Linux KHG, this should help to increase performance.)&n;&t;&t; */
id|skb_reserve
c_func
(paren
id|ringptr-&gt;skb
comma
l_int|2
)paren
suffix:semicolon
id|ringptr-&gt;skb-&gt;dev
op_assign
id|dev
suffix:semicolon
id|ringptr-&gt;skb-&gt;data
op_assign
(paren
id|u_char
op_star
)paren
id|skb_put
c_func
(paren
id|ringptr-&gt;skb
comma
id|MAX_ETHER_SIZE
)paren
suffix:semicolon
multiline_comment|/* ringptr-&gt;pdl points to the beginning of the PDL, i.e. the PDH */
multiline_comment|/* Note: 1st Fragment is used for the 4 byte packet status&n;&t;&t; * (receive header). Its PDL entries are set up by init_rxpdl. So &n;&t;&t; * here we only have to set up the PDL fragment entries for the data&n;&t;&t; * part. Those 4 bytes will be stored in the DMA memory region &n;&t;&t; * directly before the PDL. &n;&t;&t; */
macro_line|#ifdef HP100_DEBUG_BM
id|printk
c_func
(paren
l_string|&quot;hp100: build_rx_pdl: PDH@0x%x, skb-&gt;data (len %d) at 0x%x&bslash;n&quot;
comma
(paren
id|u_int
)paren
id|ringptr-&gt;pdl
comma
(paren
(paren
id|MAX_ETHER_SIZE
op_plus
l_int|2
op_plus
l_int|3
)paren
op_div
l_int|4
)paren
op_star
l_int|4
comma
(paren
r_int
r_int
)paren
id|ringptr-&gt;skb-&gt;data
)paren
suffix:semicolon
macro_line|#endif
id|ringptr-&gt;pdl
(braket
l_int|0
)braket
op_assign
l_int|0x00020000
suffix:semicolon
multiline_comment|/* Write PDH */
id|ringptr-&gt;pdl
(braket
l_int|3
)braket
op_assign
(paren
(paren
id|u_int
)paren
id|virt_to_bus
c_func
(paren
id|ringptr-&gt;skb-&gt;data
)paren
)paren
suffix:semicolon
id|ringptr-&gt;pdl
(braket
l_int|4
)braket
op_assign
id|MAX_ETHER_SIZE
suffix:semicolon
multiline_comment|/* Length of Data */
macro_line|#ifdef HP100_DEBUG_BM
r_for
c_loop
(paren
id|p
op_assign
(paren
id|ringptr-&gt;pdl
)paren
suffix:semicolon
id|p
OL
(paren
id|ringptr-&gt;pdl
op_plus
l_int|5
)paren
suffix:semicolon
id|p
op_increment
)paren
id|printk
c_func
(paren
l_string|&quot;Adr 0x%.8x = 0x%.8x&bslash;n&quot;
comma
(paren
id|u_int
)paren
id|p
comma
(paren
id|u_int
)paren
op_star
id|p
)paren
suffix:semicolon
macro_line|#endif
r_return
(paren
l_int|1
)paren
suffix:semicolon
)brace
multiline_comment|/* else: */
multiline_comment|/* alloc_skb failed (no memory) -&gt; still can receive the header&n;&t; * fragment into PDL memory. make PDL safe by clearing msgptr and&n;&t; * making the PDL only 1 fragment (i.e. the 4 byte packet status)&n;&t; */
macro_line|#ifdef HP100_DEBUG_BM
id|printk
c_func
(paren
l_string|&quot;hp100: build_rx_pdl: PDH@0x%x, No space for skb.&bslash;n&quot;
comma
(paren
id|u_int
)paren
id|ringptr-&gt;pdl
)paren
suffix:semicolon
macro_line|#endif
id|ringptr-&gt;pdl
(braket
l_int|0
)braket
op_assign
l_int|0x00010000
suffix:semicolon
multiline_comment|/* PDH: Count=1 Fragment */
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
"&f;"
multiline_comment|/*&n; *  hp100_rxfill - attempt to fill the Rx Ring will empty skb&squot;s&n; *&n; * Makes assumption that skb&squot;s are always contiguous memory areas and&n; * therefore PDLs contain only 2 physical fragments.&n; * -  While the number of Rx PDLs with buffers is less than maximum&n; *      a.  Get a maximum packet size skb&n; *      b.  Put the physical address of the buffer into the PDL.&n; *      c.  Output physical address of PDL to adapter.&n; */
DECL|function|hp100_rxfill
r_static
r_void
id|hp100_rxfill
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
r_int
id|ioaddr
op_assign
id|dev-&gt;base_addr
suffix:semicolon
r_struct
id|hp100_private
op_star
id|lp
op_assign
(paren
r_struct
id|hp100_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|hp100_ring_t
op_star
id|ringptr
suffix:semicolon
macro_line|#ifdef HP100_DEBUG_B
id|hp100_outw
c_func
(paren
l_int|0x4208
comma
id|TRACE
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;hp100: rxfill&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
id|hp100_page
c_func
(paren
id|PERFORMANCE
)paren
suffix:semicolon
r_while
c_loop
(paren
id|lp-&gt;rxrcommit
OL
id|MAX_RX_PDL
)paren
(brace
multiline_comment|/*&n;&t;&t;   ** Attempt to get a buffer and build a Rx PDL.&n;&t;&t; */
id|ringptr
op_assign
id|lp-&gt;rxrtail
suffix:semicolon
r_if
c_cond
(paren
l_int|0
op_eq
id|hp100_build_rx_pdl
c_func
(paren
id|ringptr
comma
id|dev
)paren
)paren
(brace
r_return
suffix:semicolon
multiline_comment|/* None available, return */
)brace
multiline_comment|/* Hand this PDL over to the card */
multiline_comment|/* Note: This needs performance page selected! */
macro_line|#ifdef HP100_DEBUG_BM
id|printk
c_func
(paren
l_string|&quot;hp100: rxfill: Hand to card: pdl #%d @0x%x phys:0x%x, buffer: 0x%x&bslash;n&quot;
comma
id|lp-&gt;rxrcommit
comma
(paren
id|u_int
)paren
id|ringptr-&gt;pdl
comma
(paren
id|u_int
)paren
id|ringptr-&gt;pdl_paddr
comma
(paren
id|u_int
)paren
id|ringptr-&gt;pdl
(braket
l_int|3
)braket
)paren
suffix:semicolon
macro_line|#endif
id|hp100_outl
c_func
(paren
(paren
id|u32
)paren
id|ringptr-&gt;pdl_paddr
comma
id|RX_PDA
)paren
suffix:semicolon
id|lp-&gt;rxrcommit
op_add_assign
l_int|1
suffix:semicolon
id|lp-&gt;rxrtail
op_assign
id|ringptr-&gt;next
suffix:semicolon
)brace
)brace
"&f;"
multiline_comment|/*&n; * BM_shutdown - shutdown bus mastering and leave chip in reset state&n; */
DECL|function|hp100_BM_shutdown
r_static
r_void
id|hp100_BM_shutdown
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
r_int
id|ioaddr
op_assign
id|dev-&gt;base_addr
suffix:semicolon
r_struct
id|hp100_private
op_star
id|lp
op_assign
(paren
r_struct
id|hp100_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_int
r_int
id|time
suffix:semicolon
macro_line|#ifdef HP100_DEBUG_B
id|hp100_outw
c_func
(paren
l_int|0x4209
comma
id|TRACE
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;hp100: bm shutdown&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
id|hp100_page
c_func
(paren
id|PERFORMANCE
)paren
suffix:semicolon
id|hp100_outw
c_func
(paren
l_int|0xfefe
comma
id|IRQ_MASK
)paren
suffix:semicolon
multiline_comment|/* mask off all ints */
id|hp100_outw
c_func
(paren
l_int|0xffff
comma
id|IRQ_STATUS
)paren
suffix:semicolon
multiline_comment|/* Ack all ints */
multiline_comment|/* Ensure Interrupts are off */
id|hp100_outw
c_func
(paren
id|HP100_INT_EN
op_or
id|HP100_RESET_LB
comma
id|OPTION_LSW
)paren
suffix:semicolon
multiline_comment|/* Disable all MAC activity */
id|hp100_page
c_func
(paren
id|MAC_CTRL
)paren
suffix:semicolon
id|hp100_andb
c_func
(paren
op_complement
(paren
id|HP100_RX_EN
op_or
id|HP100_TX_EN
)paren
comma
id|MAC_CFG_1
)paren
suffix:semicolon
multiline_comment|/* stop rx/tx */
multiline_comment|/* If cascade MMU is not already in reset */
r_if
c_cond
(paren
l_int|0
op_ne
(paren
id|hp100_inw
c_func
(paren
id|OPTION_LSW
)paren
op_amp
id|HP100_HW_RST
)paren
)paren
(brace
multiline_comment|/* Wait 1.3ms (10Mb max packet time) to ensure MAC is idle so&n;&t;&t; * MMU pointers will not be reset out from underneath&n;&t;&t; */
id|hp100_page
c_func
(paren
id|MAC_CTRL
)paren
suffix:semicolon
r_for
c_loop
(paren
id|time
op_assign
l_int|0
suffix:semicolon
id|time
OL
l_int|5000
suffix:semicolon
id|time
op_increment
)paren
(brace
r_if
c_cond
(paren
(paren
id|hp100_inb
c_func
(paren
id|MAC_CFG_1
)paren
op_amp
(paren
id|HP100_TX_IDLE
op_or
id|HP100_RX_IDLE
)paren
)paren
op_eq
(paren
id|HP100_TX_IDLE
op_or
id|HP100_RX_IDLE
)paren
)paren
r_break
suffix:semicolon
)brace
multiline_comment|/* Shutdown algorithm depends on the generation of Cascade */
r_if
c_cond
(paren
id|lp-&gt;chip
op_eq
id|HP100_CHIPID_LASSEN
)paren
(brace
multiline_comment|/* ETR shutdown/reset */
multiline_comment|/* Disable Busmaster mode and wait for bit to go to zero. */
id|hp100_page
c_func
(paren
id|HW_MAP
)paren
suffix:semicolon
id|hp100_andb
c_func
(paren
op_complement
id|HP100_BM_MASTER
comma
id|BM
)paren
suffix:semicolon
multiline_comment|/* 100 ms timeout */
r_for
c_loop
(paren
id|time
op_assign
l_int|0
suffix:semicolon
id|time
OL
l_int|32000
suffix:semicolon
id|time
op_increment
)paren
(brace
r_if
c_cond
(paren
l_int|0
op_eq
(paren
id|hp100_inb
c_func
(paren
id|BM
)paren
op_amp
id|HP100_BM_MASTER
)paren
)paren
r_break
suffix:semicolon
)brace
)brace
r_else
(brace
multiline_comment|/* Shasta or Rainier Shutdown/Reset */
multiline_comment|/* To ensure all bus master inloading activity has ceased,&n;&t;&t;&t; * wait for no Rx PDAs or no Rx packets on card. &n;&t;&t;&t; */
id|hp100_page
c_func
(paren
id|PERFORMANCE
)paren
suffix:semicolon
multiline_comment|/* 100 ms timeout */
r_for
c_loop
(paren
id|time
op_assign
l_int|0
suffix:semicolon
id|time
OL
l_int|10000
suffix:semicolon
id|time
op_increment
)paren
(brace
multiline_comment|/* RX_PDL: PDLs not executed. */
multiline_comment|/* RX_PKT_CNT: RX&squot;d packets on card. */
r_if
c_cond
(paren
(paren
id|hp100_inb
c_func
(paren
id|RX_PDL
)paren
op_eq
l_int|0
)paren
op_logical_and
(paren
id|hp100_inb
c_func
(paren
id|RX_PKT_CNT
)paren
op_eq
l_int|0
)paren
)paren
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|time
op_ge
l_int|10000
)paren
id|printk
c_func
(paren
l_string|&quot;hp100: BM shutdown error.&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* To ensure all bus master outloading activity has ceased,&n;&t;&t;&t; * wait until the Tx PDA count goes to zero or no more Tx space&n;&t;&t;&t; * available in the Tx region of the card. &n;&t;&t;&t; */
multiline_comment|/* 100 ms timeout */
r_for
c_loop
(paren
id|time
op_assign
l_int|0
suffix:semicolon
id|time
OL
l_int|10000
suffix:semicolon
id|time
op_increment
)paren
(brace
r_if
c_cond
(paren
(paren
l_int|0
op_eq
id|hp100_inb
c_func
(paren
id|TX_PKT_CNT
)paren
)paren
op_logical_and
(paren
l_int|0
op_ne
(paren
id|hp100_inb
c_func
(paren
id|TX_MEM_FREE
)paren
op_amp
id|HP100_AUTO_COMPARE
)paren
)paren
)paren
r_break
suffix:semicolon
)brace
multiline_comment|/* Disable Busmaster mode */
id|hp100_page
c_func
(paren
id|HW_MAP
)paren
suffix:semicolon
id|hp100_andb
c_func
(paren
op_complement
id|HP100_BM_MASTER
comma
id|BM
)paren
suffix:semicolon
)brace
multiline_comment|/* end of shutdown procedure for non-etr parts */
id|hp100_cascade_reset
c_func
(paren
id|dev
comma
id|TRUE
)paren
suffix:semicolon
)brace
id|hp100_page
c_func
(paren
id|PERFORMANCE
)paren
suffix:semicolon
id|hp100_outw
c_func
(paren
id|HP100_BM_READ
op_or
id|HP100_BM_WRITE
op_or
id|HP100_RESET_HB
comma
id|OPTION_LSW
)paren
suffix:semicolon
multiline_comment|/* Busmaster mode should be shut down now. */
)brace
"&f;"
multiline_comment|/* &n; *  transmit functions&n; */
multiline_comment|/* tx function for busmaster mode */
DECL|function|hp100_start_xmit_bm
r_static
r_int
id|hp100_start_xmit_bm
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|device
op_star
id|dev
)paren
(brace
r_int
id|i
comma
id|ok_flag
suffix:semicolon
r_int
id|ioaddr
op_assign
id|dev-&gt;base_addr
suffix:semicolon
r_struct
id|hp100_private
op_star
id|lp
op_assign
(paren
r_struct
id|hp100_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|hp100_ring_t
op_star
id|ringptr
suffix:semicolon
macro_line|#ifdef HP100_DEBUG_B
id|hp100_outw
c_func
(paren
l_int|0x4210
comma
id|TRACE
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;hp100: start_xmit_bm&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/* Get Tx ring tail pointer */
r_if
c_cond
(paren
id|lp-&gt;txrtail-&gt;next
op_eq
id|lp-&gt;txrhead
)paren
(brace
multiline_comment|/* No memory. */
macro_line|#ifdef HP100_DEBUG
id|printk
c_func
(paren
l_string|&quot;hp100: start_xmit_bm: No TX PDL available.&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/* not waited long enough since last tx? */
r_if
c_cond
(paren
id|jiffies
op_minus
id|dev-&gt;trans_start
OL
id|HZ
op_div
l_int|10
)paren
r_return
op_minus
id|EAGAIN
suffix:semicolon
r_if
c_cond
(paren
id|lp-&gt;lan_type
OL
l_int|0
)paren
(brace
multiline_comment|/* no LAN type detected yet? */
id|hp100_stop_interface
c_func
(paren
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|lp-&gt;lan_type
op_assign
id|hp100_sense_lan
c_func
(paren
id|dev
)paren
)paren
OL
l_int|0
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%s: no connection found - check wire&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|hp100_start_interface
c_func
(paren
id|dev
)paren
suffix:semicolon
multiline_comment|/* 10Mb/s RX pkts maybe handled */
r_return
op_minus
id|EIO
suffix:semicolon
)brace
r_if
c_cond
(paren
id|lp-&gt;lan_type
op_eq
id|HP100_LAN_100
)paren
id|lp-&gt;hub_status
op_assign
id|hp100_login_to_vg_hub
c_func
(paren
id|dev
comma
id|FALSE
)paren
suffix:semicolon
multiline_comment|/* relogin */
id|hp100_start_interface
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|lp-&gt;lan_type
op_eq
id|HP100_LAN_100
op_logical_and
id|lp-&gt;hub_status
OL
l_int|0
)paren
multiline_comment|/* we have a 100Mb/s adapter but it isn&squot;t connected to hub */
(brace
id|printk
c_func
(paren
l_string|&quot;%s: login to 100Mb/s hub retry&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|hp100_stop_interface
c_func
(paren
id|dev
)paren
suffix:semicolon
id|lp-&gt;hub_status
op_assign
id|hp100_login_to_vg_hub
c_func
(paren
id|dev
comma
id|FALSE
)paren
suffix:semicolon
id|hp100_start_interface
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
r_else
(brace
id|hp100_ints_off
c_func
(paren
)paren
suffix:semicolon
id|i
op_assign
id|hp100_sense_lan
c_func
(paren
id|dev
)paren
suffix:semicolon
id|hp100_page
c_func
(paren
id|PERFORMANCE
)paren
suffix:semicolon
id|hp100_ints_on
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
op_eq
id|HP100_LAN_ERR
)paren
id|printk
c_func
(paren
l_string|&quot;%s: link down detected&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
id|lp-&gt;lan_type
op_ne
id|i
)paren
(brace
multiline_comment|/* cable change! */
multiline_comment|/* it&squot;s very hard - all network setting must be changed!!! */
id|printk
c_func
(paren
l_string|&quot;%s: cable change 10Mb/s &lt;-&gt; 100Mb/s detected&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|lp-&gt;lan_type
op_assign
id|i
suffix:semicolon
id|hp100_stop_interface
c_func
(paren
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|lp-&gt;lan_type
op_eq
id|HP100_LAN_100
)paren
id|lp-&gt;hub_status
op_assign
id|hp100_login_to_vg_hub
c_func
(paren
id|dev
comma
id|FALSE
)paren
suffix:semicolon
id|hp100_start_interface
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
r_else
(brace
id|printk
c_func
(paren
l_string|&quot;%s: interface reset&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|hp100_stop_interface
c_func
(paren
id|dev
)paren
suffix:semicolon
id|hp100_start_interface
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
)brace
id|dev-&gt;trans_start
op_assign
id|jiffies
suffix:semicolon
r_return
op_minus
id|EAGAIN
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * we have to turn int&squot;s off before modifying this, otherwise&n;&t; * a tx_pdl_cleanup could occur at the same time&n;&t; */
id|cli
c_func
(paren
)paren
suffix:semicolon
id|ringptr
op_assign
id|lp-&gt;txrtail
suffix:semicolon
id|lp-&gt;txrtail
op_assign
id|ringptr-&gt;next
suffix:semicolon
multiline_comment|/* Check whether packet has minimal packet size */
id|ok_flag
op_assign
id|skb-&gt;len
op_ge
id|HP100_MIN_PACKET_SIZE
suffix:semicolon
id|i
op_assign
id|ok_flag
ques
c_cond
id|skb-&gt;len
suffix:colon
id|HP100_MIN_PACKET_SIZE
suffix:semicolon
id|ringptr-&gt;skb
op_assign
id|skb
suffix:semicolon
id|ringptr-&gt;pdl
(braket
l_int|0
)braket
op_assign
(paren
(paren
l_int|1
op_lshift
l_int|16
)paren
op_or
id|i
)paren
suffix:semicolon
multiline_comment|/* PDH: 1 Fragment &amp; length */
id|ringptr-&gt;pdl
(braket
l_int|1
)braket
op_assign
(paren
id|u32
)paren
id|virt_to_bus
c_func
(paren
id|skb-&gt;data
)paren
suffix:semicolon
multiline_comment|/* 1st Frag: Adr. of data */
r_if
c_cond
(paren
id|lp-&gt;chip
op_eq
id|HP100_CHIPID_SHASTA
)paren
(brace
multiline_comment|/* TODO:Could someone who has the EISA card please check if this works? */
id|ringptr-&gt;pdl
(braket
l_int|2
)braket
op_assign
id|i
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* Lassen */
multiline_comment|/* In the PDL, don&squot;t use the padded size but the real packet size: */
id|ringptr-&gt;pdl
(braket
l_int|2
)braket
op_assign
id|skb-&gt;len
suffix:semicolon
multiline_comment|/* 1st Frag: Length of frag */
)brace
multiline_comment|/* Hand this PDL to the card. */
id|hp100_outl
c_func
(paren
id|ringptr-&gt;pdl_paddr
comma
id|TX_PDA_L
)paren
suffix:semicolon
multiline_comment|/* Low Prio. Queue */
id|lp-&gt;txrcommit
op_increment
suffix:semicolon
id|sti
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* Update statistics */
id|lp-&gt;stats.tx_packets
op_increment
suffix:semicolon
macro_line|#ifdef LINUX_2_1
id|lp-&gt;stats.tx_bytes
op_add_assign
id|skb-&gt;len
suffix:semicolon
macro_line|#endif
id|dev-&gt;trans_start
op_assign
id|jiffies
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
"&f;"
multiline_comment|/* clean_txring checks if packets have been sent by the card by reading&n; * the TX_PDL register from the performance page and comparing it to the&n; * number of commited packets. It then frees the skb&squot;s of the packets that&n; * obviously have been sent to the network.&n; *&n; * Needs the PERFORMANCE page selected. &n; */
DECL|function|hp100_clean_txring
r_static
r_void
id|hp100_clean_txring
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
r_struct
id|hp100_private
op_star
id|lp
op_assign
(paren
r_struct
id|hp100_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_int
id|ioaddr
op_assign
id|dev-&gt;base_addr
suffix:semicolon
r_int
id|donecount
suffix:semicolon
macro_line|#ifdef HP100_DEBUG_B
id|hp100_outw
c_func
(paren
l_int|0x4211
comma
id|TRACE
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;hp100: clean txring&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/* How many PDLs have been transmitted? */
id|donecount
op_assign
(paren
id|lp-&gt;txrcommit
)paren
op_minus
id|hp100_inb
c_func
(paren
id|TX_PDL
)paren
suffix:semicolon
macro_line|#ifdef HP100_DEBUG
r_if
c_cond
(paren
id|donecount
OG
id|MAX_TX_PDL
)paren
id|printk
c_func
(paren
l_string|&quot;hp100: Warning: More PDLs transmitted than commited to card???&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
r_for
c_loop
(paren
suffix:semicolon
l_int|0
op_ne
id|donecount
suffix:semicolon
id|donecount
op_decrement
)paren
(brace
macro_line|#ifdef HP100_DEBUG_BM
id|printk
c_func
(paren
l_string|&quot;hp100: Free skb: data @0x%.8x txrcommit=0x%x TXPDL=0x%x, done=0x%x&bslash;n&quot;
comma
(paren
id|u_int
)paren
id|lp-&gt;txrhead-&gt;skb-&gt;data
comma
id|lp-&gt;txrcommit
comma
id|hp100_inb
c_func
(paren
id|TX_PDL
)paren
comma
id|donecount
)paren
suffix:semicolon
macro_line|#endif
id|dev_kfree_skb
c_func
(paren
id|lp-&gt;txrhead-&gt;skb
)paren
suffix:semicolon
id|lp-&gt;txrhead-&gt;skb
op_assign
(paren
r_void
op_star
)paren
l_int|NULL
suffix:semicolon
id|lp-&gt;txrhead
op_assign
id|lp-&gt;txrhead-&gt;next
suffix:semicolon
id|lp-&gt;txrcommit
op_decrement
suffix:semicolon
)brace
)brace
"&f;"
multiline_comment|/* tx function for slave modes */
DECL|function|hp100_start_xmit
r_static
r_int
id|hp100_start_xmit
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|device
op_star
id|dev
)paren
(brace
r_int
id|i
comma
id|ok_flag
suffix:semicolon
r_int
id|ioaddr
op_assign
id|dev-&gt;base_addr
suffix:semicolon
id|u_short
id|val
suffix:semicolon
r_struct
id|hp100_private
op_star
id|lp
op_assign
(paren
r_struct
id|hp100_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
macro_line|#ifdef HP100_DEBUG_B
id|hp100_outw
c_func
(paren
l_int|0x4212
comma
id|TRACE
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;hp100: start_xmit&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|lp-&gt;lan_type
OL
l_int|0
)paren
(brace
multiline_comment|/* no LAN type detected yet? */
id|hp100_stop_interface
c_func
(paren
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|lp-&gt;lan_type
op_assign
id|hp100_sense_lan
c_func
(paren
id|dev
)paren
)paren
OL
l_int|0
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%s: no connection found - check wire&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|hp100_start_interface
c_func
(paren
id|dev
)paren
suffix:semicolon
multiline_comment|/* 10Mb/s RX packets maybe handled */
r_return
op_minus
id|EIO
suffix:semicolon
)brace
r_if
c_cond
(paren
id|lp-&gt;lan_type
op_eq
id|HP100_LAN_100
)paren
id|lp-&gt;hub_status
op_assign
id|hp100_login_to_vg_hub
c_func
(paren
id|dev
comma
id|FALSE
)paren
suffix:semicolon
multiline_comment|/* relogin */
id|hp100_start_interface
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
multiline_comment|/* If there is not enough free memory on the card... */
id|i
op_assign
id|hp100_inl
c_func
(paren
id|TX_MEM_FREE
)paren
op_amp
l_int|0x7fffffff
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
(paren
(paren
id|i
op_div
l_int|2
)paren
op_minus
l_int|539
)paren
OG
(paren
id|skb-&gt;len
op_plus
l_int|16
)paren
op_logical_and
(paren
id|hp100_inb
c_func
(paren
id|TX_PKT_CNT
)paren
OL
l_int|255
)paren
)paren
)paren
(brace
macro_line|#ifdef HP100_DEBUG
id|printk
c_func
(paren
l_string|&quot;hp100_start_xmit: tx free mem = 0x%x&bslash;n&quot;
comma
id|i
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/* not waited long enough since last failed tx try? */
r_if
c_cond
(paren
id|jiffies
op_minus
id|dev-&gt;trans_start
OL
id|HZ
op_div
l_int|2
)paren
(brace
macro_line|#ifdef HP100_DEBUG
id|printk
c_func
(paren
l_string|&quot;hp100: trans_start timing problem&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
r_return
op_minus
id|EAGAIN
suffix:semicolon
)brace
r_if
c_cond
(paren
id|lp-&gt;lan_type
op_eq
id|HP100_LAN_100
op_logical_and
id|lp-&gt;hub_status
OL
l_int|0
)paren
multiline_comment|/* we have a 100Mb/s adapter but it isn&squot;t connected to hub */
(brace
id|printk
c_func
(paren
l_string|&quot;%s: login to 100Mb/s hub retry&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|hp100_stop_interface
c_func
(paren
id|dev
)paren
suffix:semicolon
id|lp-&gt;hub_status
op_assign
id|hp100_login_to_vg_hub
c_func
(paren
id|dev
comma
id|FALSE
)paren
suffix:semicolon
id|hp100_start_interface
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
r_else
(brace
id|hp100_ints_off
c_func
(paren
)paren
suffix:semicolon
id|i
op_assign
id|hp100_sense_lan
c_func
(paren
id|dev
)paren
suffix:semicolon
id|hp100_page
c_func
(paren
id|PERFORMANCE
)paren
suffix:semicolon
id|hp100_ints_on
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
op_eq
id|HP100_LAN_ERR
)paren
id|printk
c_func
(paren
l_string|&quot;%s: link down detected&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
id|lp-&gt;lan_type
op_ne
id|i
)paren
(brace
multiline_comment|/* cable change! */
multiline_comment|/* it&squot;s very hard - all network setting must be changed!!! */
id|printk
c_func
(paren
l_string|&quot;%s: cable change 10Mb/s &lt;-&gt; 100Mb/s detected&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|lp-&gt;lan_type
op_assign
id|i
suffix:semicolon
id|hp100_stop_interface
c_func
(paren
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|lp-&gt;lan_type
op_eq
id|HP100_LAN_100
)paren
id|lp-&gt;hub_status
op_assign
id|hp100_login_to_vg_hub
c_func
(paren
id|dev
comma
id|FALSE
)paren
suffix:semicolon
id|hp100_start_interface
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
r_else
(brace
id|printk
c_func
(paren
l_string|&quot;%s: interface reset&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|hp100_stop_interface
c_func
(paren
id|dev
)paren
suffix:semicolon
id|hp100_start_interface
c_func
(paren
id|dev
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|1000
)paren
suffix:semicolon
)brace
)brace
id|dev-&gt;trans_start
op_assign
id|jiffies
suffix:semicolon
r_return
op_minus
id|EAGAIN
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|6000
op_logical_and
(paren
id|hp100_inb
c_func
(paren
id|OPTION_MSW
)paren
op_amp
id|HP100_TX_CMD
)paren
suffix:semicolon
id|i
op_increment
)paren
(brace
macro_line|#ifdef HP100_DEBUG_TX
id|printk
c_func
(paren
l_string|&quot;hp100_start_xmit: busy&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
)brace
id|hp100_ints_off
c_func
(paren
)paren
suffix:semicolon
id|val
op_assign
id|hp100_inw
c_func
(paren
id|IRQ_STATUS
)paren
suffix:semicolon
multiline_comment|/* Ack / clear the interrupt TX_COMPLETE interrupt - this interrupt is set&n;&t; * when the current packet being transmitted on the wire is completed. */
id|hp100_outw
c_func
(paren
id|HP100_TX_COMPLETE
comma
id|IRQ_STATUS
)paren
suffix:semicolon
macro_line|#ifdef HP100_DEBUG_TX
id|printk
c_func
(paren
l_string|&quot;hp100_start_xmit: irq_status=0x%.4x, irqmask=0x%.4x, len=%d&bslash;n&quot;
comma
id|val
comma
id|hp100_inw
c_func
(paren
id|IRQ_MASK
)paren
comma
(paren
r_int
)paren
id|skb-&gt;len
)paren
suffix:semicolon
macro_line|#endif
id|ok_flag
op_assign
id|skb-&gt;len
op_ge
id|HP100_MIN_PACKET_SIZE
suffix:semicolon
id|i
op_assign
id|ok_flag
ques
c_cond
id|skb-&gt;len
suffix:colon
id|HP100_MIN_PACKET_SIZE
suffix:semicolon
id|hp100_outw
c_func
(paren
id|i
comma
id|DATA32
)paren
suffix:semicolon
multiline_comment|/* tell card the total packet length */
id|hp100_outw
c_func
(paren
id|i
comma
id|FRAGMENT_LEN
)paren
suffix:semicolon
multiline_comment|/* and first/only fragment length    */
r_if
c_cond
(paren
id|lp-&gt;mode
op_eq
l_int|2
)paren
(brace
multiline_comment|/* memory mapped */
r_if
c_cond
(paren
id|lp-&gt;mem_ptr_virt
)paren
(brace
multiline_comment|/* high pci memory was remapped */
multiline_comment|/* Note: The J2585B needs alignment to 32bits here!  */
id|memcpy
c_func
(paren
id|lp-&gt;mem_ptr_virt
comma
id|skb-&gt;data
comma
(paren
id|skb-&gt;len
op_plus
l_int|3
)paren
op_amp
op_complement
l_int|3
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ok_flag
)paren
id|memset
c_func
(paren
id|lp-&gt;mem_ptr_virt
comma
l_int|0
comma
id|HP100_MIN_PACKET_SIZE
op_minus
id|skb-&gt;len
)paren
suffix:semicolon
)brace
r_else
(brace
id|memcpy_toio
c_func
(paren
id|lp-&gt;mem_ptr_phys
comma
id|skb-&gt;data
comma
id|skb-&gt;len
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ok_flag
)paren
id|memset_io
c_func
(paren
id|lp-&gt;mem_ptr_phys
comma
l_int|0
comma
id|HP100_MIN_PACKET_SIZE
op_minus
id|skb-&gt;len
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
multiline_comment|/* programmed i/o */
id|outsl
c_func
(paren
id|ioaddr
op_plus
id|HP100_REG_DATA32
comma
id|skb-&gt;data
comma
(paren
id|skb-&gt;len
op_plus
l_int|3
)paren
op_rshift
l_int|2
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ok_flag
)paren
r_for
c_loop
(paren
id|i
op_assign
(paren
id|skb-&gt;len
op_plus
l_int|3
)paren
op_amp
op_complement
l_int|3
suffix:semicolon
id|i
OL
id|HP100_MIN_PACKET_SIZE
suffix:semicolon
id|i
op_add_assign
l_int|4
)paren
id|hp100_outl
c_func
(paren
l_int|0
comma
id|DATA32
)paren
suffix:semicolon
)brace
id|hp100_outb
c_func
(paren
id|HP100_TX_CMD
op_or
id|HP100_SET_LB
comma
id|OPTION_MSW
)paren
suffix:semicolon
multiline_comment|/* send packet */
id|lp-&gt;stats.tx_packets
op_increment
suffix:semicolon
macro_line|#ifdef LINUX_2_1
id|lp-&gt;stats.tx_bytes
op_add_assign
id|skb-&gt;len
suffix:semicolon
macro_line|#endif
id|dev-&gt;trans_start
op_assign
id|jiffies
suffix:semicolon
id|hp100_ints_on
c_func
(paren
)paren
suffix:semicolon
id|dev_kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
macro_line|#ifdef HP100_DEBUG_TX
id|printk
c_func
(paren
l_string|&quot;hp100_start_xmit: end&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
r_return
l_int|0
suffix:semicolon
)brace
"&f;"
multiline_comment|/*&n; * Receive Function (Non-Busmaster mode)&n; * Called when an &quot;Receive Packet&quot; interrupt occurs, i.e. the receive &n; * packet counter is non-zero.&n; * For non-busmaster, this function does the whole work of transfering&n; * the packet to the host memory and then up to higher layers via skb&n; * and netif_rx. &n; */
DECL|function|hp100_rx
r_static
r_void
id|hp100_rx
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
r_int
id|packets
comma
id|pkt_len
suffix:semicolon
r_int
id|ioaddr
op_assign
id|dev-&gt;base_addr
suffix:semicolon
r_struct
id|hp100_private
op_star
id|lp
op_assign
(paren
r_struct
id|hp100_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|u_int
id|header
suffix:semicolon
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
macro_line|#ifdef DEBUG_B
id|hp100_outw
c_func
(paren
l_int|0x4213
comma
id|TRACE
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;hp100: rx&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/* First get indication of received lan packet */
multiline_comment|/* RX_PKT_CND indicates the number of packets which have been fully */
multiline_comment|/* received onto the card but have not been fully transfered of the card */
id|packets
op_assign
id|hp100_inb
c_func
(paren
id|RX_PKT_CNT
)paren
suffix:semicolon
macro_line|#ifdef HP100_DEBUG_RX
r_if
c_cond
(paren
id|packets
OG
l_int|1
)paren
id|printk
c_func
(paren
l_string|&quot;hp100_rx: waiting packets = %d&bslash;n&quot;
comma
id|packets
)paren
suffix:semicolon
macro_line|#endif
r_while
c_loop
(paren
id|packets
op_decrement
OG
l_int|0
)paren
(brace
multiline_comment|/* If ADV_NXT_PKT is still set, we have to wait until the card has */
multiline_comment|/* really advanced to the next packet. */
r_for
c_loop
(paren
id|pkt_len
op_assign
l_int|0
suffix:semicolon
id|pkt_len
OL
l_int|6000
op_logical_and
(paren
id|hp100_inb
c_func
(paren
id|OPTION_MSW
)paren
op_amp
id|HP100_ADV_NXT_PKT
)paren
suffix:semicolon
id|pkt_len
op_increment
)paren
(brace
macro_line|#ifdef HP100_DEBUG_RX
id|printk
c_func
(paren
l_string|&quot;hp100_rx: busy, remaining packets = %d&bslash;n&quot;
comma
id|packets
)paren
suffix:semicolon
macro_line|#endif
)brace
multiline_comment|/* First we get the header, which contains information about the */
multiline_comment|/* actual length of the received packet. */
r_if
c_cond
(paren
id|lp-&gt;mode
op_eq
l_int|2
)paren
(brace
multiline_comment|/* memory mapped mode */
r_if
c_cond
(paren
id|lp-&gt;mem_ptr_virt
)paren
multiline_comment|/* if memory was remapped */
id|header
op_assign
op_star
(paren
id|__u32
op_star
)paren
id|lp-&gt;mem_ptr_virt
suffix:semicolon
r_else
id|header
op_assign
id|readl
c_func
(paren
id|lp-&gt;mem_ptr_phys
)paren
suffix:semicolon
)brace
r_else
multiline_comment|/* programmed i/o */
id|header
op_assign
id|hp100_inl
c_func
(paren
id|DATA32
)paren
suffix:semicolon
id|pkt_len
op_assign
id|header
op_amp
id|HP100_PKT_LEN_MASK
suffix:semicolon
macro_line|#ifdef HP100_DEBUG_RX
id|printk
c_func
(paren
l_string|&quot;hp100_rx: new packet - length=%d, errors=0x%x, dest=0x%x&bslash;n&quot;
comma
id|header
op_amp
id|HP100_PKT_LEN_MASK
comma
(paren
id|header
op_rshift
l_int|16
)paren
op_amp
l_int|0xfff8
comma
(paren
id|header
op_rshift
l_int|16
)paren
op_amp
l_int|7
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/* Now we allocate the skb and transfer the data into it. */
multiline_comment|/* NOTE! This (and the skb_put() below) depends on the skb-functions&n;&t;&t; * allocating more than asked (notably, aligning the request up to&n;&t;&t; * the next 16-byte length).&n;&t;&t; */
id|skb
op_assign
id|dev_alloc_skb
c_func
(paren
id|pkt_len
)paren
suffix:semicolon
r_if
c_cond
(paren
id|skb
op_eq
l_int|NULL
)paren
(brace
multiline_comment|/* Not enough memory-&gt;drop packet */
macro_line|#ifdef HP100_DEBUG
id|printk
c_func
(paren
l_string|&quot;hp100_rx: couldn&squot;t allocate a sk_buff of size %d&bslash;n&quot;
comma
id|pkt_len
)paren
suffix:semicolon
macro_line|#endif
id|lp-&gt;stats.rx_dropped
op_increment
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* skb successfully allocated */
id|u_char
op_star
id|ptr
suffix:semicolon
id|skb-&gt;dev
op_assign
id|dev
suffix:semicolon
multiline_comment|/* ptr to start of the sk_buff data area */
id|ptr
op_assign
(paren
id|u_char
op_star
)paren
id|skb_put
c_func
(paren
id|skb
comma
id|pkt_len
)paren
suffix:semicolon
multiline_comment|/* Now transfer the data from the card into that area */
r_if
c_cond
(paren
id|lp-&gt;mode
op_eq
l_int|2
)paren
(brace
r_if
c_cond
(paren
id|lp-&gt;mem_ptr_virt
)paren
id|memcpy
c_func
(paren
id|ptr
comma
id|lp-&gt;mem_ptr_virt
comma
(paren
id|pkt_len
op_plus
l_int|3
)paren
op_amp
op_complement
l_int|3
)paren
suffix:semicolon
multiline_comment|/* Note alignment to 32bit transfers */
r_else
id|memcpy_fromio
c_func
(paren
id|ptr
comma
id|lp-&gt;mem_ptr_phys
comma
(paren
id|pkt_len
op_plus
l_int|3
)paren
op_amp
op_complement
l_int|3
)paren
suffix:semicolon
)brace
r_else
multiline_comment|/* io mapped */
id|insl
c_func
(paren
id|ioaddr
op_plus
id|HP100_REG_DATA32
comma
id|ptr
comma
(paren
id|pkt_len
op_plus
l_int|3
)paren
op_rshift
l_int|2
)paren
suffix:semicolon
id|skb-&gt;protocol
op_assign
id|eth_type_trans
c_func
(paren
id|skb
comma
id|dev
)paren
suffix:semicolon
id|netif_rx
c_func
(paren
id|skb
)paren
suffix:semicolon
id|lp-&gt;stats.rx_packets
op_increment
suffix:semicolon
macro_line|#ifdef LINUX_2_1
id|lp-&gt;stats.rx_bytes
op_add_assign
id|skb-&gt;len
suffix:semicolon
macro_line|#endif
macro_line|#ifdef HP100_DEBUG_RX
id|printk
c_func
(paren
l_string|&quot;rx: %02x %02x %02x %02x %02x %02x %02x %02x %02x %02x %02x %02x&bslash;n&quot;
comma
id|ptr
(braket
l_int|0
)braket
comma
id|ptr
(braket
l_int|1
)braket
comma
id|ptr
(braket
l_int|2
)braket
comma
id|ptr
(braket
l_int|3
)braket
comma
id|ptr
(braket
l_int|4
)braket
comma
id|ptr
(braket
l_int|5
)braket
comma
id|ptr
(braket
l_int|6
)braket
comma
id|ptr
(braket
l_int|7
)braket
comma
id|ptr
(braket
l_int|8
)braket
comma
id|ptr
(braket
l_int|9
)braket
comma
id|ptr
(braket
l_int|10
)braket
comma
id|ptr
(braket
l_int|11
)braket
)paren
suffix:semicolon
macro_line|#endif
)brace
multiline_comment|/* Indicate the card that we have got the packet */
id|hp100_outb
c_func
(paren
id|HP100_ADV_NXT_PKT
op_or
id|HP100_SET_LB
comma
id|OPTION_MSW
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|header
op_amp
l_int|0x00070000
)paren
(brace
r_case
(paren
id|HP100_MULTI_ADDR_HASH
op_lshift
l_int|16
)paren
suffix:colon
r_case
(paren
id|HP100_MULTI_ADDR_NO_HASH
op_lshift
l_int|16
)paren
suffix:colon
id|lp-&gt;stats.multicast
op_increment
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
multiline_comment|/* end of while(there are packets) loop */
macro_line|#ifdef HP100_DEBUG_RX
id|printk
c_func
(paren
l_string|&quot;hp100_rx: end&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
)brace
"&f;"
multiline_comment|/* &n; * Receive Function for Busmaster Mode&n; */
DECL|function|hp100_rx_bm
r_static
r_void
id|hp100_rx_bm
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
r_int
id|ioaddr
op_assign
id|dev-&gt;base_addr
suffix:semicolon
r_struct
id|hp100_private
op_star
id|lp
op_assign
(paren
r_struct
id|hp100_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|hp100_ring_t
op_star
id|ptr
suffix:semicolon
id|u_int
id|header
suffix:semicolon
r_int
id|pkt_len
suffix:semicolon
macro_line|#ifdef HP100_DEBUG_B
id|hp100_outw
c_func
(paren
l_int|0x4214
comma
id|TRACE
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;hp100: rx_bm&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
macro_line|#ifdef HP100_DEBUG
r_if
c_cond
(paren
l_int|0
op_eq
id|lp-&gt;rxrcommit
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;hp100: rx_bm called although no PDLs were committed to adapter?&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_else
multiline_comment|/* RX_PKT_CNT states how many PDLs are currently formatted and available to &n;&t;&t; * the cards BM engine */
r_if
c_cond
(paren
(paren
id|hp100_inw
c_func
(paren
id|RX_PKT_CNT
)paren
op_amp
l_int|0x00ff
)paren
op_ge
id|lp-&gt;rxrcommit
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;hp100: More packets received than commited? RX_PKT_CNT=0x%x, commit=0x%x&bslash;n&quot;
comma
id|hp100_inw
c_func
(paren
id|RX_PKT_CNT
)paren
op_amp
l_int|0x00ff
comma
id|lp-&gt;rxrcommit
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
macro_line|#endif
r_while
c_loop
(paren
(paren
id|lp-&gt;rxrcommit
OG
id|hp100_inb
c_func
(paren
id|RX_PDL
)paren
)paren
)paren
(brace
multiline_comment|/*&n;&t;&t; * The packet was received into the pdl pointed to by lp-&gt;rxrhead (&n;&t;&t; * the oldest pdl in the ring &n;&t;&t; */
multiline_comment|/* First we get the header, which contains information about the */
multiline_comment|/* actual length of the received packet. */
id|ptr
op_assign
id|lp-&gt;rxrhead
suffix:semicolon
id|header
op_assign
op_star
(paren
id|ptr-&gt;pdl
op_minus
l_int|1
)paren
suffix:semicolon
id|pkt_len
op_assign
(paren
id|header
op_amp
id|HP100_PKT_LEN_MASK
)paren
suffix:semicolon
macro_line|#ifdef HP100_DEBUG_BM
id|printk
c_func
(paren
l_string|&quot;hp100: rx_bm: header@0x%x=0x%x length=%d, errors=0x%x, dest=0x%x&bslash;n&quot;
comma
(paren
id|u_int
)paren
(paren
id|ptr-&gt;pdl
op_minus
l_int|1
)paren
comma
(paren
id|u_int
)paren
id|header
comma
id|pkt_len
comma
(paren
id|header
op_rshift
l_int|16
)paren
op_amp
l_int|0xfff8
comma
(paren
id|header
op_rshift
l_int|16
)paren
op_amp
l_int|7
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;hp100: RX_PDL_COUNT:0x%x TX_PDL_COUNT:0x%x, RX_PKT_CNT=0x%x PDH=0x%x, Data@0x%x len=0x%x&bslash;n&quot;
comma
id|hp100_inb
c_func
(paren
id|RX_PDL
)paren
comma
id|hp100_inb
c_func
(paren
id|TX_PDL
)paren
comma
id|hp100_inb
c_func
(paren
id|RX_PKT_CNT
)paren
comma
(paren
id|u_int
)paren
op_star
(paren
id|ptr-&gt;pdl
)paren
comma
(paren
id|u_int
)paren
op_star
(paren
id|ptr-&gt;pdl
op_plus
l_int|3
)paren
comma
(paren
id|u_int
)paren
op_star
(paren
id|ptr-&gt;pdl
op_plus
l_int|4
)paren
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
(paren
id|pkt_len
op_ge
id|MIN_ETHER_SIZE
)paren
op_logical_and
(paren
id|pkt_len
op_le
id|MAX_ETHER_SIZE
)paren
)paren
(brace
r_if
c_cond
(paren
id|ptr-&gt;skb
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;hp100: rx_bm: skb null&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* can happen if we only allocated room for the pdh due to memory shortage. */
id|lp-&gt;stats.rx_dropped
op_increment
suffix:semicolon
)brace
r_else
(brace
id|skb_trim
c_func
(paren
id|ptr-&gt;skb
comma
id|pkt_len
)paren
suffix:semicolon
multiline_comment|/* Shorten it */
id|ptr-&gt;skb-&gt;protocol
op_assign
id|eth_type_trans
c_func
(paren
id|ptr-&gt;skb
comma
id|dev
)paren
suffix:semicolon
id|netif_rx
c_func
(paren
id|ptr-&gt;skb
)paren
suffix:semicolon
multiline_comment|/* Up and away... */
id|lp-&gt;stats.rx_packets
op_increment
suffix:semicolon
macro_line|#ifdef LINUX_2_1
id|lp-&gt;stats.rx_bytes
op_add_assign
id|ptr-&gt;skb-&gt;len
suffix:semicolon
macro_line|#endif
)brace
r_switch
c_cond
(paren
id|header
op_amp
l_int|0x00070000
)paren
(brace
r_case
(paren
id|HP100_MULTI_ADDR_HASH
op_lshift
l_int|16
)paren
suffix:colon
r_case
(paren
id|HP100_MULTI_ADDR_NO_HASH
op_lshift
l_int|16
)paren
suffix:colon
id|lp-&gt;stats.multicast
op_increment
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
r_else
(brace
macro_line|#ifdef HP100_DEBUG
id|printk
c_func
(paren
l_string|&quot;hp100: rx_bm: Received bad packet (length=%d)&bslash;n&quot;
comma
id|pkt_len
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|ptr-&gt;skb
op_ne
l_int|NULL
)paren
id|dev_kfree_skb
c_func
(paren
id|ptr-&gt;skb
)paren
suffix:semicolon
id|lp-&gt;stats.rx_errors
op_increment
suffix:semicolon
)brace
id|lp-&gt;rxrhead
op_assign
id|lp-&gt;rxrhead-&gt;next
suffix:semicolon
multiline_comment|/* Allocate a new rx PDL (so lp-&gt;rxrcommit stays the same) */
r_if
c_cond
(paren
l_int|0
op_eq
id|hp100_build_rx_pdl
c_func
(paren
id|lp-&gt;rxrtail
comma
id|dev
)paren
)paren
(brace
multiline_comment|/* No space for skb, header can still be received. */
macro_line|#ifdef HP100_DEBUG
id|printk
c_func
(paren
l_string|&quot;hp100: rx_bm: No space for new PDL.&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
r_return
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* successfully allocated new PDL - put it in ringlist at tail. */
id|hp100_outl
c_func
(paren
(paren
id|u32
)paren
id|lp-&gt;rxrtail-&gt;pdl_paddr
comma
id|RX_PDA
)paren
suffix:semicolon
id|lp-&gt;rxrtail
op_assign
id|lp-&gt;rxrtail-&gt;next
suffix:semicolon
)brace
)brace
)brace
"&f;"
multiline_comment|/*&n; *  statistics&n; */
DECL|function|hp100_get_stats
r_static
id|hp100_stats_t
op_star
id|hp100_get_stats
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
r_int
id|ioaddr
op_assign
id|dev-&gt;base_addr
suffix:semicolon
macro_line|#ifdef HP100_DEBUG_B
id|hp100_outw
c_func
(paren
l_int|0x4215
comma
id|TRACE
)paren
suffix:semicolon
macro_line|#endif
id|hp100_ints_off
c_func
(paren
)paren
suffix:semicolon
id|hp100_update_stats
c_func
(paren
id|dev
)paren
suffix:semicolon
id|hp100_ints_on
c_func
(paren
)paren
suffix:semicolon
r_return
op_amp
(paren
(paren
r_struct
id|hp100_private
op_star
)paren
id|dev-&gt;priv
)paren
op_member_access_from_pointer
id|stats
suffix:semicolon
)brace
DECL|function|hp100_update_stats
r_static
r_void
id|hp100_update_stats
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
r_int
id|ioaddr
op_assign
id|dev-&gt;base_addr
suffix:semicolon
id|u_short
id|val
suffix:semicolon
r_struct
id|hp100_private
op_star
id|lp
op_assign
(paren
r_struct
id|hp100_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
macro_line|#ifdef HP100_DEBUG_B
id|hp100_outw
c_func
(paren
l_int|0x4216
comma
id|TRACE
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;hp100: update-stats&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/* Note: Statistics counters clear when read. */
id|hp100_page
c_func
(paren
id|MAC_CTRL
)paren
suffix:semicolon
id|val
op_assign
id|hp100_inw
c_func
(paren
id|DROPPED
)paren
op_amp
l_int|0x0fff
suffix:semicolon
id|lp-&gt;stats.rx_errors
op_add_assign
id|val
suffix:semicolon
id|lp-&gt;stats.rx_over_errors
op_add_assign
id|val
suffix:semicolon
id|val
op_assign
id|hp100_inb
c_func
(paren
id|CRC
)paren
suffix:semicolon
id|lp-&gt;stats.rx_errors
op_add_assign
id|val
suffix:semicolon
id|lp-&gt;stats.rx_crc_errors
op_add_assign
id|val
suffix:semicolon
id|val
op_assign
id|hp100_inb
c_func
(paren
id|ABORT
)paren
suffix:semicolon
id|lp-&gt;stats.tx_errors
op_add_assign
id|val
suffix:semicolon
id|lp-&gt;stats.tx_aborted_errors
op_add_assign
id|val
suffix:semicolon
id|hp100_page
c_func
(paren
id|PERFORMANCE
)paren
suffix:semicolon
)brace
DECL|function|hp100_clear_stats
r_static
r_void
id|hp100_clear_stats
c_func
(paren
r_int
id|ioaddr
)paren
(brace
macro_line|#ifdef HP100_DEBUG_B
id|hp100_outw
c_func
(paren
l_int|0x4217
comma
id|TRACE
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;hp100: clear_stats&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
id|cli
c_func
(paren
)paren
suffix:semicolon
id|hp100_page
c_func
(paren
id|MAC_CTRL
)paren
suffix:semicolon
multiline_comment|/* get all statistics bytes */
id|hp100_inw
c_func
(paren
id|DROPPED
)paren
suffix:semicolon
id|hp100_inb
c_func
(paren
id|CRC
)paren
suffix:semicolon
id|hp100_inb
c_func
(paren
id|ABORT
)paren
suffix:semicolon
id|hp100_page
c_func
(paren
id|PERFORMANCE
)paren
suffix:semicolon
id|sti
c_func
(paren
)paren
suffix:semicolon
)brace
"&f;"
multiline_comment|/*&n; *  multicast setup&n; */
multiline_comment|/*&n; *  Set or clear the multicast filter for this adapter.&n; *  TODO: Currently when in multicast mode, card accepts all multicast packets&n; *        for all MC addresses. Should better use the list on the card.&n; */
DECL|function|hp100_set_multicast_list
r_static
r_void
id|hp100_set_multicast_list
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
r_int
id|ioaddr
op_assign
id|dev-&gt;base_addr
suffix:semicolon
r_struct
id|hp100_private
op_star
id|lp
op_assign
(paren
r_struct
id|hp100_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
macro_line|#ifdef HP100_DEBUG_B
id|hp100_outw
c_func
(paren
l_int|0x4218
comma
id|TRACE
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;hp100: set_mc_list&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
id|cli
c_func
(paren
)paren
suffix:semicolon
id|hp100_ints_off
c_func
(paren
)paren
suffix:semicolon
id|hp100_page
c_func
(paren
id|MAC_CTRL
)paren
suffix:semicolon
id|hp100_andb
c_func
(paren
op_complement
(paren
id|HP100_RX_EN
op_or
id|HP100_TX_EN
)paren
comma
id|MAC_CFG_1
)paren
suffix:semicolon
multiline_comment|/* stop rx/tx */
r_if
c_cond
(paren
id|dev-&gt;flags
op_amp
id|IFF_PROMISC
)paren
(brace
id|lp-&gt;mac2_mode
op_assign
id|HP100_MAC2MODE6
suffix:semicolon
multiline_comment|/* promiscuous mode = get all good */
id|lp-&gt;mac1_mode
op_assign
id|HP100_MAC1MODE6
suffix:semicolon
multiline_comment|/* packets on the net */
)brace
r_else
r_if
c_cond
(paren
id|dev-&gt;mc_count
op_logical_or
(paren
id|dev-&gt;flags
op_amp
id|IFF_ALLMULTI
)paren
)paren
(brace
id|lp-&gt;mac2_mode
op_assign
id|HP100_MAC2MODE5
suffix:semicolon
multiline_comment|/* multicast mode = get packets for */
id|lp-&gt;mac1_mode
op_assign
id|HP100_MAC1MODE5
suffix:semicolon
multiline_comment|/* me, broadcasts and all multicasts */
)brace
r_else
(brace
id|lp-&gt;mac2_mode
op_assign
id|HP100_MAC2MODE3
suffix:semicolon
multiline_comment|/* normal mode = get packets for me */
id|lp-&gt;mac1_mode
op_assign
id|HP100_MAC1MODE3
suffix:semicolon
multiline_comment|/* and broadcasts */
)brace
r_if
c_cond
(paren
(paren
(paren
id|hp100_inb
c_func
(paren
id|MAC_CFG_1
)paren
op_amp
l_int|0x0f
)paren
op_ne
id|lp-&gt;mac1_mode
)paren
op_logical_or
(paren
id|hp100_inb
c_func
(paren
id|MAC_CFG_2
)paren
op_ne
id|lp-&gt;mac2_mode
)paren
)paren
(brace
id|hp100_outb
c_func
(paren
id|lp-&gt;mac2_mode
comma
id|MAC_CFG_2
)paren
suffix:semicolon
id|hp100_andb
c_func
(paren
id|HP100_MAC1MODEMASK
comma
id|MAC_CFG_1
)paren
suffix:semicolon
multiline_comment|/* clear mac1 mode bits */
id|hp100_orb
c_func
(paren
id|lp-&gt;mac1_mode
comma
id|MAC_CFG_1
)paren
suffix:semicolon
multiline_comment|/* and set the new mode */
r_if
c_cond
(paren
id|lp-&gt;lan_type
op_eq
id|HP100_LAN_100
)paren
(brace
macro_line|#ifdef HP100_DEBUG
id|printk
c_func
(paren
l_string|&quot;hp100: 100VG MAC settings have changed - relogin.&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
id|lp-&gt;hub_status
op_assign
id|hp100_login_to_vg_hub
c_func
(paren
id|dev
comma
id|TRUE
)paren
suffix:semicolon
multiline_comment|/* force a relogin to the hub */
)brace
)brace
id|hp100_page
c_func
(paren
id|MAC_CTRL
)paren
suffix:semicolon
id|hp100_orb
c_func
(paren
id|HP100_RX_EN
op_or
id|HP100_RX_IDLE
op_or
multiline_comment|/* enable rx */
id|HP100_TX_EN
op_or
id|HP100_TX_IDLE
comma
id|MAC_CFG_1
)paren
suffix:semicolon
multiline_comment|/* enable tx */
id|hp100_page
c_func
(paren
id|PERFORMANCE
)paren
suffix:semicolon
id|hp100_ints_on
c_func
(paren
)paren
suffix:semicolon
id|sti
c_func
(paren
)paren
suffix:semicolon
)brace
"&f;"
multiline_comment|/*&n; *  hardware interrupt handling&n; */
DECL|function|hp100_interrupt
r_static
r_void
id|hp100_interrupt
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_struct
id|device
op_star
id|dev
op_assign
id|dev_id
suffix:semicolon
r_struct
id|hp100_private
op_star
id|lp
op_assign
(paren
r_struct
id|hp100_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_int
id|ioaddr
suffix:semicolon
id|u_int
id|val
suffix:semicolon
r_if
c_cond
(paren
id|dev
op_eq
l_int|NULL
)paren
r_return
suffix:semicolon
id|ioaddr
op_assign
id|dev-&gt;base_addr
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;interrupt
)paren
id|printk
c_func
(paren
l_string|&quot;%s: re-entering the interrupt handler&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|hp100_ints_off
c_func
(paren
)paren
suffix:semicolon
id|dev-&gt;interrupt
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* mark that we are inside the handler */
macro_line|#ifdef HP100_DEBUG_B
id|hp100_outw
c_func
(paren
l_int|0x4219
comma
id|TRACE
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/*  hp100_page( PERFORMANCE ); */
id|val
op_assign
id|hp100_inw
c_func
(paren
id|IRQ_STATUS
)paren
suffix:semicolon
macro_line|#ifdef HP100_DEBUG_IRQ
id|printk
c_func
(paren
l_string|&quot;hp100: mode=%x,IRQ_STAT=0x%.4x,RXPKTCNT=0x%.2x RXPDL=0x%.2x TXPKTCNT=0x%.2x TXPDL=0x%.2x&bslash;n&quot;
comma
id|lp-&gt;mode
comma
(paren
id|u_int
)paren
id|val
comma
id|hp100_inb
c_func
(paren
id|RX_PKT_CNT
)paren
comma
id|hp100_inb
c_func
(paren
id|RX_PDL
)paren
comma
id|hp100_inb
c_func
(paren
id|TX_PKT_CNT
)paren
comma
id|hp100_inb
c_func
(paren
id|TX_PDL
)paren
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|val
op_eq
l_int|0
)paren
(brace
multiline_comment|/* might be a shared interrupt */
id|dev-&gt;interrupt
op_assign
l_int|0
suffix:semicolon
id|hp100_ints_on
c_func
(paren
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/* We&squot;re only interested in those interrupts we really enabled. */
multiline_comment|/* val &amp;= hp100_inw( IRQ_MASK ); */
multiline_comment|/* &n;&t; * RX_PDL_FILL_COMPL is set whenever a RX_PDL has been executed. A RX_PDL &n;&t; * is considered executed whenever the RX_PDL data structure is no longer &n;&t; * needed.&n;&t; */
r_if
c_cond
(paren
id|val
op_amp
id|HP100_RX_PDL_FILL_COMPL
)paren
(brace
r_if
c_cond
(paren
id|lp-&gt;mode
op_eq
l_int|1
)paren
id|hp100_rx_bm
c_func
(paren
id|dev
)paren
suffix:semicolon
r_else
id|printk
c_func
(paren
l_string|&quot;hp100: rx_pdl_fill_compl interrupt although not busmaster?&bslash;n&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/* &n;&t; * The RX_PACKET interrupt is set, when the receive packet counter is&n;&t; * non zero. We use this interrupt for receiving in slave mode. In&n;&t; * busmaster mode, we use it to make sure we did not miss any rx_pdl_fill&n;&t; * interrupts. If rx_pdl_fill_compl is not set and rx_packet is set, then&n;&t; * we somehow have missed a rx_pdl_fill_compl interrupt.&n;&t; */
r_if
c_cond
(paren
id|val
op_amp
id|HP100_RX_PACKET
)paren
(brace
multiline_comment|/* Receive Packet Counter is non zero */
r_if
c_cond
(paren
id|lp-&gt;mode
op_ne
l_int|1
)paren
multiline_comment|/* non busmaster */
id|hp100_rx
c_func
(paren
id|dev
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
op_logical_neg
(paren
id|val
op_amp
id|HP100_RX_PDL_FILL_COMPL
)paren
)paren
(brace
multiline_comment|/* Shouldnt happen - maybe we missed a RX_PDL_FILL Interrupt?  */
id|hp100_rx_bm
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/*&n;&t; * Ack. that we have noticed the interrupt and thereby allow next one.&n;&t; * Note that this is now done after the slave rx function, since first&n;&t; * acknowledging and then setting ADV_NXT_PKT caused an extra interrupt&n;&t; * on the J2573.&n;&t; */
id|hp100_outw
c_func
(paren
id|val
comma
id|IRQ_STATUS
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * RX_ERROR is set when a packet is dropped due to no memory resources on &n;&t; * the card or when a RCV_ERR occurs. &n;&t; * TX_ERROR is set when a TX_ABORT condition occurs in the MAC-&gt;exists  &n;&t; * only in the 802.3 MAC and happens when 16 collisions occur during a TX &n;&t; */
r_if
c_cond
(paren
id|val
op_amp
(paren
id|HP100_TX_ERROR
op_or
id|HP100_RX_ERROR
)paren
)paren
(brace
macro_line|#ifdef HP100_DEBUG_IRQ
id|printk
c_func
(paren
l_string|&quot;hp100: TX/RX Error IRQ&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
id|hp100_update_stats
c_func
(paren
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|lp-&gt;mode
op_eq
l_int|1
)paren
(brace
id|hp100_rxfill
c_func
(paren
id|dev
)paren
suffix:semicolon
id|hp100_clean_txring
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* &n;&t; * RX_PDA_ZERO is set when the PDA count goes from non-zero to zero. &n;&t; */
r_if
c_cond
(paren
(paren
id|lp-&gt;mode
op_eq
l_int|1
)paren
op_logical_and
(paren
id|val
op_amp
(paren
id|HP100_RX_PDA_ZERO
)paren
)paren
)paren
id|hp100_rxfill
c_func
(paren
id|dev
)paren
suffix:semicolon
multiline_comment|/* &n;&t; * HP100_TX_COMPLETE interrupt occurs when packet transmitted on wire &n;&t; * is completed &n;&t; */
r_if
c_cond
(paren
(paren
id|lp-&gt;mode
op_eq
l_int|1
)paren
op_logical_and
(paren
id|val
op_amp
(paren
id|HP100_TX_COMPLETE
)paren
)paren
)paren
id|hp100_clean_txring
c_func
(paren
id|dev
)paren
suffix:semicolon
multiline_comment|/* &n;&t; * MISC_ERROR is set when either the LAN link goes down or a detected&n;&t; * bus error occurs.&n;&t; */
r_if
c_cond
(paren
id|val
op_amp
id|HP100_MISC_ERROR
)paren
(brace
multiline_comment|/* New for J2585B */
id|printk
c_func
(paren
l_string|&quot;hp100: Misc. Error Interrupt - Check cabling.&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|lp-&gt;mode
op_eq
l_int|1
)paren
(brace
id|hp100_clean_txring
c_func
(paren
id|dev
)paren
suffix:semicolon
id|hp100_rxfill
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
)brace
id|dev-&gt;interrupt
op_assign
l_int|0
suffix:semicolon
id|hp100_ints_on
c_func
(paren
)paren
suffix:semicolon
)brace
"&f;"
multiline_comment|/*&n; *  some misc functions&n; */
DECL|function|hp100_start_interface
r_static
r_void
id|hp100_start_interface
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
r_int
id|ioaddr
op_assign
id|dev-&gt;base_addr
suffix:semicolon
r_struct
id|hp100_private
op_star
id|lp
op_assign
(paren
r_struct
id|hp100_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
macro_line|#ifdef HP100_DEBUG_B
id|hp100_outw
c_func
(paren
l_int|0x4220
comma
id|TRACE
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;hp100: hp100_start_interface %s&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
macro_line|#endif
id|cli
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* Ensure the adapter does not want to request an interrupt when */
multiline_comment|/* enabling the IRQ line to be active on the bus (i.e. not tri-stated) */
id|hp100_page
c_func
(paren
id|PERFORMANCE
)paren
suffix:semicolon
id|hp100_outw
c_func
(paren
l_int|0xfefe
comma
id|IRQ_MASK
)paren
suffix:semicolon
multiline_comment|/* mask off all ints */
id|hp100_outw
c_func
(paren
l_int|0xffff
comma
id|IRQ_STATUS
)paren
suffix:semicolon
multiline_comment|/* ack all IRQs */
id|hp100_outw
c_func
(paren
id|HP100_FAKE_INT
op_or
id|HP100_INT_EN
op_or
id|HP100_RESET_LB
comma
id|OPTION_LSW
)paren
suffix:semicolon
multiline_comment|/* Un Tri-state int. TODO: Check if shared interrupts can be realised? */
id|hp100_outw
c_func
(paren
id|HP100_TRI_INT
op_or
id|HP100_RESET_HB
comma
id|OPTION_LSW
)paren
suffix:semicolon
r_if
c_cond
(paren
id|lp-&gt;mode
op_eq
l_int|1
)paren
(brace
multiline_comment|/* Make sure BM bit is set... */
id|hp100_page
c_func
(paren
id|HW_MAP
)paren
suffix:semicolon
id|hp100_orb
c_func
(paren
id|HP100_BM_MASTER
comma
id|BM
)paren
suffix:semicolon
id|hp100_rxfill
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|lp-&gt;mode
op_eq
l_int|2
)paren
(brace
multiline_comment|/* Enable memory mapping. Note: Don&squot;t do this when busmaster. */
id|hp100_outw
c_func
(paren
id|HP100_MMAP_DIS
op_or
id|HP100_RESET_HB
comma
id|OPTION_LSW
)paren
suffix:semicolon
)brace
id|hp100_page
c_func
(paren
id|PERFORMANCE
)paren
suffix:semicolon
id|hp100_outw
c_func
(paren
l_int|0xfefe
comma
id|IRQ_MASK
)paren
suffix:semicolon
multiline_comment|/* mask off all ints */
id|hp100_outw
c_func
(paren
l_int|0xffff
comma
id|IRQ_STATUS
)paren
suffix:semicolon
multiline_comment|/* ack IRQ */
multiline_comment|/* enable a few interrupts: */
r_if
c_cond
(paren
id|lp-&gt;mode
op_eq
l_int|1
)paren
(brace
multiline_comment|/* busmaster mode */
id|hp100_outw
c_func
(paren
id|HP100_RX_PDL_FILL_COMPL
op_or
id|HP100_RX_PDA_ZERO
op_or
id|HP100_RX_ERROR
op_or
multiline_comment|/* HP100_RX_PACKET    | */
multiline_comment|/* HP100_RX_EARLY_INT |  */
id|HP100_SET_HB
op_or
multiline_comment|/* HP100_TX_PDA_ZERO  |  */
id|HP100_TX_COMPLETE
op_or
multiline_comment|/* HP100_MISC_ERROR   |  */
id|HP100_TX_ERROR
op_or
id|HP100_SET_LB
comma
id|IRQ_MASK
)paren
suffix:semicolon
)brace
r_else
(brace
id|hp100_outw
c_func
(paren
id|HP100_RX_PACKET
op_or
id|HP100_RX_ERROR
op_or
id|HP100_SET_HB
op_or
id|HP100_TX_ERROR
op_or
id|HP100_SET_LB
comma
id|IRQ_MASK
)paren
suffix:semicolon
)brace
multiline_comment|/* Enable MAC Tx and RX, set MAC modes, ... */
multiline_comment|/* Note: This function also turns on the interrupts. */
id|hp100_set_multicast_list
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
"&f;"
DECL|function|hp100_stop_interface
r_static
r_void
id|hp100_stop_interface
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
r_struct
id|hp100_private
op_star
id|lp
op_assign
(paren
r_struct
id|hp100_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_int
id|ioaddr
op_assign
id|dev-&gt;base_addr
suffix:semicolon
id|u_int
id|val
suffix:semicolon
macro_line|#ifdef HP100_DEBUG_B
id|printk
c_func
(paren
l_string|&quot;hp100: hp100_stop_interface %s&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|hp100_outw
c_func
(paren
l_int|0x4221
comma
id|TRACE
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|lp-&gt;mode
op_eq
l_int|1
)paren
id|hp100_BM_shutdown
c_func
(paren
id|dev
)paren
suffix:semicolon
r_else
(brace
multiline_comment|/* Note: MMAP_DIS will be reenabled by start_interface */
id|hp100_outw
c_func
(paren
id|HP100_INT_EN
op_or
id|HP100_RESET_LB
op_or
id|HP100_TRI_INT
op_or
id|HP100_MMAP_DIS
op_or
id|HP100_SET_HB
comma
id|OPTION_LSW
)paren
suffix:semicolon
id|val
op_assign
id|hp100_inw
c_func
(paren
id|OPTION_LSW
)paren
suffix:semicolon
id|hp100_page
c_func
(paren
id|MAC_CTRL
)paren
suffix:semicolon
id|hp100_andb
c_func
(paren
op_complement
(paren
id|HP100_RX_EN
op_or
id|HP100_TX_EN
)paren
comma
id|MAC_CFG_1
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|val
op_amp
id|HP100_HW_RST
)paren
)paren
r_return
suffix:semicolon
multiline_comment|/* If reset, imm. return ... */
multiline_comment|/* ... else: busy wait until idle */
r_for
c_loop
(paren
id|val
op_assign
l_int|0
suffix:semicolon
id|val
OL
l_int|6000
suffix:semicolon
id|val
op_increment
)paren
r_if
c_cond
(paren
(paren
id|hp100_inb
c_func
(paren
id|MAC_CFG_1
)paren
op_amp
(paren
id|HP100_TX_IDLE
op_or
id|HP100_RX_IDLE
)paren
)paren
op_eq
(paren
id|HP100_TX_IDLE
op_or
id|HP100_RX_IDLE
)paren
)paren
(brace
id|hp100_page
c_func
(paren
id|PERFORMANCE
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;%s: hp100_stop_interface - timeout&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|hp100_page
c_func
(paren
id|PERFORMANCE
)paren
suffix:semicolon
)brace
)brace
"&f;"
DECL|function|hp100_load_eeprom
r_static
r_void
id|hp100_load_eeprom
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
r_int
id|i
suffix:semicolon
r_int
id|ioaddr
op_assign
id|dev-&gt;base_addr
suffix:semicolon
macro_line|#ifdef HP100_DEBUG_B
id|hp100_outw
c_func
(paren
l_int|0x4222
comma
id|TRACE
)paren
suffix:semicolon
macro_line|#endif
id|hp100_page
c_func
(paren
id|EEPROM_CTRL
)paren
suffix:semicolon
id|hp100_andw
c_func
(paren
op_complement
id|HP100_EEPROM_LOAD
comma
id|EEPROM_CTRL
)paren
suffix:semicolon
id|hp100_orw
c_func
(paren
id|HP100_EEPROM_LOAD
comma
id|EEPROM_CTRL
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|10000
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
op_logical_neg
(paren
id|hp100_inb
c_func
(paren
id|OPTION_MSW
)paren
op_amp
id|HP100_EE_LOAD
)paren
)paren
r_return
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;%s: hp100_load_eeprom - timeout&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
)brace
"&f;"
multiline_comment|/*  Sense connection status.&n; *  return values: LAN_10  - Connected to 10Mbit/s network&n; *                 LAN_100 - Connected to 100Mbit/s network&n; *                 LAN_ERR - not connected or 100Mbit/s Hub down&n; */
DECL|function|hp100_sense_lan
r_static
r_int
id|hp100_sense_lan
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
r_int
id|ioaddr
op_assign
id|dev-&gt;base_addr
suffix:semicolon
id|u_short
id|val_VG
comma
id|val_10
suffix:semicolon
r_struct
id|hp100_private
op_star
id|lp
op_assign
(paren
r_struct
id|hp100_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
macro_line|#ifdef HP100_DEBUG_B
id|hp100_outw
c_func
(paren
l_int|0x4223
comma
id|TRACE
)paren
suffix:semicolon
macro_line|#endif
id|hp100_page
c_func
(paren
id|MAC_CTRL
)paren
suffix:semicolon
multiline_comment|/* Enable Auto Selection */
multiline_comment|/* hp100_orb( HP100_VG_RESET|HP100_LINK_CMD|HP100_VG_SEL, VG_LAN_CFG_1 ); */
multiline_comment|/* hp100_orb( HP100_DOT3_MAC,10_LAN_CFG_2); */
multiline_comment|/* hp100_orb( HP100_AUTO_MODE,MAC_CFG_3); */
multiline_comment|/* Now we have to wait a while... */
multiline_comment|/* for(i=0; i&lt;5000; i++) */
multiline_comment|/* { */
id|val_10
op_assign
id|hp100_inb
c_func
(paren
l_int|10
id|_LAN_CFG_1
)paren
suffix:semicolon
id|val_VG
op_assign
id|hp100_inb
c_func
(paren
id|VG_LAN_CFG_1
)paren
suffix:semicolon
multiline_comment|/* } */
macro_line|#ifdef HP100_DEBUG
id|printk
c_func
(paren
l_string|&quot;hp100_sense_lan: val_VG = 0x%04x, val_10 = 0x%04x&bslash;n&quot;
comma
id|val_VG
comma
id|val_10
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|val_10
op_amp
id|HP100_LINK_BEAT_ST
)paren
r_return
id|HP100_LAN_10
suffix:semicolon
r_if
c_cond
(paren
(paren
id|lp-&gt;id-&gt;id
op_eq
l_int|0x02019F022
)paren
op_logical_or
(paren
id|lp-&gt;id-&gt;id
op_eq
l_int|0x01042103c
)paren
op_logical_or
(paren
id|lp-&gt;id-&gt;id
op_eq
l_int|0x01040103c
)paren
)paren
(brace
id|hp100_page
c_func
(paren
id|PERFORMANCE
)paren
suffix:semicolon
r_return
id|HP100_LAN_ERR
suffix:semicolon
multiline_comment|/* Those cards don&squot;t have a 100 Mbit connector */
)brace
multiline_comment|/* for ( i = 0; i &lt; 2500; i++ ) */
multiline_comment|/*     { */
id|val_VG
op_assign
id|hp100_inb
c_func
(paren
id|VG_LAN_CFG_1
)paren
suffix:semicolon
id|hp100_page
c_func
(paren
id|PERFORMANCE
)paren
suffix:semicolon
r_if
c_cond
(paren
id|val_VG
op_amp
id|HP100_LINK_CABLE_ST
)paren
multiline_comment|/* Can hear the HUBs tone. */
r_return
id|HP100_LAN_100
suffix:semicolon
multiline_comment|/*   } */
r_return
id|HP100_LAN_ERR
suffix:semicolon
)brace
"&f;"
DECL|function|hp100_down_vg_link
r_static
r_int
id|hp100_down_vg_link
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
r_struct
id|hp100_private
op_star
id|lp
op_assign
(paren
r_struct
id|hp100_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_int
id|ioaddr
op_assign
id|dev-&gt;base_addr
suffix:semicolon
r_int
r_int
id|time
suffix:semicolon
r_int
id|savelan
comma
id|newlan
suffix:semicolon
macro_line|#ifdef HP100_DEBUG_B
id|hp100_outw
c_func
(paren
l_int|0x4224
comma
id|TRACE
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;hp100: down_vg_link&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
id|hp100_page
c_func
(paren
id|MAC_CTRL
)paren
suffix:semicolon
id|time
op_assign
id|jiffies
op_plus
(paren
id|HZ
op_div
l_int|4
)paren
suffix:semicolon
r_do
(brace
r_if
c_cond
(paren
id|hp100_inb
c_func
(paren
id|VG_LAN_CFG_1
)paren
op_amp
id|HP100_LINK_CABLE_ST
)paren
r_break
suffix:semicolon
)brace
r_while
c_loop
(paren
id|time
OG
id|jiffies
)paren
suffix:semicolon
r_if
c_cond
(paren
id|jiffies
op_ge
id|time
)paren
multiline_comment|/* no signal-&gt;no logout */
r_return
l_int|0
suffix:semicolon
multiline_comment|/* Drop the VG Link by clearing the link up cmd and load addr. */
id|hp100_andb
c_func
(paren
op_complement
(paren
id|HP100_LOAD_ADDR
op_or
id|HP100_LINK_CMD
)paren
comma
id|VG_LAN_CFG_1
)paren
suffix:semicolon
id|hp100_orb
c_func
(paren
id|HP100_VG_SEL
comma
id|VG_LAN_CFG_1
)paren
suffix:semicolon
multiline_comment|/* Conditionally stall for &gt;250ms on Link-Up Status (to go down) */
id|time
op_assign
id|jiffies
op_plus
(paren
id|HZ
op_div
l_int|2
)paren
suffix:semicolon
r_do
(brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|hp100_inb
c_func
(paren
id|VG_LAN_CFG_1
)paren
op_amp
id|HP100_LINK_UP_ST
)paren
)paren
r_break
suffix:semicolon
)brace
r_while
c_loop
(paren
id|time
OG
id|jiffies
)paren
suffix:semicolon
macro_line|#ifdef HP100_DEBUG
r_if
c_cond
(paren
id|jiffies
op_ge
id|time
)paren
id|printk
c_func
(paren
l_string|&quot;hp100_down_vg_link: Link does not go down?&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/* To prevent condition where Rev 1 VG MAC and old hubs do not complete */
multiline_comment|/* logout under traffic (even though all the status bits are cleared),  */
multiline_comment|/* do this workaround to get the Rev 1 MAC in its idle state */
r_if
c_cond
(paren
id|lp-&gt;chip
op_eq
id|HP100_CHIPID_LASSEN
)paren
(brace
multiline_comment|/* Reset VG MAC to insure it leaves the logoff state even if */
multiline_comment|/* the Hub is still emitting tones */
id|hp100_andb
c_func
(paren
op_complement
id|HP100_VG_RESET
comma
id|VG_LAN_CFG_1
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|1500
)paren
suffix:semicolon
multiline_comment|/* wait for &gt;1ms */
id|hp100_orb
c_func
(paren
id|HP100_VG_RESET
comma
id|VG_LAN_CFG_1
)paren
suffix:semicolon
multiline_comment|/* Release Reset */
id|udelay
c_func
(paren
l_int|1500
)paren
suffix:semicolon
)brace
multiline_comment|/* New: For lassen, switch to 10 Mbps mac briefly to clear training ACK */
multiline_comment|/* to get the VG mac to full reset. This is not req.d with later chips */
multiline_comment|/* Note: It will take the between 1 and 2 seconds for the VG mac to be */
multiline_comment|/* selected again! This will be left to the connect hub function to */
multiline_comment|/* perform if desired.  */
r_if
c_cond
(paren
id|lp-&gt;chip
op_eq
id|HP100_CHIPID_LASSEN
)paren
(brace
multiline_comment|/* Have to write to 10 and 100VG control registers simultaneously */
id|savelan
op_assign
id|newlan
op_assign
id|hp100_inl
c_func
(paren
l_int|10
id|_LAN_CFG_1
)paren
suffix:semicolon
multiline_comment|/* read 10+100 LAN_CFG regs */
id|newlan
op_and_assign
op_complement
(paren
id|HP100_VG_SEL
op_lshift
l_int|16
)paren
suffix:semicolon
id|newlan
op_or_assign
(paren
id|HP100_DOT3_MAC
)paren
op_lshift
l_int|8
suffix:semicolon
id|hp100_andb
c_func
(paren
op_complement
id|HP100_AUTO_MODE
comma
id|MAC_CFG_3
)paren
suffix:semicolon
multiline_comment|/* Autosel off */
id|hp100_outl
c_func
(paren
id|newlan
comma
l_int|10
id|_LAN_CFG_1
)paren
suffix:semicolon
multiline_comment|/* Conditionally stall for 5sec on VG selected. */
id|time
op_assign
id|jiffies
op_plus
(paren
id|HZ
op_star
l_int|5
)paren
suffix:semicolon
r_do
(brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|hp100_inb
c_func
(paren
id|MAC_CFG_4
)paren
op_amp
id|HP100_MAC_SEL_ST
)paren
)paren
r_break
suffix:semicolon
)brace
r_while
c_loop
(paren
id|time
OG
id|jiffies
)paren
suffix:semicolon
id|hp100_orb
c_func
(paren
id|HP100_AUTO_MODE
comma
id|MAC_CFG_3
)paren
suffix:semicolon
multiline_comment|/* Autosel back on */
id|hp100_outl
c_func
(paren
id|savelan
comma
l_int|10
id|_LAN_CFG_1
)paren
suffix:semicolon
)brace
id|time
op_assign
id|jiffies
op_plus
(paren
l_int|3
op_star
id|HZ
)paren
suffix:semicolon
multiline_comment|/* Timeout 3s */
r_do
(brace
r_if
c_cond
(paren
(paren
id|hp100_inb
c_func
(paren
id|VG_LAN_CFG_1
)paren
op_amp
id|HP100_LINK_CABLE_ST
)paren
op_eq
l_int|0
)paren
r_break
suffix:semicolon
)brace
r_while
c_loop
(paren
id|time
OG
id|jiffies
)paren
suffix:semicolon
r_if
c_cond
(paren
id|time
op_le
id|jiffies
)paren
(brace
macro_line|#ifdef HP100_DEBUG
id|printk
c_func
(paren
l_string|&quot;hp100_down_vg_link: timeout&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
r_return
op_minus
id|EIO
suffix:semicolon
)brace
id|time
op_assign
id|jiffies
op_plus
(paren
l_int|2
op_star
id|HZ
)paren
suffix:semicolon
multiline_comment|/* This seems to take a while.... */
r_do
(brace
)brace
r_while
c_loop
(paren
id|time
OG
id|jiffies
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
"&f;"
DECL|function|hp100_login_to_vg_hub
r_static
r_int
id|hp100_login_to_vg_hub
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
id|u_short
id|force_relogin
)paren
(brace
r_int
id|ioaddr
op_assign
id|dev-&gt;base_addr
suffix:semicolon
r_struct
id|hp100_private
op_star
id|lp
op_assign
(paren
r_struct
id|hp100_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|u_short
id|val
op_assign
l_int|0
suffix:semicolon
r_int
r_int
id|time
suffix:semicolon
r_int
id|startst
suffix:semicolon
macro_line|#ifdef HP100_DEBUG_B
id|hp100_outw
c_func
(paren
l_int|0x4225
comma
id|TRACE
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;hp100: login_to_vg_hub&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/* Initiate a login sequence iff VG MAC is enabled and either Load Address&n;&t; * bit is zero or the force relogin flag is set (e.g. due to MAC address or&n;&t; * promiscuous mode change)&n;&t; */
id|hp100_page
c_func
(paren
id|MAC_CTRL
)paren
suffix:semicolon
id|startst
op_assign
id|hp100_inb
c_func
(paren
id|VG_LAN_CFG_1
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|force_relogin
op_eq
id|TRUE
)paren
op_logical_or
(paren
id|hp100_inb
c_func
(paren
id|MAC_CFG_4
)paren
op_amp
id|HP100_MAC_SEL_ST
)paren
)paren
(brace
macro_line|#ifdef HP100_DEBUG_TRAINING
id|printk
c_func
(paren
l_string|&quot;hp100: Start training&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/* Ensure VG Reset bit is 1 (i.e., do not reset) */
id|hp100_orb
c_func
(paren
id|HP100_VG_RESET
comma
id|VG_LAN_CFG_1
)paren
suffix:semicolon
multiline_comment|/* If Lassen AND auto-select-mode AND VG tones were sensed on */
multiline_comment|/* entry then temporarily put them into force 100Mbit mode */
r_if
c_cond
(paren
(paren
id|lp-&gt;chip
op_eq
id|HP100_CHIPID_LASSEN
)paren
op_logical_and
(paren
id|startst
op_amp
id|HP100_LINK_CABLE_ST
)paren
)paren
id|hp100_andb
c_func
(paren
op_complement
id|HP100_DOT3_MAC
comma
l_int|10
id|_LAN_CFG_2
)paren
suffix:semicolon
multiline_comment|/* Drop the VG link by zeroing Link Up Command and Load Address  */
id|hp100_andb
c_func
(paren
op_complement
(paren
id|HP100_LINK_CMD
multiline_comment|/* |HP100_LOAD_ADDR */
)paren
comma
id|VG_LAN_CFG_1
)paren
suffix:semicolon
macro_line|#ifdef HP100_DEBUG_TRAINING
id|printk
c_func
(paren
l_string|&quot;hp100: Bring down the link&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/* Wait for link to drop */
id|time
op_assign
id|jiffies
op_plus
(paren
id|HZ
op_div
l_int|10
)paren
suffix:semicolon
r_do
(brace
r_if
c_cond
(paren
op_complement
(paren
id|hp100_inb
c_func
(paren
id|VG_LAN_CFG_1
)paren
op_amp
id|HP100_LINK_UP_ST
)paren
)paren
r_break
suffix:semicolon
)brace
r_while
c_loop
(paren
id|time
OG
id|jiffies
)paren
suffix:semicolon
multiline_comment|/* Start an addressed training and optionally request promiscuous port */
r_if
c_cond
(paren
(paren
id|dev-&gt;flags
)paren
op_amp
id|IFF_PROMISC
)paren
(brace
id|hp100_orb
c_func
(paren
id|HP100_PROM_MODE
comma
id|VG_LAN_CFG_2
)paren
suffix:semicolon
r_if
c_cond
(paren
id|lp-&gt;chip
op_eq
id|HP100_CHIPID_LASSEN
)paren
id|hp100_orw
c_func
(paren
id|HP100_MACRQ_PROMSC
comma
id|TRAIN_REQUEST
)paren
suffix:semicolon
)brace
r_else
(brace
id|hp100_andb
c_func
(paren
op_complement
id|HP100_PROM_MODE
comma
id|VG_LAN_CFG_2
)paren
suffix:semicolon
multiline_comment|/* For ETR parts we need to reset the prom. bit in the training&n;&t;&t;&t; * register, otherwise promiscious mode won&squot;t be disabled.&n;&t;&t;&t; */
r_if
c_cond
(paren
id|lp-&gt;chip
op_eq
id|HP100_CHIPID_LASSEN
)paren
(brace
id|hp100_andw
c_func
(paren
op_complement
id|HP100_MACRQ_PROMSC
comma
id|TRAIN_REQUEST
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* With ETR parts, frame format request bits can be set. */
r_if
c_cond
(paren
id|lp-&gt;chip
op_eq
id|HP100_CHIPID_LASSEN
)paren
id|hp100_orb
c_func
(paren
id|HP100_MACRQ_FRAMEFMT_EITHER
comma
id|TRAIN_REQUEST
)paren
suffix:semicolon
id|hp100_orb
c_func
(paren
id|HP100_LINK_CMD
op_or
id|HP100_LOAD_ADDR
op_or
id|HP100_VG_RESET
comma
id|VG_LAN_CFG_1
)paren
suffix:semicolon
multiline_comment|/* Note: Next wait could be omitted for Hood and earlier chips under */
multiline_comment|/* certain circumstances */
multiline_comment|/* TODO: check if hood/earlier and skip wait. */
multiline_comment|/* Wait for either short timeout for VG tones or long for login    */
multiline_comment|/* Wait for the card hardware to signalise link cable status ok... */
id|hp100_page
c_func
(paren
id|MAC_CTRL
)paren
suffix:semicolon
id|time
op_assign
id|jiffies
op_plus
(paren
l_int|1
op_star
id|HZ
)paren
suffix:semicolon
multiline_comment|/* 1 sec timeout for cable st */
r_do
(brace
r_if
c_cond
(paren
id|hp100_inb
c_func
(paren
id|VG_LAN_CFG_1
)paren
op_amp
id|HP100_LINK_CABLE_ST
)paren
r_break
suffix:semicolon
)brace
r_while
c_loop
(paren
id|jiffies
OL
id|time
)paren
suffix:semicolon
r_if
c_cond
(paren
id|jiffies
op_ge
id|time
)paren
(brace
macro_line|#ifdef HP100_DEBUG_TRAINING
id|printk
c_func
(paren
l_string|&quot;hp100: Link cable status not ok? Training aborted.&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
)brace
r_else
(brace
macro_line|#ifdef HP100_DEBUG_TRAINING
id|printk
c_func
(paren
l_string|&quot;hp100: HUB tones detected. Trying to train.&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
id|time
op_assign
id|jiffies
op_plus
(paren
l_int|2
op_star
id|HZ
)paren
suffix:semicolon
multiline_comment|/* again a timeout */
r_do
(brace
id|val
op_assign
id|hp100_inb
c_func
(paren
id|VG_LAN_CFG_1
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|val
op_amp
(paren
id|HP100_LINK_UP_ST
)paren
)paren
)paren
(brace
macro_line|#ifdef HP100_DEBUG_TRAINING
id|printk
c_func
(paren
l_string|&quot;hp100: Passed training.&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
r_break
suffix:semicolon
)brace
)brace
r_while
c_loop
(paren
id|time
OG
id|jiffies
)paren
suffix:semicolon
)brace
multiline_comment|/* If LINK_UP_ST is set, then we are logged into the hub. */
r_if
c_cond
(paren
(paren
id|jiffies
op_le
id|time
)paren
op_logical_and
(paren
id|val
op_amp
id|HP100_LINK_UP_ST
)paren
)paren
(brace
macro_line|#ifdef HP100_DEBUG_TRAINING
id|printk
c_func
(paren
l_string|&quot;hp100: Successfully logged into the HUB.&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|lp-&gt;chip
op_eq
id|HP100_CHIPID_LASSEN
)paren
(brace
id|val
op_assign
id|hp100_inw
c_func
(paren
id|TRAIN_ALLOW
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;hp100: Card supports 100VG MAC Version &bslash;&quot;%s&bslash;&quot; &quot;
comma
(paren
id|hp100_inw
c_func
(paren
id|TRAIN_REQUEST
)paren
op_amp
id|HP100_CARD_MACVER
)paren
ques
c_cond
l_string|&quot;802.12&quot;
suffix:colon
l_string|&quot;Pre&quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;Driver will use MAC Version &bslash;&quot;%s&bslash;&quot;&bslash;n&quot;
comma
(paren
id|val
op_amp
id|HP100_HUB_MACVER
)paren
ques
c_cond
l_string|&quot;802.12&quot;
suffix:colon
l_string|&quot;Pre&quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;hp100: Frame format is %s.&bslash;n&quot;
comma
(paren
id|val
op_amp
id|HP100_MALLOW_FRAMEFMT
)paren
ques
c_cond
l_string|&quot;802.5&quot;
suffix:colon
l_string|&quot;802.3&quot;
)paren
suffix:semicolon
)brace
macro_line|#endif
)brace
r_else
(brace
multiline_comment|/* If LINK_UP_ST is not set, login was not successful */
id|printk
c_func
(paren
l_string|&quot;hp100/%s: Problem logging into the HUB.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_if
c_cond
(paren
id|lp-&gt;chip
op_eq
id|HP100_CHIPID_LASSEN
)paren
(brace
multiline_comment|/* Check allowed Register to find out why there is a problem. */
id|val
op_assign
id|hp100_inw
c_func
(paren
id|TRAIN_ALLOW
)paren
suffix:semicolon
multiline_comment|/* wont work on non-ETR card */
macro_line|#ifdef HP100_DEBUG_TRAINING
id|printk
c_func
(paren
l_string|&quot;hp100: MAC Configuration requested: 0x%04x, HUB allowed: 0x%04x&bslash;n&quot;
comma
id|hp100_inw
c_func
(paren
id|TRAIN_REQUEST
)paren
comma
id|val
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|val
op_amp
id|HP100_MALLOW_ACCDENIED
)paren
id|printk
c_func
(paren
l_string|&quot;hp100: HUB access denied.&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|val
op_amp
id|HP100_MALLOW_CONFIGURE
)paren
id|printk
c_func
(paren
l_string|&quot;hp100: MAC Configuration is incompatible with the Network.&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|val
op_amp
id|HP100_MALLOW_DUPADDR
)paren
id|printk
c_func
(paren
l_string|&quot;hp100: Duplicate MAC Address on the Network.&bslash;n&quot;
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* If we have put the chip into forced 100 Mbit mode earlier, go back */
multiline_comment|/* to auto-select mode */
r_if
c_cond
(paren
(paren
id|lp-&gt;chip
op_eq
id|HP100_CHIPID_LASSEN
)paren
op_logical_and
(paren
id|startst
op_amp
id|HP100_LINK_CABLE_ST
)paren
)paren
(brace
id|hp100_page
c_func
(paren
id|MAC_CTRL
)paren
suffix:semicolon
id|hp100_orb
c_func
(paren
id|HP100_DOT3_MAC
comma
l_int|10
id|_LAN_CFG_2
)paren
suffix:semicolon
)brace
id|val
op_assign
id|hp100_inb
c_func
(paren
id|VG_LAN_CFG_1
)paren
suffix:semicolon
multiline_comment|/* Clear the MISC_ERROR Interrupt, which might be generated when doing the relogin */
id|hp100_page
c_func
(paren
id|PERFORMANCE
)paren
suffix:semicolon
id|hp100_outw
c_func
(paren
id|HP100_MISC_ERROR
comma
id|IRQ_STATUS
)paren
suffix:semicolon
r_if
c_cond
(paren
id|val
op_amp
id|HP100_LINK_UP_ST
)paren
r_return
(paren
l_int|0
)paren
suffix:semicolon
multiline_comment|/* login was ok */
r_else
(brace
id|printk
c_func
(paren
l_string|&quot;hp100: Training failed.&bslash;n&quot;
)paren
suffix:semicolon
id|hp100_down_vg_link
c_func
(paren
id|dev
)paren
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
)brace
multiline_comment|/* no forced relogin &amp; already link there-&gt;no training. */
r_return
op_minus
id|EIO
suffix:semicolon
)brace
"&f;"
DECL|function|hp100_cascade_reset
r_static
r_void
id|hp100_cascade_reset
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
id|u_short
id|enable
)paren
(brace
r_int
id|ioaddr
op_assign
id|dev-&gt;base_addr
suffix:semicolon
r_struct
id|hp100_private
op_star
id|lp
op_assign
(paren
r_struct
id|hp100_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_int
id|i
suffix:semicolon
macro_line|#ifdef HP100_DEBUG_B
id|hp100_outw
c_func
(paren
l_int|0x4226
comma
id|TRACE
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;hp100: cascade_reset&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|enable
op_eq
id|TRUE
)paren
(brace
id|hp100_outw
c_func
(paren
id|HP100_HW_RST
op_or
id|HP100_RESET_LB
comma
id|OPTION_LSW
)paren
suffix:semicolon
r_if
c_cond
(paren
id|lp-&gt;chip
op_eq
id|HP100_CHIPID_LASSEN
)paren
(brace
multiline_comment|/* Lassen requires a PCI transmit fifo reset */
id|hp100_page
c_func
(paren
id|HW_MAP
)paren
suffix:semicolon
id|hp100_andb
c_func
(paren
op_complement
id|HP100_PCI_RESET
comma
id|PCICTRL2
)paren
suffix:semicolon
id|hp100_orb
c_func
(paren
id|HP100_PCI_RESET
comma
id|PCICTRL2
)paren
suffix:semicolon
multiline_comment|/* Wait for min. 300 ns */
multiline_comment|/* we cant use jiffies here, because it may be */
multiline_comment|/* that we have disabled the timer... */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|0xffff
suffix:semicolon
id|i
op_increment
)paren
suffix:semicolon
id|hp100_andb
c_func
(paren
op_complement
id|HP100_PCI_RESET
comma
id|PCICTRL2
)paren
suffix:semicolon
id|hp100_page
c_func
(paren
id|PERFORMANCE
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
multiline_comment|/* bring out of reset */
id|hp100_outw
c_func
(paren
id|HP100_HW_RST
op_or
id|HP100_SET_LB
comma
id|OPTION_LSW
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|0xffff
suffix:semicolon
id|i
op_increment
)paren
suffix:semicolon
id|hp100_page
c_func
(paren
id|PERFORMANCE
)paren
suffix:semicolon
)brace
)brace
macro_line|#ifdef HP100_DEBUG
DECL|function|hp100_RegisterDump
r_void
id|hp100_RegisterDump
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
r_int
id|ioaddr
op_assign
id|dev-&gt;base_addr
suffix:semicolon
r_int
id|Page
suffix:semicolon
r_int
id|Register
suffix:semicolon
multiline_comment|/* Dump common registers */
id|printk
c_func
(paren
l_string|&quot;hp100: Cascade Register Dump&bslash;n&quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;hardware id #1: 0x%.2x&bslash;n&quot;
comma
id|hp100_inb
c_func
(paren
id|HW_ID
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;hardware id #2/paging: 0x%.2x&bslash;n&quot;
comma
id|hp100_inb
c_func
(paren
id|PAGING
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;option #1: 0x%.4x&bslash;n&quot;
comma
id|hp100_inw
c_func
(paren
id|OPTION_LSW
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;option #2: 0x%.4x&bslash;n&quot;
comma
id|hp100_inw
c_func
(paren
id|OPTION_MSW
)paren
)paren
suffix:semicolon
multiline_comment|/* Dump paged registers */
r_for
c_loop
(paren
id|Page
op_assign
l_int|0
suffix:semicolon
id|Page
OL
l_int|8
suffix:semicolon
id|Page
op_increment
)paren
(brace
multiline_comment|/* Dump registers */
id|printk
c_func
(paren
l_string|&quot;page: 0x%.2x&bslash;n&quot;
comma
id|Page
)paren
suffix:semicolon
id|outw
c_func
(paren
id|Page
comma
id|ioaddr
op_plus
l_int|0x02
)paren
suffix:semicolon
r_for
c_loop
(paren
id|Register
op_assign
l_int|0x8
suffix:semicolon
id|Register
OL
l_int|0x22
suffix:semicolon
id|Register
op_add_assign
l_int|2
)paren
(brace
multiline_comment|/* Display Register contents except data port */
r_if
c_cond
(paren
(paren
(paren
id|Register
op_ne
l_int|0x10
)paren
op_logical_and
(paren
id|Register
op_ne
l_int|0x12
)paren
)paren
op_logical_or
(paren
id|Page
OG
l_int|0
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;0x%.2x = 0x%.4x&bslash;n&quot;
comma
id|Register
comma
id|inw
c_func
(paren
id|ioaddr
op_plus
id|Register
)paren
)paren
suffix:semicolon
)brace
)brace
)brace
id|hp100_page
c_func
(paren
id|PERFORMANCE
)paren
suffix:semicolon
)brace
macro_line|#endif
"&f;"
multiline_comment|/*&n; *  module section&n; */
macro_line|#ifdef MODULE
multiline_comment|/* Parameters set by insmod */
DECL|variable|hp100_port
r_int
id|hp100_port
(braket
l_int|5
)braket
op_assign
(brace
l_int|0
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
)brace
suffix:semicolon
macro_line|#ifdef LINUX_2_1
id|MODULE_PARM
c_func
(paren
id|hp100_port
comma
l_string|&quot;1-5i&quot;
)paren
suffix:semicolon
macro_line|#endif
macro_line|#ifdef LINUX_2_1
DECL|variable|hp100_name
r_char
id|hp100_name
(braket
l_int|5
)braket
(braket
id|IFNAMSIZ
)braket
op_assign
(brace
l_string|&quot;&quot;
comma
l_string|&quot;&quot;
comma
l_string|&quot;&quot;
comma
l_string|&quot;&quot;
comma
l_string|&quot;&quot;
)brace
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|hp100_name
comma
l_string|&quot;1-5c&quot;
id|__MODULE_STRING
c_func
(paren
id|IFNAMSIZ
)paren
)paren
suffix:semicolon
macro_line|#else
DECL|variable|devname
r_static
r_char
id|devname
(braket
l_int|5
)braket
(braket
id|IFNAMSIZ
)braket
op_assign
(brace
l_string|&quot;&quot;
comma
l_string|&quot;&quot;
comma
l_string|&quot;&quot;
comma
l_string|&quot;&quot;
comma
l_string|&quot;&quot;
)brace
suffix:semicolon
DECL|variable|hp100_name
r_static
r_char
op_star
id|hp100_name
(braket
l_int|5
)braket
op_assign
(brace
id|devname
(braket
l_int|0
)braket
comma
id|devname
(braket
l_int|1
)braket
comma
id|devname
(braket
l_int|2
)braket
comma
id|devname
(braket
l_int|3
)braket
comma
id|devname
(braket
l_int|4
)braket
)brace
suffix:semicolon
macro_line|#endif
multiline_comment|/* List of devices */
DECL|variable|hp100_devlist
r_static
r_struct
id|device
op_star
id|hp100_devlist
(braket
l_int|5
)braket
op_assign
(brace
l_int|NULL
comma
l_int|NULL
comma
l_int|NULL
comma
l_int|NULL
comma
l_int|NULL
)brace
suffix:semicolon
multiline_comment|/*&n; * Note: if you have more than five 100vg cards in your pc, feel free to&n; * increase this value &n; */
multiline_comment|/*&n; * Note: to register three eisa or pci devices, use:&n; * option hp100 hp100_port=0,0,0&n; *        to register one card at io 0x280 as eth239, use:&n; * option hp100 hp100_port=0x280 hp100_name=eth239&n; */
DECL|function|init_module
r_int
id|init_module
c_func
(paren
r_void
)paren
(brace
r_int
id|i
suffix:semicolon
r_int
id|ret
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|hp100_port
op_eq
l_int|0
op_logical_and
op_logical_neg
id|EISA_bus
op_logical_and
op_logical_neg
id|pcibios_present
c_func
(paren
)paren
)paren
id|printk
c_func
(paren
l_string|&quot;HP100: You should not use auto-probing with insmod!&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* Loop on all possible base addresses */
id|i
op_assign
op_minus
l_int|1
suffix:semicolon
r_while
c_loop
(paren
(paren
id|hp100_port
(braket
op_increment
id|i
)braket
op_ne
op_minus
l_int|1
)paren
op_logical_and
(paren
id|i
OL
l_int|5
)paren
)paren
(brace
multiline_comment|/* Create device and set basics args */
id|hp100_devlist
(braket
id|i
)braket
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|device
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
id|memset
c_func
(paren
id|hp100_devlist
(braket
id|i
)braket
comma
l_int|0x00
comma
r_sizeof
(paren
r_struct
id|device
)paren
)paren
suffix:semicolon
id|hp100_devlist
(braket
id|i
)braket
op_member_access_from_pointer
id|name
op_assign
id|hp100_name
(braket
id|i
)braket
suffix:semicolon
id|hp100_devlist
(braket
id|i
)braket
op_member_access_from_pointer
id|base_addr
op_assign
id|hp100_port
(braket
id|i
)braket
suffix:semicolon
id|hp100_devlist
(braket
id|i
)braket
op_member_access_from_pointer
id|init
op_assign
op_amp
id|hp100_probe
suffix:semicolon
multiline_comment|/* Try to create the device */
r_if
c_cond
(paren
id|register_netdev
c_func
(paren
id|hp100_devlist
(braket
id|i
)braket
)paren
op_ne
l_int|0
)paren
(brace
multiline_comment|/* DeAllocate everything */
multiline_comment|/* Note: if dev-&gt;priv is mallocated, there is no way to fail */
id|kfree_s
c_func
(paren
id|hp100_devlist
(braket
id|i
)braket
comma
r_sizeof
(paren
r_struct
id|device
)paren
)paren
suffix:semicolon
id|hp100_devlist
(braket
id|i
)braket
op_assign
(paren
r_struct
id|device
op_star
)paren
l_int|NULL
suffix:semicolon
id|ret
op_assign
op_minus
id|EIO
suffix:semicolon
)brace
)brace
multiline_comment|/* Loop over all devices */
r_return
id|ret
suffix:semicolon
)brace
DECL|function|cleanup_module
r_void
id|cleanup_module
c_func
(paren
r_void
)paren
(brace
r_int
id|i
suffix:semicolon
multiline_comment|/* TODO: Check if all skb&squot;s are released/freed. */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|5
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
id|hp100_devlist
(braket
id|i
)braket
op_ne
(paren
r_struct
id|device
op_star
)paren
l_int|NULL
)paren
(brace
id|unregister_netdev
c_func
(paren
id|hp100_devlist
(braket
id|i
)braket
)paren
suffix:semicolon
id|release_region
c_func
(paren
id|hp100_devlist
(braket
id|i
)braket
op_member_access_from_pointer
id|base_addr
comma
id|HP100_REGION_SIZE
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
(paren
r_struct
id|hp100_private
op_star
)paren
id|hp100_devlist
(braket
id|i
)braket
op_member_access_from_pointer
id|priv
)paren
op_member_access_from_pointer
id|mode
op_eq
l_int|1
)paren
multiline_comment|/* busmaster */
id|kfree_s
c_func
(paren
(paren
(paren
r_struct
id|hp100_private
op_star
)paren
id|hp100_devlist
(braket
id|i
)braket
op_member_access_from_pointer
id|priv
)paren
op_member_access_from_pointer
id|page_vaddr
comma
id|MAX_RINGSIZE
op_plus
l_int|0x0f
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
(paren
r_struct
id|hp100_private
op_star
)paren
id|hp100_devlist
(braket
id|i
)braket
op_member_access_from_pointer
id|priv
)paren
op_member_access_from_pointer
id|mem_ptr_virt
)paren
id|iounmap
c_func
(paren
(paren
(paren
r_struct
id|hp100_private
op_star
)paren
id|hp100_devlist
(braket
id|i
)braket
op_member_access_from_pointer
id|priv
)paren
op_member_access_from_pointer
id|mem_ptr_virt
)paren
suffix:semicolon
id|kfree_s
c_func
(paren
id|hp100_devlist
(braket
id|i
)braket
op_member_access_from_pointer
id|priv
comma
r_sizeof
(paren
r_struct
id|hp100_private
)paren
)paren
suffix:semicolon
id|hp100_devlist
(braket
id|i
)braket
op_member_access_from_pointer
id|priv
op_assign
l_int|NULL
suffix:semicolon
id|kfree_s
c_func
(paren
id|hp100_devlist
(braket
id|i
)braket
comma
r_sizeof
(paren
r_struct
id|device
)paren
)paren
suffix:semicolon
id|hp100_devlist
(braket
id|i
)braket
op_assign
(paren
r_struct
id|device
op_star
)paren
l_int|NULL
suffix:semicolon
)brace
)brace
macro_line|#endif&t;&t;&t;&t;/* MODULE */
"&f;"
multiline_comment|/*&n; * Local variables:&n; *  compile-command: &quot;gcc -D__KERNEL__ -I/usr/src/linux/net/inet -Wall -Wstrict-prototypes -O6 -m486 -c hp100.c&quot;&n; *  c-indent-level: 2&n; *  tab-width: 8&n; * End:&n; */
eof
