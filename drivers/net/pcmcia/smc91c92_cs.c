multiline_comment|/*======================================================================&n;&n;    A PCMCIA ethernet driver for SMC91c92-based cards.&n;&n;    This driver supports Megahertz PCMCIA ethernet cards; and&n;    Megahertz, Motorola, Ositech, and Psion Dacom ethernet/modem&n;    multifunction cards.&n;&n;    Copyright (C) 1999 David A. Hinds -- dahinds@users.sourceforge.net&n;&n;    smc91c92_cs.c 1.104 2000/08/31 21:25:13&n;    &n;    This driver contains code written by Donald Becker&n;    (becker@cesdis.gsfc.nasa.gov), Rowan Hughes (x-csrdh@jcu.edu.au),&n;    David Hinds (dahinds@users.sourceforge.net), and Erik Stahlman&n;    (erik@vt.edu).  Donald wrote the SMC 91c92 code using parts of&n;    Erik&squot;s SMC 91c94 driver.  Rowan wrote a similar driver, and I&squot;ve&n;    incorporated some parts of his driver here.  I (Dave) wrote most&n;    of the PCMCIA glue code, and the Ositech support code.  Kelly&n;    Stephens (kstephen@holli.com) added support for the Motorola&n;    Mariner, with help from Allen Brost. &n;&n;    This software may be used and distributed according to the terms of&n;    the GNU Public License, incorporated herein by reference.&n;&n;======================================================================*/
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/malloc.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/timer.h&gt;
macro_line|#include &lt;linux/interrupt.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/system.h&gt;
macro_line|#include &lt;linux/netdevice.h&gt;
macro_line|#include &lt;linux/etherdevice.h&gt;
macro_line|#include &lt;linux/skbuff.h&gt;
macro_line|#include &lt;linux/if_arp.h&gt;
macro_line|#include &lt;linux/ioport.h&gt;
macro_line|#include &lt;pcmcia/version.h&gt;
macro_line|#include &lt;pcmcia/cs_types.h&gt;
macro_line|#include &lt;pcmcia/cs.h&gt;
macro_line|#include &lt;pcmcia/cistpl.h&gt;
macro_line|#include &lt;pcmcia/cisreg.h&gt;
macro_line|#include &lt;pcmcia/ciscode.h&gt;
macro_line|#include &lt;pcmcia/ds.h&gt;
multiline_comment|/* Ositech Seven of Diamonds firmware */
macro_line|#include &quot;ositech.h&quot;
multiline_comment|/*====================================================================*/
macro_line|#ifdef PCMCIA_DEBUG
DECL|variable|pc_debug
r_static
r_int
id|pc_debug
op_assign
id|PCMCIA_DEBUG
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|pc_debug
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
DECL|variable|version
r_static
r_const
r_char
op_star
id|version
op_assign
l_string|&quot;smc91c92_cs.c 0.09 1996/8/4 Donald Becker, becker@cesdis.gsfc.nasa.gov.&bslash;n&quot;
suffix:semicolon
DECL|macro|DEBUG
mdefine_line|#define DEBUG(n, args...) if (pc_debug&gt;(n)) printk(KERN_DEBUG args)
macro_line|#else
DECL|macro|DEBUG
mdefine_line|#define DEBUG(n, args...)
macro_line|#endif
DECL|variable|if_names
r_static
r_char
op_star
id|if_names
(braket
)braket
op_assign
(brace
l_string|&quot;auto&quot;
comma
l_string|&quot;10baseT&quot;
comma
l_string|&quot;10base2&quot;
)brace
suffix:semicolon
multiline_comment|/* Parameters that can be set with &squot;insmod&squot; */
multiline_comment|/*&n;  Transceiver/media type.&n;   0 = auto&n;   1 = 10baseT (and autoselect if #define AUTOSELECT),&n;   2 = AUI/10base2,&n;*/
DECL|variable|if_port
r_static
r_int
id|if_port
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Bit map of interrupts to choose from. */
DECL|variable|irq_mask
r_static
id|u_int
id|irq_mask
op_assign
l_int|0xdeb8
suffix:semicolon
DECL|variable|irq_list
r_static
r_int
id|irq_list
(braket
l_int|4
)braket
op_assign
(brace
op_minus
l_int|1
)brace
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|if_port
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|irq_mask
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|irq_list
comma
l_string|&quot;1-4i&quot;
)paren
suffix:semicolon
multiline_comment|/* Operational parameter that usually are not changed. */
multiline_comment|/* Time in jiffies before concluding Tx hung */
DECL|macro|TX_TIMEOUT
mdefine_line|#define TX_TIMEOUT&t;&t;((400*HZ)/1000)
multiline_comment|/* Maximum events (Rx packets, etc.) to handle at each interrupt. */
DECL|macro|INTR_WORK
mdefine_line|#define INTR_WORK&t;&t;4
multiline_comment|/* Times to check the check the chip before concluding that it doesn&squot;t&n;   currently have room for another Tx packet. */
DECL|macro|MEMORY_WAIT_TIME
mdefine_line|#define MEMORY_WAIT_TIME       &t;8
DECL|variable|dev_info
r_static
id|dev_info_t
id|dev_info
op_assign
l_string|&quot;smc91c92_cs&quot;
suffix:semicolon
DECL|variable|dev_list
r_static
id|dev_link_t
op_star
id|dev_list
op_assign
l_int|NULL
suffix:semicolon
DECL|struct|smc_private
r_struct
id|smc_private
(brace
DECL|member|link
id|dev_link_t
id|link
suffix:semicolon
DECL|member|dev
r_struct
id|net_device
id|dev
suffix:semicolon
DECL|member|manfid
id|u_short
id|manfid
suffix:semicolon
DECL|member|cardid
id|u_short
id|cardid
suffix:semicolon
DECL|member|stats
r_struct
id|net_device_stats
id|stats
suffix:semicolon
DECL|member|node
id|dev_node_t
id|node
suffix:semicolon
DECL|member|saved_skb
r_struct
id|sk_buff
op_star
id|saved_skb
suffix:semicolon
DECL|member|packets_waiting
r_int
id|packets_waiting
suffix:semicolon
DECL|member|base
id|caddr_t
id|base
suffix:semicolon
DECL|member|cfg
id|u_short
id|cfg
suffix:semicolon
DECL|member|media
r_struct
id|timer_list
id|media
suffix:semicolon
DECL|member|watchdog
DECL|member|tx_err
r_int
id|watchdog
comma
id|tx_err
suffix:semicolon
DECL|member|media_status
id|u_short
id|media_status
suffix:semicolon
DECL|member|fast_poll
id|u_short
id|fast_poll
suffix:semicolon
DECL|member|last_rx
id|u_long
id|last_rx
suffix:semicolon
)brace
suffix:semicolon
multiline_comment|/* Special definitions for Megahertz multifunction cards */
DECL|macro|MEGAHERTZ_ISR
mdefine_line|#define MEGAHERTZ_ISR&t;&t;0x0380
multiline_comment|/* Special function registers for Motorola Mariner */
DECL|macro|MOT_LAN
mdefine_line|#define MOT_LAN&t;&t;&t;0x0000
DECL|macro|MOT_UART
mdefine_line|#define MOT_UART&t;&t;0x0020
DECL|macro|MOT_EEPROM
mdefine_line|#define MOT_EEPROM&t;&t;0x20
DECL|macro|MOT_NORMAL
mdefine_line|#define MOT_NORMAL &bslash;&n;(COR_LEVEL_REQ | COR_FUNC_ENA | COR_ADDR_DECODE | COR_IREQ_ENA)
multiline_comment|/* Special function registers for Ositech cards */
DECL|macro|OSITECH_AUI_CTL
mdefine_line|#define OSITECH_AUI_CTL&t;&t;0x0c
DECL|macro|OSITECH_PWRDOWN
mdefine_line|#define OSITECH_PWRDOWN&t;&t;0x0d
DECL|macro|OSITECH_RESET
mdefine_line|#define OSITECH_RESET&t;&t;0x0e
DECL|macro|OSITECH_ISR
mdefine_line|#define OSITECH_ISR&t;&t;0x0f
DECL|macro|OSITECH_AUI_PWR
mdefine_line|#define OSITECH_AUI_PWR&t;&t;0x0c
DECL|macro|OSITECH_RESET_ISR
mdefine_line|#define OSITECH_RESET_ISR&t;0x0e
DECL|macro|OSI_AUI_PWR
mdefine_line|#define OSI_AUI_PWR&t;&t;0x40
DECL|macro|OSI_LAN_PWRDOWN
mdefine_line|#define OSI_LAN_PWRDOWN&t;&t;0x02
DECL|macro|OSI_MODEM_PWRDOWN
mdefine_line|#define OSI_MODEM_PWRDOWN&t;0x01
DECL|macro|OSI_LAN_RESET
mdefine_line|#define OSI_LAN_RESET&t;&t;0x02
DECL|macro|OSI_MODEM_RESET
mdefine_line|#define OSI_MODEM_RESET&t;&t;0x01
multiline_comment|/* Symbolic constants for the SMC91c9* series chips, from Erik Stahlman. */
DECL|macro|BANK_SELECT
mdefine_line|#define&t;BANK_SELECT&t;&t;14&t;&t;/* Window select register. */
DECL|macro|SMC_SELECT_BANK
mdefine_line|#define SMC_SELECT_BANK(x)  { outw(x, ioaddr + BANK_SELECT); }
multiline_comment|/* Bank 0 registers. */
DECL|macro|TCR
mdefine_line|#define&t;TCR &t;&t;0&t;/* transmit control register */
DECL|macro|TCR_CLEAR
mdefine_line|#define&t; TCR_CLEAR&t;0&t;/* do NOTHING */
DECL|macro|TCR_ENABLE
mdefine_line|#define  TCR_ENABLE&t;0x0001&t;/* if this is 1, we can transmit */
DECL|macro|TCR_PAD_EN
mdefine_line|#define&t; TCR_PAD_EN&t;0x0080&t;/* pads short packets to 64 bytes */
DECL|macro|TCR_MONCSN
mdefine_line|#define  TCR_MONCSN&t;0x0400  /* Monitor Carrier. */
DECL|macro|TCR_FDUPLX
mdefine_line|#define  TCR_FDUPLX&t;0x0800  /* Full duplex mode. */
DECL|macro|TCR_NORMAL
mdefine_line|#define&t; TCR_NORMAL TCR_ENABLE | TCR_PAD_EN
DECL|macro|EPH
mdefine_line|#define EPH&t;&t;2&t;/* Ethernet Protocol Handler report. */
DECL|macro|EPH_TX_SUC
mdefine_line|#define  EPH_TX_SUC&t;0x0001
DECL|macro|EPH_SNGLCOL
mdefine_line|#define  EPH_SNGLCOL&t;0x0002
DECL|macro|EPH_MULCOL
mdefine_line|#define  EPH_MULCOL&t;0x0004
DECL|macro|EPH_LTX_MULT
mdefine_line|#define  EPH_LTX_MULT&t;0x0008
DECL|macro|EPH_16COL
mdefine_line|#define  EPH_16COL&t;0x0010
DECL|macro|EPH_SQET
mdefine_line|#define  EPH_SQET&t;0x0020
DECL|macro|EPH_LTX_BRD
mdefine_line|#define  EPH_LTX_BRD&t;0x0040
DECL|macro|EPH_TX_DEFR
mdefine_line|#define  EPH_TX_DEFR&t;0x0080
DECL|macro|EPH_LAT_COL
mdefine_line|#define  EPH_LAT_COL&t;0x0200
DECL|macro|EPH_LOST_CAR
mdefine_line|#define  EPH_LOST_CAR&t;0x0400
DECL|macro|EPH_EXC_DEF
mdefine_line|#define  EPH_EXC_DEF&t;0x0800
DECL|macro|EPH_CTR_ROL
mdefine_line|#define  EPH_CTR_ROL&t;0x1000
DECL|macro|EPH_RX_OVRN
mdefine_line|#define  EPH_RX_OVRN&t;0x2000
DECL|macro|EPH_LINK_OK
mdefine_line|#define  EPH_LINK_OK&t;0x4000
DECL|macro|EPH_TX_UNRN
mdefine_line|#define  EPH_TX_UNRN&t;0x8000
DECL|macro|MEMINFO
mdefine_line|#define MEMINFO&t;&t;8&t;/* Memory Information Register */
DECL|macro|MEMCFG
mdefine_line|#define MEMCFG&t;&t;10&t;/* Memory Configuration Register */
multiline_comment|/* Bank 1 registers. */
DECL|macro|CONFIG
mdefine_line|#define CONFIG&t;&t;&t;0
DECL|macro|CFG_MII_SELECT
mdefine_line|#define  CFG_MII_SELECT&t;&t;0x8000&t;/* 91C100 only */
DECL|macro|CFG_NO_WAIT
mdefine_line|#define  CFG_NO_WAIT&t;&t;0x1000
DECL|macro|CFG_FULL_STEP
mdefine_line|#define  CFG_FULL_STEP&t;&t;0x0400
DECL|macro|CFG_SET_SQLCH
mdefine_line|#define  CFG_SET_SQLCH&t;&t;0x0200
DECL|macro|CFG_AUI_SELECT
mdefine_line|#define  CFG_AUI_SELECT&t; &t;0x0100
DECL|macro|CFG_16BIT
mdefine_line|#define  CFG_16BIT&t;&t;0x0080
DECL|macro|CFG_DIS_LINK
mdefine_line|#define  CFG_DIS_LINK&t;&t;0x0040
DECL|macro|CFG_STATIC
mdefine_line|#define  CFG_STATIC&t;&t;0x0030
DECL|macro|CFG_IRQ_SEL_1
mdefine_line|#define  CFG_IRQ_SEL_1&t;&t;0x0004
DECL|macro|CFG_IRQ_SEL_0
mdefine_line|#define  CFG_IRQ_SEL_0&t;&t;0x0002
DECL|macro|BASE_ADDR
mdefine_line|#define BASE_ADDR&t;&t;2
DECL|macro|ADDR0
mdefine_line|#define&t;ADDR0&t;&t;&t;4
DECL|macro|GENERAL
mdefine_line|#define&t;GENERAL&t;&t;&t;10
DECL|macro|CONTROL
mdefine_line|#define&t;CONTROL&t;&t;&t;12
DECL|macro|CTL_STORE
mdefine_line|#define  CTL_STORE&t;&t;0x0001
DECL|macro|CTL_RELOAD
mdefine_line|#define  CTL_RELOAD&t;&t;0x0002
DECL|macro|CTL_EE_SELECT
mdefine_line|#define  CTL_EE_SELECT&t;&t;0x0004
DECL|macro|CTL_TE_ENABLE
mdefine_line|#define  CTL_TE_ENABLE&t;&t;0x0020
DECL|macro|CTL_CR_ENABLE
mdefine_line|#define  CTL_CR_ENABLE&t;&t;0x0040
DECL|macro|CTL_LE_ENABLE
mdefine_line|#define  CTL_LE_ENABLE&t;&t;0x0080
DECL|macro|CTL_AUTO_RELEASE
mdefine_line|#define  CTL_AUTO_RELEASE&t;0x0800
DECL|macro|CTL_POWERDOWN
mdefine_line|#define&t; CTL_POWERDOWN&t;&t;0x2000
multiline_comment|/* Bank 2 registers. */
DECL|macro|MMU_CMD
mdefine_line|#define MMU_CMD&t;&t;0
DECL|macro|MC_ALLOC
mdefine_line|#define&t; MC_ALLOC&t;0x20  &t;/* or with number of 256 byte packets */
DECL|macro|MC_RESET
mdefine_line|#define&t; MC_RESET&t;0x40
DECL|macro|MC_RELEASE
mdefine_line|#define  MC_RELEASE  &t;0x80  &t;/* remove and release the current rx packet */
DECL|macro|MC_FREEPKT
mdefine_line|#define  MC_FREEPKT  &t;0xA0  &t;/* Release packet in PNR register */
DECL|macro|MC_ENQUEUE
mdefine_line|#define  MC_ENQUEUE&t;0xC0 &t;/* Enqueue the packet for transmit */
DECL|macro|PNR_ARR
mdefine_line|#define&t;PNR_ARR&t;&t;2
DECL|macro|FIFO_PORTS
mdefine_line|#define FIFO_PORTS&t;4
DECL|macro|FP_RXEMPTY
mdefine_line|#define  FP_RXEMPTY&t;0x8000
DECL|macro|POINTER
mdefine_line|#define&t;POINTER&t;&t;6
DECL|macro|PTR_AUTO_INC
mdefine_line|#define  PTR_AUTO_INC&t;0x0040
DECL|macro|PTR_READ
mdefine_line|#define  PTR_READ&t;0x2000
DECL|macro|PTR_AUTOINC
mdefine_line|#define&t; PTR_AUTOINC &t;0x4000
DECL|macro|PTR_RCV
mdefine_line|#define&t; PTR_RCV&t;0x8000
DECL|macro|DATA_1
mdefine_line|#define&t;DATA_1&t;&t;8
DECL|macro|INTERRUPT
mdefine_line|#define&t;INTERRUPT&t;12
DECL|macro|IM_RCV_INT
mdefine_line|#define  IM_RCV_INT&t;&t;0x1
DECL|macro|IM_TX_INT
mdefine_line|#define&t; IM_TX_INT&t;&t;0x2
DECL|macro|IM_TX_EMPTY_INT
mdefine_line|#define&t; IM_TX_EMPTY_INT&t;0x4
DECL|macro|IM_ALLOC_INT
mdefine_line|#define&t; IM_ALLOC_INT&t;&t;0x8
DECL|macro|IM_RX_OVRN_INT
mdefine_line|#define&t; IM_RX_OVRN_INT&t;&t;0x10
DECL|macro|IM_EPH_INT
mdefine_line|#define&t; IM_EPH_INT&t;&t;0x20
DECL|macro|RCR
mdefine_line|#define&t;RCR&t;&t;4
DECL|enum|RxCfg
DECL|enumerator|RxAllMulti
DECL|enumerator|RxPromisc
r_enum
id|RxCfg
(brace
id|RxAllMulti
op_assign
l_int|0x0004
comma
id|RxPromisc
op_assign
l_int|0x0002
comma
DECL|enumerator|RxEnable
DECL|enumerator|RxStripCRC
id|RxEnable
op_assign
l_int|0x0100
comma
id|RxStripCRC
op_assign
l_int|0x0200
)brace
suffix:semicolon
DECL|macro|RCR_SOFTRESET
mdefine_line|#define  RCR_SOFTRESET&t;0x8000 &t;/* resets the chip */
DECL|macro|RCR_STRIP_CRC
mdefine_line|#define&t; RCR_STRIP_CRC&t;0x200&t;/* strips CRC */
DECL|macro|RCR_ENABLE
mdefine_line|#define  RCR_ENABLE&t;0x100&t;/* IFF this is set, we can recieve packets */
DECL|macro|RCR_ALMUL
mdefine_line|#define  RCR_ALMUL&t;0x4 &t;/* receive all multicast packets */
DECL|macro|RCR_PROMISC
mdefine_line|#define&t; RCR_PROMISC&t;0x2&t;/* enable promiscuous mode */
multiline_comment|/* the normal settings for the RCR register : */
DECL|macro|RCR_NORMAL
mdefine_line|#define&t; RCR_NORMAL&t;(RCR_STRIP_CRC | RCR_ENABLE)
DECL|macro|RCR_CLEAR
mdefine_line|#define  RCR_CLEAR&t;0x0&t;&t;/* set it to a base state */
DECL|macro|COUNTER
mdefine_line|#define&t;COUNTER&t;&t;6
multiline_comment|/* BANK 3 -- not the same values as in smc9194! */
DECL|macro|MULTICAST0
mdefine_line|#define&t;MULTICAST0&t;0
DECL|macro|MULTICAST2
mdefine_line|#define&t;MULTICAST2&t;2
DECL|macro|MULTICAST4
mdefine_line|#define&t;MULTICAST4&t;4
DECL|macro|MULTICAST6
mdefine_line|#define&t;MULTICAST6&t;6
DECL|macro|REVISION
mdefine_line|#define REVISION&t;0x0a
multiline_comment|/* Transmit status bits. */
DECL|macro|TS_SUCCESS
mdefine_line|#define TS_SUCCESS 0x0001
DECL|macro|TS_16COL
mdefine_line|#define TS_16COL   0x0010
DECL|macro|TS_LATCOL
mdefine_line|#define TS_LATCOL  0x0200
DECL|macro|TS_LOSTCAR
mdefine_line|#define TS_LOSTCAR 0x0400
multiline_comment|/* Receive status bits. */
DECL|macro|RS_ALGNERR
mdefine_line|#define RS_ALGNERR&t;0x8000
DECL|macro|RS_BADCRC
mdefine_line|#define RS_BADCRC&t;0x2000
DECL|macro|RS_ODDFRAME
mdefine_line|#define RS_ODDFRAME&t;0x1000
DECL|macro|RS_TOOLONG
mdefine_line|#define RS_TOOLONG&t;0x0800
DECL|macro|RS_TOOSHORT
mdefine_line|#define RS_TOOSHORT&t;0x0400
DECL|macro|RS_MULTICAST
mdefine_line|#define RS_MULTICAST&t;0x0001
DECL|macro|RS_ERRORS
mdefine_line|#define RS_ERRORS&t;(RS_ALGNERR | RS_BADCRC | RS_TOOLONG | RS_TOOSHORT)
DECL|macro|set_bits
mdefine_line|#define set_bits(v, p) outw(inw(p)|(v), (p))
DECL|macro|mask_bits
mdefine_line|#define mask_bits(v, p) outw(inw(p)&amp;(v), (p))
multiline_comment|/*====================================================================*/
r_static
id|dev_link_t
op_star
id|smc91c92_attach
c_func
(paren
r_void
)paren
suffix:semicolon
r_static
r_void
id|smc91c92_detach
c_func
(paren
id|dev_link_t
op_star
)paren
suffix:semicolon
r_static
r_void
id|smc91c92_config
c_func
(paren
id|dev_link_t
op_star
id|link
)paren
suffix:semicolon
r_static
r_void
id|smc91c92_release
c_func
(paren
id|u_long
id|arg
)paren
suffix:semicolon
r_static
r_int
id|smc91c92_event
c_func
(paren
id|event_t
id|event
comma
r_int
id|priority
comma
id|event_callback_args_t
op_star
id|args
)paren
suffix:semicolon
r_static
r_int
id|smc91c92_open
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_int
id|smc91c92_close
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_void
id|smc_tx_timeout
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_int
id|smc_start_xmit
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_void
id|smc_interrupt
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
suffix:semicolon
r_static
r_void
id|smc_rx
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_struct
id|net_device_stats
op_star
id|smc91c92_get_stats
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_void
id|set_rx_mode
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_int
id|s9k_config
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_struct
id|ifmap
op_star
id|map
)paren
suffix:semicolon
r_static
r_void
id|smc_set_xcvr
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_int
id|if_port
)paren
suffix:semicolon
r_static
r_void
id|smc_reset
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_void
id|media_check
c_func
(paren
id|u_long
id|arg
)paren
suffix:semicolon
multiline_comment|/*======================================================================&n;&n;    This bit of code is used to avoid unregistering network devices&n;    at inappropriate times.  2.2 and later kernels are fairly picky&n;    about when this can happen.&n;    &n;======================================================================*/
DECL|function|flush_stale_links
r_static
r_void
id|flush_stale_links
c_func
(paren
r_void
)paren
(brace
id|dev_link_t
op_star
id|link
comma
op_star
id|next
suffix:semicolon
r_for
c_loop
(paren
id|link
op_assign
id|dev_list
suffix:semicolon
id|link
suffix:semicolon
id|link
op_assign
id|next
)paren
(brace
id|next
op_assign
id|link-&gt;next
suffix:semicolon
r_if
c_cond
(paren
id|link-&gt;state
op_amp
id|DEV_STALE_LINK
)paren
id|smc91c92_detach
c_func
(paren
id|link
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/*====================================================================*/
DECL|function|cs_error
r_static
r_void
id|cs_error
c_func
(paren
id|client_handle_t
id|handle
comma
r_int
id|func
comma
r_int
id|ret
)paren
(brace
id|error_info_t
id|err
op_assign
(brace
id|func
comma
id|ret
)brace
suffix:semicolon
id|CardServices
c_func
(paren
id|ReportError
comma
id|handle
comma
op_amp
id|err
)paren
suffix:semicolon
)brace
multiline_comment|/*======================================================================&n;&n;  smc91c92_attach() creates an &quot;instance&quot; of the driver, allocating&n;  local data structures for one device.  The device is registered&n;  with Card Services.&n;&n;======================================================================*/
DECL|function|smc91c92_attach
r_static
id|dev_link_t
op_star
id|smc91c92_attach
c_func
(paren
r_void
)paren
(brace
id|client_reg_t
id|client_reg
suffix:semicolon
r_struct
id|smc_private
op_star
id|smc
suffix:semicolon
id|dev_link_t
op_star
id|link
suffix:semicolon
r_struct
id|net_device
op_star
id|dev
suffix:semicolon
r_int
id|i
comma
id|ret
suffix:semicolon
id|DEBUG
c_func
(paren
l_int|0
comma
l_string|&quot;smc91c92_attach()&bslash;n&quot;
)paren
suffix:semicolon
id|flush_stale_links
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* Create new ethernet device */
id|smc
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|smc_private
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|smc
)paren
r_return
l_int|NULL
suffix:semicolon
id|memset
c_func
(paren
id|smc
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|smc_private
)paren
)paren
suffix:semicolon
id|link
op_assign
op_amp
id|smc-&gt;link
suffix:semicolon
id|dev
op_assign
op_amp
id|smc-&gt;dev
suffix:semicolon
id|link-&gt;release.function
op_assign
op_amp
id|smc91c92_release
suffix:semicolon
id|link-&gt;release.data
op_assign
(paren
id|u_long
)paren
id|link
suffix:semicolon
id|link-&gt;io.NumPorts1
op_assign
l_int|16
suffix:semicolon
id|link-&gt;io.Attributes1
op_assign
id|IO_DATA_PATH_WIDTH_AUTO
suffix:semicolon
id|link-&gt;io.IOAddrLines
op_assign
l_int|4
suffix:semicolon
id|link-&gt;irq.Attributes
op_assign
id|IRQ_TYPE_EXCLUSIVE
op_or
id|IRQ_HANDLE_PRESENT
suffix:semicolon
id|link-&gt;irq.IRQInfo1
op_assign
id|IRQ_INFO2_VALID
op_or
id|IRQ_LEVEL_ID
suffix:semicolon
r_if
c_cond
(paren
id|irq_list
(braket
l_int|0
)braket
op_eq
op_minus
l_int|1
)paren
id|link-&gt;irq.IRQInfo2
op_assign
id|irq_mask
suffix:semicolon
r_else
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|4
suffix:semicolon
id|i
op_increment
)paren
id|link-&gt;irq.IRQInfo2
op_or_assign
l_int|1
op_lshift
id|irq_list
(braket
id|i
)braket
suffix:semicolon
id|link-&gt;irq.Handler
op_assign
op_amp
id|smc_interrupt
suffix:semicolon
id|link-&gt;conf.Attributes
op_assign
id|CONF_ENABLE_IRQ
suffix:semicolon
id|link-&gt;conf.Vcc
op_assign
l_int|50
suffix:semicolon
id|link-&gt;conf.IntType
op_assign
id|INT_MEMORY_AND_IO
suffix:semicolon
multiline_comment|/* The SMC91c92-specific entries in the device structure. */
id|dev-&gt;hard_start_xmit
op_assign
op_amp
id|smc_start_xmit
suffix:semicolon
id|dev-&gt;get_stats
op_assign
op_amp
id|smc91c92_get_stats
suffix:semicolon
id|dev-&gt;set_config
op_assign
op_amp
id|s9k_config
suffix:semicolon
id|dev-&gt;set_multicast_list
op_assign
op_amp
id|set_rx_mode
suffix:semicolon
id|ether_setup
c_func
(paren
id|dev
)paren
suffix:semicolon
id|dev-&gt;open
op_assign
op_amp
id|smc91c92_open
suffix:semicolon
id|dev-&gt;stop
op_assign
op_amp
id|smc91c92_close
suffix:semicolon
id|dev-&gt;tx_timeout
op_assign
id|smc_tx_timeout
suffix:semicolon
id|dev-&gt;watchdog_timeo
op_assign
id|TX_TIMEOUT
suffix:semicolon
id|dev-&gt;priv
op_assign
id|link-&gt;priv
op_assign
id|link-&gt;irq.Instance
op_assign
id|smc
suffix:semicolon
multiline_comment|/* Register with Card Services */
id|link-&gt;next
op_assign
id|dev_list
suffix:semicolon
id|dev_list
op_assign
id|link
suffix:semicolon
id|client_reg.dev_info
op_assign
op_amp
id|dev_info
suffix:semicolon
id|client_reg.Attributes
op_assign
id|INFO_IO_CLIENT
op_or
id|INFO_CARD_SHARE
suffix:semicolon
id|client_reg.EventMask
op_assign
id|CS_EVENT_CARD_INSERTION
op_or
id|CS_EVENT_CARD_REMOVAL
op_or
id|CS_EVENT_RESET_PHYSICAL
op_or
id|CS_EVENT_CARD_RESET
op_or
id|CS_EVENT_PM_SUSPEND
op_or
id|CS_EVENT_PM_RESUME
suffix:semicolon
id|client_reg.event_handler
op_assign
op_amp
id|smc91c92_event
suffix:semicolon
id|client_reg.Version
op_assign
l_int|0x0210
suffix:semicolon
id|client_reg.event_callback_args.client_data
op_assign
id|link
suffix:semicolon
id|ret
op_assign
id|CardServices
c_func
(paren
id|RegisterClient
comma
op_amp
id|link-&gt;handle
comma
op_amp
id|client_reg
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
op_ne
l_int|0
)paren
(brace
id|cs_error
c_func
(paren
id|link-&gt;handle
comma
id|RegisterClient
comma
id|ret
)paren
suffix:semicolon
id|smc91c92_detach
c_func
(paren
id|link
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
r_return
id|link
suffix:semicolon
)brace
multiline_comment|/* smc91c92_attach */
multiline_comment|/*======================================================================&n;&n;    This deletes a driver &quot;instance&quot;.  The device is de-registered&n;    with Card Services.  If it has been released, all local data&n;    structures are freed.  Otherwise, the structures will be freed&n;    when the device is released.&n;&n;======================================================================*/
DECL|function|smc91c92_detach
r_static
r_void
id|smc91c92_detach
c_func
(paren
id|dev_link_t
op_star
id|link
)paren
(brace
r_struct
id|smc_private
op_star
id|smc
op_assign
id|link-&gt;priv
suffix:semicolon
id|dev_link_t
op_star
op_star
id|linkp
suffix:semicolon
id|DEBUG
c_func
(paren
l_int|0
comma
l_string|&quot;smc91c92_detach(0x%p)&bslash;n&quot;
comma
id|link
)paren
suffix:semicolon
multiline_comment|/* Locate device structure */
r_for
c_loop
(paren
id|linkp
op_assign
op_amp
id|dev_list
suffix:semicolon
op_star
id|linkp
suffix:semicolon
id|linkp
op_assign
op_amp
(paren
op_star
id|linkp
)paren
op_member_access_from_pointer
id|next
)paren
r_if
c_cond
(paren
op_star
id|linkp
op_eq
id|link
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
op_star
id|linkp
op_eq
l_int|NULL
)paren
r_return
suffix:semicolon
id|del_timer
c_func
(paren
op_amp
id|link-&gt;release
)paren
suffix:semicolon
r_if
c_cond
(paren
id|link-&gt;state
op_amp
id|DEV_CONFIG
)paren
(brace
id|smc91c92_release
c_func
(paren
(paren
id|u_long
)paren
id|link
)paren
suffix:semicolon
r_if
c_cond
(paren
id|link-&gt;state
op_amp
id|DEV_STALE_CONFIG
)paren
(brace
id|link-&gt;state
op_or_assign
id|DEV_STALE_LINK
suffix:semicolon
r_return
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|link-&gt;handle
)paren
id|CardServices
c_func
(paren
id|DeregisterClient
comma
id|link-&gt;handle
)paren
suffix:semicolon
multiline_comment|/* Unlink device structure, free bits */
op_star
id|linkp
op_assign
id|link-&gt;next
suffix:semicolon
r_if
c_cond
(paren
id|link-&gt;dev
)paren
id|unregister_netdev
c_func
(paren
op_amp
id|smc-&gt;dev
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|smc
)paren
suffix:semicolon
)brace
multiline_comment|/* smc91c92_detach */
multiline_comment|/*====================================================================*/
DECL|function|cvt_ascii_address
r_static
r_int
id|cvt_ascii_address
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_char
op_star
id|s
)paren
(brace
r_int
id|i
comma
id|j
comma
id|da
comma
id|c
suffix:semicolon
r_if
c_cond
(paren
id|strlen
c_func
(paren
id|s
)paren
op_ne
l_int|12
)paren
r_return
op_minus
l_int|1
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|6
suffix:semicolon
id|i
op_increment
)paren
(brace
id|da
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|j
op_assign
l_int|0
suffix:semicolon
id|j
OL
l_int|2
suffix:semicolon
id|j
op_increment
)paren
(brace
id|c
op_assign
op_star
id|s
op_increment
suffix:semicolon
id|da
op_lshift_assign
l_int|4
suffix:semicolon
id|da
op_add_assign
(paren
(paren
id|c
op_ge
l_char|&squot;0&squot;
)paren
op_logical_and
(paren
id|c
op_le
l_char|&squot;9&squot;
)paren
)paren
ques
c_cond
(paren
id|c
op_minus
l_char|&squot;0&squot;
)paren
suffix:colon
(paren
(paren
id|c
op_amp
l_int|0x0f
)paren
op_plus
l_int|9
)paren
suffix:semicolon
)brace
id|dev-&gt;dev_addr
(braket
id|i
)braket
op_assign
id|da
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*====================================================================*/
DECL|function|get_tuple
r_static
r_int
id|get_tuple
c_func
(paren
r_int
id|fn
comma
id|client_handle_t
id|handle
comma
id|tuple_t
op_star
id|tuple
comma
id|cisparse_t
op_star
id|parse
)paren
(brace
r_int
id|i
suffix:semicolon
id|i
op_assign
id|CardServices
c_func
(paren
id|fn
comma
id|handle
comma
id|tuple
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
op_ne
id|CS_SUCCESS
)paren
r_return
id|i
suffix:semicolon
id|i
op_assign
id|CardServices
c_func
(paren
id|GetTupleData
comma
id|handle
comma
id|tuple
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
op_ne
id|CS_SUCCESS
)paren
r_return
id|i
suffix:semicolon
r_return
id|CardServices
c_func
(paren
id|ParseTuple
comma
id|handle
comma
id|tuple
comma
id|parse
)paren
suffix:semicolon
)brace
DECL|macro|first_tuple
mdefine_line|#define first_tuple(a, b, c) get_tuple(GetFirstTuple, a, b, c)
DECL|macro|next_tuple
mdefine_line|#define next_tuple(a, b, c) get_tuple(GetNextTuple, a, b, c)
multiline_comment|/*======================================================================&n;&n;    Configuration stuff for Megahertz cards&n;&n;    mhz_3288_power() is used to power up a 3288&squot;s ethernet chip.&n;    mhz_mfc_config() handles socket setup for multifunction (1144&n;    and 3288) cards.  mhz_setup() gets a card&squot;s hardware ethernet&n;    address.&n;    &n;======================================================================*/
DECL|function|mhz_3288_power
r_static
r_int
id|mhz_3288_power
c_func
(paren
id|dev_link_t
op_star
id|link
)paren
(brace
r_struct
id|smc_private
op_star
id|smc
op_assign
id|link-&gt;priv
suffix:semicolon
id|u_char
id|tmp
suffix:semicolon
multiline_comment|/* Read the ISR twice... */
id|readb
c_func
(paren
id|smc-&gt;base
op_plus
id|MEGAHERTZ_ISR
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|5
)paren
suffix:semicolon
id|readb
c_func
(paren
id|smc-&gt;base
op_plus
id|MEGAHERTZ_ISR
)paren
suffix:semicolon
multiline_comment|/* Pause 200ms... */
id|mdelay
c_func
(paren
l_int|200
)paren
suffix:semicolon
multiline_comment|/* Now read and write the COR... */
id|tmp
op_assign
id|readb
c_func
(paren
id|smc-&gt;base
op_plus
id|link-&gt;conf.ConfigBase
op_plus
id|CISREG_COR
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|5
)paren
suffix:semicolon
id|writeb
c_func
(paren
id|tmp
comma
id|smc-&gt;base
op_plus
id|link-&gt;conf.ConfigBase
op_plus
id|CISREG_COR
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|mhz_mfc_config
r_static
r_int
id|mhz_mfc_config
c_func
(paren
id|dev_link_t
op_star
id|link
)paren
(brace
r_struct
id|smc_private
op_star
id|smc
op_assign
id|link-&gt;priv
suffix:semicolon
r_struct
id|net_device
op_star
id|dev
op_assign
op_amp
id|smc-&gt;dev
suffix:semicolon
id|tuple_t
id|tuple
suffix:semicolon
id|cisparse_t
id|parse
suffix:semicolon
id|u_char
id|buf
(braket
l_int|255
)braket
suffix:semicolon
id|cistpl_cftable_entry_t
op_star
id|cf
op_assign
op_amp
id|parse.cftable_entry
suffix:semicolon
id|win_req_t
id|req
suffix:semicolon
id|memreq_t
id|mem
suffix:semicolon
r_int
id|i
comma
id|k
suffix:semicolon
id|link-&gt;conf.Attributes
op_or_assign
id|CONF_ENABLE_SPKR
suffix:semicolon
id|link-&gt;conf.Status
op_assign
id|CCSR_AUDIO_ENA
suffix:semicolon
id|link-&gt;irq.Attributes
op_assign
id|IRQ_TYPE_DYNAMIC_SHARING
op_or
id|IRQ_FIRST_SHARED
op_or
id|IRQ_HANDLE_PRESENT
suffix:semicolon
id|link-&gt;io.IOAddrLines
op_assign
l_int|16
suffix:semicolon
id|link-&gt;io.Attributes2
op_assign
id|IO_DATA_PATH_WIDTH_8
suffix:semicolon
id|link-&gt;io.NumPorts2
op_assign
l_int|8
suffix:semicolon
id|tuple.Attributes
op_assign
id|tuple.TupleOffset
op_assign
l_int|0
suffix:semicolon
id|tuple.TupleData
op_assign
(paren
id|cisdata_t
op_star
)paren
id|buf
suffix:semicolon
id|tuple.TupleDataMax
op_assign
r_sizeof
(paren
id|buf
)paren
suffix:semicolon
id|tuple.DesiredTuple
op_assign
id|CISTPL_CFTABLE_ENTRY
suffix:semicolon
id|i
op_assign
id|first_tuple
c_func
(paren
id|link-&gt;handle
comma
op_amp
id|tuple
comma
op_amp
id|parse
)paren
suffix:semicolon
multiline_comment|/* The Megahertz combo cards have modem-like CIS entries, so&n;       we have to explicitly try a bunch of port combinations. */
r_while
c_loop
(paren
id|i
op_eq
id|CS_SUCCESS
)paren
(brace
id|link-&gt;conf.ConfigIndex
op_assign
id|cf-&gt;index
suffix:semicolon
id|link-&gt;io.BasePort2
op_assign
id|cf-&gt;io.win
(braket
l_int|0
)braket
dot
id|base
suffix:semicolon
r_for
c_loop
(paren
id|k
op_assign
l_int|0
suffix:semicolon
id|k
OL
l_int|0x400
suffix:semicolon
id|k
op_add_assign
l_int|0x10
)paren
(brace
r_if
c_cond
(paren
id|k
op_amp
l_int|0x80
)paren
r_continue
suffix:semicolon
id|link-&gt;io.BasePort1
op_assign
id|k
op_xor
l_int|0x300
suffix:semicolon
id|i
op_assign
id|CardServices
c_func
(paren
id|RequestIO
comma
id|link-&gt;handle
comma
op_amp
id|link-&gt;io
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
op_eq
id|CS_SUCCESS
)paren
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|i
op_eq
id|CS_SUCCESS
)paren
r_break
suffix:semicolon
id|i
op_assign
id|next_tuple
c_func
(paren
id|link-&gt;handle
comma
op_amp
id|tuple
comma
op_amp
id|parse
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|i
op_ne
id|CS_SUCCESS
)paren
r_return
id|i
suffix:semicolon
id|dev-&gt;base_addr
op_assign
id|link-&gt;io.BasePort1
suffix:semicolon
multiline_comment|/* Allocate a memory window, for accessing the ISR */
id|req.Attributes
op_assign
id|WIN_DATA_WIDTH_8
op_or
id|WIN_MEMORY_TYPE_AM
op_or
id|WIN_ENABLE
suffix:semicolon
id|req.Base
op_assign
id|req.Size
op_assign
l_int|0
suffix:semicolon
id|req.AccessSpeed
op_assign
l_int|0
suffix:semicolon
id|link-&gt;win
op_assign
(paren
id|window_handle_t
)paren
id|link-&gt;handle
suffix:semicolon
id|i
op_assign
id|CardServices
c_func
(paren
id|RequestWindow
comma
op_amp
id|link-&gt;win
comma
op_amp
id|req
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
op_ne
id|CS_SUCCESS
)paren
r_return
id|i
suffix:semicolon
id|smc-&gt;base
op_assign
id|ioremap
c_func
(paren
id|req.Base
comma
id|req.Size
)paren
suffix:semicolon
id|mem.CardOffset
op_assign
id|mem.Page
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|smc-&gt;manfid
op_eq
id|MANFID_MOTOROLA
)paren
id|mem.CardOffset
op_assign
id|link-&gt;conf.ConfigBase
suffix:semicolon
id|i
op_assign
id|CardServices
c_func
(paren
id|MapMemPage
comma
id|link-&gt;win
comma
op_amp
id|mem
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|i
op_eq
id|CS_SUCCESS
)paren
op_logical_and
(paren
id|smc-&gt;manfid
op_eq
id|MANFID_MEGAHERTZ
)paren
op_logical_and
(paren
id|smc-&gt;cardid
op_eq
id|PRODID_MEGAHERTZ_EM3288
)paren
)paren
id|mhz_3288_power
c_func
(paren
id|link
)paren
suffix:semicolon
r_return
id|i
suffix:semicolon
)brace
DECL|function|mhz_setup
r_static
r_int
id|mhz_setup
c_func
(paren
id|dev_link_t
op_star
id|link
)paren
(brace
id|client_handle_t
id|handle
op_assign
id|link-&gt;handle
suffix:semicolon
r_struct
id|smc_private
op_star
id|smc
op_assign
id|link-&gt;priv
suffix:semicolon
r_struct
id|net_device
op_star
id|dev
op_assign
op_amp
id|smc-&gt;dev
suffix:semicolon
id|tuple_t
id|tuple
suffix:semicolon
id|cisparse_t
id|parse
suffix:semicolon
id|u_char
id|buf
(braket
l_int|255
)braket
comma
op_star
id|station_addr
suffix:semicolon
id|tuple.Attributes
op_assign
id|tuple.TupleOffset
op_assign
l_int|0
suffix:semicolon
id|tuple.TupleData
op_assign
id|buf
suffix:semicolon
id|tuple.TupleDataMax
op_assign
r_sizeof
(paren
id|buf
)paren
suffix:semicolon
multiline_comment|/* Read the station address from the CIS.  It is stored as the last&n;       (fourth) string in the Version 1 Version/ID tuple. */
id|tuple.DesiredTuple
op_assign
id|CISTPL_VERS_1
suffix:semicolon
r_if
c_cond
(paren
id|first_tuple
c_func
(paren
id|handle
comma
op_amp
id|tuple
comma
op_amp
id|parse
)paren
op_ne
id|CS_SUCCESS
)paren
r_return
op_minus
l_int|1
suffix:semicolon
multiline_comment|/* Ugh -- the EM1144 card has two VERS_1 tuples!?! */
r_if
c_cond
(paren
id|next_tuple
c_func
(paren
id|handle
comma
op_amp
id|tuple
comma
op_amp
id|parse
)paren
op_ne
id|CS_SUCCESS
)paren
id|first_tuple
c_func
(paren
id|handle
comma
op_amp
id|tuple
comma
op_amp
id|parse
)paren
suffix:semicolon
r_if
c_cond
(paren
id|parse.version_1.ns
OG
l_int|3
)paren
(brace
id|station_addr
op_assign
id|parse.version_1.str
op_plus
id|parse.version_1.ofs
(braket
l_int|3
)braket
suffix:semicolon
r_if
c_cond
(paren
id|cvt_ascii_address
c_func
(paren
id|dev
comma
id|station_addr
)paren
op_eq
l_int|0
)paren
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Another possibility: for the EM3288, in a special tuple */
id|tuple.DesiredTuple
op_assign
l_int|0x81
suffix:semicolon
r_if
c_cond
(paren
id|CardServices
c_func
(paren
id|GetFirstTuple
comma
id|handle
comma
op_amp
id|tuple
)paren
op_ne
id|CS_SUCCESS
)paren
r_return
op_minus
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|CardServices
c_func
(paren
id|GetTupleData
comma
id|handle
comma
op_amp
id|tuple
)paren
op_ne
id|CS_SUCCESS
)paren
r_return
op_minus
l_int|1
suffix:semicolon
id|buf
(braket
l_int|12
)braket
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
r_if
c_cond
(paren
id|cvt_ascii_address
c_func
(paren
id|dev
comma
id|buf
)paren
op_eq
l_int|0
)paren
r_return
l_int|0
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
multiline_comment|/*======================================================================&n;&n;    Configuration stuff for the Motorola Mariner&n;&n;    mot_config() writes directly to the Mariner configuration&n;    registers because the CIS is just bogus.&n;    &n;======================================================================*/
DECL|function|mot_config
r_static
r_void
id|mot_config
c_func
(paren
id|dev_link_t
op_star
id|link
)paren
(brace
r_struct
id|smc_private
op_star
id|smc
op_assign
id|link-&gt;priv
suffix:semicolon
r_struct
id|net_device
op_star
id|dev
op_assign
op_amp
id|smc-&gt;dev
suffix:semicolon
id|ioaddr_t
id|ioaddr
op_assign
id|dev-&gt;base_addr
suffix:semicolon
id|ioaddr_t
id|iouart
op_assign
id|link-&gt;io.BasePort2
suffix:semicolon
multiline_comment|/* Set UART base address and force map with COR bit 1 */
id|writeb
c_func
(paren
id|iouart
op_amp
l_int|0xff
comma
id|smc-&gt;base
op_plus
id|MOT_UART
op_plus
id|CISREG_IOBASE_0
)paren
suffix:semicolon
id|writeb
c_func
(paren
(paren
id|iouart
op_rshift
l_int|8
)paren
op_amp
l_int|0xff
comma
id|smc-&gt;base
op_plus
id|MOT_UART
op_plus
id|CISREG_IOBASE_1
)paren
suffix:semicolon
id|writeb
c_func
(paren
id|MOT_NORMAL
comma
id|smc-&gt;base
op_plus
id|MOT_UART
op_plus
id|CISREG_COR
)paren
suffix:semicolon
multiline_comment|/* Set SMC base address and force map with COR bit 1 */
id|writeb
c_func
(paren
id|ioaddr
op_amp
l_int|0xff
comma
id|smc-&gt;base
op_plus
id|MOT_LAN
op_plus
id|CISREG_IOBASE_0
)paren
suffix:semicolon
id|writeb
c_func
(paren
(paren
id|ioaddr
op_rshift
l_int|8
)paren
op_amp
l_int|0xff
comma
id|smc-&gt;base
op_plus
id|MOT_LAN
op_plus
id|CISREG_IOBASE_1
)paren
suffix:semicolon
id|writeb
c_func
(paren
id|MOT_NORMAL
comma
id|smc-&gt;base
op_plus
id|MOT_LAN
op_plus
id|CISREG_COR
)paren
suffix:semicolon
multiline_comment|/* Wait for things to settle down */
id|mdelay
c_func
(paren
l_int|100
)paren
suffix:semicolon
)brace
DECL|function|mot_setup
r_static
r_int
id|mot_setup
c_func
(paren
id|dev_link_t
op_star
id|link
)paren
(brace
r_struct
id|smc_private
op_star
id|smc
op_assign
id|link-&gt;priv
suffix:semicolon
r_struct
id|net_device
op_star
id|dev
op_assign
op_amp
id|smc-&gt;dev
suffix:semicolon
id|ioaddr_t
id|ioaddr
op_assign
id|dev-&gt;base_addr
suffix:semicolon
r_int
id|i
comma
id|wait
comma
id|loop
suffix:semicolon
id|u_int
id|addr
suffix:semicolon
multiline_comment|/* Read Ethernet address from Serial EEPROM */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|3
suffix:semicolon
id|i
op_increment
)paren
(brace
id|SMC_SELECT_BANK
c_func
(paren
l_int|2
)paren
suffix:semicolon
id|outw
c_func
(paren
id|MOT_EEPROM
op_plus
id|i
comma
id|ioaddr
op_plus
id|POINTER
)paren
suffix:semicolon
id|SMC_SELECT_BANK
c_func
(paren
l_int|1
)paren
suffix:semicolon
id|outw
c_func
(paren
(paren
id|CTL_RELOAD
op_or
id|CTL_EE_SELECT
)paren
comma
id|ioaddr
op_plus
id|CONTROL
)paren
suffix:semicolon
r_for
c_loop
(paren
id|loop
op_assign
id|wait
op_assign
l_int|0
suffix:semicolon
id|loop
OL
l_int|200
suffix:semicolon
id|loop
op_increment
)paren
(brace
id|udelay
c_func
(paren
l_int|10
)paren
suffix:semicolon
id|wait
op_assign
(paren
(paren
id|CTL_RELOAD
op_or
id|CTL_STORE
)paren
op_amp
id|inw
c_func
(paren
id|ioaddr
op_plus
id|CONTROL
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|wait
op_eq
l_int|0
)paren
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|wait
)paren
r_return
op_minus
l_int|1
suffix:semicolon
id|addr
op_assign
id|inw
c_func
(paren
id|ioaddr
op_plus
id|GENERAL
)paren
suffix:semicolon
id|dev-&gt;dev_addr
(braket
l_int|2
op_star
id|i
)braket
op_assign
id|addr
op_amp
l_int|0xff
suffix:semicolon
id|dev-&gt;dev_addr
(braket
l_int|2
op_star
id|i
op_plus
l_int|1
)braket
op_assign
(paren
id|addr
op_rshift
l_int|8
)paren
op_amp
l_int|0xff
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*====================================================================*/
DECL|function|smc_config
r_static
r_int
id|smc_config
c_func
(paren
id|dev_link_t
op_star
id|link
)paren
(brace
r_struct
id|smc_private
op_star
id|smc
op_assign
id|link-&gt;priv
suffix:semicolon
r_struct
id|net_device
op_star
id|dev
op_assign
op_amp
id|smc-&gt;dev
suffix:semicolon
id|tuple_t
id|tuple
suffix:semicolon
id|cisparse_t
id|parse
suffix:semicolon
id|u_char
id|buf
(braket
l_int|255
)braket
suffix:semicolon
id|cistpl_cftable_entry_t
op_star
id|cf
op_assign
op_amp
id|parse.cftable_entry
suffix:semicolon
r_int
id|i
suffix:semicolon
id|tuple.Attributes
op_assign
id|tuple.TupleOffset
op_assign
l_int|0
suffix:semicolon
id|tuple.TupleData
op_assign
(paren
id|cisdata_t
op_star
)paren
id|buf
suffix:semicolon
id|tuple.TupleDataMax
op_assign
r_sizeof
(paren
id|buf
)paren
suffix:semicolon
id|tuple.DesiredTuple
op_assign
id|CISTPL_CFTABLE_ENTRY
suffix:semicolon
id|link-&gt;io.NumPorts1
op_assign
l_int|16
suffix:semicolon
id|i
op_assign
id|first_tuple
c_func
(paren
id|link-&gt;handle
comma
op_amp
id|tuple
comma
op_amp
id|parse
)paren
suffix:semicolon
r_while
c_loop
(paren
id|i
op_ne
id|CS_NO_MORE_ITEMS
)paren
(brace
r_if
c_cond
(paren
id|i
op_eq
id|CS_SUCCESS
)paren
(brace
id|link-&gt;conf.ConfigIndex
op_assign
id|cf-&gt;index
suffix:semicolon
id|link-&gt;io.BasePort1
op_assign
id|cf-&gt;io.win
(braket
l_int|0
)braket
dot
id|base
suffix:semicolon
id|link-&gt;io.IOAddrLines
op_assign
id|cf-&gt;io.flags
op_amp
id|CISTPL_IO_LINES_MASK
suffix:semicolon
id|i
op_assign
id|CardServices
c_func
(paren
id|RequestIO
comma
id|link-&gt;handle
comma
op_amp
id|link-&gt;io
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
op_eq
id|CS_SUCCESS
)paren
r_break
suffix:semicolon
)brace
id|i
op_assign
id|next_tuple
c_func
(paren
id|link-&gt;handle
comma
op_amp
id|tuple
comma
op_amp
id|parse
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|i
op_eq
id|CS_SUCCESS
)paren
id|dev-&gt;base_addr
op_assign
id|link-&gt;io.BasePort1
suffix:semicolon
r_return
id|i
suffix:semicolon
)brace
DECL|function|smc_setup
r_static
r_int
id|smc_setup
c_func
(paren
id|dev_link_t
op_star
id|link
)paren
(brace
id|client_handle_t
id|handle
op_assign
id|link-&gt;handle
suffix:semicolon
r_struct
id|smc_private
op_star
id|smc
op_assign
id|link-&gt;priv
suffix:semicolon
r_struct
id|net_device
op_star
id|dev
op_assign
op_amp
id|smc-&gt;dev
suffix:semicolon
id|tuple_t
id|tuple
suffix:semicolon
id|cisparse_t
id|parse
suffix:semicolon
id|cistpl_lan_node_id_t
op_star
id|node_id
suffix:semicolon
id|u_char
id|buf
(braket
l_int|255
)braket
comma
op_star
id|station_addr
suffix:semicolon
r_int
id|i
suffix:semicolon
id|tuple.Attributes
op_assign
id|tuple.TupleOffset
op_assign
l_int|0
suffix:semicolon
id|tuple.TupleData
op_assign
id|buf
suffix:semicolon
id|tuple.TupleDataMax
op_assign
r_sizeof
(paren
id|buf
)paren
suffix:semicolon
multiline_comment|/* Check for a LAN function extension tuple */
id|tuple.DesiredTuple
op_assign
id|CISTPL_FUNCE
suffix:semicolon
id|i
op_assign
id|first_tuple
c_func
(paren
id|handle
comma
op_amp
id|tuple
comma
op_amp
id|parse
)paren
suffix:semicolon
r_while
c_loop
(paren
id|i
op_eq
id|CS_SUCCESS
)paren
(brace
r_if
c_cond
(paren
id|parse.funce.type
op_eq
id|CISTPL_FUNCE_LAN_NODE_ID
)paren
r_break
suffix:semicolon
id|i
op_assign
id|next_tuple
c_func
(paren
id|handle
comma
op_amp
id|tuple
comma
op_amp
id|parse
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|i
op_eq
id|CS_SUCCESS
)paren
(brace
id|node_id
op_assign
(paren
id|cistpl_lan_node_id_t
op_star
)paren
id|parse.funce.data
suffix:semicolon
r_if
c_cond
(paren
id|node_id-&gt;nb
op_eq
l_int|6
)paren
(brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|6
suffix:semicolon
id|i
op_increment
)paren
id|dev-&gt;dev_addr
(braket
id|i
)braket
op_assign
id|node_id-&gt;id
(braket
id|i
)braket
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
)brace
multiline_comment|/* Try the third string in the Version 1 Version/ID tuple. */
id|tuple.DesiredTuple
op_assign
id|CISTPL_VERS_1
suffix:semicolon
r_if
c_cond
(paren
id|first_tuple
c_func
(paren
id|handle
comma
op_amp
id|tuple
comma
op_amp
id|parse
)paren
op_ne
id|CS_SUCCESS
)paren
r_return
op_minus
l_int|1
suffix:semicolon
id|station_addr
op_assign
id|parse.version_1.str
op_plus
id|parse.version_1.ofs
(braket
l_int|2
)braket
suffix:semicolon
r_if
c_cond
(paren
id|cvt_ascii_address
c_func
(paren
id|dev
comma
id|station_addr
)paren
op_eq
l_int|0
)paren
r_return
l_int|0
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
multiline_comment|/*====================================================================*/
DECL|function|osi_config
r_static
r_int
id|osi_config
c_func
(paren
id|dev_link_t
op_star
id|link
)paren
(brace
r_struct
id|smc_private
op_star
id|smc
op_assign
id|link-&gt;priv
suffix:semicolon
r_struct
id|net_device
op_star
id|dev
op_assign
op_amp
id|smc-&gt;dev
suffix:semicolon
r_static
id|ioaddr_t
id|com
(braket
l_int|4
)braket
op_assign
(brace
l_int|0x3f8
comma
l_int|0x2f8
comma
l_int|0x3e8
comma
l_int|0x2e8
)brace
suffix:semicolon
r_int
id|i
comma
id|j
suffix:semicolon
id|link-&gt;conf.Attributes
op_or_assign
id|CONF_ENABLE_SPKR
suffix:semicolon
id|link-&gt;conf.Status
op_assign
id|CCSR_AUDIO_ENA
suffix:semicolon
id|link-&gt;irq.Attributes
op_assign
id|IRQ_TYPE_DYNAMIC_SHARING
op_or
id|IRQ_FIRST_SHARED
op_or
id|IRQ_HANDLE_PRESENT
suffix:semicolon
id|link-&gt;io.NumPorts1
op_assign
l_int|64
suffix:semicolon
id|link-&gt;io.Attributes2
op_assign
id|IO_DATA_PATH_WIDTH_8
suffix:semicolon
id|link-&gt;io.NumPorts2
op_assign
l_int|8
suffix:semicolon
id|link-&gt;io.IOAddrLines
op_assign
l_int|16
suffix:semicolon
multiline_comment|/* Enable Hard Decode, LAN, Modem */
id|link-&gt;conf.ConfigIndex
op_assign
l_int|0x23
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
id|j
op_assign
l_int|0
suffix:semicolon
id|j
OL
l_int|4
suffix:semicolon
id|j
op_increment
)paren
(brace
id|link-&gt;io.BasePort2
op_assign
id|com
(braket
id|j
)braket
suffix:semicolon
id|i
op_assign
id|CardServices
c_func
(paren
id|RequestIO
comma
id|link-&gt;handle
comma
op_amp
id|link-&gt;io
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
op_eq
id|CS_SUCCESS
)paren
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|i
op_ne
id|CS_SUCCESS
)paren
(brace
multiline_comment|/* Fallback: turn off hard decode */
id|link-&gt;conf.ConfigIndex
op_assign
l_int|0x03
suffix:semicolon
id|link-&gt;io.NumPorts2
op_assign
l_int|0
suffix:semicolon
id|i
op_assign
id|CardServices
c_func
(paren
id|RequestIO
comma
id|link-&gt;handle
comma
op_amp
id|link-&gt;io
)paren
suffix:semicolon
)brace
id|dev-&gt;base_addr
op_assign
id|link-&gt;io.BasePort1
op_plus
l_int|0x10
suffix:semicolon
r_return
id|i
suffix:semicolon
)brace
DECL|function|osi_setup
r_static
r_int
id|osi_setup
c_func
(paren
id|dev_link_t
op_star
id|link
comma
id|u_short
id|manfid
comma
id|u_short
id|cardid
)paren
(brace
id|client_handle_t
id|handle
op_assign
id|link-&gt;handle
suffix:semicolon
r_struct
id|smc_private
op_star
id|smc
op_assign
id|link-&gt;priv
suffix:semicolon
r_struct
id|net_device
op_star
id|dev
op_assign
op_amp
id|smc-&gt;dev
suffix:semicolon
id|tuple_t
id|tuple
suffix:semicolon
id|u_char
id|buf
(braket
l_int|255
)braket
suffix:semicolon
r_int
id|i
suffix:semicolon
id|tuple.Attributes
op_assign
id|TUPLE_RETURN_COMMON
suffix:semicolon
id|tuple.TupleData
op_assign
id|buf
suffix:semicolon
id|tuple.TupleDataMax
op_assign
r_sizeof
(paren
id|buf
)paren
suffix:semicolon
id|tuple.TupleOffset
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Read the station address from tuple 0x90, subtuple 0x04 */
id|tuple.DesiredTuple
op_assign
l_int|0x90
suffix:semicolon
id|i
op_assign
id|CardServices
c_func
(paren
id|GetFirstTuple
comma
id|handle
comma
op_amp
id|tuple
)paren
suffix:semicolon
r_while
c_loop
(paren
id|i
op_eq
id|CS_SUCCESS
)paren
(brace
id|i
op_assign
id|CardServices
c_func
(paren
id|GetTupleData
comma
id|handle
comma
op_amp
id|tuple
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|i
op_ne
id|CS_SUCCESS
)paren
op_logical_or
(paren
id|buf
(braket
l_int|0
)braket
op_eq
l_int|0x04
)paren
)paren
r_break
suffix:semicolon
id|i
op_assign
id|CardServices
c_func
(paren
id|GetNextTuple
comma
id|handle
comma
op_amp
id|tuple
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|i
op_ne
id|CS_SUCCESS
)paren
r_return
op_minus
l_int|1
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|6
suffix:semicolon
id|i
op_increment
)paren
id|dev-&gt;dev_addr
(braket
id|i
)braket
op_assign
id|buf
(braket
id|i
op_plus
l_int|2
)braket
suffix:semicolon
r_if
c_cond
(paren
(paren
(paren
id|manfid
op_eq
id|MANFID_OSITECH
)paren
op_logical_and
(paren
id|cardid
op_eq
id|PRODID_OSITECH_SEVEN
)paren
)paren
op_logical_or
(paren
(paren
id|manfid
op_eq
id|MANFID_PSION
)paren
op_logical_and
(paren
id|cardid
op_eq
id|PRODID_PSION_NET100
)paren
)paren
)paren
(brace
multiline_comment|/* Download the Seven of Diamonds firmware */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
r_sizeof
(paren
id|__Xilinx7OD
)paren
suffix:semicolon
id|i
op_increment
)paren
(brace
id|outb
c_func
(paren
id|__Xilinx7OD
(braket
id|i
)braket
comma
id|link-&gt;io.BasePort1
op_plus
l_int|2
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|50
)paren
suffix:semicolon
)brace
)brace
r_else
r_if
c_cond
(paren
id|manfid
op_eq
id|MANFID_OSITECH
)paren
(brace
multiline_comment|/* Make sure both functions are powered up */
id|set_bits
c_func
(paren
l_int|0x300
comma
id|link-&gt;io.BasePort1
op_plus
id|OSITECH_AUI_PWR
)paren
suffix:semicolon
multiline_comment|/* Now, turn on the interrupt for both card functions */
id|set_bits
c_func
(paren
l_int|0x300
comma
id|link-&gt;io.BasePort1
op_plus
id|OSITECH_RESET_ISR
)paren
suffix:semicolon
id|DEBUG
c_func
(paren
l_int|2
comma
l_string|&quot;AUI/PWR: %4.4x RESET/ISR: %4.4x&bslash;n&quot;
comma
id|inw
c_func
(paren
id|link-&gt;io.BasePort1
op_plus
id|OSITECH_AUI_PWR
)paren
comma
id|inw
c_func
(paren
id|link-&gt;io.BasePort1
op_plus
id|OSITECH_RESET_ISR
)paren
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*======================================================================&n;&n;    This verifies that the chip is some SMC91cXX variant, and returns&n;    the revision code if successful.  Otherwise, it returns -ENODEV.&n;    &n;======================================================================*/
DECL|function|check_sig
r_static
r_int
id|check_sig
c_func
(paren
id|dev_link_t
op_star
id|link
)paren
(brace
r_struct
id|smc_private
op_star
id|smc
op_assign
id|link-&gt;priv
suffix:semicolon
r_struct
id|net_device
op_star
id|dev
op_assign
op_amp
id|smc-&gt;dev
suffix:semicolon
id|ioaddr_t
id|ioaddr
op_assign
id|dev-&gt;base_addr
suffix:semicolon
r_int
id|width
suffix:semicolon
id|u_short
id|s
suffix:semicolon
id|SMC_SELECT_BANK
c_func
(paren
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|inw
c_func
(paren
id|ioaddr
op_plus
id|BANK_SELECT
)paren
op_rshift
l_int|8
op_ne
l_int|0x33
)paren
(brace
multiline_comment|/* Try powering up the chip */
id|outw
c_func
(paren
l_int|0
comma
id|ioaddr
op_plus
id|CONTROL
)paren
suffix:semicolon
id|mdelay
c_func
(paren
l_int|55
)paren
suffix:semicolon
)brace
multiline_comment|/* Try setting bus width */
id|width
op_assign
(paren
id|link-&gt;io.Attributes1
op_eq
id|IO_DATA_PATH_WIDTH_AUTO
)paren
suffix:semicolon
id|s
op_assign
id|inb
c_func
(paren
id|ioaddr
op_plus
id|CONFIG
)paren
suffix:semicolon
r_if
c_cond
(paren
id|width
)paren
id|s
op_or_assign
id|CFG_16BIT
suffix:semicolon
r_else
id|s
op_and_assign
op_complement
id|CFG_16BIT
suffix:semicolon
id|outb
c_func
(paren
id|s
comma
id|ioaddr
op_plus
id|CONFIG
)paren
suffix:semicolon
multiline_comment|/* Check Base Address Register to make sure bus width is OK */
id|s
op_assign
id|inw
c_func
(paren
id|ioaddr
op_plus
id|BASE_ADDR
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|inw
c_func
(paren
id|ioaddr
op_plus
id|BANK_SELECT
)paren
op_rshift
l_int|8
op_eq
l_int|0x33
)paren
op_logical_and
(paren
(paren
id|s
op_rshift
l_int|8
)paren
op_ne
(paren
id|s
op_amp
l_int|0xff
)paren
)paren
)paren
(brace
id|SMC_SELECT_BANK
c_func
(paren
l_int|3
)paren
suffix:semicolon
id|s
op_assign
id|inw
c_func
(paren
id|ioaddr
op_plus
id|REVISION
)paren
suffix:semicolon
r_return
(paren
id|s
op_amp
l_int|0xff
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|width
)paren
(brace
id|event_callback_args_t
id|args
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;smc91c92_cs: using 8-bit IO window.&bslash;n&quot;
)paren
suffix:semicolon
id|args.client_data
op_assign
id|link
suffix:semicolon
id|smc91c92_event
c_func
(paren
id|CS_EVENT_RESET_PHYSICAL
comma
l_int|0
comma
op_amp
id|args
)paren
suffix:semicolon
id|CardServices
c_func
(paren
id|ReleaseIO
comma
id|link-&gt;handle
comma
op_amp
id|link-&gt;io
)paren
suffix:semicolon
id|link-&gt;io.Attributes1
op_assign
id|IO_DATA_PATH_WIDTH_8
suffix:semicolon
id|CardServices
c_func
(paren
id|RequestIO
comma
id|link-&gt;handle
comma
op_amp
id|link-&gt;io
)paren
suffix:semicolon
id|smc91c92_event
c_func
(paren
id|CS_EVENT_CARD_RESET
comma
l_int|0
comma
op_amp
id|args
)paren
suffix:semicolon
r_return
id|check_sig
c_func
(paren
id|link
)paren
suffix:semicolon
)brace
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
multiline_comment|/*======================================================================&n;&n;    smc91c92_config() is scheduled to run after a CARD_INSERTION event&n;    is received, to configure the PCMCIA socket, and to make the&n;    ethernet device available to the system.&n;&n;======================================================================*/
DECL|macro|CS_EXIT_TEST
mdefine_line|#define CS_EXIT_TEST(ret, svc, label) &bslash;&n;if (ret != CS_SUCCESS) { cs_error(link-&gt;handle, svc, ret); goto label; }
DECL|function|smc91c92_config
r_static
r_void
id|smc91c92_config
c_func
(paren
id|dev_link_t
op_star
id|link
)paren
(brace
id|client_handle_t
id|handle
op_assign
id|link-&gt;handle
suffix:semicolon
r_struct
id|smc_private
op_star
id|smc
op_assign
id|link-&gt;priv
suffix:semicolon
r_struct
id|net_device
op_star
id|dev
op_assign
op_amp
id|smc-&gt;dev
suffix:semicolon
id|tuple_t
id|tuple
suffix:semicolon
id|cisparse_t
id|parse
suffix:semicolon
id|u_short
id|buf
(braket
l_int|32
)braket
suffix:semicolon
r_char
op_star
id|name
suffix:semicolon
r_int
id|i
comma
id|rev
suffix:semicolon
id|DEBUG
c_func
(paren
l_int|0
comma
l_string|&quot;smc91c92_config(0x%p)&bslash;n&quot;
comma
id|link
)paren
suffix:semicolon
id|tuple.Attributes
op_assign
id|tuple.TupleOffset
op_assign
l_int|0
suffix:semicolon
id|tuple.TupleData
op_assign
(paren
id|cisdata_t
op_star
)paren
id|buf
suffix:semicolon
id|tuple.TupleDataMax
op_assign
r_sizeof
(paren
id|buf
)paren
suffix:semicolon
id|tuple.DesiredTuple
op_assign
id|CISTPL_CONFIG
suffix:semicolon
id|i
op_assign
id|first_tuple
c_func
(paren
id|handle
comma
op_amp
id|tuple
comma
op_amp
id|parse
)paren
suffix:semicolon
id|CS_EXIT_TEST
c_func
(paren
id|i
comma
id|ParseTuple
comma
id|config_failed
)paren
suffix:semicolon
id|link-&gt;conf.ConfigBase
op_assign
id|parse.config.base
suffix:semicolon
id|link-&gt;conf.Present
op_assign
id|parse.config.rmask
(braket
l_int|0
)braket
suffix:semicolon
id|tuple.DesiredTuple
op_assign
id|CISTPL_MANFID
suffix:semicolon
id|tuple.Attributes
op_assign
id|TUPLE_RETURN_COMMON
suffix:semicolon
r_if
c_cond
(paren
id|first_tuple
c_func
(paren
id|handle
comma
op_amp
id|tuple
comma
op_amp
id|parse
)paren
op_eq
id|CS_SUCCESS
)paren
(brace
id|smc-&gt;manfid
op_assign
id|parse.manfid.manf
suffix:semicolon
id|smc-&gt;cardid
op_assign
id|parse.manfid.card
suffix:semicolon
)brace
multiline_comment|/* Configure card */
id|link-&gt;state
op_or_assign
id|DEV_CONFIG
suffix:semicolon
r_if
c_cond
(paren
(paren
id|smc-&gt;manfid
op_eq
id|MANFID_OSITECH
)paren
op_logical_and
(paren
id|smc-&gt;cardid
op_ne
id|PRODID_OSITECH_SEVEN
)paren
)paren
(brace
id|i
op_assign
id|osi_config
c_func
(paren
id|link
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
(paren
id|smc-&gt;manfid
op_eq
id|MANFID_MOTOROLA
)paren
op_logical_or
(paren
(paren
id|smc-&gt;manfid
op_eq
id|MANFID_MEGAHERTZ
)paren
op_logical_and
(paren
(paren
id|smc-&gt;cardid
op_eq
id|PRODID_MEGAHERTZ_VARIOUS
)paren
op_logical_or
(paren
id|smc-&gt;cardid
op_eq
id|PRODID_MEGAHERTZ_EM3288
)paren
)paren
)paren
)paren
(brace
id|i
op_assign
id|mhz_mfc_config
c_func
(paren
id|link
)paren
suffix:semicolon
)brace
r_else
(brace
id|i
op_assign
id|smc_config
c_func
(paren
id|link
)paren
suffix:semicolon
)brace
id|CS_EXIT_TEST
c_func
(paren
id|i
comma
id|RequestIO
comma
id|config_failed
)paren
suffix:semicolon
id|i
op_assign
id|CardServices
c_func
(paren
id|RequestIRQ
comma
id|link-&gt;handle
comma
op_amp
id|link-&gt;irq
)paren
suffix:semicolon
id|CS_EXIT_TEST
c_func
(paren
id|i
comma
id|RequestIRQ
comma
id|config_failed
)paren
suffix:semicolon
id|i
op_assign
id|CardServices
c_func
(paren
id|RequestConfiguration
comma
id|link-&gt;handle
comma
op_amp
id|link-&gt;conf
)paren
suffix:semicolon
id|CS_EXIT_TEST
c_func
(paren
id|i
comma
id|RequestConfiguration
comma
id|config_failed
)paren
suffix:semicolon
r_if
c_cond
(paren
id|smc-&gt;manfid
op_eq
id|MANFID_MOTOROLA
)paren
id|mot_config
c_func
(paren
id|link
)paren
suffix:semicolon
id|dev-&gt;irq
op_assign
id|link-&gt;irq.AssignedIRQ
suffix:semicolon
r_if
c_cond
(paren
(paren
id|if_port
op_ge
l_int|0
)paren
op_logical_and
(paren
id|if_port
op_le
l_int|2
)paren
)paren
id|dev-&gt;if_port
op_assign
id|if_port
suffix:semicolon
r_else
id|printk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;smc91c92_cs: invalid if_port requested&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|register_netdev
c_func
(paren
id|dev
)paren
op_ne
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;smc91c92_cs: register_netdev() failed&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|config_undo
suffix:semicolon
)brace
r_switch
c_cond
(paren
id|smc-&gt;manfid
)paren
(brace
r_case
id|MANFID_OSITECH
suffix:colon
r_case
id|MANFID_PSION
suffix:colon
id|i
op_assign
id|osi_setup
c_func
(paren
id|link
comma
id|smc-&gt;manfid
comma
id|smc-&gt;cardid
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MANFID_SMC
suffix:colon
r_case
id|MANFID_NEW_MEDIA
suffix:colon
id|i
op_assign
id|smc_setup
c_func
(paren
id|link
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x128
suffix:colon
multiline_comment|/* For broken Megahertz cards */
r_case
id|MANFID_MEGAHERTZ
suffix:colon
id|i
op_assign
id|mhz_setup
c_func
(paren
id|link
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MANFID_MOTOROLA
suffix:colon
r_default
suffix:colon
multiline_comment|/* get the hw address from EEPROM */
id|i
op_assign
id|mot_setup
c_func
(paren
id|link
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|i
op_ne
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;smc91c92_cs: Unable to find hardware address.&bslash;n&quot;
)paren
suffix:semicolon
id|link-&gt;state
op_and_assign
op_complement
id|DEV_CONFIG_PENDING
suffix:semicolon
r_goto
id|config_undo
suffix:semicolon
)brace
id|strcpy
c_func
(paren
id|smc-&gt;node.dev_name
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|link-&gt;dev
op_assign
op_amp
id|smc-&gt;node
suffix:semicolon
id|link-&gt;state
op_and_assign
op_complement
id|DEV_CONFIG_PENDING
suffix:semicolon
id|rev
op_assign
id|check_sig
c_func
(paren
id|link
)paren
suffix:semicolon
id|name
op_assign
l_string|&quot;???&quot;
suffix:semicolon
r_if
c_cond
(paren
id|rev
OG
l_int|0
)paren
r_switch
c_cond
(paren
id|rev
op_rshift
l_int|4
)paren
(brace
r_case
l_int|3
suffix:colon
id|name
op_assign
l_string|&quot;92&quot;
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|4
suffix:colon
id|name
op_assign
(paren
(paren
id|rev
op_amp
l_int|15
)paren
op_ge
l_int|6
)paren
ques
c_cond
l_string|&quot;96&quot;
suffix:colon
l_string|&quot;94&quot;
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|5
suffix:colon
id|name
op_assign
l_string|&quot;95&quot;
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|7
suffix:colon
id|name
op_assign
l_string|&quot;100&quot;
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|8
suffix:colon
id|name
op_assign
l_string|&quot;100-FD&quot;
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|9
suffix:colon
id|name
op_assign
l_string|&quot;110&quot;
suffix:semicolon
r_break
suffix:semicolon
)brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: smc91c%s rev %d: io %#3lx, irq %d, &quot;
l_string|&quot;hw_addr &quot;
comma
id|dev-&gt;name
comma
id|name
comma
(paren
id|rev
op_amp
l_int|0x0f
)paren
comma
id|dev-&gt;base_addr
comma
id|dev-&gt;irq
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|6
suffix:semicolon
id|i
op_increment
)paren
id|printk
c_func
(paren
l_string|&quot;%02X%s&quot;
comma
id|dev-&gt;dev_addr
(braket
id|i
)braket
comma
(paren
(paren
id|i
OL
l_int|5
)paren
ques
c_cond
l_string|&quot;:&quot;
suffix:colon
l_string|&quot;&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rev
OG
l_int|0
)paren
(brace
id|u_long
id|mir
comma
id|mcr
suffix:semicolon
id|ioaddr_t
id|ioaddr
op_assign
id|dev-&gt;base_addr
suffix:semicolon
id|SMC_SELECT_BANK
c_func
(paren
l_int|0
)paren
suffix:semicolon
id|mir
op_assign
id|inw
c_func
(paren
id|ioaddr
op_plus
id|MEMINFO
)paren
op_amp
l_int|0xff
suffix:semicolon
r_if
c_cond
(paren
id|mir
op_eq
l_int|0xff
)paren
id|mir
op_increment
suffix:semicolon
multiline_comment|/* Get scale factor for memory size */
id|mcr
op_assign
(paren
(paren
id|rev
op_rshift
l_int|4
)paren
OG
l_int|3
)paren
ques
c_cond
id|inw
c_func
(paren
id|ioaddr
op_plus
id|MEMCFG
)paren
suffix:colon
l_int|0x0200
suffix:semicolon
id|mir
op_mul_assign
l_int|128
op_star
(paren
l_int|1
op_lshift
(paren
(paren
id|mcr
op_rshift
l_int|9
)paren
op_amp
l_int|7
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mir
op_amp
l_int|0x3ff
)paren
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;  %lu byte&quot;
comma
id|mir
)paren
suffix:semicolon
r_else
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;  %lu kb&quot;
comma
id|mir
op_rshift
l_int|10
)paren
suffix:semicolon
id|SMC_SELECT_BANK
c_func
(paren
l_int|1
)paren
suffix:semicolon
id|smc-&gt;cfg
op_assign
id|inw
c_func
(paren
id|ioaddr
op_plus
id|CONFIG
)paren
op_amp
op_complement
id|CFG_AUI_SELECT
suffix:semicolon
id|smc-&gt;cfg
op_or_assign
id|CFG_NO_WAIT
op_or
id|CFG_16BIT
op_or
id|CFG_STATIC
suffix:semicolon
r_if
c_cond
(paren
id|smc-&gt;manfid
op_eq
id|MANFID_OSITECH
)paren
id|smc-&gt;cfg
op_or_assign
id|CFG_IRQ_SEL_1
op_or
id|CFG_IRQ_SEL_0
suffix:semicolon
r_if
c_cond
(paren
(paren
id|rev
op_rshift
l_int|4
)paren
op_ge
l_int|7
)paren
id|smc-&gt;cfg
op_or_assign
id|CFG_MII_SELECT
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot; buffer, %s xcvr&bslash;n&quot;
comma
(paren
id|smc-&gt;cfg
op_amp
id|CFG_MII_SELECT
)paren
ques
c_cond
l_string|&quot;MII&quot;
suffix:colon
id|if_names
(braket
id|dev-&gt;if_port
)braket
)paren
suffix:semicolon
)brace
r_return
suffix:semicolon
id|config_undo
suffix:colon
id|unregister_netdev
c_func
(paren
id|dev
)paren
suffix:semicolon
id|config_failed
suffix:colon
multiline_comment|/* CS_EXIT_TEST() calls jump to here... */
id|smc91c92_release
c_func
(paren
(paren
id|u_long
)paren
id|link
)paren
suffix:semicolon
)brace
multiline_comment|/* smc91c92_config */
multiline_comment|/*======================================================================&n;&n;    After a card is removed, smc91c92_release() will unregister the net&n;    device, and release the PCMCIA configuration.  If the device is&n;    still open, this will be postponed until it is closed.&n;&n;======================================================================*/
DECL|function|smc91c92_release
r_static
r_void
id|smc91c92_release
c_func
(paren
id|u_long
id|arg
)paren
(brace
id|dev_link_t
op_star
id|link
op_assign
(paren
id|dev_link_t
op_star
)paren
id|arg
suffix:semicolon
r_struct
id|smc_private
op_star
id|smc
op_assign
id|link-&gt;priv
suffix:semicolon
id|DEBUG
c_func
(paren
l_int|0
comma
l_string|&quot;smc91c92_release(0x%p)&bslash;n&quot;
comma
id|link
)paren
suffix:semicolon
r_if
c_cond
(paren
id|link-&gt;open
)paren
(brace
id|DEBUG
c_func
(paren
l_int|1
comma
l_string|&quot;smc91c92_cs: release postponed, &squot;%s&squot; still open&bslash;n&quot;
comma
id|link-&gt;dev-&gt;dev_name
)paren
suffix:semicolon
id|link-&gt;state
op_or_assign
id|DEV_STALE_CONFIG
suffix:semicolon
r_return
suffix:semicolon
)brace
id|CardServices
c_func
(paren
id|ReleaseConfiguration
comma
id|link-&gt;handle
)paren
suffix:semicolon
id|CardServices
c_func
(paren
id|ReleaseIO
comma
id|link-&gt;handle
comma
op_amp
id|link-&gt;io
)paren
suffix:semicolon
id|CardServices
c_func
(paren
id|ReleaseIRQ
comma
id|link-&gt;handle
comma
op_amp
id|link-&gt;irq
)paren
suffix:semicolon
r_if
c_cond
(paren
id|link-&gt;win
)paren
(brace
id|iounmap
c_func
(paren
id|smc-&gt;base
)paren
suffix:semicolon
id|CardServices
c_func
(paren
id|ReleaseWindow
comma
id|link-&gt;win
)paren
suffix:semicolon
)brace
id|link-&gt;state
op_and_assign
op_complement
id|DEV_CONFIG
suffix:semicolon
)brace
multiline_comment|/* smc91c92_release */
multiline_comment|/*======================================================================&n;&n;    The card status event handler.  Mostly, this schedules other&n;    stuff to run after an event is received.  A CARD_REMOVAL event&n;    also sets some flags to discourage the net drivers from trying&n;    to talk to the card any more.&n;&n;======================================================================*/
DECL|function|smc91c92_event
r_static
r_int
id|smc91c92_event
c_func
(paren
id|event_t
id|event
comma
r_int
id|priority
comma
id|event_callback_args_t
op_star
id|args
)paren
(brace
id|dev_link_t
op_star
id|link
op_assign
id|args-&gt;client_data
suffix:semicolon
r_struct
id|smc_private
op_star
id|smc
op_assign
id|link-&gt;priv
suffix:semicolon
r_struct
id|net_device
op_star
id|dev
op_assign
op_amp
id|smc-&gt;dev
suffix:semicolon
id|DEBUG
c_func
(paren
l_int|1
comma
l_string|&quot;smc91c92_event(0x%06x)&bslash;n&quot;
comma
id|event
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|event
)paren
(brace
r_case
id|CS_EVENT_CARD_REMOVAL
suffix:colon
id|link-&gt;state
op_and_assign
op_complement
id|DEV_PRESENT
suffix:semicolon
r_if
c_cond
(paren
id|link-&gt;state
op_amp
id|DEV_CONFIG
)paren
(brace
id|netif_device_detach
c_func
(paren
id|dev
)paren
suffix:semicolon
id|mod_timer
c_func
(paren
op_amp
id|link-&gt;release
comma
id|jiffies
op_plus
id|HZ
op_div
l_int|20
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|CS_EVENT_CARD_INSERTION
suffix:colon
id|link-&gt;state
op_or_assign
id|DEV_PRESENT
suffix:semicolon
id|smc91c92_config
c_func
(paren
id|link
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CS_EVENT_PM_SUSPEND
suffix:colon
id|link-&gt;state
op_or_assign
id|DEV_SUSPEND
suffix:semicolon
multiline_comment|/* Fall through... */
r_case
id|CS_EVENT_RESET_PHYSICAL
suffix:colon
r_if
c_cond
(paren
id|link-&gt;state
op_amp
id|DEV_CONFIG
)paren
(brace
r_if
c_cond
(paren
id|link-&gt;open
)paren
id|netif_device_detach
c_func
(paren
id|dev
)paren
suffix:semicolon
id|CardServices
c_func
(paren
id|ReleaseConfiguration
comma
id|link-&gt;handle
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|CS_EVENT_PM_RESUME
suffix:colon
id|link-&gt;state
op_and_assign
op_complement
id|DEV_SUSPEND
suffix:semicolon
multiline_comment|/* Fall through... */
r_case
id|CS_EVENT_CARD_RESET
suffix:colon
r_if
c_cond
(paren
id|link-&gt;state
op_amp
id|DEV_CONFIG
)paren
(brace
r_if
c_cond
(paren
(paren
id|smc-&gt;manfid
op_eq
id|MANFID_MEGAHERTZ
)paren
op_logical_and
(paren
id|smc-&gt;cardid
op_eq
id|PRODID_MEGAHERTZ_EM3288
)paren
)paren
id|mhz_3288_power
c_func
(paren
id|link
)paren
suffix:semicolon
id|CardServices
c_func
(paren
id|RequestConfiguration
comma
id|link-&gt;handle
comma
op_amp
id|link-&gt;conf
)paren
suffix:semicolon
r_if
c_cond
(paren
id|smc-&gt;manfid
op_eq
id|MANFID_MOTOROLA
)paren
id|mot_config
c_func
(paren
id|link
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|smc-&gt;manfid
op_eq
id|MANFID_OSITECH
)paren
op_logical_and
(paren
id|smc-&gt;cardid
op_ne
id|PRODID_OSITECH_SEVEN
)paren
)paren
(brace
multiline_comment|/* Power up the card and enable interrupts */
id|set_bits
c_func
(paren
l_int|0x0300
comma
id|dev-&gt;base_addr
op_minus
l_int|0x10
op_plus
id|OSITECH_AUI_PWR
)paren
suffix:semicolon
id|set_bits
c_func
(paren
l_int|0x0300
comma
id|dev-&gt;base_addr
op_minus
l_int|0x10
op_plus
id|OSITECH_RESET_ISR
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|link-&gt;open
)paren
(brace
id|smc_reset
c_func
(paren
id|dev
)paren
suffix:semicolon
id|netif_device_attach
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
)brace
r_break
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* smc91c92_event */
multiline_comment|/*======================================================================&n;  &n;    The driver core code, most of which should be common with a&n;    non-PCMCIA implementation.&n;    &n;======================================================================*/
macro_line|#ifdef PCMCIA_DEBUG
DECL|function|smc_dump
r_static
r_void
id|smc_dump
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
id|ioaddr_t
id|ioaddr
op_assign
id|dev-&gt;base_addr
suffix:semicolon
id|u_short
id|i
comma
id|w
comma
id|save
suffix:semicolon
id|save
op_assign
id|inw
c_func
(paren
id|ioaddr
op_plus
id|BANK_SELECT
)paren
suffix:semicolon
r_for
c_loop
(paren
id|w
op_assign
l_int|0
suffix:semicolon
id|w
OL
l_int|4
suffix:semicolon
id|w
op_increment
)paren
(brace
id|SMC_SELECT_BANK
c_func
(paren
id|w
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;bank %d: &quot;
comma
id|w
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|14
suffix:semicolon
id|i
op_add_assign
l_int|2
)paren
id|printk
c_func
(paren
l_string|&quot; %04x&quot;
comma
id|inw
c_func
(paren
id|ioaddr
op_plus
id|i
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
)brace
id|outw
c_func
(paren
id|save
comma
id|ioaddr
op_plus
id|BANK_SELECT
)paren
suffix:semicolon
)brace
macro_line|#endif
DECL|function|smc91c92_open
r_static
r_int
id|smc91c92_open
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|smc_private
op_star
id|smc
op_assign
id|dev-&gt;priv
suffix:semicolon
id|dev_link_t
op_star
id|link
op_assign
op_amp
id|smc-&gt;link
suffix:semicolon
macro_line|#ifdef PCMCIA_DEBUG
id|DEBUG
c_func
(paren
l_int|0
comma
l_string|&quot;%s: smc91c92_open(%p), ID/Window %4.4x.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|dev
comma
id|inw
c_func
(paren
id|dev-&gt;base_addr
op_plus
id|BANK_SELECT
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pc_debug
OG
l_int|1
)paren
id|smc_dump
c_func
(paren
id|dev
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/* Check that the PCMCIA card is still here. */
r_if
c_cond
(paren
op_logical_neg
id|DEV_OK
c_func
(paren
id|link
)paren
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
multiline_comment|/* Physical device present signature. */
r_if
c_cond
(paren
id|check_sig
c_func
(paren
id|link
)paren
OL
l_int|0
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;smc91c92_cs: Yikes!  Bad chip signature!&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
id|link-&gt;open
op_increment
suffix:semicolon
id|MOD_INC_USE_COUNT
suffix:semicolon
id|netif_start_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
id|smc-&gt;saved_skb
op_assign
l_int|0
suffix:semicolon
id|smc-&gt;packets_waiting
op_assign
l_int|0
suffix:semicolon
id|smc_reset
c_func
(paren
id|dev
)paren
suffix:semicolon
id|smc-&gt;media.function
op_assign
op_amp
id|media_check
suffix:semicolon
id|smc-&gt;media.data
op_assign
(paren
id|u_long
)paren
id|smc
suffix:semicolon
id|smc-&gt;media.expires
op_assign
id|jiffies
op_plus
id|HZ
suffix:semicolon
id|add_timer
c_func
(paren
op_amp
id|smc-&gt;media
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* smc91c92_open */
multiline_comment|/*====================================================================*/
DECL|function|smc91c92_close
r_static
r_int
id|smc91c92_close
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|smc_private
op_star
id|smc
op_assign
id|dev-&gt;priv
suffix:semicolon
id|dev_link_t
op_star
id|link
op_assign
op_amp
id|smc-&gt;link
suffix:semicolon
id|ioaddr_t
id|ioaddr
op_assign
id|dev-&gt;base_addr
suffix:semicolon
id|DEBUG
c_func
(paren
l_int|0
comma
l_string|&quot;%s: smc91c92_close(), status %4.4x.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|inw
c_func
(paren
id|ioaddr
op_plus
id|BANK_SELECT
)paren
)paren
suffix:semicolon
id|netif_stop_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
multiline_comment|/* Shut off all interrupts, and turn off the Tx and Rx sections.&n;       Don&squot;t bother to check for chip present. */
id|SMC_SELECT_BANK
c_func
(paren
l_int|2
)paren
suffix:semicolon
multiline_comment|/* Nominally paranoia, but do no assume... */
id|outw
c_func
(paren
l_int|0
comma
id|ioaddr
op_plus
id|INTERRUPT
)paren
suffix:semicolon
id|SMC_SELECT_BANK
c_func
(paren
l_int|0
)paren
suffix:semicolon
id|mask_bits
c_func
(paren
l_int|0xff00
comma
id|ioaddr
op_plus
id|RCR
)paren
suffix:semicolon
id|mask_bits
c_func
(paren
l_int|0xff00
comma
id|ioaddr
op_plus
id|TCR
)paren
suffix:semicolon
multiline_comment|/* Put the chip into power-down mode. */
id|SMC_SELECT_BANK
c_func
(paren
l_int|1
)paren
suffix:semicolon
id|outw
c_func
(paren
id|CTL_POWERDOWN
comma
id|ioaddr
op_plus
id|CONTROL
)paren
suffix:semicolon
id|link-&gt;open
op_decrement
suffix:semicolon
id|del_timer
c_func
(paren
op_amp
id|smc-&gt;media
)paren
suffix:semicolon
r_if
c_cond
(paren
id|link-&gt;state
op_amp
id|DEV_STALE_CONFIG
)paren
id|mod_timer
c_func
(paren
op_amp
id|link-&gt;release
comma
id|jiffies
op_plus
id|HZ
op_div
l_int|20
)paren
suffix:semicolon
id|MOD_DEC_USE_COUNT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* smc91c92_close */
multiline_comment|/*======================================================================&n;&n;   Transfer a packet to the hardware and trigger the packet send.&n;   This may be called at either from either the Tx queue code&n;   or the interrupt handler.&n;   &n;======================================================================*/
DECL|function|smc_hardware_send_packet
r_static
r_void
id|smc_hardware_send_packet
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|smc_private
op_star
id|smc
op_assign
id|dev-&gt;priv
suffix:semicolon
r_struct
id|sk_buff
op_star
id|skb
op_assign
id|smc-&gt;saved_skb
suffix:semicolon
id|ioaddr_t
id|ioaddr
op_assign
id|dev-&gt;base_addr
suffix:semicolon
id|u_char
id|packet_no
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|skb
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: In XMIT with no packet to send.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/* There should be a packet slot waiting. */
id|packet_no
op_assign
id|inw
c_func
(paren
id|ioaddr
op_plus
id|PNR_ARR
)paren
op_rshift
l_int|8
suffix:semicolon
r_if
c_cond
(paren
id|packet_no
op_amp
l_int|0x80
)paren
(brace
multiline_comment|/* If not, there is a hardware problem!  Likely an ejected card. */
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: 91c92 hardware Tx buffer allocation&quot;
l_string|&quot; failed, status %#2.2x.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|packet_no
)paren
suffix:semicolon
id|dev_kfree_skb_irq
c_func
(paren
id|skb
)paren
suffix:semicolon
id|smc-&gt;saved_skb
op_assign
l_int|NULL
suffix:semicolon
id|netif_start_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|smc-&gt;stats.tx_bytes
op_add_assign
id|skb-&gt;len
suffix:semicolon
multiline_comment|/* The card should use the just-allocated buffer. */
id|outw
c_func
(paren
id|packet_no
comma
id|ioaddr
op_plus
id|PNR_ARR
)paren
suffix:semicolon
multiline_comment|/* point to the beginning of the packet */
id|outw
c_func
(paren
id|PTR_AUTOINC
comma
id|ioaddr
op_plus
id|POINTER
)paren
suffix:semicolon
multiline_comment|/* Send the packet length (+6 for status, length and ctl byte)&n;       and the status word (set to zeros). */
(brace
id|u_char
op_star
id|buf
op_assign
id|skb-&gt;data
suffix:semicolon
id|u_int
id|length
op_assign
id|skb-&gt;len
suffix:semicolon
multiline_comment|/* The chip will pad to ethernet min. */
id|DEBUG
c_func
(paren
l_int|2
comma
l_string|&quot;%s: Trying to xmit packet of length %d.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|length
)paren
suffix:semicolon
multiline_comment|/* send the packet length: +6 for status word, length, and ctl */
id|outw
c_func
(paren
l_int|0
comma
id|ioaddr
op_plus
id|DATA_1
)paren
suffix:semicolon
id|outw
c_func
(paren
id|length
op_plus
l_int|6
comma
id|ioaddr
op_plus
id|DATA_1
)paren
suffix:semicolon
id|outsw
c_func
(paren
id|ioaddr
op_plus
id|DATA_1
comma
id|buf
comma
id|length
op_rshift
l_int|1
)paren
suffix:semicolon
multiline_comment|/* The odd last byte, if there is one, goes in the control word. */
id|outw
c_func
(paren
(paren
id|length
op_amp
l_int|1
)paren
ques
c_cond
l_int|0x2000
op_or
id|buf
(braket
id|length
op_minus
l_int|1
)braket
suffix:colon
l_int|0
comma
id|ioaddr
op_plus
id|DATA_1
)paren
suffix:semicolon
)brace
multiline_comment|/* Enable the Tx interrupts, both Tx (TxErr) and TxEmpty. */
id|outw
c_func
(paren
(paren
(paren
id|IM_TX_INT
op_or
id|IM_TX_EMPTY_INT
)paren
op_lshift
l_int|8
)paren
op_or
(paren
id|inw
c_func
(paren
id|ioaddr
op_plus
id|INTERRUPT
)paren
op_amp
l_int|0xff00
)paren
comma
id|ioaddr
op_plus
id|INTERRUPT
)paren
suffix:semicolon
multiline_comment|/* The chip does the rest of the work. */
id|outw
c_func
(paren
id|MC_ENQUEUE
comma
id|ioaddr
op_plus
id|MMU_CMD
)paren
suffix:semicolon
id|smc-&gt;saved_skb
op_assign
l_int|NULL
suffix:semicolon
id|dev_kfree_skb_irq
c_func
(paren
id|skb
)paren
suffix:semicolon
id|dev-&gt;trans_start
op_assign
id|jiffies
suffix:semicolon
id|netif_start_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/*====================================================================*/
DECL|function|smc_tx_timeout
r_static
r_void
id|smc_tx_timeout
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|smc_private
op_star
id|smc
op_assign
id|dev-&gt;priv
suffix:semicolon
id|ioaddr_t
id|ioaddr
op_assign
id|dev-&gt;base_addr
suffix:semicolon
id|printk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;%s: SMC91c92 transmit timed out, &quot;
l_string|&quot;Tx_status %2.2x status %4.4x.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|inw
c_func
(paren
id|ioaddr
)paren
op_amp
l_int|0xff
comma
id|inw
c_func
(paren
id|ioaddr
op_plus
l_int|2
)paren
)paren
suffix:semicolon
id|smc-&gt;stats.tx_errors
op_increment
suffix:semicolon
id|smc_reset
c_func
(paren
id|dev
)paren
suffix:semicolon
id|dev-&gt;trans_start
op_assign
id|jiffies
suffix:semicolon
id|smc-&gt;saved_skb
op_assign
l_int|NULL
suffix:semicolon
id|netif_start_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
DECL|function|smc_start_xmit
r_static
r_int
id|smc_start_xmit
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|smc_private
op_star
id|smc
op_assign
id|dev-&gt;priv
suffix:semicolon
id|ioaddr_t
id|ioaddr
op_assign
id|dev-&gt;base_addr
suffix:semicolon
id|u_short
id|num_pages
suffix:semicolon
r_int
id|time_out
comma
id|ir
suffix:semicolon
id|netif_stop_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
id|DEBUG
c_func
(paren
l_int|2
comma
l_string|&quot;%s: smc91c92_start_xmit(length = %d) called,&quot;
l_string|&quot; status %4.4x.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|skb-&gt;len
comma
id|inw
c_func
(paren
id|ioaddr
op_plus
l_int|2
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|smc-&gt;saved_skb
)paren
(brace
multiline_comment|/* THIS SHOULD NEVER HAPPEN. */
id|smc-&gt;stats.tx_aborted_errors
op_increment
suffix:semicolon
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%s: Internal error -- sent packet while busy.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
id|smc-&gt;saved_skb
op_assign
id|skb
suffix:semicolon
id|num_pages
op_assign
id|skb-&gt;len
op_rshift
l_int|8
suffix:semicolon
r_if
c_cond
(paren
id|num_pages
OG
l_int|7
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: Far too big packet error.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|dev_kfree_skb
(paren
id|skb
)paren
suffix:semicolon
id|smc-&gt;saved_skb
op_assign
l_int|NULL
suffix:semicolon
id|smc-&gt;stats.tx_dropped
op_increment
suffix:semicolon
r_return
l_int|0
suffix:semicolon
multiline_comment|/* Do not re-queue this packet. */
)brace
multiline_comment|/* A packet is now waiting. */
id|smc-&gt;packets_waiting
op_increment
suffix:semicolon
id|SMC_SELECT_BANK
c_func
(paren
l_int|2
)paren
suffix:semicolon
multiline_comment|/* Paranoia, we should always be in window 2 */
multiline_comment|/* Allocate the memory; send the packet now if we win. */
id|outw
c_func
(paren
id|MC_ALLOC
op_or
id|num_pages
comma
id|ioaddr
op_plus
id|MMU_CMD
)paren
suffix:semicolon
r_for
c_loop
(paren
id|time_out
op_assign
id|MEMORY_WAIT_TIME
suffix:semicolon
id|time_out
op_ge
l_int|0
suffix:semicolon
id|time_out
op_decrement
)paren
(brace
id|ir
op_assign
id|inw
c_func
(paren
id|ioaddr
op_plus
id|INTERRUPT
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ir
op_amp
id|IM_ALLOC_INT
)paren
(brace
multiline_comment|/* Acknowledge the interrupt, send the packet. */
id|outw
c_func
(paren
(paren
id|ir
op_amp
l_int|0xff00
)paren
op_or
id|IM_ALLOC_INT
comma
id|ioaddr
op_plus
id|INTERRUPT
)paren
suffix:semicolon
id|smc_hardware_send_packet
c_func
(paren
id|dev
)paren
suffix:semicolon
multiline_comment|/* Send the packet now.. */
r_return
l_int|0
suffix:semicolon
)brace
)brace
multiline_comment|/* Otherwise defer until the Tx-space-allocated interrupt. */
id|DEBUG
c_func
(paren
l_int|2
comma
l_string|&quot;%s: memory allocation deferred.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|outw
c_func
(paren
(paren
id|IM_ALLOC_INT
op_lshift
l_int|8
)paren
op_or
(paren
id|ir
op_amp
l_int|0xff00
)paren
comma
id|ioaddr
op_plus
id|INTERRUPT
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*======================================================================&n;&n;    Handle a Tx anomolous event.  Entered while in Window 2.&n;    &n;======================================================================*/
DECL|function|smc_tx_err
r_static
r_void
id|smc_tx_err
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|smc_private
op_star
id|smc
op_assign
(paren
r_struct
id|smc_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|ioaddr_t
id|ioaddr
op_assign
id|dev-&gt;base_addr
suffix:semicolon
r_int
id|saved_packet
op_assign
id|inw
c_func
(paren
id|ioaddr
op_plus
id|PNR_ARR
)paren
op_amp
l_int|0xff
suffix:semicolon
r_int
id|packet_no
op_assign
id|inw
c_func
(paren
id|ioaddr
op_plus
id|FIFO_PORTS
)paren
op_amp
l_int|0x7f
suffix:semicolon
r_int
id|tx_status
suffix:semicolon
multiline_comment|/* select this as the packet to read from */
id|outw
c_func
(paren
id|packet_no
comma
id|ioaddr
op_plus
id|PNR_ARR
)paren
suffix:semicolon
multiline_comment|/* read the first word from this packet */
id|outw
c_func
(paren
id|PTR_AUTOINC
op_or
id|PTR_READ
op_or
l_int|0
comma
id|ioaddr
op_plus
id|POINTER
)paren
suffix:semicolon
id|tx_status
op_assign
id|inw
c_func
(paren
id|ioaddr
op_plus
id|DATA_1
)paren
suffix:semicolon
id|smc-&gt;stats.tx_errors
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|tx_status
op_amp
id|TS_LOSTCAR
)paren
id|smc-&gt;stats.tx_carrier_errors
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|tx_status
op_amp
id|TS_LATCOL
)paren
id|smc-&gt;stats.tx_window_errors
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|tx_status
op_amp
id|TS_16COL
)paren
(brace
id|smc-&gt;stats.tx_aborted_errors
op_increment
suffix:semicolon
id|smc-&gt;tx_err
op_increment
suffix:semicolon
)brace
r_if
c_cond
(paren
id|tx_status
op_amp
id|TS_SUCCESS
)paren
(brace
id|printk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;%s: Successful packet caused error &quot;
l_string|&quot;interrupt?&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
)brace
multiline_comment|/* re-enable transmit */
id|SMC_SELECT_BANK
c_func
(paren
l_int|0
)paren
suffix:semicolon
id|outw
c_func
(paren
id|inw
c_func
(paren
id|ioaddr
op_plus
id|TCR
)paren
op_or
id|TCR_ENABLE
comma
id|ioaddr
op_plus
id|TCR
)paren
suffix:semicolon
id|SMC_SELECT_BANK
c_func
(paren
l_int|2
)paren
suffix:semicolon
id|outw
c_func
(paren
id|MC_FREEPKT
comma
id|ioaddr
op_plus
id|MMU_CMD
)paren
suffix:semicolon
multiline_comment|/* Free the packet memory. */
multiline_comment|/* one less packet waiting for me */
id|smc-&gt;packets_waiting
op_decrement
suffix:semicolon
id|outw
c_func
(paren
id|saved_packet
comma
id|ioaddr
op_plus
id|PNR_ARR
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/*====================================================================*/
DECL|function|smc_eph_irq
r_static
r_void
id|smc_eph_irq
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|smc_private
op_star
id|smc
op_assign
id|dev-&gt;priv
suffix:semicolon
id|ioaddr_t
id|ioaddr
op_assign
id|dev-&gt;base_addr
suffix:semicolon
id|u_short
id|card_stats
comma
id|ephs
suffix:semicolon
id|SMC_SELECT_BANK
c_func
(paren
l_int|0
)paren
suffix:semicolon
id|ephs
op_assign
id|inw
c_func
(paren
id|ioaddr
op_plus
id|EPH
)paren
suffix:semicolon
id|DEBUG
c_func
(paren
l_int|2
comma
l_string|&quot;%s: Ethernet protocol handler interrupt, status&quot;
l_string|&quot; %4.4x.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|ephs
)paren
suffix:semicolon
multiline_comment|/* Could be a counter roll-over warning: update stats. */
id|card_stats
op_assign
id|inw
c_func
(paren
id|ioaddr
op_plus
id|COUNTER
)paren
suffix:semicolon
multiline_comment|/* single collisions */
id|smc-&gt;stats.collisions
op_add_assign
id|card_stats
op_amp
l_int|0xF
suffix:semicolon
id|card_stats
op_rshift_assign
l_int|4
suffix:semicolon
multiline_comment|/* multiple collisions */
id|smc-&gt;stats.collisions
op_add_assign
id|card_stats
op_amp
l_int|0xF
suffix:semicolon
macro_line|#if 0 &t;&t;/* These are for when linux supports these statistics */
id|card_stats
op_rshift_assign
l_int|4
suffix:semicolon
multiline_comment|/* deferred */
id|card_stats
op_rshift_assign
l_int|4
suffix:semicolon
multiline_comment|/* excess deferred */
macro_line|#endif
multiline_comment|/* If we had a transmit error we must re-enable the transmitter. */
id|outw
c_func
(paren
id|inw
c_func
(paren
id|ioaddr
op_plus
id|TCR
)paren
op_or
id|TCR_ENABLE
comma
id|ioaddr
op_plus
id|TCR
)paren
suffix:semicolon
multiline_comment|/* Clear a link error interrupt. */
id|SMC_SELECT_BANK
c_func
(paren
l_int|1
)paren
suffix:semicolon
id|outw
c_func
(paren
id|CTL_AUTO_RELEASE
op_or
l_int|0x0000
comma
id|ioaddr
op_plus
id|CONTROL
)paren
suffix:semicolon
id|outw
c_func
(paren
id|CTL_AUTO_RELEASE
op_or
id|CTL_TE_ENABLE
op_or
id|CTL_CR_ENABLE
comma
id|ioaddr
op_plus
id|CONTROL
)paren
suffix:semicolon
id|SMC_SELECT_BANK
c_func
(paren
l_int|2
)paren
suffix:semicolon
)brace
multiline_comment|/*====================================================================*/
DECL|function|smc_interrupt
r_static
r_void
id|smc_interrupt
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_struct
id|smc_private
op_star
id|smc
op_assign
id|dev_id
suffix:semicolon
r_struct
id|net_device
op_star
id|dev
op_assign
op_amp
id|smc-&gt;dev
suffix:semicolon
id|ioaddr_t
id|ioaddr
suffix:semicolon
id|u_short
id|saved_bank
comma
id|saved_pointer
comma
id|mask
comma
id|status
suffix:semicolon
r_char
id|bogus_cnt
op_assign
id|INTR_WORK
suffix:semicolon
multiline_comment|/* Work we are willing to do. */
r_if
c_cond
(paren
op_logical_neg
id|netif_device_present
c_func
(paren
id|dev
)paren
)paren
r_return
suffix:semicolon
id|ioaddr
op_assign
id|dev-&gt;base_addr
suffix:semicolon
id|DEBUG
c_func
(paren
l_int|3
comma
l_string|&quot;%s: SMC91c92 interrupt %d at %#x.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|irq
comma
id|ioaddr
)paren
suffix:semicolon
id|smc-&gt;watchdog
op_assign
l_int|0
suffix:semicolon
id|saved_bank
op_assign
id|inw
c_func
(paren
id|ioaddr
op_plus
id|BANK_SELECT
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|saved_bank
op_amp
l_int|0xff00
)paren
op_ne
l_int|0x3300
)paren
(brace
multiline_comment|/* The device does not exist -- the card could be off-line, or&n;&t;   maybe it has been ejected. */
id|DEBUG
c_func
(paren
l_int|1
comma
l_string|&quot;%s: SMC91c92 interrupt %d for non-existent&quot;
l_string|&quot;/ejected device.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|irq
)paren
suffix:semicolon
r_goto
id|irq_done
suffix:semicolon
)brace
id|SMC_SELECT_BANK
c_func
(paren
l_int|2
)paren
suffix:semicolon
id|saved_pointer
op_assign
id|inw
c_func
(paren
id|ioaddr
op_plus
id|POINTER
)paren
suffix:semicolon
id|mask
op_assign
id|inw
c_func
(paren
id|ioaddr
op_plus
id|INTERRUPT
)paren
op_rshift
l_int|8
suffix:semicolon
multiline_comment|/* clear all interrupts */
id|outw
c_func
(paren
l_int|0
comma
id|ioaddr
op_plus
id|INTERRUPT
)paren
suffix:semicolon
r_do
(brace
multiline_comment|/* read the status flag, and mask it */
id|status
op_assign
id|inw
c_func
(paren
id|ioaddr
op_plus
id|INTERRUPT
)paren
op_amp
l_int|0xff
suffix:semicolon
id|DEBUG
c_func
(paren
l_int|3
comma
l_string|&quot;%s: Status is %#2.2x (mask %#2.2x).&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|status
comma
id|mask
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|status
op_amp
id|mask
)paren
op_eq
l_int|0
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
id|IM_RCV_INT
)paren
(brace
multiline_comment|/* Got a packet(s). */
id|smc_rx
c_func
(paren
id|dev
)paren
suffix:semicolon
id|smc-&gt;last_rx
op_assign
id|jiffies
suffix:semicolon
)brace
r_if
c_cond
(paren
id|status
op_amp
id|IM_TX_INT
)paren
(brace
id|smc_tx_err
c_func
(paren
id|dev
)paren
suffix:semicolon
id|outw
c_func
(paren
id|IM_TX_INT
comma
id|ioaddr
op_plus
id|INTERRUPT
)paren
suffix:semicolon
)brace
id|status
op_and_assign
id|mask
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
id|IM_TX_EMPTY_INT
)paren
(brace
id|outw
c_func
(paren
id|IM_TX_EMPTY_INT
comma
id|ioaddr
op_plus
id|INTERRUPT
)paren
suffix:semicolon
id|mask
op_and_assign
op_complement
id|IM_TX_EMPTY_INT
suffix:semicolon
id|smc-&gt;stats.tx_packets
op_add_assign
id|smc-&gt;packets_waiting
suffix:semicolon
id|smc-&gt;packets_waiting
op_assign
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|status
op_amp
id|IM_ALLOC_INT
)paren
(brace
multiline_comment|/* Clear this interrupt so it doesn&squot;t happen again */
id|mask
op_and_assign
op_complement
id|IM_ALLOC_INT
suffix:semicolon
id|smc_hardware_send_packet
c_func
(paren
id|dev
)paren
suffix:semicolon
multiline_comment|/* enable xmit interrupts based on this */
id|mask
op_or_assign
(paren
id|IM_TX_EMPTY_INT
op_or
id|IM_TX_INT
)paren
suffix:semicolon
multiline_comment|/* and let the card send more packets to me */
id|netif_wake_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|status
op_amp
id|IM_RX_OVRN_INT
)paren
(brace
id|smc-&gt;stats.rx_errors
op_increment
suffix:semicolon
id|smc-&gt;stats.rx_fifo_errors
op_increment
suffix:semicolon
id|outw
c_func
(paren
id|IM_RX_OVRN_INT
comma
id|ioaddr
op_plus
id|INTERRUPT
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|status
op_amp
id|IM_EPH_INT
)paren
id|smc_eph_irq
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
op_decrement
id|bogus_cnt
)paren
suffix:semicolon
id|DEBUG
c_func
(paren
l_int|3
comma
l_string|&quot;  Restoring saved registers mask %2.2x bank %4.4x&quot;
l_string|&quot; pointer %4.4x.&bslash;n&quot;
comma
id|mask
comma
id|saved_bank
comma
id|saved_pointer
)paren
suffix:semicolon
multiline_comment|/* restore state register */
id|outw
c_func
(paren
(paren
id|mask
op_lshift
l_int|8
)paren
comma
id|ioaddr
op_plus
id|INTERRUPT
)paren
suffix:semicolon
id|outw
c_func
(paren
id|saved_pointer
comma
id|ioaddr
op_plus
id|POINTER
)paren
suffix:semicolon
id|SMC_SELECT_BANK
c_func
(paren
id|saved_bank
)paren
suffix:semicolon
id|DEBUG
c_func
(paren
l_int|3
comma
l_string|&quot;%s: Exiting interrupt IRQ%d.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|irq
)paren
suffix:semicolon
id|irq_done
suffix:colon
r_if
c_cond
(paren
(paren
id|smc-&gt;manfid
op_eq
id|MANFID_OSITECH
)paren
op_logical_and
(paren
id|smc-&gt;cardid
op_ne
id|PRODID_OSITECH_SEVEN
)paren
)paren
(brace
multiline_comment|/* Retrigger interrupt if needed */
id|mask_bits
c_func
(paren
l_int|0x00ff
comma
id|ioaddr
op_minus
l_int|0x10
op_plus
id|OSITECH_RESET_ISR
)paren
suffix:semicolon
id|set_bits
c_func
(paren
l_int|0x0300
comma
id|ioaddr
op_minus
l_int|0x10
op_plus
id|OSITECH_RESET_ISR
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|smc-&gt;manfid
op_eq
id|MANFID_MOTOROLA
)paren
(brace
id|u_char
id|cor
suffix:semicolon
id|cor
op_assign
id|readb
c_func
(paren
id|smc-&gt;base
op_plus
id|MOT_UART
op_plus
id|CISREG_COR
)paren
suffix:semicolon
id|writeb
c_func
(paren
id|cor
op_amp
op_complement
id|COR_IREQ_ENA
comma
id|smc-&gt;base
op_plus
id|MOT_UART
op_plus
id|CISREG_COR
)paren
suffix:semicolon
id|writeb
c_func
(paren
id|cor
comma
id|smc-&gt;base
op_plus
id|MOT_UART
op_plus
id|CISREG_COR
)paren
suffix:semicolon
id|cor
op_assign
id|readb
c_func
(paren
id|smc-&gt;base
op_plus
id|MOT_LAN
op_plus
id|CISREG_COR
)paren
suffix:semicolon
id|writeb
c_func
(paren
id|cor
op_amp
op_complement
id|COR_IREQ_ENA
comma
id|smc-&gt;base
op_plus
id|MOT_LAN
op_plus
id|CISREG_COR
)paren
suffix:semicolon
id|writeb
c_func
(paren
id|cor
comma
id|smc-&gt;base
op_plus
id|MOT_LAN
op_plus
id|CISREG_COR
)paren
suffix:semicolon
)brace
macro_line|#ifdef DOES_NOT_WORK
r_if
c_cond
(paren
id|smc-&gt;base
op_ne
l_int|NULL
)paren
(brace
multiline_comment|/* Megahertz MFC&squot;s */
id|readb
c_func
(paren
id|smc-&gt;base
op_plus
id|MEGAHERTZ_ISR
)paren
suffix:semicolon
id|readb
c_func
(paren
id|smc-&gt;base
op_plus
id|MEGAHERTZ_ISR
)paren
suffix:semicolon
)brace
macro_line|#endif
)brace
multiline_comment|/*====================================================================*/
DECL|function|smc_rx
r_static
r_void
id|smc_rx
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|smc_private
op_star
id|smc
op_assign
(paren
r_struct
id|smc_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|ioaddr_t
id|ioaddr
op_assign
id|dev-&gt;base_addr
suffix:semicolon
r_int
id|rx_status
suffix:semicolon
r_int
id|packet_length
suffix:semicolon
multiline_comment|/* Caution: not frame length, rather words&n;&t;&t;&t;   to transfer from the chip. */
multiline_comment|/* Assertion: we are in Window 2. */
r_if
c_cond
(paren
id|inw
c_func
(paren
id|ioaddr
op_plus
id|FIFO_PORTS
)paren
op_amp
id|FP_RXEMPTY
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: smc_rx() with nothing on Rx FIFO.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/*  Reset the read pointer, and read the status and packet length. */
id|outw
c_func
(paren
id|PTR_READ
op_or
id|PTR_RCV
op_or
id|PTR_AUTOINC
comma
id|ioaddr
op_plus
id|POINTER
)paren
suffix:semicolon
id|rx_status
op_assign
id|inw
c_func
(paren
id|ioaddr
op_plus
id|DATA_1
)paren
suffix:semicolon
id|packet_length
op_assign
id|inw
c_func
(paren
id|ioaddr
op_plus
id|DATA_1
)paren
op_amp
l_int|0x07ff
suffix:semicolon
id|DEBUG
c_func
(paren
l_int|2
comma
l_string|&quot;%s: Receive status %4.4x length %d.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|rx_status
comma
id|packet_length
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|rx_status
op_amp
id|RS_ERRORS
)paren
)paren
(brace
multiline_comment|/* do stuff to make a new packet */
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
multiline_comment|/* Note: packet_length adds 5 or 6 extra bytes here! */
id|skb
op_assign
id|dev_alloc_skb
c_func
(paren
id|packet_length
op_plus
l_int|2
)paren
suffix:semicolon
r_if
c_cond
(paren
id|skb
op_eq
l_int|NULL
)paren
(brace
id|DEBUG
c_func
(paren
l_int|1
comma
l_string|&quot;%s: Low memory, packet dropped.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|smc-&gt;stats.rx_dropped
op_increment
suffix:semicolon
id|outw
c_func
(paren
id|MC_RELEASE
comma
id|ioaddr
op_plus
id|MMU_CMD
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|packet_length
op_sub_assign
(paren
id|rx_status
op_amp
id|RS_ODDFRAME
ques
c_cond
l_int|5
suffix:colon
l_int|6
)paren
suffix:semicolon
id|skb_reserve
c_func
(paren
id|skb
comma
l_int|2
)paren
suffix:semicolon
id|insw
c_func
(paren
id|ioaddr
op_plus
id|DATA_1
comma
id|skb_put
c_func
(paren
id|skb
comma
id|packet_length
)paren
comma
(paren
id|packet_length
op_plus
l_int|1
)paren
op_rshift
l_int|1
)paren
suffix:semicolon
id|skb-&gt;protocol
op_assign
id|eth_type_trans
c_func
(paren
id|skb
comma
id|dev
)paren
suffix:semicolon
id|skb-&gt;dev
op_assign
id|dev
suffix:semicolon
id|netif_rx
c_func
(paren
id|skb
)paren
suffix:semicolon
id|smc-&gt;stats.rx_packets
op_increment
suffix:semicolon
id|smc-&gt;stats.rx_bytes
op_add_assign
id|skb-&gt;len
suffix:semicolon
r_if
c_cond
(paren
id|rx_status
op_amp
id|RS_MULTICAST
)paren
id|smc-&gt;stats.multicast
op_increment
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* error ... */
id|smc-&gt;stats.rx_errors
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|rx_status
op_amp
id|RS_ALGNERR
)paren
id|smc-&gt;stats.rx_frame_errors
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|rx_status
op_amp
(paren
id|RS_TOOSHORT
op_or
id|RS_TOOLONG
)paren
)paren
id|smc-&gt;stats.rx_length_errors
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|rx_status
op_amp
id|RS_BADCRC
)paren
id|smc-&gt;stats.rx_crc_errors
op_increment
suffix:semicolon
)brace
multiline_comment|/* Let the MMU free the memory of this packet. */
id|outw
c_func
(paren
id|MC_RELEASE
comma
id|ioaddr
op_plus
id|MMU_CMD
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/*====================================================================*/
DECL|function|smc91c92_get_stats
r_static
r_struct
id|net_device_stats
op_star
id|smc91c92_get_stats
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|smc_private
op_star
id|smc
op_assign
(paren
r_struct
id|smc_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
multiline_comment|/* Nothing to update - the 91c92 is a pretty primative chip. */
r_return
op_amp
id|smc-&gt;stats
suffix:semicolon
)brace
multiline_comment|/*======================================================================&n;&n;    Compute the AUTODIN polynomial &quot;CRC32&quot; for ethernet packets.&n;&n;======================================================================*/
DECL|variable|ethernet_polynomial
r_static
r_const
id|u_int
id|ethernet_polynomial
op_assign
l_int|0x04c11db7U
suffix:semicolon
DECL|function|ether_crc
r_static
id|u_int
id|ether_crc
c_func
(paren
r_int
id|length
comma
id|u_char
op_star
id|data
)paren
(brace
r_int
id|crc
op_assign
l_int|0xffffffff
suffix:semicolon
multiline_comment|/* Initial value. */
r_while
c_loop
(paren
op_decrement
id|length
op_ge
l_int|0
)paren
(brace
id|u_char
id|current_octet
op_assign
op_star
id|data
op_increment
suffix:semicolon
r_int
id|bit
suffix:semicolon
r_for
c_loop
(paren
id|bit
op_assign
l_int|0
suffix:semicolon
id|bit
OL
l_int|8
suffix:semicolon
id|bit
op_increment
comma
id|current_octet
op_rshift_assign
l_int|1
)paren
(brace
id|crc
op_assign
(paren
id|crc
op_lshift
l_int|1
)paren
op_xor
(paren
(paren
id|crc
OL
l_int|0
)paren
op_xor
(paren
id|current_octet
op_amp
l_int|1
)paren
ques
c_cond
id|ethernet_polynomial
suffix:colon
l_int|0
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* The hash index is the either the upper or lower bits of the CRC, so&n;     * we return the entire CRC.&n;     */
r_return
id|crc
suffix:semicolon
)brace
multiline_comment|/*======================================================================&n;  &n;    Calculate values for the hardware multicast filter hash table.&n;    &n;======================================================================*/
DECL|function|fill_multicast_tbl
r_static
r_void
id|fill_multicast_tbl
c_func
(paren
r_int
id|count
comma
r_struct
id|dev_mc_list
op_star
id|addrs
comma
id|u_char
op_star
id|multicast_table
)paren
(brace
r_struct
id|dev_mc_list
op_star
id|mc_addr
suffix:semicolon
r_for
c_loop
(paren
id|mc_addr
op_assign
id|addrs
suffix:semicolon
id|mc_addr
op_logical_and
op_decrement
id|count
OG
l_int|0
suffix:semicolon
id|mc_addr
op_assign
id|mc_addr-&gt;next
)paren
(brace
id|u_int
id|position
op_assign
id|ether_crc
c_func
(paren
l_int|6
comma
id|mc_addr-&gt;dmi_addr
)paren
suffix:semicolon
macro_line|#ifndef final_version&t;&t;/* Verify multicast address. */
r_if
c_cond
(paren
(paren
id|mc_addr-&gt;dmi_addr
(braket
l_int|0
)braket
op_amp
l_int|1
)paren
op_eq
l_int|0
)paren
r_continue
suffix:semicolon
macro_line|#endif
id|multicast_table
(braket
id|position
op_rshift
l_int|29
)braket
op_or_assign
l_int|1
op_lshift
(paren
(paren
id|position
op_rshift
l_int|26
)paren
op_amp
l_int|7
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/*======================================================================&n;  &n;    Set the receive mode.&n;    &n;    This routine is used by both the protocol level to notify us of&n;    promiscuous/multicast mode changes, and by the open/reset code to&n;    initialize the Rx registers.  We always set the multicast list and&n;    leave the receiver running.&n;    &n;======================================================================*/
DECL|function|set_rx_mode
r_static
r_void
id|set_rx_mode
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
id|ioaddr_t
id|ioaddr
op_assign
id|dev-&gt;base_addr
suffix:semicolon
id|u_int
id|multicast_table
(braket
l_int|2
)braket
op_assign
(brace
l_int|0
comma
)brace
suffix:semicolon
r_int
id|flags
suffix:semicolon
id|u_short
id|rx_cfg_setting
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;flags
op_amp
id|IFF_PROMISC
)paren
(brace
id|printk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;%s: setting Rx mode to promiscuous.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|rx_cfg_setting
op_assign
id|RxStripCRC
op_or
id|RxEnable
op_or
id|RxPromisc
op_or
id|RxAllMulti
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|dev-&gt;flags
op_amp
id|IFF_ALLMULTI
)paren
id|rx_cfg_setting
op_assign
id|RxStripCRC
op_or
id|RxEnable
op_or
id|RxAllMulti
suffix:semicolon
r_else
(brace
r_if
c_cond
(paren
id|dev-&gt;mc_count
)paren
(brace
id|fill_multicast_tbl
c_func
(paren
id|dev-&gt;mc_count
comma
id|dev-&gt;mc_list
comma
(paren
id|u_char
op_star
)paren
id|multicast_table
)paren
suffix:semicolon
)brace
id|rx_cfg_setting
op_assign
id|RxStripCRC
op_or
id|RxEnable
suffix:semicolon
)brace
multiline_comment|/* Load MC table and Rx setting into the chip without interrupts. */
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|SMC_SELECT_BANK
c_func
(paren
l_int|3
)paren
suffix:semicolon
id|outl
c_func
(paren
id|multicast_table
(braket
l_int|0
)braket
comma
id|ioaddr
op_plus
id|MULTICAST0
)paren
suffix:semicolon
id|outl
c_func
(paren
id|multicast_table
(braket
l_int|1
)braket
comma
id|ioaddr
op_plus
id|MULTICAST4
)paren
suffix:semicolon
id|SMC_SELECT_BANK
c_func
(paren
l_int|0
)paren
suffix:semicolon
id|outw
c_func
(paren
id|rx_cfg_setting
comma
id|ioaddr
op_plus
id|RCR
)paren
suffix:semicolon
id|SMC_SELECT_BANK
c_func
(paren
l_int|2
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/*======================================================================&n;&n;    Senses when a card&squot;s config changes. Here, it&squot;s coax or TP.&n; &n;======================================================================*/
DECL|function|s9k_config
r_static
r_int
id|s9k_config
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_struct
id|ifmap
op_star
id|map
)paren
(brace
r_struct
id|smc_private
op_star
id|smc
op_assign
id|dev-&gt;priv
suffix:semicolon
r_if
c_cond
(paren
(paren
id|map-&gt;port
op_ne
(paren
id|u_char
)paren
(paren
op_minus
l_int|1
)paren
)paren
op_logical_and
(paren
id|map-&gt;port
op_ne
id|dev-&gt;if_port
)paren
)paren
(brace
r_if
c_cond
(paren
id|smc-&gt;cfg
op_amp
id|CFG_MII_SELECT
)paren
r_return
op_minus
id|EOPNOTSUPP
suffix:semicolon
r_else
r_if
c_cond
(paren
id|map-&gt;port
OG
l_int|2
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|dev-&gt;if_port
op_assign
id|map-&gt;port
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: switched to %s port&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|if_names
(braket
id|dev-&gt;if_port
)braket
)paren
suffix:semicolon
id|smc_reset
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*======================================================================&n;&n;    Reset the chip, reloading every register that might be corrupted.&n;&n;======================================================================*/
multiline_comment|/*&n;  Set transceiver type, perhaps to something other than what the user&n;  specified in dev-&gt;if_port.&n;*/
DECL|function|smc_set_xcvr
r_static
r_void
id|smc_set_xcvr
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_int
id|if_port
)paren
(brace
r_struct
id|smc_private
op_star
id|smc
op_assign
(paren
r_struct
id|smc_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|ioaddr_t
id|ioaddr
op_assign
id|dev-&gt;base_addr
suffix:semicolon
id|u_short
id|saved_bank
suffix:semicolon
id|saved_bank
op_assign
id|inw
c_func
(paren
id|ioaddr
op_plus
id|BANK_SELECT
)paren
suffix:semicolon
id|SMC_SELECT_BANK
c_func
(paren
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|if_port
op_eq
l_int|2
)paren
(brace
id|outw
c_func
(paren
id|smc-&gt;cfg
op_or
id|CFG_AUI_SELECT
comma
id|ioaddr
op_plus
id|CONFIG
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|smc-&gt;manfid
op_eq
id|MANFID_OSITECH
)paren
op_logical_and
(paren
id|smc-&gt;cardid
op_ne
id|PRODID_OSITECH_SEVEN
)paren
)paren
id|set_bits
c_func
(paren
id|OSI_AUI_PWR
comma
id|ioaddr
op_minus
l_int|0x10
op_plus
id|OSITECH_AUI_PWR
)paren
suffix:semicolon
id|smc-&gt;media_status
op_assign
(paren
(paren
id|dev-&gt;if_port
op_eq
l_int|0
)paren
ques
c_cond
l_int|0x0001
suffix:colon
l_int|0x0002
)paren
suffix:semicolon
)brace
r_else
(brace
id|outw
c_func
(paren
id|smc-&gt;cfg
comma
id|ioaddr
op_plus
id|CONFIG
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|smc-&gt;manfid
op_eq
id|MANFID_OSITECH
)paren
op_logical_and
(paren
id|smc-&gt;cardid
op_ne
id|PRODID_OSITECH_SEVEN
)paren
)paren
id|mask_bits
c_func
(paren
op_complement
id|OSI_AUI_PWR
comma
id|ioaddr
op_minus
l_int|0x10
op_plus
id|OSITECH_AUI_PWR
)paren
suffix:semicolon
id|smc-&gt;media_status
op_assign
(paren
(paren
id|dev-&gt;if_port
op_eq
l_int|0
)paren
ques
c_cond
l_int|0x0012
suffix:colon
l_int|0x4001
)paren
suffix:semicolon
)brace
id|SMC_SELECT_BANK
c_func
(paren
id|saved_bank
)paren
suffix:semicolon
)brace
DECL|function|smc_reset
r_static
r_void
id|smc_reset
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
id|ioaddr_t
id|ioaddr
op_assign
id|dev-&gt;base_addr
suffix:semicolon
r_struct
id|smc_private
op_star
id|smc
op_assign
id|dev-&gt;priv
suffix:semicolon
r_int
id|i
suffix:semicolon
id|DEBUG
c_func
(paren
l_int|0
comma
l_string|&quot;%s: smc91c92 reset called.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
multiline_comment|/* The first interaction must be a write to bring the chip out&n;       of sleep mode. */
id|SMC_SELECT_BANK
c_func
(paren
l_int|0
)paren
suffix:semicolon
multiline_comment|/* Reset the chip. */
id|outw
c_func
(paren
id|RCR_SOFTRESET
comma
id|ioaddr
op_plus
id|RCR
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|10
)paren
suffix:semicolon
multiline_comment|/* Clear the transmit and receive configuration registers. */
id|outw
c_func
(paren
id|RCR_CLEAR
comma
id|ioaddr
op_plus
id|RCR
)paren
suffix:semicolon
id|outw
c_func
(paren
id|TCR_CLEAR
comma
id|ioaddr
op_plus
id|TCR
)paren
suffix:semicolon
multiline_comment|/* Set the Window 1 control, configuration and station addr registers.&n;       No point in writing the I/O base register ;-&gt; */
id|SMC_SELECT_BANK
c_func
(paren
l_int|1
)paren
suffix:semicolon
multiline_comment|/* Automatically release succesfully transmitted packets,&n;       Accept link errors, counter and Tx error interrupts. */
id|outw
c_func
(paren
id|CTL_AUTO_RELEASE
op_or
id|CTL_TE_ENABLE
op_or
id|CTL_CR_ENABLE
comma
id|ioaddr
op_plus
id|CONTROL
)paren
suffix:semicolon
id|smc_set_xcvr
c_func
(paren
id|dev
comma
id|dev-&gt;if_port
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|smc-&gt;manfid
op_eq
id|MANFID_OSITECH
)paren
op_logical_and
(paren
id|smc-&gt;cardid
op_ne
id|PRODID_OSITECH_SEVEN
)paren
)paren
id|outw
c_func
(paren
(paren
id|dev-&gt;if_port
op_eq
l_int|2
ques
c_cond
id|OSI_AUI_PWR
suffix:colon
l_int|0
)paren
op_or
(paren
id|inw
c_func
(paren
id|ioaddr
op_minus
l_int|0x10
op_plus
id|OSITECH_AUI_PWR
)paren
op_amp
l_int|0xff00
)paren
comma
id|ioaddr
op_minus
l_int|0x10
op_plus
id|OSITECH_AUI_PWR
)paren
suffix:semicolon
multiline_comment|/* Fill in the physical address.  The databook is wrong about the order! */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|6
suffix:semicolon
id|i
op_add_assign
l_int|2
)paren
id|outw
c_func
(paren
(paren
id|dev-&gt;dev_addr
(braket
id|i
op_plus
l_int|1
)braket
op_lshift
l_int|8
)paren
op_plus
id|dev-&gt;dev_addr
(braket
id|i
)braket
comma
id|ioaddr
op_plus
id|ADDR0
op_plus
id|i
)paren
suffix:semicolon
multiline_comment|/* Reset the MMU */
id|SMC_SELECT_BANK
c_func
(paren
l_int|2
)paren
suffix:semicolon
id|outw
c_func
(paren
id|MC_RESET
comma
id|ioaddr
op_plus
id|MMU_CMD
)paren
suffix:semicolon
id|outw
c_func
(paren
l_int|0
comma
id|ioaddr
op_plus
id|INTERRUPT
)paren
suffix:semicolon
multiline_comment|/* Re-enable the chip. */
id|SMC_SELECT_BANK
c_func
(paren
l_int|0
)paren
suffix:semicolon
id|outw
c_func
(paren
(paren
(paren
id|smc-&gt;cfg
op_amp
id|CFG_MII_SELECT
)paren
ques
c_cond
l_int|0
suffix:colon
id|TCR_MONCSN
)paren
op_or
id|TCR_ENABLE
op_or
id|TCR_PAD_EN
comma
id|ioaddr
op_plus
id|TCR
)paren
suffix:semicolon
id|set_rx_mode
c_func
(paren
id|dev
)paren
suffix:semicolon
multiline_comment|/* Enable interrupts. */
id|SMC_SELECT_BANK
c_func
(paren
l_int|2
)paren
suffix:semicolon
id|outw
c_func
(paren
(paren
id|IM_EPH_INT
op_or
id|IM_RX_OVRN_INT
op_or
id|IM_RCV_INT
)paren
op_lshift
l_int|8
comma
id|ioaddr
op_plus
id|INTERRUPT
)paren
suffix:semicolon
)brace
multiline_comment|/*======================================================================&n;&n;    Media selection timer routine&n;    &n;======================================================================*/
DECL|function|media_check
r_static
r_void
id|media_check
c_func
(paren
id|u_long
id|arg
)paren
(brace
r_struct
id|smc_private
op_star
id|smc
op_assign
(paren
r_struct
id|smc_private
op_star
)paren
(paren
id|arg
)paren
suffix:semicolon
r_struct
id|net_device
op_star
id|dev
op_assign
op_amp
id|smc-&gt;dev
suffix:semicolon
id|ioaddr_t
id|ioaddr
op_assign
id|dev-&gt;base_addr
suffix:semicolon
id|u_short
id|i
comma
id|media
comma
id|saved_bank
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|netif_device_present
c_func
(paren
id|dev
)paren
)paren
r_goto
id|reschedule
suffix:semicolon
id|saved_bank
op_assign
id|inw
c_func
(paren
id|ioaddr
op_plus
id|BANK_SELECT
)paren
suffix:semicolon
id|SMC_SELECT_BANK
c_func
(paren
l_int|2
)paren
suffix:semicolon
id|i
op_assign
id|inw
c_func
(paren
id|ioaddr
op_plus
id|INTERRUPT
)paren
suffix:semicolon
id|SMC_SELECT_BANK
c_func
(paren
l_int|0
)paren
suffix:semicolon
id|media
op_assign
id|inw
c_func
(paren
id|ioaddr
op_plus
id|EPH
)paren
op_amp
id|EPH_LINK_OK
suffix:semicolon
id|SMC_SELECT_BANK
c_func
(paren
l_int|1
)paren
suffix:semicolon
id|media
op_or_assign
(paren
id|inw
c_func
(paren
id|ioaddr
op_plus
id|CONFIG
)paren
op_amp
id|CFG_AUI_SELECT
)paren
ques
c_cond
l_int|2
suffix:colon
l_int|1
suffix:semicolon
id|SMC_SELECT_BANK
c_func
(paren
id|saved_bank
)paren
suffix:semicolon
multiline_comment|/* Check for pending interrupt with watchdog flag set: with&n;       this, we can limp along even if the interrupt is blocked */
r_if
c_cond
(paren
id|smc-&gt;watchdog
op_increment
op_logical_and
(paren
(paren
id|i
op_rshift
l_int|8
)paren
op_amp
id|i
)paren
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|smc-&gt;fast_poll
)paren
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: interrupt(s) dropped!&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|smc_interrupt
c_func
(paren
id|dev-&gt;irq
comma
id|smc
comma
l_int|NULL
)paren
suffix:semicolon
id|smc-&gt;fast_poll
op_assign
id|HZ
suffix:semicolon
)brace
r_if
c_cond
(paren
id|smc-&gt;fast_poll
)paren
(brace
id|smc-&gt;fast_poll
op_decrement
suffix:semicolon
id|smc-&gt;media.expires
op_assign
id|jiffies
op_plus
l_int|1
suffix:semicolon
id|add_timer
c_func
(paren
op_amp
id|smc-&gt;media
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|smc-&gt;cfg
op_amp
id|CFG_MII_SELECT
)paren
r_goto
id|reschedule
suffix:semicolon
multiline_comment|/* Ignore collisions unless we&squot;ve had no rx&squot;s recently */
r_if
c_cond
(paren
id|jiffies
op_minus
id|smc-&gt;last_rx
OG
id|HZ
)paren
(brace
r_if
c_cond
(paren
id|smc-&gt;tx_err
op_logical_or
(paren
id|smc-&gt;media_status
op_amp
id|EPH_16COL
)paren
)paren
id|media
op_or_assign
id|EPH_16COL
suffix:semicolon
)brace
id|smc-&gt;tx_err
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|media
op_ne
id|smc-&gt;media_status
)paren
(brace
r_if
c_cond
(paren
(paren
id|media
op_amp
id|smc-&gt;media_status
op_amp
l_int|1
)paren
op_logical_and
(paren
(paren
id|smc-&gt;media_status
op_xor
id|media
)paren
op_amp
id|EPH_LINK_OK
)paren
)paren
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: %s link beat&bslash;n&quot;
comma
id|dev-&gt;name
comma
(paren
id|smc-&gt;media_status
op_amp
id|EPH_LINK_OK
ques
c_cond
l_string|&quot;lost&quot;
suffix:colon
l_string|&quot;found&quot;
)paren
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
(paren
id|media
op_amp
id|smc-&gt;media_status
op_amp
l_int|2
)paren
op_logical_and
(paren
(paren
id|smc-&gt;media_status
op_xor
id|media
)paren
op_amp
id|EPH_16COL
)paren
)paren
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: coax cable %s&bslash;n&quot;
comma
id|dev-&gt;name
comma
(paren
id|media
op_amp
id|EPH_16COL
ques
c_cond
l_string|&quot;problem&quot;
suffix:colon
l_string|&quot;ok&quot;
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;if_port
op_eq
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|media
op_amp
l_int|1
)paren
(brace
r_if
c_cond
(paren
id|media
op_amp
id|EPH_LINK_OK
)paren
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: flipped to 10baseT&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_else
id|smc_set_xcvr
c_func
(paren
id|dev
comma
l_int|2
)paren
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|media
op_amp
id|EPH_16COL
)paren
id|smc_set_xcvr
c_func
(paren
id|dev
comma
l_int|1
)paren
suffix:semicolon
r_else
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: flipped to 10base2&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
)brace
)brace
id|smc-&gt;media_status
op_assign
id|media
suffix:semicolon
)brace
id|reschedule
suffix:colon
id|smc-&gt;media.expires
op_assign
id|jiffies
op_plus
id|HZ
suffix:semicolon
id|add_timer
c_func
(paren
op_amp
id|smc-&gt;media
)paren
suffix:semicolon
)brace
multiline_comment|/*====================================================================*/
DECL|function|init_smc91c92_cs
r_static
r_int
id|__init
id|init_smc91c92_cs
c_func
(paren
r_void
)paren
(brace
id|servinfo_t
id|serv
suffix:semicolon
id|DEBUG
c_func
(paren
l_int|0
comma
l_string|&quot;%s&bslash;n&quot;
comma
id|version
)paren
suffix:semicolon
id|CardServices
c_func
(paren
id|GetCardServicesInfo
comma
op_amp
id|serv
)paren
suffix:semicolon
r_if
c_cond
(paren
id|serv.Revision
op_ne
id|CS_RELEASE_CODE
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;smc91c92_cs: Card Services release does not match!&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|register_pccard_driver
c_func
(paren
op_amp
id|dev_info
comma
op_amp
id|smc91c92_attach
comma
op_amp
id|smc91c92_detach
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|exit_smc91c92_cs
r_static
r_void
id|__exit
id|exit_smc91c92_cs
c_func
(paren
r_void
)paren
(brace
id|DEBUG
c_func
(paren
l_int|0
comma
l_string|&quot;smc91c92_cs: unloading&bslash;n&quot;
)paren
suffix:semicolon
id|unregister_pccard_driver
c_func
(paren
op_amp
id|dev_info
)paren
suffix:semicolon
r_while
c_loop
(paren
id|dev_list
op_ne
l_int|NULL
)paren
id|smc91c92_detach
c_func
(paren
id|dev_list
)paren
suffix:semicolon
)brace
DECL|variable|init_smc91c92_cs
id|module_init
c_func
(paren
id|init_smc91c92_cs
)paren
suffix:semicolon
DECL|variable|exit_smc91c92_cs
id|module_exit
c_func
(paren
id|exit_smc91c92_cs
)paren
suffix:semicolon
eof
