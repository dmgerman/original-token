multiline_comment|/*======================================================================&n;    fmvj18x_cs.c,v 2.0 2000/10/01  03:13:53 root Exp&n;&n;    A fmvj18x (and its compatibles) PCMCIA client driver&n;&n;    Contributed by Shingo Fujimoto, shingo@flab.fujitsu.co.jp&n;&n;    TDK LAK-CD021 and CONTEC C-NET(PC)C support added by &n;    Nobuhiro Katayama, kata-n@po.iijnet.or.jp&n;&n;    The PCMCIA client code is based on code written by David Hinds.&n;    Network code is based on the &quot;FMV-18x driver&quot; by Yutaka TAMIYA&n;    but is actually largely Donald Becker&squot;s AT1700 driver, which&n;    carries the following attribution:&n;&n;    Written 1993-94 by Donald Becker.&n;&n;    Copyright 1993 United States Government as represented by the&n;    Director, National Security Agency.&n;    &n;    This software may be used and distributed according to the terms&n;    of the GNU Public License, incorporated herein by reference.&n;    &n;    The author may be reached as becker@CESDIS.gsfc.nasa.gov, or C/O&n;    Center of Excellence in Space Data and Information Sciences&n;    Code 930.5, Goddard Space Flight Center, Greenbelt MD 20771&n;    &n;======================================================================*/
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/ptrace.h&gt;
macro_line|#include &lt;linux/malloc.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/timer.h&gt;
macro_line|#include &lt;linux/interrupt.h&gt;
macro_line|#include &lt;linux/in.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/system.h&gt;
macro_line|#include &lt;linux/netdevice.h&gt;
macro_line|#include &lt;linux/etherdevice.h&gt;
macro_line|#include &lt;linux/skbuff.h&gt;
macro_line|#include &lt;linux/if_arp.h&gt;
macro_line|#include &lt;linux/ioport.h&gt;
macro_line|#include &lt;pcmcia/version.h&gt;
macro_line|#include &lt;pcmcia/cs_types.h&gt;
macro_line|#include &lt;pcmcia/cs.h&gt;
macro_line|#include &lt;pcmcia/cistpl.h&gt;
macro_line|#include &lt;pcmcia/ciscode.h&gt;
macro_line|#include &lt;pcmcia/ds.h&gt;
multiline_comment|/*&n;   All the PCMCIA modules use PCMCIA_DEBUG to control debugging.  If&n;   you do not define PCMCIA_DEBUG at all, all the debug code will be&n;   left out.  If you compile with PCMCIA_DEBUG=0, the debug code will&n;   be present but disabled -- but it can then be enabled for specific&n;   modules at load time with a &squot;pc_debug=#&squot; option to insmod.&n;*/
macro_line|#ifdef PCMCIA_DEBUG
DECL|variable|pc_debug
r_static
r_int
id|pc_debug
op_assign
id|PCMCIA_DEBUG
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|pc_debug
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
DECL|macro|DEBUG
mdefine_line|#define DEBUG(n, args...) if (pc_debug&gt;(n)) printk(KERN_DEBUG args)
macro_line|#else
DECL|macro|DEBUG
mdefine_line|#define DEBUG(n, args...)
macro_line|#endif
multiline_comment|/* Bit map of interrupts to choose from */
multiline_comment|/* This means pick from 15, 14, 12, 11, 10, 9, 7, 5, 4, and 3 */
DECL|variable|irq_mask
r_static
id|u_int
id|irq_mask
op_assign
l_int|0xdeb8
suffix:semicolon
DECL|variable|irq_list
r_static
r_int
id|irq_list
(braket
l_int|4
)braket
op_assign
(brace
op_minus
l_int|1
)brace
suffix:semicolon
multiline_comment|/* SRAM configuration */
multiline_comment|/* 0:4KB*2 TX buffer   else:8KB*2 TX buffer */
DECL|variable|sram_config
r_static
r_int
id|sram_config
op_assign
l_int|0
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|irq_mask
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|irq_list
comma
l_string|&quot;1-4i&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|sram_config
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
multiline_comment|/*====================================================================*/
multiline_comment|/* &n;   driver version infomation &n; */
macro_line|#ifdef PCMCIA_DEBUG
DECL|variable|version
r_static
r_char
op_star
id|version
op_assign
l_string|&quot;fmvj18x_cs.c,v 2.0 2000/10/01 03:13:53 root Exp&quot;
suffix:semicolon
macro_line|#endif
multiline_comment|/*====================================================================*/
multiline_comment|/*&n;    PCMCIA event handlers&n; */
r_static
r_void
id|fmvj18x_config
c_func
(paren
id|dev_link_t
op_star
id|link
)paren
suffix:semicolon
r_static
r_void
id|fmvj18x_release
c_func
(paren
id|u_long
id|arg
)paren
suffix:semicolon
r_static
r_int
id|fmvj18x_event
c_func
(paren
id|event_t
id|event
comma
r_int
id|priority
comma
id|event_callback_args_t
op_star
id|args
)paren
suffix:semicolon
r_static
id|dev_link_t
op_star
id|fmvj18x_attach
c_func
(paren
r_void
)paren
suffix:semicolon
r_static
r_void
id|fmvj18x_detach
c_func
(paren
id|dev_link_t
op_star
)paren
suffix:semicolon
multiline_comment|/*&n;    LAN controler(MBH86960A) specific routines&n; */
r_static
r_int
id|fjn_config
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_struct
id|ifmap
op_star
id|map
)paren
suffix:semicolon
r_static
r_int
id|fjn_open
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_int
id|fjn_close
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_int
id|fjn_start_xmit
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_void
id|fjn_interrupt
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
suffix:semicolon
r_static
r_void
id|fjn_rx
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_void
id|fjn_reset
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_struct
id|net_device_stats
op_star
id|fjn_get_stats
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_void
id|set_rx_mode
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_void
id|fjn_tx_timeout
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
DECL|variable|dev_info
r_static
id|dev_info_t
id|dev_info
op_assign
l_string|&quot;fmvj18x_cs&quot;
suffix:semicolon
DECL|variable|dev_list
r_static
id|dev_link_t
op_star
id|dev_list
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/*&n;    card type&n; */
DECL|enumerator|MBH10302
DECL|enumerator|MBH10304
DECL|enumerator|TDK
DECL|enumerator|CONTEC
DECL|enumerator|LA501
DECL|enumerator|UNGERMANN
DECL|typedef|cardtype_t
r_typedef
r_enum
(brace
id|MBH10302
comma
id|MBH10304
comma
id|TDK
comma
id|CONTEC
comma
id|LA501
comma
id|UNGERMANN
)brace
id|cardtype_t
suffix:semicolon
DECL|macro|MANFID_UNGERMANN
mdefine_line|#define MANFID_UNGERMANN 0x02c0
multiline_comment|/*&n;    driver specific data structure&n;*/
DECL|struct|local_info_t
r_typedef
r_struct
id|local_info_t
(brace
DECL|member|link
id|dev_link_t
id|link
suffix:semicolon
DECL|member|dev
r_struct
id|net_device
id|dev
suffix:semicolon
DECL|member|node
id|dev_node_t
id|node
suffix:semicolon
DECL|member|stats
r_struct
id|net_device_stats
id|stats
suffix:semicolon
DECL|member|open_time
r_int
id|open_time
suffix:semicolon
DECL|member|tx_started
id|uint
id|tx_started
suffix:colon
l_int|1
suffix:semicolon
DECL|member|tx_queue
id|uint
id|tx_queue
suffix:semicolon
DECL|member|tx_queue_len
id|u_short
id|tx_queue_len
suffix:semicolon
DECL|member|cardtype
id|cardtype_t
id|cardtype
suffix:semicolon
DECL|member|sent
id|u_short
id|sent
suffix:semicolon
DECL|member|mc_filter
id|u_char
id|mc_filter
(braket
l_int|8
)braket
suffix:semicolon
DECL|typedef|local_info_t
)brace
id|local_info_t
suffix:semicolon
DECL|macro|MC_FILTERBREAK
mdefine_line|#define MC_FILTERBREAK 64
multiline_comment|/*====================================================================*/
multiline_comment|/* &n;    ioport offset from the base address &n; */
DECL|macro|TX_STATUS
mdefine_line|#define TX_STATUS               0 /* transmit status register */
DECL|macro|RX_STATUS
mdefine_line|#define RX_STATUS               1 /* receive status register */
DECL|macro|TX_INTR
mdefine_line|#define TX_INTR                 2 /* transmit interrupt mask register */
DECL|macro|RX_INTR
mdefine_line|#define RX_INTR                 3 /* receive interrupt mask register */
DECL|macro|TX_MODE
mdefine_line|#define TX_MODE                 4 /* transmit mode register */
DECL|macro|RX_MODE
mdefine_line|#define RX_MODE                 5 /* receive mode register */
DECL|macro|CONFIG_0
mdefine_line|#define CONFIG_0                6 /* configuration register 0 */
DECL|macro|CONFIG_1
mdefine_line|#define CONFIG_1                7 /* configuration register 1 */
DECL|macro|NODE_ID
mdefine_line|#define NODE_ID                 8 /* node ID register            (bank 0) */
DECL|macro|MAR_ADR
mdefine_line|#define MAR_ADR                 8 /* multicast address registers (bank 1) */
DECL|macro|DATAPORT
mdefine_line|#define DATAPORT                8 /* buffer mem port registers   (bank 2) */
DECL|macro|TX_START
mdefine_line|#define TX_START               10 /* transmit start register */
DECL|macro|COL_CTRL
mdefine_line|#define COL_CTRL               11 /* 16 collision control register */
DECL|macro|BMPR12
mdefine_line|#define BMPR12                 12 /* reserved */
DECL|macro|BMPR13
mdefine_line|#define BMPR13                 13 /* reserved */
DECL|macro|RX_SKIP
mdefine_line|#define RX_SKIP                14 /* skip received packet register */
DECL|macro|LAN_CTRL
mdefine_line|#define LAN_CTRL               16 /* LAN card control register */
DECL|macro|MAC_ID
mdefine_line|#define MAC_ID               0x1a /* hardware address */
DECL|macro|UNGERMANN_MAC_ID
mdefine_line|#define UNGERMANN_MAC_ID     0x18 /* UNGERMANN-BASS hardware address */
multiline_comment|/* &n;    control bits &n; */
DECL|macro|ENA_TMT_OK
mdefine_line|#define ENA_TMT_OK           0x80
DECL|macro|ENA_TMT_REC
mdefine_line|#define ENA_TMT_REC          0x20
DECL|macro|ENA_COL
mdefine_line|#define ENA_COL              0x04
DECL|macro|ENA_16_COL
mdefine_line|#define ENA_16_COL           0x02
DECL|macro|ENA_TBUS_ERR
mdefine_line|#define ENA_TBUS_ERR         0x01
DECL|macro|ENA_PKT_RDY
mdefine_line|#define ENA_PKT_RDY          0x80
DECL|macro|ENA_BUS_ERR
mdefine_line|#define ENA_BUS_ERR          0x40
DECL|macro|ENA_LEN_ERR
mdefine_line|#define ENA_LEN_ERR          0x08
DECL|macro|ENA_ALG_ERR
mdefine_line|#define ENA_ALG_ERR          0x04
DECL|macro|ENA_CRC_ERR
mdefine_line|#define ENA_CRC_ERR          0x02
DECL|macro|ENA_OVR_FLO
mdefine_line|#define ENA_OVR_FLO          0x01
multiline_comment|/* flags */
DECL|macro|F_TMT_RDY
mdefine_line|#define F_TMT_RDY            0x80 /* can accept new packet */
DECL|macro|F_NET_BSY
mdefine_line|#define F_NET_BSY            0x40 /* carrier is detected */
DECL|macro|F_TMT_OK
mdefine_line|#define F_TMT_OK             0x20 /* send packet successfully */
DECL|macro|F_SRT_PKT
mdefine_line|#define F_SRT_PKT            0x10 /* short packet error */
DECL|macro|F_COL_ERR
mdefine_line|#define F_COL_ERR            0x04 /* collision error */
DECL|macro|F_16_COL
mdefine_line|#define F_16_COL             0x02 /* 16 collision error */
DECL|macro|F_TBUS_ERR
mdefine_line|#define F_TBUS_ERR           0x01 /* bus read error */
DECL|macro|F_PKT_RDY
mdefine_line|#define F_PKT_RDY            0x80 /* packet(s) in buffer */
DECL|macro|F_BUS_ERR
mdefine_line|#define F_BUS_ERR            0x40 /* bus read error */
DECL|macro|F_LEN_ERR
mdefine_line|#define F_LEN_ERR            0x08 /* short packet */
DECL|macro|F_ALG_ERR
mdefine_line|#define F_ALG_ERR            0x04 /* frame error */
DECL|macro|F_CRC_ERR
mdefine_line|#define F_CRC_ERR            0x02 /* CRC error */
DECL|macro|F_OVR_FLO
mdefine_line|#define F_OVR_FLO            0x01 /* overflow error */
DECL|macro|F_BUF_EMP
mdefine_line|#define F_BUF_EMP            0x40 /* receive buffer is empty */
DECL|macro|F_SKP_PKT
mdefine_line|#define F_SKP_PKT            0x05 /* drop packet in buffer */
multiline_comment|/* default bitmaps */
DECL|macro|D_TX_INTR
mdefine_line|#define D_TX_INTR  ( ENA_TMT_OK )
DECL|macro|D_RX_INTR
mdefine_line|#define D_RX_INTR  ( ENA_PKT_RDY | ENA_LEN_ERR &bslash;&n;&t;&t;   | ENA_ALG_ERR | ENA_CRC_ERR | ENA_OVR_FLO )
DECL|macro|TX_STAT_M
mdefine_line|#define TX_STAT_M  ( F_TMT_RDY )
DECL|macro|RX_STAT_M
mdefine_line|#define RX_STAT_M  ( F_PKT_RDY | F_LEN_ERR &bslash;&n;                   | F_ALG_ERR | F_CRC_ERR | F_OVR_FLO )
multiline_comment|/* commands */
DECL|macro|D_TX_MODE
mdefine_line|#define D_TX_MODE            0x06 /* no tests, detect carrier */
DECL|macro|ID_MATCHED
mdefine_line|#define ID_MATCHED           0x02 /* (RX_MODE) */
DECL|macro|RECV_ALL
mdefine_line|#define RECV_ALL             0x03 /* (RX_MODE) */
DECL|macro|CONFIG0_DFL
mdefine_line|#define CONFIG0_DFL          0x5a /* 16bit bus, 4K x 2 Tx queues */
DECL|macro|CONFIG0_DFL_1
mdefine_line|#define CONFIG0_DFL_1        0x5e /* 16bit bus, 8K x 2 Tx queues */
DECL|macro|CONFIG0_RST
mdefine_line|#define CONFIG0_RST          0xda /* Data Link Controler off (CONFIG_0) */
DECL|macro|CONFIG0_RST_1
mdefine_line|#define CONFIG0_RST_1        0xde /* Data Link Controler off (CONFIG_0) */
DECL|macro|BANK_0
mdefine_line|#define BANK_0               0xa0 /* bank 0 (CONFIG_1) */
DECL|macro|BANK_1
mdefine_line|#define BANK_1               0xa4 /* bank 1 (CONFIG_1) */
DECL|macro|BANK_2
mdefine_line|#define BANK_2               0xa8 /* bank 2 (CONFIG_1) */
DECL|macro|CHIP_OFF
mdefine_line|#define CHIP_OFF             0x80 /* contrl chip power off (CONFIG_1) */
DECL|macro|DO_TX
mdefine_line|#define DO_TX                0x80 /* do transmit packet */
DECL|macro|SEND_PKT
mdefine_line|#define SEND_PKT             0x81 /* send a packet */
DECL|macro|AUTO_MODE
mdefine_line|#define AUTO_MODE            0x07 /* Auto skip packet on 16 col detected */
DECL|macro|MANU_MODE
mdefine_line|#define MANU_MODE            0x03 /* Stop and skip packet on 16 col */
DECL|macro|TDK_AUTO_MODE
mdefine_line|#define TDK_AUTO_MODE        0x47 /* Auto skip packet on 16 col detected */
DECL|macro|TDK_MANU_MODE
mdefine_line|#define TDK_MANU_MODE        0x43 /* Stop and skip packet on 16 col */
DECL|macro|INTR_OFF
mdefine_line|#define INTR_OFF             0x0d /* LAN controler ignores interrupts */
DECL|macro|INTR_ON
mdefine_line|#define INTR_ON              0x1d /* LAN controler will catch interrupts */
DECL|macro|TX_TIMEOUT
mdefine_line|#define TX_TIMEOUT&t;&t;((400*HZ)/1000)
DECL|macro|BANK_0U
mdefine_line|#define BANK_0U              0x20 /* bank 0 (CONFIG_1) */
DECL|macro|BANK_1U
mdefine_line|#define BANK_1U              0x24 /* bank 1 (CONFIG_1) */
DECL|macro|BANK_2U
mdefine_line|#define BANK_2U              0x28 /* bank 2 (CONFIG_1) */
multiline_comment|/*======================================================================&n;&n;    This bit of code is used to avoid unregistering network devices&n;    at inappropriate times.  2.2 and later kernels are fairly picky&n;    about when this can happen.&n;    &n;======================================================================*/
DECL|function|flush_stale_links
r_static
r_void
id|flush_stale_links
c_func
(paren
r_void
)paren
(brace
id|dev_link_t
op_star
id|link
comma
op_star
id|next
suffix:semicolon
r_for
c_loop
(paren
id|link
op_assign
id|dev_list
suffix:semicolon
id|link
suffix:semicolon
id|link
op_assign
id|next
)paren
(brace
id|next
op_assign
id|link-&gt;next
suffix:semicolon
r_if
c_cond
(paren
id|link-&gt;state
op_amp
id|DEV_STALE_LINK
)paren
id|fmvj18x_detach
c_func
(paren
id|link
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/*====================================================================*/
DECL|function|cs_error
r_static
r_void
id|cs_error
c_func
(paren
id|client_handle_t
id|handle
comma
r_int
id|func
comma
r_int
id|ret
)paren
(brace
id|error_info_t
id|err
op_assign
(brace
id|func
comma
id|ret
)brace
suffix:semicolon
id|CardServices
c_func
(paren
id|ReportError
comma
id|handle
comma
op_amp
id|err
)paren
suffix:semicolon
)brace
multiline_comment|/*====================================================================*/
DECL|function|fmvj18x_attach
r_static
id|dev_link_t
op_star
id|fmvj18x_attach
c_func
(paren
r_void
)paren
(brace
id|local_info_t
op_star
id|lp
suffix:semicolon
id|dev_link_t
op_star
id|link
suffix:semicolon
r_struct
id|net_device
op_star
id|dev
suffix:semicolon
id|client_reg_t
id|client_reg
suffix:semicolon
r_int
id|i
comma
id|ret
suffix:semicolon
id|DEBUG
c_func
(paren
l_int|0
comma
l_string|&quot;fmvj18x_attach()&bslash;n&quot;
)paren
suffix:semicolon
id|flush_stale_links
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* Make up a FMVJ18x specific data structure */
id|lp
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
op_star
id|lp
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|lp
)paren
r_return
l_int|NULL
suffix:semicolon
id|memset
c_func
(paren
id|lp
comma
l_int|0
comma
r_sizeof
(paren
op_star
id|lp
)paren
)paren
suffix:semicolon
id|link
op_assign
op_amp
id|lp-&gt;link
suffix:semicolon
id|dev
op_assign
op_amp
id|lp-&gt;dev
suffix:semicolon
id|link-&gt;priv
op_assign
id|dev-&gt;priv
op_assign
id|link-&gt;irq.Instance
op_assign
id|lp
suffix:semicolon
id|link-&gt;release.function
op_assign
op_amp
id|fmvj18x_release
suffix:semicolon
id|link-&gt;release.data
op_assign
(paren
id|u_long
)paren
id|link
suffix:semicolon
multiline_comment|/* The io structure describes IO port mapping */
id|link-&gt;io.NumPorts1
op_assign
l_int|32
suffix:semicolon
id|link-&gt;io.Attributes1
op_assign
id|IO_DATA_PATH_WIDTH_AUTO
suffix:semicolon
id|link-&gt;io.IOAddrLines
op_assign
l_int|5
suffix:semicolon
multiline_comment|/* Interrupt setup */
id|link-&gt;irq.Attributes
op_assign
id|IRQ_TYPE_EXCLUSIVE
op_or
id|IRQ_HANDLE_PRESENT
suffix:semicolon
id|link-&gt;irq.IRQInfo1
op_assign
id|IRQ_INFO2_VALID
op_or
id|IRQ_LEVEL_ID
suffix:semicolon
r_if
c_cond
(paren
id|irq_list
(braket
l_int|0
)braket
op_eq
op_minus
l_int|1
)paren
id|link-&gt;irq.IRQInfo2
op_assign
id|irq_mask
suffix:semicolon
r_else
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|4
suffix:semicolon
id|i
op_increment
)paren
id|link-&gt;irq.IRQInfo2
op_or_assign
l_int|1
op_lshift
id|irq_list
(braket
id|i
)braket
suffix:semicolon
id|link-&gt;irq.Handler
op_assign
op_amp
id|fjn_interrupt
suffix:semicolon
multiline_comment|/* General socket configuration */
id|link-&gt;conf.Attributes
op_assign
id|CONF_ENABLE_IRQ
suffix:semicolon
id|link-&gt;conf.Vcc
op_assign
l_int|50
suffix:semicolon
id|link-&gt;conf.IntType
op_assign
id|INT_MEMORY_AND_IO
suffix:semicolon
multiline_comment|/* The FMVJ18x specific entries in the device structure. */
id|dev-&gt;hard_start_xmit
op_assign
op_amp
id|fjn_start_xmit
suffix:semicolon
id|dev-&gt;set_config
op_assign
op_amp
id|fjn_config
suffix:semicolon
id|dev-&gt;get_stats
op_assign
op_amp
id|fjn_get_stats
suffix:semicolon
id|dev-&gt;set_multicast_list
op_assign
op_amp
id|set_rx_mode
suffix:semicolon
id|ether_setup
c_func
(paren
id|dev
)paren
suffix:semicolon
id|dev-&gt;open
op_assign
op_amp
id|fjn_open
suffix:semicolon
id|dev-&gt;stop
op_assign
op_amp
id|fjn_close
suffix:semicolon
id|dev-&gt;tx_timeout
op_assign
id|fjn_tx_timeout
suffix:semicolon
id|dev-&gt;watchdog_timeo
op_assign
id|TX_TIMEOUT
suffix:semicolon
multiline_comment|/* Register with Card Services */
id|link-&gt;next
op_assign
id|dev_list
suffix:semicolon
id|dev_list
op_assign
id|link
suffix:semicolon
id|client_reg.dev_info
op_assign
op_amp
id|dev_info
suffix:semicolon
id|client_reg.Attributes
op_assign
id|INFO_IO_CLIENT
op_or
id|INFO_CARD_SHARE
suffix:semicolon
id|client_reg.EventMask
op_assign
id|CS_EVENT_CARD_INSERTION
op_or
id|CS_EVENT_CARD_REMOVAL
op_or
id|CS_EVENT_RESET_PHYSICAL
op_or
id|CS_EVENT_CARD_RESET
op_or
id|CS_EVENT_PM_SUSPEND
op_or
id|CS_EVENT_PM_RESUME
suffix:semicolon
id|client_reg.event_handler
op_assign
op_amp
id|fmvj18x_event
suffix:semicolon
id|client_reg.Version
op_assign
l_int|0x0210
suffix:semicolon
id|client_reg.event_callback_args.client_data
op_assign
id|link
suffix:semicolon
id|ret
op_assign
id|CardServices
c_func
(paren
id|RegisterClient
comma
op_amp
id|link-&gt;handle
comma
op_amp
id|client_reg
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
op_ne
l_int|0
)paren
(brace
id|cs_error
c_func
(paren
id|link-&gt;handle
comma
id|RegisterClient
comma
id|ret
)paren
suffix:semicolon
id|fmvj18x_detach
c_func
(paren
id|link
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
r_return
id|link
suffix:semicolon
)brace
multiline_comment|/* fmvj18x_attach */
multiline_comment|/*====================================================================*/
DECL|function|fmvj18x_detach
r_static
r_void
id|fmvj18x_detach
c_func
(paren
id|dev_link_t
op_star
id|link
)paren
(brace
id|local_info_t
op_star
id|lp
op_assign
id|link-&gt;priv
suffix:semicolon
id|dev_link_t
op_star
op_star
id|linkp
suffix:semicolon
id|DEBUG
c_func
(paren
l_int|0
comma
l_string|&quot;fmvj18x_detach(0x%p)&bslash;n&quot;
comma
id|link
)paren
suffix:semicolon
multiline_comment|/* Locate device structure */
r_for
c_loop
(paren
id|linkp
op_assign
op_amp
id|dev_list
suffix:semicolon
op_star
id|linkp
suffix:semicolon
id|linkp
op_assign
op_amp
(paren
op_star
id|linkp
)paren
op_member_access_from_pointer
id|next
)paren
r_if
c_cond
(paren
op_star
id|linkp
op_eq
id|link
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
op_star
id|linkp
op_eq
l_int|NULL
)paren
r_return
suffix:semicolon
id|del_timer
c_func
(paren
op_amp
id|link-&gt;release
)paren
suffix:semicolon
r_if
c_cond
(paren
id|link-&gt;state
op_amp
id|DEV_CONFIG
)paren
(brace
id|fmvj18x_release
c_func
(paren
(paren
id|u_long
)paren
id|link
)paren
suffix:semicolon
r_if
c_cond
(paren
id|link-&gt;state
op_amp
id|DEV_STALE_CONFIG
)paren
(brace
id|link-&gt;state
op_or_assign
id|DEV_STALE_LINK
suffix:semicolon
r_return
suffix:semicolon
)brace
)brace
multiline_comment|/* Break the link with Card Services */
r_if
c_cond
(paren
id|link-&gt;handle
)paren
id|CardServices
c_func
(paren
id|DeregisterClient
comma
id|link-&gt;handle
)paren
suffix:semicolon
multiline_comment|/* Unlink device structure, free pieces */
op_star
id|linkp
op_assign
id|link-&gt;next
suffix:semicolon
r_if
c_cond
(paren
id|link-&gt;dev
)paren
id|unregister_netdev
c_func
(paren
op_amp
id|lp-&gt;dev
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|lp
)paren
suffix:semicolon
)brace
multiline_comment|/* fmvj18x_detach */
multiline_comment|/*====================================================================*/
DECL|macro|CS_CHECK
mdefine_line|#define CS_CHECK(fn, args...) &bslash;&n;while ((last_ret=CardServices(last_fn=(fn), args))!=0) goto cs_failed
DECL|function|fmvj18x_config
r_static
r_void
id|fmvj18x_config
c_func
(paren
id|dev_link_t
op_star
id|link
)paren
(brace
id|client_handle_t
id|handle
op_assign
id|link-&gt;handle
suffix:semicolon
id|local_info_t
op_star
id|lp
op_assign
id|link-&gt;priv
suffix:semicolon
r_struct
id|net_device
op_star
id|dev
op_assign
op_amp
id|lp-&gt;dev
suffix:semicolon
id|tuple_t
id|tuple
suffix:semicolon
id|cisparse_t
id|parse
suffix:semicolon
id|u_short
id|buf
(braket
l_int|32
)braket
suffix:semicolon
r_int
id|i
comma
id|last_fn
comma
id|last_ret
comma
id|ret
suffix:semicolon
id|ioaddr_t
id|ioaddr
suffix:semicolon
id|cardtype_t
id|cardtype
suffix:semicolon
r_char
op_star
id|card_name
op_assign
l_string|&quot;unknown&quot;
suffix:semicolon
id|u_char
op_star
id|node_id
suffix:semicolon
id|DEBUG
c_func
(paren
l_int|0
comma
l_string|&quot;fmvj18x_config(0x%p)&bslash;n&quot;
comma
id|link
)paren
suffix:semicolon
multiline_comment|/*&n;       This reads the card&squot;s CONFIG tuple to find its configuration&n;       registers.&n;    */
id|tuple.DesiredTuple
op_assign
id|CISTPL_CONFIG
suffix:semicolon
id|CS_CHECK
c_func
(paren
id|GetFirstTuple
comma
id|handle
comma
op_amp
id|tuple
)paren
suffix:semicolon
id|tuple.TupleData
op_assign
(paren
id|u_char
op_star
)paren
id|buf
suffix:semicolon
id|tuple.TupleDataMax
op_assign
l_int|64
suffix:semicolon
id|tuple.TupleOffset
op_assign
l_int|0
suffix:semicolon
id|CS_CHECK
c_func
(paren
id|GetTupleData
comma
id|handle
comma
op_amp
id|tuple
)paren
suffix:semicolon
id|CS_CHECK
c_func
(paren
id|ParseTuple
comma
id|handle
comma
op_amp
id|tuple
comma
op_amp
id|parse
)paren
suffix:semicolon
multiline_comment|/* Configure card */
id|link-&gt;state
op_or_assign
id|DEV_CONFIG
suffix:semicolon
id|link-&gt;conf.ConfigBase
op_assign
id|parse.config.base
suffix:semicolon
id|link-&gt;conf.Present
op_assign
id|parse.config.rmask
(braket
l_int|0
)braket
suffix:semicolon
id|tuple.DesiredTuple
op_assign
id|CISTPL_FUNCE
suffix:semicolon
id|tuple.TupleOffset
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|CardServices
c_func
(paren
id|GetFirstTuple
comma
id|handle
comma
op_amp
id|tuple
)paren
op_eq
id|CS_SUCCESS
)paren
(brace
multiline_comment|/* Yes, I have CISTPL_FUNCE. Let&squot;s check CISTPL_MANFID */
id|tuple.DesiredTuple
op_assign
id|CISTPL_CFTABLE_ENTRY
suffix:semicolon
id|CS_CHECK
c_func
(paren
id|GetFirstTuple
comma
id|handle
comma
op_amp
id|tuple
)paren
suffix:semicolon
id|CS_CHECK
c_func
(paren
id|GetTupleData
comma
id|handle
comma
op_amp
id|tuple
)paren
suffix:semicolon
id|CS_CHECK
c_func
(paren
id|ParseTuple
comma
id|handle
comma
op_amp
id|tuple
comma
op_amp
id|parse
)paren
suffix:semicolon
id|link-&gt;conf.ConfigIndex
op_assign
id|parse.cftable_entry.index
suffix:semicolon
id|tuple.DesiredTuple
op_assign
id|CISTPL_MANFID
suffix:semicolon
r_if
c_cond
(paren
id|CardServices
c_func
(paren
id|GetFirstTuple
comma
id|handle
comma
op_amp
id|tuple
)paren
op_eq
id|CS_SUCCESS
)paren
id|CS_CHECK
c_func
(paren
id|GetTupleData
comma
id|handle
comma
op_amp
id|tuple
)paren
suffix:semicolon
r_else
id|buf
(braket
l_int|0
)braket
op_assign
l_int|0xffff
suffix:semicolon
r_switch
c_cond
(paren
id|le16_to_cpu
c_func
(paren
id|buf
(braket
l_int|0
)braket
)paren
)paren
(brace
r_case
id|MANFID_TDK
suffix:colon
id|cardtype
op_assign
id|TDK
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MANFID_CONTEC
suffix:colon
id|cardtype
op_assign
id|CONTEC
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MANFID_FUJITSU
suffix:colon
r_if
c_cond
(paren
id|le16_to_cpu
c_func
(paren
id|buf
(braket
l_int|1
)braket
)paren
op_eq
id|PRODID_FUJITSU_MBH10302
)paren
id|cardtype
op_assign
id|MBH10302
suffix:semicolon
r_else
r_if
c_cond
(paren
id|le16_to_cpu
c_func
(paren
id|buf
(braket
l_int|1
)braket
)paren
op_eq
id|PRODID_FUJITSU_MBH10304
)paren
id|cardtype
op_assign
id|MBH10304
suffix:semicolon
r_else
id|cardtype
op_assign
id|LA501
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|cardtype
op_assign
id|MBH10304
suffix:semicolon
)brace
)brace
r_else
(brace
multiline_comment|/* old type card */
id|tuple.DesiredTuple
op_assign
id|CISTPL_MANFID
suffix:semicolon
r_if
c_cond
(paren
id|CardServices
c_func
(paren
id|GetFirstTuple
comma
id|handle
comma
op_amp
id|tuple
)paren
op_eq
id|CS_SUCCESS
)paren
id|CS_CHECK
c_func
(paren
id|GetTupleData
comma
id|handle
comma
op_amp
id|tuple
)paren
suffix:semicolon
r_else
id|buf
(braket
l_int|0
)braket
op_assign
l_int|0xffff
suffix:semicolon
r_switch
c_cond
(paren
id|le16_to_cpu
c_func
(paren
id|buf
(braket
l_int|0
)braket
)paren
)paren
(brace
r_case
id|MANFID_UNGERMANN
suffix:colon
id|cardtype
op_assign
id|UNGERMANN
suffix:semicolon
multiline_comment|/*&n;&t;       Ungermann-Bass Access/CARD accepts 0x300,0x320,0x340,0x360&n;&t;       0x380,0x3c0 only for ioport.&n;&t;    */
r_for
c_loop
(paren
id|link-&gt;io.BasePort1
op_assign
l_int|0x300
suffix:semicolon
id|link-&gt;io.BasePort1
OL
l_int|0x3e0
suffix:semicolon
id|link-&gt;io.BasePort1
op_add_assign
l_int|0x20
)paren
(brace
id|ret
op_assign
id|CardServices
c_func
(paren
id|RequestIO
comma
id|link-&gt;handle
comma
op_amp
id|link-&gt;io
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
op_eq
id|CS_SUCCESS
)paren
(brace
multiline_comment|/* calculate ConfigIndex value */
id|link-&gt;conf.ConfigIndex
op_assign
(paren
(paren
id|link-&gt;io.BasePort1
op_amp
l_int|0x0f0
)paren
op_rshift
l_int|3
)paren
op_or
l_int|0x22
suffix:semicolon
r_goto
id|req_irq
suffix:semicolon
)brace
)brace
multiline_comment|/* if ioport allocation is failed, goto failed */
id|printk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;fmvj18x_cs: register_netdev() failed&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|failed
suffix:semicolon
r_default
suffix:colon
id|cardtype
op_assign
id|MBH10302
suffix:semicolon
id|link-&gt;conf.ConfigIndex
op_assign
l_int|1
suffix:semicolon
)brace
)brace
id|CS_CHECK
c_func
(paren
id|RequestIO
comma
id|link-&gt;handle
comma
op_amp
id|link-&gt;io
)paren
suffix:semicolon
id|req_irq
suffix:colon
id|CS_CHECK
c_func
(paren
id|RequestIRQ
comma
id|link-&gt;handle
comma
op_amp
id|link-&gt;irq
)paren
suffix:semicolon
id|CS_CHECK
c_func
(paren
id|RequestConfiguration
comma
id|link-&gt;handle
comma
op_amp
id|link-&gt;conf
)paren
suffix:semicolon
id|dev-&gt;irq
op_assign
id|link-&gt;irq.AssignedIRQ
suffix:semicolon
id|dev-&gt;base_addr
op_assign
id|link-&gt;io.BasePort1
suffix:semicolon
r_if
c_cond
(paren
id|register_netdev
c_func
(paren
id|dev
)paren
op_ne
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;fmvj18x_cs: register_netdev() failed&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|failed
suffix:semicolon
)brace
id|ioaddr
op_assign
id|dev-&gt;base_addr
suffix:semicolon
multiline_comment|/* Power On chip and select bank 0 */
r_if
c_cond
(paren
id|cardtype
op_eq
id|UNGERMANN
)paren
(brace
id|outb
c_func
(paren
id|BANK_0U
comma
id|ioaddr
op_plus
id|CONFIG_1
)paren
suffix:semicolon
)brace
r_else
id|outb
c_func
(paren
id|BANK_0
comma
id|ioaddr
op_plus
id|CONFIG_1
)paren
suffix:semicolon
multiline_comment|/* Reset controler */
r_if
c_cond
(paren
id|sram_config
op_eq
l_int|0
)paren
(brace
id|outb
c_func
(paren
id|CONFIG0_RST
comma
id|ioaddr
op_plus
id|CONFIG_0
)paren
suffix:semicolon
)brace
r_else
id|outb
c_func
(paren
id|CONFIG0_RST_1
comma
id|ioaddr
op_plus
id|CONFIG_0
)paren
suffix:semicolon
multiline_comment|/* Set hardware address */
r_switch
c_cond
(paren
id|cardtype
)paren
(brace
r_case
id|MBH10304
suffix:colon
r_case
id|TDK
suffix:colon
r_case
id|LA501
suffix:colon
r_case
id|CONTEC
suffix:colon
id|tuple.DesiredTuple
op_assign
id|CISTPL_FUNCE
suffix:semicolon
id|tuple.TupleOffset
op_assign
l_int|0
suffix:semicolon
id|CS_CHECK
c_func
(paren
id|GetFirstTuple
comma
id|handle
comma
op_amp
id|tuple
)paren
suffix:semicolon
id|tuple.TupleOffset
op_assign
l_int|0
suffix:semicolon
id|CS_CHECK
c_func
(paren
id|GetTupleData
comma
id|handle
comma
op_amp
id|tuple
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cardtype
op_eq
id|MBH10304
)paren
(brace
multiline_comment|/* MBH10304&squot;s CIS_FUNCE is corrupted */
id|node_id
op_assign
op_amp
(paren
id|tuple.TupleData
(braket
l_int|5
)braket
)paren
suffix:semicolon
id|card_name
op_assign
l_string|&quot;FMV-J182&quot;
suffix:semicolon
)brace
r_else
(brace
r_while
c_loop
(paren
id|tuple.TupleData
(braket
l_int|0
)braket
op_ne
id|CISTPL_FUNCE_LAN_NODE_ID
)paren
(brace
id|CS_CHECK
c_func
(paren
id|GetNextTuple
comma
id|handle
comma
op_amp
id|tuple
)paren
suffix:semicolon
id|CS_CHECK
c_func
(paren
id|GetTupleData
comma
id|handle
comma
op_amp
id|tuple
)paren
suffix:semicolon
)brace
id|node_id
op_assign
op_amp
(paren
id|tuple.TupleData
(braket
l_int|2
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cardtype
op_eq
id|TDK
)paren
(brace
id|card_name
op_assign
l_string|&quot;TDK LAK-CD021&quot;
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|cardtype
op_eq
id|LA501
)paren
(brace
id|card_name
op_assign
l_string|&quot;LA501&quot;
suffix:semicolon
)brace
r_else
(brace
id|card_name
op_assign
l_string|&quot;C-NET(PC)C&quot;
suffix:semicolon
)brace
)brace
multiline_comment|/* Read MACID from CIS */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|6
suffix:semicolon
id|i
op_increment
)paren
id|dev-&gt;dev_addr
(braket
id|i
)braket
op_assign
id|node_id
(braket
id|i
)braket
suffix:semicolon
r_break
suffix:semicolon
r_case
id|UNGERMANN
suffix:colon
multiline_comment|/* Read MACID from register */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|6
suffix:semicolon
id|i
op_increment
)paren
id|dev-&gt;dev_addr
(braket
id|i
)braket
op_assign
id|inb
c_func
(paren
id|ioaddr
op_plus
id|UNGERMANN_MAC_ID
op_plus
id|i
)paren
suffix:semicolon
id|card_name
op_assign
l_string|&quot;Access/CARD&quot;
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MBH10302
suffix:colon
r_default
suffix:colon
(brace
)brace
multiline_comment|/* Read MACID from register */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|6
suffix:semicolon
id|i
op_increment
)paren
id|dev-&gt;dev_addr
(braket
id|i
)braket
op_assign
id|inb
c_func
(paren
id|ioaddr
op_plus
id|MAC_ID
op_plus
id|i
)paren
suffix:semicolon
id|card_name
op_assign
l_string|&quot;FMV-J181&quot;
suffix:semicolon
r_break
suffix:semicolon
)brace
id|strcpy
c_func
(paren
id|lp-&gt;node.dev_name
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|link-&gt;dev
op_assign
op_amp
id|lp-&gt;node
suffix:semicolon
id|link-&gt;state
op_and_assign
op_complement
id|DEV_CONFIG_PENDING
suffix:semicolon
id|lp-&gt;cardtype
op_assign
id|cardtype
suffix:semicolon
multiline_comment|/* print current configuration */
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: %s, sram %s, port %#3lx, irq %d, hw_addr &quot;
comma
id|dev-&gt;name
comma
id|card_name
comma
id|sram_config
op_eq
l_int|0
ques
c_cond
l_string|&quot;4K TX*2&quot;
suffix:colon
l_string|&quot;8K TX*2&quot;
comma
id|dev-&gt;base_addr
comma
id|dev-&gt;irq
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|6
suffix:semicolon
id|i
op_increment
)paren
id|printk
c_func
(paren
l_string|&quot;%02X%s&quot;
comma
id|dev-&gt;dev_addr
(braket
id|i
)braket
comma
(paren
(paren
id|i
OL
l_int|5
)paren
ques
c_cond
l_string|&quot;:&quot;
suffix:colon
l_string|&quot;&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_return
suffix:semicolon
id|cs_failed
suffix:colon
multiline_comment|/* All Card Services errors end up here */
id|cs_error
c_func
(paren
id|link-&gt;handle
comma
id|last_fn
comma
id|last_ret
)paren
suffix:semicolon
id|failed
suffix:colon
id|fmvj18x_release
c_func
(paren
(paren
id|u_long
)paren
id|link
)paren
suffix:semicolon
)brace
multiline_comment|/* fmvj18x_config */
multiline_comment|/*====================================================================*/
DECL|function|fmvj18x_release
r_static
r_void
id|fmvj18x_release
c_func
(paren
id|u_long
id|arg
)paren
(brace
id|dev_link_t
op_star
id|link
op_assign
(paren
id|dev_link_t
op_star
)paren
id|arg
suffix:semicolon
id|DEBUG
c_func
(paren
l_int|0
comma
l_string|&quot;fmvj18x_release(0x%p)&bslash;n&quot;
comma
id|link
)paren
suffix:semicolon
multiline_comment|/*&n;       If the device is currently in use, we won&squot;t release until it&n;       is actually closed.&n;    */
r_if
c_cond
(paren
id|link-&gt;open
)paren
(brace
id|DEBUG
c_func
(paren
l_int|1
comma
l_string|&quot;fmvj18x_cs: release postponed, &squot;%s&squot; &quot;
l_string|&quot;still open&bslash;n&quot;
comma
id|link-&gt;dev-&gt;dev_name
)paren
suffix:semicolon
id|link-&gt;state
op_or_assign
id|DEV_STALE_CONFIG
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/* Don&squot;t bother checking to see if these succeed or not */
id|CardServices
c_func
(paren
id|ReleaseWindow
comma
id|link-&gt;win
)paren
suffix:semicolon
id|CardServices
c_func
(paren
id|ReleaseConfiguration
comma
id|link-&gt;handle
)paren
suffix:semicolon
id|CardServices
c_func
(paren
id|ReleaseIO
comma
id|link-&gt;handle
comma
op_amp
id|link-&gt;io
)paren
suffix:semicolon
id|CardServices
c_func
(paren
id|ReleaseIRQ
comma
id|link-&gt;handle
comma
op_amp
id|link-&gt;irq
)paren
suffix:semicolon
id|link-&gt;state
op_and_assign
op_complement
id|DEV_CONFIG
suffix:semicolon
)brace
multiline_comment|/* fmvj18x_release */
multiline_comment|/*====================================================================*/
DECL|function|fmvj18x_event
r_static
r_int
id|fmvj18x_event
c_func
(paren
id|event_t
id|event
comma
r_int
id|priority
comma
id|event_callback_args_t
op_star
id|args
)paren
(brace
id|dev_link_t
op_star
id|link
op_assign
id|args-&gt;client_data
suffix:semicolon
id|local_info_t
op_star
id|lp
op_assign
id|link-&gt;priv
suffix:semicolon
r_struct
id|net_device
op_star
id|dev
op_assign
op_amp
id|lp-&gt;dev
suffix:semicolon
id|DEBUG
c_func
(paren
l_int|1
comma
l_string|&quot;fmvj18x_event(0x%06x)&bslash;n&quot;
comma
id|event
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|event
)paren
(brace
r_case
id|CS_EVENT_CARD_REMOVAL
suffix:colon
id|link-&gt;state
op_and_assign
op_complement
id|DEV_PRESENT
suffix:semicolon
r_if
c_cond
(paren
id|link-&gt;state
op_amp
id|DEV_CONFIG
)paren
(brace
id|netif_device_detach
c_func
(paren
id|dev
)paren
suffix:semicolon
id|mod_timer
c_func
(paren
op_amp
id|link-&gt;release
comma
id|jiffies
op_plus
id|HZ
op_div
l_int|20
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|CS_EVENT_CARD_INSERTION
suffix:colon
id|link-&gt;state
op_or_assign
id|DEV_PRESENT
op_or
id|DEV_CONFIG_PENDING
suffix:semicolon
id|fmvj18x_config
c_func
(paren
id|link
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CS_EVENT_PM_SUSPEND
suffix:colon
id|link-&gt;state
op_or_assign
id|DEV_SUSPEND
suffix:semicolon
multiline_comment|/* Fall through... */
r_case
id|CS_EVENT_RESET_PHYSICAL
suffix:colon
r_if
c_cond
(paren
id|link-&gt;state
op_amp
id|DEV_CONFIG
)paren
(brace
r_if
c_cond
(paren
id|link-&gt;open
)paren
id|netif_device_detach
c_func
(paren
id|dev
)paren
suffix:semicolon
id|CardServices
c_func
(paren
id|ReleaseConfiguration
comma
id|link-&gt;handle
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|CS_EVENT_PM_RESUME
suffix:colon
id|link-&gt;state
op_and_assign
op_complement
id|DEV_SUSPEND
suffix:semicolon
multiline_comment|/* Fall through... */
r_case
id|CS_EVENT_CARD_RESET
suffix:colon
r_if
c_cond
(paren
id|link-&gt;state
op_amp
id|DEV_CONFIG
)paren
(brace
id|CardServices
c_func
(paren
id|RequestConfiguration
comma
id|link-&gt;handle
comma
op_amp
id|link-&gt;conf
)paren
suffix:semicolon
r_if
c_cond
(paren
id|link-&gt;open
)paren
(brace
id|fjn_reset
c_func
(paren
id|dev
)paren
suffix:semicolon
id|netif_device_attach
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
)brace
r_break
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* fmvj18x_event */
multiline_comment|/*====================================================================*/
DECL|function|init_fmvj18x_cs
r_static
r_int
id|__init
id|init_fmvj18x_cs
c_func
(paren
r_void
)paren
(brace
id|servinfo_t
id|serv
suffix:semicolon
id|DEBUG
c_func
(paren
l_int|0
comma
l_string|&quot;%s&bslash;n&quot;
comma
id|version
)paren
suffix:semicolon
id|CardServices
c_func
(paren
id|GetCardServicesInfo
comma
op_amp
id|serv
)paren
suffix:semicolon
r_if
c_cond
(paren
id|serv.Revision
op_ne
id|CS_RELEASE_CODE
)paren
(brace
id|printk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;fmvj18x: Card Services release &quot;
l_string|&quot;does not match!&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|register_pccard_driver
c_func
(paren
op_amp
id|dev_info
comma
op_amp
id|fmvj18x_attach
comma
op_amp
id|fmvj18x_detach
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|exit_fmvj18x_cs
r_static
r_void
id|__exit
id|exit_fmvj18x_cs
c_func
(paren
r_void
)paren
(brace
id|DEBUG
c_func
(paren
l_int|0
comma
l_string|&quot;fmvj18x_cs: unloading&bslash;n&quot;
)paren
suffix:semicolon
id|unregister_pccard_driver
c_func
(paren
op_amp
id|dev_info
)paren
suffix:semicolon
r_while
c_loop
(paren
id|dev_list
op_ne
l_int|NULL
)paren
id|fmvj18x_detach
c_func
(paren
id|dev_list
)paren
suffix:semicolon
)brace
DECL|variable|init_fmvj18x_cs
id|module_init
c_func
(paren
id|init_fmvj18x_cs
)paren
suffix:semicolon
DECL|variable|exit_fmvj18x_cs
id|module_exit
c_func
(paren
id|exit_fmvj18x_cs
)paren
suffix:semicolon
multiline_comment|/*====================================================================*/
DECL|function|fjn_interrupt
r_static
r_void
id|fjn_interrupt
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
id|local_info_t
op_star
id|lp
op_assign
id|dev_id
suffix:semicolon
r_struct
id|net_device
op_star
id|dev
op_assign
op_amp
id|lp-&gt;dev
suffix:semicolon
id|ioaddr_t
id|ioaddr
suffix:semicolon
r_int
r_int
id|tx_stat
comma
id|rx_stat
suffix:semicolon
r_if
c_cond
(paren
id|lp
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;fjn_interrupt(): irq %d for &quot;
l_string|&quot;unknown device.&bslash;n&quot;
comma
id|irq
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|ioaddr
op_assign
id|dev-&gt;base_addr
suffix:semicolon
multiline_comment|/* avoid multiple interrupts */
id|outw
c_func
(paren
l_int|0x0000
comma
id|ioaddr
op_plus
id|TX_INTR
)paren
suffix:semicolon
multiline_comment|/* wait for a while */
id|udelay
c_func
(paren
l_int|1
)paren
suffix:semicolon
multiline_comment|/* get status */
id|tx_stat
op_assign
id|inb
c_func
(paren
id|ioaddr
op_plus
id|TX_STATUS
)paren
suffix:semicolon
id|rx_stat
op_assign
id|inb
c_func
(paren
id|ioaddr
op_plus
id|RX_STATUS
)paren
suffix:semicolon
multiline_comment|/* clear status */
id|outb
c_func
(paren
id|tx_stat
comma
id|ioaddr
op_plus
id|TX_STATUS
)paren
suffix:semicolon
id|outb
c_func
(paren
id|rx_stat
comma
id|ioaddr
op_plus
id|RX_STATUS
)paren
suffix:semicolon
id|DEBUG
c_func
(paren
l_int|4
comma
l_string|&quot;%s: interrupt, rx_status %02x.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|rx_stat
)paren
suffix:semicolon
id|DEBUG
c_func
(paren
l_int|4
comma
l_string|&quot;               tx_status %02x.&bslash;n&quot;
comma
id|tx_stat
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rx_stat
op_logical_or
(paren
id|inb
c_func
(paren
id|ioaddr
op_plus
id|RX_MODE
)paren
op_amp
id|F_BUF_EMP
)paren
op_eq
l_int|0
)paren
(brace
multiline_comment|/* there is packet(s) in rx buffer */
id|fjn_rx
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|tx_stat
op_amp
id|F_TMT_RDY
)paren
(brace
id|lp-&gt;stats.tx_packets
op_add_assign
id|lp-&gt;sent
suffix:semicolon
id|lp-&gt;sent
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|lp-&gt;tx_queue
)paren
(brace
id|outb
c_func
(paren
id|DO_TX
op_or
id|lp-&gt;tx_queue
comma
id|ioaddr
op_plus
id|TX_START
)paren
suffix:semicolon
id|lp-&gt;sent
op_assign
id|lp-&gt;tx_queue
suffix:semicolon
id|lp-&gt;tx_queue
op_assign
l_int|0
suffix:semicolon
id|lp-&gt;tx_queue_len
op_assign
l_int|0
suffix:semicolon
id|dev-&gt;trans_start
op_assign
id|jiffies
suffix:semicolon
)brace
r_else
(brace
id|lp-&gt;tx_started
op_assign
l_int|0
suffix:semicolon
)brace
id|netif_wake_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
id|DEBUG
c_func
(paren
l_int|4
comma
l_string|&quot;%s: exiting interrupt,&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|DEBUG
c_func
(paren
l_int|4
comma
l_string|&quot;    tx_status %02x, rx_status %02x.&bslash;n&quot;
comma
id|tx_stat
comma
id|rx_stat
)paren
suffix:semicolon
id|outb
c_func
(paren
id|D_TX_INTR
comma
id|ioaddr
op_plus
id|TX_INTR
)paren
suffix:semicolon
id|outb
c_func
(paren
id|D_RX_INTR
comma
id|ioaddr
op_plus
id|RX_INTR
)paren
suffix:semicolon
)brace
multiline_comment|/* fjn_interrupt */
multiline_comment|/*====================================================================*/
DECL|function|fjn_tx_timeout
r_static
r_void
id|fjn_tx_timeout
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|local_info_t
op_star
id|lp
op_assign
(paren
r_struct
id|local_info_t
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|ioaddr_t
id|ioaddr
op_assign
id|dev-&gt;base_addr
suffix:semicolon
id|printk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;%s: transmit timed out with status %04x, %s?&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|htons
c_func
(paren
id|inw
c_func
(paren
id|ioaddr
op_plus
id|TX_STATUS
)paren
)paren
comma
id|inb
c_func
(paren
id|ioaddr
op_plus
id|TX_STATUS
)paren
op_amp
id|F_TMT_RDY
ques
c_cond
l_string|&quot;IRQ conflict&quot;
suffix:colon
l_string|&quot;network cable problem&quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;%s: timeout registers: %04x %04x %04x &quot;
l_string|&quot;%04x %04x %04x %04x %04x.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|htons
c_func
(paren
id|inw
c_func
(paren
id|ioaddr
op_plus
l_int|0
)paren
)paren
comma
id|htons
c_func
(paren
id|inw
c_func
(paren
id|ioaddr
op_plus
l_int|2
)paren
)paren
comma
id|htons
c_func
(paren
id|inw
c_func
(paren
id|ioaddr
op_plus
l_int|4
)paren
)paren
comma
id|htons
c_func
(paren
id|inw
c_func
(paren
id|ioaddr
op_plus
l_int|6
)paren
)paren
comma
id|htons
c_func
(paren
id|inw
c_func
(paren
id|ioaddr
op_plus
l_int|8
)paren
)paren
comma
id|htons
c_func
(paren
id|inw
c_func
(paren
id|ioaddr
op_plus
l_int|10
)paren
)paren
comma
id|htons
c_func
(paren
id|inw
c_func
(paren
id|ioaddr
op_plus
l_int|12
)paren
)paren
comma
id|htons
c_func
(paren
id|inw
c_func
(paren
id|ioaddr
op_plus
l_int|14
)paren
)paren
)paren
suffix:semicolon
id|lp-&gt;stats.tx_errors
op_increment
suffix:semicolon
multiline_comment|/* ToDo: We should try to restart the adaptor... */
id|cli
c_func
(paren
)paren
suffix:semicolon
id|fjn_reset
c_func
(paren
id|dev
)paren
suffix:semicolon
id|lp-&gt;tx_started
op_assign
l_int|0
suffix:semicolon
id|lp-&gt;tx_queue
op_assign
l_int|0
suffix:semicolon
id|lp-&gt;tx_queue_len
op_assign
l_int|0
suffix:semicolon
id|lp-&gt;sent
op_assign
l_int|0
suffix:semicolon
id|lp-&gt;open_time
op_assign
id|jiffies
suffix:semicolon
id|sti
c_func
(paren
)paren
suffix:semicolon
id|netif_start_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
DECL|function|fjn_start_xmit
r_static
r_int
id|fjn_start_xmit
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|local_info_t
op_star
id|lp
op_assign
(paren
r_struct
id|local_info_t
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|ioaddr_t
id|ioaddr
op_assign
id|dev-&gt;base_addr
suffix:semicolon
id|netif_stop_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
(brace
r_int
id|length
op_assign
id|ETH_ZLEN
OL
id|skb-&gt;len
ques
c_cond
id|skb-&gt;len
suffix:colon
id|ETH_ZLEN
suffix:semicolon
r_int
r_char
op_star
id|buf
op_assign
id|skb-&gt;data
suffix:semicolon
r_if
c_cond
(paren
id|length
OG
id|ETH_FRAME_LEN
)paren
(brace
id|printk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;%s: Attempting to send a large packet&quot;
l_string|&quot; (%d bytes).&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|length
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
id|DEBUG
c_func
(paren
l_int|4
comma
l_string|&quot;%s: Transmitting a packet of length %lu.&bslash;n&quot;
comma
id|dev-&gt;name
comma
(paren
r_int
r_int
)paren
id|skb-&gt;len
)paren
suffix:semicolon
id|lp-&gt;stats.tx_bytes
op_add_assign
id|skb-&gt;len
suffix:semicolon
multiline_comment|/* Disable both interrupts. */
id|outw
c_func
(paren
l_int|0x0000
comma
id|ioaddr
op_plus
id|TX_INTR
)paren
suffix:semicolon
multiline_comment|/* wait for a while */
id|udelay
c_func
(paren
l_int|1
)paren
suffix:semicolon
id|outw
c_func
(paren
id|length
comma
id|ioaddr
op_plus
id|DATAPORT
)paren
suffix:semicolon
id|outsw
c_func
(paren
id|ioaddr
op_plus
id|DATAPORT
comma
id|buf
comma
(paren
id|length
op_plus
l_int|1
)paren
op_rshift
l_int|1
)paren
suffix:semicolon
id|lp-&gt;tx_queue
op_increment
suffix:semicolon
id|lp-&gt;tx_queue_len
op_add_assign
(paren
(paren
id|length
op_plus
l_int|3
)paren
op_amp
op_complement
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|lp-&gt;tx_started
op_eq
l_int|0
)paren
(brace
multiline_comment|/* If the Tx is idle, always trigger a transmit. */
id|outb
c_func
(paren
id|DO_TX
op_or
id|lp-&gt;tx_queue
comma
id|ioaddr
op_plus
id|TX_START
)paren
suffix:semicolon
id|lp-&gt;sent
op_assign
id|lp-&gt;tx_queue
suffix:semicolon
id|lp-&gt;tx_queue
op_assign
l_int|0
suffix:semicolon
id|lp-&gt;tx_queue_len
op_assign
l_int|0
suffix:semicolon
id|dev-&gt;trans_start
op_assign
id|jiffies
suffix:semicolon
id|lp-&gt;tx_started
op_assign
l_int|1
suffix:semicolon
id|netif_start_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|sram_config
op_eq
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|lp-&gt;tx_queue_len
OL
(paren
l_int|4096
op_minus
(paren
id|ETH_FRAME_LEN
op_plus
l_int|2
)paren
)paren
)paren
multiline_comment|/* Yes, there is room for one more packet. */
id|netif_start_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|lp-&gt;tx_queue_len
OL
(paren
l_int|8192
op_minus
(paren
id|ETH_FRAME_LEN
op_plus
l_int|2
)paren
)paren
op_logical_and
id|lp-&gt;tx_queue
OL
l_int|127
)paren
multiline_comment|/* Yes, there is room for one more packet. */
id|netif_start_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* Re-enable interrupts */
id|outb
c_func
(paren
id|D_TX_INTR
comma
id|ioaddr
op_plus
id|TX_INTR
)paren
suffix:semicolon
id|outb
c_func
(paren
id|D_RX_INTR
comma
id|ioaddr
op_plus
id|RX_INTR
)paren
suffix:semicolon
)brace
id|dev_kfree_skb
(paren
id|skb
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* fjn_start_xmit */
multiline_comment|/*====================================================================*/
DECL|function|fjn_reset
r_static
r_void
id|fjn_reset
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|local_info_t
op_star
id|lp
op_assign
(paren
r_struct
id|local_info_t
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|ioaddr_t
id|ioaddr
op_assign
id|dev-&gt;base_addr
suffix:semicolon
r_int
id|i
suffix:semicolon
id|DEBUG
c_func
(paren
l_int|4
comma
l_string|&quot;fjn_reset(%s) called.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
multiline_comment|/* Power On chip and select bank 0 */
r_if
c_cond
(paren
id|lp-&gt;cardtype
op_eq
id|UNGERMANN
)paren
(brace
id|outb
c_func
(paren
id|BANK_0U
comma
id|ioaddr
op_plus
id|CONFIG_1
)paren
suffix:semicolon
)brace
r_else
id|outb
c_func
(paren
id|BANK_0
comma
id|ioaddr
op_plus
id|CONFIG_1
)paren
suffix:semicolon
multiline_comment|/* Reset buffers */
r_if
c_cond
(paren
id|sram_config
op_eq
l_int|0
)paren
(brace
id|outb
c_func
(paren
id|CONFIG0_RST
comma
id|ioaddr
op_plus
id|CONFIG_0
)paren
suffix:semicolon
)brace
r_else
id|outb
c_func
(paren
id|CONFIG0_RST_1
comma
id|ioaddr
op_plus
id|CONFIG_0
)paren
suffix:semicolon
multiline_comment|/* Set Tx modes */
id|outb
c_func
(paren
id|D_TX_MODE
comma
id|ioaddr
op_plus
id|TX_MODE
)paren
suffix:semicolon
multiline_comment|/* set Rx modes */
id|outb
c_func
(paren
id|ID_MATCHED
comma
id|ioaddr
op_plus
id|RX_MODE
)paren
suffix:semicolon
multiline_comment|/* Set hardware address */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|6
suffix:semicolon
id|i
op_increment
)paren
id|outb
c_func
(paren
id|dev-&gt;dev_addr
(braket
id|i
)braket
comma
id|ioaddr
op_plus
id|NODE_ID
op_plus
id|i
)paren
suffix:semicolon
multiline_comment|/* Switch to bank 1 */
r_if
c_cond
(paren
id|lp-&gt;cardtype
op_eq
id|UNGERMANN
)paren
id|outb
c_func
(paren
id|BANK_1U
comma
id|ioaddr
op_plus
id|CONFIG_1
)paren
suffix:semicolon
r_else
id|outb
c_func
(paren
id|BANK_1
comma
id|ioaddr
op_plus
id|CONFIG_1
)paren
suffix:semicolon
multiline_comment|/* set the multicast table to accept none. */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|6
suffix:semicolon
id|i
op_increment
)paren
id|outb
c_func
(paren
l_int|0x00
comma
id|ioaddr
op_plus
id|MAR_ADR
op_plus
id|i
)paren
suffix:semicolon
multiline_comment|/* Switch to bank 2 (runtime mode) */
r_if
c_cond
(paren
id|lp-&gt;cardtype
op_eq
id|UNGERMANN
)paren
id|outb
c_func
(paren
id|BANK_2U
comma
id|ioaddr
op_plus
id|CONFIG_1
)paren
suffix:semicolon
r_else
id|outb
c_func
(paren
id|BANK_2
comma
id|ioaddr
op_plus
id|CONFIG_1
)paren
suffix:semicolon
multiline_comment|/* set 16col ctrl bits */
r_if
c_cond
(paren
id|lp-&gt;cardtype
op_eq
id|TDK
)paren
(brace
id|outb
c_func
(paren
id|TDK_AUTO_MODE
comma
id|ioaddr
op_plus
id|COL_CTRL
)paren
suffix:semicolon
)brace
r_else
id|outb
c_func
(paren
id|AUTO_MODE
comma
id|ioaddr
op_plus
id|COL_CTRL
)paren
suffix:semicolon
multiline_comment|/* clear Reserved Regs */
id|outb
c_func
(paren
l_int|0x00
comma
id|ioaddr
op_plus
id|BMPR12
)paren
suffix:semicolon
id|outb
c_func
(paren
l_int|0x00
comma
id|ioaddr
op_plus
id|BMPR13
)paren
suffix:semicolon
multiline_comment|/* reset Skip packet reg. */
id|outb
c_func
(paren
l_int|0x01
comma
id|ioaddr
op_plus
id|RX_SKIP
)paren
suffix:semicolon
multiline_comment|/* Enable Tx and Rx */
r_if
c_cond
(paren
id|sram_config
op_eq
l_int|0
)paren
(brace
id|outb
c_func
(paren
id|CONFIG0_DFL
comma
id|ioaddr
op_plus
id|CONFIG_0
)paren
suffix:semicolon
)brace
r_else
id|outb
c_func
(paren
id|CONFIG0_DFL_1
comma
id|ioaddr
op_plus
id|CONFIG_0
)paren
suffix:semicolon
multiline_comment|/* Init receive pointer ? */
id|inw
c_func
(paren
id|ioaddr
op_plus
id|DATAPORT
)paren
suffix:semicolon
id|inw
c_func
(paren
id|ioaddr
op_plus
id|DATAPORT
)paren
suffix:semicolon
multiline_comment|/* Clear all status */
id|outb
c_func
(paren
l_int|0xff
comma
id|ioaddr
op_plus
id|TX_STATUS
)paren
suffix:semicolon
id|outb
c_func
(paren
l_int|0xff
comma
id|ioaddr
op_plus
id|RX_STATUS
)paren
suffix:semicolon
r_if
c_cond
(paren
id|lp-&gt;cardtype
op_ne
id|TDK
)paren
(brace
id|outb
c_func
(paren
id|INTR_OFF
comma
id|ioaddr
op_plus
id|LAN_CTRL
)paren
suffix:semicolon
)brace
multiline_comment|/* Turn on Rx interrupts */
id|outb
c_func
(paren
id|D_TX_INTR
comma
id|ioaddr
op_plus
id|TX_INTR
)paren
suffix:semicolon
id|outb
c_func
(paren
id|D_RX_INTR
comma
id|ioaddr
op_plus
id|RX_INTR
)paren
suffix:semicolon
multiline_comment|/* Turn on interrupts from LAN card controler */
r_if
c_cond
(paren
id|lp-&gt;cardtype
op_ne
id|TDK
)paren
(brace
id|outb
c_func
(paren
id|INTR_ON
comma
id|ioaddr
op_plus
id|LAN_CTRL
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* fjn_reset */
multiline_comment|/*====================================================================*/
DECL|function|fjn_rx
r_static
r_void
id|fjn_rx
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|local_info_t
op_star
id|lp
op_assign
(paren
r_struct
id|local_info_t
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|ioaddr_t
id|ioaddr
op_assign
id|dev-&gt;base_addr
suffix:semicolon
r_int
id|boguscount
op_assign
l_int|10
suffix:semicolon
multiline_comment|/* 5 -&gt; 10: by agy 19940922 */
id|DEBUG
c_func
(paren
l_int|4
comma
l_string|&quot;%s: in rx_packet(), rx_status %02x.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|inb
c_func
(paren
id|ioaddr
op_plus
id|RX_STATUS
)paren
)paren
suffix:semicolon
r_while
c_loop
(paren
(paren
id|inb
c_func
(paren
id|ioaddr
op_plus
id|RX_MODE
)paren
op_amp
id|F_BUF_EMP
)paren
op_eq
l_int|0
)paren
(brace
id|u_short
id|status
op_assign
id|inw
c_func
(paren
id|ioaddr
op_plus
id|DATAPORT
)paren
suffix:semicolon
id|DEBUG
c_func
(paren
l_int|4
comma
l_string|&quot;%s: Rxing packet mode %02x status %04x.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|inb
c_func
(paren
id|ioaddr
op_plus
id|RX_MODE
)paren
comma
id|status
)paren
suffix:semicolon
macro_line|#ifndef final_version
r_if
c_cond
(paren
id|status
op_eq
l_int|0
)paren
(brace
id|outb
c_func
(paren
id|F_SKP_PKT
comma
id|ioaddr
op_plus
id|RX_SKIP
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
macro_line|#endif
r_if
c_cond
(paren
(paren
id|status
op_amp
l_int|0xF0
)paren
op_ne
l_int|0x20
)paren
(brace
multiline_comment|/* There was an error. */
id|lp-&gt;stats.rx_errors
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
id|F_LEN_ERR
)paren
id|lp-&gt;stats.rx_length_errors
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
id|F_ALG_ERR
)paren
id|lp-&gt;stats.rx_frame_errors
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
id|F_CRC_ERR
)paren
id|lp-&gt;stats.rx_crc_errors
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
id|F_OVR_FLO
)paren
id|lp-&gt;stats.rx_over_errors
op_increment
suffix:semicolon
)brace
r_else
(brace
id|u_short
id|pkt_len
op_assign
id|inw
c_func
(paren
id|ioaddr
op_plus
id|DATAPORT
)paren
suffix:semicolon
multiline_comment|/* Malloc up new buffer. */
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
r_if
c_cond
(paren
id|pkt_len
OG
l_int|1550
)paren
(brace
id|printk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;%s: The FMV-18x claimed a very &quot;
l_string|&quot;large packet, size %d.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|pkt_len
)paren
suffix:semicolon
id|outb
c_func
(paren
id|F_SKP_PKT
comma
id|ioaddr
op_plus
id|RX_SKIP
)paren
suffix:semicolon
id|lp-&gt;stats.rx_errors
op_increment
suffix:semicolon
r_break
suffix:semicolon
)brace
id|skb
op_assign
id|dev_alloc_skb
c_func
(paren
id|pkt_len
op_plus
l_int|2
)paren
suffix:semicolon
r_if
c_cond
(paren
id|skb
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;%s: Memory squeeze, dropping &quot;
l_string|&quot;packet (len %d).&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|pkt_len
)paren
suffix:semicolon
id|outb
c_func
(paren
id|F_SKP_PKT
comma
id|ioaddr
op_plus
id|RX_SKIP
)paren
suffix:semicolon
id|lp-&gt;stats.rx_dropped
op_increment
suffix:semicolon
r_break
suffix:semicolon
)brace
id|skb-&gt;dev
op_assign
id|dev
suffix:semicolon
id|skb_reserve
c_func
(paren
id|skb
comma
l_int|2
)paren
suffix:semicolon
id|insw
c_func
(paren
id|ioaddr
op_plus
id|DATAPORT
comma
id|skb_put
c_func
(paren
id|skb
comma
id|pkt_len
)paren
comma
(paren
id|pkt_len
op_plus
l_int|1
)paren
op_rshift
l_int|1
)paren
suffix:semicolon
id|skb-&gt;protocol
op_assign
id|eth_type_trans
c_func
(paren
id|skb
comma
id|dev
)paren
suffix:semicolon
macro_line|#ifdef PCMCIA_DEBUG
r_if
c_cond
(paren
id|pc_debug
OG
l_int|5
)paren
(brace
r_int
id|i
suffix:semicolon
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%s: Rxed packet of length %d: &quot;
comma
id|dev-&gt;name
comma
id|pkt_len
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|14
suffix:semicolon
id|i
op_increment
)paren
id|printk
c_func
(paren
l_string|&quot; %02x&quot;
comma
id|skb-&gt;data
(braket
id|i
)braket
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;.&bslash;n&quot;
)paren
suffix:semicolon
)brace
macro_line|#endif
id|netif_rx
c_func
(paren
id|skb
)paren
suffix:semicolon
id|lp-&gt;stats.rx_packets
op_increment
suffix:semicolon
id|lp-&gt;stats.rx_bytes
op_add_assign
id|skb-&gt;len
suffix:semicolon
)brace
r_if
c_cond
(paren
op_decrement
id|boguscount
op_le
l_int|0
)paren
r_break
suffix:semicolon
)brace
multiline_comment|/* If any worth-while packets have been received, dev_rint()&n;&t;   has done a netif_wake_queue() for us and will work on them&n;&t;   when we get to the bottom-half routine. */
multiline_comment|/*&n;    if( lp-&gt;cardtype != TDK ) {&n;&t;int i;&n;&t;for (i = 0; i &lt; 20; i++) {&n;&t;    if ((inb(ioaddr + RX_MODE) &amp; F_BUF_EMP) == F_BUF_EMP)&n;&t;&t;break;&n;&t;    (void)inw(ioaddr + DATAPORT);  /+ dummy status read +/&n;&t;    outb(F_SKP_PKT, ioaddr + RX_SKIP);&n;&t;}&n;&n;&t;if (i &gt; 0)&n;&t;    DEBUG(5, &quot;%s: Exint Rx packet with mode %02x after &quot;&n;&t;&t;  &quot;%d ticks.&bslash;n&quot;, dev-&gt;name, inb(ioaddr + RX_MODE), i);&n;    }&n;*/
r_return
suffix:semicolon
)brace
multiline_comment|/* fjn_rx */
multiline_comment|/*====================================================================*/
DECL|function|fjn_config
r_static
r_int
(def_block
id|fjn_config
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_struct
id|ifmap
op_star
id|map
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
)def_block
DECL|function|fjn_open
r_static
r_int
id|fjn_open
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|local_info_t
op_star
id|lp
op_assign
(paren
r_struct
id|local_info_t
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|dev_link_t
op_star
id|link
op_assign
op_amp
id|lp-&gt;link
suffix:semicolon
id|DEBUG
c_func
(paren
l_int|4
comma
l_string|&quot;fjn_open(&squot;%s&squot;).&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|DEV_OK
c_func
(paren
id|link
)paren
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
id|link-&gt;open
op_increment
suffix:semicolon
id|fjn_reset
c_func
(paren
id|dev
)paren
suffix:semicolon
id|lp-&gt;tx_started
op_assign
l_int|0
suffix:semicolon
id|lp-&gt;tx_queue
op_assign
l_int|0
suffix:semicolon
id|lp-&gt;tx_queue_len
op_assign
l_int|0
suffix:semicolon
id|lp-&gt;open_time
op_assign
id|jiffies
suffix:semicolon
id|netif_start_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
id|MOD_INC_USE_COUNT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* fjn_open */
multiline_comment|/*====================================================================*/
DECL|function|fjn_close
r_static
r_int
id|fjn_close
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|local_info_t
op_star
id|lp
op_assign
(paren
r_struct
id|local_info_t
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|dev_link_t
op_star
id|link
op_assign
op_amp
id|lp-&gt;link
suffix:semicolon
id|ioaddr_t
id|ioaddr
op_assign
id|dev-&gt;base_addr
suffix:semicolon
id|DEBUG
c_func
(paren
l_int|4
comma
l_string|&quot;fjn_close(&squot;%s&squot;).&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|lp-&gt;open_time
op_assign
l_int|0
suffix:semicolon
id|netif_stop_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
multiline_comment|/* Set configuration register 0 to disable Tx and Rx. */
r_if
c_cond
(paren
id|sram_config
op_eq
l_int|0
)paren
(brace
id|outb
c_func
(paren
id|CONFIG0_RST
comma
id|ioaddr
op_plus
id|CONFIG_0
)paren
suffix:semicolon
)brace
r_else
id|outb
c_func
(paren
id|CONFIG0_RST_1
comma
id|ioaddr
op_plus
id|CONFIG_0
)paren
suffix:semicolon
multiline_comment|/* Update the statistics -- ToDo. */
multiline_comment|/* Power-down the chip.  Green, green, green! */
id|outb
c_func
(paren
id|CHIP_OFF
comma
id|ioaddr
op_plus
id|CONFIG_1
)paren
suffix:semicolon
multiline_comment|/* Set the ethernet adaptor disable IRQ */
r_if
c_cond
(paren
id|lp-&gt;cardtype
op_ne
id|TDK
)paren
(brace
id|outb
c_func
(paren
id|INTR_OFF
comma
id|ioaddr
op_plus
id|LAN_CTRL
)paren
suffix:semicolon
)brace
id|link-&gt;open
op_decrement
suffix:semicolon
r_if
c_cond
(paren
id|link-&gt;state
op_amp
id|DEV_STALE_CONFIG
)paren
id|mod_timer
c_func
(paren
op_amp
id|link-&gt;release
comma
id|jiffies
op_plus
id|HZ
op_div
l_int|20
)paren
suffix:semicolon
id|MOD_DEC_USE_COUNT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* fjn_close */
multiline_comment|/*====================================================================*/
DECL|function|fjn_get_stats
r_static
r_struct
id|net_device_stats
op_star
id|fjn_get_stats
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
id|local_info_t
op_star
id|lp
op_assign
(paren
id|local_info_t
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_return
op_amp
id|lp-&gt;stats
suffix:semicolon
)brace
multiline_comment|/* fjn_get_stats */
multiline_comment|/*====================================================================*/
multiline_comment|/*&n;  Set the multicast/promiscuous mode for this adaptor.&n;*/
multiline_comment|/* The little-endian AUTODIN II ethernet CRC calculation.&n;   N.B. Do not use for bulk data, use a table-based routine instead.&n;   This is common code and should be moved to net/core/crc.c */
DECL|variable|ethernet_polynomial_le
r_static
r_int
r_const
id|ethernet_polynomial_le
op_assign
l_int|0xedb88320U
suffix:semicolon
DECL|function|ether_crc_le
r_static
r_inline
r_int
id|ether_crc_le
c_func
(paren
r_int
id|length
comma
r_int
r_char
op_star
id|data
)paren
(brace
r_int
r_int
id|crc
op_assign
l_int|0xffffffff
suffix:semicolon
multiline_comment|/* Initial value. */
r_while
c_loop
(paren
op_decrement
id|length
op_ge
l_int|0
)paren
(brace
r_int
r_char
id|current_octet
op_assign
op_star
id|data
op_increment
suffix:semicolon
r_int
id|bit
suffix:semicolon
r_for
c_loop
(paren
id|bit
op_assign
l_int|8
suffix:semicolon
op_decrement
id|bit
op_ge
l_int|0
suffix:semicolon
id|current_octet
op_rshift_assign
l_int|1
)paren
(brace
r_if
c_cond
(paren
(paren
id|crc
op_xor
id|current_octet
)paren
op_amp
l_int|1
)paren
(brace
id|crc
op_rshift_assign
l_int|1
suffix:semicolon
id|crc
op_xor_assign
id|ethernet_polynomial_le
suffix:semicolon
)brace
r_else
id|crc
op_rshift_assign
l_int|1
suffix:semicolon
)brace
)brace
r_return
id|crc
suffix:semicolon
)brace
DECL|function|set_rx_mode
r_static
r_void
id|set_rx_mode
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
id|ioaddr_t
id|ioaddr
op_assign
id|dev-&gt;base_addr
suffix:semicolon
r_struct
id|local_info_t
op_star
id|lp
op_assign
(paren
r_struct
id|local_info_t
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_int
r_char
id|mc_filter
(braket
l_int|8
)braket
suffix:semicolon
multiline_comment|/* Multicast hash filter */
r_int
id|flags
suffix:semicolon
r_int
id|i
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;flags
op_amp
id|IFF_PROMISC
)paren
(brace
multiline_comment|/* Unconditionally log net taps. */
id|printk
c_func
(paren
l_string|&quot;%s: Promiscuous mode enabled.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|memset
c_func
(paren
id|mc_filter
comma
l_int|0xff
comma
r_sizeof
(paren
id|mc_filter
)paren
)paren
suffix:semicolon
id|outb
c_func
(paren
l_int|3
comma
id|ioaddr
op_plus
id|RX_MODE
)paren
suffix:semicolon
multiline_comment|/* Enable promiscuous mode */
)brace
r_else
r_if
c_cond
(paren
id|dev-&gt;mc_count
OG
id|MC_FILTERBREAK
op_logical_or
(paren
id|dev-&gt;flags
op_amp
id|IFF_ALLMULTI
)paren
)paren
(brace
multiline_comment|/* Too many to filter perfectly -- accept all multicasts. */
id|memset
c_func
(paren
id|mc_filter
comma
l_int|0xff
comma
r_sizeof
(paren
id|mc_filter
)paren
)paren
suffix:semicolon
id|outb
c_func
(paren
l_int|2
comma
id|ioaddr
op_plus
id|RX_MODE
)paren
suffix:semicolon
multiline_comment|/* Use normal mode. */
)brace
r_else
r_if
c_cond
(paren
id|dev-&gt;mc_count
op_eq
l_int|0
)paren
(brace
id|memset
c_func
(paren
id|mc_filter
comma
l_int|0x00
comma
r_sizeof
(paren
id|mc_filter
)paren
)paren
suffix:semicolon
id|outb
c_func
(paren
l_int|1
comma
id|ioaddr
op_plus
id|RX_MODE
)paren
suffix:semicolon
multiline_comment|/* Ignore almost all multicasts. */
)brace
r_else
(brace
r_struct
id|dev_mc_list
op_star
id|mclist
suffix:semicolon
r_int
id|i
suffix:semicolon
id|memset
c_func
(paren
id|mc_filter
comma
l_int|0
comma
r_sizeof
(paren
id|mc_filter
)paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
comma
id|mclist
op_assign
id|dev-&gt;mc_list
suffix:semicolon
id|mclist
op_logical_and
id|i
OL
id|dev-&gt;mc_count
suffix:semicolon
id|i
op_increment
comma
id|mclist
op_assign
id|mclist-&gt;next
)paren
id|set_bit
c_func
(paren
id|ether_crc_le
c_func
(paren
id|ETH_ALEN
comma
id|mclist-&gt;dmi_addr
)paren
op_amp
l_int|0x3f
comma
id|mc_filter
)paren
suffix:semicolon
)brace
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|memcmp
c_func
(paren
id|mc_filter
comma
id|lp-&gt;mc_filter
comma
r_sizeof
(paren
id|mc_filter
)paren
)paren
)paren
(brace
r_int
id|saved_bank
op_assign
id|inb
c_func
(paren
id|ioaddr
op_plus
id|CONFIG_1
)paren
suffix:semicolon
multiline_comment|/* Switch to bank 1 and set the multicast table. */
id|outb
c_func
(paren
l_int|0xe4
comma
id|ioaddr
op_plus
id|CONFIG_1
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|8
suffix:semicolon
id|i
op_increment
)paren
id|outb
c_func
(paren
id|mc_filter
(braket
id|i
)braket
comma
id|ioaddr
op_plus
l_int|8
op_plus
id|i
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|lp-&gt;mc_filter
comma
id|mc_filter
comma
r_sizeof
(paren
id|mc_filter
)paren
)paren
suffix:semicolon
id|outb
c_func
(paren
id|saved_bank
comma
id|ioaddr
op_plus
id|CONFIG_1
)paren
suffix:semicolon
)brace
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
eof
