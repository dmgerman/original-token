multiline_comment|/*======================================================================&n;&n;    A PCMCIA ethernet driver for NS8390-based cards&n;&n;    This driver supports the D-Link DE-650 and Linksys EthernetCard&n;    cards, the newer D-Link and Linksys combo cards, Accton EN2212&n;    cards, the RPTI EP400, and the PreMax PE-200 in non-shared-memory&n;    mode, and the IBM Credit Card Adapter, the NE4100, the Thomas&n;    Conrad ethernet card, and the Kingston KNE-PCM/x in shared-memory&n;    mode.  It will also handle the Socket EA card in either mode.&n;&n;    Copyright (C) 1999 David A. Hinds -- dahinds@users.sourceforge.net&n;&n;    pcnet_cs.c 1.126 2000/10/02 20:38:23&n;    &n;    The network driver code is based on Donald Becker&squot;s NE2000 code:&n;&n;    Written 1992,1993 by Donald Becker.&n;    Copyright 1993 United States Government as represented by the&n;    Director, National Security Agency.  This software may be used and&n;    distributed according to the terms of the GNU Public License,&n;    incorporated herein by reference.&n;    Donald Becker may be reached at becker@cesdis1.gsfc.nasa.gov&n;&n;    Based also on Keith Moore&squot;s changes to Don Becker&squot;s code, for IBM&n;    CCAE support.  Drivers merged back together, and shared-memory&n;    Socket EA support added, by Ken Raeburn, September 1995.&n;&n;======================================================================*/
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/ptrace.h&gt;
macro_line|#include &lt;linux/malloc.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/timer.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/system.h&gt;
macro_line|#include &lt;linux/netdevice.h&gt;
macro_line|#include &lt;../drivers/net/8390.h&gt;
macro_line|#include &lt;pcmcia/version.h&gt;
macro_line|#include &lt;pcmcia/cs_types.h&gt;
macro_line|#include &lt;pcmcia/cs.h&gt;
macro_line|#include &lt;pcmcia/cistpl.h&gt;
macro_line|#include &lt;pcmcia/ciscode.h&gt;
macro_line|#include &lt;pcmcia/ds.h&gt;
macro_line|#include &lt;pcmcia/cisreg.h&gt;
DECL|macro|PCNET_CMD
mdefine_line|#define PCNET_CMD&t;0x00
DECL|macro|PCNET_DATAPORT
mdefine_line|#define PCNET_DATAPORT&t;0x10&t;/* NatSemi-defined port window offset. */
DECL|macro|PCNET_RESET
mdefine_line|#define PCNET_RESET&t;0x1f&t;/* Issue a read to reset, a write to clear. */
DECL|macro|PCNET_MISC
mdefine_line|#define PCNET_MISC&t;0x18&t;/* For IBM CCAE and Socket EA cards */
DECL|macro|PCNET_START_PG
mdefine_line|#define PCNET_START_PG&t;0x40&t;/* First page of TX buffer */
DECL|macro|PCNET_STOP_PG
mdefine_line|#define PCNET_STOP_PG&t;0x80&t;/* Last page +1 of RX ring */
multiline_comment|/* Socket EA cards have a larger packet buffer */
DECL|macro|SOCKET_START_PG
mdefine_line|#define SOCKET_START_PG&t;0x01
DECL|macro|SOCKET_STOP_PG
mdefine_line|#define SOCKET_STOP_PG&t;0xff
DECL|macro|PCNET_RDC_TIMEOUT
mdefine_line|#define PCNET_RDC_TIMEOUT 0x02&t;/* Max wait in jiffies for Tx RDC */
DECL|variable|if_names
r_static
r_char
op_star
id|if_names
(braket
)braket
op_assign
(brace
l_string|&quot;auto&quot;
comma
l_string|&quot;10baseT&quot;
comma
l_string|&quot;10base2&quot;
)brace
suffix:semicolon
macro_line|#ifdef PCMCIA_DEBUG
DECL|variable|pc_debug
r_static
r_int
id|pc_debug
op_assign
id|PCMCIA_DEBUG
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|pc_debug
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
DECL|macro|DEBUG
mdefine_line|#define DEBUG(n, args...) if (pc_debug&gt;(n)) printk(KERN_DEBUG args)
DECL|variable|version
r_static
r_char
op_star
id|version
op_assign
l_string|&quot;pcnet_cs.c 1.126 2000/10/02 20:38:23 (David Hinds)&quot;
suffix:semicolon
macro_line|#else
DECL|macro|DEBUG
mdefine_line|#define DEBUG(n, args...)
macro_line|#endif
multiline_comment|/*====================================================================*/
multiline_comment|/* Parameters that can be set with &squot;insmod&squot; */
DECL|macro|INT_MODULE_PARM
mdefine_line|#define INT_MODULE_PARM(n, v) static int n = v; MODULE_PARM(n, &quot;i&quot;)
multiline_comment|/* Bit map of interrupts to choose from */
id|INT_MODULE_PARM
c_func
(paren
id|irq_mask
comma
l_int|0xdeb8
)paren
suffix:semicolon
DECL|variable|irq_list
r_static
r_int
id|irq_list
(braket
l_int|4
)braket
op_assign
(brace
op_minus
l_int|1
)brace
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|irq_list
comma
l_string|&quot;1-4i&quot;
)paren
suffix:semicolon
id|INT_MODULE_PARM
c_func
(paren
id|if_port
comma
l_int|1
)paren
suffix:semicolon
multiline_comment|/* Transceiver type */
id|INT_MODULE_PARM
c_func
(paren
id|use_big_buf
comma
l_int|1
)paren
suffix:semicolon
multiline_comment|/* use 64K packet buffer? */
id|INT_MODULE_PARM
c_func
(paren
id|mem_speed
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* shared mem speed, in ns */
id|INT_MODULE_PARM
c_func
(paren
id|delay_output
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* pause after xmit? */
id|INT_MODULE_PARM
c_func
(paren
id|delay_time
comma
l_int|4
)paren
suffix:semicolon
multiline_comment|/* in usec */
id|INT_MODULE_PARM
c_func
(paren
id|use_shmem
comma
op_minus
l_int|1
)paren
suffix:semicolon
multiline_comment|/* use shared memory? */
multiline_comment|/* Ugh!  Let the user hardwire the hardware address for queer cards */
DECL|variable|hw_addr
r_static
r_int
id|hw_addr
(braket
l_int|6
)braket
op_assign
(brace
l_int|0
comma
multiline_comment|/* ... */
)brace
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|hw_addr
comma
l_string|&quot;6i&quot;
)paren
suffix:semicolon
multiline_comment|/*====================================================================*/
r_static
r_void
id|pcnet_config
c_func
(paren
id|dev_link_t
op_star
id|link
)paren
suffix:semicolon
r_static
r_void
id|pcnet_release
c_func
(paren
id|u_long
id|arg
)paren
suffix:semicolon
r_static
r_int
id|pcnet_event
c_func
(paren
id|event_t
id|event
comma
r_int
id|priority
comma
id|event_callback_args_t
op_star
id|args
)paren
suffix:semicolon
r_static
r_int
id|pcnet_open
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_int
id|pcnet_close
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_int
id|do_ioctl
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_struct
id|ifreq
op_star
id|rq
comma
r_int
id|cmd
)paren
suffix:semicolon
r_static
r_void
id|ei_irq_wrapper
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
suffix:semicolon
r_static
r_void
id|ei_watchdog
c_func
(paren
id|u_long
id|arg
)paren
suffix:semicolon
r_static
r_void
id|pcnet_reset_8390
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_int
id|set_config
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_struct
id|ifmap
op_star
id|map
)paren
suffix:semicolon
r_static
r_int
id|setup_shmem_window
c_func
(paren
id|dev_link_t
op_star
id|link
comma
r_int
id|start_pg
comma
r_int
id|stop_pg
comma
r_int
id|cm_offset
)paren
suffix:semicolon
r_static
r_int
id|setup_dma_config
c_func
(paren
id|dev_link_t
op_star
id|link
comma
r_int
id|start_pg
comma
r_int
id|stop_pg
)paren
suffix:semicolon
r_static
id|dev_link_t
op_star
id|pcnet_attach
c_func
(paren
r_void
)paren
suffix:semicolon
r_static
r_void
id|pcnet_detach
c_func
(paren
id|dev_link_t
op_star
)paren
suffix:semicolon
DECL|variable|dev_info
r_static
id|dev_info_t
id|dev_info
op_assign
l_string|&quot;pcnet_cs&quot;
suffix:semicolon
DECL|variable|dev_list
r_static
id|dev_link_t
op_star
id|dev_list
suffix:semicolon
multiline_comment|/*====================================================================*/
DECL|struct|hw_info_t
r_typedef
r_struct
id|hw_info_t
(brace
DECL|member|offset
id|u_int
id|offset
suffix:semicolon
DECL|member|a0
DECL|member|a1
DECL|member|a2
id|u_char
id|a0
comma
id|a1
comma
id|a2
suffix:semicolon
DECL|member|flags
id|u_int
id|flags
suffix:semicolon
DECL|typedef|hw_info_t
)brace
id|hw_info_t
suffix:semicolon
DECL|macro|DELAY_OUTPUT
mdefine_line|#define DELAY_OUTPUT&t;0x01
DECL|macro|HAS_MISC_REG
mdefine_line|#define HAS_MISC_REG&t;0x02
DECL|macro|USE_BIG_BUF
mdefine_line|#define USE_BIG_BUF&t;0x04
DECL|macro|HAS_IBM_MISC
mdefine_line|#define HAS_IBM_MISC&t;0x08
DECL|macro|IS_DL10019
mdefine_line|#define IS_DL10019&t;0x10
DECL|macro|IS_DL10022
mdefine_line|#define IS_DL10022&t;0x20
DECL|macro|IS_AX88190
mdefine_line|#define IS_AX88190&t;0x40
DECL|macro|USE_SHMEM
mdefine_line|#define USE_SHMEM&t;0x80&t;/* autodetected */
DECL|variable|hw_info
r_static
id|hw_info_t
id|hw_info
(braket
)braket
op_assign
(brace
(brace
multiline_comment|/* Accton EN2212 */
l_int|0x0ff0
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0xe8
comma
id|DELAY_OUTPUT
)brace
comma
(brace
multiline_comment|/* Allied Telesis LA-PCM */
l_int|0x0ff0
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0xf4
comma
l_int|0
)brace
comma
(brace
multiline_comment|/* APEX MultiCard */
l_int|0x03f4
comma
l_int|0x00
comma
l_int|0x20
comma
l_int|0xe5
comma
l_int|0
)brace
comma
(brace
multiline_comment|/* ASANTE FriendlyNet */
l_int|0x4910
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x94
comma
id|DELAY_OUTPUT
op_or
id|HAS_IBM_MISC
)brace
comma
(brace
multiline_comment|/* Danpex EN-6200P2 */
l_int|0x0110
comma
l_int|0x00
comma
l_int|0x40
comma
l_int|0xc7
comma
l_int|0
)brace
comma
(brace
multiline_comment|/* DataTrek NetCard */
l_int|0x0ff0
comma
l_int|0x00
comma
l_int|0x20
comma
l_int|0xe8
comma
l_int|0
)brace
comma
(brace
multiline_comment|/* Dayna CommuniCard E */
l_int|0x0110
comma
l_int|0x00
comma
l_int|0x80
comma
l_int|0x19
comma
l_int|0
)brace
comma
(brace
multiline_comment|/* D-Link DE-650 */
l_int|0x0040
comma
l_int|0x00
comma
l_int|0x80
comma
l_int|0xc8
comma
l_int|0
)brace
comma
(brace
multiline_comment|/* EP-210 Ethernet */
l_int|0x0110
comma
l_int|0x00
comma
l_int|0x40
comma
l_int|0x33
comma
l_int|0
)brace
comma
(brace
multiline_comment|/* EP4000 Ethernet */
l_int|0x01c0
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0xb4
comma
l_int|0
)brace
comma
(brace
multiline_comment|/* Epson EEN10B */
l_int|0x0ff0
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x48
comma
id|HAS_MISC_REG
op_or
id|HAS_IBM_MISC
)brace
comma
(brace
multiline_comment|/* ELECOM Laneed LD-CDWA */
l_int|0xb8
comma
l_int|0x08
comma
l_int|0x00
comma
l_int|0x42
comma
l_int|0
)brace
comma
(brace
multiline_comment|/* Hypertec Ethernet */
l_int|0x01c0
comma
l_int|0x00
comma
l_int|0x40
comma
l_int|0x4c
comma
l_int|0
)brace
comma
(brace
multiline_comment|/* IBM CCAE */
l_int|0x0ff0
comma
l_int|0x08
comma
l_int|0x00
comma
l_int|0x5a
comma
id|HAS_MISC_REG
op_or
id|HAS_IBM_MISC
)brace
comma
(brace
multiline_comment|/* IBM CCAE */
l_int|0x0ff0
comma
l_int|0x00
comma
l_int|0x04
comma
l_int|0xac
comma
id|HAS_MISC_REG
op_or
id|HAS_IBM_MISC
)brace
comma
(brace
multiline_comment|/* IBM CCAE */
l_int|0x0ff0
comma
l_int|0x00
comma
l_int|0x06
comma
l_int|0x29
comma
id|HAS_MISC_REG
op_or
id|HAS_IBM_MISC
)brace
comma
(brace
multiline_comment|/* IBM FME */
l_int|0x0374
comma
l_int|0x08
comma
l_int|0x00
comma
l_int|0x5a
comma
id|HAS_MISC_REG
op_or
id|HAS_IBM_MISC
)brace
comma
(brace
multiline_comment|/* IBM FME */
l_int|0x0374
comma
l_int|0x00
comma
l_int|0x04
comma
l_int|0xac
comma
id|HAS_MISC_REG
op_or
id|HAS_IBM_MISC
)brace
comma
(brace
multiline_comment|/* Kansai KLA-PCM/T */
l_int|0x0ff0
comma
l_int|0x00
comma
l_int|0x60
comma
l_int|0x87
comma
id|HAS_MISC_REG
op_or
id|HAS_IBM_MISC
)brace
comma
(brace
multiline_comment|/* NSC DP83903 */
l_int|0x0374
comma
l_int|0x08
comma
l_int|0x00
comma
l_int|0x17
comma
id|HAS_MISC_REG
op_or
id|HAS_IBM_MISC
)brace
comma
(brace
multiline_comment|/* NSC DP83903 */
l_int|0x0374
comma
l_int|0x00
comma
l_int|0xc0
comma
l_int|0xa8
comma
id|HAS_MISC_REG
op_or
id|HAS_IBM_MISC
)brace
comma
(brace
multiline_comment|/* NSC DP83903 */
l_int|0x0374
comma
l_int|0x00
comma
l_int|0xa0
comma
l_int|0xb0
comma
id|HAS_MISC_REG
op_or
id|HAS_IBM_MISC
)brace
comma
(brace
multiline_comment|/* NSC DP83903 */
l_int|0x0198
comma
l_int|0x00
comma
l_int|0x20
comma
l_int|0xe0
comma
id|HAS_MISC_REG
op_or
id|HAS_IBM_MISC
)brace
comma
(brace
multiline_comment|/* I-O DATA PCLA/T */
l_int|0x0ff0
comma
l_int|0x00
comma
l_int|0xa0
comma
l_int|0xb0
comma
l_int|0
)brace
comma
(brace
multiline_comment|/* Katron PE-520 */
l_int|0x0110
comma
l_int|0x00
comma
l_int|0x40
comma
l_int|0xf6
comma
l_int|0
)brace
comma
(brace
multiline_comment|/* Kingston KNE-PCM/x */
l_int|0x0ff0
comma
l_int|0x00
comma
l_int|0xc0
comma
l_int|0xf0
comma
id|HAS_MISC_REG
op_or
id|HAS_IBM_MISC
)brace
comma
(brace
multiline_comment|/* Kingston KNE-PCM/x */
l_int|0x0ff0
comma
l_int|0xe2
comma
l_int|0x0c
comma
l_int|0x0f
comma
id|HAS_MISC_REG
op_or
id|HAS_IBM_MISC
)brace
comma
(brace
multiline_comment|/* Kingston KNE-PC2 */
l_int|0x0180
comma
l_int|0x00
comma
l_int|0xc0
comma
l_int|0xf0
comma
l_int|0
)brace
comma
(brace
multiline_comment|/* Maxtech PCN2000 */
l_int|0x5000
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0xe8
comma
l_int|0
)brace
comma
(brace
multiline_comment|/* NDC Instant-Link */
l_int|0x003a
comma
l_int|0x00
comma
l_int|0x80
comma
l_int|0xc6
comma
l_int|0
)brace
comma
(brace
multiline_comment|/* NE2000 Compatible */
l_int|0x0ff0
comma
l_int|0x00
comma
l_int|0xa0
comma
l_int|0x0c
comma
l_int|0
)brace
comma
(brace
multiline_comment|/* Network General Sniffer */
l_int|0x0ff0
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x65
comma
id|HAS_MISC_REG
op_or
id|HAS_IBM_MISC
)brace
comma
(brace
multiline_comment|/* Panasonic VEL211 */
l_int|0x0ff0
comma
l_int|0x00
comma
l_int|0x80
comma
l_int|0x45
comma
id|HAS_MISC_REG
op_or
id|HAS_IBM_MISC
)brace
comma
(brace
multiline_comment|/* PreMax PE-200 */
l_int|0x07f0
comma
l_int|0x00
comma
l_int|0x20
comma
l_int|0xe0
comma
l_int|0
)brace
comma
(brace
multiline_comment|/* RPTI EP400 */
l_int|0x0110
comma
l_int|0x00
comma
l_int|0x40
comma
l_int|0x95
comma
l_int|0
)brace
comma
(brace
multiline_comment|/* SCM Ethernet */
l_int|0x0ff0
comma
l_int|0x00
comma
l_int|0x20
comma
l_int|0xcb
comma
l_int|0
)brace
comma
(brace
multiline_comment|/* Socket EA */
l_int|0x4000
comma
l_int|0x00
comma
l_int|0xc0
comma
l_int|0x1b
comma
id|DELAY_OUTPUT
op_or
id|HAS_MISC_REG
op_or
id|USE_BIG_BUF
)brace
comma
(brace
multiline_comment|/* SuperSocket RE450T */
l_int|0x0110
comma
l_int|0x00
comma
l_int|0xe0
comma
l_int|0x98
comma
l_int|0
)brace
comma
(brace
multiline_comment|/* Volktek NPL-402CT */
l_int|0x0060
comma
l_int|0x00
comma
l_int|0x40
comma
l_int|0x05
comma
l_int|0
)brace
comma
(brace
multiline_comment|/* NEC PC-9801N-J12 */
l_int|0x0ff0
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x4c
comma
l_int|0
)brace
comma
(brace
multiline_comment|/* PCMCIA Technology OEM */
l_int|0x01c8
comma
l_int|0x00
comma
l_int|0xa0
comma
l_int|0x0c
comma
l_int|0
)brace
)brace
suffix:semicolon
DECL|macro|NR_INFO
mdefine_line|#define NR_INFO&t;&t;(sizeof(hw_info)/sizeof(hw_info_t))
DECL|variable|default_info
r_static
id|hw_info_t
id|default_info
op_assign
(brace
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
)brace
suffix:semicolon
DECL|variable|dl10019_info
r_static
id|hw_info_t
id|dl10019_info
op_assign
(brace
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
id|IS_DL10019
)brace
suffix:semicolon
DECL|variable|dl10022_info
r_static
id|hw_info_t
id|dl10022_info
op_assign
(brace
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
id|IS_DL10019
op_or
id|IS_DL10022
)brace
suffix:semicolon
DECL|struct|pcnet_dev_t
r_typedef
r_struct
id|pcnet_dev_t
(brace
DECL|member|dev
r_struct
id|net_device
id|dev
suffix:semicolon
multiline_comment|/* so &amp;dev == &amp;pcnet_dev_t */
DECL|member|link
id|dev_link_t
id|link
suffix:semicolon
DECL|member|node
id|dev_node_t
id|node
suffix:semicolon
DECL|member|flags
id|u_int
id|flags
suffix:semicolon
DECL|member|base
id|caddr_t
id|base
suffix:semicolon
DECL|member|watchdog
r_struct
id|timer_list
id|watchdog
suffix:semicolon
DECL|member|stale
DECL|member|fast_poll
r_int
id|stale
comma
id|fast_poll
suffix:semicolon
DECL|member|link_status
id|u_short
id|link_status
suffix:semicolon
DECL|typedef|pcnet_dev_t
)brace
id|pcnet_dev_t
suffix:semicolon
multiline_comment|/*======================================================================&n;&n;    This bit of code is used to avoid unregistering network devices&n;    at inappropriate times.  2.2 and later kernels are fairly picky&n;    about when this can happen.&n;    &n;======================================================================*/
DECL|function|flush_stale_links
r_static
r_void
id|flush_stale_links
c_func
(paren
r_void
)paren
(brace
id|dev_link_t
op_star
id|link
comma
op_star
id|next
suffix:semicolon
r_for
c_loop
(paren
id|link
op_assign
id|dev_list
suffix:semicolon
id|link
suffix:semicolon
id|link
op_assign
id|next
)paren
(brace
id|next
op_assign
id|link-&gt;next
suffix:semicolon
r_if
c_cond
(paren
id|link-&gt;state
op_amp
id|DEV_STALE_LINK
)paren
id|pcnet_detach
c_func
(paren
id|link
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/*====================================================================*/
DECL|function|cs_error
r_static
r_void
id|cs_error
c_func
(paren
id|client_handle_t
id|handle
comma
r_int
id|func
comma
r_int
id|ret
)paren
(brace
id|error_info_t
id|err
op_assign
(brace
id|func
comma
id|ret
)brace
suffix:semicolon
id|CardServices
c_func
(paren
id|ReportError
comma
id|handle
comma
op_amp
id|err
)paren
suffix:semicolon
)brace
multiline_comment|/*======================================================================&n;&n;    We never need to do anything when a pcnet device is &quot;initialized&quot;&n;    by the net software, because we only register already-found cards.&n;&n;======================================================================*/
DECL|function|pcnet_init
r_static
r_int
id|pcnet_init
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*======================================================================&n;&n;    pcnet_attach() creates an &quot;instance&quot; of the driver, allocating&n;    local data structures for one device.  The device is registered&n;    with Card Services.&n;&n;======================================================================*/
DECL|function|pcnet_attach
r_static
id|dev_link_t
op_star
id|pcnet_attach
c_func
(paren
r_void
)paren
(brace
id|pcnet_dev_t
op_star
id|info
suffix:semicolon
id|dev_link_t
op_star
id|link
suffix:semicolon
r_struct
id|net_device
op_star
id|dev
suffix:semicolon
id|client_reg_t
id|client_reg
suffix:semicolon
r_int
id|i
comma
id|ret
suffix:semicolon
id|DEBUG
c_func
(paren
l_int|0
comma
l_string|&quot;pcnet_attach()&bslash;n&quot;
)paren
suffix:semicolon
id|flush_stale_links
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* Create new ethernet device */
id|info
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
op_star
id|info
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|info
)paren
r_return
l_int|NULL
suffix:semicolon
id|memset
c_func
(paren
id|info
comma
l_int|0
comma
r_sizeof
(paren
op_star
id|info
)paren
)paren
suffix:semicolon
id|link
op_assign
op_amp
id|info-&gt;link
suffix:semicolon
id|dev
op_assign
op_amp
id|info-&gt;dev
suffix:semicolon
id|link-&gt;priv
op_assign
id|info
suffix:semicolon
id|link-&gt;release.function
op_assign
op_amp
id|pcnet_release
suffix:semicolon
id|link-&gt;release.data
op_assign
(paren
id|u_long
)paren
id|link
suffix:semicolon
id|link-&gt;irq.Attributes
op_assign
id|IRQ_TYPE_EXCLUSIVE
suffix:semicolon
id|link-&gt;irq.IRQInfo1
op_assign
id|IRQ_INFO2_VALID
op_or
id|IRQ_LEVEL_ID
suffix:semicolon
r_if
c_cond
(paren
id|irq_list
(braket
l_int|0
)braket
op_eq
op_minus
l_int|1
)paren
id|link-&gt;irq.IRQInfo2
op_assign
id|irq_mask
suffix:semicolon
r_else
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|4
suffix:semicolon
id|i
op_increment
)paren
id|link-&gt;irq.IRQInfo2
op_or_assign
l_int|1
op_lshift
id|irq_list
(braket
id|i
)braket
suffix:semicolon
id|link-&gt;conf.Attributes
op_assign
id|CONF_ENABLE_IRQ
suffix:semicolon
id|link-&gt;conf.IntType
op_assign
id|INT_MEMORY_AND_IO
suffix:semicolon
id|ethdev_init
c_func
(paren
id|dev
)paren
suffix:semicolon
id|dev-&gt;init
op_assign
op_amp
id|pcnet_init
suffix:semicolon
id|dev-&gt;open
op_assign
op_amp
id|pcnet_open
suffix:semicolon
id|dev-&gt;stop
op_assign
op_amp
id|pcnet_close
suffix:semicolon
id|dev-&gt;set_config
op_assign
op_amp
id|set_config
suffix:semicolon
multiline_comment|/* Register with Card Services */
id|link-&gt;next
op_assign
id|dev_list
suffix:semicolon
id|dev_list
op_assign
id|link
suffix:semicolon
id|client_reg.dev_info
op_assign
op_amp
id|dev_info
suffix:semicolon
id|client_reg.Attributes
op_assign
id|INFO_IO_CLIENT
op_or
id|INFO_CARD_SHARE
suffix:semicolon
id|client_reg.EventMask
op_assign
id|CS_EVENT_CARD_INSERTION
op_or
id|CS_EVENT_CARD_REMOVAL
op_or
id|CS_EVENT_RESET_PHYSICAL
op_or
id|CS_EVENT_CARD_RESET
op_or
id|CS_EVENT_PM_SUSPEND
op_or
id|CS_EVENT_PM_RESUME
suffix:semicolon
id|client_reg.event_handler
op_assign
op_amp
id|pcnet_event
suffix:semicolon
id|client_reg.Version
op_assign
l_int|0x0210
suffix:semicolon
id|client_reg.event_callback_args.client_data
op_assign
id|link
suffix:semicolon
id|ret
op_assign
id|CardServices
c_func
(paren
id|RegisterClient
comma
op_amp
id|link-&gt;handle
comma
op_amp
id|client_reg
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
op_ne
id|CS_SUCCESS
)paren
(brace
id|cs_error
c_func
(paren
id|link-&gt;handle
comma
id|RegisterClient
comma
id|ret
)paren
suffix:semicolon
id|pcnet_detach
c_func
(paren
id|link
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
r_return
id|link
suffix:semicolon
)brace
multiline_comment|/* pcnet_attach */
multiline_comment|/*======================================================================&n;&n;    This deletes a driver &quot;instance&quot;.  The device is de-registered&n;    with Card Services.  If it has been released, all local data&n;    structures are freed.  Otherwise, the structures will be freed&n;    when the device is released.&n;&n;======================================================================*/
DECL|function|pcnet_detach
r_static
r_void
id|pcnet_detach
c_func
(paren
id|dev_link_t
op_star
id|link
)paren
(brace
id|pcnet_dev_t
op_star
id|info
op_assign
id|link-&gt;priv
suffix:semicolon
id|dev_link_t
op_star
op_star
id|linkp
suffix:semicolon
id|DEBUG
c_func
(paren
l_int|0
comma
l_string|&quot;pcnet_detach(0x%p)&bslash;n&quot;
comma
id|link
)paren
suffix:semicolon
multiline_comment|/* Locate device structure */
r_for
c_loop
(paren
id|linkp
op_assign
op_amp
id|dev_list
suffix:semicolon
op_star
id|linkp
suffix:semicolon
id|linkp
op_assign
op_amp
(paren
op_star
id|linkp
)paren
op_member_access_from_pointer
id|next
)paren
r_if
c_cond
(paren
op_star
id|linkp
op_eq
id|link
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
op_star
id|linkp
op_eq
l_int|NULL
)paren
r_return
suffix:semicolon
id|del_timer
c_func
(paren
op_amp
id|link-&gt;release
)paren
suffix:semicolon
r_if
c_cond
(paren
id|link-&gt;state
op_amp
id|DEV_CONFIG
)paren
(brace
id|pcnet_release
c_func
(paren
(paren
id|u_long
)paren
id|link
)paren
suffix:semicolon
r_if
c_cond
(paren
id|link-&gt;state
op_amp
id|DEV_STALE_CONFIG
)paren
(brace
id|link-&gt;state
op_or_assign
id|DEV_STALE_LINK
suffix:semicolon
r_return
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|link-&gt;handle
)paren
id|CardServices
c_func
(paren
id|DeregisterClient
comma
id|link-&gt;handle
)paren
suffix:semicolon
multiline_comment|/* Unlink device structure, free bits */
op_star
id|linkp
op_assign
id|link-&gt;next
suffix:semicolon
r_if
c_cond
(paren
id|link-&gt;dev
)paren
id|unregister_netdev
c_func
(paren
op_amp
id|info-&gt;dev
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|info
)paren
suffix:semicolon
)brace
multiline_comment|/* pcnet_detach */
multiline_comment|/*======================================================================&n;&n;    This probes for a card&squot;s hardware address, for card types that&n;    encode this information in their CIS.&n;&n;======================================================================*/
DECL|function|get_hwinfo
r_static
id|hw_info_t
op_star
id|get_hwinfo
c_func
(paren
id|dev_link_t
op_star
id|link
)paren
(brace
r_struct
id|net_device
op_star
id|dev
op_assign
id|link-&gt;priv
suffix:semicolon
id|win_req_t
id|req
suffix:semicolon
id|memreq_t
id|mem
suffix:semicolon
id|u_char
op_star
id|base
comma
op_star
id|virt
suffix:semicolon
r_int
id|i
comma
id|j
suffix:semicolon
multiline_comment|/* Allocate a small memory window */
id|req.Attributes
op_assign
id|WIN_DATA_WIDTH_8
op_or
id|WIN_MEMORY_TYPE_AM
op_or
id|WIN_ENABLE
suffix:semicolon
id|req.Base
op_assign
l_int|0
suffix:semicolon
id|req.Size
op_assign
l_int|0
suffix:semicolon
id|req.AccessSpeed
op_assign
l_int|0
suffix:semicolon
id|link-&gt;win
op_assign
(paren
id|window_handle_t
)paren
id|link-&gt;handle
suffix:semicolon
id|i
op_assign
id|CardServices
c_func
(paren
id|RequestWindow
comma
op_amp
id|link-&gt;win
comma
op_amp
id|req
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
op_ne
id|CS_SUCCESS
)paren
(brace
id|cs_error
c_func
(paren
id|link-&gt;handle
comma
id|RequestWindow
comma
id|i
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
id|virt
op_assign
id|ioremap
c_func
(paren
id|req.Base
comma
id|req.Size
)paren
suffix:semicolon
id|mem.Page
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|NR_INFO
suffix:semicolon
id|i
op_increment
)paren
(brace
id|mem.CardOffset
op_assign
id|hw_info
(braket
id|i
)braket
dot
id|offset
op_amp
op_complement
(paren
id|req.Size
op_minus
l_int|1
)paren
suffix:semicolon
id|CardServices
c_func
(paren
id|MapMemPage
comma
id|link-&gt;win
comma
op_amp
id|mem
)paren
suffix:semicolon
id|base
op_assign
op_amp
id|virt
(braket
id|hw_info
(braket
id|i
)braket
dot
id|offset
op_amp
(paren
id|req.Size
op_minus
l_int|1
)paren
)braket
suffix:semicolon
r_if
c_cond
(paren
(paren
id|readb
c_func
(paren
id|base
op_plus
l_int|0
)paren
op_eq
id|hw_info
(braket
id|i
)braket
dot
id|a0
)paren
op_logical_and
(paren
id|readb
c_func
(paren
id|base
op_plus
l_int|2
)paren
op_eq
id|hw_info
(braket
id|i
)braket
dot
id|a1
)paren
op_logical_and
(paren
id|readb
c_func
(paren
id|base
op_plus
l_int|4
)paren
op_eq
id|hw_info
(braket
id|i
)braket
dot
id|a2
)paren
)paren
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|i
OL
id|NR_INFO
)paren
(brace
r_for
c_loop
(paren
id|j
op_assign
l_int|0
suffix:semicolon
id|j
OL
l_int|6
suffix:semicolon
id|j
op_increment
)paren
id|dev-&gt;dev_addr
(braket
id|j
)braket
op_assign
id|readb
c_func
(paren
id|base
op_plus
(paren
id|j
op_lshift
l_int|1
)paren
)paren
suffix:semicolon
)brace
id|iounmap
c_func
(paren
id|virt
)paren
suffix:semicolon
id|j
op_assign
id|CardServices
c_func
(paren
id|ReleaseWindow
comma
id|link-&gt;win
)paren
suffix:semicolon
r_if
c_cond
(paren
id|j
op_ne
id|CS_SUCCESS
)paren
id|cs_error
c_func
(paren
id|link-&gt;handle
comma
id|ReleaseWindow
comma
id|j
)paren
suffix:semicolon
r_return
(paren
id|i
OL
id|NR_INFO
)paren
ques
c_cond
id|hw_info
op_plus
id|i
suffix:colon
l_int|NULL
suffix:semicolon
)brace
multiline_comment|/* get_hwinfo */
multiline_comment|/*======================================================================&n;&n;    This probes for a card&squot;s hardware address by reading the PROM.&n;    It checks the address against a list of known types, then falls&n;    back to a simple NE2000 clone signature check.&n;&n;======================================================================*/
DECL|function|get_prom
r_static
id|hw_info_t
op_star
id|get_prom
c_func
(paren
id|dev_link_t
op_star
id|link
)paren
(brace
r_struct
id|net_device
op_star
id|dev
op_assign
id|link-&gt;priv
suffix:semicolon
id|ioaddr_t
id|ioaddr
op_assign
id|dev-&gt;base_addr
suffix:semicolon
id|u_char
id|prom
(braket
l_int|32
)braket
suffix:semicolon
r_int
id|i
comma
id|j
suffix:semicolon
multiline_comment|/* This is lifted straight from drivers/net/ne.c */
r_struct
(brace
id|u_char
id|value
comma
id|offset
suffix:semicolon
)brace
id|program_seq
(braket
)braket
op_assign
(brace
(brace
id|E8390_NODMA
op_plus
id|E8390_PAGE0
op_plus
id|E8390_STOP
comma
id|E8390_CMD
)brace
comma
multiline_comment|/* Select page 0*/
(brace
l_int|0x48
comma
id|EN0_DCFG
)brace
comma
multiline_comment|/* Set byte-wide (0x48) access. */
(brace
l_int|0x00
comma
id|EN0_RCNTLO
)brace
comma
multiline_comment|/* Clear the count regs. */
(brace
l_int|0x00
comma
id|EN0_RCNTHI
)brace
comma
(brace
l_int|0x00
comma
id|EN0_IMR
)brace
comma
multiline_comment|/* Mask completion irq. */
(brace
l_int|0xFF
comma
id|EN0_ISR
)brace
comma
(brace
id|E8390_RXOFF
comma
id|EN0_RXCR
)brace
comma
multiline_comment|/* 0x20  Set to monitor */
(brace
id|E8390_TXOFF
comma
id|EN0_TXCR
)brace
comma
multiline_comment|/* 0x02  and loopback mode. */
(brace
l_int|32
comma
id|EN0_RCNTLO
)brace
comma
(brace
l_int|0x00
comma
id|EN0_RCNTHI
)brace
comma
(brace
l_int|0x00
comma
id|EN0_RSARLO
)brace
comma
multiline_comment|/* DMA starting at 0x0000. */
(brace
l_int|0x00
comma
id|EN0_RSARHI
)brace
comma
(brace
id|E8390_RREAD
op_plus
id|E8390_START
comma
id|E8390_CMD
)brace
comma
)brace
suffix:semicolon
id|pcnet_reset_8390
c_func
(paren
id|dev
)paren
suffix:semicolon
id|mdelay
c_func
(paren
l_int|10
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
r_sizeof
(paren
id|program_seq
)paren
op_div
r_sizeof
(paren
id|program_seq
(braket
l_int|0
)braket
)paren
suffix:semicolon
id|i
op_increment
)paren
id|outb_p
c_func
(paren
id|program_seq
(braket
id|i
)braket
dot
id|value
comma
id|ioaddr
op_plus
id|program_seq
(braket
id|i
)braket
dot
id|offset
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|32
suffix:semicolon
id|i
op_increment
)paren
id|prom
(braket
id|i
)braket
op_assign
id|inb
c_func
(paren
id|ioaddr
op_plus
id|PCNET_DATAPORT
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|NR_INFO
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
(paren
id|prom
(braket
l_int|0
)braket
op_eq
id|hw_info
(braket
id|i
)braket
dot
id|a0
)paren
op_logical_and
(paren
id|prom
(braket
l_int|2
)braket
op_eq
id|hw_info
(braket
id|i
)braket
dot
id|a1
)paren
op_logical_and
(paren
id|prom
(braket
l_int|4
)braket
op_eq
id|hw_info
(braket
id|i
)braket
dot
id|a2
)paren
)paren
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|i
OL
id|NR_INFO
)paren
op_logical_or
(paren
(paren
id|prom
(braket
l_int|28
)braket
op_eq
l_int|0x57
)paren
op_logical_and
(paren
id|prom
(braket
l_int|30
)braket
op_eq
l_int|0x57
)paren
)paren
)paren
(brace
r_for
c_loop
(paren
id|j
op_assign
l_int|0
suffix:semicolon
id|j
OL
l_int|6
suffix:semicolon
id|j
op_increment
)paren
id|dev-&gt;dev_addr
(braket
id|j
)braket
op_assign
id|prom
(braket
id|j
op_lshift
l_int|1
)braket
suffix:semicolon
r_return
(paren
id|i
OL
id|NR_INFO
)paren
ques
c_cond
id|hw_info
op_plus
id|i
suffix:colon
op_amp
id|default_info
suffix:semicolon
)brace
r_return
l_int|NULL
suffix:semicolon
)brace
multiline_comment|/* get_prom */
multiline_comment|/*======================================================================&n;&n;    For DL10019 based cards, like the Linksys EtherFast&n;&n;======================================================================*/
DECL|function|get_dl10019
r_static
id|hw_info_t
op_star
id|get_dl10019
c_func
(paren
id|dev_link_t
op_star
id|link
)paren
(brace
r_struct
id|net_device
op_star
id|dev
op_assign
id|link-&gt;priv
suffix:semicolon
r_int
id|i
suffix:semicolon
id|u_char
id|sum
suffix:semicolon
r_for
c_loop
(paren
id|sum
op_assign
l_int|0
comma
id|i
op_assign
l_int|0x14
suffix:semicolon
id|i
OL
l_int|0x1c
suffix:semicolon
id|i
op_increment
)paren
id|sum
op_add_assign
id|inb_p
c_func
(paren
id|dev-&gt;base_addr
op_plus
id|i
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sum
op_ne
l_int|0xff
)paren
r_return
l_int|NULL
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|6
suffix:semicolon
id|i
op_increment
)paren
id|dev-&gt;dev_addr
(braket
id|i
)braket
op_assign
id|inb_p
c_func
(paren
id|dev-&gt;base_addr
op_plus
l_int|0x14
op_plus
id|i
)paren
suffix:semicolon
id|i
op_assign
id|inb
c_func
(paren
id|dev-&gt;base_addr
op_plus
l_int|0x1f
)paren
suffix:semicolon
r_return
(paren
(paren
id|i
op_eq
l_int|0x91
)paren
op_logical_or
(paren
id|i
op_eq
l_int|0x99
)paren
)paren
ques
c_cond
op_amp
id|dl10022_info
suffix:colon
op_amp
id|dl10019_info
suffix:semicolon
)brace
multiline_comment|/*======================================================================&n;&n;    For Asix AX88190 based cards&n;&n;======================================================================*/
DECL|function|get_ax88190
r_static
id|hw_info_t
op_star
id|get_ax88190
c_func
(paren
id|dev_link_t
op_star
id|link
)paren
(brace
r_struct
id|net_device
op_star
id|dev
op_assign
id|link-&gt;priv
suffix:semicolon
id|ioaddr_t
id|ioaddr
op_assign
id|dev-&gt;base_addr
suffix:semicolon
r_int
id|i
comma
id|j
suffix:semicolon
multiline_comment|/* Not much of a test, but the alternatives are messy */
r_if
c_cond
(paren
id|link-&gt;conf.ConfigBase
op_ne
l_int|0x03c0
)paren
r_return
l_int|NULL
suffix:semicolon
id|outb_p
c_func
(paren
l_int|0x01
comma
id|EN0_DCFG
)paren
suffix:semicolon
multiline_comment|/* Set word-wide access. */
id|outb_p
c_func
(paren
l_int|0x00
comma
id|EN0_RSARLO
)paren
suffix:semicolon
multiline_comment|/* DMA starting at 0x0400. */
id|outb_p
c_func
(paren
l_int|0x04
comma
id|EN0_RSARHI
)paren
suffix:semicolon
id|outb_p
c_func
(paren
id|E8390_RREAD
op_plus
id|E8390_START
comma
id|E8390_CMD
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|6
suffix:semicolon
id|i
op_add_assign
l_int|2
)paren
(brace
id|j
op_assign
id|inw
c_func
(paren
id|ioaddr
op_plus
id|PCNET_DATAPORT
)paren
suffix:semicolon
id|dev-&gt;dev_addr
(braket
id|i
)braket
op_assign
id|j
op_amp
l_int|0xff
suffix:semicolon
id|dev-&gt;dev_addr
(braket
id|i
op_plus
l_int|1
)braket
op_assign
id|j
op_rshift
l_int|8
suffix:semicolon
)brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;pcnet_cs: sorry, the AX88190 chipset is not &quot;
l_string|&quot;supported.&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
multiline_comment|/*======================================================================&n;&n;    This should be totally unnecessary... but when we can&squot;t figure&n;    out the hardware address any other way, we&squot;ll let the user hard&n;    wire it when the module is initialized.&n;&n;======================================================================*/
DECL|function|get_hwired
r_static
id|hw_info_t
op_star
id|get_hwired
c_func
(paren
id|dev_link_t
op_star
id|link
)paren
(brace
r_struct
id|net_device
op_star
id|dev
op_assign
id|link-&gt;priv
suffix:semicolon
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|6
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
id|hw_addr
(braket
id|i
)braket
op_ne
l_int|0
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
id|i
op_eq
l_int|6
)paren
r_return
l_int|NULL
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|6
suffix:semicolon
id|i
op_increment
)paren
id|dev-&gt;dev_addr
(braket
id|i
)braket
op_assign
id|hw_addr
(braket
id|i
)braket
suffix:semicolon
r_return
op_amp
id|default_info
suffix:semicolon
)brace
multiline_comment|/* get_hwired */
multiline_comment|/*======================================================================&n;&n;    pcnet_config() is scheduled to run after a CARD_INSERTION event&n;    is received, to configure the PCMCIA socket, and to make the&n;    ethernet device available to the system.&n;&n;======================================================================*/
DECL|macro|CS_CHECK
mdefine_line|#define CS_CHECK(fn, args...) &bslash;&n;while ((last_ret=CardServices(last_fn=(fn), args))!=0) goto cs_failed
DECL|macro|CFG_CHECK
mdefine_line|#define CFG_CHECK(fn, args...) &bslash;&n;if (CardServices(fn, args) != 0) goto next_entry
DECL|function|try_io_port
r_static
r_int
id|try_io_port
c_func
(paren
id|dev_link_t
op_star
id|link
)paren
(brace
r_int
id|j
comma
id|ret
suffix:semicolon
r_if
c_cond
(paren
id|link-&gt;io.NumPorts1
op_eq
l_int|32
)paren
(brace
id|link-&gt;io.Attributes1
op_assign
id|IO_DATA_PATH_WIDTH_AUTO
suffix:semicolon
r_if
c_cond
(paren
id|link-&gt;io.NumPorts2
OG
l_int|0
)paren
(brace
multiline_comment|/* for master/slave multifunction cards */
id|link-&gt;io.Attributes2
op_assign
id|IO_DATA_PATH_WIDTH_8
suffix:semicolon
id|link-&gt;irq.Attributes
op_assign
id|IRQ_TYPE_DYNAMIC_SHARING
op_or
id|IRQ_FIRST_SHARED
suffix:semicolon
)brace
)brace
r_else
(brace
multiline_comment|/* This should be two 16-port windows */
id|link-&gt;io.Attributes1
op_assign
id|IO_DATA_PATH_WIDTH_8
suffix:semicolon
id|link-&gt;io.Attributes2
op_assign
id|IO_DATA_PATH_WIDTH_16
suffix:semicolon
)brace
r_if
c_cond
(paren
id|link-&gt;io.BasePort1
op_eq
l_int|0
)paren
(brace
id|link-&gt;io.IOAddrLines
op_assign
l_int|16
suffix:semicolon
r_for
c_loop
(paren
id|j
op_assign
l_int|0
suffix:semicolon
id|j
OL
l_int|0x400
suffix:semicolon
id|j
op_add_assign
l_int|0x20
)paren
(brace
id|link-&gt;io.BasePort1
op_assign
id|j
op_xor
l_int|0x300
suffix:semicolon
id|link-&gt;io.BasePort2
op_assign
(paren
id|j
op_xor
l_int|0x300
)paren
op_plus
l_int|0x10
suffix:semicolon
id|ret
op_assign
id|CardServices
c_func
(paren
id|RequestIO
comma
id|link-&gt;handle
comma
op_amp
id|link-&gt;io
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
op_eq
id|CS_SUCCESS
)paren
r_return
id|ret
suffix:semicolon
)brace
r_return
id|ret
suffix:semicolon
)brace
r_else
(brace
r_return
id|CardServices
c_func
(paren
id|RequestIO
comma
id|link-&gt;handle
comma
op_amp
id|link-&gt;io
)paren
suffix:semicolon
)brace
)brace
DECL|function|pcnet_config
r_static
r_void
id|pcnet_config
c_func
(paren
id|dev_link_t
op_star
id|link
)paren
(brace
id|client_handle_t
id|handle
op_assign
id|link-&gt;handle
suffix:semicolon
id|pcnet_dev_t
op_star
id|info
op_assign
id|link-&gt;priv
suffix:semicolon
r_struct
id|net_device
op_star
id|dev
op_assign
op_amp
id|info-&gt;dev
suffix:semicolon
id|tuple_t
id|tuple
suffix:semicolon
id|cisparse_t
id|parse
suffix:semicolon
r_int
id|i
comma
id|last_ret
comma
id|last_fn
comma
id|start_pg
comma
id|stop_pg
comma
id|cm_offset
suffix:semicolon
r_int
id|manfid
op_assign
l_int|0
comma
id|prodid
op_assign
l_int|0
comma
id|has_shmem
op_assign
l_int|0
suffix:semicolon
id|u_short
id|buf
(braket
l_int|64
)braket
suffix:semicolon
id|config_info_t
id|conf
suffix:semicolon
id|hw_info_t
op_star
id|hw_info
suffix:semicolon
id|DEBUG
c_func
(paren
l_int|0
comma
l_string|&quot;pcnet_config(0x%p)&bslash;n&quot;
comma
id|link
)paren
suffix:semicolon
id|tuple.Attributes
op_assign
l_int|0
suffix:semicolon
id|tuple.TupleData
op_assign
(paren
id|cisdata_t
op_star
)paren
id|buf
suffix:semicolon
id|tuple.TupleDataMax
op_assign
r_sizeof
(paren
id|buf
)paren
suffix:semicolon
id|tuple.TupleOffset
op_assign
l_int|0
suffix:semicolon
id|tuple.DesiredTuple
op_assign
id|CISTPL_CONFIG
suffix:semicolon
id|CS_CHECK
c_func
(paren
id|GetFirstTuple
comma
id|handle
comma
op_amp
id|tuple
)paren
suffix:semicolon
id|CS_CHECK
c_func
(paren
id|GetTupleData
comma
id|handle
comma
op_amp
id|tuple
)paren
suffix:semicolon
id|CS_CHECK
c_func
(paren
id|ParseTuple
comma
id|handle
comma
op_amp
id|tuple
comma
op_amp
id|parse
)paren
suffix:semicolon
id|link-&gt;conf.ConfigBase
op_assign
id|parse.config.base
suffix:semicolon
id|link-&gt;conf.Present
op_assign
id|parse.config.rmask
(braket
l_int|0
)braket
suffix:semicolon
multiline_comment|/* Configure card */
id|link-&gt;state
op_or_assign
id|DEV_CONFIG
suffix:semicolon
multiline_comment|/* Look up current Vcc */
id|CS_CHECK
c_func
(paren
id|GetConfigurationInfo
comma
id|handle
comma
op_amp
id|conf
)paren
suffix:semicolon
id|link-&gt;conf.Vcc
op_assign
id|conf.Vcc
suffix:semicolon
id|tuple.DesiredTuple
op_assign
id|CISTPL_MANFID
suffix:semicolon
id|tuple.Attributes
op_assign
id|TUPLE_RETURN_COMMON
suffix:semicolon
r_if
c_cond
(paren
(paren
id|CardServices
c_func
(paren
id|GetFirstTuple
comma
id|handle
comma
op_amp
id|tuple
)paren
op_eq
id|CS_SUCCESS
)paren
op_logical_and
(paren
id|CardServices
c_func
(paren
id|GetTupleData
comma
id|handle
comma
op_amp
id|tuple
)paren
op_eq
id|CS_SUCCESS
)paren
)paren
(brace
id|manfid
op_assign
id|le16_to_cpu
c_func
(paren
id|buf
(braket
l_int|0
)braket
)paren
suffix:semicolon
id|prodid
op_assign
id|le16_to_cpu
c_func
(paren
id|buf
(braket
l_int|1
)braket
)paren
suffix:semicolon
)brace
id|tuple.DesiredTuple
op_assign
id|CISTPL_CFTABLE_ENTRY
suffix:semicolon
id|tuple.Attributes
op_assign
l_int|0
suffix:semicolon
id|CS_CHECK
c_func
(paren
id|GetFirstTuple
comma
id|handle
comma
op_amp
id|tuple
)paren
suffix:semicolon
r_while
c_loop
(paren
id|last_ret
op_eq
id|CS_SUCCESS
)paren
(brace
id|cistpl_cftable_entry_t
op_star
id|cfg
op_assign
op_amp
(paren
id|parse.cftable_entry
)paren
suffix:semicolon
id|cistpl_io_t
op_star
id|io
op_assign
op_amp
(paren
id|parse.cftable_entry.io
)paren
suffix:semicolon
id|CFG_CHECK
c_func
(paren
id|GetTupleData
comma
id|handle
comma
op_amp
id|tuple
)paren
suffix:semicolon
id|CFG_CHECK
c_func
(paren
id|ParseTuple
comma
id|handle
comma
op_amp
id|tuple
comma
op_amp
id|parse
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|cfg-&gt;index
op_eq
l_int|0
)paren
op_logical_or
(paren
id|cfg-&gt;io.nwin
op_eq
l_int|0
)paren
)paren
r_goto
id|next_entry
suffix:semicolon
id|link-&gt;conf.ConfigIndex
op_assign
id|cfg-&gt;index
suffix:semicolon
multiline_comment|/* For multifunction cards, by convention, we configure the&n;&t;   network function with window 0, and serial with window 1 */
r_if
c_cond
(paren
id|io-&gt;nwin
OG
l_int|1
)paren
(brace
id|i
op_assign
(paren
id|io-&gt;win
(braket
l_int|1
)braket
dot
id|len
OG
id|io-&gt;win
(braket
l_int|0
)braket
dot
id|len
)paren
suffix:semicolon
id|link-&gt;io.BasePort2
op_assign
id|io-&gt;win
(braket
l_int|1
op_minus
id|i
)braket
dot
id|base
suffix:semicolon
id|link-&gt;io.NumPorts2
op_assign
id|io-&gt;win
(braket
l_int|1
op_minus
id|i
)braket
dot
id|len
suffix:semicolon
)brace
r_else
(brace
id|i
op_assign
id|link-&gt;io.NumPorts2
op_assign
l_int|0
suffix:semicolon
)brace
id|has_shmem
op_assign
(paren
(paren
id|cfg-&gt;mem.nwin
op_eq
l_int|1
)paren
op_logical_and
(paren
id|cfg-&gt;mem.win
(braket
l_int|0
)braket
dot
id|len
op_ge
l_int|0x4000
)paren
)paren
suffix:semicolon
id|link-&gt;io.BasePort1
op_assign
id|io-&gt;win
(braket
id|i
)braket
dot
id|base
suffix:semicolon
id|link-&gt;io.NumPorts1
op_assign
id|io-&gt;win
(braket
id|i
)braket
dot
id|len
suffix:semicolon
id|link-&gt;io.IOAddrLines
op_assign
id|io-&gt;flags
op_amp
id|CISTPL_IO_LINES_MASK
suffix:semicolon
r_if
c_cond
(paren
id|link-&gt;io.NumPorts1
op_plus
id|link-&gt;io.NumPorts2
op_ge
l_int|32
)paren
(brace
id|last_ret
op_assign
id|try_io_port
c_func
(paren
id|link
)paren
suffix:semicolon
r_if
c_cond
(paren
id|last_ret
op_eq
id|CS_SUCCESS
)paren
r_break
suffix:semicolon
)brace
id|next_entry
suffix:colon
id|last_ret
op_assign
id|CardServices
c_func
(paren
id|GetNextTuple
comma
id|handle
comma
op_amp
id|tuple
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|last_ret
op_ne
id|CS_SUCCESS
)paren
(brace
id|cs_error
c_func
(paren
id|handle
comma
id|RequestIO
comma
id|last_ret
)paren
suffix:semicolon
r_goto
id|failed
suffix:semicolon
)brace
id|CS_CHECK
c_func
(paren
id|RequestIRQ
comma
id|handle
comma
op_amp
id|link-&gt;irq
)paren
suffix:semicolon
r_if
c_cond
(paren
id|link-&gt;io.NumPorts2
op_eq
l_int|8
)paren
(brace
id|link-&gt;conf.Attributes
op_or_assign
id|CONF_ENABLE_SPKR
suffix:semicolon
id|link-&gt;conf.Status
op_assign
id|CCSR_AUDIO_ENA
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|manfid
op_eq
id|MANFID_IBM
)paren
op_logical_and
(paren
id|prodid
op_eq
id|PRODID_IBM_HOME_AND_AWAY
)paren
)paren
id|link-&gt;conf.ConfigIndex
op_or_assign
l_int|0x10
suffix:semicolon
id|CS_CHECK
c_func
(paren
id|RequestConfiguration
comma
id|handle
comma
op_amp
id|link-&gt;conf
)paren
suffix:semicolon
id|dev-&gt;irq
op_assign
id|link-&gt;irq.AssignedIRQ
suffix:semicolon
id|dev-&gt;base_addr
op_assign
id|link-&gt;io.BasePort1
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;flags
op_amp
id|HAS_MISC_REG
)paren
(brace
r_if
c_cond
(paren
(paren
id|if_port
op_eq
l_int|1
)paren
op_logical_or
(paren
id|if_port
op_eq
l_int|2
)paren
)paren
id|dev-&gt;if_port
op_assign
id|if_port
suffix:semicolon
r_else
id|printk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;pcnet_cs: invalid if_port requested&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_else
(brace
id|dev-&gt;if_port
op_assign
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|register_netdev
c_func
(paren
id|dev
)paren
op_ne
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;pcnet_cs: register_netdev() failed&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|failed
suffix:semicolon
)brace
id|hw_info
op_assign
id|get_hwinfo
c_func
(paren
id|link
)paren
suffix:semicolon
r_if
c_cond
(paren
id|hw_info
op_eq
l_int|NULL
)paren
id|hw_info
op_assign
id|get_prom
c_func
(paren
id|link
)paren
suffix:semicolon
r_if
c_cond
(paren
id|hw_info
op_eq
l_int|NULL
)paren
id|hw_info
op_assign
id|get_dl10019
c_func
(paren
id|link
)paren
suffix:semicolon
r_if
c_cond
(paren
id|hw_info
op_eq
l_int|NULL
)paren
id|hw_info
op_assign
id|get_ax88190
c_func
(paren
id|link
)paren
suffix:semicolon
r_if
c_cond
(paren
id|hw_info
op_eq
l_int|NULL
)paren
id|hw_info
op_assign
id|get_hwired
c_func
(paren
id|link
)paren
suffix:semicolon
r_if
c_cond
(paren
id|hw_info
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;pcnet_cs: unable to read hardware net&quot;
l_string|&quot; address for io base %#3lx&bslash;n&quot;
comma
id|dev-&gt;base_addr
)paren
suffix:semicolon
id|unregister_netdev
c_func
(paren
id|dev
)paren
suffix:semicolon
r_goto
id|failed
suffix:semicolon
)brace
id|info-&gt;flags
op_assign
id|hw_info-&gt;flags
suffix:semicolon
multiline_comment|/* Check for user overrides */
id|info-&gt;flags
op_or_assign
(paren
id|delay_output
)paren
ques
c_cond
id|DELAY_OUTPUT
suffix:colon
l_int|0
suffix:semicolon
r_if
c_cond
(paren
(paren
id|manfid
op_eq
id|MANFID_SOCKET
)paren
op_logical_and
(paren
(paren
id|prodid
op_eq
id|PRODID_SOCKET_LPE
)paren
op_logical_or
(paren
id|prodid
op_eq
id|PRODID_SOCKET_EIO
)paren
)paren
)paren
id|info-&gt;flags
op_and_assign
op_complement
id|USE_BIG_BUF
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|use_big_buf
)paren
id|info-&gt;flags
op_and_assign
op_complement
id|USE_BIG_BUF
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;flags
op_amp
id|USE_BIG_BUF
)paren
(brace
id|start_pg
op_assign
id|SOCKET_START_PG
suffix:semicolon
id|stop_pg
op_assign
id|SOCKET_STOP_PG
suffix:semicolon
id|cm_offset
op_assign
l_int|0x10000
suffix:semicolon
)brace
r_else
(brace
id|start_pg
op_assign
id|PCNET_START_PG
suffix:semicolon
id|stop_pg
op_assign
id|PCNET_STOP_PG
suffix:semicolon
id|cm_offset
op_assign
l_int|0
suffix:semicolon
)brace
multiline_comment|/* has_shmem is ignored if use_shmem != -1 */
r_if
c_cond
(paren
(paren
id|use_shmem
op_eq
l_int|0
)paren
op_logical_or
(paren
op_logical_neg
id|has_shmem
op_logical_and
(paren
id|use_shmem
op_eq
op_minus
l_int|1
)paren
)paren
op_logical_or
(paren
id|setup_shmem_window
c_func
(paren
id|link
comma
id|start_pg
comma
id|stop_pg
comma
id|cm_offset
)paren
op_ne
l_int|0
)paren
)paren
id|setup_dma_config
c_func
(paren
id|link
comma
id|start_pg
comma
id|stop_pg
)paren
suffix:semicolon
id|ei_status.name
op_assign
l_string|&quot;NE2000&quot;
suffix:semicolon
id|ei_status.word16
op_assign
l_int|1
suffix:semicolon
id|ei_status.reset_8390
op_assign
op_amp
id|pcnet_reset_8390
suffix:semicolon
id|strcpy
c_func
(paren
id|info-&gt;node.dev_name
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|link-&gt;dev
op_assign
op_amp
id|info-&gt;node
suffix:semicolon
id|link-&gt;state
op_and_assign
op_complement
id|DEV_CONFIG_PENDING
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;flags
op_amp
id|IS_DL10019
)paren
(brace
id|dev-&gt;do_ioctl
op_assign
op_amp
id|do_ioctl
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: NE2000 (DL100%d rev %02x): &quot;
comma
id|dev-&gt;name
comma
(paren
(paren
id|info-&gt;flags
op_amp
id|IS_DL10022
)paren
ques
c_cond
l_int|22
suffix:colon
l_int|19
)paren
comma
id|inb
c_func
(paren
id|dev-&gt;base_addr
op_plus
l_int|0x1a
)paren
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|info-&gt;flags
op_amp
id|IS_AX88190
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: NE2000 (AX88190): &quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
)brace
r_else
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: NE2000 Compatible: &quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;io %#3lx, irq %d,&quot;
comma
id|dev-&gt;base_addr
comma
id|dev-&gt;irq
)paren
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;flags
op_amp
id|USE_SHMEM
)paren
id|printk
(paren
l_string|&quot; mem %#5lx,&quot;
comma
id|dev-&gt;mem_start
)paren
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;flags
op_amp
id|HAS_MISC_REG
)paren
id|printk
c_func
(paren
l_string|&quot; %s xcvr,&quot;
comma
id|if_names
(braket
id|dev-&gt;if_port
)braket
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot; hw_addr &quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|6
suffix:semicolon
id|i
op_increment
)paren
id|printk
c_func
(paren
l_string|&quot;%02X%s&quot;
comma
id|dev-&gt;dev_addr
(braket
id|i
)braket
comma
(paren
(paren
id|i
OL
l_int|5
)paren
ques
c_cond
l_string|&quot;:&quot;
suffix:colon
l_string|&quot;&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_return
suffix:semicolon
id|cs_failed
suffix:colon
id|cs_error
c_func
(paren
id|link-&gt;handle
comma
id|last_fn
comma
id|last_ret
)paren
suffix:semicolon
id|failed
suffix:colon
id|pcnet_release
c_func
(paren
(paren
id|u_long
)paren
id|link
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/* pcnet_config */
multiline_comment|/*======================================================================&n;&n;    After a card is removed, pcnet_release() will unregister the net&n;    device, and release the PCMCIA configuration.  If the device is&n;    still open, this will be postponed until it is closed.&n;&n;======================================================================*/
DECL|function|pcnet_release
r_static
r_void
id|pcnet_release
c_func
(paren
id|u_long
id|arg
)paren
(brace
id|dev_link_t
op_star
id|link
op_assign
(paren
id|dev_link_t
op_star
)paren
id|arg
suffix:semicolon
id|pcnet_dev_t
op_star
id|info
op_assign
id|link-&gt;priv
suffix:semicolon
id|DEBUG
c_func
(paren
l_int|0
comma
l_string|&quot;pcnet_release(0x%p)&bslash;n&quot;
comma
id|link
)paren
suffix:semicolon
r_if
c_cond
(paren
id|link-&gt;open
)paren
(brace
id|DEBUG
c_func
(paren
l_int|1
comma
l_string|&quot;pcnet_cs: release postponed, &squot;%s&squot; still open&bslash;n&quot;
comma
id|info-&gt;node.dev_name
)paren
suffix:semicolon
id|link-&gt;state
op_or_assign
id|DEV_STALE_CONFIG
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|info-&gt;flags
op_amp
id|USE_SHMEM
)paren
(brace
id|iounmap
c_func
(paren
id|info-&gt;base
)paren
suffix:semicolon
id|CardServices
c_func
(paren
id|ReleaseWindow
comma
id|link-&gt;win
)paren
suffix:semicolon
)brace
id|CardServices
c_func
(paren
id|ReleaseConfiguration
comma
id|link-&gt;handle
)paren
suffix:semicolon
id|CardServices
c_func
(paren
id|ReleaseIO
comma
id|link-&gt;handle
comma
op_amp
id|link-&gt;io
)paren
suffix:semicolon
id|CardServices
c_func
(paren
id|ReleaseIRQ
comma
id|link-&gt;handle
comma
op_amp
id|link-&gt;irq
)paren
suffix:semicolon
id|link-&gt;state
op_and_assign
op_complement
id|DEV_CONFIG
suffix:semicolon
)brace
multiline_comment|/* pcnet_release */
multiline_comment|/*======================================================================&n;&n;    The card status event handler.  Mostly, this schedules other&n;    stuff to run after an event is received.  A CARD_REMOVAL event&n;    also sets some flags to discourage the net drivers from trying&n;    to talk to the card any more.&n;&n;======================================================================*/
DECL|function|pcnet_event
r_static
r_int
id|pcnet_event
c_func
(paren
id|event_t
id|event
comma
r_int
id|priority
comma
id|event_callback_args_t
op_star
id|args
)paren
(brace
id|dev_link_t
op_star
id|link
op_assign
id|args-&gt;client_data
suffix:semicolon
id|pcnet_dev_t
op_star
id|info
op_assign
id|link-&gt;priv
suffix:semicolon
id|DEBUG
c_func
(paren
l_int|2
comma
l_string|&quot;pcnet_event(0x%06x)&bslash;n&quot;
comma
id|event
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|event
)paren
(brace
r_case
id|CS_EVENT_CARD_REMOVAL
suffix:colon
id|link-&gt;state
op_and_assign
op_complement
id|DEV_PRESENT
suffix:semicolon
r_if
c_cond
(paren
id|link-&gt;state
op_amp
id|DEV_CONFIG
)paren
(brace
id|netif_device_detach
c_func
(paren
op_amp
id|info-&gt;dev
)paren
suffix:semicolon
id|mod_timer
c_func
(paren
op_amp
id|link-&gt;release
comma
id|jiffies
op_plus
id|HZ
op_div
l_int|20
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|CS_EVENT_CARD_INSERTION
suffix:colon
id|link-&gt;state
op_or_assign
id|DEV_PRESENT
suffix:semicolon
id|pcnet_config
c_func
(paren
id|link
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CS_EVENT_PM_SUSPEND
suffix:colon
id|link-&gt;state
op_or_assign
id|DEV_SUSPEND
suffix:semicolon
multiline_comment|/* Fall through... */
r_case
id|CS_EVENT_RESET_PHYSICAL
suffix:colon
r_if
c_cond
(paren
id|link-&gt;state
op_amp
id|DEV_CONFIG
)paren
(brace
r_if
c_cond
(paren
id|link-&gt;open
)paren
id|netif_device_detach
c_func
(paren
op_amp
id|info-&gt;dev
)paren
suffix:semicolon
id|CardServices
c_func
(paren
id|ReleaseConfiguration
comma
id|link-&gt;handle
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|CS_EVENT_PM_RESUME
suffix:colon
id|link-&gt;state
op_and_assign
op_complement
id|DEV_SUSPEND
suffix:semicolon
multiline_comment|/* Fall through... */
r_case
id|CS_EVENT_CARD_RESET
suffix:colon
r_if
c_cond
(paren
id|link-&gt;state
op_amp
id|DEV_CONFIG
)paren
(brace
id|CardServices
c_func
(paren
id|RequestConfiguration
comma
id|link-&gt;handle
comma
op_amp
id|link-&gt;conf
)paren
suffix:semicolon
r_if
c_cond
(paren
id|link-&gt;open
)paren
(brace
id|pcnet_reset_8390
c_func
(paren
op_amp
id|info-&gt;dev
)paren
suffix:semicolon
id|NS8390_init
c_func
(paren
op_amp
id|info-&gt;dev
comma
l_int|1
)paren
suffix:semicolon
id|netif_device_attach
c_func
(paren
op_amp
id|info-&gt;dev
)paren
suffix:semicolon
)brace
)brace
r_break
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* pcnet_event */
multiline_comment|/*======================================================================&n;&n;    MII interface support for DL10019 and DL10022 based cards&n;&n;    On the DL10019, the MII IO direction bit is 0x10; on  the DL10022&n;    it is 0x20.  Setting both bits seems to work on both card types.&n;&n;======================================================================*/
DECL|macro|DLINK_GPIO
mdefine_line|#define DLINK_GPIO&t;&t;0x1c
DECL|macro|DLINK_DIAG
mdefine_line|#define DLINK_DIAG&t;&t;0x1d
DECL|macro|MDIO_SHIFT_CLK
mdefine_line|#define MDIO_SHIFT_CLK&t;&t;0x80
DECL|macro|MDIO_DATA_OUT
mdefine_line|#define MDIO_DATA_OUT&t;&t;0x40
DECL|macro|MDIO_DIR_WRITE
mdefine_line|#define MDIO_DIR_WRITE&t;&t;0x30
DECL|macro|MDIO_DATA_WRITE0
mdefine_line|#define MDIO_DATA_WRITE0&t;(MDIO_DIR_WRITE)
DECL|macro|MDIO_DATA_WRITE1
mdefine_line|#define MDIO_DATA_WRITE1&t;(MDIO_DIR_WRITE | MDIO_DATA_OUT)
DECL|macro|MDIO_DATA_READ
mdefine_line|#define MDIO_DATA_READ&t;&t;0x10
DECL|macro|MDIO_MASK
mdefine_line|#define MDIO_MASK&t;&t;0x0f
DECL|function|mdio_sync
r_static
r_void
id|mdio_sync
c_func
(paren
id|ioaddr_t
id|addr
)paren
(brace
r_int
id|bits
comma
id|mask
op_assign
id|inb
c_func
(paren
id|addr
)paren
op_amp
id|MDIO_MASK
suffix:semicolon
r_for
c_loop
(paren
id|bits
op_assign
l_int|0
suffix:semicolon
id|bits
OL
l_int|32
suffix:semicolon
id|bits
op_increment
)paren
(brace
id|outb
c_func
(paren
id|mask
op_or
id|MDIO_DATA_WRITE1
comma
id|addr
)paren
suffix:semicolon
id|outb
c_func
(paren
id|mask
op_or
id|MDIO_DATA_WRITE1
op_or
id|MDIO_SHIFT_CLK
comma
id|addr
)paren
suffix:semicolon
)brace
)brace
DECL|function|mdio_read
r_static
r_int
id|mdio_read
c_func
(paren
id|ioaddr_t
id|addr
comma
r_int
id|phy_id
comma
r_int
id|loc
)paren
(brace
id|u_int
id|cmd
op_assign
(paren
l_int|0x06
op_lshift
l_int|10
)paren
op_or
(paren
id|phy_id
op_lshift
l_int|5
)paren
op_or
id|loc
suffix:semicolon
r_int
id|i
comma
id|retval
op_assign
l_int|0
comma
id|mask
op_assign
id|inb
c_func
(paren
id|addr
)paren
op_amp
id|MDIO_MASK
suffix:semicolon
id|mdio_sync
c_func
(paren
id|addr
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|13
suffix:semicolon
id|i
op_ge
l_int|0
suffix:semicolon
id|i
op_decrement
)paren
(brace
r_int
id|dat
op_assign
(paren
id|cmd
op_amp
(paren
l_int|1
op_lshift
id|i
)paren
)paren
ques
c_cond
id|MDIO_DATA_WRITE1
suffix:colon
id|MDIO_DATA_WRITE0
suffix:semicolon
id|outb
c_func
(paren
id|mask
op_or
id|dat
comma
id|addr
)paren
suffix:semicolon
id|outb
c_func
(paren
id|mask
op_or
id|dat
op_or
id|MDIO_SHIFT_CLK
comma
id|addr
)paren
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|19
suffix:semicolon
id|i
OG
l_int|0
suffix:semicolon
id|i
op_decrement
)paren
(brace
id|outb
c_func
(paren
id|mask
comma
id|addr
)paren
suffix:semicolon
id|retval
op_assign
(paren
id|retval
op_lshift
l_int|1
)paren
op_or
(paren
(paren
id|inb
c_func
(paren
id|addr
)paren
op_amp
id|MDIO_DATA_READ
)paren
op_ne
l_int|0
)paren
suffix:semicolon
id|outb
c_func
(paren
id|mask
op_or
id|MDIO_SHIFT_CLK
comma
id|addr
)paren
suffix:semicolon
)brace
r_return
(paren
id|retval
op_rshift
l_int|1
)paren
op_amp
l_int|0xffff
suffix:semicolon
)brace
DECL|function|mdio_write
r_static
r_void
id|mdio_write
c_func
(paren
id|ioaddr_t
id|addr
comma
r_int
id|phy_id
comma
r_int
id|loc
comma
r_int
id|value
)paren
(brace
id|u_int
id|cmd
op_assign
(paren
l_int|0x05
op_lshift
l_int|28
)paren
op_or
(paren
id|phy_id
op_lshift
l_int|23
)paren
op_or
(paren
id|loc
op_lshift
l_int|18
)paren
op_or
(paren
l_int|1
op_lshift
l_int|17
)paren
op_or
id|value
suffix:semicolon
r_int
id|i
comma
id|mask
op_assign
id|inb
c_func
(paren
id|addr
)paren
op_amp
id|MDIO_MASK
suffix:semicolon
id|mdio_sync
c_func
(paren
id|addr
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|31
suffix:semicolon
id|i
op_ge
l_int|0
suffix:semicolon
id|i
op_decrement
)paren
(brace
r_int
id|dat
op_assign
(paren
id|cmd
op_amp
(paren
l_int|1
op_lshift
id|i
)paren
)paren
ques
c_cond
id|MDIO_DATA_WRITE1
suffix:colon
id|MDIO_DATA_WRITE0
suffix:semicolon
id|outb
c_func
(paren
id|mask
op_or
id|dat
comma
id|addr
)paren
suffix:semicolon
id|outb
c_func
(paren
id|mask
op_or
id|dat
op_or
id|MDIO_SHIFT_CLK
comma
id|addr
)paren
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|1
suffix:semicolon
id|i
op_ge
l_int|0
suffix:semicolon
id|i
op_decrement
)paren
(brace
id|outb
c_func
(paren
id|mask
comma
id|addr
)paren
suffix:semicolon
id|outb
c_func
(paren
id|mask
op_or
id|MDIO_SHIFT_CLK
comma
id|addr
)paren
suffix:semicolon
)brace
)brace
DECL|function|mdio_reset
r_static
r_void
id|mdio_reset
c_func
(paren
id|ioaddr_t
id|addr
comma
r_int
id|phy_id
)paren
(brace
id|outb_p
c_func
(paren
l_int|0x08
comma
id|addr
)paren
suffix:semicolon
id|outb_p
c_func
(paren
l_int|0x0c
comma
id|addr
)paren
suffix:semicolon
id|outb_p
c_func
(paren
l_int|0x08
comma
id|addr
)paren
suffix:semicolon
id|outb_p
c_func
(paren
l_int|0x0c
comma
id|addr
)paren
suffix:semicolon
id|outb_p
c_func
(paren
l_int|0x00
comma
id|addr
)paren
suffix:semicolon
)brace
multiline_comment|/*====================================================================*/
DECL|function|set_misc_reg
r_static
r_void
id|set_misc_reg
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
id|ioaddr_t
id|nic_base
op_assign
id|dev-&gt;base_addr
suffix:semicolon
id|pcnet_dev_t
op_star
id|info
op_assign
(paren
id|pcnet_dev_t
op_star
)paren
id|dev
suffix:semicolon
id|u_char
id|tmp
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;flags
op_amp
id|HAS_MISC_REG
)paren
(brace
id|tmp
op_assign
id|inb_p
c_func
(paren
id|nic_base
op_plus
id|PCNET_MISC
)paren
op_amp
op_complement
l_int|3
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;if_port
op_eq
l_int|2
)paren
id|tmp
op_or_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;flags
op_amp
id|USE_BIG_BUF
)paren
id|tmp
op_or_assign
l_int|2
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;flags
op_amp
id|HAS_IBM_MISC
)paren
id|tmp
op_or_assign
l_int|8
suffix:semicolon
id|outb_p
c_func
(paren
id|tmp
comma
id|nic_base
op_plus
id|PCNET_MISC
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|info-&gt;flags
op_amp
id|IS_DL10022
)paren
(brace
id|mdio_reset
c_func
(paren
id|nic_base
op_plus
id|DLINK_GPIO
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* Restart MII autonegotiation */
id|mdio_write
c_func
(paren
id|nic_base
op_plus
id|DLINK_GPIO
comma
l_int|0
comma
l_int|0
comma
l_int|0x0000
)paren
suffix:semicolon
id|mdio_write
c_func
(paren
id|nic_base
op_plus
id|DLINK_GPIO
comma
l_int|0
comma
l_int|0
comma
l_int|0x1200
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/*====================================================================*/
DECL|function|pcnet_open
r_static
r_int
id|pcnet_open
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
id|pcnet_dev_t
op_star
id|info
op_assign
(paren
id|pcnet_dev_t
op_star
)paren
id|dev
suffix:semicolon
id|dev_link_t
op_star
id|link
op_assign
op_amp
id|info-&gt;link
suffix:semicolon
id|DEBUG
c_func
(paren
l_int|2
comma
l_string|&quot;pcnet_open(&squot;%s&squot;)&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|DEV_OK
c_func
(paren
id|link
)paren
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
id|link-&gt;open
op_increment
suffix:semicolon
id|MOD_INC_USE_COUNT
suffix:semicolon
id|set_misc_reg
c_func
(paren
id|dev
)paren
suffix:semicolon
id|request_irq
c_func
(paren
id|dev-&gt;irq
comma
id|ei_irq_wrapper
comma
id|SA_SHIRQ
comma
id|dev_info
comma
id|dev
)paren
suffix:semicolon
id|info-&gt;link_status
op_assign
l_int|0x00
suffix:semicolon
id|info-&gt;watchdog.function
op_assign
op_amp
id|ei_watchdog
suffix:semicolon
id|info-&gt;watchdog.data
op_assign
(paren
id|u_long
)paren
id|info
suffix:semicolon
id|info-&gt;watchdog.expires
op_assign
id|jiffies
op_plus
id|HZ
suffix:semicolon
id|add_timer
c_func
(paren
op_amp
id|info-&gt;watchdog
)paren
suffix:semicolon
r_return
id|ei_open
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
multiline_comment|/* pcnet_open */
multiline_comment|/*====================================================================*/
DECL|function|pcnet_close
r_static
r_int
id|pcnet_close
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
id|pcnet_dev_t
op_star
id|info
op_assign
(paren
id|pcnet_dev_t
op_star
)paren
id|dev
suffix:semicolon
id|dev_link_t
op_star
id|link
op_assign
op_amp
id|info-&gt;link
suffix:semicolon
id|DEBUG
c_func
(paren
l_int|2
comma
l_string|&quot;pcnet_close(&squot;%s&squot;)&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|free_irq
c_func
(paren
id|dev-&gt;irq
comma
id|dev
)paren
suffix:semicolon
id|link-&gt;open
op_decrement
suffix:semicolon
id|netif_stop_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
id|del_timer
c_func
(paren
op_amp
id|info-&gt;watchdog
)paren
suffix:semicolon
r_if
c_cond
(paren
id|link-&gt;state
op_amp
id|DEV_STALE_CONFIG
)paren
id|mod_timer
c_func
(paren
op_amp
id|link-&gt;release
comma
id|jiffies
op_plus
id|HZ
op_div
l_int|20
)paren
suffix:semicolon
id|MOD_DEC_USE_COUNT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* pcnet_close */
multiline_comment|/*======================================================================&n;&n;    Hard reset the card.  This used to pause for the same period that&n;    a 8390 reset command required, but that shouldn&squot;t be necessary.&n;&n;======================================================================*/
DECL|function|pcnet_reset_8390
r_static
r_void
id|pcnet_reset_8390
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
id|ioaddr_t
id|nic_base
op_assign
id|dev-&gt;base_addr
suffix:semicolon
r_int
id|i
suffix:semicolon
id|ei_status.txing
op_assign
id|ei_status.dmaing
op_assign
l_int|0
suffix:semicolon
id|outb
c_func
(paren
id|inb
c_func
(paren
id|nic_base
op_plus
id|PCNET_RESET
)paren
comma
id|nic_base
op_plus
id|PCNET_RESET
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|100
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
(paren
id|inb_p
c_func
(paren
id|nic_base
op_plus
id|EN0_ISR
)paren
op_amp
id|ENISR_RESET
)paren
op_ne
l_int|0
)paren
r_break
suffix:semicolon
id|udelay
c_func
(paren
l_int|100
)paren
suffix:semicolon
)brace
id|outb_p
c_func
(paren
id|ENISR_RESET
comma
id|nic_base
op_plus
id|EN0_ISR
)paren
suffix:semicolon
multiline_comment|/* Ack intr. */
r_if
c_cond
(paren
id|i
op_eq
l_int|100
)paren
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: pcnet_reset_8390() did not complete.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|set_misc_reg
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
multiline_comment|/* pcnet_reset_8390 */
multiline_comment|/*====================================================================*/
DECL|function|set_config
r_static
r_int
id|set_config
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_struct
id|ifmap
op_star
id|map
)paren
(brace
id|pcnet_dev_t
op_star
id|info
op_assign
(paren
id|pcnet_dev_t
op_star
)paren
id|dev
suffix:semicolon
r_if
c_cond
(paren
(paren
id|map-&gt;port
op_ne
(paren
id|u_char
)paren
(paren
op_minus
l_int|1
)paren
)paren
op_logical_and
(paren
id|map-&gt;port
op_ne
id|dev-&gt;if_port
)paren
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|info-&gt;flags
op_amp
id|HAS_MISC_REG
)paren
)paren
r_return
op_minus
id|EOPNOTSUPP
suffix:semicolon
r_else
r_if
c_cond
(paren
(paren
id|map-&gt;port
OL
l_int|1
)paren
op_logical_or
(paren
id|map-&gt;port
OG
l_int|2
)paren
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|dev-&gt;if_port
op_assign
id|map-&gt;port
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: switched to %s port&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|if_names
(braket
id|dev-&gt;if_port
)braket
)paren
suffix:semicolon
id|NS8390_init
c_func
(paren
id|dev
comma
l_int|1
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*====================================================================*/
DECL|function|ei_irq_wrapper
r_static
r_void
id|ei_irq_wrapper
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
id|pcnet_dev_t
op_star
id|info
op_assign
id|dev_id
suffix:semicolon
id|info-&gt;stale
op_assign
l_int|0
suffix:semicolon
id|ei_interrupt
c_func
(paren
id|irq
comma
id|dev_id
comma
id|regs
)paren
suffix:semicolon
)brace
DECL|function|ei_watchdog
r_static
r_void
id|ei_watchdog
c_func
(paren
id|u_long
id|arg
)paren
(brace
id|pcnet_dev_t
op_star
id|info
op_assign
(paren
id|pcnet_dev_t
op_star
)paren
(paren
id|arg
)paren
suffix:semicolon
r_struct
id|net_device
op_star
id|dev
op_assign
op_amp
id|info-&gt;dev
suffix:semicolon
id|ioaddr_t
id|nic_base
op_assign
id|dev-&gt;base_addr
suffix:semicolon
id|u_short
id|link
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|netif_device_present
c_func
(paren
id|dev
)paren
)paren
r_goto
id|reschedule
suffix:semicolon
multiline_comment|/* Check for pending interrupt with expired latency timer: with&n;       this, we can limp along even if the interrupt is blocked */
id|outb_p
c_func
(paren
id|E8390_NODMA
op_plus
id|E8390_PAGE0
comma
id|nic_base
op_plus
id|E8390_CMD
)paren
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;stale
op_increment
op_logical_and
(paren
id|inb_p
c_func
(paren
id|nic_base
op_plus
id|EN0_ISR
)paren
op_amp
id|ENISR_ALL
)paren
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|info-&gt;fast_poll
)paren
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: interrupt(s) dropped!&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|ei_irq_wrapper
c_func
(paren
id|dev-&gt;irq
comma
id|dev
comma
l_int|NULL
)paren
suffix:semicolon
id|info-&gt;fast_poll
op_assign
id|HZ
suffix:semicolon
)brace
r_if
c_cond
(paren
id|info-&gt;fast_poll
)paren
(brace
id|info-&gt;fast_poll
op_decrement
suffix:semicolon
id|info-&gt;watchdog.expires
op_assign
id|jiffies
op_plus
l_int|1
suffix:semicolon
id|add_timer
c_func
(paren
op_amp
id|info-&gt;watchdog
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|info-&gt;flags
op_amp
id|IS_DL10019
)paren
)paren
r_goto
id|reschedule
suffix:semicolon
id|link
op_assign
id|mdio_read
c_func
(paren
id|dev-&gt;base_addr
op_plus
id|DLINK_GPIO
comma
l_int|0
comma
l_int|1
)paren
op_amp
l_int|0x0004
suffix:semicolon
r_if
c_cond
(paren
id|link
op_ne
id|info-&gt;link_status
)paren
(brace
id|u_short
id|p
op_assign
id|mdio_read
c_func
(paren
id|dev-&gt;base_addr
op_plus
id|DLINK_GPIO
comma
l_int|0
comma
l_int|5
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: %s link beat&bslash;n&quot;
comma
id|dev-&gt;name
comma
(paren
id|link
)paren
ques
c_cond
l_string|&quot;found&quot;
suffix:colon
l_string|&quot;lost&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|link
op_logical_and
(paren
id|info-&gt;flags
op_amp
id|IS_DL10022
)paren
)paren
(brace
multiline_comment|/* Disable collision detection on full duplex links */
id|outb
c_func
(paren
(paren
id|p
op_amp
l_int|0x0140
)paren
ques
c_cond
l_int|4
suffix:colon
l_int|0
comma
id|dev-&gt;base_addr
op_plus
id|DLINK_DIAG
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|link
)paren
(brace
r_if
c_cond
(paren
id|p
)paren
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: autonegotiation complete: &quot;
l_string|&quot;%sbaseT-%cD selected&bslash;n&quot;
comma
id|dev-&gt;name
comma
(paren
(paren
id|p
op_amp
l_int|0x0180
)paren
ques
c_cond
l_string|&quot;100&quot;
suffix:colon
l_string|&quot;10&quot;
)paren
comma
(paren
(paren
id|p
op_amp
l_int|0x0140
)paren
ques
c_cond
l_char|&squot;F&squot;
suffix:colon
l_char|&squot;H&squot;
)paren
)paren
suffix:semicolon
r_else
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: link partner did not autonegotiate&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|NS8390_init
c_func
(paren
id|dev
comma
l_int|1
)paren
suffix:semicolon
)brace
id|info-&gt;link_status
op_assign
id|link
suffix:semicolon
)brace
id|reschedule
suffix:colon
id|info-&gt;watchdog.expires
op_assign
id|jiffies
op_plus
id|HZ
suffix:semicolon
id|add_timer
c_func
(paren
op_amp
id|info-&gt;watchdog
)paren
suffix:semicolon
)brace
multiline_comment|/*====================================================================*/
DECL|function|do_ioctl
r_static
r_int
id|do_ioctl
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_struct
id|ifreq
op_star
id|rq
comma
r_int
id|cmd
)paren
(brace
id|u16
op_star
id|data
op_assign
(paren
id|u16
op_star
)paren
op_amp
id|rq-&gt;ifr_data
suffix:semicolon
id|ioaddr_t
id|addr
op_assign
id|dev-&gt;base_addr
op_plus
id|DLINK_GPIO
suffix:semicolon
r_switch
c_cond
(paren
id|cmd
)paren
(brace
r_case
id|SIOCDEVPRIVATE
suffix:colon
id|data
(braket
l_int|0
)braket
op_assign
l_int|0
suffix:semicolon
r_case
id|SIOCDEVPRIVATE
op_plus
l_int|1
suffix:colon
id|data
(braket
l_int|3
)braket
op_assign
id|mdio_read
c_func
(paren
id|addr
comma
id|data
(braket
l_int|0
)braket
comma
id|data
(braket
l_int|1
)braket
op_amp
l_int|0x1f
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
r_case
id|SIOCDEVPRIVATE
op_plus
l_int|2
suffix:colon
r_if
c_cond
(paren
op_logical_neg
id|capable
c_func
(paren
id|CAP_NET_ADMIN
)paren
)paren
r_return
op_minus
id|EPERM
suffix:semicolon
id|mdio_write
c_func
(paren
id|addr
comma
id|data
(braket
l_int|0
)braket
comma
id|data
(braket
l_int|1
)braket
op_amp
l_int|0x1f
comma
id|data
(braket
l_int|2
)braket
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_return
op_minus
id|EOPNOTSUPP
suffix:semicolon
)brace
multiline_comment|/*====================================================================*/
DECL|function|dma_get_8390_hdr
r_static
r_void
id|dma_get_8390_hdr
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_struct
id|e8390_pkt_hdr
op_star
id|hdr
comma
r_int
id|ring_page
)paren
(brace
id|ioaddr_t
id|nic_base
op_assign
id|dev-&gt;base_addr
suffix:semicolon
r_if
c_cond
(paren
id|ei_status.dmaing
)paren
(brace
id|printk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;%s: DMAing conflict in dma_block_input.&quot;
l_string|&quot;[DMAstat:%1x][irqlock:%1x]&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|ei_status.dmaing
comma
id|ei_status.irqlock
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|ei_status.dmaing
op_or_assign
l_int|0x01
suffix:semicolon
id|outb_p
c_func
(paren
id|E8390_NODMA
op_plus
id|E8390_PAGE0
op_plus
id|E8390_START
comma
id|nic_base
op_plus
id|PCNET_CMD
)paren
suffix:semicolon
id|outb_p
c_func
(paren
r_sizeof
(paren
r_struct
id|e8390_pkt_hdr
)paren
comma
id|nic_base
op_plus
id|EN0_RCNTLO
)paren
suffix:semicolon
id|outb_p
c_func
(paren
l_int|0
comma
id|nic_base
op_plus
id|EN0_RCNTHI
)paren
suffix:semicolon
id|outb_p
c_func
(paren
l_int|0
comma
id|nic_base
op_plus
id|EN0_RSARLO
)paren
suffix:semicolon
multiline_comment|/* On page boundary */
id|outb_p
c_func
(paren
id|ring_page
comma
id|nic_base
op_plus
id|EN0_RSARHI
)paren
suffix:semicolon
id|outb_p
c_func
(paren
id|E8390_RREAD
op_plus
id|E8390_START
comma
id|nic_base
op_plus
id|PCNET_CMD
)paren
suffix:semicolon
id|insw
c_func
(paren
id|nic_base
op_plus
id|PCNET_DATAPORT
comma
id|hdr
comma
r_sizeof
(paren
r_struct
id|e8390_pkt_hdr
)paren
op_rshift
l_int|1
)paren
suffix:semicolon
multiline_comment|/* Fix for big endian systems */
id|hdr-&gt;count
op_assign
id|le16_to_cpu
c_func
(paren
id|hdr-&gt;count
)paren
suffix:semicolon
id|outb_p
c_func
(paren
id|ENISR_RDC
comma
id|nic_base
op_plus
id|EN0_ISR
)paren
suffix:semicolon
multiline_comment|/* Ack intr. */
id|ei_status.dmaing
op_and_assign
op_complement
l_int|0x01
suffix:semicolon
)brace
multiline_comment|/*====================================================================*/
DECL|function|dma_block_input
r_static
r_void
id|dma_block_input
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_int
id|count
comma
r_struct
id|sk_buff
op_star
id|skb
comma
r_int
id|ring_offset
)paren
(brace
id|ioaddr_t
id|nic_base
op_assign
id|dev-&gt;base_addr
suffix:semicolon
r_int
id|xfer_count
op_assign
id|count
suffix:semicolon
r_char
op_star
id|buf
op_assign
id|skb-&gt;data
suffix:semicolon
macro_line|#ifdef PCMCIA_DEBUG
r_if
c_cond
(paren
(paren
id|ei_debug
OG
l_int|4
)paren
op_logical_and
(paren
id|count
op_ne
l_int|4
)paren
)paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%s: [bi=%d]&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|count
op_plus
l_int|4
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|ei_status.dmaing
)paren
(brace
id|printk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;%s: DMAing conflict in dma_block_input.&quot;
l_string|&quot;[DMAstat:%1x][irqlock:%1x]&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|ei_status.dmaing
comma
id|ei_status.irqlock
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|ei_status.dmaing
op_or_assign
l_int|0x01
suffix:semicolon
id|outb_p
c_func
(paren
id|E8390_NODMA
op_plus
id|E8390_PAGE0
op_plus
id|E8390_START
comma
id|nic_base
op_plus
id|PCNET_CMD
)paren
suffix:semicolon
id|outb_p
c_func
(paren
id|count
op_amp
l_int|0xff
comma
id|nic_base
op_plus
id|EN0_RCNTLO
)paren
suffix:semicolon
id|outb_p
c_func
(paren
id|count
op_rshift
l_int|8
comma
id|nic_base
op_plus
id|EN0_RCNTHI
)paren
suffix:semicolon
id|outb_p
c_func
(paren
id|ring_offset
op_amp
l_int|0xff
comma
id|nic_base
op_plus
id|EN0_RSARLO
)paren
suffix:semicolon
id|outb_p
c_func
(paren
id|ring_offset
op_rshift
l_int|8
comma
id|nic_base
op_plus
id|EN0_RSARHI
)paren
suffix:semicolon
id|outb_p
c_func
(paren
id|E8390_RREAD
op_plus
id|E8390_START
comma
id|nic_base
op_plus
id|PCNET_CMD
)paren
suffix:semicolon
id|insw
c_func
(paren
id|nic_base
op_plus
id|PCNET_DATAPORT
comma
id|buf
comma
id|count
op_rshift
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|count
op_amp
l_int|0x01
)paren
id|buf
(braket
id|count
op_minus
l_int|1
)braket
op_assign
id|inb
c_func
(paren
id|nic_base
op_plus
id|PCNET_DATAPORT
)paren
comma
id|xfer_count
op_increment
suffix:semicolon
multiline_comment|/* This was for the ALPHA version only, but enough people have&n;       encountering problems that it is still here. */
macro_line|#ifdef PCMCIA_DEBUG
r_if
c_cond
(paren
id|ei_debug
OG
l_int|4
)paren
(brace
multiline_comment|/* DMA termination address check... */
r_int
id|addr
comma
id|tries
op_assign
l_int|20
suffix:semicolon
r_do
(brace
multiline_comment|/* DON&squot;T check for &squot;inb_p(EN0_ISR) &amp; ENISR_RDC&squot; here&n;&t;       -- it&squot;s broken for Rx on some cards! */
r_int
id|high
op_assign
id|inb_p
c_func
(paren
id|nic_base
op_plus
id|EN0_RSARHI
)paren
suffix:semicolon
r_int
id|low
op_assign
id|inb_p
c_func
(paren
id|nic_base
op_plus
id|EN0_RSARLO
)paren
suffix:semicolon
id|addr
op_assign
(paren
id|high
op_lshift
l_int|8
)paren
op_plus
id|low
suffix:semicolon
r_if
c_cond
(paren
(paren
(paren
id|ring_offset
op_plus
id|xfer_count
)paren
op_amp
l_int|0xff
)paren
op_eq
(paren
id|addr
op_amp
l_int|0xff
)paren
)paren
r_break
suffix:semicolon
)brace
r_while
c_loop
(paren
op_decrement
id|tries
OG
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tries
op_le
l_int|0
)paren
id|printk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;%s: RX transfer address mismatch,&quot;
l_string|&quot;%#4.4x (expected) vs. %#4.4x (actual).&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|ring_offset
op_plus
id|xfer_count
comma
id|addr
)paren
suffix:semicolon
)brace
macro_line|#endif
id|outb_p
c_func
(paren
id|ENISR_RDC
comma
id|nic_base
op_plus
id|EN0_ISR
)paren
suffix:semicolon
multiline_comment|/* Ack intr. */
id|ei_status.dmaing
op_and_assign
op_complement
l_int|0x01
suffix:semicolon
)brace
multiline_comment|/* dma_block_input */
multiline_comment|/*====================================================================*/
DECL|function|dma_block_output
r_static
r_void
id|dma_block_output
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_int
id|count
comma
r_const
id|u_char
op_star
id|buf
comma
r_const
r_int
id|start_page
)paren
(brace
id|ioaddr_t
id|nic_base
op_assign
id|dev-&gt;base_addr
suffix:semicolon
id|pcnet_dev_t
op_star
id|info
op_assign
(paren
id|pcnet_dev_t
op_star
)paren
id|dev
suffix:semicolon
macro_line|#ifdef PCMCIA_DEBUG
r_int
id|retries
op_assign
l_int|0
suffix:semicolon
macro_line|#endif
id|u_long
id|dma_start
suffix:semicolon
macro_line|#ifdef PCMCIA_DEBUG
r_if
c_cond
(paren
id|ei_debug
OG
l_int|4
)paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%s: [bo=%d]&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|count
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/* Round the count up for word writes.  Do we need to do this?&n;       What effect will an odd byte count have on the 8390?&n;       I should check someday. */
r_if
c_cond
(paren
id|count
op_amp
l_int|0x01
)paren
id|count
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|ei_status.dmaing
)paren
(brace
id|printk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;%s: DMAing conflict in dma_block_output.&quot;
l_string|&quot;[DMAstat:%1x][irqlock:%1x]&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|ei_status.dmaing
comma
id|ei_status.irqlock
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|ei_status.dmaing
op_or_assign
l_int|0x01
suffix:semicolon
multiline_comment|/* We should already be in page 0, but to be safe... */
id|outb_p
c_func
(paren
id|E8390_PAGE0
op_plus
id|E8390_START
op_plus
id|E8390_NODMA
comma
id|nic_base
op_plus
id|PCNET_CMD
)paren
suffix:semicolon
macro_line|#ifdef PCMCIA_DEBUG
id|retry
suffix:colon
macro_line|#endif
id|outb_p
c_func
(paren
id|ENISR_RDC
comma
id|nic_base
op_plus
id|EN0_ISR
)paren
suffix:semicolon
multiline_comment|/* Now the normal output. */
id|outb_p
c_func
(paren
id|count
op_amp
l_int|0xff
comma
id|nic_base
op_plus
id|EN0_RCNTLO
)paren
suffix:semicolon
id|outb_p
c_func
(paren
id|count
op_rshift
l_int|8
comma
id|nic_base
op_plus
id|EN0_RCNTHI
)paren
suffix:semicolon
id|outb_p
c_func
(paren
l_int|0x00
comma
id|nic_base
op_plus
id|EN0_RSARLO
)paren
suffix:semicolon
id|outb_p
c_func
(paren
id|start_page
comma
id|nic_base
op_plus
id|EN0_RSARHI
)paren
suffix:semicolon
id|outb_p
c_func
(paren
id|E8390_RWRITE
op_plus
id|E8390_START
comma
id|nic_base
op_plus
id|PCNET_CMD
)paren
suffix:semicolon
id|outsw
c_func
(paren
id|nic_base
op_plus
id|PCNET_DATAPORT
comma
id|buf
comma
id|count
op_rshift
l_int|1
)paren
suffix:semicolon
id|dma_start
op_assign
id|jiffies
suffix:semicolon
macro_line|#ifdef PCMCIA_DEBUG
multiline_comment|/* This was for the ALPHA version only, but enough people have&n;       encountering problems that it is still here. */
r_if
c_cond
(paren
id|ei_debug
OG
l_int|4
)paren
(brace
multiline_comment|/* DMA termination address check... */
r_int
id|addr
comma
id|tries
op_assign
l_int|20
suffix:semicolon
r_do
(brace
r_int
id|high
op_assign
id|inb_p
c_func
(paren
id|nic_base
op_plus
id|EN0_RSARHI
)paren
suffix:semicolon
r_int
id|low
op_assign
id|inb_p
c_func
(paren
id|nic_base
op_plus
id|EN0_RSARLO
)paren
suffix:semicolon
id|addr
op_assign
(paren
id|high
op_lshift
l_int|8
)paren
op_plus
id|low
suffix:semicolon
r_if
c_cond
(paren
(paren
id|start_page
op_lshift
l_int|8
)paren
op_plus
id|count
op_eq
id|addr
)paren
r_break
suffix:semicolon
)brace
r_while
c_loop
(paren
op_decrement
id|tries
OG
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tries
op_le
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;%s: Tx packet transfer address mismatch,&quot;
l_string|&quot;%#4.4x (expected) vs. %#4.4x (actual).&bslash;n&quot;
comma
id|dev-&gt;name
comma
(paren
id|start_page
op_lshift
l_int|8
)paren
op_plus
id|count
comma
id|addr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|retries
op_increment
op_eq
l_int|0
)paren
r_goto
id|retry
suffix:semicolon
)brace
)brace
macro_line|#endif
r_while
c_loop
(paren
(paren
id|inb_p
c_func
(paren
id|nic_base
op_plus
id|EN0_ISR
)paren
op_amp
id|ENISR_RDC
)paren
op_eq
l_int|0
)paren
r_if
c_cond
(paren
id|jiffies
op_minus
id|dma_start
OG
id|PCNET_RDC_TIMEOUT
)paren
(brace
id|printk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;%s: timeout waiting for Tx RDC.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|pcnet_reset_8390
c_func
(paren
id|dev
)paren
suffix:semicolon
id|NS8390_init
c_func
(paren
id|dev
comma
l_int|1
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|outb_p
c_func
(paren
id|ENISR_RDC
comma
id|nic_base
op_plus
id|EN0_ISR
)paren
suffix:semicolon
multiline_comment|/* Ack intr. */
r_if
c_cond
(paren
id|info-&gt;flags
op_amp
id|DELAY_OUTPUT
)paren
id|udelay
c_func
(paren
(paren
r_int
)paren
id|delay_time
)paren
suffix:semicolon
id|ei_status.dmaing
op_and_assign
op_complement
l_int|0x01
suffix:semicolon
)brace
multiline_comment|/*====================================================================*/
DECL|function|setup_dma_config
r_static
r_int
id|setup_dma_config
c_func
(paren
id|dev_link_t
op_star
id|link
comma
r_int
id|start_pg
comma
r_int
id|stop_pg
)paren
(brace
r_struct
id|net_device
op_star
id|dev
op_assign
id|link-&gt;priv
suffix:semicolon
id|ei_status.tx_start_page
op_assign
id|start_pg
suffix:semicolon
id|ei_status.rx_start_page
op_assign
id|start_pg
op_plus
id|TX_PAGES
suffix:semicolon
id|ei_status.stop_page
op_assign
id|stop_pg
suffix:semicolon
multiline_comment|/* set up block i/o functions */
id|ei_status.get_8390_hdr
op_assign
op_amp
id|dma_get_8390_hdr
suffix:semicolon
id|ei_status.block_input
op_assign
op_amp
id|dma_block_input
suffix:semicolon
id|ei_status.block_output
op_assign
op_amp
id|dma_block_output
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*====================================================================*/
DECL|function|copyin
r_static
r_void
id|copyin
c_func
(paren
id|u_char
op_star
id|dest
comma
id|u_char
op_star
id|src
comma
r_int
id|c
)paren
(brace
id|u_short
op_star
id|d
op_assign
(paren
id|u_short
op_star
)paren
id|dest
comma
op_star
id|s
op_assign
(paren
id|u_short
op_star
)paren
id|src
suffix:semicolon
r_int
id|odd
suffix:semicolon
r_if
c_cond
(paren
id|c
op_le
l_int|0
)paren
r_return
suffix:semicolon
id|odd
op_assign
(paren
id|c
op_amp
l_int|1
)paren
suffix:semicolon
id|c
op_rshift_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|c
)paren
(brace
r_do
(brace
op_star
id|d
op_increment
op_assign
id|__raw_readw
c_func
(paren
id|s
op_increment
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
op_decrement
id|c
)paren
suffix:semicolon
)brace
multiline_comment|/* get last byte by fetching a word and masking */
r_if
c_cond
(paren
id|odd
)paren
op_star
(paren
(paren
id|u_char
op_star
)paren
id|d
)paren
op_assign
id|readw
c_func
(paren
id|s
)paren
op_amp
l_int|0xff
suffix:semicolon
)brace
DECL|function|copyout
r_static
r_void
id|copyout
c_func
(paren
id|u_char
op_star
id|dest
comma
r_const
id|u_char
op_star
id|src
comma
r_int
id|c
)paren
(brace
id|u_short
op_star
id|d
op_assign
(paren
id|u_short
op_star
)paren
id|dest
comma
op_star
id|s
op_assign
(paren
id|u_short
op_star
)paren
id|src
suffix:semicolon
r_int
id|odd
suffix:semicolon
r_if
c_cond
(paren
id|c
op_le
l_int|0
)paren
r_return
suffix:semicolon
id|odd
op_assign
(paren
id|c
op_amp
l_int|1
)paren
suffix:semicolon
id|c
op_rshift_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|c
)paren
(brace
r_do
(brace
id|__raw_writew
c_func
(paren
op_star
id|s
op_increment
comma
id|d
op_increment
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
op_decrement
id|c
)paren
suffix:semicolon
)brace
multiline_comment|/* copy last byte doing a read-modify-write */
r_if
c_cond
(paren
id|odd
)paren
id|writew
c_func
(paren
(paren
id|readw
c_func
(paren
id|d
)paren
op_amp
l_int|0xff00
)paren
op_or
op_star
(paren
id|u_char
op_star
)paren
id|s
comma
id|d
)paren
suffix:semicolon
)brace
multiline_comment|/*====================================================================*/
DECL|function|shmem_get_8390_hdr
r_static
r_void
id|shmem_get_8390_hdr
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_struct
id|e8390_pkt_hdr
op_star
id|hdr
comma
r_int
id|ring_page
)paren
(brace
r_void
op_star
id|xfer_start
op_assign
(paren
r_void
op_star
)paren
(paren
id|dev-&gt;rmem_start
op_plus
(paren
id|ring_page
op_lshift
l_int|8
)paren
op_minus
(paren
id|ei_status.rx_start_page
op_lshift
l_int|8
)paren
)paren
suffix:semicolon
id|copyin
c_func
(paren
(paren
r_void
op_star
)paren
id|hdr
comma
id|xfer_start
comma
r_sizeof
(paren
r_struct
id|e8390_pkt_hdr
)paren
)paren
suffix:semicolon
multiline_comment|/* Fix for big endian systems */
id|hdr-&gt;count
op_assign
id|le16_to_cpu
c_func
(paren
id|hdr-&gt;count
)paren
suffix:semicolon
)brace
multiline_comment|/*====================================================================*/
DECL|function|shmem_block_input
r_static
r_void
id|shmem_block_input
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_int
id|count
comma
r_struct
id|sk_buff
op_star
id|skb
comma
r_int
id|ring_offset
)paren
(brace
r_void
op_star
id|xfer_start
op_assign
(paren
r_void
op_star
)paren
(paren
id|dev-&gt;rmem_start
op_plus
id|ring_offset
op_minus
(paren
id|ei_status.rx_start_page
op_lshift
l_int|8
)paren
)paren
suffix:semicolon
r_char
op_star
id|buf
op_assign
id|skb-&gt;data
suffix:semicolon
r_if
c_cond
(paren
id|xfer_start
op_plus
id|count
OG
(paren
r_void
op_star
)paren
id|dev-&gt;rmem_end
)paren
(brace
multiline_comment|/* We must wrap the input move. */
r_int
id|semi_count
op_assign
(paren
r_void
op_star
)paren
id|dev-&gt;rmem_end
op_minus
id|xfer_start
suffix:semicolon
id|copyin
c_func
(paren
id|buf
comma
id|xfer_start
comma
id|semi_count
)paren
suffix:semicolon
id|buf
op_add_assign
id|semi_count
suffix:semicolon
id|ring_offset
op_assign
id|ei_status.rx_start_page
op_lshift
l_int|8
suffix:semicolon
id|xfer_start
op_assign
(paren
r_void
op_star
)paren
id|dev-&gt;rmem_start
suffix:semicolon
id|count
op_sub_assign
id|semi_count
suffix:semicolon
)brace
id|copyin
c_func
(paren
id|buf
comma
id|xfer_start
comma
id|count
)paren
suffix:semicolon
)brace
multiline_comment|/*====================================================================*/
DECL|function|shmem_block_output
r_static
r_void
id|shmem_block_output
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_int
id|count
comma
r_const
id|u_char
op_star
id|buf
comma
r_const
r_int
id|start_page
)paren
(brace
r_void
op_star
id|shmem
op_assign
(paren
r_void
op_star
)paren
id|dev-&gt;mem_start
op_plus
(paren
id|start_page
op_lshift
l_int|8
)paren
suffix:semicolon
id|shmem
op_sub_assign
id|ei_status.tx_start_page
op_lshift
l_int|8
suffix:semicolon
id|copyout
c_func
(paren
id|shmem
comma
id|buf
comma
id|count
)paren
suffix:semicolon
)brace
multiline_comment|/*====================================================================*/
DECL|function|setup_shmem_window
r_static
r_int
id|setup_shmem_window
c_func
(paren
id|dev_link_t
op_star
id|link
comma
r_int
id|start_pg
comma
r_int
id|stop_pg
comma
r_int
id|cm_offset
)paren
(brace
r_struct
id|net_device
op_star
id|dev
op_assign
id|link-&gt;priv
suffix:semicolon
id|pcnet_dev_t
op_star
id|info
op_assign
id|link-&gt;priv
suffix:semicolon
id|win_req_t
id|req
suffix:semicolon
id|memreq_t
id|mem
suffix:semicolon
r_int
id|i
comma
id|window_size
comma
id|offset
comma
id|last_ret
comma
id|last_fn
suffix:semicolon
id|window_size
op_assign
(paren
id|stop_pg
op_minus
id|start_pg
)paren
op_lshift
l_int|8
suffix:semicolon
r_if
c_cond
(paren
id|window_size
OG
l_int|32
op_star
l_int|1024
)paren
id|window_size
op_assign
l_int|32
op_star
l_int|1024
suffix:semicolon
multiline_comment|/* Make sure it&squot;s a power of two.  */
r_while
c_loop
(paren
(paren
id|window_size
op_amp
(paren
id|window_size
op_minus
l_int|1
)paren
)paren
op_ne
l_int|0
)paren
id|window_size
op_add_assign
id|window_size
op_amp
op_complement
(paren
id|window_size
op_minus
l_int|1
)paren
suffix:semicolon
multiline_comment|/* Allocate a memory window */
id|req.Attributes
op_assign
id|WIN_DATA_WIDTH_16
op_or
id|WIN_MEMORY_TYPE_CM
op_or
id|WIN_ENABLE
suffix:semicolon
id|req.Attributes
op_or_assign
id|WIN_USE_WAIT
suffix:semicolon
id|req.Base
op_assign
l_int|0
suffix:semicolon
id|req.Size
op_assign
id|window_size
suffix:semicolon
id|req.AccessSpeed
op_assign
id|mem_speed
suffix:semicolon
id|link-&gt;win
op_assign
(paren
id|window_handle_t
)paren
id|link-&gt;handle
suffix:semicolon
id|CS_CHECK
c_func
(paren
id|RequestWindow
comma
op_amp
id|link-&gt;win
comma
op_amp
id|req
)paren
suffix:semicolon
id|mem.CardOffset
op_assign
(paren
id|start_pg
op_lshift
l_int|8
)paren
op_plus
id|cm_offset
suffix:semicolon
id|offset
op_assign
id|mem.CardOffset
op_mod
id|window_size
suffix:semicolon
id|mem.CardOffset
op_sub_assign
id|offset
suffix:semicolon
id|mem.Page
op_assign
l_int|0
suffix:semicolon
id|CS_CHECK
c_func
(paren
id|MapMemPage
comma
id|link-&gt;win
comma
op_amp
id|mem
)paren
suffix:semicolon
multiline_comment|/* Try scribbling on the buffer */
id|info-&gt;base
op_assign
id|ioremap
c_func
(paren
id|req.Base
comma
id|window_size
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
(paren
id|TX_PAGES
op_lshift
l_int|8
)paren
suffix:semicolon
id|i
op_add_assign
l_int|2
)paren
id|__raw_writew
c_func
(paren
(paren
id|i
op_rshift
l_int|1
)paren
comma
id|info-&gt;base
op_plus
id|offset
op_plus
id|i
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|100
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
(paren
id|TX_PAGES
op_lshift
l_int|8
)paren
suffix:semicolon
id|i
op_add_assign
l_int|2
)paren
r_if
c_cond
(paren
id|__raw_readw
c_func
(paren
id|info-&gt;base
op_plus
id|offset
op_plus
id|i
)paren
op_ne
(paren
id|i
op_rshift
l_int|1
)paren
)paren
r_break
suffix:semicolon
id|pcnet_reset_8390
c_func
(paren
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
op_ne
(paren
id|TX_PAGES
op_lshift
l_int|8
)paren
)paren
(brace
id|iounmap
c_func
(paren
id|info-&gt;base
)paren
suffix:semicolon
id|CardServices
c_func
(paren
id|ReleaseWindow
comma
id|link-&gt;win
)paren
suffix:semicolon
id|info-&gt;base
op_assign
l_int|NULL
suffix:semicolon
id|link-&gt;win
op_assign
l_int|NULL
suffix:semicolon
r_goto
id|failed
suffix:semicolon
)brace
id|dev-&gt;mem_start
op_assign
(paren
id|u_long
)paren
id|info-&gt;base
op_plus
id|offset
suffix:semicolon
id|dev-&gt;rmem_start
op_assign
id|dev-&gt;mem_start
op_plus
(paren
id|TX_PAGES
op_lshift
l_int|8
)paren
suffix:semicolon
id|dev-&gt;mem_end
op_assign
id|dev-&gt;rmem_end
op_assign
(paren
id|u_long
)paren
id|info-&gt;base
op_plus
id|req.Size
suffix:semicolon
id|ei_status.tx_start_page
op_assign
id|start_pg
suffix:semicolon
id|ei_status.rx_start_page
op_assign
id|start_pg
op_plus
id|TX_PAGES
suffix:semicolon
id|ei_status.stop_page
op_assign
id|start_pg
op_plus
(paren
(paren
id|req.Size
op_minus
id|offset
)paren
op_rshift
l_int|8
)paren
suffix:semicolon
multiline_comment|/* set up block i/o functions */
id|ei_status.get_8390_hdr
op_assign
op_amp
id|shmem_get_8390_hdr
suffix:semicolon
id|ei_status.block_input
op_assign
op_amp
id|shmem_block_input
suffix:semicolon
id|ei_status.block_output
op_assign
op_amp
id|shmem_block_output
suffix:semicolon
id|info-&gt;flags
op_or_assign
id|USE_SHMEM
suffix:semicolon
r_return
l_int|0
suffix:semicolon
id|cs_failed
suffix:colon
id|cs_error
c_func
(paren
id|link-&gt;handle
comma
id|last_fn
comma
id|last_ret
)paren
suffix:semicolon
id|failed
suffix:colon
r_return
l_int|1
suffix:semicolon
)brace
multiline_comment|/*====================================================================*/
DECL|function|init_pcnet_cs
r_static
r_int
id|__init
id|init_pcnet_cs
c_func
(paren
r_void
)paren
(brace
id|servinfo_t
id|serv
suffix:semicolon
id|DEBUG
c_func
(paren
l_int|0
comma
l_string|&quot;%s&bslash;n&quot;
comma
id|version
)paren
suffix:semicolon
id|CardServices
c_func
(paren
id|GetCardServicesInfo
comma
op_amp
id|serv
)paren
suffix:semicolon
r_if
c_cond
(paren
id|serv.Revision
op_ne
id|CS_RELEASE_CODE
)paren
(brace
id|printk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;pcnet_cs: Card Services release &quot;
l_string|&quot;does not match!&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|register_pccard_driver
c_func
(paren
op_amp
id|dev_info
comma
op_amp
id|pcnet_attach
comma
op_amp
id|pcnet_detach
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|exit_pcnet_cs
r_static
r_void
id|__exit
id|exit_pcnet_cs
c_func
(paren
r_void
)paren
(brace
id|DEBUG
c_func
(paren
l_int|0
comma
l_string|&quot;pcnet_cs: unloading&bslash;n&quot;
)paren
suffix:semicolon
id|unregister_pccard_driver
c_func
(paren
op_amp
id|dev_info
)paren
suffix:semicolon
r_while
c_loop
(paren
id|dev_list
op_ne
l_int|NULL
)paren
id|pcnet_detach
c_func
(paren
id|dev_list
)paren
suffix:semicolon
)brace
DECL|variable|init_pcnet_cs
id|module_init
c_func
(paren
id|init_pcnet_cs
)paren
suffix:semicolon
DECL|variable|exit_pcnet_cs
id|module_exit
c_func
(paren
id|exit_pcnet_cs
)paren
suffix:semicolon
eof
