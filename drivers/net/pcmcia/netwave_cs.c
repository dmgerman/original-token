multiline_comment|/*********************************************************************&n; *                &n; * Filename:      netwave_cs.c&n; * Version:       0.4.1&n; * Description:   Netwave AirSurfer Wireless LAN PC Card driver&n; * Status:        Experimental.&n; * Authors:       John Markus Bj&#xfffd;rndalen &lt;johnm@cs.uit.no&gt;&n; *                Dag Brattli &lt;dagb@cs.uit.no&gt;&n; *                David Hinds &lt;dahinds@users.sourceforge.net&gt;&n; * Created at:    A long time ago!&n; * Modified at:   Mon Nov 10 11:54:37 1997&n; * Modified by:   Dag Brattli &lt;dagb@cs.uit.no&gt;&n; * &n; *     Copyright (c) 1997 University of Troms&#xfffd;, Norway&n; *&n; * Revision History:&n; *&n; *   08-Nov-97 15:14:47   John Markus Bj&#xfffd;rndalen &lt;johnm@cs.uit.no&gt;&n; *    - Fixed some bugs in netwave_rx and cleaned it up a bit. &n; *      (One of the bugs would have destroyed packets when receiving&n; *      multiple packets per interrupt). &n; *    - Cleaned up parts of newave_hw_xmit. &n; *    - A few general cleanups. &n; *   24-Oct-97 13:17:36   Dag Brattli &lt;dagb@cs.uit.no&gt;&n; *    - Fixed netwave_rx receive function (got updated docs)&n; *   Others:&n; *    - Changed name from xircnw to netwave, take a look at &n; *      http://www.netwave-wireless.com&n; *    - Some reorganizing of the code&n; *    - Removed possible race condition between interrupt handler and transmit&n; *      function&n; *    - Started to add wireless extensions, but still needs some coding&n; *    - Added watchdog for better handling of transmission timeouts &n; *      (hopefully this works better)&n; ********************************************************************/
multiline_comment|/* To have statistics (just packets sent) define this */
DECL|macro|NETWAVE_STATS
macro_line|#undef NETWAVE_STATS
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/fcntl.h&gt;
macro_line|#include &lt;linux/interrupt.h&gt;
macro_line|#include &lt;linux/ptrace.h&gt;
macro_line|#include &lt;linux/ioport.h&gt;
macro_line|#include &lt;linux/in.h&gt;
macro_line|#include &lt;linux/malloc.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/timer.h&gt;
macro_line|#include &lt;asm/system.h&gt;
macro_line|#include &lt;asm/bitops.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/dma.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/netdevice.h&gt;
macro_line|#include &lt;linux/etherdevice.h&gt;
macro_line|#include &lt;linux/skbuff.h&gt;
macro_line|#ifdef CONFIG_NET_PCMCIA_RADIO
macro_line|#include &lt;linux/wireless.h&gt;
macro_line|#endif
macro_line|#include &lt;pcmcia/version.h&gt;
macro_line|#include &lt;pcmcia/cs_types.h&gt;
macro_line|#include &lt;pcmcia/cs.h&gt;
macro_line|#include &lt;pcmcia/cistpl.h&gt;
macro_line|#include &lt;pcmcia/cisreg.h&gt;
macro_line|#include &lt;pcmcia/ds.h&gt;
macro_line|#include &lt;pcmcia/mem_op.h&gt;
DECL|macro|NETWAVE_REGOFF
mdefine_line|#define NETWAVE_REGOFF         0x8000
multiline_comment|/* The Netwave IO registers, offsets to iobase */
DECL|macro|NETWAVE_REG_COR
mdefine_line|#define NETWAVE_REG_COR        0x0
DECL|macro|NETWAVE_REG_CCSR
mdefine_line|#define NETWAVE_REG_CCSR       0x2
DECL|macro|NETWAVE_REG_ASR
mdefine_line|#define NETWAVE_REG_ASR        0x4
DECL|macro|NETWAVE_REG_IMR
mdefine_line|#define NETWAVE_REG_IMR        0xa
DECL|macro|NETWAVE_REG_PMR
mdefine_line|#define NETWAVE_REG_PMR        0xc
DECL|macro|NETWAVE_REG_IOLOW
mdefine_line|#define NETWAVE_REG_IOLOW      0x6
DECL|macro|NETWAVE_REG_IOHI
mdefine_line|#define NETWAVE_REG_IOHI       0x7
DECL|macro|NETWAVE_REG_IOCONTROL
mdefine_line|#define NETWAVE_REG_IOCONTROL  0x8
DECL|macro|NETWAVE_REG_DATA
mdefine_line|#define NETWAVE_REG_DATA       0xf
multiline_comment|/* The Netwave Extended IO registers, offsets to RamBase */
DECL|macro|NETWAVE_EREG_ASCC
mdefine_line|#define NETWAVE_EREG_ASCC      0x114
DECL|macro|NETWAVE_EREG_RSER
mdefine_line|#define NETWAVE_EREG_RSER      0x120
DECL|macro|NETWAVE_EREG_RSERW
mdefine_line|#define NETWAVE_EREG_RSERW     0x124
DECL|macro|NETWAVE_EREG_TSER
mdefine_line|#define NETWAVE_EREG_TSER      0x130
DECL|macro|NETWAVE_EREG_TSERW
mdefine_line|#define NETWAVE_EREG_TSERW     0x134
DECL|macro|NETWAVE_EREG_CB
mdefine_line|#define NETWAVE_EREG_CB        0x100
DECL|macro|NETWAVE_EREG_SPCQ
mdefine_line|#define NETWAVE_EREG_SPCQ      0x154
DECL|macro|NETWAVE_EREG_SPU
mdefine_line|#define NETWAVE_EREG_SPU       0x155
DECL|macro|NETWAVE_EREG_LIF
mdefine_line|#define NETWAVE_EREG_LIF       0x14e
DECL|macro|NETWAVE_EREG_ISPLQ
mdefine_line|#define NETWAVE_EREG_ISPLQ     0x156
DECL|macro|NETWAVE_EREG_HHC
mdefine_line|#define NETWAVE_EREG_HHC       0x158
DECL|macro|NETWAVE_EREG_NI
mdefine_line|#define NETWAVE_EREG_NI        0x16e
DECL|macro|NETWAVE_EREG_MHS
mdefine_line|#define NETWAVE_EREG_MHS       0x16b
DECL|macro|NETWAVE_EREG_TDP
mdefine_line|#define NETWAVE_EREG_TDP       0x140
DECL|macro|NETWAVE_EREG_RDP
mdefine_line|#define NETWAVE_EREG_RDP       0x150
DECL|macro|NETWAVE_EREG_PA
mdefine_line|#define NETWAVE_EREG_PA        0x160
DECL|macro|NETWAVE_EREG_EC
mdefine_line|#define NETWAVE_EREG_EC        0x180
DECL|macro|NETWAVE_EREG_CRBP
mdefine_line|#define NETWAVE_EREG_CRBP      0x17a
DECL|macro|NETWAVE_EREG_ARW
mdefine_line|#define NETWAVE_EREG_ARW       0x166
multiline_comment|/*&n; * Commands used in the extended command buffer&n; * NETWAVE_EREG_CB (0x100-0x10F) &n; */
DECL|macro|NETWAVE_CMD_NOP
mdefine_line|#define NETWAVE_CMD_NOP        0x00
DECL|macro|NETWAVE_CMD_SRC
mdefine_line|#define NETWAVE_CMD_SRC        0x01
DECL|macro|NETWAVE_CMD_STC
mdefine_line|#define NETWAVE_CMD_STC        0x02
DECL|macro|NETWAVE_CMD_AMA
mdefine_line|#define NETWAVE_CMD_AMA        0x03
DECL|macro|NETWAVE_CMD_DMA
mdefine_line|#define NETWAVE_CMD_DMA        0x04
DECL|macro|NETWAVE_CMD_SAMA
mdefine_line|#define NETWAVE_CMD_SAMA       0x05
DECL|macro|NETWAVE_CMD_ER
mdefine_line|#define NETWAVE_CMD_ER         0x06
DECL|macro|NETWAVE_CMD_DR
mdefine_line|#define NETWAVE_CMD_DR         0x07
DECL|macro|NETWAVE_CMD_TL
mdefine_line|#define NETWAVE_CMD_TL         0x08
DECL|macro|NETWAVE_CMD_SRP
mdefine_line|#define NETWAVE_CMD_SRP        0x09
DECL|macro|NETWAVE_CMD_SSK
mdefine_line|#define NETWAVE_CMD_SSK        0x0a
DECL|macro|NETWAVE_CMD_SMD
mdefine_line|#define NETWAVE_CMD_SMD        0x0b
DECL|macro|NETWAVE_CMD_SAPD
mdefine_line|#define NETWAVE_CMD_SAPD       0x0c
DECL|macro|NETWAVE_CMD_SSS
mdefine_line|#define NETWAVE_CMD_SSS        0x11
multiline_comment|/* End of Command marker */
DECL|macro|NETWAVE_CMD_EOC
mdefine_line|#define NETWAVE_CMD_EOC        0x00
multiline_comment|/* ASR register bits */
DECL|macro|NETWAVE_ASR_RXRDY
mdefine_line|#define NETWAVE_ASR_RXRDY   0x80
DECL|macro|NETWAVE_ASR_TXBA
mdefine_line|#define NETWAVE_ASR_TXBA    0x01
DECL|macro|TX_TIMEOUT
mdefine_line|#define TX_TIMEOUT&t;&t;((32*HZ)/100)
DECL|variable|imrConfRFU1
r_static
r_const
r_int
r_int
id|imrConfRFU1
op_assign
l_int|0x10
suffix:semicolon
multiline_comment|/* RFU interrupt mask, keep high */
DECL|variable|imrConfIENA
r_static
r_const
r_int
r_int
id|imrConfIENA
op_assign
l_int|0x02
suffix:semicolon
multiline_comment|/* Interrupt enable */
DECL|variable|corConfIENA
r_static
r_const
r_int
r_int
id|corConfIENA
op_assign
l_int|0x01
suffix:semicolon
multiline_comment|/* Interrupt enable */
DECL|variable|corConfLVLREQ
r_static
r_const
r_int
r_int
id|corConfLVLREQ
op_assign
l_int|0x40
suffix:semicolon
multiline_comment|/* Keep high */
DECL|variable|rxConfRxEna
r_static
r_const
r_int
r_int
id|rxConfRxEna
op_assign
l_int|0x80
suffix:semicolon
multiline_comment|/* Receive Enable */
DECL|variable|rxConfMAC
r_static
r_const
r_int
r_int
id|rxConfMAC
op_assign
l_int|0x20
suffix:semicolon
multiline_comment|/* MAC host receive mode*/
DECL|variable|rxConfPro
r_static
r_const
r_int
r_int
id|rxConfPro
op_assign
l_int|0x10
suffix:semicolon
multiline_comment|/* Promiscuous */
DECL|variable|rxConfAMP
r_static
r_const
r_int
r_int
id|rxConfAMP
op_assign
l_int|0x08
suffix:semicolon
multiline_comment|/* Accept Multicast Packets */
DECL|variable|rxConfBcast
r_static
r_const
r_int
r_int
id|rxConfBcast
op_assign
l_int|0x04
suffix:semicolon
multiline_comment|/* Accept Broadcast Packets */
DECL|variable|txConfTxEna
r_static
r_const
r_int
r_int
id|txConfTxEna
op_assign
l_int|0x80
suffix:semicolon
multiline_comment|/* Transmit Enable */
DECL|variable|txConfMAC
r_static
r_const
r_int
r_int
id|txConfMAC
op_assign
l_int|0x20
suffix:semicolon
multiline_comment|/* Host sends MAC mode */
DECL|variable|txConfEUD
r_static
r_const
r_int
r_int
id|txConfEUD
op_assign
l_int|0x10
suffix:semicolon
multiline_comment|/* Enable Uni-Data packets */
DECL|variable|txConfKey
r_static
r_const
r_int
r_int
id|txConfKey
op_assign
l_int|0x02
suffix:semicolon
multiline_comment|/* Scramble data packets */
DECL|variable|txConfLoop
r_static
r_const
r_int
r_int
id|txConfLoop
op_assign
l_int|0x01
suffix:semicolon
multiline_comment|/* Loopback mode */
multiline_comment|/*&n;   All the PCMCIA modules use PCMCIA_DEBUG to control debugging.  If&n;   you do not define PCMCIA_DEBUG at all, all the debug code will be&n;   left out.  If you compile with PCMCIA_DEBUG=0, the debug code will&n;   be present but disabled -- but it can then be enabled for specific&n;   modules at load time with a &squot;pc_debug=#&squot; option to insmod.&n;*/
macro_line|#ifdef PCMCIA_DEBUG
DECL|variable|pc_debug
r_static
r_int
id|pc_debug
op_assign
id|PCMCIA_DEBUG
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|pc_debug
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
DECL|macro|DEBUG
mdefine_line|#define DEBUG(n, args...) if (pc_debug&gt;(n)) printk(KERN_DEBUG args)
DECL|variable|version
r_static
r_char
op_star
id|version
op_assign
l_string|&quot;netwave_cs.c 0.3.0 Thu Jul 17 14:36:02 1997 (John Markus Bj&#xfffd;rndalen)&bslash;n&quot;
suffix:semicolon
macro_line|#else
DECL|macro|DEBUG
mdefine_line|#define DEBUG(n, args...)
macro_line|#endif
DECL|variable|dev_info
r_static
id|dev_info_t
id|dev_info
op_assign
l_string|&quot;netwave_cs&quot;
suffix:semicolon
multiline_comment|/*====================================================================*/
multiline_comment|/* Parameters that can be set with &squot;insmod&squot; */
multiline_comment|/* Choose the domain, default is 0x100 */
DECL|variable|domain
r_static
id|u_int
id|domain
op_assign
l_int|0x100
suffix:semicolon
multiline_comment|/* Scramble key, range from 0x0 to 0xffff.  &n; * 0x0 is no scrambling. &n; */
DECL|variable|scramble_key
r_static
id|u_int
id|scramble_key
op_assign
l_int|0x0
suffix:semicolon
multiline_comment|/* Shared memory speed, in ns. The documentation states that &n; * the card should not be read faster than every 400ns. &n; * This timing should be provided by the HBA. If it becomes a &n; * problem, try setting mem_speed to 400. &n; */
DECL|variable|mem_speed
r_static
r_int
id|mem_speed
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Bit map of interrupts to choose from */
multiline_comment|/* This means pick from 15, 14, 12, 11, 10, 9, 7, 5, 4, and 3 */
DECL|variable|irq_mask
r_static
id|u_int
id|irq_mask
op_assign
l_int|0xdeb8
suffix:semicolon
DECL|variable|irq_list
r_static
r_int
id|irq_list
(braket
l_int|4
)braket
op_assign
(brace
op_minus
l_int|1
)brace
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|domain
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|scramble_key
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|mem_speed
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|irq_mask
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|irq_list
comma
l_string|&quot;1-4i&quot;
)paren
suffix:semicolon
multiline_comment|/*====================================================================*/
multiline_comment|/* PCMCIA (Card Services) related functions */
r_static
r_void
id|netwave_release
c_func
(paren
id|u_long
id|arg
)paren
suffix:semicolon
multiline_comment|/* Card removal */
r_static
r_int
id|netwave_event
c_func
(paren
id|event_t
id|event
comma
r_int
id|priority
comma
id|event_callback_args_t
op_star
id|args
)paren
suffix:semicolon
r_static
r_void
id|netwave_pcmcia_config
c_func
(paren
id|dev_link_t
op_star
id|arg
)paren
suffix:semicolon
multiline_comment|/* Runs after card &n;&t;&t;&t;&t;&t;&t;&t;&t;&t;&t;&t;&t;&t;   insertion */
r_static
id|dev_link_t
op_star
id|netwave_attach
c_func
(paren
r_void
)paren
suffix:semicolon
multiline_comment|/* Create instance */
r_static
r_void
id|netwave_detach
c_func
(paren
id|dev_link_t
op_star
)paren
suffix:semicolon
multiline_comment|/* Destroy instance */
r_static
r_void
id|netwave_flush_stale_links
c_func
(paren
r_void
)paren
suffix:semicolon
multiline_comment|/* Destroy all staled instances */
multiline_comment|/* Hardware configuration */
r_static
r_void
id|netwave_doreset
c_func
(paren
id|ioaddr_t
id|iobase
comma
id|u_char
op_star
id|ramBase
)paren
suffix:semicolon
r_static
r_void
id|netwave_reset
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
multiline_comment|/* Misc device stuff */
r_static
r_int
id|netwave_open
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
multiline_comment|/* Open the device */
r_static
r_int
id|netwave_close
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
multiline_comment|/* Close the device */
r_static
r_int
id|netwave_config
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_struct
id|ifmap
op_star
id|map
)paren
suffix:semicolon
multiline_comment|/* Packet transmission and Packet reception */
r_static
r_int
id|netwave_start_xmit
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_int
id|netwave_rx
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
multiline_comment|/* Interrupt routines */
r_static
r_void
id|netwave_interrupt
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
suffix:semicolon
r_static
r_void
id|netwave_watchdog
c_func
(paren
r_struct
id|net_device
op_star
)paren
suffix:semicolon
multiline_comment|/* Statistics */
r_static
r_void
id|update_stats
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_struct
id|net_device_stats
op_star
id|netwave_get_stats
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
multiline_comment|/* Wireless extensions */
macro_line|#ifdef WIRELESS_EXT
r_static
r_struct
id|iw_statistics
op_star
id|netwave_get_wireless_stats
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
macro_line|#endif
r_static
r_int
id|netwave_ioctl
c_func
(paren
r_struct
id|net_device
op_star
comma
r_struct
id|ifreq
op_star
comma
r_int
)paren
suffix:semicolon
r_static
r_void
id|set_multicast_list
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
multiline_comment|/*&n;   A linked list of &quot;instances&quot; of the skeleton device.  Each actual&n;   PCMCIA card corresponds to one device instance, and is described&n;   by one dev_link_t structure (defined in ds.h).&n;&n;   You may not want to use a linked list for this -- for example, the&n;   memory card driver uses an array of dev_link_t pointers, where minor&n;   device numbers are used to derive the corresponding array index.&n;*/
DECL|variable|dev_list
r_static
id|dev_link_t
op_star
id|dev_list
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/*&n;   A dev_link_t structure has fields for most things that are needed&n;   to keep track of a socket, but there will usually be some device&n;   specific information that also needs to be kept track of.  The&n;   &squot;priv&squot; pointer in a dev_link_t structure can be used to point to&n;   a device-specific private data structure, like this.&n;&n;   A driver needs to provide a dev_node_t structure for each device&n;   on a card.  In some cases, there is only one device per card (for&n;   example, ethernet cards, modems).  In other cases, there may be&n;   many actual or logical devices (SCSI adapters, memory cards with&n;   multiple partitions).  The dev_node_t structures need to be kept&n;   in a linked list starting at the &squot;dev&squot; field of a dev_link_t&n;   structure.  We allocate them in the card&squot;s private data structure,&n;   because they generally can&squot;t be allocated dynamically.&n;*/
DECL|macro|SIOCGIPSNAP
mdefine_line|#define SIOCGIPSNAP&t;SIOCDEVPRIVATE&t;&t;/* Site Survey Snapshot */
multiline_comment|/*#define SIOCGIPQTHR&t;SIOCDEVPRIVATE + 1*/
DECL|macro|MAX_ESA
mdefine_line|#define MAX_ESA 10
DECL|struct|net_addr
r_typedef
r_struct
id|net_addr
(brace
DECL|member|addr48
id|u_char
id|addr48
(braket
l_int|6
)braket
suffix:semicolon
DECL|typedef|net_addr
)brace
id|net_addr
suffix:semicolon
DECL|struct|site_survey
r_struct
id|site_survey
(brace
DECL|member|length
id|u_short
id|length
suffix:semicolon
DECL|member|struct_revision
id|u_char
id|struct_revision
suffix:semicolon
DECL|member|roaming_state
id|u_char
id|roaming_state
suffix:semicolon
DECL|member|sp_existsFlag
id|u_char
id|sp_existsFlag
suffix:semicolon
DECL|member|sp_link_quality
id|u_char
id|sp_link_quality
suffix:semicolon
DECL|member|sp_max_link_quality
id|u_char
id|sp_max_link_quality
suffix:semicolon
DECL|member|linkQualityGoodFairBoundary
id|u_char
id|linkQualityGoodFairBoundary
suffix:semicolon
DECL|member|linkQualityFairPoorBoundary
id|u_char
id|linkQualityFairPoorBoundary
suffix:semicolon
DECL|member|sp_utilization
id|u_char
id|sp_utilization
suffix:semicolon
DECL|member|sp_goodness
id|u_char
id|sp_goodness
suffix:semicolon
DECL|member|sp_hotheadcount
id|u_char
id|sp_hotheadcount
suffix:semicolon
DECL|member|roaming_condition
id|u_char
id|roaming_condition
suffix:semicolon
DECL|member|sp
id|net_addr
id|sp
suffix:semicolon
DECL|member|numAPs
id|u_char
id|numAPs
suffix:semicolon
DECL|member|nearByAccessPoints
id|net_addr
id|nearByAccessPoints
(braket
id|MAX_ESA
)braket
suffix:semicolon
)brace
suffix:semicolon
DECL|struct|netwave_private
r_typedef
r_struct
id|netwave_private
(brace
DECL|member|link
id|dev_link_t
id|link
suffix:semicolon
DECL|member|dev
r_struct
id|net_device
id|dev
suffix:semicolon
DECL|member|node
id|dev_node_t
id|node
suffix:semicolon
DECL|member|ramBase
id|u_char
op_star
id|ramBase
suffix:semicolon
DECL|member|timeoutCounter
r_int
id|timeoutCounter
suffix:semicolon
DECL|member|lastExec
r_int
id|lastExec
suffix:semicolon
DECL|member|watchdog
r_struct
id|timer_list
id|watchdog
suffix:semicolon
multiline_comment|/* To avoid blocking state */
DECL|member|nss
r_struct
id|site_survey
id|nss
suffix:semicolon
DECL|member|stats
r_struct
id|net_device_stats
id|stats
suffix:semicolon
macro_line|#ifdef WIRELESS_EXT
DECL|member|iw_stats
r_struct
id|iw_statistics
id|iw_stats
suffix:semicolon
multiline_comment|/* Wireless stats */
macro_line|#endif
DECL|typedef|netwave_private
)brace
id|netwave_private
suffix:semicolon
macro_line|#ifdef NETWAVE_STATS
r_static
r_struct
id|net_device_stats
op_star
id|netwave_get_stats
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/*&n; * The Netwave card is little-endian, so won&squot;t work for big endian&n; * systems.&n; */
DECL|function|get_uint16
r_static
r_inline
r_int
r_int
id|get_uint16
c_func
(paren
id|u_char
op_star
id|staddr
)paren
(brace
r_return
id|readw
c_func
(paren
id|staddr
)paren
suffix:semicolon
multiline_comment|/* Return only 16 bits */
)brace
DECL|function|get_int16
r_static
r_inline
r_int
id|get_int16
c_func
(paren
id|u_char
op_star
id|staddr
)paren
(brace
r_return
id|readw
c_func
(paren
id|staddr
)paren
suffix:semicolon
)brace
multiline_comment|/**************************************************************************/
DECL|function|cs_error
r_static
r_void
id|cs_error
c_func
(paren
id|client_handle_t
id|handle
comma
r_int
id|func
comma
r_int
id|ret
)paren
(brace
id|error_info_t
id|err
op_assign
(brace
id|func
comma
id|ret
)brace
suffix:semicolon
id|CardServices
c_func
(paren
id|ReportError
comma
id|handle
comma
op_amp
id|err
)paren
suffix:semicolon
)brace
multiline_comment|/* &n; * Wait until the WOC (Write Operation Complete) bit in the &n; * ASR (Adapter Status Register) is asserted. &n; * This should have aborted if it takes too long time. &n; */
DECL|function|wait_WOC
r_static
r_inline
r_void
id|wait_WOC
c_func
(paren
r_int
r_int
id|iobase
)paren
(brace
multiline_comment|/* Spin lock */
r_while
c_loop
(paren
(paren
id|inb
c_func
(paren
id|iobase
op_plus
id|NETWAVE_REG_ASR
)paren
op_amp
l_int|0x8
)paren
op_ne
l_int|0x8
)paren
suffix:semicolon
)brace
macro_line|#ifdef WIRELESS_EXT
DECL|function|netwave_snapshot
r_static
r_void
id|netwave_snapshot
c_func
(paren
id|netwave_private
op_star
id|priv
comma
id|u_char
op_star
id|ramBase
comma
id|ioaddr_t
id|iobase
)paren
(brace
id|u_short
id|resultBuffer
suffix:semicolon
multiline_comment|/* if time since last snapshot is &gt; 1 sec. (100 jiffies?)  then take &n;     * new snapshot, else return cached data. This is the recommended rate.  &n;     */
r_if
c_cond
(paren
id|jiffies
op_minus
id|priv-&gt;lastExec
OG
l_int|100
)paren
(brace
multiline_comment|/* Take site survey  snapshot */
multiline_comment|/*printk( KERN_DEBUG &quot;Taking new snapshot. %ld&bslash;n&quot;, jiffies -&n;&t;  priv-&gt;lastExec); */
id|wait_WOC
c_func
(paren
id|iobase
)paren
suffix:semicolon
id|writeb
c_func
(paren
id|NETWAVE_CMD_SSS
comma
id|ramBase
op_plus
id|NETWAVE_EREG_CB
op_plus
l_int|0
)paren
suffix:semicolon
id|writeb
c_func
(paren
id|NETWAVE_CMD_EOC
comma
id|ramBase
op_plus
id|NETWAVE_EREG_CB
op_plus
l_int|1
)paren
suffix:semicolon
id|wait_WOC
c_func
(paren
id|iobase
)paren
suffix:semicolon
multiline_comment|/* Get result and copy to cach */
id|resultBuffer
op_assign
id|readw
c_func
(paren
id|ramBase
op_plus
id|NETWAVE_EREG_CRBP
)paren
suffix:semicolon
id|copy_from_pc
c_func
(paren
op_amp
id|priv-&gt;nss
comma
id|ramBase
op_plus
id|resultBuffer
comma
r_sizeof
(paren
r_struct
id|site_survey
)paren
)paren
suffix:semicolon
)brace
)brace
macro_line|#endif
macro_line|#ifdef WIRELESS_EXT
multiline_comment|/*&n; * Function netwave_get_wireless_stats (dev)&n; *&n; *    Wireless extensions statistics&n; *&n; */
DECL|function|netwave_get_wireless_stats
r_static
r_struct
id|iw_statistics
op_star
id|netwave_get_wireless_stats
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
id|ioaddr_t
id|iobase
op_assign
id|dev-&gt;base_addr
suffix:semicolon
id|netwave_private
op_star
id|priv
op_assign
(paren
id|netwave_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|u_char
op_star
id|ramBase
op_assign
id|priv-&gt;ramBase
suffix:semicolon
r_struct
id|iw_statistics
op_star
id|wstats
suffix:semicolon
id|wstats
op_assign
op_amp
id|priv-&gt;iw_stats
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|netwave_snapshot
c_func
(paren
id|priv
comma
id|ramBase
comma
id|iobase
)paren
suffix:semicolon
id|wstats-&gt;status
op_assign
id|priv-&gt;nss.roaming_state
suffix:semicolon
id|wstats-&gt;qual.qual
op_assign
id|readb
c_func
(paren
id|ramBase
op_plus
id|NETWAVE_EREG_SPCQ
)paren
suffix:semicolon
id|wstats-&gt;qual.level
op_assign
id|readb
c_func
(paren
id|ramBase
op_plus
id|NETWAVE_EREG_ISPLQ
)paren
suffix:semicolon
id|wstats-&gt;qual.noise
op_assign
id|readb
c_func
(paren
id|ramBase
op_plus
id|NETWAVE_EREG_SPU
)paren
op_amp
l_int|0x3f
suffix:semicolon
id|wstats-&gt;discard.nwid
op_assign
l_int|0L
suffix:semicolon
id|wstats-&gt;discard.code
op_assign
l_int|0L
suffix:semicolon
id|wstats-&gt;discard.misc
op_assign
l_int|0L
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
op_amp
id|priv-&gt;iw_stats
suffix:semicolon
)brace
macro_line|#endif
multiline_comment|/*&n; * Function netwave_attach (void)&n; *&n; *     Creates an &quot;instance&quot; of the driver, allocating local data &n; *     structures for one device.  The device is registered with Card &n; *     Services.&n; *&n; *     The dev_link structure is initialized, but we don&squot;t actually&n; *     configure the card at this point -- we wait until we receive a&n; *     card insertion event.&n; */
DECL|function|netwave_attach
r_static
id|dev_link_t
op_star
id|netwave_attach
c_func
(paren
r_void
)paren
(brace
id|client_reg_t
id|client_reg
suffix:semicolon
id|dev_link_t
op_star
id|link
suffix:semicolon
r_struct
id|net_device
op_star
id|dev
suffix:semicolon
id|netwave_private
op_star
id|priv
suffix:semicolon
r_int
id|i
comma
id|ret
suffix:semicolon
id|DEBUG
c_func
(paren
l_int|0
comma
l_string|&quot;netwave_attach()&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* Perform some cleanup */
id|netwave_flush_stale_links
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* Initialize the dev_link_t structure */
id|priv
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
op_star
id|priv
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|priv
)paren
r_return
l_int|NULL
suffix:semicolon
id|memset
c_func
(paren
id|priv
comma
l_int|0
comma
r_sizeof
(paren
op_star
id|priv
)paren
)paren
suffix:semicolon
id|link
op_assign
op_amp
id|priv-&gt;link
suffix:semicolon
id|dev
op_assign
op_amp
id|priv-&gt;dev
suffix:semicolon
id|link-&gt;priv
op_assign
id|dev-&gt;priv
op_assign
id|priv
suffix:semicolon
id|link-&gt;release.function
op_assign
op_amp
id|netwave_release
suffix:semicolon
id|link-&gt;release.data
op_assign
(paren
id|u_long
)paren
id|link
suffix:semicolon
multiline_comment|/* The io structure describes IO port mapping */
id|link-&gt;io.NumPorts1
op_assign
l_int|16
suffix:semicolon
id|link-&gt;io.Attributes1
op_assign
id|IO_DATA_PATH_WIDTH_16
suffix:semicolon
multiline_comment|/* link-&gt;io.NumPorts2 = 16; &n;       link-&gt;io.Attributes2 = IO_DATA_PATH_WIDTH_16; */
id|link-&gt;io.IOAddrLines
op_assign
l_int|5
suffix:semicolon
multiline_comment|/* Interrupt setup */
id|link-&gt;irq.Attributes
op_assign
id|IRQ_TYPE_EXCLUSIVE
op_or
id|IRQ_HANDLE_PRESENT
suffix:semicolon
id|link-&gt;irq.IRQInfo1
op_assign
id|IRQ_INFO2_VALID
op_or
id|IRQ_LEVEL_ID
suffix:semicolon
r_if
c_cond
(paren
id|irq_list
(braket
l_int|0
)braket
op_eq
op_minus
l_int|1
)paren
id|link-&gt;irq.IRQInfo2
op_assign
id|irq_mask
suffix:semicolon
r_else
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|4
suffix:semicolon
id|i
op_increment
)paren
id|link-&gt;irq.IRQInfo2
op_or_assign
l_int|1
op_lshift
id|irq_list
(braket
id|i
)braket
suffix:semicolon
id|link-&gt;irq.Handler
op_assign
op_amp
id|netwave_interrupt
suffix:semicolon
multiline_comment|/* General socket configuration */
id|link-&gt;conf.Attributes
op_assign
id|CONF_ENABLE_IRQ
suffix:semicolon
id|link-&gt;conf.Vcc
op_assign
l_int|50
suffix:semicolon
id|link-&gt;conf.IntType
op_assign
id|INT_MEMORY_AND_IO
suffix:semicolon
id|link-&gt;conf.ConfigIndex
op_assign
l_int|1
suffix:semicolon
id|link-&gt;conf.Present
op_assign
id|PRESENT_OPTION
suffix:semicolon
multiline_comment|/* Netwave specific entries in the device structure */
id|dev-&gt;hard_start_xmit
op_assign
op_amp
id|netwave_start_xmit
suffix:semicolon
id|dev-&gt;set_config
op_assign
op_amp
id|netwave_config
suffix:semicolon
id|dev-&gt;get_stats
op_assign
op_amp
id|netwave_get_stats
suffix:semicolon
id|dev-&gt;set_multicast_list
op_assign
op_amp
id|set_multicast_list
suffix:semicolon
multiline_comment|/* wireless extensions */
macro_line|#ifdef WIRELESS_EXT
id|dev-&gt;get_wireless_stats
op_assign
op_amp
id|netwave_get_wireless_stats
suffix:semicolon
macro_line|#endif
id|dev-&gt;do_ioctl
op_assign
op_amp
id|netwave_ioctl
suffix:semicolon
id|dev-&gt;tx_timeout
op_assign
op_amp
id|netwave_watchdog
suffix:semicolon
id|dev-&gt;watchdog_timeo
op_assign
id|TX_TIMEOUT
suffix:semicolon
id|ether_setup
c_func
(paren
id|dev
)paren
suffix:semicolon
id|dev-&gt;open
op_assign
op_amp
id|netwave_open
suffix:semicolon
id|dev-&gt;stop
op_assign
op_amp
id|netwave_close
suffix:semicolon
id|link-&gt;irq.Instance
op_assign
id|dev
suffix:semicolon
multiline_comment|/* Register with Card Services */
id|link-&gt;next
op_assign
id|dev_list
suffix:semicolon
id|dev_list
op_assign
id|link
suffix:semicolon
id|client_reg.dev_info
op_assign
op_amp
id|dev_info
suffix:semicolon
id|client_reg.Attributes
op_assign
id|INFO_IO_CLIENT
op_or
id|INFO_CARD_SHARE
suffix:semicolon
id|client_reg.EventMask
op_assign
id|CS_EVENT_CARD_INSERTION
op_or
id|CS_EVENT_CARD_REMOVAL
op_or
id|CS_EVENT_RESET_PHYSICAL
op_or
id|CS_EVENT_CARD_RESET
op_or
id|CS_EVENT_PM_SUSPEND
op_or
id|CS_EVENT_PM_RESUME
suffix:semicolon
id|client_reg.event_handler
op_assign
op_amp
id|netwave_event
suffix:semicolon
id|client_reg.Version
op_assign
l_int|0x0210
suffix:semicolon
id|client_reg.event_callback_args.client_data
op_assign
id|link
suffix:semicolon
id|ret
op_assign
id|CardServices
c_func
(paren
id|RegisterClient
comma
op_amp
id|link-&gt;handle
comma
op_amp
id|client_reg
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
op_ne
l_int|0
)paren
(brace
id|cs_error
c_func
(paren
id|link-&gt;handle
comma
id|RegisterClient
comma
id|ret
)paren
suffix:semicolon
id|netwave_detach
c_func
(paren
id|link
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
r_return
id|link
suffix:semicolon
)brace
multiline_comment|/* netwave_attach */
multiline_comment|/*&n; * Function netwave_detach (link)&n; *&n; *    This deletes a driver &quot;instance&quot;.  The device is de-registered&n; *    with Card Services.  If it has been released, all local data&n; *    structures are freed.  Otherwise, the structures will be freed&n; *    when the device is released.&n; */
DECL|function|netwave_detach
r_static
r_void
id|netwave_detach
c_func
(paren
id|dev_link_t
op_star
id|link
)paren
(brace
id|netwave_private
op_star
id|priv
op_assign
id|link-&gt;priv
suffix:semicolon
id|dev_link_t
op_star
op_star
id|linkp
suffix:semicolon
id|DEBUG
c_func
(paren
l_int|0
comma
l_string|&quot;netwave_detach(0x%p)&bslash;n&quot;
comma
id|link
)paren
suffix:semicolon
multiline_comment|/*&n;&t;  If the device is currently configured and active, we won&squot;t&n;&t;  actually delete it yet.  Instead, it is marked so that when&n;&t;  the release() function is called, that will trigger a proper&n;&t;  detach().&n;&t;*/
id|del_timer
c_func
(paren
op_amp
id|link-&gt;release
)paren
suffix:semicolon
r_if
c_cond
(paren
id|link-&gt;state
op_amp
id|DEV_CONFIG
)paren
(brace
id|netwave_release
c_func
(paren
(paren
id|u_long
)paren
id|link
)paren
suffix:semicolon
r_if
c_cond
(paren
id|link-&gt;state
op_amp
id|DEV_STALE_CONFIG
)paren
(brace
id|DEBUG
c_func
(paren
l_int|1
comma
l_string|&quot;netwave_cs: detach postponed, &squot;%s&squot; still &quot;
l_string|&quot;locked&bslash;n&quot;
comma
id|link-&gt;dev-&gt;dev_name
)paren
suffix:semicolon
id|link-&gt;state
op_or_assign
id|DEV_STALE_LINK
suffix:semicolon
r_return
suffix:semicolon
)brace
)brace
multiline_comment|/* Break the link with Card Services */
r_if
c_cond
(paren
id|link-&gt;handle
)paren
id|CardServices
c_func
(paren
id|DeregisterClient
comma
id|link-&gt;handle
)paren
suffix:semicolon
multiline_comment|/* Locate device structure */
r_for
c_loop
(paren
id|linkp
op_assign
op_amp
id|dev_list
suffix:semicolon
op_star
id|linkp
suffix:semicolon
id|linkp
op_assign
op_amp
(paren
op_star
id|linkp
)paren
op_member_access_from_pointer
id|next
)paren
r_if
c_cond
(paren
op_star
id|linkp
op_eq
id|link
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
op_star
id|linkp
op_eq
l_int|NULL
)paren
(brace
id|DEBUG
c_func
(paren
l_int|1
comma
l_string|&quot;netwave_cs: detach fail, &squot;%s&squot; not in list&bslash;n&quot;
comma
id|link-&gt;dev-&gt;dev_name
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/* Unlink device structure, free pieces */
op_star
id|linkp
op_assign
id|link-&gt;next
suffix:semicolon
r_if
c_cond
(paren
id|link-&gt;dev
)paren
id|unregister_netdev
c_func
(paren
op_amp
id|priv-&gt;dev
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|priv
)paren
suffix:semicolon
)brace
multiline_comment|/* netwave_detach */
multiline_comment|/*&n; * Function netwave_flush_stale_links (void)&n; *&n; *    This deletes all driver &quot;instances&quot; that need to be deleted.&n; *    Sometimes, netwave_detach can&squot;t be performed following a call from&n; *    cardmgr (device still open) and the device is put in a STALE_LINK&n; *    state.&n; *    This function is in charge of making the cleanup...&n; */
DECL|function|netwave_flush_stale_links
r_static
r_void
id|netwave_flush_stale_links
c_func
(paren
r_void
)paren
(brace
id|dev_link_t
op_star
id|link
suffix:semicolon
multiline_comment|/* Current node in linked list */
id|dev_link_t
op_star
id|next
suffix:semicolon
multiline_comment|/* Next node in linked list */
id|DEBUG
c_func
(paren
l_int|1
comma
l_string|&quot;netwave_flush_stale_links(0x%p)&bslash;n&quot;
comma
id|dev_list
)paren
suffix:semicolon
multiline_comment|/* Go through the list */
r_for
c_loop
(paren
id|link
op_assign
id|dev_list
suffix:semicolon
id|link
suffix:semicolon
id|link
op_assign
id|next
)paren
(brace
id|next
op_assign
id|link-&gt;next
suffix:semicolon
multiline_comment|/* Check if in need of being removed */
r_if
c_cond
(paren
id|link-&gt;state
op_amp
id|DEV_STALE_LINK
)paren
(brace
id|netwave_detach
c_func
(paren
id|link
)paren
suffix:semicolon
)brace
)brace
)brace
multiline_comment|/* netwave_flush_stale_links */
multiline_comment|/*&n; * Function netwave_ioctl (dev, rq, cmd)&n; *&n; *     Perform ioctl : config &amp; info stuff&n; *     This is the stuff that are treated the wireless extensions (iwconfig)&n; *&n; */
DECL|function|netwave_ioctl
r_static
r_int
id|netwave_ioctl
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
multiline_comment|/* ioctl device */
r_struct
id|ifreq
op_star
id|rq
comma
multiline_comment|/* Data passed */
r_int
id|cmd
)paren
multiline_comment|/* Ioctl number */
(brace
r_int
r_int
id|flags
suffix:semicolon
r_int
id|ret
op_assign
l_int|0
suffix:semicolon
macro_line|#ifdef WIRELESS_EXT
id|ioaddr_t
id|iobase
op_assign
id|dev-&gt;base_addr
suffix:semicolon
id|netwave_private
op_star
id|priv
op_assign
(paren
id|netwave_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|u_char
op_star
id|ramBase
op_assign
id|priv-&gt;ramBase
suffix:semicolon
r_struct
id|iwreq
op_star
id|wrq
op_assign
(paren
r_struct
id|iwreq
op_star
)paren
id|rq
suffix:semicolon
macro_line|#endif
id|DEBUG
c_func
(paren
l_int|0
comma
l_string|&quot;%s: -&gt;netwave_ioctl(cmd=0x%X)&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|cmd
)paren
suffix:semicolon
multiline_comment|/* Disable interrupts &amp; save flags */
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* Look what is the request */
r_switch
c_cond
(paren
id|cmd
)paren
(brace
multiline_comment|/* --------------- WIRELESS EXTENSIONS --------------- */
macro_line|#ifdef WIRELESS_EXT
r_case
id|SIOCGIWNAME
suffix:colon
multiline_comment|/* Get name */
id|strcpy
c_func
(paren
id|wrq-&gt;u.name
comma
l_string|&quot;Netwave&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SIOCSIWNWID
suffix:colon
multiline_comment|/* Set domain */
macro_line|#if WIRELESS_EXT &gt; 8
r_if
c_cond
(paren
op_logical_neg
id|wrq-&gt;u.nwid.disabled
)paren
(brace
id|domain
op_assign
id|wrq-&gt;u.nwid.value
suffix:semicolon
macro_line|#else&t;/* WIRELESS_EXT &gt; 8 */
r_if
c_cond
(paren
id|wrq-&gt;u.nwid.on
)paren
(brace
id|domain
op_assign
id|wrq-&gt;u.nwid.nwid
suffix:semicolon
macro_line|#endif&t;/* WIRELESS_EXT &gt; 8 */
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;Setting domain to 0x%x%02x&bslash;n&quot;
comma
(paren
id|domain
op_rshift
l_int|8
)paren
op_amp
l_int|0x01
comma
id|domain
op_amp
l_int|0xff
)paren
suffix:semicolon
id|wait_WOC
c_func
(paren
id|iobase
)paren
suffix:semicolon
id|writeb
c_func
(paren
id|NETWAVE_CMD_SMD
comma
id|ramBase
op_plus
id|NETWAVE_EREG_CB
op_plus
l_int|0
)paren
suffix:semicolon
id|writeb
c_func
(paren
id|domain
op_amp
l_int|0xff
comma
id|ramBase
op_plus
id|NETWAVE_EREG_CB
op_plus
l_int|1
)paren
suffix:semicolon
id|writeb
c_func
(paren
(paren
id|domain
op_rshift
l_int|8
)paren
op_amp
l_int|0x01
comma
id|ramBase
op_plus
id|NETWAVE_EREG_CB
op_plus
l_int|2
)paren
suffix:semicolon
id|writeb
c_func
(paren
id|NETWAVE_CMD_EOC
comma
id|ramBase
op_plus
id|NETWAVE_EREG_CB
op_plus
l_int|3
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|SIOCGIWNWID
suffix:colon
multiline_comment|/* Read domain*/
macro_line|#if WIRELESS_EXT &gt; 8
id|wrq-&gt;u.nwid.value
op_assign
id|domain
suffix:semicolon
id|wrq-&gt;u.nwid.disabled
op_assign
l_int|0
suffix:semicolon
id|wrq-&gt;u.nwid.fixed
op_assign
l_int|1
suffix:semicolon
macro_line|#else&t;/* WIRELESS_EXT &gt; 8 */
id|wrq-&gt;u.nwid.nwid
op_assign
id|domain
suffix:semicolon
id|wrq-&gt;u.nwid.on
op_assign
l_int|1
suffix:semicolon
macro_line|#endif&t;/* WIRELESS_EXT &gt; 8 */
r_break
suffix:semicolon
macro_line|#if WIRELESS_EXT &gt; 8&t;/* Note : The API did change... */
r_case
id|SIOCGIWENCODE
suffix:colon
multiline_comment|/* Get scramble key */
r_if
c_cond
(paren
id|wrq-&gt;u.encoding.pointer
op_ne
(paren
id|caddr_t
)paren
l_int|0
)paren
(brace
r_char
id|key
(braket
l_int|2
)braket
suffix:semicolon
id|key
(braket
l_int|1
)braket
op_assign
id|scramble_key
op_amp
l_int|0xff
suffix:semicolon
id|key
(braket
l_int|0
)braket
op_assign
(paren
id|scramble_key
op_rshift
l_int|8
)paren
op_amp
l_int|0xff
suffix:semicolon
id|wrq-&gt;u.encoding.flags
op_assign
id|IW_ENCODE_ENABLED
suffix:semicolon
id|wrq-&gt;u.encoding.length
op_assign
l_int|2
suffix:semicolon
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
id|wrq-&gt;u.encoding.pointer
comma
id|key
comma
l_int|2
)paren
)paren
(brace
id|ret
op_assign
op_minus
id|EFAULT
suffix:semicolon
)brace
)brace
r_break
suffix:semicolon
r_case
id|SIOCSIWENCODE
suffix:colon
multiline_comment|/* Set  scramble key */
r_if
c_cond
(paren
id|wrq-&gt;u.encoding.pointer
op_ne
(paren
id|caddr_t
)paren
l_int|0
)paren
(brace
r_char
id|key
(braket
l_int|2
)braket
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
id|key
comma
id|wrq-&gt;u.encoding.pointer
comma
l_int|2
)paren
)paren
(brace
id|ret
op_assign
op_minus
id|EFAULT
suffix:semicolon
r_break
suffix:semicolon
)brace
id|scramble_key
op_assign
(paren
id|key
(braket
l_int|0
)braket
op_lshift
l_int|8
)paren
op_or
id|key
(braket
l_int|1
)braket
suffix:semicolon
id|wait_WOC
c_func
(paren
id|iobase
)paren
suffix:semicolon
id|writeb
c_func
(paren
id|NETWAVE_CMD_SSK
comma
id|ramBase
op_plus
id|NETWAVE_EREG_CB
op_plus
l_int|0
)paren
suffix:semicolon
id|writeb
c_func
(paren
id|scramble_key
op_amp
l_int|0xff
comma
id|ramBase
op_plus
id|NETWAVE_EREG_CB
op_plus
l_int|1
)paren
suffix:semicolon
id|writeb
c_func
(paren
(paren
id|scramble_key
op_rshift
l_int|8
)paren
op_amp
l_int|0xff
comma
id|ramBase
op_plus
id|NETWAVE_EREG_CB
op_plus
l_int|2
)paren
suffix:semicolon
id|writeb
c_func
(paren
id|NETWAVE_CMD_EOC
comma
id|ramBase
op_plus
id|NETWAVE_EREG_CB
op_plus
l_int|3
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|SIOCGIWMODE
suffix:colon
multiline_comment|/* Mode of operation */
r_if
c_cond
(paren
id|domain
op_amp
l_int|0x100
)paren
(brace
id|wrq-&gt;u.mode
op_assign
id|IW_MODE_INFRA
suffix:semicolon
)brace
r_else
id|wrq-&gt;u.mode
op_assign
id|IW_MODE_ADHOC
suffix:semicolon
r_break
suffix:semicolon
macro_line|#else /* WIRELESS_EXT &gt; 8 */
r_case
id|SIOCGIWENCODE
suffix:colon
multiline_comment|/* Get scramble key */
id|wrq-&gt;u.encoding.code
op_assign
id|scramble_key
suffix:semicolon
id|wrq-&gt;u.encoding.method
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SIOCSIWENCODE
suffix:colon
multiline_comment|/* Set  scramble key */
id|scramble_key
op_assign
id|wrq-&gt;u.encoding.code
suffix:semicolon
id|wait_WOC
c_func
(paren
id|iobase
)paren
suffix:semicolon
id|writeb
c_func
(paren
id|NETWAVE_CMD_SSK
comma
id|ramBase
op_plus
id|NETWAVE_EREG_CB
op_plus
l_int|0
)paren
suffix:semicolon
id|writeb
c_func
(paren
id|scramble_key
op_amp
l_int|0xff
comma
id|ramBase
op_plus
id|NETWAVE_EREG_CB
op_plus
l_int|1
)paren
suffix:semicolon
id|writeb
c_func
(paren
(paren
id|scramble_key
op_rshift
l_int|8
)paren
op_amp
l_int|0xff
comma
id|ramBase
op_plus
id|NETWAVE_EREG_CB
op_plus
l_int|2
)paren
suffix:semicolon
id|writeb
c_func
(paren
id|NETWAVE_CMD_EOC
comma
id|ramBase
op_plus
id|NETWAVE_EREG_CB
op_plus
l_int|3
)paren
suffix:semicolon
r_break
suffix:semicolon
macro_line|#endif /* WIRELESS_EXT &gt; 8 */
r_case
id|SIOCGIWRANGE
suffix:colon
multiline_comment|/* Basic checking... */
r_if
c_cond
(paren
id|wrq-&gt;u.data.pointer
op_ne
(paren
id|caddr_t
)paren
l_int|0
)paren
(brace
r_struct
id|iw_range
id|range
suffix:semicolon
multiline_comment|/* Set the length (useless : its constant...) */
id|wrq-&gt;u.data.length
op_assign
r_sizeof
(paren
r_struct
id|iw_range
)paren
suffix:semicolon
multiline_comment|/* Set information in the range struct */
id|range.throughput
op_assign
l_int|450
op_star
l_int|1000
suffix:semicolon
multiline_comment|/* don&squot;t argue on this ! */
id|range.min_nwid
op_assign
l_int|0x0000
suffix:semicolon
id|range.max_nwid
op_assign
l_int|0x01FF
suffix:semicolon
id|range.num_channels
op_assign
id|range.num_frequency
op_assign
l_int|0
suffix:semicolon
id|range.sensitivity
op_assign
l_int|0x3F
suffix:semicolon
id|range.max_qual.qual
op_assign
l_int|255
suffix:semicolon
id|range.max_qual.level
op_assign
l_int|255
suffix:semicolon
id|range.max_qual.noise
op_assign
l_int|0
suffix:semicolon
macro_line|#if WIRELESS_EXT &gt; 7
id|range.num_bitrates
op_assign
l_int|1
suffix:semicolon
id|range.bitrate
(braket
l_int|0
)braket
op_assign
l_int|1000000
suffix:semicolon
multiline_comment|/* 1 Mb/s */
macro_line|#endif /* WIRELESS_EXT &gt; 7 */
macro_line|#if WIRELESS_EXT &gt; 8
id|range.encoding_size
(braket
l_int|0
)braket
op_assign
l_int|2
suffix:semicolon
multiline_comment|/* 16 bits scrambling */
id|range.num_encoding_sizes
op_assign
l_int|1
suffix:semicolon
id|range.max_encoding_tokens
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* Only one key possible */
macro_line|#endif /* WIRELESS_EXT &gt; 8 */
multiline_comment|/* Copy structure to the user buffer */
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
id|wrq-&gt;u.data.pointer
comma
op_amp
id|range
comma
r_sizeof
(paren
r_struct
id|iw_range
)paren
)paren
)paren
(brace
id|ret
op_assign
op_minus
id|EFAULT
suffix:semicolon
)brace
)brace
r_break
suffix:semicolon
r_case
id|SIOCGIWPRIV
suffix:colon
multiline_comment|/* Basic checking... */
r_if
c_cond
(paren
id|wrq-&gt;u.data.pointer
op_ne
(paren
id|caddr_t
)paren
l_int|0
)paren
(brace
r_struct
id|iw_priv_args
id|priv
(braket
)braket
op_assign
(brace
multiline_comment|/* cmd,&t;&t;set_args,&t;get_args,&t;name */
(brace
id|SIOCGIPSNAP
comma
id|IW_PRIV_TYPE_BYTE
op_or
id|IW_PRIV_SIZE_FIXED
op_or
l_int|0
comma
r_sizeof
(paren
r_struct
id|site_survey
)paren
comma
l_string|&quot;getsitesurvey&quot;
)brace
comma
)brace
suffix:semicolon
multiline_comment|/* Set the number of ioctl available */
id|wrq-&gt;u.data.length
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* Copy structure to the user buffer */
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
id|wrq-&gt;u.data.pointer
comma
(paren
id|u_char
op_star
)paren
id|priv
comma
r_sizeof
(paren
id|priv
)paren
)paren
)paren
(brace
id|ret
op_assign
op_minus
id|EFAULT
suffix:semicolon
)brace
)brace
r_break
suffix:semicolon
r_case
id|SIOCGIPSNAP
suffix:colon
r_if
c_cond
(paren
id|wrq-&gt;u.data.pointer
op_ne
(paren
id|caddr_t
)paren
l_int|0
)paren
(brace
multiline_comment|/* Take snapshot of environment */
id|netwave_snapshot
c_func
(paren
id|priv
comma
id|ramBase
comma
id|iobase
)paren
suffix:semicolon
id|wrq-&gt;u.data.length
op_assign
id|priv-&gt;nss.length
suffix:semicolon
multiline_comment|/* Copy structure to the user buffer */
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
id|wrq-&gt;u.data.pointer
comma
(paren
id|u_char
op_star
)paren
op_amp
id|priv-&gt;nss
comma
r_sizeof
(paren
r_struct
id|site_survey
)paren
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;Bad buffer!&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|priv-&gt;lastExec
op_assign
id|jiffies
suffix:semicolon
)brace
r_break
suffix:semicolon
macro_line|#endif
r_default
suffix:colon
id|ret
op_assign
op_minus
id|EOPNOTSUPP
suffix:semicolon
)brace
multiline_comment|/* ReEnable interrupts &amp; restore flags */
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
multiline_comment|/*&n; * Function netwave_pcmcia_config (link)&n; *&n; *     netwave_pcmcia_config() is scheduled to run after a CARD_INSERTION &n; *     event is received, to configure the PCMCIA socket, and to make the&n; *     device available to the system. &n; *&n; */
DECL|macro|CS_CHECK
mdefine_line|#define CS_CHECK(fn, args...) &bslash;&n;while ((last_ret=CardServices(last_fn=(fn), args))!=0) goto cs_failed
DECL|function|netwave_pcmcia_config
r_static
r_void
id|netwave_pcmcia_config
c_func
(paren
id|dev_link_t
op_star
id|link
)paren
(brace
id|client_handle_t
id|handle
op_assign
id|link-&gt;handle
suffix:semicolon
id|netwave_private
op_star
id|priv
op_assign
id|link-&gt;priv
suffix:semicolon
r_struct
id|net_device
op_star
id|dev
op_assign
op_amp
id|priv-&gt;dev
suffix:semicolon
id|tuple_t
id|tuple
suffix:semicolon
id|cisparse_t
id|parse
suffix:semicolon
r_int
id|i
comma
id|j
comma
id|last_ret
comma
id|last_fn
suffix:semicolon
id|u_char
id|buf
(braket
l_int|64
)braket
suffix:semicolon
id|win_req_t
id|req
suffix:semicolon
id|memreq_t
id|mem
suffix:semicolon
id|u_char
op_star
id|ramBase
op_assign
l_int|NULL
suffix:semicolon
id|DEBUG
c_func
(paren
l_int|0
comma
l_string|&quot;netwave_pcmcia_config(0x%p)&bslash;n&quot;
comma
id|link
)paren
suffix:semicolon
multiline_comment|/*&n;      This reads the card&squot;s CONFIG tuple to find its configuration&n;      registers.&n;    */
id|tuple.Attributes
op_assign
l_int|0
suffix:semicolon
id|tuple.TupleData
op_assign
(paren
id|cisdata_t
op_star
)paren
id|buf
suffix:semicolon
id|tuple.TupleDataMax
op_assign
l_int|64
suffix:semicolon
id|tuple.TupleOffset
op_assign
l_int|0
suffix:semicolon
id|tuple.DesiredTuple
op_assign
id|CISTPL_CONFIG
suffix:semicolon
id|CS_CHECK
c_func
(paren
id|GetFirstTuple
comma
id|handle
comma
op_amp
id|tuple
)paren
suffix:semicolon
id|CS_CHECK
c_func
(paren
id|GetTupleData
comma
id|handle
comma
op_amp
id|tuple
)paren
suffix:semicolon
id|CS_CHECK
c_func
(paren
id|ParseTuple
comma
id|handle
comma
op_amp
id|tuple
comma
op_amp
id|parse
)paren
suffix:semicolon
id|link-&gt;conf.ConfigBase
op_assign
id|parse.config.base
suffix:semicolon
id|link-&gt;conf.Present
op_assign
id|parse.config.rmask
(braket
l_int|0
)braket
suffix:semicolon
multiline_comment|/* Configure card */
id|link-&gt;state
op_or_assign
id|DEV_CONFIG
suffix:semicolon
multiline_comment|/*&n;     *  Try allocating IO ports.  This tries a few fixed addresses.&n;     *  If you want, you can also read the card&squot;s config table to&n;     *  pick addresses -- see the serial driver for an example.&n;     */
r_for
c_loop
(paren
id|i
op_assign
id|j
op_assign
l_int|0x0
suffix:semicolon
id|j
OL
l_int|0x400
suffix:semicolon
id|j
op_add_assign
l_int|0x20
)paren
(brace
id|link-&gt;io.BasePort1
op_assign
id|j
op_xor
l_int|0x300
suffix:semicolon
id|i
op_assign
id|CardServices
c_func
(paren
id|RequestIO
comma
id|link-&gt;handle
comma
op_amp
id|link-&gt;io
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
op_eq
id|CS_SUCCESS
)paren
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|i
op_ne
id|CS_SUCCESS
)paren
(brace
id|cs_error
c_func
(paren
id|link-&gt;handle
comma
id|RequestIO
comma
id|i
)paren
suffix:semicolon
r_goto
id|failed
suffix:semicolon
)brace
multiline_comment|/*&n;     *  Now allocate an interrupt line.  Note that this does not&n;     *  actually assign a handler to the interrupt.&n;     */
id|CS_CHECK
c_func
(paren
id|RequestIRQ
comma
id|handle
comma
op_amp
id|link-&gt;irq
)paren
suffix:semicolon
multiline_comment|/*&n;     *  This actually configures the PCMCIA socket -- setting up&n;     *  the I/O windows and the interrupt mapping.&n;     */
id|CS_CHECK
c_func
(paren
id|RequestConfiguration
comma
id|handle
comma
op_amp
id|link-&gt;conf
)paren
suffix:semicolon
multiline_comment|/*&n;     *  Allocate a 32K memory window.  Note that the dev_link_t&n;     *  structure provides space for one window handle -- if your&n;     *  device needs several windows, you&squot;ll need to keep track of&n;     *  the handles in your private data structure, link-&gt;priv.&n;     */
id|DEBUG
c_func
(paren
l_int|1
comma
l_string|&quot;Setting mem speed of %d&bslash;n&quot;
comma
id|mem_speed
)paren
suffix:semicolon
id|req.Attributes
op_assign
id|WIN_DATA_WIDTH_8
op_or
id|WIN_MEMORY_TYPE_CM
op_or
id|WIN_ENABLE
suffix:semicolon
id|req.Base
op_assign
l_int|0
suffix:semicolon
id|req.Size
op_assign
l_int|0x8000
suffix:semicolon
id|req.AccessSpeed
op_assign
id|mem_speed
suffix:semicolon
id|link-&gt;win
op_assign
(paren
id|window_handle_t
)paren
id|link-&gt;handle
suffix:semicolon
id|CS_CHECK
c_func
(paren
id|RequestWindow
comma
op_amp
id|link-&gt;win
comma
op_amp
id|req
)paren
suffix:semicolon
id|mem.CardOffset
op_assign
l_int|0x20000
suffix:semicolon
id|mem.Page
op_assign
l_int|0
suffix:semicolon
id|CS_CHECK
c_func
(paren
id|MapMemPage
comma
id|link-&gt;win
comma
op_amp
id|mem
)paren
suffix:semicolon
multiline_comment|/* Store base address of the common window frame */
id|ramBase
op_assign
id|ioremap
c_func
(paren
id|req.Base
comma
l_int|0x8000
)paren
suffix:semicolon
(paren
(paren
id|netwave_private
op_star
)paren
id|dev-&gt;priv
)paren
op_member_access_from_pointer
id|ramBase
op_assign
id|ramBase
suffix:semicolon
id|dev-&gt;irq
op_assign
id|link-&gt;irq.AssignedIRQ
suffix:semicolon
id|dev-&gt;base_addr
op_assign
id|link-&gt;io.BasePort1
suffix:semicolon
r_if
c_cond
(paren
id|register_netdev
c_func
(paren
id|dev
)paren
op_ne
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;netwave_cs: register_netdev() failed&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|failed
suffix:semicolon
)brace
id|strcpy
c_func
(paren
id|priv-&gt;node.dev_name
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|link-&gt;dev
op_assign
op_amp
id|priv-&gt;node
suffix:semicolon
id|link-&gt;state
op_and_assign
op_complement
id|DEV_CONFIG_PENDING
suffix:semicolon
multiline_comment|/* Reset card before reading physical address */
id|netwave_doreset
c_func
(paren
id|dev-&gt;base_addr
comma
id|ramBase
)paren
suffix:semicolon
multiline_comment|/* Read the ethernet address and fill in the Netwave registers. */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|6
suffix:semicolon
id|i
op_increment
)paren
id|dev-&gt;dev_addr
(braket
id|i
)braket
op_assign
id|readb
c_func
(paren
id|ramBase
op_plus
id|NETWAVE_EREG_PA
op_plus
id|i
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Netwave: port %#3lx, irq %d, mem %lx id &quot;
l_string|&quot;%c%c, hw_addr &quot;
comma
id|dev-&gt;name
comma
id|dev-&gt;base_addr
comma
id|dev-&gt;irq
comma
(paren
id|u_long
)paren
id|ramBase
comma
(paren
r_int
)paren
id|readb
c_func
(paren
id|ramBase
op_plus
id|NETWAVE_EREG_NI
)paren
comma
(paren
r_int
)paren
id|readb
c_func
(paren
id|ramBase
op_plus
id|NETWAVE_EREG_NI
op_plus
l_int|1
)paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|6
suffix:semicolon
id|i
op_increment
)paren
id|printk
c_func
(paren
l_string|&quot;%02X%s&quot;
comma
id|dev-&gt;dev_addr
(braket
id|i
)braket
comma
(paren
(paren
id|i
OL
l_int|5
)paren
ques
c_cond
l_string|&quot;:&quot;
suffix:colon
l_string|&quot;&bslash;n&quot;
)paren
)paren
suffix:semicolon
multiline_comment|/* get revision words */
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;Netwave_reset: revision %04x %04x&bslash;n&quot;
comma
id|get_uint16
c_func
(paren
id|ramBase
op_plus
id|NETWAVE_EREG_ARW
)paren
comma
id|get_uint16
c_func
(paren
id|ramBase
op_plus
id|NETWAVE_EREG_ARW
op_plus
l_int|2
)paren
)paren
suffix:semicolon
r_return
suffix:semicolon
id|cs_failed
suffix:colon
id|cs_error
c_func
(paren
id|link-&gt;handle
comma
id|last_fn
comma
id|last_ret
)paren
suffix:semicolon
id|failed
suffix:colon
id|netwave_release
c_func
(paren
(paren
id|u_long
)paren
id|link
)paren
suffix:semicolon
)brace
multiline_comment|/* netwave_pcmcia_config */
multiline_comment|/*&n; * Function netwave_release (arg)&n; *&n; *    After a card is removed, netwave_release() will unregister the net&n; *    device, and release the PCMCIA configuration.  If the device is&n; *    still open, this will be postponed until it is closed.&n; */
DECL|function|netwave_release
r_static
r_void
id|netwave_release
c_func
(paren
id|u_long
id|arg
)paren
(brace
id|dev_link_t
op_star
id|link
op_assign
(paren
id|dev_link_t
op_star
)paren
id|arg
suffix:semicolon
id|netwave_private
op_star
id|priv
op_assign
id|link-&gt;priv
suffix:semicolon
id|DEBUG
c_func
(paren
l_int|0
comma
l_string|&quot;netwave_release(0x%p)&bslash;n&quot;
comma
id|link
)paren
suffix:semicolon
multiline_comment|/*&n;      If the device is currently in use, we won&squot;t release until it&n;      is actually closed.&n;      */
r_if
c_cond
(paren
id|link-&gt;open
)paren
(brace
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;netwave_cs: release postponed, &squot;%s&squot; still open&bslash;n&quot;
comma
id|link-&gt;dev-&gt;dev_name
)paren
suffix:semicolon
id|link-&gt;state
op_or_assign
id|DEV_STALE_CONFIG
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/* Don&squot;t bother checking to see if these succeed or not */
r_if
c_cond
(paren
id|link-&gt;win
)paren
(brace
id|iounmap
c_func
(paren
id|priv-&gt;ramBase
)paren
suffix:semicolon
id|CardServices
c_func
(paren
id|ReleaseWindow
comma
id|link-&gt;win
)paren
suffix:semicolon
)brace
id|CardServices
c_func
(paren
id|ReleaseConfiguration
comma
id|link-&gt;handle
)paren
suffix:semicolon
id|CardServices
c_func
(paren
id|ReleaseIO
comma
id|link-&gt;handle
comma
op_amp
id|link-&gt;io
)paren
suffix:semicolon
id|CardServices
c_func
(paren
id|ReleaseIRQ
comma
id|link-&gt;handle
comma
op_amp
id|link-&gt;irq
)paren
suffix:semicolon
id|link-&gt;state
op_and_assign
op_complement
(paren
id|DEV_CONFIG
op_or
id|DEV_STALE_CONFIG
)paren
suffix:semicolon
)brace
multiline_comment|/* netwave_release */
multiline_comment|/*&n; * Function netwave_event (event, priority, args)&n; *&n; *    The card status event handler.  Mostly, this schedules other&n; *    stuff to run after an event is received.  A CARD_REMOVAL event&n; *    also sets some flags to discourage the net drivers from trying&n; *    to talk to the card any more.&n; *&n; *    When a CARD_REMOVAL event is received, we immediately set a flag&n; *    to block future accesses to this device.  All the functions that&n; *    actually access the device should check this flag to make sure&n; *    the card is still present.&n; *&n; */
DECL|function|netwave_event
r_static
r_int
id|netwave_event
c_func
(paren
id|event_t
id|event
comma
r_int
id|priority
comma
id|event_callback_args_t
op_star
id|args
)paren
(brace
id|dev_link_t
op_star
id|link
op_assign
id|args-&gt;client_data
suffix:semicolon
id|netwave_private
op_star
id|priv
op_assign
id|link-&gt;priv
suffix:semicolon
r_struct
id|net_device
op_star
id|dev
op_assign
op_amp
id|priv-&gt;dev
suffix:semicolon
id|DEBUG
c_func
(paren
l_int|1
comma
l_string|&quot;netwave_event(0x%06x)&bslash;n&quot;
comma
id|event
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|event
)paren
(brace
r_case
id|CS_EVENT_REGISTRATION_COMPLETE
suffix:colon
id|DEBUG
c_func
(paren
l_int|0
comma
l_string|&quot;netwave_cs: registration complete&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CS_EVENT_CARD_REMOVAL
suffix:colon
id|link-&gt;state
op_and_assign
op_complement
id|DEV_PRESENT
suffix:semicolon
r_if
c_cond
(paren
id|link-&gt;state
op_amp
id|DEV_CONFIG
)paren
(brace
id|netif_device_detach
c_func
(paren
id|dev
)paren
suffix:semicolon
id|mod_timer
c_func
(paren
op_amp
id|link-&gt;release
comma
id|jiffies
op_plus
id|HZ
op_div
l_int|20
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|CS_EVENT_CARD_INSERTION
suffix:colon
id|link-&gt;state
op_or_assign
id|DEV_PRESENT
op_or
id|DEV_CONFIG_PENDING
suffix:semicolon
id|netwave_pcmcia_config
c_func
(paren
id|link
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CS_EVENT_PM_SUSPEND
suffix:colon
id|link-&gt;state
op_or_assign
id|DEV_SUSPEND
suffix:semicolon
multiline_comment|/* Fall through... */
r_case
id|CS_EVENT_RESET_PHYSICAL
suffix:colon
r_if
c_cond
(paren
id|link-&gt;state
op_amp
id|DEV_CONFIG
)paren
(brace
r_if
c_cond
(paren
id|link-&gt;open
)paren
id|netif_device_detach
c_func
(paren
id|dev
)paren
suffix:semicolon
id|CardServices
c_func
(paren
id|ReleaseConfiguration
comma
id|link-&gt;handle
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|CS_EVENT_PM_RESUME
suffix:colon
id|link-&gt;state
op_and_assign
op_complement
id|DEV_SUSPEND
suffix:semicolon
multiline_comment|/* Fall through... */
r_case
id|CS_EVENT_CARD_RESET
suffix:colon
r_if
c_cond
(paren
id|link-&gt;state
op_amp
id|DEV_CONFIG
)paren
(brace
id|CardServices
c_func
(paren
id|RequestConfiguration
comma
id|link-&gt;handle
comma
op_amp
id|link-&gt;conf
)paren
suffix:semicolon
r_if
c_cond
(paren
id|link-&gt;open
)paren
(brace
id|netwave_reset
c_func
(paren
id|dev
)paren
suffix:semicolon
id|netif_device_attach
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
)brace
r_break
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* netwave_event */
multiline_comment|/*&n; * Function netwave_doreset (ioBase, ramBase)&n; *&n; *    Proper hardware reset of the card.&n; */
DECL|function|netwave_doreset
r_static
r_void
id|netwave_doreset
c_func
(paren
id|ioaddr_t
id|ioBase
comma
id|u_char
op_star
id|ramBase
)paren
(brace
multiline_comment|/* Reset card */
id|wait_WOC
c_func
(paren
id|ioBase
)paren
suffix:semicolon
id|outb
c_func
(paren
l_int|0x80
comma
id|ioBase
op_plus
id|NETWAVE_REG_PMR
)paren
suffix:semicolon
id|writeb
c_func
(paren
l_int|0x08
comma
id|ramBase
op_plus
id|NETWAVE_EREG_ASCC
)paren
suffix:semicolon
multiline_comment|/* Bit 3 is WOC */
id|outb
c_func
(paren
l_int|0x0
comma
id|ioBase
op_plus
id|NETWAVE_REG_PMR
)paren
suffix:semicolon
multiline_comment|/* release reset */
)brace
multiline_comment|/*&n; * Function netwave_reset (dev)&n; *&n; *    Reset and restore all of the netwave registers &n; */
DECL|function|netwave_reset
r_static
r_void
id|netwave_reset
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
multiline_comment|/* u_char state; */
id|netwave_private
op_star
id|priv
op_assign
(paren
id|netwave_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|u_char
op_star
id|ramBase
op_assign
id|priv-&gt;ramBase
suffix:semicolon
id|ioaddr_t
id|iobase
op_assign
id|dev-&gt;base_addr
suffix:semicolon
id|DEBUG
c_func
(paren
l_int|0
comma
l_string|&quot;netwave_reset: Done with hardware reset&bslash;n&quot;
)paren
suffix:semicolon
id|priv-&gt;timeoutCounter
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Reset card */
id|netwave_doreset
c_func
(paren
id|iobase
comma
id|ramBase
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;netwave_reset: Done with hardware reset&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* Write a NOP to check the card */
id|wait_WOC
c_func
(paren
id|iobase
)paren
suffix:semicolon
id|writeb
c_func
(paren
id|NETWAVE_CMD_NOP
comma
id|ramBase
op_plus
id|NETWAVE_EREG_CB
op_plus
l_int|0
)paren
suffix:semicolon
id|writeb
c_func
(paren
id|NETWAVE_CMD_EOC
comma
id|ramBase
op_plus
id|NETWAVE_EREG_CB
op_plus
l_int|1
)paren
suffix:semicolon
multiline_comment|/* Set receive conf */
id|wait_WOC
c_func
(paren
id|iobase
)paren
suffix:semicolon
id|writeb
c_func
(paren
id|NETWAVE_CMD_SRC
comma
id|ramBase
op_plus
id|NETWAVE_EREG_CB
op_plus
l_int|0
)paren
suffix:semicolon
id|writeb
c_func
(paren
id|rxConfRxEna
op_plus
id|rxConfBcast
comma
id|ramBase
op_plus
id|NETWAVE_EREG_CB
op_plus
l_int|1
)paren
suffix:semicolon
id|writeb
c_func
(paren
id|NETWAVE_CMD_EOC
comma
id|ramBase
op_plus
id|NETWAVE_EREG_CB
op_plus
l_int|2
)paren
suffix:semicolon
multiline_comment|/* Set transmit conf */
id|wait_WOC
c_func
(paren
id|iobase
)paren
suffix:semicolon
id|writeb
c_func
(paren
id|NETWAVE_CMD_STC
comma
id|ramBase
op_plus
id|NETWAVE_EREG_CB
op_plus
l_int|0
)paren
suffix:semicolon
id|writeb
c_func
(paren
id|txConfTxEna
comma
id|ramBase
op_plus
id|NETWAVE_EREG_CB
op_plus
l_int|1
)paren
suffix:semicolon
id|writeb
c_func
(paren
id|NETWAVE_CMD_EOC
comma
id|ramBase
op_plus
id|NETWAVE_EREG_CB
op_plus
l_int|2
)paren
suffix:semicolon
multiline_comment|/* Now set the MU Domain */
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;Setting domain to 0x%x%02x&bslash;n&quot;
comma
(paren
id|domain
op_rshift
l_int|8
)paren
op_amp
l_int|0x01
comma
id|domain
op_amp
l_int|0xff
)paren
suffix:semicolon
id|wait_WOC
c_func
(paren
id|iobase
)paren
suffix:semicolon
id|writeb
c_func
(paren
id|NETWAVE_CMD_SMD
comma
id|ramBase
op_plus
id|NETWAVE_EREG_CB
op_plus
l_int|0
)paren
suffix:semicolon
id|writeb
c_func
(paren
id|domain
op_amp
l_int|0xff
comma
id|ramBase
op_plus
id|NETWAVE_EREG_CB
op_plus
l_int|1
)paren
suffix:semicolon
id|writeb
c_func
(paren
(paren
id|domain
op_rshift
l_int|8
)paren
op_amp
l_int|0x01
comma
id|ramBase
op_plus
id|NETWAVE_EREG_CB
op_plus
l_int|2
)paren
suffix:semicolon
id|writeb
c_func
(paren
id|NETWAVE_CMD_EOC
comma
id|ramBase
op_plus
id|NETWAVE_EREG_CB
op_plus
l_int|3
)paren
suffix:semicolon
multiline_comment|/* Set scramble key */
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;Setting scramble key to 0x%x&bslash;n&quot;
comma
id|scramble_key
)paren
suffix:semicolon
id|wait_WOC
c_func
(paren
id|iobase
)paren
suffix:semicolon
id|writeb
c_func
(paren
id|NETWAVE_CMD_SSK
comma
id|ramBase
op_plus
id|NETWAVE_EREG_CB
op_plus
l_int|0
)paren
suffix:semicolon
id|writeb
c_func
(paren
id|scramble_key
op_amp
l_int|0xff
comma
id|ramBase
op_plus
id|NETWAVE_EREG_CB
op_plus
l_int|1
)paren
suffix:semicolon
id|writeb
c_func
(paren
(paren
id|scramble_key
op_rshift
l_int|8
)paren
op_amp
l_int|0xff
comma
id|ramBase
op_plus
id|NETWAVE_EREG_CB
op_plus
l_int|2
)paren
suffix:semicolon
id|writeb
c_func
(paren
id|NETWAVE_CMD_EOC
comma
id|ramBase
op_plus
id|NETWAVE_EREG_CB
op_plus
l_int|3
)paren
suffix:semicolon
multiline_comment|/* Enable interrupts, bit 4 high to keep unused&n;     * source from interrupting us, bit 2 high to &n;     * set interrupt enable, 567 to enable TxDN, &n;     * RxErr and RxRdy&n;     */
id|wait_WOC
c_func
(paren
id|iobase
)paren
suffix:semicolon
id|outb
c_func
(paren
id|imrConfIENA
op_plus
id|imrConfRFU1
comma
id|iobase
op_plus
id|NETWAVE_REG_IMR
)paren
suffix:semicolon
multiline_comment|/* Hent 4 bytes fra 0x170. Skal vaere 0a,29,88,36&n;     * waitWOC&n;     * skriv 80 til d000:3688&n;     * sjekk om det ble 80&n;     */
multiline_comment|/* Enable Receiver */
id|wait_WOC
c_func
(paren
id|iobase
)paren
suffix:semicolon
id|writeb
c_func
(paren
id|NETWAVE_CMD_ER
comma
id|ramBase
op_plus
id|NETWAVE_EREG_CB
op_plus
l_int|0
)paren
suffix:semicolon
id|writeb
c_func
(paren
id|NETWAVE_CMD_EOC
comma
id|ramBase
op_plus
id|NETWAVE_EREG_CB
op_plus
l_int|1
)paren
suffix:semicolon
multiline_comment|/* Set the IENA bit in COR */
id|wait_WOC
c_func
(paren
id|iobase
)paren
suffix:semicolon
id|outb
c_func
(paren
id|corConfIENA
op_plus
id|corConfLVLREQ
comma
id|iobase
op_plus
id|NETWAVE_REG_COR
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Function netwave_config (dev, map)&n; *&n; *    Configure device, this work is done by netwave_pcmcia_config when a&n; *    card is inserted&n; */
DECL|function|netwave_config
r_static
r_int
id|netwave_config
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_struct
id|ifmap
op_star
id|map
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * Function netwave_hw_xmit (data, len, dev)    &n; */
DECL|function|netwave_hw_xmit
r_static
r_int
id|netwave_hw_xmit
c_func
(paren
r_int
r_char
op_star
id|data
comma
r_int
id|len
comma
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
r_int
r_int
id|TxFreeList
comma
id|curBuff
comma
id|MaxData
comma
id|DataOffset
suffix:semicolon
r_int
id|tmpcount
suffix:semicolon
id|netwave_private
op_star
id|priv
op_assign
(paren
id|netwave_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|u_char
op_star
id|ramBase
op_assign
id|priv-&gt;ramBase
suffix:semicolon
id|ioaddr_t
id|iobase
op_assign
id|dev-&gt;base_addr
suffix:semicolon
multiline_comment|/* Disable interrupts &amp; save flags */
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* Check if there are transmit buffers available */
id|wait_WOC
c_func
(paren
id|iobase
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|inb
c_func
(paren
id|iobase
op_plus
id|NETWAVE_REG_ASR
)paren
op_amp
id|NETWAVE_ASR_TXBA
)paren
op_eq
l_int|0
)paren
(brace
multiline_comment|/* No buffers available */
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;netwave_hw_xmit: %s - no xmit buffers available.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
id|priv-&gt;stats.tx_bytes
op_add_assign
id|len
suffix:semicolon
id|DEBUG
c_func
(paren
l_int|3
comma
l_string|&quot;Transmitting with SPCQ %x SPU %x LIF %x ISPLQ %x&bslash;n&quot;
comma
id|readb
c_func
(paren
id|ramBase
op_plus
id|NETWAVE_EREG_SPCQ
)paren
comma
id|readb
c_func
(paren
id|ramBase
op_plus
id|NETWAVE_EREG_SPU
)paren
comma
id|readb
c_func
(paren
id|ramBase
op_plus
id|NETWAVE_EREG_LIF
)paren
comma
id|readb
c_func
(paren
id|ramBase
op_plus
id|NETWAVE_EREG_ISPLQ
)paren
)paren
suffix:semicolon
multiline_comment|/* Now try to insert it into the adapters free memory */
id|wait_WOC
c_func
(paren
id|iobase
)paren
suffix:semicolon
id|TxFreeList
op_assign
id|get_uint16
c_func
(paren
id|ramBase
op_plus
id|NETWAVE_EREG_TDP
)paren
suffix:semicolon
id|MaxData
op_assign
id|get_uint16
c_func
(paren
id|ramBase
op_plus
id|NETWAVE_EREG_TDP
op_plus
l_int|2
)paren
suffix:semicolon
id|DataOffset
op_assign
id|get_uint16
c_func
(paren
id|ramBase
op_plus
id|NETWAVE_EREG_TDP
op_plus
l_int|4
)paren
suffix:semicolon
id|DEBUG
c_func
(paren
l_int|3
comma
l_string|&quot;TxFreeList %x, MaxData %x, DataOffset %x&bslash;n&quot;
comma
id|TxFreeList
comma
id|MaxData
comma
id|DataOffset
)paren
suffix:semicolon
multiline_comment|/* Copy packet to the adapter fragment buffers */
id|curBuff
op_assign
id|TxFreeList
suffix:semicolon
id|tmpcount
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
id|tmpcount
OL
id|len
)paren
(brace
r_int
id|tmplen
op_assign
id|len
op_minus
id|tmpcount
suffix:semicolon
id|copy_to_pc
c_func
(paren
id|ramBase
op_plus
id|curBuff
op_plus
id|DataOffset
comma
id|data
op_plus
id|tmpcount
comma
(paren
id|tmplen
OL
id|MaxData
)paren
ques
c_cond
id|tmplen
suffix:colon
id|MaxData
)paren
suffix:semicolon
id|tmpcount
op_add_assign
id|MaxData
suffix:semicolon
multiline_comment|/* Advance to next buffer */
id|curBuff
op_assign
id|get_uint16
c_func
(paren
id|ramBase
op_plus
id|curBuff
)paren
suffix:semicolon
)brace
multiline_comment|/* Now issue transmit list */
id|wait_WOC
c_func
(paren
id|iobase
)paren
suffix:semicolon
id|writeb
c_func
(paren
id|NETWAVE_CMD_TL
comma
id|ramBase
op_plus
id|NETWAVE_EREG_CB
op_plus
l_int|0
)paren
suffix:semicolon
id|writeb
c_func
(paren
id|len
op_amp
l_int|0xff
comma
id|ramBase
op_plus
id|NETWAVE_EREG_CB
op_plus
l_int|1
)paren
suffix:semicolon
id|writeb
c_func
(paren
(paren
id|len
op_rshift
l_int|8
)paren
op_amp
l_int|0xff
comma
id|ramBase
op_plus
id|NETWAVE_EREG_CB
op_plus
l_int|2
)paren
suffix:semicolon
id|writeb
c_func
(paren
id|NETWAVE_CMD_EOC
comma
id|ramBase
op_plus
id|NETWAVE_EREG_CB
op_plus
l_int|3
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|netwave_start_xmit
r_static
r_int
id|netwave_start_xmit
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|net_device
op_star
id|dev
)paren
(brace
multiline_comment|/* This flag indicate that the hardware can&squot;t perform a transmission.&n;&t; * Theoritically, NET3 check it before sending a packet to the driver,&n;&t; * but in fact it never do that and pool continuously.&n;&t; * As the watchdog will abort too long transmissions, we are quite safe...&n;&t; */
id|netif_stop_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
(brace
r_int
id|length
op_assign
id|ETH_ZLEN
OL
id|skb-&gt;len
ques
c_cond
id|skb-&gt;len
suffix:colon
id|ETH_ZLEN
suffix:semicolon
r_int
r_char
op_star
id|buf
op_assign
id|skb-&gt;data
suffix:semicolon
r_if
c_cond
(paren
id|netwave_hw_xmit
c_func
(paren
id|buf
comma
id|length
comma
id|dev
)paren
op_eq
l_int|1
)paren
(brace
multiline_comment|/* Some error, let&squot;s make them call us another time? */
id|netif_start_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
id|dev-&gt;trans_start
op_assign
id|jiffies
suffix:semicolon
)brace
id|dev_kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* netwave_start_xmit */
multiline_comment|/*&n; * Function netwave_interrupt (irq, dev_id, regs)&n; *&n; *    This function is the interrupt handler for the Netwave card. This&n; *    routine will be called whenever: &n; *&t;  1. A packet is received.&n; *&t;  2. A packet has successfully been transfered and the unit is&n; *&t;     ready to transmit another packet.&n; *&t;  3. A command has completed execution.&n; */
DECL|function|netwave_interrupt
r_static
r_void
id|netwave_interrupt
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
id|ioaddr_t
id|iobase
suffix:semicolon
id|u_char
op_star
id|ramBase
suffix:semicolon
r_struct
id|net_device
op_star
id|dev
op_assign
(paren
r_struct
id|net_device
op_star
)paren
id|dev_id
suffix:semicolon
r_struct
id|netwave_private
op_star
id|priv
op_assign
id|dev-&gt;priv
suffix:semicolon
id|dev_link_t
op_star
id|link
op_assign
op_amp
id|priv-&gt;link
suffix:semicolon
r_int
id|i
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|netif_device_present
c_func
(paren
id|dev
)paren
)paren
r_return
suffix:semicolon
id|iobase
op_assign
id|dev-&gt;base_addr
suffix:semicolon
id|ramBase
op_assign
id|priv-&gt;ramBase
suffix:semicolon
multiline_comment|/* Now find what caused the interrupt, check while interrupts ready */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|10
suffix:semicolon
id|i
op_increment
)paren
(brace
id|u_char
id|status
suffix:semicolon
id|wait_WOC
c_func
(paren
id|iobase
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|inb
c_func
(paren
id|iobase
op_plus
id|NETWAVE_REG_CCSR
)paren
op_amp
l_int|0x02
)paren
)paren
r_break
suffix:semicolon
multiline_comment|/* None of the interrupt sources asserted */
id|status
op_assign
id|inb
c_func
(paren
id|iobase
op_plus
id|NETWAVE_REG_ASR
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|DEV_OK
c_func
(paren
id|link
)paren
)paren
(brace
id|DEBUG
c_func
(paren
l_int|1
comma
l_string|&quot;netwave_interrupt: Interrupt with status 0x%x &quot;
l_string|&quot;from removed or suspended card!&bslash;n&quot;
comma
id|status
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
multiline_comment|/* RxRdy */
r_if
c_cond
(paren
id|status
op_amp
l_int|0x80
)paren
(brace
id|netwave_rx
c_func
(paren
id|dev
)paren
suffix:semicolon
multiline_comment|/* wait_WOC(iobase); */
multiline_comment|/* RxRdy cannot be reset directly by the host */
)brace
multiline_comment|/* RxErr */
r_if
c_cond
(paren
id|status
op_amp
l_int|0x40
)paren
(brace
id|u_char
id|rser
suffix:semicolon
id|rser
op_assign
id|readb
c_func
(paren
id|ramBase
op_plus
id|NETWAVE_EREG_RSER
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rser
op_amp
l_int|0x04
)paren
(brace
op_increment
id|priv-&gt;stats.rx_dropped
suffix:semicolon
op_increment
id|priv-&gt;stats.rx_crc_errors
suffix:semicolon
)brace
r_if
c_cond
(paren
id|rser
op_amp
l_int|0x02
)paren
op_increment
id|priv-&gt;stats.rx_frame_errors
suffix:semicolon
multiline_comment|/* Clear the RxErr bit in RSER. RSER+4 is the&n;&t;     * write part. Also clear the RxCRC (0x04) and &n;&t;     * RxBig (0x02) bits if present */
id|wait_WOC
c_func
(paren
id|iobase
)paren
suffix:semicolon
id|writeb
c_func
(paren
l_int|0x40
op_or
(paren
id|rser
op_amp
l_int|0x06
)paren
comma
id|ramBase
op_plus
id|NETWAVE_EREG_RSER
op_plus
l_int|4
)paren
suffix:semicolon
multiline_comment|/* Write bit 6 high to ASCC to clear RxErr in ASR,&n;&t;     * WOC must be set first! &n;&t;     */
id|wait_WOC
c_func
(paren
id|iobase
)paren
suffix:semicolon
id|writeb
c_func
(paren
l_int|0x40
comma
id|ramBase
op_plus
id|NETWAVE_EREG_ASCC
)paren
suffix:semicolon
multiline_comment|/* Remember to count up priv-&gt;stats on error packets */
op_increment
id|priv-&gt;stats.rx_errors
suffix:semicolon
)brace
multiline_comment|/* TxDN */
r_if
c_cond
(paren
id|status
op_amp
l_int|0x20
)paren
(brace
r_int
id|txStatus
suffix:semicolon
id|txStatus
op_assign
id|readb
c_func
(paren
id|ramBase
op_plus
id|NETWAVE_EREG_TSER
)paren
suffix:semicolon
id|DEBUG
c_func
(paren
l_int|3
comma
l_string|&quot;Transmit done. TSER = %x id %x&bslash;n&quot;
comma
id|txStatus
comma
id|readb
c_func
(paren
id|ramBase
op_plus
id|NETWAVE_EREG_TSER
op_plus
l_int|1
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|txStatus
op_amp
l_int|0x20
)paren
(brace
multiline_comment|/* Transmitting was okay, clear bits */
id|wait_WOC
c_func
(paren
id|iobase
)paren
suffix:semicolon
id|writeb
c_func
(paren
l_int|0x2f
comma
id|ramBase
op_plus
id|NETWAVE_EREG_TSER
op_plus
l_int|4
)paren
suffix:semicolon
op_increment
id|priv-&gt;stats.tx_packets
suffix:semicolon
)brace
r_if
c_cond
(paren
id|txStatus
op_amp
l_int|0xd0
)paren
(brace
r_if
c_cond
(paren
id|txStatus
op_amp
l_int|0x80
)paren
(brace
op_increment
id|priv-&gt;stats.collisions
suffix:semicolon
multiline_comment|/* Because of /proc/net/dev*/
multiline_comment|/* ++priv-&gt;stats.tx_aborted_errors; */
multiline_comment|/* printk(&quot;Collision. %ld&bslash;n&quot;, jiffies - dev-&gt;trans_start); */
)brace
r_if
c_cond
(paren
id|txStatus
op_amp
l_int|0x40
)paren
op_increment
id|priv-&gt;stats.tx_carrier_errors
suffix:semicolon
multiline_comment|/* 0x80 TxGU Transmit giveup - nine times and no luck&n;&t;&t; * 0x40 TxNOAP No access point. Discarded packet.&n;&t;&t; * 0x10 TxErr Transmit error. Always set when &n;&t;&t; *      TxGU and TxNOAP is set. (Those are the only ones&n;&t;&t; *      to set TxErr).&n;&t;&t; */
id|DEBUG
c_func
(paren
l_int|3
comma
l_string|&quot;netwave_interrupt: TxDN with error status %x&bslash;n&quot;
comma
id|txStatus
)paren
suffix:semicolon
multiline_comment|/* Clear out TxGU, TxNOAP, TxErr and TxTrys */
id|wait_WOC
c_func
(paren
id|iobase
)paren
suffix:semicolon
id|writeb
c_func
(paren
l_int|0xdf
op_amp
id|txStatus
comma
id|ramBase
op_plus
id|NETWAVE_EREG_TSER
op_plus
l_int|4
)paren
suffix:semicolon
op_increment
id|priv-&gt;stats.tx_errors
suffix:semicolon
)brace
id|DEBUG
c_func
(paren
l_int|3
comma
l_string|&quot;New status is TSER %x ASR %x&bslash;n&quot;
comma
id|readb
c_func
(paren
id|ramBase
op_plus
id|NETWAVE_EREG_TSER
)paren
comma
id|inb
c_func
(paren
id|iobase
op_plus
id|NETWAVE_REG_ASR
)paren
)paren
suffix:semicolon
id|netif_wake_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
multiline_comment|/* TxBA, this would trigger on all error packets received */
multiline_comment|/* if (status &amp; 0x01) {&n;&t;   DEBUG(4, &quot;Transmit buffers available, %x&bslash;n&quot;, status);&n;&t;   }&n;&t;   */
)brace
)brace
multiline_comment|/* netwave_interrupt */
multiline_comment|/*&n; * Function netwave_watchdog (a)&n; *&n; *    Watchdog : when we start a transmission, we set a timer in the&n; *    kernel.  If the transmission complete, this timer is disabled. If&n; *    it expire, we reset the card.&n; *&n; */
DECL|function|netwave_watchdog
r_static
r_void
id|netwave_watchdog
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
id|DEBUG
c_func
(paren
l_int|1
comma
l_string|&quot;%s: netwave_watchdog: watchdog timer expired&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|netwave_reset
c_func
(paren
id|dev
)paren
suffix:semicolon
id|dev-&gt;trans_start
op_assign
id|jiffies
suffix:semicolon
id|netif_start_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
multiline_comment|/* netwave_watchdog */
DECL|function|netwave_get_stats
r_static
r_struct
id|net_device_stats
op_star
id|netwave_get_stats
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
id|netwave_private
op_star
id|priv
op_assign
(paren
id|netwave_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|update_stats
c_func
(paren
id|dev
)paren
suffix:semicolon
id|DEBUG
c_func
(paren
l_int|2
comma
l_string|&quot;netwave: SPCQ %x SPU %x LIF %x ISPLQ %x MHS %x rxtx %x&quot;
l_string|&quot; %x tx %x %x %x %x&bslash;n&quot;
comma
id|readb
c_func
(paren
id|priv-&gt;ramBase
op_plus
id|NETWAVE_EREG_SPCQ
)paren
comma
id|readb
c_func
(paren
id|priv-&gt;ramBase
op_plus
id|NETWAVE_EREG_SPU
)paren
comma
id|readb
c_func
(paren
id|priv-&gt;ramBase
op_plus
id|NETWAVE_EREG_LIF
)paren
comma
id|readb
c_func
(paren
id|priv-&gt;ramBase
op_plus
id|NETWAVE_EREG_ISPLQ
)paren
comma
id|readb
c_func
(paren
id|priv-&gt;ramBase
op_plus
id|NETWAVE_EREG_MHS
)paren
comma
id|readb
c_func
(paren
id|priv-&gt;ramBase
op_plus
id|NETWAVE_EREG_EC
op_plus
l_int|0xe
)paren
comma
id|readb
c_func
(paren
id|priv-&gt;ramBase
op_plus
id|NETWAVE_EREG_EC
op_plus
l_int|0xf
)paren
comma
id|readb
c_func
(paren
id|priv-&gt;ramBase
op_plus
id|NETWAVE_EREG_EC
op_plus
l_int|0x18
)paren
comma
id|readb
c_func
(paren
id|priv-&gt;ramBase
op_plus
id|NETWAVE_EREG_EC
op_plus
l_int|0x19
)paren
comma
id|readb
c_func
(paren
id|priv-&gt;ramBase
op_plus
id|NETWAVE_EREG_EC
op_plus
l_int|0x1a
)paren
comma
id|readb
c_func
(paren
id|priv-&gt;ramBase
op_plus
id|NETWAVE_EREG_EC
op_plus
l_int|0x1b
)paren
)paren
suffix:semicolon
r_return
op_amp
id|priv-&gt;stats
suffix:semicolon
)brace
DECL|function|update_stats
r_static
r_void
id|update_stats
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/*     netwave_private *priv = (netwave_private*) dev-&gt;priv;&n;    priv-&gt;stats.rx_packets = readb(priv-&gt;ramBase + 0x18e); &n;    priv-&gt;stats.tx_packets = readb(priv-&gt;ramBase + 0x18f); */
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
DECL|function|netwave_rx
r_static
r_int
id|netwave_rx
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
id|netwave_private
op_star
id|priv
op_assign
(paren
id|netwave_private
op_star
)paren
(paren
id|dev-&gt;priv
)paren
suffix:semicolon
id|u_char
op_star
id|ramBase
op_assign
id|priv-&gt;ramBase
suffix:semicolon
id|ioaddr_t
id|iobase
op_assign
id|dev-&gt;base_addr
suffix:semicolon
id|u_char
id|rxStatus
suffix:semicolon
r_struct
id|sk_buff
op_star
id|skb
op_assign
l_int|NULL
suffix:semicolon
r_int
r_int
id|curBuffer
comma
id|rcvList
suffix:semicolon
r_int
id|rcvLen
suffix:semicolon
r_int
id|tmpcount
op_assign
l_int|0
suffix:semicolon
r_int
id|dataCount
comma
id|dataOffset
suffix:semicolon
r_int
id|i
suffix:semicolon
id|u_char
op_star
id|ptr
suffix:semicolon
id|DEBUG
c_func
(paren
l_int|3
comma
l_string|&quot;xinw_rx: Receiving ... &bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* Receive max 10 packets for now. */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|10
suffix:semicolon
id|i
op_increment
)paren
(brace
multiline_comment|/* Any packets? */
id|wait_WOC
c_func
(paren
id|iobase
)paren
suffix:semicolon
id|rxStatus
op_assign
id|readb
c_func
(paren
id|ramBase
op_plus
id|NETWAVE_EREG_RSER
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|rxStatus
op_amp
l_int|0x80
)paren
)paren
multiline_comment|/* No more packets */
r_break
suffix:semicolon
multiline_comment|/* Check if multicast/broadcast or other */
multiline_comment|/* multicast = (rxStatus &amp; 0x20);  */
multiline_comment|/* The receive list pointer and length of the packet */
id|wait_WOC
c_func
(paren
id|iobase
)paren
suffix:semicolon
id|rcvLen
op_assign
id|get_int16
c_func
(paren
id|ramBase
op_plus
id|NETWAVE_EREG_RDP
)paren
suffix:semicolon
id|rcvList
op_assign
id|get_uint16
c_func
(paren
id|ramBase
op_plus
id|NETWAVE_EREG_RDP
op_plus
l_int|2
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rcvLen
OL
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;netwave_rx: Receive packet with len %d&bslash;n&quot;
comma
id|rcvLen
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|skb
op_assign
id|dev_alloc_skb
c_func
(paren
id|rcvLen
op_plus
l_int|5
)paren
suffix:semicolon
r_if
c_cond
(paren
id|skb
op_eq
l_int|NULL
)paren
(brace
id|DEBUG
c_func
(paren
l_int|1
comma
l_string|&quot;netwave_rx: Could not allocate an sk_buff of &quot;
l_string|&quot;length %d&bslash;n&quot;
comma
id|rcvLen
)paren
suffix:semicolon
op_increment
id|priv-&gt;stats.rx_dropped
suffix:semicolon
multiline_comment|/* Tell the adapter to skip the packet */
id|wait_WOC
c_func
(paren
id|iobase
)paren
suffix:semicolon
id|writeb
c_func
(paren
id|NETWAVE_CMD_SRP
comma
id|ramBase
op_plus
id|NETWAVE_EREG_CB
op_plus
l_int|0
)paren
suffix:semicolon
id|writeb
c_func
(paren
id|NETWAVE_CMD_EOC
comma
id|ramBase
op_plus
id|NETWAVE_EREG_CB
op_plus
l_int|1
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|skb_reserve
c_func
(paren
id|skb
comma
l_int|2
)paren
suffix:semicolon
multiline_comment|/* Align IP on 16 byte */
id|skb_put
c_func
(paren
id|skb
comma
id|rcvLen
)paren
suffix:semicolon
id|skb-&gt;dev
op_assign
id|dev
suffix:semicolon
multiline_comment|/* Copy packet fragments to the skb data area */
id|ptr
op_assign
(paren
id|u_char
op_star
)paren
id|skb-&gt;data
suffix:semicolon
id|curBuffer
op_assign
id|rcvList
suffix:semicolon
id|tmpcount
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
id|tmpcount
OL
id|rcvLen
)paren
(brace
multiline_comment|/* Get length and offset of current buffer */
id|dataCount
op_assign
id|get_uint16
c_func
(paren
id|ramBase
op_plus
id|curBuffer
op_plus
l_int|2
)paren
suffix:semicolon
id|dataOffset
op_assign
id|get_uint16
c_func
(paren
id|ramBase
op_plus
id|curBuffer
op_plus
l_int|4
)paren
suffix:semicolon
id|copy_from_pc
c_func
(paren
id|ptr
op_plus
id|tmpcount
comma
id|ramBase
op_plus
id|curBuffer
op_plus
id|dataOffset
comma
id|dataCount
)paren
suffix:semicolon
id|tmpcount
op_add_assign
id|dataCount
suffix:semicolon
multiline_comment|/* Point to next buffer */
id|curBuffer
op_assign
id|get_uint16
c_func
(paren
id|ramBase
op_plus
id|curBuffer
)paren
suffix:semicolon
)brace
id|skb-&gt;protocol
op_assign
id|eth_type_trans
c_func
(paren
id|skb
comma
id|dev
)paren
suffix:semicolon
multiline_comment|/* Queue packet for network layer */
id|netif_rx
c_func
(paren
id|skb
)paren
suffix:semicolon
multiline_comment|/* Got the packet, tell the adapter to skip it */
id|wait_WOC
c_func
(paren
id|iobase
)paren
suffix:semicolon
id|writeb
c_func
(paren
id|NETWAVE_CMD_SRP
comma
id|ramBase
op_plus
id|NETWAVE_EREG_CB
op_plus
l_int|0
)paren
suffix:semicolon
id|writeb
c_func
(paren
id|NETWAVE_CMD_EOC
comma
id|ramBase
op_plus
id|NETWAVE_EREG_CB
op_plus
l_int|1
)paren
suffix:semicolon
id|DEBUG
c_func
(paren
l_int|3
comma
l_string|&quot;Packet reception ok&bslash;n&quot;
)paren
suffix:semicolon
id|priv-&gt;stats.rx_packets
op_increment
suffix:semicolon
id|priv-&gt;stats.rx_bytes
op_add_assign
id|skb-&gt;len
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|netwave_open
r_static
r_int
id|netwave_open
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
id|netwave_private
op_star
id|priv
op_assign
id|dev-&gt;priv
suffix:semicolon
id|dev_link_t
op_star
id|link
op_assign
op_amp
id|priv-&gt;link
suffix:semicolon
id|DEBUG
c_func
(paren
l_int|1
comma
l_string|&quot;netwave_open: starting.&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|DEV_OK
c_func
(paren
id|link
)paren
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
id|link-&gt;open
op_increment
suffix:semicolon
id|MOD_INC_USE_COUNT
suffix:semicolon
id|netif_start_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
id|netwave_reset
c_func
(paren
id|dev
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|netwave_close
r_static
r_int
id|netwave_close
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
id|netwave_private
op_star
id|priv
op_assign
(paren
id|netwave_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|dev_link_t
op_star
id|link
op_assign
op_amp
id|priv-&gt;link
suffix:semicolon
id|DEBUG
c_func
(paren
l_int|1
comma
l_string|&quot;netwave_close: finishing.&bslash;n&quot;
)paren
suffix:semicolon
id|link-&gt;open
op_decrement
suffix:semicolon
id|netif_stop_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|link-&gt;state
op_amp
id|DEV_STALE_CONFIG
)paren
id|mod_timer
c_func
(paren
op_amp
id|link-&gt;release
comma
id|jiffies
op_plus
id|HZ
op_div
l_int|20
)paren
suffix:semicolon
id|MOD_DEC_USE_COUNT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|init_netwave_cs
r_static
r_int
id|__init
id|init_netwave_cs
c_func
(paren
r_void
)paren
(brace
id|servinfo_t
id|serv
suffix:semicolon
id|DEBUG
c_func
(paren
l_int|0
comma
l_string|&quot;%s&bslash;n&quot;
comma
id|version
)paren
suffix:semicolon
id|CardServices
c_func
(paren
id|GetCardServicesInfo
comma
op_amp
id|serv
)paren
suffix:semicolon
r_if
c_cond
(paren
id|serv.Revision
op_ne
id|CS_RELEASE_CODE
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;netwave_cs: Card Services release does not match!&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|register_pccard_driver
c_func
(paren
op_amp
id|dev_info
comma
op_amp
id|netwave_attach
comma
op_amp
id|netwave_detach
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|exit_netwave_cs
r_static
r_void
id|__exit
id|exit_netwave_cs
c_func
(paren
r_void
)paren
(brace
id|DEBUG
c_func
(paren
l_int|1
comma
l_string|&quot;netwave_cs: unloading&bslash;n&quot;
)paren
suffix:semicolon
id|unregister_pccard_driver
c_func
(paren
op_amp
id|dev_info
)paren
suffix:semicolon
multiline_comment|/* Do some cleanup of the device list */
id|netwave_flush_stale_links
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dev_list
op_ne
l_int|NULL
)paren
(brace
multiline_comment|/* Critical situation */
id|printk
c_func
(paren
l_string|&quot;netwave_cs: devices remaining when removing module&bslash;n&quot;
)paren
suffix:semicolon
)brace
)brace
DECL|variable|init_netwave_cs
id|module_init
c_func
(paren
id|init_netwave_cs
)paren
suffix:semicolon
DECL|variable|exit_netwave_cs
id|module_exit
c_func
(paren
id|exit_netwave_cs
)paren
suffix:semicolon
multiline_comment|/* Set or clear the multicast filter for this adaptor.&n;   num_addrs == -1&t;Promiscuous mode, receive all packets&n;   num_addrs == 0&t;Normal mode, clear multicast list&n;   num_addrs &gt; 0&t;Multicast mode, receive normal and MC packets, and do&n;   best-effort filtering.&n; */
DECL|function|set_multicast_list
r_static
r_void
id|set_multicast_list
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
id|ioaddr_t
id|iobase
op_assign
id|dev-&gt;base_addr
suffix:semicolon
id|u_char
op_star
id|ramBase
op_assign
(paren
(paren
id|netwave_private
op_star
)paren
id|dev-&gt;priv
)paren
op_member_access_from_pointer
id|ramBase
suffix:semicolon
id|u_char
id|rcvMode
op_assign
l_int|0
suffix:semicolon
macro_line|#ifdef PCMCIA_DEBUG
r_if
c_cond
(paren
id|pc_debug
OG
l_int|2
)paren
(brace
r_static
r_int
id|old
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|old
op_ne
id|dev-&gt;mc_count
)paren
(brace
id|old
op_assign
id|dev-&gt;mc_count
suffix:semicolon
id|DEBUG
c_func
(paren
l_int|0
comma
l_string|&quot;%s: setting Rx mode to %d addresses.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|dev-&gt;mc_count
)paren
suffix:semicolon
)brace
)brace
macro_line|#endif
r_if
c_cond
(paren
id|dev-&gt;mc_count
op_logical_or
(paren
id|dev-&gt;flags
op_amp
id|IFF_ALLMULTI
)paren
)paren
(brace
multiline_comment|/* Multicast Mode */
id|rcvMode
op_assign
id|rxConfRxEna
op_plus
id|rxConfAMP
op_plus
id|rxConfBcast
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|dev-&gt;flags
op_amp
id|IFF_PROMISC
)paren
(brace
multiline_comment|/* Promiscous mode */
id|rcvMode
op_assign
id|rxConfRxEna
op_plus
id|rxConfPro
op_plus
id|rxConfAMP
op_plus
id|rxConfBcast
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* Normal mode */
id|rcvMode
op_assign
id|rxConfRxEna
op_plus
id|rxConfBcast
suffix:semicolon
)brace
multiline_comment|/* printk(&quot;netwave set_multicast_list: rcvMode to %x&bslash;n&quot;, rcvMode);*/
multiline_comment|/* Now set receive mode */
id|wait_WOC
c_func
(paren
id|iobase
)paren
suffix:semicolon
id|writeb
c_func
(paren
id|NETWAVE_CMD_SRC
comma
id|ramBase
op_plus
id|NETWAVE_EREG_CB
op_plus
l_int|0
)paren
suffix:semicolon
id|writeb
c_func
(paren
id|rcvMode
comma
id|ramBase
op_plus
id|NETWAVE_EREG_CB
op_plus
l_int|1
)paren
suffix:semicolon
id|writeb
c_func
(paren
id|NETWAVE_CMD_EOC
comma
id|ramBase
op_plus
id|NETWAVE_EREG_CB
op_plus
l_int|2
)paren
suffix:semicolon
)brace
eof
