multiline_comment|/*=============================================================================&n; *&n; * A  PCMCIA client driver for the Raylink wireless LAN card.&n; * The starting point for this module was the skeleton.c in the&n; * PCMCIA 2.9.12 package written by David Hinds, dhinds@allegro.stanford.edu&n; *&n; *&n; * Copyright (c) 1998  Corey Thomas (corey@world.std.com)&n; *&n; * This driver is free software; you can redistribute it and/or modify&n; * it under the terms of version 2 only of the GNU General Public License as &n; * published by the Free Software Foundation.&n; *&n; * It is distributed in the hope that it will be useful,&n; * but WITHOUT ANY WARRANTY; without even the implied warranty of&n; * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the&n; * GNU General Public License for more details.&n; *&n; * You should have received a copy of the GNU General Public License&n; * along with this program; if not, write to the Free Software&n; * Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA&n; *&n; * Changes:&n; * Arnaldo Carvalho de Melo &lt;acme@conectiva.com.br&gt; - 08/08/2000&n; * - reorganize kmallocs in ray_attach, checking all for failure&n; *   and releasing the previous allocations if one fails&n; *&n; * &n;=============================================================================*/
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/proc_fs.h&gt;
macro_line|#include &lt;linux/ptrace.h&gt;
macro_line|#include &lt;linux/malloc.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/timer.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/system.h&gt;
macro_line|#include &lt;asm/byteorder.h&gt;
macro_line|#include &lt;linux/netdevice.h&gt;
macro_line|#include &lt;linux/etherdevice.h&gt;
macro_line|#include &lt;linux/if_arp.h&gt;
macro_line|#include &lt;linux/ioport.h&gt;
macro_line|#include &lt;linux/skbuff.h&gt;
macro_line|#include &lt;pcmcia/version.h&gt;
macro_line|#include &lt;pcmcia/cs_types.h&gt;
macro_line|#include &lt;pcmcia/cs.h&gt;
macro_line|#include &lt;pcmcia/cistpl.h&gt;
macro_line|#include &lt;pcmcia/cisreg.h&gt;
macro_line|#include &lt;pcmcia/ds.h&gt;
macro_line|#include &lt;pcmcia/mem_op.h&gt;
macro_line|#ifdef CONFIG_NET_PCMCIA_RADIO
macro_line|#include &lt;linux/wireless.h&gt;
multiline_comment|/* Warning : these stuff will slow down the driver... */
DECL|macro|WIRELESS_SPY
mdefine_line|#define WIRELESS_SPY&t;&t;/* Enable spying addresses */
multiline_comment|/* Definitions we need for spy */
DECL|typedef|iw_stats
r_typedef
r_struct
id|iw_statistics
id|iw_stats
suffix:semicolon
DECL|typedef|iw_qual
r_typedef
r_struct
id|iw_quality
id|iw_qual
suffix:semicolon
DECL|typedef|mac_addr
r_typedef
id|u_char
id|mac_addr
(braket
id|ETH_ALEN
)braket
suffix:semicolon
multiline_comment|/* Hardware address */
macro_line|#endif&t;/* CONFIG_NET_PCMCIA_RADIO */
macro_line|#include &quot;rayctl.h&quot;
macro_line|#include &quot;ray_cs.h&quot;
multiline_comment|/* All the PCMCIA modules use PCMCIA_DEBUG to control debugging.  If&n;   you do not define PCMCIA_DEBUG at all, all the debug code will be&n;   left out.  If you compile with PCMCIA_DEBUG=0, the debug code will&n;   be present but disabled -- but it can then be enabled for specific&n;   modules at load time with a &squot;pc_debug=#&squot; option to insmod.&n;*/
macro_line|#ifdef RAYLINK_DEBUG
DECL|macro|PCMCIA_DEBUG
mdefine_line|#define PCMCIA_DEBUG RAYLINK_DEBUG
macro_line|#endif
macro_line|#ifdef PCMCIA_DEBUG
DECL|variable|ray_debug
r_static
r_int
id|ray_debug
op_assign
l_int|0
suffix:semicolon
DECL|variable|pc_debug
r_static
r_int
id|pc_debug
op_assign
id|PCMCIA_DEBUG
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|pc_debug
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
multiline_comment|/* #define DEBUG(n, args...) if (pc_debug&gt;(n)) printk(KERN_DEBUG args); */
DECL|macro|DEBUG
mdefine_line|#define DEBUG(n, args...) if (pc_debug&gt;(n)) printk(args);
macro_line|#else
DECL|macro|DEBUG
mdefine_line|#define DEBUG(n, args...)
macro_line|#endif
multiline_comment|/** Prototypes based on PCMCIA skeleton driver *******************************/
r_static
r_void
id|ray_config
c_func
(paren
id|dev_link_t
op_star
id|link
)paren
suffix:semicolon
r_static
r_void
id|ray_release
c_func
(paren
id|u_long
id|arg
)paren
suffix:semicolon
r_static
r_int
id|ray_event
c_func
(paren
id|event_t
id|event
comma
r_int
id|priority
comma
id|event_callback_args_t
op_star
id|args
)paren
suffix:semicolon
r_static
id|dev_link_t
op_star
id|ray_attach
c_func
(paren
r_void
)paren
suffix:semicolon
r_static
r_void
id|ray_detach
c_func
(paren
id|dev_link_t
op_star
)paren
suffix:semicolon
multiline_comment|/***** Prototypes indicated by device structure ******************************/
r_static
r_int
id|ray_dev_close
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_int
id|ray_dev_config
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_struct
id|ifmap
op_star
id|map
)paren
suffix:semicolon
r_static
r_struct
id|net_device_stats
op_star
id|ray_get_stats
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_int
id|ray_dev_init
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_int
id|ray_dev_ioctl
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_struct
id|ifreq
op_star
id|ifr
comma
r_int
id|cmd
)paren
suffix:semicolon
r_static
r_int
id|ray_open
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_int
id|ray_dev_start_xmit
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_void
id|set_multicast_list
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_void
id|ray_update_multi_list
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_int
id|all
)paren
suffix:semicolon
r_static
r_int
id|translate_frame
c_func
(paren
id|ray_dev_t
op_star
id|local
comma
r_struct
id|tx_msg
op_star
id|ptx
comma
r_int
r_char
op_star
id|data
comma
r_int
id|len
)paren
suffix:semicolon
r_static
r_void
id|ray_build_header
c_func
(paren
id|ray_dev_t
op_star
id|local
comma
r_struct
id|tx_msg
op_star
id|ptx
comma
id|UCHAR
id|msg_type
comma
r_int
r_char
op_star
id|data
)paren
suffix:semicolon
r_static
r_void
id|untranslate
c_func
(paren
id|ray_dev_t
op_star
id|local
comma
r_struct
id|sk_buff
op_star
id|skb
comma
r_int
id|len
)paren
suffix:semicolon
macro_line|#if WIRELESS_EXT &gt; 7&t;/* If wireless extension exist in the kernel */
r_static
id|iw_stats
op_star
id|ray_get_wireless_stats
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
macro_line|#endif&t;/* WIRELESS_EXT &gt; 7 */
multiline_comment|/***** Prototypes for raylink functions **************************************/
r_static
r_int
id|asc_to_int
c_func
(paren
r_char
id|a
)paren
suffix:semicolon
r_static
r_void
id|authenticate
c_func
(paren
id|ray_dev_t
op_star
id|local
)paren
suffix:semicolon
r_static
r_int
id|build_auth_frame
c_func
(paren
id|ray_dev_t
op_star
id|local
comma
id|UCHAR
op_star
id|dest
comma
r_int
id|auth_type
)paren
suffix:semicolon
r_static
r_void
id|authenticate_timeout
c_func
(paren
id|u_long
)paren
suffix:semicolon
r_static
r_int
id|get_free_ccs
c_func
(paren
id|ray_dev_t
op_star
id|local
)paren
suffix:semicolon
r_static
r_int
id|get_free_tx_ccs
c_func
(paren
id|ray_dev_t
op_star
id|local
)paren
suffix:semicolon
r_static
r_void
id|init_startup_params
c_func
(paren
id|ray_dev_t
op_star
id|local
)paren
suffix:semicolon
r_static
r_int
id|parse_addr
c_func
(paren
r_char
op_star
id|in_str
comma
id|UCHAR
op_star
id|out
)paren
suffix:semicolon
r_static
r_int
id|ray_hw_xmit
c_func
(paren
r_int
r_char
op_star
id|data
comma
r_int
id|len
comma
r_struct
id|net_device
op_star
id|dev
comma
id|UCHAR
id|type
)paren
suffix:semicolon
r_static
r_int
id|ray_init
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_int
id|interrupt_ecf
c_func
(paren
id|ray_dev_t
op_star
id|local
comma
r_int
id|ccs
)paren
suffix:semicolon
r_static
r_void
id|ray_reset
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_void
id|ray_update_parm
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
id|UCHAR
id|objid
comma
id|UCHAR
op_star
id|value
comma
r_int
id|len
)paren
suffix:semicolon
r_static
r_void
id|verify_dl_startup
c_func
(paren
id|u_long
)paren
suffix:semicolon
multiline_comment|/* Prototypes for interrpt time functions **********************************/
r_static
r_void
id|ray_interrupt
(paren
r_int
id|reg
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
suffix:semicolon
r_static
r_void
id|clear_interrupt
c_func
(paren
id|ray_dev_t
op_star
id|local
)paren
suffix:semicolon
r_static
r_void
id|rx_deauthenticate
c_func
(paren
id|ray_dev_t
op_star
id|local
comma
r_struct
id|rcs
op_star
id|prcs
comma
r_int
r_int
id|pkt_addr
comma
r_int
id|rx_len
)paren
suffix:semicolon
r_static
r_int
id|copy_from_rx_buff
c_func
(paren
id|ray_dev_t
op_star
id|local
comma
id|UCHAR
op_star
id|dest
comma
r_int
id|pkt_addr
comma
r_int
id|len
)paren
suffix:semicolon
r_static
r_void
id|ray_rx
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
id|ray_dev_t
op_star
id|local
comma
r_struct
id|rcs
op_star
id|prcs
)paren
suffix:semicolon
r_static
r_void
id|release_frag_chain
c_func
(paren
id|ray_dev_t
op_star
id|local
comma
r_struct
id|rcs
op_star
id|prcs
)paren
suffix:semicolon
r_static
r_void
id|rx_authenticate
c_func
(paren
id|ray_dev_t
op_star
id|local
comma
r_struct
id|rcs
op_star
id|prcs
comma
r_int
r_int
id|pkt_addr
comma
r_int
id|rx_len
)paren
suffix:semicolon
r_static
r_void
id|rx_data
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_struct
id|rcs
op_star
id|prcs
comma
r_int
r_int
id|pkt_addr
comma
r_int
id|rx_len
)paren
suffix:semicolon
r_static
r_void
id|associate
c_func
(paren
id|ray_dev_t
op_star
id|local
)paren
suffix:semicolon
multiline_comment|/* Card command functions */
r_static
r_int
id|dl_startup_params
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_void
id|join_net
c_func
(paren
id|u_long
id|local
)paren
suffix:semicolon
r_static
r_void
id|start_net
c_func
(paren
id|u_long
id|local
)paren
suffix:semicolon
multiline_comment|/* void start_net(ray_dev_t *local); */
multiline_comment|/* Create symbol table for registering with kernel in init_module */
DECL|variable|ray_dev_ioctl
id|EXPORT_SYMBOL
c_func
(paren
id|ray_dev_ioctl
)paren
suffix:semicolon
DECL|variable|ray_rx
id|EXPORT_SYMBOL
c_func
(paren
id|ray_rx
)paren
suffix:semicolon
multiline_comment|/*===========================================================================*/
multiline_comment|/* Parameters that can be set with &squot;insmod&squot; */
multiline_comment|/* Bit map of interrupts to choose from */
multiline_comment|/* This means pick from 15, 14, 12, 11, 10, 9, 7, 5, 4, and 3 */
DECL|variable|irq_mask
r_static
id|u_long
id|irq_mask
op_assign
l_int|0xdeb8
suffix:semicolon
multiline_comment|/* ADHOC=0, Infrastructure=1 */
DECL|variable|net_type
r_static
r_int
id|net_type
op_assign
id|ADHOC
suffix:semicolon
multiline_comment|/* Hop dwell time in Kus (1024 us units defined by 802.11) */
DECL|variable|hop_dwell
r_static
r_int
id|hop_dwell
op_assign
l_int|128
suffix:semicolon
multiline_comment|/* Beacon period in Kus */
DECL|variable|beacon_period
r_static
r_int
id|beacon_period
op_assign
l_int|256
suffix:semicolon
multiline_comment|/* power save mode (0 = off, 1 = save power) */
DECL|variable|psm
r_static
r_int
id|psm
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* String for network&squot;s Extended Service Set ID. 32 Characters max */
DECL|variable|essid
r_static
r_char
op_star
id|essid
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/* Default to encapsulation unless translation requested */
DECL|variable|translate
r_static
r_int
id|translate
op_assign
l_int|1
suffix:semicolon
DECL|variable|country
r_static
r_int
id|country
op_assign
id|USA
suffix:semicolon
DECL|variable|sniffer
r_static
r_int
id|sniffer
op_assign
l_int|0
suffix:semicolon
DECL|variable|bc
r_static
r_int
id|bc
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* 48 bit physical card address if overriding card&squot;s real physical&n; * address is required.  Since IEEE 802.11 addresses are 48 bits&n; * like ethernet, an int can&squot;t be used, so a string is used. To&n; * allow use of addresses starting with a decimal digit, the first&n; * character must be a letter and will be ignored. This letter is&n; * followed by up to 12 hex digits which are the address.  If less&n; * than 12 digits are used, the address will be left filled with 0&squot;s.&n; * Note that bit 0 of the first byte is the broadcast bit, and evil&n; * things will happen if it is not 0 in a card address.&n; */
DECL|variable|phy_addr
r_static
r_char
op_star
id|phy_addr
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/* The dev_info variable is the &quot;key&quot; that is used to match up this&n;   device driver with appropriate cards, through the card configuration&n;   database.&n;*/
DECL|variable|dev_info
r_static
id|dev_info_t
id|dev_info
op_assign
l_string|&quot;ray_cs&quot;
suffix:semicolon
multiline_comment|/* A linked list of &quot;instances&quot; of the ray device.  Each actual&n;   PCMCIA card corresponds to one device instance, and is described&n;   by one dev_link_t structure (defined in ds.h).&n;*/
DECL|variable|dev_list
r_static
id|dev_link_t
op_star
id|dev_list
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/* A dev_link_t structure has fields for most things that are needed&n;   to keep track of a socket, but there will usually be some device&n;   specific information that also needs to be kept track of.  The&n;   &squot;priv&squot; pointer in a dev_link_t structure can be used to point to&n;   a device-specific private data structure, like this.&n;*/
DECL|variable|ray_mem_speed
r_static
r_int
r_int
id|ray_mem_speed
op_assign
l_int|500
suffix:semicolon
id|MODULE_AUTHOR
c_func
(paren
l_string|&quot;Corey Thomas &lt;corey@world.std.com&gt;&quot;
)paren
suffix:semicolon
id|MODULE_DESCRIPTION
c_func
(paren
l_string|&quot;Raylink/WebGear wireless LAN driver&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|irq_mask
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|net_type
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|hop_dwell
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|beacon_period
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|psm
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|essid
comma
l_string|&quot;s&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|translate
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|country
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|sniffer
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|bc
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|phy_addr
comma
l_string|&quot;s&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|ray_mem_speed
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
DECL|variable|b5_default_startup_parms
r_static
id|UCHAR
id|b5_default_startup_parms
(braket
)braket
op_assign
(brace
l_int|0
comma
l_int|0
comma
multiline_comment|/* Adhoc station */
l_char|&squot;L&squot;
comma
l_char|&squot;I&squot;
comma
l_char|&squot;N&squot;
comma
l_char|&squot;U&squot;
comma
l_char|&squot;X&squot;
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
multiline_comment|/* 32 char ESSID */
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|1
comma
l_int|0
comma
multiline_comment|/* Active scan, CA Mode */
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
multiline_comment|/* No default MAC addr  */
l_int|0x7f
comma
l_int|0xff
comma
multiline_comment|/* Frag threshold */
l_int|0x00
comma
l_int|0x80
comma
multiline_comment|/* Hop time 128 Kus*/
l_int|0x01
comma
l_int|0x00
comma
multiline_comment|/* Beacon period 256 Kus */
l_int|0x01
comma
l_int|0x07
comma
l_int|0xa3
comma
multiline_comment|/* DTIM, retries, ack timeout*/
l_int|0x1d
comma
l_int|0x82
comma
l_int|0x4e
comma
multiline_comment|/* SIFS, DIFS, PIFS */
l_int|0x7f
comma
l_int|0xff
comma
multiline_comment|/* RTS threshold */
l_int|0x04
comma
l_int|0xe2
comma
l_int|0x38
comma
l_int|0xA4
comma
multiline_comment|/* scan_dwell, max_scan_dwell */
l_int|0x05
comma
multiline_comment|/* assoc resp timeout thresh */
l_int|0x08
comma
l_int|0x02
comma
l_int|0x08
comma
multiline_comment|/* adhoc, infra, super cycle max*/
l_int|0
comma
multiline_comment|/* Promiscuous mode */
l_int|0x0c
comma
l_int|0x0bd
comma
multiline_comment|/* Unique word */
l_int|0x32
comma
multiline_comment|/* Slot time */
l_int|0xff
comma
l_int|0xff
comma
multiline_comment|/* roam-low snr, low snr count */
l_int|0x05
comma
l_int|0xff
comma
multiline_comment|/* Infra, adhoc missed bcn thresh */
l_int|0x01
comma
l_int|0x0b
comma
l_int|0x4f
comma
multiline_comment|/* USA, hop pattern, hop pat length */
multiline_comment|/* b4 - b5 differences start here */
l_int|0x00
comma
l_int|0x3f
comma
multiline_comment|/* CW max */
l_int|0x00
comma
l_int|0x0f
comma
multiline_comment|/* CW min */
l_int|0x04
comma
l_int|0x08
comma
multiline_comment|/* Noise gain, limit offset */
l_int|0x28
comma
l_int|0x28
comma
multiline_comment|/* det rssi, med busy offsets */
l_int|7
comma
multiline_comment|/* det sync thresh */
l_int|0
comma
l_int|2
comma
l_int|2
comma
multiline_comment|/* test mode, min, max */
l_int|0
comma
multiline_comment|/* allow broadcast SSID probe resp */
l_int|0
comma
l_int|0
comma
multiline_comment|/* privacy must start, can join */
l_int|2
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
multiline_comment|/* basic rate set */
)brace
suffix:semicolon
DECL|variable|b4_default_startup_parms
r_static
id|UCHAR
id|b4_default_startup_parms
(braket
)braket
op_assign
(brace
l_int|0
comma
l_int|0
comma
multiline_comment|/* Adhoc station */
l_char|&squot;L&squot;
comma
l_char|&squot;I&squot;
comma
l_char|&squot;N&squot;
comma
l_char|&squot;U&squot;
comma
l_char|&squot;X&squot;
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
multiline_comment|/* 32 char ESSID */
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|1
comma
l_int|0
comma
multiline_comment|/* Active scan, CA Mode */
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
multiline_comment|/* No default MAC addr  */
l_int|0x7f
comma
l_int|0xff
comma
multiline_comment|/* Frag threshold */
l_int|0x02
comma
l_int|0x00
comma
multiline_comment|/* Hop time */
l_int|0x00
comma
l_int|0x01
comma
multiline_comment|/* Beacon period */
l_int|0x01
comma
l_int|0x07
comma
l_int|0xa3
comma
multiline_comment|/* DTIM, retries, ack timeout*/
l_int|0x1d
comma
l_int|0x82
comma
l_int|0xce
comma
multiline_comment|/* SIFS, DIFS, PIFS */
l_int|0x7f
comma
l_int|0xff
comma
multiline_comment|/* RTS threshold */
l_int|0xfb
comma
l_int|0x1e
comma
l_int|0xc7
comma
l_int|0x5c
comma
multiline_comment|/* scan_dwell, max_scan_dwell */
l_int|0x05
comma
multiline_comment|/* assoc resp timeout thresh */
l_int|0x04
comma
l_int|0x02
comma
l_int|0x4
comma
multiline_comment|/* adhoc, infra, super cycle max*/
l_int|0
comma
multiline_comment|/* Promiscuous mode */
l_int|0x0c
comma
l_int|0x0bd
comma
multiline_comment|/* Unique word */
l_int|0x4e
comma
multiline_comment|/* Slot time (TBD seems wrong)*/
l_int|0xff
comma
l_int|0xff
comma
multiline_comment|/* roam-low snr, low snr count */
l_int|0x05
comma
l_int|0xff
comma
multiline_comment|/* Infra, adhoc missed bcn thresh */
l_int|0x01
comma
l_int|0x0b
comma
l_int|0x4e
comma
multiline_comment|/* USA, hop pattern, hop pat length */
multiline_comment|/* b4 - b5 differences start here */
l_int|0x3f
comma
l_int|0x0f
comma
multiline_comment|/* CW max, min */
l_int|0x04
comma
l_int|0x08
comma
multiline_comment|/* Noise gain, limit offset */
l_int|0x28
comma
l_int|0x28
comma
multiline_comment|/* det rssi, med busy offsets */
l_int|7
comma
multiline_comment|/* det sync thresh */
l_int|0
comma
l_int|2
comma
l_int|2
multiline_comment|/* test mode, min, max*/
)brace
suffix:semicolon
multiline_comment|/*===========================================================================*/
DECL|variable|eth2_llc
r_static
r_int
r_char
id|eth2_llc
(braket
)braket
op_assign
(brace
l_int|0xaa
comma
l_int|0xaa
comma
l_int|3
comma
l_int|0
comma
l_int|0
comma
l_int|0
)brace
suffix:semicolon
DECL|variable|hop_pattern_length
r_static
r_char
id|hop_pattern_length
(braket
)braket
op_assign
(brace
l_int|1
comma
id|USA_HOP_MOD
comma
id|EUROPE_HOP_MOD
comma
id|JAPAN_HOP_MOD
comma
id|KOREA_HOP_MOD
comma
id|SPAIN_HOP_MOD
comma
id|FRANCE_HOP_MOD
comma
id|ISRAEL_HOP_MOD
comma
id|AUSTRALIA_HOP_MOD
comma
id|JAPAN_TEST_HOP_MOD
)brace
suffix:semicolon
DECL|variable|rcsid
r_static
r_char
id|rcsid
(braket
)braket
op_assign
l_string|&quot;Raylink/WebGear wireless LAN - Corey &lt;Thomas corey@world.std.com&gt;&quot;
suffix:semicolon
multiline_comment|/*===========================================================================*/
DECL|function|cs_error
r_static
r_void
id|cs_error
c_func
(paren
id|client_handle_t
id|handle
comma
r_int
id|func
comma
r_int
id|ret
)paren
(brace
id|error_info_t
id|err
op_assign
(brace
id|func
comma
id|ret
)brace
suffix:semicolon
id|pcmcia_report_error
c_func
(paren
id|handle
comma
op_amp
id|err
)paren
suffix:semicolon
)brace
multiline_comment|/*======================================================================&n;&n;    This bit of code is used to avoid unregistering network devices&n;    at inappropriate times.  2.2 and later kernels are fairly picky&n;    about when this can happen.&n;    &n;======================================================================*/
DECL|function|flush_stale_links
r_static
r_void
id|flush_stale_links
c_func
(paren
r_void
)paren
(brace
id|dev_link_t
op_star
id|link
comma
op_star
id|next
suffix:semicolon
r_for
c_loop
(paren
id|link
op_assign
id|dev_list
suffix:semicolon
id|link
suffix:semicolon
id|link
op_assign
id|next
)paren
(brace
id|next
op_assign
id|link-&gt;next
suffix:semicolon
r_if
c_cond
(paren
id|link-&gt;state
op_amp
id|DEV_STALE_LINK
)paren
id|ray_detach
c_func
(paren
id|link
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/*=============================================================================&n;    ray_attach() creates an &quot;instance&quot; of the driver, allocating&n;    local data structures for one device.  The device is registered&n;    with Card Services.&n;    The dev_link structure is initialized, but we don&squot;t actually&n;    configure the card at this point -- we wait until we receive a&n;    card insertion event.&n;=============================================================================*/
DECL|function|ray_attach
r_static
id|dev_link_t
op_star
id|ray_attach
c_func
(paren
r_void
)paren
(brace
id|client_reg_t
id|client_reg
suffix:semicolon
id|dev_link_t
op_star
id|link
suffix:semicolon
id|ray_dev_t
op_star
id|local
suffix:semicolon
r_int
id|ret
suffix:semicolon
r_struct
id|net_device
op_star
id|dev
suffix:semicolon
id|DEBUG
c_func
(paren
l_int|1
comma
l_string|&quot;ray_attach()&bslash;n&quot;
)paren
suffix:semicolon
id|flush_stale_links
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* Initialize the dev_link_t structure */
id|link
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|dev_link_t
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|link
)paren
r_return
l_int|NULL
suffix:semicolon
multiline_comment|/* Allocate space for private device-specific data */
id|dev
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|net_device
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dev
)paren
r_goto
id|fail_alloc_dev
suffix:semicolon
id|local
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
id|ray_dev_t
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|local
)paren
r_goto
id|fail_alloc_local
suffix:semicolon
id|memset
c_func
(paren
id|link
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|dev_link_t
)paren
)paren
suffix:semicolon
id|memset
c_func
(paren
id|dev
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|net_device
)paren
)paren
suffix:semicolon
id|memset
c_func
(paren
id|local
comma
l_int|0
comma
r_sizeof
(paren
id|ray_dev_t
)paren
)paren
suffix:semicolon
id|link-&gt;release.function
op_assign
op_amp
id|ray_release
suffix:semicolon
id|link-&gt;release.data
op_assign
(paren
id|u_long
)paren
id|link
suffix:semicolon
multiline_comment|/* The io structure describes IO port mapping. None used here */
id|link-&gt;io.NumPorts1
op_assign
l_int|0
suffix:semicolon
id|link-&gt;io.Attributes1
op_assign
id|IO_DATA_PATH_WIDTH_8
suffix:semicolon
id|link-&gt;io.IOAddrLines
op_assign
l_int|5
suffix:semicolon
multiline_comment|/* Interrupt setup. For PCMCIA, driver takes what&squot;s given */
id|link-&gt;irq.Attributes
op_assign
id|IRQ_TYPE_EXCLUSIVE
op_or
id|IRQ_HANDLE_PRESENT
suffix:semicolon
id|link-&gt;irq.IRQInfo1
op_assign
id|IRQ_INFO2_VALID
op_or
id|IRQ_LEVEL_ID
suffix:semicolon
id|link-&gt;irq.IRQInfo2
op_assign
id|irq_mask
suffix:semicolon
id|link-&gt;irq.Handler
op_assign
op_amp
id|ray_interrupt
suffix:semicolon
multiline_comment|/* General socket configuration */
id|link-&gt;conf.Attributes
op_assign
id|CONF_ENABLE_IRQ
suffix:semicolon
id|link-&gt;conf.Vcc
op_assign
l_int|50
suffix:semicolon
id|link-&gt;conf.IntType
op_assign
id|INT_MEMORY_AND_IO
suffix:semicolon
id|link-&gt;conf.ConfigIndex
op_assign
l_int|1
suffix:semicolon
id|link-&gt;conf.Present
op_assign
id|PRESENT_OPTION
suffix:semicolon
id|link-&gt;priv
op_assign
id|dev
suffix:semicolon
id|link-&gt;irq.Instance
op_assign
id|dev
suffix:semicolon
id|dev-&gt;priv
op_assign
id|local
suffix:semicolon
id|local-&gt;finder
op_assign
id|link
suffix:semicolon
id|local-&gt;card_status
op_assign
id|CARD_INSERTED
suffix:semicolon
id|local-&gt;authentication_state
op_assign
id|UNAUTHENTICATED
suffix:semicolon
id|local-&gt;num_multi
op_assign
l_int|0
suffix:semicolon
id|DEBUG
c_func
(paren
l_int|2
comma
l_string|&quot;ray_attach link = %p,  dev = %p,  local = %p, intr = %p&bslash;n&quot;
comma
id|link
comma
id|dev
comma
id|local
comma
op_amp
id|ray_interrupt
)paren
suffix:semicolon
multiline_comment|/* Raylink entries in the device structure */
id|dev-&gt;hard_start_xmit
op_assign
op_amp
id|ray_dev_start_xmit
suffix:semicolon
id|dev-&gt;set_config
op_assign
op_amp
id|ray_dev_config
suffix:semicolon
id|dev-&gt;get_stats
op_assign
op_amp
id|ray_get_stats
suffix:semicolon
id|dev-&gt;do_ioctl
op_assign
op_amp
id|ray_dev_ioctl
suffix:semicolon
macro_line|#if WIRELESS_EXT &gt; 7&t;/* If wireless extension exist in the kernel */
id|dev-&gt;get_wireless_stats
op_assign
id|ray_get_wireless_stats
suffix:semicolon
macro_line|#endif
id|dev-&gt;set_multicast_list
op_assign
op_amp
id|set_multicast_list
suffix:semicolon
id|DEBUG
c_func
(paren
l_int|2
comma
l_string|&quot;ray_cs ray_attach calling ether_setup.)&bslash;n&quot;
)paren
suffix:semicolon
id|ether_setup
c_func
(paren
id|dev
)paren
suffix:semicolon
id|dev-&gt;init
op_assign
op_amp
id|ray_dev_init
suffix:semicolon
id|dev-&gt;open
op_assign
op_amp
id|ray_open
suffix:semicolon
id|dev-&gt;stop
op_assign
op_amp
id|ray_dev_close
suffix:semicolon
id|netif_stop_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
multiline_comment|/* Register with Card Services */
id|link-&gt;next
op_assign
id|dev_list
suffix:semicolon
id|dev_list
op_assign
id|link
suffix:semicolon
id|client_reg.dev_info
op_assign
op_amp
id|dev_info
suffix:semicolon
id|client_reg.Attributes
op_assign
id|INFO_IO_CLIENT
op_or
id|INFO_CARD_SHARE
suffix:semicolon
id|client_reg.EventMask
op_assign
id|CS_EVENT_CARD_INSERTION
op_or
id|CS_EVENT_CARD_REMOVAL
op_or
id|CS_EVENT_RESET_PHYSICAL
op_or
id|CS_EVENT_CARD_RESET
op_or
id|CS_EVENT_PM_SUSPEND
op_or
id|CS_EVENT_PM_RESUME
suffix:semicolon
id|client_reg.event_handler
op_assign
op_amp
id|ray_event
suffix:semicolon
id|client_reg.Version
op_assign
l_int|0x0210
suffix:semicolon
id|client_reg.event_callback_args.client_data
op_assign
id|link
suffix:semicolon
id|DEBUG
c_func
(paren
l_int|2
comma
l_string|&quot;ray_cs ray_attach calling CardServices(RegisterClient...)&bslash;n&quot;
)paren
suffix:semicolon
id|init_timer
c_func
(paren
op_amp
id|local-&gt;timer
)paren
suffix:semicolon
id|ret
op_assign
id|pcmcia_register_client
c_func
(paren
op_amp
id|link-&gt;handle
comma
op_amp
id|client_reg
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
op_ne
l_int|0
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;ray_cs ray_attach RegisterClient unhappy - detaching&bslash;n&quot;
)paren
suffix:semicolon
id|cs_error
c_func
(paren
id|link-&gt;handle
comma
id|RegisterClient
comma
id|ret
)paren
suffix:semicolon
id|ray_detach
c_func
(paren
id|link
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
id|DEBUG
c_func
(paren
l_int|2
comma
l_string|&quot;ray_cs ray_attach ending&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|link
suffix:semicolon
id|fail_alloc_local
suffix:colon
id|kfree
c_func
(paren
id|dev
)paren
suffix:semicolon
id|fail_alloc_dev
suffix:colon
id|kfree
c_func
(paren
id|link
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
multiline_comment|/* ray_attach */
multiline_comment|/*=============================================================================&n;    This deletes a driver &quot;instance&quot;.  The device is de-registered&n;    with Card Services.  If it has been released, all local data&n;    structures are freed.  Otherwise, the structures will be freed&n;    when the device is released.&n;=============================================================================*/
DECL|function|ray_detach
r_static
r_void
id|ray_detach
c_func
(paren
id|dev_link_t
op_star
id|link
)paren
(brace
id|dev_link_t
op_star
op_star
id|linkp
suffix:semicolon
id|DEBUG
c_func
(paren
l_int|1
comma
l_string|&quot;ray_detach(0x%p)&bslash;n&quot;
comma
id|link
)paren
suffix:semicolon
multiline_comment|/* Locate device structure */
r_for
c_loop
(paren
id|linkp
op_assign
op_amp
id|dev_list
suffix:semicolon
op_star
id|linkp
suffix:semicolon
id|linkp
op_assign
op_amp
(paren
op_star
id|linkp
)paren
op_member_access_from_pointer
id|next
)paren
r_if
c_cond
(paren
op_star
id|linkp
op_eq
id|link
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
op_star
id|linkp
op_eq
l_int|NULL
)paren
r_return
suffix:semicolon
multiline_comment|/* If the device is currently configured and active, we won&squot;t&n;      actually delete it yet.  Instead, it is marked so that when&n;      the release() function is called, that will trigger a proper&n;      detach().&n;    */
id|del_timer
c_func
(paren
op_amp
id|link-&gt;release
)paren
suffix:semicolon
r_if
c_cond
(paren
id|link-&gt;state
op_amp
id|DEV_CONFIG
)paren
(brace
id|ray_release
c_func
(paren
(paren
id|u_long
)paren
id|link
)paren
suffix:semicolon
r_if
c_cond
(paren
id|link-&gt;state
op_amp
id|DEV_STALE_CONFIG
)paren
(brace
id|link-&gt;state
op_or_assign
id|DEV_STALE_LINK
suffix:semicolon
r_return
suffix:semicolon
)brace
)brace
multiline_comment|/* Break the link with Card Services */
r_if
c_cond
(paren
id|link-&gt;handle
)paren
id|pcmcia_deregister_client
c_func
(paren
id|link-&gt;handle
)paren
suffix:semicolon
multiline_comment|/* Unlink device structure, free pieces */
op_star
id|linkp
op_assign
id|link-&gt;next
suffix:semicolon
r_if
c_cond
(paren
id|link-&gt;priv
)paren
(brace
r_struct
id|net_device
op_star
id|dev
op_assign
id|link-&gt;priv
suffix:semicolon
r_if
c_cond
(paren
id|link-&gt;dev
)paren
id|unregister_netdev
c_func
(paren
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;priv
)paren
id|kfree
c_func
(paren
id|dev-&gt;priv
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|link-&gt;priv
)paren
suffix:semicolon
)brace
id|kfree
c_func
(paren
id|link
)paren
suffix:semicolon
id|DEBUG
c_func
(paren
l_int|2
comma
l_string|&quot;ray_cs ray_detach ending&bslash;n&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/* ray_detach */
multiline_comment|/*=============================================================================&n;    ray_config() is run after a CARD_INSERTION event&n;    is received, to configure the PCMCIA socket, and to make the&n;    ethernet device available to the system.&n;=============================================================================*/
DECL|macro|CS_CHECK
mdefine_line|#define CS_CHECK(fn, args...) &bslash;&n;while ((last_ret=fn(args))!=0) goto cs_failed
DECL|macro|MAX_TUPLE_SIZE
mdefine_line|#define MAX_TUPLE_SIZE 128
DECL|function|ray_config
r_static
r_void
id|ray_config
c_func
(paren
id|dev_link_t
op_star
id|link
)paren
(brace
id|client_handle_t
id|handle
op_assign
id|link-&gt;handle
suffix:semicolon
id|tuple_t
id|tuple
suffix:semicolon
id|cisparse_t
id|parse
suffix:semicolon
r_int
id|last_fn
op_assign
l_int|0
comma
id|last_ret
op_assign
l_int|0
suffix:semicolon
r_int
id|i
suffix:semicolon
id|u_char
id|buf
(braket
id|MAX_TUPLE_SIZE
)braket
suffix:semicolon
id|win_req_t
id|req
suffix:semicolon
id|memreq_t
id|mem
suffix:semicolon
r_struct
id|net_device
op_star
id|dev
op_assign
(paren
r_struct
id|net_device
op_star
)paren
id|link-&gt;priv
suffix:semicolon
id|ray_dev_t
op_star
id|local
op_assign
(paren
id|ray_dev_t
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|DEBUG
c_func
(paren
l_int|1
comma
l_string|&quot;ray_config(0x%p)&bslash;n&quot;
comma
id|link
)paren
suffix:semicolon
multiline_comment|/* This reads the card&squot;s CONFIG tuple to find its configuration regs */
id|tuple.DesiredTuple
op_assign
id|CISTPL_CONFIG
suffix:semicolon
id|CS_CHECK
c_func
(paren
id|pcmcia_get_first_tuple
comma
id|handle
comma
op_amp
id|tuple
)paren
suffix:semicolon
id|tuple.TupleData
op_assign
id|buf
suffix:semicolon
id|tuple.TupleDataMax
op_assign
id|MAX_TUPLE_SIZE
suffix:semicolon
id|tuple.TupleOffset
op_assign
l_int|0
suffix:semicolon
id|CS_CHECK
c_func
(paren
id|pcmcia_get_tuple_data
comma
id|handle
comma
op_amp
id|tuple
)paren
suffix:semicolon
id|CS_CHECK
c_func
(paren
id|pcmcia_parse_tuple
comma
id|handle
comma
op_amp
id|tuple
comma
op_amp
id|parse
)paren
suffix:semicolon
id|link-&gt;conf.ConfigBase
op_assign
id|parse.config.base
suffix:semicolon
id|link-&gt;conf.Present
op_assign
id|parse.config.rmask
(braket
l_int|0
)braket
suffix:semicolon
multiline_comment|/* Determine card type and firmware version */
id|buf
(braket
l_int|0
)braket
op_assign
id|buf
(braket
id|MAX_TUPLE_SIZE
op_minus
l_int|1
)braket
op_assign
l_int|0
suffix:semicolon
id|tuple.DesiredTuple
op_assign
id|CISTPL_VERS_1
suffix:semicolon
id|CS_CHECK
c_func
(paren
id|pcmcia_get_first_tuple
comma
id|handle
comma
op_amp
id|tuple
)paren
suffix:semicolon
id|tuple.TupleData
op_assign
id|buf
suffix:semicolon
id|tuple.TupleDataMax
op_assign
id|MAX_TUPLE_SIZE
suffix:semicolon
id|tuple.TupleOffset
op_assign
l_int|2
suffix:semicolon
id|CS_CHECK
c_func
(paren
id|pcmcia_get_tuple_data
comma
id|handle
comma
op_amp
id|tuple
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|tuple.TupleDataLen
op_minus
l_int|4
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
id|buf
(braket
id|i
)braket
op_eq
l_int|0
)paren
id|buf
(braket
id|i
)braket
op_assign
l_char|&squot; &squot;
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;ray_cs Detected: %s&bslash;n&quot;
comma
id|buf
)paren
suffix:semicolon
multiline_comment|/* Configure card */
id|link-&gt;state
op_or_assign
id|DEV_CONFIG
suffix:semicolon
multiline_comment|/* Now allocate an interrupt line.  Note that this does not&n;       actually assign a handler to the interrupt.&n;    */
id|CS_CHECK
c_func
(paren
id|pcmcia_request_irq
comma
id|link-&gt;handle
comma
op_amp
id|link-&gt;irq
)paren
suffix:semicolon
id|dev-&gt;irq
op_assign
id|link-&gt;irq.AssignedIRQ
suffix:semicolon
multiline_comment|/* This actually configures the PCMCIA socket -- setting up&n;       the I/O windows and the interrupt mapping.&n;    */
id|CS_CHECK
c_func
(paren
id|pcmcia_request_configuration
comma
id|link-&gt;handle
comma
op_amp
id|link-&gt;conf
)paren
suffix:semicolon
multiline_comment|/*** Set up 32k window for shared memory (transmit and control) ************/
id|req.Attributes
op_assign
id|WIN_DATA_WIDTH_8
op_or
id|WIN_MEMORY_TYPE_CM
op_or
id|WIN_ENABLE
op_or
id|WIN_USE_WAIT
suffix:semicolon
id|req.Base
op_assign
l_int|0
suffix:semicolon
id|req.Size
op_assign
l_int|0x8000
suffix:semicolon
id|req.AccessSpeed
op_assign
id|ray_mem_speed
suffix:semicolon
id|CS_CHECK
c_func
(paren
id|pcmcia_request_window
comma
op_amp
id|link-&gt;handle
comma
op_amp
id|req
comma
op_amp
id|link-&gt;win
)paren
suffix:semicolon
id|mem.CardOffset
op_assign
l_int|0x0000
suffix:semicolon
id|mem.Page
op_assign
l_int|0
suffix:semicolon
id|CS_CHECK
c_func
(paren
id|pcmcia_map_mem_page
comma
id|link-&gt;win
comma
op_amp
id|mem
)paren
suffix:semicolon
id|local-&gt;sram
op_assign
(paren
id|UCHAR
op_star
)paren
(paren
id|ioremap
c_func
(paren
id|req.Base
comma
id|req.Size
)paren
)paren
suffix:semicolon
multiline_comment|/*** Set up 16k window for shared memory (receive buffer) ***************/
id|req.Attributes
op_assign
id|WIN_DATA_WIDTH_8
op_or
id|WIN_MEMORY_TYPE_CM
op_or
id|WIN_ENABLE
op_or
id|WIN_USE_WAIT
suffix:semicolon
id|req.Base
op_assign
l_int|0
suffix:semicolon
id|req.Size
op_assign
l_int|0x4000
suffix:semicolon
id|req.AccessSpeed
op_assign
id|ray_mem_speed
suffix:semicolon
id|CS_CHECK
c_func
(paren
id|pcmcia_request_window
comma
op_amp
id|link-&gt;handle
comma
op_amp
id|req
comma
op_amp
id|local-&gt;rmem_handle
)paren
suffix:semicolon
id|mem.CardOffset
op_assign
l_int|0x8000
suffix:semicolon
id|mem.Page
op_assign
l_int|0
suffix:semicolon
id|CS_CHECK
c_func
(paren
id|pcmcia_map_mem_page
comma
id|local-&gt;rmem_handle
comma
op_amp
id|mem
)paren
suffix:semicolon
id|local-&gt;rmem
op_assign
(paren
id|UCHAR
op_star
)paren
(paren
id|ioremap
c_func
(paren
id|req.Base
comma
id|req.Size
)paren
)paren
suffix:semicolon
multiline_comment|/*** Set up window for attribute memory ***********************************/
id|req.Attributes
op_assign
id|WIN_DATA_WIDTH_8
op_or
id|WIN_MEMORY_TYPE_AM
op_or
id|WIN_ENABLE
op_or
id|WIN_USE_WAIT
suffix:semicolon
id|req.Base
op_assign
l_int|0
suffix:semicolon
id|req.Size
op_assign
l_int|0x1000
suffix:semicolon
id|req.AccessSpeed
op_assign
id|ray_mem_speed
suffix:semicolon
id|CS_CHECK
c_func
(paren
id|pcmcia_request_window
comma
op_amp
id|link-&gt;handle
comma
op_amp
id|req
comma
op_amp
id|local-&gt;amem_handle
)paren
suffix:semicolon
id|mem.CardOffset
op_assign
l_int|0x0000
suffix:semicolon
id|mem.Page
op_assign
l_int|0
suffix:semicolon
id|CS_CHECK
c_func
(paren
id|pcmcia_map_mem_page
comma
id|local-&gt;amem_handle
comma
op_amp
id|mem
)paren
suffix:semicolon
id|local-&gt;amem
op_assign
(paren
id|UCHAR
op_star
)paren
(paren
id|ioremap
c_func
(paren
id|req.Base
comma
id|req.Size
)paren
)paren
suffix:semicolon
id|DEBUG
c_func
(paren
l_int|3
comma
l_string|&quot;ray_config sram=%p&bslash;n&quot;
comma
id|local-&gt;sram
)paren
suffix:semicolon
id|DEBUG
c_func
(paren
l_int|3
comma
l_string|&quot;ray_config rmem=%p&bslash;n&quot;
comma
id|local-&gt;rmem
)paren
suffix:semicolon
id|DEBUG
c_func
(paren
l_int|3
comma
l_string|&quot;ray_config amem=%p&bslash;n&quot;
comma
id|local-&gt;amem
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ray_init
c_func
(paren
id|dev
)paren
OL
l_int|0
)paren
(brace
id|ray_release
c_func
(paren
(paren
id|u_long
)paren
id|link
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|i
op_assign
id|register_netdev
c_func
(paren
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
op_ne
l_int|0
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;ray_config register_netdev() failed&bslash;n&quot;
)paren
suffix:semicolon
id|ray_release
c_func
(paren
(paren
id|u_long
)paren
id|link
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|strcpy
c_func
(paren
id|local-&gt;node.dev_name
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|link-&gt;dev
op_assign
op_amp
id|local-&gt;node
suffix:semicolon
id|link-&gt;state
op_and_assign
op_complement
id|DEV_CONFIG_PENDING
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: RayLink, irq %d, hw_addr &quot;
comma
id|dev-&gt;name
comma
id|dev-&gt;irq
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|6
suffix:semicolon
id|i
op_increment
)paren
id|printk
c_func
(paren
l_string|&quot;%02X%s&quot;
comma
id|dev-&gt;dev_addr
(braket
id|i
)braket
comma
(paren
(paren
id|i
OL
l_int|5
)paren
ques
c_cond
l_string|&quot;:&quot;
suffix:colon
l_string|&quot;&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_return
suffix:semicolon
id|cs_failed
suffix:colon
id|cs_error
c_func
(paren
id|link-&gt;handle
comma
id|last_fn
comma
id|last_ret
)paren
suffix:semicolon
id|ray_release
c_func
(paren
(paren
id|u_long
)paren
id|link
)paren
suffix:semicolon
)brace
multiline_comment|/* ray_config */
multiline_comment|/*===========================================================================*/
DECL|function|ray_init
r_static
r_int
id|ray_init
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_int
id|i
suffix:semicolon
id|UCHAR
op_star
id|p
suffix:semicolon
r_struct
id|ccs
op_star
id|pccs
suffix:semicolon
id|ray_dev_t
op_star
id|local
op_assign
(paren
id|ray_dev_t
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|dev_link_t
op_star
id|link
op_assign
id|local-&gt;finder
suffix:semicolon
id|DEBUG
c_func
(paren
l_int|1
comma
l_string|&quot;ray_init(0x%p)&bslash;n&quot;
comma
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|link-&gt;state
op_amp
id|DEV_PRESENT
)paren
)paren
(brace
id|DEBUG
c_func
(paren
l_int|0
comma
l_string|&quot;ray_init - device not present&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|local-&gt;net_type
op_assign
id|net_type
suffix:semicolon
id|local-&gt;sta_type
op_assign
id|TYPE_STA
suffix:semicolon
multiline_comment|/* Copy the startup results to local memory */
id|memcpy_fromio
c_func
(paren
op_amp
id|local-&gt;startup_res
comma
id|local-&gt;sram
op_plus
id|ECF_TO_HOST_BASE
comma
"&bslash;"
r_sizeof
(paren
r_struct
id|startup_res_6
)paren
)paren
suffix:semicolon
multiline_comment|/* Check Power up test status and get mac address from card */
r_if
c_cond
(paren
id|local-&gt;startup_res.startup_word
op_ne
l_int|0x80
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;ray_init ERROR card status = %2x&bslash;n&quot;
comma
id|local-&gt;startup_res.startup_word
)paren
suffix:semicolon
id|local-&gt;card_status
op_assign
id|CARD_INIT_ERROR
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|local-&gt;fw_ver
op_assign
id|local-&gt;startup_res.firmware_version
(braket
l_int|0
)braket
suffix:semicolon
id|local-&gt;fw_bld
op_assign
id|local-&gt;startup_res.firmware_version
(braket
l_int|1
)braket
suffix:semicolon
id|local-&gt;fw_var
op_assign
id|local-&gt;startup_res.firmware_version
(braket
l_int|2
)braket
suffix:semicolon
id|DEBUG
c_func
(paren
l_int|1
comma
l_string|&quot;ray_init firmware version %d.%d &bslash;n&quot;
comma
id|local-&gt;fw_ver
comma
id|local-&gt;fw_bld
)paren
suffix:semicolon
id|local-&gt;tib_length
op_assign
l_int|0x20
suffix:semicolon
r_if
c_cond
(paren
(paren
id|local-&gt;fw_ver
op_eq
l_int|5
)paren
op_logical_and
(paren
id|local-&gt;fw_bld
op_ge
l_int|30
)paren
)paren
id|local-&gt;tib_length
op_assign
id|local-&gt;startup_res.tib_length
suffix:semicolon
id|DEBUG
c_func
(paren
l_int|2
comma
l_string|&quot;ray_init tib_length = 0x%02x&bslash;n&quot;
comma
id|local-&gt;tib_length
)paren
suffix:semicolon
multiline_comment|/* Initialize CCS&squot;s to buffer free state */
id|pccs
op_assign
(paren
r_struct
id|ccs
op_star
)paren
(paren
id|local-&gt;sram
op_plus
id|CCS_BASE
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|NUMBER_OF_CCS
suffix:semicolon
id|i
op_increment
)paren
(brace
id|writeb
c_func
(paren
id|CCS_BUFFER_FREE
comma
op_amp
(paren
id|pccs
op_increment
)paren
op_member_access_from_pointer
id|buffer_status
)paren
suffix:semicolon
)brace
id|init_startup_params
c_func
(paren
id|local
)paren
suffix:semicolon
multiline_comment|/* copy mac address to startup parameters */
r_if
c_cond
(paren
id|parse_addr
c_func
(paren
id|phy_addr
comma
id|local-&gt;sparm.b4.a_mac_addr
)paren
)paren
(brace
id|p
op_assign
id|local-&gt;sparm.b4.a_mac_addr
suffix:semicolon
)brace
r_else
(brace
id|memcpy
c_func
(paren
op_amp
id|local-&gt;sparm.b4.a_mac_addr
comma
op_amp
id|local-&gt;startup_res.station_addr
comma
id|ADDRLEN
)paren
suffix:semicolon
id|p
op_assign
id|local-&gt;sparm.b4.a_mac_addr
suffix:semicolon
)brace
id|clear_interrupt
c_func
(paren
id|local
)paren
suffix:semicolon
multiline_comment|/* Clear any interrupt from the card */
id|local-&gt;card_status
op_assign
id|CARD_AWAITING_PARAM
suffix:semicolon
id|DEBUG
c_func
(paren
l_int|2
comma
l_string|&quot;ray_init ending&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* ray_init */
multiline_comment|/*===========================================================================*/
multiline_comment|/* Download startup parameters to the card and command it to read them       */
DECL|function|dl_startup_params
r_static
r_int
id|dl_startup_params
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_int
id|ccsindex
suffix:semicolon
id|ray_dev_t
op_star
id|local
op_assign
(paren
id|ray_dev_t
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_struct
id|ccs
op_star
id|pccs
suffix:semicolon
id|dev_link_t
op_star
id|link
op_assign
id|local-&gt;finder
suffix:semicolon
id|DEBUG
c_func
(paren
l_int|1
comma
l_string|&quot;dl_startup_params entered&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|link-&gt;state
op_amp
id|DEV_PRESENT
)paren
)paren
(brace
id|DEBUG
c_func
(paren
l_int|2
comma
l_string|&quot;ray_cs dl_startup_params - device not present&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
multiline_comment|/* Copy parameters to host to ECF area */
r_if
c_cond
(paren
id|local-&gt;fw_ver
op_eq
l_int|0x55
)paren
id|memcpy_toio
c_func
(paren
id|local-&gt;sram
op_plus
id|HOST_TO_ECF_BASE
comma
op_amp
id|local-&gt;sparm.b4
comma
r_sizeof
(paren
r_struct
id|b4_startup_params
)paren
)paren
suffix:semicolon
r_else
id|memcpy_toio
c_func
(paren
id|local-&gt;sram
op_plus
id|HOST_TO_ECF_BASE
comma
op_amp
id|local-&gt;sparm.b5
comma
r_sizeof
(paren
r_struct
id|b5_startup_params
)paren
)paren
suffix:semicolon
multiline_comment|/* Fill in the CCS fields for the ECF */
r_if
c_cond
(paren
(paren
id|ccsindex
op_assign
id|get_free_ccs
c_func
(paren
id|local
)paren
)paren
OL
l_int|0
)paren
r_return
op_minus
l_int|1
suffix:semicolon
id|local-&gt;dl_param_ccs
op_assign
id|ccsindex
suffix:semicolon
id|pccs
op_assign
(paren
(paren
r_struct
id|ccs
op_star
)paren
(paren
id|local-&gt;sram
op_plus
id|CCS_BASE
)paren
)paren
op_plus
id|ccsindex
suffix:semicolon
id|writeb
c_func
(paren
id|CCS_DOWNLOAD_STARTUP_PARAMS
comma
op_amp
id|pccs-&gt;cmd
)paren
suffix:semicolon
id|DEBUG
c_func
(paren
l_int|2
comma
l_string|&quot;dl_startup_params start ccsindex = %d&bslash;n&quot;
comma
id|local-&gt;dl_param_ccs
)paren
suffix:semicolon
multiline_comment|/* Interrupt the firmware to process the command */
r_if
c_cond
(paren
id|interrupt_ecf
c_func
(paren
id|local
comma
id|ccsindex
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;ray dl_startup_params failed - &quot;
l_string|&quot;ECF not ready for intr&bslash;n&quot;
)paren
suffix:semicolon
id|local-&gt;card_status
op_assign
id|CARD_DL_PARAM_ERROR
suffix:semicolon
id|writeb
c_func
(paren
id|CCS_BUFFER_FREE
comma
op_amp
(paren
id|pccs
op_increment
)paren
op_member_access_from_pointer
id|buffer_status
)paren
suffix:semicolon
r_return
op_minus
l_int|2
suffix:semicolon
)brace
id|local-&gt;card_status
op_assign
id|CARD_DL_PARAM
suffix:semicolon
multiline_comment|/* Start kernel timer to wait for dl startup to complete. */
id|local-&gt;timer.expires
op_assign
id|jiffies
op_plus
id|HZ
op_div
l_int|2
suffix:semicolon
id|local-&gt;timer.data
op_assign
(paren
r_int
)paren
id|local
suffix:semicolon
id|local-&gt;timer.function
op_assign
op_amp
id|verify_dl_startup
suffix:semicolon
id|add_timer
c_func
(paren
op_amp
id|local-&gt;timer
)paren
suffix:semicolon
id|DEBUG
c_func
(paren
l_int|2
comma
l_string|&quot;ray_cs dl_startup_params started timer for verify_dl_startup&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* dl_startup_params */
multiline_comment|/*===========================================================================*/
DECL|function|init_startup_params
r_static
r_void
id|init_startup_params
c_func
(paren
id|ray_dev_t
op_star
id|local
)paren
(brace
r_int
id|i
suffix:semicolon
r_if
c_cond
(paren
id|country
OG
id|JAPAN_TEST
)paren
id|country
op_assign
id|USA
suffix:semicolon
r_else
r_if
c_cond
(paren
id|country
OL
id|USA
)paren
id|country
op_assign
id|USA
suffix:semicolon
multiline_comment|/* structure for hop time and beacon period is defined here using &n;     * New 802.11D6.1 format.  Card firmware is still using old format&n;     * until version 6.&n;     *    Before                    After&n;     *    a_hop_time ms byte        a_hop_time ms byte&n;     *    a_hop_time 2s byte        a_hop_time ls byte&n;     *    a_hop_time ls byte        a_beacon_period ms byte&n;     *    a_beacon_period           a_beacon_period ls byte&n;     *&n;     *    a_hop_time = uS           a_hop_time = KuS&n;     *    a_beacon_period = hops    a_beacon_period = KuS&n;     */
multiline_comment|/* 64ms = 010000 */
r_if
c_cond
(paren
id|local-&gt;fw_ver
op_eq
l_int|0x55
)paren
(brace
id|memcpy
c_func
(paren
(paren
id|UCHAR
op_star
)paren
op_amp
id|local-&gt;sparm.b4
comma
id|b4_default_startup_parms
comma
r_sizeof
(paren
r_struct
id|b4_startup_params
)paren
)paren
suffix:semicolon
multiline_comment|/* Translate sane kus input values to old build 4/5 format */
multiline_comment|/* i = hop time in uS truncated to 3 bytes */
id|i
op_assign
(paren
id|hop_dwell
op_star
l_int|1024
)paren
op_amp
l_int|0xffffff
suffix:semicolon
id|local-&gt;sparm.b4.a_hop_time
(braket
l_int|0
)braket
op_assign
(paren
id|i
op_rshift
l_int|16
)paren
op_amp
l_int|0xff
suffix:semicolon
id|local-&gt;sparm.b4.a_hop_time
(braket
l_int|1
)braket
op_assign
(paren
id|i
op_rshift
l_int|8
)paren
op_amp
l_int|0xff
suffix:semicolon
id|local-&gt;sparm.b4.a_beacon_period
(braket
l_int|0
)braket
op_assign
l_int|0
suffix:semicolon
id|local-&gt;sparm.b4.a_beacon_period
(braket
l_int|1
)braket
op_assign
(paren
(paren
id|beacon_period
op_div
id|hop_dwell
)paren
op_minus
l_int|1
)paren
op_amp
l_int|0xff
suffix:semicolon
id|local-&gt;sparm.b4.a_curr_country_code
op_assign
id|country
suffix:semicolon
id|local-&gt;sparm.b4.a_hop_pattern_length
op_assign
id|hop_pattern_length
(braket
(paren
r_int
)paren
id|country
)braket
op_minus
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|bc
)paren
(brace
id|local-&gt;sparm.b4.a_ack_timeout
op_assign
l_int|0x50
suffix:semicolon
id|local-&gt;sparm.b4.a_sifs
op_assign
l_int|0x3f
suffix:semicolon
)brace
)brace
r_else
(brace
multiline_comment|/* Version 5 uses real kus values */
id|memcpy
c_func
(paren
(paren
id|UCHAR
op_star
)paren
op_amp
id|local-&gt;sparm.b5
comma
id|b5_default_startup_parms
comma
r_sizeof
(paren
r_struct
id|b5_startup_params
)paren
)paren
suffix:semicolon
id|local-&gt;sparm.b5.a_hop_time
(braket
l_int|0
)braket
op_assign
(paren
id|hop_dwell
op_rshift
l_int|8
)paren
op_amp
l_int|0xff
suffix:semicolon
id|local-&gt;sparm.b5.a_hop_time
(braket
l_int|1
)braket
op_assign
id|hop_dwell
op_amp
l_int|0xff
suffix:semicolon
id|local-&gt;sparm.b5.a_beacon_period
(braket
l_int|0
)braket
op_assign
(paren
id|beacon_period
op_rshift
l_int|8
)paren
op_amp
l_int|0xff
suffix:semicolon
id|local-&gt;sparm.b5.a_beacon_period
(braket
l_int|1
)braket
op_assign
id|beacon_period
op_amp
l_int|0xff
suffix:semicolon
r_if
c_cond
(paren
id|psm
)paren
id|local-&gt;sparm.b5.a_power_mgt_state
op_assign
l_int|1
suffix:semicolon
id|local-&gt;sparm.b5.a_curr_country_code
op_assign
id|country
suffix:semicolon
id|local-&gt;sparm.b5.a_hop_pattern_length
op_assign
id|hop_pattern_length
(braket
(paren
r_int
)paren
id|country
)braket
suffix:semicolon
)brace
id|local-&gt;sparm.b4.a_network_type
op_assign
id|net_type
op_amp
l_int|0x01
suffix:semicolon
id|local-&gt;sparm.b4.a_acting_as_ap_status
op_assign
id|TYPE_STA
suffix:semicolon
r_if
c_cond
(paren
id|essid
op_ne
l_int|NULL
)paren
id|strncpy
c_func
(paren
id|local-&gt;sparm.b4.a_current_ess_id
comma
id|essid
comma
id|ESSID_SIZE
)paren
suffix:semicolon
)brace
multiline_comment|/* init_startup_params */
multiline_comment|/*===========================================================================*/
DECL|function|verify_dl_startup
r_static
r_void
id|verify_dl_startup
c_func
(paren
id|u_long
id|data
)paren
(brace
id|ray_dev_t
op_star
id|local
op_assign
(paren
id|ray_dev_t
op_star
)paren
id|data
suffix:semicolon
r_struct
id|ccs
op_star
id|pccs
op_assign
(paren
(paren
r_struct
id|ccs
op_star
)paren
(paren
id|local-&gt;sram
op_plus
id|CCS_BASE
)paren
)paren
op_plus
id|local-&gt;dl_param_ccs
suffix:semicolon
id|UCHAR
id|status
suffix:semicolon
id|dev_link_t
op_star
id|link
op_assign
id|local-&gt;finder
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|link-&gt;state
op_amp
id|DEV_PRESENT
)paren
)paren
(brace
id|DEBUG
c_func
(paren
l_int|2
comma
l_string|&quot;ray_cs verify_dl_startup - device not present&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
macro_line|#ifdef PCMCIA_DEBUG
r_if
c_cond
(paren
id|pc_debug
OG
l_int|2
)paren
(brace
r_int
id|i
suffix:semicolon
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;verify_dl_startup parameters sent via ccs %d:&bslash;n&quot;
comma
id|local-&gt;dl_param_ccs
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
r_sizeof
(paren
r_struct
id|b5_startup_params
)paren
suffix:semicolon
id|i
op_increment
)paren
(brace
id|printk
c_func
(paren
l_string|&quot; %2x&quot;
comma
(paren
r_int
r_int
)paren
id|readb
c_func
(paren
id|local-&gt;sram
op_plus
id|HOST_TO_ECF_BASE
op_plus
id|i
)paren
)paren
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
)brace
macro_line|#endif
id|status
op_assign
id|readb
c_func
(paren
op_amp
id|pccs-&gt;buffer_status
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
op_ne
id|CCS_BUFFER_FREE
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;Download startup params failed.  Status = %d&bslash;n&quot;
comma
id|status
)paren
suffix:semicolon
id|local-&gt;card_status
op_assign
id|CARD_DL_PARAM_ERROR
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|local-&gt;sparm.b4.a_network_type
op_eq
id|ADHOC
)paren
id|start_net
c_func
(paren
(paren
id|u_long
)paren
id|local
)paren
suffix:semicolon
r_else
id|join_net
c_func
(paren
(paren
id|u_long
)paren
id|local
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/* end verify_dl_startup */
multiline_comment|/*===========================================================================*/
multiline_comment|/* Command card to start a network */
DECL|function|start_net
r_static
r_void
id|start_net
c_func
(paren
id|u_long
id|data
)paren
(brace
id|ray_dev_t
op_star
id|local
op_assign
(paren
id|ray_dev_t
op_star
)paren
id|data
suffix:semicolon
r_struct
id|ccs
op_star
id|pccs
suffix:semicolon
r_int
id|ccsindex
suffix:semicolon
id|dev_link_t
op_star
id|link
op_assign
id|local-&gt;finder
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|link-&gt;state
op_amp
id|DEV_PRESENT
)paren
)paren
(brace
id|DEBUG
c_func
(paren
l_int|2
comma
l_string|&quot;ray_cs start_net - device not present&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/* Fill in the CCS fields for the ECF */
r_if
c_cond
(paren
(paren
id|ccsindex
op_assign
id|get_free_ccs
c_func
(paren
id|local
)paren
)paren
OL
l_int|0
)paren
r_return
suffix:semicolon
id|pccs
op_assign
(paren
(paren
r_struct
id|ccs
op_star
)paren
(paren
id|local-&gt;sram
op_plus
id|CCS_BASE
)paren
)paren
op_plus
id|ccsindex
suffix:semicolon
id|writeb
c_func
(paren
id|CCS_START_NETWORK
comma
op_amp
id|pccs-&gt;cmd
)paren
suffix:semicolon
id|writeb
c_func
(paren
l_int|0
comma
op_amp
id|pccs-&gt;var.start_network.update_param
)paren
suffix:semicolon
multiline_comment|/* Interrupt the firmware to process the command */
r_if
c_cond
(paren
id|interrupt_ecf
c_func
(paren
id|local
comma
id|ccsindex
)paren
)paren
(brace
id|DEBUG
c_func
(paren
l_int|1
comma
l_string|&quot;ray start net failed - card not ready for intr&bslash;n&quot;
)paren
suffix:semicolon
id|writeb
c_func
(paren
id|CCS_BUFFER_FREE
comma
op_amp
(paren
id|pccs
op_increment
)paren
op_member_access_from_pointer
id|buffer_status
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|local-&gt;card_status
op_assign
id|CARD_DOING_ACQ
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/* end start_net */
multiline_comment|/*===========================================================================*/
multiline_comment|/* Command card to join a network */
DECL|function|join_net
r_static
r_void
id|join_net
c_func
(paren
id|u_long
id|data
)paren
(brace
id|ray_dev_t
op_star
id|local
op_assign
(paren
id|ray_dev_t
op_star
)paren
id|data
suffix:semicolon
r_struct
id|ccs
op_star
id|pccs
suffix:semicolon
r_int
id|ccsindex
suffix:semicolon
id|dev_link_t
op_star
id|link
op_assign
id|local-&gt;finder
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|link-&gt;state
op_amp
id|DEV_PRESENT
)paren
)paren
(brace
id|DEBUG
c_func
(paren
l_int|2
comma
l_string|&quot;ray_cs join_net - device not present&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/* Fill in the CCS fields for the ECF */
r_if
c_cond
(paren
(paren
id|ccsindex
op_assign
id|get_free_ccs
c_func
(paren
id|local
)paren
)paren
OL
l_int|0
)paren
r_return
suffix:semicolon
id|pccs
op_assign
(paren
(paren
r_struct
id|ccs
op_star
)paren
(paren
id|local-&gt;sram
op_plus
id|CCS_BASE
)paren
)paren
op_plus
id|ccsindex
suffix:semicolon
id|writeb
c_func
(paren
id|CCS_JOIN_NETWORK
comma
op_amp
id|pccs-&gt;cmd
)paren
suffix:semicolon
id|writeb
c_func
(paren
l_int|0
comma
op_amp
id|pccs-&gt;var.join_network.update_param
)paren
suffix:semicolon
id|writeb
c_func
(paren
l_int|0
comma
op_amp
id|pccs-&gt;var.join_network.net_initiated
)paren
suffix:semicolon
multiline_comment|/* Interrupt the firmware to process the command */
r_if
c_cond
(paren
id|interrupt_ecf
c_func
(paren
id|local
comma
id|ccsindex
)paren
)paren
(brace
id|DEBUG
c_func
(paren
l_int|1
comma
l_string|&quot;ray join net failed - card not ready for intr&bslash;n&quot;
)paren
suffix:semicolon
id|writeb
c_func
(paren
id|CCS_BUFFER_FREE
comma
op_amp
(paren
id|pccs
op_increment
)paren
op_member_access_from_pointer
id|buffer_status
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|local-&gt;card_status
op_assign
id|CARD_DOING_ACQ
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/*============================================================================&n;    After a card is removed, ray_release() will unregister the net&n;    device, and release the PCMCIA configuration.  If the device is&n;    still open, this will be postponed until it is closed.&n;=============================================================================*/
DECL|function|ray_release
r_static
r_void
id|ray_release
c_func
(paren
id|u_long
id|arg
)paren
(brace
id|dev_link_t
op_star
id|link
op_assign
(paren
id|dev_link_t
op_star
)paren
id|arg
suffix:semicolon
r_struct
id|net_device
op_star
id|dev
op_assign
id|link-&gt;priv
suffix:semicolon
id|ray_dev_t
op_star
id|local
op_assign
id|dev-&gt;priv
suffix:semicolon
r_int
id|i
suffix:semicolon
id|DEBUG
c_func
(paren
l_int|1
comma
l_string|&quot;ray_release(0x%p)&bslash;n&quot;
comma
id|link
)paren
suffix:semicolon
multiline_comment|/* If the device is currently in use, we won&squot;t release until it&n;      is actually closed.&n;    */
r_if
c_cond
(paren
id|link-&gt;open
)paren
(brace
id|DEBUG
c_func
(paren
l_int|1
comma
l_string|&quot;ray_cs: release postponed, &squot;%s&squot; still open&bslash;n&quot;
comma
id|link-&gt;dev-&gt;dev_name
)paren
suffix:semicolon
id|link-&gt;state
op_or_assign
id|DEV_STALE_CONFIG
suffix:semicolon
r_return
suffix:semicolon
)brace
id|del_timer
c_func
(paren
op_amp
id|local-&gt;timer
)paren
suffix:semicolon
id|link-&gt;state
op_and_assign
op_complement
id|DEV_CONFIG
suffix:semicolon
id|iounmap
c_func
(paren
id|local-&gt;sram
)paren
suffix:semicolon
id|iounmap
c_func
(paren
id|local-&gt;rmem
)paren
suffix:semicolon
id|iounmap
c_func
(paren
id|local-&gt;amem
)paren
suffix:semicolon
multiline_comment|/* Do bother checking to see if these succeed or not */
id|i
op_assign
id|pcmcia_release_window
c_func
(paren
id|link-&gt;win
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
op_ne
id|CS_SUCCESS
)paren
id|DEBUG
c_func
(paren
l_int|0
comma
l_string|&quot;ReleaseWindow(link-&gt;win) ret = %x&bslash;n&quot;
comma
id|i
)paren
suffix:semicolon
id|i
op_assign
id|pcmcia_release_window
c_func
(paren
id|local-&gt;amem_handle
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
op_ne
id|CS_SUCCESS
)paren
id|DEBUG
c_func
(paren
l_int|0
comma
l_string|&quot;ReleaseWindow(local-&gt;amem) ret = %x&bslash;n&quot;
comma
id|i
)paren
suffix:semicolon
id|i
op_assign
id|pcmcia_release_window
c_func
(paren
id|local-&gt;rmem_handle
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
op_ne
id|CS_SUCCESS
)paren
id|DEBUG
c_func
(paren
l_int|0
comma
l_string|&quot;ReleaseWindow(local-&gt;rmem) ret = %x&bslash;n&quot;
comma
id|i
)paren
suffix:semicolon
id|i
op_assign
id|pcmcia_release_configuration
c_func
(paren
id|link-&gt;handle
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
op_ne
id|CS_SUCCESS
)paren
id|DEBUG
c_func
(paren
l_int|0
comma
l_string|&quot;ReleaseConfiguration ret = %x&bslash;n&quot;
comma
id|i
)paren
suffix:semicolon
id|i
op_assign
id|pcmcia_release_irq
c_func
(paren
id|link-&gt;handle
comma
op_amp
id|link-&gt;irq
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
op_ne
id|CS_SUCCESS
)paren
id|DEBUG
c_func
(paren
l_int|0
comma
l_string|&quot;ReleaseIRQ ret = %x&bslash;n&quot;
comma
id|i
)paren
suffix:semicolon
id|DEBUG
c_func
(paren
l_int|2
comma
l_string|&quot;ray_release ending&bslash;n&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/* ray_release */
multiline_comment|/*=============================================================================&n;    The card status event handler.  Mostly, this schedules other&n;    stuff to run after an event is received.  A CARD_REMOVAL event&n;    also sets some flags to discourage the net drivers from trying&n;    to talk to the card any more.&n;&n;    When a CARD_REMOVAL event is received, we immediately set a flag&n;    to block future accesses to this device.  All the functions that&n;    actually access the device should check this flag to make sure&n;    the card is still present.&n;=============================================================================*/
DECL|function|ray_event
r_static
r_int
id|ray_event
c_func
(paren
id|event_t
id|event
comma
r_int
id|priority
comma
id|event_callback_args_t
op_star
id|args
)paren
(brace
id|dev_link_t
op_star
id|link
op_assign
id|args-&gt;client_data
suffix:semicolon
r_struct
id|net_device
op_star
id|dev
op_assign
id|link-&gt;priv
suffix:semicolon
id|ray_dev_t
op_star
id|local
op_assign
(paren
id|ray_dev_t
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|DEBUG
c_func
(paren
l_int|1
comma
l_string|&quot;ray_event(0x%06x)&bslash;n&quot;
comma
id|event
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|event
)paren
(brace
r_case
id|CS_EVENT_CARD_REMOVAL
suffix:colon
id|link-&gt;state
op_and_assign
op_complement
id|DEV_PRESENT
suffix:semicolon
id|netif_device_detach
c_func
(paren
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|link-&gt;state
op_amp
id|DEV_CONFIG
)paren
(brace
id|mod_timer
c_func
(paren
op_amp
id|link-&gt;release
comma
id|jiffies
op_plus
id|HZ
op_div
l_int|20
)paren
suffix:semicolon
id|del_timer
c_func
(paren
op_amp
id|local-&gt;timer
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|CS_EVENT_CARD_INSERTION
suffix:colon
id|link-&gt;state
op_or_assign
id|DEV_PRESENT
op_or
id|DEV_CONFIG_PENDING
suffix:semicolon
id|ray_config
c_func
(paren
id|link
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CS_EVENT_PM_SUSPEND
suffix:colon
id|link-&gt;state
op_or_assign
id|DEV_SUSPEND
suffix:semicolon
multiline_comment|/* Fall through... */
r_case
id|CS_EVENT_RESET_PHYSICAL
suffix:colon
r_if
c_cond
(paren
id|link-&gt;state
op_amp
id|DEV_CONFIG
)paren
(brace
r_if
c_cond
(paren
id|link-&gt;open
)paren
id|netif_device_detach
c_func
(paren
id|dev
)paren
suffix:semicolon
id|pcmcia_release_configuration
c_func
(paren
id|link-&gt;handle
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|CS_EVENT_PM_RESUME
suffix:colon
id|link-&gt;state
op_and_assign
op_complement
id|DEV_SUSPEND
suffix:semicolon
multiline_comment|/* Fall through... */
r_case
id|CS_EVENT_CARD_RESET
suffix:colon
r_if
c_cond
(paren
id|link-&gt;state
op_amp
id|DEV_CONFIG
)paren
(brace
id|pcmcia_request_configuration
c_func
(paren
id|link-&gt;handle
comma
op_amp
id|link-&gt;conf
)paren
suffix:semicolon
r_if
c_cond
(paren
id|link-&gt;open
)paren
(brace
id|ray_reset
c_func
(paren
id|dev
)paren
suffix:semicolon
id|netif_device_attach
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
)brace
r_break
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
id|DEBUG
c_func
(paren
l_int|2
comma
l_string|&quot;ray_event ending&bslash;n&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/* ray_event */
multiline_comment|/*===========================================================================*/
DECL|function|ray_dev_init
r_int
id|ray_dev_init
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_int
id|i
suffix:semicolon
id|ray_dev_t
op_star
id|local
op_assign
id|dev-&gt;priv
suffix:semicolon
id|dev_link_t
op_star
id|link
op_assign
id|local-&gt;finder
suffix:semicolon
id|DEBUG
c_func
(paren
l_int|1
comma
l_string|&quot;ray_dev_init(dev=%p)&bslash;n&quot;
comma
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|link-&gt;state
op_amp
id|DEV_PRESENT
)paren
)paren
(brace
id|DEBUG
c_func
(paren
l_int|2
comma
l_string|&quot;ray_dev_init - device not present&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
multiline_comment|/* Download startup parameters */
r_if
c_cond
(paren
(paren
id|i
op_assign
id|dl_startup_params
c_func
(paren
id|dev
)paren
)paren
OL
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;ray_dev_init dl_startup_params failed - &quot;
l_string|&quot;returns 0x%x&bslash;n&quot;
comma
id|i
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
multiline_comment|/* copy mac and broadcast addresses to linux device */
id|memcpy
c_func
(paren
op_amp
id|dev-&gt;dev_addr
comma
op_amp
id|local-&gt;sparm.b4.a_mac_addr
comma
id|ADDRLEN
)paren
suffix:semicolon
id|memset
c_func
(paren
id|dev-&gt;broadcast
comma
l_int|0xff
comma
id|ETH_ALEN
)paren
suffix:semicolon
id|DEBUG
c_func
(paren
l_int|2
comma
l_string|&quot;ray_dev_init ending&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*===========================================================================*/
DECL|function|ray_dev_config
r_static
r_int
id|ray_dev_config
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_struct
id|ifmap
op_star
id|map
)paren
(brace
id|ray_dev_t
op_star
id|local
op_assign
id|dev-&gt;priv
suffix:semicolon
id|dev_link_t
op_star
id|link
op_assign
id|local-&gt;finder
suffix:semicolon
multiline_comment|/* Dummy routine to satisfy device structure */
id|DEBUG
c_func
(paren
l_int|1
comma
l_string|&quot;ray_dev_config(dev=%p,ifmap=%p)&bslash;n&quot;
comma
id|dev
comma
id|map
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|link-&gt;state
op_amp
id|DEV_PRESENT
)paren
)paren
(brace
id|DEBUG
c_func
(paren
l_int|2
comma
l_string|&quot;ray_dev_config - device not present&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*===========================================================================*/
DECL|function|ray_dev_start_xmit
r_static
r_int
id|ray_dev_start_xmit
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|net_device
op_star
id|dev
)paren
(brace
id|ray_dev_t
op_star
id|local
op_assign
id|dev-&gt;priv
suffix:semicolon
id|dev_link_t
op_star
id|link
op_assign
id|local-&gt;finder
suffix:semicolon
r_int
id|length
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|link-&gt;state
op_amp
id|DEV_PRESENT
)paren
)paren
(brace
id|DEBUG
c_func
(paren
l_int|2
comma
l_string|&quot;ray_dev_start_xmit - device not present&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|DEBUG
c_func
(paren
l_int|3
comma
l_string|&quot;ray_dev_start_xmit(skb=%p, dev=%p)&bslash;n&quot;
comma
id|skb
comma
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|local-&gt;authentication_state
op_eq
id|NEED_TO_AUTH
)paren
(brace
id|DEBUG
c_func
(paren
l_int|0
comma
l_string|&quot;ray_cs Sending authentication request.&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|build_auth_frame
(paren
id|local
comma
id|local-&gt;auth_id
comma
id|OPEN_AUTH_REQUEST
)paren
)paren
(brace
id|local-&gt;authentication_state
op_assign
id|AUTHENTICATED
suffix:semicolon
id|netif_stop_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
)brace
id|length
op_assign
id|ETH_ZLEN
OL
id|skb-&gt;len
ques
c_cond
id|skb-&gt;len
suffix:colon
id|ETH_ZLEN
suffix:semicolon
r_switch
c_cond
(paren
id|ray_hw_xmit
c_func
(paren
id|skb-&gt;data
comma
id|length
comma
id|dev
comma
id|DATA_TYPE
)paren
)paren
(brace
r_case
id|XMIT_NO_CCS
suffix:colon
r_case
id|XMIT_NEED_AUTH
suffix:colon
id|netif_stop_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
r_case
id|XMIT_NO_INTR
suffix:colon
r_case
id|XMIT_MSG_BAD
suffix:colon
r_case
id|XMIT_OK
suffix:colon
r_default
suffix:colon
id|dev-&gt;trans_start
op_assign
id|jiffies
suffix:semicolon
id|dev_kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* ray_dev_start_xmit */
multiline_comment|/*===========================================================================*/
DECL|function|ray_hw_xmit
r_static
r_int
id|ray_hw_xmit
c_func
(paren
r_int
r_char
op_star
id|data
comma
r_int
id|len
comma
r_struct
id|net_device
op_star
id|dev
comma
id|UCHAR
id|msg_type
)paren
(brace
id|ray_dev_t
op_star
id|local
op_assign
(paren
id|ray_dev_t
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_struct
id|ccs
op_star
id|pccs
suffix:semicolon
r_int
id|ccsindex
suffix:semicolon
r_int
id|offset
suffix:semicolon
r_struct
id|tx_msg
op_star
id|ptx
suffix:semicolon
multiline_comment|/* Address of xmit buffer in PC space */
r_int
r_int
id|addr
suffix:semicolon
multiline_comment|/* Address of xmit buffer in card space */
id|DEBUG
c_func
(paren
l_int|3
comma
l_string|&quot;ray_hw_xmit(data=%p, len=%d, dev=%p)&bslash;n&quot;
comma
id|data
comma
id|len
comma
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|len
op_plus
id|TX_HEADER_LENGTH
OG
id|TX_BUF_SIZE
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;ray_hw_xmit packet too large: %d bytes&bslash;n&quot;
comma
id|len
)paren
suffix:semicolon
r_return
id|XMIT_MSG_BAD
suffix:semicolon
)brace
r_switch
c_cond
(paren
id|ccsindex
op_assign
id|get_free_tx_ccs
c_func
(paren
id|local
)paren
)paren
(brace
r_case
id|ECCSBUSY
suffix:colon
id|DEBUG
c_func
(paren
l_int|2
comma
l_string|&quot;ray_hw_xmit tx_ccs table busy&bslash;n&quot;
)paren
suffix:semicolon
r_case
id|ECCSFULL
suffix:colon
id|DEBUG
c_func
(paren
l_int|2
comma
l_string|&quot;ray_hw_xmit No free tx ccs&bslash;n&quot;
)paren
suffix:semicolon
r_case
id|ECARDGONE
suffix:colon
id|netif_stop_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
r_return
id|XMIT_NO_CCS
suffix:semicolon
r_default
suffix:colon
r_break
suffix:semicolon
)brace
id|addr
op_assign
id|TX_BUF_BASE
op_plus
(paren
id|ccsindex
op_lshift
l_int|11
)paren
suffix:semicolon
r_if
c_cond
(paren
id|msg_type
op_eq
id|DATA_TYPE
)paren
(brace
id|local-&gt;stats.tx_bytes
op_add_assign
id|len
suffix:semicolon
id|local-&gt;stats.tx_packets
op_increment
suffix:semicolon
)brace
id|ptx
op_assign
(paren
r_struct
id|tx_msg
op_star
)paren
(paren
id|local-&gt;sram
op_plus
id|addr
)paren
suffix:semicolon
id|ray_build_header
c_func
(paren
id|local
comma
id|ptx
comma
id|msg_type
comma
id|data
)paren
suffix:semicolon
r_if
c_cond
(paren
id|translate
)paren
(brace
id|offset
op_assign
id|translate_frame
c_func
(paren
id|local
comma
id|ptx
comma
id|data
comma
id|len
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* Encapsulate frame */
multiline_comment|/* TBD TIB length will move address of ptx-&gt;var */
id|memcpy_toio
c_func
(paren
op_amp
id|ptx-&gt;var
comma
id|data
comma
id|len
)paren
suffix:semicolon
id|offset
op_assign
l_int|0
suffix:semicolon
)brace
multiline_comment|/* fill in the CCS */
id|pccs
op_assign
(paren
(paren
r_struct
id|ccs
op_star
)paren
(paren
id|local-&gt;sram
op_plus
id|CCS_BASE
)paren
)paren
op_plus
id|ccsindex
suffix:semicolon
id|len
op_add_assign
id|TX_HEADER_LENGTH
op_plus
id|offset
suffix:semicolon
id|writeb
c_func
(paren
id|CCS_TX_REQUEST
comma
op_amp
id|pccs-&gt;cmd
)paren
suffix:semicolon
id|writeb
c_func
(paren
id|addr
op_rshift
l_int|8
comma
op_amp
id|pccs-&gt;var.tx_request.tx_data_ptr
(braket
l_int|0
)braket
)paren
suffix:semicolon
id|writeb
c_func
(paren
id|local-&gt;tib_length
comma
op_amp
id|pccs-&gt;var.tx_request.tx_data_ptr
(braket
l_int|1
)braket
)paren
suffix:semicolon
id|writeb
c_func
(paren
id|len
op_rshift
l_int|8
comma
op_amp
id|pccs-&gt;var.tx_request.tx_data_length
(braket
l_int|0
)braket
)paren
suffix:semicolon
id|writeb
c_func
(paren
id|len
op_amp
l_int|0xff
comma
op_amp
id|pccs-&gt;var.tx_request.tx_data_length
(braket
l_int|1
)braket
)paren
suffix:semicolon
multiline_comment|/* TBD still need psm_cam? */
id|writeb
c_func
(paren
id|PSM_CAM
comma
op_amp
id|pccs-&gt;var.tx_request.pow_sav_mode
)paren
suffix:semicolon
id|writeb
c_func
(paren
id|local-&gt;net_default_tx_rate
comma
op_amp
id|pccs-&gt;var.tx_request.tx_rate
)paren
suffix:semicolon
id|writeb
c_func
(paren
l_int|0
comma
op_amp
id|pccs-&gt;var.tx_request.antenna
)paren
suffix:semicolon
id|DEBUG
c_func
(paren
l_int|3
comma
l_string|&quot;ray_hw_xmit default_tx_rate = 0x%x&bslash;n&quot;
comma
"&bslash;"
id|local-&gt;net_default_tx_rate
)paren
suffix:semicolon
multiline_comment|/* Interrupt the firmware to process the command */
r_if
c_cond
(paren
id|interrupt_ecf
c_func
(paren
id|local
comma
id|ccsindex
)paren
)paren
(brace
id|DEBUG
c_func
(paren
l_int|2
comma
l_string|&quot;ray_hw_xmit failed - ECF not ready for intr&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* TBD very inefficient to copy packet to buffer, and then not&n;   send it, but the alternative is to queue the messages and that&n;   won&squot;t be done for a while.  Maybe set tbusy until a CCS is free?&n;*/
id|writeb
c_func
(paren
id|CCS_BUFFER_FREE
comma
op_amp
id|pccs-&gt;buffer_status
)paren
suffix:semicolon
r_return
id|XMIT_NO_INTR
suffix:semicolon
)brace
r_return
id|XMIT_OK
suffix:semicolon
)brace
multiline_comment|/* end ray_hw_xmit */
multiline_comment|/*===========================================================================*/
DECL|function|translate_frame
r_static
r_int
id|translate_frame
c_func
(paren
id|ray_dev_t
op_star
id|local
comma
r_struct
id|tx_msg
op_star
id|ptx
comma
r_int
r_char
op_star
id|data
comma
r_int
id|len
)paren
(brace
r_int
r_int
r_int
id|proto
op_assign
(paren
(paren
r_struct
id|ethhdr
op_star
)paren
id|data
)paren
op_member_access_from_pointer
id|h_proto
suffix:semicolon
r_if
c_cond
(paren
id|ntohs
c_func
(paren
id|proto
)paren
op_ge
l_int|1536
)paren
(brace
multiline_comment|/* DIX II ethernet frame */
id|DEBUG
c_func
(paren
l_int|3
comma
l_string|&quot;ray_cs translate_frame DIX II&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* Copy LLC header to card buffer */
id|memcpy_toio
c_func
(paren
(paren
id|UCHAR
op_star
)paren
op_amp
id|ptx-&gt;var
comma
id|eth2_llc
comma
r_sizeof
(paren
id|eth2_llc
)paren
)paren
suffix:semicolon
id|memcpy_toio
c_func
(paren
(paren
(paren
id|UCHAR
op_star
)paren
op_amp
id|ptx-&gt;var
)paren
op_plus
r_sizeof
(paren
id|eth2_llc
)paren
comma
(paren
id|UCHAR
op_star
)paren
op_amp
id|proto
comma
l_int|2
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|proto
op_eq
l_int|0xf380
)paren
op_logical_or
(paren
id|proto
op_eq
l_int|0x3781
)paren
)paren
(brace
multiline_comment|/* This is the selective translation table, only 2 entries */
id|writeb
c_func
(paren
l_int|0xf8
comma
(paren
id|UCHAR
op_star
)paren
op_amp
(paren
(paren
r_struct
id|snaphdr_t
op_star
)paren
id|ptx-&gt;var
)paren
op_member_access_from_pointer
id|org
(braket
l_int|3
)braket
)paren
suffix:semicolon
)brace
multiline_comment|/* Copy body of ethernet packet without ethernet header */
id|memcpy_toio
c_func
(paren
(paren
id|UCHAR
op_star
)paren
op_amp
id|ptx-&gt;var
op_plus
r_sizeof
(paren
r_struct
id|snaphdr_t
)paren
comma
"&bslash;"
id|data
op_plus
id|ETH_HLEN
comma
id|len
op_minus
id|ETH_HLEN
)paren
suffix:semicolon
r_return
(paren
r_int
)paren
r_sizeof
(paren
r_struct
id|snaphdr_t
)paren
op_minus
id|ETH_HLEN
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* already  802 type, and proto is length */
id|DEBUG
c_func
(paren
l_int|3
comma
l_string|&quot;ray_cs translate_frame 802&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|proto
op_eq
l_int|0xffff
)paren
(brace
multiline_comment|/* evil netware IPX 802.3 without LLC */
id|DEBUG
c_func
(paren
l_int|3
comma
l_string|&quot;ray_cs translate_frame evil IPX&bslash;n&quot;
)paren
suffix:semicolon
id|memcpy_toio
c_func
(paren
(paren
id|UCHAR
op_star
)paren
op_amp
id|ptx-&gt;var
comma
id|data
op_plus
id|ETH_HLEN
comma
id|len
op_minus
id|ETH_HLEN
)paren
suffix:semicolon
r_return
l_int|0
op_minus
id|ETH_HLEN
suffix:semicolon
)brace
id|memcpy_toio
c_func
(paren
(paren
id|UCHAR
op_star
)paren
op_amp
id|ptx-&gt;var
comma
id|data
op_plus
id|ETH_HLEN
comma
id|len
op_minus
id|ETH_HLEN
)paren
suffix:semicolon
r_return
l_int|0
op_minus
id|ETH_HLEN
suffix:semicolon
)brace
multiline_comment|/* TBD do other frame types */
)brace
multiline_comment|/* end translate_frame */
multiline_comment|/*===========================================================================*/
DECL|function|ray_build_header
r_static
r_void
id|ray_build_header
c_func
(paren
id|ray_dev_t
op_star
id|local
comma
r_struct
id|tx_msg
op_star
id|ptx
comma
id|UCHAR
id|msg_type
comma
r_int
r_char
op_star
id|data
)paren
(brace
id|writeb
c_func
(paren
id|PROTOCOL_VER
op_or
id|msg_type
comma
op_amp
id|ptx-&gt;mac.frame_ctl_1
)paren
suffix:semicolon
multiline_comment|/*** IEEE 802.11 Address field assignments *************&n;                TODS FROMDS   addr_1     addr_2          addr_3   addr_4&n;Adhoc           0    0        dest       src (terminal)  BSSID    N/A&n;AP to Terminal  0    1        dest       AP(BSSID)       source   N/A&n;Terminal to AP  1    0        AP(BSSID)  src (terminal)  dest     N/A&n;AP to AP        1    1        dest AP    src AP          dest     source      &n;*******************************************************/
r_if
c_cond
(paren
id|local-&gt;net_type
op_eq
id|ADHOC
)paren
(brace
id|writeb
c_func
(paren
l_int|0
comma
op_amp
id|ptx-&gt;mac.frame_ctl_2
)paren
suffix:semicolon
id|memcpy_toio
c_func
(paren
id|ptx-&gt;mac.addr_1
comma
(paren
(paren
r_struct
id|ethhdr
op_star
)paren
id|data
)paren
op_member_access_from_pointer
id|h_dest
comma
l_int|2
op_star
id|ADDRLEN
)paren
suffix:semicolon
id|memcpy_toio
c_func
(paren
id|ptx-&gt;mac.addr_3
comma
id|local-&gt;bss_id
comma
id|ADDRLEN
)paren
suffix:semicolon
)brace
r_else
multiline_comment|/* infrastructure */
(brace
r_if
c_cond
(paren
id|local-&gt;sparm.b4.a_acting_as_ap_status
)paren
(brace
id|writeb
c_func
(paren
id|FC2_FROM_DS
comma
op_amp
id|ptx-&gt;mac.frame_ctl_2
)paren
suffix:semicolon
id|memcpy_toio
c_func
(paren
id|ptx-&gt;mac.addr_1
comma
(paren
(paren
r_struct
id|ethhdr
op_star
)paren
id|data
)paren
op_member_access_from_pointer
id|h_dest
comma
id|ADDRLEN
)paren
suffix:semicolon
id|memcpy_toio
c_func
(paren
id|ptx-&gt;mac.addr_2
comma
id|local-&gt;bss_id
comma
l_int|6
)paren
suffix:semicolon
id|memcpy_toio
c_func
(paren
id|ptx-&gt;mac.addr_3
comma
(paren
(paren
r_struct
id|ethhdr
op_star
)paren
id|data
)paren
op_member_access_from_pointer
id|h_source
comma
id|ADDRLEN
)paren
suffix:semicolon
)brace
r_else
multiline_comment|/* Terminal */
(brace
id|writeb
c_func
(paren
id|FC2_TO_DS
comma
op_amp
id|ptx-&gt;mac.frame_ctl_2
)paren
suffix:semicolon
id|memcpy_toio
c_func
(paren
id|ptx-&gt;mac.addr_1
comma
id|local-&gt;bss_id
comma
id|ADDRLEN
)paren
suffix:semicolon
id|memcpy_toio
c_func
(paren
id|ptx-&gt;mac.addr_2
comma
(paren
(paren
r_struct
id|ethhdr
op_star
)paren
id|data
)paren
op_member_access_from_pointer
id|h_source
comma
id|ADDRLEN
)paren
suffix:semicolon
id|memcpy_toio
c_func
(paren
id|ptx-&gt;mac.addr_3
comma
(paren
(paren
r_struct
id|ethhdr
op_star
)paren
id|data
)paren
op_member_access_from_pointer
id|h_dest
comma
id|ADDRLEN
)paren
suffix:semicolon
)brace
)brace
)brace
multiline_comment|/* end encapsulate_frame */
multiline_comment|/*===========================================================================*/
DECL|function|ray_dev_ioctl
r_static
r_int
id|ray_dev_ioctl
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_struct
id|ifreq
op_star
id|ifr
comma
r_int
id|cmd
)paren
(brace
id|ray_dev_t
op_star
id|local
op_assign
(paren
id|ray_dev_t
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|dev_link_t
op_star
id|link
op_assign
id|local-&gt;finder
suffix:semicolon
r_int
id|err
op_assign
l_int|0
suffix:semicolon
macro_line|#if WIRELESS_EXT &gt; 7
r_struct
id|iwreq
op_star
id|wrq
op_assign
(paren
r_struct
id|iwreq
op_star
)paren
id|ifr
suffix:semicolon
macro_line|#endif&t;/* WIRELESS_EXT &gt; 7 */
r_if
c_cond
(paren
op_logical_neg
(paren
id|link-&gt;state
op_amp
id|DEV_PRESENT
)paren
)paren
(brace
id|DEBUG
c_func
(paren
l_int|2
comma
l_string|&quot;ray_dev_ioctl - device not present&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|DEBUG
c_func
(paren
l_int|2
comma
l_string|&quot;ray_cs IOCTL dev=%p, ifr=%p, cmd = 0x%x&bslash;n&quot;
comma
id|dev
comma
id|ifr
comma
id|cmd
)paren
suffix:semicolon
multiline_comment|/* Validate the command */
r_switch
c_cond
(paren
id|cmd
)paren
(brace
macro_line|#if WIRELESS_EXT &gt; 7
multiline_comment|/* --------------- WIRELESS EXTENSIONS --------------- */
multiline_comment|/* Get name */
r_case
id|SIOCGIWNAME
suffix:colon
id|strcpy
c_func
(paren
id|wrq-&gt;u.name
comma
l_string|&quot;IEEE 802.11-FH&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
multiline_comment|/* Get frequency/channel */
r_case
id|SIOCGIWFREQ
suffix:colon
id|wrq-&gt;u.freq.m
op_assign
id|local-&gt;sparm.b5.a_hop_pattern
suffix:semicolon
id|wrq-&gt;u.freq.e
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
multiline_comment|/* Get current network name (ESSID) */
r_case
id|SIOCGIWESSID
suffix:colon
r_if
c_cond
(paren
id|wrq-&gt;u.data.pointer
)paren
(brace
r_char
id|essid
(braket
id|IW_ESSID_MAX_SIZE
op_plus
l_int|1
)braket
suffix:semicolon
multiline_comment|/* Get the essid that was set */
id|memcpy
c_func
(paren
id|essid
comma
id|local-&gt;sparm.b5.a_current_ess_id
comma
id|IW_ESSID_MAX_SIZE
)paren
suffix:semicolon
id|essid
(braket
id|IW_ESSID_MAX_SIZE
)braket
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
multiline_comment|/* Push it out ! */
id|wrq-&gt;u.data.length
op_assign
id|strlen
c_func
(paren
id|essid
)paren
op_plus
l_int|1
suffix:semicolon
id|wrq-&gt;u.data.flags
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* active */
id|copy_to_user
c_func
(paren
id|wrq-&gt;u.data.pointer
comma
id|essid
comma
r_sizeof
(paren
id|essid
)paren
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
multiline_comment|/* Get current Access Point (BSSID in our case) */
r_case
id|SIOCGIWAP
suffix:colon
id|memcpy
c_func
(paren
id|wrq-&gt;u.ap_addr.sa_data
comma
id|local-&gt;bss_id
comma
id|ETH_ALEN
)paren
suffix:semicolon
id|wrq-&gt;u.ap_addr.sa_family
op_assign
id|ARPHRD_ETHER
suffix:semicolon
r_break
suffix:semicolon
multiline_comment|/* Get the current bit-rate */
r_case
id|SIOCGIWRATE
suffix:colon
r_if
c_cond
(paren
id|local-&gt;net_default_tx_rate
op_eq
l_int|3
)paren
(brace
id|wrq-&gt;u.bitrate.value
op_assign
l_int|2000000
suffix:semicolon
)brace
multiline_comment|/* Hum... */
r_else
id|wrq-&gt;u.bitrate.value
op_assign
id|local-&gt;net_default_tx_rate
op_star
l_int|500000
suffix:semicolon
id|wrq-&gt;u.bitrate.fixed
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* We are in auto mode */
r_break
suffix:semicolon
multiline_comment|/* Set the desired bit-rate */
r_case
id|SIOCSIWRATE
suffix:colon
multiline_comment|/* Check if rate is in range */
r_if
c_cond
(paren
(paren
id|wrq-&gt;u.bitrate.value
op_ne
l_int|1000000
)paren
op_logical_and
(paren
id|wrq-&gt;u.bitrate.value
op_ne
l_int|2000000
)paren
)paren
(brace
id|err
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_break
suffix:semicolon
)brace
multiline_comment|/* Hack for 1.5 Mb/s instead of 2 Mb/s */
r_if
c_cond
(paren
(paren
id|local-&gt;fw_ver
op_eq
l_int|0x55
)paren
op_logical_and
multiline_comment|/* Please check */
(paren
id|wrq-&gt;u.bitrate.value
op_eq
l_int|2000000
)paren
)paren
(brace
id|local-&gt;net_default_tx_rate
op_assign
l_int|3
suffix:semicolon
)brace
r_else
id|local-&gt;net_default_tx_rate
op_assign
id|wrq-&gt;u.bitrate.value
op_div
l_int|500000
suffix:semicolon
r_break
suffix:semicolon
multiline_comment|/* Get the current RTS threshold */
r_case
id|SIOCGIWRTS
suffix:colon
id|wrq-&gt;u.rts.value
op_assign
(paren
id|local-&gt;sparm.b5.a_rts_threshold
(braket
l_int|0
)braket
op_lshift
l_int|8
)paren
op_plus
id|local-&gt;sparm.b5.a_rts_threshold
(braket
l_int|1
)braket
suffix:semicolon
macro_line|#if WIRELESS_EXT &gt; 8
id|wrq-&gt;u.rts.disabled
op_assign
(paren
id|wrq-&gt;u.rts.value
op_eq
l_int|32767
)paren
suffix:semicolon
macro_line|#endif /* WIRELESS_EXT &gt; 8 */
id|wrq-&gt;u.rts.fixed
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
multiline_comment|/* Get the current fragmentation threshold */
r_case
id|SIOCGIWFRAG
suffix:colon
id|wrq-&gt;u.frag.value
op_assign
(paren
id|local-&gt;sparm.b5.a_frag_threshold
(braket
l_int|0
)braket
op_lshift
l_int|8
)paren
op_plus
id|local-&gt;sparm.b5.a_frag_threshold
(braket
l_int|1
)braket
suffix:semicolon
macro_line|#if WIRELESS_EXT &gt; 8
id|wrq-&gt;u.frag.disabled
op_assign
(paren
id|wrq-&gt;u.frag.value
op_eq
l_int|32767
)paren
suffix:semicolon
macro_line|#endif /* WIRELESS_EXT &gt; 8 */
id|wrq-&gt;u.frag.fixed
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
macro_line|#endif&t;/* WIRELESS_EXT &gt; 7 */
macro_line|#if WIRELESS_EXT &gt; 8
multiline_comment|/* Get the current mode of operation */
r_case
id|SIOCGIWMODE
suffix:colon
r_if
c_cond
(paren
id|local-&gt;sparm.b5.a_network_type
)paren
(brace
id|wrq-&gt;u.mode
op_assign
id|IW_MODE_INFRA
suffix:semicolon
)brace
r_else
id|wrq-&gt;u.mode
op_assign
id|IW_MODE_ADHOC
suffix:semicolon
r_break
suffix:semicolon
macro_line|#endif /* WIRELESS_EXT &gt; 8 */
macro_line|#if WIRELESS_EXT &gt; 7
multiline_comment|/* ------------------ IWSPY SUPPORT ------------------ */
multiline_comment|/* Define the range (variations) of above parameters */
r_case
id|SIOCGIWRANGE
suffix:colon
multiline_comment|/* Basic checking... */
r_if
c_cond
(paren
id|wrq-&gt;u.data.pointer
op_ne
(paren
id|caddr_t
)paren
l_int|0
)paren
(brace
r_struct
id|iw_range
id|range
suffix:semicolon
id|memset
c_func
(paren
(paren
r_char
op_star
)paren
op_amp
id|range
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|iw_range
)paren
)paren
suffix:semicolon
multiline_comment|/* Set the length (useless : its constant...) */
id|wrq-&gt;u.data.length
op_assign
r_sizeof
(paren
r_struct
id|iw_range
)paren
suffix:semicolon
multiline_comment|/* Set information in the range struct */
id|range.throughput
op_assign
l_float|1.1
op_star
l_int|1000
op_star
l_int|1000
suffix:semicolon
multiline_comment|/* Put the right number here */
id|range.num_channels
op_assign
id|hop_pattern_length
(braket
(paren
r_int
)paren
id|country
)braket
suffix:semicolon
id|range.num_frequency
op_assign
l_int|0
suffix:semicolon
id|range.max_qual.qual
op_assign
l_int|0
suffix:semicolon
id|range.max_qual.level
op_assign
l_int|255
suffix:semicolon
multiline_comment|/* What&squot;s the correct value ? */
id|range.max_qual.noise
op_assign
l_int|255
suffix:semicolon
multiline_comment|/* Idem */
id|range.num_bitrates
op_assign
l_int|2
suffix:semicolon
id|range.bitrate
(braket
l_int|0
)braket
op_assign
l_int|1000000
suffix:semicolon
multiline_comment|/* 1 Mb/s */
id|range.bitrate
(braket
l_int|1
)braket
op_assign
l_int|2000000
suffix:semicolon
multiline_comment|/* 2 Mb/s */
multiline_comment|/* Copy structure to the user buffer */
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
id|wrq-&gt;u.data.pointer
comma
op_amp
id|range
comma
r_sizeof
(paren
r_struct
id|iw_range
)paren
)paren
)paren
(brace
id|err
op_assign
op_minus
id|EFAULT
suffix:semicolon
)brace
)brace
r_break
suffix:semicolon
macro_line|#ifdef WIRELESS_SPY
multiline_comment|/* Set addresses to spy */
r_case
id|SIOCSIWSPY
suffix:colon
multiline_comment|/* Check the number of addresses */
r_if
c_cond
(paren
id|wrq-&gt;u.data.length
OG
id|IW_MAX_SPY
)paren
(brace
id|err
op_assign
op_minus
id|E2BIG
suffix:semicolon
r_break
suffix:semicolon
)brace
id|local-&gt;spy_number
op_assign
id|wrq-&gt;u.data.length
suffix:semicolon
multiline_comment|/* If there is some addresses to copy */
r_if
c_cond
(paren
id|local-&gt;spy_number
OG
l_int|0
)paren
(brace
r_struct
id|sockaddr
id|address
(braket
id|IW_MAX_SPY
)braket
suffix:semicolon
r_int
id|i
suffix:semicolon
multiline_comment|/* Copy addresses to the driver */
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
id|address
comma
id|wrq-&gt;u.data.pointer
comma
r_sizeof
(paren
r_struct
id|sockaddr
)paren
op_star
id|local-&gt;spy_number
)paren
)paren
(brace
id|err
op_assign
op_minus
id|EFAULT
suffix:semicolon
r_break
suffix:semicolon
)brace
multiline_comment|/* Copy addresses to the lp structure */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|local-&gt;spy_number
suffix:semicolon
id|i
op_increment
)paren
(brace
id|memcpy
c_func
(paren
id|local-&gt;spy_address
(braket
id|i
)braket
comma
id|address
(braket
id|i
)braket
dot
id|sa_data
comma
id|ETH_ALEN
)paren
suffix:semicolon
)brace
multiline_comment|/* Reset structure... */
id|memset
c_func
(paren
id|local-&gt;spy_stat
comma
l_int|0x00
comma
r_sizeof
(paren
id|iw_qual
)paren
op_star
id|IW_MAX_SPY
)paren
suffix:semicolon
macro_line|#ifdef DEBUG_IOCTL_INFO
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;SetSpy - Set of new addresses is :&bslash;n&quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|local-&gt;spy_number
suffix:semicolon
id|i
op_increment
)paren
(brace
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%02X:%02X:%02X:%02X:%02X:%02X&bslash;n&quot;
comma
id|local-&gt;spy_address
(braket
id|i
)braket
(braket
l_int|0
)braket
comma
id|local-&gt;spy_address
(braket
id|i
)braket
(braket
l_int|1
)braket
comma
id|local-&gt;spy_address
(braket
id|i
)braket
(braket
l_int|2
)braket
comma
id|local-&gt;spy_address
(braket
id|i
)braket
(braket
l_int|3
)braket
comma
id|local-&gt;spy_address
(braket
id|i
)braket
(braket
l_int|4
)braket
comma
id|local-&gt;spy_address
(braket
id|i
)braket
(braket
l_int|5
)braket
)paren
suffix:semicolon
)brace
macro_line|#endif&t;/* DEBUG_IOCTL_INFO */
)brace
r_break
suffix:semicolon
multiline_comment|/* Get the spy list and spy stats */
r_case
id|SIOCGIWSPY
suffix:colon
multiline_comment|/* Set the number of addresses */
id|wrq-&gt;u.data.length
op_assign
id|local-&gt;spy_number
suffix:semicolon
multiline_comment|/* If the user want to have the addresses back... */
r_if
c_cond
(paren
(paren
id|local-&gt;spy_number
OG
l_int|0
)paren
op_logical_and
(paren
id|wrq-&gt;u.data.pointer
op_ne
(paren
id|caddr_t
)paren
l_int|0
)paren
)paren
(brace
r_struct
id|sockaddr
id|address
(braket
id|IW_MAX_SPY
)braket
suffix:semicolon
r_int
id|i
suffix:semicolon
multiline_comment|/* Copy addresses from the lp structure */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|local-&gt;spy_number
suffix:semicolon
id|i
op_increment
)paren
(brace
id|memcpy
c_func
(paren
id|address
(braket
id|i
)braket
dot
id|sa_data
comma
id|local-&gt;spy_address
(braket
id|i
)braket
comma
id|ETH_ALEN
)paren
suffix:semicolon
id|address
(braket
id|i
)braket
dot
id|sa_family
op_assign
id|ARPHRD_ETHER
suffix:semicolon
)brace
multiline_comment|/* Copy addresses to the user buffer */
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
id|wrq-&gt;u.data.pointer
comma
id|address
comma
r_sizeof
(paren
r_struct
id|sockaddr
)paren
op_star
id|local-&gt;spy_number
)paren
)paren
(brace
id|err
op_assign
op_minus
id|EFAULT
suffix:semicolon
r_break
suffix:semicolon
)brace
multiline_comment|/* Copy stats to the user buffer (just after) */
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
id|wrq-&gt;u.data.pointer
op_plus
(paren
r_sizeof
(paren
r_struct
id|sockaddr
)paren
op_star
id|local-&gt;spy_number
)paren
comma
id|local-&gt;spy_stat
comma
r_sizeof
(paren
id|iw_qual
)paren
op_star
id|local-&gt;spy_number
)paren
)paren
(brace
id|err
op_assign
op_minus
id|EFAULT
suffix:semicolon
r_break
suffix:semicolon
)brace
multiline_comment|/* Reset updated flags */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|local-&gt;spy_number
suffix:semicolon
id|i
op_increment
)paren
(brace
id|local-&gt;spy_stat
(braket
id|i
)braket
dot
id|updated
op_assign
l_int|0x0
suffix:semicolon
)brace
)brace
multiline_comment|/* if(pointer != NULL) */
r_break
suffix:semicolon
macro_line|#endif&t;/* WIRELESS_SPY */
multiline_comment|/* ------------------ PRIVATE IOCTL ------------------ */
DECL|macro|SIOCSIPFRAMING
mdefine_line|#define SIOCSIPFRAMING&t;SIOCDEVPRIVATE&t;&t;/* Set framing mode */
DECL|macro|SIOCGIPFRAMING
mdefine_line|#define SIOCGIPFRAMING&t;SIOCDEVPRIVATE + 1&t;/* Get framing mode */
DECL|macro|SIOCGIPCOUNTRY
mdefine_line|#define SIOCGIPCOUNTRY&t;SIOCDEVPRIVATE + 3&t;/* Get country code */
r_case
id|SIOCSIPFRAMING
suffix:colon
r_if
c_cond
(paren
op_logical_neg
id|capable
c_func
(paren
id|CAP_NET_ADMIN
)paren
)paren
multiline_comment|/* For private IOCTLs, we need to check permissions */
(brace
id|err
op_assign
op_minus
id|EPERM
suffix:semicolon
r_break
suffix:semicolon
)brace
id|translate
op_assign
op_star
(paren
id|wrq-&gt;u.name
)paren
suffix:semicolon
multiline_comment|/* Set framing mode */
r_break
suffix:semicolon
r_case
id|SIOCGIPFRAMING
suffix:colon
op_star
(paren
id|wrq-&gt;u.name
)paren
op_assign
id|translate
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SIOCGIPCOUNTRY
suffix:colon
op_star
(paren
id|wrq-&gt;u.name
)paren
op_assign
id|country
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SIOCGIWPRIV
suffix:colon
multiline_comment|/* Export our &quot;private&quot; intercace */
r_if
c_cond
(paren
id|wrq-&gt;u.data.pointer
op_ne
(paren
id|caddr_t
)paren
l_int|0
)paren
(brace
r_struct
id|iw_priv_args
id|priv
(braket
)braket
op_assign
(brace
multiline_comment|/* cmd,&t;&t;set_args,&t;get_args,&t;name */
(brace
id|SIOCSIPFRAMING
comma
id|IW_PRIV_TYPE_BYTE
op_or
id|IW_PRIV_SIZE_FIXED
op_or
l_int|1
comma
l_int|0
comma
l_string|&quot;set_framing&quot;
)brace
comma
(brace
id|SIOCGIPFRAMING
comma
l_int|0
comma
id|IW_PRIV_TYPE_BYTE
op_or
id|IW_PRIV_SIZE_FIXED
op_or
l_int|1
comma
l_string|&quot;get_framing&quot;
)brace
comma
(brace
id|SIOCGIPCOUNTRY
comma
l_int|0
comma
id|IW_PRIV_TYPE_BYTE
op_or
id|IW_PRIV_SIZE_FIXED
op_or
l_int|1
comma
l_string|&quot;get_country&quot;
)brace
comma
)brace
suffix:semicolon
multiline_comment|/* Set the number of ioctl available */
id|wrq-&gt;u.data.length
op_assign
l_int|3
suffix:semicolon
multiline_comment|/* Copy structure to the user buffer */
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
id|wrq-&gt;u.data.pointer
comma
(paren
id|u_char
op_star
)paren
id|priv
comma
r_sizeof
(paren
id|priv
)paren
)paren
)paren
(brace
id|err
op_assign
op_minus
id|EFAULT
suffix:semicolon
)brace
)brace
r_break
suffix:semicolon
macro_line|#endif&t;/* WIRELESS_EXT &gt; 7 */
r_default
suffix:colon
id|DEBUG
c_func
(paren
l_int|0
comma
l_string|&quot;ray_dev_ioctl cmd = 0x%x&bslash;n&quot;
comma
id|cmd
)paren
suffix:semicolon
id|err
op_assign
op_minus
id|EOPNOTSUPP
suffix:semicolon
)brace
r_return
id|err
suffix:semicolon
)brace
multiline_comment|/* end ray_dev_ioctl */
multiline_comment|/*===========================================================================*/
macro_line|#if WIRELESS_EXT &gt; 7&t;/* If wireless extension exist in the kernel */
DECL|function|ray_get_wireless_stats
r_static
id|iw_stats
op_star
id|ray_get_wireless_stats
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
id|ray_dev_t
op_star
id|local
op_assign
(paren
id|ray_dev_t
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|dev_link_t
op_star
id|link
op_assign
id|local-&gt;finder
suffix:semicolon
r_struct
id|status
op_star
id|p
op_assign
(paren
r_struct
id|status
op_star
)paren
(paren
id|local-&gt;sram
op_plus
id|STATUS_BASE
)paren
suffix:semicolon
r_if
c_cond
(paren
id|local
op_eq
(paren
id|ray_dev_t
op_star
)paren
l_int|NULL
)paren
(brace
r_return
(paren
id|iw_stats
op_star
)paren
l_int|NULL
suffix:semicolon
)brace
id|local-&gt;wstats.status
op_assign
id|local-&gt;card_status
suffix:semicolon
macro_line|#ifdef WIRELESS_SPY
r_if
c_cond
(paren
(paren
id|local-&gt;spy_number
OG
l_int|0
)paren
op_logical_and
(paren
id|local-&gt;sparm.b5.a_network_type
op_eq
l_int|0
)paren
)paren
(brace
multiline_comment|/* Get it from the first node in spy list */
id|local-&gt;wstats.qual.qual
op_assign
id|local-&gt;spy_stat
(braket
l_int|0
)braket
dot
id|qual
suffix:semicolon
id|local-&gt;wstats.qual.level
op_assign
id|local-&gt;spy_stat
(braket
l_int|0
)braket
dot
id|level
suffix:semicolon
id|local-&gt;wstats.qual.noise
op_assign
id|local-&gt;spy_stat
(braket
l_int|0
)braket
dot
id|noise
suffix:semicolon
id|local-&gt;wstats.qual.updated
op_assign
id|local-&gt;spy_stat
(braket
l_int|0
)braket
dot
id|updated
suffix:semicolon
)brace
macro_line|#endif /* WIRELESS_SPY */
r_if
c_cond
(paren
(paren
id|link-&gt;state
op_amp
id|DEV_PRESENT
)paren
)paren
(brace
id|local-&gt;wstats.qual.noise
op_assign
id|readb
c_func
(paren
op_amp
id|p-&gt;rxnoise
)paren
suffix:semicolon
id|local-&gt;wstats.qual.updated
op_or_assign
l_int|4
suffix:semicolon
)brace
r_return
op_amp
id|local-&gt;wstats
suffix:semicolon
)brace
multiline_comment|/* end ray_get_wireless_stats */
macro_line|#endif&t;/* WIRELESS_EXT &gt; 7 */
multiline_comment|/*===========================================================================*/
DECL|function|ray_open
r_static
r_int
id|ray_open
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
id|dev_link_t
op_star
id|link
suffix:semicolon
id|ray_dev_t
op_star
id|local
op_assign
(paren
id|ray_dev_t
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|MOD_INC_USE_COUNT
suffix:semicolon
id|DEBUG
c_func
(paren
l_int|1
comma
l_string|&quot;ray_open(&squot;%s&squot;)&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_for
c_loop
(paren
id|link
op_assign
id|dev_list
suffix:semicolon
id|link
suffix:semicolon
id|link
op_assign
id|link-&gt;next
)paren
r_if
c_cond
(paren
id|link-&gt;priv
op_eq
id|dev
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|DEV_OK
c_func
(paren
id|link
)paren
)paren
(brace
id|MOD_DEC_USE_COUNT
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
r_if
c_cond
(paren
id|link-&gt;open
op_eq
l_int|0
)paren
id|local-&gt;num_multi
op_assign
l_int|0
suffix:semicolon
id|link-&gt;open
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|sniffer
)paren
id|netif_stop_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
r_else
id|netif_start_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
id|DEBUG
c_func
(paren
l_int|2
comma
l_string|&quot;ray_open ending&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* end ray_open */
multiline_comment|/*===========================================================================*/
DECL|function|ray_dev_close
r_static
r_int
id|ray_dev_close
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
id|dev_link_t
op_star
id|link
suffix:semicolon
id|DEBUG
c_func
(paren
l_int|1
comma
l_string|&quot;ray_dev_close(&squot;%s&squot;)&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_for
c_loop
(paren
id|link
op_assign
id|dev_list
suffix:semicolon
id|link
suffix:semicolon
id|link
op_assign
id|link-&gt;next
)paren
r_if
c_cond
(paren
id|link-&gt;priv
op_eq
id|dev
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
id|link
op_eq
l_int|NULL
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
id|link-&gt;open
op_decrement
suffix:semicolon
id|netif_stop_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|link-&gt;state
op_amp
id|DEV_STALE_CONFIG
)paren
id|mod_timer
c_func
(paren
op_amp
id|link-&gt;release
comma
id|jiffies
op_plus
id|HZ
op_div
l_int|20
)paren
suffix:semicolon
id|MOD_DEC_USE_COUNT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* end ray_dev_close */
multiline_comment|/*===========================================================================*/
DECL|function|ray_reset
r_static
r_void
id|ray_reset
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
id|DEBUG
c_func
(paren
l_int|1
comma
l_string|&quot;ray_reset entered&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/*===========================================================================*/
multiline_comment|/* Cause a firmware interrupt if it is ready for one                         */
multiline_comment|/* Return nonzero if not ready                                               */
DECL|function|interrupt_ecf
r_static
r_int
id|interrupt_ecf
c_func
(paren
id|ray_dev_t
op_star
id|local
comma
r_int
id|ccs
)paren
(brace
r_int
id|i
op_assign
l_int|50
suffix:semicolon
id|dev_link_t
op_star
id|link
op_assign
id|local-&gt;finder
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|link-&gt;state
op_amp
id|DEV_PRESENT
)paren
)paren
(brace
id|DEBUG
c_func
(paren
l_int|2
comma
l_string|&quot;ray_cs interrupt_ecf - device not present&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|DEBUG
c_func
(paren
l_int|2
comma
l_string|&quot;interrupt_ecf(local=%p, ccs = 0x%x&bslash;n&quot;
comma
id|local
comma
id|ccs
)paren
suffix:semicolon
r_while
c_loop
(paren
id|i
op_logical_and
(paren
id|readb
c_func
(paren
id|local-&gt;amem
op_plus
id|CIS_OFFSET
op_plus
id|ECF_INTR_OFFSET
)paren
op_amp
id|ECF_INTR_SET
)paren
)paren
id|i
op_decrement
suffix:semicolon
r_if
c_cond
(paren
id|i
op_eq
l_int|0
)paren
(brace
id|DEBUG
c_func
(paren
l_int|2
comma
l_string|&quot;ray_cs interrupt_ecf card not ready for interrupt&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
multiline_comment|/* Fill the mailbox, then kick the card */
id|writeb
c_func
(paren
id|ccs
comma
id|local-&gt;sram
op_plus
id|SCB_BASE
)paren
suffix:semicolon
id|writeb
c_func
(paren
id|ECF_INTR_SET
comma
id|local-&gt;amem
op_plus
id|CIS_OFFSET
op_plus
id|ECF_INTR_OFFSET
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* interrupt_ecf */
multiline_comment|/*===========================================================================*/
multiline_comment|/* Get next free transmit CCS                                                */
multiline_comment|/* Return - index of current tx ccs                                          */
DECL|function|get_free_tx_ccs
r_static
r_int
id|get_free_tx_ccs
c_func
(paren
id|ray_dev_t
op_star
id|local
)paren
(brace
r_int
id|i
suffix:semicolon
r_struct
id|ccs
op_star
id|pccs
op_assign
(paren
r_struct
id|ccs
op_star
)paren
(paren
id|local-&gt;sram
op_plus
id|CCS_BASE
)paren
suffix:semicolon
id|dev_link_t
op_star
id|link
op_assign
id|local-&gt;finder
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|link-&gt;state
op_amp
id|DEV_PRESENT
)paren
)paren
(brace
id|DEBUG
c_func
(paren
l_int|2
comma
l_string|&quot;ray_cs get_free_tx_ccs - device not present&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|ECARDGONE
suffix:semicolon
)brace
r_if
c_cond
(paren
id|test_and_set_bit
c_func
(paren
l_int|0
comma
op_amp
id|local-&gt;tx_ccs_lock
)paren
)paren
(brace
id|DEBUG
c_func
(paren
l_int|1
comma
l_string|&quot;ray_cs tx_ccs_lock busy&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|ECCSBUSY
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|NUMBER_OF_TX_CCS
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|readb
c_func
(paren
op_amp
(paren
id|pccs
op_plus
id|i
)paren
op_member_access_from_pointer
id|buffer_status
)paren
op_eq
id|CCS_BUFFER_FREE
)paren
(brace
id|writeb
c_func
(paren
id|CCS_BUFFER_BUSY
comma
op_amp
(paren
id|pccs
op_plus
id|i
)paren
op_member_access_from_pointer
id|buffer_status
)paren
suffix:semicolon
id|writeb
c_func
(paren
id|CCS_END_LIST
comma
op_amp
(paren
id|pccs
op_plus
id|i
)paren
op_member_access_from_pointer
id|link
)paren
suffix:semicolon
id|local-&gt;tx_ccs_lock
op_assign
l_int|0
suffix:semicolon
r_return
id|i
suffix:semicolon
)brace
)brace
id|local-&gt;tx_ccs_lock
op_assign
l_int|0
suffix:semicolon
id|DEBUG
c_func
(paren
l_int|2
comma
l_string|&quot;ray_cs ERROR no free tx CCS for raylink card&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|ECCSFULL
suffix:semicolon
)brace
multiline_comment|/* get_free_tx_ccs */
multiline_comment|/*===========================================================================*/
multiline_comment|/* Get next free CCS                                                         */
multiline_comment|/* Return - index of current ccs                                             */
DECL|function|get_free_ccs
r_static
r_int
id|get_free_ccs
c_func
(paren
id|ray_dev_t
op_star
id|local
)paren
(brace
r_int
id|i
suffix:semicolon
r_struct
id|ccs
op_star
id|pccs
op_assign
(paren
r_struct
id|ccs
op_star
)paren
(paren
id|local-&gt;sram
op_plus
id|CCS_BASE
)paren
suffix:semicolon
id|dev_link_t
op_star
id|link
op_assign
id|local-&gt;finder
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|link-&gt;state
op_amp
id|DEV_PRESENT
)paren
)paren
(brace
id|DEBUG
c_func
(paren
l_int|2
comma
l_string|&quot;ray_cs get_free_ccs - device not present&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|ECARDGONE
suffix:semicolon
)brace
r_if
c_cond
(paren
id|test_and_set_bit
c_func
(paren
l_int|0
comma
op_amp
id|local-&gt;ccs_lock
)paren
)paren
(brace
id|DEBUG
c_func
(paren
l_int|1
comma
l_string|&quot;ray_cs ccs_lock busy&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|ECCSBUSY
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
id|NUMBER_OF_TX_CCS
suffix:semicolon
id|i
OL
id|NUMBER_OF_CCS
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|readb
c_func
(paren
op_amp
(paren
id|pccs
op_plus
id|i
)paren
op_member_access_from_pointer
id|buffer_status
)paren
op_eq
id|CCS_BUFFER_FREE
)paren
(brace
id|writeb
c_func
(paren
id|CCS_BUFFER_BUSY
comma
op_amp
(paren
id|pccs
op_plus
id|i
)paren
op_member_access_from_pointer
id|buffer_status
)paren
suffix:semicolon
id|writeb
c_func
(paren
id|CCS_END_LIST
comma
op_amp
(paren
id|pccs
op_plus
id|i
)paren
op_member_access_from_pointer
id|link
)paren
suffix:semicolon
id|local-&gt;ccs_lock
op_assign
l_int|0
suffix:semicolon
r_return
id|i
suffix:semicolon
)brace
)brace
id|local-&gt;ccs_lock
op_assign
l_int|0
suffix:semicolon
id|DEBUG
c_func
(paren
l_int|1
comma
l_string|&quot;ray_cs ERROR no free CCS for raylink card&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|ECCSFULL
suffix:semicolon
)brace
multiline_comment|/* get_free_ccs */
multiline_comment|/*===========================================================================*/
DECL|function|authenticate_timeout
r_static
r_void
id|authenticate_timeout
c_func
(paren
id|u_long
id|data
)paren
(brace
id|ray_dev_t
op_star
id|local
op_assign
(paren
id|ray_dev_t
op_star
)paren
id|data
suffix:semicolon
id|del_timer
c_func
(paren
op_amp
id|local-&gt;timer
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;ray_cs Authentication with access point failed&quot;
l_string|&quot; - timeout&bslash;n&quot;
)paren
suffix:semicolon
id|join_net
c_func
(paren
(paren
id|u_long
)paren
id|local
)paren
suffix:semicolon
)brace
multiline_comment|/*===========================================================================*/
DECL|function|asc_to_int
r_static
r_int
id|asc_to_int
c_func
(paren
r_char
id|a
)paren
(brace
r_if
c_cond
(paren
id|a
OL
l_char|&squot;0&squot;
)paren
r_return
op_minus
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|a
op_le
l_char|&squot;9&squot;
)paren
r_return
(paren
id|a
op_minus
l_char|&squot;0&squot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|a
OL
l_char|&squot;A&squot;
)paren
r_return
op_minus
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|a
op_le
l_char|&squot;F&squot;
)paren
r_return
(paren
l_int|10
op_plus
id|a
op_minus
l_char|&squot;A&squot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|a
OL
l_char|&squot;a&squot;
)paren
r_return
op_minus
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|a
op_le
l_char|&squot;f&squot;
)paren
r_return
(paren
l_int|10
op_plus
id|a
op_minus
l_char|&squot;a&squot;
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
multiline_comment|/*===========================================================================*/
DECL|function|parse_addr
r_static
r_int
id|parse_addr
c_func
(paren
r_char
op_star
id|in_str
comma
id|UCHAR
op_star
id|out
)paren
(brace
r_int
id|len
suffix:semicolon
r_int
id|i
comma
id|j
comma
id|k
suffix:semicolon
r_int
id|status
suffix:semicolon
r_if
c_cond
(paren
id|in_str
op_eq
l_int|NULL
)paren
r_return
l_int|0
suffix:semicolon
r_if
c_cond
(paren
(paren
id|len
op_assign
id|strlen
c_func
(paren
id|in_str
)paren
)paren
OL
l_int|2
)paren
r_return
l_int|0
suffix:semicolon
id|memset
c_func
(paren
id|out
comma
l_int|0
comma
id|ADDRLEN
)paren
suffix:semicolon
id|status
op_assign
l_int|1
suffix:semicolon
id|j
op_assign
id|len
op_minus
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|j
OG
l_int|12
)paren
id|j
op_assign
l_int|12
suffix:semicolon
id|i
op_assign
l_int|5
suffix:semicolon
r_while
c_loop
(paren
id|j
OG
l_int|0
)paren
(brace
r_if
c_cond
(paren
(paren
id|k
op_assign
id|asc_to_int
c_func
(paren
id|in_str
(braket
id|j
op_decrement
)braket
)paren
)paren
op_ne
op_minus
l_int|1
)paren
id|out
(braket
id|i
)braket
op_assign
id|k
suffix:semicolon
r_else
r_return
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|j
op_eq
l_int|0
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
(paren
id|k
op_assign
id|asc_to_int
c_func
(paren
id|in_str
(braket
id|j
op_decrement
)braket
)paren
)paren
op_ne
op_minus
l_int|1
)paren
id|out
(braket
id|i
)braket
op_add_assign
id|k
op_lshift
l_int|4
suffix:semicolon
r_else
r_return
l_int|0
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|i
op_decrement
)paren
r_break
suffix:semicolon
)brace
r_return
id|status
suffix:semicolon
)brace
multiline_comment|/*===========================================================================*/
DECL|function|ray_get_stats
r_static
r_struct
id|net_device_stats
op_star
id|ray_get_stats
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
id|ray_dev_t
op_star
id|local
op_assign
(paren
id|ray_dev_t
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|dev_link_t
op_star
id|link
op_assign
id|local-&gt;finder
suffix:semicolon
r_struct
id|status
op_star
id|p
op_assign
(paren
r_struct
id|status
op_star
)paren
(paren
id|local-&gt;sram
op_plus
id|STATUS_BASE
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|link-&gt;state
op_amp
id|DEV_PRESENT
)paren
)paren
(brace
id|DEBUG
c_func
(paren
l_int|2
comma
l_string|&quot;ray_cs net_device_stats - device not present&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_amp
id|local-&gt;stats
suffix:semicolon
)brace
r_if
c_cond
(paren
id|readb
c_func
(paren
op_amp
id|p-&gt;mrx_overflow_for_host
)paren
)paren
(brace
id|local-&gt;stats.rx_over_errors
op_add_assign
id|ntohs
c_func
(paren
id|readb
c_func
(paren
op_amp
id|p-&gt;mrx_overflow
)paren
)paren
suffix:semicolon
id|writeb
c_func
(paren
l_int|0
comma
op_amp
id|p-&gt;mrx_overflow
)paren
suffix:semicolon
id|writeb
c_func
(paren
l_int|0
comma
op_amp
id|p-&gt;mrx_overflow_for_host
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|readb
c_func
(paren
op_amp
id|p-&gt;mrx_checksum_error_for_host
)paren
)paren
(brace
id|local-&gt;stats.rx_crc_errors
op_add_assign
id|ntohs
c_func
(paren
id|readb
c_func
(paren
op_amp
id|p-&gt;mrx_checksum_error
)paren
)paren
suffix:semicolon
id|writeb
c_func
(paren
l_int|0
comma
op_amp
id|p-&gt;mrx_checksum_error
)paren
suffix:semicolon
id|writeb
c_func
(paren
l_int|0
comma
op_amp
id|p-&gt;mrx_checksum_error_for_host
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|readb
c_func
(paren
op_amp
id|p-&gt;rx_hec_error_for_host
)paren
)paren
(brace
id|local-&gt;stats.rx_frame_errors
op_add_assign
id|ntohs
c_func
(paren
id|readb
c_func
(paren
op_amp
id|p-&gt;rx_hec_error
)paren
)paren
suffix:semicolon
id|writeb
c_func
(paren
l_int|0
comma
op_amp
id|p-&gt;rx_hec_error
)paren
suffix:semicolon
id|writeb
c_func
(paren
l_int|0
comma
op_amp
id|p-&gt;rx_hec_error_for_host
)paren
suffix:semicolon
)brace
r_return
op_amp
id|local-&gt;stats
suffix:semicolon
)brace
multiline_comment|/*===========================================================================*/
DECL|function|ray_update_parm
r_static
r_void
id|ray_update_parm
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
id|UCHAR
id|objid
comma
id|UCHAR
op_star
id|value
comma
r_int
id|len
)paren
(brace
id|ray_dev_t
op_star
id|local
op_assign
(paren
id|ray_dev_t
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|dev_link_t
op_star
id|link
op_assign
id|local-&gt;finder
suffix:semicolon
r_int
id|ccsindex
suffix:semicolon
r_int
id|i
suffix:semicolon
r_struct
id|ccs
op_star
id|pccs
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|link-&gt;state
op_amp
id|DEV_PRESENT
)paren
)paren
(brace
id|DEBUG
c_func
(paren
l_int|2
comma
l_string|&quot;ray_update_parm - device not present&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|ccsindex
op_assign
id|get_free_ccs
c_func
(paren
id|local
)paren
)paren
OL
l_int|0
)paren
(brace
id|DEBUG
c_func
(paren
l_int|0
comma
l_string|&quot;ray_update_parm - No free ccs&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|pccs
op_assign
(paren
(paren
r_struct
id|ccs
op_star
)paren
(paren
id|local-&gt;sram
op_plus
id|CCS_BASE
)paren
)paren
op_plus
id|ccsindex
suffix:semicolon
id|writeb
c_func
(paren
id|CCS_UPDATE_PARAMS
comma
op_amp
id|pccs-&gt;cmd
)paren
suffix:semicolon
id|writeb
c_func
(paren
id|objid
comma
op_amp
id|pccs-&gt;var.update_param.object_id
)paren
suffix:semicolon
id|writeb
c_func
(paren
l_int|1
comma
op_amp
id|pccs-&gt;var.update_param.number_objects
)paren
suffix:semicolon
id|writeb
c_func
(paren
l_int|0
comma
op_amp
id|pccs-&gt;var.update_param.failure_cause
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|len
suffix:semicolon
id|i
op_increment
)paren
(brace
id|writeb
c_func
(paren
id|value
(braket
id|i
)braket
comma
id|local-&gt;sram
op_plus
id|HOST_TO_ECF_BASE
)paren
suffix:semicolon
)brace
multiline_comment|/* Interrupt the firmware to process the command */
r_if
c_cond
(paren
id|interrupt_ecf
c_func
(paren
id|local
comma
id|ccsindex
)paren
)paren
(brace
id|DEBUG
c_func
(paren
l_int|0
comma
l_string|&quot;ray_cs associate failed - ECF not ready for intr&bslash;n&quot;
)paren
suffix:semicolon
id|writeb
c_func
(paren
id|CCS_BUFFER_FREE
comma
op_amp
(paren
id|pccs
op_increment
)paren
op_member_access_from_pointer
id|buffer_status
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/*===========================================================================*/
DECL|function|ray_update_multi_list
r_static
r_void
id|ray_update_multi_list
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_int
id|all
)paren
(brace
r_struct
id|dev_mc_list
op_star
id|dmi
comma
op_star
op_star
id|dmip
suffix:semicolon
r_int
id|ccsindex
suffix:semicolon
r_struct
id|ccs
op_star
id|pccs
suffix:semicolon
r_int
id|i
op_assign
l_int|0
suffix:semicolon
id|ray_dev_t
op_star
id|local
op_assign
(paren
id|ray_dev_t
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|dev_link_t
op_star
id|link
op_assign
id|local-&gt;finder
suffix:semicolon
id|UCHAR
op_star
id|p
op_assign
id|local-&gt;sram
op_plus
id|HOST_TO_ECF_BASE
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|link-&gt;state
op_amp
id|DEV_PRESENT
)paren
)paren
(brace
id|DEBUG
c_func
(paren
l_int|2
comma
l_string|&quot;ray_update_multi_list - device not present&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_else
id|DEBUG
c_func
(paren
l_int|2
comma
l_string|&quot;ray_update_multi_list(%p)&bslash;n&quot;
comma
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|ccsindex
op_assign
id|get_free_ccs
c_func
(paren
id|local
)paren
)paren
OL
l_int|0
)paren
(brace
id|DEBUG
c_func
(paren
l_int|1
comma
l_string|&quot;ray_update_multi - No free ccs&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|pccs
op_assign
(paren
(paren
r_struct
id|ccs
op_star
)paren
(paren
id|local-&gt;sram
op_plus
id|CCS_BASE
)paren
)paren
op_plus
id|ccsindex
suffix:semicolon
id|writeb
c_func
(paren
id|CCS_UPDATE_MULTICAST_LIST
comma
op_amp
id|pccs-&gt;cmd
)paren
suffix:semicolon
r_if
c_cond
(paren
id|all
)paren
(brace
id|writeb
c_func
(paren
l_int|0xff
comma
op_amp
id|pccs-&gt;var
)paren
suffix:semicolon
id|local-&gt;num_multi
op_assign
l_int|0xff
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* Copy the kernel&squot;s list of MC addresses to card */
r_for
c_loop
(paren
id|dmip
op_assign
op_amp
id|dev-&gt;mc_list
suffix:semicolon
(paren
id|dmi
op_assign
op_star
id|dmip
)paren
op_ne
l_int|NULL
suffix:semicolon
id|dmip
op_assign
op_amp
id|dmi-&gt;next
)paren
(brace
id|memcpy_toio
c_func
(paren
id|p
comma
id|dmi-&gt;dmi_addr
comma
id|ETH_ALEN
)paren
suffix:semicolon
id|DEBUG
c_func
(paren
l_int|1
comma
l_string|&quot;ray_update_multi add addr %02x%02x%02x%02x%02x%02x&bslash;n&quot;
comma
id|dmi-&gt;dmi_addr
(braket
l_int|0
)braket
comma
id|dmi-&gt;dmi_addr
(braket
l_int|1
)braket
comma
id|dmi-&gt;dmi_addr
(braket
l_int|2
)braket
comma
id|dmi-&gt;dmi_addr
(braket
l_int|3
)braket
comma
id|dmi-&gt;dmi_addr
(braket
l_int|4
)braket
comma
id|dmi-&gt;dmi_addr
(braket
l_int|5
)braket
)paren
suffix:semicolon
id|p
op_add_assign
id|ETH_ALEN
suffix:semicolon
id|i
op_increment
suffix:semicolon
)brace
r_if
c_cond
(paren
id|i
OG
l_int|256
op_div
id|ADDRLEN
)paren
id|i
op_assign
l_int|256
op_div
id|ADDRLEN
suffix:semicolon
id|writeb
c_func
(paren
(paren
id|UCHAR
)paren
id|i
comma
op_amp
id|pccs-&gt;var
)paren
suffix:semicolon
id|DEBUG
c_func
(paren
l_int|1
comma
l_string|&quot;ray_cs update_multi %d addresses in list&bslash;n&quot;
comma
id|i
)paren
suffix:semicolon
multiline_comment|/* Interrupt the firmware to process the command */
id|local-&gt;num_multi
op_assign
id|i
suffix:semicolon
)brace
r_if
c_cond
(paren
id|interrupt_ecf
c_func
(paren
id|local
comma
id|ccsindex
)paren
)paren
(brace
id|DEBUG
c_func
(paren
l_int|1
comma
l_string|&quot;ray_cs update_multi failed - ECF not ready for intr&bslash;n&quot;
)paren
suffix:semicolon
id|writeb
c_func
(paren
id|CCS_BUFFER_FREE
comma
op_amp
(paren
id|pccs
op_increment
)paren
op_member_access_from_pointer
id|buffer_status
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* end ray_update_multi_list */
multiline_comment|/*===========================================================================*/
DECL|function|set_multicast_list
r_static
r_void
id|set_multicast_list
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
id|ray_dev_t
op_star
id|local
op_assign
(paren
id|ray_dev_t
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|UCHAR
id|promisc
suffix:semicolon
id|DEBUG
c_func
(paren
l_int|2
comma
l_string|&quot;ray_cs set_multicast_list(%p)&bslash;n&quot;
comma
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;flags
op_amp
id|IFF_PROMISC
)paren
(brace
r_if
c_cond
(paren
id|local-&gt;sparm.b5.a_promiscuous_mode
op_eq
l_int|0
)paren
(brace
id|DEBUG
c_func
(paren
l_int|1
comma
l_string|&quot;ray_cs set_multicast_list promisc on&bslash;n&quot;
)paren
suffix:semicolon
id|local-&gt;sparm.b5.a_promiscuous_mode
op_assign
l_int|1
suffix:semicolon
id|promisc
op_assign
l_int|1
suffix:semicolon
id|ray_update_parm
c_func
(paren
id|dev
comma
id|OBJID_promiscuous_mode
comma
"&bslash;"
op_amp
id|promisc
comma
r_sizeof
(paren
id|promisc
)paren
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
r_if
c_cond
(paren
id|local-&gt;sparm.b5.a_promiscuous_mode
op_eq
l_int|1
)paren
(brace
id|DEBUG
c_func
(paren
l_int|1
comma
l_string|&quot;ray_cs set_multicast_list promisc off&bslash;n&quot;
)paren
suffix:semicolon
id|local-&gt;sparm.b5.a_promiscuous_mode
op_assign
l_int|0
suffix:semicolon
id|promisc
op_assign
l_int|0
suffix:semicolon
id|ray_update_parm
c_func
(paren
id|dev
comma
id|OBJID_promiscuous_mode
comma
"&bslash;"
op_amp
id|promisc
comma
r_sizeof
(paren
id|promisc
)paren
)paren
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|dev-&gt;flags
op_amp
id|IFF_ALLMULTI
)paren
id|ray_update_multi_list
c_func
(paren
id|dev
comma
l_int|1
)paren
suffix:semicolon
r_else
(brace
r_if
c_cond
(paren
id|local-&gt;num_multi
op_ne
id|dev-&gt;mc_count
)paren
id|ray_update_multi_list
c_func
(paren
id|dev
comma
l_int|0
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* end set_multicast_list */
multiline_comment|/*=============================================================================&n; * All routines below here are run at interrupt time.&n;=============================================================================*/
DECL|function|ray_interrupt
r_static
r_void
id|ray_interrupt
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_struct
id|net_device
op_star
id|dev
op_assign
(paren
r_struct
id|net_device
op_star
)paren
id|dev_id
suffix:semicolon
id|dev_link_t
op_star
id|link
suffix:semicolon
id|ray_dev_t
op_star
id|local
suffix:semicolon
r_struct
id|ccs
op_star
id|pccs
suffix:semicolon
r_struct
id|rcs
op_star
id|prcs
suffix:semicolon
id|UCHAR
id|rcsindex
suffix:semicolon
id|UCHAR
id|tmp
suffix:semicolon
id|UCHAR
id|cmd
suffix:semicolon
id|UCHAR
id|status
suffix:semicolon
r_if
c_cond
(paren
id|dev
op_eq
l_int|NULL
)paren
multiline_comment|/* Note that we want interrupts with dev-&gt;start == 0 */
r_return
suffix:semicolon
id|DEBUG
c_func
(paren
l_int|4
comma
l_string|&quot;ray_cs: interrupt for *dev=%p&bslash;n&quot;
comma
id|dev
)paren
suffix:semicolon
id|local
op_assign
(paren
id|ray_dev_t
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|link
op_assign
(paren
id|dev_link_t
op_star
)paren
id|local-&gt;finder
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|link-&gt;state
op_amp
id|DEV_PRESENT
)paren
op_logical_or
id|link-&gt;state
op_amp
id|DEV_SUSPEND
)paren
(brace
id|DEBUG
c_func
(paren
l_int|2
comma
l_string|&quot;ray_cs interrupt from device not present or suspended.&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|rcsindex
op_assign
id|readb
c_func
(paren
op_amp
(paren
(paren
r_struct
id|scb
op_star
)paren
(paren
id|local-&gt;sram
)paren
)paren
op_member_access_from_pointer
id|rcs_index
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rcsindex
op_ge
(paren
id|NUMBER_OF_CCS
op_plus
id|NUMBER_OF_RCS
)paren
)paren
(brace
id|DEBUG
c_func
(paren
l_int|1
comma
l_string|&quot;ray_cs interrupt bad rcsindex = 0x%x&bslash;n&quot;
comma
id|rcsindex
)paren
suffix:semicolon
id|clear_interrupt
c_func
(paren
id|local
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|rcsindex
OL
id|NUMBER_OF_CCS
)paren
multiline_comment|/* If it&squot;s a returned CCS */
(brace
id|pccs
op_assign
(paren
(paren
r_struct
id|ccs
op_star
)paren
(paren
id|local-&gt;sram
op_plus
id|CCS_BASE
)paren
)paren
op_plus
id|rcsindex
suffix:semicolon
id|cmd
op_assign
id|readb
c_func
(paren
op_amp
id|pccs-&gt;cmd
)paren
suffix:semicolon
id|status
op_assign
id|readb
c_func
(paren
op_amp
id|pccs-&gt;buffer_status
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|cmd
)paren
(brace
r_case
id|CCS_DOWNLOAD_STARTUP_PARAMS
suffix:colon
multiline_comment|/* Happens in firmware someday */
id|del_timer
c_func
(paren
op_amp
id|local-&gt;timer
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
op_eq
id|CCS_COMMAND_COMPLETE
)paren
(brace
id|DEBUG
c_func
(paren
l_int|1
comma
l_string|&quot;ray_cs interrupt download_startup_parameters OK&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_else
(brace
id|DEBUG
c_func
(paren
l_int|1
comma
l_string|&quot;ray_cs interrupt download_startup_parameters fail&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|CCS_UPDATE_PARAMS
suffix:colon
id|DEBUG
c_func
(paren
l_int|1
comma
l_string|&quot;ray_cs interrupt update params done&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
op_ne
id|CCS_COMMAND_COMPLETE
)paren
(brace
id|tmp
op_assign
id|readb
c_func
(paren
op_amp
id|pccs-&gt;var.update_param.failure_cause
)paren
suffix:semicolon
id|DEBUG
c_func
(paren
l_int|0
comma
l_string|&quot;ray_cs interrupt update params failed - reason %d&bslash;n&quot;
comma
id|tmp
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|CCS_REPORT_PARAMS
suffix:colon
id|DEBUG
c_func
(paren
l_int|1
comma
l_string|&quot;ray_cs interrupt report params done&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CCS_UPDATE_MULTICAST_LIST
suffix:colon
multiline_comment|/* Note that this CCS isn&squot;t returned */
id|DEBUG
c_func
(paren
l_int|1
comma
l_string|&quot;ray_cs interrupt CCS Update Multicast List done&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CCS_UPDATE_POWER_SAVINGS_MODE
suffix:colon
id|DEBUG
c_func
(paren
l_int|1
comma
l_string|&quot;ray_cs interrupt update power save mode done&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CCS_START_NETWORK
suffix:colon
r_case
id|CCS_JOIN_NETWORK
suffix:colon
r_if
c_cond
(paren
id|status
op_eq
id|CCS_COMMAND_COMPLETE
)paren
(brace
r_if
c_cond
(paren
id|readb
c_func
(paren
op_amp
id|pccs-&gt;var.start_network.net_initiated
)paren
op_eq
l_int|1
)paren
(brace
id|DEBUG
c_func
(paren
l_int|0
comma
l_string|&quot;ray_cs interrupt network &bslash;&quot;%s&bslash;&quot; started&bslash;n&quot;
comma
"&bslash;"
id|local-&gt;sparm.b4.a_current_ess_id
)paren
suffix:semicolon
)brace
r_else
(brace
id|DEBUG
c_func
(paren
l_int|0
comma
l_string|&quot;ray_cs interrupt network &bslash;&quot;%s&bslash;&quot; joined&bslash;n&quot;
comma
"&bslash;"
id|local-&gt;sparm.b4.a_current_ess_id
)paren
suffix:semicolon
)brace
id|memcpy_fromio
c_func
(paren
op_amp
id|local-&gt;bss_id
comma
id|pccs-&gt;var.start_network.bssid
comma
id|ADDRLEN
)paren
suffix:semicolon
r_if
c_cond
(paren
id|local-&gt;fw_ver
op_eq
l_int|0x55
)paren
id|local-&gt;net_default_tx_rate
op_assign
l_int|3
suffix:semicolon
r_else
id|local-&gt;net_default_tx_rate
op_assign
id|readb
c_func
(paren
op_amp
id|pccs-&gt;var.start_network.net_default_tx_rate
)paren
suffix:semicolon
id|local-&gt;encryption
op_assign
id|readb
c_func
(paren
op_amp
id|pccs-&gt;var.start_network.encryption
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|sniffer
op_logical_and
(paren
id|local-&gt;net_type
op_eq
id|INFRA
)paren
op_logical_and
op_logical_neg
(paren
id|local-&gt;sparm.b4.a_acting_as_ap_status
)paren
)paren
(brace
id|authenticate
c_func
(paren
id|local
)paren
suffix:semicolon
)brace
id|local-&gt;card_status
op_assign
id|CARD_ACQ_COMPLETE
suffix:semicolon
)brace
r_else
(brace
id|local-&gt;card_status
op_assign
id|CARD_ACQ_FAILED
suffix:semicolon
id|del_timer
c_func
(paren
op_amp
id|local-&gt;timer
)paren
suffix:semicolon
id|local-&gt;timer.expires
op_assign
id|jiffies
op_plus
id|HZ
op_star
l_int|5
suffix:semicolon
id|local-&gt;timer.data
op_assign
(paren
r_int
)paren
id|local
suffix:semicolon
r_if
c_cond
(paren
id|status
op_eq
id|CCS_START_NETWORK
)paren
(brace
id|DEBUG
c_func
(paren
l_int|0
comma
l_string|&quot;ray_cs interrupt network &bslash;&quot;%s&bslash;&quot; start failed&bslash;n&quot;
comma
"&bslash;"
id|local-&gt;sparm.b4.a_current_ess_id
)paren
suffix:semicolon
id|local-&gt;timer.function
op_assign
op_amp
id|start_net
suffix:semicolon
)brace
r_else
(brace
id|DEBUG
c_func
(paren
l_int|0
comma
l_string|&quot;ray_cs interrupt network &bslash;&quot;%s&bslash;&quot; join failed&bslash;n&quot;
comma
"&bslash;"
id|local-&gt;sparm.b4.a_current_ess_id
)paren
suffix:semicolon
id|local-&gt;timer.function
op_assign
op_amp
id|join_net
suffix:semicolon
)brace
id|add_timer
c_func
(paren
op_amp
id|local-&gt;timer
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|CCS_START_ASSOCIATION
suffix:colon
r_if
c_cond
(paren
id|status
op_eq
id|CCS_COMMAND_COMPLETE
)paren
(brace
id|local-&gt;card_status
op_assign
id|CARD_ASSOC_COMPLETE
suffix:semicolon
id|DEBUG
c_func
(paren
l_int|0
comma
l_string|&quot;ray_cs association successful&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_else
(brace
id|DEBUG
c_func
(paren
l_int|0
comma
l_string|&quot;ray_cs association failed,&bslash;n&quot;
)paren
suffix:semicolon
id|local-&gt;card_status
op_assign
id|CARD_ASSOC_FAILED
suffix:semicolon
id|join_net
c_func
(paren
(paren
id|u_long
)paren
id|local
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|CCS_TX_REQUEST
suffix:colon
r_if
c_cond
(paren
id|status
op_eq
id|CCS_COMMAND_COMPLETE
)paren
(brace
id|DEBUG
c_func
(paren
l_int|3
comma
l_string|&quot;ray_cs interrupt tx request complete&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_else
(brace
id|DEBUG
c_func
(paren
l_int|1
comma
l_string|&quot;ray_cs interrupt tx request failed&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|sniffer
)paren
id|netif_start_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
id|netif_wake_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CCS_TEST_MEMORY
suffix:colon
id|DEBUG
c_func
(paren
l_int|1
comma
l_string|&quot;ray_cs interrupt mem test done&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CCS_SHUTDOWN
suffix:colon
id|DEBUG
c_func
(paren
l_int|1
comma
l_string|&quot;ray_cs interrupt Unexpected CCS returned - Shutdown&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CCS_DUMP_MEMORY
suffix:colon
id|DEBUG
c_func
(paren
l_int|1
comma
l_string|&quot;ray_cs interrupt dump memory done&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CCS_START_TIMER
suffix:colon
id|DEBUG
c_func
(paren
l_int|2
comma
l_string|&quot;ray_cs interrupt DING - raylink timer expired&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|DEBUG
c_func
(paren
l_int|1
comma
l_string|&quot;ray_cs interrupt Unexpected CCS 0x%x returned 0x%x&bslash;n&quot;
comma
"&bslash;"
id|rcsindex
comma
id|cmd
)paren
suffix:semicolon
)brace
id|writeb
c_func
(paren
id|CCS_BUFFER_FREE
comma
op_amp
id|pccs-&gt;buffer_status
)paren
suffix:semicolon
)brace
r_else
multiline_comment|/* It&squot;s an RCS */
(brace
id|prcs
op_assign
(paren
(paren
r_struct
id|rcs
op_star
)paren
(paren
id|local-&gt;sram
op_plus
id|CCS_BASE
)paren
)paren
op_plus
id|rcsindex
suffix:semicolon
r_switch
c_cond
(paren
id|readb
c_func
(paren
op_amp
id|prcs-&gt;interrupt_id
)paren
)paren
(brace
r_case
id|PROCESS_RX_PACKET
suffix:colon
id|ray_rx
c_func
(paren
id|dev
comma
id|local
comma
id|prcs
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|REJOIN_NET_COMPLETE
suffix:colon
id|DEBUG
c_func
(paren
l_int|1
comma
l_string|&quot;ray_cs interrupt rejoin net complete&bslash;n&quot;
)paren
suffix:semicolon
id|local-&gt;card_status
op_assign
id|CARD_ACQ_COMPLETE
suffix:semicolon
multiline_comment|/* do we need to clear tx buffers CCS&squot;s? */
r_if
c_cond
(paren
id|local-&gt;sparm.b4.a_network_type
op_eq
id|ADHOC
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|sniffer
)paren
id|netif_start_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
r_else
(brace
id|memcpy_fromio
c_func
(paren
op_amp
id|local-&gt;bss_id
comma
id|prcs-&gt;var.rejoin_net_complete.bssid
comma
id|ADDRLEN
)paren
suffix:semicolon
id|DEBUG
c_func
(paren
l_int|1
comma
l_string|&quot;ray_cs new BSSID = %02x%02x%02x%02x%02x%02x&bslash;n&quot;
comma
"&bslash;"
id|local-&gt;bss_id
(braket
l_int|0
)braket
comma
id|local-&gt;bss_id
(braket
l_int|1
)braket
comma
id|local-&gt;bss_id
(braket
l_int|2
)braket
comma
"&bslash;"
id|local-&gt;bss_id
(braket
l_int|3
)braket
comma
id|local-&gt;bss_id
(braket
l_int|4
)braket
comma
id|local-&gt;bss_id
(braket
l_int|5
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|sniffer
)paren
id|authenticate
c_func
(paren
id|local
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|ROAMING_INITIATED
suffix:colon
id|DEBUG
c_func
(paren
l_int|1
comma
l_string|&quot;ray_cs interrupt roaming initiated&bslash;n&quot;
)paren
suffix:semicolon
id|netif_stop_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
id|local-&gt;card_status
op_assign
id|CARD_DOING_ACQ
suffix:semicolon
r_break
suffix:semicolon
r_case
id|JAPAN_CALL_SIGN_RXD
suffix:colon
id|DEBUG
c_func
(paren
l_int|1
comma
l_string|&quot;ray_cs interrupt japan call sign rx&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|DEBUG
c_func
(paren
l_int|1
comma
l_string|&quot;ray_cs Unexpected interrupt for RCS 0x%x cmd = 0x%x&bslash;n&quot;
comma
"&bslash;"
id|rcsindex
comma
(paren
r_int
r_int
)paren
id|readb
c_func
(paren
op_amp
id|prcs-&gt;interrupt_id
)paren
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|writeb
c_func
(paren
id|CCS_BUFFER_FREE
comma
op_amp
id|prcs-&gt;buffer_status
)paren
suffix:semicolon
)brace
id|clear_interrupt
c_func
(paren
id|local
)paren
suffix:semicolon
)brace
multiline_comment|/* ray_interrupt */
multiline_comment|/*===========================================================================*/
DECL|function|ray_rx
r_static
r_void
id|ray_rx
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
id|ray_dev_t
op_star
id|local
comma
r_struct
id|rcs
op_star
id|prcs
)paren
(brace
r_int
id|rx_len
suffix:semicolon
r_int
r_int
id|pkt_addr
suffix:semicolon
id|UCHAR
op_star
id|pmsg
suffix:semicolon
id|DEBUG
c_func
(paren
l_int|4
comma
l_string|&quot;ray_rx process rx packet&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* Calculate address of packet within Rx buffer */
id|pkt_addr
op_assign
(paren
(paren
id|readb
c_func
(paren
op_amp
id|prcs-&gt;var.rx_packet.rx_data_ptr
(braket
l_int|0
)braket
)paren
op_lshift
l_int|8
)paren
op_plus
id|readb
c_func
(paren
op_amp
id|prcs-&gt;var.rx_packet.rx_data_ptr
(braket
l_int|1
)braket
)paren
)paren
op_amp
id|RX_BUFF_END
suffix:semicolon
multiline_comment|/* Length of first packet fragment */
id|rx_len
op_assign
(paren
id|readb
c_func
(paren
op_amp
id|prcs-&gt;var.rx_packet.rx_data_length
(braket
l_int|0
)braket
)paren
op_lshift
l_int|8
)paren
op_plus
id|readb
c_func
(paren
op_amp
id|prcs-&gt;var.rx_packet.rx_data_length
(braket
l_int|1
)braket
)paren
suffix:semicolon
id|local-&gt;last_rsl
op_assign
id|readb
c_func
(paren
op_amp
id|prcs-&gt;var.rx_packet.rx_sig_lev
)paren
suffix:semicolon
id|pmsg
op_assign
id|local-&gt;rmem
op_plus
id|pkt_addr
suffix:semicolon
r_switch
c_cond
(paren
id|readb
c_func
(paren
id|pmsg
)paren
)paren
(brace
r_case
id|DATA_TYPE
suffix:colon
id|DEBUG
c_func
(paren
l_int|4
comma
l_string|&quot;ray_rx data type&bslash;n&quot;
)paren
suffix:semicolon
id|rx_data
c_func
(paren
id|dev
comma
id|prcs
comma
id|pkt_addr
comma
id|rx_len
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|AUTHENTIC_TYPE
suffix:colon
id|DEBUG
c_func
(paren
l_int|4
comma
l_string|&quot;ray_rx authentic type&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sniffer
)paren
id|rx_data
c_func
(paren
id|dev
comma
id|prcs
comma
id|pkt_addr
comma
id|rx_len
)paren
suffix:semicolon
r_else
id|rx_authenticate
c_func
(paren
id|local
comma
id|prcs
comma
id|pkt_addr
comma
id|rx_len
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|DEAUTHENTIC_TYPE
suffix:colon
id|DEBUG
c_func
(paren
l_int|4
comma
l_string|&quot;ray_rx deauth type&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sniffer
)paren
id|rx_data
c_func
(paren
id|dev
comma
id|prcs
comma
id|pkt_addr
comma
id|rx_len
)paren
suffix:semicolon
r_else
id|rx_deauthenticate
c_func
(paren
id|local
comma
id|prcs
comma
id|pkt_addr
comma
id|rx_len
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|NULL_MSG_TYPE
suffix:colon
id|DEBUG
c_func
(paren
l_int|3
comma
l_string|&quot;ray_cs rx NULL msg&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|BEACON_TYPE
suffix:colon
id|DEBUG
c_func
(paren
l_int|4
comma
l_string|&quot;ray_rx beacon type&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sniffer
)paren
id|rx_data
c_func
(paren
id|dev
comma
id|prcs
comma
id|pkt_addr
comma
id|rx_len
)paren
suffix:semicolon
id|copy_from_rx_buff
c_func
(paren
id|local
comma
(paren
id|UCHAR
op_star
)paren
op_amp
id|local-&gt;last_bcn
comma
id|pkt_addr
comma
id|rx_len
OL
r_sizeof
(paren
r_struct
id|beacon_rx
)paren
ques
c_cond
id|rx_len
suffix:colon
r_sizeof
(paren
r_struct
id|beacon_rx
)paren
)paren
suffix:semicolon
id|local-&gt;beacon_rxed
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* Get the statistics so the card counters never overflow */
id|ray_get_stats
c_func
(paren
id|dev
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|DEBUG
c_func
(paren
l_int|0
comma
l_string|&quot;ray_cs unknown pkt type %2x&bslash;n&quot;
comma
(paren
r_int
r_int
)paren
id|readb
c_func
(paren
id|pmsg
)paren
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
multiline_comment|/* end ray_rx */
multiline_comment|/*===========================================================================*/
DECL|function|rx_data
r_static
r_void
id|rx_data
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_struct
id|rcs
op_star
id|prcs
comma
r_int
r_int
id|pkt_addr
comma
r_int
id|rx_len
)paren
(brace
r_struct
id|sk_buff
op_star
id|skb
op_assign
l_int|NULL
suffix:semicolon
r_struct
id|rcs
op_star
id|prcslink
op_assign
id|prcs
suffix:semicolon
id|ray_dev_t
op_star
id|local
op_assign
id|dev-&gt;priv
suffix:semicolon
id|UCHAR
op_star
id|rx_ptr
suffix:semicolon
r_int
id|total_len
suffix:semicolon
r_int
id|tmp
suffix:semicolon
macro_line|#ifdef WIRELESS_SPY
r_int
id|siglev
op_assign
id|local-&gt;last_rsl
suffix:semicolon
id|u_char
id|linksrcaddr
(braket
id|ETH_ALEN
)braket
suffix:semicolon
multiline_comment|/* Other end of the wireless link */
macro_line|#endif
r_if
c_cond
(paren
op_logical_neg
id|sniffer
)paren
(brace
r_if
c_cond
(paren
id|translate
)paren
(brace
multiline_comment|/* TBD length needs fixing for translated header */
r_if
c_cond
(paren
id|rx_len
template_param
(paren
id|dev-&gt;mtu
op_plus
id|RX_MAC_HEADER_LENGTH
op_plus
id|ETH_HLEN
op_plus
id|FCS_LEN
)paren
)paren
(brace
id|DEBUG
c_func
(paren
l_int|0
comma
l_string|&quot;ray_cs invalid packet length %d received &bslash;n&quot;
comma
id|rx_len
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
)brace
r_else
multiline_comment|/* encapsulated ethernet */
(brace
r_if
c_cond
(paren
id|rx_len
template_param
(paren
id|dev-&gt;mtu
op_plus
id|RX_MAC_HEADER_LENGTH
op_plus
id|ETH_HLEN
op_plus
id|FCS_LEN
)paren
)paren
(brace
id|DEBUG
c_func
(paren
l_int|0
comma
l_string|&quot;ray_cs invalid packet length %d received &bslash;n&quot;
comma
id|rx_len
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
)brace
)brace
id|DEBUG
c_func
(paren
l_int|4
comma
l_string|&quot;ray_cs rx_data packet&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* If fragmented packet, verify sizes of fragments add up */
r_if
c_cond
(paren
id|readb
c_func
(paren
op_amp
id|prcs-&gt;var.rx_packet.next_frag_rcs_index
)paren
op_ne
l_int|0xFF
)paren
(brace
id|DEBUG
c_func
(paren
l_int|1
comma
l_string|&quot;ray_cs rx&squot;ed fragment&bslash;n&quot;
)paren
suffix:semicolon
id|tmp
op_assign
(paren
id|readb
c_func
(paren
op_amp
id|prcs-&gt;var.rx_packet.totalpacketlength
(braket
l_int|0
)braket
)paren
op_lshift
l_int|8
)paren
op_plus
id|readb
c_func
(paren
op_amp
id|prcs-&gt;var.rx_packet.totalpacketlength
(braket
l_int|1
)braket
)paren
suffix:semicolon
id|total_len
op_assign
id|tmp
suffix:semicolon
id|prcslink
op_assign
id|prcs
suffix:semicolon
r_do
(brace
id|tmp
op_sub_assign
(paren
id|readb
c_func
(paren
op_amp
id|prcslink-&gt;var.rx_packet.rx_data_length
(braket
l_int|0
)braket
)paren
op_lshift
l_int|8
)paren
op_plus
id|readb
c_func
(paren
op_amp
id|prcslink-&gt;var.rx_packet.rx_data_length
(braket
l_int|1
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
id|readb
c_func
(paren
op_amp
id|prcslink-&gt;var.rx_packet.next_frag_rcs_index
)paren
op_eq
l_int|0xFF
op_logical_or
id|tmp
OL
l_int|0
)paren
r_break
suffix:semicolon
id|prcslink
op_assign
(paren
(paren
r_struct
id|rcs
op_star
)paren
(paren
id|local-&gt;sram
op_plus
id|CCS_BASE
)paren
)paren
op_plus
id|readb
c_func
(paren
op_amp
id|prcslink-&gt;link_field
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tmp
OL
l_int|0
)paren
(brace
id|DEBUG
c_func
(paren
l_int|0
comma
l_string|&quot;ray_cs rx_data fragment lengths don&squot;t add up&bslash;n&quot;
)paren
suffix:semicolon
id|local-&gt;stats.rx_dropped
op_increment
suffix:semicolon
id|release_frag_chain
c_func
(paren
id|local
comma
id|prcs
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
)brace
r_else
(brace
multiline_comment|/* Single unfragmented packet */
id|total_len
op_assign
id|rx_len
suffix:semicolon
)brace
id|skb
op_assign
id|dev_alloc_skb
c_func
(paren
id|total_len
op_plus
l_int|5
)paren
suffix:semicolon
r_if
c_cond
(paren
id|skb
op_eq
l_int|NULL
)paren
(brace
id|DEBUG
c_func
(paren
l_int|0
comma
l_string|&quot;ray_cs rx_data could not allocate skb&bslash;n&quot;
)paren
suffix:semicolon
id|local-&gt;stats.rx_dropped
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|readb
c_func
(paren
op_amp
id|prcs-&gt;var.rx_packet.next_frag_rcs_index
)paren
op_ne
l_int|0xFF
)paren
id|release_frag_chain
c_func
(paren
id|local
comma
id|prcs
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|skb_reserve
c_func
(paren
id|skb
comma
l_int|2
)paren
suffix:semicolon
multiline_comment|/* Align IP on 16 byte (TBD check this)*/
id|skb-&gt;dev
op_assign
id|dev
suffix:semicolon
id|DEBUG
c_func
(paren
l_int|4
comma
l_string|&quot;ray_cs rx_data total_len = %x, rx_len = %x&bslash;n&quot;
comma
id|total_len
comma
id|rx_len
)paren
suffix:semicolon
multiline_comment|/************************/
multiline_comment|/* Reserve enough room for the whole damn packet. */
id|rx_ptr
op_assign
id|skb_put
c_func
(paren
id|skb
comma
id|total_len
)paren
suffix:semicolon
multiline_comment|/* Copy the whole packet to sk_buff */
id|rx_ptr
op_add_assign
id|copy_from_rx_buff
c_func
(paren
id|local
comma
id|rx_ptr
comma
id|pkt_addr
op_amp
id|RX_BUFF_END
comma
id|rx_len
)paren
suffix:semicolon
multiline_comment|/* Get source address */
macro_line|#ifdef WIRELESS_SPY
id|memcpy
c_func
(paren
id|linksrcaddr
comma
(paren
(paren
r_struct
id|mac_header
op_star
)paren
id|skb-&gt;data
)paren
op_member_access_from_pointer
id|addr_2
comma
id|ETH_ALEN
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/* Now, deal with encapsulation/translation/sniffer */
r_if
c_cond
(paren
op_logical_neg
id|sniffer
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|translate
)paren
(brace
multiline_comment|/* Encapsulated ethernet, so just lop off 802.11 MAC header */
multiline_comment|/* TBD reserve            skb_reserve( skb, RX_MAC_HEADER_LENGTH); */
id|skb_pull
c_func
(paren
id|skb
comma
id|RX_MAC_HEADER_LENGTH
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* Do translation */
id|untranslate
c_func
(paren
id|local
comma
id|skb
comma
id|total_len
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
multiline_comment|/* sniffer mode, so just pass whole packet */
)brace
suffix:semicolon
multiline_comment|/************************/
multiline_comment|/* Now pick up the rest of the fragments if any */
id|tmp
op_assign
l_int|17
suffix:semicolon
r_if
c_cond
(paren
id|readb
c_func
(paren
op_amp
id|prcs-&gt;var.rx_packet.next_frag_rcs_index
)paren
op_ne
l_int|0xFF
)paren
(brace
id|prcslink
op_assign
id|prcs
suffix:semicolon
id|DEBUG
c_func
(paren
l_int|1
comma
l_string|&quot;ray_cs rx_data in fragment loop&bslash;n&quot;
)paren
suffix:semicolon
r_do
(brace
id|prcslink
op_assign
(paren
(paren
r_struct
id|rcs
op_star
)paren
(paren
id|local-&gt;sram
op_plus
id|CCS_BASE
)paren
)paren
op_plus
id|readb
c_func
(paren
op_amp
id|prcslink-&gt;var.rx_packet.next_frag_rcs_index
)paren
suffix:semicolon
id|rx_len
op_assign
(paren
(paren
id|readb
c_func
(paren
op_amp
id|prcslink-&gt;var.rx_packet.rx_data_length
(braket
l_int|0
)braket
)paren
op_lshift
l_int|8
)paren
op_plus
id|readb
c_func
(paren
op_amp
id|prcslink-&gt;var.rx_packet.rx_data_length
(braket
l_int|1
)braket
)paren
)paren
op_amp
id|RX_BUFF_END
suffix:semicolon
id|pkt_addr
op_assign
(paren
(paren
id|readb
c_func
(paren
op_amp
id|prcslink-&gt;var.rx_packet.rx_data_ptr
(braket
l_int|0
)braket
)paren
op_lshift
l_int|8
)paren
op_plus
id|readb
c_func
(paren
op_amp
id|prcslink-&gt;var.rx_packet.rx_data_ptr
(braket
l_int|1
)braket
)paren
)paren
op_amp
id|RX_BUFF_END
suffix:semicolon
id|rx_ptr
op_add_assign
id|copy_from_rx_buff
c_func
(paren
id|local
comma
id|rx_ptr
comma
id|pkt_addr
comma
id|rx_len
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
id|tmp
op_decrement
op_logical_and
id|readb
c_func
(paren
op_amp
id|prcslink-&gt;var.rx_packet.next_frag_rcs_index
)paren
op_ne
l_int|0xFF
)paren
suffix:semicolon
id|release_frag_chain
c_func
(paren
id|local
comma
id|prcs
)paren
suffix:semicolon
)brace
id|skb-&gt;protocol
op_assign
id|eth_type_trans
c_func
(paren
id|skb
comma
id|dev
)paren
suffix:semicolon
id|netif_rx
c_func
(paren
id|skb
)paren
suffix:semicolon
id|local-&gt;stats.rx_packets
op_increment
suffix:semicolon
id|local-&gt;stats.rx_bytes
op_add_assign
id|skb-&gt;len
suffix:semicolon
multiline_comment|/* Gather signal strength per address */
macro_line|#ifdef WIRELESS_SPY
multiline_comment|/* For the Access Point or the node having started the ad-hoc net&n;     * note : ad-hoc work only in some specific configurations, but we&n;     * kludge in ray_get_wireless_stats... */
r_if
c_cond
(paren
op_logical_neg
id|memcmp
c_func
(paren
id|linksrcaddr
comma
id|local-&gt;bss_id
comma
id|ETH_ALEN
)paren
)paren
(brace
multiline_comment|/* Update statistics */
multiline_comment|/*local-&gt;wstats.qual.qual = none ? */
id|local-&gt;wstats.qual.level
op_assign
id|siglev
suffix:semicolon
multiline_comment|/*local-&gt;wstats.qual.noise = none ? */
id|local-&gt;wstats.qual.updated
op_assign
l_int|0x2
suffix:semicolon
)brace
multiline_comment|/* Now, for the addresses in the spy list */
(brace
r_int
id|i
suffix:semicolon
multiline_comment|/* Look all addresses */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|local-&gt;spy_number
suffix:semicolon
id|i
op_increment
)paren
multiline_comment|/* If match */
r_if
c_cond
(paren
op_logical_neg
id|memcmp
c_func
(paren
id|linksrcaddr
comma
id|local-&gt;spy_address
(braket
id|i
)braket
comma
id|ETH_ALEN
)paren
)paren
(brace
multiline_comment|/* Update statistics */
multiline_comment|/*local-&gt;spy_stat[i].qual = none ? */
id|local-&gt;spy_stat
(braket
id|i
)braket
dot
id|level
op_assign
id|siglev
suffix:semicolon
multiline_comment|/*local-&gt;spy_stat[i].noise = none ? */
id|local-&gt;spy_stat
(braket
id|i
)braket
dot
id|updated
op_assign
l_int|0x2
suffix:semicolon
)brace
)brace
macro_line|#endif&t;/* WIRELESS_SPY */
)brace
multiline_comment|/* end rx_data */
multiline_comment|/*===========================================================================*/
DECL|function|untranslate
r_static
r_void
id|untranslate
c_func
(paren
id|ray_dev_t
op_star
id|local
comma
r_struct
id|sk_buff
op_star
id|skb
comma
r_int
id|len
)paren
(brace
id|snaphdr_t
op_star
id|psnap
op_assign
(paren
id|snaphdr_t
op_star
)paren
(paren
id|skb-&gt;data
op_plus
id|RX_MAC_HEADER_LENGTH
)paren
suffix:semicolon
r_struct
id|mac_header
op_star
id|pmac
op_assign
(paren
r_struct
id|mac_header
op_star
)paren
id|skb-&gt;data
suffix:semicolon
r_int
r_int
id|type
op_assign
op_star
(paren
r_int
r_int
op_star
)paren
id|psnap-&gt;ethertype
suffix:semicolon
r_int
r_int
id|xsap
op_assign
op_star
(paren
r_int
r_int
op_star
)paren
id|psnap
op_amp
l_int|0x00ffffff
suffix:semicolon
r_int
r_int
id|org
op_assign
(paren
op_star
(paren
r_int
r_int
op_star
)paren
id|psnap-&gt;org
)paren
op_amp
l_int|0x00ffffff
suffix:semicolon
r_int
id|delta
suffix:semicolon
r_struct
id|ethhdr
op_star
id|peth
suffix:semicolon
id|UCHAR
id|srcaddr
(braket
id|ADDRLEN
)braket
suffix:semicolon
id|UCHAR
id|destaddr
(braket
id|ADDRLEN
)braket
suffix:semicolon
r_if
c_cond
(paren
id|pmac-&gt;frame_ctl_2
op_amp
id|FC2_FROM_DS
)paren
(brace
r_if
c_cond
(paren
id|pmac-&gt;frame_ctl_2
op_amp
id|FC2_TO_DS
)paren
(brace
multiline_comment|/* AP to AP */
id|memcpy
c_func
(paren
id|destaddr
comma
id|pmac-&gt;addr_3
comma
id|ADDRLEN
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|srcaddr
comma
(paren
(paren
r_int
r_char
op_star
)paren
id|pmac-&gt;addr_3
)paren
op_plus
id|ADDRLEN
comma
id|ADDRLEN
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* AP to terminal */
id|memcpy
c_func
(paren
id|destaddr
comma
id|pmac-&gt;addr_1
comma
id|ADDRLEN
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|srcaddr
comma
id|pmac-&gt;addr_3
comma
id|ADDRLEN
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
multiline_comment|/* Terminal to AP */
r_if
c_cond
(paren
id|pmac-&gt;frame_ctl_2
op_amp
id|FC2_TO_DS
)paren
(brace
id|memcpy
c_func
(paren
id|destaddr
comma
id|pmac-&gt;addr_3
comma
id|ADDRLEN
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|srcaddr
comma
id|pmac-&gt;addr_2
comma
id|ADDRLEN
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* Adhoc */
id|memcpy
c_func
(paren
id|destaddr
comma
id|pmac-&gt;addr_1
comma
id|ADDRLEN
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|srcaddr
comma
id|pmac-&gt;addr_2
comma
id|ADDRLEN
)paren
suffix:semicolon
)brace
)brace
macro_line|#ifdef PCMCIA_DEBUG
r_if
c_cond
(paren
id|pc_debug
OG
l_int|3
)paren
(brace
r_int
id|i
suffix:semicolon
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;skb-&gt;data before untranslate&quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|64
suffix:semicolon
id|i
op_increment
)paren
id|printk
c_func
(paren
l_string|&quot;%02x &quot;
comma
id|skb-&gt;data
(braket
id|i
)braket
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;&bslash;n&quot;
id|KERN_DEBUG
l_string|&quot;type = %08x, xsap = %08x, org = %08x&bslash;n&quot;
comma
id|type
comma
id|xsap
comma
id|org
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;untranslate skb-&gt;data = %p&bslash;n&quot;
comma
id|skb-&gt;data
)paren
suffix:semicolon
)brace
macro_line|#endif
r_if
c_cond
(paren
id|xsap
op_ne
id|SNAP_ID
)paren
(brace
multiline_comment|/* not a snap type so leave it alone */
id|DEBUG
c_func
(paren
l_int|3
comma
l_string|&quot;ray_cs untranslate NOT SNAP %x&bslash;n&quot;
comma
op_star
(paren
r_int
r_int
op_star
)paren
id|psnap
op_amp
l_int|0x00ffffff
)paren
suffix:semicolon
id|delta
op_assign
id|RX_MAC_HEADER_LENGTH
op_minus
id|ETH_HLEN
suffix:semicolon
id|peth
op_assign
(paren
r_struct
id|ethhdr
op_star
)paren
(paren
id|skb-&gt;data
op_plus
id|delta
)paren
suffix:semicolon
id|peth-&gt;h_proto
op_assign
id|htons
c_func
(paren
id|len
op_minus
id|RX_MAC_HEADER_LENGTH
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* Its a SNAP */
r_if
c_cond
(paren
id|org
op_eq
id|BRIDGE_ENCAP
)paren
(brace
multiline_comment|/* EtherII and nuke the LLC  */
id|DEBUG
c_func
(paren
l_int|3
comma
l_string|&quot;ray_cs untranslate Bridge encap&bslash;n&quot;
)paren
suffix:semicolon
id|delta
op_assign
id|RX_MAC_HEADER_LENGTH
op_plus
r_sizeof
(paren
r_struct
id|snaphdr_t
)paren
op_minus
id|ETH_HLEN
suffix:semicolon
id|peth
op_assign
(paren
r_struct
id|ethhdr
op_star
)paren
(paren
id|skb-&gt;data
op_plus
id|delta
)paren
suffix:semicolon
id|peth-&gt;h_proto
op_assign
id|type
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|org
op_eq
id|RFC1042_ENCAP
)paren
(brace
r_switch
c_cond
(paren
id|type
)paren
(brace
r_case
id|RAY_IPX_TYPE
suffix:colon
r_case
id|APPLEARP_TYPE
suffix:colon
id|DEBUG
c_func
(paren
l_int|3
comma
l_string|&quot;ray_cs untranslate RFC IPX/AARP&bslash;n&quot;
)paren
suffix:semicolon
id|delta
op_assign
id|RX_MAC_HEADER_LENGTH
op_minus
id|ETH_HLEN
suffix:semicolon
id|peth
op_assign
(paren
r_struct
id|ethhdr
op_star
)paren
(paren
id|skb-&gt;data
op_plus
id|delta
)paren
suffix:semicolon
id|peth-&gt;h_proto
op_assign
id|htons
c_func
(paren
id|len
op_minus
id|RX_MAC_HEADER_LENGTH
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|DEBUG
c_func
(paren
l_int|3
comma
l_string|&quot;ray_cs untranslate RFC default&bslash;n&quot;
)paren
suffix:semicolon
id|delta
op_assign
id|RX_MAC_HEADER_LENGTH
op_plus
r_sizeof
(paren
r_struct
id|snaphdr_t
)paren
op_minus
id|ETH_HLEN
suffix:semicolon
id|peth
op_assign
(paren
r_struct
id|ethhdr
op_star
)paren
(paren
id|skb-&gt;data
op_plus
id|delta
)paren
suffix:semicolon
id|peth-&gt;h_proto
op_assign
id|type
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
r_else
(brace
id|printk
c_func
(paren
l_string|&quot;ray_cs untranslate very confused by packet&bslash;n&quot;
)paren
suffix:semicolon
id|delta
op_assign
id|RX_MAC_HEADER_LENGTH
op_minus
id|ETH_HLEN
suffix:semicolon
id|peth
op_assign
(paren
r_struct
id|ethhdr
op_star
)paren
(paren
id|skb-&gt;data
op_plus
id|delta
)paren
suffix:semicolon
id|peth-&gt;h_proto
op_assign
id|type
suffix:semicolon
)brace
)brace
)brace
multiline_comment|/* TBD reserve  skb_reserve(skb, delta); */
id|skb_pull
c_func
(paren
id|skb
comma
id|delta
)paren
suffix:semicolon
id|DEBUG
c_func
(paren
l_int|3
comma
l_string|&quot;untranslate after skb_pull(%d), skb-&gt;data = %p&bslash;n&quot;
comma
id|delta
comma
id|skb-&gt;data
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|peth-&gt;h_dest
comma
id|destaddr
comma
id|ADDRLEN
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|peth-&gt;h_source
comma
id|srcaddr
comma
id|ADDRLEN
)paren
suffix:semicolon
macro_line|#ifdef PCMCIA_DEBUG
r_if
c_cond
(paren
id|pc_debug
OG
l_int|3
)paren
(brace
r_int
id|i
suffix:semicolon
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;skb-&gt;data after untranslate:&quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|64
suffix:semicolon
id|i
op_increment
)paren
id|printk
c_func
(paren
l_string|&quot;%02x &quot;
comma
id|skb-&gt;data
(braket
id|i
)braket
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
)brace
macro_line|#endif
)brace
multiline_comment|/* end untranslate */
multiline_comment|/*===========================================================================*/
multiline_comment|/* Copy data from circular receive buffer to PC memory.&n; * dest     = destination address in PC memory&n; * pkt_addr = source address in receive buffer&n; * len      = length of packet to copy&n; */
DECL|function|copy_from_rx_buff
r_static
r_int
id|copy_from_rx_buff
c_func
(paren
id|ray_dev_t
op_star
id|local
comma
id|UCHAR
op_star
id|dest
comma
r_int
id|pkt_addr
comma
r_int
id|length
)paren
(brace
r_int
id|wrap_bytes
op_assign
(paren
id|pkt_addr
op_plus
id|length
)paren
op_minus
(paren
id|RX_BUFF_END
op_plus
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|wrap_bytes
op_le
l_int|0
)paren
(brace
id|memcpy_fromio
c_func
(paren
id|dest
comma
id|local-&gt;rmem
op_plus
id|pkt_addr
comma
id|length
)paren
suffix:semicolon
)brace
r_else
multiline_comment|/* Packet wrapped in circular buffer */
(brace
id|memcpy_fromio
c_func
(paren
id|dest
comma
id|local-&gt;rmem
op_plus
id|pkt_addr
comma
id|length
op_minus
id|wrap_bytes
)paren
suffix:semicolon
id|memcpy_fromio
c_func
(paren
id|dest
op_plus
id|length
op_minus
id|wrap_bytes
comma
id|local-&gt;rmem
comma
id|wrap_bytes
)paren
suffix:semicolon
)brace
r_return
id|length
suffix:semicolon
)brace
multiline_comment|/*===========================================================================*/
DECL|function|release_frag_chain
r_static
r_void
id|release_frag_chain
c_func
(paren
id|ray_dev_t
op_star
id|local
comma
r_struct
id|rcs
op_star
id|prcs
)paren
(brace
r_struct
id|rcs
op_star
id|prcslink
op_assign
id|prcs
suffix:semicolon
r_int
id|tmp
op_assign
l_int|17
suffix:semicolon
r_int
id|rcsindex
op_assign
id|readb
c_func
(paren
op_amp
id|prcs-&gt;var.rx_packet.next_frag_rcs_index
)paren
suffix:semicolon
r_while
c_loop
(paren
id|tmp
op_decrement
)paren
(brace
id|writeb
c_func
(paren
id|CCS_BUFFER_FREE
comma
op_amp
id|prcslink-&gt;buffer_status
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rcsindex
op_ge
(paren
id|NUMBER_OF_CCS
op_plus
id|NUMBER_OF_RCS
)paren
)paren
(brace
id|DEBUG
c_func
(paren
l_int|1
comma
l_string|&quot;ray_cs interrupt bad rcsindex = 0x%x&bslash;n&quot;
comma
id|rcsindex
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|prcslink
op_assign
(paren
(paren
r_struct
id|rcs
op_star
)paren
(paren
id|local-&gt;sram
op_plus
id|CCS_BASE
)paren
)paren
op_plus
id|rcsindex
suffix:semicolon
id|rcsindex
op_assign
id|readb
c_func
(paren
op_amp
id|prcslink-&gt;var.rx_packet.next_frag_rcs_index
)paren
suffix:semicolon
)brace
id|writeb
c_func
(paren
id|CCS_BUFFER_FREE
comma
op_amp
id|prcslink-&gt;buffer_status
)paren
suffix:semicolon
)brace
multiline_comment|/*===========================================================================*/
DECL|function|authenticate
r_static
r_void
id|authenticate
c_func
(paren
id|ray_dev_t
op_star
id|local
)paren
(brace
id|dev_link_t
op_star
id|link
op_assign
id|local-&gt;finder
suffix:semicolon
id|DEBUG
c_func
(paren
l_int|0
comma
l_string|&quot;ray_cs Starting authentication.&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|link-&gt;state
op_amp
id|DEV_PRESENT
)paren
)paren
(brace
id|DEBUG
c_func
(paren
l_int|2
comma
l_string|&quot;ray_cs authenticate - device not present&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|del_timer
c_func
(paren
op_amp
id|local-&gt;timer
)paren
suffix:semicolon
r_if
c_cond
(paren
id|build_auth_frame
c_func
(paren
id|local
comma
id|local-&gt;bss_id
comma
id|OPEN_AUTH_REQUEST
)paren
)paren
(brace
id|local-&gt;timer.function
op_assign
op_amp
id|join_net
suffix:semicolon
)brace
r_else
(brace
id|local-&gt;timer.function
op_assign
op_amp
id|authenticate_timeout
suffix:semicolon
)brace
id|local-&gt;timer.expires
op_assign
id|jiffies
op_plus
id|HZ
op_star
l_int|2
suffix:semicolon
id|local-&gt;timer.data
op_assign
(paren
r_int
)paren
id|local
suffix:semicolon
id|add_timer
c_func
(paren
op_amp
id|local-&gt;timer
)paren
suffix:semicolon
id|local-&gt;authentication_state
op_assign
id|AWAITING_RESPONSE
suffix:semicolon
)brace
multiline_comment|/* end authenticate */
multiline_comment|/*===========================================================================*/
DECL|function|rx_authenticate
r_static
r_void
id|rx_authenticate
c_func
(paren
id|ray_dev_t
op_star
id|local
comma
r_struct
id|rcs
op_star
id|prcs
comma
r_int
r_int
id|pkt_addr
comma
r_int
id|rx_len
)paren
(brace
id|UCHAR
id|buff
(braket
l_int|256
)braket
suffix:semicolon
r_struct
id|rx_msg
op_star
id|msg
op_assign
(paren
r_struct
id|rx_msg
op_star
)paren
id|buff
suffix:semicolon
id|del_timer
c_func
(paren
op_amp
id|local-&gt;timer
)paren
suffix:semicolon
id|copy_from_rx_buff
c_func
(paren
id|local
comma
id|buff
comma
id|pkt_addr
comma
id|rx_len
op_amp
l_int|0xff
)paren
suffix:semicolon
multiline_comment|/* if we are trying to get authenticated */
r_if
c_cond
(paren
id|local-&gt;sparm.b4.a_network_type
op_eq
id|ADHOC
)paren
(brace
id|DEBUG
c_func
(paren
l_int|1
comma
l_string|&quot;ray_cs rx_auth var= %02x %02x %02x %02x %02x %02x&bslash;n&quot;
comma
id|msg-&gt;var
(braket
l_int|0
)braket
comma
id|msg-&gt;var
(braket
l_int|1
)braket
comma
id|msg-&gt;var
(braket
l_int|2
)braket
comma
id|msg-&gt;var
(braket
l_int|3
)braket
comma
id|msg-&gt;var
(braket
l_int|4
)braket
comma
id|msg-&gt;var
(braket
l_int|5
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
id|msg-&gt;var
(braket
l_int|2
)braket
op_eq
l_int|1
)paren
(brace
id|DEBUG
c_func
(paren
l_int|0
comma
l_string|&quot;ray_cs Sending authentication response.&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|build_auth_frame
(paren
id|local
comma
id|msg-&gt;mac.addr_2
comma
id|OPEN_AUTH_RESPONSE
)paren
)paren
(brace
id|local-&gt;authentication_state
op_assign
id|NEED_TO_AUTH
suffix:semicolon
id|memcpy
c_func
(paren
id|local-&gt;auth_id
comma
id|msg-&gt;mac.addr_2
comma
id|ADDRLEN
)paren
suffix:semicolon
)brace
)brace
)brace
r_else
multiline_comment|/* Infrastructure network */
(brace
r_if
c_cond
(paren
id|local-&gt;authentication_state
op_eq
id|AWAITING_RESPONSE
)paren
(brace
multiline_comment|/* Verify authentication sequence #2 and success */
r_if
c_cond
(paren
id|msg-&gt;var
(braket
l_int|2
)braket
op_eq
l_int|2
)paren
(brace
r_if
c_cond
(paren
(paren
id|msg-&gt;var
(braket
l_int|3
)braket
op_or
id|msg-&gt;var
(braket
l_int|4
)braket
)paren
op_eq
l_int|0
)paren
(brace
id|DEBUG
c_func
(paren
l_int|1
comma
l_string|&quot;Authentication successful&bslash;n&quot;
)paren
suffix:semicolon
id|local-&gt;card_status
op_assign
id|CARD_AUTH_COMPLETE
suffix:semicolon
id|associate
c_func
(paren
id|local
)paren
suffix:semicolon
id|local-&gt;authentication_state
op_assign
id|AUTHENTICATED
suffix:semicolon
)brace
r_else
(brace
id|DEBUG
c_func
(paren
l_int|0
comma
l_string|&quot;Authentication refused&bslash;n&quot;
)paren
suffix:semicolon
id|local-&gt;card_status
op_assign
id|CARD_AUTH_REFUSED
suffix:semicolon
id|join_net
c_func
(paren
(paren
id|u_long
)paren
id|local
)paren
suffix:semicolon
id|local-&gt;authentication_state
op_assign
id|UNAUTHENTICATED
suffix:semicolon
)brace
)brace
)brace
)brace
)brace
multiline_comment|/* end rx_authenticate */
multiline_comment|/*===========================================================================*/
DECL|function|associate
r_static
r_void
id|associate
c_func
(paren
id|ray_dev_t
op_star
id|local
)paren
(brace
r_struct
id|ccs
op_star
id|pccs
suffix:semicolon
id|dev_link_t
op_star
id|link
op_assign
id|local-&gt;finder
suffix:semicolon
r_struct
id|net_device
op_star
id|dev
op_assign
id|link-&gt;priv
suffix:semicolon
r_int
id|ccsindex
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|link-&gt;state
op_amp
id|DEV_PRESENT
)paren
)paren
(brace
id|DEBUG
c_func
(paren
l_int|2
comma
l_string|&quot;ray_cs associate - device not present&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/* If no tx buffers available, return*/
r_if
c_cond
(paren
(paren
id|ccsindex
op_assign
id|get_free_ccs
c_func
(paren
id|local
)paren
)paren
OL
l_int|0
)paren
(brace
multiline_comment|/* TBD should never be here but... what if we are? */
id|DEBUG
c_func
(paren
l_int|1
comma
l_string|&quot;ray_cs associate - No free ccs&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|DEBUG
c_func
(paren
l_int|1
comma
l_string|&quot;ray_cs Starting association with access point&bslash;n&quot;
)paren
suffix:semicolon
id|pccs
op_assign
(paren
(paren
r_struct
id|ccs
op_star
)paren
(paren
id|local-&gt;sram
op_plus
id|CCS_BASE
)paren
)paren
op_plus
id|ccsindex
suffix:semicolon
multiline_comment|/* fill in the CCS */
id|writeb
c_func
(paren
id|CCS_START_ASSOCIATION
comma
op_amp
id|pccs-&gt;cmd
)paren
suffix:semicolon
multiline_comment|/* Interrupt the firmware to process the command */
r_if
c_cond
(paren
id|interrupt_ecf
c_func
(paren
id|local
comma
id|ccsindex
)paren
)paren
(brace
id|DEBUG
c_func
(paren
l_int|1
comma
l_string|&quot;ray_cs associate failed - ECF not ready for intr&bslash;n&quot;
)paren
suffix:semicolon
id|writeb
c_func
(paren
id|CCS_BUFFER_FREE
comma
op_amp
(paren
id|pccs
op_increment
)paren
op_member_access_from_pointer
id|buffer_status
)paren
suffix:semicolon
id|del_timer
c_func
(paren
op_amp
id|local-&gt;timer
)paren
suffix:semicolon
id|local-&gt;timer.expires
op_assign
id|jiffies
op_plus
id|HZ
op_star
l_int|2
suffix:semicolon
id|local-&gt;timer.data
op_assign
(paren
r_int
)paren
id|local
suffix:semicolon
id|local-&gt;timer.function
op_assign
op_amp
id|join_net
suffix:semicolon
id|add_timer
c_func
(paren
op_amp
id|local-&gt;timer
)paren
suffix:semicolon
id|local-&gt;card_status
op_assign
id|CARD_ASSOC_FAILED
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|sniffer
)paren
id|netif_start_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
multiline_comment|/* end associate */
multiline_comment|/*===========================================================================*/
DECL|function|rx_deauthenticate
r_static
r_void
id|rx_deauthenticate
c_func
(paren
id|ray_dev_t
op_star
id|local
comma
r_struct
id|rcs
op_star
id|prcs
comma
r_int
r_int
id|pkt_addr
comma
r_int
id|rx_len
)paren
(brace
multiline_comment|/*  UCHAR buff[256];&n;    struct rx_msg *msg = (struct rx_msg *)buff;&n;*/
id|DEBUG
c_func
(paren
l_int|0
comma
l_string|&quot;Deauthentication frame received&bslash;n&quot;
)paren
suffix:semicolon
id|local-&gt;authentication_state
op_assign
id|UNAUTHENTICATED
suffix:semicolon
multiline_comment|/* Need to reauthenticate or rejoin depending on reason code */
multiline_comment|/*  copy_from_rx_buff(local, buff, pkt_addr, rx_len &amp; 0xff);&n; */
)brace
multiline_comment|/*===========================================================================*/
DECL|function|clear_interrupt
r_static
r_void
id|clear_interrupt
c_func
(paren
id|ray_dev_t
op_star
id|local
)paren
(brace
id|writeb
c_func
(paren
l_int|0
comma
id|local-&gt;amem
op_plus
id|CIS_OFFSET
op_plus
id|HCS_INTR_OFFSET
)paren
suffix:semicolon
)brace
multiline_comment|/*===========================================================================*/
macro_line|#ifdef CONFIG_PROC_FS
DECL|macro|MAXDATA
mdefine_line|#define MAXDATA (PAGE_SIZE - 80)
DECL|variable|card_status
r_static
r_char
op_star
id|card_status
(braket
)braket
op_assign
(brace
l_string|&quot;Card inserted - uninitialized&quot;
comma
multiline_comment|/* 0 */
l_string|&quot;Card not downloaded&quot;
comma
multiline_comment|/* 1 */
l_string|&quot;Waiting for download parameters&quot;
comma
multiline_comment|/* 2 */
l_string|&quot;Card doing acquisition&quot;
comma
multiline_comment|/* 3 */
l_string|&quot;Acquisition complete&quot;
comma
multiline_comment|/* 4 */
l_string|&quot;Authentication complete&quot;
comma
multiline_comment|/* 5 */
l_string|&quot;Association complete&quot;
comma
multiline_comment|/* 6 */
l_string|&quot;???&quot;
comma
l_string|&quot;???&quot;
comma
l_string|&quot;???&quot;
comma
l_string|&quot;???&quot;
comma
multiline_comment|/* 7 8 9 10 undefined */
l_string|&quot;Card init error&quot;
comma
multiline_comment|/* 11 */
l_string|&quot;Download parameters error&quot;
comma
multiline_comment|/* 12 */
l_string|&quot;???&quot;
comma
multiline_comment|/* 13 */
l_string|&quot;Acquisition failed&quot;
comma
multiline_comment|/* 14 */
l_string|&quot;Authentication refused&quot;
comma
multiline_comment|/* 15 */
l_string|&quot;Association failed&quot;
multiline_comment|/* 16 */
)brace
suffix:semicolon
DECL|variable|nettype
r_static
r_char
op_star
id|nettype
(braket
)braket
op_assign
(brace
l_string|&quot;Adhoc&quot;
comma
l_string|&quot;Infra &quot;
)brace
suffix:semicolon
DECL|variable|framing
r_static
r_char
op_star
id|framing
(braket
)braket
op_assign
(brace
l_string|&quot;Encapsulation&quot;
comma
l_string|&quot;Translation&quot;
)brace
suffix:semicolon
multiline_comment|/*===========================================================================*/
DECL|function|ray_cs_proc_read
r_static
r_int
id|ray_cs_proc_read
c_func
(paren
r_char
op_star
id|buf
comma
r_char
op_star
op_star
id|start
comma
id|off_t
id|offset
comma
r_int
id|len
)paren
(brace
multiline_comment|/* Print current values which are not available via other means&n; * eg ifconfig &n; */
r_int
id|i
suffix:semicolon
id|dev_link_t
op_star
id|link
suffix:semicolon
r_struct
id|net_device
op_star
id|dev
suffix:semicolon
id|ray_dev_t
op_star
id|local
suffix:semicolon
id|UCHAR
op_star
id|p
suffix:semicolon
r_struct
id|freq_hop_element
op_star
id|pfh
suffix:semicolon
id|UCHAR
id|c
(braket
l_int|33
)braket
suffix:semicolon
id|link
op_assign
id|dev_list
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|link
)paren
r_return
l_int|0
suffix:semicolon
id|dev
op_assign
(paren
r_struct
id|net_device
op_star
)paren
id|link-&gt;priv
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dev
)paren
r_return
l_int|0
suffix:semicolon
id|local
op_assign
(paren
id|ray_dev_t
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|local
)paren
r_return
l_int|0
suffix:semicolon
id|len
op_assign
l_int|0
suffix:semicolon
id|len
op_add_assign
id|sprintf
c_func
(paren
id|buf
op_plus
id|len
comma
l_string|&quot;Raylink Wireless LAN driver status&bslash;n&quot;
)paren
suffix:semicolon
id|len
op_add_assign
id|sprintf
c_func
(paren
id|buf
op_plus
id|len
comma
l_string|&quot;%s&bslash;n&quot;
comma
id|rcsid
)paren
suffix:semicolon
multiline_comment|/* build 4 does not report version, and field is 0x55 after memtest */
id|len
op_add_assign
id|sprintf
c_func
(paren
id|buf
op_plus
id|len
comma
l_string|&quot;Firmware version     = &quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|local-&gt;fw_ver
op_eq
l_int|0x55
)paren
id|len
op_add_assign
id|sprintf
c_func
(paren
id|buf
op_plus
id|len
comma
l_string|&quot;4 - Use dump_cis for more details&bslash;n&quot;
)paren
suffix:semicolon
r_else
id|len
op_add_assign
id|sprintf
c_func
(paren
id|buf
op_plus
id|len
comma
l_string|&quot;%2d.%02d.%02d&bslash;n&quot;
comma
id|local-&gt;fw_ver
comma
id|local-&gt;fw_bld
comma
id|local-&gt;fw_var
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|32
suffix:semicolon
id|i
op_increment
)paren
id|c
(braket
id|i
)braket
op_assign
id|local-&gt;sparm.b5.a_current_ess_id
(braket
id|i
)braket
suffix:semicolon
id|c
(braket
l_int|32
)braket
op_assign
l_int|0
suffix:semicolon
id|len
op_add_assign
id|sprintf
c_func
(paren
id|buf
op_plus
id|len
comma
l_string|&quot;%s network ESSID = &bslash;&quot;%s&bslash;&quot;&bslash;n&quot;
comma
id|nettype
(braket
id|local-&gt;sparm.b5.a_network_type
)braket
comma
id|c
)paren
suffix:semicolon
id|p
op_assign
id|local-&gt;bss_id
suffix:semicolon
id|len
op_add_assign
id|sprintf
c_func
(paren
id|buf
op_plus
id|len
comma
l_string|&quot;BSSID                = %02x:%02x:%02x:%02x:%02x:%02x&bslash;n&quot;
comma
id|p
(braket
l_int|0
)braket
comma
id|p
(braket
l_int|1
)braket
comma
id|p
(braket
l_int|2
)braket
comma
id|p
(braket
l_int|3
)braket
comma
id|p
(braket
l_int|4
)braket
comma
id|p
(braket
l_int|5
)braket
)paren
suffix:semicolon
id|len
op_add_assign
id|sprintf
c_func
(paren
id|buf
op_plus
id|len
comma
l_string|&quot;Country code         = %d&bslash;n&quot;
comma
id|local-&gt;sparm.b5.a_curr_country_code
)paren
suffix:semicolon
id|i
op_assign
id|local-&gt;card_status
suffix:semicolon
r_if
c_cond
(paren
id|i
OL
l_int|0
)paren
id|i
op_assign
l_int|10
suffix:semicolon
r_if
c_cond
(paren
id|i
OG
l_int|16
)paren
id|i
op_assign
l_int|10
suffix:semicolon
id|len
op_add_assign
id|sprintf
c_func
(paren
id|buf
op_plus
id|len
comma
l_string|&quot;Card status          = %s&bslash;n&quot;
comma
id|card_status
(braket
id|i
)braket
)paren
suffix:semicolon
id|len
op_add_assign
id|sprintf
c_func
(paren
id|buf
op_plus
id|len
comma
l_string|&quot;Framing mode         = %s&bslash;n&quot;
comma
id|framing
(braket
id|translate
)braket
)paren
suffix:semicolon
id|len
op_add_assign
id|sprintf
c_func
(paren
id|buf
op_plus
id|len
comma
l_string|&quot;Last pkt signal lvl  = %d&bslash;n&quot;
comma
id|local-&gt;last_rsl
)paren
suffix:semicolon
r_if
c_cond
(paren
id|local-&gt;beacon_rxed
)paren
(brace
multiline_comment|/* Pull some fields out of last beacon received */
id|len
op_add_assign
id|sprintf
c_func
(paren
id|buf
op_plus
id|len
comma
l_string|&quot;Beacon Interval      = %d Kus&bslash;n&quot;
comma
id|local-&gt;last_bcn.beacon_intvl
(braket
l_int|0
)braket
op_plus
l_int|256
op_star
id|local-&gt;last_bcn.beacon_intvl
(braket
l_int|1
)braket
)paren
suffix:semicolon
id|p
op_assign
id|local-&gt;last_bcn.elements
suffix:semicolon
r_if
c_cond
(paren
id|p
(braket
l_int|0
)braket
op_eq
id|C_ESSID_ELEMENT_ID
)paren
id|p
op_add_assign
id|p
(braket
l_int|1
)braket
op_plus
l_int|2
suffix:semicolon
r_else
(brace
id|len
op_add_assign
id|sprintf
c_func
(paren
id|buf
op_plus
id|len
comma
l_string|&quot;Parse beacon failed at essid element id = %d&bslash;n&quot;
comma
id|p
(braket
l_int|0
)braket
)paren
suffix:semicolon
r_return
id|len
suffix:semicolon
)brace
r_if
c_cond
(paren
id|p
(braket
l_int|0
)braket
op_eq
id|C_SUPPORTED_RATES_ELEMENT_ID
)paren
(brace
id|len
op_add_assign
id|sprintf
c_func
(paren
id|buf
op_plus
id|len
comma
l_string|&quot;Supported rate codes = &quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|2
suffix:semicolon
id|i
OL
id|p
(braket
l_int|1
)braket
op_plus
l_int|2
suffix:semicolon
id|i
op_increment
)paren
id|len
op_add_assign
id|sprintf
c_func
(paren
id|buf
op_plus
id|len
comma
l_string|&quot;0x%02x &quot;
comma
id|p
(braket
id|i
)braket
)paren
suffix:semicolon
id|len
op_add_assign
id|sprintf
c_func
(paren
id|buf
op_plus
id|len
comma
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
id|p
op_add_assign
id|p
(braket
l_int|1
)braket
op_plus
l_int|2
suffix:semicolon
)brace
r_else
(brace
id|len
op_add_assign
id|sprintf
c_func
(paren
id|buf
op_plus
id|len
comma
l_string|&quot;Parse beacon failed at rates element&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|len
suffix:semicolon
)brace
r_if
c_cond
(paren
id|p
(braket
l_int|0
)braket
op_eq
id|C_FH_PARAM_SET_ELEMENT_ID
)paren
(brace
id|pfh
op_assign
(paren
r_struct
id|freq_hop_element
op_star
)paren
id|p
suffix:semicolon
id|len
op_add_assign
id|sprintf
c_func
(paren
id|buf
op_plus
id|len
comma
l_string|&quot;Hop dwell            = %d Kus&bslash;n&quot;
comma
id|pfh-&gt;dwell_time
(braket
l_int|0
)braket
op_plus
l_int|256
op_star
id|pfh-&gt;dwell_time
(braket
l_int|1
)braket
)paren
suffix:semicolon
id|len
op_add_assign
id|sprintf
c_func
(paren
id|buf
op_plus
id|len
comma
l_string|&quot;Hop set              = %d &bslash;n&quot;
comma
id|pfh-&gt;hop_set
)paren
suffix:semicolon
id|len
op_add_assign
id|sprintf
c_func
(paren
id|buf
op_plus
id|len
comma
l_string|&quot;Hop pattern          = %d &bslash;n&quot;
comma
id|pfh-&gt;hop_pattern
)paren
suffix:semicolon
id|len
op_add_assign
id|sprintf
c_func
(paren
id|buf
op_plus
id|len
comma
l_string|&quot;Hop index            = %d &bslash;n&quot;
comma
id|pfh-&gt;hop_index
)paren
suffix:semicolon
id|p
op_add_assign
id|p
(braket
l_int|1
)braket
op_plus
l_int|2
suffix:semicolon
)brace
r_else
(brace
id|len
op_add_assign
id|sprintf
c_func
(paren
id|buf
op_plus
id|len
comma
l_string|&quot;Parse beacon failed at FH param element&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|len
suffix:semicolon
)brace
)brace
r_else
(brace
id|len
op_add_assign
id|sprintf
c_func
(paren
id|buf
op_plus
id|len
comma
l_string|&quot;No beacons received&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_return
id|len
suffix:semicolon
)brace
macro_line|#endif
multiline_comment|/*===========================================================================*/
DECL|function|build_auth_frame
r_static
r_int
id|build_auth_frame
c_func
(paren
id|ray_dev_t
op_star
id|local
comma
id|UCHAR
op_star
id|dest
comma
r_int
id|auth_type
)paren
(brace
r_int
id|addr
suffix:semicolon
r_struct
id|ccs
op_star
id|pccs
suffix:semicolon
r_struct
id|tx_msg
op_star
id|ptx
suffix:semicolon
r_int
id|ccsindex
suffix:semicolon
multiline_comment|/* If no tx buffers available, return */
r_if
c_cond
(paren
(paren
id|ccsindex
op_assign
id|get_free_tx_ccs
c_func
(paren
id|local
)paren
)paren
OL
l_int|0
)paren
(brace
id|DEBUG
c_func
(paren
l_int|1
comma
l_string|&quot;ray_cs send authenticate - No free tx ccs&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|pccs
op_assign
(paren
(paren
r_struct
id|ccs
op_star
)paren
(paren
id|local-&gt;sram
op_plus
id|CCS_BASE
)paren
)paren
op_plus
id|ccsindex
suffix:semicolon
multiline_comment|/* Address in card space */
id|addr
op_assign
id|TX_BUF_BASE
op_plus
(paren
id|ccsindex
op_lshift
l_int|11
)paren
suffix:semicolon
multiline_comment|/* fill in the CCS */
id|writeb
c_func
(paren
id|CCS_TX_REQUEST
comma
op_amp
id|pccs-&gt;cmd
)paren
suffix:semicolon
id|writeb
c_func
(paren
id|addr
op_rshift
l_int|8
comma
id|pccs-&gt;var.tx_request.tx_data_ptr
)paren
suffix:semicolon
id|writeb
c_func
(paren
l_int|0x20
comma
id|pccs-&gt;var.tx_request.tx_data_ptr
op_plus
l_int|1
)paren
suffix:semicolon
id|writeb
c_func
(paren
id|TX_AUTHENTICATE_LENGTH_MSB
comma
id|pccs-&gt;var.tx_request.tx_data_length
)paren
suffix:semicolon
id|writeb
c_func
(paren
id|TX_AUTHENTICATE_LENGTH_LSB
comma
id|pccs-&gt;var.tx_request.tx_data_length
op_plus
l_int|1
)paren
suffix:semicolon
id|writeb
c_func
(paren
l_int|0
comma
op_amp
id|pccs-&gt;var.tx_request.pow_sav_mode
)paren
suffix:semicolon
id|ptx
op_assign
(paren
r_struct
id|tx_msg
op_star
)paren
(paren
id|local-&gt;sram
op_plus
id|addr
)paren
suffix:semicolon
multiline_comment|/* fill in the mac header */
id|writeb
c_func
(paren
id|PROTOCOL_VER
op_or
id|AUTHENTIC_TYPE
comma
op_amp
id|ptx-&gt;mac.frame_ctl_1
)paren
suffix:semicolon
id|writeb
c_func
(paren
l_int|0
comma
op_amp
id|ptx-&gt;mac.frame_ctl_2
)paren
suffix:semicolon
id|memcpy_toio
c_func
(paren
id|ptx-&gt;mac.addr_1
comma
id|dest
comma
id|ADDRLEN
)paren
suffix:semicolon
id|memcpy_toio
c_func
(paren
id|ptx-&gt;mac.addr_2
comma
id|local-&gt;sparm.b4.a_mac_addr
comma
id|ADDRLEN
)paren
suffix:semicolon
id|memcpy_toio
c_func
(paren
id|ptx-&gt;mac.addr_3
comma
id|local-&gt;bss_id
comma
id|ADDRLEN
)paren
suffix:semicolon
multiline_comment|/* Fill in msg body with protocol 00 00, sequence 01 00 ,status 00 00 */
id|memset_io
c_func
(paren
id|ptx-&gt;var
comma
l_int|0
comma
l_int|6
)paren
suffix:semicolon
id|writeb
c_func
(paren
id|auth_type
op_amp
l_int|0xff
comma
id|ptx-&gt;var
op_plus
l_int|2
)paren
suffix:semicolon
multiline_comment|/* Interrupt the firmware to process the command */
r_if
c_cond
(paren
id|interrupt_ecf
c_func
(paren
id|local
comma
id|ccsindex
)paren
)paren
(brace
id|DEBUG
c_func
(paren
l_int|1
comma
l_string|&quot;ray_cs send authentication request failed - ECF not ready for intr&bslash;n&quot;
)paren
suffix:semicolon
id|writeb
c_func
(paren
id|CCS_BUFFER_FREE
comma
op_amp
(paren
id|pccs
op_increment
)paren
op_member_access_from_pointer
id|buffer_status
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* End build_auth_frame */
multiline_comment|/*===========================================================================*/
macro_line|#ifdef CONFIG_PROC_FS
DECL|function|raycs_write
r_static
r_void
id|raycs_write
c_func
(paren
r_const
r_char
op_star
id|name
comma
id|write_proc_t
op_star
id|w
comma
r_void
op_star
id|data
)paren
(brace
r_struct
id|proc_dir_entry
op_star
id|entry
op_assign
id|create_proc_entry
c_func
(paren
id|name
comma
id|S_IFREG
op_or
id|S_IWUSR
comma
l_int|NULL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|entry
)paren
(brace
id|entry-&gt;write_proc
op_assign
id|w
suffix:semicolon
id|entry-&gt;data
op_assign
id|data
suffix:semicolon
)brace
)brace
DECL|function|write_essid
r_static
r_int
id|write_essid
c_func
(paren
r_struct
id|file
op_star
id|file
comma
r_const
r_char
op_star
id|buffer
comma
r_int
r_int
id|count
comma
r_void
op_star
id|data
)paren
(brace
r_static
r_char
id|proc_essid
(braket
l_int|33
)braket
suffix:semicolon
r_int
id|len
op_assign
id|count
suffix:semicolon
r_if
c_cond
(paren
id|len
OG
l_int|32
)paren
id|len
op_assign
l_int|32
suffix:semicolon
id|memset
c_func
(paren
id|proc_essid
comma
l_int|0
comma
l_int|33
)paren
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
id|proc_essid
comma
id|buffer
comma
id|len
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
id|essid
op_assign
id|proc_essid
suffix:semicolon
r_return
id|count
suffix:semicolon
)brace
DECL|function|write_int
r_static
r_int
id|write_int
c_func
(paren
r_struct
id|file
op_star
id|file
comma
r_const
r_char
op_star
id|buffer
comma
r_int
r_int
id|count
comma
r_void
op_star
id|data
)paren
(brace
r_static
r_char
id|proc_number
(braket
l_int|10
)braket
suffix:semicolon
r_char
op_star
id|p
suffix:semicolon
r_int
id|nr
comma
id|len
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|count
)paren
r_return
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|count
OG
l_int|9
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
id|proc_number
comma
id|buffer
comma
id|count
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
id|p
op_assign
id|proc_number
suffix:semicolon
id|nr
op_assign
l_int|0
suffix:semicolon
id|len
op_assign
id|count
suffix:semicolon
r_do
(brace
r_int
r_int
id|c
op_assign
op_star
id|p
op_minus
l_char|&squot;0&squot;
suffix:semicolon
r_if
c_cond
(paren
id|c
OG
l_int|9
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|nr
op_assign
id|nr
op_star
l_int|10
op_plus
id|c
suffix:semicolon
id|p
op_increment
suffix:semicolon
)brace
r_while
c_loop
(paren
op_decrement
id|len
)paren
suffix:semicolon
op_star
(paren
r_int
op_star
)paren
id|data
op_assign
id|nr
suffix:semicolon
r_return
id|count
suffix:semicolon
)brace
macro_line|#endif
DECL|function|init_ray_cs
r_static
r_int
id|__init
id|init_ray_cs
c_func
(paren
r_void
)paren
(brace
r_int
id|rc
suffix:semicolon
id|DEBUG
c_func
(paren
l_int|1
comma
l_string|&quot;%s&bslash;n&quot;
comma
id|rcsid
)paren
suffix:semicolon
id|rc
op_assign
id|register_pcmcia_driver
c_func
(paren
op_amp
id|dev_info
comma
op_amp
id|ray_attach
comma
op_amp
id|ray_detach
)paren
suffix:semicolon
id|DEBUG
c_func
(paren
l_int|1
comma
l_string|&quot;raylink init_module register_pcmcia_driver returns 0x%x&bslash;n&quot;
comma
id|rc
)paren
suffix:semicolon
macro_line|#ifdef CONFIG_PROC_FS
id|proc_mkdir
c_func
(paren
l_string|&quot;driver/ray_cs&quot;
comma
l_int|0
)paren
suffix:semicolon
id|create_proc_info_entry
c_func
(paren
l_string|&quot;driver/ray_cs/ray_cs&quot;
comma
l_int|0
comma
l_int|NULL
comma
op_amp
id|ray_cs_proc_read
)paren
suffix:semicolon
id|raycs_write
c_func
(paren
l_string|&quot;driver/ray_cs/essid&quot;
comma
id|write_essid
comma
l_int|NULL
)paren
suffix:semicolon
id|raycs_write
c_func
(paren
l_string|&quot;driver/ray_cs/net_type&quot;
comma
id|write_int
comma
op_amp
id|net_type
)paren
suffix:semicolon
id|raycs_write
c_func
(paren
l_string|&quot;driver/ray_cs/translate&quot;
comma
id|write_int
comma
op_amp
id|translate
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|translate
op_ne
l_int|0
)paren
id|translate
op_assign
l_int|1
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* init_ray_cs */
multiline_comment|/*===========================================================================*/
DECL|function|exit_ray_cs
r_static
r_void
id|__exit
id|exit_ray_cs
c_func
(paren
r_void
)paren
(brace
id|DEBUG
c_func
(paren
l_int|0
comma
l_string|&quot;ray_cs: cleanup_module&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#ifdef CONFIG_PROC_FS
id|remove_proc_entry
c_func
(paren
l_string|&quot;ray_cs&quot;
comma
id|proc_root_driver
)paren
suffix:semicolon
macro_line|#endif
id|unregister_pcmcia_driver
c_func
(paren
op_amp
id|dev_info
)paren
suffix:semicolon
r_while
c_loop
(paren
id|dev_list
op_ne
l_int|NULL
)paren
id|ray_detach
c_func
(paren
id|dev_list
)paren
suffix:semicolon
macro_line|#ifdef CONFIG_PROC_FS
id|remove_proc_entry
c_func
(paren
l_string|&quot;driver/ray_cs/ray_cs&quot;
comma
l_int|NULL
)paren
suffix:semicolon
id|remove_proc_entry
c_func
(paren
l_string|&quot;driver/ray_cs/essid&quot;
comma
l_int|NULL
)paren
suffix:semicolon
id|remove_proc_entry
c_func
(paren
l_string|&quot;driver/ray_cs/net_type&quot;
comma
l_int|NULL
)paren
suffix:semicolon
id|remove_proc_entry
c_func
(paren
l_string|&quot;driver/ray_cs/translate&quot;
comma
l_int|NULL
)paren
suffix:semicolon
id|remove_proc_entry
c_func
(paren
l_string|&quot;driver/ray_cs&quot;
comma
l_int|NULL
)paren
suffix:semicolon
macro_line|#endif
)brace
multiline_comment|/* exit_ray_cs */
DECL|variable|init_ray_cs
id|module_init
c_func
(paren
id|init_ray_cs
)paren
suffix:semicolon
DECL|variable|exit_ray_cs
id|module_exit
c_func
(paren
id|exit_ray_cs
)paren
suffix:semicolon
multiline_comment|/*===========================================================================*/
eof
