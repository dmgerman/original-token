multiline_comment|/* 3c574.c: A PCMCIA ethernet driver for the 3com 3c574 &quot;RoadRunner&quot;.&n;&n;&t;Written 1993-1998 by&n;&t;Donald Becker, becker@cesdis.gsfc.nasa.gov, (driver core) and&n;&t;David Hinds, dahinds@users.sourceforge.net (from his PC card code).&n;&n;&t;This software may be used and distributed according to the terms of&n;&t;the GNU Public License, incorporated herein by reference.&n;&n;&t;This driver derives from Donald Becker&squot;s 3c509 core, which has the&n;&t;following copyright:&n;&t;Copyright 1993 United States Government as represented by the&n;&t;Director, National Security Agency.&n;&n;*/
multiline_comment|/* Driver author info must always be in the binary.  Version too.. */
DECL|variable|tc574_version
r_static
r_const
r_char
op_star
id|tc574_version
op_assign
l_string|&quot;3c574_cs.c v1.08 9/24/98 Donald Becker/David Hinds, becker@cesdis.gsfc.nasa.gov.&bslash;n&quot;
suffix:semicolon
multiline_comment|/*&n;&t;&t;&t;&t;Theory of Operation&n;&n;I. Board Compatibility&n;&n;This device driver is designed for the 3Com 3c574 PC card Fast Ethernet&n;Adapter.&n;&n;II. Board-specific settings&n;&n;None -- PC cards are autoconfigured.&n;&n;III. Driver operation&n;&n;The 3c574 uses a Boomerang-style interface, without the bus-master capability.&n;See the Boomerang driver and documentation for most details.&n;&n;IV. Notes and chip documentation.&n;&n;Two added registers are used to enhance PIO performance, RunnerRdCtrl and&n;RunnerWrCtrl.  These are 11 bit down-counters that are preloaded with the&n;count of word (16 bits) reads or writes the driver is about to do to the Rx&n;or Tx FIFO.  The chip is then able to hide the internal-PCI-bus to PC-card&n;translation latency by buffering the I/O operations with an 8 word FIFO.&n;Note: No other chip accesses are permitted when this buffer is used.&n;&n;A second enhancement is that both attribute and common memory space&n;0x0800-0x0fff can translated to the PIO FIFO.  Thus memory operations (faster&n;with *some* PCcard bridges) may be used instead of I/O operations.&n;This is enabled by setting the 0x10 bit in the PCMCIA LAN COR.&n;&n;Some slow PC card bridges work better if they never see a WAIT signal.&n;This is configured by setting the 0x20 bit in the PCMCIA LAN COR.&n;Only do this after testing that it is reliable and improves performance.&n;&n;The upper five bits of RunnerRdCtrl are used to window into PCcard&n;configuration space registers.  Window 0 is the regular Boomerang/Odie&n;register set, 1-5 are various PC card control registers, and 16-31 are&n;the (reversed!) CIS table.&n;&n;A final note: writing the InternalConfig register in window 3 with an&n;invalid ramWidth is Very Bad.&n;&n;V. References&n;&n;http://cesdis.gsfc.nasa.gov/linux/misc/NWay.html&n;http://www.national.com/pf/DP/DP83840.html&n;&n;Thanks to Terry Murphy of 3Com for providing development information for&n;earlier 3Com products.&n;&n;*/
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/malloc.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/timer.h&gt;
macro_line|#include &lt;linux/interrupt.h&gt;
macro_line|#include &lt;linux/in.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/system.h&gt;
macro_line|#include &lt;asm/bitops.h&gt;
macro_line|#include &lt;linux/netdevice.h&gt;
macro_line|#include &lt;linux/etherdevice.h&gt;
macro_line|#include &lt;linux/skbuff.h&gt;
macro_line|#include &lt;linux/if_arp.h&gt;
macro_line|#include &lt;linux/ioport.h&gt;
macro_line|#include &lt;pcmcia/version.h&gt;
macro_line|#include &lt;pcmcia/cs_types.h&gt;
macro_line|#include &lt;pcmcia/cs.h&gt;
macro_line|#include &lt;pcmcia/cistpl.h&gt;
macro_line|#include &lt;pcmcia/cisreg.h&gt;
macro_line|#include &lt;pcmcia/ciscode.h&gt;
macro_line|#include &lt;pcmcia/ds.h&gt;
macro_line|#include &lt;pcmcia/mem_op.h&gt;
multiline_comment|/* A few values that may be tweaked. */
id|MODULE_PARM
c_func
(paren
id|irq_mask
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|irq_list
comma
l_string|&quot;1-4i&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|max_interrupt_work
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|full_duplex
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
multiline_comment|/* Now-standard PC card module parameters. */
DECL|variable|irq_mask
r_static
id|u_int
id|irq_mask
op_assign
l_int|0xdeb8
suffix:semicolon
multiline_comment|/* IRQ3,4,5,7,9,10,11,12,14,15 */
DECL|variable|irq_list
r_static
r_int
id|irq_list
(braket
l_int|4
)braket
op_assign
(brace
op_minus
l_int|1
)brace
suffix:semicolon
multiline_comment|/* Time in jiffies before concluding the transmitter is hung. */
DECL|macro|TX_TIMEOUT
mdefine_line|#define TX_TIMEOUT  ((800*HZ)/1000)
multiline_comment|/* Maximum events (Rx packets, etc.) to handle at each interrupt. */
DECL|variable|max_interrupt_work
r_static
r_int
id|max_interrupt_work
op_assign
l_int|32
suffix:semicolon
multiline_comment|/* Force full duplex modes? */
DECL|variable|full_duplex
r_static
r_int
id|full_duplex
suffix:semicolon
multiline_comment|/* To minimize the size of the driver source and make the driver more&n;   readable not all constants are symbolically defined.&n;   You&squot;ll need the manual if you want to understand driver details anyway. */
multiline_comment|/* Offsets from base I/O address. */
DECL|macro|EL3_DATA
mdefine_line|#define EL3_DATA&t;0x00
DECL|macro|EL3_CMD
mdefine_line|#define EL3_CMD&t;&t;0x0e
DECL|macro|EL3_STATUS
mdefine_line|#define EL3_STATUS&t;0x0e
DECL|macro|EL3WINDOW
mdefine_line|#define EL3WINDOW(win_num) outw(SelectWindow + (win_num), ioaddr + EL3_CMD)
multiline_comment|/* The top five bits written to EL3_CMD are a command, the lower&n;   11 bits are the parameter, if applicable. */
DECL|enum|el3_cmds
r_enum
id|el3_cmds
(brace
DECL|enumerator|TotalReset
DECL|enumerator|SelectWindow
DECL|enumerator|StartCoax
id|TotalReset
op_assign
l_int|0
op_lshift
l_int|11
comma
id|SelectWindow
op_assign
l_int|1
op_lshift
l_int|11
comma
id|StartCoax
op_assign
l_int|2
op_lshift
l_int|11
comma
DECL|enumerator|RxDisable
DECL|enumerator|RxEnable
DECL|enumerator|RxReset
DECL|enumerator|RxDiscard
id|RxDisable
op_assign
l_int|3
op_lshift
l_int|11
comma
id|RxEnable
op_assign
l_int|4
op_lshift
l_int|11
comma
id|RxReset
op_assign
l_int|5
op_lshift
l_int|11
comma
id|RxDiscard
op_assign
l_int|8
op_lshift
l_int|11
comma
DECL|enumerator|TxEnable
DECL|enumerator|TxDisable
DECL|enumerator|TxReset
id|TxEnable
op_assign
l_int|9
op_lshift
l_int|11
comma
id|TxDisable
op_assign
l_int|10
op_lshift
l_int|11
comma
id|TxReset
op_assign
l_int|11
op_lshift
l_int|11
comma
DECL|enumerator|FakeIntr
DECL|enumerator|AckIntr
DECL|enumerator|SetIntrEnb
id|FakeIntr
op_assign
l_int|12
op_lshift
l_int|11
comma
id|AckIntr
op_assign
l_int|13
op_lshift
l_int|11
comma
id|SetIntrEnb
op_assign
l_int|14
op_lshift
l_int|11
comma
DECL|enumerator|SetStatusEnb
DECL|enumerator|SetRxFilter
DECL|enumerator|SetRxThreshold
id|SetStatusEnb
op_assign
l_int|15
op_lshift
l_int|11
comma
id|SetRxFilter
op_assign
l_int|16
op_lshift
l_int|11
comma
id|SetRxThreshold
op_assign
l_int|17
op_lshift
l_int|11
comma
DECL|enumerator|SetTxThreshold
DECL|enumerator|SetTxStart
DECL|enumerator|StatsEnable
id|SetTxThreshold
op_assign
l_int|18
op_lshift
l_int|11
comma
id|SetTxStart
op_assign
l_int|19
op_lshift
l_int|11
comma
id|StatsEnable
op_assign
l_int|21
op_lshift
l_int|11
comma
DECL|enumerator|StatsDisable
DECL|enumerator|StopCoax
id|StatsDisable
op_assign
l_int|22
op_lshift
l_int|11
comma
id|StopCoax
op_assign
l_int|23
op_lshift
l_int|11
comma
)brace
suffix:semicolon
DECL|enum|elxl_status
r_enum
id|elxl_status
(brace
DECL|enumerator|IntLatch
DECL|enumerator|AdapterFailure
DECL|enumerator|TxComplete
id|IntLatch
op_assign
l_int|0x0001
comma
id|AdapterFailure
op_assign
l_int|0x0002
comma
id|TxComplete
op_assign
l_int|0x0004
comma
DECL|enumerator|TxAvailable
DECL|enumerator|RxComplete
DECL|enumerator|RxEarly
id|TxAvailable
op_assign
l_int|0x0008
comma
id|RxComplete
op_assign
l_int|0x0010
comma
id|RxEarly
op_assign
l_int|0x0020
comma
DECL|enumerator|IntReq
DECL|enumerator|StatsFull
DECL|enumerator|CmdBusy
id|IntReq
op_assign
l_int|0x0040
comma
id|StatsFull
op_assign
l_int|0x0080
comma
id|CmdBusy
op_assign
l_int|0x1000
)brace
suffix:semicolon
multiline_comment|/* The SetRxFilter command accepts the following classes: */
DECL|enum|RxFilter
r_enum
id|RxFilter
(brace
DECL|enumerator|RxStation
DECL|enumerator|RxMulticast
DECL|enumerator|RxBroadcast
DECL|enumerator|RxProm
id|RxStation
op_assign
l_int|1
comma
id|RxMulticast
op_assign
l_int|2
comma
id|RxBroadcast
op_assign
l_int|4
comma
id|RxProm
op_assign
l_int|8
)brace
suffix:semicolon
DECL|enum|Window0
r_enum
id|Window0
(brace
DECL|enumerator|Wn0EepromCmd
DECL|enumerator|Wn0EepromData
id|Wn0EepromCmd
op_assign
l_int|10
comma
id|Wn0EepromData
op_assign
l_int|12
comma
multiline_comment|/* EEPROM command/address, data. */
DECL|enumerator|IntrStatus
id|IntrStatus
op_assign
l_int|0x0E
comma
multiline_comment|/* Valid in all windows. */
)brace
suffix:semicolon
multiline_comment|/* These assumes the larger EEPROM. */
DECL|enum|Win0_EEPROM_cmds
r_enum
id|Win0_EEPROM_cmds
(brace
DECL|enumerator|EEPROM_Read
DECL|enumerator|EEPROM_WRITE
DECL|enumerator|EEPROM_ERASE
id|EEPROM_Read
op_assign
l_int|0x200
comma
id|EEPROM_WRITE
op_assign
l_int|0x100
comma
id|EEPROM_ERASE
op_assign
l_int|0x300
comma
DECL|enumerator|EEPROM_EWENB
id|EEPROM_EWENB
op_assign
l_int|0x30
comma
multiline_comment|/* Enable erasing/writing for 10 msec. */
DECL|enumerator|EEPROM_EWDIS
id|EEPROM_EWDIS
op_assign
l_int|0x00
comma
multiline_comment|/* Disable EWENB before 10 msec timeout. */
)brace
suffix:semicolon
multiline_comment|/* Register window 1 offsets, the window used in normal operation.&n;   On the &quot;Odie&quot; this window is always mapped at offsets 0x10-0x1f.&n;   Except for TxFree, which is overlapped by RunnerWrCtrl. */
DECL|enum|Window1
r_enum
id|Window1
(brace
DECL|enumerator|TX_FIFO
DECL|enumerator|RX_FIFO
DECL|enumerator|RxErrors
id|TX_FIFO
op_assign
l_int|0x10
comma
id|RX_FIFO
op_assign
l_int|0x10
comma
id|RxErrors
op_assign
l_int|0x14
comma
DECL|enumerator|RxStatus
DECL|enumerator|Timer
DECL|enumerator|TxStatus
id|RxStatus
op_assign
l_int|0x18
comma
id|Timer
op_assign
l_int|0x1A
comma
id|TxStatus
op_assign
l_int|0x1B
comma
DECL|enumerator|TxFree
id|TxFree
op_assign
l_int|0x0C
comma
multiline_comment|/* Remaining free bytes in Tx buffer. */
DECL|enumerator|RunnerRdCtrl
DECL|enumerator|RunnerWrCtrl
id|RunnerRdCtrl
op_assign
l_int|0x16
comma
id|RunnerWrCtrl
op_assign
l_int|0x1c
comma
)brace
suffix:semicolon
DECL|enum|Window3
r_enum
id|Window3
(brace
multiline_comment|/* Window 3: MAC/config bits. */
DECL|enumerator|Wn3_Config
DECL|enumerator|Wn3_MAC_Ctrl
DECL|enumerator|Wn3_Options
id|Wn3_Config
op_assign
l_int|0
comma
id|Wn3_MAC_Ctrl
op_assign
l_int|6
comma
id|Wn3_Options
op_assign
l_int|8
comma
)brace
suffix:semicolon
DECL|union|wn3_config
r_union
id|wn3_config
(brace
DECL|member|i
r_int
id|i
suffix:semicolon
DECL|struct|w3_config_fields
r_struct
id|w3_config_fields
(brace
DECL|member|ram_size
DECL|member|ram_width
DECL|member|ram_speed
DECL|member|rom_size
r_int
r_int
id|ram_size
suffix:colon
l_int|3
comma
id|ram_width
suffix:colon
l_int|1
comma
id|ram_speed
suffix:colon
l_int|2
comma
id|rom_size
suffix:colon
l_int|2
suffix:semicolon
DECL|member|pad8
r_int
id|pad8
suffix:colon
l_int|8
suffix:semicolon
DECL|member|ram_split
DECL|member|pad18
DECL|member|xcvr
DECL|member|pad21
DECL|member|autoselect
r_int
r_int
id|ram_split
suffix:colon
l_int|2
comma
id|pad18
suffix:colon
l_int|2
comma
id|xcvr
suffix:colon
l_int|3
comma
id|pad21
suffix:colon
l_int|1
comma
id|autoselect
suffix:colon
l_int|1
suffix:semicolon
DECL|member|pad24
r_int
id|pad24
suffix:colon
l_int|7
suffix:semicolon
DECL|member|u
)brace
id|u
suffix:semicolon
)brace
suffix:semicolon
DECL|enum|Window4
r_enum
id|Window4
(brace
multiline_comment|/* Window 4: Xcvr/media bits. */
DECL|enumerator|Wn4_FIFODiag
DECL|enumerator|Wn4_NetDiag
DECL|enumerator|Wn4_PhysicalMgmt
DECL|enumerator|Wn4_Media
id|Wn4_FIFODiag
op_assign
l_int|4
comma
id|Wn4_NetDiag
op_assign
l_int|6
comma
id|Wn4_PhysicalMgmt
op_assign
l_int|8
comma
id|Wn4_Media
op_assign
l_int|10
comma
)brace
suffix:semicolon
DECL|macro|MEDIA_TP
mdefine_line|#define MEDIA_TP&t;0x00C0&t;/* Enable link beat and jabber for 10baseT. */
DECL|struct|el3_private
r_struct
id|el3_private
(brace
DECL|member|link
id|dev_link_t
id|link
suffix:semicolon
DECL|member|dev
r_struct
id|net_device
id|dev
suffix:semicolon
DECL|member|node
id|dev_node_t
id|node
suffix:semicolon
DECL|member|stats
r_struct
id|net_device_stats
id|stats
suffix:semicolon
DECL|member|advertising
DECL|member|partner
id|u16
id|advertising
comma
id|partner
suffix:semicolon
multiline_comment|/* NWay media advertisement */
DECL|member|phys
r_int
r_char
id|phys
(braket
l_int|2
)braket
suffix:semicolon
multiline_comment|/* MII device addresses. */
r_int
r_int
DECL|member|autoselect
DECL|member|default_media
id|autoselect
suffix:colon
l_int|1
comma
id|default_media
suffix:colon
l_int|3
suffix:semicolon
multiline_comment|/* Read from the EEPROM/Wn3_Config. */
multiline_comment|/* for transceiver monitoring */
DECL|member|media
r_struct
id|timer_list
id|media
suffix:semicolon
DECL|member|media_status
id|u_short
id|media_status
suffix:semicolon
DECL|member|fast_poll
id|u_short
id|fast_poll
suffix:semicolon
DECL|member|last_irq
id|u_long
id|last_irq
suffix:semicolon
)brace
suffix:semicolon
multiline_comment|/* Set iff a MII transceiver on any interface requires mdio preamble.&n;   This only set with the original DP83840 on older 3c905 boards, so the extra&n;   code size of a per-interface flag is not worthwhile. */
DECL|variable|mii_preamble_required
r_static
r_char
id|mii_preamble_required
op_assign
l_int|0
suffix:semicolon
macro_line|#ifdef PCMCIA_DEBUG
DECL|variable|pc_debug
r_static
r_int
id|pc_debug
op_assign
id|PCMCIA_DEBUG
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|pc_debug
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
DECL|macro|DEBUG
mdefine_line|#define DEBUG(n, args...) if (pc_debug&gt;(n)) printk(KERN_DEBUG args)
DECL|variable|version
r_static
r_char
op_star
id|version
op_assign
l_string|&quot;3c574_cs.c 1.000 1998/1/8 Donald Becker, becker@cesdis.gsfc.nasa.gov.&bslash;n&quot;
suffix:semicolon
macro_line|#else
DECL|macro|DEBUG
mdefine_line|#define DEBUG(n, args...)
macro_line|#endif
multiline_comment|/* Index of functions. */
r_static
r_void
id|tc574_config
c_func
(paren
id|dev_link_t
op_star
id|link
)paren
suffix:semicolon
r_static
r_void
id|tc574_release
c_func
(paren
id|u_long
id|arg
)paren
suffix:semicolon
r_static
r_int
id|tc574_event
c_func
(paren
id|event_t
id|event
comma
r_int
id|priority
comma
id|event_callback_args_t
op_star
id|args
)paren
suffix:semicolon
r_static
r_void
id|mdio_sync
c_func
(paren
id|ioaddr_t
id|ioaddr
comma
r_int
id|bits
)paren
suffix:semicolon
r_static
r_int
id|mdio_read
c_func
(paren
id|ioaddr_t
id|ioaddr
comma
r_int
id|phy_id
comma
r_int
id|location
)paren
suffix:semicolon
r_static
r_void
id|mdio_write
c_func
(paren
id|ioaddr_t
id|ioaddr
comma
r_int
id|phy_id
comma
r_int
id|location
comma
r_int
id|value
)paren
suffix:semicolon
r_static
id|u_short
id|read_eeprom
c_func
(paren
id|ioaddr_t
id|ioaddr
comma
r_int
id|index
)paren
suffix:semicolon
r_static
r_void
id|wait_for_completion
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_int
id|cmd
)paren
suffix:semicolon
r_static
r_void
id|tc574_reset
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_void
id|media_check
c_func
(paren
id|u_long
id|arg
)paren
suffix:semicolon
r_static
r_int
id|el3_open
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_int
id|el3_start_xmit
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_void
id|el3_interrupt
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
suffix:semicolon
r_static
r_void
id|update_stats
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_struct
id|net_device_stats
op_star
id|el3_get_stats
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_int
id|el3_rx
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_int
id|worklimit
)paren
suffix:semicolon
r_static
r_int
id|el3_close
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_void
id|el3_tx_timeout
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_int
id|el3_ioctl
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_struct
id|ifreq
op_star
id|rq
comma
r_int
id|cmd
)paren
suffix:semicolon
r_static
r_void
id|set_rx_mode
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
DECL|variable|dev_info
r_static
id|dev_info_t
id|dev_info
op_assign
l_string|&quot;3c574_cs&quot;
suffix:semicolon
r_static
id|dev_link_t
op_star
id|tc574_attach
c_func
(paren
r_void
)paren
suffix:semicolon
r_static
r_void
id|tc574_detach
c_func
(paren
id|dev_link_t
op_star
)paren
suffix:semicolon
DECL|variable|dev_list
r_static
id|dev_link_t
op_star
id|dev_list
op_assign
l_int|NULL
suffix:semicolon
DECL|function|flush_stale_links
r_static
r_void
id|flush_stale_links
c_func
(paren
r_void
)paren
(brace
id|dev_link_t
op_star
id|link
comma
op_star
id|next
suffix:semicolon
r_for
c_loop
(paren
id|link
op_assign
id|dev_list
suffix:semicolon
id|link
suffix:semicolon
id|link
op_assign
id|next
)paren
(brace
id|next
op_assign
id|link-&gt;next
suffix:semicolon
r_if
c_cond
(paren
id|link-&gt;state
op_amp
id|DEV_STALE_LINK
)paren
id|tc574_detach
c_func
(paren
id|link
)paren
suffix:semicolon
)brace
)brace
DECL|function|cs_error
r_static
r_void
id|cs_error
c_func
(paren
id|client_handle_t
id|handle
comma
r_int
id|func
comma
r_int
id|ret
)paren
(brace
macro_line|#if CS_RELEASE_CODE &lt; 0x2911
id|CardServices
c_func
(paren
id|ReportError
comma
id|dev_info
comma
(paren
r_void
op_star
)paren
id|func
comma
(paren
r_void
op_star
)paren
id|ret
)paren
suffix:semicolon
macro_line|#else
id|error_info_t
id|err
op_assign
(brace
id|func
comma
id|ret
)brace
suffix:semicolon
id|CardServices
c_func
(paren
id|ReportError
comma
id|handle
comma
op_amp
id|err
)paren
suffix:semicolon
macro_line|#endif
)brace
multiline_comment|/*&n;&t;tc574_attach() creates an &quot;instance&quot; of the driver, allocating&n;&t;local data structures for one device.  The device is registered&n;&t;with Card Services.&n;*/
DECL|function|tc574_attach
r_static
id|dev_link_t
op_star
id|tc574_attach
c_func
(paren
r_void
)paren
(brace
r_struct
id|el3_private
op_star
id|lp
suffix:semicolon
id|client_reg_t
id|client_reg
suffix:semicolon
id|dev_link_t
op_star
id|link
suffix:semicolon
r_struct
id|net_device
op_star
id|dev
suffix:semicolon
r_int
id|i
comma
id|ret
suffix:semicolon
id|DEBUG
c_func
(paren
l_int|0
comma
l_string|&quot;3c574_attach()&bslash;n&quot;
)paren
suffix:semicolon
id|flush_stale_links
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* Create the PC card device object. */
id|lp
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
op_star
id|lp
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|lp
)paren
r_return
l_int|NULL
suffix:semicolon
id|memset
c_func
(paren
id|lp
comma
l_int|0
comma
r_sizeof
(paren
op_star
id|lp
)paren
)paren
suffix:semicolon
id|link
op_assign
op_amp
id|lp-&gt;link
suffix:semicolon
id|dev
op_assign
op_amp
id|lp-&gt;dev
suffix:semicolon
id|link-&gt;priv
op_assign
id|dev-&gt;priv
op_assign
id|link-&gt;irq.Instance
op_assign
id|lp
suffix:semicolon
id|link-&gt;release.function
op_assign
op_amp
id|tc574_release
suffix:semicolon
id|link-&gt;release.data
op_assign
(paren
id|u_long
)paren
id|link
suffix:semicolon
id|link-&gt;io.NumPorts1
op_assign
l_int|32
suffix:semicolon
id|link-&gt;io.Attributes1
op_assign
id|IO_DATA_PATH_WIDTH_16
suffix:semicolon
id|link-&gt;irq.Attributes
op_assign
id|IRQ_TYPE_EXCLUSIVE
op_or
id|IRQ_HANDLE_PRESENT
suffix:semicolon
id|link-&gt;irq.IRQInfo1
op_assign
id|IRQ_INFO2_VALID
op_or
id|IRQ_LEVEL_ID
suffix:semicolon
r_if
c_cond
(paren
id|irq_list
(braket
l_int|0
)braket
op_eq
op_minus
l_int|1
)paren
id|link-&gt;irq.IRQInfo2
op_assign
id|irq_mask
suffix:semicolon
r_else
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|4
suffix:semicolon
id|i
op_increment
)paren
id|link-&gt;irq.IRQInfo2
op_or_assign
l_int|1
op_lshift
id|irq_list
(braket
id|i
)braket
suffix:semicolon
id|link-&gt;irq.Handler
op_assign
op_amp
id|el3_interrupt
suffix:semicolon
id|link-&gt;conf.Attributes
op_assign
id|CONF_ENABLE_IRQ
suffix:semicolon
id|link-&gt;conf.Vcc
op_assign
l_int|50
suffix:semicolon
id|link-&gt;conf.IntType
op_assign
id|INT_MEMORY_AND_IO
suffix:semicolon
id|link-&gt;conf.ConfigIndex
op_assign
l_int|1
suffix:semicolon
id|link-&gt;conf.Present
op_assign
id|PRESENT_OPTION
suffix:semicolon
multiline_comment|/* The EL3-specific entries in the device structure. */
id|dev-&gt;hard_start_xmit
op_assign
op_amp
id|el3_start_xmit
suffix:semicolon
id|dev-&gt;get_stats
op_assign
op_amp
id|el3_get_stats
suffix:semicolon
id|dev-&gt;do_ioctl
op_assign
op_amp
id|el3_ioctl
suffix:semicolon
id|dev-&gt;set_multicast_list
op_assign
op_amp
id|set_rx_mode
suffix:semicolon
id|ether_setup
c_func
(paren
id|dev
)paren
suffix:semicolon
id|dev-&gt;open
op_assign
op_amp
id|el3_open
suffix:semicolon
id|dev-&gt;stop
op_assign
op_amp
id|el3_close
suffix:semicolon
id|dev-&gt;tx_timeout
op_assign
id|el3_tx_timeout
suffix:semicolon
id|dev-&gt;watchdog_timeo
op_assign
id|TX_TIMEOUT
suffix:semicolon
multiline_comment|/* Register with Card Services */
id|link-&gt;next
op_assign
id|dev_list
suffix:semicolon
id|dev_list
op_assign
id|link
suffix:semicolon
id|client_reg.dev_info
op_assign
op_amp
id|dev_info
suffix:semicolon
id|client_reg.Attributes
op_assign
id|INFO_IO_CLIENT
op_or
id|INFO_CARD_SHARE
suffix:semicolon
id|client_reg.EventMask
op_assign
id|CS_EVENT_CARD_INSERTION
op_or
id|CS_EVENT_CARD_REMOVAL
op_or
id|CS_EVENT_RESET_PHYSICAL
op_or
id|CS_EVENT_CARD_RESET
op_or
id|CS_EVENT_PM_SUSPEND
op_or
id|CS_EVENT_PM_RESUME
suffix:semicolon
id|client_reg.event_handler
op_assign
op_amp
id|tc574_event
suffix:semicolon
id|client_reg.Version
op_assign
l_int|0x0210
suffix:semicolon
id|client_reg.event_callback_args.client_data
op_assign
id|link
suffix:semicolon
id|ret
op_assign
id|CardServices
c_func
(paren
id|RegisterClient
comma
op_amp
id|link-&gt;handle
comma
op_amp
id|client_reg
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
op_ne
l_int|0
)paren
(brace
id|cs_error
c_func
(paren
id|link-&gt;handle
comma
id|RegisterClient
comma
id|ret
)paren
suffix:semicolon
id|tc574_detach
c_func
(paren
id|link
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
r_return
id|link
suffix:semicolon
)brace
multiline_comment|/* tc574_attach */
multiline_comment|/*&n;&n;&t;This deletes a driver &quot;instance&quot;.  The device is de-registered&n;&t;with Card Services.  If it has been released, all local data&n;&t;structures are freed.  Otherwise, the structures will be freed&n;&t;when the device is released.&n;&n;*/
DECL|function|tc574_detach
r_static
r_void
id|tc574_detach
c_func
(paren
id|dev_link_t
op_star
id|link
)paren
(brace
r_struct
id|el3_private
op_star
id|lp
op_assign
id|link-&gt;priv
suffix:semicolon
id|dev_link_t
op_star
op_star
id|linkp
suffix:semicolon
id|DEBUG
c_func
(paren
l_int|0
comma
l_string|&quot;3c574_detach(0x%p)&bslash;n&quot;
comma
id|link
)paren
suffix:semicolon
multiline_comment|/* Locate device structure */
r_for
c_loop
(paren
id|linkp
op_assign
op_amp
id|dev_list
suffix:semicolon
op_star
id|linkp
suffix:semicolon
id|linkp
op_assign
op_amp
(paren
op_star
id|linkp
)paren
op_member_access_from_pointer
id|next
)paren
r_if
c_cond
(paren
op_star
id|linkp
op_eq
id|link
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
op_star
id|linkp
op_eq
l_int|NULL
)paren
r_return
suffix:semicolon
id|del_timer
c_func
(paren
op_amp
id|link-&gt;release
)paren
suffix:semicolon
r_if
c_cond
(paren
id|link-&gt;state
op_amp
id|DEV_CONFIG
)paren
(brace
id|tc574_release
c_func
(paren
(paren
id|u_long
)paren
id|link
)paren
suffix:semicolon
r_if
c_cond
(paren
id|link-&gt;state
op_amp
id|DEV_STALE_CONFIG
)paren
(brace
id|link-&gt;state
op_or_assign
id|DEV_STALE_LINK
suffix:semicolon
r_return
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|link-&gt;handle
)paren
id|CardServices
c_func
(paren
id|DeregisterClient
comma
id|link-&gt;handle
)paren
suffix:semicolon
multiline_comment|/* Unlink device structure, free bits */
op_star
id|linkp
op_assign
id|link-&gt;next
suffix:semicolon
r_if
c_cond
(paren
id|link-&gt;dev
)paren
id|unregister_netdev
c_func
(paren
op_amp
id|lp-&gt;dev
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|lp
)paren
suffix:semicolon
)brace
multiline_comment|/* tc574_detach */
multiline_comment|/*&n;&t;tc574_config() is scheduled to run after a CARD_INSERTION event&n;&t;is received, to configure the PCMCIA socket, and to make the&n;&t;ethernet device available to the system.&n;*/
DECL|macro|CS_CHECK
mdefine_line|#define CS_CHECK(fn, args...) &bslash;&n;while ((last_ret=CardServices(last_fn=(fn), args))!=0) goto cs_failed
DECL|function|tc574_config
r_static
r_void
id|tc574_config
c_func
(paren
id|dev_link_t
op_star
id|link
)paren
(brace
id|client_handle_t
id|handle
op_assign
id|link-&gt;handle
suffix:semicolon
r_struct
id|el3_private
op_star
id|lp
op_assign
id|link-&gt;priv
suffix:semicolon
r_struct
id|net_device
op_star
id|dev
op_assign
op_amp
id|lp-&gt;dev
suffix:semicolon
id|tuple_t
id|tuple
suffix:semicolon
id|cisparse_t
id|parse
suffix:semicolon
id|u_short
id|buf
(braket
l_int|32
)braket
suffix:semicolon
r_int
id|last_fn
comma
id|last_ret
comma
id|i
comma
id|j
suffix:semicolon
id|ioaddr_t
id|ioaddr
suffix:semicolon
id|u16
op_star
id|phys_addr
suffix:semicolon
r_char
op_star
id|cardname
suffix:semicolon
id|phys_addr
op_assign
(paren
id|u16
op_star
)paren
id|dev-&gt;dev_addr
suffix:semicolon
id|DEBUG
c_func
(paren
l_int|0
comma
l_string|&quot;3c574_config(0x%p)&bslash;n&quot;
comma
id|link
)paren
suffix:semicolon
id|tuple.Attributes
op_assign
l_int|0
suffix:semicolon
id|tuple.DesiredTuple
op_assign
id|CISTPL_CONFIG
suffix:semicolon
id|CS_CHECK
c_func
(paren
id|GetFirstTuple
comma
id|handle
comma
op_amp
id|tuple
)paren
suffix:semicolon
id|tuple.TupleData
op_assign
(paren
id|cisdata_t
op_star
)paren
id|buf
suffix:semicolon
id|tuple.TupleDataMax
op_assign
l_int|64
suffix:semicolon
id|tuple.TupleOffset
op_assign
l_int|0
suffix:semicolon
id|CS_CHECK
c_func
(paren
id|GetTupleData
comma
id|handle
comma
op_amp
id|tuple
)paren
suffix:semicolon
id|CS_CHECK
c_func
(paren
id|ParseTuple
comma
id|handle
comma
op_amp
id|tuple
comma
op_amp
id|parse
)paren
suffix:semicolon
id|link-&gt;conf.ConfigBase
op_assign
id|parse.config.base
suffix:semicolon
id|link-&gt;conf.Present
op_assign
id|parse.config.rmask
(braket
l_int|0
)braket
suffix:semicolon
multiline_comment|/* Configure card */
id|link-&gt;state
op_or_assign
id|DEV_CONFIG
suffix:semicolon
id|link-&gt;io.IOAddrLines
op_assign
l_int|16
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
id|j
op_assign
l_int|0
suffix:semicolon
id|j
OL
l_int|0x400
suffix:semicolon
id|j
op_add_assign
l_int|0x20
)paren
(brace
id|link-&gt;io.BasePort1
op_assign
id|j
op_xor
l_int|0x300
suffix:semicolon
id|i
op_assign
id|CardServices
c_func
(paren
id|RequestIO
comma
id|link-&gt;handle
comma
op_amp
id|link-&gt;io
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
op_eq
id|CS_SUCCESS
)paren
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|i
op_ne
id|CS_SUCCESS
)paren
(brace
id|cs_error
c_func
(paren
id|link-&gt;handle
comma
id|RequestIO
comma
id|i
)paren
suffix:semicolon
r_goto
id|failed
suffix:semicolon
)brace
id|CS_CHECK
c_func
(paren
id|RequestIRQ
comma
id|link-&gt;handle
comma
op_amp
id|link-&gt;irq
)paren
suffix:semicolon
id|CS_CHECK
c_func
(paren
id|RequestConfiguration
comma
id|link-&gt;handle
comma
op_amp
id|link-&gt;conf
)paren
suffix:semicolon
id|dev-&gt;irq
op_assign
id|link-&gt;irq.AssignedIRQ
suffix:semicolon
id|dev-&gt;base_addr
op_assign
id|link-&gt;io.BasePort1
suffix:semicolon
r_if
c_cond
(paren
id|register_netdev
c_func
(paren
id|dev
)paren
op_ne
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;3c574_cs: register_netdev() failed&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|failed
suffix:semicolon
)brace
id|ioaddr
op_assign
id|dev-&gt;base_addr
suffix:semicolon
id|strcpy
c_func
(paren
id|lp-&gt;node.dev_name
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|link-&gt;dev
op_assign
op_amp
id|lp-&gt;node
suffix:semicolon
id|link-&gt;state
op_and_assign
op_complement
id|DEV_CONFIG_PENDING
suffix:semicolon
multiline_comment|/* The 3c574 normally uses an EEPROM for configuration info, including&n;&t;   the hardware address.  The future products may include a modem chip&n;&t;   and put the address in the CIS. */
id|tuple.DesiredTuple
op_assign
l_int|0x88
suffix:semicolon
r_if
c_cond
(paren
id|CardServices
c_func
(paren
id|GetFirstTuple
comma
id|handle
comma
op_amp
id|tuple
)paren
op_eq
id|CS_SUCCESS
)paren
(brace
id|CardServices
c_func
(paren
id|GetTupleData
comma
id|handle
comma
op_amp
id|tuple
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|3
suffix:semicolon
id|i
op_increment
)paren
id|phys_addr
(braket
id|i
)braket
op_assign
id|htons
c_func
(paren
id|buf
(braket
id|i
)braket
)paren
suffix:semicolon
)brace
r_else
(brace
id|EL3WINDOW
c_func
(paren
l_int|0
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|3
suffix:semicolon
id|i
op_increment
)paren
id|phys_addr
(braket
id|i
)braket
op_assign
id|htons
c_func
(paren
id|read_eeprom
c_func
(paren
id|ioaddr
comma
id|i
op_plus
l_int|10
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|phys_addr
(braket
l_int|0
)braket
op_eq
l_int|0x6060
)paren
(brace
id|printk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;3c574_cs: IO port conflict at 0x%03lx&quot;
l_string|&quot;-0x%03lx&bslash;n&quot;
comma
id|dev-&gt;base_addr
comma
id|dev-&gt;base_addr
op_plus
l_int|15
)paren
suffix:semicolon
r_goto
id|failed
suffix:semicolon
)brace
)brace
id|tuple.DesiredTuple
op_assign
id|CISTPL_VERS_1
suffix:semicolon
r_if
c_cond
(paren
id|CardServices
c_func
(paren
id|GetFirstTuple
comma
id|handle
comma
op_amp
id|tuple
)paren
op_eq
id|CS_SUCCESS
op_logical_and
id|CardServices
c_func
(paren
id|GetTupleData
comma
id|handle
comma
op_amp
id|tuple
)paren
op_eq
id|CS_SUCCESS
op_logical_and
id|CardServices
c_func
(paren
id|ParseTuple
comma
id|handle
comma
op_amp
id|tuple
comma
op_amp
id|parse
)paren
op_eq
id|CS_SUCCESS
)paren
(brace
id|cardname
op_assign
id|parse.version_1.str
op_plus
id|parse.version_1.ofs
(braket
l_int|1
)braket
suffix:semicolon
)brace
r_else
id|cardname
op_assign
l_string|&quot;3Com 3c574&quot;
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: %s at io %#3lx, irq %d, hw_addr &quot;
comma
id|dev-&gt;name
comma
id|cardname
comma
id|dev-&gt;base_addr
comma
id|dev-&gt;irq
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|6
suffix:semicolon
id|i
op_increment
)paren
id|printk
c_func
(paren
l_string|&quot;%02X%s&quot;
comma
id|dev-&gt;dev_addr
(braket
id|i
)braket
comma
(paren
(paren
id|i
OL
l_int|5
)paren
ques
c_cond
l_string|&quot;:&quot;
suffix:colon
l_string|&quot;.&bslash;n&quot;
)paren
)paren
suffix:semicolon
(brace
id|u_char
id|mcr
comma
op_star
id|ram_split
(braket
)braket
op_assign
(brace
l_string|&quot;5:3&quot;
comma
l_string|&quot;3:1&quot;
comma
l_string|&quot;1:1&quot;
comma
l_string|&quot;3:5&quot;
)brace
suffix:semicolon
r_union
id|wn3_config
id|config
suffix:semicolon
id|outw
c_func
(paren
l_int|2
op_lshift
l_int|11
comma
id|ioaddr
op_plus
id|RunnerRdCtrl
)paren
suffix:semicolon
id|mcr
op_assign
id|inb
c_func
(paren
id|ioaddr
op_plus
l_int|2
)paren
suffix:semicolon
id|outw
c_func
(paren
l_int|0
op_lshift
l_int|11
comma
id|ioaddr
op_plus
id|RunnerRdCtrl
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;  ASIC rev %d,&quot;
comma
id|mcr
op_rshift
l_int|3
)paren
suffix:semicolon
id|EL3WINDOW
c_func
(paren
l_int|3
)paren
suffix:semicolon
id|config.i
op_assign
id|inl
c_func
(paren
id|ioaddr
op_plus
id|Wn3_Config
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot; %dK FIFO split %s Rx:Tx, %sMII interface.&bslash;n&quot;
comma
l_int|8
op_lshift
id|config.u.ram_size
comma
id|ram_split
(braket
id|config.u.ram_split
)braket
comma
id|config.u.autoselect
ques
c_cond
l_string|&quot;autoselect &quot;
suffix:colon
l_string|&quot;&quot;
)paren
suffix:semicolon
id|lp-&gt;default_media
op_assign
id|config.u.xcvr
suffix:semicolon
id|lp-&gt;autoselect
op_assign
id|config.u.autoselect
suffix:semicolon
)brace
(brace
r_int
id|phy
comma
id|phy_idx
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Roadrunner only: Turn on the MII transceiver */
id|outw
c_func
(paren
l_int|0x8040
comma
id|ioaddr
op_plus
id|Wn3_Options
)paren
suffix:semicolon
id|mdelay
c_func
(paren
l_int|1
)paren
suffix:semicolon
id|outw
c_func
(paren
l_int|0xc040
comma
id|ioaddr
op_plus
id|Wn3_Options
)paren
suffix:semicolon
id|wait_for_completion
c_func
(paren
id|dev
comma
id|TxReset
)paren
suffix:semicolon
id|wait_for_completion
c_func
(paren
id|dev
comma
id|RxReset
)paren
suffix:semicolon
id|mdelay
c_func
(paren
l_int|1
)paren
suffix:semicolon
id|outw
c_func
(paren
l_int|0x8040
comma
id|ioaddr
op_plus
id|Wn3_Options
)paren
suffix:semicolon
id|EL3WINDOW
c_func
(paren
l_int|4
)paren
suffix:semicolon
r_for
c_loop
(paren
id|phy
op_assign
l_int|1
suffix:semicolon
id|phy
op_le
l_int|32
op_logical_and
id|phy_idx
OL
r_sizeof
(paren
id|lp-&gt;phys
)paren
suffix:semicolon
id|phy
op_increment
)paren
(brace
r_int
id|mii_status
suffix:semicolon
id|mdio_sync
c_func
(paren
id|ioaddr
comma
l_int|32
)paren
suffix:semicolon
id|mii_status
op_assign
id|mdio_read
c_func
(paren
id|ioaddr
comma
id|phy
op_amp
l_int|0x1f
comma
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mii_status
op_ne
l_int|0xffff
)paren
(brace
id|lp-&gt;phys
(braket
id|phy_idx
op_increment
)braket
op_assign
id|phy
op_amp
l_int|0x1f
suffix:semicolon
id|DEBUG
c_func
(paren
l_int|0
comma
l_string|&quot;  MII transceiver at index %d, status %x.&bslash;n&quot;
comma
id|phy
comma
id|mii_status
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|mii_status
op_amp
l_int|0x0040
)paren
op_eq
l_int|0
)paren
id|mii_preamble_required
op_assign
l_int|1
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|phy_idx
op_eq
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;  No MII transceivers found!&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|failed
suffix:semicolon
)brace
id|i
op_assign
id|mdio_read
c_func
(paren
id|ioaddr
comma
id|lp-&gt;phys
(braket
l_int|0
)braket
comma
l_int|16
)paren
op_or
l_int|0x40
suffix:semicolon
id|mdio_write
c_func
(paren
id|ioaddr
comma
id|lp-&gt;phys
(braket
l_int|0
)braket
comma
l_int|16
comma
id|i
)paren
suffix:semicolon
id|lp-&gt;advertising
op_assign
id|mdio_read
c_func
(paren
id|ioaddr
comma
id|lp-&gt;phys
(braket
l_int|0
)braket
comma
l_int|4
)paren
suffix:semicolon
r_if
c_cond
(paren
id|full_duplex
)paren
(brace
multiline_comment|/* Only advertise the FD media types. */
id|lp-&gt;advertising
op_and_assign
op_complement
l_int|0x02a0
suffix:semicolon
id|mdio_write
c_func
(paren
id|ioaddr
comma
id|lp-&gt;phys
(braket
l_int|0
)braket
comma
l_int|4
comma
id|lp-&gt;advertising
)paren
suffix:semicolon
)brace
)brace
r_return
suffix:semicolon
id|cs_failed
suffix:colon
id|cs_error
c_func
(paren
id|link-&gt;handle
comma
id|last_fn
comma
id|last_ret
)paren
suffix:semicolon
id|failed
suffix:colon
id|tc574_release
c_func
(paren
(paren
id|u_long
)paren
id|link
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/* tc574_config */
multiline_comment|/*&n;&t;After a card is removed, tc574_release() will unregister the net&n;&t;device, and release the PCMCIA configuration.  If the device is&n;&t;still open, this will be postponed until it is closed.&n;*/
DECL|function|tc574_release
r_static
r_void
id|tc574_release
c_func
(paren
id|u_long
id|arg
)paren
(brace
id|dev_link_t
op_star
id|link
op_assign
(paren
id|dev_link_t
op_star
)paren
id|arg
suffix:semicolon
id|DEBUG
c_func
(paren
l_int|0
comma
l_string|&quot;3c574_release(0x%p)&bslash;n&quot;
comma
id|link
)paren
suffix:semicolon
r_if
c_cond
(paren
id|link-&gt;open
)paren
(brace
id|DEBUG
c_func
(paren
l_int|1
comma
l_string|&quot;3c574_cs: release postponed, &squot;%s&squot; still open&bslash;n&quot;
comma
id|link-&gt;dev-&gt;dev_name
)paren
suffix:semicolon
id|link-&gt;state
op_or_assign
id|DEV_STALE_CONFIG
suffix:semicolon
r_return
suffix:semicolon
)brace
id|CardServices
c_func
(paren
id|ReleaseConfiguration
comma
id|link-&gt;handle
)paren
suffix:semicolon
id|CardServices
c_func
(paren
id|ReleaseIO
comma
id|link-&gt;handle
comma
op_amp
id|link-&gt;io
)paren
suffix:semicolon
id|CardServices
c_func
(paren
id|ReleaseIRQ
comma
id|link-&gt;handle
comma
op_amp
id|link-&gt;irq
)paren
suffix:semicolon
id|link-&gt;state
op_and_assign
op_complement
id|DEV_CONFIG
suffix:semicolon
)brace
multiline_comment|/* tc574_release */
multiline_comment|/*&n;&t;The card status event handler.  Mostly, this schedules other&n;&t;stuff to run after an event is received.  A CARD_REMOVAL event&n;&t;also sets some flags to discourage the net drivers from trying&n;&t;to talk to the card any more.&n;*/
DECL|function|tc574_event
r_static
r_int
id|tc574_event
c_func
(paren
id|event_t
id|event
comma
r_int
id|priority
comma
id|event_callback_args_t
op_star
id|args
)paren
(brace
id|dev_link_t
op_star
id|link
op_assign
id|args-&gt;client_data
suffix:semicolon
r_struct
id|el3_private
op_star
id|lp
op_assign
id|link-&gt;priv
suffix:semicolon
r_struct
id|net_device
op_star
id|dev
op_assign
op_amp
id|lp-&gt;dev
suffix:semicolon
id|DEBUG
c_func
(paren
l_int|1
comma
l_string|&quot;3c574_event(0x%06x)&bslash;n&quot;
comma
id|event
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|event
)paren
(brace
r_case
id|CS_EVENT_CARD_REMOVAL
suffix:colon
id|link-&gt;state
op_and_assign
op_complement
id|DEV_PRESENT
suffix:semicolon
r_if
c_cond
(paren
id|link-&gt;state
op_amp
id|DEV_CONFIG
)paren
(brace
id|netif_device_detach
c_func
(paren
id|dev
)paren
suffix:semicolon
id|mod_timer
c_func
(paren
op_amp
id|link-&gt;release
comma
id|jiffies
op_plus
id|HZ
op_div
l_int|20
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|CS_EVENT_CARD_INSERTION
suffix:colon
id|link-&gt;state
op_or_assign
id|DEV_PRESENT
op_or
id|DEV_CONFIG_PENDING
suffix:semicolon
id|tc574_config
c_func
(paren
id|link
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CS_EVENT_PM_SUSPEND
suffix:colon
id|link-&gt;state
op_or_assign
id|DEV_SUSPEND
suffix:semicolon
multiline_comment|/* Fall through... */
r_case
id|CS_EVENT_RESET_PHYSICAL
suffix:colon
r_if
c_cond
(paren
id|link-&gt;state
op_amp
id|DEV_CONFIG
)paren
(brace
r_if
c_cond
(paren
id|link-&gt;open
)paren
id|netif_device_detach
c_func
(paren
id|dev
)paren
suffix:semicolon
id|CardServices
c_func
(paren
id|ReleaseConfiguration
comma
id|link-&gt;handle
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|CS_EVENT_PM_RESUME
suffix:colon
id|link-&gt;state
op_and_assign
op_complement
id|DEV_SUSPEND
suffix:semicolon
multiline_comment|/* Fall through... */
r_case
id|CS_EVENT_CARD_RESET
suffix:colon
r_if
c_cond
(paren
id|link-&gt;state
op_amp
id|DEV_CONFIG
)paren
(brace
id|CardServices
c_func
(paren
id|RequestConfiguration
comma
id|link-&gt;handle
comma
op_amp
id|link-&gt;conf
)paren
suffix:semicolon
r_if
c_cond
(paren
id|link-&gt;open
)paren
(brace
id|tc574_reset
c_func
(paren
id|dev
)paren
suffix:semicolon
id|netif_device_attach
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
)brace
r_break
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* tc574_event */
DECL|function|dump_status
r_static
r_void
id|dump_status
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
id|ioaddr_t
id|ioaddr
op_assign
id|dev-&gt;base_addr
suffix:semicolon
id|EL3WINDOW
c_func
(paren
l_int|1
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;  irq status %04x, rx status %04x, tx status &quot;
l_string|&quot;%02x, tx free %04x&bslash;n&quot;
comma
id|inw
c_func
(paren
id|ioaddr
op_plus
id|EL3_STATUS
)paren
comma
id|inw
c_func
(paren
id|ioaddr
op_plus
id|RxStatus
)paren
comma
id|inb
c_func
(paren
id|ioaddr
op_plus
id|TxStatus
)paren
comma
id|inw
c_func
(paren
id|ioaddr
op_plus
id|TxFree
)paren
)paren
suffix:semicolon
id|EL3WINDOW
c_func
(paren
l_int|4
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;  diagnostics: fifo %04x net %04x ethernet %04x&quot;
l_string|&quot; media %04x&bslash;n&quot;
comma
id|inw
c_func
(paren
id|ioaddr
op_plus
l_int|0x04
)paren
comma
id|inw
c_func
(paren
id|ioaddr
op_plus
l_int|0x06
)paren
comma
id|inw
c_func
(paren
id|ioaddr
op_plus
l_int|0x08
)paren
comma
id|inw
c_func
(paren
id|ioaddr
op_plus
l_int|0x0a
)paren
)paren
suffix:semicolon
id|EL3WINDOW
c_func
(paren
l_int|1
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;  Use this for commands that may take time to finish&n;*/
DECL|function|wait_for_completion
r_static
r_void
id|wait_for_completion
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_int
id|cmd
)paren
(brace
r_int
id|i
op_assign
l_int|1500
suffix:semicolon
id|outw
c_func
(paren
id|cmd
comma
id|dev-&gt;base_addr
op_plus
id|EL3_CMD
)paren
suffix:semicolon
r_while
c_loop
(paren
op_decrement
id|i
OG
l_int|0
)paren
r_if
c_cond
(paren
op_logical_neg
(paren
id|inw
c_func
(paren
id|dev-&gt;base_addr
op_plus
id|EL3_STATUS
)paren
op_amp
l_int|0x1000
)paren
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
id|i
op_eq
l_int|0
)paren
id|printk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;%s: command 0x%04x did not complete!&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|cmd
)paren
suffix:semicolon
)brace
multiline_comment|/* Read a word from the EEPROM using the regular EEPROM access register.&n;   Assume that we are in register window zero.&n; */
DECL|function|read_eeprom
r_static
id|u_short
id|read_eeprom
c_func
(paren
id|ioaddr_t
id|ioaddr
comma
r_int
id|index
)paren
(brace
r_int
id|timer
suffix:semicolon
id|outw
c_func
(paren
id|EEPROM_Read
op_plus
id|index
comma
id|ioaddr
op_plus
id|Wn0EepromCmd
)paren
suffix:semicolon
multiline_comment|/* Pause for at least 162 usec for the read to take place. */
r_for
c_loop
(paren
id|timer
op_assign
l_int|1620
suffix:semicolon
id|timer
op_ge
l_int|0
suffix:semicolon
id|timer
op_decrement
)paren
(brace
r_if
c_cond
(paren
(paren
id|inw
c_func
(paren
id|ioaddr
op_plus
id|Wn0EepromCmd
)paren
op_amp
l_int|0x8000
)paren
op_eq
l_int|0
)paren
r_break
suffix:semicolon
)brace
r_return
id|inw
c_func
(paren
id|ioaddr
op_plus
id|Wn0EepromData
)paren
suffix:semicolon
)brace
multiline_comment|/* MII transceiver control section.&n;   Read and write the MII registers using software-generated serial&n;   MDIO protocol.  See the MII specifications or DP83840A data sheet&n;   for details.&n;   The maxium data clock rate is 2.5 Mhz.  The timing is easily met by the&n;   slow PC card interface. */
DECL|macro|MDIO_SHIFT_CLK
mdefine_line|#define MDIO_SHIFT_CLK&t;0x01
DECL|macro|MDIO_DIR_WRITE
mdefine_line|#define MDIO_DIR_WRITE&t;0x04
DECL|macro|MDIO_DATA_WRITE0
mdefine_line|#define MDIO_DATA_WRITE0 (0x00 | MDIO_DIR_WRITE)
DECL|macro|MDIO_DATA_WRITE1
mdefine_line|#define MDIO_DATA_WRITE1 (0x02 | MDIO_DIR_WRITE)
DECL|macro|MDIO_DATA_READ
mdefine_line|#define MDIO_DATA_READ&t;0x02
DECL|macro|MDIO_ENB_IN
mdefine_line|#define MDIO_ENB_IN&t;&t;0x00
multiline_comment|/* Generate the preamble required for initial synchronization and&n;   a few older transceivers. */
DECL|function|mdio_sync
r_static
r_void
id|mdio_sync
c_func
(paren
id|ioaddr_t
id|ioaddr
comma
r_int
id|bits
)paren
(brace
r_int
id|mdio_addr
op_assign
id|ioaddr
op_plus
id|Wn4_PhysicalMgmt
suffix:semicolon
multiline_comment|/* Establish sync by sending at least 32 logic ones. */
r_while
c_loop
(paren
op_decrement
id|bits
op_ge
l_int|0
)paren
(brace
id|outw
c_func
(paren
id|MDIO_DATA_WRITE1
comma
id|mdio_addr
)paren
suffix:semicolon
id|outw
c_func
(paren
id|MDIO_DATA_WRITE1
op_or
id|MDIO_SHIFT_CLK
comma
id|mdio_addr
)paren
suffix:semicolon
)brace
)brace
DECL|function|mdio_read
r_static
r_int
id|mdio_read
c_func
(paren
id|ioaddr_t
id|ioaddr
comma
r_int
id|phy_id
comma
r_int
id|location
)paren
(brace
r_int
id|i
suffix:semicolon
r_int
id|read_cmd
op_assign
(paren
l_int|0xf6
op_lshift
l_int|10
)paren
op_or
(paren
id|phy_id
op_lshift
l_int|5
)paren
op_or
id|location
suffix:semicolon
r_int
r_int
id|retval
op_assign
l_int|0
suffix:semicolon
r_int
id|mdio_addr
op_assign
id|ioaddr
op_plus
id|Wn4_PhysicalMgmt
suffix:semicolon
r_if
c_cond
(paren
id|mii_preamble_required
)paren
id|mdio_sync
c_func
(paren
id|ioaddr
comma
l_int|32
)paren
suffix:semicolon
multiline_comment|/* Shift the read command bits out. */
r_for
c_loop
(paren
id|i
op_assign
l_int|14
suffix:semicolon
id|i
op_ge
l_int|0
suffix:semicolon
id|i
op_decrement
)paren
(brace
r_int
id|dataval
op_assign
(paren
id|read_cmd
op_amp
(paren
l_int|1
op_lshift
id|i
)paren
)paren
ques
c_cond
id|MDIO_DATA_WRITE1
suffix:colon
id|MDIO_DATA_WRITE0
suffix:semicolon
id|outw
c_func
(paren
id|dataval
comma
id|mdio_addr
)paren
suffix:semicolon
id|outw
c_func
(paren
id|dataval
op_or
id|MDIO_SHIFT_CLK
comma
id|mdio_addr
)paren
suffix:semicolon
)brace
multiline_comment|/* Read the two transition, 16 data, and wire-idle bits. */
r_for
c_loop
(paren
id|i
op_assign
l_int|19
suffix:semicolon
id|i
OG
l_int|0
suffix:semicolon
id|i
op_decrement
)paren
(brace
id|outw
c_func
(paren
id|MDIO_ENB_IN
comma
id|mdio_addr
)paren
suffix:semicolon
id|retval
op_assign
(paren
id|retval
op_lshift
l_int|1
)paren
op_or
(paren
(paren
id|inw
c_func
(paren
id|mdio_addr
)paren
op_amp
id|MDIO_DATA_READ
)paren
ques
c_cond
l_int|1
suffix:colon
l_int|0
)paren
suffix:semicolon
id|outw
c_func
(paren
id|MDIO_ENB_IN
op_or
id|MDIO_SHIFT_CLK
comma
id|mdio_addr
)paren
suffix:semicolon
)brace
r_return
(paren
id|retval
op_rshift
l_int|1
)paren
op_amp
l_int|0xffff
suffix:semicolon
)brace
DECL|function|mdio_write
r_static
r_void
id|mdio_write
c_func
(paren
id|ioaddr_t
id|ioaddr
comma
r_int
id|phy_id
comma
r_int
id|location
comma
r_int
id|value
)paren
(brace
r_int
id|write_cmd
op_assign
l_int|0x50020000
op_or
(paren
id|phy_id
op_lshift
l_int|23
)paren
op_or
(paren
id|location
op_lshift
l_int|18
)paren
op_or
id|value
suffix:semicolon
r_int
id|mdio_addr
op_assign
id|ioaddr
op_plus
id|Wn4_PhysicalMgmt
suffix:semicolon
r_int
id|i
suffix:semicolon
r_if
c_cond
(paren
id|mii_preamble_required
)paren
id|mdio_sync
c_func
(paren
id|ioaddr
comma
l_int|32
)paren
suffix:semicolon
multiline_comment|/* Shift the command bits out. */
r_for
c_loop
(paren
id|i
op_assign
l_int|31
suffix:semicolon
id|i
op_ge
l_int|0
suffix:semicolon
id|i
op_decrement
)paren
(brace
r_int
id|dataval
op_assign
(paren
id|write_cmd
op_amp
(paren
l_int|1
op_lshift
id|i
)paren
)paren
ques
c_cond
id|MDIO_DATA_WRITE1
suffix:colon
id|MDIO_DATA_WRITE0
suffix:semicolon
id|outw
c_func
(paren
id|dataval
comma
id|mdio_addr
)paren
suffix:semicolon
id|outw
c_func
(paren
id|dataval
op_or
id|MDIO_SHIFT_CLK
comma
id|mdio_addr
)paren
suffix:semicolon
)brace
multiline_comment|/* Leave the interface idle. */
r_for
c_loop
(paren
id|i
op_assign
l_int|1
suffix:semicolon
id|i
op_ge
l_int|0
suffix:semicolon
id|i
op_decrement
)paren
(brace
id|outw
c_func
(paren
id|MDIO_ENB_IN
comma
id|mdio_addr
)paren
suffix:semicolon
id|outw
c_func
(paren
id|MDIO_ENB_IN
op_or
id|MDIO_SHIFT_CLK
comma
id|mdio_addr
)paren
suffix:semicolon
)brace
r_return
suffix:semicolon
)brace
multiline_comment|/* Reset and restore all of the 3c574 registers. */
DECL|function|tc574_reset
r_static
r_void
id|tc574_reset
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|el3_private
op_star
id|lp
op_assign
(paren
r_struct
id|el3_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_int
id|i
comma
id|ioaddr
op_assign
id|dev-&gt;base_addr
suffix:semicolon
id|wait_for_completion
c_func
(paren
id|dev
comma
id|TotalReset
op_or
l_int|0x10
)paren
suffix:semicolon
multiline_comment|/* Clear any transactions in progress. */
id|outw
c_func
(paren
l_int|0
comma
id|ioaddr
op_plus
id|RunnerWrCtrl
)paren
suffix:semicolon
id|outw
c_func
(paren
l_int|0
comma
id|ioaddr
op_plus
id|RunnerRdCtrl
)paren
suffix:semicolon
multiline_comment|/* Set the station address and mask. */
id|EL3WINDOW
c_func
(paren
l_int|2
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|6
suffix:semicolon
id|i
op_increment
)paren
id|outb
c_func
(paren
id|dev-&gt;dev_addr
(braket
id|i
)braket
comma
id|ioaddr
op_plus
id|i
)paren
suffix:semicolon
r_for
c_loop
(paren
suffix:semicolon
id|i
OL
l_int|12
suffix:semicolon
id|i
op_add_assign
l_int|2
)paren
id|outw
c_func
(paren
l_int|0
comma
id|ioaddr
op_plus
id|i
)paren
suffix:semicolon
multiline_comment|/* Reset config options */
id|EL3WINDOW
c_func
(paren
l_int|3
)paren
suffix:semicolon
id|outb
c_func
(paren
(paren
id|dev-&gt;mtu
OG
l_int|1500
ques
c_cond
l_int|0x40
suffix:colon
l_int|0
)paren
comma
id|ioaddr
op_plus
id|Wn3_MAC_Ctrl
)paren
suffix:semicolon
id|outl
c_func
(paren
(paren
id|lp-&gt;autoselect
ques
c_cond
l_int|0x01000000
suffix:colon
l_int|0
)paren
op_or
l_int|0x0062001b
comma
id|ioaddr
op_plus
id|Wn3_Config
)paren
suffix:semicolon
multiline_comment|/* Roadrunner only: Turn on the MII transceiver. */
id|outw
c_func
(paren
l_int|0x8040
comma
id|ioaddr
op_plus
id|Wn3_Options
)paren
suffix:semicolon
id|mdelay
c_func
(paren
l_int|1
)paren
suffix:semicolon
id|outw
c_func
(paren
l_int|0xc040
comma
id|ioaddr
op_plus
id|Wn3_Options
)paren
suffix:semicolon
id|wait_for_completion
c_func
(paren
id|dev
comma
id|TxReset
)paren
suffix:semicolon
id|wait_for_completion
c_func
(paren
id|dev
comma
id|RxReset
)paren
suffix:semicolon
id|mdelay
c_func
(paren
l_int|1
)paren
suffix:semicolon
id|outw
c_func
(paren
l_int|0x8040
comma
id|ioaddr
op_plus
id|Wn3_Options
)paren
suffix:semicolon
multiline_comment|/* Switch to the stats window, and clear all stats by reading. */
id|outw
c_func
(paren
id|StatsDisable
comma
id|ioaddr
op_plus
id|EL3_CMD
)paren
suffix:semicolon
id|EL3WINDOW
c_func
(paren
l_int|6
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|10
suffix:semicolon
id|i
op_increment
)paren
id|inb
c_func
(paren
id|ioaddr
op_plus
id|i
)paren
suffix:semicolon
id|inw
c_func
(paren
id|ioaddr
op_plus
l_int|10
)paren
suffix:semicolon
id|inw
c_func
(paren
id|ioaddr
op_plus
l_int|12
)paren
suffix:semicolon
id|EL3WINDOW
c_func
(paren
l_int|4
)paren
suffix:semicolon
id|inb
c_func
(paren
id|ioaddr
op_plus
l_int|12
)paren
suffix:semicolon
id|inb
c_func
(paren
id|ioaddr
op_plus
l_int|13
)paren
suffix:semicolon
multiline_comment|/* .. enable any extra statistics bits.. */
id|outw
c_func
(paren
l_int|0x0040
comma
id|ioaddr
op_plus
id|Wn4_NetDiag
)paren
suffix:semicolon
multiline_comment|/* .. re-sync MII and re-fill what NWay is advertising. */
id|mdio_sync
c_func
(paren
id|ioaddr
comma
l_int|32
)paren
suffix:semicolon
id|mdio_write
c_func
(paren
id|ioaddr
comma
id|lp-&gt;phys
(braket
l_int|0
)braket
comma
l_int|4
comma
id|lp-&gt;advertising
)paren
suffix:semicolon
multiline_comment|/* Switch to register set 1 for normal use, just for TxFree. */
id|EL3WINDOW
c_func
(paren
l_int|1
)paren
suffix:semicolon
id|set_rx_mode
c_func
(paren
id|dev
)paren
suffix:semicolon
id|outw
c_func
(paren
id|StatsEnable
comma
id|ioaddr
op_plus
id|EL3_CMD
)paren
suffix:semicolon
multiline_comment|/* Turn on statistics. */
id|outw
c_func
(paren
id|RxEnable
comma
id|ioaddr
op_plus
id|EL3_CMD
)paren
suffix:semicolon
multiline_comment|/* Enable the receiver. */
id|outw
c_func
(paren
id|TxEnable
comma
id|ioaddr
op_plus
id|EL3_CMD
)paren
suffix:semicolon
multiline_comment|/* Enable transmitter. */
multiline_comment|/* Allow status bits to be seen. */
id|outw
c_func
(paren
id|SetStatusEnb
op_or
l_int|0xff
comma
id|ioaddr
op_plus
id|EL3_CMD
)paren
suffix:semicolon
multiline_comment|/* Ack all pending events, and set active indicator mask. */
id|outw
c_func
(paren
id|AckIntr
op_or
id|IntLatch
op_or
id|TxAvailable
op_or
id|RxEarly
op_or
id|IntReq
comma
id|ioaddr
op_plus
id|EL3_CMD
)paren
suffix:semicolon
id|outw
c_func
(paren
id|SetIntrEnb
op_or
id|IntLatch
op_or
id|TxAvailable
op_or
id|RxComplete
op_or
id|StatsFull
op_or
id|AdapterFailure
op_or
id|RxEarly
comma
id|ioaddr
op_plus
id|EL3_CMD
)paren
suffix:semicolon
)brace
DECL|function|el3_open
r_static
r_int
id|el3_open
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|el3_private
op_star
id|lp
op_assign
(paren
r_struct
id|el3_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|dev_link_t
op_star
id|link
op_assign
op_amp
id|lp-&gt;link
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|DEV_OK
c_func
(paren
id|link
)paren
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
id|link-&gt;open
op_increment
suffix:semicolon
id|MOD_INC_USE_COUNT
suffix:semicolon
id|netif_start_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
id|tc574_reset
c_func
(paren
id|dev
)paren
suffix:semicolon
id|lp-&gt;media.function
op_assign
op_amp
id|media_check
suffix:semicolon
id|lp-&gt;media.data
op_assign
(paren
id|u_long
)paren
id|lp
suffix:semicolon
id|lp-&gt;media.expires
op_assign
id|jiffies
op_plus
id|HZ
suffix:semicolon
id|add_timer
c_func
(paren
op_amp
id|lp-&gt;media
)paren
suffix:semicolon
id|DEBUG
c_func
(paren
l_int|2
comma
l_string|&quot;%s: opened, status %4.4x.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|inw
c_func
(paren
id|dev-&gt;base_addr
op_plus
id|EL3_STATUS
)paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|el3_tx_timeout
r_static
r_void
id|el3_tx_timeout
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|el3_private
op_star
id|lp
op_assign
(paren
r_struct
id|el3_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|ioaddr_t
id|ioaddr
op_assign
id|dev-&gt;base_addr
suffix:semicolon
id|printk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;%s: Transmit timed out!&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|dump_status
c_func
(paren
id|dev
)paren
suffix:semicolon
id|lp-&gt;stats.tx_errors
op_increment
suffix:semicolon
id|dev-&gt;trans_start
op_assign
id|jiffies
suffix:semicolon
multiline_comment|/* Issue TX_RESET and TX_START commands. */
id|wait_for_completion
c_func
(paren
id|dev
comma
id|TxReset
)paren
suffix:semicolon
id|outw
c_func
(paren
id|TxEnable
comma
id|ioaddr
op_plus
id|EL3_CMD
)paren
suffix:semicolon
id|netif_start_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
DECL|function|pop_tx_status
r_static
r_void
id|pop_tx_status
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|el3_private
op_star
id|lp
op_assign
(paren
r_struct
id|el3_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|ioaddr_t
id|ioaddr
op_assign
id|dev-&gt;base_addr
suffix:semicolon
r_int
id|i
suffix:semicolon
multiline_comment|/* Clear the Tx status stack. */
r_for
c_loop
(paren
id|i
op_assign
l_int|32
suffix:semicolon
id|i
OG
l_int|0
suffix:semicolon
id|i
op_decrement
)paren
(brace
id|u_char
id|tx_status
op_assign
id|inb
c_func
(paren
id|ioaddr
op_plus
id|TxStatus
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|tx_status
op_amp
l_int|0x84
)paren
)paren
r_break
suffix:semicolon
multiline_comment|/* reset transmitter on jabber error or underrun */
r_if
c_cond
(paren
id|tx_status
op_amp
l_int|0x30
)paren
id|wait_for_completion
c_func
(paren
id|dev
comma
id|TxReset
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tx_status
op_amp
l_int|0x38
)paren
(brace
id|DEBUG
c_func
(paren
l_int|1
comma
l_string|&quot;%s: transmit error: status 0x%02x&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|tx_status
)paren
suffix:semicolon
id|outw
c_func
(paren
id|TxEnable
comma
id|ioaddr
op_plus
id|EL3_CMD
)paren
suffix:semicolon
id|lp-&gt;stats.tx_aborted_errors
op_increment
suffix:semicolon
)brace
id|outb
c_func
(paren
l_int|0x00
comma
id|ioaddr
op_plus
id|TxStatus
)paren
suffix:semicolon
multiline_comment|/* Pop the status stack. */
)brace
)brace
DECL|function|el3_start_xmit
r_static
r_int
id|el3_start_xmit
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|net_device
op_star
id|dev
)paren
(brace
id|ioaddr_t
id|ioaddr
op_assign
id|dev-&gt;base_addr
suffix:semicolon
id|DEBUG
c_func
(paren
l_int|3
comma
l_string|&quot;%s: el3_start_xmit(length = %ld) called, &quot;
l_string|&quot;status %4.4x.&bslash;n&quot;
comma
id|dev-&gt;name
comma
(paren
r_int
)paren
id|skb-&gt;len
comma
id|inw
c_func
(paren
id|ioaddr
op_plus
id|EL3_STATUS
)paren
)paren
suffix:semicolon
id|outw
c_func
(paren
id|skb-&gt;len
comma
id|ioaddr
op_plus
id|TX_FIFO
)paren
suffix:semicolon
id|outw
c_func
(paren
l_int|0
comma
id|ioaddr
op_plus
id|TX_FIFO
)paren
suffix:semicolon
id|outsl
c_func
(paren
id|ioaddr
op_plus
id|TX_FIFO
comma
id|skb-&gt;data
comma
(paren
id|skb-&gt;len
op_plus
l_int|3
)paren
op_rshift
l_int|2
)paren
suffix:semicolon
id|dev-&gt;trans_start
op_assign
id|jiffies
suffix:semicolon
multiline_comment|/* TxFree appears only in Window 1, not offset 0x1c. */
r_if
c_cond
(paren
id|inw
c_func
(paren
id|ioaddr
op_plus
id|TxFree
)paren
op_le
l_int|1536
)paren
(brace
id|netif_stop_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
multiline_comment|/* Interrupt us when the FIFO has room for max-sized packet. &n;&t;&t;   The threshold is in units of dwords. */
id|outw
c_func
(paren
id|SetTxThreshold
op_plus
(paren
l_int|1536
op_rshift
l_int|2
)paren
comma
id|ioaddr
op_plus
id|EL3_CMD
)paren
suffix:semicolon
)brace
id|dev_kfree_skb
(paren
id|skb
)paren
suffix:semicolon
id|pop_tx_status
c_func
(paren
id|dev
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* The EL3 interrupt handler. */
DECL|function|el3_interrupt
r_static
r_void
id|el3_interrupt
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_struct
id|el3_private
op_star
id|lp
op_assign
id|dev_id
suffix:semicolon
r_struct
id|net_device
op_star
id|dev
op_assign
op_amp
id|lp-&gt;dev
suffix:semicolon
id|ioaddr_t
id|ioaddr
comma
id|status
suffix:semicolon
r_int
id|work_budget
op_assign
id|max_interrupt_work
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|netif_device_present
c_func
(paren
id|dev
)paren
)paren
r_return
suffix:semicolon
id|ioaddr
op_assign
id|dev-&gt;base_addr
suffix:semicolon
id|DEBUG
c_func
(paren
l_int|3
comma
l_string|&quot;%s: interrupt, status %4.4x.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|inw
c_func
(paren
id|ioaddr
op_plus
id|EL3_STATUS
)paren
)paren
suffix:semicolon
r_while
c_loop
(paren
(paren
id|status
op_assign
id|inw
c_func
(paren
id|ioaddr
op_plus
id|EL3_STATUS
)paren
)paren
op_amp
(paren
id|IntLatch
op_or
id|RxComplete
op_or
id|RxEarly
op_or
id|StatsFull
)paren
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|netif_device_present
c_func
(paren
id|dev
)paren
op_logical_or
(paren
(paren
id|status
op_amp
l_int|0xe000
)paren
op_ne
l_int|0x2000
)paren
)paren
(brace
id|DEBUG
c_func
(paren
l_int|1
comma
l_string|&quot;%s: Interrupt from dead card&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|status
op_amp
id|RxComplete
)paren
id|work_budget
op_assign
id|el3_rx
c_func
(paren
id|dev
comma
id|work_budget
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
id|TxAvailable
)paren
(brace
id|DEBUG
c_func
(paren
l_int|3
comma
l_string|&quot;  TX room bit was handled.&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* There&squot;s room in the FIFO for a full-sized packet. */
id|outw
c_func
(paren
id|AckIntr
op_or
id|TxAvailable
comma
id|ioaddr
op_plus
id|EL3_CMD
)paren
suffix:semicolon
id|netif_wake_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|status
op_amp
id|TxComplete
)paren
id|pop_tx_status
c_func
(paren
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
(paren
id|AdapterFailure
op_or
id|RxEarly
op_or
id|StatsFull
)paren
)paren
(brace
multiline_comment|/* Handle all uncommon interrupts. */
r_if
c_cond
(paren
id|status
op_amp
id|StatsFull
)paren
id|update_stats
c_func
(paren
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
id|RxEarly
)paren
(brace
id|work_budget
op_assign
id|el3_rx
c_func
(paren
id|dev
comma
id|work_budget
)paren
suffix:semicolon
id|outw
c_func
(paren
id|AckIntr
op_or
id|RxEarly
comma
id|ioaddr
op_plus
id|EL3_CMD
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|status
op_amp
id|AdapterFailure
)paren
(brace
id|u16
id|fifo_diag
suffix:semicolon
id|EL3WINDOW
c_func
(paren
l_int|4
)paren
suffix:semicolon
id|fifo_diag
op_assign
id|inw
c_func
(paren
id|ioaddr
op_plus
id|Wn4_FIFODiag
)paren
suffix:semicolon
id|EL3WINDOW
c_func
(paren
l_int|1
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;%s: adapter failure, FIFO diagnostic&quot;
l_string|&quot; register %04x.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|fifo_diag
)paren
suffix:semicolon
r_if
c_cond
(paren
id|fifo_diag
op_amp
l_int|0x0400
)paren
(brace
multiline_comment|/* Tx overrun */
id|wait_for_completion
c_func
(paren
id|dev
comma
id|TxReset
)paren
suffix:semicolon
id|outw
c_func
(paren
id|TxEnable
comma
id|ioaddr
op_plus
id|EL3_CMD
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|fifo_diag
op_amp
l_int|0x2000
)paren
(brace
multiline_comment|/* Rx underrun */
id|wait_for_completion
c_func
(paren
id|dev
comma
id|RxReset
)paren
suffix:semicolon
id|set_rx_mode
c_func
(paren
id|dev
)paren
suffix:semicolon
id|outw
c_func
(paren
id|RxEnable
comma
id|ioaddr
op_plus
id|EL3_CMD
)paren
suffix:semicolon
)brace
id|outw
c_func
(paren
id|AckIntr
op_or
id|AdapterFailure
comma
id|ioaddr
op_plus
id|EL3_CMD
)paren
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
op_decrement
id|work_budget
OL
l_int|0
)paren
(brace
id|DEBUG
c_func
(paren
l_int|0
comma
l_string|&quot;%s: Too much work in interrupt, &quot;
l_string|&quot;status %4.4x.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|status
)paren
suffix:semicolon
multiline_comment|/* Clear all interrupts */
id|outw
c_func
(paren
id|AckIntr
op_or
l_int|0xFF
comma
id|ioaddr
op_plus
id|EL3_CMD
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
multiline_comment|/* Acknowledge the IRQ. */
id|outw
c_func
(paren
id|AckIntr
op_or
id|IntReq
op_or
id|IntLatch
comma
id|ioaddr
op_plus
id|EL3_CMD
)paren
suffix:semicolon
)brace
id|DEBUG
c_func
(paren
l_int|3
comma
l_string|&quot;%s: exiting interrupt, status %4.4x.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|inw
c_func
(paren
id|ioaddr
op_plus
id|EL3_STATUS
)paren
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/*&n;    This timer serves two purposes: to check for missed interrupts&n;&t;(and as a last resort, poll the NIC for events), and to monitor&n;&t;the MII, reporting changes in cable status.&n;*/
DECL|function|media_check
r_static
r_void
id|media_check
c_func
(paren
id|u_long
id|arg
)paren
(brace
r_struct
id|el3_private
op_star
id|lp
op_assign
(paren
r_struct
id|el3_private
op_star
)paren
id|arg
suffix:semicolon
r_struct
id|net_device
op_star
id|dev
op_assign
op_amp
id|lp-&gt;dev
suffix:semicolon
id|ioaddr_t
id|ioaddr
op_assign
id|dev-&gt;base_addr
suffix:semicolon
id|u_long
id|flags
suffix:semicolon
id|u_short
multiline_comment|/* cable, */
id|media
comma
id|partner
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|netif_device_present
c_func
(paren
id|dev
)paren
)paren
r_goto
id|reschedule
suffix:semicolon
multiline_comment|/* Check for pending interrupt with expired latency timer: with&n;       this, we can limp along even if the interrupt is blocked */
r_if
c_cond
(paren
(paren
id|inw
c_func
(paren
id|ioaddr
op_plus
id|EL3_STATUS
)paren
op_amp
id|IntLatch
)paren
op_logical_and
(paren
id|inb
c_func
(paren
id|ioaddr
op_plus
id|Timer
)paren
op_eq
l_int|0xff
)paren
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|lp-&gt;fast_poll
)paren
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: interrupt(s) dropped!&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|el3_interrupt
c_func
(paren
id|dev-&gt;irq
comma
id|lp
comma
l_int|NULL
)paren
suffix:semicolon
id|lp-&gt;fast_poll
op_assign
id|HZ
suffix:semicolon
)brace
r_if
c_cond
(paren
id|lp-&gt;fast_poll
)paren
(brace
id|lp-&gt;fast_poll
op_decrement
suffix:semicolon
id|lp-&gt;media.expires
op_assign
id|jiffies
op_plus
l_int|2
suffix:semicolon
id|add_timer
c_func
(paren
op_amp
id|lp-&gt;media
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|EL3WINDOW
c_func
(paren
l_int|4
)paren
suffix:semicolon
id|media
op_assign
id|mdio_read
c_func
(paren
id|ioaddr
comma
id|lp-&gt;phys
(braket
l_int|0
)braket
comma
l_int|1
)paren
suffix:semicolon
id|partner
op_assign
id|mdio_read
c_func
(paren
id|ioaddr
comma
id|lp-&gt;phys
(braket
l_int|0
)braket
comma
l_int|5
)paren
suffix:semicolon
id|EL3WINDOW
c_func
(paren
l_int|1
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|media
op_ne
id|lp-&gt;media_status
)paren
(brace
r_if
c_cond
(paren
(paren
id|media
op_xor
id|lp-&gt;media_status
)paren
op_amp
l_int|0x0004
)paren
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: %s link beat&bslash;n&quot;
comma
id|dev-&gt;name
comma
(paren
id|lp-&gt;media_status
op_amp
l_int|0x0004
)paren
ques
c_cond
l_string|&quot;lost&quot;
suffix:colon
l_string|&quot;found&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|media
op_xor
id|lp-&gt;media_status
)paren
op_amp
l_int|0x0020
)paren
(brace
id|lp-&gt;partner
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|lp-&gt;media_status
op_amp
l_int|0x0020
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: autonegotiation restarted&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|partner
)paren
(brace
id|partner
op_and_assign
id|lp-&gt;advertising
suffix:semicolon
id|lp-&gt;partner
op_assign
id|partner
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: autonegotiation complete: &quot;
l_string|&quot;%sbaseT-%cD selected&bslash;n&quot;
comma
id|dev-&gt;name
comma
(paren
(paren
id|partner
op_amp
l_int|0x0180
)paren
ques
c_cond
l_string|&quot;100&quot;
suffix:colon
l_string|&quot;10&quot;
)paren
comma
(paren
(paren
id|partner
op_amp
l_int|0x0140
)paren
ques
c_cond
l_char|&squot;F&squot;
suffix:colon
l_char|&squot;H&squot;
)paren
)paren
suffix:semicolon
)brace
r_else
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: link partner did not autonegotiate&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
)brace
id|EL3WINDOW
c_func
(paren
l_int|3
)paren
suffix:semicolon
id|outb
c_func
(paren
(paren
id|partner
op_amp
l_int|0x0140
ques
c_cond
l_int|0x20
suffix:colon
l_int|0
)paren
op_or
(paren
id|dev-&gt;mtu
OG
l_int|1500
ques
c_cond
l_int|0x40
suffix:colon
l_int|0
)paren
comma
id|ioaddr
op_plus
id|Wn3_MAC_Ctrl
)paren
suffix:semicolon
id|EL3WINDOW
c_func
(paren
l_int|1
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|media
op_amp
l_int|0x0010
)paren
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: remote fault detected&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_if
c_cond
(paren
id|media
op_amp
l_int|0x0002
)paren
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: jabber detected&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|lp-&gt;media_status
op_assign
id|media
suffix:semicolon
)brace
id|reschedule
suffix:colon
id|lp-&gt;media.expires
op_assign
id|jiffies
op_plus
id|HZ
suffix:semicolon
id|add_timer
c_func
(paren
op_amp
id|lp-&gt;media
)paren
suffix:semicolon
)brace
DECL|function|el3_get_stats
r_static
r_struct
id|net_device_stats
op_star
id|el3_get_stats
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|el3_private
op_star
id|lp
op_assign
(paren
r_struct
id|el3_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_if
c_cond
(paren
id|netif_device_present
c_func
(paren
id|dev
)paren
)paren
id|update_stats
c_func
(paren
id|dev
)paren
suffix:semicolon
r_return
op_amp
id|lp-&gt;stats
suffix:semicolon
)brace
multiline_comment|/*  Update statistics.&n;&t;Suprisingly this need not be run single-threaded, but it effectively is.&n;&t;The counters clear when read, so the adds must merely be atomic.&n; */
DECL|function|update_stats
r_static
r_void
id|update_stats
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|el3_private
op_star
id|lp
op_assign
(paren
r_struct
id|el3_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|ioaddr_t
id|ioaddr
op_assign
id|dev-&gt;base_addr
suffix:semicolon
id|u8
id|rx
comma
id|tx
comma
id|up
suffix:semicolon
id|DEBUG
c_func
(paren
l_int|2
comma
l_string|&quot;%s: updating the statistics.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_if
c_cond
(paren
id|inw
c_func
(paren
id|ioaddr
op_plus
id|EL3_STATUS
)paren
op_eq
l_int|0xffff
)paren
multiline_comment|/* No card. */
r_return
suffix:semicolon
multiline_comment|/* Unlike the 3c509 we need not turn off stats updates while reading. */
multiline_comment|/* Switch to the stats window, and read everything. */
id|EL3WINDOW
c_func
(paren
l_int|6
)paren
suffix:semicolon
id|lp-&gt;stats.tx_carrier_errors
op_add_assign
id|inb
c_func
(paren
id|ioaddr
op_plus
l_int|0
)paren
suffix:semicolon
id|lp-&gt;stats.tx_heartbeat_errors
op_add_assign
id|inb
c_func
(paren
id|ioaddr
op_plus
l_int|1
)paren
suffix:semicolon
multiline_comment|/* Multiple collisions. */
id|inb
c_func
(paren
id|ioaddr
op_plus
l_int|2
)paren
suffix:semicolon
id|lp-&gt;stats.collisions
op_add_assign
id|inb
c_func
(paren
id|ioaddr
op_plus
l_int|3
)paren
suffix:semicolon
id|lp-&gt;stats.tx_window_errors
op_add_assign
id|inb
c_func
(paren
id|ioaddr
op_plus
l_int|4
)paren
suffix:semicolon
id|lp-&gt;stats.rx_fifo_errors
op_add_assign
id|inb
c_func
(paren
id|ioaddr
op_plus
l_int|5
)paren
suffix:semicolon
id|lp-&gt;stats.tx_packets
op_add_assign
id|inb
c_func
(paren
id|ioaddr
op_plus
l_int|6
)paren
suffix:semicolon
id|up
op_assign
id|inb
c_func
(paren
id|ioaddr
op_plus
l_int|9
)paren
suffix:semicolon
id|lp-&gt;stats.tx_packets
op_add_assign
(paren
id|up
op_amp
l_int|0x30
)paren
op_lshift
l_int|4
suffix:semicolon
multiline_comment|/* Rx packets   */
id|inb
c_func
(paren
id|ioaddr
op_plus
l_int|7
)paren
suffix:semicolon
multiline_comment|/* Tx deferrals */
id|inb
c_func
(paren
id|ioaddr
op_plus
l_int|8
)paren
suffix:semicolon
id|rx
op_assign
id|inw
c_func
(paren
id|ioaddr
op_plus
l_int|10
)paren
suffix:semicolon
id|tx
op_assign
id|inw
c_func
(paren
id|ioaddr
op_plus
l_int|12
)paren
suffix:semicolon
id|EL3WINDOW
c_func
(paren
l_int|4
)paren
suffix:semicolon
multiline_comment|/* BadSSD */
id|inb
c_func
(paren
id|ioaddr
op_plus
l_int|12
)paren
suffix:semicolon
id|up
op_assign
id|inb
c_func
(paren
id|ioaddr
op_plus
l_int|13
)paren
suffix:semicolon
id|lp-&gt;stats.rx_bytes
op_add_assign
id|rx
op_plus
(paren
(paren
id|up
op_amp
l_int|0x0f
)paren
op_lshift
l_int|16
)paren
suffix:semicolon
id|lp-&gt;stats.tx_bytes
op_add_assign
id|tx
op_plus
(paren
(paren
id|up
op_amp
l_int|0xf0
)paren
op_lshift
l_int|12
)paren
suffix:semicolon
id|EL3WINDOW
c_func
(paren
l_int|1
)paren
suffix:semicolon
)brace
DECL|function|el3_rx
r_static
r_int
id|el3_rx
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_int
id|worklimit
)paren
(brace
r_struct
id|el3_private
op_star
id|lp
op_assign
(paren
r_struct
id|el3_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|ioaddr_t
id|ioaddr
op_assign
id|dev-&gt;base_addr
suffix:semicolon
r_int
id|rx_status
suffix:semicolon
id|DEBUG
c_func
(paren
l_int|3
comma
l_string|&quot;%s: in rx_packet(), status %4.4x, rx_status %4.4x.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|inw
c_func
(paren
id|ioaddr
op_plus
id|EL3_STATUS
)paren
comma
id|inw
c_func
(paren
id|ioaddr
op_plus
id|RxStatus
)paren
)paren
suffix:semicolon
r_while
c_loop
(paren
op_logical_neg
(paren
(paren
id|rx_status
op_assign
id|inw
c_func
(paren
id|ioaddr
op_plus
id|RxStatus
)paren
)paren
op_amp
l_int|0x8000
)paren
op_logical_and
(paren
op_decrement
id|worklimit
op_ge
l_int|0
)paren
)paren
(brace
r_if
c_cond
(paren
id|rx_status
op_amp
l_int|0x4000
)paren
(brace
multiline_comment|/* Error, update stats. */
r_int
id|error
op_assign
id|rx_status
op_amp
l_int|0x3800
suffix:semicolon
id|lp-&gt;stats.rx_errors
op_increment
suffix:semicolon
r_switch
c_cond
(paren
id|error
)paren
(brace
r_case
l_int|0x0000
suffix:colon
id|lp-&gt;stats.rx_over_errors
op_increment
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x0800
suffix:colon
id|lp-&gt;stats.rx_length_errors
op_increment
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x1000
suffix:colon
id|lp-&gt;stats.rx_frame_errors
op_increment
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x1800
suffix:colon
id|lp-&gt;stats.rx_length_errors
op_increment
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x2000
suffix:colon
id|lp-&gt;stats.rx_frame_errors
op_increment
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x2800
suffix:colon
id|lp-&gt;stats.rx_crc_errors
op_increment
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
r_else
(brace
r_int
id|pkt_len
op_assign
id|rx_status
op_amp
l_int|0x7ff
suffix:semicolon
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
id|skb
op_assign
id|dev_alloc_skb
c_func
(paren
id|pkt_len
op_plus
l_int|5
)paren
suffix:semicolon
id|DEBUG
c_func
(paren
l_int|3
comma
l_string|&quot;  Receiving packet size %d status %4.4x.&bslash;n&quot;
comma
id|pkt_len
comma
id|rx_status
)paren
suffix:semicolon
r_if
c_cond
(paren
id|skb
op_ne
l_int|NULL
)paren
(brace
id|skb-&gt;dev
op_assign
id|dev
suffix:semicolon
id|skb_reserve
c_func
(paren
id|skb
comma
l_int|2
)paren
suffix:semicolon
id|insl
c_func
(paren
id|ioaddr
op_plus
id|RX_FIFO
comma
id|skb_put
c_func
(paren
id|skb
comma
id|pkt_len
)paren
comma
(paren
(paren
id|pkt_len
op_plus
l_int|3
)paren
op_rshift
l_int|2
)paren
)paren
suffix:semicolon
id|skb-&gt;protocol
op_assign
id|eth_type_trans
c_func
(paren
id|skb
comma
id|dev
)paren
suffix:semicolon
id|netif_rx
c_func
(paren
id|skb
)paren
suffix:semicolon
id|lp-&gt;stats.rx_packets
op_increment
suffix:semicolon
)brace
r_else
(brace
id|DEBUG
c_func
(paren
l_int|1
comma
l_string|&quot;%s: couldn&squot;t allocate a sk_buff of&quot;
l_string|&quot; size %d.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|pkt_len
)paren
suffix:semicolon
id|lp-&gt;stats.rx_dropped
op_increment
suffix:semicolon
)brace
)brace
id|wait_for_completion
c_func
(paren
id|dev
comma
id|RxDiscard
)paren
suffix:semicolon
)brace
r_return
id|worklimit
suffix:semicolon
)brace
multiline_comment|/* Provide ioctl() calls to examine the MII xcvr state. */
DECL|function|el3_ioctl
r_static
r_int
id|el3_ioctl
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_struct
id|ifreq
op_star
id|rq
comma
r_int
id|cmd
)paren
(brace
r_struct
id|el3_private
op_star
id|lp
op_assign
(paren
r_struct
id|el3_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|ioaddr_t
id|ioaddr
op_assign
id|dev-&gt;base_addr
suffix:semicolon
id|u16
op_star
id|data
op_assign
(paren
id|u16
op_star
)paren
op_amp
id|rq-&gt;ifr_data
suffix:semicolon
r_int
id|phy
op_assign
id|lp-&gt;phys
(braket
l_int|0
)braket
op_amp
l_int|0x1f
suffix:semicolon
id|DEBUG
c_func
(paren
l_int|2
comma
l_string|&quot;%s: In ioct(%-.6s, %#4.4x) %4.4x %4.4x %4.4x %4.4x.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|rq-&gt;ifr_ifrn.ifrn_name
comma
id|cmd
comma
id|data
(braket
l_int|0
)braket
comma
id|data
(braket
l_int|1
)braket
comma
id|data
(braket
l_int|2
)braket
comma
id|data
(braket
l_int|3
)braket
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|cmd
)paren
(brace
r_case
id|SIOCDEVPRIVATE
suffix:colon
multiline_comment|/* Get the address of the PHY in use. */
id|data
(braket
l_int|0
)braket
op_assign
id|phy
suffix:semicolon
r_case
id|SIOCDEVPRIVATE
op_plus
l_int|1
suffix:colon
multiline_comment|/* Read the specified MII register. */
(brace
r_int
id|saved_window
suffix:semicolon
r_int
id|flags
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|saved_window
op_assign
id|inw
c_func
(paren
id|ioaddr
op_plus
id|EL3_CMD
)paren
op_rshift
l_int|13
suffix:semicolon
id|EL3WINDOW
c_func
(paren
l_int|4
)paren
suffix:semicolon
id|data
(braket
l_int|3
)braket
op_assign
id|mdio_read
c_func
(paren
id|ioaddr
comma
id|data
(braket
l_int|0
)braket
op_amp
l_int|0x1f
comma
id|data
(braket
l_int|1
)braket
op_amp
l_int|0x1f
)paren
suffix:semicolon
id|EL3WINDOW
c_func
(paren
id|saved_window
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_case
id|SIOCDEVPRIVATE
op_plus
l_int|2
suffix:colon
multiline_comment|/* Write the specified MII register */
(brace
r_int
id|saved_window
suffix:semicolon
r_int
id|flags
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|capable
c_func
(paren
id|CAP_NET_ADMIN
)paren
)paren
r_return
op_minus
id|EPERM
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|saved_window
op_assign
id|inw
c_func
(paren
id|ioaddr
op_plus
id|EL3_CMD
)paren
op_rshift
l_int|13
suffix:semicolon
id|EL3WINDOW
c_func
(paren
l_int|4
)paren
suffix:semicolon
id|mdio_write
c_func
(paren
id|ioaddr
comma
id|data
(braket
l_int|0
)braket
op_amp
l_int|0x1f
comma
id|data
(braket
l_int|1
)braket
op_amp
l_int|0x1f
comma
id|data
(braket
l_int|2
)braket
)paren
suffix:semicolon
id|EL3WINDOW
c_func
(paren
id|saved_window
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_default
suffix:colon
r_return
op_minus
id|EOPNOTSUPP
suffix:semicolon
)brace
)brace
multiline_comment|/* The Odie chip has a 64 bin multicast filter, but the bit layout is not&n;   documented.  Until it is we revert to receiving all multicast frames when&n;   any multicast reception is desired.&n;   Note: My other drivers emit a log message whenever promiscuous mode is&n;   entered to help detect password sniffers.  This is less desirable on&n;   typical PC card machines, so we omit the message.&n;   */
DECL|function|set_rx_mode
r_static
r_void
id|set_rx_mode
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
id|ioaddr_t
id|ioaddr
op_assign
id|dev-&gt;base_addr
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;flags
op_amp
id|IFF_PROMISC
)paren
id|outw
c_func
(paren
id|SetRxFilter
op_or
id|RxStation
op_or
id|RxMulticast
op_or
id|RxBroadcast
op_or
id|RxProm
comma
id|ioaddr
op_plus
id|EL3_CMD
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
id|dev-&gt;mc_count
op_logical_or
(paren
id|dev-&gt;flags
op_amp
id|IFF_ALLMULTI
)paren
)paren
id|outw
c_func
(paren
id|SetRxFilter
op_or
id|RxStation
op_or
id|RxMulticast
op_or
id|RxBroadcast
comma
id|ioaddr
op_plus
id|EL3_CMD
)paren
suffix:semicolon
r_else
id|outw
c_func
(paren
id|SetRxFilter
op_or
id|RxStation
op_or
id|RxBroadcast
comma
id|ioaddr
op_plus
id|EL3_CMD
)paren
suffix:semicolon
)brace
DECL|function|el3_close
r_static
r_int
id|el3_close
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
id|ioaddr_t
id|ioaddr
op_assign
id|dev-&gt;base_addr
suffix:semicolon
r_struct
id|el3_private
op_star
id|lp
op_assign
id|dev-&gt;priv
suffix:semicolon
id|dev_link_t
op_star
id|link
op_assign
op_amp
id|lp-&gt;link
suffix:semicolon
id|DEBUG
c_func
(paren
l_int|2
comma
l_string|&quot;%s: shutting down ethercard.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_if
c_cond
(paren
id|DEV_OK
c_func
(paren
id|link
)paren
)paren
(brace
multiline_comment|/* Turn off statistics ASAP.  We update lp-&gt;stats below. */
id|outw
c_func
(paren
id|StatsDisable
comma
id|ioaddr
op_plus
id|EL3_CMD
)paren
suffix:semicolon
multiline_comment|/* Disable the receiver and transmitter. */
id|outw
c_func
(paren
id|RxDisable
comma
id|ioaddr
op_plus
id|EL3_CMD
)paren
suffix:semicolon
id|outw
c_func
(paren
id|TxDisable
comma
id|ioaddr
op_plus
id|EL3_CMD
)paren
suffix:semicolon
multiline_comment|/* Note: Switching to window 0 may disable the IRQ. */
id|EL3WINDOW
c_func
(paren
l_int|0
)paren
suffix:semicolon
id|update_stats
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
id|link-&gt;open
op_decrement
suffix:semicolon
id|netif_stop_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
id|del_timer
c_func
(paren
op_amp
id|lp-&gt;media
)paren
suffix:semicolon
r_if
c_cond
(paren
id|link-&gt;state
op_amp
id|DEV_STALE_CONFIG
)paren
id|mod_timer
c_func
(paren
op_amp
id|link-&gt;release
comma
id|jiffies
op_plus
id|HZ
op_div
l_int|20
)paren
suffix:semicolon
id|MOD_DEC_USE_COUNT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|init_3c574_cs
r_static
r_int
id|__init
id|init_3c574_cs
c_func
(paren
r_void
)paren
(brace
id|servinfo_t
id|serv
suffix:semicolon
multiline_comment|/* Always emit the version, before any failure. */
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s&quot;
comma
id|tc574_version
)paren
suffix:semicolon
id|DEBUG
c_func
(paren
l_int|0
comma
l_string|&quot;%s&bslash;n&quot;
comma
id|version
)paren
suffix:semicolon
id|CardServices
c_func
(paren
id|GetCardServicesInfo
comma
op_amp
id|serv
)paren
suffix:semicolon
r_if
c_cond
(paren
id|serv.Revision
op_ne
id|CS_RELEASE_CODE
)paren
(brace
id|printk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;3c574_cs: Card Services release &quot;
l_string|&quot;does not match!&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|register_pccard_driver
c_func
(paren
op_amp
id|dev_info
comma
op_amp
id|tc574_attach
comma
op_amp
id|tc574_detach
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|exit_3c574_cs
r_static
r_void
id|__exit
id|exit_3c574_cs
c_func
(paren
r_void
)paren
(brace
id|DEBUG
c_func
(paren
l_int|0
comma
l_string|&quot;3c574_cs: unloading&bslash;n&quot;
)paren
suffix:semicolon
id|unregister_pccard_driver
c_func
(paren
op_amp
id|dev_info
)paren
suffix:semicolon
r_while
c_loop
(paren
id|dev_list
op_ne
l_int|NULL
)paren
id|tc574_detach
c_func
(paren
id|dev_list
)paren
suffix:semicolon
)brace
DECL|variable|init_3c574_cs
id|module_init
c_func
(paren
id|init_3c574_cs
)paren
suffix:semicolon
DECL|variable|exit_3c574_cs
id|module_exit
c_func
(paren
id|exit_3c574_cs
)paren
suffix:semicolon
multiline_comment|/*&n; * Local variables:&n; *  compile-command: &quot;make 3c574_cs.o&quot;&n; *  c-indent-level: 4&n; *  c-basic-offset: 4&n; *  tab-width: 4&n; * End:&n; */
eof
