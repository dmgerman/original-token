multiline_comment|/* ----------------------------------------------------------------------------&n;Linux PCMCIA ethernet adapter driver for the New Media Ethernet LAN.&n;  nmclan_cs.c,v 0.16 1995/07/01 06:42:17 rpao Exp rpao&n;&n;  The Ethernet LAN uses the Advanced Micro Devices (AMD) Am79C940 Media&n;  Access Controller for Ethernet (MACE).  It is essentially the Am2150&n;  PCMCIA Ethernet card contained in the the Am2150 Demo Kit.&n;&n;Written by Roger C. Pao &lt;rpao@paonet.org&gt;&n;  Copyright 1995 Roger C. Pao&n;&n;  This software may be used and distributed according to the terms of&n;  the GNU Public License.&n;&n;Ported to Linux 1.3.* network driver environment by&n;  Matti Aarnio &lt;mea@utu.fi&gt;&n;&n;References&n;&n;  Am2150 Technical Reference Manual, Revision 1.0, August 17, 1993&n;  Am79C940 (MACE) Data Sheet, 1994&n;  Am79C90 (C-LANCE) Data Sheet, 1994&n;  Linux PCMCIA Programmer&squot;s Guide v1.17&n;  /usr/src/linux/net/inet/dev.c, Linux kernel 1.2.8&n;&n;  Eric Mears, New Media Corporation&n;  Tom Pollard, New Media Corporation&n;  Dean Siasoyco, New Media Corporation&n;  Ken Lesniak, Silicon Graphics, Inc. &lt;lesniak@boston.sgi.com&gt;&n;  Donald Becker &lt;becker@cesdis1.gsfc.nasa.gov&gt;&n;  David Hinds &lt;dahinds@users.sourceforge.net&gt;&n;&n;  The Linux client driver is based on the 3c589_cs.c client driver by&n;  David Hinds.&n;&n;  The Linux network driver outline is based on the 3c589_cs.c driver,&n;  the 8390.c driver, and the example skeleton.c kernel code, which are&n;  by Donald Becker.&n;&n;  The Am2150 network driver hardware interface code is based on the&n;  OS/9000 driver for the New Media Ethernet LAN by Eric Mears.&n;&n;  Special thanks for testing and help in debugging this driver goes&n;  to Ken Lesniak.&n;&n;-------------------------------------------------------------------------------&n;Driver Notes and Issues&n;-------------------------------------------------------------------------------&n;&n;1. Developed on a Dell 320SLi&n;   PCMCIA Card Services 2.6.2&n;   Linux dell 1.2.10 #1 Thu Jun 29 20:23:41 PDT 1995 i386&n;&n;2. rc.pcmcia may require loading pcmcia_core with io_speed=300:&n;   &squot;insmod pcmcia_core.o io_speed=300&squot;.&n;   This will avoid problems with fast systems which causes rx_framecnt&n;   to return random values.&n;&n;3. If hot extraction does not work for you, use &squot;ifconfig eth0 down&squot;&n;   before extraction.&n;&n;4. There is a bad slow-down problem in this driver.&n;&n;5. Future: Multicast processing.  In the meantime, do _not_ compile your&n;   kernel with multicast ip enabled.&n;&n;-------------------------------------------------------------------------------&n;History&n;-------------------------------------------------------------------------------&n;Log: nmclan_cs.c,v&n; * Revision 0.16  1995/07/01  06:42:17  rpao&n; * Bug fix: nmclan_reset() called CardServices incorrectly.&n; *&n; * Revision 0.15  1995/05/24  08:09:47  rpao&n; * Re-implement MULTI_TX dev-&gt;tbusy handling.&n; *&n; * Revision 0.14  1995/05/23  03:19:30  rpao&n; * Added, in nmclan_config(), &quot;tuple.Attributes = 0;&quot;.&n; * Modified MACE ID check to ignore chip revision level.&n; * Avoid tx_free_frames race condition between _start_xmit and _interrupt.&n; *&n; * Revision 0.13  1995/05/18  05:56:34  rpao&n; * Statistics changes.&n; * Bug fix: nmclan_reset did not enable TX and RX: call restore_multicast_list.&n; * Bug fix: mace_interrupt checks ~MACE_IMR_DEFAULT.  Fixes driver lockup.&n; *&n; * Revision 0.12  1995/05/14  00:12:23  rpao&n; * Statistics overhaul.&n; *&n;&n;95/05/13 rpao&t;V0.10a&n;&t;&t;Bug fix: MACE statistics counters used wrong I/O ports.&n;&t;&t;Bug fix: mace_interrupt() needed to allow statistics to be&n;&t;&t;processed without RX or TX interrupts pending.&n;95/05/11 rpao&t;V0.10&n;&t;&t;Multiple transmit request processing.&n;&t;&t;Modified statistics to use MACE counters where possible.&n;95/05/10 rpao&t;V0.09 Bug fix: Must use IO_DATA_PATH_WIDTH_AUTO.&n;&t;&t;*Released&n;95/05/10 rpao&t;V0.08&n;&t;&t;Bug fix: Make all non-exported functions private by using&n;&t;&t;static keyword.&n;&t;&t;Bug fix: Test IntrCnt _before_ reading MACE_IR.&n;95/05/10 rpao&t;V0.07 Statistics.&n;95/05/09 rpao&t;V0.06 Fix rx_framecnt problem by addition of PCIC wait states.&n;&n;---------------------------------------------------------------------------- */
multiline_comment|/* ----------------------------------------------------------------------------&n;Conditional Compilation Options&n;---------------------------------------------------------------------------- */
DECL|macro|MULTI_TX
mdefine_line|#define MULTI_TX&t;&t;&t;0
DECL|macro|RESET_ON_TIMEOUT
mdefine_line|#define RESET_ON_TIMEOUT&t;&t;1
DECL|macro|TX_INTERRUPTABLE
mdefine_line|#define TX_INTERRUPTABLE&t;&t;1
DECL|macro|RESET_XILINX
mdefine_line|#define RESET_XILINX&t;&t;&t;0
multiline_comment|/* ----------------------------------------------------------------------------&n;Include Files&n;---------------------------------------------------------------------------- */
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/ptrace.h&gt;
macro_line|#include &lt;linux/malloc.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/timer.h&gt;
macro_line|#include &lt;linux/interrupt.h&gt;
macro_line|#include &lt;linux/in.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/system.h&gt;
macro_line|#include &lt;asm/bitops.h&gt;
macro_line|#include &lt;linux/netdevice.h&gt;
macro_line|#include &lt;linux/etherdevice.h&gt;
macro_line|#include &lt;linux/skbuff.h&gt;
macro_line|#include &lt;linux/if_arp.h&gt;
macro_line|#include &lt;linux/ioport.h&gt;
macro_line|#include &lt;pcmcia/version.h&gt;
macro_line|#include &lt;pcmcia/cs_types.h&gt;
macro_line|#include &lt;pcmcia/cs.h&gt;
macro_line|#include &lt;pcmcia/cisreg.h&gt;
macro_line|#include &lt;pcmcia/cistpl.h&gt;
macro_line|#include &lt;pcmcia/ds.h&gt;
multiline_comment|/* ----------------------------------------------------------------------------&n;Defines&n;---------------------------------------------------------------------------- */
DECL|macro|ETHER_ADDR_LEN
mdefine_line|#define ETHER_ADDR_LEN&t;&t;&t;ETH_ALEN
multiline_comment|/* 6 bytes in an Ethernet Address */
DECL|macro|MACE_LADRF_LEN
mdefine_line|#define MACE_LADRF_LEN&t;&t;&t;8
multiline_comment|/* 8 bytes in Logical Address Filter */
multiline_comment|/* Loop Control Defines */
DECL|macro|MACE_MAX_IR_ITERATIONS
mdefine_line|#define MACE_MAX_IR_ITERATIONS&t;&t;10
DECL|macro|MACE_MAX_RX_ITERATIONS
mdefine_line|#define MACE_MAX_RX_ITERATIONS&t;&t;12
multiline_comment|/*&n;&t;TBD: Dean brought this up, and I assumed the hardware would&n;&t;handle it:&n;&n;&t;If MACE_MAX_RX_ITERATIONS is &gt; 1, rx_framecnt may still be&n;&t;non-zero when the isr exits.  We may not get another interrupt&n;&t;to process the remaining packets for some time.&n;&t;*/
multiline_comment|/*&n;The Am2150 has a Xilinx XC3042 field programmable gate array (FPGA)&n;which manages the interface between the MACE and the PCMCIA bus.  It&n;also includes buffer management for the 32K x 8 SRAM to control up to&n;four transmit and 12 receive frames at a time.&n;*/
DECL|macro|AM2150_MAX_TX_FRAMES
mdefine_line|#define AM2150_MAX_TX_FRAMES&t;&t;4
DECL|macro|AM2150_MAX_RX_FRAMES
mdefine_line|#define AM2150_MAX_RX_FRAMES&t;&t;12
multiline_comment|/* Am2150 Ethernet Card I/O Mapping */
DECL|macro|AM2150_RCV
mdefine_line|#define AM2150_RCV&t;&t;&t;0x00
DECL|macro|AM2150_XMT
mdefine_line|#define AM2150_XMT&t;&t;&t;0x04
DECL|macro|AM2150_XMT_SKIP
mdefine_line|#define AM2150_XMT_SKIP&t;&t;&t;0x09
DECL|macro|AM2150_RCV_NEXT
mdefine_line|#define AM2150_RCV_NEXT&t;&t;&t;0x0A
DECL|macro|AM2150_RCV_FRAME_COUNT
mdefine_line|#define AM2150_RCV_FRAME_COUNT&t;&t;0x0B
DECL|macro|AM2150_MACE_BANK
mdefine_line|#define AM2150_MACE_BANK&t;&t;0x0C
DECL|macro|AM2150_MACE_BASE
mdefine_line|#define AM2150_MACE_BASE&t;&t;0x10
multiline_comment|/* MACE Registers */
DECL|macro|MACE_RCVFIFO
mdefine_line|#define MACE_RCVFIFO&t;&t;&t;0
DECL|macro|MACE_XMTFIFO
mdefine_line|#define MACE_XMTFIFO&t;&t;&t;1
DECL|macro|MACE_XMTFC
mdefine_line|#define MACE_XMTFC&t;&t;&t;2
DECL|macro|MACE_XMTFS
mdefine_line|#define MACE_XMTFS&t;&t;&t;3
DECL|macro|MACE_XMTRC
mdefine_line|#define MACE_XMTRC&t;&t;&t;4
DECL|macro|MACE_RCVFC
mdefine_line|#define MACE_RCVFC&t;&t;&t;5
DECL|macro|MACE_RCVFS
mdefine_line|#define MACE_RCVFS&t;&t;&t;6
DECL|macro|MACE_FIFOFC
mdefine_line|#define MACE_FIFOFC&t;&t;&t;7
DECL|macro|MACE_IR
mdefine_line|#define MACE_IR&t;&t;&t;&t;8
DECL|macro|MACE_IMR
mdefine_line|#define MACE_IMR&t;&t;&t;9
DECL|macro|MACE_PR
mdefine_line|#define MACE_PR&t;&t;&t;&t;10
DECL|macro|MACE_BIUCC
mdefine_line|#define MACE_BIUCC&t;&t;&t;11
DECL|macro|MACE_FIFOCC
mdefine_line|#define MACE_FIFOCC&t;&t;&t;12
DECL|macro|MACE_MACCC
mdefine_line|#define MACE_MACCC&t;&t;&t;13
DECL|macro|MACE_PLSCC
mdefine_line|#define MACE_PLSCC&t;&t;&t;14
DECL|macro|MACE_PHYCC
mdefine_line|#define MACE_PHYCC&t;&t;&t;15
DECL|macro|MACE_CHIPIDL
mdefine_line|#define MACE_CHIPIDL&t;&t;&t;16
DECL|macro|MACE_CHIPIDH
mdefine_line|#define MACE_CHIPIDH&t;&t;&t;17
DECL|macro|MACE_IAC
mdefine_line|#define MACE_IAC&t;&t;&t;18
multiline_comment|/* Reserved */
DECL|macro|MACE_LADRF
mdefine_line|#define MACE_LADRF&t;&t;&t;20
DECL|macro|MACE_PADR
mdefine_line|#define MACE_PADR&t;&t;&t;21
multiline_comment|/* Reserved */
multiline_comment|/* Reserved */
DECL|macro|MACE_MPC
mdefine_line|#define MACE_MPC&t;&t;&t;24
multiline_comment|/* Reserved */
DECL|macro|MACE_RNTPC
mdefine_line|#define MACE_RNTPC&t;&t;&t;26
DECL|macro|MACE_RCVCC
mdefine_line|#define MACE_RCVCC&t;&t;&t;27
multiline_comment|/* Reserved */
DECL|macro|MACE_UTR
mdefine_line|#define MACE_UTR&t;&t;&t;29
DECL|macro|MACE_RTR1
mdefine_line|#define MACE_RTR1&t;&t;&t;30
DECL|macro|MACE_RTR2
mdefine_line|#define MACE_RTR2&t;&t;&t;31
multiline_comment|/* MACE Bit Masks */
DECL|macro|MACE_XMTRC_EXDEF
mdefine_line|#define MACE_XMTRC_EXDEF&t;&t;0x80
DECL|macro|MACE_XMTRC_XMTRC
mdefine_line|#define MACE_XMTRC_XMTRC&t;&t;0x0F
DECL|macro|MACE_XMTFS_XMTSV
mdefine_line|#define MACE_XMTFS_XMTSV&t;&t;0x80
DECL|macro|MACE_XMTFS_UFLO
mdefine_line|#define MACE_XMTFS_UFLO&t;&t;&t;0x40
DECL|macro|MACE_XMTFS_LCOL
mdefine_line|#define MACE_XMTFS_LCOL&t;&t;&t;0x20
DECL|macro|MACE_XMTFS_MORE
mdefine_line|#define MACE_XMTFS_MORE&t;&t;&t;0x10
DECL|macro|MACE_XMTFS_ONE
mdefine_line|#define MACE_XMTFS_ONE&t;&t;&t;0x08
DECL|macro|MACE_XMTFS_DEFER
mdefine_line|#define MACE_XMTFS_DEFER&t;&t;0x04
DECL|macro|MACE_XMTFS_LCAR
mdefine_line|#define MACE_XMTFS_LCAR&t;&t;&t;0x02
DECL|macro|MACE_XMTFS_RTRY
mdefine_line|#define MACE_XMTFS_RTRY&t;&t;&t;0x01
DECL|macro|MACE_RCVFS_RCVSTS
mdefine_line|#define MACE_RCVFS_RCVSTS&t;&t;0xF000
DECL|macro|MACE_RCVFS_OFLO
mdefine_line|#define MACE_RCVFS_OFLO&t;&t;&t;0x8000
DECL|macro|MACE_RCVFS_CLSN
mdefine_line|#define MACE_RCVFS_CLSN&t;&t;&t;0x4000
DECL|macro|MACE_RCVFS_FRAM
mdefine_line|#define MACE_RCVFS_FRAM&t;&t;&t;0x2000
DECL|macro|MACE_RCVFS_FCS
mdefine_line|#define MACE_RCVFS_FCS&t;&t;&t;0x1000
DECL|macro|MACE_FIFOFC_RCVFC
mdefine_line|#define MACE_FIFOFC_RCVFC&t;&t;0xF0
DECL|macro|MACE_FIFOFC_XMTFC
mdefine_line|#define MACE_FIFOFC_XMTFC&t;&t;0x0F
DECL|macro|MACE_IR_JAB
mdefine_line|#define MACE_IR_JAB&t;&t;&t;0x80
DECL|macro|MACE_IR_BABL
mdefine_line|#define MACE_IR_BABL&t;&t;&t;0x40
DECL|macro|MACE_IR_CERR
mdefine_line|#define MACE_IR_CERR&t;&t;&t;0x20
DECL|macro|MACE_IR_RCVCCO
mdefine_line|#define MACE_IR_RCVCCO&t;&t;&t;0x10
DECL|macro|MACE_IR_RNTPCO
mdefine_line|#define MACE_IR_RNTPCO&t;&t;&t;0x08
DECL|macro|MACE_IR_MPCO
mdefine_line|#define MACE_IR_MPCO&t;&t;&t;0x04
DECL|macro|MACE_IR_RCVINT
mdefine_line|#define MACE_IR_RCVINT&t;&t;&t;0x02
DECL|macro|MACE_IR_XMTINT
mdefine_line|#define MACE_IR_XMTINT&t;&t;&t;0x01
DECL|macro|MACE_MACCC_PROM
mdefine_line|#define MACE_MACCC_PROM&t;&t;&t;0x80
DECL|macro|MACE_MACCC_DXMT2PD
mdefine_line|#define MACE_MACCC_DXMT2PD&t;&t;0x40
DECL|macro|MACE_MACCC_EMBA
mdefine_line|#define MACE_MACCC_EMBA&t;&t;&t;0x20
DECL|macro|MACE_MACCC_RESERVED
mdefine_line|#define MACE_MACCC_RESERVED&t;&t;0x10
DECL|macro|MACE_MACCC_DRCVPA
mdefine_line|#define MACE_MACCC_DRCVPA&t;&t;0x08
DECL|macro|MACE_MACCC_DRCVBC
mdefine_line|#define MACE_MACCC_DRCVBC&t;&t;0x04
DECL|macro|MACE_MACCC_ENXMT
mdefine_line|#define MACE_MACCC_ENXMT&t;&t;0x02
DECL|macro|MACE_MACCC_ENRCV
mdefine_line|#define MACE_MACCC_ENRCV&t;&t;0x01
DECL|macro|MACE_PHYCC_LNKFL
mdefine_line|#define MACE_PHYCC_LNKFL&t;&t;0x80
DECL|macro|MACE_PHYCC_DLNKTST
mdefine_line|#define MACE_PHYCC_DLNKTST&t;&t;0x40
DECL|macro|MACE_PHYCC_REVPOL
mdefine_line|#define MACE_PHYCC_REVPOL&t;&t;0x20
DECL|macro|MACE_PHYCC_DAPC
mdefine_line|#define MACE_PHYCC_DAPC&t;&t;&t;0x10
DECL|macro|MACE_PHYCC_LRT
mdefine_line|#define MACE_PHYCC_LRT&t;&t;&t;0x08
DECL|macro|MACE_PHYCC_ASEL
mdefine_line|#define MACE_PHYCC_ASEL&t;&t;&t;0x04
DECL|macro|MACE_PHYCC_RWAKE
mdefine_line|#define MACE_PHYCC_RWAKE&t;&t;0x02
DECL|macro|MACE_PHYCC_AWAKE
mdefine_line|#define MACE_PHYCC_AWAKE&t;&t;0x01
DECL|macro|MACE_IAC_ADDRCHG
mdefine_line|#define MACE_IAC_ADDRCHG&t;&t;0x80
DECL|macro|MACE_IAC_PHYADDR
mdefine_line|#define MACE_IAC_PHYADDR&t;&t;0x04
DECL|macro|MACE_IAC_LOGADDR
mdefine_line|#define MACE_IAC_LOGADDR&t;&t;0x02
DECL|macro|MACE_UTR_RTRE
mdefine_line|#define MACE_UTR_RTRE&t;&t;&t;0x80
DECL|macro|MACE_UTR_RTRD
mdefine_line|#define MACE_UTR_RTRD&t;&t;&t;0x40
DECL|macro|MACE_UTR_RPA
mdefine_line|#define MACE_UTR_RPA&t;&t;&t;0x20
DECL|macro|MACE_UTR_FCOLL
mdefine_line|#define MACE_UTR_FCOLL&t;&t;&t;0x10
DECL|macro|MACE_UTR_RCVFCSE
mdefine_line|#define MACE_UTR_RCVFCSE&t;&t;0x08
DECL|macro|MACE_UTR_LOOP_INCL_MENDEC
mdefine_line|#define MACE_UTR_LOOP_INCL_MENDEC&t;0x06
DECL|macro|MACE_UTR_LOOP_NO_MENDEC
mdefine_line|#define MACE_UTR_LOOP_NO_MENDEC&t;&t;0x04
DECL|macro|MACE_UTR_LOOP_EXTERNAL
mdefine_line|#define MACE_UTR_LOOP_EXTERNAL&t;&t;0x02
DECL|macro|MACE_UTR_LOOP_NONE
mdefine_line|#define MACE_UTR_LOOP_NONE&t;&t;0x00
DECL|macro|MACE_UTR_RESERVED
mdefine_line|#define MACE_UTR_RESERVED&t;&t;0x01
multiline_comment|/* Switch MACE register bank (only 0 and 1 are valid) */
DECL|macro|MACEBANK
mdefine_line|#define MACEBANK(win_num) outb((win_num), ioaddr + AM2150_MACE_BANK)
DECL|macro|MACE_IMR_DEFAULT
mdefine_line|#define MACE_IMR_DEFAULT &bslash;&n;  (0xFF - &bslash;&n;    ( &bslash;&n;      MACE_IR_CERR | &bslash;&n;      MACE_IR_RCVCCO | &bslash;&n;      MACE_IR_RNTPCO | &bslash;&n;      MACE_IR_MPCO | &bslash;&n;      MACE_IR_RCVINT | &bslash;&n;      MACE_IR_XMTINT &bslash;&n;    ) &bslash;&n;  )
DECL|macro|MACE_IMR_DEFAULT
macro_line|#undef MACE_IMR_DEFAULT
DECL|macro|MACE_IMR_DEFAULT
mdefine_line|#define MACE_IMR_DEFAULT 0x00 /* New statistics handling: grab everything */
DECL|macro|TX_TIMEOUT
mdefine_line|#define TX_TIMEOUT&t;&t;((400*HZ)/1000)
multiline_comment|/* ----------------------------------------------------------------------------&n;Type Definitions&n;---------------------------------------------------------------------------- */
DECL|struct|_mace_statistics
r_typedef
r_struct
id|_mace_statistics
(brace
multiline_comment|/* MACE_XMTFS */
DECL|member|xmtsv
r_int
id|xmtsv
suffix:semicolon
DECL|member|uflo
r_int
id|uflo
suffix:semicolon
DECL|member|lcol
r_int
id|lcol
suffix:semicolon
DECL|member|more
r_int
id|more
suffix:semicolon
DECL|member|one
r_int
id|one
suffix:semicolon
DECL|member|defer
r_int
id|defer
suffix:semicolon
DECL|member|lcar
r_int
id|lcar
suffix:semicolon
DECL|member|rtry
r_int
id|rtry
suffix:semicolon
multiline_comment|/* MACE_XMTRC */
DECL|member|exdef
r_int
id|exdef
suffix:semicolon
DECL|member|xmtrc
r_int
id|xmtrc
suffix:semicolon
multiline_comment|/* RFS1--Receive Status (RCVSTS) */
DECL|member|oflo
r_int
id|oflo
suffix:semicolon
DECL|member|clsn
r_int
id|clsn
suffix:semicolon
DECL|member|fram
r_int
id|fram
suffix:semicolon
DECL|member|fcs
r_int
id|fcs
suffix:semicolon
multiline_comment|/* RFS2--Runt Packet Count (RNTPC) */
DECL|member|rfs_rntpc
r_int
id|rfs_rntpc
suffix:semicolon
multiline_comment|/* RFS3--Receive Collision Count (RCVCC) */
DECL|member|rfs_rcvcc
r_int
id|rfs_rcvcc
suffix:semicolon
multiline_comment|/* MACE_IR */
DECL|member|jab
r_int
id|jab
suffix:semicolon
DECL|member|babl
r_int
id|babl
suffix:semicolon
DECL|member|cerr
r_int
id|cerr
suffix:semicolon
DECL|member|rcvcco
r_int
id|rcvcco
suffix:semicolon
DECL|member|rntpco
r_int
id|rntpco
suffix:semicolon
DECL|member|mpco
r_int
id|mpco
suffix:semicolon
multiline_comment|/* MACE_MPC */
DECL|member|mpc
r_int
id|mpc
suffix:semicolon
multiline_comment|/* MACE_RNTPC */
DECL|member|rntpc
r_int
id|rntpc
suffix:semicolon
multiline_comment|/* MACE_RCVCC */
DECL|member|rcvcc
r_int
id|rcvcc
suffix:semicolon
DECL|typedef|mace_statistics
)brace
id|mace_statistics
suffix:semicolon
DECL|struct|_mace_private
r_typedef
r_struct
id|_mace_private
(brace
DECL|member|link
id|dev_link_t
id|link
suffix:semicolon
DECL|member|dev
r_struct
id|net_device
id|dev
suffix:semicolon
DECL|member|node
id|dev_node_t
id|node
suffix:semicolon
DECL|member|linux_stats
r_struct
id|net_device_stats
id|linux_stats
suffix:semicolon
multiline_comment|/* Linux statistics counters */
DECL|member|mace_stats
id|mace_statistics
id|mace_stats
suffix:semicolon
multiline_comment|/* MACE chip statistics counters */
multiline_comment|/* restore_multicast_list() state variables */
DECL|member|multicast_ladrf
r_int
id|multicast_ladrf
(braket
id|MACE_LADRF_LEN
)braket
suffix:semicolon
multiline_comment|/* Logical address filter */
DECL|member|multicast_num_addrs
r_int
id|multicast_num_addrs
suffix:semicolon
DECL|member|tx_free_frames
r_char
id|tx_free_frames
suffix:semicolon
multiline_comment|/* Number of free transmit frame buffers */
DECL|member|tx_irq_disabled
r_char
id|tx_irq_disabled
suffix:semicolon
multiline_comment|/* MACE TX interrupt disabled */
DECL|typedef|mace_private
)brace
id|mace_private
suffix:semicolon
multiline_comment|/* ----------------------------------------------------------------------------&n;Private Global Variables&n;---------------------------------------------------------------------------- */
macro_line|#ifdef PCMCIA_DEBUG
DECL|variable|rcsid
r_static
r_char
id|rcsid
(braket
)braket
op_assign
l_string|&quot;nmclan_cs.c,v 0.16 1995/07/01 06:42:17 rpao Exp rpao&quot;
suffix:semicolon
DECL|variable|version
r_static
r_char
op_star
id|version
op_assign
l_string|&quot;nmclan_cs 0.16 (Roger C. Pao)&quot;
suffix:semicolon
macro_line|#endif
DECL|variable|dev_info
r_static
id|dev_info_t
id|dev_info
op_assign
l_string|&quot;nmclan_cs&quot;
suffix:semicolon
DECL|variable|dev_list
r_static
id|dev_link_t
op_star
id|dev_list
op_assign
l_int|NULL
suffix:semicolon
DECL|variable|if_names
r_static
r_char
op_star
id|if_names
(braket
)braket
op_assign
initialization_block
suffix:semicolon
macro_line|#ifdef PCMCIA_DEBUG
DECL|variable|pc_debug
r_static
r_int
id|pc_debug
op_assign
id|PCMCIA_DEBUG
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|pc_debug
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
DECL|macro|DEBUG
mdefine_line|#define DEBUG(n, args...) if (pc_debug&gt;(n)) printk(KERN_DEBUG args)
macro_line|#else
DECL|macro|DEBUG
mdefine_line|#define DEBUG(n, args...)
macro_line|#endif
multiline_comment|/* ----------------------------------------------------------------------------&n;Parameters&n;&t;These are the parameters that can be set during loading with&n;&t;&squot;insmod&squot;.&n;---------------------------------------------------------------------------- */
multiline_comment|/* 0=auto, 1=10baseT, 2 = 10base2, default=auto */
DECL|variable|if_port
r_static
r_int
id|if_port
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Bit map of interrupts to choose from */
DECL|variable|irq_mask
r_static
id|u_int
id|irq_mask
op_assign
l_int|0xdeb8
suffix:semicolon
DECL|variable|irq_list
r_static
r_int
id|irq_list
(braket
l_int|4
)braket
op_assign
(brace
op_minus
l_int|1
)brace
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|if_port
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|irq_mask
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|irq_list
comma
l_string|&quot;1-4i&quot;
)paren
suffix:semicolon
multiline_comment|/* ----------------------------------------------------------------------------&n;Function Prototypes&n;---------------------------------------------------------------------------- */
r_static
r_void
id|nmclan_config
c_func
(paren
id|dev_link_t
op_star
id|link
)paren
suffix:semicolon
r_static
r_void
id|nmclan_release
c_func
(paren
id|u_long
id|arg
)paren
suffix:semicolon
r_static
r_int
id|nmclan_event
c_func
(paren
id|event_t
id|event
comma
r_int
id|priority
comma
id|event_callback_args_t
op_star
id|args
)paren
suffix:semicolon
r_static
r_void
id|nmclan_reset
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_int
id|mace_config
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_struct
id|ifmap
op_star
id|map
)paren
suffix:semicolon
r_static
r_int
id|mace_open
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_int
id|mace_close
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_int
id|mace_start_xmit
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_void
id|mace_tx_timeout
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_void
id|mace_interrupt
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
suffix:semicolon
r_static
r_struct
id|net_device_stats
op_star
id|mace_get_stats
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_int
id|mace_rx
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_int
r_char
id|RxCnt
)paren
suffix:semicolon
r_static
r_void
id|restore_multicast_list
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_void
id|set_multicast_list
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
id|dev_link_t
op_star
id|nmclan_attach
c_func
(paren
r_void
)paren
suffix:semicolon
r_static
r_void
id|nmclan_detach
c_func
(paren
id|dev_link_t
op_star
)paren
suffix:semicolon
multiline_comment|/* ----------------------------------------------------------------------------&n;flush_stale_links&n;&t;Clean up stale device structures&n;---------------------------------------------------------------------------- */
DECL|function|flush_stale_links
r_static
r_void
id|flush_stale_links
c_func
(paren
r_void
)paren
(brace
id|dev_link_t
op_star
id|link
comma
op_star
id|next
suffix:semicolon
r_for
c_loop
(paren
id|link
op_assign
id|dev_list
suffix:semicolon
id|link
suffix:semicolon
id|link
op_assign
id|next
)paren
(brace
id|next
op_assign
id|link-&gt;next
suffix:semicolon
r_if
c_cond
(paren
id|link-&gt;state
op_amp
id|DEV_STALE_LINK
)paren
id|nmclan_detach
c_func
(paren
id|link
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* ----------------------------------------------------------------------------&n;cs_error&n;&t;Report a Card Services related error.&n;---------------------------------------------------------------------------- */
DECL|function|cs_error
r_static
r_void
id|cs_error
c_func
(paren
id|client_handle_t
id|handle
comma
r_int
id|func
comma
r_int
id|ret
)paren
(brace
id|error_info_t
id|err
op_assign
(brace
id|func
comma
id|ret
)brace
suffix:semicolon
id|CardServices
c_func
(paren
id|ReportError
comma
id|handle
comma
op_amp
id|err
)paren
suffix:semicolon
)brace
multiline_comment|/* ----------------------------------------------------------------------------&n;nmclan_attach&n;&t;Creates an &quot;instance&quot; of the driver, allocating local data&n;&t;structures for one device.  The device is registered with Card&n;&t;Services.&n;---------------------------------------------------------------------------- */
DECL|function|nmclan_attach
r_static
id|dev_link_t
op_star
id|nmclan_attach
c_func
(paren
r_void
)paren
(brace
id|mace_private
op_star
id|lp
suffix:semicolon
id|dev_link_t
op_star
id|link
suffix:semicolon
r_struct
id|net_device
op_star
id|dev
suffix:semicolon
id|client_reg_t
id|client_reg
suffix:semicolon
r_int
id|i
comma
id|ret
suffix:semicolon
id|DEBUG
c_func
(paren
l_int|0
comma
l_string|&quot;nmclan_attach()&bslash;n&quot;
)paren
suffix:semicolon
id|DEBUG
c_func
(paren
l_int|1
comma
l_string|&quot;%s&bslash;n&quot;
comma
id|rcsid
)paren
suffix:semicolon
id|flush_stale_links
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* Create new ethernet device */
id|lp
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
op_star
id|lp
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|lp
)paren
r_return
l_int|NULL
suffix:semicolon
id|memset
c_func
(paren
id|lp
comma
l_int|0
comma
r_sizeof
(paren
op_star
id|lp
)paren
)paren
suffix:semicolon
id|link
op_assign
op_amp
id|lp-&gt;link
suffix:semicolon
id|dev
op_assign
op_amp
id|lp-&gt;dev
suffix:semicolon
id|link-&gt;priv
op_assign
id|dev-&gt;priv
op_assign
id|link-&gt;irq.Instance
op_assign
id|lp
suffix:semicolon
id|link-&gt;release.function
op_assign
op_amp
id|nmclan_release
suffix:semicolon
id|link-&gt;release.data
op_assign
(paren
id|u_long
)paren
id|link
suffix:semicolon
id|link-&gt;io.NumPorts1
op_assign
l_int|32
suffix:semicolon
id|link-&gt;io.Attributes1
op_assign
id|IO_DATA_PATH_WIDTH_AUTO
suffix:semicolon
id|link-&gt;io.IOAddrLines
op_assign
l_int|5
suffix:semicolon
id|link-&gt;irq.Attributes
op_assign
id|IRQ_TYPE_EXCLUSIVE
op_or
id|IRQ_HANDLE_PRESENT
suffix:semicolon
id|link-&gt;irq.IRQInfo1
op_assign
id|IRQ_INFO2_VALID
op_or
id|IRQ_LEVEL_ID
suffix:semicolon
r_if
c_cond
(paren
id|irq_list
(braket
l_int|0
)braket
op_eq
op_minus
l_int|1
)paren
id|link-&gt;irq.IRQInfo2
op_assign
id|irq_mask
suffix:semicolon
r_else
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|4
suffix:semicolon
id|i
op_increment
)paren
id|link-&gt;irq.IRQInfo2
op_or_assign
l_int|1
op_lshift
id|irq_list
(braket
id|i
)braket
suffix:semicolon
id|link-&gt;irq.Handler
op_assign
op_amp
id|mace_interrupt
suffix:semicolon
id|link-&gt;conf.Attributes
op_assign
id|CONF_ENABLE_IRQ
suffix:semicolon
id|link-&gt;conf.Vcc
op_assign
l_int|50
suffix:semicolon
id|link-&gt;conf.IntType
op_assign
id|INT_MEMORY_AND_IO
suffix:semicolon
id|link-&gt;conf.ConfigIndex
op_assign
l_int|1
suffix:semicolon
id|link-&gt;conf.Present
op_assign
id|PRESENT_OPTION
suffix:semicolon
id|lp-&gt;tx_free_frames
op_assign
id|AM2150_MAX_TX_FRAMES
suffix:semicolon
id|dev-&gt;hard_start_xmit
op_assign
op_amp
id|mace_start_xmit
suffix:semicolon
id|dev-&gt;set_config
op_assign
op_amp
id|mace_config
suffix:semicolon
id|dev-&gt;get_stats
op_assign
op_amp
id|mace_get_stats
suffix:semicolon
id|dev-&gt;set_multicast_list
op_assign
op_amp
id|set_multicast_list
suffix:semicolon
id|ether_setup
c_func
(paren
id|dev
)paren
suffix:semicolon
id|dev-&gt;open
op_assign
op_amp
id|mace_open
suffix:semicolon
id|dev-&gt;stop
op_assign
op_amp
id|mace_close
suffix:semicolon
id|dev-&gt;tx_timeout
op_assign
id|mace_tx_timeout
suffix:semicolon
id|dev-&gt;watchdog_timeo
op_assign
id|TX_TIMEOUT
suffix:semicolon
multiline_comment|/* Register with Card Services */
id|link-&gt;next
op_assign
id|dev_list
suffix:semicolon
id|dev_list
op_assign
id|link
suffix:semicolon
id|client_reg.dev_info
op_assign
op_amp
id|dev_info
suffix:semicolon
id|client_reg.Attributes
op_assign
id|INFO_IO_CLIENT
op_or
id|INFO_CARD_SHARE
suffix:semicolon
id|client_reg.EventMask
op_assign
id|CS_EVENT_CARD_INSERTION
op_or
id|CS_EVENT_CARD_REMOVAL
op_or
id|CS_EVENT_RESET_PHYSICAL
op_or
id|CS_EVENT_CARD_RESET
op_or
id|CS_EVENT_PM_SUSPEND
op_or
id|CS_EVENT_PM_RESUME
suffix:semicolon
id|client_reg.event_handler
op_assign
op_amp
id|nmclan_event
suffix:semicolon
id|client_reg.Version
op_assign
l_int|0x0210
suffix:semicolon
id|client_reg.event_callback_args.client_data
op_assign
id|link
suffix:semicolon
id|ret
op_assign
id|CardServices
c_func
(paren
id|RegisterClient
comma
op_amp
id|link-&gt;handle
comma
op_amp
id|client_reg
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
op_ne
l_int|0
)paren
(brace
id|cs_error
c_func
(paren
id|link-&gt;handle
comma
id|RegisterClient
comma
id|ret
)paren
suffix:semicolon
id|nmclan_detach
c_func
(paren
id|link
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
r_return
id|link
suffix:semicolon
)brace
multiline_comment|/* nmclan_attach */
multiline_comment|/* ----------------------------------------------------------------------------&n;nmclan_detach&n;&t;This deletes a driver &quot;instance&quot;.  The device is de-registered&n;&t;with Card Services.  If it has been released, all local data&n;&t;structures are freed.  Otherwise, the structures will be freed&n;&t;when the device is released.&n;---------------------------------------------------------------------------- */
DECL|function|nmclan_detach
r_static
r_void
id|nmclan_detach
c_func
(paren
id|dev_link_t
op_star
id|link
)paren
(brace
id|mace_private
op_star
id|lp
op_assign
id|link-&gt;priv
suffix:semicolon
id|dev_link_t
op_star
op_star
id|linkp
suffix:semicolon
id|DEBUG
c_func
(paren
l_int|0
comma
l_string|&quot;nmclan_detach(0x%p)&bslash;n&quot;
comma
id|link
)paren
suffix:semicolon
multiline_comment|/* Locate device structure */
r_for
c_loop
(paren
id|linkp
op_assign
op_amp
id|dev_list
suffix:semicolon
op_star
id|linkp
suffix:semicolon
id|linkp
op_assign
op_amp
(paren
op_star
id|linkp
)paren
op_member_access_from_pointer
id|next
)paren
r_if
c_cond
(paren
op_star
id|linkp
op_eq
id|link
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
op_star
id|linkp
op_eq
l_int|NULL
)paren
r_return
suffix:semicolon
id|del_timer
c_func
(paren
op_amp
id|link-&gt;release
)paren
suffix:semicolon
r_if
c_cond
(paren
id|link-&gt;state
op_amp
id|DEV_CONFIG
)paren
(brace
id|nmclan_release
c_func
(paren
(paren
id|u_long
)paren
id|link
)paren
suffix:semicolon
r_if
c_cond
(paren
id|link-&gt;state
op_amp
id|DEV_STALE_CONFIG
)paren
(brace
id|link-&gt;state
op_or_assign
id|DEV_STALE_LINK
suffix:semicolon
r_return
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|link-&gt;handle
)paren
id|CardServices
c_func
(paren
id|DeregisterClient
comma
id|link-&gt;handle
)paren
suffix:semicolon
multiline_comment|/* Unlink device structure, free bits */
op_star
id|linkp
op_assign
id|link-&gt;next
suffix:semicolon
r_if
c_cond
(paren
id|link-&gt;dev
)paren
id|unregister_netdev
c_func
(paren
op_amp
id|lp-&gt;dev
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|lp
)paren
suffix:semicolon
)brace
multiline_comment|/* nmclan_detach */
multiline_comment|/* ----------------------------------------------------------------------------&n;mace_read&n;&t;Reads a MACE register.  This is bank independent; however, the&n;&t;caller must ensure that this call is not interruptable.  We are&n;&t;assuming that during normal operation, the MACE is always in&n;&t;bank 0.&n;---------------------------------------------------------------------------- */
DECL|function|mace_read
r_static
r_int
id|mace_read
c_func
(paren
id|ioaddr_t
id|ioaddr
comma
r_int
id|reg
)paren
(brace
r_int
id|data
op_assign
l_int|0xFF
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_switch
c_cond
(paren
id|reg
op_rshift
l_int|4
)paren
(brace
r_case
l_int|0
suffix:colon
multiline_comment|/* register 0-15 */
id|data
op_assign
id|inb
c_func
(paren
id|ioaddr
op_plus
id|AM2150_MACE_BASE
op_plus
id|reg
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|1
suffix:colon
multiline_comment|/* register 16-31 */
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|MACEBANK
c_func
(paren
l_int|1
)paren
suffix:semicolon
id|data
op_assign
id|inb
c_func
(paren
id|ioaddr
op_plus
id|AM2150_MACE_BASE
op_plus
(paren
id|reg
op_amp
l_int|0x0F
)paren
)paren
suffix:semicolon
id|MACEBANK
c_func
(paren
l_int|0
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_return
(paren
id|data
op_amp
l_int|0xFF
)paren
suffix:semicolon
)brace
multiline_comment|/* mace_read */
multiline_comment|/* ----------------------------------------------------------------------------&n;mace_write&n;&t;Writes to a MACE register.  This is bank independent; however,&n;&t;the caller must ensure that this call is not interruptable.  We&n;&t;are assuming that during normal operation, the MACE is always in&n;&t;bank 0.&n;---------------------------------------------------------------------------- */
DECL|function|mace_write
r_static
r_void
id|mace_write
c_func
(paren
id|ioaddr_t
id|ioaddr
comma
r_int
id|reg
comma
r_int
id|data
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
r_switch
c_cond
(paren
id|reg
op_rshift
l_int|4
)paren
(brace
r_case
l_int|0
suffix:colon
multiline_comment|/* register 0-15 */
id|outb
c_func
(paren
id|data
op_amp
l_int|0xFF
comma
id|ioaddr
op_plus
id|AM2150_MACE_BASE
op_plus
id|reg
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|1
suffix:colon
multiline_comment|/* register 16-31 */
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|MACEBANK
c_func
(paren
l_int|1
)paren
suffix:semicolon
id|outb
c_func
(paren
id|data
op_amp
l_int|0xFF
comma
id|ioaddr
op_plus
id|AM2150_MACE_BASE
op_plus
(paren
id|reg
op_amp
l_int|0x0F
)paren
)paren
suffix:semicolon
id|MACEBANK
c_func
(paren
l_int|0
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
multiline_comment|/* mace_write */
multiline_comment|/* ----------------------------------------------------------------------------&n;mace_init&n;&t;Resets the MACE chip.&n;---------------------------------------------------------------------------- */
DECL|function|mace_init
r_static
r_void
id|mace_init
c_func
(paren
id|ioaddr_t
id|ioaddr
comma
r_char
op_star
id|enet_addr
)paren
(brace
r_int
id|i
suffix:semicolon
multiline_comment|/* MACE Software reset */
id|mace_write
c_func
(paren
id|ioaddr
comma
id|MACE_BIUCC
comma
l_int|1
)paren
suffix:semicolon
r_while
c_loop
(paren
id|mace_read
c_func
(paren
id|ioaddr
comma
id|MACE_BIUCC
)paren
op_amp
l_int|0x01
)paren
(brace
multiline_comment|/* Wait for reset bit to be cleared automatically after &lt;= 200ns */
suffix:semicolon
)brace
id|mace_write
c_func
(paren
id|ioaddr
comma
id|MACE_BIUCC
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* The Am2150 requires that the MACE FIFOs operate in burst mode. */
id|mace_write
c_func
(paren
id|ioaddr
comma
id|MACE_FIFOCC
comma
l_int|0x0F
)paren
suffix:semicolon
id|mace_write
c_func
(paren
id|ioaddr
comma
id|MACE_RCVFC
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* Disable Auto Strip Receive */
id|mace_write
c_func
(paren
id|ioaddr
comma
id|MACE_IMR
comma
l_int|0xFF
)paren
suffix:semicolon
multiline_comment|/* Disable all interrupts until _open */
multiline_comment|/*&n;   * Bit 2-1 PORTSEL[1-0] Port Select.&n;   * 00 AUI/10Base-2&n;   * 01 10Base-T&n;   * 10 DAI Port (reserved in Am2150)&n;   * 11 GPSI&n;   * For this card, only the first two are valid.&n;   * So, PLSCC should be set to&n;   * 0x00 for 10Base-2&n;   * 0x02 for 10Base-T&n;   * Or just set ASEL in PHYCC below!&n;   */
r_switch
c_cond
(paren
id|if_port
)paren
(brace
r_case
l_int|1
suffix:colon
id|mace_write
c_func
(paren
id|ioaddr
comma
id|MACE_PLSCC
comma
l_int|0x02
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|2
suffix:colon
id|mace_write
c_func
(paren
id|ioaddr
comma
id|MACE_PLSCC
comma
l_int|0x00
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|mace_write
c_func
(paren
id|ioaddr
comma
id|MACE_PHYCC
comma
multiline_comment|/* ASEL */
l_int|4
)paren
suffix:semicolon
multiline_comment|/* ASEL Auto Select.  When set, the PORTSEL[1-0] bits are overridden,&n;&t; and the MACE device will automatically select the operating media&n;&t; interface port. */
r_break
suffix:semicolon
)brace
id|mace_write
c_func
(paren
id|ioaddr
comma
id|MACE_IAC
comma
id|MACE_IAC_ADDRCHG
op_or
id|MACE_IAC_PHYADDR
)paren
suffix:semicolon
multiline_comment|/* Poll ADDRCHG bit */
r_while
c_loop
(paren
id|mace_read
c_func
(paren
id|ioaddr
comma
id|MACE_IAC
)paren
op_amp
id|MACE_IAC_ADDRCHG
)paren
suffix:semicolon
multiline_comment|/* Set PADR register */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|ETHER_ADDR_LEN
suffix:semicolon
id|i
op_increment
)paren
id|mace_write
c_func
(paren
id|ioaddr
comma
id|MACE_PADR
comma
id|enet_addr
(braket
id|i
)braket
)paren
suffix:semicolon
multiline_comment|/* MAC Configuration Control Register should be written last */
multiline_comment|/* Let set_multicast_list set this. */
multiline_comment|/* mace_write(ioaddr, MACE_MACCC, MACE_MACCC_ENXMT | MACE_MACCC_ENRCV); */
id|mace_write
c_func
(paren
id|ioaddr
comma
id|MACE_MACCC
comma
l_int|0x00
)paren
suffix:semicolon
)brace
multiline_comment|/* mace_init */
multiline_comment|/* ----------------------------------------------------------------------------&n;nmclan_config&n;&t;This routine is scheduled to run after a CARD_INSERTION event&n;&t;is received, to configure the PCMCIA socket, and to make the&n;&t;ethernet device available to the system.&n;---------------------------------------------------------------------------- */
DECL|macro|CS_CHECK
mdefine_line|#define CS_CHECK(fn, args...) &bslash;&n;while ((last_ret=CardServices(last_fn=(fn), args))!=0) goto cs_failed
DECL|function|nmclan_config
r_static
r_void
id|nmclan_config
c_func
(paren
id|dev_link_t
op_star
id|link
)paren
(brace
id|client_handle_t
id|handle
op_assign
id|link-&gt;handle
suffix:semicolon
id|mace_private
op_star
id|lp
op_assign
id|link-&gt;priv
suffix:semicolon
r_struct
id|net_device
op_star
id|dev
op_assign
op_amp
id|lp-&gt;dev
suffix:semicolon
id|tuple_t
id|tuple
suffix:semicolon
id|cisparse_t
id|parse
suffix:semicolon
id|u_char
id|buf
(braket
l_int|64
)braket
suffix:semicolon
r_int
id|i
comma
id|last_ret
comma
id|last_fn
suffix:semicolon
id|ioaddr_t
id|ioaddr
suffix:semicolon
id|DEBUG
c_func
(paren
l_int|0
comma
l_string|&quot;nmclan_config(0x%p)&bslash;n&quot;
comma
id|link
)paren
suffix:semicolon
id|tuple.Attributes
op_assign
l_int|0
suffix:semicolon
id|tuple.TupleData
op_assign
id|buf
suffix:semicolon
id|tuple.TupleDataMax
op_assign
l_int|64
suffix:semicolon
id|tuple.TupleOffset
op_assign
l_int|0
suffix:semicolon
id|tuple.DesiredTuple
op_assign
id|CISTPL_CONFIG
suffix:semicolon
id|CS_CHECK
c_func
(paren
id|GetFirstTuple
comma
id|handle
comma
op_amp
id|tuple
)paren
suffix:semicolon
id|CS_CHECK
c_func
(paren
id|GetTupleData
comma
id|handle
comma
op_amp
id|tuple
)paren
suffix:semicolon
id|CS_CHECK
c_func
(paren
id|ParseTuple
comma
id|handle
comma
op_amp
id|tuple
comma
op_amp
id|parse
)paren
suffix:semicolon
id|link-&gt;conf.ConfigBase
op_assign
id|parse.config.base
suffix:semicolon
multiline_comment|/* Configure card */
id|link-&gt;state
op_or_assign
id|DEV_CONFIG
suffix:semicolon
id|CS_CHECK
c_func
(paren
id|RequestIO
comma
id|handle
comma
op_amp
id|link-&gt;io
)paren
suffix:semicolon
id|CS_CHECK
c_func
(paren
id|RequestIRQ
comma
id|handle
comma
op_amp
id|link-&gt;irq
)paren
suffix:semicolon
id|CS_CHECK
c_func
(paren
id|RequestConfiguration
comma
id|handle
comma
op_amp
id|link-&gt;conf
)paren
suffix:semicolon
id|dev-&gt;irq
op_assign
id|link-&gt;irq.AssignedIRQ
suffix:semicolon
id|dev-&gt;base_addr
op_assign
id|link-&gt;io.BasePort1
suffix:semicolon
id|i
op_assign
id|register_netdev
c_func
(paren
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
op_ne
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;nmclan_cs: register_netdev() failed&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|failed
suffix:semicolon
)brace
id|ioaddr
op_assign
id|dev-&gt;base_addr
suffix:semicolon
multiline_comment|/* Read the ethernet address from the CIS. */
id|tuple.DesiredTuple
op_assign
l_int|0x80
multiline_comment|/* CISTPL_CFTABLE_ENTRY_MISC */
suffix:semicolon
id|tuple.TupleData
op_assign
id|buf
suffix:semicolon
id|tuple.TupleDataMax
op_assign
l_int|64
suffix:semicolon
id|tuple.TupleOffset
op_assign
l_int|0
suffix:semicolon
id|CS_CHECK
c_func
(paren
id|GetFirstTuple
comma
id|handle
comma
op_amp
id|tuple
)paren
suffix:semicolon
id|CS_CHECK
c_func
(paren
id|GetTupleData
comma
id|handle
comma
op_amp
id|tuple
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|dev-&gt;dev_addr
comma
id|tuple.TupleData
comma
id|ETHER_ADDR_LEN
)paren
suffix:semicolon
multiline_comment|/* Verify configuration by reading the MACE ID. */
(brace
r_char
id|sig
(braket
l_int|2
)braket
suffix:semicolon
id|sig
(braket
l_int|0
)braket
op_assign
id|mace_read
c_func
(paren
id|ioaddr
comma
id|MACE_CHIPIDL
)paren
suffix:semicolon
id|sig
(braket
l_int|1
)braket
op_assign
id|mace_read
c_func
(paren
id|ioaddr
comma
id|MACE_CHIPIDH
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|sig
(braket
l_int|0
)braket
op_eq
l_int|0x40
)paren
op_logical_and
(paren
(paren
id|sig
(braket
l_int|1
)braket
op_amp
l_int|0x0F
)paren
op_eq
l_int|0x09
)paren
)paren
(brace
id|DEBUG
c_func
(paren
l_int|0
comma
l_string|&quot;nmclan_cs configured: mace id=%x %x&bslash;n&quot;
comma
id|sig
(braket
l_int|0
)braket
comma
id|sig
(braket
l_int|1
)braket
)paren
suffix:semicolon
)brace
r_else
(brace
id|printk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;nmclan_cs: mace id not found: %x %x should&quot;
l_string|&quot; be 0x40 0x?9&bslash;n&quot;
comma
id|sig
(braket
l_int|0
)braket
comma
id|sig
(braket
l_int|1
)braket
)paren
suffix:semicolon
id|link-&gt;state
op_and_assign
op_complement
id|DEV_CONFIG_PENDING
suffix:semicolon
r_return
suffix:semicolon
)brace
)brace
id|mace_init
c_func
(paren
id|ioaddr
comma
id|dev-&gt;dev_addr
)paren
suffix:semicolon
multiline_comment|/* The if_port symbol can be set when the module is loaded */
r_if
c_cond
(paren
id|if_port
op_le
l_int|2
)paren
id|dev-&gt;if_port
op_assign
id|if_port
suffix:semicolon
r_else
id|printk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;nmclan_cs: invalid if_port requested&bslash;n&quot;
)paren
suffix:semicolon
id|strcpy
c_func
(paren
id|lp-&gt;node.dev_name
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|link-&gt;dev
op_assign
op_amp
id|lp-&gt;node
suffix:semicolon
id|link-&gt;state
op_and_assign
op_complement
id|DEV_CONFIG_PENDING
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: nmclan: port %#3lx, irq %d, %s port, hw_addr &quot;
comma
id|dev-&gt;name
comma
id|dev-&gt;base_addr
comma
id|dev-&gt;irq
comma
id|if_names
(braket
id|dev-&gt;if_port
)braket
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|6
suffix:semicolon
id|i
op_increment
)paren
id|printk
c_func
(paren
l_string|&quot;%02X%s&quot;
comma
id|dev-&gt;dev_addr
(braket
id|i
)braket
comma
(paren
(paren
id|i
OL
l_int|5
)paren
ques
c_cond
l_string|&quot;:&quot;
suffix:colon
l_string|&quot;&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_return
suffix:semicolon
id|cs_failed
suffix:colon
id|cs_error
c_func
(paren
id|link-&gt;handle
comma
id|last_fn
comma
id|last_ret
)paren
suffix:semicolon
id|failed
suffix:colon
id|nmclan_release
c_func
(paren
(paren
id|u_long
)paren
id|link
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/* nmclan_config */
multiline_comment|/* ----------------------------------------------------------------------------&n;nmclan_release&n;&t;After a card is removed, nmclan_release() will unregister the&n;&t;net device, and release the PCMCIA configuration.  If the device&n;&t;is still open, this will be postponed until it is closed.&n;---------------------------------------------------------------------------- */
DECL|function|nmclan_release
r_static
r_void
id|nmclan_release
c_func
(paren
id|u_long
id|arg
)paren
(brace
id|dev_link_t
op_star
id|link
op_assign
(paren
id|dev_link_t
op_star
)paren
id|arg
suffix:semicolon
id|DEBUG
c_func
(paren
l_int|0
comma
l_string|&quot;nmclan_release(0x%p)&bslash;n&quot;
comma
id|link
)paren
suffix:semicolon
r_if
c_cond
(paren
id|link-&gt;open
)paren
(brace
id|DEBUG
c_func
(paren
l_int|1
comma
l_string|&quot;nmclan_cs: release postponed, &squot;%s&squot; &quot;
l_string|&quot;still open&bslash;n&quot;
comma
id|link-&gt;dev-&gt;dev_name
)paren
suffix:semicolon
id|link-&gt;state
op_or_assign
id|DEV_STALE_CONFIG
suffix:semicolon
r_return
suffix:semicolon
)brace
id|CardServices
c_func
(paren
id|ReleaseConfiguration
comma
id|link-&gt;handle
)paren
suffix:semicolon
id|CardServices
c_func
(paren
id|ReleaseIO
comma
id|link-&gt;handle
comma
op_amp
id|link-&gt;io
)paren
suffix:semicolon
id|CardServices
c_func
(paren
id|ReleaseIRQ
comma
id|link-&gt;handle
comma
op_amp
id|link-&gt;irq
)paren
suffix:semicolon
id|link-&gt;state
op_and_assign
op_complement
id|DEV_CONFIG
suffix:semicolon
)brace
multiline_comment|/* nmclan_release */
multiline_comment|/* ----------------------------------------------------------------------------&n;nmclan_event&n;&t;The card status event handler.  Mostly, this schedules other&n;&t;stuff to run after an event is received.  A CARD_REMOVAL event&n;&t;also sets some flags to discourage the net drivers from trying&n;&t;to talk to the card any more.&n;---------------------------------------------------------------------------- */
DECL|function|nmclan_event
r_static
r_int
id|nmclan_event
c_func
(paren
id|event_t
id|event
comma
r_int
id|priority
comma
id|event_callback_args_t
op_star
id|args
)paren
(brace
id|dev_link_t
op_star
id|link
op_assign
id|args-&gt;client_data
suffix:semicolon
id|mace_private
op_star
id|lp
op_assign
id|link-&gt;priv
suffix:semicolon
r_struct
id|net_device
op_star
id|dev
op_assign
op_amp
id|lp-&gt;dev
suffix:semicolon
id|DEBUG
c_func
(paren
l_int|1
comma
l_string|&quot;nmclan_event(0x%06x)&bslash;n&quot;
comma
id|event
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|event
)paren
(brace
r_case
id|CS_EVENT_CARD_REMOVAL
suffix:colon
id|link-&gt;state
op_and_assign
op_complement
id|DEV_PRESENT
suffix:semicolon
r_if
c_cond
(paren
id|link-&gt;state
op_amp
id|DEV_CONFIG
)paren
(brace
id|netif_device_detach
c_func
(paren
id|dev
)paren
suffix:semicolon
id|mod_timer
c_func
(paren
op_amp
id|link-&gt;release
comma
id|jiffies
op_plus
id|HZ
op_div
l_int|20
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|CS_EVENT_CARD_INSERTION
suffix:colon
id|link-&gt;state
op_or_assign
id|DEV_PRESENT
op_or
id|DEV_CONFIG_PENDING
suffix:semicolon
id|nmclan_config
c_func
(paren
id|link
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CS_EVENT_PM_SUSPEND
suffix:colon
id|link-&gt;state
op_or_assign
id|DEV_SUSPEND
suffix:semicolon
multiline_comment|/* Fall through... */
r_case
id|CS_EVENT_RESET_PHYSICAL
suffix:colon
r_if
c_cond
(paren
id|link-&gt;state
op_amp
id|DEV_CONFIG
)paren
(brace
r_if
c_cond
(paren
id|link-&gt;open
)paren
id|netif_device_detach
c_func
(paren
id|dev
)paren
suffix:semicolon
id|CardServices
c_func
(paren
id|ReleaseConfiguration
comma
id|link-&gt;handle
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|CS_EVENT_PM_RESUME
suffix:colon
id|link-&gt;state
op_and_assign
op_complement
id|DEV_SUSPEND
suffix:semicolon
multiline_comment|/* Fall through... */
r_case
id|CS_EVENT_CARD_RESET
suffix:colon
r_if
c_cond
(paren
id|link-&gt;state
op_amp
id|DEV_CONFIG
)paren
(brace
id|CardServices
c_func
(paren
id|RequestConfiguration
comma
id|link-&gt;handle
comma
op_amp
id|link-&gt;conf
)paren
suffix:semicolon
r_if
c_cond
(paren
id|link-&gt;open
)paren
(brace
id|nmclan_reset
c_func
(paren
id|dev
)paren
suffix:semicolon
id|netif_device_attach
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
)brace
r_break
suffix:semicolon
r_case
id|CS_EVENT_RESET_REQUEST
suffix:colon
r_return
l_int|1
suffix:semicolon
r_break
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* nmclan_event */
multiline_comment|/* ----------------------------------------------------------------------------&n;nmclan_reset&n;&t;Reset and restore all of the Xilinx and MACE registers.&n;---------------------------------------------------------------------------- */
DECL|function|nmclan_reset
r_static
r_void
id|nmclan_reset
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
id|mace_private
op_star
id|lp
op_assign
id|dev-&gt;priv
suffix:semicolon
macro_line|#if RESET_XILINX
id|dev_link_t
op_star
id|link
op_assign
op_amp
id|lp-&gt;link
suffix:semicolon
id|conf_reg_t
id|reg
suffix:semicolon
id|u_long
id|OrigCorValue
suffix:semicolon
multiline_comment|/* Save original COR value */
id|reg.Function
op_assign
l_int|0
suffix:semicolon
id|reg.Action
op_assign
id|CS_READ
suffix:semicolon
id|reg.Offset
op_assign
id|CISREG_COR
suffix:semicolon
id|reg.Value
op_assign
l_int|0
suffix:semicolon
id|CardServices
c_func
(paren
id|AccessConfigurationRegister
comma
id|link-&gt;handle
comma
op_amp
id|reg
)paren
suffix:semicolon
id|OrigCorValue
op_assign
id|reg.Value
suffix:semicolon
multiline_comment|/* Reset Xilinx */
id|reg.Action
op_assign
id|CS_WRITE
suffix:semicolon
id|reg.Offset
op_assign
id|CISREG_COR
suffix:semicolon
id|DEBUG
c_func
(paren
l_int|1
comma
l_string|&quot;nmclan_reset: OrigCorValue=0x%lX, resetting...&bslash;n&quot;
comma
id|OrigCorValue
)paren
suffix:semicolon
id|reg.Value
op_assign
id|COR_SOFT_RESET
suffix:semicolon
id|CardServices
c_func
(paren
id|AccessConfigurationRegister
comma
id|link-&gt;handle
comma
op_amp
id|reg
)paren
suffix:semicolon
multiline_comment|/* Need to wait for 20 ms for PCMCIA to finish reset. */
multiline_comment|/* Restore original COR configuration index */
id|reg.Value
op_assign
id|COR_LEVEL_REQ
op_or
(paren
id|OrigCorValue
op_amp
id|COR_CONFIG_MASK
)paren
suffix:semicolon
id|CardServices
c_func
(paren
id|AccessConfigurationRegister
comma
id|link-&gt;handle
comma
op_amp
id|reg
)paren
suffix:semicolon
multiline_comment|/* Xilinx is now completely reset along with the MACE chip. */
id|lp-&gt;tx_free_frames
op_assign
id|AM2150_MAX_TX_FRAMES
suffix:semicolon
macro_line|#endif /* #if RESET_XILINX */
multiline_comment|/* Xilinx is now completely reset along with the MACE chip. */
id|lp-&gt;tx_free_frames
op_assign
id|AM2150_MAX_TX_FRAMES
suffix:semicolon
multiline_comment|/* Reinitialize the MACE chip for operation. */
id|mace_init
c_func
(paren
id|dev-&gt;base_addr
comma
id|dev-&gt;dev_addr
)paren
suffix:semicolon
id|mace_write
c_func
(paren
id|dev-&gt;base_addr
comma
id|MACE_IMR
comma
id|MACE_IMR_DEFAULT
)paren
suffix:semicolon
multiline_comment|/* Restore the multicast list and enable TX and RX. */
id|restore_multicast_list
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
multiline_comment|/* nmclan_reset */
multiline_comment|/* ----------------------------------------------------------------------------&n;mace_config&n;&t;[Someone tell me what this is supposed to do?  Is if_port a defined&n;&t;standard?  If so, there should be defines to indicate 1=10Base-T,&n;&t;2=10Base-2, etc. including limited automatic detection.]&n;---------------------------------------------------------------------------- */
DECL|function|mace_config
r_static
r_int
id|mace_config
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_struct
id|ifmap
op_star
id|map
)paren
(brace
r_if
c_cond
(paren
(paren
id|map-&gt;port
op_ne
(paren
id|u_char
)paren
(paren
op_minus
l_int|1
)paren
)paren
op_logical_and
(paren
id|map-&gt;port
op_ne
id|dev-&gt;if_port
)paren
)paren
(brace
r_if
c_cond
(paren
id|map-&gt;port
op_le
l_int|2
)paren
(brace
id|dev-&gt;if_port
op_assign
id|map-&gt;port
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: switched to %s port&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|if_names
(braket
id|dev-&gt;if_port
)braket
)paren
suffix:semicolon
)brace
r_else
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* mace_config */
multiline_comment|/* ----------------------------------------------------------------------------&n;mace_open&n;&t;Open device driver.&n;---------------------------------------------------------------------------- */
DECL|function|mace_open
r_static
r_int
id|mace_open
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
id|ioaddr_t
id|ioaddr
op_assign
id|dev-&gt;base_addr
suffix:semicolon
id|mace_private
op_star
id|lp
op_assign
id|dev-&gt;priv
suffix:semicolon
id|dev_link_t
op_star
id|link
op_assign
op_amp
id|lp-&gt;link
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|DEV_OK
c_func
(paren
id|link
)paren
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
id|link-&gt;open
op_increment
suffix:semicolon
id|MOD_INC_USE_COUNT
suffix:semicolon
id|MACEBANK
c_func
(paren
l_int|0
)paren
suffix:semicolon
id|netif_start_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
id|nmclan_reset
c_func
(paren
id|dev
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
multiline_comment|/* Always succeed */
)brace
multiline_comment|/* mace_open */
multiline_comment|/* ----------------------------------------------------------------------------&n;mace_close&n;&t;Closes device driver.&n;---------------------------------------------------------------------------- */
DECL|function|mace_close
r_static
r_int
id|mace_close
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
id|ioaddr_t
id|ioaddr
op_assign
id|dev-&gt;base_addr
suffix:semicolon
id|mace_private
op_star
id|lp
op_assign
id|dev-&gt;priv
suffix:semicolon
id|dev_link_t
op_star
id|link
op_assign
op_amp
id|lp-&gt;link
suffix:semicolon
id|DEBUG
c_func
(paren
l_int|2
comma
l_string|&quot;%s: shutting down ethercard.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
multiline_comment|/* Mask off all interrupts from the MACE chip. */
id|outb
c_func
(paren
l_int|0xFF
comma
id|ioaddr
op_plus
id|AM2150_MACE_BASE
op_plus
id|MACE_IMR
)paren
suffix:semicolon
id|link-&gt;open
op_decrement
suffix:semicolon
id|netif_stop_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|link-&gt;state
op_amp
id|DEV_STALE_CONFIG
)paren
id|mod_timer
c_func
(paren
op_amp
id|link-&gt;release
comma
id|jiffies
op_plus
id|HZ
op_div
l_int|20
)paren
suffix:semicolon
id|MOD_DEC_USE_COUNT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* mace_close */
multiline_comment|/* ----------------------------------------------------------------------------&n;mace_start_xmit&n;&t;This routine begins the packet transmit function.  When completed,&n;&t;it will generate a transmit interrupt.&n;&n;&t;According to /usr/src/linux/net/inet/dev.c, if _start_xmit&n;&t;returns 0, the &quot;packet is now solely the responsibility of the&n;&t;driver.&quot;  If _start_xmit returns non-zero, the &quot;transmission&n;&t;failed, put skb back into a list.&quot;&n;---------------------------------------------------------------------------- */
DECL|function|mace_tx_timeout
r_static
r_void
id|mace_tx_timeout
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
id|mace_private
op_star
id|lp
op_assign
(paren
id|mace_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|dev_link_t
op_star
id|link
op_assign
op_amp
id|lp-&gt;link
suffix:semicolon
id|printk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;%s: transmit timed out -- &quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
macro_line|#if RESET_ON_TIMEOUT
id|printk
c_func
(paren
l_string|&quot;resetting card&bslash;n&quot;
)paren
suffix:semicolon
id|CardServices
c_func
(paren
id|ResetCard
comma
id|link-&gt;handle
)paren
suffix:semicolon
macro_line|#else /* #if RESET_ON_TIMEOUT */
id|printk
c_func
(paren
l_string|&quot;NOT resetting card&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif /* #if RESET_ON_TIMEOUT */
id|dev-&gt;trans_start
op_assign
id|jiffies
suffix:semicolon
id|netif_start_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
DECL|function|mace_start_xmit
r_static
r_int
id|mace_start_xmit
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|net_device
op_star
id|dev
)paren
(brace
id|mace_private
op_star
id|lp
op_assign
(paren
id|mace_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|ioaddr_t
id|ioaddr
op_assign
id|dev-&gt;base_addr
suffix:semicolon
id|netif_stop_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
id|DEBUG
c_func
(paren
l_int|3
comma
l_string|&quot;%s: mace_start_xmit(length = %ld) called.&bslash;n&quot;
comma
id|dev-&gt;name
comma
(paren
r_int
)paren
id|skb-&gt;len
)paren
suffix:semicolon
macro_line|#if (!TX_INTERRUPTABLE)
multiline_comment|/* Disable MACE TX interrupts. */
id|outb
c_func
(paren
id|MACE_IMR_DEFAULT
op_or
id|MACE_IR_XMTINT
comma
id|ioaddr
op_plus
id|AM2150_MACE_BASE
op_plus
id|MACE_IMR
)paren
suffix:semicolon
id|lp-&gt;tx_irq_disabled
op_assign
l_int|1
suffix:semicolon
macro_line|#endif /* #if (!TX_INTERRUPTABLE) */
(brace
multiline_comment|/* This block must not be interrupted by another transmit request!&n;       mace_tx_timeout will take care of timer-based retransmissions from&n;       the upper layers.  The interrupt handler is guaranteed never to&n;       service a transmit interrupt while we are in here.&n;    */
id|lp-&gt;linux_stats.tx_bytes
op_add_assign
id|skb-&gt;len
suffix:semicolon
id|lp-&gt;tx_free_frames
op_decrement
suffix:semicolon
multiline_comment|/* WARNING: Write the _exact_ number of bytes written in the header! */
multiline_comment|/* Put out the word header [must be an outw()] . . . */
id|outw
c_func
(paren
id|skb-&gt;len
comma
id|ioaddr
op_plus
id|AM2150_XMT
)paren
suffix:semicolon
multiline_comment|/* . . . and the packet [may be any combination of outw() and outb()] */
id|outsw
c_func
(paren
id|ioaddr
op_plus
id|AM2150_XMT
comma
id|skb-&gt;data
comma
id|skb-&gt;len
op_rshift
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|skb-&gt;len
op_amp
l_int|1
)paren
(brace
multiline_comment|/* Odd byte transfer */
id|outb
c_func
(paren
id|skb-&gt;data
(braket
id|skb-&gt;len
op_minus
l_int|1
)braket
comma
id|ioaddr
op_plus
id|AM2150_XMT
)paren
suffix:semicolon
)brace
id|dev-&gt;trans_start
op_assign
id|jiffies
suffix:semicolon
macro_line|#if MULTI_TX
r_if
c_cond
(paren
id|lp-&gt;tx_free_frames
OG
l_int|0
)paren
id|netif_start_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
macro_line|#endif /* #if MULTI_TX */
)brace
macro_line|#if (!TX_INTERRUPTABLE)
multiline_comment|/* Re-enable MACE TX interrupts. */
id|lp-&gt;tx_irq_disabled
op_assign
l_int|0
suffix:semicolon
id|outb
c_func
(paren
id|MACE_IMR_DEFAULT
comma
id|ioaddr
op_plus
id|AM2150_MACE_BASE
op_plus
id|MACE_IMR
)paren
suffix:semicolon
macro_line|#endif /* #if (!TX_INTERRUPTABLE) */
id|dev_kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* mace_start_xmit */
multiline_comment|/* ----------------------------------------------------------------------------&n;mace_interrupt&n;&t;The interrupt handler.&n;---------------------------------------------------------------------------- */
DECL|function|mace_interrupt
r_static
r_void
id|mace_interrupt
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
id|mace_private
op_star
id|lp
op_assign
(paren
id|mace_private
op_star
)paren
id|dev_id
suffix:semicolon
r_struct
id|net_device
op_star
id|dev
op_assign
op_amp
id|lp-&gt;dev
suffix:semicolon
id|ioaddr_t
id|ioaddr
op_assign
id|dev-&gt;base_addr
suffix:semicolon
r_int
id|status
suffix:semicolon
r_int
id|IntrCnt
op_assign
id|MACE_MAX_IR_ITERATIONS
suffix:semicolon
r_if
c_cond
(paren
id|dev
op_eq
l_int|NULL
)paren
(brace
id|DEBUG
c_func
(paren
l_int|2
comma
l_string|&quot;mace_interrupt(): irq 0x%X for unknown device.&bslash;n&quot;
comma
id|irq
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|lp-&gt;tx_irq_disabled
)paren
(brace
id|printk
c_func
(paren
(paren
id|lp-&gt;tx_irq_disabled
ques
c_cond
id|KERN_NOTICE
l_string|&quot;%s: Interrupt with tx_irq_disabled &quot;
l_string|&quot;[isr=%02X, imr=%02X]&bslash;n&quot;
suffix:colon
id|KERN_NOTICE
l_string|&quot;%s: Re-entering the interrupt handler &quot;
l_string|&quot;[isr=%02X, imr=%02X]&bslash;n&quot;
)paren
comma
id|dev-&gt;name
comma
id|inb
c_func
(paren
id|ioaddr
op_plus
id|AM2150_MACE_BASE
op_plus
id|MACE_IR
)paren
comma
id|inb
c_func
(paren
id|ioaddr
op_plus
id|AM2150_MACE_BASE
op_plus
id|MACE_IMR
)paren
)paren
suffix:semicolon
multiline_comment|/* WARNING: MACE_IR has been read! */
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|netif_device_present
c_func
(paren
id|dev
)paren
)paren
(brace
id|DEBUG
c_func
(paren
l_int|2
comma
l_string|&quot;%s: interrupt from dead card&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_goto
id|exception
suffix:semicolon
)brace
r_do
(brace
multiline_comment|/* WARNING: MACE_IR is a READ/CLEAR port! */
id|status
op_assign
id|inb
c_func
(paren
id|ioaddr
op_plus
id|AM2150_MACE_BASE
op_plus
id|MACE_IR
)paren
suffix:semicolon
id|DEBUG
c_func
(paren
l_int|3
comma
l_string|&quot;mace_interrupt: irq 0x%X status 0x%X.&bslash;n&quot;
comma
id|irq
comma
id|status
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
id|MACE_IR_RCVINT
)paren
(brace
id|mace_rx
c_func
(paren
id|dev
comma
id|MACE_MAX_RX_ITERATIONS
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|status
op_amp
id|MACE_IR_XMTINT
)paren
(brace
r_int
r_char
id|fifofc
suffix:semicolon
r_int
r_char
id|xmtrc
suffix:semicolon
r_int
r_char
id|xmtfs
suffix:semicolon
id|fifofc
op_assign
id|inb
c_func
(paren
id|ioaddr
op_plus
id|AM2150_MACE_BASE
op_plus
id|MACE_FIFOFC
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|fifofc
op_amp
id|MACE_FIFOFC_XMTFC
)paren
op_eq
l_int|0
)paren
(brace
id|lp-&gt;linux_stats.tx_errors
op_increment
suffix:semicolon
id|outb
c_func
(paren
l_int|0xFF
comma
id|ioaddr
op_plus
id|AM2150_XMT_SKIP
)paren
suffix:semicolon
)brace
multiline_comment|/* Transmit Retry Count (XMTRC, reg 4) */
id|xmtrc
op_assign
id|inb
c_func
(paren
id|ioaddr
op_plus
id|AM2150_MACE_BASE
op_plus
id|MACE_XMTRC
)paren
suffix:semicolon
r_if
c_cond
(paren
id|xmtrc
op_amp
id|MACE_XMTRC_EXDEF
)paren
id|lp-&gt;mace_stats.exdef
op_increment
suffix:semicolon
id|lp-&gt;mace_stats.xmtrc
op_add_assign
(paren
id|xmtrc
op_amp
id|MACE_XMTRC_XMTRC
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|xmtfs
op_assign
id|inb
c_func
(paren
id|ioaddr
op_plus
id|AM2150_MACE_BASE
op_plus
id|MACE_XMTFS
)paren
)paren
op_amp
id|MACE_XMTFS_XMTSV
multiline_comment|/* Transmit Status Valid */
)paren
(brace
id|lp-&gt;mace_stats.xmtsv
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|xmtfs
op_amp
op_complement
id|MACE_XMTFS_XMTSV
)paren
(brace
r_if
c_cond
(paren
id|xmtfs
op_amp
id|MACE_XMTFS_UFLO
)paren
(brace
multiline_comment|/* Underflow.  Indicates that the Transmit FIFO emptied before&n;&t;       the end of frame was reached. */
id|lp-&gt;mace_stats.uflo
op_increment
suffix:semicolon
)brace
r_if
c_cond
(paren
id|xmtfs
op_amp
id|MACE_XMTFS_LCOL
)paren
(brace
multiline_comment|/* Late Collision */
id|lp-&gt;mace_stats.lcol
op_increment
suffix:semicolon
)brace
r_if
c_cond
(paren
id|xmtfs
op_amp
id|MACE_XMTFS_MORE
)paren
(brace
multiline_comment|/* MORE than one retry was needed */
id|lp-&gt;mace_stats.more
op_increment
suffix:semicolon
)brace
r_if
c_cond
(paren
id|xmtfs
op_amp
id|MACE_XMTFS_ONE
)paren
(brace
multiline_comment|/* Exactly ONE retry occurred */
id|lp-&gt;mace_stats.one
op_increment
suffix:semicolon
)brace
r_if
c_cond
(paren
id|xmtfs
op_amp
id|MACE_XMTFS_DEFER
)paren
(brace
multiline_comment|/* Transmission was defered */
id|lp-&gt;mace_stats.defer
op_increment
suffix:semicolon
)brace
r_if
c_cond
(paren
id|xmtfs
op_amp
id|MACE_XMTFS_LCAR
)paren
(brace
multiline_comment|/* Loss of carrier */
id|lp-&gt;mace_stats.lcar
op_increment
suffix:semicolon
)brace
r_if
c_cond
(paren
id|xmtfs
op_amp
id|MACE_XMTFS_RTRY
)paren
(brace
multiline_comment|/* Retry error: transmit aborted after 16 attempts */
id|lp-&gt;mace_stats.rtry
op_increment
suffix:semicolon
)brace
)brace
multiline_comment|/* if (xmtfs &amp; ~MACE_XMTFS_XMTSV) */
)brace
multiline_comment|/* if (xmtfs &amp; MACE_XMTFS_XMTSV) */
id|lp-&gt;linux_stats.tx_packets
op_increment
suffix:semicolon
id|lp-&gt;tx_free_frames
op_increment
suffix:semicolon
id|netif_wake_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
multiline_comment|/* if (status &amp; MACE_IR_XMTINT) */
r_if
c_cond
(paren
id|status
op_amp
op_complement
id|MACE_IMR_DEFAULT
op_amp
op_complement
id|MACE_IR_RCVINT
op_amp
op_complement
id|MACE_IR_XMTINT
)paren
(brace
r_if
c_cond
(paren
id|status
op_amp
id|MACE_IR_JAB
)paren
(brace
multiline_comment|/* Jabber Error.  Excessive transmit duration (20-150ms). */
id|lp-&gt;mace_stats.jab
op_increment
suffix:semicolon
)brace
r_if
c_cond
(paren
id|status
op_amp
id|MACE_IR_BABL
)paren
(brace
multiline_comment|/* Babble Error.  &gt;1518 bytes transmitted. */
id|lp-&gt;mace_stats.babl
op_increment
suffix:semicolon
)brace
r_if
c_cond
(paren
id|status
op_amp
id|MACE_IR_CERR
)paren
(brace
multiline_comment|/* Collision Error.  CERR indicates the absence of the&n;&t;   Signal Quality Error Test message after a packet&n;&t;   transmission. */
id|lp-&gt;mace_stats.cerr
op_increment
suffix:semicolon
)brace
r_if
c_cond
(paren
id|status
op_amp
id|MACE_IR_RCVCCO
)paren
(brace
multiline_comment|/* Receive Collision Count Overflow; */
id|lp-&gt;mace_stats.rcvcco
op_increment
suffix:semicolon
)brace
r_if
c_cond
(paren
id|status
op_amp
id|MACE_IR_RNTPCO
)paren
(brace
multiline_comment|/* Runt Packet Count Overflow */
id|lp-&gt;mace_stats.rntpco
op_increment
suffix:semicolon
)brace
r_if
c_cond
(paren
id|status
op_amp
id|MACE_IR_MPCO
)paren
(brace
multiline_comment|/* Missed Packet Count Overflow */
id|lp-&gt;mace_stats.mpco
op_increment
suffix:semicolon
)brace
)brace
multiline_comment|/* if (status &amp; ~MACE_IMR_DEFAULT &amp; ~MACE_IR_RCVINT &amp; ~MACE_IR_XMTINT) */
)brace
r_while
c_loop
(paren
(paren
id|status
op_amp
op_complement
id|MACE_IMR_DEFAULT
)paren
op_logical_and
(paren
op_decrement
id|IntrCnt
)paren
)paren
suffix:semicolon
id|exception
suffix:colon
r_return
suffix:semicolon
)brace
multiline_comment|/* mace_interrupt */
multiline_comment|/* ----------------------------------------------------------------------------&n;mace_rx&n;&t;Receives packets.&n;---------------------------------------------------------------------------- */
DECL|function|mace_rx
r_static
r_int
id|mace_rx
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_int
r_char
id|RxCnt
)paren
(brace
id|mace_private
op_star
id|lp
op_assign
(paren
id|mace_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|ioaddr_t
id|ioaddr
op_assign
id|dev-&gt;base_addr
suffix:semicolon
r_int
r_char
id|rx_framecnt
suffix:semicolon
r_int
r_int
id|rx_status
suffix:semicolon
r_while
c_loop
(paren
(paren
(paren
id|rx_framecnt
op_assign
id|inb
c_func
(paren
id|ioaddr
op_plus
id|AM2150_RCV_FRAME_COUNT
)paren
)paren
OG
l_int|0
)paren
op_logical_and
(paren
id|rx_framecnt
op_le
l_int|12
)paren
op_logical_and
multiline_comment|/* rx_framecnt==0xFF if card is extracted. */
(paren
id|RxCnt
op_decrement
)paren
)paren
(brace
id|rx_status
op_assign
id|inw
c_func
(paren
id|ioaddr
op_plus
id|AM2150_RCV
)paren
suffix:semicolon
id|DEBUG
c_func
(paren
l_int|3
comma
l_string|&quot;%s: in mace_rx(), framecnt 0x%X, rx_status&quot;
l_string|&quot; 0x%X.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|rx_framecnt
comma
id|rx_status
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rx_status
op_amp
id|MACE_RCVFS_RCVSTS
)paren
(brace
multiline_comment|/* Error, update stats. */
id|lp-&gt;linux_stats.rx_errors
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|rx_status
op_amp
id|MACE_RCVFS_OFLO
)paren
(brace
id|lp-&gt;mace_stats.oflo
op_increment
suffix:semicolon
)brace
r_if
c_cond
(paren
id|rx_status
op_amp
id|MACE_RCVFS_CLSN
)paren
(brace
id|lp-&gt;mace_stats.clsn
op_increment
suffix:semicolon
)brace
r_if
c_cond
(paren
id|rx_status
op_amp
id|MACE_RCVFS_FRAM
)paren
(brace
id|lp-&gt;mace_stats.fram
op_increment
suffix:semicolon
)brace
r_if
c_cond
(paren
id|rx_status
op_amp
id|MACE_RCVFS_FCS
)paren
(brace
id|lp-&gt;mace_stats.fcs
op_increment
suffix:semicolon
)brace
)brace
r_else
(brace
r_int
id|pkt_len
op_assign
(paren
id|rx_status
op_amp
op_complement
id|MACE_RCVFS_RCVSTS
)paren
op_minus
l_int|4
suffix:semicolon
multiline_comment|/* Auto Strip is off, always subtract 4 */
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
id|lp-&gt;mace_stats.rfs_rntpc
op_add_assign
id|inb
c_func
(paren
id|ioaddr
op_plus
id|AM2150_RCV
)paren
suffix:semicolon
multiline_comment|/* runt packet count */
id|lp-&gt;mace_stats.rfs_rcvcc
op_add_assign
id|inb
c_func
(paren
id|ioaddr
op_plus
id|AM2150_RCV
)paren
suffix:semicolon
multiline_comment|/* rcv collision count */
id|DEBUG
c_func
(paren
l_int|3
comma
l_string|&quot;    receiving packet size 0x%X rx_status&quot;
l_string|&quot; 0x%X.&bslash;n&quot;
comma
id|pkt_len
comma
id|rx_status
)paren
suffix:semicolon
id|skb
op_assign
id|dev_alloc_skb
c_func
(paren
id|pkt_len
op_plus
l_int|2
)paren
suffix:semicolon
r_if
c_cond
(paren
id|skb
op_ne
l_int|NULL
)paren
(brace
id|skb-&gt;dev
op_assign
id|dev
suffix:semicolon
id|skb_reserve
c_func
(paren
id|skb
comma
l_int|2
)paren
suffix:semicolon
id|insw
c_func
(paren
id|ioaddr
op_plus
id|AM2150_RCV
comma
id|skb_put
c_func
(paren
id|skb
comma
id|pkt_len
)paren
comma
id|pkt_len
op_rshift
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pkt_len
op_amp
l_int|1
)paren
op_star
(paren
id|skb-&gt;tail
op_minus
l_int|1
)paren
op_assign
id|inb
c_func
(paren
id|ioaddr
op_plus
id|AM2150_RCV
)paren
suffix:semicolon
id|skb-&gt;protocol
op_assign
id|eth_type_trans
c_func
(paren
id|skb
comma
id|dev
)paren
suffix:semicolon
id|netif_rx
c_func
(paren
id|skb
)paren
suffix:semicolon
multiline_comment|/* Send the packet to the upper (protocol) layers. */
id|lp-&gt;linux_stats.rx_packets
op_increment
suffix:semicolon
id|lp-&gt;linux_stats.rx_bytes
op_add_assign
id|skb-&gt;len
suffix:semicolon
id|outb
c_func
(paren
l_int|0xFF
comma
id|ioaddr
op_plus
id|AM2150_RCV_NEXT
)paren
suffix:semicolon
multiline_comment|/* skip to next frame */
r_continue
suffix:semicolon
)brace
r_else
(brace
id|DEBUG
c_func
(paren
l_int|1
comma
l_string|&quot;%s: couldn&squot;t allocate a sk_buff of size&quot;
l_string|&quot; %d.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|pkt_len
)paren
suffix:semicolon
id|lp-&gt;linux_stats.rx_dropped
op_increment
suffix:semicolon
)brace
)brace
id|outb
c_func
(paren
l_int|0xFF
comma
id|ioaddr
op_plus
id|AM2150_RCV_NEXT
)paren
suffix:semicolon
multiline_comment|/* skip to next frame */
)brace
multiline_comment|/* while */
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* mace_rx */
multiline_comment|/* ----------------------------------------------------------------------------&n;pr_linux_stats&n;---------------------------------------------------------------------------- */
DECL|function|pr_linux_stats
r_static
r_void
id|pr_linux_stats
c_func
(paren
r_struct
id|net_device_stats
op_star
id|pstats
)paren
(brace
id|DEBUG
c_func
(paren
l_int|2
comma
l_string|&quot;pr_linux_stats&bslash;n&quot;
)paren
suffix:semicolon
id|DEBUG
c_func
(paren
l_int|2
comma
l_string|&quot; rx_packets=%-7ld        tx_packets=%ld&bslash;n&quot;
comma
(paren
r_int
)paren
id|pstats-&gt;rx_packets
comma
(paren
r_int
)paren
id|pstats-&gt;tx_packets
)paren
suffix:semicolon
id|DEBUG
c_func
(paren
l_int|2
comma
l_string|&quot; rx_errors=%-7ld         tx_errors=%ld&bslash;n&quot;
comma
(paren
r_int
)paren
id|pstats-&gt;rx_errors
comma
(paren
r_int
)paren
id|pstats-&gt;tx_errors
)paren
suffix:semicolon
id|DEBUG
c_func
(paren
l_int|2
comma
l_string|&quot; rx_dropped=%-7ld        tx_dropped=%ld&bslash;n&quot;
comma
(paren
r_int
)paren
id|pstats-&gt;rx_dropped
comma
(paren
r_int
)paren
id|pstats-&gt;tx_dropped
)paren
suffix:semicolon
id|DEBUG
c_func
(paren
l_int|2
comma
l_string|&quot; multicast=%-7ld         collisions=%ld&bslash;n&quot;
comma
(paren
r_int
)paren
id|pstats-&gt;multicast
comma
(paren
r_int
)paren
id|pstats-&gt;collisions
)paren
suffix:semicolon
id|DEBUG
c_func
(paren
l_int|2
comma
l_string|&quot; rx_length_errors=%-7ld  rx_over_errors=%ld&bslash;n&quot;
comma
(paren
r_int
)paren
id|pstats-&gt;rx_length_errors
comma
(paren
r_int
)paren
id|pstats-&gt;rx_over_errors
)paren
suffix:semicolon
id|DEBUG
c_func
(paren
l_int|2
comma
l_string|&quot; rx_crc_errors=%-7ld     rx_frame_errors=%ld&bslash;n&quot;
comma
(paren
r_int
)paren
id|pstats-&gt;rx_crc_errors
comma
(paren
r_int
)paren
id|pstats-&gt;rx_frame_errors
)paren
suffix:semicolon
id|DEBUG
c_func
(paren
l_int|2
comma
l_string|&quot; rx_fifo_errors=%-7ld    rx_missed_errors=%ld&bslash;n&quot;
comma
(paren
r_int
)paren
id|pstats-&gt;rx_fifo_errors
comma
(paren
r_int
)paren
id|pstats-&gt;rx_missed_errors
)paren
suffix:semicolon
id|DEBUG
c_func
(paren
l_int|2
comma
l_string|&quot; tx_aborted_errors=%-7ld tx_carrier_errors=%ld&bslash;n&quot;
comma
(paren
r_int
)paren
id|pstats-&gt;tx_aborted_errors
comma
(paren
r_int
)paren
id|pstats-&gt;tx_carrier_errors
)paren
suffix:semicolon
id|DEBUG
c_func
(paren
l_int|2
comma
l_string|&quot; tx_fifo_errors=%-7ld    tx_heartbeat_errors=%ld&bslash;n&quot;
comma
(paren
r_int
)paren
id|pstats-&gt;tx_fifo_errors
comma
(paren
r_int
)paren
id|pstats-&gt;tx_heartbeat_errors
)paren
suffix:semicolon
id|DEBUG
c_func
(paren
l_int|2
comma
l_string|&quot; tx_window_errors=%ld&bslash;n&quot;
comma
(paren
r_int
)paren
id|pstats-&gt;tx_window_errors
)paren
suffix:semicolon
)brace
multiline_comment|/* pr_linux_stats */
multiline_comment|/* ----------------------------------------------------------------------------&n;pr_mace_stats&n;---------------------------------------------------------------------------- */
DECL|function|pr_mace_stats
r_static
r_void
id|pr_mace_stats
c_func
(paren
id|mace_statistics
op_star
id|pstats
)paren
(brace
id|DEBUG
c_func
(paren
l_int|2
comma
l_string|&quot;pr_mace_stats&bslash;n&quot;
)paren
suffix:semicolon
id|DEBUG
c_func
(paren
l_int|2
comma
l_string|&quot; xmtsv=%-7d             uflo=%d&bslash;n&quot;
comma
id|pstats-&gt;xmtsv
comma
id|pstats-&gt;uflo
)paren
suffix:semicolon
id|DEBUG
c_func
(paren
l_int|2
comma
l_string|&quot; lcol=%-7d              more=%d&bslash;n&quot;
comma
id|pstats-&gt;lcol
comma
id|pstats-&gt;more
)paren
suffix:semicolon
id|DEBUG
c_func
(paren
l_int|2
comma
l_string|&quot; one=%-7d               defer=%d&bslash;n&quot;
comma
id|pstats-&gt;one
comma
id|pstats-&gt;defer
)paren
suffix:semicolon
id|DEBUG
c_func
(paren
l_int|2
comma
l_string|&quot; lcar=%-7d              rtry=%d&bslash;n&quot;
comma
id|pstats-&gt;lcar
comma
id|pstats-&gt;rtry
)paren
suffix:semicolon
multiline_comment|/* MACE_XMTRC */
id|DEBUG
c_func
(paren
l_int|2
comma
l_string|&quot; exdef=%-7d             xmtrc=%d&bslash;n&quot;
comma
id|pstats-&gt;exdef
comma
id|pstats-&gt;xmtrc
)paren
suffix:semicolon
multiline_comment|/* RFS1--Receive Status (RCVSTS) */
id|DEBUG
c_func
(paren
l_int|2
comma
l_string|&quot; oflo=%-7d              clsn=%d&bslash;n&quot;
comma
id|pstats-&gt;oflo
comma
id|pstats-&gt;clsn
)paren
suffix:semicolon
id|DEBUG
c_func
(paren
l_int|2
comma
l_string|&quot; fram=%-7d              fcs=%d&bslash;n&quot;
comma
id|pstats-&gt;fram
comma
id|pstats-&gt;fcs
)paren
suffix:semicolon
multiline_comment|/* RFS2--Runt Packet Count (RNTPC) */
multiline_comment|/* RFS3--Receive Collision Count (RCVCC) */
id|DEBUG
c_func
(paren
l_int|2
comma
l_string|&quot; rfs_rntpc=%-7d         rfs_rcvcc=%d&bslash;n&quot;
comma
id|pstats-&gt;rfs_rntpc
comma
id|pstats-&gt;rfs_rcvcc
)paren
suffix:semicolon
multiline_comment|/* MACE_IR */
id|DEBUG
c_func
(paren
l_int|2
comma
l_string|&quot; jab=%-7d               babl=%d&bslash;n&quot;
comma
id|pstats-&gt;jab
comma
id|pstats-&gt;babl
)paren
suffix:semicolon
id|DEBUG
c_func
(paren
l_int|2
comma
l_string|&quot; cerr=%-7d              rcvcco=%d&bslash;n&quot;
comma
id|pstats-&gt;cerr
comma
id|pstats-&gt;rcvcco
)paren
suffix:semicolon
id|DEBUG
c_func
(paren
l_int|2
comma
l_string|&quot; rntpco=%-7d            mpco=%d&bslash;n&quot;
comma
id|pstats-&gt;rntpco
comma
id|pstats-&gt;mpco
)paren
suffix:semicolon
multiline_comment|/* MACE_MPC */
id|DEBUG
c_func
(paren
l_int|2
comma
l_string|&quot; mpc=%d&bslash;n&quot;
comma
id|pstats-&gt;mpc
)paren
suffix:semicolon
multiline_comment|/* MACE_RNTPC */
id|DEBUG
c_func
(paren
l_int|2
comma
l_string|&quot; rntpc=%d&bslash;n&quot;
comma
id|pstats-&gt;rntpc
)paren
suffix:semicolon
multiline_comment|/* MACE_RCVCC */
id|DEBUG
c_func
(paren
l_int|2
comma
l_string|&quot; rcvcc=%d&bslash;n&quot;
comma
id|pstats-&gt;rcvcc
)paren
suffix:semicolon
)brace
multiline_comment|/* pr_mace_stats */
multiline_comment|/* ----------------------------------------------------------------------------&n;update_stats&n;&t;Update statistics.  We change to register window 1, so this&n;&t;should be run single-threaded if the device is active. This is&n;&t;expected to be a rare operation, and it&squot;s simpler for the rest&n;&t;of the driver to assume that window 0 is always valid rather&n;&t;than use a special window-state variable.&n;&n;&t;oflo &amp; uflo should _never_ occur since it would mean the Xilinx&n;&t;was not able to transfer data between the MACE FIFO and the&n;&t;card&squot;s SRAM fast enough.  If this happens, something is&n;&t;seriously wrong with the hardware.&n;---------------------------------------------------------------------------- */
DECL|function|update_stats
r_static
r_void
id|update_stats
c_func
(paren
id|ioaddr_t
id|ioaddr
comma
r_struct
id|net_device
op_star
id|dev
)paren
(brace
id|mace_private
op_star
id|lp
op_assign
(paren
id|mace_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|lp-&gt;mace_stats.rcvcc
op_add_assign
id|mace_read
c_func
(paren
id|ioaddr
comma
id|MACE_RCVCC
)paren
suffix:semicolon
id|lp-&gt;mace_stats.rntpc
op_add_assign
id|mace_read
c_func
(paren
id|ioaddr
comma
id|MACE_RNTPC
)paren
suffix:semicolon
id|lp-&gt;mace_stats.mpc
op_add_assign
id|mace_read
c_func
(paren
id|ioaddr
comma
id|MACE_MPC
)paren
suffix:semicolon
multiline_comment|/* At this point, mace_stats is fully updated for this call.&n;     We may now update the linux_stats. */
multiline_comment|/* The MACE has no equivalent for linux_stats field which are commented&n;     out. */
multiline_comment|/* lp-&gt;linux_stats.multicast; */
id|lp-&gt;linux_stats.collisions
op_assign
id|lp-&gt;mace_stats.rcvcco
op_star
l_int|256
op_plus
id|lp-&gt;mace_stats.rcvcc
suffix:semicolon
multiline_comment|/* Collision: The MACE may retry sending a packet 15 times&n;       before giving up.  The retry count is in XMTRC.&n;       Does each retry constitute a collision?&n;       If so, why doesn&squot;t the RCVCC record these collisions? */
multiline_comment|/* detailed rx_errors: */
id|lp-&gt;linux_stats.rx_length_errors
op_assign
id|lp-&gt;mace_stats.rntpco
op_star
l_int|256
op_plus
id|lp-&gt;mace_stats.rntpc
suffix:semicolon
multiline_comment|/* lp-&gt;linux_stats.rx_over_errors */
id|lp-&gt;linux_stats.rx_crc_errors
op_assign
id|lp-&gt;mace_stats.fcs
suffix:semicolon
id|lp-&gt;linux_stats.rx_frame_errors
op_assign
id|lp-&gt;mace_stats.fram
suffix:semicolon
id|lp-&gt;linux_stats.rx_fifo_errors
op_assign
id|lp-&gt;mace_stats.oflo
suffix:semicolon
id|lp-&gt;linux_stats.rx_missed_errors
op_assign
id|lp-&gt;mace_stats.mpco
op_star
l_int|256
op_plus
id|lp-&gt;mace_stats.mpc
suffix:semicolon
multiline_comment|/* detailed tx_errors */
id|lp-&gt;linux_stats.tx_aborted_errors
op_assign
id|lp-&gt;mace_stats.rtry
suffix:semicolon
id|lp-&gt;linux_stats.tx_carrier_errors
op_assign
id|lp-&gt;mace_stats.lcar
suffix:semicolon
multiline_comment|/* LCAR usually results from bad cabling. */
id|lp-&gt;linux_stats.tx_fifo_errors
op_assign
id|lp-&gt;mace_stats.uflo
suffix:semicolon
id|lp-&gt;linux_stats.tx_heartbeat_errors
op_assign
id|lp-&gt;mace_stats.cerr
suffix:semicolon
multiline_comment|/* lp-&gt;linux_stats.tx_window_errors; */
r_return
suffix:semicolon
)brace
multiline_comment|/* update_stats */
multiline_comment|/* ----------------------------------------------------------------------------&n;mace_get_stats&n;&t;Gathers ethernet statistics from the MACE chip.&n;---------------------------------------------------------------------------- */
DECL|function|mace_get_stats
r_static
r_struct
id|net_device_stats
op_star
id|mace_get_stats
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
id|mace_private
op_star
id|lp
op_assign
(paren
id|mace_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|update_stats
c_func
(paren
id|dev-&gt;base_addr
comma
id|dev
)paren
suffix:semicolon
id|DEBUG
c_func
(paren
l_int|1
comma
l_string|&quot;%s: updating the statistics.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|pr_linux_stats
c_func
(paren
op_amp
id|lp-&gt;linux_stats
)paren
suffix:semicolon
id|pr_mace_stats
c_func
(paren
op_amp
id|lp-&gt;mace_stats
)paren
suffix:semicolon
r_return
op_amp
id|lp-&gt;linux_stats
suffix:semicolon
)brace
multiline_comment|/* net_device_stats */
multiline_comment|/* ----------------------------------------------------------------------------&n;updateCRC&n;&t;Modified from Am79C90 data sheet.&n;---------------------------------------------------------------------------- */
macro_line|#if BROKEN_MULTICAST
DECL|function|updateCRC
r_static
r_void
id|updateCRC
c_func
(paren
r_int
op_star
id|CRC
comma
r_int
id|bit
)paren
(brace
r_int
id|poly
(braket
)braket
op_assign
initialization_block
suffix:semicolon
multiline_comment|/* CRC polynomial.  poly[n] = coefficient of the x**n term of the&n;&t;CRC generator polynomial. */
r_int
id|j
suffix:semicolon
multiline_comment|/* shift CRC and control bit (CRC[32]) */
r_for
c_loop
(paren
id|j
op_assign
l_int|32
suffix:semicolon
id|j
OG
l_int|0
suffix:semicolon
id|j
op_decrement
)paren
id|CRC
(braket
id|j
)braket
op_assign
id|CRC
(braket
id|j
op_minus
l_int|1
)braket
suffix:semicolon
id|CRC
(braket
l_int|0
)braket
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* If bit XOR(control bit) = 1, set CRC = CRC XOR polynomial. */
r_if
c_cond
(paren
id|bit
op_xor
id|CRC
(braket
l_int|32
)braket
)paren
r_for
c_loop
(paren
id|j
op_assign
l_int|0
suffix:semicolon
id|j
OL
l_int|32
suffix:semicolon
id|j
op_increment
)paren
id|CRC
(braket
id|j
)braket
op_xor_assign
id|poly
(braket
id|j
)braket
suffix:semicolon
)brace
multiline_comment|/* updateCRC */
multiline_comment|/* ----------------------------------------------------------------------------&n;BuildLAF&n;&t;Build logical address filter.&n;&t;Modified from Am79C90 data sheet.&n;&n;Input&n;&t;ladrf: logical address filter (contents initialized to 0)&n;&t;adr: ethernet address&n;---------------------------------------------------------------------------- */
DECL|function|BuildLAF
r_static
r_void
id|BuildLAF
c_func
(paren
r_int
op_star
id|ladrf
comma
r_int
op_star
id|adr
)paren
(brace
r_int
id|CRC
(braket
l_int|33
)braket
op_assign
initialization_block
suffix:semicolon
multiline_comment|/* CRC register, 1 word/bit + extra control bit */
r_int
id|i
comma
id|byte
suffix:semicolon
multiline_comment|/* temporary array indices */
r_int
id|hashcode
suffix:semicolon
multiline_comment|/* the output object */
id|CRC
(braket
l_int|32
)braket
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|byte
op_assign
l_int|0
suffix:semicolon
id|byte
OL
l_int|6
suffix:semicolon
id|byte
op_increment
)paren
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|8
suffix:semicolon
id|i
op_increment
)paren
id|updateCRC
c_func
(paren
id|CRC
comma
(paren
id|adr
(braket
id|byte
)braket
op_rshift
id|i
)paren
op_amp
l_int|1
)paren
suffix:semicolon
id|hashcode
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|6
suffix:semicolon
id|i
op_increment
)paren
id|hashcode
op_assign
(paren
id|hashcode
op_lshift
l_int|1
)paren
op_plus
id|CRC
(braket
id|i
)braket
suffix:semicolon
id|byte
op_assign
id|hashcode
op_rshift
l_int|3
suffix:semicolon
id|ladrf
(braket
id|byte
)braket
op_or_assign
(paren
l_int|1
op_lshift
(paren
id|hashcode
op_amp
l_int|7
)paren
)paren
suffix:semicolon
macro_line|#ifdef PCMCIA_DEBUG
r_if
c_cond
(paren
id|pc_debug
OG
l_int|2
)paren
(brace
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;    adr =&quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|6
suffix:semicolon
id|i
op_increment
)paren
id|printk
c_func
(paren
l_string|&quot; %02X&quot;
comma
id|adr
(braket
id|i
)braket
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;&bslash;n&quot;
id|KERN_DEBUG
l_string|&quot;    hashcode = %d(decimal), ladrf[0:63]&quot;
l_string|&quot; =&quot;
comma
id|hashcode
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|8
suffix:semicolon
id|i
op_increment
)paren
id|printk
c_func
(paren
l_string|&quot; %02X&quot;
comma
id|ladrf
(braket
id|i
)braket
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
)brace
macro_line|#endif
)brace
multiline_comment|/* BuildLAF */
multiline_comment|/* ----------------------------------------------------------------------------&n;restore_multicast_list&n;&t;Restores the multicast filter for MACE chip to the last&n;&t;set_multicast_list() call.&n;&n;Input&n;&t;multicast_num_addrs&n;&t;multicast_ladrf[]&n;---------------------------------------------------------------------------- */
DECL|function|restore_multicast_list
r_static
r_void
id|restore_multicast_list
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
id|mace_private
op_star
id|lp
op_assign
(paren
id|mace_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_int
id|num_addrs
op_assign
id|lp-&gt;multicast_num_addrs
suffix:semicolon
r_int
op_star
id|ladrf
op_assign
id|lp-&gt;multicast_ladrf
suffix:semicolon
id|ioaddr_t
id|ioaddr
op_assign
id|dev-&gt;base_addr
suffix:semicolon
r_int
id|i
suffix:semicolon
id|DEBUG
c_func
(paren
l_int|2
comma
l_string|&quot;%s: restoring Rx mode to %d addresses.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|num_addrs
)paren
suffix:semicolon
r_if
c_cond
(paren
id|num_addrs
OG
l_int|0
)paren
(brace
id|DEBUG
c_func
(paren
l_int|1
comma
l_string|&quot;Attempt to restore multicast list detected.&bslash;n&quot;
)paren
suffix:semicolon
id|mace_write
c_func
(paren
id|ioaddr
comma
id|MACE_IAC
comma
id|MACE_IAC_ADDRCHG
op_or
id|MACE_IAC_LOGADDR
)paren
suffix:semicolon
multiline_comment|/* Poll ADDRCHG bit */
r_while
c_loop
(paren
id|mace_read
c_func
(paren
id|ioaddr
comma
id|MACE_IAC
)paren
op_amp
id|MACE_IAC_ADDRCHG
)paren
suffix:semicolon
multiline_comment|/* Set LADRF register */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|MACE_LADRF_LEN
suffix:semicolon
id|i
op_increment
)paren
id|mace_write
c_func
(paren
id|ioaddr
comma
id|MACE_LADRF
comma
id|ladrf
(braket
id|i
)braket
)paren
suffix:semicolon
id|mace_write
c_func
(paren
id|ioaddr
comma
id|MACE_UTR
comma
id|MACE_UTR_RCVFCSE
op_or
id|MACE_UTR_LOOP_EXTERNAL
)paren
suffix:semicolon
id|mace_write
c_func
(paren
id|ioaddr
comma
id|MACE_MACCC
comma
id|MACE_MACCC_ENXMT
op_or
id|MACE_MACCC_ENRCV
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|num_addrs
OL
l_int|0
)paren
(brace
multiline_comment|/* Promiscuous mode: receive all packets */
id|mace_write
c_func
(paren
id|ioaddr
comma
id|MACE_UTR
comma
id|MACE_UTR_LOOP_EXTERNAL
)paren
suffix:semicolon
id|mace_write
c_func
(paren
id|ioaddr
comma
id|MACE_MACCC
comma
id|MACE_MACCC_PROM
op_or
id|MACE_MACCC_ENXMT
op_or
id|MACE_MACCC_ENRCV
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* Normal mode */
id|mace_write
c_func
(paren
id|ioaddr
comma
id|MACE_UTR
comma
id|MACE_UTR_LOOP_EXTERNAL
)paren
suffix:semicolon
id|mace_write
c_func
(paren
id|ioaddr
comma
id|MACE_MACCC
comma
id|MACE_MACCC_ENXMT
op_or
id|MACE_MACCC_ENRCV
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* restore_multicast_list */
multiline_comment|/* ----------------------------------------------------------------------------&n;set_multicast_list&n;&t;Set or clear the multicast filter for this adaptor.&n;&n;Input&n;&t;num_addrs == -1&t;Promiscuous mode, receive all packets&n;&t;num_addrs == 0&t;Normal mode, clear multicast list&n;&t;num_addrs &gt; 0&t;Multicast mode, receive normal and MC packets, and do&n;&t;&t;&t;best-effort filtering.&n;Output&n;&t;multicast_num_addrs&n;&t;multicast_ladrf[]&n;---------------------------------------------------------------------------- */
DECL|function|set_multicast_list
r_static
r_void
id|set_multicast_list
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
id|mace_private
op_star
id|lp
op_assign
(paren
id|mace_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_int
id|adr
(braket
id|ETHER_ADDR_LEN
)braket
op_assign
(brace
l_int|0
)brace
suffix:semicolon
multiline_comment|/* Ethernet address */
r_int
id|i
suffix:semicolon
r_struct
id|dev_mc_list
op_star
id|dmi
op_assign
id|dev-&gt;mc_list
suffix:semicolon
macro_line|#ifdef PCMCIA_DEBUG
r_if
c_cond
(paren
id|pc_debug
OG
l_int|1
)paren
(brace
r_static
r_int
id|old
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;mc_count
op_ne
id|old
)paren
(brace
id|old
op_assign
id|dev-&gt;mc_count
suffix:semicolon
id|DEBUG
c_func
(paren
l_int|0
comma
l_string|&quot;%s: setting Rx mode to %d addresses.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|old
)paren
suffix:semicolon
)brace
)brace
macro_line|#endif
multiline_comment|/* Set multicast_num_addrs. */
id|lp-&gt;multicast_num_addrs
op_assign
id|dev-&gt;mc_count
suffix:semicolon
multiline_comment|/* Set multicast_ladrf. */
r_if
c_cond
(paren
id|num_addrs
OG
l_int|0
)paren
(brace
multiline_comment|/* Calculate multicast logical address filter */
id|memset
c_func
(paren
id|lp-&gt;multicast_ladrf
comma
l_int|0
comma
id|MACE_LADRF_LEN
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|dev-&gt;mc_count
suffix:semicolon
id|i
op_increment
)paren
(brace
id|memcpy
c_func
(paren
id|adr
comma
id|dmi-&gt;dmi_addr
comma
id|ETHER_ADDR_LEN
)paren
suffix:semicolon
id|dmi
op_assign
id|dmi-&gt;next
suffix:semicolon
id|BuildLAF
c_func
(paren
id|lp-&gt;multicast_ladrf
comma
id|adr
)paren
suffix:semicolon
)brace
)brace
id|restore_multicast_list
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
multiline_comment|/* set_multicast_list */
macro_line|#endif /* BROKEN_MULTICAST */
DECL|function|restore_multicast_list
r_static
r_void
id|restore_multicast_list
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
id|ioaddr_t
id|ioaddr
op_assign
id|dev-&gt;base_addr
suffix:semicolon
id|DEBUG
c_func
(paren
l_int|2
comma
l_string|&quot;%s: restoring Rx mode to %d addresses.&bslash;n&quot;
comma
id|dev-&gt;name
comma
(paren
(paren
id|mace_private
op_star
)paren
(paren
id|dev-&gt;priv
)paren
)paren
op_member_access_from_pointer
id|multicast_num_addrs
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;flags
op_amp
id|IFF_PROMISC
)paren
(brace
multiline_comment|/* Promiscuous mode: receive all packets */
id|mace_write
c_func
(paren
id|ioaddr
comma
id|MACE_UTR
comma
id|MACE_UTR_LOOP_EXTERNAL
)paren
suffix:semicolon
id|mace_write
c_func
(paren
id|ioaddr
comma
id|MACE_MACCC
comma
id|MACE_MACCC_PROM
op_or
id|MACE_MACCC_ENXMT
op_or
id|MACE_MACCC_ENRCV
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* Normal mode */
id|mace_write
c_func
(paren
id|ioaddr
comma
id|MACE_UTR
comma
id|MACE_UTR_LOOP_EXTERNAL
)paren
suffix:semicolon
id|mace_write
c_func
(paren
id|ioaddr
comma
id|MACE_MACCC
comma
id|MACE_MACCC_ENXMT
op_or
id|MACE_MACCC_ENRCV
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* restore_multicast_list */
DECL|function|set_multicast_list
r_static
r_void
id|set_multicast_list
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
id|mace_private
op_star
id|lp
op_assign
(paren
id|mace_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
macro_line|#ifdef PCMCIA_DEBUG
r_if
c_cond
(paren
id|pc_debug
OG
l_int|1
)paren
(brace
r_static
r_int
id|old
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;mc_count
op_ne
id|old
)paren
(brace
id|old
op_assign
id|dev-&gt;mc_count
suffix:semicolon
id|DEBUG
c_func
(paren
l_int|0
comma
l_string|&quot;%s: setting Rx mode to %d addresses.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|old
)paren
suffix:semicolon
)brace
)brace
macro_line|#endif
id|lp-&gt;multicast_num_addrs
op_assign
id|dev-&gt;mc_count
suffix:semicolon
id|restore_multicast_list
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
multiline_comment|/* set_multicast_list */
multiline_comment|/* ----------------------------------------------------------------------------&n;init_nmclan_cs&n;---------------------------------------------------------------------------- */
DECL|function|init_nmclan_cs
r_static
r_int
id|__init
id|init_nmclan_cs
c_func
(paren
r_void
)paren
(brace
id|servinfo_t
id|serv
suffix:semicolon
id|DEBUG
c_func
(paren
l_int|0
comma
l_string|&quot;%s&bslash;n&quot;
comma
id|version
)paren
suffix:semicolon
id|CardServices
c_func
(paren
id|GetCardServicesInfo
comma
op_amp
id|serv
)paren
suffix:semicolon
r_if
c_cond
(paren
id|serv.Revision
op_ne
id|CS_RELEASE_CODE
)paren
(brace
id|printk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;nmclan_cs: Card Services release does not match!&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|register_pccard_driver
c_func
(paren
op_amp
id|dev_info
comma
op_amp
id|nmclan_attach
comma
op_amp
id|nmclan_detach
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* ----------------------------------------------------------------------------&n;exit_nmclan_cs&n;---------------------------------------------------------------------------- */
DECL|function|exit_nmclan_cs
r_static
r_void
id|__exit
id|exit_nmclan_cs
c_func
(paren
r_void
)paren
(brace
id|DEBUG
c_func
(paren
l_int|0
comma
l_string|&quot;nmclan_cs: unloading&bslash;n&quot;
)paren
suffix:semicolon
id|unregister_pccard_driver
c_func
(paren
op_amp
id|dev_info
)paren
suffix:semicolon
r_while
c_loop
(paren
id|dev_list
op_ne
l_int|NULL
)paren
id|nmclan_detach
c_func
(paren
id|dev_list
)paren
suffix:semicolon
)brace
DECL|variable|init_nmclan_cs
id|module_init
c_func
(paren
id|init_nmclan_cs
)paren
suffix:semicolon
DECL|variable|exit_nmclan_cs
id|module_exit
c_func
(paren
id|exit_nmclan_cs
)paren
suffix:semicolon
eof
