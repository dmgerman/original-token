multiline_comment|/* &n; * net-3-driver for the NI5210 card (i82586 Ethernet chip)&n; *&n; * This is an extension to the Linux operating system, and is covered by the&n; * same Gnu Public License that covers that work.&n; * &n; * Alphacode 0.51 (94/08/19) for Linux 1.1.47 (or later)&n; * Copyrights (c) 1994 by Michael Hipp (mhipp@student.uni-tuebingen.de)&n; *    [feel free to mail ....]&n; *&n; * CAN YOU PLEASE REPORT ME YOUR PERFORMANCE EXPERIENCES !!.&n; *&n; * autoprobe for: base_addr: 0x300,0x280,0x360,0x320,0x340&n; *                mem_start: 0xd0000,0xd4000,0xd8000 (8K and 16K)&n; *&n; * sources:&n; *   skeleton.c from Donald Becker&n; *&n; * I have also done a look in the following sources: (mail me if you need them)&n; *   crynwr-packet-driver by Russ Nelson&n; *   Garret A. Wollman&squot;s (fourth) i82586-driver for BSD&n; *   (before getting an i82596 manual, the existing drivers helped&n; *    me a lot to understand this tricky chip.)&n; *&n; * Known Bugs:&n; *   The internal sysbus seems to be slow. So we often lose packets because of&n; *   overruns while receiving from a fast remote host. &n; *   This can slow down TCP connections. Maybe the newer ni5210 cards are better.&n; */
multiline_comment|/*&n; * 19.Aug.94: changed request_irq() parameter (MH)&n; * &n; * 20.July.94: removed cleanup bugs, removed a 16K-mem-probe-bug (MH)&n; *&n; * 19.July.94: lotsa cleanups .. (MH)&n; *&n; * 17.July.94: some patches ... verified to run with 1.1.29 (MH)&n; *&n; * 4.July.94: patches for Linux 1.1.24  (MH)&n; *&n; * 26.March.94: patches for Linux 1.0 and iomem-auto-probe (MH)&n; *&n; * 30.Sep.93: Added nop-chain .. driver now runs with only one Xmit-Buff, too (MH)&n; */
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/ptrace.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/ioport.h&gt;
macro_line|#include &lt;linux/malloc.h&gt;
macro_line|#include &lt;linux/interrupt.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;asm/bitops.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;linux/netdevice.h&gt;
macro_line|#include &lt;linux/etherdevice.h&gt;
macro_line|#include &lt;linux/skbuff.h&gt;
macro_line|#include &quot;ni52.h&quot;
DECL|macro|DEBUG
mdefine_line|#define DEBUG   /* debug on */
multiline_comment|/*&n;#define DEBUG1&n;#define DEBUG2&n;#define DEBUG3&n;*/
DECL|macro|SYSBUSVAL
mdefine_line|#define SYSBUSVAL 1
DECL|macro|ni_attn586
mdefine_line|#define ni_attn586()  {outb(0,dev-&gt;base_addr+NI52_ATTENTION);}
DECL|macro|ni_reset586
mdefine_line|#define ni_reset586() {outb(0,dev-&gt;base_addr+NI52_RESET);}
DECL|macro|make32
mdefine_line|#define make32(ptr16) (p-&gt;memtop + (short) (ptr16) )
DECL|macro|make24
mdefine_line|#define make24(ptr32) ((char *) (ptr32) - p-&gt;base)
DECL|macro|make16
mdefine_line|#define make16(ptr32) ((unsigned short) ((unsigned long) (ptr32) - (unsigned long) p-&gt;memtop ))
multiline_comment|/******************* how to calc the buffers *****************************&n;&n;IMPORTANT NOTE: if you configure only one NUM_XMIT_BUFFS, do also a &n;---------------   #define ONLY_ONE_XMIT_BUF&n;                btw: it seems, that only the ONLY_ONE_XMIT_BUF Mode is stable&n;&n;&n;sizeof(scp)=12; sizeof(scb)=16; sizeof(iscp)=8;&n;sizeof(scp)+sizeof(iscp)+sizeof(scb) = 36 = INIT&n;sizeof(rfd) = 24; sizeof(rbd) = 12; &n;sizeof(tbd) = 8; sizeof(transmit_cmd) = 16;&n;sizeof(nop_cmd) = 8; &n;&n;examples:&n;---------&n;&n;-&gt;cfg1: NUM_RECV_FRAMES=16, NUM_RECV_BUFFS=48, RECV_BUFF_SIZE=256, &n;        NUM_XMIT_BUFFS=2 ,XMIT_BUFF_SIZE=1514&n;&n;NUM_RECV_FRAMES * sizeof(rfd) = 384;&n;NUM_RECV_BUFFS * ( sizeof(rbd) + RECV_BUFF_SIZE) = 12864&n;NUM_XMIT_BUFFS * ( sizeof(tbd+transmit_cmd+nop_cmd) + XMIT_BUFF_SIZE) = 3092&n;INIT = 36&n;--------------------&n;16358   (36 bytes left!)&n;&n;************************&n;&n;-&gt;cfg2: NUM_RECV_FRAMES=9, NUM_RECV_BUFFS=18, RECV_BUFF_SIZE=256, &n;        NUM_XMIT_BUFFS=2 ,XMIT_BUFF_SIZE=1514&n;&n;NUM_RECV_FRAMES * sizeof(rfd) = 216&n;NUM_RECV_BUFFS * ( sizeof(rbd) + RECV_BUFF_SIZE) = 4824&n;NUM_XMIT_BUFFS * ( sizeof(tbd+transmit_cmd+nop_cmd) + XMIT_BUFF_SIZE) = 3092&n;INIT = 36&n;------------------&n;8180    (24 bytes left!)&n;&n;-&gt;cfg3: NUM_RECV_FRAMES=7, NUM_RECV_BUFFS=24, RECV_BUFF_SIZE=256, &n;        NUM_XMIT_BUFFS=1, XMIT_BUFF_SIZE=1514&n;        168  +  6432  +  1538  +  36  +  16 = 8190 &n;&n;***************************************************************************/
macro_line|#if 0
multiline_comment|/* config-1 for 16Kram card */
macro_line|#  define NUM_RECV_FRAMES 16&t;/* number of frames to allow for receive */
macro_line|#  define NUM_RECV_BUFFS 48&t;/* number of buffers to allocate */
macro_line|#  define RECV_BUFF_SIZE 256&t;/* size of each buffer, POWER OF 2 &amp; EVEN*/
macro_line|#  define XMIT_BUFF_SIZE 1514&t;/* length of transmit buffer (EVEN) */
macro_line|#  define NUM_XMIT_BUFFS 2&t;/* number of Xmit-Buffs */
macro_line|#elif 0
multiline_comment|/* config-2 for 8Kram card */
DECL|macro|NUM_RECV_FRAMES
macro_line|#  define NUM_RECV_FRAMES 9
DECL|macro|NUM_RECV_BUFFS
macro_line|#  define NUM_RECV_BUFFS 18
DECL|macro|RECV_BUFF_SIZE
macro_line|#  define RECV_BUFF_SIZE 256
DECL|macro|XMIT_BUFF_SIZE
macro_line|#  define XMIT_BUFF_SIZE 1514
DECL|macro|NUM_XMIT_BUFFS
macro_line|#  define NUM_XMIT_BUFFS 2
macro_line|#elif 1
multiline_comment|/*&n; * config-3 for 8Kram card  ___use_this_config____ seems to be stable&n; */
DECL|macro|NUM_RECV_FRAMES
macro_line|#  define NUM_RECV_FRAMES 7
DECL|macro|NUM_RECV_BUFFS
macro_line|#  define NUM_RECV_BUFFS 24
DECL|macro|RECV_BUFF_SIZE
macro_line|#  define RECV_BUFF_SIZE 256
DECL|macro|XMIT_BUFF_SIZE
macro_line|#  define XMIT_BUFF_SIZE 1514
DECL|macro|NUM_XMIT_BUFFS
macro_line|#  define NUM_XMIT_BUFFS 1
DECL|macro|ONLY_ONE_XMIT_BUF
macro_line|#  define ONLY_ONE_XMIT_BUF 
DECL|macro|NO_NOPCOMMANDS
macro_line|#  define NO_NOPCOMMANDS
macro_line|#elif 0
multiline_comment|/*&n; * cfg-4 for 16K, ONLY_ONE_XMIT_BUF&n; */
DECL|macro|NUM_RECV_FRAMES
macro_line|#  define NUM_RECV_FRAMES 20
DECL|macro|NUM_RECV_BUFFS
macro_line|#  define NUM_RECV_BUFFS 27
DECL|macro|RECV_BUFF_SIZE
macro_line|#  define RECV_BUFF_SIZE 512
DECL|macro|XMIT_BUFF_SIZE
macro_line|#  define XMIT_BUFF_SIZE 1514
DECL|macro|NUM_XMIT_BUFFS
macro_line|#  define NUM_XMIT_BUFFS 1
DECL|macro|ONLY_ONE_XMIT_BUF
macro_line|#  define ONLY_ONE_XMIT_BUF
macro_line|#else
DECL|macro|NUM_RECV_FRAMES
macro_line|#  define NUM_RECV_FRAMES 4
DECL|macro|NUM_RECV_BUFFS
macro_line|#  define NUM_RECV_BUFFS 4
DECL|macro|RECV_BUFF_SIZE
macro_line|#  define RECV_BUFF_SIZE 1536
DECL|macro|XMIT_BUFF_SIZE
macro_line|#  define XMIT_BUFF_SIZE 1536
DECL|macro|NUM_XMIT_BUFFS
macro_line|#  define NUM_XMIT_BUFFS 1
DECL|macro|ONLY_ONE_XMIT_BUF
macro_line|#  define ONLY_ONE_XMIT_BUF
DECL|macro|NO_NOPCOMMANDS
macro_line|#  define NO_NOPCOMMANDS
macro_line|#endif
DECL|macro|DELAY
mdefine_line|#define DELAY(x) {int i=jiffies; &bslash;&n;                  if(loops_per_sec == 1) &bslash;&n;                     while(i+(x)&gt;jiffies); &bslash;&n;                  else &bslash;&n;                     __delay((loops_per_sec&gt;&gt;5)*x); &bslash;&n;                 }
r_extern
r_void
id|autoirq_setup
c_func
(paren
r_int
id|waittime
)paren
suffix:semicolon
r_extern
r_int
id|autoirq_report
c_func
(paren
r_int
id|waittime
)paren
suffix:semicolon
r_extern
r_void
op_star
id|irq2dev_map
(braket
l_int|16
)braket
suffix:semicolon
macro_line|#ifndef HAVE_PORTRESERVE
DECL|macro|check_region
mdefine_line|#define check_region(ioaddr, size) &t;&t;0
DECL|macro|register_iomem
mdefine_line|#define&t;register_iomem(ioaddr, size,name);&t;&t;do ; while (0)
macro_line|#endif
DECL|macro|NI52_TOTAL_SIZE
mdefine_line|#define NI52_TOTAL_SIZE 16
DECL|macro|NI52_ADDR0
mdefine_line|#define NI52_ADDR0 0x02
DECL|macro|NI52_ADDR1
mdefine_line|#define NI52_ADDR1 0x07
DECL|macro|NI52_ADDR2
mdefine_line|#define NI52_ADDR2 0x01
r_static
r_int
id|ni52_probe1
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
r_int
id|ioaddr
)paren
suffix:semicolon
r_static
r_void
id|ni52_interrupt
c_func
(paren
r_int
id|reg_ptr
)paren
suffix:semicolon
r_static
r_int
id|ni52_open
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_int
id|ni52_close
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_int
id|ni52_send_packet
c_func
(paren
r_struct
id|sk_buff
op_star
comma
r_struct
id|device
op_star
)paren
suffix:semicolon
r_static
r_struct
id|enet_statistics
op_star
id|ni52_get_stats
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_void
id|set_multicast_list
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
r_int
id|num_addrs
comma
r_void
op_star
id|addrs
)paren
suffix:semicolon
multiline_comment|/* helper-functions */
r_static
r_int
id|init586
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_int
id|check586
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
r_char
op_star
id|where
comma
r_int
id|size
)paren
suffix:semicolon
r_static
r_void
id|alloc586
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_void
id|startrecv586
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_void
op_star
id|alloc_rfa
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
r_void
op_star
id|ptr
)paren
suffix:semicolon
r_static
r_void
id|ni52_rcv_int
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_void
id|ni52_xmt_int
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_void
id|ni52_rnr_int
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
suffix:semicolon
DECL|struct|priv
r_struct
id|priv
(brace
DECL|member|stats
r_struct
id|enet_statistics
id|stats
suffix:semicolon
DECL|member|base
r_int
r_int
id|base
suffix:semicolon
DECL|member|memtop
DECL|member|max_cbuff32
DECL|member|min_cbuff32
DECL|member|max_cbuff24
r_char
op_star
id|memtop
comma
op_star
id|max_cbuff32
comma
op_star
id|min_cbuff32
comma
op_star
id|max_cbuff24
suffix:semicolon
DECL|member|rbd_last
r_volatile
r_struct
id|rbd_struct
op_star
id|rbd_last
suffix:semicolon
DECL|member|rfd_last
DECL|member|rfd_top
DECL|member|rfd_first
r_volatile
r_struct
id|rfd_struct
op_star
id|rfd_last
comma
op_star
id|rfd_top
comma
op_star
id|rfd_first
suffix:semicolon
DECL|member|scp
r_volatile
r_struct
id|scp_struct
op_star
id|scp
suffix:semicolon
multiline_comment|/* volatile is important */
DECL|member|iscp
r_volatile
r_struct
id|iscp_struct
op_star
id|iscp
suffix:semicolon
multiline_comment|/* volatile is important */
DECL|member|scb
r_volatile
r_struct
id|scb_struct
op_star
id|scb
suffix:semicolon
multiline_comment|/* volatile is important */
DECL|member|xmit_buffs
r_volatile
r_struct
id|tbd_struct
op_star
id|xmit_buffs
(braket
id|NUM_XMIT_BUFFS
)braket
suffix:semicolon
DECL|member|xmit_cmds
r_volatile
r_struct
id|transmit_cmd_struct
op_star
id|xmit_cmds
(braket
id|NUM_XMIT_BUFFS
)braket
suffix:semicolon
macro_line|#ifdef ONLY_ONE_XMIT_BUF
DECL|member|nop_cmds
r_volatile
r_struct
id|nop_cmd_struct
op_star
id|nop_cmds
(braket
l_int|2
)braket
suffix:semicolon
macro_line|#else
DECL|member|nop_cmds
r_volatile
r_struct
id|nop_cmd_struct
op_star
id|nop_cmds
(braket
id|NUM_XMIT_BUFFS
)braket
suffix:semicolon
macro_line|#endif
DECL|member|nop_point
r_volatile
r_int
id|nop_point
suffix:semicolon
DECL|member|xmit_cbuffs
r_volatile
r_char
op_star
id|xmit_cbuffs
(braket
id|NUM_XMIT_BUFFS
)braket
suffix:semicolon
DECL|member|xmit_count
DECL|member|xmit_last
r_volatile
r_int
id|xmit_count
comma
id|xmit_last
suffix:semicolon
)brace
suffix:semicolon
multiline_comment|/**********************************************&n; * close device &n; */
DECL|function|ni52_close
r_static
r_int
id|ni52_close
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
id|free_irq
c_func
(paren
id|dev-&gt;irq
)paren
suffix:semicolon
id|irq2dev_map
(braket
id|dev-&gt;irq
)braket
op_assign
l_int|0
suffix:semicolon
id|ni_reset586
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* the hard way to stop the receiver */
id|dev-&gt;start
op_assign
l_int|0
suffix:semicolon
id|dev-&gt;tbusy
op_assign
l_int|0
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/**********************************************&n; * open device &n; */
DECL|function|ni52_open
r_static
r_int
id|ni52_open
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
id|alloc586
c_func
(paren
id|dev
)paren
suffix:semicolon
id|init586
c_func
(paren
id|dev
)paren
suffix:semicolon
id|startrecv586
c_func
(paren
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|request_irq
c_func
(paren
id|dev-&gt;irq
comma
op_amp
id|ni52_interrupt
comma
l_int|0
comma
l_string|&quot;ni52&quot;
)paren
)paren
(brace
id|ni_reset586
c_func
(paren
)paren
suffix:semicolon
r_return
op_minus
id|EAGAIN
suffix:semicolon
)brace
id|irq2dev_map
(braket
id|dev-&gt;irq
)braket
op_assign
id|dev
suffix:semicolon
id|dev-&gt;interrupt
op_assign
l_int|0
suffix:semicolon
id|dev-&gt;tbusy
op_assign
l_int|0
suffix:semicolon
id|dev-&gt;start
op_assign
l_int|1
suffix:semicolon
r_return
l_int|0
suffix:semicolon
multiline_comment|/* most done by init */
)brace
multiline_comment|/**********************************************&n; * Check to see if there&squot;s an 82586 out there. &n; */
DECL|function|check586
r_static
r_int
id|check586
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
r_char
op_star
id|where
comma
r_int
id|size
)paren
(brace
r_struct
id|priv
op_star
id|p
op_assign
(paren
r_struct
id|priv
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_char
op_star
id|iscp_addrs
(braket
l_int|2
)braket
suffix:semicolon
r_int
id|i
suffix:semicolon
id|p-&gt;base
op_assign
(paren
r_int
r_int
)paren
id|where
op_plus
id|size
op_minus
l_int|0x01000000
suffix:semicolon
id|p-&gt;memtop
op_assign
id|where
op_plus
id|size
suffix:semicolon
id|p-&gt;scp
op_assign
(paren
r_struct
id|scp_struct
op_star
)paren
(paren
id|p-&gt;base
op_plus
id|SCP_DEFAULT_ADDRESS
)paren
suffix:semicolon
id|memset
c_func
(paren
(paren
r_char
op_star
)paren
id|p-&gt;scp
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|scp_struct
)paren
)paren
suffix:semicolon
id|p-&gt;scp-&gt;sysbus
op_assign
id|SYSBUSVAL
suffix:semicolon
multiline_comment|/* 1 = 8Bit-Bus */
id|iscp_addrs
(braket
l_int|0
)braket
op_assign
id|where
suffix:semicolon
id|iscp_addrs
(braket
l_int|1
)braket
op_assign
(paren
r_char
op_star
)paren
id|p-&gt;scp
op_minus
r_sizeof
(paren
r_struct
id|iscp_struct
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|2
suffix:semicolon
id|i
op_increment
)paren
(brace
id|p-&gt;iscp
op_assign
(paren
r_struct
id|iscp_struct
op_star
)paren
id|iscp_addrs
(braket
id|i
)braket
suffix:semicolon
id|memset
c_func
(paren
(paren
r_char
op_star
)paren
id|p-&gt;iscp
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|iscp_struct
)paren
)paren
suffix:semicolon
id|p-&gt;scp-&gt;iscp
op_assign
id|make24
c_func
(paren
id|p-&gt;iscp
)paren
suffix:semicolon
id|p-&gt;iscp-&gt;busy
op_assign
l_int|1
suffix:semicolon
id|ni_reset586
c_func
(paren
)paren
suffix:semicolon
id|ni_attn586
c_func
(paren
)paren
suffix:semicolon
id|DELAY
c_func
(paren
l_int|2
)paren
suffix:semicolon
multiline_comment|/* wait a while... */
r_if
c_cond
(paren
id|p-&gt;iscp-&gt;busy
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
)brace
r_return
l_int|1
suffix:semicolon
)brace
multiline_comment|/******************************************************************&n; * set iscp at the right place, called by ni52_probe1 and open586. &n; */
DECL|function|alloc586
r_void
id|alloc586
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
r_struct
id|priv
op_star
id|p
op_assign
(paren
r_struct
id|priv
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|p-&gt;scp
op_assign
(paren
r_struct
id|scp_struct
op_star
)paren
(paren
id|p-&gt;base
op_plus
id|SCP_DEFAULT_ADDRESS
)paren
suffix:semicolon
id|p-&gt;scb
op_assign
(paren
r_struct
id|scb_struct
op_star
)paren
(paren
id|dev-&gt;mem_start
)paren
suffix:semicolon
id|p-&gt;iscp
op_assign
(paren
r_struct
id|iscp_struct
op_star
)paren
(paren
(paren
r_char
op_star
)paren
id|p-&gt;scp
op_minus
r_sizeof
(paren
r_struct
id|iscp_struct
)paren
)paren
suffix:semicolon
id|memset
c_func
(paren
(paren
r_char
op_star
)paren
id|p-&gt;iscp
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|iscp_struct
)paren
)paren
suffix:semicolon
id|memset
c_func
(paren
(paren
r_char
op_star
)paren
id|p-&gt;scp
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|scp_struct
)paren
)paren
suffix:semicolon
id|p-&gt;scp-&gt;iscp
op_assign
id|make24
c_func
(paren
id|p-&gt;iscp
)paren
suffix:semicolon
id|p-&gt;scp-&gt;sysbus
op_assign
id|SYSBUSVAL
suffix:semicolon
id|p-&gt;iscp-&gt;scb_offset
op_assign
id|make16
c_func
(paren
id|p-&gt;scb
)paren
suffix:semicolon
id|p-&gt;iscp-&gt;busy
op_assign
l_int|1
suffix:semicolon
id|ni_reset586
c_func
(paren
)paren
suffix:semicolon
id|ni_attn586
c_func
(paren
)paren
suffix:semicolon
macro_line|#ifdef DEBUG
id|DELAY
c_func
(paren
l_int|2
)paren
suffix:semicolon
r_if
c_cond
(paren
id|p-&gt;iscp-&gt;busy
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%s: Init-Problems (alloc).&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
)brace
macro_line|#endif
id|memset
c_func
(paren
(paren
r_char
op_star
)paren
id|p-&gt;scb
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|scb_struct
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/**********************************************&n; * probe the ni5210-card&n; */
DECL|function|ni52_probe
r_int
id|ni52_probe
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
r_int
op_star
id|port
comma
id|ports
(braket
)braket
op_assign
(brace
l_int|0x300
comma
l_int|0x280
comma
l_int|0x360
comma
l_int|0x320
comma
l_int|0x340
comma
l_int|0
)brace
suffix:semicolon
r_int
id|base_addr
op_assign
id|dev-&gt;base_addr
suffix:semicolon
r_if
c_cond
(paren
id|base_addr
OG
l_int|0x1ff
)paren
multiline_comment|/* Check a single specified location. */
r_if
c_cond
(paren
(paren
id|inb
c_func
(paren
id|base_addr
op_plus
id|NI52_MAGIC1
)paren
op_eq
id|NI52_MAGICVAL1
)paren
op_logical_and
(paren
id|inb
c_func
(paren
id|base_addr
op_plus
id|NI52_MAGIC2
)paren
op_eq
id|NI52_MAGICVAL2
)paren
)paren
(brace
r_return
id|ni52_probe1
c_func
(paren
id|dev
comma
id|base_addr
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|base_addr
OG
l_int|0
)paren
multiline_comment|/* Don&squot;t probe at all. */
r_return
id|ENXIO
suffix:semicolon
r_for
c_loop
(paren
id|port
op_assign
id|ports
suffix:semicolon
op_star
id|port
suffix:semicolon
id|port
op_increment
)paren
(brace
r_int
id|ioaddr
op_assign
op_star
id|port
suffix:semicolon
r_if
c_cond
(paren
id|check_region
c_func
(paren
id|ioaddr
comma
id|NI52_TOTAL_SIZE
)paren
)paren
r_continue
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|inb
c_func
(paren
id|ioaddr
op_plus
id|NI52_MAGIC1
)paren
op_eq
id|NI52_MAGICVAL1
)paren
op_logical_or
op_logical_neg
(paren
id|inb
c_func
(paren
id|ioaddr
op_plus
id|NI52_MAGIC2
)paren
op_eq
id|NI52_MAGICVAL2
)paren
)paren
(brace
r_continue
suffix:semicolon
)brace
id|dev-&gt;base_addr
op_assign
id|ioaddr
suffix:semicolon
r_if
c_cond
(paren
id|ni52_probe1
c_func
(paren
id|dev
comma
id|ioaddr
)paren
op_eq
l_int|0
)paren
r_return
l_int|0
suffix:semicolon
)brace
id|dev-&gt;base_addr
op_assign
id|base_addr
suffix:semicolon
r_return
id|ENODEV
suffix:semicolon
)brace
DECL|function|ni52_probe1
r_static
r_int
id|ni52_probe1
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
r_int
id|ioaddr
)paren
(brace
r_int
id|memaddrs
(braket
)braket
op_assign
(brace
l_int|0xd0000
comma
l_int|0xd2000
comma
l_int|0xd4000
comma
l_int|0xd6000
comma
l_int|0xd8000
comma
l_int|0
)brace
suffix:semicolon
r_int
id|i
comma
id|size
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|ETH_ALEN
suffix:semicolon
id|i
op_increment
)paren
(brace
id|dev-&gt;dev_addr
(braket
id|i
)braket
op_assign
id|inb
c_func
(paren
id|dev-&gt;base_addr
op_plus
id|i
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|dev-&gt;dev_addr
(braket
l_int|0
)braket
op_ne
id|NI52_ADDR0
op_logical_or
id|dev-&gt;dev_addr
(braket
l_int|1
)braket
op_ne
id|NI52_ADDR1
op_logical_or
id|dev-&gt;dev_addr
(braket
l_int|2
)braket
op_ne
id|NI52_ADDR2
)paren
(brace
r_return
id|ENODEV
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;%s: Ni52 found at %#3x, &quot;
comma
id|dev-&gt;name
comma
id|dev-&gt;base_addr
)paren
suffix:semicolon
id|register_iomem
c_func
(paren
id|ioaddr
comma
id|NI52_TOTAL_SIZE
comma
l_string|&quot;ni52&quot;
)paren
suffix:semicolon
id|dev-&gt;priv
op_assign
(paren
r_void
op_star
)paren
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|priv
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
multiline_comment|/* warning: we don&squot;t free it on errors */
id|memset
c_func
(paren
(paren
r_char
op_star
)paren
id|dev-&gt;priv
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|priv
)paren
)paren
suffix:semicolon
multiline_comment|/* &n;   * check (or search) IO-Memory, 8K and 16K&n;   */
r_if
c_cond
(paren
id|dev-&gt;mem_start
op_ne
l_int|0
)paren
multiline_comment|/* no auto-mem-probe */
(brace
id|size
op_assign
l_int|0x4000
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|check586
c_func
(paren
id|dev
comma
(paren
r_char
op_star
)paren
id|dev-&gt;mem_start
comma
id|size
)paren
)paren
(brace
id|size
op_assign
l_int|0x2000
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|check586
c_func
(paren
id|dev
comma
(paren
r_char
op_star
)paren
id|dev-&gt;mem_start
comma
id|size
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;?memprobe, Can&squot;t find memory at 0x%lx!&bslash;n&quot;
comma
id|dev-&gt;mem_start
)paren
suffix:semicolon
r_return
id|ENODEV
suffix:semicolon
)brace
)brace
)brace
r_else
(brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|memaddrs
(braket
id|i
)braket
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;?memprobe, Can&squot;t find io-memory!&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|ENODEV
suffix:semicolon
)brace
id|dev-&gt;mem_start
op_assign
id|memaddrs
(braket
id|i
)braket
suffix:semicolon
id|size
op_assign
l_int|0x2000
suffix:semicolon
r_if
c_cond
(paren
id|check586
c_func
(paren
id|dev
comma
(paren
r_char
op_star
)paren
id|dev-&gt;mem_start
comma
id|size
)paren
)paren
(brace
multiline_comment|/* 8K-check */
r_break
suffix:semicolon
)brace
id|size
op_assign
l_int|0x4000
suffix:semicolon
r_if
c_cond
(paren
id|check586
c_func
(paren
id|dev
comma
(paren
r_char
op_star
)paren
id|dev-&gt;mem_start
comma
id|size
)paren
)paren
(brace
multiline_comment|/* 16K-check */
r_break
suffix:semicolon
)brace
)brace
)brace
(paren
(paren
r_struct
id|priv
op_star
)paren
(paren
id|dev-&gt;priv
)paren
)paren
op_member_access_from_pointer
id|base
op_assign
id|dev-&gt;mem_start
op_plus
id|size
op_minus
l_int|0x01000000
suffix:semicolon
id|alloc586
c_func
(paren
id|dev
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;Memaddr: 0x%lx, Memsize: %d, &quot;
comma
id|dev-&gt;mem_start
comma
id|size
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;irq
OL
l_int|2
)paren
(brace
id|autoirq_setup
c_func
(paren
l_int|0
)paren
suffix:semicolon
id|ni_reset586
c_func
(paren
)paren
suffix:semicolon
id|ni_attn586
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|dev-&gt;irq
op_assign
id|autoirq_report
c_func
(paren
l_int|2
)paren
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;?autoirq, Failed to detect IRQ line!&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
)brace
r_else
r_if
c_cond
(paren
id|dev-&gt;irq
op_eq
l_int|2
)paren
(brace
id|dev-&gt;irq
op_assign
l_int|9
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;IRQ %d.&bslash;n&quot;
comma
id|dev-&gt;irq
)paren
suffix:semicolon
id|dev-&gt;open
op_assign
op_amp
id|ni52_open
suffix:semicolon
id|dev-&gt;stop
op_assign
op_amp
id|ni52_close
suffix:semicolon
id|dev-&gt;get_stats
op_assign
op_amp
id|ni52_get_stats
suffix:semicolon
id|dev-&gt;hard_start_xmit
op_assign
op_amp
id|ni52_send_packet
suffix:semicolon
id|dev-&gt;set_multicast_list
op_assign
op_amp
id|set_multicast_list
suffix:semicolon
id|dev-&gt;if_port
op_assign
l_int|0
suffix:semicolon
id|ether_setup
c_func
(paren
id|dev
)paren
suffix:semicolon
id|dev-&gt;tbusy
op_assign
l_int|0
suffix:semicolon
id|dev-&gt;interrupt
op_assign
l_int|0
suffix:semicolon
id|dev-&gt;start
op_assign
l_int|0
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/********************************************** &n; * init the chip (ni52-interrupt should be disabled?!)&n; * needs a correct &squot;allocated&squot; memory&n; */
DECL|function|init586
r_static
r_int
id|init586
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
r_void
op_star
id|ptr
suffix:semicolon
r_int
r_int
id|s
suffix:semicolon
r_int
id|i
comma
id|result
op_assign
l_int|0
suffix:semicolon
r_struct
id|priv
op_star
id|p
op_assign
(paren
r_struct
id|priv
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_volatile
r_struct
id|configure_cmd_struct
op_star
id|cfg_cmd
suffix:semicolon
r_volatile
r_struct
id|iasetup_cmd_struct
op_star
id|ias_cmd
suffix:semicolon
r_volatile
r_struct
id|tdr_cmd_struct
op_star
id|tdr_cmd
suffix:semicolon
id|ptr
op_assign
(paren
r_void
op_star
)paren
(paren
(paren
r_char
op_star
)paren
id|p-&gt;scb
op_plus
r_sizeof
(paren
r_struct
id|scb_struct
)paren
)paren
suffix:semicolon
id|cfg_cmd
op_assign
(paren
r_struct
id|configure_cmd_struct
op_star
)paren
id|ptr
suffix:semicolon
multiline_comment|/* configure-command */
id|cfg_cmd-&gt;byte_cnt
op_assign
l_int|0x04
suffix:semicolon
multiline_comment|/* number of cfg bytes */
id|cfg_cmd-&gt;fifo
op_assign
l_int|0xc8
suffix:semicolon
multiline_comment|/* fifo-limit (8=tx:32/rx:64) | monitor */
id|cfg_cmd-&gt;sav_bf
op_assign
l_int|0x40
suffix:semicolon
multiline_comment|/* hold or discard bad recv frames (bit 7) */
id|cfg_cmd-&gt;adr_len
op_assign
l_int|0x2e
suffix:semicolon
multiline_comment|/* addr_len |!src_insert |pre-len |loopback */
id|cfg_cmd-&gt;cmd_status
op_assign
l_int|0
suffix:semicolon
id|cfg_cmd-&gt;cmd_cmd
op_assign
id|CMD_CONFIGURE
op_or
id|CMD_LAST
suffix:semicolon
id|cfg_cmd-&gt;cmd_link
op_assign
l_int|0xffff
suffix:semicolon
id|p-&gt;scb-&gt;cbl_offset
op_assign
id|make16
c_func
(paren
id|cfg_cmd
)paren
suffix:semicolon
id|p-&gt;scb-&gt;cmd
op_assign
id|CUC_START
suffix:semicolon
multiline_comment|/* cmd.-unit start */
id|ni_attn586
c_func
(paren
)paren
suffix:semicolon
id|s
op_assign
id|jiffies
suffix:semicolon
multiline_comment|/* warning: only active with interrupts on !! */
r_while
c_loop
(paren
op_logical_neg
(paren
id|cfg_cmd-&gt;cmd_status
op_amp
id|STAT_COMPL
)paren
)paren
r_if
c_cond
(paren
id|jiffies
op_minus
id|s
OG
l_int|30
)paren
(brace
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|cfg_cmd-&gt;cmd_status
op_amp
(paren
id|STAT_OK
op_or
id|STAT_COMPL
)paren
)paren
op_ne
(paren
id|STAT_COMPL
op_or
id|STAT_OK
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%s (ni52): configure command failed: %x&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|cfg_cmd-&gt;cmd_status
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
multiline_comment|/*&n;     * individual address setup&n;     */
id|ias_cmd
op_assign
(paren
r_struct
id|iasetup_cmd_struct
op_star
)paren
id|ptr
suffix:semicolon
id|ias_cmd-&gt;cmd_status
op_assign
l_int|0
suffix:semicolon
id|ias_cmd-&gt;cmd_cmd
op_assign
id|CMD_IASETUP
op_or
id|CMD_LAST
suffix:semicolon
id|ias_cmd-&gt;cmd_link
op_assign
l_int|0xffff
suffix:semicolon
id|memcpy
c_func
(paren
(paren
r_char
op_star
)paren
op_amp
id|ias_cmd-&gt;iaddr
comma
(paren
r_char
op_star
)paren
id|dev-&gt;dev_addr
comma
id|ETH_ALEN
)paren
suffix:semicolon
id|p-&gt;scb-&gt;cbl_offset
op_assign
id|make16
c_func
(paren
id|ias_cmd
)paren
suffix:semicolon
id|p-&gt;scb-&gt;cmd
op_assign
id|CUC_START
suffix:semicolon
multiline_comment|/* cmd.-unit start */
id|ni_attn586
c_func
(paren
)paren
suffix:semicolon
id|s
op_assign
id|jiffies
suffix:semicolon
r_while
c_loop
(paren
op_logical_neg
(paren
id|ias_cmd-&gt;cmd_status
op_amp
id|STAT_COMPL
)paren
)paren
r_if
c_cond
(paren
id|jiffies
op_minus
id|s
OG
l_int|30
)paren
(brace
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|ias_cmd-&gt;cmd_status
op_amp
(paren
id|STAT_OK
op_or
id|STAT_COMPL
)paren
)paren
op_ne
(paren
id|STAT_OK
op_or
id|STAT_COMPL
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%s (ni52): individual address setup command failed: %04x&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|ias_cmd-&gt;cmd_status
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
multiline_comment|/* &n;    * TDR, wire check .. e.g. no resistor e.t.c &n;    */
id|tdr_cmd
op_assign
(paren
r_struct
id|tdr_cmd_struct
op_star
)paren
id|ptr
suffix:semicolon
id|tdr_cmd-&gt;cmd_status
op_assign
l_int|0
suffix:semicolon
id|tdr_cmd-&gt;cmd_cmd
op_assign
id|CMD_TDR
op_or
id|CMD_LAST
suffix:semicolon
id|tdr_cmd-&gt;cmd_link
op_assign
l_int|0xffff
suffix:semicolon
id|tdr_cmd-&gt;status
op_assign
l_int|0
suffix:semicolon
id|p-&gt;scb-&gt;cbl_offset
op_assign
id|make16
c_func
(paren
id|tdr_cmd
)paren
suffix:semicolon
id|p-&gt;scb-&gt;cmd
op_assign
id|CUC_START
suffix:semicolon
multiline_comment|/* cmd.-unit start */
id|ni_attn586
c_func
(paren
)paren
suffix:semicolon
id|s
op_assign
id|jiffies
suffix:semicolon
r_while
c_loop
(paren
op_logical_neg
(paren
id|tdr_cmd-&gt;cmd_status
op_amp
id|STAT_COMPL
)paren
)paren
r_if
c_cond
(paren
id|jiffies
op_minus
id|s
OG
l_int|30
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%s: Problems while running the TDR.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|result
op_assign
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|result
)paren
(brace
id|DELAY
c_func
(paren
l_int|2
)paren
suffix:semicolon
multiline_comment|/* wait for result */
id|result
op_assign
id|tdr_cmd-&gt;status
suffix:semicolon
id|p-&gt;scb-&gt;cmd
op_assign
id|p-&gt;scb-&gt;status
op_amp
id|STAT_MASK
suffix:semicolon
id|ni_attn586
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* ack the interrupts */
r_if
c_cond
(paren
id|result
op_amp
id|TDR_LNK_OK
)paren
(brace
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|result
op_amp
id|TDR_XCVR_PRB
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%s: TDR: Transceiver problem!&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|result
op_amp
id|TDR_ET_OPN
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%s: TDR: No correct termination %d clocks away.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|result
op_amp
id|TDR_TIMEMASK
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|result
op_amp
id|TDR_ET_SRT
)paren
(brace
r_if
c_cond
(paren
id|result
op_amp
id|TDR_TIMEMASK
)paren
multiline_comment|/* time == 0 -&gt; strange :-) */
id|printk
c_func
(paren
l_string|&quot;%s: TDR: Detected a short circuit %d clocks away.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|result
op_amp
id|TDR_TIMEMASK
)paren
suffix:semicolon
)brace
r_else
id|printk
c_func
(paren
l_string|&quot;%s: TDR: Unknown status %04x&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|result
)paren
suffix:semicolon
)brace
multiline_comment|/* &n;    * ack interrupts &n;    */
id|p-&gt;scb-&gt;cmd
op_assign
id|p-&gt;scb-&gt;status
op_amp
id|STAT_MASK
suffix:semicolon
id|ni_attn586
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/*&n;    * alloc nop/xmit-cmds&n;    */
macro_line|#ifdef ONLY_ONE_XMIT_BUF
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|2
suffix:semicolon
id|i
op_increment
)paren
(brace
id|p-&gt;nop_cmds
(braket
id|i
)braket
op_assign
(paren
r_struct
id|nop_cmd_struct
op_star
)paren
id|ptr
suffix:semicolon
id|p-&gt;nop_cmds
(braket
id|i
)braket
op_member_access_from_pointer
id|cmd_cmd
op_assign
l_int|0
suffix:semicolon
id|p-&gt;nop_cmds
(braket
id|i
)braket
op_member_access_from_pointer
id|cmd_status
op_assign
l_int|0
suffix:semicolon
id|p-&gt;nop_cmds
(braket
id|i
)braket
op_member_access_from_pointer
id|cmd_link
op_assign
id|make16
c_func
(paren
(paren
id|p-&gt;nop_cmds
(braket
id|i
)braket
)paren
)paren
suffix:semicolon
id|ptr
op_add_assign
r_sizeof
(paren
r_struct
id|nop_cmd_struct
)paren
suffix:semicolon
)brace
id|p-&gt;xmit_cmds
(braket
l_int|0
)braket
op_assign
(paren
r_struct
id|transmit_cmd_struct
op_star
)paren
id|ptr
suffix:semicolon
multiline_comment|/* transmit cmd/buff 0 */
id|ptr
op_add_assign
r_sizeof
(paren
r_struct
id|transmit_cmd_struct
)paren
suffix:semicolon
macro_line|#else
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|NUM_XMIT_BUFFS
suffix:semicolon
id|i
op_increment
)paren
(brace
id|p-&gt;nop_cmds
(braket
id|i
)braket
op_assign
(paren
r_struct
id|nop_cmd_struct
op_star
)paren
id|ptr
suffix:semicolon
id|p-&gt;nop_cmds
(braket
id|i
)braket
op_member_access_from_pointer
id|cmd_cmd
op_assign
l_int|0
suffix:semicolon
id|p-&gt;nop_cmds
(braket
id|i
)braket
op_member_access_from_pointer
id|cmd_status
op_assign
l_int|0
suffix:semicolon
id|p-&gt;nop_cmds
(braket
id|i
)braket
op_member_access_from_pointer
id|cmd_link
op_assign
id|make16
c_func
(paren
(paren
id|p-&gt;nop_cmds
(braket
id|i
)braket
)paren
)paren
suffix:semicolon
id|ptr
op_add_assign
r_sizeof
(paren
r_struct
id|nop_cmd_struct
)paren
suffix:semicolon
id|p-&gt;xmit_cmds
(braket
id|i
)braket
op_assign
(paren
r_struct
id|transmit_cmd_struct
op_star
)paren
id|ptr
suffix:semicolon
multiline_comment|/* transmit cmd/buff 0 */
id|ptr
op_add_assign
r_sizeof
(paren
r_struct
id|transmit_cmd_struct
)paren
suffix:semicolon
)brace
macro_line|#endif
id|ptr
op_assign
id|alloc_rfa
c_func
(paren
id|dev
comma
(paren
r_void
op_star
)paren
id|ptr
)paren
suffix:semicolon
multiline_comment|/* init receive-frame-area */
multiline_comment|/*&n;    * alloc xmit-buffs &n;    */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|NUM_XMIT_BUFFS
suffix:semicolon
id|i
op_increment
)paren
(brace
id|p-&gt;xmit_cbuffs
(braket
id|i
)braket
op_assign
(paren
r_char
op_star
)paren
id|ptr
suffix:semicolon
multiline_comment|/* char-buffs */
id|ptr
op_add_assign
id|XMIT_BUFF_SIZE
suffix:semicolon
id|p-&gt;xmit_buffs
(braket
id|i
)braket
op_assign
(paren
r_struct
id|tbd_struct
op_star
)paren
id|ptr
suffix:semicolon
multiline_comment|/* TBD */
id|ptr
op_add_assign
r_sizeof
(paren
r_struct
id|tbd_struct
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
r_void
op_star
)paren
id|ptr
OG
(paren
r_void
op_star
)paren
id|p-&gt;iscp
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%s: not enough shared-mem for your configuration!&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
id|memset
c_func
(paren
(paren
r_char
op_star
)paren
(paren
id|p-&gt;xmit_cmds
(braket
id|i
)braket
)paren
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|transmit_cmd_struct
)paren
)paren
suffix:semicolon
id|memset
c_func
(paren
(paren
r_char
op_star
)paren
(paren
id|p-&gt;xmit_buffs
(braket
id|i
)braket
)paren
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|tbd_struct
)paren
)paren
suffix:semicolon
id|p-&gt;xmit_cmds
(braket
id|i
)braket
op_member_access_from_pointer
id|cmd_status
op_assign
id|STAT_COMPL
suffix:semicolon
id|p-&gt;xmit_cmds
(braket
id|i
)braket
op_member_access_from_pointer
id|tbd_offset
op_assign
id|make16
c_func
(paren
(paren
id|p-&gt;xmit_buffs
(braket
id|i
)braket
)paren
)paren
suffix:semicolon
id|p-&gt;xmit_buffs
(braket
id|i
)braket
op_member_access_from_pointer
id|next
op_assign
l_int|0xffff
suffix:semicolon
id|p-&gt;xmit_buffs
(braket
id|i
)braket
op_member_access_from_pointer
id|buffer
op_assign
id|make24
c_func
(paren
(paren
id|p-&gt;xmit_cbuffs
(braket
id|i
)braket
)paren
)paren
suffix:semicolon
)brace
id|p-&gt;xmit_count
op_assign
l_int|0
suffix:semicolon
id|p-&gt;xmit_last
op_assign
l_int|0
suffix:semicolon
macro_line|#ifndef NO_NOPCOMMANDS
id|p-&gt;nop_point
op_assign
l_int|0
suffix:semicolon
macro_line|#endif
multiline_comment|/*&n;    * &squot;start transmitter&squot; (nop-loop)&n;    */
macro_line|#ifndef NO_NOPCOMMANDS
id|p-&gt;scb-&gt;cbl_offset
op_assign
id|make16
c_func
(paren
id|p-&gt;nop_cmds
(braket
l_int|0
)braket
)paren
suffix:semicolon
id|p-&gt;scb-&gt;cmd
op_assign
id|CUC_START
suffix:semicolon
id|ni_attn586
c_func
(paren
)paren
suffix:semicolon
r_while
c_loop
(paren
id|p-&gt;scb-&gt;cmd
)paren
(brace
suffix:semicolon
)brace
macro_line|#else
multiline_comment|/*&n;  p-&gt;nop_cmds[0]-&gt;cmd_link = make16(p-&gt;nop_cmds[1]);&n;  p-&gt;nop_cmds[1]-&gt;cmd_link = make16(p-&gt;xmit_cmds[0]);&n;*/
id|p-&gt;xmit_cmds
(braket
l_int|0
)braket
op_member_access_from_pointer
id|cmd_link
op_assign
l_int|0xffff
suffix:semicolon
id|p-&gt;xmit_cmds
(braket
l_int|0
)braket
op_member_access_from_pointer
id|cmd_cmd
op_assign
id|CMD_XMIT
op_or
id|CMD_LAST
op_or
id|CMD_INT
suffix:semicolon
macro_line|#endif
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/******************************************************&n; * This is a helper routine for ni52_nr_int() and init586(). &n; * It sets up the Receive Frame Area (RFA).&n; */
DECL|function|alloc_rfa
r_static
r_void
op_star
id|alloc_rfa
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
r_void
op_star
id|ptr
)paren
(brace
r_volatile
r_struct
id|rfd_struct
op_star
id|rfd
op_assign
(paren
r_struct
id|rfd_struct
op_star
)paren
id|ptr
suffix:semicolon
r_volatile
r_struct
id|rbd_struct
op_star
id|rbd
suffix:semicolon
r_int
id|i
suffix:semicolon
r_struct
id|priv
op_star
id|p
op_assign
(paren
r_struct
id|priv
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|memset
c_func
(paren
(paren
r_char
op_star
)paren
id|rfd
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|rfd_struct
)paren
op_star
id|NUM_RECV_FRAMES
)paren
suffix:semicolon
id|p-&gt;rfd_first
op_assign
id|rfd
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|NUM_RECV_FRAMES
suffix:semicolon
id|i
op_increment
)paren
(brace
id|rfd
(braket
id|i
)braket
dot
id|next
op_assign
id|make16
c_func
(paren
id|rfd
op_plus
(paren
id|i
op_plus
l_int|1
)paren
op_mod
id|NUM_RECV_FRAMES
)paren
suffix:semicolon
)brace
id|rfd
(braket
id|NUM_RECV_FRAMES
op_minus
l_int|1
)braket
dot
id|last
op_assign
id|RFD_LAST
suffix:semicolon
multiline_comment|/* set EOL (no RU suspend) */
id|ptr
op_assign
(paren
r_char
op_star
)paren
(paren
id|rfd
op_plus
id|NUM_RECV_FRAMES
)paren
suffix:semicolon
id|rbd
op_assign
(paren
r_struct
id|rbd_struct
op_star
)paren
id|ptr
suffix:semicolon
id|ptr
op_add_assign
r_sizeof
(paren
r_struct
id|rbd_struct
)paren
op_star
id|NUM_RECV_BUFFS
suffix:semicolon
multiline_comment|/* clr descriptors */
id|memset
c_func
(paren
(paren
r_char
op_star
)paren
id|rbd
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|rbd_struct
)paren
op_star
id|NUM_RECV_BUFFS
)paren
suffix:semicolon
id|p-&gt;min_cbuff32
op_assign
id|ptr
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|NUM_RECV_BUFFS
suffix:semicolon
id|i
op_increment
)paren
(brace
id|rbd
(braket
id|i
)braket
dot
id|next
op_assign
id|make16
c_func
(paren
(paren
id|rbd
op_plus
(paren
id|i
op_plus
l_int|1
)paren
op_mod
id|NUM_RECV_BUFFS
)paren
)paren
suffix:semicolon
id|rbd
(braket
id|i
)braket
dot
id|size
op_assign
id|RECV_BUFF_SIZE
suffix:semicolon
id|rbd
(braket
id|i
)braket
dot
id|buffer
op_assign
id|make24
c_func
(paren
id|ptr
)paren
suffix:semicolon
id|ptr
op_add_assign
id|RECV_BUFF_SIZE
suffix:semicolon
)brace
id|rbd
(braket
id|NUM_RECV_BUFFS
op_minus
l_int|1
)braket
dot
id|size
op_or_assign
id|RBD_LAST
suffix:semicolon
multiline_comment|/* set eol */
id|p-&gt;max_cbuff32
op_assign
id|ptr
suffix:semicolon
id|p-&gt;max_cbuff24
op_assign
id|make24
c_func
(paren
id|p-&gt;max_cbuff32
)paren
suffix:semicolon
id|p-&gt;rfd_top
op_assign
id|p-&gt;rfd_first
suffix:semicolon
id|p-&gt;rfd_last
op_assign
id|p-&gt;rfd_first
op_plus
id|NUM_RECV_FRAMES
op_minus
l_int|1
suffix:semicolon
id|p-&gt;rbd_last
op_assign
id|rbd
op_plus
id|NUM_RECV_BUFFS
op_minus
l_int|1
suffix:semicolon
id|p-&gt;scb-&gt;rfa_offset
op_assign
id|make16
c_func
(paren
id|p-&gt;rfd_first
)paren
suffix:semicolon
id|p-&gt;rfd_first-&gt;rbd_offset
op_assign
id|make16
c_func
(paren
id|rbd
)paren
suffix:semicolon
r_return
id|ptr
suffix:semicolon
)brace
multiline_comment|/**************************************************&n; * Interrupt Handler ...&n; */
DECL|function|ni52_interrupt
r_static
r_void
id|ni52_interrupt
c_func
(paren
r_int
id|reg_ptr
)paren
(brace
r_struct
id|device
op_star
id|dev
op_assign
(paren
r_struct
id|device
op_star
)paren
id|irq2dev_map
(braket
op_minus
(paren
(paren
r_struct
id|pt_regs
op_star
)paren
id|reg_ptr
)paren
op_member_access_from_pointer
id|orig_eax
op_minus
l_int|2
)braket
suffix:semicolon
r_int
r_int
id|stat
suffix:semicolon
r_int
id|pd
op_assign
l_int|0
suffix:semicolon
r_struct
id|priv
op_star
id|p
suffix:semicolon
macro_line|#ifdef DEBUG2
id|printk
c_func
(paren
l_string|&quot;(1)&quot;
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|dev
op_eq
l_int|NULL
)paren
(brace
id|printk
(paren
l_string|&quot;ni52-interrupt: irq %d for unknown device.&bslash;n&quot;
comma
(paren
r_int
)paren
op_minus
(paren
(paren
(paren
r_struct
id|pt_regs
op_star
)paren
id|reg_ptr
)paren
op_member_access_from_pointer
id|orig_eax
op_plus
l_int|2
)paren
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|p
op_assign
(paren
r_struct
id|priv
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;interrupt
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;(ni52-I)&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|dev-&gt;interrupt
op_assign
l_int|1
suffix:semicolon
r_while
c_loop
(paren
(paren
id|stat
op_assign
id|p-&gt;scb-&gt;status
op_amp
id|STAT_MASK
)paren
)paren
(brace
id|p-&gt;scb-&gt;cmd
op_assign
id|stat
suffix:semicolon
id|ni_attn586
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* ack inter. */
r_if
c_cond
(paren
id|pd
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;ni52-%04x/%04x-&quot;
comma
(paren
r_int
)paren
id|stat
comma
(paren
r_int
)paren
id|p-&gt;scb-&gt;status
)paren
suffix:semicolon
)brace
multiline_comment|/* debug */
r_if
c_cond
(paren
id|stat
op_amp
(paren
id|STAT_FR
op_or
id|STAT_RNR
)paren
)paren
(brace
id|ni52_rcv_int
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|stat
op_amp
id|STAT_CX
)paren
(brace
id|ni52_xmt_int
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
macro_line|#ifndef NO_NOPCOMMANDS
r_if
c_cond
(paren
id|stat
op_amp
id|STAT_CNA
)paren
macro_line|#else
r_if
c_cond
(paren
(paren
id|stat
op_amp
id|STAT_CNA
)paren
op_logical_and
op_logical_neg
(paren
id|stat
op_amp
id|STAT_CX
)paren
)paren
(brace
macro_line|#endif
id|printk
c_func
(paren
l_string|&quot;%s: oops! CU has left active state. stat: %04x/%04x.&bslash;n&quot;
comma
id|dev-&gt;name
comma
(paren
r_int
)paren
id|stat
comma
(paren
r_int
)paren
id|p-&gt;scb-&gt;status
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|stat
op_amp
id|STAT_RNR
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%s: rnr: %04x/%04x.&bslash;n&quot;
comma
id|dev-&gt;name
comma
(paren
r_int
)paren
id|stat
comma
(paren
r_int
)paren
id|p-&gt;scb-&gt;status
)paren
suffix:semicolon
id|ni52_rnr_int
c_func
(paren
id|dev
)paren
suffix:semicolon
id|pd
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* local debug on */
)brace
macro_line|#ifdef DEBUG2
id|pd
op_increment
suffix:semicolon
macro_line|#endif
r_while
c_loop
(paren
id|p-&gt;scb-&gt;cmd
)paren
(brace
r_int
id|i
suffix:semicolon
multiline_comment|/* wait for ack. (ni52_xmt_int can be faster than ack!!) */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|200
suffix:semicolon
id|i
op_increment
)paren
(brace
suffix:semicolon
)brace
)brace
)brace
macro_line|#ifdef DEBUG
(brace
r_static
r_int
id|old_ovr
op_assign
l_int|0
suffix:semicolon
r_int
id|l
suffix:semicolon
r_if
c_cond
(paren
(paren
id|l
op_assign
id|p-&gt;scb-&gt;ovrn_errs
op_minus
id|old_ovr
)paren
)paren
(brace
r_if
c_cond
(paren
id|l
OG
l_int|0
)paren
(brace
id|p-&gt;stats.rx_over_errors
op_add_assign
id|l
suffix:semicolon
)brace
r_else
id|old_ovr
op_assign
l_int|0
suffix:semicolon
)brace
)brace
macro_line|#endif
macro_line|#ifdef DEBUG2
id|printk
c_func
(paren
l_string|&quot;(2)&quot;
)paren
suffix:semicolon
macro_line|#endif
id|dev-&gt;interrupt
op_assign
l_int|0
suffix:semicolon
)brace
multiline_comment|/*******************************************************&n; * receive-interrupt&n; */
DECL|function|ni52_rcv_int
r_static
r_void
id|ni52_rcv_int
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
r_int
id|status
suffix:semicolon
r_int
r_int
id|totlen
comma
id|pnt
suffix:semicolon
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
r_struct
id|rbd_struct
op_star
id|rbd
comma
op_star
id|rbd_first
suffix:semicolon
r_struct
id|priv
op_star
id|p
op_assign
(paren
r_struct
id|priv
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_for
c_loop
(paren
suffix:semicolon
(paren
id|status
op_assign
id|p-&gt;rfd_top-&gt;status
)paren
op_amp
id|STAT_COMPL
suffix:semicolon
)paren
(brace
id|rbd
op_assign
id|rbd_first
op_assign
(paren
r_struct
id|rbd_struct
op_star
)paren
id|make32
c_func
(paren
id|p-&gt;rfd_top-&gt;rbd_offset
)paren
suffix:semicolon
macro_line|#ifdef DEBUG1
(brace
r_struct
id|rbd_struct
op_star
id|rbd1
op_assign
id|rbd
suffix:semicolon
r_if
c_cond
(paren
id|rbd1
op_eq
id|p-&gt;rbd_last
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;L&quot;
)paren
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;S:%04x/%x/%02x &gt;&quot;
comma
(paren
r_int
)paren
id|rbd1-&gt;status
comma
(paren
r_int
)paren
id|rbd1-&gt;size
op_rshift
l_int|12
comma
(paren
r_int
)paren
(paren
(paren
r_int
r_int
)paren
id|rbd1
op_amp
l_int|0xff
)paren
)paren
suffix:semicolon
id|rbd1
op_assign
(paren
r_struct
id|rbd_struct
op_star
)paren
id|make32
c_func
(paren
id|rbd1-&gt;next
)paren
suffix:semicolon
r_for
c_loop
(paren
suffix:semicolon
id|rbd1
op_ne
id|rbd_first
suffix:semicolon
id|rbd1
op_assign
(paren
r_struct
id|rbd_struct
op_star
)paren
id|make32
c_func
(paren
id|rbd1-&gt;next
)paren
)paren
(brace
r_if
c_cond
(paren
id|rbd1
op_eq
id|p-&gt;rbd_last
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;L:&quot;
)paren
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;%04x/%x-&quot;
comma
(paren
r_int
)paren
id|rbd1-&gt;status
op_rshift
l_int|12
comma
(paren
r_int
)paren
id|rbd1-&gt;size
op_rshift
l_int|12
)paren
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;&lt; &quot;
)paren
suffix:semicolon
)brace
(brace
r_struct
id|rfd_struct
op_star
id|rfd1
op_assign
id|p-&gt;rfd_top
suffix:semicolon
r_if
c_cond
(paren
id|rfd1
op_eq
id|p-&gt;rfd_last
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;L&quot;
)paren
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;S:%04x/%x/%02x &gt;&quot;
comma
(paren
r_int
)paren
id|rfd1-&gt;status
comma
(paren
r_int
)paren
id|rfd1-&gt;last
op_rshift
l_int|12
comma
(paren
r_int
)paren
(paren
(paren
r_int
r_int
)paren
id|rfd1
op_amp
l_int|0xff
)paren
)paren
suffix:semicolon
id|rfd1
op_assign
(paren
r_struct
id|rfd_struct
op_star
)paren
id|make32
c_func
(paren
id|rfd1-&gt;next
)paren
suffix:semicolon
r_for
c_loop
(paren
suffix:semicolon
id|rfd1
op_ne
id|p-&gt;rfd_top
suffix:semicolon
id|rfd1
op_assign
(paren
r_struct
id|rfd_struct
op_star
)paren
id|make32
c_func
(paren
id|rfd1-&gt;next
)paren
)paren
(brace
r_if
c_cond
(paren
id|rfd1
op_eq
id|p-&gt;rfd_last
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;L:&quot;
)paren
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;%x/%x-&quot;
comma
(paren
r_int
)paren
id|rfd1-&gt;status
op_rshift
l_int|12
comma
(paren
r_int
)paren
id|rfd1-&gt;last
op_rshift
l_int|12
)paren
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;&lt;&bslash;n&quot;
)paren
suffix:semicolon
)brace
macro_line|#endif
id|p-&gt;rfd_top-&gt;status
op_assign
l_int|0
suffix:semicolon
id|p-&gt;rfd_top-&gt;last
op_assign
id|RFD_LAST
suffix:semicolon
id|p-&gt;rfd_last-&gt;last
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* delete RFD_LAST, no RU suspend */
id|p-&gt;rfd_last
op_assign
id|p-&gt;rfd_top
suffix:semicolon
id|p-&gt;rfd_top
op_assign
(paren
r_struct
id|rfd_struct
op_star
)paren
id|make32
c_func
(paren
id|p-&gt;rfd_top-&gt;next
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
id|RFD_ERRMASK
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%s: RFD-Error ... status: %04x.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|status
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|status
op_amp
id|STAT_OK
)paren
(brace
r_for
c_loop
(paren
id|totlen
op_assign
l_int|0
suffix:semicolon
op_logical_neg
(paren
id|rbd-&gt;status
op_amp
id|RBD_LAST
)paren
suffix:semicolon
id|rbd
op_assign
(paren
r_struct
id|rbd_struct
op_star
)paren
id|make32
c_func
(paren
id|rbd-&gt;next
)paren
)paren
(brace
id|totlen
op_add_assign
id|RECV_BUFF_SIZE
suffix:semicolon
id|rbd-&gt;status
op_assign
l_int|0
suffix:semicolon
)brace
id|totlen
op_add_assign
id|rbd-&gt;status
op_amp
id|RBD_MASK
suffix:semicolon
id|rbd-&gt;status
op_assign
l_int|0
suffix:semicolon
id|skb
op_assign
(paren
r_struct
id|sk_buff
op_star
)paren
id|alloc_skb
c_func
(paren
id|totlen
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
id|skb
op_ne
l_int|NULL
)paren
multiline_comment|/* copy header */
(brace
id|skb-&gt;len
op_assign
id|totlen
suffix:semicolon
id|skb-&gt;dev
op_assign
id|dev
suffix:semicolon
r_if
c_cond
(paren
id|rbd-&gt;buffer
OL
id|rbd_first-&gt;buffer
)paren
(brace
id|pnt
op_assign
id|p-&gt;max_cbuff24
op_minus
id|rbd_first-&gt;buffer
suffix:semicolon
id|memcpy
c_func
(paren
(paren
r_char
op_star
)paren
id|skb-&gt;data
comma
id|p-&gt;max_cbuff32
op_minus
id|pnt
comma
id|pnt
)paren
suffix:semicolon
id|memcpy
c_func
(paren
(paren
r_char
op_star
)paren
id|skb-&gt;data
op_plus
id|pnt
comma
id|p-&gt;min_cbuff32
comma
id|totlen
op_minus
id|pnt
)paren
suffix:semicolon
)brace
r_else
id|memcpy
c_func
(paren
(paren
r_char
op_star
)paren
id|skb-&gt;data
comma
(paren
r_char
op_star
)paren
id|p-&gt;base
op_plus
(paren
r_int
r_int
)paren
id|rbd_first-&gt;buffer
comma
id|totlen
)paren
suffix:semicolon
id|rbd-&gt;size
op_or_assign
id|RBD_LAST
suffix:semicolon
id|p-&gt;rbd_last-&gt;size
op_and_assign
op_complement
id|RBD_LAST
suffix:semicolon
id|p-&gt;rbd_last
op_assign
id|rbd
suffix:semicolon
id|netif_rx
c_func
(paren
id|skb
)paren
suffix:semicolon
id|p-&gt;stats.rx_packets
op_increment
suffix:semicolon
)brace
r_else
(brace
id|rbd-&gt;size
op_or_assign
id|RBD_LAST
suffix:semicolon
id|p-&gt;rbd_last-&gt;size
op_and_assign
op_complement
id|RBD_LAST
suffix:semicolon
id|p-&gt;rbd_last
op_assign
id|rbd
suffix:semicolon
)brace
)brace
r_else
multiline_comment|/* frame !(ok), only with &squot;save-bad-frames&squot; */
(brace
id|printk
c_func
(paren
l_string|&quot;%s: oops! rfd-error-status: %04x&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|status
)paren
suffix:semicolon
id|p-&gt;stats.rx_errors
op_increment
suffix:semicolon
)brace
)brace
)brace
multiline_comment|/**********************************************************&n; * I never got this error , (which should occur if someone &n; * wants to blast your machine) so I couldn&squot;t debug it for now.&n; * but we _try_ to fix the receiver not ready int.&n; */
DECL|function|ni52_rnr_int
r_static
r_void
id|ni52_rnr_int
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
r_struct
id|priv
op_star
id|p
op_assign
(paren
r_struct
id|priv
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|p-&gt;stats.rx_errors
op_increment
suffix:semicolon
r_while
c_loop
(paren
id|p-&gt;scb-&gt;cmd
)paren
(brace
suffix:semicolon
)brace
multiline_comment|/* wait for the last cmd */
id|p-&gt;scb-&gt;cmd
op_assign
id|RUC_ABORT
suffix:semicolon
id|ni_attn586
c_func
(paren
)paren
suffix:semicolon
r_while
c_loop
(paren
id|p-&gt;scb-&gt;cmd
)paren
(brace
suffix:semicolon
)brace
multiline_comment|/* wait for accept cmd. */
id|alloc_rfa
c_func
(paren
id|dev
comma
(paren
r_char
op_star
)paren
id|p-&gt;rfd_first
)paren
suffix:semicolon
id|startrecv586
c_func
(paren
id|dev
)paren
suffix:semicolon
multiline_comment|/* restart */
)brace
multiline_comment|/**********************************************************&n; * handle xmit - interrupt&n; */
DECL|function|ni52_xmt_int
r_static
r_void
id|ni52_xmt_int
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
r_int
id|status
suffix:semicolon
r_struct
id|priv
op_star
id|p
op_assign
(paren
r_struct
id|priv
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
multiline_comment|/*&n;  if(!(p-&gt;xmit_cmds[0]-&gt;cmd_status &amp; STAT_COMPL))&n;    return;&n;*/
r_if
c_cond
(paren
(paren
id|status
op_assign
id|p-&gt;xmit_cmds
(braket
id|p-&gt;xmit_last
)braket
op_member_access_from_pointer
id|cmd_status
)paren
op_amp
id|STAT_OK
)paren
(brace
id|p-&gt;stats.tx_packets
op_increment
suffix:semicolon
id|p-&gt;stats.collisions
op_add_assign
(paren
id|status
op_amp
id|TCMD_MAXCOLLMASK
)paren
suffix:semicolon
id|dev-&gt;tbusy
op_assign
l_int|0
suffix:semicolon
id|mark_bh
c_func
(paren
id|NET_BH
)paren
suffix:semicolon
)brace
r_else
(brace
id|p-&gt;stats.tx_errors
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
id|TCMD_LATECOLL
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%s: late collision detected.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|p-&gt;stats.collisions
op_increment
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|status
op_amp
id|TCMD_NOCARRIER
)paren
(brace
id|p-&gt;stats.tx_carrier_errors
op_increment
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;%s: no carrier detected.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|status
op_amp
id|TCMD_LOSTCTS
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%s: loss of CTS detected.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|status
op_amp
id|TCMD_UNDERRUN
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%s: DMA underrun detected.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|status
op_amp
id|TCMD_MAXCOLL
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%s: Max. collisions exceeded.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|p-&gt;stats.collisions
op_add_assign
l_int|16
suffix:semicolon
)brace
)brace
macro_line|#ifndef ONLY_ONE_XMIT_BUF
r_if
c_cond
(paren
(paren
op_increment
id|p-&gt;xmit_last
)paren
op_eq
id|NUM_XMIT_BUFFS
)paren
(brace
id|p-&gt;xmit_last
op_assign
l_int|0
suffix:semicolon
)brace
macro_line|#endif
)brace
multiline_comment|/***********************************************************&n; * (re)start the receiver&n; */
DECL|function|startrecv586
r_static
r_void
id|startrecv586
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
r_struct
id|priv
op_star
id|p
op_assign
(paren
r_struct
id|priv
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|p-&gt;scb-&gt;rfa_offset
op_assign
id|make16
c_func
(paren
id|p-&gt;rfd_first
)paren
suffix:semicolon
id|p-&gt;scb-&gt;cmd
op_assign
id|RUC_START
suffix:semicolon
id|ni_attn586
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* start cmd. */
r_while
c_loop
(paren
id|p-&gt;scb-&gt;cmd
)paren
(brace
suffix:semicolon
)brace
multiline_comment|/* wait for accept cmd. (no timeout!!) */
id|DELAY
c_func
(paren
l_int|2
)paren
suffix:semicolon
multiline_comment|/* isn&squot;t necess. */
id|p-&gt;scb-&gt;cmd
op_assign
id|p-&gt;scb-&gt;status
op_amp
id|STAT_MASK
suffix:semicolon
id|ni_attn586
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* ack interr */
)brace
multiline_comment|/******************************************************&n; * send frame &n; */
DECL|function|ni52_send_packet
r_static
r_int
id|ni52_send_packet
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|device
op_star
id|dev
)paren
(brace
r_int
id|len
suffix:semicolon
macro_line|#ifndef NO_NOPCOMMANDS
r_int
id|next_nop
suffix:semicolon
macro_line|#endif
r_struct
id|priv
op_star
id|p
op_assign
(paren
r_struct
id|priv
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;tbusy
)paren
(brace
r_int
id|tickssofar
op_assign
id|jiffies
op_minus
id|dev-&gt;trans_start
suffix:semicolon
r_if
c_cond
(paren
id|tickssofar
OL
l_int|30
)paren
r_return
l_int|1
suffix:semicolon
macro_line|#ifdef DEBUG
id|printk
c_func
(paren
l_string|&quot;%s: xmitter timed out, try to restart! stat: %04x&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|p-&gt;scb-&gt;status
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;%s: command-stats: %04x %04x&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|p-&gt;xmit_cmds
(braket
l_int|0
)braket
op_member_access_from_pointer
id|cmd_status
comma
id|p-&gt;xmit_cmds
(braket
l_int|1
)braket
op_member_access_from_pointer
id|cmd_status
)paren
suffix:semicolon
macro_line|#endif
id|ni52_close
c_func
(paren
id|dev
)paren
suffix:semicolon
id|ni52_open
c_func
(paren
id|dev
)paren
suffix:semicolon
id|dev-&gt;trans_start
op_assign
id|jiffies
suffix:semicolon
)brace
r_if
c_cond
(paren
id|skb
op_eq
l_int|NULL
)paren
(brace
id|dev_tint
c_func
(paren
id|dev
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|skb-&gt;len
op_le
l_int|0
)paren
r_return
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|set_bit
c_func
(paren
l_int|0
comma
(paren
r_void
op_star
)paren
op_amp
id|dev-&gt;tbusy
)paren
op_ne
l_int|0
)paren
id|printk
c_func
(paren
l_string|&quot;%s: Transmitter access conflict.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_else
(brace
id|memcpy
c_func
(paren
(paren
r_char
op_star
)paren
id|p-&gt;xmit_cbuffs
(braket
id|p-&gt;xmit_count
)braket
comma
(paren
r_char
op_star
)paren
(paren
id|skb-&gt;data
)paren
comma
id|skb-&gt;len
)paren
suffix:semicolon
id|len
op_assign
(paren
id|ETH_ZLEN
OL
id|skb-&gt;len
)paren
ques
c_cond
id|skb-&gt;len
suffix:colon
id|ETH_ZLEN
suffix:semicolon
macro_line|#ifdef ONLY_ONE_XMIT_BUF  
macro_line|#  ifdef NO_NOPCOMMANDS
id|p-&gt;xmit_buffs
(braket
l_int|0
)braket
op_member_access_from_pointer
id|size
op_assign
id|TBD_LAST
op_or
id|len
suffix:semicolon
id|p-&gt;xmit_cmds
(braket
l_int|0
)braket
op_member_access_from_pointer
id|cmd_status
op_assign
l_int|0
suffix:semicolon
id|p-&gt;scb-&gt;cbl_offset
op_assign
id|make16
c_func
(paren
id|p-&gt;xmit_cmds
(braket
l_int|0
)braket
)paren
suffix:semicolon
id|p-&gt;scb-&gt;cmd
op_assign
id|CUC_START
suffix:semicolon
id|dev-&gt;trans_start
op_assign
id|jiffies
suffix:semicolon
id|ni_attn586
c_func
(paren
)paren
suffix:semicolon
r_while
c_loop
(paren
id|p-&gt;scb-&gt;cmd
)paren
r_for
c_loop
(paren
id|len
op_assign
l_int|0
suffix:semicolon
id|len
OL
l_int|256
suffix:semicolon
id|len
op_increment
)paren
(brace
suffix:semicolon
)brace
multiline_comment|/*  DELAY(1); */
multiline_comment|/* TEST;TEST;TEST */
macro_line|#  else
id|next_nop
op_assign
(paren
id|p-&gt;nop_point
op_plus
l_int|1
)paren
op_amp
l_int|0x1
suffix:semicolon
id|p-&gt;xmit_buffs
(braket
l_int|0
)braket
op_member_access_from_pointer
id|size
op_assign
id|TBD_LAST
op_or
id|len
suffix:semicolon
id|p-&gt;xmit_cmds
(braket
l_int|0
)braket
op_member_access_from_pointer
id|cmd_cmd
op_assign
id|CMD_XMIT
op_or
id|CMD_INT
suffix:semicolon
id|p-&gt;xmit_cmds
(braket
l_int|0
)braket
op_member_access_from_pointer
id|cmd_status
op_assign
l_int|0
suffix:semicolon
id|p-&gt;xmit_cmds
(braket
l_int|0
)braket
op_member_access_from_pointer
id|cmd_link
op_assign
id|p-&gt;nop_cmds
(braket
id|next_nop
)braket
op_member_access_from_pointer
id|cmd_link
op_assign
id|make16
c_func
(paren
(paren
id|p-&gt;nop_cmds
(braket
id|next_nop
)braket
)paren
)paren
suffix:semicolon
id|p-&gt;nop_cmds
(braket
id|next_nop
)braket
op_member_access_from_pointer
id|cmd_status
op_assign
l_int|0
suffix:semicolon
id|p-&gt;nop_cmds
(braket
id|p-&gt;nop_point
)braket
op_member_access_from_pointer
id|cmd_link
op_assign
id|make16
c_func
(paren
(paren
id|p-&gt;xmit_cmds
(braket
l_int|0
)braket
)paren
)paren
suffix:semicolon
id|dev-&gt;trans_start
op_assign
id|jiffies
suffix:semicolon
id|p-&gt;nop_point
op_assign
id|next_nop
suffix:semicolon
macro_line|#  endif
macro_line|#else
id|p-&gt;xmit_buffs
(braket
id|p-&gt;xmit_count
)braket
op_member_access_from_pointer
id|size
op_assign
id|TBD_LAST
op_or
id|len
suffix:semicolon
r_if
c_cond
(paren
(paren
id|next_nop
op_assign
id|p-&gt;xmit_count
op_plus
l_int|1
)paren
op_eq
id|NUM_XMIT_BUFFS
)paren
(brace
id|next_nop
op_assign
l_int|0
suffix:semicolon
)brace
id|p-&gt;xmit_cmds
(braket
id|p-&gt;xmit_count
)braket
op_member_access_from_pointer
id|cmd_cmd
op_assign
id|CMD_XMIT
op_or
id|CMD_INT
suffix:semicolon
id|p-&gt;xmit_cmds
(braket
id|p-&gt;xmit_count
)braket
op_member_access_from_pointer
id|cmd_status
op_assign
l_int|0
suffix:semicolon
id|p-&gt;xmit_cmds
(braket
id|p-&gt;xmit_count
)braket
op_member_access_from_pointer
id|cmd_link
op_assign
id|p-&gt;nop_cmds
(braket
id|next_nop
)braket
op_member_access_from_pointer
id|cmd_link
op_assign
id|make16
c_func
(paren
(paren
id|p-&gt;nop_cmds
(braket
id|next_nop
)braket
)paren
)paren
suffix:semicolon
id|p-&gt;nop_cmds
(braket
id|next_nop
)braket
op_member_access_from_pointer
id|cmd_status
op_assign
l_int|0
suffix:semicolon
id|p-&gt;nop_cmds
(braket
id|p-&gt;xmit_count
)braket
op_member_access_from_pointer
id|cmd_link
op_assign
id|make16
c_func
(paren
(paren
id|p-&gt;xmit_cmds
(braket
id|p-&gt;xmit_count
)braket
)paren
)paren
suffix:semicolon
id|dev-&gt;trans_start
op_assign
id|jiffies
suffix:semicolon
id|p-&gt;xmit_count
op_assign
id|next_nop
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|p-&gt;xmit_count
op_ne
id|p-&gt;xmit_last
)paren
(brace
id|dev-&gt;tbusy
op_assign
l_int|0
suffix:semicolon
)brace
id|sti
c_func
(paren
)paren
suffix:semicolon
macro_line|#endif
)brace
id|dev_kfree_skb
c_func
(paren
id|skb
comma
id|FREE_WRITE
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|ni52_get_stats
r_static
r_struct
id|enet_statistics
op_star
id|ni52_get_stats
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
r_struct
id|priv
op_star
id|p
op_assign
(paren
r_struct
id|priv
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
macro_line|#ifdef DEBUG3
id|printk
c_func
(paren
l_string|&quot;ni52: errs, crc %d, align %d, resource %d, ovrn %d.&bslash;n&quot;
comma
(paren
r_int
)paren
id|p-&gt;scb-&gt;crc_errs
comma
(paren
r_int
)paren
id|p-&gt;scb-&gt;aln_errs
comma
(paren
r_int
)paren
id|p-&gt;scb-&gt;rsc_errs
comma
(paren
r_int
)paren
id|p-&gt;scb-&gt;ovrn_errs
)paren
suffix:semicolon
macro_line|#endif
r_return
op_amp
id|p-&gt;stats
suffix:semicolon
)brace
DECL|function|set_multicast_list
r_static
r_void
id|set_multicast_list
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
r_int
id|num_addrs
comma
r_void
op_star
id|addrs
)paren
(brace
multiline_comment|/*&n;  struct priv *p = (struct priv *) dev-&gt;priv;&n;  volatile struct configure_cmd_struct  *cfg_cmd;&n;*/
r_if
c_cond
(paren
op_logical_neg
id|num_addrs
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%s: Currently, the Ni52 driver doesn&squot;t support promiscuous or multicast mode.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
)brace
macro_line|#if 0
id|p-&gt;scb-&gt;cmd
op_assign
id|CUC_SUSPEND
suffix:semicolon
id|ni_attn586
c_func
(paren
)paren
suffix:semicolon
r_while
c_loop
(paren
id|p-&gt;scb-&gt;cmd
)paren
(brace
suffix:semicolon
)brace
id|p-&gt;scb-&gt;cmd
op_assign
id|RUC_SUSPEND
suffix:semicolon
id|ni_attn586
c_func
(paren
)paren
suffix:semicolon
r_while
c_loop
(paren
id|p-&gt;scb-&gt;cmd
)paren
(brace
suffix:semicolon
)brace
id|cfg_cmd
op_assign
(paren
r_struct
id|configure_cmd_struct
op_star
)paren
id|p-&gt;xmit_cbuffs
(braket
l_int|0
)braket
suffix:semicolon
multiline_comment|/* we&squot;re using a transmitcommand */
id|cfg_cmd-&gt;cmd_status
op_assign
l_int|0
suffix:semicolon
id|cfg_cmd-&gt;cmd_cmd
op_assign
id|CMD_CONFIGURE
op_or
id|CMD_LAST
suffix:semicolon
id|cfg_cmd-&gt;cmd_link
op_assign
l_int|0xffff
suffix:semicolon
id|cfg_cmd-&gt;byte_cnt
op_assign
l_int|0x0a
suffix:semicolon
multiline_comment|/* number of cfg bytes */
id|cfg_cmd-&gt;fifo
op_assign
l_int|0x08
suffix:semicolon
multiline_comment|/* fifo-limit (8=tx:32/rx:64) */
id|cfg_cmd-&gt;sav_bf
op_assign
l_int|0x40
suffix:semicolon
multiline_comment|/* hold or discard bad recv frames (bit 7) */
id|cfg_cmd-&gt;adr_len
op_assign
l_int|0x2e
suffix:semicolon
multiline_comment|/* addr_len |!src_insert |pre-len |loopback */
id|cfg_cmd-&gt;priority
op_assign
l_int|0x00
suffix:semicolon
id|cfg_cmd-&gt;ifd
op_assign
l_int|0x60
suffix:semicolon
id|cfg_cmd-&gt;time_low
op_assign
l_int|0x00
suffix:semicolon
id|cfg_cmd-&gt;time_high
op_assign
l_int|0xf2
suffix:semicolon
id|cfg_cmd-&gt;promisc
op_assign
l_int|0x01
suffix:semicolon
multiline_comment|/* promisc on */
id|cfg_cmd-&gt;carr_coll
op_assign
l_int|0x00
suffix:semicolon
id|p-&gt;scb-&gt;cbl_offset
op_assign
id|make16
c_func
(paren
id|cfg_cmd
)paren
suffix:semicolon
id|p-&gt;scb-&gt;cmd
op_assign
id|CUC_START
suffix:semicolon
multiline_comment|/* cmd.-unit start */
id|ni_attn586
c_func
(paren
)paren
suffix:semicolon
r_while
c_loop
(paren
id|p-&gt;scb-&gt;cmd
)paren
(brace
suffix:semicolon
)brace
id|p-&gt;scb-&gt;cbl_offset
op_assign
id|p-&gt;nop_cmds
(braket
l_int|0
)braket
op_member_access_from_pointer
id|cmd_link
op_assign
id|make16
c_func
(paren
id|p-&gt;nop_cmds
(braket
l_int|0
)braket
)paren
suffix:semicolon
id|p-&gt;scb-&gt;cmd
op_assign
id|CUC_START
suffix:semicolon
id|ni_atthn586
c_func
(paren
)paren
suffix:semicolon
r_while
c_loop
(paren
id|p-&gt;scb-&gt;cmd
)paren
(brace
suffix:semicolon
)brace
id|p-&gt;scb-&gt;cmd
op_assign
id|RUC_RESUME
suffix:semicolon
id|ni_atthn586
c_func
(paren
)paren
suffix:semicolon
r_while
c_loop
(paren
id|p-&gt;scb-&gt;cmd
)paren
(brace
suffix:semicolon
)brace
macro_line|#endif
)brace
eof
