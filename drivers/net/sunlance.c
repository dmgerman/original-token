multiline_comment|/* $Id: sunlance.c,v 1.105 2000/10/22 16:08:38 davem Exp $&n; * lance.c: Linux/Sparc/Lance driver&n; *&n; *&t;Written 1995, 1996 by Miguel de Icaza&n; * Sources:&n; *&t;The Linux  depca driver&n; *&t;The Linux  lance driver.&n; *&t;The Linux  skeleton driver.&n; *&t;The NetBSD Sparc/Lance driver.&n; *&t;Theo de Raadt (deraadt@openbsd.org)&n; *&t;NCR92C990 Lan Controller manual&n; *&n; * 1.4:&n; *&t;Added support to run with a ledma on the Sun4m&n; *&n; * 1.5:&n; *&t;Added multiple card detection.&n; *&n; *&t; 4/17/96: Burst sizes and tpe selection on sun4m by Eddie C. Dost&n; *&t;&t;  (ecd@skynet.be)&n; *&n; *&t; 5/15/96: auto carrier detection on sun4m by Eddie C. Dost&n; *&t;&t;  (ecd@skynet.be)&n; *&n; *&t; 5/17/96: lebuffer on scsi/ether cards now work David S. Miller&n; *&t;&t;  (davem@caip.rutgers.edu)&n; *&n; *&t; 5/29/96: override option &squot;tpe-link-test?&squot;, if it is &squot;false&squot;, as&n; *&t;&t;  this disables auto carrier detection on sun4m. Eddie C. Dost&n; *&t;&t;  (ecd@skynet.be)&n; *&n; * 1.7:&n; *&t; 6/26/96: Bug fix for multiple ledmas, miguel.&n; *&n; * 1.8:&n; *&t;&t;  Stole multicast code from depca.c, fixed lance_tx.&n; *&n; * 1.9:&n; *&t; 8/21/96: Fixed the multicast code (Pedro Roque)&n; *&n; *&t; 8/28/96: Send fake packet in lance_open() if auto_select is true,&n; *&t;&t;  so we can detect the carrier loss condition in time.&n; *&t;&t;  Eddie C. Dost (ecd@skynet.be)&n; *&n; *&t; 9/15/96: Align rx_buf so that eth_copy_and_sum() won&squot;t cause an&n; *&t;&t;  MNA trap during chksum_partial_copy(). (ecd@skynet.be)&n; *&n; *&t;11/17/96: Handle LE_C0_MERR in lance_interrupt(). (ecd@skynet.be)&n; *&n; *&t;12/22/96: Don&squot;t loop forever in lance_rx() on incomplete packets.&n; *&t;&t;  This was the sun4c killer. Shit, stupid bug.&n; *&t;&t;  (ecd@skynet.be)&n; *&n; * 1.10:&n; *&t; 1/26/97: Modularize driver. (ecd@skynet.be)&n; *&n; * 1.11:&n; *&t;12/27/97: Added sun4d support. (jj@sunsite.mff.cuni.cz)&n; *&n; * 1.12:&n; * &t; 11/3/99: Fixed SMP race in lance_start_xmit found by davem.&n; * &t;          Anton Blanchard (anton@progsoc.uts.edu.au)&n; * 2.00: 11/9/99: Massive overhaul and port to new SBUS driver interfaces.&n; *&t;&t;  David S. Miller (davem@redhat.com)&n; */
DECL|macro|DEBUG_DRIVER
macro_line|#undef DEBUG_DRIVER
DECL|variable|version
r_static
r_char
op_star
id|version
op_assign
l_string|&quot;sunlance.c:v2.00 11/Sep/99 Miguel de Icaza (miguel@nuclecu.unam.mx)&bslash;n&quot;
suffix:semicolon
DECL|variable|lancestr
r_static
r_char
op_star
id|lancestr
op_assign
l_string|&quot;LANCE&quot;
suffix:semicolon
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/fcntl.h&gt;
macro_line|#include &lt;linux/interrupt.h&gt;
macro_line|#include &lt;linux/ptrace.h&gt;
macro_line|#include &lt;linux/ioport.h&gt;
macro_line|#include &lt;linux/in.h&gt;
macro_line|#include &lt;linux/malloc.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;asm/system.h&gt;
macro_line|#include &lt;asm/bitops.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/dma.h&gt;
macro_line|#include &lt;asm/pgtable.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;asm/byteorder.h&gt;&t;/* Used by the checksum routines */
multiline_comment|/* Used for the temporal inet entries and routing */
macro_line|#include &lt;linux/socket.h&gt;
macro_line|#include &lt;linux/route.h&gt;
macro_line|#include &lt;asm/idprom.h&gt;
macro_line|#include &lt;asm/sbus.h&gt;
macro_line|#include &lt;asm/openprom.h&gt;
macro_line|#include &lt;asm/oplib.h&gt;
macro_line|#include &lt;asm/auxio.h&gt;&t;&t;/* For tpe-link-test? setting */
macro_line|#include &lt;asm/irq.h&gt;
macro_line|#include &lt;linux/netdevice.h&gt;
macro_line|#include &lt;linux/etherdevice.h&gt;
macro_line|#include &lt;linux/skbuff.h&gt;
multiline_comment|/* Define: 2^4 Tx buffers and 2^4 Rx buffers */
macro_line|#ifndef LANCE_LOG_TX_BUFFERS
DECL|macro|LANCE_LOG_TX_BUFFERS
mdefine_line|#define LANCE_LOG_TX_BUFFERS 4
DECL|macro|LANCE_LOG_RX_BUFFERS
mdefine_line|#define LANCE_LOG_RX_BUFFERS 4
macro_line|#endif
DECL|macro|CRC_POLYNOMIAL_BE
mdefine_line|#define CRC_POLYNOMIAL_BE 0x04c11db7UL  /* Ethernet CRC, big endian */
DECL|macro|CRC_POLYNOMIAL_LE
mdefine_line|#define CRC_POLYNOMIAL_LE 0xedb88320UL  /* Ethernet CRC, little endian */
DECL|macro|LE_CSR0
mdefine_line|#define LE_CSR0 0
DECL|macro|LE_CSR1
mdefine_line|#define LE_CSR1 1
DECL|macro|LE_CSR2
mdefine_line|#define LE_CSR2 2
DECL|macro|LE_CSR3
mdefine_line|#define LE_CSR3 3
DECL|macro|LE_MO_PROM
mdefine_line|#define LE_MO_PROM      0x8000  /* Enable promiscuous mode */
DECL|macro|LE_C0_ERR
mdefine_line|#define&t;LE_C0_ERR&t;0x8000&t;/* Error: set if BAB, SQE, MISS or ME is set */
DECL|macro|LE_C0_BABL
mdefine_line|#define&t;LE_C0_BABL&t;0x4000&t;/* BAB:  Babble: tx timeout. */
DECL|macro|LE_C0_CERR
mdefine_line|#define&t;LE_C0_CERR&t;0x2000&t;/* SQE:  Signal quality error */
DECL|macro|LE_C0_MISS
mdefine_line|#define&t;LE_C0_MISS&t;0x1000&t;/* MISS: Missed a packet */
DECL|macro|LE_C0_MERR
mdefine_line|#define&t;LE_C0_MERR&t;0x0800&t;/* ME:   Memory error */
DECL|macro|LE_C0_RINT
mdefine_line|#define&t;LE_C0_RINT&t;0x0400&t;/* Received interrupt */
DECL|macro|LE_C0_TINT
mdefine_line|#define&t;LE_C0_TINT&t;0x0200&t;/* Transmitter Interrupt */
DECL|macro|LE_C0_IDON
mdefine_line|#define&t;LE_C0_IDON&t;0x0100&t;/* IFIN: Init finished. */
DECL|macro|LE_C0_INTR
mdefine_line|#define&t;LE_C0_INTR&t;0x0080&t;/* Interrupt or error */
DECL|macro|LE_C0_INEA
mdefine_line|#define&t;LE_C0_INEA&t;0x0040&t;/* Interrupt enable */
DECL|macro|LE_C0_RXON
mdefine_line|#define&t;LE_C0_RXON&t;0x0020&t;/* Receiver on */
DECL|macro|LE_C0_TXON
mdefine_line|#define&t;LE_C0_TXON&t;0x0010&t;/* Transmitter on */
DECL|macro|LE_C0_TDMD
mdefine_line|#define&t;LE_C0_TDMD&t;0x0008&t;/* Transmitter demand */
DECL|macro|LE_C0_STOP
mdefine_line|#define&t;LE_C0_STOP&t;0x0004&t;/* Stop the card */
DECL|macro|LE_C0_STRT
mdefine_line|#define&t;LE_C0_STRT&t;0x0002&t;/* Start the card */
DECL|macro|LE_C0_INIT
mdefine_line|#define&t;LE_C0_INIT&t;0x0001&t;/* Init the card */
DECL|macro|LE_C3_BSWP
mdefine_line|#define&t;LE_C3_BSWP&t;0x4     /* SWAP */
DECL|macro|LE_C3_ACON
mdefine_line|#define&t;LE_C3_ACON&t;0x2&t;/* ALE Control */
DECL|macro|LE_C3_BCON
mdefine_line|#define&t;LE_C3_BCON&t;0x1&t;/* Byte control */
multiline_comment|/* Receive message descriptor 1 */
DECL|macro|LE_R1_OWN
mdefine_line|#define LE_R1_OWN       0x80    /* Who owns the entry */
DECL|macro|LE_R1_ERR
mdefine_line|#define LE_R1_ERR       0x40    /* Error: if FRA, OFL, CRC or BUF is set */
DECL|macro|LE_R1_FRA
mdefine_line|#define LE_R1_FRA       0x20    /* FRA: Frame error */
DECL|macro|LE_R1_OFL
mdefine_line|#define LE_R1_OFL       0x10    /* OFL: Frame overflow */
DECL|macro|LE_R1_CRC
mdefine_line|#define LE_R1_CRC       0x08    /* CRC error */
DECL|macro|LE_R1_BUF
mdefine_line|#define LE_R1_BUF       0x04    /* BUF: Buffer error */
DECL|macro|LE_R1_SOP
mdefine_line|#define LE_R1_SOP       0x02    /* Start of packet */
DECL|macro|LE_R1_EOP
mdefine_line|#define LE_R1_EOP       0x01    /* End of packet */
DECL|macro|LE_R1_POK
mdefine_line|#define LE_R1_POK       0x03    /* Packet is complete: SOP + EOP */
DECL|macro|LE_T1_OWN
mdefine_line|#define LE_T1_OWN       0x80    /* Lance owns the packet */
DECL|macro|LE_T1_ERR
mdefine_line|#define LE_T1_ERR       0x40    /* Error summary */
DECL|macro|LE_T1_EMORE
mdefine_line|#define LE_T1_EMORE     0x10    /* Error: more than one retry needed */
DECL|macro|LE_T1_EONE
mdefine_line|#define LE_T1_EONE      0x08    /* Error: one retry needed */
DECL|macro|LE_T1_EDEF
mdefine_line|#define LE_T1_EDEF      0x04    /* Error: deferred */
DECL|macro|LE_T1_SOP
mdefine_line|#define LE_T1_SOP       0x02    /* Start of packet */
DECL|macro|LE_T1_EOP
mdefine_line|#define LE_T1_EOP       0x01    /* End of packet */
DECL|macro|LE_T1_POK
mdefine_line|#define LE_T1_POK&t;0x03&t;/* Packet is complete: SOP + EOP */
DECL|macro|LE_T3_BUF
mdefine_line|#define LE_T3_BUF       0x8000  /* Buffer error */
DECL|macro|LE_T3_UFL
mdefine_line|#define LE_T3_UFL       0x4000  /* Error underflow */
DECL|macro|LE_T3_LCOL
mdefine_line|#define LE_T3_LCOL      0x1000  /* Error late collision */
DECL|macro|LE_T3_CLOS
mdefine_line|#define LE_T3_CLOS      0x0800  /* Error carrier loss */
DECL|macro|LE_T3_RTY
mdefine_line|#define LE_T3_RTY       0x0400  /* Error retry */
DECL|macro|LE_T3_TDR
mdefine_line|#define LE_T3_TDR       0x03ff  /* Time Domain Reflectometry counter */
DECL|macro|TX_RING_SIZE
mdefine_line|#define TX_RING_SIZE&t;&t;&t;(1 &lt;&lt; (LANCE_LOG_TX_BUFFERS))
DECL|macro|TX_RING_MOD_MASK
mdefine_line|#define TX_RING_MOD_MASK&t;&t;(TX_RING_SIZE - 1)
DECL|macro|TX_RING_LEN_BITS
mdefine_line|#define TX_RING_LEN_BITS&t;&t;((LANCE_LOG_TX_BUFFERS) &lt;&lt; 29)
DECL|macro|TX_NEXT
mdefine_line|#define TX_NEXT(__x)&t;&t;&t;(((__x)+1) &amp; TX_RING_MOD_MASK)
DECL|macro|RX_RING_SIZE
mdefine_line|#define RX_RING_SIZE&t;&t;&t;(1 &lt;&lt; (LANCE_LOG_RX_BUFFERS))
DECL|macro|RX_RING_MOD_MASK
mdefine_line|#define RX_RING_MOD_MASK&t;&t;(RX_RING_SIZE - 1)
DECL|macro|RX_RING_LEN_BITS
mdefine_line|#define RX_RING_LEN_BITS&t;&t;((LANCE_LOG_RX_BUFFERS) &lt;&lt; 29)
DECL|macro|RX_NEXT
mdefine_line|#define RX_NEXT(__x)&t;&t;&t;(((__x)+1) &amp; RX_RING_MOD_MASK)
DECL|macro|PKT_BUF_SZ
mdefine_line|#define PKT_BUF_SZ&t;&t;1544
DECL|macro|RX_BUFF_SIZE
mdefine_line|#define RX_BUFF_SIZE            PKT_BUF_SZ
DECL|macro|TX_BUFF_SIZE
mdefine_line|#define TX_BUFF_SIZE            PKT_BUF_SZ
DECL|struct|lance_rx_desc
r_struct
id|lance_rx_desc
(brace
DECL|member|rmd0
id|u16
id|rmd0
suffix:semicolon
multiline_comment|/* low address of packet */
DECL|member|rmd1_bits
id|u8
id|rmd1_bits
suffix:semicolon
multiline_comment|/* descriptor bits */
DECL|member|rmd1_hadr
id|u8
id|rmd1_hadr
suffix:semicolon
multiline_comment|/* high address of packet */
DECL|member|length
id|s16
id|length
suffix:semicolon
multiline_comment|/* This length is 2s complement (negative)!&n;&t;&t;&t;&t; * Buffer length&n;&t;&t;&t;&t; */
DECL|member|mblength
id|u16
id|mblength
suffix:semicolon
multiline_comment|/* This is the actual number of bytes received */
)brace
suffix:semicolon
DECL|struct|lance_tx_desc
r_struct
id|lance_tx_desc
(brace
DECL|member|tmd0
id|u16
id|tmd0
suffix:semicolon
multiline_comment|/* low address of packet */
DECL|member|tmd1_bits
id|u8
id|tmd1_bits
suffix:semicolon
multiline_comment|/* descriptor bits */
DECL|member|tmd1_hadr
id|u8
id|tmd1_hadr
suffix:semicolon
multiline_comment|/* high address of packet */
DECL|member|length
id|s16
id|length
suffix:semicolon
multiline_comment|/* Length is 2s complement (negative)! */
DECL|member|misc
id|u16
id|misc
suffix:semicolon
)brace
suffix:semicolon
multiline_comment|/* The LANCE initialization block, described in databook. */
multiline_comment|/* On the Sparc, this block should be on a DMA region     */
DECL|struct|lance_init_block
r_struct
id|lance_init_block
(brace
DECL|member|mode
id|u16
id|mode
suffix:semicolon
multiline_comment|/* Pre-set mode (reg. 15) */
DECL|member|phys_addr
id|u8
id|phys_addr
(braket
l_int|6
)braket
suffix:semicolon
multiline_comment|/* Physical ethernet address */
DECL|member|filter
id|u32
id|filter
(braket
l_int|2
)braket
suffix:semicolon
multiline_comment|/* Multicast filter. */
multiline_comment|/* Receive and transmit ring base, along with extra bits. */
DECL|member|rx_ptr
id|u16
id|rx_ptr
suffix:semicolon
multiline_comment|/* receive descriptor addr */
DECL|member|rx_len
id|u16
id|rx_len
suffix:semicolon
multiline_comment|/* receive len and high addr */
DECL|member|tx_ptr
id|u16
id|tx_ptr
suffix:semicolon
multiline_comment|/* transmit descriptor addr */
DECL|member|tx_len
id|u16
id|tx_len
suffix:semicolon
multiline_comment|/* transmit len and high addr */
multiline_comment|/* The Tx and Rx ring entries must aligned on 8-byte boundaries. */
DECL|member|brx_ring
r_struct
id|lance_rx_desc
id|brx_ring
(braket
id|RX_RING_SIZE
)braket
suffix:semicolon
DECL|member|btx_ring
r_struct
id|lance_tx_desc
id|btx_ring
(braket
id|TX_RING_SIZE
)braket
suffix:semicolon
DECL|member|tx_buf
id|u8
id|tx_buf
(braket
id|TX_RING_SIZE
)braket
(braket
id|TX_BUFF_SIZE
)braket
suffix:semicolon
DECL|member|pad
id|u8
id|pad
(braket
l_int|2
)braket
suffix:semicolon
multiline_comment|/* align rx_buf for copy_and_sum(). */
DECL|member|rx_buf
id|u8
id|rx_buf
(braket
id|RX_RING_SIZE
)braket
(braket
id|RX_BUFF_SIZE
)braket
suffix:semicolon
)brace
suffix:semicolon
DECL|macro|libdesc_offset
mdefine_line|#define libdesc_offset(rt, elem) &bslash;&n;((__u32)(((unsigned long)(&amp;(((struct lance_init_block *)0)-&gt;rt[elem])))))
DECL|macro|libbuff_offset
mdefine_line|#define libbuff_offset(rt, elem) &bslash;&n;((__u32)(((unsigned long)(&amp;(((struct lance_init_block *)0)-&gt;rt[elem][0])))))
DECL|struct|lance_private
r_struct
id|lance_private
(brace
DECL|member|lregs
r_int
r_int
id|lregs
suffix:semicolon
multiline_comment|/* Lance RAP/RDP regs.&t;&t;*/
DECL|member|dregs
r_int
r_int
id|dregs
suffix:semicolon
multiline_comment|/* DMA controller regs.&t;&t;*/
DECL|member|init_block
r_volatile
r_struct
id|lance_init_block
op_star
id|init_block
suffix:semicolon
DECL|member|lock
id|spinlock_t
id|lock
suffix:semicolon
DECL|member|rx_new
DECL|member|tx_new
r_int
id|rx_new
comma
id|tx_new
suffix:semicolon
DECL|member|rx_old
DECL|member|tx_old
r_int
id|rx_old
comma
id|tx_old
suffix:semicolon
DECL|member|stats
r_struct
id|net_device_stats
id|stats
suffix:semicolon
DECL|member|ledma
r_struct
id|sbus_dma
op_star
id|ledma
suffix:semicolon
multiline_comment|/* If set this points to ledma&t;*/
DECL|member|tpe
r_char
id|tpe
suffix:semicolon
multiline_comment|/* cable-selection is TPE&t;*/
DECL|member|auto_select
r_char
id|auto_select
suffix:semicolon
multiline_comment|/* cable-selection by carrier&t;*/
DECL|member|burst_sizes
r_char
id|burst_sizes
suffix:semicolon
multiline_comment|/* ledma SBus burst sizes&t;*/
DECL|member|pio_buffer
r_char
id|pio_buffer
suffix:semicolon
multiline_comment|/* init block in PIO space?&t;*/
DECL|member|busmaster_regval
r_int
r_int
id|busmaster_regval
suffix:semicolon
DECL|member|init_ring
r_void
(paren
op_star
id|init_ring
)paren
(paren
r_struct
id|net_device
op_star
)paren
suffix:semicolon
DECL|member|rx
r_void
(paren
op_star
id|rx
)paren
(paren
r_struct
id|net_device
op_star
)paren
suffix:semicolon
DECL|member|tx
r_void
(paren
op_star
id|tx
)paren
(paren
r_struct
id|net_device
op_star
)paren
suffix:semicolon
DECL|member|name
r_char
op_star
id|name
suffix:semicolon
DECL|member|init_block_dvma
id|__u32
id|init_block_dvma
suffix:semicolon
DECL|member|dev
r_struct
id|net_device
op_star
id|dev
suffix:semicolon
multiline_comment|/* Backpointer&t;*/
DECL|member|next_module
r_struct
id|lance_private
op_star
id|next_module
suffix:semicolon
DECL|member|sdev
r_struct
id|sbus_dev
op_star
id|sdev
suffix:semicolon
DECL|member|multicast_timer
r_struct
id|timer_list
id|multicast_timer
suffix:semicolon
)brace
suffix:semicolon
DECL|macro|TX_BUFFS_AVAIL
mdefine_line|#define TX_BUFFS_AVAIL ((lp-&gt;tx_old&lt;=lp-&gt;tx_new)?&bslash;&n;&t;&t;&t;lp-&gt;tx_old+TX_RING_MOD_MASK-lp-&gt;tx_new:&bslash;&n;&t;&t;&t;lp-&gt;tx_old - lp-&gt;tx_new-1)
multiline_comment|/* Lance registers. */
DECL|macro|RDP
mdefine_line|#define RDP&t;&t;0x00UL&t;&t;/* register data port&t;&t;*/
DECL|macro|RAP
mdefine_line|#define RAP&t;&t;0x02UL&t;&t;/* register address port&t;*/
DECL|macro|LANCE_REG_SIZE
mdefine_line|#define LANCE_REG_SIZE&t;0x04UL
DECL|macro|STOP_LANCE
mdefine_line|#define STOP_LANCE(__lp) &bslash;&n;do {&t;unsigned long __base = (__lp)-&gt;lregs; &bslash;&n;&t;sbus_writew(LE_CSR0,&t;__base + RAP); &bslash;&n;&t;sbus_writew(LE_C0_STOP,&t;__base + RDP); &bslash;&n;} while (0)
DECL|variable|sparc_lance_debug
r_int
id|sparc_lance_debug
op_assign
l_int|2
suffix:semicolon
multiline_comment|/* The Lance uses 24 bit addresses */
multiline_comment|/* On the Sun4c the DVMA will provide the remaining bytes for us */
multiline_comment|/* On the Sun4m we have to instruct the ledma to provide them    */
multiline_comment|/* Even worse, on scsi/ether SBUS cards, the init block and the&n; * transmit/receive buffers are addresses as offsets from absolute&n; * zero on the lebuffer PIO area. -DaveM&n; */
DECL|macro|LANCE_ADDR
mdefine_line|#define LANCE_ADDR(x) ((long)(x) &amp; ~0xff000000)
DECL|variable|root_lance_dev
r_static
r_struct
id|lance_private
op_star
id|root_lance_dev
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/* Load the CSR registers */
DECL|function|load_csrs
r_static
r_void
id|load_csrs
c_func
(paren
r_struct
id|lance_private
op_star
id|lp
)paren
(brace
id|u32
id|leptr
suffix:semicolon
r_if
c_cond
(paren
id|lp-&gt;pio_buffer
)paren
id|leptr
op_assign
l_int|0
suffix:semicolon
r_else
id|leptr
op_assign
id|LANCE_ADDR
c_func
(paren
id|lp-&gt;init_block_dvma
)paren
suffix:semicolon
id|sbus_writew
c_func
(paren
id|LE_CSR1
comma
id|lp-&gt;lregs
op_plus
id|RAP
)paren
suffix:semicolon
id|sbus_writew
c_func
(paren
id|leptr
op_amp
l_int|0xffff
comma
id|lp-&gt;lregs
op_plus
id|RDP
)paren
suffix:semicolon
id|sbus_writew
c_func
(paren
id|LE_CSR2
comma
id|lp-&gt;lregs
op_plus
id|RAP
)paren
suffix:semicolon
id|sbus_writew
c_func
(paren
id|leptr
op_rshift
l_int|16
comma
id|lp-&gt;lregs
op_plus
id|RDP
)paren
suffix:semicolon
id|sbus_writew
c_func
(paren
id|LE_CSR3
comma
id|lp-&gt;lregs
op_plus
id|RAP
)paren
suffix:semicolon
id|sbus_writew
c_func
(paren
id|lp-&gt;busmaster_regval
comma
id|lp-&gt;lregs
op_plus
id|RDP
)paren
suffix:semicolon
multiline_comment|/* Point back to csr0 */
id|sbus_writew
c_func
(paren
id|LE_CSR0
comma
id|lp-&gt;lregs
op_plus
id|RAP
)paren
suffix:semicolon
)brace
multiline_comment|/* Setup the Lance Rx and Tx rings */
DECL|function|lance_init_ring_dvma
r_static
r_void
id|lance_init_ring_dvma
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|lance_private
op_star
id|lp
op_assign
(paren
r_struct
id|lance_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_volatile
r_struct
id|lance_init_block
op_star
id|ib
op_assign
id|lp-&gt;init_block
suffix:semicolon
id|__u32
id|aib
op_assign
id|lp-&gt;init_block_dvma
suffix:semicolon
id|__u32
id|leptr
suffix:semicolon
r_int
id|i
suffix:semicolon
multiline_comment|/* Lock out other processes while setting up hardware */
id|netif_stop_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
id|lp-&gt;rx_new
op_assign
id|lp-&gt;tx_new
op_assign
l_int|0
suffix:semicolon
id|lp-&gt;rx_old
op_assign
id|lp-&gt;tx_old
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Copy the ethernet address to the lance init block&n;&t; * Note that on the sparc you need to swap the ethernet address.&n;&t; */
id|ib-&gt;phys_addr
(braket
l_int|0
)braket
op_assign
id|dev-&gt;dev_addr
(braket
l_int|1
)braket
suffix:semicolon
id|ib-&gt;phys_addr
(braket
l_int|1
)braket
op_assign
id|dev-&gt;dev_addr
(braket
l_int|0
)braket
suffix:semicolon
id|ib-&gt;phys_addr
(braket
l_int|2
)braket
op_assign
id|dev-&gt;dev_addr
(braket
l_int|3
)braket
suffix:semicolon
id|ib-&gt;phys_addr
(braket
l_int|3
)braket
op_assign
id|dev-&gt;dev_addr
(braket
l_int|2
)braket
suffix:semicolon
id|ib-&gt;phys_addr
(braket
l_int|4
)braket
op_assign
id|dev-&gt;dev_addr
(braket
l_int|5
)braket
suffix:semicolon
id|ib-&gt;phys_addr
(braket
l_int|5
)braket
op_assign
id|dev-&gt;dev_addr
(braket
l_int|4
)braket
suffix:semicolon
multiline_comment|/* Setup the Tx ring entries */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
op_le
id|TX_RING_SIZE
suffix:semicolon
id|i
op_increment
)paren
(brace
id|leptr
op_assign
id|LANCE_ADDR
c_func
(paren
id|aib
op_plus
id|libbuff_offset
c_func
(paren
id|tx_buf
comma
id|i
)paren
)paren
suffix:semicolon
id|ib-&gt;btx_ring
(braket
id|i
)braket
dot
id|tmd0
op_assign
id|leptr
suffix:semicolon
id|ib-&gt;btx_ring
(braket
id|i
)braket
dot
id|tmd1_hadr
op_assign
id|leptr
op_rshift
l_int|16
suffix:semicolon
id|ib-&gt;btx_ring
(braket
id|i
)braket
dot
id|tmd1_bits
op_assign
l_int|0
suffix:semicolon
id|ib-&gt;btx_ring
(braket
id|i
)braket
dot
id|length
op_assign
l_int|0xf000
suffix:semicolon
multiline_comment|/* The ones required by tmd2 */
id|ib-&gt;btx_ring
(braket
id|i
)braket
dot
id|misc
op_assign
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Setup the Rx ring entries */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|RX_RING_SIZE
suffix:semicolon
id|i
op_increment
)paren
(brace
id|leptr
op_assign
id|LANCE_ADDR
c_func
(paren
id|aib
op_plus
id|libbuff_offset
c_func
(paren
id|rx_buf
comma
id|i
)paren
)paren
suffix:semicolon
id|ib-&gt;brx_ring
(braket
id|i
)braket
dot
id|rmd0
op_assign
id|leptr
suffix:semicolon
id|ib-&gt;brx_ring
(braket
id|i
)braket
dot
id|rmd1_hadr
op_assign
id|leptr
op_rshift
l_int|16
suffix:semicolon
id|ib-&gt;brx_ring
(braket
id|i
)braket
dot
id|rmd1_bits
op_assign
id|LE_R1_OWN
suffix:semicolon
id|ib-&gt;brx_ring
(braket
id|i
)braket
dot
id|length
op_assign
op_minus
id|RX_BUFF_SIZE
op_or
l_int|0xf000
suffix:semicolon
id|ib-&gt;brx_ring
(braket
id|i
)braket
dot
id|mblength
op_assign
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Setup the initialization block */
multiline_comment|/* Setup rx descriptor pointer */
id|leptr
op_assign
id|LANCE_ADDR
c_func
(paren
id|aib
op_plus
id|libdesc_offset
c_func
(paren
id|brx_ring
comma
l_int|0
)paren
)paren
suffix:semicolon
id|ib-&gt;rx_len
op_assign
(paren
id|LANCE_LOG_RX_BUFFERS
op_lshift
l_int|13
)paren
op_or
(paren
id|leptr
op_rshift
l_int|16
)paren
suffix:semicolon
id|ib-&gt;rx_ptr
op_assign
id|leptr
suffix:semicolon
multiline_comment|/* Setup tx descriptor pointer */
id|leptr
op_assign
id|LANCE_ADDR
c_func
(paren
id|aib
op_plus
id|libdesc_offset
c_func
(paren
id|btx_ring
comma
l_int|0
)paren
)paren
suffix:semicolon
id|ib-&gt;tx_len
op_assign
(paren
id|LANCE_LOG_TX_BUFFERS
op_lshift
l_int|13
)paren
op_or
(paren
id|leptr
op_rshift
l_int|16
)paren
suffix:semicolon
id|ib-&gt;tx_ptr
op_assign
id|leptr
suffix:semicolon
)brace
DECL|function|lance_init_ring_pio
r_static
r_void
id|lance_init_ring_pio
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|lance_private
op_star
id|lp
op_assign
(paren
r_struct
id|lance_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_volatile
r_struct
id|lance_init_block
op_star
id|ib
op_assign
id|lp-&gt;init_block
suffix:semicolon
id|u32
id|leptr
suffix:semicolon
r_int
id|i
suffix:semicolon
multiline_comment|/* Lock out other processes while setting up hardware */
id|netif_stop_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
id|lp-&gt;rx_new
op_assign
id|lp-&gt;tx_new
op_assign
l_int|0
suffix:semicolon
id|lp-&gt;rx_old
op_assign
id|lp-&gt;tx_old
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Copy the ethernet address to the lance init block&n;&t; * Note that on the sparc you need to swap the ethernet address.&n;&t; */
id|sbus_writeb
c_func
(paren
id|dev-&gt;dev_addr
(braket
l_int|1
)braket
comma
op_amp
id|ib-&gt;phys_addr
(braket
l_int|0
)braket
)paren
suffix:semicolon
id|sbus_writeb
c_func
(paren
id|dev-&gt;dev_addr
(braket
l_int|0
)braket
comma
op_amp
id|ib-&gt;phys_addr
(braket
l_int|1
)braket
)paren
suffix:semicolon
id|sbus_writeb
c_func
(paren
id|dev-&gt;dev_addr
(braket
l_int|3
)braket
comma
op_amp
id|ib-&gt;phys_addr
(braket
l_int|2
)braket
)paren
suffix:semicolon
id|sbus_writeb
c_func
(paren
id|dev-&gt;dev_addr
(braket
l_int|2
)braket
comma
op_amp
id|ib-&gt;phys_addr
(braket
l_int|3
)braket
)paren
suffix:semicolon
id|sbus_writeb
c_func
(paren
id|dev-&gt;dev_addr
(braket
l_int|5
)braket
comma
op_amp
id|ib-&gt;phys_addr
(braket
l_int|4
)braket
)paren
suffix:semicolon
id|sbus_writeb
c_func
(paren
id|dev-&gt;dev_addr
(braket
l_int|4
)braket
comma
op_amp
id|ib-&gt;phys_addr
(braket
l_int|5
)braket
)paren
suffix:semicolon
multiline_comment|/* Setup the Tx ring entries */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
op_le
id|TX_RING_SIZE
suffix:semicolon
id|i
op_increment
)paren
(brace
id|leptr
op_assign
id|libbuff_offset
c_func
(paren
id|tx_buf
comma
id|i
)paren
suffix:semicolon
id|sbus_writew
c_func
(paren
id|leptr
comma
op_amp
id|ib-&gt;btx_ring
(braket
id|i
)braket
dot
id|tmd0
)paren
suffix:semicolon
id|sbus_writeb
c_func
(paren
id|leptr
op_rshift
l_int|16
comma
op_amp
id|ib-&gt;btx_ring
(braket
id|i
)braket
dot
id|tmd1_hadr
)paren
suffix:semicolon
id|sbus_writeb
c_func
(paren
l_int|0
comma
op_amp
id|ib-&gt;btx_ring
(braket
id|i
)braket
dot
id|tmd1_bits
)paren
suffix:semicolon
multiline_comment|/* The ones required by tmd2 */
id|sbus_writew
c_func
(paren
l_int|0xf000
comma
op_amp
id|ib-&gt;btx_ring
(braket
id|i
)braket
dot
id|length
)paren
suffix:semicolon
id|sbus_writew
c_func
(paren
l_int|0
comma
op_amp
id|ib-&gt;btx_ring
(braket
id|i
)braket
dot
id|misc
)paren
suffix:semicolon
)brace
multiline_comment|/* Setup the Rx ring entries */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|RX_RING_SIZE
suffix:semicolon
id|i
op_increment
)paren
(brace
id|leptr
op_assign
id|libbuff_offset
c_func
(paren
id|rx_buf
comma
id|i
)paren
suffix:semicolon
id|sbus_writew
c_func
(paren
id|leptr
comma
op_amp
id|ib-&gt;brx_ring
(braket
id|i
)braket
dot
id|rmd0
)paren
suffix:semicolon
id|sbus_writeb
c_func
(paren
id|leptr
op_rshift
l_int|16
comma
op_amp
id|ib-&gt;brx_ring
(braket
id|i
)braket
dot
id|rmd1_hadr
)paren
suffix:semicolon
id|sbus_writeb
c_func
(paren
id|LE_R1_OWN
comma
op_amp
id|ib-&gt;brx_ring
(braket
id|i
)braket
dot
id|rmd1_bits
)paren
suffix:semicolon
id|sbus_writew
c_func
(paren
op_minus
id|RX_BUFF_SIZE
op_or
l_int|0xf000
comma
op_amp
id|ib-&gt;brx_ring
(braket
id|i
)braket
dot
id|length
)paren
suffix:semicolon
id|sbus_writew
c_func
(paren
l_int|0
comma
op_amp
id|ib-&gt;brx_ring
(braket
id|i
)braket
dot
id|mblength
)paren
suffix:semicolon
)brace
multiline_comment|/* Setup the initialization block */
multiline_comment|/* Setup rx descriptor pointer */
id|leptr
op_assign
id|libdesc_offset
c_func
(paren
id|brx_ring
comma
l_int|0
)paren
suffix:semicolon
id|sbus_writew
c_func
(paren
(paren
id|LANCE_LOG_RX_BUFFERS
op_lshift
l_int|13
)paren
op_or
(paren
id|leptr
op_rshift
l_int|16
)paren
comma
op_amp
id|ib-&gt;rx_len
)paren
suffix:semicolon
id|sbus_writew
c_func
(paren
id|leptr
comma
op_amp
id|ib-&gt;rx_ptr
)paren
suffix:semicolon
multiline_comment|/* Setup tx descriptor pointer */
id|leptr
op_assign
id|libdesc_offset
c_func
(paren
id|btx_ring
comma
l_int|0
)paren
suffix:semicolon
id|sbus_writew
c_func
(paren
(paren
id|LANCE_LOG_TX_BUFFERS
op_lshift
l_int|13
)paren
op_or
(paren
id|leptr
op_rshift
l_int|16
)paren
comma
op_amp
id|ib-&gt;tx_len
)paren
suffix:semicolon
id|sbus_writew
c_func
(paren
id|leptr
comma
op_amp
id|ib-&gt;tx_ptr
)paren
suffix:semicolon
)brace
DECL|function|init_restart_ledma
r_static
r_void
id|init_restart_ledma
c_func
(paren
r_struct
id|lance_private
op_star
id|lp
)paren
(brace
id|u32
id|csr
op_assign
id|sbus_readl
c_func
(paren
id|lp-&gt;dregs
op_plus
id|DMA_CSR
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|csr
op_amp
id|DMA_HNDL_ERROR
)paren
)paren
(brace
multiline_comment|/* E-Cache draining */
r_while
c_loop
(paren
id|sbus_readl
c_func
(paren
id|lp-&gt;dregs
op_plus
id|DMA_CSR
)paren
op_amp
id|DMA_FIFO_ISDRAIN
)paren
id|barrier
c_func
(paren
)paren
suffix:semicolon
)brace
id|csr
op_assign
id|sbus_readl
c_func
(paren
id|lp-&gt;dregs
op_plus
id|DMA_CSR
)paren
suffix:semicolon
id|csr
op_and_assign
op_complement
id|DMA_E_BURSTS
suffix:semicolon
r_if
c_cond
(paren
id|lp-&gt;burst_sizes
op_amp
id|DMA_BURST32
)paren
id|csr
op_or_assign
id|DMA_E_BURST32
suffix:semicolon
r_else
id|csr
op_or_assign
id|DMA_E_BURST16
suffix:semicolon
id|csr
op_or_assign
(paren
id|DMA_DSBL_RD_DRN
op_or
id|DMA_DSBL_WR_INV
op_or
id|DMA_FIFO_INV
)paren
suffix:semicolon
r_if
c_cond
(paren
id|lp-&gt;tpe
)paren
id|csr
op_or_assign
id|DMA_EN_ENETAUI
suffix:semicolon
r_else
id|csr
op_and_assign
op_complement
id|DMA_EN_ENETAUI
suffix:semicolon
id|udelay
c_func
(paren
l_int|20
)paren
suffix:semicolon
id|sbus_writel
c_func
(paren
id|csr
comma
id|lp-&gt;dregs
op_plus
id|DMA_CSR
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|200
)paren
suffix:semicolon
)brace
DECL|function|init_restart_lance
r_static
r_int
id|init_restart_lance
c_func
(paren
r_struct
id|lance_private
op_star
id|lp
)paren
(brace
id|u16
id|regval
op_assign
l_int|0
suffix:semicolon
r_int
id|i
suffix:semicolon
r_if
c_cond
(paren
id|lp-&gt;dregs
)paren
id|init_restart_ledma
c_func
(paren
id|lp
)paren
suffix:semicolon
id|sbus_writew
c_func
(paren
id|LE_CSR0
comma
id|lp-&gt;lregs
op_plus
id|RAP
)paren
suffix:semicolon
id|sbus_writew
c_func
(paren
id|LE_C0_INIT
comma
id|lp-&gt;lregs
op_plus
id|RDP
)paren
suffix:semicolon
multiline_comment|/* Wait for the lance to complete initialization */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|100
suffix:semicolon
id|i
op_increment
)paren
(brace
id|regval
op_assign
id|sbus_readw
c_func
(paren
id|lp-&gt;lregs
op_plus
id|RDP
)paren
suffix:semicolon
r_if
c_cond
(paren
id|regval
op_amp
(paren
id|LE_C0_ERR
op_or
id|LE_C0_IDON
)paren
)paren
r_break
suffix:semicolon
id|barrier
c_func
(paren
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|i
op_eq
l_int|100
op_logical_or
(paren
id|regval
op_amp
id|LE_C0_ERR
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;LANCE unopened after %d ticks, csr0=%4.4x.&bslash;n&quot;
comma
id|i
comma
id|regval
)paren
suffix:semicolon
r_if
c_cond
(paren
id|lp-&gt;dregs
)paren
id|printk
c_func
(paren
l_string|&quot;dcsr=%8.8x&bslash;n&quot;
comma
id|sbus_readl
c_func
(paren
id|lp-&gt;dregs
op_plus
id|DMA_CSR
)paren
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
multiline_comment|/* Clear IDON by writing a &quot;1&quot;, enable interrupts and start lance */
id|sbus_writew
c_func
(paren
id|LE_C0_IDON
comma
id|lp-&gt;lregs
op_plus
id|RDP
)paren
suffix:semicolon
id|sbus_writew
c_func
(paren
id|LE_C0_INEA
op_or
id|LE_C0_STRT
comma
id|lp-&gt;lregs
op_plus
id|RDP
)paren
suffix:semicolon
r_if
c_cond
(paren
id|lp-&gt;dregs
)paren
(brace
id|u32
id|csr
op_assign
id|sbus_readl
c_func
(paren
id|lp-&gt;dregs
op_plus
id|DMA_CSR
)paren
suffix:semicolon
id|csr
op_or_assign
id|DMA_INT_ENAB
suffix:semicolon
id|sbus_writel
c_func
(paren
id|csr
comma
id|lp-&gt;dregs
op_plus
id|DMA_CSR
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|lance_rx_dvma
r_static
r_void
id|lance_rx_dvma
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|lance_private
op_star
id|lp
op_assign
(paren
r_struct
id|lance_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_volatile
r_struct
id|lance_init_block
op_star
id|ib
op_assign
id|lp-&gt;init_block
suffix:semicolon
r_volatile
r_struct
id|lance_rx_desc
op_star
id|rd
suffix:semicolon
id|u8
id|bits
suffix:semicolon
r_int
id|len
comma
id|entry
op_assign
id|lp-&gt;rx_new
suffix:semicolon
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
r_for
c_loop
(paren
id|rd
op_assign
op_amp
id|ib-&gt;brx_ring
(braket
id|entry
)braket
suffix:semicolon
op_logical_neg
(paren
(paren
id|bits
op_assign
id|rd-&gt;rmd1_bits
)paren
op_amp
id|LE_R1_OWN
)paren
suffix:semicolon
id|rd
op_assign
op_amp
id|ib-&gt;brx_ring
(braket
id|entry
)braket
)paren
(brace
multiline_comment|/* We got an incomplete frame? */
r_if
c_cond
(paren
(paren
id|bits
op_amp
id|LE_R1_POK
)paren
op_ne
id|LE_R1_POK
)paren
(brace
id|lp-&gt;stats.rx_over_errors
op_increment
suffix:semicolon
id|lp-&gt;stats.rx_errors
op_increment
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|bits
op_amp
id|LE_R1_ERR
)paren
(brace
multiline_comment|/* Count only the end frame as a rx error,&n;&t;&t;&t; * not the beginning&n;&t;&t;&t; */
r_if
c_cond
(paren
id|bits
op_amp
id|LE_R1_BUF
)paren
id|lp-&gt;stats.rx_fifo_errors
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|bits
op_amp
id|LE_R1_CRC
)paren
id|lp-&gt;stats.rx_crc_errors
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|bits
op_amp
id|LE_R1_OFL
)paren
id|lp-&gt;stats.rx_over_errors
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|bits
op_amp
id|LE_R1_FRA
)paren
id|lp-&gt;stats.rx_frame_errors
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|bits
op_amp
id|LE_R1_EOP
)paren
id|lp-&gt;stats.rx_errors
op_increment
suffix:semicolon
)brace
r_else
(brace
id|len
op_assign
(paren
id|rd-&gt;mblength
op_amp
l_int|0xfff
)paren
op_minus
l_int|4
suffix:semicolon
id|skb
op_assign
id|dev_alloc_skb
c_func
(paren
id|len
op_plus
l_int|2
)paren
suffix:semicolon
r_if
c_cond
(paren
id|skb
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Memory squeeze, deferring packet.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|lp-&gt;stats.rx_dropped
op_increment
suffix:semicolon
id|rd-&gt;mblength
op_assign
l_int|0
suffix:semicolon
id|rd-&gt;rmd1_bits
op_assign
id|LE_R1_OWN
suffix:semicolon
id|lp-&gt;rx_new
op_assign
id|RX_NEXT
c_func
(paren
id|entry
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|lp-&gt;stats.rx_bytes
op_add_assign
id|len
suffix:semicolon
id|skb-&gt;dev
op_assign
id|dev
suffix:semicolon
id|skb_reserve
c_func
(paren
id|skb
comma
l_int|2
)paren
suffix:semicolon
multiline_comment|/* 16 byte align */
id|skb_put
c_func
(paren
id|skb
comma
id|len
)paren
suffix:semicolon
multiline_comment|/* make room */
id|eth_copy_and_sum
c_func
(paren
id|skb
comma
(paren
r_int
r_char
op_star
)paren
op_amp
(paren
id|ib-&gt;rx_buf
(braket
id|entry
)braket
(braket
l_int|0
)braket
)paren
comma
id|len
comma
l_int|0
)paren
suffix:semicolon
id|skb-&gt;protocol
op_assign
id|eth_type_trans
c_func
(paren
id|skb
comma
id|dev
)paren
suffix:semicolon
id|netif_rx
c_func
(paren
id|skb
)paren
suffix:semicolon
id|lp-&gt;stats.rx_packets
op_increment
suffix:semicolon
)brace
multiline_comment|/* Return the packet to the pool */
id|rd-&gt;mblength
op_assign
l_int|0
suffix:semicolon
id|rd-&gt;rmd1_bits
op_assign
id|LE_R1_OWN
suffix:semicolon
id|entry
op_assign
id|RX_NEXT
c_func
(paren
id|entry
)paren
suffix:semicolon
)brace
id|lp-&gt;rx_new
op_assign
id|entry
suffix:semicolon
)brace
DECL|function|lance_tx_dvma
r_static
r_void
id|lance_tx_dvma
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|lance_private
op_star
id|lp
op_assign
(paren
r_struct
id|lance_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_volatile
r_struct
id|lance_init_block
op_star
id|ib
op_assign
id|lp-&gt;init_block
suffix:semicolon
r_int
id|i
comma
id|j
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|lp-&gt;lock
)paren
suffix:semicolon
id|j
op_assign
id|lp-&gt;tx_old
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
id|j
suffix:semicolon
id|i
op_ne
id|lp-&gt;tx_new
suffix:semicolon
id|i
op_assign
id|j
)paren
(brace
r_volatile
r_struct
id|lance_tx_desc
op_star
id|td
op_assign
op_amp
id|ib-&gt;btx_ring
(braket
id|i
)braket
suffix:semicolon
id|u8
id|bits
op_assign
id|td-&gt;tmd1_bits
suffix:semicolon
multiline_comment|/* If we hit a packet not owned by us, stop */
r_if
c_cond
(paren
id|bits
op_amp
id|LE_T1_OWN
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
id|bits
op_amp
id|LE_T1_ERR
)paren
(brace
id|u16
id|status
op_assign
id|td-&gt;misc
suffix:semicolon
id|lp-&gt;stats.tx_errors
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
id|LE_T3_RTY
)paren
id|lp-&gt;stats.tx_aborted_errors
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
id|LE_T3_LCOL
)paren
id|lp-&gt;stats.tx_window_errors
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
id|LE_T3_CLOS
)paren
(brace
id|lp-&gt;stats.tx_carrier_errors
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|lp-&gt;auto_select
)paren
(brace
id|lp-&gt;tpe
op_assign
l_int|1
op_minus
id|lp-&gt;tpe
suffix:semicolon
id|printk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;%s: Carrier Lost, trying %s&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|lp-&gt;tpe
ques
c_cond
l_string|&quot;TPE&quot;
suffix:colon
l_string|&quot;AUI&quot;
)paren
suffix:semicolon
id|STOP_LANCE
c_func
(paren
id|lp
)paren
suffix:semicolon
id|lp
op_member_access_from_pointer
id|init_ring
c_func
(paren
id|dev
)paren
suffix:semicolon
id|load_csrs
c_func
(paren
id|lp
)paren
suffix:semicolon
id|init_restart_lance
c_func
(paren
id|lp
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
)brace
multiline_comment|/* Buffer errors and underflows turn off the&n;&t;&t;&t; * transmitter, restart the adapter.&n;&t;&t;&t; */
r_if
c_cond
(paren
id|status
op_amp
(paren
id|LE_T3_BUF
op_or
id|LE_T3_UFL
)paren
)paren
(brace
id|lp-&gt;stats.tx_fifo_errors
op_increment
suffix:semicolon
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: Tx: ERR_BUF|ERR_UFL, restarting&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|STOP_LANCE
c_func
(paren
id|lp
)paren
suffix:semicolon
id|lp
op_member_access_from_pointer
id|init_ring
c_func
(paren
id|dev
)paren
suffix:semicolon
id|load_csrs
c_func
(paren
id|lp
)paren
suffix:semicolon
id|init_restart_lance
c_func
(paren
id|lp
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
)brace
r_else
r_if
c_cond
(paren
(paren
id|bits
op_amp
id|LE_T1_POK
)paren
op_eq
id|LE_T1_POK
)paren
(brace
multiline_comment|/*&n;&t;&t;&t; * So we don&squot;t count the packet more than once.&n;&t;&t;&t; */
id|td-&gt;tmd1_bits
op_assign
id|bits
op_amp
op_complement
(paren
id|LE_T1_POK
)paren
suffix:semicolon
multiline_comment|/* One collision before packet was sent. */
r_if
c_cond
(paren
id|bits
op_amp
id|LE_T1_EONE
)paren
id|lp-&gt;stats.collisions
op_increment
suffix:semicolon
multiline_comment|/* More than one collision, be optimistic. */
r_if
c_cond
(paren
id|bits
op_amp
id|LE_T1_EMORE
)paren
id|lp-&gt;stats.collisions
op_add_assign
l_int|2
suffix:semicolon
id|lp-&gt;stats.tx_packets
op_increment
suffix:semicolon
)brace
id|j
op_assign
id|TX_NEXT
c_func
(paren
id|j
)paren
suffix:semicolon
)brace
id|lp-&gt;tx_old
op_assign
id|j
suffix:semicolon
id|out
suffix:colon
r_if
c_cond
(paren
id|netif_queue_stopped
c_func
(paren
id|dev
)paren
op_logical_and
id|TX_BUFFS_AVAIL
OG
l_int|0
)paren
id|netif_wake_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|lp-&gt;lock
)paren
suffix:semicolon
)brace
DECL|function|lance_piocopy_to_skb
r_static
r_void
id|lance_piocopy_to_skb
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_volatile
r_void
op_star
id|piobuf
comma
r_int
id|len
)paren
(brace
id|u16
op_star
id|p16
op_assign
(paren
id|u16
op_star
)paren
id|skb-&gt;data
suffix:semicolon
id|u32
op_star
id|p32
suffix:semicolon
id|u8
op_star
id|p8
suffix:semicolon
r_int
r_int
id|pbuf
op_assign
(paren
r_int
r_int
)paren
id|piobuf
suffix:semicolon
multiline_comment|/* We know here that both src and dest are on a 16bit boundry. */
op_star
id|p16
op_increment
op_assign
id|sbus_readw
c_func
(paren
id|pbuf
)paren
suffix:semicolon
id|p32
op_assign
(paren
id|u32
op_star
)paren
id|p16
suffix:semicolon
id|pbuf
op_add_assign
l_int|2
suffix:semicolon
id|len
op_sub_assign
l_int|2
suffix:semicolon
r_while
c_loop
(paren
id|len
op_ge
l_int|4
)paren
(brace
op_star
id|p32
op_increment
op_assign
id|sbus_readl
c_func
(paren
id|pbuf
)paren
suffix:semicolon
id|pbuf
op_add_assign
l_int|4
suffix:semicolon
id|len
op_sub_assign
l_int|4
suffix:semicolon
)brace
id|p8
op_assign
(paren
id|u8
op_star
)paren
id|p32
suffix:semicolon
r_if
c_cond
(paren
id|len
op_ge
l_int|2
)paren
(brace
id|p16
op_assign
(paren
id|u16
op_star
)paren
id|p32
suffix:semicolon
op_star
id|p16
op_increment
op_assign
id|sbus_readw
c_func
(paren
id|pbuf
)paren
suffix:semicolon
id|pbuf
op_add_assign
l_int|2
suffix:semicolon
id|len
op_sub_assign
l_int|2
suffix:semicolon
id|p8
op_assign
(paren
id|u8
op_star
)paren
id|p16
suffix:semicolon
)brace
r_if
c_cond
(paren
id|len
op_ge
l_int|1
)paren
op_star
id|p8
op_assign
id|sbus_readb
c_func
(paren
id|pbuf
)paren
suffix:semicolon
)brace
DECL|function|lance_rx_pio
r_static
r_void
id|lance_rx_pio
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|lance_private
op_star
id|lp
op_assign
(paren
r_struct
id|lance_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_volatile
r_struct
id|lance_init_block
op_star
id|ib
op_assign
id|lp-&gt;init_block
suffix:semicolon
r_volatile
r_struct
id|lance_rx_desc
op_star
id|rd
suffix:semicolon
r_int
r_char
id|bits
suffix:semicolon
r_int
id|len
comma
id|entry
suffix:semicolon
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
id|entry
op_assign
id|lp-&gt;rx_new
suffix:semicolon
r_for
c_loop
(paren
id|rd
op_assign
op_amp
id|ib-&gt;brx_ring
(braket
id|entry
)braket
suffix:semicolon
op_logical_neg
(paren
(paren
id|bits
op_assign
id|sbus_readb
c_func
(paren
op_amp
id|rd-&gt;rmd1_bits
)paren
)paren
op_amp
id|LE_R1_OWN
)paren
suffix:semicolon
id|rd
op_assign
op_amp
id|ib-&gt;brx_ring
(braket
id|entry
)braket
)paren
(brace
multiline_comment|/* We got an incomplete frame? */
r_if
c_cond
(paren
(paren
id|bits
op_amp
id|LE_R1_POK
)paren
op_ne
id|LE_R1_POK
)paren
(brace
id|lp-&gt;stats.rx_over_errors
op_increment
suffix:semicolon
id|lp-&gt;stats.rx_errors
op_increment
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|bits
op_amp
id|LE_R1_ERR
)paren
(brace
multiline_comment|/* Count only the end frame as a rx error,&n;&t;&t;&t; * not the beginning&n;&t;&t;&t; */
r_if
c_cond
(paren
id|bits
op_amp
id|LE_R1_BUF
)paren
id|lp-&gt;stats.rx_fifo_errors
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|bits
op_amp
id|LE_R1_CRC
)paren
id|lp-&gt;stats.rx_crc_errors
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|bits
op_amp
id|LE_R1_OFL
)paren
id|lp-&gt;stats.rx_over_errors
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|bits
op_amp
id|LE_R1_FRA
)paren
id|lp-&gt;stats.rx_frame_errors
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|bits
op_amp
id|LE_R1_EOP
)paren
id|lp-&gt;stats.rx_errors
op_increment
suffix:semicolon
)brace
r_else
(brace
id|len
op_assign
(paren
id|sbus_readw
c_func
(paren
op_amp
id|rd-&gt;mblength
)paren
op_amp
l_int|0xfff
)paren
op_minus
l_int|4
suffix:semicolon
id|skb
op_assign
id|dev_alloc_skb
c_func
(paren
id|len
op_plus
l_int|2
)paren
suffix:semicolon
r_if
c_cond
(paren
id|skb
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Memory squeeze, deferring packet.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|lp-&gt;stats.rx_dropped
op_increment
suffix:semicolon
id|sbus_writew
c_func
(paren
l_int|0
comma
op_amp
id|rd-&gt;mblength
)paren
suffix:semicolon
id|sbus_writeb
c_func
(paren
id|LE_R1_OWN
comma
op_amp
id|rd-&gt;rmd1_bits
)paren
suffix:semicolon
id|lp-&gt;rx_new
op_assign
id|RX_NEXT
c_func
(paren
id|entry
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|lp-&gt;stats.rx_bytes
op_add_assign
id|len
suffix:semicolon
id|skb-&gt;dev
op_assign
id|dev
suffix:semicolon
id|skb_reserve
(paren
id|skb
comma
l_int|2
)paren
suffix:semicolon
multiline_comment|/* 16 byte align */
id|skb_put
c_func
(paren
id|skb
comma
id|len
)paren
suffix:semicolon
multiline_comment|/* make room */
id|lance_piocopy_to_skb
c_func
(paren
id|skb
comma
op_amp
(paren
id|ib-&gt;rx_buf
(braket
id|entry
)braket
(braket
l_int|0
)braket
)paren
comma
id|len
)paren
suffix:semicolon
id|skb-&gt;protocol
op_assign
id|eth_type_trans
c_func
(paren
id|skb
comma
id|dev
)paren
suffix:semicolon
id|netif_rx
c_func
(paren
id|skb
)paren
suffix:semicolon
id|lp-&gt;stats.rx_packets
op_increment
suffix:semicolon
)brace
multiline_comment|/* Return the packet to the pool */
id|sbus_writew
c_func
(paren
l_int|0
comma
op_amp
id|rd-&gt;mblength
)paren
suffix:semicolon
id|sbus_writeb
c_func
(paren
id|LE_R1_OWN
comma
op_amp
id|rd-&gt;rmd1_bits
)paren
suffix:semicolon
id|entry
op_assign
id|RX_NEXT
c_func
(paren
id|entry
)paren
suffix:semicolon
)brace
id|lp-&gt;rx_new
op_assign
id|entry
suffix:semicolon
)brace
DECL|function|lance_tx_pio
r_static
r_void
id|lance_tx_pio
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|lance_private
op_star
id|lp
op_assign
(paren
r_struct
id|lance_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_volatile
r_struct
id|lance_init_block
op_star
id|ib
op_assign
id|lp-&gt;init_block
suffix:semicolon
r_int
id|i
comma
id|j
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|lp-&gt;lock
)paren
suffix:semicolon
id|j
op_assign
id|lp-&gt;tx_old
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
id|j
suffix:semicolon
id|i
op_ne
id|lp-&gt;tx_new
suffix:semicolon
id|i
op_assign
id|j
)paren
(brace
r_volatile
r_struct
id|lance_tx_desc
op_star
id|td
op_assign
op_amp
id|ib-&gt;btx_ring
(braket
id|i
)braket
suffix:semicolon
id|u8
id|bits
op_assign
id|sbus_readb
c_func
(paren
op_amp
id|td-&gt;tmd1_bits
)paren
suffix:semicolon
multiline_comment|/* If we hit a packet not owned by us, stop */
r_if
c_cond
(paren
id|bits
op_amp
id|LE_T1_OWN
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
id|bits
op_amp
id|LE_T1_ERR
)paren
(brace
id|u16
id|status
op_assign
id|sbus_readw
c_func
(paren
op_amp
id|td-&gt;misc
)paren
suffix:semicolon
id|lp-&gt;stats.tx_errors
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
id|LE_T3_RTY
)paren
id|lp-&gt;stats.tx_aborted_errors
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
id|LE_T3_LCOL
)paren
id|lp-&gt;stats.tx_window_errors
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
id|LE_T3_CLOS
)paren
(brace
id|lp-&gt;stats.tx_carrier_errors
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|lp-&gt;auto_select
)paren
(brace
id|lp-&gt;tpe
op_assign
l_int|1
op_minus
id|lp-&gt;tpe
suffix:semicolon
id|printk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;%s: Carrier Lost, trying %s&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|lp-&gt;tpe
ques
c_cond
l_string|&quot;TPE&quot;
suffix:colon
l_string|&quot;AUI&quot;
)paren
suffix:semicolon
id|STOP_LANCE
c_func
(paren
id|lp
)paren
suffix:semicolon
id|lp
op_member_access_from_pointer
id|init_ring
c_func
(paren
id|dev
)paren
suffix:semicolon
id|load_csrs
c_func
(paren
id|lp
)paren
suffix:semicolon
id|init_restart_lance
c_func
(paren
id|lp
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
)brace
multiline_comment|/* Buffer errors and underflows turn off the&n;&t;&t;&t; * transmitter, restart the adapter.&n;&t;&t;&t; */
r_if
c_cond
(paren
id|status
op_amp
(paren
id|LE_T3_BUF
op_or
id|LE_T3_UFL
)paren
)paren
(brace
id|lp-&gt;stats.tx_fifo_errors
op_increment
suffix:semicolon
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: Tx: ERR_BUF|ERR_UFL, restarting&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|STOP_LANCE
c_func
(paren
id|lp
)paren
suffix:semicolon
id|lp
op_member_access_from_pointer
id|init_ring
c_func
(paren
id|dev
)paren
suffix:semicolon
id|load_csrs
c_func
(paren
id|lp
)paren
suffix:semicolon
id|init_restart_lance
c_func
(paren
id|lp
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
)brace
r_else
r_if
c_cond
(paren
(paren
id|bits
op_amp
id|LE_T1_POK
)paren
op_eq
id|LE_T1_POK
)paren
(brace
multiline_comment|/*&n;&t;&t;&t; * So we don&squot;t count the packet more than once.&n;&t;&t;&t; */
id|sbus_writeb
c_func
(paren
id|bits
op_amp
op_complement
(paren
id|LE_T1_POK
)paren
comma
op_amp
id|td-&gt;tmd1_bits
)paren
suffix:semicolon
multiline_comment|/* One collision before packet was sent. */
r_if
c_cond
(paren
id|bits
op_amp
id|LE_T1_EONE
)paren
id|lp-&gt;stats.collisions
op_increment
suffix:semicolon
multiline_comment|/* More than one collision, be optimistic. */
r_if
c_cond
(paren
id|bits
op_amp
id|LE_T1_EMORE
)paren
id|lp-&gt;stats.collisions
op_add_assign
l_int|2
suffix:semicolon
id|lp-&gt;stats.tx_packets
op_increment
suffix:semicolon
)brace
id|j
op_assign
id|TX_NEXT
c_func
(paren
id|j
)paren
suffix:semicolon
)brace
id|lp-&gt;tx_old
op_assign
id|j
suffix:semicolon
r_if
c_cond
(paren
id|netif_queue_stopped
c_func
(paren
id|dev
)paren
op_logical_and
id|TX_BUFFS_AVAIL
OG
l_int|0
)paren
id|netif_wake_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
id|out
suffix:colon
id|spin_unlock
c_func
(paren
op_amp
id|lp-&gt;lock
)paren
suffix:semicolon
)brace
DECL|function|lance_interrupt
r_static
r_void
id|lance_interrupt
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_struct
id|net_device
op_star
id|dev
op_assign
(paren
r_struct
id|net_device
op_star
)paren
id|dev_id
suffix:semicolon
r_struct
id|lance_private
op_star
id|lp
op_assign
(paren
r_struct
id|lance_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_int
id|csr0
suffix:semicolon
id|sbus_writew
c_func
(paren
id|LE_CSR0
comma
id|lp-&gt;lregs
op_plus
id|RAP
)paren
suffix:semicolon
id|csr0
op_assign
id|sbus_readw
c_func
(paren
id|lp-&gt;lregs
op_plus
id|RDP
)paren
suffix:semicolon
multiline_comment|/* Acknowledge all the interrupt sources ASAP */
id|sbus_writew
c_func
(paren
id|csr0
op_amp
(paren
id|LE_C0_INTR
op_or
id|LE_C0_TINT
op_or
id|LE_C0_RINT
)paren
comma
id|lp-&gt;lregs
op_plus
id|RDP
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|csr0
op_amp
id|LE_C0_ERR
)paren
op_ne
l_int|0
)paren
(brace
multiline_comment|/* Clear the error condition */
id|sbus_writew
c_func
(paren
(paren
id|LE_C0_BABL
op_or
id|LE_C0_ERR
op_or
id|LE_C0_MISS
op_or
id|LE_C0_CERR
op_or
id|LE_C0_MERR
)paren
comma
id|lp-&gt;lregs
op_plus
id|RDP
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|csr0
op_amp
id|LE_C0_RINT
)paren
id|lp
op_member_access_from_pointer
id|rx
c_func
(paren
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|csr0
op_amp
id|LE_C0_TINT
)paren
id|lp
op_member_access_from_pointer
id|tx
c_func
(paren
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|csr0
op_amp
id|LE_C0_BABL
)paren
id|lp-&gt;stats.tx_errors
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|csr0
op_amp
id|LE_C0_MISS
)paren
id|lp-&gt;stats.rx_errors
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|csr0
op_amp
id|LE_C0_MERR
)paren
(brace
r_if
c_cond
(paren
id|lp-&gt;dregs
)paren
(brace
id|u32
id|addr
op_assign
id|sbus_readl
c_func
(paren
id|lp-&gt;dregs
op_plus
id|DMA_ADDR
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: Memory error, status %04x, addr %06x&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|csr0
comma
id|addr
op_amp
l_int|0xffffff
)paren
suffix:semicolon
)brace
r_else
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: Memory error, status %04x&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|csr0
)paren
suffix:semicolon
)brace
id|sbus_writew
c_func
(paren
id|LE_C0_STOP
comma
id|lp-&gt;lregs
op_plus
id|RDP
)paren
suffix:semicolon
r_if
c_cond
(paren
id|lp-&gt;dregs
)paren
(brace
id|u32
id|dma_csr
op_assign
id|sbus_readl
c_func
(paren
id|lp-&gt;dregs
op_plus
id|DMA_CSR
)paren
suffix:semicolon
id|dma_csr
op_or_assign
id|DMA_FIFO_INV
suffix:semicolon
id|sbus_writel
c_func
(paren
id|dma_csr
comma
id|lp-&gt;dregs
op_plus
id|DMA_CSR
)paren
suffix:semicolon
)brace
id|lp
op_member_access_from_pointer
id|init_ring
c_func
(paren
id|dev
)paren
suffix:semicolon
id|load_csrs
c_func
(paren
id|lp
)paren
suffix:semicolon
id|init_restart_lance
c_func
(paren
id|lp
)paren
suffix:semicolon
id|netif_wake_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
id|sbus_writew
c_func
(paren
id|LE_C0_INEA
comma
id|lp-&gt;lregs
op_plus
id|RDP
)paren
suffix:semicolon
)brace
multiline_comment|/* Build a fake network packet and send it to ourselves. */
DECL|function|build_fake_packet
r_static
r_void
id|build_fake_packet
c_func
(paren
r_struct
id|lance_private
op_star
id|lp
)paren
(brace
r_struct
id|net_device
op_star
id|dev
op_assign
id|lp-&gt;dev
suffix:semicolon
r_volatile
r_struct
id|lance_init_block
op_star
id|ib
op_assign
id|lp-&gt;init_block
suffix:semicolon
id|u16
op_star
id|packet
suffix:semicolon
r_struct
id|ethhdr
op_star
id|eth
suffix:semicolon
r_int
id|i
comma
id|entry
suffix:semicolon
id|entry
op_assign
id|lp-&gt;tx_new
op_amp
id|TX_RING_MOD_MASK
suffix:semicolon
id|packet
op_assign
(paren
id|u16
op_star
)paren
op_amp
(paren
id|ib-&gt;tx_buf
(braket
id|entry
)braket
(braket
l_int|0
)braket
)paren
suffix:semicolon
id|eth
op_assign
(paren
r_struct
id|ethhdr
op_star
)paren
id|packet
suffix:semicolon
r_if
c_cond
(paren
id|lp-&gt;pio_buffer
)paren
(brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
(paren
id|ETH_ZLEN
op_div
r_sizeof
(paren
id|u16
)paren
)paren
suffix:semicolon
id|i
op_increment
)paren
id|sbus_writew
c_func
(paren
l_int|0
comma
op_amp
id|packet
(braket
id|i
)braket
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|6
suffix:semicolon
id|i
op_increment
)paren
(brace
id|sbus_writeb
c_func
(paren
id|dev-&gt;dev_addr
(braket
id|i
)braket
comma
op_amp
id|eth-&gt;h_dest
(braket
id|i
)braket
)paren
suffix:semicolon
id|sbus_writeb
c_func
(paren
id|dev-&gt;dev_addr
(braket
id|i
)braket
comma
op_amp
id|eth-&gt;h_source
(braket
id|i
)braket
)paren
suffix:semicolon
)brace
id|sbus_writew
c_func
(paren
(paren
op_minus
id|ETH_ZLEN
)paren
op_or
l_int|0xf000
comma
op_amp
id|ib-&gt;btx_ring
(braket
id|entry
)braket
dot
id|length
)paren
suffix:semicolon
id|sbus_writew
c_func
(paren
l_int|0
comma
op_amp
id|ib-&gt;btx_ring
(braket
id|entry
)braket
dot
id|misc
)paren
suffix:semicolon
id|sbus_writeb
c_func
(paren
id|LE_T1_POK
op_or
id|LE_T1_OWN
comma
op_amp
id|ib-&gt;btx_ring
(braket
id|entry
)braket
dot
id|tmd1_bits
)paren
suffix:semicolon
)brace
r_else
(brace
id|memset
c_func
(paren
id|packet
comma
l_int|0
comma
id|ETH_ZLEN
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|6
suffix:semicolon
id|i
op_increment
)paren
(brace
id|eth-&gt;h_dest
(braket
id|i
)braket
op_assign
id|dev-&gt;dev_addr
(braket
id|i
)braket
suffix:semicolon
id|eth-&gt;h_source
(braket
id|i
)braket
op_assign
id|dev-&gt;dev_addr
(braket
id|i
)braket
suffix:semicolon
)brace
id|ib-&gt;btx_ring
(braket
id|entry
)braket
dot
id|length
op_assign
(paren
op_minus
id|ETH_ZLEN
)paren
op_or
l_int|0xf000
suffix:semicolon
id|ib-&gt;btx_ring
(braket
id|entry
)braket
dot
id|misc
op_assign
l_int|0
suffix:semicolon
id|ib-&gt;btx_ring
(braket
id|entry
)braket
dot
id|tmd1_bits
op_assign
(paren
id|LE_T1_POK
op_or
id|LE_T1_OWN
)paren
suffix:semicolon
)brace
id|lp-&gt;tx_new
op_assign
id|TX_NEXT
c_func
(paren
id|entry
)paren
suffix:semicolon
)brace
DECL|variable|last_dev
r_struct
id|net_device
op_star
id|last_dev
op_assign
l_int|0
suffix:semicolon
DECL|function|lance_open
r_static
r_int
id|lance_open
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|lance_private
op_star
id|lp
op_assign
(paren
r_struct
id|lance_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_volatile
r_struct
id|lance_init_block
op_star
id|ib
op_assign
id|lp-&gt;init_block
suffix:semicolon
r_int
id|status
op_assign
l_int|0
suffix:semicolon
id|last_dev
op_assign
id|dev
suffix:semicolon
r_if
c_cond
(paren
id|request_irq
c_func
(paren
id|dev-&gt;irq
comma
op_amp
id|lance_interrupt
comma
id|SA_SHIRQ
comma
id|lancestr
comma
(paren
r_void
op_star
)paren
id|dev
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;Lance: Can&squot;t get irq %s&bslash;n&quot;
comma
id|__irq_itoa
c_func
(paren
id|dev-&gt;irq
)paren
)paren
suffix:semicolon
r_return
op_minus
id|EAGAIN
suffix:semicolon
)brace
id|STOP_LANCE
c_func
(paren
id|lp
)paren
suffix:semicolon
multiline_comment|/* On the 4m, setup the ledma to provide the upper bits for buffers */
r_if
c_cond
(paren
id|lp-&gt;dregs
)paren
(brace
id|u32
id|regval
op_assign
id|lp-&gt;init_block_dvma
op_amp
l_int|0xff000000
suffix:semicolon
id|sbus_writel
c_func
(paren
id|regval
comma
id|lp-&gt;dregs
op_plus
id|DMA_TEST
)paren
suffix:semicolon
)brace
multiline_comment|/* Set mode and clear multicast filter only at device open,&n;&t; * so that lance_init_ring() called at any error will not&n;&t; * forget multicast filters.&n;&t; *&n;&t; * BTW it is common bug in all lance drivers! --ANK&n;&t; */
r_if
c_cond
(paren
id|lp-&gt;pio_buffer
)paren
(brace
id|sbus_writew
c_func
(paren
l_int|0
comma
op_amp
id|ib-&gt;mode
)paren
suffix:semicolon
id|sbus_writel
c_func
(paren
l_int|0
comma
op_amp
id|ib-&gt;filter
(braket
l_int|0
)braket
)paren
suffix:semicolon
id|sbus_writel
c_func
(paren
l_int|0
comma
op_amp
id|ib-&gt;filter
(braket
l_int|1
)braket
)paren
suffix:semicolon
)brace
r_else
(brace
id|ib-&gt;mode
op_assign
l_int|0
suffix:semicolon
id|ib-&gt;filter
(braket
l_int|0
)braket
op_assign
l_int|0
suffix:semicolon
id|ib-&gt;filter
(braket
l_int|1
)braket
op_assign
l_int|0
suffix:semicolon
)brace
id|lp
op_member_access_from_pointer
id|init_ring
c_func
(paren
id|dev
)paren
suffix:semicolon
id|load_csrs
c_func
(paren
id|lp
)paren
suffix:semicolon
id|netif_start_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
id|status
op_assign
id|init_restart_lance
c_func
(paren
id|lp
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|status
op_logical_and
id|lp-&gt;auto_select
)paren
(brace
id|build_fake_packet
c_func
(paren
id|lp
)paren
suffix:semicolon
id|sbus_writew
c_func
(paren
id|LE_C0_INEA
op_or
id|LE_C0_TDMD
comma
id|lp-&gt;lregs
op_plus
id|RDP
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|status
)paren
id|MOD_INC_USE_COUNT
suffix:semicolon
r_return
id|status
suffix:semicolon
)brace
DECL|function|lance_close
r_static
r_int
id|lance_close
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|lance_private
op_star
id|lp
op_assign
(paren
r_struct
id|lance_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|netif_stop_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
id|del_timer_sync
c_func
(paren
op_amp
id|lp-&gt;multicast_timer
)paren
suffix:semicolon
id|STOP_LANCE
c_func
(paren
id|lp
)paren
suffix:semicolon
id|free_irq
c_func
(paren
id|dev-&gt;irq
comma
(paren
r_void
op_star
)paren
id|dev
)paren
suffix:semicolon
id|MOD_DEC_USE_COUNT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|lance_reset
r_static
r_int
id|lance_reset
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|lance_private
op_star
id|lp
op_assign
(paren
r_struct
id|lance_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_int
id|status
suffix:semicolon
id|STOP_LANCE
c_func
(paren
id|lp
)paren
suffix:semicolon
multiline_comment|/* On the 4m, reset the dma too */
r_if
c_cond
(paren
id|lp-&gt;dregs
)paren
(brace
id|u32
id|csr
comma
id|addr
suffix:semicolon
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;resetting ledma&bslash;n&quot;
)paren
suffix:semicolon
id|csr
op_assign
id|sbus_readl
c_func
(paren
id|lp-&gt;dregs
op_plus
id|DMA_CSR
)paren
suffix:semicolon
id|sbus_writel
c_func
(paren
id|csr
op_or
id|DMA_RST_ENET
comma
id|lp-&gt;dregs
op_plus
id|DMA_CSR
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|200
)paren
suffix:semicolon
id|sbus_writel
c_func
(paren
id|csr
op_amp
op_complement
id|DMA_RST_ENET
comma
id|lp-&gt;dregs
op_plus
id|DMA_CSR
)paren
suffix:semicolon
id|addr
op_assign
id|lp-&gt;init_block_dvma
op_amp
l_int|0xff000000
suffix:semicolon
id|sbus_writel
c_func
(paren
id|addr
comma
id|lp-&gt;dregs
op_plus
id|DMA_TEST
)paren
suffix:semicolon
)brace
id|lp
op_member_access_from_pointer
id|init_ring
c_func
(paren
id|dev
)paren
suffix:semicolon
id|load_csrs
c_func
(paren
id|lp
)paren
suffix:semicolon
id|dev-&gt;trans_start
op_assign
id|jiffies
suffix:semicolon
id|status
op_assign
id|init_restart_lance
c_func
(paren
id|lp
)paren
suffix:semicolon
r_return
id|status
suffix:semicolon
)brace
DECL|function|lance_piocopy_from_skb
r_static
r_void
id|lance_piocopy_from_skb
c_func
(paren
r_volatile
r_void
op_star
id|dest
comma
r_int
r_char
op_star
id|src
comma
r_int
id|len
)paren
(brace
r_int
r_int
id|piobuf
op_assign
(paren
r_int
r_int
)paren
id|dest
suffix:semicolon
id|u32
op_star
id|p32
suffix:semicolon
id|u16
op_star
id|p16
suffix:semicolon
id|u8
op_star
id|p8
suffix:semicolon
r_switch
c_cond
(paren
(paren
r_int
r_int
)paren
id|src
op_amp
l_int|0x3
)paren
(brace
r_case
l_int|0
suffix:colon
id|p32
op_assign
(paren
id|u32
op_star
)paren
id|src
suffix:semicolon
r_while
c_loop
(paren
id|len
op_ge
l_int|4
)paren
(brace
id|sbus_writel
c_func
(paren
op_star
id|p32
comma
id|piobuf
)paren
suffix:semicolon
id|p32
op_increment
suffix:semicolon
id|piobuf
op_add_assign
l_int|4
suffix:semicolon
id|len
op_sub_assign
l_int|4
suffix:semicolon
)brace
id|src
op_assign
(paren
r_char
op_star
)paren
id|p32
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|1
suffix:colon
r_case
l_int|3
suffix:colon
id|p8
op_assign
(paren
id|u8
op_star
)paren
id|src
suffix:semicolon
r_while
c_loop
(paren
id|len
op_ge
l_int|4
)paren
(brace
id|u32
id|val
suffix:semicolon
id|val
op_assign
id|p8
(braket
l_int|0
)braket
op_lshift
l_int|24
suffix:semicolon
id|val
op_or_assign
id|p8
(braket
l_int|1
)braket
op_lshift
l_int|16
suffix:semicolon
id|val
op_or_assign
id|p8
(braket
l_int|2
)braket
op_lshift
l_int|8
suffix:semicolon
id|val
op_or_assign
id|p8
(braket
l_int|3
)braket
suffix:semicolon
id|sbus_writel
c_func
(paren
id|val
comma
id|piobuf
)paren
suffix:semicolon
id|p8
op_add_assign
l_int|4
suffix:semicolon
id|piobuf
op_add_assign
l_int|4
suffix:semicolon
id|len
op_sub_assign
l_int|4
suffix:semicolon
)brace
id|src
op_assign
(paren
r_char
op_star
)paren
id|p8
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|2
suffix:colon
id|p16
op_assign
(paren
id|u16
op_star
)paren
id|src
suffix:semicolon
r_while
c_loop
(paren
id|len
op_ge
l_int|4
)paren
(brace
id|u32
id|val
op_assign
id|p16
(braket
l_int|0
)braket
op_lshift
l_int|16
op_or
id|p16
(braket
l_int|1
)braket
suffix:semicolon
id|sbus_writel
c_func
(paren
id|val
comma
id|piobuf
)paren
suffix:semicolon
id|p16
op_add_assign
l_int|2
suffix:semicolon
id|piobuf
op_add_assign
l_int|4
suffix:semicolon
id|len
op_sub_assign
l_int|4
suffix:semicolon
)brace
id|src
op_assign
(paren
r_char
op_star
)paren
id|p16
suffix:semicolon
r_break
suffix:semicolon
)brace
suffix:semicolon
r_if
c_cond
(paren
id|len
op_ge
l_int|2
)paren
(brace
id|u16
id|val
op_assign
id|src
(braket
l_int|0
)braket
op_lshift
l_int|8
op_or
id|src
(braket
l_int|1
)braket
suffix:semicolon
id|sbus_writew
c_func
(paren
id|val
comma
id|piobuf
)paren
suffix:semicolon
id|src
op_add_assign
l_int|2
suffix:semicolon
id|piobuf
op_add_assign
l_int|2
suffix:semicolon
id|len
op_sub_assign
l_int|2
suffix:semicolon
)brace
r_if
c_cond
(paren
id|len
op_ge
l_int|1
)paren
id|sbus_writeb
c_func
(paren
id|src
(braket
l_int|0
)braket
comma
id|piobuf
)paren
suffix:semicolon
)brace
DECL|function|lance_piozero
r_static
r_void
id|lance_piozero
c_func
(paren
r_volatile
r_void
op_star
id|dest
comma
r_int
id|len
)paren
(brace
r_int
r_int
id|piobuf
op_assign
(paren
r_int
r_int
)paren
id|dest
suffix:semicolon
r_if
c_cond
(paren
id|piobuf
op_amp
l_int|1
)paren
(brace
id|sbus_writeb
c_func
(paren
l_int|0
comma
id|piobuf
)paren
suffix:semicolon
id|piobuf
op_add_assign
l_int|1
suffix:semicolon
id|len
op_sub_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|len
op_eq
l_int|0
)paren
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|len
op_eq
l_int|1
)paren
(brace
id|sbus_writeb
c_func
(paren
l_int|0
comma
id|piobuf
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|piobuf
op_amp
l_int|2
)paren
(brace
id|sbus_writew
c_func
(paren
l_int|0
comma
id|piobuf
)paren
suffix:semicolon
id|piobuf
op_add_assign
l_int|2
suffix:semicolon
id|len
op_sub_assign
l_int|2
suffix:semicolon
r_if
c_cond
(paren
id|len
op_eq
l_int|0
)paren
r_return
suffix:semicolon
)brace
r_while
c_loop
(paren
id|len
op_ge
l_int|4
)paren
(brace
id|sbus_writel
c_func
(paren
l_int|0
comma
id|piobuf
)paren
suffix:semicolon
id|piobuf
op_add_assign
l_int|4
suffix:semicolon
id|len
op_sub_assign
l_int|4
suffix:semicolon
)brace
r_if
c_cond
(paren
id|len
op_ge
l_int|2
)paren
(brace
id|sbus_writew
c_func
(paren
l_int|0
comma
id|piobuf
)paren
suffix:semicolon
id|piobuf
op_add_assign
l_int|2
suffix:semicolon
id|len
op_sub_assign
l_int|2
suffix:semicolon
)brace
r_if
c_cond
(paren
id|len
op_ge
l_int|1
)paren
id|sbus_writeb
c_func
(paren
l_int|0
comma
id|piobuf
)paren
suffix:semicolon
)brace
DECL|function|lance_tx_timeout
r_static
r_void
id|lance_tx_timeout
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|lance_private
op_star
id|lp
op_assign
(paren
r_struct
id|lance_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: transmit timed out, status %04x, reset&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|sbus_readw
c_func
(paren
id|lp-&gt;lregs
op_plus
id|RDP
)paren
)paren
suffix:semicolon
id|lance_reset
c_func
(paren
id|dev
)paren
suffix:semicolon
id|netif_wake_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
DECL|function|lance_start_xmit
r_static
r_int
id|lance_start_xmit
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|lance_private
op_star
id|lp
op_assign
(paren
r_struct
id|lance_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_volatile
r_struct
id|lance_init_block
op_star
id|ib
op_assign
id|lp-&gt;init_block
suffix:semicolon
r_int
id|entry
comma
id|skblen
comma
id|len
suffix:semicolon
id|skblen
op_assign
id|skb-&gt;len
suffix:semicolon
id|len
op_assign
(paren
id|skblen
op_le
id|ETH_ZLEN
)paren
ques
c_cond
id|ETH_ZLEN
suffix:colon
id|skblen
suffix:semicolon
id|spin_lock_irq
c_func
(paren
op_amp
id|lp-&gt;lock
)paren
suffix:semicolon
id|lp-&gt;stats.tx_bytes
op_add_assign
id|len
suffix:semicolon
id|entry
op_assign
id|lp-&gt;tx_new
op_amp
id|TX_RING_MOD_MASK
suffix:semicolon
r_if
c_cond
(paren
id|lp-&gt;pio_buffer
)paren
(brace
id|sbus_writew
c_func
(paren
(paren
op_minus
id|len
)paren
op_or
l_int|0xf000
comma
op_amp
id|ib-&gt;btx_ring
(braket
id|entry
)braket
dot
id|length
)paren
suffix:semicolon
id|sbus_writew
c_func
(paren
l_int|0
comma
op_amp
id|ib-&gt;btx_ring
(braket
id|entry
)braket
dot
id|misc
)paren
suffix:semicolon
id|lance_piocopy_from_skb
c_func
(paren
op_amp
id|ib-&gt;tx_buf
(braket
id|entry
)braket
(braket
l_int|0
)braket
comma
id|skb-&gt;data
comma
id|skblen
)paren
suffix:semicolon
r_if
c_cond
(paren
id|len
op_ne
id|skblen
)paren
id|lance_piozero
c_func
(paren
op_amp
id|ib-&gt;tx_buf
(braket
id|entry
)braket
(braket
id|skblen
)braket
comma
id|len
op_minus
id|skblen
)paren
suffix:semicolon
id|sbus_writeb
c_func
(paren
id|LE_T1_POK
op_or
id|LE_T1_OWN
comma
op_amp
id|ib-&gt;btx_ring
(braket
id|entry
)braket
dot
id|tmd1_bits
)paren
suffix:semicolon
)brace
r_else
(brace
id|ib-&gt;btx_ring
(braket
id|entry
)braket
dot
id|length
op_assign
(paren
op_minus
id|len
)paren
op_or
l_int|0xf000
suffix:semicolon
id|ib-&gt;btx_ring
(braket
id|entry
)braket
dot
id|misc
op_assign
l_int|0
suffix:semicolon
id|memcpy
c_func
(paren
(paren
r_char
op_star
)paren
op_amp
id|ib-&gt;tx_buf
(braket
id|entry
)braket
(braket
l_int|0
)braket
comma
id|skb-&gt;data
comma
id|skblen
)paren
suffix:semicolon
r_if
c_cond
(paren
id|len
op_ne
id|skblen
)paren
id|memset
c_func
(paren
(paren
r_char
op_star
)paren
op_amp
id|ib-&gt;tx_buf
(braket
id|entry
)braket
(braket
id|skblen
)braket
comma
l_int|0
comma
id|len
op_minus
id|skblen
)paren
suffix:semicolon
id|ib-&gt;btx_ring
(braket
id|entry
)braket
dot
id|tmd1_bits
op_assign
(paren
id|LE_T1_POK
op_or
id|LE_T1_OWN
)paren
suffix:semicolon
)brace
id|lp-&gt;tx_new
op_assign
id|TX_NEXT
c_func
(paren
id|entry
)paren
suffix:semicolon
r_if
c_cond
(paren
id|TX_BUFFS_AVAIL
op_le
l_int|0
)paren
id|netif_stop_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
multiline_comment|/* Kick the lance: transmit now */
id|sbus_writew
c_func
(paren
id|LE_C0_INEA
op_or
id|LE_C0_TDMD
comma
id|lp-&gt;lregs
op_plus
id|RDP
)paren
suffix:semicolon
multiline_comment|/* Read back CSR to invalidate the E-Cache.&n;&t; * This is needed, because DMA_DSBL_WR_INV is set.&n;&t; */
r_if
c_cond
(paren
id|lp-&gt;dregs
)paren
id|sbus_readw
c_func
(paren
id|lp-&gt;lregs
op_plus
id|RDP
)paren
suffix:semicolon
id|spin_unlock_irq
c_func
(paren
op_amp
id|lp-&gt;lock
)paren
suffix:semicolon
id|dev-&gt;trans_start
op_assign
id|jiffies
suffix:semicolon
id|dev_kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|lance_get_stats
r_static
r_struct
id|net_device_stats
op_star
id|lance_get_stats
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|lance_private
op_star
id|lp
op_assign
(paren
r_struct
id|lance_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_return
op_amp
id|lp-&gt;stats
suffix:semicolon
)brace
multiline_comment|/* taken from the depca driver */
DECL|function|lance_load_multicast
r_static
r_void
id|lance_load_multicast
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|lance_private
op_star
id|lp
op_assign
(paren
r_struct
id|lance_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_volatile
r_struct
id|lance_init_block
op_star
id|ib
op_assign
id|lp-&gt;init_block
suffix:semicolon
r_volatile
id|u16
op_star
id|mcast_table
op_assign
(paren
id|u16
op_star
)paren
op_amp
id|ib-&gt;filter
suffix:semicolon
r_struct
id|dev_mc_list
op_star
id|dmi
op_assign
id|dev-&gt;mc_list
suffix:semicolon
r_char
op_star
id|addrs
suffix:semicolon
r_int
id|i
comma
id|j
comma
id|bit
comma
id|byte
suffix:semicolon
id|u32
id|crc
comma
id|poly
op_assign
id|CRC_POLYNOMIAL_LE
suffix:semicolon
multiline_comment|/* set all multicast bits */
r_if
c_cond
(paren
id|dev-&gt;flags
op_amp
id|IFF_ALLMULTI
)paren
(brace
r_if
c_cond
(paren
id|lp-&gt;pio_buffer
)paren
(brace
id|sbus_writel
c_func
(paren
l_int|0xffffffff
comma
op_amp
id|ib-&gt;filter
(braket
l_int|0
)braket
)paren
suffix:semicolon
id|sbus_writel
c_func
(paren
l_int|0xffffffff
comma
op_amp
id|ib-&gt;filter
(braket
l_int|1
)braket
)paren
suffix:semicolon
)brace
r_else
(brace
id|ib-&gt;filter
(braket
l_int|0
)braket
op_assign
l_int|0xffffffff
suffix:semicolon
id|ib-&gt;filter
(braket
l_int|1
)braket
op_assign
l_int|0xffffffff
suffix:semicolon
)brace
r_return
suffix:semicolon
)brace
multiline_comment|/* clear the multicast filter */
r_if
c_cond
(paren
id|lp-&gt;pio_buffer
)paren
(brace
id|sbus_writel
c_func
(paren
l_int|0
comma
op_amp
id|ib-&gt;filter
(braket
l_int|0
)braket
)paren
suffix:semicolon
id|sbus_writel
c_func
(paren
l_int|0
comma
op_amp
id|ib-&gt;filter
(braket
l_int|1
)braket
)paren
suffix:semicolon
)brace
r_else
(brace
id|ib-&gt;filter
(braket
l_int|0
)braket
op_assign
l_int|0
suffix:semicolon
id|ib-&gt;filter
(braket
l_int|1
)braket
op_assign
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Add addresses */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|dev-&gt;mc_count
suffix:semicolon
id|i
op_increment
)paren
(brace
id|addrs
op_assign
id|dmi-&gt;dmi_addr
suffix:semicolon
id|dmi
op_assign
id|dmi-&gt;next
suffix:semicolon
multiline_comment|/* multicast address? */
r_if
c_cond
(paren
op_logical_neg
(paren
op_star
id|addrs
op_amp
l_int|1
)paren
)paren
r_continue
suffix:semicolon
id|crc
op_assign
l_int|0xffffffff
suffix:semicolon
r_for
c_loop
(paren
id|byte
op_assign
l_int|0
suffix:semicolon
id|byte
OL
l_int|6
suffix:semicolon
id|byte
op_increment
)paren
(brace
r_for
c_loop
(paren
id|bit
op_assign
op_star
id|addrs
op_increment
comma
id|j
op_assign
l_int|0
suffix:semicolon
id|j
OL
l_int|8
suffix:semicolon
id|j
op_increment
comma
id|bit
op_rshift_assign
l_int|1
)paren
(brace
r_int
id|test
suffix:semicolon
id|test
op_assign
(paren
(paren
id|bit
op_xor
id|crc
)paren
op_amp
l_int|0x01
)paren
suffix:semicolon
id|crc
op_rshift_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|test
)paren
id|crc
op_assign
id|crc
op_xor
id|poly
suffix:semicolon
)brace
)brace
id|crc
op_assign
id|crc
op_rshift
l_int|26
suffix:semicolon
r_if
c_cond
(paren
id|lp-&gt;pio_buffer
)paren
(brace
id|u16
id|tmp
op_assign
id|sbus_readw
c_func
(paren
op_amp
id|mcast_table
(braket
id|crc
op_rshift
l_int|4
)braket
)paren
suffix:semicolon
id|tmp
op_or_assign
l_int|1
op_lshift
(paren
id|crc
op_amp
l_int|0xf
)paren
suffix:semicolon
id|sbus_writew
c_func
(paren
id|tmp
comma
op_amp
id|mcast_table
(braket
id|crc
op_rshift
l_int|4
)braket
)paren
suffix:semicolon
)brace
r_else
(brace
id|mcast_table
(braket
id|crc
op_rshift
l_int|4
)braket
op_or_assign
l_int|1
op_lshift
(paren
id|crc
op_amp
l_int|0xf
)paren
suffix:semicolon
)brace
)brace
)brace
DECL|function|lance_set_multicast
r_static
r_void
id|lance_set_multicast
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|lance_private
op_star
id|lp
op_assign
(paren
r_struct
id|lance_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_volatile
r_struct
id|lance_init_block
op_star
id|ib
op_assign
id|lp-&gt;init_block
suffix:semicolon
id|u16
id|mode
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|netif_running
c_func
(paren
id|dev
)paren
)paren
r_return
suffix:semicolon
r_if
c_cond
(paren
id|lp-&gt;tx_old
op_ne
id|lp-&gt;tx_new
)paren
(brace
id|mod_timer
c_func
(paren
op_amp
id|lp-&gt;multicast_timer
comma
id|jiffies
op_plus
l_int|4
)paren
suffix:semicolon
id|netif_wake_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|netif_stop_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
id|STOP_LANCE
c_func
(paren
id|lp
)paren
suffix:semicolon
id|lp
op_member_access_from_pointer
id|init_ring
c_func
(paren
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|lp-&gt;pio_buffer
)paren
id|mode
op_assign
id|sbus_readw
c_func
(paren
op_amp
id|ib-&gt;mode
)paren
suffix:semicolon
r_else
id|mode
op_assign
id|ib-&gt;mode
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;flags
op_amp
id|IFF_PROMISC
)paren
(brace
id|mode
op_or_assign
id|LE_MO_PROM
suffix:semicolon
r_if
c_cond
(paren
id|lp-&gt;pio_buffer
)paren
id|sbus_writew
c_func
(paren
id|mode
comma
op_amp
id|ib-&gt;mode
)paren
suffix:semicolon
r_else
id|ib-&gt;mode
op_assign
id|mode
suffix:semicolon
)brace
r_else
(brace
id|mode
op_and_assign
op_complement
id|LE_MO_PROM
suffix:semicolon
r_if
c_cond
(paren
id|lp-&gt;pio_buffer
)paren
id|sbus_writew
c_func
(paren
id|mode
comma
op_amp
id|ib-&gt;mode
)paren
suffix:semicolon
r_else
id|ib-&gt;mode
op_assign
id|mode
suffix:semicolon
id|lance_load_multicast
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
id|load_csrs
c_func
(paren
id|lp
)paren
suffix:semicolon
id|init_restart_lance
c_func
(paren
id|lp
)paren
suffix:semicolon
id|netif_wake_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
DECL|function|lance_set_multicast_retry
r_static
r_void
id|lance_set_multicast_retry
c_func
(paren
r_int
r_int
id|_opaque
)paren
(brace
r_struct
id|net_device
op_star
id|dev
op_assign
(paren
r_struct
id|net_device
op_star
)paren
id|_opaque
suffix:semicolon
id|lance_set_multicast
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
DECL|function|lance_free_hwresources
r_static
r_void
id|lance_free_hwresources
c_func
(paren
r_struct
id|lance_private
op_star
id|lp
)paren
(brace
r_if
c_cond
(paren
id|lp-&gt;lregs
)paren
id|sbus_iounmap
c_func
(paren
id|lp-&gt;lregs
comma
id|LANCE_REG_SIZE
)paren
suffix:semicolon
r_if
c_cond
(paren
id|lp-&gt;init_block
op_ne
l_int|NULL
)paren
(brace
r_if
c_cond
(paren
id|lp-&gt;pio_buffer
)paren
(brace
id|sbus_iounmap
c_func
(paren
(paren
r_int
r_int
)paren
id|lp-&gt;init_block
comma
r_sizeof
(paren
r_struct
id|lance_init_block
)paren
)paren
suffix:semicolon
)brace
r_else
(brace
id|sbus_free_consistent
c_func
(paren
id|lp-&gt;sdev
comma
r_sizeof
(paren
r_struct
id|lance_init_block
)paren
comma
(paren
r_void
op_star
)paren
id|lp-&gt;init_block
comma
id|lp-&gt;init_block_dvma
)paren
suffix:semicolon
)brace
)brace
)brace
DECL|function|sparc_lance_init
r_static
r_int
id|__init
id|sparc_lance_init
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_struct
id|sbus_dev
op_star
id|sdev
comma
r_struct
id|sbus_dma
op_star
id|ledma
comma
r_struct
id|sbus_dev
op_star
id|lebuffer
)paren
(brace
r_static
r_int
id|version_printed
op_assign
l_int|0
suffix:semicolon
r_struct
id|lance_private
op_star
id|lp
op_assign
l_int|NULL
suffix:semicolon
r_int
id|i
suffix:semicolon
r_if
c_cond
(paren
id|dev
op_eq
l_int|NULL
)paren
(brace
id|dev
op_assign
id|init_etherdev
(paren
l_int|0
comma
r_sizeof
(paren
r_struct
id|lance_private
)paren
op_plus
l_int|8
)paren
suffix:semicolon
)brace
r_else
(brace
id|dev-&gt;priv
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|lance_private
)paren
op_plus
l_int|8
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;priv
op_eq
l_int|NULL
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|memset
c_func
(paren
id|dev-&gt;priv
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|lance_private
)paren
op_plus
l_int|8
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|sparc_lance_debug
op_logical_and
id|version_printed
op_increment
op_eq
l_int|0
)paren
id|printk
(paren
id|KERN_INFO
l_string|&quot;%s&quot;
comma
id|version
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: LANCE &quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
multiline_comment|/* Make certain the data structures used by the LANCE are aligned. */
id|dev-&gt;priv
op_assign
(paren
r_void
op_star
)paren
(paren
(paren
(paren
r_int
r_int
)paren
id|dev-&gt;priv
op_plus
l_int|7
)paren
op_amp
op_complement
l_int|7
)paren
suffix:semicolon
id|lp
op_assign
(paren
r_struct
id|lance_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|spin_lock_init
c_func
(paren
op_amp
id|lp-&gt;lock
)paren
suffix:semicolon
multiline_comment|/* Copy the IDPROM ethernet address to the device structure, later we&n;&t; * will copy the address in the device structure to the lance&n;&t; * initialization block.&n;&t; */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|6
suffix:semicolon
id|i
op_increment
)paren
id|printk
c_func
(paren
l_string|&quot;%2.2x%c&quot;
comma
id|dev-&gt;dev_addr
(braket
id|i
)braket
op_assign
id|idprom-&gt;id_ethaddr
(braket
id|i
)braket
comma
id|i
op_eq
l_int|5
ques
c_cond
l_char|&squot; &squot;
suffix:colon
l_char|&squot;:&squot;
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* Get the IO region */
id|lp-&gt;lregs
op_assign
id|sbus_ioremap
c_func
(paren
op_amp
id|sdev-&gt;resource
(braket
l_int|0
)braket
comma
l_int|0
comma
id|LANCE_REG_SIZE
comma
id|lancestr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|lp-&gt;lregs
op_eq
l_int|0UL
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: Cannot map SunLance registers.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_goto
id|fail
suffix:semicolon
)brace
id|lp-&gt;sdev
op_assign
id|sdev
suffix:semicolon
r_if
c_cond
(paren
id|lebuffer
)paren
(brace
id|lp-&gt;init_block
op_assign
(paren
r_volatile
r_struct
id|lance_init_block
op_star
)paren
id|sbus_ioremap
c_func
(paren
op_amp
id|lebuffer-&gt;resource
(braket
l_int|0
)braket
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|lance_init_block
)paren
comma
l_string|&quot;lebuffer&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|lp-&gt;init_block
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: Cannot map SunLance PIO buffer.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_goto
id|fail
suffix:semicolon
)brace
id|lp-&gt;init_block_dvma
op_assign
l_int|0
suffix:semicolon
id|lp-&gt;pio_buffer
op_assign
l_int|1
suffix:semicolon
id|lp-&gt;init_ring
op_assign
id|lance_init_ring_pio
suffix:semicolon
id|lp-&gt;rx
op_assign
id|lance_rx_pio
suffix:semicolon
id|lp-&gt;tx
op_assign
id|lance_tx_pio
suffix:semicolon
)brace
r_else
(brace
id|lp-&gt;init_block
op_assign
(paren
r_volatile
r_struct
id|lance_init_block
op_star
)paren
id|sbus_alloc_consistent
c_func
(paren
id|sdev
comma
r_sizeof
(paren
r_struct
id|lance_init_block
)paren
comma
op_amp
id|lp-&gt;init_block_dvma
)paren
suffix:semicolon
r_if
c_cond
(paren
id|lp-&gt;init_block
op_eq
l_int|NULL
op_logical_or
id|lp-&gt;init_block_dvma
op_eq
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: Cannot allocate consistent DMA memory.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_goto
id|fail
suffix:semicolon
)brace
id|lp-&gt;pio_buffer
op_assign
l_int|0
suffix:semicolon
id|lp-&gt;init_ring
op_assign
id|lance_init_ring_dvma
suffix:semicolon
id|lp-&gt;rx
op_assign
id|lance_rx_dvma
suffix:semicolon
id|lp-&gt;tx
op_assign
id|lance_tx_dvma
suffix:semicolon
)brace
id|lp-&gt;busmaster_regval
op_assign
id|prom_getintdefault
c_func
(paren
id|sdev-&gt;prom_node
comma
l_string|&quot;busmaster-regval&quot;
comma
(paren
id|LE_C3_BSWP
op_or
id|LE_C3_ACON
op_or
id|LE_C3_BCON
)paren
)paren
suffix:semicolon
id|lp-&gt;name
op_assign
id|lancestr
suffix:semicolon
id|lp-&gt;ledma
op_assign
id|ledma
suffix:semicolon
id|lp-&gt;burst_sizes
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|lp-&gt;ledma
)paren
(brace
r_char
id|prop
(braket
l_int|6
)braket
suffix:semicolon
r_int
r_int
id|sbmask
suffix:semicolon
id|u32
id|csr
suffix:semicolon
multiline_comment|/* Find burst-size property for ledma */
id|lp-&gt;burst_sizes
op_assign
id|prom_getintdefault
c_func
(paren
id|ledma-&gt;sdev-&gt;prom_node
comma
l_string|&quot;burst-sizes&quot;
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* ledma may be capable of fast bursts, but sbus may not. */
id|sbmask
op_assign
id|prom_getintdefault
c_func
(paren
id|ledma-&gt;sdev-&gt;bus-&gt;prom_node
comma
l_string|&quot;burst-sizes&quot;
comma
id|DMA_BURSTBITS
)paren
suffix:semicolon
id|lp-&gt;burst_sizes
op_and_assign
id|sbmask
suffix:semicolon
multiline_comment|/* Get the cable-selection property */
id|memset
c_func
(paren
id|prop
comma
l_int|0
comma
r_sizeof
(paren
id|prop
)paren
)paren
suffix:semicolon
id|prom_getstring
c_func
(paren
id|ledma-&gt;sdev-&gt;prom_node
comma
l_string|&quot;cable-selection&quot;
comma
id|prop
comma
r_sizeof
(paren
id|prop
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|prop
(braket
l_int|0
)braket
op_eq
l_int|0
)paren
(brace
r_int
id|topnd
comma
id|nd
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: using auto-carrier-detection.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
multiline_comment|/* Is this found at /options .attributes in all&n;&t;&t;&t; * Prom versions? XXX&n;&t;&t;&t; */
id|topnd
op_assign
id|prom_getchild
c_func
(paren
id|prom_root_node
)paren
suffix:semicolon
id|nd
op_assign
id|prom_searchsiblings
c_func
(paren
id|topnd
comma
l_string|&quot;options&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|nd
)paren
r_goto
id|no_link_test
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|prom_node_has_property
c_func
(paren
id|nd
comma
l_string|&quot;tpe-link-test?&quot;
)paren
)paren
r_goto
id|no_link_test
suffix:semicolon
id|memset
c_func
(paren
id|prop
comma
l_int|0
comma
r_sizeof
(paren
id|prop
)paren
)paren
suffix:semicolon
id|prom_getstring
c_func
(paren
id|nd
comma
l_string|&quot;tpe-link-test?&quot;
comma
id|prop
comma
r_sizeof
(paren
id|prop
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|strcmp
c_func
(paren
id|prop
comma
l_string|&quot;true&quot;
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;%s: warning: overriding option &quot;
l_string|&quot;&squot;tpe-link-test?&squot;&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;%s: warning: mail any problems &quot;
l_string|&quot;to ecd@skynet.be&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|set_auxio
c_func
(paren
id|AUXIO_LINK_TEST
comma
l_int|0
)paren
suffix:semicolon
)brace
id|no_link_test
suffix:colon
id|lp-&gt;auto_select
op_assign
l_int|1
suffix:semicolon
id|lp-&gt;tpe
op_assign
l_int|0
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
op_logical_neg
id|strcmp
c_func
(paren
id|prop
comma
l_string|&quot;aui&quot;
)paren
)paren
(brace
id|lp-&gt;auto_select
op_assign
l_int|0
suffix:semicolon
id|lp-&gt;tpe
op_assign
l_int|0
suffix:semicolon
)brace
r_else
(brace
id|lp-&gt;auto_select
op_assign
l_int|0
suffix:semicolon
id|lp-&gt;tpe
op_assign
l_int|1
suffix:semicolon
)brace
id|lp-&gt;dregs
op_assign
id|ledma-&gt;regs
suffix:semicolon
multiline_comment|/* Reset ledma */
id|csr
op_assign
id|sbus_readl
c_func
(paren
id|lp-&gt;dregs
op_plus
id|DMA_CSR
)paren
suffix:semicolon
id|sbus_writel
c_func
(paren
id|csr
op_or
id|DMA_RST_ENET
comma
id|lp-&gt;dregs
op_plus
id|DMA_CSR
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|200
)paren
suffix:semicolon
id|sbus_writel
c_func
(paren
id|csr
op_amp
op_complement
id|DMA_RST_ENET
comma
id|lp-&gt;dregs
op_plus
id|DMA_CSR
)paren
suffix:semicolon
)brace
r_else
id|lp-&gt;dregs
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* This should never happen. */
r_if
c_cond
(paren
(paren
r_int
r_int
)paren
(paren
id|lp-&gt;init_block-&gt;brx_ring
)paren
op_amp
l_int|0x07
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: ERROR: Rx and Tx rings not on even boundary.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_goto
id|fail
suffix:semicolon
)brace
id|lp-&gt;dev
op_assign
id|dev
suffix:semicolon
id|dev-&gt;open
op_assign
op_amp
id|lance_open
suffix:semicolon
id|dev-&gt;stop
op_assign
op_amp
id|lance_close
suffix:semicolon
id|dev-&gt;hard_start_xmit
op_assign
op_amp
id|lance_start_xmit
suffix:semicolon
id|dev-&gt;tx_timeout
op_assign
op_amp
id|lance_tx_timeout
suffix:semicolon
id|dev-&gt;watchdog_timeo
op_assign
l_int|5
op_star
id|HZ
suffix:semicolon
id|dev-&gt;get_stats
op_assign
op_amp
id|lance_get_stats
suffix:semicolon
id|dev-&gt;set_multicast_list
op_assign
op_amp
id|lance_set_multicast
suffix:semicolon
id|dev-&gt;irq
op_assign
id|sdev-&gt;irqs
(braket
l_int|0
)braket
suffix:semicolon
id|dev-&gt;dma
op_assign
l_int|0
suffix:semicolon
id|ether_setup
c_func
(paren
id|dev
)paren
suffix:semicolon
multiline_comment|/* We cannot sleep if the chip is busy during a&n;&t; * multicast list update event, because such events&n;&t; * can occur from interrupts (ex. IPv6).  So we&n;&t; * use a timer to try again later when necessary. -DaveM&n;&t; */
id|init_timer
c_func
(paren
op_amp
id|lp-&gt;multicast_timer
)paren
suffix:semicolon
id|lp-&gt;multicast_timer.data
op_assign
(paren
r_int
r_int
)paren
id|dev
suffix:semicolon
id|lp-&gt;multicast_timer.function
op_assign
op_amp
id|lance_set_multicast_retry
suffix:semicolon
id|dev-&gt;ifindex
op_assign
id|dev_new_index
c_func
(paren
)paren
suffix:semicolon
id|lp-&gt;next_module
op_assign
id|root_lance_dev
suffix:semicolon
id|root_lance_dev
op_assign
id|lp
suffix:semicolon
r_return
l_int|0
suffix:semicolon
id|fail
suffix:colon
r_if
c_cond
(paren
id|lp
op_ne
l_int|NULL
)paren
id|lance_free_hwresources
c_func
(paren
id|lp
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
multiline_comment|/* On 4m, find the associated dma for the lance chip */
DECL|function|find_ledma
r_static
r_inline
r_struct
id|sbus_dma
op_star
id|find_ledma
c_func
(paren
r_struct
id|sbus_dev
op_star
id|sdev
)paren
(brace
r_struct
id|sbus_dma
op_star
id|p
suffix:semicolon
id|for_each_dvma
c_func
(paren
id|p
)paren
(brace
r_if
c_cond
(paren
id|p-&gt;sdev
op_eq
id|sdev
)paren
r_return
id|p
suffix:semicolon
)brace
r_return
l_int|NULL
suffix:semicolon
)brace
macro_line|#ifdef CONFIG_SUN4
macro_line|#include &lt;asm/sun4paddr.h&gt;
multiline_comment|/* Find all the lance cards on the system and initialize them */
DECL|function|sparc_lance_probe
r_static
r_int
id|__init
id|sparc_lance_probe
c_func
(paren
r_void
)paren
(brace
r_static
r_struct
id|sbus_dev
id|sdev
suffix:semicolon
r_static
r_int
id|called
op_assign
l_int|0
suffix:semicolon
id|root_lance_dev
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
id|called
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
id|called
op_increment
suffix:semicolon
r_if
c_cond
(paren
(paren
id|idprom-&gt;id_machtype
op_eq
(paren
id|SM_SUN4
op_or
id|SM_4_330
)paren
)paren
op_logical_or
(paren
id|idprom-&gt;id_machtype
op_eq
(paren
id|SM_SUN4
op_or
id|SM_4_470
)paren
)paren
)paren
(brace
id|memset
c_func
(paren
op_amp
id|sdev
comma
l_int|0
comma
r_sizeof
(paren
id|sdev
)paren
)paren
suffix:semicolon
id|sdev.reg_addrs
(braket
l_int|0
)braket
dot
id|phys_addr
op_assign
id|sun4_eth_physaddr
suffix:semicolon
id|sdev.irqs
(braket
l_int|0
)braket
op_assign
l_int|6
suffix:semicolon
r_return
id|sparc_lance_init
c_func
(paren
l_int|NULL
comma
op_amp
id|sdev
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
)brace
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
macro_line|#else /* !CONFIG_SUN4 */
multiline_comment|/* Find all the lance cards on the system and initialize them */
DECL|function|sparc_lance_probe
r_static
r_int
id|__init
id|sparc_lance_probe
c_func
(paren
r_void
)paren
(brace
r_struct
id|sbus_bus
op_star
id|bus
suffix:semicolon
r_struct
id|sbus_dev
op_star
id|sdev
op_assign
l_int|0
suffix:semicolon
r_struct
id|net_device
op_star
id|dev
op_assign
l_int|NULL
suffix:semicolon
r_struct
id|sbus_dma
op_star
id|ledma
op_assign
l_int|0
suffix:semicolon
r_static
r_int
id|called
op_assign
l_int|0
suffix:semicolon
r_int
id|cards
op_assign
l_int|0
comma
id|v
suffix:semicolon
id|root_lance_dev
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
id|called
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
id|called
op_increment
suffix:semicolon
id|for_each_sbus
(paren
id|bus
)paren
(brace
id|for_each_sbusdev
(paren
id|sdev
comma
id|bus
)paren
(brace
r_if
c_cond
(paren
id|cards
)paren
id|dev
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
id|strcmp
c_func
(paren
id|sdev-&gt;prom_name
comma
l_string|&quot;le&quot;
)paren
op_eq
l_int|0
)paren
(brace
id|cards
op_increment
suffix:semicolon
r_if
c_cond
(paren
(paren
id|v
op_assign
id|sparc_lance_init
c_func
(paren
id|dev
comma
id|sdev
comma
l_int|0
comma
l_int|0
)paren
)paren
)paren
r_return
id|v
suffix:semicolon
r_continue
suffix:semicolon
)brace
r_if
c_cond
(paren
id|strcmp
c_func
(paren
id|sdev-&gt;prom_name
comma
l_string|&quot;ledma&quot;
)paren
op_eq
l_int|0
)paren
(brace
id|cards
op_increment
suffix:semicolon
id|ledma
op_assign
id|find_ledma
c_func
(paren
id|sdev
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|v
op_assign
id|sparc_lance_init
c_func
(paren
id|dev
comma
id|sdev-&gt;child
comma
id|ledma
comma
l_int|0
)paren
)paren
)paren
r_return
id|v
suffix:semicolon
r_continue
suffix:semicolon
)brace
r_if
c_cond
(paren
id|strcmp
c_func
(paren
id|sdev-&gt;prom_name
comma
l_string|&quot;lebuffer&quot;
)paren
op_eq
l_int|0
)paren
(brace
id|cards
op_increment
suffix:semicolon
r_if
c_cond
(paren
(paren
id|v
op_assign
id|sparc_lance_init
c_func
(paren
id|dev
comma
id|sdev-&gt;child
comma
l_int|0
comma
id|sdev
)paren
)paren
)paren
r_return
id|v
suffix:semicolon
r_continue
suffix:semicolon
)brace
)brace
multiline_comment|/* for each sbusdev */
)brace
multiline_comment|/* for each sbus */
r_if
c_cond
(paren
op_logical_neg
id|cards
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#endif /* !CONFIG_SUN4 */
DECL|function|sparc_lance_cleanup
r_static
r_void
id|__exit
id|sparc_lance_cleanup
c_func
(paren
r_void
)paren
(brace
r_struct
id|lance_private
op_star
id|lp
suffix:semicolon
r_while
c_loop
(paren
id|root_lance_dev
)paren
(brace
id|lp
op_assign
id|root_lance_dev-&gt;next_module
suffix:semicolon
id|unregister_netdev
c_func
(paren
id|root_lance_dev-&gt;dev
)paren
suffix:semicolon
id|lance_free_hwresources
c_func
(paren
id|root_lance_dev
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|root_lance_dev-&gt;dev
)paren
suffix:semicolon
id|root_lance_dev
op_assign
id|lp
suffix:semicolon
)brace
)brace
DECL|variable|sparc_lance_probe
id|module_init
c_func
(paren
id|sparc_lance_probe
)paren
suffix:semicolon
DECL|variable|sparc_lance_cleanup
id|module_exit
c_func
(paren
id|sparc_lance_cleanup
)paren
suffix:semicolon
eof
