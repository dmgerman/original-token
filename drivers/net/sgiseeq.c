multiline_comment|/* $Id: sgiseeq.c,v 1.17 2000/03/27 23:02:57 ralf Exp $&n; *&n; * sgiseeq.c: Seeq8003 ethernet driver for SGI machines.&n; *&n; * Copyright (C) 1996 David S. Miller (dm@engr.sgi.com)&n; */
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/interrupt.h&gt;
macro_line|#include &lt;linux/ptrace.h&gt;
macro_line|#include &lt;linux/ioport.h&gt;
macro_line|#include &lt;linux/in.h&gt;
macro_line|#include &lt;linux/malloc.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/segment.h&gt;
macro_line|#include &lt;asm/system.h&gt;
macro_line|#include &lt;asm/bitops.h&gt;
macro_line|#include &lt;asm/page.h&gt;
macro_line|#include &lt;asm/pgtable.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;asm/byteorder.h&gt;
macro_line|#include &lt;linux/socket.h&gt;
macro_line|#include &lt;linux/route.h&gt;
macro_line|#include &lt;linux/netdevice.h&gt;
macro_line|#include &lt;linux/etherdevice.h&gt;
macro_line|#include &lt;linux/skbuff.h&gt;
macro_line|#include &lt;asm/sgi/sgihpc.h&gt;
macro_line|#include &lt;asm/sgi/sgint23.h&gt;
macro_line|#include &lt;asm/sgialib.h&gt;
macro_line|#include &quot;sgiseeq.h&quot;
DECL|variable|version
r_static
r_char
op_star
id|version
op_assign
l_string|&quot;sgiseeq.c: David S. Miller (dm@engr.sgi.com)&bslash;n&quot;
suffix:semicolon
DECL|variable|sgiseeqstr
r_static
r_char
op_star
id|sgiseeqstr
op_assign
l_string|&quot;SGI Seeq8003&quot;
suffix:semicolon
multiline_comment|/* If you want speed, you do something silly, it always has worked&n; * for me.  So, with that in mind, I&squot;ve decided to make this driver&n; * look completely like a stupid Lance from a driver architecture&n; * perspective.  Only difference is that here our &quot;ring buffer&quot; looks&n; * and acts like a real Lance one does but is layed out like how the&n; * HPC DMA and the Seeq want it to.  You&squot;d be surprised how a stupid&n; * idea like this can pay off in performance, not to mention making&n; * this driver 2,000 times easier to write. ;-)&n; */
multiline_comment|/* Tune these if we tend to run out often etc. */
DECL|macro|SEEQ_RX_BUFFERS
mdefine_line|#define SEEQ_RX_BUFFERS  16
DECL|macro|SEEQ_TX_BUFFERS
mdefine_line|#define SEEQ_TX_BUFFERS  16
DECL|macro|PKT_BUF_SZ
mdefine_line|#define PKT_BUF_SZ       1584
DECL|macro|NEXT_RX
mdefine_line|#define NEXT_RX(i)  (((i) + 1) &amp; (SEEQ_RX_BUFFERS - 1))
DECL|macro|NEXT_TX
mdefine_line|#define NEXT_TX(i)  (((i) + 1) &amp; (SEEQ_TX_BUFFERS - 1))
DECL|macro|PREV_RX
mdefine_line|#define PREV_RX(i)  (((i) - 1) &amp; (SEEQ_RX_BUFFERS - 1))
DECL|macro|PREV_TX
mdefine_line|#define PREV_TX(i)  (((i) - 1) &amp; (SEEQ_TX_BUFFERS - 1))
DECL|macro|TX_BUFFS_AVAIL
mdefine_line|#define TX_BUFFS_AVAIL(sp) ((sp-&gt;tx_old &lt;= sp-&gt;tx_new) ? &bslash;&n;&t;&t;&t;    sp-&gt;tx_old + (SEEQ_TX_BUFFERS - 1) - sp-&gt;tx_new : &bslash;&n;&t;&t;&t;    sp-&gt;tx_old - sp-&gt;tx_new - 1)
DECL|macro|DEBUG
mdefine_line|#define DEBUG
DECL|struct|sgiseeq_rx_desc
r_struct
id|sgiseeq_rx_desc
(brace
DECL|member|rdma
r_struct
id|hpc_dma_desc
id|rdma
suffix:semicolon
DECL|member|buf_vaddr
r_int
r_int
id|buf_vaddr
suffix:semicolon
)brace
suffix:semicolon
DECL|struct|sgiseeq_tx_desc
r_struct
id|sgiseeq_tx_desc
(brace
DECL|member|tdma
r_struct
id|hpc_dma_desc
id|tdma
suffix:semicolon
DECL|member|buf_vaddr
r_int
r_int
id|buf_vaddr
suffix:semicolon
)brace
suffix:semicolon
multiline_comment|/* Warning: This structure is layed out in a certain way because&n; *          HPC dma descriptors must be 8-byte aligned.  So don&squot;t&n; *          touch this without some care.&n; */
DECL|struct|sgiseeq_init_block
r_struct
id|sgiseeq_init_block
(brace
multiline_comment|/* Note the name ;-) */
multiline_comment|/* Ptrs to the descriptors in KSEG1 uncached space. */
DECL|member|rx_desc
r_struct
id|sgiseeq_rx_desc
op_star
id|rx_desc
suffix:semicolon
DECL|member|tx_desc
r_struct
id|sgiseeq_tx_desc
op_star
id|tx_desc
suffix:semicolon
DECL|member|_padding
r_int
r_int
id|_padding
(braket
l_int|30
)braket
suffix:semicolon
multiline_comment|/* Pad out to largest cache line size. */
DECL|member|rxvector
r_struct
id|sgiseeq_rx_desc
id|rxvector
(braket
id|SEEQ_RX_BUFFERS
)braket
suffix:semicolon
DECL|member|txvector
r_struct
id|sgiseeq_tx_desc
id|txvector
(braket
id|SEEQ_TX_BUFFERS
)braket
suffix:semicolon
)brace
suffix:semicolon
DECL|struct|sgiseeq_private
r_struct
id|sgiseeq_private
(brace
DECL|member|srings
r_volatile
r_struct
id|sgiseeq_init_block
id|srings
suffix:semicolon
DECL|member|name
r_char
op_star
id|name
suffix:semicolon
DECL|member|hregs
r_volatile
r_struct
id|hpc3_ethregs
op_star
id|hregs
suffix:semicolon
DECL|member|sregs
r_volatile
r_struct
id|sgiseeq_regs
op_star
id|sregs
suffix:semicolon
multiline_comment|/* Ring entry counters. */
DECL|member|rx_new
DECL|member|tx_new
r_int
r_int
id|rx_new
comma
id|tx_new
suffix:semicolon
DECL|member|rx_old
DECL|member|tx_old
r_int
r_int
id|rx_old
comma
id|tx_old
suffix:semicolon
DECL|member|is_edlc
r_int
id|is_edlc
suffix:semicolon
DECL|member|control
r_int
r_char
id|control
suffix:semicolon
DECL|member|mode
r_int
r_char
id|mode
suffix:semicolon
DECL|member|stats
r_struct
id|net_device_stats
id|stats
suffix:semicolon
)brace
suffix:semicolon
DECL|function|hpc3_eth_reset
r_static
r_inline
r_void
id|hpc3_eth_reset
c_func
(paren
r_volatile
r_struct
id|hpc3_ethregs
op_star
id|hregs
)paren
(brace
id|hregs-&gt;rx_reset
op_assign
(paren
id|HPC3_ERXRST_CRESET
op_or
id|HPC3_ERXRST_CLRIRQ
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|20
)paren
suffix:semicolon
id|hregs-&gt;rx_reset
op_assign
l_int|0
suffix:semicolon
)brace
DECL|function|reset_hpc3_and_seeq
r_static
r_inline
r_void
id|reset_hpc3_and_seeq
c_func
(paren
r_volatile
r_struct
id|hpc3_ethregs
op_star
id|hregs
comma
r_volatile
r_struct
id|sgiseeq_regs
op_star
id|sregs
)paren
(brace
id|hregs-&gt;rx_ctrl
op_assign
id|hregs-&gt;tx_ctrl
op_assign
l_int|0
suffix:semicolon
id|hpc3_eth_reset
c_func
(paren
id|hregs
)paren
suffix:semicolon
)brace
DECL|macro|RSTAT_GO_BITS
mdefine_line|#define RSTAT_GO_BITS (SEEQ_RCMD_IGOOD | SEEQ_RCMD_IEOF | SEEQ_RCMD_ISHORT | &bslash;&n;&t;&t;       SEEQ_RCMD_IDRIB | SEEQ_RCMD_ICRC)
DECL|function|seeq_go
r_static
r_inline
r_void
id|seeq_go
c_func
(paren
r_struct
id|sgiseeq_private
op_star
id|sp
comma
r_volatile
r_struct
id|hpc3_ethregs
op_star
id|hregs
comma
r_volatile
r_struct
id|sgiseeq_regs
op_star
id|sregs
)paren
(brace
id|sregs-&gt;rstat
op_assign
id|sp-&gt;mode
op_or
id|RSTAT_GO_BITS
suffix:semicolon
id|hregs-&gt;rx_ctrl
op_assign
id|HPC3_ERXCTRL_ACTIVE
suffix:semicolon
)brace
DECL|function|seeq_load_eaddr
r_static
r_inline
r_void
id|seeq_load_eaddr
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_volatile
r_struct
id|sgiseeq_regs
op_star
id|sregs
)paren
(brace
r_int
id|i
suffix:semicolon
id|sregs-&gt;tstat
op_assign
id|SEEQ_TCMD_RB0
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|6
suffix:semicolon
id|i
op_increment
)paren
id|sregs-&gt;rw.eth_addr
(braket
id|i
)braket
op_assign
id|dev-&gt;dev_addr
(braket
id|i
)braket
suffix:semicolon
)brace
DECL|macro|TCNTINFO_INIT
mdefine_line|#define TCNTINFO_INIT (HPCDMA_EOX | HPCDMA_ETXD)
DECL|macro|RCNTCFG_INIT
mdefine_line|#define RCNTCFG_INIT  (HPCDMA_OWN | HPCDMA_EORP | HPCDMA_XIE)
DECL|macro|RCNTINFO_INIT
mdefine_line|#define RCNTINFO_INIT (RCNTCFG_INIT | (PKT_BUF_SZ &amp; HPCDMA_BCNT))
DECL|function|seeq_init_ring
r_static
r_void
id|seeq_init_ring
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|sgiseeq_private
op_star
id|sp
op_assign
(paren
r_struct
id|sgiseeq_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_volatile
r_struct
id|sgiseeq_init_block
op_star
id|ib
op_assign
op_amp
id|sp-&gt;srings
suffix:semicolon
r_int
id|i
suffix:semicolon
id|netif_stop_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
id|sp-&gt;rx_new
op_assign
id|sp-&gt;tx_new
op_assign
l_int|0
suffix:semicolon
id|sp-&gt;rx_old
op_assign
id|sp-&gt;tx_old
op_assign
l_int|0
suffix:semicolon
id|seeq_load_eaddr
c_func
(paren
id|dev
comma
id|sp-&gt;sregs
)paren
suffix:semicolon
multiline_comment|/* XXX for now just accept packets directly to us&n;&t; * XXX and ether-broadcast.  Will do multicast and&n;&t; * XXX promiscuous mode later. -davem&n;&t; */
id|sp-&gt;mode
op_assign
id|SEEQ_RCMD_RBCAST
suffix:semicolon
multiline_comment|/* Setup tx ring. */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|SEEQ_TX_BUFFERS
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|ib-&gt;tx_desc
(braket
id|i
)braket
dot
id|tdma.pbuf
)paren
(brace
r_int
r_int
id|buffer
suffix:semicolon
id|buffer
op_assign
(paren
r_int
r_int
)paren
id|kmalloc
c_func
(paren
id|PKT_BUF_SZ
comma
id|GFP_KERNEL
)paren
suffix:semicolon
id|ib-&gt;tx_desc
(braket
id|i
)braket
dot
id|buf_vaddr
op_assign
id|KSEG1ADDR
c_func
(paren
id|buffer
)paren
suffix:semicolon
id|ib-&gt;tx_desc
(braket
id|i
)braket
dot
id|tdma.pbuf
op_assign
id|PHYSADDR
c_func
(paren
id|buffer
)paren
suffix:semicolon
singleline_comment|//&t;&t;&t;flush_cache_all();
)brace
id|ib-&gt;tx_desc
(braket
id|i
)braket
dot
id|tdma.cntinfo
op_assign
(paren
id|TCNTINFO_INIT
)paren
suffix:semicolon
)brace
multiline_comment|/* And now the rx ring. */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|SEEQ_RX_BUFFERS
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|ib-&gt;rx_desc
(braket
id|i
)braket
dot
id|rdma.pbuf
)paren
(brace
r_int
r_int
id|buffer
suffix:semicolon
id|buffer
op_assign
(paren
r_int
r_int
)paren
id|kmalloc
c_func
(paren
id|PKT_BUF_SZ
comma
id|GFP_KERNEL
)paren
suffix:semicolon
id|ib-&gt;rx_desc
(braket
id|i
)braket
dot
id|buf_vaddr
op_assign
id|KSEG1ADDR
c_func
(paren
id|buffer
)paren
suffix:semicolon
id|ib-&gt;rx_desc
(braket
id|i
)braket
dot
id|rdma.pbuf
op_assign
id|PHYSADDR
c_func
(paren
id|buffer
)paren
suffix:semicolon
singleline_comment|//&t;&t;&t;flush_cache_all();
)brace
id|ib-&gt;rx_desc
(braket
id|i
)braket
dot
id|rdma.cntinfo
op_assign
(paren
id|RCNTINFO_INIT
)paren
suffix:semicolon
)brace
id|ib-&gt;rx_desc
(braket
id|i
op_minus
l_int|1
)braket
dot
id|rdma.cntinfo
op_or_assign
(paren
id|HPCDMA_EOR
)paren
suffix:semicolon
)brace
macro_line|#ifdef DEBUG
DECL|variable|gpriv
r_static
r_struct
id|sgiseeq_private
op_star
id|gpriv
suffix:semicolon
DECL|variable|gdev
r_static
r_struct
id|net_device
op_star
id|gdev
suffix:semicolon
DECL|function|sgiseeq_dump_rings
r_void
id|sgiseeq_dump_rings
c_func
(paren
r_void
)paren
(brace
r_static
r_int
id|once
op_assign
l_int|0
suffix:semicolon
r_struct
id|sgiseeq_rx_desc
op_star
id|r
op_assign
id|gpriv-&gt;srings.rx_desc
suffix:semicolon
r_struct
id|sgiseeq_tx_desc
op_star
id|t
op_assign
id|gpriv-&gt;srings.tx_desc
suffix:semicolon
r_volatile
r_struct
id|hpc3_ethregs
op_star
id|hregs
op_assign
id|gpriv-&gt;hregs
suffix:semicolon
r_int
id|i
suffix:semicolon
r_if
c_cond
(paren
id|once
)paren
(brace
r_return
suffix:semicolon
)brace
id|once
op_increment
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;RING DUMP:&bslash;n&quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|SEEQ_RX_BUFFERS
suffix:semicolon
id|i
op_increment
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;RX [%d]: @(%p) [%08x,%08x,%08x] &quot;
comma
id|i
comma
(paren
op_amp
id|r
(braket
id|i
)braket
)paren
comma
id|r
(braket
id|i
)braket
dot
id|rdma.pbuf
comma
id|r
(braket
id|i
)braket
dot
id|rdma.cntinfo
comma
id|r
(braket
id|i
)braket
dot
id|rdma.pnext
)paren
suffix:semicolon
id|i
op_add_assign
l_int|1
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;-- [%d]: @(%p) [%08x,%08x,%08x]&bslash;n&quot;
comma
id|i
comma
(paren
op_amp
id|r
(braket
id|i
)braket
)paren
comma
id|r
(braket
id|i
)braket
dot
id|rdma.pbuf
comma
id|r
(braket
id|i
)braket
dot
id|rdma.cntinfo
comma
id|r
(braket
id|i
)braket
dot
id|rdma.pnext
)paren
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|SEEQ_TX_BUFFERS
suffix:semicolon
id|i
op_increment
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;TX [%d]: @(%p) [%08x,%08x,%08x] &quot;
comma
id|i
comma
(paren
op_amp
id|t
(braket
id|i
)braket
)paren
comma
id|t
(braket
id|i
)braket
dot
id|tdma.pbuf
comma
id|t
(braket
id|i
)braket
dot
id|tdma.cntinfo
comma
id|t
(braket
id|i
)braket
dot
id|tdma.pnext
)paren
suffix:semicolon
id|i
op_add_assign
l_int|1
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;-- [%d]: @(%p) [%08x,%08x,%08x]&bslash;n&quot;
comma
id|i
comma
(paren
op_amp
id|t
(braket
id|i
)braket
)paren
comma
id|t
(braket
id|i
)braket
dot
id|tdma.pbuf
comma
id|t
(braket
id|i
)braket
dot
id|tdma.cntinfo
comma
id|t
(braket
id|i
)braket
dot
id|tdma.pnext
)paren
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;INFO: [rx_new = %d rx_old=%d] [tx_new = %d tx_old = %d]&bslash;n&quot;
comma
id|gpriv-&gt;rx_new
comma
id|gpriv-&gt;rx_old
comma
id|gpriv-&gt;tx_new
comma
id|gpriv-&gt;tx_old
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;RREGS: rx_cbptr[%08x] rx_ndptr[%08x] rx_ctrl[%08x]&bslash;n&quot;
comma
id|hregs-&gt;rx_cbptr
comma
id|hregs-&gt;rx_ndptr
comma
id|hregs-&gt;rx_ctrl
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;TREGS: tx_cbptr[%08x] tx_ndptr[%08x] tx_ctrl[%08x]&bslash;n&quot;
comma
id|hregs-&gt;tx_cbptr
comma
id|hregs-&gt;tx_ndptr
comma
id|hregs-&gt;tx_ctrl
)paren
suffix:semicolon
)brace
macro_line|#endif
DECL|macro|TSTAT_INIT_SEEQ
mdefine_line|#define TSTAT_INIT_SEEQ (SEEQ_TCMD_IPT|SEEQ_TCMD_I16|SEEQ_TCMD_IC|SEEQ_TCMD_IUF)
DECL|macro|TSTAT_INIT_EDLC
mdefine_line|#define TSTAT_INIT_EDLC ((TSTAT_INIT_SEEQ) | SEEQ_TCMD_RB2)
DECL|macro|RDMACFG_INIT
mdefine_line|#define RDMACFG_INIT    (HPC3_ERXDCFG_FRXDC | HPC3_ERXDCFG_FEOP | HPC3_ERXDCFG_FIRQ)
DECL|function|init_seeq
r_static
r_void
id|init_seeq
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_struct
id|sgiseeq_private
op_star
id|sp
comma
r_volatile
r_struct
id|sgiseeq_regs
op_star
id|sregs
)paren
(brace
r_volatile
r_struct
id|hpc3_ethregs
op_star
id|hregs
op_assign
id|sp-&gt;hregs
suffix:semicolon
id|reset_hpc3_and_seeq
c_func
(paren
id|hregs
comma
id|sregs
)paren
suffix:semicolon
id|seeq_init_ring
c_func
(paren
id|dev
)paren
suffix:semicolon
multiline_comment|/* Setup to field the proper interrupt types. */
r_if
c_cond
(paren
id|sp-&gt;is_edlc
)paren
(brace
id|sregs-&gt;tstat
op_assign
(paren
id|TSTAT_INIT_EDLC
)paren
suffix:semicolon
id|sregs-&gt;rw.wregs.control
op_assign
id|sp-&gt;control
suffix:semicolon
id|sregs-&gt;rw.wregs.frame_gap
op_assign
l_int|0
suffix:semicolon
)brace
r_else
(brace
id|sregs-&gt;tstat
op_assign
(paren
id|TSTAT_INIT_SEEQ
)paren
suffix:semicolon
)brace
id|hregs-&gt;rx_dconfig
op_or_assign
id|RDMACFG_INIT
suffix:semicolon
id|hregs-&gt;rx_ndptr
op_assign
id|PHYSADDR
c_func
(paren
op_amp
id|sp-&gt;srings.rx_desc
(braket
l_int|0
)braket
)paren
suffix:semicolon
id|hregs-&gt;tx_ndptr
op_assign
id|PHYSADDR
c_func
(paren
op_amp
id|sp-&gt;srings.tx_desc
(braket
l_int|0
)braket
)paren
suffix:semicolon
id|seeq_go
c_func
(paren
id|sp
comma
id|hregs
comma
id|sregs
)paren
suffix:semicolon
)brace
DECL|function|record_rx_errors
r_static
r_inline
r_void
id|record_rx_errors
c_func
(paren
r_struct
id|sgiseeq_private
op_star
id|sp
comma
r_int
r_char
id|status
)paren
(brace
r_if
c_cond
(paren
id|status
op_amp
id|SEEQ_RSTAT_OVERF
op_logical_or
id|status
op_amp
id|SEEQ_RSTAT_SFRAME
)paren
id|sp-&gt;stats.rx_over_errors
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
id|SEEQ_RSTAT_CERROR
)paren
id|sp-&gt;stats.rx_crc_errors
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
id|SEEQ_RSTAT_DERROR
)paren
id|sp-&gt;stats.rx_frame_errors
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
id|SEEQ_RSTAT_REOF
)paren
id|sp-&gt;stats.rx_errors
op_increment
suffix:semicolon
)brace
DECL|function|rx_maybe_restart
r_static
r_inline
r_void
id|rx_maybe_restart
c_func
(paren
r_struct
id|sgiseeq_private
op_star
id|sp
comma
r_volatile
r_struct
id|hpc3_ethregs
op_star
id|hregs
comma
r_volatile
r_struct
id|sgiseeq_regs
op_star
id|sregs
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|hregs-&gt;rx_ctrl
op_amp
id|HPC3_ERXCTRL_ACTIVE
)paren
)paren
(brace
id|hregs-&gt;rx_ndptr
op_assign
id|PHYSADDR
c_func
(paren
op_amp
id|sp-&gt;srings.rx_desc
(braket
id|sp-&gt;rx_new
)braket
)paren
suffix:semicolon
id|seeq_go
c_func
(paren
id|sp
comma
id|hregs
comma
id|sregs
)paren
suffix:semicolon
)brace
)brace
DECL|macro|for_each_rx
mdefine_line|#define for_each_rx(rd, sp) for((rd) = &amp;(sp)-&gt;srings.rx_desc[(sp)-&gt;rx_new]; &bslash;&n;&t;&t;&t;&t;!((rd)-&gt;rdma.cntinfo &amp; HPCDMA_OWN); &bslash;&n;&t;&t;&t;&t;(rd) = &amp;(sp)-&gt;srings.rx_desc[(sp)-&gt;rx_new])
DECL|function|sgiseeq_rx
r_static
r_inline
r_void
id|sgiseeq_rx
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_struct
id|sgiseeq_private
op_star
id|sp
comma
r_volatile
r_struct
id|hpc3_ethregs
op_star
id|hregs
comma
r_volatile
r_struct
id|sgiseeq_regs
op_star
id|sregs
)paren
(brace
r_struct
id|sgiseeq_rx_desc
op_star
id|rd
suffix:semicolon
r_struct
id|sk_buff
op_star
id|skb
op_assign
l_int|0
suffix:semicolon
r_int
r_char
id|pkt_status
suffix:semicolon
r_int
r_char
op_star
id|pkt_pointer
op_assign
l_int|0
suffix:semicolon
r_int
id|len
op_assign
l_int|0
suffix:semicolon
r_int
r_int
id|orig_end
op_assign
id|PREV_RX
c_func
(paren
id|sp-&gt;rx_new
)paren
suffix:semicolon
multiline_comment|/* Service every received packet. */
id|for_each_rx
c_func
(paren
id|rd
comma
id|sp
)paren
(brace
id|len
op_assign
(paren
id|PKT_BUF_SZ
op_minus
(paren
id|rd-&gt;rdma.cntinfo
op_amp
id|HPCDMA_BCNT
)paren
op_minus
l_int|3
)paren
suffix:semicolon
id|pkt_pointer
op_assign
(paren
r_int
r_char
op_star
)paren
(paren
r_int
)paren
id|rd-&gt;buf_vaddr
suffix:semicolon
id|pkt_status
op_assign
id|pkt_pointer
(braket
id|len
op_plus
l_int|2
)braket
suffix:semicolon
r_if
c_cond
(paren
id|pkt_status
op_amp
id|SEEQ_RSTAT_FIG
)paren
(brace
multiline_comment|/* Packet is OK. */
id|skb
op_assign
id|dev_alloc_skb
c_func
(paren
id|len
op_plus
l_int|2
)paren
suffix:semicolon
r_if
c_cond
(paren
id|skb
)paren
(brace
id|skb-&gt;dev
op_assign
id|dev
suffix:semicolon
id|skb_reserve
c_func
(paren
id|skb
comma
l_int|2
)paren
suffix:semicolon
id|skb_put
c_func
(paren
id|skb
comma
id|len
)paren
suffix:semicolon
multiline_comment|/* Copy out of kseg1 to avoid silly cache flush. */
id|eth_copy_and_sum
c_func
(paren
id|skb
comma
id|pkt_pointer
op_plus
l_int|2
comma
id|len
comma
l_int|0
)paren
suffix:semicolon
id|skb-&gt;protocol
op_assign
id|eth_type_trans
c_func
(paren
id|skb
comma
id|dev
)paren
suffix:semicolon
id|netif_rx
c_func
(paren
id|skb
)paren
suffix:semicolon
id|sp-&gt;stats.rx_packets
op_increment
suffix:semicolon
id|sp-&gt;stats.rx_bytes
op_add_assign
id|len
suffix:semicolon
)brace
r_else
(brace
id|printk
(paren
l_string|&quot;%s: Memory squeeze, deferring packet.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|sp-&gt;stats.rx_dropped
op_increment
suffix:semicolon
)brace
)brace
r_else
(brace
id|record_rx_errors
c_func
(paren
id|sp
comma
id|pkt_status
)paren
suffix:semicolon
)brace
multiline_comment|/* Return the entry to the ring pool. */
id|rd-&gt;rdma.cntinfo
op_assign
(paren
id|RCNTINFO_INIT
)paren
suffix:semicolon
id|sp-&gt;rx_new
op_assign
id|NEXT_RX
c_func
(paren
id|sp-&gt;rx_new
)paren
suffix:semicolon
)brace
id|sp-&gt;srings.rx_desc
(braket
id|orig_end
)braket
dot
id|rdma.cntinfo
op_and_assign
op_complement
(paren
id|HPCDMA_EOR
)paren
suffix:semicolon
id|sp-&gt;srings.rx_desc
(braket
id|PREV_RX
c_func
(paren
id|sp-&gt;rx_new
)paren
)braket
dot
id|rdma.cntinfo
op_or_assign
id|HPCDMA_EOR
suffix:semicolon
id|rx_maybe_restart
c_func
(paren
id|sp
comma
id|hregs
comma
id|sregs
)paren
suffix:semicolon
)brace
DECL|function|tx_maybe_reset_collisions
r_static
r_inline
r_void
id|tx_maybe_reset_collisions
c_func
(paren
r_struct
id|sgiseeq_private
op_star
id|sp
comma
r_volatile
r_struct
id|sgiseeq_regs
op_star
id|sregs
)paren
(brace
r_if
c_cond
(paren
id|sp-&gt;is_edlc
)paren
(brace
id|sregs-&gt;rw.wregs.control
op_assign
id|sp-&gt;control
op_amp
op_complement
(paren
id|SEEQ_CTRL_XCNT
)paren
suffix:semicolon
id|sregs-&gt;rw.wregs.control
op_assign
id|sp-&gt;control
suffix:semicolon
)brace
)brace
DECL|function|kick_tx
r_static
r_inline
r_void
id|kick_tx
c_func
(paren
r_struct
id|sgiseeq_tx_desc
op_star
id|td
comma
r_volatile
r_struct
id|hpc3_ethregs
op_star
id|hregs
)paren
(brace
multiline_comment|/* If the HPC aint doin nothin, and there are more packets&n;&t; * with ETXD cleared and XIU set we must make very certain&n;&t; * that we restart the HPC else we risk locking up the&n;&t; * adapter.  The following code is only safe iff the HPCDMA&n;&t; * is not active!&n;&t; */
r_while
c_loop
(paren
(paren
id|td-&gt;tdma.cntinfo
op_amp
(paren
id|HPCDMA_XIU
op_or
id|HPCDMA_ETXD
)paren
)paren
op_eq
(paren
id|HPCDMA_XIU
op_or
id|HPCDMA_ETXD
)paren
)paren
id|td
op_assign
(paren
r_struct
id|sgiseeq_tx_desc
op_star
)paren
(paren
r_int
)paren
id|KSEG1ADDR
c_func
(paren
id|td-&gt;tdma.pnext
)paren
suffix:semicolon
r_if
c_cond
(paren
id|td-&gt;tdma.cntinfo
op_amp
id|HPCDMA_XIU
)paren
(brace
id|hregs-&gt;tx_ndptr
op_assign
id|PHYSADDR
c_func
(paren
id|td
)paren
suffix:semicolon
id|hregs-&gt;tx_ctrl
op_assign
id|HPC3_ETXCTRL_ACTIVE
suffix:semicolon
)brace
)brace
DECL|function|sgiseeq_tx
r_static
r_inline
r_void
id|sgiseeq_tx
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_struct
id|sgiseeq_private
op_star
id|sp
comma
r_volatile
r_struct
id|hpc3_ethregs
op_star
id|hregs
comma
r_volatile
r_struct
id|sgiseeq_regs
op_star
id|sregs
)paren
(brace
r_struct
id|sgiseeq_tx_desc
op_star
id|td
suffix:semicolon
r_int
r_int
id|status
op_assign
id|hregs-&gt;tx_ctrl
suffix:semicolon
r_int
id|j
suffix:semicolon
id|tx_maybe_reset_collisions
c_func
(paren
id|sp
comma
id|sregs
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|status
op_amp
(paren
id|HPC3_ETXCTRL_ACTIVE
op_or
id|SEEQ_TSTAT_PTRANS
)paren
)paren
)paren
(brace
multiline_comment|/* Oops, HPC detected some sort of error. */
r_if
c_cond
(paren
id|status
op_amp
id|SEEQ_TSTAT_R16
)paren
id|sp-&gt;stats.tx_aborted_errors
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
id|SEEQ_TSTAT_UFLOW
)paren
id|sp-&gt;stats.tx_fifo_errors
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
id|SEEQ_TSTAT_LCLS
)paren
id|sp-&gt;stats.collisions
op_increment
suffix:semicolon
)brace
multiline_comment|/* Ack &squot;em... */
r_for
c_loop
(paren
id|j
op_assign
id|sp-&gt;tx_old
suffix:semicolon
id|j
op_ne
id|sp-&gt;tx_new
suffix:semicolon
id|j
op_assign
id|NEXT_TX
c_func
(paren
id|j
)paren
)paren
(brace
id|td
op_assign
op_amp
id|sp-&gt;srings.tx_desc
(braket
id|j
)braket
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|td-&gt;tdma.cntinfo
op_amp
(paren
id|HPCDMA_XIU
)paren
)paren
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|td-&gt;tdma.cntinfo
op_amp
(paren
id|HPCDMA_ETXD
)paren
)paren
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|status
op_amp
id|HPC3_ETXCTRL_ACTIVE
)paren
)paren
(brace
id|hregs-&gt;tx_ndptr
op_assign
id|PHYSADDR
c_func
(paren
id|td
)paren
suffix:semicolon
id|hregs-&gt;tx_ctrl
op_assign
id|HPC3_ETXCTRL_ACTIVE
suffix:semicolon
)brace
r_break
suffix:semicolon
)brace
id|sp-&gt;stats.tx_packets
op_increment
suffix:semicolon
id|sp-&gt;tx_old
op_assign
id|NEXT_TX
c_func
(paren
id|sp-&gt;tx_old
)paren
suffix:semicolon
id|td-&gt;tdma.cntinfo
op_and_assign
op_complement
(paren
id|HPCDMA_XIU
op_or
id|HPCDMA_XIE
)paren
suffix:semicolon
id|td-&gt;tdma.cntinfo
op_or_assign
id|HPCDMA_EOX
suffix:semicolon
)brace
)brace
DECL|function|sgiseeq_interrupt
r_static
r_void
id|sgiseeq_interrupt
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_struct
id|net_device
op_star
id|dev
op_assign
(paren
r_struct
id|net_device
op_star
)paren
id|dev_id
suffix:semicolon
r_struct
id|sgiseeq_private
op_star
id|sp
op_assign
(paren
r_struct
id|sgiseeq_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_volatile
r_struct
id|hpc3_ethregs
op_star
id|hregs
op_assign
id|sp-&gt;hregs
suffix:semicolon
r_volatile
r_struct
id|sgiseeq_regs
op_star
id|sregs
op_assign
id|sp-&gt;sregs
suffix:semicolon
multiline_comment|/* Ack the IRQ and set software state. */
id|hregs-&gt;rx_reset
op_assign
id|HPC3_ERXRST_CLRIRQ
suffix:semicolon
multiline_comment|/* Always check for received packets. */
id|sgiseeq_rx
c_func
(paren
id|dev
comma
id|sp
comma
id|hregs
comma
id|sregs
)paren
suffix:semicolon
multiline_comment|/* Only check for tx acks iff we have something queued. */
r_if
c_cond
(paren
id|sp-&gt;tx_old
op_ne
id|sp-&gt;tx_new
)paren
id|sgiseeq_tx
c_func
(paren
id|dev
comma
id|sp
comma
id|hregs
comma
id|sregs
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|TX_BUFFS_AVAIL
c_func
(paren
id|sp
)paren
OG
l_int|0
)paren
op_logical_and
id|netif_queue_stopped
c_func
(paren
id|dev
)paren
)paren
(brace
id|netif_wake_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
)brace
DECL|function|sgiseeq_open
r_static
r_int
id|sgiseeq_open
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|sgiseeq_private
op_star
id|sp
op_assign
(paren
r_struct
id|sgiseeq_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_volatile
r_struct
id|sgiseeq_regs
op_star
id|sregs
op_assign
id|sp-&gt;sregs
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|request_irq
c_func
(paren
id|dev-&gt;irq
comma
id|sgiseeq_interrupt
comma
l_int|0
comma
id|sgiseeqstr
comma
(paren
r_void
op_star
)paren
id|dev
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;Seeq8003: Can&squot;t get irq %d&bslash;n&quot;
comma
id|dev-&gt;irq
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
op_minus
id|EAGAIN
suffix:semicolon
)brace
id|init_seeq
c_func
(paren
id|dev
comma
id|sp
comma
id|sregs
)paren
suffix:semicolon
id|netif_start_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|sgiseeq_close
r_static
r_int
id|sgiseeq_close
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|sgiseeq_private
op_star
id|sp
op_assign
(paren
r_struct
id|sgiseeq_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_volatile
r_struct
id|sgiseeq_regs
op_star
id|sregs
op_assign
id|sp-&gt;sregs
suffix:semicolon
id|netif_stop_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
multiline_comment|/* Shutdown the Seeq. */
id|reset_hpc3_and_seeq
c_func
(paren
id|sp-&gt;hregs
comma
id|sregs
)paren
suffix:semicolon
id|free_irq
c_func
(paren
id|dev-&gt;irq
comma
id|dev
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|sgiseeq_reset
r_static
r_inline
r_int
id|sgiseeq_reset
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|sgiseeq_private
op_star
id|sp
op_assign
(paren
r_struct
id|sgiseeq_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_volatile
r_struct
id|sgiseeq_regs
op_star
id|sregs
op_assign
id|sp-&gt;sregs
suffix:semicolon
id|init_seeq
c_func
(paren
id|dev
comma
id|sp
comma
id|sregs
)paren
suffix:semicolon
id|dev-&gt;trans_start
op_assign
id|jiffies
suffix:semicolon
id|netif_wake_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|sgiseeq_my_reset
r_void
id|sgiseeq_my_reset
c_func
(paren
r_void
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;RESET!&bslash;n&quot;
)paren
suffix:semicolon
id|sgiseeq_reset
c_func
(paren
id|gdev
)paren
suffix:semicolon
)brace
DECL|function|sgiseeq_start_xmit
r_static
r_int
id|sgiseeq_start_xmit
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|sgiseeq_private
op_star
id|sp
op_assign
(paren
r_struct
id|sgiseeq_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_volatile
r_struct
id|hpc3_ethregs
op_star
id|hregs
op_assign
id|sp-&gt;hregs
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_struct
id|sgiseeq_tx_desc
op_star
id|td
suffix:semicolon
r_int
id|skblen
comma
id|len
comma
id|entry
suffix:semicolon
id|save_and_cli
c_func
(paren
id|flags
)paren
suffix:semicolon
multiline_comment|/* Setup... */
id|skblen
op_assign
id|skb-&gt;len
suffix:semicolon
id|len
op_assign
(paren
id|skblen
op_le
id|ETH_ZLEN
)paren
ques
c_cond
id|ETH_ZLEN
suffix:colon
id|skblen
suffix:semicolon
id|sp-&gt;stats.tx_bytes
op_add_assign
id|len
suffix:semicolon
id|entry
op_assign
id|sp-&gt;tx_new
suffix:semicolon
id|td
op_assign
op_amp
id|sp-&gt;srings.tx_desc
(braket
id|entry
)braket
suffix:semicolon
multiline_comment|/* Create entry.  There are so many races with adding a new&n;&t; * descriptor to the chain:&n;&t; * 1) Assume that the HPC is off processing a DMA chain while&n;&t; *    we are changing all of the following.&n;&t; * 2) Do no allow the HPC to look at a new descriptor until&n;&t; *    we have completely set up it&squot;s state.  This means, do&n;&t; *    not clear HPCDMA_EOX in the current last descritptor&n;&t; *    until the one we are adding looks consistant and could&n;&t; *    be processes right now.&n;&t; * 3) The tx interrupt code must notice when we&squot;ve added a new&n;&t; *    entry and the HPC got to the end of the chain before we&n;&t; *    added this new entry and restarted it.&n;&t; */
id|memcpy
c_func
(paren
(paren
r_char
op_star
)paren
(paren
r_int
)paren
id|td-&gt;buf_vaddr
comma
id|skb-&gt;data
comma
id|skblen
)paren
suffix:semicolon
id|td-&gt;tdma.cntinfo
op_assign
(paren
id|len
op_amp
id|HPCDMA_BCNT
)paren
op_or
(paren
id|HPCDMA_XIU
op_or
id|HPCDMA_EOXP
op_or
id|HPCDMA_XIE
op_or
id|HPCDMA_EOX
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sp-&gt;tx_old
op_ne
id|sp-&gt;tx_new
)paren
(brace
r_struct
id|sgiseeq_tx_desc
op_star
id|backend
suffix:semicolon
id|backend
op_assign
op_amp
id|sp-&gt;srings.tx_desc
(braket
id|PREV_TX
c_func
(paren
id|sp-&gt;tx_new
)paren
)braket
suffix:semicolon
id|backend-&gt;tdma.cntinfo
op_and_assign
op_complement
(paren
id|HPCDMA_EOX
)paren
suffix:semicolon
)brace
id|sp-&gt;tx_new
op_assign
id|NEXT_TX
c_func
(paren
id|sp-&gt;tx_new
)paren
suffix:semicolon
multiline_comment|/* Advance. */
multiline_comment|/* Maybe kick the HPC back into motion. */
r_if
c_cond
(paren
op_logical_neg
(paren
id|hregs-&gt;tx_ctrl
op_amp
id|HPC3_ETXCTRL_ACTIVE
)paren
)paren
id|kick_tx
c_func
(paren
op_amp
id|sp-&gt;srings.tx_desc
(braket
id|sp-&gt;tx_old
)braket
comma
id|hregs
)paren
suffix:semicolon
id|dev-&gt;trans_start
op_assign
id|jiffies
suffix:semicolon
id|dev_kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|TX_BUFFS_AVAIL
c_func
(paren
id|sp
)paren
)paren
id|netif_stop_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|timeout
r_static
r_void
id|timeout
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%s: transmit timed out, resetting&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|sgiseeq_reset
c_func
(paren
id|dev
)paren
suffix:semicolon
id|dev-&gt;trans_start
op_assign
id|jiffies
suffix:semicolon
id|netif_wake_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
DECL|function|sgiseeq_get_stats
r_static
r_struct
id|net_device_stats
op_star
id|sgiseeq_get_stats
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|sgiseeq_private
op_star
id|sp
op_assign
(paren
r_struct
id|sgiseeq_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_return
op_amp
id|sp-&gt;stats
suffix:semicolon
)brace
DECL|function|sgiseeq_set_multicast
r_static
r_void
id|sgiseeq_set_multicast
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
)brace
DECL|function|setup_tx_ring
r_static
r_inline
r_void
id|setup_tx_ring
c_func
(paren
r_struct
id|sgiseeq_tx_desc
op_star
id|buf
comma
r_int
id|nbufs
)paren
(brace
r_int
id|i
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
id|i
OL
(paren
id|nbufs
op_minus
l_int|1
)paren
)paren
(brace
id|buf
(braket
id|i
)braket
dot
id|tdma.pnext
op_assign
id|PHYSADDR
c_func
(paren
op_amp
id|buf
(braket
id|i
op_plus
l_int|1
)braket
)paren
suffix:semicolon
id|buf
(braket
id|i
)braket
dot
id|tdma.pbuf
op_assign
l_int|0
suffix:semicolon
id|i
op_increment
suffix:semicolon
)brace
id|buf
(braket
id|i
)braket
dot
id|tdma.pnext
op_assign
id|PHYSADDR
c_func
(paren
op_amp
id|buf
(braket
l_int|0
)braket
)paren
suffix:semicolon
)brace
DECL|function|setup_rx_ring
r_static
r_inline
r_void
id|setup_rx_ring
c_func
(paren
r_struct
id|sgiseeq_rx_desc
op_star
id|buf
comma
r_int
id|nbufs
)paren
(brace
r_int
id|i
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
id|i
OL
(paren
id|nbufs
op_minus
l_int|1
)paren
)paren
(brace
id|buf
(braket
id|i
)braket
dot
id|rdma.pnext
op_assign
id|PHYSADDR
c_func
(paren
op_amp
id|buf
(braket
id|i
op_plus
l_int|1
)braket
)paren
suffix:semicolon
id|buf
(braket
id|i
)braket
dot
id|rdma.pbuf
op_assign
l_int|0
suffix:semicolon
id|i
op_increment
suffix:semicolon
)brace
id|buf
(braket
id|i
)braket
dot
id|rdma.pbuf
op_assign
l_int|0
suffix:semicolon
id|buf
(braket
id|i
)braket
dot
id|rdma.pnext
op_assign
id|PHYSADDR
c_func
(paren
op_amp
id|buf
(braket
l_int|0
)braket
)paren
suffix:semicolon
)brace
DECL|variable|onboard_eth_addr
r_static
r_char
id|onboard_eth_addr
(braket
l_int|6
)braket
suffix:semicolon
DECL|macro|ALIGNED
mdefine_line|#define ALIGNED(x)  ((((unsigned long)(x)) + 0xf) &amp; ~(0xf))
DECL|function|sgiseeq_init
r_int
id|sgiseeq_init
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_struct
id|sgiseeq_regs
op_star
id|sregs
comma
r_struct
id|hpc3_ethregs
op_star
id|hregs
comma
r_int
id|irq
)paren
(brace
r_static
r_int
id|version_printed
op_assign
l_int|0
suffix:semicolon
r_int
id|i
suffix:semicolon
r_struct
id|sgiseeq_private
op_star
id|sp
suffix:semicolon
id|dev-&gt;priv
op_assign
(paren
r_struct
id|sgiseeq_private
op_star
)paren
id|get_free_page
c_func
(paren
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;priv
op_eq
l_int|NULL
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|version_printed
op_increment
)paren
id|printk
c_func
(paren
id|version
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;%s: SGI Seeq8003 &quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|6
suffix:semicolon
id|i
op_increment
)paren
id|printk
c_func
(paren
l_string|&quot;%2.2x%c&quot;
comma
id|dev-&gt;dev_addr
(braket
id|i
)braket
op_assign
id|onboard_eth_addr
(braket
id|i
)braket
comma
id|i
op_eq
l_int|5
ques
c_cond
l_char|&squot; &squot;
suffix:colon
l_char|&squot;:&squot;
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
id|sp
op_assign
(paren
r_struct
id|sgiseeq_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
macro_line|#ifdef DEBUG
id|gpriv
op_assign
id|sp
suffix:semicolon
id|gdev
op_assign
id|dev
suffix:semicolon
macro_line|#endif
id|memset
c_func
(paren
(paren
r_char
op_star
)paren
id|dev-&gt;priv
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|sgiseeq_private
)paren
)paren
suffix:semicolon
id|sp-&gt;sregs
op_assign
id|sregs
suffix:semicolon
id|sp-&gt;hregs
op_assign
id|hregs
suffix:semicolon
id|sp-&gt;name
op_assign
id|sgiseeqstr
suffix:semicolon
id|sp-&gt;srings.rx_desc
op_assign
(paren
r_struct
id|sgiseeq_rx_desc
op_star
)paren
(paren
id|KSEG1ADDR
c_func
(paren
id|ALIGNED
c_func
(paren
op_amp
id|sp-&gt;srings.rxvector
(braket
l_int|0
)braket
)paren
)paren
)paren
suffix:semicolon
id|dma_cache_wback_inv
c_func
(paren
(paren
r_int
r_int
)paren
op_amp
id|sp-&gt;srings.rxvector
comma
r_sizeof
(paren
id|sp-&gt;srings.rxvector
)paren
)paren
suffix:semicolon
id|sp-&gt;srings.tx_desc
op_assign
(paren
r_struct
id|sgiseeq_tx_desc
op_star
)paren
(paren
id|KSEG1ADDR
c_func
(paren
id|ALIGNED
c_func
(paren
op_amp
id|sp-&gt;srings.txvector
(braket
l_int|0
)braket
)paren
)paren
)paren
suffix:semicolon
id|dma_cache_wback_inv
c_func
(paren
(paren
r_int
r_int
)paren
op_amp
id|sp-&gt;srings.txvector
comma
r_sizeof
(paren
id|sp-&gt;srings.txvector
)paren
)paren
suffix:semicolon
multiline_comment|/* A couple calculations now, saves many cycles later. */
id|setup_rx_ring
c_func
(paren
id|sp-&gt;srings.rx_desc
comma
id|SEEQ_RX_BUFFERS
)paren
suffix:semicolon
id|setup_tx_ring
c_func
(paren
id|sp-&gt;srings.tx_desc
comma
id|SEEQ_TX_BUFFERS
)paren
suffix:semicolon
multiline_comment|/* Reset the chip. */
id|hpc3_eth_reset
c_func
(paren
(paren
r_volatile
r_struct
id|hpc3_ethregs
op_star
)paren
id|hregs
)paren
suffix:semicolon
id|sp-&gt;is_edlc
op_assign
op_logical_neg
(paren
id|sregs-&gt;rw.rregs.collision_tx
(braket
l_int|0
)braket
op_amp
l_int|0xff
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sp-&gt;is_edlc
)paren
(brace
id|sp-&gt;control
op_assign
(paren
id|SEEQ_CTRL_XCNT
op_or
id|SEEQ_CTRL_ACCNT
op_or
id|SEEQ_CTRL_SFLAG
op_or
id|SEEQ_CTRL_ESHORT
op_or
id|SEEQ_CTRL_ENCARR
)paren
suffix:semicolon
)brace
id|dev-&gt;open
op_assign
id|sgiseeq_open
suffix:semicolon
id|dev-&gt;stop
op_assign
id|sgiseeq_close
suffix:semicolon
id|dev-&gt;hard_start_xmit
op_assign
id|sgiseeq_start_xmit
suffix:semicolon
id|dev-&gt;tx_timeout
op_assign
id|timeout
suffix:semicolon
id|dev-&gt;watchdog_timeo
op_assign
(paren
l_int|200
op_star
id|HZ
)paren
op_div
l_int|1000
suffix:semicolon
id|dev-&gt;get_stats
op_assign
id|sgiseeq_get_stats
suffix:semicolon
id|dev-&gt;set_multicast_list
op_assign
id|sgiseeq_set_multicast
suffix:semicolon
id|dev-&gt;irq
op_assign
id|irq
suffix:semicolon
id|dev-&gt;dma
op_assign
l_int|0
suffix:semicolon
id|ether_setup
c_func
(paren
id|dev
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|str2hexnum
r_static
r_inline
r_int
r_char
id|str2hexnum
c_func
(paren
r_int
r_char
id|c
)paren
(brace
r_if
c_cond
(paren
id|c
op_ge
l_char|&squot;0&squot;
op_logical_and
id|c
op_le
l_char|&squot;9&squot;
)paren
r_return
id|c
op_minus
l_char|&squot;0&squot;
suffix:semicolon
r_if
c_cond
(paren
id|c
op_ge
l_char|&squot;a&squot;
op_logical_and
id|c
op_le
l_char|&squot;f&squot;
)paren
r_return
id|c
op_minus
l_char|&squot;a&squot;
op_plus
l_int|10
suffix:semicolon
r_return
l_int|0
suffix:semicolon
multiline_comment|/* foo */
)brace
DECL|function|str2eaddr
r_static
r_inline
r_void
id|str2eaddr
c_func
(paren
r_int
r_char
op_star
id|ea
comma
r_int
r_char
op_star
id|str
)paren
(brace
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|6
suffix:semicolon
id|i
op_increment
)paren
(brace
r_int
r_char
id|num
suffix:semicolon
r_if
c_cond
(paren
op_star
id|str
op_eq
l_char|&squot;:&squot;
)paren
(brace
id|str
op_increment
suffix:semicolon
)brace
id|num
op_assign
id|str2hexnum
c_func
(paren
op_star
id|str
op_increment
)paren
op_lshift
l_int|4
suffix:semicolon
id|num
op_or_assign
(paren
id|str2hexnum
c_func
(paren
op_star
id|str
op_increment
)paren
)paren
suffix:semicolon
id|ea
(braket
id|i
)braket
op_assign
id|num
suffix:semicolon
)brace
)brace
DECL|function|sgiseeq_probe
r_int
id|sgiseeq_probe
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_static
r_int
id|initialized
op_assign
l_int|0
suffix:semicolon
r_char
op_star
id|ep
suffix:semicolon
r_if
c_cond
(paren
id|initialized
)paren
multiline_comment|/* Already initialized? */
r_return
l_int|1
suffix:semicolon
id|initialized
op_increment
suffix:semicolon
multiline_comment|/* First get the ethernet address of the onboard interface from ARCS.&n;&t; * This is fragile; PROM doesn&squot;t like running from cache.&n;&t; * On MIPS64 it crashes for some other, yet unknown reason ...&n;&t; */
id|ep
op_assign
id|ArcGetEnvironmentVariable
c_func
(paren
l_string|&quot;eaddr&quot;
)paren
suffix:semicolon
id|str2eaddr
c_func
(paren
id|onboard_eth_addr
comma
id|ep
)paren
suffix:semicolon
r_return
id|sgiseeq_init
c_func
(paren
id|dev
comma
(paren
r_struct
id|sgiseeq_regs
op_star
)paren
(paren
id|KSEG1ADDR
c_func
(paren
l_int|0x1fbd4000
)paren
)paren
comma
op_amp
id|hpc3c0-&gt;ethregs
comma
id|SGI_ENET_IRQ
)paren
suffix:semicolon
)brace
eof
