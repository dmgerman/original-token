multiline_comment|/* $Id: sunhme.c,v 1.105 2000/12/05 02:00:36 anton Exp $&n; * sunhme.c: Sparc HME/BigMac 10/100baseT half/full duplex auto switching,&n; *           auto carrier detecting ethernet driver.  Also known as the&n; *           &quot;Happy Meal Ethernet&quot; found on SunSwift SBUS cards.&n; *&n; * Copyright (C) 1996, 1998, 1999 David S. Miller (davem@redhat.com)&n; *&n; * Changes :&n; * 2000/11/11 Willy Tarreau &lt;willy AT meta-x.org&gt;&n; *   - port to non-sparc architectures. Tested only on x86 and&n; *     only currently works with QFE PCI cards.&n; *   - ability to specify the MAC address at module load time by passing this&n; *     argument : macaddr=0x00,0x10,0x20,0x30,0x40,0x50&n; */
DECL|variable|version
r_static
r_char
op_star
id|version
op_assign
l_string|&quot;sunhme.c:v1.99 12/Sep/99 David S. Miller (davem@redhat.com)&bslash;n&quot;
suffix:semicolon
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/fcntl.h&gt;
macro_line|#include &lt;linux/interrupt.h&gt;
macro_line|#include &lt;linux/ptrace.h&gt;
macro_line|#include &lt;linux/ioport.h&gt;
macro_line|#include &lt;linux/in.h&gt;
macro_line|#include &lt;linux/malloc.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/ethtool.h&gt;
macro_line|#include &lt;asm/system.h&gt;
macro_line|#include &lt;asm/bitops.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/dma.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;asm/byteorder.h&gt;
macro_line|#ifdef __sparc__
macro_line|#include &lt;asm/idprom.h&gt;
macro_line|#include &lt;asm/sbus.h&gt;
macro_line|#include &lt;asm/openprom.h&gt;
macro_line|#include &lt;asm/oplib.h&gt;
macro_line|#include &lt;asm/auxio.h&gt;
macro_line|#ifndef __sparc_v9__
macro_line|#include &lt;asm/io-unit.h&gt;
macro_line|#endif
macro_line|#endif
macro_line|#include &lt;asm/uaccess.h&gt;
macro_line|#include &lt;asm/pgtable.h&gt;
macro_line|#include &lt;asm/irq.h&gt;
macro_line|#include &lt;linux/netdevice.h&gt;
macro_line|#include &lt;linux/etherdevice.h&gt;
macro_line|#include &lt;linux/skbuff.h&gt;
macro_line|#ifdef CONFIG_PCI
macro_line|#include &lt;linux/pci.h&gt;
macro_line|#ifdef __sparc__
macro_line|#include &lt;asm/pbm.h&gt;
macro_line|#endif
macro_line|#endif
macro_line|#include &quot;sunhme.h&quot;
DECL|variable|macaddr
r_static
r_int
id|macaddr
(braket
l_int|6
)braket
suffix:semicolon
multiline_comment|/* accept MAC address of the form macaddr=0x08,0x00,0x20,0x30,0x40,0x50 */
id|MODULE_PARM
c_func
(paren
id|macaddr
comma
l_string|&quot;6i&quot;
)paren
suffix:semicolon
DECL|variable|root_happy_dev
r_static
r_struct
id|happy_meal
op_star
id|root_happy_dev
op_assign
l_int|NULL
suffix:semicolon
macro_line|#ifdef CONFIG_SBUS
DECL|variable|qfe_sbus_list
r_static
r_struct
id|quattro
op_star
id|qfe_sbus_list
op_assign
l_int|NULL
suffix:semicolon
macro_line|#endif
macro_line|#ifdef CONFIG_PCI
DECL|variable|qfe_pci_list
r_static
r_struct
id|quattro
op_star
id|qfe_pci_list
op_assign
l_int|NULL
suffix:semicolon
macro_line|#endif
DECL|macro|HMEDEBUG
macro_line|#undef HMEDEBUG
DECL|macro|SXDEBUG
macro_line|#undef SXDEBUG
DECL|macro|RXDEBUG
macro_line|#undef RXDEBUG
DECL|macro|TXDEBUG
macro_line|#undef TXDEBUG
DECL|macro|TXLOGGING
macro_line|#undef TXLOGGING
macro_line|#ifdef TXLOGGING
DECL|struct|hme_tx_logent
r_struct
id|hme_tx_logent
(brace
DECL|member|tstamp
r_int
r_int
id|tstamp
suffix:semicolon
DECL|member|tx_new
DECL|member|tx_old
r_int
id|tx_new
comma
id|tx_old
suffix:semicolon
DECL|member|action
r_int
r_int
id|action
suffix:semicolon
DECL|macro|TXLOG_ACTION_IRQ
mdefine_line|#define TXLOG_ACTION_IRQ&t;0x01
DECL|macro|TXLOG_ACTION_TXMIT
mdefine_line|#define TXLOG_ACTION_TXMIT&t;0x02
DECL|macro|TXLOG_ACTION_TBUSY
mdefine_line|#define TXLOG_ACTION_TBUSY&t;0x04
DECL|macro|TXLOG_ACTION_NBUFS
mdefine_line|#define TXLOG_ACTION_NBUFS&t;0x08
DECL|member|status
r_int
r_int
id|status
suffix:semicolon
)brace
suffix:semicolon
DECL|macro|TX_LOG_LEN
mdefine_line|#define TX_LOG_LEN&t;128
DECL|variable|tx_log
r_static
r_struct
id|hme_tx_logent
id|tx_log
(braket
id|TX_LOG_LEN
)braket
suffix:semicolon
DECL|variable|txlog_cur_entry
r_static
r_int
id|txlog_cur_entry
op_assign
l_int|0
suffix:semicolon
DECL|function|tx_add_log
r_static
id|__inline__
r_void
id|tx_add_log
c_func
(paren
r_struct
id|happy_meal
op_star
id|hp
comma
r_int
r_int
id|a
comma
r_int
r_int
id|s
)paren
(brace
r_struct
id|hme_tx_logent
op_star
id|tlp
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|save_and_cli
c_func
(paren
id|flags
)paren
suffix:semicolon
id|tlp
op_assign
op_amp
id|tx_log
(braket
id|txlog_cur_entry
)braket
suffix:semicolon
id|tlp-&gt;tstamp
op_assign
(paren
r_int
r_int
)paren
id|jiffies
suffix:semicolon
id|tlp-&gt;tx_new
op_assign
id|hp-&gt;tx_new
suffix:semicolon
id|tlp-&gt;tx_old
op_assign
id|hp-&gt;tx_old
suffix:semicolon
id|tlp-&gt;action
op_assign
id|a
suffix:semicolon
id|tlp-&gt;status
op_assign
id|s
suffix:semicolon
id|txlog_cur_entry
op_assign
(paren
id|txlog_cur_entry
op_plus
l_int|1
)paren
op_amp
(paren
id|TX_LOG_LEN
op_minus
l_int|1
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
DECL|function|tx_dump_log
r_static
id|__inline__
r_void
id|tx_dump_log
c_func
(paren
r_void
)paren
(brace
r_int
id|i
comma
id|this
suffix:semicolon
id|this
op_assign
id|txlog_cur_entry
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|TX_LOG_LEN
suffix:semicolon
id|i
op_increment
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;TXLOG[%d]: j[%08x] tx[N(%d)O(%d)] action[%08x] stat[%08x]&bslash;n&quot;
comma
id|i
comma
id|tx_log
(braket
id|this
)braket
dot
id|tstamp
comma
id|tx_log
(braket
id|this
)braket
dot
id|tx_new
comma
id|tx_log
(braket
id|this
)braket
dot
id|tx_old
comma
id|tx_log
(braket
id|this
)braket
dot
id|action
comma
id|tx_log
(braket
id|this
)braket
dot
id|status
)paren
suffix:semicolon
id|this
op_assign
(paren
id|this
op_plus
l_int|1
)paren
op_amp
(paren
id|TX_LOG_LEN
op_minus
l_int|1
)paren
suffix:semicolon
)brace
)brace
DECL|function|tx_dump_ring
r_static
id|__inline__
r_void
id|tx_dump_ring
c_func
(paren
r_struct
id|happy_meal
op_star
id|hp
)paren
(brace
r_struct
id|hmeal_init_block
op_star
id|hb
op_assign
id|hp-&gt;happy_block
suffix:semicolon
r_struct
id|happy_meal_txd
op_star
id|tp
op_assign
op_amp
id|hb-&gt;happy_meal_txd
(braket
l_int|0
)braket
suffix:semicolon
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|TX_RING_SIZE
suffix:semicolon
id|i
op_add_assign
l_int|4
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;TXD[%d..%d]: [%08x:%08x] [%08x:%08x] [%08x:%08x] [%08x:%08x]&bslash;n&quot;
comma
id|i
comma
id|i
op_plus
l_int|4
comma
id|le32_to_cpu
c_func
(paren
id|tp
(braket
id|i
)braket
dot
id|tx_flags
)paren
comma
id|le32_to_cpu
c_func
(paren
id|tp
(braket
id|i
)braket
dot
id|tx_addr
)paren
comma
id|le32_to_cpu
c_func
(paren
id|tp
(braket
id|i
op_plus
l_int|1
)braket
dot
id|tx_flags
)paren
comma
id|le32_to_cpu
c_func
(paren
id|tp
(braket
id|i
op_plus
l_int|1
)braket
dot
id|tx_addr
)paren
comma
id|le32_to_cpu
c_func
(paren
id|tp
(braket
id|i
op_plus
l_int|2
)braket
dot
id|tx_flags
)paren
comma
id|le32_to_cpu
c_func
(paren
id|tp
(braket
id|i
op_plus
l_int|2
)braket
dot
id|tx_addr
)paren
comma
id|le32_to_cpu
c_func
(paren
id|tp
(braket
id|i
op_plus
l_int|3
)braket
dot
id|tx_flags
)paren
comma
id|le32_to_cpu
c_func
(paren
id|tp
(braket
id|i
op_plus
l_int|3
)braket
dot
id|tx_addr
)paren
)paren
suffix:semicolon
)brace
)brace
macro_line|#else
DECL|macro|tx_add_log
mdefine_line|#define tx_add_log(hp, a, s)&t;&t;do { } while(0)
DECL|macro|tx_dump_log
mdefine_line|#define tx_dump_log()&t;&t;&t;do { } while(0)
DECL|macro|tx_dump_ring
mdefine_line|#define tx_dump_ring(hp)&t;&t;do { } while(0)
macro_line|#endif
macro_line|#ifdef HMEDEBUG
DECL|macro|HMD
mdefine_line|#define HMD(x)  printk x
macro_line|#else
DECL|macro|HMD
mdefine_line|#define HMD(x)
macro_line|#endif
multiline_comment|/* #define AUTO_SWITCH_DEBUG */
macro_line|#ifdef AUTO_SWITCH_DEBUG
DECL|macro|ASD
mdefine_line|#define ASD(x)  printk x
macro_line|#else
DECL|macro|ASD
mdefine_line|#define ASD(x)
macro_line|#endif
DECL|macro|DEFAULT_IPG0
mdefine_line|#define DEFAULT_IPG0      16 /* For lance-mode only */
DECL|macro|DEFAULT_IPG1
mdefine_line|#define DEFAULT_IPG1       8 /* For all modes */
DECL|macro|DEFAULT_IPG2
mdefine_line|#define DEFAULT_IPG2       4 /* For all modes */
DECL|macro|DEFAULT_JAMSIZE
mdefine_line|#define DEFAULT_JAMSIZE    4 /* Toe jam */
macro_line|#ifdef CONFIG_PCI
multiline_comment|/* This happy_pci_ids is declared __initdata because it is only used&n;   as an advisory to depmod.  If this is ported to the new PCI interface&n;   where it could be referenced at any time due to hot plugging,&n;   it should be changed to __devinitdata. */
DECL|variable|__initdata
r_struct
id|pci_device_id
id|happymeal_pci_ids
(braket
)braket
id|__initdata
op_assign
(brace
(brace
id|vendor
suffix:colon
id|PCI_VENDOR_ID_SUN
comma
id|device
suffix:colon
id|PCI_DEVICE_ID_SUN_HAPPYMEAL
comma
id|subvendor
suffix:colon
id|PCI_ANY_ID
comma
id|subdevice
suffix:colon
id|PCI_ANY_ID
comma
)brace
comma
(brace
)brace
multiline_comment|/* Terminating entry */
)brace
suffix:semicolon
id|MODULE_DEVICE_TABLE
c_func
(paren
id|pci
comma
id|happymeal_pci_ids
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/* NOTE: In the descriptor writes one _must_ write the address&n; *&t; member _first_.  The card must not be allowed to see&n; *&t; the updated descriptor flags until the address is&n; *&t; correct.  I&squot;ve added a write memory barrier between&n; *&t; the two stores so that I can sleep well at night... -DaveM&n; */
macro_line|#if defined(CONFIG_SBUS) &amp;&amp; defined(CONFIG_PCI)
DECL|function|sbus_hme_write32
r_static
r_void
id|sbus_hme_write32
c_func
(paren
r_int
r_int
id|reg
comma
id|u32
id|val
)paren
(brace
id|sbus_writel
c_func
(paren
id|val
comma
id|reg
)paren
suffix:semicolon
)brace
DECL|function|sbus_hme_read32
r_static
id|u32
id|sbus_hme_read32
c_func
(paren
r_int
r_int
id|reg
)paren
(brace
r_return
id|sbus_readl
c_func
(paren
id|reg
)paren
suffix:semicolon
)brace
DECL|function|sbus_hme_write_rxd
r_static
r_void
id|sbus_hme_write_rxd
c_func
(paren
r_struct
id|happy_meal_rxd
op_star
id|rxd
comma
id|u32
id|flags
comma
id|u32
id|addr
)paren
(brace
id|rxd-&gt;rx_addr
op_assign
id|addr
suffix:semicolon
id|wmb
c_func
(paren
)paren
suffix:semicolon
id|rxd-&gt;rx_flags
op_assign
id|flags
suffix:semicolon
)brace
DECL|function|sbus_hme_write_txd
r_static
r_void
id|sbus_hme_write_txd
c_func
(paren
r_struct
id|happy_meal_txd
op_star
id|txd
comma
id|u32
id|flags
comma
id|u32
id|addr
)paren
(brace
id|txd-&gt;tx_addr
op_assign
id|addr
suffix:semicolon
id|wmb
c_func
(paren
)paren
suffix:semicolon
id|txd-&gt;tx_flags
op_assign
id|flags
suffix:semicolon
)brace
DECL|function|sbus_hme_read_desc32
r_static
id|u32
id|sbus_hme_read_desc32
c_func
(paren
id|u32
op_star
id|p
)paren
(brace
r_return
op_star
id|p
suffix:semicolon
)brace
DECL|function|pci_hme_write32
r_static
r_void
id|pci_hme_write32
c_func
(paren
r_int
r_int
id|reg
comma
id|u32
id|val
)paren
(brace
id|writel
c_func
(paren
id|val
comma
id|reg
)paren
suffix:semicolon
)brace
DECL|function|pci_hme_read32
r_static
id|u32
id|pci_hme_read32
c_func
(paren
r_int
r_int
id|reg
)paren
(brace
r_return
id|readl
c_func
(paren
id|reg
)paren
suffix:semicolon
)brace
DECL|function|pci_hme_write_rxd
r_static
r_void
id|pci_hme_write_rxd
c_func
(paren
r_struct
id|happy_meal_rxd
op_star
id|rxd
comma
id|u32
id|flags
comma
id|u32
id|addr
)paren
(brace
id|rxd-&gt;rx_addr
op_assign
id|cpu_to_le32
c_func
(paren
id|addr
)paren
suffix:semicolon
id|wmb
c_func
(paren
)paren
suffix:semicolon
id|rxd-&gt;rx_flags
op_assign
id|cpu_to_le32
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
DECL|function|pci_hme_write_txd
r_static
r_void
id|pci_hme_write_txd
c_func
(paren
r_struct
id|happy_meal_txd
op_star
id|txd
comma
id|u32
id|flags
comma
id|u32
id|addr
)paren
(brace
id|txd-&gt;tx_addr
op_assign
id|cpu_to_le32
c_func
(paren
id|addr
)paren
suffix:semicolon
id|wmb
c_func
(paren
)paren
suffix:semicolon
id|txd-&gt;tx_flags
op_assign
id|cpu_to_le32
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
DECL|function|pci_hme_read_desc32
r_static
id|u32
id|pci_hme_read_desc32
c_func
(paren
id|u32
op_star
id|p
)paren
(brace
r_return
id|cpu_to_le32p
c_func
(paren
id|p
)paren
suffix:semicolon
)brace
DECL|macro|hme_write32
mdefine_line|#define hme_write32(__hp, __reg, __val) &bslash;&n;&t;((__hp)-&gt;write32((__reg), (__val)))
DECL|macro|hme_read32
mdefine_line|#define hme_read32(__hp, __reg) &bslash;&n;&t;((__hp)-&gt;read32(__reg))
DECL|macro|hme_write_rxd
mdefine_line|#define hme_write_rxd(__hp, __rxd, __flags, __addr) &bslash;&n;&t;((__hp)-&gt;write_rxd((__rxd), (__flags), (__addr)))
DECL|macro|hme_write_txd
mdefine_line|#define hme_write_txd(__hp, __txd, __flags, __addr) &bslash;&n;&t;((__hp)-&gt;write_txd((__txd), (__flags), (__addr)))
DECL|macro|hme_read_desc32
mdefine_line|#define hme_read_desc32(__hp, __p) &bslash;&n;&t;((__hp)-&gt;read_desc32(__p))
DECL|macro|hme_dma_map
mdefine_line|#define hme_dma_map(__hp, __ptr, __size, __dir) &bslash;&n;&t;((__hp)-&gt;dma_map((__hp)-&gt;happy_dev, (__ptr), (__size), (__dir)))
DECL|macro|hme_dma_unmap
mdefine_line|#define hme_dma_unmap(__hp, __addr, __size, __dir) &bslash;&n;&t;((__hp)-&gt;dma_unmap((__hp)-&gt;happy_dev, (__addr), (__size), (__dir)))
DECL|macro|hme_dma_sync
mdefine_line|#define hme_dma_sync(__hp, __addr, __size, __dir) &bslash;&n;&t;((__hp)-&gt;dma_sync((__hp)-&gt;happy_dev, (__addr), (__size), (__dir)))
macro_line|#else
macro_line|#ifdef CONFIG_SBUS
multiline_comment|/* SBUS only compilation */
DECL|macro|hme_write32
mdefine_line|#define hme_write32(__hp, __reg, __val) &bslash;&n;&t;sbus_writel((__val), (__reg))
DECL|macro|hme_read32
mdefine_line|#define hme_read32(__hp, __reg) &bslash;&n;&t;sbus_readl(__reg)
DECL|macro|hme_write_rxd
mdefine_line|#define hme_write_rxd(__hp, __rxd, __flags, __addr) &bslash;&n;do {&t;(__rxd)-&gt;rx_addr = (__addr); &bslash;&n;&t;wmb(); &bslash;&n;&t;(__rxd)-&gt;rx_flags = (__flags); &bslash;&n;} while(0)
DECL|macro|hme_write_txd
mdefine_line|#define hme_write_txd(__hp, __txd, __flags, __addr) &bslash;&n;do {&t;(__txd)-&gt;tx_addr = (__addr); &bslash;&n;&t;wmb(); &bslash;&n;&t;(__txd)-&gt;tx_flags = (__flags); &bslash;&n;} while(0)
DECL|macro|hme_read_desc32
mdefine_line|#define hme_read_desc32(__hp, __p)&t;(*(__p))
DECL|macro|hme_dma_map
mdefine_line|#define hme_dma_map(__hp, __ptr, __size, __dir) &bslash;&n;&t;sbus_map_single((__hp)-&gt;happy_dev, (__ptr), (__size), (__dir))
DECL|macro|hme_dma_unmap
mdefine_line|#define hme_dma_unmap(__hp, __addr, __size, __dir) &bslash;&n;&t;sbus_unmap_single((__hp)-&gt;happy_dev, (__addr), (__size), (__dir))
DECL|macro|hme_dma_sync
mdefine_line|#define hme_dma_sync(__hp, __addr, __size, __dir) &bslash;&n;&t;sbus_dma_sync_single((__hp)-&gt;happy_dev, (__addr), (__size), (__dir))
macro_line|#else
multiline_comment|/* PCI only compilation */
DECL|macro|hme_write32
mdefine_line|#define hme_write32(__hp, __reg, __val) &bslash;&n;&t;writel((__val), (__reg))
DECL|macro|hme_read32
mdefine_line|#define hme_read32(__hp, __reg) &bslash;&n;&t;readl(__reg)
DECL|macro|hme_write_rxd
mdefine_line|#define hme_write_rxd(__hp, __rxd, __flags, __addr) &bslash;&n;do {&t;(__rxd)-&gt;rx_addr = cpu_to_le32(__addr); &bslash;&n;&t;wmb(); &bslash;&n;&t;(__rxd)-&gt;rx_flags = cpu_to_le32(__flags); &bslash;&n;} while(0)
DECL|macro|hme_write_txd
mdefine_line|#define hme_write_txd(__hp, __txd, __flags, __addr) &bslash;&n;do {&t;(__txd)-&gt;tx_addr = cpu_to_le32(__addr); &bslash;&n;&t;wmb(); &bslash;&n;&t;(__txd)-&gt;tx_flags = cpu_to_le32(__flags); &bslash;&n;} while(0)
DECL|macro|hme_read_desc32
mdefine_line|#define hme_read_desc32(__hp, __p)&t;cpu_to_le32p(__p)
DECL|macro|hme_dma_map
mdefine_line|#define hme_dma_map(__hp, __ptr, __size, __dir) &bslash;&n;&t;pci_map_single((__hp)-&gt;happy_dev, (__ptr), (__size), (__dir))
DECL|macro|hme_dma_unmap
mdefine_line|#define hme_dma_unmap(__hp, __addr, __size, __dir) &bslash;&n;&t;pci_unmap_single((__hp)-&gt;happy_dev, (__addr), (__size), (__dir))
DECL|macro|hme_dma_sync
mdefine_line|#define hme_dma_sync(__hp, __addr, __size, __dir) &bslash;&n;&t;pci_dma_sync_single((__hp)-&gt;happy_dev, (__addr), (__size), (__dir))
macro_line|#endif
macro_line|#endif
macro_line|#ifdef SBUS_DMA_BIDIRECTIONAL
DECL|macro|DMA_BIDIRECTIONAL
macro_line|#&t;define DMA_BIDIRECTIONAL&t;SBUS_DMA_BIDIRECTIONAL
macro_line|#else
DECL|macro|DMA_BIDIRECTIONAL
macro_line|#&t;define DMA_BIDIRECTIONAL&t;0
macro_line|#endif
macro_line|#ifdef SBUS_DMA_FROMDEVICE
DECL|macro|DMA_FROMDEVICE
macro_line|#&t;define DMA_FROMDEVICE&t;&t;SBUS_DMA_FROMDEVICE
macro_line|#else
DECL|macro|DMA_TODEVICE
macro_line|#&t;define DMA_TODEVICE&t;&t;1
macro_line|#endif
macro_line|#ifdef SBUS_DMA_TODEVICE
DECL|macro|DMA_TODEVICE
macro_line|#&t;define DMA_TODEVICE&t;&t;SBUS_DMA_TODEVICE
macro_line|#else
DECL|macro|DMA_FROMDEVICE
macro_line|#&t;define DMA_FROMDEVICE&t;&t;2
macro_line|#endif
multiline_comment|/* Oh yes, the MIF BitBang is mighty fun to program.  BitBucket is more like it. */
DECL|function|BB_PUT_BIT
r_static
r_void
id|BB_PUT_BIT
c_func
(paren
r_struct
id|happy_meal
op_star
id|hp
comma
r_int
r_int
id|tregs
comma
r_int
id|bit
)paren
(brace
id|hme_write32
c_func
(paren
id|hp
comma
id|tregs
op_plus
id|TCVR_BBDATA
comma
id|bit
)paren
suffix:semicolon
id|hme_write32
c_func
(paren
id|hp
comma
id|tregs
op_plus
id|TCVR_BBCLOCK
comma
l_int|0
)paren
suffix:semicolon
id|hme_write32
c_func
(paren
id|hp
comma
id|tregs
op_plus
id|TCVR_BBCLOCK
comma
l_int|1
)paren
suffix:semicolon
)brace
macro_line|#if 0
r_static
id|u32
id|BB_GET_BIT
c_func
(paren
r_struct
id|happy_meal
op_star
id|hp
comma
r_int
r_int
id|tregs
comma
r_int
id|internal
)paren
(brace
id|u32
id|ret
suffix:semicolon
id|hme_write32
c_func
(paren
id|hp
comma
id|tregs
op_plus
id|TCVR_BBCLOCK
comma
l_int|0
)paren
suffix:semicolon
id|hme_write32
c_func
(paren
id|hp
comma
id|tregs
op_plus
id|TCVR_BBCLOCK
comma
l_int|1
)paren
suffix:semicolon
id|ret
op_assign
id|hme_read32
c_func
(paren
id|hp
comma
id|tregs
op_plus
id|TCVR_CFG
)paren
suffix:semicolon
r_if
c_cond
(paren
id|internal
)paren
id|ret
op_and_assign
id|TCV_CFG_MDIO0
suffix:semicolon
r_else
id|ret
op_and_assign
id|TCV_CFG_MDIO1
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
macro_line|#endif
DECL|function|BB_GET_BIT2
r_static
id|u32
id|BB_GET_BIT2
c_func
(paren
r_struct
id|happy_meal
op_star
id|hp
comma
r_int
r_int
id|tregs
comma
r_int
id|internal
)paren
(brace
id|u32
id|retval
suffix:semicolon
id|hme_write32
c_func
(paren
id|hp
comma
id|tregs
op_plus
id|TCVR_BBCLOCK
comma
l_int|0
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|1
)paren
suffix:semicolon
id|retval
op_assign
id|hme_read32
c_func
(paren
id|hp
comma
id|tregs
op_plus
id|TCVR_CFG
)paren
suffix:semicolon
r_if
c_cond
(paren
id|internal
)paren
id|retval
op_and_assign
id|TCV_CFG_MDIO0
suffix:semicolon
r_else
id|retval
op_and_assign
id|TCV_CFG_MDIO1
suffix:semicolon
id|hme_write32
c_func
(paren
id|hp
comma
id|tregs
op_plus
id|TCVR_BBCLOCK
comma
l_int|1
)paren
suffix:semicolon
r_return
id|retval
suffix:semicolon
)brace
DECL|macro|TCVR_FAILURE
mdefine_line|#define TCVR_FAILURE      0x80000000     /* Impossible MIF read value */
DECL|function|happy_meal_bb_read
r_static
r_int
id|happy_meal_bb_read
c_func
(paren
r_struct
id|happy_meal
op_star
id|hp
comma
r_int
r_int
id|tregs
comma
r_int
id|reg
)paren
(brace
id|u32
id|tmp
suffix:semicolon
r_int
id|retval
op_assign
l_int|0
suffix:semicolon
r_int
id|i
suffix:semicolon
id|ASD
c_func
(paren
(paren
l_string|&quot;happy_meal_bb_read: reg=%d &quot;
comma
id|reg
)paren
)paren
suffix:semicolon
multiline_comment|/* Enable the MIF BitBang outputs. */
id|hme_write32
c_func
(paren
id|hp
comma
id|tregs
op_plus
id|TCVR_BBOENAB
comma
l_int|1
)paren
suffix:semicolon
multiline_comment|/* Force BitBang into the idle state. */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|32
suffix:semicolon
id|i
op_increment
)paren
id|BB_PUT_BIT
c_func
(paren
id|hp
comma
id|tregs
comma
l_int|1
)paren
suffix:semicolon
multiline_comment|/* Give it the read sequence. */
id|BB_PUT_BIT
c_func
(paren
id|hp
comma
id|tregs
comma
l_int|0
)paren
suffix:semicolon
id|BB_PUT_BIT
c_func
(paren
id|hp
comma
id|tregs
comma
l_int|1
)paren
suffix:semicolon
id|BB_PUT_BIT
c_func
(paren
id|hp
comma
id|tregs
comma
l_int|1
)paren
suffix:semicolon
id|BB_PUT_BIT
c_func
(paren
id|hp
comma
id|tregs
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* Give it the PHY address. */
id|tmp
op_assign
id|hp-&gt;paddr
op_amp
l_int|0xff
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|4
suffix:semicolon
id|i
op_ge
l_int|0
suffix:semicolon
id|i
op_decrement
)paren
id|BB_PUT_BIT
c_func
(paren
id|hp
comma
id|tregs
comma
(paren
(paren
id|tmp
op_rshift
id|i
)paren
op_amp
l_int|1
)paren
)paren
suffix:semicolon
multiline_comment|/* Tell it what register we want to read. */
id|tmp
op_assign
(paren
id|reg
op_amp
l_int|0xff
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|4
suffix:semicolon
id|i
op_ge
l_int|0
suffix:semicolon
id|i
op_decrement
)paren
id|BB_PUT_BIT
c_func
(paren
id|hp
comma
id|tregs
comma
(paren
(paren
id|tmp
op_rshift
id|i
)paren
op_amp
l_int|1
)paren
)paren
suffix:semicolon
multiline_comment|/* Close down the MIF BitBang outputs. */
id|hme_write32
c_func
(paren
id|hp
comma
id|tregs
op_plus
id|TCVR_BBOENAB
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* Now read in the value. */
(paren
r_void
)paren
id|BB_GET_BIT2
c_func
(paren
id|hp
comma
id|tregs
comma
(paren
id|hp-&gt;tcvr_type
op_eq
id|internal
)paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|15
suffix:semicolon
id|i
op_ge
l_int|0
suffix:semicolon
id|i
op_decrement
)paren
id|retval
op_or_assign
id|BB_GET_BIT2
c_func
(paren
id|hp
comma
id|tregs
comma
(paren
id|hp-&gt;tcvr_type
op_eq
id|internal
)paren
)paren
suffix:semicolon
(paren
r_void
)paren
id|BB_GET_BIT2
c_func
(paren
id|hp
comma
id|tregs
comma
(paren
id|hp-&gt;tcvr_type
op_eq
id|internal
)paren
)paren
suffix:semicolon
(paren
r_void
)paren
id|BB_GET_BIT2
c_func
(paren
id|hp
comma
id|tregs
comma
(paren
id|hp-&gt;tcvr_type
op_eq
id|internal
)paren
)paren
suffix:semicolon
(paren
r_void
)paren
id|BB_GET_BIT2
c_func
(paren
id|hp
comma
id|tregs
comma
(paren
id|hp-&gt;tcvr_type
op_eq
id|internal
)paren
)paren
suffix:semicolon
id|ASD
c_func
(paren
(paren
l_string|&quot;value=%x&bslash;n&quot;
comma
id|retval
)paren
)paren
suffix:semicolon
r_return
id|retval
suffix:semicolon
)brace
DECL|function|happy_meal_bb_write
r_static
r_void
id|happy_meal_bb_write
c_func
(paren
r_struct
id|happy_meal
op_star
id|hp
comma
r_int
r_int
id|tregs
comma
r_int
id|reg
comma
r_int
r_int
id|value
)paren
(brace
id|u32
id|tmp
suffix:semicolon
r_int
id|i
suffix:semicolon
id|ASD
c_func
(paren
(paren
l_string|&quot;happy_meal_bb_write: reg=%d value=%x&bslash;n&quot;
comma
id|reg
comma
id|value
)paren
)paren
suffix:semicolon
multiline_comment|/* Enable the MIF BitBang outputs. */
id|hme_write32
c_func
(paren
id|hp
comma
id|tregs
op_plus
id|TCVR_BBOENAB
comma
l_int|1
)paren
suffix:semicolon
multiline_comment|/* Force BitBang into the idle state. */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|32
suffix:semicolon
id|i
op_increment
)paren
id|BB_PUT_BIT
c_func
(paren
id|hp
comma
id|tregs
comma
l_int|1
)paren
suffix:semicolon
multiline_comment|/* Give it write sequence. */
id|BB_PUT_BIT
c_func
(paren
id|hp
comma
id|tregs
comma
l_int|0
)paren
suffix:semicolon
id|BB_PUT_BIT
c_func
(paren
id|hp
comma
id|tregs
comma
l_int|1
)paren
suffix:semicolon
id|BB_PUT_BIT
c_func
(paren
id|hp
comma
id|tregs
comma
l_int|0
)paren
suffix:semicolon
id|BB_PUT_BIT
c_func
(paren
id|hp
comma
id|tregs
comma
l_int|1
)paren
suffix:semicolon
multiline_comment|/* Give it the PHY address. */
id|tmp
op_assign
(paren
id|hp-&gt;paddr
op_amp
l_int|0xff
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|4
suffix:semicolon
id|i
op_ge
l_int|0
suffix:semicolon
id|i
op_decrement
)paren
id|BB_PUT_BIT
c_func
(paren
id|hp
comma
id|tregs
comma
(paren
(paren
id|tmp
op_rshift
id|i
)paren
op_amp
l_int|1
)paren
)paren
suffix:semicolon
multiline_comment|/* Tell it what register we will be writing. */
id|tmp
op_assign
(paren
id|reg
op_amp
l_int|0xff
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|4
suffix:semicolon
id|i
op_ge
l_int|0
suffix:semicolon
id|i
op_decrement
)paren
id|BB_PUT_BIT
c_func
(paren
id|hp
comma
id|tregs
comma
(paren
(paren
id|tmp
op_rshift
id|i
)paren
op_amp
l_int|1
)paren
)paren
suffix:semicolon
multiline_comment|/* Tell it to become ready for the bits. */
id|BB_PUT_BIT
c_func
(paren
id|hp
comma
id|tregs
comma
l_int|1
)paren
suffix:semicolon
id|BB_PUT_BIT
c_func
(paren
id|hp
comma
id|tregs
comma
l_int|0
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|15
suffix:semicolon
id|i
op_ge
l_int|0
suffix:semicolon
id|i
op_decrement
)paren
id|BB_PUT_BIT
c_func
(paren
id|hp
comma
id|tregs
comma
(paren
(paren
id|value
op_rshift
id|i
)paren
op_amp
l_int|1
)paren
)paren
suffix:semicolon
multiline_comment|/* Close down the MIF BitBang outputs. */
id|hme_write32
c_func
(paren
id|hp
comma
id|tregs
op_plus
id|TCVR_BBOENAB
comma
l_int|0
)paren
suffix:semicolon
)brace
DECL|macro|TCVR_READ_TRIES
mdefine_line|#define TCVR_READ_TRIES   16
DECL|function|happy_meal_tcvr_read
r_static
r_int
id|happy_meal_tcvr_read
c_func
(paren
r_struct
id|happy_meal
op_star
id|hp
comma
r_int
r_int
id|tregs
comma
r_int
id|reg
)paren
(brace
r_int
id|tries
op_assign
id|TCVR_READ_TRIES
suffix:semicolon
r_int
id|retval
suffix:semicolon
id|ASD
c_func
(paren
(paren
l_string|&quot;happy_meal_tcvr_read: reg=0x%02x &quot;
comma
id|reg
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|hp-&gt;tcvr_type
op_eq
id|none
)paren
(brace
id|ASD
c_func
(paren
(paren
l_string|&quot;no transceiver, value=TCVR_FAILURE&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_return
id|TCVR_FAILURE
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|hp-&gt;happy_flags
op_amp
id|HFLAG_FENABLE
)paren
)paren
(brace
id|ASD
c_func
(paren
(paren
l_string|&quot;doing bit bang&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_return
id|happy_meal_bb_read
c_func
(paren
id|hp
comma
id|tregs
comma
id|reg
)paren
suffix:semicolon
)brace
id|hme_write32
c_func
(paren
id|hp
comma
id|tregs
op_plus
id|TCVR_FRAME
comma
(paren
id|FRAME_READ
op_or
(paren
id|hp-&gt;paddr
op_lshift
l_int|23
)paren
op_or
(paren
(paren
id|reg
op_amp
l_int|0xff
)paren
op_lshift
l_int|18
)paren
)paren
)paren
suffix:semicolon
r_while
c_loop
(paren
op_logical_neg
(paren
id|hme_read32
c_func
(paren
id|hp
comma
id|tregs
op_plus
id|TCVR_FRAME
)paren
op_amp
l_int|0x10000
)paren
op_logical_and
op_decrement
id|tries
)paren
id|udelay
c_func
(paren
l_int|20
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|tries
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;happy meal: Aieee, transceiver MIF read bolixed&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|TCVR_FAILURE
suffix:semicolon
)brace
id|retval
op_assign
id|hme_read32
c_func
(paren
id|hp
comma
id|tregs
op_plus
id|TCVR_FRAME
)paren
op_amp
l_int|0xffff
suffix:semicolon
id|ASD
c_func
(paren
(paren
l_string|&quot;value=%04x&bslash;n&quot;
comma
id|retval
)paren
)paren
suffix:semicolon
r_return
id|retval
suffix:semicolon
)brace
DECL|macro|TCVR_WRITE_TRIES
mdefine_line|#define TCVR_WRITE_TRIES  16
DECL|function|happy_meal_tcvr_write
r_static
r_void
id|happy_meal_tcvr_write
c_func
(paren
r_struct
id|happy_meal
op_star
id|hp
comma
r_int
r_int
id|tregs
comma
r_int
id|reg
comma
r_int
r_int
id|value
)paren
(brace
r_int
id|tries
op_assign
id|TCVR_WRITE_TRIES
suffix:semicolon
id|ASD
c_func
(paren
(paren
l_string|&quot;happy_meal_tcvr_write: reg=0x%02x value=%04x&bslash;n&quot;
comma
id|reg
comma
id|value
)paren
)paren
suffix:semicolon
multiline_comment|/* Welcome to Sun Microsystems, can I take your order please? */
r_if
c_cond
(paren
op_logical_neg
id|hp-&gt;happy_flags
op_amp
id|HFLAG_FENABLE
)paren
r_return
id|happy_meal_bb_write
c_func
(paren
id|hp
comma
id|tregs
comma
id|reg
comma
id|value
)paren
suffix:semicolon
multiline_comment|/* Would you like fries with that? */
id|hme_write32
c_func
(paren
id|hp
comma
id|tregs
op_plus
id|TCVR_FRAME
comma
(paren
id|FRAME_WRITE
op_or
(paren
id|hp-&gt;paddr
op_lshift
l_int|23
)paren
op_or
(paren
(paren
id|reg
op_amp
l_int|0xff
)paren
op_lshift
l_int|18
)paren
op_or
(paren
id|value
op_amp
l_int|0xffff
)paren
)paren
)paren
suffix:semicolon
r_while
c_loop
(paren
op_logical_neg
(paren
id|hme_read32
c_func
(paren
id|hp
comma
id|tregs
op_plus
id|TCVR_FRAME
)paren
op_amp
l_int|0x10000
)paren
op_logical_and
op_decrement
id|tries
)paren
id|udelay
c_func
(paren
l_int|20
)paren
suffix:semicolon
multiline_comment|/* Anything else? */
r_if
c_cond
(paren
op_logical_neg
id|tries
)paren
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;happy meal: Aieee, transceiver MIF write bolixed&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* Fifty-two cents is your change, have a nice day. */
)brace
multiline_comment|/* Auto negotiation.  The scheme is very simple.  We have a timer routine&n; * that keeps watching the auto negotiation process as it progresses.&n; * The DP83840 is first told to start doing it&squot;s thing, we set up the time&n; * and place the timer state machine in it&squot;s initial state.&n; *&n; * Here the timer peeks at the DP83840 status registers at each click to see&n; * if the auto negotiation has completed, we assume here that the DP83840 PHY&n; * will time out at some point and just tell us what (didn&squot;t) happen.  For&n; * complete coverage we only allow so many of the ticks at this level to run,&n; * when this has expired we print a warning message and try another strategy.&n; * This &quot;other&quot; strategy is to force the interface into various speed/duplex&n; * configurations and we stop when we see a link-up condition before the&n; * maximum number of &quot;peek&quot; ticks have occurred.&n; *&n; * Once a valid link status has been detected we configure the BigMAC and&n; * the rest of the Happy Meal to speak the most efficient protocol we could&n; * get a clean link for.  The priority for link configurations, highest first&n; * is:&n; *                 100 Base-T Full Duplex&n; *                 100 Base-T Half Duplex&n; *                 10 Base-T Full Duplex&n; *                 10 Base-T Half Duplex&n; *&n; * We start a new timer now, after a successful auto negotiation status has&n; * been detected.  This timer just waits for the link-up bit to get set in&n; * the BMCR of the DP83840.  When this occurs we print a kernel log message&n; * describing the link type in use and the fact that it is up.&n; *&n; * If a fatal error of some sort is signalled and detected in the interrupt&n; * service routine, and the chip is reset, or the link is ifconfig&squot;d down&n; * and then back up, this entire process repeats itself all over again.&n; */
DECL|function|try_next_permutation
r_static
r_int
id|try_next_permutation
c_func
(paren
r_struct
id|happy_meal
op_star
id|hp
comma
r_int
r_int
id|tregs
)paren
(brace
id|hp-&gt;sw_bmcr
op_assign
id|happy_meal_tcvr_read
c_func
(paren
id|hp
comma
id|tregs
comma
id|DP83840_BMCR
)paren
suffix:semicolon
multiline_comment|/* Downgrade from full to half duplex.  Only possible&n;&t; * via ethtool.&n;&t; */
r_if
c_cond
(paren
id|hp-&gt;sw_bmcr
op_amp
id|BMCR_FULLDPLX
)paren
(brace
id|hp-&gt;sw_bmcr
op_and_assign
op_complement
(paren
id|BMCR_FULLDPLX
)paren
suffix:semicolon
id|happy_meal_tcvr_write
c_func
(paren
id|hp
comma
id|tregs
comma
id|DP83840_BMCR
comma
id|hp-&gt;sw_bmcr
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Downgrade from 100 to 10. */
r_if
c_cond
(paren
id|hp-&gt;sw_bmcr
op_amp
id|BMCR_SPEED100
)paren
(brace
id|hp-&gt;sw_bmcr
op_and_assign
op_complement
(paren
id|BMCR_SPEED100
)paren
suffix:semicolon
id|happy_meal_tcvr_write
c_func
(paren
id|hp
comma
id|tregs
comma
id|DP83840_BMCR
comma
id|hp-&gt;sw_bmcr
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* We&squot;ve tried everything. */
r_return
op_minus
l_int|1
suffix:semicolon
)brace
DECL|function|display_link_mode
r_static
r_void
id|display_link_mode
c_func
(paren
r_struct
id|happy_meal
op_star
id|hp
comma
r_int
r_int
id|tregs
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Link is up using &quot;
comma
id|hp-&gt;dev-&gt;name
)paren
suffix:semicolon
r_if
c_cond
(paren
id|hp-&gt;tcvr_type
op_eq
id|external
)paren
id|printk
c_func
(paren
l_string|&quot;external &quot;
)paren
suffix:semicolon
r_else
id|printk
c_func
(paren
l_string|&quot;internal &quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;transceiver at &quot;
)paren
suffix:semicolon
id|hp-&gt;sw_lpa
op_assign
id|happy_meal_tcvr_read
c_func
(paren
id|hp
comma
id|tregs
comma
id|DP83840_LPA
)paren
suffix:semicolon
r_if
c_cond
(paren
id|hp-&gt;sw_lpa
op_amp
(paren
id|LPA_100HALF
op_or
id|LPA_100FULL
)paren
)paren
(brace
r_if
c_cond
(paren
id|hp-&gt;sw_lpa
op_amp
id|LPA_100FULL
)paren
id|printk
c_func
(paren
l_string|&quot;100Mb/s, Full Duplex.&bslash;n&quot;
)paren
suffix:semicolon
r_else
id|printk
c_func
(paren
l_string|&quot;100Mb/s, Half Duplex.&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|hp-&gt;sw_lpa
op_amp
id|LPA_10FULL
)paren
id|printk
c_func
(paren
l_string|&quot;10Mb/s, Full Duplex.&bslash;n&quot;
)paren
suffix:semicolon
r_else
id|printk
c_func
(paren
l_string|&quot;10Mb/s, Half Duplex.&bslash;n&quot;
)paren
suffix:semicolon
)brace
)brace
DECL|function|display_forced_link_mode
r_static
r_void
id|display_forced_link_mode
c_func
(paren
r_struct
id|happy_meal
op_star
id|hp
comma
r_int
r_int
id|tregs
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Link has been forced up using &quot;
comma
id|hp-&gt;dev-&gt;name
)paren
suffix:semicolon
r_if
c_cond
(paren
id|hp-&gt;tcvr_type
op_eq
id|external
)paren
id|printk
c_func
(paren
l_string|&quot;external &quot;
)paren
suffix:semicolon
r_else
id|printk
c_func
(paren
l_string|&quot;internal &quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;transceiver at &quot;
)paren
suffix:semicolon
id|hp-&gt;sw_bmcr
op_assign
id|happy_meal_tcvr_read
c_func
(paren
id|hp
comma
id|tregs
comma
id|DP83840_BMCR
)paren
suffix:semicolon
r_if
c_cond
(paren
id|hp-&gt;sw_bmcr
op_amp
id|BMCR_SPEED100
)paren
id|printk
c_func
(paren
l_string|&quot;100Mb/s, &quot;
)paren
suffix:semicolon
r_else
id|printk
c_func
(paren
l_string|&quot;10Mb/s, &quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|hp-&gt;sw_bmcr
op_amp
id|BMCR_FULLDPLX
)paren
id|printk
c_func
(paren
l_string|&quot;Full Duplex.&bslash;n&quot;
)paren
suffix:semicolon
r_else
id|printk
c_func
(paren
l_string|&quot;Half Duplex.&bslash;n&quot;
)paren
suffix:semicolon
)brace
DECL|function|set_happy_link_modes
r_static
r_int
id|set_happy_link_modes
c_func
(paren
r_struct
id|happy_meal
op_star
id|hp
comma
r_int
r_int
id|tregs
)paren
(brace
r_int
id|full
suffix:semicolon
multiline_comment|/* All we care about is making sure the bigmac tx_cfg has a&n;&t; * proper duplex setting.&n;&t; */
r_if
c_cond
(paren
id|hp-&gt;timer_state
op_eq
id|arbwait
)paren
(brace
id|hp-&gt;sw_lpa
op_assign
id|happy_meal_tcvr_read
c_func
(paren
id|hp
comma
id|tregs
comma
id|DP83840_LPA
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|hp-&gt;sw_lpa
op_amp
(paren
id|LPA_10HALF
op_or
id|LPA_10FULL
op_or
id|LPA_100HALF
op_or
id|LPA_100FULL
)paren
)paren
)paren
r_goto
id|no_response
suffix:semicolon
r_if
c_cond
(paren
id|hp-&gt;sw_lpa
op_amp
id|LPA_100FULL
)paren
id|full
op_assign
l_int|1
suffix:semicolon
r_else
r_if
c_cond
(paren
id|hp-&gt;sw_lpa
op_amp
id|LPA_100HALF
)paren
id|full
op_assign
l_int|0
suffix:semicolon
r_else
r_if
c_cond
(paren
id|hp-&gt;sw_lpa
op_amp
id|LPA_10FULL
)paren
id|full
op_assign
l_int|1
suffix:semicolon
r_else
id|full
op_assign
l_int|0
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* Forcing a link mode. */
id|hp-&gt;sw_bmcr
op_assign
id|happy_meal_tcvr_read
c_func
(paren
id|hp
comma
id|tregs
comma
id|DP83840_BMCR
)paren
suffix:semicolon
r_if
c_cond
(paren
id|hp-&gt;sw_bmcr
op_amp
id|BMCR_FULLDPLX
)paren
id|full
op_assign
l_int|1
suffix:semicolon
r_else
id|full
op_assign
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Before changing other bits in the tx_cfg register, and in&n;&t; * general any of other the TX config registers too, you&n;&t; * must:&n;&t; * 1) Clear Enable&n;&t; * 2) Poll with reads until that bit reads back as zero&n;&t; * 3) Make TX configuration changes&n;&t; * 4) Set Enable once more&n;&t; */
id|hme_write32
c_func
(paren
id|hp
comma
id|hp-&gt;bigmacregs
op_plus
id|BMAC_TXCFG
comma
id|hme_read32
c_func
(paren
id|hp
comma
id|hp-&gt;bigmacregs
op_plus
id|BMAC_TXCFG
)paren
op_amp
op_complement
(paren
id|BIGMAC_TXCFG_ENABLE
)paren
)paren
suffix:semicolon
r_while
c_loop
(paren
id|hme_read32
c_func
(paren
id|hp
comma
id|hp-&gt;bigmacregs
op_plus
id|BMAC_TXCFG
)paren
op_amp
id|BIGMAC_TXCFG_ENABLE
)paren
id|barrier
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|full
)paren
(brace
id|hp-&gt;happy_flags
op_or_assign
id|HFLAG_FULL
suffix:semicolon
id|hme_write32
c_func
(paren
id|hp
comma
id|hp-&gt;bigmacregs
op_plus
id|BMAC_TXCFG
comma
id|hme_read32
c_func
(paren
id|hp
comma
id|hp-&gt;bigmacregs
op_plus
id|BMAC_TXCFG
)paren
op_or
id|BIGMAC_TXCFG_FULLDPLX
)paren
suffix:semicolon
)brace
r_else
(brace
id|hp-&gt;happy_flags
op_and_assign
op_complement
(paren
id|HFLAG_FULL
)paren
suffix:semicolon
id|hme_write32
c_func
(paren
id|hp
comma
id|hp-&gt;bigmacregs
op_plus
id|BMAC_TXCFG
comma
id|hme_read32
c_func
(paren
id|hp
comma
id|hp-&gt;bigmacregs
op_plus
id|BMAC_TXCFG
)paren
op_amp
op_complement
(paren
id|BIGMAC_TXCFG_FULLDPLX
)paren
)paren
suffix:semicolon
)brace
id|hme_write32
c_func
(paren
id|hp
comma
id|hp-&gt;bigmacregs
op_plus
id|BMAC_TXCFG
comma
id|hme_read32
c_func
(paren
id|hp
comma
id|hp-&gt;bigmacregs
op_plus
id|BMAC_TXCFG
)paren
op_or
id|BIGMAC_TXCFG_ENABLE
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
id|no_response
suffix:colon
r_return
l_int|1
suffix:semicolon
)brace
r_static
r_int
id|happy_meal_init
c_func
(paren
r_struct
id|happy_meal
op_star
id|hp
comma
r_int
id|from_irq
)paren
suffix:semicolon
DECL|function|is_lucent_phy
r_static
r_int
id|is_lucent_phy
c_func
(paren
r_struct
id|happy_meal
op_star
id|hp
)paren
(brace
r_int
r_int
id|tregs
op_assign
id|hp-&gt;tcvregs
suffix:semicolon
r_int
r_int
id|mr2
comma
id|mr3
suffix:semicolon
r_int
id|ret
op_assign
l_int|0
suffix:semicolon
id|mr2
op_assign
id|happy_meal_tcvr_read
c_func
(paren
id|hp
comma
id|tregs
comma
l_int|2
)paren
suffix:semicolon
id|mr3
op_assign
id|happy_meal_tcvr_read
c_func
(paren
id|hp
comma
id|tregs
comma
l_int|3
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|mr2
op_amp
l_int|0xffff
)paren
op_eq
l_int|0x0180
op_logical_and
(paren
(paren
id|mr3
op_amp
l_int|0xffff
)paren
op_rshift
l_int|10
)paren
op_eq
l_int|0x1d
)paren
(brace
macro_line|#if 0
id|printk
c_func
(paren
l_string|&quot;HMEDEBUG: Lucent PHY detected.&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
id|ret
op_assign
l_int|1
suffix:semicolon
)brace
r_return
id|ret
suffix:semicolon
)brace
DECL|function|happy_meal_timer
r_static
r_void
id|happy_meal_timer
c_func
(paren
r_int
r_int
id|data
)paren
(brace
r_struct
id|happy_meal
op_star
id|hp
op_assign
(paren
r_struct
id|happy_meal
op_star
)paren
id|data
suffix:semicolon
r_int
r_int
id|tregs
op_assign
id|hp-&gt;tcvregs
suffix:semicolon
r_int
id|restart_timer
op_assign
l_int|0
suffix:semicolon
id|hp-&gt;timer_ticks
op_increment
suffix:semicolon
r_switch
c_cond
(paren
id|hp-&gt;timer_state
)paren
(brace
r_case
id|arbwait
suffix:colon
multiline_comment|/* Only allow for 5 ticks, thats 10 seconds and much too&n;&t;&t; * long to wait for arbitration to complete.&n;&t;&t; */
r_if
c_cond
(paren
id|hp-&gt;timer_ticks
op_ge
l_int|10
)paren
(brace
multiline_comment|/* Enter force mode. */
id|do_force_mode
suffix:colon
id|hp-&gt;sw_bmcr
op_assign
id|happy_meal_tcvr_read
c_func
(paren
id|hp
comma
id|tregs
comma
id|DP83840_BMCR
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;%s: Auto-Negotiation unsuccessful, trying force link mode&bslash;n&quot;
comma
id|hp-&gt;dev-&gt;name
)paren
suffix:semicolon
id|hp-&gt;sw_bmcr
op_assign
id|BMCR_SPEED100
suffix:semicolon
id|happy_meal_tcvr_write
c_func
(paren
id|hp
comma
id|tregs
comma
id|DP83840_BMCR
comma
id|hp-&gt;sw_bmcr
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|is_lucent_phy
c_func
(paren
id|hp
)paren
)paren
(brace
multiline_comment|/* OK, seems we need do disable the transceiver for the first&n;&t;&t;&t;&t; * tick to make sure we get an accurate link state at the&n;&t;&t;&t;&t; * second tick.&n;&t;&t;&t;&t; */
id|hp-&gt;sw_csconfig
op_assign
id|happy_meal_tcvr_read
c_func
(paren
id|hp
comma
id|tregs
comma
id|DP83840_CSCONFIG
)paren
suffix:semicolon
id|hp-&gt;sw_csconfig
op_and_assign
op_complement
(paren
id|CSCONFIG_TCVDISAB
)paren
suffix:semicolon
id|happy_meal_tcvr_write
c_func
(paren
id|hp
comma
id|tregs
comma
id|DP83840_CSCONFIG
comma
id|hp-&gt;sw_csconfig
)paren
suffix:semicolon
)brace
id|hp-&gt;timer_state
op_assign
id|ltrywait
suffix:semicolon
id|hp-&gt;timer_ticks
op_assign
l_int|0
suffix:semicolon
id|restart_timer
op_assign
l_int|1
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* Anything interesting happen? */
id|hp-&gt;sw_bmsr
op_assign
id|happy_meal_tcvr_read
c_func
(paren
id|hp
comma
id|tregs
comma
id|DP83840_BMSR
)paren
suffix:semicolon
r_if
c_cond
(paren
id|hp-&gt;sw_bmsr
op_amp
id|BMSR_ANEGCOMPLETE
)paren
(brace
r_int
id|ret
suffix:semicolon
multiline_comment|/* Just what we&squot;ve been waiting for... */
id|ret
op_assign
id|set_happy_link_modes
c_func
(paren
id|hp
comma
id|tregs
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
)paren
(brace
multiline_comment|/* Ooops, something bad happened, go to force&n;&t;&t;&t;&t;&t; * mode.&n;&t;&t;&t;&t;&t; *&n;&t;&t;&t;&t;&t; * XXX Broken hubs which don&squot;t support 802.3u&n;&t;&t;&t;&t;&t; * XXX auto-negotiation make this happen as well.&n;&t;&t;&t;&t;&t; */
r_goto
id|do_force_mode
suffix:semicolon
)brace
multiline_comment|/* Success, at least so far, advance our state engine. */
id|hp-&gt;timer_state
op_assign
id|lupwait
suffix:semicolon
id|restart_timer
op_assign
l_int|1
suffix:semicolon
)brace
r_else
(brace
id|restart_timer
op_assign
l_int|1
suffix:semicolon
)brace
)brace
r_break
suffix:semicolon
r_case
id|lupwait
suffix:colon
multiline_comment|/* Auto negotiation was successful and we are awaiting a&n;&t;&t; * link up status.  I have decided to let this timer run&n;&t;&t; * forever until some sort of error is signalled, reporting&n;&t;&t; * a message to the user at 10 second intervals.&n;&t;&t; */
id|hp-&gt;sw_bmsr
op_assign
id|happy_meal_tcvr_read
c_func
(paren
id|hp
comma
id|tregs
comma
id|DP83840_BMSR
)paren
suffix:semicolon
r_if
c_cond
(paren
id|hp-&gt;sw_bmsr
op_amp
id|BMSR_LSTATUS
)paren
(brace
multiline_comment|/* Wheee, it&squot;s up, display the link mode in use and put&n;&t;&t;&t; * the timer to sleep.&n;&t;&t;&t; */
id|display_link_mode
c_func
(paren
id|hp
comma
id|tregs
)paren
suffix:semicolon
id|hp-&gt;timer_state
op_assign
id|asleep
suffix:semicolon
id|restart_timer
op_assign
l_int|0
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|hp-&gt;timer_ticks
op_ge
l_int|10
)paren
(brace
id|printk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;%s: Auto negotiation successful, link still &quot;
l_string|&quot;not completely up.&bslash;n&quot;
comma
id|hp-&gt;dev-&gt;name
)paren
suffix:semicolon
id|hp-&gt;timer_ticks
op_assign
l_int|0
suffix:semicolon
id|restart_timer
op_assign
l_int|1
suffix:semicolon
)brace
r_else
(brace
id|restart_timer
op_assign
l_int|1
suffix:semicolon
)brace
)brace
r_break
suffix:semicolon
r_case
id|ltrywait
suffix:colon
multiline_comment|/* Making the timeout here too long can make it take&n;&t;&t; * annoyingly long to attempt all of the link mode&n;&t;&t; * permutations, but then again this is essentially&n;&t;&t; * error recovery code for the most part.&n;&t;&t; */
id|hp-&gt;sw_bmsr
op_assign
id|happy_meal_tcvr_read
c_func
(paren
id|hp
comma
id|tregs
comma
id|DP83840_BMSR
)paren
suffix:semicolon
id|hp-&gt;sw_csconfig
op_assign
id|happy_meal_tcvr_read
c_func
(paren
id|hp
comma
id|tregs
comma
id|DP83840_CSCONFIG
)paren
suffix:semicolon
r_if
c_cond
(paren
id|hp-&gt;timer_ticks
op_eq
l_int|1
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|is_lucent_phy
c_func
(paren
id|hp
)paren
)paren
(brace
multiline_comment|/* Re-enable transceiver, we&squot;ll re-enable the transceiver next&n;&t;&t;&t;&t; * tick, then check link state on the following tick.&n;&t;&t;&t;&t; */
id|hp-&gt;sw_csconfig
op_or_assign
id|CSCONFIG_TCVDISAB
suffix:semicolon
id|happy_meal_tcvr_write
c_func
(paren
id|hp
comma
id|tregs
comma
id|DP83840_CSCONFIG
comma
id|hp-&gt;sw_csconfig
)paren
suffix:semicolon
)brace
id|restart_timer
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|hp-&gt;timer_ticks
op_eq
l_int|2
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|is_lucent_phy
c_func
(paren
id|hp
)paren
)paren
(brace
id|hp-&gt;sw_csconfig
op_and_assign
op_complement
(paren
id|CSCONFIG_TCVDISAB
)paren
suffix:semicolon
id|happy_meal_tcvr_write
c_func
(paren
id|hp
comma
id|tregs
comma
id|DP83840_CSCONFIG
comma
id|hp-&gt;sw_csconfig
)paren
suffix:semicolon
)brace
id|restart_timer
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|hp-&gt;sw_bmsr
op_amp
id|BMSR_LSTATUS
)paren
(brace
multiline_comment|/* Force mode selection success. */
id|display_forced_link_mode
c_func
(paren
id|hp
comma
id|tregs
)paren
suffix:semicolon
id|set_happy_link_modes
c_func
(paren
id|hp
comma
id|tregs
)paren
suffix:semicolon
multiline_comment|/* XXX error? then what? */
id|hp-&gt;timer_state
op_assign
id|asleep
suffix:semicolon
id|restart_timer
op_assign
l_int|0
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|hp-&gt;timer_ticks
op_ge
l_int|4
)paren
(brace
multiline_comment|/* 6 seconds or so... */
r_int
id|ret
suffix:semicolon
id|ret
op_assign
id|try_next_permutation
c_func
(paren
id|hp
comma
id|tregs
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
op_eq
op_minus
l_int|1
)paren
(brace
multiline_comment|/* Aieee, tried them all, reset the&n;&t;&t;&t;&t;&t; * chip and try all over again.&n;&t;&t;&t;&t;&t; */
multiline_comment|/* Let the user know... */
id|printk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;%s: Link down, cable problem?&bslash;n&quot;
comma
id|hp-&gt;dev-&gt;name
)paren
suffix:semicolon
id|ret
op_assign
id|happy_meal_init
c_func
(paren
id|hp
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
)paren
(brace
multiline_comment|/* ho hum... */
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: Error, cannot re-init the &quot;
l_string|&quot;Happy Meal.&bslash;n&quot;
comma
id|hp-&gt;dev-&gt;name
)paren
suffix:semicolon
)brace
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|is_lucent_phy
c_func
(paren
id|hp
)paren
)paren
(brace
id|hp-&gt;sw_csconfig
op_assign
id|happy_meal_tcvr_read
c_func
(paren
id|hp
comma
id|tregs
comma
id|DP83840_CSCONFIG
)paren
suffix:semicolon
id|hp-&gt;sw_csconfig
op_or_assign
id|CSCONFIG_TCVDISAB
suffix:semicolon
id|happy_meal_tcvr_write
c_func
(paren
id|hp
comma
id|tregs
comma
id|DP83840_CSCONFIG
comma
id|hp-&gt;sw_csconfig
)paren
suffix:semicolon
)brace
id|hp-&gt;timer_ticks
op_assign
l_int|0
suffix:semicolon
id|restart_timer
op_assign
l_int|1
suffix:semicolon
)brace
r_else
(brace
id|restart_timer
op_assign
l_int|1
suffix:semicolon
)brace
)brace
r_break
suffix:semicolon
r_case
id|asleep
suffix:colon
r_default
suffix:colon
multiline_comment|/* Can&squot;t happens.... */
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: Aieee, link timer is asleep but we got one anyways!&bslash;n&quot;
comma
id|hp-&gt;dev-&gt;name
)paren
suffix:semicolon
id|restart_timer
op_assign
l_int|0
suffix:semicolon
id|hp-&gt;timer_ticks
op_assign
l_int|0
suffix:semicolon
id|hp-&gt;timer_state
op_assign
id|asleep
suffix:semicolon
multiline_comment|/* foo on you */
r_break
suffix:semicolon
)brace
suffix:semicolon
r_if
c_cond
(paren
id|restart_timer
)paren
(brace
id|hp-&gt;happy_timer.expires
op_assign
id|jiffies
op_plus
(paren
(paren
l_int|12
op_star
id|HZ
)paren
op_div
l_int|10
)paren
suffix:semicolon
multiline_comment|/* 1.2 sec. */
id|add_timer
c_func
(paren
op_amp
id|hp-&gt;happy_timer
)paren
suffix:semicolon
)brace
)brace
DECL|macro|TX_RESET_TRIES
mdefine_line|#define TX_RESET_TRIES     32
DECL|macro|RX_RESET_TRIES
mdefine_line|#define RX_RESET_TRIES     32
DECL|function|happy_meal_tx_reset
r_static
r_void
id|happy_meal_tx_reset
c_func
(paren
r_struct
id|happy_meal
op_star
id|hp
comma
r_int
r_int
id|bregs
)paren
(brace
r_int
id|tries
op_assign
id|TX_RESET_TRIES
suffix:semicolon
id|HMD
c_func
(paren
(paren
l_string|&quot;happy_meal_tx_reset: reset, &quot;
)paren
)paren
suffix:semicolon
multiline_comment|/* Would you like to try our SMCC Delux? */
id|hme_write32
c_func
(paren
id|hp
comma
id|bregs
op_plus
id|BMAC_TXSWRESET
comma
l_int|0
)paren
suffix:semicolon
r_while
c_loop
(paren
(paren
id|hme_read32
c_func
(paren
id|hp
comma
id|bregs
op_plus
id|BMAC_TXSWRESET
)paren
op_amp
l_int|1
)paren
op_logical_and
op_decrement
id|tries
)paren
id|udelay
c_func
(paren
l_int|20
)paren
suffix:semicolon
multiline_comment|/* Lettuce, tomato, buggy hardware (no extra charge)? */
r_if
c_cond
(paren
op_logical_neg
id|tries
)paren
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;happy meal: Transceiver BigMac ATTACK!&quot;
)paren
suffix:semicolon
multiline_comment|/* Take care. */
id|HMD
c_func
(paren
(paren
l_string|&quot;done&bslash;n&quot;
)paren
)paren
suffix:semicolon
)brace
DECL|function|happy_meal_rx_reset
r_static
r_void
id|happy_meal_rx_reset
c_func
(paren
r_struct
id|happy_meal
op_star
id|hp
comma
r_int
r_int
id|bregs
)paren
(brace
r_int
id|tries
op_assign
id|RX_RESET_TRIES
suffix:semicolon
id|HMD
c_func
(paren
(paren
l_string|&quot;happy_meal_rx_reset: reset, &quot;
)paren
)paren
suffix:semicolon
multiline_comment|/* We have a special on GNU/Viking hardware bugs today. */
id|hme_write32
c_func
(paren
id|hp
comma
id|bregs
op_plus
id|BMAC_RXSWRESET
comma
l_int|0
)paren
suffix:semicolon
r_while
c_loop
(paren
(paren
id|hme_read32
c_func
(paren
id|hp
comma
id|bregs
op_plus
id|BMAC_RXSWRESET
)paren
op_amp
l_int|1
)paren
op_logical_and
op_decrement
id|tries
)paren
id|udelay
c_func
(paren
l_int|20
)paren
suffix:semicolon
multiline_comment|/* Will that be all? */
r_if
c_cond
(paren
op_logical_neg
id|tries
)paren
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;happy meal: Receiver BigMac ATTACK!&quot;
)paren
suffix:semicolon
multiline_comment|/* Don&squot;t forget your vik_1137125_wa.  Have a nice day. */
id|HMD
c_func
(paren
(paren
l_string|&quot;done&bslash;n&quot;
)paren
)paren
suffix:semicolon
)brace
DECL|macro|STOP_TRIES
mdefine_line|#define STOP_TRIES         16
DECL|function|happy_meal_stop
r_static
r_void
id|happy_meal_stop
c_func
(paren
r_struct
id|happy_meal
op_star
id|hp
comma
r_int
r_int
id|gregs
)paren
(brace
r_int
id|tries
op_assign
id|STOP_TRIES
suffix:semicolon
id|HMD
c_func
(paren
(paren
l_string|&quot;happy_meal_stop: reset, &quot;
)paren
)paren
suffix:semicolon
multiline_comment|/* We&squot;re consolidating our STB products, it&squot;s your lucky day. */
id|hme_write32
c_func
(paren
id|hp
comma
id|gregs
op_plus
id|GREG_SWRESET
comma
id|GREG_RESET_ALL
)paren
suffix:semicolon
r_while
c_loop
(paren
id|hme_read32
c_func
(paren
id|hp
comma
id|gregs
op_plus
id|GREG_SWRESET
)paren
op_logical_and
op_decrement
id|tries
)paren
id|udelay
c_func
(paren
l_int|20
)paren
suffix:semicolon
multiline_comment|/* Come back next week when we are &quot;Sun Microelectronics&quot;. */
r_if
c_cond
(paren
op_logical_neg
id|tries
)paren
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;happy meal: Fry guys.&quot;
)paren
suffix:semicolon
multiline_comment|/* Remember: &quot;Different name, same old buggy as shit hardware.&quot; */
id|HMD
c_func
(paren
(paren
l_string|&quot;done&bslash;n&quot;
)paren
)paren
suffix:semicolon
)brace
DECL|function|happy_meal_get_counters
r_static
r_void
id|happy_meal_get_counters
c_func
(paren
r_struct
id|happy_meal
op_star
id|hp
comma
r_int
r_int
id|bregs
)paren
(brace
r_struct
id|net_device_stats
op_star
id|stats
op_assign
op_amp
id|hp-&gt;net_stats
suffix:semicolon
id|stats-&gt;rx_crc_errors
op_add_assign
id|hme_read32
c_func
(paren
id|hp
comma
id|bregs
op_plus
id|BMAC_RCRCECTR
)paren
suffix:semicolon
id|hme_write32
c_func
(paren
id|hp
comma
id|bregs
op_plus
id|BMAC_RCRCECTR
comma
l_int|0
)paren
suffix:semicolon
id|stats-&gt;rx_frame_errors
op_add_assign
id|hme_read32
c_func
(paren
id|hp
comma
id|bregs
op_plus
id|BMAC_UNALECTR
)paren
suffix:semicolon
id|hme_write32
c_func
(paren
id|hp
comma
id|bregs
op_plus
id|BMAC_UNALECTR
comma
l_int|0
)paren
suffix:semicolon
id|stats-&gt;rx_length_errors
op_add_assign
id|hme_read32
c_func
(paren
id|hp
comma
id|bregs
op_plus
id|BMAC_GLECTR
)paren
suffix:semicolon
id|hme_write32
c_func
(paren
id|hp
comma
id|bregs
op_plus
id|BMAC_GLECTR
comma
l_int|0
)paren
suffix:semicolon
id|stats-&gt;tx_aborted_errors
op_add_assign
id|hme_read32
c_func
(paren
id|hp
comma
id|bregs
op_plus
id|BMAC_EXCTR
)paren
suffix:semicolon
id|stats-&gt;collisions
op_add_assign
(paren
id|hme_read32
c_func
(paren
id|hp
comma
id|bregs
op_plus
id|BMAC_EXCTR
)paren
op_plus
id|hme_read32
c_func
(paren
id|hp
comma
id|bregs
op_plus
id|BMAC_LTCTR
)paren
)paren
suffix:semicolon
id|hme_write32
c_func
(paren
id|hp
comma
id|bregs
op_plus
id|BMAC_EXCTR
comma
l_int|0
)paren
suffix:semicolon
id|hme_write32
c_func
(paren
id|hp
comma
id|bregs
op_plus
id|BMAC_LTCTR
comma
l_int|0
)paren
suffix:semicolon
)brace
macro_line|#if 0
r_static
r_void
id|happy_meal_poll_start
c_func
(paren
r_struct
id|happy_meal
op_star
id|hp
comma
r_int
r_int
id|tregs
)paren
(brace
id|u32
id|tmp
suffix:semicolon
r_int
id|speed
suffix:semicolon
id|ASD
c_func
(paren
(paren
l_string|&quot;happy_meal_poll_start: &quot;
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|hp-&gt;happy_flags
op_amp
id|HFLAG_POLLENABLE
)paren
)paren
(brace
id|HMD
c_func
(paren
(paren
l_string|&quot;polling disabled, return&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/* Start the MIF polling on the external transceiver. */
id|ASD
c_func
(paren
(paren
l_string|&quot;polling on, &quot;
)paren
)paren
suffix:semicolon
id|tmp
op_assign
id|hme_read32
c_func
(paren
id|hp
comma
id|tregs
op_plus
id|TCVR_CFG
)paren
suffix:semicolon
id|tmp
op_and_assign
op_complement
(paren
id|TCV_CFG_PDADDR
op_or
id|TCV_CFG_PREGADDR
)paren
suffix:semicolon
id|tmp
op_or_assign
(paren
(paren
id|hp-&gt;paddr
op_amp
l_int|0x1f
)paren
op_lshift
l_int|10
)paren
suffix:semicolon
id|tmp
op_or_assign
(paren
id|TCV_PADDR_ETX
op_lshift
l_int|3
)paren
suffix:semicolon
id|tmp
op_or_assign
id|TCV_CFG_PENABLE
suffix:semicolon
id|hme_write32
c_func
(paren
id|hp
comma
id|tregs
op_plus
id|TCVR_CFG
comma
id|tmp
)paren
suffix:semicolon
multiline_comment|/* Let the bits set. */
id|udelay
c_func
(paren
l_int|200
)paren
suffix:semicolon
multiline_comment|/* We are polling now. */
id|ASD
c_func
(paren
(paren
l_string|&quot;now polling, &quot;
)paren
)paren
suffix:semicolon
id|hp-&gt;happy_flags
op_or_assign
id|HFLAG_POLL
suffix:semicolon
multiline_comment|/* Clear the poll flags, get the basic status as of now. */
id|hp-&gt;poll_flag
op_assign
l_int|0
suffix:semicolon
id|hp-&gt;poll_data
op_assign
id|hme_read32
c_func
(paren
id|hp
comma
id|tregs
op_plus
id|TCVR_STATUS
)paren
op_rshift
l_int|16
suffix:semicolon
r_if
c_cond
(paren
id|hp-&gt;happy_flags
op_amp
id|HFLAG_AUTO
)paren
id|speed
op_assign
id|hp-&gt;auto_speed
suffix:semicolon
r_else
id|speed
op_assign
id|hp-&gt;forced_speed
suffix:semicolon
multiline_comment|/* Listen only for the MIF interrupts we want to hear. */
id|ASD
c_func
(paren
(paren
l_string|&quot;mif ints on, &quot;
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|speed
op_eq
l_int|100
)paren
id|hme_write32
c_func
(paren
id|hp
comma
id|tregs
op_plus
id|TCVR_IMASK
comma
l_int|0xfffb
)paren
suffix:semicolon
r_else
id|hme_write32
c_func
(paren
id|hp
comma
id|tregs
op_plus
id|TCVR_IMASK
comma
l_int|0xfff9
)paren
suffix:semicolon
id|ASD
c_func
(paren
(paren
l_string|&quot;done&bslash;n&quot;
)paren
)paren
suffix:semicolon
)brace
macro_line|#endif
DECL|function|happy_meal_poll_stop
r_static
r_void
id|happy_meal_poll_stop
c_func
(paren
r_struct
id|happy_meal
op_star
id|hp
comma
r_int
r_int
id|tregs
)paren
(brace
id|ASD
c_func
(paren
(paren
l_string|&quot;happy_meal_poll_stop: &quot;
)paren
)paren
suffix:semicolon
multiline_comment|/* If polling disabled or not polling already, nothing to do. */
r_if
c_cond
(paren
(paren
id|hp-&gt;happy_flags
op_amp
(paren
id|HFLAG_POLLENABLE
op_or
id|HFLAG_POLL
)paren
)paren
op_ne
(paren
id|HFLAG_POLLENABLE
op_or
id|HFLAG_POLL
)paren
)paren
(brace
id|HMD
c_func
(paren
(paren
l_string|&quot;not polling, return&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/* Shut up the MIF. */
id|ASD
c_func
(paren
(paren
l_string|&quot;were polling, mif ints off, &quot;
)paren
)paren
suffix:semicolon
id|hme_write32
c_func
(paren
id|hp
comma
id|tregs
op_plus
id|TCVR_IMASK
comma
l_int|0xffff
)paren
suffix:semicolon
multiline_comment|/* Turn off polling. */
id|ASD
c_func
(paren
(paren
l_string|&quot;polling off, &quot;
)paren
)paren
suffix:semicolon
id|hme_write32
c_func
(paren
id|hp
comma
id|tregs
op_plus
id|TCVR_CFG
comma
id|hme_read32
c_func
(paren
id|hp
comma
id|tregs
op_plus
id|TCVR_CFG
)paren
op_amp
op_complement
(paren
id|TCV_CFG_PENABLE
)paren
)paren
suffix:semicolon
multiline_comment|/* We are no longer polling. */
id|hp-&gt;happy_flags
op_and_assign
op_complement
(paren
id|HFLAG_POLL
)paren
suffix:semicolon
multiline_comment|/* Let the bits set. */
id|udelay
c_func
(paren
l_int|200
)paren
suffix:semicolon
id|ASD
c_func
(paren
(paren
l_string|&quot;done&bslash;n&quot;
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/* Only Sun can take such nice parts and fuck up the programming interface&n; * like this.  Good job guys...&n; */
DECL|macro|TCVR_RESET_TRIES
mdefine_line|#define TCVR_RESET_TRIES       16 /* It should reset quickly        */
DECL|macro|TCVR_UNISOLATE_TRIES
mdefine_line|#define TCVR_UNISOLATE_TRIES   32 /* Dis-isolation can take longer. */
DECL|function|happy_meal_tcvr_reset
r_static
r_int
id|happy_meal_tcvr_reset
c_func
(paren
r_struct
id|happy_meal
op_star
id|hp
comma
r_int
r_int
id|tregs
)paren
(brace
id|u32
id|tconfig
suffix:semicolon
r_int
id|result
comma
id|tries
op_assign
id|TCVR_RESET_TRIES
suffix:semicolon
id|tconfig
op_assign
id|hme_read32
c_func
(paren
id|hp
comma
id|tregs
op_plus
id|TCVR_CFG
)paren
suffix:semicolon
id|ASD
c_func
(paren
(paren
l_string|&quot;happy_meal_tcvr_reset: tcfg&lt;%08lx&gt; &quot;
comma
id|tconfig
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|hp-&gt;tcvr_type
op_eq
id|external
)paren
(brace
id|ASD
c_func
(paren
(paren
l_string|&quot;external&lt;&quot;
)paren
)paren
suffix:semicolon
id|hme_write32
c_func
(paren
id|hp
comma
id|tregs
op_plus
id|TCVR_CFG
comma
id|tconfig
op_amp
op_complement
(paren
id|TCV_CFG_PSELECT
)paren
)paren
suffix:semicolon
id|hp-&gt;tcvr_type
op_assign
id|internal
suffix:semicolon
id|hp-&gt;paddr
op_assign
id|TCV_PADDR_ITX
suffix:semicolon
id|ASD
c_func
(paren
(paren
l_string|&quot;ISOLATE,&quot;
)paren
)paren
suffix:semicolon
id|happy_meal_tcvr_write
c_func
(paren
id|hp
comma
id|tregs
comma
id|DP83840_BMCR
comma
(paren
id|BMCR_LOOPBACK
op_or
id|BMCR_PDOWN
op_or
id|BMCR_ISOLATE
)paren
)paren
suffix:semicolon
id|result
op_assign
id|happy_meal_tcvr_read
c_func
(paren
id|hp
comma
id|tregs
comma
id|DP83840_BMCR
)paren
suffix:semicolon
r_if
c_cond
(paren
id|result
op_eq
id|TCVR_FAILURE
)paren
(brace
id|ASD
c_func
(paren
(paren
l_string|&quot;phyread_fail&gt;&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|ASD
c_func
(paren
(paren
l_string|&quot;phyread_ok,PSELECT&gt;&quot;
)paren
)paren
suffix:semicolon
id|hme_write32
c_func
(paren
id|hp
comma
id|tregs
op_plus
id|TCVR_CFG
comma
id|tconfig
op_or
id|TCV_CFG_PSELECT
)paren
suffix:semicolon
id|hp-&gt;tcvr_type
op_assign
id|external
suffix:semicolon
id|hp-&gt;paddr
op_assign
id|TCV_PADDR_ETX
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|tconfig
op_amp
id|TCV_CFG_MDIO1
)paren
(brace
id|ASD
c_func
(paren
(paren
l_string|&quot;internal&lt;PSELECT,&quot;
)paren
)paren
suffix:semicolon
id|hme_write32
c_func
(paren
id|hp
comma
id|tregs
op_plus
id|TCVR_CFG
comma
(paren
id|tconfig
op_or
id|TCV_CFG_PSELECT
)paren
)paren
suffix:semicolon
id|ASD
c_func
(paren
(paren
l_string|&quot;ISOLATE,&quot;
)paren
)paren
suffix:semicolon
id|happy_meal_tcvr_write
c_func
(paren
id|hp
comma
id|tregs
comma
id|DP83840_BMCR
comma
(paren
id|BMCR_LOOPBACK
op_or
id|BMCR_PDOWN
op_or
id|BMCR_ISOLATE
)paren
)paren
suffix:semicolon
id|result
op_assign
id|happy_meal_tcvr_read
c_func
(paren
id|hp
comma
id|tregs
comma
id|DP83840_BMCR
)paren
suffix:semicolon
r_if
c_cond
(paren
id|result
op_eq
id|TCVR_FAILURE
)paren
(brace
id|ASD
c_func
(paren
(paren
l_string|&quot;phyread_fail&gt;&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|ASD
c_func
(paren
(paren
l_string|&quot;phyread_ok,~PSELECT&gt;&quot;
)paren
)paren
suffix:semicolon
id|hme_write32
c_func
(paren
id|hp
comma
id|tregs
op_plus
id|TCVR_CFG
comma
(paren
id|tconfig
op_amp
op_complement
(paren
id|TCV_CFG_PSELECT
)paren
)paren
)paren
suffix:semicolon
id|hp-&gt;tcvr_type
op_assign
id|internal
suffix:semicolon
id|hp-&gt;paddr
op_assign
id|TCV_PADDR_ITX
suffix:semicolon
)brace
)brace
id|ASD
c_func
(paren
(paren
l_string|&quot;BMCR_RESET &quot;
)paren
)paren
suffix:semicolon
id|happy_meal_tcvr_write
c_func
(paren
id|hp
comma
id|tregs
comma
id|DP83840_BMCR
comma
id|BMCR_RESET
)paren
suffix:semicolon
r_while
c_loop
(paren
op_decrement
id|tries
)paren
(brace
id|result
op_assign
id|happy_meal_tcvr_read
c_func
(paren
id|hp
comma
id|tregs
comma
id|DP83840_BMCR
)paren
suffix:semicolon
r_if
c_cond
(paren
id|result
op_eq
id|TCVR_FAILURE
)paren
r_return
op_minus
l_int|1
suffix:semicolon
id|hp-&gt;sw_bmcr
op_assign
id|result
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|result
op_amp
id|BMCR_RESET
)paren
)paren
r_break
suffix:semicolon
id|udelay
c_func
(paren
l_int|20
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|tries
)paren
(brace
id|ASD
c_func
(paren
(paren
l_string|&quot;BMCR RESET FAILED!&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|ASD
c_func
(paren
(paren
l_string|&quot;RESET_OK&bslash;n&quot;
)paren
)paren
suffix:semicolon
multiline_comment|/* Get fresh copies of the PHY registers. */
id|hp-&gt;sw_bmsr
op_assign
id|happy_meal_tcvr_read
c_func
(paren
id|hp
comma
id|tregs
comma
id|DP83840_BMSR
)paren
suffix:semicolon
id|hp-&gt;sw_physid1
op_assign
id|happy_meal_tcvr_read
c_func
(paren
id|hp
comma
id|tregs
comma
id|DP83840_PHYSID1
)paren
suffix:semicolon
id|hp-&gt;sw_physid2
op_assign
id|happy_meal_tcvr_read
c_func
(paren
id|hp
comma
id|tregs
comma
id|DP83840_PHYSID2
)paren
suffix:semicolon
id|hp-&gt;sw_advertise
op_assign
id|happy_meal_tcvr_read
c_func
(paren
id|hp
comma
id|tregs
comma
id|DP83840_ADVERTISE
)paren
suffix:semicolon
id|ASD
c_func
(paren
(paren
l_string|&quot;UNISOLATE&quot;
)paren
)paren
suffix:semicolon
id|hp-&gt;sw_bmcr
op_and_assign
op_complement
(paren
id|BMCR_ISOLATE
)paren
suffix:semicolon
id|happy_meal_tcvr_write
c_func
(paren
id|hp
comma
id|tregs
comma
id|DP83840_BMCR
comma
id|hp-&gt;sw_bmcr
)paren
suffix:semicolon
id|tries
op_assign
id|TCVR_UNISOLATE_TRIES
suffix:semicolon
r_while
c_loop
(paren
op_decrement
id|tries
)paren
(brace
id|result
op_assign
id|happy_meal_tcvr_read
c_func
(paren
id|hp
comma
id|tregs
comma
id|DP83840_BMCR
)paren
suffix:semicolon
r_if
c_cond
(paren
id|result
op_eq
id|TCVR_FAILURE
)paren
r_return
op_minus
l_int|1
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|result
op_amp
id|BMCR_ISOLATE
)paren
)paren
r_break
suffix:semicolon
id|udelay
c_func
(paren
l_int|20
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|tries
)paren
(brace
id|ASD
c_func
(paren
(paren
l_string|&quot; FAILED!&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|ASD
c_func
(paren
(paren
l_string|&quot; SUCCESS and CSCONFIG_DFBYPASS&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|is_lucent_phy
c_func
(paren
id|hp
)paren
)paren
(brace
id|result
op_assign
id|happy_meal_tcvr_read
c_func
(paren
id|hp
comma
id|tregs
comma
id|DP83840_CSCONFIG
)paren
suffix:semicolon
id|happy_meal_tcvr_write
c_func
(paren
id|hp
comma
id|tregs
comma
id|DP83840_CSCONFIG
comma
(paren
id|result
op_or
id|CSCONFIG_DFBYPASS
)paren
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Figure out whether we have an internal or external transceiver. */
DECL|function|happy_meal_transceiver_check
r_static
r_void
id|happy_meal_transceiver_check
c_func
(paren
r_struct
id|happy_meal
op_star
id|hp
comma
r_int
r_int
id|tregs
)paren
(brace
r_int
r_int
id|tconfig
op_assign
id|hme_read32
c_func
(paren
id|hp
comma
id|tregs
op_plus
id|TCVR_CFG
)paren
suffix:semicolon
id|ASD
c_func
(paren
(paren
l_string|&quot;happy_meal_transceiver_check: tcfg=%08lx &quot;
comma
id|tconfig
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|hp-&gt;happy_flags
op_amp
id|HFLAG_POLL
)paren
(brace
multiline_comment|/* If we are polling, we must stop to get the transceiver type. */
id|ASD
c_func
(paren
(paren
l_string|&quot;&lt;polling&gt; &quot;
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|hp-&gt;tcvr_type
op_eq
id|internal
)paren
(brace
r_if
c_cond
(paren
id|tconfig
op_amp
id|TCV_CFG_MDIO1
)paren
(brace
id|ASD
c_func
(paren
(paren
l_string|&quot;&lt;internal&gt; &lt;poll stop&gt; &quot;
)paren
)paren
suffix:semicolon
id|happy_meal_poll_stop
c_func
(paren
id|hp
comma
id|tregs
)paren
suffix:semicolon
id|hp-&gt;paddr
op_assign
id|TCV_PADDR_ETX
suffix:semicolon
id|hp-&gt;tcvr_type
op_assign
id|external
suffix:semicolon
id|ASD
c_func
(paren
(paren
l_string|&quot;&lt;external&gt;&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|tconfig
op_and_assign
op_complement
(paren
id|TCV_CFG_PENABLE
)paren
suffix:semicolon
id|tconfig
op_or_assign
id|TCV_CFG_PSELECT
suffix:semicolon
id|hme_write32
c_func
(paren
id|hp
comma
id|tregs
op_plus
id|TCVR_CFG
comma
id|tconfig
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
r_if
c_cond
(paren
id|hp-&gt;tcvr_type
op_eq
id|external
)paren
(brace
id|ASD
c_func
(paren
(paren
l_string|&quot;&lt;external&gt; &quot;
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|hme_read32
c_func
(paren
id|hp
comma
id|tregs
op_plus
id|TCVR_STATUS
)paren
op_rshift
l_int|16
)paren
)paren
(brace
id|ASD
c_func
(paren
(paren
l_string|&quot;&lt;poll stop&gt; &quot;
)paren
)paren
suffix:semicolon
id|happy_meal_poll_stop
c_func
(paren
id|hp
comma
id|tregs
)paren
suffix:semicolon
id|hp-&gt;paddr
op_assign
id|TCV_PADDR_ITX
suffix:semicolon
id|hp-&gt;tcvr_type
op_assign
id|internal
suffix:semicolon
id|ASD
c_func
(paren
(paren
l_string|&quot;&lt;internal&gt;&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|hme_write32
c_func
(paren
id|hp
comma
id|tregs
op_plus
id|TCVR_CFG
comma
id|hme_read32
c_func
(paren
id|hp
comma
id|tregs
op_plus
id|TCVR_CFG
)paren
op_amp
op_complement
(paren
id|TCV_CFG_PSELECT
)paren
)paren
suffix:semicolon
)brace
id|ASD
c_func
(paren
(paren
l_string|&quot;&bslash;n&quot;
)paren
)paren
suffix:semicolon
)brace
r_else
(brace
id|ASD
c_func
(paren
(paren
l_string|&quot;&lt;none&gt;&bslash;n&quot;
)paren
)paren
suffix:semicolon
)brace
)brace
)brace
r_else
(brace
id|u32
id|reread
op_assign
id|hme_read32
c_func
(paren
id|hp
comma
id|tregs
op_plus
id|TCVR_CFG
)paren
suffix:semicolon
multiline_comment|/* Else we can just work off of the MDIO bits. */
id|ASD
c_func
(paren
(paren
l_string|&quot;&lt;not polling&gt; &quot;
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|reread
op_amp
id|TCV_CFG_MDIO1
)paren
(brace
id|hme_write32
c_func
(paren
id|hp
comma
id|tregs
op_plus
id|TCVR_CFG
comma
id|tconfig
op_or
id|TCV_CFG_PSELECT
)paren
suffix:semicolon
id|hp-&gt;paddr
op_assign
id|TCV_PADDR_ETX
suffix:semicolon
id|hp-&gt;tcvr_type
op_assign
id|external
suffix:semicolon
id|ASD
c_func
(paren
(paren
l_string|&quot;&lt;external&gt;&bslash;n&quot;
)paren
)paren
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|reread
op_amp
id|TCV_CFG_MDIO0
)paren
(brace
id|hme_write32
c_func
(paren
id|hp
comma
id|tregs
op_plus
id|TCVR_CFG
comma
id|tconfig
op_amp
op_complement
(paren
id|TCV_CFG_PSELECT
)paren
)paren
suffix:semicolon
id|hp-&gt;paddr
op_assign
id|TCV_PADDR_ITX
suffix:semicolon
id|hp-&gt;tcvr_type
op_assign
id|internal
suffix:semicolon
id|ASD
c_func
(paren
(paren
l_string|&quot;&lt;internal&gt;&bslash;n&quot;
)paren
)paren
suffix:semicolon
)brace
r_else
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;happy meal: Transceiver and a coke please.&quot;
)paren
suffix:semicolon
id|hp-&gt;tcvr_type
op_assign
id|none
suffix:semicolon
multiline_comment|/* Grrr... */
id|ASD
c_func
(paren
(paren
l_string|&quot;&lt;none&gt;&bslash;n&quot;
)paren
)paren
suffix:semicolon
)brace
)brace
)brace
)brace
multiline_comment|/* The receive ring buffers are a bit tricky to get right.  Here goes...&n; *&n; * The buffers we dma into must be 64 byte aligned.  So we use a special&n; * alloc_skb() routine for the happy meal to allocate 64 bytes more than&n; * we really need.&n; *&n; * We use skb_reserve() to align the data block we get in the skb.  We&n; * also program the etxregs-&gt;cfg register to use an offset of 2.  This&n; * imperical constant plus the ethernet header size will always leave&n; * us with a nicely aligned ip header once we pass things up to the&n; * protocol layers.&n; *&n; * The numbers work out to:&n; *&n; *         Max ethernet frame size         1518&n; *         Ethernet header size              14&n; *         Happy Meal base offset             2&n; *&n; * Say a skb data area is at 0xf001b010, and its size alloced is&n; * (ETH_FRAME_LEN + 64 + 2) = (1514 + 64 + 2) = 1580 bytes.&n; *&n; * First our alloc_skb() routine aligns the data base to a 64 byte&n; * boundry.  We now have 0xf001b040 as our skb data address.  We&n; * plug this into the receive descriptor address.&n; *&n; * Next, we skb_reserve() 2 bytes to account for the Happy Meal offset.&n; * So now the data we will end up looking at starts at 0xf001b042.  When&n; * the packet arrives, we will check out the size received and subtract&n; * this from the skb-&gt;length.  Then we just pass the packet up to the&n; * protocols as is, and allocate a new skb to replace this slot we have&n; * just received from.&n; *&n; * The ethernet layer will strip the ether header from the front of the&n; * skb we just sent to it, this leaves us with the ip header sitting&n; * nicely aligned at 0xf001b050.  Also, for tcp and udp packets the&n; * Happy Meal has even checksummed the tcp/udp data for us.  The 16&n; * bit checksum is obtained from the low bits of the receive descriptor&n; * flags, thus:&n; *&n; * &t;skb-&gt;csum = rxd-&gt;rx_flags &amp; 0xffff;&n; * &t;skb-&gt;ip_summed = CHECKSUM_HW;&n; *&n; * before sending off the skb to the protocols, and we are good as gold.&n; */
DECL|function|happy_meal_clean_rings
r_static
r_void
id|happy_meal_clean_rings
c_func
(paren
r_struct
id|happy_meal
op_star
id|hp
)paren
(brace
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|RX_RING_SIZE
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|hp-&gt;rx_skbs
(braket
id|i
)braket
op_ne
l_int|NULL
)paren
(brace
r_struct
id|sk_buff
op_star
id|skb
op_assign
id|hp-&gt;rx_skbs
(braket
id|i
)braket
suffix:semicolon
r_struct
id|happy_meal_rxd
op_star
id|rxd
suffix:semicolon
id|u32
id|dma_addr
suffix:semicolon
id|rxd
op_assign
op_amp
id|hp-&gt;happy_block-&gt;happy_meal_rxd
(braket
id|i
)braket
suffix:semicolon
id|dma_addr
op_assign
id|hme_read_desc32
c_func
(paren
id|hp
comma
op_amp
id|rxd-&gt;rx_addr
)paren
suffix:semicolon
id|hme_dma_unmap
c_func
(paren
id|hp
comma
id|dma_addr
comma
id|RX_BUF_ALLOC_SIZE
comma
id|DMA_FROMDEVICE
)paren
suffix:semicolon
id|dev_kfree_skb_any
c_func
(paren
id|skb
)paren
suffix:semicolon
id|hp-&gt;rx_skbs
(braket
id|i
)braket
op_assign
l_int|NULL
suffix:semicolon
)brace
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|TX_RING_SIZE
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|hp-&gt;tx_skbs
(braket
id|i
)braket
op_ne
l_int|NULL
)paren
(brace
r_struct
id|sk_buff
op_star
id|skb
op_assign
id|hp-&gt;tx_skbs
(braket
id|i
)braket
suffix:semicolon
r_struct
id|happy_meal_txd
op_star
id|txd
suffix:semicolon
id|u32
id|dma_addr
suffix:semicolon
id|txd
op_assign
op_amp
id|hp-&gt;happy_block-&gt;happy_meal_txd
(braket
id|i
)braket
suffix:semicolon
id|dma_addr
op_assign
id|hme_read_desc32
c_func
(paren
id|hp
comma
op_amp
id|txd-&gt;tx_addr
)paren
suffix:semicolon
id|hme_dma_unmap
c_func
(paren
id|hp
comma
id|dma_addr
comma
id|skb-&gt;len
comma
id|DMA_TODEVICE
)paren
suffix:semicolon
id|dev_kfree_skb_any
c_func
(paren
id|skb
)paren
suffix:semicolon
id|hp-&gt;tx_skbs
(braket
id|i
)braket
op_assign
l_int|NULL
suffix:semicolon
)brace
)brace
)brace
DECL|function|happy_meal_init_rings
r_static
r_void
id|happy_meal_init_rings
c_func
(paren
r_struct
id|happy_meal
op_star
id|hp
comma
r_int
id|from_irq
)paren
(brace
r_struct
id|hmeal_init_block
op_star
id|hb
op_assign
id|hp-&gt;happy_block
suffix:semicolon
r_struct
id|net_device
op_star
id|dev
op_assign
id|hp-&gt;dev
suffix:semicolon
r_int
id|i
comma
id|gfp_flags
op_assign
id|GFP_KERNEL
suffix:semicolon
r_if
c_cond
(paren
id|from_irq
op_logical_or
id|in_interrupt
c_func
(paren
)paren
)paren
id|gfp_flags
op_assign
id|GFP_ATOMIC
suffix:semicolon
id|HMD
c_func
(paren
(paren
l_string|&quot;happy_meal_init_rings: counters to zero, &quot;
)paren
)paren
suffix:semicolon
id|hp-&gt;rx_new
op_assign
id|hp-&gt;rx_old
op_assign
id|hp-&gt;tx_new
op_assign
id|hp-&gt;tx_old
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Free any skippy bufs left around in the rings. */
id|HMD
c_func
(paren
(paren
l_string|&quot;clean, &quot;
)paren
)paren
suffix:semicolon
id|happy_meal_clean_rings
c_func
(paren
id|hp
)paren
suffix:semicolon
multiline_comment|/* Now get new skippy bufs for the receive ring. */
id|HMD
c_func
(paren
(paren
l_string|&quot;init rxring, &quot;
)paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|RX_RING_SIZE
suffix:semicolon
id|i
op_increment
)paren
(brace
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
id|skb
op_assign
id|happy_meal_alloc_skb
c_func
(paren
id|RX_BUF_ALLOC_SIZE
comma
id|gfp_flags
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|skb
)paren
(brace
id|hme_write_rxd
c_func
(paren
id|hp
comma
op_amp
id|hb-&gt;happy_meal_rxd
(braket
id|i
)braket
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
id|hp-&gt;rx_skbs
(braket
id|i
)braket
op_assign
id|skb
suffix:semicolon
id|skb-&gt;dev
op_assign
id|dev
suffix:semicolon
multiline_comment|/* Because we reserve afterwards. */
id|skb_put
c_func
(paren
id|skb
comma
(paren
id|ETH_FRAME_LEN
op_plus
id|RX_OFFSET
)paren
)paren
suffix:semicolon
id|hme_write_rxd
c_func
(paren
id|hp
comma
op_amp
id|hb-&gt;happy_meal_rxd
(braket
id|i
)braket
comma
(paren
id|RXFLAG_OWN
op_or
(paren
(paren
id|RX_BUF_ALLOC_SIZE
op_minus
id|RX_OFFSET
)paren
op_lshift
l_int|16
)paren
)paren
comma
id|hme_dma_map
c_func
(paren
id|hp
comma
id|skb-&gt;data
comma
id|RX_BUF_ALLOC_SIZE
comma
id|DMA_FROMDEVICE
)paren
)paren
suffix:semicolon
id|skb_reserve
c_func
(paren
id|skb
comma
id|RX_OFFSET
)paren
suffix:semicolon
)brace
id|HMD
c_func
(paren
(paren
l_string|&quot;init txring, &quot;
)paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|TX_RING_SIZE
suffix:semicolon
id|i
op_increment
)paren
id|hme_write_txd
c_func
(paren
id|hp
comma
op_amp
id|hb-&gt;happy_meal_txd
(braket
id|i
)braket
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
id|HMD
c_func
(paren
(paren
l_string|&quot;done&bslash;n&quot;
)paren
)paren
suffix:semicolon
)brace
DECL|function|happy_meal_begin_auto_negotiation
r_static
r_void
id|happy_meal_begin_auto_negotiation
c_func
(paren
r_struct
id|happy_meal
op_star
id|hp
comma
r_int
r_int
id|tregs
comma
r_struct
id|ethtool_cmd
op_star
id|ep
)paren
(brace
r_int
id|timeout
suffix:semicolon
multiline_comment|/* Read all of the registers we are interested in now. */
id|hp-&gt;sw_bmsr
op_assign
id|happy_meal_tcvr_read
c_func
(paren
id|hp
comma
id|tregs
comma
id|DP83840_BMSR
)paren
suffix:semicolon
id|hp-&gt;sw_bmcr
op_assign
id|happy_meal_tcvr_read
c_func
(paren
id|hp
comma
id|tregs
comma
id|DP83840_BMCR
)paren
suffix:semicolon
id|hp-&gt;sw_physid1
op_assign
id|happy_meal_tcvr_read
c_func
(paren
id|hp
comma
id|tregs
comma
id|DP83840_PHYSID1
)paren
suffix:semicolon
id|hp-&gt;sw_physid2
op_assign
id|happy_meal_tcvr_read
c_func
(paren
id|hp
comma
id|tregs
comma
id|DP83840_PHYSID2
)paren
suffix:semicolon
multiline_comment|/* XXX Check BMSR_ANEGCAPABLE, should not be necessary though. */
id|hp-&gt;sw_advertise
op_assign
id|happy_meal_tcvr_read
c_func
(paren
id|hp
comma
id|tregs
comma
id|DP83840_ADVERTISE
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ep
op_eq
l_int|NULL
op_logical_or
id|ep-&gt;autoneg
op_eq
id|AUTONEG_ENABLE
)paren
(brace
multiline_comment|/* Advertise everything we can support. */
r_if
c_cond
(paren
id|hp-&gt;sw_bmsr
op_amp
id|BMSR_10HALF
)paren
id|hp-&gt;sw_advertise
op_or_assign
(paren
id|ADVERTISE_10HALF
)paren
suffix:semicolon
r_else
id|hp-&gt;sw_advertise
op_and_assign
op_complement
(paren
id|ADVERTISE_10HALF
)paren
suffix:semicolon
r_if
c_cond
(paren
id|hp-&gt;sw_bmsr
op_amp
id|BMSR_10FULL
)paren
id|hp-&gt;sw_advertise
op_or_assign
(paren
id|ADVERTISE_10FULL
)paren
suffix:semicolon
r_else
id|hp-&gt;sw_advertise
op_and_assign
op_complement
(paren
id|ADVERTISE_10FULL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|hp-&gt;sw_bmsr
op_amp
id|BMSR_100HALF
)paren
id|hp-&gt;sw_advertise
op_or_assign
(paren
id|ADVERTISE_100HALF
)paren
suffix:semicolon
r_else
id|hp-&gt;sw_advertise
op_and_assign
op_complement
(paren
id|ADVERTISE_100HALF
)paren
suffix:semicolon
r_if
c_cond
(paren
id|hp-&gt;sw_bmsr
op_amp
id|BMSR_100FULL
)paren
id|hp-&gt;sw_advertise
op_or_assign
(paren
id|ADVERTISE_100FULL
)paren
suffix:semicolon
r_else
id|hp-&gt;sw_advertise
op_and_assign
op_complement
(paren
id|ADVERTISE_100FULL
)paren
suffix:semicolon
id|happy_meal_tcvr_write
c_func
(paren
id|hp
comma
id|tregs
comma
id|DP83840_ADVERTISE
comma
id|hp-&gt;sw_advertise
)paren
suffix:semicolon
multiline_comment|/* XXX Currently no Happy Meal cards I know off support 100BaseT4,&n;&t;&t; * XXX and this is because the DP83840 does not support it, changes&n;&t;&t; * XXX would need to be made to the tx/rx logic in the driver as well&n;&t;&t; * XXX so I completely skip checking for it in the BMSR for now.&n;&t;&t; */
macro_line|#ifdef AUTO_SWITCH_DEBUG
id|ASD
c_func
(paren
(paren
l_string|&quot;%s: Advertising [ &quot;
comma
id|hp-&gt;dev-&gt;name
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|hp-&gt;sw_advertise
op_amp
id|ADVERTISE_10HALF
)paren
id|ASD
c_func
(paren
(paren
l_string|&quot;10H &quot;
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|hp-&gt;sw_advertise
op_amp
id|ADVERTISE_10FULL
)paren
id|ASD
c_func
(paren
(paren
l_string|&quot;10F &quot;
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|hp-&gt;sw_advertise
op_amp
id|ADVERTISE_100HALF
)paren
id|ASD
c_func
(paren
(paren
l_string|&quot;100H &quot;
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|hp-&gt;sw_advertise
op_amp
id|ADVERTISE_100FULL
)paren
id|ASD
c_func
(paren
(paren
l_string|&quot;100F &quot;
)paren
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/* Enable Auto-Negotiation, this is usually on already... */
id|hp-&gt;sw_bmcr
op_or_assign
id|BMCR_ANENABLE
suffix:semicolon
id|happy_meal_tcvr_write
c_func
(paren
id|hp
comma
id|tregs
comma
id|DP83840_BMCR
comma
id|hp-&gt;sw_bmcr
)paren
suffix:semicolon
multiline_comment|/* Restart it to make sure it is going. */
id|hp-&gt;sw_bmcr
op_or_assign
id|BMCR_ANRESTART
suffix:semicolon
id|happy_meal_tcvr_write
c_func
(paren
id|hp
comma
id|tregs
comma
id|DP83840_BMCR
comma
id|hp-&gt;sw_bmcr
)paren
suffix:semicolon
multiline_comment|/* BMCR_ANRESTART self clears when the process has begun. */
id|timeout
op_assign
l_int|64
suffix:semicolon
multiline_comment|/* More than enough. */
r_while
c_loop
(paren
op_decrement
id|timeout
)paren
(brace
id|hp-&gt;sw_bmcr
op_assign
id|happy_meal_tcvr_read
c_func
(paren
id|hp
comma
id|tregs
comma
id|DP83840_BMCR
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|hp-&gt;sw_bmcr
op_amp
id|BMCR_ANRESTART
)paren
)paren
r_break
suffix:semicolon
multiline_comment|/* got it. */
id|udelay
c_func
(paren
l_int|10
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|timeout
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: Happy Meal would not start auto negotiation &quot;
l_string|&quot;BMCR=0x%04x&bslash;n&quot;
comma
id|hp-&gt;dev-&gt;name
comma
id|hp-&gt;sw_bmcr
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;%s: Performing force link detection.&bslash;n&quot;
comma
id|hp-&gt;dev-&gt;name
)paren
suffix:semicolon
r_goto
id|force_link
suffix:semicolon
)brace
r_else
(brace
id|hp-&gt;timer_state
op_assign
id|arbwait
suffix:semicolon
)brace
)brace
r_else
(brace
id|force_link
suffix:colon
multiline_comment|/* Force the link up, trying first a particular mode.&n;&t;&t; * Either we are here at the request of ethtool or&n;&t;&t; * because the Happy Meal would not start to autoneg.&n;&t;&t; */
multiline_comment|/* Disable auto-negotiation in BMCR, enable the duplex and&n;&t;&t; * speed setting, init the timer state machine, and fire it off.&n;&t;&t; */
r_if
c_cond
(paren
id|ep
op_eq
l_int|NULL
op_logical_or
id|ep-&gt;autoneg
op_eq
id|AUTONEG_ENABLE
)paren
(brace
id|hp-&gt;sw_bmcr
op_assign
id|BMCR_SPEED100
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|ep-&gt;speed
op_eq
id|SPEED_100
)paren
id|hp-&gt;sw_bmcr
op_assign
id|BMCR_SPEED100
suffix:semicolon
r_else
id|hp-&gt;sw_bmcr
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|ep-&gt;duplex
op_eq
id|DUPLEX_FULL
)paren
id|hp-&gt;sw_bmcr
op_or_assign
id|BMCR_FULLDPLX
suffix:semicolon
)brace
id|happy_meal_tcvr_write
c_func
(paren
id|hp
comma
id|tregs
comma
id|DP83840_BMCR
comma
id|hp-&gt;sw_bmcr
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|is_lucent_phy
c_func
(paren
id|hp
)paren
)paren
(brace
multiline_comment|/* OK, seems we need do disable the transceiver for the first&n;&t;&t;&t; * tick to make sure we get an accurate link state at the&n;&t;&t;&t; * second tick.&n;&t;&t;&t; */
id|hp-&gt;sw_csconfig
op_assign
id|happy_meal_tcvr_read
c_func
(paren
id|hp
comma
id|tregs
comma
id|DP83840_CSCONFIG
)paren
suffix:semicolon
id|hp-&gt;sw_csconfig
op_and_assign
op_complement
(paren
id|CSCONFIG_TCVDISAB
)paren
suffix:semicolon
id|happy_meal_tcvr_write
c_func
(paren
id|hp
comma
id|tregs
comma
id|DP83840_CSCONFIG
comma
id|hp-&gt;sw_csconfig
)paren
suffix:semicolon
)brace
id|hp-&gt;timer_state
op_assign
id|ltrywait
suffix:semicolon
)brace
id|hp-&gt;timer_ticks
op_assign
l_int|0
suffix:semicolon
id|hp-&gt;happy_timer.expires
op_assign
id|jiffies
op_plus
(paren
l_int|12
op_star
id|HZ
)paren
op_div
l_int|10
suffix:semicolon
multiline_comment|/* 1.2 sec. */
id|hp-&gt;happy_timer.data
op_assign
(paren
r_int
r_int
)paren
id|hp
suffix:semicolon
id|hp-&gt;happy_timer.function
op_assign
op_amp
id|happy_meal_timer
suffix:semicolon
id|add_timer
c_func
(paren
op_amp
id|hp-&gt;happy_timer
)paren
suffix:semicolon
)brace
DECL|macro|CRC_POLYNOMIAL_BE
mdefine_line|#define CRC_POLYNOMIAL_BE 0x04c11db7UL  /* Ethernet CRC, big endian */
DECL|macro|CRC_POLYNOMIAL_LE
mdefine_line|#define CRC_POLYNOMIAL_LE 0xedb88320UL  /* Ethernet CRC, little endian */
DECL|function|happy_meal_init
r_static
r_int
id|happy_meal_init
c_func
(paren
r_struct
id|happy_meal
op_star
id|hp
comma
r_int
id|from_irq
)paren
(brace
r_int
r_int
id|gregs
op_assign
id|hp-&gt;gregs
suffix:semicolon
r_int
r_int
id|etxregs
op_assign
id|hp-&gt;etxregs
suffix:semicolon
r_int
r_int
id|erxregs
op_assign
id|hp-&gt;erxregs
suffix:semicolon
r_int
r_int
id|bregs
op_assign
id|hp-&gt;bigmacregs
suffix:semicolon
r_int
r_int
id|tregs
op_assign
id|hp-&gt;tcvregs
suffix:semicolon
id|u32
id|regtmp
comma
id|rxcfg
suffix:semicolon
r_int
r_char
op_star
id|e
op_assign
op_amp
id|hp-&gt;dev-&gt;dev_addr
(braket
l_int|0
)braket
suffix:semicolon
multiline_comment|/* If auto-negotiation timer is running, kill it. */
id|del_timer
c_func
(paren
op_amp
id|hp-&gt;happy_timer
)paren
suffix:semicolon
id|HMD
c_func
(paren
(paren
l_string|&quot;happy_meal_init: happy_flags[%08x] &quot;
comma
id|hp-&gt;happy_flags
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|hp-&gt;happy_flags
op_amp
id|HFLAG_INIT
)paren
)paren
(brace
id|HMD
c_func
(paren
(paren
l_string|&quot;set HFLAG_INIT, &quot;
)paren
)paren
suffix:semicolon
id|hp-&gt;happy_flags
op_or_assign
id|HFLAG_INIT
suffix:semicolon
id|happy_meal_get_counters
c_func
(paren
id|hp
comma
id|bregs
)paren
suffix:semicolon
)brace
multiline_comment|/* Stop polling. */
id|HMD
c_func
(paren
(paren
l_string|&quot;to happy_meal_poll_stop&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|happy_meal_poll_stop
c_func
(paren
id|hp
comma
id|tregs
)paren
suffix:semicolon
multiline_comment|/* Stop transmitter and receiver. */
id|HMD
c_func
(paren
(paren
l_string|&quot;happy_meal_init: to happy_meal_stop&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|happy_meal_stop
c_func
(paren
id|hp
comma
id|gregs
)paren
suffix:semicolon
multiline_comment|/* Alloc and reset the tx/rx descriptor chains. */
id|HMD
c_func
(paren
(paren
l_string|&quot;happy_meal_init: to happy_meal_init_rings&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|happy_meal_init_rings
c_func
(paren
id|hp
comma
id|from_irq
)paren
suffix:semicolon
multiline_comment|/* Shut up the MIF. */
id|HMD
c_func
(paren
(paren
l_string|&quot;happy_meal_init: Disable all MIF irqs (old[%08x]), &quot;
comma
id|hme_read32
c_func
(paren
id|hp
comma
id|tregs
op_plus
id|TCVR_IMASK
)paren
)paren
)paren
suffix:semicolon
id|hme_write32
c_func
(paren
id|hp
comma
id|tregs
op_plus
id|TCVR_IMASK
comma
l_int|0xffff
)paren
suffix:semicolon
multiline_comment|/* See if we can enable the MIF frame on this card to speak to the DP83840. */
r_if
c_cond
(paren
id|hp-&gt;happy_flags
op_amp
id|HFLAG_FENABLE
)paren
(brace
id|HMD
c_func
(paren
(paren
l_string|&quot;use frame old[%08x], &quot;
comma
id|hme_read32
c_func
(paren
id|hp
comma
id|tregs
op_plus
id|TCVR_CFG
)paren
)paren
)paren
suffix:semicolon
id|hme_write32
c_func
(paren
id|hp
comma
id|tregs
op_plus
id|TCVR_CFG
comma
id|hme_read32
c_func
(paren
id|hp
comma
id|tregs
op_plus
id|TCVR_CFG
)paren
op_amp
op_complement
(paren
id|TCV_CFG_BENABLE
)paren
)paren
suffix:semicolon
)brace
r_else
(brace
id|HMD
c_func
(paren
(paren
l_string|&quot;use bitbang old[%08x], &quot;
comma
id|hme_read32
c_func
(paren
id|hp
comma
id|tregs
op_plus
id|TCVR_CFG
)paren
)paren
)paren
suffix:semicolon
id|hme_write32
c_func
(paren
id|hp
comma
id|tregs
op_plus
id|TCVR_CFG
comma
id|hme_read32
c_func
(paren
id|hp
comma
id|tregs
op_plus
id|TCVR_CFG
)paren
op_or
id|TCV_CFG_BENABLE
)paren
suffix:semicolon
)brace
multiline_comment|/* Check the state of the transceiver. */
id|HMD
c_func
(paren
(paren
l_string|&quot;to happy_meal_transceiver_check&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|happy_meal_transceiver_check
c_func
(paren
id|hp
comma
id|tregs
)paren
suffix:semicolon
multiline_comment|/* Put the Big Mac into a sane state. */
id|HMD
c_func
(paren
(paren
l_string|&quot;happy_meal_init: &quot;
)paren
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|hp-&gt;tcvr_type
)paren
(brace
r_case
id|none
suffix:colon
multiline_comment|/* Cannot operate if we don&squot;t know the transceiver type! */
id|HMD
c_func
(paren
(paren
l_string|&quot;AAIEEE no transceiver type, EAGAIN&quot;
)paren
)paren
suffix:semicolon
r_return
op_minus
id|EAGAIN
suffix:semicolon
r_case
id|internal
suffix:colon
multiline_comment|/* Using the MII buffers. */
id|HMD
c_func
(paren
(paren
l_string|&quot;internal, using MII, &quot;
)paren
)paren
suffix:semicolon
id|hme_write32
c_func
(paren
id|hp
comma
id|bregs
op_plus
id|BMAC_XIFCFG
comma
l_int|0
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|external
suffix:colon
multiline_comment|/* Not using the MII, disable it. */
id|HMD
c_func
(paren
(paren
l_string|&quot;external, disable MII, &quot;
)paren
)paren
suffix:semicolon
id|hme_write32
c_func
(paren
id|hp
comma
id|bregs
op_plus
id|BMAC_XIFCFG
comma
id|BIGMAC_XCFG_MIIDISAB
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
suffix:semicolon
r_if
c_cond
(paren
id|happy_meal_tcvr_reset
c_func
(paren
id|hp
comma
id|tregs
)paren
)paren
r_return
op_minus
id|EAGAIN
suffix:semicolon
multiline_comment|/* Reset the Happy Meal Big Mac transceiver and the receiver. */
id|HMD
c_func
(paren
(paren
l_string|&quot;tx/rx reset, &quot;
)paren
)paren
suffix:semicolon
id|happy_meal_tx_reset
c_func
(paren
id|hp
comma
id|bregs
)paren
suffix:semicolon
id|happy_meal_rx_reset
c_func
(paren
id|hp
comma
id|bregs
)paren
suffix:semicolon
multiline_comment|/* Set jam size and inter-packet gaps to reasonable defaults. */
id|HMD
c_func
(paren
(paren
l_string|&quot;jsize/ipg1/ipg2, &quot;
)paren
)paren
suffix:semicolon
id|hme_write32
c_func
(paren
id|hp
comma
id|bregs
op_plus
id|BMAC_JSIZE
comma
id|DEFAULT_JAMSIZE
)paren
suffix:semicolon
id|hme_write32
c_func
(paren
id|hp
comma
id|bregs
op_plus
id|BMAC_IGAP1
comma
id|DEFAULT_IPG1
)paren
suffix:semicolon
id|hme_write32
c_func
(paren
id|hp
comma
id|bregs
op_plus
id|BMAC_IGAP2
comma
id|DEFAULT_IPG2
)paren
suffix:semicolon
multiline_comment|/* Load up the MAC address and random seed. */
id|HMD
c_func
(paren
(paren
l_string|&quot;rseed/macaddr, &quot;
)paren
)paren
suffix:semicolon
multiline_comment|/* The docs recommend to use the 10LSB of our MAC here. */
id|hme_write32
c_func
(paren
id|hp
comma
id|bregs
op_plus
id|BMAC_RSEED
comma
(paren
(paren
id|e
(braket
l_int|5
)braket
op_or
id|e
(braket
l_int|4
)braket
op_lshift
l_int|8
)paren
op_amp
l_int|0x3ff
)paren
)paren
suffix:semicolon
id|hme_write32
c_func
(paren
id|hp
comma
id|bregs
op_plus
id|BMAC_MACADDR2
comma
(paren
(paren
id|e
(braket
l_int|4
)braket
op_lshift
l_int|8
)paren
op_or
id|e
(braket
l_int|5
)braket
)paren
)paren
suffix:semicolon
id|hme_write32
c_func
(paren
id|hp
comma
id|bregs
op_plus
id|BMAC_MACADDR1
comma
(paren
(paren
id|e
(braket
l_int|2
)braket
op_lshift
l_int|8
)paren
op_or
id|e
(braket
l_int|3
)braket
)paren
)paren
suffix:semicolon
id|hme_write32
c_func
(paren
id|hp
comma
id|bregs
op_plus
id|BMAC_MACADDR0
comma
(paren
(paren
id|e
(braket
l_int|0
)braket
op_lshift
l_int|8
)paren
op_or
id|e
(braket
l_int|1
)braket
)paren
)paren
suffix:semicolon
id|HMD
c_func
(paren
(paren
l_string|&quot;htable, &quot;
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|hp-&gt;dev-&gt;flags
op_amp
id|IFF_ALLMULTI
)paren
op_logical_or
(paren
id|hp-&gt;dev-&gt;mc_count
OG
l_int|64
)paren
)paren
(brace
id|hme_write32
c_func
(paren
id|hp
comma
id|bregs
op_plus
id|BMAC_HTABLE0
comma
l_int|0xffff
)paren
suffix:semicolon
id|hme_write32
c_func
(paren
id|hp
comma
id|bregs
op_plus
id|BMAC_HTABLE1
comma
l_int|0xffff
)paren
suffix:semicolon
id|hme_write32
c_func
(paren
id|hp
comma
id|bregs
op_plus
id|BMAC_HTABLE2
comma
l_int|0xffff
)paren
suffix:semicolon
id|hme_write32
c_func
(paren
id|hp
comma
id|bregs
op_plus
id|BMAC_HTABLE3
comma
l_int|0xffff
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
(paren
id|hp-&gt;dev-&gt;flags
op_amp
id|IFF_PROMISC
)paren
op_eq
l_int|0
)paren
(brace
id|u16
id|hash_table
(braket
l_int|4
)braket
suffix:semicolon
r_struct
id|dev_mc_list
op_star
id|dmi
op_assign
id|hp-&gt;dev-&gt;mc_list
suffix:semicolon
r_char
op_star
id|addrs
suffix:semicolon
r_int
id|i
comma
id|j
comma
id|bit
comma
id|byte
suffix:semicolon
id|u32
id|crc
comma
id|poly
op_assign
id|CRC_POLYNOMIAL_LE
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|4
suffix:semicolon
id|i
op_increment
)paren
id|hash_table
(braket
id|i
)braket
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|hp-&gt;dev-&gt;mc_count
suffix:semicolon
id|i
op_increment
)paren
(brace
id|addrs
op_assign
id|dmi-&gt;dmi_addr
suffix:semicolon
id|dmi
op_assign
id|dmi-&gt;next
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
op_star
id|addrs
op_amp
l_int|1
)paren
)paren
r_continue
suffix:semicolon
id|crc
op_assign
l_int|0xffffffffU
suffix:semicolon
r_for
c_loop
(paren
id|byte
op_assign
l_int|0
suffix:semicolon
id|byte
OL
l_int|6
suffix:semicolon
id|byte
op_increment
)paren
(brace
r_for
c_loop
(paren
id|bit
op_assign
op_star
id|addrs
op_increment
comma
id|j
op_assign
l_int|0
suffix:semicolon
id|j
OL
l_int|8
suffix:semicolon
id|j
op_increment
comma
id|bit
op_rshift_assign
l_int|1
)paren
(brace
r_int
id|test
suffix:semicolon
id|test
op_assign
(paren
(paren
id|bit
op_xor
id|crc
)paren
op_amp
l_int|0x01
)paren
suffix:semicolon
id|crc
op_rshift_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|test
)paren
id|crc
op_assign
id|crc
op_xor
id|poly
suffix:semicolon
)brace
)brace
id|crc
op_rshift_assign
l_int|26
suffix:semicolon
id|hash_table
(braket
id|crc
op_rshift
l_int|4
)braket
op_or_assign
l_int|1
op_lshift
(paren
id|crc
op_amp
l_int|0xf
)paren
suffix:semicolon
)brace
id|hme_write32
c_func
(paren
id|hp
comma
id|bregs
op_plus
id|BMAC_HTABLE0
comma
id|hash_table
(braket
l_int|0
)braket
)paren
suffix:semicolon
id|hme_write32
c_func
(paren
id|hp
comma
id|bregs
op_plus
id|BMAC_HTABLE1
comma
id|hash_table
(braket
l_int|1
)braket
)paren
suffix:semicolon
id|hme_write32
c_func
(paren
id|hp
comma
id|bregs
op_plus
id|BMAC_HTABLE2
comma
id|hash_table
(braket
l_int|2
)braket
)paren
suffix:semicolon
id|hme_write32
c_func
(paren
id|hp
comma
id|bregs
op_plus
id|BMAC_HTABLE3
comma
id|hash_table
(braket
l_int|3
)braket
)paren
suffix:semicolon
)brace
r_else
(brace
id|hme_write32
c_func
(paren
id|hp
comma
id|bregs
op_plus
id|BMAC_HTABLE3
comma
l_int|0
)paren
suffix:semicolon
id|hme_write32
c_func
(paren
id|hp
comma
id|bregs
op_plus
id|BMAC_HTABLE2
comma
l_int|0
)paren
suffix:semicolon
id|hme_write32
c_func
(paren
id|hp
comma
id|bregs
op_plus
id|BMAC_HTABLE1
comma
l_int|0
)paren
suffix:semicolon
id|hme_write32
c_func
(paren
id|hp
comma
id|bregs
op_plus
id|BMAC_HTABLE0
comma
l_int|0
)paren
suffix:semicolon
)brace
multiline_comment|/* Set the RX and TX ring ptrs. */
id|HMD
c_func
(paren
(paren
l_string|&quot;ring ptrs rxr[%08x] txr[%08x]&bslash;n&quot;
comma
(paren
id|hp-&gt;hblock_dvma
op_plus
id|hblock_offset
c_func
(paren
id|happy_meal_rxd
comma
l_int|0
)paren
)paren
comma
(paren
id|hp-&gt;hblock_dvma
op_plus
id|hblock_offset
c_func
(paren
id|happy_meal_txd
comma
l_int|0
)paren
)paren
)paren
)paren
suffix:semicolon
id|hme_write32
c_func
(paren
id|hp
comma
id|erxregs
op_plus
id|ERX_RING
comma
(paren
id|hp-&gt;hblock_dvma
op_plus
id|hblock_offset
c_func
(paren
id|happy_meal_rxd
comma
l_int|0
)paren
)paren
)paren
suffix:semicolon
id|hme_write32
c_func
(paren
id|hp
comma
id|etxregs
op_plus
id|ETX_RING
comma
(paren
id|hp-&gt;hblock_dvma
op_plus
id|hblock_offset
c_func
(paren
id|happy_meal_txd
comma
l_int|0
)paren
)paren
)paren
suffix:semicolon
multiline_comment|/* Set the supported burst sizes. */
id|HMD
c_func
(paren
(paren
l_string|&quot;happy_meal_init: old[%08x] bursts&lt;&quot;
comma
id|hme_read32
c_func
(paren
id|hp
comma
id|gregs
op_plus
id|GREG_CFG
)paren
)paren
)paren
suffix:semicolon
macro_line|#ifndef __sparc__
multiline_comment|/* It is always PCI and can handle 64byte bursts. */
id|hme_write32
c_func
(paren
id|hp
comma
id|gregs
op_plus
id|GREG_CFG
comma
id|GREG_CFG_BURST64
)paren
suffix:semicolon
macro_line|#else
r_if
c_cond
(paren
(paren
id|hp-&gt;happy_bursts
op_amp
id|DMA_BURST64
)paren
op_logical_and
(paren
(paren
id|hp-&gt;happy_flags
op_amp
id|HFLAG_PCI
)paren
op_ne
l_int|0
macro_line|#ifdef CONFIG_SBUS
op_logical_or
id|sbus_can_burst64
c_func
(paren
id|hp-&gt;happy_dev
)paren
macro_line|#endif
op_logical_or
l_int|0
)paren
)paren
(brace
id|u32
id|gcfg
op_assign
id|GREG_CFG_BURST64
suffix:semicolon
multiline_comment|/* I have no idea if I should set the extended&n;&t;&t; * transfer mode bit for Cheerio, so for now I&n;&t;&t; * do not.  -DaveM&n;&t;&t; */
macro_line|#ifdef CONFIG_SBUS
r_if
c_cond
(paren
(paren
id|hp-&gt;happy_flags
op_amp
id|HFLAG_PCI
)paren
op_eq
l_int|0
op_logical_and
id|sbus_can_dma_64bit
c_func
(paren
id|hp-&gt;happy_dev
)paren
)paren
(brace
id|sbus_set_sbus64
c_func
(paren
id|hp-&gt;happy_dev
comma
id|hp-&gt;happy_bursts
)paren
suffix:semicolon
id|gcfg
op_or_assign
id|GREG_CFG_64BIT
suffix:semicolon
)brace
macro_line|#endif
id|HMD
c_func
(paren
(paren
l_string|&quot;64&gt;&quot;
)paren
)paren
suffix:semicolon
id|hme_write32
c_func
(paren
id|hp
comma
id|gregs
op_plus
id|GREG_CFG
comma
id|gcfg
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|hp-&gt;happy_bursts
op_amp
id|DMA_BURST32
)paren
(brace
id|HMD
c_func
(paren
(paren
l_string|&quot;32&gt;&quot;
)paren
)paren
suffix:semicolon
id|hme_write32
c_func
(paren
id|hp
comma
id|gregs
op_plus
id|GREG_CFG
comma
id|GREG_CFG_BURST32
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|hp-&gt;happy_bursts
op_amp
id|DMA_BURST16
)paren
(brace
id|HMD
c_func
(paren
(paren
l_string|&quot;16&gt;&quot;
)paren
)paren
suffix:semicolon
id|hme_write32
c_func
(paren
id|hp
comma
id|gregs
op_plus
id|GREG_CFG
comma
id|GREG_CFG_BURST16
)paren
suffix:semicolon
)brace
r_else
(brace
id|HMD
c_func
(paren
(paren
l_string|&quot;XXX&gt;&quot;
)paren
)paren
suffix:semicolon
id|hme_write32
c_func
(paren
id|hp
comma
id|gregs
op_plus
id|GREG_CFG
comma
l_int|0
)paren
suffix:semicolon
)brace
macro_line|#endif /* __sparc__ */
multiline_comment|/* Turn off interrupts we do not want to hear. */
id|HMD
c_func
(paren
(paren
l_string|&quot;, enable global interrupts, &quot;
)paren
)paren
suffix:semicolon
id|hme_write32
c_func
(paren
id|hp
comma
id|gregs
op_plus
id|GREG_IMASK
comma
(paren
id|GREG_IMASK_GOTFRAME
op_or
id|GREG_IMASK_RCNTEXP
op_or
id|GREG_IMASK_SENTFRAME
op_or
id|GREG_IMASK_TXPERR
)paren
)paren
suffix:semicolon
multiline_comment|/* Set the transmit ring buffer size. */
id|HMD
c_func
(paren
(paren
l_string|&quot;tx rsize=%d oreg[%08x], &quot;
comma
(paren
r_int
)paren
id|TX_RING_SIZE
comma
id|hme_read32
c_func
(paren
id|hp
comma
id|etxregs
op_plus
id|ETX_RSIZE
)paren
)paren
)paren
suffix:semicolon
id|hme_write32
c_func
(paren
id|hp
comma
id|etxregs
op_plus
id|ETX_RSIZE
comma
(paren
id|TX_RING_SIZE
op_rshift
id|ETX_RSIZE_SHIFT
)paren
op_minus
l_int|1
)paren
suffix:semicolon
multiline_comment|/* Enable transmitter DVMA. */
id|HMD
c_func
(paren
(paren
l_string|&quot;tx dma enable old[%08x], &quot;
comma
id|hme_read32
c_func
(paren
id|hp
comma
id|etxregs
op_plus
id|ETX_CFG
)paren
)paren
)paren
suffix:semicolon
id|hme_write32
c_func
(paren
id|hp
comma
id|etxregs
op_plus
id|ETX_CFG
comma
id|hme_read32
c_func
(paren
id|hp
comma
id|etxregs
op_plus
id|ETX_CFG
)paren
op_or
id|ETX_CFG_DMAENABLE
)paren
suffix:semicolon
multiline_comment|/* This chip really rots, for the receiver sometimes when you&n;&t; * write to it&squot;s control registers not all the bits get there&n;&t; * properly.  I cannot think of a sane way to provide complete&n;&t; * coverage for this hardware bug yet.&n;&t; */
id|HMD
c_func
(paren
(paren
l_string|&quot;erx regs bug old[%08x]&bslash;n&quot;
comma
id|hme_read32
c_func
(paren
id|hp
comma
id|erxregs
op_plus
id|ERX_CFG
)paren
)paren
)paren
suffix:semicolon
id|hme_write32
c_func
(paren
id|hp
comma
id|erxregs
op_plus
id|ERX_CFG
comma
id|ERX_CFG_DEFAULT
c_func
(paren
id|RX_OFFSET
)paren
)paren
suffix:semicolon
id|regtmp
op_assign
id|hme_read32
c_func
(paren
id|hp
comma
id|erxregs
op_plus
id|ERX_CFG
)paren
suffix:semicolon
id|hme_write32
c_func
(paren
id|hp
comma
id|erxregs
op_plus
id|ERX_CFG
comma
id|ERX_CFG_DEFAULT
c_func
(paren
id|RX_OFFSET
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|hme_read32
c_func
(paren
id|hp
comma
id|erxregs
op_plus
id|ERX_CFG
)paren
op_ne
id|ERX_CFG_DEFAULT
c_func
(paren
id|RX_OFFSET
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;happy meal: Eieee, rx config register gets greasy fries.&bslash;n&quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;happy meal: Trying to set %08x, reread gives %08x&bslash;n&quot;
comma
id|ERX_CFG_DEFAULT
c_func
(paren
id|RX_OFFSET
)paren
comma
id|regtmp
)paren
suffix:semicolon
multiline_comment|/* XXX Should return failure here... */
)brace
multiline_comment|/* Enable Big Mac hash table filter. */
id|HMD
c_func
(paren
(paren
l_string|&quot;happy_meal_init: enable hash rx_cfg_old[%08x], &quot;
comma
id|hme_read32
c_func
(paren
id|hp
comma
id|bregs
op_plus
id|BMAC_RXCFG
)paren
)paren
)paren
suffix:semicolon
id|rxcfg
op_assign
id|BIGMAC_RXCFG_HENABLE
suffix:semicolon
r_if
c_cond
(paren
id|hp-&gt;dev-&gt;flags
op_amp
id|IFF_PROMISC
)paren
id|rxcfg
op_or_assign
id|BIGMAC_RXCFG_PMISC
suffix:semicolon
id|hme_write32
c_func
(paren
id|hp
comma
id|bregs
op_plus
id|BMAC_RXCFG
comma
id|rxcfg
)paren
suffix:semicolon
multiline_comment|/* Let the bits settle in the chip. */
id|udelay
c_func
(paren
l_int|10
)paren
suffix:semicolon
multiline_comment|/* Ok, configure the Big Mac transmitter. */
id|HMD
c_func
(paren
(paren
l_string|&quot;BIGMAC init, &quot;
)paren
)paren
suffix:semicolon
id|regtmp
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|hp-&gt;happy_flags
op_amp
id|HFLAG_FULL
)paren
id|regtmp
op_or_assign
id|BIGMAC_TXCFG_FULLDPLX
suffix:semicolon
id|hme_write32
c_func
(paren
id|hp
comma
id|bregs
op_plus
id|BMAC_TXCFG
comma
id|regtmp
op_or
id|BIGMAC_TXCFG_DGIVEUP
)paren
suffix:semicolon
multiline_comment|/* Enable the output drivers no matter what. */
id|regtmp
op_assign
id|BIGMAC_XCFG_ODENABLE
suffix:semicolon
multiline_comment|/* If card can do lance mode, enable it. */
r_if
c_cond
(paren
id|hp-&gt;happy_flags
op_amp
id|HFLAG_LANCE
)paren
id|regtmp
op_or_assign
(paren
id|DEFAULT_IPG0
op_lshift
l_int|5
)paren
op_or
id|BIGMAC_XCFG_LANCE
suffix:semicolon
multiline_comment|/* Disable the MII buffers if using external transceiver. */
r_if
c_cond
(paren
id|hp-&gt;tcvr_type
op_eq
id|external
)paren
id|regtmp
op_or_assign
id|BIGMAC_XCFG_MIIDISAB
suffix:semicolon
id|HMD
c_func
(paren
(paren
l_string|&quot;XIF config old[%08x], &quot;
comma
id|hme_read32
c_func
(paren
id|hp
comma
id|bregs
op_plus
id|BMAC_XIFCFG
)paren
)paren
)paren
suffix:semicolon
id|hme_write32
c_func
(paren
id|hp
comma
id|bregs
op_plus
id|BMAC_XIFCFG
comma
id|regtmp
)paren
suffix:semicolon
multiline_comment|/* Start things up. */
id|HMD
c_func
(paren
(paren
l_string|&quot;tx old[%08x] and rx [%08x] ON!&bslash;n&quot;
comma
id|hme_read32
c_func
(paren
id|hp
comma
id|bregs
op_plus
id|BMAC_TXCFG
)paren
comma
id|hme_read32
c_func
(paren
id|hp
comma
id|bregs
op_plus
id|BMAC_RXCFG
)paren
)paren
)paren
suffix:semicolon
id|hme_write32
c_func
(paren
id|hp
comma
id|bregs
op_plus
id|BMAC_TXCFG
comma
id|hme_read32
c_func
(paren
id|hp
comma
id|bregs
op_plus
id|BMAC_TXCFG
)paren
op_or
id|BIGMAC_TXCFG_ENABLE
)paren
suffix:semicolon
id|hme_write32
c_func
(paren
id|hp
comma
id|bregs
op_plus
id|BMAC_RXCFG
comma
id|hme_read32
c_func
(paren
id|hp
comma
id|bregs
op_plus
id|BMAC_RXCFG
)paren
op_or
id|BIGMAC_RXCFG_ENABLE
)paren
suffix:semicolon
multiline_comment|/* Get the autonegotiation started, and the watch timer ticking. */
id|happy_meal_begin_auto_negotiation
c_func
(paren
id|hp
comma
id|tregs
comma
l_int|NULL
)paren
suffix:semicolon
multiline_comment|/* Success. */
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|happy_meal_set_initial_advertisement
r_static
r_void
id|happy_meal_set_initial_advertisement
c_func
(paren
r_struct
id|happy_meal
op_star
id|hp
)paren
(brace
r_int
r_int
id|tregs
op_assign
id|hp-&gt;tcvregs
suffix:semicolon
r_int
r_int
id|bregs
op_assign
id|hp-&gt;bigmacregs
suffix:semicolon
r_int
r_int
id|gregs
op_assign
id|hp-&gt;gregs
suffix:semicolon
id|happy_meal_stop
c_func
(paren
id|hp
comma
id|gregs
)paren
suffix:semicolon
id|hme_write32
c_func
(paren
id|hp
comma
id|tregs
op_plus
id|TCVR_IMASK
comma
l_int|0xffff
)paren
suffix:semicolon
r_if
c_cond
(paren
id|hp-&gt;happy_flags
op_amp
id|HFLAG_FENABLE
)paren
id|hme_write32
c_func
(paren
id|hp
comma
id|tregs
op_plus
id|TCVR_CFG
comma
id|hme_read32
c_func
(paren
id|hp
comma
id|tregs
op_plus
id|TCVR_CFG
)paren
op_amp
op_complement
(paren
id|TCV_CFG_BENABLE
)paren
)paren
suffix:semicolon
r_else
id|hme_write32
c_func
(paren
id|hp
comma
id|tregs
op_plus
id|TCVR_CFG
comma
id|hme_read32
c_func
(paren
id|hp
comma
id|tregs
op_plus
id|TCVR_CFG
)paren
op_or
id|TCV_CFG_BENABLE
)paren
suffix:semicolon
id|happy_meal_transceiver_check
c_func
(paren
id|hp
comma
id|tregs
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|hp-&gt;tcvr_type
)paren
(brace
r_case
id|none
suffix:colon
r_return
suffix:semicolon
r_case
id|internal
suffix:colon
id|hme_write32
c_func
(paren
id|hp
comma
id|bregs
op_plus
id|BMAC_XIFCFG
comma
l_int|0
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|external
suffix:colon
id|hme_write32
c_func
(paren
id|hp
comma
id|bregs
op_plus
id|BMAC_XIFCFG
comma
id|BIGMAC_XCFG_MIIDISAB
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
suffix:semicolon
r_if
c_cond
(paren
id|happy_meal_tcvr_reset
c_func
(paren
id|hp
comma
id|tregs
)paren
)paren
r_return
suffix:semicolon
multiline_comment|/* Latch PHY registers as of now. */
id|hp-&gt;sw_bmsr
op_assign
id|happy_meal_tcvr_read
c_func
(paren
id|hp
comma
id|tregs
comma
id|DP83840_BMSR
)paren
suffix:semicolon
id|hp-&gt;sw_advertise
op_assign
id|happy_meal_tcvr_read
c_func
(paren
id|hp
comma
id|tregs
comma
id|DP83840_ADVERTISE
)paren
suffix:semicolon
multiline_comment|/* Advertise everything we can support. */
r_if
c_cond
(paren
id|hp-&gt;sw_bmsr
op_amp
id|BMSR_10HALF
)paren
id|hp-&gt;sw_advertise
op_or_assign
(paren
id|ADVERTISE_10HALF
)paren
suffix:semicolon
r_else
id|hp-&gt;sw_advertise
op_and_assign
op_complement
(paren
id|ADVERTISE_10HALF
)paren
suffix:semicolon
r_if
c_cond
(paren
id|hp-&gt;sw_bmsr
op_amp
id|BMSR_10FULL
)paren
id|hp-&gt;sw_advertise
op_or_assign
(paren
id|ADVERTISE_10FULL
)paren
suffix:semicolon
r_else
id|hp-&gt;sw_advertise
op_and_assign
op_complement
(paren
id|ADVERTISE_10FULL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|hp-&gt;sw_bmsr
op_amp
id|BMSR_100HALF
)paren
id|hp-&gt;sw_advertise
op_or_assign
(paren
id|ADVERTISE_100HALF
)paren
suffix:semicolon
r_else
id|hp-&gt;sw_advertise
op_and_assign
op_complement
(paren
id|ADVERTISE_100HALF
)paren
suffix:semicolon
r_if
c_cond
(paren
id|hp-&gt;sw_bmsr
op_amp
id|BMSR_100FULL
)paren
id|hp-&gt;sw_advertise
op_or_assign
(paren
id|ADVERTISE_100FULL
)paren
suffix:semicolon
r_else
id|hp-&gt;sw_advertise
op_and_assign
op_complement
(paren
id|ADVERTISE_100FULL
)paren
suffix:semicolon
multiline_comment|/* Update the PHY advertisement register. */
id|happy_meal_tcvr_write
c_func
(paren
id|hp
comma
id|tregs
comma
id|DP83840_ADVERTISE
comma
id|hp-&gt;sw_advertise
)paren
suffix:semicolon
)brace
multiline_comment|/* Once status is latched (by happy_meal_interrupt) it is cleared by&n; * the hardware, so we cannot re-read it and get a correct value.&n; */
DECL|function|happy_meal_is_not_so_happy
r_static
r_int
id|happy_meal_is_not_so_happy
c_func
(paren
r_struct
id|happy_meal
op_star
id|hp
comma
id|u32
id|status
)paren
(brace
r_int
id|reset
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Only print messages for non-counter related interrupts. */
r_if
c_cond
(paren
id|status
op_amp
(paren
id|GREG_STAT_STSTERR
op_or
id|GREG_STAT_TFIFO_UND
op_or
id|GREG_STAT_MAXPKTERR
op_or
id|GREG_STAT_RXERR
op_or
id|GREG_STAT_RXPERR
op_or
id|GREG_STAT_RXTERR
op_or
id|GREG_STAT_EOPERR
op_or
id|GREG_STAT_MIFIRQ
op_or
id|GREG_STAT_TXEACK
op_or
id|GREG_STAT_TXLERR
op_or
id|GREG_STAT_TXPERR
op_or
id|GREG_STAT_TXTERR
op_or
id|GREG_STAT_SLVERR
op_or
id|GREG_STAT_SLVPERR
)paren
)paren
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: Error interrupt for happy meal, status = %08x&bslash;n&quot;
comma
id|hp-&gt;dev-&gt;name
comma
id|status
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
id|GREG_STAT_RFIFOVF
)paren
(brace
multiline_comment|/* Receive FIFO overflow is harmless and the hardware will take&n;&t;&t;   care of it, just some packets are lost. Who cares. */
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%s: Happy Meal receive FIFO overflow.&bslash;n&quot;
comma
id|hp-&gt;dev-&gt;name
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|status
op_amp
id|GREG_STAT_STSTERR
)paren
(brace
multiline_comment|/* BigMAC SQE link test failed. */
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: Happy Meal BigMAC SQE test failed.&bslash;n&quot;
comma
id|hp-&gt;dev-&gt;name
)paren
suffix:semicolon
id|reset
op_assign
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|status
op_amp
id|GREG_STAT_TFIFO_UND
)paren
(brace
multiline_comment|/* Transmit FIFO underrun, again DMA error likely. */
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: Happy Meal transmitter FIFO underrun, DMA error.&bslash;n&quot;
comma
id|hp-&gt;dev-&gt;name
)paren
suffix:semicolon
id|reset
op_assign
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|status
op_amp
id|GREG_STAT_MAXPKTERR
)paren
(brace
multiline_comment|/* Driver error, tried to transmit something larger&n;&t;&t; * than ethernet max mtu.&n;&t;&t; */
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: Happy Meal MAX Packet size error.&bslash;n&quot;
comma
id|hp-&gt;dev-&gt;name
)paren
suffix:semicolon
id|reset
op_assign
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|status
op_amp
id|GREG_STAT_NORXD
)paren
(brace
multiline_comment|/* This is harmless, it just means the system is&n;&t;&t; * quite loaded and the incomming packet rate was&n;&t;&t; * faster than the interrupt handler could keep up&n;&t;&t; * with.&n;&t;&t; */
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Happy Meal out of receive &quot;
l_string|&quot;descriptors, packet dropped.&bslash;n&quot;
comma
id|hp-&gt;dev-&gt;name
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|status
op_amp
(paren
id|GREG_STAT_RXERR
op_or
id|GREG_STAT_RXPERR
op_or
id|GREG_STAT_RXTERR
)paren
)paren
(brace
multiline_comment|/* All sorts of DMA receive errors. */
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: Happy Meal rx DMA errors [ &quot;
comma
id|hp-&gt;dev-&gt;name
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
id|GREG_STAT_RXERR
)paren
id|printk
c_func
(paren
l_string|&quot;GenericError &quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
id|GREG_STAT_RXPERR
)paren
id|printk
c_func
(paren
l_string|&quot;ParityError &quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
id|GREG_STAT_RXTERR
)paren
id|printk
c_func
(paren
l_string|&quot;RxTagBotch &quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;]&bslash;n&quot;
)paren
suffix:semicolon
id|reset
op_assign
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|status
op_amp
id|GREG_STAT_EOPERR
)paren
(brace
multiline_comment|/* Driver bug, didn&squot;t set EOP bit in tx descriptor given&n;&t;&t; * to the happy meal.&n;&t;&t; */
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: EOP not set in happy meal transmit descriptor!&bslash;n&quot;
comma
id|hp-&gt;dev-&gt;name
)paren
suffix:semicolon
id|reset
op_assign
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|status
op_amp
id|GREG_STAT_MIFIRQ
)paren
(brace
multiline_comment|/* MIF signalled an interrupt, were we polling it? */
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: Happy Meal MIF interrupt.&bslash;n&quot;
comma
id|hp-&gt;dev-&gt;name
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|status
op_amp
(paren
id|GREG_STAT_TXEACK
op_or
id|GREG_STAT_TXLERR
op_or
id|GREG_STAT_TXPERR
op_or
id|GREG_STAT_TXTERR
)paren
)paren
(brace
multiline_comment|/* All sorts of transmit DMA errors. */
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: Happy Meal tx DMA errors [ &quot;
comma
id|hp-&gt;dev-&gt;name
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
id|GREG_STAT_TXEACK
)paren
id|printk
c_func
(paren
l_string|&quot;GenericError &quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
id|GREG_STAT_TXLERR
)paren
id|printk
c_func
(paren
l_string|&quot;LateError &quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
id|GREG_STAT_TXPERR
)paren
id|printk
c_func
(paren
l_string|&quot;ParityErro &quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
id|GREG_STAT_TXTERR
)paren
id|printk
c_func
(paren
l_string|&quot;TagBotch &quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;]&bslash;n&quot;
)paren
suffix:semicolon
id|reset
op_assign
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|status
op_amp
(paren
id|GREG_STAT_SLVERR
op_or
id|GREG_STAT_SLVPERR
)paren
)paren
(brace
multiline_comment|/* Bus or parity error when cpu accessed happy meal registers&n;&t;&t; * or it&squot;s internal FIFO&squot;s.  Should never see this.&n;&t;&t; */
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: Happy Meal register access SBUS slave (%s) error.&bslash;n&quot;
comma
id|hp-&gt;dev-&gt;name
comma
(paren
id|status
op_amp
id|GREG_STAT_SLVPERR
)paren
ques
c_cond
l_string|&quot;parity&quot;
suffix:colon
l_string|&quot;generic&quot;
)paren
suffix:semicolon
id|reset
op_assign
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|reset
)paren
(brace
id|printk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;%s: Resetting...&bslash;n&quot;
comma
id|hp-&gt;dev-&gt;name
)paren
suffix:semicolon
id|happy_meal_init
c_func
(paren
id|hp
comma
l_int|1
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|happy_meal_mif_interrupt
r_static
r_void
id|happy_meal_mif_interrupt
c_func
(paren
r_struct
id|happy_meal
op_star
id|hp
)paren
(brace
r_int
r_int
id|tregs
op_assign
id|hp-&gt;tcvregs
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Link status change.&bslash;n&quot;
comma
id|hp-&gt;dev-&gt;name
)paren
suffix:semicolon
id|hp-&gt;sw_bmcr
op_assign
id|happy_meal_tcvr_read
c_func
(paren
id|hp
comma
id|tregs
comma
id|DP83840_BMCR
)paren
suffix:semicolon
id|hp-&gt;sw_lpa
op_assign
id|happy_meal_tcvr_read
c_func
(paren
id|hp
comma
id|tregs
comma
id|DP83840_LPA
)paren
suffix:semicolon
multiline_comment|/* Use the fastest transmission protocol possible. */
r_if
c_cond
(paren
id|hp-&gt;sw_lpa
op_amp
id|LPA_100FULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Switching to 100Mbps at full duplex.&quot;
comma
id|hp-&gt;dev-&gt;name
)paren
suffix:semicolon
id|hp-&gt;sw_bmcr
op_or_assign
(paren
id|BMCR_FULLDPLX
op_or
id|BMCR_SPEED100
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|hp-&gt;sw_lpa
op_amp
id|LPA_100HALF
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Switching to 100MBps at half duplex.&quot;
comma
id|hp-&gt;dev-&gt;name
)paren
suffix:semicolon
id|hp-&gt;sw_bmcr
op_or_assign
id|BMCR_SPEED100
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|hp-&gt;sw_lpa
op_amp
id|LPA_10FULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Switching to 10MBps at full duplex.&quot;
comma
id|hp-&gt;dev-&gt;name
)paren
suffix:semicolon
id|hp-&gt;sw_bmcr
op_or_assign
id|BMCR_FULLDPLX
suffix:semicolon
)brace
r_else
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Using 10Mbps at half duplex.&quot;
comma
id|hp-&gt;dev-&gt;name
)paren
suffix:semicolon
)brace
id|happy_meal_tcvr_write
c_func
(paren
id|hp
comma
id|tregs
comma
id|DP83840_BMCR
comma
id|hp-&gt;sw_bmcr
)paren
suffix:semicolon
multiline_comment|/* Finally stop polling and shut up the MIF. */
id|happy_meal_poll_stop
c_func
(paren
id|hp
comma
id|tregs
)paren
suffix:semicolon
)brace
macro_line|#ifdef TXDEBUG
DECL|macro|TXD
mdefine_line|#define TXD(x) printk x
macro_line|#else
DECL|macro|TXD
mdefine_line|#define TXD(x)
macro_line|#endif
DECL|function|happy_meal_tx
r_static
r_void
id|happy_meal_tx
c_func
(paren
r_struct
id|happy_meal
op_star
id|hp
)paren
(brace
r_struct
id|happy_meal_txd
op_star
id|txbase
op_assign
op_amp
id|hp-&gt;happy_block-&gt;happy_meal_txd
(braket
l_int|0
)braket
suffix:semicolon
r_struct
id|happy_meal_txd
op_star
id|this
suffix:semicolon
r_struct
id|net_device
op_star
id|dev
op_assign
id|hp-&gt;dev
suffix:semicolon
r_int
id|elem
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|hp-&gt;happy_lock
)paren
suffix:semicolon
id|elem
op_assign
id|hp-&gt;tx_old
suffix:semicolon
id|TXD
c_func
(paren
(paren
l_string|&quot;TX&lt;&quot;
)paren
)paren
suffix:semicolon
r_while
c_loop
(paren
id|elem
op_ne
id|hp-&gt;tx_new
)paren
(brace
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
id|u32
id|flags
comma
id|dma_addr
suffix:semicolon
id|TXD
c_func
(paren
(paren
l_string|&quot;[%d]&quot;
comma
id|elem
)paren
)paren
suffix:semicolon
id|this
op_assign
op_amp
id|txbase
(braket
id|elem
)braket
suffix:semicolon
id|flags
op_assign
id|hme_read_desc32
c_func
(paren
id|hp
comma
op_amp
id|this-&gt;tx_flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|flags
op_amp
id|TXFLAG_OWN
)paren
r_break
suffix:semicolon
id|dma_addr
op_assign
id|hme_read_desc32
c_func
(paren
id|hp
comma
op_amp
id|this-&gt;tx_addr
)paren
suffix:semicolon
id|skb
op_assign
id|hp-&gt;tx_skbs
(braket
id|elem
)braket
suffix:semicolon
id|hme_dma_unmap
c_func
(paren
id|hp
comma
id|dma_addr
comma
id|skb-&gt;len
comma
id|DMA_TODEVICE
)paren
suffix:semicolon
id|hp-&gt;tx_skbs
(braket
id|elem
)braket
op_assign
l_int|NULL
suffix:semicolon
id|hp-&gt;net_stats.tx_bytes
op_add_assign
id|skb-&gt;len
suffix:semicolon
id|dev_kfree_skb_irq
c_func
(paren
id|skb
)paren
suffix:semicolon
id|hp-&gt;net_stats.tx_packets
op_increment
suffix:semicolon
id|elem
op_assign
id|NEXT_TX
c_func
(paren
id|elem
)paren
suffix:semicolon
)brace
id|hp-&gt;tx_old
op_assign
id|elem
suffix:semicolon
id|TXD
c_func
(paren
(paren
l_string|&quot;&gt;&quot;
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|netif_queue_stopped
c_func
(paren
id|dev
)paren
op_logical_and
id|TX_BUFFS_AVAIL
c_func
(paren
id|hp
)paren
OG
l_int|0
)paren
id|netif_wake_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|hp-&gt;happy_lock
)paren
suffix:semicolon
)brace
macro_line|#ifdef RXDEBUG
DECL|macro|RXD
mdefine_line|#define RXD(x) printk x
macro_line|#else
DECL|macro|RXD
mdefine_line|#define RXD(x)
macro_line|#endif
multiline_comment|/* Originally I used to handle the allocation failure by just giving back just&n; * that one ring buffer to the happy meal.  Problem is that usually when that&n; * condition is triggered, the happy meal expects you to do something reasonable&n; * with all of the packets it has DMA&squot;d in.  So now I just drop the entire&n; * ring when we cannot get a new skb and give them all back to the happy meal,&n; * maybe things will be &quot;happier&quot; now.&n; */
DECL|function|happy_meal_rx
r_static
r_void
id|happy_meal_rx
c_func
(paren
r_struct
id|happy_meal
op_star
id|hp
comma
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|happy_meal_rxd
op_star
id|rxbase
op_assign
op_amp
id|hp-&gt;happy_block-&gt;happy_meal_rxd
(braket
l_int|0
)braket
suffix:semicolon
r_struct
id|happy_meal_rxd
op_star
id|this
suffix:semicolon
r_int
id|elem
op_assign
id|hp-&gt;rx_new
comma
id|drops
op_assign
l_int|0
suffix:semicolon
id|u32
id|flags
suffix:semicolon
id|RXD
c_func
(paren
(paren
l_string|&quot;RX&lt;&quot;
)paren
)paren
suffix:semicolon
id|this
op_assign
op_amp
id|rxbase
(braket
id|elem
)braket
suffix:semicolon
r_while
c_loop
(paren
op_logical_neg
(paren
(paren
id|flags
op_assign
id|hme_read_desc32
c_func
(paren
id|hp
comma
op_amp
id|this-&gt;rx_flags
)paren
)paren
op_amp
id|RXFLAG_OWN
)paren
)paren
(brace
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
r_int
id|len
op_assign
id|flags
op_rshift
l_int|16
suffix:semicolon
id|u16
id|csum
op_assign
id|flags
op_amp
id|RXFLAG_CSUM
suffix:semicolon
id|u32
id|dma_addr
op_assign
id|hme_read_desc32
c_func
(paren
id|hp
comma
op_amp
id|this-&gt;rx_addr
)paren
suffix:semicolon
id|RXD
c_func
(paren
(paren
l_string|&quot;[%d &quot;
comma
id|elem
)paren
)paren
suffix:semicolon
multiline_comment|/* Check for errors. */
r_if
c_cond
(paren
(paren
id|len
OL
id|ETH_ZLEN
)paren
op_logical_or
(paren
id|flags
op_amp
id|RXFLAG_OVERFLOW
)paren
)paren
(brace
id|RXD
c_func
(paren
(paren
l_string|&quot;ERR(%08x)]&quot;
comma
id|flags
)paren
)paren
suffix:semicolon
id|hp-&gt;net_stats.rx_errors
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|len
OL
id|ETH_ZLEN
)paren
id|hp-&gt;net_stats.rx_length_errors
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|len
op_amp
(paren
id|RXFLAG_OVERFLOW
op_rshift
l_int|16
)paren
)paren
(brace
id|hp-&gt;net_stats.rx_over_errors
op_increment
suffix:semicolon
id|hp-&gt;net_stats.rx_fifo_errors
op_increment
suffix:semicolon
)brace
multiline_comment|/* Return it to the Happy meal. */
id|drop_it
suffix:colon
id|hp-&gt;net_stats.rx_dropped
op_increment
suffix:semicolon
id|hme_write_rxd
c_func
(paren
id|hp
comma
id|this
comma
(paren
id|RXFLAG_OWN
op_or
(paren
(paren
id|RX_BUF_ALLOC_SIZE
op_minus
id|RX_OFFSET
)paren
op_lshift
l_int|16
)paren
)paren
comma
id|dma_addr
)paren
suffix:semicolon
r_goto
id|next
suffix:semicolon
)brace
id|skb
op_assign
id|hp-&gt;rx_skbs
(braket
id|elem
)braket
suffix:semicolon
r_if
c_cond
(paren
id|len
OG
id|RX_COPY_THRESHOLD
)paren
(brace
r_struct
id|sk_buff
op_star
id|new_skb
suffix:semicolon
multiline_comment|/* Now refill the entry, if we can. */
id|new_skb
op_assign
id|happy_meal_alloc_skb
c_func
(paren
id|RX_BUF_ALLOC_SIZE
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
id|new_skb
op_eq
l_int|NULL
)paren
(brace
id|drops
op_increment
suffix:semicolon
r_goto
id|drop_it
suffix:semicolon
)brace
id|hme_dma_unmap
c_func
(paren
id|hp
comma
id|dma_addr
comma
id|RX_BUF_ALLOC_SIZE
comma
id|DMA_FROMDEVICE
)paren
suffix:semicolon
id|hp-&gt;rx_skbs
(braket
id|elem
)braket
op_assign
id|new_skb
suffix:semicolon
id|new_skb-&gt;dev
op_assign
id|dev
suffix:semicolon
id|skb_put
c_func
(paren
id|new_skb
comma
(paren
id|ETH_FRAME_LEN
op_plus
id|RX_OFFSET
)paren
)paren
suffix:semicolon
id|hme_write_rxd
c_func
(paren
id|hp
comma
id|this
comma
(paren
id|RXFLAG_OWN
op_or
(paren
(paren
id|RX_BUF_ALLOC_SIZE
op_minus
id|RX_OFFSET
)paren
op_lshift
l_int|16
)paren
)paren
comma
id|hme_dma_map
c_func
(paren
id|hp
comma
id|new_skb-&gt;data
comma
id|RX_BUF_ALLOC_SIZE
comma
id|DMA_FROMDEVICE
)paren
)paren
suffix:semicolon
id|skb_reserve
c_func
(paren
id|new_skb
comma
id|RX_OFFSET
)paren
suffix:semicolon
multiline_comment|/* Trim the original skb for the netif. */
id|skb_trim
c_func
(paren
id|skb
comma
id|len
)paren
suffix:semicolon
)brace
r_else
(brace
r_struct
id|sk_buff
op_star
id|copy_skb
op_assign
id|dev_alloc_skb
c_func
(paren
id|len
op_plus
l_int|2
)paren
suffix:semicolon
r_if
c_cond
(paren
id|copy_skb
op_eq
l_int|NULL
)paren
(brace
id|drops
op_increment
suffix:semicolon
r_goto
id|drop_it
suffix:semicolon
)brace
id|copy_skb-&gt;dev
op_assign
id|dev
suffix:semicolon
id|skb_reserve
c_func
(paren
id|copy_skb
comma
l_int|2
)paren
suffix:semicolon
id|skb_put
c_func
(paren
id|copy_skb
comma
id|len
)paren
suffix:semicolon
id|hme_dma_sync
c_func
(paren
id|hp
comma
id|dma_addr
comma
id|len
comma
id|DMA_FROMDEVICE
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|copy_skb-&gt;data
comma
id|skb-&gt;data
comma
id|len
)paren
suffix:semicolon
multiline_comment|/* Reuse original ring buffer. */
id|hme_write_rxd
c_func
(paren
id|hp
comma
id|this
comma
(paren
id|RXFLAG_OWN
op_or
(paren
(paren
id|RX_BUF_ALLOC_SIZE
op_minus
id|RX_OFFSET
)paren
op_lshift
l_int|16
)paren
)paren
comma
id|dma_addr
)paren
suffix:semicolon
id|skb
op_assign
id|copy_skb
suffix:semicolon
)brace
multiline_comment|/* This card is _fucking_ hot... */
r_if
c_cond
(paren
op_logical_neg
(paren
id|csum
op_xor
l_int|0xffff
)paren
)paren
id|skb-&gt;ip_summed
op_assign
id|CHECKSUM_UNNECESSARY
suffix:semicolon
r_else
id|skb-&gt;ip_summed
op_assign
id|CHECKSUM_NONE
suffix:semicolon
id|RXD
c_func
(paren
(paren
l_string|&quot;len=%d csum=%4x]&quot;
comma
id|len
comma
id|csum
)paren
)paren
suffix:semicolon
id|skb-&gt;protocol
op_assign
id|eth_type_trans
c_func
(paren
id|skb
comma
id|dev
)paren
suffix:semicolon
id|netif_rx
c_func
(paren
id|skb
)paren
suffix:semicolon
id|hp-&gt;net_stats.rx_packets
op_increment
suffix:semicolon
id|hp-&gt;net_stats.rx_bytes
op_add_assign
id|len
suffix:semicolon
id|next
suffix:colon
id|elem
op_assign
id|NEXT_RX
c_func
(paren
id|elem
)paren
suffix:semicolon
id|this
op_assign
op_amp
id|rxbase
(braket
id|elem
)braket
suffix:semicolon
)brace
id|hp-&gt;rx_new
op_assign
id|elem
suffix:semicolon
r_if
c_cond
(paren
id|drops
)paren
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Memory squeeze, deferring packet.&bslash;n&quot;
comma
id|hp-&gt;dev-&gt;name
)paren
suffix:semicolon
id|RXD
c_func
(paren
(paren
l_string|&quot;&gt;&quot;
)paren
)paren
suffix:semicolon
)brace
DECL|function|happy_meal_interrupt
r_static
r_void
id|happy_meal_interrupt
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_struct
id|net_device
op_star
id|dev
op_assign
(paren
r_struct
id|net_device
op_star
)paren
id|dev_id
suffix:semicolon
r_struct
id|happy_meal
op_star
id|hp
op_assign
(paren
r_struct
id|happy_meal
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|u32
id|happy_status
op_assign
id|hme_read32
c_func
(paren
id|hp
comma
id|hp-&gt;gregs
op_plus
id|GREG_STAT
)paren
suffix:semicolon
id|HMD
c_func
(paren
(paren
l_string|&quot;happy_meal_interrupt: status=%08x &quot;
comma
id|happy_status
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|happy_status
op_amp
id|GREG_STAT_ERRORS
)paren
(brace
id|HMD
c_func
(paren
(paren
l_string|&quot;ERRORS &quot;
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|happy_meal_is_not_so_happy
c_func
(paren
id|hp
comma
multiline_comment|/* un- */
id|happy_status
)paren
)paren
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|happy_status
op_amp
id|GREG_STAT_MIFIRQ
)paren
(brace
id|HMD
c_func
(paren
(paren
l_string|&quot;MIFIRQ &quot;
)paren
)paren
suffix:semicolon
id|happy_meal_mif_interrupt
c_func
(paren
id|hp
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|happy_status
op_amp
id|GREG_STAT_TXALL
)paren
(brace
id|HMD
c_func
(paren
(paren
l_string|&quot;TXALL &quot;
)paren
)paren
suffix:semicolon
id|happy_meal_tx
c_func
(paren
id|hp
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|happy_status
op_amp
id|GREG_STAT_RXTOHOST
)paren
(brace
id|HMD
c_func
(paren
(paren
l_string|&quot;RXTOHOST &quot;
)paren
)paren
suffix:semicolon
id|happy_meal_rx
c_func
(paren
id|hp
comma
id|dev
)paren
suffix:semicolon
)brace
id|HMD
c_func
(paren
(paren
l_string|&quot;done&bslash;n&quot;
)paren
)paren
suffix:semicolon
)brace
macro_line|#ifdef CONFIG_SBUS
DECL|function|quattro_sbus_interrupt
r_static
r_void
id|quattro_sbus_interrupt
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|cookie
comma
r_struct
id|pt_regs
op_star
id|ptregs
)paren
(brace
r_struct
id|quattro
op_star
id|qp
op_assign
(paren
r_struct
id|quattro
op_star
)paren
id|cookie
suffix:semicolon
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|4
suffix:semicolon
id|i
op_increment
)paren
(brace
r_struct
id|net_device
op_star
id|dev
op_assign
id|qp-&gt;happy_meals
(braket
id|i
)braket
suffix:semicolon
r_struct
id|happy_meal
op_star
id|hp
op_assign
(paren
r_struct
id|happy_meal
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|u32
id|happy_status
op_assign
id|hme_read32
c_func
(paren
id|hp
comma
id|hp-&gt;gregs
op_plus
id|GREG_STAT
)paren
suffix:semicolon
id|HMD
c_func
(paren
(paren
l_string|&quot;quattro_interrupt: status=%08x &quot;
comma
id|happy_status
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|happy_status
op_amp
(paren
id|GREG_STAT_ERRORS
op_or
id|GREG_STAT_MIFIRQ
op_or
id|GREG_STAT_TXALL
op_or
id|GREG_STAT_RXTOHOST
)paren
)paren
)paren
r_continue
suffix:semicolon
r_if
c_cond
(paren
id|happy_status
op_amp
id|GREG_STAT_ERRORS
)paren
(brace
id|HMD
c_func
(paren
(paren
l_string|&quot;ERRORS &quot;
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|happy_meal_is_not_so_happy
c_func
(paren
id|hp
comma
id|happy_status
)paren
)paren
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|happy_status
op_amp
id|GREG_STAT_MIFIRQ
)paren
(brace
id|HMD
c_func
(paren
(paren
l_string|&quot;MIFIRQ &quot;
)paren
)paren
suffix:semicolon
id|happy_meal_mif_interrupt
c_func
(paren
id|hp
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|happy_status
op_amp
id|GREG_STAT_TXALL
)paren
(brace
id|HMD
c_func
(paren
(paren
l_string|&quot;TXALL &quot;
)paren
)paren
suffix:semicolon
id|happy_meal_tx
c_func
(paren
id|hp
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|happy_status
op_amp
id|GREG_STAT_RXTOHOST
)paren
(brace
id|HMD
c_func
(paren
(paren
l_string|&quot;RXTOHOST &quot;
)paren
)paren
suffix:semicolon
id|happy_meal_rx
c_func
(paren
id|hp
comma
id|dev
)paren
suffix:semicolon
)brace
)brace
id|HMD
c_func
(paren
(paren
l_string|&quot;done&bslash;n&quot;
)paren
)paren
suffix:semicolon
)brace
macro_line|#endif
DECL|function|happy_meal_open
r_static
r_int
id|happy_meal_open
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|happy_meal
op_star
id|hp
op_assign
(paren
r_struct
id|happy_meal
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_int
id|res
suffix:semicolon
id|HMD
c_func
(paren
(paren
l_string|&quot;happy_meal_open: &quot;
)paren
)paren
suffix:semicolon
multiline_comment|/* On SBUS Quattro QFE cards, all hme interrupts are concentrated&n;&t; * into a single source which we register handling at probe time.&n;&t; */
r_if
c_cond
(paren
(paren
id|hp-&gt;happy_flags
op_amp
(paren
id|HFLAG_QUATTRO
op_or
id|HFLAG_PCI
)paren
)paren
op_ne
id|HFLAG_QUATTRO
)paren
(brace
r_if
c_cond
(paren
id|request_irq
c_func
(paren
id|dev-&gt;irq
comma
op_amp
id|happy_meal_interrupt
comma
id|SA_SHIRQ
comma
l_string|&quot;HAPPY MEAL&quot;
comma
(paren
r_void
op_star
)paren
id|dev
)paren
)paren
(brace
id|HMD
c_func
(paren
(paren
l_string|&quot;EAGAIN&bslash;n&quot;
)paren
)paren
suffix:semicolon
macro_line|#ifdef __sparc__
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;happy_meal(SBUS): Can&squot;t order irq %s to go.&bslash;n&quot;
comma
id|__irq_itoa
c_func
(paren
id|dev-&gt;irq
)paren
)paren
suffix:semicolon
macro_line|#else
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;happy_meal(SBUS): Can&squot;t order irq %d to go.&bslash;n&quot;
comma
id|dev-&gt;irq
)paren
suffix:semicolon
macro_line|#endif
r_return
op_minus
id|EAGAIN
suffix:semicolon
)brace
)brace
id|HMD
c_func
(paren
(paren
l_string|&quot;to happy_meal_init&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|res
op_assign
id|happy_meal_init
c_func
(paren
id|hp
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|res
)paren
(brace
id|MOD_INC_USE_COUNT
suffix:semicolon
)brace
r_return
id|res
suffix:semicolon
)brace
DECL|function|happy_meal_close
r_static
r_int
id|happy_meal_close
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|happy_meal
op_star
id|hp
op_assign
(paren
r_struct
id|happy_meal
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|happy_meal_stop
c_func
(paren
id|hp
comma
id|hp-&gt;gregs
)paren
suffix:semicolon
id|happy_meal_clean_rings
c_func
(paren
id|hp
)paren
suffix:semicolon
multiline_comment|/* If auto-negotiation timer is running, kill it. */
id|del_timer
c_func
(paren
op_amp
id|hp-&gt;happy_timer
)paren
suffix:semicolon
multiline_comment|/* On Quattro QFE cards, all hme interrupts are concentrated&n;&t; * into a single source which we register handling at probe&n;&t; * time and never unregister.&n;&t; */
r_if
c_cond
(paren
(paren
id|hp-&gt;happy_flags
op_amp
(paren
id|HFLAG_QUATTRO
op_or
id|HFLAG_PCI
)paren
)paren
op_ne
id|HFLAG_QUATTRO
)paren
id|free_irq
c_func
(paren
id|dev-&gt;irq
comma
(paren
r_void
op_star
)paren
id|dev
)paren
suffix:semicolon
id|MOD_DEC_USE_COUNT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#ifdef SXDEBUG
DECL|macro|SXD
mdefine_line|#define SXD(x) printk x
macro_line|#else
DECL|macro|SXD
mdefine_line|#define SXD(x)
macro_line|#endif
macro_line|#ifdef CONFIG_SBUS
DECL|function|happy_meal_tx_timeout
r_static
r_void
id|happy_meal_tx_timeout
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|happy_meal
op_star
id|hp
op_assign
(paren
r_struct
id|happy_meal
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|printk
(paren
id|KERN_ERR
l_string|&quot;%s: transmit timed out, resetting&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|tx_dump_log
c_func
(paren
)paren
suffix:semicolon
id|printk
(paren
id|KERN_ERR
l_string|&quot;%s: Happy Status %08x TX[%08x:%08x]&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|hme_read32
c_func
(paren
id|hp
comma
id|hp-&gt;gregs
op_plus
id|GREG_STAT
)paren
comma
id|hme_read32
c_func
(paren
id|hp
comma
id|hp-&gt;etxregs
op_plus
id|ETX_CFG
)paren
comma
id|hme_read32
c_func
(paren
id|hp
comma
id|hp-&gt;bigmacregs
op_plus
id|BMAC_TXCFG
)paren
)paren
suffix:semicolon
id|happy_meal_init
c_func
(paren
id|hp
comma
l_int|0
)paren
suffix:semicolon
id|netif_wake_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
macro_line|#endif
DECL|function|happy_meal_start_xmit
r_static
r_int
id|happy_meal_start_xmit
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|happy_meal
op_star
id|hp
op_assign
(paren
r_struct
id|happy_meal
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_int
id|len
comma
id|entry
suffix:semicolon
id|u32
id|mapping
suffix:semicolon
id|len
op_assign
id|skb-&gt;len
suffix:semicolon
id|mapping
op_assign
id|hme_dma_map
c_func
(paren
id|hp
comma
id|skb-&gt;data
comma
id|len
comma
id|DMA_TODEVICE
)paren
suffix:semicolon
id|spin_lock_irq
c_func
(paren
op_amp
id|hp-&gt;happy_lock
)paren
suffix:semicolon
id|entry
op_assign
id|hp-&gt;tx_new
suffix:semicolon
id|SXD
c_func
(paren
(paren
l_string|&quot;SX&lt;l[%d]e[%d]&gt;&quot;
comma
id|len
comma
id|entry
)paren
)paren
suffix:semicolon
id|hp-&gt;tx_skbs
(braket
id|entry
)braket
op_assign
id|skb
suffix:semicolon
id|hme_write_txd
c_func
(paren
id|hp
comma
op_amp
id|hp-&gt;happy_block-&gt;happy_meal_txd
(braket
id|entry
)braket
comma
(paren
id|TXFLAG_OWN
op_or
id|TXFLAG_SOP
op_or
id|TXFLAG_EOP
op_or
(paren
id|len
op_amp
id|TXFLAG_SIZE
)paren
)paren
comma
id|mapping
)paren
suffix:semicolon
id|hp-&gt;tx_new
op_assign
id|NEXT_TX
c_func
(paren
id|entry
)paren
suffix:semicolon
r_if
c_cond
(paren
id|TX_BUFFS_AVAIL
c_func
(paren
id|hp
)paren
op_le
l_int|0
)paren
id|netif_stop_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
multiline_comment|/* Get it going. */
id|hme_write32
c_func
(paren
id|hp
comma
id|hp-&gt;etxregs
op_plus
id|ETX_PENDING
comma
id|ETX_TP_DMAWAKEUP
)paren
suffix:semicolon
id|spin_unlock_irq
c_func
(paren
op_amp
id|hp-&gt;happy_lock
)paren
suffix:semicolon
id|dev-&gt;trans_start
op_assign
id|jiffies
suffix:semicolon
id|tx_add_log
c_func
(paren
id|hp
comma
id|TXLOG_ACTION_TXMIT
comma
l_int|0
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|happy_meal_get_stats
r_static
r_struct
id|net_device_stats
op_star
id|happy_meal_get_stats
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|happy_meal
op_star
id|hp
op_assign
(paren
r_struct
id|happy_meal
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|happy_meal_get_counters
c_func
(paren
id|hp
comma
id|hp-&gt;bigmacregs
)paren
suffix:semicolon
r_return
op_amp
id|hp-&gt;net_stats
suffix:semicolon
)brace
DECL|function|happy_meal_set_multicast
r_static
r_void
id|happy_meal_set_multicast
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|happy_meal
op_star
id|hp
op_assign
(paren
r_struct
id|happy_meal
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_int
r_int
id|bregs
op_assign
id|hp-&gt;bigmacregs
suffix:semicolon
r_struct
id|dev_mc_list
op_star
id|dmi
op_assign
id|dev-&gt;mc_list
suffix:semicolon
r_char
op_star
id|addrs
suffix:semicolon
r_int
id|i
comma
id|j
comma
id|bit
comma
id|byte
suffix:semicolon
id|u32
id|crc
comma
id|poly
op_assign
id|CRC_POLYNOMIAL_LE
suffix:semicolon
multiline_comment|/* Lock out others. */
id|netif_stop_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|dev-&gt;flags
op_amp
id|IFF_ALLMULTI
)paren
op_logical_or
(paren
id|dev-&gt;mc_count
OG
l_int|64
)paren
)paren
(brace
id|hme_write32
c_func
(paren
id|hp
comma
id|bregs
op_plus
id|BMAC_HTABLE0
comma
l_int|0xffff
)paren
suffix:semicolon
id|hme_write32
c_func
(paren
id|hp
comma
id|bregs
op_plus
id|BMAC_HTABLE1
comma
l_int|0xffff
)paren
suffix:semicolon
id|hme_write32
c_func
(paren
id|hp
comma
id|bregs
op_plus
id|BMAC_HTABLE2
comma
l_int|0xffff
)paren
suffix:semicolon
id|hme_write32
c_func
(paren
id|hp
comma
id|bregs
op_plus
id|BMAC_HTABLE3
comma
l_int|0xffff
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|dev-&gt;flags
op_amp
id|IFF_PROMISC
)paren
(brace
id|hme_write32
c_func
(paren
id|hp
comma
id|bregs
op_plus
id|BMAC_RXCFG
comma
id|hme_read32
c_func
(paren
id|hp
comma
id|bregs
op_plus
id|BMAC_RXCFG
)paren
op_or
id|BIGMAC_RXCFG_PMISC
)paren
suffix:semicolon
)brace
r_else
(brace
id|u16
id|hash_table
(braket
l_int|4
)braket
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|4
suffix:semicolon
id|i
op_increment
)paren
id|hash_table
(braket
id|i
)braket
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|dev-&gt;mc_count
suffix:semicolon
id|i
op_increment
)paren
(brace
id|addrs
op_assign
id|dmi-&gt;dmi_addr
suffix:semicolon
id|dmi
op_assign
id|dmi-&gt;next
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
op_star
id|addrs
op_amp
l_int|1
)paren
)paren
r_continue
suffix:semicolon
id|crc
op_assign
l_int|0xffffffffU
suffix:semicolon
r_for
c_loop
(paren
id|byte
op_assign
l_int|0
suffix:semicolon
id|byte
OL
l_int|6
suffix:semicolon
id|byte
op_increment
)paren
(brace
r_for
c_loop
(paren
id|bit
op_assign
op_star
id|addrs
op_increment
comma
id|j
op_assign
l_int|0
suffix:semicolon
id|j
OL
l_int|8
suffix:semicolon
id|j
op_increment
comma
id|bit
op_rshift_assign
l_int|1
)paren
(brace
r_int
id|test
suffix:semicolon
id|test
op_assign
(paren
(paren
id|bit
op_xor
id|crc
)paren
op_amp
l_int|0x01
)paren
suffix:semicolon
id|crc
op_rshift_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|test
)paren
id|crc
op_assign
id|crc
op_xor
id|poly
suffix:semicolon
)brace
)brace
id|crc
op_rshift_assign
l_int|26
suffix:semicolon
id|hash_table
(braket
id|crc
op_rshift
l_int|4
)braket
op_or_assign
l_int|1
op_lshift
(paren
id|crc
op_amp
l_int|0xf
)paren
suffix:semicolon
)brace
id|hme_write32
c_func
(paren
id|hp
comma
id|bregs
op_plus
id|BMAC_HTABLE0
comma
id|hash_table
(braket
l_int|0
)braket
)paren
suffix:semicolon
id|hme_write32
c_func
(paren
id|hp
comma
id|bregs
op_plus
id|BMAC_HTABLE1
comma
id|hash_table
(braket
l_int|1
)braket
)paren
suffix:semicolon
id|hme_write32
c_func
(paren
id|hp
comma
id|bregs
op_plus
id|BMAC_HTABLE2
comma
id|hash_table
(braket
l_int|2
)braket
)paren
suffix:semicolon
id|hme_write32
c_func
(paren
id|hp
comma
id|bregs
op_plus
id|BMAC_HTABLE3
comma
id|hash_table
(braket
l_int|3
)braket
)paren
suffix:semicolon
)brace
multiline_comment|/* Let us get going again. */
id|netif_wake_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
multiline_comment|/* Ethtool support... */
DECL|function|happy_meal_ioctl
r_static
r_int
id|happy_meal_ioctl
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_struct
id|ifreq
op_star
id|rq
comma
r_int
id|cmd
)paren
(brace
r_struct
id|happy_meal
op_star
id|hp
op_assign
(paren
r_struct
id|happy_meal
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_struct
id|ethtool_cmd
op_star
id|ep_user
op_assign
(paren
r_struct
id|ethtool_cmd
op_star
)paren
id|rq-&gt;ifr_data
suffix:semicolon
r_struct
id|ethtool_cmd
id|ecmd
suffix:semicolon
r_if
c_cond
(paren
id|cmd
op_ne
id|SIOCETHTOOL
)paren
r_return
op_minus
id|EOPNOTSUPP
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|ecmd
comma
id|ep_user
comma
r_sizeof
(paren
id|ecmd
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_if
c_cond
(paren
id|ecmd.cmd
op_eq
id|SPARC_ETH_GSET
)paren
(brace
id|ecmd.supported
op_assign
(paren
id|SUPPORTED_10baseT_Half
op_or
id|SUPPORTED_10baseT_Full
op_or
id|SUPPORTED_100baseT_Half
op_or
id|SUPPORTED_100baseT_Full
op_or
id|SUPPORTED_Autoneg
op_or
id|SUPPORTED_TP
op_or
id|SUPPORTED_MII
)paren
suffix:semicolon
multiline_comment|/* XXX hardcoded stuff for now */
id|ecmd.port
op_assign
id|PORT_TP
suffix:semicolon
multiline_comment|/* XXX no MII support */
id|ecmd.transceiver
op_assign
id|XCVR_INTERNAL
suffix:semicolon
multiline_comment|/* XXX no external xcvr support */
id|ecmd.phy_address
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* XXX fixed PHYAD */
multiline_comment|/* Record PHY settings. */
id|hp-&gt;sw_bmcr
op_assign
id|happy_meal_tcvr_read
c_func
(paren
id|hp
comma
id|hp-&gt;tcvregs
comma
id|DP83840_BMCR
)paren
suffix:semicolon
id|hp-&gt;sw_lpa
op_assign
id|happy_meal_tcvr_read
c_func
(paren
id|hp
comma
id|hp-&gt;tcvregs
comma
id|DP83840_LPA
)paren
suffix:semicolon
r_if
c_cond
(paren
id|hp-&gt;sw_bmcr
op_amp
id|BMCR_ANENABLE
)paren
(brace
id|ecmd.autoneg
op_assign
id|AUTONEG_ENABLE
suffix:semicolon
id|ecmd.speed
op_assign
(paren
id|hp-&gt;sw_lpa
op_amp
(paren
id|LPA_100HALF
op_or
id|LPA_100FULL
)paren
)paren
ques
c_cond
id|SPEED_100
suffix:colon
id|SPEED_10
suffix:semicolon
r_if
c_cond
(paren
id|ecmd.speed
op_eq
id|SPEED_100
)paren
id|ecmd.duplex
op_assign
(paren
id|hp-&gt;sw_lpa
op_amp
(paren
id|LPA_100FULL
)paren
)paren
ques
c_cond
id|DUPLEX_FULL
suffix:colon
id|DUPLEX_HALF
suffix:semicolon
r_else
id|ecmd.duplex
op_assign
(paren
id|hp-&gt;sw_lpa
op_amp
(paren
id|LPA_10FULL
)paren
)paren
ques
c_cond
id|DUPLEX_FULL
suffix:colon
id|DUPLEX_HALF
suffix:semicolon
)brace
r_else
(brace
id|ecmd.autoneg
op_assign
id|AUTONEG_DISABLE
suffix:semicolon
id|ecmd.speed
op_assign
(paren
id|hp-&gt;sw_bmcr
op_amp
id|BMCR_SPEED100
)paren
ques
c_cond
id|SPEED_100
suffix:colon
id|SPEED_10
suffix:semicolon
id|ecmd.duplex
op_assign
(paren
id|hp-&gt;sw_bmcr
op_amp
id|BMCR_FULLDPLX
)paren
ques
c_cond
id|DUPLEX_FULL
suffix:colon
id|DUPLEX_HALF
suffix:semicolon
)brace
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
id|ep_user
comma
op_amp
id|ecmd
comma
r_sizeof
(paren
id|ecmd
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|ecmd.cmd
op_eq
id|SPARC_ETH_SSET
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|capable
c_func
(paren
id|CAP_NET_ADMIN
)paren
)paren
r_return
op_minus
id|EPERM
suffix:semicolon
multiline_comment|/* Verify the settings we care about. */
r_if
c_cond
(paren
id|ecmd.autoneg
op_ne
id|AUTONEG_ENABLE
op_logical_and
id|ecmd.autoneg
op_ne
id|AUTONEG_DISABLE
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|ecmd.autoneg
op_eq
id|AUTONEG_DISABLE
op_logical_and
(paren
(paren
id|ecmd.speed
op_ne
id|SPEED_100
op_logical_and
id|ecmd.speed
op_ne
id|SPEED_10
)paren
op_logical_or
(paren
id|ecmd.duplex
op_ne
id|DUPLEX_HALF
op_logical_and
id|ecmd.duplex
op_ne
id|DUPLEX_FULL
)paren
)paren
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
multiline_comment|/* Ok, do it to it. */
id|del_timer
c_func
(paren
op_amp
id|hp-&gt;happy_timer
)paren
suffix:semicolon
id|happy_meal_begin_auto_negotiation
c_func
(paren
id|hp
comma
id|hp-&gt;tcvregs
comma
op_amp
id|ecmd
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_else
r_return
op_minus
id|EOPNOTSUPP
suffix:semicolon
)brace
DECL|variable|hme_version_printed
r_static
r_int
id|hme_version_printed
op_assign
l_int|0
suffix:semicolon
macro_line|#ifdef CONFIG_SBUS
DECL|function|quattro_get_ranges
r_void
id|__init
id|quattro_get_ranges
c_func
(paren
r_struct
id|quattro
op_star
id|qp
)paren
(brace
r_struct
id|sbus_dev
op_star
id|sdev
op_assign
id|qp-&gt;quattro_dev
suffix:semicolon
r_int
id|err
suffix:semicolon
id|err
op_assign
id|prom_getproperty
c_func
(paren
id|sdev-&gt;prom_node
comma
l_string|&quot;ranges&quot;
comma
(paren
r_char
op_star
)paren
op_amp
id|qp-&gt;ranges
(braket
l_int|0
)braket
comma
r_sizeof
(paren
id|qp-&gt;ranges
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
op_eq
l_int|0
op_logical_or
id|err
op_eq
op_minus
l_int|1
)paren
(brace
id|qp-&gt;nranges
op_assign
l_int|0
suffix:semicolon
r_return
suffix:semicolon
)brace
id|qp-&gt;nranges
op_assign
(paren
id|err
op_div
r_sizeof
(paren
r_struct
id|linux_prom_ranges
)paren
)paren
suffix:semicolon
)brace
DECL|function|quattro_apply_ranges
r_static
r_void
id|__init
id|quattro_apply_ranges
c_func
(paren
r_struct
id|quattro
op_star
id|qp
comma
r_struct
id|happy_meal
op_star
id|hp
)paren
(brace
r_struct
id|sbus_dev
op_star
id|sdev
op_assign
id|hp-&gt;happy_dev
suffix:semicolon
r_int
id|rng
suffix:semicolon
r_for
c_loop
(paren
id|rng
op_assign
l_int|0
suffix:semicolon
id|rng
OL
id|qp-&gt;nranges
suffix:semicolon
id|rng
op_increment
)paren
(brace
r_struct
id|linux_prom_ranges
op_star
id|rngp
op_assign
op_amp
id|qp-&gt;ranges
(braket
id|rng
)braket
suffix:semicolon
r_int
id|reg
suffix:semicolon
r_for
c_loop
(paren
id|reg
op_assign
l_int|0
suffix:semicolon
id|reg
OL
l_int|5
suffix:semicolon
id|reg
op_increment
)paren
(brace
r_if
c_cond
(paren
id|sdev-&gt;reg_addrs
(braket
id|reg
)braket
dot
id|which_io
op_eq
id|rngp-&gt;ot_child_space
)paren
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|reg
op_eq
l_int|5
)paren
r_continue
suffix:semicolon
id|sdev-&gt;reg_addrs
(braket
id|reg
)braket
dot
id|which_io
op_assign
id|rngp-&gt;ot_parent_space
suffix:semicolon
id|sdev-&gt;reg_addrs
(braket
id|reg
)braket
dot
id|phys_addr
op_add_assign
id|rngp-&gt;ot_parent_base
suffix:semicolon
)brace
)brace
multiline_comment|/* Given a happy meal sbus device, find it&squot;s quattro parent.&n; * If none exist, allocate and return a new one.&n; *&n; * Return NULL on failure.&n; */
DECL|function|quattro_sbus_find
r_static
r_struct
id|quattro
op_star
id|__init
id|quattro_sbus_find
c_func
(paren
r_struct
id|sbus_dev
op_star
id|goal_sdev
)paren
(brace
r_struct
id|sbus_bus
op_star
id|sbus
suffix:semicolon
r_struct
id|sbus_dev
op_star
id|sdev
suffix:semicolon
r_struct
id|quattro
op_star
id|qp
suffix:semicolon
r_if
c_cond
(paren
id|qfe_sbus_list
op_eq
l_int|NULL
)paren
r_goto
id|found
suffix:semicolon
r_for
c_loop
(paren
id|qp
op_assign
id|qfe_sbus_list
suffix:semicolon
id|qp
op_ne
l_int|NULL
suffix:semicolon
id|qp
op_assign
id|qp-&gt;next
)paren
(brace
r_for
c_loop
(paren
id|sdev
op_assign
id|qp-&gt;quattro_dev
suffix:semicolon
id|sdev
op_ne
l_int|NULL
suffix:semicolon
id|sdev
op_assign
id|sdev-&gt;next
)paren
(brace
r_if
c_cond
(paren
id|sdev
op_eq
id|goal_sdev
)paren
r_return
id|qp
suffix:semicolon
)brace
)brace
id|for_each_sbus
c_func
(paren
id|sbus
)paren
(brace
id|for_each_sbusdev
c_func
(paren
id|sdev
comma
id|sbus
)paren
(brace
r_if
c_cond
(paren
id|sdev-&gt;child
op_ne
l_int|NULL
)paren
(brace
r_struct
id|sbus_dev
op_star
id|p
suffix:semicolon
r_for
c_loop
(paren
id|p
op_assign
id|sdev-&gt;child
suffix:semicolon
id|p
op_ne
l_int|NULL
suffix:semicolon
id|p
op_assign
id|p-&gt;next
)paren
r_if
c_cond
(paren
id|p
op_eq
id|goal_sdev
)paren
r_goto
id|found
suffix:semicolon
)brace
)brace
)brace
multiline_comment|/* Cannot find quattro parent, fail. */
r_return
l_int|NULL
suffix:semicolon
id|found
suffix:colon
id|qp
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|quattro
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|qp
op_ne
l_int|NULL
)paren
(brace
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|4
suffix:semicolon
id|i
op_increment
)paren
id|qp-&gt;happy_meals
(braket
id|i
)braket
op_assign
l_int|NULL
suffix:semicolon
id|qp-&gt;quattro_dev
op_assign
id|goal_sdev
suffix:semicolon
id|qp-&gt;next
op_assign
id|qfe_sbus_list
suffix:semicolon
id|qfe_sbus_list
op_assign
id|qp
suffix:semicolon
id|quattro_get_ranges
c_func
(paren
id|qp
)paren
suffix:semicolon
)brace
r_return
id|qp
suffix:semicolon
)brace
multiline_comment|/* After all quattro cards have been probed, we call these functions&n; * to register the IRQ handlers.&n; */
DECL|function|quattro_sbus_register_irqs
r_static
r_void
id|__init
id|quattro_sbus_register_irqs
c_func
(paren
r_void
)paren
(brace
r_struct
id|quattro
op_star
id|qp
suffix:semicolon
r_for
c_loop
(paren
id|qp
op_assign
id|qfe_sbus_list
suffix:semicolon
id|qp
op_ne
l_int|NULL
suffix:semicolon
id|qp
op_assign
id|qp-&gt;next
)paren
(brace
r_struct
id|sbus_dev
op_star
id|sdev
op_assign
id|qp-&gt;quattro_dev
suffix:semicolon
r_int
id|err
suffix:semicolon
id|err
op_assign
id|request_irq
c_func
(paren
id|sdev-&gt;irqs
(braket
l_int|0
)braket
comma
id|quattro_sbus_interrupt
comma
id|SA_SHIRQ
comma
l_string|&quot;Quattro&quot;
comma
id|qp
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
op_ne
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;Quattro: Fatal IRQ registery error %d.&bslash;n&quot;
comma
id|err
)paren
suffix:semicolon
id|panic
c_func
(paren
l_string|&quot;QFE request irq&quot;
)paren
suffix:semicolon
)brace
)brace
)brace
macro_line|#endif /* CONFIG_SBUS */
macro_line|#ifdef CONFIG_PCI
DECL|function|quattro_pci_find
r_static
r_struct
id|quattro
op_star
id|__init
id|quattro_pci_find
c_func
(paren
r_struct
id|pci_dev
op_star
id|pdev
)paren
(brace
r_struct
id|pci_dev
op_star
id|bdev
op_assign
id|pdev-&gt;bus-&gt;self
suffix:semicolon
r_struct
id|quattro
op_star
id|qp
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|bdev
)paren
r_return
l_int|NULL
suffix:semicolon
r_for
c_loop
(paren
id|qp
op_assign
id|qfe_pci_list
suffix:semicolon
id|qp
op_ne
l_int|NULL
suffix:semicolon
id|qp
op_assign
id|qp-&gt;next
)paren
(brace
r_struct
id|pci_dev
op_star
id|qpdev
op_assign
id|qp-&gt;quattro_dev
suffix:semicolon
r_if
c_cond
(paren
id|qpdev
op_eq
id|bdev
)paren
r_return
id|qp
suffix:semicolon
)brace
id|qp
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|quattro
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|qp
op_ne
l_int|NULL
)paren
(brace
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|4
suffix:semicolon
id|i
op_increment
)paren
id|qp-&gt;happy_meals
(braket
id|i
)braket
op_assign
l_int|NULL
suffix:semicolon
id|qp-&gt;quattro_dev
op_assign
id|bdev
suffix:semicolon
id|qp-&gt;next
op_assign
id|qfe_pci_list
suffix:semicolon
id|qfe_pci_list
op_assign
id|qp
suffix:semicolon
multiline_comment|/* No range tricks necessary on PCI. */
id|qp-&gt;nranges
op_assign
l_int|0
suffix:semicolon
)brace
r_return
id|qp
suffix:semicolon
)brace
macro_line|#endif /* CONFIG_PCI */
macro_line|#ifdef CONFIG_SBUS
DECL|function|happy_meal_sbus_init
r_static
r_int
id|__init
id|happy_meal_sbus_init
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_struct
id|sbus_dev
op_star
id|sdev
comma
r_int
id|is_qfe
)paren
(brace
r_struct
id|quattro
op_star
id|qp
op_assign
l_int|NULL
suffix:semicolon
r_struct
id|happy_meal
op_star
id|hp
suffix:semicolon
r_int
id|i
comma
id|qfe_slot
op_assign
op_minus
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|is_qfe
)paren
(brace
id|qp
op_assign
id|quattro_sbus_find
c_func
(paren
id|sdev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|qp
op_eq
l_int|NULL
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
r_for
c_loop
(paren
id|qfe_slot
op_assign
l_int|0
suffix:semicolon
id|qfe_slot
OL
l_int|4
suffix:semicolon
id|qfe_slot
op_increment
)paren
r_if
c_cond
(paren
id|qp-&gt;happy_meals
(braket
id|qfe_slot
)braket
op_eq
l_int|NULL
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
id|qfe_slot
op_eq
l_int|4
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
r_if
c_cond
(paren
id|dev
op_eq
l_int|NULL
)paren
(brace
id|dev
op_assign
id|init_etherdev
c_func
(paren
l_int|0
comma
r_sizeof
(paren
r_struct
id|happy_meal
)paren
)paren
suffix:semicolon
)brace
r_else
(brace
id|dev-&gt;priv
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|happy_meal
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;priv
op_eq
l_int|NULL
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
r_if
c_cond
(paren
id|hme_version_printed
op_increment
op_eq
l_int|0
)paren
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s&quot;
comma
id|version
)paren
suffix:semicolon
r_if
c_cond
(paren
id|qfe_slot
op_ne
op_minus
l_int|1
)paren
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Quattro HME slot %d (SBUS) 10/100baseT Ethernet &quot;
comma
id|dev-&gt;name
comma
id|qfe_slot
)paren
suffix:semicolon
r_else
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: HAPPY MEAL (SBUS) 10/100baseT Ethernet &quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
multiline_comment|/* If user did not specify a MAC address specifically, use&n;&t; * the Quattro local-mac-address property...&n;&t; */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|6
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|macaddr
(braket
id|i
)braket
op_ne
l_int|0
)paren
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|i
OL
l_int|6
)paren
(brace
multiline_comment|/* a mac address was given */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|6
suffix:semicolon
id|i
op_increment
)paren
id|dev-&gt;dev_addr
(braket
id|i
)braket
op_assign
id|macaddr
(braket
id|i
)braket
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|qfe_slot
op_ne
op_minus
l_int|1
op_logical_and
id|prom_getproplen
c_func
(paren
id|sdev-&gt;prom_node
comma
l_string|&quot;local-mac-address&quot;
)paren
op_eq
l_int|6
)paren
(brace
id|prom_getproperty
c_func
(paren
id|sdev-&gt;prom_node
comma
l_string|&quot;local-mac-address&quot;
comma
id|dev-&gt;dev_addr
comma
l_int|6
)paren
suffix:semicolon
)brace
r_else
(brace
id|memcpy
c_func
(paren
id|dev-&gt;dev_addr
comma
id|idprom-&gt;id_ethaddr
comma
l_int|6
)paren
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|6
suffix:semicolon
id|i
op_increment
)paren
id|printk
c_func
(paren
l_string|&quot;%2.2x%c&quot;
comma
id|dev-&gt;dev_addr
(braket
id|i
)braket
comma
id|i
op_eq
l_int|5
ques
c_cond
l_char|&squot; &squot;
suffix:colon
l_char|&squot;:&squot;
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
id|hp
op_assign
(paren
r_struct
id|happy_meal
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|memset
c_func
(paren
id|hp
comma
l_int|0
comma
r_sizeof
(paren
op_star
id|hp
)paren
)paren
suffix:semicolon
id|hp-&gt;happy_dev
op_assign
id|sdev
suffix:semicolon
id|spin_lock_init
c_func
(paren
op_amp
id|hp-&gt;happy_lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sdev-&gt;num_registers
op_ne
l_int|5
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;happymeal: Device does not have 5 regs, it has %d.&bslash;n&quot;
comma
id|sdev-&gt;num_registers
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;happymeal: Would you like that for here or to go?&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
r_if
c_cond
(paren
id|qp
op_ne
l_int|NULL
)paren
(brace
id|hp-&gt;qfe_parent
op_assign
id|qp
suffix:semicolon
id|hp-&gt;qfe_ent
op_assign
id|qfe_slot
suffix:semicolon
id|qp-&gt;happy_meals
(braket
id|qfe_slot
)braket
op_assign
id|dev
suffix:semicolon
id|quattro_apply_ranges
c_func
(paren
id|qp
comma
id|hp
)paren
suffix:semicolon
)brace
id|hp-&gt;gregs
op_assign
id|sbus_ioremap
c_func
(paren
op_amp
id|sdev-&gt;resource
(braket
l_int|0
)braket
comma
l_int|0
comma
id|GREG_REG_SIZE
comma
l_string|&quot;HME Global Regs&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|hp-&gt;gregs
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;happymeal: Cannot map Happy Meal global registers.&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
id|hp-&gt;etxregs
op_assign
id|sbus_ioremap
c_func
(paren
op_amp
id|sdev-&gt;resource
(braket
l_int|1
)braket
comma
l_int|0
comma
id|ETX_REG_SIZE
comma
l_string|&quot;HME TX Regs&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|hp-&gt;etxregs
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;happymeal: Cannot map Happy Meal MAC Transmit registers.&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
id|hp-&gt;erxregs
op_assign
id|sbus_ioremap
c_func
(paren
op_amp
id|sdev-&gt;resource
(braket
l_int|2
)braket
comma
l_int|0
comma
id|ERX_REG_SIZE
comma
l_string|&quot;HME RX Regs&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|hp-&gt;erxregs
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;happymeal: Cannot map Happy Meal MAC Receive registers.&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
id|hp-&gt;bigmacregs
op_assign
id|sbus_ioremap
c_func
(paren
op_amp
id|sdev-&gt;resource
(braket
l_int|3
)braket
comma
l_int|0
comma
id|BMAC_REG_SIZE
comma
l_string|&quot;HME BIGMAC Regs&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|hp-&gt;bigmacregs
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;happymeal: Cannot map Happy Meal BIGMAC registers.&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
id|hp-&gt;tcvregs
op_assign
id|sbus_ioremap
c_func
(paren
op_amp
id|sdev-&gt;resource
(braket
l_int|4
)braket
comma
l_int|0
comma
id|TCVR_REG_SIZE
comma
l_string|&quot;HME Tranceiver Regs&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|hp-&gt;tcvregs
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;happymeal: Cannot map Happy Meal Tranceiver registers.&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
id|hp-&gt;hm_revision
op_assign
id|prom_getintdefault
c_func
(paren
id|sdev-&gt;prom_node
comma
l_string|&quot;hm-rev&quot;
comma
l_int|0xff
)paren
suffix:semicolon
r_if
c_cond
(paren
id|hp-&gt;hm_revision
op_eq
l_int|0xff
)paren
id|hp-&gt;hm_revision
op_assign
l_int|0xa0
suffix:semicolon
multiline_comment|/* Now enable the feature flags we can. */
r_if
c_cond
(paren
id|hp-&gt;hm_revision
op_eq
l_int|0x20
op_logical_or
id|hp-&gt;hm_revision
op_eq
l_int|0x21
)paren
id|hp-&gt;happy_flags
op_assign
id|HFLAG_20_21
suffix:semicolon
r_else
r_if
c_cond
(paren
id|hp-&gt;hm_revision
op_ne
l_int|0xa0
)paren
id|hp-&gt;happy_flags
op_assign
id|HFLAG_NOT_A0
suffix:semicolon
r_if
c_cond
(paren
id|qp
op_ne
l_int|NULL
)paren
id|hp-&gt;happy_flags
op_or_assign
id|HFLAG_QUATTRO
suffix:semicolon
multiline_comment|/* Get the supported DVMA burst sizes from our Happy SBUS. */
id|hp-&gt;happy_bursts
op_assign
id|prom_getintdefault
c_func
(paren
id|sdev-&gt;bus-&gt;prom_node
comma
l_string|&quot;burst-sizes&quot;
comma
l_int|0x00
)paren
suffix:semicolon
id|hp-&gt;happy_block
op_assign
id|sbus_alloc_consistent
c_func
(paren
id|hp-&gt;happy_dev
comma
id|PAGE_SIZE
comma
op_amp
id|hp-&gt;hblock_dvma
)paren
suffix:semicolon
multiline_comment|/* Force check of the link first time we are brought up. */
id|hp-&gt;linkcheck
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Force timer state to &squot;asleep&squot; with count of zero. */
id|hp-&gt;timer_state
op_assign
id|asleep
suffix:semicolon
id|hp-&gt;timer_ticks
op_assign
l_int|0
suffix:semicolon
id|init_timer
c_func
(paren
op_amp
id|hp-&gt;happy_timer
)paren
suffix:semicolon
id|hp-&gt;dev
op_assign
id|dev
suffix:semicolon
id|dev-&gt;open
op_assign
op_amp
id|happy_meal_open
suffix:semicolon
id|dev-&gt;stop
op_assign
op_amp
id|happy_meal_close
suffix:semicolon
id|dev-&gt;hard_start_xmit
op_assign
op_amp
id|happy_meal_start_xmit
suffix:semicolon
id|dev-&gt;get_stats
op_assign
op_amp
id|happy_meal_get_stats
suffix:semicolon
id|dev-&gt;set_multicast_list
op_assign
op_amp
id|happy_meal_set_multicast
suffix:semicolon
id|dev-&gt;tx_timeout
op_assign
op_amp
id|happy_meal_tx_timeout
suffix:semicolon
id|dev-&gt;watchdog_timeo
op_assign
l_int|5
op_star
id|HZ
suffix:semicolon
id|dev-&gt;do_ioctl
op_assign
op_amp
id|happy_meal_ioctl
suffix:semicolon
id|dev-&gt;irq
op_assign
id|sdev-&gt;irqs
(braket
l_int|0
)braket
suffix:semicolon
macro_line|#if defined(CONFIG_SBUS) &amp;&amp; defined(CONFIG_PCI)
multiline_comment|/* Hook up PCI register/dma accessors. */
id|hp-&gt;read_desc32
op_assign
id|sbus_hme_read_desc32
suffix:semicolon
id|hp-&gt;write_txd
op_assign
id|sbus_hme_write_txd
suffix:semicolon
id|hp-&gt;write_rxd
op_assign
id|sbus_hme_write_rxd
suffix:semicolon
id|hp-&gt;dma_map
op_assign
(paren
id|u32
(paren
op_star
)paren
(paren
r_void
op_star
comma
r_void
op_star
comma
r_int
comma
r_int
)paren
)paren
id|sbus_map_single
suffix:semicolon
id|hp-&gt;dma_unmap
op_assign
(paren
r_void
(paren
op_star
)paren
(paren
r_void
op_star
comma
id|u32
comma
r_int
comma
r_int
)paren
)paren
id|sbus_unmap_single
suffix:semicolon
id|hp-&gt;dma_sync
op_assign
(paren
r_void
(paren
op_star
)paren
(paren
r_void
op_star
comma
id|u32
comma
r_int
comma
r_int
)paren
)paren
id|sbus_dma_sync_single
suffix:semicolon
id|hp-&gt;read32
op_assign
id|sbus_hme_read32
suffix:semicolon
id|hp-&gt;write32
op_assign
id|sbus_hme_write32
suffix:semicolon
macro_line|#endif
multiline_comment|/* Grrr, Happy Meal comes up by default not advertising&n;&t; * full duplex 100baseT capabilities, fix this.&n;&t; */
id|happy_meal_set_initial_advertisement
c_func
(paren
id|hp
)paren
suffix:semicolon
id|ether_setup
c_func
(paren
id|dev
)paren
suffix:semicolon
multiline_comment|/* We are home free at this point, link us in to the happy&n;&t; * device list.&n;&t; */
id|dev-&gt;ifindex
op_assign
id|dev_new_index
c_func
(paren
)paren
suffix:semicolon
id|hp-&gt;next_module
op_assign
id|root_happy_dev
suffix:semicolon
id|root_happy_dev
op_assign
id|hp
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#endif
macro_line|#ifdef CONFIG_PCI
DECL|function|happy_meal_pci_init
r_static
r_int
id|__init
id|happy_meal_pci_init
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_struct
id|pci_dev
op_star
id|pdev
)paren
(brace
r_struct
id|quattro
op_star
id|qp
op_assign
l_int|NULL
suffix:semicolon
macro_line|#ifdef __sparc__
r_struct
id|pcidev_cookie
op_star
id|pcp
suffix:semicolon
r_int
id|node
suffix:semicolon
macro_line|#endif
r_struct
id|happy_meal
op_star
id|hp
suffix:semicolon
r_int
r_int
id|hpreg_base
suffix:semicolon
r_int
id|i
comma
id|qfe_slot
op_assign
op_minus
l_int|1
suffix:semicolon
r_char
id|prom_name
(braket
l_int|64
)braket
suffix:semicolon
multiline_comment|/* Now make sure pci_dev cookie is there. */
macro_line|#ifdef __sparc__
id|pcp
op_assign
id|pdev-&gt;sysdata
suffix:semicolon
r_if
c_cond
(paren
id|pcp
op_eq
l_int|NULL
op_logical_or
id|pcp-&gt;prom_node
op_eq
op_minus
l_int|1
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;happymeal(PCI): Some PCI device info missing&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
id|node
op_assign
id|pcp-&gt;prom_node
suffix:semicolon
id|prom_getstring
c_func
(paren
id|node
comma
l_string|&quot;name&quot;
comma
id|prom_name
comma
r_sizeof
(paren
id|prom_name
)paren
)paren
suffix:semicolon
macro_line|#else
macro_line|#warning This needs to be corrected... -DaveM
id|strcpy
c_func
(paren
id|prom_name
comma
l_string|&quot;qfe&quot;
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
op_logical_neg
id|strcmp
c_func
(paren
id|prom_name
comma
l_string|&quot;SUNW,qfe&quot;
)paren
op_logical_or
op_logical_neg
id|strcmp
c_func
(paren
id|prom_name
comma
l_string|&quot;qfe&quot;
)paren
)paren
(brace
id|qp
op_assign
id|quattro_pci_find
c_func
(paren
id|pdev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|qp
op_eq
l_int|NULL
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
r_for
c_loop
(paren
id|qfe_slot
op_assign
l_int|0
suffix:semicolon
id|qfe_slot
OL
l_int|4
suffix:semicolon
id|qfe_slot
op_increment
)paren
r_if
c_cond
(paren
id|qp-&gt;happy_meals
(braket
id|qfe_slot
)braket
op_eq
l_int|NULL
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
id|qfe_slot
op_eq
l_int|4
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
r_if
c_cond
(paren
id|dev
op_eq
l_int|NULL
)paren
(brace
id|dev
op_assign
id|init_etherdev
c_func
(paren
l_int|0
comma
r_sizeof
(paren
r_struct
id|happy_meal
)paren
)paren
suffix:semicolon
)brace
r_else
(brace
id|dev-&gt;priv
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|happy_meal
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;priv
op_eq
l_int|NULL
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
r_if
c_cond
(paren
id|hme_version_printed
op_increment
op_eq
l_int|0
)paren
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s&quot;
comma
id|version
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|qfe_slot
)paren
(brace
r_struct
id|pci_dev
op_star
id|qpdev
op_assign
id|qp-&gt;quattro_dev
suffix:semicolon
id|prom_name
(braket
l_int|0
)braket
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|strncmp
c_func
(paren
id|dev-&gt;name
comma
l_string|&quot;eth&quot;
comma
l_int|3
)paren
)paren
(brace
r_int
id|i
op_assign
id|simple_strtoul
c_func
(paren
id|dev-&gt;name
op_plus
l_int|3
comma
l_int|NULL
comma
l_int|10
)paren
suffix:semicolon
id|sprintf
c_func
(paren
id|prom_name
comma
l_string|&quot;-%d&quot;
comma
id|i
op_plus
l_int|3
)paren
suffix:semicolon
)brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s%s: Quattro HME (PCI/CheerIO) 10/100baseT Ethernet &quot;
comma
id|dev-&gt;name
comma
id|prom_name
)paren
suffix:semicolon
r_if
c_cond
(paren
id|qpdev-&gt;vendor
op_eq
id|PCI_VENDOR_ID_DEC
op_logical_and
id|qpdev-&gt;device
op_eq
id|PCI_DEVICE_ID_DEC_21153
)paren
id|printk
c_func
(paren
l_string|&quot;DEC 21153 PCI Bridge&bslash;n&quot;
)paren
suffix:semicolon
r_else
id|printk
c_func
(paren
l_string|&quot;unknown bridge %04x.%04x&bslash;n&quot;
comma
id|qpdev-&gt;vendor
comma
id|qpdev-&gt;device
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|qfe_slot
op_ne
op_minus
l_int|1
)paren
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Quattro HME slot %d (PCI/CheerIO) 10/100baseT Ethernet &quot;
comma
id|dev-&gt;name
comma
id|qfe_slot
)paren
suffix:semicolon
r_else
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: HAPPY MEAL (PCI/CheerIO) 10/100BaseT Ethernet &quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|dev-&gt;base_addr
op_assign
(paren
r_int
)paren
id|pdev
suffix:semicolon
id|hp
op_assign
(paren
r_struct
id|happy_meal
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|memset
c_func
(paren
id|hp
comma
l_int|0
comma
r_sizeof
(paren
op_star
id|hp
)paren
)paren
suffix:semicolon
id|hp-&gt;happy_dev
op_assign
id|pdev
suffix:semicolon
id|spin_lock_init
c_func
(paren
op_amp
id|hp-&gt;happy_lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|qp
op_ne
l_int|NULL
)paren
(brace
id|hp-&gt;qfe_parent
op_assign
id|qp
suffix:semicolon
id|hp-&gt;qfe_ent
op_assign
id|qfe_slot
suffix:semicolon
id|qp-&gt;happy_meals
(braket
id|qfe_slot
)braket
op_assign
id|dev
suffix:semicolon
)brace
id|hpreg_base
op_assign
id|pci_resource_start
c_func
(paren
id|pdev
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|pci_resource_flags
c_func
(paren
id|pdev
comma
l_int|0
)paren
op_amp
id|IORESOURCE_IO
)paren
op_ne
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;happymeal(PCI): Cannot find proper PCI device base address.&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
id|hpreg_base
op_assign
(paren
r_int
r_int
)paren
id|ioremap
c_func
(paren
id|hpreg_base
comma
l_int|0x8000
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|6
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|macaddr
(braket
id|i
)braket
op_ne
l_int|0
)paren
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|i
OL
l_int|6
)paren
(brace
multiline_comment|/* a mac address was given */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|6
suffix:semicolon
id|i
op_increment
)paren
id|dev-&gt;dev_addr
(braket
id|i
)braket
op_assign
id|macaddr
(braket
id|i
)braket
suffix:semicolon
)brace
r_else
(brace
macro_line|#ifdef __sparc__
r_if
c_cond
(paren
id|qfe_slot
op_ne
op_minus
l_int|1
op_logical_and
id|prom_getproplen
c_func
(paren
id|node
comma
l_string|&quot;local-mac-address&quot;
)paren
op_eq
l_int|6
)paren
(brace
id|prom_getproperty
c_func
(paren
id|node
comma
l_string|&quot;local-mac-address&quot;
comma
id|dev-&gt;dev_addr
comma
l_int|6
)paren
suffix:semicolon
)brace
r_else
(brace
id|memcpy
c_func
(paren
id|dev-&gt;dev_addr
comma
id|idprom-&gt;id_ethaddr
comma
l_int|6
)paren
suffix:semicolon
)brace
macro_line|#else
id|memset
c_func
(paren
id|dev-&gt;dev_addr
comma
l_int|0
comma
l_int|6
)paren
suffix:semicolon
macro_line|#endif
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|6
suffix:semicolon
id|i
op_increment
)paren
id|printk
c_func
(paren
l_string|&quot;%2.2x%c&quot;
comma
id|dev-&gt;dev_addr
(braket
id|i
)braket
comma
id|i
op_eq
l_int|5
ques
c_cond
l_char|&squot; &squot;
suffix:colon
l_char|&squot;:&squot;
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* Layout registers. */
id|hp-&gt;gregs
op_assign
(paren
id|hpreg_base
op_plus
l_int|0x0000UL
)paren
suffix:semicolon
id|hp-&gt;etxregs
op_assign
(paren
id|hpreg_base
op_plus
l_int|0x2000UL
)paren
suffix:semicolon
id|hp-&gt;erxregs
op_assign
(paren
id|hpreg_base
op_plus
l_int|0x4000UL
)paren
suffix:semicolon
id|hp-&gt;bigmacregs
op_assign
(paren
id|hpreg_base
op_plus
l_int|0x6000UL
)paren
suffix:semicolon
id|hp-&gt;tcvregs
op_assign
(paren
id|hpreg_base
op_plus
l_int|0x7000UL
)paren
suffix:semicolon
macro_line|#ifdef __sparc__
id|hp-&gt;hm_revision
op_assign
id|prom_getintdefault
c_func
(paren
id|node
comma
l_string|&quot;hm-rev&quot;
comma
l_int|0xff
)paren
suffix:semicolon
r_if
c_cond
(paren
id|hp-&gt;hm_revision
op_eq
l_int|0xff
)paren
id|hp-&gt;hm_revision
op_assign
l_int|0xa0
suffix:semicolon
macro_line|#else
multiline_comment|/* works with this on non-sparc hosts */
id|hp-&gt;hm_revision
op_assign
l_int|0x20
suffix:semicolon
macro_line|#endif
multiline_comment|/* Now enable the feature flags we can. */
r_if
c_cond
(paren
id|hp-&gt;hm_revision
op_eq
l_int|0x20
op_logical_or
id|hp-&gt;hm_revision
op_eq
l_int|0x21
)paren
id|hp-&gt;happy_flags
op_assign
id|HFLAG_20_21
suffix:semicolon
r_else
r_if
c_cond
(paren
id|hp-&gt;hm_revision
op_ne
l_int|0xa0
)paren
id|hp-&gt;happy_flags
op_assign
id|HFLAG_NOT_A0
suffix:semicolon
r_if
c_cond
(paren
id|qp
op_ne
l_int|NULL
)paren
id|hp-&gt;happy_flags
op_or_assign
id|HFLAG_QUATTRO
suffix:semicolon
multiline_comment|/* And of course, indicate this is PCI. */
id|hp-&gt;happy_flags
op_or_assign
id|HFLAG_PCI
suffix:semicolon
macro_line|#ifdef __sparc__
multiline_comment|/* Assume PCI happy meals can handle all burst sizes. */
id|hp-&gt;happy_bursts
op_assign
id|DMA_BURSTBITS
suffix:semicolon
macro_line|#endif
id|hp-&gt;happy_block
op_assign
(paren
r_struct
id|hmeal_init_block
op_star
)paren
id|pci_alloc_consistent
c_func
(paren
id|pdev
comma
id|PAGE_SIZE
comma
op_amp
id|hp-&gt;hblock_dvma
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|hp-&gt;happy_block
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;happymeal(PCI): Cannot get hme init block.&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
id|hp-&gt;linkcheck
op_assign
l_int|0
suffix:semicolon
id|hp-&gt;timer_state
op_assign
id|asleep
suffix:semicolon
id|hp-&gt;timer_ticks
op_assign
l_int|0
suffix:semicolon
id|init_timer
c_func
(paren
op_amp
id|hp-&gt;happy_timer
)paren
suffix:semicolon
id|hp-&gt;dev
op_assign
id|dev
suffix:semicolon
id|dev-&gt;open
op_assign
op_amp
id|happy_meal_open
suffix:semicolon
id|dev-&gt;stop
op_assign
op_amp
id|happy_meal_close
suffix:semicolon
id|dev-&gt;hard_start_xmit
op_assign
op_amp
id|happy_meal_start_xmit
suffix:semicolon
id|dev-&gt;get_stats
op_assign
op_amp
id|happy_meal_get_stats
suffix:semicolon
id|dev-&gt;set_multicast_list
op_assign
op_amp
id|happy_meal_set_multicast
suffix:semicolon
id|dev-&gt;do_ioctl
op_assign
op_amp
id|happy_meal_ioctl
suffix:semicolon
id|dev-&gt;irq
op_assign
id|pdev-&gt;irq
suffix:semicolon
id|dev-&gt;dma
op_assign
l_int|0
suffix:semicolon
macro_line|#if defined(CONFIG_SBUS) &amp;&amp; defined(CONFIG_PCI)
multiline_comment|/* Hook up PCI register/dma accessors. */
id|hp-&gt;read_desc32
op_assign
id|pci_hme_read_desc32
suffix:semicolon
id|hp-&gt;write_txd
op_assign
id|pci_hme_write_txd
suffix:semicolon
id|hp-&gt;write_rxd
op_assign
id|pci_hme_write_rxd
suffix:semicolon
id|hp-&gt;dma_map
op_assign
(paren
id|u32
(paren
op_star
)paren
(paren
r_void
op_star
comma
r_void
op_star
comma
r_int
comma
r_int
)paren
)paren
id|pci_map_single
suffix:semicolon
id|hp-&gt;dma_unmap
op_assign
(paren
r_void
(paren
op_star
)paren
(paren
r_void
op_star
comma
id|u32
comma
r_int
comma
r_int
)paren
)paren
id|pci_unmap_single
suffix:semicolon
id|hp-&gt;dma_sync
op_assign
(paren
r_void
(paren
op_star
)paren
(paren
r_void
op_star
comma
id|u32
comma
r_int
comma
r_int
)paren
)paren
id|pci_dma_sync_single
suffix:semicolon
id|hp-&gt;read32
op_assign
id|pci_hme_read32
suffix:semicolon
id|hp-&gt;write32
op_assign
id|pci_hme_write32
suffix:semicolon
macro_line|#endif
multiline_comment|/* Grrr, Happy Meal comes up by default not advertising&n;&t; * full duplex 100baseT capabilities, fix this.&n;&t; */
id|happy_meal_set_initial_advertisement
c_func
(paren
id|hp
)paren
suffix:semicolon
id|ether_setup
c_func
(paren
id|dev
)paren
suffix:semicolon
multiline_comment|/* We are home free at this point, link us in to the happy&n;&t; * device list.&n;&t; */
id|dev-&gt;ifindex
op_assign
id|dev_new_index
c_func
(paren
)paren
suffix:semicolon
id|hp-&gt;next_module
op_assign
id|root_happy_dev
suffix:semicolon
id|root_happy_dev
op_assign
id|hp
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#endif
macro_line|#ifdef CONFIG_SBUS
DECL|function|happy_meal_sbus_probe
r_static
r_int
id|__init
id|happy_meal_sbus_probe
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|sbus_bus
op_star
id|sbus
suffix:semicolon
r_struct
id|sbus_dev
op_star
id|sdev
suffix:semicolon
r_int
id|cards
op_assign
l_int|0
suffix:semicolon
id|for_each_sbus
c_func
(paren
id|sbus
)paren
(brace
id|for_each_sbusdev
c_func
(paren
id|sdev
comma
id|sbus
)paren
(brace
r_char
op_star
id|name
op_assign
id|sdev-&gt;prom_name
suffix:semicolon
r_if
c_cond
(paren
id|cards
)paren
id|dev
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|strcmp
c_func
(paren
id|name
comma
l_string|&quot;SUNW,hme&quot;
)paren
)paren
(brace
id|cards
op_increment
suffix:semicolon
id|happy_meal_sbus_init
c_func
(paren
id|dev
comma
id|sdev
comma
l_int|0
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
op_logical_neg
id|strcmp
c_func
(paren
id|name
comma
l_string|&quot;qfe&quot;
)paren
op_logical_or
op_logical_neg
id|strcmp
c_func
(paren
id|name
comma
l_string|&quot;SUNW,qfe&quot;
)paren
)paren
(brace
id|cards
op_increment
suffix:semicolon
id|happy_meal_sbus_init
c_func
(paren
id|dev
comma
id|sdev
comma
l_int|1
)paren
suffix:semicolon
)brace
)brace
)brace
r_if
c_cond
(paren
id|cards
op_ne
l_int|0
)paren
id|quattro_sbus_register_irqs
c_func
(paren
)paren
suffix:semicolon
r_return
id|cards
suffix:semicolon
)brace
macro_line|#endif
macro_line|#ifdef CONFIG_PCI
DECL|function|happy_meal_pci_probe
r_static
r_int
id|__init
id|happy_meal_pci_probe
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|pci_dev
op_star
id|pdev
op_assign
l_int|NULL
suffix:semicolon
r_int
id|cards
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
(paren
id|pdev
op_assign
id|pci_find_device
c_func
(paren
id|PCI_VENDOR_ID_SUN
comma
id|PCI_DEVICE_ID_SUN_HAPPYMEAL
comma
id|pdev
)paren
)paren
op_ne
l_int|NULL
)paren
(brace
r_if
c_cond
(paren
id|pci_enable_device
c_func
(paren
id|pdev
)paren
)paren
r_continue
suffix:semicolon
r_if
c_cond
(paren
id|cards
)paren
id|dev
op_assign
l_int|NULL
suffix:semicolon
id|cards
op_increment
suffix:semicolon
id|happy_meal_pci_init
c_func
(paren
id|dev
comma
id|pdev
)paren
suffix:semicolon
)brace
r_return
id|cards
suffix:semicolon
)brace
macro_line|#endif
DECL|function|happy_meal_probe
r_static
r_int
id|__init
id|happy_meal_probe
c_func
(paren
r_void
)paren
(brace
r_struct
id|net_device
op_star
id|dev
op_assign
l_int|NULL
suffix:semicolon
r_static
r_int
id|called
op_assign
l_int|0
suffix:semicolon
r_int
id|cards
suffix:semicolon
id|root_happy_dev
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
id|called
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
id|called
op_increment
suffix:semicolon
id|cards
op_assign
l_int|0
suffix:semicolon
macro_line|#ifdef CONFIG_SBUS
id|cards
op_add_assign
id|happy_meal_sbus_probe
c_func
(paren
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cards
op_ne
l_int|0
)paren
id|dev
op_assign
l_int|NULL
suffix:semicolon
macro_line|#endif
macro_line|#ifdef CONFIG_PCI
id|cards
op_add_assign
id|happy_meal_pci_probe
c_func
(paren
id|dev
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
op_logical_neg
id|cards
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|happy_meal_cleanup_module
r_static
r_void
id|__exit
id|happy_meal_cleanup_module
c_func
(paren
r_void
)paren
(brace
r_while
c_loop
(paren
id|root_happy_dev
)paren
(brace
r_struct
id|happy_meal
op_star
id|hp
op_assign
id|root_happy_dev
suffix:semicolon
r_struct
id|happy_meal
op_star
id|next
op_assign
id|root_happy_dev-&gt;next_module
suffix:semicolon
macro_line|#ifdef CONFIG_SBUS
r_if
c_cond
(paren
op_logical_neg
(paren
id|hp-&gt;happy_flags
op_amp
id|HFLAG_PCI
)paren
)paren
(brace
id|sbus_iounmap
c_func
(paren
id|hp-&gt;gregs
comma
id|GREG_REG_SIZE
)paren
suffix:semicolon
id|sbus_iounmap
c_func
(paren
id|hp-&gt;etxregs
comma
id|ETX_REG_SIZE
)paren
suffix:semicolon
id|sbus_iounmap
c_func
(paren
id|hp-&gt;erxregs
comma
id|ERX_REG_SIZE
)paren
suffix:semicolon
id|sbus_iounmap
c_func
(paren
id|hp-&gt;bigmacregs
comma
id|BMAC_REG_SIZE
)paren
suffix:semicolon
id|sbus_iounmap
c_func
(paren
id|hp-&gt;tcvregs
comma
id|TCVR_REG_SIZE
)paren
suffix:semicolon
id|sbus_free_consistent
c_func
(paren
id|hp-&gt;happy_dev
comma
id|PAGE_SIZE
comma
id|hp-&gt;happy_block
comma
id|hp-&gt;hblock_dvma
)paren
suffix:semicolon
)brace
macro_line|#endif
macro_line|#ifdef CONFIG_PCI
r_if
c_cond
(paren
(paren
id|hp-&gt;happy_flags
op_amp
id|HFLAG_PCI
)paren
)paren
(brace
id|pci_free_consistent
c_func
(paren
id|hp-&gt;happy_dev
comma
id|PAGE_SIZE
comma
id|hp-&gt;happy_block
comma
id|hp-&gt;hblock_dvma
)paren
suffix:semicolon
)brace
macro_line|#endif
id|unregister_netdev
c_func
(paren
id|hp-&gt;dev
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|hp-&gt;dev
)paren
suffix:semicolon
id|root_happy_dev
op_assign
id|next
suffix:semicolon
)brace
)brace
DECL|variable|happy_meal_probe
id|module_init
c_func
(paren
id|happy_meal_probe
)paren
suffix:semicolon
DECL|variable|happy_meal_cleanup_module
id|module_exit
c_func
(paren
id|happy_meal_cleanup_module
)paren
suffix:semicolon
eof
