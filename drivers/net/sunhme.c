multiline_comment|/* sunhme.c: Sparc HME/BigMac 10/100baseT half/full duplex auto switching,&n; *           auto carrier detecting ethernet driver.  Also known as the&n; *           &quot;Happy Meal Ethernet&quot; found on SunSwift SBUS cards.&n; *&n; * Copyright (C) 1996 David S. Miller (davem@caipfs.rutgers.edu)&n; */
DECL|variable|version
r_static
r_char
op_star
id|version
op_assign
l_string|&quot;sunhme.c:v1.2 10/Oct/96 David S. Miller (davem@caipfs.rutgers.edu)&bslash;n&quot;
suffix:semicolon
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/fcntl.h&gt;
macro_line|#include &lt;linux/interrupt.h&gt;
macro_line|#include &lt;linux/ptrace.h&gt;
macro_line|#include &lt;linux/ioport.h&gt;
macro_line|#include &lt;linux/in.h&gt;
macro_line|#include &lt;linux/malloc.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;asm/system.h&gt;
macro_line|#include &lt;asm/bitops.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/dma.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;asm/byteorder.h&gt;
macro_line|#include &lt;asm/idprom.h&gt;
macro_line|#include &lt;asm/sbus.h&gt;
macro_line|#include &lt;asm/openprom.h&gt;
macro_line|#include &lt;asm/oplib.h&gt;
macro_line|#include &lt;asm/auxio.h&gt;
macro_line|#include &lt;asm/system.h&gt;
macro_line|#include &lt;asm/pgtable.h&gt;
macro_line|#include &lt;linux/netdevice.h&gt;
macro_line|#include &lt;linux/etherdevice.h&gt;
macro_line|#include &lt;linux/skbuff.h&gt;
macro_line|#include &quot;sunhme.h&quot;
macro_line|#ifdef MODULE
DECL|variable|root_happy_dev
r_static
r_struct
id|happy_meal
op_star
id|root_happy_dev
op_assign
l_int|NULL
suffix:semicolon
macro_line|#endif
multiline_comment|/* #define HMEDEBUG */
macro_line|#ifdef HMEDEBUG
DECL|macro|HMD
mdefine_line|#define HMD(x)  printk x
macro_line|#else
DECL|macro|HMD
mdefine_line|#define HMD(x)
macro_line|#endif
multiline_comment|/* #define AUTO_SWITCH_DEBUG */
macro_line|#ifdef AUTO_SWITCH_DEBUG
DECL|macro|ASD
mdefine_line|#define ASD(x)  printk x
macro_line|#else
DECL|macro|ASD
mdefine_line|#define ASD(x)
macro_line|#endif
DECL|macro|DEFAULT_IPG0
mdefine_line|#define DEFAULT_IPG0      32 /* For lance-mode only */
DECL|macro|DEFAULT_IPG1
mdefine_line|#define DEFAULT_IPG1       8 /* For all modes */
DECL|macro|DEFAULT_IPG2
mdefine_line|#define DEFAULT_IPG2       4 /* For all modes */
DECL|macro|DEFAULT_JAMSIZE
mdefine_line|#define DEFAULT_JAMSIZE    4 /* Toe jam */
multiline_comment|/* Oh yes, the MIF BitBang is mighty fun to program.  BitBucket is more like it. */
DECL|macro|BB_PUT_BIT
mdefine_line|#define BB_PUT_BIT(tregs, bit) &bslash;&n;do { (tregs)-&gt;bb_data = (bit); (tregs)-&gt;bb_clock = 0; (tregs)-&gt;bb_clock = 1; } while(0)
DECL|macro|BB_GET_BIT
mdefine_line|#define BB_GET_BIT(tregs, internal)              &bslash;&n;({                                               &bslash;&n;&t;(tregs)-&gt;bb_clock = 0;                   &bslash;&n;&t;(tregs)-&gt;bb_clock = 1;                   &bslash;&n;&t;if(internal)                             &bslash;&n;&t;&t;((tregs)-&gt;cfg &amp; TCV_CFG_MDIO0);  &bslash;&n;&t;else                                     &bslash;&n;&t;&t;((tregs)-&gt;cfg &amp; TCV_CFG_MDIO1);  &bslash;&n;})
DECL|macro|BB_GET_BIT2
mdefine_line|#define BB_GET_BIT2(tregs, internal)                      &bslash;&n;({                                                        &bslash;&n;&t;int retval;                                       &bslash;&n;&t;(tregs)-&gt;bb_clock = 0;                            &bslash;&n;&t;udelay(1);                                        &bslash;&n;&t;if(internal)                                      &bslash;&n;&t;&t;retval = ((tregs)-&gt;cfg &amp; TCV_CFG_MDIO0);  &bslash;&n;&t;else                                              &bslash;&n;&t;&t;retval = ((tregs)-&gt;cfg &amp; TCV_CFG_MDIO1);  &bslash;&n;&t;(tregs)-&gt;bb_clock = 1;                            &bslash;&n;&t;retval;                                           &bslash;&n;})
DECL|macro|TCVR_FAILURE
mdefine_line|#define TCVR_FAILURE      0x80000000     /* Impossible MIF read value */
DECL|function|happy_meal_bb_read
r_static
r_inline
r_int
id|happy_meal_bb_read
c_func
(paren
r_struct
id|happy_meal
op_star
id|hp
comma
r_struct
id|hmeal_tcvregs
op_star
id|tregs
comma
r_int
id|reg
)paren
(brace
r_volatile
r_int
id|unused
suffix:semicolon
r_int
r_int
id|tmp
suffix:semicolon
r_int
id|retval
op_assign
l_int|0
suffix:semicolon
r_int
id|i
suffix:semicolon
id|ASD
c_func
(paren
(paren
l_string|&quot;happy_meal_bb_read: reg=%d &quot;
comma
id|reg
)paren
)paren
suffix:semicolon
multiline_comment|/* Enable the MIF BitBang outputs. */
id|tregs-&gt;bb_oenab
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* Force BitBang into the idle state. */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|32
suffix:semicolon
id|i
op_increment
)paren
(brace
id|BB_PUT_BIT
c_func
(paren
id|tregs
comma
l_int|1
)paren
suffix:semicolon
)brace
multiline_comment|/* Give it the read sequence. */
id|BB_PUT_BIT
c_func
(paren
id|tregs
comma
l_int|0
)paren
suffix:semicolon
id|BB_PUT_BIT
c_func
(paren
id|tregs
comma
l_int|1
)paren
suffix:semicolon
id|BB_PUT_BIT
c_func
(paren
id|tregs
comma
l_int|1
)paren
suffix:semicolon
id|BB_PUT_BIT
c_func
(paren
id|tregs
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* Give it the PHY address. */
id|tmp
op_assign
id|hp-&gt;paddr
op_amp
l_int|0xff
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|4
suffix:semicolon
id|i
op_ge
l_int|0
suffix:semicolon
id|i
op_decrement
)paren
(brace
id|BB_PUT_BIT
c_func
(paren
id|tregs
comma
(paren
(paren
id|tmp
op_rshift
id|i
)paren
op_amp
l_int|1
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/* Tell it what register we want to read. */
id|tmp
op_assign
(paren
id|reg
op_amp
l_int|0xff
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|4
suffix:semicolon
id|i
op_ge
l_int|0
suffix:semicolon
id|i
op_decrement
)paren
(brace
id|BB_PUT_BIT
c_func
(paren
id|tregs
comma
(paren
(paren
id|tmp
op_rshift
id|i
)paren
op_amp
l_int|1
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/* Close down the MIF BitBang outputs. */
id|tregs-&gt;bb_oenab
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Now read in the value. */
id|unused
op_assign
id|BB_GET_BIT2
c_func
(paren
id|tregs
comma
(paren
id|hp-&gt;tcvr_type
op_eq
id|internal
)paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|15
suffix:semicolon
id|i
op_ge
l_int|0
suffix:semicolon
id|i
op_decrement
)paren
(brace
id|retval
op_or_assign
id|BB_GET_BIT2
c_func
(paren
id|tregs
comma
(paren
id|hp-&gt;tcvr_type
op_eq
id|internal
)paren
)paren
suffix:semicolon
)brace
id|unused
op_assign
id|BB_GET_BIT2
c_func
(paren
id|tregs
comma
(paren
id|hp-&gt;tcvr_type
op_eq
id|internal
)paren
)paren
suffix:semicolon
id|unused
op_assign
id|BB_GET_BIT2
c_func
(paren
id|tregs
comma
(paren
id|hp-&gt;tcvr_type
op_eq
id|internal
)paren
)paren
suffix:semicolon
id|unused
op_assign
id|BB_GET_BIT2
c_func
(paren
id|tregs
comma
(paren
id|hp-&gt;tcvr_type
op_eq
id|internal
)paren
)paren
suffix:semicolon
id|ASD
c_func
(paren
(paren
l_string|&quot;value=%x&bslash;n&quot;
comma
id|retval
)paren
)paren
suffix:semicolon
r_return
id|retval
suffix:semicolon
)brace
DECL|function|happy_meal_bb_write
r_static
r_inline
r_void
id|happy_meal_bb_write
c_func
(paren
r_struct
id|happy_meal
op_star
id|hp
comma
r_struct
id|hmeal_tcvregs
op_star
id|tregs
comma
r_int
id|reg
comma
r_int
r_int
id|value
)paren
(brace
r_int
r_int
id|tmp
suffix:semicolon
r_int
id|i
suffix:semicolon
id|ASD
c_func
(paren
(paren
l_string|&quot;happy_meal_bb_write: reg=%d value=%x&bslash;n&quot;
comma
id|reg
comma
id|value
)paren
)paren
suffix:semicolon
multiline_comment|/* Enable the MIF BitBang outputs. */
id|tregs-&gt;bb_oenab
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* Force BitBang into the idle state. */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|32
suffix:semicolon
id|i
op_increment
)paren
(brace
id|BB_PUT_BIT
c_func
(paren
id|tregs
comma
l_int|1
)paren
suffix:semicolon
)brace
multiline_comment|/* Give it write sequence. */
id|BB_PUT_BIT
c_func
(paren
id|tregs
comma
l_int|0
)paren
suffix:semicolon
id|BB_PUT_BIT
c_func
(paren
id|tregs
comma
l_int|1
)paren
suffix:semicolon
id|BB_PUT_BIT
c_func
(paren
id|tregs
comma
l_int|0
)paren
suffix:semicolon
id|BB_PUT_BIT
c_func
(paren
id|tregs
comma
l_int|1
)paren
suffix:semicolon
multiline_comment|/* Give it the PHY address. */
id|tmp
op_assign
(paren
id|hp-&gt;paddr
op_amp
l_int|0xff
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|4
suffix:semicolon
id|i
op_ge
l_int|0
suffix:semicolon
id|i
op_decrement
)paren
(brace
id|BB_PUT_BIT
c_func
(paren
id|tregs
comma
(paren
(paren
id|tmp
op_rshift
id|i
)paren
op_amp
l_int|1
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/* Tell it what register we will be writing. */
id|tmp
op_assign
(paren
id|reg
op_amp
l_int|0xff
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|4
suffix:semicolon
id|i
op_ge
l_int|0
suffix:semicolon
id|i
op_decrement
)paren
(brace
id|BB_PUT_BIT
c_func
(paren
id|tregs
comma
(paren
(paren
id|tmp
op_rshift
id|i
)paren
op_amp
l_int|1
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/* Tell it to become ready for the bits. */
id|BB_PUT_BIT
c_func
(paren
id|tregs
comma
l_int|1
)paren
suffix:semicolon
id|BB_PUT_BIT
c_func
(paren
id|tregs
comma
l_int|0
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|15
suffix:semicolon
id|i
op_ge
l_int|0
suffix:semicolon
id|i
op_decrement
)paren
(brace
id|BB_PUT_BIT
c_func
(paren
id|tregs
comma
(paren
(paren
id|value
op_rshift
id|i
)paren
op_amp
l_int|1
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/* Close down the MIF BitBang outputs. */
id|tregs-&gt;bb_oenab
op_assign
l_int|0
suffix:semicolon
)brace
DECL|macro|TCVR_READ_TRIES
mdefine_line|#define TCVR_READ_TRIES   16
DECL|function|happy_meal_tcvr_read
r_static
r_inline
r_int
id|happy_meal_tcvr_read
c_func
(paren
r_struct
id|happy_meal
op_star
id|hp
comma
r_struct
id|hmeal_tcvregs
op_star
id|tregs
comma
r_int
id|reg
)paren
(brace
r_int
id|tries
op_assign
id|TCVR_READ_TRIES
suffix:semicolon
r_int
id|retval
suffix:semicolon
id|ASD
c_func
(paren
(paren
l_string|&quot;happy_meal_tcvr_read: reg=0x%02x &quot;
comma
id|reg
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|hp-&gt;tcvr_type
op_eq
id|none
)paren
(brace
id|ASD
c_func
(paren
(paren
l_string|&quot;no transceiver, value=TCVR_FAILURE&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_return
id|TCVR_FAILURE
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|hp-&gt;happy_flags
op_amp
id|HFLAG_FENABLE
)paren
)paren
(brace
id|ASD
c_func
(paren
(paren
l_string|&quot;doing bit bang&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_return
id|happy_meal_bb_read
c_func
(paren
id|hp
comma
id|tregs
comma
id|reg
)paren
suffix:semicolon
)brace
id|tregs-&gt;frame
op_assign
(paren
id|FRAME_READ
op_or
(paren
id|hp-&gt;paddr
op_lshift
l_int|23
)paren
op_or
(paren
(paren
id|reg
op_amp
l_int|0xff
)paren
op_lshift
l_int|18
)paren
)paren
suffix:semicolon
r_while
c_loop
(paren
op_logical_neg
(paren
id|tregs-&gt;frame
op_amp
l_int|0x10000
)paren
op_logical_and
op_decrement
id|tries
)paren
(brace
id|udelay
c_func
(paren
l_int|20
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|tries
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;happy meal: Aieee, transceiver MIF read bolixed&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|TCVR_FAILURE
suffix:semicolon
)brace
id|retval
op_assign
id|tregs-&gt;frame
op_amp
l_int|0xffff
suffix:semicolon
id|ASD
c_func
(paren
(paren
l_string|&quot;value=%04x&bslash;n&quot;
comma
id|retval
)paren
)paren
suffix:semicolon
r_return
id|retval
suffix:semicolon
)brace
DECL|macro|TCVR_WRITE_TRIES
mdefine_line|#define TCVR_WRITE_TRIES  16
DECL|function|happy_meal_tcvr_write
r_static
r_inline
r_void
id|happy_meal_tcvr_write
c_func
(paren
r_struct
id|happy_meal
op_star
id|hp
comma
r_struct
id|hmeal_tcvregs
op_star
id|tregs
comma
r_int
id|reg
comma
r_int
r_int
id|value
)paren
(brace
r_int
id|tries
op_assign
id|TCVR_WRITE_TRIES
suffix:semicolon
id|ASD
c_func
(paren
(paren
l_string|&quot;happy_meal_tcvr_write: reg=0x%02x value=%04x&bslash;n&quot;
comma
id|reg
comma
id|value
)paren
)paren
suffix:semicolon
multiline_comment|/* Welcome to Sun Microsystems, can I take your order please? */
r_if
c_cond
(paren
op_logical_neg
id|hp-&gt;happy_flags
op_amp
id|HFLAG_FENABLE
)paren
(brace
r_return
id|happy_meal_bb_write
c_func
(paren
id|hp
comma
id|tregs
comma
id|reg
comma
id|value
)paren
suffix:semicolon
)brace
multiline_comment|/* Would you like fries with that? */
id|tregs-&gt;frame
op_assign
(paren
id|FRAME_WRITE
op_or
(paren
id|hp-&gt;paddr
op_lshift
l_int|23
)paren
op_or
(paren
(paren
id|reg
op_amp
l_int|0xff
)paren
op_lshift
l_int|18
)paren
op_or
(paren
id|value
op_amp
l_int|0xffff
)paren
)paren
suffix:semicolon
r_while
c_loop
(paren
op_logical_neg
(paren
id|tregs-&gt;frame
op_amp
l_int|0x10000
)paren
op_logical_and
op_decrement
id|tries
)paren
(brace
id|udelay
c_func
(paren
l_int|20
)paren
suffix:semicolon
)brace
multiline_comment|/* Anything else? */
r_if
c_cond
(paren
op_logical_neg
id|tries
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;happy meal: Aieee, transceiver MIF write bolixed&bslash;n&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/* Fifty-two cents is your change, have a nice day. */
)brace
multiline_comment|/* Auto negotiation.  The scheme is very simple.  We have a timer routine&n; * that keeps watching the auto negotiation process as it progresses.&n; * The DP83840 is first told to start doing it&squot;s thing, we set up the time&n; * and place the timer state machine in it&squot;s initial state.&n; *&n; * Here the timer peeks at the DP83840 status registers at each click to see&n; * if the auto negotiation has completed, we assume here that the DP83840 PHY&n; * will time out at some point and just tell us what (didn&squot;t) happen.  For&n; * complete coverage we only allow so many of the ticks at this level to run,&n; * when this has expired we print a warning message and try another strategy.&n; * This &quot;other&quot; strategy is to force the interface into various speed/duplex&n; * configurations and we stop when we see a link-up condition before the&n; * maximum number of &quot;peek&quot; ticks have occurred.&n; *&n; * Once a valid link status has been detected we configure the BigMAC and&n; * the rest of the Happy Meal to speak the most efficient protocol we could&n; * get a clean link for.  The priority for link configurations, highest first&n; * is:&n; *                 100 Base-T Full Duplex&n; *                 100 Base-T Half Duplex&n; *                 10 Base-T Full Duplex&n; *                 10 Base-T Half Duplex&n; *&n; * We start a new timer now, after a successful auto negotiation status has&n; * been detected.  This timer just waits for the link-up bit to get set in&n; * the BMCR of the DP83840.  When this occurs we print a kernel log message&n; * describing the link type in use and the fact that it is up.&n; *&n; * If a fatal error of some sort is signalled and detected in the interrupt&n; * service routine, and the chip is reset, or the link is ifconfig&squot;d down&n; * and then back up, this entire process repeats itself all over again.&n; */
DECL|function|try_next_permutation
r_static
r_int
id|try_next_permutation
c_func
(paren
r_struct
id|happy_meal
op_star
id|hp
comma
r_struct
id|hmeal_tcvregs
op_star
id|tregs
)paren
(brace
id|hp-&gt;sw_bmcr
op_assign
id|happy_meal_tcvr_read
c_func
(paren
id|hp
comma
id|tregs
comma
id|DP83840_BMCR
)paren
suffix:semicolon
multiline_comment|/* Downgrade from 100 to 10. */
r_if
c_cond
(paren
id|hp-&gt;sw_bmcr
op_amp
id|BMCR_SPEED100
)paren
(brace
id|hp-&gt;sw_bmcr
op_and_assign
op_complement
(paren
id|BMCR_SPEED100
)paren
suffix:semicolon
id|happy_meal_tcvr_write
c_func
(paren
id|hp
comma
id|tregs
comma
id|DP83840_BMCR
comma
id|hp-&gt;sw_bmcr
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* We&squot;ve tried everything. */
r_return
op_minus
l_int|1
suffix:semicolon
)brace
DECL|function|display_link_mode
r_static
r_void
id|display_link_mode
c_func
(paren
r_struct
id|happy_meal
op_star
id|hp
comma
r_struct
id|hmeal_tcvregs
op_star
id|tregs
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%s: Link is up using &quot;
comma
id|hp-&gt;dev-&gt;name
)paren
suffix:semicolon
r_if
c_cond
(paren
id|hp-&gt;tcvr_type
op_eq
id|external
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;external &quot;
)paren
suffix:semicolon
)brace
r_else
id|printk
c_func
(paren
l_string|&quot;internal &quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;transceiver at &quot;
)paren
suffix:semicolon
id|hp-&gt;sw_lpa
op_assign
id|happy_meal_tcvr_read
c_func
(paren
id|hp
comma
id|tregs
comma
id|DP83840_LPA
)paren
suffix:semicolon
r_if
c_cond
(paren
id|hp-&gt;sw_lpa
op_amp
(paren
id|LPA_100HALF
op_or
id|LPA_100FULL
)paren
)paren
(brace
r_if
c_cond
(paren
id|hp-&gt;sw_lpa
op_amp
id|LPA_100FULL
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;100Mb/s, Full Duplex.&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_else
id|printk
c_func
(paren
l_string|&quot;100Mb/s, Half Duplex.&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|hp-&gt;sw_lpa
op_amp
id|LPA_10FULL
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;10Mb/s, Full Duplex.&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_else
id|printk
c_func
(paren
l_string|&quot;10Mb/s, Half Duplex.&bslash;n&quot;
)paren
suffix:semicolon
)brace
)brace
DECL|function|display_forced_link_mode
r_static
r_void
id|display_forced_link_mode
c_func
(paren
r_struct
id|happy_meal
op_star
id|hp
comma
r_struct
id|hmeal_tcvregs
op_star
id|tregs
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%s: Link has been forced up using &quot;
comma
id|hp-&gt;dev-&gt;name
)paren
suffix:semicolon
r_if
c_cond
(paren
id|hp-&gt;tcvr_type
op_eq
id|external
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;external &quot;
)paren
suffix:semicolon
)brace
r_else
id|printk
c_func
(paren
l_string|&quot;internal &quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;transceiver at &quot;
)paren
suffix:semicolon
id|hp-&gt;sw_bmcr
op_assign
id|happy_meal_tcvr_read
c_func
(paren
id|hp
comma
id|tregs
comma
id|DP83840_BMCR
)paren
suffix:semicolon
r_if
c_cond
(paren
id|hp-&gt;sw_bmcr
op_amp
id|BMCR_SPEED100
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;100Mb/s, &quot;
)paren
suffix:semicolon
)brace
r_else
id|printk
c_func
(paren
l_string|&quot;10Mb/s, &quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|hp-&gt;sw_bmcr
op_amp
id|BMCR_FULLDPLX
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;Full Duplex.&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_else
id|printk
c_func
(paren
l_string|&quot;Half Duplex.&bslash;n&quot;
)paren
suffix:semicolon
)brace
DECL|function|set_happy_link_modes
r_static
r_int
id|set_happy_link_modes
c_func
(paren
r_struct
id|happy_meal
op_star
id|hp
comma
r_struct
id|hmeal_tcvregs
op_star
id|tregs
)paren
(brace
r_int
id|full
suffix:semicolon
multiline_comment|/* All we care about is making sure the bigmac tx_cfg has a&n;&t; * proper duplex setting.&n;&t; */
r_if
c_cond
(paren
id|hp-&gt;timer_state
op_eq
id|arbwait
)paren
(brace
id|hp-&gt;sw_lpa
op_assign
id|happy_meal_tcvr_read
c_func
(paren
id|hp
comma
id|tregs
comma
id|DP83840_LPA
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|hp-&gt;sw_lpa
op_amp
(paren
id|LPA_10HALF
op_or
id|LPA_10FULL
op_or
id|LPA_100HALF
op_or
id|LPA_100FULL
)paren
)paren
)paren
(brace
r_goto
id|no_response
suffix:semicolon
)brace
r_if
c_cond
(paren
id|hp-&gt;sw_lpa
op_amp
id|LPA_100FULL
)paren
(brace
id|full
op_assign
l_int|1
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|hp-&gt;sw_lpa
op_amp
id|LPA_100HALF
)paren
(brace
id|full
op_assign
l_int|0
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|hp-&gt;sw_lpa
op_amp
id|LPA_10FULL
)paren
(brace
id|full
op_assign
l_int|1
suffix:semicolon
)brace
r_else
id|full
op_assign
l_int|0
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* Forcing a link mode. */
id|hp-&gt;sw_bmcr
op_assign
id|happy_meal_tcvr_read
c_func
(paren
id|hp
comma
id|tregs
comma
id|DP83840_BMCR
)paren
suffix:semicolon
r_if
c_cond
(paren
id|hp-&gt;sw_bmcr
op_amp
id|BMCR_FULLDPLX
)paren
(brace
id|full
op_assign
l_int|1
suffix:semicolon
)brace
r_else
id|full
op_assign
l_int|0
suffix:semicolon
)brace
multiline_comment|/* XXX This may not be enough, we may need to reinit the entire&n;&t; * XXX Happy Meal front end for this to work every time.&n;&t; */
r_if
c_cond
(paren
id|full
)paren
(brace
id|hp-&gt;bigmacregs-&gt;tx_cfg
op_or_assign
id|BIGMAC_TXCFG_FULLDPLX
suffix:semicolon
)brace
r_else
id|hp-&gt;bigmacregs-&gt;tx_cfg
op_and_assign
op_complement
(paren
id|BIGMAC_TXCFG_FULLDPLX
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
id|no_response
suffix:colon
r_return
l_int|1
suffix:semicolon
)brace
r_static
r_int
id|happy_meal_init
c_func
(paren
r_struct
id|happy_meal
op_star
id|hp
comma
r_int
id|from_irq
)paren
suffix:semicolon
DECL|function|happy_meal_timer
r_static
r_void
id|happy_meal_timer
c_func
(paren
r_int
r_int
id|data
)paren
(brace
r_struct
id|happy_meal
op_star
id|hp
op_assign
(paren
r_struct
id|happy_meal
op_star
)paren
id|data
suffix:semicolon
r_struct
id|hmeal_tcvregs
op_star
id|tregs
op_assign
id|hp-&gt;tcvregs
suffix:semicolon
r_int
id|restart_timer
op_assign
l_int|0
suffix:semicolon
id|hp-&gt;timer_ticks
op_increment
suffix:semicolon
r_switch
c_cond
(paren
id|hp-&gt;timer_state
)paren
(brace
r_case
id|arbwait
suffix:colon
multiline_comment|/* Only allow for 5 ticks, thats 10 seconds and much too&n;&t;&t; * long to wait for arbitration to complete.&n;&t;&t; */
r_if
c_cond
(paren
id|hp-&gt;timer_ticks
op_ge
l_int|10
)paren
(brace
multiline_comment|/* Enter force mode. */
id|do_force_mode
suffix:colon
id|hp-&gt;sw_bmcr
op_assign
id|happy_meal_tcvr_read
c_func
(paren
id|hp
comma
id|tregs
comma
id|DP83840_BMCR
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;%s: Auto-Negotiation unsuccessful, trying force link mode&bslash;n&quot;
comma
id|hp-&gt;dev-&gt;name
)paren
suffix:semicolon
id|hp-&gt;sw_bmcr
op_assign
id|BMCR_SPEED100
suffix:semicolon
id|happy_meal_tcvr_write
c_func
(paren
id|hp
comma
id|tregs
comma
id|DP83840_BMCR
comma
id|hp-&gt;sw_bmcr
)paren
suffix:semicolon
multiline_comment|/* OK, seems we need do disable the transceiver for the first&n;&t;&t;&t; * tick to make sure we get an accurate link state at the&n;&t;&t;&t; * second tick.&n;&t;&t;&t; */
id|hp-&gt;sw_csconfig
op_assign
id|happy_meal_tcvr_read
c_func
(paren
id|hp
comma
id|tregs
comma
id|DP83840_CSCONFIG
)paren
suffix:semicolon
id|hp-&gt;sw_csconfig
op_and_assign
op_complement
(paren
id|CSCONFIG_TCVDISAB
)paren
suffix:semicolon
id|happy_meal_tcvr_write
c_func
(paren
id|hp
comma
id|tregs
comma
id|DP83840_CSCONFIG
comma
id|hp-&gt;sw_csconfig
)paren
suffix:semicolon
id|hp-&gt;timer_state
op_assign
id|ltrywait
suffix:semicolon
id|hp-&gt;timer_ticks
op_assign
l_int|0
suffix:semicolon
id|restart_timer
op_assign
l_int|1
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* Anything interesting happen? */
id|hp-&gt;sw_bmsr
op_assign
id|happy_meal_tcvr_read
c_func
(paren
id|hp
comma
id|tregs
comma
id|DP83840_BMSR
)paren
suffix:semicolon
r_if
c_cond
(paren
id|hp-&gt;sw_bmsr
op_amp
id|BMSR_ANEGCOMPLETE
)paren
(brace
r_int
id|ret
suffix:semicolon
multiline_comment|/* Just what we&squot;ve been waiting for... */
id|ret
op_assign
id|set_happy_link_modes
c_func
(paren
id|hp
comma
id|tregs
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
)paren
(brace
multiline_comment|/* Ooops, something bad happened, go to force&n;&t;&t;&t;&t;&t; * mode.&n;&t;&t;&t;&t;&t; *&n;&t;&t;&t;&t;&t; * XXX Broken hubs which don&squot;t support 802.3u&n;&t;&t;&t;&t;&t; * XXX auto-negotiation make this happen as well.&n;&t;&t;&t;&t;&t; */
r_goto
id|do_force_mode
suffix:semicolon
)brace
multiline_comment|/* Success, at least so far, advance our state engine. */
id|hp-&gt;timer_state
op_assign
id|lupwait
suffix:semicolon
id|restart_timer
op_assign
l_int|1
suffix:semicolon
)brace
r_else
(brace
id|restart_timer
op_assign
l_int|1
suffix:semicolon
)brace
)brace
r_break
suffix:semicolon
r_case
id|lupwait
suffix:colon
multiline_comment|/* Auto negotiation was successful and we are awaiting a&n;&t;&t; * link up status.  I have decided to let this timer run&n;&t;&t; * forever until some sort of error is signalled, reporting&n;&t;&t; * a message to the user at 10 second intervals.&n;&t;&t; */
id|hp-&gt;sw_bmsr
op_assign
id|happy_meal_tcvr_read
c_func
(paren
id|hp
comma
id|tregs
comma
id|DP83840_BMSR
)paren
suffix:semicolon
r_if
c_cond
(paren
id|hp-&gt;sw_bmsr
op_amp
id|BMSR_LSTATUS
)paren
(brace
multiline_comment|/* Wheee, it&squot;s up, display the link mode in use and put&n;&t;&t;&t; * the timer to sleep.&n;&t;&t;&t; */
id|display_link_mode
c_func
(paren
id|hp
comma
id|tregs
)paren
suffix:semicolon
id|hp-&gt;timer_state
op_assign
id|asleep
suffix:semicolon
id|restart_timer
op_assign
l_int|0
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|hp-&gt;timer_ticks
op_ge
l_int|10
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%s: Auto negotiation successful, link still &quot;
l_string|&quot;not completely up.&bslash;n&quot;
comma
id|hp-&gt;dev-&gt;name
)paren
suffix:semicolon
id|hp-&gt;timer_ticks
op_assign
l_int|0
suffix:semicolon
id|restart_timer
op_assign
l_int|1
suffix:semicolon
)brace
r_else
(brace
id|restart_timer
op_assign
l_int|1
suffix:semicolon
)brace
)brace
r_break
suffix:semicolon
r_case
id|ltrywait
suffix:colon
multiline_comment|/* Making the timeout here too long can make it take&n;&t;&t; * annoyingly long to attempt all of the link mode&n;&t;&t; * permutations, but then again this is essentially&n;&t;&t; * error recovery code for the most part.&n;&t;&t; */
id|hp-&gt;sw_bmsr
op_assign
id|happy_meal_tcvr_read
c_func
(paren
id|hp
comma
id|tregs
comma
id|DP83840_BMSR
)paren
suffix:semicolon
id|hp-&gt;sw_csconfig
op_assign
id|happy_meal_tcvr_read
c_func
(paren
id|hp
comma
id|tregs
comma
id|DP83840_CSCONFIG
)paren
suffix:semicolon
r_if
c_cond
(paren
id|hp-&gt;timer_ticks
op_eq
l_int|1
)paren
(brace
multiline_comment|/* Re-enable transceiver, we&squot;ll re-enable the transceiver next&n;&t;&t;&t; * tick, then check link state on the following tick. */
id|hp-&gt;sw_csconfig
op_or_assign
id|CSCONFIG_TCVDISAB
suffix:semicolon
id|happy_meal_tcvr_write
c_func
(paren
id|hp
comma
id|tregs
comma
id|DP83840_CSCONFIG
comma
id|hp-&gt;sw_csconfig
)paren
suffix:semicolon
id|restart_timer
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|hp-&gt;timer_ticks
op_eq
l_int|2
)paren
(brace
id|hp-&gt;sw_csconfig
op_and_assign
op_complement
(paren
id|CSCONFIG_TCVDISAB
)paren
suffix:semicolon
id|happy_meal_tcvr_write
c_func
(paren
id|hp
comma
id|tregs
comma
id|DP83840_CSCONFIG
comma
id|hp-&gt;sw_csconfig
)paren
suffix:semicolon
id|restart_timer
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|hp-&gt;sw_bmsr
op_amp
id|BMSR_LSTATUS
)paren
(brace
multiline_comment|/* Force mode selection success. */
id|display_forced_link_mode
c_func
(paren
id|hp
comma
id|tregs
)paren
suffix:semicolon
id|set_happy_link_modes
c_func
(paren
id|hp
comma
id|tregs
)paren
suffix:semicolon
multiline_comment|/* XXX error? then what? */
id|hp-&gt;timer_state
op_assign
id|asleep
suffix:semicolon
id|restart_timer
op_assign
l_int|0
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|hp-&gt;timer_ticks
op_ge
l_int|4
)paren
(brace
multiline_comment|/* 6 seconds or so... */
r_int
id|ret
suffix:semicolon
id|ret
op_assign
id|try_next_permutation
c_func
(paren
id|hp
comma
id|tregs
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
op_eq
op_minus
l_int|1
)paren
(brace
multiline_comment|/* Aieee, tried them all, reset the&n;&t;&t;&t;&t;&t; * chip and try all over again.&n;&t;&t;&t;&t;&t; */
multiline_comment|/* Let the user know... */
id|printk
c_func
(paren
l_string|&quot;%s: Link down, cable problem?&bslash;n&quot;
comma
id|hp-&gt;dev-&gt;name
)paren
suffix:semicolon
id|ret
op_assign
id|happy_meal_init
c_func
(paren
id|hp
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
)paren
(brace
multiline_comment|/* ho hum... */
id|printk
c_func
(paren
l_string|&quot;%s: Error, cannot re-init the &quot;
l_string|&quot;Happy Meal.&bslash;n&quot;
comma
id|hp-&gt;dev-&gt;name
)paren
suffix:semicolon
)brace
r_return
suffix:semicolon
)brace
id|hp-&gt;sw_csconfig
op_assign
id|happy_meal_tcvr_read
c_func
(paren
id|hp
comma
id|tregs
comma
id|DP83840_CSCONFIG
)paren
suffix:semicolon
id|hp-&gt;sw_csconfig
op_or_assign
id|CSCONFIG_TCVDISAB
suffix:semicolon
id|happy_meal_tcvr_write
c_func
(paren
id|hp
comma
id|tregs
comma
id|DP83840_CSCONFIG
comma
id|hp-&gt;sw_csconfig
)paren
suffix:semicolon
id|hp-&gt;timer_ticks
op_assign
l_int|0
suffix:semicolon
id|restart_timer
op_assign
l_int|1
suffix:semicolon
)brace
r_else
(brace
id|restart_timer
op_assign
l_int|1
suffix:semicolon
)brace
)brace
r_break
suffix:semicolon
r_case
id|asleep
suffix:colon
r_default
suffix:colon
multiline_comment|/* Can&squot;t happens.... */
id|printk
c_func
(paren
l_string|&quot;%s: Aieee, link timer is asleep but we got one anyways!&bslash;n&quot;
comma
id|hp-&gt;dev-&gt;name
)paren
suffix:semicolon
id|restart_timer
op_assign
l_int|0
suffix:semicolon
id|hp-&gt;timer_ticks
op_assign
l_int|0
suffix:semicolon
id|hp-&gt;timer_state
op_assign
id|asleep
suffix:semicolon
multiline_comment|/* foo on you */
r_break
suffix:semicolon
)brace
suffix:semicolon
r_if
c_cond
(paren
id|restart_timer
)paren
(brace
id|hp-&gt;happy_timer.expires
op_assign
id|jiffies
op_plus
(paren
(paren
l_int|12
op_star
id|HZ
)paren
op_div
l_int|10
)paren
suffix:semicolon
multiline_comment|/* 1.2 sec. */
id|add_timer
c_func
(paren
op_amp
id|hp-&gt;happy_timer
)paren
suffix:semicolon
)brace
)brace
DECL|macro|TX_RESET_TRIES
mdefine_line|#define TX_RESET_TRIES     32
DECL|macro|RX_RESET_TRIES
mdefine_line|#define RX_RESET_TRIES     32
DECL|function|happy_meal_tx_reset
r_static
r_inline
r_void
id|happy_meal_tx_reset
c_func
(paren
r_struct
id|hmeal_bigmacregs
op_star
id|bregs
)paren
(brace
r_int
id|tries
op_assign
id|TX_RESET_TRIES
suffix:semicolon
id|HMD
c_func
(paren
(paren
l_string|&quot;happy_meal_tx_reset: reset, &quot;
)paren
)paren
suffix:semicolon
multiline_comment|/* Would you like to try our SMCC Delux? */
id|bregs-&gt;tx_swreset
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
(paren
id|bregs-&gt;tx_swreset
op_amp
l_int|1
)paren
op_logical_and
op_decrement
id|tries
)paren
(brace
id|udelay
c_func
(paren
l_int|20
)paren
suffix:semicolon
)brace
multiline_comment|/* Lettuce, tomato, buggy hardware (no extra charge)? */
r_if
c_cond
(paren
op_logical_neg
id|tries
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;happy meal: Transceiver BigMac ATTACK!&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/* Take care. */
id|HMD
c_func
(paren
(paren
l_string|&quot;done&bslash;n&quot;
)paren
)paren
suffix:semicolon
)brace
DECL|function|happy_meal_rx_reset
r_static
r_inline
r_void
id|happy_meal_rx_reset
c_func
(paren
r_struct
id|hmeal_bigmacregs
op_star
id|bregs
)paren
(brace
r_int
id|tries
op_assign
id|RX_RESET_TRIES
suffix:semicolon
id|HMD
c_func
(paren
(paren
l_string|&quot;happy_meal_rx_reset: reset, &quot;
)paren
)paren
suffix:semicolon
multiline_comment|/* We have a special on GNU/Viking hardware bugs today. */
id|bregs-&gt;rx_swreset
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
(paren
id|bregs-&gt;rx_swreset
op_amp
l_int|1
)paren
op_logical_and
op_decrement
id|tries
)paren
(brace
id|udelay
c_func
(paren
l_int|20
)paren
suffix:semicolon
)brace
multiline_comment|/* Will that be all? */
r_if
c_cond
(paren
op_logical_neg
id|tries
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;happy meal: Receiver BigMac ATTACK!&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/* Don&squot;t forget your vik_1137125_wa.  Have a nice day. */
id|HMD
c_func
(paren
(paren
l_string|&quot;done&bslash;n&quot;
)paren
)paren
suffix:semicolon
)brace
DECL|macro|STOP_TRIES
mdefine_line|#define STOP_TRIES         16
DECL|function|happy_meal_stop
r_static
r_inline
r_void
id|happy_meal_stop
c_func
(paren
r_struct
id|hmeal_gregs
op_star
id|gregs
)paren
(brace
r_int
id|tries
op_assign
id|STOP_TRIES
suffix:semicolon
id|HMD
c_func
(paren
(paren
l_string|&quot;happy_meal_stop: reset, &quot;
)paren
)paren
suffix:semicolon
multiline_comment|/* We&squot;re consolidating our STB products, it&squot;s your lucky day. */
id|gregs-&gt;sw_reset
op_assign
id|GREG_RESET_ALL
suffix:semicolon
r_while
c_loop
(paren
id|gregs-&gt;sw_reset
op_logical_and
op_decrement
id|tries
)paren
(brace
id|udelay
c_func
(paren
l_int|20
)paren
suffix:semicolon
)brace
multiline_comment|/* Come back next week when we are &quot;Sun Microelectronics&quot;. */
r_if
c_cond
(paren
op_logical_neg
id|tries
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;happy meal: Fry guys.&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/* Remember: &quot;Different name, same old buggy as shit hardware.&quot; */
id|HMD
c_func
(paren
(paren
l_string|&quot;done&bslash;n&quot;
)paren
)paren
suffix:semicolon
)brace
DECL|function|happy_meal_get_counters
r_static
r_void
id|happy_meal_get_counters
c_func
(paren
r_struct
id|happy_meal
op_star
id|hp
comma
r_struct
id|hmeal_bigmacregs
op_star
id|bregs
)paren
(brace
r_struct
id|net_device_stats
op_star
id|stats
op_assign
op_amp
id|hp-&gt;net_stats
suffix:semicolon
id|stats-&gt;rx_crc_errors
op_add_assign
id|bregs-&gt;rcrce_ctr
suffix:semicolon
id|bregs-&gt;rcrce_ctr
op_assign
l_int|0
suffix:semicolon
id|stats-&gt;rx_frame_errors
op_add_assign
id|bregs-&gt;unale_ctr
suffix:semicolon
id|bregs-&gt;unale_ctr
op_assign
l_int|0
suffix:semicolon
id|stats-&gt;rx_length_errors
op_add_assign
id|bregs-&gt;gle_ctr
suffix:semicolon
id|bregs-&gt;gle_ctr
op_assign
l_int|0
suffix:semicolon
id|stats-&gt;tx_aborted_errors
op_add_assign
id|bregs-&gt;ex_ctr
suffix:semicolon
id|stats-&gt;collisions
op_add_assign
(paren
id|bregs-&gt;ex_ctr
op_plus
id|bregs-&gt;lt_ctr
)paren
suffix:semicolon
id|bregs-&gt;ex_ctr
op_assign
id|bregs-&gt;lt_ctr
op_assign
l_int|0
suffix:semicolon
)brace
DECL|function|happy_meal_poll_start
r_static
r_inline
r_void
id|happy_meal_poll_start
c_func
(paren
r_struct
id|happy_meal
op_star
id|hp
comma
r_struct
id|hmeal_tcvregs
op_star
id|tregs
)paren
(brace
r_int
r_int
id|tmp
suffix:semicolon
r_int
id|speed
suffix:semicolon
id|ASD
c_func
(paren
(paren
l_string|&quot;happy_meal_poll_start: &quot;
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|hp-&gt;happy_flags
op_amp
id|HFLAG_POLLENABLE
)paren
)paren
(brace
id|HMD
c_func
(paren
(paren
l_string|&quot;polling disabled, return&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/* Start the MIF polling on the external transceiver. */
id|ASD
c_func
(paren
(paren
l_string|&quot;polling on, &quot;
)paren
)paren
suffix:semicolon
id|tmp
op_assign
id|tregs-&gt;cfg
suffix:semicolon
id|tmp
op_and_assign
op_complement
(paren
id|TCV_CFG_PDADDR
op_or
id|TCV_CFG_PREGADDR
)paren
suffix:semicolon
id|tmp
op_or_assign
(paren
(paren
id|hp-&gt;paddr
op_amp
l_int|0x1f
)paren
op_lshift
l_int|10
)paren
suffix:semicolon
id|tmp
op_or_assign
(paren
id|TCV_PADDR_ETX
op_lshift
l_int|3
)paren
suffix:semicolon
id|tmp
op_or_assign
id|TCV_CFG_PENABLE
suffix:semicolon
id|tregs-&gt;cfg
op_assign
id|tmp
suffix:semicolon
multiline_comment|/* Let the bits set. */
id|udelay
c_func
(paren
l_int|200
)paren
suffix:semicolon
multiline_comment|/* We are polling now. */
id|ASD
c_func
(paren
(paren
l_string|&quot;now polling, &quot;
)paren
)paren
suffix:semicolon
id|hp-&gt;happy_flags
op_or_assign
id|HFLAG_POLL
suffix:semicolon
multiline_comment|/* Clear the poll flags, get the basic status as of now. */
id|hp-&gt;poll_flag
op_assign
l_int|0
suffix:semicolon
id|hp-&gt;poll_data
op_assign
id|tregs-&gt;status
op_rshift
l_int|16
suffix:semicolon
r_if
c_cond
(paren
id|hp-&gt;happy_flags
op_amp
id|HFLAG_AUTO
)paren
(brace
id|speed
op_assign
id|hp-&gt;auto_speed
suffix:semicolon
)brace
r_else
id|speed
op_assign
id|hp-&gt;forced_speed
suffix:semicolon
multiline_comment|/* Listen only for the MIF interrupts we want to hear. */
id|ASD
c_func
(paren
(paren
l_string|&quot;mif ints on, &quot;
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|speed
op_eq
l_int|100
)paren
(brace
id|tregs-&gt;int_mask
op_assign
l_int|0xfffb
suffix:semicolon
)brace
r_else
id|tregs-&gt;int_mask
op_assign
l_int|0xfff9
suffix:semicolon
id|ASD
c_func
(paren
(paren
l_string|&quot;done&bslash;n&quot;
)paren
)paren
suffix:semicolon
)brace
DECL|function|happy_meal_poll_stop
r_static
r_inline
r_void
id|happy_meal_poll_stop
c_func
(paren
r_struct
id|happy_meal
op_star
id|hp
comma
r_struct
id|hmeal_tcvregs
op_star
id|tregs
)paren
(brace
id|ASD
c_func
(paren
(paren
l_string|&quot;happy_meal_poll_stop: &quot;
)paren
)paren
suffix:semicolon
multiline_comment|/* If polling disabled or not polling already, nothing to do. */
r_if
c_cond
(paren
(paren
id|hp-&gt;happy_flags
op_amp
(paren
id|HFLAG_POLLENABLE
op_or
id|HFLAG_POLL
)paren
)paren
op_ne
(paren
id|HFLAG_POLLENABLE
op_or
id|HFLAG_POLL
)paren
)paren
(brace
id|HMD
c_func
(paren
(paren
l_string|&quot;not polling, return&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/* Shut up the MIF. */
id|ASD
c_func
(paren
(paren
l_string|&quot;were polling, mif ints off, &quot;
)paren
)paren
suffix:semicolon
id|tregs-&gt;int_mask
op_assign
l_int|0xffff
suffix:semicolon
multiline_comment|/* Turn off polling. */
id|ASD
c_func
(paren
(paren
l_string|&quot;polling off, &quot;
)paren
)paren
suffix:semicolon
id|tregs-&gt;cfg
op_and_assign
op_complement
(paren
id|TCV_CFG_PENABLE
)paren
suffix:semicolon
multiline_comment|/* We are no longer polling. */
id|hp-&gt;happy_flags
op_and_assign
op_complement
(paren
id|HFLAG_POLL
)paren
suffix:semicolon
multiline_comment|/* Let the bits set. */
id|udelay
c_func
(paren
l_int|200
)paren
suffix:semicolon
id|ASD
c_func
(paren
(paren
l_string|&quot;done&bslash;n&quot;
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/* Only Sun can take such nice parts and fuck up the programming interface&n; * like this.  Good job guys...&n; */
DECL|macro|TCVR_RESET_TRIES
mdefine_line|#define TCVR_RESET_TRIES       16 /* It should reset quickly        */
DECL|macro|TCVR_UNISOLATE_TRIES
mdefine_line|#define TCVR_UNISOLATE_TRIES   32 /* Dis-isolation can take longer. */
DECL|function|happy_meal_tcvr_reset
r_static
r_int
id|happy_meal_tcvr_reset
c_func
(paren
r_struct
id|happy_meal
op_star
id|hp
comma
r_struct
id|hmeal_tcvregs
op_star
id|tregs
)paren
(brace
r_int
r_int
id|tconfig
suffix:semicolon
r_int
id|result
comma
id|tries
op_assign
id|TCVR_RESET_TRIES
suffix:semicolon
id|tconfig
op_assign
id|tregs-&gt;cfg
suffix:semicolon
id|ASD
c_func
(paren
(paren
l_string|&quot;happy_meal_tcvr_reset: tcfg&lt;%08lx&gt; &quot;
comma
id|tconfig
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|hp-&gt;tcvr_type
op_eq
id|external
)paren
(brace
id|ASD
c_func
(paren
(paren
l_string|&quot;external&lt;&quot;
)paren
)paren
suffix:semicolon
id|tregs-&gt;cfg
op_assign
id|tconfig
op_amp
op_complement
(paren
id|TCV_CFG_PSELECT
)paren
suffix:semicolon
id|hp-&gt;tcvr_type
op_assign
id|internal
suffix:semicolon
id|hp-&gt;paddr
op_assign
id|TCV_PADDR_ITX
suffix:semicolon
id|ASD
c_func
(paren
(paren
l_string|&quot;ISOLATE,&quot;
)paren
)paren
suffix:semicolon
id|happy_meal_tcvr_write
c_func
(paren
id|hp
comma
id|tregs
comma
id|DP83840_BMCR
comma
(paren
id|BMCR_LOOPBACK
op_or
id|BMCR_PDOWN
op_or
id|BMCR_ISOLATE
)paren
)paren
suffix:semicolon
id|result
op_assign
id|happy_meal_tcvr_read
c_func
(paren
id|hp
comma
id|tregs
comma
id|DP83840_BMCR
)paren
suffix:semicolon
r_if
c_cond
(paren
id|result
op_eq
id|TCVR_FAILURE
)paren
(brace
id|ASD
c_func
(paren
(paren
l_string|&quot;phyread_fail&gt;&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|ASD
c_func
(paren
(paren
l_string|&quot;phyread_ok,PSELECT&gt;&quot;
)paren
)paren
suffix:semicolon
id|tregs-&gt;cfg
op_assign
id|tconfig
op_or
id|TCV_CFG_PSELECT
suffix:semicolon
id|hp-&gt;tcvr_type
op_assign
id|external
suffix:semicolon
id|hp-&gt;paddr
op_assign
id|TCV_PADDR_ETX
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|tconfig
op_amp
id|TCV_CFG_MDIO1
)paren
(brace
id|ASD
c_func
(paren
(paren
l_string|&quot;internal&lt;PSELECT,&quot;
)paren
)paren
suffix:semicolon
id|tregs-&gt;cfg
op_assign
(paren
id|tconfig
op_or
id|TCV_CFG_PSELECT
)paren
suffix:semicolon
id|ASD
c_func
(paren
(paren
l_string|&quot;ISOLATE,&quot;
)paren
)paren
suffix:semicolon
id|happy_meal_tcvr_write
c_func
(paren
id|hp
comma
id|tregs
comma
id|DP83840_BMCR
comma
(paren
id|BMCR_LOOPBACK
op_or
id|BMCR_PDOWN
op_or
id|BMCR_ISOLATE
)paren
)paren
suffix:semicolon
id|result
op_assign
id|happy_meal_tcvr_read
c_func
(paren
id|hp
comma
id|tregs
comma
id|DP83840_BMCR
)paren
suffix:semicolon
r_if
c_cond
(paren
id|result
op_eq
id|TCVR_FAILURE
)paren
(brace
id|ASD
c_func
(paren
(paren
l_string|&quot;phyread_fail&gt;&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|ASD
c_func
(paren
(paren
l_string|&quot;phyread_ok,~PSELECT&gt;&quot;
)paren
)paren
suffix:semicolon
id|tregs-&gt;cfg
op_assign
(paren
id|tconfig
op_amp
op_complement
(paren
id|TCV_CFG_PSELECT
)paren
)paren
suffix:semicolon
id|hp-&gt;tcvr_type
op_assign
id|internal
suffix:semicolon
id|hp-&gt;paddr
op_assign
id|TCV_PADDR_ITX
suffix:semicolon
)brace
)brace
id|ASD
c_func
(paren
(paren
l_string|&quot;BMCR_RESET &quot;
)paren
)paren
suffix:semicolon
id|happy_meal_tcvr_write
c_func
(paren
id|hp
comma
id|tregs
comma
id|DP83840_BMCR
comma
id|BMCR_RESET
)paren
suffix:semicolon
r_while
c_loop
(paren
op_decrement
id|tries
)paren
(brace
id|result
op_assign
id|happy_meal_tcvr_read
c_func
(paren
id|hp
comma
id|tregs
comma
id|DP83840_BMCR
)paren
suffix:semicolon
r_if
c_cond
(paren
id|result
op_eq
id|TCVR_FAILURE
)paren
(brace
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|hp-&gt;sw_bmcr
op_assign
id|result
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|result
op_amp
id|BMCR_RESET
)paren
)paren
(brace
r_break
suffix:semicolon
)brace
id|udelay
c_func
(paren
l_int|20
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|tries
)paren
(brace
id|ASD
c_func
(paren
(paren
l_string|&quot;BMCR RESET FAILED!&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|ASD
c_func
(paren
(paren
l_string|&quot;RESET_OK&bslash;n&quot;
)paren
)paren
suffix:semicolon
multiline_comment|/* Get fresh copies of the PHY registers. */
id|hp-&gt;sw_bmsr
op_assign
id|happy_meal_tcvr_read
c_func
(paren
id|hp
comma
id|tregs
comma
id|DP83840_BMSR
)paren
suffix:semicolon
id|hp-&gt;sw_physid1
op_assign
id|happy_meal_tcvr_read
c_func
(paren
id|hp
comma
id|tregs
comma
id|DP83840_PHYSID1
)paren
suffix:semicolon
id|hp-&gt;sw_physid2
op_assign
id|happy_meal_tcvr_read
c_func
(paren
id|hp
comma
id|tregs
comma
id|DP83840_PHYSID2
)paren
suffix:semicolon
id|hp-&gt;sw_advertise
op_assign
id|happy_meal_tcvr_read
c_func
(paren
id|hp
comma
id|tregs
comma
id|DP83840_ADVERTISE
)paren
suffix:semicolon
id|ASD
c_func
(paren
(paren
l_string|&quot;UNISOLATE&quot;
)paren
)paren
suffix:semicolon
id|hp-&gt;sw_bmcr
op_and_assign
op_complement
(paren
id|BMCR_ISOLATE
)paren
suffix:semicolon
id|happy_meal_tcvr_write
c_func
(paren
id|hp
comma
id|tregs
comma
id|DP83840_BMCR
comma
id|hp-&gt;sw_bmcr
)paren
suffix:semicolon
id|tries
op_assign
id|TCVR_UNISOLATE_TRIES
suffix:semicolon
r_while
c_loop
(paren
op_decrement
id|tries
)paren
(brace
id|result
op_assign
id|happy_meal_tcvr_read
c_func
(paren
id|hp
comma
id|tregs
comma
id|DP83840_BMCR
)paren
suffix:semicolon
r_if
c_cond
(paren
id|result
op_eq
id|TCVR_FAILURE
)paren
(brace
r_return
op_minus
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|result
op_amp
id|BMCR_ISOLATE
)paren
)paren
(brace
r_break
suffix:semicolon
)brace
id|udelay
c_func
(paren
l_int|20
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|tries
)paren
(brace
id|ASD
c_func
(paren
(paren
l_string|&quot; FAILED!&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|ASD
c_func
(paren
(paren
l_string|&quot; SUCCESS and CSCONFIG_DFBYPASS&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|result
op_assign
id|happy_meal_tcvr_read
c_func
(paren
id|hp
comma
id|tregs
comma
id|DP83840_CSCONFIG
)paren
suffix:semicolon
id|happy_meal_tcvr_write
c_func
(paren
id|hp
comma
id|tregs
comma
id|DP83840_CSCONFIG
comma
(paren
id|result
op_or
id|CSCONFIG_DFBYPASS
)paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Figure out whether we have an internal or external transceiver. */
DECL|function|happy_meal_transceiver_check
r_static
r_void
id|happy_meal_transceiver_check
c_func
(paren
r_struct
id|happy_meal
op_star
id|hp
comma
r_struct
id|hmeal_tcvregs
op_star
id|tregs
)paren
(brace
r_int
r_int
id|tconfig
op_assign
id|tregs-&gt;cfg
suffix:semicolon
id|ASD
c_func
(paren
(paren
l_string|&quot;happy_meal_transceiver_check: tcfg=%08lx &quot;
comma
id|tconfig
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|hp-&gt;happy_flags
op_amp
id|HFLAG_POLL
)paren
(brace
multiline_comment|/* If we are polling, we must stop to get the transceiver type. */
id|ASD
c_func
(paren
(paren
l_string|&quot;&lt;polling&gt; &quot;
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|hp-&gt;tcvr_type
op_eq
id|internal
)paren
(brace
r_if
c_cond
(paren
id|tconfig
op_amp
id|TCV_CFG_MDIO1
)paren
(brace
id|ASD
c_func
(paren
(paren
l_string|&quot;&lt;internal&gt; &lt;poll stop&gt; &quot;
)paren
)paren
suffix:semicolon
id|happy_meal_poll_stop
c_func
(paren
id|hp
comma
id|tregs
)paren
suffix:semicolon
id|hp-&gt;paddr
op_assign
id|TCV_PADDR_ETX
suffix:semicolon
id|hp-&gt;tcvr_type
op_assign
id|external
suffix:semicolon
id|ASD
c_func
(paren
(paren
l_string|&quot;&lt;external&gt;&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|tconfig
op_and_assign
op_complement
(paren
id|TCV_CFG_PENABLE
)paren
suffix:semicolon
id|tconfig
op_or_assign
id|TCV_CFG_PSELECT
suffix:semicolon
id|tregs-&gt;cfg
op_assign
id|tconfig
suffix:semicolon
)brace
)brace
r_else
(brace
r_if
c_cond
(paren
id|hp-&gt;tcvr_type
op_eq
id|external
)paren
(brace
id|ASD
c_func
(paren
(paren
l_string|&quot;&lt;external&gt; &quot;
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|tregs-&gt;status
op_rshift
l_int|16
)paren
)paren
(brace
id|ASD
c_func
(paren
(paren
l_string|&quot;&lt;poll stop&gt; &quot;
)paren
)paren
suffix:semicolon
id|happy_meal_poll_stop
c_func
(paren
id|hp
comma
id|tregs
)paren
suffix:semicolon
id|hp-&gt;paddr
op_assign
id|TCV_PADDR_ITX
suffix:semicolon
id|hp-&gt;tcvr_type
op_assign
id|internal
suffix:semicolon
id|ASD
c_func
(paren
(paren
l_string|&quot;&lt;internal&gt;&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|tregs-&gt;cfg
op_and_assign
op_complement
(paren
id|TCV_CFG_PSELECT
)paren
suffix:semicolon
)brace
id|ASD
c_func
(paren
(paren
l_string|&quot;&bslash;n&quot;
)paren
)paren
suffix:semicolon
)brace
r_else
(brace
id|ASD
c_func
(paren
(paren
l_string|&quot;&lt;none&gt;&bslash;n&quot;
)paren
)paren
suffix:semicolon
)brace
)brace
)brace
r_else
(brace
r_int
r_int
id|reread
op_assign
id|tregs-&gt;cfg
suffix:semicolon
multiline_comment|/* Else we can just work off of the MDIO bits. */
id|ASD
c_func
(paren
(paren
l_string|&quot;&lt;not polling&gt; &quot;
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|reread
op_amp
id|TCV_CFG_MDIO1
)paren
(brace
id|tregs-&gt;cfg
op_assign
id|tconfig
op_or
id|TCV_CFG_PSELECT
suffix:semicolon
id|hp-&gt;paddr
op_assign
id|TCV_PADDR_ETX
suffix:semicolon
id|hp-&gt;tcvr_type
op_assign
id|external
suffix:semicolon
id|ASD
c_func
(paren
(paren
l_string|&quot;&lt;external&gt;&bslash;n&quot;
)paren
)paren
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|reread
op_amp
id|TCV_CFG_MDIO0
)paren
(brace
id|tregs-&gt;cfg
op_assign
id|tconfig
op_amp
op_complement
(paren
id|TCV_CFG_PSELECT
)paren
suffix:semicolon
id|hp-&gt;paddr
op_assign
id|TCV_PADDR_ITX
suffix:semicolon
id|hp-&gt;tcvr_type
op_assign
id|internal
suffix:semicolon
id|ASD
c_func
(paren
(paren
l_string|&quot;&lt;internal&gt;&bslash;n&quot;
)paren
)paren
suffix:semicolon
)brace
r_else
(brace
id|printk
c_func
(paren
l_string|&quot;happy meal: Transceiver and a coke please.&quot;
)paren
suffix:semicolon
id|hp-&gt;tcvr_type
op_assign
id|none
suffix:semicolon
multiline_comment|/* Grrr... */
id|ASD
c_func
(paren
(paren
l_string|&quot;&lt;none&gt;&bslash;n&quot;
)paren
)paren
suffix:semicolon
)brace
)brace
)brace
)brace
multiline_comment|/* The receive ring buffers are a bit tricky to get right.  Here goes...&n; *&n; * The buffers we dma into must be 64 byte aligned.  So we use a special&n; * alloc_skb() routine for the happy meal to allocate 64 bytes more than&n; * we really need.&n; *&n; * We use skb_reserve() to align the data block we get in the skb.  We&n; * also program the etxregs-&gt;cfg register to use an offset of 2.  This&n; * imperical constant plus the ethernet header size will always leave&n; * us with a nicely aligned ip header once we pass things up to the&n; * protocol layers.&n; *&n; * The numbers work out to:&n; *&n; *         Max ethernet frame size         1518&n; *         Ethernet header size              14&n; *         Happy Meal base offset             2&n; *&n; * Say a skb data area is at 0xf001b010, and its size alloced is&n; * (ETH_FRAME_LEN + 64 + 2) = (1514 + 64 + 2) = 1580 bytes.&n; *&n; * First our alloc_skb() routine aligns the data base to a 64 byte&n; * boundry.  We now have 0xf001b040 as our skb data address.  We&n; * plug this into the receive descriptor address.&n; *&n; * Next, we skb_reserve() 2 bytes to account for the Happy Meal offset.&n; * So now the data we will end up looking at starts at 0xf001b042.  When&n; * the packet arrives, we will check out the size received and subtract&n; * this from the skb-&gt;length.  Then we just pass the packet up to the&n; * protocols as is, and allocate a new skb to replace this slot we have&n; * just received from.&n; *&n; * The ethernet layer will strip the ether header from the front of the&n; * skb we just sent to it, this leaves us with the ip header sitting&n; * nicely aligned at 0xf001b050.  Also, for tcp and udp packets the&n; * Happy Meal has even checksummed the tcp/udp data for us.  The 16&n; * bit checksum is obtained from the low bits of the receive descriptor&n; * flags, thus:&n; *&n; * &t;skb-&gt;csum = rxd-&gt;rx_flags &amp; 0xffff;&n; * &t;skb-&gt;ip_summed = CHECKSUM_HW;&n; *&n; * before sending off the skb to the protocols, and we are good as gold.&n; */
DECL|function|happy_meal_clean_rings
r_static
r_inline
r_void
id|happy_meal_clean_rings
c_func
(paren
r_struct
id|happy_meal
op_star
id|hp
)paren
(brace
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|RX_RING_SIZE
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|hp-&gt;rx_skbs
(braket
id|i
)braket
op_ne
l_int|NULL
)paren
(brace
id|dev_kfree_skb
c_func
(paren
id|hp-&gt;rx_skbs
(braket
id|i
)braket
comma
id|FREE_READ
)paren
suffix:semicolon
id|hp-&gt;rx_skbs
(braket
id|i
)braket
op_assign
l_int|NULL
suffix:semicolon
)brace
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|TX_RING_SIZE
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|hp-&gt;tx_skbs
(braket
id|i
)braket
op_ne
l_int|NULL
)paren
(brace
id|dev_kfree_skb
c_func
(paren
id|hp-&gt;tx_skbs
(braket
id|i
)braket
comma
id|FREE_WRITE
)paren
suffix:semicolon
id|hp-&gt;tx_skbs
(braket
id|i
)braket
op_assign
l_int|NULL
suffix:semicolon
)brace
)brace
)brace
DECL|function|happy_meal_init_rings
r_static
r_void
id|happy_meal_init_rings
c_func
(paren
r_struct
id|happy_meal
op_star
id|hp
comma
r_int
id|from_irq
)paren
(brace
r_struct
id|hmeal_init_block
op_star
id|hb
op_assign
id|hp-&gt;happy_block
suffix:semicolon
r_struct
id|device
op_star
id|dev
op_assign
id|hp-&gt;dev
suffix:semicolon
r_int
id|i
comma
id|gfp_flags
op_assign
id|GFP_KERNEL
suffix:semicolon
r_if
c_cond
(paren
id|from_irq
op_logical_or
id|in_interrupt
c_func
(paren
)paren
)paren
(brace
id|gfp_flags
op_assign
id|GFP_ATOMIC
suffix:semicolon
)brace
id|HMD
c_func
(paren
(paren
l_string|&quot;happy_meal_init_rings: counters to zero, &quot;
)paren
)paren
suffix:semicolon
id|hp-&gt;rx_new
op_assign
id|hp-&gt;rx_old
op_assign
id|hp-&gt;tx_new
op_assign
id|hp-&gt;tx_old
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Free any skippy bufs left around in the rings. */
id|HMD
c_func
(paren
(paren
l_string|&quot;clean, &quot;
)paren
)paren
suffix:semicolon
id|happy_meal_clean_rings
c_func
(paren
id|hp
)paren
suffix:semicolon
multiline_comment|/* Now get new skippy bufs for the receive ring. */
id|HMD
c_func
(paren
(paren
l_string|&quot;init rxring, &quot;
)paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|RX_RING_SIZE
suffix:semicolon
id|i
op_increment
)paren
(brace
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
id|skb
op_assign
id|happy_meal_alloc_skb
c_func
(paren
id|RX_BUF_ALLOC_SIZE
comma
id|gfp_flags
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|skb
)paren
(brace
r_continue
suffix:semicolon
)brace
id|hp-&gt;rx_skbs
(braket
id|i
)braket
op_assign
id|skb
suffix:semicolon
id|skb-&gt;dev
op_assign
id|dev
suffix:semicolon
multiline_comment|/* Because we reserve afterwards. */
id|skb_put
c_func
(paren
id|skb
comma
(paren
id|ETH_FRAME_LEN
op_plus
id|RX_OFFSET
)paren
)paren
suffix:semicolon
id|hb-&gt;happy_meal_rxd
(braket
id|i
)braket
dot
id|rx_addr
op_assign
(paren
r_int
r_int
)paren
id|skb-&gt;data
suffix:semicolon
id|skb_reserve
c_func
(paren
id|skb
comma
id|RX_OFFSET
)paren
suffix:semicolon
id|hb-&gt;happy_meal_rxd
(braket
id|i
)braket
dot
id|rx_flags
op_assign
(paren
id|RXFLAG_OWN
op_or
(paren
(paren
id|RX_BUF_ALLOC_SIZE
op_minus
id|RX_OFFSET
)paren
op_lshift
l_int|16
)paren
)paren
suffix:semicolon
)brace
id|HMD
c_func
(paren
(paren
l_string|&quot;init txring, &quot;
)paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|TX_RING_SIZE
suffix:semicolon
id|i
op_increment
)paren
(brace
id|hb-&gt;happy_meal_txd
(braket
id|i
)braket
dot
id|tx_flags
op_assign
l_int|0
suffix:semicolon
)brace
id|HMD
c_func
(paren
(paren
l_string|&quot;done&bslash;n&quot;
)paren
)paren
suffix:semicolon
)brace
DECL|function|sun4c_happy_meal_init_rings
r_static
r_void
id|sun4c_happy_meal_init_rings
c_func
(paren
r_struct
id|happy_meal
op_star
id|hp
)paren
(brace
r_struct
id|hmeal_init_block
op_star
id|hb
op_assign
id|hp-&gt;happy_block
suffix:semicolon
id|__u32
id|hbufs
op_assign
id|hp-&gt;s4c_buf_dvma
suffix:semicolon
r_int
id|i
suffix:semicolon
id|HMD
c_func
(paren
(paren
l_string|&quot;happy_meal_init_rings: counters to zero, &quot;
)paren
)paren
suffix:semicolon
id|hp-&gt;rx_new
op_assign
id|hp-&gt;rx_old
op_assign
id|hp-&gt;tx_new
op_assign
id|hp-&gt;tx_old
op_assign
l_int|0
suffix:semicolon
id|HMD
c_func
(paren
(paren
l_string|&quot;init rxring, &quot;
)paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|RX_RING_SIZE
suffix:semicolon
id|i
op_increment
)paren
(brace
id|hb-&gt;happy_meal_rxd
(braket
id|i
)braket
dot
id|rx_addr
op_assign
id|hbufs
op_plus
id|hbuf_offset
c_func
(paren
id|rx_buf
comma
id|i
)paren
suffix:semicolon
id|hb-&gt;happy_meal_rxd
(braket
id|i
)braket
dot
id|rx_flags
op_assign
(paren
id|RXFLAG_OWN
op_or
(paren
(paren
id|SUN4C_RX_BUFF_SIZE
op_minus
id|RX_OFFSET
)paren
op_lshift
l_int|16
)paren
)paren
suffix:semicolon
)brace
id|HMD
c_func
(paren
(paren
l_string|&quot;init txring, &quot;
)paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|TX_RING_SIZE
suffix:semicolon
id|i
op_increment
)paren
(brace
id|hb-&gt;happy_meal_txd
(braket
id|i
)braket
dot
id|tx_flags
op_assign
l_int|0
suffix:semicolon
)brace
id|HMD
c_func
(paren
(paren
l_string|&quot;done&bslash;n&quot;
)paren
)paren
suffix:semicolon
)brace
DECL|function|happy_meal_begin_auto_negotiation
r_static
r_void
id|happy_meal_begin_auto_negotiation
c_func
(paren
r_struct
id|happy_meal
op_star
id|hp
comma
r_struct
id|hmeal_tcvregs
op_star
id|tregs
)paren
(brace
r_int
id|timeout
suffix:semicolon
multiline_comment|/* Read all of the registers we are interested in now. */
id|hp-&gt;sw_bmsr
op_assign
id|happy_meal_tcvr_read
c_func
(paren
id|hp
comma
id|tregs
comma
id|DP83840_BMSR
)paren
suffix:semicolon
id|hp-&gt;sw_bmcr
op_assign
id|happy_meal_tcvr_read
c_func
(paren
id|hp
comma
id|tregs
comma
id|DP83840_BMCR
)paren
suffix:semicolon
id|hp-&gt;sw_physid1
op_assign
id|happy_meal_tcvr_read
c_func
(paren
id|hp
comma
id|tregs
comma
id|DP83840_PHYSID1
)paren
suffix:semicolon
id|hp-&gt;sw_physid2
op_assign
id|happy_meal_tcvr_read
c_func
(paren
id|hp
comma
id|tregs
comma
id|DP83840_PHYSID2
)paren
suffix:semicolon
id|hp-&gt;sw_advertise
op_assign
id|happy_meal_tcvr_read
c_func
(paren
id|hp
comma
id|tregs
comma
id|DP83840_ADVERTISE
)paren
suffix:semicolon
multiline_comment|/* XXX Check BMSR_ANEGCAPABLE, should not be necessary though. */
multiline_comment|/* Advertise everything we can support. */
r_if
c_cond
(paren
id|hp-&gt;sw_bmsr
op_amp
id|BMSR_10HALF
)paren
(brace
id|hp-&gt;sw_advertise
op_or_assign
(paren
id|ADVERTISE_10HALF
)paren
suffix:semicolon
)brace
r_else
id|hp-&gt;sw_advertise
op_and_assign
op_complement
(paren
id|ADVERTISE_10HALF
)paren
suffix:semicolon
r_if
c_cond
(paren
id|hp-&gt;sw_bmsr
op_amp
id|BMSR_10FULL
)paren
(brace
id|hp-&gt;sw_advertise
op_or_assign
(paren
id|ADVERTISE_10FULL
)paren
suffix:semicolon
)brace
r_else
id|hp-&gt;sw_advertise
op_and_assign
op_complement
(paren
id|ADVERTISE_10FULL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|hp-&gt;sw_bmsr
op_amp
id|BMSR_100HALF
)paren
(brace
id|hp-&gt;sw_advertise
op_or_assign
(paren
id|ADVERTISE_100HALF
)paren
suffix:semicolon
)brace
r_else
id|hp-&gt;sw_advertise
op_and_assign
op_complement
(paren
id|ADVERTISE_100HALF
)paren
suffix:semicolon
r_if
c_cond
(paren
id|hp-&gt;sw_bmsr
op_amp
id|BMSR_100FULL
)paren
(brace
id|hp-&gt;sw_advertise
op_or_assign
(paren
id|ADVERTISE_100FULL
)paren
suffix:semicolon
)brace
r_else
id|hp-&gt;sw_advertise
op_and_assign
op_complement
(paren
id|ADVERTISE_100FULL
)paren
suffix:semicolon
multiline_comment|/* XXX Currently no Happy Meal cards I know off support 100BaseT4,&n;&t; * XXX and this is because the DP83840 does not support it, changes&n;&t; * XXX would need to be made to the tx/rx logic in the driver as well&n;&t; * XXX so I completely skip checking for it in the BMSR for now.&n;&t; */
macro_line|#ifdef AUTO_SWITCH_DEBUG
id|ASD
c_func
(paren
(paren
l_string|&quot;%s: Advertising [ &quot;
comma
id|hp-&gt;dev-&gt;name
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|hp-&gt;sw_advertise
op_amp
id|ADVERTISE_10HALF
)paren
(brace
id|ASD
c_func
(paren
(paren
l_string|&quot;10H &quot;
)paren
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|hp-&gt;sw_advertise
op_amp
id|ADVERTISE_10FULL
)paren
(brace
id|ASD
c_func
(paren
(paren
l_string|&quot;10F &quot;
)paren
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|hp-&gt;sw_advertise
op_amp
id|ADVERTISE_100HALF
)paren
(brace
id|ASD
c_func
(paren
(paren
l_string|&quot;100H &quot;
)paren
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|hp-&gt;sw_advertise
op_amp
id|ADVERTISE_100FULL
)paren
(brace
id|ASD
c_func
(paren
(paren
l_string|&quot;100F &quot;
)paren
)paren
suffix:semicolon
)brace
macro_line|#endif
id|happy_meal_tcvr_write
c_func
(paren
id|hp
comma
id|tregs
comma
id|DP83840_ADVERTISE
comma
id|hp-&gt;sw_advertise
)paren
suffix:semicolon
multiline_comment|/* Enable Auto-Negotiation, this is usually on already... */
id|hp-&gt;sw_bmcr
op_or_assign
id|BMCR_ANENABLE
suffix:semicolon
id|happy_meal_tcvr_write
c_func
(paren
id|hp
comma
id|tregs
comma
id|DP83840_BMCR
comma
id|hp-&gt;sw_bmcr
)paren
suffix:semicolon
multiline_comment|/* Restart it to make sure it is going. */
id|hp-&gt;sw_bmcr
op_or_assign
id|BMCR_ANRESTART
suffix:semicolon
id|happy_meal_tcvr_write
c_func
(paren
id|hp
comma
id|tregs
comma
id|DP83840_BMCR
comma
id|hp-&gt;sw_bmcr
)paren
suffix:semicolon
multiline_comment|/* BMCR_ANRESTART self clears when the process has begun. */
id|timeout
op_assign
l_int|64
suffix:semicolon
multiline_comment|/* More than enough. */
r_while
c_loop
(paren
op_decrement
id|timeout
)paren
(brace
id|hp-&gt;sw_bmcr
op_assign
id|happy_meal_tcvr_read
c_func
(paren
id|hp
comma
id|tregs
comma
id|DP83840_BMCR
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|hp-&gt;sw_bmcr
op_amp
id|BMCR_ANRESTART
)paren
)paren
(brace
r_break
suffix:semicolon
)brace
multiline_comment|/* got it. */
id|udelay
c_func
(paren
l_int|10
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|timeout
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%s: Happy Meal would not start auto negotiation BMCR=0x%04x&bslash;n&quot;
comma
id|hp-&gt;dev-&gt;name
comma
id|hp-&gt;sw_bmcr
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;%s: Performing force link detection.&bslash;n&quot;
comma
id|hp-&gt;dev-&gt;name
)paren
suffix:semicolon
multiline_comment|/* Disable auto-negotiation in BMCR, enable FULL duplex and 100mb/s,&n;&t;&t; * setup the timer state machine, and fire it off.&n;&t;&t; *&n;&t;&t; * XXX Should probably reset the DP83840 first&n;&t;&t; * XXX as this is a gross fatal error...&n;&t;&t; */
id|hp-&gt;sw_bmcr
op_assign
id|BMCR_SPEED100
suffix:semicolon
id|happy_meal_tcvr_write
c_func
(paren
id|hp
comma
id|tregs
comma
id|DP83840_BMCR
comma
id|hp-&gt;sw_bmcr
)paren
suffix:semicolon
multiline_comment|/* OK, seems we need do disable the transceiver for the first&n;&t;&t; * tick to make sure we get an accurate link state at the&n;&t;&t; * second tick.&n;&t;&t; */
id|hp-&gt;sw_csconfig
op_assign
id|happy_meal_tcvr_read
c_func
(paren
id|hp
comma
id|tregs
comma
id|DP83840_CSCONFIG
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;%s: CSCONFIG [%04x], disabling transceiver&bslash;n&quot;
comma
id|hp-&gt;dev-&gt;name
comma
id|hp-&gt;sw_csconfig
)paren
suffix:semicolon
id|hp-&gt;sw_csconfig
op_and_assign
op_complement
(paren
id|CSCONFIG_TCVDISAB
)paren
suffix:semicolon
id|happy_meal_tcvr_write
c_func
(paren
id|hp
comma
id|tregs
comma
id|DP83840_CSCONFIG
comma
id|hp-&gt;sw_csconfig
)paren
suffix:semicolon
id|hp-&gt;timer_state
op_assign
id|ltrywait
suffix:semicolon
)brace
r_else
(brace
id|hp-&gt;timer_state
op_assign
id|arbwait
suffix:semicolon
)brace
id|hp-&gt;timer_ticks
op_assign
l_int|0
suffix:semicolon
id|hp-&gt;happy_timer.expires
op_assign
id|jiffies
op_plus
(paren
l_int|12
op_star
id|HZ
)paren
op_div
l_int|10
suffix:semicolon
multiline_comment|/* 1.2 sec. */
id|hp-&gt;happy_timer.data
op_assign
(paren
r_int
r_int
)paren
id|hp
suffix:semicolon
id|hp-&gt;happy_timer.function
op_assign
op_amp
id|happy_meal_timer
suffix:semicolon
id|add_timer
c_func
(paren
op_amp
id|hp-&gt;happy_timer
)paren
suffix:semicolon
)brace
DECL|function|happy_meal_init
r_static
r_int
id|happy_meal_init
c_func
(paren
r_struct
id|happy_meal
op_star
id|hp
comma
r_int
id|from_irq
)paren
(brace
r_struct
id|hmeal_gregs
op_star
id|gregs
op_assign
id|hp-&gt;gregs
suffix:semicolon
r_struct
id|hmeal_etxregs
op_star
id|etxregs
op_assign
id|hp-&gt;etxregs
suffix:semicolon
r_struct
id|hmeal_erxregs
op_star
id|erxregs
op_assign
id|hp-&gt;erxregs
suffix:semicolon
r_struct
id|hmeal_bigmacregs
op_star
id|bregs
op_assign
id|hp-&gt;bigmacregs
suffix:semicolon
r_struct
id|hmeal_tcvregs
op_star
id|tregs
op_assign
id|hp-&gt;tcvregs
suffix:semicolon
r_int
r_int
id|regtmp
suffix:semicolon
r_int
r_char
op_star
id|e
op_assign
op_amp
id|hp-&gt;dev-&gt;dev_addr
(braket
l_int|0
)braket
suffix:semicolon
id|HMD
c_func
(paren
(paren
l_string|&quot;happy_meal_init: &quot;
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|hp-&gt;happy_flags
op_amp
id|HFLAG_INIT
)paren
)paren
(brace
id|HMD
c_func
(paren
(paren
l_string|&quot;set HFLAG_INIT, &quot;
)paren
)paren
suffix:semicolon
id|hp-&gt;happy_flags
op_or_assign
id|HFLAG_INIT
suffix:semicolon
id|happy_meal_get_counters
c_func
(paren
id|hp
comma
id|bregs
)paren
suffix:semicolon
)brace
multiline_comment|/* Stop polling. */
id|HMD
c_func
(paren
(paren
l_string|&quot;to happy_meal_poll_stop&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|happy_meal_poll_stop
c_func
(paren
id|hp
comma
id|tregs
)paren
suffix:semicolon
multiline_comment|/* Stop transmitter and receiver. */
id|HMD
c_func
(paren
(paren
l_string|&quot;happy_meal_init: to happy_meal_stop&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|happy_meal_stop
c_func
(paren
id|gregs
)paren
suffix:semicolon
multiline_comment|/* Alloc and reset the tx/rx descriptor chains. */
id|HMD
c_func
(paren
(paren
l_string|&quot;happy_meal_init: to happy_meal_init_rings&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sparc_cpu_model
op_eq
id|sun4c
)paren
(brace
id|sun4c_happy_meal_init_rings
c_func
(paren
id|hp
)paren
suffix:semicolon
)brace
r_else
id|happy_meal_init_rings
c_func
(paren
id|hp
comma
id|from_irq
)paren
suffix:semicolon
multiline_comment|/* Shut up the MIF. */
id|HMD
c_func
(paren
(paren
l_string|&quot;happy_meal_init: Disable all MIF irqs, &quot;
)paren
)paren
suffix:semicolon
id|tregs-&gt;int_mask
op_assign
l_int|0xffff
suffix:semicolon
multiline_comment|/* See if we can enable the MIF frame on this card to speak to the DP83840. */
r_if
c_cond
(paren
id|hp-&gt;happy_flags
op_amp
id|HFLAG_FENABLE
)paren
(brace
id|HMD
c_func
(paren
(paren
l_string|&quot;use frame, &quot;
)paren
)paren
suffix:semicolon
id|tregs-&gt;cfg
op_and_assign
op_complement
(paren
id|TCV_CFG_BENABLE
)paren
suffix:semicolon
)brace
r_else
(brace
id|HMD
c_func
(paren
(paren
l_string|&quot;use bitbang, &quot;
)paren
)paren
suffix:semicolon
id|tregs-&gt;cfg
op_or_assign
id|TCV_CFG_BENABLE
suffix:semicolon
)brace
multiline_comment|/* Check the state of the transceiver. */
id|HMD
c_func
(paren
(paren
l_string|&quot;to happy_meal_transceiver_check&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|happy_meal_transceiver_check
c_func
(paren
id|hp
comma
id|tregs
)paren
suffix:semicolon
multiline_comment|/* Put the Big Mac into a sane state. */
id|HMD
c_func
(paren
(paren
l_string|&quot;happy_meal_init: &quot;
)paren
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|hp-&gt;tcvr_type
)paren
(brace
r_case
id|none
suffix:colon
multiline_comment|/* Cannot operate if we don&squot;t know the transceiver type! */
id|HMD
c_func
(paren
(paren
l_string|&quot;AAIEEE no transceiver type, EAGAIN&quot;
)paren
)paren
suffix:semicolon
r_return
op_minus
id|EAGAIN
suffix:semicolon
r_case
id|internal
suffix:colon
multiline_comment|/* Using the MII buffers. */
id|HMD
c_func
(paren
(paren
l_string|&quot;internal, using MII, &quot;
)paren
)paren
suffix:semicolon
id|bregs-&gt;xif_cfg
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_case
id|external
suffix:colon
multiline_comment|/* Not using the MII, disable it. */
id|HMD
c_func
(paren
(paren
l_string|&quot;external, disable MII, &quot;
)paren
)paren
suffix:semicolon
id|bregs-&gt;xif_cfg
op_assign
id|BIGMAC_XCFG_MIIDISAB
suffix:semicolon
r_break
suffix:semicolon
)brace
suffix:semicolon
r_if
c_cond
(paren
id|happy_meal_tcvr_reset
c_func
(paren
id|hp
comma
id|tregs
)paren
)paren
(brace
r_return
op_minus
id|EAGAIN
suffix:semicolon
)brace
multiline_comment|/* Reset the Happy Meal Big Mac transceiver and the receiver. */
id|HMD
c_func
(paren
(paren
l_string|&quot;tx/rx reset, &quot;
)paren
)paren
suffix:semicolon
id|happy_meal_tx_reset
c_func
(paren
id|bregs
)paren
suffix:semicolon
id|happy_meal_rx_reset
c_func
(paren
id|bregs
)paren
suffix:semicolon
multiline_comment|/* Set jam size and inter-packet gaps to reasonable defaults. */
id|HMD
c_func
(paren
(paren
l_string|&quot;jsize/ipg1/ipg2, &quot;
)paren
)paren
suffix:semicolon
id|bregs-&gt;jsize
op_assign
id|DEFAULT_JAMSIZE
suffix:semicolon
id|bregs-&gt;ipkt_gap1
op_assign
id|DEFAULT_IPG1
suffix:semicolon
id|bregs-&gt;ipkt_gap2
op_assign
id|DEFAULT_IPG2
suffix:semicolon
multiline_comment|/* Load up the MAC address and random seed. */
id|HMD
c_func
(paren
(paren
l_string|&quot;rseed/macaddr, &quot;
)paren
)paren
suffix:semicolon
multiline_comment|/* XXX use something less deterministic... */
id|bregs-&gt;rand_seed
op_assign
l_int|0xbd
suffix:semicolon
id|bregs-&gt;mac_addr2
op_assign
(paren
(paren
id|e
(braket
l_int|4
)braket
op_lshift
l_int|8
)paren
op_or
id|e
(braket
l_int|5
)braket
)paren
suffix:semicolon
id|bregs-&gt;mac_addr1
op_assign
(paren
(paren
id|e
(braket
l_int|2
)braket
op_lshift
l_int|8
)paren
op_or
id|e
(braket
l_int|3
)braket
)paren
suffix:semicolon
id|bregs-&gt;mac_addr0
op_assign
(paren
(paren
id|e
(braket
l_int|0
)braket
op_lshift
l_int|8
)paren
op_or
id|e
(braket
l_int|1
)braket
)paren
suffix:semicolon
multiline_comment|/* Ick, figure out how to properly program the hash table later... */
id|HMD
c_func
(paren
(paren
l_string|&quot;htable, &quot;
)paren
)paren
suffix:semicolon
id|bregs-&gt;htable3
op_assign
l_int|0
suffix:semicolon
id|bregs-&gt;htable2
op_assign
l_int|0
suffix:semicolon
id|bregs-&gt;htable1
op_assign
l_int|0
suffix:semicolon
id|bregs-&gt;htable0
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Set the RX and TX ring ptrs. */
id|HMD
c_func
(paren
(paren
l_string|&quot;ring ptrs&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|erxregs-&gt;rx_ring
op_assign
id|hp-&gt;hblock_dvma
op_plus
id|hblock_offset
c_func
(paren
id|happy_meal_rxd
comma
l_int|0
)paren
suffix:semicolon
id|etxregs-&gt;tx_ring
op_assign
id|hp-&gt;hblock_dvma
op_plus
id|hblock_offset
c_func
(paren
id|happy_meal_txd
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* Set the supported SBUS burst sizes. */
id|HMD
c_func
(paren
(paren
l_string|&quot;happy_meal_init: bursts&lt;&quot;
)paren
)paren
suffix:semicolon
macro_line|#if 0 /* XXX take down huahaga and debug this... */
multiline_comment|/* Grrr... */
r_if
c_cond
(paren
id|hp-&gt;happy_bursts
op_amp
id|DMA_BURST64
)paren
(brace
id|HMD
c_func
(paren
(paren
l_string|&quot;64&gt;&quot;
)paren
)paren
suffix:semicolon
id|gregs-&gt;cfg
op_assign
id|GREG_CFG_BURST64
suffix:semicolon
)brace
r_else
macro_line|#endif
r_if
c_cond
(paren
id|hp-&gt;happy_bursts
op_amp
id|DMA_BURST32
)paren
(brace
id|HMD
c_func
(paren
(paren
l_string|&quot;32&gt;&quot;
)paren
)paren
suffix:semicolon
id|gregs-&gt;cfg
op_assign
id|GREG_CFG_BURST32
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|hp-&gt;happy_bursts
op_amp
id|DMA_BURST16
)paren
(brace
id|HMD
c_func
(paren
(paren
l_string|&quot;16&gt;&quot;
)paren
)paren
suffix:semicolon
id|gregs-&gt;cfg
op_assign
id|GREG_CFG_BURST16
suffix:semicolon
)brace
r_else
(brace
id|HMD
c_func
(paren
(paren
l_string|&quot;XXX&gt;&quot;
)paren
)paren
suffix:semicolon
id|gregs-&gt;cfg
op_assign
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Turn off interrupts we do not want to hear. */
id|HMD
c_func
(paren
(paren
l_string|&quot;, enable global interrupts, &quot;
)paren
)paren
suffix:semicolon
id|gregs-&gt;imask
op_assign
(paren
id|GREG_IMASK_GOTFRAME
op_or
id|GREG_IMASK_RCNTEXP
op_or
id|GREG_IMASK_SENTFRAME
op_or
id|GREG_IMASK_TXPERR
)paren
suffix:semicolon
multiline_comment|/* Set the transmit ring buffer size. */
id|HMD
c_func
(paren
(paren
l_string|&quot;tx rsize=%d, &quot;
comma
(paren
r_int
)paren
id|TX_RING_SIZE
)paren
)paren
suffix:semicolon
id|etxregs-&gt;tx_rsize
op_assign
(paren
id|TX_RING_SIZE
op_rshift
id|ETX_RSIZE_SHIFT
)paren
op_minus
l_int|1
suffix:semicolon
multiline_comment|/* Enable transmitter DVMA. */
id|HMD
c_func
(paren
(paren
l_string|&quot;tx dma enable, &quot;
)paren
)paren
suffix:semicolon
id|etxregs-&gt;cfg
op_or_assign
id|ETX_CFG_DMAENABLE
suffix:semicolon
multiline_comment|/* This chip really rots, for the receiver sometimes when you&n;&t; * write to it&squot;s control registers not all the bits get there&n;&t; * properly.  I cannot think of a sane way to provide complete&n;&t; * coverage for this hardware bug yet.&n;&t; */
id|HMD
c_func
(paren
(paren
l_string|&quot;erx regs bug&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|erxregs-&gt;cfg
op_assign
id|ERX_CFG_DEFAULT
c_func
(paren
id|RX_OFFSET
)paren
suffix:semicolon
id|regtmp
op_assign
id|erxregs-&gt;cfg
suffix:semicolon
id|erxregs-&gt;cfg
op_assign
id|ERX_CFG_DEFAULT
c_func
(paren
id|RX_OFFSET
)paren
suffix:semicolon
r_if
c_cond
(paren
id|erxregs-&gt;cfg
op_ne
id|ERX_CFG_DEFAULT
c_func
(paren
id|RX_OFFSET
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;happy meal: Eieee, rx config register gets greasy fries.&bslash;n&quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;happy meal: Trying to set %08x, reread gives %08lx&bslash;n&quot;
comma
id|ERX_CFG_DEFAULT
c_func
(paren
id|RX_OFFSET
)paren
comma
id|regtmp
)paren
suffix:semicolon
multiline_comment|/* XXX Should return failure here... */
)brace
multiline_comment|/* Enable Big Mac hash table filter. */
id|HMD
c_func
(paren
(paren
l_string|&quot;happy_meal_init: enable hash, &quot;
)paren
)paren
suffix:semicolon
id|bregs-&gt;rx_cfg
op_assign
id|BIGMAC_RXCFG_HENABLE
suffix:semicolon
multiline_comment|/* Let the bits settle in the chip. */
id|udelay
c_func
(paren
l_int|10
)paren
suffix:semicolon
multiline_comment|/* Ok, configure the Big Mac transmitter. */
id|HMD
c_func
(paren
(paren
l_string|&quot;BIGMAC init, &quot;
)paren
)paren
suffix:semicolon
id|regtmp
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|hp-&gt;happy_flags
op_amp
id|HFLAG_FULL
)paren
(brace
id|regtmp
op_or_assign
id|BIGMAC_TXCFG_FULLDPLX
suffix:semicolon
)brace
id|bregs-&gt;tx_cfg
op_assign
id|regtmp
op_or
id|BIGMAC_TXCFG_DGIVEUP
suffix:semicolon
multiline_comment|/* Enable the output drivers no matter what. */
id|regtmp
op_assign
id|BIGMAC_XCFG_ODENABLE
suffix:semicolon
multiline_comment|/* If card can do lance mode, enable it. */
r_if
c_cond
(paren
id|hp-&gt;happy_flags
op_amp
id|HFLAG_LANCE
)paren
(brace
id|regtmp
op_or_assign
(paren
id|DEFAULT_IPG0
op_lshift
l_int|5
)paren
op_or
id|BIGMAC_XCFG_LANCE
suffix:semicolon
)brace
multiline_comment|/* Disable the MII buffers if using external transceiver. */
r_if
c_cond
(paren
id|hp-&gt;tcvr_type
op_eq
id|external
)paren
(brace
id|regtmp
op_or_assign
id|BIGMAC_XCFG_MIIDISAB
suffix:semicolon
)brace
id|HMD
c_func
(paren
(paren
l_string|&quot;XIF config, &quot;
)paren
)paren
suffix:semicolon
id|bregs-&gt;xif_cfg
op_assign
id|regtmp
suffix:semicolon
multiline_comment|/* Start things up. */
id|HMD
c_func
(paren
(paren
l_string|&quot;tx and rx ON!&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|bregs-&gt;tx_cfg
op_or_assign
id|BIGMAC_TXCFG_ENABLE
suffix:semicolon
id|bregs-&gt;rx_cfg
op_or_assign
id|BIGMAC_RXCFG_ENABLE
suffix:semicolon
multiline_comment|/* Get the autonegotiation started, and the watch timer ticking. */
id|happy_meal_begin_auto_negotiation
c_func
(paren
id|hp
comma
id|tregs
)paren
suffix:semicolon
multiline_comment|/* Success. */
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|happy_meal_set_initial_advertisement
r_static
r_void
id|happy_meal_set_initial_advertisement
c_func
(paren
r_struct
id|happy_meal
op_star
id|hp
)paren
(brace
r_struct
id|hmeal_tcvregs
op_star
id|tregs
op_assign
id|hp-&gt;tcvregs
suffix:semicolon
r_struct
id|hmeal_bigmacregs
op_star
id|bregs
op_assign
id|hp-&gt;bigmacregs
suffix:semicolon
r_struct
id|hmeal_gregs
op_star
id|gregs
op_assign
id|hp-&gt;gregs
suffix:semicolon
id|happy_meal_stop
c_func
(paren
id|gregs
)paren
suffix:semicolon
id|tregs-&gt;int_mask
op_assign
l_int|0xffff
suffix:semicolon
r_if
c_cond
(paren
id|hp-&gt;happy_flags
op_amp
id|HFLAG_FENABLE
)paren
(brace
id|tregs-&gt;cfg
op_and_assign
op_complement
(paren
id|TCV_CFG_BENABLE
)paren
suffix:semicolon
)brace
r_else
id|tregs-&gt;cfg
op_or_assign
id|TCV_CFG_BENABLE
suffix:semicolon
id|happy_meal_transceiver_check
c_func
(paren
id|hp
comma
id|tregs
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|hp-&gt;tcvr_type
)paren
(brace
r_case
id|none
suffix:colon
r_return
suffix:semicolon
r_case
id|internal
suffix:colon
id|bregs-&gt;xif_cfg
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_case
id|external
suffix:colon
id|bregs-&gt;xif_cfg
op_assign
id|BIGMAC_XCFG_MIIDISAB
suffix:semicolon
r_break
suffix:semicolon
)brace
suffix:semicolon
r_if
c_cond
(paren
id|happy_meal_tcvr_reset
c_func
(paren
id|hp
comma
id|tregs
)paren
)paren
(brace
r_return
suffix:semicolon
)brace
multiline_comment|/* Latch PHY registers as of now. */
id|hp-&gt;sw_bmsr
op_assign
id|happy_meal_tcvr_read
c_func
(paren
id|hp
comma
id|tregs
comma
id|DP83840_BMSR
)paren
suffix:semicolon
id|hp-&gt;sw_advertise
op_assign
id|happy_meal_tcvr_read
c_func
(paren
id|hp
comma
id|tregs
comma
id|DP83840_ADVERTISE
)paren
suffix:semicolon
multiline_comment|/* Advertise everything we can support. */
r_if
c_cond
(paren
id|hp-&gt;sw_bmsr
op_amp
id|BMSR_10HALF
)paren
(brace
id|hp-&gt;sw_advertise
op_or_assign
(paren
id|ADVERTISE_10HALF
)paren
suffix:semicolon
)brace
r_else
id|hp-&gt;sw_advertise
op_and_assign
op_complement
(paren
id|ADVERTISE_10HALF
)paren
suffix:semicolon
r_if
c_cond
(paren
id|hp-&gt;sw_bmsr
op_amp
id|BMSR_10FULL
)paren
(brace
id|hp-&gt;sw_advertise
op_or_assign
(paren
id|ADVERTISE_10FULL
)paren
suffix:semicolon
)brace
r_else
id|hp-&gt;sw_advertise
op_and_assign
op_complement
(paren
id|ADVERTISE_10FULL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|hp-&gt;sw_bmsr
op_amp
id|BMSR_100HALF
)paren
(brace
id|hp-&gt;sw_advertise
op_or_assign
(paren
id|ADVERTISE_100HALF
)paren
suffix:semicolon
)brace
r_else
id|hp-&gt;sw_advertise
op_and_assign
op_complement
(paren
id|ADVERTISE_100HALF
)paren
suffix:semicolon
r_if
c_cond
(paren
id|hp-&gt;sw_bmsr
op_amp
id|BMSR_100FULL
)paren
(brace
id|hp-&gt;sw_advertise
op_or_assign
(paren
id|ADVERTISE_100FULL
)paren
suffix:semicolon
)brace
r_else
id|hp-&gt;sw_advertise
op_and_assign
op_complement
(paren
id|ADVERTISE_100FULL
)paren
suffix:semicolon
multiline_comment|/* Update the PHY advertisement register. */
id|happy_meal_tcvr_write
c_func
(paren
id|hp
comma
id|tregs
comma
id|DP83840_ADVERTISE
comma
id|hp-&gt;sw_advertise
)paren
suffix:semicolon
)brace
multiline_comment|/* Once status is latched (by happy_meal_interrupt) it is cleared by&n; * the hardware, so we cannot re-read it and get a correct value.&n; */
DECL|function|happy_meal_is_not_so_happy
r_static
r_int
id|happy_meal_is_not_so_happy
c_func
(paren
r_struct
id|happy_meal
op_star
id|hp
comma
r_struct
id|hmeal_gregs
op_star
id|gregs
comma
r_int
r_int
id|status
)paren
(brace
r_int
id|reset
op_assign
l_int|0
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;%s: Error interrupt for happy meal, status = %08lx&bslash;n&quot;
comma
id|hp-&gt;dev-&gt;name
comma
id|status
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
(paren
id|GREG_STAT_RCNTEXP
op_or
id|GREG_STAT_ACNTEXP
op_or
id|GREG_STAT_CCNTEXP
op_or
id|GREG_STAT_LCNTEXP
)paren
)paren
(brace
multiline_comment|/* Some stupid counter expired, we should be not&n;&t;&t; * have interrupts for this enabled, but we check&n;&t;&t; * for it anyways.&n;&t;&t; */
id|printk
c_func
(paren
l_string|&quot;%s: Happy Meal counters expired [ &quot;
comma
id|hp-&gt;dev-&gt;name
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
id|GREG_STAT_RCNTEXP
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;ReceiveFrame &quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|status
op_amp
id|GREG_STAT_ACNTEXP
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;AlignError &quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|status
op_amp
id|GREG_STAT_CCNTEXP
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;CrcError &quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|status
op_amp
id|GREG_STAT_LCNTEXP
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;LengthError &quot;
)paren
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;]&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|status
op_amp
id|GREG_STAT_RFIFOVF
)paren
(brace
multiline_comment|/* The receive FIFO overflowwed, usually a DMA error. */
id|printk
c_func
(paren
l_string|&quot;%s: Happy Meal receive FIFO overflow.&bslash;n&quot;
comma
id|hp-&gt;dev-&gt;name
)paren
suffix:semicolon
id|reset
op_assign
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|status
op_amp
id|GREG_STAT_CVCNTEXP
)paren
(brace
multiline_comment|/* See above about counter expiration... */
id|printk
c_func
(paren
l_string|&quot;%s: Code Violation error counter expired.&bslash;n&quot;
comma
id|hp-&gt;dev-&gt;name
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|status
op_amp
id|GREG_STAT_STSTERR
)paren
(brace
multiline_comment|/* BigMAC SQE link test failed. */
id|printk
c_func
(paren
l_string|&quot;%s: Happy Meal BigMAC SQE test failed.&bslash;n&quot;
comma
id|hp-&gt;dev-&gt;name
)paren
suffix:semicolon
id|reset
op_assign
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|status
op_amp
id|GREG_STAT_TFIFO_UND
)paren
(brace
multiline_comment|/* Transmit FIFO underrun, again DMA error likely. */
id|printk
c_func
(paren
l_string|&quot;%s: Happy Meal transmitter FIFO underrun, DMA error.&bslash;n&quot;
comma
id|hp-&gt;dev-&gt;name
)paren
suffix:semicolon
id|reset
op_assign
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|status
op_amp
id|GREG_STAT_MAXPKTERR
)paren
(brace
multiline_comment|/* Driver error, tried to transmit something larger&n;&t;&t; * than ethernet max mtu.&n;&t;&t; */
id|printk
c_func
(paren
l_string|&quot;%s: Happy Meal MAX Packet size error.&bslash;n&quot;
comma
id|hp-&gt;dev-&gt;name
)paren
suffix:semicolon
id|reset
op_assign
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|status
op_amp
(paren
id|GREG_STAT_NCNTEXP
op_or
id|GREG_STAT_ECNTEXP
op_or
id|GREG_STAT_LCCNTEXP
op_or
id|GREG_STAT_FCNTEXP
)paren
)paren
(brace
multiline_comment|/* More stupid error counters... */
id|printk
c_func
(paren
l_string|&quot;%s: Happy Meal counters expired [ &quot;
comma
id|hp-&gt;dev-&gt;name
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
id|GREG_STAT_NCNTEXP
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;NormalCollision &quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|status
op_amp
id|GREG_STAT_ECNTEXP
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;ExcessCollision &quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|status
op_amp
id|GREG_STAT_LCCNTEXP
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;LateCollision &quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|status
op_amp
id|GREG_STAT_FCNTEXP
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;FirstCollision &quot;
)paren
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;]&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|status
op_amp
id|GREG_STAT_DTIMEXP
)paren
(brace
multiline_comment|/* Defer-timer expired.  Probably means the happy meal needed&n;&t;&t; * to back off too much before it could transmit one frame.&n;&t;&t; */
macro_line|#if 0&t;&t;/* XXX This isn&squot;t worth reporting and is in fact a normal condition. */
id|printk
c_func
(paren
l_string|&quot;%s: Transmit defer timer expired, subnet congested?&bslash;n&quot;
comma
id|hp-&gt;dev-&gt;name
)paren
suffix:semicolon
id|reset
op_assign
l_int|1
suffix:semicolon
macro_line|#endif
)brace
r_if
c_cond
(paren
id|status
op_amp
id|GREG_STAT_NORXD
)paren
(brace
multiline_comment|/* AIEEE, out of receive descriptors.  Check out our drop&n;&t;&t; * processing in happy_meal_rx to see how we try very hard&n;&t;&t; * to avoid this situation.&n;&t;&t; */
id|printk
c_func
(paren
l_string|&quot;%s: Happy Meal out of receive descriptors, aieee!&bslash;n&quot;
comma
id|hp-&gt;dev-&gt;name
)paren
suffix:semicolon
id|reset
op_assign
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|status
op_amp
(paren
id|GREG_STAT_RXERR
op_or
id|GREG_STAT_RXPERR
op_or
id|GREG_STAT_RXTERR
)paren
)paren
(brace
multiline_comment|/* All sorts of DMA receive errors. */
id|printk
c_func
(paren
l_string|&quot;%s: Happy Meal rx DMA errors [ &quot;
comma
id|hp-&gt;dev-&gt;name
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
id|GREG_STAT_RXERR
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;GenericError &quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|status
op_amp
id|GREG_STAT_RXPERR
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;ParityError &quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|status
op_amp
id|GREG_STAT_RXTERR
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;RxTagBotch &quot;
)paren
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;]&bslash;n&quot;
)paren
suffix:semicolon
id|reset
op_assign
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|status
op_amp
id|GREG_STAT_EOPERR
)paren
(brace
multiline_comment|/* Driver bug, didn&squot;t set EOP bit in tx descriptor given&n;&t;&t; * to the happy meal.&n;&t;&t; */
id|printk
c_func
(paren
l_string|&quot;%s: EOP not set in happy meal transmit descriptor!&bslash;n&quot;
comma
id|hp-&gt;dev-&gt;name
)paren
suffix:semicolon
id|reset
op_assign
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|status
op_amp
id|GREG_STAT_MIFIRQ
)paren
(brace
multiline_comment|/* MIF signalled an interrupt, were we polling it? */
id|printk
c_func
(paren
l_string|&quot;%s: Happy Meal MIF interrupt.&bslash;n&quot;
comma
id|hp-&gt;dev-&gt;name
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|status
op_amp
(paren
id|GREG_STAT_TXEACK
op_or
id|GREG_STAT_TXLERR
op_or
id|GREG_STAT_TXPERR
op_or
id|GREG_STAT_TXTERR
)paren
)paren
(brace
multiline_comment|/* All sorts of transmit DMA errors. */
id|printk
c_func
(paren
l_string|&quot;%s: Happy Meal tx DMA errors [ &quot;
comma
id|hp-&gt;dev-&gt;name
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
id|GREG_STAT_TXEACK
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;GenericError &quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|status
op_amp
id|GREG_STAT_TXLERR
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;LateError &quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|status
op_amp
id|GREG_STAT_TXPERR
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;ParityErro &quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|status
op_amp
id|GREG_STAT_TXTERR
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;TagBotch &quot;
)paren
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;]&bslash;n&quot;
)paren
suffix:semicolon
id|reset
op_assign
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|status
op_amp
(paren
id|GREG_STAT_SLVERR
op_or
id|GREG_STAT_SLVPERR
)paren
)paren
(brace
multiline_comment|/* Bus or parity error when cpu accessed happy meal registers&n;&t;&t; * or it&squot;s internal FIFO&squot;s.  Should never see this.&n;&t;&t; */
id|printk
c_func
(paren
l_string|&quot;%s: Happy Meal register access SBUS slave (%s) error.&bslash;n&quot;
comma
id|hp-&gt;dev-&gt;name
comma
(paren
id|status
op_amp
id|GREG_STAT_SLVPERR
)paren
ques
c_cond
l_string|&quot;parity&quot;
suffix:colon
l_string|&quot;generic&quot;
)paren
suffix:semicolon
id|reset
op_assign
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|reset
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%s: Resetting...&bslash;n&quot;
comma
id|hp-&gt;dev-&gt;name
)paren
suffix:semicolon
id|happy_meal_init
c_func
(paren
id|hp
comma
l_int|1
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|happy_meal_mif_interrupt
r_static
r_inline
r_void
id|happy_meal_mif_interrupt
c_func
(paren
r_struct
id|happy_meal
op_star
id|hp
comma
r_struct
id|hmeal_gregs
op_star
id|gregs
comma
r_struct
id|hmeal_tcvregs
op_star
id|tregs
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%s: Link status change.&bslash;n&quot;
comma
id|hp-&gt;dev-&gt;name
)paren
suffix:semicolon
id|hp-&gt;sw_bmcr
op_assign
id|happy_meal_tcvr_read
c_func
(paren
id|hp
comma
id|tregs
comma
id|DP83840_BMCR
)paren
suffix:semicolon
id|hp-&gt;sw_lpa
op_assign
id|happy_meal_tcvr_read
c_func
(paren
id|hp
comma
id|tregs
comma
id|DP83840_LPA
)paren
suffix:semicolon
multiline_comment|/* Use the fastest transmission protocol possible. */
r_if
c_cond
(paren
id|hp-&gt;sw_lpa
op_amp
id|LPA_100FULL
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%s: Switching to 100Mbps at full duplex.&quot;
comma
id|hp-&gt;dev-&gt;name
)paren
suffix:semicolon
id|hp-&gt;sw_bmcr
op_or_assign
(paren
id|BMCR_FULLDPLX
op_or
id|BMCR_SPEED100
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|hp-&gt;sw_lpa
op_amp
id|LPA_100HALF
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%s: Switching to 100MBps at half duplex.&quot;
comma
id|hp-&gt;dev-&gt;name
)paren
suffix:semicolon
id|hp-&gt;sw_bmcr
op_or_assign
id|BMCR_SPEED100
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|hp-&gt;sw_lpa
op_amp
id|LPA_10FULL
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%s: Switching to 10MBps at full duplex.&quot;
comma
id|hp-&gt;dev-&gt;name
)paren
suffix:semicolon
id|hp-&gt;sw_bmcr
op_or_assign
id|BMCR_FULLDPLX
suffix:semicolon
)brace
r_else
(brace
id|printk
c_func
(paren
l_string|&quot;%s: Using 10Mbps at half duplex.&quot;
comma
id|hp-&gt;dev-&gt;name
)paren
suffix:semicolon
)brace
id|happy_meal_tcvr_write
c_func
(paren
id|hp
comma
id|tregs
comma
id|DP83840_BMCR
comma
id|hp-&gt;sw_bmcr
)paren
suffix:semicolon
multiline_comment|/* Finally stop polling and shut up the MIF. */
id|happy_meal_poll_stop
c_func
(paren
id|hp
comma
id|tregs
)paren
suffix:semicolon
)brace
multiline_comment|/* #define TXD(x) printk x */
DECL|macro|TXD
mdefine_line|#define TXD(x)
DECL|function|happy_meal_tx
r_static
r_inline
r_void
id|happy_meal_tx
c_func
(paren
r_struct
id|happy_meal
op_star
id|hp
)paren
(brace
r_struct
id|happy_meal_txd
op_star
id|txbase
op_assign
op_amp
id|hp-&gt;happy_block-&gt;happy_meal_txd
(braket
l_int|0
)braket
suffix:semicolon
r_struct
id|happy_meal_txd
op_star
id|this
suffix:semicolon
r_int
id|elem
op_assign
id|hp-&gt;tx_old
suffix:semicolon
id|TXD
c_func
(paren
(paren
l_string|&quot;TX&lt;&quot;
)paren
)paren
suffix:semicolon
r_while
c_loop
(paren
id|elem
op_ne
id|hp-&gt;tx_new
)paren
(brace
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
id|TXD
c_func
(paren
(paren
l_string|&quot;[%d]&quot;
comma
id|elem
)paren
)paren
suffix:semicolon
id|this
op_assign
op_amp
id|txbase
(braket
id|elem
)braket
suffix:semicolon
r_if
c_cond
(paren
id|this-&gt;tx_flags
op_amp
id|TXFLAG_OWN
)paren
(brace
r_break
suffix:semicolon
)brace
id|skb
op_assign
id|hp-&gt;tx_skbs
(braket
id|elem
)braket
suffix:semicolon
id|hp-&gt;tx_skbs
(braket
id|elem
)braket
op_assign
l_int|NULL
suffix:semicolon
id|hp-&gt;net_stats.tx_bytes
op_add_assign
id|skb-&gt;len
suffix:semicolon
id|dev_kfree_skb
c_func
(paren
id|skb
comma
id|FREE_WRITE
)paren
suffix:semicolon
id|hp-&gt;net_stats.tx_packets
op_increment
suffix:semicolon
id|elem
op_assign
id|NEXT_TX
c_func
(paren
id|elem
)paren
suffix:semicolon
)brace
id|hp-&gt;tx_old
op_assign
id|elem
suffix:semicolon
id|TXD
c_func
(paren
(paren
l_string|&quot;&gt;&quot;
)paren
)paren
suffix:semicolon
)brace
DECL|function|sun4c_happy_meal_tx
r_static
r_inline
r_void
id|sun4c_happy_meal_tx
c_func
(paren
r_struct
id|happy_meal
op_star
id|hp
)paren
(brace
r_struct
id|happy_meal_txd
op_star
id|txbase
op_assign
op_amp
id|hp-&gt;happy_block-&gt;happy_meal_txd
(braket
l_int|0
)braket
suffix:semicolon
r_struct
id|happy_meal_txd
op_star
id|this
suffix:semicolon
r_int
id|elem
op_assign
id|hp-&gt;tx_old
suffix:semicolon
id|TXD
c_func
(paren
(paren
l_string|&quot;TX&lt;&quot;
)paren
)paren
suffix:semicolon
r_while
c_loop
(paren
id|elem
op_ne
id|hp-&gt;tx_new
)paren
(brace
id|TXD
c_func
(paren
(paren
l_string|&quot;[%d]&quot;
comma
id|elem
)paren
)paren
suffix:semicolon
id|this
op_assign
op_amp
id|txbase
(braket
id|elem
)braket
suffix:semicolon
r_if
c_cond
(paren
id|this-&gt;tx_flags
op_amp
id|TXFLAG_OWN
)paren
(brace
r_break
suffix:semicolon
)brace
id|hp-&gt;net_stats.tx_packets
op_increment
suffix:semicolon
id|elem
op_assign
id|NEXT_TX
c_func
(paren
id|elem
)paren
suffix:semicolon
)brace
id|hp-&gt;tx_old
op_assign
id|elem
suffix:semicolon
id|TXD
c_func
(paren
(paren
l_string|&quot;&gt;&quot;
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/* #define RXD(x) printk x */
DECL|macro|RXD
mdefine_line|#define RXD(x)
multiline_comment|/* Originally I use to handle the allocation failure by just giving back just&n; * that one ring buffer to the happy meal.  Problem is that usually when that&n; * condition is triggered, the happy meal expects you to do something reasonable&n; * with all of the packets it has DMA&squot;d in.  So now I just drop the entire&n; * ring when we cannot get a new skb and give them all back to the happy meal,&n; * maybe things will be &quot;happier&quot; now.&n; */
DECL|function|happy_meal_rx
r_static
r_inline
r_void
id|happy_meal_rx
c_func
(paren
r_struct
id|happy_meal
op_star
id|hp
comma
r_struct
id|device
op_star
id|dev
comma
r_struct
id|hmeal_gregs
op_star
id|gregs
)paren
(brace
r_struct
id|happy_meal_rxd
op_star
id|rxbase
op_assign
op_amp
id|hp-&gt;happy_block-&gt;happy_meal_rxd
(braket
l_int|0
)braket
suffix:semicolon
r_struct
id|happy_meal_rxd
op_star
id|this
suffix:semicolon
r_int
id|elem
op_assign
id|hp-&gt;rx_new
comma
id|drops
op_assign
l_int|0
suffix:semicolon
id|RXD
c_func
(paren
(paren
l_string|&quot;RX&lt;&quot;
)paren
)paren
suffix:semicolon
id|this
op_assign
op_amp
id|rxbase
(braket
id|elem
)braket
suffix:semicolon
r_while
c_loop
(paren
op_logical_neg
(paren
id|this-&gt;rx_flags
op_amp
id|RXFLAG_OWN
)paren
)paren
(brace
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
r_int
r_int
id|flags
op_assign
id|this-&gt;rx_flags
suffix:semicolon
r_int
id|len
op_assign
id|flags
op_rshift
l_int|16
suffix:semicolon
id|u16
id|csum
op_assign
id|flags
op_amp
id|RXFLAG_CSUM
suffix:semicolon
id|RXD
c_func
(paren
(paren
l_string|&quot;[%d &quot;
comma
id|elem
)paren
)paren
suffix:semicolon
multiline_comment|/* Check for errors. */
r_if
c_cond
(paren
(paren
id|len
OL
id|ETH_ZLEN
)paren
op_logical_or
(paren
id|flags
op_amp
id|RXFLAG_OVERFLOW
)paren
)paren
(brace
id|RXD
c_func
(paren
(paren
l_string|&quot;ERR(%08lx)]&quot;
comma
id|flags
)paren
)paren
suffix:semicolon
id|hp-&gt;net_stats.rx_errors
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|len
OL
id|ETH_ZLEN
)paren
(brace
id|hp-&gt;net_stats.rx_length_errors
op_increment
suffix:semicolon
)brace
r_if
c_cond
(paren
id|len
op_amp
(paren
id|RXFLAG_OVERFLOW
op_rshift
l_int|16
)paren
)paren
(brace
id|hp-&gt;net_stats.rx_over_errors
op_increment
suffix:semicolon
id|hp-&gt;net_stats.rx_fifo_errors
op_increment
suffix:semicolon
)brace
multiline_comment|/* Return it to the Happy meal. */
id|drop_it
suffix:colon
id|hp-&gt;net_stats.rx_dropped
op_increment
suffix:semicolon
id|this-&gt;rx_addr
op_assign
(paren
r_int
r_int
)paren
id|hp-&gt;rx_skbs
(braket
id|elem
)braket
op_member_access_from_pointer
id|data
suffix:semicolon
id|this-&gt;rx_flags
op_assign
(paren
id|RXFLAG_OWN
op_or
(paren
(paren
id|RX_BUF_ALLOC_SIZE
op_minus
id|RX_OFFSET
)paren
op_lshift
l_int|16
)paren
)paren
suffix:semicolon
r_goto
id|next
suffix:semicolon
)brace
id|skb
op_assign
id|hp-&gt;rx_skbs
(braket
id|elem
)braket
suffix:semicolon
r_if
c_cond
(paren
id|len
OG
id|RX_COPY_THRESHOLD
)paren
(brace
r_struct
id|sk_buff
op_star
id|new_skb
suffix:semicolon
multiline_comment|/* Now refill the entry, if we can. */
id|new_skb
op_assign
id|happy_meal_alloc_skb
c_func
(paren
id|RX_BUF_ALLOC_SIZE
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|new_skb
)paren
(brace
id|drops
op_increment
suffix:semicolon
r_goto
id|drop_it
suffix:semicolon
)brace
id|hp-&gt;rx_skbs
(braket
id|elem
)braket
op_assign
id|new_skb
suffix:semicolon
id|new_skb-&gt;dev
op_assign
id|dev
suffix:semicolon
id|skb_put
c_func
(paren
id|new_skb
comma
(paren
id|ETH_FRAME_LEN
op_plus
id|RX_OFFSET
)paren
)paren
suffix:semicolon
id|rxbase
(braket
id|elem
)braket
dot
id|rx_addr
op_assign
(paren
r_int
r_int
)paren
id|new_skb-&gt;data
suffix:semicolon
id|skb_reserve
c_func
(paren
id|new_skb
comma
id|RX_OFFSET
)paren
suffix:semicolon
id|rxbase
(braket
id|elem
)braket
dot
id|rx_flags
op_assign
(paren
id|RXFLAG_OWN
op_or
(paren
(paren
id|RX_BUF_ALLOC_SIZE
op_minus
id|RX_OFFSET
)paren
op_lshift
l_int|16
)paren
)paren
suffix:semicolon
multiline_comment|/* Trim the original skb for the netif. */
id|skb_trim
c_func
(paren
id|skb
comma
id|len
)paren
suffix:semicolon
)brace
r_else
(brace
r_struct
id|sk_buff
op_star
id|copy_skb
op_assign
id|dev_alloc_skb
c_func
(paren
id|len
op_plus
l_int|2
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|copy_skb
)paren
(brace
id|drops
op_increment
suffix:semicolon
r_goto
id|drop_it
suffix:semicolon
)brace
id|copy_skb-&gt;dev
op_assign
id|dev
suffix:semicolon
id|skb_reserve
c_func
(paren
id|copy_skb
comma
l_int|2
)paren
suffix:semicolon
id|skb_put
c_func
(paren
id|copy_skb
comma
id|len
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|copy_skb-&gt;data
comma
id|skb-&gt;data
comma
id|len
)paren
suffix:semicolon
multiline_comment|/* Reuse original ring buffer. */
id|rxbase
(braket
id|elem
)braket
dot
id|rx_addr
op_assign
(paren
r_int
r_int
)paren
id|skb-&gt;data
suffix:semicolon
id|rxbase
(braket
id|elem
)braket
dot
id|rx_flags
op_assign
(paren
id|RXFLAG_OWN
op_or
(paren
(paren
id|RX_BUF_ALLOC_SIZE
op_minus
id|RX_OFFSET
)paren
op_lshift
l_int|16
)paren
)paren
suffix:semicolon
id|skb
op_assign
id|copy_skb
suffix:semicolon
)brace
multiline_comment|/* This card is _fucking_ hot... */
r_if
c_cond
(paren
op_logical_neg
op_complement
(paren
id|csum
)paren
)paren
(brace
id|skb-&gt;ip_summed
op_assign
id|CHECKSUM_UNNECESSARY
suffix:semicolon
)brace
r_else
id|skb-&gt;ip_summed
op_assign
id|CHECKSUM_NONE
suffix:semicolon
id|RXD
c_func
(paren
(paren
l_string|&quot;len=%d csum=%4x]&quot;
comma
id|len
comma
id|csum
)paren
)paren
suffix:semicolon
id|skb-&gt;protocol
op_assign
id|eth_type_trans
c_func
(paren
id|skb
comma
id|dev
)paren
suffix:semicolon
id|netif_rx
c_func
(paren
id|skb
)paren
suffix:semicolon
id|hp-&gt;net_stats.rx_packets
op_increment
suffix:semicolon
id|next
suffix:colon
id|elem
op_assign
id|NEXT_RX
c_func
(paren
id|elem
)paren
suffix:semicolon
id|this
op_assign
op_amp
id|rxbase
(braket
id|elem
)braket
suffix:semicolon
)brace
id|hp-&gt;rx_new
op_assign
id|elem
suffix:semicolon
r_if
c_cond
(paren
id|drops
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%s: Memory squeeze, deferring packet.&bslash;n&quot;
comma
id|hp-&gt;dev-&gt;name
)paren
suffix:semicolon
)brace
id|RXD
c_func
(paren
(paren
l_string|&quot;&gt;&quot;
)paren
)paren
suffix:semicolon
)brace
DECL|function|sun4c_happy_meal_rx
r_static
r_inline
r_void
id|sun4c_happy_meal_rx
c_func
(paren
r_struct
id|happy_meal
op_star
id|hp
comma
r_struct
id|device
op_star
id|dev
comma
r_struct
id|hmeal_gregs
op_star
id|gregs
)paren
(brace
r_struct
id|happy_meal_rxd
op_star
id|rxbase
op_assign
op_amp
id|hp-&gt;happy_block-&gt;happy_meal_rxd
(braket
l_int|0
)braket
suffix:semicolon
r_struct
id|happy_meal_rxd
op_star
id|this
suffix:semicolon
r_struct
id|hmeal_buffers
op_star
id|hbufs
op_assign
id|hp-&gt;sun4c_buffers
suffix:semicolon
id|__u32
id|hbufs_dvma
op_assign
id|hp-&gt;s4c_buf_dvma
suffix:semicolon
r_int
id|elem
op_assign
id|hp-&gt;rx_new
comma
id|drops
op_assign
l_int|0
suffix:semicolon
id|RXD
c_func
(paren
(paren
l_string|&quot;RX&lt;&quot;
)paren
)paren
suffix:semicolon
id|this
op_assign
op_amp
id|rxbase
(braket
id|elem
)braket
suffix:semicolon
r_while
c_loop
(paren
op_logical_neg
(paren
id|this-&gt;rx_flags
op_amp
id|RXFLAG_OWN
)paren
)paren
(brace
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
r_int
r_int
id|flags
op_assign
id|this-&gt;rx_flags
suffix:semicolon
r_int
r_char
op_star
id|thisbuf
op_assign
op_amp
id|hbufs-&gt;rx_buf
(braket
id|elem
)braket
(braket
l_int|0
)braket
suffix:semicolon
id|__u32
id|thisbuf_dvma
op_assign
id|hbufs_dvma
op_plus
id|hbuf_offset
c_func
(paren
id|rx_buf
comma
id|elem
)paren
suffix:semicolon
r_int
id|len
op_assign
id|flags
op_rshift
l_int|16
suffix:semicolon
id|RXD
c_func
(paren
(paren
l_string|&quot;[%d &quot;
comma
id|elem
)paren
)paren
suffix:semicolon
multiline_comment|/* Check for errors. */
r_if
c_cond
(paren
(paren
id|len
OL
id|ETH_ZLEN
)paren
op_logical_or
(paren
id|flags
op_amp
id|RXFLAG_OVERFLOW
)paren
)paren
(brace
id|RXD
c_func
(paren
(paren
l_string|&quot;ERR(%08lx)]&quot;
comma
id|flags
)paren
)paren
suffix:semicolon
id|hp-&gt;net_stats.rx_errors
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|len
OL
id|ETH_ZLEN
)paren
(brace
id|hp-&gt;net_stats.rx_length_errors
op_increment
suffix:semicolon
)brace
r_if
c_cond
(paren
id|len
op_amp
(paren
id|RXFLAG_OVERFLOW
op_rshift
l_int|16
)paren
)paren
(brace
id|hp-&gt;net_stats.rx_over_errors
op_increment
suffix:semicolon
id|hp-&gt;net_stats.rx_fifo_errors
op_increment
suffix:semicolon
)brace
id|hp-&gt;net_stats.rx_dropped
op_increment
suffix:semicolon
)brace
r_else
(brace
id|skb
op_assign
id|dev_alloc_skb
c_func
(paren
id|len
op_plus
l_int|2
)paren
suffix:semicolon
r_if
c_cond
(paren
id|skb
op_eq
l_int|0
)paren
(brace
id|drops
op_increment
suffix:semicolon
id|hp-&gt;net_stats.rx_dropped
op_increment
suffix:semicolon
)brace
r_else
(brace
id|RXD
c_func
(paren
(paren
l_string|&quot;len=%d]&quot;
comma
id|len
)paren
)paren
suffix:semicolon
id|skb-&gt;dev
op_assign
id|hp-&gt;dev
suffix:semicolon
id|skb_reserve
c_func
(paren
id|skb
comma
l_int|2
)paren
suffix:semicolon
id|skb_put
c_func
(paren
id|skb
comma
id|len
)paren
suffix:semicolon
id|eth_copy_and_sum
c_func
(paren
id|skb
comma
(paren
id|thisbuf
op_plus
l_int|2
)paren
comma
id|len
comma
l_int|0
)paren
suffix:semicolon
id|skb-&gt;protocol
op_assign
id|eth_type_trans
c_func
(paren
id|skb
comma
id|dev
)paren
suffix:semicolon
id|netif_rx
c_func
(paren
id|skb
)paren
suffix:semicolon
id|hp-&gt;net_stats.rx_packets
op_increment
suffix:semicolon
)brace
)brace
multiline_comment|/* Return the buffer to the Happy Meal. */
id|this-&gt;rx_addr
op_assign
id|thisbuf_dvma
suffix:semicolon
id|this-&gt;rx_flags
op_assign
(paren
id|RXFLAG_OWN
op_or
(paren
(paren
id|SUN4C_RX_BUFF_SIZE
op_minus
id|RX_OFFSET
)paren
op_lshift
l_int|16
)paren
)paren
suffix:semicolon
id|elem
op_assign
id|NEXT_RX
c_func
(paren
id|elem
)paren
suffix:semicolon
id|this
op_assign
op_amp
id|rxbase
(braket
id|elem
)braket
suffix:semicolon
)brace
id|hp-&gt;rx_new
op_assign
id|elem
suffix:semicolon
r_if
c_cond
(paren
id|drops
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%s: Memory squeeze, deferring packet.&bslash;n&quot;
comma
id|hp-&gt;dev-&gt;name
)paren
suffix:semicolon
)brace
id|RXD
c_func
(paren
(paren
l_string|&quot;&gt;&quot;
)paren
)paren
suffix:semicolon
)brace
DECL|function|happy_meal_interrupt
r_static
r_void
id|happy_meal_interrupt
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_struct
id|device
op_star
id|dev
op_assign
(paren
r_struct
id|device
op_star
)paren
id|dev_id
suffix:semicolon
r_struct
id|happy_meal
op_star
id|hp
op_assign
(paren
r_struct
id|happy_meal
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_struct
id|hmeal_gregs
op_star
id|gregs
op_assign
id|hp-&gt;gregs
suffix:semicolon
r_struct
id|hmeal_tcvregs
op_star
id|tregs
op_assign
id|hp-&gt;tcvregs
suffix:semicolon
r_int
r_int
id|happy_status
op_assign
id|gregs-&gt;stat
suffix:semicolon
id|HMD
c_func
(paren
(paren
l_string|&quot;happy_meal_interrupt: status=%08lx &quot;
comma
id|happy_status
)paren
)paren
suffix:semicolon
id|dev-&gt;interrupt
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|happy_status
op_amp
id|GREG_STAT_ERRORS
)paren
(brace
id|HMD
c_func
(paren
(paren
l_string|&quot;ERRORS &quot;
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|happy_meal_is_not_so_happy
c_func
(paren
id|hp
comma
id|gregs
comma
multiline_comment|/* un- */
id|happy_status
)paren
)paren
(brace
id|dev-&gt;interrupt
op_assign
l_int|0
suffix:semicolon
r_return
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|happy_status
op_amp
id|GREG_STAT_MIFIRQ
)paren
(brace
id|HMD
c_func
(paren
(paren
l_string|&quot;MIFIRQ &quot;
)paren
)paren
suffix:semicolon
id|happy_meal_mif_interrupt
c_func
(paren
id|hp
comma
id|gregs
comma
id|tregs
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|happy_status
op_amp
id|GREG_STAT_TXALL
)paren
(brace
id|HMD
c_func
(paren
(paren
l_string|&quot;TXALL &quot;
)paren
)paren
suffix:semicolon
id|happy_meal_tx
c_func
(paren
id|hp
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|happy_status
op_amp
id|GREG_STAT_RXTOHOST
)paren
(brace
id|HMD
c_func
(paren
(paren
l_string|&quot;RXTOHOST &quot;
)paren
)paren
suffix:semicolon
id|happy_meal_rx
c_func
(paren
id|hp
comma
id|dev
comma
id|gregs
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|dev-&gt;tbusy
op_logical_and
(paren
id|TX_BUFFS_AVAIL
c_func
(paren
id|hp
)paren
op_ge
l_int|0
)paren
)paren
(brace
id|hp-&gt;dev-&gt;tbusy
op_assign
l_int|0
suffix:semicolon
id|mark_bh
c_func
(paren
id|NET_BH
)paren
suffix:semicolon
)brace
id|dev-&gt;interrupt
op_assign
l_int|0
suffix:semicolon
id|HMD
c_func
(paren
(paren
l_string|&quot;done&bslash;n&quot;
)paren
)paren
suffix:semicolon
)brace
DECL|function|sun4c_happy_meal_interrupt
r_static
r_void
id|sun4c_happy_meal_interrupt
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_struct
id|device
op_star
id|dev
op_assign
(paren
r_struct
id|device
op_star
)paren
id|dev_id
suffix:semicolon
r_struct
id|happy_meal
op_star
id|hp
op_assign
(paren
r_struct
id|happy_meal
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_struct
id|hmeal_gregs
op_star
id|gregs
op_assign
id|hp-&gt;gregs
suffix:semicolon
r_struct
id|hmeal_tcvregs
op_star
id|tregs
op_assign
id|hp-&gt;tcvregs
suffix:semicolon
r_int
r_int
id|happy_status
op_assign
id|gregs-&gt;stat
suffix:semicolon
id|HMD
c_func
(paren
(paren
l_string|&quot;happy_meal_interrupt: status=%08lx &quot;
comma
id|happy_status
)paren
)paren
suffix:semicolon
id|dev-&gt;interrupt
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|happy_status
op_amp
id|GREG_STAT_ERRORS
)paren
(brace
id|HMD
c_func
(paren
(paren
l_string|&quot;ERRORS &quot;
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|happy_meal_is_not_so_happy
c_func
(paren
id|hp
comma
id|gregs
comma
multiline_comment|/* un- */
id|happy_status
)paren
)paren
(brace
id|dev-&gt;interrupt
op_assign
l_int|0
suffix:semicolon
r_return
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|happy_status
op_amp
id|GREG_STAT_MIFIRQ
)paren
(brace
id|HMD
c_func
(paren
(paren
l_string|&quot;MIFIRQ &quot;
)paren
)paren
suffix:semicolon
id|happy_meal_mif_interrupt
c_func
(paren
id|hp
comma
id|gregs
comma
id|tregs
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|happy_status
op_amp
id|GREG_STAT_TXALL
)paren
(brace
id|HMD
c_func
(paren
(paren
l_string|&quot;TXALL &quot;
)paren
)paren
suffix:semicolon
id|sun4c_happy_meal_tx
c_func
(paren
id|hp
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|happy_status
op_amp
id|GREG_STAT_RXTOHOST
)paren
(brace
id|HMD
c_func
(paren
(paren
l_string|&quot;RXTOHOST &quot;
)paren
)paren
suffix:semicolon
id|sun4c_happy_meal_rx
c_func
(paren
id|hp
comma
id|dev
comma
id|gregs
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|dev-&gt;tbusy
op_logical_and
(paren
id|TX_BUFFS_AVAIL
c_func
(paren
id|hp
)paren
op_ge
l_int|0
)paren
)paren
(brace
id|hp-&gt;dev-&gt;tbusy
op_assign
l_int|0
suffix:semicolon
id|mark_bh
c_func
(paren
id|NET_BH
)paren
suffix:semicolon
)brace
id|dev-&gt;interrupt
op_assign
l_int|0
suffix:semicolon
id|HMD
c_func
(paren
(paren
l_string|&quot;done&bslash;n&quot;
)paren
)paren
suffix:semicolon
)brace
DECL|function|happy_meal_open
r_static
r_int
id|happy_meal_open
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
r_struct
id|happy_meal
op_star
id|hp
op_assign
(paren
r_struct
id|happy_meal
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_int
id|res
suffix:semicolon
id|HMD
c_func
(paren
(paren
l_string|&quot;happy_meal_open: &quot;
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sparc_cpu_model
op_eq
id|sun4c
)paren
(brace
r_if
c_cond
(paren
id|request_irq
c_func
(paren
id|dev-&gt;irq
comma
op_amp
id|sun4c_happy_meal_interrupt
comma
id|SA_SHIRQ
comma
l_string|&quot;HAPPY MEAL&quot;
comma
(paren
r_void
op_star
)paren
id|dev
)paren
)paren
(brace
id|HMD
c_func
(paren
(paren
l_string|&quot;EAGAIN&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;happy meal: Can&squot;t order irq %d to go.&bslash;n&quot;
comma
id|dev-&gt;irq
)paren
suffix:semicolon
r_return
op_minus
id|EAGAIN
suffix:semicolon
)brace
)brace
r_else
(brace
r_if
c_cond
(paren
id|request_irq
c_func
(paren
id|dev-&gt;irq
comma
op_amp
id|happy_meal_interrupt
comma
id|SA_SHIRQ
comma
l_string|&quot;HAPPY MEAL&quot;
comma
(paren
r_void
op_star
)paren
id|dev
)paren
)paren
(brace
id|HMD
c_func
(paren
(paren
l_string|&quot;EAGAIN&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;happy meal: Can&squot;t order irq %d to go.&bslash;n&quot;
comma
id|dev-&gt;irq
)paren
suffix:semicolon
r_return
op_minus
id|EAGAIN
suffix:semicolon
)brace
)brace
id|HMD
c_func
(paren
(paren
l_string|&quot;Init happy timer&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|init_timer
c_func
(paren
op_amp
id|hp-&gt;happy_timer
)paren
suffix:semicolon
id|HMD
c_func
(paren
(paren
l_string|&quot;to happy_meal_init&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|res
op_assign
id|happy_meal_init
c_func
(paren
id|hp
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|res
)paren
(brace
id|MOD_INC_USE_COUNT
suffix:semicolon
)brace
r_return
id|res
suffix:semicolon
)brace
DECL|function|happy_meal_close
r_static
r_int
id|happy_meal_close
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
r_struct
id|happy_meal
op_star
id|hp
op_assign
(paren
r_struct
id|happy_meal
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|happy_meal_stop
c_func
(paren
id|hp-&gt;gregs
)paren
suffix:semicolon
id|happy_meal_clean_rings
c_func
(paren
id|hp
)paren
suffix:semicolon
id|free_irq
c_func
(paren
id|dev-&gt;irq
comma
(paren
r_void
op_star
)paren
id|dev
)paren
suffix:semicolon
id|MOD_DEC_USE_COUNT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* #define SXD(x) printk x */
DECL|macro|SXD
mdefine_line|#define SXD(x)
DECL|function|happy_meal_start_xmit
r_static
r_int
id|happy_meal_start_xmit
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|device
op_star
id|dev
)paren
(brace
r_struct
id|happy_meal
op_star
id|hp
op_assign
(paren
r_struct
id|happy_meal
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_int
id|len
comma
id|entry
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;tbusy
)paren
(brace
r_int
id|tickssofar
op_assign
id|jiffies
op_minus
id|dev-&gt;trans_start
suffix:semicolon
r_if
c_cond
(paren
id|tickssofar
OL
l_int|40
)paren
(brace
r_return
l_int|1
suffix:semicolon
)brace
r_else
(brace
id|printk
(paren
l_string|&quot;%s: transmit timed out, resetting&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|hp-&gt;net_stats.tx_errors
op_increment
suffix:semicolon
id|happy_meal_init
c_func
(paren
id|hp
comma
l_int|0
)paren
suffix:semicolon
id|dev-&gt;tbusy
op_assign
l_int|0
suffix:semicolon
id|dev-&gt;trans_start
op_assign
id|jiffies
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|set_bit
c_func
(paren
l_int|0
comma
(paren
r_void
op_star
)paren
op_amp
id|dev-&gt;tbusy
)paren
op_ne
l_int|0
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;happy meal: Transmitter access conflict.&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|TX_BUFFS_AVAIL
c_func
(paren
id|hp
)paren
)paren
(brace
r_return
l_int|1
suffix:semicolon
)brace
id|len
op_assign
id|skb-&gt;len
suffix:semicolon
id|entry
op_assign
id|hp-&gt;tx_new
suffix:semicolon
id|SXD
c_func
(paren
(paren
l_string|&quot;SX&lt;l[%d]e[%d]&gt;&quot;
comma
id|len
comma
id|entry
)paren
)paren
suffix:semicolon
id|hp-&gt;tx_skbs
(braket
id|entry
)braket
op_assign
id|skb
suffix:semicolon
id|hp-&gt;happy_block-&gt;happy_meal_txd
(braket
id|entry
)braket
dot
id|tx_addr
op_assign
(paren
r_int
r_int
)paren
id|skb-&gt;data
suffix:semicolon
id|hp-&gt;happy_block-&gt;happy_meal_txd
(braket
id|entry
)braket
dot
id|tx_flags
op_assign
(paren
id|TXFLAG_OWN
op_or
id|TXFLAG_SOP
op_or
id|TXFLAG_EOP
op_or
(paren
id|len
op_amp
id|TXFLAG_SIZE
)paren
)paren
suffix:semicolon
id|hp-&gt;tx_new
op_assign
id|NEXT_TX
c_func
(paren
id|entry
)paren
suffix:semicolon
multiline_comment|/* Get it going. */
id|dev-&gt;trans_start
op_assign
id|jiffies
suffix:semicolon
id|hp-&gt;etxregs-&gt;tx_pnding
op_assign
id|ETX_TP_DMAWAKEUP
suffix:semicolon
r_if
c_cond
(paren
id|TX_BUFFS_AVAIL
c_func
(paren
id|hp
)paren
)paren
(brace
id|dev-&gt;tbusy
op_assign
l_int|0
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|sun4c_happy_meal_start_xmit
r_static
r_int
id|sun4c_happy_meal_start_xmit
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|device
op_star
id|dev
)paren
(brace
r_struct
id|happy_meal
op_star
id|hp
op_assign
(paren
r_struct
id|happy_meal
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_struct
id|hmeal_buffers
op_star
id|hbufs
op_assign
id|hp-&gt;sun4c_buffers
suffix:semicolon
id|__u32
id|txbuf_dvma
comma
id|hbufs_dvma
op_assign
id|hp-&gt;s4c_buf_dvma
suffix:semicolon
r_int
r_char
op_star
id|txbuf
suffix:semicolon
r_int
id|len
comma
id|entry
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;tbusy
)paren
(brace
r_int
id|tickssofar
op_assign
id|jiffies
op_minus
id|dev-&gt;trans_start
suffix:semicolon
r_if
c_cond
(paren
id|tickssofar
OL
l_int|40
)paren
(brace
r_return
l_int|1
suffix:semicolon
)brace
r_else
(brace
id|printk
(paren
l_string|&quot;%s: transmit timed out, resetting&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|hp-&gt;net_stats.tx_errors
op_increment
suffix:semicolon
id|happy_meal_init
c_func
(paren
id|hp
comma
l_int|0
)paren
suffix:semicolon
id|dev-&gt;tbusy
op_assign
l_int|0
suffix:semicolon
id|dev-&gt;trans_start
op_assign
id|jiffies
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|skb
op_eq
l_int|NULL
op_logical_or
id|skb-&gt;len
op_le
l_int|0
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%s: skb is NULL&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|dev_tint
c_func
(paren
id|dev
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|set_bit
c_func
(paren
l_int|0
comma
(paren
r_void
op_star
)paren
op_amp
id|dev-&gt;tbusy
)paren
op_ne
l_int|0
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;happy meal: Transmitter access conflict.&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|TX_BUFFS_AVAIL
c_func
(paren
id|hp
)paren
)paren
(brace
r_return
l_int|1
suffix:semicolon
)brace
id|len
op_assign
id|skb-&gt;len
suffix:semicolon
id|entry
op_assign
id|hp-&gt;tx_new
suffix:semicolon
id|txbuf
op_assign
op_amp
id|hbufs-&gt;tx_buf
(braket
id|entry
)braket
(braket
l_int|0
)braket
suffix:semicolon
id|memcpy
c_func
(paren
id|txbuf
comma
id|skb-&gt;data
comma
id|len
)paren
suffix:semicolon
id|SXD
c_func
(paren
(paren
l_string|&quot;SX&lt;l[%d]e[%d]&gt;&quot;
comma
id|len
comma
id|entry
)paren
)paren
suffix:semicolon
id|txbuf_dvma
op_assign
id|hbufs_dvma
op_plus
id|hbuf_offset
c_func
(paren
id|tx_buf
comma
id|entry
)paren
suffix:semicolon
id|hp-&gt;happy_block-&gt;happy_meal_txd
(braket
id|entry
)braket
dot
id|tx_addr
op_assign
id|txbuf_dvma
suffix:semicolon
id|hp-&gt;happy_block-&gt;happy_meal_txd
(braket
id|entry
)braket
dot
id|tx_flags
op_assign
(paren
id|TXFLAG_OWN
op_or
id|TXFLAG_SOP
op_or
id|TXFLAG_EOP
op_or
(paren
id|len
op_amp
id|TXFLAG_SIZE
)paren
)paren
suffix:semicolon
id|hp-&gt;tx_new
op_assign
id|NEXT_TX
c_func
(paren
id|entry
)paren
suffix:semicolon
multiline_comment|/* Get it going. */
id|dev-&gt;trans_start
op_assign
id|jiffies
suffix:semicolon
id|hp-&gt;etxregs-&gt;tx_pnding
op_assign
id|ETX_TP_DMAWAKEUP
suffix:semicolon
id|dev_kfree_skb
c_func
(paren
id|skb
comma
id|FREE_WRITE
)paren
suffix:semicolon
r_if
c_cond
(paren
id|TX_BUFFS_AVAIL
c_func
(paren
id|hp
)paren
)paren
(brace
id|dev-&gt;tbusy
op_assign
l_int|0
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|happy_meal_get_stats
r_static
r_struct
id|net_device_stats
op_star
id|happy_meal_get_stats
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
r_struct
id|happy_meal
op_star
id|hp
op_assign
(paren
r_struct
id|happy_meal
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|happy_meal_get_counters
c_func
(paren
id|hp
comma
id|hp-&gt;bigmacregs
)paren
suffix:semicolon
r_return
op_amp
id|hp-&gt;net_stats
suffix:semicolon
)brace
DECL|macro|CRC_POLYNOMIAL_BE
mdefine_line|#define CRC_POLYNOMIAL_BE 0x04c11db7UL  /* Ethernet CRC, big endian */
DECL|macro|CRC_POLYNOMIAL_LE
mdefine_line|#define CRC_POLYNOMIAL_LE 0xedb88320UL  /* Ethernet CRC, little endian */
DECL|function|happy_meal_set_multicast
r_static
r_void
id|happy_meal_set_multicast
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
r_struct
id|happy_meal
op_star
id|hp
op_assign
(paren
r_struct
id|happy_meal
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_struct
id|hmeal_bigmacregs
op_star
id|bregs
op_assign
id|hp-&gt;bigmacregs
suffix:semicolon
r_struct
id|dev_mc_list
op_star
id|dmi
op_assign
id|dev-&gt;mc_list
suffix:semicolon
r_char
op_star
id|addrs
suffix:semicolon
r_int
id|i
comma
id|j
comma
id|bit
comma
id|byte
suffix:semicolon
id|u32
id|crc
comma
id|poly
op_assign
id|CRC_POLYNOMIAL_LE
suffix:semicolon
multiline_comment|/* Let the transmits drain. */
r_while
c_loop
(paren
id|dev-&gt;tbusy
)paren
(brace
id|schedule
c_func
(paren
)paren
suffix:semicolon
)brace
multiline_comment|/* Lock out others. */
id|set_bit
c_func
(paren
l_int|0
comma
(paren
r_void
op_star
)paren
op_amp
id|dev-&gt;tbusy
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|dev-&gt;flags
op_amp
id|IFF_ALLMULTI
)paren
op_logical_or
(paren
id|dev-&gt;mc_count
OG
l_int|64
)paren
)paren
(brace
id|bregs-&gt;htable0
op_assign
l_int|0xffff
suffix:semicolon
id|bregs-&gt;htable1
op_assign
l_int|0xffff
suffix:semicolon
id|bregs-&gt;htable2
op_assign
l_int|0xffff
suffix:semicolon
id|bregs-&gt;htable3
op_assign
l_int|0xffff
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|dev-&gt;flags
op_amp
id|IFF_PROMISC
)paren
(brace
id|bregs-&gt;rx_cfg
op_or_assign
id|BIGMAC_RXCFG_PMISC
suffix:semicolon
)brace
r_else
(brace
id|u16
id|hash_table
(braket
l_int|4
)braket
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|4
suffix:semicolon
id|i
op_increment
)paren
(brace
id|hash_table
(braket
id|i
)braket
op_assign
l_int|0
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|dev-&gt;mc_count
suffix:semicolon
id|i
op_increment
)paren
(brace
id|addrs
op_assign
id|dmi-&gt;dmi_addr
suffix:semicolon
id|dmi
op_assign
id|dmi-&gt;next
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
op_star
id|addrs
op_amp
l_int|1
)paren
)paren
(brace
r_continue
suffix:semicolon
)brace
id|crc
op_assign
l_int|0xffffffffU
suffix:semicolon
r_for
c_loop
(paren
id|byte
op_assign
l_int|0
suffix:semicolon
id|byte
OL
l_int|6
suffix:semicolon
id|byte
op_increment
)paren
(brace
r_for
c_loop
(paren
id|bit
op_assign
op_star
id|addrs
op_increment
comma
id|j
op_assign
l_int|0
suffix:semicolon
id|j
OL
l_int|8
suffix:semicolon
id|j
op_increment
comma
id|bit
op_rshift_assign
l_int|1
)paren
(brace
r_int
id|test
suffix:semicolon
id|test
op_assign
(paren
(paren
id|bit
op_xor
id|crc
)paren
op_amp
l_int|0x01
)paren
suffix:semicolon
id|crc
op_rshift_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|test
)paren
(brace
id|crc
op_assign
id|crc
op_xor
id|poly
suffix:semicolon
)brace
)brace
)brace
id|crc
op_rshift_assign
l_int|26
suffix:semicolon
id|hash_table
(braket
id|crc
op_rshift
l_int|4
)braket
op_or_assign
l_int|1
op_lshift
(paren
id|crc
op_amp
l_int|0xf
)paren
suffix:semicolon
)brace
id|bregs-&gt;htable0
op_assign
id|hash_table
(braket
l_int|0
)braket
suffix:semicolon
id|bregs-&gt;htable1
op_assign
id|hash_table
(braket
l_int|1
)braket
suffix:semicolon
id|bregs-&gt;htable2
op_assign
id|hash_table
(braket
l_int|2
)braket
suffix:semicolon
id|bregs-&gt;htable3
op_assign
id|hash_table
(braket
l_int|3
)braket
suffix:semicolon
)brace
multiline_comment|/* Let us get going again. */
id|dev-&gt;tbusy
op_assign
l_int|0
suffix:semicolon
)brace
DECL|function|happy_meal_ether_init
r_static
r_inline
r_int
id|happy_meal_ether_init
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
r_struct
id|linux_sbus_device
op_star
id|sdev
)paren
(brace
r_static
r_int
id|version_printed
op_assign
l_int|0
suffix:semicolon
r_struct
id|happy_meal
op_star
id|hp
suffix:semicolon
r_int
id|i
suffix:semicolon
r_if
c_cond
(paren
id|dev
op_eq
l_int|NULL
)paren
(brace
id|dev
op_assign
id|init_etherdev
c_func
(paren
l_int|0
comma
r_sizeof
(paren
r_struct
id|happy_meal
)paren
)paren
suffix:semicolon
)brace
r_else
(brace
id|dev-&gt;priv
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|happy_meal
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;priv
op_eq
l_int|NULL
)paren
(brace
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|version_printed
op_increment
op_eq
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|version
)paren
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;%s: HAPPY MEAL 10/100baseT Ethernet &quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|dev-&gt;base_addr
op_assign
(paren
r_int
)paren
id|sdev
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|6
suffix:semicolon
id|i
op_increment
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%2.2x%c&quot;
comma
id|dev-&gt;dev_addr
(braket
id|i
)braket
op_assign
id|idprom-&gt;id_ethaddr
(braket
id|i
)braket
comma
id|i
op_eq
l_int|5
ques
c_cond
l_char|&squot; &squot;
suffix:colon
l_char|&squot;:&squot;
)paren
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
id|hp
op_assign
(paren
r_struct
id|happy_meal
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|hp-&gt;happy_sbus_dev
op_assign
id|sdev
suffix:semicolon
r_if
c_cond
(paren
id|sdev-&gt;num_registers
op_ne
l_int|5
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;happymeal: Device does not have 5 regs, it has %d.&bslash;n&quot;
comma
id|sdev-&gt;num_registers
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;happymeal: Would you like that for here or to go?&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|ENODEV
suffix:semicolon
)brace
id|prom_apply_sbus_ranges
c_func
(paren
id|sdev-&gt;my_bus
comma
op_amp
id|sdev-&gt;reg_addrs
(braket
l_int|0
)braket
comma
id|sdev-&gt;num_registers
comma
id|sdev
)paren
suffix:semicolon
id|hp-&gt;gregs
op_assign
id|sparc_alloc_io
c_func
(paren
id|sdev-&gt;reg_addrs
(braket
l_int|0
)braket
dot
id|phys_addr
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|hmeal_gregs
)paren
comma
l_string|&quot;Happy Meal Global Regs&quot;
comma
id|sdev-&gt;reg_addrs
(braket
l_int|0
)braket
dot
id|which_io
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|hp-&gt;gregs
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;happymeal: Cannot map Happy Meal global registers.&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|ENODEV
suffix:semicolon
)brace
id|hp-&gt;etxregs
op_assign
id|sparc_alloc_io
c_func
(paren
id|sdev-&gt;reg_addrs
(braket
l_int|1
)braket
dot
id|phys_addr
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|hmeal_etxregs
)paren
comma
l_string|&quot;Happy Meal MAC TX Regs&quot;
comma
id|sdev-&gt;reg_addrs
(braket
l_int|1
)braket
dot
id|which_io
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|hp-&gt;etxregs
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;happymeal: Cannot map Happy Meal MAC Transmit registers.&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|ENODEV
suffix:semicolon
)brace
id|hp-&gt;erxregs
op_assign
id|sparc_alloc_io
c_func
(paren
id|sdev-&gt;reg_addrs
(braket
l_int|2
)braket
dot
id|phys_addr
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|hmeal_erxregs
)paren
comma
l_string|&quot;Happy Meal MAC RX Regs&quot;
comma
id|sdev-&gt;reg_addrs
(braket
l_int|2
)braket
dot
id|which_io
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|hp-&gt;erxregs
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;happymeal: Cannot map Happy Meal MAC Receive registers.&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|ENODEV
suffix:semicolon
)brace
id|hp-&gt;bigmacregs
op_assign
id|sparc_alloc_io
c_func
(paren
id|sdev-&gt;reg_addrs
(braket
l_int|3
)braket
dot
id|phys_addr
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|hmeal_bigmacregs
)paren
comma
l_string|&quot;Happy Meal BIGMAC Regs&quot;
comma
id|sdev-&gt;reg_addrs
(braket
l_int|3
)braket
dot
id|which_io
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|hp-&gt;bigmacregs
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;happymeal: Cannot map Happy Meal BIGMAC registers.&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|ENODEV
suffix:semicolon
)brace
id|hp-&gt;tcvregs
op_assign
id|sparc_alloc_io
c_func
(paren
id|sdev-&gt;reg_addrs
(braket
l_int|4
)braket
dot
id|phys_addr
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|hmeal_tcvregs
)paren
comma
l_string|&quot;Happy Meal Tranceiver Regs&quot;
comma
id|sdev-&gt;reg_addrs
(braket
l_int|4
)braket
dot
id|which_io
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|hp-&gt;tcvregs
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;happymeal: Cannot map Happy Meal Tranceiver registers.&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|ENODEV
suffix:semicolon
)brace
id|hp-&gt;hm_revision
op_assign
id|prom_getintdefault
c_func
(paren
id|sdev-&gt;prom_node
comma
l_string|&quot;hm-rev&quot;
comma
l_int|0xff
)paren
suffix:semicolon
r_if
c_cond
(paren
id|hp-&gt;hm_revision
op_eq
l_int|0xff
)paren
(brace
id|hp-&gt;hm_revision
op_assign
l_int|0xa0
suffix:semicolon
)brace
multiline_comment|/* Now enable the feature flags we can. */
r_if
c_cond
(paren
id|hp-&gt;hm_revision
op_eq
l_int|0x20
op_logical_or
id|hp-&gt;hm_revision
op_eq
l_int|0x21
)paren
(brace
id|hp-&gt;happy_flags
op_assign
id|HFLAG_20_21
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|hp-&gt;hm_revision
op_ne
l_int|0xa0
)paren
(brace
id|hp-&gt;happy_flags
op_assign
id|HFLAG_NOT_A0
suffix:semicolon
)brace
multiline_comment|/* Get the supported DVMA burst sizes from our Happy SBUS. */
id|hp-&gt;happy_bursts
op_assign
id|prom_getintdefault
c_func
(paren
id|hp-&gt;happy_sbus_dev-&gt;my_bus-&gt;prom_node
comma
l_string|&quot;burst-sizes&quot;
comma
l_int|0x00
)paren
suffix:semicolon
id|hp-&gt;happy_block
op_assign
(paren
r_struct
id|hmeal_init_block
op_star
)paren
id|sparc_dvma_malloc
c_func
(paren
id|PAGE_SIZE
comma
l_string|&quot;Happy Meal Init Block&quot;
comma
op_amp
id|hp-&gt;hblock_dvma
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sparc_cpu_model
op_eq
id|sun4c
)paren
(brace
id|hp-&gt;sun4c_buffers
op_assign
(paren
r_struct
id|hmeal_buffers
op_star
)paren
id|sparc_dvma_malloc
c_func
(paren
r_sizeof
(paren
r_struct
id|hmeal_buffers
)paren
comma
l_string|&quot;Happy Meal Bufs&quot;
comma
op_amp
id|hp-&gt;s4c_buf_dvma
)paren
suffix:semicolon
)brace
r_else
id|hp-&gt;sun4c_buffers
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Force check of the link first time we are brought up. */
id|hp-&gt;linkcheck
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Force timer state to &squot;asleep&squot; with count of zero. */
id|hp-&gt;timer_state
op_assign
id|asleep
suffix:semicolon
id|hp-&gt;timer_ticks
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Grrr, Happy Meal comes up by default not advertising&n;&t; * full duplex 100baseT capabilities, fix this.&n;&t; */
id|happy_meal_set_initial_advertisement
c_func
(paren
id|hp
)paren
suffix:semicolon
id|hp-&gt;dev
op_assign
id|dev
suffix:semicolon
id|dev-&gt;open
op_assign
op_amp
id|happy_meal_open
suffix:semicolon
id|dev-&gt;stop
op_assign
op_amp
id|happy_meal_close
suffix:semicolon
r_if
c_cond
(paren
id|sparc_cpu_model
op_eq
id|sun4c
)paren
(brace
id|dev-&gt;hard_start_xmit
op_assign
op_amp
id|sun4c_happy_meal_start_xmit
suffix:semicolon
)brace
r_else
id|dev-&gt;hard_start_xmit
op_assign
op_amp
id|happy_meal_start_xmit
suffix:semicolon
id|dev-&gt;get_stats
op_assign
op_amp
id|happy_meal_get_stats
suffix:semicolon
id|dev-&gt;set_multicast_list
op_assign
op_amp
id|happy_meal_set_multicast
suffix:semicolon
id|dev-&gt;irq
op_assign
(paren
r_int
r_char
)paren
id|sdev-&gt;irqs
(braket
l_int|0
)braket
dot
id|pri
suffix:semicolon
id|dev-&gt;dma
op_assign
l_int|0
suffix:semicolon
id|ether_setup
c_func
(paren
id|dev
)paren
suffix:semicolon
macro_line|#ifdef MODULE
multiline_comment|/* We are home free at this point, link us in to the happy&n;&t; * module device list.&n;&t; */
id|dev-&gt;ifindex
op_assign
id|dev_new_index
c_func
(paren
)paren
suffix:semicolon
id|hp-&gt;next_module
op_assign
id|root_happy_dev
suffix:semicolon
id|root_happy_dev
op_assign
id|hp
suffix:semicolon
macro_line|#endif
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|__initfunc
id|__initfunc
c_func
(paren
r_int
id|happy_meal_probe
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
)paren
(brace
r_struct
id|linux_sbus
op_star
id|bus
suffix:semicolon
r_struct
id|linux_sbus_device
op_star
id|sdev
op_assign
l_int|0
suffix:semicolon
r_static
r_int
id|called
op_assign
l_int|0
suffix:semicolon
r_int
id|cards
op_assign
l_int|0
comma
id|v
suffix:semicolon
r_if
c_cond
(paren
id|called
)paren
(brace
r_return
id|ENODEV
suffix:semicolon
)brace
id|called
op_increment
suffix:semicolon
id|for_each_sbus
c_func
(paren
id|bus
)paren
(brace
id|for_each_sbusdev
c_func
(paren
id|sdev
comma
id|bus
)paren
(brace
r_if
c_cond
(paren
id|cards
)paren
(brace
id|dev
op_assign
l_int|NULL
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|strcmp
c_func
(paren
id|sdev-&gt;prom_name
comma
l_string|&quot;SUNW,hme&quot;
)paren
)paren
(brace
id|cards
op_increment
suffix:semicolon
r_if
c_cond
(paren
(paren
id|v
op_assign
id|happy_meal_ether_init
c_func
(paren
id|dev
comma
id|sdev
)paren
)paren
)paren
(brace
r_return
id|v
suffix:semicolon
)brace
)brace
)brace
)brace
r_if
c_cond
(paren
op_logical_neg
id|cards
)paren
(brace
r_return
id|ENODEV
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#ifdef MODULE
r_int
DECL|function|init_module
id|init_module
c_func
(paren
r_void
)paren
(brace
id|root_happy_dev
op_assign
l_int|NULL
suffix:semicolon
r_return
id|happy_meal_probe
c_func
(paren
l_int|NULL
)paren
suffix:semicolon
)brace
r_void
DECL|function|cleanup_module
id|cleanup_module
c_func
(paren
r_void
)paren
(brace
r_struct
id|happy_meal
op_star
id|sunshine
suffix:semicolon
multiline_comment|/* No need to check MOD_IN_USE, as sys_delete_module() checks. */
r_while
c_loop
(paren
id|root_happy_dev
)paren
(brace
r_struct
id|happy_meal
op_star
id|hp
op_assign
id|root_happy_dev
suffix:semicolon
id|sunshine
op_assign
id|root_happy_dev-&gt;next_module
suffix:semicolon
id|sparc_free_io
c_func
(paren
id|hp-&gt;gregs
comma
r_sizeof
(paren
r_struct
id|hmeal_gregs
)paren
)paren
suffix:semicolon
id|sparc_free_io
c_func
(paren
id|hp-&gt;etxregs
comma
r_sizeof
(paren
r_struct
id|hmeal_etxregs
)paren
)paren
suffix:semicolon
id|sparc_free_io
c_func
(paren
id|hp-&gt;erxregs
comma
r_sizeof
(paren
r_struct
id|hmeal_erxregs
)paren
)paren
suffix:semicolon
id|sparc_free_io
c_func
(paren
id|hp-&gt;bigmacregs
comma
r_sizeof
(paren
r_struct
id|hmeal_bigmacregs
)paren
)paren
suffix:semicolon
id|sparc_free_io
c_func
(paren
id|hp-&gt;tcvregs
comma
r_sizeof
(paren
r_struct
id|hmeal_tcvregs
)paren
)paren
suffix:semicolon
id|unregister_netdev
c_func
(paren
id|hp-&gt;dev
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|hp-&gt;dev
)paren
suffix:semicolon
id|root_happy_dev
op_assign
id|sunshine
suffix:semicolon
)brace
)brace
macro_line|#endif /* MODULE */
eof
