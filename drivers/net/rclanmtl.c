multiline_comment|/*&n;** *************************************************************************&n;**&n;**&n;**     R C L A N M T L . C             $Revision: 6 $&n;**&n;**&n;**  RedCreek I2O LAN Message Transport Layer program module.&n;**&n;**  ---------------------------------------------------------------------&n;**  ---     Copyright (c) 1997-1999, RedCreek Communications Inc.     ---&n;**  ---                   All rights reserved.                        ---&n;**  ---------------------------------------------------------------------&n;**&n;**  File Description:&n;**&n;**  Host side I2O (Intelligent I/O) LAN message transport layer.&n;**&n;**  This program is free software; you can redistribute it and/or modify&n;**  it under the terms of the GNU General Public License as published by&n;**  the Free Software Foundation; either version 2 of the License, or&n;**  (at your option) any later version.&n;&n;**  This program is distributed in the hope that it will be useful,&n;**  but WITHOUT ANY WARRANTY; without even the implied warranty of&n;**  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the&n;**  GNU General Public License for more details.&n;&n;**  You should have received a copy of the GNU General Public License&n;**  along with this program; if not, write to the Free Software&n;**  Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.&n;**&n;** 1998-1999, LAN API was modified and enhanced by Alice Hennessy.&n;**&n;** Sometime in 1997, LAN API was written from scratch by Wendell Nichols.&n;** *************************************************************************&n;*/
DECL|macro|DEBUG
macro_line|#undef DEBUG
DECL|macro|RC_LINUX_MODULE
mdefine_line|#define RC_LINUX_MODULE
macro_line|#include &quot;rclanmtl.h&quot;
DECL|macro|dprintf
mdefine_line|#define dprintf kprintf
r_extern
r_int
id|printk
c_func
(paren
r_const
r_char
op_star
id|fmt
comma
dot
dot
dot
)paren
suffix:semicolon
multiline_comment|/* RedCreek LAN device Target ID */
DECL|macro|RC_LAN_TARGET_ID
mdefine_line|#define RC_LAN_TARGET_ID  0x10 
multiline_comment|/* RedCreek&squot;s OSM default LAN receive Initiator */
DECL|macro|DEFAULT_RECV_INIT_CONTEXT
mdefine_line|#define DEFAULT_RECV_INIT_CONTEXT  0xA17  
multiline_comment|/*&n;** I2O message structures&n;*/
DECL|macro|I2O_TID_SZ
mdefine_line|#define    I2O_TID_SZ                                  12
DECL|macro|I2O_FUNCTION_SZ
mdefine_line|#define    I2O_FUNCTION_SZ                             8
multiline_comment|/* Transaction Reply Lists (TRL) Control Word structure */
DECL|macro|I2O_TRL_FLAGS_SINGLE_FIXED_LENGTH
mdefine_line|#define    I2O_TRL_FLAGS_SINGLE_FIXED_LENGTH           0x00
DECL|macro|I2O_TRL_FLAGS_SINGLE_VARIABLE_LENGTH
mdefine_line|#define    I2O_TRL_FLAGS_SINGLE_VARIABLE_LENGTH        0x40
DECL|macro|I2O_TRL_FLAGS_MULTIPLE_FIXED_LENGTH
mdefine_line|#define    I2O_TRL_FLAGS_MULTIPLE_FIXED_LENGTH         0x80
multiline_comment|/* LAN Class specific functions */
DECL|macro|I2O_LAN_PACKET_SEND
mdefine_line|#define    I2O_LAN_PACKET_SEND                         0x3B
DECL|macro|I2O_LAN_SDU_SEND
mdefine_line|#define    I2O_LAN_SDU_SEND                            0x3D
DECL|macro|I2O_LAN_RECEIVE_POST
mdefine_line|#define    I2O_LAN_RECEIVE_POST                        0x3E
DECL|macro|I2O_LAN_RESET
mdefine_line|#define    I2O_LAN_RESET                               0x35
DECL|macro|I2O_LAN_SHUTDOWN
mdefine_line|#define    I2O_LAN_SHUTDOWN                            0x37
multiline_comment|/* Private Class specfic function */
DECL|macro|I2O_PRIVATE
mdefine_line|#define    I2O_PRIVATE                                 0xFF
multiline_comment|/*  I2O Executive Function Codes.  */
DECL|macro|I2O_EXEC_ADAPTER_ASSIGN
mdefine_line|#define    I2O_EXEC_ADAPTER_ASSIGN                     0xB3
DECL|macro|I2O_EXEC_ADAPTER_READ
mdefine_line|#define    I2O_EXEC_ADAPTER_READ                       0xB2
DECL|macro|I2O_EXEC_ADAPTER_RELEASE
mdefine_line|#define    I2O_EXEC_ADAPTER_RELEASE                    0xB5
DECL|macro|I2O_EXEC_BIOS_INFO_SET
mdefine_line|#define    I2O_EXEC_BIOS_INFO_SET                      0xA5
DECL|macro|I2O_EXEC_BOOT_DEVICE_SET
mdefine_line|#define    I2O_EXEC_BOOT_DEVICE_SET                    0xA7
DECL|macro|I2O_EXEC_CONFIG_VALIDATE
mdefine_line|#define    I2O_EXEC_CONFIG_VALIDATE                    0xBB
DECL|macro|I2O_EXEC_CONN_SETUP
mdefine_line|#define    I2O_EXEC_CONN_SETUP                         0xCA
DECL|macro|I2O_EXEC_DEVICE_ASSIGN
mdefine_line|#define    I2O_EXEC_DEVICE_ASSIGN                      0xB7
DECL|macro|I2O_EXEC_DEVICE_RELEASE
mdefine_line|#define    I2O_EXEC_DEVICE_RELEASE                     0xB9
DECL|macro|I2O_EXEC_HRT_GET
mdefine_line|#define    I2O_EXEC_HRT_GET                            0xA8
DECL|macro|I2O_EXEC_IOP_CLEAR
mdefine_line|#define    I2O_EXEC_IOP_CLEAR                          0xBE
DECL|macro|I2O_EXEC_IOP_CONNECT
mdefine_line|#define    I2O_EXEC_IOP_CONNECT                        0xC9
DECL|macro|I2O_EXEC_IOP_RESET
mdefine_line|#define    I2O_EXEC_IOP_RESET                          0xBD
DECL|macro|I2O_EXEC_LCT_NOTIFY
mdefine_line|#define    I2O_EXEC_LCT_NOTIFY                         0xA2
DECL|macro|I2O_EXEC_OUTBOUND_INIT
mdefine_line|#define    I2O_EXEC_OUTBOUND_INIT                      0xA1
DECL|macro|I2O_EXEC_PATH_ENABLE
mdefine_line|#define    I2O_EXEC_PATH_ENABLE                        0xD3
DECL|macro|I2O_EXEC_PATH_QUIESCE
mdefine_line|#define    I2O_EXEC_PATH_QUIESCE                       0xC5
DECL|macro|I2O_EXEC_PATH_RESET
mdefine_line|#define    I2O_EXEC_PATH_RESET                         0xD7
DECL|macro|I2O_EXEC_STATIC_MF_CREATE
mdefine_line|#define    I2O_EXEC_STATIC_MF_CREATE                   0xDD
DECL|macro|I2O_EXEC_STATIC_MF_RELEASE
mdefine_line|#define    I2O_EXEC_STATIC_MF_RELEASE                  0xDF
DECL|macro|I2O_EXEC_STATUS_GET
mdefine_line|#define    I2O_EXEC_STATUS_GET                         0xA0
DECL|macro|I2O_EXEC_SW_DOWNLOAD
mdefine_line|#define    I2O_EXEC_SW_DOWNLOAD                        0xA9
DECL|macro|I2O_EXEC_SW_UPLOAD
mdefine_line|#define    I2O_EXEC_SW_UPLOAD                          0xAB
DECL|macro|I2O_EXEC_SW_REMOVE
mdefine_line|#define    I2O_EXEC_SW_REMOVE                          0xAD
DECL|macro|I2O_EXEC_SYS_ENABLE
mdefine_line|#define    I2O_EXEC_SYS_ENABLE                         0xD1
DECL|macro|I2O_EXEC_SYS_MODIFY
mdefine_line|#define    I2O_EXEC_SYS_MODIFY                         0xC1
DECL|macro|I2O_EXEC_SYS_QUIESCE
mdefine_line|#define    I2O_EXEC_SYS_QUIESCE                        0xC3
DECL|macro|I2O_EXEC_SYS_TAB_SET
mdefine_line|#define    I2O_EXEC_SYS_TAB_SET                        0xA3
multiline_comment|/* Init Outbound Q status */
DECL|macro|I2O_EXEC_OUTBOUND_INIT_IN_PROGRESS
mdefine_line|#define    I2O_EXEC_OUTBOUND_INIT_IN_PROGRESS          0x01
DECL|macro|I2O_EXEC_OUTBOUND_INIT_REJECTED
mdefine_line|#define    I2O_EXEC_OUTBOUND_INIT_REJECTED             0x02
DECL|macro|I2O_EXEC_OUTBOUND_INIT_FAILED
mdefine_line|#define    I2O_EXEC_OUTBOUND_INIT_FAILED               0x03
DECL|macro|I2O_EXEC_OUTBOUND_INIT_COMPLETE
mdefine_line|#define    I2O_EXEC_OUTBOUND_INIT_COMPLETE             0x04
DECL|macro|I2O_UTIL_NOP
mdefine_line|#define    I2O_UTIL_NOP                                0x00
multiline_comment|/* I2O Get Status State values */
DECL|macro|I2O_IOP_STATE_INITIALIZING
mdefine_line|#define    I2O_IOP_STATE_INITIALIZING                  0x01
DECL|macro|I2O_IOP_STATE_RESET
mdefine_line|#define    I2O_IOP_STATE_RESET                         0x02
DECL|macro|I2O_IOP_STATE_HOLD
mdefine_line|#define    I2O_IOP_STATE_HOLD                          0x04
DECL|macro|I2O_IOP_STATE_READY
mdefine_line|#define    I2O_IOP_STATE_READY                         0x05
DECL|macro|I2O_IOP_STATE_OPERATIONAL
mdefine_line|#define    I2O_IOP_STATE_OPERATIONAL                   0x08
DECL|macro|I2O_IOP_STATE_FAILED
mdefine_line|#define    I2O_IOP_STATE_FAILED                        0x10
DECL|macro|I2O_IOP_STATE_FAULTED
mdefine_line|#define    I2O_IOP_STATE_FAULTED                       0x11
multiline_comment|/* Defines for Request Status Codes:  Table 3-1 Reply Status Codes.  */
DECL|macro|I2O_REPLY_STATUS_SUCCESS
mdefine_line|#define    I2O_REPLY_STATUS_SUCCESS                    0x00
DECL|macro|I2O_REPLY_STATUS_ABORT_DIRTY
mdefine_line|#define    I2O_REPLY_STATUS_ABORT_DIRTY                0x01
DECL|macro|I2O_REPLY_STATUS_ABORT_NO_DATA_TRANSFER
mdefine_line|#define    I2O_REPLY_STATUS_ABORT_NO_DATA_TRANSFER     0x02
DECL|macro|I2O_REPLY_STATUS_ABORT_PARTIAL_TRANSFER
mdefine_line|#define    I2O_REPLY_STATUS_ABORT_PARTIAL_TRANSFER     0x03
DECL|macro|I2O_REPLY_STATUS_ERROR_DIRTY
mdefine_line|#define    I2O_REPLY_STATUS_ERROR_DIRTY                0x04
DECL|macro|I2O_REPLY_STATUS_ERROR_NO_DATA_TRANSFER
mdefine_line|#define    I2O_REPLY_STATUS_ERROR_NO_DATA_TRANSFER     0x05
DECL|macro|I2O_REPLY_STATUS_ERROR_PARTIAL_TRANSFER
mdefine_line|#define    I2O_REPLY_STATUS_ERROR_PARTIAL_TRANSFER     0x06
DECL|macro|I2O_REPLY_STATUS_PROCESS_ABORT_DIRTY
mdefine_line|#define    I2O_REPLY_STATUS_PROCESS_ABORT_DIRTY        0x07
DECL|macro|I2O_REPLY_STATUS_PROCESS_ABORT_NO_DATA_TRANSFER
mdefine_line|#define    I2O_REPLY_STATUS_PROCESS_ABORT_NO_DATA_TRANSFER   0x08
DECL|macro|I2O_REPLY_STATUS_PROCESS_ABORT_PARTIAL_TRANSFER
mdefine_line|#define    I2O_REPLY_STATUS_PROCESS_ABORT_PARTIAL_TRANSFER   0x09
DECL|macro|I2O_REPLY_STATUS_TRANSACTION_ERROR
mdefine_line|#define    I2O_REPLY_STATUS_TRANSACTION_ERROR          0x0A
DECL|macro|I2O_REPLY_STATUS_PROGRESS_REPORT
mdefine_line|#define    I2O_REPLY_STATUS_PROGRESS_REPORT            0x80
multiline_comment|/* DetailedStatusCode defines for ALL messages: Table 3-2 Detailed Status Codes.*/
DECL|macro|I2O_DETAIL_STATUS_SUCCESS
mdefine_line|#define    I2O_DETAIL_STATUS_SUCCESS                        0x0000
DECL|macro|I2O_DETAIL_STATUS_BAD_KEY
mdefine_line|#define    I2O_DETAIL_STATUS_BAD_KEY                        0x0001
DECL|macro|I2O_DETAIL_STATUS_CHAIN_BUFFER_TOO_LARGE
mdefine_line|#define    I2O_DETAIL_STATUS_CHAIN_BUFFER_TOO_LARGE         0x0002
DECL|macro|I2O_DETAIL_STATUS_DEVICE_BUSY
mdefine_line|#define    I2O_DETAIL_STATUS_DEVICE_BUSY                    0x0003
DECL|macro|I2O_DETAIL_STATUS_DEVICE_LOCKED
mdefine_line|#define    I2O_DETAIL_STATUS_DEVICE_LOCKED                  0x0004
DECL|macro|I2O_DETAIL_STATUS_DEVICE_NOT_AVAILABLE
mdefine_line|#define    I2O_DETAIL_STATUS_DEVICE_NOT_AVAILABLE           0x0005
DECL|macro|I2O_DETAIL_STATUS_DEVICE_RESET
mdefine_line|#define    I2O_DETAIL_STATUS_DEVICE_RESET                   0x0006
DECL|macro|I2O_DETAIL_STATUS_INAPPROPRIATE_FUNCTION
mdefine_line|#define    I2O_DETAIL_STATUS_INAPPROPRIATE_FUNCTION         0x0007
DECL|macro|I2O_DETAIL_STATUS_INSUFFICIENT_RESOURCE_HARD
mdefine_line|#define    I2O_DETAIL_STATUS_INSUFFICIENT_RESOURCE_HARD     0x0008
DECL|macro|I2O_DETAIL_STATUS_INSUFFICIENT_RESOURCE_SOFT
mdefine_line|#define    I2O_DETAIL_STATUS_INSUFFICIENT_RESOURCE_SOFT     0x0009
DECL|macro|I2O_DETAIL_STATUS_INVALID_INITIATOR_ADDRESS
mdefine_line|#define    I2O_DETAIL_STATUS_INVALID_INITIATOR_ADDRESS      0x000A
DECL|macro|I2O_DETAIL_STATUS_INVALID_MESSAGE_FLAGS
mdefine_line|#define    I2O_DETAIL_STATUS_INVALID_MESSAGE_FLAGS          0x000B
DECL|macro|I2O_DETAIL_STATUS_INVALID_OFFSET
mdefine_line|#define    I2O_DETAIL_STATUS_INVALID_OFFSET                 0x000C
DECL|macro|I2O_DETAIL_STATUS_INVALID_PARAMETER
mdefine_line|#define    I2O_DETAIL_STATUS_INVALID_PARAMETER              0x000D
DECL|macro|I2O_DETAIL_STATUS_INVALID_REQUEST
mdefine_line|#define    I2O_DETAIL_STATUS_INVALID_REQUEST                0x000E
DECL|macro|I2O_DETAIL_STATUS_INVALID_TARGET_ADDRESS
mdefine_line|#define    I2O_DETAIL_STATUS_INVALID_TARGET_ADDRESS         0x000F
DECL|macro|I2O_DETAIL_STATUS_MESSAGE_TOO_LARGE
mdefine_line|#define    I2O_DETAIL_STATUS_MESSAGE_TOO_LARGE              0x0010
DECL|macro|I2O_DETAIL_STATUS_MESSAGE_TOO_SMALL
mdefine_line|#define    I2O_DETAIL_STATUS_MESSAGE_TOO_SMALL              0x0011
DECL|macro|I2O_DETAIL_STATUS_MISSING_PARAMETER
mdefine_line|#define    I2O_DETAIL_STATUS_MISSING_PARAMETER              0x0012
DECL|macro|I2O_DETAIL_STATUS_NO_SUCH_PAGE
mdefine_line|#define    I2O_DETAIL_STATUS_NO_SUCH_PAGE                   0x0013
DECL|macro|I2O_DETAIL_STATUS_REPLY_BUFFER_FULL
mdefine_line|#define    I2O_DETAIL_STATUS_REPLY_BUFFER_FULL              0x0014
DECL|macro|I2O_DETAIL_STATUS_TCL_ERROR
mdefine_line|#define    I2O_DETAIL_STATUS_TCL_ERROR                      0x0015
DECL|macro|I2O_DETAIL_STATUS_TIMEOUT
mdefine_line|#define    I2O_DETAIL_STATUS_TIMEOUT                        0x0016
DECL|macro|I2O_DETAIL_STATUS_UNKNOWN_ERROR
mdefine_line|#define    I2O_DETAIL_STATUS_UNKNOWN_ERROR                  0x0017
DECL|macro|I2O_DETAIL_STATUS_UNKNOWN_FUNCTION
mdefine_line|#define    I2O_DETAIL_STATUS_UNKNOWN_FUNCTION               0x0018
DECL|macro|I2O_DETAIL_STATUS_UNSUPPORTED_FUNCTION
mdefine_line|#define    I2O_DETAIL_STATUS_UNSUPPORTED_FUNCTION           0x0019
DECL|macro|I2O_DETAIL_STATUS_UNSUPPORTED_VERSION
mdefine_line|#define    I2O_DETAIL_STATUS_UNSUPPORTED_VERSION            0x001A
multiline_comment|/* I2O msg header defines for VersionOffset */
DECL|macro|I2OMSGVER_1_5
mdefine_line|#define I2OMSGVER_1_5   0x0001
DECL|macro|SGL_OFFSET_0
mdefine_line|#define SGL_OFFSET_0    I2OMSGVER_1_5
DECL|macro|SGL_OFFSET_4
mdefine_line|#define SGL_OFFSET_4    (0x0040 | I2OMSGVER_1_5)
DECL|macro|TRL_OFFSET_5
mdefine_line|#define TRL_OFFSET_5    (0x0050 | I2OMSGVER_1_5)
DECL|macro|TRL_OFFSET_6
mdefine_line|#define TRL_OFFSET_6    (0x0060 | I2OMSGVER_1_5)
multiline_comment|/* I2O msg header defines for MsgFlags */
DECL|macro|MSG_STATIC
mdefine_line|#define MSG_STATIC      0x0100
DECL|macro|MSG_64BIT_CNTXT
mdefine_line|#define MSG_64BIT_CNTXT 0x0200
DECL|macro|MSG_MULTI_TRANS
mdefine_line|#define MSG_MULTI_TRANS 0x1000
DECL|macro|MSG_FAIL
mdefine_line|#define MSG_FAIL        0x2000
DECL|macro|MSG_LAST
mdefine_line|#define MSG_LAST        0x4000
DECL|macro|MSG_REPLY
mdefine_line|#define MSG_REPLY       0x8000
multiline_comment|/* normal LAN request message MsgFlags and VersionOffset (0x1041) */
DECL|macro|LAN_MSG_REQST
mdefine_line|#define LAN_MSG_REQST  (MSG_MULTI_TRANS | SGL_OFFSET_4)
multiline_comment|/* minimum size msg */
DECL|macro|THREE_WORD_MSG_SIZE
mdefine_line|#define THREE_WORD_MSG_SIZE 0x00030000
DECL|macro|FOUR_WORD_MSG_SIZE
mdefine_line|#define FOUR_WORD_MSG_SIZE  0x00040000
DECL|macro|FIVE_WORD_MSG_SIZE
mdefine_line|#define FIVE_WORD_MSG_SIZE  0x00050000
DECL|macro|SIX_WORD_MSG_SIZE
mdefine_line|#define SIX_WORD_MSG_SIZE   0x00060000
DECL|macro|SEVEN_WORD_MSG_SIZE
mdefine_line|#define SEVEN_WORD_MSG_SIZE 0x00070000
DECL|macro|EIGHT_WORD_MSG_SIZE
mdefine_line|#define EIGHT_WORD_MSG_SIZE 0x00080000
DECL|macro|NINE_WORD_MSG_SIZE
mdefine_line|#define NINE_WORD_MSG_SIZE  0x00090000
multiline_comment|/* Special TID Assignments */
DECL|macro|I2O_IOP_TID
mdefine_line|#define I2O_IOP_TID   0
DECL|macro|I2O_HOST_TID
mdefine_line|#define I2O_HOST_TID  0xB91
multiline_comment|/* RedCreek I2O private message codes */
DECL|macro|RC_PRIVATE_GET_MAC_ADDR
mdefine_line|#define RC_PRIVATE_GET_MAC_ADDR     0x0001/**/ /* OBSOLETE */
DECL|macro|RC_PRIVATE_SET_MAC_ADDR
mdefine_line|#define RC_PRIVATE_SET_MAC_ADDR     0x0002
DECL|macro|RC_PRIVATE_GET_NIC_STATS
mdefine_line|#define RC_PRIVATE_GET_NIC_STATS    0x0003
DECL|macro|RC_PRIVATE_GET_LINK_STATUS
mdefine_line|#define RC_PRIVATE_GET_LINK_STATUS  0x0004
DECL|macro|RC_PRIVATE_SET_LINK_SPEED
mdefine_line|#define RC_PRIVATE_SET_LINK_SPEED   0x0005
DECL|macro|RC_PRIVATE_SET_IP_AND_MASK
mdefine_line|#define RC_PRIVATE_SET_IP_AND_MASK  0x0006
multiline_comment|/* #define RC_PRIVATE_GET_IP_AND_MASK  0x0007 */
multiline_comment|/* OBSOLETE */
DECL|macro|RC_PRIVATE_GET_LINK_SPEED
mdefine_line|#define RC_PRIVATE_GET_LINK_SPEED   0x0008
DECL|macro|RC_PRIVATE_GET_FIRMWARE_REV
mdefine_line|#define RC_PRIVATE_GET_FIRMWARE_REV 0x0009
multiline_comment|/* #define RC_PRIVATE_GET_MAC_ADDR     0x000A */
multiline_comment|/**/
DECL|macro|RC_PRIVATE_GET_IP_AND_MASK
mdefine_line|#define RC_PRIVATE_GET_IP_AND_MASK  0x000B /**/
DECL|macro|RC_PRIVATE_DEBUG_MSG
mdefine_line|#define RC_PRIVATE_DEBUG_MSG        0x000C
DECL|macro|RC_PRIVATE_REPORT_DRIVER_CAPABILITY
mdefine_line|#define RC_PRIVATE_REPORT_DRIVER_CAPABILITY  0x000D
DECL|macro|RC_PRIVATE_SET_PROMISCUOUS_MODE
mdefine_line|#define RC_PRIVATE_SET_PROMISCUOUS_MODE  0x000e
DECL|macro|RC_PRIVATE_GET_PROMISCUOUS_MODE
mdefine_line|#define RC_PRIVATE_GET_PROMISCUOUS_MODE  0x000f
DECL|macro|RC_PRIVATE_SET_BROADCAST_MODE
mdefine_line|#define RC_PRIVATE_SET_BROADCAST_MODE    0x0010
DECL|macro|RC_PRIVATE_GET_BROADCAST_MODE
mdefine_line|#define RC_PRIVATE_GET_BROADCAST_MODE    0x0011
DECL|macro|RC_PRIVATE_REBOOT
mdefine_line|#define RC_PRIVATE_REBOOT           0x00FF
multiline_comment|/* I2O message header */
DECL|struct|_I2O_MESSAGE_FRAME
r_typedef
r_struct
id|_I2O_MESSAGE_FRAME
(brace
DECL|member|VersionOffset
id|U8
id|VersionOffset
suffix:semicolon
DECL|member|MsgFlags
id|U8
id|MsgFlags
suffix:semicolon
DECL|member|MessageSize
id|U16
id|MessageSize
suffix:semicolon
DECL|member|TargetAddress
id|BF
id|TargetAddress
suffix:colon
id|I2O_TID_SZ
suffix:semicolon
DECL|member|InitiatorAddress
id|BF
id|InitiatorAddress
suffix:colon
id|I2O_TID_SZ
suffix:semicolon
DECL|member|Function
id|BF
id|Function
suffix:colon
id|I2O_FUNCTION_SZ
suffix:semicolon
DECL|member|InitiatorContext
id|U32
id|InitiatorContext
suffix:semicolon
multiline_comment|/* SGL[] */
)brace
DECL|typedef|I2O_MESSAGE_FRAME
DECL|typedef|PI2O_MESSAGE_FRAME
id|I2O_MESSAGE_FRAME
comma
op_star
id|PI2O_MESSAGE_FRAME
suffix:semicolon
multiline_comment|/* assumed a 16K minus 256 byte space for outbound queue message frames */
DECL|macro|MSG_FRAME_SIZE
mdefine_line|#define MSG_FRAME_SIZE  512
DECL|macro|NMBR_MSG_FRAMES
mdefine_line|#define NMBR_MSG_FRAMES 30
multiline_comment|/*&n;**  Message Unit CSR definitions for RedCreek PCI45 board&n;*/
DECL|struct|tag_rcatu
r_typedef
r_struct
id|tag_rcatu
(brace
DECL|member|APICRegSel
r_volatile
r_int
r_int
id|APICRegSel
suffix:semicolon
multiline_comment|/* APIC Register Select */
DECL|member|reserved0
r_volatile
r_int
r_int
id|reserved0
suffix:semicolon
DECL|member|APICWinReg
r_volatile
r_int
r_int
id|APICWinReg
suffix:semicolon
multiline_comment|/* APIC Window Register */
DECL|member|reserved1
r_volatile
r_int
r_int
id|reserved1
suffix:semicolon
DECL|member|InMsgReg0
r_volatile
r_int
r_int
id|InMsgReg0
suffix:semicolon
multiline_comment|/* inbound message register 0 */
DECL|member|InMsgReg1
r_volatile
r_int
r_int
id|InMsgReg1
suffix:semicolon
multiline_comment|/* inbound message register 1 */
DECL|member|OutMsgReg0
r_volatile
r_int
r_int
id|OutMsgReg0
suffix:semicolon
multiline_comment|/* outbound message register 0 */
DECL|member|OutMsgReg1
r_volatile
r_int
r_int
id|OutMsgReg1
suffix:semicolon
multiline_comment|/* outbound message register 1 */
DECL|member|InDoorReg
r_volatile
r_int
r_int
id|InDoorReg
suffix:semicolon
multiline_comment|/* inbound doorbell register */
DECL|member|InIntStat
r_volatile
r_int
r_int
id|InIntStat
suffix:semicolon
multiline_comment|/* inbound interrupt status register */
DECL|member|InIntMask
r_volatile
r_int
r_int
id|InIntMask
suffix:semicolon
multiline_comment|/* inbound interrupt mask register */
DECL|member|OutDoorReg
r_volatile
r_int
r_int
id|OutDoorReg
suffix:semicolon
multiline_comment|/* outbound doorbell register */
DECL|member|OutIntStat
r_volatile
r_int
r_int
id|OutIntStat
suffix:semicolon
multiline_comment|/* outbound interrupt status register */
DECL|member|OutIntMask
r_volatile
r_int
r_int
id|OutIntMask
suffix:semicolon
multiline_comment|/* outbound interrupt mask register */
DECL|member|reserved2
r_volatile
r_int
r_int
id|reserved2
suffix:semicolon
DECL|member|reserved3
r_volatile
r_int
r_int
id|reserved3
suffix:semicolon
DECL|member|InQueue
r_volatile
r_int
r_int
id|InQueue
suffix:semicolon
multiline_comment|/* inbound queue port */
DECL|member|OutQueue
r_volatile
r_int
r_int
id|OutQueue
suffix:semicolon
multiline_comment|/* outbound queue port */
DECL|member|reserved4
r_volatile
r_int
r_int
id|reserved4
suffix:semicolon
DECL|member|reserver5
r_volatile
r_int
r_int
id|reserver5
suffix:semicolon
multiline_comment|/* RedCreek extension */
DECL|member|EtherMacLow
r_volatile
r_int
r_int
id|EtherMacLow
suffix:semicolon
DECL|member|EtherMacHi
r_volatile
r_int
r_int
id|EtherMacHi
suffix:semicolon
DECL|member|IPaddr
r_volatile
r_int
r_int
id|IPaddr
suffix:semicolon
DECL|member|IPmask
r_volatile
r_int
r_int
id|IPmask
suffix:semicolon
)brace
DECL|typedef|ATU
DECL|typedef|PATU
id|ATU
comma
op_star
id|PATU
suffix:semicolon
multiline_comment|/* &n; ** typedef PAB&n; **&n; ** PCI Adapter Block - holds instance specific information and is located&n; ** in a reserved space at the start of the message buffer allocated by user.&n; */
r_typedef
r_struct
(brace
DECL|member|p_atu
id|PATU
id|p_atu
suffix:semicolon
multiline_comment|/* ptr to  ATU register block */
DECL|member|pPci45LinBaseAddr
id|PU8
id|pPci45LinBaseAddr
suffix:semicolon
DECL|member|pLinOutMsgBlock
id|PU8
id|pLinOutMsgBlock
suffix:semicolon
DECL|member|outMsgBlockPhyAddr
id|U32
id|outMsgBlockPhyAddr
suffix:semicolon
DECL|member|pTransCallbackFunc
id|PFNTXCALLBACK
id|pTransCallbackFunc
suffix:semicolon
DECL|member|pRecvCallbackFunc
id|PFNRXCALLBACK
id|pRecvCallbackFunc
suffix:semicolon
DECL|member|pRebootCallbackFunc
id|PFNCALLBACK
id|pRebootCallbackFunc
suffix:semicolon
DECL|member|pCallbackFunc
id|PFNCALLBACK
id|pCallbackFunc
suffix:semicolon
DECL|member|IOPState
id|U16
id|IOPState
suffix:semicolon
DECL|member|InboundMFrameSize
id|U16
id|InboundMFrameSize
suffix:semicolon
)brace
DECL|typedef|PAB
DECL|typedef|PPAB
id|PAB
comma
op_star
id|PPAB
suffix:semicolon
multiline_comment|/* &n; ** in reserved space right after PAB in host memory is area for returning&n; ** values from card &n; */
multiline_comment|/* &n; ** Array of pointers to PCI Adapter Blocks.&n; ** Indexed by a zero based (0-31) interface number.&n; */
DECL|macro|MAX_ADAPTERS
mdefine_line|#define MAX_ADAPTERS 32
DECL|variable|PCIAdapterBlock
r_static
id|PPAB
id|PCIAdapterBlock
(braket
id|MAX_ADAPTERS
)braket
suffix:semicolon
multiline_comment|/*&n;** typedef NICSTAT&n;**&n;** Data structure for NIC statistics retruned from PCI card.  Data copied from&n;** here to user allocated RCLINKSTATS (see rclanmtl.h) structure.&n;*/
DECL|struct|tag_NicStat
r_typedef
r_struct
id|tag_NicStat
(brace
DECL|member|TX_good
r_int
r_int
id|TX_good
suffix:semicolon
DECL|member|TX_maxcol
r_int
r_int
id|TX_maxcol
suffix:semicolon
DECL|member|TX_latecol
r_int
r_int
id|TX_latecol
suffix:semicolon
DECL|member|TX_urun
r_int
r_int
id|TX_urun
suffix:semicolon
DECL|member|TX_crs
r_int
r_int
id|TX_crs
suffix:semicolon
multiline_comment|/* lost carrier sense */
DECL|member|TX_def
r_int
r_int
id|TX_def
suffix:semicolon
multiline_comment|/* transmit deferred */
DECL|member|TX_singlecol
r_int
r_int
id|TX_singlecol
suffix:semicolon
multiline_comment|/* single collisions */
DECL|member|TX_multcol
r_int
r_int
id|TX_multcol
suffix:semicolon
DECL|member|TX_totcol
r_int
r_int
id|TX_totcol
suffix:semicolon
DECL|member|Rcv_good
r_int
r_int
id|Rcv_good
suffix:semicolon
DECL|member|Rcv_CRCerr
r_int
r_int
id|Rcv_CRCerr
suffix:semicolon
DECL|member|Rcv_alignerr
r_int
r_int
id|Rcv_alignerr
suffix:semicolon
DECL|member|Rcv_reserr
r_int
r_int
id|Rcv_reserr
suffix:semicolon
multiline_comment|/* rnr&squot;d pkts */
DECL|member|Rcv_orun
r_int
r_int
id|Rcv_orun
suffix:semicolon
DECL|member|Rcv_cdt
r_int
r_int
id|Rcv_cdt
suffix:semicolon
DECL|member|Rcv_runt
r_int
r_int
id|Rcv_runt
suffix:semicolon
DECL|member|dump_status
r_int
r_int
id|dump_status
suffix:semicolon
multiline_comment|/* last field directly from the chip */
)brace
DECL|typedef|NICSTAT
DECL|typedef|P_NICSTAT
id|NICSTAT
comma
op_star
id|P_NICSTAT
suffix:semicolon
DECL|macro|DUMP_DONE
mdefine_line|#define DUMP_DONE   0x0000A005      /* completed statistical dump */
DECL|macro|DUMP_CLEAR
mdefine_line|#define DUMP_CLEAR  0x0000A007      /* completed stat dump and clear counters */
DECL|variable|msgFlag
r_static
r_volatile
r_int
id|msgFlag
suffix:semicolon
multiline_comment|/* local function prototypes */
r_static
r_void
id|ProcessOutboundI2OMsg
c_func
(paren
id|PPAB
id|pPab
comma
id|U32
id|phyMsgAddr
)paren
suffix:semicolon
r_static
r_int
id|FillI2OMsgSGLFromTCB
c_func
(paren
id|PU32
id|pMsg
comma
id|PRCTCB
id|pXmitCntrlBlock
)paren
suffix:semicolon
r_static
r_int
id|GetI2OStatus
c_func
(paren
id|PPAB
id|pPab
)paren
suffix:semicolon
r_static
r_int
id|SendI2OOutboundQInitMsg
c_func
(paren
id|PPAB
id|pPab
)paren
suffix:semicolon
r_static
r_int
id|SendEnableSysMsg
c_func
(paren
id|PPAB
id|pPab
)paren
suffix:semicolon
multiline_comment|/* 1st 100h bytes of message block is reserved for messenger instance */
DECL|macro|ADAPTER_BLOCK_RESERVED_SPACE
mdefine_line|#define ADAPTER_BLOCK_RESERVED_SPACE 0x100
multiline_comment|/*&n;** =========================================================================&n;** RCInitI2OMsgLayer()&n;**&n;** Initialize the RedCreek I2O Module and adapter.&n;**&n;** Inputs:  AdapterID - interface number from 0 to 15&n;**          pciBaseAddr - virual base address of PCI (set by BIOS)&n;**          p_msgbuf - virual address to private message block (min. 16K)&n;**          p_phymsgbuf - physical address of private message block&n;**          TransmitCallbackFunction - address of transmit callback function&n;**          ReceiveCallbackFunction  - address of receive  callback function&n;**&n;** private message block is allocated by user.  It must be in locked pages.&n;** p_msgbuf and p_phymsgbuf point to the same location.  Must be contigous&n;** memory block of a minimum of 16K byte and long word aligned.&n;** =========================================================================&n;*/
id|RC_RETURN
DECL|function|RCInitI2OMsgLayer
id|RCInitI2OMsgLayer
c_func
(paren
id|U16
id|AdapterID
comma
id|U32
id|pciBaseAddr
comma
id|PU8
id|p_msgbuf
comma
id|PU8
id|p_phymsgbuf
comma
id|PFNTXCALLBACK
id|TransmitCallbackFunction
comma
id|PFNRXCALLBACK
id|ReceiveCallbackFunction
comma
id|PFNCALLBACK
id|RebootCallbackFunction
)paren
(brace
r_int
id|result
suffix:semicolon
id|PPAB
id|pPab
suffix:semicolon
macro_line|#ifdef DEBUG
id|kprintf
c_func
(paren
l_string|&quot;InitI2O: Adapter:0x%04.4ux ATU:0x%08.8ulx msgbuf:0x%08.8ulx phymsgbuf:0x%08.8ulx&bslash;n&quot;
l_string|&quot;TransmitCallbackFunction:0x%08.8ulx  ReceiveCallbackFunction:0x%08.8ulx&bslash;n&quot;
comma
id|AdapterID
comma
id|pciBaseAddr
comma
id|p_msgbuf
comma
id|p_phymsgbuf
comma
id|TransmitCallbackFunction
comma
id|ReceiveCallbackFunction
)paren
suffix:semicolon
macro_line|#endif /* DEBUG */
multiline_comment|/* Check if this interface already initialized - if so, shut it down */
r_if
c_cond
(paren
id|PCIAdapterBlock
(braket
id|AdapterID
)braket
op_ne
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;PCIAdapterBlock[%d]!=NULL&bslash;n&quot;
comma
id|AdapterID
)paren
suffix:semicolon
singleline_comment|//        RCResetLANCard(AdapterID, 0, (PU32)NULL, (PFNCALLBACK)NULL);
id|PCIAdapterBlock
(braket
id|AdapterID
)braket
op_assign
l_int|NULL
suffix:semicolon
)brace
multiline_comment|/* &n;    ** store adapter instance values in adapter block.&n;    ** Adapter block is at beginning of message buffer&n;    */
id|pPab
op_assign
(paren
id|PPAB
)paren
id|p_msgbuf
suffix:semicolon
id|pPab-&gt;p_atu
op_assign
(paren
id|PATU
)paren
id|pciBaseAddr
suffix:semicolon
id|pPab-&gt;pPci45LinBaseAddr
op_assign
(paren
id|PU8
)paren
id|pciBaseAddr
suffix:semicolon
multiline_comment|/* Set outbound message frame addr - skip over Adapter Block */
id|pPab-&gt;outMsgBlockPhyAddr
op_assign
(paren
id|U32
)paren
(paren
id|p_phymsgbuf
op_plus
id|ADAPTER_BLOCK_RESERVED_SPACE
)paren
suffix:semicolon
id|pPab-&gt;pLinOutMsgBlock
op_assign
(paren
id|PU8
)paren
(paren
id|p_msgbuf
op_plus
id|ADAPTER_BLOCK_RESERVED_SPACE
)paren
suffix:semicolon
multiline_comment|/* store callback function addresses */
id|pPab-&gt;pTransCallbackFunc
op_assign
id|TransmitCallbackFunction
suffix:semicolon
id|pPab-&gt;pRecvCallbackFunc
op_assign
id|ReceiveCallbackFunction
suffix:semicolon
id|pPab-&gt;pRebootCallbackFunc
op_assign
id|RebootCallbackFunction
suffix:semicolon
id|pPab-&gt;pCallbackFunc
op_assign
(paren
id|PFNCALLBACK
)paren
l_int|NULL
suffix:semicolon
multiline_comment|/*&n;    ** Initialize I2O IOP&n;    */
id|result
op_assign
id|GetI2OStatus
c_func
(paren
id|pPab
)paren
suffix:semicolon
r_if
c_cond
(paren
id|result
op_ne
id|RC_RTN_NO_ERROR
)paren
r_return
id|result
suffix:semicolon
r_if
c_cond
(paren
id|pPab-&gt;IOPState
op_eq
id|I2O_IOP_STATE_OPERATIONAL
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;pPab-&gt;IOPState == op: resetting adapter&bslash;n&quot;
)paren
suffix:semicolon
id|RCResetLANCard
c_func
(paren
id|AdapterID
comma
l_int|0
comma
(paren
id|PU32
)paren
l_int|NULL
comma
(paren
id|PFNCALLBACK
)paren
l_int|NULL
)paren
suffix:semicolon
)brace
id|result
op_assign
id|SendI2OOutboundQInitMsg
c_func
(paren
id|pPab
)paren
suffix:semicolon
r_if
c_cond
(paren
id|result
op_ne
id|RC_RTN_NO_ERROR
)paren
r_return
id|result
suffix:semicolon
id|result
op_assign
id|SendEnableSysMsg
c_func
(paren
id|pPab
)paren
suffix:semicolon
r_if
c_cond
(paren
id|result
op_ne
id|RC_RTN_NO_ERROR
)paren
r_return
id|result
suffix:semicolon
id|PCIAdapterBlock
(braket
id|AdapterID
)braket
op_assign
id|pPab
suffix:semicolon
r_return
id|RC_RTN_NO_ERROR
suffix:semicolon
)brace
multiline_comment|/*&n;** =========================================================================&n;** Disable and Enable I2O interrupts.  I2O interrupts are enabled at Init time&n;** but can be disabled and re-enabled through these two function calls.&n;** Packets will still be put into any posted received buffers and packets will&n;** be sent through RCI2OSendPacket() functions.  Disabling I2O interrupts&n;** will prevent hardware interrupt to host even though the outbound I2O msg&n;** queue is not emtpy.&n;** =========================================================================&n;*/
DECL|macro|i960_OUT_POST_Q_INT_BIT
mdefine_line|#define i960_OUT_POST_Q_INT_BIT        0x0008 /* bit set masks interrupts */
DECL|function|RCDisableI2OInterrupts
id|RC_RETURN
id|RCDisableI2OInterrupts
c_func
(paren
id|U16
id|AdapterID
)paren
(brace
id|PPAB
id|pPab
suffix:semicolon
id|pPab
op_assign
id|PCIAdapterBlock
(braket
id|AdapterID
)braket
suffix:semicolon
r_if
c_cond
(paren
id|pPab
op_eq
l_int|NULL
)paren
r_return
id|RC_RTN_ADPTR_NOT_REGISTERED
suffix:semicolon
id|pPab-&gt;p_atu-&gt;OutIntMask
op_or_assign
id|i960_OUT_POST_Q_INT_BIT
suffix:semicolon
r_return
id|RC_RTN_NO_ERROR
suffix:semicolon
)brace
DECL|function|RCEnableI2OInterrupts
id|RC_RETURN
id|RCEnableI2OInterrupts
c_func
(paren
id|U16
id|AdapterID
)paren
(brace
id|PPAB
id|pPab
suffix:semicolon
id|pPab
op_assign
id|PCIAdapterBlock
(braket
id|AdapterID
)braket
suffix:semicolon
r_if
c_cond
(paren
id|pPab
op_eq
l_int|NULL
)paren
r_return
id|RC_RTN_ADPTR_NOT_REGISTERED
suffix:semicolon
id|pPab-&gt;p_atu-&gt;OutIntMask
op_and_assign
op_complement
id|i960_OUT_POST_Q_INT_BIT
suffix:semicolon
r_return
id|RC_RTN_NO_ERROR
suffix:semicolon
)brace
multiline_comment|/*&n;** =========================================================================&n;** RCI2OSendPacket()&n;** =========================================================================&n;*/
id|RC_RETURN
DECL|function|RCI2OSendPacket
id|RCI2OSendPacket
c_func
(paren
id|U16
id|AdapterID
comma
id|U32
id|InitiatorContext
comma
id|PRCTCB
id|pTransCtrlBlock
)paren
(brace
id|U32
id|msgOffset
suffix:semicolon
id|PU32
id|pMsg
suffix:semicolon
r_int
id|size
suffix:semicolon
id|PPAB
id|pPab
suffix:semicolon
macro_line|#ifdef DEBUG
id|kprintf
c_func
(paren
l_string|&quot;RCI2OSendPacket()...&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif /* DEBUG */
id|pPab
op_assign
id|PCIAdapterBlock
(braket
id|AdapterID
)braket
suffix:semicolon
r_if
c_cond
(paren
id|pPab
op_eq
l_int|NULL
)paren
r_return
id|RC_RTN_ADPTR_NOT_REGISTERED
suffix:semicolon
multiline_comment|/* get Inbound free Q entry - reading from In Q gets free Q entry */
multiline_comment|/* offset to Msg Frame in PCI msg block */
id|msgOffset
op_assign
id|pPab-&gt;p_atu-&gt;InQueue
suffix:semicolon
r_if
c_cond
(paren
id|msgOffset
op_eq
l_int|0xFFFFFFFF
)paren
(brace
macro_line|#ifdef DEBUG
id|kprintf
c_func
(paren
l_string|&quot;RCI2OSendPacket(): Inbound Free Q empty!&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif /* DEBUG */
r_return
id|RC_RTN_FREE_Q_EMPTY
suffix:semicolon
)brace
multiline_comment|/* calc virual address of msg - virual already mapped to physical */
id|pMsg
op_assign
(paren
id|PU32
)paren
(paren
id|pPab-&gt;pPci45LinBaseAddr
op_plus
id|msgOffset
)paren
suffix:semicolon
id|size
op_assign
id|FillI2OMsgSGLFromTCB
c_func
(paren
id|pMsg
op_plus
l_int|4
comma
id|pTransCtrlBlock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|size
op_eq
op_minus
l_int|1
)paren
multiline_comment|/* error processing TCB - send NOP msg */
(brace
macro_line|#ifdef DEBUG
id|kprintf
c_func
(paren
l_string|&quot;RCI2OSendPacket(): Error Rrocess TCB!&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif /* DEBUG */
id|pMsg
(braket
l_int|0
)braket
op_assign
id|THREE_WORD_MSG_SIZE
op_or
id|SGL_OFFSET_0
suffix:semicolon
id|pMsg
(braket
l_int|1
)braket
op_assign
id|I2O_UTIL_NOP
op_lshift
l_int|24
op_or
id|I2O_HOST_TID
op_lshift
l_int|12
op_or
id|RC_LAN_TARGET_ID
suffix:semicolon
r_return
id|RC_RTN_TCB_ERROR
suffix:semicolon
)brace
r_else
multiline_comment|/* send over msg header */
(brace
id|pMsg
(braket
l_int|0
)braket
op_assign
(paren
id|size
op_plus
l_int|4
)paren
op_lshift
l_int|16
op_or
id|LAN_MSG_REQST
suffix:semicolon
multiline_comment|/* send over message size and flags */
id|pMsg
(braket
l_int|1
)braket
op_assign
id|I2O_LAN_PACKET_SEND
op_lshift
l_int|24
op_or
id|I2O_HOST_TID
op_lshift
l_int|12
op_or
id|RC_LAN_TARGET_ID
suffix:semicolon
id|pMsg
(braket
l_int|2
)braket
op_assign
id|InitiatorContext
suffix:semicolon
id|pMsg
(braket
l_int|3
)braket
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* batch reply */
multiline_comment|/* post to Inbound Post Q */
id|pPab-&gt;p_atu-&gt;InQueue
op_assign
id|msgOffset
suffix:semicolon
r_return
id|RC_RTN_NO_ERROR
suffix:semicolon
)brace
)brace
multiline_comment|/*&n;** =========================================================================&n;** RCI2OPostRecvBuffer()&n;**&n;** inputs:  pBufrCntrlBlock - pointer to buffer control block&n;**&n;** returns TRUE if successful in sending message, else FALSE.&n;** =========================================================================&n;*/
id|RC_RETURN
DECL|function|RCPostRecvBuffers
id|RCPostRecvBuffers
c_func
(paren
id|U16
id|AdapterID
comma
id|PRCTCB
id|pTransCtrlBlock
)paren
(brace
id|U32
id|msgOffset
suffix:semicolon
id|PU32
id|pMsg
suffix:semicolon
r_int
id|size
suffix:semicolon
id|PPAB
id|pPab
suffix:semicolon
macro_line|#ifdef DEBUG
id|kprintf
c_func
(paren
l_string|&quot;RCPostRecvBuffers()...&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif /* DEBUG */
multiline_comment|/* search for DeviceHandle */
id|pPab
op_assign
id|PCIAdapterBlock
(braket
id|AdapterID
)braket
suffix:semicolon
r_if
c_cond
(paren
id|pPab
op_eq
l_int|NULL
)paren
r_return
id|RC_RTN_ADPTR_NOT_REGISTERED
suffix:semicolon
multiline_comment|/* get Inbound free Q entry - reading from In Q gets free Q entry */
multiline_comment|/* offset to Msg Frame in PCI msg block */
id|msgOffset
op_assign
id|pPab-&gt;p_atu-&gt;InQueue
suffix:semicolon
r_if
c_cond
(paren
id|msgOffset
op_eq
l_int|0xFFFFFFFF
)paren
(brace
macro_line|#ifdef DEBUG
id|kprintf
c_func
(paren
l_string|&quot;RCPostRecvBuffers(): Inbound Free Q empty!&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif /* DEBUG */
r_return
id|RC_RTN_FREE_Q_EMPTY
suffix:semicolon
)brace
multiline_comment|/* calc virual address of msg - virual already mapped to physical */
id|pMsg
op_assign
(paren
id|PU32
)paren
(paren
id|pPab-&gt;pPci45LinBaseAddr
op_plus
id|msgOffset
)paren
suffix:semicolon
id|size
op_assign
id|FillI2OMsgSGLFromTCB
c_func
(paren
id|pMsg
op_plus
l_int|4
comma
id|pTransCtrlBlock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|size
op_eq
op_minus
l_int|1
)paren
multiline_comment|/* error prcessing TCB - send 3 DWORD private msg == NOP */
(brace
macro_line|#ifdef DEBUG
id|kprintf
c_func
(paren
l_string|&quot;RCPostRecvBuffers(): Error Processing TCB! size = %d&bslash;n&quot;
comma
id|size
)paren
suffix:semicolon
macro_line|#endif /* DEBUG */
id|pMsg
(braket
l_int|0
)braket
op_assign
id|THREE_WORD_MSG_SIZE
op_or
id|SGL_OFFSET_0
suffix:semicolon
id|pMsg
(braket
l_int|1
)braket
op_assign
id|I2O_UTIL_NOP
op_lshift
l_int|24
op_or
id|I2O_HOST_TID
op_lshift
l_int|12
op_or
id|RC_LAN_TARGET_ID
suffix:semicolon
multiline_comment|/* post to Post Q */
id|pPab-&gt;p_atu-&gt;InQueue
op_assign
id|msgOffset
suffix:semicolon
r_return
id|RC_RTN_TCB_ERROR
suffix:semicolon
)brace
r_else
multiline_comment|/* send over size msg header */
(brace
id|pMsg
(braket
l_int|0
)braket
op_assign
(paren
id|size
op_plus
l_int|4
)paren
op_lshift
l_int|16
op_or
id|LAN_MSG_REQST
suffix:semicolon
multiline_comment|/* send over message size and flags */
id|pMsg
(braket
l_int|1
)braket
op_assign
id|I2O_LAN_RECEIVE_POST
op_lshift
l_int|24
op_or
id|I2O_HOST_TID
op_lshift
l_int|12
op_or
id|RC_LAN_TARGET_ID
suffix:semicolon
id|pMsg
(braket
l_int|2
)braket
op_assign
id|DEFAULT_RECV_INIT_CONTEXT
suffix:semicolon
id|pMsg
(braket
l_int|3
)braket
op_assign
op_star
(paren
id|PU32
)paren
id|pTransCtrlBlock
suffix:semicolon
multiline_comment|/* number of packet buffers */
multiline_comment|/* post to Post Q */
id|pPab-&gt;p_atu-&gt;InQueue
op_assign
id|msgOffset
suffix:semicolon
r_return
id|RC_RTN_NO_ERROR
suffix:semicolon
)brace
)brace
multiline_comment|/*&n;** =========================================================================&n;** RCProcI2OMsgQ()&n;**&n;** Process I2O outbound message queue until empty.&n;** =========================================================================&n;*/
r_void
DECL|function|RCProcI2OMsgQ
id|RCProcI2OMsgQ
c_func
(paren
id|U16
id|AdapterID
)paren
(brace
id|U32
id|phyAddrMsg
suffix:semicolon
id|PU8
id|p8Msg
suffix:semicolon
id|PU32
id|p32
suffix:semicolon
id|U16
id|count
suffix:semicolon
id|PPAB
id|pPab
suffix:semicolon
r_int
r_char
id|debug_msg
(braket
l_int|20
)braket
suffix:semicolon
id|pPab
op_assign
id|PCIAdapterBlock
(braket
id|AdapterID
)braket
suffix:semicolon
r_if
c_cond
(paren
id|pPab
op_eq
l_int|NULL
)paren
r_return
suffix:semicolon
id|phyAddrMsg
op_assign
id|pPab-&gt;p_atu-&gt;OutQueue
suffix:semicolon
r_while
c_loop
(paren
id|phyAddrMsg
op_ne
l_int|0xFFFFFFFF
)paren
(brace
id|p8Msg
op_assign
id|pPab-&gt;pLinOutMsgBlock
op_plus
(paren
id|phyAddrMsg
op_minus
id|pPab-&gt;outMsgBlockPhyAddr
)paren
suffix:semicolon
id|p32
op_assign
(paren
id|PU32
)paren
id|p8Msg
suffix:semicolon
singleline_comment|//printk(&quot; msg: 0x%x  0x%x &bslash;n&quot;, p8Msg[7], p32[5]);
multiline_comment|/* &n;        ** Send Packet Reply Msg&n;        */
r_if
c_cond
(paren
id|I2O_LAN_PACKET_SEND
op_eq
id|p8Msg
(braket
l_int|7
)braket
)paren
multiline_comment|/* function code byte */
(brace
id|count
op_assign
op_star
(paren
id|PU16
)paren
(paren
id|p8Msg
op_plus
l_int|2
)paren
suffix:semicolon
id|count
op_sub_assign
id|p8Msg
(braket
l_int|0
)braket
op_rshift
l_int|4
suffix:semicolon
multiline_comment|/* status, count, context[], adapter */
(paren
op_star
id|pPab-&gt;pTransCallbackFunc
)paren
(paren
id|p8Msg
(braket
l_int|19
)braket
comma
id|count
comma
id|p32
op_plus
l_int|5
comma
id|AdapterID
)paren
suffix:semicolon
)brace
multiline_comment|/* &n;        ** Receive Packet Reply Msg */
r_else
r_if
c_cond
(paren
id|I2O_LAN_RECEIVE_POST
op_eq
id|p8Msg
(braket
l_int|7
)braket
)paren
(brace
macro_line|#ifdef DEBUG    
id|kprintf
c_func
(paren
l_string|&quot;I2O_RECV_REPLY pPab:0x%08.8ulx p8Msg:0x%08.8ulx p32:0x%08.8ulx&bslash;n&quot;
comma
id|pPab
comma
id|p8Msg
comma
id|p32
)paren
suffix:semicolon
id|kprintf
c_func
(paren
l_string|&quot;msg: 0x%08.8ulx:0x%08.8ulx:0x%08.8ulx:0x%08.8ulx&bslash;n&quot;
comma
id|p32
(braket
l_int|0
)braket
comma
id|p32
(braket
l_int|1
)braket
comma
id|p32
(braket
l_int|2
)braket
comma
id|p32
(braket
l_int|3
)braket
)paren
suffix:semicolon
id|kprintf
c_func
(paren
l_string|&quot;     0x%08.8ulx:0x%08.8ulx:0x%08.8ulx:0x%08.8ulx&bslash;n&quot;
comma
id|p32
(braket
l_int|4
)braket
comma
id|p32
(braket
l_int|5
)braket
comma
id|p32
(braket
l_int|6
)braket
comma
id|p32
(braket
l_int|7
)braket
)paren
suffix:semicolon
id|kprintf
c_func
(paren
l_string|&quot;     0x%08.8ulx:0X%08.8ulx:0x%08.8ulx:0x%08.8ulx&bslash;n&quot;
comma
id|p32
(braket
l_int|8
)braket
comma
id|p32
(braket
l_int|9
)braket
comma
id|p32
(braket
l_int|10
)braket
comma
id|p32
(braket
l_int|11
)braket
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/*  status, count, buckets remaining, packetParmBlock, adapter */
(paren
op_star
id|pPab-&gt;pRecvCallbackFunc
)paren
(paren
id|p8Msg
(braket
l_int|19
)braket
comma
id|p8Msg
(braket
l_int|12
)braket
comma
id|p32
(braket
l_int|5
)braket
comma
id|p32
op_plus
l_int|6
comma
id|AdapterID
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|I2O_LAN_RESET
op_eq
id|p8Msg
(braket
l_int|7
)braket
op_logical_or
id|I2O_LAN_SHUTDOWN
op_eq
id|p8Msg
(braket
l_int|7
)braket
)paren
(brace
r_if
c_cond
(paren
id|pPab-&gt;pCallbackFunc
)paren
(brace
(paren
op_star
id|pPab-&gt;pCallbackFunc
)paren
(paren
id|p8Msg
(braket
l_int|19
)braket
comma
l_int|0
comma
l_int|0
comma
id|AdapterID
)paren
suffix:semicolon
)brace
r_else
(brace
id|pPab-&gt;pCallbackFunc
op_assign
(paren
id|PFNCALLBACK
)paren
l_int|1
suffix:semicolon
)brace
singleline_comment|//PCIAdapterBlock[AdapterID] = 0;
)brace
r_else
r_if
c_cond
(paren
id|I2O_PRIVATE
op_eq
id|p8Msg
(braket
l_int|7
)braket
)paren
(brace
singleline_comment|//printk(&quot;i2o private 0x%x, 0x%x &bslash;n&quot;, p8Msg[7], p32[5]);
r_switch
c_cond
(paren
id|p32
(braket
l_int|5
)braket
)paren
(brace
r_case
id|RC_PRIVATE_DEBUG_MSG
suffix:colon
id|msgFlag
op_assign
l_int|1
suffix:semicolon
multiline_comment|/*printk(&quot;Received I2O_PRIVATE msg&bslash;n&quot;);*/
id|debug_msg
(braket
l_int|15
)braket
op_assign
(paren
id|p32
(braket
l_int|6
)braket
op_amp
l_int|0xff000000
)paren
op_rshift
l_int|24
suffix:semicolon
id|debug_msg
(braket
l_int|14
)braket
op_assign
(paren
id|p32
(braket
l_int|6
)braket
op_amp
l_int|0x00ff0000
)paren
op_rshift
l_int|16
suffix:semicolon
id|debug_msg
(braket
l_int|13
)braket
op_assign
(paren
id|p32
(braket
l_int|6
)braket
op_amp
l_int|0x0000ff00
)paren
op_rshift
l_int|8
suffix:semicolon
id|debug_msg
(braket
l_int|12
)braket
op_assign
(paren
id|p32
(braket
l_int|6
)braket
op_amp
l_int|0x000000ff
)paren
suffix:semicolon
id|debug_msg
(braket
l_int|11
)braket
op_assign
(paren
id|p32
(braket
l_int|7
)braket
op_amp
l_int|0xff000000
)paren
op_rshift
l_int|24
suffix:semicolon
id|debug_msg
(braket
l_int|10
)braket
op_assign
(paren
id|p32
(braket
l_int|7
)braket
op_amp
l_int|0x00ff0000
)paren
op_rshift
l_int|16
suffix:semicolon
id|debug_msg
(braket
l_int|9
)braket
op_assign
(paren
id|p32
(braket
l_int|7
)braket
op_amp
l_int|0x0000ff00
)paren
op_rshift
l_int|8
suffix:semicolon
id|debug_msg
(braket
l_int|8
)braket
op_assign
(paren
id|p32
(braket
l_int|7
)braket
op_amp
l_int|0x000000ff
)paren
suffix:semicolon
id|debug_msg
(braket
l_int|7
)braket
op_assign
(paren
id|p32
(braket
l_int|8
)braket
op_amp
l_int|0xff000000
)paren
op_rshift
l_int|24
suffix:semicolon
id|debug_msg
(braket
l_int|6
)braket
op_assign
(paren
id|p32
(braket
l_int|8
)braket
op_amp
l_int|0x00ff0000
)paren
op_rshift
l_int|16
suffix:semicolon
id|debug_msg
(braket
l_int|5
)braket
op_assign
(paren
id|p32
(braket
l_int|8
)braket
op_amp
l_int|0x0000ff00
)paren
op_rshift
l_int|8
suffix:semicolon
id|debug_msg
(braket
l_int|4
)braket
op_assign
(paren
id|p32
(braket
l_int|8
)braket
op_amp
l_int|0x000000ff
)paren
suffix:semicolon
id|debug_msg
(braket
l_int|3
)braket
op_assign
(paren
id|p32
(braket
l_int|9
)braket
op_amp
l_int|0xff000000
)paren
op_rshift
l_int|24
suffix:semicolon
id|debug_msg
(braket
l_int|2
)braket
op_assign
(paren
id|p32
(braket
l_int|9
)braket
op_amp
l_int|0x00ff0000
)paren
op_rshift
l_int|16
suffix:semicolon
id|debug_msg
(braket
l_int|1
)braket
op_assign
(paren
id|p32
(braket
l_int|9
)braket
op_amp
l_int|0x0000ff00
)paren
op_rshift
l_int|8
suffix:semicolon
id|debug_msg
(braket
l_int|0
)braket
op_assign
(paren
id|p32
(braket
l_int|9
)braket
op_amp
l_int|0x000000ff
)paren
suffix:semicolon
id|debug_msg
(braket
l_int|16
)braket
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
id|printk
(paren
id|debug_msg
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|RC_PRIVATE_REBOOT
suffix:colon
id|printk
c_func
(paren
l_string|&quot;Adapter reboot initiated...&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pPab-&gt;pRebootCallbackFunc
)paren
(brace
(paren
op_star
id|pPab-&gt;pRebootCallbackFunc
)paren
(paren
l_int|0
comma
l_int|0
comma
l_int|0
comma
id|AdapterID
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_default
suffix:colon
id|printk
c_func
(paren
l_string|&quot;Unknown private I2O msg received: 0x%lx&bslash;n&quot;
comma
id|p32
(braket
l_int|5
)braket
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
multiline_comment|/* &n;        ** Process other Msg&squot;s&n;        */
r_else
(brace
id|ProcessOutboundI2OMsg
c_func
(paren
id|pPab
comma
id|phyAddrMsg
)paren
suffix:semicolon
)brace
multiline_comment|/* return MFA to outbound free Q*/
id|pPab-&gt;p_atu-&gt;OutQueue
op_assign
id|phyAddrMsg
suffix:semicolon
multiline_comment|/* any more msgs? */
id|phyAddrMsg
op_assign
id|pPab-&gt;p_atu-&gt;OutQueue
suffix:semicolon
)brace
)brace
multiline_comment|/*&n;** =========================================================================&n;**  Returns LAN interface statistical counters to space provided by caller at&n;**  StatsReturnAddr.  Returns 0 if success, else RC_RETURN code.&n;**  This function will call the WaitCallback function provided by&n;**  user while waiting for card to respond.&n;** =========================================================================&n;*/
id|RC_RETURN
DECL|function|RCGetLinkStatistics
id|RCGetLinkStatistics
c_func
(paren
id|U16
id|AdapterID
comma
id|P_RCLINKSTATS
id|StatsReturnAddr
comma
id|PFNWAITCALLBACK
id|WaitCallback
)paren
(brace
id|U32
id|msgOffset
suffix:semicolon
r_volatile
id|U32
id|timeout
suffix:semicolon
r_volatile
id|PU32
id|pMsg
suffix:semicolon
r_volatile
id|PU32
id|p32
comma
id|pReturnAddr
suffix:semicolon
id|P_NICSTAT
id|pStats
suffix:semicolon
r_int
id|i
suffix:semicolon
id|PPAB
id|pPab
suffix:semicolon
multiline_comment|/*kprintf(&quot;Get82558Stats() StatsReturnAddr:0x%08.8ulx&bslash;n&quot;, StatsReturnAddr);*/
id|pPab
op_assign
id|PCIAdapterBlock
(braket
id|AdapterID
)braket
suffix:semicolon
r_if
c_cond
(paren
id|pPab
op_eq
l_int|NULL
)paren
r_return
id|RC_RTN_ADPTR_NOT_REGISTERED
suffix:semicolon
id|msgOffset
op_assign
id|pPab-&gt;p_atu-&gt;InQueue
suffix:semicolon
r_if
c_cond
(paren
id|msgOffset
op_eq
l_int|0xFFFFFFFF
)paren
(brace
macro_line|#ifdef DEBUG
id|kprintf
c_func
(paren
l_string|&quot;Get8255XStats(): Inbound Free Q empty!&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
r_return
id|RC_RTN_FREE_Q_EMPTY
suffix:semicolon
)brace
multiline_comment|/* calc virual address of msg - virual already mapped to physical */
id|pMsg
op_assign
(paren
id|PU32
)paren
(paren
id|pPab-&gt;pPci45LinBaseAddr
op_plus
id|msgOffset
)paren
suffix:semicolon
multiline_comment|/*dprintf(&quot;Get82558Stats - pMsg = 0x%08ulx, InQ msgOffset = 0x%08ulx&bslash;n&quot;, pMsg, msgOffset);*/
multiline_comment|/*dprintf(&quot;Get82558Stats - pMsg = 0x%08X, InQ msgOffset = 0x%08X&bslash;n&quot;, pMsg, msgOffset);*/
id|pMsg
(braket
l_int|0
)braket
op_assign
id|SIX_WORD_MSG_SIZE
op_or
id|SGL_OFFSET_0
suffix:semicolon
id|pMsg
(braket
l_int|1
)braket
op_assign
id|I2O_PRIVATE
op_lshift
l_int|24
op_or
id|I2O_HOST_TID
op_lshift
l_int|12
op_or
id|RC_LAN_TARGET_ID
suffix:semicolon
id|pMsg
(braket
l_int|2
)braket
op_assign
id|DEFAULT_RECV_INIT_CONTEXT
suffix:semicolon
id|pMsg
(braket
l_int|3
)braket
op_assign
l_int|0x112
suffix:semicolon
multiline_comment|/* transaction context */
id|pMsg
(braket
l_int|4
)braket
op_assign
id|RC_PCI45_VENDOR_ID
op_lshift
l_int|16
op_or
id|RC_PRIVATE_GET_NIC_STATS
suffix:semicolon
id|pMsg
(braket
l_int|5
)braket
op_assign
id|pPab-&gt;outMsgBlockPhyAddr
op_minus
id|ADAPTER_BLOCK_RESERVED_SPACE
op_plus
r_sizeof
(paren
id|PAB
)paren
suffix:semicolon
id|p32
op_assign
(paren
id|PU32
)paren
(paren
id|pPab-&gt;pLinOutMsgBlock
op_minus
id|ADAPTER_BLOCK_RESERVED_SPACE
op_plus
r_sizeof
(paren
id|PAB
)paren
)paren
suffix:semicolon
id|pStats
op_assign
(paren
id|P_NICSTAT
)paren
id|p32
suffix:semicolon
id|pStats-&gt;dump_status
op_assign
l_int|0xFFFFFFFF
suffix:semicolon
multiline_comment|/* post to Inbound Post Q */
id|pPab-&gt;p_atu-&gt;InQueue
op_assign
id|msgOffset
suffix:semicolon
id|timeout
op_assign
l_int|100000
suffix:semicolon
r_while
c_loop
(paren
l_int|1
)paren
(brace
r_if
c_cond
(paren
id|WaitCallback
)paren
(paren
op_star
id|WaitCallback
)paren
(paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|1000
suffix:semicolon
id|i
op_increment
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pStats-&gt;dump_status
op_ne
l_int|0xFFFFFFFF
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|timeout
op_decrement
)paren
(brace
macro_line|#ifdef DEBUG
id|kprintf
c_func
(paren
l_string|&quot;RCGet82558Stats() Timeout waiting for NIC statistics&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
r_return
id|RC_RTN_MSG_REPLY_TIMEOUT
suffix:semicolon
)brace
)brace
id|pReturnAddr
op_assign
(paren
id|PU32
)paren
id|StatsReturnAddr
suffix:semicolon
multiline_comment|/* copy Nic stats to user&squot;s structure */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
(paren
r_int
)paren
r_sizeof
(paren
id|RCLINKSTATS
)paren
op_div
l_int|4
suffix:semicolon
id|i
op_increment
)paren
id|pReturnAddr
(braket
id|i
)braket
op_assign
id|p32
(braket
id|i
)braket
suffix:semicolon
r_return
id|RC_RTN_NO_ERROR
suffix:semicolon
)brace
multiline_comment|/*&n;** =========================================================================&n;** Get82558LinkStatus()&n;** =========================================================================&n;*/
id|RC_RETURN
DECL|function|RCGetLinkStatus
id|RCGetLinkStatus
c_func
(paren
id|U16
id|AdapterID
comma
id|PU32
id|ReturnAddr
comma
id|PFNWAITCALLBACK
id|WaitCallback
)paren
(brace
id|U32
id|msgOffset
suffix:semicolon
r_volatile
id|U32
id|timeout
suffix:semicolon
r_volatile
id|PU32
id|pMsg
suffix:semicolon
r_volatile
id|PU32
id|p32
suffix:semicolon
id|PPAB
id|pPab
suffix:semicolon
multiline_comment|/*kprintf(&quot;Get82558LinkStatus() ReturnPhysAddr:0x%08.8ulx&bslash;n&quot;, ReturnAddr);*/
id|pPab
op_assign
id|PCIAdapterBlock
(braket
id|AdapterID
)braket
suffix:semicolon
r_if
c_cond
(paren
id|pPab
op_eq
l_int|NULL
)paren
r_return
id|RC_RTN_ADPTR_NOT_REGISTERED
suffix:semicolon
id|msgOffset
op_assign
id|pPab-&gt;p_atu-&gt;InQueue
suffix:semicolon
r_if
c_cond
(paren
id|msgOffset
op_eq
l_int|0xFFFFFFFF
)paren
(brace
macro_line|#ifdef DEBUG
id|dprintf
c_func
(paren
l_string|&quot;Get82558LinkStatus(): Inbound Free Q empty!&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
r_return
id|RC_RTN_FREE_Q_EMPTY
suffix:semicolon
)brace
multiline_comment|/* calc virual address of msg - virual already mapped to physical */
id|pMsg
op_assign
(paren
id|PU32
)paren
(paren
id|pPab-&gt;pPci45LinBaseAddr
op_plus
id|msgOffset
)paren
suffix:semicolon
multiline_comment|/*dprintf(&quot;Get82558LinkStatus - pMsg = 0x%08ulx, InQ msgOffset = 0x%08ulx&bslash;n&quot;, pMsg, msgOffset);*/
multiline_comment|/*dprintf(&quot;Get82558LinkStatus - pMsg = 0x%08X, InQ msgOffset = 0x%08X&bslash;n&quot;, pMsg, msgOffset);*/
id|pMsg
(braket
l_int|0
)braket
op_assign
id|SIX_WORD_MSG_SIZE
op_or
id|SGL_OFFSET_0
suffix:semicolon
id|pMsg
(braket
l_int|1
)braket
op_assign
id|I2O_PRIVATE
op_lshift
l_int|24
op_or
id|I2O_HOST_TID
op_lshift
l_int|12
op_or
id|RC_LAN_TARGET_ID
suffix:semicolon
id|pMsg
(braket
l_int|2
)braket
op_assign
id|DEFAULT_RECV_INIT_CONTEXT
suffix:semicolon
id|pMsg
(braket
l_int|3
)braket
op_assign
l_int|0x112
suffix:semicolon
multiline_comment|/* transaction context */
id|pMsg
(braket
l_int|4
)braket
op_assign
id|RC_PCI45_VENDOR_ID
op_lshift
l_int|16
op_or
id|RC_PRIVATE_GET_LINK_STATUS
suffix:semicolon
id|pMsg
(braket
l_int|5
)braket
op_assign
id|pPab-&gt;outMsgBlockPhyAddr
op_minus
id|ADAPTER_BLOCK_RESERVED_SPACE
op_plus
r_sizeof
(paren
id|PAB
)paren
suffix:semicolon
id|p32
op_assign
(paren
id|PU32
)paren
(paren
id|pPab-&gt;pLinOutMsgBlock
op_minus
id|ADAPTER_BLOCK_RESERVED_SPACE
op_plus
r_sizeof
(paren
id|PAB
)paren
)paren
suffix:semicolon
op_star
id|p32
op_assign
l_int|0xFFFFFFFF
suffix:semicolon
multiline_comment|/* post to Inbound Post Q */
id|pPab-&gt;p_atu-&gt;InQueue
op_assign
id|msgOffset
suffix:semicolon
id|timeout
op_assign
l_int|100000
suffix:semicolon
r_while
c_loop
(paren
l_int|1
)paren
(brace
id|U32
id|i
suffix:semicolon
r_if
c_cond
(paren
id|WaitCallback
)paren
(paren
op_star
id|WaitCallback
)paren
(paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|1000
suffix:semicolon
id|i
op_increment
)paren
suffix:semicolon
r_if
c_cond
(paren
op_star
id|p32
op_ne
l_int|0xFFFFFFFF
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|timeout
op_decrement
)paren
(brace
macro_line|#ifdef DEBUG
id|kprintf
c_func
(paren
l_string|&quot;Timeout waiting for link status&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif    
r_return
id|RC_RTN_MSG_REPLY_TIMEOUT
suffix:semicolon
)brace
)brace
op_star
id|ReturnAddr
op_assign
op_star
id|p32
suffix:semicolon
multiline_comment|/* 1 = up 0 = down */
r_return
id|RC_RTN_NO_ERROR
suffix:semicolon
)brace
multiline_comment|/*&n;** =========================================================================&n;** RCGetMAC()&n;**&n;** get the MAC address the adapter is listening for in non-promiscous mode.&n;** MAC address is in media format.&n;** =========================================================================&n;*/
id|RC_RETURN
DECL|function|RCGetMAC
id|RCGetMAC
c_func
(paren
id|U16
id|AdapterID
comma
id|PU8
id|mac
comma
id|PFNWAITCALLBACK
id|WaitCallback
)paren
(brace
r_int
id|i
comma
id|timeout
suffix:semicolon
id|U32
id|off
suffix:semicolon
id|PU32
id|p
suffix:semicolon
id|U32
id|temp
(braket
l_int|2
)braket
suffix:semicolon
id|PPAB
id|pPab
suffix:semicolon
id|PATU
id|p_atu
suffix:semicolon
id|pPab
op_assign
id|PCIAdapterBlock
(braket
id|AdapterID
)braket
suffix:semicolon
r_if
c_cond
(paren
id|pPab
op_eq
l_int|NULL
)paren
r_return
id|RC_RTN_ADPTR_NOT_REGISTERED
suffix:semicolon
id|p_atu
op_assign
id|pPab-&gt;p_atu
suffix:semicolon
id|p_atu-&gt;EtherMacLow
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* first zero return data */
id|p_atu-&gt;EtherMacHi
op_assign
l_int|0
suffix:semicolon
id|off
op_assign
id|p_atu-&gt;InQueue
suffix:semicolon
multiline_comment|/* get addresss of message */
r_if
c_cond
(paren
l_int|0xFFFFFFFF
op_eq
id|off
)paren
r_return
id|RC_RTN_FREE_Q_EMPTY
suffix:semicolon
id|p
op_assign
(paren
id|PU32
)paren
(paren
id|pPab-&gt;pPci45LinBaseAddr
op_plus
id|off
)paren
suffix:semicolon
macro_line|#ifdef RCDEBUG
id|printk
c_func
(paren
l_string|&quot;RCGetMAC: p_atu 0x%08x, off 0x%08x, p 0x%08x&bslash;n&quot;
comma
(paren
id|uint
)paren
id|p_atu
comma
(paren
id|uint
)paren
id|off
comma
(paren
id|uint
)paren
id|p
)paren
suffix:semicolon
macro_line|#endif /* RCDEBUG */
multiline_comment|/* setup private message */
id|p
(braket
l_int|0
)braket
op_assign
id|FIVE_WORD_MSG_SIZE
op_or
id|SGL_OFFSET_0
suffix:semicolon
id|p
(braket
l_int|1
)braket
op_assign
id|I2O_PRIVATE
op_lshift
l_int|24
op_or
id|I2O_HOST_TID
op_lshift
l_int|12
op_or
id|RC_LAN_TARGET_ID
suffix:semicolon
id|p
(braket
l_int|2
)braket
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* initiator context */
id|p
(braket
l_int|3
)braket
op_assign
l_int|0x218
suffix:semicolon
multiline_comment|/* transaction context */
id|p
(braket
l_int|4
)braket
op_assign
id|RC_PCI45_VENDOR_ID
op_lshift
l_int|16
op_or
id|RC_PRIVATE_GET_MAC_ADDR
suffix:semicolon
id|p_atu-&gt;InQueue
op_assign
id|off
suffix:semicolon
multiline_comment|/* send it to the I2O device */
macro_line|#ifdef RCDEBUG
id|printk
c_func
(paren
l_string|&quot;RCGetMAC: p_atu 0x%08x, off 0x%08x, p 0x%08x&bslash;n&quot;
comma
(paren
id|uint
)paren
id|p_atu
comma
(paren
id|uint
)paren
id|off
comma
(paren
id|uint
)paren
id|p
)paren
suffix:semicolon
macro_line|#endif /* RCDEBUG */
multiline_comment|/* wait for the rcpci45 board to update the info */
id|timeout
op_assign
l_int|1000000
suffix:semicolon
r_while
c_loop
(paren
l_int|0
op_eq
id|p_atu-&gt;EtherMacLow
)paren
(brace
r_if
c_cond
(paren
id|WaitCallback
)paren
(paren
op_star
id|WaitCallback
)paren
(paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|1000
suffix:semicolon
id|i
op_increment
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|timeout
op_decrement
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;rc_getmac: Timeout&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|RC_RTN_MSG_REPLY_TIMEOUT
suffix:semicolon
)brace
)brace
multiline_comment|/* read the mac address  */
id|temp
(braket
l_int|0
)braket
op_assign
id|p_atu-&gt;EtherMacLow
suffix:semicolon
id|temp
(braket
l_int|1
)braket
op_assign
id|p_atu-&gt;EtherMacHi
suffix:semicolon
id|memcpy
c_func
(paren
(paren
r_char
op_star
)paren
id|mac
comma
(paren
r_char
op_star
)paren
id|temp
comma
l_int|6
)paren
suffix:semicolon
macro_line|#ifdef RCDEBUG
singleline_comment|//    printk(&quot;rc_getmac: 0x%X&bslash;n&quot;, ptr);
macro_line|#endif /* RCDEBUG */
r_return
id|RC_RTN_NO_ERROR
suffix:semicolon
)brace
multiline_comment|/*&n;** =========================================================================&n;** RCSetMAC()&n;**&n;** set MAC address the adapter is listening for in non-promiscous mode.&n;** MAC address is in media format.&n;** =========================================================================&n;*/
id|RC_RETURN
DECL|function|RCSetMAC
id|RCSetMAC
c_func
(paren
id|U16
id|AdapterID
comma
id|PU8
id|mac
)paren
(brace
id|U32
id|off
suffix:semicolon
id|PU32
id|pMsg
suffix:semicolon
id|PPAB
id|pPab
suffix:semicolon
id|pPab
op_assign
id|PCIAdapterBlock
(braket
id|AdapterID
)braket
suffix:semicolon
r_if
c_cond
(paren
id|pPab
op_eq
l_int|NULL
)paren
r_return
id|RC_RTN_ADPTR_NOT_REGISTERED
suffix:semicolon
id|off
op_assign
id|pPab-&gt;p_atu-&gt;InQueue
suffix:semicolon
multiline_comment|/* get addresss of message */
r_if
c_cond
(paren
l_int|0xFFFFFFFF
op_eq
id|off
)paren
r_return
id|RC_RTN_FREE_Q_EMPTY
suffix:semicolon
id|pMsg
op_assign
(paren
id|PU32
)paren
(paren
id|pPab-&gt;pPci45LinBaseAddr
op_plus
id|off
)paren
suffix:semicolon
multiline_comment|/* setup private message */
id|pMsg
(braket
l_int|0
)braket
op_assign
id|SEVEN_WORD_MSG_SIZE
op_or
id|SGL_OFFSET_0
suffix:semicolon
id|pMsg
(braket
l_int|1
)braket
op_assign
id|I2O_PRIVATE
op_lshift
l_int|24
op_or
id|I2O_HOST_TID
op_lshift
l_int|12
op_or
id|RC_LAN_TARGET_ID
suffix:semicolon
id|pMsg
(braket
l_int|2
)braket
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* initiator context */
id|pMsg
(braket
l_int|3
)braket
op_assign
l_int|0x219
suffix:semicolon
multiline_comment|/* transaction context */
id|pMsg
(braket
l_int|4
)braket
op_assign
id|RC_PCI45_VENDOR_ID
op_lshift
l_int|16
op_or
id|RC_PRIVATE_SET_MAC_ADDR
suffix:semicolon
id|pMsg
(braket
l_int|5
)braket
op_assign
op_star
(paren
r_int
op_star
)paren
id|mac
suffix:semicolon
multiline_comment|/* first four bytes */
id|pMsg
(braket
l_int|6
)braket
op_assign
op_star
(paren
r_int
op_star
)paren
(paren
id|mac
op_plus
l_int|4
)paren
suffix:semicolon
multiline_comment|/* last two bytes */
id|pPab-&gt;p_atu-&gt;InQueue
op_assign
id|off
suffix:semicolon
multiline_comment|/* send it to the I2O device */
r_return
id|RC_RTN_NO_ERROR
suffix:semicolon
)brace
multiline_comment|/*&n;** =========================================================================&n;** RCSetLinkSpeed()&n;**&n;** set ethernet link speed. &n;** input: speedControl - determines action to take as follows&n;**          0 = reset and auto-negotiate (NWay)&n;**          1 = Full Duplex 100BaseT&n;**          2 = Half duplex 100BaseT&n;**          3 = Full Duplex  10BaseT&n;**          4 = Half duplex  10BaseT&n;**          all other values are ignore (do nothing)&n;** =========================================================================&n;*/
id|RC_RETURN
DECL|function|RCSetLinkSpeed
id|RCSetLinkSpeed
c_func
(paren
id|U16
id|AdapterID
comma
id|U16
id|LinkSpeedCode
)paren
(brace
id|U32
id|off
suffix:semicolon
id|PU32
id|pMsg
suffix:semicolon
id|PPAB
id|pPab
suffix:semicolon
id|pPab
op_assign
id|PCIAdapterBlock
(braket
id|AdapterID
)braket
suffix:semicolon
r_if
c_cond
(paren
id|pPab
op_eq
l_int|NULL
)paren
r_return
id|RC_RTN_ADPTR_NOT_REGISTERED
suffix:semicolon
id|off
op_assign
id|pPab-&gt;p_atu-&gt;InQueue
suffix:semicolon
multiline_comment|/* get addresss of message */
r_if
c_cond
(paren
l_int|0xFFFFFFFF
op_eq
id|off
)paren
r_return
id|RC_RTN_FREE_Q_EMPTY
suffix:semicolon
id|pMsg
op_assign
(paren
id|PU32
)paren
(paren
id|pPab-&gt;pPci45LinBaseAddr
op_plus
id|off
)paren
suffix:semicolon
multiline_comment|/* setup private message */
id|pMsg
(braket
l_int|0
)braket
op_assign
id|SIX_WORD_MSG_SIZE
op_or
id|SGL_OFFSET_0
suffix:semicolon
id|pMsg
(braket
l_int|1
)braket
op_assign
id|I2O_PRIVATE
op_lshift
l_int|24
op_or
id|I2O_HOST_TID
op_lshift
l_int|12
op_or
id|RC_LAN_TARGET_ID
suffix:semicolon
id|pMsg
(braket
l_int|2
)braket
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* initiator context */
id|pMsg
(braket
l_int|3
)braket
op_assign
l_int|0x219
suffix:semicolon
multiline_comment|/* transaction context */
id|pMsg
(braket
l_int|4
)braket
op_assign
id|RC_PCI45_VENDOR_ID
op_lshift
l_int|16
op_or
id|RC_PRIVATE_SET_LINK_SPEED
suffix:semicolon
id|pMsg
(braket
l_int|5
)braket
op_assign
id|LinkSpeedCode
suffix:semicolon
multiline_comment|/* link speed code */
id|pPab-&gt;p_atu-&gt;InQueue
op_assign
id|off
suffix:semicolon
multiline_comment|/* send it to the I2O device */
r_return
id|RC_RTN_NO_ERROR
suffix:semicolon
)brace
multiline_comment|/*&n;** =========================================================================&n;** RCSetPromiscuousMode()&n;**&n;** Defined values for Mode:&n;**  0 - turn off promiscuous mode&n;**  1 - turn on  promiscuous mode&n;**&n;** =========================================================================&n;*/
id|RC_RETURN
DECL|function|RCSetPromiscuousMode
id|RCSetPromiscuousMode
c_func
(paren
id|U16
id|AdapterID
comma
id|U16
id|Mode
)paren
(brace
id|U32
id|off
suffix:semicolon
id|PU32
id|pMsg
suffix:semicolon
id|PPAB
id|pPab
suffix:semicolon
id|pPab
op_assign
id|PCIAdapterBlock
(braket
id|AdapterID
)braket
suffix:semicolon
r_if
c_cond
(paren
id|pPab
op_eq
l_int|NULL
)paren
r_return
id|RC_RTN_ADPTR_NOT_REGISTERED
suffix:semicolon
id|off
op_assign
id|pPab-&gt;p_atu-&gt;InQueue
suffix:semicolon
multiline_comment|/* get addresss of message */
r_if
c_cond
(paren
l_int|0xFFFFFFFF
op_eq
id|off
)paren
r_return
id|RC_RTN_FREE_Q_EMPTY
suffix:semicolon
id|pMsg
op_assign
(paren
id|PU32
)paren
(paren
id|pPab-&gt;pPci45LinBaseAddr
op_plus
id|off
)paren
suffix:semicolon
multiline_comment|/* setup private message */
id|pMsg
(braket
l_int|0
)braket
op_assign
id|SIX_WORD_MSG_SIZE
op_or
id|SGL_OFFSET_0
suffix:semicolon
id|pMsg
(braket
l_int|1
)braket
op_assign
id|I2O_PRIVATE
op_lshift
l_int|24
op_or
id|I2O_HOST_TID
op_lshift
l_int|12
op_or
id|RC_LAN_TARGET_ID
suffix:semicolon
id|pMsg
(braket
l_int|2
)braket
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* initiator context */
id|pMsg
(braket
l_int|3
)braket
op_assign
l_int|0x219
suffix:semicolon
multiline_comment|/* transaction context */
id|pMsg
(braket
l_int|4
)braket
op_assign
id|RC_PCI45_VENDOR_ID
op_lshift
l_int|16
op_or
id|RC_PRIVATE_SET_PROMISCUOUS_MODE
suffix:semicolon
id|pMsg
(braket
l_int|5
)braket
op_assign
id|Mode
suffix:semicolon
multiline_comment|/* promiscuous mode setting */
id|pPab-&gt;p_atu-&gt;InQueue
op_assign
id|off
suffix:semicolon
multiline_comment|/* send it to the device */
r_return
id|RC_RTN_NO_ERROR
suffix:semicolon
)brace
multiline_comment|/*&n;** =========================================================================&n;** RCGetPromiscuousMode()&n;**&n;** get promiscuous mode setting&n;**&n;** Possible return values placed in pMode:&n;**  0 = promisuous mode not set&n;**  1 = promisuous mode is set&n;**&n;** =========================================================================&n;*/
id|RC_RETURN
DECL|function|RCGetPromiscuousMode
id|RCGetPromiscuousMode
c_func
(paren
id|U16
id|AdapterID
comma
id|PU32
id|pMode
comma
id|PFNWAITCALLBACK
id|WaitCallback
)paren
(brace
id|U32
id|msgOffset
comma
id|timeout
suffix:semicolon
id|PU32
id|pMsg
suffix:semicolon
r_volatile
id|PU32
id|p32
suffix:semicolon
id|PPAB
id|pPab
suffix:semicolon
id|pPab
op_assign
id|PCIAdapterBlock
(braket
id|AdapterID
)braket
suffix:semicolon
id|msgOffset
op_assign
id|pPab-&gt;p_atu-&gt;InQueue
suffix:semicolon
r_if
c_cond
(paren
id|msgOffset
op_eq
l_int|0xFFFFFFFF
)paren
(brace
id|kprintf
c_func
(paren
l_string|&quot;RCGetLinkSpeed(): Inbound Free Q empty!&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|RC_RTN_FREE_Q_EMPTY
suffix:semicolon
)brace
multiline_comment|/* calc virtual address of msg - virtual already mapped to physical */
id|pMsg
op_assign
(paren
id|PU32
)paren
(paren
id|pPab-&gt;pPci45LinBaseAddr
op_plus
id|msgOffset
)paren
suffix:semicolon
multiline_comment|/* virtual pointer to return buffer - clear first two dwords */
id|p32
op_assign
(paren
r_volatile
id|PU32
)paren
(paren
id|pPab-&gt;pLinOutMsgBlock
op_minus
id|ADAPTER_BLOCK_RESERVED_SPACE
op_plus
r_sizeof
(paren
id|PAB
)paren
)paren
suffix:semicolon
id|p32
(braket
l_int|0
)braket
op_assign
l_int|0xff
suffix:semicolon
multiline_comment|/* setup private message */
id|pMsg
(braket
l_int|0
)braket
op_assign
id|SIX_WORD_MSG_SIZE
op_or
id|SGL_OFFSET_0
suffix:semicolon
id|pMsg
(braket
l_int|1
)braket
op_assign
id|I2O_PRIVATE
op_lshift
l_int|24
op_or
id|I2O_HOST_TID
op_lshift
l_int|12
op_or
id|RC_LAN_TARGET_ID
suffix:semicolon
id|pMsg
(braket
l_int|2
)braket
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* initiator context */
id|pMsg
(braket
l_int|3
)braket
op_assign
l_int|0x219
suffix:semicolon
multiline_comment|/* transaction context */
id|pMsg
(braket
l_int|4
)braket
op_assign
id|RC_PCI45_VENDOR_ID
op_lshift
l_int|16
op_or
id|RC_PRIVATE_GET_PROMISCUOUS_MODE
suffix:semicolon
multiline_comment|/* phys address to return status - area right after PAB */
id|pMsg
(braket
l_int|5
)braket
op_assign
id|pPab-&gt;outMsgBlockPhyAddr
op_minus
id|ADAPTER_BLOCK_RESERVED_SPACE
op_plus
r_sizeof
(paren
id|PAB
)paren
suffix:semicolon
multiline_comment|/* post to Inbound Post Q */
id|pPab-&gt;p_atu-&gt;InQueue
op_assign
id|msgOffset
suffix:semicolon
multiline_comment|/* wait for response */
id|timeout
op_assign
l_int|1000000
suffix:semicolon
r_while
c_loop
(paren
l_int|1
)paren
(brace
r_int
id|i
suffix:semicolon
r_if
c_cond
(paren
id|WaitCallback
)paren
(paren
op_star
id|WaitCallback
)paren
(paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|1000
suffix:semicolon
id|i
op_increment
)paren
multiline_comment|/* please don&squot;t hog the bus!!! */
suffix:semicolon
r_if
c_cond
(paren
id|p32
(braket
l_int|0
)braket
op_ne
l_int|0xff
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|timeout
op_decrement
)paren
(brace
id|kprintf
c_func
(paren
l_string|&quot;Timeout waiting for promiscuous mode from adapter&bslash;n&quot;
)paren
suffix:semicolon
id|kprintf
c_func
(paren
l_string|&quot;0x%8.8lx&bslash;n&quot;
comma
id|p32
(braket
l_int|0
)braket
)paren
suffix:semicolon
r_return
id|RC_RTN_NO_LINK_SPEED
suffix:semicolon
)brace
)brace
multiline_comment|/* get mode */
op_star
id|pMode
op_assign
(paren
id|U8
)paren
(paren
(paren
r_volatile
id|PU8
)paren
id|p32
)paren
(braket
l_int|0
)braket
op_amp
l_int|0x0f
suffix:semicolon
r_return
id|RC_RTN_NO_ERROR
suffix:semicolon
)brace
multiline_comment|/*&n;** =========================================================================&n;** RCSetBroadcastMode()&n;**&n;** Defined values for Mode:&n;**  0 - turn off promiscuous mode&n;**  1 - turn on  promiscuous mode&n;**&n;** =========================================================================&n;*/
id|RC_RETURN
DECL|function|RCSetBroadcastMode
id|RCSetBroadcastMode
c_func
(paren
id|U16
id|AdapterID
comma
id|U16
id|Mode
)paren
(brace
id|U32
id|off
suffix:semicolon
id|PU32
id|pMsg
suffix:semicolon
id|PPAB
id|pPab
suffix:semicolon
id|pPab
op_assign
id|PCIAdapterBlock
(braket
id|AdapterID
)braket
suffix:semicolon
r_if
c_cond
(paren
id|pPab
op_eq
l_int|NULL
)paren
r_return
id|RC_RTN_ADPTR_NOT_REGISTERED
suffix:semicolon
id|off
op_assign
id|pPab-&gt;p_atu-&gt;InQueue
suffix:semicolon
multiline_comment|/* get addresss of message */
r_if
c_cond
(paren
l_int|0xFFFFFFFF
op_eq
id|off
)paren
r_return
id|RC_RTN_FREE_Q_EMPTY
suffix:semicolon
id|pMsg
op_assign
(paren
id|PU32
)paren
(paren
id|pPab-&gt;pPci45LinBaseAddr
op_plus
id|off
)paren
suffix:semicolon
multiline_comment|/* setup private message */
id|pMsg
(braket
l_int|0
)braket
op_assign
id|SIX_WORD_MSG_SIZE
op_or
id|SGL_OFFSET_0
suffix:semicolon
id|pMsg
(braket
l_int|1
)braket
op_assign
id|I2O_PRIVATE
op_lshift
l_int|24
op_or
id|I2O_HOST_TID
op_lshift
l_int|12
op_or
id|RC_LAN_TARGET_ID
suffix:semicolon
id|pMsg
(braket
l_int|2
)braket
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* initiator context */
id|pMsg
(braket
l_int|3
)braket
op_assign
l_int|0x219
suffix:semicolon
multiline_comment|/* transaction context */
id|pMsg
(braket
l_int|4
)braket
op_assign
id|RC_PCI45_VENDOR_ID
op_lshift
l_int|16
op_or
id|RC_PRIVATE_SET_BROADCAST_MODE
suffix:semicolon
id|pMsg
(braket
l_int|5
)braket
op_assign
id|Mode
suffix:semicolon
multiline_comment|/* promiscuous mode setting */
id|pPab-&gt;p_atu-&gt;InQueue
op_assign
id|off
suffix:semicolon
multiline_comment|/* send it to the device */
r_return
id|RC_RTN_NO_ERROR
suffix:semicolon
)brace
multiline_comment|/*&n;** =========================================================================&n;** RCGetBroadcastMode()&n;**&n;** get promiscuous mode setting&n;**&n;** Possible return values placed in pMode:&n;**  0 = promisuous mode not set&n;**  1 = promisuous mode is set&n;**&n;** =========================================================================&n;*/
id|RC_RETURN
DECL|function|RCGetBroadcastMode
id|RCGetBroadcastMode
c_func
(paren
id|U16
id|AdapterID
comma
id|PU32
id|pMode
comma
id|PFNWAITCALLBACK
id|WaitCallback
)paren
(brace
id|U32
id|msgOffset
comma
id|timeout
suffix:semicolon
id|PU32
id|pMsg
suffix:semicolon
r_volatile
id|PU32
id|p32
suffix:semicolon
id|PPAB
id|pPab
suffix:semicolon
id|pPab
op_assign
id|PCIAdapterBlock
(braket
id|AdapterID
)braket
suffix:semicolon
id|msgOffset
op_assign
id|pPab-&gt;p_atu-&gt;InQueue
suffix:semicolon
r_if
c_cond
(paren
id|msgOffset
op_eq
l_int|0xFFFFFFFF
)paren
(brace
id|kprintf
c_func
(paren
l_string|&quot;RCGetLinkSpeed(): Inbound Free Q empty!&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|RC_RTN_FREE_Q_EMPTY
suffix:semicolon
)brace
multiline_comment|/* calc virtual address of msg - virtual already mapped to physical */
id|pMsg
op_assign
(paren
id|PU32
)paren
(paren
id|pPab-&gt;pPci45LinBaseAddr
op_plus
id|msgOffset
)paren
suffix:semicolon
multiline_comment|/* virtual pointer to return buffer - clear first two dwords */
id|p32
op_assign
(paren
r_volatile
id|PU32
)paren
(paren
id|pPab-&gt;pLinOutMsgBlock
op_minus
id|ADAPTER_BLOCK_RESERVED_SPACE
op_plus
r_sizeof
(paren
id|PAB
)paren
)paren
suffix:semicolon
id|p32
(braket
l_int|0
)braket
op_assign
l_int|0xff
suffix:semicolon
multiline_comment|/* setup private message */
id|pMsg
(braket
l_int|0
)braket
op_assign
id|SIX_WORD_MSG_SIZE
op_or
id|SGL_OFFSET_0
suffix:semicolon
id|pMsg
(braket
l_int|1
)braket
op_assign
id|I2O_PRIVATE
op_lshift
l_int|24
op_or
id|I2O_HOST_TID
op_lshift
l_int|12
op_or
id|RC_LAN_TARGET_ID
suffix:semicolon
id|pMsg
(braket
l_int|2
)braket
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* initiator context */
id|pMsg
(braket
l_int|3
)braket
op_assign
l_int|0x219
suffix:semicolon
multiline_comment|/* transaction context */
id|pMsg
(braket
l_int|4
)braket
op_assign
id|RC_PCI45_VENDOR_ID
op_lshift
l_int|16
op_or
id|RC_PRIVATE_GET_BROADCAST_MODE
suffix:semicolon
multiline_comment|/* phys address to return status - area right after PAB */
id|pMsg
(braket
l_int|5
)braket
op_assign
id|pPab-&gt;outMsgBlockPhyAddr
op_minus
id|ADAPTER_BLOCK_RESERVED_SPACE
op_plus
r_sizeof
(paren
id|PAB
)paren
suffix:semicolon
multiline_comment|/* post to Inbound Post Q */
id|pPab-&gt;p_atu-&gt;InQueue
op_assign
id|msgOffset
suffix:semicolon
multiline_comment|/* wait for response */
id|timeout
op_assign
l_int|1000000
suffix:semicolon
r_while
c_loop
(paren
l_int|1
)paren
(brace
r_int
id|i
suffix:semicolon
r_if
c_cond
(paren
id|WaitCallback
)paren
(paren
op_star
id|WaitCallback
)paren
(paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|1000
suffix:semicolon
id|i
op_increment
)paren
multiline_comment|/* please don&squot;t hog the bus!!! */
suffix:semicolon
r_if
c_cond
(paren
id|p32
(braket
l_int|0
)braket
op_ne
l_int|0xff
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|timeout
op_decrement
)paren
(brace
id|kprintf
c_func
(paren
l_string|&quot;Timeout waiting for promiscuous mode from adapter&bslash;n&quot;
)paren
suffix:semicolon
id|kprintf
c_func
(paren
l_string|&quot;0x%8.8lx&bslash;n&quot;
comma
id|p32
(braket
l_int|0
)braket
)paren
suffix:semicolon
r_return
id|RC_RTN_NO_LINK_SPEED
suffix:semicolon
)brace
)brace
multiline_comment|/* get mode */
op_star
id|pMode
op_assign
(paren
id|U8
)paren
(paren
(paren
r_volatile
id|PU8
)paren
id|p32
)paren
(braket
l_int|0
)braket
op_amp
l_int|0x0f
suffix:semicolon
r_return
id|RC_RTN_NO_ERROR
suffix:semicolon
)brace
multiline_comment|/*&n;** =========================================================================&n;** RCGetLinkSpeed()&n;**&n;** get ethernet link speed. &n;**&n;** 0 = Unknown&n;** 1 = Full Duplex 100BaseT&n;** 2 = Half duplex 100BaseT&n;** 3 = Full Duplex  10BaseT&n;** 4 = Half duplex  10BaseT&n;**&n;** =========================================================================&n;*/
id|RC_RETURN
DECL|function|RCGetLinkSpeed
id|RCGetLinkSpeed
c_func
(paren
id|U16
id|AdapterID
comma
id|PU32
id|pLinkSpeedCode
comma
id|PFNWAITCALLBACK
id|WaitCallback
)paren
(brace
id|U32
id|msgOffset
comma
id|timeout
suffix:semicolon
id|PU32
id|pMsg
suffix:semicolon
r_volatile
id|PU32
id|p32
suffix:semicolon
id|U8
id|IOPLinkSpeed
suffix:semicolon
id|PPAB
id|pPab
suffix:semicolon
id|pPab
op_assign
id|PCIAdapterBlock
(braket
id|AdapterID
)braket
suffix:semicolon
id|msgOffset
op_assign
id|pPab-&gt;p_atu-&gt;InQueue
suffix:semicolon
r_if
c_cond
(paren
id|msgOffset
op_eq
l_int|0xFFFFFFFF
)paren
(brace
id|kprintf
c_func
(paren
l_string|&quot;RCGetLinkSpeed(): Inbound Free Q empty!&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|RC_RTN_FREE_Q_EMPTY
suffix:semicolon
)brace
multiline_comment|/* calc virtual address of msg - virtual already mapped to physical */
id|pMsg
op_assign
(paren
id|PU32
)paren
(paren
id|pPab-&gt;pPci45LinBaseAddr
op_plus
id|msgOffset
)paren
suffix:semicolon
multiline_comment|/* virtual pointer to return buffer - clear first two dwords */
id|p32
op_assign
(paren
r_volatile
id|PU32
)paren
(paren
id|pPab-&gt;pLinOutMsgBlock
op_minus
id|ADAPTER_BLOCK_RESERVED_SPACE
op_plus
r_sizeof
(paren
id|PAB
)paren
)paren
suffix:semicolon
id|p32
(braket
l_int|0
)braket
op_assign
l_int|0xff
suffix:semicolon
multiline_comment|/* setup private message */
id|pMsg
(braket
l_int|0
)braket
op_assign
id|SIX_WORD_MSG_SIZE
op_or
id|SGL_OFFSET_0
suffix:semicolon
id|pMsg
(braket
l_int|1
)braket
op_assign
id|I2O_PRIVATE
op_lshift
l_int|24
op_or
id|I2O_HOST_TID
op_lshift
l_int|12
op_or
id|RC_LAN_TARGET_ID
suffix:semicolon
id|pMsg
(braket
l_int|2
)braket
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* initiator context */
id|pMsg
(braket
l_int|3
)braket
op_assign
l_int|0x219
suffix:semicolon
multiline_comment|/* transaction context */
id|pMsg
(braket
l_int|4
)braket
op_assign
id|RC_PCI45_VENDOR_ID
op_lshift
l_int|16
op_or
id|RC_PRIVATE_GET_LINK_SPEED
suffix:semicolon
multiline_comment|/* phys address to return status - area right after PAB */
id|pMsg
(braket
l_int|5
)braket
op_assign
id|pPab-&gt;outMsgBlockPhyAddr
op_minus
id|ADAPTER_BLOCK_RESERVED_SPACE
op_plus
r_sizeof
(paren
id|PAB
)paren
suffix:semicolon
multiline_comment|/* post to Inbound Post Q */
id|pPab-&gt;p_atu-&gt;InQueue
op_assign
id|msgOffset
suffix:semicolon
multiline_comment|/* wait for response */
id|timeout
op_assign
l_int|1000000
suffix:semicolon
r_while
c_loop
(paren
l_int|1
)paren
(brace
r_int
id|i
suffix:semicolon
r_if
c_cond
(paren
id|WaitCallback
)paren
(paren
op_star
id|WaitCallback
)paren
(paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|1000
suffix:semicolon
id|i
op_increment
)paren
multiline_comment|/* please don&squot;t hog the bus!!! */
suffix:semicolon
r_if
c_cond
(paren
id|p32
(braket
l_int|0
)braket
op_ne
l_int|0xff
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|timeout
op_decrement
)paren
(brace
id|kprintf
c_func
(paren
l_string|&quot;Timeout waiting for link speed from IOP&bslash;n&quot;
)paren
suffix:semicolon
id|kprintf
c_func
(paren
l_string|&quot;0x%8.8lx&bslash;n&quot;
comma
id|p32
(braket
l_int|0
)braket
)paren
suffix:semicolon
r_return
id|RC_RTN_NO_LINK_SPEED
suffix:semicolon
)brace
)brace
multiline_comment|/* get Link speed */
id|IOPLinkSpeed
op_assign
(paren
id|U8
)paren
(paren
(paren
r_volatile
id|PU8
)paren
id|p32
)paren
(braket
l_int|0
)braket
op_amp
l_int|0x0f
suffix:semicolon
op_star
id|pLinkSpeedCode
op_assign
id|IOPLinkSpeed
suffix:semicolon
r_return
id|RC_RTN_NO_ERROR
suffix:semicolon
)brace
multiline_comment|/*&n;** =========================================================================&n;** RCReportDriverCapability(U16 AdapterID, U32 capability)&n;**&n;** Currently defined bits:&n;** WARM_REBOOT_CAPABLE   0x01&n;**&n;** =========================================================================&n;*/
id|RC_RETURN
DECL|function|RCReportDriverCapability
id|RCReportDriverCapability
c_func
(paren
id|U16
id|AdapterID
comma
id|U32
id|capability
)paren
(brace
id|U32
id|off
suffix:semicolon
id|PU32
id|pMsg
suffix:semicolon
id|PPAB
id|pPab
suffix:semicolon
id|pPab
op_assign
id|PCIAdapterBlock
(braket
id|AdapterID
)braket
suffix:semicolon
r_if
c_cond
(paren
id|pPab
op_eq
l_int|NULL
)paren
r_return
id|RC_RTN_ADPTR_NOT_REGISTERED
suffix:semicolon
id|off
op_assign
id|pPab-&gt;p_atu-&gt;InQueue
suffix:semicolon
multiline_comment|/* get addresss of message */
r_if
c_cond
(paren
l_int|0xFFFFFFFF
op_eq
id|off
)paren
r_return
id|RC_RTN_FREE_Q_EMPTY
suffix:semicolon
id|pMsg
op_assign
(paren
id|PU32
)paren
(paren
id|pPab-&gt;pPci45LinBaseAddr
op_plus
id|off
)paren
suffix:semicolon
multiline_comment|/* setup private message */
id|pMsg
(braket
l_int|0
)braket
op_assign
id|SIX_WORD_MSG_SIZE
op_or
id|SGL_OFFSET_0
suffix:semicolon
id|pMsg
(braket
l_int|1
)braket
op_assign
id|I2O_PRIVATE
op_lshift
l_int|24
op_or
id|I2O_HOST_TID
op_lshift
l_int|12
op_or
id|RC_LAN_TARGET_ID
suffix:semicolon
id|pMsg
(braket
l_int|2
)braket
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* initiator context */
id|pMsg
(braket
l_int|3
)braket
op_assign
l_int|0x219
suffix:semicolon
multiline_comment|/* transaction context */
id|pMsg
(braket
l_int|4
)braket
op_assign
id|RC_PCI45_VENDOR_ID
op_lshift
l_int|16
op_or
id|RC_PRIVATE_REPORT_DRIVER_CAPABILITY
suffix:semicolon
id|pMsg
(braket
l_int|5
)braket
op_assign
id|capability
suffix:semicolon
id|pPab-&gt;p_atu-&gt;InQueue
op_assign
id|off
suffix:semicolon
multiline_comment|/* send it to the I2O device */
r_return
id|RC_RTN_NO_ERROR
suffix:semicolon
)brace
multiline_comment|/*&n;** =========================================================================&n;** RCGetFirmwareVer()&n;**&n;** Return firmware version in the form &quot;SoftwareVersion : Bt BootVersion&quot;&n;**&n;** =========================================================================&n;*/
id|RC_RETURN
DECL|function|RCGetFirmwareVer
id|RCGetFirmwareVer
c_func
(paren
id|U16
id|AdapterID
comma
id|PU8
id|pFirmString
comma
id|PFNWAITCALLBACK
id|WaitCallback
)paren
(brace
id|U32
id|msgOffset
comma
id|timeout
suffix:semicolon
id|PU32
id|pMsg
suffix:semicolon
r_volatile
id|PU32
id|p32
suffix:semicolon
id|PPAB
id|pPab
suffix:semicolon
id|pPab
op_assign
id|PCIAdapterBlock
(braket
id|AdapterID
)braket
suffix:semicolon
id|msgOffset
op_assign
id|pPab-&gt;p_atu-&gt;InQueue
suffix:semicolon
r_if
c_cond
(paren
id|msgOffset
op_eq
l_int|0xFFFFFFFF
)paren
(brace
id|kprintf
c_func
(paren
l_string|&quot;RCGetFirmwareVer(): Inbound Free Q empty!&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|RC_RTN_FREE_Q_EMPTY
suffix:semicolon
)brace
multiline_comment|/* calc virtual address of msg - virtual already mapped to physical */
id|pMsg
op_assign
(paren
id|PU32
)paren
(paren
id|pPab-&gt;pPci45LinBaseAddr
op_plus
id|msgOffset
)paren
suffix:semicolon
multiline_comment|/* virtual pointer to return buffer - clear first two dwords */
id|p32
op_assign
(paren
r_volatile
id|PU32
)paren
(paren
id|pPab-&gt;pLinOutMsgBlock
op_minus
id|ADAPTER_BLOCK_RESERVED_SPACE
op_plus
r_sizeof
(paren
id|PAB
)paren
)paren
suffix:semicolon
id|p32
(braket
l_int|0
)braket
op_assign
l_int|0xff
suffix:semicolon
multiline_comment|/* setup private message */
id|pMsg
(braket
l_int|0
)braket
op_assign
id|SIX_WORD_MSG_SIZE
op_or
id|SGL_OFFSET_0
suffix:semicolon
id|pMsg
(braket
l_int|1
)braket
op_assign
id|I2O_PRIVATE
op_lshift
l_int|24
op_or
id|I2O_HOST_TID
op_lshift
l_int|12
op_or
id|RC_LAN_TARGET_ID
suffix:semicolon
id|pMsg
(braket
l_int|2
)braket
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* initiator context */
id|pMsg
(braket
l_int|3
)braket
op_assign
l_int|0x219
suffix:semicolon
multiline_comment|/* transaction context */
id|pMsg
(braket
l_int|4
)braket
op_assign
id|RC_PCI45_VENDOR_ID
op_lshift
l_int|16
op_or
id|RC_PRIVATE_GET_FIRMWARE_REV
suffix:semicolon
multiline_comment|/* phys address to return status - area right after PAB */
id|pMsg
(braket
l_int|5
)braket
op_assign
id|pPab-&gt;outMsgBlockPhyAddr
op_minus
id|ADAPTER_BLOCK_RESERVED_SPACE
op_plus
r_sizeof
(paren
id|PAB
)paren
suffix:semicolon
multiline_comment|/* post to Inbound Post Q */
id|pPab-&gt;p_atu-&gt;InQueue
op_assign
id|msgOffset
suffix:semicolon
multiline_comment|/* wait for response */
id|timeout
op_assign
l_int|1000000
suffix:semicolon
r_while
c_loop
(paren
l_int|1
)paren
(brace
r_int
id|i
suffix:semicolon
r_if
c_cond
(paren
id|WaitCallback
)paren
(paren
op_star
id|WaitCallback
)paren
(paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|1000
suffix:semicolon
id|i
op_increment
)paren
multiline_comment|/* please don&squot;t hog the bus!!! */
suffix:semicolon
r_if
c_cond
(paren
id|p32
(braket
l_int|0
)braket
op_ne
l_int|0xff
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|timeout
op_decrement
)paren
(brace
id|kprintf
c_func
(paren
l_string|&quot;Timeout waiting for link speed from IOP&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|RC_RTN_NO_FIRM_VER
suffix:semicolon
)brace
)brace
id|strcpy
c_func
(paren
id|pFirmString
comma
(paren
id|PU8
)paren
id|p32
)paren
suffix:semicolon
r_return
id|RC_RTN_NO_ERROR
suffix:semicolon
)brace
multiline_comment|/*&n;** =========================================================================&n;** RCResetLANCard()&n;**&n;** ResourceFlags indicates whether to return buffer resource explicitly&n;** to host or keep and reuse.&n;** CallbackFunction (if not NULL) is the function to be called when &n;** reset is complete.&n;** If CallbackFunction is NULL, ReturnAddr will have a 1 placed in it when&n;** reset is done (if not NULL).&n;**&n;** =========================================================================&n;*/
id|RC_RETURN
DECL|function|RCResetLANCard
id|RCResetLANCard
c_func
(paren
id|U16
id|AdapterID
comma
id|U16
id|ResourceFlags
comma
id|PU32
id|ReturnAddr
comma
id|PFNCALLBACK
id|CallbackFunction
)paren
(brace
r_int
r_int
id|off
suffix:semicolon
id|PU32
id|pMsg
suffix:semicolon
id|PPAB
id|pPab
suffix:semicolon
r_int
id|i
suffix:semicolon
r_int
id|timeout
op_assign
l_int|0
suffix:semicolon
id|pPab
op_assign
id|PCIAdapterBlock
(braket
id|AdapterID
)braket
suffix:semicolon
r_if
c_cond
(paren
id|pPab
op_eq
l_int|NULL
)paren
r_return
id|RC_RTN_ADPTR_NOT_REGISTERED
suffix:semicolon
id|off
op_assign
id|pPab-&gt;p_atu-&gt;InQueue
suffix:semicolon
multiline_comment|/* get addresss of message */
r_if
c_cond
(paren
l_int|0xFFFFFFFF
op_eq
id|off
)paren
r_return
id|RC_RTN_FREE_Q_EMPTY
suffix:semicolon
id|pPab-&gt;pCallbackFunc
op_assign
id|CallbackFunction
suffix:semicolon
id|pMsg
op_assign
(paren
id|PU32
)paren
(paren
id|pPab-&gt;pPci45LinBaseAddr
op_plus
id|off
)paren
suffix:semicolon
multiline_comment|/* setup message */
id|pMsg
(braket
l_int|0
)braket
op_assign
id|FOUR_WORD_MSG_SIZE
op_or
id|SGL_OFFSET_0
suffix:semicolon
id|pMsg
(braket
l_int|1
)braket
op_assign
id|I2O_LAN_RESET
op_lshift
l_int|24
op_or
id|I2O_HOST_TID
op_lshift
l_int|12
op_or
id|RC_LAN_TARGET_ID
suffix:semicolon
id|pMsg
(braket
l_int|2
)braket
op_assign
id|DEFAULT_RECV_INIT_CONTEXT
suffix:semicolon
id|pMsg
(braket
l_int|3
)braket
op_assign
id|ResourceFlags
op_lshift
l_int|16
suffix:semicolon
multiline_comment|/* resource flags */
id|pPab-&gt;p_atu-&gt;InQueue
op_assign
id|off
suffix:semicolon
multiline_comment|/* send it to the I2O device */
r_if
c_cond
(paren
id|CallbackFunction
op_eq
(paren
id|PFNCALLBACK
)paren
l_int|NULL
)paren
(brace
multiline_comment|/* call RCProcI2OMsgQ() until something in pPab-&gt;pCallbackFunc&n;           or until timer goes off */
r_while
c_loop
(paren
id|pPab-&gt;pCallbackFunc
op_eq
(paren
id|PFNCALLBACK
)paren
l_int|NULL
)paren
(brace
id|RCProcI2OMsgQ
c_func
(paren
id|AdapterID
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|100000
suffix:semicolon
id|i
op_increment
)paren
multiline_comment|/* please don&squot;t hog the bus!!! */
suffix:semicolon
id|timeout
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|timeout
OG
l_int|10000
)paren
(brace
r_break
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|ReturnAddr
op_ne
(paren
id|PU32
)paren
l_int|NULL
)paren
op_star
id|ReturnAddr
op_assign
(paren
id|U32
)paren
id|pPab-&gt;pCallbackFunc
suffix:semicolon
)brace
r_return
id|RC_RTN_NO_ERROR
suffix:semicolon
)brace
multiline_comment|/*&n;** =========================================================================&n;** RCResetIOP()&n;**&n;** Send StatusGet Msg, wait for results return directly to buffer.&n;**&n;** =========================================================================&n;*/
id|RC_RETURN
DECL|function|RCResetIOP
id|RCResetIOP
c_func
(paren
id|U16
id|AdapterID
)paren
(brace
id|U32
id|msgOffset
comma
id|timeout
suffix:semicolon
id|PU32
id|pMsg
suffix:semicolon
id|PPAB
id|pPab
suffix:semicolon
r_volatile
id|PU32
id|p32
suffix:semicolon
id|pPab
op_assign
id|PCIAdapterBlock
(braket
id|AdapterID
)braket
suffix:semicolon
id|msgOffset
op_assign
id|pPab-&gt;p_atu-&gt;InQueue
suffix:semicolon
r_if
c_cond
(paren
id|msgOffset
op_eq
l_int|0xFFFFFFFF
)paren
(brace
r_return
id|RC_RTN_FREE_Q_EMPTY
suffix:semicolon
)brace
multiline_comment|/* calc virtual address of msg - virtual already mapped to physical */
id|pMsg
op_assign
(paren
id|PU32
)paren
(paren
id|pPab-&gt;pPci45LinBaseAddr
op_plus
id|msgOffset
)paren
suffix:semicolon
id|pMsg
(braket
l_int|0
)braket
op_assign
id|NINE_WORD_MSG_SIZE
op_or
id|SGL_OFFSET_0
suffix:semicolon
id|pMsg
(braket
l_int|1
)braket
op_assign
id|I2O_EXEC_IOP_RESET
op_lshift
l_int|24
op_or
id|I2O_HOST_TID
op_lshift
l_int|12
op_or
id|I2O_IOP_TID
suffix:semicolon
id|pMsg
(braket
l_int|2
)braket
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* universal context */
id|pMsg
(braket
l_int|3
)braket
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* universal context */
id|pMsg
(braket
l_int|4
)braket
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* universal context */
id|pMsg
(braket
l_int|5
)braket
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* universal context */
multiline_comment|/* phys address to return status - area right after PAB */
id|pMsg
(braket
l_int|6
)braket
op_assign
id|pPab-&gt;outMsgBlockPhyAddr
op_minus
id|ADAPTER_BLOCK_RESERVED_SPACE
op_plus
r_sizeof
(paren
id|PAB
)paren
suffix:semicolon
id|pMsg
(braket
l_int|7
)braket
op_assign
l_int|0
suffix:semicolon
id|pMsg
(braket
l_int|8
)braket
op_assign
l_int|1
suffix:semicolon
multiline_comment|/*  return 1 byte */
multiline_comment|/* virual pointer to return buffer - clear first two dwords */
id|p32
op_assign
(paren
r_volatile
id|PU32
)paren
(paren
id|pPab-&gt;pLinOutMsgBlock
op_minus
id|ADAPTER_BLOCK_RESERVED_SPACE
op_plus
r_sizeof
(paren
id|PAB
)paren
)paren
suffix:semicolon
id|p32
(braket
l_int|0
)braket
op_assign
l_int|0
suffix:semicolon
id|p32
(braket
l_int|1
)braket
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* post to Inbound Post Q */
id|pPab-&gt;p_atu-&gt;InQueue
op_assign
id|msgOffset
suffix:semicolon
multiline_comment|/* wait for response */
id|timeout
op_assign
l_int|1000000
suffix:semicolon
r_while
c_loop
(paren
l_int|1
)paren
(brace
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|1000
suffix:semicolon
id|i
op_increment
)paren
multiline_comment|/* please don&squot;t hog the bus!!! */
suffix:semicolon
r_if
c_cond
(paren
id|p32
(braket
l_int|0
)braket
op_logical_or
id|p32
(braket
l_int|1
)braket
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|timeout
op_decrement
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;RCResetIOP timeout&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|RC_RTN_MSG_REPLY_TIMEOUT
suffix:semicolon
)brace
)brace
r_return
id|RC_RTN_NO_ERROR
suffix:semicolon
)brace
multiline_comment|/*&n;** =========================================================================&n;** RCShutdownLANCard()&n;**&n;** ResourceFlags indicates whether to return buffer resource explicitly&n;** to host or keep and reuse.&n;** CallbackFunction (if not NULL) is the function to be called when &n;** shutdown is complete.&n;** If CallbackFunction is NULL, ReturnAddr will have a 1 placed in it when&n;** shutdown is done (if not NULL).&n;**&n;** =========================================================================&n;*/
id|RC_RETURN
DECL|function|RCShutdownLANCard
id|RCShutdownLANCard
c_func
(paren
id|U16
id|AdapterID
comma
id|U16
id|ResourceFlags
comma
id|PU32
id|ReturnAddr
comma
id|PFNCALLBACK
id|CallbackFunction
)paren
(brace
r_volatile
id|PU32
id|pMsg
suffix:semicolon
id|U32
id|off
suffix:semicolon
id|PPAB
id|pPab
suffix:semicolon
r_int
id|i
suffix:semicolon
r_int
id|timeout
op_assign
l_int|0
suffix:semicolon
id|pPab
op_assign
id|PCIAdapterBlock
(braket
id|AdapterID
)braket
suffix:semicolon
r_if
c_cond
(paren
id|pPab
op_eq
l_int|NULL
)paren
r_return
id|RC_RTN_ADPTR_NOT_REGISTERED
suffix:semicolon
id|off
op_assign
id|pPab-&gt;p_atu-&gt;InQueue
suffix:semicolon
multiline_comment|/* get addresss of message */
r_if
c_cond
(paren
l_int|0xFFFFFFFF
op_eq
id|off
)paren
r_return
id|RC_RTN_FREE_Q_EMPTY
suffix:semicolon
id|pPab-&gt;pCallbackFunc
op_assign
id|CallbackFunction
suffix:semicolon
id|pMsg
op_assign
(paren
id|PU32
)paren
(paren
id|pPab-&gt;pPci45LinBaseAddr
op_plus
id|off
)paren
suffix:semicolon
multiline_comment|/* setup message */
id|pMsg
(braket
l_int|0
)braket
op_assign
id|FOUR_WORD_MSG_SIZE
op_or
id|SGL_OFFSET_0
suffix:semicolon
id|pMsg
(braket
l_int|1
)braket
op_assign
id|I2O_LAN_SHUTDOWN
op_lshift
l_int|24
op_or
id|I2O_HOST_TID
op_lshift
l_int|12
op_or
id|RC_LAN_TARGET_ID
suffix:semicolon
id|pMsg
(braket
l_int|2
)braket
op_assign
id|DEFAULT_RECV_INIT_CONTEXT
suffix:semicolon
id|pMsg
(braket
l_int|3
)braket
op_assign
id|ResourceFlags
op_lshift
l_int|16
suffix:semicolon
multiline_comment|/* resource flags */
id|pPab-&gt;p_atu-&gt;InQueue
op_assign
id|off
suffix:semicolon
multiline_comment|/* send it to the I2O device */
r_if
c_cond
(paren
id|CallbackFunction
op_eq
(paren
id|PFNCALLBACK
)paren
l_int|NULL
)paren
(brace
multiline_comment|/* call RCProcI2OMsgQ() until something in pPab-&gt;pCallbackFunc&n;           or until timer goes off */
r_while
c_loop
(paren
id|pPab-&gt;pCallbackFunc
op_eq
(paren
id|PFNCALLBACK
)paren
l_int|NULL
)paren
(brace
id|RCProcI2OMsgQ
c_func
(paren
id|AdapterID
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|100000
suffix:semicolon
id|i
op_increment
)paren
multiline_comment|/* please don&squot;t hog the bus!!! */
suffix:semicolon
id|timeout
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|timeout
OG
l_int|10000
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;RCShutdownLANCard(): timeout&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|ReturnAddr
op_ne
(paren
id|PU32
)paren
l_int|NULL
)paren
op_star
id|ReturnAddr
op_assign
(paren
id|U32
)paren
id|pPab-&gt;pCallbackFunc
suffix:semicolon
)brace
r_return
id|RC_RTN_NO_ERROR
suffix:semicolon
)brace
multiline_comment|/*&n;** =========================================================================&n;** RCSetRavlinIPandMask()&n;**&n;** Set the Ravlin 45/PCI cards IP address and network mask.&n;**&n;** IP address and mask must be in network byte order.&n;** For example, IP address 1.2.3.4 and mask 255.255.255.0 would be&n;** 0x04030201 and 0x00FFFFFF on a little endian machine.&n;**&n;** =========================================================================&n;*/
id|RC_RETURN
DECL|function|RCSetRavlinIPandMask
id|RCSetRavlinIPandMask
c_func
(paren
id|U16
id|AdapterID
comma
id|U32
id|ipAddr
comma
id|U32
id|netMask
)paren
(brace
r_volatile
id|PU32
id|pMsg
suffix:semicolon
id|U32
id|off
suffix:semicolon
id|PPAB
id|pPab
suffix:semicolon
id|pPab
op_assign
id|PCIAdapterBlock
(braket
id|AdapterID
)braket
suffix:semicolon
r_if
c_cond
(paren
id|pPab
op_eq
l_int|NULL
)paren
r_return
id|RC_RTN_ADPTR_NOT_REGISTERED
suffix:semicolon
id|off
op_assign
id|pPab-&gt;p_atu-&gt;InQueue
suffix:semicolon
multiline_comment|/* get addresss of message */
r_if
c_cond
(paren
l_int|0xFFFFFFFF
op_eq
id|off
)paren
r_return
id|RC_RTN_FREE_Q_EMPTY
suffix:semicolon
id|pMsg
op_assign
(paren
id|PU32
)paren
(paren
id|pPab-&gt;pPci45LinBaseAddr
op_plus
id|off
)paren
suffix:semicolon
multiline_comment|/* setup private message */
id|pMsg
(braket
l_int|0
)braket
op_assign
id|SEVEN_WORD_MSG_SIZE
op_or
id|SGL_OFFSET_0
suffix:semicolon
id|pMsg
(braket
l_int|1
)braket
op_assign
id|I2O_PRIVATE
op_lshift
l_int|24
op_or
id|I2O_HOST_TID
op_lshift
l_int|12
op_or
id|RC_LAN_TARGET_ID
suffix:semicolon
id|pMsg
(braket
l_int|2
)braket
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* initiator context */
id|pMsg
(braket
l_int|3
)braket
op_assign
l_int|0x219
suffix:semicolon
multiline_comment|/* transaction context */
id|pMsg
(braket
l_int|4
)braket
op_assign
id|RC_PCI45_VENDOR_ID
op_lshift
l_int|16
op_or
id|RC_PRIVATE_SET_IP_AND_MASK
suffix:semicolon
id|pMsg
(braket
l_int|5
)braket
op_assign
id|ipAddr
suffix:semicolon
id|pMsg
(braket
l_int|6
)braket
op_assign
id|netMask
suffix:semicolon
id|pPab-&gt;p_atu-&gt;InQueue
op_assign
id|off
suffix:semicolon
multiline_comment|/* send it to the I2O device */
r_return
id|RC_RTN_NO_ERROR
suffix:semicolon
)brace
multiline_comment|/*&n;** =========================================================================&n;** RCGetRavlinIPandMask()&n;**&n;** get the IP address and MASK from the card&n;** &n;** =========================================================================&n;*/
id|RC_RETURN
DECL|function|RCGetRavlinIPandMask
id|RCGetRavlinIPandMask
c_func
(paren
id|U16
id|AdapterID
comma
id|PU32
id|pIpAddr
comma
id|PU32
id|pNetMask
comma
id|PFNWAITCALLBACK
id|WaitCallback
)paren
(brace
r_int
id|i
comma
id|timeout
suffix:semicolon
id|U32
id|off
suffix:semicolon
id|PU32
id|pMsg
comma
id|p32
suffix:semicolon
id|PPAB
id|pPab
suffix:semicolon
id|PATU
id|p_atu
suffix:semicolon
macro_line|#ifdef DEBUG
id|kprintf
c_func
(paren
l_string|&quot;RCGetRavlinIPandMask: pIpAddr is 0x%08.8ulx, *IpAddr is 0x%08.8ulx&bslash;n&quot;
comma
id|pIpAddr
comma
op_star
id|pIpAddr
)paren
suffix:semicolon
macro_line|#endif /* DEBUG */
id|pPab
op_assign
id|PCIAdapterBlock
(braket
id|AdapterID
)braket
suffix:semicolon
r_if
c_cond
(paren
id|pPab
op_eq
l_int|NULL
)paren
r_return
id|RC_RTN_ADPTR_NOT_REGISTERED
suffix:semicolon
id|p_atu
op_assign
id|pPab-&gt;p_atu
suffix:semicolon
id|off
op_assign
id|p_atu-&gt;InQueue
suffix:semicolon
multiline_comment|/* get addresss of message */
r_if
c_cond
(paren
l_int|0xFFFFFFFF
op_eq
id|off
)paren
r_return
id|RC_RTN_FREE_Q_EMPTY
suffix:semicolon
id|p32
op_assign
(paren
r_volatile
id|PU32
)paren
(paren
id|pPab-&gt;pLinOutMsgBlock
op_minus
id|ADAPTER_BLOCK_RESERVED_SPACE
op_plus
r_sizeof
(paren
id|PAB
)paren
)paren
suffix:semicolon
op_star
id|p32
op_assign
l_int|0xFFFFFFFF
suffix:semicolon
id|pMsg
op_assign
(paren
id|PU32
)paren
(paren
id|pPab-&gt;pPci45LinBaseAddr
op_plus
id|off
)paren
suffix:semicolon
macro_line|#ifdef DEBUG
id|kprintf
c_func
(paren
l_string|&quot;RCGetRavlinIPandMask: p_atu 0x%08.8ulx, off 0x%08.8ulx, p32 0x%08.8ulx&bslash;n&quot;
comma
id|p_atu
comma
id|off
comma
id|p32
)paren
suffix:semicolon
macro_line|#endif /* DEBUG */
multiline_comment|/* setup private message */
id|pMsg
(braket
l_int|0
)braket
op_assign
id|FIVE_WORD_MSG_SIZE
op_or
id|SGL_OFFSET_0
suffix:semicolon
id|pMsg
(braket
l_int|1
)braket
op_assign
id|I2O_PRIVATE
op_lshift
l_int|24
op_or
id|I2O_HOST_TID
op_lshift
l_int|12
op_or
id|RC_LAN_TARGET_ID
suffix:semicolon
id|pMsg
(braket
l_int|2
)braket
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* initiator context */
id|pMsg
(braket
l_int|3
)braket
op_assign
l_int|0x218
suffix:semicolon
multiline_comment|/* transaction context */
id|pMsg
(braket
l_int|4
)braket
op_assign
id|RC_PCI45_VENDOR_ID
op_lshift
l_int|16
op_or
id|RC_PRIVATE_GET_IP_AND_MASK
suffix:semicolon
id|pMsg
(braket
l_int|5
)braket
op_assign
id|pPab-&gt;outMsgBlockPhyAddr
op_minus
id|ADAPTER_BLOCK_RESERVED_SPACE
op_plus
r_sizeof
(paren
id|PAB
)paren
suffix:semicolon
id|p_atu-&gt;InQueue
op_assign
id|off
suffix:semicolon
multiline_comment|/* send it to the I2O device */
macro_line|#ifdef DEBUG
id|kprintf
c_func
(paren
l_string|&quot;RCGetRavlinIPandMask: p_atu 0x%08.8ulx, off 0x%08.8ulx, p32 0x%08.8ulx&bslash;n&quot;
comma
id|p_atu
comma
id|off
comma
id|p32
)paren
suffix:semicolon
macro_line|#endif /* DEBUG */
multiline_comment|/* wait for the rcpci45 board to update the info */
id|timeout
op_assign
l_int|100000
suffix:semicolon
r_while
c_loop
(paren
l_int|0xffffffff
op_eq
op_star
id|p32
)paren
(brace
r_if
c_cond
(paren
id|WaitCallback
)paren
(paren
op_star
id|WaitCallback
)paren
(paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|1000
suffix:semicolon
id|i
op_increment
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|timeout
op_decrement
)paren
(brace
macro_line|#ifdef DEBUG
id|kprintf
c_func
(paren
l_string|&quot;RCGetRavlinIPandMask: Timeout&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif /* DEBUG */
r_return
id|RC_RTN_MSG_REPLY_TIMEOUT
suffix:semicolon
)brace
)brace
macro_line|#ifdef DEBUG
id|kprintf
c_func
(paren
l_string|&quot;RCGetRavlinIPandMask: after time out&bslash;n&quot;
comma
"&bslash;"
l_string|&quot;p32[0] (IpAddr) 0x%08.8ulx, p32[1] (IPmask) 0x%08.8ulx&bslash;n&quot;
comma
id|p32
(braket
l_int|0
)braket
comma
id|p32
(braket
l_int|1
)braket
)paren
suffix:semicolon
macro_line|#endif /* DEBUG */
multiline_comment|/* send IP and mask to user&squot;s space  */
op_star
id|pIpAddr
op_assign
id|p32
(braket
l_int|0
)braket
suffix:semicolon
op_star
id|pNetMask
op_assign
id|p32
(braket
l_int|1
)braket
suffix:semicolon
macro_line|#ifdef DEBUG
id|kprintf
c_func
(paren
l_string|&quot;RCGetRavlinIPandMask: pIpAddr is 0x%08.8ulx, *IpAddr is 0x%08.8ulx&bslash;n&quot;
comma
id|pIpAddr
comma
op_star
id|pIpAddr
)paren
suffix:semicolon
macro_line|#endif /* DEBUG */
r_return
id|RC_RTN_NO_ERROR
suffix:semicolon
)brace
multiline_comment|/* &n;** /////////////////////////////////////////////////////////////////////////&n;** /////////////////////////////////////////////////////////////////////////&n;**&n;**                        local functions&n;**&n;** /////////////////////////////////////////////////////////////////////////&n;** /////////////////////////////////////////////////////////////////////////&n;*/
multiline_comment|/*&n;** =========================================================================&n;** SendI2OOutboundQInitMsg()&n;**&n;** =========================================================================&n;*/
r_static
r_int
DECL|function|SendI2OOutboundQInitMsg
id|SendI2OOutboundQInitMsg
c_func
(paren
id|PPAB
id|pPab
)paren
(brace
id|U32
id|msgOffset
comma
id|timeout
comma
id|phyOutQFrames
comma
id|i
suffix:semicolon
r_volatile
id|PU32
id|pMsg
suffix:semicolon
r_volatile
id|PU32
id|p32
suffix:semicolon
id|msgOffset
op_assign
id|pPab-&gt;p_atu-&gt;InQueue
suffix:semicolon
r_if
c_cond
(paren
id|msgOffset
op_eq
l_int|0xFFFFFFFF
)paren
(brace
macro_line|#ifdef DEBUG
id|kprintf
c_func
(paren
l_string|&quot;SendI2OOutboundQInitMsg(): Inbound Free Q empty!&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif /* DEBUG */
r_return
id|RC_RTN_FREE_Q_EMPTY
suffix:semicolon
)brace
multiline_comment|/* calc virual address of msg - virual already mapped to physical */
id|pMsg
op_assign
(paren
id|PU32
)paren
(paren
id|pPab-&gt;pPci45LinBaseAddr
op_plus
id|msgOffset
)paren
suffix:semicolon
macro_line|#ifdef DEBUG
id|kprintf
c_func
(paren
l_string|&quot;SendI2OOutboundQInitMsg - pMsg = 0x%08.8ulx, InQ msgOffset = 0x%08.8ulx&bslash;n&quot;
comma
id|pMsg
comma
id|msgOffset
)paren
suffix:semicolon
macro_line|#endif /* DEBUG */
id|pMsg
(braket
l_int|0
)braket
op_assign
id|EIGHT_WORD_MSG_SIZE
op_or
id|TRL_OFFSET_6
suffix:semicolon
id|pMsg
(braket
l_int|1
)braket
op_assign
id|I2O_EXEC_OUTBOUND_INIT
op_lshift
l_int|24
op_or
id|I2O_HOST_TID
op_lshift
l_int|12
op_or
id|I2O_IOP_TID
suffix:semicolon
id|pMsg
(braket
l_int|2
)braket
op_assign
id|DEFAULT_RECV_INIT_CONTEXT
suffix:semicolon
id|pMsg
(braket
l_int|3
)braket
op_assign
l_int|0x106
suffix:semicolon
multiline_comment|/* transaction context */
id|pMsg
(braket
l_int|4
)braket
op_assign
l_int|4096
suffix:semicolon
multiline_comment|/* Host page frame size */
id|pMsg
(braket
l_int|5
)braket
op_assign
id|MSG_FRAME_SIZE
op_lshift
l_int|16
op_or
l_int|0x80
suffix:semicolon
multiline_comment|/* outbound msg frame size and Initcode */
id|pMsg
(braket
l_int|6
)braket
op_assign
l_int|0xD0000004
suffix:semicolon
multiline_comment|/* simple sgl element LE, EOB */
multiline_comment|/* phys address to return status - area right after PAB */
id|pMsg
(braket
l_int|7
)braket
op_assign
id|pPab-&gt;outMsgBlockPhyAddr
op_minus
id|ADAPTER_BLOCK_RESERVED_SPACE
op_plus
r_sizeof
(paren
id|PAB
)paren
suffix:semicolon
multiline_comment|/* virual pointer to return buffer - clear first two dwords */
id|p32
op_assign
(paren
id|PU32
)paren
(paren
id|pPab-&gt;pLinOutMsgBlock
op_minus
id|ADAPTER_BLOCK_RESERVED_SPACE
op_plus
r_sizeof
(paren
id|PAB
)paren
)paren
suffix:semicolon
id|p32
(braket
l_int|0
)braket
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* post to Inbound Post Q */
id|pPab-&gt;p_atu-&gt;InQueue
op_assign
id|msgOffset
suffix:semicolon
multiline_comment|/* wait for response */
id|timeout
op_assign
l_int|100000
suffix:semicolon
r_while
c_loop
(paren
l_int|1
)paren
(brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|1000
suffix:semicolon
id|i
op_increment
)paren
multiline_comment|/* please don&squot;t hog the bus!!! */
suffix:semicolon
r_if
c_cond
(paren
id|p32
(braket
l_int|0
)braket
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|timeout
op_decrement
)paren
(brace
macro_line|#ifdef DEBUG
id|kprintf
c_func
(paren
l_string|&quot;Timeout wait for InitOutQ InPrgress status from IOP&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif /* DEBUG */
r_return
id|RC_RTN_NO_I2O_STATUS
suffix:semicolon
)brace
)brace
id|timeout
op_assign
l_int|100000
suffix:semicolon
r_while
c_loop
(paren
l_int|1
)paren
(brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|1000
suffix:semicolon
id|i
op_increment
)paren
multiline_comment|/* please don&squot;t hog the bus!!! */
suffix:semicolon
r_if
c_cond
(paren
id|p32
(braket
l_int|0
)braket
op_eq
id|I2O_EXEC_OUTBOUND_INIT_COMPLETE
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|timeout
op_decrement
)paren
(brace
macro_line|#ifdef DEBUG
id|kprintf
c_func
(paren
l_string|&quot;Timeout wait for InitOutQ Complete status from IOP&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif /* DEBUG */
r_return
id|RC_RTN_NO_I2O_STATUS
suffix:semicolon
)brace
)brace
multiline_comment|/* load PCI outbound free Q with MF physical addresses */
id|phyOutQFrames
op_assign
id|pPab-&gt;outMsgBlockPhyAddr
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|NMBR_MSG_FRAMES
suffix:semicolon
id|i
op_increment
)paren
(brace
id|pPab-&gt;p_atu-&gt;OutQueue
op_assign
id|phyOutQFrames
suffix:semicolon
id|phyOutQFrames
op_add_assign
id|MSG_FRAME_SIZE
suffix:semicolon
)brace
r_return
id|RC_RTN_NO_ERROR
suffix:semicolon
)brace
multiline_comment|/*&n;** =========================================================================&n;** GetI2OStatus()&n;**&n;** Send StatusGet Msg, wait for results return directly to buffer.&n;**&n;** =========================================================================&n;*/
r_static
r_int
DECL|function|GetI2OStatus
id|GetI2OStatus
c_func
(paren
id|PPAB
id|pPab
)paren
(brace
id|U32
id|msgOffset
comma
id|timeout
suffix:semicolon
id|PU32
id|pMsg
suffix:semicolon
r_volatile
id|PU32
id|p32
suffix:semicolon
id|msgOffset
op_assign
id|pPab-&gt;p_atu-&gt;InQueue
suffix:semicolon
macro_line|#ifdef DEBUG
id|printk
c_func
(paren
l_string|&quot;GetI2OStatus: msg offset = 0x%x&bslash;n&quot;
comma
id|msgOffset
)paren
suffix:semicolon
macro_line|#endif /* DEBUG */
r_if
c_cond
(paren
id|msgOffset
op_eq
l_int|0xFFFFFFFF
)paren
(brace
macro_line|#ifdef DEBUG
id|kprintf
c_func
(paren
l_string|&quot;GetI2OStatus(): Inbound Free Q empty!&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif /* DEBUG */
r_return
id|RC_RTN_FREE_Q_EMPTY
suffix:semicolon
)brace
multiline_comment|/* calc virual address of msg - virual already mapped to physical */
id|pMsg
op_assign
(paren
id|PU32
)paren
(paren
id|pPab-&gt;pPci45LinBaseAddr
op_plus
id|msgOffset
)paren
suffix:semicolon
id|pMsg
(braket
l_int|0
)braket
op_assign
id|NINE_WORD_MSG_SIZE
op_or
id|SGL_OFFSET_0
suffix:semicolon
id|pMsg
(braket
l_int|1
)braket
op_assign
id|I2O_EXEC_STATUS_GET
op_lshift
l_int|24
op_or
id|I2O_HOST_TID
op_lshift
l_int|12
op_or
id|I2O_IOP_TID
suffix:semicolon
id|pMsg
(braket
l_int|2
)braket
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* universal context */
id|pMsg
(braket
l_int|3
)braket
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* universal context */
id|pMsg
(braket
l_int|4
)braket
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* universal context */
id|pMsg
(braket
l_int|5
)braket
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* universal context */
multiline_comment|/* phys address to return status - area right after PAB */
id|pMsg
(braket
l_int|6
)braket
op_assign
id|pPab-&gt;outMsgBlockPhyAddr
op_minus
id|ADAPTER_BLOCK_RESERVED_SPACE
op_plus
r_sizeof
(paren
id|PAB
)paren
suffix:semicolon
id|pMsg
(braket
l_int|7
)braket
op_assign
l_int|0
suffix:semicolon
id|pMsg
(braket
l_int|8
)braket
op_assign
l_int|88
suffix:semicolon
multiline_comment|/*  return 88 bytes */
multiline_comment|/* virual pointer to return buffer - clear first two dwords */
id|p32
op_assign
(paren
r_volatile
id|PU32
)paren
(paren
id|pPab-&gt;pLinOutMsgBlock
op_minus
id|ADAPTER_BLOCK_RESERVED_SPACE
op_plus
r_sizeof
(paren
id|PAB
)paren
)paren
suffix:semicolon
id|p32
(braket
l_int|0
)braket
op_assign
l_int|0
suffix:semicolon
id|p32
(braket
l_int|1
)braket
op_assign
l_int|0
suffix:semicolon
macro_line|#ifdef DEBUG
id|kprintf
c_func
(paren
l_string|&quot;GetI2OStatus - pMsg:0x%08.8ulx, msgOffset:0x%08.8ulx, [1]:0x%08.8ulx, [6]:0x%08.8ulx&bslash;n&quot;
comma
id|pMsg
comma
id|msgOffset
comma
id|pMsg
(braket
l_int|1
)braket
comma
id|pMsg
(braket
l_int|6
)braket
)paren
suffix:semicolon
macro_line|#endif /* DEBUG */
multiline_comment|/* post to Inbound Post Q */
id|pPab-&gt;p_atu-&gt;InQueue
op_assign
id|msgOffset
suffix:semicolon
macro_line|#ifdef DEBUG
id|kprintf
c_func
(paren
l_string|&quot;Return status to p32 = 0x%08.8ulx&bslash;n&quot;
comma
id|p32
)paren
suffix:semicolon
macro_line|#endif /* DEBUG */
multiline_comment|/* wait for response */
id|timeout
op_assign
l_int|1000000
suffix:semicolon
r_while
c_loop
(paren
l_int|1
)paren
(brace
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|1000
suffix:semicolon
id|i
op_increment
)paren
multiline_comment|/* please don&squot;t hog the bus!!! */
suffix:semicolon
r_if
c_cond
(paren
id|p32
(braket
l_int|0
)braket
op_logical_and
id|p32
(braket
l_int|1
)braket
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|timeout
op_decrement
)paren
(brace
macro_line|#ifdef DEBUG
id|kprintf
c_func
(paren
l_string|&quot;Timeout waiting for status from IOP&bslash;n&quot;
)paren
suffix:semicolon
id|kprintf
c_func
(paren
l_string|&quot;0x%08.8ulx:0x%08.8ulx:0x%08.8ulx:0x%08.8ulx&bslash;n&quot;
comma
id|p32
(braket
l_int|0
)braket
comma
id|p32
(braket
l_int|1
)braket
comma
id|p32
(braket
l_int|2
)braket
comma
id|p32
(braket
l_int|3
)braket
)paren
suffix:semicolon
id|kprintf
c_func
(paren
l_string|&quot;0x%08.8ulx:0x%08.8ulx:0x%08.8ulx:0x%08.8ulx&bslash;n&quot;
comma
id|p32
(braket
l_int|4
)braket
comma
id|p32
(braket
l_int|5
)braket
comma
id|p32
(braket
l_int|6
)braket
comma
id|p32
(braket
l_int|7
)braket
)paren
suffix:semicolon
id|kprintf
c_func
(paren
l_string|&quot;0x%08.8ulx:0x%08.8ulx:0x%08.8ulx:0x%08.8ulx&bslash;n&quot;
comma
id|p32
(braket
l_int|8
)braket
comma
id|p32
(braket
l_int|9
)braket
comma
id|p32
(braket
l_int|10
)braket
comma
id|p32
(braket
l_int|11
)braket
)paren
suffix:semicolon
macro_line|#endif /* DEBUG */
r_return
id|RC_RTN_NO_I2O_STATUS
suffix:semicolon
)brace
)brace
macro_line|#ifdef DEBUG
id|kprintf
c_func
(paren
l_string|&quot;0x%08.8ulx:0x%08.8ulx:0x%08.8ulx:0x%08.8ulx&bslash;n&quot;
comma
id|p32
(braket
l_int|0
)braket
comma
id|p32
(braket
l_int|1
)braket
comma
id|p32
(braket
l_int|2
)braket
comma
id|p32
(braket
l_int|3
)braket
)paren
suffix:semicolon
id|kprintf
c_func
(paren
l_string|&quot;0x%08.8ulx:0x%08.8ulx:0x%08.8ulx:0x%08.8ulx&bslash;n&quot;
comma
id|p32
(braket
l_int|4
)braket
comma
id|p32
(braket
l_int|5
)braket
comma
id|p32
(braket
l_int|6
)braket
comma
id|p32
(braket
l_int|7
)braket
)paren
suffix:semicolon
id|kprintf
c_func
(paren
l_string|&quot;0x%08.8ulx:0x%08.8ulx:0x%08.8ulx:0x%08.8ulx&bslash;n&quot;
comma
id|p32
(braket
l_int|8
)braket
comma
id|p32
(braket
l_int|9
)braket
comma
id|p32
(braket
l_int|10
)braket
comma
id|p32
(braket
l_int|11
)braket
)paren
suffix:semicolon
macro_line|#endif /* DEBUG */
multiline_comment|/* get IOP state */
id|pPab-&gt;IOPState
op_assign
(paren
(paren
r_volatile
id|PU8
)paren
id|p32
)paren
(braket
l_int|10
)braket
suffix:semicolon
id|pPab-&gt;InboundMFrameSize
op_assign
(paren
(paren
r_volatile
id|PU16
)paren
id|p32
)paren
(braket
l_int|6
)braket
suffix:semicolon
macro_line|#ifdef DEBUG
id|kprintf
c_func
(paren
l_string|&quot;IOP state 0x%02.2x InFrameSize = 0x%04.4x&bslash;n&quot;
comma
id|pPab-&gt;IOPState
comma
id|pPab-&gt;InboundMFrameSize
)paren
suffix:semicolon
macro_line|#endif /* DEBUG */
r_return
id|RC_RTN_NO_ERROR
suffix:semicolon
)brace
multiline_comment|/*&n;** =========================================================================&n;** SendEnableSysMsg()&n;**&n;**&n;** =========================================================================&n;*/
r_static
r_int
DECL|function|SendEnableSysMsg
id|SendEnableSysMsg
c_func
(paren
id|PPAB
id|pPab
)paren
(brace
id|U32
id|msgOffset
suffix:semicolon
singleline_comment|// timeout;
r_volatile
id|PU32
id|pMsg
suffix:semicolon
id|msgOffset
op_assign
id|pPab-&gt;p_atu-&gt;InQueue
suffix:semicolon
r_if
c_cond
(paren
id|msgOffset
op_eq
l_int|0xFFFFFFFF
)paren
(brace
macro_line|#ifdef DEBUG
id|kprintf
c_func
(paren
l_string|&quot;SendEnableSysMsg(): Inbound Free Q empty!&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif /* DEBUG */
r_return
id|RC_RTN_FREE_Q_EMPTY
suffix:semicolon
)brace
multiline_comment|/* calc virual address of msg - virual already mapped to physical */
id|pMsg
op_assign
(paren
id|PU32
)paren
(paren
id|pPab-&gt;pPci45LinBaseAddr
op_plus
id|msgOffset
)paren
suffix:semicolon
macro_line|#ifdef DEBUG
id|kprintf
c_func
(paren
l_string|&quot;SendEnableSysMsg - pMsg = 0x%08.8ulx, InQ msgOffset = 0x%08.8ulx&bslash;n&quot;
comma
id|pMsg
comma
id|msgOffset
)paren
suffix:semicolon
macro_line|#endif /* DEBUG */
id|pMsg
(braket
l_int|0
)braket
op_assign
id|FOUR_WORD_MSG_SIZE
op_or
id|SGL_OFFSET_0
suffix:semicolon
id|pMsg
(braket
l_int|1
)braket
op_assign
id|I2O_EXEC_SYS_ENABLE
op_lshift
l_int|24
op_or
id|I2O_HOST_TID
op_lshift
l_int|12
op_or
id|I2O_IOP_TID
suffix:semicolon
id|pMsg
(braket
l_int|2
)braket
op_assign
id|DEFAULT_RECV_INIT_CONTEXT
suffix:semicolon
id|pMsg
(braket
l_int|3
)braket
op_assign
l_int|0x110
suffix:semicolon
multiline_comment|/* transaction context */
id|pMsg
(braket
l_int|4
)braket
op_assign
l_int|0x50657465
suffix:semicolon
multiline_comment|/*  RedCreek Private */
multiline_comment|/* post to Inbound Post Q */
id|pPab-&gt;p_atu-&gt;InQueue
op_assign
id|msgOffset
suffix:semicolon
r_return
id|RC_RTN_NO_ERROR
suffix:semicolon
)brace
multiline_comment|/*&n;** =========================================================================&n;** FillI2OMsgFromTCB()&n;**&n;** inputs   pMsgU32 - virual pointer (mapped to physical) of message frame&n;**          pXmitCntrlBlock - pointer to caller buffer control block.&n;**&n;** fills in LAN SGL after Transaction Control Word or Bucket Count.&n;** =========================================================================&n;*/
r_static
r_int
DECL|function|FillI2OMsgSGLFromTCB
id|FillI2OMsgSGLFromTCB
c_func
(paren
id|PU32
id|pMsgFrame
comma
id|PRCTCB
id|pTransCtrlBlock
)paren
(brace
r_int
r_int
id|nmbrBuffers
comma
id|nmbrSeg
comma
id|nmbrDwords
comma
id|context
comma
id|flags
suffix:semicolon
id|PU32
id|pTCB
comma
id|pMsg
suffix:semicolon
multiline_comment|/* SGL element flags */
DECL|macro|EOB
mdefine_line|#define EOB        0x40000000
DECL|macro|LE
mdefine_line|#define LE         0x80000000
DECL|macro|SIMPLE_SGL
mdefine_line|#define SIMPLE_SGL 0x10000000
DECL|macro|BC_PRESENT
mdefine_line|#define BC_PRESENT 0x01000000
id|pTCB
op_assign
(paren
id|PU32
)paren
id|pTransCtrlBlock
suffix:semicolon
id|pMsg
op_assign
id|pMsgFrame
suffix:semicolon
id|nmbrDwords
op_assign
l_int|0
suffix:semicolon
macro_line|#ifdef DEBUG
id|kprintf
c_func
(paren
l_string|&quot;FillI2OMsgSGLFromTCBX&bslash;n&quot;
)paren
suffix:semicolon
id|kprintf
c_func
(paren
l_string|&quot;TCB  0x%08.8ulx:0x%08.8ulx:0x%08.8ulx:0x%08.8ulx:0x%08.8ulx&bslash;n&quot;
comma
id|pTCB
(braket
l_int|0
)braket
comma
id|pTCB
(braket
l_int|1
)braket
comma
id|pTCB
(braket
l_int|2
)braket
comma
id|pTCB
(braket
l_int|3
)braket
comma
id|pTCB
(braket
l_int|4
)braket
)paren
suffix:semicolon
id|kprintf
c_func
(paren
l_string|&quot;pTCB 0x%08.8ulx, pMsg 0x%08.8ulx&bslash;n&quot;
comma
id|pTCB
comma
id|pMsg
)paren
suffix:semicolon
macro_line|#endif /* DEBUG */
id|nmbrBuffers
op_assign
op_star
id|pTCB
op_increment
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|nmbrBuffers
)paren
(brace
r_return
op_minus
l_int|1
suffix:semicolon
)brace
r_do
(brace
id|context
op_assign
op_star
id|pTCB
op_increment
suffix:semicolon
multiline_comment|/* buffer tag (context) */
id|nmbrSeg
op_assign
op_star
id|pTCB
op_increment
suffix:semicolon
multiline_comment|/* number of segments */
r_if
c_cond
(paren
op_logical_neg
id|nmbrSeg
)paren
(brace
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|flags
op_assign
id|SIMPLE_SGL
op_or
id|BC_PRESENT
suffix:semicolon
r_if
c_cond
(paren
l_int|1
op_eq
id|nmbrSeg
)paren
(brace
id|flags
op_or_assign
id|EOB
suffix:semicolon
r_if
c_cond
(paren
l_int|1
op_eq
id|nmbrBuffers
)paren
id|flags
op_or_assign
id|LE
suffix:semicolon
)brace
multiline_comment|/* 1st SGL buffer element has context */
id|pMsg
(braket
l_int|0
)braket
op_assign
id|pTCB
(braket
l_int|0
)braket
op_or
id|flags
suffix:semicolon
multiline_comment|/* send over count (segment size) */
id|pMsg
(braket
l_int|1
)braket
op_assign
id|context
suffix:semicolon
id|pMsg
(braket
l_int|2
)braket
op_assign
id|pTCB
(braket
l_int|1
)braket
suffix:semicolon
multiline_comment|/* send buffer segment physical address */
id|nmbrDwords
op_add_assign
l_int|3
suffix:semicolon
id|pMsg
op_add_assign
l_int|3
suffix:semicolon
id|pTCB
op_add_assign
l_int|2
suffix:semicolon
r_if
c_cond
(paren
op_decrement
id|nmbrSeg
)paren
(brace
r_do
(brace
id|flags
op_assign
id|SIMPLE_SGL
suffix:semicolon
r_if
c_cond
(paren
l_int|1
op_eq
id|nmbrSeg
)paren
(brace
id|flags
op_or_assign
id|EOB
suffix:semicolon
r_if
c_cond
(paren
l_int|1
op_eq
id|nmbrBuffers
)paren
id|flags
op_or_assign
id|LE
suffix:semicolon
)brace
id|pMsg
(braket
l_int|0
)braket
op_assign
id|pTCB
(braket
l_int|0
)braket
op_or
id|flags
suffix:semicolon
multiline_comment|/* send over count */
id|pMsg
(braket
l_int|1
)braket
op_assign
id|pTCB
(braket
l_int|1
)braket
suffix:semicolon
multiline_comment|/* send buffer segment physical address */
id|nmbrDwords
op_add_assign
l_int|2
suffix:semicolon
id|pTCB
op_add_assign
l_int|2
suffix:semicolon
id|pMsg
op_add_assign
l_int|2
suffix:semicolon
)brace
r_while
c_loop
(paren
op_decrement
id|nmbrSeg
)paren
suffix:semicolon
)brace
)brace
r_while
c_loop
(paren
op_decrement
id|nmbrBuffers
)paren
suffix:semicolon
r_return
id|nmbrDwords
suffix:semicolon
)brace
multiline_comment|/*&n;** =========================================================================&n;** ProcessOutboundI2OMsg()&n;**&n;** process I2O reply message&n;** * change to msg structure *&n;** =========================================================================&n;*/
r_static
r_void
DECL|function|ProcessOutboundI2OMsg
id|ProcessOutboundI2OMsg
c_func
(paren
id|PPAB
id|pPab
comma
id|U32
id|phyAddrMsg
)paren
(brace
id|PU8
id|p8Msg
suffix:semicolon
id|PU32
id|p32
suffix:semicolon
singleline_comment|//  U16 count;
id|p8Msg
op_assign
id|pPab-&gt;pLinOutMsgBlock
op_plus
(paren
id|phyAddrMsg
op_minus
id|pPab-&gt;outMsgBlockPhyAddr
)paren
suffix:semicolon
id|p32
op_assign
(paren
id|PU32
)paren
id|p8Msg
suffix:semicolon
macro_line|#ifdef DEBUG
id|kprintf
c_func
(paren
l_string|&quot;VXD: ProcessOutboundI2OMsg - pPab 0x%08.8ulx, phyAdr 0x%08.8ulx, linAdr 0x%08.8ulx&bslash;n&quot;
comma
id|pPab
comma
id|phyAddrMsg
comma
id|p8Msg
)paren
suffix:semicolon
id|kprintf
c_func
(paren
l_string|&quot;msg :0x%08.8ulx:0x%08.8ulx:0x%08.8ulx:0x%08.8ulx&bslash;n&quot;
comma
id|p32
(braket
l_int|0
)braket
comma
id|p32
(braket
l_int|1
)braket
comma
id|p32
(braket
l_int|2
)braket
comma
id|p32
(braket
l_int|3
)braket
)paren
suffix:semicolon
id|kprintf
c_func
(paren
l_string|&quot;msg :0x%08.8ulx:0x%08.8ulx:0x%08.8ulx:0x%08.8ulx&bslash;n&quot;
comma
id|p32
(braket
l_int|4
)braket
comma
id|p32
(braket
l_int|5
)braket
comma
id|p32
(braket
l_int|6
)braket
comma
id|p32
(braket
l_int|7
)braket
)paren
suffix:semicolon
macro_line|#endif /* DEBUG */
r_if
c_cond
(paren
id|p32
(braket
l_int|4
)braket
op_rshift
l_int|24
op_ne
id|I2O_REPLY_STATUS_SUCCESS
)paren
(brace
macro_line|#ifdef DEBUG
id|kprintf
c_func
(paren
l_string|&quot;Message reply status not success&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif /* DEBUG */
r_return
suffix:semicolon
)brace
r_switch
c_cond
(paren
id|p8Msg
(braket
l_int|7
)braket
)paren
multiline_comment|/* function code byte */
(brace
r_case
id|I2O_EXEC_SYS_TAB_SET
suffix:colon
id|msgFlag
op_assign
l_int|1
suffix:semicolon
macro_line|#ifdef DEBUG
id|kprintf
c_func
(paren
l_string|&quot;Received I2O_EXEC_SYS_TAB_SET reply&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif /* DEBUG */
r_break
suffix:semicolon
r_case
id|I2O_EXEC_HRT_GET
suffix:colon
id|msgFlag
op_assign
l_int|1
suffix:semicolon
macro_line|#ifdef DEBUG
id|kprintf
c_func
(paren
l_string|&quot;Received I2O_EXEC_HRT_GET reply&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif /* DEBUG */
r_break
suffix:semicolon
r_case
id|I2O_EXEC_LCT_NOTIFY
suffix:colon
id|msgFlag
op_assign
l_int|1
suffix:semicolon
macro_line|#ifdef DEBUG
id|kprintf
c_func
(paren
l_string|&quot;Received I2O_EXEC_LCT_NOTIFY reply&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif /* DEBUG */
r_break
suffix:semicolon
r_case
id|I2O_EXEC_SYS_ENABLE
suffix:colon
id|msgFlag
op_assign
l_int|1
suffix:semicolon
macro_line|#ifdef DEBUG
id|kprintf
c_func
(paren
l_string|&quot;Received I2O_EXEC_SYS_ENABLE reply&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif /* DEBUG */
r_break
suffix:semicolon
r_default
suffix:colon
macro_line|#ifdef DEBUG
id|kprintf
c_func
(paren
l_string|&quot;Received UNKNOWN reply&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif /* DEBUG */
r_break
suffix:semicolon
)brace
)brace
eof
