multiline_comment|/* sb1000.c: A General Instruments SB1000 driver for linux. */
multiline_comment|/*&n;&t;Written 1998 by Franco Venturi.&n;&n;&t;Copyright 1998 by Franco Venturi.&n;&t;Copyright 1994,1995 by Donald Becker.&n;&t;Copyright 1993 United States Government as represented by the&n;&t;Director, National Security Agency.&n;&n;&t;This driver is for the General Instruments SB1000 (internal SURFboard)&n;&n;&t;The author may be reached as fventuri@mediaone.net&n;&n;&t;This program is free software; you can redistribute it&n;&t;and/or  modify it under  the terms of  the GNU General&n;&t;Public  License as  published  by  the  Free  Software&n;&t;Foundation;  either  version 2 of the License, or  (at&n;&t;your option) any later version.&n;&n;&t;Changes:&n;&n;&t;981115 Steven Hirsch &lt;shirsch@adelphia.net&gt;&n;&n;&t;Linus changed the timer interface.  Should work on all recent&n;&t;development kernels.&n;&n;&t;980608 Steven Hirsch &lt;shirsch@adelphia.net&gt;&n;&n;&t;Small changes to make it work with 2.1.x kernels. Hopefully,&n;&t;nothing major will change before official release of Linux 2.2.&n;&t;&n;&t;Merged with 2.2 - Alan Cox&n;*/
DECL|variable|version
r_static
r_char
id|version
(braket
)braket
op_assign
l_string|&quot;sb1000.c:v1.1.2 6/01/98 (fventuri@mediaone.net)&bslash;n&quot;
suffix:semicolon
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/version.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/interrupt.h&gt;
macro_line|#include &lt;linux/ptrace.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/in.h&gt;
macro_line|#include &lt;linux/malloc.h&gt;
macro_line|#include &lt;linux/ioport.h&gt;
macro_line|#include &lt;linux/netdevice.h&gt;
macro_line|#include &lt;linux/if_arp.h&gt;
macro_line|#include &lt;linux/skbuff.h&gt;
macro_line|#include &lt;linux/delay.h&gt;&t;/* for udelay() */
macro_line|#include &lt;asm/processor.h&gt;
macro_line|#include &lt;asm/bitops.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/uaccess.h&gt;
macro_line|#include &lt;linux/etherdevice.h&gt;
macro_line|#include &lt;linux/isapnp.h&gt;
multiline_comment|/* for SIOGCM/SIOSCM stuff */
macro_line|#include &lt;linux/if_cablemodem.h&gt;
macro_line|#ifdef SB1000_DEBUG
DECL|variable|sb1000_debug
r_int
id|sb1000_debug
op_assign
id|SB1000_DEBUG
suffix:semicolon
macro_line|#else
DECL|variable|sb1000_debug
r_int
id|sb1000_debug
op_assign
l_int|1
suffix:semicolon
macro_line|#endif
DECL|variable|SB1000_IO_EXTENT
r_static
r_const
r_int
id|SB1000_IO_EXTENT
op_assign
l_int|8
suffix:semicolon
multiline_comment|/* SB1000 Maximum Receive Unit */
DECL|variable|SB1000_MRU
r_static
r_const
r_int
id|SB1000_MRU
op_assign
l_int|1500
suffix:semicolon
multiline_comment|/* octects */
DECL|macro|NPIDS
mdefine_line|#define NPIDS 4
DECL|struct|sb1000_private
r_struct
id|sb1000_private
(brace
DECL|member|rx_skb
r_struct
id|sk_buff
op_star
id|rx_skb
(braket
id|NPIDS
)braket
suffix:semicolon
DECL|member|rx_dlen
r_int
id|rx_dlen
(braket
id|NPIDS
)braket
suffix:semicolon
DECL|member|rx_bytes
r_int
r_int
id|rx_bytes
suffix:semicolon
DECL|member|rx_frames
r_int
r_int
id|rx_frames
suffix:semicolon
DECL|member|rx_error_count
r_int
id|rx_error_count
suffix:semicolon
DECL|member|rx_error_dpc_count
r_int
id|rx_error_dpc_count
suffix:semicolon
DECL|member|rx_session_id
r_int
r_char
id|rx_session_id
(braket
id|NPIDS
)braket
suffix:semicolon
DECL|member|rx_frame_id
r_int
r_char
id|rx_frame_id
(braket
id|NPIDS
)braket
suffix:semicolon
DECL|member|rx_pkt_type
r_int
r_char
id|rx_pkt_type
(braket
id|NPIDS
)braket
suffix:semicolon
DECL|member|stats
r_struct
id|net_device_stats
id|stats
suffix:semicolon
)brace
suffix:semicolon
multiline_comment|/* prototypes for Linux interface */
r_extern
r_int
id|sb1000_probe
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_int
id|sb1000_open
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_int
id|sb1000_dev_ioctl
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_struct
id|ifreq
op_star
id|ifr
comma
r_int
id|cmd
)paren
suffix:semicolon
r_static
r_int
id|sb1000_start_xmit
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_void
id|sb1000_interrupt
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
suffix:semicolon
r_static
r_struct
id|net_device_stats
op_star
id|sb1000_stats
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_int
id|sb1000_close
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
multiline_comment|/* SB1000 hardware routines to be used during open/configuration phases */
r_static
r_inline
r_void
id|nicedelay
c_func
(paren
r_int
r_int
id|usecs
)paren
suffix:semicolon
r_static
r_inline
r_int
id|card_wait_for_busy_clear
c_func
(paren
r_const
r_int
id|ioaddr
(braket
)braket
comma
r_const
r_char
op_star
id|name
)paren
suffix:semicolon
r_static
r_inline
r_int
id|card_wait_for_ready
c_func
(paren
r_const
r_int
id|ioaddr
(braket
)braket
comma
r_const
r_char
op_star
id|name
comma
r_int
r_char
id|in
(braket
)braket
)paren
suffix:semicolon
r_static
r_inline
r_int
id|card_send_command
c_func
(paren
r_const
r_int
id|ioaddr
(braket
)braket
comma
r_const
r_char
op_star
id|name
comma
r_const
r_int
r_char
id|out
(braket
)braket
comma
r_int
r_char
id|in
(braket
)braket
)paren
suffix:semicolon
multiline_comment|/* SB1000 hardware routines to be used during frame rx interrupt */
r_static
r_inline
r_int
id|sb1000_wait_for_ready
c_func
(paren
r_const
r_int
id|ioaddr
(braket
)braket
comma
r_const
r_char
op_star
id|name
)paren
suffix:semicolon
r_static
r_inline
r_int
id|sb1000_wait_for_ready_clear
c_func
(paren
r_const
r_int
id|ioaddr
(braket
)braket
comma
r_const
r_char
op_star
id|name
)paren
suffix:semicolon
r_static
r_inline
r_void
id|sb1000_send_command
c_func
(paren
r_const
r_int
id|ioaddr
(braket
)braket
comma
r_const
r_char
op_star
id|name
comma
r_const
r_int
r_char
id|out
(braket
)braket
)paren
suffix:semicolon
r_static
r_inline
r_void
id|sb1000_read_status
c_func
(paren
r_const
r_int
id|ioaddr
(braket
)braket
comma
r_int
r_char
id|in
(braket
)braket
)paren
suffix:semicolon
r_static
r_inline
r_void
id|sb1000_issue_read_command
c_func
(paren
r_const
r_int
id|ioaddr
(braket
)braket
comma
r_const
r_char
op_star
id|name
)paren
suffix:semicolon
multiline_comment|/* SB1000 commands for open/configuration */
r_static
r_inline
r_int
id|sb1000_reset
c_func
(paren
r_const
r_int
id|ioaddr
(braket
)braket
comma
r_const
r_char
op_star
id|name
)paren
suffix:semicolon
r_static
r_inline
r_int
id|sb1000_check_CRC
c_func
(paren
r_const
r_int
id|ioaddr
(braket
)braket
comma
r_const
r_char
op_star
id|name
)paren
suffix:semicolon
r_static
r_inline
r_int
id|sb1000_start_get_set_command
c_func
(paren
r_const
r_int
id|ioaddr
(braket
)braket
comma
r_const
r_char
op_star
id|name
)paren
suffix:semicolon
r_static
r_inline
r_int
id|sb1000_end_get_set_command
c_func
(paren
r_const
r_int
id|ioaddr
(braket
)braket
comma
r_const
r_char
op_star
id|name
)paren
suffix:semicolon
r_static
r_inline
r_int
id|sb1000_activate
c_func
(paren
r_const
r_int
id|ioaddr
(braket
)braket
comma
r_const
r_char
op_star
id|name
)paren
suffix:semicolon
r_static
r_inline
r_int
id|sb1000_get_firmware_version
c_func
(paren
r_const
r_int
id|ioaddr
(braket
)braket
comma
r_const
r_char
op_star
id|name
comma
r_int
r_char
id|version
(braket
)braket
comma
r_int
id|do_end
)paren
suffix:semicolon
r_static
r_inline
r_int
id|sb1000_get_frequency
c_func
(paren
r_const
r_int
id|ioaddr
(braket
)braket
comma
r_const
r_char
op_star
id|name
comma
r_int
op_star
id|frequency
)paren
suffix:semicolon
r_static
r_inline
r_int
id|sb1000_set_frequency
c_func
(paren
r_const
r_int
id|ioaddr
(braket
)braket
comma
r_const
r_char
op_star
id|name
comma
r_int
id|frequency
)paren
suffix:semicolon
r_static
r_inline
r_int
id|sb1000_get_PIDs
c_func
(paren
r_const
r_int
id|ioaddr
(braket
)braket
comma
r_const
r_char
op_star
id|name
comma
r_int
id|PID
(braket
)braket
)paren
suffix:semicolon
r_static
r_inline
r_int
id|sb1000_set_PIDs
c_func
(paren
r_const
r_int
id|ioaddr
(braket
)braket
comma
r_const
r_char
op_star
id|name
comma
r_const
r_int
id|PID
(braket
)braket
)paren
suffix:semicolon
multiline_comment|/* SB1000 commands for frame rx interrupt */
r_static
r_inline
r_int
id|sb1000_rx
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_inline
r_void
id|sb1000_error_dpc
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
multiline_comment|/* probe for SB1000 using Plug-n-Play mechanism */
r_int
DECL|function|sb1000_probe
id|sb1000_probe
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_int
r_int
id|ioaddr
(braket
l_int|2
)braket
comma
id|irq
suffix:semicolon
r_struct
id|pci_dev
op_star
id|idev
op_assign
l_int|NULL
suffix:semicolon
r_int
r_int
id|serial_number
suffix:semicolon
r_while
c_loop
(paren
l_int|1
)paren
(brace
multiline_comment|/*&n;&t;&t; *&t;Find the card&n;&t;&t; */
id|idev
op_assign
id|isapnp_find_dev
c_func
(paren
l_int|NULL
comma
id|ISAPNP_VENDOR
c_func
(paren
l_char|&squot;G&squot;
comma
l_char|&squot;I&squot;
comma
l_char|&squot;C&squot;
)paren
comma
id|ISAPNP_FUNCTION
c_func
(paren
l_int|0x1000
)paren
comma
id|idev
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t; *&t;No card&n;&t;&t; */
r_if
c_cond
(paren
id|idev
op_eq
l_int|NULL
)paren
(brace
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
multiline_comment|/*&n;&t;&t; *&t;Bring it online&n;&t;&t; */
id|idev
op_member_access_from_pointer
id|prepare
c_func
(paren
id|idev
)paren
suffix:semicolon
id|idev
op_member_access_from_pointer
id|activate
c_func
(paren
id|idev
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t; *&t;Ports free ?&n;&t;&t; */
r_if
c_cond
(paren
op_logical_neg
id|idev-&gt;resource
(braket
l_int|0
)braket
dot
id|start
op_logical_or
id|check_region
c_func
(paren
id|idev-&gt;resource
(braket
l_int|0
)braket
dot
id|start
comma
l_int|16
)paren
)paren
(brace
r_continue
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|idev-&gt;resource
(braket
l_int|1
)braket
dot
id|start
op_logical_or
id|check_region
c_func
(paren
id|idev-&gt;resource
(braket
l_int|1
)braket
dot
id|start
comma
l_int|16
)paren
)paren
(brace
r_continue
suffix:semicolon
)brace
id|serial_number
op_assign
id|idev-&gt;bus-&gt;serial
suffix:semicolon
id|ioaddr
(braket
l_int|0
)braket
op_assign
id|idev-&gt;resource
(braket
l_int|0
)braket
dot
id|start
suffix:semicolon
id|ioaddr
(braket
l_int|1
)braket
op_assign
id|idev-&gt;resource
(braket
l_int|1
)braket
dot
id|start
suffix:semicolon
id|irq
op_assign
id|idev-&gt;irq
suffix:semicolon
multiline_comment|/* check I/O base and IRQ */
r_if
c_cond
(paren
id|dev-&gt;base_addr
op_ne
l_int|0
op_logical_and
id|dev-&gt;base_addr
op_ne
id|ioaddr
(braket
l_int|0
)braket
)paren
r_continue
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;rmem_end
op_ne
l_int|0
op_logical_and
id|dev-&gt;rmem_end
op_ne
id|ioaddr
(braket
l_int|1
)braket
)paren
r_continue
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;irq
op_ne
l_int|0
op_logical_and
id|dev-&gt;irq
op_ne
id|irq
)paren
r_continue
suffix:semicolon
multiline_comment|/*&n;&t;&t; *&t;Ok set it up.&n;&t;&t; */
id|dev-&gt;base_addr
op_assign
id|ioaddr
(braket
l_int|0
)braket
suffix:semicolon
multiline_comment|/* rmem_end holds the second I/O address - fv */
id|dev-&gt;rmem_end
op_assign
id|ioaddr
(braket
l_int|1
)braket
suffix:semicolon
id|dev-&gt;irq
op_assign
id|irq
suffix:semicolon
r_if
c_cond
(paren
id|sb1000_debug
OG
l_int|0
)paren
id|printk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;%s: sb1000 at (%#3.3lx,%#3.3lx), &quot;
l_string|&quot;S/N %#8.8x, IRQ %d.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|dev-&gt;base_addr
comma
id|dev-&gt;rmem_end
comma
id|serial_number
comma
id|dev-&gt;irq
)paren
suffix:semicolon
id|dev
op_assign
id|init_etherdev
c_func
(paren
id|dev
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dev
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|SET_MODULE_OWNER
c_func
(paren
id|dev
)paren
suffix:semicolon
multiline_comment|/* Make up a SB1000-specific-data structure. */
id|dev-&gt;priv
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|sb1000_private
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;priv
op_eq
l_int|NULL
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|memset
c_func
(paren
id|dev-&gt;priv
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|sb1000_private
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sb1000_debug
OG
l_int|0
)paren
id|printk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;%s&quot;
comma
id|version
)paren
suffix:semicolon
multiline_comment|/* The SB1000-specific entries in the device structure. */
id|dev-&gt;open
op_assign
id|sb1000_open
suffix:semicolon
id|dev-&gt;do_ioctl
op_assign
id|sb1000_dev_ioctl
suffix:semicolon
id|dev-&gt;hard_start_xmit
op_assign
id|sb1000_start_xmit
suffix:semicolon
id|dev-&gt;stop
op_assign
id|sb1000_close
suffix:semicolon
id|dev-&gt;get_stats
op_assign
id|sb1000_stats
suffix:semicolon
multiline_comment|/* Fill in the generic fields of the device structure. */
id|dev-&gt;change_mtu
op_assign
l_int|NULL
suffix:semicolon
id|dev-&gt;hard_header
op_assign
l_int|NULL
suffix:semicolon
id|dev-&gt;rebuild_header
op_assign
l_int|NULL
suffix:semicolon
id|dev-&gt;set_mac_address
op_assign
l_int|NULL
suffix:semicolon
id|dev-&gt;header_cache_update
op_assign
l_int|NULL
suffix:semicolon
id|dev-&gt;type
op_assign
id|ARPHRD_ETHER
suffix:semicolon
id|dev-&gt;hard_header_len
op_assign
l_int|0
suffix:semicolon
id|dev-&gt;mtu
op_assign
l_int|1500
suffix:semicolon
id|dev-&gt;addr_len
op_assign
id|ETH_ALEN
suffix:semicolon
multiline_comment|/* hardware address is 0:0:serial_number */
id|dev-&gt;dev_addr
(braket
l_int|0
)braket
op_assign
l_int|0
suffix:semicolon
id|dev-&gt;dev_addr
(braket
l_int|1
)braket
op_assign
l_int|0
suffix:semicolon
id|dev-&gt;dev_addr
(braket
l_int|2
)braket
op_assign
id|serial_number
op_rshift
l_int|24
op_amp
l_int|0xff
suffix:semicolon
id|dev-&gt;dev_addr
(braket
l_int|3
)braket
op_assign
id|serial_number
op_rshift
l_int|16
op_amp
l_int|0xff
suffix:semicolon
id|dev-&gt;dev_addr
(braket
l_int|4
)braket
op_assign
id|serial_number
op_rshift
l_int|8
op_amp
l_int|0xff
suffix:semicolon
id|dev-&gt;dev_addr
(braket
l_int|5
)braket
op_assign
id|serial_number
op_rshift
l_int|0
op_amp
l_int|0xff
suffix:semicolon
id|dev-&gt;tx_queue_len
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* New-style flags. */
id|dev-&gt;flags
op_assign
id|IFF_POINTOPOINT
op_or
id|IFF_NOARP
suffix:semicolon
multiline_comment|/* Lock resources */
id|request_region
c_func
(paren
id|ioaddr
(braket
l_int|0
)braket
comma
l_int|16
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|request_region
c_func
(paren
id|ioaddr
(braket
l_int|1
)braket
comma
l_int|16
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
)brace
"&f;"
multiline_comment|/*&n; * SB1000 hardware routines to be used during open/configuration phases&n; */
DECL|variable|TimeOutJiffies
r_const
r_int
id|TimeOutJiffies
op_assign
(paren
r_int
)paren
(paren
l_float|8.75
op_star
id|HZ
)paren
suffix:semicolon
DECL|function|nicedelay
r_static
r_inline
r_void
id|nicedelay
c_func
(paren
r_int
r_int
id|usecs
)paren
(brace
id|current-&gt;state
op_assign
id|TASK_INTERRUPTIBLE
suffix:semicolon
id|schedule_timeout
c_func
(paren
id|HZ
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/* Card Wait For Busy Clear (cannot be used during an interrupt) */
r_static
r_inline
r_int
DECL|function|card_wait_for_busy_clear
id|card_wait_for_busy_clear
c_func
(paren
r_const
r_int
id|ioaddr
(braket
)braket
comma
r_const
r_char
op_star
id|name
)paren
(brace
r_int
r_char
id|a
suffix:semicolon
r_int
r_int
id|timeout
suffix:semicolon
id|a
op_assign
id|inb
c_func
(paren
id|ioaddr
(braket
l_int|0
)braket
op_plus
l_int|7
)paren
suffix:semicolon
id|timeout
op_assign
id|jiffies
op_plus
id|TimeOutJiffies
suffix:semicolon
r_while
c_loop
(paren
id|a
op_amp
l_int|0x80
op_logical_or
id|a
op_amp
l_int|0x40
)paren
(brace
multiline_comment|/* a little sleep */
id|current-&gt;state
op_assign
id|TASK_INTERRUPTIBLE
suffix:semicolon
id|schedule_timeout
c_func
(paren
l_int|0
)paren
suffix:semicolon
id|a
op_assign
id|inb
c_func
(paren
id|ioaddr
(braket
l_int|0
)braket
op_plus
l_int|7
)paren
suffix:semicolon
r_if
c_cond
(paren
id|jiffies
op_ge
id|timeout
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: card_wait_for_busy_clear timeout&bslash;n&quot;
comma
id|name
)paren
suffix:semicolon
r_return
op_minus
id|ETIME
suffix:semicolon
)brace
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Card Wait For Ready (cannot be used during an interrupt) */
r_static
r_inline
r_int
DECL|function|card_wait_for_ready
id|card_wait_for_ready
c_func
(paren
r_const
r_int
id|ioaddr
(braket
)braket
comma
r_const
r_char
op_star
id|name
comma
r_int
r_char
id|in
(braket
)braket
)paren
(brace
r_int
r_char
id|a
suffix:semicolon
r_int
r_int
id|timeout
suffix:semicolon
id|a
op_assign
id|inb
c_func
(paren
id|ioaddr
(braket
l_int|1
)braket
op_plus
l_int|6
)paren
suffix:semicolon
id|timeout
op_assign
id|jiffies
op_plus
id|TimeOutJiffies
suffix:semicolon
r_while
c_loop
(paren
id|a
op_amp
l_int|0x80
op_logical_or
op_logical_neg
(paren
id|a
op_amp
l_int|0x40
)paren
)paren
(brace
multiline_comment|/* a little sleep */
id|current-&gt;state
op_assign
id|TASK_INTERRUPTIBLE
suffix:semicolon
id|schedule_timeout
c_func
(paren
l_int|0
)paren
suffix:semicolon
id|a
op_assign
id|inb
c_func
(paren
id|ioaddr
(braket
l_int|1
)braket
op_plus
l_int|6
)paren
suffix:semicolon
r_if
c_cond
(paren
id|jiffies
op_ge
id|timeout
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: card_wait_for_ready timeout&bslash;n&quot;
comma
id|name
)paren
suffix:semicolon
r_return
op_minus
id|ETIME
suffix:semicolon
)brace
)brace
id|in
(braket
l_int|1
)braket
op_assign
id|inb
c_func
(paren
id|ioaddr
(braket
l_int|0
)braket
op_plus
l_int|1
)paren
suffix:semicolon
id|in
(braket
l_int|2
)braket
op_assign
id|inb
c_func
(paren
id|ioaddr
(braket
l_int|0
)braket
op_plus
l_int|2
)paren
suffix:semicolon
id|in
(braket
l_int|3
)braket
op_assign
id|inb
c_func
(paren
id|ioaddr
(braket
l_int|0
)braket
op_plus
l_int|3
)paren
suffix:semicolon
id|in
(braket
l_int|4
)braket
op_assign
id|inb
c_func
(paren
id|ioaddr
(braket
l_int|0
)braket
op_plus
l_int|4
)paren
suffix:semicolon
id|in
(braket
l_int|0
)braket
op_assign
id|inb
c_func
(paren
id|ioaddr
(braket
l_int|0
)braket
op_plus
l_int|5
)paren
suffix:semicolon
id|in
(braket
l_int|6
)braket
op_assign
id|inb
c_func
(paren
id|ioaddr
(braket
l_int|0
)braket
op_plus
l_int|6
)paren
suffix:semicolon
id|in
(braket
l_int|5
)braket
op_assign
id|inb
c_func
(paren
id|ioaddr
(braket
l_int|1
)braket
op_plus
l_int|6
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Card Send Command (cannot be used during an interrupt) */
r_static
r_inline
r_int
DECL|function|card_send_command
id|card_send_command
c_func
(paren
r_const
r_int
id|ioaddr
(braket
)braket
comma
r_const
r_char
op_star
id|name
comma
r_const
r_int
r_char
id|out
(braket
)braket
comma
r_int
r_char
id|in
(braket
)braket
)paren
(brace
r_int
id|status
comma
id|x
suffix:semicolon
r_if
c_cond
(paren
(paren
id|status
op_assign
id|card_wait_for_busy_clear
c_func
(paren
id|ioaddr
comma
id|name
)paren
)paren
)paren
r_return
id|status
suffix:semicolon
id|outb
c_func
(paren
l_int|0xa0
comma
id|ioaddr
(braket
l_int|0
)braket
op_plus
l_int|6
)paren
suffix:semicolon
id|outb
c_func
(paren
id|out
(braket
l_int|2
)braket
comma
id|ioaddr
(braket
l_int|0
)braket
op_plus
l_int|1
)paren
suffix:semicolon
id|outb
c_func
(paren
id|out
(braket
l_int|3
)braket
comma
id|ioaddr
(braket
l_int|0
)braket
op_plus
l_int|2
)paren
suffix:semicolon
id|outb
c_func
(paren
id|out
(braket
l_int|4
)braket
comma
id|ioaddr
(braket
l_int|0
)braket
op_plus
l_int|3
)paren
suffix:semicolon
id|outb
c_func
(paren
id|out
(braket
l_int|5
)braket
comma
id|ioaddr
(braket
l_int|0
)braket
op_plus
l_int|4
)paren
suffix:semicolon
id|outb
c_func
(paren
id|out
(braket
l_int|1
)braket
comma
id|ioaddr
(braket
l_int|0
)braket
op_plus
l_int|5
)paren
suffix:semicolon
id|outb
c_func
(paren
l_int|0xa0
comma
id|ioaddr
(braket
l_int|0
)braket
op_plus
l_int|6
)paren
suffix:semicolon
id|outb
c_func
(paren
id|out
(braket
l_int|0
)braket
comma
id|ioaddr
(braket
l_int|0
)braket
op_plus
l_int|7
)paren
suffix:semicolon
r_if
c_cond
(paren
id|out
(braket
l_int|0
)braket
op_ne
l_int|0x20
op_logical_and
id|out
(braket
l_int|0
)braket
op_ne
l_int|0x30
)paren
(brace
r_if
c_cond
(paren
(paren
id|status
op_assign
id|card_wait_for_ready
c_func
(paren
id|ioaddr
comma
id|name
comma
id|in
)paren
)paren
)paren
r_return
id|status
suffix:semicolon
id|inb
c_func
(paren
id|ioaddr
(braket
l_int|0
)braket
op_plus
l_int|7
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sb1000_debug
OG
l_int|3
)paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%s: card_send_command &quot;
l_string|&quot;out: %02x%02x%02x%02x%02x%02x  &quot;
l_string|&quot;in: %02x%02x%02x%02x%02x%02x%02x&bslash;n&quot;
comma
id|name
comma
id|out
(braket
l_int|0
)braket
comma
id|out
(braket
l_int|1
)braket
comma
id|out
(braket
l_int|2
)braket
comma
id|out
(braket
l_int|3
)braket
comma
id|out
(braket
l_int|4
)braket
comma
id|out
(braket
l_int|5
)braket
comma
id|in
(braket
l_int|0
)braket
comma
id|in
(braket
l_int|1
)braket
comma
id|in
(braket
l_int|2
)braket
comma
id|in
(braket
l_int|3
)braket
comma
id|in
(braket
l_int|4
)braket
comma
id|in
(braket
l_int|5
)braket
comma
id|in
(braket
l_int|6
)braket
)paren
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|sb1000_debug
OG
l_int|3
)paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%s: card_send_command &quot;
l_string|&quot;out: %02x%02x%02x%02x%02x%02x&bslash;n&quot;
comma
id|name
comma
id|out
(braket
l_int|0
)braket
comma
id|out
(braket
l_int|1
)braket
comma
id|out
(braket
l_int|2
)braket
comma
id|out
(braket
l_int|3
)braket
comma
id|out
(braket
l_int|4
)braket
comma
id|out
(braket
l_int|5
)braket
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|out
(braket
l_int|1
)braket
op_eq
l_int|0x1b
)paren
(brace
id|x
op_assign
(paren
id|out
(braket
l_int|2
)braket
op_eq
l_int|0x02
)paren
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|out
(braket
l_int|0
)braket
op_ge
l_int|0x80
op_logical_and
id|in
(braket
l_int|0
)braket
op_ne
(paren
id|out
(braket
l_int|1
)braket
op_or
l_int|0x80
)paren
)paren
r_return
op_minus
id|EIO
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
"&f;"
multiline_comment|/*&n; * SB1000 hardware routines to be used during frame rx interrupt&n; */
DECL|variable|Sb1000TimeOutJiffies
r_const
r_int
id|Sb1000TimeOutJiffies
op_assign
l_int|7
op_star
id|HZ
suffix:semicolon
multiline_comment|/* Card Wait For Ready (to be used during frame rx) */
r_static
r_inline
r_int
DECL|function|sb1000_wait_for_ready
id|sb1000_wait_for_ready
c_func
(paren
r_const
r_int
id|ioaddr
(braket
)braket
comma
r_const
r_char
op_star
id|name
)paren
(brace
r_int
r_int
id|timeout
suffix:semicolon
id|timeout
op_assign
id|jiffies
op_plus
id|Sb1000TimeOutJiffies
suffix:semicolon
r_while
c_loop
(paren
id|inb
c_func
(paren
id|ioaddr
(braket
l_int|1
)braket
op_plus
l_int|6
)paren
op_amp
l_int|0x80
)paren
(brace
r_if
c_cond
(paren
id|jiffies
op_ge
id|timeout
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: sb1000_wait_for_ready timeout&bslash;n&quot;
comma
id|name
)paren
suffix:semicolon
r_return
op_minus
id|ETIME
suffix:semicolon
)brace
)brace
id|timeout
op_assign
id|jiffies
op_plus
id|Sb1000TimeOutJiffies
suffix:semicolon
r_while
c_loop
(paren
op_logical_neg
(paren
id|inb
c_func
(paren
id|ioaddr
(braket
l_int|1
)braket
op_plus
l_int|6
)paren
op_amp
l_int|0x40
)paren
)paren
(brace
r_if
c_cond
(paren
id|jiffies
op_ge
id|timeout
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: sb1000_wait_for_ready timeout&bslash;n&quot;
comma
id|name
)paren
suffix:semicolon
r_return
op_minus
id|ETIME
suffix:semicolon
)brace
)brace
id|inb
c_func
(paren
id|ioaddr
(braket
l_int|0
)braket
op_plus
l_int|7
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Card Wait For Ready Clear (to be used during frame rx) */
r_static
r_inline
r_int
DECL|function|sb1000_wait_for_ready_clear
id|sb1000_wait_for_ready_clear
c_func
(paren
r_const
r_int
id|ioaddr
(braket
)braket
comma
r_const
r_char
op_star
id|name
)paren
(brace
r_int
r_int
id|timeout
suffix:semicolon
id|timeout
op_assign
id|jiffies
op_plus
id|Sb1000TimeOutJiffies
suffix:semicolon
r_while
c_loop
(paren
id|inb
c_func
(paren
id|ioaddr
(braket
l_int|1
)braket
op_plus
l_int|6
)paren
op_amp
l_int|0x80
)paren
(brace
r_if
c_cond
(paren
id|jiffies
op_ge
id|timeout
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: sb1000_wait_for_ready_clear timeout&bslash;n&quot;
comma
id|name
)paren
suffix:semicolon
r_return
op_minus
id|ETIME
suffix:semicolon
)brace
)brace
id|timeout
op_assign
id|jiffies
op_plus
id|Sb1000TimeOutJiffies
suffix:semicolon
r_while
c_loop
(paren
id|inb
c_func
(paren
id|ioaddr
(braket
l_int|1
)braket
op_plus
l_int|6
)paren
op_amp
l_int|0x40
)paren
(brace
r_if
c_cond
(paren
id|jiffies
op_ge
id|timeout
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: sb1000_wait_for_ready_clear timeout&bslash;n&quot;
comma
id|name
)paren
suffix:semicolon
r_return
op_minus
id|ETIME
suffix:semicolon
)brace
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Card Send Command (to be used during frame rx) */
r_static
r_inline
r_void
DECL|function|sb1000_send_command
id|sb1000_send_command
c_func
(paren
r_const
r_int
id|ioaddr
(braket
)braket
comma
r_const
r_char
op_star
id|name
comma
r_const
r_int
r_char
id|out
(braket
)braket
)paren
(brace
id|outb
c_func
(paren
id|out
(braket
l_int|2
)braket
comma
id|ioaddr
(braket
l_int|0
)braket
op_plus
l_int|1
)paren
suffix:semicolon
id|outb
c_func
(paren
id|out
(braket
l_int|3
)braket
comma
id|ioaddr
(braket
l_int|0
)braket
op_plus
l_int|2
)paren
suffix:semicolon
id|outb
c_func
(paren
id|out
(braket
l_int|4
)braket
comma
id|ioaddr
(braket
l_int|0
)braket
op_plus
l_int|3
)paren
suffix:semicolon
id|outb
c_func
(paren
id|out
(braket
l_int|5
)braket
comma
id|ioaddr
(braket
l_int|0
)braket
op_plus
l_int|4
)paren
suffix:semicolon
id|outb
c_func
(paren
id|out
(braket
l_int|1
)braket
comma
id|ioaddr
(braket
l_int|0
)braket
op_plus
l_int|5
)paren
suffix:semicolon
id|outb
c_func
(paren
id|out
(braket
l_int|0
)braket
comma
id|ioaddr
(braket
l_int|0
)braket
op_plus
l_int|7
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sb1000_debug
OG
l_int|3
)paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%s: sb1000_send_command out: %02x%02x%02x%02x&quot;
l_string|&quot;%02x%02x&bslash;n&quot;
comma
id|name
comma
id|out
(braket
l_int|0
)braket
comma
id|out
(braket
l_int|1
)braket
comma
id|out
(braket
l_int|2
)braket
comma
id|out
(braket
l_int|3
)braket
comma
id|out
(braket
l_int|4
)braket
comma
id|out
(braket
l_int|5
)braket
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/* Card Read Status (to be used during frame rx) */
r_static
r_inline
r_void
DECL|function|sb1000_read_status
id|sb1000_read_status
c_func
(paren
r_const
r_int
id|ioaddr
(braket
)braket
comma
r_int
r_char
id|in
(braket
)braket
)paren
(brace
id|in
(braket
l_int|1
)braket
op_assign
id|inb
c_func
(paren
id|ioaddr
(braket
l_int|0
)braket
op_plus
l_int|1
)paren
suffix:semicolon
id|in
(braket
l_int|2
)braket
op_assign
id|inb
c_func
(paren
id|ioaddr
(braket
l_int|0
)braket
op_plus
l_int|2
)paren
suffix:semicolon
id|in
(braket
l_int|3
)braket
op_assign
id|inb
c_func
(paren
id|ioaddr
(braket
l_int|0
)braket
op_plus
l_int|3
)paren
suffix:semicolon
id|in
(braket
l_int|4
)braket
op_assign
id|inb
c_func
(paren
id|ioaddr
(braket
l_int|0
)braket
op_plus
l_int|4
)paren
suffix:semicolon
id|in
(braket
l_int|0
)braket
op_assign
id|inb
c_func
(paren
id|ioaddr
(braket
l_int|0
)braket
op_plus
l_int|5
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/* Issue Read Command (to be used during frame rx) */
r_static
r_inline
r_void
DECL|function|sb1000_issue_read_command
id|sb1000_issue_read_command
c_func
(paren
r_const
r_int
id|ioaddr
(braket
)braket
comma
r_const
r_char
op_star
id|name
)paren
(brace
r_const
r_int
r_char
id|Command0
(braket
l_int|6
)braket
op_assign
(brace
l_int|0x20
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x01
comma
l_int|0x00
comma
l_int|0x00
)brace
suffix:semicolon
id|sb1000_wait_for_ready_clear
c_func
(paren
id|ioaddr
comma
id|name
)paren
suffix:semicolon
id|outb
c_func
(paren
l_int|0xa0
comma
id|ioaddr
(braket
l_int|0
)braket
op_plus
l_int|6
)paren
suffix:semicolon
id|sb1000_send_command
c_func
(paren
id|ioaddr
comma
id|name
comma
id|Command0
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
"&f;"
multiline_comment|/*&n; * SB1000 commands for open/configuration&n; */
multiline_comment|/* reset SB1000 card */
r_static
r_inline
r_int
DECL|function|sb1000_reset
id|sb1000_reset
c_func
(paren
r_const
r_int
id|ioaddr
(braket
)braket
comma
r_const
r_char
op_star
id|name
)paren
(brace
r_int
r_char
id|st
(braket
l_int|7
)braket
suffix:semicolon
r_int
id|port
comma
id|status
suffix:semicolon
r_const
r_int
r_char
id|Command0
(braket
l_int|6
)braket
op_assign
(brace
l_int|0x80
comma
l_int|0x16
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
)brace
suffix:semicolon
id|port
op_assign
id|ioaddr
(braket
l_int|1
)braket
op_plus
l_int|6
suffix:semicolon
id|outb
c_func
(paren
l_int|0x4
comma
id|port
)paren
suffix:semicolon
id|inb
c_func
(paren
id|port
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|1000
)paren
suffix:semicolon
id|outb
c_func
(paren
l_int|0x0
comma
id|port
)paren
suffix:semicolon
id|inb
c_func
(paren
id|port
)paren
suffix:semicolon
id|nicedelay
c_func
(paren
l_int|60000
)paren
suffix:semicolon
id|outb
c_func
(paren
l_int|0x4
comma
id|port
)paren
suffix:semicolon
id|inb
c_func
(paren
id|port
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|1000
)paren
suffix:semicolon
id|outb
c_func
(paren
l_int|0x0
comma
id|port
)paren
suffix:semicolon
id|inb
c_func
(paren
id|port
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|status
op_assign
id|card_send_command
c_func
(paren
id|ioaddr
comma
id|name
comma
id|Command0
comma
id|st
)paren
)paren
)paren
r_return
id|status
suffix:semicolon
r_if
c_cond
(paren
id|st
(braket
l_int|3
)braket
op_ne
l_int|0xf0
)paren
r_return
op_minus
id|EIO
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* check SB1000 firmware CRC */
r_static
r_inline
r_int
DECL|function|sb1000_check_CRC
id|sb1000_check_CRC
c_func
(paren
r_const
r_int
id|ioaddr
(braket
)braket
comma
r_const
r_char
op_star
id|name
)paren
(brace
r_int
r_char
id|st
(braket
l_int|7
)braket
suffix:semicolon
r_int
id|crc
comma
id|status
suffix:semicolon
r_const
r_int
r_char
id|Command0
(braket
l_int|6
)braket
op_assign
(brace
l_int|0x80
comma
l_int|0x1f
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
)brace
suffix:semicolon
multiline_comment|/* check CRC */
r_if
c_cond
(paren
(paren
id|status
op_assign
id|card_send_command
c_func
(paren
id|ioaddr
comma
id|name
comma
id|Command0
comma
id|st
)paren
)paren
)paren
r_return
id|status
suffix:semicolon
r_if
c_cond
(paren
id|st
(braket
l_int|1
)braket
op_ne
id|st
(braket
l_int|3
)braket
op_logical_or
id|st
(braket
l_int|2
)braket
op_ne
id|st
(braket
l_int|4
)braket
)paren
r_return
op_minus
id|EIO
suffix:semicolon
id|crc
op_assign
id|st
(braket
l_int|1
)braket
op_lshift
l_int|8
op_or
id|st
(braket
l_int|2
)braket
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_inline
r_int
DECL|function|sb1000_start_get_set_command
id|sb1000_start_get_set_command
c_func
(paren
r_const
r_int
id|ioaddr
(braket
)braket
comma
r_const
r_char
op_star
id|name
)paren
(brace
r_int
r_char
id|st
(braket
l_int|7
)braket
suffix:semicolon
r_const
r_int
r_char
id|Command0
(braket
l_int|6
)braket
op_assign
(brace
l_int|0x80
comma
l_int|0x1b
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
)brace
suffix:semicolon
r_return
id|card_send_command
c_func
(paren
id|ioaddr
comma
id|name
comma
id|Command0
comma
id|st
)paren
suffix:semicolon
)brace
r_static
r_inline
r_int
DECL|function|sb1000_end_get_set_command
id|sb1000_end_get_set_command
c_func
(paren
r_const
r_int
id|ioaddr
(braket
)braket
comma
r_const
r_char
op_star
id|name
)paren
(brace
r_int
r_char
id|st
(braket
l_int|7
)braket
suffix:semicolon
r_int
id|status
suffix:semicolon
r_const
r_int
r_char
id|Command0
(braket
l_int|6
)braket
op_assign
(brace
l_int|0x80
comma
l_int|0x1b
comma
l_int|0x02
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
)brace
suffix:semicolon
r_const
r_int
r_char
id|Command1
(braket
l_int|6
)braket
op_assign
(brace
l_int|0x20
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
)brace
suffix:semicolon
r_if
c_cond
(paren
(paren
id|status
op_assign
id|card_send_command
c_func
(paren
id|ioaddr
comma
id|name
comma
id|Command0
comma
id|st
)paren
)paren
)paren
r_return
id|status
suffix:semicolon
r_return
id|card_send_command
c_func
(paren
id|ioaddr
comma
id|name
comma
id|Command1
comma
id|st
)paren
suffix:semicolon
)brace
r_static
r_inline
r_int
DECL|function|sb1000_activate
id|sb1000_activate
c_func
(paren
r_const
r_int
id|ioaddr
(braket
)braket
comma
r_const
r_char
op_star
id|name
)paren
(brace
r_int
r_char
id|st
(braket
l_int|7
)braket
suffix:semicolon
r_int
id|status
suffix:semicolon
r_const
r_int
r_char
id|Command0
(braket
l_int|6
)braket
op_assign
(brace
l_int|0x80
comma
l_int|0x11
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
)brace
suffix:semicolon
r_const
r_int
r_char
id|Command1
(braket
l_int|6
)braket
op_assign
(brace
l_int|0x80
comma
l_int|0x16
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
)brace
suffix:semicolon
id|nicedelay
c_func
(paren
l_int|50000
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|status
op_assign
id|card_send_command
c_func
(paren
id|ioaddr
comma
id|name
comma
id|Command0
comma
id|st
)paren
)paren
)paren
r_return
id|status
suffix:semicolon
r_if
c_cond
(paren
(paren
id|status
op_assign
id|card_send_command
c_func
(paren
id|ioaddr
comma
id|name
comma
id|Command1
comma
id|st
)paren
)paren
)paren
r_return
id|status
suffix:semicolon
r_if
c_cond
(paren
id|st
(braket
l_int|3
)braket
op_ne
l_int|0xf1
)paren
(brace
r_if
c_cond
(paren
(paren
id|status
op_assign
id|sb1000_start_get_set_command
c_func
(paren
id|ioaddr
comma
id|name
)paren
)paren
)paren
r_return
id|status
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
id|udelay
c_func
(paren
l_int|1000
)paren
suffix:semicolon
r_return
id|sb1000_start_get_set_command
c_func
(paren
id|ioaddr
comma
id|name
)paren
suffix:semicolon
)brace
multiline_comment|/* get SB1000 firmware version */
r_static
r_inline
r_int
DECL|function|sb1000_get_firmware_version
id|sb1000_get_firmware_version
c_func
(paren
r_const
r_int
id|ioaddr
(braket
)braket
comma
r_const
r_char
op_star
id|name
comma
r_int
r_char
id|version
(braket
)braket
comma
r_int
id|do_end
)paren
(brace
r_int
r_char
id|st
(braket
l_int|7
)braket
suffix:semicolon
r_int
id|status
suffix:semicolon
r_const
r_int
r_char
id|Command0
(braket
l_int|6
)braket
op_assign
(brace
l_int|0x80
comma
l_int|0x23
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
)brace
suffix:semicolon
r_if
c_cond
(paren
(paren
id|status
op_assign
id|sb1000_start_get_set_command
c_func
(paren
id|ioaddr
comma
id|name
)paren
)paren
)paren
r_return
id|status
suffix:semicolon
r_if
c_cond
(paren
(paren
id|status
op_assign
id|card_send_command
c_func
(paren
id|ioaddr
comma
id|name
comma
id|Command0
comma
id|st
)paren
)paren
)paren
r_return
id|status
suffix:semicolon
r_if
c_cond
(paren
id|st
(braket
l_int|0
)braket
op_ne
l_int|0xa3
)paren
r_return
op_minus
id|EIO
suffix:semicolon
id|version
(braket
l_int|0
)braket
op_assign
id|st
(braket
l_int|1
)braket
suffix:semicolon
id|version
(braket
l_int|1
)braket
op_assign
id|st
(braket
l_int|2
)braket
suffix:semicolon
r_if
c_cond
(paren
id|do_end
)paren
r_return
id|sb1000_end_get_set_command
c_func
(paren
id|ioaddr
comma
id|name
)paren
suffix:semicolon
r_else
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* get SB1000 frequency */
r_static
r_inline
r_int
DECL|function|sb1000_get_frequency
id|sb1000_get_frequency
c_func
(paren
r_const
r_int
id|ioaddr
(braket
)braket
comma
r_const
r_char
op_star
id|name
comma
r_int
op_star
id|frequency
)paren
(brace
r_int
r_char
id|st
(braket
l_int|7
)braket
suffix:semicolon
r_int
id|status
suffix:semicolon
r_const
r_int
r_char
id|Command0
(braket
l_int|6
)braket
op_assign
(brace
l_int|0x80
comma
l_int|0x44
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
)brace
suffix:semicolon
id|udelay
c_func
(paren
l_int|1000
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|status
op_assign
id|sb1000_start_get_set_command
c_func
(paren
id|ioaddr
comma
id|name
)paren
)paren
)paren
r_return
id|status
suffix:semicolon
r_if
c_cond
(paren
(paren
id|status
op_assign
id|card_send_command
c_func
(paren
id|ioaddr
comma
id|name
comma
id|Command0
comma
id|st
)paren
)paren
)paren
r_return
id|status
suffix:semicolon
op_star
id|frequency
op_assign
(paren
(paren
id|st
(braket
l_int|1
)braket
op_lshift
l_int|8
op_or
id|st
(braket
l_int|2
)braket
)paren
op_lshift
l_int|8
op_or
id|st
(braket
l_int|3
)braket
)paren
op_lshift
l_int|8
op_or
id|st
(braket
l_int|4
)braket
suffix:semicolon
r_return
id|sb1000_end_get_set_command
c_func
(paren
id|ioaddr
comma
id|name
)paren
suffix:semicolon
)brace
multiline_comment|/* set SB1000 frequency */
r_static
r_inline
r_int
DECL|function|sb1000_set_frequency
id|sb1000_set_frequency
c_func
(paren
r_const
r_int
id|ioaddr
(braket
)braket
comma
r_const
r_char
op_star
id|name
comma
r_int
id|frequency
)paren
(brace
r_int
r_char
id|st
(braket
l_int|7
)braket
suffix:semicolon
r_int
id|status
suffix:semicolon
r_int
r_char
id|Command0
(braket
l_int|6
)braket
op_assign
(brace
l_int|0x80
comma
l_int|0x29
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
)brace
suffix:semicolon
r_const
r_int
id|FrequencyLowerLimit
op_assign
l_int|57000
suffix:semicolon
r_const
r_int
id|FrequencyUpperLimit
op_assign
l_int|804000
suffix:semicolon
r_if
c_cond
(paren
id|frequency
template_param
id|FrequencyUpperLimit
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: frequency chosen (%d kHz) is not in the range &quot;
l_string|&quot;[%d,%d] kHz&bslash;n&quot;
comma
id|name
comma
id|frequency
comma
id|FrequencyLowerLimit
comma
id|FrequencyUpperLimit
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|udelay
c_func
(paren
l_int|1000
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|status
op_assign
id|sb1000_start_get_set_command
c_func
(paren
id|ioaddr
comma
id|name
)paren
)paren
)paren
r_return
id|status
suffix:semicolon
id|Command0
(braket
l_int|5
)braket
op_assign
id|frequency
op_amp
l_int|0xff
suffix:semicolon
id|frequency
op_rshift_assign
l_int|8
suffix:semicolon
id|Command0
(braket
l_int|4
)braket
op_assign
id|frequency
op_amp
l_int|0xff
suffix:semicolon
id|frequency
op_rshift_assign
l_int|8
suffix:semicolon
id|Command0
(braket
l_int|3
)braket
op_assign
id|frequency
op_amp
l_int|0xff
suffix:semicolon
id|frequency
op_rshift_assign
l_int|8
suffix:semicolon
id|Command0
(braket
l_int|2
)braket
op_assign
id|frequency
op_amp
l_int|0xff
suffix:semicolon
r_return
id|card_send_command
c_func
(paren
id|ioaddr
comma
id|name
comma
id|Command0
comma
id|st
)paren
suffix:semicolon
)brace
multiline_comment|/* get SB1000 PIDs */
r_static
r_inline
r_int
DECL|function|sb1000_get_PIDs
id|sb1000_get_PIDs
c_func
(paren
r_const
r_int
id|ioaddr
(braket
)braket
comma
r_const
r_char
op_star
id|name
comma
r_int
id|PID
(braket
)braket
)paren
(brace
r_int
r_char
id|st
(braket
l_int|7
)braket
suffix:semicolon
r_int
id|status
suffix:semicolon
r_const
r_int
r_char
id|Command0
(braket
l_int|6
)braket
op_assign
(brace
l_int|0x80
comma
l_int|0x40
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
)brace
suffix:semicolon
r_const
r_int
r_char
id|Command1
(braket
l_int|6
)braket
op_assign
(brace
l_int|0x80
comma
l_int|0x41
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
)brace
suffix:semicolon
r_const
r_int
r_char
id|Command2
(braket
l_int|6
)braket
op_assign
(brace
l_int|0x80
comma
l_int|0x42
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
)brace
suffix:semicolon
r_const
r_int
r_char
id|Command3
(braket
l_int|6
)braket
op_assign
(brace
l_int|0x80
comma
l_int|0x43
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
)brace
suffix:semicolon
id|udelay
c_func
(paren
l_int|1000
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|status
op_assign
id|sb1000_start_get_set_command
c_func
(paren
id|ioaddr
comma
id|name
)paren
)paren
)paren
r_return
id|status
suffix:semicolon
r_if
c_cond
(paren
(paren
id|status
op_assign
id|card_send_command
c_func
(paren
id|ioaddr
comma
id|name
comma
id|Command0
comma
id|st
)paren
)paren
)paren
r_return
id|status
suffix:semicolon
id|PID
(braket
l_int|0
)braket
op_assign
id|st
(braket
l_int|1
)braket
op_lshift
l_int|8
op_or
id|st
(braket
l_int|2
)braket
suffix:semicolon
r_if
c_cond
(paren
(paren
id|status
op_assign
id|card_send_command
c_func
(paren
id|ioaddr
comma
id|name
comma
id|Command1
comma
id|st
)paren
)paren
)paren
r_return
id|status
suffix:semicolon
id|PID
(braket
l_int|1
)braket
op_assign
id|st
(braket
l_int|1
)braket
op_lshift
l_int|8
op_or
id|st
(braket
l_int|2
)braket
suffix:semicolon
r_if
c_cond
(paren
(paren
id|status
op_assign
id|card_send_command
c_func
(paren
id|ioaddr
comma
id|name
comma
id|Command2
comma
id|st
)paren
)paren
)paren
r_return
id|status
suffix:semicolon
id|PID
(braket
l_int|2
)braket
op_assign
id|st
(braket
l_int|1
)braket
op_lshift
l_int|8
op_or
id|st
(braket
l_int|2
)braket
suffix:semicolon
r_if
c_cond
(paren
(paren
id|status
op_assign
id|card_send_command
c_func
(paren
id|ioaddr
comma
id|name
comma
id|Command3
comma
id|st
)paren
)paren
)paren
r_return
id|status
suffix:semicolon
id|PID
(braket
l_int|3
)braket
op_assign
id|st
(braket
l_int|1
)braket
op_lshift
l_int|8
op_or
id|st
(braket
l_int|2
)braket
suffix:semicolon
r_return
id|sb1000_end_get_set_command
c_func
(paren
id|ioaddr
comma
id|name
)paren
suffix:semicolon
)brace
multiline_comment|/* set SB1000 PIDs */
r_static
r_inline
r_int
DECL|function|sb1000_set_PIDs
id|sb1000_set_PIDs
c_func
(paren
r_const
r_int
id|ioaddr
(braket
)braket
comma
r_const
r_char
op_star
id|name
comma
r_const
r_int
id|PID
(braket
)braket
)paren
(brace
r_int
r_char
id|st
(braket
l_int|7
)braket
suffix:semicolon
r_int
id|p
suffix:semicolon
r_int
id|status
suffix:semicolon
r_int
r_char
id|Command0
(braket
l_int|6
)braket
op_assign
(brace
l_int|0x80
comma
l_int|0x31
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
)brace
suffix:semicolon
r_int
r_char
id|Command1
(braket
l_int|6
)braket
op_assign
(brace
l_int|0x80
comma
l_int|0x32
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
)brace
suffix:semicolon
r_int
r_char
id|Command2
(braket
l_int|6
)braket
op_assign
(brace
l_int|0x80
comma
l_int|0x33
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
)brace
suffix:semicolon
r_int
r_char
id|Command3
(braket
l_int|6
)braket
op_assign
(brace
l_int|0x80
comma
l_int|0x34
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
)brace
suffix:semicolon
r_const
r_int
r_char
id|Command4
(braket
l_int|6
)braket
op_assign
(brace
l_int|0x80
comma
l_int|0x2e
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
)brace
suffix:semicolon
id|udelay
c_func
(paren
l_int|1000
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|status
op_assign
id|sb1000_start_get_set_command
c_func
(paren
id|ioaddr
comma
id|name
)paren
)paren
)paren
r_return
id|status
suffix:semicolon
id|p
op_assign
id|PID
(braket
l_int|0
)braket
suffix:semicolon
id|Command0
(braket
l_int|3
)braket
op_assign
id|p
op_amp
l_int|0xff
suffix:semicolon
id|p
op_rshift_assign
l_int|8
suffix:semicolon
id|Command0
(braket
l_int|2
)braket
op_assign
id|p
op_amp
l_int|0xff
suffix:semicolon
r_if
c_cond
(paren
(paren
id|status
op_assign
id|card_send_command
c_func
(paren
id|ioaddr
comma
id|name
comma
id|Command0
comma
id|st
)paren
)paren
)paren
r_return
id|status
suffix:semicolon
id|p
op_assign
id|PID
(braket
l_int|1
)braket
suffix:semicolon
id|Command1
(braket
l_int|3
)braket
op_assign
id|p
op_amp
l_int|0xff
suffix:semicolon
id|p
op_rshift_assign
l_int|8
suffix:semicolon
id|Command1
(braket
l_int|2
)braket
op_assign
id|p
op_amp
l_int|0xff
suffix:semicolon
r_if
c_cond
(paren
(paren
id|status
op_assign
id|card_send_command
c_func
(paren
id|ioaddr
comma
id|name
comma
id|Command1
comma
id|st
)paren
)paren
)paren
r_return
id|status
suffix:semicolon
id|p
op_assign
id|PID
(braket
l_int|2
)braket
suffix:semicolon
id|Command2
(braket
l_int|3
)braket
op_assign
id|p
op_amp
l_int|0xff
suffix:semicolon
id|p
op_rshift_assign
l_int|8
suffix:semicolon
id|Command2
(braket
l_int|2
)braket
op_assign
id|p
op_amp
l_int|0xff
suffix:semicolon
r_if
c_cond
(paren
(paren
id|status
op_assign
id|card_send_command
c_func
(paren
id|ioaddr
comma
id|name
comma
id|Command2
comma
id|st
)paren
)paren
)paren
r_return
id|status
suffix:semicolon
id|p
op_assign
id|PID
(braket
l_int|3
)braket
suffix:semicolon
id|Command3
(braket
l_int|3
)braket
op_assign
id|p
op_amp
l_int|0xff
suffix:semicolon
id|p
op_rshift_assign
l_int|8
suffix:semicolon
id|Command3
(braket
l_int|2
)braket
op_assign
id|p
op_amp
l_int|0xff
suffix:semicolon
r_if
c_cond
(paren
(paren
id|status
op_assign
id|card_send_command
c_func
(paren
id|ioaddr
comma
id|name
comma
id|Command3
comma
id|st
)paren
)paren
)paren
r_return
id|status
suffix:semicolon
r_if
c_cond
(paren
(paren
id|status
op_assign
id|card_send_command
c_func
(paren
id|ioaddr
comma
id|name
comma
id|Command4
comma
id|st
)paren
)paren
)paren
r_return
id|status
suffix:semicolon
r_return
id|sb1000_end_get_set_command
c_func
(paren
id|ioaddr
comma
id|name
)paren
suffix:semicolon
)brace
"&f;"
r_static
r_inline
r_void
DECL|function|sb1000_print_status_buffer
id|sb1000_print_status_buffer
c_func
(paren
r_const
r_char
op_star
id|name
comma
r_int
r_char
id|st
(braket
)braket
comma
r_int
r_char
id|buffer
(braket
)braket
comma
r_int
id|size
)paren
(brace
r_int
id|i
comma
id|j
comma
id|k
suffix:semicolon
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%s: status: %02x %02x&bslash;n&quot;
comma
id|name
comma
id|st
(braket
l_int|0
)braket
comma
id|st
(braket
l_int|1
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
id|buffer
(braket
l_int|24
)braket
op_eq
l_int|0x08
op_logical_and
id|buffer
(braket
l_int|25
)braket
op_eq
l_int|0x00
op_logical_and
id|buffer
(braket
l_int|26
)braket
op_eq
l_int|0x45
)paren
(brace
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%s: length: %d protocol: %d from: %d.%d.%d.%d:%d &quot;
l_string|&quot;to %d.%d.%d.%d:%d&bslash;n&quot;
comma
id|name
comma
id|buffer
(braket
l_int|28
)braket
op_lshift
l_int|8
op_or
id|buffer
(braket
l_int|29
)braket
comma
id|buffer
(braket
l_int|35
)braket
comma
id|buffer
(braket
l_int|38
)braket
comma
id|buffer
(braket
l_int|39
)braket
comma
id|buffer
(braket
l_int|40
)braket
comma
id|buffer
(braket
l_int|41
)braket
comma
id|buffer
(braket
l_int|46
)braket
op_lshift
l_int|8
op_or
id|buffer
(braket
l_int|47
)braket
comma
id|buffer
(braket
l_int|42
)braket
comma
id|buffer
(braket
l_int|43
)braket
comma
id|buffer
(braket
l_int|44
)braket
comma
id|buffer
(braket
l_int|45
)braket
comma
id|buffer
(braket
l_int|48
)braket
op_lshift
l_int|8
op_or
id|buffer
(braket
l_int|49
)braket
)paren
suffix:semicolon
)brace
r_else
(brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
comma
id|k
op_assign
l_int|0
suffix:semicolon
id|i
OL
(paren
id|size
op_plus
l_int|7
)paren
op_div
l_int|8
suffix:semicolon
id|i
op_increment
)paren
(brace
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%s: %s&quot;
comma
id|name
comma
id|i
ques
c_cond
l_string|&quot;       &quot;
suffix:colon
l_string|&quot;buffer:&quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|j
op_assign
l_int|0
suffix:semicolon
id|j
OL
l_int|8
op_logical_and
id|k
OL
id|size
suffix:semicolon
id|j
op_increment
comma
id|k
op_increment
)paren
id|printk
c_func
(paren
l_string|&quot; %02x&quot;
comma
id|buffer
(braket
id|k
)braket
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
)brace
)brace
r_return
suffix:semicolon
)brace
multiline_comment|/*&n; * SB1000 commands for frame rx interrupt&n; */
multiline_comment|/* receive a single frame and assemble datagram&n; * (this is the heart of the interrupt routine)&n; */
r_static
r_inline
r_int
DECL|function|sb1000_rx
id|sb1000_rx
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
DECL|macro|FRAMESIZE
mdefine_line|#define FRAMESIZE 184
r_int
r_char
id|st
(braket
l_int|2
)braket
comma
id|buffer
(braket
id|FRAMESIZE
)braket
comma
id|session_id
comma
id|frame_id
suffix:semicolon
r_int
id|dlen
suffix:semicolon
r_int
id|ioaddr
comma
id|ns
suffix:semicolon
r_int
r_int
id|skbsize
suffix:semicolon
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
r_struct
id|sb1000_private
op_star
id|lp
op_assign
(paren
r_struct
id|sb1000_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_struct
id|net_device_stats
op_star
id|stats
op_assign
op_amp
id|lp-&gt;stats
suffix:semicolon
multiline_comment|/* SB1000 frame constants */
r_const
r_int
id|FrameSize
op_assign
id|FRAMESIZE
suffix:semicolon
r_const
r_int
id|NewDatagramHeaderSkip
op_assign
l_int|8
suffix:semicolon
r_const
r_int
id|NewDatagramHeaderSize
op_assign
id|NewDatagramHeaderSkip
op_plus
l_int|18
suffix:semicolon
r_const
r_int
id|NewDatagramDataSize
op_assign
id|FrameSize
op_minus
id|NewDatagramHeaderSize
suffix:semicolon
r_const
r_int
id|ContDatagramHeaderSkip
op_assign
l_int|7
suffix:semicolon
r_const
r_int
id|ContDatagramHeaderSize
op_assign
id|ContDatagramHeaderSkip
op_plus
l_int|1
suffix:semicolon
r_const
r_int
id|ContDatagramDataSize
op_assign
id|FrameSize
op_minus
id|ContDatagramHeaderSize
suffix:semicolon
r_const
r_int
id|TrailerSize
op_assign
l_int|4
suffix:semicolon
id|ioaddr
op_assign
id|dev-&gt;base_addr
suffix:semicolon
id|insw
c_func
(paren
id|ioaddr
comma
(paren
r_int
r_int
op_star
)paren
id|st
comma
l_int|1
)paren
suffix:semicolon
macro_line|#ifdef XXXDEBUG
id|printk
c_func
(paren
l_string|&quot;cm0: received: %02x %02x&bslash;n&quot;
comma
id|st
(braket
l_int|0
)braket
comma
id|st
(braket
l_int|1
)braket
)paren
suffix:semicolon
macro_line|#endif /* XXXDEBUG */
id|lp-&gt;rx_frames
op_increment
suffix:semicolon
multiline_comment|/* decide if it is a good or bad frame */
r_for
c_loop
(paren
id|ns
op_assign
l_int|0
suffix:semicolon
id|ns
OL
id|NPIDS
suffix:semicolon
id|ns
op_increment
)paren
(brace
id|session_id
op_assign
id|lp-&gt;rx_session_id
(braket
id|ns
)braket
suffix:semicolon
id|frame_id
op_assign
id|lp-&gt;rx_frame_id
(braket
id|ns
)braket
suffix:semicolon
r_if
c_cond
(paren
id|st
(braket
l_int|0
)braket
op_eq
id|session_id
)paren
(brace
r_if
c_cond
(paren
id|st
(braket
l_int|1
)braket
op_eq
id|frame_id
op_logical_or
(paren
op_logical_neg
id|frame_id
op_logical_and
(paren
id|st
(braket
l_int|1
)braket
op_amp
l_int|0xf0
)paren
op_eq
l_int|0x30
)paren
)paren
(brace
r_goto
id|good_frame
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
(paren
id|st
(braket
l_int|1
)braket
op_amp
l_int|0xf0
)paren
op_eq
l_int|0x30
op_logical_and
(paren
id|st
(braket
l_int|0
)braket
op_amp
l_int|0x40
)paren
)paren
(brace
r_goto
id|skipped_frame
suffix:semicolon
)brace
r_else
(brace
r_goto
id|bad_frame
suffix:semicolon
)brace
)brace
r_else
r_if
c_cond
(paren
id|st
(braket
l_int|0
)braket
op_eq
(paren
id|session_id
op_or
l_int|0x40
)paren
)paren
(brace
r_if
c_cond
(paren
(paren
id|st
(braket
l_int|1
)braket
op_amp
l_int|0xf0
)paren
op_eq
l_int|0x30
)paren
(brace
r_goto
id|skipped_frame
suffix:semicolon
)brace
r_else
(brace
r_goto
id|bad_frame
suffix:semicolon
)brace
)brace
)brace
r_goto
id|bad_frame
suffix:semicolon
id|skipped_frame
suffix:colon
id|stats-&gt;rx_frame_errors
op_increment
suffix:semicolon
id|skb
op_assign
id|lp-&gt;rx_skb
(braket
id|ns
)braket
suffix:semicolon
r_if
c_cond
(paren
id|sb1000_debug
OG
l_int|1
)paren
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: missing frame(s): got %02x %02x &quot;
l_string|&quot;expecting %02x %02x&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|st
(braket
l_int|0
)braket
comma
id|st
(braket
l_int|1
)braket
comma
id|skb
ques
c_cond
id|session_id
suffix:colon
id|session_id
op_or
l_int|0x40
comma
id|frame_id
)paren
suffix:semicolon
r_if
c_cond
(paren
id|skb
)paren
(brace
id|dev_kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
id|skb
op_assign
l_int|0
suffix:semicolon
)brace
id|good_frame
suffix:colon
id|lp-&gt;rx_frame_id
(braket
id|ns
)braket
op_assign
l_int|0x30
op_or
(paren
(paren
id|st
(braket
l_int|1
)braket
op_plus
l_int|1
)paren
op_amp
l_int|0x0f
)paren
suffix:semicolon
multiline_comment|/* new datagram */
r_if
c_cond
(paren
id|st
(braket
l_int|0
)braket
op_amp
l_int|0x40
)paren
(brace
multiline_comment|/* get data length */
id|insw
c_func
(paren
id|ioaddr
comma
id|buffer
comma
id|NewDatagramHeaderSize
op_div
l_int|2
)paren
suffix:semicolon
macro_line|#ifdef XXXDEBUG
id|printk
c_func
(paren
l_string|&quot;cm0: IP identification: %02x%02x  fragment offset: %02x%02x&bslash;n&quot;
comma
id|buffer
(braket
l_int|30
)braket
comma
id|buffer
(braket
l_int|31
)braket
comma
id|buffer
(braket
l_int|32
)braket
comma
id|buffer
(braket
l_int|33
)braket
)paren
suffix:semicolon
macro_line|#endif /* XXXDEBUG */
r_if
c_cond
(paren
id|buffer
(braket
l_int|0
)braket
op_ne
id|NewDatagramHeaderSkip
)paren
(brace
r_if
c_cond
(paren
id|sb1000_debug
OG
l_int|1
)paren
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: new datagram header skip error: &quot;
l_string|&quot;got %02x expecting %02x&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|buffer
(braket
l_int|0
)braket
comma
id|NewDatagramHeaderSkip
)paren
suffix:semicolon
id|stats-&gt;rx_length_errors
op_increment
suffix:semicolon
id|insw
c_func
(paren
id|ioaddr
comma
id|buffer
comma
id|NewDatagramDataSize
op_div
l_int|2
)paren
suffix:semicolon
r_goto
id|bad_frame_next
suffix:semicolon
)brace
id|dlen
op_assign
(paren
(paren
id|buffer
(braket
id|NewDatagramHeaderSkip
op_plus
l_int|3
)braket
op_amp
l_int|0x0f
)paren
op_lshift
l_int|8
op_or
id|buffer
(braket
id|NewDatagramHeaderSkip
op_plus
l_int|4
)braket
)paren
op_minus
l_int|17
suffix:semicolon
r_if
c_cond
(paren
id|dlen
OG
id|SB1000_MRU
)paren
(brace
r_if
c_cond
(paren
id|sb1000_debug
OG
l_int|1
)paren
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: datagram length (%d) greater &quot;
l_string|&quot;than MRU (%d)&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|dlen
comma
id|SB1000_MRU
)paren
suffix:semicolon
id|stats-&gt;rx_length_errors
op_increment
suffix:semicolon
id|insw
c_func
(paren
id|ioaddr
comma
id|buffer
comma
id|NewDatagramDataSize
op_div
l_int|2
)paren
suffix:semicolon
r_goto
id|bad_frame_next
suffix:semicolon
)brace
id|lp-&gt;rx_dlen
(braket
id|ns
)braket
op_assign
id|dlen
suffix:semicolon
multiline_comment|/* compute size to allocate for datagram */
id|skbsize
op_assign
id|dlen
op_plus
id|FrameSize
suffix:semicolon
r_if
c_cond
(paren
(paren
id|skb
op_assign
id|alloc_skb
c_func
(paren
id|skbsize
comma
id|GFP_ATOMIC
)paren
)paren
op_eq
l_int|NULL
)paren
(brace
r_if
c_cond
(paren
id|sb1000_debug
OG
l_int|1
)paren
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: can&squot;t allocate %d bytes long &quot;
l_string|&quot;skbuff&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|skbsize
)paren
suffix:semicolon
id|stats-&gt;rx_dropped
op_increment
suffix:semicolon
id|insw
c_func
(paren
id|ioaddr
comma
id|buffer
comma
id|NewDatagramDataSize
op_div
l_int|2
)paren
suffix:semicolon
r_goto
id|dropped_frame
suffix:semicolon
)brace
id|skb-&gt;dev
op_assign
id|dev
suffix:semicolon
id|skb-&gt;mac.raw
op_assign
id|skb-&gt;data
suffix:semicolon
id|skb-&gt;protocol
op_assign
(paren
r_int
r_int
)paren
id|buffer
(braket
id|NewDatagramHeaderSkip
op_plus
l_int|16
)braket
suffix:semicolon
id|insw
c_func
(paren
id|ioaddr
comma
id|skb_put
c_func
(paren
id|skb
comma
id|NewDatagramDataSize
)paren
comma
id|NewDatagramDataSize
op_div
l_int|2
)paren
suffix:semicolon
id|lp-&gt;rx_skb
(braket
id|ns
)braket
op_assign
id|skb
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* continuation of previous datagram */
id|insw
c_func
(paren
id|ioaddr
comma
id|buffer
comma
id|ContDatagramHeaderSize
op_div
l_int|2
)paren
suffix:semicolon
r_if
c_cond
(paren
id|buffer
(braket
l_int|0
)braket
op_ne
id|ContDatagramHeaderSkip
)paren
(brace
r_if
c_cond
(paren
id|sb1000_debug
OG
l_int|1
)paren
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: cont datagram header skip error: &quot;
l_string|&quot;got %02x expecting %02x&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|buffer
(braket
l_int|0
)braket
comma
id|ContDatagramHeaderSkip
)paren
suffix:semicolon
id|stats-&gt;rx_length_errors
op_increment
suffix:semicolon
id|insw
c_func
(paren
id|ioaddr
comma
id|buffer
comma
id|ContDatagramDataSize
op_div
l_int|2
)paren
suffix:semicolon
r_goto
id|bad_frame_next
suffix:semicolon
)brace
id|skb
op_assign
id|lp-&gt;rx_skb
(braket
id|ns
)braket
suffix:semicolon
id|insw
c_func
(paren
id|ioaddr
comma
id|skb_put
c_func
(paren
id|skb
comma
id|ContDatagramDataSize
)paren
comma
id|ContDatagramDataSize
op_div
l_int|2
)paren
suffix:semicolon
id|dlen
op_assign
id|lp-&gt;rx_dlen
(braket
id|ns
)braket
suffix:semicolon
)brace
r_if
c_cond
(paren
id|skb-&gt;len
OL
id|dlen
op_plus
id|TrailerSize
)paren
(brace
id|lp-&gt;rx_session_id
(braket
id|ns
)braket
op_and_assign
op_complement
l_int|0x40
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* datagram completed: send to upper level */
id|skb_trim
c_func
(paren
id|skb
comma
id|dlen
)paren
suffix:semicolon
id|netif_rx
c_func
(paren
id|skb
)paren
suffix:semicolon
id|stats-&gt;rx_bytes
op_add_assign
id|dlen
suffix:semicolon
id|stats-&gt;rx_packets
op_increment
suffix:semicolon
id|lp-&gt;rx_bytes
op_add_assign
id|dlen
suffix:semicolon
id|lp-&gt;rx_skb
(braket
id|ns
)braket
op_assign
l_int|0
suffix:semicolon
id|lp-&gt;rx_session_id
(braket
id|ns
)braket
op_or_assign
l_int|0x40
suffix:semicolon
r_return
l_int|0
suffix:semicolon
id|bad_frame
suffix:colon
id|insw
c_func
(paren
id|ioaddr
comma
id|buffer
comma
id|FrameSize
op_div
l_int|2
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sb1000_debug
OG
l_int|1
)paren
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: frame error: got %02x %02x&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|st
(braket
l_int|0
)braket
comma
id|st
(braket
l_int|1
)braket
)paren
suffix:semicolon
id|stats-&gt;rx_frame_errors
op_increment
suffix:semicolon
id|bad_frame_next
suffix:colon
r_if
c_cond
(paren
id|sb1000_debug
OG
l_int|2
)paren
id|sb1000_print_status_buffer
c_func
(paren
id|dev-&gt;name
comma
id|st
comma
id|buffer
comma
id|FrameSize
)paren
suffix:semicolon
id|dropped_frame
suffix:colon
id|stats-&gt;rx_errors
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|ns
OL
id|NPIDS
)paren
(brace
r_if
c_cond
(paren
(paren
id|skb
op_assign
id|lp-&gt;rx_skb
(braket
id|ns
)braket
)paren
)paren
(brace
id|dev_kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
id|lp-&gt;rx_skb
(braket
id|ns
)braket
op_assign
l_int|0
suffix:semicolon
)brace
id|lp-&gt;rx_session_id
(braket
id|ns
)braket
op_or_assign
l_int|0x40
suffix:semicolon
)brace
r_return
op_minus
l_int|1
suffix:semicolon
)brace
r_static
r_inline
r_void
DECL|function|sb1000_error_dpc
id|sb1000_error_dpc
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_char
op_star
id|name
suffix:semicolon
r_int
r_char
id|st
(braket
l_int|5
)braket
suffix:semicolon
r_int
id|ioaddr
(braket
l_int|2
)braket
suffix:semicolon
r_struct
id|sb1000_private
op_star
id|lp
op_assign
(paren
r_struct
id|sb1000_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_const
r_int
r_char
id|Command0
(braket
l_int|6
)braket
op_assign
(brace
l_int|0x80
comma
l_int|0x26
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
)brace
suffix:semicolon
r_const
r_int
id|ErrorDpcCounterInitialize
op_assign
l_int|200
suffix:semicolon
id|ioaddr
(braket
l_int|0
)braket
op_assign
id|dev-&gt;base_addr
suffix:semicolon
multiline_comment|/* rmem_end holds the second I/O address - fv */
id|ioaddr
(braket
l_int|1
)braket
op_assign
id|dev-&gt;rmem_end
suffix:semicolon
id|name
op_assign
id|dev-&gt;name
suffix:semicolon
id|sb1000_wait_for_ready_clear
c_func
(paren
id|ioaddr
comma
id|name
)paren
suffix:semicolon
id|sb1000_send_command
c_func
(paren
id|ioaddr
comma
id|name
comma
id|Command0
)paren
suffix:semicolon
id|sb1000_wait_for_ready
c_func
(paren
id|ioaddr
comma
id|name
)paren
suffix:semicolon
id|sb1000_read_status
c_func
(paren
id|ioaddr
comma
id|st
)paren
suffix:semicolon
r_if
c_cond
(paren
id|st
(braket
l_int|1
)braket
op_amp
l_int|0x10
)paren
id|lp-&gt;rx_error_dpc_count
op_assign
id|ErrorDpcCounterInitialize
suffix:semicolon
r_return
suffix:semicolon
)brace
"&f;"
multiline_comment|/*&n; * Linux interface functions&n; */
r_static
r_int
DECL|function|sb1000_open
id|sb1000_open
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_char
op_star
id|name
suffix:semicolon
r_int
id|ioaddr
(braket
l_int|2
)braket
comma
id|status
suffix:semicolon
r_struct
id|sb1000_private
op_star
id|lp
op_assign
(paren
r_struct
id|sb1000_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_const
r_int
r_int
id|FirmwareVersion
(braket
)braket
op_assign
(brace
l_int|0x01
comma
l_int|0x01
)brace
suffix:semicolon
id|ioaddr
(braket
l_int|0
)braket
op_assign
id|dev-&gt;base_addr
suffix:semicolon
multiline_comment|/* rmem_end holds the second I/O address - fv */
id|ioaddr
(braket
l_int|1
)braket
op_assign
id|dev-&gt;rmem_end
suffix:semicolon
id|name
op_assign
id|dev-&gt;name
suffix:semicolon
id|request_region
c_func
(paren
id|ioaddr
(braket
l_int|0
)braket
comma
id|SB1000_IO_EXTENT
comma
l_string|&quot;sb1000&quot;
)paren
suffix:semicolon
id|request_region
c_func
(paren
id|ioaddr
(braket
l_int|1
)braket
comma
id|SB1000_IO_EXTENT
comma
l_string|&quot;sb1000&quot;
)paren
suffix:semicolon
multiline_comment|/* initialize sb1000 */
r_if
c_cond
(paren
(paren
id|status
op_assign
id|sb1000_reset
c_func
(paren
id|ioaddr
comma
id|name
)paren
)paren
)paren
r_return
id|status
suffix:semicolon
id|nicedelay
c_func
(paren
l_int|200000
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|status
op_assign
id|sb1000_check_CRC
c_func
(paren
id|ioaddr
comma
id|name
)paren
)paren
)paren
r_return
id|status
suffix:semicolon
multiline_comment|/* initialize private data before board can catch interrupts */
id|lp-&gt;rx_skb
(braket
l_int|0
)braket
op_assign
l_int|NULL
suffix:semicolon
id|lp-&gt;rx_skb
(braket
l_int|1
)braket
op_assign
l_int|NULL
suffix:semicolon
id|lp-&gt;rx_skb
(braket
l_int|2
)braket
op_assign
l_int|NULL
suffix:semicolon
id|lp-&gt;rx_skb
(braket
l_int|3
)braket
op_assign
l_int|NULL
suffix:semicolon
id|lp-&gt;rx_dlen
(braket
l_int|0
)braket
op_assign
l_int|0
suffix:semicolon
id|lp-&gt;rx_dlen
(braket
l_int|1
)braket
op_assign
l_int|0
suffix:semicolon
id|lp-&gt;rx_dlen
(braket
l_int|2
)braket
op_assign
l_int|0
suffix:semicolon
id|lp-&gt;rx_dlen
(braket
l_int|3
)braket
op_assign
l_int|0
suffix:semicolon
id|lp-&gt;rx_bytes
op_assign
l_int|0
suffix:semicolon
id|lp-&gt;rx_frames
op_assign
l_int|0
suffix:semicolon
id|lp-&gt;rx_error_count
op_assign
l_int|0
suffix:semicolon
id|lp-&gt;rx_error_dpc_count
op_assign
l_int|0
suffix:semicolon
id|lp-&gt;rx_session_id
(braket
l_int|0
)braket
op_assign
l_int|0x50
suffix:semicolon
id|lp-&gt;rx_session_id
(braket
l_int|0
)braket
op_assign
l_int|0x48
suffix:semicolon
id|lp-&gt;rx_session_id
(braket
l_int|0
)braket
op_assign
l_int|0x44
suffix:semicolon
id|lp-&gt;rx_session_id
(braket
l_int|0
)braket
op_assign
l_int|0x42
suffix:semicolon
id|lp-&gt;rx_frame_id
(braket
l_int|0
)braket
op_assign
l_int|0
suffix:semicolon
id|lp-&gt;rx_frame_id
(braket
l_int|1
)braket
op_assign
l_int|0
suffix:semicolon
id|lp-&gt;rx_frame_id
(braket
l_int|2
)braket
op_assign
l_int|0
suffix:semicolon
id|lp-&gt;rx_frame_id
(braket
l_int|3
)braket
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|request_irq
c_func
(paren
id|dev-&gt;irq
comma
op_amp
id|sb1000_interrupt
comma
l_int|0
comma
l_string|&quot;sb1000&quot;
comma
id|dev
)paren
)paren
(brace
r_return
op_minus
id|EAGAIN
suffix:semicolon
)brace
r_if
c_cond
(paren
id|sb1000_debug
OG
l_int|2
)paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%s: Opening, IRQ %d&bslash;n&quot;
comma
id|name
comma
id|dev-&gt;irq
)paren
suffix:semicolon
multiline_comment|/* Activate board and check firmware version */
id|udelay
c_func
(paren
l_int|1000
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|status
op_assign
id|sb1000_activate
c_func
(paren
id|ioaddr
comma
id|name
)paren
)paren
)paren
r_return
id|status
suffix:semicolon
id|udelay
c_func
(paren
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|status
op_assign
id|sb1000_get_firmware_version
c_func
(paren
id|ioaddr
comma
id|name
comma
id|version
comma
l_int|0
)paren
)paren
)paren
r_return
id|status
suffix:semicolon
r_if
c_cond
(paren
id|version
(braket
l_int|0
)braket
op_ne
id|FirmwareVersion
(braket
l_int|0
)braket
op_logical_or
id|version
(braket
l_int|1
)braket
op_ne
id|FirmwareVersion
(braket
l_int|1
)braket
)paren
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: found firmware version %x.%02x &quot;
l_string|&quot;(should be %x.%02x)&bslash;n&quot;
comma
id|name
comma
id|version
(braket
l_int|0
)braket
comma
id|version
(braket
l_int|1
)braket
comma
id|FirmwareVersion
(braket
l_int|0
)braket
comma
id|FirmwareVersion
(braket
l_int|1
)braket
)paren
suffix:semicolon
id|netif_start_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
multiline_comment|/* Always succeed */
)brace
DECL|function|sb1000_dev_ioctl
r_static
r_int
id|sb1000_dev_ioctl
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_struct
id|ifreq
op_star
id|ifr
comma
r_int
id|cmd
)paren
(brace
r_char
op_star
id|name
suffix:semicolon
r_int
r_char
id|version
(braket
l_int|2
)braket
suffix:semicolon
r_int
id|PID
(braket
l_int|4
)braket
suffix:semicolon
r_int
id|ioaddr
(braket
l_int|2
)braket
comma
id|status
comma
id|frequency
suffix:semicolon
r_int
r_int
id|stats
(braket
l_int|5
)braket
suffix:semicolon
r_struct
id|sb1000_private
op_star
id|lp
op_assign
(paren
r_struct
id|sb1000_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|dev
op_logical_and
id|dev-&gt;flags
op_amp
id|IFF_UP
)paren
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
id|ioaddr
(braket
l_int|0
)braket
op_assign
id|dev-&gt;base_addr
suffix:semicolon
multiline_comment|/* rmem_end holds the second I/O address - fv */
id|ioaddr
(braket
l_int|1
)braket
op_assign
id|dev-&gt;rmem_end
suffix:semicolon
id|name
op_assign
id|dev-&gt;name
suffix:semicolon
r_switch
c_cond
(paren
id|cmd
)paren
(brace
r_case
id|SIOCGCMSTATS
suffix:colon
multiline_comment|/* get statistics */
id|stats
(braket
l_int|0
)braket
op_assign
id|lp-&gt;rx_bytes
suffix:semicolon
id|stats
(braket
l_int|1
)braket
op_assign
id|lp-&gt;rx_frames
suffix:semicolon
id|stats
(braket
l_int|2
)braket
op_assign
id|lp-&gt;stats.rx_packets
suffix:semicolon
id|stats
(braket
l_int|3
)braket
op_assign
id|lp-&gt;stats.rx_errors
suffix:semicolon
id|stats
(braket
l_int|4
)braket
op_assign
id|lp-&gt;stats.rx_dropped
suffix:semicolon
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
id|ifr-&gt;ifr_data
comma
id|stats
comma
r_sizeof
(paren
id|stats
)paren
)paren
)paren
(brace
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
id|status
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SIOCGCMFIRMWARE
suffix:colon
multiline_comment|/* get firmware version */
r_if
c_cond
(paren
(paren
id|status
op_assign
id|sb1000_get_firmware_version
c_func
(paren
id|ioaddr
comma
id|name
comma
id|version
comma
l_int|1
)paren
)paren
)paren
r_return
id|status
suffix:semicolon
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
id|ifr-&gt;ifr_data
comma
id|version
comma
r_sizeof
(paren
id|version
)paren
)paren
)paren
(brace
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|SIOCGCMFREQUENCY
suffix:colon
multiline_comment|/* get frequency */
r_if
c_cond
(paren
(paren
id|status
op_assign
id|sb1000_get_frequency
c_func
(paren
id|ioaddr
comma
id|name
comma
op_amp
id|frequency
)paren
)paren
)paren
r_return
id|status
suffix:semicolon
r_if
c_cond
(paren
id|put_user
c_func
(paren
id|frequency
comma
(paren
r_int
op_star
)paren
id|ifr-&gt;ifr_data
)paren
)paren
(brace
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|SIOCSCMFREQUENCY
suffix:colon
multiline_comment|/* set frequency */
r_if
c_cond
(paren
op_logical_neg
id|capable
c_func
(paren
id|CAP_NET_ADMIN
)paren
)paren
r_return
op_minus
id|EPERM
suffix:semicolon
r_if
c_cond
(paren
id|get_user
c_func
(paren
id|frequency
comma
(paren
r_int
op_star
)paren
id|ifr-&gt;ifr_data
)paren
)paren
(brace
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|status
op_assign
id|sb1000_set_frequency
c_func
(paren
id|ioaddr
comma
id|name
comma
id|frequency
)paren
)paren
)paren
r_return
id|status
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SIOCGCMPIDS
suffix:colon
multiline_comment|/* get PIDs */
r_if
c_cond
(paren
(paren
id|status
op_assign
id|sb1000_get_PIDs
c_func
(paren
id|ioaddr
comma
id|name
comma
id|PID
)paren
)paren
)paren
r_return
id|status
suffix:semicolon
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
id|ifr-&gt;ifr_data
comma
id|PID
comma
r_sizeof
(paren
id|PID
)paren
)paren
)paren
(brace
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|SIOCSCMPIDS
suffix:colon
multiline_comment|/* set PIDs */
r_if
c_cond
(paren
op_logical_neg
id|capable
c_func
(paren
id|CAP_NET_ADMIN
)paren
)paren
r_return
op_minus
id|EPERM
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
id|PID
comma
id|ifr-&gt;ifr_data
comma
r_sizeof
(paren
id|PID
)paren
)paren
)paren
(brace
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|status
op_assign
id|sb1000_set_PIDs
c_func
(paren
id|ioaddr
comma
id|name
comma
id|PID
)paren
)paren
)paren
r_return
id|status
suffix:semicolon
multiline_comment|/* set session_id, frame_id and pkt_type too */
id|lp-&gt;rx_session_id
(braket
l_int|0
)braket
op_assign
l_int|0x50
op_or
(paren
id|PID
(braket
l_int|0
)braket
op_amp
l_int|0x0f
)paren
suffix:semicolon
id|lp-&gt;rx_session_id
(braket
l_int|1
)braket
op_assign
l_int|0x48
suffix:semicolon
id|lp-&gt;rx_session_id
(braket
l_int|2
)braket
op_assign
l_int|0x44
suffix:semicolon
id|lp-&gt;rx_session_id
(braket
l_int|3
)braket
op_assign
l_int|0x42
suffix:semicolon
id|lp-&gt;rx_frame_id
(braket
l_int|0
)braket
op_assign
l_int|0
suffix:semicolon
id|lp-&gt;rx_frame_id
(braket
l_int|1
)braket
op_assign
l_int|0
suffix:semicolon
id|lp-&gt;rx_frame_id
(braket
l_int|2
)braket
op_assign
l_int|0
suffix:semicolon
id|lp-&gt;rx_frame_id
(braket
l_int|3
)braket
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|status
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_break
suffix:semicolon
)brace
r_return
id|status
suffix:semicolon
)brace
multiline_comment|/* transmit function: do nothing since SB1000 can&squot;t send anything out */
r_static
r_int
DECL|function|sb1000_start_xmit
id|sb1000_start_xmit
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|net_device
op_star
id|dev
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: trying to transmit!!!&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
multiline_comment|/* sb1000 can&squot;t xmit datagrams */
id|dev_kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* SB1000 interrupt handler. */
DECL|function|sb1000_interrupt
r_static
r_void
id|sb1000_interrupt
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_char
op_star
id|name
suffix:semicolon
r_int
r_char
id|st
suffix:semicolon
r_int
id|ioaddr
(braket
l_int|2
)braket
suffix:semicolon
r_struct
id|net_device
op_star
id|dev
op_assign
(paren
r_struct
id|net_device
op_star
)paren
id|dev_id
suffix:semicolon
r_struct
id|sb1000_private
op_star
id|lp
op_assign
(paren
r_struct
id|sb1000_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_const
r_int
r_char
id|Command0
(braket
l_int|6
)braket
op_assign
(brace
l_int|0x80
comma
l_int|0x2c
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
)brace
suffix:semicolon
r_const
r_int
r_char
id|Command1
(braket
l_int|6
)braket
op_assign
(brace
l_int|0x80
comma
l_int|0x2e
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
)brace
suffix:semicolon
r_const
r_int
id|MaxRxErrorCount
op_assign
l_int|6
suffix:semicolon
r_if
c_cond
(paren
id|dev
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;sb1000_interrupt(): irq %d for unknown device.&bslash;n&quot;
comma
id|irq
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|ioaddr
(braket
l_int|0
)braket
op_assign
id|dev-&gt;base_addr
suffix:semicolon
multiline_comment|/* rmem_end holds the second I/O address - fv */
id|ioaddr
(braket
l_int|1
)braket
op_assign
id|dev-&gt;rmem_end
suffix:semicolon
id|name
op_assign
id|dev-&gt;name
suffix:semicolon
multiline_comment|/* is it a good interrupt? */
id|st
op_assign
id|inb
c_func
(paren
id|ioaddr
(braket
l_int|1
)braket
op_plus
l_int|6
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|st
op_amp
l_int|0x08
op_logical_and
id|st
op_amp
l_int|0x20
)paren
)paren
(brace
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|sb1000_debug
OG
l_int|3
)paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%s: entering interrupt&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|st
op_assign
id|inb
c_func
(paren
id|ioaddr
(braket
l_int|0
)braket
op_plus
l_int|7
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sb1000_rx
c_func
(paren
id|dev
)paren
)paren
id|lp-&gt;rx_error_count
op_increment
suffix:semicolon
macro_line|#ifdef SB1000_DELAY
id|udelay
c_func
(paren
id|SB1000_DELAY
)paren
suffix:semicolon
macro_line|#endif /* SB1000_DELAY */
id|sb1000_issue_read_command
c_func
(paren
id|ioaddr
comma
id|name
)paren
suffix:semicolon
r_if
c_cond
(paren
id|st
op_amp
l_int|0x01
)paren
(brace
id|sb1000_error_dpc
c_func
(paren
id|dev
)paren
suffix:semicolon
id|sb1000_issue_read_command
c_func
(paren
id|ioaddr
comma
id|name
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|lp-&gt;rx_error_dpc_count
op_logical_and
op_logical_neg
(paren
op_decrement
id|lp-&gt;rx_error_dpc_count
)paren
)paren
(brace
id|sb1000_wait_for_ready_clear
c_func
(paren
id|ioaddr
comma
id|name
)paren
suffix:semicolon
id|sb1000_send_command
c_func
(paren
id|ioaddr
comma
id|name
comma
id|Command0
)paren
suffix:semicolon
id|sb1000_wait_for_ready
c_func
(paren
id|ioaddr
comma
id|name
)paren
suffix:semicolon
id|sb1000_issue_read_command
c_func
(paren
id|ioaddr
comma
id|name
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|lp-&gt;rx_error_count
op_ge
id|MaxRxErrorCount
)paren
(brace
id|sb1000_wait_for_ready_clear
c_func
(paren
id|ioaddr
comma
id|name
)paren
suffix:semicolon
id|sb1000_send_command
c_func
(paren
id|ioaddr
comma
id|name
comma
id|Command1
)paren
suffix:semicolon
id|sb1000_wait_for_ready
c_func
(paren
id|ioaddr
comma
id|name
)paren
suffix:semicolon
id|sb1000_issue_read_command
c_func
(paren
id|ioaddr
comma
id|name
)paren
suffix:semicolon
id|lp-&gt;rx_error_count
op_assign
l_int|0
suffix:semicolon
)brace
r_return
suffix:semicolon
)brace
DECL|function|sb1000_stats
r_static
r_struct
id|net_device_stats
op_star
id|sb1000_stats
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|sb1000_private
op_star
id|lp
op_assign
(paren
r_struct
id|sb1000_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_return
op_amp
id|lp-&gt;stats
suffix:semicolon
)brace
DECL|function|sb1000_close
r_static
r_int
id|sb1000_close
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_int
id|i
suffix:semicolon
r_int
id|ioaddr
(braket
l_int|2
)braket
suffix:semicolon
r_struct
id|sb1000_private
op_star
id|lp
op_assign
(paren
r_struct
id|sb1000_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_if
c_cond
(paren
id|sb1000_debug
OG
l_int|2
)paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%s: Shutting down sb1000.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|netif_stop_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
id|ioaddr
(braket
l_int|0
)braket
op_assign
id|dev-&gt;base_addr
suffix:semicolon
multiline_comment|/* rmem_end holds the second I/O address - fv */
id|ioaddr
(braket
l_int|1
)braket
op_assign
id|dev-&gt;rmem_end
suffix:semicolon
id|free_irq
c_func
(paren
id|dev-&gt;irq
comma
id|dev
)paren
suffix:semicolon
multiline_comment|/* If we don&squot;t do this, we can&squot;t re-insmod it later. */
id|release_region
c_func
(paren
id|ioaddr
(braket
l_int|1
)braket
comma
id|SB1000_IO_EXTENT
)paren
suffix:semicolon
id|release_region
c_func
(paren
id|ioaddr
(braket
l_int|0
)braket
comma
id|SB1000_IO_EXTENT
)paren
suffix:semicolon
multiline_comment|/* free rx_skb&squot;s if needed */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|4
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|lp-&gt;rx_skb
(braket
id|i
)braket
)paren
(brace
id|dev_kfree_skb
c_func
(paren
id|lp-&gt;rx_skb
(braket
id|i
)braket
)paren
suffix:semicolon
)brace
)brace
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#ifdef MODULE
id|MODULE_AUTHOR
c_func
(paren
l_string|&quot;Franco Venturi &lt;fventuri@mediaone.net&gt;&quot;
)paren
suffix:semicolon
id|MODULE_DESCRIPTION
c_func
(paren
l_string|&quot;General Instruments SB1000 driver&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|io
comma
l_string|&quot;1-2i&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|irq
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
DECL|variable|dev_sb1000
r_static
r_struct
id|net_device
id|dev_sb1000
suffix:semicolon
DECL|variable|io
r_static
r_int
id|io
(braket
l_int|2
)braket
suffix:semicolon
DECL|variable|irq
r_static
r_int
id|irq
suffix:semicolon
r_int
DECL|function|init_module
id|init_module
c_func
(paren
r_void
)paren
(brace
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|100
suffix:semicolon
id|i
op_increment
)paren
(brace
id|sprintf
c_func
(paren
id|dev_sb1000.name
comma
l_string|&quot;cm%d&quot;
comma
id|i
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dev_get
c_func
(paren
id|dev_sb1000.name
)paren
op_eq
l_int|0
)paren
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|i
op_eq
l_int|100
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;sb1000: can&squot;t register any device cm&lt;n&gt;&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENFILE
suffix:semicolon
)brace
id|dev_sb1000.init
op_assign
id|sb1000_probe
suffix:semicolon
id|dev_sb1000.base_addr
op_assign
id|io
(braket
l_int|0
)braket
suffix:semicolon
multiline_comment|/* rmem_end holds the second I/O address - fv */
id|dev_sb1000.rmem_end
op_assign
id|io
(braket
l_int|1
)braket
suffix:semicolon
id|dev_sb1000.irq
op_assign
id|irq
suffix:semicolon
r_if
c_cond
(paren
id|register_netdev
c_func
(paren
op_amp
id|dev_sb1000
)paren
op_ne
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;sb1000: failed to register device (io: %03x,%03x   &quot;
l_string|&quot;irq: %d)&bslash;n&quot;
comma
id|io
(braket
l_int|0
)braket
comma
id|io
(braket
l_int|1
)braket
comma
id|irq
)paren
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|cleanup_module
r_void
id|cleanup_module
c_func
(paren
r_void
)paren
(brace
id|unregister_netdev
c_func
(paren
op_amp
id|dev_sb1000
)paren
suffix:semicolon
id|release_region
c_func
(paren
id|dev_sb1000.base_addr
comma
l_int|16
)paren
suffix:semicolon
id|release_region
c_func
(paren
id|dev_sb1000.rmem_end
comma
l_int|16
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|dev_sb1000.priv
)paren
suffix:semicolon
id|dev_sb1000.priv
op_assign
l_int|NULL
suffix:semicolon
)brace
macro_line|#endif /* MODULE */
"&f;"
multiline_comment|/*&n; * Local variables:&n; *  compile-command: &quot;gcc -D__KERNEL__ -DMODULE -Wall -Wstrict-prototypes -O -m486 -c sb1000.c&quot;&n; *  version-control: t&n; *  tab-width: 4&n; *  c-basic-offset: 4&n; * End:&n; */
eof
