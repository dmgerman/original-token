multiline_comment|/*&t;$Id: com20020.c,v 1.6 1997/11/09 11:04:58 mj Exp $&n;&n;        Written 1997 by David Woodhouse &lt;dwmw2@cam.ac.uk&gt;&n;&n;&t;Derived from the original arcnet.c,&n;&t;Written 1994-1996 by Avery Pennarun,&n;&t;which was in turn derived from skeleton.c by Donald Becker.&n;&n;&t;Contact Avery at: apenwarr@bond.net or&n;&t;RR #5 Pole Line Road, Thunder Bay, ON, Canada P7C 5M9&n;&n;&t;**********************&n;&n;&t;The original copyright of skeleton.c was as follows:&n;&n;&t;skeleton.c Written 1993 by Donald Becker.&n;&t;Copyright 1993 United States Government as represented by the&n;        Director, National Security Agency.  This software may only be used&n;        and distributed according to the terms of the GNU Public License as&n;        modified by SRC, incorporated herein by reference.&n;&n;&t;**********************&n;&n;&t;For more details, see drivers/net/arcnet.c&n;&n;&t;**********************&n;*/
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/version.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/fcntl.h&gt;
macro_line|#include &lt;linux/interrupt.h&gt;
macro_line|#include &lt;linux/ptrace.h&gt;
macro_line|#include &lt;linux/ioport.h&gt;
macro_line|#include &lt;linux/in.h&gt;
macro_line|#include &lt;linux/malloc.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/timer.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;linux/netdevice.h&gt;
macro_line|#include &lt;linux/if_arp.h&gt;
macro_line|#include &lt;linux/etherdevice.h&gt;
macro_line|#include &lt;linux/skbuff.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/if_arcnet.h&gt;
macro_line|#include &lt;linux/arcdevice.h&gt;
macro_line|#include &lt;asm/system.h&gt;
macro_line|#include &lt;asm/bitops.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/dma.h&gt;
macro_line|#include &lt;net/arp.h&gt;
multiline_comment|/* Internal function declarations */
r_static
r_int
id|arc20020_probe
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_void
id|arc20020_rx
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
r_int
id|recbuf
)paren
suffix:semicolon
r_static
r_int
id|arc20020_found
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
r_int
id|ioaddr
comma
r_int
id|airq
)paren
suffix:semicolon
r_static
r_void
id|arc20020_inthandler
(paren
r_struct
id|device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_int
id|arc20020_reset
(paren
r_struct
id|device
op_star
id|dev
comma
r_int
id|reset_delay
)paren
suffix:semicolon
r_static
r_void
id|arc20020_setmask
(paren
r_struct
id|device
op_star
id|dev
comma
id|u_char
id|mask
)paren
suffix:semicolon
r_static
r_void
id|arc20020_command
(paren
r_struct
id|device
op_star
id|dev
comma
id|u_char
id|command
)paren
suffix:semicolon
r_static
id|u_char
id|arc20020_status
(paren
r_struct
id|device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_void
id|arc20020_en_dis_able_TX
(paren
r_struct
id|device
op_star
id|dev
comma
r_int
id|enable
)paren
suffix:semicolon
r_static
r_void
id|arc20020_prepare_tx
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
id|u_char
op_star
id|hdr
comma
r_int
id|hdrlen
comma
r_char
op_star
id|data
comma
r_int
id|length
comma
r_int
id|daddr
comma
r_int
id|exceptA
comma
r_int
id|offset
)paren
suffix:semicolon
r_static
r_void
id|arc20020_openclose
c_func
(paren
r_int
id|open
)paren
suffix:semicolon
r_static
r_void
id|arc20020_set_mc_list
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
suffix:semicolon
r_static
id|u_char
id|get_buffer_byte
(paren
r_struct
id|device
op_star
id|dev
comma
r_int
id|offset
)paren
suffix:semicolon
r_static
r_void
id|put_buffer_byte
(paren
r_struct
id|device
op_star
id|dev
comma
r_int
id|offset
comma
id|u_char
id|datum
)paren
suffix:semicolon
r_static
r_void
id|get_whole_buffer
(paren
r_struct
id|device
op_star
id|dev
comma
r_int
id|offset
comma
r_int
id|length
comma
r_char
op_star
id|dest
)paren
suffix:semicolon
r_static
r_void
id|put_whole_buffer
(paren
r_struct
id|device
op_star
id|dev
comma
r_int
id|offset
comma
r_int
id|length
comma
r_char
op_star
id|dest
)paren
suffix:semicolon
multiline_comment|/* Module parameters */
macro_line|#ifdef MODULE
DECL|variable|node
r_static
r_int
id|node
op_assign
l_int|0
suffix:semicolon
DECL|variable|io
r_static
r_int
id|io
op_assign
l_int|0x0
suffix:semicolon
multiline_comment|/* &lt;--- EDIT THESE LINES FOR YOUR CONFIGURATION */
DECL|variable|irq
r_static
r_int
id|irq
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* or use the insmod io= irq= shmem= options */
DECL|variable|device
r_static
r_char
op_star
id|device
suffix:semicolon
multiline_comment|/* use eg. device=&quot;arc1&quot; to change name */
DECL|variable|timeout
r_static
r_int
id|timeout
op_assign
l_int|3
suffix:semicolon
DECL|variable|backplane
r_static
r_int
id|backplane
op_assign
l_int|0
suffix:semicolon
DECL|variable|clock
r_static
r_int
id|clock
op_assign
l_int|0
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|node
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|io
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|irq
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|device
comma
l_string|&quot;s&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|timeout
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|backplane
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|clock
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
macro_line|#else
id|__initfunc
c_func
(paren
r_void
id|com20020_setup
(paren
r_char
op_star
id|str
comma
r_int
op_star
id|ints
)paren
)paren
suffix:semicolon
r_extern
r_struct
id|device
id|arcnet_devs
(braket
)braket
suffix:semicolon
r_extern
r_char
id|arcnet_dev_names
(braket
)braket
(braket
l_int|10
)braket
suffix:semicolon
r_extern
r_int
id|arcnet_num_devs
suffix:semicolon
macro_line|#endif
multiline_comment|/* Handy defines for ARCnet specific stuff */
DECL|variable|clockrates
r_static
r_char
op_star
id|clockrates
(braket
)braket
op_assign
initialization_block
suffix:semicolon
multiline_comment|/* The number of low I/O ports used by the card. */
DECL|macro|ARCNET_TOTAL_SIZE
mdefine_line|#define ARCNET_TOTAL_SIZE 9
DECL|macro|_INTMASK
mdefine_line|#define _INTMASK (ioaddr+0)&t;/* writable */
DECL|macro|_STATUS
mdefine_line|#define _STATUS  (ioaddr+0)&t;/* readable */
DECL|macro|_COMMAND
mdefine_line|#define _COMMAND (ioaddr+1)&t;/* writable, returns random vals on read (?) */
DECL|macro|_CONFIG
mdefine_line|#define _CONFIG  (ioaddr+6)      /* Configuration register */
DECL|macro|_DIAGSTAT
mdefine_line|#define _DIAGSTAT (ioaddr+1)     /* Diagnostic status register */
DECL|macro|_MEMDATA
mdefine_line|#define _MEMDATA  (ioaddr+4)     /* Data port for IO-mapped memory */
DECL|macro|_ADDR_HI
mdefine_line|#define _ADDR_HI  (ioaddr+2)     /* Control registers for said */
DECL|macro|_ADDR_LO
mdefine_line|#define _ADDR_LO  (ioaddr+3)
DECL|macro|RDDATAflag
mdefine_line|#define RDDATAflag      0x80     /* Next access is a read/~write */
DECL|macro|NEWNXTIDflag
mdefine_line|#define NEWNXTIDflag    0x02     /* ID to which token is passed has changed */
DECL|macro|TXENflag
mdefine_line|#define TXENflag        0x20     /* Enable TX (in CONFIG register) */
DECL|macro|PROMISCflag
mdefine_line|#define PROMISCflag     0x10     /* Enable RCV_ALL (in SETUP register) */
DECL|macro|REGTENTID
mdefine_line|#define REGTENTID (lp-&gt;config &amp;= ~3);
DECL|macro|REGNID
mdefine_line|#define REGNID (lp-&gt;config = (lp-&gt;config&amp;~2)|1);
DECL|macro|REGSETUP
mdefine_line|#define REGSETUP (lp-&gt;config = (lp-&gt;config&amp;~1)|2);
DECL|macro|REGNXTID
mdefine_line|#define REGNXTID (lp-&gt;config |= 3);
DECL|macro|ARCRESET
mdefine_line|#define ARCRESET { outb(lp-&gt;config | 0x80, _CONFIG); &bslash;&n;&t;&t;    udelay(5);                        &bslash;&n;&t;&t;    outb(lp-&gt;config , _CONFIG);       &bslash;&n;                  }
DECL|macro|ARCRESET0
mdefine_line|#define ARCRESET0 { outb(0x18 | 0x80, _CONFIG);   &bslash;&n;&t;&t;    udelay(5);                       &bslash;&n;&t;&t;    outb(0x18 , _CONFIG);            &bslash;&n;                  }
DECL|macro|ARCSTATUS
mdefine_line|#define ARCSTATUS&t;inb(_STATUS)
DECL|macro|ACOMMAND
mdefine_line|#define ACOMMAND(cmd) outb((cmd),_COMMAND)
DECL|macro|AINTMASK
mdefine_line|#define AINTMASK(msk)&t;outb((msk),_INTMASK)
DECL|macro|SETCONF
mdefine_line|#define SETCONF &t;outb((lp-&gt;config),_CONFIG)
multiline_comment|/****************************************************************************&n; *                                                                          *&n; * IO-mapped operation routines                                             *&n; *                                                                          *&n; ****************************************************************************/
DECL|function|get_buffer_byte
id|u_char
id|get_buffer_byte
(paren
r_struct
id|device
op_star
id|dev
comma
r_int
id|offset
)paren
(brace
r_int
id|ioaddr
op_assign
id|dev-&gt;base_addr
suffix:semicolon
id|outb
c_func
(paren
id|offset
op_rshift
l_int|8
op_or
id|RDDATAflag
comma
id|_ADDR_HI
)paren
suffix:semicolon
id|outb
c_func
(paren
id|offset
op_amp
l_int|0xff
comma
id|_ADDR_LO
)paren
suffix:semicolon
r_return
id|inb
c_func
(paren
id|_MEMDATA
)paren
suffix:semicolon
)brace
DECL|function|put_buffer_byte
r_void
id|put_buffer_byte
(paren
r_struct
id|device
op_star
id|dev
comma
r_int
id|offset
comma
id|u_char
id|datum
)paren
(brace
r_int
id|ioaddr
op_assign
id|dev-&gt;base_addr
suffix:semicolon
id|outb
c_func
(paren
id|offset
op_rshift
l_int|8
comma
id|_ADDR_HI
)paren
suffix:semicolon
id|outb
c_func
(paren
id|offset
op_amp
l_int|0xff
comma
id|_ADDR_LO
)paren
suffix:semicolon
id|outb
c_func
(paren
id|datum
comma
id|_MEMDATA
)paren
suffix:semicolon
)brace
DECL|macro|ONE_AT_A_TIME_TX
macro_line|#undef ONE_AT_A_TIME_TX
DECL|macro|ONE_AT_A_TIME_RX
macro_line|#undef ONE_AT_A_TIME_RX
DECL|function|get_whole_buffer
r_void
id|get_whole_buffer
(paren
r_struct
id|device
op_star
id|dev
comma
r_int
id|offset
comma
r_int
id|length
comma
r_char
op_star
id|dest
)paren
(brace
r_int
id|ioaddr
op_assign
id|dev-&gt;base_addr
suffix:semicolon
id|outb
c_func
(paren
(paren
id|offset
op_rshift
l_int|8
)paren
op_or
id|AUTOINCflag
op_or
id|RDDATAflag
comma
id|_ADDR_HI
)paren
suffix:semicolon
id|outb
c_func
(paren
id|offset
op_amp
l_int|0xff
comma
id|_ADDR_LO
)paren
suffix:semicolon
r_while
c_loop
(paren
id|length
op_decrement
)paren
macro_line|#ifdef ONE_AT_A_TIME_RX
op_star
(paren
id|dest
op_increment
)paren
op_assign
id|get_buffer_byte
c_func
(paren
id|dev
comma
id|offset
op_increment
)paren
suffix:semicolon
macro_line|#else
op_star
(paren
id|dest
op_increment
)paren
op_assign
id|inb
(paren
id|_MEMDATA
)paren
suffix:semicolon
macro_line|#endif
)brace
DECL|function|put_whole_buffer
r_void
id|put_whole_buffer
(paren
r_struct
id|device
op_star
id|dev
comma
r_int
id|offset
comma
r_int
id|length
comma
r_char
op_star
id|dest
)paren
(brace
r_int
id|ioaddr
op_assign
id|dev-&gt;base_addr
suffix:semicolon
id|outb
c_func
(paren
(paren
id|offset
op_rshift
l_int|8
)paren
op_or
id|AUTOINCflag
comma
id|_ADDR_HI
)paren
suffix:semicolon
id|outb
c_func
(paren
id|offset
op_amp
l_int|0xff
comma
id|_ADDR_LO
)paren
suffix:semicolon
r_while
c_loop
(paren
id|length
op_decrement
)paren
macro_line|#ifdef ONE_AT_A_TIME_TX
id|put_buffer_byte
c_func
(paren
id|dev
comma
id|offset
op_increment
comma
op_star
(paren
id|dest
op_increment
)paren
)paren
suffix:semicolon
macro_line|#else
id|outb
(paren
op_star
(paren
id|dest
op_increment
)paren
comma
id|_MEMDATA
)paren
suffix:semicolon
macro_line|#endif
)brace
DECL|variable|version
r_static
r_const
r_char
op_star
id|version
op_assign
l_string|&quot;com20020.c: v3.00 97/11/09 Avery Pennarun &lt;apenwarr@bond.net&gt; et al.&bslash;n&quot;
suffix:semicolon
multiline_comment|/****************************************************************************&n; *                                                                          *&n; * Probe and initialization                                                 *&n; *                                                                          *&n; ****************************************************************************/
multiline_comment|/* We cannot probe for an IO mapped card either, although we can check that&n; * it&squot;s where we were told it was, and even autoirq&n; */
DECL|function|__initfunc
id|__initfunc
c_func
(paren
r_int
id|arc20020_probe
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
)paren
(brace
r_int
id|ioaddr
op_assign
id|dev-&gt;base_addr
comma
id|status
comma
id|delayval
suffix:semicolon
r_int
r_int
id|airqmask
suffix:semicolon
id|BUGLVL
c_func
(paren
id|D_NORMAL
)paren
id|printk
c_func
(paren
id|version
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ioaddr
OL
l_int|0x200
)paren
(brace
id|BUGMSG
c_func
(paren
id|D_NORMAL
comma
l_string|&quot;No autoprobe for IO mapped cards; you &quot;
l_string|&quot;must specify the base address!&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
r_if
c_cond
(paren
id|check_region
c_func
(paren
id|ioaddr
comma
id|ARCNET_TOTAL_SIZE
)paren
)paren
(brace
id|BUGMSG
c_func
(paren
id|D_NORMAL
comma
l_string|&quot;IO region %xh-%xh already allocated.&bslash;n&quot;
comma
id|ioaddr
comma
id|ioaddr
op_plus
id|ARCNET_TOTAL_SIZE
op_minus
l_int|1
)paren
suffix:semicolon
r_return
op_minus
id|ENXIO
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ARCSTATUS
op_eq
l_int|0xFF
)paren
(brace
id|BUGMSG
c_func
(paren
id|D_NORMAL
comma
l_string|&quot;IO address %x empty&bslash;n&quot;
comma
id|ioaddr
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
id|ARCRESET0
suffix:semicolon
id|JIFFER
c_func
(paren
id|RESETtime
)paren
suffix:semicolon
id|status
op_assign
id|ARCSTATUS
suffix:semicolon
r_if
c_cond
(paren
(paren
id|status
op_amp
l_int|0x99
)paren
op_ne
(paren
id|NORXflag
op_or
id|TXFREEflag
op_or
id|RESETflag
)paren
)paren
(brace
id|BUGMSG
c_func
(paren
id|D_NORMAL
comma
l_string|&quot;Status invalid (%Xh).&bslash;n&quot;
comma
id|status
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
id|BUGMSG
c_func
(paren
id|D_INIT_REASONS
comma
l_string|&quot;Status after reset: %X&bslash;n&quot;
comma
id|status
)paren
suffix:semicolon
multiline_comment|/* Enable TX */
id|outb
c_func
(paren
l_int|0x39
comma
id|_CONFIG
)paren
suffix:semicolon
id|outb
c_func
(paren
id|inb
c_func
(paren
id|ioaddr
op_plus
l_int|8
)paren
comma
id|ioaddr
op_plus
l_int|7
)paren
suffix:semicolon
id|ACOMMAND
c_func
(paren
id|CFLAGScmd
op_or
id|RESETclear
op_or
id|CONFIGclear
)paren
suffix:semicolon
id|BUGMSG
c_func
(paren
id|D_INIT_REASONS
comma
l_string|&quot;Status after reset acknowledged: %X&bslash;n&quot;
comma
id|status
)paren
suffix:semicolon
multiline_comment|/* Reset card. */
id|outb
c_func
(paren
l_int|0x98
comma
id|_CONFIG
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|5
)paren
suffix:semicolon
id|outb
c_func
(paren
l_int|0x18
comma
id|_CONFIG
)paren
suffix:semicolon
multiline_comment|/* Read first loc&squot;n of memory */
id|outb
c_func
(paren
l_int|0
op_or
id|RDDATAflag
op_or
id|AUTOINCflag
comma
id|_ADDR_HI
)paren
suffix:semicolon
id|outb
c_func
(paren
l_int|0
comma
id|_ADDR_LO
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|status
op_assign
id|inb
c_func
(paren
id|_MEMDATA
)paren
)paren
op_ne
l_int|0xd1
)paren
(brace
id|BUGMSG
c_func
(paren
id|D_NORMAL
comma
l_string|&quot;Signature byte not found.&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|dev-&gt;irq
)paren
(brace
multiline_comment|/* if we do this, we&squot;re sure to get an IRQ since the&n;       * card has just reset and the NORXflag is on until&n;       * we tell it to start receiving.&n;       */
id|BUGMSG
c_func
(paren
id|D_INIT_REASONS
comma
l_string|&quot;intmask was %d:&bslash;n&quot;
comma
id|inb
c_func
(paren
id|_INTMASK
)paren
)paren
suffix:semicolon
id|outb
c_func
(paren
l_int|0
comma
id|_INTMASK
)paren
suffix:semicolon
id|airqmask
op_assign
id|probe_irq_on
c_func
(paren
)paren
suffix:semicolon
id|outb
c_func
(paren
id|NORXflag
comma
id|_INTMASK
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|1
)paren
suffix:semicolon
id|outb
c_func
(paren
l_int|0
comma
id|_INTMASK
)paren
suffix:semicolon
id|dev-&gt;irq
op_assign
id|probe_irq_off
c_func
(paren
id|airqmask
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;irq
op_le
l_int|0
)paren
(brace
id|BUGMSG
c_func
(paren
id|D_INIT_REASONS
comma
l_string|&quot;Autoprobe IRQ failed first time&bslash;n&quot;
)paren
suffix:semicolon
id|airqmask
op_assign
id|probe_irq_on
c_func
(paren
)paren
suffix:semicolon
id|outb
c_func
(paren
id|NORXflag
comma
id|_INTMASK
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|5
)paren
suffix:semicolon
id|outb
c_func
(paren
l_int|0
comma
id|_INTMASK
)paren
suffix:semicolon
id|dev-&gt;irq
op_assign
id|probe_irq_off
c_func
(paren
id|airqmask
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;irq
op_le
l_int|0
)paren
(brace
id|BUGMSG
c_func
(paren
id|D_NORMAL
comma
l_string|&quot;Autoprobe IRQ failed.&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
)brace
)brace
r_return
id|arc20020_found
c_func
(paren
id|dev
comma
id|dev-&gt;base_addr
comma
id|dev-&gt;irq
)paren
suffix:semicolon
)brace
multiline_comment|/* Set up the struct device associated with this card.  Called after&n; * probing succeeds.&n; */
DECL|function|__initfunc
id|__initfunc
c_func
(paren
r_int
id|arc20020_found
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
r_int
id|ioaddr
comma
r_int
id|airq
)paren
)paren
(brace
r_struct
id|arcnet_local
op_star
id|lp
suffix:semicolon
multiline_comment|/* reserve the irq */
r_if
c_cond
(paren
id|request_irq
c_func
(paren
id|airq
comma
op_amp
id|arcnet_interrupt
comma
l_int|0
comma
l_string|&quot;arcnet (COM20020)&quot;
comma
id|dev
)paren
)paren
(brace
id|BUGMSG
c_func
(paren
id|D_NORMAL
comma
l_string|&quot;Can&squot;t get IRQ %d!&bslash;n&quot;
comma
id|airq
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
id|dev-&gt;irq
op_assign
id|airq
suffix:semicolon
multiline_comment|/* reserve the I/O region - guaranteed to work by check_region */
id|request_region
c_func
(paren
id|ioaddr
comma
id|ARCNET_TOTAL_SIZE
comma
l_string|&quot;arcnet (COM20020)&quot;
)paren
suffix:semicolon
id|dev-&gt;base_addr
op_assign
id|ioaddr
suffix:semicolon
id|dev-&gt;mem_start
op_assign
id|dev-&gt;mem_end
op_assign
id|dev-&gt;rmem_start
op_assign
id|dev-&gt;rmem_end
op_assign
(paren
r_int
)paren
l_int|NULL
suffix:semicolon
multiline_comment|/* Initialize the rest of the device structure. */
id|dev-&gt;priv
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|arcnet_local
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;priv
op_eq
l_int|NULL
)paren
(brace
id|free_irq
c_func
(paren
id|airq
comma
id|dev
)paren
suffix:semicolon
id|release_region
c_func
(paren
id|ioaddr
comma
id|ARCNET_TOTAL_SIZE
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|memset
c_func
(paren
id|dev-&gt;priv
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|arcnet_local
)paren
)paren
suffix:semicolon
id|lp
op_assign
(paren
r_struct
id|arcnet_local
op_star
)paren
(paren
id|dev-&gt;priv
)paren
suffix:semicolon
id|lp-&gt;card_type
op_assign
id|ARC_20020
suffix:semicolon
id|lp-&gt;card_type_str
op_assign
l_string|&quot;COM 20020&quot;
suffix:semicolon
id|lp-&gt;arcnet_reset
op_assign
id|arc20020_reset
suffix:semicolon
id|lp-&gt;asetmask
op_assign
id|arc20020_setmask
suffix:semicolon
id|lp-&gt;astatus
op_assign
id|arc20020_status
suffix:semicolon
id|lp-&gt;acommand
op_assign
id|arc20020_command
suffix:semicolon
id|lp-&gt;en_dis_able_TX
op_assign
id|arc20020_en_dis_able_TX
suffix:semicolon
id|lp-&gt;openclose_device
op_assign
id|arc20020_openclose
suffix:semicolon
id|lp-&gt;prepare_tx
op_assign
id|arc20020_prepare_tx
suffix:semicolon
id|lp-&gt;inthandler
op_assign
id|arc20020_inthandler
suffix:semicolon
id|dev-&gt;set_multicast_list
op_assign
id|arc20020_set_mc_list
suffix:semicolon
multiline_comment|/* Fill in the fields of the device structure with generic&n;   * values.&n;   */
id|arcnet_setup
c_func
(paren
id|dev
)paren
suffix:semicolon
multiline_comment|/* And now fill particular fields with arcnet values */
id|dev-&gt;mtu
op_assign
l_int|1500
suffix:semicolon
multiline_comment|/* completely arbitrary - agrees with ether, though */
id|dev-&gt;hard_header_len
op_assign
r_sizeof
(paren
r_struct
id|ClientData
)paren
suffix:semicolon
id|lp-&gt;sequence
op_assign
l_int|1
suffix:semicolon
id|lp-&gt;recbuf
op_assign
l_int|0
suffix:semicolon
id|BUGMSG
c_func
(paren
id|D_DURING
comma
l_string|&quot;ClientData header size is %d.&bslash;n&quot;
comma
r_sizeof
(paren
r_struct
id|ClientData
)paren
)paren
suffix:semicolon
id|BUGMSG
c_func
(paren
id|D_DURING
comma
l_string|&quot;HardHeader size is %d.&bslash;n&quot;
comma
r_sizeof
(paren
r_struct
id|archdr
)paren
)paren
suffix:semicolon
multiline_comment|/* get and check the station ID from offset 1 in shmem */
id|lp-&gt;timeout
op_assign
id|dev-&gt;dev_addr
(braket
l_int|3
)braket
op_amp
l_int|3
suffix:semicolon
id|dev-&gt;dev_addr
(braket
l_int|3
)braket
op_assign
l_int|0
suffix:semicolon
id|lp-&gt;backplane
op_assign
id|dev-&gt;dev_addr
(braket
l_int|1
)braket
op_amp
l_int|1
suffix:semicolon
id|dev-&gt;dev_addr
(braket
l_int|1
)braket
op_assign
l_int|0
suffix:semicolon
id|lp-&gt;setup
op_assign
(paren
id|dev-&gt;dev_addr
(braket
l_int|2
)braket
op_amp
l_int|7
)paren
op_lshift
l_int|1
suffix:semicolon
id|dev-&gt;dev_addr
(braket
l_int|2
)braket
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;dev_addr
(braket
l_int|0
)braket
)paren
id|lp-&gt;stationid
op_assign
id|dev-&gt;dev_addr
(braket
l_int|0
)braket
suffix:semicolon
r_else
id|lp-&gt;stationid
op_assign
id|inb
c_func
(paren
id|ioaddr
op_plus
l_int|8
)paren
suffix:semicolon
multiline_comment|/* FIX ME - We should check that&n;&t;&t;&t;&t;&t;       this is valid before using it */
id|lp-&gt;config
op_assign
l_int|0x21
op_or
(paren
id|lp-&gt;timeout
op_lshift
l_int|3
)paren
op_or
(paren
id|lp-&gt;backplane
op_lshift
l_int|2
)paren
suffix:semicolon
multiline_comment|/* Default 0x38 + register: Node ID */
id|SETCONF
suffix:semicolon
id|outb
c_func
(paren
id|lp-&gt;stationid
comma
id|ioaddr
op_plus
l_int|7
)paren
suffix:semicolon
id|REGSETUP
suffix:semicolon
id|SETCONF
suffix:semicolon
id|outb
c_func
(paren
id|lp-&gt;setup
comma
id|ioaddr
op_plus
l_int|7
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|lp-&gt;stationid
)paren
id|BUGMSG
c_func
(paren
id|D_NORMAL
comma
l_string|&quot;WARNING!  Station address 00 is reserved &quot;
l_string|&quot;for broadcasts!&bslash;n&quot;
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
id|lp-&gt;stationid
op_eq
l_int|255
)paren
id|BUGMSG
c_func
(paren
id|D_NORMAL
comma
l_string|&quot;WARNING!  Station address FF may confuse &quot;
l_string|&quot;DOS networking programs!&bslash;n&quot;
)paren
suffix:semicolon
id|dev-&gt;dev_addr
(braket
l_int|0
)braket
op_assign
id|lp-&gt;stationid
suffix:semicolon
id|BUGMSG
c_func
(paren
id|D_NORMAL
comma
l_string|&quot;ARCnet COM20020: station %02Xh found at %03lXh, IRQ %d.&bslash;n&quot;
comma
id|lp-&gt;stationid
comma
id|dev-&gt;base_addr
comma
id|dev-&gt;irq
)paren
suffix:semicolon
r_if
c_cond
(paren
id|lp-&gt;backplane
)paren
id|BUGMSG
(paren
id|D_NORMAL
comma
l_string|&quot;Using backplane mode.&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|lp-&gt;timeout
op_ne
l_int|3
)paren
id|BUGMSG
(paren
id|D_NORMAL
comma
l_string|&quot;Using Extended Timeout value of %d.&bslash;n&quot;
comma
id|lp-&gt;timeout
)paren
suffix:semicolon
r_if
c_cond
(paren
id|lp-&gt;setup
)paren
(brace
id|BUGMSG
(paren
id|D_NORMAL
comma
l_string|&quot;Using CKP %d - Data rate %s.&bslash;n&quot;
comma
id|lp-&gt;setup
op_rshift
l_int|1
comma
id|clockrates
(braket
id|lp-&gt;setup
op_rshift
l_int|1
)braket
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/****************************************************************************&n; *                                                                          *&n; * Utility routines                                                         *&n; *                                                                          *&n; ****************************************************************************/
multiline_comment|/* Do a hardware reset on the card, and set up necessary registers.&n; *&n; * This should be called as little as possible, because it disrupts the&n; * token on the network (causes a RECON) and requires a significant delay.&n; *&n; * However, it does make sure the card is in a defined state.&n; */
DECL|function|arc20020_reset
r_int
id|arc20020_reset
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
r_int
id|reset_delay
)paren
(brace
r_struct
id|arcnet_local
op_star
id|lp
op_assign
(paren
r_struct
id|arcnet_local
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_int
id|ioaddr
op_assign
id|dev-&gt;base_addr
suffix:semicolon
r_int
id|delayval
comma
id|recbuf
op_assign
id|lp-&gt;recbuf
suffix:semicolon
r_if
c_cond
(paren
id|reset_delay
op_eq
l_int|3
)paren
(brace
id|ARCRESET
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* no IRQ&squot;s, please! */
id|lp-&gt;intmask
op_assign
l_int|0
suffix:semicolon
id|SETMASK
suffix:semicolon
id|BUGMSG
c_func
(paren
id|D_INIT
comma
l_string|&quot;Resetting %s (status=%Xh)&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|ARCSTATUS
)paren
suffix:semicolon
id|lp-&gt;config
op_assign
l_int|0x20
op_or
(paren
id|lp-&gt;timeout
op_lshift
l_int|3
)paren
op_or
(paren
id|lp-&gt;backplane
op_lshift
l_int|2
)paren
suffix:semicolon
multiline_comment|/* power-up defaults */
id|SETCONF
suffix:semicolon
r_if
c_cond
(paren
id|reset_delay
)paren
(brace
multiline_comment|/* reset the card */
id|ARCRESET
suffix:semicolon
id|JIFFER
c_func
(paren
id|RESETtime
)paren
suffix:semicolon
)brace
id|ACOMMAND
c_func
(paren
id|CFLAGScmd
op_or
id|RESETclear
)paren
suffix:semicolon
multiline_comment|/* clear flags &amp; end reset */
id|ACOMMAND
c_func
(paren
id|CFLAGScmd
op_or
id|CONFIGclear
)paren
suffix:semicolon
multiline_comment|/* verify that the ARCnet signature byte is present */
r_if
c_cond
(paren
id|get_buffer_byte
c_func
(paren
id|dev
comma
l_int|0
)paren
op_ne
id|TESTvalue
)paren
(brace
id|BUGMSG
c_func
(paren
id|D_NORMAL
comma
l_string|&quot;reset failed: TESTvalue not present.&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
multiline_comment|/* clear out status variables */
id|recbuf
op_assign
id|lp-&gt;recbuf
op_assign
l_int|0
suffix:semicolon
id|lp-&gt;txbuf
op_assign
l_int|2
suffix:semicolon
multiline_comment|/* enable extended (512-byte) packets */
id|ACOMMAND
c_func
(paren
id|CONFIGcmd
op_or
id|EXTconf
)paren
suffix:semicolon
multiline_comment|/* and enable receive of our first packet to the first buffer */
id|EnableReceiver
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* re-enable interrupts */
id|lp-&gt;intmask
op_or_assign
id|NORXflag
suffix:semicolon
macro_line|#ifdef DETECT_RECONFIGS
id|lp-&gt;intmask
op_or_assign
id|RECONflag
suffix:semicolon
macro_line|#endif
id|SETMASK
suffix:semicolon
multiline_comment|/* done!  return success. */
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Set or clear the multicast filter for this adaptor.&n; * num_addrs == -1&t;Promiscuous mode, receive all packets&n; * num_addrs == 0&t;Normal mode, clear multicast list&n; * num_addrs &gt; 0&t;Multicast mode, receive normal and MC packets, and do&n; *&t;&t;&t;best-effort filtering.&n; *      FIX ME - do multicast stuff, not just promiscuous.&n; */
r_static
r_void
DECL|function|arc20020_set_mc_list
id|arc20020_set_mc_list
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
r_struct
id|arcnet_local
op_star
id|lp
op_assign
id|dev-&gt;priv
suffix:semicolon
r_int
id|ioaddr
op_assign
id|dev-&gt;base_addr
suffix:semicolon
r_if
c_cond
(paren
(paren
id|dev-&gt;flags
op_amp
id|IFF_PROMISC
)paren
op_logical_and
(paren
id|dev-&gt;flags
op_amp
id|IFF_UP
)paren
)paren
(brace
multiline_comment|/* Enable promiscuous mode */
r_if
c_cond
(paren
op_logical_neg
(paren
id|lp-&gt;setup
op_amp
id|PROMISCflag
)paren
)paren
id|BUGMSG
c_func
(paren
id|D_NORMAL
comma
l_string|&quot;Setting promiscuous flag...&bslash;n&quot;
)paren
suffix:semicolon
id|REGSETUP
suffix:semicolon
id|SETCONF
suffix:semicolon
id|lp-&gt;setup
op_or_assign
id|PROMISCflag
suffix:semicolon
id|outb
c_func
(paren
id|lp-&gt;setup
comma
id|ioaddr
op_plus
l_int|7
)paren
suffix:semicolon
)brace
r_else
multiline_comment|/* Disable promiscuous mode, use normal mode */
(brace
r_if
c_cond
(paren
(paren
id|lp-&gt;setup
op_amp
id|PROMISCflag
)paren
)paren
id|BUGMSG
c_func
(paren
id|D_NORMAL
comma
l_string|&quot;Resetting promiscuous flag...&bslash;n&quot;
)paren
suffix:semicolon
id|REGSETUP
suffix:semicolon
id|SETCONF
suffix:semicolon
id|lp-&gt;setup
op_and_assign
op_complement
id|PROMISCflag
suffix:semicolon
id|outb
c_func
(paren
id|lp-&gt;setup
comma
id|ioaddr
op_plus
l_int|7
)paren
suffix:semicolon
)brace
)brace
DECL|function|arc20020_openclose
r_static
r_void
id|arc20020_openclose
c_func
(paren
r_int
id|open
)paren
(brace
r_if
c_cond
(paren
id|open
)paren
id|MOD_INC_USE_COUNT
suffix:semicolon
r_else
id|MOD_DEC_USE_COUNT
suffix:semicolon
)brace
DECL|function|arc20020_en_dis_able_TX
r_static
r_void
id|arc20020_en_dis_able_TX
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
r_int
id|enable
)paren
(brace
r_struct
id|arcnet_local
op_star
id|lp
op_assign
(paren
r_struct
id|arcnet_local
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_int
id|ioaddr
op_assign
id|dev-&gt;base_addr
suffix:semicolon
id|lp-&gt;config
op_assign
id|enable
ques
c_cond
(paren
id|lp-&gt;config
op_or
id|TXENflag
)paren
suffix:colon
(paren
id|lp-&gt;config
op_amp
op_complement
id|TXENflag
)paren
suffix:semicolon
id|SETCONF
suffix:semicolon
)brace
DECL|function|arc20020_setmask
r_static
r_void
id|arc20020_setmask
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
id|u_char
id|mask
)paren
(brace
r_int
id|ioaddr
op_assign
id|dev-&gt;base_addr
suffix:semicolon
id|AINTMASK
c_func
(paren
id|mask
)paren
suffix:semicolon
)brace
DECL|function|arc20020_status
r_static
id|u_char
id|arc20020_status
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
r_int
id|ioaddr
op_assign
id|dev-&gt;base_addr
suffix:semicolon
r_return
id|ARCSTATUS
suffix:semicolon
)brace
DECL|function|arc20020_command
r_static
r_void
id|arc20020_command
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
id|u_char
id|cmd
)paren
(brace
r_int
id|ioaddr
op_assign
id|dev-&gt;base_addr
suffix:semicolon
id|ACOMMAND
c_func
(paren
id|cmd
)paren
suffix:semicolon
)brace
multiline_comment|/* The actual interrupt handler routine - handle various IRQ&squot;s generated&n; * by the card.&n; */
r_static
r_void
DECL|function|arc20020_inthandler
id|arc20020_inthandler
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
r_struct
id|arcnet_local
op_star
id|lp
op_assign
(paren
r_struct
id|arcnet_local
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_int
id|ioaddr
op_assign
id|dev-&gt;base_addr
comma
id|status
comma
id|boguscount
op_assign
l_int|3
comma
id|didsomething
comma
id|dstatus
suffix:semicolon
id|AINTMASK
c_func
(paren
l_int|0
)paren
suffix:semicolon
id|BUGMSG
c_func
(paren
id|D_DURING
comma
l_string|&quot;in arc20020_inthandler (status=%Xh, intmask=%Xh)&bslash;n&quot;
comma
id|ARCSTATUS
comma
id|lp-&gt;intmask
)paren
suffix:semicolon
r_do
(brace
id|status
op_assign
id|ARCSTATUS
suffix:semicolon
id|didsomething
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* RESET flag was enabled - card is resetting and if RX&n;       * is disabled, it&squot;s NOT because we just got a packet.&n;       */
r_if
c_cond
(paren
id|status
op_amp
id|RESETflag
)paren
(brace
id|BUGMSG
c_func
(paren
id|D_NORMAL
comma
l_string|&quot;spurious reset (status=%Xh)&bslash;n&quot;
comma
id|status
)paren
suffix:semicolon
id|arc20020_reset
c_func
(paren
id|dev
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* all other flag values are just garbage */
r_break
suffix:semicolon
)brace
multiline_comment|/* RX is inhibited - we must have received something. */
r_if
c_cond
(paren
id|status
op_amp
id|lp-&gt;intmask
op_amp
id|NORXflag
)paren
(brace
r_int
id|recbuf
op_assign
id|lp-&gt;recbuf
op_assign
op_logical_neg
id|lp-&gt;recbuf
suffix:semicolon
r_int
id|oldaddr
op_assign
l_int|0
suffix:semicolon
id|BUGMSG
c_func
(paren
id|D_DURING
comma
l_string|&quot;receive irq (status=%Xh)&bslash;n&quot;
comma
id|status
)paren
suffix:semicolon
multiline_comment|/* enable receive of our next packet */
id|EnableReceiver
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|lp-&gt;intx
)paren
id|oldaddr
op_assign
(paren
id|inb
c_func
(paren
id|_ADDR_HI
)paren
op_lshift
l_int|8
)paren
op_or
id|inb
c_func
(paren
id|_ADDR_LO
)paren
suffix:semicolon
multiline_comment|/* Got a packet. */
id|arc20020_rx
c_func
(paren
id|dev
comma
op_logical_neg
id|recbuf
)paren
suffix:semicolon
r_if
c_cond
(paren
id|lp-&gt;intx
)paren
(brace
id|outb
c_func
(paren
(paren
id|oldaddr
op_rshift
l_int|8
)paren
comma
id|_ADDR_HI
)paren
suffix:semicolon
id|outb
c_func
(paren
id|oldaddr
op_amp
l_int|0xff
comma
id|_ADDR_LO
)paren
suffix:semicolon
)brace
id|didsomething
op_increment
suffix:semicolon
)brace
multiline_comment|/* it can only be an xmit-done irq if we&squot;re xmitting :) */
multiline_comment|/*if (status&amp;TXFREEflag &amp;&amp; !lp-&gt;in_txhandler &amp;&amp; lp-&gt;sending)*/
r_if
c_cond
(paren
id|status
op_amp
id|lp-&gt;intmask
op_amp
id|TXFREEflag
)paren
(brace
r_struct
id|Outgoing
op_star
id|out
op_assign
op_amp
(paren
id|lp-&gt;outgoing
)paren
suffix:semicolon
r_int
id|was_sending
op_assign
id|lp-&gt;sending
suffix:semicolon
id|lp-&gt;intmask
op_and_assign
op_complement
id|TXFREEflag
suffix:semicolon
id|lp-&gt;in_txhandler
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|was_sending
)paren
id|lp-&gt;sending
op_decrement
suffix:semicolon
id|BUGMSG
c_func
(paren
id|D_DURING
comma
l_string|&quot;TX IRQ (stat=%Xh, numsegs=%d, segnum=%d, skb=%ph)&bslash;n&quot;
comma
id|status
comma
id|out-&gt;numsegs
comma
id|out-&gt;segnum
comma
id|out-&gt;skb
)paren
suffix:semicolon
r_if
c_cond
(paren
id|was_sending
op_logical_and
op_logical_neg
(paren
id|status
op_amp
id|TXACKflag
)paren
)paren
(brace
r_if
c_cond
(paren
id|lp-&gt;lasttrans_dest
op_ne
l_int|0
)paren
(brace
id|BUGMSG
c_func
(paren
id|D_EXTRA
comma
l_string|&quot;transmit was not acknowledged! (status=%Xh, dest=%02Xh)&bslash;n&quot;
comma
id|status
comma
id|lp-&gt;lasttrans_dest
)paren
suffix:semicolon
id|lp-&gt;stats.tx_errors
op_increment
suffix:semicolon
id|lp-&gt;stats.tx_carrier_errors
op_increment
suffix:semicolon
)brace
r_else
(brace
id|BUGMSG
c_func
(paren
id|D_DURING
comma
l_string|&quot;broadcast was not acknowledged; that&squot;s normal (status=%Xh, dest=%02Xh)&bslash;n&quot;
comma
id|status
comma
id|lp-&gt;lasttrans_dest
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* send packet if there is one */
id|arcnet_go_tx
c_func
(paren
id|dev
comma
l_int|0
)paren
suffix:semicolon
id|didsomething
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|lp-&gt;intx
)paren
(brace
id|BUGMSG
c_func
(paren
id|D_DURING
comma
l_string|&quot;TXDONE while intx! (status=%Xh, intx=%d)&bslash;n&quot;
comma
id|ARCSTATUS
comma
id|lp-&gt;intx
)paren
suffix:semicolon
id|lp-&gt;in_txhandler
op_decrement
suffix:semicolon
r_continue
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|lp-&gt;outgoing.skb
)paren
(brace
id|BUGMSG
c_func
(paren
id|D_DURING
comma
l_string|&quot;TX IRQ done: no split to continue.&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* inform upper layers */
r_if
c_cond
(paren
op_logical_neg
id|lp-&gt;txready
)paren
id|arcnet_tx_done
c_func
(paren
id|dev
comma
id|lp
)paren
suffix:semicolon
id|lp-&gt;in_txhandler
op_decrement
suffix:semicolon
r_continue
suffix:semicolon
)brace
multiline_comment|/* if more than one segment, and not all segments&n;&t;   * are done, then continue xmit.&n;&t;   */
r_if
c_cond
(paren
id|out-&gt;segnum
OL
id|out-&gt;numsegs
)paren
id|arcnetA_continue_tx
c_func
(paren
id|dev
)paren
suffix:semicolon
id|arcnet_go_tx
c_func
(paren
id|dev
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* if segnum==numsegs, the transmission is finished;&n;&t;   * free the skb.&n;&t;   */
r_if
c_cond
(paren
id|out-&gt;segnum
op_ge
id|out-&gt;numsegs
)paren
(brace
multiline_comment|/* transmit completed */
id|out-&gt;segnum
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|out-&gt;skb
)paren
(brace
id|lp-&gt;stats.tx_bytes
op_add_assign
id|out-&gt;skb-&gt;len
suffix:semicolon
id|dev_kfree_skb
c_func
(paren
id|out-&gt;skb
)paren
suffix:semicolon
)brace
id|out-&gt;skb
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/* inform upper layers */
r_if
c_cond
(paren
op_logical_neg
id|lp-&gt;txready
)paren
id|arcnet_tx_done
c_func
(paren
id|dev
comma
id|lp
)paren
suffix:semicolon
)brace
id|didsomething
op_increment
suffix:semicolon
id|lp-&gt;in_txhandler
op_decrement
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|lp-&gt;txready
op_logical_and
op_logical_neg
id|lp-&gt;sending
op_logical_and
op_logical_neg
id|lp-&gt;intx
)paren
(brace
id|BUGMSG
c_func
(paren
id|D_NORMAL
comma
l_string|&quot;recovery from silent TX (status=%Xh)&bslash;n&quot;
comma
id|status
)paren
suffix:semicolon
id|arcnet_go_tx
c_func
(paren
id|dev
comma
l_int|0
)paren
suffix:semicolon
id|didsomething
op_increment
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|dstatus
op_assign
id|inb
c_func
(paren
id|_DIAGSTAT
)paren
)paren
op_amp
id|NEWNXTIDflag
)paren
(brace
id|REGNXTID
suffix:semicolon
id|SETCONF
suffix:semicolon
id|BUGMSG
c_func
(paren
id|D_EXTRA
comma
l_string|&quot;New NextID detected: %X&bslash;n&quot;
comma
id|inb
c_func
(paren
id|ioaddr
op_plus
l_int|7
)paren
)paren
suffix:semicolon
)brace
macro_line|#ifdef DETECT_RECONFIGS
r_if
c_cond
(paren
id|status
op_amp
(paren
id|lp-&gt;intmask
)paren
op_amp
id|RECONflag
)paren
(brace
id|ACOMMAND
c_func
(paren
id|CFLAGScmd
op_or
id|CONFIGclear
)paren
suffix:semicolon
id|lp-&gt;stats.tx_carrier_errors
op_increment
suffix:semicolon
macro_line|#ifdef SHOW_RECONFIGS
id|BUGMSG
c_func
(paren
id|D_NORMAL
comma
l_string|&quot;Network reconfiguration detected (status=%Xh, diag status=%Xh, config=%X)&bslash;n&quot;
comma
id|status
comma
id|dstatus
comma
id|lp-&gt;config
)paren
suffix:semicolon
macro_line|#endif /* SHOW_RECONFIGS */
macro_line|#ifdef RECON_THRESHOLD
multiline_comment|/* is the RECON info empty or old? */
r_if
c_cond
(paren
op_logical_neg
id|lp-&gt;first_recon
op_logical_or
op_logical_neg
id|lp-&gt;last_recon
op_logical_or
id|jiffies
op_minus
id|lp-&gt;last_recon
OG
id|HZ
op_star
l_int|10
)paren
(brace
r_if
c_cond
(paren
id|lp-&gt;network_down
)paren
id|BUGMSG
c_func
(paren
id|D_NORMAL
comma
l_string|&quot;reconfiguration detected: cabling restored?&bslash;n&quot;
)paren
suffix:semicolon
id|lp-&gt;first_recon
op_assign
id|lp-&gt;last_recon
op_assign
id|jiffies
suffix:semicolon
id|lp-&gt;num_recons
op_assign
id|lp-&gt;network_down
op_assign
l_int|0
suffix:semicolon
id|BUGMSG
c_func
(paren
id|D_DURING
comma
l_string|&quot;recon: clearing counters.&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_else
multiline_comment|/* add to current RECON counter */
(brace
id|lp-&gt;last_recon
op_assign
id|jiffies
suffix:semicolon
id|lp-&gt;num_recons
op_increment
suffix:semicolon
id|BUGMSG
c_func
(paren
id|D_DURING
comma
l_string|&quot;recon: counter=%d, time=%lds, net=%d&bslash;n&quot;
comma
id|lp-&gt;num_recons
comma
(paren
id|lp-&gt;last_recon
op_minus
id|lp-&gt;first_recon
)paren
op_div
id|HZ
comma
id|lp-&gt;network_down
)paren
suffix:semicolon
multiline_comment|/* if network is marked up;&n;&t;       * and first_recon and last_recon are 60+ sec&n;&t;       *   apart;&n;&t;       * and the average no. of recons counted is&n;&t;       *   &gt; RECON_THRESHOLD/min;&n;&t;       * then print a warning message.&n;&t;       */
r_if
c_cond
(paren
op_logical_neg
id|lp-&gt;network_down
op_logical_and
(paren
id|lp-&gt;last_recon
op_minus
id|lp-&gt;first_recon
)paren
op_le
id|HZ
op_star
l_int|60
op_logical_and
id|lp-&gt;num_recons
op_ge
id|RECON_THRESHOLD
)paren
(brace
id|lp-&gt;network_down
op_assign
l_int|1
suffix:semicolon
id|BUGMSG
c_func
(paren
id|D_NORMAL
comma
l_string|&quot;many reconfigurations detected: cabling problem?&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
op_logical_neg
id|lp-&gt;network_down
op_logical_and
id|lp-&gt;last_recon
op_minus
id|lp-&gt;first_recon
OG
id|HZ
op_star
l_int|60
)paren
(brace
multiline_comment|/* reset counters if we&squot;ve gone for&n;&t;&t;   * over a minute.&n;&t;&t;   */
id|lp-&gt;first_recon
op_assign
id|lp-&gt;last_recon
suffix:semicolon
id|lp-&gt;num_recons
op_assign
l_int|1
suffix:semicolon
)brace
)brace
)brace
r_else
r_if
c_cond
(paren
id|lp-&gt;network_down
op_logical_and
id|jiffies
op_minus
id|lp-&gt;last_recon
OG
id|HZ
op_star
l_int|10
)paren
(brace
r_if
c_cond
(paren
id|lp-&gt;network_down
)paren
id|BUGMSG
c_func
(paren
id|D_NORMAL
comma
l_string|&quot;cabling restored?&bslash;n&quot;
)paren
suffix:semicolon
id|lp-&gt;first_recon
op_assign
id|lp-&gt;last_recon
op_assign
l_int|0
suffix:semicolon
id|lp-&gt;num_recons
op_assign
id|lp-&gt;network_down
op_assign
l_int|0
suffix:semicolon
id|BUGMSG
c_func
(paren
id|D_DURING
comma
l_string|&quot;not recon: clearing counters anyway.&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
)brace
macro_line|#endif /* DETECT_RECONFIGS */
)brace
r_while
c_loop
(paren
op_decrement
id|boguscount
op_logical_and
id|didsomething
)paren
suffix:semicolon
id|BUGMSG
c_func
(paren
id|D_DURING
comma
l_string|&quot;net_interrupt complete (status=%Xh, count=%d)&bslash;n&quot;
comma
id|ARCSTATUS
comma
id|boguscount
)paren
suffix:semicolon
id|BUGMSG
c_func
(paren
id|D_DURING
comma
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
id|SETMASK
suffix:semicolon
multiline_comment|/* put back interrupt mask */
)brace
multiline_comment|/* A packet has arrived; grab it from the buffers and pass it to the generic&n; * arcnet_rx routing to deal with it.&n; */
r_static
r_void
DECL|function|arc20020_rx
id|arc20020_rx
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
r_int
id|recbuf
)paren
(brace
r_struct
id|arcnet_local
op_star
id|lp
op_assign
(paren
r_struct
id|arcnet_local
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_int
id|ioaddr
op_assign
id|dev-&gt;base_addr
suffix:semicolon
r_union
id|ArcPacket
id|packetbuf
suffix:semicolon
r_union
id|ArcPacket
op_star
id|arcpacket
op_assign
op_amp
id|packetbuf
suffix:semicolon
id|u_char
op_star
id|arcsoft
suffix:semicolon
r_int
id|length
comma
id|offset
suffix:semicolon
id|u_char
id|daddr
comma
id|saddr
suffix:semicolon
id|lp-&gt;stats.rx_packets
op_increment
suffix:semicolon
id|get_whole_buffer
c_func
(paren
id|dev
comma
id|recbuf
op_star
l_int|512
comma
l_int|4
comma
(paren
r_char
op_star
)paren
id|arcpacket
)paren
suffix:semicolon
id|saddr
op_assign
id|arcpacket-&gt;hardheader.source
suffix:semicolon
multiline_comment|/* if source is 0, it&squot;s a &quot;used&quot; packet! */
r_if
c_cond
(paren
id|saddr
op_eq
l_int|0
)paren
(brace
id|BUGMSG
c_func
(paren
id|D_NORMAL
comma
l_string|&quot;discarding old packet. (status=%Xh)&bslash;n&quot;
comma
id|ARCSTATUS
)paren
suffix:semicolon
id|lp-&gt;stats.rx_errors
op_increment
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/* Set source address to zero to mark it as old */
id|put_buffer_byte
c_func
(paren
id|dev
comma
id|recbuf
op_star
l_int|512
comma
l_int|0
)paren
suffix:semicolon
id|arcpacket-&gt;hardheader.source
op_assign
l_int|0
suffix:semicolon
id|daddr
op_assign
id|arcpacket-&gt;hardheader.destination
suffix:semicolon
r_if
c_cond
(paren
id|arcpacket-&gt;hardheader.offset1
)paren
multiline_comment|/* Normal Packet */
(brace
id|offset
op_assign
id|arcpacket-&gt;hardheader.offset1
suffix:semicolon
id|arcsoft
op_assign
op_amp
id|arcpacket-&gt;raw
(braket
id|offset
)braket
suffix:semicolon
id|length
op_assign
l_int|256
op_minus
id|offset
suffix:semicolon
)brace
r_else
multiline_comment|/* ExtendedPacket or ExceptionPacket */
(brace
id|offset
op_assign
id|arcpacket-&gt;hardheader.offset2
suffix:semicolon
id|arcsoft
op_assign
op_amp
id|arcpacket-&gt;raw
(braket
id|offset
)braket
suffix:semicolon
id|length
op_assign
l_int|512
op_minus
id|offset
suffix:semicolon
)brace
id|get_whole_buffer
c_func
(paren
id|dev
comma
id|recbuf
op_star
l_int|512
op_plus
id|offset
comma
id|length
comma
(paren
r_char
op_star
)paren
id|arcpacket
op_plus
id|offset
)paren
suffix:semicolon
id|arcnet_rx
c_func
(paren
id|lp
comma
id|arcsoft
comma
id|length
comma
id|saddr
comma
id|daddr
)paren
suffix:semicolon
id|BUGLVL
c_func
(paren
id|D_RX
)paren
id|arcnet_dump_packet
c_func
(paren
id|lp-&gt;adev
comma
id|arcpacket-&gt;raw
comma
id|length
OG
l_int|240
comma
l_string|&quot;rx&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/* Given an skb, copy a packet into the ARCnet buffers for later transmission&n; * by arcnet_go_tx.&n; */
r_static
r_void
DECL|function|arc20020_prepare_tx
id|arc20020_prepare_tx
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
id|u_char
op_star
id|hdr
comma
r_int
id|hdrlen
comma
r_char
op_star
id|data
comma
r_int
id|length
comma
r_int
id|daddr
comma
r_int
id|exceptA
comma
r_int
id|offset
)paren
(brace
r_struct
id|arcnet_local
op_star
id|lp
op_assign
(paren
r_struct
id|arcnet_local
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|lp-&gt;txbuf
op_assign
id|lp-&gt;txbuf
op_xor
l_int|1
suffix:semicolon
multiline_comment|/* XOR with 1 to alternate between 2 and 3 */
id|length
op_add_assign
id|hdrlen
suffix:semicolon
id|BUGMSG
c_func
(paren
id|D_TX
comma
l_string|&quot;arcnetAS_prep_tx: hdr:%ph, length:%d, data:%ph&bslash;n&quot;
comma
id|hdr
comma
id|length
comma
id|data
)paren
suffix:semicolon
id|put_buffer_byte
c_func
(paren
id|dev
comma
id|lp-&gt;txbuf
op_star
l_int|512
op_plus
l_int|1
comma
id|daddr
)paren
suffix:semicolon
multiline_comment|/* load packet into shared memory */
r_if
c_cond
(paren
id|length
op_le
id|MTU
)paren
multiline_comment|/* Normal (256-byte) Packet */
id|put_buffer_byte
c_func
(paren
id|dev
comma
id|lp-&gt;txbuf
op_star
l_int|512
op_plus
l_int|2
comma
id|offset
op_assign
id|offset
ques
c_cond
id|offset
suffix:colon
l_int|256
op_minus
id|length
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
id|length
op_ge
id|MinTU
op_logical_or
id|offset
)paren
multiline_comment|/* Extended (512-byte) Packet */
(brace
id|put_buffer_byte
c_func
(paren
id|dev
comma
id|lp-&gt;txbuf
op_star
l_int|512
op_plus
l_int|2
comma
l_int|0
)paren
suffix:semicolon
id|put_buffer_byte
c_func
(paren
id|dev
comma
id|lp-&gt;txbuf
op_star
l_int|512
op_plus
l_int|3
comma
id|offset
op_assign
id|offset
ques
c_cond
id|offset
suffix:colon
l_int|512
op_minus
id|length
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|exceptA
)paren
multiline_comment|/* RFC1201 Exception Packet */
(brace
id|put_buffer_byte
c_func
(paren
id|dev
comma
id|lp-&gt;txbuf
op_star
l_int|512
op_plus
l_int|2
comma
l_int|0
)paren
suffix:semicolon
id|put_buffer_byte
c_func
(paren
id|dev
comma
id|lp-&gt;txbuf
op_star
l_int|512
op_plus
l_int|3
comma
id|offset
op_assign
l_int|512
op_minus
id|length
op_minus
l_int|4
)paren
suffix:semicolon
multiline_comment|/* exception-specific stuff - these four bytes&n;       * make the packet long enough to fit in a 512-byte&n;       * frame.&n;       */
id|put_buffer_byte
c_func
(paren
id|dev
comma
id|lp-&gt;txbuf
op_star
l_int|512
op_plus
id|offset
comma
id|hdr
(braket
l_int|0
)braket
)paren
suffix:semicolon
id|put_whole_buffer
c_func
(paren
id|dev
comma
id|lp-&gt;txbuf
op_star
l_int|512
op_plus
id|offset
op_plus
l_int|1
comma
l_int|3
comma
l_string|&quot;&bslash;377&bslash;377&bslash;377&quot;
)paren
suffix:semicolon
id|offset
op_add_assign
l_int|4
suffix:semicolon
)brace
r_else
multiline_comment|/* &quot;other&quot; Exception packet */
(brace
multiline_comment|/* RFC1051 - set 4 trailing bytes to 0 */
id|put_whole_buffer
c_func
(paren
id|dev
comma
id|lp-&gt;txbuf
op_star
l_int|512
op_plus
l_int|508
comma
l_int|4
comma
l_string|&quot;&bslash;0&bslash;0&bslash;0&bslash;0&quot;
)paren
suffix:semicolon
multiline_comment|/* now round up to MinTU */
id|put_buffer_byte
c_func
(paren
id|dev
comma
id|lp-&gt;txbuf
op_star
l_int|512
op_plus
l_int|2
comma
l_int|0
)paren
suffix:semicolon
id|put_buffer_byte
c_func
(paren
id|dev
comma
id|lp-&gt;txbuf
op_star
l_int|512
op_plus
l_int|3
comma
id|offset
op_assign
l_int|512
op_minus
id|MinTU
)paren
suffix:semicolon
)brace
multiline_comment|/* copy the packet into ARCnet shmem&n;   *  - the first bytes of ClientData header are skipped&n;   */
id|put_whole_buffer
c_func
(paren
id|dev
comma
l_int|512
op_star
id|lp-&gt;txbuf
op_plus
id|offset
comma
id|hdrlen
comma
(paren
id|u_char
op_star
)paren
id|hdr
)paren
suffix:semicolon
id|put_whole_buffer
c_func
(paren
id|dev
comma
l_int|512
op_star
id|lp-&gt;txbuf
op_plus
id|offset
op_plus
id|hdrlen
comma
id|length
op_minus
id|hdrlen
comma
id|data
)paren
suffix:semicolon
id|BUGMSG
c_func
(paren
id|D_DURING
comma
l_string|&quot;transmitting packet to station %02Xh (%d bytes)&bslash;n&quot;
comma
id|daddr
comma
id|length
)paren
suffix:semicolon
id|lp-&gt;lastload_dest
op_assign
id|daddr
suffix:semicolon
id|lp-&gt;txready
op_assign
id|lp-&gt;txbuf
suffix:semicolon
multiline_comment|/* packet is ready for sending */
)brace
multiline_comment|/****************************************************************************&n; *                                                                          *&n; * Kernel Loadable Module Support                                           *&n; *                                                                          *&n; ****************************************************************************/
macro_line|#ifdef MODULE
DECL|variable|cards
r_static
r_struct
id|device
op_star
id|cards
(braket
l_int|16
)braket
op_assign
initialization_block
suffix:semicolon
DECL|function|init_module
r_int
id|init_module
c_func
(paren
r_void
)paren
(brace
r_struct
id|device
op_star
id|dev
suffix:semicolon
id|cards
(braket
l_int|0
)braket
op_assign
id|dev
op_assign
(paren
r_struct
id|device
op_star
)paren
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|device
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dev
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|memset
c_func
(paren
id|dev
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|device
)paren
)paren
suffix:semicolon
id|dev-&gt;name
op_assign
(paren
r_char
op_star
)paren
id|kmalloc
c_func
(paren
l_int|9
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dev-&gt;name
)paren
(brace
id|kfree
c_func
(paren
id|dev
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|dev-&gt;init
op_assign
id|arc20020_probe
suffix:semicolon
r_if
c_cond
(paren
id|device
)paren
id|strcpy
c_func
(paren
id|dev-&gt;name
comma
id|device
)paren
suffix:semicolon
r_else
id|arcnet_makename
c_func
(paren
id|dev-&gt;name
)paren
suffix:semicolon
r_if
c_cond
(paren
id|node
op_logical_and
id|node
op_ne
l_int|0xff
)paren
id|dev-&gt;dev_addr
(braket
l_int|0
)braket
op_assign
id|node
suffix:semicolon
r_if
c_cond
(paren
id|backplane
)paren
id|dev-&gt;dev_addr
(braket
l_int|1
)braket
op_assign
id|backplane
ques
c_cond
l_int|1
suffix:colon
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|clock
)paren
id|dev-&gt;dev_addr
(braket
l_int|2
)braket
op_assign
id|clock
op_amp
l_int|7
suffix:semicolon
id|dev-&gt;dev_addr
(braket
l_int|3
)braket
op_assign
id|timeout
op_amp
l_int|3
suffix:semicolon
id|dev-&gt;base_addr
op_assign
id|io
suffix:semicolon
id|dev-&gt;irq
op_assign
id|irq
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;irq
op_eq
l_int|2
)paren
id|dev-&gt;irq
op_assign
l_int|9
suffix:semicolon
r_if
c_cond
(paren
id|register_netdev
c_func
(paren
id|dev
)paren
op_ne
l_int|0
)paren
r_return
op_minus
id|EIO
suffix:semicolon
multiline_comment|/* Increase use count of arcnet.o */
id|arcnet_use_count
c_func
(paren
l_int|1
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|cleanup_module
r_void
id|cleanup_module
c_func
(paren
r_void
)paren
(brace
r_struct
id|device
op_star
id|dev
op_assign
id|cards
(braket
l_int|0
)braket
suffix:semicolon
r_int
id|ioaddr
op_assign
id|dev-&gt;base_addr
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;start
)paren
(paren
op_star
id|dev-&gt;stop
)paren
(paren
id|dev
)paren
suffix:semicolon
multiline_comment|/* Flush TX and disable RX */
r_if
c_cond
(paren
id|ioaddr
)paren
(brace
id|AINTMASK
c_func
(paren
l_int|0
)paren
suffix:semicolon
multiline_comment|/* disable IRQ&squot;s */
id|ACOMMAND
c_func
(paren
id|NOTXcmd
)paren
suffix:semicolon
multiline_comment|/* stop transmit */
id|ACOMMAND
c_func
(paren
id|NORXcmd
)paren
suffix:semicolon
multiline_comment|/* disable receive */
)brace
r_if
c_cond
(paren
id|dev-&gt;irq
)paren
(brace
id|free_irq
c_func
(paren
id|dev-&gt;irq
comma
id|dev
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|dev-&gt;base_addr
)paren
id|release_region
c_func
(paren
id|dev-&gt;base_addr
comma
id|ARCNET_TOTAL_SIZE
)paren
suffix:semicolon
id|unregister_netdev
c_func
(paren
id|dev
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|dev-&gt;priv
)paren
suffix:semicolon
id|dev-&gt;priv
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/* Decrease use count of arcnet.o */
id|arcnet_use_count
c_func
(paren
l_int|0
)paren
suffix:semicolon
)brace
macro_line|#else
DECL|function|__initfunc
id|__initfunc
c_func
(paren
r_void
id|com20020_setup
(paren
r_char
op_star
id|str
comma
r_int
op_star
id|ints
)paren
)paren
(brace
r_struct
id|device
op_star
id|dev
suffix:semicolon
r_if
c_cond
(paren
id|arcnet_num_devs
op_eq
id|MAX_ARCNET_DEVS
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;com20020: Too many ARCnet devices registered (max %d).&bslash;n&quot;
comma
id|MAX_ARCNET_DEVS
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|dev
op_assign
op_amp
id|arcnet_devs
(braket
id|arcnet_num_devs
)braket
suffix:semicolon
r_if
c_cond
(paren
id|ints
(braket
l_int|0
)braket
OL
l_int|1
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;com20020: You must give an IO address.&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|dev-&gt;dev_addr
(braket
l_int|3
)braket
op_assign
l_int|3
suffix:semicolon
id|dev-&gt;init
op_assign
id|arc20020_probe
suffix:semicolon
r_switch
c_cond
(paren
id|ints
(braket
l_int|0
)braket
)paren
(brace
r_case
l_int|7
suffix:colon
multiline_comment|/* ERROR */
id|printk
c_func
(paren
l_string|&quot;com20020: Too many arguments.&bslash;n&quot;
)paren
suffix:semicolon
r_case
l_int|6
suffix:colon
multiline_comment|/* Timeout */
id|dev-&gt;dev_addr
(braket
l_int|3
)braket
op_assign
(paren
id|u_char
)paren
id|ints
(braket
l_int|6
)braket
suffix:semicolon
r_case
l_int|5
suffix:colon
multiline_comment|/* CKP value */
id|dev-&gt;dev_addr
(braket
l_int|2
)braket
op_assign
(paren
id|u_char
)paren
id|ints
(braket
l_int|5
)braket
suffix:semicolon
r_case
l_int|4
suffix:colon
multiline_comment|/* Backplane flag */
id|dev-&gt;dev_addr
(braket
l_int|1
)braket
op_assign
(paren
id|u_char
)paren
id|ints
(braket
l_int|4
)braket
suffix:semicolon
r_case
l_int|3
suffix:colon
multiline_comment|/* Node ID */
id|dev-&gt;dev_addr
(braket
l_int|0
)braket
op_assign
(paren
id|u_char
)paren
id|ints
(braket
l_int|3
)braket
suffix:semicolon
r_case
l_int|2
suffix:colon
multiline_comment|/* IRQ */
id|dev-&gt;irq
op_assign
id|ints
(braket
l_int|2
)braket
suffix:semicolon
r_case
l_int|1
suffix:colon
multiline_comment|/* IO address */
id|dev-&gt;base_addr
op_assign
id|ints
(braket
l_int|1
)braket
suffix:semicolon
)brace
id|dev-&gt;name
op_assign
(paren
r_char
op_star
)paren
op_amp
id|arcnet_dev_names
(braket
id|arcnet_num_devs
)braket
suffix:semicolon
r_if
c_cond
(paren
id|str
)paren
id|strncpy
c_func
(paren
id|dev-&gt;name
comma
id|str
comma
l_int|9
)paren
suffix:semicolon
id|arcnet_num_devs
op_increment
suffix:semicolon
)brace
macro_line|#endif /* MODULE */
eof
