multiline_comment|/*&n; *&t;ipddp.c: IP-over-DDP driver for Linux&n; *&n; *&t;Authors:&n; *      - Original code by: Bradford W. Johnson &lt;johns393@maroon.tc.umn.edu&gt;&n; *&t;- Moved to driver by: Jay Schulist &lt;Jay.Schulist@spacs.k12.wi.us&gt;&n; *&n; *&t;Derived from:&n; *&t;- Almost all code already existed in net/appletalk/ddp.c I just&n; *&t;  moved/reorginized it into a driver file. Original IP-over-DDP code&n; *&t;  was done by Bradford W. Johnson &lt;johns393@maroon.tc.umn.edu&gt;&n; *      - skeleton.c: A network driver outline for linux.&n; *        Written 1993-94 by Donald Becker.&n; *&t;- dummy.c: A dummy net driver. By Nick Holloway.&n; *&n; *      Copyright 1993 United States Government as represented by the&n; *      Director, National Security Agency.&n; *&n; *      This software may be used and distributed according to the terms&n; *      of the GNU Public License, incorporated herein by reference.&n; */
DECL|variable|version
r_static
r_const
r_char
op_star
id|version
op_assign
l_string|&quot;ipddp.c:v0.01 8/28/97 Bradford W. Johnson &lt;johns393@maroon.tc.umn.edu&gt;&bslash;n&quot;
suffix:semicolon
macro_line|#include &lt;linux/config.h&gt;
macro_line|#ifdef MODULE
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/version.h&gt;
macro_line|#endif
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/fcntl.h&gt;
macro_line|#include &lt;linux/interrupt.h&gt;
macro_line|#include &lt;linux/ptrace.h&gt;
macro_line|#include &lt;linux/ioport.h&gt;
macro_line|#include &lt;linux/in.h&gt;
macro_line|#include &lt;linux/malloc.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;asm/uaccess.h&gt;
macro_line|#include &lt;asm/system.h&gt;
macro_line|#include &lt;asm/bitops.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/dma.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/netdevice.h&gt;
macro_line|#include &lt;linux/inetdevice.h&gt;
macro_line|#include &lt;linux/etherdevice.h&gt;
macro_line|#include &lt;linux/skbuff.h&gt;
macro_line|#include &lt;linux/if_arp.h&gt;
macro_line|#include &lt;linux/atalk.h&gt;
macro_line|#include &lt;linux/ip.h&gt;
macro_line|#include &lt;net/route.h&gt;
macro_line|#include &quot;ipddp.h&quot;&t;&t;/* Our stuff */
multiline_comment|/*&n; *      The name of the card. Is used for messages and in the requests for&n; *      io regions, irqs and dma channels&n; */
DECL|variable|cardname
r_static
r_const
r_char
op_star
id|cardname
op_assign
l_string|&quot;ipddp&quot;
suffix:semicolon
multiline_comment|/* Use 0 for production, 1 for verification, 2 for debug, 3 for verbose debug */
macro_line|#ifndef IPDDP_DEBUG
DECL|macro|IPDDP_DEBUG
mdefine_line|#define IPDDP_DEBUG 1
macro_line|#endif
DECL|variable|ipddp_debug
r_static
r_int
r_int
id|ipddp_debug
op_assign
id|IPDDP_DEBUG
suffix:semicolon
multiline_comment|/* Index to functions, as function prototypes. */
r_static
r_int
id|ipddp_xmit
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_struct
id|net_device_stats
op_star
id|ipddp_get_stats
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_int
id|ipddp_rebuild_header
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
)paren
suffix:semicolon
r_static
r_int
id|ipddp_header
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|device
op_star
id|dev
comma
r_int
r_int
id|type
comma
r_void
op_star
id|daddr
comma
r_void
op_star
id|saddr
comma
r_int
id|len
)paren
suffix:semicolon
r_static
r_int
id|ipddp_ioctl
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
r_struct
id|ifreq
op_star
id|ifr
comma
r_int
id|cmd
)paren
suffix:semicolon
DECL|function|ipddp_open
r_static
r_int
id|ipddp_open
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
macro_line|#ifdef MODULE
id|MOD_INC_USE_COUNT
suffix:semicolon
macro_line|#endif
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|ipddp_close
r_static
r_int
id|ipddp_close
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
macro_line|#ifdef MODULE
id|MOD_DEC_USE_COUNT
suffix:semicolon
macro_line|#endif
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|ipddp_init
r_int
id|ipddp_init
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
r_static
r_int
id|version_printed
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|ipddp_debug
op_logical_and
id|version_printed
op_increment
op_eq
l_int|0
)paren
id|printk
c_func
(paren
l_string|&quot;%s&quot;
comma
id|version
)paren
suffix:semicolon
multiline_comment|/* Initalize the device structure. */
id|dev-&gt;hard_start_xmit
op_assign
id|ipddp_xmit
suffix:semicolon
id|dev-&gt;priv
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|enet_statistics
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dev-&gt;priv
)paren
(brace
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|memset
c_func
(paren
id|dev-&gt;priv
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|enet_statistics
)paren
)paren
suffix:semicolon
id|dev-&gt;open
op_assign
id|ipddp_open
suffix:semicolon
id|dev-&gt;stop
op_assign
id|ipddp_close
suffix:semicolon
id|dev-&gt;get_stats
op_assign
id|ipddp_get_stats
suffix:semicolon
id|dev-&gt;do_ioctl
op_assign
id|ipddp_ioctl
suffix:semicolon
id|dev-&gt;hard_header
op_assign
id|ipddp_header
suffix:semicolon
multiline_comment|/* see ip_output.c */
id|dev-&gt;rebuild_header
op_assign
id|ipddp_rebuild_header
suffix:semicolon
id|dev-&gt;type
op_assign
id|ARPHRD_IPDDP
suffix:semicolon
multiline_comment|/* IP over DDP tunnel */
id|dev-&gt;mtu
op_assign
l_int|585
suffix:semicolon
id|dev-&gt;flags
op_or_assign
id|IFF_NOARP
suffix:semicolon
multiline_comment|/*&n;         *      The worst case header we will need is currently a&n;         *      ethernet header (14 bytes) and a ddp header (sizeof ddpehdr+1)&n;         *      We send over SNAP so that takes another 8 bytes.&n;         */
id|dev-&gt;hard_header_len
op_assign
l_int|14
op_plus
l_int|8
op_plus
r_sizeof
(paren
r_struct
id|ddpehdr
)paren
op_plus
l_int|1
suffix:semicolon
multiline_comment|/* Fill in the device structure with ethernet-generic values. */
id|ether_setup
c_func
(paren
id|dev
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * Transmit LLAP/ELAP frame using aarp_send_ddp.&n; */
DECL|function|ipddp_xmit
r_static
r_int
id|ipddp_xmit
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|device
op_star
id|dev
)paren
(brace
multiline_comment|/* Retrieve the saved address hint */
r_struct
id|at_addr
op_star
id|a
op_assign
(paren
r_struct
id|at_addr
op_star
)paren
id|skb-&gt;data
suffix:semicolon
id|skb_pull
c_func
(paren
id|skb
comma
l_int|4
)paren
suffix:semicolon
(paren
(paren
r_struct
id|net_device_stats
op_star
)paren
id|dev-&gt;priv
)paren
op_member_access_from_pointer
id|tx_packets
op_increment
suffix:semicolon
(paren
(paren
r_struct
id|net_device_stats
op_star
)paren
id|dev-&gt;priv
)paren
op_member_access_from_pointer
id|tx_bytes
op_add_assign
id|skb-&gt;len
suffix:semicolon
r_if
c_cond
(paren
id|ipddp_debug
OG
l_int|1
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;ipddp_xmit: Headroom %d&bslash;n&quot;
comma
id|skb_headroom
c_func
(paren
id|skb
)paren
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|aarp_send_ddp
c_func
(paren
id|skb-&gt;dev
comma
id|skb
comma
id|a
comma
l_int|NULL
)paren
OL
l_int|0
)paren
(brace
id|dev_kfree_skb
c_func
(paren
id|skb
comma
id|FREE_WRITE
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * Get the current statistics. This may be called with the card open or closed.&n; */
DECL|function|ipddp_get_stats
r_static
r_struct
id|net_device_stats
op_star
id|ipddp_get_stats
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
r_return
(paren
r_struct
id|net_device_stats
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
)brace
multiline_comment|/*&n; * Now the packet really wants to go out.&n; */
DECL|function|ipddp_rebuild_header
r_static
r_int
id|ipddp_rebuild_header
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
)paren
(brace
id|u32
id|paddr
op_assign
(paren
(paren
r_struct
id|rtable
op_star
)paren
id|skb-&gt;dst
)paren
op_member_access_from_pointer
id|rt_gateway
suffix:semicolon
r_struct
id|ddpehdr
op_star
id|ddp
suffix:semicolon
r_struct
id|at_addr
id|at
suffix:semicolon
r_struct
id|ipddp_route
op_star
id|rt
suffix:semicolon
r_struct
id|at_addr
op_star
id|our_addr
suffix:semicolon
multiline_comment|/*&n;         * On entry skb-&gt;data points to the ddpehdr we reserved earlier.&n;         * skb-&gt;h.raw will be the higher level header.&n;         */
multiline_comment|/*&n;         * We created this earlier.&n;         */
id|ddp
op_assign
(paren
r_struct
id|ddpehdr
op_star
)paren
(paren
id|skb-&gt;data
op_plus
l_int|4
)paren
suffix:semicolon
multiline_comment|/* find appropriate route */
r_for
c_loop
(paren
id|rt
op_assign
id|ipddp_route_head
suffix:semicolon
id|rt
suffix:semicolon
id|rt
op_assign
id|rt-&gt;next
)paren
(brace
r_if
c_cond
(paren
id|rt-&gt;ip
op_eq
id|paddr
)paren
(brace
r_break
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
op_logical_neg
id|rt
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;ipddp unreachable dst %08lx&bslash;n&quot;
comma
id|ntohl
c_func
(paren
id|paddr
)paren
)paren
suffix:semicolon
r_return
op_minus
id|ENETUNREACH
suffix:semicolon
)brace
id|our_addr
op_assign
id|atalk_find_dev_addr
c_func
(paren
id|rt-&gt;dev
)paren
suffix:semicolon
multiline_comment|/* fill in ddpehdr */
id|ddp-&gt;deh_len
op_assign
id|skb-&gt;len
suffix:semicolon
id|ddp-&gt;deh_hops
op_assign
l_int|1
suffix:semicolon
id|ddp-&gt;deh_pad
op_assign
l_int|0
suffix:semicolon
id|ddp-&gt;deh_sum
op_assign
l_int|0
suffix:semicolon
id|ddp-&gt;deh_dnet
op_assign
id|rt-&gt;at.s_net
suffix:semicolon
multiline_comment|/* FIXME more hops?? */
id|ddp-&gt;deh_snet
op_assign
id|our_addr-&gt;s_net
suffix:semicolon
id|ddp-&gt;deh_dnode
op_assign
id|rt-&gt;at.s_node
suffix:semicolon
id|ddp-&gt;deh_snode
op_assign
id|our_addr-&gt;s_node
suffix:semicolon
id|ddp-&gt;deh_dport
op_assign
l_int|72
suffix:semicolon
id|ddp-&gt;deh_sport
op_assign
l_int|72
suffix:semicolon
op_star
(paren
(paren
id|__u8
op_star
)paren
(paren
id|ddp
op_plus
l_int|1
)paren
)paren
op_assign
l_int|22
suffix:semicolon
multiline_comment|/* ddp type = IP */
multiline_comment|/* fix up length field */
op_star
(paren
(paren
id|__u16
op_star
)paren
id|ddp
)paren
op_assign
id|ntohs
c_func
(paren
op_star
(paren
(paren
id|__u16
op_star
)paren
id|ddp
)paren
)paren
suffix:semicolon
multiline_comment|/* set skb-&gt;dev to appropriate device */
id|skb-&gt;dev
op_assign
id|rt-&gt;dev
suffix:semicolon
multiline_comment|/* skb-&gt;raddr = (unsigned long) at */
id|at
op_assign
id|rt-&gt;at
suffix:semicolon
multiline_comment|/* Hide it at the start of the buffer */
id|memcpy
c_func
(paren
id|skb-&gt;data
comma
(paren
r_void
op_star
)paren
op_amp
id|at
comma
r_sizeof
(paren
id|at
)paren
)paren
suffix:semicolon
id|skb-&gt;arp
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* so the actual device doesn&squot;t try to arp it... */
id|skb-&gt;protocol
op_assign
id|htons
c_func
(paren
id|ETH_P_ATALK
)paren
suffix:semicolon
multiline_comment|/* Protocol has changed */
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|ipddp_header
r_static
r_int
id|ipddp_header
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|device
op_star
id|dev
comma
r_int
r_int
id|type
comma
r_void
op_star
id|daddr
comma
r_void
op_star
id|saddr
comma
r_int
id|len
)paren
(brace
r_if
c_cond
(paren
id|ipddp_debug
op_ge
l_int|2
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%s: ipddp_header&bslash;n&quot;
comma
id|cardname
)paren
suffix:semicolon
)brace
multiline_comment|/* Push down the header space and the type byte */
id|skb_push
c_func
(paren
id|skb
comma
r_sizeof
(paren
r_struct
id|ddpehdr
)paren
op_plus
l_int|1
op_plus
l_int|4
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|ipddp_ioctl
r_static
r_int
id|ipddp_ioctl
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
r_struct
id|ifreq
op_star
id|ifr
comma
r_int
id|cmd
)paren
(brace
r_struct
id|ipddp_route
op_star
id|urt
op_assign
(paren
r_struct
id|ipddp_route
op_star
)paren
id|ifr-&gt;ifr_data
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|suser
c_func
(paren
)paren
)paren
(brace
r_return
op_minus
id|EPERM
suffix:semicolon
)brace
multiline_comment|/* for now we only have one route at a time */
r_switch
c_cond
(paren
id|cmd
)paren
(brace
r_case
id|SIOCADDIPDDPRT
suffix:colon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|ipddp_route_test
comma
id|urt
comma
r_sizeof
(paren
r_struct
id|ipddp_route
)paren
)paren
)paren
(brace
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
id|ipddp_route_test.dev
op_assign
id|atrtr_get_dev
c_func
(paren
op_amp
id|ipddp_route_test.at
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dev
op_eq
l_int|NULL
)paren
r_return
op_minus
id|ENETUNREACH
suffix:semicolon
id|ipddp_route_test.next
op_assign
l_int|NULL
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;%s: Added route through %s&bslash;n&quot;
comma
id|ipddp_route_test.dev-&gt;name
comma
id|cardname
)paren
suffix:semicolon
id|ipddp_route_head
op_assign
op_amp
id|ipddp_route_test
suffix:semicolon
r_return
l_int|0
suffix:semicolon
r_case
id|SIOCFINDIPDDPRT
suffix:colon
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
id|urt
comma
op_amp
id|ipddp_route_test
comma
r_sizeof
(paren
r_struct
id|ipddp_route
)paren
)paren
)paren
(brace
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
r_case
id|SIOCDELIPDDPRT
suffix:colon
id|ipddp_route_test.dev
op_assign
l_int|NULL
suffix:semicolon
id|ipddp_route_head
op_assign
l_int|NULL
suffix:semicolon
r_return
l_int|0
suffix:semicolon
r_default
suffix:colon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
)brace
macro_line|#ifdef MODULE&t;/* Module specific functions for ipddp.c */
DECL|variable|dev_ipddp
r_static
r_struct
id|device
id|dev_ipddp
op_assign
(brace
l_string|&quot;ipddp0&bslash;0   &quot;
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0x0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|NULL
comma
id|ipddp_init
)brace
suffix:semicolon
DECL|function|init_module
r_int
id|init_module
c_func
(paren
r_void
)paren
(brace
r_if
c_cond
(paren
id|register_netdev
c_func
(paren
op_amp
id|dev_ipddp
)paren
op_ne
l_int|0
)paren
r_return
op_minus
id|EIO
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|cleanup_module
r_void
id|cleanup_module
c_func
(paren
r_void
)paren
(brace
id|unregister_netdev
c_func
(paren
op_amp
id|dev_ipddp
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|dev_ipddp.priv
)paren
suffix:semicolon
id|dev_ipddp.priv
op_assign
l_int|NULL
suffix:semicolon
)brace
macro_line|#endif /* MODULE */
eof
