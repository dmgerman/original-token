multiline_comment|/*&n; * Amiga Linux/68k A2065 Ethernet Driver&n; *&n; * (C) Copyright 1995 by Geert Uytterhoeven &lt;geert@linux-m68k.org&gt;&n; *&n; * Fixes and tips by:&n; *&t;- Janos Farkas (CHEXUM@sparta.banki.hu)&n; *&t;- Jes Degn Soerensen (jds@kom.auc.dk)&n; *&n; * ----------------------------------------------------------------------------&n; *&n; * This program is based on&n; *&n; *&t;ariadne.?:&t;Amiga Linux/68k Ariadne Ethernet Driver&n; *&t;&t;&t;(C) Copyright 1995 by Geert Uytterhoeven,&n; *                                            Peter De Schrijver&n; *&n; *&t;lance.c:&t;An AMD LANCE ethernet driver for linux.&n; *&t;&t;&t;Written 1993-94 by Donald Becker.&n; *&n; *&t;Am79C960:&t;PCnet(tm)-ISA Single-Chip Ethernet Controller&n; *&t;&t;&t;Advanced Micro Devices&n; *&t;&t;&t;Publication #16907, Rev. B, Amendment/0, May 1994&n; *&n; * ----------------------------------------------------------------------------&n; *&n; * This file is subject to the terms and conditions of the GNU General Public&n; * License.  See the file COPYING in the main directory of the Linux&n; * distribution for more details.&n; *&n; * ----------------------------------------------------------------------------&n; *&n; * The A2065 is a Zorro-II board made by Commodore/Ameristar. It contains:&n; *&n; *&t;- an Am7990 Local Area Network Controller for Ethernet (LANCE) with&n; *&t;  both 10BASE-2 (thin coax) and AUI (DB-15) connectors&n; */
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/stddef.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/interrupt.h&gt;
macro_line|#include &lt;linux/ptrace.h&gt;
macro_line|#include &lt;linux/ioport.h&gt;
macro_line|#include &lt;linux/malloc.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;asm/bitops.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/irq.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;asm/amigaints.h&gt;
macro_line|#include &lt;asm/amigahw.h&gt;
macro_line|#include &lt;linux/zorro.h&gt;
macro_line|#include &lt;linux/netdevice.h&gt;
macro_line|#include &lt;linux/etherdevice.h&gt;
macro_line|#include &lt;linux/skbuff.h&gt;
macro_line|#include &quot;a2065.h&quot;
multiline_comment|/*&n;&t; *&t;&t;Transmit/Receive Ring Definitions&n;&t; */
DECL|macro|LANCE_LOG_TX_BUFFERS
mdefine_line|#define LANCE_LOG_TX_BUFFERS&t;(2)
DECL|macro|LANCE_LOG_RX_BUFFERS
mdefine_line|#define LANCE_LOG_RX_BUFFERS&t;(4)
DECL|macro|TX_RING_SIZE
mdefine_line|#define TX_RING_SIZE&t;&t;(1&lt;&lt;LANCE_LOG_TX_BUFFERS)
DECL|macro|RX_RING_SIZE
mdefine_line|#define RX_RING_SIZE&t;&t;(1&lt;&lt;LANCE_LOG_RX_BUFFERS)
DECL|macro|TX_RING_MOD_MASK
mdefine_line|#define TX_RING_MOD_MASK&t;(TX_RING_SIZE-1)
DECL|macro|RX_RING_MOD_MASK
mdefine_line|#define RX_RING_MOD_MASK&t;(RX_RING_SIZE-1)
DECL|macro|PKT_BUF_SIZE
mdefine_line|#define PKT_BUF_SIZE&t;&t;(1544)
DECL|macro|RX_BUFF_SIZE
mdefine_line|#define RX_BUFF_SIZE            PKT_BUF_SIZE
DECL|macro|TX_BUFF_SIZE
mdefine_line|#define TX_BUFF_SIZE            PKT_BUF_SIZE
multiline_comment|/*&n;&t; *&t;&t;Layout of the Lance&squot;s RAM Buffer&n;&t; */
DECL|struct|lance_init_block
r_struct
id|lance_init_block
(brace
DECL|member|mode
r_int
r_int
id|mode
suffix:semicolon
multiline_comment|/* Pre-set mode (reg. 15) */
DECL|member|phys_addr
r_int
r_char
id|phys_addr
(braket
l_int|6
)braket
suffix:semicolon
multiline_comment|/* Physical ethernet address */
DECL|member|filter
r_int
id|filter
(braket
l_int|2
)braket
suffix:semicolon
multiline_comment|/* Multicast filter. */
multiline_comment|/* Receive and transmit ring base, along with extra bits. */
DECL|member|rx_ptr
r_int
r_int
id|rx_ptr
suffix:semicolon
multiline_comment|/* receive descriptor addr */
DECL|member|rx_len
r_int
r_int
id|rx_len
suffix:semicolon
multiline_comment|/* receive len and high addr */
DECL|member|tx_ptr
r_int
r_int
id|tx_ptr
suffix:semicolon
multiline_comment|/* transmit descriptor addr */
DECL|member|tx_len
r_int
r_int
id|tx_len
suffix:semicolon
multiline_comment|/* transmit len and high addr */
multiline_comment|/* The Tx and Rx ring entries must aligned on 8-byte boundaries. */
DECL|member|brx_ring
r_struct
id|lance_rx_desc
id|brx_ring
(braket
id|RX_RING_SIZE
)braket
suffix:semicolon
DECL|member|btx_ring
r_struct
id|lance_tx_desc
id|btx_ring
(braket
id|TX_RING_SIZE
)braket
suffix:semicolon
DECL|member|rx_buf
r_char
id|rx_buf
(braket
id|RX_RING_SIZE
)braket
(braket
id|RX_BUFF_SIZE
)braket
suffix:semicolon
DECL|member|tx_buf
r_char
id|tx_buf
(braket
id|TX_RING_SIZE
)braket
(braket
id|TX_BUFF_SIZE
)braket
suffix:semicolon
)brace
suffix:semicolon
multiline_comment|/*&n;&t; *&t;&t;Private Device Data&n;&t; */
DECL|struct|lance_private
r_struct
id|lance_private
(brace
DECL|member|name
r_char
op_star
id|name
suffix:semicolon
DECL|member|ll
r_volatile
r_struct
id|lance_regs
op_star
id|ll
suffix:semicolon
DECL|member|init_block
r_volatile
r_struct
id|lance_init_block
op_star
id|init_block
suffix:semicolon
multiline_comment|/* Hosts view */
DECL|member|lance_init_block
r_volatile
r_struct
id|lance_init_block
op_star
id|lance_init_block
suffix:semicolon
multiline_comment|/* Lance view */
DECL|member|rx_new
DECL|member|tx_new
r_int
id|rx_new
comma
id|tx_new
suffix:semicolon
DECL|member|rx_old
DECL|member|tx_old
r_int
id|rx_old
comma
id|tx_old
suffix:semicolon
DECL|member|lance_log_rx_bufs
DECL|member|lance_log_tx_bufs
r_int
id|lance_log_rx_bufs
comma
id|lance_log_tx_bufs
suffix:semicolon
DECL|member|rx_ring_mod_mask
DECL|member|tx_ring_mod_mask
r_int
id|rx_ring_mod_mask
comma
id|tx_ring_mod_mask
suffix:semicolon
DECL|member|stats
r_struct
id|net_device_stats
id|stats
suffix:semicolon
DECL|member|tpe
r_int
id|tpe
suffix:semicolon
multiline_comment|/* cable-selection is TPE */
DECL|member|auto_select
r_int
id|auto_select
suffix:semicolon
multiline_comment|/* cable-selection by carrier */
DECL|member|busmaster_regval
r_int
r_int
id|busmaster_regval
suffix:semicolon
macro_line|#ifdef CONFIG_SUNLANCE
DECL|member|ledma
r_struct
id|Linux_SBus_DMA
op_star
id|ledma
suffix:semicolon
multiline_comment|/* if set this points to ledma and arch=4m */
DECL|member|burst_sizes
r_int
id|burst_sizes
suffix:semicolon
multiline_comment|/* ledma SBus burst sizes */
macro_line|#endif
DECL|member|multicast_timer
r_struct
id|timer_list
id|multicast_timer
suffix:semicolon
DECL|member|dev
r_struct
id|net_device
op_star
id|dev
suffix:semicolon
multiline_comment|/* Backpointer */
DECL|member|next_module
r_struct
id|lance_private
op_star
id|next_module
suffix:semicolon
)brace
suffix:semicolon
macro_line|#ifdef MODULE
DECL|variable|root_a2065_dev
r_static
r_struct
id|lance_private
op_star
id|root_a2065_dev
op_assign
l_int|NULL
suffix:semicolon
macro_line|#endif
DECL|macro|TX_BUFFS_AVAIL
mdefine_line|#define TX_BUFFS_AVAIL ((lp-&gt;tx_old&lt;=lp-&gt;tx_new)?&bslash;&n;&t;&t;&t;lp-&gt;tx_old+lp-&gt;tx_ring_mod_mask-lp-&gt;tx_new:&bslash;&n;&t;&t;&t;lp-&gt;tx_old - lp-&gt;tx_new-1)
DECL|macro|LANCE_ADDR
mdefine_line|#define LANCE_ADDR(x) ((int)(x) &amp; ~0xff000000)
multiline_comment|/* Load the CSR registers */
DECL|function|load_csrs
r_static
r_void
id|load_csrs
(paren
r_struct
id|lance_private
op_star
id|lp
)paren
(brace
r_volatile
r_struct
id|lance_regs
op_star
id|ll
op_assign
id|lp-&gt;ll
suffix:semicolon
r_volatile
r_struct
id|lance_init_block
op_star
id|aib
op_assign
id|lp-&gt;lance_init_block
suffix:semicolon
r_int
id|leptr
suffix:semicolon
id|leptr
op_assign
id|LANCE_ADDR
(paren
id|aib
)paren
suffix:semicolon
id|ll-&gt;rap
op_assign
id|LE_CSR1
suffix:semicolon
id|ll-&gt;rdp
op_assign
(paren
id|leptr
op_amp
l_int|0xFFFF
)paren
suffix:semicolon
id|ll-&gt;rap
op_assign
id|LE_CSR2
suffix:semicolon
id|ll-&gt;rdp
op_assign
id|leptr
op_rshift
l_int|16
suffix:semicolon
id|ll-&gt;rap
op_assign
id|LE_CSR3
suffix:semicolon
id|ll-&gt;rdp
op_assign
id|lp-&gt;busmaster_regval
suffix:semicolon
multiline_comment|/* Point back to csr0 */
id|ll-&gt;rap
op_assign
id|LE_CSR0
suffix:semicolon
)brace
DECL|macro|ZERO
mdefine_line|#define ZERO 0
multiline_comment|/* Setup the Lance Rx and Tx rings */
DECL|function|lance_init_ring
r_static
r_void
id|lance_init_ring
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|lance_private
op_star
id|lp
op_assign
(paren
r_struct
id|lance_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_volatile
r_struct
id|lance_init_block
op_star
id|ib
op_assign
id|lp-&gt;init_block
suffix:semicolon
r_volatile
r_struct
id|lance_init_block
op_star
id|aib
suffix:semicolon
multiline_comment|/* for LANCE_ADDR computations */
r_int
id|leptr
suffix:semicolon
r_int
id|i
suffix:semicolon
id|aib
op_assign
id|lp-&gt;lance_init_block
suffix:semicolon
multiline_comment|/* Lock out other processes while setting up hardware */
id|netif_stop_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
id|lp-&gt;rx_new
op_assign
id|lp-&gt;tx_new
op_assign
l_int|0
suffix:semicolon
id|lp-&gt;rx_old
op_assign
id|lp-&gt;tx_old
op_assign
l_int|0
suffix:semicolon
id|ib-&gt;mode
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Copy the ethernet address to the lance init block&n;&t; * Note that on the sparc you need to swap the ethernet address.&n;&t; */
id|ib-&gt;phys_addr
(braket
l_int|0
)braket
op_assign
id|dev-&gt;dev_addr
(braket
l_int|1
)braket
suffix:semicolon
id|ib-&gt;phys_addr
(braket
l_int|1
)braket
op_assign
id|dev-&gt;dev_addr
(braket
l_int|0
)braket
suffix:semicolon
id|ib-&gt;phys_addr
(braket
l_int|2
)braket
op_assign
id|dev-&gt;dev_addr
(braket
l_int|3
)braket
suffix:semicolon
id|ib-&gt;phys_addr
(braket
l_int|3
)braket
op_assign
id|dev-&gt;dev_addr
(braket
l_int|2
)braket
suffix:semicolon
id|ib-&gt;phys_addr
(braket
l_int|4
)braket
op_assign
id|dev-&gt;dev_addr
(braket
l_int|5
)braket
suffix:semicolon
id|ib-&gt;phys_addr
(braket
l_int|5
)braket
op_assign
id|dev-&gt;dev_addr
(braket
l_int|4
)braket
suffix:semicolon
r_if
c_cond
(paren
id|ZERO
)paren
id|printk
(paren
l_string|&quot;TX rings:&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* Setup the Tx ring entries */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
op_le
(paren
l_int|1
op_lshift
id|lp-&gt;lance_log_tx_bufs
)paren
suffix:semicolon
id|i
op_increment
)paren
(brace
id|leptr
op_assign
id|LANCE_ADDR
c_func
(paren
op_amp
id|aib-&gt;tx_buf
(braket
id|i
)braket
(braket
l_int|0
)braket
)paren
suffix:semicolon
id|ib-&gt;btx_ring
(braket
id|i
)braket
dot
id|tmd0
op_assign
id|leptr
suffix:semicolon
id|ib-&gt;btx_ring
(braket
id|i
)braket
dot
id|tmd1_hadr
op_assign
id|leptr
op_rshift
l_int|16
suffix:semicolon
id|ib-&gt;btx_ring
(braket
id|i
)braket
dot
id|tmd1_bits
op_assign
l_int|0
suffix:semicolon
id|ib-&gt;btx_ring
(braket
id|i
)braket
dot
id|length
op_assign
l_int|0xf000
suffix:semicolon
multiline_comment|/* The ones required by tmd2 */
id|ib-&gt;btx_ring
(braket
id|i
)braket
dot
id|misc
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|i
OL
l_int|3
)paren
r_if
c_cond
(paren
id|ZERO
)paren
id|printk
(paren
l_string|&quot;%d: 0x%8.8x&bslash;n&quot;
comma
id|i
comma
id|leptr
)paren
suffix:semicolon
)brace
multiline_comment|/* Setup the Rx ring entries */
r_if
c_cond
(paren
id|ZERO
)paren
id|printk
(paren
l_string|&quot;RX rings:&bslash;n&quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
(paren
l_int|1
op_lshift
id|lp-&gt;lance_log_rx_bufs
)paren
suffix:semicolon
id|i
op_increment
)paren
(brace
id|leptr
op_assign
id|LANCE_ADDR
c_func
(paren
op_amp
id|aib-&gt;rx_buf
(braket
id|i
)braket
(braket
l_int|0
)braket
)paren
suffix:semicolon
id|ib-&gt;brx_ring
(braket
id|i
)braket
dot
id|rmd0
op_assign
id|leptr
suffix:semicolon
id|ib-&gt;brx_ring
(braket
id|i
)braket
dot
id|rmd1_hadr
op_assign
id|leptr
op_rshift
l_int|16
suffix:semicolon
id|ib-&gt;brx_ring
(braket
id|i
)braket
dot
id|rmd1_bits
op_assign
id|LE_R1_OWN
suffix:semicolon
id|ib-&gt;brx_ring
(braket
id|i
)braket
dot
id|length
op_assign
op_minus
id|RX_BUFF_SIZE
op_or
l_int|0xf000
suffix:semicolon
id|ib-&gt;brx_ring
(braket
id|i
)braket
dot
id|mblength
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|i
OL
l_int|3
op_logical_and
id|ZERO
)paren
id|printk
(paren
l_string|&quot;%d: 0x%8.8x&bslash;n&quot;
comma
id|i
comma
id|leptr
)paren
suffix:semicolon
)brace
multiline_comment|/* Setup the initialization block */
multiline_comment|/* Setup rx descriptor pointer */
id|leptr
op_assign
id|LANCE_ADDR
c_func
(paren
op_amp
id|aib-&gt;brx_ring
)paren
suffix:semicolon
id|ib-&gt;rx_len
op_assign
(paren
id|lp-&gt;lance_log_rx_bufs
op_lshift
l_int|13
)paren
op_or
(paren
id|leptr
op_rshift
l_int|16
)paren
suffix:semicolon
id|ib-&gt;rx_ptr
op_assign
id|leptr
suffix:semicolon
r_if
c_cond
(paren
id|ZERO
)paren
id|printk
(paren
l_string|&quot;RX ptr: %8.8x&bslash;n&quot;
comma
id|leptr
)paren
suffix:semicolon
multiline_comment|/* Setup tx descriptor pointer */
id|leptr
op_assign
id|LANCE_ADDR
c_func
(paren
op_amp
id|aib-&gt;btx_ring
)paren
suffix:semicolon
id|ib-&gt;tx_len
op_assign
(paren
id|lp-&gt;lance_log_tx_bufs
op_lshift
l_int|13
)paren
op_or
(paren
id|leptr
op_rshift
l_int|16
)paren
suffix:semicolon
id|ib-&gt;tx_ptr
op_assign
id|leptr
suffix:semicolon
r_if
c_cond
(paren
id|ZERO
)paren
id|printk
(paren
l_string|&quot;TX ptr: %8.8x&bslash;n&quot;
comma
id|leptr
)paren
suffix:semicolon
multiline_comment|/* Clear the multicast filter */
id|ib-&gt;filter
(braket
l_int|0
)braket
op_assign
l_int|0
suffix:semicolon
id|ib-&gt;filter
(braket
l_int|1
)braket
op_assign
l_int|0
suffix:semicolon
)brace
DECL|function|init_restart_lance
r_static
r_int
id|init_restart_lance
(paren
r_struct
id|lance_private
op_star
id|lp
)paren
(brace
r_volatile
r_struct
id|lance_regs
op_star
id|ll
op_assign
id|lp-&gt;ll
suffix:semicolon
r_int
id|i
suffix:semicolon
id|ll-&gt;rap
op_assign
id|LE_CSR0
suffix:semicolon
id|ll-&gt;rdp
op_assign
id|LE_C0_INIT
suffix:semicolon
multiline_comment|/* Wait for the lance to complete initialization */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
(paren
id|i
OL
l_int|100
)paren
op_logical_and
op_logical_neg
(paren
id|ll-&gt;rdp
op_amp
(paren
id|LE_C0_ERR
op_or
id|LE_C0_IDON
)paren
)paren
suffix:semicolon
id|i
op_increment
)paren
id|barrier
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|i
op_eq
l_int|100
)paren
op_logical_or
(paren
id|ll-&gt;rdp
op_amp
id|LE_C0_ERR
)paren
)paren
(brace
id|printk
(paren
l_string|&quot;LANCE unopened after %d ticks, csr0=%4.4x.&bslash;n&quot;
comma
id|i
comma
id|ll-&gt;rdp
)paren
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
multiline_comment|/* Clear IDON by writing a &quot;1&quot;, enable interrupts and start lance */
id|ll-&gt;rdp
op_assign
id|LE_C0_IDON
suffix:semicolon
id|ll-&gt;rdp
op_assign
id|LE_C0_INEA
op_or
id|LE_C0_STRT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|lance_rx
r_static
r_int
id|lance_rx
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|lance_private
op_star
id|lp
op_assign
(paren
r_struct
id|lance_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_volatile
r_struct
id|lance_init_block
op_star
id|ib
op_assign
id|lp-&gt;init_block
suffix:semicolon
r_volatile
r_struct
id|lance_regs
op_star
id|ll
op_assign
id|lp-&gt;ll
suffix:semicolon
r_volatile
r_struct
id|lance_rx_desc
op_star
id|rd
suffix:semicolon
r_int
r_char
id|bits
suffix:semicolon
r_int
id|len
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* XXX shut up gcc warnings */
r_struct
id|sk_buff
op_star
id|skb
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* XXX shut up gcc warnings */
macro_line|#ifdef TEST_HITS
id|printk
(paren
l_string|&quot;[&quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|RX_RING_SIZE
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|i
op_eq
id|lp-&gt;rx_new
)paren
id|printk
(paren
l_string|&quot;%s&quot;
comma
id|ib-&gt;brx_ring
(braket
id|i
)braket
dot
id|rmd1_bits
op_amp
id|LE_R1_OWN
ques
c_cond
l_string|&quot;_&quot;
suffix:colon
l_string|&quot;X&quot;
)paren
suffix:semicolon
r_else
id|printk
(paren
l_string|&quot;%s&quot;
comma
id|ib-&gt;brx_ring
(braket
id|i
)braket
dot
id|rmd1_bits
op_amp
id|LE_R1_OWN
ques
c_cond
l_string|&quot;.&quot;
suffix:colon
l_string|&quot;1&quot;
)paren
suffix:semicolon
)brace
id|printk
(paren
l_string|&quot;]&quot;
)paren
suffix:semicolon
macro_line|#endif
id|ll-&gt;rdp
op_assign
id|LE_C0_RINT
op_or
id|LE_C0_INEA
suffix:semicolon
r_for
c_loop
(paren
id|rd
op_assign
op_amp
id|ib-&gt;brx_ring
(braket
id|lp-&gt;rx_new
)braket
suffix:semicolon
op_logical_neg
(paren
(paren
id|bits
op_assign
id|rd-&gt;rmd1_bits
)paren
op_amp
id|LE_R1_OWN
)paren
suffix:semicolon
id|rd
op_assign
op_amp
id|ib-&gt;brx_ring
(braket
id|lp-&gt;rx_new
)braket
)paren
(brace
multiline_comment|/* We got an incomplete frame? */
r_if
c_cond
(paren
(paren
id|bits
op_amp
id|LE_R1_POK
)paren
op_ne
id|LE_R1_POK
)paren
(brace
id|lp-&gt;stats.rx_over_errors
op_increment
suffix:semicolon
id|lp-&gt;stats.rx_errors
op_increment
suffix:semicolon
r_continue
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|bits
op_amp
id|LE_R1_ERR
)paren
(brace
multiline_comment|/* Count only the end frame as a rx error,&n;&t;&t;&t; * not the beginning&n;&t;&t;&t; */
r_if
c_cond
(paren
id|bits
op_amp
id|LE_R1_BUF
)paren
id|lp-&gt;stats.rx_fifo_errors
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|bits
op_amp
id|LE_R1_CRC
)paren
id|lp-&gt;stats.rx_crc_errors
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|bits
op_amp
id|LE_R1_OFL
)paren
id|lp-&gt;stats.rx_over_errors
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|bits
op_amp
id|LE_R1_FRA
)paren
id|lp-&gt;stats.rx_frame_errors
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|bits
op_amp
id|LE_R1_EOP
)paren
id|lp-&gt;stats.rx_errors
op_increment
suffix:semicolon
)brace
r_else
(brace
id|len
op_assign
(paren
id|rd-&gt;mblength
op_amp
l_int|0xfff
)paren
op_minus
l_int|4
suffix:semicolon
id|skb
op_assign
id|dev_alloc_skb
(paren
id|len
op_plus
l_int|2
)paren
suffix:semicolon
r_if
c_cond
(paren
id|skb
op_eq
l_int|0
)paren
(brace
id|printk
(paren
l_string|&quot;%s: Memory squeeze, deferring packet.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|lp-&gt;stats.rx_dropped
op_increment
suffix:semicolon
id|rd-&gt;mblength
op_assign
l_int|0
suffix:semicolon
id|rd-&gt;rmd1_bits
op_assign
id|LE_R1_OWN
suffix:semicolon
id|lp-&gt;rx_new
op_assign
(paren
id|lp-&gt;rx_new
op_plus
l_int|1
)paren
op_amp
id|lp-&gt;rx_ring_mod_mask
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|skb-&gt;dev
op_assign
id|dev
suffix:semicolon
id|skb_reserve
(paren
id|skb
comma
l_int|2
)paren
suffix:semicolon
multiline_comment|/* 16 byte align */
id|skb_put
(paren
id|skb
comma
id|len
)paren
suffix:semicolon
multiline_comment|/* make room */
id|eth_copy_and_sum
c_func
(paren
id|skb
comma
(paren
r_int
r_char
op_star
)paren
op_amp
(paren
id|ib-&gt;rx_buf
(braket
id|lp-&gt;rx_new
)braket
(braket
l_int|0
)braket
)paren
comma
id|len
comma
l_int|0
)paren
suffix:semicolon
id|skb-&gt;protocol
op_assign
id|eth_type_trans
(paren
id|skb
comma
id|dev
)paren
suffix:semicolon
id|netif_rx
(paren
id|skb
)paren
suffix:semicolon
id|lp-&gt;stats.rx_packets
op_increment
suffix:semicolon
)brace
multiline_comment|/* Return the packet to the pool */
id|rd-&gt;mblength
op_assign
l_int|0
suffix:semicolon
id|rd-&gt;rmd1_bits
op_assign
id|LE_R1_OWN
suffix:semicolon
id|lp-&gt;rx_new
op_assign
(paren
id|lp-&gt;rx_new
op_plus
l_int|1
)paren
op_amp
id|lp-&gt;rx_ring_mod_mask
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|lance_tx
r_static
r_int
id|lance_tx
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|lance_private
op_star
id|lp
op_assign
(paren
r_struct
id|lance_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_volatile
r_struct
id|lance_init_block
op_star
id|ib
op_assign
id|lp-&gt;init_block
suffix:semicolon
r_volatile
r_struct
id|lance_regs
op_star
id|ll
op_assign
id|lp-&gt;ll
suffix:semicolon
r_volatile
r_struct
id|lance_tx_desc
op_star
id|td
suffix:semicolon
r_int
id|i
comma
id|j
suffix:semicolon
r_int
id|status
suffix:semicolon
multiline_comment|/* csr0 is 2f3 */
id|ll-&gt;rdp
op_assign
id|LE_C0_TINT
op_or
id|LE_C0_INEA
suffix:semicolon
multiline_comment|/* csr0 is 73 */
id|j
op_assign
id|lp-&gt;tx_old
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
id|j
suffix:semicolon
id|i
op_ne
id|lp-&gt;tx_new
suffix:semicolon
id|i
op_assign
id|j
)paren
(brace
id|td
op_assign
op_amp
id|ib-&gt;btx_ring
(braket
id|i
)braket
suffix:semicolon
multiline_comment|/* If we hit a packet not owned by us, stop */
r_if
c_cond
(paren
id|td-&gt;tmd1_bits
op_amp
id|LE_T1_OWN
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
id|td-&gt;tmd1_bits
op_amp
id|LE_T1_ERR
)paren
(brace
id|status
op_assign
id|td-&gt;misc
suffix:semicolon
id|lp-&gt;stats.tx_errors
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
id|LE_T3_RTY
)paren
id|lp-&gt;stats.tx_aborted_errors
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
id|LE_T3_LCOL
)paren
id|lp-&gt;stats.tx_window_errors
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
id|LE_T3_CLOS
)paren
(brace
id|lp-&gt;stats.tx_carrier_errors
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|lp-&gt;auto_select
)paren
(brace
id|lp-&gt;tpe
op_assign
l_int|1
op_minus
id|lp-&gt;tpe
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;%s: Carrier Lost, trying %s&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|lp-&gt;tpe
ques
c_cond
l_string|&quot;TPE&quot;
suffix:colon
l_string|&quot;AUI&quot;
)paren
suffix:semicolon
multiline_comment|/* Stop the lance */
id|ll-&gt;rap
op_assign
id|LE_CSR0
suffix:semicolon
id|ll-&gt;rdp
op_assign
id|LE_C0_STOP
suffix:semicolon
id|lance_init_ring
(paren
id|dev
)paren
suffix:semicolon
id|load_csrs
(paren
id|lp
)paren
suffix:semicolon
id|init_restart_lance
(paren
id|lp
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
)brace
multiline_comment|/* buffer errors and underflows turn off the transmitter */
multiline_comment|/* Restart the adapter */
r_if
c_cond
(paren
id|status
op_amp
(paren
id|LE_T3_BUF
op_or
id|LE_T3_UFL
)paren
)paren
(brace
id|lp-&gt;stats.tx_fifo_errors
op_increment
suffix:semicolon
id|printk
(paren
l_string|&quot;%s: Tx: ERR_BUF|ERR_UFL, restarting&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
multiline_comment|/* Stop the lance */
id|ll-&gt;rap
op_assign
id|LE_CSR0
suffix:semicolon
id|ll-&gt;rdp
op_assign
id|LE_C0_STOP
suffix:semicolon
id|lance_init_ring
(paren
id|dev
)paren
suffix:semicolon
id|load_csrs
(paren
id|lp
)paren
suffix:semicolon
id|init_restart_lance
(paren
id|lp
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
)brace
r_else
r_if
c_cond
(paren
(paren
id|td-&gt;tmd1_bits
op_amp
id|LE_T1_POK
)paren
op_eq
id|LE_T1_POK
)paren
(brace
multiline_comment|/*&n;&t;&t;&t; * So we don&squot;t count the packet more than once.&n;&t;&t;&t; */
id|td-&gt;tmd1_bits
op_and_assign
op_complement
(paren
id|LE_T1_POK
)paren
suffix:semicolon
multiline_comment|/* One collision before packet was sent. */
r_if
c_cond
(paren
id|td-&gt;tmd1_bits
op_amp
id|LE_T1_EONE
)paren
id|lp-&gt;stats.collisions
op_increment
suffix:semicolon
multiline_comment|/* More than one collision, be optimistic. */
r_if
c_cond
(paren
id|td-&gt;tmd1_bits
op_amp
id|LE_T1_EMORE
)paren
id|lp-&gt;stats.collisions
op_add_assign
l_int|2
suffix:semicolon
id|lp-&gt;stats.tx_packets
op_increment
suffix:semicolon
)brace
id|j
op_assign
(paren
id|j
op_plus
l_int|1
)paren
op_amp
id|lp-&gt;tx_ring_mod_mask
suffix:semicolon
)brace
id|lp-&gt;tx_old
op_assign
id|j
suffix:semicolon
id|ll-&gt;rdp
op_assign
id|LE_C0_TINT
op_or
id|LE_C0_INEA
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|lance_interrupt
r_static
r_void
id|lance_interrupt
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_struct
id|net_device
op_star
id|dev
suffix:semicolon
r_struct
id|lance_private
op_star
id|lp
suffix:semicolon
r_volatile
r_struct
id|lance_regs
op_star
id|ll
suffix:semicolon
r_int
id|csr0
suffix:semicolon
id|dev
op_assign
(paren
r_struct
id|net_device
op_star
)paren
id|dev_id
suffix:semicolon
id|lp
op_assign
(paren
r_struct
id|lance_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|ll
op_assign
id|lp-&gt;ll
suffix:semicolon
id|ll-&gt;rap
op_assign
id|LE_CSR0
suffix:semicolon
multiline_comment|/* LANCE Controller Status */
id|csr0
op_assign
id|ll-&gt;rdp
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|csr0
op_amp
id|LE_C0_INTR
)paren
)paren
multiline_comment|/* Check if any interrupt has */
r_return
suffix:semicolon
multiline_comment|/* been generated by the Lance. */
multiline_comment|/* Acknowledge all the interrupt sources ASAP */
id|ll-&gt;rdp
op_assign
id|csr0
op_amp
op_complement
(paren
id|LE_C0_INEA
op_or
id|LE_C0_TDMD
op_or
id|LE_C0_STOP
op_or
id|LE_C0_STRT
op_or
id|LE_C0_INIT
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|csr0
op_amp
id|LE_C0_ERR
)paren
)paren
(brace
multiline_comment|/* Clear the error condition */
id|ll-&gt;rdp
op_assign
id|LE_C0_BABL
op_or
id|LE_C0_ERR
op_or
id|LE_C0_MISS
op_or
id|LE_C0_INEA
suffix:semicolon
)brace
r_if
c_cond
(paren
id|csr0
op_amp
id|LE_C0_RINT
)paren
id|lance_rx
(paren
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|csr0
op_amp
id|LE_C0_TINT
)paren
id|lance_tx
(paren
id|dev
)paren
suffix:semicolon
multiline_comment|/* Log misc errors. */
r_if
c_cond
(paren
id|csr0
op_amp
id|LE_C0_BABL
)paren
id|lp-&gt;stats.tx_errors
op_increment
suffix:semicolon
multiline_comment|/* Tx babble. */
r_if
c_cond
(paren
id|csr0
op_amp
id|LE_C0_MISS
)paren
id|lp-&gt;stats.rx_errors
op_increment
suffix:semicolon
multiline_comment|/* Missed a Rx frame. */
r_if
c_cond
(paren
id|csr0
op_amp
id|LE_C0_MERR
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%s: Bus master arbitration failure, status %4.4x.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|csr0
)paren
suffix:semicolon
multiline_comment|/* Restart the chip. */
id|ll-&gt;rdp
op_assign
id|LE_C0_STRT
suffix:semicolon
)brace
r_if
c_cond
(paren
id|netif_queue_stopped
c_func
(paren
id|dev
)paren
op_logical_and
id|TX_BUFFS_AVAIL
OG
l_int|0
)paren
id|netif_wake_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
id|ll-&gt;rap
op_assign
id|LE_CSR0
suffix:semicolon
id|ll-&gt;rdp
op_assign
id|LE_C0_BABL
op_or
id|LE_C0_CERR
op_or
id|LE_C0_MISS
op_or
id|LE_C0_MERR
op_or
id|LE_C0_IDON
op_or
id|LE_C0_INEA
suffix:semicolon
)brace
DECL|variable|last_dev
r_struct
id|net_device
op_star
id|last_dev
op_assign
l_int|0
suffix:semicolon
DECL|function|lance_open
r_static
r_int
id|lance_open
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|lance_private
op_star
id|lp
op_assign
(paren
r_struct
id|lance_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_volatile
r_struct
id|lance_regs
op_star
id|ll
op_assign
id|lp-&gt;ll
suffix:semicolon
r_int
id|ret
suffix:semicolon
id|last_dev
op_assign
id|dev
suffix:semicolon
multiline_comment|/* Install the Interrupt handler */
id|ret
op_assign
id|request_irq
c_func
(paren
id|IRQ_AMIGA_PORTS
comma
id|lance_interrupt
comma
id|SA_SHIRQ
comma
id|dev-&gt;name
comma
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
)paren
r_return
id|ret
suffix:semicolon
multiline_comment|/* Stop the Lance */
id|ll-&gt;rap
op_assign
id|LE_CSR0
suffix:semicolon
id|ll-&gt;rdp
op_assign
id|LE_C0_STOP
suffix:semicolon
id|load_csrs
(paren
id|lp
)paren
suffix:semicolon
id|lance_init_ring
(paren
id|dev
)paren
suffix:semicolon
id|netif_start_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
r_return
id|init_restart_lance
(paren
id|lp
)paren
suffix:semicolon
)brace
DECL|function|lance_close
r_static
r_int
id|lance_close
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|lance_private
op_star
id|lp
op_assign
(paren
r_struct
id|lance_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_volatile
r_struct
id|lance_regs
op_star
id|ll
op_assign
id|lp-&gt;ll
suffix:semicolon
id|netif_stop_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
id|del_timer_sync
c_func
(paren
op_amp
id|lp-&gt;multicast_timer
)paren
suffix:semicolon
multiline_comment|/* Stop the card */
id|ll-&gt;rap
op_assign
id|LE_CSR0
suffix:semicolon
id|ll-&gt;rdp
op_assign
id|LE_C0_STOP
suffix:semicolon
id|free_irq
c_func
(paren
id|IRQ_AMIGA_PORTS
comma
id|dev
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|lance_reset
r_static
r_inline
r_int
id|lance_reset
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|lance_private
op_star
id|lp
op_assign
(paren
r_struct
id|lance_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_volatile
r_struct
id|lance_regs
op_star
id|ll
op_assign
id|lp-&gt;ll
suffix:semicolon
r_int
id|status
suffix:semicolon
multiline_comment|/* Stop the lance */
id|ll-&gt;rap
op_assign
id|LE_CSR0
suffix:semicolon
id|ll-&gt;rdp
op_assign
id|LE_C0_STOP
suffix:semicolon
id|load_csrs
(paren
id|lp
)paren
suffix:semicolon
id|lance_init_ring
(paren
id|dev
)paren
suffix:semicolon
id|dev-&gt;trans_start
op_assign
id|jiffies
suffix:semicolon
id|netif_start_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
id|status
op_assign
id|init_restart_lance
(paren
id|lp
)paren
suffix:semicolon
macro_line|#ifdef DEBUG_DRIVER
id|printk
(paren
l_string|&quot;Lance restart=%d&bslash;n&quot;
comma
id|status
)paren
suffix:semicolon
macro_line|#endif
r_return
id|status
suffix:semicolon
)brace
DECL|function|lance_tx_timeout
r_static
r_void
id|lance_tx_timeout
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|lance_private
op_star
id|lp
op_assign
(paren
r_struct
id|lance_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_volatile
r_struct
id|lance_regs
op_star
id|ll
op_assign
id|lp-&gt;ll
suffix:semicolon
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: transmit timed out, status %04x, reset&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|ll-&gt;rdp
)paren
suffix:semicolon
id|lance_reset
c_func
(paren
id|dev
)paren
suffix:semicolon
id|netif_wake_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
DECL|function|lance_start_xmit
r_static
r_int
id|lance_start_xmit
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|lance_private
op_star
id|lp
op_assign
(paren
r_struct
id|lance_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_volatile
r_struct
id|lance_regs
op_star
id|ll
op_assign
id|lp-&gt;ll
suffix:semicolon
r_volatile
r_struct
id|lance_init_block
op_star
id|ib
op_assign
id|lp-&gt;init_block
suffix:semicolon
r_int
id|entry
comma
id|skblen
comma
id|len
suffix:semicolon
r_int
id|status
op_assign
l_int|0
suffix:semicolon
r_static
r_int
id|outs
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|skblen
op_assign
id|skb-&gt;len
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|TX_BUFFS_AVAIL
)paren
(brace
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
macro_line|#ifdef DEBUG_DRIVER
multiline_comment|/* dump the packet */
(brace
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|64
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
(paren
id|i
op_mod
l_int|16
)paren
op_eq
l_int|0
)paren
id|printk
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
id|printk
(paren
l_string|&quot;%2.2x &quot;
comma
id|skb-&gt;data
(braket
id|i
)braket
)paren
suffix:semicolon
)brace
)brace
macro_line|#endif
id|len
op_assign
(paren
id|skblen
op_le
id|ETH_ZLEN
)paren
ques
c_cond
id|ETH_ZLEN
suffix:colon
id|skblen
suffix:semicolon
id|entry
op_assign
id|lp-&gt;tx_new
op_amp
id|lp-&gt;tx_ring_mod_mask
suffix:semicolon
id|ib-&gt;btx_ring
(braket
id|entry
)braket
dot
id|length
op_assign
(paren
op_minus
id|len
)paren
op_or
l_int|0xf000
suffix:semicolon
id|ib-&gt;btx_ring
(braket
id|entry
)braket
dot
id|misc
op_assign
l_int|0
suffix:semicolon
id|memcpy
(paren
(paren
r_char
op_star
)paren
op_amp
id|ib-&gt;tx_buf
(braket
id|entry
)braket
(braket
l_int|0
)braket
comma
id|skb-&gt;data
comma
id|skblen
)paren
suffix:semicolon
multiline_comment|/* Clear the slack of the packet, do I need this? */
r_if
c_cond
(paren
id|len
op_ne
id|skblen
)paren
id|memset
(paren
(paren
r_char
op_star
)paren
op_amp
id|ib-&gt;tx_buf
(braket
id|entry
)braket
(braket
id|skblen
)braket
comma
l_int|0
comma
id|len
op_minus
id|skblen
)paren
suffix:semicolon
multiline_comment|/* Now, give the packet to the lance */
id|ib-&gt;btx_ring
(braket
id|entry
)braket
dot
id|tmd1_bits
op_assign
(paren
id|LE_T1_POK
op_or
id|LE_T1_OWN
)paren
suffix:semicolon
id|lp-&gt;tx_new
op_assign
(paren
id|lp-&gt;tx_new
op_plus
l_int|1
)paren
op_amp
id|lp-&gt;tx_ring_mod_mask
suffix:semicolon
id|outs
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|TX_BUFFS_AVAIL
op_le
l_int|0
)paren
id|netif_stop_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
multiline_comment|/* Kick the lance: transmit now */
id|ll-&gt;rdp
op_assign
id|LE_C0_INEA
op_or
id|LE_C0_TDMD
suffix:semicolon
id|dev-&gt;trans_start
op_assign
id|jiffies
suffix:semicolon
id|dev_kfree_skb
(paren
id|skb
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
id|status
suffix:semicolon
)brace
DECL|function|lance_get_stats
r_static
r_struct
id|net_device_stats
op_star
id|lance_get_stats
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|lance_private
op_star
id|lp
op_assign
(paren
r_struct
id|lance_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_return
op_amp
id|lp-&gt;stats
suffix:semicolon
)brace
multiline_comment|/* taken from the depca driver */
DECL|function|lance_load_multicast
r_static
r_void
id|lance_load_multicast
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|lance_private
op_star
id|lp
op_assign
(paren
r_struct
id|lance_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_volatile
r_struct
id|lance_init_block
op_star
id|ib
op_assign
id|lp-&gt;init_block
suffix:semicolon
r_volatile
id|u16
op_star
id|mcast_table
op_assign
(paren
id|u16
op_star
)paren
op_amp
id|ib-&gt;filter
suffix:semicolon
r_struct
id|dev_mc_list
op_star
id|dmi
op_assign
id|dev-&gt;mc_list
suffix:semicolon
r_char
op_star
id|addrs
suffix:semicolon
r_int
id|i
comma
id|j
comma
id|bit
comma
id|byte
suffix:semicolon
id|u32
id|crc
comma
id|poly
op_assign
id|CRC_POLYNOMIAL_LE
suffix:semicolon
multiline_comment|/* set all multicast bits */
r_if
c_cond
(paren
id|dev-&gt;flags
op_amp
id|IFF_ALLMULTI
)paren
(brace
id|ib-&gt;filter
(braket
l_int|0
)braket
op_assign
l_int|0xffffffff
suffix:semicolon
id|ib-&gt;filter
(braket
l_int|1
)braket
op_assign
l_int|0xffffffff
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/* clear the multicast filter */
id|ib-&gt;filter
(braket
l_int|0
)braket
op_assign
l_int|0
suffix:semicolon
id|ib-&gt;filter
(braket
l_int|1
)braket
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Add addresses */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|dev-&gt;mc_count
suffix:semicolon
id|i
op_increment
)paren
(brace
id|addrs
op_assign
id|dmi-&gt;dmi_addr
suffix:semicolon
id|dmi
op_assign
id|dmi-&gt;next
suffix:semicolon
multiline_comment|/* multicast address? */
r_if
c_cond
(paren
op_logical_neg
(paren
op_star
id|addrs
op_amp
l_int|1
)paren
)paren
r_continue
suffix:semicolon
id|crc
op_assign
l_int|0xffffffff
suffix:semicolon
r_for
c_loop
(paren
id|byte
op_assign
l_int|0
suffix:semicolon
id|byte
OL
l_int|6
suffix:semicolon
id|byte
op_increment
)paren
r_for
c_loop
(paren
id|bit
op_assign
op_star
id|addrs
op_increment
comma
id|j
op_assign
l_int|0
suffix:semicolon
id|j
OL
l_int|8
suffix:semicolon
id|j
op_increment
comma
id|bit
op_rshift_assign
l_int|1
)paren
(brace
r_int
id|test
suffix:semicolon
id|test
op_assign
(paren
(paren
id|bit
op_xor
id|crc
)paren
op_amp
l_int|0x01
)paren
suffix:semicolon
id|crc
op_rshift_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|test
)paren
(brace
id|crc
op_assign
id|crc
op_xor
id|poly
suffix:semicolon
)brace
)brace
id|crc
op_assign
id|crc
op_rshift
l_int|26
suffix:semicolon
id|mcast_table
(braket
id|crc
op_rshift
l_int|4
)braket
op_or_assign
l_int|1
op_lshift
(paren
id|crc
op_amp
l_int|0xf
)paren
suffix:semicolon
)brace
r_return
suffix:semicolon
)brace
DECL|function|lance_set_multicast
r_static
r_void
id|lance_set_multicast
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|lance_private
op_star
id|lp
op_assign
(paren
r_struct
id|lance_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_volatile
r_struct
id|lance_init_block
op_star
id|ib
op_assign
id|lp-&gt;init_block
suffix:semicolon
r_volatile
r_struct
id|lance_regs
op_star
id|ll
op_assign
id|lp-&gt;ll
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|netif_running
c_func
(paren
id|dev
)paren
)paren
r_return
suffix:semicolon
r_if
c_cond
(paren
id|lp-&gt;tx_old
op_ne
id|lp-&gt;tx_new
)paren
(brace
id|mod_timer
c_func
(paren
op_amp
id|lp-&gt;multicast_timer
comma
id|jiffies
op_plus
l_int|4
)paren
suffix:semicolon
id|netif_wake_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|netif_stop_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
id|ll-&gt;rap
op_assign
id|LE_CSR0
suffix:semicolon
id|ll-&gt;rdp
op_assign
id|LE_C0_STOP
suffix:semicolon
id|lance_init_ring
(paren
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;flags
op_amp
id|IFF_PROMISC
)paren
(brace
id|ib-&gt;mode
op_or_assign
id|LE_MO_PROM
suffix:semicolon
)brace
r_else
(brace
id|ib-&gt;mode
op_and_assign
op_complement
id|LE_MO_PROM
suffix:semicolon
id|lance_load_multicast
(paren
id|dev
)paren
suffix:semicolon
)brace
id|load_csrs
(paren
id|lp
)paren
suffix:semicolon
id|init_restart_lance
(paren
id|lp
)paren
suffix:semicolon
id|netif_wake_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
DECL|function|a2065_probe
r_static
r_int
id|__init
id|a2065_probe
c_func
(paren
r_void
)paren
(brace
r_struct
id|zorro_dev
op_star
id|z
op_assign
l_int|NULL
suffix:semicolon
r_struct
id|net_device
op_star
id|dev
suffix:semicolon
r_struct
id|lance_private
op_star
id|priv
suffix:semicolon
r_int
id|res
op_assign
op_minus
id|ENODEV
suffix:semicolon
r_while
c_loop
(paren
(paren
id|z
op_assign
id|zorro_find_device
c_func
(paren
id|ZORRO_WILDCARD
comma
id|z
)paren
)paren
)paren
(brace
r_int
r_int
id|board
comma
id|base_addr
comma
id|mem_start
suffix:semicolon
r_struct
id|resource
op_star
id|r1
comma
op_star
id|r2
suffix:semicolon
r_int
id|is_cbm
suffix:semicolon
r_if
c_cond
(paren
id|z-&gt;id
op_eq
id|ZORRO_PROD_CBM_A2065_1
op_logical_or
id|z-&gt;id
op_eq
id|ZORRO_PROD_CBM_A2065_2
)paren
id|is_cbm
op_assign
l_int|1
suffix:semicolon
r_else
r_if
c_cond
(paren
id|z-&gt;id
op_eq
id|ZORRO_PROD_AMERISTAR_A2065
)paren
id|is_cbm
op_assign
l_int|0
suffix:semicolon
r_else
r_continue
suffix:semicolon
id|board
op_assign
id|z-&gt;resource.start
suffix:semicolon
id|base_addr
op_assign
id|board
op_plus
id|A2065_LANCE
suffix:semicolon
id|mem_start
op_assign
id|board
op_plus
id|A2065_RAM
suffix:semicolon
id|r1
op_assign
id|request_mem_region
c_func
(paren
id|base_addr
comma
r_sizeof
(paren
r_struct
id|lance_regs
)paren
comma
l_string|&quot;Am7990&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|r1
)paren
r_continue
suffix:semicolon
id|r2
op_assign
id|request_mem_region
c_func
(paren
id|mem_start
comma
id|A2065_RAM_SIZE
comma
l_string|&quot;RAM&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|r2
)paren
(brace
id|release_resource
c_func
(paren
id|r1
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
id|dev
op_assign
id|init_etherdev
c_func
(paren
l_int|NULL
comma
r_sizeof
(paren
r_struct
id|lance_private
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dev
op_eq
l_int|NULL
)paren
(brace
id|release_resource
c_func
(paren
id|r1
)paren
suffix:semicolon
id|release_resource
c_func
(paren
id|r2
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|SET_MODULE_OWNER
c_func
(paren
id|dev
)paren
suffix:semicolon
id|priv
op_assign
id|dev-&gt;priv
suffix:semicolon
id|r1-&gt;name
op_assign
id|dev-&gt;name
suffix:semicolon
id|r2-&gt;name
op_assign
id|dev-&gt;name
suffix:semicolon
id|priv-&gt;dev
op_assign
id|dev
suffix:semicolon
id|dev-&gt;dev_addr
(braket
l_int|0
)braket
op_assign
l_int|0x00
suffix:semicolon
r_if
c_cond
(paren
id|is_cbm
)paren
(brace
multiline_comment|/* Commodore */
id|dev-&gt;dev_addr
(braket
l_int|1
)braket
op_assign
l_int|0x80
suffix:semicolon
id|dev-&gt;dev_addr
(braket
l_int|2
)braket
op_assign
l_int|0x10
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* Ameristar */
id|dev-&gt;dev_addr
(braket
l_int|1
)braket
op_assign
l_int|0x00
suffix:semicolon
id|dev-&gt;dev_addr
(braket
l_int|2
)braket
op_assign
l_int|0x9f
suffix:semicolon
)brace
id|dev-&gt;dev_addr
(braket
l_int|3
)braket
op_assign
(paren
id|z-&gt;rom.er_SerialNumber
op_rshift
l_int|16
)paren
op_amp
l_int|0xff
suffix:semicolon
id|dev-&gt;dev_addr
(braket
l_int|4
)braket
op_assign
(paren
id|z-&gt;rom.er_SerialNumber
op_rshift
l_int|8
)paren
op_amp
l_int|0xff
suffix:semicolon
id|dev-&gt;dev_addr
(braket
l_int|5
)braket
op_assign
id|z-&gt;rom.er_SerialNumber
op_amp
l_int|0xff
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;%s: A2065 at 0x%08lx, Ethernet Address &quot;
l_string|&quot;%02x:%02x:%02x:%02x:%02x:%02x&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|board
comma
id|dev-&gt;dev_addr
(braket
l_int|0
)braket
comma
id|dev-&gt;dev_addr
(braket
l_int|1
)braket
comma
id|dev-&gt;dev_addr
(braket
l_int|2
)braket
comma
id|dev-&gt;dev_addr
(braket
l_int|3
)braket
comma
id|dev-&gt;dev_addr
(braket
l_int|4
)braket
comma
id|dev-&gt;dev_addr
(braket
l_int|5
)braket
)paren
suffix:semicolon
id|dev-&gt;base_addr
op_assign
id|ZTWO_VADDR
c_func
(paren
id|base_addr
)paren
suffix:semicolon
id|dev-&gt;mem_start
op_assign
id|ZTWO_VADDR
c_func
(paren
id|mem_start
)paren
suffix:semicolon
id|dev-&gt;mem_end
op_assign
id|dev-&gt;mem_start
op_plus
id|A2065_RAM_SIZE
suffix:semicolon
id|priv-&gt;ll
op_assign
(paren
r_volatile
r_struct
id|lance_regs
op_star
)paren
id|dev-&gt;base_addr
suffix:semicolon
id|priv-&gt;init_block
op_assign
(paren
r_struct
id|lance_init_block
op_star
)paren
id|dev-&gt;mem_start
suffix:semicolon
id|priv-&gt;lance_init_block
op_assign
(paren
r_struct
id|lance_init_block
op_star
)paren
id|A2065_RAM
suffix:semicolon
id|priv-&gt;auto_select
op_assign
l_int|0
suffix:semicolon
id|priv-&gt;busmaster_regval
op_assign
id|LE_C3_BSWP
suffix:semicolon
id|priv-&gt;lance_log_rx_bufs
op_assign
id|LANCE_LOG_RX_BUFFERS
suffix:semicolon
id|priv-&gt;lance_log_tx_bufs
op_assign
id|LANCE_LOG_TX_BUFFERS
suffix:semicolon
id|priv-&gt;rx_ring_mod_mask
op_assign
id|RX_RING_MOD_MASK
suffix:semicolon
id|priv-&gt;tx_ring_mod_mask
op_assign
id|TX_RING_MOD_MASK
suffix:semicolon
id|dev-&gt;open
op_assign
op_amp
id|lance_open
suffix:semicolon
id|dev-&gt;stop
op_assign
op_amp
id|lance_close
suffix:semicolon
id|dev-&gt;hard_start_xmit
op_assign
op_amp
id|lance_start_xmit
suffix:semicolon
id|dev-&gt;tx_timeout
op_assign
op_amp
id|lance_tx_timeout
suffix:semicolon
id|dev-&gt;watchdog_timeo
op_assign
l_int|5
op_star
id|HZ
suffix:semicolon
id|dev-&gt;get_stats
op_assign
op_amp
id|lance_get_stats
suffix:semicolon
id|dev-&gt;set_multicast_list
op_assign
op_amp
id|lance_set_multicast
suffix:semicolon
id|dev-&gt;dma
op_assign
l_int|0
suffix:semicolon
macro_line|#ifdef MODULE
id|priv-&gt;next_module
op_assign
id|root_a2065_dev
suffix:semicolon
id|root_a2065_dev
op_assign
id|priv
suffix:semicolon
macro_line|#endif
id|ether_setup
c_func
(paren
id|dev
)paren
suffix:semicolon
id|init_timer
c_func
(paren
op_amp
id|priv-&gt;multicast_timer
)paren
suffix:semicolon
id|priv-&gt;multicast_timer.data
op_assign
(paren
r_int
r_int
)paren
id|dev
suffix:semicolon
id|priv-&gt;multicast_timer.function
op_assign
(paren
r_void
(paren
op_star
)paren
(paren
r_int
r_int
)paren
)paren
op_amp
id|lance_set_multicast
suffix:semicolon
id|res
op_assign
l_int|0
suffix:semicolon
)brace
r_return
id|res
suffix:semicolon
)brace
DECL|function|a2065_cleanup
r_static
r_void
id|__exit
id|a2065_cleanup
c_func
(paren
r_void
)paren
(brace
macro_line|#ifdef MODULE
r_struct
id|lance_private
op_star
id|next
suffix:semicolon
r_struct
id|net_device
op_star
id|dev
suffix:semicolon
r_while
c_loop
(paren
id|root_a2065_dev
)paren
(brace
id|next
op_assign
id|root_a2065_dev-&gt;next_module
suffix:semicolon
id|dev
op_assign
id|root_a2065_dev-&gt;dev
suffix:semicolon
id|unregister_netdev
c_func
(paren
id|dev
)paren
suffix:semicolon
id|release_mem_region
c_func
(paren
id|ZTWO_PADDR
c_func
(paren
id|dev-&gt;base_addr
)paren
comma
r_sizeof
(paren
r_struct
id|lance_regs
)paren
)paren
suffix:semicolon
id|release_mem_region
c_func
(paren
id|ZTWO_PADDR
c_func
(paren
id|dev-&gt;mem_start
)paren
comma
id|A2065_RAM_SIZE
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|dev
)paren
suffix:semicolon
id|root_a2065_dev
op_assign
id|next
suffix:semicolon
)brace
macro_line|#endif
)brace
DECL|variable|a2065_probe
id|module_init
c_func
(paren
id|a2065_probe
)paren
suffix:semicolon
DECL|variable|a2065_cleanup
id|module_exit
c_func
(paren
id|a2065_cleanup
)paren
suffix:semicolon
eof
