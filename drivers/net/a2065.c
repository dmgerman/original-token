multiline_comment|/*&n; * Amiga Linux/68k A2065 Ethernet Driver&n; *&n; * (C) Copyright 1995 by Geert Uytterhoeven&n; *                      (Geert.Uytterhoeven@cs.kuleuven.ac.be)&n; *&n; * Fixes and tips by:&n; *&t;- Janos Farkas (CHEXUM@sparta.banki.hu)&n; *&t;- Jes Degn Soerensen (jds@kom.auc.dk)&n; *&n; * ----------------------------------------------------------------------------&n; *&n; * This program is based on&n; *&n; *&t;ariadne.?:&t;Amiga Linux/68k Ariadne Ethernet Driver&n; *&t;&t;&t;(C) Copyright 1995 by Geert Uytterhoeven,&n; *                                            Peter De Schrijver&n; *&n; *&t;lance.c:&t;An AMD LANCE ethernet driver for linux.&n; *&t;&t;&t;Written 1993-94 by Donald Becker.&n; *&n; *&t;Am79C960:&t;PCnet(tm)-ISA Single-Chip Ethernet Controller&n; *&t;&t;&t;Advanced Micro Devices&n; *&t;&t;&t;Publication #16907, Rev. B, Amendment/0, May 1994&n; *&n; * ----------------------------------------------------------------------------&n; *&n; * This file is subject to the terms and conditions of the GNU General Public&n; * License.  See the file README.legal in the main directory of the Linux/68k&n; * distribution for more details.&n; *&n; * ----------------------------------------------------------------------------&n; *&n; * The A2065 is a Zorro-II board made by Commodore/Ameristar. It contains:&n; *&n; *&t;- an Am7990 Local Area Network Controller for Ethernet (LANCE) with&n; *&t;  both 10BASE-2 (thin coax) and AUI (DB-15) connectors&n; */
macro_line|#include &lt;stddef.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/ptrace.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/ioport.h&gt;
macro_line|#include &lt;linux/malloc.h&gt;
macro_line|#include &lt;linux/interrupt.h&gt;
macro_line|#include &lt;linux/netdevice.h&gt;
macro_line|#include &lt;linux/etherdevice.h&gt;
macro_line|#include &lt;linux/skbuff.h&gt;
macro_line|#include &lt;asm/bitops.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/irq.h&gt;
macro_line|#include &lt;asm/bootinfo.h&gt;
macro_line|#include &lt;asm/amigaints.h&gt;
macro_line|#include &lt;asm/amigahw.h&gt;
macro_line|#include &lt;asm/zorro.h&gt;
macro_line|#include &quot;a2065.h&quot;
macro_line|#ifdef A2065_DEBUG
DECL|variable|a2065_debug
r_int
id|a2065_debug
op_assign
id|A2065_DEBUG
suffix:semicolon
macro_line|#else
DECL|variable|a2065_debug
r_int
id|a2065_debug
op_assign
l_int|1
suffix:semicolon
macro_line|#endif
multiline_comment|/*&n;&t; *&t;&t;Transmit/Receive Ring Definitions&n;&t; */
DECL|macro|LANCE_LOG_TX_BUFFERS
mdefine_line|#define LANCE_LOG_TX_BUFFERS&t;(2)
DECL|macro|LANCE_LOG_RX_BUFFERS
mdefine_line|#define LANCE_LOG_RX_BUFFERS&t;(4)
DECL|macro|TX_RING_SIZE
mdefine_line|#define TX_RING_SIZE&t;&t;(1&lt;&lt;LANCE_LOG_TX_BUFFERS)
DECL|macro|RX_RING_SIZE
mdefine_line|#define RX_RING_SIZE&t;&t;(1&lt;&lt;LANCE_LOG_RX_BUFFERS)
DECL|macro|TX_RING_MOD_MASK
mdefine_line|#define TX_RING_MOD_MASK&t;(TX_RING_SIZE-1)
DECL|macro|RX_RING_MOD_MASK
mdefine_line|#define RX_RING_MOD_MASK&t;(RX_RING_SIZE-1)
DECL|macro|PKT_BUF_SIZE
mdefine_line|#define PKT_BUF_SIZE&t;&t;(1520)
multiline_comment|/*&n;&t; *&t;&t;Private Device Data&n;&t; */
DECL|struct|a2065_private
r_struct
id|a2065_private
(brace
DECL|member|board
r_struct
id|A2065Board
op_star
id|board
suffix:semicolon
DECL|member|tx_ring
r_struct
id|TDRE
op_star
id|tx_ring
(braket
id|TX_RING_SIZE
)braket
suffix:semicolon
DECL|member|rx_ring
r_struct
id|RDRE
op_star
id|rx_ring
(braket
id|RX_RING_SIZE
)braket
suffix:semicolon
DECL|member|tx_buff
id|u_char
op_star
id|tx_buff
(braket
id|TX_RING_SIZE
)braket
suffix:semicolon
DECL|member|rx_buff
id|u_char
op_star
id|rx_buff
(braket
id|RX_RING_SIZE
)braket
suffix:semicolon
DECL|member|cur_tx
DECL|member|cur_rx
r_int
id|cur_tx
comma
id|cur_rx
suffix:semicolon
multiline_comment|/* The next free ring entry */
DECL|member|dirty_tx
r_int
id|dirty_tx
suffix:semicolon
multiline_comment|/* The ring entries to be free()ed. */
DECL|member|stats
r_struct
id|enet_statistics
id|stats
suffix:semicolon
DECL|member|tx_full
r_char
id|tx_full
suffix:semicolon
DECL|member|lock
r_int
r_int
id|lock
suffix:semicolon
)brace
suffix:semicolon
multiline_comment|/*&n;&t; *&t;&t;Structure Created in the A2065&squot;s RAM Buffer&n;&t; */
DECL|struct|lancedata
r_struct
id|lancedata
(brace
DECL|member|init
r_struct
id|InitBlock
id|init
suffix:semicolon
DECL|member|tx_ring
r_struct
id|TDRE
id|tx_ring
(braket
id|TX_RING_SIZE
)braket
suffix:semicolon
DECL|member|rx_ring
r_struct
id|RDRE
id|rx_ring
(braket
id|RX_RING_SIZE
)braket
suffix:semicolon
DECL|member|tx_buff
id|u_char
id|tx_buff
(braket
id|TX_RING_SIZE
)braket
(braket
id|PKT_BUF_SIZE
)braket
suffix:semicolon
DECL|member|rx_buff
id|u_char
id|rx_buff
(braket
id|RX_RING_SIZE
)braket
(braket
id|PKT_BUF_SIZE
)braket
suffix:semicolon
)brace
suffix:semicolon
r_static
r_int
id|a2065_open
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_void
id|a2065_init_ring
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_int
id|a2065_start_xmit
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_int
id|a2065_rx
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_void
id|a2065_interrupt
c_func
(paren
r_int
id|irq
comma
r_struct
id|pt_regs
op_star
id|fp
comma
r_void
op_star
id|data
)paren
suffix:semicolon
r_static
r_int
id|a2065_close
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_struct
id|enet_statistics
op_star
id|a2065_get_stats
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_void
id|set_multicast_list
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
suffix:semicolon
DECL|function|a2065_probe
r_int
id|a2065_probe
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
r_int
id|key1
comma
id|key2
suffix:semicolon
r_struct
id|ConfigDev
op_star
id|cd
suffix:semicolon
id|u_long
id|board
suffix:semicolon
id|u_long
id|sn
suffix:semicolon
r_struct
id|a2065_private
op_star
id|priv
suffix:semicolon
r_if
c_cond
(paren
(paren
id|key1
op_assign
id|zorro_find
c_func
(paren
id|MANUF_COMMODORE
comma
id|PROD_A2065
comma
l_int|0
comma
l_int|0
)paren
)paren
op_logical_or
(paren
id|key2
op_assign
id|zorro_find
c_func
(paren
id|MANUF_AMERISTAR
comma
id|PROD_AMERISTAR2065
comma
l_int|0
comma
l_int|0
)paren
)paren
)paren
(brace
id|cd
op_assign
id|zorro_get_board
c_func
(paren
id|key1
ques
c_cond
id|key1
suffix:colon
id|key2
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|board
op_assign
(paren
id|u_long
)paren
id|cd-&gt;cd_BoardAddr
)paren
)paren
(brace
id|sn
op_assign
id|cd-&gt;cd_Rom.er_SerialNumber
suffix:semicolon
r_if
c_cond
(paren
id|key1
)paren
(brace
multiline_comment|/* Commodore */
id|dev-&gt;dev_addr
(braket
l_int|0
)braket
op_assign
l_int|0x00
suffix:semicolon
id|dev-&gt;dev_addr
(braket
l_int|1
)braket
op_assign
l_int|0x80
suffix:semicolon
id|dev-&gt;dev_addr
(braket
l_int|2
)braket
op_assign
l_int|0x10
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* Ameristar */
id|dev-&gt;dev_addr
(braket
l_int|0
)braket
op_assign
l_int|0x00
suffix:semicolon
id|dev-&gt;dev_addr
(braket
l_int|1
)braket
op_assign
l_int|0x00
suffix:semicolon
id|dev-&gt;dev_addr
(braket
l_int|2
)braket
op_assign
l_int|0x9f
suffix:semicolon
)brace
id|dev-&gt;dev_addr
(braket
l_int|3
)braket
op_assign
(paren
id|sn
op_rshift
l_int|16
)paren
op_amp
l_int|0xff
suffix:semicolon
id|dev-&gt;dev_addr
(braket
l_int|4
)braket
op_assign
(paren
id|sn
op_rshift
l_int|8
)paren
op_amp
l_int|0xff
suffix:semicolon
id|dev-&gt;dev_addr
(braket
l_int|5
)braket
op_assign
id|sn
op_amp
l_int|0xff
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;%s: A2065 at 0x%08lx, Ethernet Address %02x:%02x:%02x:%02x:%02x:%02x&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|board
comma
id|dev-&gt;dev_addr
(braket
l_int|0
)braket
comma
id|dev-&gt;dev_addr
(braket
l_int|1
)braket
comma
id|dev-&gt;dev_addr
(braket
l_int|2
)braket
comma
id|dev-&gt;dev_addr
(braket
l_int|3
)braket
comma
id|dev-&gt;dev_addr
(braket
l_int|4
)braket
comma
id|dev-&gt;dev_addr
(braket
l_int|5
)braket
)paren
suffix:semicolon
id|init_etherdev
c_func
(paren
id|dev
comma
l_int|0
)paren
suffix:semicolon
id|dev-&gt;priv
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|a2065_private
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
id|priv
op_assign
(paren
r_struct
id|a2065_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|memset
c_func
(paren
id|priv
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|a2065_private
)paren
)paren
suffix:semicolon
id|priv-&gt;board
op_assign
(paren
r_struct
id|A2065Board
op_star
)paren
id|ZTWO_VADDR
c_func
(paren
id|board
)paren
suffix:semicolon
id|dev-&gt;open
op_assign
op_amp
id|a2065_open
suffix:semicolon
id|dev-&gt;stop
op_assign
op_amp
id|a2065_close
suffix:semicolon
id|dev-&gt;hard_start_xmit
op_assign
op_amp
id|a2065_start_xmit
suffix:semicolon
id|dev-&gt;get_stats
op_assign
op_amp
id|a2065_get_stats
suffix:semicolon
id|dev-&gt;set_multicast_list
op_assign
op_amp
id|set_multicast_list
suffix:semicolon
id|zorro_config_board
c_func
(paren
id|key1
ques
c_cond
id|key1
suffix:colon
id|key2
comma
l_int|0
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
)brace
r_return
id|ENODEV
suffix:semicolon
)brace
DECL|function|a2065_open
r_static
r_int
id|a2065_open
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
r_struct
id|a2065_private
op_star
id|priv
op_assign
(paren
r_struct
id|a2065_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_struct
id|A2065Board
op_star
id|board
op_assign
id|priv-&gt;board
suffix:semicolon
r_static
r_int
id|interruptinstalled
op_assign
l_int|0
suffix:semicolon
r_struct
id|lancedata
op_star
id|lancedata
suffix:semicolon
multiline_comment|/* LANCE point of view */
r_struct
id|lancedata
op_star
id|alancedata
suffix:semicolon
multiline_comment|/* Amiga point of view */
id|lancedata
op_assign
(paren
r_struct
id|lancedata
op_star
)paren
m_offsetof
(paren
r_struct
id|A2065Board
comma
id|RAM
)paren
suffix:semicolon
id|alancedata
op_assign
(paren
r_struct
id|lancedata
op_star
)paren
id|board-&gt;RAM
suffix:semicolon
multiline_comment|/* Stop the LANCE */
id|board-&gt;Lance.RAP
op_assign
id|CSR0
suffix:semicolon
multiline_comment|/* LANCE Controller Status */
id|board-&gt;Lance.RDP
op_assign
id|STOP
suffix:semicolon
multiline_comment|/* Enable big endian byte ordering */
id|board-&gt;Lance.RAP
op_assign
id|CSR3
suffix:semicolon
multiline_comment|/* CSR3 */
id|board-&gt;Lance.RDP
op_assign
id|BSWP
suffix:semicolon
multiline_comment|/* Set the Init Block Pointer */
id|board-&gt;Lance.RAP
op_assign
id|CSR1
suffix:semicolon
multiline_comment|/* IADR[15:0] */
id|board-&gt;Lance.RDP
op_assign
(paren
id|u_long
)paren
op_amp
id|lancedata-&gt;init
suffix:semicolon
id|board-&gt;Lance.RAP
op_assign
id|CSR2
suffix:semicolon
multiline_comment|/* IADR[23:16] */
id|board-&gt;Lance.RDP
op_assign
l_int|0x0000
suffix:semicolon
multiline_comment|/* Set the Mode */
id|alancedata-&gt;init.Mode
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Set the Ethernet Hardware Address */
multiline_comment|/* Physical Address Register */
id|alancedata-&gt;init.PADR
(braket
l_int|0
)braket
op_assign
id|dev-&gt;dev_addr
(braket
l_int|1
)braket
suffix:semicolon
id|alancedata-&gt;init.PADR
(braket
l_int|1
)braket
op_assign
id|dev-&gt;dev_addr
(braket
l_int|0
)braket
suffix:semicolon
id|alancedata-&gt;init.PADR
(braket
l_int|2
)braket
op_assign
id|dev-&gt;dev_addr
(braket
l_int|3
)braket
suffix:semicolon
id|alancedata-&gt;init.PADR
(braket
l_int|3
)braket
op_assign
id|dev-&gt;dev_addr
(braket
l_int|2
)braket
suffix:semicolon
id|alancedata-&gt;init.PADR
(braket
l_int|4
)braket
op_assign
id|dev-&gt;dev_addr
(braket
l_int|5
)braket
suffix:semicolon
id|alancedata-&gt;init.PADR
(braket
l_int|5
)braket
op_assign
id|dev-&gt;dev_addr
(braket
l_int|4
)braket
suffix:semicolon
multiline_comment|/* Set the Multicast Table */
multiline_comment|/* Logical Address Filter, LADRF[31:0] */
id|alancedata-&gt;init.LADRF
(braket
l_int|0
)braket
op_assign
l_int|0x00000000
suffix:semicolon
multiline_comment|/* Logical Address Filter, LADRF[63:32] */
id|alancedata-&gt;init.LADRF
(braket
l_int|1
)braket
op_assign
l_int|0x00000000
suffix:semicolon
multiline_comment|/* Set the Receive and Transmit Descriptor Ring Pointers */
id|alancedata-&gt;init.RDRA
op_assign
(paren
id|u_long
)paren
op_amp
id|lancedata-&gt;rx_ring
suffix:semicolon
id|alancedata-&gt;init.RLEN
op_assign
id|LANCE_LOG_RX_BUFFERS
op_lshift
l_int|13
suffix:semicolon
id|alancedata-&gt;init.TDRA
op_assign
(paren
id|u_long
)paren
op_amp
id|lancedata-&gt;tx_ring
suffix:semicolon
id|alancedata-&gt;init.TLEN
op_assign
id|LANCE_LOG_TX_BUFFERS
op_lshift
l_int|13
suffix:semicolon
multiline_comment|/* Initialise the Rings */
id|a2065_init_ring
c_func
(paren
id|dev
)paren
suffix:semicolon
multiline_comment|/* Install the Interrupt handler */
r_if
c_cond
(paren
op_logical_neg
id|interruptinstalled
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|add_isr
c_func
(paren
id|IRQ_AMIGA_PORTS
comma
id|a2065_interrupt
comma
l_int|0
comma
id|dev
comma
l_string|&quot;a2065 Ethernet&quot;
)paren
)paren
r_return
op_minus
id|EAGAIN
suffix:semicolon
id|interruptinstalled
op_assign
l_int|1
suffix:semicolon
)brace
multiline_comment|/* Make the LANCE read the Init Block */
id|board-&gt;Lance.RAP
op_assign
id|CSR0
suffix:semicolon
multiline_comment|/* LANCE Controller Status */
id|board-&gt;Lance.RDP
op_assign
id|INEA
op_or
id|INIT
suffix:semicolon
id|dev-&gt;tbusy
op_assign
l_int|0
suffix:semicolon
id|dev-&gt;interrupt
op_assign
l_int|0
suffix:semicolon
id|dev-&gt;start
op_assign
l_int|1
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|a2065_init_ring
r_static
r_void
id|a2065_init_ring
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
r_struct
id|a2065_private
op_star
id|priv
op_assign
(paren
r_struct
id|a2065_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_struct
id|A2065Board
op_star
id|board
op_assign
id|priv-&gt;board
suffix:semicolon
r_struct
id|lancedata
op_star
id|lancedata
suffix:semicolon
multiline_comment|/* LANCE point of view */
r_struct
id|lancedata
op_star
id|alancedata
suffix:semicolon
multiline_comment|/* Amiga point of view */
r_int
id|i
suffix:semicolon
id|priv-&gt;lock
op_assign
l_int|0
comma
id|priv-&gt;tx_full
op_assign
l_int|0
suffix:semicolon
id|priv-&gt;cur_rx
op_assign
id|priv-&gt;cur_tx
op_assign
l_int|0
suffix:semicolon
id|priv-&gt;dirty_tx
op_assign
l_int|0
suffix:semicolon
id|lancedata
op_assign
(paren
r_struct
id|lancedata
op_star
)paren
m_offsetof
(paren
r_struct
id|A2065Board
comma
id|RAM
)paren
suffix:semicolon
id|alancedata
op_assign
(paren
r_struct
id|lancedata
op_star
)paren
id|board-&gt;RAM
suffix:semicolon
multiline_comment|/* Set up TX Ring */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|TX_RING_SIZE
suffix:semicolon
id|i
op_increment
)paren
(brace
id|alancedata-&gt;tx_ring
(braket
id|i
)braket
dot
id|TMD0
op_assign
(paren
id|u_long
)paren
id|lancedata-&gt;tx_buff
(braket
id|i
)braket
suffix:semicolon
id|alancedata-&gt;tx_ring
(braket
id|i
)braket
dot
id|TMD1
op_assign
id|TF_STP
op_or
id|TF_ENP
suffix:semicolon
id|alancedata-&gt;tx_ring
(braket
id|i
)braket
dot
id|TMD2
op_assign
op_minus
id|PKT_BUF_SIZE
suffix:semicolon
id|alancedata-&gt;tx_ring
(braket
id|i
)braket
dot
id|TMD3
op_assign
l_int|0x0000
suffix:semicolon
id|priv-&gt;tx_ring
(braket
id|i
)braket
op_assign
op_amp
id|alancedata-&gt;tx_ring
(braket
id|i
)braket
suffix:semicolon
id|priv-&gt;tx_buff
(braket
id|i
)braket
op_assign
id|alancedata-&gt;tx_buff
(braket
id|i
)braket
suffix:semicolon
macro_line|#if 0
id|printk
c_func
(paren
l_string|&quot;TX Entry %2d @ 0x%08x (LANCE 0x%08x), Buf @ 0x%08x (LANCE 0x%08x)&bslash;n&quot;
comma
id|i
comma
(paren
r_int
)paren
op_amp
id|alancedata-&gt;tx_ring
(braket
id|i
)braket
comma
(paren
r_int
)paren
op_amp
id|lancedata-&gt;tx_ring
(braket
id|i
)braket
comma
(paren
r_int
)paren
id|alancedata-&gt;tx_buff
(braket
id|i
)braket
comma
(paren
r_int
)paren
id|lancedata-&gt;tx_buff
(braket
id|i
)braket
)paren
suffix:semicolon
macro_line|#endif
)brace
multiline_comment|/* Set up RX Ring */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|RX_RING_SIZE
suffix:semicolon
id|i
op_increment
)paren
(brace
id|alancedata-&gt;rx_ring
(braket
id|i
)braket
dot
id|RMD0
op_assign
(paren
id|u_long
)paren
id|lancedata-&gt;rx_buff
(braket
id|i
)braket
suffix:semicolon
id|alancedata-&gt;rx_ring
(braket
id|i
)braket
dot
id|RMD1
op_assign
id|RF_OWN
suffix:semicolon
id|alancedata-&gt;rx_ring
(braket
id|i
)braket
dot
id|RMD2
op_assign
op_minus
id|PKT_BUF_SIZE
suffix:semicolon
id|alancedata-&gt;rx_ring
(braket
id|i
)braket
dot
id|RMD3
op_assign
l_int|0x0000
suffix:semicolon
id|priv-&gt;rx_ring
(braket
id|i
)braket
op_assign
op_amp
id|alancedata-&gt;rx_ring
(braket
id|i
)braket
suffix:semicolon
id|priv-&gt;rx_buff
(braket
id|i
)braket
op_assign
id|alancedata-&gt;rx_buff
(braket
id|i
)braket
suffix:semicolon
macro_line|#if 0
id|printk
c_func
(paren
l_string|&quot;RX Entry %2d @ 0x%08x (LANCE 0x%08x), Buf @ 0x%08x (LANCE 0x%08x)&bslash;n&quot;
comma
id|i
comma
(paren
r_int
)paren
op_amp
id|alancedata-&gt;rx_ring
(braket
id|i
)braket
comma
(paren
r_int
)paren
op_amp
id|lancedata-&gt;rx_ring
(braket
id|i
)braket
comma
(paren
r_int
)paren
id|alancedata-&gt;rx_buff
(braket
id|i
)braket
comma
(paren
r_int
)paren
id|lancedata-&gt;rx_buff
(braket
id|i
)braket
)paren
suffix:semicolon
macro_line|#endif
)brace
)brace
DECL|function|a2065_close
r_static
r_int
id|a2065_close
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
r_struct
id|a2065_private
op_star
id|priv
op_assign
(paren
r_struct
id|a2065_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_struct
id|A2065Board
op_star
id|board
op_assign
id|priv-&gt;board
suffix:semicolon
id|dev-&gt;start
op_assign
l_int|0
suffix:semicolon
id|dev-&gt;tbusy
op_assign
l_int|1
suffix:semicolon
id|board-&gt;Lance.RAP
op_assign
id|CSR0
suffix:semicolon
multiline_comment|/* LANCE Controller Status */
r_if
c_cond
(paren
id|a2065_debug
OG
l_int|1
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%s: Shutting down ethercard, status was %2.2x.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|board-&gt;Lance.RDP
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;%s: %d packets missed&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|priv-&gt;stats.rx_missed_errors
)paren
suffix:semicolon
)brace
multiline_comment|/* We stop the LANCE here - it occasionally polls memory if we don&squot;t */
id|board-&gt;Lance.RDP
op_assign
id|STOP
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|a2065_interrupt
r_static
r_void
id|a2065_interrupt
c_func
(paren
r_int
id|irq
comma
r_struct
id|pt_regs
op_star
id|fp
comma
r_void
op_star
id|data
)paren
(brace
r_struct
id|device
op_star
id|dev
op_assign
(paren
r_struct
id|device
op_star
)paren
id|data
suffix:semicolon
r_struct
id|a2065_private
op_star
id|priv
suffix:semicolon
r_struct
id|A2065Board
op_star
id|board
suffix:semicolon
r_int
id|csr0
comma
id|boguscnt
op_assign
l_int|10
suffix:semicolon
r_if
c_cond
(paren
id|dev
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;a2065_interrupt(): irq for unknown device.&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|priv
op_assign
(paren
r_struct
id|a2065_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|board
op_assign
id|priv-&gt;board
suffix:semicolon
id|board-&gt;Lance.RAP
op_assign
id|CSR0
suffix:semicolon
multiline_comment|/* LANCE Controller Status */
r_if
c_cond
(paren
op_logical_neg
(paren
id|board-&gt;Lance.RDP
op_amp
id|INTR
)paren
)paren
multiline_comment|/* Check if any interrupt has&n;&t;&t;&t;&t;&t;   been generated by the board. */
r_return
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;interrupt
)paren
id|printk
c_func
(paren
l_string|&quot;%s: Re-entering the interrupt handler.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|dev-&gt;interrupt
op_assign
l_int|1
suffix:semicolon
r_while
c_loop
(paren
(paren
id|csr0
op_assign
id|board-&gt;Lance.RDP
)paren
op_amp
(paren
id|ERR
op_or
id|RINT
op_or
id|TINT
)paren
op_logical_and
op_decrement
id|boguscnt
op_ge
l_int|0
)paren
(brace
multiline_comment|/* Acknowledge all of the current interrupt sources ASAP. */
id|board-&gt;Lance.RDP
op_assign
id|csr0
op_amp
op_complement
(paren
id|INEA
op_or
id|TDMD
op_or
id|STOP
op_or
id|STRT
op_or
id|INIT
)paren
suffix:semicolon
macro_line|#if 0
r_if
c_cond
(paren
id|a2065_debug
OG
l_int|5
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%s: interrupt  csr0=%#2.2x new csr=%#2.2x.&quot;
comma
id|dev-&gt;name
comma
id|csr0
comma
id|board-&gt;Lance.RDP
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;[&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|csr0
op_amp
id|INTR
)paren
id|printk
c_func
(paren
l_string|&quot; INTR&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|csr0
op_amp
id|INEA
)paren
id|printk
c_func
(paren
l_string|&quot; INEA&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|csr0
op_amp
id|RXON
)paren
id|printk
c_func
(paren
l_string|&quot; RXON&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|csr0
op_amp
id|TXON
)paren
id|printk
c_func
(paren
l_string|&quot; TXON&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|csr0
op_amp
id|TDMD
)paren
id|printk
c_func
(paren
l_string|&quot; TDMD&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|csr0
op_amp
id|STOP
)paren
id|printk
c_func
(paren
l_string|&quot; STOP&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|csr0
op_amp
id|STRT
)paren
id|printk
c_func
(paren
l_string|&quot; STRT&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|csr0
op_amp
id|INIT
)paren
id|printk
c_func
(paren
l_string|&quot; INIT&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|csr0
op_amp
id|ERR
)paren
id|printk
c_func
(paren
l_string|&quot; ERR&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|csr0
op_amp
id|BABL
)paren
id|printk
c_func
(paren
l_string|&quot; BABL&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|csr0
op_amp
id|CERR
)paren
id|printk
c_func
(paren
l_string|&quot; CERR&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|csr0
op_amp
id|MISS
)paren
id|printk
c_func
(paren
l_string|&quot; MISS&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|csr0
op_amp
id|MERR
)paren
id|printk
c_func
(paren
l_string|&quot; MERR&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|csr0
op_amp
id|RINT
)paren
id|printk
c_func
(paren
l_string|&quot; RINT&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|csr0
op_amp
id|TINT
)paren
id|printk
c_func
(paren
l_string|&quot; TINT&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|csr0
op_amp
id|IDON
)paren
id|printk
c_func
(paren
l_string|&quot; IDON&quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot; ]&bslash;n&quot;
)paren
suffix:semicolon
)brace
macro_line|#endif
r_if
c_cond
(paren
id|csr0
op_amp
id|RINT
)paren
multiline_comment|/* Rx interrupt */
id|a2065_rx
c_func
(paren
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|csr0
op_amp
id|TINT
)paren
(brace
multiline_comment|/* Tx-done interrupt */
r_int
id|dirty_tx
op_assign
id|priv-&gt;dirty_tx
suffix:semicolon
r_while
c_loop
(paren
id|dirty_tx
OL
id|priv-&gt;cur_tx
)paren
(brace
r_int
id|entry
op_assign
id|dirty_tx
op_mod
id|TX_RING_SIZE
suffix:semicolon
r_int
id|status
op_assign
id|priv-&gt;tx_ring
(braket
id|entry
)braket
op_member_access_from_pointer
id|TMD1
op_amp
l_int|0xff00
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
id|TF_OWN
)paren
r_break
suffix:semicolon
multiline_comment|/* It still hasn&squot;t been Txed */
id|priv-&gt;tx_ring
(braket
id|entry
)braket
op_member_access_from_pointer
id|TMD1
op_and_assign
l_int|0x00ff
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
id|TF_ERR
)paren
(brace
multiline_comment|/* There was an major error, log it. */
r_int
id|err_status
op_assign
id|priv-&gt;tx_ring
(braket
id|entry
)braket
op_member_access_from_pointer
id|TMD3
suffix:semicolon
id|priv-&gt;stats.tx_errors
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|err_status
op_amp
id|EF_RTRY
)paren
id|priv-&gt;stats.tx_aborted_errors
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|err_status
op_amp
id|EF_LCAR
)paren
id|priv-&gt;stats.tx_carrier_errors
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|err_status
op_amp
id|EF_LCOL
)paren
id|priv-&gt;stats.tx_window_errors
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|err_status
op_amp
id|EF_UFLO
)paren
(brace
multiline_comment|/* Ackk!  On FIFO errors the Tx unit is turned off! */
id|priv-&gt;stats.tx_fifo_errors
op_increment
suffix:semicolon
multiline_comment|/* Remove this verbosity later! */
id|printk
c_func
(paren
l_string|&quot;%s: Tx FIFO error! Status %4.4x.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|csr0
)paren
suffix:semicolon
multiline_comment|/* Restart the chip. */
id|board-&gt;Lance.RDP
op_assign
id|STRT
suffix:semicolon
)brace
)brace
r_else
(brace
r_if
c_cond
(paren
id|status
op_amp
(paren
id|TF_MORE
op_or
id|TF_ONE
)paren
)paren
id|priv-&gt;stats.collisions
op_increment
suffix:semicolon
id|priv-&gt;stats.tx_packets
op_increment
suffix:semicolon
)brace
id|dirty_tx
op_increment
suffix:semicolon
)brace
macro_line|#ifndef final_version
r_if
c_cond
(paren
id|priv-&gt;cur_tx
op_minus
id|dirty_tx
op_ge
id|TX_RING_SIZE
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;out-of-sync dirty pointer, %d vs. %d, full=%d.&bslash;n&quot;
comma
id|dirty_tx
comma
id|priv-&gt;cur_tx
comma
id|priv-&gt;tx_full
)paren
suffix:semicolon
id|dirty_tx
op_add_assign
id|TX_RING_SIZE
suffix:semicolon
)brace
macro_line|#endif
r_if
c_cond
(paren
id|priv-&gt;tx_full
op_logical_and
id|dev-&gt;tbusy
op_logical_and
id|dirty_tx
OG
id|priv-&gt;cur_tx
op_minus
id|TX_RING_SIZE
op_plus
l_int|2
)paren
(brace
multiline_comment|/* The ring is no longer full, clear tbusy. */
id|priv-&gt;tx_full
op_assign
l_int|0
suffix:semicolon
id|dev-&gt;tbusy
op_assign
l_int|0
suffix:semicolon
id|mark_bh
c_func
(paren
id|NET_BH
)paren
suffix:semicolon
)brace
id|priv-&gt;dirty_tx
op_assign
id|dirty_tx
suffix:semicolon
)brace
multiline_comment|/* Log misc errors. */
r_if
c_cond
(paren
id|csr0
op_amp
id|BABL
)paren
id|priv-&gt;stats.tx_errors
op_increment
suffix:semicolon
multiline_comment|/* Tx babble. */
r_if
c_cond
(paren
id|csr0
op_amp
id|MISS
)paren
id|priv-&gt;stats.rx_errors
op_increment
suffix:semicolon
multiline_comment|/* Missed a Rx frame. */
r_if
c_cond
(paren
id|csr0
op_amp
id|MERR
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%s: Bus master arbitration failure, status %4.4x.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|csr0
)paren
suffix:semicolon
multiline_comment|/* Restart the chip. */
id|board-&gt;Lance.RDP
op_assign
id|STRT
suffix:semicolon
)brace
)brace
multiline_comment|/* Clear any other interrupt, and set interrupt enable. */
id|board-&gt;Lance.RAP
op_assign
id|CSR0
suffix:semicolon
multiline_comment|/* LANCE Controller Status */
id|board-&gt;Lance.RDP
op_assign
id|INEA
op_or
id|BABL
op_or
id|CERR
op_or
id|MISS
op_or
id|MERR
op_or
id|IDON
suffix:semicolon
macro_line|#if 0
r_if
c_cond
(paren
id|a2065_debug
OG
l_int|4
)paren
id|printk
c_func
(paren
l_string|&quot;%s: exiting interrupt, csr%d=%#4.4x.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|board-&gt;Lance.RAP
comma
id|board-&gt;Lance.RDP
)paren
suffix:semicolon
macro_line|#endif
id|dev-&gt;interrupt
op_assign
l_int|0
suffix:semicolon
r_return
suffix:semicolon
)brace
DECL|function|a2065_start_xmit
r_static
r_int
id|a2065_start_xmit
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|device
op_star
id|dev
)paren
(brace
r_struct
id|a2065_private
op_star
id|priv
op_assign
(paren
r_struct
id|a2065_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_struct
id|A2065Board
op_star
id|board
op_assign
id|priv-&gt;board
suffix:semicolon
r_int
id|entry
suffix:semicolon
multiline_comment|/* Transmitter timeout, serious problems. */
r_if
c_cond
(paren
id|dev-&gt;tbusy
)paren
(brace
r_int
id|tickssofar
op_assign
id|jiffies
op_minus
id|dev-&gt;trans_start
suffix:semicolon
r_if
c_cond
(paren
id|tickssofar
OL
l_int|20
)paren
r_return
l_int|1
suffix:semicolon
id|board-&gt;Lance.RAP
op_assign
id|CSR0
suffix:semicolon
multiline_comment|/* LANCE Controller Status */
id|printk
c_func
(paren
l_string|&quot;%s: transmit timed out, status %4.4x, resetting.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|board-&gt;Lance.RDP
)paren
suffix:semicolon
id|board-&gt;Lance.RDP
op_assign
id|STOP
suffix:semicolon
multiline_comment|/* Enable big endian byte ordering */
id|board-&gt;Lance.RAP
op_assign
id|CSR3
suffix:semicolon
multiline_comment|/* CSR3 */
id|board-&gt;Lance.RDP
op_assign
id|BSWP
suffix:semicolon
id|priv-&gt;stats.tx_errors
op_increment
suffix:semicolon
macro_line|#ifndef final_version
(brace
r_int
id|i
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot; Ring data dump: dirty_tx %d cur_tx %d%s cur_rx %d.&quot;
comma
id|priv-&gt;dirty_tx
comma
id|priv-&gt;cur_tx
comma
id|priv-&gt;tx_full
ques
c_cond
l_string|&quot; (full)&quot;
suffix:colon
l_string|&quot;&quot;
comma
id|priv-&gt;cur_rx
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|RX_RING_SIZE
suffix:semicolon
id|i
op_increment
)paren
id|printk
c_func
(paren
l_string|&quot;%s %08x %04x %04x&quot;
comma
id|i
op_amp
l_int|0x3
ques
c_cond
l_string|&quot;&quot;
suffix:colon
l_string|&quot;&bslash;n &quot;
comma
(paren
(paren
id|priv-&gt;rx_ring
(braket
id|i
)braket
op_member_access_from_pointer
id|RMD1
)paren
op_lshift
l_int|16
)paren
op_or
id|priv-&gt;rx_ring
(braket
id|i
)braket
op_member_access_from_pointer
id|RMD0
comma
op_minus
id|priv-&gt;rx_ring
(braket
id|i
)braket
op_member_access_from_pointer
id|RMD2
comma
id|priv-&gt;rx_ring
(braket
id|i
)braket
op_member_access_from_pointer
id|RMD3
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|TX_RING_SIZE
suffix:semicolon
id|i
op_increment
)paren
id|printk
c_func
(paren
l_string|&quot;%s %08x %04x %04x&quot;
comma
id|i
op_amp
l_int|0x3
ques
c_cond
l_string|&quot;&quot;
suffix:colon
l_string|&quot;&bslash;n &quot;
comma
(paren
(paren
id|priv-&gt;tx_ring
(braket
id|i
)braket
op_member_access_from_pointer
id|TMD1
)paren
op_lshift
l_int|16
)paren
op_or
id|priv-&gt;tx_ring
(braket
id|i
)braket
op_member_access_from_pointer
id|TMD0
comma
op_minus
id|priv-&gt;tx_ring
(braket
id|i
)braket
op_member_access_from_pointer
id|TMD2
comma
id|priv-&gt;tx_ring
(braket
id|i
)braket
op_member_access_from_pointer
id|TMD3
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
)brace
macro_line|#endif
id|a2065_init_ring
c_func
(paren
id|dev
)paren
suffix:semicolon
id|board-&gt;Lance.RDP
op_assign
id|INEA
op_or
id|INIT
suffix:semicolon
id|dev-&gt;tbusy
op_assign
l_int|0
suffix:semicolon
id|dev-&gt;trans_start
op_assign
id|jiffies
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|skb
op_eq
l_int|NULL
)paren
(brace
id|dev_tint
c_func
(paren
id|dev
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|skb-&gt;len
op_le
l_int|0
)paren
r_return
l_int|0
suffix:semicolon
macro_line|#if 0
r_if
c_cond
(paren
id|a2065_debug
OG
l_int|3
)paren
(brace
id|board-&gt;Lance.RAP
op_assign
id|CSR0
suffix:semicolon
multiline_comment|/* LANCE Controller Status */
id|printk
c_func
(paren
l_string|&quot;%s: a2065_start_xmit() called, csr0 %4.4x.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|board-&gt;Lance.RDP
)paren
suffix:semicolon
id|board-&gt;Lance.RDP
op_assign
l_int|0x0000
suffix:semicolon
)brace
macro_line|#endif
multiline_comment|/*&n;&t; * Block a timer-based transmit from overlapping.  This could better be&n;&t; * done with atomic_swap(1, dev-&gt;tbusy), but set_bit() works as well.&n;&t; */
r_if
c_cond
(paren
id|set_bit
c_func
(paren
l_int|0
comma
(paren
r_void
op_star
)paren
op_amp
id|dev-&gt;tbusy
)paren
op_ne
l_int|0
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%s: Transmitter access conflict.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|set_bit
c_func
(paren
l_int|0
comma
(paren
r_void
op_star
)paren
op_amp
id|priv-&gt;lock
)paren
op_ne
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|a2065_debug
OG
l_int|0
)paren
id|printk
c_func
(paren
l_string|&quot;%s: tx queue lock!.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
multiline_comment|/* don&squot;t clear dev-&gt;tbusy flag. */
r_return
l_int|1
suffix:semicolon
)brace
multiline_comment|/* Fill in a Tx ring entry */
macro_line|#if 0
id|printk
c_func
(paren
l_string|&quot;TX pkt type 0x%04x from &quot;
comma
(paren
(paren
id|u_short
op_star
)paren
id|skb-&gt;data
)paren
(braket
l_int|6
)braket
)paren
suffix:semicolon
(brace
r_int
id|i
suffix:semicolon
id|u_char
op_star
id|ptr
op_assign
op_amp
(paren
(paren
id|u_char
op_star
)paren
id|skb-&gt;data
)paren
(braket
l_int|6
)braket
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|6
suffix:semicolon
id|i
op_increment
)paren
id|printk
c_func
(paren
l_string|&quot;%02x&quot;
comma
id|ptr
(braket
id|i
)braket
)paren
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot; to &quot;
)paren
suffix:semicolon
(brace
r_int
id|i
suffix:semicolon
id|u_char
op_star
id|ptr
op_assign
(paren
id|u_char
op_star
)paren
id|skb-&gt;data
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|6
suffix:semicolon
id|i
op_increment
)paren
id|printk
c_func
(paren
l_string|&quot;%02x&quot;
comma
id|ptr
(braket
id|i
)braket
)paren
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot; data 0x%08x len %d&bslash;n&quot;
comma
(paren
r_int
)paren
id|skb-&gt;data
comma
(paren
r_int
)paren
id|skb-&gt;len
)paren
suffix:semicolon
macro_line|#endif
id|entry
op_assign
id|priv-&gt;cur_tx
op_mod
id|TX_RING_SIZE
suffix:semicolon
id|priv-&gt;tx_ring
(braket
id|entry
)braket
op_member_access_from_pointer
id|TMD2
op_assign
op_minus
(paren
id|ETH_ZLEN
OL
id|skb-&gt;len
ques
c_cond
id|skb-&gt;len
suffix:colon
id|ETH_ZLEN
)paren
suffix:semicolon
id|priv-&gt;tx_ring
(braket
id|entry
)braket
op_member_access_from_pointer
id|TMD3
op_assign
l_int|0x0000
suffix:semicolon
id|memcpy
c_func
(paren
id|priv-&gt;tx_buff
(braket
id|entry
)braket
comma
id|skb-&gt;data
comma
id|skb-&gt;len
)paren
suffix:semicolon
macro_line|#if 0
(brace
r_int
id|i
comma
id|len
suffix:semicolon
id|len
op_assign
id|skb-&gt;len
OG
l_int|64
ques
c_cond
l_int|64
suffix:colon
id|skb-&gt;len
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|len
suffix:semicolon
id|i
op_add_assign
l_int|8
)paren
(brace
r_int
id|j
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;%02x:&quot;
comma
id|i
)paren
suffix:semicolon
r_for
c_loop
(paren
id|j
op_assign
l_int|0
suffix:semicolon
(paren
id|j
OL
l_int|16
)paren
op_logical_and
(paren
(paren
id|i
op_plus
id|j
)paren
OL
id|len
)paren
suffix:semicolon
id|j
op_increment
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|j
op_amp
l_int|1
)paren
)paren
id|printk
c_func
(paren
l_string|&quot; &quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;%02x&quot;
comma
id|priv-&gt;tx_buff
(braket
id|entry
)braket
(braket
id|i
op_plus
id|j
)braket
)paren
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
)brace
)brace
macro_line|#endif
id|priv-&gt;tx_ring
(braket
id|entry
)braket
op_member_access_from_pointer
id|TMD1
op_assign
(paren
id|priv-&gt;tx_ring
(braket
id|entry
)braket
op_member_access_from_pointer
id|TMD1
op_amp
l_int|0x00ff
)paren
op_or
id|TF_OWN
op_or
id|TF_STP
op_or
id|TF_ENP
suffix:semicolon
id|dev_kfree_skb
c_func
(paren
id|skb
comma
id|FREE_WRITE
)paren
suffix:semicolon
id|priv-&gt;cur_tx
op_increment
suffix:semicolon
r_if
c_cond
(paren
(paren
id|priv-&gt;cur_tx
op_ge
id|TX_RING_SIZE
)paren
op_logical_and
(paren
id|priv-&gt;dirty_tx
op_ge
id|TX_RING_SIZE
)paren
)paren
(brace
macro_line|#if 0
id|printk
c_func
(paren
l_string|&quot;*** Subtracting TX_RING_SIZE from cur_tx (%d) and dirty_tx (%d)&bslash;n&quot;
comma
id|priv-&gt;cur_tx
comma
id|priv-&gt;dirty_tx
)paren
suffix:semicolon
macro_line|#endif
id|priv-&gt;cur_tx
op_sub_assign
id|TX_RING_SIZE
suffix:semicolon
id|priv-&gt;dirty_tx
op_sub_assign
id|TX_RING_SIZE
suffix:semicolon
)brace
multiline_comment|/* Trigger an immediate send poll. */
id|board-&gt;Lance.RAP
op_assign
id|CSR0
suffix:semicolon
multiline_comment|/* LANCE Controller Status */
id|board-&gt;Lance.RDP
op_assign
id|INEA
op_or
id|TDMD
suffix:semicolon
id|dev-&gt;trans_start
op_assign
id|jiffies
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|priv-&gt;lock
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
(paren
id|priv-&gt;tx_ring
(braket
(paren
id|entry
op_plus
l_int|1
)paren
op_mod
id|TX_RING_SIZE
)braket
op_member_access_from_pointer
id|TMD1
op_amp
l_int|0xff00
)paren
op_eq
l_int|0
)paren
id|dev-&gt;tbusy
op_assign
l_int|0
suffix:semicolon
r_else
id|priv-&gt;tx_full
op_assign
l_int|1
suffix:semicolon
id|sti
c_func
(paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|a2065_rx
r_static
r_int
id|a2065_rx
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
r_struct
id|a2065_private
op_star
id|priv
op_assign
(paren
r_struct
id|a2065_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_int
id|entry
op_assign
id|priv-&gt;cur_rx
op_mod
id|RX_RING_SIZE
suffix:semicolon
r_int
id|i
suffix:semicolon
multiline_comment|/* If we own the next entry, it&squot;s a new packet. Send it up. */
r_while
c_loop
(paren
op_logical_neg
(paren
id|priv-&gt;rx_ring
(braket
id|entry
)braket
op_member_access_from_pointer
id|RMD1
op_amp
id|RF_OWN
)paren
)paren
(brace
r_int
id|status
op_assign
id|priv-&gt;rx_ring
(braket
id|entry
)braket
op_member_access_from_pointer
id|RMD1
op_amp
l_int|0xff00
suffix:semicolon
r_if
c_cond
(paren
id|status
op_ne
(paren
id|RF_STP
op_or
id|RF_ENP
)paren
)paren
(brace
multiline_comment|/* There was an error. */
multiline_comment|/* There is a tricky error noted by John Murphy,&n;&t;&t;     &lt;murf@perftech.com&gt; to Russ Nelson: Even with full-sized&n;&t;&t;     buffers it&squot;s possible for a jabber packet to use two&n;&t;&t;     buffers, with only the last correctly noting the error. */
r_if
c_cond
(paren
id|status
op_amp
id|RF_ENP
)paren
multiline_comment|/* Only count a general error at the */
id|priv-&gt;stats.rx_errors
op_increment
suffix:semicolon
multiline_comment|/* end of a packet.*/
r_if
c_cond
(paren
id|status
op_amp
id|RF_FRAM
)paren
id|priv-&gt;stats.rx_frame_errors
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
id|RF_OFLO
)paren
id|priv-&gt;stats.rx_over_errors
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
id|RF_CRC
)paren
id|priv-&gt;stats.rx_crc_errors
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
id|RF_BUFF
)paren
id|priv-&gt;stats.rx_fifo_errors
op_increment
suffix:semicolon
id|priv-&gt;rx_ring
(braket
id|entry
)braket
op_member_access_from_pointer
id|RMD1
op_and_assign
l_int|0x00ff
op_or
id|RF_STP
op_or
id|RF_ENP
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* Malloc up new buffer, compatible with net-3. */
r_int
id|pkt_len
op_assign
id|priv-&gt;rx_ring
(braket
id|entry
)braket
op_member_access_from_pointer
id|RMD3
suffix:semicolon
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
r_if
c_cond
(paren
id|pkt_len
OL
l_int|60
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%s: Runt packet!&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|priv-&gt;stats.rx_errors
op_increment
suffix:semicolon
)brace
r_else
(brace
id|skb
op_assign
id|dev_alloc_skb
c_func
(paren
id|pkt_len
op_plus
l_int|2
)paren
suffix:semicolon
r_if
c_cond
(paren
id|skb
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%s: Memory squeeze, deferring packet.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|RX_RING_SIZE
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
id|priv-&gt;rx_ring
(braket
(paren
id|entry
op_plus
id|i
)paren
op_mod
id|RX_RING_SIZE
)braket
op_member_access_from_pointer
id|RMD1
op_amp
id|RF_OWN
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
id|i
OG
id|RX_RING_SIZE
op_minus
l_int|2
)paren
(brace
id|priv-&gt;stats.rx_dropped
op_increment
suffix:semicolon
id|priv-&gt;rx_ring
(braket
id|entry
)braket
op_member_access_from_pointer
id|RMD1
op_or_assign
id|RF_OWN
suffix:semicolon
id|priv-&gt;cur_rx
op_increment
suffix:semicolon
)brace
r_break
suffix:semicolon
)brace
id|skb-&gt;dev
op_assign
id|dev
suffix:semicolon
id|skb_reserve
c_func
(paren
id|skb
comma
l_int|2
)paren
suffix:semicolon
multiline_comment|/* 16 byte align */
id|skb_put
c_func
(paren
id|skb
comma
id|pkt_len
)paren
suffix:semicolon
multiline_comment|/* Make room */
id|eth_copy_and_sum
c_func
(paren
id|skb
comma
id|priv-&gt;rx_buff
(braket
id|entry
)braket
comma
id|pkt_len
comma
l_int|0
)paren
suffix:semicolon
id|skb-&gt;protocol
op_assign
id|eth_type_trans
c_func
(paren
id|skb
comma
id|dev
)paren
suffix:semicolon
macro_line|#if 0
id|printk
c_func
(paren
l_string|&quot;RX pkt type 0x%04x from &quot;
comma
(paren
(paren
id|u_short
op_star
)paren
id|skb-&gt;data
)paren
(braket
l_int|6
)braket
)paren
suffix:semicolon
(brace
r_int
id|i
suffix:semicolon
id|u_char
op_star
id|ptr
op_assign
op_amp
(paren
(paren
id|u_char
op_star
)paren
id|skb-&gt;data
)paren
(braket
l_int|6
)braket
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|6
suffix:semicolon
id|i
op_increment
)paren
id|printk
c_func
(paren
l_string|&quot;%02x&quot;
comma
id|ptr
(braket
id|i
)braket
)paren
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot; to &quot;
)paren
suffix:semicolon
(brace
r_int
id|i
suffix:semicolon
id|u_char
op_star
id|ptr
op_assign
(paren
id|u_char
op_star
)paren
id|skb-&gt;data
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|6
suffix:semicolon
id|i
op_increment
)paren
id|printk
c_func
(paren
l_string|&quot;%02x&quot;
comma
id|ptr
(braket
id|i
)braket
)paren
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot; data 0x%08x len %d&bslash;n&quot;
comma
(paren
r_int
)paren
id|skb-&gt;data
comma
(paren
r_int
)paren
id|skb-&gt;len
)paren
suffix:semicolon
macro_line|#endif
id|netif_rx
c_func
(paren
id|skb
)paren
suffix:semicolon
id|priv-&gt;stats.rx_packets
op_increment
suffix:semicolon
)brace
)brace
id|priv-&gt;rx_ring
(braket
id|entry
)braket
op_member_access_from_pointer
id|RMD1
op_or_assign
id|RF_OWN
suffix:semicolon
id|entry
op_assign
(paren
op_increment
id|priv-&gt;cur_rx
)paren
op_mod
id|RX_RING_SIZE
suffix:semicolon
)brace
id|priv-&gt;cur_rx
op_assign
id|priv-&gt;cur_rx
op_mod
id|RX_RING_SIZE
suffix:semicolon
multiline_comment|/* We should check that at least two ring entries are free.&n;&t;   If not, we should free one and mark stats-&gt;rx_dropped++. */
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|a2065_get_stats
r_static
r_struct
id|enet_statistics
op_star
id|a2065_get_stats
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
r_struct
id|a2065_private
op_star
id|priv
op_assign
(paren
r_struct
id|a2065_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_return
op_amp
id|priv-&gt;stats
suffix:semicolon
)brace
multiline_comment|/* Set or clear the multicast filter for this adaptor.&n; */
DECL|function|set_multicast_list
r_static
r_void
id|set_multicast_list
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
r_struct
id|a2065_private
op_star
id|priv
op_assign
(paren
r_struct
id|a2065_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_struct
id|A2065Board
op_star
id|board
op_assign
id|priv-&gt;board
suffix:semicolon
r_struct
id|lancedata
op_star
id|alancedata
suffix:semicolon
multiline_comment|/* Amiga point of view */
id|alancedata
op_assign
(paren
r_struct
id|lancedata
op_star
)paren
id|board-&gt;RAM
suffix:semicolon
multiline_comment|/* We take the simple way out and always enable promiscuous mode. */
id|board-&gt;Lance.RAP
op_assign
id|CSR0
suffix:semicolon
multiline_comment|/* LANCE Controller Status */
id|board-&gt;Lance.RDP
op_assign
id|STOP
suffix:semicolon
multiline_comment|/* Temporarily stop the lance. */
multiline_comment|/* Enable big endian byte ordering */
id|board-&gt;Lance.RAP
op_assign
id|CSR3
suffix:semicolon
multiline_comment|/* CSR3 */
id|board-&gt;Lance.RDP
op_assign
id|BSWP
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;flags
op_amp
id|IFF_PROMISC
)paren
(brace
multiline_comment|/* Log any net taps. */
id|printk
c_func
(paren
l_string|&quot;%s: Promiscuous mode enabled.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|alancedata-&gt;init.Mode
op_assign
id|PROM
suffix:semicolon
multiline_comment|/* Set promiscuous mode */
)brace
r_else
(brace
r_int
id|multicast_table
(braket
l_int|4
)braket
suffix:semicolon
r_int
id|num_addrs
op_assign
id|dev-&gt;mc_count
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;flags
op_amp
id|IFF_ALLMULTI
)paren
(brace
id|num_addrs
op_assign
l_int|1
suffix:semicolon
)brace
multiline_comment|/*&n;&t;   * We don&squot;t use the multicast table,&n;&t;   * but rely on upper-layer filtering.&n;&t;   */
id|memset
c_func
(paren
id|multicast_table
comma
(paren
id|num_addrs
op_eq
l_int|0
)paren
ques
c_cond
l_int|0
suffix:colon
op_minus
l_int|1
comma
r_sizeof
(paren
id|multicast_table
)paren
)paren
suffix:semicolon
id|alancedata-&gt;init.LADRF
(braket
l_int|0
)braket
op_assign
id|multicast_table
(braket
l_int|0
)braket
op_lshift
l_int|16
op_or
id|multicast_table
(braket
l_int|1
)braket
suffix:semicolon
id|alancedata-&gt;init.LADRF
(braket
l_int|1
)braket
op_assign
id|multicast_table
(braket
l_int|2
)braket
op_lshift
l_int|16
op_or
id|multicast_table
(braket
l_int|3
)braket
suffix:semicolon
id|alancedata-&gt;init.Mode
op_assign
l_int|0x0000
suffix:semicolon
)brace
id|board-&gt;Lance.RAP
op_assign
id|CSR0
suffix:semicolon
multiline_comment|/* LANCE Controller Status */
id|board-&gt;Lance.RDP
op_assign
id|INEA
op_or
id|STRT
op_or
id|IDON
op_or
id|INIT
suffix:semicolon
multiline_comment|/* Resume normal operation. */
)brace
eof
