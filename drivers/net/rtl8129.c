multiline_comment|/* rtl8129.c: A RealTek RTL8129 Fast Ethernet driver for Linux. */
multiline_comment|/*&n;&t;Written 1997-1999 by Donald Becker.&n;&n;&t;This software may be used and distributed according to the terms&n;&t;of the GNU Public License, incorporated herein by reference.&n;    All other rights reserved.&n;&n;&t;This driver is for boards based on the RTL8129 PCI ethernet chip.&n;&n;&t;The author may be reached as becker@CESDIS.gsfc.nasa.gov, or C/O&n;&t;Center of Excellence in Space Data and Information Sciences&n;&t;   Code 930.5, Goddard Space Flight Center, Greenbelt MD 20771&n;&n;&t;Support and updates available at&n;&t;http://cesdis.gsfc.nasa.gov/linux/drivers/rtl8139.html&n;&n;&t;Twister-tuning table provided by Kinston &lt;shangh@realtek.com.tw&gt;.&n;*/
DECL|variable|version
r_static
r_const
r_char
op_star
id|version
op_assign
l_string|&quot;rtl8129.c:v1.07 5/6/99 Donald Becker http://cesdis.gsfc.nasa.gov/linux/drivers/rtl8139.html&bslash;n&quot;
suffix:semicolon
multiline_comment|/* A few user-configurable values. */
multiline_comment|/* Maximum events (Rx packets, etc.) to handle at each interrupt. */
DECL|variable|max_interrupt_work
r_static
r_int
id|max_interrupt_work
op_assign
l_int|20
suffix:semicolon
DECL|macro|rtl8129_debug
mdefine_line|#define rtl8129_debug debug
DECL|variable|rtl8129_debug
r_static
r_int
id|rtl8129_debug
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* Maximum number of multicast addresses to filter (vs. Rx-all-multicast).&n;   The RTL chips use a 64 element hash table based on the Ethernet CRC.  */
DECL|variable|multicast_filter_limit
r_static
r_int
id|multicast_filter_limit
op_assign
l_int|32
suffix:semicolon
multiline_comment|/* Used to pass the full-duplex flag, etc. */
DECL|macro|MAX_UNITS
mdefine_line|#define MAX_UNITS 8&t;&t;/* More are supported, limit only on options */
DECL|variable|options
r_static
r_int
id|options
(braket
id|MAX_UNITS
)braket
op_assign
(brace
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
)brace
suffix:semicolon
DECL|variable|full_duplex
r_static
r_int
id|full_duplex
(braket
id|MAX_UNITS
)braket
op_assign
(brace
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
)brace
suffix:semicolon
multiline_comment|/* Size of the in-memory receive ring. */
DECL|macro|RX_BUF_LEN_IDX
mdefine_line|#define RX_BUF_LEN_IDX&t;3&t;&t;&t;/* 0==8K, 1==16K, 2==32K, 3==64K */
DECL|macro|RX_BUF_LEN
mdefine_line|#define RX_BUF_LEN (8192 &lt;&lt; RX_BUF_LEN_IDX)
multiline_comment|/* Size of the Tx bounce buffers -- must be at least (dev-&gt;mtu+14+4). */
DECL|macro|TX_BUF_SIZE
mdefine_line|#define TX_BUF_SIZE&t;1536
multiline_comment|/* PCI Tuning Parameters&n;   Threshold is bytes transferred to chip before transmission starts. */
DECL|macro|TX_FIFO_THRESH
mdefine_line|#define TX_FIFO_THRESH 256&t;/* In bytes, rounded down to 32 byte units. */
multiline_comment|/* The following settings are log_2(bytes)-4:  0 == 16 bytes .. 6==1024. */
DECL|macro|RX_FIFO_THRESH
mdefine_line|#define RX_FIFO_THRESH&t;4&t;&t;/* Rx buffer level before first PCI xfer.  */
DECL|macro|RX_DMA_BURST
mdefine_line|#define RX_DMA_BURST&t;4&t;&t;/* Maximum PCI burst, &squot;4&squot; is 256 bytes */
DECL|macro|TX_DMA_BURST
mdefine_line|#define TX_DMA_BURST&t;4&t;&t;/* Calculate as 16&lt;&lt;val. */
multiline_comment|/* Operational parameters that usually are not changed. */
multiline_comment|/* Time in jiffies before concluding the transmitter is hung. */
DECL|macro|TX_TIMEOUT
mdefine_line|#define TX_TIMEOUT  (4*HZ)
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/version.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/timer.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/ioport.h&gt;
macro_line|#include &lt;linux/malloc.h&gt;
macro_line|#include &lt;linux/interrupt.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/pci.h&gt;
macro_line|#include &lt;linux/netdevice.h&gt;
macro_line|#include &lt;linux/etherdevice.h&gt;
macro_line|#include &lt;linux/skbuff.h&gt;
macro_line|#include &lt;asm/processor.h&gt;&t;&t;/* Processor type for cache alignment. */
macro_line|#include &lt;asm/bitops.h&gt;
macro_line|#include &lt;asm/io.h&gt;
multiline_comment|/* Kernel compatibility defines, some common to David Hind&squot;s PCMCIA package.&n;   This is only in the support-all-kernels source code. */
DECL|macro|RUN_AT
mdefine_line|#define RUN_AT(x) (jiffies + (x))
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#if LINUX_VERSION_CODE &lt; 0x20123
DECL|macro|test_and_set_bit
mdefine_line|#define test_and_set_bit(val, addr) set_bit(val, addr)
macro_line|#endif
macro_line|#if LINUX_VERSION_CODE &lt;= 0x20139
DECL|macro|net_device_stats
mdefine_line|#define&t;net_device_stats enet_statistics
macro_line|#else
DECL|macro|NETSTATS_VER2
mdefine_line|#define NETSTATS_VER2
macro_line|#endif
macro_line|#if LINUX_VERSION_CODE &lt; 0x20155  ||  defined(CARDBUS)
multiline_comment|/* Grrrr, the PCI code changed, but did not consider CardBus... */
macro_line|#include &lt;linux/bios32.h&gt;
DECL|macro|PCI_SUPPORT_VER1
mdefine_line|#define PCI_SUPPORT_VER1
macro_line|#else
DECL|macro|PCI_SUPPORT_VER2
mdefine_line|#define PCI_SUPPORT_VER2
macro_line|#endif
multiline_comment|/* The I/O extent. */
DECL|macro|RTL8129_TOTAL_SIZE
mdefine_line|#define RTL8129_TOTAL_SIZE 0x80
multiline_comment|/*&n;&t;&t;&t;&t;Theory of Operation&n;&n;I. Board Compatibility&n;&n;This device driver is designed for the RealTek RTL8129, the RealTek Fast&n;Ethernet controllers for PCI.  This chip is used on a few clone boards.&n;&n;&n;II. Board-specific settings&n;&n;PCI bus devices are configured by the system at boot time, so no jumpers&n;need to be set on the board.  The system BIOS will assign the&n;PCI INTA signal to a (preferably otherwise unused) system IRQ line.&n;Note: Kernel versions earlier than 1.3.73 do not support shared PCI&n;interrupt lines.&n;&n;III. Driver operation&n;&n;IIIa. Rx Ring buffers&n;&n;The receive unit uses a single linear ring buffer rather than the more&n;common (and more efficient) descriptor-based architecture.  Incoming frames&n;are sequentially stored into the Rx region, and the host copies them into&n;skbuffs.&n;&n;Comment: While it is theoretically possible to process many frames in place,&n;any delay in Rx processing would cause us to drop frames.  More importantly,&n;the Linux protocol stack is not designed to operate in this manner.&n;&n;IIIb. Tx operation&n;&n;The RTL8129 uses a fixed set of four Tx descriptors in register space.&n;In a stunningly bad design choice, Tx frames must be 32 bit aligned.  Linux&n;aligns the IP header on word boundaries, and 14 byte ethernet header means&n;that almost all frames will need to be copied to an alignment buffer.&n;&n;IVb. References&n;&n;http://www.realtek.com.tw/cn/cn.html&n;http://cesdis.gsfc.nasa.gov/linux/misc/NWay.html&n;&n;IVc. Errata&n;&n;*/
"&f;"
multiline_comment|/* This table drives the PCI probe routines.  It&squot;s mostly boilerplate in all&n;   of the drivers, and will likely be provided by some future kernel.&n;   Note the matching code -- the first table entry matchs all 56** cards but&n;   second only the 1234 card.&n;*/
DECL|enum|pci_flags_bit
r_enum
id|pci_flags_bit
(brace
DECL|enumerator|PCI_USES_IO
DECL|enumerator|PCI_USES_MEM
DECL|enumerator|PCI_USES_MASTER
id|PCI_USES_IO
op_assign
l_int|1
comma
id|PCI_USES_MEM
op_assign
l_int|2
comma
id|PCI_USES_MASTER
op_assign
l_int|4
comma
DECL|enumerator|PCI_ADDR0
DECL|enumerator|PCI_ADDR1
DECL|enumerator|PCI_ADDR2
DECL|enumerator|PCI_ADDR3
id|PCI_ADDR0
op_assign
l_int|0x10
op_lshift
l_int|0
comma
id|PCI_ADDR1
op_assign
l_int|0x10
op_lshift
l_int|1
comma
id|PCI_ADDR2
op_assign
l_int|0x10
op_lshift
l_int|2
comma
id|PCI_ADDR3
op_assign
l_int|0x10
op_lshift
l_int|3
comma
)brace
suffix:semicolon
DECL|struct|pci_id_info
r_struct
id|pci_id_info
(brace
DECL|member|name
r_const
r_char
op_star
id|name
suffix:semicolon
DECL|member|vendor_id
DECL|member|device_id
DECL|member|device_id_mask
DECL|member|flags
id|u16
id|vendor_id
comma
id|device_id
comma
id|device_id_mask
comma
id|flags
suffix:semicolon
DECL|member|io_size
r_int
id|io_size
suffix:semicolon
DECL|member|probe1
r_struct
id|net_device
op_star
(paren
op_star
id|probe1
)paren
(paren
r_struct
id|pci_dev
op_star
id|pdev
comma
r_int
id|pci_bus
comma
r_int
id|pci_devfn
comma
r_int
id|ioaddr
comma
r_int
id|irq
comma
r_int
id|chip_idx
comma
r_int
id|fnd_cnt
)paren
suffix:semicolon
)brace
suffix:semicolon
r_static
r_struct
id|net_device
op_star
id|rtl8129_probe1
c_func
(paren
r_struct
id|pci_dev
op_star
id|pdev
comma
r_int
id|pci_bus
comma
r_int
id|pci_devfn
comma
r_int
id|ioaddr
comma
r_int
id|irq
comma
r_int
id|chp_idx
comma
r_int
id|fnd_cnt
)paren
suffix:semicolon
DECL|variable|pci_tbl
r_static
r_struct
id|pci_id_info
id|pci_tbl
(braket
)braket
op_assign
(brace
(brace
l_string|&quot;RealTek RTL8129 Fast Ethernet&quot;
comma
l_int|0x10ec
comma
l_int|0x8129
comma
l_int|0xffff
comma
id|PCI_USES_IO
op_or
id|PCI_USES_MASTER
comma
l_int|0x80
comma
id|rtl8129_probe1
)brace
comma
macro_line|#ifdef USE_8139_SUPPORT_ALSO
(brace
l_string|&quot;RealTek RTL8139 Fast Ethernet&quot;
comma
l_int|0x10ec
comma
l_int|0x8139
comma
l_int|0xffff
comma
id|PCI_USES_IO
op_or
id|PCI_USES_MASTER
comma
l_int|0x80
comma
id|rtl8129_probe1
)brace
comma
(brace
l_string|&quot;SMC1211TX EZCard 10/100 (RealTek RTL8139)&quot;
comma
l_int|0x1113
comma
l_int|0x1211
comma
l_int|0xffff
comma
id|PCI_USES_IO
op_or
id|PCI_USES_MASTER
comma
l_int|0x80
comma
id|rtl8129_probe1
)brace
comma
(brace
l_string|&quot;Accton MPX5030 (RealTek RTL8139)&quot;
comma
l_int|0x1113
comma
l_int|0x1211
comma
l_int|0xffff
comma
id|PCI_USES_IO
op_or
id|PCI_USES_MASTER
comma
l_int|0x80
comma
id|rtl8129_probe1
)brace
comma
macro_line|#endif
(brace
l_int|0
comma
)brace
comma
multiline_comment|/* 0 terminated list. */
)brace
suffix:semicolon
multiline_comment|/* The capability table matches the chip table above. */
DECL|enumerator|HAS_MII_XCVR
DECL|enumerator|HAS_CHIP_XCVR
DECL|enumerator|HAS_LNK_CHNG
r_enum
(brace
id|HAS_MII_XCVR
op_assign
l_int|0x01
comma
id|HAS_CHIP_XCVR
op_assign
l_int|0x02
comma
id|HAS_LNK_CHNG
op_assign
l_int|0x04
)brace
suffix:semicolon
DECL|variable|rtl_cap_tbl
r_static
r_int
id|rtl_cap_tbl
(braket
)braket
op_assign
(brace
id|HAS_MII_XCVR
comma
id|HAS_CHIP_XCVR
op_or
id|HAS_LNK_CHNG
comma
id|HAS_CHIP_XCVR
op_or
id|HAS_LNK_CHNG
comma
)brace
suffix:semicolon
multiline_comment|/* The rest of these values should never change. */
DECL|macro|NUM_TX_DESC
mdefine_line|#define NUM_TX_DESC&t;4&t;&t;&t;/* Number of Tx descriptor registers. */
multiline_comment|/* Symbolic offsets to registers. */
DECL|enum|RTL8129_registers
r_enum
id|RTL8129_registers
(brace
DECL|enumerator|MAC0
id|MAC0
op_assign
l_int|0
comma
multiline_comment|/* Ethernet hardware address. */
DECL|enumerator|MAR0
id|MAR0
op_assign
l_int|8
comma
multiline_comment|/* Multicast filter. */
DECL|enumerator|TxStatus0
id|TxStatus0
op_assign
l_int|0x10
comma
multiline_comment|/* Transmit status (Four 32bit registers). */
DECL|enumerator|TxAddr0
id|TxAddr0
op_assign
l_int|0x20
comma
multiline_comment|/* Tx descriptors (also four 32bit). */
DECL|enumerator|RxBuf
DECL|enumerator|RxEarlyCnt
DECL|enumerator|RxEarlyStatus
id|RxBuf
op_assign
l_int|0x30
comma
id|RxEarlyCnt
op_assign
l_int|0x34
comma
id|RxEarlyStatus
op_assign
l_int|0x36
comma
DECL|enumerator|ChipCmd
DECL|enumerator|RxBufPtr
DECL|enumerator|RxBufAddr
id|ChipCmd
op_assign
l_int|0x37
comma
id|RxBufPtr
op_assign
l_int|0x38
comma
id|RxBufAddr
op_assign
l_int|0x3A
comma
DECL|enumerator|IntrMask
DECL|enumerator|IntrStatus
id|IntrMask
op_assign
l_int|0x3C
comma
id|IntrStatus
op_assign
l_int|0x3E
comma
DECL|enumerator|TxConfig
DECL|enumerator|RxConfig
id|TxConfig
op_assign
l_int|0x40
comma
id|RxConfig
op_assign
l_int|0x44
comma
DECL|enumerator|Timer
id|Timer
op_assign
l_int|0x48
comma
multiline_comment|/* A general-purpose counter. */
DECL|enumerator|RxMissed
id|RxMissed
op_assign
l_int|0x4C
comma
multiline_comment|/* 24 bits valid, write clears. */
DECL|enumerator|Cfg9346
DECL|enumerator|Config0
DECL|enumerator|Config1
id|Cfg9346
op_assign
l_int|0x50
comma
id|Config0
op_assign
l_int|0x51
comma
id|Config1
op_assign
l_int|0x52
comma
DECL|enumerator|FlashReg
DECL|enumerator|GPPinData
DECL|enumerator|GPPinDir
DECL|enumerator|MII_SMI
DECL|enumerator|HltClk
id|FlashReg
op_assign
l_int|0x54
comma
id|GPPinData
op_assign
l_int|0x58
comma
id|GPPinDir
op_assign
l_int|0x59
comma
id|MII_SMI
op_assign
l_int|0x5A
comma
id|HltClk
op_assign
l_int|0x5B
comma
DECL|enumerator|MultiIntr
DECL|enumerator|TxSummary
id|MultiIntr
op_assign
l_int|0x5C
comma
id|TxSummary
op_assign
l_int|0x60
comma
DECL|enumerator|MII_BMCR
DECL|enumerator|MII_BMSR
DECL|enumerator|NWayAdvert
DECL|enumerator|NWayLPAR
id|MII_BMCR
op_assign
l_int|0x62
comma
id|MII_BMSR
op_assign
l_int|0x64
comma
id|NWayAdvert
op_assign
l_int|0x66
comma
id|NWayLPAR
op_assign
l_int|0x68
comma
DECL|enumerator|NWayExpansion
id|NWayExpansion
op_assign
l_int|0x6A
comma
multiline_comment|/* Undocumented registers, but required for proper operation. */
DECL|enumerator|FIFOTMS
id|FIFOTMS
op_assign
l_int|0x70
comma
multiline_comment|/* FIFO Test Mode Select */
DECL|enumerator|CSCR
id|CSCR
op_assign
l_int|0x74
comma
multiline_comment|/* Chip Status and Configuration Register. */
DECL|enumerator|PARA78
DECL|enumerator|PARA7c
id|PARA78
op_assign
l_int|0x78
comma
id|PARA7c
op_assign
l_int|0x7c
comma
multiline_comment|/* Magic transceiver parameter register. */
)brace
suffix:semicolon
DECL|enum|ChipCmdBits
r_enum
id|ChipCmdBits
(brace
DECL|enumerator|CmdReset
DECL|enumerator|CmdRxEnb
DECL|enumerator|CmdTxEnb
DECL|enumerator|RxBufEmpty
id|CmdReset
op_assign
l_int|0x10
comma
id|CmdRxEnb
op_assign
l_int|0x08
comma
id|CmdTxEnb
op_assign
l_int|0x04
comma
id|RxBufEmpty
op_assign
l_int|0x01
comma
)brace
suffix:semicolon
multiline_comment|/* Interrupt register bits, using my own meaningful names. */
DECL|enum|IntrStatusBits
r_enum
id|IntrStatusBits
(brace
DECL|enumerator|PCIErr
DECL|enumerator|PCSTimeout
id|PCIErr
op_assign
l_int|0x8000
comma
id|PCSTimeout
op_assign
l_int|0x4000
comma
DECL|enumerator|RxFIFOOver
DECL|enumerator|RxUnderrun
DECL|enumerator|RxOverflow
id|RxFIFOOver
op_assign
l_int|0x40
comma
id|RxUnderrun
op_assign
l_int|0x20
comma
id|RxOverflow
op_assign
l_int|0x10
comma
DECL|enumerator|TxErr
DECL|enumerator|TxOK
DECL|enumerator|RxErr
DECL|enumerator|RxOK
id|TxErr
op_assign
l_int|0x08
comma
id|TxOK
op_assign
l_int|0x04
comma
id|RxErr
op_assign
l_int|0x02
comma
id|RxOK
op_assign
l_int|0x01
comma
)brace
suffix:semicolon
DECL|enum|TxStatusBits
r_enum
id|TxStatusBits
(brace
DECL|enumerator|TxHostOwns
DECL|enumerator|TxUnderrun
DECL|enumerator|TxStatOK
id|TxHostOwns
op_assign
l_int|0x2000
comma
id|TxUnderrun
op_assign
l_int|0x4000
comma
id|TxStatOK
op_assign
l_int|0x8000
comma
DECL|enumerator|TxOutOfWindow
DECL|enumerator|TxAborted
DECL|enumerator|TxCarrierLost
id|TxOutOfWindow
op_assign
l_int|0x20000000
comma
id|TxAborted
op_assign
l_int|0x40000000
comma
id|TxCarrierLost
op_assign
l_int|0x80000000
comma
)brace
suffix:semicolon
DECL|enum|RxStatusBits
r_enum
id|RxStatusBits
(brace
DECL|enumerator|RxMulticast
DECL|enumerator|RxPhysical
DECL|enumerator|RxBroadcast
id|RxMulticast
op_assign
l_int|0x8000
comma
id|RxPhysical
op_assign
l_int|0x4000
comma
id|RxBroadcast
op_assign
l_int|0x2000
comma
DECL|enumerator|RxBadSymbol
DECL|enumerator|RxRunt
DECL|enumerator|RxTooLong
DECL|enumerator|RxCRCErr
id|RxBadSymbol
op_assign
l_int|0x0020
comma
id|RxRunt
op_assign
l_int|0x0010
comma
id|RxTooLong
op_assign
l_int|0x0008
comma
id|RxCRCErr
op_assign
l_int|0x0004
comma
DECL|enumerator|RxBadAlign
DECL|enumerator|RxStatusOK
id|RxBadAlign
op_assign
l_int|0x0002
comma
id|RxStatusOK
op_assign
l_int|0x0001
comma
)brace
suffix:semicolon
multiline_comment|/* Twister tuning parameters from RealTek.&n;   Completely undocumented, but required to tune bad links. */
DECL|enum|CSCRBits
r_enum
id|CSCRBits
(brace
DECL|enumerator|CSCR_LinkOKBit
DECL|enumerator|CSCR_LinkChangeBit
id|CSCR_LinkOKBit
op_assign
l_int|0x0400
comma
id|CSCR_LinkChangeBit
op_assign
l_int|0x0800
comma
DECL|enumerator|CSCR_LinkStatusBits
DECL|enumerator|CSCR_LinkDownOffCmd
id|CSCR_LinkStatusBits
op_assign
l_int|0x0f000
comma
id|CSCR_LinkDownOffCmd
op_assign
l_int|0x003c0
comma
DECL|enumerator|CSCR_LinkDownCmd
id|CSCR_LinkDownCmd
op_assign
l_int|0x0f3c0
comma
)brace
suffix:semicolon
DECL|variable|param
r_static
r_const
r_int
r_int
id|param
(braket
l_int|4
)braket
(braket
l_int|4
)braket
op_assign
initialization_block
suffix:semicolon
DECL|struct|ring_info
r_struct
id|ring_info
(brace
DECL|member|skb
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
DECL|member|mapping
id|dma_addr_t
id|mapping
suffix:semicolon
)brace
suffix:semicolon
DECL|struct|rtl8129_private
r_struct
id|rtl8129_private
(brace
DECL|member|devname
r_char
id|devname
(braket
l_int|8
)braket
suffix:semicolon
multiline_comment|/* Used only for kernel debugging. */
DECL|member|product_name
r_const
r_char
op_star
id|product_name
suffix:semicolon
DECL|member|next_module
r_struct
id|net_device
op_star
id|next_module
suffix:semicolon
DECL|member|pdev
r_struct
id|pci_dev
op_star
id|pdev
suffix:semicolon
DECL|member|chip_id
r_int
id|chip_id
suffix:semicolon
DECL|member|chip_revision
r_int
id|chip_revision
suffix:semicolon
DECL|member|pci_bus
DECL|member|pci_devfn
r_int
r_char
id|pci_bus
comma
id|pci_devfn
suffix:semicolon
DECL|member|stats
r_struct
id|net_device_stats
id|stats
suffix:semicolon
DECL|member|timer
r_struct
id|timer_list
id|timer
suffix:semicolon
multiline_comment|/* Media selection timer. */
DECL|member|cur_rx
r_int
r_int
id|cur_rx
suffix:semicolon
multiline_comment|/* Index into the Rx buffer of next Rx pkt. */
DECL|member|cur_tx
DECL|member|dirty_tx
DECL|member|tx_flag
r_int
r_int
id|cur_tx
comma
id|dirty_tx
comma
id|tx_flag
suffix:semicolon
multiline_comment|/* The saved address of a sent-in-place packet/buffer, for skfree(). */
DECL|member|tx_info
r_struct
id|ring_info
id|tx_info
(braket
id|NUM_TX_DESC
)braket
suffix:semicolon
DECL|member|tx_buf
r_int
r_char
op_star
id|tx_buf
(braket
id|NUM_TX_DESC
)braket
suffix:semicolon
multiline_comment|/* Tx bounce buffers */
DECL|member|rx_ring
r_int
r_char
op_star
id|rx_ring
suffix:semicolon
DECL|member|tx_bufs
r_int
r_char
op_star
id|tx_bufs
suffix:semicolon
multiline_comment|/* Tx bounce buffer region. */
DECL|member|rx_ring_dma
id|dma_addr_t
id|rx_ring_dma
suffix:semicolon
DECL|member|tx_bufs_dma
id|dma_addr_t
id|tx_bufs_dma
suffix:semicolon
DECL|member|phys
r_char
id|phys
(braket
l_int|4
)braket
suffix:semicolon
multiline_comment|/* MII device addresses. */
DECL|member|twistie
DECL|member|twist_cnt
r_char
id|twistie
comma
id|twist_cnt
suffix:semicolon
multiline_comment|/* Twister tune state. */
DECL|member|tx_full
r_int
r_int
id|tx_full
suffix:colon
l_int|1
suffix:semicolon
multiline_comment|/* The Tx queue is full. */
DECL|member|full_duplex
r_int
r_int
id|full_duplex
suffix:colon
l_int|1
suffix:semicolon
multiline_comment|/* Full-duplex operation requested. */
DECL|member|duplex_lock
r_int
r_int
id|duplex_lock
suffix:colon
l_int|1
suffix:semicolon
DECL|member|default_port
r_int
r_int
id|default_port
suffix:colon
l_int|4
suffix:semicolon
multiline_comment|/* Last dev-&gt;if_port value. */
DECL|member|media2
r_int
r_int
id|media2
suffix:colon
l_int|4
suffix:semicolon
multiline_comment|/* Secondary monitored media port. */
DECL|member|medialock
r_int
r_int
id|medialock
suffix:colon
l_int|1
suffix:semicolon
multiline_comment|/* Don&squot;t sense media type. */
DECL|member|mediasense
r_int
r_int
id|mediasense
suffix:colon
l_int|1
suffix:semicolon
multiline_comment|/* Media sensing in progress. */
)brace
suffix:semicolon
id|MODULE_AUTHOR
c_func
(paren
l_string|&quot;Donald Becker &lt;becker@cesdis.gsfc.nasa.gov&gt;&quot;
)paren
suffix:semicolon
id|MODULE_DESCRIPTION
c_func
(paren
l_string|&quot;RealTek RTL8129 Fast Ethernet driver&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|options
comma
l_string|&quot;1-&quot;
id|__MODULE_STRING
c_func
(paren
id|MAX_UNITS
)paren
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|full_duplex
comma
l_string|&quot;1-&quot;
id|__MODULE_STRING
c_func
(paren
id|MAX_UNITS
)paren
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|multicast_filter_limit
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|max_interrupt_work
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|debug
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
r_static
r_int
id|rtl8129_open
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_int
id|read_eeprom
c_func
(paren
r_int
id|ioaddr
comma
r_int
id|location
)paren
suffix:semicolon
r_static
r_int
id|mdio_read
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_int
id|phy_id
comma
r_int
id|location
)paren
suffix:semicolon
r_static
r_void
id|mdio_write
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_int
id|phy_id
comma
r_int
id|location
comma
r_int
id|val
)paren
suffix:semicolon
r_static
r_void
id|rtl8129_timer
c_func
(paren
r_int
r_int
id|data
)paren
suffix:semicolon
r_static
r_void
id|rtl8129_tx_timeout
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_void
id|rtl8129_init_ring
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_int
id|rtl8129_start_xmit
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_int
id|rtl8129_rx
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_void
id|rtl8129_interrupt
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_instance
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
suffix:semicolon
r_static
r_int
id|rtl8129_close
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_int
id|mii_ioctl
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_struct
id|ifreq
op_star
id|rq
comma
r_int
id|cmd
)paren
suffix:semicolon
r_static
r_struct
id|net_device_stats
op_star
id|rtl8129_get_stats
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_inline
id|u32
id|ether_crc
c_func
(paren
r_int
id|length
comma
r_int
r_char
op_star
id|data
)paren
suffix:semicolon
r_static
r_void
id|set_rx_mode
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
"&f;"
multiline_comment|/* A list of all installed RTL8129 devices, for removing the driver module. */
DECL|variable|root_rtl8129_dev
r_static
r_struct
id|net_device
op_star
id|root_rtl8129_dev
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/* Ideally we would detect all network cards in slot order.  That would&n;   be best done a central PCI probe dispatch, which wouldn&squot;t work&n;   well when dynamically adding drivers.  So instead we detect just the&n;   Rtl81*9 cards in slot order. */
DECL|function|rtl8129_probe
r_static
r_int
id|__init
id|rtl8129_probe
c_func
(paren
r_void
)paren
(brace
r_int
id|cards_found
op_assign
l_int|0
suffix:semicolon
r_int
id|pci_index
op_assign
l_int|0
suffix:semicolon
r_int
r_char
id|pci_bus
comma
id|pci_device_fn
suffix:semicolon
r_struct
id|net_device
op_star
id|dev
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pcibios_present
c_func
(paren
)paren
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
r_for
c_loop
(paren
suffix:semicolon
id|pci_index
OL
l_int|0xff
suffix:semicolon
id|pci_index
op_increment
)paren
(brace
r_struct
id|pci_dev
op_star
id|pdev
suffix:semicolon
id|u16
id|vendor
comma
id|device
comma
id|pci_command
comma
id|new_command
suffix:semicolon
r_int
id|chip_idx
comma
id|irq
suffix:semicolon
r_int
id|ioaddr
suffix:semicolon
r_if
c_cond
(paren
id|pcibios_find_class
(paren
id|PCI_CLASS_NETWORK_ETHERNET
op_lshift
l_int|8
comma
id|pci_index
comma
op_amp
id|pci_bus
comma
op_amp
id|pci_device_fn
)paren
op_ne
id|PCIBIOS_SUCCESSFUL
)paren
r_break
suffix:semicolon
id|pcibios_read_config_word
c_func
(paren
id|pci_bus
comma
id|pci_device_fn
comma
id|PCI_VENDOR_ID
comma
op_amp
id|vendor
)paren
suffix:semicolon
id|pcibios_read_config_word
c_func
(paren
id|pci_bus
comma
id|pci_device_fn
comma
id|PCI_DEVICE_ID
comma
op_amp
id|device
)paren
suffix:semicolon
r_for
c_loop
(paren
id|chip_idx
op_assign
l_int|0
suffix:semicolon
id|pci_tbl
(braket
id|chip_idx
)braket
dot
id|vendor_id
suffix:semicolon
id|chip_idx
op_increment
)paren
r_if
c_cond
(paren
id|vendor
op_eq
id|pci_tbl
(braket
id|chip_idx
)braket
dot
id|vendor_id
op_logical_and
(paren
id|device
op_amp
id|pci_tbl
(braket
id|chip_idx
)braket
dot
id|device_id_mask
)paren
op_eq
id|pci_tbl
(braket
id|chip_idx
)braket
dot
id|device_id
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
id|pci_tbl
(braket
id|chip_idx
)braket
dot
id|vendor_id
op_eq
l_int|0
)paren
multiline_comment|/* Compiled out! */
r_continue
suffix:semicolon
id|pdev
op_assign
id|pci_find_slot
c_func
(paren
id|pci_bus
comma
id|pci_device_fn
)paren
suffix:semicolon
id|ioaddr
op_assign
id|pci_resource_start
c_func
(paren
id|pdev
comma
l_int|0
)paren
suffix:semicolon
id|irq
op_assign
id|pdev-&gt;irq
suffix:semicolon
r_if
c_cond
(paren
id|pci_enable_device
c_func
(paren
id|pdev
)paren
)paren
r_continue
suffix:semicolon
r_if
c_cond
(paren
(paren
id|pci_tbl
(braket
id|chip_idx
)braket
dot
id|flags
op_amp
id|PCI_USES_IO
)paren
op_logical_and
id|check_region
c_func
(paren
id|ioaddr
comma
id|pci_tbl
(braket
id|chip_idx
)braket
dot
id|io_size
)paren
)paren
r_continue
suffix:semicolon
multiline_comment|/* Activate the card: fix for brain-damaged Win98 BIOSes. */
id|pcibios_read_config_word
c_func
(paren
id|pci_bus
comma
id|pci_device_fn
comma
id|PCI_COMMAND
comma
op_amp
id|pci_command
)paren
suffix:semicolon
id|new_command
op_assign
id|pci_command
op_or
(paren
id|pci_tbl
(braket
id|chip_idx
)braket
dot
id|flags
op_amp
l_int|7
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pci_command
op_ne
id|new_command
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;  The PCI BIOS has not enabled the&quot;
l_string|&quot; device at %d/%d!  Updating PCI command %4.4x-&gt;%4.4x.&bslash;n&quot;
comma
id|pci_bus
comma
id|pci_device_fn
comma
id|pci_command
comma
id|new_command
)paren
suffix:semicolon
id|pcibios_write_config_word
c_func
(paren
id|pci_bus
comma
id|pci_device_fn
comma
id|PCI_COMMAND
comma
id|new_command
)paren
suffix:semicolon
)brace
id|dev
op_assign
id|pci_tbl
(braket
id|chip_idx
)braket
dot
id|probe1
c_func
(paren
id|pdev
comma
id|pci_bus
comma
id|pci_device_fn
comma
id|ioaddr
comma
id|irq
comma
id|chip_idx
comma
id|cards_found
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dev
op_logical_and
(paren
id|pci_tbl
(braket
id|chip_idx
)braket
dot
id|flags
op_amp
id|PCI_COMMAND_MASTER
)paren
)paren
(brace
id|u8
id|pci_latency
suffix:semicolon
id|pcibios_read_config_byte
c_func
(paren
id|pci_bus
comma
id|pci_device_fn
comma
id|PCI_LATENCY_TIMER
comma
op_amp
id|pci_latency
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pci_latency
OL
l_int|32
)paren
(brace
id|printk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;  PCI latency timer (CFLT) is &quot;
l_string|&quot;unreasonably low at %d.  Setting to 64 clocks.&bslash;n&quot;
comma
id|pci_latency
)paren
suffix:semicolon
id|pcibios_write_config_byte
c_func
(paren
id|pci_bus
comma
id|pci_device_fn
comma
id|PCI_LATENCY_TIMER
comma
l_int|64
)paren
suffix:semicolon
)brace
)brace
id|dev
op_assign
l_int|0
suffix:semicolon
id|cards_found
op_increment
suffix:semicolon
)brace
r_return
id|cards_found
ques
c_cond
l_int|0
suffix:colon
op_minus
id|ENODEV
suffix:semicolon
)brace
DECL|function|rtl8129_probe1
r_static
r_struct
id|net_device
op_star
id|rtl8129_probe1
c_func
(paren
r_struct
id|pci_dev
op_star
id|pdev
comma
r_int
id|pci_bus
comma
r_int
id|pci_devfn
comma
r_int
id|ioaddr
comma
r_int
id|irq
comma
r_int
id|chip_idx
comma
r_int
id|found_cnt
)paren
(brace
r_static
r_int
id|did_version
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Already printed version info. */
r_struct
id|rtl8129_private
op_star
id|tp
suffix:semicolon
r_int
id|i
comma
id|option
op_assign
id|found_cnt
OL
id|MAX_UNITS
ques
c_cond
id|options
(braket
id|found_cnt
)braket
suffix:colon
l_int|0
suffix:semicolon
r_struct
id|net_device
op_star
id|dev
suffix:semicolon
r_if
c_cond
(paren
id|rtl8129_debug
OG
l_int|0
op_logical_and
id|did_version
op_increment
op_eq
l_int|0
)paren
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s&quot;
comma
id|version
)paren
suffix:semicolon
id|dev
op_assign
id|init_etherdev
c_func
(paren
l_int|NULL
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dev
op_eq
l_int|NULL
)paren
r_goto
id|out
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: %s at %#lx, IRQ %d, &quot;
comma
id|dev-&gt;name
comma
id|pci_tbl
(braket
id|chip_idx
)braket
dot
id|name
comma
id|ioaddr
comma
id|irq
)paren
suffix:semicolon
multiline_comment|/* Bring the chip out of low-power mode. */
id|outb
c_func
(paren
l_int|0x00
comma
id|ioaddr
op_plus
id|Config1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|read_eeprom
c_func
(paren
id|ioaddr
comma
l_int|0
)paren
op_ne
l_int|0xffff
)paren
(brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|3
suffix:semicolon
id|i
op_increment
)paren
(brace
(paren
(paren
id|u16
op_star
)paren
(paren
id|dev-&gt;dev_addr
)paren
)paren
(braket
id|i
)braket
op_assign
id|le16_to_cpu
c_func
(paren
id|read_eeprom
c_func
(paren
id|ioaddr
comma
id|i
op_plus
l_int|7
)paren
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|6
suffix:semicolon
id|i
op_increment
)paren
id|dev-&gt;dev_addr
(braket
id|i
)braket
op_assign
id|inb
c_func
(paren
id|ioaddr
op_plus
id|MAC0
op_plus
id|i
)paren
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|5
suffix:semicolon
id|i
op_increment
)paren
id|printk
c_func
(paren
l_string|&quot;%2.2x:&quot;
comma
id|dev-&gt;dev_addr
(braket
id|i
)braket
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;%2.2x.&bslash;n&quot;
comma
id|dev-&gt;dev_addr
(braket
id|i
)braket
)paren
suffix:semicolon
multiline_comment|/* We do a request_region() to register /proc/ioports info. */
r_if
c_cond
(paren
op_logical_neg
id|request_region
c_func
(paren
id|ioaddr
comma
id|pci_tbl
(braket
id|chip_idx
)braket
dot
id|io_size
comma
id|dev-&gt;name
)paren
)paren
r_goto
id|out_free_dev
suffix:semicolon
id|dev-&gt;base_addr
op_assign
id|ioaddr
suffix:semicolon
id|dev-&gt;irq
op_assign
id|irq
suffix:semicolon
multiline_comment|/* Some data structures must be quadword aligned. */
id|tp
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
op_star
id|tp
)paren
comma
id|GFP_KERNEL
op_or
id|GFP_DMA
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tp
op_eq
l_int|NULL
)paren
r_goto
id|out_release_region
suffix:semicolon
id|memset
c_func
(paren
id|tp
comma
l_int|0
comma
r_sizeof
(paren
op_star
id|tp
)paren
)paren
suffix:semicolon
id|dev-&gt;priv
op_assign
id|tp
suffix:semicolon
id|tp-&gt;next_module
op_assign
id|root_rtl8129_dev
suffix:semicolon
id|root_rtl8129_dev
op_assign
id|dev
suffix:semicolon
id|tp-&gt;pdev
op_assign
id|pdev
suffix:semicolon
id|tp-&gt;chip_id
op_assign
id|chip_idx
suffix:semicolon
id|tp-&gt;pci_bus
op_assign
id|pci_bus
suffix:semicolon
id|tp-&gt;pci_devfn
op_assign
id|pci_devfn
suffix:semicolon
multiline_comment|/* Find the connected MII xcvrs.&n;&t;   Doing this in open() would allow detecting external xcvrs later, but&n;&t;   takes too much time. */
r_if
c_cond
(paren
id|rtl_cap_tbl
(braket
id|chip_idx
)braket
op_amp
id|HAS_MII_XCVR
)paren
(brace
r_int
id|phy
comma
id|phy_idx
suffix:semicolon
r_for
c_loop
(paren
id|phy
op_assign
l_int|0
comma
id|phy_idx
op_assign
l_int|0
suffix:semicolon
id|phy
OL
l_int|32
op_logical_and
id|phy_idx
OL
r_sizeof
(paren
id|tp-&gt;phys
)paren
suffix:semicolon
id|phy
op_increment
)paren
(brace
r_int
id|mii_status
op_assign
id|mdio_read
c_func
(paren
id|dev
comma
id|phy
comma
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mii_status
op_ne
l_int|0xffff
op_logical_and
id|mii_status
op_ne
l_int|0x0000
)paren
(brace
id|tp-&gt;phys
(braket
id|phy_idx
op_increment
)braket
op_assign
id|phy
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: MII transceiver found at address %d.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|phy
)paren
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|phy_idx
op_eq
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: No MII transceivers found!  Assuming SYM &quot;
l_string|&quot;transceiver.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|tp-&gt;phys
(braket
l_int|0
)braket
op_assign
op_minus
l_int|1
suffix:semicolon
)brace
)brace
r_else
id|tp-&gt;phys
(braket
l_int|0
)braket
op_assign
l_int|32
suffix:semicolon
multiline_comment|/* Put the chip into low-power mode. */
id|outb
c_func
(paren
l_int|0xC0
comma
id|ioaddr
op_plus
id|Cfg9346
)paren
suffix:semicolon
id|outb
c_func
(paren
l_int|0x03
comma
id|ioaddr
op_plus
id|Config1
)paren
suffix:semicolon
id|outb
c_func
(paren
l_char|&squot;H&squot;
comma
id|ioaddr
op_plus
id|HltClk
)paren
suffix:semicolon
multiline_comment|/* &squot;R&squot; would leave the clock running. */
multiline_comment|/* The lower four bits are the media type. */
r_if
c_cond
(paren
id|option
OG
l_int|0
)paren
(brace
id|tp-&gt;full_duplex
op_assign
(paren
id|option
op_amp
l_int|0x200
)paren
ques
c_cond
l_int|1
suffix:colon
l_int|0
suffix:semicolon
id|tp-&gt;default_port
op_assign
id|option
op_amp
l_int|15
suffix:semicolon
r_if
c_cond
(paren
id|tp-&gt;default_port
)paren
id|tp-&gt;medialock
op_assign
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|found_cnt
template_param
l_int|0
)paren
id|tp-&gt;full_duplex
op_assign
id|full_duplex
(braket
id|found_cnt
)braket
suffix:semicolon
r_if
c_cond
(paren
id|tp-&gt;full_duplex
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Media type forced to Full Duplex.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|mdio_write
c_func
(paren
id|dev
comma
id|tp-&gt;phys
(braket
l_int|0
)braket
comma
l_int|4
comma
l_int|0x141
)paren
suffix:semicolon
id|tp-&gt;duplex_lock
op_assign
l_int|1
suffix:semicolon
)brace
multiline_comment|/* The Rtl8129-specific entries in the device structure. */
id|dev-&gt;open
op_assign
op_amp
id|rtl8129_open
suffix:semicolon
id|dev-&gt;hard_start_xmit
op_assign
op_amp
id|rtl8129_start_xmit
suffix:semicolon
id|dev-&gt;tx_timeout
op_assign
op_amp
id|rtl8129_tx_timeout
suffix:semicolon
id|dev-&gt;watchdog_timeo
op_assign
id|TX_TIMEOUT
suffix:semicolon
id|dev-&gt;stop
op_assign
op_amp
id|rtl8129_close
suffix:semicolon
id|dev-&gt;get_stats
op_assign
op_amp
id|rtl8129_get_stats
suffix:semicolon
id|dev-&gt;set_multicast_list
op_assign
op_amp
id|set_rx_mode
suffix:semicolon
id|dev-&gt;do_ioctl
op_assign
op_amp
id|mii_ioctl
suffix:semicolon
r_return
id|dev
suffix:semicolon
id|out_release_region
suffix:colon
id|release_region
c_func
(paren
id|ioaddr
comma
id|pci_tbl
(braket
id|chip_idx
)braket
dot
id|io_size
)paren
suffix:semicolon
id|out_free_dev
suffix:colon
id|unregister_netdev
c_func
(paren
id|dev
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|dev
)paren
suffix:semicolon
id|out
suffix:colon
r_return
l_int|NULL
suffix:semicolon
)brace
"&f;"
multiline_comment|/* Serial EEPROM section. */
multiline_comment|/*  EEPROM_Ctrl bits. */
DECL|macro|EE_SHIFT_CLK
mdefine_line|#define EE_SHIFT_CLK&t;0x04&t;/* EEPROM shift clock. */
DECL|macro|EE_CS
mdefine_line|#define EE_CS&t;&t;&t;0x08&t;/* EEPROM chip select. */
DECL|macro|EE_DATA_WRITE
mdefine_line|#define EE_DATA_WRITE&t;0x02&t;/* EEPROM chip data in. */
DECL|macro|EE_WRITE_0
mdefine_line|#define EE_WRITE_0&t;&t;0x00
DECL|macro|EE_WRITE_1
mdefine_line|#define EE_WRITE_1&t;&t;0x02
DECL|macro|EE_DATA_READ
mdefine_line|#define EE_DATA_READ&t;0x01&t;/* EEPROM chip data out. */
DECL|macro|EE_ENB
mdefine_line|#define EE_ENB&t;&t;&t;(0x80 | EE_CS)
multiline_comment|/* Delay between EEPROM clock transitions.&n;   No extra delay is needed with 33Mhz PCI, but 66Mhz may change this.&n; */
DECL|macro|eeprom_delay
mdefine_line|#define eeprom_delay()&t;inl(ee_addr)
multiline_comment|/* The EEPROM commands include the alway-set leading bit. */
DECL|macro|EE_WRITE_CMD
mdefine_line|#define EE_WRITE_CMD&t;(5 &lt;&lt; 6)
DECL|macro|EE_READ_CMD
mdefine_line|#define EE_READ_CMD&t;&t;(6 &lt;&lt; 6)
DECL|macro|EE_ERASE_CMD
mdefine_line|#define EE_ERASE_CMD&t;(7 &lt;&lt; 6)
DECL|function|read_eeprom
r_static
r_int
id|read_eeprom
c_func
(paren
r_int
id|ioaddr
comma
r_int
id|location
)paren
(brace
r_int
id|i
suffix:semicolon
r_int
id|retval
op_assign
l_int|0
suffix:semicolon
r_int
id|ee_addr
op_assign
id|ioaddr
op_plus
id|Cfg9346
suffix:semicolon
r_int
id|read_cmd
op_assign
id|location
op_or
id|EE_READ_CMD
suffix:semicolon
id|outb
c_func
(paren
id|EE_ENB
op_amp
op_complement
id|EE_CS
comma
id|ee_addr
)paren
suffix:semicolon
id|outb
c_func
(paren
id|EE_ENB
comma
id|ee_addr
)paren
suffix:semicolon
multiline_comment|/* Shift the read command bits out. */
r_for
c_loop
(paren
id|i
op_assign
l_int|10
suffix:semicolon
id|i
op_ge
l_int|0
suffix:semicolon
id|i
op_decrement
)paren
(brace
r_int
id|dataval
op_assign
(paren
id|read_cmd
op_amp
(paren
l_int|1
op_lshift
id|i
)paren
)paren
ques
c_cond
id|EE_DATA_WRITE
suffix:colon
l_int|0
suffix:semicolon
id|outb
c_func
(paren
id|EE_ENB
op_or
id|dataval
comma
id|ee_addr
)paren
suffix:semicolon
id|eeprom_delay
c_func
(paren
)paren
suffix:semicolon
id|outb
c_func
(paren
id|EE_ENB
op_or
id|dataval
op_or
id|EE_SHIFT_CLK
comma
id|ee_addr
)paren
suffix:semicolon
id|eeprom_delay
c_func
(paren
)paren
suffix:semicolon
)brace
id|outb
c_func
(paren
id|EE_ENB
comma
id|ee_addr
)paren
suffix:semicolon
id|eeprom_delay
c_func
(paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|16
suffix:semicolon
id|i
OG
l_int|0
suffix:semicolon
id|i
op_decrement
)paren
(brace
id|outb
c_func
(paren
id|EE_ENB
op_or
id|EE_SHIFT_CLK
comma
id|ee_addr
)paren
suffix:semicolon
id|eeprom_delay
c_func
(paren
)paren
suffix:semicolon
id|retval
op_assign
(paren
id|retval
op_lshift
l_int|1
)paren
op_or
(paren
(paren
id|inb
c_func
(paren
id|ee_addr
)paren
op_amp
id|EE_DATA_READ
)paren
ques
c_cond
l_int|1
suffix:colon
l_int|0
)paren
suffix:semicolon
id|outb
c_func
(paren
id|EE_ENB
comma
id|ee_addr
)paren
suffix:semicolon
id|eeprom_delay
c_func
(paren
)paren
suffix:semicolon
)brace
multiline_comment|/* Terminate the EEPROM access. */
id|outb
c_func
(paren
op_complement
id|EE_CS
comma
id|ee_addr
)paren
suffix:semicolon
r_return
id|retval
suffix:semicolon
)brace
multiline_comment|/* MII serial management: mostly bogus for now. */
multiline_comment|/* Read and write the MII management registers using software-generated&n;   serial MDIO protocol.&n;   The maximum data clock rate is 2.5 Mhz.  The minimum timing is usually&n;   met by back-to-back PCI I/O cycles, but we insert a delay to avoid&n;   &quot;overclocking&quot; issues. */
DECL|macro|MDIO_DIR
mdefine_line|#define MDIO_DIR&t;&t;0x80
DECL|macro|MDIO_DATA_OUT
mdefine_line|#define MDIO_DATA_OUT&t;0x04
DECL|macro|MDIO_DATA_IN
mdefine_line|#define MDIO_DATA_IN&t;0x02
DECL|macro|MDIO_CLK
mdefine_line|#define MDIO_CLK&t;&t;0x01
DECL|macro|MDIO_WRITE0
mdefine_line|#define MDIO_WRITE0 (MDIO_DIR)
DECL|macro|MDIO_WRITE1
mdefine_line|#define MDIO_WRITE1 (MDIO_DIR | MDIO_DATA_OUT)
DECL|macro|mdio_delay
mdefine_line|#define mdio_delay()&t;inb(mdio_addr)
DECL|variable|mii_2_8139_map
r_static
r_char
id|mii_2_8139_map
(braket
l_int|8
)braket
op_assign
(brace
id|MII_BMCR
comma
id|MII_BMSR
comma
l_int|0
comma
l_int|0
comma
id|NWayAdvert
comma
id|NWayLPAR
comma
id|NWayExpansion
comma
l_int|0
)brace
suffix:semicolon
multiline_comment|/* Syncronize the MII management interface by shifting 32 one bits out. */
DECL|function|mdio_sync
r_static
r_void
id|mdio_sync
c_func
(paren
r_int
id|mdio_addr
)paren
(brace
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|32
suffix:semicolon
id|i
op_ge
l_int|0
suffix:semicolon
id|i
op_decrement
)paren
(brace
id|outb
c_func
(paren
id|MDIO_WRITE1
comma
id|mdio_addr
)paren
suffix:semicolon
id|mdio_delay
c_func
(paren
)paren
suffix:semicolon
id|outb
c_func
(paren
id|MDIO_WRITE1
op_or
id|MDIO_CLK
comma
id|mdio_addr
)paren
suffix:semicolon
id|mdio_delay
c_func
(paren
)paren
suffix:semicolon
)brace
r_return
suffix:semicolon
)brace
DECL|function|mdio_read
r_static
r_int
id|mdio_read
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_int
id|phy_id
comma
r_int
id|location
)paren
(brace
r_int
id|mdio_addr
op_assign
id|dev-&gt;base_addr
op_plus
id|MII_SMI
suffix:semicolon
r_int
id|mii_cmd
op_assign
(paren
l_int|0xf6
op_lshift
l_int|10
)paren
op_or
(paren
id|phy_id
op_lshift
l_int|5
)paren
op_or
id|location
suffix:semicolon
r_int
id|retval
op_assign
l_int|0
suffix:semicolon
r_int
id|i
suffix:semicolon
r_if
c_cond
(paren
id|phy_id
OG
l_int|31
)paren
(brace
multiline_comment|/* Really a 8139.  Use internal registers. */
r_return
id|location
OL
l_int|8
op_logical_and
id|mii_2_8139_map
(braket
id|location
)braket
ques
c_cond
id|inw
c_func
(paren
id|dev-&gt;base_addr
op_plus
id|mii_2_8139_map
(braket
id|location
)braket
)paren
suffix:colon
l_int|0
suffix:semicolon
)brace
id|mdio_sync
c_func
(paren
id|mdio_addr
)paren
suffix:semicolon
multiline_comment|/* Shift the read command bits out. */
r_for
c_loop
(paren
id|i
op_assign
l_int|15
suffix:semicolon
id|i
op_ge
l_int|0
suffix:semicolon
id|i
op_decrement
)paren
(brace
r_int
id|dataval
op_assign
(paren
id|mii_cmd
op_amp
(paren
l_int|1
op_lshift
id|i
)paren
)paren
ques
c_cond
id|MDIO_DATA_OUT
suffix:colon
l_int|0
suffix:semicolon
id|outb
c_func
(paren
id|MDIO_DIR
op_or
id|dataval
comma
id|mdio_addr
)paren
suffix:semicolon
id|mdio_delay
c_func
(paren
)paren
suffix:semicolon
id|outb
c_func
(paren
id|MDIO_DIR
op_or
id|dataval
op_or
id|MDIO_CLK
comma
id|mdio_addr
)paren
suffix:semicolon
id|mdio_delay
c_func
(paren
)paren
suffix:semicolon
)brace
multiline_comment|/* Read the two transition, 16 data, and wire-idle bits. */
r_for
c_loop
(paren
id|i
op_assign
l_int|19
suffix:semicolon
id|i
OG
l_int|0
suffix:semicolon
id|i
op_decrement
)paren
(brace
id|outb
c_func
(paren
l_int|0
comma
id|mdio_addr
)paren
suffix:semicolon
id|mdio_delay
c_func
(paren
)paren
suffix:semicolon
id|retval
op_assign
(paren
id|retval
op_lshift
l_int|1
)paren
op_or
(paren
(paren
id|inb
c_func
(paren
id|mdio_addr
)paren
op_amp
id|MDIO_DATA_IN
)paren
ques
c_cond
l_int|1
suffix:colon
l_int|0
)paren
suffix:semicolon
id|outb
c_func
(paren
id|MDIO_CLK
comma
id|mdio_addr
)paren
suffix:semicolon
id|mdio_delay
c_func
(paren
)paren
suffix:semicolon
)brace
r_return
(paren
id|retval
op_rshift
l_int|1
)paren
op_amp
l_int|0xffff
suffix:semicolon
)brace
DECL|function|mdio_write
r_static
r_void
id|mdio_write
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_int
id|phy_id
comma
r_int
id|location
comma
r_int
id|value
)paren
(brace
r_int
id|mdio_addr
op_assign
id|dev-&gt;base_addr
op_plus
id|MII_SMI
suffix:semicolon
r_int
id|mii_cmd
op_assign
(paren
l_int|0x5002
op_lshift
l_int|16
)paren
op_or
(paren
id|phy_id
op_lshift
l_int|23
)paren
op_or
(paren
id|location
op_lshift
l_int|18
)paren
op_or
id|value
suffix:semicolon
r_int
id|i
suffix:semicolon
r_if
c_cond
(paren
id|phy_id
OG
l_int|31
)paren
(brace
multiline_comment|/* Really a 8139.  Use internal registers. */
r_if
c_cond
(paren
id|location
OL
l_int|8
op_logical_and
id|mii_2_8139_map
(braket
id|location
)braket
)paren
id|outw
c_func
(paren
id|value
comma
id|dev-&gt;base_addr
op_plus
id|mii_2_8139_map
(braket
id|location
)braket
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|mdio_sync
c_func
(paren
id|mdio_addr
)paren
suffix:semicolon
multiline_comment|/* Shift the command bits out. */
r_for
c_loop
(paren
id|i
op_assign
l_int|31
suffix:semicolon
id|i
op_ge
l_int|0
suffix:semicolon
id|i
op_decrement
)paren
(brace
r_int
id|dataval
op_assign
(paren
id|mii_cmd
op_amp
(paren
l_int|1
op_lshift
id|i
)paren
)paren
ques
c_cond
id|MDIO_WRITE1
suffix:colon
id|MDIO_WRITE0
suffix:semicolon
id|outb
c_func
(paren
id|dataval
comma
id|mdio_addr
)paren
suffix:semicolon
id|mdio_delay
c_func
(paren
)paren
suffix:semicolon
id|outb
c_func
(paren
id|dataval
op_or
id|MDIO_CLK
comma
id|mdio_addr
)paren
suffix:semicolon
id|mdio_delay
c_func
(paren
)paren
suffix:semicolon
)brace
multiline_comment|/* Clear out extra bits. */
r_for
c_loop
(paren
id|i
op_assign
l_int|2
suffix:semicolon
id|i
OG
l_int|0
suffix:semicolon
id|i
op_decrement
)paren
(brace
id|outb
c_func
(paren
l_int|0
comma
id|mdio_addr
)paren
suffix:semicolon
id|mdio_delay
c_func
(paren
)paren
suffix:semicolon
id|outb
c_func
(paren
id|MDIO_CLK
comma
id|mdio_addr
)paren
suffix:semicolon
id|mdio_delay
c_func
(paren
)paren
suffix:semicolon
)brace
r_return
suffix:semicolon
)brace
"&f;"
r_static
r_int
DECL|function|rtl8129_open
id|rtl8129_open
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|rtl8129_private
op_star
id|tp
op_assign
(paren
r_struct
id|rtl8129_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_int
id|ioaddr
op_assign
id|dev-&gt;base_addr
suffix:semicolon
r_int
id|i
comma
id|retval
suffix:semicolon
id|MOD_INC_USE_COUNT
suffix:semicolon
multiline_comment|/* Soft reset the chip. */
id|outb
c_func
(paren
id|CmdReset
comma
id|ioaddr
op_plus
id|ChipCmd
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|retval
op_assign
id|request_irq
c_func
(paren
id|dev-&gt;irq
comma
op_amp
id|rtl8129_interrupt
comma
id|SA_SHIRQ
comma
id|dev-&gt;name
comma
id|dev
)paren
)paren
)paren
(brace
id|MOD_DEC_USE_COUNT
suffix:semicolon
r_return
id|retval
suffix:semicolon
)brace
id|tp-&gt;tx_bufs
op_assign
id|pci_alloc_consistent
c_func
(paren
id|tp-&gt;pdev
comma
id|TX_BUF_SIZE
op_star
id|NUM_TX_DESC
comma
op_amp
id|tp-&gt;tx_bufs_dma
)paren
suffix:semicolon
id|tp-&gt;rx_ring
op_assign
id|pci_alloc_consistent
c_func
(paren
id|tp-&gt;pdev
comma
id|RX_BUF_LEN
op_plus
l_int|16
comma
op_amp
id|tp-&gt;rx_ring_dma
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tp-&gt;tx_bufs
op_eq
l_int|NULL
op_logical_or
id|tp-&gt;rx_ring
op_eq
l_int|NULL
)paren
(brace
id|free_irq
c_func
(paren
id|dev-&gt;irq
comma
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tp-&gt;tx_bufs
)paren
id|pci_free_consistent
c_func
(paren
id|tp-&gt;pdev
comma
id|TX_BUF_SIZE
op_star
id|NUM_TX_DESC
comma
id|tp-&gt;tx_bufs
comma
id|tp-&gt;tx_bufs_dma
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tp-&gt;rx_ring
)paren
id|pci_free_consistent
c_func
(paren
id|tp-&gt;pdev
comma
id|RX_BUF_LEN
op_plus
l_int|16
comma
id|tp-&gt;rx_ring
comma
id|tp-&gt;rx_ring_dma
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rtl8129_debug
OG
l_int|0
)paren
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: Couldn&squot;t allocate a %d byte receive ring.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|RX_BUF_LEN
)paren
suffix:semicolon
id|MOD_DEC_USE_COUNT
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|rtl8129_init_ring
c_func
(paren
id|dev
)paren
suffix:semicolon
multiline_comment|/* Check that the chip has finished the reset. */
r_for
c_loop
(paren
id|i
op_assign
l_int|1000
suffix:semicolon
id|i
OG
l_int|0
suffix:semicolon
id|i
op_decrement
)paren
r_if
c_cond
(paren
(paren
id|inb
c_func
(paren
id|ioaddr
op_plus
id|ChipCmd
)paren
op_amp
id|CmdReset
)paren
op_eq
l_int|0
)paren
r_break
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|6
suffix:semicolon
id|i
op_increment
)paren
id|outb
c_func
(paren
id|dev-&gt;dev_addr
(braket
id|i
)braket
comma
id|ioaddr
op_plus
id|MAC0
op_plus
id|i
)paren
suffix:semicolon
multiline_comment|/* Must enable Tx/Rx before setting transfer thresholds! */
id|outb
c_func
(paren
id|CmdRxEnb
op_or
id|CmdTxEnb
comma
id|ioaddr
op_plus
id|ChipCmd
)paren
suffix:semicolon
id|outl
c_func
(paren
(paren
id|RX_FIFO_THRESH
op_lshift
l_int|13
)paren
op_or
(paren
id|RX_BUF_LEN_IDX
op_lshift
l_int|11
)paren
op_or
(paren
id|RX_DMA_BURST
op_lshift
l_int|8
)paren
comma
id|ioaddr
op_plus
id|RxConfig
)paren
suffix:semicolon
id|outl
c_func
(paren
(paren
id|TX_DMA_BURST
op_lshift
l_int|8
)paren
op_or
l_int|0x03000000
comma
id|ioaddr
op_plus
id|TxConfig
)paren
suffix:semicolon
id|tp-&gt;tx_flag
op_assign
(paren
id|TX_FIFO_THRESH
op_lshift
l_int|11
)paren
op_amp
l_int|0x003f0000
suffix:semicolon
id|tp-&gt;full_duplex
op_assign
id|tp-&gt;duplex_lock
suffix:semicolon
r_if
c_cond
(paren
id|tp-&gt;phys
(braket
l_int|0
)braket
op_ge
l_int|0
op_logical_or
(paren
id|rtl_cap_tbl
(braket
id|tp-&gt;chip_id
)braket
op_amp
id|HAS_MII_XCVR
)paren
)paren
(brace
id|u16
id|mii_reg5
op_assign
id|mdio_read
c_func
(paren
id|dev
comma
id|tp-&gt;phys
(braket
l_int|0
)braket
comma
l_int|5
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mii_reg5
op_eq
l_int|0xffff
)paren
suffix:semicolon
multiline_comment|/* Not there */
r_else
r_if
c_cond
(paren
(paren
id|mii_reg5
op_amp
l_int|0x0100
)paren
op_eq
l_int|0x0100
op_logical_or
(paren
id|mii_reg5
op_amp
l_int|0x00C0
)paren
op_eq
l_int|0x0040
)paren
id|tp-&gt;full_duplex
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|rtl8129_debug
OG
l_int|1
)paren
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Setting %s%s-duplex based on&quot;
l_string|&quot; auto-negotiated partner ability %4.4x.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|mii_reg5
op_eq
l_int|0
ques
c_cond
l_string|&quot;&quot;
suffix:colon
(paren
id|mii_reg5
op_amp
l_int|0x0180
)paren
ques
c_cond
l_string|&quot;100mbps &quot;
suffix:colon
l_string|&quot;10mbps &quot;
comma
id|tp-&gt;full_duplex
ques
c_cond
l_string|&quot;full&quot;
suffix:colon
l_string|&quot;half&quot;
comma
id|mii_reg5
)paren
suffix:semicolon
)brace
id|outb
c_func
(paren
l_int|0xC0
comma
id|ioaddr
op_plus
id|Cfg9346
)paren
suffix:semicolon
id|outb
c_func
(paren
id|tp-&gt;full_duplex
ques
c_cond
l_int|0x60
suffix:colon
l_int|0x20
comma
id|ioaddr
op_plus
id|Config1
)paren
suffix:semicolon
id|outb
c_func
(paren
l_int|0x00
comma
id|ioaddr
op_plus
id|Cfg9346
)paren
suffix:semicolon
id|outl
c_func
(paren
id|tp-&gt;rx_ring_dma
comma
id|ioaddr
op_plus
id|RxBuf
)paren
suffix:semicolon
multiline_comment|/* Start the chip&squot;s Tx and Rx process. */
id|outl
c_func
(paren
l_int|0
comma
id|ioaddr
op_plus
id|RxMissed
)paren
suffix:semicolon
id|set_rx_mode
c_func
(paren
id|dev
)paren
suffix:semicolon
id|outb
c_func
(paren
id|CmdRxEnb
op_or
id|CmdTxEnb
comma
id|ioaddr
op_plus
id|ChipCmd
)paren
suffix:semicolon
multiline_comment|/* Enable all known interrupts by setting the interrupt mask. */
id|outw
c_func
(paren
id|PCIErr
op_or
id|PCSTimeout
op_or
id|RxUnderrun
op_or
id|RxOverflow
op_or
id|RxFIFOOver
op_or
id|TxErr
op_or
id|TxOK
op_or
id|RxErr
op_or
id|RxOK
comma
id|ioaddr
op_plus
id|IntrMask
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rtl8129_debug
OG
l_int|1
)paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%s: rtl8129_open() ioaddr %#lx IRQ %d&quot;
l_string|&quot; GP Pins %2.2x %s-duplex.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|ioaddr
comma
id|dev-&gt;irq
comma
id|inb
c_func
(paren
id|ioaddr
op_plus
id|GPPinData
)paren
comma
id|tp-&gt;full_duplex
ques
c_cond
l_string|&quot;full&quot;
suffix:colon
l_string|&quot;half&quot;
)paren
suffix:semicolon
multiline_comment|/* Set the timer to switch to check for link beat and perhaps switch&n;&t;   to an alternate media type. */
id|init_timer
c_func
(paren
op_amp
id|tp-&gt;timer
)paren
suffix:semicolon
id|tp-&gt;timer.expires
op_assign
id|RUN_AT
c_func
(paren
(paren
l_int|24
op_star
id|HZ
)paren
op_div
l_int|10
)paren
suffix:semicolon
multiline_comment|/* 2.4 sec. */
id|tp-&gt;timer.data
op_assign
(paren
r_int
r_int
)paren
id|dev
suffix:semicolon
id|tp-&gt;timer.function
op_assign
op_amp
id|rtl8129_timer
suffix:semicolon
id|add_timer
c_func
(paren
op_amp
id|tp-&gt;timer
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|rtl8129_timer
r_static
r_void
id|rtl8129_timer
c_func
(paren
r_int
r_int
id|data
)paren
(brace
r_struct
id|net_device
op_star
id|dev
op_assign
(paren
r_struct
id|net_device
op_star
)paren
id|data
suffix:semicolon
r_struct
id|rtl8129_private
op_star
id|tp
op_assign
(paren
r_struct
id|rtl8129_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_int
id|ioaddr
op_assign
id|dev-&gt;base_addr
suffix:semicolon
r_int
id|next_tick
op_assign
l_int|60
op_star
id|HZ
suffix:semicolon
r_int
id|mii_reg5
op_assign
id|mdio_read
c_func
(paren
id|dev
comma
id|tp-&gt;phys
(braket
l_int|0
)braket
comma
l_int|5
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|tp-&gt;duplex_lock
op_logical_and
id|mii_reg5
op_ne
l_int|0xffff
)paren
(brace
r_int
id|duplex
op_assign
(paren
id|mii_reg5
op_amp
l_int|0x0100
)paren
op_logical_or
(paren
id|mii_reg5
op_amp
l_int|0x01C0
)paren
op_eq
l_int|0x0040
suffix:semicolon
r_if
c_cond
(paren
id|tp-&gt;full_duplex
op_ne
id|duplex
)paren
(brace
id|tp-&gt;full_duplex
op_assign
id|duplex
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Setting %s-duplex based on MII #%d link&quot;
l_string|&quot; partner ability of %4.4x.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|tp-&gt;full_duplex
ques
c_cond
l_string|&quot;full&quot;
suffix:colon
l_string|&quot;half&quot;
comma
id|tp-&gt;phys
(braket
l_int|0
)braket
comma
id|mii_reg5
)paren
suffix:semicolon
id|outb
c_func
(paren
l_int|0xC0
comma
id|ioaddr
op_plus
id|Cfg9346
)paren
suffix:semicolon
id|outb
c_func
(paren
id|tp-&gt;full_duplex
ques
c_cond
l_int|0x60
suffix:colon
l_int|0x20
comma
id|ioaddr
op_plus
id|Config1
)paren
suffix:semicolon
id|outb
c_func
(paren
l_int|0x00
comma
id|ioaddr
op_plus
id|Cfg9346
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* Check for bogusness. */
r_if
c_cond
(paren
id|inw
c_func
(paren
id|ioaddr
op_plus
id|IntrStatus
)paren
op_amp
(paren
id|TxOK
op_or
id|RxOK
)paren
)paren
(brace
r_int
id|status
op_assign
id|inw
c_func
(paren
id|ioaddr
op_plus
id|IntrStatus
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
(paren
id|TxOK
op_or
id|RxOK
)paren
)paren
(brace
multiline_comment|/* Double check */
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: RTL8129 Interrupt line blocked, status %x.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|status
)paren
suffix:semicolon
id|rtl8129_interrupt
c_func
(paren
id|dev-&gt;irq
comma
id|dev
comma
l_int|0
)paren
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|netif_queue_stopped
c_func
(paren
id|dev
)paren
op_logical_and
(paren
id|jiffies
op_minus
id|dev-&gt;trans_start
)paren
op_ge
l_int|2
op_star
id|TX_TIMEOUT
)paren
id|rtl8129_tx_timeout
c_func
(paren
id|dev
)paren
suffix:semicolon
macro_line|#if 0
r_if
c_cond
(paren
id|tp-&gt;twistie
)paren
(brace
r_int
r_int
id|CSCRval
op_assign
id|inw
c_func
(paren
id|ioaddr
op_plus
id|CSCR
)paren
suffix:semicolon
multiline_comment|/* Read link status. */
r_if
c_cond
(paren
id|tp-&gt;twistie
op_eq
l_int|1
)paren
(brace
r_if
c_cond
(paren
id|CSCRval
op_amp
id|CSCR_LinkOKBit
)paren
(brace
id|outw
c_func
(paren
id|CSCR_LinkDownOffCmd
comma
id|ioaddr
op_plus
id|CSCR
)paren
suffix:semicolon
id|tp-&gt;twistie
op_assign
l_int|2
suffix:semicolon
id|next_tick
op_assign
id|HZ
op_div
l_int|10
suffix:semicolon
)brace
r_else
(brace
id|outw
c_func
(paren
id|CSCR_LinkDownCmd
comma
id|ioaddr
op_plus
id|CSCR
)paren
suffix:semicolon
id|outl
c_func
(paren
id|FIFOTMS_default
comma
id|ioaddr
op_plus
id|FIFOTMS
)paren
suffix:semicolon
id|outl
c_func
(paren
id|PARA78_default
comma
id|ioaddr
op_plus
id|PARA78
)paren
suffix:semicolon
id|outl
c_func
(paren
id|PARA7c_default
comma
id|ioaddr
op_plus
id|PARA7c
)paren
suffix:semicolon
id|tp-&gt;twistie
op_assign
l_int|0
suffix:semicolon
)brace
)brace
r_else
r_if
c_cond
(paren
id|tp-&gt;twistie
op_eq
l_int|2
)paren
(brace
r_int
id|linkcase
op_assign
(paren
id|CSCRval
op_amp
id|CSCR_LinkStatusBits
)paren
op_rshift
l_int|12
suffix:semicolon
r_int
id|row
suffix:semicolon
r_if
c_cond
(paren
id|linkcase
op_ge
l_int|0x7000
)paren
id|row
op_assign
l_int|3
suffix:semicolon
r_else
r_if
c_cond
(paren
id|linkcase
op_ge
l_int|0x3000
)paren
id|row
op_assign
l_int|2
suffix:semicolon
r_else
r_if
c_cond
(paren
id|linkcase
op_ge
l_int|0x1000
)paren
id|row
op_assign
l_int|1
suffix:semicolon
r_else
id|row
op_assign
l_int|0
suffix:semicolon
id|tp-&gt;twistie
op_eq
id|row
op_plus
l_int|3
suffix:semicolon
id|outw
c_func
(paren
l_int|0
comma
id|ioaddr
op_plus
id|FIFOTMS
)paren
suffix:semicolon
id|outl
c_func
(paren
id|param
(braket
id|row
)braket
(braket
l_int|0
)braket
comma
id|ioaddr
op_plus
id|PARA7c
)paren
suffix:semicolon
id|tp-&gt;twist_cnt
op_assign
l_int|1
suffix:semicolon
)brace
r_else
(brace
id|outl
c_func
(paren
id|param
(braket
id|tp-&gt;twistie
op_minus
l_int|3
)braket
(braket
id|tp-&gt;twist_cnt
)braket
comma
id|ioaddr
op_plus
id|PARA7c
)paren
suffix:semicolon
r_if
c_cond
(paren
op_increment
id|tp-&gt;twist_cnt
OL
l_int|4
)paren
(brace
id|next_tick
op_assign
id|HZ
op_div
l_int|10
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|tp-&gt;twistie
op_minus
l_int|3
op_eq
l_int|3
)paren
(brace
r_if
c_cond
(paren
(paren
id|CSCRval
op_amp
id|CSCR_LinkStatusBits
)paren
op_ne
l_int|0x7000
)paren
(brace
id|outl
c_func
(paren
id|PARA7c_xxx
comma
id|ioaddr
op_plus
id|PARA7c
)paren
suffix:semicolon
id|next_tick
op_assign
id|HZ
op_div
l_int|10
suffix:semicolon
multiline_comment|/* 100ms. */
id|outl
c_func
(paren
id|FIFOTMS_default
comma
id|ioaddr
op_plus
id|FIFOTMS
)paren
suffix:semicolon
id|outl
c_func
(paren
id|PARA78_default
comma
id|ioaddr
op_plus
id|PARA78
)paren
suffix:semicolon
id|outl
c_func
(paren
id|PARA7c_default
comma
id|ioaddr
op_plus
id|PARA7c
)paren
suffix:semicolon
id|tp-&gt;twistie
op_eq
l_int|3
op_plus
l_int|3
suffix:semicolon
id|outw
c_func
(paren
l_int|0
comma
id|ioaddr
op_plus
id|FIFOTMS
)paren
suffix:semicolon
id|outl
c_func
(paren
id|param
(braket
l_int|3
)braket
(braket
l_int|0
)braket
comma
id|ioaddr
op_plus
id|PARA7c
)paren
suffix:semicolon
id|tp-&gt;twist_cnt
op_assign
l_int|1
suffix:semicolon
)brace
)brace
)brace
)brace
macro_line|#endif
r_if
c_cond
(paren
id|rtl8129_debug
OG
l_int|2
)paren
(brace
r_if
c_cond
(paren
id|rtl_cap_tbl
(braket
id|tp-&gt;chip_id
)braket
op_amp
id|HAS_MII_XCVR
)paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%s: Media selection tick, GP pins %2.2x.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|inb
c_func
(paren
id|ioaddr
op_plus
id|GPPinData
)paren
)paren
suffix:semicolon
r_else
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%s: Media selection tick, Link partner %4.4x.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|inw
c_func
(paren
id|ioaddr
op_plus
id|NWayLPAR
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%s:  Other registers are IntMask %4.4x IntStatus %4.4x&quot;
l_string|&quot; RxStatus %4.4x.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|inw
c_func
(paren
id|ioaddr
op_plus
id|IntrMask
)paren
comma
id|inw
c_func
(paren
id|ioaddr
op_plus
id|IntrStatus
)paren
comma
id|inl
c_func
(paren
id|ioaddr
op_plus
id|RxEarlyStatus
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%s:  Chip config %2.2x %2.2x.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|inb
c_func
(paren
id|ioaddr
op_plus
id|Config0
)paren
comma
id|inb
c_func
(paren
id|ioaddr
op_plus
id|Config1
)paren
)paren
suffix:semicolon
)brace
id|tp-&gt;timer.expires
op_assign
id|RUN_AT
c_func
(paren
id|next_tick
)paren
suffix:semicolon
id|add_timer
c_func
(paren
op_amp
id|tp-&gt;timer
)paren
suffix:semicolon
)brace
DECL|function|rtl8129_tx_timeout
r_static
r_void
id|rtl8129_tx_timeout
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|rtl8129_private
op_star
id|tp
op_assign
(paren
r_struct
id|rtl8129_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_int
id|ioaddr
op_assign
id|dev-&gt;base_addr
suffix:semicolon
r_int
id|mii_reg
comma
id|i
suffix:semicolon
r_if
c_cond
(paren
id|rtl8129_debug
OG
l_int|0
)paren
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: Transmit timeout, status %2.2x %4.4x &quot;
l_string|&quot;media %2.2x.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|inb
c_func
(paren
id|ioaddr
op_plus
id|ChipCmd
)paren
comma
id|inw
c_func
(paren
id|ioaddr
op_plus
id|IntrStatus
)paren
comma
id|inb
c_func
(paren
id|ioaddr
op_plus
id|GPPinData
)paren
)paren
suffix:semicolon
multiline_comment|/* Disable interrupts by clearing the interrupt mask. */
id|outw
c_func
(paren
l_int|0x0000
comma
id|ioaddr
op_plus
id|IntrMask
)paren
suffix:semicolon
multiline_comment|/* Emit info to figure out what went wrong. */
id|printk
c_func
(paren
l_string|&quot;%s: Tx queue start entry %d  dirty entry %d.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|tp-&gt;cur_tx
comma
id|tp-&gt;dirty_tx
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|NUM_TX_DESC
suffix:semicolon
id|i
op_increment
)paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%s:  Tx descriptor %d is %8.8x.%s&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|i
comma
id|inl
c_func
(paren
id|ioaddr
op_plus
id|TxStatus0
op_plus
id|i
op_star
l_int|4
)paren
comma
id|i
op_eq
id|tp-&gt;dirty_tx
op_mod
id|NUM_TX_DESC
ques
c_cond
l_string|&quot; (queue head)&quot;
suffix:colon
l_string|&quot;&quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%s: MII #%d registers are:&quot;
comma
id|dev-&gt;name
comma
id|tp-&gt;phys
(braket
l_int|0
)braket
)paren
suffix:semicolon
r_for
c_loop
(paren
id|mii_reg
op_assign
l_int|0
suffix:semicolon
id|mii_reg
OL
l_int|8
suffix:semicolon
id|mii_reg
op_increment
)paren
id|printk
c_func
(paren
l_string|&quot; %4.4x&quot;
comma
id|mdio_read
c_func
(paren
id|dev
comma
id|tp-&gt;phys
(braket
l_int|0
)braket
comma
id|mii_reg
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;.&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* Soft reset the chip. */
id|outb
c_func
(paren
id|CmdReset
comma
id|ioaddr
op_plus
id|ChipCmd
)paren
suffix:semicolon
multiline_comment|/* Check that the chip has finished the reset. */
r_for
c_loop
(paren
id|i
op_assign
l_int|1000
suffix:semicolon
id|i
OG
l_int|0
suffix:semicolon
id|i
op_decrement
)paren
r_if
c_cond
(paren
(paren
id|inb
c_func
(paren
id|ioaddr
op_plus
id|ChipCmd
)paren
op_amp
id|CmdReset
)paren
op_eq
l_int|0
)paren
r_break
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|6
suffix:semicolon
id|i
op_increment
)paren
id|outb
c_func
(paren
id|dev-&gt;dev_addr
(braket
id|i
)braket
comma
id|ioaddr
op_plus
id|MAC0
op_plus
id|i
)paren
suffix:semicolon
id|outb
c_func
(paren
l_int|0x00
comma
id|ioaddr
op_plus
id|Cfg9346
)paren
suffix:semicolon
id|tp-&gt;cur_rx
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Must enable Tx/Rx before setting transfer thresholds! */
id|outb
c_func
(paren
id|CmdRxEnb
op_or
id|CmdTxEnb
comma
id|ioaddr
op_plus
id|ChipCmd
)paren
suffix:semicolon
id|outl
c_func
(paren
(paren
id|RX_FIFO_THRESH
op_lshift
l_int|13
)paren
op_or
(paren
id|RX_BUF_LEN_IDX
op_lshift
l_int|11
)paren
op_or
(paren
id|RX_DMA_BURST
op_lshift
l_int|8
)paren
comma
id|ioaddr
op_plus
id|RxConfig
)paren
suffix:semicolon
id|outl
c_func
(paren
(paren
id|TX_DMA_BURST
op_lshift
l_int|8
)paren
comma
id|ioaddr
op_plus
id|TxConfig
)paren
suffix:semicolon
id|set_rx_mode
c_func
(paren
id|dev
)paren
suffix:semicolon
(brace
multiline_comment|/* Save the unsent Tx packets. */
r_struct
id|sk_buff
op_star
id|saved_skb
(braket
id|NUM_TX_DESC
)braket
comma
op_star
id|skb
suffix:semicolon
r_int
id|j
suffix:semicolon
r_for
c_loop
(paren
id|j
op_assign
l_int|0
suffix:semicolon
id|tp-&gt;cur_tx
op_minus
id|tp-&gt;dirty_tx
OG
l_int|0
suffix:semicolon
id|j
op_increment
comma
id|tp-&gt;dirty_tx
op_increment
)paren
(brace
r_struct
id|ring_info
op_star
id|rp
op_assign
op_amp
id|tp-&gt;tx_info
(braket
id|tp-&gt;dirty_tx
op_mod
id|NUM_TX_DESC
)braket
suffix:semicolon
id|saved_skb
(braket
id|j
)braket
op_assign
id|rp-&gt;skb
suffix:semicolon
r_if
c_cond
(paren
id|rp-&gt;mapping
op_ne
l_int|0
)paren
(brace
id|pci_unmap_single
c_func
(paren
id|tp-&gt;pdev
comma
id|rp-&gt;mapping
comma
id|rp-&gt;skb-&gt;len
comma
id|PCI_DMA_TODEVICE
)paren
suffix:semicolon
id|rp-&gt;mapping
op_assign
l_int|0
suffix:semicolon
)brace
)brace
id|tp-&gt;dirty_tx
op_assign
id|tp-&gt;cur_tx
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|j
suffix:semicolon
id|i
op_increment
)paren
(brace
id|skb
op_assign
id|tp-&gt;tx_info
(braket
id|i
)braket
dot
id|skb
op_assign
id|saved_skb
(braket
id|i
)braket
suffix:semicolon
r_if
c_cond
(paren
(paren
r_int
)paren
id|skb-&gt;data
op_amp
l_int|3
)paren
(brace
multiline_comment|/* Must use alignment buffer. */
id|memcpy
c_func
(paren
id|tp-&gt;tx_buf
(braket
id|i
)braket
comma
id|skb-&gt;data
comma
id|skb-&gt;len
)paren
suffix:semicolon
id|outl
c_func
(paren
id|tp-&gt;tx_bufs_dma
op_plus
(paren
id|tp-&gt;tx_buf
(braket
id|i
)braket
op_minus
id|tp-&gt;tx_bufs
)paren
comma
id|ioaddr
op_plus
id|TxAddr0
op_plus
id|i
op_star
l_int|4
)paren
suffix:semicolon
)brace
r_else
(brace
id|tp-&gt;tx_info
(braket
id|i
)braket
dot
id|mapping
op_assign
id|pci_map_single
c_func
(paren
id|tp-&gt;pdev
comma
id|skb-&gt;data
comma
id|skb-&gt;len
comma
id|PCI_DMA_TODEVICE
)paren
suffix:semicolon
id|outl
c_func
(paren
id|tp-&gt;tx_info
(braket
id|i
)braket
dot
id|mapping
comma
id|ioaddr
op_plus
id|TxAddr0
op_plus
id|i
op_star
l_int|4
)paren
suffix:semicolon
)brace
multiline_comment|/* Note: the chip doesn&squot;t have auto-pad! */
id|outl
c_func
(paren
id|tp-&gt;tx_flag
op_or
(paren
id|skb-&gt;len
op_ge
id|ETH_ZLEN
ques
c_cond
id|skb-&gt;len
suffix:colon
id|ETH_ZLEN
)paren
comma
id|ioaddr
op_plus
id|TxStatus0
op_plus
id|i
op_star
l_int|4
)paren
suffix:semicolon
)brace
id|tp-&gt;cur_tx
op_assign
id|i
suffix:semicolon
r_while
c_loop
(paren
id|i
OL
id|NUM_TX_DESC
)paren
(brace
id|tp-&gt;tx_info
(braket
id|i
)braket
dot
id|skb
op_assign
l_int|NULL
suffix:semicolon
id|tp-&gt;tx_info
(braket
id|i
)braket
dot
id|mapping
op_assign
l_int|0
suffix:semicolon
id|i
op_increment
suffix:semicolon
)brace
r_if
c_cond
(paren
id|tp-&gt;cur_tx
op_minus
id|tp-&gt;dirty_tx
OL
id|NUM_TX_DESC
)paren
(brace
multiline_comment|/* Typical path */
id|netif_wake_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
id|tp-&gt;tx_full
op_assign
l_int|0
suffix:semicolon
)brace
r_else
(brace
id|tp-&gt;tx_full
op_assign
l_int|1
suffix:semicolon
id|netif_stop_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
)brace
id|dev-&gt;trans_start
op_assign
id|jiffies
suffix:semicolon
id|tp-&gt;stats.tx_errors
op_increment
suffix:semicolon
multiline_comment|/* Enable all known interrupts by setting the interrupt mask. */
id|outw
c_func
(paren
id|PCIErr
op_or
id|PCSTimeout
op_or
id|RxUnderrun
op_or
id|RxOverflow
op_or
id|RxFIFOOver
op_or
id|TxErr
op_or
id|TxOK
op_or
id|RxErr
op_or
id|RxOK
comma
id|ioaddr
op_plus
id|IntrMask
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/* Initialize the Rx and Tx rings, along with various &squot;dev&squot; bits. */
r_static
r_void
DECL|function|rtl8129_init_ring
id|rtl8129_init_ring
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|rtl8129_private
op_star
id|tp
op_assign
(paren
r_struct
id|rtl8129_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_int
id|i
suffix:semicolon
id|tp-&gt;tx_full
op_assign
l_int|0
suffix:semicolon
id|tp-&gt;cur_rx
op_assign
l_int|0
suffix:semicolon
id|tp-&gt;dirty_tx
op_assign
id|tp-&gt;cur_tx
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|NUM_TX_DESC
suffix:semicolon
id|i
op_increment
)paren
(brace
id|tp-&gt;tx_buf
(braket
id|i
)braket
op_assign
op_amp
id|tp-&gt;tx_bufs
(braket
id|i
op_star
id|TX_BUF_SIZE
)braket
suffix:semicolon
id|tp-&gt;tx_info
(braket
id|i
)braket
dot
id|skb
op_assign
l_int|NULL
suffix:semicolon
id|tp-&gt;tx_info
(braket
id|i
)braket
dot
id|mapping
op_assign
l_int|0
suffix:semicolon
)brace
)brace
r_static
r_int
DECL|function|rtl8129_start_xmit
id|rtl8129_start_xmit
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|rtl8129_private
op_star
id|tp
op_assign
(paren
r_struct
id|rtl8129_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_int
id|ioaddr
op_assign
id|dev-&gt;base_addr
suffix:semicolon
r_int
id|entry
suffix:semicolon
id|netif_stop_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
multiline_comment|/* Calculate the next Tx descriptor entry. */
id|entry
op_assign
id|tp-&gt;cur_tx
op_mod
id|NUM_TX_DESC
suffix:semicolon
id|tp-&gt;tx_info
(braket
id|entry
)braket
dot
id|skb
op_assign
id|skb
suffix:semicolon
r_if
c_cond
(paren
(paren
r_int
)paren
id|skb-&gt;data
op_amp
l_int|3
)paren
(brace
multiline_comment|/* Must use alignment buffer. */
id|tp-&gt;tx_info
(braket
id|entry
)braket
dot
id|mapping
op_assign
l_int|0
suffix:semicolon
id|memcpy
c_func
(paren
id|tp-&gt;tx_buf
(braket
id|entry
)braket
comma
id|skb-&gt;data
comma
id|skb-&gt;len
)paren
suffix:semicolon
id|outl
c_func
(paren
id|tp-&gt;tx_bufs_dma
op_plus
(paren
id|tp-&gt;tx_buf
(braket
id|entry
)braket
op_minus
id|tp-&gt;tx_bufs
)paren
comma
id|ioaddr
op_plus
id|TxAddr0
op_plus
id|entry
op_star
l_int|4
)paren
suffix:semicolon
)brace
r_else
(brace
id|tp-&gt;tx_info
(braket
id|entry
)braket
dot
id|mapping
op_assign
id|pci_map_single
c_func
(paren
id|tp-&gt;pdev
comma
id|skb-&gt;data
comma
id|skb-&gt;len
comma
id|PCI_DMA_TODEVICE
)paren
suffix:semicolon
id|outl
c_func
(paren
id|tp-&gt;tx_info
(braket
id|entry
)braket
dot
id|mapping
comma
id|ioaddr
op_plus
id|TxAddr0
op_plus
id|entry
op_star
l_int|4
)paren
suffix:semicolon
)brace
multiline_comment|/* Note: the chip doesn&squot;t have auto-pad! */
id|outl
c_func
(paren
id|tp-&gt;tx_flag
op_or
(paren
id|skb-&gt;len
op_ge
id|ETH_ZLEN
ques
c_cond
id|skb-&gt;len
suffix:colon
id|ETH_ZLEN
)paren
comma
id|ioaddr
op_plus
id|TxStatus0
op_plus
id|entry
op_star
l_int|4
)paren
suffix:semicolon
r_if
c_cond
(paren
op_increment
id|tp-&gt;cur_tx
op_minus
id|tp-&gt;dirty_tx
OL
id|NUM_TX_DESC
)paren
(brace
multiline_comment|/* Typical path */
id|netif_start_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
r_else
(brace
id|tp-&gt;tx_full
op_assign
l_int|1
suffix:semicolon
)brace
id|dev-&gt;trans_start
op_assign
id|jiffies
suffix:semicolon
r_if
c_cond
(paren
id|rtl8129_debug
OG
l_int|4
)paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%s: Queued Tx packet at %p size %d to slot %d.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|skb-&gt;data
comma
(paren
r_int
)paren
id|skb-&gt;len
comma
id|entry
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* The interrupt handler does all of the Rx thread work and cleans up&n;   after the Tx thread. */
DECL|function|rtl8129_interrupt
r_static
r_void
id|rtl8129_interrupt
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_instance
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_struct
id|net_device
op_star
id|dev
op_assign
(paren
r_struct
id|net_device
op_star
)paren
id|dev_instance
suffix:semicolon
r_struct
id|rtl8129_private
op_star
id|tp
op_assign
(paren
r_struct
id|rtl8129_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_int
id|boguscnt
op_assign
id|max_interrupt_work
suffix:semicolon
r_int
id|status
comma
id|link_changed
op_assign
l_int|0
suffix:semicolon
r_int
id|ioaddr
op_assign
id|dev-&gt;base_addr
suffix:semicolon
r_do
(brace
id|status
op_assign
id|inw
c_func
(paren
id|ioaddr
op_plus
id|IntrStatus
)paren
suffix:semicolon
multiline_comment|/* Acknowledge all of the current interrupt sources ASAP, but&n;&t;&t;   an first get an additional status bit from CSCR. */
r_if
c_cond
(paren
(paren
id|status
op_amp
id|RxUnderrun
)paren
op_logical_and
id|inw
c_func
(paren
id|ioaddr
op_plus
id|CSCR
)paren
op_amp
id|CSCR_LinkChangeBit
)paren
id|link_changed
op_assign
l_int|1
suffix:semicolon
id|outw
c_func
(paren
id|status
comma
id|ioaddr
op_plus
id|IntrStatus
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rtl8129_debug
OG
l_int|4
)paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%s: interrupt  status=%#4.4x new intstat=%#4.4x.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|status
comma
id|inw
c_func
(paren
id|ioaddr
op_plus
id|IntrStatus
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|status
op_amp
(paren
id|PCIErr
op_or
id|PCSTimeout
op_or
id|RxUnderrun
op_or
id|RxOverflow
op_or
id|RxFIFOOver
op_or
id|TxErr
op_or
id|TxOK
op_or
id|RxErr
op_or
id|RxOK
)paren
)paren
op_eq
l_int|0
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
(paren
id|RxOK
op_or
id|RxUnderrun
op_or
id|RxOverflow
op_or
id|RxFIFOOver
)paren
)paren
multiline_comment|/* Rx interrupt */
id|rtl8129_rx
c_func
(paren
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
(paren
id|TxOK
op_or
id|TxErr
)paren
)paren
(brace
r_int
r_int
id|dirty_tx
op_assign
id|tp-&gt;dirty_tx
suffix:semicolon
r_while
c_loop
(paren
id|tp-&gt;cur_tx
op_minus
id|dirty_tx
OG
l_int|0
)paren
(brace
r_int
id|entry
op_assign
id|dirty_tx
op_mod
id|NUM_TX_DESC
suffix:semicolon
r_int
id|txstatus
op_assign
id|inl
c_func
(paren
id|ioaddr
op_plus
id|TxStatus0
op_plus
id|entry
op_star
l_int|4
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|txstatus
op_amp
(paren
id|TxStatOK
op_or
id|TxUnderrun
op_or
id|TxAborted
)paren
)paren
)paren
r_break
suffix:semicolon
multiline_comment|/* It still hasn&squot;t been Txed */
multiline_comment|/* Note: TxCarrierLost is always asserted at 100mbps. */
r_if
c_cond
(paren
id|txstatus
op_amp
(paren
id|TxOutOfWindow
op_or
id|TxAborted
)paren
)paren
(brace
multiline_comment|/* There was an major error, log it. */
r_if
c_cond
(paren
id|rtl8129_debug
OG
l_int|1
)paren
id|printk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;%s: Transmit error, Tx status %8.8x.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|txstatus
)paren
suffix:semicolon
id|tp-&gt;stats.tx_errors
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|txstatus
op_amp
id|TxAborted
)paren
(brace
id|tp-&gt;stats.tx_aborted_errors
op_increment
suffix:semicolon
id|outl
c_func
(paren
(paren
id|TX_DMA_BURST
op_lshift
l_int|8
)paren
op_or
l_int|0x03000001
comma
id|ioaddr
op_plus
id|TxConfig
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|txstatus
op_amp
id|TxCarrierLost
)paren
id|tp-&gt;stats.tx_carrier_errors
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|txstatus
op_amp
id|TxOutOfWindow
)paren
id|tp-&gt;stats.tx_window_errors
op_increment
suffix:semicolon
macro_line|#ifdef ETHER_STATS
r_if
c_cond
(paren
(paren
id|txstatus
op_amp
l_int|0x0f000000
)paren
op_eq
l_int|0x0f000000
)paren
id|tp-&gt;stats.collisions16
op_increment
suffix:semicolon
macro_line|#endif
)brace
r_else
(brace
r_if
c_cond
(paren
id|txstatus
op_amp
id|TxUnderrun
)paren
(brace
multiline_comment|/* Add 64 to the Tx FIFO threshold. */
r_if
c_cond
(paren
id|tp-&gt;tx_flag
OL
l_int|0x00300000
)paren
id|tp-&gt;tx_flag
op_add_assign
l_int|0x00020000
suffix:semicolon
id|tp-&gt;stats.tx_fifo_errors
op_increment
suffix:semicolon
)brace
id|tp-&gt;stats.collisions
op_add_assign
(paren
id|txstatus
op_rshift
l_int|24
)paren
op_amp
l_int|15
suffix:semicolon
macro_line|#if LINUX_VERSION_CODE &gt; 0x20119
id|tp-&gt;stats.tx_bytes
op_add_assign
id|txstatus
op_amp
l_int|0x7ff
suffix:semicolon
macro_line|#endif
id|tp-&gt;stats.tx_packets
op_increment
suffix:semicolon
)brace
r_if
c_cond
(paren
id|tp-&gt;tx_info
(braket
id|entry
)braket
dot
id|mapping
op_ne
l_int|0
)paren
(brace
id|pci_unmap_single
c_func
(paren
id|tp-&gt;pdev
comma
id|tp-&gt;tx_info
(braket
id|entry
)braket
dot
id|mapping
comma
id|tp-&gt;tx_info
(braket
id|entry
)braket
dot
id|skb-&gt;len
comma
id|PCI_DMA_TODEVICE
)paren
suffix:semicolon
id|tp-&gt;tx_info
(braket
id|entry
)braket
dot
id|mapping
op_assign
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Free the original skb. */
id|dev_kfree_skb_irq
c_func
(paren
id|tp-&gt;tx_info
(braket
id|entry
)braket
dot
id|skb
)paren
suffix:semicolon
id|tp-&gt;tx_info
(braket
id|entry
)braket
dot
id|skb
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
id|tp-&gt;tx_full
)paren
(brace
multiline_comment|/* The ring is no longer full, wake the queue. */
id|tp-&gt;tx_full
op_assign
l_int|0
suffix:semicolon
id|netif_wake_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
id|dirty_tx
op_increment
suffix:semicolon
)brace
macro_line|#ifndef final_version
r_if
c_cond
(paren
id|tp-&gt;cur_tx
op_minus
id|dirty_tx
OG
id|NUM_TX_DESC
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: Out-of-sync dirty pointer, %d vs. %d, full=%d.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|dirty_tx
comma
id|tp-&gt;cur_tx
comma
id|tp-&gt;tx_full
)paren
suffix:semicolon
id|dirty_tx
op_add_assign
id|NUM_TX_DESC
suffix:semicolon
)brace
macro_line|#endif
id|tp-&gt;dirty_tx
op_assign
id|dirty_tx
suffix:semicolon
)brace
multiline_comment|/* Check uncommon events with one test. */
r_if
c_cond
(paren
id|status
op_amp
(paren
id|PCIErr
op_or
id|PCSTimeout
op_or
id|RxUnderrun
op_or
id|RxOverflow
op_or
id|RxFIFOOver
op_or
id|TxErr
op_or
id|RxErr
)paren
)paren
(brace
r_if
c_cond
(paren
id|rtl8129_debug
OG
l_int|2
)paren
id|printk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;%s: Abnormal interrupt, status %8.8x.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|status
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
op_eq
l_int|0xffffffff
)paren
r_break
suffix:semicolon
multiline_comment|/* Update the error count. */
id|tp-&gt;stats.rx_missed_errors
op_add_assign
id|inl
c_func
(paren
id|ioaddr
op_plus
id|RxMissed
)paren
suffix:semicolon
id|outl
c_func
(paren
l_int|0
comma
id|ioaddr
op_plus
id|RxMissed
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|status
op_amp
id|RxUnderrun
)paren
op_logical_and
id|link_changed
op_logical_and
(paren
id|rtl_cap_tbl
(braket
id|tp-&gt;chip_id
)braket
op_amp
id|HAS_LNK_CHNG
)paren
)paren
(brace
multiline_comment|/* Really link-change on new chips. */
r_int
id|lpar
op_assign
id|inw
c_func
(paren
id|ioaddr
op_plus
id|NWayLPAR
)paren
suffix:semicolon
r_int
id|duplex
op_assign
(paren
id|lpar
op_amp
l_int|0x0100
)paren
op_logical_or
(paren
id|lpar
op_amp
l_int|0x01C0
)paren
op_eq
l_int|0x0040
suffix:semicolon
r_if
c_cond
(paren
id|tp-&gt;full_duplex
op_ne
id|duplex
)paren
(brace
id|tp-&gt;full_duplex
op_assign
id|duplex
suffix:semicolon
id|outb
c_func
(paren
l_int|0xC0
comma
id|ioaddr
op_plus
id|Cfg9346
)paren
suffix:semicolon
id|outb
c_func
(paren
id|tp-&gt;full_duplex
ques
c_cond
l_int|0x60
suffix:colon
l_int|0x20
comma
id|ioaddr
op_plus
id|Config1
)paren
suffix:semicolon
id|outb
c_func
(paren
l_int|0x00
comma
id|ioaddr
op_plus
id|Cfg9346
)paren
suffix:semicolon
)brace
id|status
op_and_assign
op_complement
id|RxUnderrun
suffix:semicolon
)brace
r_if
c_cond
(paren
id|status
op_amp
(paren
id|RxUnderrun
op_or
id|RxOverflow
op_or
id|RxErr
op_or
id|RxFIFOOver
)paren
)paren
id|tp-&gt;stats.rx_errors
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
(paren
id|PCSTimeout
)paren
)paren
id|tp-&gt;stats.rx_length_errors
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
(paren
id|RxUnderrun
op_or
id|RxFIFOOver
)paren
)paren
id|tp-&gt;stats.rx_fifo_errors
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
id|RxOverflow
)paren
(brace
id|tp-&gt;stats.rx_over_errors
op_increment
suffix:semicolon
id|tp-&gt;cur_rx
op_assign
id|inw
c_func
(paren
id|ioaddr
op_plus
id|RxBufAddr
)paren
op_mod
id|RX_BUF_LEN
suffix:semicolon
id|outw
c_func
(paren
id|tp-&gt;cur_rx
op_minus
l_int|16
comma
id|ioaddr
op_plus
id|RxBufPtr
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|status
op_amp
id|PCIErr
)paren
(brace
id|u32
id|pci_cmd_status
suffix:semicolon
id|pcibios_read_config_dword
c_func
(paren
id|tp-&gt;pci_bus
comma
id|tp-&gt;pci_devfn
comma
id|PCI_COMMAND
comma
op_amp
id|pci_cmd_status
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: PCI Bus error %4.4x.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|pci_cmd_status
)paren
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
op_decrement
id|boguscnt
OL
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: Too much work at interrupt, &quot;
l_string|&quot;IntrStatus=0x%4.4x.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|status
)paren
suffix:semicolon
multiline_comment|/* Clear all interrupt sources. */
id|outw
c_func
(paren
l_int|0xffff
comma
id|ioaddr
op_plus
id|IntrStatus
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
r_while
c_loop
(paren
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rtl8129_debug
OG
l_int|3
)paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%s: exiting interrupt, intr_status=%#4.4x.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|inl
c_func
(paren
id|ioaddr
op_plus
id|IntrStatus
)paren
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/* The data sheet doesn&squot;t describe the Rx ring at all, so I&squot;m guessing at the&n;   field alignments and semantics. */
DECL|function|rtl8129_rx
r_static
r_int
id|rtl8129_rx
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|rtl8129_private
op_star
id|tp
op_assign
(paren
r_struct
id|rtl8129_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_int
id|ioaddr
op_assign
id|dev-&gt;base_addr
suffix:semicolon
r_int
r_char
op_star
id|rx_ring
op_assign
id|tp-&gt;rx_ring
suffix:semicolon
id|u16
id|cur_rx
op_assign
id|tp-&gt;cur_rx
suffix:semicolon
r_if
c_cond
(paren
id|rtl8129_debug
OG
l_int|4
)paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%s: In rtl8129_rx(), current %4.4x BufAddr %4.4x,&quot;
l_string|&quot; free to %4.4x, Cmd %2.2x.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|cur_rx
comma
id|inw
c_func
(paren
id|ioaddr
op_plus
id|RxBufAddr
)paren
comma
id|inw
c_func
(paren
id|ioaddr
op_plus
id|RxBufPtr
)paren
comma
id|inb
c_func
(paren
id|ioaddr
op_plus
id|ChipCmd
)paren
)paren
suffix:semicolon
r_while
c_loop
(paren
(paren
id|inb
c_func
(paren
id|ioaddr
op_plus
id|ChipCmd
)paren
op_amp
l_int|1
)paren
op_eq
l_int|0
)paren
(brace
r_int
id|ring_offset
op_assign
id|cur_rx
op_mod
id|RX_BUF_LEN
suffix:semicolon
id|u32
id|rx_status
op_assign
id|le32_to_cpu
c_func
(paren
op_star
(paren
id|u32
op_star
)paren
(paren
id|rx_ring
op_plus
id|ring_offset
)paren
)paren
suffix:semicolon
r_int
id|rx_size
op_assign
id|rx_status
op_rshift
l_int|16
suffix:semicolon
r_if
c_cond
(paren
id|rtl8129_debug
OG
l_int|4
)paren
(brace
r_int
id|i
suffix:semicolon
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%s:  rtl8129_rx() status %4.4x, size %4.4x, cur %4.4x.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|rx_status
comma
id|rx_size
comma
id|cur_rx
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%s: Frame contents &quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|70
suffix:semicolon
id|i
op_increment
)paren
id|printk
c_func
(paren
l_string|&quot; %2.2x&quot;
comma
id|le32_to_cpu
c_func
(paren
id|rx_ring
(braket
id|ring_offset
op_plus
id|i
)braket
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;.&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|rx_status
op_amp
id|RxTooLong
)paren
(brace
r_if
c_cond
(paren
id|rtl8129_debug
OG
l_int|0
)paren
id|printk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;%s: Oversized Ethernet frame, status %4.4x!&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|rx_status
)paren
suffix:semicolon
id|tp-&gt;stats.rx_length_errors
op_increment
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|rx_status
op_amp
(paren
id|RxBadSymbol
op_or
id|RxRunt
op_or
id|RxTooLong
op_or
id|RxCRCErr
op_or
id|RxBadAlign
)paren
)paren
(brace
r_if
c_cond
(paren
id|rtl8129_debug
OG
l_int|1
)paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%s: Ethernet frame had errors,&quot;
l_string|&quot; status %4.4x.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|rx_status
)paren
suffix:semicolon
id|tp-&gt;stats.rx_errors
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|rx_status
op_amp
(paren
id|RxBadSymbol
op_or
id|RxBadAlign
)paren
)paren
id|tp-&gt;stats.rx_frame_errors
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|rx_status
op_amp
(paren
id|RxRunt
op_or
id|RxTooLong
)paren
)paren
id|tp-&gt;stats.rx_length_errors
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|rx_status
op_amp
id|RxCRCErr
)paren
id|tp-&gt;stats.rx_crc_errors
op_increment
suffix:semicolon
multiline_comment|/* Reset the receiver, based on RealTek recommendation. (Bug?) */
id|tp-&gt;cur_rx
op_assign
l_int|0
suffix:semicolon
id|outb
c_func
(paren
id|CmdTxEnb
comma
id|ioaddr
op_plus
id|ChipCmd
)paren
suffix:semicolon
id|outb
c_func
(paren
id|CmdRxEnb
op_or
id|CmdTxEnb
comma
id|ioaddr
op_plus
id|ChipCmd
)paren
suffix:semicolon
id|outl
c_func
(paren
(paren
id|RX_FIFO_THRESH
op_lshift
l_int|13
)paren
op_or
(paren
id|RX_BUF_LEN_IDX
op_lshift
l_int|11
)paren
op_or
(paren
id|RX_DMA_BURST
op_lshift
l_int|8
)paren
comma
id|ioaddr
op_plus
id|RxConfig
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* Malloc up new buffer, compatible with net-2e. */
multiline_comment|/* Omit the four octet CRC from the length. */
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
r_int
id|pkt_size
op_assign
id|rx_size
op_minus
l_int|4
suffix:semicolon
id|skb
op_assign
id|dev_alloc_skb
c_func
(paren
id|pkt_size
op_plus
l_int|2
)paren
suffix:semicolon
r_if
c_cond
(paren
id|skb
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: Memory squeeze, deferring packet.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
multiline_comment|/* We should check that some rx space is free.&n;&t;&t;&t;&t;   If not, free one and mark stats-&gt;rx_dropped++. */
id|tp-&gt;stats.rx_dropped
op_increment
suffix:semicolon
r_break
suffix:semicolon
)brace
id|skb-&gt;dev
op_assign
id|dev
suffix:semicolon
id|skb_reserve
c_func
(paren
id|skb
comma
l_int|2
)paren
suffix:semicolon
multiline_comment|/* 16 byte align the IP fields. */
r_if
c_cond
(paren
id|ring_offset
op_plus
id|rx_size
OG
id|RX_BUF_LEN
)paren
(brace
r_int
id|semi_count
op_assign
id|RX_BUF_LEN
op_minus
id|ring_offset
op_minus
l_int|4
suffix:semicolon
id|memcpy
c_func
(paren
id|skb_put
c_func
(paren
id|skb
comma
id|semi_count
)paren
comma
op_amp
id|rx_ring
(braket
id|ring_offset
op_plus
l_int|4
)braket
comma
id|semi_count
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|skb_put
c_func
(paren
id|skb
comma
id|pkt_size
op_minus
id|semi_count
)paren
comma
id|rx_ring
comma
id|pkt_size
op_minus
id|semi_count
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rtl8129_debug
OG
l_int|4
)paren
(brace
r_int
id|i
suffix:semicolon
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%s:  Frame wrap @%d&quot;
comma
id|dev-&gt;name
comma
id|semi_count
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|16
suffix:semicolon
id|i
op_increment
)paren
id|printk
c_func
(paren
l_string|&quot; %2.2x&quot;
comma
id|le32_to_cpu
c_func
(paren
id|rx_ring
(braket
id|i
)braket
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;.&bslash;n&quot;
)paren
suffix:semicolon
id|memset
c_func
(paren
id|rx_ring
comma
l_int|0xcc
comma
l_int|16
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
macro_line|#if 1  /* USE_IP_COPYSUM */
id|eth_copy_and_sum
c_func
(paren
id|skb
comma
op_amp
id|rx_ring
(braket
id|ring_offset
op_plus
l_int|4
)braket
comma
id|pkt_size
comma
l_int|0
)paren
suffix:semicolon
id|skb_put
c_func
(paren
id|skb
comma
id|pkt_size
)paren
suffix:semicolon
macro_line|#else
id|memcpy
c_func
(paren
id|skb_put
c_func
(paren
id|skb
comma
id|pkt_size
)paren
comma
op_amp
id|rx_ring
(braket
id|ring_offset
op_plus
l_int|4
)braket
comma
id|pkt_size
)paren
suffix:semicolon
macro_line|#endif
)brace
id|skb-&gt;protocol
op_assign
id|eth_type_trans
c_func
(paren
id|skb
comma
id|dev
)paren
suffix:semicolon
id|netif_rx
c_func
(paren
id|skb
)paren
suffix:semicolon
macro_line|#if LINUX_VERSION_CODE &gt; 0x20119
id|tp-&gt;stats.rx_bytes
op_add_assign
id|pkt_size
suffix:semicolon
macro_line|#endif
id|tp-&gt;stats.rx_packets
op_increment
suffix:semicolon
)brace
id|cur_rx
op_assign
(paren
id|cur_rx
op_plus
id|rx_size
op_plus
l_int|4
op_plus
l_int|3
)paren
op_amp
op_complement
l_int|3
suffix:semicolon
id|outw
c_func
(paren
id|cur_rx
op_minus
l_int|16
comma
id|ioaddr
op_plus
id|RxBufPtr
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|rtl8129_debug
OG
l_int|4
)paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%s: Done rtl8129_rx(), current %4.4x BufAddr %4.4x,&quot;
l_string|&quot; free to %4.4x, Cmd %2.2x.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|cur_rx
comma
id|inw
c_func
(paren
id|ioaddr
op_plus
id|RxBufAddr
)paren
comma
id|inw
c_func
(paren
id|ioaddr
op_plus
id|RxBufPtr
)paren
comma
id|inb
c_func
(paren
id|ioaddr
op_plus
id|ChipCmd
)paren
)paren
suffix:semicolon
id|tp-&gt;cur_rx
op_assign
id|cur_rx
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_int
DECL|function|rtl8129_close
id|rtl8129_close
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_int
id|ioaddr
op_assign
id|dev-&gt;base_addr
suffix:semicolon
r_struct
id|rtl8129_private
op_star
id|tp
op_assign
(paren
r_struct
id|rtl8129_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_int
id|i
suffix:semicolon
id|netif_stop_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
id|del_timer_sync
c_func
(paren
op_amp
id|tp-&gt;timer
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rtl8129_debug
OG
l_int|1
)paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%s: Shutting down ethercard, status was 0x%4.4x.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|inw
c_func
(paren
id|ioaddr
op_plus
id|IntrStatus
)paren
)paren
suffix:semicolon
multiline_comment|/* Disable interrupts by clearing the interrupt mask. */
id|outw
c_func
(paren
l_int|0x0000
comma
id|ioaddr
op_plus
id|IntrMask
)paren
suffix:semicolon
multiline_comment|/* Stop the chip&squot;s Tx and Rx DMA processes. */
id|outb
c_func
(paren
l_int|0x00
comma
id|ioaddr
op_plus
id|ChipCmd
)paren
suffix:semicolon
multiline_comment|/* Update the error counts. */
id|tp-&gt;stats.rx_missed_errors
op_add_assign
id|inl
c_func
(paren
id|ioaddr
op_plus
id|RxMissed
)paren
suffix:semicolon
id|outl
c_func
(paren
l_int|0
comma
id|ioaddr
op_plus
id|RxMissed
)paren
suffix:semicolon
id|free_irq
c_func
(paren
id|dev-&gt;irq
comma
id|dev
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|NUM_TX_DESC
suffix:semicolon
id|i
op_increment
)paren
(brace
r_struct
id|sk_buff
op_star
id|skb
op_assign
id|tp-&gt;tx_info
(braket
id|i
)braket
dot
id|skb
suffix:semicolon
id|dma_addr_t
id|mapping
op_assign
id|tp-&gt;tx_info
(braket
id|i
)braket
dot
id|mapping
suffix:semicolon
r_if
c_cond
(paren
id|skb
)paren
(brace
r_if
c_cond
(paren
id|mapping
)paren
id|pci_unmap_single
c_func
(paren
id|tp-&gt;pdev
comma
id|mapping
comma
id|skb-&gt;len
comma
id|PCI_DMA_TODEVICE
)paren
suffix:semicolon
id|dev_kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
)brace
id|tp-&gt;tx_info
(braket
id|i
)braket
dot
id|skb
op_assign
l_int|NULL
suffix:semicolon
id|tp-&gt;tx_info
(braket
id|i
)braket
dot
id|mapping
op_assign
l_int|0
suffix:semicolon
)brace
id|pci_free_consistent
c_func
(paren
id|tp-&gt;pdev
comma
id|RX_BUF_LEN
op_plus
l_int|16
comma
id|tp-&gt;rx_ring
comma
id|tp-&gt;rx_ring_dma
)paren
suffix:semicolon
id|pci_free_consistent
c_func
(paren
id|tp-&gt;pdev
comma
id|TX_BUF_SIZE
op_star
id|NUM_TX_DESC
comma
id|tp-&gt;tx_bufs
comma
id|tp-&gt;tx_bufs_dma
)paren
suffix:semicolon
id|tp-&gt;rx_ring
op_assign
l_int|NULL
suffix:semicolon
id|tp-&gt;tx_bufs
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/* Green! Put the chip in low-power mode. */
id|outb
c_func
(paren
l_int|0xC0
comma
id|ioaddr
op_plus
id|Cfg9346
)paren
suffix:semicolon
id|outb
c_func
(paren
l_int|0x03
comma
id|ioaddr
op_plus
id|Config1
)paren
suffix:semicolon
id|outb
c_func
(paren
l_char|&squot;H&squot;
comma
id|ioaddr
op_plus
id|HltClk
)paren
suffix:semicolon
multiline_comment|/* &squot;R&squot; would leave the clock running. */
id|MOD_DEC_USE_COUNT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|mii_ioctl
r_static
r_int
id|mii_ioctl
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_struct
id|ifreq
op_star
id|rq
comma
r_int
id|cmd
)paren
(brace
r_struct
id|rtl8129_private
op_star
id|tp
op_assign
(paren
r_struct
id|rtl8129_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|u16
op_star
id|data
op_assign
(paren
id|u16
op_star
)paren
op_amp
id|rq-&gt;ifr_data
suffix:semicolon
r_switch
c_cond
(paren
id|cmd
)paren
(brace
r_case
id|SIOCDEVPRIVATE
suffix:colon
multiline_comment|/* Get the address of the PHY in use. */
id|data
(braket
l_int|0
)braket
op_assign
id|tp-&gt;phys
(braket
l_int|0
)braket
op_amp
l_int|0x3f
suffix:semicolon
multiline_comment|/* Fall Through */
r_case
id|SIOCDEVPRIVATE
op_plus
l_int|1
suffix:colon
multiline_comment|/* Read the specified MII register. */
id|data
(braket
l_int|3
)braket
op_assign
id|mdio_read
c_func
(paren
id|dev
comma
id|data
(braket
l_int|0
)braket
comma
id|data
(braket
l_int|1
)braket
op_amp
l_int|0x1f
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
r_case
id|SIOCDEVPRIVATE
op_plus
l_int|2
suffix:colon
multiline_comment|/* Write the specified MII register */
r_if
c_cond
(paren
op_logical_neg
id|capable
c_func
(paren
id|CAP_NET_ADMIN
)paren
)paren
r_return
op_minus
id|EPERM
suffix:semicolon
id|mdio_write
c_func
(paren
id|dev
comma
id|data
(braket
l_int|0
)braket
comma
id|data
(braket
l_int|1
)braket
op_amp
l_int|0x1f
comma
id|data
(braket
l_int|2
)braket
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
r_default
suffix:colon
r_return
op_minus
id|EOPNOTSUPP
suffix:semicolon
)brace
)brace
r_static
r_struct
id|net_device_stats
op_star
DECL|function|rtl8129_get_stats
id|rtl8129_get_stats
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|rtl8129_private
op_star
id|tp
op_assign
(paren
r_struct
id|rtl8129_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_int
id|ioaddr
op_assign
id|dev-&gt;base_addr
suffix:semicolon
r_if
c_cond
(paren
id|netif_running
c_func
(paren
id|dev
)paren
)paren
(brace
id|tp-&gt;stats.rx_missed_errors
op_add_assign
id|inl
c_func
(paren
id|ioaddr
op_plus
id|RxMissed
)paren
suffix:semicolon
id|outl
c_func
(paren
l_int|0
comma
id|ioaddr
op_plus
id|RxMissed
)paren
suffix:semicolon
)brace
r_return
op_amp
id|tp-&gt;stats
suffix:semicolon
)brace
multiline_comment|/* Set or clear the multicast filter for this adaptor.&n;   This routine is not state sensitive and need not be SMP locked. */
DECL|variable|ethernet_polynomial
r_static
r_int
r_const
id|ethernet_polynomial
op_assign
l_int|0x04c11db7U
suffix:semicolon
DECL|function|ether_crc
r_static
r_inline
id|u32
id|ether_crc
c_func
(paren
r_int
id|length
comma
r_int
r_char
op_star
id|data
)paren
(brace
r_int
id|crc
op_assign
op_minus
l_int|1
suffix:semicolon
r_while
c_loop
(paren
op_decrement
id|length
op_ge
l_int|0
)paren
(brace
r_int
r_char
id|current_octet
op_assign
op_star
id|data
op_increment
suffix:semicolon
r_int
id|bit
suffix:semicolon
r_for
c_loop
(paren
id|bit
op_assign
l_int|0
suffix:semicolon
id|bit
OL
l_int|8
suffix:semicolon
id|bit
op_increment
comma
id|current_octet
op_rshift_assign
l_int|1
)paren
id|crc
op_assign
(paren
id|crc
op_lshift
l_int|1
)paren
op_xor
(paren
(paren
id|crc
OL
l_int|0
)paren
op_xor
(paren
id|current_octet
op_amp
l_int|1
)paren
ques
c_cond
id|ethernet_polynomial
suffix:colon
l_int|0
)paren
suffix:semicolon
)brace
r_return
id|crc
suffix:semicolon
)brace
multiline_comment|/* Bits in RxConfig. */
DECL|enum|rx_mode_bits
r_enum
id|rx_mode_bits
(brace
DECL|enumerator|AcceptErr
DECL|enumerator|AcceptRunt
DECL|enumerator|AcceptBroadcast
id|AcceptErr
op_assign
l_int|0x20
comma
id|AcceptRunt
op_assign
l_int|0x10
comma
id|AcceptBroadcast
op_assign
l_int|0x08
comma
DECL|enumerator|AcceptMulticast
DECL|enumerator|AcceptMyPhys
DECL|enumerator|AcceptAllPhys
id|AcceptMulticast
op_assign
l_int|0x04
comma
id|AcceptMyPhys
op_assign
l_int|0x02
comma
id|AcceptAllPhys
op_assign
l_int|0x01
comma
)brace
suffix:semicolon
DECL|function|set_rx_mode
r_static
r_void
id|set_rx_mode
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_int
id|ioaddr
op_assign
id|dev-&gt;base_addr
suffix:semicolon
id|u32
id|mc_filter
(braket
l_int|2
)braket
suffix:semicolon
multiline_comment|/* Multicast hash filter */
r_int
id|i
comma
id|rx_mode
suffix:semicolon
r_if
c_cond
(paren
id|rtl8129_debug
OG
l_int|3
)paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%s:   set_rx_mode(%4.4x) done -- Rx config %8.8x.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|dev-&gt;flags
comma
id|inl
c_func
(paren
id|ioaddr
op_plus
id|RxConfig
)paren
)paren
suffix:semicolon
multiline_comment|/* Note: do not reorder, GCC is clever about common statements. */
r_if
c_cond
(paren
id|dev-&gt;flags
op_amp
id|IFF_PROMISC
)paren
(brace
multiline_comment|/* Unconditionally log net taps. */
id|printk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;%s: Promiscuous mode enabled.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|rx_mode
op_assign
id|AcceptBroadcast
op_or
id|AcceptMulticast
op_or
id|AcceptMyPhys
op_or
id|AcceptAllPhys
suffix:semicolon
id|mc_filter
(braket
l_int|1
)braket
op_assign
id|mc_filter
(braket
l_int|0
)braket
op_assign
l_int|0xffffffff
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
(paren
id|dev-&gt;mc_count
OG
id|multicast_filter_limit
)paren
op_logical_or
(paren
id|dev-&gt;flags
op_amp
id|IFF_ALLMULTI
)paren
)paren
(brace
multiline_comment|/* Too many to filter perfectly -- accept all multicasts. */
id|rx_mode
op_assign
id|AcceptBroadcast
op_or
id|AcceptMulticast
op_or
id|AcceptMyPhys
suffix:semicolon
id|mc_filter
(braket
l_int|1
)braket
op_assign
id|mc_filter
(braket
l_int|0
)braket
op_assign
l_int|0xffffffff
suffix:semicolon
)brace
r_else
(brace
r_struct
id|dev_mc_list
op_star
id|mclist
suffix:semicolon
id|rx_mode
op_assign
id|AcceptBroadcast
op_or
id|AcceptMulticast
op_or
id|AcceptMyPhys
suffix:semicolon
id|mc_filter
(braket
l_int|1
)braket
op_assign
id|mc_filter
(braket
l_int|0
)braket
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
comma
id|mclist
op_assign
id|dev-&gt;mc_list
suffix:semicolon
id|mclist
op_logical_and
id|i
OL
id|dev-&gt;mc_count
suffix:semicolon
id|i
op_increment
comma
id|mclist
op_assign
id|mclist-&gt;next
)paren
id|set_bit
c_func
(paren
id|ether_crc
c_func
(paren
id|ETH_ALEN
comma
id|mclist-&gt;dmi_addr
)paren
op_rshift
l_int|26
comma
id|mc_filter
)paren
suffix:semicolon
)brace
multiline_comment|/* We can safely update without stopping the chip. */
id|outb
c_func
(paren
id|rx_mode
comma
id|ioaddr
op_plus
id|RxConfig
)paren
suffix:semicolon
id|outl
c_func
(paren
id|mc_filter
(braket
l_int|0
)braket
comma
id|ioaddr
op_plus
id|MAR0
op_plus
l_int|0
)paren
suffix:semicolon
id|outl
c_func
(paren
id|mc_filter
(braket
l_int|1
)braket
comma
id|ioaddr
op_plus
id|MAR0
op_plus
l_int|4
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
"&f;"
DECL|function|rtl8129_cleanup
r_static
r_void
id|__exit
id|rtl8129_cleanup
(paren
r_void
)paren
(brace
r_struct
id|net_device
op_star
id|next_dev
suffix:semicolon
multiline_comment|/* No need to check MOD_IN_USE, as sys_delete_module() checks. */
r_while
c_loop
(paren
id|root_rtl8129_dev
)paren
(brace
r_struct
id|rtl8129_private
op_star
id|tp
op_assign
(paren
r_struct
id|rtl8129_private
op_star
)paren
id|root_rtl8129_dev-&gt;priv
suffix:semicolon
id|next_dev
op_assign
id|tp-&gt;next_module
suffix:semicolon
id|unregister_netdev
c_func
(paren
id|root_rtl8129_dev
)paren
suffix:semicolon
id|release_region
c_func
(paren
id|root_rtl8129_dev-&gt;base_addr
comma
id|pci_tbl
(braket
id|tp-&gt;chip_id
)braket
dot
id|io_size
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|tp
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|root_rtl8129_dev
)paren
suffix:semicolon
id|root_rtl8129_dev
op_assign
id|next_dev
suffix:semicolon
)brace
)brace
DECL|variable|rtl8129_probe
id|module_init
c_func
(paren
id|rtl8129_probe
)paren
suffix:semicolon
DECL|variable|rtl8129_cleanup
id|module_exit
c_func
(paren
id|rtl8129_cleanup
)paren
suffix:semicolon
multiline_comment|/*&n; * Local variables:&n; *  compile-command: &quot;gcc -DMODULE -D__KERNEL__ -Wall -Wstrict-prototypes -O6 -c rtl8129.c `[ -f /usr/include/linux/modversions.h ] &amp;&amp; echo -DMODVERSIONS`&quot;&n; *  c-indent-level: 4&n; *  c-basic-offset: 4&n; *  tab-width: 4&n; * End:&n; */
eof
