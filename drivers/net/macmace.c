multiline_comment|/*&n; *&t;Driver for the Macintosh 68K onboard MACE controller with PSC&n; *&t;driven DMA. The MACE driver code is derived from mace.c. The&n; *&t;Mac68k theory of operation is courtesy of the MacBSD wizards.&n; *&n; *&t;This program is free software; you can redistribute it and/or&n; *&t;modify it under the terms of the GNU General Public License&n; *&t;as published by the Free Software Foundation; either version&n; *&t;2 of the License, or (at your option) any later version.&n; *&n; *&t;Copyright (C) 1996 Paul Mackerras.&n; *&t;Copyright (C) 1998 Alan Cox &lt;alan@redhat.com&gt;&n; */
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/netdevice.h&gt;
macro_line|#include &lt;linux/etherdevice.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/timer.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/pgtable.h&gt;
macro_line|#include &lt;asm/irq.h&gt;
macro_line|#include &lt;asm/macintosh.h&gt;
macro_line|#include &lt;asm/macints.h&gt;
macro_line|#include &lt;asm/mac_psc.h&gt;
macro_line|#include &quot;mace.h&quot;
DECL|macro|N_RX_RING
mdefine_line|#define N_RX_RING&t;8
DECL|macro|N_TX_RING
mdefine_line|#define N_TX_RING&t;2
DECL|macro|MAX_TX_ACTIVE
mdefine_line|#define MAX_TX_ACTIVE&t;1
DECL|macro|NCMDS_TX
mdefine_line|#define NCMDS_TX&t;1&t;/* dma commands per element in tx ring */
DECL|macro|RX_BUFLEN
mdefine_line|#define RX_BUFLEN&t;(ETH_FRAME_LEN + 8)
DECL|macro|TX_TIMEOUT
mdefine_line|#define TX_TIMEOUT&t;HZ&t;/* 1 second */
multiline_comment|/* Bits in transmit DMA status */
DECL|macro|TX_DMA_ERR
mdefine_line|#define TX_DMA_ERR&t;0x80
multiline_comment|/* The MACE is simply wired down on a Mac68K box */
DECL|macro|MACE_BASE
mdefine_line|#define MACE_BASE&t;(void *)(0x50F1C000)
DECL|macro|MACE_PROM
mdefine_line|#define MACE_PROM&t;(void *)(0x50F08001)
DECL|struct|mace68k_data
r_struct
id|mace68k_data
(brace
DECL|member|mace
r_volatile
r_struct
id|mace
op_star
id|mace
suffix:semicolon
DECL|member|tx_ring
r_volatile
r_int
r_char
op_star
id|tx_ring
suffix:semicolon
DECL|member|rx_ring
r_volatile
r_int
r_char
op_star
id|rx_ring
suffix:semicolon
DECL|member|dma_intr
r_int
id|dma_intr
suffix:semicolon
DECL|member|maccc
r_int
r_char
id|maccc
suffix:semicolon
DECL|member|stats
r_struct
id|net_device_stats
id|stats
suffix:semicolon
DECL|member|tx_timeout
r_struct
id|timer_list
id|tx_timeout
suffix:semicolon
DECL|member|timeout_active
r_int
id|timeout_active
suffix:semicolon
DECL|member|rx_slot
DECL|member|rx_done
r_int
id|rx_slot
comma
id|rx_done
suffix:semicolon
DECL|member|tx_slot
DECL|member|tx_count
r_int
id|tx_slot
comma
id|tx_count
suffix:semicolon
)brace
suffix:semicolon
DECL|struct|mace_frame
r_struct
id|mace_frame
(brace
DECL|member|len
id|u16
id|len
suffix:semicolon
DECL|member|status
id|u16
id|status
suffix:semicolon
DECL|member|rntpc
id|u16
id|rntpc
suffix:semicolon
DECL|member|rcvcc
id|u16
id|rcvcc
suffix:semicolon
DECL|member|pad1
id|u32
id|pad1
suffix:semicolon
DECL|member|pad2
id|u32
id|pad2
suffix:semicolon
DECL|member|data
id|u8
id|data
(braket
l_int|1
)braket
suffix:semicolon
multiline_comment|/* And frame continues.. */
)brace
suffix:semicolon
DECL|macro|PRIV_BYTES
mdefine_line|#define PRIV_BYTES&t;sizeof(struct mace68k_data)
r_extern
r_void
id|psc_debug_dump
c_func
(paren
r_void
)paren
suffix:semicolon
r_static
r_int
id|mace68k_open
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_int
id|mace68k_close
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_int
id|mace68k_xmit_start
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_struct
id|net_device_stats
op_star
id|mace68k_stats
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_void
id|mace68k_set_multicast
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_void
id|mace68k_reset
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_int
id|mace68k_set_address
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_void
op_star
id|addr
)paren
suffix:semicolon
r_static
r_void
id|mace68k_interrupt
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
suffix:semicolon
r_static
r_void
id|mace68k_dma_intr
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
suffix:semicolon
r_static
r_void
id|mace68k_set_timeout
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_void
id|mace68k_tx_timeout
c_func
(paren
r_int
r_int
id|data
)paren
suffix:semicolon
multiline_comment|/*&n; *&t;PSC DMA engine control. As you&squot;d expect on a macintosh its&n; *&t;more like a lawnmower engine supplied without instructions&n; *&n; *&t;The basic theory of operation appears to be as follows.&n; *&n; *&t;There are two sets of receive DMA registers and two sets&n; *&t;of transmit DMA registers. Instead of the more traditional&n; *&t;&quot;ring buffer&quot; approach the Mac68K DMA engine expects you&n; *&t;to be loading one chain while the other runs, and then&n; *&t;to flip register set. Each entry in the chain is a fixed &n; *&t;length.&n; */
multiline_comment|/*&n; *&t;Load a receive DMA channel with a base address and ring length&n; */
DECL|function|psc_load_rxdma_base
r_static
r_void
id|psc_load_rxdma_base
c_func
(paren
r_int
id|set
comma
r_void
op_star
id|base
)paren
(brace
id|psc_write_word
c_func
(paren
id|PSC_ENETRD_CMD
op_plus
id|set
comma
l_int|0x0100
)paren
suffix:semicolon
id|psc_write_long
c_func
(paren
id|PSC_ENETRD_ADDR
op_plus
id|set
comma
(paren
id|u32
)paren
id|base
)paren
suffix:semicolon
id|psc_write_long
c_func
(paren
id|PSC_ENETRD_LEN
op_plus
id|set
comma
id|N_RX_RING
)paren
suffix:semicolon
id|psc_write_word
c_func
(paren
id|PSC_ENETRD_CMD
op_plus
id|set
comma
l_int|0x9800
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;Reset the receive DMA subsystem&n; */
DECL|function|mace68k_rxdma_reset
r_static
r_void
id|mace68k_rxdma_reset
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|mace68k_data
op_star
id|mp
op_assign
(paren
r_struct
id|mace68k_data
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_volatile
r_struct
id|mace
op_star
id|mace
op_assign
id|mp-&gt;mace
suffix:semicolon
id|u8
id|mcc
op_assign
id|mace-&gt;maccc
suffix:semicolon
multiline_comment|/*&n;&t; *&t;Turn off receive&n;&t; */
id|mcc
op_and_assign
op_complement
id|ENRCV
suffix:semicolon
id|mace-&gt;maccc
op_assign
id|mcc
suffix:semicolon
multiline_comment|/*&n;&t; *&t;Program the DMA&n;&t; */
id|psc_write_word
c_func
(paren
id|PSC_ENETRD_CTL
comma
l_int|0x8800
)paren
suffix:semicolon
id|psc_load_rxdma_base
c_func
(paren
l_int|0x0
comma
(paren
r_void
op_star
)paren
id|virt_to_bus
c_func
(paren
id|mp-&gt;rx_ring
)paren
)paren
suffix:semicolon
id|psc_write_word
c_func
(paren
id|PSC_ENETRD_CTL
comma
l_int|0x0400
)paren
suffix:semicolon
id|psc_write_word
c_func
(paren
id|PSC_ENETRD_CTL
comma
l_int|0x8800
)paren
suffix:semicolon
id|psc_load_rxdma_base
c_func
(paren
l_int|0x10
comma
(paren
r_void
op_star
)paren
id|virt_to_bus
c_func
(paren
id|mp-&gt;rx_ring
)paren
)paren
suffix:semicolon
id|psc_write_word
c_func
(paren
id|PSC_ENETRD_CTL
comma
l_int|0x0400
)paren
suffix:semicolon
id|mace-&gt;maccc
op_assign
id|mcc
op_or
id|ENRCV
suffix:semicolon
macro_line|#if 0
id|psc_write_word
c_func
(paren
id|PSC_ENETRD_CTL
comma
l_int|0x9800
)paren
suffix:semicolon
id|psc_write_word
c_func
(paren
id|PSC_ENETRD_CTL
op_plus
l_int|0x10
comma
l_int|0x9800
)paren
suffix:semicolon
macro_line|#endif
)brace
multiline_comment|/*&n; *&t;Reset the transmit DMA subsystem&n; */
DECL|function|mace68k_txdma_reset
r_static
r_void
id|mace68k_txdma_reset
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|mace68k_data
op_star
id|mp
op_assign
(paren
r_struct
id|mace68k_data
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_volatile
r_struct
id|mace
op_star
id|mace
op_assign
id|mp-&gt;mace
suffix:semicolon
id|u8
id|mcc
op_assign
id|mace-&gt;maccc
suffix:semicolon
id|psc_write_word
c_func
(paren
id|PSC_ENETWR_CTL
comma
l_int|0x8800
)paren
suffix:semicolon
id|mace-&gt;maccc
op_assign
id|mcc
op_amp
op_complement
id|ENXMT
suffix:semicolon
id|psc_write_word
c_func
(paren
id|PSC_ENETWR_CTL
comma
l_int|0x0400
)paren
suffix:semicolon
id|mace-&gt;maccc
op_assign
id|mcc
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;Disable DMA&n; */
DECL|function|mace68k_dma_off
r_static
r_void
id|mace68k_dma_off
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
id|psc_write_word
c_func
(paren
id|PSC_ENETRD_CTL
comma
l_int|0x8800
)paren
suffix:semicolon
id|psc_write_word
c_func
(paren
id|PSC_ENETRD_CTL
comma
l_int|0x1000
)paren
suffix:semicolon
id|psc_write_word
c_func
(paren
id|PSC_ENETRD_CMD
comma
l_int|0x1100
)paren
suffix:semicolon
id|psc_write_word
c_func
(paren
id|PSC_ENETRD_CMD
op_plus
l_int|0x10
comma
l_int|0x1100
)paren
suffix:semicolon
id|psc_write_word
c_func
(paren
id|PSC_ENETWR_CTL
comma
l_int|0x8800
)paren
suffix:semicolon
id|psc_write_word
c_func
(paren
id|PSC_ENETWR_CTL
comma
l_int|0x1000
)paren
suffix:semicolon
id|psc_write_word
c_func
(paren
id|PSC_ENETWR_CMD
comma
l_int|0x1100
)paren
suffix:semicolon
id|psc_write_word
c_func
(paren
id|PSC_ENETWR_CMD
op_plus
l_int|0x10
comma
l_int|0x1100
)paren
suffix:semicolon
)brace
multiline_comment|/* Bit-reverse one byte of an ethernet hardware address. */
DECL|function|bitrev
r_static
r_int
id|bitrev
c_func
(paren
r_int
id|b
)paren
(brace
r_int
id|d
op_assign
l_int|0
comma
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|8
suffix:semicolon
op_increment
id|i
comma
id|b
op_rshift_assign
l_int|1
)paren
id|d
op_assign
(paren
id|d
op_lshift
l_int|1
)paren
op_or
(paren
id|b
op_amp
l_int|1
)paren
suffix:semicolon
r_return
id|d
suffix:semicolon
)brace
multiline_comment|/*&n; * &t;Not really much of a probe. The hardware table tells us if this&n; *&t;model of Macintrash has a MACE (AV macintoshes)&n; */
DECL|function|mace68k_probe
r_int
id|mace68k_probe
c_func
(paren
r_struct
id|net_device
op_star
id|unused
)paren
(brace
r_int
id|j
suffix:semicolon
r_static
r_int
id|once
op_assign
l_int|0
suffix:semicolon
r_struct
id|mace68k_data
op_star
id|mp
suffix:semicolon
r_int
r_char
op_star
id|addr
suffix:semicolon
r_struct
id|net_device
op_star
id|dev
suffix:semicolon
r_int
r_char
id|checksum
op_assign
l_int|0
suffix:semicolon
multiline_comment|/*&n;&t; *&t;There can be only one...&n;&t; */
r_if
c_cond
(paren
id|once
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
id|once
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|macintosh_config-&gt;ether_type
op_ne
id|MAC_ETHER_MACE
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;MACE ethernet should be present &quot;
)paren
suffix:semicolon
id|dev
op_assign
id|init_etherdev
c_func
(paren
l_int|0
comma
id|PRIV_BYTES
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dev
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;no free memory.&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|mp
op_assign
(paren
r_struct
id|mace68k_data
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|dev-&gt;base_addr
op_assign
(paren
id|u32
)paren
id|MACE_BASE
suffix:semicolon
id|mp-&gt;mace
op_assign
(paren
r_volatile
r_struct
id|mace
op_star
)paren
id|MACE_BASE
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;at 0x%p&quot;
comma
id|mp-&gt;mace
)paren
suffix:semicolon
multiline_comment|/*&n;&t; *&t;16K RX ring and 4K TX ring should do nicely&n;&t; */
id|mp-&gt;rx_ring
op_assign
(paren
r_void
op_star
)paren
id|__get_free_pages
c_func
(paren
id|GFP_KERNEL
comma
l_int|2
)paren
suffix:semicolon
id|mp-&gt;tx_ring
op_assign
(paren
r_void
op_star
)paren
id|__get_free_page
c_func
(paren
id|GFP_KERNEL
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;.&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mp-&gt;tx_ring
op_eq
l_int|NULL
op_logical_or
id|mp-&gt;rx_ring
op_eq
l_int|NULL
)paren
(brace
r_if
c_cond
(paren
id|mp-&gt;tx_ring
)paren
(brace
id|free_page
c_func
(paren
(paren
id|u32
)paren
id|mp-&gt;tx_ring
)paren
suffix:semicolon
)brace
singleline_comment|//&t;&t;if(mp-&gt;rx_ring)
singleline_comment|//&t;&t;&t;__free_pages(mp-&gt;rx_ring,2);
id|printk
c_func
(paren
l_string|&quot;&bslash;nNo memory for ring buffers.&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
multiline_comment|/* We want the receive data to be uncached. We dont care about the&n;&t;   byte reading order */
id|printk
c_func
(paren
l_string|&quot;.&quot;
)paren
suffix:semicolon
id|kernel_set_cachemode
c_func
(paren
(paren
r_void
op_star
)paren
id|mp-&gt;rx_ring
comma
l_int|16384
comma
id|IOMAP_NOCACHE_NONSER
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;.&quot;
)paren
suffix:semicolon
multiline_comment|/* The transmit buffer needs to be write through */
id|kernel_set_cachemode
c_func
(paren
(paren
r_void
op_star
)paren
id|mp-&gt;tx_ring
comma
l_int|4096
comma
id|IOMAP_WRITETHROUGH
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot; Ok&bslash;n&quot;
)paren
suffix:semicolon
id|dev-&gt;irq
op_assign
id|IRQ_MAC_MACE
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: MACE at&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
multiline_comment|/*&n;&t; *&t;The PROM contains 8 bytes which total 0xFF when XOR&squot;d&n;&t; *&t;together. Due to the usual peculiar apple brain damage&n;&t; *&t;the bytes are spaced out in a strange boundary and the&n;&t; * &t;bits are reversed.&n;&t; */
id|addr
op_assign
(paren
r_void
op_star
)paren
id|MACE_PROM
suffix:semicolon
r_for
c_loop
(paren
id|j
op_assign
l_int|0
suffix:semicolon
id|j
OL
l_int|6
suffix:semicolon
op_increment
id|j
)paren
(brace
id|u8
id|v
op_assign
id|bitrev
c_func
(paren
id|addr
(braket
id|j
op_lshift
l_int|4
)braket
)paren
suffix:semicolon
id|checksum
op_xor_assign
id|v
suffix:semicolon
id|dev-&gt;dev_addr
(braket
id|j
)braket
op_assign
id|v
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;%c%.2x&quot;
comma
(paren
id|j
ques
c_cond
l_char|&squot;:&squot;
suffix:colon
l_char|&squot; &squot;
)paren
comma
id|dev-&gt;dev_addr
(braket
id|j
)braket
)paren
suffix:semicolon
)brace
r_for
c_loop
(paren
suffix:semicolon
id|j
OL
l_int|8
suffix:semicolon
op_increment
id|j
)paren
(brace
id|checksum
op_xor_assign
id|bitrev
c_func
(paren
id|addr
(braket
id|j
op_lshift
l_int|4
)braket
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|checksum
op_ne
l_int|0xFF
)paren
(brace
id|printk
c_func
(paren
l_string|&quot; (invalid checksum)&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
id|memset
c_func
(paren
op_amp
id|mp-&gt;stats
comma
l_int|0
comma
r_sizeof
(paren
id|mp-&gt;stats
)paren
)paren
suffix:semicolon
id|init_timer
c_func
(paren
op_amp
id|mp-&gt;tx_timeout
)paren
suffix:semicolon
id|mp-&gt;timeout_active
op_assign
l_int|0
suffix:semicolon
id|dev-&gt;open
op_assign
id|mace68k_open
suffix:semicolon
id|dev-&gt;stop
op_assign
id|mace68k_close
suffix:semicolon
id|dev-&gt;hard_start_xmit
op_assign
id|mace68k_xmit_start
suffix:semicolon
id|dev-&gt;get_stats
op_assign
id|mace68k_stats
suffix:semicolon
id|dev-&gt;set_multicast_list
op_assign
id|mace68k_set_multicast
suffix:semicolon
id|dev-&gt;set_mac_address
op_assign
id|mace68k_set_address
suffix:semicolon
id|ether_setup
c_func
(paren
id|dev
)paren
suffix:semicolon
id|mp
op_assign
(paren
r_struct
id|mace68k_data
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|mp-&gt;maccc
op_assign
id|ENXMT
op_or
id|ENRCV
suffix:semicolon
id|mp-&gt;dma_intr
op_assign
id|IRQ_MAC_MACE_DMA
suffix:semicolon
id|psc_write_word
c_func
(paren
id|PSC_ENETWR_CTL
comma
l_int|0x9000
)paren
suffix:semicolon
id|psc_write_word
c_func
(paren
id|PSC_ENETRD_CTL
comma
l_int|0x9000
)paren
suffix:semicolon
id|psc_write_word
c_func
(paren
id|PSC_ENETWR_CTL
comma
l_int|0x0400
)paren
suffix:semicolon
id|psc_write_word
c_func
(paren
id|PSC_ENETRD_CTL
comma
l_int|0x0400
)paren
suffix:semicolon
multiline_comment|/* apple&squot;s driver doesn&squot;t seem to do this */
multiline_comment|/* except at driver shutdown time...      */
macro_line|#if 0
id|mace68k_dma_off
c_func
(paren
id|dev
)paren
suffix:semicolon
macro_line|#endif
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;Reset a MACE controller&n; */
DECL|function|mace68k_reset
r_static
r_void
id|mace68k_reset
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|mace68k_data
op_star
id|mp
op_assign
(paren
r_struct
id|mace68k_data
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_volatile
r_struct
id|mace
op_star
id|mb
op_assign
id|mp-&gt;mace
suffix:semicolon
r_int
id|i
suffix:semicolon
multiline_comment|/* soft-reset the chip */
id|i
op_assign
l_int|200
suffix:semicolon
r_while
c_loop
(paren
op_decrement
id|i
)paren
(brace
id|mb-&gt;biucc
op_assign
id|SWRST
suffix:semicolon
r_if
c_cond
(paren
id|mb-&gt;biucc
op_amp
id|SWRST
)paren
(brace
id|udelay
c_func
(paren
l_int|10
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|i
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;mace: cannot reset chip!&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|mb-&gt;biucc
op_assign
id|XMTSP_64
suffix:semicolon
id|mb-&gt;imr
op_assign
l_int|0xff
suffix:semicolon
multiline_comment|/* disable all intrs for now */
id|i
op_assign
id|mb-&gt;ir
suffix:semicolon
id|mb-&gt;maccc
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* turn off tx, rx */
id|mb-&gt;utr
op_assign
id|RTRD
suffix:semicolon
id|mb-&gt;fifocc
op_assign
id|RCVFW_64
suffix:semicolon
id|mb-&gt;xmtfc
op_assign
id|AUTO_PAD_XMIT
suffix:semicolon
multiline_comment|/* auto-pad short frames */
multiline_comment|/* load up the hardware address */
id|mb-&gt;iac
op_assign
id|ADDRCHG
op_or
id|PHYADDR
suffix:semicolon
r_while
c_loop
(paren
(paren
id|mb-&gt;iac
op_amp
id|ADDRCHG
)paren
op_ne
l_int|0
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|6
suffix:semicolon
op_increment
id|i
)paren
id|mb-&gt;padr
op_assign
id|dev-&gt;dev_addr
(braket
id|i
)braket
suffix:semicolon
multiline_comment|/* clear the multicast filter */
id|mb-&gt;iac
op_assign
id|ADDRCHG
op_or
id|LOGADDR
suffix:semicolon
r_while
c_loop
(paren
(paren
id|mb-&gt;iac
op_amp
id|ADDRCHG
)paren
op_ne
l_int|0
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|8
suffix:semicolon
op_increment
id|i
)paren
id|mb-&gt;ladrf
op_assign
l_int|0
suffix:semicolon
id|mb-&gt;plscc
op_assign
id|PORTSEL_GPSI
op_plus
id|ENPLSIO
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;Load the address on a mace controller.&n; */
DECL|function|mace68k_set_address
r_static
r_int
id|mace68k_set_address
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_void
op_star
id|addr
)paren
(brace
r_int
r_char
op_star
id|p
op_assign
id|addr
suffix:semicolon
r_struct
id|mace68k_data
op_star
id|mp
op_assign
(paren
r_struct
id|mace68k_data
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_volatile
r_struct
id|mace
op_star
id|mb
op_assign
id|mp-&gt;mace
suffix:semicolon
r_int
id|i
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* load up the hardware address */
id|mb-&gt;iac
op_assign
id|ADDRCHG
op_or
id|PHYADDR
suffix:semicolon
r_while
c_loop
(paren
(paren
id|mb-&gt;iac
op_amp
id|ADDRCHG
)paren
op_ne
l_int|0
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|6
suffix:semicolon
op_increment
id|i
)paren
id|mb-&gt;padr
op_assign
id|dev-&gt;dev_addr
(braket
id|i
)braket
op_assign
id|p
(braket
id|i
)braket
suffix:semicolon
multiline_comment|/* note: setting ADDRCHG clears ENRCV */
id|mb-&gt;maccc
op_assign
id|mp-&gt;maccc
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;Open the Macintosh MACE. Most of this is playing with the DMA&n; *&t;engine. The ethernet chip is quite friendly.&n; */
DECL|function|mace68k_open
r_static
r_int
id|mace68k_open
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|mace68k_data
op_star
id|mp
op_assign
(paren
r_struct
id|mace68k_data
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_volatile
r_struct
id|mace
op_star
id|mb
op_assign
id|mp-&gt;mace
suffix:semicolon
multiline_comment|/* reset the chip */
id|mace68k_reset
c_func
(paren
id|dev
)paren
suffix:semicolon
id|mp-&gt;rx_done
op_assign
l_int|0
suffix:semicolon
id|mace68k_rxdma_reset
c_func
(paren
id|dev
)paren
suffix:semicolon
multiline_comment|/*&n;&t; *&t;The interrupt is fixed and comes off the PSC.&n;&t; */
r_if
c_cond
(paren
id|request_irq
c_func
(paren
id|dev-&gt;irq
comma
id|mace68k_interrupt
comma
l_int|0
comma
l_string|&quot;68K MACE&quot;
comma
id|dev
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;MACE: can&squot;t get irq %d&bslash;n&quot;
comma
id|dev-&gt;irq
)paren
suffix:semicolon
r_return
op_minus
id|EAGAIN
suffix:semicolon
)brace
multiline_comment|/*&n;&t; *&t;Ditto the DMA interrupt.&n;&t; */
r_if
c_cond
(paren
id|request_irq
c_func
(paren
id|IRQ_MAC_MACE_DMA
comma
id|mace68k_dma_intr
comma
l_int|0
comma
l_string|&quot;68K MACE DMA&quot;
comma
id|dev
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;MACE: can&squot;t get irq %d&bslash;n&quot;
comma
id|IRQ_MAC_MACE_DMA
)paren
suffix:semicolon
r_return
op_minus
id|EAGAIN
suffix:semicolon
)brace
multiline_comment|/* Activate the Mac DMA engine */
id|mp-&gt;tx_slot
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Using register set 0 */
id|mp-&gt;tx_count
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* 1 Buffer ready for use */
id|mace68k_txdma_reset
c_func
(paren
id|dev
)paren
suffix:semicolon
multiline_comment|/* turn it on! */
id|mb-&gt;maccc
op_assign
id|mp-&gt;maccc
suffix:semicolon
multiline_comment|/* enable all interrupts except receive interrupts */
id|mb-&gt;imr
op_assign
id|RCVINT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;Shut down the mace and its interrupt channel&n; */
DECL|function|mace68k_close
r_static
r_int
id|mace68k_close
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|mace68k_data
op_star
id|mp
op_assign
(paren
r_struct
id|mace68k_data
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_volatile
r_struct
id|mace
op_star
id|mb
op_assign
id|mp-&gt;mace
suffix:semicolon
multiline_comment|/* disable rx and tx */
id|mb-&gt;maccc
op_assign
l_int|0
suffix:semicolon
id|mb-&gt;imr
op_assign
l_int|0xff
suffix:semicolon
multiline_comment|/* disable all intrs */
multiline_comment|/* disable rx and tx dma */
id|mace68k_dma_off
c_func
(paren
id|dev
)paren
suffix:semicolon
id|free_irq
c_func
(paren
id|dev-&gt;irq
comma
id|dev
)paren
suffix:semicolon
id|free_irq
c_func
(paren
id|IRQ_MAC_MACE_DMA
comma
id|dev
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|mace68k_set_timeout
r_static
r_inline
r_void
id|mace68k_set_timeout
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|mace68k_data
op_star
id|mp
op_assign
(paren
r_struct
id|mace68k_data
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mp-&gt;timeout_active
)paren
id|del_timer
c_func
(paren
op_amp
id|mp-&gt;tx_timeout
)paren
suffix:semicolon
id|mp-&gt;tx_timeout.expires
op_assign
id|jiffies
op_plus
id|TX_TIMEOUT
suffix:semicolon
id|mp-&gt;tx_timeout.function
op_assign
id|mace68k_tx_timeout
suffix:semicolon
id|mp-&gt;tx_timeout.data
op_assign
(paren
r_int
r_int
)paren
id|dev
suffix:semicolon
id|add_timer
c_func
(paren
op_amp
id|mp-&gt;tx_timeout
)paren
suffix:semicolon
id|mp-&gt;timeout_active
op_assign
l_int|1
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;Transmit a frame&n; */
DECL|function|mace68k_xmit_start
r_static
r_int
id|mace68k_xmit_start
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|mace68k_data
op_star
id|mp
op_assign
(paren
r_struct
id|mace68k_data
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
multiline_comment|/*&n;&t; *&t;This may need atomic types ???&n;&t; */
id|printk
c_func
(paren
l_string|&quot;mace68k_xmit_start: mp-&gt;tx_count = %d, dev-&gt;tbusy = %d, mp-&gt;tx_ring = %p (%p)&bslash;n&quot;
comma
id|mp-&gt;tx_count
comma
id|dev-&gt;tbusy
comma
id|mp-&gt;tx_ring
comma
id|virt_to_bus
c_func
(paren
id|mp-&gt;tx_ring
)paren
)paren
suffix:semicolon
id|psc_debug_dump
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mp-&gt;tx_count
op_eq
l_int|0
)paren
(brace
id|dev-&gt;tbusy
op_assign
l_int|1
suffix:semicolon
id|mace68k_dma_intr
c_func
(paren
id|IRQ_MAC_MACE_DMA
comma
id|dev
comma
l_int|NULL
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
id|mp-&gt;tx_count
op_decrement
suffix:semicolon
multiline_comment|/*&n;&t; *&t;FIXME:&n;&t; *&t;This is hackish. The memcpy probably isnt needed but&n;&t; *&t;the rules for alignment are not known. Ideally we&squot;d like&n;&t; *&t;to just blast the skb directly to ethernet. We also don&squot;t&n;&t; *&t;use the ring properly - just a one frame buffer. That&n;&t; *&t;also requires cache pushes ;).&n;&t; */
id|memcpy
c_func
(paren
(paren
r_void
op_star
)paren
id|mp-&gt;tx_ring
comma
id|skb
comma
id|skb-&gt;len
)paren
suffix:semicolon
id|psc_write_long
c_func
(paren
id|PSC_ENETWR_ADDR
op_plus
id|mp-&gt;tx_slot
comma
id|virt_to_bus
c_func
(paren
id|mp-&gt;tx_ring
)paren
)paren
suffix:semicolon
id|psc_write_long
c_func
(paren
id|PSC_ENETWR_LEN
op_plus
id|mp-&gt;tx_slot
comma
id|skb-&gt;len
)paren
suffix:semicolon
id|psc_write_word
c_func
(paren
id|PSC_ENETWR_CMD
op_plus
id|mp-&gt;tx_slot
comma
l_int|0x9800
)paren
suffix:semicolon
id|mp-&gt;stats.tx_packets
op_increment
suffix:semicolon
id|mp-&gt;stats.tx_bytes
op_add_assign
id|skb-&gt;len
suffix:semicolon
id|dev_kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|mace68k_stats
r_static
r_struct
id|net_device_stats
op_star
id|mace68k_stats
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|mace68k_data
op_star
id|p
op_assign
(paren
r_struct
id|mace68k_data
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_return
op_amp
id|p-&gt;stats
suffix:semicolon
)brace
multiline_comment|/*&n; * CRC polynomial - used in working out multicast filter bits.&n; */
DECL|macro|CRC_POLY
mdefine_line|#define CRC_POLY&t;0xedb88320
DECL|function|mace68k_set_multicast
r_static
r_void
id|mace68k_set_multicast
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|mace68k_data
op_star
id|mp
op_assign
(paren
r_struct
id|mace68k_data
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_volatile
r_struct
id|mace
op_star
id|mb
op_assign
id|mp-&gt;mace
suffix:semicolon
r_int
id|i
comma
id|j
comma
id|k
comma
id|b
suffix:semicolon
r_int
r_int
id|crc
suffix:semicolon
id|mp-&gt;maccc
op_and_assign
op_complement
id|PROM
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;flags
op_amp
id|IFF_PROMISC
)paren
(brace
id|mp-&gt;maccc
op_or_assign
id|PROM
suffix:semicolon
)brace
r_else
(brace
r_int
r_char
id|multicast_filter
(braket
l_int|8
)braket
suffix:semicolon
r_struct
id|dev_mc_list
op_star
id|dmi
op_assign
id|dev-&gt;mc_list
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;flags
op_amp
id|IFF_ALLMULTI
)paren
(brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|8
suffix:semicolon
id|i
op_increment
)paren
id|multicast_filter
(braket
id|i
)braket
op_assign
l_int|0xff
suffix:semicolon
)brace
r_else
(brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|8
suffix:semicolon
id|i
op_increment
)paren
id|multicast_filter
(braket
id|i
)braket
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|dev-&gt;mc_count
suffix:semicolon
id|i
op_increment
)paren
(brace
id|crc
op_assign
op_complement
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|j
op_assign
l_int|0
suffix:semicolon
id|j
OL
l_int|6
suffix:semicolon
op_increment
id|j
)paren
(brace
id|b
op_assign
id|dmi-&gt;dmi_addr
(braket
id|j
)braket
suffix:semicolon
r_for
c_loop
(paren
id|k
op_assign
l_int|0
suffix:semicolon
id|k
OL
l_int|8
suffix:semicolon
op_increment
id|k
)paren
(brace
r_if
c_cond
(paren
(paren
id|crc
op_xor
id|b
)paren
op_amp
l_int|1
)paren
id|crc
op_assign
(paren
id|crc
op_rshift
l_int|1
)paren
op_xor
id|CRC_POLY
suffix:semicolon
r_else
id|crc
op_rshift_assign
l_int|1
suffix:semicolon
id|b
op_rshift_assign
l_int|1
suffix:semicolon
)brace
)brace
id|j
op_assign
id|crc
op_rshift
l_int|26
suffix:semicolon
multiline_comment|/* bit number in multicast_filter */
id|multicast_filter
(braket
id|j
op_rshift
l_int|3
)braket
op_or_assign
l_int|1
op_lshift
(paren
id|j
op_amp
l_int|7
)paren
suffix:semicolon
id|dmi
op_assign
id|dmi-&gt;next
suffix:semicolon
)brace
)brace
macro_line|#if 0
id|printk
c_func
(paren
l_string|&quot;Multicast filter :&quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|8
suffix:semicolon
id|i
op_increment
)paren
id|printk
c_func
(paren
l_string|&quot;%02x &quot;
comma
id|multicast_filter
(braket
id|i
)braket
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
id|mb-&gt;iac
op_assign
id|ADDRCHG
op_or
id|LOGADDR
suffix:semicolon
r_while
c_loop
(paren
(paren
id|mb-&gt;iac
op_amp
id|ADDRCHG
)paren
op_ne
l_int|0
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|8
suffix:semicolon
op_increment
id|i
)paren
id|mb-&gt;ladrf
op_assign
id|multicast_filter
(braket
id|i
)braket
suffix:semicolon
)brace
multiline_comment|/* reset maccc */
id|mb-&gt;maccc
op_assign
id|mp-&gt;maccc
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;Miscellaneous interrupts are handled here. We may end up &n; *&t;having to bash the chip on the head for bad errors&n; */
DECL|function|mace68k_handle_misc_intrs
r_static
r_void
id|mace68k_handle_misc_intrs
c_func
(paren
r_struct
id|mace68k_data
op_star
id|mp
comma
r_int
id|intr
)paren
(brace
r_volatile
r_struct
id|mace
op_star
id|mb
op_assign
id|mp-&gt;mace
suffix:semicolon
r_static
r_int
id|mace68k_babbles
comma
id|mace68k_jabbers
suffix:semicolon
r_if
c_cond
(paren
id|intr
op_amp
id|MPCO
)paren
id|mp-&gt;stats.rx_missed_errors
op_add_assign
l_int|256
suffix:semicolon
id|mp-&gt;stats.rx_missed_errors
op_add_assign
id|mb-&gt;mpc
suffix:semicolon
multiline_comment|/* reading clears it */
r_if
c_cond
(paren
id|intr
op_amp
id|RNTPCO
)paren
id|mp-&gt;stats.rx_length_errors
op_add_assign
l_int|256
suffix:semicolon
id|mp-&gt;stats.rx_length_errors
op_add_assign
id|mb-&gt;rntpc
suffix:semicolon
multiline_comment|/* reading clears it */
r_if
c_cond
(paren
id|intr
op_amp
id|CERR
)paren
op_increment
id|mp-&gt;stats.tx_heartbeat_errors
suffix:semicolon
r_if
c_cond
(paren
id|intr
op_amp
id|BABBLE
)paren
r_if
c_cond
(paren
id|mace68k_babbles
op_increment
OL
l_int|4
)paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;mace: babbling transmitter&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|intr
op_amp
id|JABBER
)paren
r_if
c_cond
(paren
id|mace68k_jabbers
op_increment
OL
l_int|4
)paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;mace: jabbering transceiver&bslash;n&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;A transmit error has occured. (We kick the transmit side from&n; *&t;the DMA completion)&n; */
DECL|function|mace68k_xmit_error
r_static
r_void
id|mace68k_xmit_error
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|mace68k_data
op_star
id|mp
op_assign
(paren
r_struct
id|mace68k_data
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_volatile
r_struct
id|mace
op_star
id|mb
op_assign
id|mp-&gt;mace
suffix:semicolon
id|u8
id|xmtfs
comma
id|xmtrc
suffix:semicolon
id|xmtfs
op_assign
id|mb-&gt;xmtfs
suffix:semicolon
id|xmtrc
op_assign
id|mb-&gt;xmtrc
suffix:semicolon
r_if
c_cond
(paren
id|xmtfs
op_amp
id|XMTSV
)paren
(brace
r_if
c_cond
(paren
id|xmtfs
op_amp
id|UFLO
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%s: DMA underrun.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|mp-&gt;stats.tx_errors
op_increment
suffix:semicolon
id|mp-&gt;stats.tx_fifo_errors
op_increment
suffix:semicolon
id|mace68k_reset
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|xmtfs
op_amp
id|RTRY
)paren
(brace
id|mp-&gt;stats.collisions
op_increment
suffix:semicolon
)brace
)brace
id|mark_bh
c_func
(paren
id|NET_BH
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;A receive interrupt occured.&n; */
DECL|function|mace68k_recv_interrupt
r_static
r_void
id|mace68k_recv_interrupt
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
singleline_comment|//&t;struct mace68k_data *mp = (struct mace68k_data *) dev-&gt;priv;
singleline_comment|//&t;volatile struct mace *mb = mp-&gt;mace;
)brace
multiline_comment|/*&n; *&t;Process the chip interrupt&n; */
DECL|function|mace68k_interrupt
r_static
r_void
id|mace68k_interrupt
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_struct
id|net_device
op_star
id|dev
op_assign
(paren
r_struct
id|net_device
op_star
)paren
id|dev_id
suffix:semicolon
r_struct
id|mace68k_data
op_star
id|mp
op_assign
(paren
r_struct
id|mace68k_data
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_volatile
r_struct
id|mace
op_star
id|mb
op_assign
id|mp-&gt;mace
suffix:semicolon
id|u8
id|ir
suffix:semicolon
id|ir
op_assign
id|mb-&gt;ir
suffix:semicolon
id|mace68k_handle_misc_intrs
c_func
(paren
id|mp
comma
id|ir
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ir
op_amp
id|XMTINT
)paren
(brace
id|mace68k_xmit_error
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ir
op_amp
id|RCVINT
)paren
(brace
id|mace68k_recv_interrupt
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
)brace
DECL|function|mace68k_tx_timeout
r_static
r_void
id|mace68k_tx_timeout
c_func
(paren
r_int
r_int
id|data
)paren
(brace
singleline_comment|//&t;struct net_device *dev = (struct net_device *) data;
singleline_comment|//&t;struct mace68k_data *mp = (struct mace68k_data *) dev-&gt;priv;
singleline_comment|//&t;volatile struct mace *mb = mp-&gt;mace;
)brace
multiline_comment|/*&n; *&t;Handle a newly arrived frame&n; */
DECL|function|mace_dma_rx_frame
r_static
r_void
id|mace_dma_rx_frame
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_struct
id|mace_frame
op_star
id|mf
)paren
(brace
r_struct
id|mace68k_data
op_star
id|mp
op_assign
(paren
r_struct
id|mace68k_data
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
r_if
c_cond
(paren
id|mf-&gt;status
op_amp
id|RS_OFLO
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%s: fifo overflow.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|mp-&gt;stats.rx_errors
op_increment
suffix:semicolon
id|mp-&gt;stats.rx_fifo_errors
op_increment
suffix:semicolon
)brace
r_if
c_cond
(paren
id|mf-&gt;status
op_amp
(paren
id|RS_CLSN
op_or
id|RS_FRAMERR
op_or
id|RS_FCSERR
)paren
)paren
(brace
id|mp-&gt;stats.rx_errors
op_increment
suffix:semicolon
)brace
r_if
c_cond
(paren
id|mf-&gt;status
op_amp
id|RS_CLSN
)paren
(brace
id|mp-&gt;stats.collisions
op_increment
suffix:semicolon
)brace
r_if
c_cond
(paren
id|mf-&gt;status
op_amp
id|RS_FRAMERR
)paren
(brace
id|mp-&gt;stats.rx_frame_errors
op_increment
suffix:semicolon
)brace
r_if
c_cond
(paren
id|mf-&gt;status
op_amp
id|RS_FCSERR
)paren
(brace
id|mp-&gt;stats.rx_crc_errors
op_increment
suffix:semicolon
)brace
id|skb
op_assign
id|dev_alloc_skb
c_func
(paren
id|mf-&gt;len
op_plus
l_int|2
)paren
suffix:semicolon
r_if
c_cond
(paren
id|skb
op_eq
l_int|NULL
)paren
(brace
id|mp-&gt;stats.rx_dropped
op_increment
suffix:semicolon
r_return
suffix:semicolon
)brace
id|skb_reserve
c_func
(paren
id|skb
comma
l_int|2
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|skb_put
c_func
(paren
id|skb
comma
id|mf-&gt;len
)paren
comma
id|mf-&gt;data
comma
id|mf-&gt;len
)paren
suffix:semicolon
id|skb-&gt;protocol
op_assign
id|eth_type_trans
c_func
(paren
id|skb
comma
id|dev
)paren
suffix:semicolon
id|netif_rx
c_func
(paren
id|skb
)paren
suffix:semicolon
id|mp-&gt;stats.rx_packets
op_increment
suffix:semicolon
id|mp-&gt;stats.rx_bytes
op_add_assign
id|mf-&gt;len
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;The PSC has passed us a DMA interrupt event.&n; */
DECL|function|mace68k_dma_intr
r_static
r_void
id|mace68k_dma_intr
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_struct
id|net_device
op_star
id|dev
op_assign
(paren
r_struct
id|net_device
op_star
)paren
id|dev_id
suffix:semicolon
r_struct
id|mace68k_data
op_star
id|mp
op_assign
(paren
r_struct
id|mace68k_data
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
macro_line|#if 0
id|u32
id|psc_status
suffix:semicolon
multiline_comment|/* It seems this must be allowed to stabilise ?? */
r_while
c_loop
(paren
(paren
id|psc_status
op_assign
id|psc_read_long
c_func
(paren
l_int|0x0804
)paren
)paren
op_ne
id|psc_read_long
c_func
(paren
l_int|0x0804
)paren
)paren
(brace
suffix:semicolon
)brace
multiline_comment|/*&n;&t; *&t;Was this an ethernet event ?&n;&t; */
r_if
c_cond
(paren
id|psc_status
op_amp
l_int|0x60000000
)paren
(brace
macro_line|#endif
multiline_comment|/*&n;&t;&t; *&t;Process the read queue&n;&t;&t; */
id|u16
id|psc_status
op_assign
id|psc_read_word
c_func
(paren
id|PSC_ENETRD_CTL
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;mace68k_dma_intr: PSC_ENETRD_CTL = %04X&bslash;n&quot;
comma
(paren
id|uint
)paren
id|psc_status
)paren
suffix:semicolon
r_if
c_cond
(paren
id|psc_status
op_amp
l_int|0x2000
)paren
(brace
id|mace68k_rxdma_reset
c_func
(paren
id|dev
)paren
suffix:semicolon
id|mp-&gt;rx_done
op_assign
l_int|0
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|psc_status
op_amp
l_int|0x100
)paren
(brace
r_int
id|left
suffix:semicolon
id|psc_write_word
c_func
(paren
id|PSC_ENETRD_CMD
op_plus
id|mp-&gt;rx_slot
comma
l_int|0x1100
)paren
suffix:semicolon
id|left
op_assign
id|psc_read_long
c_func
(paren
id|PSC_ENETRD_LEN
op_plus
id|mp-&gt;rx_slot
)paren
suffix:semicolon
multiline_comment|/* read packets */
r_while
c_loop
(paren
id|mp-&gt;rx_done
OL
id|left
)paren
(brace
r_struct
id|mace_frame
op_star
id|mf
op_assign
(paren
(paren
r_struct
id|mace_frame
op_star
)paren
id|mp-&gt;rx_ring
)paren
op_plus
id|mp-&gt;rx_done
op_increment
suffix:semicolon
id|mace_dma_rx_frame
c_func
(paren
id|dev
comma
id|mf
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|left
op_eq
l_int|0
)paren
multiline_comment|/* Out of DMA room */
(brace
id|psc_load_rxdma_base
c_func
(paren
id|mp-&gt;rx_slot
comma
(paren
r_void
op_star
)paren
id|virt_to_phys
c_func
(paren
id|mp-&gt;rx_ring
)paren
)paren
suffix:semicolon
id|mp-&gt;rx_slot
op_xor_assign
l_int|16
suffix:semicolon
id|mp-&gt;rx_done
op_assign
l_int|0
suffix:semicolon
)brace
r_else
(brace
id|psc_write_word
c_func
(paren
id|PSC_ENETRD_CMD
op_plus
id|mp-&gt;rx_slot
comma
l_int|0x9800
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/*&n;&t;&t; *&t;Process the write queue&n;&t;&t; */
id|psc_status
op_assign
id|psc_read_word
c_func
(paren
id|PSC_ENETWR_CTL
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;mace68k_dma_intr: PSC_ENETWR_CTL = %04X&bslash;n&quot;
comma
(paren
id|uint
)paren
id|psc_status
)paren
suffix:semicolon
multiline_comment|/* apple&squot;s driver seems to loop over this until neither */
multiline_comment|/* condition is true.    - jmt                          */
r_if
c_cond
(paren
id|psc_status
op_amp
l_int|0x2000
)paren
(brace
id|mace68k_txdma_reset
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|psc_status
op_amp
l_int|0x0100
)paren
(brace
id|psc_write_word
c_func
(paren
id|PSC_ENETWR_CMD
op_plus
id|mp-&gt;tx_slot
comma
l_int|0x0100
)paren
suffix:semicolon
id|mp-&gt;tx_slot
op_xor_assign
l_int|16
suffix:semicolon
id|mp-&gt;tx_count
op_increment
suffix:semicolon
id|dev-&gt;tbusy
op_assign
l_int|0
suffix:semicolon
id|mark_bh
c_func
(paren
id|NET_BH
)paren
suffix:semicolon
)brace
macro_line|#if 0
)brace
macro_line|#endif
)brace
eof
