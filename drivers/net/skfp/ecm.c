multiline_comment|/******************************************************************************&n; *&n; *&t;(C)Copyright 1998,1999 SysKonnect,&n; *&t;a business unit of Schneider &amp; Koch &amp; Co. Datensysteme GmbH.&n; *&n; *&t;See the file &quot;skfddi.c&quot; for further information.&n; *&n; *&t;This program is free software; you can redistribute it and/or modify&n; *&t;it under the terms of the GNU General Public License as published by&n; *&t;the Free Software Foundation; either version 2 of the License, or&n; *&t;(at your option) any later version.&n; *&n; *&t;The information in this file is provided &quot;AS IS&quot; without warranty.&n; *&n; ******************************************************************************/
multiline_comment|/*&n;&t;SMT ECM&n;&t;Entity Coordination Management&n;&t;Hardware independant state machine&n;*/
multiline_comment|/*&n; * Hardware independant state machine implemantation&n; * The following external SMT functions are referenced :&n; *&n; * &t;&t;queue_event()&n; * &t;&t;smt_timer_start()&n; * &t;&t;smt_timer_stop()&n; *&n; * &t;The following external HW dependant functions are referenced :&n; * &t;&t;sm_pm_bypass_req()&n; * &t;&t;sm_pm_ls_latch()&n; * &t;&t;sm_pm_get_ls()&n; * &n; * &t;The following HW dependant events are required :&n; *&t;&t;NONE&n; *&n; */
macro_line|#include &quot;h/types.h&quot;
macro_line|#include &quot;h/fddi.h&quot;
macro_line|#include &quot;h/smc.h&quot;
DECL|macro|KERNEL
mdefine_line|#define KERNEL
macro_line|#include &quot;h/smtstate.h&quot;
macro_line|#ifndef&t;lint
DECL|variable|ID_sccs
r_static
r_const
r_char
id|ID_sccs
(braket
)braket
op_assign
l_string|&quot;@(#)ecm.c&t;2.7 99/08/05 (C) SK &quot;
suffix:semicolon
macro_line|#endif
multiline_comment|/*&n; * FSM Macros&n; */
DECL|macro|AFLAG
mdefine_line|#define AFLAG&t;0x10
DECL|macro|GO_STATE
mdefine_line|#define GO_STATE(x)&t;(smc-&gt;mib.fddiSMTECMState = (x)|AFLAG)
DECL|macro|ACTIONS_DONE
mdefine_line|#define ACTIONS_DONE()&t;(smc-&gt;mib.fddiSMTECMState &amp;= ~AFLAG)
DECL|macro|ACTIONS
mdefine_line|#define ACTIONS(x)&t;(x|AFLAG)
DECL|macro|EC0_OUT
mdefine_line|#define EC0_OUT&t;&t;0&t;&t;&t;/* not inserted */
DECL|macro|EC1_IN
mdefine_line|#define EC1_IN&t;&t;1&t;&t;&t;/* inserted */
DECL|macro|EC2_TRACE
mdefine_line|#define EC2_TRACE&t;2&t;&t;&t;/* tracing */
DECL|macro|EC3_LEAVE
mdefine_line|#define EC3_LEAVE&t;3&t;&t;&t;/* leaving the ring */
DECL|macro|EC4_PATH_TEST
mdefine_line|#define EC4_PATH_TEST&t;4&t;&t;&t;/* performing path test */
DECL|macro|EC5_INSERT
mdefine_line|#define EC5_INSERT&t;5&t;&t;&t;/* bypass being turned on */
DECL|macro|EC6_CHECK
mdefine_line|#define EC6_CHECK&t;6&t;&t;&t;/* checking bypass */
DECL|macro|EC7_DEINSERT
mdefine_line|#define EC7_DEINSERT&t;7&t;&t;&t;/* bypass being turnde off */
macro_line|#ifdef&t;DEBUG
multiline_comment|/*&n; * symbolic state names&n; */
DECL|variable|ecm_states
r_static
r_const
r_char
op_star
r_const
id|ecm_states
(braket
)braket
op_assign
(brace
l_string|&quot;EC0_OUT&quot;
comma
l_string|&quot;EC1_IN&quot;
comma
l_string|&quot;EC2_TRACE&quot;
comma
l_string|&quot;EC3_LEAVE&quot;
comma
l_string|&quot;EC4_PATH_TEST&quot;
comma
l_string|&quot;EC5_INSERT&quot;
comma
l_string|&quot;EC6_CHECK&quot;
comma
l_string|&quot;EC7_DEINSERT&quot;
)brace
suffix:semicolon
multiline_comment|/*&n; * symbolic event names&n; */
DECL|variable|ecm_events
r_static
r_const
r_char
op_star
r_const
id|ecm_events
(braket
)braket
op_assign
(brace
l_string|&quot;NONE&quot;
comma
l_string|&quot;EC_CONNECT&quot;
comma
l_string|&quot;EC_DISCONNECT&quot;
comma
l_string|&quot;EC_TRACE_PROP&quot;
comma
l_string|&quot;EC_PATH_TEST&quot;
comma
l_string|&quot;EC_TIMEOUT_TD&quot;
comma
l_string|&quot;EC_TIMEOUT_TMAX&quot;
comma
l_string|&quot;EC_TIMEOUT_IMAX&quot;
comma
l_string|&quot;EC_TIMEOUT_INMAX&quot;
comma
l_string|&quot;EC_TEST_DONE&quot;
)brace
suffix:semicolon
macro_line|#endif
multiline_comment|/*&n; * all Globals  are defined in smc.h&n; * struct s_ecm&n; */
multiline_comment|/*&n; * function declarations&n; */
r_static
r_void
id|ecm_fsm
c_func
(paren
)paren
suffix:semicolon
r_static
r_void
id|start_ecm_timer
c_func
(paren
)paren
suffix:semicolon
r_static
r_void
id|stop_ecm_timer
c_func
(paren
)paren
suffix:semicolon
r_static
r_void
id|prop_actions
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/*&n;&t;init ECM state machine&n;&t;clear all ECM vars and flags&n;*/
DECL|function|ecm_init
r_void
id|ecm_init
c_func
(paren
id|smc
)paren
r_struct
id|s_smc
op_star
id|smc
suffix:semicolon
(brace
id|smc-&gt;e.path_test
op_assign
id|PT_PASSED
suffix:semicolon
id|smc-&gt;e.trace_prop
op_assign
l_int|0
suffix:semicolon
id|smc-&gt;e.sb_flag
op_assign
l_int|0
suffix:semicolon
id|smc-&gt;mib.fddiSMTECMState
op_assign
id|ACTIONS
c_func
(paren
id|EC0_OUT
)paren
suffix:semicolon
id|smc-&gt;e.ecm_line_state
op_assign
id|FALSE
suffix:semicolon
)brace
multiline_comment|/*&n;&t;ECM state machine&n;&t;called by dispatcher&n;&n;&t;do&n;&t;&t;display state change&n;&t;&t;process event&n;&t;until SM is stable&n;*/
DECL|function|ecm
r_void
id|ecm
c_func
(paren
id|smc
comma
id|event
)paren
r_struct
id|s_smc
op_star
id|smc
suffix:semicolon
r_int
id|event
suffix:semicolon
(brace
r_int
id|state
suffix:semicolon
r_do
(brace
id|DB_ECM
c_func
(paren
l_string|&quot;ECM : state %s%s&quot;
comma
(paren
id|smc-&gt;mib.fddiSMTECMState
op_amp
id|AFLAG
)paren
ques
c_cond
l_string|&quot;ACTIONS &quot;
suffix:colon
l_string|&quot;&quot;
comma
id|ecm_states
(braket
id|smc-&gt;mib.fddiSMTECMState
op_amp
op_complement
id|AFLAG
)braket
)paren
suffix:semicolon
id|DB_ECM
c_func
(paren
l_string|&quot; event %s&bslash;n&quot;
comma
id|ecm_events
(braket
id|event
)braket
comma
l_int|0
)paren
suffix:semicolon
id|state
op_assign
id|smc-&gt;mib.fddiSMTECMState
suffix:semicolon
id|ecm_fsm
c_func
(paren
id|smc
comma
id|event
)paren
suffix:semicolon
id|event
op_assign
l_int|0
suffix:semicolon
)brace
r_while
c_loop
(paren
id|state
op_ne
id|smc-&gt;mib.fddiSMTECMState
)paren
suffix:semicolon
id|ecm_state_change
c_func
(paren
id|smc
comma
(paren
r_int
)paren
id|smc-&gt;mib.fddiSMTECMState
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;&t;process ECM event&n;*/
DECL|function|ecm_fsm
r_static
r_void
id|ecm_fsm
c_func
(paren
id|smc
comma
id|cmd
)paren
r_struct
id|s_smc
op_star
id|smc
suffix:semicolon
r_int
id|cmd
suffix:semicolon
(brace
r_int
id|ls_a
suffix:semicolon
multiline_comment|/* current line state PHY A */
r_int
id|ls_b
suffix:semicolon
multiline_comment|/* current line state PHY B */
r_int
id|p
suffix:semicolon
multiline_comment|/* ports */
id|smc-&gt;mib.fddiSMTBypassPresent
op_assign
id|sm_pm_bypass_present
c_func
(paren
id|smc
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cmd
op_eq
id|EC_CONNECT
)paren
id|smc-&gt;mib.fddiSMTRemoteDisconnectFlag
op_assign
id|FALSE
suffix:semicolon
multiline_comment|/* For AIX event notification: */
multiline_comment|/* Is a disconnect  command remotely issued ? */
r_if
c_cond
(paren
id|cmd
op_eq
id|EC_DISCONNECT
op_logical_and
id|smc-&gt;mib.fddiSMTRemoteDisconnectFlag
op_eq
id|TRUE
)paren
id|AIX_EVENT
(paren
id|smc
comma
(paren
id|u_long
)paren
id|CIO_HARD_FAIL
comma
(paren
id|u_long
)paren
id|FDDI_REMOTE_DISCONNECT
comma
id|smt_get_event_word
c_func
(paren
id|smc
)paren
comma
id|smt_get_error_word
c_func
(paren
id|smc
)paren
)paren
suffix:semicolon
multiline_comment|/*jd 05-Aug-1999 Bug #10419 &quot;Port Disconnect fails at Dup MAc Cond.&quot;*/
r_if
c_cond
(paren
id|cmd
op_eq
id|EC_CONNECT
)paren
(brace
id|smc-&gt;e.DisconnectFlag
op_assign
id|FALSE
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|cmd
op_eq
id|EC_DISCONNECT
)paren
(brace
id|smc-&gt;e.DisconnectFlag
op_assign
id|TRUE
suffix:semicolon
)brace
r_switch
c_cond
(paren
id|smc-&gt;mib.fddiSMTECMState
)paren
(brace
r_case
id|ACTIONS
c_func
(paren
id|EC0_OUT
)paren
suffix:colon
multiline_comment|/*&n;&t;&t; * We do not perform a path test&n;&t;&t; */
id|smc-&gt;e.path_test
op_assign
id|PT_PASSED
suffix:semicolon
id|smc-&gt;e.ecm_line_state
op_assign
id|FALSE
suffix:semicolon
id|stop_ecm_timer
c_func
(paren
id|smc
)paren
suffix:semicolon
id|ACTIONS_DONE
c_func
(paren
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|EC0_OUT
suffix:colon
multiline_comment|/*EC01*/
r_if
c_cond
(paren
id|cmd
op_eq
id|EC_CONNECT
op_logical_and
op_logical_neg
id|smc-&gt;mib.fddiSMTBypassPresent
op_logical_and
id|smc-&gt;e.path_test
op_eq
id|PT_PASSED
)paren
(brace
id|GO_STATE
c_func
(paren
id|EC1_IN
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
multiline_comment|/*EC05*/
r_else
r_if
c_cond
(paren
id|cmd
op_eq
id|EC_CONNECT
op_logical_and
(paren
id|smc-&gt;e.path_test
op_eq
id|PT_PASSED
)paren
op_logical_and
id|smc-&gt;mib.fddiSMTBypassPresent
op_logical_and
(paren
id|smc-&gt;s.sas
op_eq
id|SMT_DAS
)paren
)paren
(brace
id|GO_STATE
c_func
(paren
id|EC5_INSERT
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|ACTIONS
c_func
(paren
id|EC1_IN
)paren
suffix:colon
id|stop_ecm_timer
c_func
(paren
id|smc
)paren
suffix:semicolon
id|smc-&gt;e.trace_prop
op_assign
l_int|0
suffix:semicolon
id|sm_ma_control
c_func
(paren
id|smc
comma
id|MA_TREQ
)paren
suffix:semicolon
r_for
c_loop
(paren
id|p
op_assign
l_int|0
suffix:semicolon
id|p
OL
id|NUMPHYS
suffix:semicolon
id|p
op_increment
)paren
r_if
c_cond
(paren
id|smc-&gt;mib.p
(braket
id|p
)braket
dot
id|fddiPORTHardwarePresent
)paren
id|queue_event
c_func
(paren
id|smc
comma
id|EVENT_PCMA
op_plus
id|p
comma
id|PC_START
)paren
suffix:semicolon
id|ACTIONS_DONE
c_func
(paren
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|EC1_IN
suffix:colon
multiline_comment|/*EC12*/
r_if
c_cond
(paren
id|cmd
op_eq
id|EC_TRACE_PROP
)paren
(brace
id|prop_actions
c_func
(paren
id|smc
)paren
suffix:semicolon
id|GO_STATE
c_func
(paren
id|EC2_TRACE
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
multiline_comment|/*EC13*/
r_else
r_if
c_cond
(paren
id|cmd
op_eq
id|EC_DISCONNECT
)paren
(brace
id|GO_STATE
c_func
(paren
id|EC3_LEAVE
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|ACTIONS
c_func
(paren
id|EC2_TRACE
)paren
suffix:colon
id|start_ecm_timer
c_func
(paren
id|smc
comma
id|MIB2US
c_func
(paren
id|smc-&gt;mib.fddiSMTTrace_MaxExpiration
)paren
comma
id|EC_TIMEOUT_TMAX
)paren
suffix:semicolon
id|ACTIONS_DONE
c_func
(paren
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|EC2_TRACE
suffix:colon
multiline_comment|/*EC22*/
r_if
c_cond
(paren
id|cmd
op_eq
id|EC_TRACE_PROP
)paren
(brace
id|prop_actions
c_func
(paren
id|smc
)paren
suffix:semicolon
id|GO_STATE
c_func
(paren
id|EC2_TRACE
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
multiline_comment|/*EC23a*/
r_else
r_if
c_cond
(paren
id|cmd
op_eq
id|EC_DISCONNECT
)paren
(brace
id|smc-&gt;e.path_test
op_assign
id|PT_EXITING
suffix:semicolon
id|GO_STATE
c_func
(paren
id|EC3_LEAVE
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
multiline_comment|/*EC23b*/
r_else
r_if
c_cond
(paren
id|smc-&gt;e.path_test
op_eq
id|PT_PENDING
)paren
(brace
id|GO_STATE
c_func
(paren
id|EC3_LEAVE
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
multiline_comment|/*EC23c*/
r_else
r_if
c_cond
(paren
id|cmd
op_eq
id|EC_TIMEOUT_TMAX
)paren
(brace
multiline_comment|/* Trace_Max is expired */
multiline_comment|/* -&gt; send AIX_EVENT */
id|AIX_EVENT
c_func
(paren
id|smc
comma
(paren
id|u_long
)paren
id|FDDI_RING_STATUS
comma
(paren
id|u_long
)paren
id|FDDI_SMT_ERROR
comma
(paren
id|u_long
)paren
id|FDDI_TRACE_MAX
comma
id|smt_get_error_word
c_func
(paren
id|smc
)paren
)paren
suffix:semicolon
id|smc-&gt;e.path_test
op_assign
id|PT_PENDING
suffix:semicolon
id|GO_STATE
c_func
(paren
id|EC3_LEAVE
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|ACTIONS
c_func
(paren
id|EC3_LEAVE
)paren
suffix:colon
id|start_ecm_timer
c_func
(paren
id|smc
comma
id|smc-&gt;s.ecm_td_min
comma
id|EC_TIMEOUT_TD
)paren
suffix:semicolon
r_for
c_loop
(paren
id|p
op_assign
l_int|0
suffix:semicolon
id|p
OL
id|NUMPHYS
suffix:semicolon
id|p
op_increment
)paren
id|queue_event
c_func
(paren
id|smc
comma
id|EVENT_PCMA
op_plus
id|p
comma
id|PC_STOP
)paren
suffix:semicolon
id|ACTIONS_DONE
c_func
(paren
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|EC3_LEAVE
suffix:colon
multiline_comment|/*EC30*/
r_if
c_cond
(paren
id|cmd
op_eq
id|EC_TIMEOUT_TD
op_logical_and
op_logical_neg
id|smc-&gt;mib.fddiSMTBypassPresent
op_logical_and
(paren
id|smc-&gt;e.path_test
op_ne
id|PT_PENDING
)paren
)paren
(brace
id|GO_STATE
c_func
(paren
id|EC0_OUT
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
multiline_comment|/*EC34*/
r_else
r_if
c_cond
(paren
id|cmd
op_eq
id|EC_TIMEOUT_TD
op_logical_and
(paren
id|smc-&gt;e.path_test
op_eq
id|PT_PENDING
)paren
)paren
(brace
id|GO_STATE
c_func
(paren
id|EC4_PATH_TEST
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
multiline_comment|/*EC31*/
r_else
r_if
c_cond
(paren
id|cmd
op_eq
id|EC_CONNECT
op_logical_and
id|smc-&gt;e.path_test
op_eq
id|PT_PASSED
)paren
(brace
id|GO_STATE
c_func
(paren
id|EC1_IN
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
multiline_comment|/*EC33*/
r_else
r_if
c_cond
(paren
id|cmd
op_eq
id|EC_DISCONNECT
op_logical_and
id|smc-&gt;e.path_test
op_eq
id|PT_PENDING
)paren
(brace
id|smc-&gt;e.path_test
op_assign
id|PT_EXITING
suffix:semicolon
multiline_comment|/*&n;&t;&t;&t; * stay in state - state will be left via timeout&n;&t;&t;&t; */
)brace
multiline_comment|/*EC37*/
r_else
r_if
c_cond
(paren
id|cmd
op_eq
id|EC_TIMEOUT_TD
op_logical_and
id|smc-&gt;mib.fddiSMTBypassPresent
op_logical_and
id|smc-&gt;e.path_test
op_ne
id|PT_PENDING
)paren
(brace
id|GO_STATE
c_func
(paren
id|EC7_DEINSERT
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|ACTIONS
c_func
(paren
id|EC4_PATH_TEST
)paren
suffix:colon
id|stop_ecm_timer
c_func
(paren
id|smc
)paren
suffix:semicolon
id|smc-&gt;e.path_test
op_assign
id|PT_TESTING
suffix:semicolon
id|start_ecm_timer
c_func
(paren
id|smc
comma
id|smc-&gt;s.ecm_test_done
comma
id|EC_TEST_DONE
)paren
suffix:semicolon
multiline_comment|/* now perform path test ... just a simulation */
id|ACTIONS_DONE
c_func
(paren
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|EC4_PATH_TEST
suffix:colon
multiline_comment|/* path test done delay */
r_if
c_cond
(paren
id|cmd
op_eq
id|EC_TEST_DONE
)paren
id|smc-&gt;e.path_test
op_assign
id|PT_PASSED
suffix:semicolon
r_if
c_cond
(paren
id|smc-&gt;e.path_test
op_eq
id|PT_FAILED
)paren
id|RS_SET
c_func
(paren
id|smc
comma
id|RS_PATHTEST
)paren
suffix:semicolon
multiline_comment|/*EC40a*/
r_if
c_cond
(paren
id|smc-&gt;e.path_test
op_eq
id|PT_FAILED
op_logical_and
op_logical_neg
id|smc-&gt;mib.fddiSMTBypassPresent
)paren
(brace
id|GO_STATE
c_func
(paren
id|EC0_OUT
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
multiline_comment|/*EC40b*/
r_else
r_if
c_cond
(paren
id|cmd
op_eq
id|EC_DISCONNECT
op_logical_and
op_logical_neg
id|smc-&gt;mib.fddiSMTBypassPresent
)paren
(brace
id|GO_STATE
c_func
(paren
id|EC0_OUT
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
multiline_comment|/*EC41*/
r_else
r_if
c_cond
(paren
id|smc-&gt;e.path_test
op_eq
id|PT_PASSED
)paren
(brace
id|GO_STATE
c_func
(paren
id|EC1_IN
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
multiline_comment|/*EC47a*/
r_else
r_if
c_cond
(paren
id|smc-&gt;e.path_test
op_eq
id|PT_FAILED
op_logical_and
id|smc-&gt;mib.fddiSMTBypassPresent
)paren
(brace
id|GO_STATE
c_func
(paren
id|EC7_DEINSERT
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
multiline_comment|/*EC47b*/
r_else
r_if
c_cond
(paren
id|cmd
op_eq
id|EC_DISCONNECT
op_logical_and
id|smc-&gt;mib.fddiSMTBypassPresent
)paren
(brace
id|GO_STATE
c_func
(paren
id|EC7_DEINSERT
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|ACTIONS
c_func
(paren
id|EC5_INSERT
)paren
suffix:colon
id|sm_pm_bypass_req
c_func
(paren
id|smc
comma
id|BP_INSERT
)paren
suffix:semicolon
id|start_ecm_timer
c_func
(paren
id|smc
comma
id|smc-&gt;s.ecm_in_max
comma
id|EC_TIMEOUT_INMAX
)paren
suffix:semicolon
id|ACTIONS_DONE
c_func
(paren
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|EC5_INSERT
suffix:colon
multiline_comment|/*EC56*/
r_if
c_cond
(paren
id|cmd
op_eq
id|EC_TIMEOUT_INMAX
)paren
(brace
id|GO_STATE
c_func
(paren
id|EC6_CHECK
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
multiline_comment|/*EC57*/
r_else
r_if
c_cond
(paren
id|cmd
op_eq
id|EC_DISCONNECT
)paren
(brace
id|GO_STATE
c_func
(paren
id|EC7_DEINSERT
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|ACTIONS
c_func
(paren
id|EC6_CHECK
)paren
suffix:colon
multiline_comment|/*&n;&t;&t; * in EC6_CHECK, we *POLL* the line state !&n;&t;&t; * check whether both bypass switches have switched.&n;&t;&t; */
id|start_ecm_timer
c_func
(paren
id|smc
comma
id|smc-&gt;s.ecm_check_poll
comma
l_int|0
)paren
suffix:semicolon
id|smc-&gt;e.ecm_line_state
op_assign
id|TRUE
suffix:semicolon
multiline_comment|/* flag to pcm: report Q/HLS */
(paren
r_void
)paren
id|sm_pm_ls_latch
c_func
(paren
id|smc
comma
id|PA
comma
l_int|1
)paren
suffix:semicolon
multiline_comment|/* enable line state latch */
(paren
r_void
)paren
id|sm_pm_ls_latch
c_func
(paren
id|smc
comma
id|PB
comma
l_int|1
)paren
suffix:semicolon
multiline_comment|/* enable line state latch */
id|ACTIONS_DONE
c_func
(paren
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|EC6_CHECK
suffix:colon
id|ls_a
op_assign
id|sm_pm_get_ls
c_func
(paren
id|smc
comma
id|PA
)paren
suffix:semicolon
id|ls_b
op_assign
id|sm_pm_get_ls
c_func
(paren
id|smc
comma
id|PB
)paren
suffix:semicolon
multiline_comment|/*EC61*/
r_if
c_cond
(paren
(paren
(paren
id|ls_a
op_eq
id|PC_QLS
)paren
op_logical_or
(paren
id|ls_a
op_eq
id|PC_HLS
)paren
)paren
op_logical_and
(paren
(paren
id|ls_b
op_eq
id|PC_QLS
)paren
op_logical_or
(paren
id|ls_b
op_eq
id|PC_HLS
)paren
)paren
)paren
(brace
id|smc-&gt;e.sb_flag
op_assign
id|FALSE
suffix:semicolon
id|smc-&gt;e.ecm_line_state
op_assign
id|FALSE
suffix:semicolon
id|GO_STATE
c_func
(paren
id|EC1_IN
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
multiline_comment|/*EC66*/
r_else
r_if
c_cond
(paren
op_logical_neg
id|smc-&gt;e.sb_flag
op_logical_and
(paren
(paren
(paren
id|ls_a
op_eq
id|PC_ILS
)paren
op_logical_and
(paren
id|ls_b
op_eq
id|PC_QLS
)paren
)paren
op_logical_or
(paren
(paren
id|ls_a
op_eq
id|PC_QLS
)paren
op_logical_and
(paren
id|ls_b
op_eq
id|PC_ILS
)paren
)paren
)paren
)paren
(brace
id|smc-&gt;e.sb_flag
op_assign
id|TRUE
suffix:semicolon
id|DB_ECMN
c_func
(paren
l_int|1
comma
l_string|&quot;ECM : EC6_CHECK - stuck bypass&bslash;n&quot;
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
id|AIX_EVENT
c_func
(paren
id|smc
comma
(paren
id|u_long
)paren
id|FDDI_RING_STATUS
comma
(paren
id|u_long
)paren
id|FDDI_SMT_ERROR
comma
(paren
id|u_long
)paren
id|FDDI_BYPASS_STUCK
comma
id|smt_get_error_word
c_func
(paren
id|smc
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/*EC67*/
r_else
r_if
c_cond
(paren
id|cmd
op_eq
id|EC_DISCONNECT
)paren
(brace
id|smc-&gt;e.ecm_line_state
op_assign
id|FALSE
suffix:semicolon
id|GO_STATE
c_func
(paren
id|EC7_DEINSERT
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/*&n;&t;&t;&t; * restart poll&n;&t;&t;&t; */
id|start_ecm_timer
c_func
(paren
id|smc
comma
id|smc-&gt;s.ecm_check_poll
comma
l_int|0
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|ACTIONS
c_func
(paren
id|EC7_DEINSERT
)paren
suffix:colon
id|sm_pm_bypass_req
c_func
(paren
id|smc
comma
id|BP_DEINSERT
)paren
suffix:semicolon
id|start_ecm_timer
c_func
(paren
id|smc
comma
id|smc-&gt;s.ecm_i_max
comma
id|EC_TIMEOUT_IMAX
)paren
suffix:semicolon
id|ACTIONS_DONE
c_func
(paren
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|EC7_DEINSERT
suffix:colon
multiline_comment|/*EC70*/
r_if
c_cond
(paren
id|cmd
op_eq
id|EC_TIMEOUT_IMAX
)paren
(brace
id|GO_STATE
c_func
(paren
id|EC0_OUT
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
multiline_comment|/*EC75*/
r_else
r_if
c_cond
(paren
id|cmd
op_eq
id|EC_CONNECT
op_logical_and
id|smc-&gt;e.path_test
op_eq
id|PT_PASSED
)paren
(brace
id|GO_STATE
c_func
(paren
id|EC5_INSERT
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_break
suffix:semicolon
r_default
suffix:colon
id|SMT_PANIC
c_func
(paren
id|smc
comma
id|SMT_E0107
comma
id|SMT_E0107_MSG
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
macro_line|#ifndef&t;CONCENTRATOR
multiline_comment|/*&n; * trace propagation actions for SAS &amp; DAS&n; */
DECL|function|prop_actions
r_static
r_void
id|prop_actions
c_func
(paren
id|smc
)paren
r_struct
id|s_smc
op_star
id|smc
suffix:semicolon
(brace
r_int
id|port_in
op_assign
l_int|0
suffix:semicolon
r_int
id|port_out
op_assign
l_int|0
suffix:semicolon
id|RS_SET
c_func
(paren
id|smc
comma
id|RS_EVENT
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|smc-&gt;s.sas
)paren
(brace
r_case
id|SMT_SAS
suffix:colon
id|port_in
op_assign
id|port_out
op_assign
id|pcm_get_s_port
c_func
(paren
id|smc
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SMT_DAS
suffix:colon
id|port_in
op_assign
id|cfm_get_mac_input
c_func
(paren
id|smc
)paren
suffix:semicolon
multiline_comment|/* PA or PB */
id|port_out
op_assign
id|cfm_get_mac_output
c_func
(paren
id|smc
)paren
suffix:semicolon
multiline_comment|/* PA or PB */
r_break
suffix:semicolon
r_case
id|SMT_NAC
suffix:colon
id|SMT_PANIC
c_func
(paren
id|smc
comma
id|SMT_E0108
comma
id|SMT_E0108_MSG
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|DB_ECM
c_func
(paren
l_string|&quot;ECM : prop_actions - trace_prop %d&bslash;n&quot;
comma
id|smc-&gt;e.trace_prop
comma
l_int|0
)paren
suffix:semicolon
id|DB_ECM
c_func
(paren
l_string|&quot;ECM : prop_actions - in %d out %d&bslash;n&quot;
comma
id|port_in
comma
id|port_out
)paren
suffix:semicolon
r_if
c_cond
(paren
id|smc-&gt;e.trace_prop
op_amp
id|ENTITY_BIT
c_func
(paren
id|ENTITY_MAC
)paren
)paren
(brace
multiline_comment|/* trace initiatior */
id|DB_ECM
c_func
(paren
l_string|&quot;ECM : initiate TRACE on PHY %c&bslash;n&quot;
comma
l_char|&squot;A&squot;
op_plus
id|port_in
op_minus
id|PA
comma
l_int|0
)paren
suffix:semicolon
id|queue_event
c_func
(paren
id|smc
comma
id|EVENT_PCM
op_plus
id|port_in
comma
id|PC_TRACE
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
(paren
id|smc-&gt;e.trace_prop
op_amp
id|ENTITY_BIT
c_func
(paren
id|ENTITY_PHY
c_func
(paren
id|PA
)paren
)paren
)paren
op_logical_and
id|port_out
op_ne
id|PA
)paren
(brace
multiline_comment|/* trace propagate upstream */
id|DB_ECM
c_func
(paren
l_string|&quot;ECM : propagate TRACE on PHY B&bslash;n&quot;
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
id|queue_event
c_func
(paren
id|smc
comma
id|EVENT_PCMB
comma
id|PC_TRACE
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
(paren
id|smc-&gt;e.trace_prop
op_amp
id|ENTITY_BIT
c_func
(paren
id|ENTITY_PHY
c_func
(paren
id|PB
)paren
)paren
)paren
op_logical_and
id|port_out
op_ne
id|PB
)paren
(brace
multiline_comment|/* trace propagate upstream */
id|DB_ECM
c_func
(paren
l_string|&quot;ECM : propagate TRACE on PHY A&bslash;n&quot;
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
id|queue_event
c_func
(paren
id|smc
comma
id|EVENT_PCMA
comma
id|PC_TRACE
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* signal trace termination */
id|DB_ECM
c_func
(paren
l_string|&quot;ECM : TRACE terminated&bslash;n&quot;
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
id|smc-&gt;e.path_test
op_assign
id|PT_PENDING
suffix:semicolon
)brace
id|smc-&gt;e.trace_prop
op_assign
l_int|0
suffix:semicolon
)brace
macro_line|#else
multiline_comment|/*&n; * trace propagation actions for Concentrator&n; */
DECL|function|prop_actions
r_static
r_void
id|prop_actions
c_func
(paren
id|smc
)paren
r_struct
id|s_smc
op_star
id|smc
suffix:semicolon
(brace
r_int
id|initiator
suffix:semicolon
r_int
id|upstream
suffix:semicolon
r_int
id|p
suffix:semicolon
id|RS_SET
c_func
(paren
id|smc
comma
id|RS_EVENT
)paren
suffix:semicolon
r_while
c_loop
(paren
id|smc-&gt;e.trace_prop
)paren
(brace
id|DB_ECM
c_func
(paren
l_string|&quot;ECM : prop_actions - trace_prop %d&bslash;n&quot;
comma
id|smc-&gt;e.trace_prop
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|smc-&gt;e.trace_prop
op_amp
id|ENTITY_BIT
c_func
(paren
id|ENTITY_MAC
)paren
)paren
(brace
id|initiator
op_assign
id|ENTITY_MAC
suffix:semicolon
id|smc-&gt;e.trace_prop
op_and_assign
op_complement
id|ENTITY_BIT
c_func
(paren
id|ENTITY_MAC
)paren
suffix:semicolon
id|DB_ECM
c_func
(paren
l_string|&quot;ECM: MAC initiates trace&bslash;n&quot;
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
)brace
r_else
(brace
r_for
c_loop
(paren
id|p
op_assign
id|NUMPHYS
op_minus
l_int|1
suffix:semicolon
id|p
op_ge
l_int|0
suffix:semicolon
id|p
op_decrement
)paren
(brace
r_if
c_cond
(paren
id|smc-&gt;e.trace_prop
op_amp
id|ENTITY_BIT
c_func
(paren
id|ENTITY_PHY
c_func
(paren
id|p
)paren
)paren
)paren
r_break
suffix:semicolon
)brace
id|initiator
op_assign
id|ENTITY_PHY
c_func
(paren
id|p
)paren
suffix:semicolon
id|smc-&gt;e.trace_prop
op_and_assign
op_complement
id|ENTITY_BIT
c_func
(paren
id|ENTITY_PHY
c_func
(paren
id|p
)paren
)paren
suffix:semicolon
)brace
id|upstream
op_assign
id|cem_get_upstream
c_func
(paren
id|smc
comma
id|initiator
)paren
suffix:semicolon
r_if
c_cond
(paren
id|upstream
op_eq
id|ENTITY_MAC
)paren
(brace
multiline_comment|/* signal trace termination */
id|DB_ECM
c_func
(paren
l_string|&quot;ECM : TRACE terminated&bslash;n&quot;
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
id|smc-&gt;e.path_test
op_assign
id|PT_PENDING
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* trace propagate upstream */
id|DB_ECM
c_func
(paren
l_string|&quot;ECM : propagate TRACE on PHY %d&bslash;n&quot;
comma
id|upstream
comma
l_int|0
)paren
suffix:semicolon
id|queue_event
c_func
(paren
id|smc
comma
id|EVENT_PCM
op_plus
id|upstream
comma
id|PC_TRACE
)paren
suffix:semicolon
)brace
)brace
)brace
macro_line|#endif
multiline_comment|/*&n; * SMT timer interface&n; *&t;start ECM timer&n; */
DECL|function|start_ecm_timer
r_static
r_void
id|start_ecm_timer
c_func
(paren
id|smc
comma
id|value
comma
id|event
)paren
r_struct
id|s_smc
op_star
id|smc
suffix:semicolon
id|u_long
id|value
suffix:semicolon
r_int
id|event
suffix:semicolon
(brace
id|smt_timer_start
c_func
(paren
id|smc
comma
op_amp
id|smc-&gt;e.ecm_timer
comma
id|value
comma
id|EV_TOKEN
c_func
(paren
id|EVENT_ECM
comma
id|event
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * SMT timer interface&n; *&t;stop ECM timer&n; */
DECL|function|stop_ecm_timer
r_static
r_void
id|stop_ecm_timer
c_func
(paren
id|smc
)paren
r_struct
id|s_smc
op_star
id|smc
suffix:semicolon
(brace
r_if
c_cond
(paren
id|smc-&gt;e.ecm_timer.tm_active
)paren
id|smt_timer_stop
c_func
(paren
id|smc
comma
op_amp
id|smc-&gt;e.ecm_timer
)paren
suffix:semicolon
)brace
eof
