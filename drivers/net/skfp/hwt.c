multiline_comment|/******************************************************************************&n; *&n; *&t;(C)Copyright 1998,1999 SysKonnect,&n; *&t;a business unit of Schneider &amp; Koch &amp; Co. Datensysteme GmbH.&n; *&n; *&t;See the file &quot;skfddi.c&quot; for further information.&n; *&n; *&t;This program is free software; you can redistribute it and/or modify&n; *&t;it under the terms of the GNU General Public License as published by&n; *&t;the Free Software Foundation; either version 2 of the License, or&n; *&t;(at your option) any later version.&n; *&n; *&t;The information in this file is provided &quot;AS IS&quot; without warranty.&n; *&n; ******************************************************************************/
multiline_comment|/*&n; * Timer Driver for FBI board (timer chip 82C54)&n; */
multiline_comment|/*&n; * Modifications:&n; *&n; *&t;28-Jun-1994 sw&t;Edit v1.6.&n; *&t;&t;&t;MCA: Added support for the SK-NET FDDI-FM2 adapter. The&n; *&t;&t;&t; following functions have been added(+) or modified(*):&n; *&t;&t;&t; hwt_start(*), hwt_stop(*), hwt_restart(*), hwt_read(*)&n; */
macro_line|#include &quot;h/types.h&quot;
macro_line|#include &quot;h/fddi.h&quot;
macro_line|#include &quot;h/smc.h&quot;
macro_line|#ifndef&t;lint
DECL|variable|ID_sccs
r_static
r_const
r_char
id|ID_sccs
(braket
)braket
op_assign
l_string|&quot;@(#)hwt.c&t;1.13 97/04/23 (C) SK &quot;
suffix:semicolon
macro_line|#endif
multiline_comment|/*&n; * Prototypes of local functions.&n; */
multiline_comment|/* 28-Jun-1994 sw - Note: hwt_restart() is also used in module &squot;drvfbi.c&squot;. */
multiline_comment|/*static*/
r_void
id|hwt_restart
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/************************&n; *&n; *&t;hwt_start&n; *&n; *&t;Start hardware timer (clock ticks are 16us).&n; *&n; *&t;void hwt_start(&n; *&t;&t;struct s_smc *smc,&n; *&t;&t;u_long time) ;&n; * In&n; *&t;smc - A pointer to the SMT Context structure.&n; *&n; *&t;time - The time in units of 16us to load the timer with.&n; * Out&n; *&t;Nothing.&n; *&n; ************************/
DECL|macro|HWT_MAX
mdefine_line|#define&t;HWT_MAX&t;(65000)
DECL|function|hwt_start
r_void
id|hwt_start
c_func
(paren
id|smc
comma
id|time
)paren
r_struct
id|s_smc
op_star
id|smc
suffix:semicolon
id|u_long
id|time
suffix:semicolon
(brace
id|u_short
id|cnt
suffix:semicolon
r_if
c_cond
(paren
id|time
OG
id|HWT_MAX
)paren
id|time
op_assign
id|HWT_MAX
suffix:semicolon
id|smc-&gt;hw.t_start
op_assign
id|time
suffix:semicolon
id|smc-&gt;hw.t_stop
op_assign
l_int|0L
suffix:semicolon
id|cnt
op_assign
(paren
id|u_short
)paren
id|time
suffix:semicolon
multiline_comment|/*&n;&t; * if time &lt; 16 us&n;&t; *&t;time = 16 us&n;&t; */
r_if
c_cond
(paren
op_logical_neg
id|cnt
)paren
id|cnt
op_increment
suffix:semicolon
macro_line|#ifndef&t;PCI
multiline_comment|/*&n;&t; * 6.25MHz -&gt; CLK0 : T0 (cnt0 = 16us)&t;-&gt; OUT0&n;&t; *    OUT0 -&gt; CLK1 : T1 (cnt1)&t;OUT1&t;-&gt; ISRA(IS_TIMINT)&n;&t; */
id|OUT_82c54_TIMER
c_func
(paren
l_int|3
comma
l_int|1
op_lshift
l_int|6
op_or
l_int|3
op_lshift
l_int|4
op_or
l_int|0
op_lshift
l_int|1
)paren
suffix:semicolon
multiline_comment|/* counter 1, mode 0 */
id|OUT_82c54_TIMER
c_func
(paren
l_int|1
comma
id|cnt
op_amp
l_int|0xff
)paren
suffix:semicolon
multiline_comment|/* LSB */
id|OUT_82c54_TIMER
c_func
(paren
l_int|1
comma
(paren
id|cnt
op_rshift
l_int|8
)paren
op_amp
l_int|0xff
)paren
suffix:semicolon
multiline_comment|/* MSB */
multiline_comment|/*&n;&t; * start timer by switching counter 0 to mode 3&n;&t; *&t;T0 resolution 16 us (CLK0=0.16us)&n;&t; */
id|OUT_82c54_TIMER
c_func
(paren
l_int|3
comma
l_int|0
op_lshift
l_int|6
op_or
l_int|3
op_lshift
l_int|4
op_or
l_int|3
op_lshift
l_int|1
)paren
suffix:semicolon
multiline_comment|/* counter 0, mode 3 */
id|OUT_82c54_TIMER
c_func
(paren
l_int|0
comma
l_int|100
)paren
suffix:semicolon
multiline_comment|/* LSB */
id|OUT_82c54_TIMER
c_func
(paren
l_int|0
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* MSB */
macro_line|#else&t;/* PCI */
id|outpd
c_func
(paren
id|ADDR
c_func
(paren
id|B2_TI_INI
)paren
comma
(paren
id|u_long
)paren
id|cnt
op_star
l_int|200
)paren
suffix:semicolon
multiline_comment|/* Load timer value. */
id|outpw
c_func
(paren
id|ADDR
c_func
(paren
id|B2_TI_CRTL
)paren
comma
id|TIM_START
)paren
suffix:semicolon
multiline_comment|/* Start timer. */
macro_line|#endif&t;/* PCI */
id|smc-&gt;hw.timer_activ
op_assign
id|TRUE
suffix:semicolon
)brace
multiline_comment|/************************&n; *&n; *&t;hwt_stop&n; *&n; *&t;Stop hardware timer.&n; *&n; *&t;void hwt_stop(&n; *&t;&t;struct s_smc *smc) ;&n; * In&n; *&t;smc - A pointer to the SMT Context structure.&n; * Out&n; *&t;Nothing.&n; *&n; ************************/
DECL|function|hwt_stop
r_void
id|hwt_stop
c_func
(paren
id|smc
)paren
r_struct
id|s_smc
op_star
id|smc
suffix:semicolon
(brace
macro_line|#ifndef PCI
multiline_comment|/* stop counter 0 by switching to mode 0 */
id|OUT_82c54_TIMER
c_func
(paren
l_int|3
comma
l_int|0
op_lshift
l_int|6
op_or
l_int|3
op_lshift
l_int|4
op_or
l_int|0
op_lshift
l_int|1
)paren
suffix:semicolon
multiline_comment|/* counter 0, mode 0 */
id|OUT_82c54_TIMER
c_func
(paren
l_int|0
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* LSB */
id|OUT_82c54_TIMER
c_func
(paren
l_int|0
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* MSB */
macro_line|#else&t;/* PCI */
id|outpw
c_func
(paren
id|ADDR
c_func
(paren
id|B2_TI_CRTL
)paren
comma
id|TIM_STOP
)paren
suffix:semicolon
id|outpw
c_func
(paren
id|ADDR
c_func
(paren
id|B2_TI_CRTL
)paren
comma
id|TIM_CL_IRQ
)paren
suffix:semicolon
macro_line|#endif&t;/* PCI */
id|smc-&gt;hw.timer_activ
op_assign
id|FALSE
suffix:semicolon
)brace
multiline_comment|/************************&n; *&n; *&t;hwt_init&n; *&n; *&t;Initialize hardware timer.&n; *&n; *&t;void hwt_init(&n; *&t;&t;struct s_smc *smc) ;&n; * In&n; *&t;smc - A pointer to the SMT Context structure.&n; * Out&n; *&t;Nothing.&n; *&n; ************************/
DECL|function|hwt_init
r_void
id|hwt_init
c_func
(paren
id|smc
)paren
r_struct
id|s_smc
op_star
id|smc
suffix:semicolon
(brace
id|smc-&gt;hw.t_start
op_assign
l_int|0
suffix:semicolon
id|smc-&gt;hw.t_stop
op_assign
l_int|0
suffix:semicolon
id|smc-&gt;hw.timer_activ
op_assign
id|FALSE
suffix:semicolon
id|hwt_restart
c_func
(paren
id|smc
)paren
suffix:semicolon
)brace
multiline_comment|/************************&n; *&n; *&t;hwt_restart&n; *&n; *&t;Clear timer interrupt.&n; *&n; *&t;void hwt_restart(&n; *&t;&t;struct s_smc *smc) ;&n; * In&n; *&t;smc - A pointer to the SMT Context structure.&n; * Out&n; *&t;Nothing.&n; *&n; ************************/
DECL|function|hwt_restart
r_void
id|hwt_restart
c_func
(paren
id|smc
)paren
r_struct
id|s_smc
op_star
id|smc
suffix:semicolon
(brace
id|hwt_stop
c_func
(paren
id|smc
)paren
suffix:semicolon
macro_line|#ifndef&t;PCI
id|OUT_82c54_TIMER
c_func
(paren
l_int|3
comma
l_int|1
op_lshift
l_int|6
op_or
l_int|3
op_lshift
l_int|4
op_or
l_int|0
op_lshift
l_int|1
)paren
suffix:semicolon
multiline_comment|/* counter 1, mode 0 */
id|OUT_82c54_TIMER
c_func
(paren
l_int|1
comma
l_int|1
)paren
suffix:semicolon
multiline_comment|/* LSB */
id|OUT_82c54_TIMER
c_func
(paren
l_int|1
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* MSB */
macro_line|#endif
)brace
multiline_comment|/************************&n; *&n; *&t;hwt_read&n; *&n; *&t;Stop hardware timer and read time elapsed since last start.&n; *&n; *&t;u_long hwt_read(smc) ;&n; * In&n; *&t;smc - A pointer to the SMT Context structure.&n; * Out&n; *&t;The elapsed time since last start in units of 16us.&n; *&n; ************************/
DECL|function|hwt_read
id|u_long
id|hwt_read
c_func
(paren
id|smc
)paren
r_struct
id|s_smc
op_star
id|smc
suffix:semicolon
(brace
id|u_short
id|tr
suffix:semicolon
macro_line|#ifndef&t;PCI
id|u_short
id|is
suffix:semicolon
macro_line|#else
id|u_long
id|is
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|smc-&gt;hw.timer_activ
)paren
(brace
id|hwt_stop
c_func
(paren
id|smc
)paren
suffix:semicolon
macro_line|#ifndef&t;PCI
id|OUT_82c54_TIMER
c_func
(paren
l_int|3
comma
l_int|1
op_lshift
l_int|6
)paren
suffix:semicolon
multiline_comment|/* latch command */
id|tr
op_assign
id|IN_82c54_TIMER
c_func
(paren
l_int|1
)paren
op_amp
l_int|0xff
suffix:semicolon
id|tr
op_add_assign
(paren
id|IN_82c54_TIMER
c_func
(paren
l_int|1
)paren
op_amp
l_int|0xff
)paren
op_lshift
l_int|8
suffix:semicolon
macro_line|#else&t;/* PCI */
id|tr
op_assign
(paren
id|u_short
)paren
(paren
(paren
id|inpd
c_func
(paren
id|ADDR
c_func
(paren
id|B2_TI_VAL
)paren
)paren
op_div
l_int|200
)paren
op_amp
l_int|0xffff
)paren
suffix:semicolon
macro_line|#endif&t;/* PCI */
id|is
op_assign
id|GET_ISR
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* Check if timer expired (or wraparound). */
r_if
c_cond
(paren
(paren
id|tr
OG
id|smc-&gt;hw.t_start
)paren
op_logical_or
(paren
id|is
op_amp
id|IS_TIMINT
)paren
)paren
(brace
id|hwt_restart
c_func
(paren
id|smc
)paren
suffix:semicolon
id|smc-&gt;hw.t_stop
op_assign
id|smc-&gt;hw.t_start
suffix:semicolon
)brace
r_else
id|smc-&gt;hw.t_stop
op_assign
id|smc-&gt;hw.t_start
op_minus
id|tr
suffix:semicolon
)brace
r_return
(paren
id|smc-&gt;hw.t_stop
)paren
suffix:semicolon
)brace
macro_line|#ifdef&t;PCI
multiline_comment|/************************&n; *&n; *&t;hwt_quick_read&n; *&n; *&t;Stop hardware timer and read timer value and start the timer again.&n; *&n; *&t;u_long hwt_read(smc) ;&n; * In&n; *&t;smc - A pointer to the SMT Context structure.&n; * Out&n; *&t;current timer value in units of 80ns.&n; *&n; ************************/
DECL|function|hwt_quick_read
id|u_long
id|hwt_quick_read
c_func
(paren
id|smc
)paren
r_struct
id|s_smc
op_star
id|smc
suffix:semicolon
(brace
id|u_long
id|interval
suffix:semicolon
id|u_long
id|time
suffix:semicolon
id|interval
op_assign
id|inpd
c_func
(paren
id|ADDR
c_func
(paren
id|B2_TI_INI
)paren
)paren
suffix:semicolon
id|outpw
c_func
(paren
id|ADDR
c_func
(paren
id|B2_TI_CRTL
)paren
comma
id|TIM_STOP
)paren
suffix:semicolon
id|time
op_assign
id|inpd
c_func
(paren
id|ADDR
c_func
(paren
id|B2_TI_VAL
)paren
)paren
suffix:semicolon
id|outpd
c_func
(paren
id|ADDR
c_func
(paren
id|B2_TI_INI
)paren
comma
id|time
)paren
suffix:semicolon
id|outpw
c_func
(paren
id|ADDR
c_func
(paren
id|B2_TI_CRTL
)paren
comma
id|TIM_START
)paren
suffix:semicolon
id|outpd
c_func
(paren
id|ADDR
c_func
(paren
id|B2_TI_INI
)paren
comma
id|interval
)paren
suffix:semicolon
r_return
(paren
id|time
)paren
suffix:semicolon
)brace
multiline_comment|/************************&n; *&n; *&t;hwt_wait_time(smc,start,duration)&n; *&n; *&t;This function returnes after the amount of time is elapsed&n; *&t;since the start time.&n; * &n; * para&t;start&t;&t;start time&n; *&t;duration&t;time to wait&n; *&n; * NOTE: The fuction will return immediatly, if the timer is not &n; *&t; started&n; ************************/
DECL|function|hwt_wait_time
r_void
id|hwt_wait_time
c_func
(paren
id|smc
comma
id|start
comma
id|duration
)paren
r_struct
id|s_smc
op_star
id|smc
suffix:semicolon
id|u_long
id|start
suffix:semicolon
r_int
id|duration
suffix:semicolon
(brace
r_int
id|diff
suffix:semicolon
r_int
id|interval
suffix:semicolon
r_int
id|wrapped
suffix:semicolon
multiline_comment|/*&n;&t; * check if timer is running&n;&t; */
r_if
c_cond
(paren
id|smc-&gt;hw.timer_activ
op_eq
id|FALSE
op_logical_or
id|hwt_quick_read
c_func
(paren
id|smc
)paren
op_eq
id|hwt_quick_read
c_func
(paren
id|smc
)paren
)paren
(brace
r_return
suffix:semicolon
)brace
id|interval
op_assign
id|inpd
c_func
(paren
id|ADDR
c_func
(paren
id|B2_TI_INI
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|interval
OG
id|duration
)paren
(brace
r_do
(brace
id|diff
op_assign
(paren
r_int
)paren
(paren
id|start
op_minus
id|hwt_quick_read
c_func
(paren
id|smc
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|diff
OL
l_int|0
)paren
(brace
id|diff
op_add_assign
id|interval
suffix:semicolon
)brace
)brace
r_while
c_loop
(paren
id|diff
op_le
id|duration
)paren
suffix:semicolon
)brace
r_else
(brace
id|diff
op_assign
id|interval
suffix:semicolon
id|wrapped
op_assign
l_int|0
suffix:semicolon
r_do
(brace
r_if
c_cond
(paren
op_logical_neg
id|wrapped
)paren
(brace
r_if
c_cond
(paren
id|hwt_quick_read
c_func
(paren
id|smc
)paren
op_ge
id|start
)paren
(brace
id|diff
op_add_assign
id|interval
suffix:semicolon
id|wrapped
op_assign
l_int|1
suffix:semicolon
)brace
)brace
r_else
(brace
r_if
c_cond
(paren
id|hwt_quick_read
c_func
(paren
id|smc
)paren
OL
id|start
)paren
(brace
id|wrapped
op_assign
l_int|0
suffix:semicolon
)brace
)brace
)brace
r_while
c_loop
(paren
id|diff
op_le
id|duration
)paren
suffix:semicolon
)brace
)brace
macro_line|#endif
eof
