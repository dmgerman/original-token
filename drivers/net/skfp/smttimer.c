multiline_comment|/******************************************************************************&n; *&n; *&t;(C)Copyright 1998,1999 SysKonnect,&n; *&t;a business unit of Schneider &amp; Koch &amp; Co. Datensysteme GmbH.&n; *&n; *&t;See the file &quot;skfddi.c&quot; for further information.&n; *&n; *&t;This program is free software; you can redistribute it and/or modify&n; *&t;it under the terms of the GNU General Public License as published by&n; *&t;the Free Software Foundation; either version 2 of the License, or&n; *&t;(at your option) any later version.&n; *&n; *&t;The information in this file is provided &quot;AS IS&quot; without warranty.&n; *&n; ******************************************************************************/
multiline_comment|/*&n;&t;SMT timer&n;*/
macro_line|#include &quot;h/types.h&quot;
macro_line|#include &quot;h/fddi.h&quot;
macro_line|#include &quot;h/smc.h&quot;
macro_line|#ifndef&t;lint
DECL|variable|ID_sccs
r_static
r_const
r_char
id|ID_sccs
(braket
)braket
op_assign
l_string|&quot;@(#)smttimer.c&t;2.4 97/08/04 (C) SK &quot;
suffix:semicolon
macro_line|#endif
multiline_comment|/*&n; * external function declarations&n; */
r_extern
id|u_long
id|hwt_read
c_func
(paren
)paren
suffix:semicolon
r_extern
r_void
id|hwt_stop
c_func
(paren
)paren
suffix:semicolon
r_extern
r_void
id|hwt_start
c_func
(paren
)paren
suffix:semicolon
r_static
r_void
id|timer_done
c_func
(paren
)paren
suffix:semicolon
DECL|function|smt_timer_init
r_void
id|smt_timer_init
c_func
(paren
id|smc
)paren
r_struct
id|s_smc
op_star
id|smc
suffix:semicolon
(brace
id|smc-&gt;t.st_queue
op_assign
l_int|0
suffix:semicolon
id|smc-&gt;t.st_fast.tm_active
op_assign
id|FALSE
suffix:semicolon
id|smc-&gt;t.st_fast.tm_next
op_assign
l_int|0
suffix:semicolon
id|hwt_init
c_func
(paren
id|smc
)paren
suffix:semicolon
)brace
DECL|function|smt_timer_stop
r_void
id|smt_timer_stop
c_func
(paren
id|smc
comma
id|timer
)paren
r_struct
id|s_smc
op_star
id|smc
suffix:semicolon
r_struct
id|smt_timer
op_star
id|timer
suffix:semicolon
(brace
r_struct
id|smt_timer
op_star
op_star
id|prev
suffix:semicolon
r_struct
id|smt_timer
op_star
id|tm
suffix:semicolon
multiline_comment|/*&n;&t; * remove timer from queue&n;&t; */
id|timer-&gt;tm_active
op_assign
id|FALSE
suffix:semicolon
r_if
c_cond
(paren
id|smc-&gt;t.st_queue
op_eq
id|timer
op_logical_and
op_logical_neg
id|timer-&gt;tm_next
)paren
(brace
id|hwt_stop
c_func
(paren
id|smc
)paren
suffix:semicolon
)brace
r_for
c_loop
(paren
id|prev
op_assign
op_amp
id|smc-&gt;t.st_queue
suffix:semicolon
(paren
id|tm
op_assign
op_star
id|prev
)paren
suffix:semicolon
id|prev
op_assign
op_amp
id|tm-&gt;tm_next
)paren
(brace
r_if
c_cond
(paren
id|tm
op_eq
id|timer
)paren
(brace
op_star
id|prev
op_assign
id|tm-&gt;tm_next
suffix:semicolon
r_if
c_cond
(paren
id|tm-&gt;tm_next
)paren
(brace
id|tm-&gt;tm_next-&gt;tm_delta
op_add_assign
id|tm-&gt;tm_delta
suffix:semicolon
)brace
r_return
suffix:semicolon
)brace
)brace
)brace
DECL|function|smt_timer_start
r_void
id|smt_timer_start
c_func
(paren
id|smc
comma
id|timer
comma
id|time
comma
id|token
)paren
r_struct
id|s_smc
op_star
id|smc
suffix:semicolon
r_struct
id|smt_timer
op_star
id|timer
suffix:semicolon
id|u_long
id|time
suffix:semicolon
id|u_long
id|token
suffix:semicolon
(brace
r_struct
id|smt_timer
op_star
op_star
id|prev
suffix:semicolon
r_struct
id|smt_timer
op_star
id|tm
suffix:semicolon
id|u_long
id|delta
op_assign
l_int|0
suffix:semicolon
id|time
op_div_assign
l_int|16
suffix:semicolon
multiline_comment|/* input is uS, clock ticks are 16uS */
r_if
c_cond
(paren
op_logical_neg
id|time
)paren
id|time
op_assign
l_int|1
suffix:semicolon
id|smt_timer_stop
c_func
(paren
id|smc
comma
id|timer
)paren
suffix:semicolon
id|timer-&gt;tm_smc
op_assign
id|smc
suffix:semicolon
id|timer-&gt;tm_token
op_assign
id|token
suffix:semicolon
id|timer-&gt;tm_active
op_assign
id|TRUE
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|smc-&gt;t.st_queue
)paren
(brace
id|smc-&gt;t.st_queue
op_assign
id|timer
suffix:semicolon
id|timer-&gt;tm_next
op_assign
l_int|0
suffix:semicolon
id|timer-&gt;tm_delta
op_assign
id|time
suffix:semicolon
id|hwt_start
c_func
(paren
id|smc
comma
id|time
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * timer correction&n;&t; */
id|timer_done
c_func
(paren
id|smc
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * find position in queue&n;&t; */
id|delta
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|prev
op_assign
op_amp
id|smc-&gt;t.st_queue
suffix:semicolon
(paren
id|tm
op_assign
op_star
id|prev
)paren
suffix:semicolon
id|prev
op_assign
op_amp
id|tm-&gt;tm_next
)paren
(brace
r_if
c_cond
(paren
id|delta
op_plus
id|tm-&gt;tm_delta
OG
id|time
)paren
(brace
r_break
suffix:semicolon
)brace
id|delta
op_add_assign
id|tm-&gt;tm_delta
suffix:semicolon
)brace
multiline_comment|/* insert in queue */
op_star
id|prev
op_assign
id|timer
suffix:semicolon
id|timer-&gt;tm_next
op_assign
id|tm
suffix:semicolon
id|timer-&gt;tm_delta
op_assign
id|time
op_minus
id|delta
suffix:semicolon
r_if
c_cond
(paren
id|tm
)paren
id|tm-&gt;tm_delta
op_sub_assign
id|timer-&gt;tm_delta
suffix:semicolon
multiline_comment|/*&n;&t; * start new with first&n;&t; */
id|hwt_start
c_func
(paren
id|smc
comma
id|smc-&gt;t.st_queue-&gt;tm_delta
)paren
suffix:semicolon
)brace
DECL|function|smt_force_irq
r_void
id|smt_force_irq
c_func
(paren
id|smc
)paren
r_struct
id|s_smc
op_star
id|smc
suffix:semicolon
(brace
id|smt_timer_start
c_func
(paren
id|smc
comma
op_amp
id|smc-&gt;t.st_fast
comma
l_int|32L
comma
id|EV_TOKEN
c_func
(paren
id|EVENT_SMT
comma
id|SM_FAST
)paren
)paren
suffix:semicolon
)brace
DECL|function|smt_timer_done
r_void
id|smt_timer_done
c_func
(paren
id|smc
)paren
r_struct
id|s_smc
op_star
id|smc
suffix:semicolon
(brace
id|timer_done
c_func
(paren
id|smc
comma
l_int|1
)paren
suffix:semicolon
)brace
DECL|function|timer_done
r_static
r_void
id|timer_done
c_func
(paren
id|smc
comma
id|restart
)paren
r_struct
id|s_smc
op_star
id|smc
suffix:semicolon
r_int
id|restart
suffix:semicolon
(brace
id|u_long
id|delta
suffix:semicolon
r_struct
id|smt_timer
op_star
id|tm
suffix:semicolon
r_struct
id|smt_timer
op_star
id|next
suffix:semicolon
r_struct
id|smt_timer
op_star
op_star
id|last
suffix:semicolon
r_int
id|done
op_assign
l_int|0
suffix:semicolon
id|delta
op_assign
id|hwt_read
c_func
(paren
id|smc
)paren
suffix:semicolon
id|last
op_assign
op_amp
id|smc-&gt;t.st_queue
suffix:semicolon
id|tm
op_assign
id|smc-&gt;t.st_queue
suffix:semicolon
r_while
c_loop
(paren
id|tm
op_logical_and
op_logical_neg
id|done
)paren
(brace
r_if
c_cond
(paren
id|delta
op_ge
id|tm-&gt;tm_delta
)paren
(brace
id|tm-&gt;tm_active
op_assign
id|FALSE
suffix:semicolon
id|delta
op_sub_assign
id|tm-&gt;tm_delta
suffix:semicolon
id|last
op_assign
op_amp
id|tm-&gt;tm_next
suffix:semicolon
id|tm
op_assign
id|tm-&gt;tm_next
suffix:semicolon
)brace
r_else
(brace
id|tm-&gt;tm_delta
op_sub_assign
id|delta
suffix:semicolon
id|delta
op_assign
l_int|0
suffix:semicolon
id|done
op_assign
l_int|1
suffix:semicolon
)brace
)brace
op_star
id|last
op_assign
l_int|0
suffix:semicolon
id|next
op_assign
id|smc-&gt;t.st_queue
suffix:semicolon
id|smc-&gt;t.st_queue
op_assign
id|tm
suffix:semicolon
r_for
c_loop
(paren
id|tm
op_assign
id|next
suffix:semicolon
id|tm
suffix:semicolon
id|tm
op_assign
id|next
)paren
(brace
id|next
op_assign
id|tm-&gt;tm_next
suffix:semicolon
id|timer_event
c_func
(paren
id|smc
comma
id|tm-&gt;tm_token
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|restart
op_logical_and
id|smc-&gt;t.st_queue
)paren
id|hwt_start
c_func
(paren
id|smc
comma
id|smc-&gt;t.st_queue-&gt;tm_delta
)paren
suffix:semicolon
)brace
eof
