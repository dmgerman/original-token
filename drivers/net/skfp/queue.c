multiline_comment|/******************************************************************************&n; *&n; *&t;(C)Copyright 1998,1999 SysKonnect,&n; *&t;a business unit of Schneider &amp; Koch &amp; Co. Datensysteme GmbH.&n; *&n; *&t;See the file &quot;skfddi.c&quot; for further information.&n; *&n; *&t;This program is free software; you can redistribute it and/or modify&n; *&t;it under the terms of the GNU General Public License as published by&n; *&t;the Free Software Foundation; either version 2 of the License, or&n; *&t;(at your option) any later version.&n; *&n; *&t;The information in this file is provided &quot;AS IS&quot; without warranty.&n; *&n; ******************************************************************************/
multiline_comment|/*&n;&t;SMT Event Queue Management&n;*/
macro_line|#include &quot;h/types.h&quot;
macro_line|#include &quot;h/fddi.h&quot;
macro_line|#include &quot;h/smc.h&quot;
macro_line|#ifndef&t;lint
DECL|variable|ID_sccs
r_static
r_const
r_char
id|ID_sccs
(braket
)braket
op_assign
l_string|&quot;@(#)queue.c&t;2.9 97/08/04 (C) SK &quot;
suffix:semicolon
macro_line|#endif
DECL|macro|PRINTF
mdefine_line|#define PRINTF(a,b,c)
multiline_comment|/*&n; * init event queue management&n; */
DECL|function|ev_init
r_void
id|ev_init
c_func
(paren
id|smc
)paren
r_struct
id|s_smc
op_star
id|smc
suffix:semicolon
(brace
id|smc-&gt;q.ev_put
op_assign
id|smc-&gt;q.ev_get
op_assign
id|smc-&gt;q.ev_queue
suffix:semicolon
)brace
multiline_comment|/*&n; * add event to queue&n; */
DECL|function|queue_event
r_void
id|queue_event
c_func
(paren
id|smc
comma
r_class
comma
id|event
)paren
r_struct
id|s_smc
op_star
id|smc
suffix:semicolon
r_int
r_class
suffix:semicolon
r_int
id|event
suffix:semicolon
(brace
id|PRINTF
c_func
(paren
l_string|&quot;queue class %d event %d&bslash;n&quot;
comma
r_class
comma
id|event
)paren
suffix:semicolon
id|smc-&gt;q.ev_put
op_member_access_from_pointer
r_class
op_assign
r_class
suffix:semicolon
id|smc-&gt;q.ev_put-&gt;event
op_assign
id|event
suffix:semicolon
r_if
c_cond
(paren
op_increment
id|smc-&gt;q.ev_put
op_eq
op_amp
id|smc-&gt;q.ev_queue
(braket
id|MAX_EVENT
)braket
)paren
id|smc-&gt;q.ev_put
op_assign
id|smc-&gt;q.ev_queue
suffix:semicolon
r_if
c_cond
(paren
id|smc-&gt;q.ev_put
op_eq
id|smc-&gt;q.ev_get
)paren
(brace
id|SMT_ERR_LOG
c_func
(paren
id|smc
comma
id|SMT_E0137
comma
id|SMT_E0137_MSG
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/*&n; * timer_event is called from HW timer package.&n; */
DECL|function|timer_event
r_void
id|timer_event
c_func
(paren
id|smc
comma
id|token
)paren
r_struct
id|s_smc
op_star
id|smc
suffix:semicolon
id|u_long
id|token
suffix:semicolon
(brace
id|PRINTF
c_func
(paren
l_string|&quot;timer event class %d token %d&bslash;n&quot;
comma
id|EV_T_CLASS
c_func
(paren
id|token
)paren
comma
id|EV_T_EVENT
c_func
(paren
id|token
)paren
)paren
suffix:semicolon
id|queue_event
c_func
(paren
id|smc
comma
id|EV_T_CLASS
c_func
(paren
id|token
)paren
comma
id|EV_T_EVENT
c_func
(paren
id|token
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * event dispatcher&n; *&t;while event queue is not empty&n; *&t;&t;get event from queue&n; *&t;&t;send command to state machine&n; *&t;end&n; */
DECL|function|ev_dispatcher
r_void
id|ev_dispatcher
c_func
(paren
id|smc
)paren
r_struct
id|s_smc
op_star
id|smc
suffix:semicolon
(brace
r_struct
id|event_queue
op_star
id|ev
suffix:semicolon
multiline_comment|/* pointer into queue */
r_int
r_class
suffix:semicolon
id|ev
op_assign
id|smc-&gt;q.ev_get
suffix:semicolon
id|PRINTF
c_func
(paren
l_string|&quot;dispatch get %x put %x&bslash;n&quot;
comma
id|ev
comma
id|smc-&gt;q.ev_put
)paren
suffix:semicolon
r_while
c_loop
(paren
id|ev
op_ne
id|smc-&gt;q.ev_put
)paren
(brace
id|PRINTF
c_func
(paren
l_string|&quot;dispatch class %d event %d&bslash;n&quot;
comma
id|ev
op_member_access_from_pointer
r_class
comma
id|ev-&gt;event
)paren
suffix:semicolon
r_switch
c_cond
(paren
r_class
op_assign
id|ev
op_member_access_from_pointer
r_class
)paren
(brace
r_case
id|EVENT_ECM
suffix:colon
multiline_comment|/* Entity Corordination  Man. */
id|ecm
c_func
(paren
id|smc
comma
(paren
r_int
)paren
id|ev-&gt;event
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|EVENT_CFM
suffix:colon
multiline_comment|/* Configuration Man. */
id|cfm
c_func
(paren
id|smc
comma
(paren
r_int
)paren
id|ev-&gt;event
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|EVENT_RMT
suffix:colon
multiline_comment|/* Ring Man. */
id|rmt
c_func
(paren
id|smc
comma
(paren
r_int
)paren
id|ev-&gt;event
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|EVENT_SMT
suffix:colon
id|smt_event
c_func
(paren
id|smc
comma
(paren
r_int
)paren
id|ev-&gt;event
)paren
suffix:semicolon
r_break
suffix:semicolon
macro_line|#ifdef&t;CONCENTRATOR
r_case
l_int|99
suffix:colon
id|timer_test_event
c_func
(paren
id|smc
comma
(paren
r_int
)paren
id|ev-&gt;event
)paren
suffix:semicolon
r_break
suffix:semicolon
macro_line|#endif
r_case
id|EVENT_PCMA
suffix:colon
multiline_comment|/* PHY A */
r_case
id|EVENT_PCMB
suffix:colon
multiline_comment|/* PHY B */
r_default
suffix:colon
r_if
c_cond
(paren
r_class
op_ge
id|EVENT_PCMA
op_logical_and
r_class
OL
id|EVENT_PCMA
op_plus
id|NUMPHYS
)paren
(brace
id|pcm
c_func
(paren
id|smc
comma
r_class
op_minus
id|EVENT_PCMA
comma
(paren
r_int
)paren
id|ev-&gt;event
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|SMT_PANIC
c_func
(paren
id|smc
comma
id|SMT_E0121
comma
id|SMT_E0121_MSG
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
op_increment
id|ev
op_eq
op_amp
id|smc-&gt;q.ev_queue
(braket
id|MAX_EVENT
)braket
)paren
id|ev
op_assign
id|smc-&gt;q.ev_queue
suffix:semicolon
multiline_comment|/* Renew get: it is used in queue_events to detect overruns */
id|smc-&gt;q.ev_get
op_assign
id|ev
suffix:semicolon
)brace
)brace
multiline_comment|/*&n; * smt_online connects to or disconnects from the ring&n; * MUST be called to initiate connection establishment&n; *&n; *&t;on&t;0&t;disconnect&n; *&t;on&t;1&t;connect&n; */
DECL|function|smt_online
id|u_short
id|smt_online
c_func
(paren
id|smc
comma
id|on
)paren
r_struct
id|s_smc
op_star
id|smc
suffix:semicolon
r_int
id|on
suffix:semicolon
(brace
id|queue_event
c_func
(paren
id|smc
comma
id|EVENT_ECM
comma
id|on
ques
c_cond
id|EC_CONNECT
suffix:colon
id|EC_DISCONNECT
)paren
suffix:semicolon
id|ev_dispatcher
c_func
(paren
id|smc
)paren
suffix:semicolon
r_return
(paren
id|smc-&gt;mib.fddiSMTCF_State
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * set SMT flag to value&n; *&t;flag&t;&t;flag name&n; *&t;value&t;&t;flag value&n; * dump current flag setting&n; */
macro_line|#ifdef&t;CONCENTRATOR
DECL|function|do_smt_flag
r_void
id|do_smt_flag
c_func
(paren
id|smc
comma
id|flag
comma
id|value
)paren
r_struct
id|s_smc
op_star
id|smc
suffix:semicolon
r_char
op_star
id|flag
suffix:semicolon
r_int
id|value
suffix:semicolon
(brace
macro_line|#ifdef&t;DEBUG
r_struct
id|smt_debug
op_star
id|deb
suffix:semicolon
id|SK_UNUSED
c_func
(paren
id|smc
)paren
suffix:semicolon
macro_line|#ifdef&t;DEBUG_BRD
id|deb
op_assign
op_amp
id|smc-&gt;debug
suffix:semicolon
macro_line|#else
id|deb
op_assign
op_amp
id|debug
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
op_logical_neg
id|strcmp
c_func
(paren
id|flag
comma
l_string|&quot;smt&quot;
)paren
)paren
id|deb-&gt;d_smt
op_assign
id|value
suffix:semicolon
r_else
r_if
c_cond
(paren
op_logical_neg
id|strcmp
c_func
(paren
id|flag
comma
l_string|&quot;smtf&quot;
)paren
)paren
id|deb-&gt;d_smtf
op_assign
id|value
suffix:semicolon
r_else
r_if
c_cond
(paren
op_logical_neg
id|strcmp
c_func
(paren
id|flag
comma
l_string|&quot;pcm&quot;
)paren
)paren
id|deb-&gt;d_pcm
op_assign
id|value
suffix:semicolon
r_else
r_if
c_cond
(paren
op_logical_neg
id|strcmp
c_func
(paren
id|flag
comma
l_string|&quot;rmt&quot;
)paren
)paren
id|deb-&gt;d_rmt
op_assign
id|value
suffix:semicolon
r_else
r_if
c_cond
(paren
op_logical_neg
id|strcmp
c_func
(paren
id|flag
comma
l_string|&quot;cfm&quot;
)paren
)paren
id|deb-&gt;d_cfm
op_assign
id|value
suffix:semicolon
r_else
r_if
c_cond
(paren
op_logical_neg
id|strcmp
c_func
(paren
id|flag
comma
l_string|&quot;ecm&quot;
)paren
)paren
id|deb-&gt;d_ecm
op_assign
id|value
suffix:semicolon
id|printf
c_func
(paren
l_string|&quot;smt&t;%d&bslash;n&quot;
comma
id|deb-&gt;d_smt
)paren
suffix:semicolon
id|printf
c_func
(paren
l_string|&quot;smtf&t;%d&bslash;n&quot;
comma
id|deb-&gt;d_smtf
)paren
suffix:semicolon
id|printf
c_func
(paren
l_string|&quot;pcm&t;%d&bslash;n&quot;
comma
id|deb-&gt;d_pcm
)paren
suffix:semicolon
id|printf
c_func
(paren
l_string|&quot;rmt&t;%d&bslash;n&quot;
comma
id|deb-&gt;d_rmt
)paren
suffix:semicolon
id|printf
c_func
(paren
l_string|&quot;cfm&t;%d&bslash;n&quot;
comma
id|deb-&gt;d_cfm
)paren
suffix:semicolon
id|printf
c_func
(paren
l_string|&quot;ecm&t;%d&bslash;n&quot;
comma
id|deb-&gt;d_ecm
)paren
suffix:semicolon
macro_line|#endif&t;/* DEBUG */
)brace
macro_line|#endif
eof
