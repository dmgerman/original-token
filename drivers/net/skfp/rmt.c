multiline_comment|/******************************************************************************&n; *&n; *&t;(C)Copyright 1998,1999 SysKonnect,&n; *&t;a business unit of Schneider &amp; Koch &amp; Co. Datensysteme GmbH.&n; *&n; *&t;See the file &quot;skfddi.c&quot; for further information.&n; *&n; *&t;This program is free software; you can redistribute it and/or modify&n; *&t;it under the terms of the GNU General Public License as published by&n; *&t;the Free Software Foundation; either version 2 of the License, or&n; *&t;(at your option) any later version.&n; *&n; *&t;The information in this file is provided &quot;AS IS&quot; without warranty.&n; *&n; ******************************************************************************/
multiline_comment|/*&n;&t;SMT RMT&n;&t;Ring Management&n;*/
multiline_comment|/*&n; * Hardware independant state machine implemantation&n; * The following external SMT functions are referenced :&n; *&n; * &t;&t;queue_event()&n; * &t;&t;smt_timer_start()&n; * &t;&t;smt_timer_stop()&n; *&n; * &t;The following external HW dependant functions are referenced :&n; *&t;&t;sm_ma_control()&n; *&t;&t;sm_mac_check_beacon_claim()&n; *&n; * &t;The following HW dependant events are required :&n; *&t;&t;RM_RING_OP&n; *&t;&t;RM_RING_NON_OP&n; *&t;&t;RM_MY_BEACON&n; *&t;&t;RM_OTHER_BEACON&n; *&t;&t;RM_MY_CLAIM&n; *&t;&t;RM_TRT_EXP&n; *&t;&t;RM_VALID_CLAIM&n; *&n; */
macro_line|#include &quot;h/types.h&quot;
macro_line|#include &quot;h/fddi.h&quot;
macro_line|#include &quot;h/smc.h&quot;
DECL|macro|KERNEL
mdefine_line|#define KERNEL
macro_line|#include &quot;h/smtstate.h&quot;
macro_line|#ifndef&t;lint
DECL|variable|ID_sccs
r_static
r_const
r_char
id|ID_sccs
(braket
)braket
op_assign
l_string|&quot;@(#)rmt.c&t;2.13 99/07/02 (C) SK &quot;
suffix:semicolon
macro_line|#endif
multiline_comment|/*&n; * FSM Macros&n; */
DECL|macro|AFLAG
mdefine_line|#define AFLAG&t;0x10
DECL|macro|GO_STATE
mdefine_line|#define GO_STATE(x)&t;(smc-&gt;mib.m[MAC0].fddiMACRMTState = (x)|AFLAG)
DECL|macro|ACTIONS_DONE
mdefine_line|#define ACTIONS_DONE()&t;(smc-&gt;mib.m[MAC0].fddiMACRMTState &amp;= ~AFLAG)
DECL|macro|ACTIONS
mdefine_line|#define ACTIONS(x)&t;(x|AFLAG)
DECL|macro|RM0_ISOLATED
mdefine_line|#define RM0_ISOLATED&t;0
DECL|macro|RM1_NON_OP
mdefine_line|#define RM1_NON_OP&t;1&t;&t;/* not operational */
DECL|macro|RM2_RING_OP
mdefine_line|#define RM2_RING_OP&t;2&t;&t;/* ring operational */
DECL|macro|RM3_DETECT
mdefine_line|#define RM3_DETECT&t;3&t;&t;/* detect dupl addresses */
DECL|macro|RM4_NON_OP_DUP
mdefine_line|#define RM4_NON_OP_DUP&t;4&t;&t;/* dupl. addr detected */
DECL|macro|RM5_RING_OP_DUP
mdefine_line|#define RM5_RING_OP_DUP&t;5&t;&t;/* ring oper. with dupl. addr */
DECL|macro|RM6_DIRECTED
mdefine_line|#define RM6_DIRECTED&t;6&t;&t;/* sending directed beacons */
DECL|macro|RM7_TRACE
mdefine_line|#define RM7_TRACE&t;7&t;&t;/* trace initiated */
macro_line|#ifdef&t;DEBUG
multiline_comment|/*&n; * symbolic state names&n; */
DECL|variable|rmt_states
r_static
r_const
r_char
op_star
r_const
id|rmt_states
(braket
)braket
op_assign
(brace
l_string|&quot;RM0_ISOLATED&quot;
comma
l_string|&quot;RM1_NON_OP&quot;
comma
l_string|&quot;RM2_RING_OP&quot;
comma
l_string|&quot;RM3_DETECT&quot;
comma
l_string|&quot;RM4_NON_OP_DUP&quot;
comma
l_string|&quot;RM5_RING_OP_DUP&quot;
comma
l_string|&quot;RM6_DIRECTED&quot;
comma
l_string|&quot;RM7_TRACE&quot;
)brace
suffix:semicolon
multiline_comment|/*&n; * symbolic event names&n; */
DECL|variable|rmt_events
r_static
r_const
r_char
op_star
r_const
id|rmt_events
(braket
)braket
op_assign
(brace
l_string|&quot;NONE&quot;
comma
l_string|&quot;RM_RING_OP&quot;
comma
l_string|&quot;RM_RING_NON_OP&quot;
comma
l_string|&quot;RM_MY_BEACON&quot;
comma
l_string|&quot;RM_OTHER_BEACON&quot;
comma
l_string|&quot;RM_MY_CLAIM&quot;
comma
l_string|&quot;RM_TRT_EXP&quot;
comma
l_string|&quot;RM_VALID_CLAIM&quot;
comma
l_string|&quot;RM_JOIN&quot;
comma
l_string|&quot;RM_LOOP&quot;
comma
l_string|&quot;RM_DUP_ADDR&quot;
comma
l_string|&quot;RM_ENABLE_FLAG&quot;
comma
l_string|&quot;RM_TIMEOUT_NON_OP&quot;
comma
l_string|&quot;RM_TIMEOUT_T_STUCK&quot;
comma
l_string|&quot;RM_TIMEOUT_ANNOUNCE&quot;
comma
l_string|&quot;RM_TIMEOUT_T_DIRECT&quot;
comma
l_string|&quot;RM_TIMEOUT_D_MAX&quot;
comma
l_string|&quot;RM_TIMEOUT_POLL&quot;
comma
l_string|&quot;RM_TX_STATE_CHANGE&quot;
)brace
suffix:semicolon
macro_line|#endif
multiline_comment|/*&n; * Globals&n; * in struct s_rmt&n; */
multiline_comment|/*&n; * function declarations&n; */
r_static
r_void
id|rmt_fsm
c_func
(paren
)paren
suffix:semicolon
r_static
r_void
id|start_rmt_timer0
c_func
(paren
)paren
suffix:semicolon
r_static
r_void
id|start_rmt_timer1
c_func
(paren
)paren
suffix:semicolon
r_static
r_void
id|start_rmt_timer2
c_func
(paren
)paren
suffix:semicolon
r_static
r_void
id|stop_rmt_timer0
c_func
(paren
)paren
suffix:semicolon
r_static
r_void
id|stop_rmt_timer1
c_func
(paren
)paren
suffix:semicolon
r_static
r_void
id|stop_rmt_timer2
c_func
(paren
)paren
suffix:semicolon
r_static
r_void
id|rmt_dup_actions
c_func
(paren
)paren
suffix:semicolon
r_static
r_void
id|rmt_reinsert_actions
c_func
(paren
)paren
suffix:semicolon
r_static
r_void
id|rmt_leave_actions
c_func
(paren
)paren
suffix:semicolon
r_static
r_void
id|rmt_new_dup_actions
c_func
(paren
)paren
suffix:semicolon
macro_line|#ifndef SUPERNET_3
r_extern
r_void
id|restart_trt_for_dbcn
c_func
(paren
)paren
suffix:semicolon
macro_line|#endif /*SUPERNET_3*/
multiline_comment|/*&n;&t;init RMT state machine&n;&t;clear all RMT vars and flags&n;*/
DECL|function|rmt_init
r_void
id|rmt_init
c_func
(paren
id|smc
)paren
r_struct
id|s_smc
op_star
id|smc
suffix:semicolon
(brace
id|smc-&gt;mib.m
(braket
id|MAC0
)braket
dot
id|fddiMACRMTState
op_assign
id|ACTIONS
c_func
(paren
id|RM0_ISOLATED
)paren
suffix:semicolon
id|smc-&gt;r.dup_addr_test
op_assign
id|DA_NONE
suffix:semicolon
id|smc-&gt;r.da_flag
op_assign
l_int|0
suffix:semicolon
id|smc-&gt;mib.m
(braket
id|MAC0
)braket
dot
id|fddiMACMA_UnitdataAvailable
op_assign
id|FALSE
suffix:semicolon
id|smc-&gt;r.sm_ma_avail
op_assign
id|FALSE
suffix:semicolon
id|smc-&gt;r.loop_avail
op_assign
l_int|0
suffix:semicolon
id|smc-&gt;r.bn_flag
op_assign
l_int|0
suffix:semicolon
id|smc-&gt;r.jm_flag
op_assign
l_int|0
suffix:semicolon
id|smc-&gt;r.no_flag
op_assign
id|TRUE
suffix:semicolon
)brace
multiline_comment|/*&n;&t;RMT state machine&n;&t;called by dispatcher&n;&n;&t;do&n;&t;&t;display state change&n;&t;&t;process event&n;&t;until SM is stable&n;*/
DECL|function|rmt
r_void
id|rmt
c_func
(paren
id|smc
comma
id|event
)paren
r_struct
id|s_smc
op_star
id|smc
suffix:semicolon
r_int
id|event
suffix:semicolon
(brace
r_int
id|state
suffix:semicolon
r_do
(brace
id|DB_RMT
c_func
(paren
l_string|&quot;RMT : state %s%s&quot;
comma
(paren
id|smc-&gt;mib.m
(braket
id|MAC0
)braket
dot
id|fddiMACRMTState
op_amp
id|AFLAG
)paren
ques
c_cond
l_string|&quot;ACTIONS &quot;
suffix:colon
l_string|&quot;&quot;
comma
id|rmt_states
(braket
id|smc-&gt;mib.m
(braket
id|MAC0
)braket
dot
id|fddiMACRMTState
op_amp
op_complement
id|AFLAG
)braket
)paren
suffix:semicolon
id|DB_RMT
c_func
(paren
l_string|&quot; event %s&bslash;n&quot;
comma
id|rmt_events
(braket
id|event
)braket
comma
l_int|0
)paren
suffix:semicolon
id|state
op_assign
id|smc-&gt;mib.m
(braket
id|MAC0
)braket
dot
id|fddiMACRMTState
suffix:semicolon
id|rmt_fsm
c_func
(paren
id|smc
comma
id|event
)paren
suffix:semicolon
id|event
op_assign
l_int|0
suffix:semicolon
)brace
r_while
c_loop
(paren
id|state
op_ne
id|smc-&gt;mib.m
(braket
id|MAC0
)braket
dot
id|fddiMACRMTState
)paren
suffix:semicolon
id|rmt_state_change
c_func
(paren
id|smc
comma
(paren
r_int
)paren
id|smc-&gt;mib.m
(braket
id|MAC0
)braket
dot
id|fddiMACRMTState
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;&t;process RMT event&n;*/
DECL|function|rmt_fsm
r_static
r_void
id|rmt_fsm
c_func
(paren
id|smc
comma
id|cmd
)paren
r_struct
id|s_smc
op_star
id|smc
suffix:semicolon
r_int
id|cmd
suffix:semicolon
(brace
multiline_comment|/*&n;&t; * RM00-RM70 : from all states&n;&t; */
r_if
c_cond
(paren
op_logical_neg
id|smc-&gt;r.rm_join
op_logical_and
op_logical_neg
id|smc-&gt;r.rm_loop
op_logical_and
id|smc-&gt;mib.m
(braket
id|MAC0
)braket
dot
id|fddiMACRMTState
op_ne
id|ACTIONS
c_func
(paren
id|RM0_ISOLATED
)paren
op_logical_and
id|smc-&gt;mib.m
(braket
id|MAC0
)braket
dot
id|fddiMACRMTState
op_ne
id|RM0_ISOLATED
)paren
(brace
id|RS_SET
c_func
(paren
id|smc
comma
id|RS_NORINGOP
)paren
suffix:semicolon
id|rmt_indication
c_func
(paren
id|smc
comma
l_int|0
)paren
suffix:semicolon
id|GO_STATE
c_func
(paren
id|RM0_ISOLATED
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_switch
c_cond
(paren
id|smc-&gt;mib.m
(braket
id|MAC0
)braket
dot
id|fddiMACRMTState
)paren
(brace
r_case
id|ACTIONS
c_func
(paren
id|RM0_ISOLATED
)paren
suffix:colon
id|stop_rmt_timer0
c_func
(paren
id|smc
)paren
suffix:semicolon
id|stop_rmt_timer1
c_func
(paren
id|smc
)paren
suffix:semicolon
id|stop_rmt_timer2
c_func
(paren
id|smc
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t; * Disable MAC.&n;&t;&t; */
id|sm_ma_control
c_func
(paren
id|smc
comma
id|MA_OFFLINE
)paren
suffix:semicolon
id|smc-&gt;mib.m
(braket
id|MAC0
)braket
dot
id|fddiMACMA_UnitdataAvailable
op_assign
id|FALSE
suffix:semicolon
id|smc-&gt;r.loop_avail
op_assign
id|FALSE
suffix:semicolon
id|smc-&gt;r.sm_ma_avail
op_assign
id|FALSE
suffix:semicolon
id|smc-&gt;r.no_flag
op_assign
id|TRUE
suffix:semicolon
id|DB_RMTN
c_func
(paren
l_int|1
comma
l_string|&quot;RMT : ISOLATED&bslash;n&quot;
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
id|ACTIONS_DONE
c_func
(paren
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|RM0_ISOLATED
suffix:colon
multiline_comment|/*RM01*/
r_if
c_cond
(paren
id|smc-&gt;r.rm_join
op_logical_or
id|smc-&gt;r.rm_loop
)paren
(brace
multiline_comment|/*&n;&t;&t;&t; * According to the standard the MAC must be reset&n;&t;&t;&t; * here. The FORMAC will be initialized and Claim&n;&t;&t;&t; * and Beacon Frames will be uploaded to the MAC.&n;&t;&t;&t; * So any change of Treq will take effect NOW.&n;&t;&t;&t; */
id|sm_ma_control
c_func
(paren
id|smc
comma
id|MA_RESET
)paren
suffix:semicolon
id|GO_STATE
c_func
(paren
id|RM1_NON_OP
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|ACTIONS
c_func
(paren
id|RM1_NON_OP
)paren
suffix:colon
id|start_rmt_timer0
c_func
(paren
id|smc
comma
id|smc-&gt;s.rmt_t_non_op
comma
id|RM_TIMEOUT_NON_OP
)paren
suffix:semicolon
id|stop_rmt_timer1
c_func
(paren
id|smc
)paren
suffix:semicolon
id|stop_rmt_timer2
c_func
(paren
id|smc
)paren
suffix:semicolon
id|sm_ma_control
c_func
(paren
id|smc
comma
id|MA_BEACON
)paren
suffix:semicolon
id|DB_RMTN
c_func
(paren
l_int|1
comma
l_string|&quot;RMT : RING DOWN&bslash;n&quot;
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
id|RS_SET
c_func
(paren
id|smc
comma
id|RS_NORINGOP
)paren
suffix:semicolon
id|smc-&gt;r.sm_ma_avail
op_assign
id|FALSE
suffix:semicolon
id|rmt_indication
c_func
(paren
id|smc
comma
l_int|0
)paren
suffix:semicolon
id|ACTIONS_DONE
c_func
(paren
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|RM1_NON_OP
suffix:colon
multiline_comment|/*RM12*/
r_if
c_cond
(paren
id|cmd
op_eq
id|RM_RING_OP
)paren
(brace
id|RS_SET
c_func
(paren
id|smc
comma
id|RS_RINGOPCHANGE
)paren
suffix:semicolon
id|GO_STATE
c_func
(paren
id|RM2_RING_OP
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
multiline_comment|/*RM13*/
r_else
r_if
c_cond
(paren
id|cmd
op_eq
id|RM_TIMEOUT_NON_OP
)paren
(brace
id|smc-&gt;r.bn_flag
op_assign
id|FALSE
suffix:semicolon
id|smc-&gt;r.no_flag
op_assign
id|TRUE
suffix:semicolon
id|GO_STATE
c_func
(paren
id|RM3_DETECT
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|ACTIONS
c_func
(paren
id|RM2_RING_OP
)paren
suffix:colon
id|stop_rmt_timer0
c_func
(paren
id|smc
)paren
suffix:semicolon
id|stop_rmt_timer1
c_func
(paren
id|smc
)paren
suffix:semicolon
id|stop_rmt_timer2
c_func
(paren
id|smc
)paren
suffix:semicolon
id|smc-&gt;r.no_flag
op_assign
id|FALSE
suffix:semicolon
r_if
c_cond
(paren
id|smc-&gt;r.rm_loop
)paren
id|smc-&gt;r.loop_avail
op_assign
id|TRUE
suffix:semicolon
r_if
c_cond
(paren
id|smc-&gt;r.rm_join
)paren
(brace
id|smc-&gt;r.sm_ma_avail
op_assign
id|TRUE
suffix:semicolon
r_if
c_cond
(paren
id|smc-&gt;mib.m
(braket
id|MAC0
)braket
dot
id|fddiMACMA_UnitdataEnable
)paren
id|smc-&gt;mib.m
(braket
id|MAC0
)braket
dot
id|fddiMACMA_UnitdataAvailable
op_assign
id|TRUE
suffix:semicolon
r_else
id|smc-&gt;mib.m
(braket
id|MAC0
)braket
dot
id|fddiMACMA_UnitdataAvailable
op_assign
id|FALSE
suffix:semicolon
)brace
id|DB_RMTN
c_func
(paren
l_int|1
comma
l_string|&quot;RMT : RING UP&bslash;n&quot;
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
id|RS_CLEAR
c_func
(paren
id|smc
comma
id|RS_NORINGOP
)paren
suffix:semicolon
id|RS_SET
c_func
(paren
id|smc
comma
id|RS_RINGOPCHANGE
)paren
suffix:semicolon
id|rmt_indication
c_func
(paren
id|smc
comma
l_int|1
)paren
suffix:semicolon
id|smt_stat_counter
c_func
(paren
id|smc
comma
l_int|0
)paren
suffix:semicolon
id|ACTIONS_DONE
c_func
(paren
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|RM2_RING_OP
suffix:colon
multiline_comment|/*RM21*/
r_if
c_cond
(paren
id|cmd
op_eq
id|RM_RING_NON_OP
)paren
(brace
id|smc-&gt;mib.m
(braket
id|MAC0
)braket
dot
id|fddiMACMA_UnitdataAvailable
op_assign
id|FALSE
suffix:semicolon
id|smc-&gt;r.loop_avail
op_assign
id|FALSE
suffix:semicolon
id|RS_SET
c_func
(paren
id|smc
comma
id|RS_RINGOPCHANGE
)paren
suffix:semicolon
id|GO_STATE
c_func
(paren
id|RM1_NON_OP
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
multiline_comment|/*RM22a*/
r_else
r_if
c_cond
(paren
id|cmd
op_eq
id|RM_ENABLE_FLAG
)paren
(brace
r_if
c_cond
(paren
id|smc-&gt;mib.m
(braket
id|MAC0
)braket
dot
id|fddiMACMA_UnitdataEnable
)paren
id|smc-&gt;mib.m
(braket
id|MAC0
)braket
dot
id|fddiMACMA_UnitdataAvailable
op_assign
id|TRUE
suffix:semicolon
r_else
id|smc-&gt;mib.m
(braket
id|MAC0
)braket
dot
id|fddiMACMA_UnitdataAvailable
op_assign
id|FALSE
suffix:semicolon
)brace
multiline_comment|/*RM25*/
r_else
r_if
c_cond
(paren
id|smc-&gt;r.dup_addr_test
op_eq
id|DA_FAILED
)paren
(brace
id|smc-&gt;mib.m
(braket
id|MAC0
)braket
dot
id|fddiMACMA_UnitdataAvailable
op_assign
id|FALSE
suffix:semicolon
id|smc-&gt;r.loop_avail
op_assign
id|FALSE
suffix:semicolon
id|smc-&gt;r.da_flag
op_assign
id|TRUE
suffix:semicolon
id|GO_STATE
c_func
(paren
id|RM5_RING_OP_DUP
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|ACTIONS
c_func
(paren
id|RM3_DETECT
)paren
suffix:colon
id|start_rmt_timer0
c_func
(paren
id|smc
comma
id|smc-&gt;s.mac_d_max
op_star
l_int|2
comma
id|RM_TIMEOUT_D_MAX
)paren
suffix:semicolon
id|start_rmt_timer1
c_func
(paren
id|smc
comma
id|smc-&gt;s.rmt_t_stuck
comma
id|RM_TIMEOUT_T_STUCK
)paren
suffix:semicolon
id|start_rmt_timer2
c_func
(paren
id|smc
comma
id|smc-&gt;s.rmt_t_poll
comma
id|RM_TIMEOUT_POLL
)paren
suffix:semicolon
id|sm_mac_check_beacon_claim
c_func
(paren
id|smc
)paren
suffix:semicolon
id|DB_RMTN
c_func
(paren
l_int|1
comma
l_string|&quot;RMT : RM3_DETECT&bslash;n&quot;
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
id|ACTIONS_DONE
c_func
(paren
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|RM3_DETECT
suffix:colon
r_if
c_cond
(paren
id|cmd
op_eq
id|RM_TIMEOUT_POLL
)paren
(brace
id|start_rmt_timer2
c_func
(paren
id|smc
comma
id|smc-&gt;s.rmt_t_poll
comma
id|RM_TIMEOUT_POLL
)paren
suffix:semicolon
id|sm_mac_check_beacon_claim
c_func
(paren
id|smc
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|cmd
op_eq
id|RM_TIMEOUT_D_MAX
)paren
(brace
id|smc-&gt;r.timer0_exp
op_assign
id|TRUE
suffix:semicolon
)brace
multiline_comment|/*&n;&t;&t; *jd(22-Feb-1999)&n;&t;&t; * We need a time &quot;&gt;= 2*mac_d_max&quot; since we had finished&n;&t;&t; * Claim or Beacon state. So we will restart timer0 at&n;&t;&t; * every state change.&n;&t;&t; */
r_if
c_cond
(paren
id|cmd
op_eq
id|RM_TX_STATE_CHANGE
)paren
(brace
id|start_rmt_timer0
c_func
(paren
id|smc
comma
id|smc-&gt;s.mac_d_max
op_star
l_int|2
comma
id|RM_TIMEOUT_D_MAX
)paren
suffix:semicolon
)brace
multiline_comment|/*RM32*/
r_if
c_cond
(paren
id|cmd
op_eq
id|RM_RING_OP
)paren
(brace
id|GO_STATE
c_func
(paren
id|RM2_RING_OP
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
multiline_comment|/*RM33a*/
r_else
r_if
c_cond
(paren
(paren
id|cmd
op_eq
id|RM_MY_BEACON
op_logical_or
id|cmd
op_eq
id|RM_OTHER_BEACON
)paren
op_logical_and
id|smc-&gt;r.bn_flag
)paren
(brace
id|smc-&gt;r.bn_flag
op_assign
id|FALSE
suffix:semicolon
)brace
multiline_comment|/*RM33b*/
r_else
r_if
c_cond
(paren
id|cmd
op_eq
id|RM_TRT_EXP
op_logical_and
op_logical_neg
id|smc-&gt;r.bn_flag
)paren
(brace
r_int
id|tx
suffix:semicolon
multiline_comment|/*&n;&t;&t;&t; * set bn_flag only if in state T4 or T5:&n;&t;&t;&t; * only if we&squot;re the beaconer should we start the&n;&t;&t;&t; * trace !&n;&t;&t;&t; */
r_if
c_cond
(paren
(paren
id|tx
op_assign
id|sm_mac_get_tx_state
c_func
(paren
id|smc
)paren
)paren
op_eq
l_int|4
op_logical_or
id|tx
op_eq
l_int|5
)paren
(brace
id|DB_RMTN
c_func
(paren
l_int|2
comma
l_string|&quot;RMT : DETECT &amp;&amp; TRT_EXPIRED &amp;&amp; T4/T5&bslash;n&quot;
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
id|smc-&gt;r.bn_flag
op_assign
id|TRUE
suffix:semicolon
multiline_comment|/*&n;&t;&t;&t;&t; * If one of the upstream stations beaconed&n;&t;&t;&t;&t; * and the link to the upstream neighbor is&n;&t;&t;&t;&t; * lost we need to restart the stuck timer to&n;&t;&t;&t;&t; * check the &quot;stuck beacon&quot; condition.&n;&t;&t;&t;&t; */
id|start_rmt_timer1
c_func
(paren
id|smc
comma
id|smc-&gt;s.rmt_t_stuck
comma
id|RM_TIMEOUT_T_STUCK
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;&t;&t;&t; * We do NOT need to clear smc-&gt;r.bn_flag in case of&n;&t;&t;&t; * not being in state T4 or T5, because the flag&n;&t;&t;&t; * must be cleared in order to get in this condition.&n;&t;&t;&t; */
id|DB_RMTN
c_func
(paren
l_int|2
comma
l_string|&quot;RMT : sm_mac_get_tx_state() = %d (bn_flag = %d)&bslash;n&quot;
comma
id|tx
comma
id|smc-&gt;r.bn_flag
)paren
suffix:semicolon
)brace
multiline_comment|/*RM34a*/
r_else
r_if
c_cond
(paren
id|cmd
op_eq
id|RM_MY_CLAIM
op_logical_and
id|smc-&gt;r.timer0_exp
)paren
(brace
id|rmt_new_dup_actions
c_func
(paren
id|smc
)paren
suffix:semicolon
id|GO_STATE
c_func
(paren
id|RM4_NON_OP_DUP
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
multiline_comment|/*RM34b*/
r_else
r_if
c_cond
(paren
id|cmd
op_eq
id|RM_MY_BEACON
op_logical_and
id|smc-&gt;r.timer0_exp
)paren
(brace
id|rmt_new_dup_actions
c_func
(paren
id|smc
)paren
suffix:semicolon
id|GO_STATE
c_func
(paren
id|RM4_NON_OP_DUP
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
multiline_comment|/*RM34c*/
r_else
r_if
c_cond
(paren
id|cmd
op_eq
id|RM_VALID_CLAIM
)paren
(brace
id|rmt_new_dup_actions
c_func
(paren
id|smc
)paren
suffix:semicolon
id|GO_STATE
c_func
(paren
id|RM4_NON_OP_DUP
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
multiline_comment|/*RM36*/
r_else
r_if
c_cond
(paren
id|cmd
op_eq
id|RM_TIMEOUT_T_STUCK
op_logical_and
id|smc-&gt;r.rm_join
op_logical_and
id|smc-&gt;r.bn_flag
)paren
(brace
id|GO_STATE
c_func
(paren
id|RM6_DIRECTED
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|ACTIONS
c_func
(paren
id|RM4_NON_OP_DUP
)paren
suffix:colon
id|start_rmt_timer0
c_func
(paren
id|smc
comma
id|smc-&gt;s.rmt_t_announce
comma
id|RM_TIMEOUT_ANNOUNCE
)paren
suffix:semicolon
id|start_rmt_timer1
c_func
(paren
id|smc
comma
id|smc-&gt;s.rmt_t_stuck
comma
id|RM_TIMEOUT_T_STUCK
)paren
suffix:semicolon
id|start_rmt_timer2
c_func
(paren
id|smc
comma
id|smc-&gt;s.rmt_t_poll
comma
id|RM_TIMEOUT_POLL
)paren
suffix:semicolon
id|sm_mac_check_beacon_claim
c_func
(paren
id|smc
)paren
suffix:semicolon
id|DB_RMTN
c_func
(paren
l_int|1
comma
l_string|&quot;RMT : RM4_NON_OP_DUP&bslash;n&quot;
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
id|ACTIONS_DONE
c_func
(paren
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|RM4_NON_OP_DUP
suffix:colon
r_if
c_cond
(paren
id|cmd
op_eq
id|RM_TIMEOUT_POLL
)paren
(brace
id|start_rmt_timer2
c_func
(paren
id|smc
comma
id|smc-&gt;s.rmt_t_poll
comma
id|RM_TIMEOUT_POLL
)paren
suffix:semicolon
id|sm_mac_check_beacon_claim
c_func
(paren
id|smc
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
multiline_comment|/*RM41*/
r_if
c_cond
(paren
op_logical_neg
id|smc-&gt;r.da_flag
)paren
(brace
id|GO_STATE
c_func
(paren
id|RM1_NON_OP
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
multiline_comment|/*RM44a*/
r_else
r_if
c_cond
(paren
(paren
id|cmd
op_eq
id|RM_MY_BEACON
op_logical_or
id|cmd
op_eq
id|RM_OTHER_BEACON
)paren
op_logical_and
id|smc-&gt;r.bn_flag
)paren
(brace
id|smc-&gt;r.bn_flag
op_assign
id|FALSE
suffix:semicolon
)brace
multiline_comment|/*RM44b*/
r_else
r_if
c_cond
(paren
id|cmd
op_eq
id|RM_TRT_EXP
op_logical_and
op_logical_neg
id|smc-&gt;r.bn_flag
)paren
(brace
r_int
id|tx
suffix:semicolon
multiline_comment|/*&n;&t;&t;&t; * set bn_flag only if in state T4 or T5:&n;&t;&t;&t; * only if we&squot;re the beaconer should we start the&n;&t;&t;&t; * trace !&n;&t;&t;&t; */
r_if
c_cond
(paren
(paren
id|tx
op_assign
id|sm_mac_get_tx_state
c_func
(paren
id|smc
)paren
)paren
op_eq
l_int|4
op_logical_or
id|tx
op_eq
l_int|5
)paren
(brace
id|DB_RMTN
c_func
(paren
l_int|2
comma
l_string|&quot;RMT : NOPDUP &amp;&amp; TRT_EXPIRED &amp;&amp; T4/T5&bslash;n&quot;
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
id|smc-&gt;r.bn_flag
op_assign
id|TRUE
suffix:semicolon
multiline_comment|/*&n;&t;&t;&t;&t; * If one of the upstream stations beaconed&n;&t;&t;&t;&t; * and the link to the upstream neighbor is&n;&t;&t;&t;&t; * lost we need to restart the stuck timer to&n;&t;&t;&t;&t; * check the &quot;stuck beacon&quot; condition.&n;&t;&t;&t;&t; */
id|start_rmt_timer1
c_func
(paren
id|smc
comma
id|smc-&gt;s.rmt_t_stuck
comma
id|RM_TIMEOUT_T_STUCK
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;&t;&t;&t; * We do NOT need to clear smc-&gt;r.bn_flag in case of&n;&t;&t;&t; * not being in state T4 or T5, because the flag&n;&t;&t;&t; * must be cleared in order to get in this condition.&n;&t;&t;&t; */
id|DB_RMTN
c_func
(paren
l_int|2
comma
l_string|&quot;RMT : sm_mac_get_tx_state() = %d (bn_flag = %d)&bslash;n&quot;
comma
id|tx
comma
id|smc-&gt;r.bn_flag
)paren
suffix:semicolon
)brace
multiline_comment|/*RM44c*/
r_else
r_if
c_cond
(paren
id|cmd
op_eq
id|RM_TIMEOUT_ANNOUNCE
op_logical_and
op_logical_neg
id|smc-&gt;r.bn_flag
)paren
(brace
id|rmt_dup_actions
c_func
(paren
id|smc
)paren
suffix:semicolon
)brace
multiline_comment|/*RM45*/
r_else
r_if
c_cond
(paren
id|cmd
op_eq
id|RM_RING_OP
)paren
(brace
id|smc-&gt;r.no_flag
op_assign
id|FALSE
suffix:semicolon
id|GO_STATE
c_func
(paren
id|RM5_RING_OP_DUP
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
multiline_comment|/*RM46*/
r_else
r_if
c_cond
(paren
id|cmd
op_eq
id|RM_TIMEOUT_T_STUCK
op_logical_and
id|smc-&gt;r.rm_join
op_logical_and
id|smc-&gt;r.bn_flag
)paren
(brace
id|GO_STATE
c_func
(paren
id|RM6_DIRECTED
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|ACTIONS
c_func
(paren
id|RM5_RING_OP_DUP
)paren
suffix:colon
id|stop_rmt_timer0
c_func
(paren
id|smc
)paren
suffix:semicolon
id|stop_rmt_timer1
c_func
(paren
id|smc
)paren
suffix:semicolon
id|stop_rmt_timer2
c_func
(paren
id|smc
)paren
suffix:semicolon
id|DB_RMTN
c_func
(paren
l_int|1
comma
l_string|&quot;RMT : RM5_RING_OP_DUP&bslash;n&quot;
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
id|ACTIONS_DONE
c_func
(paren
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|RM5_RING_OP_DUP
suffix:colon
multiline_comment|/*RM52*/
r_if
c_cond
(paren
id|smc-&gt;r.dup_addr_test
op_eq
id|DA_PASSED
)paren
(brace
id|smc-&gt;r.da_flag
op_assign
id|FALSE
suffix:semicolon
id|GO_STATE
c_func
(paren
id|RM2_RING_OP
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
multiline_comment|/*RM54*/
r_else
r_if
c_cond
(paren
id|cmd
op_eq
id|RM_RING_NON_OP
)paren
(brace
id|smc-&gt;r.jm_flag
op_assign
id|FALSE
suffix:semicolon
id|smc-&gt;r.bn_flag
op_assign
id|FALSE
suffix:semicolon
id|GO_STATE
c_func
(paren
id|RM4_NON_OP_DUP
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|ACTIONS
c_func
(paren
id|RM6_DIRECTED
)paren
suffix:colon
id|start_rmt_timer0
c_func
(paren
id|smc
comma
id|smc-&gt;s.rmt_t_direct
comma
id|RM_TIMEOUT_T_DIRECT
)paren
suffix:semicolon
id|stop_rmt_timer1
c_func
(paren
id|smc
)paren
suffix:semicolon
id|start_rmt_timer2
c_func
(paren
id|smc
comma
id|smc-&gt;s.rmt_t_poll
comma
id|RM_TIMEOUT_POLL
)paren
suffix:semicolon
id|sm_ma_control
c_func
(paren
id|smc
comma
id|MA_DIRECTED
)paren
suffix:semicolon
id|RS_SET
c_func
(paren
id|smc
comma
id|RS_BEACON
)paren
suffix:semicolon
id|DB_RMTN
c_func
(paren
l_int|1
comma
l_string|&quot;RMT : RM6_DIRECTED&bslash;n&quot;
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
id|ACTIONS_DONE
c_func
(paren
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|RM6_DIRECTED
suffix:colon
multiline_comment|/*RM63*/
r_if
c_cond
(paren
id|cmd
op_eq
id|RM_TIMEOUT_POLL
)paren
(brace
id|start_rmt_timer2
c_func
(paren
id|smc
comma
id|smc-&gt;s.rmt_t_poll
comma
id|RM_TIMEOUT_POLL
)paren
suffix:semicolon
id|sm_mac_check_beacon_claim
c_func
(paren
id|smc
)paren
suffix:semicolon
macro_line|#ifndef SUPERNET_3
multiline_comment|/* Because of problems with the Supernet II chip set&n;&t;&t;&t; * sending of Directed Beacon will stop after 165ms&n;&t;&t;&t; * therefore restart_trt_for_dbcn(smc) will be called&n;&t;&t;&t; * to prevent this.&n;&t;&t;&t; */
id|restart_trt_for_dbcn
c_func
(paren
id|smc
)paren
suffix:semicolon
macro_line|#endif /*SUPERNET_3*/
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|cmd
op_eq
id|RM_MY_BEACON
op_logical_or
id|cmd
op_eq
id|RM_OTHER_BEACON
)paren
op_logical_and
op_logical_neg
id|smc-&gt;r.da_flag
)paren
(brace
id|smc-&gt;r.bn_flag
op_assign
id|FALSE
suffix:semicolon
id|GO_STATE
c_func
(paren
id|RM3_DETECT
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
multiline_comment|/*RM64*/
r_else
r_if
c_cond
(paren
(paren
id|cmd
op_eq
id|RM_MY_BEACON
op_logical_or
id|cmd
op_eq
id|RM_OTHER_BEACON
)paren
op_logical_and
id|smc-&gt;r.da_flag
)paren
(brace
id|smc-&gt;r.bn_flag
op_assign
id|FALSE
suffix:semicolon
id|GO_STATE
c_func
(paren
id|RM4_NON_OP_DUP
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
multiline_comment|/*RM67*/
r_else
r_if
c_cond
(paren
id|cmd
op_eq
id|RM_TIMEOUT_T_DIRECT
)paren
(brace
id|GO_STATE
c_func
(paren
id|RM7_TRACE
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|ACTIONS
c_func
(paren
id|RM7_TRACE
)paren
suffix:colon
id|stop_rmt_timer0
c_func
(paren
id|smc
)paren
suffix:semicolon
id|stop_rmt_timer1
c_func
(paren
id|smc
)paren
suffix:semicolon
id|stop_rmt_timer2
c_func
(paren
id|smc
)paren
suffix:semicolon
id|smc-&gt;e.trace_prop
op_or_assign
id|ENTITY_BIT
c_func
(paren
id|ENTITY_MAC
)paren
suffix:semicolon
id|queue_event
c_func
(paren
id|smc
comma
id|EVENT_ECM
comma
id|EC_TRACE_PROP
)paren
suffix:semicolon
id|DB_RMTN
c_func
(paren
l_int|1
comma
l_string|&quot;RMT : RM7_TRACE&bslash;n&quot;
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
id|ACTIONS_DONE
c_func
(paren
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|RM7_TRACE
suffix:colon
r_break
suffix:semicolon
r_default
suffix:colon
id|SMT_PANIC
c_func
(paren
id|smc
comma
id|SMT_E0122
comma
id|SMT_E0122_MSG
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
multiline_comment|/*&n; * (jd) RMT duplicate address actions&n; * leave the ring or reinsert just as configured&n; */
DECL|function|rmt_dup_actions
r_static
r_void
id|rmt_dup_actions
c_func
(paren
id|smc
)paren
r_struct
id|s_smc
op_star
id|smc
suffix:semicolon
(brace
r_if
c_cond
(paren
id|smc-&gt;r.jm_flag
)paren
(brace
)brace
r_else
(brace
r_if
c_cond
(paren
id|smc-&gt;s.rmt_dup_mac_behavior
)paren
(brace
id|SMT_ERR_LOG
c_func
(paren
id|smc
comma
id|SMT_E0138
comma
id|SMT_E0138_MSG
)paren
suffix:semicolon
id|rmt_reinsert_actions
c_func
(paren
id|smc
)paren
suffix:semicolon
)brace
r_else
(brace
id|SMT_ERR_LOG
c_func
(paren
id|smc
comma
id|SMT_E0135
comma
id|SMT_E0135_MSG
)paren
suffix:semicolon
id|rmt_leave_actions
c_func
(paren
id|smc
)paren
suffix:semicolon
)brace
)brace
)brace
multiline_comment|/*&n; * Reconnect to the Ring&n; */
DECL|function|rmt_reinsert_actions
r_static
r_void
id|rmt_reinsert_actions
c_func
(paren
id|smc
)paren
r_struct
id|s_smc
op_star
id|smc
suffix:semicolon
(brace
id|queue_event
c_func
(paren
id|smc
comma
id|EVENT_ECM
comma
id|EC_DISCONNECT
)paren
suffix:semicolon
id|queue_event
c_func
(paren
id|smc
comma
id|EVENT_ECM
comma
id|EC_CONNECT
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * duplicate address detected&n; */
DECL|function|rmt_new_dup_actions
r_static
r_void
id|rmt_new_dup_actions
c_func
(paren
id|smc
)paren
r_struct
id|s_smc
op_star
id|smc
suffix:semicolon
(brace
id|smc-&gt;r.da_flag
op_assign
id|TRUE
suffix:semicolon
id|smc-&gt;r.bn_flag
op_assign
id|FALSE
suffix:semicolon
id|smc-&gt;r.jm_flag
op_assign
id|FALSE
suffix:semicolon
multiline_comment|/*&n;&t; * we have three options : change address, jam or leave&n;&t; * we leave the ring as default &n;&t; * Optionally it&squot;s possible to reinsert after leaving the Ring&n;&t; * but this will not conform with SMT Spec.&n;&t; */
r_if
c_cond
(paren
id|smc-&gt;s.rmt_dup_mac_behavior
)paren
(brace
id|SMT_ERR_LOG
c_func
(paren
id|smc
comma
id|SMT_E0138
comma
id|SMT_E0138_MSG
)paren
suffix:semicolon
id|rmt_reinsert_actions
c_func
(paren
id|smc
)paren
suffix:semicolon
)brace
r_else
(brace
id|SMT_ERR_LOG
c_func
(paren
id|smc
comma
id|SMT_E0135
comma
id|SMT_E0135_MSG
)paren
suffix:semicolon
id|rmt_leave_actions
c_func
(paren
id|smc
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/*&n; * leave the ring&n; */
DECL|function|rmt_leave_actions
r_static
r_void
id|rmt_leave_actions
c_func
(paren
id|smc
)paren
r_struct
id|s_smc
op_star
id|smc
suffix:semicolon
(brace
id|queue_event
c_func
(paren
id|smc
comma
id|EVENT_ECM
comma
id|EC_DISCONNECT
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Note: Do NOT try again later. (with please reconnect)&n;&t; * The station must be left from the ring!&n;&t; */
)brace
multiline_comment|/*&n; * SMT timer interface&n; *&t;start RMT timer 0&n; */
DECL|function|start_rmt_timer0
r_static
r_void
id|start_rmt_timer0
c_func
(paren
id|smc
comma
id|value
comma
id|event
)paren
r_struct
id|s_smc
op_star
id|smc
suffix:semicolon
id|u_long
id|value
suffix:semicolon
r_int
id|event
suffix:semicolon
(brace
id|smc-&gt;r.timer0_exp
op_assign
id|FALSE
suffix:semicolon
multiline_comment|/* clear timer event flag */
id|smt_timer_start
c_func
(paren
id|smc
comma
op_amp
id|smc-&gt;r.rmt_timer0
comma
id|value
comma
id|EV_TOKEN
c_func
(paren
id|EVENT_RMT
comma
id|event
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * SMT timer interface&n; *&t;start RMT timer 1&n; */
DECL|function|start_rmt_timer1
r_static
r_void
id|start_rmt_timer1
c_func
(paren
id|smc
comma
id|value
comma
id|event
)paren
r_struct
id|s_smc
op_star
id|smc
suffix:semicolon
id|u_long
id|value
suffix:semicolon
r_int
id|event
suffix:semicolon
(brace
id|smc-&gt;r.timer1_exp
op_assign
id|FALSE
suffix:semicolon
multiline_comment|/* clear timer event flag */
id|smt_timer_start
c_func
(paren
id|smc
comma
op_amp
id|smc-&gt;r.rmt_timer1
comma
id|value
comma
id|EV_TOKEN
c_func
(paren
id|EVENT_RMT
comma
id|event
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * SMT timer interface&n; *&t;start RMT timer 2&n; */
DECL|function|start_rmt_timer2
r_static
r_void
id|start_rmt_timer2
c_func
(paren
id|smc
comma
id|value
comma
id|event
)paren
r_struct
id|s_smc
op_star
id|smc
suffix:semicolon
id|u_long
id|value
suffix:semicolon
r_int
id|event
suffix:semicolon
(brace
id|smc-&gt;r.timer2_exp
op_assign
id|FALSE
suffix:semicolon
multiline_comment|/* clear timer event flag */
id|smt_timer_start
c_func
(paren
id|smc
comma
op_amp
id|smc-&gt;r.rmt_timer2
comma
id|value
comma
id|EV_TOKEN
c_func
(paren
id|EVENT_RMT
comma
id|event
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * SMT timer interface&n; *&t;stop RMT timer 0&n; */
DECL|function|stop_rmt_timer0
r_static
r_void
id|stop_rmt_timer0
c_func
(paren
id|smc
)paren
r_struct
id|s_smc
op_star
id|smc
suffix:semicolon
(brace
r_if
c_cond
(paren
id|smc-&gt;r.rmt_timer0.tm_active
)paren
id|smt_timer_stop
c_func
(paren
id|smc
comma
op_amp
id|smc-&gt;r.rmt_timer0
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * SMT timer interface&n; *&t;stop RMT timer 1&n; */
DECL|function|stop_rmt_timer1
r_static
r_void
id|stop_rmt_timer1
c_func
(paren
id|smc
)paren
r_struct
id|s_smc
op_star
id|smc
suffix:semicolon
(brace
r_if
c_cond
(paren
id|smc-&gt;r.rmt_timer1.tm_active
)paren
id|smt_timer_stop
c_func
(paren
id|smc
comma
op_amp
id|smc-&gt;r.rmt_timer1
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * SMT timer interface&n; *&t;stop RMT timer 2&n; */
DECL|function|stop_rmt_timer2
r_static
r_void
id|stop_rmt_timer2
c_func
(paren
id|smc
)paren
r_struct
id|s_smc
op_star
id|smc
suffix:semicolon
(brace
r_if
c_cond
(paren
id|smc-&gt;r.rmt_timer2.tm_active
)paren
id|smt_timer_stop
c_func
(paren
id|smc
comma
op_amp
id|smc-&gt;r.rmt_timer2
)paren
suffix:semicolon
)brace
eof
