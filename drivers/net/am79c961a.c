multiline_comment|/*&n; * linux/drivers/net/am79c961.c&n; *&n; * Derived from various things including skeleton.c&n; *&n; * R.M.King 1995.&n; */
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/fcntl.h&gt;
macro_line|#include &lt;linux/interrupt.h&gt;
macro_line|#include &lt;linux/ptrace.h&gt;
macro_line|#include &lt;linux/ioport.h&gt;
macro_line|#include &lt;linux/in.h&gt;
macro_line|#include &lt;linux/malloc.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/netdevice.h&gt;
macro_line|#include &lt;linux/etherdevice.h&gt;
macro_line|#include &lt;linux/skbuff.h&gt;
macro_line|#include &lt;asm/system.h&gt;
macro_line|#include &lt;asm/bitops.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/dma.h&gt;
macro_line|#include &lt;asm/ecard.h&gt;
macro_line|#include &lt;asm/delay.h&gt;
DECL|macro|TX_BUFFERS
mdefine_line|#define TX_BUFFERS 15
DECL|macro|RX_BUFFERS
mdefine_line|#define RX_BUFFERS 25
macro_line|#include &quot;am79c961a.h&quot;
DECL|variable|net_debug
r_static
r_int
r_int
id|net_debug
op_assign
id|NET_DEBUG
suffix:semicolon
r_static
r_void
id|am79c961_setmulticastlist
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
DECL|variable|version
r_static
r_char
op_star
id|version
op_assign
l_string|&quot;am79c961 ethernet driver (c) 1995 R.M.King v0.00&bslash;n&quot;
suffix:semicolon
DECL|macro|FUNC_PROLOGUE
mdefine_line|#define FUNC_PROLOGUE &bslash;&n;&t;struct dev_priv *priv = (struct dev_priv *)dev-&gt;priv
multiline_comment|/* --------------------------------------------------------------------------- */
r_static
r_void
DECL|function|write_rreg
id|write_rreg
(paren
r_int
r_int
id|base
comma
r_int
r_int
id|reg
comma
r_int
r_int
id|val
)paren
(brace
id|__asm__
(paren
"&quot;"
id|strh
op_mod
l_int|1
comma
(braket
op_mod
l_int|2
)braket
"@"
id|NET_RAP
id|strh
op_mod
l_int|0
comma
(braket
op_mod
l_int|2
comma
macro_line|#-4]&t;@ NET_RDP
l_string|&quot; : : &quot;
id|r
l_string|&quot; (val), &quot;
id|r
l_string|&quot; (reg), &quot;
id|r
"&quot;"
(paren
l_int|0xf0000464
)paren
)paren
suffix:semicolon
)brace
r_static
r_inline
r_void
DECL|function|write_ireg
id|write_ireg
(paren
r_int
r_int
id|base
comma
r_int
r_int
id|reg
comma
r_int
r_int
id|val
)paren
(brace
id|__asm__
(paren
"&quot;"
id|strh
op_mod
l_int|1
comma
(braket
op_mod
l_int|2
)braket
"@"
id|NET_RAP
id|strh
op_mod
l_int|0
comma
(braket
op_mod
l_int|2
comma
macro_line|#8]&t;@ NET_RDP
l_string|&quot; : : &quot;
id|r
l_string|&quot; (val), &quot;
id|r
l_string|&quot; (reg), &quot;
id|r
"&quot;"
(paren
l_int|0xf0000464
)paren
)paren
suffix:semicolon
)brace
DECL|macro|am_writeword
mdefine_line|#define am_writeword(dev,off,val)&bslash;&n;&t;__asm__(&quot;&bslash;&n;&t;&t;strh&t;%0, [%1]&bslash;&n;&t;&t;&quot; : : &quot;r&quot; ((val) &amp; 0xffff), &quot;r&quot; (0xe0000000 + ((off) &lt;&lt; 1)));
r_static
r_inline
r_void
DECL|function|am_writebuffer
id|am_writebuffer
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_int
r_int
id|offset
comma
r_int
r_char
op_star
id|buf
comma
r_int
r_int
id|length
)paren
(brace
id|offset
op_assign
l_int|0xe0000000
op_plus
(paren
id|offset
op_lshift
l_int|1
)paren
suffix:semicolon
id|length
op_assign
(paren
id|length
op_plus
l_int|1
)paren
op_amp
op_complement
l_int|1
suffix:semicolon
r_if
c_cond
(paren
(paren
r_int
)paren
id|buf
op_amp
l_int|2
)paren
(brace
id|__asm__
id|__volatile__
c_func
(paren
"&quot;"
id|strh
op_mod
l_int|2
comma
(braket
op_mod
l_int|0
)braket
comma
macro_line|#4
l_string|&quot; : &quot;
op_assign
op_amp
id|r
l_string|&quot; (offset) : &quot;
l_int|0
l_string|&quot; (offset), &quot;
id|r
"&quot;"
(paren
id|buf
(braket
l_int|0
)braket
op_or
(paren
id|buf
(braket
l_int|1
)braket
op_lshift
l_int|8
)paren
)paren
)paren
suffix:semicolon
id|buf
op_add_assign
l_int|2
suffix:semicolon
id|length
op_sub_assign
l_int|2
suffix:semicolon
)brace
r_while
c_loop
(paren
id|length
OG
l_int|8
)paren
(brace
r_int
r_int
id|tmp
comma
id|tmp2
suffix:semicolon
id|__asm__
id|__volatile__
c_func
(paren
"&quot;"
id|ldmia
op_mod
l_int|1
op_logical_neg
comma
(brace
op_mod
l_int|2
comma
op_mod
l_int|3
)brace
id|strh
op_mod
l_int|2
comma
(braket
op_mod
l_int|0
)braket
comma
macro_line|#4
id|mov
op_mod
l_int|2
comma
op_mod
l_int|2
comma
id|lsr
macro_line|#16
id|strh
op_mod
l_int|2
comma
(braket
op_mod
l_int|0
)braket
comma
macro_line|#4
id|strh
op_mod
l_int|3
comma
(braket
op_mod
l_int|0
)braket
comma
macro_line|#4
id|mov
op_mod
l_int|3
comma
op_mod
l_int|3
comma
id|lsr
macro_line|#16
id|strh
op_mod
l_int|3
comma
(braket
op_mod
l_int|0
)braket
comma
macro_line|#4
l_string|&quot; : &quot;
op_assign
op_amp
id|r
l_string|&quot; (offset), &quot;
op_assign
op_amp
id|r
l_string|&quot; (buf), &quot;
op_assign
id|r
l_string|&quot; (tmp), &quot;
op_assign
id|r
"&quot;"
(paren
id|tmp2
)paren
suffix:colon
l_string|&quot;0&quot;
(paren
id|offset
)paren
comma
l_string|&quot;1&quot;
(paren
id|buf
)paren
)paren
suffix:semicolon
id|length
op_sub_assign
l_int|8
suffix:semicolon
)brace
r_while
c_loop
(paren
id|length
OG
l_int|0
)paren
(brace
id|__asm__
id|__volatile__
c_func
(paren
"&quot;"
id|strh
op_mod
l_int|2
comma
(braket
op_mod
l_int|0
)braket
comma
macro_line|#4
l_string|&quot; : &quot;
op_assign
op_amp
id|r
l_string|&quot; (offset) : &quot;
l_int|0
l_string|&quot; (offset), &quot;
id|r
"&quot;"
(paren
id|buf
(braket
l_int|0
)braket
op_or
(paren
id|buf
(braket
l_int|1
)braket
op_lshift
l_int|8
)paren
)paren
)paren
suffix:semicolon
id|buf
op_add_assign
l_int|2
suffix:semicolon
id|length
op_sub_assign
l_int|2
suffix:semicolon
)brace
)brace
r_static
r_inline
r_int
r_int
DECL|function|read_rreg
id|read_rreg
(paren
r_int
r_int
id|base_addr
comma
r_int
r_int
id|reg
)paren
(brace
r_int
r_int
id|v
suffix:semicolon
id|__asm__
(paren
"&quot;"
id|strh
op_mod
l_int|1
comma
(braket
op_mod
l_int|2
)braket
"@"
id|NET_RAP
id|ldrh
op_mod
l_int|0
comma
(braket
op_mod
l_int|2
comma
macro_line|#-4]&t;@ NET_IDP
l_string|&quot; : &quot;
op_assign
id|r
l_string|&quot; (v): &quot;
id|r
l_string|&quot; (reg), &quot;
id|r
"&quot;"
(paren
l_int|0xf0000464
)paren
)paren
suffix:semicolon
r_return
id|v
suffix:semicolon
)brace
r_static
r_inline
r_int
r_int
DECL|function|am_readword
id|am_readword
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_int
r_int
id|off
)paren
(brace
r_int
r_int
id|address
op_assign
l_int|0xe0000000
op_plus
(paren
id|off
op_lshift
l_int|1
)paren
suffix:semicolon
r_int
r_int
id|val
suffix:semicolon
id|__asm__
c_func
(paren
"&quot;"
id|ldrh
op_mod
l_int|0
comma
(braket
op_mod
l_int|1
)braket
l_string|&quot; : &quot;
op_assign
id|r
l_string|&quot; (val): &quot;
id|r
"&quot;"
(paren
id|address
)paren
)paren
suffix:semicolon
r_return
id|val
suffix:semicolon
)brace
r_static
r_inline
r_void
DECL|function|am_readbuffer
id|am_readbuffer
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_int
r_int
id|offset
comma
r_int
r_char
op_star
id|buf
comma
r_int
r_int
id|length
)paren
(brace
id|offset
op_assign
l_int|0xe0000000
op_plus
(paren
id|offset
op_lshift
l_int|1
)paren
suffix:semicolon
id|length
op_assign
(paren
id|length
op_plus
l_int|1
)paren
op_amp
op_complement
l_int|1
suffix:semicolon
r_if
c_cond
(paren
(paren
r_int
)paren
id|buf
op_amp
l_int|2
)paren
(brace
r_int
r_int
id|tmp
suffix:semicolon
id|__asm__
id|__volatile__
c_func
(paren
"&quot;"
id|ldrh
op_mod
l_int|2
comma
(braket
op_mod
l_int|0
)braket
comma
macro_line|#4
id|strb
op_mod
l_int|2
comma
(braket
op_mod
l_int|1
)braket
comma
macro_line|#1
id|mov
op_mod
l_int|2
comma
op_mod
l_int|2
comma
id|lsr
macro_line|#8
id|strb
op_mod
l_int|2
comma
(braket
op_mod
l_int|1
)braket
comma
macro_line|#1
l_string|&quot; : &quot;
op_assign
op_amp
id|r
l_string|&quot; (offset), &quot;
op_assign
op_amp
id|r
l_string|&quot; (buf), &quot;
op_assign
id|r
l_string|&quot; (tmp): &quot;
l_int|0
l_string|&quot; (offset), &quot;
l_int|1
"&quot;"
(paren
id|buf
)paren
)paren
suffix:semicolon
id|length
op_sub_assign
l_int|2
suffix:semicolon
)brace
r_while
c_loop
(paren
id|length
OG
l_int|8
)paren
(brace
r_int
r_int
id|tmp
comma
id|tmp2
comma
id|tmp3
suffix:semicolon
id|__asm__
id|__volatile__
c_func
(paren
"&quot;"
id|ldrh
op_mod
l_int|2
comma
(braket
op_mod
l_int|0
)braket
comma
macro_line|#4
id|ldrh
op_mod
l_int|3
comma
(braket
op_mod
l_int|0
)braket
comma
macro_line|#4
id|orr
op_mod
l_int|2
comma
op_mod
l_int|2
comma
op_mod
l_int|3
comma
id|lsl
macro_line|#16
id|ldrh
op_mod
l_int|3
comma
(braket
op_mod
l_int|0
)braket
comma
macro_line|#4
id|ldrh
op_mod
l_int|4
comma
(braket
op_mod
l_int|0
)braket
comma
macro_line|#4
id|orr
op_mod
l_int|3
comma
op_mod
l_int|3
comma
op_mod
l_int|4
comma
id|lsl
macro_line|#16
id|stmia
op_mod
l_int|1
op_logical_neg
comma
(brace
op_mod
l_int|2
comma
op_mod
l_int|3
)brace
l_string|&quot; : &quot;
op_assign
op_amp
id|r
l_string|&quot; (offset), &quot;
op_assign
op_amp
id|r
l_string|&quot; (buf), &quot;
op_assign
id|r
l_string|&quot; (tmp), &quot;
op_assign
id|r
l_string|&quot; (tmp2), &quot;
op_assign
id|r
"&quot;"
(paren
id|tmp3
)paren
suffix:colon
l_string|&quot;0&quot;
(paren
id|offset
)paren
comma
l_string|&quot;1&quot;
(paren
id|buf
)paren
)paren
suffix:semicolon
id|length
op_sub_assign
l_int|8
suffix:semicolon
)brace
r_while
c_loop
(paren
id|length
OG
l_int|0
)paren
(brace
r_int
r_int
id|tmp
suffix:semicolon
id|__asm__
id|__volatile__
c_func
(paren
"&quot;"
id|ldrh
op_mod
l_int|2
comma
(braket
op_mod
l_int|0
)braket
comma
macro_line|#4
id|strb
op_mod
l_int|2
comma
(braket
op_mod
l_int|1
)braket
comma
macro_line|#1
id|mov
op_mod
l_int|2
comma
op_mod
l_int|2
comma
id|lsr
macro_line|#8
id|strb
op_mod
l_int|2
comma
(braket
op_mod
l_int|1
)braket
comma
macro_line|#1
l_string|&quot; : &quot;
op_assign
op_amp
id|r
l_string|&quot; (offset), &quot;
op_assign
op_amp
id|r
l_string|&quot; (buf), &quot;
op_assign
id|r
l_string|&quot; (tmp) : &quot;
l_int|0
l_string|&quot; (offset), &quot;
l_int|1
"&quot;"
(paren
id|buf
)paren
)paren
suffix:semicolon
id|length
op_sub_assign
l_int|2
suffix:semicolon
)brace
)brace
r_static
r_int
DECL|function|am79c961_ramtest
id|am79c961_ramtest
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_int
r_int
id|val
)paren
(brace
r_int
r_char
op_star
id|buffer
op_assign
id|kmalloc
(paren
l_int|65536
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_int
id|i
comma
id|error
op_assign
l_int|0
comma
id|errorcount
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|buffer
)paren
r_return
l_int|0
suffix:semicolon
id|memset
(paren
id|buffer
comma
id|val
comma
l_int|65536
)paren
suffix:semicolon
id|am_writebuffer
c_func
(paren
id|dev
comma
l_int|0
comma
id|buffer
comma
l_int|65536
)paren
suffix:semicolon
id|memset
(paren
id|buffer
comma
id|val
op_xor
l_int|255
comma
l_int|65536
)paren
suffix:semicolon
id|am_readbuffer
c_func
(paren
id|dev
comma
l_int|0
comma
id|buffer
comma
l_int|65536
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|65536
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|buffer
(braket
id|i
)braket
op_ne
id|val
op_logical_and
op_logical_neg
id|error
)paren
(brace
id|printk
(paren
l_string|&quot;%s: buffer error (%02X %02X) %05X - &quot;
comma
id|dev-&gt;name
comma
id|val
comma
id|buffer
(braket
id|i
)braket
comma
id|i
)paren
suffix:semicolon
id|error
op_assign
l_int|1
suffix:semicolon
id|errorcount
op_increment
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|error
op_logical_and
id|buffer
(braket
id|i
)braket
op_eq
id|val
)paren
(brace
id|printk
(paren
l_string|&quot;%05X&bslash;n&quot;
comma
id|i
)paren
suffix:semicolon
id|error
op_assign
l_int|0
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|error
)paren
id|printk
(paren
l_string|&quot;10000&bslash;n&quot;
)paren
suffix:semicolon
id|kfree
(paren
id|buffer
)paren
suffix:semicolon
r_return
id|errorcount
suffix:semicolon
)brace
r_static
r_void
DECL|function|am79c961_init_for_open
id|am79c961_init_for_open
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|dev_priv
op_star
id|priv
op_assign
(paren
r_struct
id|dev_priv
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_int
r_int
id|hdr_addr
comma
id|first_free_addr
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_int
r_char
op_star
id|p
suffix:semicolon
r_int
id|i
suffix:semicolon
id|save_flags_cli
(paren
id|flags
)paren
suffix:semicolon
id|write_ireg
(paren
id|dev-&gt;base_addr
comma
l_int|2
comma
l_int|0x4000
)paren
suffix:semicolon
multiline_comment|/* autoselect media */
id|write_rreg
(paren
id|dev-&gt;base_addr
comma
id|CSR0
comma
id|CSR0_BABL
op_or
id|CSR0_CERR
op_or
id|CSR0_MISS
op_or
id|CSR0_MERR
op_or
id|CSR0_TINT
op_or
id|CSR0_RINT
op_or
id|CSR0_STOP
)paren
suffix:semicolon
id|restore_flags
(paren
id|flags
)paren
suffix:semicolon
id|first_free_addr
op_assign
id|RX_BUFFERS
op_star
l_int|8
op_plus
id|TX_BUFFERS
op_star
l_int|8
op_plus
l_int|16
suffix:semicolon
id|hdr_addr
op_assign
l_int|0
suffix:semicolon
id|priv-&gt;rxhead
op_assign
l_int|0
suffix:semicolon
id|priv-&gt;rxtail
op_assign
l_int|0
suffix:semicolon
id|priv-&gt;rxhdr
op_assign
id|hdr_addr
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|RX_BUFFERS
suffix:semicolon
id|i
op_increment
)paren
(brace
id|priv-&gt;rxbuffer
(braket
id|i
)braket
op_assign
id|first_free_addr
suffix:semicolon
id|am_writeword
(paren
id|dev
comma
id|hdr_addr
comma
id|first_free_addr
)paren
suffix:semicolon
id|am_writeword
(paren
id|dev
comma
id|hdr_addr
op_plus
l_int|2
comma
id|RMD_OWN
)paren
suffix:semicolon
id|am_writeword
(paren
id|dev
comma
id|hdr_addr
op_plus
l_int|4
comma
(paren
op_minus
l_int|1600
)paren
)paren
suffix:semicolon
id|am_writeword
(paren
id|dev
comma
id|hdr_addr
op_plus
l_int|6
comma
l_int|0
)paren
suffix:semicolon
id|first_free_addr
op_add_assign
l_int|1600
suffix:semicolon
id|hdr_addr
op_add_assign
l_int|8
suffix:semicolon
)brace
id|priv-&gt;txhead
op_assign
l_int|0
suffix:semicolon
id|priv-&gt;txtail
op_assign
l_int|0
suffix:semicolon
id|priv-&gt;txhdr
op_assign
id|hdr_addr
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|TX_BUFFERS
suffix:semicolon
id|i
op_increment
)paren
(brace
id|priv-&gt;txbuffer
(braket
id|i
)braket
op_assign
id|first_free_addr
suffix:semicolon
id|am_writeword
(paren
id|dev
comma
id|hdr_addr
comma
id|first_free_addr
)paren
suffix:semicolon
id|am_writeword
(paren
id|dev
comma
id|hdr_addr
op_plus
l_int|2
comma
l_int|0
)paren
suffix:semicolon
id|am_writeword
(paren
id|dev
comma
id|hdr_addr
op_plus
l_int|4
comma
l_int|0
)paren
suffix:semicolon
id|am_writeword
(paren
id|dev
comma
id|hdr_addr
op_plus
l_int|6
comma
l_int|0
)paren
suffix:semicolon
id|first_free_addr
op_add_assign
l_int|1600
suffix:semicolon
id|hdr_addr
op_add_assign
l_int|8
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
id|LADRL
suffix:semicolon
id|i
op_le
id|LADRH
suffix:semicolon
id|i
op_increment
)paren
id|write_rreg
(paren
id|dev-&gt;base_addr
comma
id|i
comma
l_int|0
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
id|PADRL
comma
id|p
op_assign
id|dev-&gt;dev_addr
suffix:semicolon
id|i
op_le
id|PADRH
suffix:semicolon
id|i
op_increment
comma
id|p
op_add_assign
l_int|2
)paren
id|write_rreg
(paren
id|dev-&gt;base_addr
comma
id|i
comma
id|p
(braket
l_int|0
)braket
op_or
(paren
id|p
(braket
l_int|1
)braket
op_lshift
l_int|8
)paren
)paren
suffix:semicolon
id|i
op_assign
id|MODE_PORT0
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;flags
op_amp
id|IFF_PROMISC
)paren
id|i
op_or_assign
id|MODE_PROMISC
suffix:semicolon
id|write_rreg
(paren
id|dev-&gt;base_addr
comma
id|MODE
comma
id|i
)paren
suffix:semicolon
id|write_rreg
(paren
id|dev-&gt;base_addr
comma
id|BASERXL
comma
id|priv-&gt;rxhdr
)paren
suffix:semicolon
id|write_rreg
(paren
id|dev-&gt;base_addr
comma
id|BASERXH
comma
l_int|0
)paren
suffix:semicolon
id|write_rreg
(paren
id|dev-&gt;base_addr
comma
id|BASETXL
comma
id|priv-&gt;txhdr
)paren
suffix:semicolon
id|write_rreg
(paren
id|dev-&gt;base_addr
comma
id|BASERXH
comma
l_int|0
)paren
suffix:semicolon
id|write_rreg
(paren
id|dev-&gt;base_addr
comma
id|POLLINT
comma
l_int|0
)paren
suffix:semicolon
id|write_rreg
(paren
id|dev-&gt;base_addr
comma
id|SIZERXR
comma
op_minus
id|RX_BUFFERS
)paren
suffix:semicolon
id|write_rreg
(paren
id|dev-&gt;base_addr
comma
id|SIZETXR
comma
op_minus
id|TX_BUFFERS
)paren
suffix:semicolon
id|write_rreg
(paren
id|dev-&gt;base_addr
comma
id|CSR0
comma
id|CSR0_STOP
)paren
suffix:semicolon
id|write_rreg
(paren
id|dev-&gt;base_addr
comma
id|CSR3
comma
id|CSR3_IDONM
op_or
id|CSR3_BABLM
)paren
suffix:semicolon
id|write_rreg
(paren
id|dev-&gt;base_addr
comma
id|CSR0
comma
id|CSR0_IENA
op_or
id|CSR0_STRT
)paren
suffix:semicolon
)brace
r_static
r_int
DECL|function|am79c961_init
id|am79c961_init
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
id|am79c961_ramtest
c_func
(paren
id|dev
comma
l_int|0x66
)paren
suffix:semicolon
id|am79c961_ramtest
c_func
(paren
id|dev
comma
l_int|0x99
)paren
suffix:semicolon
id|save_flags_cli
(paren
id|flags
)paren
suffix:semicolon
id|write_ireg
(paren
id|dev-&gt;base_addr
comma
l_int|2
comma
l_int|0x4000
)paren
suffix:semicolon
multiline_comment|/* autoselect media */
id|write_rreg
(paren
id|dev-&gt;base_addr
comma
id|CSR0
comma
id|CSR0_STOP
)paren
suffix:semicolon
id|write_rreg
(paren
id|dev-&gt;base_addr
comma
id|CSR3
comma
id|CSR3_MASKALL
)paren
suffix:semicolon
id|restore_flags
(paren
id|flags
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * This is the real probe routine.&n; */
r_static
r_int
DECL|function|am79c961_probe1
id|am79c961_probe1
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_static
r_int
id|version_printed
op_assign
l_int|0
suffix:semicolon
r_struct
id|dev_priv
op_star
id|priv
suffix:semicolon
r_int
id|i
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dev-&gt;priv
)paren
(brace
id|dev-&gt;priv
op_assign
id|kmalloc
(paren
r_sizeof
(paren
r_struct
id|dev_priv
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dev-&gt;priv
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|priv
op_assign
(paren
r_struct
id|dev_priv
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|memset
(paren
id|priv
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|dev_priv
)paren
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * The PNP initialisation should have been done by the ether bootp loader.&n;&t; */
id|inb
(paren
(paren
id|dev-&gt;base_addr
op_plus
id|NET_RESET
)paren
op_rshift
l_int|1
)paren
suffix:semicolon
multiline_comment|/* reset the device */
id|udelay
(paren
l_int|5
)paren
suffix:semicolon
r_if
c_cond
(paren
id|inb
(paren
id|dev-&gt;base_addr
op_rshift
l_int|1
)paren
op_ne
l_int|0x08
op_logical_or
id|inb
(paren
(paren
id|dev-&gt;base_addr
op_rshift
l_int|1
)paren
op_plus
l_int|1
)paren
op_ne
l_int|00
op_logical_or
id|inb
(paren
(paren
id|dev-&gt;base_addr
op_rshift
l_int|1
)paren
op_plus
l_int|2
)paren
op_ne
l_int|0x2b
)paren
(brace
id|kfree
(paren
id|dev-&gt;priv
)paren
suffix:semicolon
id|dev-&gt;priv
op_assign
l_int|NULL
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * Ok, we&squot;ve found a valid hw ID&n;&t; */
r_if
c_cond
(paren
id|net_debug
op_logical_and
id|version_printed
op_increment
op_eq
l_int|0
)paren
id|printk
(paren
id|KERN_INFO
l_string|&quot;%s&quot;
comma
id|version
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: am79c961 found [%04lx, %d] &quot;
comma
id|dev-&gt;name
comma
id|dev-&gt;base_addr
comma
id|dev-&gt;irq
)paren
suffix:semicolon
id|request_region
(paren
id|dev-&gt;base_addr
comma
l_int|0x18
comma
l_string|&quot;am79c961&quot;
)paren
suffix:semicolon
multiline_comment|/* Retrive and print the ethernet address. */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|6
suffix:semicolon
id|i
op_increment
)paren
(brace
id|dev-&gt;dev_addr
(braket
id|i
)braket
op_assign
id|inb
(paren
(paren
id|dev-&gt;base_addr
op_rshift
l_int|1
)paren
op_plus
id|i
)paren
op_amp
l_int|0xff
suffix:semicolon
id|printk
(paren
id|i
op_eq
l_int|5
ques
c_cond
l_string|&quot;%02x&bslash;n&quot;
suffix:colon
l_string|&quot;%02x:&quot;
comma
id|dev-&gt;dev_addr
(braket
id|i
)braket
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|am79c961_init
c_func
(paren
id|dev
)paren
)paren
(brace
id|kfree
(paren
id|dev-&gt;priv
)paren
suffix:semicolon
id|dev-&gt;priv
op_assign
l_int|NULL
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
id|dev-&gt;open
op_assign
id|am79c961_open
suffix:semicolon
id|dev-&gt;stop
op_assign
id|am79c961_close
suffix:semicolon
id|dev-&gt;hard_start_xmit
op_assign
id|am79c961_sendpacket
suffix:semicolon
id|dev-&gt;get_stats
op_assign
id|am79c961_getstats
suffix:semicolon
id|dev-&gt;set_multicast_list
op_assign
id|am79c961_setmulticastlist
suffix:semicolon
multiline_comment|/* Fill in the fields of the device structure with ethernet values. */
id|ether_setup
c_func
(paren
id|dev
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_int
DECL|function|am79c961_probe
id|am79c961_probe
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_static
r_int
id|initialised
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|initialised
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
id|initialised
op_assign
l_int|1
suffix:semicolon
id|dev-&gt;base_addr
op_assign
l_int|0x220
suffix:semicolon
id|dev-&gt;irq
op_assign
l_int|3
suffix:semicolon
r_return
id|am79c961_probe1
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Open/initialize the board.  This is called (in the current kernel)&n; * sometime after booting when the &squot;ifconfig&squot; program is run.&n; *&n; * This routine should set everything up anew at each open, even&n; * registers that &quot;should&quot; only need to be set once at boot, so that&n; * there is non-reboot way to recover if something goes wrong.&n; */
r_static
r_int
DECL|function|am79c961_open
id|am79c961_open
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|dev_priv
op_star
id|priv
op_assign
(paren
r_struct
id|dev_priv
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|MOD_INC_USE_COUNT
suffix:semicolon
id|memset
(paren
op_amp
id|priv-&gt;stats
comma
l_int|0
comma
r_sizeof
(paren
id|priv-&gt;stats
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|request_irq
c_func
(paren
id|dev-&gt;irq
comma
id|am79c961_interrupt
comma
l_int|0
comma
l_string|&quot;am79c961&quot;
comma
id|dev
)paren
)paren
r_return
op_minus
id|EAGAIN
suffix:semicolon
id|am79c961_init_for_open
c_func
(paren
id|dev
)paren
suffix:semicolon
id|dev-&gt;tbusy
op_assign
l_int|0
suffix:semicolon
id|dev-&gt;interrupt
op_assign
l_int|0
suffix:semicolon
id|dev-&gt;start
op_assign
l_int|1
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * The inverse routine to am79c961_open().&n; */
r_static
r_int
DECL|function|am79c961_close
id|am79c961_close
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
id|dev-&gt;tbusy
op_assign
l_int|1
suffix:semicolon
id|dev-&gt;start
op_assign
l_int|0
suffix:semicolon
id|am79c961_init
c_func
(paren
id|dev
)paren
suffix:semicolon
id|free_irq
(paren
id|dev-&gt;irq
comma
id|dev
)paren
suffix:semicolon
id|MOD_DEC_USE_COUNT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * Get the current statistics.&t;This may be called with the card open or&n; * closed.&n; */
DECL|function|am79c961_getstats
r_static
r_struct
id|enet_statistics
op_star
id|am79c961_getstats
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|dev_priv
op_star
id|priv
op_assign
(paren
r_struct
id|dev_priv
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_return
op_amp
id|priv-&gt;stats
suffix:semicolon
)brace
multiline_comment|/*&n; * Set or clear promiscuous/multicast mode filter for this adaptor.&n; *&n; * We don&squot;t attempt any packet filtering.  The card may have a SEEQ 8004&n; * in which does not have the other ethernet address registers present...&n; */
DECL|function|am79c961_setmulticastlist
r_static
r_void
id|am79c961_setmulticastlist
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
r_int
id|i
suffix:semicolon
id|dev-&gt;flags
op_and_assign
op_complement
id|IFF_ALLMULTI
suffix:semicolon
id|i
op_assign
id|MODE_PORT0
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;flags
op_amp
id|IFF_PROMISC
)paren
id|i
op_or_assign
id|MODE_PROMISC
suffix:semicolon
id|save_flags_cli
(paren
id|flags
)paren
suffix:semicolon
id|write_rreg
(paren
id|dev-&gt;base_addr
comma
id|MODE
comma
id|i
)paren
suffix:semicolon
id|restore_flags
(paren
id|flags
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Transmit a packet&n; */
r_static
r_int
DECL|function|am79c961_sendpacket
id|am79c961_sendpacket
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|dev_priv
op_star
id|priv
op_assign
(paren
r_struct
id|dev_priv
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dev-&gt;tbusy
)paren
(brace
id|again
suffix:colon
r_if
c_cond
(paren
op_logical_neg
id|test_and_set_bit
c_func
(paren
l_int|0
comma
(paren
r_void
op_star
)paren
op_amp
id|dev-&gt;tbusy
)paren
)paren
(brace
r_int
r_int
id|length
op_assign
id|ETH_ZLEN
OL
id|skb-&gt;len
ques
c_cond
id|skb-&gt;len
suffix:colon
id|ETH_ZLEN
suffix:semicolon
r_int
r_int
id|hdraddr
comma
id|bufaddr
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|hdraddr
op_assign
id|priv-&gt;txhdr
op_plus
(paren
id|priv-&gt;txhead
op_lshift
l_int|3
)paren
suffix:semicolon
id|bufaddr
op_assign
id|priv-&gt;txbuffer
(braket
id|priv-&gt;txhead
)braket
suffix:semicolon
id|priv-&gt;txhead
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|priv-&gt;txhead
op_ge
id|TX_BUFFERS
)paren
id|priv-&gt;txhead
op_assign
l_int|0
suffix:semicolon
id|am_writebuffer
(paren
id|dev
comma
id|bufaddr
comma
id|skb-&gt;data
comma
id|length
)paren
suffix:semicolon
id|am_writeword
(paren
id|dev
comma
id|hdraddr
op_plus
l_int|4
comma
op_minus
id|length
)paren
suffix:semicolon
id|am_writeword
(paren
id|dev
comma
id|hdraddr
op_plus
l_int|2
comma
id|TMD_OWN
op_or
id|TMD_STP
op_or
id|TMD_ENP
)paren
suffix:semicolon
id|save_flags_cli
(paren
id|flags
)paren
suffix:semicolon
id|write_rreg
(paren
id|dev-&gt;base_addr
comma
id|CSR0
comma
id|CSR0_TDMD
op_or
id|CSR0_IENA
)paren
suffix:semicolon
id|dev-&gt;trans_start
op_assign
id|jiffies
suffix:semicolon
id|restore_flags
(paren
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|am_readword
(paren
id|dev
comma
id|priv-&gt;txhdr
op_plus
(paren
id|priv-&gt;txhead
op_lshift
l_int|3
)paren
op_plus
l_int|2
)paren
op_amp
id|TMD_OWN
)paren
)paren
id|dev-&gt;tbusy
op_assign
l_int|0
suffix:semicolon
id|dev_kfree_skb
(paren
id|skb
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_else
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: Transmitter access conflict.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
r_else
(brace
r_int
id|tickssofar
op_assign
id|jiffies
op_minus
id|dev-&gt;trans_start
suffix:semicolon
r_if
c_cond
(paren
id|tickssofar
OL
l_int|5
)paren
r_return
l_int|1
suffix:semicolon
id|printk
(paren
id|KERN_WARNING
l_string|&quot;%s: transmit timed out, network cable problem?&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
multiline_comment|/* Try to restart the adaptor. */
id|dev-&gt;tbusy
op_assign
l_int|0
suffix:semicolon
id|dev-&gt;trans_start
op_assign
id|jiffies
suffix:semicolon
r_goto
id|again
suffix:semicolon
)brace
)brace
r_static
r_void
DECL|function|am79c961_interrupt
id|am79c961_interrupt
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_struct
id|net_device
op_star
id|dev
op_assign
(paren
r_struct
id|net_device
op_star
)paren
id|dev_id
suffix:semicolon
r_struct
id|dev_priv
op_star
id|priv
op_assign
(paren
r_struct
id|dev_priv
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_int
r_int
id|status
suffix:semicolon
macro_line|#if NET_DEBUG &gt; 1
r_if
c_cond
(paren
id|net_debug
op_amp
id|DEBUG_INT
)paren
(brace
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;am79c961irq: %d &quot;
comma
id|irq
)paren
suffix:semicolon
)brace
macro_line|#endif
id|dev-&gt;interrupt
op_assign
l_int|1
suffix:semicolon
id|status
op_assign
id|read_rreg
(paren
id|dev-&gt;base_addr
comma
id|CSR0
)paren
suffix:semicolon
id|write_rreg
(paren
id|dev-&gt;base_addr
comma
id|CSR0
comma
id|status
op_amp
(paren
id|CSR0_TINT
op_or
id|CSR0_RINT
op_or
id|CSR0_MISS
op_or
id|CSR0_IENA
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
id|CSR0_RINT
)paren
multiline_comment|/* Got a packet(s). */
id|am79c961_rx
(paren
id|dev
comma
id|priv
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
id|CSR0_TINT
)paren
multiline_comment|/* Packets transmitted */
id|am79c961_tx
(paren
id|dev
comma
id|priv
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
id|CSR0_MISS
)paren
id|priv-&gt;stats.rx_dropped
op_increment
suffix:semicolon
id|dev-&gt;interrupt
op_assign
l_int|0
suffix:semicolon
macro_line|#if NET_DEBUG &gt; 1
r_if
c_cond
(paren
id|net_debug
op_amp
id|DEBUG_INT
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;done&bslash;n&quot;
)paren
suffix:semicolon
)brace
macro_line|#endif
)brace
multiline_comment|/*&n; * If we have a good packet(s), get it/them out of the buffers.&n; */
r_static
r_void
DECL|function|am79c961_rx
id|am79c961_rx
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_struct
id|dev_priv
op_star
id|priv
)paren
(brace
r_int
r_int
id|hdraddr
suffix:semicolon
r_int
r_int
id|pktaddr
suffix:semicolon
r_do
(brace
r_int
r_int
id|status
suffix:semicolon
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
r_int
id|len
suffix:semicolon
id|hdraddr
op_assign
id|priv-&gt;rxhdr
op_plus
(paren
id|priv-&gt;rxtail
op_lshift
l_int|3
)paren
suffix:semicolon
id|pktaddr
op_assign
id|priv-&gt;rxbuffer
(braket
id|priv-&gt;rxtail
)braket
suffix:semicolon
id|status
op_assign
id|am_readword
(paren
id|dev
comma
id|hdraddr
op_plus
l_int|2
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
id|RMD_OWN
)paren
multiline_comment|/* do we own it? */
r_break
suffix:semicolon
id|priv-&gt;rxtail
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|priv-&gt;rxtail
op_ge
id|RX_BUFFERS
)paren
id|priv-&gt;rxtail
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
(paren
id|status
op_amp
(paren
id|RMD_ERR
op_or
id|RMD_STP
op_or
id|RMD_ENP
)paren
)paren
op_ne
(paren
id|RMD_STP
op_or
id|RMD_ENP
)paren
)paren
(brace
id|am_writeword
(paren
id|dev
comma
id|hdraddr
op_plus
l_int|2
comma
id|RMD_OWN
)paren
suffix:semicolon
id|priv-&gt;stats.rx_errors
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
id|RMD_ERR
)paren
(brace
r_if
c_cond
(paren
id|status
op_amp
id|RMD_FRAM
)paren
id|priv-&gt;stats.rx_frame_errors
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
id|RMD_CRC
)paren
id|priv-&gt;stats.rx_crc_errors
op_increment
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|status
op_amp
id|RMD_STP
)paren
id|priv-&gt;stats.rx_length_errors
op_increment
suffix:semicolon
r_continue
suffix:semicolon
)brace
id|len
op_assign
id|am_readword
(paren
id|dev
comma
id|hdraddr
op_plus
l_int|6
)paren
suffix:semicolon
id|skb
op_assign
id|dev_alloc_skb
(paren
id|len
op_plus
l_int|2
)paren
suffix:semicolon
r_if
c_cond
(paren
id|skb
)paren
(brace
r_int
r_char
op_star
id|buf
suffix:semicolon
id|skb-&gt;dev
op_assign
id|dev
suffix:semicolon
id|skb_reserve
(paren
id|skb
comma
l_int|2
)paren
suffix:semicolon
id|buf
op_assign
id|skb_put
(paren
id|skb
comma
id|len
)paren
suffix:semicolon
id|am_readbuffer
(paren
id|dev
comma
id|pktaddr
comma
id|buf
comma
id|len
)paren
suffix:semicolon
id|am_writeword
(paren
id|dev
comma
id|hdraddr
op_plus
l_int|2
comma
id|RMD_OWN
)paren
suffix:semicolon
id|skb-&gt;protocol
op_assign
id|eth_type_trans
c_func
(paren
id|skb
comma
id|dev
)paren
suffix:semicolon
id|netif_rx
(paren
id|skb
)paren
suffix:semicolon
id|priv-&gt;stats.rx_packets
op_increment
suffix:semicolon
)brace
r_else
(brace
id|am_writeword
(paren
id|dev
comma
id|hdraddr
op_plus
l_int|2
comma
id|RMD_OWN
)paren
suffix:semicolon
id|printk
(paren
id|KERN_WARNING
l_string|&quot;%s: memory squeeze, dropping packet.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|priv-&gt;stats.rx_dropped
op_increment
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
r_while
c_loop
(paren
l_int|1
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Update stats for the transmitted packet&n; */
r_static
r_void
DECL|function|am79c961_tx
id|am79c961_tx
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_struct
id|dev_priv
op_star
id|priv
)paren
(brace
r_do
(brace
r_int
r_int
id|hdraddr
suffix:semicolon
r_int
r_int
id|status
suffix:semicolon
id|hdraddr
op_assign
id|priv-&gt;txhdr
op_plus
(paren
id|priv-&gt;txtail
op_lshift
l_int|3
)paren
suffix:semicolon
id|status
op_assign
id|am_readword
(paren
id|dev
comma
id|hdraddr
op_plus
l_int|2
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
id|TMD_OWN
)paren
r_break
suffix:semicolon
id|priv-&gt;txtail
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|priv-&gt;txtail
op_ge
id|TX_BUFFERS
)paren
id|priv-&gt;txtail
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
id|TMD_ERR
)paren
(brace
r_int
r_int
id|status2
suffix:semicolon
id|priv-&gt;stats.tx_errors
op_increment
suffix:semicolon
id|status2
op_assign
id|am_readword
(paren
id|dev
comma
id|hdraddr
op_plus
l_int|6
)paren
suffix:semicolon
id|am_writeword
(paren
id|dev
comma
id|hdraddr
op_plus
l_int|6
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status2
op_amp
id|TST_RTRY
)paren
id|priv-&gt;stats.collisions
op_add_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|status2
op_amp
id|TST_LCOL
)paren
id|priv-&gt;stats.tx_window_errors
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|status2
op_amp
id|TST_LCAR
)paren
id|priv-&gt;stats.tx_carrier_errors
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|status2
op_amp
id|TST_UFLO
)paren
id|priv-&gt;stats.tx_fifo_errors
op_increment
suffix:semicolon
r_continue
suffix:semicolon
)brace
id|priv-&gt;stats.tx_packets
op_increment
suffix:semicolon
)brace
r_while
c_loop
(paren
id|priv-&gt;txtail
op_ne
id|priv-&gt;txhead
)paren
suffix:semicolon
id|dev-&gt;tbusy
op_assign
l_int|0
suffix:semicolon
id|mark_bh
(paren
id|NET_BH
)paren
suffix:semicolon
)brace
eof
