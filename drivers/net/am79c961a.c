multiline_comment|/*&n; *  linux/drivers/net/am79c961.c&n; *&n; *  by Russell King &lt;rmk@arm.linux.org.uk&gt; 1995-2000.&n; *&n; * This program is free software; you can redistribute it and/or modify&n; * it under the terms of the GNU General Public License version 2 as&n; * published by the Free Software Foundation.&n; *&n; * Derived from various things including skeleton.c&n; *&n; * This is a special driver for the am79c961A Lance chip used in the&n; * Intel (formally Digital Equipment Corp) EBSA110 platform.&n; */
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/fcntl.h&gt;
macro_line|#include &lt;linux/interrupt.h&gt;
macro_line|#include &lt;linux/ptrace.h&gt;
macro_line|#include &lt;linux/ioport.h&gt;
macro_line|#include &lt;linux/in.h&gt;
macro_line|#include &lt;linux/malloc.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/netdevice.h&gt;
macro_line|#include &lt;linux/etherdevice.h&gt;
macro_line|#include &lt;linux/skbuff.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;asm/system.h&gt;
macro_line|#include &lt;asm/bitops.h&gt;
macro_line|#include &lt;asm/irq.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/dma.h&gt;
macro_line|#include &lt;asm/ecard.h&gt;
DECL|macro|TX_BUFFERS
mdefine_line|#define TX_BUFFERS 15
DECL|macro|RX_BUFFERS
mdefine_line|#define RX_BUFFERS 25
macro_line|#include &quot;am79c961a.h&quot;
r_static
r_void
id|am79c961_interrupt
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
suffix:semicolon
DECL|variable|net_debug
r_static
r_int
r_int
id|net_debug
op_assign
id|NET_DEBUG
suffix:semicolon
DECL|variable|version
r_static
r_char
op_star
id|version
op_assign
l_string|&quot;am79c961 ethernet driver (c) 1995 R.M.King v0.02&bslash;n&quot;
suffix:semicolon
multiline_comment|/* --------------------------------------------------------------------------- */
macro_line|#ifdef __arm__
r_static
r_void
DECL|function|write_rreg
id|write_rreg
(paren
r_int
r_int
id|base
comma
r_int
r_int
id|reg
comma
r_int
r_int
id|val
)paren
(brace
id|__asm__
(paren
"&quot;"
id|str
op_mod
ques
c_cond
id|h
op_mod
l_int|1
comma
(braket
op_mod
l_int|2
)braket
"@"
id|NET_RAP
id|str
op_mod
ques
c_cond
id|h
op_mod
l_int|0
comma
(braket
op_mod
l_int|2
comma
macro_line|#-4]&t;@ NET_RDP
l_string|&quot; : : &quot;
id|r
l_string|&quot; (val), &quot;
id|r
l_string|&quot; (reg), &quot;
id|r
"&quot;"
(paren
l_int|0xf0000464
)paren
)paren
suffix:semicolon
)brace
r_static
r_inline
r_int
r_int
DECL|function|read_rreg
id|read_rreg
(paren
r_int
r_int
id|base_addr
comma
r_int
r_int
id|reg
)paren
(brace
r_int
r_int
id|v
suffix:semicolon
id|__asm__
(paren
"&quot;"
id|str
op_mod
ques
c_cond
id|h
op_mod
l_int|1
comma
(braket
op_mod
l_int|2
)braket
"@"
id|NET_RAP
id|ldr
op_mod
ques
c_cond
id|h
op_mod
l_int|0
comma
(braket
op_mod
l_int|2
comma
macro_line|#-4]&t;@ NET_RDP
l_string|&quot; : &quot;
op_assign
id|r
l_string|&quot; (v): &quot;
id|r
l_string|&quot; (reg), &quot;
id|r
"&quot;"
(paren
l_int|0xf0000464
)paren
)paren
suffix:semicolon
r_return
id|v
suffix:semicolon
)brace
r_static
r_inline
r_void
DECL|function|write_ireg
id|write_ireg
(paren
r_int
r_int
id|base
comma
r_int
r_int
id|reg
comma
r_int
r_int
id|val
)paren
(brace
id|__asm__
(paren
"&quot;"
id|str
op_mod
ques
c_cond
id|h
op_mod
l_int|1
comma
(braket
op_mod
l_int|2
)braket
"@"
id|NET_RAP
id|str
op_mod
ques
c_cond
id|h
op_mod
l_int|0
comma
(braket
op_mod
l_int|2
comma
macro_line|#8]&t;@ NET_IDP
l_string|&quot; : : &quot;
id|r
l_string|&quot; (val), &quot;
id|r
l_string|&quot; (reg), &quot;
id|r
"&quot;"
(paren
l_int|0xf0000464
)paren
)paren
suffix:semicolon
)brace
DECL|macro|am_writeword
mdefine_line|#define am_writeword(dev,off,val)&bslash;&n;&t;__asm__(&quot;str%?h&t;%0, [%1]&quot; : : &bslash;&n;&t;&t;&quot;r&quot; ((val) &amp; 0xffff), &quot;r&quot; (0xe0000000 + ((off) &lt;&lt; 1)));
r_static
r_inline
r_void
DECL|function|am_writebuffer
id|am_writebuffer
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
id|u_int
id|offset
comma
r_int
r_char
op_star
id|buf
comma
r_int
r_int
id|length
)paren
(brace
id|offset
op_assign
l_int|0xe0000000
op_plus
(paren
id|offset
op_lshift
l_int|1
)paren
suffix:semicolon
id|length
op_assign
(paren
id|length
op_plus
l_int|1
)paren
op_amp
op_complement
l_int|1
suffix:semicolon
r_if
c_cond
(paren
(paren
r_int
)paren
id|buf
op_amp
l_int|2
)paren
(brace
id|__asm__
id|__volatile__
c_func
(paren
l_string|&quot;str%?h&t;%2, [%0], #4&quot;
suffix:colon
l_string|&quot;=&amp;r&quot;
(paren
id|offset
)paren
suffix:colon
l_string|&quot;0&quot;
(paren
id|offset
)paren
comma
l_string|&quot;r&quot;
(paren
id|buf
(braket
l_int|0
)braket
op_or
(paren
id|buf
(braket
l_int|1
)braket
op_lshift
l_int|8
)paren
)paren
)paren
suffix:semicolon
id|buf
op_add_assign
l_int|2
suffix:semicolon
id|length
op_sub_assign
l_int|2
suffix:semicolon
)brace
r_while
c_loop
(paren
id|length
OG
l_int|8
)paren
(brace
r_int
r_int
id|tmp
comma
id|tmp2
suffix:semicolon
id|__asm__
id|__volatile__
c_func
(paren
"&quot;"
id|ldm
op_mod
ques
c_cond
id|ia
op_mod
l_int|1
op_logical_neg
comma
(brace
op_mod
l_int|2
comma
op_mod
l_int|3
)brace
id|str
op_mod
ques
c_cond
id|h
op_mod
l_int|2
comma
(braket
op_mod
l_int|0
)braket
comma
macro_line|#4
id|mov
op_mod
ques
c_cond
op_mod
l_int|2
comma
op_mod
l_int|2
comma
id|lsr
macro_line|#16
id|str
op_mod
ques
c_cond
id|h
op_mod
l_int|2
comma
(braket
op_mod
l_int|0
)braket
comma
macro_line|#4
id|str
op_mod
ques
c_cond
id|h
op_mod
l_int|3
comma
(braket
op_mod
l_int|0
)braket
comma
macro_line|#4
id|mov
op_mod
ques
c_cond
op_mod
l_int|3
comma
op_mod
l_int|3
comma
id|lsr
macro_line|#16
id|str
op_mod
ques
c_cond
id|h
op_mod
l_int|3
comma
(braket
op_mod
l_int|0
)braket
comma
macro_line|#4
l_string|&quot; : &quot;
op_assign
op_amp
id|r
l_string|&quot; (offset), &quot;
op_assign
op_amp
id|r
l_string|&quot; (buf), &quot;
op_assign
id|r
l_string|&quot; (tmp), &quot;
op_assign
id|r
"&quot;"
(paren
id|tmp2
)paren
suffix:colon
l_string|&quot;0&quot;
(paren
id|offset
)paren
comma
l_string|&quot;1&quot;
(paren
id|buf
)paren
)paren
suffix:semicolon
id|length
op_sub_assign
l_int|8
suffix:semicolon
)brace
r_while
c_loop
(paren
id|length
OG
l_int|0
)paren
(brace
id|__asm__
id|__volatile__
c_func
(paren
l_string|&quot;str%?h&t;%2, [%0], #4&quot;
suffix:colon
l_string|&quot;=&amp;r&quot;
(paren
id|offset
)paren
suffix:colon
l_string|&quot;0&quot;
(paren
id|offset
)paren
comma
l_string|&quot;r&quot;
(paren
id|buf
(braket
l_int|0
)braket
op_or
(paren
id|buf
(braket
l_int|1
)braket
op_lshift
l_int|8
)paren
)paren
)paren
suffix:semicolon
id|buf
op_add_assign
l_int|2
suffix:semicolon
id|length
op_sub_assign
l_int|2
suffix:semicolon
)brace
)brace
multiline_comment|/*&n; * This reads a 16-bit quantity in little-endian&n; * mode from the am79c961 buffer.&n; */
DECL|function|am_readword
r_static
r_inline
r_int
r_int
id|am_readword
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
id|u_int
id|off
)paren
(brace
r_int
r_int
id|address
op_assign
l_int|0xe0000000
op_plus
(paren
id|off
op_lshift
l_int|1
)paren
suffix:semicolon
r_int
r_int
id|val
suffix:semicolon
id|__asm__
c_func
(paren
l_string|&quot;ldr%?h&t;%0, [%1]&quot;
suffix:colon
l_string|&quot;=r&quot;
(paren
id|val
)paren
suffix:colon
l_string|&quot;r&quot;
(paren
id|address
)paren
)paren
suffix:semicolon
r_return
id|val
suffix:semicolon
)brace
r_static
r_inline
r_void
DECL|function|am_readbuffer
id|am_readbuffer
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
id|u_int
id|offset
comma
r_int
r_char
op_star
id|buf
comma
r_int
r_int
id|length
)paren
(brace
id|offset
op_assign
l_int|0xe0000000
op_plus
(paren
id|offset
op_lshift
l_int|1
)paren
suffix:semicolon
id|length
op_assign
(paren
id|length
op_plus
l_int|1
)paren
op_amp
op_complement
l_int|1
suffix:semicolon
r_if
c_cond
(paren
(paren
r_int
)paren
id|buf
op_amp
l_int|2
)paren
(brace
r_int
r_int
id|tmp
suffix:semicolon
id|__asm__
id|__volatile__
c_func
(paren
"&quot;"
id|ldr
op_mod
ques
c_cond
id|h
op_mod
l_int|2
comma
(braket
op_mod
l_int|0
)braket
comma
macro_line|#4
id|str
op_mod
ques
c_cond
id|b
op_mod
l_int|2
comma
(braket
op_mod
l_int|1
)braket
comma
macro_line|#1
id|mov
op_mod
ques
c_cond
op_mod
l_int|2
comma
op_mod
l_int|2
comma
id|lsr
macro_line|#8
id|str
op_mod
ques
c_cond
id|b
op_mod
l_int|2
comma
(braket
op_mod
l_int|1
)braket
comma
macro_line|#1
l_string|&quot; : &quot;
op_assign
op_amp
id|r
l_string|&quot; (offset), &quot;
op_assign
op_amp
id|r
l_string|&quot; (buf), &quot;
op_assign
id|r
l_string|&quot; (tmp): &quot;
l_int|0
l_string|&quot; (offset), &quot;
l_int|1
"&quot;"
(paren
id|buf
)paren
)paren
suffix:semicolon
id|length
op_sub_assign
l_int|2
suffix:semicolon
)brace
r_while
c_loop
(paren
id|length
OG
l_int|8
)paren
(brace
r_int
r_int
id|tmp
comma
id|tmp2
comma
id|tmp3
suffix:semicolon
id|__asm__
id|__volatile__
c_func
(paren
"&quot;"
id|ldr
op_mod
ques
c_cond
id|h
op_mod
l_int|2
comma
(braket
op_mod
l_int|0
)braket
comma
macro_line|#4
id|ldr
op_mod
ques
c_cond
id|h
op_mod
l_int|3
comma
(braket
op_mod
l_int|0
)braket
comma
macro_line|#4
id|orr
op_mod
ques
c_cond
op_mod
l_int|2
comma
op_mod
l_int|2
comma
op_mod
l_int|3
comma
id|lsl
macro_line|#16
id|ldr
op_mod
ques
c_cond
id|h
op_mod
l_int|3
comma
(braket
op_mod
l_int|0
)braket
comma
macro_line|#4
id|ldr
op_mod
ques
c_cond
id|h
op_mod
l_int|4
comma
(braket
op_mod
l_int|0
)braket
comma
macro_line|#4
id|orr
op_mod
ques
c_cond
op_mod
l_int|3
comma
op_mod
l_int|3
comma
op_mod
l_int|4
comma
id|lsl
macro_line|#16
id|stm
op_mod
ques
c_cond
id|ia
op_mod
l_int|1
op_logical_neg
comma
(brace
op_mod
l_int|2
comma
op_mod
l_int|3
)brace
l_string|&quot; : &quot;
op_assign
op_amp
id|r
l_string|&quot; (offset), &quot;
op_assign
op_amp
id|r
l_string|&quot; (buf), &quot;
op_assign
id|r
l_string|&quot; (tmp), &quot;
op_assign
id|r
l_string|&quot; (tmp2), &quot;
op_assign
id|r
"&quot;"
(paren
id|tmp3
)paren
suffix:colon
l_string|&quot;0&quot;
(paren
id|offset
)paren
comma
l_string|&quot;1&quot;
(paren
id|buf
)paren
)paren
suffix:semicolon
id|length
op_sub_assign
l_int|8
suffix:semicolon
)brace
r_while
c_loop
(paren
id|length
OG
l_int|0
)paren
(brace
r_int
r_int
id|tmp
suffix:semicolon
id|__asm__
id|__volatile__
c_func
(paren
"&quot;"
id|ldr
op_mod
ques
c_cond
id|h
op_mod
l_int|2
comma
(braket
op_mod
l_int|0
)braket
comma
macro_line|#4
id|str
op_mod
ques
c_cond
id|b
op_mod
l_int|2
comma
(braket
op_mod
l_int|1
)braket
comma
macro_line|#1
id|mov
op_mod
ques
c_cond
op_mod
l_int|2
comma
op_mod
l_int|2
comma
id|lsr
macro_line|#8
id|str
op_mod
ques
c_cond
id|b
op_mod
l_int|2
comma
(braket
op_mod
l_int|1
)braket
comma
macro_line|#1
l_string|&quot; : &quot;
op_assign
op_amp
id|r
l_string|&quot; (offset), &quot;
op_assign
op_amp
id|r
l_string|&quot; (buf), &quot;
op_assign
id|r
l_string|&quot; (tmp) : &quot;
l_int|0
l_string|&quot; (offset), &quot;
l_int|1
"&quot;"
(paren
id|buf
)paren
)paren
suffix:semicolon
id|length
op_sub_assign
l_int|2
suffix:semicolon
)brace
)brace
macro_line|#else
macro_line|#error Not compatable
macro_line|#endif
r_static
r_int
DECL|function|am79c961_ramtest
id|am79c961_ramtest
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_int
r_int
id|val
)paren
(brace
r_int
r_char
op_star
id|buffer
op_assign
id|kmalloc
(paren
l_int|65536
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_int
id|i
comma
id|error
op_assign
l_int|0
comma
id|errorcount
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|buffer
)paren
r_return
l_int|0
suffix:semicolon
id|memset
(paren
id|buffer
comma
id|val
comma
l_int|65536
)paren
suffix:semicolon
id|am_writebuffer
c_func
(paren
id|dev
comma
l_int|0
comma
id|buffer
comma
l_int|65536
)paren
suffix:semicolon
id|memset
(paren
id|buffer
comma
id|val
op_xor
l_int|255
comma
l_int|65536
)paren
suffix:semicolon
id|am_readbuffer
c_func
(paren
id|dev
comma
l_int|0
comma
id|buffer
comma
l_int|65536
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|65536
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|buffer
(braket
id|i
)braket
op_ne
id|val
op_logical_and
op_logical_neg
id|error
)paren
(brace
id|printk
(paren
l_string|&quot;%s: buffer error (%02X %02X) %05X - &quot;
comma
id|dev-&gt;name
comma
id|val
comma
id|buffer
(braket
id|i
)braket
comma
id|i
)paren
suffix:semicolon
id|error
op_assign
l_int|1
suffix:semicolon
id|errorcount
op_increment
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|error
op_logical_and
id|buffer
(braket
id|i
)braket
op_eq
id|val
)paren
(brace
id|printk
(paren
l_string|&quot;%05X&bslash;n&quot;
comma
id|i
)paren
suffix:semicolon
id|error
op_assign
l_int|0
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|error
)paren
id|printk
(paren
l_string|&quot;10000&bslash;n&quot;
)paren
suffix:semicolon
id|kfree
(paren
id|buffer
)paren
suffix:semicolon
r_return
id|errorcount
suffix:semicolon
)brace
r_static
r_void
DECL|function|am79c961_init_for_open
id|am79c961_init_for_open
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|dev_priv
op_star
id|priv
op_assign
(paren
r_struct
id|dev_priv
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_int
r_char
op_star
id|p
suffix:semicolon
id|u_int
id|hdr_addr
comma
id|first_free_addr
suffix:semicolon
r_int
id|i
suffix:semicolon
multiline_comment|/*&n;&t; * Stop the chip.&n;&t; */
id|spin_lock_irqsave
c_func
(paren
id|priv-&gt;chip_lock
comma
id|flags
)paren
suffix:semicolon
id|write_rreg
(paren
id|dev-&gt;base_addr
comma
id|CSR0
comma
id|CSR0_BABL
op_or
id|CSR0_CERR
op_or
id|CSR0_MISS
op_or
id|CSR0_MERR
op_or
id|CSR0_TINT
op_or
id|CSR0_RINT
op_or
id|CSR0_STOP
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
id|priv-&gt;chip_lock
comma
id|flags
)paren
suffix:semicolon
id|write_ireg
(paren
id|dev-&gt;base_addr
comma
l_int|5
comma
l_int|0x00a0
)paren
suffix:semicolon
multiline_comment|/* Receive address LED */
id|write_ireg
(paren
id|dev-&gt;base_addr
comma
l_int|6
comma
l_int|0x0081
)paren
suffix:semicolon
multiline_comment|/* Collision LED */
id|write_ireg
(paren
id|dev-&gt;base_addr
comma
l_int|7
comma
l_int|0x0090
)paren
suffix:semicolon
multiline_comment|/* XMIT LED */
id|write_ireg
(paren
id|dev-&gt;base_addr
comma
l_int|2
comma
l_int|0x0000
)paren
suffix:semicolon
multiline_comment|/* MODE register selects media */
r_for
c_loop
(paren
id|i
op_assign
id|LADRL
suffix:semicolon
id|i
op_le
id|LADRH
suffix:semicolon
id|i
op_increment
)paren
id|write_rreg
(paren
id|dev-&gt;base_addr
comma
id|i
comma
l_int|0
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
id|PADRL
comma
id|p
op_assign
id|dev-&gt;dev_addr
suffix:semicolon
id|i
op_le
id|PADRH
suffix:semicolon
id|i
op_increment
comma
id|p
op_add_assign
l_int|2
)paren
id|write_rreg
(paren
id|dev-&gt;base_addr
comma
id|i
comma
id|p
(braket
l_int|0
)braket
op_or
(paren
id|p
(braket
l_int|1
)braket
op_lshift
l_int|8
)paren
)paren
suffix:semicolon
id|i
op_assign
id|MODE_PORT_10BT
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;flags
op_amp
id|IFF_PROMISC
)paren
id|i
op_or_assign
id|MODE_PROMISC
suffix:semicolon
id|write_rreg
(paren
id|dev-&gt;base_addr
comma
id|MODE
comma
id|i
)paren
suffix:semicolon
id|write_rreg
(paren
id|dev-&gt;base_addr
comma
id|POLLINT
comma
l_int|0
)paren
suffix:semicolon
id|write_rreg
(paren
id|dev-&gt;base_addr
comma
id|SIZERXR
comma
op_minus
id|RX_BUFFERS
)paren
suffix:semicolon
id|write_rreg
(paren
id|dev-&gt;base_addr
comma
id|SIZETXR
comma
op_minus
id|TX_BUFFERS
)paren
suffix:semicolon
id|first_free_addr
op_assign
id|RX_BUFFERS
op_star
l_int|8
op_plus
id|TX_BUFFERS
op_star
l_int|8
op_plus
l_int|16
suffix:semicolon
id|hdr_addr
op_assign
l_int|0
suffix:semicolon
id|priv-&gt;rxhead
op_assign
l_int|0
suffix:semicolon
id|priv-&gt;rxtail
op_assign
l_int|0
suffix:semicolon
id|priv-&gt;rxhdr
op_assign
id|hdr_addr
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|RX_BUFFERS
suffix:semicolon
id|i
op_increment
)paren
(brace
id|priv-&gt;rxbuffer
(braket
id|i
)braket
op_assign
id|first_free_addr
suffix:semicolon
id|am_writeword
(paren
id|dev
comma
id|hdr_addr
comma
id|first_free_addr
)paren
suffix:semicolon
id|am_writeword
(paren
id|dev
comma
id|hdr_addr
op_plus
l_int|2
comma
id|RMD_OWN
)paren
suffix:semicolon
id|am_writeword
(paren
id|dev
comma
id|hdr_addr
op_plus
l_int|4
comma
(paren
op_minus
l_int|1600
)paren
)paren
suffix:semicolon
id|am_writeword
(paren
id|dev
comma
id|hdr_addr
op_plus
l_int|6
comma
l_int|0
)paren
suffix:semicolon
id|first_free_addr
op_add_assign
l_int|1600
suffix:semicolon
id|hdr_addr
op_add_assign
l_int|8
suffix:semicolon
)brace
id|priv-&gt;txhead
op_assign
l_int|0
suffix:semicolon
id|priv-&gt;txtail
op_assign
l_int|0
suffix:semicolon
id|priv-&gt;txhdr
op_assign
id|hdr_addr
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|TX_BUFFERS
suffix:semicolon
id|i
op_increment
)paren
(brace
id|priv-&gt;txbuffer
(braket
id|i
)braket
op_assign
id|first_free_addr
suffix:semicolon
id|am_writeword
(paren
id|dev
comma
id|hdr_addr
comma
id|first_free_addr
)paren
suffix:semicolon
id|am_writeword
(paren
id|dev
comma
id|hdr_addr
op_plus
l_int|2
comma
id|TMD_STP
op_or
id|TMD_ENP
)paren
suffix:semicolon
id|am_writeword
(paren
id|dev
comma
id|hdr_addr
op_plus
l_int|4
comma
l_int|0xf000
)paren
suffix:semicolon
id|am_writeword
(paren
id|dev
comma
id|hdr_addr
op_plus
l_int|6
comma
l_int|0
)paren
suffix:semicolon
id|first_free_addr
op_add_assign
l_int|1600
suffix:semicolon
id|hdr_addr
op_add_assign
l_int|8
suffix:semicolon
)brace
id|write_rreg
(paren
id|dev-&gt;base_addr
comma
id|BASERXL
comma
id|priv-&gt;rxhdr
)paren
suffix:semicolon
id|write_rreg
(paren
id|dev-&gt;base_addr
comma
id|BASERXH
comma
l_int|0
)paren
suffix:semicolon
id|write_rreg
(paren
id|dev-&gt;base_addr
comma
id|BASETXL
comma
id|priv-&gt;txhdr
)paren
suffix:semicolon
id|write_rreg
(paren
id|dev-&gt;base_addr
comma
id|BASERXH
comma
l_int|0
)paren
suffix:semicolon
id|write_rreg
(paren
id|dev-&gt;base_addr
comma
id|CSR0
comma
id|CSR0_STOP
)paren
suffix:semicolon
id|write_rreg
(paren
id|dev-&gt;base_addr
comma
id|CSR3
comma
id|CSR3_IDONM
op_or
id|CSR3_BABLM
op_or
id|CSR3_DXSUFLO
)paren
suffix:semicolon
id|write_rreg
(paren
id|dev-&gt;base_addr
comma
id|CSR0
comma
id|CSR0_IENA
op_or
id|CSR0_STRT
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Open/initialize the board.  This is called (in the current kernel)&n; * sometime after booting when the &squot;ifconfig&squot; program is run.&n; *&n; * This routine should set everything up anew at each open, even&n; * registers that &quot;should&quot; only need to be set once at boot, so that&n; * there is non-reboot way to recover if something goes wrong.&n; */
r_static
r_int
DECL|function|am79c961_open
id|am79c961_open
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|dev_priv
op_star
id|priv
op_assign
(paren
r_struct
id|dev_priv
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_int
id|ret
suffix:semicolon
id|memset
(paren
op_amp
id|priv-&gt;stats
comma
l_int|0
comma
r_sizeof
(paren
id|priv-&gt;stats
)paren
)paren
suffix:semicolon
id|ret
op_assign
id|request_irq
c_func
(paren
id|dev-&gt;irq
comma
id|am79c961_interrupt
comma
l_int|0
comma
id|dev-&gt;name
comma
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
)paren
r_return
id|ret
suffix:semicolon
id|am79c961_init_for_open
c_func
(paren
id|dev
)paren
suffix:semicolon
id|netif_start_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * The inverse routine to am79c961_open().&n; */
r_static
r_int
DECL|function|am79c961_close
id|am79c961_close
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|dev_priv
op_star
id|priv
op_assign
(paren
r_struct
id|dev_priv
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|netif_stop_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
id|priv-&gt;chip_lock
comma
id|flags
)paren
suffix:semicolon
id|write_rreg
(paren
id|dev-&gt;base_addr
comma
id|CSR0
comma
id|CSR0_STOP
)paren
suffix:semicolon
id|write_rreg
(paren
id|dev-&gt;base_addr
comma
id|CSR3
comma
id|CSR3_MASKALL
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
id|priv-&gt;chip_lock
comma
id|flags
)paren
suffix:semicolon
id|free_irq
(paren
id|dev-&gt;irq
comma
id|dev
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * Get the current statistics.&t;This may be called with the card open or&n; * closed.&n; */
DECL|function|am79c961_getstats
r_static
r_struct
id|net_device_stats
op_star
id|am79c961_getstats
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|dev_priv
op_star
id|priv
op_assign
(paren
r_struct
id|dev_priv
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_return
op_amp
id|priv-&gt;stats
suffix:semicolon
)brace
DECL|function|update_crc
r_static
r_inline
id|u32
id|update_crc
c_func
(paren
id|u32
id|crc
comma
id|u8
id|byte
)paren
(brace
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|8
suffix:semicolon
id|i
op_ne
l_int|0
suffix:semicolon
id|i
op_decrement
)paren
(brace
id|byte
op_xor_assign
id|crc
op_amp
l_int|1
suffix:semicolon
id|crc
op_rshift_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|byte
op_amp
l_int|1
)paren
id|crc
op_xor_assign
l_int|0xedb88320
suffix:semicolon
id|byte
op_rshift_assign
l_int|1
suffix:semicolon
)brace
r_return
id|crc
suffix:semicolon
)brace
DECL|function|am79c961_mc_hash
r_static
r_void
id|am79c961_mc_hash
c_func
(paren
r_struct
id|dev_mc_list
op_star
id|dmi
comma
r_int
r_int
op_star
id|hash
)paren
(brace
r_if
c_cond
(paren
id|dmi-&gt;dmi_addrlen
op_eq
id|ETH_ALEN
op_logical_and
id|dmi-&gt;dmi_addr
(braket
l_int|0
)braket
op_amp
l_int|0x01
)paren
(brace
r_int
id|i
comma
id|idx
comma
id|bit
suffix:semicolon
id|u32
id|crc
suffix:semicolon
id|crc
op_assign
l_int|0xffffffff
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|ETH_ALEN
suffix:semicolon
id|i
op_increment
)paren
id|crc
op_assign
id|update_crc
c_func
(paren
id|crc
comma
id|dmi-&gt;dmi_addr
(braket
id|i
)braket
)paren
suffix:semicolon
id|idx
op_assign
id|crc
op_rshift
l_int|30
suffix:semicolon
id|bit
op_assign
(paren
id|crc
op_rshift
l_int|26
)paren
op_amp
l_int|15
suffix:semicolon
id|hash
(braket
id|idx
)braket
op_or_assign
l_int|1
op_lshift
id|bit
suffix:semicolon
)brace
)brace
multiline_comment|/*&n; * Set or clear promiscuous/multicast mode filter for this adaptor.&n; */
DECL|function|am79c961_setmulticastlist
r_static
r_void
id|am79c961_setmulticastlist
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|dev_priv
op_star
id|priv
op_assign
(paren
r_struct
id|dev_priv
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_int
r_int
id|multi_hash
(braket
l_int|4
)braket
comma
id|mode
suffix:semicolon
r_int
id|i
comma
id|stopped
suffix:semicolon
id|mode
op_assign
id|MODE_PORT_10BT
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;flags
op_amp
id|IFF_PROMISC
)paren
(brace
id|mode
op_or_assign
id|MODE_PROMISC
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|dev-&gt;flags
op_amp
id|IFF_ALLMULTI
)paren
(brace
id|memset
c_func
(paren
id|multi_hash
comma
l_int|0xff
comma
r_sizeof
(paren
id|multi_hash
)paren
)paren
suffix:semicolon
)brace
r_else
(brace
r_struct
id|dev_mc_list
op_star
id|dmi
suffix:semicolon
id|memset
c_func
(paren
id|multi_hash
comma
l_int|0x00
comma
r_sizeof
(paren
id|multi_hash
)paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|dmi
op_assign
id|dev-&gt;mc_list
suffix:semicolon
id|dmi
suffix:semicolon
id|dmi
op_assign
id|dmi-&gt;next
)paren
id|am79c961_mc_hash
c_func
(paren
id|dmi
comma
id|multi_hash
)paren
suffix:semicolon
)brace
id|spin_lock_irqsave
c_func
(paren
id|priv-&gt;chip_lock
comma
id|flags
)paren
suffix:semicolon
id|stopped
op_assign
id|read_rreg
c_func
(paren
id|dev-&gt;base_addr
comma
id|CSR0
)paren
op_amp
id|CSR0_STOP
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|stopped
)paren
(brace
multiline_comment|/*&n;&t;&t; * Put the chip into suspend mode&n;&t;&t; */
id|write_rreg
c_func
(paren
id|dev-&gt;base_addr
comma
id|CTRL1
comma
id|CTRL1_SPND
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t; * Spin waiting for chip to report suspend mode&n;&t;&t; */
r_while
c_loop
(paren
(paren
id|read_rreg
c_func
(paren
id|dev-&gt;base_addr
comma
id|CTRL1
)paren
op_amp
id|CTRL1_SPND
)paren
op_eq
l_int|0
)paren
(brace
id|spin_unlock_irqrestore
c_func
(paren
id|priv-&gt;chip_lock
comma
id|flags
)paren
suffix:semicolon
id|nop
c_func
(paren
)paren
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
id|priv-&gt;chip_lock
comma
id|flags
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/*&n;&t; * Update the multicast hash table&n;&t; */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
r_sizeof
(paren
id|multi_hash
)paren
op_div
r_sizeof
(paren
id|multi_hash
(braket
l_int|0
)braket
)paren
suffix:semicolon
id|i
op_increment
)paren
id|write_rreg
c_func
(paren
id|dev-&gt;base_addr
comma
id|i
op_plus
id|LADRL
comma
id|multi_hash
(braket
id|i
)braket
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Write the mode register&n;&t; */
id|write_rreg
c_func
(paren
id|dev-&gt;base_addr
comma
id|MODE
comma
id|mode
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|stopped
)paren
(brace
multiline_comment|/*&n;&t;&t; * Put the chip back into running mode&n;&t;&t; */
id|write_rreg
c_func
(paren
id|dev-&gt;base_addr
comma
id|CTRL1
comma
l_int|0
)paren
suffix:semicolon
)brace
id|spin_unlock_irqrestore
c_func
(paren
id|priv-&gt;chip_lock
comma
id|flags
)paren
suffix:semicolon
)brace
DECL|function|am79c961_timeout
r_static
r_void
id|am79c961_timeout
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: transmit timed out, network cable problem?&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * ought to do some setup of the tx side here&n;&t; */
id|netif_wake_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Transmit a packet&n; */
r_static
r_int
DECL|function|am79c961_sendpacket
id|am79c961_sendpacket
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|dev_priv
op_star
id|priv
op_assign
(paren
r_struct
id|dev_priv
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_int
r_int
id|length
op_assign
id|ETH_ZLEN
OL
id|skb-&gt;len
ques
c_cond
id|skb-&gt;len
suffix:colon
id|ETH_ZLEN
suffix:semicolon
r_int
r_int
id|hdraddr
comma
id|bufaddr
suffix:semicolon
r_int
r_int
id|head
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|head
op_assign
id|priv-&gt;txhead
suffix:semicolon
id|hdraddr
op_assign
id|priv-&gt;txhdr
op_plus
(paren
id|head
op_lshift
l_int|3
)paren
suffix:semicolon
id|bufaddr
op_assign
id|priv-&gt;txbuffer
(braket
id|head
)braket
suffix:semicolon
id|head
op_add_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|head
op_ge
id|TX_BUFFERS
)paren
id|head
op_assign
l_int|0
suffix:semicolon
id|am_writebuffer
(paren
id|dev
comma
id|bufaddr
comma
id|skb-&gt;data
comma
id|length
)paren
suffix:semicolon
id|am_writeword
(paren
id|dev
comma
id|hdraddr
op_plus
l_int|4
comma
op_minus
id|length
)paren
suffix:semicolon
id|am_writeword
(paren
id|dev
comma
id|hdraddr
op_plus
l_int|2
comma
id|TMD_OWN
op_or
id|TMD_STP
op_or
id|TMD_ENP
)paren
suffix:semicolon
id|priv-&gt;txhead
op_assign
id|head
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
id|priv-&gt;chip_lock
comma
id|flags
)paren
suffix:semicolon
id|write_rreg
(paren
id|dev-&gt;base_addr
comma
id|CSR0
comma
id|CSR0_TDMD
op_or
id|CSR0_IENA
)paren
suffix:semicolon
id|dev-&gt;trans_start
op_assign
id|jiffies
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
id|priv-&gt;chip_lock
comma
id|flags
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * If the next packet is owned by the ethernet device,&n;&t; * then the tx ring is full and we can&squot;t add another&n;&t; * packet.&n;&t; */
r_if
c_cond
(paren
id|am_readword
c_func
(paren
id|dev
comma
id|priv-&gt;txhdr
op_plus
(paren
id|priv-&gt;txhead
op_lshift
l_int|3
)paren
op_plus
l_int|2
)paren
op_amp
id|TMD_OWN
)paren
(brace
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;tx ring full, stopping queue&bslash;n&quot;
)paren
suffix:semicolon
id|netif_stop_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
id|dev_kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * If we have a good packet(s), get it/them out of the buffers.&n; */
r_static
r_void
DECL|function|am79c961_rx
id|am79c961_rx
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_struct
id|dev_priv
op_star
id|priv
)paren
(brace
r_do
(brace
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
id|u_int
id|hdraddr
suffix:semicolon
id|u_int
id|pktaddr
suffix:semicolon
id|u_int
id|status
suffix:semicolon
r_int
id|len
suffix:semicolon
id|hdraddr
op_assign
id|priv-&gt;rxhdr
op_plus
(paren
id|priv-&gt;rxtail
op_lshift
l_int|3
)paren
suffix:semicolon
id|pktaddr
op_assign
id|priv-&gt;rxbuffer
(braket
id|priv-&gt;rxtail
)braket
suffix:semicolon
id|status
op_assign
id|am_readword
(paren
id|dev
comma
id|hdraddr
op_plus
l_int|2
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
id|RMD_OWN
)paren
multiline_comment|/* do we own it? */
r_break
suffix:semicolon
id|priv-&gt;rxtail
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|priv-&gt;rxtail
op_ge
id|RX_BUFFERS
)paren
id|priv-&gt;rxtail
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
(paren
id|status
op_amp
(paren
id|RMD_ERR
op_or
id|RMD_STP
op_or
id|RMD_ENP
)paren
)paren
op_ne
(paren
id|RMD_STP
op_or
id|RMD_ENP
)paren
)paren
(brace
id|am_writeword
(paren
id|dev
comma
id|hdraddr
op_plus
l_int|2
comma
id|RMD_OWN
)paren
suffix:semicolon
id|priv-&gt;stats.rx_errors
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
id|RMD_ERR
)paren
(brace
r_if
c_cond
(paren
id|status
op_amp
id|RMD_FRAM
)paren
id|priv-&gt;stats.rx_frame_errors
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
id|RMD_CRC
)paren
id|priv-&gt;stats.rx_crc_errors
op_increment
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|status
op_amp
id|RMD_STP
)paren
id|priv-&gt;stats.rx_length_errors
op_increment
suffix:semicolon
r_continue
suffix:semicolon
)brace
id|len
op_assign
id|am_readword
c_func
(paren
id|dev
comma
id|hdraddr
op_plus
l_int|6
)paren
suffix:semicolon
id|skb
op_assign
id|dev_alloc_skb
c_func
(paren
id|len
op_plus
l_int|2
)paren
suffix:semicolon
r_if
c_cond
(paren
id|skb
)paren
(brace
id|skb-&gt;dev
op_assign
id|dev
suffix:semicolon
id|skb_reserve
c_func
(paren
id|skb
comma
l_int|2
)paren
suffix:semicolon
id|am_readbuffer
c_func
(paren
id|dev
comma
id|pktaddr
comma
id|skb_put
c_func
(paren
id|skb
comma
id|len
)paren
comma
id|len
)paren
suffix:semicolon
id|am_writeword
c_func
(paren
id|dev
comma
id|hdraddr
op_plus
l_int|2
comma
id|RMD_OWN
)paren
suffix:semicolon
id|skb-&gt;protocol
op_assign
id|eth_type_trans
c_func
(paren
id|skb
comma
id|dev
)paren
suffix:semicolon
id|netif_rx
c_func
(paren
id|skb
)paren
suffix:semicolon
id|dev-&gt;last_rx
op_assign
id|jiffies
suffix:semicolon
id|priv-&gt;stats.rx_bytes
op_add_assign
id|len
suffix:semicolon
id|priv-&gt;stats.rx_packets
op_increment
suffix:semicolon
)brace
r_else
(brace
id|am_writeword
(paren
id|dev
comma
id|hdraddr
op_plus
l_int|2
comma
id|RMD_OWN
)paren
suffix:semicolon
id|printk
(paren
id|KERN_WARNING
l_string|&quot;%s: memory squeeze, dropping packet.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|priv-&gt;stats.rx_dropped
op_increment
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
r_while
c_loop
(paren
l_int|1
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Update stats for the transmitted packet&n; */
r_static
r_void
DECL|function|am79c961_tx
id|am79c961_tx
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_struct
id|dev_priv
op_star
id|priv
)paren
(brace
r_do
(brace
id|u_int
id|hdraddr
suffix:semicolon
id|u_int
id|status
suffix:semicolon
r_int
id|bufnum
suffix:semicolon
id|bufnum
op_assign
id|priv-&gt;txtail
suffix:semicolon
id|hdraddr
op_assign
id|priv-&gt;txhdr
op_plus
(paren
id|priv-&gt;txtail
op_lshift
l_int|3
)paren
suffix:semicolon
id|status
op_assign
id|am_readword
(paren
id|dev
comma
id|hdraddr
op_plus
l_int|2
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
id|TMD_OWN
)paren
r_break
suffix:semicolon
id|priv-&gt;txtail
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|priv-&gt;txtail
op_ge
id|TX_BUFFERS
)paren
id|priv-&gt;txtail
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
id|TMD_ERR
)paren
(brace
id|u_int
id|status2
suffix:semicolon
id|priv-&gt;stats.tx_errors
op_increment
suffix:semicolon
id|status2
op_assign
id|am_readword
(paren
id|dev
comma
id|hdraddr
op_plus
l_int|6
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t;&t; * Clear the error byte&n;&t;&t;&t; */
id|am_writeword
(paren
id|dev
comma
id|hdraddr
op_plus
l_int|6
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status2
op_amp
id|TST_RTRY
)paren
id|priv-&gt;stats.collisions
op_add_assign
l_int|16
suffix:semicolon
r_if
c_cond
(paren
id|status2
op_amp
id|TST_LCOL
)paren
id|priv-&gt;stats.tx_window_errors
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|status2
op_amp
id|TST_LCAR
)paren
id|priv-&gt;stats.tx_carrier_errors
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|status2
op_amp
id|TST_UFLO
)paren
id|priv-&gt;stats.tx_fifo_errors
op_increment
suffix:semicolon
r_continue
suffix:semicolon
)brace
id|priv-&gt;stats.tx_packets
op_increment
suffix:semicolon
)brace
r_while
c_loop
(paren
id|priv-&gt;txtail
op_ne
id|priv-&gt;txhead
)paren
suffix:semicolon
id|netif_wake_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
r_static
r_void
DECL|function|am79c961_interrupt
id|am79c961_interrupt
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_struct
id|net_device
op_star
id|dev
op_assign
(paren
r_struct
id|net_device
op_star
)paren
id|dev_id
suffix:semicolon
r_struct
id|dev_priv
op_star
id|priv
op_assign
(paren
r_struct
id|dev_priv
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|u_int
id|status
suffix:semicolon
id|status
op_assign
id|read_rreg
c_func
(paren
id|dev-&gt;base_addr
comma
id|CSR0
)paren
suffix:semicolon
id|write_rreg
c_func
(paren
id|dev-&gt;base_addr
comma
id|CSR0
comma
id|status
op_amp
(paren
id|CSR0_TINT
op_or
id|CSR0_RINT
op_or
id|CSR0_MISS
op_or
id|CSR0_IENA
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
id|CSR0_RINT
)paren
id|am79c961_rx
c_func
(paren
id|dev
comma
id|priv
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
id|CSR0_TINT
)paren
id|am79c961_tx
c_func
(paren
id|dev
comma
id|priv
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
id|CSR0_MISS
)paren
id|priv-&gt;stats.rx_dropped
op_increment
suffix:semicolon
)brace
multiline_comment|/*&n; * Initialise the chip.  Note that we always expect&n; * to be entered with interrupts enabled.&n; */
r_static
r_int
DECL|function|am79c961_hw_init
id|am79c961_hw_init
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|dev_priv
op_star
id|priv
op_assign
(paren
r_struct
id|dev_priv
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|spin_lock_irq
c_func
(paren
id|priv-&gt;chip_lock
)paren
suffix:semicolon
id|write_rreg
(paren
id|dev-&gt;base_addr
comma
id|CSR0
comma
id|CSR0_STOP
)paren
suffix:semicolon
id|write_rreg
(paren
id|dev-&gt;base_addr
comma
id|CSR3
comma
id|CSR3_MASKALL
)paren
suffix:semicolon
id|spin_unlock_irq
c_func
(paren
id|priv-&gt;chip_lock
)paren
suffix:semicolon
id|am79c961_ramtest
c_func
(paren
id|dev
comma
l_int|0x66
)paren
suffix:semicolon
id|am79c961_ramtest
c_func
(paren
id|dev
comma
l_int|0x99
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|am79c961_banner
r_static
r_void
id|__init
id|am79c961_banner
c_func
(paren
r_void
)paren
(brace
r_static
r_int
id|version_printed
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|net_debug
op_logical_and
id|version_printed
op_increment
op_eq
l_int|0
)paren
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s&quot;
comma
id|version
)paren
suffix:semicolon
)brace
DECL|function|am79c961_init
r_static
r_int
id|__init
id|am79c961_init
c_func
(paren
r_void
)paren
(brace
r_struct
id|net_device
op_star
id|dev
suffix:semicolon
r_struct
id|dev_priv
op_star
id|priv
suffix:semicolon
r_int
id|i
comma
id|ret
suffix:semicolon
id|dev
op_assign
id|init_etherdev
c_func
(paren
l_int|NULL
comma
r_sizeof
(paren
r_struct
id|dev_priv
)paren
)paren
suffix:semicolon
id|ret
op_assign
op_minus
id|ENOMEM
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dev
)paren
r_goto
id|out
suffix:semicolon
id|SET_MODULE_OWNER
c_func
(paren
id|dev
)paren
suffix:semicolon
id|priv
op_assign
id|dev-&gt;priv
suffix:semicolon
multiline_comment|/*&n;&t; * Fixed address and IRQ lines here.&n;&t; * The PNP initialisation should have been&n;&t; * done by the ether bootp loader.&n;&t; */
id|dev-&gt;base_addr
op_assign
l_int|0x220
suffix:semicolon
id|dev-&gt;irq
op_assign
id|IRQ_EBSA110_ETHERNET
suffix:semicolon
multiline_comment|/*&n;&t; * Reset the device.&n;&t; */
id|inb
c_func
(paren
(paren
id|dev-&gt;base_addr
op_plus
id|NET_RESET
)paren
op_rshift
l_int|1
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|5
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Check the manufacturer part of the&n;&t; * ether address.&n;&t; */
id|ret
op_assign
op_minus
id|ENODEV
suffix:semicolon
r_if
c_cond
(paren
id|inb
c_func
(paren
id|dev-&gt;base_addr
op_rshift
l_int|1
)paren
op_ne
l_int|0x08
op_logical_or
id|inb
c_func
(paren
(paren
id|dev-&gt;base_addr
op_rshift
l_int|1
)paren
op_plus
l_int|1
)paren
op_ne
l_int|00
op_logical_or
id|inb
c_func
(paren
(paren
id|dev-&gt;base_addr
op_rshift
l_int|1
)paren
op_plus
l_int|2
)paren
op_ne
l_int|0x2b
)paren
r_goto
id|nodev
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|request_region
c_func
(paren
id|dev-&gt;base_addr
comma
l_int|0x18
comma
id|dev-&gt;name
)paren
)paren
r_goto
id|nodev
suffix:semicolon
id|am79c961_banner
c_func
(paren
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: am79c961 found at %08lx, IRQ%d, ether address &quot;
comma
id|dev-&gt;name
comma
id|dev-&gt;base_addr
comma
id|dev-&gt;irq
)paren
suffix:semicolon
multiline_comment|/* Retrive and print the ethernet address. */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|6
suffix:semicolon
id|i
op_increment
)paren
(brace
id|dev-&gt;dev_addr
(braket
id|i
)braket
op_assign
id|inb
c_func
(paren
(paren
id|dev-&gt;base_addr
op_rshift
l_int|1
)paren
op_plus
id|i
)paren
op_amp
l_int|0xff
suffix:semicolon
id|printk
(paren
id|i
op_eq
l_int|5
ques
c_cond
l_string|&quot;%02x&bslash;n&quot;
suffix:colon
l_string|&quot;%02x:&quot;
comma
id|dev-&gt;dev_addr
(braket
id|i
)braket
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|am79c961_hw_init
c_func
(paren
id|dev
)paren
)paren
r_goto
id|release
suffix:semicolon
id|dev-&gt;open
op_assign
id|am79c961_open
suffix:semicolon
id|dev-&gt;stop
op_assign
id|am79c961_close
suffix:semicolon
id|dev-&gt;hard_start_xmit
op_assign
id|am79c961_sendpacket
suffix:semicolon
id|dev-&gt;get_stats
op_assign
id|am79c961_getstats
suffix:semicolon
id|dev-&gt;set_multicast_list
op_assign
id|am79c961_setmulticastlist
suffix:semicolon
id|dev-&gt;tx_timeout
op_assign
id|am79c961_timeout
suffix:semicolon
r_return
l_int|0
suffix:semicolon
id|release
suffix:colon
id|release_region
c_func
(paren
id|dev-&gt;base_addr
comma
l_int|0x18
)paren
suffix:semicolon
id|nodev
suffix:colon
id|unregister_netdev
c_func
(paren
id|dev
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|dev
)paren
suffix:semicolon
id|out
suffix:colon
r_return
id|ret
suffix:semicolon
)brace
DECL|variable|am79c961_init
id|module_init
c_func
(paren
id|am79c961_init
)paren
suffix:semicolon
eof
