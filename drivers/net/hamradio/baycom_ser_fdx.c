multiline_comment|/*****************************************************************************/
multiline_comment|/*&n; *&t;baycom_ser_fdx.c  -- baycom ser12 fullduplex radio modem driver.&n; *&n; *&t;Copyright (C) 1996-2000  Thomas Sailer (sailer@ife.ee.ethz.ch)&n; *&n; *&t;This program is free software; you can redistribute it and/or modify&n; *&t;it under the terms of the GNU General Public License as published by&n; *&t;the Free Software Foundation; either version 2 of the License, or&n; *&t;(at your option) any later version.&n; *&n; *&t;This program is distributed in the hope that it will be useful,&n; *&t;but WITHOUT ANY WARRANTY; without even the implied warranty of&n; *&t;MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the&n; *&t;GNU General Public License for more details.&n; *&n; *&t;You should have received a copy of the GNU General Public License&n; *&t;along with this program; if not, write to the Free Software&n; *&t;Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.&n; *&n; *  Please note that the GPL allows you to use the driver, NOT the radio.&n; *  In order to use the radio, you need a license from the communications&n; *  authority of your country.&n; *&n; *&n; *  Supported modems&n; *&n; *  ser12:  This is a very simple 1200 baud AFSK modem. The modem consists only&n; *          of a modulator/demodulator chip, usually a TI TCM3105. The computer&n; *          is responsible for regenerating the receiver bit clock, as well as&n; *          for handling the HDLC protocol. The modem connects to a serial port,&n; *          hence the name. Since the serial port is not used as an async serial&n; *          port, the kernel driver for serial ports cannot be used, and this&n; *          driver only supports standard serial hardware (8250, 16450, 16550A)&n; *&n; *          This modem usually draws its supply current out of the otherwise unused&n; *          TXD pin of the serial port. Thus a contignuous stream of 0x00-bytes&n; *          is transmitted to achieve a positive supply voltage.&n; *&n; *  hsk:    This is a 4800 baud FSK modem, designed for TNC use. It works fine&n; *          in &squot;baycom-mode&squot; :-)  In contrast to the TCM3105 modem, power is&n; *          externally supplied. So there&squot;s no need to provide the 0x00-byte-stream&n; *          when receiving or idle, which drastically reduces interrupt load.&n; *&n; *  Command line options (insmod command line)&n; *&n; *  mode     ser#    hardware DCD&n; *           ser#*   software DCD&n; *           ser#+   hardware DCD, inverted signal at DCD pin&n; *           &squot;#&squot; denotes the baud rate / 100, eg. ser12* is &squot;1200 baud, soft DCD&squot;&n; *  iobase   base address of the port; common values are 0x3f8, 0x2f8, 0x3e8, 0x2e8&n; *  baud     baud rate (between 300 and 4800)&n; *  irq      interrupt line of the port; common values are 4,3&n; *&n; *&n; *  History:&n; *   0.1  26.06.1996  Adapted from baycom.c and made network driver interface&n; *        18.10.1996  Changed to new user space access routines (copy_{to,from}_user)&n; *   0.3  26.04.1997  init code/data tagged&n; *   0.4  08.07.1997  alternative ser12 decoding algorithm (uses delta CTS ints)&n; *   0.5  11.11.1997  ser12/par96 split into separate files&n; *   0.6  24.01.1998  Thorsten Kranzkowski, dl8bcu and Thomas Sailer:&n; *                    reduced interrupt load in transmit case&n; *                    reworked receiver&n; *   0.7  03.08.1999  adapt to Linus&squot; new __setup/__initcall&n; *   0.8  10.08.1999  use module_init/module_exit&n; *   0.9  12.02.2000  adapted to softnet driver interface&n; *   0.10 03.07.2000  fix interface name handling&n; */
multiline_comment|/*****************************************************************************/
macro_line|#include &lt;linux/version.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/ioport.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;asm/uaccess.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;linux/hdlcdrv.h&gt;
macro_line|#include &lt;linux/baycom.h&gt;
multiline_comment|/* --------------------------------------------------------------------- */
DECL|macro|BAYCOM_DEBUG
mdefine_line|#define BAYCOM_DEBUG
multiline_comment|/* --------------------------------------------------------------------- */
DECL|variable|bc_drvname
r_static
r_const
r_char
id|bc_drvname
(braket
)braket
op_assign
l_string|&quot;baycom_ser_fdx&quot;
suffix:semicolon
DECL|variable|bc_drvinfo
r_static
r_const
r_char
id|bc_drvinfo
(braket
)braket
op_assign
id|KERN_INFO
l_string|&quot;baycom_ser_fdx: (C) 1996-2000 Thomas Sailer, HB9JNX/AE4WA&bslash;n&quot;
id|KERN_INFO
l_string|&quot;baycom_ser_fdx: version 0.10 compiled &quot;
id|__TIME__
l_string|&quot; &quot;
id|__DATE__
l_string|&quot;&bslash;n&quot;
suffix:semicolon
multiline_comment|/* --------------------------------------------------------------------- */
DECL|macro|NR_PORTS
mdefine_line|#define NR_PORTS 4
DECL|variable|baycom_device
r_static
r_struct
id|net_device
id|baycom_device
(braket
id|NR_PORTS
)braket
suffix:semicolon
multiline_comment|/* --------------------------------------------------------------------- */
DECL|macro|RBR
mdefine_line|#define RBR(iobase) (iobase+0)
DECL|macro|THR
mdefine_line|#define THR(iobase) (iobase+0)
DECL|macro|IER
mdefine_line|#define IER(iobase) (iobase+1)
DECL|macro|IIR
mdefine_line|#define IIR(iobase) (iobase+2)
DECL|macro|FCR
mdefine_line|#define FCR(iobase) (iobase+2)
DECL|macro|LCR
mdefine_line|#define LCR(iobase) (iobase+3)
DECL|macro|MCR
mdefine_line|#define MCR(iobase) (iobase+4)
DECL|macro|LSR
mdefine_line|#define LSR(iobase) (iobase+5)
DECL|macro|MSR
mdefine_line|#define MSR(iobase) (iobase+6)
DECL|macro|SCR
mdefine_line|#define SCR(iobase) (iobase+7)
DECL|macro|DLL
mdefine_line|#define DLL(iobase) (iobase+0)
DECL|macro|DLM
mdefine_line|#define DLM(iobase) (iobase+1)
DECL|macro|SER12_EXTENT
mdefine_line|#define SER12_EXTENT 8
multiline_comment|/* ---------------------------------------------------------------------- */
multiline_comment|/*&n; * Information that need to be kept for each board.&n; */
DECL|struct|baycom_state
r_struct
id|baycom_state
(brace
DECL|member|hdrv
r_struct
id|hdlcdrv_state
id|hdrv
suffix:semicolon
DECL|member|baud
DECL|member|baud_us
DECL|member|baud_arbdiv
DECL|member|baud_uartdiv
DECL|member|baud_dcdtimeout
r_int
r_int
id|baud
comma
id|baud_us
comma
id|baud_arbdiv
comma
id|baud_uartdiv
comma
id|baud_dcdtimeout
suffix:semicolon
DECL|member|opt_dcd
r_int
id|opt_dcd
suffix:semicolon
DECL|struct|modem_state
r_struct
id|modem_state
(brace
DECL|member|flags
r_int
r_char
id|flags
suffix:semicolon
DECL|member|ptt
r_int
r_char
id|ptt
suffix:semicolon
DECL|member|shreg
r_int
r_int
id|shreg
suffix:semicolon
DECL|struct|modem_state_ser12
r_struct
id|modem_state_ser12
(brace
DECL|member|tx_bit
r_int
r_char
id|tx_bit
suffix:semicolon
DECL|member|last_rxbit
r_int
r_char
id|last_rxbit
suffix:semicolon
DECL|member|dcd_sum0
DECL|member|dcd_sum1
DECL|member|dcd_sum2
r_int
id|dcd_sum0
comma
id|dcd_sum1
comma
id|dcd_sum2
suffix:semicolon
DECL|member|dcd_time
r_int
id|dcd_time
suffix:semicolon
DECL|member|pll_time
r_int
r_int
id|pll_time
suffix:semicolon
DECL|member|txshreg
r_int
r_int
id|txshreg
suffix:semicolon
DECL|member|ser12
)brace
id|ser12
suffix:semicolon
DECL|member|modem
)brace
id|modem
suffix:semicolon
macro_line|#ifdef BAYCOM_DEBUG
DECL|struct|debug_vals
r_struct
id|debug_vals
(brace
DECL|member|last_jiffies
r_int
r_int
id|last_jiffies
suffix:semicolon
DECL|member|cur_intcnt
r_int
id|cur_intcnt
suffix:semicolon
DECL|member|last_intcnt
r_int
id|last_intcnt
suffix:semicolon
DECL|member|cur_pllcorr
r_int
id|cur_pllcorr
suffix:semicolon
DECL|member|last_pllcorr
r_int
id|last_pllcorr
suffix:semicolon
DECL|member|debug_vals
)brace
id|debug_vals
suffix:semicolon
macro_line|#endif /* BAYCOM_DEBUG */
)brace
suffix:semicolon
multiline_comment|/* --------------------------------------------------------------------- */
DECL|macro|min
mdefine_line|#define min(a, b) (((a) &lt; (b)) ? (a) : (b))
DECL|macro|max
mdefine_line|#define max(a, b) (((a) &gt; (b)) ? (a) : (b))
multiline_comment|/* --------------------------------------------------------------------- */
DECL|function|baycom_int_freq
r_static
r_void
r_inline
id|baycom_int_freq
c_func
(paren
r_struct
id|baycom_state
op_star
id|bc
)paren
(brace
macro_line|#ifdef BAYCOM_DEBUG
r_int
r_int
id|cur_jiffies
op_assign
id|jiffies
suffix:semicolon
multiline_comment|/*&n;&t; * measure the interrupt frequency&n;&t; */
id|bc-&gt;debug_vals.cur_intcnt
op_increment
suffix:semicolon
r_if
c_cond
(paren
(paren
id|cur_jiffies
op_minus
id|bc-&gt;debug_vals.last_jiffies
)paren
op_ge
id|HZ
)paren
(brace
id|bc-&gt;debug_vals.last_jiffies
op_assign
id|cur_jiffies
suffix:semicolon
id|bc-&gt;debug_vals.last_intcnt
op_assign
id|bc-&gt;debug_vals.cur_intcnt
suffix:semicolon
id|bc-&gt;debug_vals.cur_intcnt
op_assign
l_int|0
suffix:semicolon
id|bc-&gt;debug_vals.last_pllcorr
op_assign
id|bc-&gt;debug_vals.cur_pllcorr
suffix:semicolon
id|bc-&gt;debug_vals.cur_pllcorr
op_assign
l_int|0
suffix:semicolon
)brace
macro_line|#endif /* BAYCOM_DEBUG */
)brace
multiline_comment|/* --------------------------------------------------------------------- */
multiline_comment|/*&n; * ===================== SER12 specific routines =========================&n; */
multiline_comment|/* --------------------------------------------------------------------- */
DECL|function|ser12_set_divisor
r_static
r_inline
r_void
id|ser12_set_divisor
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_int
r_int
id|divisor
)paren
(brace
id|outb
c_func
(paren
l_int|0x81
comma
id|LCR
c_func
(paren
id|dev-&gt;base_addr
)paren
)paren
suffix:semicolon
multiline_comment|/* DLAB = 1 */
id|outb
c_func
(paren
id|divisor
comma
id|DLL
c_func
(paren
id|dev-&gt;base_addr
)paren
)paren
suffix:semicolon
id|outb
c_func
(paren
id|divisor
op_rshift
l_int|8
comma
id|DLM
c_func
(paren
id|dev-&gt;base_addr
)paren
)paren
suffix:semicolon
id|outb
c_func
(paren
l_int|0x01
comma
id|LCR
c_func
(paren
id|dev-&gt;base_addr
)paren
)paren
suffix:semicolon
multiline_comment|/* word length = 6 */
multiline_comment|/*&n;         * make sure the next interrupt is generated;&n;         * 0 must be used to power the modem; the modem draws its&n;         * power from the TxD line&n;         */
id|outb
c_func
(paren
l_int|0x00
comma
id|THR
c_func
(paren
id|dev-&gt;base_addr
)paren
)paren
suffix:semicolon
multiline_comment|/*&n;         * it is important not to set the divider while transmitting;&n;         * this reportedly makes some UARTs generating interrupts&n;         * in the hundredthousands per second region&n;         * Reported by: Ignacio.Arenaza@studi.epfl.ch (Ignacio Arenaza Nuno)&n;         */
)brace
multiline_comment|/* --------------------------------------------------------------------- */
macro_line|#if 0
r_extern
r_inline
r_int
r_int
id|hweight16
c_func
(paren
r_int
r_int
id|w
)paren
id|__attribute__
(paren
(paren
id|unused
)paren
)paren
suffix:semicolon
r_extern
r_inline
r_int
r_int
id|hweight8
c_func
(paren
r_int
r_int
id|w
)paren
id|__attribute__
(paren
(paren
id|unused
)paren
)paren
suffix:semicolon
r_extern
r_inline
r_int
r_int
id|hweight16
c_func
(paren
r_int
r_int
id|w
)paren
(brace
r_int
r_int
id|res
op_assign
(paren
id|w
op_amp
l_int|0x5555
)paren
op_plus
(paren
(paren
id|w
op_rshift
l_int|1
)paren
op_amp
l_int|0x5555
)paren
suffix:semicolon
id|res
op_assign
(paren
id|res
op_amp
l_int|0x3333
)paren
op_plus
(paren
(paren
id|res
op_rshift
l_int|2
)paren
op_amp
l_int|0x3333
)paren
suffix:semicolon
id|res
op_assign
(paren
id|res
op_amp
l_int|0x0F0F
)paren
op_plus
(paren
(paren
id|res
op_rshift
l_int|4
)paren
op_amp
l_int|0x0F0F
)paren
suffix:semicolon
r_return
(paren
id|res
op_amp
l_int|0x00FF
)paren
op_plus
(paren
(paren
id|res
op_rshift
l_int|8
)paren
op_amp
l_int|0x00FF
)paren
suffix:semicolon
)brace
r_extern
r_inline
r_int
r_int
id|hweight8
c_func
(paren
r_int
r_int
id|w
)paren
(brace
r_int
r_int
id|res
op_assign
(paren
id|w
op_amp
l_int|0x55
)paren
op_plus
(paren
(paren
id|w
op_rshift
l_int|1
)paren
op_amp
l_int|0x55
)paren
suffix:semicolon
id|res
op_assign
(paren
id|res
op_amp
l_int|0x33
)paren
op_plus
(paren
(paren
id|res
op_rshift
l_int|2
)paren
op_amp
l_int|0x33
)paren
suffix:semicolon
r_return
(paren
id|res
op_amp
l_int|0x0F
)paren
op_plus
(paren
(paren
id|res
op_rshift
l_int|4
)paren
op_amp
l_int|0x0F
)paren
suffix:semicolon
)brace
macro_line|#endif
multiline_comment|/* --------------------------------------------------------------------- */
DECL|function|ser12_rx
r_static
id|__inline__
r_void
id|ser12_rx
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_struct
id|baycom_state
op_star
id|bc
comma
r_struct
id|timeval
op_star
id|tv
comma
r_int
r_char
id|curs
)paren
(brace
r_int
id|timediff
suffix:semicolon
r_int
id|bdus8
op_assign
id|bc-&gt;baud_us
op_rshift
l_int|3
suffix:semicolon
r_int
id|bdus4
op_assign
id|bc-&gt;baud_us
op_rshift
l_int|2
suffix:semicolon
r_int
id|bdus2
op_assign
id|bc-&gt;baud_us
op_rshift
l_int|1
suffix:semicolon
id|timediff
op_assign
l_int|1000000
op_plus
id|tv-&gt;tv_usec
op_minus
id|bc-&gt;modem.ser12.pll_time
suffix:semicolon
r_while
c_loop
(paren
id|timediff
op_ge
l_int|500000
)paren
id|timediff
op_sub_assign
l_int|1000000
suffix:semicolon
r_while
c_loop
(paren
id|timediff
op_ge
id|bdus2
)paren
(brace
id|timediff
op_sub_assign
id|bc-&gt;baud_us
suffix:semicolon
id|bc-&gt;modem.ser12.pll_time
op_add_assign
id|bc-&gt;baud_us
suffix:semicolon
id|bc-&gt;modem.ser12.dcd_time
op_decrement
suffix:semicolon
multiline_comment|/* first check if there is room to add a bit */
r_if
c_cond
(paren
id|bc-&gt;modem.shreg
op_amp
l_int|1
)paren
(brace
id|hdlcdrv_putbits
c_func
(paren
op_amp
id|bc-&gt;hdrv
comma
(paren
id|bc-&gt;modem.shreg
op_rshift
l_int|1
)paren
op_xor
l_int|0xffff
)paren
suffix:semicolon
id|bc-&gt;modem.shreg
op_assign
l_int|0x10000
suffix:semicolon
)brace
multiline_comment|/* add a one bit */
id|bc-&gt;modem.shreg
op_rshift_assign
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|bc-&gt;modem.ser12.dcd_time
op_le
l_int|0
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|bc-&gt;opt_dcd
)paren
id|hdlcdrv_setdcd
c_func
(paren
op_amp
id|bc-&gt;hdrv
comma
(paren
id|bc-&gt;modem.ser12.dcd_sum0
op_plus
id|bc-&gt;modem.ser12.dcd_sum1
op_plus
id|bc-&gt;modem.ser12.dcd_sum2
)paren
OL
l_int|0
)paren
suffix:semicolon
id|bc-&gt;modem.ser12.dcd_sum2
op_assign
id|bc-&gt;modem.ser12.dcd_sum1
suffix:semicolon
id|bc-&gt;modem.ser12.dcd_sum1
op_assign
id|bc-&gt;modem.ser12.dcd_sum0
suffix:semicolon
id|bc-&gt;modem.ser12.dcd_sum0
op_assign
l_int|2
suffix:semicolon
multiline_comment|/* slight bias */
id|bc-&gt;modem.ser12.dcd_time
op_add_assign
l_int|120
suffix:semicolon
)brace
r_if
c_cond
(paren
id|bc-&gt;modem.ser12.last_rxbit
op_ne
id|curs
)paren
(brace
id|bc-&gt;modem.ser12.last_rxbit
op_assign
id|curs
suffix:semicolon
id|bc-&gt;modem.shreg
op_or_assign
l_int|0x10000
suffix:semicolon
multiline_comment|/* adjust the PLL */
r_if
c_cond
(paren
id|timediff
OG
l_int|0
)paren
id|bc-&gt;modem.ser12.pll_time
op_add_assign
id|bdus8
suffix:semicolon
r_else
id|bc-&gt;modem.ser12.pll_time
op_add_assign
l_int|1000000
op_minus
id|bdus8
suffix:semicolon
multiline_comment|/* update DCD */
r_if
c_cond
(paren
id|abs
c_func
(paren
id|timediff
)paren
OG
id|bdus4
)paren
id|bc-&gt;modem.ser12.dcd_sum0
op_add_assign
l_int|4
suffix:semicolon
r_else
id|bc-&gt;modem.ser12.dcd_sum0
op_decrement
suffix:semicolon
macro_line|#ifdef BAYCOM_DEBUG
id|bc-&gt;debug_vals.cur_pllcorr
op_assign
id|timediff
suffix:semicolon
macro_line|#endif /* BAYCOM_DEBUG */
)brace
r_while
c_loop
(paren
id|bc-&gt;modem.ser12.pll_time
op_ge
l_int|1000000
)paren
id|bc-&gt;modem.ser12.pll_time
op_sub_assign
l_int|1000000
suffix:semicolon
)brace
multiline_comment|/* --------------------------------------------------------------------- */
DECL|function|ser12_interrupt
r_static
r_void
id|ser12_interrupt
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_struct
id|net_device
op_star
id|dev
op_assign
(paren
r_struct
id|net_device
op_star
)paren
id|dev_id
suffix:semicolon
r_struct
id|baycom_state
op_star
id|bc
op_assign
(paren
r_struct
id|baycom_state
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_struct
id|timeval
id|tv
suffix:semicolon
r_int
r_char
id|iir
comma
id|msr
suffix:semicolon
r_int
r_int
id|txcount
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|bc
op_logical_or
id|bc-&gt;hdrv.magic
op_ne
id|HDLCDRV_MAGIC
)paren
r_return
suffix:semicolon
multiline_comment|/* fast way out for shared irq */
r_if
c_cond
(paren
(paren
id|iir
op_assign
id|inb
c_func
(paren
id|IIR
c_func
(paren
id|dev-&gt;base_addr
)paren
)paren
)paren
op_amp
l_int|1
)paren
r_return
suffix:semicolon
multiline_comment|/* get current time */
id|do_gettimeofday
c_func
(paren
op_amp
id|tv
)paren
suffix:semicolon
id|msr
op_assign
id|inb
c_func
(paren
id|MSR
c_func
(paren
id|dev-&gt;base_addr
)paren
)paren
suffix:semicolon
multiline_comment|/* delta DCD */
r_if
c_cond
(paren
(paren
id|msr
op_amp
l_int|8
)paren
op_logical_and
id|bc-&gt;opt_dcd
)paren
id|hdlcdrv_setdcd
c_func
(paren
op_amp
id|bc-&gt;hdrv
comma
op_logical_neg
(paren
(paren
id|msr
op_xor
id|bc-&gt;opt_dcd
)paren
op_amp
l_int|0x80
)paren
)paren
suffix:semicolon
r_do
(brace
r_switch
c_cond
(paren
id|iir
op_amp
l_int|6
)paren
(brace
r_case
l_int|6
suffix:colon
id|inb
c_func
(paren
id|LSR
c_func
(paren
id|dev-&gt;base_addr
)paren
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|4
suffix:colon
id|inb
c_func
(paren
id|RBR
c_func
(paren
id|dev-&gt;base_addr
)paren
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|2
suffix:colon
multiline_comment|/*&n;&t;&t;&t; * make sure the next interrupt is generated;&n;&t;&t;&t; * 0 must be used to power the modem; the modem draws its&n;&t;&t;&t; * power from the TxD line&n;&t;&t;&t; */
id|outb
c_func
(paren
l_int|0x00
comma
id|THR
c_func
(paren
id|dev-&gt;base_addr
)paren
)paren
suffix:semicolon
id|baycom_int_freq
c_func
(paren
id|bc
)paren
suffix:semicolon
id|txcount
op_increment
suffix:semicolon
multiline_comment|/*&n;&t;&t;&t; * first output the last bit (!) then call HDLC transmitter,&n;&t;&t;&t; * since this may take quite long&n;&t;&t;&t; */
r_if
c_cond
(paren
id|bc-&gt;modem.ptt
)paren
id|outb
c_func
(paren
l_int|0x0e
op_or
(paren
op_logical_neg
op_logical_neg
id|bc-&gt;modem.ser12.tx_bit
)paren
comma
id|MCR
c_func
(paren
id|dev-&gt;base_addr
)paren
)paren
suffix:semicolon
r_else
id|outb
c_func
(paren
l_int|0x0d
comma
id|MCR
c_func
(paren
id|dev-&gt;base_addr
)paren
)paren
suffix:semicolon
multiline_comment|/* transmitter off */
r_break
suffix:semicolon
r_default
suffix:colon
id|msr
op_assign
id|inb
c_func
(paren
id|MSR
c_func
(paren
id|dev-&gt;base_addr
)paren
)paren
suffix:semicolon
multiline_comment|/* delta DCD */
r_if
c_cond
(paren
(paren
id|msr
op_amp
l_int|8
)paren
op_logical_and
id|bc-&gt;opt_dcd
)paren
id|hdlcdrv_setdcd
c_func
(paren
op_amp
id|bc-&gt;hdrv
comma
op_logical_neg
(paren
(paren
id|msr
op_xor
id|bc-&gt;opt_dcd
)paren
op_amp
l_int|0x80
)paren
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|iir
op_assign
id|inb
c_func
(paren
id|IIR
c_func
(paren
id|dev-&gt;base_addr
)paren
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
op_logical_neg
(paren
id|iir
op_amp
l_int|1
)paren
)paren
suffix:semicolon
id|ser12_rx
c_func
(paren
id|dev
comma
id|bc
comma
op_amp
id|tv
comma
id|msr
op_amp
l_int|0x10
)paren
suffix:semicolon
multiline_comment|/* CTS */
r_if
c_cond
(paren
id|bc-&gt;modem.ptt
op_logical_and
id|txcount
)paren
(brace
r_if
c_cond
(paren
id|bc-&gt;modem.ser12.txshreg
op_le
l_int|1
)paren
(brace
id|bc-&gt;modem.ser12.txshreg
op_assign
l_int|0x10000
op_or
id|hdlcdrv_getbits
c_func
(paren
op_amp
id|bc-&gt;hdrv
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|hdlcdrv_ptt
c_func
(paren
op_amp
id|bc-&gt;hdrv
)paren
)paren
(brace
id|ser12_set_divisor
c_func
(paren
id|dev
comma
l_int|115200
op_div
l_int|100
op_div
l_int|8
)paren
suffix:semicolon
id|bc-&gt;modem.ptt
op_assign
l_int|0
suffix:semicolon
r_goto
id|end_transmit
suffix:semicolon
)brace
)brace
id|bc-&gt;modem.ser12.tx_bit
op_assign
op_logical_neg
(paren
id|bc-&gt;modem.ser12.tx_bit
op_xor
(paren
id|bc-&gt;modem.ser12.txshreg
op_amp
l_int|1
)paren
)paren
suffix:semicolon
id|bc-&gt;modem.ser12.txshreg
op_rshift_assign
l_int|1
suffix:semicolon
)brace
id|end_transmit
suffix:colon
id|__sti
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|bc-&gt;modem.ptt
op_logical_and
id|txcount
)paren
(brace
id|hdlcdrv_arbitrate
c_func
(paren
id|dev
comma
op_amp
id|bc-&gt;hdrv
)paren
suffix:semicolon
r_if
c_cond
(paren
id|hdlcdrv_ptt
c_func
(paren
op_amp
id|bc-&gt;hdrv
)paren
)paren
(brace
id|ser12_set_divisor
c_func
(paren
id|dev
comma
id|bc-&gt;baud_uartdiv
)paren
suffix:semicolon
id|bc-&gt;modem.ser12.txshreg
op_assign
l_int|1
suffix:semicolon
id|bc-&gt;modem.ptt
op_assign
l_int|1
suffix:semicolon
)brace
)brace
id|hdlcdrv_transmitter
c_func
(paren
id|dev
comma
op_amp
id|bc-&gt;hdrv
)paren
suffix:semicolon
id|hdlcdrv_receiver
c_func
(paren
id|dev
comma
op_amp
id|bc-&gt;hdrv
)paren
suffix:semicolon
id|__cli
c_func
(paren
)paren
suffix:semicolon
)brace
multiline_comment|/* --------------------------------------------------------------------- */
DECL|enum|uart
DECL|enumerator|c_uart_unknown
DECL|enumerator|c_uart_8250
r_enum
id|uart
(brace
id|c_uart_unknown
comma
id|c_uart_8250
comma
DECL|enumerator|c_uart_16450
DECL|enumerator|c_uart_16550
DECL|enumerator|c_uart_16550A
id|c_uart_16450
comma
id|c_uart_16550
comma
id|c_uart_16550A
)brace
suffix:semicolon
DECL|variable|uart_str
r_static
r_const
r_char
op_star
id|uart_str
(braket
)braket
op_assign
(brace
l_string|&quot;unknown&quot;
comma
l_string|&quot;8250&quot;
comma
l_string|&quot;16450&quot;
comma
l_string|&quot;16550&quot;
comma
l_string|&quot;16550A&quot;
)brace
suffix:semicolon
DECL|function|ser12_check_uart
r_static
r_enum
id|uart
id|ser12_check_uart
c_func
(paren
r_int
r_int
id|iobase
)paren
(brace
r_int
r_char
id|b1
comma
id|b2
comma
id|b3
suffix:semicolon
r_enum
id|uart
id|u
suffix:semicolon
r_enum
id|uart
id|uart_tab
(braket
)braket
op_assign
(brace
id|c_uart_16450
comma
id|c_uart_unknown
comma
id|c_uart_16550
comma
id|c_uart_16550A
)brace
suffix:semicolon
id|b1
op_assign
id|inb
c_func
(paren
id|MCR
c_func
(paren
id|iobase
)paren
)paren
suffix:semicolon
id|outb
c_func
(paren
id|b1
op_or
l_int|0x10
comma
id|MCR
c_func
(paren
id|iobase
)paren
)paren
suffix:semicolon
multiline_comment|/* loopback mode */
id|b2
op_assign
id|inb
c_func
(paren
id|MSR
c_func
(paren
id|iobase
)paren
)paren
suffix:semicolon
id|outb
c_func
(paren
l_int|0x1a
comma
id|MCR
c_func
(paren
id|iobase
)paren
)paren
suffix:semicolon
id|b3
op_assign
id|inb
c_func
(paren
id|MSR
c_func
(paren
id|iobase
)paren
)paren
op_amp
l_int|0xf0
suffix:semicolon
id|outb
c_func
(paren
id|b1
comma
id|MCR
c_func
(paren
id|iobase
)paren
)paren
suffix:semicolon
multiline_comment|/* restore old values */
id|outb
c_func
(paren
id|b2
comma
id|MSR
c_func
(paren
id|iobase
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|b3
op_ne
l_int|0x90
)paren
r_return
id|c_uart_unknown
suffix:semicolon
id|inb
c_func
(paren
id|RBR
c_func
(paren
id|iobase
)paren
)paren
suffix:semicolon
id|inb
c_func
(paren
id|RBR
c_func
(paren
id|iobase
)paren
)paren
suffix:semicolon
id|outb
c_func
(paren
l_int|0x01
comma
id|FCR
c_func
(paren
id|iobase
)paren
)paren
suffix:semicolon
multiline_comment|/* enable FIFOs */
id|u
op_assign
id|uart_tab
(braket
(paren
id|inb
c_func
(paren
id|IIR
c_func
(paren
id|iobase
)paren
)paren
op_rshift
l_int|6
)paren
op_amp
l_int|3
)braket
suffix:semicolon
r_if
c_cond
(paren
id|u
op_eq
id|c_uart_16450
)paren
(brace
id|outb
c_func
(paren
l_int|0x5a
comma
id|SCR
c_func
(paren
id|iobase
)paren
)paren
suffix:semicolon
id|b1
op_assign
id|inb
c_func
(paren
id|SCR
c_func
(paren
id|iobase
)paren
)paren
suffix:semicolon
id|outb
c_func
(paren
l_int|0xa5
comma
id|SCR
c_func
(paren
id|iobase
)paren
)paren
suffix:semicolon
id|b2
op_assign
id|inb
c_func
(paren
id|SCR
c_func
(paren
id|iobase
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|b1
op_ne
l_int|0x5a
)paren
op_logical_or
(paren
id|b2
op_ne
l_int|0xa5
)paren
)paren
id|u
op_assign
id|c_uart_8250
suffix:semicolon
)brace
r_return
id|u
suffix:semicolon
)brace
multiline_comment|/* --------------------------------------------------------------------- */
DECL|function|ser12_open
r_static
r_int
id|ser12_open
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|baycom_state
op_star
id|bc
op_assign
(paren
r_struct
id|baycom_state
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_enum
id|uart
id|u
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dev
op_logical_or
op_logical_neg
id|bc
)paren
r_return
op_minus
id|ENXIO
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dev-&gt;base_addr
op_logical_or
id|dev-&gt;base_addr
OG
l_int|0x1000
op_minus
id|SER12_EXTENT
op_logical_or
id|dev-&gt;irq
template_param
l_int|15
)paren
r_return
op_minus
id|ENXIO
suffix:semicolon
r_if
c_cond
(paren
id|bc-&gt;baud
template_param
l_int|4800
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|check_region
c_func
(paren
id|dev-&gt;base_addr
comma
id|SER12_EXTENT
)paren
)paren
r_return
op_minus
id|EACCES
suffix:semicolon
id|memset
c_func
(paren
op_amp
id|bc-&gt;modem
comma
l_int|0
comma
r_sizeof
(paren
id|bc-&gt;modem
)paren
)paren
suffix:semicolon
id|bc-&gt;hdrv.par.bitrate
op_assign
id|bc-&gt;baud
suffix:semicolon
id|bc-&gt;baud_us
op_assign
l_int|1000000
op_div
id|bc-&gt;baud
suffix:semicolon
id|bc-&gt;baud_uartdiv
op_assign
(paren
l_int|115200
op_div
l_int|8
)paren
op_div
id|bc-&gt;baud
suffix:semicolon
r_if
c_cond
(paren
(paren
id|u
op_assign
id|ser12_check_uart
c_func
(paren
id|dev-&gt;base_addr
)paren
)paren
op_eq
id|c_uart_unknown
)paren
r_return
op_minus
id|EIO
suffix:semicolon
id|outb
c_func
(paren
l_int|0
comma
id|FCR
c_func
(paren
id|dev-&gt;base_addr
)paren
)paren
suffix:semicolon
multiline_comment|/* disable FIFOs */
id|outb
c_func
(paren
l_int|0x0d
comma
id|MCR
c_func
(paren
id|dev-&gt;base_addr
)paren
)paren
suffix:semicolon
id|outb
c_func
(paren
l_int|0
comma
id|IER
c_func
(paren
id|dev-&gt;base_addr
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|request_irq
c_func
(paren
id|dev-&gt;irq
comma
id|ser12_interrupt
comma
id|SA_INTERRUPT
op_or
id|SA_SHIRQ
comma
l_string|&quot;baycom_ser_fdx&quot;
comma
id|dev
)paren
)paren
r_return
op_minus
id|EBUSY
suffix:semicolon
id|request_region
c_func
(paren
id|dev-&gt;base_addr
comma
id|SER12_EXTENT
comma
l_string|&quot;baycom_ser_fdx&quot;
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * set the SIO to 6 Bits/character; during receive,&n;&t; * the baud rate is set to produce 100 ints/sec&n;&t; * to feed the channel arbitration process,&n;&t; * during transmit to baud ints/sec to run&n;&t; * the transmitter&n;&t; */
id|ser12_set_divisor
c_func
(paren
id|dev
comma
l_int|115200
op_div
l_int|100
op_div
l_int|8
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * enable transmitter empty interrupt and modem status interrupt&n;&t; */
id|outb
c_func
(paren
l_int|0x0a
comma
id|IER
c_func
(paren
id|dev-&gt;base_addr
)paren
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * make sure the next interrupt is generated;&n;&t; * 0 must be used to power the modem; the modem draws its&n;&t; * power from the TxD line&n;&t; */
id|outb
c_func
(paren
l_int|0x00
comma
id|THR
c_func
(paren
id|dev-&gt;base_addr
)paren
)paren
suffix:semicolon
id|hdlcdrv_setdcd
c_func
(paren
op_amp
id|bc-&gt;hdrv
comma
l_int|0
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: ser_fdx at iobase 0x%lx irq %u baud %u uart %s&bslash;n&quot;
comma
id|bc_drvname
comma
id|dev-&gt;base_addr
comma
id|dev-&gt;irq
comma
id|bc-&gt;baud
comma
id|uart_str
(braket
id|u
)braket
)paren
suffix:semicolon
id|MOD_INC_USE_COUNT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* --------------------------------------------------------------------- */
DECL|function|ser12_close
r_static
r_int
id|ser12_close
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|baycom_state
op_star
id|bc
op_assign
(paren
r_struct
id|baycom_state
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dev
op_logical_or
op_logical_neg
id|bc
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
multiline_comment|/*&n;&t; * disable interrupts&n;&t; */
id|outb
c_func
(paren
l_int|0
comma
id|IER
c_func
(paren
id|dev-&gt;base_addr
)paren
)paren
suffix:semicolon
id|outb
c_func
(paren
l_int|1
comma
id|MCR
c_func
(paren
id|dev-&gt;base_addr
)paren
)paren
suffix:semicolon
id|free_irq
c_func
(paren
id|dev-&gt;irq
comma
id|dev
)paren
suffix:semicolon
id|release_region
c_func
(paren
id|dev-&gt;base_addr
comma
id|SER12_EXTENT
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: close ser_fdx at iobase 0x%lx irq %u&bslash;n&quot;
comma
id|bc_drvname
comma
id|dev-&gt;base_addr
comma
id|dev-&gt;irq
)paren
suffix:semicolon
id|MOD_DEC_USE_COUNT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* --------------------------------------------------------------------- */
multiline_comment|/*&n; * ===================== hdlcdrv driver interface =========================&n; */
multiline_comment|/* --------------------------------------------------------------------- */
r_static
r_int
id|baycom_ioctl
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_struct
id|ifreq
op_star
id|ifr
comma
r_struct
id|hdlcdrv_ioctl
op_star
id|hi
comma
r_int
id|cmd
)paren
suffix:semicolon
multiline_comment|/* --------------------------------------------------------------------- */
DECL|variable|ser12_ops
r_static
r_struct
id|hdlcdrv_ops
id|ser12_ops
op_assign
(brace
id|bc_drvname
comma
id|bc_drvinfo
comma
id|ser12_open
comma
id|ser12_close
comma
id|baycom_ioctl
)brace
suffix:semicolon
multiline_comment|/* --------------------------------------------------------------------- */
DECL|function|baycom_setmode
r_static
r_int
id|baycom_setmode
c_func
(paren
r_struct
id|baycom_state
op_star
id|bc
comma
r_const
r_char
op_star
id|modestr
)paren
(brace
r_int
r_int
id|baud
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|strncmp
c_func
(paren
id|modestr
comma
l_string|&quot;ser&quot;
comma
l_int|3
)paren
)paren
(brace
id|baud
op_assign
id|simple_strtoul
c_func
(paren
id|modestr
op_plus
l_int|3
comma
l_int|NULL
comma
l_int|10
)paren
suffix:semicolon
r_if
c_cond
(paren
id|baud
op_ge
l_int|3
op_logical_and
id|baud
op_le
l_int|48
)paren
id|bc-&gt;baud
op_assign
id|baud
op_star
l_int|100
suffix:semicolon
)brace
r_if
c_cond
(paren
id|strchr
c_func
(paren
id|modestr
comma
l_char|&squot;*&squot;
)paren
)paren
id|bc-&gt;opt_dcd
op_assign
l_int|0
suffix:semicolon
r_else
r_if
c_cond
(paren
id|strchr
c_func
(paren
id|modestr
comma
l_char|&squot;+&squot;
)paren
)paren
id|bc-&gt;opt_dcd
op_assign
op_minus
l_int|1
suffix:semicolon
r_else
id|bc-&gt;opt_dcd
op_assign
l_int|1
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* --------------------------------------------------------------------- */
DECL|function|baycom_ioctl
r_static
r_int
id|baycom_ioctl
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_struct
id|ifreq
op_star
id|ifr
comma
r_struct
id|hdlcdrv_ioctl
op_star
id|hi
comma
r_int
id|cmd
)paren
(brace
r_struct
id|baycom_state
op_star
id|bc
suffix:semicolon
r_struct
id|baycom_ioctl
id|bi
suffix:semicolon
r_int
id|cmd2
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dev
op_logical_or
op_logical_neg
id|dev-&gt;priv
op_logical_or
(paren
(paren
r_struct
id|baycom_state
op_star
)paren
id|dev-&gt;priv
)paren
op_member_access_from_pointer
id|hdrv.magic
op_ne
id|HDLCDRV_MAGIC
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;bc_ioctl: invalid device struct&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|bc
op_assign
(paren
r_struct
id|baycom_state
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_if
c_cond
(paren
id|cmd
op_ne
id|SIOCDEVPRIVATE
)paren
r_return
op_minus
id|ENOIOCTLCMD
suffix:semicolon
r_if
c_cond
(paren
id|get_user
c_func
(paren
id|cmd2
comma
(paren
r_int
op_star
)paren
id|ifr-&gt;ifr_data
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_switch
c_cond
(paren
id|hi-&gt;cmd
)paren
(brace
r_default
suffix:colon
r_break
suffix:semicolon
r_case
id|HDLCDRVCTL_GETMODE
suffix:colon
id|sprintf
c_func
(paren
id|hi-&gt;data.modename
comma
l_string|&quot;ser%u&quot;
comma
id|bc-&gt;baud
op_div
l_int|100
)paren
suffix:semicolon
r_if
c_cond
(paren
id|bc-&gt;opt_dcd
op_le
l_int|0
)paren
id|strcat
c_func
(paren
id|hi-&gt;data.modename
comma
(paren
op_logical_neg
id|bc-&gt;opt_dcd
)paren
ques
c_cond
l_string|&quot;*&quot;
suffix:colon
l_string|&quot;+&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
id|ifr-&gt;ifr_data
comma
id|hi
comma
r_sizeof
(paren
r_struct
id|hdlcdrv_ioctl
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
r_case
id|HDLCDRVCTL_SETMODE
suffix:colon
r_if
c_cond
(paren
id|netif_running
c_func
(paren
id|dev
)paren
op_logical_or
op_logical_neg
id|capable
c_func
(paren
id|CAP_NET_ADMIN
)paren
)paren
r_return
op_minus
id|EACCES
suffix:semicolon
id|hi-&gt;data.modename
(braket
r_sizeof
(paren
id|hi-&gt;data.modename
)paren
op_minus
l_int|1
)braket
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
r_return
id|baycom_setmode
c_func
(paren
id|bc
comma
id|hi-&gt;data.modename
)paren
suffix:semicolon
r_case
id|HDLCDRVCTL_MODELIST
suffix:colon
id|strcpy
c_func
(paren
id|hi-&gt;data.modename
comma
l_string|&quot;ser12,ser3,ser24&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
id|ifr-&gt;ifr_data
comma
id|hi
comma
r_sizeof
(paren
r_struct
id|hdlcdrv_ioctl
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
r_case
id|HDLCDRVCTL_MODEMPARMASK
suffix:colon
r_return
id|HDLCDRV_PARMASK_IOBASE
op_or
id|HDLCDRV_PARMASK_IRQ
suffix:semicolon
)brace
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|bi
comma
id|ifr-&gt;ifr_data
comma
r_sizeof
(paren
id|bi
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_switch
c_cond
(paren
id|bi.cmd
)paren
(brace
r_default
suffix:colon
r_return
op_minus
id|ENOIOCTLCMD
suffix:semicolon
macro_line|#ifdef BAYCOM_DEBUG
r_case
id|BAYCOMCTL_GETDEBUG
suffix:colon
id|bi.data.dbg.debug1
op_assign
id|bc-&gt;hdrv.ptt_keyed
suffix:semicolon
id|bi.data.dbg.debug2
op_assign
id|bc-&gt;debug_vals.last_intcnt
suffix:semicolon
id|bi.data.dbg.debug3
op_assign
id|bc-&gt;debug_vals.last_pllcorr
suffix:semicolon
r_break
suffix:semicolon
macro_line|#endif /* BAYCOM_DEBUG */
)brace
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
id|ifr-&gt;ifr_data
comma
op_amp
id|bi
comma
r_sizeof
(paren
id|bi
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* --------------------------------------------------------------------- */
multiline_comment|/*&n; * command line settable parameters&n; */
DECL|variable|mode
r_static
r_char
op_star
id|mode
(braket
id|NR_PORTS
)braket
op_assign
(brace
l_string|&quot;ser12*&quot;
comma
)brace
suffix:semicolon
DECL|variable|iobase
r_static
r_int
id|iobase
(braket
id|NR_PORTS
)braket
op_assign
(brace
l_int|0x3f8
comma
)brace
suffix:semicolon
DECL|variable|irq
r_static
r_int
id|irq
(braket
id|NR_PORTS
)braket
op_assign
(brace
l_int|4
comma
)brace
suffix:semicolon
DECL|variable|baud
r_static
r_int
id|baud
(braket
id|NR_PORTS
)braket
op_assign
(brace
(braket
l_int|0
dot
dot
dot
id|NR_PORTS
op_minus
l_int|1
)braket
op_assign
l_int|1200
)brace
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|mode
comma
l_string|&quot;1-&quot;
id|__MODULE_STRING
c_func
(paren
id|NR_PORTS
)paren
l_string|&quot;s&quot;
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|mode
comma
l_string|&quot;baycom operating mode; * for software DCD&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|iobase
comma
l_string|&quot;1-&quot;
id|__MODULE_STRING
c_func
(paren
id|NR_PORTS
)paren
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|iobase
comma
l_string|&quot;baycom io base address&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|irq
comma
l_string|&quot;1-&quot;
id|__MODULE_STRING
c_func
(paren
id|NR_PORTS
)paren
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|irq
comma
l_string|&quot;baycom irq number&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|baud
comma
l_string|&quot;1-&quot;
id|__MODULE_STRING
c_func
(paren
id|NR_PORTS
)paren
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|baud
comma
l_string|&quot;baycom baud rate (300 to 4800)&quot;
)paren
suffix:semicolon
id|MODULE_AUTHOR
c_func
(paren
l_string|&quot;Thomas M. Sailer, sailer@ife.ee.ethz.ch, hb9jnx@hb9w.che.eu&quot;
)paren
suffix:semicolon
id|MODULE_DESCRIPTION
c_func
(paren
l_string|&quot;Baycom ser12 full duplex amateur radio modem driver&quot;
)paren
suffix:semicolon
multiline_comment|/* --------------------------------------------------------------------- */
DECL|function|init_baycomserfdx
r_static
r_int
id|__init
id|init_baycomserfdx
c_func
(paren
r_void
)paren
(brace
r_int
id|i
comma
id|j
comma
id|found
op_assign
l_int|0
suffix:semicolon
r_char
id|set_hw
op_assign
l_int|1
suffix:semicolon
r_struct
id|baycom_state
op_star
id|bc
suffix:semicolon
id|printk
c_func
(paren
id|bc_drvinfo
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * register net devices&n;&t; */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|NR_PORTS
suffix:semicolon
id|i
op_increment
)paren
(brace
r_struct
id|net_device
op_star
id|dev
op_assign
id|baycom_device
op_plus
id|i
suffix:semicolon
r_char
id|ifname
(braket
id|IFNAMSIZ
)braket
suffix:semicolon
id|sprintf
c_func
(paren
id|ifname
comma
l_string|&quot;bcsf%d&quot;
comma
id|i
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|mode
(braket
id|i
)braket
)paren
id|set_hw
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|set_hw
)paren
id|iobase
(braket
id|i
)braket
op_assign
id|irq
(braket
id|i
)braket
op_assign
l_int|0
suffix:semicolon
id|j
op_assign
id|hdlcdrv_register_hdlcdrv
c_func
(paren
id|dev
comma
op_amp
id|ser12_ops
comma
r_sizeof
(paren
r_struct
id|baycom_state
)paren
comma
id|ifname
comma
id|iobase
(braket
id|i
)braket
comma
id|irq
(braket
id|i
)braket
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|j
)paren
(brace
id|bc
op_assign
(paren
r_struct
id|baycom_state
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_if
c_cond
(paren
id|set_hw
op_logical_and
id|baycom_setmode
c_func
(paren
id|bc
comma
id|mode
(braket
id|i
)braket
)paren
)paren
id|set_hw
op_assign
l_int|0
suffix:semicolon
id|bc-&gt;baud
op_assign
id|baud
(braket
id|i
)braket
suffix:semicolon
id|found
op_increment
suffix:semicolon
)brace
r_else
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: cannot register net device&bslash;n&quot;
comma
id|bc_drvname
)paren
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
op_logical_neg
id|found
)paren
r_return
op_minus
id|ENXIO
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|cleanup_baycomserfdx
r_static
r_void
id|__exit
id|cleanup_baycomserfdx
c_func
(paren
r_void
)paren
(brace
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|NR_PORTS
suffix:semicolon
id|i
op_increment
)paren
(brace
r_struct
id|net_device
op_star
id|dev
op_assign
id|baycom_device
op_plus
id|i
suffix:semicolon
r_struct
id|baycom_state
op_star
id|bc
op_assign
(paren
r_struct
id|baycom_state
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_if
c_cond
(paren
id|bc
)paren
(brace
r_if
c_cond
(paren
id|bc-&gt;hdrv.magic
op_ne
id|HDLCDRV_MAGIC
)paren
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;baycom: invalid magic in &quot;
l_string|&quot;cleanup_module&bslash;n&quot;
)paren
suffix:semicolon
r_else
id|hdlcdrv_unregister_hdlcdrv
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
)brace
)brace
DECL|variable|init_baycomserfdx
id|module_init
c_func
(paren
id|init_baycomserfdx
)paren
suffix:semicolon
DECL|variable|cleanup_baycomserfdx
id|module_exit
c_func
(paren
id|cleanup_baycomserfdx
)paren
suffix:semicolon
multiline_comment|/* --------------------------------------------------------------------- */
macro_line|#ifndef MODULE
multiline_comment|/*&n; * format: baycom_ser_fdx=io,irq,mode&n; * mode: ser#    hardware DCD&n; *       ser#*   software DCD&n; *       ser#+   hardware DCD, inverted signal at DCD pin&n; * &squot;#&squot; denotes the baud rate / 100, eg. ser12* is &squot;1200 baud, soft DCD&squot;&n; */
DECL|function|baycom_ser_fdx_setup
r_static
r_int
id|__init
id|baycom_ser_fdx_setup
c_func
(paren
r_char
op_star
id|str
)paren
(brace
r_static
r_int
id|nr_dev
op_assign
l_int|0
suffix:semicolon
r_int
id|ints
(braket
l_int|4
)braket
suffix:semicolon
r_if
c_cond
(paren
id|nr_dev
op_ge
id|NR_PORTS
)paren
r_return
l_int|0
suffix:semicolon
id|str
op_assign
id|get_options
c_func
(paren
id|str
comma
l_int|4
comma
id|ints
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ints
(braket
l_int|0
)braket
OL
l_int|2
)paren
r_return
l_int|0
suffix:semicolon
id|mode
(braket
id|nr_dev
)braket
op_assign
id|str
suffix:semicolon
id|iobase
(braket
id|nr_dev
)braket
op_assign
id|ints
(braket
l_int|1
)braket
suffix:semicolon
id|irq
(braket
id|nr_dev
)braket
op_assign
id|ints
(braket
l_int|2
)braket
suffix:semicolon
r_if
c_cond
(paren
id|ints
(braket
l_int|0
)braket
op_ge
l_int|3
)paren
id|baud
(braket
id|nr_dev
)braket
op_assign
id|ints
(braket
l_int|3
)braket
suffix:semicolon
id|nr_dev
op_increment
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
id|__setup
c_func
(paren
l_string|&quot;baycom_ser_fdx=&quot;
comma
id|baycom_ser_fdx_setup
)paren
suffix:semicolon
macro_line|#endif /* MODULE */
multiline_comment|/* --------------------------------------------------------------------- */
eof
