multiline_comment|/*&n; * $Id: dmascc.c,v 1.2 1997/12/02 16:49:49 oe1kib Exp $&n; *&n; * Driver for high-speed SCC boards (those with DMA support)&n; * Copyright (C) 1997 Klaus Kudielka&n; *&n; * This program is free software; you can redistribute it and/or modify&n; * it under the terms of the GNU General Public License as published by&n; * the Free Software Foundation; either version 2 of the License, or&n; * (at your option) any later version.&n; *&n; * This program is distributed in the hope that it will be useful,&n; * but WITHOUT ANY WARRANTY; without even the implied warranty of&n; * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the&n; * GNU General Public License for more details.&n; *&n; * You should have received a copy of the GNU General Public License&n; * along with this program; if not, write to the Free Software&n; * Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.&n; */
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/dmascc.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/if_arp.h&gt;
macro_line|#include &lt;linux/in.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/interrupt.h&gt;
macro_line|#include &lt;linux/ioport.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/mm.h&gt;
macro_line|#include &lt;linux/netdevice.h&gt;
macro_line|#include &lt;linux/sockios.h&gt;
macro_line|#include &lt;linux/tqueue.h&gt;
macro_line|#include &lt;linux/version.h&gt;
macro_line|#include &lt;asm/atomic.h&gt;
macro_line|#include &lt;asm/bitops.h&gt;
macro_line|#include &lt;asm/dma.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/irq.h&gt;
macro_line|#include &lt;asm/segment.h&gt;
macro_line|#include &lt;asm/uaccess.h&gt;
macro_line|#include &lt;net/ax25.h&gt;
macro_line|#include &lt;stdio.h&gt;
macro_line|#include &quot;z8530.h&quot;
multiline_comment|/* Number of buffers per channel */
DECL|macro|NUM_TX_BUF
mdefine_line|#define NUM_TX_BUF      2          /* NUM_TX_BUF &gt;= 1 (2 recommended) */
DECL|macro|NUM_RX_BUF
mdefine_line|#define NUM_RX_BUF      2          /* NUM_RX_BUF &gt;= 1 (2 recommended) */
DECL|macro|BUF_SIZE
mdefine_line|#define BUF_SIZE        2016
multiline_comment|/* Cards supported */
DECL|macro|HW_PI
mdefine_line|#define HW_PI           { &quot;Ottawa PI&quot;, 0x300, 0x20, 0x10, 8, &bslash;&n;                            0, 8, 1843200, 3686400 }
DECL|macro|HW_PI2
mdefine_line|#define HW_PI2          { &quot;Ottawa PI2&quot;, 0x300, 0x20, 0x10, 8, &bslash;&n;&t;&t;&t;    0, 8, 3686400, 7372800 }
DECL|macro|HW_TWIN
mdefine_line|#define HW_TWIN         { &quot;Gracilis PackeTwin&quot;, 0x200, 0x10, 0x10, 32, &bslash;&n;&t;&t;&t;    0, 4, 6144000, 6144000 }
DECL|macro|HARDWARE
mdefine_line|#define HARDWARE        { HW_PI, HW_PI2, HW_TWIN }
DECL|macro|TYPE_PI
mdefine_line|#define TYPE_PI         0
DECL|macro|TYPE_PI2
mdefine_line|#define TYPE_PI2        1
DECL|macro|TYPE_TWIN
mdefine_line|#define TYPE_TWIN       2
DECL|macro|NUM_TYPES
mdefine_line|#define NUM_TYPES       3
DECL|macro|MAX_NUM_DEVS
mdefine_line|#define MAX_NUM_DEVS    32
multiline_comment|/* SCC chips supported */
DECL|macro|Z8530
mdefine_line|#define Z8530           0
DECL|macro|Z85C30
mdefine_line|#define Z85C30          1
DECL|macro|Z85230
mdefine_line|#define Z85230          2
DECL|macro|CHIPNAMES
mdefine_line|#define CHIPNAMES       { &quot;Z8530&quot;, &quot;Z85C30&quot;, &quot;Z85230&quot; }
multiline_comment|/* I/O registers */
multiline_comment|/* 8530 registers relative to card base */
DECL|macro|SCCB_CMD
mdefine_line|#define SCCB_CMD        0x00
DECL|macro|SCCB_DATA
mdefine_line|#define SCCB_DATA       0x01
DECL|macro|SCCA_CMD
mdefine_line|#define SCCA_CMD        0x02
DECL|macro|SCCA_DATA
mdefine_line|#define SCCA_DATA       0x03
multiline_comment|/* 8254 registers relative to card base */
DECL|macro|TMR_CNT0
mdefine_line|#define TMR_CNT0        0x00
DECL|macro|TMR_CNT1
mdefine_line|#define TMR_CNT1        0x01
DECL|macro|TMR_CNT2
mdefine_line|#define TMR_CNT2        0x02
DECL|macro|TMR_CTRL
mdefine_line|#define TMR_CTRL        0x03
multiline_comment|/* Additional PI/PI2 registers relative to card base */
DECL|macro|PI_DREQ_MASK
mdefine_line|#define PI_DREQ_MASK    0x04
multiline_comment|/* Additional PackeTwin registers relative to card base */
DECL|macro|TWIN_INT_REG
mdefine_line|#define TWIN_INT_REG    0x08
DECL|macro|TWIN_CLR_TMR1
mdefine_line|#define TWIN_CLR_TMR1   0x09
DECL|macro|TWIN_CLR_TMR2
mdefine_line|#define TWIN_CLR_TMR2   0x0a
DECL|macro|TWIN_SPARE_1
mdefine_line|#define TWIN_SPARE_1    0x0b
DECL|macro|TWIN_DMA_CFG
mdefine_line|#define TWIN_DMA_CFG    0x08
DECL|macro|TWIN_SERIAL_CFG
mdefine_line|#define TWIN_SERIAL_CFG 0x09
DECL|macro|TWIN_DMA_CLR_FF
mdefine_line|#define TWIN_DMA_CLR_FF 0x0a
DECL|macro|TWIN_SPARE_2
mdefine_line|#define TWIN_SPARE_2    0x0b
multiline_comment|/* PackeTwin I/O register values */
multiline_comment|/* INT_REG */
DECL|macro|TWIN_SCC_MSK
mdefine_line|#define TWIN_SCC_MSK       0x01
DECL|macro|TWIN_TMR1_MSK
mdefine_line|#define TWIN_TMR1_MSK      0x02
DECL|macro|TWIN_TMR2_MSK
mdefine_line|#define TWIN_TMR2_MSK      0x04
DECL|macro|TWIN_INT_MSK
mdefine_line|#define TWIN_INT_MSK       0x07
multiline_comment|/* SERIAL_CFG */
DECL|macro|TWIN_DTRA_ON
mdefine_line|#define TWIN_DTRA_ON       0x01
DECL|macro|TWIN_DTRB_ON
mdefine_line|#define TWIN_DTRB_ON       0x02
DECL|macro|TWIN_EXTCLKA
mdefine_line|#define TWIN_EXTCLKA       0x04
DECL|macro|TWIN_EXTCLKB
mdefine_line|#define TWIN_EXTCLKB       0x08
DECL|macro|TWIN_LOOPA_ON
mdefine_line|#define TWIN_LOOPA_ON      0x10
DECL|macro|TWIN_LOOPB_ON
mdefine_line|#define TWIN_LOOPB_ON      0x20
DECL|macro|TWIN_EI
mdefine_line|#define TWIN_EI            0x80
multiline_comment|/* DMA_CFG */
DECL|macro|TWIN_DMA_HDX_T1
mdefine_line|#define TWIN_DMA_HDX_T1    0x08
DECL|macro|TWIN_DMA_HDX_R1
mdefine_line|#define TWIN_DMA_HDX_R1    0x0a
DECL|macro|TWIN_DMA_HDX_T3
mdefine_line|#define TWIN_DMA_HDX_T3    0x14
DECL|macro|TWIN_DMA_HDX_R3
mdefine_line|#define TWIN_DMA_HDX_R3    0x16
DECL|macro|TWIN_DMA_FDX_T3R1
mdefine_line|#define TWIN_DMA_FDX_T3R1  0x1b
DECL|macro|TWIN_DMA_FDX_T1R3
mdefine_line|#define TWIN_DMA_FDX_T1R3  0x1d
multiline_comment|/* Status values */
multiline_comment|/* tx_state */
DECL|macro|TX_IDLE
mdefine_line|#define TX_IDLE    0
DECL|macro|TX_OFF
mdefine_line|#define TX_OFF     1
DECL|macro|TX_TXDELAY
mdefine_line|#define TX_TXDELAY 2
DECL|macro|TX_ACTIVE
mdefine_line|#define TX_ACTIVE  3
DECL|macro|TX_SQDELAY
mdefine_line|#define TX_SQDELAY 4
multiline_comment|/* Data types */
DECL|struct|scc_hardware
r_struct
id|scc_hardware
(brace
DECL|member|name
r_char
op_star
id|name
suffix:semicolon
DECL|member|io_region
r_int
id|io_region
suffix:semicolon
DECL|member|io_delta
r_int
id|io_delta
suffix:semicolon
DECL|member|io_size
r_int
id|io_size
suffix:semicolon
DECL|member|num_devs
r_int
id|num_devs
suffix:semicolon
DECL|member|scc_offset
r_int
id|scc_offset
suffix:semicolon
DECL|member|tmr_offset
r_int
id|tmr_offset
suffix:semicolon
DECL|member|tmr_hz
r_int
id|tmr_hz
suffix:semicolon
DECL|member|pclk_hz
r_int
id|pclk_hz
suffix:semicolon
)brace
suffix:semicolon
DECL|struct|scc_priv
r_struct
id|scc_priv
(brace
DECL|member|name
r_char
id|name
(braket
l_int|10
)braket
suffix:semicolon
DECL|member|stats
r_struct
id|enet_statistics
id|stats
suffix:semicolon
DECL|member|info
r_struct
id|scc_info
op_star
id|info
suffix:semicolon
DECL|member|channel
r_int
id|channel
suffix:semicolon
DECL|member|cmd
DECL|member|data
DECL|member|tmr
r_int
id|cmd
comma
id|data
comma
id|tmr
suffix:semicolon
DECL|member|param
r_struct
id|scc_param
id|param
suffix:semicolon
DECL|member|rx_buf
r_char
id|rx_buf
(braket
id|NUM_RX_BUF
)braket
(braket
id|BUF_SIZE
)braket
suffix:semicolon
DECL|member|rx_len
r_int
id|rx_len
(braket
id|NUM_RX_BUF
)braket
suffix:semicolon
DECL|member|rx_ptr
r_int
id|rx_ptr
suffix:semicolon
DECL|member|rx_task
r_struct
id|tq_struct
id|rx_task
suffix:semicolon
DECL|member|rx_head
DECL|member|rx_tail
DECL|member|rx_count
r_int
id|rx_head
comma
id|rx_tail
comma
id|rx_count
suffix:semicolon
DECL|member|rx_over
r_int
id|rx_over
suffix:semicolon
DECL|member|tx_buf
r_char
id|tx_buf
(braket
id|NUM_TX_BUF
)braket
(braket
id|BUF_SIZE
)braket
suffix:semicolon
DECL|member|tx_len
r_int
id|tx_len
(braket
id|NUM_TX_BUF
)braket
suffix:semicolon
DECL|member|tx_ptr
r_int
id|tx_ptr
suffix:semicolon
DECL|member|tx_head
DECL|member|tx_tail
DECL|member|tx_count
r_int
id|tx_head
comma
id|tx_tail
comma
id|tx_count
suffix:semicolon
DECL|member|tx_sem
DECL|member|tx_state
r_int
id|tx_sem
comma
id|tx_state
suffix:semicolon
DECL|member|tx_start
r_int
r_int
id|tx_start
suffix:semicolon
DECL|member|status
r_int
id|status
suffix:semicolon
)brace
suffix:semicolon
DECL|struct|scc_info
r_struct
id|scc_info
(brace
DECL|member|type
r_int
id|type
suffix:semicolon
DECL|member|chip
r_int
id|chip
suffix:semicolon
DECL|member|open
r_int
id|open
suffix:semicolon
DECL|member|scc_base
r_int
id|scc_base
suffix:semicolon
DECL|member|tmr_base
r_int
id|tmr_base
suffix:semicolon
DECL|member|twin_serial_cfg
r_int
id|twin_serial_cfg
suffix:semicolon
DECL|member|dev
r_struct
id|device
id|dev
(braket
l_int|2
)braket
suffix:semicolon
DECL|member|priv
r_struct
id|scc_priv
id|priv
(braket
l_int|2
)braket
suffix:semicolon
DECL|member|next
r_struct
id|scc_info
op_star
id|next
suffix:semicolon
)brace
suffix:semicolon
multiline_comment|/* Function declarations */
r_int
id|dmascc_init
c_func
(paren
r_void
)paren
id|__init
suffix:semicolon
r_static
r_int
id|setup_adapter
c_func
(paren
r_int
id|io
comma
r_int
id|h
comma
r_int
id|n
)paren
id|__init
suffix:semicolon
r_static
r_inline
r_void
id|write_scc
c_func
(paren
r_int
id|ctl
comma
r_int
id|reg
comma
r_int
id|val
)paren
suffix:semicolon
r_static
r_inline
r_int
id|read_scc
c_func
(paren
r_int
id|ctl
comma
r_int
id|reg
)paren
suffix:semicolon
r_static
r_int
id|scc_open
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_int
id|scc_close
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_int
id|scc_ioctl
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
r_struct
id|ifreq
op_star
id|ifr
comma
r_int
id|cmd
)paren
suffix:semicolon
r_static
r_int
id|scc_send_packet
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_struct
id|enet_statistics
op_star
id|scc_get_stats
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_int
id|scc_set_mac_address
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
r_void
op_star
id|sa
)paren
suffix:semicolon
r_static
r_void
id|scc_isr
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
suffix:semicolon
r_static
r_inline
r_void
id|z8530_isr
c_func
(paren
r_struct
id|scc_info
op_star
id|info
)paren
suffix:semicolon
r_static
r_void
id|rx_isr
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_void
id|special_condition
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
r_int
id|rc
)paren
suffix:semicolon
r_static
r_void
id|rx_bh
c_func
(paren
r_void
op_star
id|arg
)paren
suffix:semicolon
r_static
r_void
id|tx_isr
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_void
id|es_isr
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_void
id|tm_isr
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_inline
r_void
id|delay
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
r_int
id|t
)paren
suffix:semicolon
r_static
r_inline
r_int
r_char
id|random
c_func
(paren
r_void
)paren
suffix:semicolon
multiline_comment|/* Initialization variables */
DECL|variable|__initdata
r_static
r_int
id|io
(braket
id|MAX_NUM_DEVS
)braket
id|__initdata
op_assign
(brace
l_int|0
comma
)brace
suffix:semicolon
multiline_comment|/* Beware! hw[] is also used in cleanup_module(). If __initdata also applies&n;   to modules, we may not declare hw[] as __initdata */
DECL|variable|__initdata
r_static
r_struct
id|scc_hardware
id|hw
(braket
id|NUM_TYPES
)braket
id|__initdata
op_assign
id|HARDWARE
suffix:semicolon
DECL|variable|__initdata
r_static
r_char
id|ax25_broadcast
(braket
l_int|7
)braket
id|__initdata
op_assign
(brace
l_char|&squot;Q&squot;
op_lshift
l_int|1
comma
l_char|&squot;S&squot;
op_lshift
l_int|1
comma
l_char|&squot;T&squot;
op_lshift
l_int|1
comma
l_char|&squot; &squot;
op_lshift
l_int|1
comma
l_char|&squot; &squot;
op_lshift
l_int|1
comma
l_char|&squot; &squot;
op_lshift
l_int|1
comma
l_char|&squot;0&squot;
op_lshift
l_int|1
)brace
suffix:semicolon
DECL|variable|__initdata
r_static
r_char
id|ax25_test
(braket
l_int|7
)braket
id|__initdata
op_assign
(brace
l_char|&squot;L&squot;
op_lshift
l_int|1
comma
l_char|&squot;I&squot;
op_lshift
l_int|1
comma
l_char|&squot;N&squot;
op_lshift
l_int|1
comma
l_char|&squot;U&squot;
op_lshift
l_int|1
comma
l_char|&squot;X&squot;
op_lshift
l_int|1
comma
l_char|&squot; &squot;
op_lshift
l_int|1
comma
l_char|&squot;1&squot;
op_lshift
l_int|1
)brace
suffix:semicolon
multiline_comment|/* Global variables */
DECL|variable|first
r_static
r_struct
id|scc_info
op_star
id|first
op_assign
l_int|NULL
suffix:semicolon
DECL|variable|rand
r_static
r_int
r_int
id|rand
suffix:semicolon
multiline_comment|/* Module functions */
macro_line|#ifdef MODULE
id|MODULE_AUTHOR
c_func
(paren
l_string|&quot;Klaus Kudielka &lt;oe1kib@oe1xtu.ampr.org&gt;&quot;
)paren
suffix:semicolon
id|MODULE_DESCRIPTION
c_func
(paren
l_string|&quot;Driver for high-speed SCC boards&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|io
comma
l_string|&quot;1-&quot;
id|__MODULE_STRING
c_func
(paren
id|MAX_NUM_DEVS
)paren
l_string|&quot;i&quot;
)paren
suffix:semicolon
DECL|function|init_module
r_int
id|init_module
c_func
(paren
r_void
)paren
(brace
r_return
id|dmascc_init
c_func
(paren
)paren
suffix:semicolon
)brace
DECL|function|cleanup_module
r_void
id|cleanup_module
c_func
(paren
r_void
)paren
(brace
r_int
id|i
suffix:semicolon
r_struct
id|scc_info
op_star
id|info
suffix:semicolon
r_while
c_loop
(paren
id|first
)paren
(brace
id|info
op_assign
id|first
suffix:semicolon
multiline_comment|/* Unregister devices */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|2
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|info-&gt;dev
(braket
id|i
)braket
dot
id|name
)paren
id|unregister_netdev
c_func
(paren
op_amp
id|info-&gt;dev
(braket
id|i
)braket
)paren
suffix:semicolon
)brace
multiline_comment|/* Reset board */
r_if
c_cond
(paren
id|info-&gt;type
op_eq
id|TYPE_TWIN
)paren
id|outb_p
c_func
(paren
l_int|0
comma
id|info-&gt;dev
(braket
l_int|0
)braket
dot
id|base_addr
op_plus
id|TWIN_SERIAL_CFG
)paren
suffix:semicolon
id|write_scc
c_func
(paren
id|info-&gt;priv
(braket
l_int|0
)braket
dot
id|cmd
comma
id|R9
comma
id|FHWRES
)paren
suffix:semicolon
id|release_region
c_func
(paren
id|info-&gt;dev
(braket
l_int|0
)braket
dot
id|base_addr
comma
id|hw
(braket
id|info-&gt;type
)braket
dot
id|io_size
)paren
suffix:semicolon
multiline_comment|/* Free memory */
id|first
op_assign
id|info-&gt;next
suffix:semicolon
id|kfree_s
c_func
(paren
id|info
comma
r_sizeof
(paren
r_struct
id|scc_info
)paren
)paren
suffix:semicolon
)brace
)brace
macro_line|#else
DECL|function|__initfunc
id|__initfunc
c_func
(paren
r_void
id|dmascc_setup
c_func
(paren
r_char
op_star
id|str
comma
r_int
op_star
id|ints
)paren
)paren
(brace
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|MAX_NUM_DEVS
op_logical_and
id|i
OL
id|ints
(braket
l_int|0
)braket
suffix:semicolon
id|i
op_increment
)paren
id|io
(braket
id|i
)braket
op_assign
id|ints
(braket
id|i
op_plus
l_int|1
)braket
suffix:semicolon
)brace
macro_line|#endif
multiline_comment|/* Initialization functions */
DECL|function|__initfunc
id|__initfunc
c_func
(paren
r_int
id|dmascc_init
c_func
(paren
r_void
)paren
)paren
(brace
r_int
id|h
comma
id|i
comma
id|j
comma
id|n
comma
id|base
(braket
id|MAX_NUM_DEVS
)braket
comma
id|tcmd
comma
id|t0
comma
id|t1
comma
id|status
suffix:semicolon
r_int
r_int
id|time
comma
id|start
(braket
id|MAX_NUM_DEVS
)braket
comma
id|stop
(braket
id|MAX_NUM_DEVS
)braket
suffix:semicolon
multiline_comment|/* Initialize random number generator */
id|rand
op_assign
id|jiffies
suffix:semicolon
multiline_comment|/* Cards found = 0 */
id|n
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Run autodetection for each card type */
r_for
c_loop
(paren
id|h
op_assign
l_int|0
suffix:semicolon
id|h
OL
id|NUM_TYPES
suffix:semicolon
id|h
op_increment
)paren
(brace
r_if
c_cond
(paren
id|io
(braket
l_int|0
)braket
)paren
(brace
multiline_comment|/* User-specified I/O address regions */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|hw
(braket
id|h
)braket
dot
id|num_devs
suffix:semicolon
id|i
op_increment
)paren
id|base
(braket
id|i
)braket
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|MAX_NUM_DEVS
op_logical_and
id|io
(braket
id|i
)braket
suffix:semicolon
id|i
op_increment
)paren
(brace
id|j
op_assign
(paren
id|io
(braket
id|i
)braket
op_minus
id|hw
(braket
id|h
)braket
dot
id|io_region
)paren
op_div
id|hw
(braket
id|h
)braket
dot
id|io_delta
suffix:semicolon
r_if
c_cond
(paren
id|j
op_ge
l_int|0
op_logical_and
id|j
OL
id|hw
(braket
id|h
)braket
dot
id|num_devs
op_logical_and
id|hw
(braket
id|h
)braket
dot
id|io_region
op_plus
id|j
op_star
id|hw
(braket
id|h
)braket
dot
id|io_delta
op_eq
id|io
(braket
id|i
)braket
)paren
id|base
(braket
id|j
)braket
op_assign
id|io
(braket
id|i
)braket
suffix:semicolon
)brace
)brace
r_else
(brace
multiline_comment|/* Default I/O address regions */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|hw
(braket
id|h
)braket
dot
id|num_devs
suffix:semicolon
id|i
op_increment
)paren
id|base
(braket
id|i
)braket
op_assign
id|hw
(braket
id|h
)braket
dot
id|io_region
op_plus
id|i
op_star
id|hw
(braket
id|h
)braket
dot
id|io_delta
suffix:semicolon
)brace
multiline_comment|/* Check valid I/O address regions */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|hw
(braket
id|h
)braket
dot
id|num_devs
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
id|base
(braket
id|i
)braket
op_logical_and
id|check_region
c_func
(paren
id|base
(braket
id|i
)braket
comma
id|hw
(braket
id|h
)braket
dot
id|io_size
)paren
)paren
id|base
(braket
id|i
)braket
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Start timers */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|hw
(braket
id|h
)braket
dot
id|num_devs
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
id|base
(braket
id|i
)braket
)paren
(brace
id|tcmd
op_assign
id|base
(braket
id|i
)braket
op_plus
id|hw
(braket
id|h
)braket
dot
id|tmr_offset
op_plus
id|TMR_CTRL
suffix:semicolon
id|t0
op_assign
id|base
(braket
id|i
)braket
op_plus
id|hw
(braket
id|h
)braket
dot
id|tmr_offset
op_plus
id|TMR_CNT0
suffix:semicolon
id|t1
op_assign
id|base
(braket
id|i
)braket
op_plus
id|hw
(braket
id|h
)braket
dot
id|tmr_offset
op_plus
id|TMR_CNT1
suffix:semicolon
multiline_comment|/* Timer 0: LSB+MSB, Mode 3, TMR_0_HZ */
id|outb_p
c_func
(paren
l_int|0x36
comma
id|tcmd
)paren
suffix:semicolon
id|outb_p
c_func
(paren
(paren
id|hw
(braket
id|h
)braket
dot
id|tmr_hz
op_div
id|TMR_0_HZ
)paren
op_amp
l_int|0xFF
comma
id|t0
)paren
suffix:semicolon
id|outb_p
c_func
(paren
(paren
id|hw
(braket
id|h
)braket
dot
id|tmr_hz
op_div
id|TMR_0_HZ
)paren
op_rshift
l_int|8
comma
id|t0
)paren
suffix:semicolon
multiline_comment|/* Timer 1: LSB+MSB, Mode 0, HZ/10 */
id|outb_p
c_func
(paren
l_int|0x70
comma
id|tcmd
)paren
suffix:semicolon
id|outb_p
c_func
(paren
(paren
id|TMR_0_HZ
op_div
id|HZ
op_star
l_int|10
)paren
op_amp
l_int|0xFF
comma
id|t1
)paren
suffix:semicolon
id|outb_p
c_func
(paren
(paren
id|TMR_0_HZ
op_div
id|HZ
op_star
l_int|10
)paren
op_rshift
l_int|8
comma
id|t1
)paren
suffix:semicolon
multiline_comment|/* Timer 2: LSB+MSB, Mode 0 */
id|outb_p
c_func
(paren
l_int|0xb0
comma
id|tcmd
)paren
suffix:semicolon
)brace
multiline_comment|/* Initialize start values in case we miss the null count bit */
id|time
op_assign
id|jiffies
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|hw
(braket
id|h
)braket
dot
id|num_devs
suffix:semicolon
id|i
op_increment
)paren
id|start
(braket
id|i
)braket
op_assign
id|time
suffix:semicolon
multiline_comment|/* Timing loop */
r_while
c_loop
(paren
id|jiffies
op_minus
id|time
OL
l_int|12
)paren
(brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|hw
(braket
id|h
)braket
dot
id|num_devs
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
id|base
(braket
id|i
)braket
)paren
(brace
multiline_comment|/* Read back Timer 1: Status */
id|outb_p
c_func
(paren
l_int|0xE4
comma
id|base
(braket
id|i
)braket
op_plus
id|hw
(braket
id|h
)braket
dot
id|tmr_offset
op_plus
id|TMR_CTRL
)paren
suffix:semicolon
id|status
op_assign
id|inb_p
c_func
(paren
id|base
(braket
id|i
)braket
op_plus
id|hw
(braket
id|h
)braket
dot
id|tmr_offset
op_plus
id|TMR_CNT1
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|status
op_amp
l_int|0x3F
)paren
op_ne
l_int|0x30
)paren
id|base
(braket
id|i
)braket
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
l_int|0x40
)paren
id|start
(braket
id|i
)braket
op_assign
id|jiffies
suffix:semicolon
r_if
c_cond
(paren
op_complement
id|status
op_amp
l_int|0x80
)paren
id|stop
(braket
id|i
)braket
op_assign
id|jiffies
suffix:semicolon
)brace
)brace
multiline_comment|/* Evaluate measurements */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|hw
(braket
id|h
)braket
dot
id|num_devs
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
id|base
(braket
id|i
)braket
)paren
(brace
id|time
op_assign
id|stop
(braket
id|i
)braket
op_minus
id|start
(braket
id|i
)braket
suffix:semicolon
r_if
c_cond
(paren
id|time
template_param
l_int|11
)paren
multiline_comment|/* The time expired doesn&squot;t match */
id|base
(braket
id|i
)braket
op_assign
l_int|0
suffix:semicolon
r_else
(brace
multiline_comment|/* Ok, we have found an adapter */
r_if
c_cond
(paren
id|setup_adapter
c_func
(paren
id|base
(braket
id|i
)braket
comma
id|h
comma
id|n
)paren
op_eq
l_int|0
)paren
id|n
op_increment
suffix:semicolon
)brace
)brace
)brace
multiline_comment|/* NUM_TYPES */
multiline_comment|/* If any adapter was successfully initialized, return ok */
r_if
c_cond
(paren
id|n
)paren
r_return
l_int|0
suffix:semicolon
multiline_comment|/* If no adapter found, return error */
id|printk
c_func
(paren
l_string|&quot;dmascc: no adapters found&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
DECL|function|__initfunc
id|__initfunc
c_func
(paren
r_int
id|setup_adapter
c_func
(paren
r_int
id|io
comma
r_int
id|h
comma
r_int
id|n
)paren
)paren
(brace
r_int
id|i
comma
id|irq
comma
id|chip
suffix:semicolon
r_struct
id|scc_info
op_star
id|info
suffix:semicolon
r_struct
id|device
op_star
id|dev
suffix:semicolon
r_struct
id|scc_priv
op_star
id|priv
suffix:semicolon
r_int
r_int
id|time
suffix:semicolon
r_int
r_int
id|irqs
suffix:semicolon
r_int
id|tmr
op_assign
id|io
op_plus
id|hw
(braket
id|h
)braket
dot
id|tmr_offset
suffix:semicolon
r_int
id|scc
op_assign
id|io
op_plus
id|hw
(braket
id|h
)braket
dot
id|scc_offset
suffix:semicolon
r_int
id|cmd
op_assign
id|scc
op_plus
id|SCCA_CMD
suffix:semicolon
r_char
op_star
id|chipnames
(braket
)braket
op_assign
id|CHIPNAMES
suffix:semicolon
multiline_comment|/* Reset 8530 */
id|write_scc
c_func
(paren
id|cmd
comma
id|R9
comma
id|FHWRES
op_or
id|MIE
op_or
id|NV
)paren
suffix:semicolon
multiline_comment|/* Determine type of chip */
id|write_scc
c_func
(paren
id|cmd
comma
id|R15
comma
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|read_scc
c_func
(paren
id|cmd
comma
id|R15
)paren
)paren
(brace
multiline_comment|/* WR7&squot; not present. This is an ordinary Z8530 SCC. */
id|chip
op_assign
id|Z8530
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* Put one character in TX FIFO */
id|write_scc
c_func
(paren
id|cmd
comma
id|R8
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|read_scc
c_func
(paren
id|cmd
comma
id|R0
)paren
op_amp
id|Tx_BUF_EMP
)paren
(brace
multiline_comment|/* TX FIFO not full. This is a Z85230 ESCC with a 4-byte FIFO. */
id|chip
op_assign
id|Z85230
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* TX FIFO full. This is a Z85C30 SCC with a 1-byte FIFO. */
id|chip
op_assign
id|Z85C30
suffix:semicolon
)brace
)brace
id|write_scc
c_func
(paren
id|cmd
comma
id|R15
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* Start IRQ auto-detection */
id|sti
c_func
(paren
)paren
suffix:semicolon
id|irqs
op_assign
id|probe_irq_on
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* Enable interrupts */
r_switch
c_cond
(paren
id|h
)paren
(brace
r_case
id|TYPE_PI
suffix:colon
r_case
id|TYPE_PI2
suffix:colon
id|outb_p
c_func
(paren
l_int|0
comma
id|io
op_plus
id|PI_DREQ_MASK
)paren
suffix:semicolon
id|write_scc
c_func
(paren
id|cmd
comma
id|R15
comma
id|CTSIE
)paren
suffix:semicolon
id|write_scc
c_func
(paren
id|cmd
comma
id|R0
comma
id|RES_EXT_INT
)paren
suffix:semicolon
id|write_scc
c_func
(paren
id|cmd
comma
id|R1
comma
id|EXT_INT_ENAB
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|TYPE_TWIN
suffix:colon
id|outb_p
c_func
(paren
l_int|0
comma
id|io
op_plus
id|TWIN_DMA_CFG
)paren
suffix:semicolon
id|inb_p
c_func
(paren
id|io
op_plus
id|TWIN_CLR_TMR1
)paren
suffix:semicolon
id|inb_p
c_func
(paren
id|io
op_plus
id|TWIN_CLR_TMR2
)paren
suffix:semicolon
id|outb_p
c_func
(paren
id|TWIN_EI
comma
id|io
op_plus
id|TWIN_SERIAL_CFG
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
multiline_comment|/* Start timer */
id|outb_p
c_func
(paren
l_int|1
comma
id|tmr
op_plus
id|TMR_CNT1
)paren
suffix:semicolon
id|outb_p
c_func
(paren
l_int|0
comma
id|tmr
op_plus
id|TMR_CNT1
)paren
suffix:semicolon
multiline_comment|/* Wait and detect IRQ */
id|time
op_assign
id|jiffies
suffix:semicolon
r_while
c_loop
(paren
id|jiffies
op_minus
id|time
OL
l_int|2
op_plus
id|HZ
op_div
id|TMR_0_HZ
)paren
suffix:semicolon
id|irq
op_assign
id|probe_irq_off
c_func
(paren
id|irqs
)paren
suffix:semicolon
multiline_comment|/* Clear pending interrupt, disable interrupts */
r_switch
c_cond
(paren
id|h
)paren
(brace
r_case
id|TYPE_PI
suffix:colon
r_case
id|TYPE_PI2
suffix:colon
id|write_scc
c_func
(paren
id|cmd
comma
id|R1
comma
l_int|0
)paren
suffix:semicolon
id|write_scc
c_func
(paren
id|cmd
comma
id|R15
comma
l_int|0
)paren
suffix:semicolon
id|write_scc
c_func
(paren
id|cmd
comma
id|R0
comma
id|RES_EXT_INT
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|TYPE_TWIN
suffix:colon
id|inb_p
c_func
(paren
id|io
op_plus
id|TWIN_CLR_TMR1
)paren
suffix:semicolon
id|outb_p
c_func
(paren
l_int|0
comma
id|io
op_plus
id|TWIN_SERIAL_CFG
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|irq
op_le
l_int|0
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;dmascc: could not find irq of %s at %#3x (irq=%d)&bslash;n&quot;
comma
id|hw
(braket
id|h
)braket
dot
id|name
comma
id|io
comma
id|irq
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
multiline_comment|/* Allocate memory */
id|info
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|scc_info
)paren
comma
id|GFP_KERNEL
op_or
id|GFP_DMA
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|info
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;dmascc: could not allocate memory for %s at %#3x&bslash;n&quot;
comma
id|hw
(braket
id|h
)braket
dot
id|name
comma
id|io
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
multiline_comment|/* Set up data structures */
id|memset
c_func
(paren
id|info
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|scc_info
)paren
)paren
suffix:semicolon
id|info-&gt;type
op_assign
id|h
suffix:semicolon
id|info-&gt;chip
op_assign
id|chip
suffix:semicolon
id|info-&gt;scc_base
op_assign
id|io
op_plus
id|hw
(braket
id|h
)braket
dot
id|scc_offset
suffix:semicolon
id|info-&gt;tmr_base
op_assign
id|io
op_plus
id|hw
(braket
id|h
)braket
dot
id|tmr_offset
suffix:semicolon
id|info-&gt;twin_serial_cfg
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|2
suffix:semicolon
id|i
op_increment
)paren
(brace
id|dev
op_assign
op_amp
id|info-&gt;dev
(braket
id|i
)braket
suffix:semicolon
id|priv
op_assign
op_amp
id|info-&gt;priv
(braket
id|i
)braket
suffix:semicolon
id|sprintf
c_func
(paren
id|priv-&gt;name
comma
l_string|&quot;dmascc%i&quot;
comma
l_int|2
op_star
id|n
op_plus
id|i
)paren
suffix:semicolon
id|priv-&gt;info
op_assign
id|info
suffix:semicolon
id|priv-&gt;channel
op_assign
id|i
suffix:semicolon
id|priv-&gt;cmd
op_assign
id|info-&gt;scc_base
op_plus
(paren
id|i
ques
c_cond
id|SCCB_CMD
suffix:colon
id|SCCA_CMD
)paren
suffix:semicolon
id|priv-&gt;data
op_assign
id|info-&gt;scc_base
op_plus
(paren
id|i
ques
c_cond
id|SCCB_DATA
suffix:colon
id|SCCA_DATA
)paren
suffix:semicolon
id|priv-&gt;tmr
op_assign
id|info-&gt;tmr_base
op_plus
(paren
id|i
ques
c_cond
id|TMR_CNT2
suffix:colon
id|TMR_CNT1
)paren
suffix:semicolon
id|priv-&gt;param.pclk_hz
op_assign
id|hw
(braket
id|h
)braket
dot
id|pclk_hz
suffix:semicolon
id|priv-&gt;param.brg_tc
op_assign
op_minus
l_int|1
suffix:semicolon
id|priv-&gt;param.clocks
op_assign
id|TCTRxCP
op_or
id|RCRTxCP
suffix:semicolon
id|priv-&gt;param.txdelay
op_assign
id|TMR_0_HZ
op_star
l_int|10
op_div
l_int|1000
suffix:semicolon
id|priv-&gt;param.txtime
op_assign
id|HZ
op_star
l_int|3
suffix:semicolon
id|priv-&gt;param.sqdelay
op_assign
id|TMR_0_HZ
op_star
l_int|1
op_div
l_int|1000
suffix:semicolon
id|priv-&gt;param.slottime
op_assign
id|TMR_0_HZ
op_star
l_int|10
op_div
l_int|1000
suffix:semicolon
id|priv-&gt;param.waittime
op_assign
id|TMR_0_HZ
op_star
l_int|100
op_div
l_int|1000
suffix:semicolon
id|priv-&gt;param.persist
op_assign
l_int|32
suffix:semicolon
id|priv-&gt;rx_task.routine
op_assign
id|rx_bh
suffix:semicolon
id|priv-&gt;rx_task.data
op_assign
id|dev
suffix:semicolon
id|dev-&gt;priv
op_assign
id|priv
suffix:semicolon
id|dev-&gt;name
op_assign
id|priv-&gt;name
suffix:semicolon
id|dev-&gt;base_addr
op_assign
id|io
suffix:semicolon
id|dev-&gt;irq
op_assign
id|irq
suffix:semicolon
id|dev-&gt;open
op_assign
id|scc_open
suffix:semicolon
id|dev-&gt;stop
op_assign
id|scc_close
suffix:semicolon
id|dev-&gt;do_ioctl
op_assign
id|scc_ioctl
suffix:semicolon
id|dev-&gt;hard_start_xmit
op_assign
id|scc_send_packet
suffix:semicolon
id|dev-&gt;get_stats
op_assign
id|scc_get_stats
suffix:semicolon
id|dev-&gt;hard_header
op_assign
id|ax25_encapsulate
suffix:semicolon
id|dev-&gt;rebuild_header
op_assign
id|ax25_rebuild_header
suffix:semicolon
id|dev-&gt;set_mac_address
op_assign
id|scc_set_mac_address
suffix:semicolon
id|dev-&gt;type
op_assign
id|ARPHRD_AX25
suffix:semicolon
id|dev-&gt;hard_header_len
op_assign
l_int|73
suffix:semicolon
id|dev-&gt;mtu
op_assign
l_int|1500
suffix:semicolon
id|dev-&gt;addr_len
op_assign
l_int|7
suffix:semicolon
id|dev-&gt;tx_queue_len
op_assign
l_int|64
suffix:semicolon
id|memcpy
c_func
(paren
id|dev-&gt;broadcast
comma
id|ax25_broadcast
comma
l_int|7
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|dev-&gt;dev_addr
comma
id|ax25_test
comma
l_int|7
)paren
suffix:semicolon
id|dev-&gt;flags
op_assign
l_int|0
suffix:semicolon
id|dev_init_buffers
c_func
(paren
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|register_netdev
c_func
(paren
id|dev
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;dmascc: could not register %s&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|dev-&gt;name
op_assign
l_int|NULL
suffix:semicolon
)brace
)brace
id|request_region
c_func
(paren
id|io
comma
id|hw
(braket
id|h
)braket
dot
id|io_size
comma
l_string|&quot;dmascc&quot;
)paren
suffix:semicolon
id|info-&gt;next
op_assign
id|first
suffix:semicolon
id|first
op_assign
id|info
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;dmascc: found %s (%s) at %#3x, irq %d&bslash;n&quot;
comma
id|hw
(braket
id|h
)braket
dot
id|name
comma
id|chipnames
(braket
id|chip
)braket
comma
id|io
comma
id|irq
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Driver functions */
DECL|function|write_scc
r_static
r_inline
r_void
id|write_scc
c_func
(paren
r_int
id|ctl
comma
r_int
id|reg
comma
r_int
id|val
)paren
(brace
id|outb_p
c_func
(paren
id|reg
comma
id|ctl
)paren
suffix:semicolon
id|outb_p
c_func
(paren
id|val
comma
id|ctl
)paren
suffix:semicolon
)brace
DECL|function|read_scc
r_static
r_inline
r_int
id|read_scc
c_func
(paren
r_int
id|ctl
comma
r_int
id|reg
)paren
(brace
id|outb_p
c_func
(paren
id|reg
comma
id|ctl
)paren
suffix:semicolon
r_return
id|inb_p
c_func
(paren
id|ctl
)paren
suffix:semicolon
)brace
DECL|function|scc_open
r_static
r_int
id|scc_open
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
r_struct
id|scc_priv
op_star
id|priv
op_assign
id|dev-&gt;priv
suffix:semicolon
r_struct
id|scc_info
op_star
id|info
op_assign
id|priv-&gt;info
suffix:semicolon
r_int
id|io
op_assign
id|dev-&gt;base_addr
suffix:semicolon
r_int
id|cmd
op_assign
id|priv-&gt;cmd
suffix:semicolon
multiline_comment|/* Request IRQ if not already used by other channel */
r_if
c_cond
(paren
op_logical_neg
id|info-&gt;open
)paren
(brace
r_if
c_cond
(paren
id|request_irq
c_func
(paren
id|dev-&gt;irq
comma
id|scc_isr
comma
id|SA_INTERRUPT
comma
l_string|&quot;dmascc&quot;
comma
id|info
)paren
)paren
r_return
op_minus
id|EAGAIN
suffix:semicolon
)brace
multiline_comment|/* Request DMA if required */
r_if
c_cond
(paren
id|dev-&gt;dma
op_logical_and
id|request_dma
c_func
(paren
id|dev-&gt;dma
comma
l_string|&quot;dmascc&quot;
)paren
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|info-&gt;open
)paren
id|free_irq
c_func
(paren
id|dev-&gt;irq
comma
id|info
)paren
suffix:semicolon
r_return
op_minus
id|EAGAIN
suffix:semicolon
)brace
multiline_comment|/* Initialize local variables */
id|dev-&gt;tbusy
op_assign
l_int|0
suffix:semicolon
id|priv-&gt;rx_ptr
op_assign
l_int|0
suffix:semicolon
id|priv-&gt;rx_over
op_assign
l_int|0
suffix:semicolon
id|priv-&gt;rx_head
op_assign
id|priv-&gt;rx_tail
op_assign
id|priv-&gt;rx_count
op_assign
l_int|0
suffix:semicolon
id|priv-&gt;tx_state
op_assign
id|TX_IDLE
suffix:semicolon
id|priv-&gt;tx_head
op_assign
id|priv-&gt;tx_tail
op_assign
id|priv-&gt;tx_count
op_assign
l_int|0
suffix:semicolon
id|priv-&gt;tx_ptr
op_assign
l_int|0
suffix:semicolon
id|priv-&gt;tx_sem
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Reset channel */
id|write_scc
c_func
(paren
id|cmd
comma
id|R9
comma
(paren
id|priv-&gt;channel
ques
c_cond
id|CHRB
suffix:colon
id|CHRA
)paren
op_or
id|MIE
op_or
id|NV
)paren
suffix:semicolon
multiline_comment|/* X1 clock, SDLC mode */
id|write_scc
c_func
(paren
id|cmd
comma
id|R4
comma
id|SDLC
op_or
id|X1CLK
)paren
suffix:semicolon
multiline_comment|/* DMA */
id|write_scc
c_func
(paren
id|cmd
comma
id|R1
comma
id|EXT_INT_ENAB
op_or
id|WT_FN_RDYFN
)paren
suffix:semicolon
multiline_comment|/* 8 bit RX char, RX disable */
id|write_scc
c_func
(paren
id|cmd
comma
id|R3
comma
id|Rx8
)paren
suffix:semicolon
multiline_comment|/* 8 bit TX char, TX disable */
id|write_scc
c_func
(paren
id|cmd
comma
id|R5
comma
id|Tx8
)paren
suffix:semicolon
multiline_comment|/* SDLC address field */
id|write_scc
c_func
(paren
id|cmd
comma
id|R6
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* SDLC flag */
id|write_scc
c_func
(paren
id|cmd
comma
id|R7
comma
id|FLAG
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|info-&gt;chip
)paren
(brace
r_case
id|Z85C30
suffix:colon
multiline_comment|/* Select WR7&squot; */
id|write_scc
c_func
(paren
id|cmd
comma
id|R15
comma
l_int|1
)paren
suffix:semicolon
multiline_comment|/* Auto EOM reset */
id|write_scc
c_func
(paren
id|cmd
comma
id|R7
comma
l_int|0x02
)paren
suffix:semicolon
id|write_scc
c_func
(paren
id|cmd
comma
id|R15
comma
l_int|0
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|Z85230
suffix:colon
multiline_comment|/* Select WR7&squot; */
id|write_scc
c_func
(paren
id|cmd
comma
id|R15
comma
l_int|1
)paren
suffix:semicolon
multiline_comment|/* RX FIFO half full (interrupt only), Auto EOM reset,&n;       TX FIFO empty (DMA only) */
id|write_scc
c_func
(paren
id|cmd
comma
id|R7
comma
id|dev-&gt;dma
ques
c_cond
l_int|0x22
suffix:colon
l_int|0x0a
)paren
suffix:semicolon
id|write_scc
c_func
(paren
id|cmd
comma
id|R15
comma
l_int|0
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
multiline_comment|/* Preset CRC, NRZ(I) encoding */
id|write_scc
c_func
(paren
id|cmd
comma
id|R10
comma
id|CRCPS
op_or
(paren
id|priv-&gt;param.nrzi
ques
c_cond
id|NRZI
suffix:colon
id|NRZ
)paren
)paren
suffix:semicolon
multiline_comment|/* Configure baud rate generator */
r_if
c_cond
(paren
id|priv-&gt;param.brg_tc
op_ge
l_int|0
)paren
(brace
multiline_comment|/* Program BR generator */
id|write_scc
c_func
(paren
id|cmd
comma
id|R12
comma
id|priv-&gt;param.brg_tc
op_amp
l_int|0xFF
)paren
suffix:semicolon
id|write_scc
c_func
(paren
id|cmd
comma
id|R13
comma
(paren
id|priv-&gt;param.brg_tc
op_rshift
l_int|8
)paren
op_amp
l_int|0xFF
)paren
suffix:semicolon
multiline_comment|/* BRG source = SYS CLK; enable BRG; DTR REQ function (required by&n;       PackeTwin, not connected on the PI2); set DPLL source to BRG */
id|write_scc
c_func
(paren
id|cmd
comma
id|R14
comma
id|SSBR
op_or
id|DTRREQ
op_or
id|BRSRC
op_or
id|BRENABL
)paren
suffix:semicolon
multiline_comment|/* Enable DPLL */
id|write_scc
c_func
(paren
id|cmd
comma
id|R14
comma
id|SEARCH
op_or
id|DTRREQ
op_or
id|BRSRC
op_or
id|BRENABL
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* Disable BR generator */
id|write_scc
c_func
(paren
id|cmd
comma
id|R14
comma
id|DTRREQ
op_or
id|BRSRC
)paren
suffix:semicolon
)brace
multiline_comment|/* Configure clocks */
r_if
c_cond
(paren
id|info-&gt;type
op_eq
id|TYPE_TWIN
)paren
(brace
multiline_comment|/* Disable external TX clock receiver */
id|outb_p
c_func
(paren
(paren
id|info-&gt;twin_serial_cfg
op_and_assign
op_complement
(paren
id|priv-&gt;channel
ques
c_cond
id|TWIN_EXTCLKB
suffix:colon
id|TWIN_EXTCLKA
)paren
)paren
comma
id|io
op_plus
id|TWIN_SERIAL_CFG
)paren
suffix:semicolon
)brace
id|write_scc
c_func
(paren
id|cmd
comma
id|R11
comma
id|priv-&gt;param.clocks
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|info-&gt;type
op_eq
id|TYPE_TWIN
)paren
op_logical_and
op_logical_neg
(paren
id|priv-&gt;param.clocks
op_amp
id|TRxCOI
)paren
)paren
(brace
multiline_comment|/* Enable external TX clock receiver */
id|outb_p
c_func
(paren
(paren
id|info-&gt;twin_serial_cfg
op_or_assign
(paren
id|priv-&gt;channel
ques
c_cond
id|TWIN_EXTCLKB
suffix:colon
id|TWIN_EXTCLKA
)paren
)paren
comma
id|io
op_plus
id|TWIN_SERIAL_CFG
)paren
suffix:semicolon
)brace
multiline_comment|/* Configure PackeTwin */
r_if
c_cond
(paren
id|info-&gt;type
op_eq
id|TYPE_TWIN
)paren
(brace
multiline_comment|/* Assert DTR, enable interrupts */
id|outb_p
c_func
(paren
(paren
id|info-&gt;twin_serial_cfg
op_or_assign
id|TWIN_EI
op_or
(paren
id|priv-&gt;channel
ques
c_cond
id|TWIN_DTRB_ON
suffix:colon
id|TWIN_DTRA_ON
)paren
)paren
comma
id|io
op_plus
id|TWIN_SERIAL_CFG
)paren
suffix:semicolon
)brace
multiline_comment|/* Read current status */
id|priv-&gt;status
op_assign
id|read_scc
c_func
(paren
id|cmd
comma
id|R0
)paren
suffix:semicolon
multiline_comment|/* Enable SYNC, DCD, and CTS interrupts */
id|write_scc
c_func
(paren
id|cmd
comma
id|R15
comma
id|DCDIE
op_or
id|CTSIE
op_or
id|SYNCIE
)paren
suffix:semicolon
multiline_comment|/* Configure PI2 DMA */
r_if
c_cond
(paren
id|info-&gt;type
op_le
id|TYPE_PI2
)paren
id|outb_p
c_func
(paren
l_int|1
comma
id|io
op_plus
id|PI_DREQ_MASK
)paren
suffix:semicolon
id|dev-&gt;start
op_assign
l_int|1
suffix:semicolon
id|info-&gt;open
op_increment
suffix:semicolon
id|MOD_INC_USE_COUNT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|scc_close
r_static
r_int
id|scc_close
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
r_struct
id|scc_priv
op_star
id|priv
op_assign
id|dev-&gt;priv
suffix:semicolon
r_struct
id|scc_info
op_star
id|info
op_assign
id|priv-&gt;info
suffix:semicolon
r_int
id|io
op_assign
id|dev-&gt;base_addr
suffix:semicolon
r_int
id|cmd
op_assign
id|priv-&gt;cmd
suffix:semicolon
id|dev-&gt;start
op_assign
l_int|0
suffix:semicolon
id|info-&gt;open
op_decrement
suffix:semicolon
id|MOD_DEC_USE_COUNT
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;type
op_eq
id|TYPE_TWIN
)paren
multiline_comment|/* Drop DTR */
id|outb_p
c_func
(paren
(paren
id|info-&gt;twin_serial_cfg
op_and_assign
(paren
id|priv-&gt;channel
ques
c_cond
op_complement
id|TWIN_DTRB_ON
suffix:colon
op_complement
id|TWIN_DTRA_ON
)paren
)paren
comma
id|io
op_plus
id|TWIN_SERIAL_CFG
)paren
suffix:semicolon
multiline_comment|/* Reset channel, free DMA */
id|write_scc
c_func
(paren
id|cmd
comma
id|R9
comma
(paren
id|priv-&gt;channel
ques
c_cond
id|CHRB
suffix:colon
id|CHRA
)paren
op_or
id|MIE
op_or
id|NV
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;dma
)paren
(brace
r_if
c_cond
(paren
id|info-&gt;type
op_eq
id|TYPE_TWIN
)paren
id|outb_p
c_func
(paren
l_int|0
comma
id|io
op_plus
id|TWIN_DMA_CFG
)paren
suffix:semicolon
id|free_dma
c_func
(paren
id|dev-&gt;dma
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|info-&gt;open
)paren
(brace
r_if
c_cond
(paren
id|info-&gt;type
op_le
id|TYPE_PI2
)paren
id|outb_p
c_func
(paren
l_int|0
comma
id|io
op_plus
id|PI_DREQ_MASK
)paren
suffix:semicolon
id|free_irq
c_func
(paren
id|dev-&gt;irq
comma
id|info
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|scc_ioctl
r_static
r_int
id|scc_ioctl
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
r_struct
id|ifreq
op_star
id|ifr
comma
r_int
id|cmd
)paren
(brace
r_int
id|rc
suffix:semicolon
r_struct
id|scc_priv
op_star
id|priv
op_assign
id|dev-&gt;priv
suffix:semicolon
r_switch
c_cond
(paren
id|cmd
)paren
(brace
r_case
id|SIOCGSCCPARAM
suffix:colon
id|rc
op_assign
id|verify_area
c_func
(paren
id|VERIFY_WRITE
comma
id|ifr-&gt;ifr_data
comma
r_sizeof
(paren
r_struct
id|scc_param
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
r_return
id|rc
suffix:semicolon
id|copy_to_user
c_func
(paren
id|ifr-&gt;ifr_data
comma
op_amp
id|priv-&gt;param
comma
r_sizeof
(paren
r_struct
id|scc_param
)paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
r_case
id|SIOCSSCCPARAM
suffix:colon
r_if
c_cond
(paren
op_logical_neg
id|suser
c_func
(paren
)paren
)paren
r_return
op_minus
id|EPERM
suffix:semicolon
id|rc
op_assign
id|verify_area
c_func
(paren
id|VERIFY_READ
comma
id|ifr-&gt;ifr_data
comma
r_sizeof
(paren
r_struct
id|scc_param
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
r_return
id|rc
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;start
)paren
r_return
op_minus
id|EAGAIN
suffix:semicolon
id|copy_from_user
c_func
(paren
op_amp
id|priv-&gt;param
comma
id|ifr-&gt;ifr_data
comma
r_sizeof
(paren
r_struct
id|scc_param
)paren
)paren
suffix:semicolon
id|dev-&gt;dma
op_assign
id|priv-&gt;param.dma
suffix:semicolon
r_return
l_int|0
suffix:semicolon
r_default
suffix:colon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
)brace
DECL|function|scc_send_packet
r_static
r_int
id|scc_send_packet
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|device
op_star
id|dev
)paren
(brace
r_struct
id|scc_priv
op_star
id|priv
op_assign
id|dev-&gt;priv
suffix:semicolon
r_struct
id|scc_info
op_star
id|info
op_assign
id|priv-&gt;info
suffix:semicolon
r_int
id|cmd
op_assign
id|priv-&gt;cmd
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_int
id|i
suffix:semicolon
multiline_comment|/* Block a timer-based transmit from overlapping */
r_if
c_cond
(paren
id|test_and_set_bit
c_func
(paren
l_int|0
comma
(paren
r_void
op_star
)paren
op_amp
id|priv-&gt;tx_sem
)paren
op_ne
l_int|0
)paren
(brace
id|atomic_inc
c_func
(paren
(paren
r_void
op_star
)paren
op_amp
id|priv-&gt;stats.tx_dropped
)paren
suffix:semicolon
id|dev_kfree_skb
c_func
(paren
id|skb
comma
id|FREE_WRITE
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Return with an error if we cannot accept more data */
r_if
c_cond
(paren
id|dev-&gt;tbusy
)paren
(brace
id|priv-&gt;tx_sem
op_assign
l_int|0
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
multiline_comment|/* Transfer data to DMA buffer */
id|i
op_assign
id|priv-&gt;tx_head
suffix:semicolon
id|memcpy
c_func
(paren
id|priv-&gt;tx_buf
(braket
id|i
)braket
comma
id|skb-&gt;data
op_plus
l_int|1
comma
id|skb-&gt;len
op_minus
l_int|1
)paren
suffix:semicolon
id|priv-&gt;tx_len
(braket
id|i
)braket
op_assign
id|skb-&gt;len
op_minus
l_int|1
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* Set the busy flag if we just filled up the last buffer */
id|priv-&gt;tx_head
op_assign
(paren
id|i
op_plus
l_int|1
)paren
op_mod
id|NUM_TX_BUF
suffix:semicolon
id|priv-&gt;tx_count
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|priv-&gt;tx_count
op_eq
id|NUM_TX_BUF
)paren
id|dev-&gt;tbusy
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* Set new TX state */
r_if
c_cond
(paren
id|priv-&gt;tx_state
op_eq
id|TX_IDLE
)paren
(brace
multiline_comment|/* Assert RTS, start timer */
id|priv-&gt;tx_state
op_assign
id|TX_TXDELAY
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;type
op_le
id|TYPE_PI2
)paren
id|outb_p
c_func
(paren
l_int|0
comma
id|dev-&gt;base_addr
op_plus
id|PI_DREQ_MASK
)paren
suffix:semicolon
id|write_scc
c_func
(paren
id|cmd
comma
id|R5
comma
id|TxCRC_ENAB
op_or
id|RTS
op_or
id|TxENAB
op_or
id|Tx8
)paren
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;type
op_le
id|TYPE_PI2
)paren
id|outb_p
c_func
(paren
l_int|1
comma
id|dev-&gt;base_addr
op_plus
id|PI_DREQ_MASK
)paren
suffix:semicolon
id|priv-&gt;tx_start
op_assign
id|jiffies
suffix:semicolon
id|delay
c_func
(paren
id|dev
comma
id|priv-&gt;param.txdelay
)paren
suffix:semicolon
)brace
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|dev_kfree_skb
c_func
(paren
id|skb
comma
id|FREE_WRITE
)paren
suffix:semicolon
id|priv-&gt;tx_sem
op_assign
l_int|0
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|scc_get_stats
r_static
r_struct
id|enet_statistics
op_star
id|scc_get_stats
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
r_struct
id|scc_priv
op_star
id|priv
op_assign
id|dev-&gt;priv
suffix:semicolon
r_return
op_amp
id|priv-&gt;stats
suffix:semicolon
)brace
DECL|function|scc_set_mac_address
r_static
r_int
id|scc_set_mac_address
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
r_void
op_star
id|sa
)paren
(brace
id|memcpy
c_func
(paren
id|dev-&gt;dev_addr
comma
(paren
(paren
r_struct
id|sockaddr
op_star
)paren
id|sa
)paren
op_member_access_from_pointer
id|sa_data
comma
id|dev-&gt;addr_len
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|scc_isr
r_static
r_void
id|scc_isr
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_struct
id|scc_info
op_star
id|info
op_assign
id|dev_id
suffix:semicolon
r_int
id|is
comma
id|io
op_assign
id|info-&gt;dev
(braket
l_int|0
)braket
dot
id|base_addr
suffix:semicolon
multiline_comment|/* We&squot;re a fast IRQ handler and are called with interrupts disabled */
multiline_comment|/* IRQ sharing doesn&squot;t make sense due to ISA&squot;s edge-triggered&n;     interrupts, hence it is safe to return if we have found and&n;     processed a single device. */
multiline_comment|/* Interrupt processing: We loop until we know that the IRQ line is&n;     low. If another positive edge occurs afterwards during the ISR,&n;     another interrupt will be triggered by the interrupt controller&n;     as soon as the IRQ level is enabled again (see asm/irq.h). */
r_switch
c_cond
(paren
id|info-&gt;type
)paren
(brace
r_case
id|TYPE_PI
suffix:colon
r_case
id|TYPE_PI2
suffix:colon
id|outb_p
c_func
(paren
l_int|0
comma
id|io
op_plus
id|PI_DREQ_MASK
)paren
suffix:semicolon
id|z8530_isr
c_func
(paren
id|info
)paren
suffix:semicolon
id|outb_p
c_func
(paren
l_int|1
comma
id|io
op_plus
id|PI_DREQ_MASK
)paren
suffix:semicolon
r_return
suffix:semicolon
r_case
id|TYPE_TWIN
suffix:colon
r_while
c_loop
(paren
(paren
id|is
op_assign
op_complement
id|inb_p
c_func
(paren
id|io
op_plus
id|TWIN_INT_REG
)paren
)paren
op_amp
id|TWIN_INT_MSK
)paren
(brace
r_if
c_cond
(paren
id|is
op_amp
id|TWIN_SCC_MSK
)paren
(brace
id|z8530_isr
c_func
(paren
id|info
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|is
op_amp
id|TWIN_TMR1_MSK
)paren
(brace
id|inb_p
c_func
(paren
id|io
op_plus
id|TWIN_CLR_TMR1
)paren
suffix:semicolon
id|tm_isr
c_func
(paren
op_amp
id|info-&gt;dev
(braket
l_int|0
)braket
)paren
suffix:semicolon
)brace
r_else
(brace
id|inb_p
c_func
(paren
id|io
op_plus
id|TWIN_CLR_TMR2
)paren
suffix:semicolon
id|tm_isr
c_func
(paren
op_amp
id|info-&gt;dev
(braket
l_int|1
)braket
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* No interrupts pending from the PackeTwin */
r_return
suffix:semicolon
)brace
)brace
DECL|function|z8530_isr
r_static
r_inline
r_void
id|z8530_isr
c_func
(paren
r_struct
id|scc_info
op_star
id|info
)paren
(brace
r_int
id|is
comma
id|a_cmd
suffix:semicolon
id|a_cmd
op_assign
id|info-&gt;scc_base
op_plus
id|SCCA_CMD
suffix:semicolon
r_while
c_loop
(paren
(paren
id|is
op_assign
id|read_scc
c_func
(paren
id|a_cmd
comma
id|R3
)paren
)paren
)paren
(brace
r_if
c_cond
(paren
id|is
op_amp
id|CHARxIP
)paren
(brace
id|rx_isr
c_func
(paren
op_amp
id|info-&gt;dev
(braket
l_int|0
)braket
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|is
op_amp
id|CHATxIP
)paren
(brace
id|tx_isr
c_func
(paren
op_amp
id|info-&gt;dev
(braket
l_int|0
)braket
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|is
op_amp
id|CHAEXT
)paren
(brace
id|es_isr
c_func
(paren
op_amp
id|info-&gt;dev
(braket
l_int|0
)braket
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|is
op_amp
id|CHBRxIP
)paren
(brace
id|rx_isr
c_func
(paren
op_amp
id|info-&gt;dev
(braket
l_int|1
)braket
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|is
op_amp
id|CHBTxIP
)paren
(brace
id|tx_isr
c_func
(paren
op_amp
id|info-&gt;dev
(braket
l_int|1
)braket
)paren
suffix:semicolon
)brace
r_else
(brace
id|es_isr
c_func
(paren
op_amp
id|info-&gt;dev
(braket
l_int|1
)braket
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* Ok, no interrupts pending from this 8530. The INT line should&n;     be inactive now. */
)brace
DECL|function|rx_isr
r_static
r_void
id|rx_isr
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
r_struct
id|scc_priv
op_star
id|priv
op_assign
id|dev-&gt;priv
suffix:semicolon
r_int
id|cmd
op_assign
id|priv-&gt;cmd
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;dma
)paren
(brace
multiline_comment|/* Check special condition and perform error reset. See 2.4.7.5. */
id|special_condition
c_func
(paren
id|dev
comma
id|read_scc
c_func
(paren
id|cmd
comma
id|R1
)paren
)paren
suffix:semicolon
id|write_scc
c_func
(paren
id|cmd
comma
id|R0
comma
id|ERR_RES
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* Check special condition for each character. Error reset not necessary.&n;       Same algorithm for SCC and ESCC. See 2.4.7.1 and 2.4.7.4. */
r_int
id|rc
suffix:semicolon
r_while
c_loop
(paren
id|read_scc
c_func
(paren
id|cmd
comma
id|R0
)paren
op_amp
id|Rx_CH_AV
)paren
(brace
id|rc
op_assign
id|read_scc
c_func
(paren
id|cmd
comma
id|R1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|priv-&gt;rx_ptr
OL
id|BUF_SIZE
)paren
id|priv-&gt;rx_buf
(braket
id|priv-&gt;rx_head
)braket
(braket
id|priv-&gt;rx_ptr
op_increment
)braket
op_assign
id|read_scc
c_func
(paren
id|cmd
comma
id|R8
)paren
suffix:semicolon
r_else
(brace
id|priv-&gt;rx_over
op_assign
l_int|2
suffix:semicolon
id|read_scc
c_func
(paren
id|cmd
comma
id|R8
)paren
suffix:semicolon
)brace
id|special_condition
c_func
(paren
id|dev
comma
id|rc
)paren
suffix:semicolon
)brace
)brace
)brace
DECL|function|special_condition
r_static
r_void
id|special_condition
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
r_int
id|rc
)paren
(brace
r_struct
id|scc_priv
op_star
id|priv
op_assign
id|dev-&gt;priv
suffix:semicolon
r_int
id|cb
comma
id|cmd
op_assign
id|priv-&gt;cmd
suffix:semicolon
multiline_comment|/* See Figure 2-15. Only overrun and EOF need to be checked. */
r_if
c_cond
(paren
id|rc
op_amp
id|Rx_OVR
)paren
(brace
multiline_comment|/* Receiver overrun */
id|priv-&gt;rx_over
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dev-&gt;dma
)paren
id|write_scc
c_func
(paren
id|cmd
comma
id|R0
comma
id|ERR_RES
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|rc
op_amp
id|END_FR
)paren
(brace
multiline_comment|/* End of frame. Get byte count */
r_if
c_cond
(paren
id|dev-&gt;dma
)paren
(brace
id|disable_dma
c_func
(paren
id|dev-&gt;dma
)paren
suffix:semicolon
id|clear_dma_ff
c_func
(paren
id|dev-&gt;dma
)paren
suffix:semicolon
id|cb
op_assign
id|BUF_SIZE
op_minus
id|get_dma_residue
c_func
(paren
id|dev-&gt;dma
)paren
op_minus
l_int|2
suffix:semicolon
)brace
r_else
(brace
id|cb
op_assign
id|priv-&gt;rx_ptr
op_minus
l_int|2
suffix:semicolon
)brace
r_if
c_cond
(paren
id|priv-&gt;rx_over
)paren
(brace
multiline_comment|/* We had an overrun */
id|priv-&gt;stats.rx_errors
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|priv-&gt;rx_over
op_eq
l_int|2
)paren
id|priv-&gt;stats.rx_length_errors
op_increment
suffix:semicolon
r_else
id|priv-&gt;stats.rx_fifo_errors
op_increment
suffix:semicolon
id|priv-&gt;rx_over
op_assign
l_int|0
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|rc
op_amp
id|CRC_ERR
)paren
(brace
multiline_comment|/* Count invalid CRC only if packet length &gt;= minimum */
r_if
c_cond
(paren
id|cb
op_ge
l_int|8
)paren
(brace
id|priv-&gt;stats.rx_errors
op_increment
suffix:semicolon
id|priv-&gt;stats.rx_crc_errors
op_increment
suffix:semicolon
)brace
)brace
r_else
(brace
r_if
c_cond
(paren
id|cb
op_ge
l_int|8
)paren
(brace
multiline_comment|/* Put good frame in FIFO */
id|priv-&gt;rx_len
(braket
id|priv-&gt;rx_head
)braket
op_assign
id|cb
suffix:semicolon
id|priv-&gt;rx_head
op_assign
(paren
id|priv-&gt;rx_head
op_plus
l_int|1
)paren
op_mod
id|NUM_RX_BUF
suffix:semicolon
id|priv-&gt;rx_count
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|priv-&gt;rx_count
op_eq
id|NUM_RX_BUF
)paren
(brace
multiline_comment|/* Disable receiver if FIFO full */
id|write_scc
c_func
(paren
id|cmd
comma
id|R3
comma
id|Rx8
)paren
suffix:semicolon
id|priv-&gt;stats.rx_errors
op_increment
suffix:semicolon
id|priv-&gt;stats.rx_over_errors
op_increment
suffix:semicolon
)brace
multiline_comment|/* Mark bottom half handler */
id|queue_task
c_func
(paren
op_amp
id|priv-&gt;rx_task
comma
op_amp
id|tq_immediate
)paren
suffix:semicolon
id|mark_bh
c_func
(paren
id|IMMEDIATE_BH
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* Get ready for new frame */
r_if
c_cond
(paren
id|dev-&gt;dma
)paren
(brace
id|set_dma_addr
c_func
(paren
id|dev-&gt;dma
comma
(paren
r_int
)paren
id|priv-&gt;rx_buf
(braket
id|priv-&gt;rx_head
)braket
)paren
suffix:semicolon
id|set_dma_count
c_func
(paren
id|dev-&gt;dma
comma
id|BUF_SIZE
)paren
suffix:semicolon
id|enable_dma
c_func
(paren
id|dev-&gt;dma
)paren
suffix:semicolon
)brace
r_else
(brace
id|priv-&gt;rx_ptr
op_assign
l_int|0
suffix:semicolon
)brace
)brace
)brace
DECL|function|rx_bh
r_static
r_void
id|rx_bh
c_func
(paren
r_void
op_star
id|arg
)paren
(brace
r_struct
id|device
op_star
id|dev
op_assign
id|arg
suffix:semicolon
r_struct
id|scc_priv
op_star
id|priv
op_assign
id|dev-&gt;priv
suffix:semicolon
r_struct
id|scc_info
op_star
id|info
op_assign
id|priv-&gt;info
suffix:semicolon
r_int
id|cmd
op_assign
id|priv-&gt;cmd
suffix:semicolon
r_int
id|i
op_assign
id|priv-&gt;rx_tail
suffix:semicolon
r_int
id|cb
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
r_int
r_char
op_star
id|data
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
r_while
c_loop
(paren
id|priv-&gt;rx_count
)paren
(brace
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cb
op_assign
id|priv-&gt;rx_len
(braket
id|i
)braket
suffix:semicolon
multiline_comment|/* Allocate buffer */
id|skb
op_assign
id|dev_alloc_skb
c_func
(paren
id|cb
op_plus
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|skb
op_eq
l_int|NULL
)paren
(brace
multiline_comment|/* Drop packet */
id|priv-&gt;stats.rx_dropped
op_increment
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* Fill buffer */
id|data
op_assign
id|skb_put
c_func
(paren
id|skb
comma
id|cb
op_plus
l_int|1
)paren
suffix:semicolon
id|data
(braket
l_int|0
)braket
op_assign
l_int|0
suffix:semicolon
id|memcpy
c_func
(paren
op_amp
id|data
(braket
l_int|1
)braket
comma
id|priv-&gt;rx_buf
(braket
id|i
)braket
comma
id|cb
)paren
suffix:semicolon
id|skb-&gt;dev
op_assign
id|dev
suffix:semicolon
id|skb-&gt;protocol
op_assign
id|ntohs
c_func
(paren
id|ETH_P_AX25
)paren
suffix:semicolon
id|skb-&gt;mac.raw
op_assign
id|skb-&gt;data
suffix:semicolon
id|netif_rx
c_func
(paren
id|skb
)paren
suffix:semicolon
id|priv-&gt;stats.rx_packets
op_increment
suffix:semicolon
)brace
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* Enable receiver if RX buffers have been unavailable */
r_if
c_cond
(paren
(paren
id|priv-&gt;rx_count
op_eq
id|NUM_RX_BUF
)paren
op_logical_and
(paren
id|priv-&gt;status
op_amp
id|DCD
)paren
)paren
(brace
r_if
c_cond
(paren
id|info-&gt;type
op_le
id|TYPE_PI2
)paren
id|outb_p
c_func
(paren
l_int|0
comma
id|dev-&gt;base_addr
op_plus
id|PI_DREQ_MASK
)paren
suffix:semicolon
id|write_scc
c_func
(paren
id|cmd
comma
id|R3
comma
id|RxENABLE
op_or
id|Rx8
op_or
id|RxCRC_ENAB
)paren
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;type
op_le
id|TYPE_PI2
)paren
id|outb_p
c_func
(paren
l_int|1
comma
id|dev-&gt;base_addr
op_plus
id|PI_DREQ_MASK
)paren
suffix:semicolon
)brace
multiline_comment|/* Move tail */
id|priv-&gt;rx_tail
op_assign
id|i
op_assign
(paren
id|i
op_plus
l_int|1
)paren
op_mod
id|NUM_RX_BUF
suffix:semicolon
id|priv-&gt;rx_count
op_decrement
suffix:semicolon
)brace
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
DECL|function|tx_isr
r_static
r_void
id|tx_isr
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
r_struct
id|scc_priv
op_star
id|priv
op_assign
id|dev-&gt;priv
suffix:semicolon
r_int
id|cmd
op_assign
id|priv-&gt;cmd
suffix:semicolon
r_int
id|i
op_assign
id|priv-&gt;tx_tail
comma
id|p
op_assign
id|priv-&gt;tx_ptr
suffix:semicolon
multiline_comment|/* Suspend TX interrupts if we don&squot;t want to send anything.&n;     See Figure 2-22. */
r_if
c_cond
(paren
id|p
op_eq
id|priv-&gt;tx_len
(braket
id|i
)braket
)paren
(brace
id|write_scc
c_func
(paren
id|cmd
comma
id|R0
comma
id|RES_Tx_P
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/* Write characters */
r_while
c_loop
(paren
(paren
id|read_scc
c_func
(paren
id|cmd
comma
id|R0
)paren
op_amp
id|Tx_BUF_EMP
)paren
op_logical_and
id|p
OL
id|priv-&gt;tx_len
(braket
id|i
)braket
)paren
(brace
id|write_scc
c_func
(paren
id|cmd
comma
id|R8
comma
id|priv-&gt;tx_buf
(braket
id|i
)braket
(braket
id|p
op_increment
)braket
)paren
suffix:semicolon
)brace
id|priv-&gt;tx_ptr
op_assign
id|p
suffix:semicolon
)brace
DECL|function|es_isr
r_static
r_void
id|es_isr
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
r_struct
id|scc_priv
op_star
id|priv
op_assign
id|dev-&gt;priv
suffix:semicolon
r_struct
id|scc_info
op_star
id|info
op_assign
id|priv-&gt;info
suffix:semicolon
r_int
id|i
comma
id|cmd
op_assign
id|priv-&gt;cmd
suffix:semicolon
r_int
id|st
comma
id|dst
comma
id|res
suffix:semicolon
multiline_comment|/* Read status and reset interrupt bit */
id|st
op_assign
id|read_scc
c_func
(paren
id|cmd
comma
id|R0
)paren
suffix:semicolon
id|write_scc
c_func
(paren
id|cmd
comma
id|R0
comma
id|RES_EXT_INT
)paren
suffix:semicolon
id|dst
op_assign
id|priv-&gt;status
op_xor
id|st
suffix:semicolon
id|priv-&gt;status
op_assign
id|st
suffix:semicolon
multiline_comment|/* Since the EOM latch is reset automatically, we assume that&n;     it has been zero if and only if we are in the TX_ACTIVE state.&n;     Otherwise we follow 2.4.9.6. */
multiline_comment|/* Transmit underrun */
r_if
c_cond
(paren
(paren
id|priv-&gt;tx_state
op_eq
id|TX_ACTIVE
)paren
op_logical_and
(paren
id|st
op_amp
id|TxEOM
)paren
)paren
(brace
multiline_comment|/* Get remaining bytes */
id|i
op_assign
id|priv-&gt;tx_tail
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;dma
)paren
(brace
id|disable_dma
c_func
(paren
id|dev-&gt;dma
)paren
suffix:semicolon
id|clear_dma_ff
c_func
(paren
id|dev-&gt;dma
)paren
suffix:semicolon
id|res
op_assign
id|get_dma_residue
c_func
(paren
id|dev-&gt;dma
)paren
suffix:semicolon
)brace
r_else
(brace
id|res
op_assign
id|priv-&gt;tx_len
(braket
id|i
)braket
op_minus
id|priv-&gt;tx_ptr
suffix:semicolon
r_if
c_cond
(paren
id|res
)paren
id|write_scc
c_func
(paren
id|cmd
comma
id|R0
comma
id|RES_Tx_P
)paren
suffix:semicolon
id|priv-&gt;tx_ptr
op_assign
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Remove frame from FIFO */
id|priv-&gt;tx_tail
op_assign
(paren
id|i
op_plus
l_int|1
)paren
op_mod
id|NUM_TX_BUF
suffix:semicolon
id|priv-&gt;tx_count
op_decrement
suffix:semicolon
id|dev-&gt;tbusy
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Check if another frame is available and we are allowed to transmit */
r_if
c_cond
(paren
id|priv-&gt;tx_count
op_logical_and
(paren
id|jiffies
op_minus
id|priv-&gt;tx_start
)paren
OL
id|priv-&gt;param.txtime
)paren
(brace
r_if
c_cond
(paren
id|dev-&gt;dma
)paren
(brace
id|set_dma_addr
c_func
(paren
id|dev-&gt;dma
comma
(paren
r_int
)paren
id|priv-&gt;tx_buf
(braket
id|priv-&gt;tx_tail
)braket
)paren
suffix:semicolon
id|set_dma_count
c_func
(paren
id|dev-&gt;dma
comma
id|priv-&gt;tx_len
(braket
id|priv-&gt;tx_tail
)braket
)paren
suffix:semicolon
id|enable_dma
c_func
(paren
id|dev-&gt;dma
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* If we have an ESCC, we are allowed to write data bytes&n;&t;   immediately. Otherwise we have to wait for the next&n;&t;   TX interrupt. See Figure 2-22. */
r_if
c_cond
(paren
id|info-&gt;chip
op_eq
id|Z85230
)paren
(brace
id|tx_isr
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
)brace
)brace
r_else
(brace
multiline_comment|/* No frame available. Disable interrupts. */
id|priv-&gt;tx_state
op_assign
id|TX_SQDELAY
suffix:semicolon
id|delay
c_func
(paren
id|dev
comma
id|priv-&gt;param.sqdelay
)paren
suffix:semicolon
id|write_scc
c_func
(paren
id|cmd
comma
id|R15
comma
id|DCDIE
op_or
id|CTSIE
op_or
id|SYNCIE
)paren
suffix:semicolon
id|write_scc
c_func
(paren
id|cmd
comma
id|R1
comma
id|EXT_INT_ENAB
op_or
id|WT_FN_RDYFN
)paren
suffix:semicolon
)brace
multiline_comment|/* Update packet statistics */
r_if
c_cond
(paren
id|res
)paren
(brace
id|priv-&gt;stats.tx_errors
op_increment
suffix:semicolon
id|priv-&gt;stats.tx_fifo_errors
op_increment
suffix:semicolon
)brace
r_else
(brace
id|priv-&gt;stats.tx_packets
op_increment
suffix:semicolon
)brace
multiline_comment|/* Inform upper layers */
id|mark_bh
c_func
(paren
id|NET_BH
)paren
suffix:semicolon
)brace
multiline_comment|/* DCD transition */
r_if
c_cond
(paren
(paren
id|priv-&gt;tx_state
OL
id|TX_TXDELAY
)paren
op_logical_and
(paren
id|dst
op_amp
id|DCD
)paren
)paren
(brace
multiline_comment|/* Transmitter state change */
id|priv-&gt;tx_state
op_assign
id|TX_OFF
suffix:semicolon
multiline_comment|/* Enable or disable receiver */
r_if
c_cond
(paren
id|st
op_amp
id|DCD
)paren
(brace
r_if
c_cond
(paren
id|dev-&gt;dma
)paren
(brace
multiline_comment|/* Program DMA controller */
id|disable_dma
c_func
(paren
id|dev-&gt;dma
)paren
suffix:semicolon
id|clear_dma_ff
c_func
(paren
id|dev-&gt;dma
)paren
suffix:semicolon
id|set_dma_mode
c_func
(paren
id|dev-&gt;dma
comma
id|DMA_MODE_READ
)paren
suffix:semicolon
id|set_dma_addr
c_func
(paren
id|dev-&gt;dma
comma
(paren
r_int
)paren
id|priv-&gt;rx_buf
(braket
id|priv-&gt;rx_head
)braket
)paren
suffix:semicolon
id|set_dma_count
c_func
(paren
id|dev-&gt;dma
comma
id|BUF_SIZE
)paren
suffix:semicolon
id|enable_dma
c_func
(paren
id|dev-&gt;dma
)paren
suffix:semicolon
multiline_comment|/* Configure PackeTwin DMA */
r_if
c_cond
(paren
id|info-&gt;type
op_eq
id|TYPE_TWIN
)paren
(brace
id|outb_p
c_func
(paren
(paren
id|dev-&gt;dma
op_eq
l_int|1
)paren
ques
c_cond
id|TWIN_DMA_HDX_R1
suffix:colon
id|TWIN_DMA_HDX_R3
comma
id|dev-&gt;base_addr
op_plus
id|TWIN_DMA_CFG
)paren
suffix:semicolon
)brace
multiline_comment|/* Sp. cond. intr. only, ext int enable */
id|write_scc
c_func
(paren
id|cmd
comma
id|R1
comma
id|EXT_INT_ENAB
op_or
id|INT_ERR_Rx
op_or
id|WT_RDY_RT
op_or
id|WT_FN_RDYFN
op_or
id|WT_RDY_ENAB
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* Intr. on all Rx characters and Sp. cond., ext int enable */
id|write_scc
c_func
(paren
id|cmd
comma
id|R1
comma
id|EXT_INT_ENAB
op_or
id|INT_ALL_Rx
op_or
id|WT_RDY_RT
op_or
id|WT_FN_RDYFN
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|priv-&gt;rx_count
OL
id|NUM_RX_BUF
)paren
(brace
multiline_comment|/* Enable receiver */
id|write_scc
c_func
(paren
id|cmd
comma
id|R3
comma
id|RxENABLE
op_or
id|Rx8
op_or
id|RxCRC_ENAB
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
multiline_comment|/* Disable DMA */
r_if
c_cond
(paren
id|dev-&gt;dma
)paren
id|disable_dma
c_func
(paren
id|dev-&gt;dma
)paren
suffix:semicolon
multiline_comment|/* Disable receiver */
id|write_scc
c_func
(paren
id|cmd
comma
id|R3
comma
id|Rx8
)paren
suffix:semicolon
multiline_comment|/* DMA disable, RX int disable, Ext int enable */
id|write_scc
c_func
(paren
id|cmd
comma
id|R1
comma
id|EXT_INT_ENAB
op_or
id|WT_RDY_RT
op_or
id|WT_FN_RDYFN
)paren
suffix:semicolon
multiline_comment|/* Transmitter state change */
r_if
c_cond
(paren
id|random
c_func
(paren
)paren
OG
id|priv-&gt;param.persist
)paren
id|delay
c_func
(paren
id|dev
comma
id|priv-&gt;param.slottime
)paren
suffix:semicolon
r_else
(brace
r_if
c_cond
(paren
id|priv-&gt;tx_count
)paren
(brace
id|priv-&gt;tx_state
op_assign
id|TX_TXDELAY
suffix:semicolon
id|write_scc
c_func
(paren
id|cmd
comma
id|R5
comma
id|TxCRC_ENAB
op_or
id|RTS
op_or
id|TxENAB
op_or
id|Tx8
)paren
suffix:semicolon
id|priv-&gt;tx_start
op_assign
id|jiffies
suffix:semicolon
id|delay
c_func
(paren
id|dev
comma
id|priv-&gt;param.txdelay
)paren
suffix:semicolon
)brace
r_else
(brace
id|priv-&gt;tx_state
op_assign
id|TX_IDLE
suffix:semicolon
)brace
)brace
)brace
)brace
multiline_comment|/* CTS transition */
r_if
c_cond
(paren
(paren
id|info-&gt;type
op_le
id|TYPE_PI2
)paren
op_logical_and
(paren
id|dst
op_amp
id|CTS
)paren
op_logical_and
(paren
op_complement
id|st
op_amp
id|CTS
)paren
)paren
(brace
multiline_comment|/* Timer has expired */
id|tm_isr
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
multiline_comment|/* /SYNC/HUNT transition */
r_if
c_cond
(paren
(paren
id|dst
op_amp
id|SYNC_HUNT
)paren
op_logical_and
(paren
op_complement
id|st
op_amp
id|SYNC_HUNT
)paren
)paren
(brace
multiline_comment|/* Reset current frame and clear RX FIFO */
r_while
c_loop
(paren
id|read_scc
c_func
(paren
id|cmd
comma
id|R0
)paren
op_amp
id|Rx_CH_AV
)paren
id|read_scc
c_func
(paren
id|cmd
comma
id|R8
)paren
suffix:semicolon
id|priv-&gt;rx_over
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;dma
)paren
(brace
id|disable_dma
c_func
(paren
id|dev-&gt;dma
)paren
suffix:semicolon
id|clear_dma_ff
c_func
(paren
id|dev-&gt;dma
)paren
suffix:semicolon
id|set_dma_addr
c_func
(paren
id|dev-&gt;dma
comma
(paren
r_int
)paren
id|priv-&gt;rx_buf
(braket
id|priv-&gt;rx_head
)braket
)paren
suffix:semicolon
id|set_dma_count
c_func
(paren
id|dev-&gt;dma
comma
id|BUF_SIZE
)paren
suffix:semicolon
id|enable_dma
c_func
(paren
id|dev-&gt;dma
)paren
suffix:semicolon
)brace
r_else
(brace
id|priv-&gt;rx_ptr
op_assign
l_int|0
suffix:semicolon
)brace
)brace
)brace
DECL|function|tm_isr
r_static
r_void
id|tm_isr
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
r_struct
id|scc_priv
op_star
id|priv
op_assign
id|dev-&gt;priv
suffix:semicolon
r_struct
id|scc_info
op_star
id|info
op_assign
id|priv-&gt;info
suffix:semicolon
r_int
id|cmd
op_assign
id|priv-&gt;cmd
suffix:semicolon
r_switch
c_cond
(paren
id|priv-&gt;tx_state
)paren
(brace
r_case
id|TX_OFF
suffix:colon
r_if
c_cond
(paren
op_complement
id|priv-&gt;status
op_amp
id|DCD
)paren
(brace
r_if
c_cond
(paren
id|random
c_func
(paren
)paren
OG
id|priv-&gt;param.persist
)paren
id|delay
c_func
(paren
id|dev
comma
id|priv-&gt;param.slottime
)paren
suffix:semicolon
r_else
(brace
r_if
c_cond
(paren
id|priv-&gt;tx_count
)paren
(brace
id|priv-&gt;tx_state
op_assign
id|TX_TXDELAY
suffix:semicolon
id|write_scc
c_func
(paren
id|cmd
comma
id|R5
comma
id|TxCRC_ENAB
op_or
id|RTS
op_or
id|TxENAB
op_or
id|Tx8
)paren
suffix:semicolon
id|priv-&gt;tx_start
op_assign
id|jiffies
suffix:semicolon
id|delay
c_func
(paren
id|dev
comma
id|priv-&gt;param.txdelay
)paren
suffix:semicolon
)brace
r_else
(brace
id|priv-&gt;tx_state
op_assign
id|TX_IDLE
suffix:semicolon
)brace
)brace
)brace
r_break
suffix:semicolon
r_case
id|TX_TXDELAY
suffix:colon
id|priv-&gt;tx_state
op_assign
id|TX_ACTIVE
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;dma
)paren
(brace
multiline_comment|/* Program DMA controller */
id|disable_dma
c_func
(paren
id|dev-&gt;dma
)paren
suffix:semicolon
id|clear_dma_ff
c_func
(paren
id|dev-&gt;dma
)paren
suffix:semicolon
id|set_dma_mode
c_func
(paren
id|dev-&gt;dma
comma
id|DMA_MODE_WRITE
)paren
suffix:semicolon
id|set_dma_addr
c_func
(paren
id|dev-&gt;dma
comma
(paren
r_int
)paren
id|priv-&gt;tx_buf
(braket
id|priv-&gt;tx_tail
)braket
)paren
suffix:semicolon
id|set_dma_count
c_func
(paren
id|dev-&gt;dma
comma
id|priv-&gt;tx_len
(braket
id|priv-&gt;tx_tail
)braket
)paren
suffix:semicolon
id|enable_dma
c_func
(paren
id|dev-&gt;dma
)paren
suffix:semicolon
multiline_comment|/* Configure PackeTwin DMA */
r_if
c_cond
(paren
id|info-&gt;type
op_eq
id|TYPE_TWIN
)paren
(brace
id|outb_p
c_func
(paren
(paren
id|dev-&gt;dma
op_eq
l_int|1
)paren
ques
c_cond
id|TWIN_DMA_HDX_T1
suffix:colon
id|TWIN_DMA_HDX_T3
comma
id|dev-&gt;base_addr
op_plus
id|TWIN_DMA_CFG
)paren
suffix:semicolon
)brace
multiline_comment|/* Enable interrupts and DMA. On the PackeTwin, the DTR//REQ pin&n;&t; is used for TX DMA requests, but we enable the WAIT/DMA request&n;&t; pin, anyway */
id|write_scc
c_func
(paren
id|cmd
comma
id|R15
comma
id|TxUIE
op_or
id|DCDIE
op_or
id|CTSIE
op_or
id|SYNCIE
)paren
suffix:semicolon
id|write_scc
c_func
(paren
id|cmd
comma
id|R1
comma
id|EXT_INT_ENAB
op_or
id|WT_FN_RDYFN
op_or
id|WT_RDY_ENAB
)paren
suffix:semicolon
)brace
r_else
(brace
id|write_scc
c_func
(paren
id|cmd
comma
id|R15
comma
id|TxUIE
op_or
id|DCDIE
op_or
id|CTSIE
op_or
id|SYNCIE
)paren
suffix:semicolon
id|write_scc
c_func
(paren
id|cmd
comma
id|R1
comma
id|EXT_INT_ENAB
op_or
id|WT_FN_RDYFN
op_or
id|TxINT_ENAB
)paren
suffix:semicolon
id|tx_isr
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|info-&gt;chip
op_eq
id|Z8530
)paren
id|write_scc
c_func
(paren
id|cmd
comma
id|R0
comma
id|RES_EOM_L
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|TX_SQDELAY
suffix:colon
multiline_comment|/* Disable transmitter */
id|write_scc
c_func
(paren
id|cmd
comma
id|R5
comma
id|TxCRC_ENAB
op_or
id|Tx8
)paren
suffix:semicolon
multiline_comment|/* Transmitter state change: Switch to TX_OFF and wait at least&n;       1 slottime. */
id|priv-&gt;tx_state
op_assign
id|TX_OFF
suffix:semicolon
r_if
c_cond
(paren
op_complement
id|priv-&gt;status
op_amp
id|DCD
)paren
id|delay
c_func
(paren
id|dev
comma
id|priv-&gt;param.waittime
)paren
suffix:semicolon
)brace
)brace
DECL|function|delay
r_static
r_inline
r_void
id|delay
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
r_int
id|t
)paren
(brace
r_struct
id|scc_priv
op_star
id|priv
op_assign
id|dev-&gt;priv
suffix:semicolon
r_int
id|tmr
op_assign
id|priv-&gt;tmr
suffix:semicolon
id|outb_p
c_func
(paren
id|t
op_amp
l_int|0xFF
comma
id|tmr
)paren
suffix:semicolon
id|outb_p
c_func
(paren
(paren
id|t
op_rshift
l_int|8
)paren
op_amp
l_int|0xFF
comma
id|tmr
)paren
suffix:semicolon
)brace
DECL|function|random
r_static
r_inline
r_int
r_char
id|random
c_func
(paren
r_void
)paren
(brace
multiline_comment|/* See &quot;Numerical Recipes in C&quot;, second edition, p. 284 */
id|rand
op_assign
id|rand
op_star
l_int|1664525L
op_plus
l_int|1013904223L
suffix:semicolon
r_return
(paren
r_int
r_char
)paren
(paren
id|rand
op_rshift
l_int|24
)paren
suffix:semicolon
)brace
eof
