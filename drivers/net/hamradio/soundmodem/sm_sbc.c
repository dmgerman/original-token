multiline_comment|/*&n; *&t;sm_sbc.c  -- soundcard radio modem driver soundblaster hardware driver&n; *&n; *&t;Copyright (C) 1996  Thomas Sailer (sailer@ife.ee.ethz.ch)&n; *&n; *&t;This program is free software; you can redistribute it and/or modify&n; *&t;it under the terms of the GNU General Public License as published by&n; *&t;the Free Software Foundation; either version 2 of the License, or&n; *&t;(at your option) any later version.&n; *&n; *&t;This program is distributed in the hope that it will be useful,&n; *&t;but WITHOUT ANY WARRANTY; without even the implied warranty of&n; *&t;MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the&n; *&t;GNU General Public License for more details.&n; *&n; *&t;You should have received a copy of the GNU General Public License&n; *&t;along with this program; if not, write to the Free Software&n; *&t;Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.&n; *&n; *  Please note that the GPL allows you to use the driver, NOT the radio.&n; *  In order to use the radio, you need a license from the communications&n; *  authority of your country.&n; *&n; */
macro_line|#include &lt;linux/ptrace.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/interrupt.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/dma.h&gt;
macro_line|#include &lt;linux/ioport.h&gt;
macro_line|#include &lt;linux/soundmodem.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &quot;sm.h&quot;
macro_line|#include &quot;smdma.h&quot;
multiline_comment|/* --------------------------------------------------------------------- */
multiline_comment|/*&n; * currently this module is supposed to support both module styles, i.e.&n; * the old one present up to about 2.1.9, and the new one functioning&n; * starting with 2.1.21. The reason is I have a kit allowing to compile&n; * this module also under 2.0.x which was requested by several people.&n; * This will go in 2.2&n; */
macro_line|#include &lt;linux/version.h&gt;
macro_line|#if LINUX_VERSION_CODE &gt;= 0x20100
macro_line|#include &lt;asm/uaccess.h&gt;
macro_line|#else
macro_line|#include &lt;asm/segment.h&gt;
macro_line|#include &lt;linux/mm.h&gt;
DECL|macro|put_user
macro_line|#undef put_user
DECL|macro|get_user
macro_line|#undef get_user
DECL|macro|put_user
mdefine_line|#define put_user(x,ptr) ({ __put_user((unsigned long)(x),(ptr),sizeof(*(ptr))); 0; })
DECL|macro|get_user
mdefine_line|#define get_user(x,ptr) ({ x = ((__typeof__(*(ptr)))__get_user((ptr),sizeof(*(ptr)))); 0; })
DECL|function|copy_from_user
r_extern
r_inline
r_int
id|copy_from_user
c_func
(paren
r_void
op_star
id|to
comma
r_const
r_void
op_star
id|from
comma
r_int
r_int
id|n
)paren
(brace
r_int
id|i
op_assign
id|verify_area
c_func
(paren
id|VERIFY_READ
comma
id|from
comma
id|n
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
)paren
r_return
id|i
suffix:semicolon
id|memcpy_fromfs
c_func
(paren
id|to
comma
id|from
comma
id|n
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|copy_to_user
r_extern
r_inline
r_int
id|copy_to_user
c_func
(paren
r_void
op_star
id|to
comma
r_const
r_void
op_star
id|from
comma
r_int
r_int
id|n
)paren
(brace
r_int
id|i
op_assign
id|verify_area
c_func
(paren
id|VERIFY_WRITE
comma
id|to
comma
id|n
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
)paren
r_return
id|i
suffix:semicolon
id|memcpy_tofs
c_func
(paren
id|to
comma
id|from
comma
id|n
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#endif
multiline_comment|/* --------------------------------------------------------------------- */
DECL|struct|sc_state_sbc
r_struct
id|sc_state_sbc
(brace
DECL|member|revhi
DECL|member|revlo
r_int
r_char
id|revhi
comma
id|revlo
suffix:semicolon
DECL|member|fmt
r_int
r_char
id|fmt
(braket
l_int|2
)braket
suffix:semicolon
DECL|member|sr
r_int
r_int
id|sr
(braket
l_int|2
)braket
suffix:semicolon
)brace
suffix:semicolon
DECL|macro|SCSTATE
mdefine_line|#define SCSTATE ((struct sc_state_sbc *)(&amp;sm-&gt;hw))
multiline_comment|/* --------------------------------------------------------------------- */
multiline_comment|/* &n; * the sbc converter&squot;s registers &n; */
DECL|macro|DSP_RESET
mdefine_line|#define DSP_RESET(iobase)        (iobase+0x6)
DECL|macro|DSP_READ_DATA
mdefine_line|#define DSP_READ_DATA(iobase)    (iobase+0xa)
DECL|macro|DSP_WRITE_DATA
mdefine_line|#define DSP_WRITE_DATA(iobase)   (iobase+0xc)
DECL|macro|DSP_WRITE_STATUS
mdefine_line|#define DSP_WRITE_STATUS(iobase) (iobase+0xc)
DECL|macro|DSP_DATA_AVAIL
mdefine_line|#define DSP_DATA_AVAIL(iobase)   (iobase+0xe)
DECL|macro|DSP_MIXER_ADDR
mdefine_line|#define DSP_MIXER_ADDR(iobase)   (iobase+0x4)
DECL|macro|DSP_MIXER_DATA
mdefine_line|#define DSP_MIXER_DATA(iobase)   (iobase+0x5)
DECL|macro|DSP_INTACK_16BIT
mdefine_line|#define DSP_INTACK_16BIT(iobase) (iobase+0xf)
DECL|macro|SBC_EXTENT
mdefine_line|#define SBC_EXTENT               16
multiline_comment|/* --------------------------------------------------------------------- */
multiline_comment|/*&n; * SBC commands&n; */
DECL|macro|SBC_OUTPUT
mdefine_line|#define SBC_OUTPUT             0x14
DECL|macro|SBC_INPUT
mdefine_line|#define SBC_INPUT              0x24
DECL|macro|SBC_BLOCKSIZE
mdefine_line|#define SBC_BLOCKSIZE          0x48
DECL|macro|SBC_HI_OUTPUT
mdefine_line|#define SBC_HI_OUTPUT          0x91 
DECL|macro|SBC_HI_INPUT
mdefine_line|#define SBC_HI_INPUT           0x99 
DECL|macro|SBC_LO_OUTPUT_AUTOINIT
mdefine_line|#define SBC_LO_OUTPUT_AUTOINIT 0x1c
DECL|macro|SBC_LO_INPUT_AUTOINIT
mdefine_line|#define SBC_LO_INPUT_AUTOINIT  0x2c
DECL|macro|SBC_HI_OUTPUT_AUTOINIT
mdefine_line|#define SBC_HI_OUTPUT_AUTOINIT 0x90 
DECL|macro|SBC_HI_INPUT_AUTOINIT
mdefine_line|#define SBC_HI_INPUT_AUTOINIT  0x98
DECL|macro|SBC_IMMED_INT
mdefine_line|#define SBC_IMMED_INT          0xf2
DECL|macro|SBC_GET_REVISION
mdefine_line|#define SBC_GET_REVISION       0xe1
DECL|macro|ESS_GET_REVISION
mdefine_line|#define ESS_GET_REVISION       0xe7
DECL|macro|SBC_SPEAKER_ON
mdefine_line|#define SBC_SPEAKER_ON         0xd1
DECL|macro|SBC_SPEAKER_OFF
mdefine_line|#define SBC_SPEAKER_OFF        0xd3
DECL|macro|SBC_DMA_ON
mdefine_line|#define SBC_DMA_ON             0xd0
DECL|macro|SBC_DMA_OFF
mdefine_line|#define SBC_DMA_OFF            0xd4
DECL|macro|SBC_SAMPLE_RATE
mdefine_line|#define SBC_SAMPLE_RATE        0x40
DECL|macro|SBC_SAMPLE_RATE_OUT
mdefine_line|#define SBC_SAMPLE_RATE_OUT    0x41
DECL|macro|SBC_SAMPLE_RATE_IN
mdefine_line|#define SBC_SAMPLE_RATE_IN     0x42
DECL|macro|SBC_MONO_8BIT
mdefine_line|#define SBC_MONO_8BIT          0xa0
DECL|macro|SBC_MONO_16BIT
mdefine_line|#define SBC_MONO_16BIT         0xa4
DECL|macro|SBC_STEREO_8BIT
mdefine_line|#define SBC_STEREO_8BIT        0xa8
DECL|macro|SBC_STEREO_16BIT
mdefine_line|#define SBC_STEREO_16BIT       0xac
DECL|macro|SBC4_OUT8_AI
mdefine_line|#define SBC4_OUT8_AI           0xc6
DECL|macro|SBC4_IN8_AI
mdefine_line|#define SBC4_IN8_AI            0xce
DECL|macro|SBC4_MODE_UNS_MONO
mdefine_line|#define SBC4_MODE_UNS_MONO     0x00
DECL|macro|SBC4_MODE_SIGN_MONO
mdefine_line|#define SBC4_MODE_SIGN_MONO    0x10
DECL|macro|SBC4_OUT16_AI
mdefine_line|#define SBC4_OUT16_AI          0xb6
DECL|macro|SBC4_IN16_AI
mdefine_line|#define SBC4_IN16_AI           0xbe
multiline_comment|/* --------------------------------------------------------------------- */
DECL|function|reset_dsp
r_static
r_int
r_inline
id|reset_dsp
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_int
id|i
suffix:semicolon
id|outb
c_func
(paren
l_int|1
comma
id|DSP_RESET
c_func
(paren
id|dev-&gt;base_addr
)paren
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|300
)paren
suffix:semicolon
id|outb
c_func
(paren
l_int|0
comma
id|DSP_RESET
c_func
(paren
id|dev-&gt;base_addr
)paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|0xffff
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
id|inb
c_func
(paren
id|DSP_DATA_AVAIL
c_func
(paren
id|dev-&gt;base_addr
)paren
)paren
op_amp
l_int|0x80
)paren
r_if
c_cond
(paren
id|inb
c_func
(paren
id|DSP_READ_DATA
c_func
(paren
id|dev-&gt;base_addr
)paren
)paren
op_eq
l_int|0xaa
)paren
r_return
l_int|1
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* --------------------------------------------------------------------- */
DECL|function|write_dsp
r_static
r_void
r_inline
id|write_dsp
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_int
r_char
id|data
)paren
(brace
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|0xffff
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
op_logical_neg
(paren
id|inb
c_func
(paren
id|DSP_WRITE_STATUS
c_func
(paren
id|dev-&gt;base_addr
)paren
)paren
op_amp
l_int|0x80
)paren
)paren
(brace
id|outb
c_func
(paren
id|data
comma
id|DSP_WRITE_DATA
c_func
(paren
id|dev-&gt;base_addr
)paren
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
)brace
multiline_comment|/* --------------------------------------------------------------------- */
DECL|function|read_dsp
r_static
r_int
r_inline
id|read_dsp
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_int
r_char
op_star
id|data
)paren
(brace
r_int
id|i
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|data
)paren
r_return
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|0xffff
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
id|inb
c_func
(paren
id|DSP_DATA_AVAIL
c_func
(paren
id|dev-&gt;base_addr
)paren
)paren
op_amp
l_int|0x80
)paren
(brace
op_star
id|data
op_assign
id|inb
c_func
(paren
id|DSP_READ_DATA
c_func
(paren
id|dev-&gt;base_addr
)paren
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* --------------------------------------------------------------------- */
DECL|function|config_resources
r_static
r_int
id|config_resources
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_struct
id|sm_state
op_star
id|sm
comma
r_int
id|fdx
)paren
(brace
r_int
r_char
id|irqreg
op_assign
l_int|0
comma
id|dmareg
op_assign
l_int|0
comma
id|realirq
comma
id|realdma
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_switch
c_cond
(paren
id|dev-&gt;irq
)paren
(brace
r_case
l_int|2
suffix:colon
r_case
l_int|9
suffix:colon
id|irqreg
op_or_assign
l_int|0x01
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|5
suffix:colon
id|irqreg
op_or_assign
l_int|0x02
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|7
suffix:colon
id|irqreg
op_or_assign
l_int|0x04
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|10
suffix:colon
id|irqreg
op_or_assign
l_int|0x08
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
r_switch
c_cond
(paren
id|dev-&gt;dma
)paren
(brace
r_case
l_int|0
suffix:colon
id|dmareg
op_or_assign
l_int|0x01
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|1
suffix:colon
id|dmareg
op_or_assign
l_int|0x02
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|3
suffix:colon
id|dmareg
op_or_assign
l_int|0x08
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
r_if
c_cond
(paren
id|fdx
)paren
(brace
r_switch
c_cond
(paren
id|sm-&gt;hdrv.ptt_out.dma2
)paren
(brace
r_case
l_int|5
suffix:colon
id|dmareg
op_or_assign
l_int|0x20
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|6
suffix:colon
id|dmareg
op_or_assign
l_int|0x40
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|7
suffix:colon
id|dmareg
op_or_assign
l_int|0x80
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
)brace
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|outb
c_func
(paren
l_int|0x80
comma
id|DSP_MIXER_ADDR
c_func
(paren
id|dev-&gt;base_addr
)paren
)paren
suffix:semicolon
id|outb
c_func
(paren
id|irqreg
comma
id|DSP_MIXER_DATA
c_func
(paren
id|dev-&gt;base_addr
)paren
)paren
suffix:semicolon
id|realirq
op_assign
id|inb
c_func
(paren
id|DSP_MIXER_DATA
c_func
(paren
id|dev-&gt;base_addr
)paren
)paren
suffix:semicolon
id|outb
c_func
(paren
l_int|0x81
comma
id|DSP_MIXER_ADDR
c_func
(paren
id|dev-&gt;base_addr
)paren
)paren
suffix:semicolon
id|outb
c_func
(paren
id|dmareg
comma
id|DSP_MIXER_DATA
c_func
(paren
id|dev-&gt;base_addr
)paren
)paren
suffix:semicolon
id|realdma
op_assign
id|inb
c_func
(paren
id|DSP_MIXER_DATA
c_func
(paren
id|dev-&gt;base_addr
)paren
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
op_complement
id|realirq
)paren
op_amp
id|irqreg
op_logical_or
(paren
op_complement
id|realdma
)paren
op_amp
id|dmareg
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: sbc resource registers cannot be set; PnP device &quot;
l_string|&quot;and IRQ/DMA specified wrongly?&bslash;n&quot;
comma
id|sm_drvname
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* --------------------------------------------------------------------- */
DECL|function|sbc_int_ack_8bit
r_static
r_void
r_inline
id|sbc_int_ack_8bit
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
id|inb
c_func
(paren
id|DSP_DATA_AVAIL
c_func
(paren
id|dev-&gt;base_addr
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/* --------------------------------------------------------------------- */
DECL|function|sbc_int_ack_16bit
r_static
r_void
r_inline
id|sbc_int_ack_16bit
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
id|inb
c_func
(paren
id|DSP_INTACK_16BIT
c_func
(paren
id|dev-&gt;base_addr
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/* --------------------------------------------------------------------- */
DECL|function|setup_dma_dsp
r_static
r_void
id|setup_dma_dsp
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_struct
id|sm_state
op_star
id|sm
comma
r_int
id|send
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
r_static
r_const
r_int
r_char
id|sbcmode
(braket
l_int|2
)braket
(braket
l_int|2
)braket
op_assign
(brace
(brace
id|SBC_LO_INPUT_AUTOINIT
comma
id|SBC_LO_OUTPUT_AUTOINIT
)brace
comma
(brace
id|SBC_HI_INPUT_AUTOINIT
comma
id|SBC_HI_OUTPUT_AUTOINIT
)brace
)brace
suffix:semicolon
r_static
r_const
r_int
r_char
id|sbc4mode
(braket
l_int|2
)braket
op_assign
(brace
id|SBC4_IN8_AI
comma
id|SBC4_OUT8_AI
)brace
suffix:semicolon
r_static
r_const
r_int
r_char
id|sbcskr
(braket
l_int|2
)braket
op_assign
(brace
id|SBC_SPEAKER_OFF
comma
id|SBC_SPEAKER_ON
)brace
suffix:semicolon
r_int
r_int
id|nsamps
suffix:semicolon
id|send
op_assign
op_logical_neg
op_logical_neg
id|send
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|reset_dsp
c_func
(paren
id|dev
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: sbc: cannot reset sb dsp&bslash;n&quot;
comma
id|sm_drvname
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|sbc_int_ack_8bit
c_func
(paren
id|dev
)paren
suffix:semicolon
id|write_dsp
c_func
(paren
id|dev
comma
id|SBC_SAMPLE_RATE
)paren
suffix:semicolon
multiline_comment|/* set sampling rate */
id|write_dsp
c_func
(paren
id|dev
comma
id|SCSTATE-&gt;fmt
(braket
id|send
)braket
)paren
suffix:semicolon
id|write_dsp
c_func
(paren
id|dev
comma
id|sbcskr
(braket
id|send
)braket
)paren
suffix:semicolon
id|nsamps
op_assign
id|dma_setup
c_func
(paren
id|sm
comma
id|send
comma
id|dev-&gt;dma
)paren
op_minus
l_int|1
suffix:semicolon
id|sbc_int_ack_8bit
c_func
(paren
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|SCSTATE-&gt;revhi
op_ge
l_int|4
)paren
(brace
id|write_dsp
c_func
(paren
id|dev
comma
id|sbc4mode
(braket
id|send
)braket
)paren
suffix:semicolon
id|write_dsp
c_func
(paren
id|dev
comma
id|SBC4_MODE_UNS_MONO
)paren
suffix:semicolon
id|write_dsp
c_func
(paren
id|dev
comma
id|nsamps
op_amp
l_int|0xff
)paren
suffix:semicolon
id|write_dsp
c_func
(paren
id|dev
comma
id|nsamps
op_rshift
l_int|8
)paren
suffix:semicolon
)brace
r_else
(brace
id|write_dsp
c_func
(paren
id|dev
comma
id|SBC_BLOCKSIZE
)paren
suffix:semicolon
id|write_dsp
c_func
(paren
id|dev
comma
id|nsamps
op_amp
l_int|0xff
)paren
suffix:semicolon
id|write_dsp
c_func
(paren
id|dev
comma
id|nsamps
op_rshift
l_int|8
)paren
suffix:semicolon
id|write_dsp
c_func
(paren
id|dev
comma
id|sbcmode
(braket
id|SCSTATE-&gt;fmt
(braket
id|send
)braket
op_ge
l_int|180
)braket
(braket
id|send
)braket
)paren
suffix:semicolon
multiline_comment|/* hispeed mode if sample rate &gt; 13kHz */
)brace
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
multiline_comment|/* --------------------------------------------------------------------- */
DECL|function|sbc_interrupt
r_static
r_void
id|sbc_interrupt
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_struct
id|net_device
op_star
id|dev
op_assign
(paren
r_struct
id|net_device
op_star
)paren
id|dev_id
suffix:semicolon
r_struct
id|sm_state
op_star
id|sm
op_assign
(paren
r_struct
id|sm_state
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_int
r_int
id|curfrag
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dev
op_logical_or
op_logical_neg
id|sm
op_logical_or
id|sm-&gt;hdrv.magic
op_ne
id|HDLCDRV_MAGIC
)paren
r_return
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|sbc_int_ack_8bit
c_func
(paren
id|dev
)paren
suffix:semicolon
id|disable_dma
c_func
(paren
id|dev-&gt;dma
)paren
suffix:semicolon
id|clear_dma_ff
c_func
(paren
id|dev-&gt;dma
)paren
suffix:semicolon
id|dma_ptr
c_func
(paren
id|sm
comma
id|sm-&gt;dma.ptt_cnt
OG
l_int|0
comma
id|dev-&gt;dma
comma
op_amp
id|curfrag
)paren
suffix:semicolon
id|enable_dma
c_func
(paren
id|dev-&gt;dma
)paren
suffix:semicolon
id|sm_int_freq
c_func
(paren
id|sm
)paren
suffix:semicolon
id|sti
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sm-&gt;dma.ptt_cnt
op_le
l_int|0
)paren
(brace
id|dma_receive
c_func
(paren
id|sm
comma
id|curfrag
)paren
suffix:semicolon
id|hdlcdrv_arbitrate
c_func
(paren
id|dev
comma
op_amp
id|sm-&gt;hdrv
)paren
suffix:semicolon
r_if
c_cond
(paren
id|hdlcdrv_ptt
c_func
(paren
op_amp
id|sm-&gt;hdrv
)paren
)paren
(brace
multiline_comment|/* starting to transmit */
id|disable_dma
c_func
(paren
id|dev-&gt;dma
)paren
suffix:semicolon
id|hdlcdrv_transmitter
c_func
(paren
id|dev
comma
op_amp
id|sm-&gt;hdrv
)paren
suffix:semicolon
multiline_comment|/* prefill HDLC buffer */
id|dma_start_transmit
c_func
(paren
id|sm
)paren
suffix:semicolon
id|setup_dma_dsp
c_func
(paren
id|dev
comma
id|sm
comma
l_int|1
)paren
suffix:semicolon
id|dma_transmit
c_func
(paren
id|sm
)paren
suffix:semicolon
)brace
)brace
r_else
r_if
c_cond
(paren
id|dma_end_transmit
c_func
(paren
id|sm
comma
id|curfrag
)paren
)paren
(brace
multiline_comment|/* stopping transmission */
id|disable_dma
c_func
(paren
id|dev-&gt;dma
)paren
suffix:semicolon
id|sti
c_func
(paren
)paren
suffix:semicolon
id|dma_init_receive
c_func
(paren
id|sm
)paren
suffix:semicolon
id|setup_dma_dsp
c_func
(paren
id|dev
comma
id|sm
comma
l_int|0
)paren
suffix:semicolon
)brace
r_else
id|dma_transmit
c_func
(paren
id|sm
)paren
suffix:semicolon
id|sm_output_status
c_func
(paren
id|sm
)paren
suffix:semicolon
id|hdlcdrv_transmitter
c_func
(paren
id|dev
comma
op_amp
id|sm-&gt;hdrv
)paren
suffix:semicolon
id|hdlcdrv_receiver
c_func
(paren
id|dev
comma
op_amp
id|sm-&gt;hdrv
)paren
suffix:semicolon
)brace
multiline_comment|/* --------------------------------------------------------------------- */
DECL|function|sbc_open
r_static
r_int
id|sbc_open
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_struct
id|sm_state
op_star
id|sm
)paren
(brace
r_int
id|err
suffix:semicolon
r_int
r_int
id|dmasz
comma
id|u
suffix:semicolon
r_if
c_cond
(paren
r_sizeof
(paren
id|sm-&gt;m
)paren
OL
r_sizeof
(paren
r_struct
id|sc_state_sbc
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;sm sbc: sbc state too big: %d &gt; %d&bslash;n&quot;
comma
r_sizeof
(paren
r_struct
id|sc_state_sbc
)paren
comma
r_sizeof
(paren
id|sm-&gt;m
)paren
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|dev
op_logical_or
op_logical_neg
id|sm
)paren
r_return
op_minus
id|ENXIO
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;base_addr
op_le
l_int|0
op_logical_or
id|dev-&gt;base_addr
OG
l_int|0x1000
op_minus
id|SBC_EXTENT
op_logical_or
id|dev-&gt;irq
template_param
l_int|15
op_logical_or
id|dev-&gt;dma
OG
l_int|3
)paren
r_return
op_minus
id|ENXIO
suffix:semicolon
r_if
c_cond
(paren
id|check_region
c_func
(paren
id|dev-&gt;base_addr
comma
id|SBC_EXTENT
)paren
)paren
r_return
op_minus
id|EACCES
suffix:semicolon
multiline_comment|/*&n;&t; * check if a card is available&n;&t; */
r_if
c_cond
(paren
op_logical_neg
id|reset_dsp
c_func
(paren
id|dev
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: sbc: no card at io address 0x%lx&bslash;n&quot;
comma
id|sm_drvname
comma
id|dev-&gt;base_addr
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
id|write_dsp
c_func
(paren
id|dev
comma
id|SBC_GET_REVISION
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|read_dsp
c_func
(paren
id|dev
comma
op_amp
id|SCSTATE-&gt;revhi
)paren
op_logical_or
op_logical_neg
id|read_dsp
c_func
(paren
id|dev
comma
op_amp
id|SCSTATE-&gt;revlo
)paren
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: SoundBlaster DSP revision %d.%d&bslash;n&quot;
comma
id|sm_drvname
comma
id|SCSTATE-&gt;revhi
comma
id|SCSTATE-&gt;revlo
)paren
suffix:semicolon
r_if
c_cond
(paren
id|SCSTATE-&gt;revhi
OL
l_int|2
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: your card is an antiquity, at least DSP &quot;
l_string|&quot;rev 2.00 required&bslash;n&quot;
comma
id|sm_drvname
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
r_if
c_cond
(paren
id|SCSTATE-&gt;revhi
OL
l_int|3
op_logical_and
(paren
id|SCSTATE-&gt;fmt
(braket
l_int|0
)braket
op_ge
l_int|180
op_logical_or
id|SCSTATE-&gt;fmt
(braket
l_int|1
)braket
op_ge
l_int|180
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: sbc io 0x%lx: DSP rev %d.%02d too &quot;
l_string|&quot;old, at least 3.00 required&bslash;n&quot;
comma
id|sm_drvname
comma
id|dev-&gt;base_addr
comma
id|SCSTATE-&gt;revhi
comma
id|SCSTATE-&gt;revlo
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
r_if
c_cond
(paren
id|SCSTATE-&gt;revhi
op_ge
l_int|4
op_logical_and
(paren
id|err
op_assign
id|config_resources
c_func
(paren
id|dev
comma
id|sm
comma
l_int|0
)paren
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: invalid IRQ and/or DMA specified&bslash;n&quot;
comma
id|sm_drvname
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * initialize some variables&n;&t; */
id|dma_init_receive
c_func
(paren
id|sm
)paren
suffix:semicolon
id|dmasz
op_assign
(paren
id|NUM_FRAGMENTS
op_plus
l_int|1
)paren
op_star
id|sm-&gt;dma.ifragsz
suffix:semicolon
id|u
op_assign
id|NUM_FRAGMENTS
op_star
id|sm-&gt;dma.ofragsz
suffix:semicolon
r_if
c_cond
(paren
id|u
OG
id|dmasz
)paren
id|dmasz
op_assign
id|u
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|sm-&gt;dma.ibuf
op_assign
id|sm-&gt;dma.obuf
op_assign
id|kmalloc
c_func
(paren
id|dmasz
comma
id|GFP_KERNEL
op_or
id|GFP_DMA
)paren
)paren
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|dma_init_transmit
c_func
(paren
id|sm
)paren
suffix:semicolon
id|dma_init_receive
c_func
(paren
id|sm
)paren
suffix:semicolon
id|memset
c_func
(paren
op_amp
id|sm-&gt;m
comma
l_int|0
comma
r_sizeof
(paren
id|sm-&gt;m
)paren
)paren
suffix:semicolon
id|memset
c_func
(paren
op_amp
id|sm-&gt;d
comma
l_int|0
comma
r_sizeof
(paren
id|sm-&gt;d
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sm-&gt;mode_tx-&gt;init
)paren
id|sm-&gt;mode_tx
op_member_access_from_pointer
id|init
c_func
(paren
id|sm
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sm-&gt;mode_rx-&gt;init
)paren
id|sm-&gt;mode_rx
op_member_access_from_pointer
id|init
c_func
(paren
id|sm
)paren
suffix:semicolon
r_if
c_cond
(paren
id|request_dma
c_func
(paren
id|dev-&gt;dma
comma
id|sm-&gt;hwdrv-&gt;hw_name
)paren
)paren
(brace
id|kfree
c_func
(paren
id|sm-&gt;dma.obuf
)paren
suffix:semicolon
r_return
op_minus
id|EBUSY
suffix:semicolon
)brace
r_if
c_cond
(paren
id|request_irq
c_func
(paren
id|dev-&gt;irq
comma
id|sbc_interrupt
comma
id|SA_INTERRUPT
comma
id|sm-&gt;hwdrv-&gt;hw_name
comma
id|dev
)paren
)paren
(brace
id|free_dma
c_func
(paren
id|dev-&gt;dma
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|sm-&gt;dma.obuf
)paren
suffix:semicolon
r_return
op_minus
id|EBUSY
suffix:semicolon
)brace
id|request_region
c_func
(paren
id|dev-&gt;base_addr
comma
id|SBC_EXTENT
comma
id|sm-&gt;hwdrv-&gt;hw_name
)paren
suffix:semicolon
id|setup_dma_dsp
c_func
(paren
id|dev
comma
id|sm
comma
l_int|0
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* --------------------------------------------------------------------- */
DECL|function|sbc_close
r_static
r_int
id|sbc_close
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_struct
id|sm_state
op_star
id|sm
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|dev
op_logical_or
op_logical_neg
id|sm
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
multiline_comment|/*&n;&t; * disable interrupts&n;&t; */
id|disable_dma
c_func
(paren
id|dev-&gt;dma
)paren
suffix:semicolon
id|reset_dsp
c_func
(paren
id|dev
)paren
suffix:semicolon
id|free_irq
c_func
(paren
id|dev-&gt;irq
comma
id|dev
)paren
suffix:semicolon
id|free_dma
c_func
(paren
id|dev-&gt;dma
)paren
suffix:semicolon
id|release_region
c_func
(paren
id|dev-&gt;base_addr
comma
id|SBC_EXTENT
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|sm-&gt;dma.obuf
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* --------------------------------------------------------------------- */
DECL|function|sbc_sethw
r_static
r_int
id|sbc_sethw
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_struct
id|sm_state
op_star
id|sm
comma
r_char
op_star
id|mode
)paren
(brace
r_char
op_star
id|cp
op_assign
id|strchr
c_func
(paren
id|mode
comma
l_char|&squot;.&squot;
)paren
suffix:semicolon
r_const
r_struct
id|modem_tx_info
op_star
op_star
id|mtp
op_assign
id|sm_modem_tx_table
suffix:semicolon
r_const
r_struct
id|modem_rx_info
op_star
op_star
id|mrp
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|strcmp
c_func
(paren
id|mode
comma
l_string|&quot;off&quot;
)paren
)paren
(brace
id|sm-&gt;mode_tx
op_assign
l_int|NULL
suffix:semicolon
id|sm-&gt;mode_rx
op_assign
l_int|NULL
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|cp
)paren
op_star
id|cp
op_increment
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
r_else
id|cp
op_assign
id|mode
suffix:semicolon
r_for
c_loop
(paren
suffix:semicolon
op_star
id|mtp
suffix:semicolon
id|mtp
op_increment
)paren
(brace
r_if
c_cond
(paren
(paren
op_star
id|mtp
)paren
op_member_access_from_pointer
id|loc_storage
OG
r_sizeof
(paren
id|sm-&gt;m
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: insufficient storage for modulator %s (%d)&bslash;n&quot;
comma
id|sm_drvname
comma
(paren
op_star
id|mtp
)paren
op_member_access_from_pointer
id|name
comma
(paren
op_star
id|mtp
)paren
op_member_access_from_pointer
id|loc_storage
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
(paren
op_star
id|mtp
)paren
op_member_access_from_pointer
id|name
op_logical_or
id|strcmp
c_func
(paren
(paren
op_star
id|mtp
)paren
op_member_access_from_pointer
id|name
comma
id|mode
)paren
)paren
r_continue
suffix:semicolon
r_if
c_cond
(paren
(paren
op_star
id|mtp
)paren
op_member_access_from_pointer
id|srate
template_param
l_int|44100
)paren
r_continue
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
op_star
id|mtp
)paren
op_member_access_from_pointer
id|modulator_u8
)paren
r_continue
suffix:semicolon
r_for
c_loop
(paren
id|mrp
op_assign
id|sm_modem_rx_table
suffix:semicolon
op_star
id|mrp
suffix:semicolon
id|mrp
op_increment
)paren
(brace
r_if
c_cond
(paren
(paren
op_star
id|mrp
)paren
op_member_access_from_pointer
id|loc_storage
OG
r_sizeof
(paren
id|sm-&gt;d
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: insufficient storage for demodulator %s (%d)&bslash;n&quot;
comma
id|sm_drvname
comma
(paren
op_star
id|mrp
)paren
op_member_access_from_pointer
id|name
comma
(paren
op_star
id|mrp
)paren
op_member_access_from_pointer
id|loc_storage
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
(paren
op_star
id|mrp
)paren
op_member_access_from_pointer
id|demodulator_u8
)paren
r_continue
suffix:semicolon
r_if
c_cond
(paren
(paren
op_star
id|mrp
)paren
op_member_access_from_pointer
id|name
op_logical_and
op_logical_neg
id|strcmp
c_func
(paren
(paren
op_star
id|mrp
)paren
op_member_access_from_pointer
id|name
comma
id|cp
)paren
op_logical_and
(paren
op_star
id|mrp
)paren
op_member_access_from_pointer
id|srate
op_ge
l_int|5000
op_logical_and
(paren
op_star
id|mrp
)paren
op_member_access_from_pointer
id|srate
op_le
l_int|44100
)paren
(brace
id|sm-&gt;mode_tx
op_assign
op_star
id|mtp
suffix:semicolon
id|sm-&gt;mode_rx
op_assign
op_star
id|mrp
suffix:semicolon
id|SCSTATE-&gt;fmt
(braket
l_int|0
)braket
op_assign
l_int|256
op_minus
(paren
(paren
l_int|1000000L
op_plus
id|sm-&gt;mode_rx-&gt;srate
op_div
l_int|2
)paren
op_div
id|sm-&gt;mode_rx-&gt;srate
)paren
suffix:semicolon
id|SCSTATE-&gt;fmt
(braket
l_int|1
)braket
op_assign
l_int|256
op_minus
(paren
(paren
l_int|1000000L
op_plus
id|sm-&gt;mode_tx-&gt;srate
op_div
l_int|2
)paren
op_div
id|sm-&gt;mode_tx-&gt;srate
)paren
suffix:semicolon
id|sm-&gt;dma.ifragsz
op_assign
(paren
id|sm-&gt;mode_rx-&gt;srate
op_plus
l_int|50
)paren
op_div
l_int|100
suffix:semicolon
id|sm-&gt;dma.ofragsz
op_assign
(paren
id|sm-&gt;mode_tx-&gt;srate
op_plus
l_int|50
)paren
op_div
l_int|100
suffix:semicolon
r_if
c_cond
(paren
id|sm-&gt;dma.ifragsz
OL
id|sm-&gt;mode_rx-&gt;overlap
)paren
id|sm-&gt;dma.ifragsz
op_assign
id|sm-&gt;mode_rx-&gt;overlap
suffix:semicolon
id|sm-&gt;dma.i16bit
op_assign
id|sm-&gt;dma.o16bit
op_assign
l_int|0
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
)brace
)brace
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
multiline_comment|/* --------------------------------------------------------------------- */
DECL|function|sbc_ioctl
r_static
r_int
id|sbc_ioctl
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_struct
id|sm_state
op_star
id|sm
comma
r_struct
id|ifreq
op_star
id|ifr
comma
r_struct
id|hdlcdrv_ioctl
op_star
id|hi
comma
r_int
id|cmd
)paren
(brace
r_struct
id|sm_ioctl
id|bi
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_int
id|i
suffix:semicolon
r_if
c_cond
(paren
id|cmd
op_ne
id|SIOCDEVPRIVATE
)paren
r_return
op_minus
id|ENOIOCTLCMD
suffix:semicolon
r_if
c_cond
(paren
id|hi-&gt;cmd
op_eq
id|HDLCDRVCTL_MODEMPARMASK
)paren
r_return
id|HDLCDRV_PARMASK_IOBASE
op_or
id|HDLCDRV_PARMASK_IRQ
op_or
id|HDLCDRV_PARMASK_DMA
op_or
id|HDLCDRV_PARMASK_SERIOBASE
op_or
id|HDLCDRV_PARMASK_PARIOBASE
op_or
id|HDLCDRV_PARMASK_MIDIIOBASE
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|bi
comma
id|ifr-&gt;ifr_data
comma
r_sizeof
(paren
id|bi
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_switch
c_cond
(paren
id|bi.cmd
)paren
(brace
r_default
suffix:colon
r_return
op_minus
id|ENOIOCTLCMD
suffix:semicolon
r_case
id|SMCTL_GETMIXER
suffix:colon
id|i
op_assign
l_int|0
suffix:semicolon
id|bi.data.mix.sample_rate
op_assign
id|sm-&gt;mode_rx-&gt;srate
suffix:semicolon
id|bi.data.mix.bit_rate
op_assign
id|sm-&gt;hdrv.par.bitrate
suffix:semicolon
id|bi.data.mix.mixer_type
op_assign
id|SM_MIXER_INVALID
suffix:semicolon
r_switch
c_cond
(paren
id|SCSTATE-&gt;revhi
)paren
(brace
r_case
l_int|2
suffix:colon
id|bi.data.mix.mixer_type
op_assign
id|SM_MIXER_CT1335
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|3
suffix:colon
id|bi.data.mix.mixer_type
op_assign
id|SM_MIXER_CT1345
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|4
suffix:colon
id|bi.data.mix.mixer_type
op_assign
id|SM_MIXER_CT1745
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|bi.data.mix.mixer_type
op_ne
id|SM_MIXER_INVALID
op_logical_and
id|bi.data.mix.reg
OL
l_int|0x80
)paren
(brace
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|outb
c_func
(paren
id|bi.data.mix.reg
comma
id|DSP_MIXER_ADDR
c_func
(paren
id|dev-&gt;base_addr
)paren
)paren
suffix:semicolon
id|bi.data.mix.data
op_assign
id|inb
c_func
(paren
id|DSP_MIXER_DATA
c_func
(paren
id|dev-&gt;base_addr
)paren
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|i
op_assign
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
id|ifr-&gt;ifr_data
comma
op_amp
id|bi
comma
r_sizeof
(paren
id|bi
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_return
id|i
suffix:semicolon
r_case
id|SMCTL_SETMIXER
suffix:colon
r_if
c_cond
(paren
op_logical_neg
id|capable
c_func
(paren
id|CAP_SYS_RAWIO
)paren
)paren
r_return
op_minus
id|EACCES
suffix:semicolon
r_switch
c_cond
(paren
id|SCSTATE-&gt;revhi
)paren
(brace
r_case
l_int|2
suffix:colon
r_if
c_cond
(paren
id|bi.data.mix.mixer_type
op_ne
id|SM_MIXER_CT1335
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|3
suffix:colon
r_if
c_cond
(paren
id|bi.data.mix.mixer_type
op_ne
id|SM_MIXER_CT1345
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|4
suffix:colon
r_if
c_cond
(paren
id|bi.data.mix.mixer_type
op_ne
id|SM_MIXER_CT1745
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
r_if
c_cond
(paren
id|bi.data.mix.reg
op_ge
l_int|0x80
)paren
r_return
op_minus
id|EACCES
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|outb
c_func
(paren
id|bi.data.mix.reg
comma
id|DSP_MIXER_ADDR
c_func
(paren
id|dev-&gt;base_addr
)paren
)paren
suffix:semicolon
id|outb
c_func
(paren
id|bi.data.mix.data
comma
id|DSP_MIXER_DATA
c_func
(paren
id|dev-&gt;base_addr
)paren
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
id|ifr-&gt;ifr_data
comma
op_amp
id|bi
comma
r_sizeof
(paren
id|bi
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* --------------------------------------------------------------------- */
DECL|variable|sm_hw_sbc
r_const
r_struct
id|hardware_info
id|sm_hw_sbc
op_assign
(brace
l_string|&quot;sbc&quot;
comma
r_sizeof
(paren
r_struct
id|sc_state_sbc
)paren
comma
id|sbc_open
comma
id|sbc_close
comma
id|sbc_ioctl
comma
id|sbc_sethw
)brace
suffix:semicolon
multiline_comment|/* --------------------------------------------------------------------- */
DECL|function|setup_dma_fdx_dsp
r_static
r_void
id|setup_dma_fdx_dsp
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_struct
id|sm_state
op_star
id|sm
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
r_int
r_int
id|isamps
comma
id|osamps
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|reset_dsp
c_func
(paren
id|dev
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: sbc: cannot reset sb dsp&bslash;n&quot;
comma
id|sm_drvname
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|sbc_int_ack_8bit
c_func
(paren
id|dev
)paren
suffix:semicolon
id|sbc_int_ack_16bit
c_func
(paren
id|dev
)paren
suffix:semicolon
multiline_comment|/* should eventually change to set rates individually by SBC_SAMPLE_RATE_{IN/OUT} */
id|write_dsp
c_func
(paren
id|dev
comma
id|SBC_SAMPLE_RATE_IN
)paren
suffix:semicolon
id|write_dsp
c_func
(paren
id|dev
comma
id|SCSTATE-&gt;sr
(braket
l_int|0
)braket
op_rshift
l_int|8
)paren
suffix:semicolon
id|write_dsp
c_func
(paren
id|dev
comma
id|SCSTATE-&gt;sr
(braket
l_int|0
)braket
op_amp
l_int|0xff
)paren
suffix:semicolon
id|write_dsp
c_func
(paren
id|dev
comma
id|SBC_SAMPLE_RATE_OUT
)paren
suffix:semicolon
id|write_dsp
c_func
(paren
id|dev
comma
id|SCSTATE-&gt;sr
(braket
l_int|1
)braket
op_rshift
l_int|8
)paren
suffix:semicolon
id|write_dsp
c_func
(paren
id|dev
comma
id|SCSTATE-&gt;sr
(braket
l_int|1
)braket
op_amp
l_int|0xff
)paren
suffix:semicolon
id|write_dsp
c_func
(paren
id|dev
comma
id|SBC_SPEAKER_ON
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sm-&gt;dma.o16bit
)paren
(brace
multiline_comment|/*&n;&t;&t; * DMA channel 1 (8bit) does input (capture),&n;&t;&t; * DMA channel 2 (16bit) does output (playback)&n;&t;&t; */
id|isamps
op_assign
id|dma_setup
c_func
(paren
id|sm
comma
l_int|0
comma
id|dev-&gt;dma
)paren
op_minus
l_int|1
suffix:semicolon
id|osamps
op_assign
id|dma_setup
c_func
(paren
id|sm
comma
l_int|1
comma
id|sm-&gt;hdrv.ptt_out.dma2
)paren
op_minus
l_int|1
suffix:semicolon
id|sbc_int_ack_8bit
c_func
(paren
id|dev
)paren
suffix:semicolon
id|sbc_int_ack_16bit
c_func
(paren
id|dev
)paren
suffix:semicolon
id|write_dsp
c_func
(paren
id|dev
comma
id|SBC4_IN8_AI
)paren
suffix:semicolon
id|write_dsp
c_func
(paren
id|dev
comma
id|SBC4_MODE_UNS_MONO
)paren
suffix:semicolon
id|write_dsp
c_func
(paren
id|dev
comma
id|isamps
op_amp
l_int|0xff
)paren
suffix:semicolon
id|write_dsp
c_func
(paren
id|dev
comma
id|isamps
op_rshift
l_int|8
)paren
suffix:semicolon
id|write_dsp
c_func
(paren
id|dev
comma
id|SBC4_OUT16_AI
)paren
suffix:semicolon
id|write_dsp
c_func
(paren
id|dev
comma
id|SBC4_MODE_SIGN_MONO
)paren
suffix:semicolon
id|write_dsp
c_func
(paren
id|dev
comma
id|osamps
op_amp
l_int|0xff
)paren
suffix:semicolon
id|write_dsp
c_func
(paren
id|dev
comma
id|osamps
op_rshift
l_int|8
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/*&n;&t;&t; * DMA channel 1 (8bit) does output (playback),&n;&t;&t; * DMA channel 2 (16bit) does input (capture)&n;&t;&t; */
id|isamps
op_assign
id|dma_setup
c_func
(paren
id|sm
comma
l_int|0
comma
id|sm-&gt;hdrv.ptt_out.dma2
)paren
op_minus
l_int|1
suffix:semicolon
id|osamps
op_assign
id|dma_setup
c_func
(paren
id|sm
comma
l_int|1
comma
id|dev-&gt;dma
)paren
op_minus
l_int|1
suffix:semicolon
id|sbc_int_ack_8bit
c_func
(paren
id|dev
)paren
suffix:semicolon
id|sbc_int_ack_16bit
c_func
(paren
id|dev
)paren
suffix:semicolon
id|write_dsp
c_func
(paren
id|dev
comma
id|SBC4_OUT8_AI
)paren
suffix:semicolon
id|write_dsp
c_func
(paren
id|dev
comma
id|SBC4_MODE_UNS_MONO
)paren
suffix:semicolon
id|write_dsp
c_func
(paren
id|dev
comma
id|osamps
op_amp
l_int|0xff
)paren
suffix:semicolon
id|write_dsp
c_func
(paren
id|dev
comma
id|osamps
op_rshift
l_int|8
)paren
suffix:semicolon
id|write_dsp
c_func
(paren
id|dev
comma
id|SBC4_IN16_AI
)paren
suffix:semicolon
id|write_dsp
c_func
(paren
id|dev
comma
id|SBC4_MODE_SIGN_MONO
)paren
suffix:semicolon
id|write_dsp
c_func
(paren
id|dev
comma
id|isamps
op_amp
l_int|0xff
)paren
suffix:semicolon
id|write_dsp
c_func
(paren
id|dev
comma
id|isamps
op_rshift
l_int|8
)paren
suffix:semicolon
)brace
id|dma_init_receive
c_func
(paren
id|sm
)paren
suffix:semicolon
id|dma_init_transmit
c_func
(paren
id|sm
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
multiline_comment|/* --------------------------------------------------------------------- */
DECL|function|sbcfdx_interrupt
r_static
r_void
id|sbcfdx_interrupt
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_struct
id|net_device
op_star
id|dev
op_assign
(paren
r_struct
id|net_device
op_star
)paren
id|dev_id
suffix:semicolon
r_struct
id|sm_state
op_star
id|sm
op_assign
(paren
r_struct
id|sm_state
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_int
r_char
id|intsrc
comma
id|pbint
op_assign
l_int|0
comma
id|captint
op_assign
l_int|0
suffix:semicolon
r_int
r_int
id|ocfrag
comma
id|icfrag
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dev
op_logical_or
op_logical_neg
id|sm
op_logical_or
id|sm-&gt;hdrv.magic
op_ne
id|HDLCDRV_MAGIC
)paren
r_return
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|outb
c_func
(paren
l_int|0x82
comma
id|DSP_MIXER_ADDR
c_func
(paren
id|dev-&gt;base_addr
)paren
)paren
suffix:semicolon
id|intsrc
op_assign
id|inb
c_func
(paren
id|DSP_MIXER_DATA
c_func
(paren
id|dev-&gt;base_addr
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|intsrc
op_amp
l_int|0x01
)paren
(brace
id|sbc_int_ack_8bit
c_func
(paren
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sm-&gt;dma.o16bit
)paren
(brace
id|captint
op_assign
l_int|1
suffix:semicolon
id|disable_dma
c_func
(paren
id|dev-&gt;dma
)paren
suffix:semicolon
id|clear_dma_ff
c_func
(paren
id|dev-&gt;dma
)paren
suffix:semicolon
id|dma_ptr
c_func
(paren
id|sm
comma
l_int|0
comma
id|dev-&gt;dma
comma
op_amp
id|icfrag
)paren
suffix:semicolon
id|enable_dma
c_func
(paren
id|dev-&gt;dma
)paren
suffix:semicolon
)brace
r_else
(brace
id|pbint
op_assign
l_int|1
suffix:semicolon
id|disable_dma
c_func
(paren
id|dev-&gt;dma
)paren
suffix:semicolon
id|clear_dma_ff
c_func
(paren
id|dev-&gt;dma
)paren
suffix:semicolon
id|dma_ptr
c_func
(paren
id|sm
comma
l_int|1
comma
id|dev-&gt;dma
comma
op_amp
id|ocfrag
)paren
suffix:semicolon
id|enable_dma
c_func
(paren
id|dev-&gt;dma
)paren
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|intsrc
op_amp
l_int|0x02
)paren
(brace
id|sbc_int_ack_16bit
c_func
(paren
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sm-&gt;dma.o16bit
)paren
(brace
id|pbint
op_assign
l_int|1
suffix:semicolon
id|disable_dma
c_func
(paren
id|sm-&gt;hdrv.ptt_out.dma2
)paren
suffix:semicolon
id|clear_dma_ff
c_func
(paren
id|sm-&gt;hdrv.ptt_out.dma2
)paren
suffix:semicolon
id|dma_ptr
c_func
(paren
id|sm
comma
l_int|1
comma
id|sm-&gt;hdrv.ptt_out.dma2
comma
op_amp
id|ocfrag
)paren
suffix:semicolon
id|enable_dma
c_func
(paren
id|sm-&gt;hdrv.ptt_out.dma2
)paren
suffix:semicolon
)brace
r_else
(brace
id|captint
op_assign
l_int|1
suffix:semicolon
id|disable_dma
c_func
(paren
id|sm-&gt;hdrv.ptt_out.dma2
)paren
suffix:semicolon
id|clear_dma_ff
c_func
(paren
id|sm-&gt;hdrv.ptt_out.dma2
)paren
suffix:semicolon
id|dma_ptr
c_func
(paren
id|sm
comma
l_int|0
comma
id|sm-&gt;hdrv.ptt_out.dma2
comma
op_amp
id|icfrag
)paren
suffix:semicolon
id|enable_dma
c_func
(paren
id|sm-&gt;hdrv.ptt_out.dma2
)paren
suffix:semicolon
)brace
)brace
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|sm_int_freq
c_func
(paren
id|sm
)paren
suffix:semicolon
id|sti
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pbint
)paren
(brace
r_if
c_cond
(paren
id|dma_end_transmit
c_func
(paren
id|sm
comma
id|ocfrag
)paren
)paren
id|dma_clear_transmit
c_func
(paren
id|sm
)paren
suffix:semicolon
id|dma_transmit
c_func
(paren
id|sm
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|captint
)paren
(brace
id|dma_receive
c_func
(paren
id|sm
comma
id|icfrag
)paren
suffix:semicolon
id|hdlcdrv_arbitrate
c_func
(paren
id|dev
comma
op_amp
id|sm-&gt;hdrv
)paren
suffix:semicolon
)brace
id|sm_output_status
c_func
(paren
id|sm
)paren
suffix:semicolon
id|hdlcdrv_transmitter
c_func
(paren
id|dev
comma
op_amp
id|sm-&gt;hdrv
)paren
suffix:semicolon
id|hdlcdrv_receiver
c_func
(paren
id|dev
comma
op_amp
id|sm-&gt;hdrv
)paren
suffix:semicolon
)brace
multiline_comment|/* --------------------------------------------------------------------- */
DECL|function|sbcfdx_open
r_static
r_int
id|sbcfdx_open
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_struct
id|sm_state
op_star
id|sm
)paren
(brace
r_int
id|err
suffix:semicolon
r_if
c_cond
(paren
r_sizeof
(paren
id|sm-&gt;m
)paren
OL
r_sizeof
(paren
r_struct
id|sc_state_sbc
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;sm sbc: sbc state too big: %d &gt; %d&bslash;n&quot;
comma
r_sizeof
(paren
r_struct
id|sc_state_sbc
)paren
comma
r_sizeof
(paren
id|sm-&gt;m
)paren
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|dev
op_logical_or
op_logical_neg
id|sm
)paren
r_return
op_minus
id|ENXIO
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;base_addr
op_le
l_int|0
op_logical_or
id|dev-&gt;base_addr
OG
l_int|0x1000
op_minus
id|SBC_EXTENT
op_logical_or
id|dev-&gt;irq
template_param
l_int|15
op_logical_or
id|dev-&gt;dma
OG
l_int|3
)paren
r_return
op_minus
id|ENXIO
suffix:semicolon
r_if
c_cond
(paren
id|check_region
c_func
(paren
id|dev-&gt;base_addr
comma
id|SBC_EXTENT
)paren
)paren
r_return
op_minus
id|EACCES
suffix:semicolon
multiline_comment|/*&n;&t; * check if a card is available&n;&t; */
r_if
c_cond
(paren
op_logical_neg
id|reset_dsp
c_func
(paren
id|dev
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: sbc: no card at io address 0x%lx&bslash;n&quot;
comma
id|sm_drvname
comma
id|dev-&gt;base_addr
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
id|write_dsp
c_func
(paren
id|dev
comma
id|SBC_GET_REVISION
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|read_dsp
c_func
(paren
id|dev
comma
op_amp
id|SCSTATE-&gt;revhi
)paren
op_logical_or
op_logical_neg
id|read_dsp
c_func
(paren
id|dev
comma
op_amp
id|SCSTATE-&gt;revlo
)paren
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: SoundBlaster DSP revision %d.%d&bslash;n&quot;
comma
id|sm_drvname
comma
id|SCSTATE-&gt;revhi
comma
id|SCSTATE-&gt;revlo
)paren
suffix:semicolon
r_if
c_cond
(paren
id|SCSTATE-&gt;revhi
OL
l_int|4
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: at least DSP rev 4.00 required&bslash;n&quot;
comma
id|sm_drvname
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|err
op_assign
id|config_resources
c_func
(paren
id|dev
comma
id|sm
comma
l_int|1
)paren
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: invalid IRQ and/or DMA specified&bslash;n&quot;
comma
id|sm_drvname
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * initialize some variables&n;&t; */
r_if
c_cond
(paren
op_logical_neg
(paren
id|sm-&gt;dma.ibuf
op_assign
id|kmalloc
c_func
(paren
id|sm-&gt;dma.ifragsz
op_star
(paren
id|NUM_FRAGMENTS
op_plus
l_int|1
)paren
comma
id|GFP_KERNEL
op_or
id|GFP_DMA
)paren
)paren
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|sm-&gt;dma.obuf
op_assign
id|kmalloc
c_func
(paren
id|sm-&gt;dma.ofragsz
op_star
id|NUM_FRAGMENTS
comma
id|GFP_KERNEL
op_or
id|GFP_DMA
)paren
)paren
)paren
(brace
id|kfree
c_func
(paren
id|sm-&gt;dma.ibuf
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|dma_init_transmit
c_func
(paren
id|sm
)paren
suffix:semicolon
id|dma_init_receive
c_func
(paren
id|sm
)paren
suffix:semicolon
id|memset
c_func
(paren
op_amp
id|sm-&gt;m
comma
l_int|0
comma
r_sizeof
(paren
id|sm-&gt;m
)paren
)paren
suffix:semicolon
id|memset
c_func
(paren
op_amp
id|sm-&gt;d
comma
l_int|0
comma
r_sizeof
(paren
id|sm-&gt;d
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sm-&gt;mode_tx-&gt;init
)paren
id|sm-&gt;mode_tx
op_member_access_from_pointer
id|init
c_func
(paren
id|sm
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sm-&gt;mode_rx-&gt;init
)paren
id|sm-&gt;mode_rx
op_member_access_from_pointer
id|init
c_func
(paren
id|sm
)paren
suffix:semicolon
r_if
c_cond
(paren
id|request_dma
c_func
(paren
id|dev-&gt;dma
comma
id|sm-&gt;hwdrv-&gt;hw_name
)paren
)paren
(brace
id|kfree
c_func
(paren
id|sm-&gt;dma.ibuf
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|sm-&gt;dma.obuf
)paren
suffix:semicolon
r_return
op_minus
id|EBUSY
suffix:semicolon
)brace
r_if
c_cond
(paren
id|request_dma
c_func
(paren
id|sm-&gt;hdrv.ptt_out.dma2
comma
id|sm-&gt;hwdrv-&gt;hw_name
)paren
)paren
(brace
id|kfree
c_func
(paren
id|sm-&gt;dma.ibuf
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|sm-&gt;dma.obuf
)paren
suffix:semicolon
id|free_dma
c_func
(paren
id|dev-&gt;dma
)paren
suffix:semicolon
r_return
op_minus
id|EBUSY
suffix:semicolon
)brace
r_if
c_cond
(paren
id|request_irq
c_func
(paren
id|dev-&gt;irq
comma
id|sbcfdx_interrupt
comma
id|SA_INTERRUPT
comma
id|sm-&gt;hwdrv-&gt;hw_name
comma
id|dev
)paren
)paren
(brace
id|kfree
c_func
(paren
id|sm-&gt;dma.ibuf
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|sm-&gt;dma.obuf
)paren
suffix:semicolon
id|free_dma
c_func
(paren
id|dev-&gt;dma
)paren
suffix:semicolon
id|free_dma
c_func
(paren
id|sm-&gt;hdrv.ptt_out.dma2
)paren
suffix:semicolon
r_return
op_minus
id|EBUSY
suffix:semicolon
)brace
id|request_region
c_func
(paren
id|dev-&gt;base_addr
comma
id|SBC_EXTENT
comma
id|sm-&gt;hwdrv-&gt;hw_name
)paren
suffix:semicolon
id|setup_dma_fdx_dsp
c_func
(paren
id|dev
comma
id|sm
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* --------------------------------------------------------------------- */
DECL|function|sbcfdx_close
r_static
r_int
id|sbcfdx_close
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_struct
id|sm_state
op_star
id|sm
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|dev
op_logical_or
op_logical_neg
id|sm
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
multiline_comment|/*&n;&t; * disable interrupts&n;&t; */
id|disable_dma
c_func
(paren
id|dev-&gt;dma
)paren
suffix:semicolon
id|disable_dma
c_func
(paren
id|sm-&gt;hdrv.ptt_out.dma2
)paren
suffix:semicolon
id|reset_dsp
c_func
(paren
id|dev
)paren
suffix:semicolon
id|free_irq
c_func
(paren
id|dev-&gt;irq
comma
id|dev
)paren
suffix:semicolon
id|free_dma
c_func
(paren
id|dev-&gt;dma
)paren
suffix:semicolon
id|free_dma
c_func
(paren
id|sm-&gt;hdrv.ptt_out.dma2
)paren
suffix:semicolon
id|release_region
c_func
(paren
id|dev-&gt;base_addr
comma
id|SBC_EXTENT
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|sm-&gt;dma.ibuf
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|sm-&gt;dma.obuf
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* --------------------------------------------------------------------- */
DECL|function|sbcfdx_sethw
r_static
r_int
id|sbcfdx_sethw
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_struct
id|sm_state
op_star
id|sm
comma
r_char
op_star
id|mode
)paren
(brace
r_char
op_star
id|cp
op_assign
id|strchr
c_func
(paren
id|mode
comma
l_char|&squot;.&squot;
)paren
suffix:semicolon
r_const
r_struct
id|modem_tx_info
op_star
op_star
id|mtp
op_assign
id|sm_modem_tx_table
suffix:semicolon
r_const
r_struct
id|modem_rx_info
op_star
op_star
id|mrp
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|strcmp
c_func
(paren
id|mode
comma
l_string|&quot;off&quot;
)paren
)paren
(brace
id|sm-&gt;mode_tx
op_assign
l_int|NULL
suffix:semicolon
id|sm-&gt;mode_rx
op_assign
l_int|NULL
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|cp
)paren
op_star
id|cp
op_increment
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
r_else
id|cp
op_assign
id|mode
suffix:semicolon
r_for
c_loop
(paren
suffix:semicolon
op_star
id|mtp
suffix:semicolon
id|mtp
op_increment
)paren
(brace
r_if
c_cond
(paren
(paren
op_star
id|mtp
)paren
op_member_access_from_pointer
id|loc_storage
OG
r_sizeof
(paren
id|sm-&gt;m
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: insufficient storage for modulator %s (%d)&bslash;n&quot;
comma
id|sm_drvname
comma
(paren
op_star
id|mtp
)paren
op_member_access_from_pointer
id|name
comma
(paren
op_star
id|mtp
)paren
op_member_access_from_pointer
id|loc_storage
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
(paren
op_star
id|mtp
)paren
op_member_access_from_pointer
id|name
op_logical_or
id|strcmp
c_func
(paren
(paren
op_star
id|mtp
)paren
op_member_access_from_pointer
id|name
comma
id|mode
)paren
)paren
r_continue
suffix:semicolon
r_if
c_cond
(paren
(paren
op_star
id|mtp
)paren
op_member_access_from_pointer
id|srate
template_param
l_int|44100
)paren
r_continue
suffix:semicolon
r_for
c_loop
(paren
id|mrp
op_assign
id|sm_modem_rx_table
suffix:semicolon
op_star
id|mrp
suffix:semicolon
id|mrp
op_increment
)paren
(brace
r_if
c_cond
(paren
(paren
op_star
id|mrp
)paren
op_member_access_from_pointer
id|loc_storage
OG
r_sizeof
(paren
id|sm-&gt;d
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: insufficient storage for demodulator %s (%d)&bslash;n&quot;
comma
id|sm_drvname
comma
(paren
op_star
id|mrp
)paren
op_member_access_from_pointer
id|name
comma
(paren
op_star
id|mrp
)paren
op_member_access_from_pointer
id|loc_storage
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
op_star
id|mrp
)paren
op_member_access_from_pointer
id|name
op_logical_and
op_logical_neg
id|strcmp
c_func
(paren
(paren
op_star
id|mrp
)paren
op_member_access_from_pointer
id|name
comma
id|cp
)paren
op_logical_and
(paren
op_star
id|mtp
)paren
op_member_access_from_pointer
id|srate
op_ge
l_int|5000
op_logical_and
(paren
op_star
id|mtp
)paren
op_member_access_from_pointer
id|srate
op_le
l_int|44100
op_logical_and
(paren
op_star
id|mrp
)paren
op_member_access_from_pointer
id|srate
op_eq
(paren
op_star
id|mtp
)paren
op_member_access_from_pointer
id|srate
)paren
(brace
id|sm-&gt;mode_tx
op_assign
op_star
id|mtp
suffix:semicolon
id|sm-&gt;mode_rx
op_assign
op_star
id|mrp
suffix:semicolon
id|SCSTATE-&gt;sr
(braket
l_int|0
)braket
op_assign
id|sm-&gt;mode_rx-&gt;srate
suffix:semicolon
id|SCSTATE-&gt;sr
(braket
l_int|1
)braket
op_assign
id|sm-&gt;mode_tx-&gt;srate
suffix:semicolon
id|sm-&gt;dma.ifragsz
op_assign
(paren
id|sm-&gt;mode_rx-&gt;srate
op_plus
l_int|50
)paren
op_div
l_int|100
suffix:semicolon
id|sm-&gt;dma.ofragsz
op_assign
(paren
id|sm-&gt;mode_tx-&gt;srate
op_plus
l_int|50
)paren
op_div
l_int|100
suffix:semicolon
r_if
c_cond
(paren
id|sm-&gt;dma.ifragsz
OL
id|sm-&gt;mode_rx-&gt;overlap
)paren
id|sm-&gt;dma.ifragsz
op_assign
id|sm-&gt;mode_rx-&gt;overlap
suffix:semicolon
r_if
c_cond
(paren
id|sm-&gt;mode_rx-&gt;demodulator_s16
op_logical_and
id|sm-&gt;mode_tx-&gt;modulator_u8
)paren
(brace
id|sm-&gt;dma.i16bit
op_assign
l_int|1
suffix:semicolon
id|sm-&gt;dma.o16bit
op_assign
l_int|0
suffix:semicolon
id|sm-&gt;dma.ifragsz
op_lshift_assign
l_int|1
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|sm-&gt;mode_rx-&gt;demodulator_u8
op_logical_and
id|sm-&gt;mode_tx-&gt;modulator_s16
)paren
(brace
id|sm-&gt;dma.i16bit
op_assign
l_int|0
suffix:semicolon
id|sm-&gt;dma.o16bit
op_assign
l_int|1
suffix:semicolon
id|sm-&gt;dma.ofragsz
op_lshift_assign
l_int|1
suffix:semicolon
)brace
r_else
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: mode %s or %s unusable&bslash;n&quot;
comma
id|sm_drvname
comma
id|sm-&gt;mode_rx-&gt;name
comma
id|sm-&gt;mode_tx-&gt;name
)paren
suffix:semicolon
id|sm-&gt;mode_tx
op_assign
l_int|NULL
suffix:semicolon
id|sm-&gt;mode_rx
op_assign
l_int|NULL
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
)brace
)brace
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
multiline_comment|/* --------------------------------------------------------------------- */
DECL|function|sbcfdx_ioctl
r_static
r_int
id|sbcfdx_ioctl
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_struct
id|sm_state
op_star
id|sm
comma
r_struct
id|ifreq
op_star
id|ifr
comma
r_struct
id|hdlcdrv_ioctl
op_star
id|hi
comma
r_int
id|cmd
)paren
(brace
r_if
c_cond
(paren
id|cmd
op_ne
id|SIOCDEVPRIVATE
)paren
r_return
op_minus
id|ENOIOCTLCMD
suffix:semicolon
r_if
c_cond
(paren
id|hi-&gt;cmd
op_eq
id|HDLCDRVCTL_MODEMPARMASK
)paren
r_return
id|HDLCDRV_PARMASK_IOBASE
op_or
id|HDLCDRV_PARMASK_IRQ
op_or
id|HDLCDRV_PARMASK_DMA
op_or
id|HDLCDRV_PARMASK_DMA2
op_or
id|HDLCDRV_PARMASK_SERIOBASE
op_or
id|HDLCDRV_PARMASK_PARIOBASE
op_or
id|HDLCDRV_PARMASK_MIDIIOBASE
suffix:semicolon
r_return
id|sbc_ioctl
c_func
(paren
id|dev
comma
id|sm
comma
id|ifr
comma
id|hi
comma
id|cmd
)paren
suffix:semicolon
)brace
multiline_comment|/* --------------------------------------------------------------------- */
DECL|variable|sm_hw_sbcfdx
r_const
r_struct
id|hardware_info
id|sm_hw_sbcfdx
op_assign
(brace
l_string|&quot;sbcfdx&quot;
comma
r_sizeof
(paren
r_struct
id|sc_state_sbc
)paren
comma
id|sbcfdx_open
comma
id|sbcfdx_close
comma
id|sbcfdx_ioctl
comma
id|sbcfdx_sethw
)brace
suffix:semicolon
multiline_comment|/* --------------------------------------------------------------------- */
eof
