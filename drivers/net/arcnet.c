multiline_comment|/*&t;$Id: arcnet.c,v 1.34 1997/11/09 11:04:55 mj Exp $&n;&n;&t;Written 1994-1996 by Avery Pennarun,&n;&t;derived from skeleton.c by Donald Becker.&n;&n;&t;**********************&n;&n;&t;The original copyright was as follows:&n;&n;&t;skeleton.c Written 1993 by Donald Becker.&n;&t;Copyright 1993 United States Government as represented by the&n;        Director, National Security Agency.  This software may only be used&n;        and distributed according to the terms of the GNU Public License as&n;        modified by SRC, incorporated herein by reference.&n;&n;&t;**********************&n;&n;&t;v3.02 (98/06/07)&n;&t;  - Use register_netdevice() instead of register_netdev() to create&n;&t;    new devices for RFC1051 and Ethernet encapsulation in arcnet_open.&n;&t;    Likewise for unregistering them later. This avoids the deadlock &n;&t;    encountered because the original routines call rtnl_lock() when&n;&t;    it&squot;s already locked. [dw]&n;&n;&t;v3.01 (98/04/17)&n;&t;  - Interrupt handler now also checks dev-&gt;[se]dev are non-NULL&n;&t;    to avoid crashes in interrupts during card init. [dw]&n;&n;&t;v3.00 (97/11/09)&n;&t;  - Minor cleanup of debugging messages. [mj]&n;&n;&t;v2.93 ALPHA (97/11/06)&n;&t;  - irq2dev mapping removed.&n;&t;  - Interrupt handler now checks whether dev-&gt;priv is non-null in order&n;&t;    to avoid crashes in interrupts which come during card init. [mj]&n;&n;&t;v2.92 ALPHA (97/09/02)&n;&t;  - Code cleanup [Martin Mares &lt;mj@atrey.karlin.mff.cuni.cz&gt;]&n;&t;  - Better probing for the COM90xx chipset, although only as&n;&t;    a temporary solution until we implement adding of all found&n;&t;    devices at once. [mj]&n;&n;&t;v2.91 ALPHA (97/08/19)&n;&t;  - Add counting of octets in/out.&n;&n;&t;v2.90 ALPHA (97/08/08)&n;&t;  - Add support for kernel command line parsing so that chipset&n;&t;    drivers are usable when compiled in.&n;&n;&t;v2.80 ALPHA (97/08/01)&n;&t;  - Split source into multiple files; generic arcnet support and&n;&t;    individual chipset drivers. &lt;Dave@imladris.demon.co.uk&gt;&n;&n;&t;v2.61 ALPHA (97/07/30)  by David Woodhouse (Dave@imladris.demon.co.uk)&n;&t;                            for Nortel (Northern Telecom).&n;          - Added support for IO-mapped modes and for SMC COM20020 chipset.&n;&t;  - Fixed (avoided) race condition in send_packet routines which was&n;            discovered when the buffer copy routines got slow (?).&n;          - Fixed support for device naming at load time.&n;&t;  - Added backplane, clock and timeout options for COM20020.&n;&t;  - Added support for promiscuous mode.&n;&n;&t;v2.60 ALPHA (96/11/23)&n;&t;  - Added patch from Vojtech Pavlik &lt;vojtech@atrey.karlin.mff.cuni.cz&gt;&n;&t;    and Martin Mares &lt;mj@k332.feld.cvut.cz&gt; to make the driver work&n;&t;    with the new Linux 2.1.x memory management.  I modified their&n;&t;    patch quite a bit though; bugs are my fault.  More changes should&n;&t;    be made to get eliminate any remaining phys_to_virt calls.&n;&t;  - Quietly ignore protocol id&squot;s 0, 1, 8, and 243.  Thanks to Jake&n;&t;    Messinger &lt;jake@ams.com&gt; for reporting these codes and their&n;&t;    meanings.&n;&t;  - Smarter shmem probe for cards with 4k mirrors. (does it work?)&n;&t;  - Initial support for RIM I type cards which use no I/O ports at&n;&t;    all.  To use this option, you need to compile with RIM_I_MODE&n;&t;    enabled.  Thanks to Kolja Waschk &lt;kawk@yo.com&gt; for explaining&n;&t;    RIM I programming to me.  Now, does my RIM I code actually&n;&t;    work?&n;&n;&t;v2.56 (96/10/18)&n;&t;  - Turned arc0e/arc0s startup messages back on by default, as most&n;&t;    people will probably not notice the additional devices&n;&t;    otherwise.  This causes undue confusion.&n;&t;  - Fixed a tiny but noticeable bug in the packet debugging routines&n;&t;    (thanks Tomasz)&n;&n;&t;The following has been SUMMARIZED.  The complete ChangeLog is&n;&t;available in the full Linux-ARCnet package at&n;&t;&t;http://www.worldvisions.ca/~apenwarr/arcnet&n;&n;&t;v2.50 (96/02/24)&n;&t;  - Massively improved autoprobe routines; they now work even as a&n;&t;    module.  Thanks to Vojtech Pavlik &lt;Vojtech.Pavlik@st.mff.cuni.cz&gt;&n;&t;    for his ideas and help in this area.&n;&t;  - Changed printk&squot;s around quite a lot.&n;&n;&t;v2.22 (95/12/08)&n;&t;  - Major cleanups, speedups, and better code-sharing.&n;&t;  - Eliminated/changed many useless/meaningless/scary debug messages&n;&t;    (and, in most cases, the bugs that caused them).&n;&t;  - Better IPX support.&n;&t;  - lp-&gt;stats updated properly.&n;&t;  - RECON checking now by default only prints a message if there are&n;&t;    excessive errors (ie. your cable is probably broken).&n;&t;  - New RFC1051-compliant &quot;arc0s&quot; virtual device by Tomasz&n;&t;    Motylewski.&n;&t;  - Excess debug messages can be compiled out to reduce code size.&n;&n;&t;v2.00 (95/09/06)&n;&t;  - ARCnet RECON messages are now detected and logged as &quot;carrier&quot;&n;&t;    errors.&n;&t;  - The TXACK flag is now checked, and errors are logged.&n;&t;  - Debug levels are now completely different.  See the README.&n;&t;  - Massive code cleanups, with several no-longer-necessary and some&n;&t;    completely useless options removed.&n;&t;  - Multiprotocol support.  You can now use the &quot;arc0e&quot; device to&n;&t;    send &quot;Ethernet-Encapsulation&quot; packets, which are compatible with&n;&t;    Windows for Workgroups and LAN Manager, and possibly other&n;&t;    software.  See the README for more information.&n;&n;&t;v1.02 (95/06/21)&n;          - A fix to make &quot;exception&quot; packets sent from Linux receivable&n;&t;    on other systems.  (The protocol_id byte was sometimes being set&n;&t;    incorrectly, and Linux wasn&squot;t checking it on receive so it&n;&t;    didn&squot;t show up)&n;&n;&t;v1.01 (95/03/24)&n;&t;  - Fixed some IPX-related bugs. (Thanks to Tomasz Motylewski&n;            &lt;motyl@tichy.ch.uj.edu.pl&gt; for the patches to make arcnet work&n;            with dosemu!)&n;&n;&t;v1.00 (95/02/15)&n;&t;  - Initial non-alpha release.&n;&n;&n;&t;TO DO: (semi-prioritized)&n;&n;         - Use cleaner &quot;architecture-independent&quot; shared memory access.&n;           This is half-done in ARCnet 2.60, but still uses some&n;           undocumented i386 stuff.  (We shouldn&squot;t call phys_to_virt,&n;           for example.)&n;&t; - Allow use of RFC1051 or Ether devices without RFC1201.&n;&t; - Keep separate stats for each device.&n;         - Support &quot;arpless&quot; mode like NetBSD does, and as recommended&n;           by the (obsoleted) RFC1051.&n;         - Smarter recovery from RECON-during-transmit conditions. (ie.&n;           retransmit immediately)&n;         - Add support for the new 1.3.x IP header cache, and other features.&n;         - Replace setting of debug level with the &quot;metric&quot; flag hack by&n;&t;   something that still exists. SIOCDEVPRIVATE is a good candidate, &n;&t;   but it would require an extra user-level utility.&n;&n;         - What about cards with shared memory that can be &quot;turned off?&quot;&n;           (or that have none at all, like the SMC PC500longboard)&n;           Does this work now, with IO_MAPPED_BUFFERS?&n;&n;         - Autoconfigure PDI5xxPlus cards. (I now have a PDI508Plus to play&n;           with temporarily.)  Update: yes, the Pure Data config program&n;           for DOS works fine, but the PDI508Plus I have doesn&squot;t! :)&n;         - ATA protocol support??&n;         - VINES TCP/IP encapsulation?? (info needed)&n;&n;&t;Sources:&n;&t; - Crynwr arcnet.com/arcether.com packet drivers.&n;&t; - arcnet.c v0.00 dated 1/1/94 and apparently by&n;&t; &t;Donald Becker - it didn&squot;t work :)&n;&t; - skeleton.c v0.05 dated 11/16/93 by Donald Becker&n;&t; &t;(from Linux Kernel 1.1.45)&n;&t; - RFC&squot;s 1201 and 1051 - re: TCP/IP over ARCnet&n;&t; - The official ARCnet COM9026 data sheets (!) thanks to Ken&n;&t;&t;Cornetet &lt;kcornete@nyx10.cs.du.edu&gt;&n;&t; - The official ARCnet COM20020 data sheets.&n;&t; - Information on some more obscure ARCnet controller chips, thanks&n;&t;   to the nice people at SMC.&n;&t; - net/inet/eth.c (from kernel 1.1.50) for header-building info.&n;&t; - Alternate Linux ARCnet source by V.Shergin &lt;vsher@sao.stavropol.su&gt;&n;&t; - Textual information and more alternate source from Joachim Koenig&n;&t; &t;&lt;jojo@repas.de&gt;&n;*/
DECL|variable|version
r_static
r_const
r_char
op_star
id|version
op_assign
l_string|&quot;arcnet.c: v3.02 98/06/07 Avery Pennarun &lt;apenwarr@worldvisions.ca&gt; et al.&bslash;n&quot;
suffix:semicolon
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/version.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/fcntl.h&gt;
macro_line|#include &lt;linux/interrupt.h&gt;
macro_line|#include &lt;linux/ptrace.h&gt;
macro_line|#include &lt;linux/ioport.h&gt;
macro_line|#include &lt;linux/in.h&gt;
macro_line|#include &lt;linux/malloc.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/timer.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;linux/netdevice.h&gt;
macro_line|#include &lt;linux/if_arp.h&gt;
macro_line|#include &lt;linux/etherdevice.h&gt;
macro_line|#include &lt;linux/skbuff.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/if_arcnet.h&gt;
macro_line|#include &lt;linux/arcdevice.h&gt;
macro_line|#include &lt;asm/system.h&gt;
macro_line|#include &lt;asm/bitops.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/dma.h&gt;
macro_line|#include &lt;net/arp.h&gt;
multiline_comment|/* Define this if you want to make it easier to use the &quot;call trace&quot; when&n; * a kernel NULL pointer assignment occurs.  Hopefully unnecessary, most of&n; * the time.  It will make all the function names (and other things) show&n; * up as kernel symbols.  (especially handy when using arcnet as a module)&n; */
DECL|macro|static
macro_line|#undef static
multiline_comment|/**************************************************************************/
multiline_comment|/* These are now provided by the chipset driver. There&squot;s a performance&n; * overhead in using them.&n; */
DECL|macro|AINTMASK
mdefine_line|#define AINTMASK(x) ((*lp-&gt;asetmask)(dev, x))
DECL|macro|ARCSTATUS
mdefine_line|#define ARCSTATUS ((*lp-&gt;astatus)(dev))
DECL|macro|ACOMMAND
mdefine_line|#define ACOMMAND(x) ((*lp-&gt;acommand)(dev, x))
DECL|variable|arcnet_debug
r_int
id|arcnet_debug
op_assign
id|ARCNET_DEBUG
suffix:semicolon
multiline_comment|/* Exported function prototypes */
macro_line|#ifdef MODULE
r_int
id|init_module
c_func
(paren
r_void
)paren
suffix:semicolon
r_void
id|cleanup_module
c_func
(paren
r_void
)paren
suffix:semicolon
macro_line|#else
r_void
id|arcnet_init
c_func
(paren
r_void
)paren
suffix:semicolon
r_static
r_int
id|init_module
c_func
(paren
r_void
)paren
suffix:semicolon
macro_line|#ifdef CONFIG_ARCNET_COM90xx
r_extern
r_char
id|com90xx_explicit
suffix:semicolon
r_extern
r_int
id|arc90xx_probe
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
macro_line|#endif
macro_line|#endif
r_void
id|arcnet_tx_done
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_struct
id|arcnet_local
op_star
id|lp
)paren
suffix:semicolon
r_void
id|arcnet_use_count
(paren
r_int
id|open
)paren
suffix:semicolon
r_void
id|arcnet_setup
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_void
id|arcnet_makename
c_func
(paren
r_char
op_star
id|device
)paren
suffix:semicolon
r_void
id|arcnetA_continue_tx
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_int
id|arcnet_go_tx
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_int
id|enable_irq
)paren
suffix:semicolon
r_void
id|arcnet_interrupt
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
suffix:semicolon
r_void
id|arcnet_rx
c_func
(paren
r_struct
id|arcnet_local
op_star
id|lp
comma
id|u_char
op_star
id|arcsoft
comma
r_int
id|length
comma
r_int
id|saddr
comma
r_int
id|daddr
)paren
suffix:semicolon
DECL|variable|arcnet_debug
id|EXPORT_SYMBOL
c_func
(paren
id|arcnet_debug
)paren
suffix:semicolon
DECL|variable|arcnet_tx_done
id|EXPORT_SYMBOL
c_func
(paren
id|arcnet_tx_done
)paren
suffix:semicolon
DECL|variable|arcnet_use_count
id|EXPORT_SYMBOL
c_func
(paren
id|arcnet_use_count
)paren
suffix:semicolon
DECL|variable|arcnet_setup
id|EXPORT_SYMBOL
c_func
(paren
id|arcnet_setup
)paren
suffix:semicolon
DECL|variable|arcnet_makename
id|EXPORT_SYMBOL
c_func
(paren
id|arcnet_makename
)paren
suffix:semicolon
DECL|variable|arcnetA_continue_tx
id|EXPORT_SYMBOL
c_func
(paren
id|arcnetA_continue_tx
)paren
suffix:semicolon
DECL|variable|arcnet_go_tx
id|EXPORT_SYMBOL
c_func
(paren
id|arcnet_go_tx
)paren
suffix:semicolon
DECL|variable|arcnet_interrupt
id|EXPORT_SYMBOL
c_func
(paren
id|arcnet_interrupt
)paren
suffix:semicolon
DECL|variable|arcnet_rx
id|EXPORT_SYMBOL
c_func
(paren
id|arcnet_rx
)paren
suffix:semicolon
macro_line|#if ARCNET_DEBUG_MAX &amp; D_SKB
r_void
id|arcnet_dump_skb
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_struct
id|sk_buff
op_star
id|skb
comma
r_char
op_star
id|desc
)paren
suffix:semicolon
DECL|variable|arcnet_dump_skb
id|EXPORT_SYMBOL
c_func
(paren
id|arcnet_dump_skb
)paren
suffix:semicolon
macro_line|#else
DECL|macro|arcnet_dump_skb
macro_line|#&t;define arcnet_dump_skb(dev,skb,desc) ;
macro_line|#endif
macro_line|#if (ARCNET_DEBUG_MAX &amp; D_RX) || (ARCNET_DEBUG_MAX &amp; D_TX)
r_void
id|arcnet_dump_packet
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
id|u_char
op_star
id|buffer
comma
r_int
id|ext
comma
r_char
op_star
id|desc
)paren
suffix:semicolon
DECL|variable|arcnet_dump_packet
id|EXPORT_SYMBOL
c_func
(paren
id|arcnet_dump_packet
)paren
suffix:semicolon
macro_line|#else
DECL|macro|arcnet_dump_packet
macro_line|#&t;define arcnet_dump_packet(dev,buffer,ext,desc) ;
macro_line|#endif
multiline_comment|/* Internal function prototypes */
r_static
r_int
id|arcnet_open
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_int
id|arcnet_close
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_int
id|arcnetA_header
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|net_device
op_star
id|dev
comma
r_int
r_int
id|type
comma
r_void
op_star
id|daddr
comma
r_void
op_star
id|saddr
comma
r_int
id|len
)paren
suffix:semicolon
r_static
r_int
id|arcnetA_rebuild_header
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
)paren
suffix:semicolon
r_static
r_int
id|arcnet_send_packet_bad
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_int
id|arcnetA_send_packet
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_void
id|arcnetA_rx
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
id|u_char
op_star
id|buf
comma
r_int
id|length
comma
id|u_char
id|saddr
comma
id|u_char
id|daddr
)paren
suffix:semicolon
r_static
r_struct
id|net_device_stats
op_star
id|arcnet_get_stats
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_int
r_int
id|arcnetA_type_trans
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
macro_line|#ifdef CONFIG_ARCNET_ETH
multiline_comment|/* functions specific to Ethernet-Encap */
r_static
r_int
id|arcnetE_init
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_int
id|arcnetE_open_close
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_int
id|arcnetE_send_packet
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_void
id|arcnetE_rx
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
id|u_char
op_star
id|arcsoft
comma
r_int
id|length
comma
id|u_char
id|saddr
comma
id|u_char
id|daddr
)paren
suffix:semicolon
macro_line|#endif
macro_line|#ifdef CONFIG_ARCNET_1051
multiline_comment|/* functions specific to RFC1051 */
r_static
r_int
id|arcnetS_init
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_int
id|arcnetS_open_close
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_int
id|arcnetS_send_packet
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_void
id|arcnetS_rx
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
id|u_char
op_star
id|buf
comma
r_int
id|length
comma
id|u_char
id|saddr
comma
id|u_char
id|daddr
)paren
suffix:semicolon
r_static
r_int
id|arcnetS_header
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|net_device
op_star
id|dev
comma
r_int
r_int
id|type
comma
r_void
op_star
id|daddr
comma
r_void
op_star
id|saddr
comma
r_int
id|len
)paren
suffix:semicolon
r_static
r_int
id|arcnetS_rebuild_header
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
)paren
suffix:semicolon
r_static
r_int
r_int
id|arcnetS_type_trans
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/****************************************************************************&n; *                                                                          *&n; * Packet dumps for debugging                                               *&n; *                                                                          *&n; ****************************************************************************/
multiline_comment|/* Dump the contents of an sk_buff&n; */
macro_line|#if ARCNET_DEBUG_MAX &amp; D_SKB
DECL|function|arcnet_dump_skb
r_void
id|arcnet_dump_skb
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_struct
id|sk_buff
op_star
id|skb
comma
r_char
op_star
id|desc
)paren
(brace
r_int
id|i
suffix:semicolon
r_int
id|flags
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%6s: skb dump (%s) follows:&quot;
comma
id|dev-&gt;name
comma
id|desc
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|skb-&gt;len
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|i
op_mod
l_int|16
op_eq
l_int|0
)paren
id|printk
c_func
(paren
l_string|&quot;&bslash;n&quot;
id|KERN_DEBUG
l_string|&quot;[%04X] &quot;
comma
id|i
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;%02X &quot;
comma
(paren
(paren
id|u_char
op_star
)paren
id|skb-&gt;data
)paren
(braket
id|i
)braket
)paren
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
macro_line|#endif
multiline_comment|/* Dump the contents of an ARCnet buffer&n; */
macro_line|#if (ARCNET_DEBUG_MAX &amp; D_RX) || (ARCNET_DEBUG_MAX &amp; D_TX)
DECL|function|arcnet_dump_packet
r_void
id|arcnet_dump_packet
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
id|u_char
op_star
id|buffer
comma
r_int
id|ext
comma
r_char
op_star
id|desc
)paren
(brace
r_int
id|i
suffix:semicolon
r_int
id|flags
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%6s: packet dump (%s) follows:&quot;
comma
id|dev-&gt;name
comma
id|desc
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|256
op_plus
(paren
id|ext
op_ne
l_int|0
)paren
op_star
l_int|256
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|i
op_mod
l_int|16
op_eq
l_int|0
)paren
id|printk
c_func
(paren
l_string|&quot;&bslash;n&quot;
id|KERN_DEBUG
l_string|&quot;[%04X] &quot;
comma
id|i
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;%02X &quot;
comma
id|buffer
(braket
id|i
)braket
)paren
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
macro_line|#endif
multiline_comment|/* Setup a struct net_device for ARCnet.  This should really be in net_init.c&n; * but since there are three different ARCnet devices ANYWAY... &lt;gargle&gt;&n; *&n; * Actually, the whole idea of having all this kernel-dependent stuff (ie.&n; * &quot;new-style flags&quot;) setup per-net-device is kind of weird anyway.&n; *&n; * Intelligent defaults?!  Nah.&n; */
DECL|function|arcnet_setup
r_void
id|arcnet_setup
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
id|dev_init_buffers
c_func
(paren
id|dev
)paren
suffix:semicolon
id|dev-&gt;broadcast
(braket
l_int|0
)braket
op_assign
l_int|0x00
suffix:semicolon
multiline_comment|/* for us, broadcasts are address 0 */
id|dev-&gt;addr_len
op_assign
l_int|1
suffix:semicolon
id|dev-&gt;type
op_assign
id|ARPHRD_ARCNET
suffix:semicolon
id|dev-&gt;tx_queue_len
op_assign
l_int|30
suffix:semicolon
multiline_comment|/* New-style flags. */
id|dev-&gt;flags
op_assign
id|IFF_BROADCAST
suffix:semicolon
multiline_comment|/* Put in this stuff here, so we don&squot;t have to export the symbols&n;&t; * to the chipset drivers.&n;&t; */
id|dev-&gt;open
op_assign
id|arcnet_open
suffix:semicolon
id|dev-&gt;stop
op_assign
id|arcnet_close
suffix:semicolon
id|dev-&gt;hard_start_xmit
op_assign
id|arcnetA_send_packet
suffix:semicolon
id|dev-&gt;get_stats
op_assign
id|arcnet_get_stats
suffix:semicolon
id|dev-&gt;hard_header
op_assign
id|arcnetA_header
suffix:semicolon
id|dev-&gt;rebuild_header
op_assign
id|arcnetA_rebuild_header
suffix:semicolon
)brace
multiline_comment|/****************************************************************************&n; *                                                                          *&n; * Open and close the driver                                                *&n; *                                                                          *&n; ****************************************************************************/
multiline_comment|/* Open/initialize the board.  This is called sometime after booting when&n; * the &squot;ifconfig&squot; program is run.&n; *&n; * This routine should set everything up anew at each open, even&n; * registers that &quot;should&quot; only need to be set once at boot, so that&n; * there is non-reboot way to recover if something goes wrong.&n; */
r_static
r_int
DECL|function|arcnet_open
id|arcnet_open
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|arcnet_local
op_star
id|lp
op_assign
(paren
r_struct
id|arcnet_local
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
multiline_comment|/*  if (dev-&gt;metric&gt;=1000)&n;   *  {&n;   *  arcnet_debug=dev-&gt;metric-1000;&n;   *  printk(KERN_INFO &quot;%6s: debug level set to %d&bslash;n&quot;,dev-&gt;name,arcnet_debug);&n;   *  dev-&gt;metric=1;&n;   *}&n;   */
id|BUGMSG
c_func
(paren
id|D_INIT
comma
l_string|&quot;arcnet_open: resetting card.&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* try to put the card in a defined state - if it fails the first&n;   * time, actually reset it.&n;   */
r_if
c_cond
(paren
(paren
op_star
id|lp-&gt;arcnet_reset
)paren
(paren
id|dev
comma
l_int|0
)paren
op_logical_and
(paren
op_star
id|lp-&gt;arcnet_reset
)paren
(paren
id|dev
comma
l_int|1
)paren
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
id|dev-&gt;tbusy
op_assign
l_int|0
suffix:semicolon
id|dev-&gt;interrupt
op_assign
l_int|0
suffix:semicolon
id|lp-&gt;intx
op_assign
l_int|0
suffix:semicolon
id|lp-&gt;in_txhandler
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* The RFC1201 driver is the default - just store */
id|lp-&gt;adev
op_assign
id|dev
suffix:semicolon
multiline_comment|/* we&squot;re started */
id|dev-&gt;start
op_assign
l_int|1
suffix:semicolon
macro_line|#ifdef CONFIG_ARCNET_ETH
multiline_comment|/* Initialize the ethernet-encap protocol driver */
id|lp-&gt;edev
op_assign
(paren
r_struct
id|net_device
op_star
)paren
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|net_device
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|lp-&gt;edev
op_eq
l_int|NULL
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|memcpy
c_func
(paren
id|lp-&gt;edev
comma
id|dev
comma
r_sizeof
(paren
r_struct
id|net_device
)paren
)paren
suffix:semicolon
id|lp-&gt;edev-&gt;type
op_assign
id|ARPHRD_ETHER
suffix:semicolon
id|lp-&gt;edev-&gt;name
op_assign
(paren
r_char
op_star
)paren
id|kmalloc
c_func
(paren
l_int|10
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|lp-&gt;edev-&gt;name
op_eq
l_int|NULL
)paren
(brace
id|kfree
c_func
(paren
id|lp-&gt;edev
)paren
suffix:semicolon
id|lp-&gt;edev
op_assign
l_int|NULL
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|sprintf
c_func
(paren
id|lp-&gt;edev-&gt;name
comma
l_string|&quot;%se&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|lp-&gt;edev-&gt;init
op_assign
id|arcnetE_init
suffix:semicolon
id|register_netdevice
c_func
(paren
id|lp-&gt;edev
)paren
suffix:semicolon
macro_line|#endif
macro_line|#ifdef CONFIG_ARCNET_1051
multiline_comment|/* Initialize the RFC1051-encap protocol driver */
id|lp-&gt;sdev
op_assign
(paren
r_struct
id|net_device
op_star
)paren
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|net_device
)paren
op_plus
l_int|10
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|lp-&gt;sdev
op_assign
l_int|NULL
)paren
(brace
r_if
c_cond
(paren
id|lp-&gt;edev
)paren
(brace
id|kfree
c_func
(paren
id|lp-&gt;edev
)paren
suffix:semicolon
)brace
id|lp-&gt;edev
op_assign
l_int|NULL
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|memcpy
c_func
(paren
id|lp-&gt;sdev
comma
id|dev
comma
r_sizeof
(paren
r_struct
id|net_device
)paren
)paren
suffix:semicolon
id|lp-&gt;sdev-&gt;name
op_assign
(paren
r_char
op_star
)paren
(paren
id|lp
op_plus
l_int|1
)paren
suffix:semicolon
id|sprintf
c_func
(paren
id|lp-&gt;sdev-&gt;name
comma
l_string|&quot;%ss&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|lp-&gt;sdev-&gt;init
op_assign
id|arcnetS_init
suffix:semicolon
id|register_netdevice
c_func
(paren
id|lp-&gt;sdev
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/* Enable TX if we need to */
r_if
c_cond
(paren
id|lp-&gt;en_dis_able_TX
)paren
(paren
op_star
id|lp-&gt;en_dis_able_TX
)paren
(paren
id|dev
comma
l_int|1
)paren
suffix:semicolon
multiline_comment|/* make sure we&squot;re ready to receive IRQ&squot;s.&n;   * arcnet_reset sets this for us, but if we receive one before&n;   * START is set to 1, it could be ignored.  So, we turn IRQ&squot;s&n;   * off, then on again to clean out the IRQ controller.&n;   */
id|AINTMASK
c_func
(paren
l_int|0
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|1
)paren
suffix:semicolon
multiline_comment|/* give it time to set the mask before&n;&t;&t; * we reset it again. (may not even be&n;&t;&t; * necessary)&n;&t;&t; */
id|SETMASK
suffix:semicolon
multiline_comment|/* Let it increase its use count */
(paren
op_star
id|lp-&gt;openclose_device
)paren
(paren
l_int|1
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* The inverse routine to arcnet_open - shuts down the card.&n; */
r_static
r_int
DECL|function|arcnet_close
id|arcnet_close
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|arcnet_local
op_star
id|lp
op_assign
(paren
r_struct
id|arcnet_local
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_if
c_cond
(paren
id|test_and_set_bit
c_func
(paren
l_int|0
comma
(paren
r_int
op_star
)paren
op_amp
id|dev-&gt;tbusy
)paren
)paren
id|BUGMSG
c_func
(paren
id|D_NORMAL
comma
l_string|&quot;arcnet_close: tbusy already set!&bslash;n&quot;
)paren
suffix:semicolon
id|dev-&gt;start
op_assign
l_int|0
suffix:semicolon
macro_line|#ifdef CONFIG_ARCNET_1051
id|lp-&gt;sdev-&gt;tbusy
op_assign
l_int|1
suffix:semicolon
id|lp-&gt;sdev-&gt;start
op_assign
l_int|0
suffix:semicolon
macro_line|#endif
macro_line|#ifdef CONFIG_ARCNET_ETH
id|lp-&gt;edev-&gt;tbusy
op_assign
l_int|1
suffix:semicolon
id|lp-&gt;edev-&gt;start
op_assign
l_int|0
suffix:semicolon
macro_line|#endif
multiline_comment|/* Shut down the card */
multiline_comment|/* Disable TX if we need to */
r_if
c_cond
(paren
id|lp-&gt;en_dis_able_TX
)paren
(paren
op_star
id|lp-&gt;en_dis_able_TX
)paren
(paren
id|dev
comma
l_int|0
)paren
suffix:semicolon
(paren
op_star
id|lp-&gt;arcnet_reset
)paren
(paren
id|dev
comma
l_int|3
)paren
suffix:semicolon
multiline_comment|/* reset IRQ won&squot;t run if START=0 */
macro_line|#if 0
id|lp-&gt;intmask
op_assign
l_int|0
suffix:semicolon
id|SETMASK
suffix:semicolon
multiline_comment|/* no IRQ&squot;s (except RESET, of course) */
id|ACOMMAND
c_func
(paren
id|NOTXcmd
)paren
suffix:semicolon
multiline_comment|/* stop transmit */
id|ACOMMAND
c_func
(paren
id|NORXcmd
)paren
suffix:semicolon
multiline_comment|/* disable receive */
macro_line|#endif
multiline_comment|/* reset more flags */
id|dev-&gt;interrupt
op_assign
l_int|0
suffix:semicolon
macro_line|#ifdef CONFIG_ARCNET_ETH
id|lp-&gt;edev-&gt;interrupt
op_assign
l_int|0
suffix:semicolon
macro_line|#endif
macro_line|#ifdef CONFIG_ARCNET_1051
id|lp-&gt;sdev-&gt;interrupt
op_assign
l_int|0
suffix:semicolon
macro_line|#endif
multiline_comment|/* do NOT free lp-&gt;adev!!  It&squot;s static! */
id|lp-&gt;adev
op_assign
l_int|NULL
suffix:semicolon
macro_line|#ifdef CONFIG_ARCNET_ETH
multiline_comment|/* free the ethernet-encap protocol device */
id|lp-&gt;edev-&gt;priv
op_assign
l_int|NULL
suffix:semicolon
id|unregister_netdevice
c_func
(paren
id|lp-&gt;edev
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|lp-&gt;edev-&gt;name
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|lp-&gt;edev
)paren
suffix:semicolon
id|lp-&gt;edev
op_assign
l_int|NULL
suffix:semicolon
macro_line|#endif
macro_line|#ifdef CONFIG_ARCNET_1051
multiline_comment|/* free the RFC1051-encap protocol device */
id|lp-&gt;sdev-&gt;priv
op_assign
l_int|NULL
suffix:semicolon
id|unregister_netdevice
c_func
(paren
id|lp-&gt;sdev
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|lp-&gt;sdev
)paren
suffix:semicolon
id|lp-&gt;sdev
op_assign
l_int|NULL
suffix:semicolon
macro_line|#endif
multiline_comment|/* Update the statistics here. (not necessary in ARCnet) */
multiline_comment|/* Decrease the use count */
(paren
op_star
id|lp-&gt;openclose_device
)paren
(paren
l_int|0
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/****************************************************************************&n; *                                                                          *&n; * Transmitter routines                                                     *&n; *                                                                          *&n; ****************************************************************************/
multiline_comment|/* Generic error checking routine for arcnet??_send_packet&n; */
r_static
r_int
DECL|function|arcnet_send_packet_bad
id|arcnet_send_packet_bad
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|arcnet_local
op_star
id|lp
op_assign
(paren
r_struct
id|arcnet_local
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|BUGMSG
c_func
(paren
id|D_DURING
comma
l_string|&quot;transmit requested (status=%Xh, inTX=%d)&bslash;n&quot;
comma
id|ARCSTATUS
comma
id|lp-&gt;intx
)paren
suffix:semicolon
r_if
c_cond
(paren
id|lp-&gt;in_txhandler
)paren
(brace
id|BUGMSG
c_func
(paren
id|D_NORMAL
comma
l_string|&quot;send_packet called while in txhandler!&bslash;n&quot;
)paren
suffix:semicolon
id|lp-&gt;stats.tx_dropped
op_increment
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|lp-&gt;intx
OG
l_int|1
)paren
(brace
id|BUGMSG
c_func
(paren
id|D_NORMAL
comma
l_string|&quot;send_packet called while intx!&bslash;n&quot;
)paren
suffix:semicolon
id|lp-&gt;stats.tx_dropped
op_increment
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|test_bit
c_func
(paren
l_int|0
comma
(paren
r_int
op_star
)paren
op_amp
id|dev-&gt;tbusy
)paren
)paren
(brace
multiline_comment|/* If we get here, some higher level has decided we are broken.&n;&t; There should really be a &quot;kick me&quot; function call instead. */
r_int
id|tickssofar
op_assign
id|jiffies
op_minus
id|dev-&gt;trans_start
suffix:semicolon
r_int
id|status
op_assign
id|ARCSTATUS
suffix:semicolon
r_if
c_cond
(paren
id|tickssofar
OL
id|TX_TIMEOUT
)paren
(brace
id|BUGMSG
c_func
(paren
id|D_DURING
comma
l_string|&quot;premature kickme! (status=%Xh ticks=%d o.skb=%ph numsegs=%d segnum=%d&bslash;n&quot;
comma
id|status
comma
id|tickssofar
comma
id|lp-&gt;outgoing.skb
comma
id|lp-&gt;outgoing.numsegs
comma
id|lp-&gt;outgoing.segnum
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
id|lp-&gt;intmask
op_and_assign
op_complement
id|TXFREEflag
suffix:semicolon
id|SETMASK
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
id|TXFREEflag
)paren
multiline_comment|/* transmit _DID_ finish */
(brace
id|BUGMSG
c_func
(paren
id|D_NORMAL
comma
l_string|&quot;tx timeout - missed IRQ? (status=%Xh, ticks=%d, mask=%Xh, dest=%02Xh)&bslash;n&quot;
comma
id|status
comma
id|tickssofar
comma
id|lp-&gt;intmask
comma
id|lp-&gt;lasttrans_dest
)paren
suffix:semicolon
id|lp-&gt;stats.tx_errors
op_increment
suffix:semicolon
)brace
r_else
(brace
id|BUGMSG
c_func
(paren
id|D_EXTRA
comma
l_string|&quot;tx timed out (status=%Xh, tickssofar=%d, intmask=%Xh, dest=%02Xh)&bslash;n&quot;
comma
id|status
comma
id|tickssofar
comma
id|lp-&gt;intmask
comma
id|lp-&gt;lasttrans_dest
)paren
suffix:semicolon
id|lp-&gt;stats.tx_errors
op_increment
suffix:semicolon
id|lp-&gt;stats.tx_aborted_errors
op_increment
suffix:semicolon
id|ACOMMAND
c_func
(paren
id|NOTXcmd
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|lp-&gt;outgoing.skb
)paren
(brace
id|dev_kfree_skb
c_func
(paren
id|lp-&gt;outgoing.skb
)paren
suffix:semicolon
id|lp-&gt;stats.tx_dropped
op_increment
suffix:semicolon
)brace
id|lp-&gt;outgoing.skb
op_assign
l_int|NULL
suffix:semicolon
macro_line|#ifdef CONFIG_ARCNET_ETH
id|lp-&gt;edev-&gt;tbusy
op_assign
l_int|0
suffix:semicolon
macro_line|#endif
macro_line|#ifdef CONFIG_ARCNET_1051
id|lp-&gt;sdev-&gt;tbusy
op_assign
l_int|0
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
op_logical_neg
id|test_and_clear_bit
c_func
(paren
l_int|0
comma
(paren
r_int
op_star
)paren
op_amp
id|dev-&gt;tbusy
)paren
)paren
id|BUGMSG
c_func
(paren
id|D_EXTRA
comma
l_string|&quot;after timing out, tbusy was clear!&bslash;n&quot;
)paren
suffix:semicolon
id|lp-&gt;txready
op_assign
l_int|0
suffix:semicolon
id|lp-&gt;sending
op_assign
l_int|0
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|lp-&gt;txready
)paren
multiline_comment|/* transmit already in progress! */
(brace
id|BUGMSG
c_func
(paren
id|D_NORMAL
comma
l_string|&quot;trying to start new packet while busy! (status=%Xh)&bslash;n&quot;
comma
id|ARCSTATUS
)paren
suffix:semicolon
id|lp-&gt;intmask
op_and_assign
op_complement
id|TXFREEflag
suffix:semicolon
id|SETMASK
suffix:semicolon
id|ACOMMAND
c_func
(paren
id|NOTXcmd
)paren
suffix:semicolon
multiline_comment|/* abort current send */
(paren
op_star
id|lp-&gt;inthandler
)paren
(paren
id|dev
)paren
suffix:semicolon
multiline_comment|/* fake an interrupt */
id|lp-&gt;stats.tx_errors
op_increment
suffix:semicolon
id|lp-&gt;stats.tx_fifo_errors
op_increment
suffix:semicolon
id|lp-&gt;txready
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* we definitely need this line! */
r_return
l_int|1
suffix:semicolon
)brace
multiline_comment|/* Block a timer-based transmit from overlapping.  This could better be&n;     done with atomic_swap(1, dev-&gt;tbusy), but set_bit() works as well. */
r_if
c_cond
(paren
id|test_and_set_bit
c_func
(paren
l_int|0
comma
(paren
r_int
op_star
)paren
op_amp
id|lp-&gt;adev-&gt;tbusy
)paren
)paren
(brace
id|BUGMSG
c_func
(paren
id|D_NORMAL
comma
l_string|&quot;transmitter called with busy bit set! (status=%Xh, inTX=%d, tickssofar=%ld)&bslash;n&quot;
comma
id|ARCSTATUS
comma
id|lp-&gt;intx
comma
id|jiffies
op_minus
id|dev-&gt;trans_start
)paren
suffix:semicolon
id|lp-&gt;stats.tx_errors
op_increment
suffix:semicolon
id|lp-&gt;stats.tx_fifo_errors
op_increment
suffix:semicolon
r_return
op_minus
id|EBUSY
suffix:semicolon
)brace
macro_line|#ifdef CONFIG_ARCNET_1051
id|lp-&gt;sdev-&gt;tbusy
op_assign
l_int|1
suffix:semicolon
macro_line|#endif
macro_line|#ifdef CONFIG_ARCNET_ETH
id|lp-&gt;edev-&gt;tbusy
op_assign
l_int|1
suffix:semicolon
macro_line|#endif
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Called by the kernel in order to transmit a packet.&n; */
r_static
r_int
DECL|function|arcnetA_send_packet
id|arcnetA_send_packet
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|arcnet_local
op_star
id|lp
op_assign
(paren
r_struct
id|arcnet_local
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_int
id|bad
comma
id|oldmask
op_assign
l_int|0
suffix:semicolon
r_struct
id|Outgoing
op_star
id|out
op_assign
op_amp
(paren
id|lp-&gt;outgoing
)paren
suffix:semicolon
id|lp-&gt;intx
op_increment
suffix:semicolon
id|oldmask
op_or_assign
id|lp-&gt;intmask
suffix:semicolon
id|lp-&gt;intmask
op_assign
l_int|0
suffix:semicolon
id|SETMASK
suffix:semicolon
id|bad
op_assign
id|arcnet_send_packet_bad
c_func
(paren
id|skb
comma
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|bad
)paren
(brace
id|lp-&gt;intx
op_decrement
suffix:semicolon
id|lp-&gt;intmask
op_assign
id|oldmask
suffix:semicolon
id|SETMASK
suffix:semicolon
r_return
id|bad
suffix:semicolon
)brace
multiline_comment|/* arcnet_send_packet_pad has already set tbusy - don&squot;t bother here. */
id|lp-&gt;intmask
op_assign
id|oldmask
op_amp
op_complement
id|TXFREEflag
suffix:semicolon
id|SETMASK
suffix:semicolon
id|out-&gt;length
op_assign
l_int|1
OL
id|skb-&gt;len
ques
c_cond
id|skb-&gt;len
suffix:colon
l_int|1
suffix:semicolon
id|out-&gt;hdr
op_assign
(paren
r_struct
id|ClientData
op_star
)paren
id|skb-&gt;data
suffix:semicolon
id|out-&gt;skb
op_assign
id|skb
suffix:semicolon
id|BUGLVL
c_func
(paren
id|D_SKB
)paren
id|arcnet_dump_skb
c_func
(paren
id|dev
comma
id|skb
comma
l_string|&quot;tx&quot;
)paren
suffix:semicolon
id|out-&gt;hdr-&gt;sequence
op_assign
(paren
id|lp-&gt;sequence
op_increment
)paren
suffix:semicolon
multiline_comment|/* fits in one packet? */
r_if
c_cond
(paren
id|out-&gt;length
op_minus
id|EXTRA_CLIENTDATA
op_le
id|XMTU
)paren
(brace
id|BUGMSG
c_func
(paren
id|D_DURING
comma
l_string|&quot;not splitting %d-byte packet. (split_flag=%d)&bslash;n&quot;
comma
id|out-&gt;length
comma
id|out-&gt;hdr-&gt;split_flag
)paren
suffix:semicolon
r_if
c_cond
(paren
id|out-&gt;hdr-&gt;split_flag
)paren
id|BUGMSG
c_func
(paren
id|D_NORMAL
comma
l_string|&quot;short packet has split_flag set?! (split_flag=%d)&bslash;n&quot;
comma
id|out-&gt;hdr-&gt;split_flag
)paren
suffix:semicolon
id|out-&gt;numsegs
op_assign
l_int|1
suffix:semicolon
id|out-&gt;segnum
op_assign
l_int|1
suffix:semicolon
(paren
op_star
id|lp-&gt;prepare_tx
)paren
(paren
id|dev
comma
(paren
(paren
r_char
op_star
)paren
id|out-&gt;hdr
)paren
op_plus
id|EXTRA_CLIENTDATA
comma
r_sizeof
(paren
r_struct
id|ClientData
)paren
op_minus
id|EXTRA_CLIENTDATA
comma
(paren
(paren
r_char
op_star
)paren
id|skb-&gt;data
)paren
op_plus
r_sizeof
(paren
r_struct
id|ClientData
)paren
comma
id|out-&gt;length
op_minus
r_sizeof
(paren
r_struct
id|ClientData
)paren
comma
id|out-&gt;hdr-&gt;daddr
comma
l_int|1
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* done right away */
id|lp-&gt;stats.tx_bytes
op_add_assign
id|out-&gt;skb-&gt;len
suffix:semicolon
id|dev_kfree_skb
c_func
(paren
id|out-&gt;skb
)paren
suffix:semicolon
id|out-&gt;skb
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
id|arcnet_go_tx
c_func
(paren
id|dev
comma
l_int|1
)paren
)paren
(brace
multiline_comment|/* inform upper layers */
id|arcnet_tx_done
c_func
(paren
id|dev
comma
id|lp
)paren
suffix:semicolon
)brace
)brace
r_else
multiline_comment|/* too big for one - split it */
(brace
r_int
id|maxsegsize
op_assign
id|XMTU
op_minus
l_int|4
suffix:semicolon
id|out-&gt;data
op_assign
(paren
id|u_char
op_star
)paren
id|skb-&gt;data
op_plus
r_sizeof
(paren
r_struct
id|ClientData
)paren
suffix:semicolon
id|out-&gt;dataleft
op_assign
id|out-&gt;length
op_minus
r_sizeof
(paren
r_struct
id|ClientData
)paren
suffix:semicolon
id|out-&gt;numsegs
op_assign
(paren
id|out-&gt;dataleft
op_plus
id|maxsegsize
op_minus
l_int|1
)paren
op_div
id|maxsegsize
suffix:semicolon
id|out-&gt;segnum
op_assign
l_int|0
suffix:semicolon
id|BUGMSG
c_func
(paren
id|D_TX
comma
l_string|&quot;packet (%d bytes) split into %d fragments:&bslash;n&quot;
comma
id|out-&gt;length
comma
id|out-&gt;numsegs
)paren
suffix:semicolon
multiline_comment|/* if a packet waiting, launch it */
id|arcnet_go_tx
c_func
(paren
id|dev
comma
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|lp-&gt;txready
)paren
(brace
multiline_comment|/* prepare a packet, launch it and prepare&n;&t;   * another.&n;&t;   */
id|arcnetA_continue_tx
c_func
(paren
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|arcnet_go_tx
c_func
(paren
id|dev
comma
l_int|1
)paren
)paren
(brace
id|arcnetA_continue_tx
c_func
(paren
id|dev
)paren
suffix:semicolon
id|arcnet_go_tx
c_func
(paren
id|dev
comma
l_int|1
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* if segnum==numsegs, the transmission is finished;&n;       * free the skb right away.&n;       */
r_if
c_cond
(paren
id|out-&gt;segnum
op_eq
id|out-&gt;numsegs
)paren
(brace
multiline_comment|/* transmit completed */
id|out-&gt;segnum
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|out-&gt;skb
)paren
(brace
id|lp-&gt;stats.tx_bytes
op_add_assign
id|skb-&gt;len
suffix:semicolon
id|dev_kfree_skb
c_func
(paren
id|out-&gt;skb
)paren
suffix:semicolon
)brace
id|out-&gt;skb
op_assign
l_int|NULL
suffix:semicolon
)brace
)brace
id|dev-&gt;trans_start
op_assign
id|jiffies
suffix:semicolon
id|lp-&gt;intx
op_decrement
suffix:semicolon
multiline_comment|/* make sure we didn&squot;t ignore a TX IRQ while we were in here */
id|lp-&gt;intmask
op_or_assign
id|TXFREEflag
suffix:semicolon
id|SETMASK
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* After an RFC1201 split packet has been set up, this function calls&n; * arcnetAS_prepare_tx to load the next segment into the card.  This function&n; * does NOT automatically call arcnet_go_tx.&n; */
DECL|function|arcnetA_continue_tx
r_void
id|arcnetA_continue_tx
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|arcnet_local
op_star
id|lp
op_assign
(paren
r_struct
id|arcnet_local
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_int
id|maxsegsize
op_assign
id|XMTU
op_minus
l_int|4
suffix:semicolon
r_struct
id|Outgoing
op_star
id|out
op_assign
op_amp
(paren
id|lp-&gt;outgoing
)paren
suffix:semicolon
id|BUGMSG
c_func
(paren
id|D_DURING
comma
l_string|&quot;continue_tx called (status=%Xh, intx=%d, intxh=%d, intmask=%Xh&bslash;n&quot;
comma
id|ARCSTATUS
comma
id|lp-&gt;intx
comma
id|lp-&gt;in_txhandler
comma
id|lp-&gt;intmask
)paren
suffix:semicolon
r_if
c_cond
(paren
id|lp-&gt;txready
)paren
(brace
id|BUGMSG
c_func
(paren
id|D_NORMAL
comma
l_string|&quot;continue_tx: called with packet in buffer!&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|out-&gt;segnum
op_ge
id|out-&gt;numsegs
)paren
(brace
id|BUGMSG
c_func
(paren
id|D_NORMAL
comma
l_string|&quot;continue_tx: building segment %d of %d!&bslash;n&quot;
comma
id|out-&gt;segnum
op_plus
l_int|1
comma
id|out-&gt;numsegs
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|out-&gt;segnum
)paren
multiline_comment|/* first packet */
id|out-&gt;hdr-&gt;split_flag
op_assign
(paren
(paren
id|out-&gt;numsegs
op_minus
l_int|2
)paren
op_lshift
l_int|1
)paren
op_plus
l_int|1
suffix:semicolon
r_else
id|out-&gt;hdr-&gt;split_flag
op_assign
id|out-&gt;segnum
op_lshift
l_int|1
suffix:semicolon
id|out-&gt;seglen
op_assign
id|maxsegsize
suffix:semicolon
r_if
c_cond
(paren
id|out-&gt;seglen
OG
id|out-&gt;dataleft
)paren
id|out-&gt;seglen
op_assign
id|out-&gt;dataleft
suffix:semicolon
id|BUGMSG
c_func
(paren
id|D_TX
comma
l_string|&quot;building packet #%d (%d bytes) of %d (%d total), splitflag=%d&bslash;n&quot;
comma
id|out-&gt;segnum
op_plus
l_int|1
comma
id|out-&gt;seglen
comma
id|out-&gt;numsegs
comma
id|out-&gt;length
comma
id|out-&gt;hdr-&gt;split_flag
)paren
suffix:semicolon
(paren
op_star
id|lp-&gt;prepare_tx
)paren
(paren
id|dev
comma
(paren
(paren
r_char
op_star
)paren
id|out-&gt;hdr
)paren
op_plus
id|EXTRA_CLIENTDATA
comma
r_sizeof
(paren
r_struct
id|ClientData
)paren
op_minus
id|EXTRA_CLIENTDATA
comma
id|out-&gt;data
comma
id|out-&gt;seglen
comma
id|out-&gt;hdr-&gt;daddr
comma
l_int|1
comma
l_int|0
)paren
suffix:semicolon
id|out-&gt;dataleft
op_sub_assign
id|out-&gt;seglen
suffix:semicolon
id|out-&gt;data
op_add_assign
id|out-&gt;seglen
suffix:semicolon
id|out-&gt;segnum
op_increment
suffix:semicolon
)brace
multiline_comment|/* Actually start transmitting a packet that was placed in the card&squot;s&n; * buffer by arcnetAS_prepare_tx.  Returns 1 if a Tx is really started.&n; *&n; * This should probably always be called with the INTMASK register set to 0,&n; * so go_tx is not called recursively.&n; *&n; * The enable_irq flag determines whether to actually write INTMASK value&n; * to the card; TXFREEflag is always OR&squot;ed into the memory variable either&n; * way.&n; */
DECL|function|arcnet_go_tx
r_int
id|arcnet_go_tx
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_int
id|enable_irq
)paren
(brace
r_struct
id|arcnet_local
op_star
id|lp
op_assign
(paren
r_struct
id|arcnet_local
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|BUGMSG
c_func
(paren
id|D_DURING
comma
l_string|&quot;go_tx: status=%Xh, intmask=%Xh, txready=%d, sending=%d&bslash;n&quot;
comma
id|ARCSTATUS
comma
id|lp-&gt;intmask
comma
id|lp-&gt;txready
comma
id|lp-&gt;sending
)paren
suffix:semicolon
r_if
c_cond
(paren
id|lp-&gt;sending
op_logical_or
op_logical_neg
id|lp-&gt;txready
)paren
(brace
r_if
c_cond
(paren
id|enable_irq
op_logical_and
id|lp-&gt;sending
)paren
(brace
id|lp-&gt;intmask
op_or_assign
id|TXFREEflag
suffix:semicolon
id|SETMASK
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* start sending */
id|ACOMMAND
c_func
(paren
id|TXcmd
op_or
(paren
id|lp-&gt;txready
op_lshift
l_int|3
)paren
)paren
suffix:semicolon
id|lp-&gt;stats.tx_packets
op_increment
suffix:semicolon
id|lp-&gt;txready
op_assign
l_int|0
suffix:semicolon
id|lp-&gt;sending
op_increment
suffix:semicolon
id|lp-&gt;lasttrans_dest
op_assign
id|lp-&gt;lastload_dest
suffix:semicolon
id|lp-&gt;lastload_dest
op_assign
l_int|0
suffix:semicolon
id|lp-&gt;intmask
op_or_assign
id|TXFREEflag
suffix:semicolon
r_if
c_cond
(paren
id|enable_irq
)paren
id|SETMASK
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
multiline_comment|/****************************************************************************&n; *                                                                          *&n; * Interrupt handler                                                        *&n; *                                                                          *&n; ****************************************************************************/
multiline_comment|/* The typical workload of the driver:  Handle the network interface&n; * interrupts. Establish which device needs attention, and call the correct&n; * chipset interrupt handler.&n; */
r_void
DECL|function|arcnet_interrupt
id|arcnet_interrupt
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_struct
id|net_device
op_star
id|dev
op_assign
id|dev_id
suffix:semicolon
r_struct
id|arcnet_local
op_star
id|lp
suffix:semicolon
r_if
c_cond
(paren
id|dev
op_eq
l_int|NULL
)paren
(brace
id|BUGMSG
c_func
(paren
id|D_DURING
comma
l_string|&quot;arcnet: irq %d for unknown device.&bslash;n&quot;
comma
id|irq
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|BUGMSG
c_func
(paren
id|D_DURING
comma
l_string|&quot;in arcnet_interrupt&bslash;n&quot;
)paren
suffix:semicolon
id|lp
op_assign
(paren
r_struct
id|arcnet_local
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|lp
)paren
(brace
id|BUGMSG
c_func
(paren
id|D_DURING
comma
l_string|&quot;arcnet: irq ignored.&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/* RESET flag was enabled - if !dev-&gt;start, we must clear it right&n;&t; * away (but nothing else) since inthandler() is never called.&n;&t; */
r_if
c_cond
(paren
op_logical_neg
id|dev-&gt;start
)paren
(brace
r_if
c_cond
(paren
id|ARCSTATUS
op_amp
id|RESETflag
)paren
id|ACOMMAND
c_func
(paren
id|CFLAGScmd
op_or
id|RESETclear
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|test_and_set_bit
c_func
(paren
l_int|0
comma
(paren
r_int
op_star
)paren
op_amp
id|dev-&gt;interrupt
)paren
)paren
(brace
id|BUGMSG
c_func
(paren
id|D_NORMAL
comma
l_string|&quot;DRIVER PROBLEM!  Nested arcnet interrupts!&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
multiline_comment|/* don&squot;t even try. */
)brace
macro_line|#ifdef CONFIG_ARCNET_1051
r_if
c_cond
(paren
id|lp-&gt;sdev
)paren
id|lp-&gt;sdev-&gt;interrupt
op_assign
l_int|1
suffix:semicolon
macro_line|#endif
macro_line|#ifdef CONFIG_ARCNET_ETH
r_if
c_cond
(paren
id|lp-&gt;edev
)paren
id|lp-&gt;edev-&gt;interrupt
op_assign
l_int|1
suffix:semicolon
macro_line|#endif
multiline_comment|/* Call the &quot;real&quot; interrupt handler. */
(paren
op_star
id|lp-&gt;inthandler
)paren
(paren
id|dev
)paren
suffix:semicolon
macro_line|#ifdef CONFIG_ARCNET_ETH
r_if
c_cond
(paren
id|lp-&gt;edev
)paren
id|lp-&gt;edev-&gt;interrupt
op_assign
l_int|0
suffix:semicolon
macro_line|#endif
macro_line|#ifdef CONFIG_ARCNET_1051
r_if
c_cond
(paren
id|lp-&gt;sdev
)paren
id|lp-&gt;sdev-&gt;interrupt
op_assign
l_int|0
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
op_logical_neg
id|test_and_clear_bit
c_func
(paren
l_int|0
comma
(paren
r_int
op_star
)paren
op_amp
id|dev-&gt;interrupt
)paren
)paren
id|BUGMSG
c_func
(paren
id|D_NORMAL
comma
l_string|&quot;Someone cleared our dev-&gt;interrupt flag!&bslash;n&quot;
)paren
suffix:semicolon
)brace
DECL|function|arcnet_tx_done
r_void
id|arcnet_tx_done
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_struct
id|arcnet_local
op_star
id|lp
)paren
(brace
r_if
c_cond
(paren
id|dev-&gt;tbusy
)paren
(brace
macro_line|#ifdef CONFIG_ARCNET_ETH
id|lp-&gt;edev-&gt;tbusy
op_assign
l_int|0
suffix:semicolon
macro_line|#endif
macro_line|#ifdef CONFIG_ARCNET_1051
id|lp-&gt;sdev-&gt;tbusy
op_assign
l_int|0
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
op_logical_neg
id|test_and_clear_bit
c_func
(paren
l_int|0
comma
(paren
r_int
op_star
)paren
op_amp
id|dev-&gt;tbusy
)paren
)paren
id|BUGMSG
c_func
(paren
id|D_NORMAL
comma
l_string|&quot;In arcnet_tx_done: Someone cleared our dev-&gt;tbusy&quot;
l_string|&quot; flag!&bslash;n&quot;
)paren
suffix:semicolon
id|mark_bh
c_func
(paren
id|NET_BH
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/****************************************************************************&n; *                                                                          *&n; * Receiver routines                                                        *&n; *                                                                          *&n; ****************************************************************************/
multiline_comment|/*&n; * This is a generic packet receiver that calls arcnet??_rx depending on the&n; * protocol ID found.&n; */
DECL|function|arcnet_rx
r_void
id|arcnet_rx
c_func
(paren
r_struct
id|arcnet_local
op_star
id|lp
comma
id|u_char
op_star
id|arcsoft
comma
r_int
id|length
comma
r_int
id|saddr
comma
r_int
id|daddr
)paren
(brace
r_struct
id|net_device
op_star
id|dev
op_assign
id|lp-&gt;adev
suffix:semicolon
id|BUGMSG
c_func
(paren
id|D_DURING
comma
l_string|&quot;received packet from %02Xh to %02Xh (%d bytes)&bslash;n&quot;
comma
id|saddr
comma
id|daddr
comma
id|length
)paren
suffix:semicolon
multiline_comment|/* call the right receiver for the protocol */
r_switch
c_cond
(paren
id|arcsoft
(braket
l_int|0
)braket
)paren
(brace
r_case
id|ARC_P_IP
suffix:colon
r_case
id|ARC_P_ARP
suffix:colon
r_case
id|ARC_P_RARP
suffix:colon
r_case
id|ARC_P_IPX
suffix:colon
r_case
id|ARC_P_NOVELL_EC
suffix:colon
id|arcnetA_rx
c_func
(paren
id|lp-&gt;adev
comma
id|arcsoft
comma
id|length
comma
id|saddr
comma
id|daddr
)paren
suffix:semicolon
r_break
suffix:semicolon
macro_line|#ifdef CONFIG_ARCNET_ETH
r_case
id|ARC_P_ETHER
suffix:colon
id|arcnetE_rx
c_func
(paren
id|lp-&gt;edev
comma
id|arcsoft
comma
id|length
comma
id|saddr
comma
id|daddr
)paren
suffix:semicolon
r_break
suffix:semicolon
macro_line|#endif
macro_line|#ifdef CONFIG_ARCNET_1051
r_case
id|ARC_P_IP_RFC1051
suffix:colon
r_case
id|ARC_P_ARP_RFC1051
suffix:colon
id|arcnetS_rx
c_func
(paren
id|lp-&gt;sdev
comma
id|arcsoft
comma
id|length
comma
id|saddr
comma
id|daddr
)paren
suffix:semicolon
r_break
suffix:semicolon
macro_line|#endif
r_case
id|ARC_P_DATAPOINT_BOOT
suffix:colon
r_case
id|ARC_P_DATAPOINT_MOUNT
suffix:colon
r_break
suffix:semicolon
r_case
id|ARC_P_POWERLAN_BEACON
suffix:colon
r_case
id|ARC_P_POWERLAN_BEACON2
suffix:colon
r_break
suffix:semicolon
r_case
id|ARC_P_LANSOFT
suffix:colon
multiline_comment|/* don&squot;t understand.  fall through. */
r_default
suffix:colon
id|BUGMSG
c_func
(paren
id|D_EXTRA
comma
l_string|&quot;received unknown protocol %d (%Xh) from station %d.&bslash;n&quot;
comma
id|arcsoft
(braket
l_int|0
)braket
comma
id|arcsoft
(braket
l_int|0
)braket
comma
id|saddr
)paren
suffix:semicolon
id|lp-&gt;stats.rx_errors
op_increment
suffix:semicolon
id|lp-&gt;stats.rx_crc_errors
op_increment
suffix:semicolon
r_break
suffix:semicolon
)brace
multiline_comment|/* If any worth-while packets have been received, a mark_bh(NET_BH)&n;   * has been done by netif_rx and Linux will handle them after we&n;   * return.&n;   */
)brace
multiline_comment|/* Packet receiver for &quot;standard&quot; RFC1201-style packets&n; */
r_static
r_void
DECL|function|arcnetA_rx
id|arcnetA_rx
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
id|u_char
op_star
id|buf
comma
r_int
id|length
comma
id|u_char
id|saddr
comma
id|u_char
id|daddr
)paren
(brace
r_struct
id|arcnet_local
op_star
id|lp
op_assign
(paren
r_struct
id|arcnet_local
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
r_struct
id|ClientData
op_star
id|arcsoft
comma
op_star
id|soft
suffix:semicolon
id|BUGMSG
c_func
(paren
id|D_DURING
comma
l_string|&quot;it&squot;s an RFC1201 packet (length=%d)&bslash;n&quot;
comma
id|length
)paren
suffix:semicolon
multiline_comment|/* compensate for EXTRA_CLIENTDATA (which isn&squot;t actually in the&n;   * packet)&n;   */
id|arcsoft
op_assign
(paren
r_struct
id|ClientData
op_star
)paren
(paren
id|buf
op_minus
id|EXTRA_CLIENTDATA
)paren
suffix:semicolon
id|length
op_add_assign
id|EXTRA_CLIENTDATA
suffix:semicolon
r_if
c_cond
(paren
id|arcsoft-&gt;split_flag
op_eq
l_int|0xFF
)paren
multiline_comment|/* Exception Packet */
(brace
id|BUGMSG
c_func
(paren
id|D_DURING
comma
l_string|&quot;compensating for exception packet&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* skip over 4-byte junkola */
id|arcsoft
op_assign
(paren
r_struct
id|ClientData
op_star
)paren
(paren
(paren
id|u_char
op_star
)paren
id|arcsoft
op_plus
l_int|4
)paren
suffix:semicolon
id|length
op_sub_assign
l_int|4
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|arcsoft-&gt;split_flag
)paren
multiline_comment|/* not split */
(brace
r_struct
id|Incoming
op_star
id|in
op_assign
op_amp
id|lp-&gt;incoming
(braket
id|saddr
)braket
suffix:semicolon
id|BUGMSG
c_func
(paren
id|D_RX
comma
l_string|&quot;incoming is not split (splitflag=%d)&bslash;n&quot;
comma
id|arcsoft-&gt;split_flag
)paren
suffix:semicolon
r_if
c_cond
(paren
id|in-&gt;skb
)paren
multiline_comment|/* already assembling one! */
(brace
id|BUGMSG
c_func
(paren
id|D_EXTRA
comma
l_string|&quot;aborting assembly (seq=%d) for unsplit packet (splitflag=%d, seq=%d)&bslash;n&quot;
comma
id|in-&gt;sequence
comma
id|arcsoft-&gt;split_flag
comma
id|arcsoft-&gt;sequence
)paren
suffix:semicolon
id|lp-&gt;aborted_seq
op_assign
id|arcsoft-&gt;sequence
suffix:semicolon
id|kfree_skb
c_func
(paren
id|in-&gt;skb
)paren
suffix:semicolon
id|lp-&gt;stats.rx_errors
op_increment
suffix:semicolon
id|lp-&gt;stats.rx_missed_errors
op_increment
suffix:semicolon
id|in-&gt;skb
op_assign
l_int|NULL
suffix:semicolon
)brace
id|in-&gt;sequence
op_assign
id|arcsoft-&gt;sequence
suffix:semicolon
id|skb
op_assign
id|alloc_skb
c_func
(paren
id|length
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
id|skb
op_eq
l_int|NULL
)paren
(brace
id|BUGMSG
c_func
(paren
id|D_NORMAL
comma
l_string|&quot;Memory squeeze, dropping packet.&bslash;n&quot;
)paren
suffix:semicolon
id|lp-&gt;stats.rx_dropped
op_increment
suffix:semicolon
r_return
suffix:semicolon
)brace
id|soft
op_assign
(paren
r_struct
id|ClientData
op_star
)paren
id|skb-&gt;data
suffix:semicolon
id|skb_put
c_func
(paren
id|skb
comma
id|length
)paren
suffix:semicolon
id|skb-&gt;dev
op_assign
id|dev
suffix:semicolon
id|memcpy
c_func
(paren
(paren
id|u_char
op_star
)paren
id|soft
op_plus
id|EXTRA_CLIENTDATA
comma
(paren
id|u_char
op_star
)paren
id|arcsoft
op_plus
id|EXTRA_CLIENTDATA
comma
id|length
op_minus
id|EXTRA_CLIENTDATA
)paren
suffix:semicolon
id|soft-&gt;daddr
op_assign
id|daddr
suffix:semicolon
id|soft-&gt;saddr
op_assign
id|saddr
suffix:semicolon
multiline_comment|/* ARP packets have problems when sent from DOS.&n;       * source address is always 0 on some systems!  So we take&n;       * the hardware source addr (which is impossible to fumble)&n;       * and insert it ourselves.&n;       */
r_if
c_cond
(paren
id|soft-&gt;protocol_id
op_eq
id|ARC_P_ARP
)paren
(brace
r_struct
id|arphdr
op_star
id|arp
op_assign
(paren
r_struct
id|arphdr
op_star
)paren
(paren
(paren
r_char
op_star
)paren
id|soft
op_plus
r_sizeof
(paren
r_struct
id|ClientData
)paren
)paren
suffix:semicolon
multiline_comment|/* make sure addresses are the right length */
r_if
c_cond
(paren
id|arp-&gt;ar_hln
op_eq
l_int|1
op_logical_and
id|arp-&gt;ar_pln
op_eq
l_int|4
)paren
(brace
r_char
op_star
id|cptr
op_assign
(paren
r_char
op_star
)paren
(paren
id|arp
)paren
op_plus
r_sizeof
(paren
r_struct
id|arphdr
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
op_star
id|cptr
)paren
multiline_comment|/* is saddr = 00? */
(brace
id|BUGMSG
c_func
(paren
id|D_EXTRA
comma
l_string|&quot;ARP source address was 00h, set to %02Xh.&bslash;n&quot;
comma
id|saddr
)paren
suffix:semicolon
id|lp-&gt;stats.rx_crc_errors
op_increment
suffix:semicolon
op_star
id|cptr
op_assign
id|saddr
suffix:semicolon
)brace
r_else
(brace
id|BUGMSG
c_func
(paren
id|D_DURING
comma
l_string|&quot;ARP source address (%Xh) is fine.&bslash;n&quot;
comma
op_star
id|cptr
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
id|BUGMSG
c_func
(paren
id|D_NORMAL
comma
l_string|&quot;funny-shaped ARP packet. (%Xh, %Xh)&bslash;n&quot;
comma
id|arp-&gt;ar_hln
comma
id|arp-&gt;ar_pln
)paren
suffix:semicolon
id|lp-&gt;stats.rx_errors
op_increment
suffix:semicolon
id|lp-&gt;stats.rx_crc_errors
op_increment
suffix:semicolon
)brace
)brace
id|BUGLVL
c_func
(paren
id|D_SKB
)paren
id|arcnet_dump_skb
c_func
(paren
id|dev
comma
id|skb
comma
l_string|&quot;rx&quot;
)paren
suffix:semicolon
id|lp-&gt;stats.rx_bytes
op_add_assign
id|skb-&gt;len
suffix:semicolon
id|skb-&gt;protocol
op_assign
id|arcnetA_type_trans
c_func
(paren
id|skb
comma
id|dev
)paren
suffix:semicolon
id|netif_rx
c_func
(paren
id|skb
)paren
suffix:semicolon
)brace
r_else
multiline_comment|/* split packet */
(brace
multiline_comment|/* NOTE:  MSDOS ARP packet correction should only need to&n;       * apply to unsplit packets, since ARP packets are so short.&n;       *&n;       * My interpretation of the RFC1201 (ARCnet) document is that&n;       * if a packet is received out of order, the entire assembly&n;       * process should be aborted.&n;       *&n;       * The RFC also mentions &quot;it is possible for successfully&n;       * received packets to be retransmitted.&quot;  As of 0.40 all&n;       * previously received packets are allowed, not just the&n;       * most recent one.&n;       *&n;       * We allow multiple assembly processes, one for each&n;       * ARCnet card possible on the network.  Seems rather like&n;       * a waste of memory.  Necessary?&n;       */
r_struct
id|Incoming
op_star
id|in
op_assign
op_amp
id|lp-&gt;incoming
(braket
id|saddr
)braket
suffix:semicolon
id|BUGMSG
c_func
(paren
id|D_RX
comma
l_string|&quot;packet is split (splitflag=%d, seq=%d)&bslash;n&quot;
comma
id|arcsoft-&gt;split_flag
comma
id|in-&gt;sequence
)paren
suffix:semicolon
r_if
c_cond
(paren
id|in-&gt;skb
op_logical_and
id|in-&gt;sequence
op_ne
id|arcsoft-&gt;sequence
)paren
(brace
id|BUGMSG
c_func
(paren
id|D_EXTRA
comma
l_string|&quot;wrong seq number (saddr=%d, expected=%d, seq=%d, splitflag=%d)&bslash;n&quot;
comma
id|saddr
comma
id|in-&gt;sequence
comma
id|arcsoft-&gt;sequence
comma
id|arcsoft-&gt;split_flag
)paren
suffix:semicolon
id|kfree_skb
c_func
(paren
id|in-&gt;skb
)paren
suffix:semicolon
id|in-&gt;skb
op_assign
l_int|NULL
suffix:semicolon
id|lp-&gt;stats.rx_errors
op_increment
suffix:semicolon
id|lp-&gt;stats.rx_missed_errors
op_increment
suffix:semicolon
id|in-&gt;lastpacket
op_assign
id|in-&gt;numpackets
op_assign
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|arcsoft-&gt;split_flag
op_amp
l_int|1
)paren
multiline_comment|/* first packet in split */
(brace
id|BUGMSG
c_func
(paren
id|D_RX
comma
l_string|&quot;brand new splitpacket (splitflag=%d)&bslash;n&quot;
comma
id|arcsoft-&gt;split_flag
)paren
suffix:semicolon
r_if
c_cond
(paren
id|in-&gt;skb
)paren
multiline_comment|/* already assembling one! */
(brace
id|BUGMSG
c_func
(paren
id|D_EXTRA
comma
l_string|&quot;aborting previous (seq=%d) assembly (splitflag=%d, seq=%d)&bslash;n&quot;
comma
id|in-&gt;sequence
comma
id|arcsoft-&gt;split_flag
comma
id|arcsoft-&gt;sequence
)paren
suffix:semicolon
id|lp-&gt;stats.rx_errors
op_increment
suffix:semicolon
id|lp-&gt;stats.rx_missed_errors
op_increment
suffix:semicolon
id|kfree_skb
c_func
(paren
id|in-&gt;skb
)paren
suffix:semicolon
)brace
id|in-&gt;sequence
op_assign
id|arcsoft-&gt;sequence
suffix:semicolon
id|in-&gt;numpackets
op_assign
(paren
(paren
r_int
)paren
id|arcsoft-&gt;split_flag
op_rshift
l_int|1
)paren
op_plus
l_int|2
suffix:semicolon
id|in-&gt;lastpacket
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|in-&gt;numpackets
OG
l_int|16
)paren
(brace
id|BUGMSG
c_func
(paren
id|D_EXTRA
comma
l_string|&quot;incoming packet more than 16 segments; dropping. (splitflag=%d)&bslash;n&quot;
comma
id|arcsoft-&gt;split_flag
)paren
suffix:semicolon
id|lp-&gt;stats.rx_errors
op_increment
suffix:semicolon
id|lp-&gt;stats.rx_length_errors
op_increment
suffix:semicolon
r_return
suffix:semicolon
)brace
id|in-&gt;skb
op_assign
id|skb
op_assign
id|alloc_skb
c_func
(paren
l_int|508
op_star
id|in-&gt;numpackets
op_plus
r_sizeof
(paren
r_struct
id|ClientData
)paren
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
id|skb
op_eq
l_int|NULL
)paren
(brace
id|BUGMSG
c_func
(paren
id|D_NORMAL
comma
l_string|&quot;(split) memory squeeze, dropping packet.&bslash;n&quot;
)paren
suffix:semicolon
id|lp-&gt;stats.rx_dropped
op_increment
suffix:semicolon
r_return
suffix:semicolon
)brace
id|soft
op_assign
(paren
r_struct
id|ClientData
op_star
)paren
id|skb-&gt;data
suffix:semicolon
id|skb_put
c_func
(paren
id|skb
comma
r_sizeof
(paren
r_struct
id|ClientData
)paren
)paren
suffix:semicolon
id|skb-&gt;dev
op_assign
id|dev
suffix:semicolon
id|memcpy
c_func
(paren
(paren
id|u_char
op_star
)paren
id|soft
op_plus
id|EXTRA_CLIENTDATA
comma
(paren
id|u_char
op_star
)paren
id|arcsoft
op_plus
id|EXTRA_CLIENTDATA
comma
r_sizeof
(paren
r_struct
id|ClientData
)paren
op_minus
id|EXTRA_CLIENTDATA
)paren
suffix:semicolon
id|soft-&gt;split_flag
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* final packet won&squot;t be split */
)brace
r_else
multiline_comment|/* not first packet */
(brace
r_int
id|packetnum
op_assign
(paren
(paren
r_int
)paren
id|arcsoft-&gt;split_flag
op_rshift
l_int|1
)paren
op_plus
l_int|1
suffix:semicolon
multiline_comment|/* if we&squot;re not assembling, there&squot;s no point&n;&t;   * trying to continue.&n;&t;   */
r_if
c_cond
(paren
op_logical_neg
id|in-&gt;skb
)paren
(brace
r_if
c_cond
(paren
id|lp-&gt;aborted_seq
op_ne
id|arcsoft-&gt;sequence
)paren
(brace
id|BUGMSG
c_func
(paren
id|D_EXTRA
comma
l_string|&quot;can&squot;t continue split without starting first! (splitflag=%d, seq=%d, aborted=%d)&bslash;n&quot;
comma
id|arcsoft-&gt;split_flag
comma
id|arcsoft-&gt;sequence
comma
id|lp-&gt;aborted_seq
)paren
suffix:semicolon
id|lp-&gt;stats.rx_errors
op_increment
suffix:semicolon
id|lp-&gt;stats.rx_missed_errors
op_increment
suffix:semicolon
)brace
r_return
suffix:semicolon
)brace
id|in-&gt;lastpacket
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|packetnum
op_ne
id|in-&gt;lastpacket
)paren
multiline_comment|/* not the right flag! */
(brace
multiline_comment|/* harmless duplicate? ignore. */
r_if
c_cond
(paren
id|packetnum
op_le
id|in-&gt;lastpacket
op_minus
l_int|1
)paren
(brace
id|BUGMSG
c_func
(paren
id|D_EXTRA
comma
l_string|&quot;duplicate splitpacket ignored! (splitflag=%d)&bslash;n&quot;
comma
id|arcsoft-&gt;split_flag
)paren
suffix:semicolon
id|lp-&gt;stats.rx_errors
op_increment
suffix:semicolon
id|lp-&gt;stats.rx_frame_errors
op_increment
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/* &quot;bad&quot; duplicate, kill reassembly */
id|BUGMSG
c_func
(paren
id|D_EXTRA
comma
l_string|&quot;out-of-order splitpacket, reassembly (seq=%d) aborted (splitflag=%d, seq=%d)&bslash;n&quot;
comma
id|in-&gt;sequence
comma
id|arcsoft-&gt;split_flag
comma
id|arcsoft-&gt;sequence
)paren
suffix:semicolon
id|lp-&gt;aborted_seq
op_assign
id|arcsoft-&gt;sequence
suffix:semicolon
id|kfree_skb
c_func
(paren
id|in-&gt;skb
)paren
suffix:semicolon
id|in-&gt;skb
op_assign
l_int|NULL
suffix:semicolon
id|lp-&gt;stats.rx_errors
op_increment
suffix:semicolon
id|lp-&gt;stats.rx_missed_errors
op_increment
suffix:semicolon
id|in-&gt;lastpacket
op_assign
id|in-&gt;numpackets
op_assign
l_int|0
suffix:semicolon
r_return
suffix:semicolon
)brace
id|soft
op_assign
(paren
r_struct
id|ClientData
op_star
)paren
id|in-&gt;skb-&gt;data
suffix:semicolon
)brace
id|skb
op_assign
id|in-&gt;skb
suffix:semicolon
id|memcpy
c_func
(paren
id|skb-&gt;data
op_plus
id|skb-&gt;len
comma
(paren
id|u_char
op_star
)paren
id|arcsoft
op_plus
r_sizeof
(paren
r_struct
id|ClientData
)paren
comma
id|length
op_minus
r_sizeof
(paren
r_struct
id|ClientData
)paren
)paren
suffix:semicolon
id|skb_put
c_func
(paren
id|skb
comma
id|length
op_minus
r_sizeof
(paren
r_struct
id|ClientData
)paren
)paren
suffix:semicolon
id|soft-&gt;daddr
op_assign
id|daddr
suffix:semicolon
id|soft-&gt;saddr
op_assign
id|saddr
suffix:semicolon
multiline_comment|/* are we done? */
r_if
c_cond
(paren
id|in-&gt;lastpacket
op_eq
id|in-&gt;numpackets
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|skb
op_logical_or
op_logical_neg
id|in-&gt;skb
)paren
(brace
id|BUGMSG
c_func
(paren
id|D_NORMAL
comma
l_string|&quot;?!? done reassembling packet, no skb? (skb=%ph, in-&gt;skb=%ph)&bslash;n&quot;
comma
id|skb
comma
id|in-&gt;skb
)paren
suffix:semicolon
)brace
r_else
(brace
id|in-&gt;skb
op_assign
l_int|NULL
suffix:semicolon
id|in-&gt;lastpacket
op_assign
id|in-&gt;numpackets
op_assign
l_int|0
suffix:semicolon
id|BUGLVL
c_func
(paren
id|D_SKB
)paren
id|arcnet_dump_skb
c_func
(paren
id|dev
comma
id|skb
comma
l_string|&quot;rx&quot;
)paren
suffix:semicolon
id|lp-&gt;stats.rx_bytes
op_add_assign
id|skb-&gt;len
suffix:semicolon
id|skb-&gt;protocol
op_assign
id|arcnetA_type_trans
c_func
(paren
id|skb
comma
id|dev
)paren
suffix:semicolon
id|netif_rx
c_func
(paren
id|skb
)paren
suffix:semicolon
)brace
)brace
)brace
)brace
multiline_comment|/****************************************************************************&n; *                                                                          *&n; * Miscellaneous routines                                                   *&n; *                                                                          *&n; ****************************************************************************/
multiline_comment|/* Get the current statistics.&t;This may be called with the card open or&n; * closed.&n; */
DECL|function|arcnet_get_stats
r_static
r_struct
id|net_device_stats
op_star
id|arcnet_get_stats
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|arcnet_local
op_star
id|lp
op_assign
(paren
r_struct
id|arcnet_local
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_return
op_amp
id|lp-&gt;stats
suffix:semicolon
)brace
multiline_comment|/* Create the ARCnet ClientData header for an arbitrary protocol layer&n; *&n; * saddr=NULL&t;means use device source address (always will anyway)&n; * daddr=NULL&t;means leave destination address (eg unresolved arp)&n; */
DECL|function|arcnetA_header
r_static
r_int
id|arcnetA_header
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|net_device
op_star
id|dev
comma
r_int
r_int
id|type
comma
r_void
op_star
id|daddr
comma
r_void
op_star
id|saddr
comma
r_int
id|len
)paren
(brace
r_struct
id|ClientData
op_star
id|head
op_assign
(paren
r_struct
id|ClientData
op_star
)paren
id|skb_push
c_func
(paren
id|skb
comma
id|dev-&gt;hard_header_len
)paren
suffix:semicolon
r_struct
id|arcnet_local
op_star
id|lp
op_assign
(paren
r_struct
id|arcnet_local
op_star
)paren
(paren
id|dev-&gt;priv
)paren
suffix:semicolon
id|BUGMSG
c_func
(paren
id|D_DURING
comma
l_string|&quot;create header from %d to %d; protocol %d (%Xh); size %u.&bslash;n&quot;
comma
id|saddr
ques
c_cond
op_star
(paren
id|u_char
op_star
)paren
id|saddr
suffix:colon
op_minus
l_int|1
comma
id|daddr
ques
c_cond
op_star
(paren
id|u_char
op_star
)paren
id|daddr
suffix:colon
op_minus
l_int|1
comma
id|type
comma
id|type
comma
id|len
)paren
suffix:semicolon
multiline_comment|/* set the protocol ID according to RFC1201 */
r_switch
c_cond
(paren
id|type
)paren
(brace
r_case
id|ETH_P_IP
suffix:colon
id|head-&gt;protocol_id
op_assign
id|ARC_P_IP
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ETH_P_ARP
suffix:colon
id|head-&gt;protocol_id
op_assign
id|ARC_P_ARP
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ETH_P_RARP
suffix:colon
id|head-&gt;protocol_id
op_assign
id|ARC_P_RARP
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ETH_P_IPX
suffix:colon
r_case
id|ETH_P_802_3
suffix:colon
r_case
id|ETH_P_802_2
suffix:colon
id|head-&gt;protocol_id
op_assign
id|ARC_P_IPX
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ETH_P_ATALK
suffix:colon
id|head-&gt;protocol_id
op_assign
id|ARC_P_ATALK
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|BUGMSG
c_func
(paren
id|D_NORMAL
comma
l_string|&quot;I don&squot;t understand protocol %d (%Xh)&bslash;n&quot;
comma
id|type
comma
id|type
)paren
suffix:semicolon
id|lp-&gt;stats.tx_errors
op_increment
suffix:semicolon
id|lp-&gt;stats.tx_aborted_errors
op_increment
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n;   * Set the source hardware address.&n;   *&n;   * This is pretty pointless for most purposes, but it can help&n;   * in debugging.  saddr is stored in the ClientData header and&n;   * removed before sending the packet (since ARCnet does not allow&n;   * us to change the source address in the actual packet sent)&n;   */
r_if
c_cond
(paren
id|saddr
)paren
(brace
id|head-&gt;saddr
op_assign
(paren
(paren
id|u_char
op_star
)paren
id|saddr
)paren
(braket
l_int|0
)braket
suffix:semicolon
)brace
r_else
id|head-&gt;saddr
op_assign
(paren
(paren
id|u_char
op_star
)paren
(paren
id|dev-&gt;dev_addr
)paren
)paren
(braket
l_int|0
)braket
suffix:semicolon
id|head-&gt;split_flag
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* split packets are done elsewhere */
id|head-&gt;sequence
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* so are sequence numbers */
multiline_comment|/* supposedly if daddr is NULL, we should ignore it... */
r_if
c_cond
(paren
id|daddr
)paren
(brace
id|head-&gt;daddr
op_assign
(paren
(paren
id|u_char
op_star
)paren
id|daddr
)paren
(braket
l_int|0
)braket
suffix:semicolon
r_return
id|dev-&gt;hard_header_len
suffix:semicolon
)brace
r_else
id|head-&gt;daddr
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* better fill one in anyway */
r_return
op_minus
id|dev-&gt;hard_header_len
suffix:semicolon
)brace
multiline_comment|/* Rebuild the ARCnet ClientData header. This is called after an ARP&n; * (or in future other address resolution) has completed on this&n; * sk_buff. We now let ARP fill in the other fields.&n; */
DECL|function|arcnetA_rebuild_header
r_static
r_int
id|arcnetA_rebuild_header
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
)paren
(brace
r_struct
id|ClientData
op_star
id|head
op_assign
(paren
r_struct
id|ClientData
op_star
)paren
id|skb-&gt;data
suffix:semicolon
r_struct
id|net_device
op_star
id|dev
op_assign
id|skb-&gt;dev
suffix:semicolon
r_struct
id|arcnet_local
op_star
id|lp
op_assign
(paren
r_struct
id|arcnet_local
op_star
)paren
(paren
id|dev-&gt;priv
)paren
suffix:semicolon
macro_line|#ifdef CONFIG_INET
r_int
id|status
suffix:semicolon
macro_line|#endif
multiline_comment|/*&n;   * Only ARP and IP are currently supported&n;   *&n;   * FIXME: Anyone want to spec IPv6 over ARCnet ?&n;   */
r_if
c_cond
(paren
id|head-&gt;protocol_id
op_ne
id|ARC_P_IP
)paren
(brace
id|BUGMSG
c_func
(paren
id|D_NORMAL
comma
l_string|&quot;I don&squot;t understand protocol type %d (%Xh) addresses!&bslash;n&quot;
comma
id|head-&gt;protocol_id
comma
id|head-&gt;protocol_id
)paren
suffix:semicolon
id|lp-&gt;stats.tx_errors
op_increment
suffix:semicolon
id|lp-&gt;stats.tx_aborted_errors
op_increment
suffix:semicolon
id|head-&gt;daddr
op_assign
l_int|0
suffix:semicolon
multiline_comment|/*memcpy(eth-&gt;h_source, dev-&gt;dev_addr, dev-&gt;addr_len);*/
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n;   * Try to get ARP to resolve the header.&n;   */
macro_line|#ifdef CONFIG_INET
id|BUGMSG
c_func
(paren
id|D_DURING
comma
l_string|&quot;rebuild header from %d to %d; protocol %Xh&bslash;n&quot;
comma
id|head-&gt;saddr
comma
id|head-&gt;daddr
comma
id|head-&gt;protocol_id
)paren
suffix:semicolon
id|status
op_assign
id|arp_find
c_func
(paren
op_amp
(paren
id|head-&gt;daddr
)paren
comma
id|skb
)paren
ques
c_cond
l_int|1
suffix:colon
l_int|0
suffix:semicolon
id|BUGMSG
c_func
(paren
id|D_DURING
comma
l_string|&quot; rebuilt: from %d to %d; protocol %Xh&bslash;n&quot;
comma
id|head-&gt;saddr
comma
id|head-&gt;daddr
comma
id|head-&gt;protocol_id
)paren
suffix:semicolon
r_return
id|status
suffix:semicolon
macro_line|#else
r_return
l_int|0
suffix:semicolon
macro_line|#endif
)brace
multiline_comment|/* Determine a packet&squot;s protocol ID.&n; *&n; * With ARCnet we have to convert everything to Ethernet-style stuff.&n; */
DECL|function|arcnetA_type_trans
r_static
r_int
r_int
id|arcnetA_type_trans
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|ClientData
op_star
id|head
suffix:semicolon
r_struct
id|arcnet_local
op_star
id|lp
op_assign
(paren
r_struct
id|arcnet_local
op_star
)paren
(paren
id|dev-&gt;priv
)paren
suffix:semicolon
multiline_comment|/* Pull off the arcnet header. */
id|skb-&gt;mac.raw
op_assign
id|skb-&gt;data
suffix:semicolon
id|skb_pull
c_func
(paren
id|skb
comma
id|dev-&gt;hard_header_len
)paren
suffix:semicolon
id|head
op_assign
(paren
r_struct
id|ClientData
op_star
)paren
id|skb-&gt;mac.raw
suffix:semicolon
r_if
c_cond
(paren
id|head-&gt;daddr
op_eq
l_int|0
)paren
id|skb-&gt;pkt_type
op_assign
id|PACKET_BROADCAST
suffix:semicolon
r_else
r_if
c_cond
(paren
id|dev-&gt;flags
op_amp
id|IFF_PROMISC
)paren
(brace
multiline_comment|/* if we&squot;re not sending to ourselves :) */
r_if
c_cond
(paren
id|head-&gt;daddr
op_ne
id|dev-&gt;dev_addr
(braket
l_int|0
)braket
)paren
id|skb-&gt;pkt_type
op_assign
id|PACKET_OTHERHOST
suffix:semicolon
)brace
multiline_comment|/* now return the protocol number */
r_switch
c_cond
(paren
id|head-&gt;protocol_id
)paren
(brace
r_case
id|ARC_P_IP
suffix:colon
r_return
id|htons
c_func
(paren
id|ETH_P_IP
)paren
suffix:semicolon
r_case
id|ARC_P_ARP
suffix:colon
r_return
id|htons
c_func
(paren
id|ETH_P_ARP
)paren
suffix:semicolon
r_case
id|ARC_P_RARP
suffix:colon
r_return
id|htons
c_func
(paren
id|ETH_P_RARP
)paren
suffix:semicolon
r_case
id|ARC_P_IPX
suffix:colon
r_case
id|ARC_P_NOVELL_EC
suffix:colon
r_return
id|htons
c_func
(paren
id|ETH_P_802_3
)paren
suffix:semicolon
r_default
suffix:colon
id|lp-&gt;stats.rx_errors
op_increment
suffix:semicolon
id|lp-&gt;stats.rx_crc_errors
op_increment
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_return
id|htons
c_func
(paren
id|ETH_P_IP
)paren
suffix:semicolon
)brace
macro_line|#ifdef CONFIG_ARCNET_ETH
multiline_comment|/****************************************************************************&n; *                                                                          *&n; * Ethernet-Encap Support                                                   *&n; *                                                                          *&n; ****************************************************************************/
multiline_comment|/* Initialize the arc0e device.&n; */
DECL|function|arcnetE_init
r_static
r_int
id|arcnetE_init
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|arcnet_local
op_star
id|lp
op_assign
(paren
r_struct
id|arcnet_local
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|ether_setup
c_func
(paren
id|dev
)paren
suffix:semicolon
multiline_comment|/* we&squot;re emulating ether here, not ARCnet */
id|dev-&gt;dev_addr
(braket
l_int|0
)braket
op_assign
l_int|0
suffix:semicolon
id|dev-&gt;dev_addr
(braket
l_int|5
)braket
op_assign
id|lp-&gt;stationid
suffix:semicolon
id|dev-&gt;mtu
op_assign
l_int|512
op_minus
r_sizeof
(paren
r_struct
id|archdr
)paren
op_minus
id|dev-&gt;hard_header_len
op_minus
l_int|1
suffix:semicolon
id|dev-&gt;open
op_assign
id|arcnetE_open_close
suffix:semicolon
id|dev-&gt;stop
op_assign
id|arcnetE_open_close
suffix:semicolon
id|dev-&gt;hard_start_xmit
op_assign
id|arcnetE_send_packet
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Bring up/down the arc0e device - we don&squot;t actually have to do anything,&n; * since our parent arc0 handles the card I/O itself.&n; */
DECL|function|arcnetE_open_close
r_static
r_int
id|arcnetE_open_close
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Called by the kernel in order to transmit an ethernet-type packet.&n; */
r_static
r_int
DECL|function|arcnetE_send_packet
id|arcnetE_send_packet
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|arcnet_local
op_star
id|lp
op_assign
(paren
r_struct
id|arcnet_local
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_int
id|bad
comma
id|oldmask
op_assign
l_int|0
suffix:semicolon
id|u_char
id|daddr
suffix:semicolon
r_int
id|offset
comma
id|length
op_assign
id|skb-&gt;len
op_plus
l_int|1
suffix:semicolon
id|u_char
id|proto
op_assign
id|ARC_P_ETHER
suffix:semicolon
id|lp-&gt;intx
op_increment
suffix:semicolon
id|oldmask
op_or_assign
id|lp-&gt;intmask
suffix:semicolon
id|lp-&gt;intmask
op_assign
l_int|0
suffix:semicolon
id|SETMASK
suffix:semicolon
id|bad
op_assign
id|arcnet_send_packet_bad
c_func
(paren
id|skb
comma
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|bad
)paren
(brace
id|lp-&gt;intx
op_decrement
suffix:semicolon
id|lp-&gt;intmask
op_assign
id|oldmask
suffix:semicolon
id|SETMASK
suffix:semicolon
r_return
id|bad
suffix:semicolon
)brace
multiline_comment|/* arcnet_send_packet_pad has already set tbusy - don&squot;t bother here. */
id|lp-&gt;intmask
op_assign
id|oldmask
suffix:semicolon
id|SETMASK
suffix:semicolon
r_if
c_cond
(paren
id|length
OG
id|XMTU
)paren
(brace
id|BUGMSG
c_func
(paren
id|D_NORMAL
comma
l_string|&quot;MTU must be &lt;= 493 for ethernet encap (length=%d).&bslash;n&quot;
comma
id|length
)paren
suffix:semicolon
id|BUGMSG
c_func
(paren
id|D_NORMAL
comma
l_string|&quot;transmit aborted.&bslash;n&quot;
)paren
suffix:semicolon
id|dev_kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
id|lp-&gt;intx
op_decrement
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|BUGMSG
c_func
(paren
id|D_DURING
comma
l_string|&quot;starting tx sequence...&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* broadcasts have address FF:FF:FF:FF:FF:FF in etherspeak */
r_if
c_cond
(paren
(paren
(paren
r_struct
id|ethhdr
op_star
)paren
(paren
id|skb-&gt;data
)paren
)paren
op_member_access_from_pointer
id|h_dest
(braket
l_int|0
)braket
op_eq
l_int|0xFF
)paren
id|daddr
op_assign
l_int|0
suffix:semicolon
r_else
id|daddr
op_assign
(paren
(paren
r_struct
id|ethhdr
op_star
)paren
(paren
id|skb-&gt;data
)paren
)paren
op_member_access_from_pointer
id|h_dest
(braket
l_int|5
)braket
suffix:semicolon
multiline_comment|/* load packet into shared memory */
id|offset
op_assign
l_int|512
op_minus
id|length
suffix:semicolon
r_if
c_cond
(paren
id|length
OG
id|MTU
)paren
multiline_comment|/* long/exception packet */
(brace
r_if
c_cond
(paren
id|length
OL
id|MinTU
)paren
id|offset
op_sub_assign
l_int|3
suffix:semicolon
)brace
r_else
multiline_comment|/* short packet */
(brace
id|offset
op_sub_assign
l_int|256
suffix:semicolon
)brace
id|BUGMSG
c_func
(paren
id|D_DURING
comma
l_string|&quot; length=%Xh, offset=%Xh&bslash;n&quot;
comma
id|length
comma
id|offset
)paren
suffix:semicolon
(paren
op_star
id|lp-&gt;prepare_tx
)paren
(paren
id|dev
comma
op_amp
id|proto
comma
l_int|1
comma
id|skb-&gt;data
comma
id|length
op_minus
l_int|1
comma
id|daddr
comma
l_int|0
comma
id|offset
)paren
suffix:semicolon
id|dev_kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
r_if
c_cond
(paren
id|arcnet_go_tx
c_func
(paren
id|dev
comma
l_int|1
)paren
)paren
(brace
multiline_comment|/* inform upper layers */
id|arcnet_tx_done
c_func
(paren
id|lp-&gt;adev
comma
id|lp
)paren
suffix:semicolon
)brace
id|dev-&gt;trans_start
op_assign
id|jiffies
suffix:semicolon
id|lp-&gt;intx
op_decrement
suffix:semicolon
multiline_comment|/* make sure we didn&squot;t ignore a TX IRQ while we were in here */
id|lp-&gt;intmask
op_or_assign
id|TXFREEflag
suffix:semicolon
id|SETMASK
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Packet receiver for ethernet-encap packets.&n; */
r_static
r_void
DECL|function|arcnetE_rx
id|arcnetE_rx
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
id|u_char
op_star
id|arcsoft
comma
r_int
id|length
comma
id|u_char
id|saddr
comma
id|u_char
id|daddr
)paren
(brace
r_struct
id|arcnet_local
op_star
id|lp
op_assign
(paren
r_struct
id|arcnet_local
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
id|BUGMSG
c_func
(paren
id|D_DURING
comma
l_string|&quot;it&squot;s an ethernet-encap packet (length=%d)&bslash;n&quot;
comma
id|length
)paren
suffix:semicolon
id|skb
op_assign
id|alloc_skb
c_func
(paren
id|length
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
id|skb
op_eq
l_int|NULL
)paren
(brace
id|BUGMSG
c_func
(paren
id|D_NORMAL
comma
l_string|&quot;Memory squeeze, dropping packet.&bslash;n&quot;
)paren
suffix:semicolon
id|lp-&gt;stats.rx_dropped
op_increment
suffix:semicolon
r_return
suffix:semicolon
)brace
id|skb_put
c_func
(paren
id|skb
comma
id|length
)paren
suffix:semicolon
id|skb-&gt;dev
op_assign
id|dev
suffix:semicolon
id|memcpy
c_func
(paren
id|skb-&gt;data
comma
(paren
id|u_char
op_star
)paren
id|arcsoft
op_plus
l_int|1
comma
id|length
op_minus
l_int|1
)paren
suffix:semicolon
id|BUGLVL
c_func
(paren
id|D_SKB
)paren
id|arcnet_dump_skb
c_func
(paren
id|dev
comma
id|skb
comma
l_string|&quot;rx&quot;
)paren
suffix:semicolon
id|lp-&gt;stats.rx_bytes
op_add_assign
id|skb-&gt;len
suffix:semicolon
id|skb-&gt;protocol
op_assign
id|eth_type_trans
c_func
(paren
id|skb
comma
id|dev
)paren
suffix:semicolon
id|netif_rx
c_func
(paren
id|skb
)paren
suffix:semicolon
)brace
macro_line|#endif /* CONFIG_ARCNET_ETH */
macro_line|#ifdef CONFIG_ARCNET_1051
multiline_comment|/****************************************************************************&n; *                                                                          *&n; * RFC1051 Support                                                          *&n; *                                                                          *&n; ****************************************************************************/
multiline_comment|/* Initialize the arc0s device.&n; */
DECL|function|arcnetS_init
r_static
r_int
id|arcnetS_init
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|arcnet_local
op_star
id|lp
op_assign
(paren
r_struct
id|arcnet_local
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|arcnet_setup
c_func
(paren
id|dev
)paren
suffix:semicolon
multiline_comment|/* And now fill particular fields with arcnet values */
id|dev-&gt;dev_addr
(braket
l_int|0
)braket
op_assign
id|lp-&gt;stationid
suffix:semicolon
id|dev-&gt;hard_header_len
op_assign
r_sizeof
(paren
r_struct
id|S_ClientData
)paren
suffix:semicolon
id|dev-&gt;mtu
op_assign
l_int|512
op_minus
r_sizeof
(paren
r_struct
id|archdr
)paren
op_minus
id|dev-&gt;hard_header_len
op_plus
id|S_EXTRA_CLIENTDATA
suffix:semicolon
id|dev-&gt;open
op_assign
id|arcnetS_open_close
suffix:semicolon
id|dev-&gt;stop
op_assign
id|arcnetS_open_close
suffix:semicolon
id|dev-&gt;hard_start_xmit
op_assign
id|arcnetS_send_packet
suffix:semicolon
id|dev-&gt;hard_header
op_assign
id|arcnetS_header
suffix:semicolon
id|dev-&gt;rebuild_header
op_assign
id|arcnetS_rebuild_header
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Bring up/down the arc0s device - we don&squot;t actually have to do anything,&n; * since our parent arc0 handles the card I/O itself.&n; */
DECL|function|arcnetS_open_close
r_static
r_int
id|arcnetS_open_close
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Called by the kernel in order to transmit an RFC1051-type packet.&n; */
r_static
r_int
DECL|function|arcnetS_send_packet
id|arcnetS_send_packet
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|arcnet_local
op_star
id|lp
op_assign
(paren
r_struct
id|arcnet_local
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_int
id|bad
comma
id|length
suffix:semicolon
r_struct
id|S_ClientData
op_star
id|hdr
op_assign
(paren
r_struct
id|S_ClientData
op_star
)paren
id|skb-&gt;data
suffix:semicolon
id|lp-&gt;intx
op_increment
suffix:semicolon
id|bad
op_assign
id|arcnet_send_packet_bad
c_func
(paren
id|skb
comma
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|bad
)paren
(brace
id|lp-&gt;intx
op_decrement
suffix:semicolon
r_return
id|bad
suffix:semicolon
)brace
multiline_comment|/* arcnet_send_packet_pad has already set tbusy - don&squot;t bother here. */
id|length
op_assign
l_int|1
OL
id|skb-&gt;len
ques
c_cond
id|skb-&gt;len
suffix:colon
l_int|1
suffix:semicolon
id|BUGLVL
c_func
(paren
id|D_SKB
)paren
id|arcnet_dump_skb
c_func
(paren
id|dev
comma
id|skb
comma
l_string|&quot;tx&quot;
)paren
suffix:semicolon
multiline_comment|/* fits in one packet? */
r_if
c_cond
(paren
id|length
op_minus
id|S_EXTRA_CLIENTDATA
op_le
id|XMTU
)paren
(brace
(paren
op_star
id|lp-&gt;prepare_tx
)paren
(paren
id|dev
comma
id|skb-&gt;data
op_plus
id|S_EXTRA_CLIENTDATA
comma
r_sizeof
(paren
r_struct
id|S_ClientData
)paren
op_minus
id|S_EXTRA_CLIENTDATA
comma
id|skb-&gt;data
op_plus
r_sizeof
(paren
r_struct
id|S_ClientData
)paren
comma
id|length
op_minus
r_sizeof
(paren
r_struct
id|S_ClientData
)paren
comma
id|hdr-&gt;daddr
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* done right away */
id|dev_kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
r_if
c_cond
(paren
id|arcnet_go_tx
c_func
(paren
id|dev
comma
l_int|1
)paren
)paren
(brace
multiline_comment|/* inform upper layers */
id|arcnet_tx_done
c_func
(paren
id|lp-&gt;adev
comma
id|lp
)paren
suffix:semicolon
)brace
)brace
r_else
multiline_comment|/* too big for one - not accepted */
(brace
id|BUGMSG
c_func
(paren
id|D_NORMAL
comma
l_string|&quot;packet too long (length=%d)&bslash;n&quot;
comma
id|length
)paren
suffix:semicolon
id|dev_kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
id|lp-&gt;stats.tx_dropped
op_increment
suffix:semicolon
id|arcnet_tx_done
c_func
(paren
id|lp-&gt;adev
comma
id|lp
)paren
suffix:semicolon
)brace
id|dev-&gt;trans_start
op_assign
id|jiffies
suffix:semicolon
id|lp-&gt;intx
op_decrement
suffix:semicolon
multiline_comment|/* make sure we didn&squot;t ignore a TX IRQ while we were in here */
id|lp-&gt;intmask
op_or_assign
id|TXFREEflag
suffix:semicolon
id|SETMASK
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Packet receiver for RFC1051 packets;&n; */
r_static
r_void
DECL|function|arcnetS_rx
id|arcnetS_rx
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
id|u_char
op_star
id|buf
comma
r_int
id|length
comma
id|u_char
id|saddr
comma
id|u_char
id|daddr
)paren
(brace
r_struct
id|arcnet_local
op_star
id|lp
op_assign
(paren
r_struct
id|arcnet_local
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
r_struct
id|S_ClientData
op_star
id|arcsoft
comma
op_star
id|soft
suffix:semicolon
id|arcsoft
op_assign
(paren
r_struct
id|S_ClientData
op_star
)paren
(paren
id|buf
op_minus
id|S_EXTRA_CLIENTDATA
)paren
suffix:semicolon
id|length
op_add_assign
id|S_EXTRA_CLIENTDATA
suffix:semicolon
id|BUGMSG
c_func
(paren
id|D_DURING
comma
l_string|&quot;it&squot;s an RFC1051 packet (length=%d)&bslash;n&quot;
comma
id|length
)paren
suffix:semicolon
(brace
multiline_comment|/* was &quot;if not split&quot; in A protocol, S is never split */
id|skb
op_assign
id|alloc_skb
c_func
(paren
id|length
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
id|skb
op_eq
l_int|NULL
)paren
(brace
id|BUGMSG
c_func
(paren
id|D_NORMAL
comma
l_string|&quot;Memory squeeze, dropping packet.&bslash;n&quot;
)paren
suffix:semicolon
id|lp-&gt;stats.rx_dropped
op_increment
suffix:semicolon
r_return
suffix:semicolon
)brace
id|soft
op_assign
(paren
r_struct
id|S_ClientData
op_star
)paren
id|skb-&gt;data
suffix:semicolon
id|skb_put
c_func
(paren
id|skb
comma
id|length
)paren
suffix:semicolon
id|memcpy
c_func
(paren
(paren
id|u_char
op_star
)paren
id|soft
op_plus
r_sizeof
(paren
r_struct
id|S_ClientData
)paren
op_minus
id|S_EXTRA_CLIENTDATA
comma
(paren
id|u_char
op_star
)paren
id|arcsoft
op_plus
r_sizeof
(paren
r_struct
id|S_ClientData
)paren
op_minus
id|S_EXTRA_CLIENTDATA
comma
id|length
op_minus
r_sizeof
(paren
r_struct
id|S_ClientData
)paren
op_plus
id|S_EXTRA_CLIENTDATA
)paren
suffix:semicolon
id|soft-&gt;protocol_id
op_assign
id|arcsoft-&gt;protocol_id
suffix:semicolon
id|soft-&gt;daddr
op_assign
id|daddr
suffix:semicolon
id|soft-&gt;saddr
op_assign
id|saddr
suffix:semicolon
id|skb-&gt;dev
op_assign
id|dev
suffix:semicolon
multiline_comment|/* is already lp-&gt;sdev */
id|BUGLVL
c_func
(paren
id|D_SKB
)paren
id|arcnet_dump_skb
c_func
(paren
id|dev
comma
id|skb
comma
l_string|&quot;rx&quot;
)paren
suffix:semicolon
id|lp-&gt;stats.rx_bytes
op_add_assign
id|skb-&gt;len
suffix:semicolon
id|skb-&gt;protocol
op_assign
id|arcnetS_type_trans
c_func
(paren
id|skb
comma
id|dev
)paren
suffix:semicolon
id|netif_rx
c_func
(paren
id|skb
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* Create the ARCnet ClientData header for an arbitrary protocol layer&n; *&n; * saddr=NULL&t;means use device source address (always will anyway)&n; * daddr=NULL&t;means leave destination address (eg unresolved arp)&n; */
DECL|function|arcnetS_header
r_static
r_int
id|arcnetS_header
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|net_device
op_star
id|dev
comma
r_int
r_int
id|type
comma
r_void
op_star
id|daddr
comma
r_void
op_star
id|saddr
comma
r_int
id|len
)paren
(brace
r_struct
id|S_ClientData
op_star
id|head
op_assign
(paren
r_struct
id|S_ClientData
op_star
)paren
id|skb_push
c_func
(paren
id|skb
comma
id|dev-&gt;hard_header_len
)paren
suffix:semicolon
r_struct
id|arcnet_local
op_star
id|lp
op_assign
(paren
r_struct
id|arcnet_local
op_star
)paren
(paren
id|dev-&gt;priv
)paren
suffix:semicolon
multiline_comment|/* set the protocol ID according to RFC1051 */
r_switch
c_cond
(paren
id|type
)paren
(brace
r_case
id|ETH_P_IP
suffix:colon
id|head-&gt;protocol_id
op_assign
id|ARC_P_IP_RFC1051
suffix:semicolon
id|BUGMSG
c_func
(paren
id|D_DURING
comma
l_string|&quot;S_header: IP_RFC1051 packet.&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ETH_P_ARP
suffix:colon
id|head-&gt;protocol_id
op_assign
id|ARC_P_ARP_RFC1051
suffix:semicolon
id|BUGMSG
c_func
(paren
id|D_DURING
comma
l_string|&quot;S_header: ARP_RFC1051 packet.&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|BUGMSG
c_func
(paren
id|D_NORMAL
comma
l_string|&quot;I don&squot;t understand protocol %d (%Xh)&bslash;n&quot;
comma
id|type
comma
id|type
)paren
suffix:semicolon
id|lp-&gt;stats.tx_errors
op_increment
suffix:semicolon
id|lp-&gt;stats.tx_aborted_errors
op_increment
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n;   * Set the source hardware address.&n;   *&n;   * This is pretty pointless for most purposes, but it can help&n;   * in debugging.  saddr is stored in the ClientData header and&n;   * removed before sending the packet (since ARCnet does not allow&n;   * us to change the source address in the actual packet sent)&n;   */
r_if
c_cond
(paren
id|saddr
)paren
(brace
id|head-&gt;saddr
op_assign
(paren
(paren
id|u_char
op_star
)paren
id|saddr
)paren
(braket
l_int|0
)braket
suffix:semicolon
)brace
r_else
id|head-&gt;saddr
op_assign
(paren
(paren
id|u_char
op_star
)paren
(paren
id|dev-&gt;dev_addr
)paren
)paren
(braket
l_int|0
)braket
suffix:semicolon
multiline_comment|/* supposedly if daddr is NULL, we should ignore it... */
r_if
c_cond
(paren
id|daddr
)paren
(brace
id|head-&gt;daddr
op_assign
(paren
(paren
id|u_char
op_star
)paren
id|daddr
)paren
(braket
l_int|0
)braket
suffix:semicolon
r_return
id|dev-&gt;hard_header_len
suffix:semicolon
)brace
r_else
id|head-&gt;daddr
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* better fill one in anyway */
r_return
op_minus
id|dev-&gt;hard_header_len
suffix:semicolon
)brace
multiline_comment|/* Rebuild the ARCnet ClientData header. This is called after an ARP&n; * (or in future other address resolution) has completed on this&n; * sk_buff. We now let ARP fill in the other fields.&n; */
DECL|function|arcnetS_rebuild_header
r_static
r_int
id|arcnetS_rebuild_header
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
)paren
(brace
r_struct
id|net_device
op_star
id|dev
op_assign
id|skb-&gt;dev
suffix:semicolon
r_struct
id|S_ClientData
op_star
id|head
op_assign
(paren
r_struct
id|S_ClientData
op_star
)paren
id|skb-&gt;data
suffix:semicolon
r_struct
id|arcnet_local
op_star
id|lp
op_assign
(paren
r_struct
id|arcnet_local
op_star
)paren
(paren
id|dev-&gt;priv
)paren
suffix:semicolon
multiline_comment|/*&n;   * Only ARP and IP are currently supported&n;   */
r_if
c_cond
(paren
id|head-&gt;protocol_id
op_ne
id|ARC_P_IP_RFC1051
)paren
(brace
id|BUGMSG
c_func
(paren
id|D_NORMAL
comma
l_string|&quot;I don&squot;t understand protocol type %d (%Xh) addresses!&bslash;n&quot;
comma
id|head-&gt;protocol_id
comma
id|head-&gt;protocol_id
)paren
suffix:semicolon
id|lp-&gt;stats.tx_errors
op_increment
suffix:semicolon
id|lp-&gt;stats.tx_aborted_errors
op_increment
suffix:semicolon
id|head-&gt;daddr
op_assign
l_int|0
suffix:semicolon
multiline_comment|/*memcpy(eth-&gt;h_source, dev-&gt;dev_addr, dev-&gt;addr_len);*/
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n;   * Try to get ARP to resolve the header.&n;   */
macro_line|#ifdef CONFIG_INET
r_return
id|arp_find
c_func
(paren
op_amp
(paren
id|head-&gt;daddr
)paren
comma
id|skb
)paren
ques
c_cond
l_int|1
suffix:colon
l_int|0
suffix:semicolon
macro_line|#else
r_return
l_int|0
suffix:semicolon
macro_line|#endif
)brace
multiline_comment|/* Determine a packet&squot;s protocol ID.&n; *&n; * With ARCnet we have to convert everything to Ethernet-style stuff.&n; */
DECL|function|arcnetS_type_trans
r_int
r_int
id|arcnetS_type_trans
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|S_ClientData
op_star
id|head
suffix:semicolon
r_struct
id|arcnet_local
op_star
id|lp
op_assign
(paren
r_struct
id|arcnet_local
op_star
)paren
(paren
id|dev-&gt;priv
)paren
suffix:semicolon
multiline_comment|/* Pull off the arcnet header. */
id|skb-&gt;mac.raw
op_assign
id|skb-&gt;data
suffix:semicolon
id|skb_pull
c_func
(paren
id|skb
comma
id|dev-&gt;hard_header_len
)paren
suffix:semicolon
id|head
op_assign
(paren
r_struct
id|S_ClientData
op_star
)paren
id|skb-&gt;mac.raw
suffix:semicolon
r_if
c_cond
(paren
id|head-&gt;daddr
op_eq
l_int|0
)paren
id|skb-&gt;pkt_type
op_assign
id|PACKET_BROADCAST
suffix:semicolon
r_else
r_if
c_cond
(paren
id|dev-&gt;flags
op_amp
id|IFF_PROMISC
)paren
(brace
multiline_comment|/* if we&squot;re not sending to ourselves :) */
r_if
c_cond
(paren
id|head-&gt;daddr
op_ne
id|dev-&gt;dev_addr
(braket
l_int|0
)braket
)paren
id|skb-&gt;pkt_type
op_assign
id|PACKET_OTHERHOST
suffix:semicolon
)brace
multiline_comment|/* now return the protocol number */
r_switch
c_cond
(paren
id|head-&gt;protocol_id
)paren
(brace
r_case
id|ARC_P_IP_RFC1051
suffix:colon
r_return
id|htons
c_func
(paren
id|ETH_P_IP
)paren
suffix:semicolon
r_case
id|ARC_P_ARP_RFC1051
suffix:colon
r_return
id|htons
c_func
(paren
id|ETH_P_ARP
)paren
suffix:semicolon
r_case
id|ARC_P_ATALK
suffix:colon
r_return
id|htons
c_func
(paren
id|ETH_P_ATALK
)paren
suffix:semicolon
multiline_comment|/* untested appletalk */
r_default
suffix:colon
id|lp-&gt;stats.rx_errors
op_increment
suffix:semicolon
id|lp-&gt;stats.rx_crc_errors
op_increment
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_return
id|htons
c_func
(paren
id|ETH_P_IP
)paren
suffix:semicolon
)brace
macro_line|#endif&t;/* CONFIG_ARCNET_1051 */
multiline_comment|/****************************************************************************&n; *                                                                          *&n; * Kernel Loadable Module Support                                           *&n; *                                                                          *&n; ****************************************************************************/
macro_line|#ifdef MODULE
DECL|function|cleanup_module
r_void
id|cleanup_module
c_func
(paren
r_void
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;Generic arcnet support removed.&bslash;n&quot;
)paren
suffix:semicolon
)brace
DECL|function|arcnet_use_count
r_void
id|arcnet_use_count
c_func
(paren
r_int
id|open
)paren
(brace
r_if
c_cond
(paren
id|open
)paren
id|MOD_INC_USE_COUNT
suffix:semicolon
r_else
id|MOD_DEC_USE_COUNT
suffix:semicolon
)brace
macro_line|#else
DECL|function|arcnet_use_count
r_void
id|arcnet_use_count
c_func
(paren
r_int
id|open
)paren
(brace
)brace
DECL|variable|arcnet_devs
r_struct
id|net_device
id|arcnet_devs
(braket
id|MAX_ARCNET_DEVS
)braket
suffix:semicolon
DECL|variable|arcnet_num_devs
r_int
id|arcnet_num_devs
op_assign
l_int|0
suffix:semicolon
DECL|variable|arcnet_dev_names
r_char
id|arcnet_dev_names
(braket
id|MAX_ARCNET_DEVS
)braket
(braket
l_int|10
)braket
suffix:semicolon
DECL|function|arcnet_init
r_void
id|__init
id|arcnet_init
c_func
(paren
r_void
)paren
(brace
r_int
id|c
suffix:semicolon
id|init_module
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* Don&squot;t register_netdev here. The chain hasn&squot;t been initialised. */
macro_line|#ifdef CONFIG_ARCNET_COM90xx
r_if
c_cond
(paren
(paren
op_logical_neg
id|com90xx_explicit
)paren
op_logical_and
id|arcnet_num_devs
OL
id|MAX_ARCNET_DEVS
)paren
(brace
id|arcnet_devs
(braket
id|arcnet_num_devs
)braket
dot
id|init
op_assign
id|arc90xx_probe
suffix:semicolon
id|arcnet_devs
(braket
id|arcnet_num_devs
)braket
dot
id|name
op_assign
(paren
r_char
op_star
)paren
op_amp
id|arcnet_dev_names
(braket
id|arcnet_num_devs
)braket
suffix:semicolon
id|arcnet_num_devs
op_increment
suffix:semicolon
)brace
macro_line|#endif
r_if
c_cond
(paren
op_logical_neg
id|arcnet_num_devs
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;Don&squot;t forget to load the chipset driver.&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/* Link into the device chain */
multiline_comment|/* Q: Should we put ourselves at the beginning or the end of the chain? */
multiline_comment|/* Probably the end, because we&squot;re not so fast, but... */
r_for
c_loop
(paren
id|c
op_assign
l_int|0
suffix:semicolon
id|c
OL
(paren
id|arcnet_num_devs
op_minus
l_int|1
)paren
suffix:semicolon
id|c
op_increment
)paren
id|arcnet_devs
(braket
id|c
)braket
dot
id|next
op_assign
op_amp
id|arcnet_devs
(braket
id|c
op_plus
l_int|1
)braket
suffix:semicolon
id|write_lock_bh
c_func
(paren
op_amp
id|dev_base_lock
)paren
suffix:semicolon
id|arcnet_devs
(braket
id|c
)braket
dot
id|next
op_assign
id|dev_base
suffix:semicolon
id|dev_base
op_assign
op_amp
id|arcnet_devs
(braket
l_int|0
)braket
suffix:semicolon
id|write_unlock_bh
c_func
(paren
op_amp
id|dev_base_lock
)paren
suffix:semicolon
multiline_comment|/* Give names to those without them */
r_for
c_loop
(paren
id|c
op_assign
l_int|0
suffix:semicolon
id|c
OL
id|arcnet_num_devs
suffix:semicolon
id|c
op_increment
)paren
r_if
c_cond
(paren
op_logical_neg
id|arcnet_dev_names
(braket
id|c
)braket
(braket
l_int|0
)braket
)paren
id|arcnet_makename
c_func
(paren
(paren
r_char
op_star
)paren
op_amp
id|arcnet_dev_names
(braket
id|c
)braket
)paren
suffix:semicolon
)brace
macro_line|#endif /* MODULE */
macro_line|#ifdef MODULE
DECL|function|init_module
r_int
id|init_module
c_func
(paren
r_void
)paren
macro_line|#else
r_static
r_int
id|__init
id|init_module
c_func
(paren
r_void
)paren
macro_line|#endif
(brace
macro_line|#ifdef ALPHA_WARNING
id|BUGLVL
c_func
(paren
id|D_EXTRA
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;arcnet: ***&bslash;n&quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;arcnet: * Read arcnet.txt for important release notes!&bslash;n&quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;arcnet: *&bslash;n&quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;arcnet: * This is an ALPHA version!  (Last stable release: v2.56)  E-mail me if&bslash;n&quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;arcnet: * you have any questions, comments, or bug reports.&bslash;n&quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;arcnet: ***&bslash;n&quot;
)paren
suffix:semicolon
)brace
macro_line|#endif
id|printk
c_func
(paren
l_string|&quot;%sAvailable protocols: ARCnet RFC1201&quot;
macro_line|#ifdef CONFIG_ARCNET_ETH
l_string|&quot;, Ethernet-Encap&quot;
macro_line|#endif
macro_line|#ifdef CONFIG_ARCNET_1051
l_string|&quot;, ARCnet RFC1051&quot;
macro_line|#endif
macro_line|#ifdef MODULE
l_string|&quot;.&bslash;nDon&squot;t forget to load the chipset driver&quot;
macro_line|#endif
l_string|&quot;.&bslash;n&quot;
comma
id|version
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|arcnet_makename
r_void
id|arcnet_makename
c_func
(paren
r_char
op_star
id|device
)paren
(brace
r_struct
id|net_device
op_star
id|dev
suffix:semicolon
r_int
id|arcnum
suffix:semicolon
id|arcnum
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
suffix:semicolon
suffix:semicolon
)paren
(brace
id|sprintf
c_func
(paren
id|device
comma
l_string|&quot;arc%d&quot;
comma
id|arcnum
)paren
suffix:semicolon
id|read_lock_bh
c_func
(paren
op_amp
id|dev_base_lock
)paren
suffix:semicolon
r_for
c_loop
(paren
id|dev
op_assign
id|dev_base
suffix:semicolon
id|dev
suffix:semicolon
id|dev
op_assign
id|dev-&gt;next
)paren
r_if
c_cond
(paren
id|dev-&gt;name
op_ne
id|device
op_logical_and
op_logical_neg
id|strcmp
c_func
(paren
id|dev-&gt;name
comma
id|device
)paren
)paren
r_break
suffix:semicolon
id|read_unlock_bh
c_func
(paren
op_amp
id|dev_base_lock
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dev
)paren
r_return
suffix:semicolon
id|arcnum
op_increment
suffix:semicolon
)brace
)brace
eof
