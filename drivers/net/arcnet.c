multiline_comment|/* arcnet.c:&n;&t;Written 1994-1996 by Avery Pennarun,&n;&t;derived from skeleton.c by Donald Becker.&n;&n;&t;Contact Avery at: apenwarr@foxnet.net or&n;&t;RR #5 Pole Line Road, Thunder Bay, ON, Canada P7C 5M9&n;&n;&t;**********************&n;&n;&t;The original copyright was as follows:&n;&n;&t;skeleton.c Written 1993 by Donald Becker.&n;&t;Copyright 1993 United States Government as represented by the&n;        Director, National Security Agency.  This software may only be used&n;        and distributed according to the terms of the GNU Public License as&n;        modified by SRC, incorporated herein by reference.&n;&n;&t;**********************&n;&n;&t;v2.60 ALPHA (96/11/23)&n;&t;  - Added patch from Vojtech Pavlik &lt;vojtech@atrey.karlin.mff.cuni.cz&gt;&n;&t;    and Martin Mares &lt;mj@k332.feld.cvut.cz&gt; to make the driver work&n;&t;    with the new Linux 2.1.x memory management.  I modified their&n;&t;    patch quite a bit though; bugs are my fault.  More changes should&n;&t;    be made to get eliminate any remaining phys_to_virt calls.&n;&t;  - Quietly ignore protocol id&squot;s 0, 1, 8, and 243.  Thanks to Jake&n;&t;    Messinger &lt;jake@ams.com&gt; for reporting these codes and their&n;&t;    meanings.&n;&t;  - Smarter shmem probe for cards with 4k mirrors. (does it work?)&n;&t;  - Initial support for RIM I type cards which use no I/O ports at&n;&t;    all.  To use this option, you need to compile with RIM_I_MODE&n;&t;    enabled.  Thanks to Kolja Waschk &lt;kawk@yo.com&gt; for explaining&n;&t;    RIM I programming to me.  Now, does my RIM I code actually&n;&t;    work?&n;&n;&t;v2.56 (96/10/18)&n;&t;  - Turned arc0e/arc0s startup messages back on by default, as most&n;&t;    people will probably not notice the additional devices&n;&t;    otherwise.  This causes undue confusion.&n;&t;  - Fixed a tiny but noticeable bug in the packet debugging routines&n;&t;    (thanks Tomasz)&n;&n;&t;The following has been SUMMARIZED.  The complete ChangeLog is&n;&t;available in the full Linux-ARCnet package at&n;&t;&t;http://www.foxnet.net/~apenwarr/arcnet&n;&n;&t;v2.50 (96/02/24)&n;&t;  - Massively improved autoprobe routines; they now work even as a&n;&t;    module.  Thanks to Vojtech Pavlik &lt;Vojtech.Pavlik@st.mff.cuni.cz&gt;&n;&t;    for his ideas and help in this area.&n;&t;  - Changed printk&squot;s around quite a lot.&n;&n;&t;v2.22 (95/12/08)&n;&t;  - Major cleanups, speedups, and better code-sharing.&n;&t;  - Eliminated/changed many useless/meaningless/scary debug messages&n;&t;    (and, in most cases, the bugs that caused them).&n;&t;  - Better IPX support.&n;&t;  - lp-&gt;stats updated properly.&n;&t;  - RECON checking now by default only prints a message if there are&n;&t;    excessive errors (ie. your cable is probably broken).&n;&t;  - New RFC1051-compliant &quot;arc0s&quot; virtual device by Tomasz&n;&t;    Motylewski.&n;&t;  - Excess debug messages can be compiled out to reduce code size.&n;&n;&t;v2.00 (95/09/06)&n;&t;  - ARCnet RECON messages are now detected and logged as &quot;carrier&quot;&n;&t;    errors.&n;&t;  - The TXACK flag is now checked, and errors are logged.&n;&t;  - Debug levels are now completely different.  See the README.&n;&t;  - Massive code cleanups, with several no-longer-necessary and some&n;&t;    completely useless options removed.&n;&t;  - Multiprotocol support.  You can now use the &quot;arc0e&quot; device to&n;&t;    send &quot;Ethernet-Encapsulation&quot; packets, which are compatible with&n;&t;    Windows for Workgroups and LAN Manager, and possibly other&n;&t;    software.  See the README for more information.&n;&n;&t;v1.02 (95/06/21)&n;          - A fix to make &quot;exception&quot; packets sent from Linux receivable&n;&t;    on other systems.  (The protocol_id byte was sometimes being set&n;&t;    incorrectly, and Linux wasn&squot;t checking it on receive so it&n;&t;    didn&squot;t show up)&n;&n;&t;v1.01 (95/03/24)&n;&t;  - Fixed some IPX-related bugs. (Thanks to Tomasz Motylewski&n;            &lt;motyl@tichy.ch.uj.edu.pl&gt; for the patches to make arcnet work&n;            with dosemu!)&n;&n;&t;v1.00 (95/02/15)&n;&t;  - Initial non-alpha release.&n;&n;&n;&t;TO DO: (semi-prioritized)&n;&n;         - Use cleaner &quot;architecture-independent&quot; shared memory access.&n;           This is half-done in ARCnet 2.60, but still uses some&n;           undocumented i386 stuff.  (We shouldn&squot;t call phys_to_virt,&n;           for example.)&n;         - Support &quot;arpless&quot; mode like NetBSD does, and as recommended&n;           by the (obsoleted) RFC1051.&n;         - Some way to make RIM_I_MODE runtime switchable?  Yuck...&n;         - Smarter recovery from RECON-during-transmit conditions. (ie.&n;           retransmit immediately)&n;         - Make arcnetE_send_packet use arcnet_prepare_tx for loading the&n;           packet into ARCnet memory.&n;         - Probe for multiple devices in one shot (trying to decide whether&n;           to do it the &quot;ugly&quot; way or not).&n;         - Add support for the new 1.3.x IP header cache, and other features.&n;         - Debug level should be changed with a system call, not a hack to&n;           the &quot;metric&quot; flag.&n;         - What about cards with shared memory that can be &quot;turned off?&quot;&n;           (or that have none at all, like the SMC PC500longboard)&n;         - Autoconfigure PDI5xxPlus cards. (I now have a PDI508Plus to play&n;           with temporarily.)  Update: yes, the Pure Data config program&n;           for DOS works fine, but the PDI508Plus I have doesn&squot;t! :)&n;         - Try to implement promiscuous (receive-all-packets) mode available&n;           on some newer cards with COM20020 and similar chips.  I don&squot;t have&n;           one, but SMC sent me the specs.&n;         - ATA protocol support??&n;         - VINES TCP/IP encapsulation?? (info needed)&n;&n;&n;&t;Sources:&n;&t; - Crynwr arcnet.com/arcether.com packet drivers.&n;&t; - arcnet.c v0.00 dated 1/1/94 and apparently by&n;&t; &t;Donald Becker - it didn&squot;t work :)&n;&t; - skeleton.c v0.05 dated 11/16/93 by Donald Becker&n;&t; &t;(from Linux Kernel 1.1.45)&n;&t; - RFC&squot;s 1201 and 1051 - re: TCP/IP over ARCnet&n;&t; - The official ARCnet COM9026 data sheets (!) thanks to Ken&n;&t;&t;Cornetet &lt;kcornete@nyx10.cs.du.edu&gt;&n;&t; - Information on some more obscure ARCnet controller chips, thanks&n;&t;   to the nice people at SMC.&n;&t; - net/inet/eth.c (from kernel 1.1.50) for header-building info.&n;&t; - Alternate Linux ARCnet source by V.Shergin &lt;vsher@sao.stavropol.su&gt;&n;&t; - Textual information and more alternate source from Joachim Koenig&n;&t; &t;&lt;jojo@repas.de&gt;&n;*/
DECL|variable|version
r_static
r_const
r_char
op_star
id|version
op_assign
l_string|&quot;arcnet.c: v2.60 96/11/23 Avery Pennarun &lt;apenwarr@foxnet.net&gt;&bslash;n&quot;
suffix:semicolon
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/version.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/fcntl.h&gt;
macro_line|#include &lt;linux/interrupt.h&gt;
macro_line|#include &lt;linux/ptrace.h&gt;
macro_line|#include &lt;linux/ioport.h&gt;
macro_line|#include &lt;linux/in.h&gt;
macro_line|#include &lt;linux/malloc.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/timer.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;linux/netdevice.h&gt;
macro_line|#include &lt;linux/if_arp.h&gt;
macro_line|#include &lt;linux/etherdevice.h&gt;
macro_line|#include &lt;linux/skbuff.h&gt;
macro_line|#include &lt;asm/system.h&gt;
macro_line|#include &lt;asm/bitops.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/dma.h&gt;
macro_line|#include &lt;net/arp.h&gt;
multiline_comment|/**************************************************************************/
multiline_comment|/* Define this if you have a really ancient &quot;RIM I&quot; ARCnet card with no I/O&n; * port at all and _only_ shared memory; this option MAY work for you.  It&squot;s&n; * untested, though, so good luck and write to me with any results!&n; */
DECL|macro|RIM_I_MODE
macro_line|#undef RIM_I_MODE
multiline_comment|/* Normally, the ARCnet device needs to be assigned a name (default arc0).&n; * Ethernet devices have a function to automatically try eth0, eth1, etc&n; * until a free name is found.  To name the ARCnet device using an &quot;eth?&quot;&n; * device name, define this option.&n; */
DECL|macro|CONFIG_ARCNET_ETHNAME
macro_line|#undef CONFIG_ARCNET_ETHNAME
multiline_comment|/* On a fast computer, the buffer copy from memory to the ARCnet card during&n; * a transmit can hog the bus just a little too long.  SLOW_XMIT_COPY&n; * replaces the fast memcpy() with a slower for() loop that seems to solve&n; * my problems with ftape.&n; *&n; * Probably a better solution would be to use memcpy_toio (more portable&n; * anyway) and modify that routine to support REALLY_SLOW_IO-style&n; * defines; ARCnet probably is not the only driver that can screw up an&n; * ftape DMA transfer.&n; *&n; * Turn this on if you have timing-sensitive DMA (ie. a tape drive) and&n; * would like to sacrifice a little bit of network speed to reduce tape&n; * write retries or some related problem.&n; */
DECL|macro|SLOW_XMIT_COPY
macro_line|#undef SLOW_XMIT_COPY
multiline_comment|/* The card sends the reconfiguration signal when it loses the connection to&n; * the rest of its network. It is a &squot;Hello, is anybody there?&squot; cry.  This&n; * usually happens when a new computer on the network is powered on or when&n; * the cable is broken.&n; *&n; * Define DETECT_RECONFIGS if you want to detect network reconfigurations.&n; * Recons may be a real nuisance on a larger ARCnet network; if you are a&n; * network administrator you probably would like to count them.&n; * Reconfigurations will be recorded in stats.tx_carrier_errors (the last&n; * field of the /proc/net/dev file).&n; *&n; * Define SHOW_RECONFIGS if you really want to see a log message whenever&n; * a RECON occurs.&n; */
DECL|macro|DETECT_RECONFIGS
mdefine_line|#define DETECT_RECONFIGS
DECL|macro|SHOW_RECONFIGS
macro_line|#undef SHOW_RECONFIGS
multiline_comment|/* RECON_THRESHOLD is the maximum number of RECON messages to receive within&n; * one minute before printing a &quot;cabling problem&quot; warning.  You must have&n; * DETECT_RECONFIGS enabled if you want to use this.  The default value&n; * should be fine.&n; *&n; * After that, a &quot;cabling restored&quot; message will be printed on the next IRQ&n; * if no RECON messages have been received for 10 seconds.&n; *&n; * Do not define RECON_THRESHOLD at all if you want to disable this feature.&n; */
DECL|macro|RECON_THRESHOLD
mdefine_line|#define RECON_THRESHOLD 30
multiline_comment|/* Define this to the minimum &quot;timeout&quot; value.  If a transmit takes longer&n; * than TX_TIMEOUT jiffies, Linux will abort the TX and retry.  On a large&n; * network, or one with heavy network traffic, this timeout may need to be&n; * increased.  The larger it is, though, the longer it will be between&n; * necessary transmits - don&squot;t set this too large.&n; */
DECL|macro|TX_TIMEOUT
mdefine_line|#define TX_TIMEOUT 20
multiline_comment|/* Define this to speed up the autoprobe by assuming if only one io port and&n; * shmem are left in the list at Stage 5, they must correspond to each&n; * other.&n; *&n; * This is undefined by default because it might not always be true, and the&n; * extra check makes the autoprobe even more careful.  Speed demons can turn&n; * it on - I think it should be fine if you only have one ARCnet card&n; * installed.&n; *&n; * If no ARCnet cards are installed, this delay never happens anyway and thus&n; * the option has no effect.&n; */
DECL|macro|FAST_PROBE
macro_line|#undef FAST_PROBE
multiline_comment|/* Define this to speed up &quot;ifconfig up&quot; by moving the card reset command&n; * around.  This is a new option in 2.41 ALPHA.  If it causes problems,&n; * undefine this to get the old behaviour; then send me email, because if&n; * there are no problems, this option will go away very soon.&n; */
DECL|macro|FAST_IFCONFIG
mdefine_line|#define FAST_IFCONFIG
multiline_comment|/* Define this if you want to make it easier to use the &quot;call trace&quot; when&n; * a kernel NULL pointer assignment occurs.  Hopefully unnecessary, most of&n; * the time.  It will make all the function names (and other things) show&n; * up as kernel symbols.  (especially handy when using arcnet as a module)&n; */
DECL|macro|static
macro_line|#undef static
multiline_comment|/**************************************************************************/
multiline_comment|/* New debugging bitflags: each option can be enabled individually.&n; *&n; * These can be set while the driver is running by typing:&n; *&t;ifconfig arc0 down metric 1xxx HOSTNAME&n; *&t;&t;where 1xxx is 1000 + the debug level you want&n; *&t;&t;and HOSTNAME is your hostname/ip address&n; * and then resetting your routes.&n; *&n; * An ioctl() should be used for this instead, someday.&n; *&n; * Note: only debug flags included in the ARCNET_DEBUG_MAX define will&n; *   actually be available.  GCC will (at least, GCC 2.7.0 will) notice&n; *   lines using a BUGLVL not in ARCNET_DEBUG_MAX and automatically optimize&n; *   them out.&n; */
DECL|macro|D_NORMAL
mdefine_line|#define D_NORMAL&t;1&t;/* important operational info&t;&t;*/
DECL|macro|D_EXTRA
mdefine_line|#define D_EXTRA&t;&t;2&t;/* useful, but non-vital information&t;*/
DECL|macro|D_INIT
mdefine_line|#define&t;D_INIT&t;&t;4&t;/* show init/probe messages&t;&t;*/
DECL|macro|D_INIT_REASONS
mdefine_line|#define D_INIT_REASONS&t;8&t;/* show reasons for discarding probes&t;*/
multiline_comment|/* debug levels below give LOTS of output during normal operation! */
DECL|macro|D_DURING
mdefine_line|#define D_DURING&t;16&t;/* trace operations (including irq&squot;s)&t;*/
DECL|macro|D_TX
mdefine_line|#define D_TX&t;&t;32&t;/* show tx packets&t;&t;&t;*/
DECL|macro|D_RX
mdefine_line|#define D_RX&t;&t;64&t;/* show rx packets&t;&t;&t;*/
DECL|macro|D_SKB
mdefine_line|#define D_SKB&t;&t;128&t;/* show skb&squot;s&t;&t;&t;&t;*/
macro_line|#ifndef ARCNET_DEBUG_MAX
DECL|macro|ARCNET_DEBUG_MAX
mdefine_line|#define ARCNET_DEBUG_MAX (~0)&t;&t;/* enable ALL debug messages&t; */
multiline_comment|/*#define ARCNET_DEBUG_MAX (D_NORMAL|D_EXTRA|D_INIT|D_INIT_REASONS) &t; */
multiline_comment|/*#define ARCNET_DEBUG_MAX 0&t;*/
multiline_comment|/* enable NO messages (bad idea) */
macro_line|#endif
macro_line|#ifndef ARCNET_DEBUG
DECL|macro|ARCNET_DEBUG
mdefine_line|#define ARCNET_DEBUG (D_NORMAL|D_EXTRA)
macro_line|#endif
DECL|variable|arcnet_debug
r_int
id|arcnet_debug
op_assign
id|ARCNET_DEBUG
suffix:semicolon
multiline_comment|/* macros to simplify debug checking */
DECL|macro|BUGLVL
mdefine_line|#define BUGLVL(x) if ((ARCNET_DEBUG_MAX)&amp;arcnet_debug&amp;(x))
DECL|macro|BUGMSG2
mdefine_line|#define BUGMSG2(x,msg,args...) BUGLVL(x) printk(msg, ## args)
DECL|macro|BUGMSG
mdefine_line|#define BUGMSG(x,msg,args...) BUGMSG2(x,&quot;%s%6s: &quot; msg, &bslash;&n;            x==D_NORMAL&t;? KERN_WARNING : &bslash;&n;      x&lt;=D_INIT_REASONS&t;? KERN_INFO    : KERN_DEBUG , &bslash;&n;&t;dev-&gt;name , ## args)
multiline_comment|/* Some useful multiprotocol macros.  The idea here is that GCC will&n; * optimize away multiple tests or assignments to lp-&gt;adev.  Relying on this&n; * results in the cleanest mess possible.&n; */
DECL|macro|ADEV
mdefine_line|#define ADEV lp-&gt;adev
macro_line|#ifdef CONFIG_ARCNET_ETH
DECL|macro|EDEV
mdefine_line|#define EDEV lp-&gt;edev
macro_line|#else
DECL|macro|EDEV
mdefine_line|#define EDEV lp-&gt;adev
macro_line|#endif
macro_line|#ifdef CONFIG_ARCNET_1051
DECL|macro|SDEV
mdefine_line|#define SDEV lp-&gt;sdev
macro_line|#else
DECL|macro|SDEV
mdefine_line|#define SDEV lp-&gt;adev
macro_line|#endif
DECL|macro|TBUSY
mdefine_line|#define TBUSY ADEV-&gt;tbusy=EDEV-&gt;tbusy=SDEV-&gt;tbusy
DECL|macro|IF_TBUSY
mdefine_line|#define IF_TBUSY (ADEV-&gt;tbusy||EDEV-&gt;tbusy||SDEV-&gt;tbusy)
DECL|macro|INTERRUPT
mdefine_line|#define INTERRUPT ADEV-&gt;interrupt=EDEV-&gt;interrupt=SDEV-&gt;interrupt
DECL|macro|IF_INTERRUPT
mdefine_line|#define IF_INTERRUPT (ADEV-&gt;interrupt||EDEV-&gt;interrupt||SDEV-&gt;interrupt)
DECL|macro|START
mdefine_line|#define START ADEV-&gt;start=EDEV-&gt;start=SDEV-&gt;start
multiline_comment|/* The number of low I/O ports used by the ethercard. */
DECL|macro|ARCNET_TOTAL_SIZE
mdefine_line|#define ARCNET_TOTAL_SIZE&t;16
multiline_comment|/* Handy defines for ARCnet specific stuff */
multiline_comment|/* COM 9026 controller chip --&gt; ARCnet register addresses */
DECL|macro|_INTMASK
mdefine_line|#define _INTMASK (ioaddr+0)&t;/* writable */
DECL|macro|_STATUS
mdefine_line|#define _STATUS  (ioaddr+0)&t;/* readable */
DECL|macro|_COMMAND
mdefine_line|#define _COMMAND (ioaddr+1)&t;/* writable, returns random vals on read (?) */
DECL|macro|_RESET
mdefine_line|#define _RESET  (ioaddr+8)&t;/* software reset (on read) */
multiline_comment|/* RIM I (command/status is memory mapped) versus RIM III (standard I/O&n; * mapped) macros.  These make things a bit cleaner.&n; */
macro_line|#ifdef RIM_I_MODE
DECL|macro|IOADDR
mdefine_line|#define IOADDR&t;(dev-&gt;mem_start+0x800)
DECL|macro|ARCSTATUS
mdefine_line|#define ARCSTATUS&t;readb(_STATUS)
DECL|macro|ACOMMAND
mdefine_line|#define ACOMMAND(cmd) writeb((cmd),_COMMAND)
DECL|macro|ARCRESET
mdefine_line|#define ARCRESET&t;writeb(TESTvalue,ioaddr-0x800)&t;/* fake reset */
DECL|macro|AINTMASK
mdefine_line|#define AINTMASK(msk)&t;writeb((msk),_INTMASK)
DECL|macro|RELEASE_REGION
mdefine_line|#define RELEASE_REGION(x,y)&t;/* nothing */
macro_line|#else
DECL|macro|IOADDR
mdefine_line|#define IOADDR&t;(dev-&gt;base_addr)
DECL|macro|ARCSTATUS
mdefine_line|#define ARCSTATUS&t;inb(_STATUS)
DECL|macro|ACOMMAND
mdefine_line|#define ACOMMAND(cmd) outb((cmd),_COMMAND)
DECL|macro|AINTMASK
mdefine_line|#define AINTMASK(msk)&t;outb((msk),_INTMASK)
DECL|macro|ARCRESET
mdefine_line|#define ARCRESET&t;inb(_RESET)
DECL|macro|RELEASE_REGION
mdefine_line|#define RELEASE_REGION(x,y)&t;release_region((x),(y))
macro_line|#endif
DECL|macro|SETMASK
mdefine_line|#define SETMASK AINTMASK(lp-&gt;intmask)
multiline_comment|/* Time needed to reset the card - in jiffies.  This works on my SMC&n;&t; * PC100.  I can&squot;t find a reference that tells me just how long I&n;&t; * should wait.&n;&t; */
DECL|macro|RESETtime
mdefine_line|#define RESETtime (HZ * 3 / 10)&t;&t;/* reset */
multiline_comment|/* these are the max/min lengths of packet data. (including&n;&t; * ClientData header)&n;&t; * note: packet sizes 250, 251, 252 are impossible (God knows why)&n;&t; *  so exception packets become necessary.&n;&t; *&n;&t; * These numbers are compared with the length of the full packet,&n;&t; * including ClientData header.&n;&t; */
DECL|macro|MTU
mdefine_line|#define MTU&t;253&t;/* normal packet max size */
DECL|macro|MinTU
mdefine_line|#define MinTU&t;257&t;/* extended packet min size */
DECL|macro|XMTU
mdefine_line|#define XMTU&t;508&t;/* extended packet max size */
multiline_comment|/* status/interrupt mask bit fields */
DECL|macro|TXFREEflag
mdefine_line|#define TXFREEflag&t;0x01            /* transmitter available */
DECL|macro|TXACKflag
mdefine_line|#define TXACKflag       0x02            /* transmitted msg. ackd */
DECL|macro|RECONflag
mdefine_line|#define RECONflag       0x04            /* system reconfigured */
DECL|macro|TESTflag
mdefine_line|#define TESTflag        0x08            /* test flag */
DECL|macro|RESETflag
mdefine_line|#define RESETflag       0x10            /* power-on-reset */
DECL|macro|RES1flag
mdefine_line|#define RES1flag        0x20            /* reserved - usually set by jumper */
DECL|macro|RES2flag
mdefine_line|#define RES2flag        0x40            /* reserved - usually set by jumper */
DECL|macro|NORXflag
mdefine_line|#define NORXflag        0x80            /* receiver inhibited */
multiline_comment|/* in the command register, the following bits have these meanings:&n;        *                0-2     command&n;        *                3-4     page number (for enable rcv/xmt command)&n;        *                 7      receive broadcasts&n;        */
DECL|macro|NOTXcmd
mdefine_line|#define NOTXcmd         0x01            /* disable transmitter */
DECL|macro|NORXcmd
mdefine_line|#define NORXcmd         0x02            /* disable receiver */
DECL|macro|TXcmd
mdefine_line|#define TXcmd           0x03            /* enable transmitter */
DECL|macro|RXcmd
mdefine_line|#define RXcmd           0x04            /* enable receiver */
DECL|macro|CONFIGcmd
mdefine_line|#define CONFIGcmd       0x05            /* define configuration */
DECL|macro|CFLAGScmd
mdefine_line|#define CFLAGScmd       0x06            /* clear flags */
DECL|macro|TESTcmd
mdefine_line|#define TESTcmd         0x07            /* load test flags */
multiline_comment|/* flags for &quot;clear flags&quot; command */
DECL|macro|RESETclear
mdefine_line|#define RESETclear      0x08            /* power-on-reset */
DECL|macro|CONFIGclear
mdefine_line|#define CONFIGclear     0x10            /* system reconfigured */
multiline_comment|/* flags for &quot;load test flags&quot; command */
DECL|macro|TESTload
mdefine_line|#define TESTload        0x08            /* test flag (diagnostic) */
multiline_comment|/* byte deposited into first address of buffers on reset */
DECL|macro|TESTvalue
mdefine_line|#define TESTvalue       0321&t;&t; /* that&squot;s octal for 0xD1 :) */
multiline_comment|/* for &quot;enable receiver&quot; command */
DECL|macro|RXbcasts
mdefine_line|#define RXbcasts        0x80            /* receive broadcasts */
multiline_comment|/* flags for &quot;define configuration&quot; command */
DECL|macro|NORMALconf
mdefine_line|#define NORMALconf      0x00            /* 1-249 byte packets */
DECL|macro|EXTconf
mdefine_line|#define EXTconf         0x08            /* 250-504 byte packets */
multiline_comment|/* Starts receiving packets into recbuf.&n;&t; */
DECL|macro|EnableReceiver
mdefine_line|#define EnableReceiver()&t;ACOMMAND(RXcmd|(recbuf&lt;&lt;3)|RXbcasts)
multiline_comment|/* RFC1201 Protocol ID&squot;s */
DECL|macro|ARC_P_IP
mdefine_line|#define ARC_P_IP&t;212&t;&t;/* 0xD4 */
DECL|macro|ARC_P_ARP
mdefine_line|#define ARC_P_ARP&t;213&t;&t;/* 0xD5 */
DECL|macro|ARC_P_RARP
mdefine_line|#define ARC_P_RARP&t;214&t;&t;/* 0xD6 */
DECL|macro|ARC_P_IPX
mdefine_line|#define ARC_P_IPX&t;250&t;&t;/* 0xFA */
DECL|macro|ARC_P_NOVELL_EC
mdefine_line|#define ARC_P_NOVELL_EC&t;236&t;&t;/* 0xEC */
multiline_comment|/* Old RFC1051 Protocol ID&squot;s */
DECL|macro|ARC_P_IP_RFC1051
mdefine_line|#define ARC_P_IP_RFC1051 240&t;&t;/* 0xF0 */
DECL|macro|ARC_P_ARP_RFC1051
mdefine_line|#define ARC_P_ARP_RFC1051 241&t;&t;/* 0xF1 */
multiline_comment|/* MS LanMan/WfWg protocol */
DECL|macro|ARC_P_ETHER
mdefine_line|#define ARC_P_ETHER&t;0xE8
multiline_comment|/* Unsupported/indirectly supported protocols */
DECL|macro|ARC_P_DATAPOINT_BOOT
mdefine_line|#define ARC_P_DATAPOINT_BOOT&t;0&t;/* very old Datapoint equipment */
DECL|macro|ARC_P_DATAPOINT_MOUNT
mdefine_line|#define ARC_P_DATAPOINT_MOUNT&t;1
DECL|macro|ARC_P_POWERLAN_BEACON
mdefine_line|#define ARC_P_POWERLAN_BEACON&t;8&t;/* Probably ATA-Netbios related */
DECL|macro|ARC_P_POWERLAN_BEACON2
mdefine_line|#define ARC_P_POWERLAN_BEACON2&t;243
DECL|macro|ARC_P_LANSOFT
mdefine_line|#define ARC_P_LANSOFT&t;251&t;&t;/* 0xFB - what is this? */
DECL|macro|ARC_P_ATALK
mdefine_line|#define ARC_P_ATALK&t;0xDD
multiline_comment|/* the header required by the card itself */
DECL|struct|HardHeader
r_struct
id|HardHeader
(brace
DECL|member|source
id|u_char
id|source
comma
multiline_comment|/* source ARCnet - filled in automagically */
DECL|member|destination
id|destination
comma
multiline_comment|/* destination ARCnet - 0 for broadcast */
DECL|member|offset1
id|offset1
comma
multiline_comment|/* offset of ClientData (256-byte packets) */
DECL|member|offset2
id|offset2
suffix:semicolon
multiline_comment|/* offset of ClientData (512-byte packets) */
)brace
suffix:semicolon
multiline_comment|/* a complete ARCnet packet */
DECL|union|ArcPacket
r_union
id|ArcPacket
(brace
DECL|member|hardheader
r_struct
id|HardHeader
id|hardheader
suffix:semicolon
multiline_comment|/* the hardware header */
DECL|member|raw
id|u_char
id|raw
(braket
l_int|512
)braket
suffix:semicolon
multiline_comment|/* raw packet info, incl ClientData */
)brace
suffix:semicolon
multiline_comment|/* the &quot;client data&quot; header - RFC1201 information&n;&t; * notice that this screws up if it&squot;s not an even number of bytes&n;&t; * &lt;sigh&gt;&n;&t; */
DECL|struct|ClientData
r_struct
id|ClientData
(brace
multiline_comment|/* data that&squot;s NOT part of real packet - we MUST get rid of it before&n;&t; * actually sending!!&n;&t; */
DECL|member|saddr
id|u_char
id|saddr
comma
multiline_comment|/* Source address - needed for IPX */
DECL|member|daddr
id|daddr
suffix:semicolon
multiline_comment|/* Destination address */
multiline_comment|/* data that IS part of real packet */
DECL|member|protocol_id
id|u_char
id|protocol_id
comma
multiline_comment|/* ARC_P_IP, ARC_P_ARP, etc */
DECL|member|split_flag
id|split_flag
suffix:semicolon
multiline_comment|/* for use with split packets */
DECL|member|sequence
id|u_short
id|sequence
suffix:semicolon
multiline_comment|/* sequence number */
)brace
suffix:semicolon
DECL|macro|EXTRA_CLIENTDATA
mdefine_line|#define EXTRA_CLIENTDATA (sizeof(struct ClientData)-4)
multiline_comment|/* the &quot;client data&quot; header - RFC1051 information&n;&t; * this also screws up if it&squot;s not an even number of bytes&n;&t; * &lt;sigh again&gt;&n;&t; */
DECL|struct|S_ClientData
r_struct
id|S_ClientData
(brace
multiline_comment|/* data that&squot;s NOT part of real packet - we MUST get rid of it before&n;&t; * actually sending!!&n;&t; */
DECL|member|saddr
id|u_char
id|saddr
comma
multiline_comment|/* Source address - needed for IPX */
DECL|member|daddr
id|daddr
comma
multiline_comment|/* Destination address */
DECL|member|junk
id|junk
suffix:semicolon
multiline_comment|/* padding to make an even length */
multiline_comment|/* data that IS part of real packet */
DECL|member|protocol_id
id|u_char
id|protocol_id
suffix:semicolon
multiline_comment|/* ARC_P_IP, ARC_P_ARP, etc */
)brace
suffix:semicolon
DECL|macro|S_EXTRA_CLIENTDATA
mdefine_line|#define S_EXTRA_CLIENTDATA (sizeof(struct S_ClientData)-1)
multiline_comment|/* &quot;Incoming&quot; is information needed for each address that could be sending&n; * to us.  Mostly for partially-received split packets.&n; */
DECL|struct|Incoming
r_struct
id|Incoming
(brace
DECL|member|skb
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
multiline_comment|/* packet data buffer             */
DECL|member|lastpacket
r_int
r_char
id|lastpacket
comma
multiline_comment|/* number of last packet (from 1) */
DECL|member|numpackets
id|numpackets
suffix:semicolon
multiline_comment|/* number of packets in split     */
DECL|member|sequence
id|u_short
id|sequence
suffix:semicolon
multiline_comment|/* sequence number of assembly&t;  */
)brace
suffix:semicolon
DECL|struct|Outgoing
r_struct
id|Outgoing
(brace
DECL|member|skb
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
multiline_comment|/* buffer from upper levels */
DECL|member|hdr
r_struct
id|ClientData
op_star
id|hdr
suffix:semicolon
multiline_comment|/* clientdata of last packet */
DECL|member|data
id|u_char
op_star
id|data
suffix:semicolon
multiline_comment|/* pointer to data in packet */
DECL|member|length
r_int
id|length
comma
multiline_comment|/* bytes total */
DECL|member|dataleft
id|dataleft
comma
multiline_comment|/* bytes left */
DECL|member|segnum
id|segnum
comma
multiline_comment|/* segment being sent */
DECL|member|numsegs
id|numsegs
comma
multiline_comment|/* number of segments */
DECL|member|seglen
id|seglen
suffix:semicolon
multiline_comment|/* length of segment */
)brace
suffix:semicolon
multiline_comment|/* Information that needs to be kept for each board. */
DECL|struct|arcnet_local
r_struct
id|arcnet_local
(brace
DECL|member|stats
r_struct
id|net_device_stats
id|stats
suffix:semicolon
DECL|member|sequence
id|u_short
id|sequence
suffix:semicolon
multiline_comment|/* sequence number (incs with each packet) */
DECL|member|stationid
id|u_char
id|stationid
comma
multiline_comment|/* our 8-bit station address */
DECL|member|recbuf
id|recbuf
comma
multiline_comment|/* receive buffer # (0 or 1) */
DECL|member|txbuf
id|txbuf
comma
multiline_comment|/* transmit buffer # (2 or 3) */
DECL|member|txready
id|txready
comma
multiline_comment|/* buffer where a packet is ready to send */
DECL|member|intmask
id|intmask
suffix:semicolon
multiline_comment|/* current value of INTMASK register */
DECL|member|intx
r_int
id|intx
comma
multiline_comment|/* in TX routine? */
DECL|member|in_txhandler
id|in_txhandler
comma
multiline_comment|/* in TX_IRQ handler? */
DECL|member|sending
id|sending
comma
multiline_comment|/* transmit in progress? */
DECL|member|lastload_dest
id|lastload_dest
comma
multiline_comment|/* can last loaded packet be acked? */
DECL|member|lasttrans_dest
id|lasttrans_dest
suffix:semicolon
multiline_comment|/* can last TX&squot;d packet be acked? */
macro_line|#if defined(DETECT_RECONFIGS) &amp;&amp; defined(RECON_THRESHOLD)
DECL|member|first_recon
id|time_t
id|first_recon
comma
multiline_comment|/* time of &quot;first&quot; RECON message to count */
DECL|member|last_recon
id|last_recon
suffix:semicolon
multiline_comment|/* time of most recent RECON */
DECL|member|num_recons
r_int
id|num_recons
comma
multiline_comment|/* number of RECONs between first and last. */
DECL|member|network_down
id|network_down
suffix:semicolon
multiline_comment|/* do we think the network is down? */
macro_line|#endif
DECL|member|timer
r_struct
id|timer_list
id|timer
suffix:semicolon
multiline_comment|/* the timer interrupt struct */
DECL|member|incoming
r_struct
id|Incoming
id|incoming
(braket
l_int|256
)braket
suffix:semicolon
multiline_comment|/* one from each address */
DECL|member|outgoing
r_struct
id|Outgoing
id|outgoing
suffix:semicolon
multiline_comment|/* packet currently being sent */
DECL|member|adev
r_struct
id|device
op_star
id|adev
suffix:semicolon
multiline_comment|/* RFC1201 protocol device */
macro_line|#ifdef CONFIG_ARCNET_ETH
DECL|member|edev
r_struct
id|device
op_star
id|edev
suffix:semicolon
multiline_comment|/* Ethernet-Encap device */
macro_line|#endif
macro_line|#ifdef CONFIG_ARCNET_1051
DECL|member|sdev
r_struct
id|device
op_star
id|sdev
suffix:semicolon
multiline_comment|/* RFC1051 protocol device */
macro_line|#endif
)brace
suffix:semicolon
multiline_comment|/* Index to functions, as function prototypes. */
macro_line|#if ARCNET_DEBUG_MAX &amp; D_SKB
r_static
r_void
id|arcnet_dump_skb
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
r_struct
id|sk_buff
op_star
id|skb
comma
r_char
op_star
id|desc
)paren
suffix:semicolon
macro_line|#else
DECL|macro|arcnet_dump_skb
macro_line|#&t;define arcnet_dump_skb(dev,skb,desc) ;
macro_line|#endif
macro_line|#if (ARCNET_DEBUG_MAX &amp; D_RX) || (ARCNET_DEBUG_MAX &amp; D_TX)
r_static
r_void
id|arcnet_dump_packet
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
id|u_char
op_star
id|buffer
comma
r_int
id|ext
comma
r_char
op_star
id|desc
)paren
suffix:semicolon
macro_line|#else
DECL|macro|arcnet_dump_packet
macro_line|#&t;define arcnet_dump_packet(dev,buffer,ext,desc) ;
macro_line|#endif
r_extern
r_int
id|arcnet_probe
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_int
id|arcnet_found
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
r_int
id|port
comma
r_int
id|airq
comma
id|u_long
id|shmem
)paren
suffix:semicolon
r_static
r_void
id|arcnet_setup
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_int
id|arcnet_open
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_int
id|arcnet_close
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_int
id|arcnet_reset
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
r_int
id|reset_delay
)paren
suffix:semicolon
r_static
r_int
id|arcnet_send_packet_bad
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_int
id|arcnetA_send_packet
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_void
id|arcnetA_continue_tx
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_void
id|arcnetAS_prepare_tx
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
id|u_char
op_star
id|hdr
comma
r_int
id|hdrlen
comma
r_char
op_star
id|data
comma
r_int
id|length
comma
r_int
id|daddr
comma
r_int
id|exceptA
)paren
suffix:semicolon
r_static
r_int
id|arcnet_go_tx
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
r_int
id|enable_irq
)paren
suffix:semicolon
r_static
r_void
id|arcnet_interrupt
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
suffix:semicolon
r_static
r_void
id|arcnet_inthandler
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_void
id|arcnet_rx
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
r_int
id|recbuf
)paren
suffix:semicolon
r_static
r_void
id|arcnetA_rx
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
id|u_char
op_star
id|buf
comma
r_int
id|length
comma
id|u_char
id|saddr
comma
id|u_char
id|daddr
)paren
suffix:semicolon
r_static
r_struct
id|net_device_stats
op_star
id|arcnet_get_stats
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
suffix:semicolon
r_int
id|arcnetA_header
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|device
op_star
id|dev
comma
r_int
r_int
id|type
comma
r_void
op_star
id|daddr
comma
r_void
op_star
id|saddr
comma
r_int
id|len
)paren
suffix:semicolon
r_int
id|arcnetA_rebuild_header
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
)paren
suffix:semicolon
r_int
r_int
id|arcnetA_type_trans
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|device
op_star
id|dev
)paren
suffix:semicolon
macro_line|#ifdef CONFIG_ARCNET_ETH
multiline_comment|/* functions specific to Ethernet-Encap */
r_static
r_int
id|arcnetE_init
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_int
id|arcnetE_open_close
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_int
id|arcnetE_send_packet
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_void
id|arcnetE_rx
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
id|u_char
op_star
id|arcsoft
comma
r_int
id|length
comma
id|u_char
id|saddr
comma
id|u_char
id|daddr
)paren
suffix:semicolon
macro_line|#endif
macro_line|#ifdef CONFIG_ARCNET_1051
multiline_comment|/* functions specific to RFC1051 */
r_static
r_int
id|arcnetS_init
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_int
id|arcnetS_open_close
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_int
id|arcnetS_send_packet
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_void
id|arcnetS_rx
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
id|u_char
op_star
id|buf
comma
r_int
id|length
comma
id|u_char
id|saddr
comma
id|u_char
id|daddr
)paren
suffix:semicolon
r_int
id|arcnetS_header
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|device
op_star
id|dev
comma
r_int
r_int
id|type
comma
r_void
op_star
id|daddr
comma
r_void
op_star
id|saddr
comma
r_int
id|len
)paren
suffix:semicolon
r_int
id|arcnetS_rebuild_header
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
)paren
suffix:semicolon
r_int
r_int
id|arcnetS_type_trans
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|device
op_star
id|dev
)paren
suffix:semicolon
macro_line|#endif
macro_line|#ifdef MODULE
r_int
id|init_module
c_func
(paren
r_void
)paren
suffix:semicolon
r_void
id|cleanup_module
c_func
(paren
r_void
)paren
suffix:semicolon
macro_line|#endif
DECL|macro|tx_done
mdefine_line|#define tx_done(dev) 1
DECL|macro|JIFFER
mdefine_line|#define JIFFER(time) for (delayval=jiffies+time; jiffies&lt;delayval;) ;
multiline_comment|/****************************************************************************&n; *                                                                          *&n; * Packet dumps for debugging                                               *&n; *                                                                          *&n; ****************************************************************************/
multiline_comment|/* Dump the contents of an sk_buff&n; */
macro_line|#if ARCNET_DEBUG_MAX &amp; D_SKB
DECL|function|arcnet_dump_skb
r_void
id|arcnet_dump_skb
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
r_struct
id|sk_buff
op_star
id|skb
comma
r_char
op_star
id|desc
)paren
(brace
r_int
id|i
suffix:semicolon
r_int
id|flags
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%6s: skb dump (%s) follows:&quot;
comma
id|dev-&gt;name
comma
id|desc
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|skb-&gt;len
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|i
op_mod
l_int|16
op_eq
l_int|0
)paren
id|printk
c_func
(paren
l_string|&quot;&bslash;n&quot;
id|KERN_DEBUG
l_string|&quot;[%04X] &quot;
comma
id|i
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;%02X &quot;
comma
(paren
(paren
id|u_char
op_star
)paren
id|skb-&gt;data
)paren
(braket
id|i
)braket
)paren
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
macro_line|#endif
multiline_comment|/* Dump the contents of an ARCnet buffer&n; */
macro_line|#if (ARCNET_DEBUG_MAX &amp; D_RX) || (ARCNET_DEBUG_MAX &amp; D_TX)
DECL|function|arcnet_dump_packet
r_void
id|arcnet_dump_packet
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
id|u_char
op_star
id|buffer
comma
r_int
id|ext
comma
r_char
op_star
id|desc
)paren
(brace
r_int
id|i
suffix:semicolon
r_int
id|flags
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%6s: packet dump (%s) follows:&quot;
comma
id|dev-&gt;name
comma
id|desc
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|256
op_plus
(paren
id|ext
op_ne
l_int|0
)paren
op_star
l_int|256
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|i
op_mod
l_int|16
op_eq
l_int|0
)paren
id|printk
c_func
(paren
l_string|&quot;&bslash;n&quot;
id|KERN_DEBUG
l_string|&quot;[%04X] &quot;
comma
id|i
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;%02X &quot;
comma
id|buffer
(braket
id|i
)braket
)paren
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
macro_line|#endif
multiline_comment|/****************************************************************************&n; *                                                                          *&n; * Probe and initialization                                                 *&n; *                                                                          *&n; ****************************************************************************/
macro_line|#ifdef RIM_I_MODE
multiline_comment|/* We cannot probe for a RIM I card; one reason is I don&squot;t know how to reset&n; * them.  In fact, we can&squot;t even get their node ID automatically.  So, we&n; * need to be passed a specific shmem address, IRQ, and node ID (stored in&n; * dev-&gt;base_addr)&n; */
DECL|function|arcnet_probe
r_int
id|arcnet_probe
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
id|BUGLVL
c_func
(paren
id|D_NORMAL
)paren
id|printk
c_func
(paren
id|version
)paren
suffix:semicolon
id|BUGMSG
c_func
(paren
id|D_NORMAL
comma
l_string|&quot;Compiled for ARCnet RIM I (autoprobe disabled)&bslash;n&quot;
)paren
suffix:semicolon
id|BUGMSG
c_func
(paren
id|D_NORMAL
comma
l_string|&quot;Given: node %02lXh, shmem %lXh, irq %d&bslash;n&quot;
comma
id|dev-&gt;base_addr
comma
id|dev-&gt;mem_start
comma
id|dev-&gt;irq
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;mem_start
op_le
l_int|0
op_logical_or
id|dev-&gt;irq
op_le
l_int|0
)paren
(brace
id|BUGMSG
c_func
(paren
id|D_NORMAL
comma
l_string|&quot;No autoprobe for RIM I; you &quot;
l_string|&quot;must specify the shmem and irq!&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
r_if
c_cond
(paren
id|dev-&gt;base_addr
op_le
l_int|0
op_logical_or
id|dev-&gt;base_addr
OG
l_int|255
)paren
(brace
id|BUGMSG
c_func
(paren
id|D_NORMAL
comma
l_string|&quot;You need to specify your card&squot;s station &quot;
l_string|&quot;ID!&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
r_return
id|arcnet_found
c_func
(paren
id|dev
comma
id|dev-&gt;base_addr
comma
id|dev-&gt;irq
comma
id|dev-&gt;mem_start
)paren
suffix:semicolon
)brace
macro_line|#else /* not RIM_I_MODE, so use a real autoprobe */
multiline_comment|/* Check for an ARCnet network adaptor, and return &squot;0&squot; if one exists.&n; *  If dev-&gt;base_addr == 0, probe all likely locations.&n; *  If dev-&gt;base_addr == 1, always return failure.&n; *  If dev-&gt;base_addr == 2, allocate space for the device and return success&n; *  &t;&t;&t;    (detachable devices only).&n; *&n; * NOTE: the list of possible ports/shmems is static, so it is retained&n; * across calls to arcnet_probe.  So, if more than one ARCnet probe is made,&n; * values that were discarded once will not even be tried again.&n; *&n; * FIXME: grab all devices in one shot and eliminate the big static array.&n; */
DECL|function|arcnet_probe
r_int
id|arcnet_probe
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
r_static
r_int
id|init_once
op_assign
l_int|0
suffix:semicolon
r_static
r_int
id|ports
(braket
(paren
l_int|0x3f0
op_minus
l_int|0x200
)paren
op_div
l_int|16
op_plus
l_int|1
)braket
suffix:semicolon
r_static
id|u_long
id|shmems
(braket
(paren
l_int|0xFF800
op_minus
l_int|0xA0000
)paren
op_div
l_int|2048
op_plus
l_int|1
)braket
suffix:semicolon
r_static
r_int
id|numports
op_assign
r_sizeof
(paren
id|ports
)paren
op_div
r_sizeof
(paren
id|ports
(braket
l_int|0
)braket
)paren
comma
id|numshmems
op_assign
r_sizeof
(paren
id|shmems
)paren
op_div
r_sizeof
(paren
id|shmems
(braket
l_int|0
)braket
)paren
suffix:semicolon
r_int
id|count
comma
id|status
comma
id|delayval
comma
id|ioaddr
comma
id|numprint
comma
id|airq
comma
id|retval
op_assign
op_minus
id|ENODEV
comma
id|openparen
op_assign
l_int|0
suffix:semicolon
r_int
r_int
id|airqmask
suffix:semicolon
r_int
op_star
id|port
suffix:semicolon
id|u_long
op_star
id|shmem
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|init_once
)paren
(brace
r_for
c_loop
(paren
id|count
op_assign
l_int|0x200
suffix:semicolon
id|count
op_le
l_int|0x3f0
suffix:semicolon
id|count
op_add_assign
l_int|16
)paren
id|ports
(braket
(paren
id|count
op_minus
l_int|0x200
)paren
op_div
l_int|16
)braket
op_assign
id|count
suffix:semicolon
r_for
c_loop
(paren
id|count
op_assign
l_int|0xA0000
suffix:semicolon
id|count
op_le
l_int|0xFF800
suffix:semicolon
id|count
op_add_assign
l_int|2048
)paren
id|shmems
(braket
(paren
id|count
op_minus
l_int|0xA0000
)paren
op_div
l_int|2048
)braket
op_assign
id|count
suffix:semicolon
id|init_once
op_assign
l_int|1
suffix:semicolon
)brace
id|BUGLVL
c_func
(paren
id|D_NORMAL
)paren
id|printk
c_func
(paren
id|version
)paren
suffix:semicolon
id|BUGMSG
c_func
(paren
id|D_DURING
comma
l_string|&quot;space used for probe buffers: %d+%d=%d bytes&bslash;n&quot;
comma
r_sizeof
(paren
id|ports
)paren
comma
r_sizeof
(paren
id|shmems
)paren
comma
r_sizeof
(paren
id|ports
)paren
op_plus
r_sizeof
(paren
id|shmems
)paren
)paren
suffix:semicolon
macro_line|#if 1
id|BUGLVL
c_func
(paren
id|D_EXTRA
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;arcnet: ***&bslash;n&quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;arcnet: * Read arcnet.txt for important release notes!&bslash;n&quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;arcnet: *&bslash;n&quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;arcnet: * This is an ALPHA version!  (Last stable release: v2.56)  E-mail me if&bslash;n&quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;arcnet: * you have any questions, comments, or bug reports.&bslash;n&quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;arcnet: ***&bslash;n&quot;
)paren
suffix:semicolon
)brace
macro_line|#endif
id|BUGMSG
c_func
(paren
id|D_INIT
comma
l_string|&quot;given: base %lXh, IRQ %d, shmem %lXh&bslash;n&quot;
comma
id|dev-&gt;base_addr
comma
id|dev-&gt;irq
comma
id|dev-&gt;mem_start
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;base_addr
OG
l_int|0x1ff
)paren
multiline_comment|/* Check a single specified port */
(brace
id|ports
(braket
l_int|0
)braket
op_assign
id|dev-&gt;base_addr
suffix:semicolon
id|numports
op_assign
l_int|1
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|dev-&gt;base_addr
OG
l_int|0
)paren
multiline_comment|/* Don&squot;t probe at all. */
r_return
op_minus
id|ENXIO
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;mem_start
)paren
(brace
id|shmems
(braket
l_int|0
)braket
op_assign
id|dev-&gt;mem_start
suffix:semicolon
id|numshmems
op_assign
l_int|1
suffix:semicolon
)brace
multiline_comment|/* Stage 1: abandon any reserved ports, or ones with status==0xFF&n;&t; * (empty), and reset any others by reading the reset port.&n;&t; */
id|BUGMSG
c_func
(paren
id|D_INIT
comma
l_string|&quot;Stage 1: &quot;
)paren
suffix:semicolon
id|numprint
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|port
op_assign
op_amp
id|ports
(braket
l_int|0
)braket
suffix:semicolon
id|port
op_minus
id|ports
OL
id|numports
suffix:semicolon
id|port
op_increment
)paren
(brace
id|numprint
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|numprint
OG
l_int|8
)paren
(brace
id|BUGMSG2
c_func
(paren
id|D_INIT
comma
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
id|BUGMSG
c_func
(paren
id|D_INIT
comma
l_string|&quot;Stage 1: &quot;
)paren
suffix:semicolon
id|numprint
op_assign
l_int|1
suffix:semicolon
)brace
id|BUGMSG2
c_func
(paren
id|D_INIT
comma
l_string|&quot;%Xh &quot;
comma
op_star
id|port
)paren
suffix:semicolon
id|ioaddr
op_assign
op_star
id|port
suffix:semicolon
r_if
c_cond
(paren
id|check_region
c_func
(paren
op_star
id|port
comma
id|ARCNET_TOTAL_SIZE
)paren
)paren
(brace
id|BUGMSG2
c_func
(paren
id|D_INIT_REASONS
comma
l_string|&quot;(check_region)&bslash;n&quot;
)paren
suffix:semicolon
id|BUGMSG
c_func
(paren
id|D_INIT_REASONS
comma
l_string|&quot;Stage 1: &quot;
)paren
suffix:semicolon
id|BUGLVL
c_func
(paren
id|D_INIT_REASONS
)paren
id|numprint
op_assign
l_int|0
suffix:semicolon
op_star
id|port
op_assign
id|ports
(braket
id|numports
op_minus
l_int|1
)braket
suffix:semicolon
id|numports
op_decrement
suffix:semicolon
id|port
op_decrement
suffix:semicolon
r_continue
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ARCSTATUS
op_eq
l_int|0xFF
)paren
(brace
id|BUGMSG2
c_func
(paren
id|D_INIT_REASONS
comma
l_string|&quot;(empty)&bslash;n&quot;
)paren
suffix:semicolon
id|BUGMSG
c_func
(paren
id|D_INIT_REASONS
comma
l_string|&quot;Stage 1: &quot;
)paren
suffix:semicolon
id|BUGLVL
c_func
(paren
id|D_INIT_REASONS
)paren
id|numprint
op_assign
l_int|0
suffix:semicolon
op_star
id|port
op_assign
id|ports
(braket
id|numports
op_minus
l_int|1
)braket
suffix:semicolon
id|numports
op_decrement
suffix:semicolon
id|port
op_decrement
suffix:semicolon
r_continue
suffix:semicolon
)brace
id|ARCRESET
suffix:semicolon
multiline_comment|/* begin resetting card */
id|BUGMSG2
c_func
(paren
id|D_INIT_REASONS
comma
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
id|BUGMSG
c_func
(paren
id|D_INIT_REASONS
comma
l_string|&quot;Stage 1: &quot;
)paren
suffix:semicolon
id|BUGLVL
c_func
(paren
id|D_INIT_REASONS
)paren
id|numprint
op_assign
l_int|0
suffix:semicolon
)brace
id|BUGMSG2
c_func
(paren
id|D_INIT
comma
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|numports
)paren
(brace
id|BUGMSG
c_func
(paren
id|D_NORMAL
comma
l_string|&quot;Stage 1: No ARCnet cards found.&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
multiline_comment|/* Stage 2: we have now reset any possible ARCnet cards, so we can&squot;t&n;&t; * do anything until they finish.  If D_INIT, print the list of&n;&t; * cards that are left.&n;&t; */
id|BUGMSG
c_func
(paren
id|D_INIT
comma
l_string|&quot;Stage 2: &quot;
)paren
suffix:semicolon
id|numprint
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|port
op_assign
op_amp
id|ports
(braket
l_int|0
)braket
suffix:semicolon
id|port
op_minus
id|ports
OL
id|numports
suffix:semicolon
id|port
op_increment
)paren
(brace
id|numprint
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|numprint
OG
l_int|8
)paren
(brace
id|BUGMSG2
c_func
(paren
id|D_INIT
comma
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
id|BUGMSG
c_func
(paren
id|D_INIT
comma
l_string|&quot;Stage 2: &quot;
)paren
suffix:semicolon
id|numprint
op_assign
l_int|1
suffix:semicolon
)brace
id|BUGMSG2
c_func
(paren
id|D_INIT
comma
l_string|&quot;%Xh &quot;
comma
op_star
id|port
)paren
suffix:semicolon
)brace
id|BUGMSG2
c_func
(paren
id|D_INIT
comma
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
id|JIFFER
c_func
(paren
id|RESETtime
)paren
suffix:semicolon
multiline_comment|/* Stage 3: abandon any shmem addresses that don&squot;t have the signature&n;&t; * 0xD1 byte in the right place, or are read-only.&n;&t; */
id|BUGMSG
c_func
(paren
id|D_INIT
comma
l_string|&quot;Stage 3: &quot;
)paren
suffix:semicolon
id|numprint
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|shmem
op_assign
op_amp
id|shmems
(braket
l_int|0
)braket
suffix:semicolon
id|shmem
op_minus
id|shmems
OL
id|numshmems
suffix:semicolon
id|shmem
op_increment
)paren
(brace
id|u_long
id|ptr
suffix:semicolon
id|numprint
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|numprint
OG
l_int|8
)paren
(brace
id|BUGMSG2
c_func
(paren
id|D_INIT
comma
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
id|BUGMSG
c_func
(paren
id|D_INIT
comma
l_string|&quot;Stage 3: &quot;
)paren
suffix:semicolon
id|numprint
op_assign
l_int|1
suffix:semicolon
)brace
id|BUGMSG2
c_func
(paren
id|D_INIT
comma
l_string|&quot;%lXh &quot;
comma
op_star
id|shmem
)paren
suffix:semicolon
id|ptr
op_assign
(paren
id|u_long
)paren
(paren
op_star
id|shmem
)paren
suffix:semicolon
r_if
c_cond
(paren
id|readb
c_func
(paren
id|ptr
)paren
op_ne
id|TESTvalue
)paren
(brace
id|BUGMSG2
c_func
(paren
id|D_INIT_REASONS
comma
l_string|&quot;(mem=%02Xh, not %02Xh)&bslash;n&quot;
comma
id|readb
c_func
(paren
id|ptr
)paren
comma
id|TESTvalue
)paren
suffix:semicolon
id|BUGMSG
c_func
(paren
id|D_INIT_REASONS
comma
l_string|&quot;Stage 3: &quot;
)paren
suffix:semicolon
id|BUGLVL
c_func
(paren
id|D_INIT_REASONS
)paren
id|numprint
op_assign
l_int|0
suffix:semicolon
op_star
id|shmem
op_assign
id|shmems
(braket
id|numshmems
op_minus
l_int|1
)braket
suffix:semicolon
id|numshmems
op_decrement
suffix:semicolon
id|shmem
op_decrement
suffix:semicolon
r_continue
suffix:semicolon
)brace
multiline_comment|/* By writing 0x42 to the TESTvalue location, we also make&n;&t;&t; * sure no &quot;mirror&quot; shmem areas show up - if they occur&n;&t;&t; * in another pass through this loop, they will be discarded&n;&t;&t; * because *cptr != TESTvalue.&n;&t;&t; */
id|writeb
c_func
(paren
l_int|0x42
comma
id|ptr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|readb
c_func
(paren
id|ptr
)paren
op_ne
l_int|0x42
)paren
(brace
id|BUGMSG2
c_func
(paren
id|D_INIT_REASONS
comma
l_string|&quot;(read only)&bslash;n&quot;
)paren
suffix:semicolon
id|BUGMSG
c_func
(paren
id|D_INIT_REASONS
comma
l_string|&quot;Stage 3: &quot;
)paren
suffix:semicolon
op_star
id|shmem
op_assign
id|shmems
(braket
id|numshmems
op_minus
l_int|1
)braket
suffix:semicolon
id|numshmems
op_decrement
suffix:semicolon
id|shmem
op_decrement
suffix:semicolon
r_continue
suffix:semicolon
)brace
id|BUGMSG2
c_func
(paren
id|D_INIT_REASONS
comma
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
id|BUGMSG
c_func
(paren
id|D_INIT_REASONS
comma
l_string|&quot;Stage 3: &quot;
)paren
suffix:semicolon
id|BUGLVL
c_func
(paren
id|D_INIT_REASONS
)paren
id|numprint
op_assign
l_int|0
suffix:semicolon
)brace
id|BUGMSG2
c_func
(paren
id|D_INIT
comma
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|numshmems
)paren
(brace
id|BUGMSG
c_func
(paren
id|D_NORMAL
comma
l_string|&quot;Stage 3: No ARCnet cards found.&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
multiline_comment|/* Stage 4: something of a dummy, to report the shmems that are&n;&t; * still possible after stage 3.&n;&t; */
id|BUGMSG
c_func
(paren
id|D_INIT
comma
l_string|&quot;Stage 4: &quot;
)paren
suffix:semicolon
id|numprint
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|shmem
op_assign
op_amp
id|shmems
(braket
l_int|0
)braket
suffix:semicolon
id|shmem
op_minus
id|shmems
OL
id|numshmems
suffix:semicolon
id|shmem
op_increment
)paren
(brace
id|numprint
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|numprint
OG
l_int|8
)paren
(brace
id|BUGMSG2
c_func
(paren
id|D_INIT
comma
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
id|BUGMSG
c_func
(paren
id|D_INIT
comma
l_string|&quot;Stage 4: &quot;
)paren
suffix:semicolon
id|numprint
op_assign
l_int|1
suffix:semicolon
)brace
id|BUGMSG2
c_func
(paren
id|D_INIT
comma
l_string|&quot;%lXh &quot;
comma
op_star
id|shmem
)paren
suffix:semicolon
)brace
id|BUGMSG2
c_func
(paren
id|D_INIT
comma
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* Stage 5: for any ports that have the correct status, can disable&n;&t; * the RESET flag, and (if no irq is given) generate an autoirq,&n;&t; * register an ARCnet device.&n;&t; *&n;&t; * Currently, we can only register one device per probe, so quit&n;&t; * after the first one is found.&n;&t; */
id|BUGMSG
c_func
(paren
id|D_INIT
comma
l_string|&quot;Stage 5: &quot;
)paren
suffix:semicolon
id|numprint
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|port
op_assign
op_amp
id|ports
(braket
l_int|0
)braket
suffix:semicolon
id|port
op_minus
id|ports
OL
id|numports
suffix:semicolon
id|port
op_increment
)paren
(brace
id|numprint
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|numprint
OG
l_int|8
)paren
(brace
id|BUGMSG2
c_func
(paren
id|D_INIT
comma
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
id|BUGMSG
c_func
(paren
id|D_INIT
comma
l_string|&quot;Stage 5: &quot;
)paren
suffix:semicolon
id|numprint
op_assign
l_int|1
suffix:semicolon
)brace
id|BUGMSG2
c_func
(paren
id|D_INIT
comma
l_string|&quot;%Xh &quot;
comma
op_star
id|port
)paren
suffix:semicolon
id|ioaddr
op_assign
op_star
id|port
suffix:semicolon
id|status
op_assign
id|ARCSTATUS
suffix:semicolon
r_if
c_cond
(paren
(paren
id|status
op_amp
l_int|0x9D
)paren
op_ne
(paren
id|NORXflag
op_or
id|RECONflag
op_or
id|TXFREEflag
op_or
id|RESETflag
)paren
)paren
(brace
id|BUGMSG2
c_func
(paren
id|D_INIT_REASONS
comma
l_string|&quot;(status=%Xh)&bslash;n&quot;
comma
id|status
)paren
suffix:semicolon
id|BUGMSG
c_func
(paren
id|D_INIT_REASONS
comma
l_string|&quot;Stage 5: &quot;
)paren
suffix:semicolon
id|BUGLVL
c_func
(paren
id|D_INIT_REASONS
)paren
id|numprint
op_assign
l_int|0
suffix:semicolon
op_star
id|port
op_assign
id|ports
(braket
id|numports
op_minus
l_int|1
)braket
suffix:semicolon
id|numports
op_decrement
suffix:semicolon
id|port
op_decrement
suffix:semicolon
r_continue
suffix:semicolon
)brace
id|ACOMMAND
c_func
(paren
id|CFLAGScmd
op_or
id|RESETclear
op_or
id|CONFIGclear
)paren
suffix:semicolon
id|status
op_assign
id|ARCSTATUS
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
id|RESETflag
)paren
(brace
id|BUGMSG2
c_func
(paren
id|D_INIT_REASONS
comma
l_string|&quot; (eternal reset, status=%Xh)&bslash;n&quot;
comma
id|status
)paren
suffix:semicolon
id|BUGMSG
c_func
(paren
id|D_INIT_REASONS
comma
l_string|&quot;Stage 5: &quot;
)paren
suffix:semicolon
id|BUGLVL
c_func
(paren
id|D_INIT_REASONS
)paren
id|numprint
op_assign
l_int|0
suffix:semicolon
op_star
id|port
op_assign
id|ports
(braket
id|numports
op_minus
l_int|1
)braket
suffix:semicolon
id|numports
op_decrement
suffix:semicolon
id|port
op_decrement
suffix:semicolon
r_continue
suffix:semicolon
)brace
multiline_comment|/* skip this completely if an IRQ was given, because maybe&n;&t;&t; * we&squot;re on a machine that locks during autoirq!&n;&t;&t; */
r_if
c_cond
(paren
op_logical_neg
id|dev-&gt;irq
)paren
(brace
multiline_comment|/* if we do this, we&squot;re sure to get an IRQ since the&n;&t;&t;&t; * card has just reset and the NORXflag is on until&n;&t;&t;&t; * we tell it to start receiving.&n;&t;&t;&t; */
id|airqmask
op_assign
id|probe_irq_on
c_func
(paren
)paren
suffix:semicolon
id|AINTMASK
c_func
(paren
id|NORXflag
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|1
)paren
suffix:semicolon
id|AINTMASK
c_func
(paren
l_int|0
)paren
suffix:semicolon
id|airq
op_assign
id|probe_irq_off
c_func
(paren
id|airqmask
)paren
suffix:semicolon
r_if
c_cond
(paren
id|airq
op_le
l_int|0
)paren
(brace
id|BUGMSG2
c_func
(paren
id|D_INIT_REASONS
comma
l_string|&quot;(airq=%d)&bslash;n&quot;
comma
id|airq
)paren
suffix:semicolon
id|BUGMSG
c_func
(paren
id|D_INIT_REASONS
comma
l_string|&quot;Stage 5: &quot;
)paren
suffix:semicolon
id|BUGLVL
c_func
(paren
id|D_INIT_REASONS
)paren
id|numprint
op_assign
l_int|0
suffix:semicolon
op_star
id|port
op_assign
id|ports
(braket
id|numports
op_minus
l_int|1
)braket
suffix:semicolon
id|numports
op_decrement
suffix:semicolon
id|port
op_decrement
suffix:semicolon
r_continue
suffix:semicolon
)brace
)brace
r_else
(brace
id|airq
op_assign
id|dev-&gt;irq
suffix:semicolon
)brace
id|BUGMSG2
c_func
(paren
id|D_INIT
comma
l_string|&quot;(%d,&quot;
comma
id|airq
)paren
suffix:semicolon
id|openparen
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* Everything seems okay.  But which shmem, if any, puts&n;&t;&t; * back its signature byte when the card is reset?&n;&t;&t; *&n;&t;&t; * If there are multiple cards installed, there might be&n;&t;&t; * multiple shmems still in the list.&n;&t;&t; */
macro_line|#ifdef FAST_PROBE
r_if
c_cond
(paren
id|numports
OG
l_int|1
op_logical_or
id|numshmems
OG
l_int|1
)paren
(brace
id|ARCRESET
suffix:semicolon
id|JIFFER
c_func
(paren
id|RESETtime
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* just one shmem and port, assume they match */
id|writeb
c_func
(paren
id|TESTvalue
comma
id|shmems
(braket
l_int|0
)braket
)paren
suffix:semicolon
)brace
macro_line|#else
id|ARCRESET
suffix:semicolon
id|JIFFER
c_func
(paren
id|RESETtime
)paren
suffix:semicolon
macro_line|#endif
r_for
c_loop
(paren
id|shmem
op_assign
op_amp
id|shmems
(braket
l_int|0
)braket
suffix:semicolon
id|shmem
op_minus
id|shmems
OL
id|numshmems
suffix:semicolon
id|shmem
op_increment
)paren
(brace
id|u_long
id|ptr
suffix:semicolon
id|ptr
op_assign
(paren
id|u_long
)paren
(paren
op_star
id|shmem
)paren
suffix:semicolon
r_if
c_cond
(paren
id|readb
c_func
(paren
id|ptr
)paren
op_eq
id|TESTvalue
)paren
multiline_comment|/* found one */
(brace
id|BUGMSG2
c_func
(paren
id|D_INIT
comma
l_string|&quot;%lXh)&bslash;n&quot;
comma
op_star
id|shmem
)paren
suffix:semicolon
id|openparen
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* register the card */
id|retval
op_assign
id|arcnet_found
c_func
(paren
id|dev
comma
op_star
id|port
comma
id|airq
comma
op_star
id|shmem
)paren
suffix:semicolon
r_if
c_cond
(paren
id|retval
)paren
id|openparen
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* remove shmem from the list */
op_star
id|shmem
op_assign
id|shmems
(braket
id|numshmems
op_minus
l_int|1
)braket
suffix:semicolon
id|numshmems
op_decrement
suffix:semicolon
r_break
suffix:semicolon
)brace
r_else
(brace
id|BUGMSG2
c_func
(paren
id|D_INIT_REASONS
comma
l_string|&quot;%Xh-&quot;
comma
id|readb
c_func
(paren
id|ptr
)paren
)paren
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|openparen
)paren
(brace
id|BUGMSG2
c_func
(paren
id|D_INIT
comma
l_string|&quot;no matching shmem)&bslash;n&quot;
)paren
suffix:semicolon
id|BUGMSG
c_func
(paren
id|D_INIT_REASONS
comma
l_string|&quot;Stage 5: &quot;
)paren
suffix:semicolon
id|BUGLVL
c_func
(paren
id|D_INIT_REASONS
)paren
id|numprint
op_assign
l_int|0
suffix:semicolon
)brace
op_star
id|port
op_assign
id|ports
(braket
id|numports
op_minus
l_int|1
)braket
suffix:semicolon
id|numports
op_decrement
suffix:semicolon
id|port
op_decrement
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|retval
)paren
r_break
suffix:semicolon
)brace
id|BUGMSG
c_func
(paren
id|D_INIT_REASONS
comma
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* Now put back TESTvalue on all leftover shmems.&n;&t; */
r_for
c_loop
(paren
id|shmem
op_assign
op_amp
id|shmems
(braket
l_int|0
)braket
suffix:semicolon
id|shmem
op_minus
id|shmems
OL
id|numshmems
suffix:semicolon
id|shmem
op_increment
)paren
id|writeb
c_func
(paren
id|TESTvalue
comma
op_star
id|shmem
)paren
suffix:semicolon
r_if
c_cond
(paren
id|retval
)paren
id|BUGMSG
c_func
(paren
id|D_NORMAL
comma
l_string|&quot;Stage 5: No ARCnet cards found.&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|retval
suffix:semicolon
)brace
macro_line|#endif /* !RIM_I_MODE */
multiline_comment|/* Set up the struct device associated with this card.  Called after&n; * probing succeeds.&n; */
DECL|function|arcnet_found
r_int
id|arcnet_found
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
r_int
id|port
comma
r_int
id|airq
comma
id|u_long
id|shmem
)paren
(brace
id|u_long
id|first_mirror
comma
id|last_mirror
suffix:semicolon
r_struct
id|arcnet_local
op_star
id|lp
suffix:semicolon
r_int
id|mirror_size
suffix:semicolon
multiline_comment|/* reserve the irq */
r_if
c_cond
(paren
id|request_irq
c_func
(paren
id|airq
comma
op_amp
id|arcnet_interrupt
comma
l_int|0
comma
l_string|&quot;arcnet&quot;
comma
l_int|NULL
)paren
)paren
(brace
id|BUGMSG
c_func
(paren
id|D_NORMAL
comma
l_string|&quot;Can&squot;t get IRQ %d!&bslash;n&quot;
comma
id|airq
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
id|irq2dev_map
(braket
id|airq
)braket
op_assign
id|dev
suffix:semicolon
id|dev-&gt;irq
op_assign
id|airq
suffix:semicolon
macro_line|#ifdef RIM_I_MODE
id|dev-&gt;base_addr
op_assign
l_int|0
suffix:semicolon
id|writeb
c_func
(paren
id|TESTvalue
comma
id|shmem
)paren
suffix:semicolon
id|writeb
c_func
(paren
id|port
comma
id|shmem
op_plus
l_int|1
)paren
suffix:semicolon
multiline_comment|/* actually the node ID */
macro_line|#else
multiline_comment|/* reserve the I/O region - guaranteed to work by check_region */
id|request_region
c_func
(paren
id|port
comma
id|ARCNET_TOTAL_SIZE
comma
l_string|&quot;arcnet&quot;
)paren
suffix:semicolon
id|dev-&gt;base_addr
op_assign
id|port
suffix:semicolon
macro_line|#endif
multiline_comment|/* find the real shared memory start/end points, including mirrors */
DECL|macro|BUFFER_SIZE
mdefine_line|#define BUFFER_SIZE (512)
DECL|macro|MIRROR_SIZE
mdefine_line|#define MIRROR_SIZE (BUFFER_SIZE*4)
multiline_comment|/* guess the actual size of one &quot;memory mirror&quot; - the number of&n;&t; * bytes between copies of the shared memory.  On most cards, it&squot;s&n;&t; * 2k (or there are no mirrors at all) but on some, it&squot;s 4k.&n;&t; */
id|mirror_size
op_assign
id|MIRROR_SIZE
suffix:semicolon
r_if
c_cond
(paren
id|readb
c_func
(paren
id|shmem
)paren
op_eq
id|TESTvalue
op_logical_and
id|readb
c_func
(paren
id|shmem
op_minus
id|mirror_size
)paren
op_ne
id|TESTvalue
op_logical_and
id|readb
c_func
(paren
id|shmem
op_minus
l_int|2
op_star
id|mirror_size
)paren
op_eq
id|TESTvalue
)paren
id|mirror_size
op_mul_assign
l_int|2
suffix:semicolon
id|first_mirror
op_assign
id|last_mirror
op_assign
id|shmem
suffix:semicolon
r_while
c_loop
(paren
id|readb
c_func
(paren
id|first_mirror
)paren
op_eq
id|TESTvalue
)paren
id|first_mirror
op_sub_assign
id|mirror_size
suffix:semicolon
id|first_mirror
op_add_assign
id|mirror_size
suffix:semicolon
r_while
c_loop
(paren
id|readb
c_func
(paren
id|last_mirror
)paren
op_eq
id|TESTvalue
)paren
id|last_mirror
op_add_assign
id|mirror_size
suffix:semicolon
id|last_mirror
op_sub_assign
id|mirror_size
suffix:semicolon
id|dev-&gt;mem_start
op_assign
id|first_mirror
suffix:semicolon
id|dev-&gt;mem_end
op_assign
id|last_mirror
op_plus
id|MIRROR_SIZE
op_minus
l_int|1
suffix:semicolon
id|dev-&gt;rmem_start
op_assign
id|dev-&gt;mem_start
op_plus
id|BUFFER_SIZE
op_star
l_int|0
suffix:semicolon
id|dev-&gt;rmem_end
op_assign
id|dev-&gt;mem_start
op_plus
id|BUFFER_SIZE
op_star
l_int|2
op_minus
l_int|1
suffix:semicolon
multiline_comment|/* Initialize the rest of the device structure. */
id|dev-&gt;priv
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|arcnet_local
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;priv
op_eq
l_int|NULL
)paren
(brace
id|irq2dev_map
(braket
id|airq
)braket
op_assign
l_int|NULL
suffix:semicolon
id|free_irq
c_func
(paren
id|airq
comma
l_int|NULL
)paren
suffix:semicolon
id|RELEASE_REGION
c_func
(paren
id|port
comma
id|ARCNET_TOTAL_SIZE
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|memset
c_func
(paren
id|dev-&gt;priv
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|arcnet_local
)paren
)paren
suffix:semicolon
id|lp
op_assign
(paren
r_struct
id|arcnet_local
op_star
)paren
(paren
id|dev-&gt;priv
)paren
suffix:semicolon
id|dev-&gt;open
op_assign
id|arcnet_open
suffix:semicolon
id|dev-&gt;stop
op_assign
id|arcnet_close
suffix:semicolon
id|dev-&gt;hard_start_xmit
op_assign
id|arcnetA_send_packet
suffix:semicolon
id|dev-&gt;get_stats
op_assign
id|arcnet_get_stats
suffix:semicolon
multiline_comment|/*dev-&gt;set_multicast_list = &amp;set_multicast_list;*/
multiline_comment|/* Fill in the fields of the device structure with generic&n;&t; * values.&n;&t; */
id|arcnet_setup
c_func
(paren
id|dev
)paren
suffix:semicolon
multiline_comment|/* And now fill particular fields with arcnet values */
id|dev-&gt;mtu
op_assign
l_int|1500
suffix:semicolon
multiline_comment|/* completely arbitrary - agrees with ether, though */
id|dev-&gt;hard_header_len
op_assign
r_sizeof
(paren
r_struct
id|ClientData
)paren
suffix:semicolon
id|dev-&gt;hard_header
op_assign
id|arcnetA_header
suffix:semicolon
id|dev-&gt;rebuild_header
op_assign
id|arcnetA_rebuild_header
suffix:semicolon
id|lp-&gt;sequence
op_assign
l_int|1
suffix:semicolon
id|lp-&gt;recbuf
op_assign
l_int|0
suffix:semicolon
id|BUGMSG
c_func
(paren
id|D_DURING
comma
l_string|&quot;ClientData header size is %d.&bslash;n&quot;
comma
r_sizeof
(paren
r_struct
id|ClientData
)paren
)paren
suffix:semicolon
id|BUGMSG
c_func
(paren
id|D_DURING
comma
l_string|&quot;HardHeader size is %d.&bslash;n&quot;
comma
r_sizeof
(paren
r_struct
id|HardHeader
)paren
)paren
suffix:semicolon
multiline_comment|/* get and check the station ID from offset 1 in shmem */
id|lp-&gt;stationid
op_assign
id|readb
c_func
(paren
id|first_mirror
op_plus
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|lp-&gt;stationid
op_eq
l_int|0
)paren
id|BUGMSG
c_func
(paren
id|D_NORMAL
comma
l_string|&quot;WARNING!  Station address 00 is reserved &quot;
l_string|&quot;for broadcasts!&bslash;n&quot;
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
id|lp-&gt;stationid
op_eq
l_int|255
)paren
id|BUGMSG
c_func
(paren
id|D_NORMAL
comma
l_string|&quot;WARNING!  Station address FF may confuse &quot;
l_string|&quot;DOS networking programs!&bslash;n&quot;
)paren
suffix:semicolon
id|dev-&gt;dev_addr
(braket
l_int|0
)braket
op_assign
id|lp-&gt;stationid
suffix:semicolon
id|BUGMSG
c_func
(paren
id|D_NORMAL
comma
l_string|&quot;ARCnet station %02Xh found at %03lXh, IRQ %d, &quot;
l_string|&quot;ShMem %lXh (%ld*%d bytes).&bslash;n&quot;
comma
id|lp-&gt;stationid
comma
id|dev-&gt;base_addr
comma
id|dev-&gt;irq
comma
id|dev-&gt;mem_start
comma
(paren
id|dev-&gt;mem_end
op_minus
id|dev-&gt;mem_start
op_plus
l_int|1
)paren
op_div
id|mirror_size
comma
id|mirror_size
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Do a hardware reset on the card, and set up necessary registers.&n; *&n; * This should be called as little as possible, because it disrupts the&n; * token on the network (causes a RECON) and requires a significant delay.&n; *&n; * However, it does make sure the card is in a defined state.&n; */
DECL|function|arcnet_reset
r_int
id|arcnet_reset
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
r_int
id|reset_delay
)paren
(brace
r_struct
id|arcnet_local
op_star
id|lp
op_assign
(paren
r_struct
id|arcnet_local
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_int
id|ioaddr
op_assign
id|IOADDR
suffix:semicolon
r_int
id|delayval
comma
id|recbuf
op_assign
id|lp-&gt;recbuf
suffix:semicolon
multiline_comment|/* no IRQ&squot;s, please! */
id|lp-&gt;intmask
op_assign
l_int|0
suffix:semicolon
id|SETMASK
suffix:semicolon
id|BUGMSG
c_func
(paren
id|D_INIT
comma
l_string|&quot;Resetting %s (status=%Xh)&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|ARCSTATUS
)paren
suffix:semicolon
r_if
c_cond
(paren
id|reset_delay
)paren
(brace
multiline_comment|/* reset the card */
id|ARCRESET
suffix:semicolon
id|JIFFER
c_func
(paren
id|RESETtime
)paren
suffix:semicolon
)brace
id|ACOMMAND
c_func
(paren
id|CFLAGScmd
op_or
id|RESETclear
)paren
suffix:semicolon
multiline_comment|/* clear flags &amp; end reset */
id|ACOMMAND
c_func
(paren
id|CFLAGScmd
op_or
id|CONFIGclear
)paren
suffix:semicolon
multiline_comment|/* verify that the ARCnet signature byte is present */
r_if
c_cond
(paren
id|readb
c_func
(paren
id|dev-&gt;mem_start
)paren
op_ne
id|TESTvalue
)paren
(brace
id|BUGMSG
c_func
(paren
id|D_NORMAL
comma
l_string|&quot;reset failed: TESTvalue not present.&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
multiline_comment|/* clear out status variables */
id|recbuf
op_assign
id|lp-&gt;recbuf
op_assign
l_int|0
suffix:semicolon
id|lp-&gt;txbuf
op_assign
l_int|2
suffix:semicolon
multiline_comment|/* enable extended (512-byte) packets */
id|ACOMMAND
c_func
(paren
id|CONFIGcmd
op_or
id|EXTconf
)paren
suffix:semicolon
macro_line|#ifndef SLOW_XMIT_COPY
multiline_comment|/* clean out all the memory to make debugging make more sense :) */
id|BUGLVL
c_func
(paren
id|D_DURING
)paren
id|memset_io
c_func
(paren
id|dev-&gt;mem_start
comma
l_int|0x42
comma
l_int|2048
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/* and enable receive of our first packet to the first buffer */
id|EnableReceiver
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* re-enable interrupts */
id|lp-&gt;intmask
op_or_assign
id|NORXflag
suffix:semicolon
macro_line|#ifdef DETECT_RECONFIGS
id|lp-&gt;intmask
op_or_assign
id|RECONflag
suffix:semicolon
macro_line|#endif
id|SETMASK
suffix:semicolon
multiline_comment|/* done!  return success. */
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Setup a struct device for ARCnet.  This should really be in net_init.c&n; * but since there are three different ARCnet devices ANYWAY... &lt;gargle&gt;&n; *&n; * Actually, the whole idea of having all this kernel-dependent stuff (ie.&n; * &quot;new-style flags&quot;) setup per-net-device is kind of weird anyway.&n; *&n; * Intelligent defaults?!  Nah.&n; */
DECL|function|arcnet_setup
r_void
id|arcnet_setup
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
id|dev_init_buffers
c_func
(paren
id|dev
)paren
suffix:semicolon
id|dev-&gt;broadcast
(braket
l_int|0
)braket
op_assign
l_int|0x00
suffix:semicolon
multiline_comment|/* for us, broadcasts are address 0 */
id|dev-&gt;addr_len
op_assign
l_int|1
suffix:semicolon
id|dev-&gt;type
op_assign
id|ARPHRD_ARCNET
suffix:semicolon
id|dev-&gt;tx_queue_len
op_assign
l_int|30
suffix:semicolon
multiline_comment|/* fairly long queue - arcnet is&n;&t;&t;&t;&t;&t; * quite speedy.&n;&t;&t;&t;&t;&t; */
multiline_comment|/* New-style flags. */
id|dev-&gt;flags
op_assign
id|IFF_BROADCAST
suffix:semicolon
id|dev-&gt;family
op_assign
id|AF_INET
suffix:semicolon
id|dev-&gt;pa_addr
op_assign
l_int|0
suffix:semicolon
id|dev-&gt;pa_brdaddr
op_assign
l_int|0
suffix:semicolon
id|dev-&gt;pa_mask
op_assign
l_int|0
suffix:semicolon
id|dev-&gt;pa_alen
op_assign
l_int|4
suffix:semicolon
)brace
multiline_comment|/****************************************************************************&n; *                                                                          *&n; * Open and close the driver                                                *&n; *                                                                          *&n; ****************************************************************************/
multiline_comment|/* Open/initialize the board.  This is called sometime after booting when&n; * the &squot;ifconfig&squot; program is run.&n; *&n; * This routine should set everything up anew at each open, even&n; * registers that &quot;should&quot; only need to be set once at boot, so that&n; * there is non-reboot way to recover if something goes wrong.&n; */
r_static
r_int
DECL|function|arcnet_open
id|arcnet_open
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
r_struct
id|arcnet_local
op_star
id|lp
op_assign
(paren
r_struct
id|arcnet_local
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_int
id|ioaddr
op_assign
id|IOADDR
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;metric
op_ge
l_int|1000
)paren
(brace
id|arcnet_debug
op_assign
id|dev-&gt;metric
op_minus
l_int|1000
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%6s: debug level set to %d&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|arcnet_debug
)paren
suffix:semicolon
id|dev-&gt;metric
op_assign
l_int|1
suffix:semicolon
)brace
id|BUGMSG
c_func
(paren
id|D_INIT
comma
l_string|&quot;arcnet_open: resetting card.&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#ifdef FAST_IFCONFIG
multiline_comment|/* try to put the card in a defined state - if it fails the first&n;&t; * time, actually reset it.&n;&t; */
r_if
c_cond
(paren
id|arcnet_reset
c_func
(paren
id|dev
comma
l_int|0
)paren
op_logical_and
id|arcnet_reset
c_func
(paren
id|dev
comma
l_int|1
)paren
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
macro_line|#else
multiline_comment|/* reset the card twice in case something goes wrong the first time.&n;&t; */
r_if
c_cond
(paren
id|arcnet_reset
c_func
(paren
id|dev
comma
l_int|1
)paren
op_logical_and
id|arcnet_reset
c_func
(paren
id|dev
comma
l_int|1
)paren
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
macro_line|#endif
id|dev-&gt;tbusy
op_assign
l_int|0
suffix:semicolon
id|dev-&gt;interrupt
op_assign
l_int|0
suffix:semicolon
id|lp-&gt;intx
op_assign
l_int|0
suffix:semicolon
id|lp-&gt;in_txhandler
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* The RFC1201 driver is the default - just store */
id|lp-&gt;adev
op_assign
id|dev
suffix:semicolon
id|BUGMSG
c_func
(paren
id|D_NORMAL
comma
l_string|&quot;ARCnet RFC1201 protocol initialized.&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#ifdef CONFIG_ARCNET_ETH
multiline_comment|/* Initialize the ethernet-encap protocol driver */
id|lp-&gt;edev
op_assign
(paren
r_struct
id|device
op_star
)paren
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|device
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|lp-&gt;edev
op_eq
l_int|NULL
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|memcpy
c_func
(paren
id|lp-&gt;edev
comma
id|dev
comma
r_sizeof
(paren
r_struct
id|device
)paren
)paren
suffix:semicolon
id|lp-&gt;edev-&gt;name
op_assign
(paren
r_char
op_star
)paren
id|kmalloc
c_func
(paren
l_int|10
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|lp-&gt;edev-&gt;name
op_eq
l_int|NULL
)paren
(brace
id|kfree
c_func
(paren
id|lp-&gt;edev
)paren
suffix:semicolon
id|lp-&gt;edev
op_assign
l_int|NULL
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|sprintf
c_func
(paren
id|lp-&gt;edev-&gt;name
comma
l_string|&quot;%se&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|lp-&gt;edev-&gt;init
op_assign
id|arcnetE_init
suffix:semicolon
id|register_netdev
c_func
(paren
id|lp-&gt;edev
)paren
suffix:semicolon
macro_line|#else
id|BUGMSG
c_func
(paren
id|D_NORMAL
comma
l_string|&quot;Ethernet-Encap protocol not available (disabled).&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
macro_line|#ifdef CONFIG_ARCNET_1051
multiline_comment|/* Initialize the RFC1051-encap protocol driver */
id|lp-&gt;sdev
op_assign
(paren
r_struct
id|device
op_star
)paren
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|device
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|lp-&gt;sdev
comma
id|dev
comma
r_sizeof
(paren
r_struct
id|device
)paren
)paren
suffix:semicolon
id|lp-&gt;sdev-&gt;name
op_assign
(paren
r_char
op_star
)paren
id|kmalloc
c_func
(paren
l_int|10
comma
id|GFP_KERNEL
)paren
suffix:semicolon
id|sprintf
c_func
(paren
id|lp-&gt;sdev-&gt;name
comma
l_string|&quot;%ss&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|lp-&gt;sdev-&gt;init
op_assign
id|arcnetS_init
suffix:semicolon
id|register_netdev
c_func
(paren
id|lp-&gt;sdev
)paren
suffix:semicolon
macro_line|#else
id|BUGMSG
c_func
(paren
id|D_NORMAL
comma
l_string|&quot;RFC1051 protocol not available (disabled).&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/* we&squot;re started */
id|START
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* make sure we&squot;re ready to receive IRQ&squot;s.&n;&t; * arcnet_reset sets this for us, but if we receive one before&n;&t; * START is set to 1, it could be ignored.  So, we turn IRQ&squot;s&n;&t; * off, then on again to clean out the IRQ controller.&n;&t; */
id|AINTMASK
c_func
(paren
l_int|0
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|1
)paren
suffix:semicolon
multiline_comment|/* give it time to set the mask before&n;&t;&t;&t; * we reset it again. (may not even be&n;&t;&t;&t; * necessary)&n;&t;&t;&t; */
id|SETMASK
suffix:semicolon
id|MOD_INC_USE_COUNT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* The inverse routine to arcnet_open - shuts down the card.&n; */
r_static
r_int
DECL|function|arcnet_close
id|arcnet_close
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
r_int
id|ioaddr
op_assign
id|IOADDR
suffix:semicolon
r_struct
id|arcnet_local
op_star
id|lp
op_assign
(paren
r_struct
id|arcnet_local
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|TBUSY
op_assign
l_int|1
suffix:semicolon
id|START
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Shut down the card */
macro_line|#ifdef FAST_IFCONFIG
id|ARCRESET
suffix:semicolon
multiline_comment|/* reset IRQ won&squot;t run if START=0 */
macro_line|#else
id|lp-&gt;intmask
op_assign
l_int|0
suffix:semicolon
id|SETMASK
suffix:semicolon
multiline_comment|/* no IRQ&squot;s (except RESET, of course) */
id|ACOMMAND
c_func
(paren
id|NOTXcmd
)paren
suffix:semicolon
multiline_comment|/* stop transmit */
id|ACOMMAND
c_func
(paren
id|NORXcmd
)paren
suffix:semicolon
multiline_comment|/* disable receive */
macro_line|#endif
multiline_comment|/* reset more flags */
id|INTERRUPT
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* do NOT free lp-&gt;adev!!  It&squot;s static! */
id|lp-&gt;adev
op_assign
l_int|NULL
suffix:semicolon
macro_line|#ifdef CONFIG_ARCNET_ETH
multiline_comment|/* free the ethernet-encap protocol device */
id|lp-&gt;edev-&gt;priv
op_assign
l_int|NULL
suffix:semicolon
id|dev_close
c_func
(paren
id|lp-&gt;edev
)paren
suffix:semicolon
id|unregister_netdev
c_func
(paren
id|lp-&gt;edev
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|lp-&gt;edev-&gt;name
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|lp-&gt;edev
)paren
suffix:semicolon
id|lp-&gt;edev
op_assign
l_int|NULL
suffix:semicolon
macro_line|#endif
macro_line|#ifdef CONFIG_ARCNET_1051
multiline_comment|/* free the RFC1051-encap protocol device */
id|lp-&gt;sdev-&gt;priv
op_assign
l_int|NULL
suffix:semicolon
id|dev_close
c_func
(paren
id|lp-&gt;sdev
)paren
suffix:semicolon
id|unregister_netdev
c_func
(paren
id|lp-&gt;sdev
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|lp-&gt;sdev-&gt;name
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|lp-&gt;sdev
)paren
suffix:semicolon
id|lp-&gt;sdev
op_assign
l_int|NULL
suffix:semicolon
macro_line|#endif
multiline_comment|/* Update the statistics here. (not necessary in ARCnet) */
id|MOD_DEC_USE_COUNT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/****************************************************************************&n; *                                                                          *&n; * Transmitter routines                                                     *&n; *                                                                          *&n; ****************************************************************************/
multiline_comment|/* Generic error checking routine for arcnet??_send_packet&n; */
r_static
r_int
DECL|function|arcnet_send_packet_bad
id|arcnet_send_packet_bad
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|device
op_star
id|dev
)paren
(brace
r_struct
id|arcnet_local
op_star
id|lp
op_assign
(paren
r_struct
id|arcnet_local
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_int
id|ioaddr
op_assign
id|IOADDR
suffix:semicolon
id|BUGMSG
c_func
(paren
id|D_DURING
comma
l_string|&quot;transmit requested (status=%Xh, inTX=%d)&bslash;n&quot;
comma
id|ARCSTATUS
comma
id|lp-&gt;intx
)paren
suffix:semicolon
r_if
c_cond
(paren
id|lp-&gt;in_txhandler
)paren
(brace
id|BUGMSG
c_func
(paren
id|D_NORMAL
comma
l_string|&quot;send_packet called while in txhandler!&bslash;n&quot;
)paren
suffix:semicolon
id|lp-&gt;stats.tx_dropped
op_increment
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|lp-&gt;intx
OG
l_int|1
)paren
(brace
id|BUGMSG
c_func
(paren
id|D_NORMAL
comma
l_string|&quot;send_packet called while intx!&bslash;n&quot;
)paren
suffix:semicolon
id|lp-&gt;stats.tx_dropped
op_increment
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|IF_TBUSY
)paren
(brace
multiline_comment|/* If we get here, some higher level has decided we are broken.&n;&t;&t;   There should really be a &quot;kick me&quot; function call instead. */
r_int
id|tickssofar
op_assign
id|jiffies
op_minus
id|dev-&gt;trans_start
suffix:semicolon
multiline_comment|/*int recbuf=lp-&gt;recbuf;*/
r_int
id|status
op_assign
id|ARCSTATUS
suffix:semicolon
r_if
c_cond
(paren
id|tickssofar
OL
id|TX_TIMEOUT
)paren
(brace
id|BUGMSG
c_func
(paren
id|D_DURING
comma
l_string|&quot;premature kickme! (status=%Xh ticks=%d o.skb=%ph numsegs=%d segnum=%d&bslash;n&quot;
comma
id|status
comma
id|tickssofar
comma
id|lp-&gt;outgoing.skb
comma
id|lp-&gt;outgoing.numsegs
comma
id|lp-&gt;outgoing.segnum
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
id|lp-&gt;intmask
op_and_assign
op_complement
id|TXFREEflag
suffix:semicolon
id|SETMASK
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
id|TXFREEflag
)paren
multiline_comment|/* transmit _DID_ finish */
(brace
id|BUGMSG
c_func
(paren
id|D_NORMAL
comma
l_string|&quot;tx timeout - missed IRQ? (status=%Xh, ticks=%d, mask=%Xh, dest=%02Xh)&bslash;n&quot;
comma
id|status
comma
id|tickssofar
comma
id|lp-&gt;intmask
comma
id|lp-&gt;lasttrans_dest
)paren
suffix:semicolon
id|lp-&gt;stats.tx_errors
op_increment
suffix:semicolon
)brace
r_else
(brace
id|BUGMSG
c_func
(paren
id|D_EXTRA
comma
l_string|&quot;tx timed out (status=%Xh, tickssofar=%d, intmask=%Xh, dest=%02Xh)&bslash;n&quot;
comma
id|status
comma
id|tickssofar
comma
id|lp-&gt;intmask
comma
id|lp-&gt;lasttrans_dest
)paren
suffix:semicolon
id|lp-&gt;stats.tx_errors
op_increment
suffix:semicolon
id|lp-&gt;stats.tx_aborted_errors
op_increment
suffix:semicolon
id|ACOMMAND
c_func
(paren
id|NOTXcmd
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|lp-&gt;outgoing.skb
)paren
(brace
id|dev_kfree_skb
c_func
(paren
id|lp-&gt;outgoing.skb
comma
id|FREE_WRITE
)paren
suffix:semicolon
id|lp-&gt;stats.tx_dropped
op_increment
suffix:semicolon
)brace
id|lp-&gt;outgoing.skb
op_assign
l_int|NULL
suffix:semicolon
id|TBUSY
op_assign
l_int|0
suffix:semicolon
id|lp-&gt;txready
op_assign
l_int|0
suffix:semicolon
id|lp-&gt;sending
op_assign
l_int|0
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
multiline_comment|/* If some higher layer thinks we&squot;ve missed a tx-done interrupt&n;&t;   we are passed NULL. Caution: dev_tint() handles the cli()/sti()&n;&t;   itself. */
r_if
c_cond
(paren
id|skb
op_eq
l_int|NULL
)paren
(brace
id|BUGMSG
c_func
(paren
id|D_NORMAL
comma
l_string|&quot;tx passed null skb (status=%Xh, inTX=%d, tickssofar=%ld)&bslash;n&quot;
comma
id|ARCSTATUS
comma
id|lp-&gt;intx
comma
id|jiffies
op_minus
id|dev-&gt;trans_start
)paren
suffix:semicolon
id|lp-&gt;stats.tx_errors
op_increment
suffix:semicolon
id|dev_tint
c_func
(paren
id|dev
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|lp-&gt;txready
)paren
multiline_comment|/* transmit already in progress! */
(brace
id|BUGMSG
c_func
(paren
id|D_NORMAL
comma
l_string|&quot;trying to start new packet while busy! (status=%Xh)&bslash;n&quot;
comma
id|ARCSTATUS
)paren
suffix:semicolon
id|lp-&gt;intmask
op_and_assign
op_complement
id|TXFREEflag
suffix:semicolon
id|SETMASK
suffix:semicolon
id|ACOMMAND
c_func
(paren
id|NOTXcmd
)paren
suffix:semicolon
multiline_comment|/* abort current send */
id|arcnet_inthandler
c_func
(paren
id|dev
)paren
suffix:semicolon
multiline_comment|/* fake an interrupt */
id|lp-&gt;stats.tx_errors
op_increment
suffix:semicolon
id|lp-&gt;stats.tx_fifo_errors
op_increment
suffix:semicolon
id|lp-&gt;txready
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* we definitely need this line! */
r_return
l_int|1
suffix:semicolon
)brace
multiline_comment|/* Block a timer-based transmit from overlapping.  This could better be&n;&t;   done with atomic_swap(1, dev-&gt;tbusy), but set_bit() works as well. */
r_if
c_cond
(paren
id|set_bit
c_func
(paren
l_int|0
comma
(paren
r_void
op_star
)paren
op_amp
id|dev-&gt;tbusy
)paren
op_ne
l_int|0
)paren
(brace
id|BUGMSG
c_func
(paren
id|D_NORMAL
comma
l_string|&quot;transmitter called with busy bit set! (status=%Xh, inTX=%d, tickssofar=%ld)&bslash;n&quot;
comma
id|ARCSTATUS
comma
id|lp-&gt;intx
comma
id|jiffies
op_minus
id|dev-&gt;trans_start
)paren
suffix:semicolon
id|lp-&gt;stats.tx_errors
op_increment
suffix:semicolon
id|lp-&gt;stats.tx_fifo_errors
op_increment
suffix:semicolon
r_return
op_minus
id|EBUSY
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Called by the kernel in order to transmit a packet.&n; */
r_static
r_int
DECL|function|arcnetA_send_packet
id|arcnetA_send_packet
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|device
op_star
id|dev
)paren
(brace
r_struct
id|arcnet_local
op_star
id|lp
op_assign
(paren
r_struct
id|arcnet_local
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_int
id|ioaddr
op_assign
id|IOADDR
comma
id|bad
suffix:semicolon
r_struct
id|Outgoing
op_star
id|out
op_assign
op_amp
(paren
id|lp-&gt;outgoing
)paren
suffix:semicolon
id|lp-&gt;intx
op_increment
suffix:semicolon
id|bad
op_assign
id|arcnet_send_packet_bad
c_func
(paren
id|skb
comma
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|bad
)paren
(brace
id|lp-&gt;intx
op_decrement
suffix:semicolon
r_return
id|bad
suffix:semicolon
)brace
id|TBUSY
op_assign
l_int|1
suffix:semicolon
id|out-&gt;length
op_assign
l_int|1
OL
id|skb-&gt;len
ques
c_cond
id|skb-&gt;len
suffix:colon
l_int|1
suffix:semicolon
id|out-&gt;hdr
op_assign
(paren
r_struct
id|ClientData
op_star
)paren
id|skb-&gt;data
suffix:semicolon
id|out-&gt;skb
op_assign
id|skb
suffix:semicolon
id|BUGLVL
c_func
(paren
id|D_SKB
)paren
id|arcnet_dump_skb
c_func
(paren
id|dev
comma
id|skb
comma
l_string|&quot;tx&quot;
)paren
suffix:semicolon
id|out-&gt;hdr-&gt;sequence
op_assign
(paren
id|lp-&gt;sequence
op_increment
)paren
suffix:semicolon
multiline_comment|/* fits in one packet? */
r_if
c_cond
(paren
id|out-&gt;length
op_minus
id|EXTRA_CLIENTDATA
op_le
id|XMTU
)paren
(brace
id|BUGMSG
c_func
(paren
id|D_DURING
comma
l_string|&quot;not splitting %d-byte packet. (split_flag=%d)&bslash;n&quot;
comma
id|out-&gt;length
comma
id|out-&gt;hdr-&gt;split_flag
)paren
suffix:semicolon
r_if
c_cond
(paren
id|out-&gt;hdr-&gt;split_flag
)paren
id|BUGMSG
c_func
(paren
id|D_NORMAL
comma
l_string|&quot;short packet has split_flag set?! (split_flag=%d)&bslash;n&quot;
comma
id|out-&gt;hdr-&gt;split_flag
)paren
suffix:semicolon
id|out-&gt;numsegs
op_assign
l_int|1
suffix:semicolon
id|out-&gt;segnum
op_assign
l_int|1
suffix:semicolon
id|arcnetAS_prepare_tx
c_func
(paren
id|dev
comma
(paren
(paren
r_char
op_star
)paren
id|out-&gt;hdr
)paren
op_plus
id|EXTRA_CLIENTDATA
comma
r_sizeof
(paren
r_struct
id|ClientData
)paren
op_minus
id|EXTRA_CLIENTDATA
comma
(paren
(paren
r_char
op_star
)paren
id|skb-&gt;data
)paren
op_plus
r_sizeof
(paren
r_struct
id|ClientData
)paren
comma
id|out-&gt;length
op_minus
r_sizeof
(paren
r_struct
id|ClientData
)paren
comma
id|out-&gt;hdr-&gt;daddr
comma
l_int|1
)paren
suffix:semicolon
multiline_comment|/* done right away */
id|dev_kfree_skb
c_func
(paren
id|out-&gt;skb
comma
id|FREE_WRITE
)paren
suffix:semicolon
id|out-&gt;skb
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
id|arcnet_go_tx
c_func
(paren
id|dev
comma
l_int|1
)paren
)paren
(brace
multiline_comment|/* inform upper layers */
id|TBUSY
op_assign
l_int|0
suffix:semicolon
id|mark_bh
c_func
(paren
id|NET_BH
)paren
suffix:semicolon
)brace
)brace
r_else
multiline_comment|/* too big for one - split it */
(brace
r_int
id|maxsegsize
op_assign
id|XMTU
op_minus
l_int|4
suffix:semicolon
id|out-&gt;data
op_assign
(paren
id|u_char
op_star
)paren
id|skb-&gt;data
op_plus
r_sizeof
(paren
r_struct
id|ClientData
)paren
suffix:semicolon
id|out-&gt;dataleft
op_assign
id|out-&gt;length
op_minus
r_sizeof
(paren
r_struct
id|ClientData
)paren
suffix:semicolon
id|out-&gt;numsegs
op_assign
(paren
id|out-&gt;dataleft
op_plus
id|maxsegsize
op_minus
l_int|1
)paren
op_div
id|maxsegsize
suffix:semicolon
id|out-&gt;segnum
op_assign
l_int|0
suffix:semicolon
id|BUGMSG
c_func
(paren
id|D_TX
comma
l_string|&quot;packet (%d bytes) split into %d fragments:&bslash;n&quot;
comma
id|out-&gt;length
comma
id|out-&gt;numsegs
)paren
suffix:semicolon
multiline_comment|/* if a packet waiting, launch it */
id|arcnet_go_tx
c_func
(paren
id|dev
comma
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|lp-&gt;txready
)paren
(brace
multiline_comment|/* prepare a packet, launch it and prepare&n;&t;&t;&t; * another.&n;&t;&t;&t; */
id|arcnetA_continue_tx
c_func
(paren
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|arcnet_go_tx
c_func
(paren
id|dev
comma
l_int|1
)paren
)paren
(brace
id|arcnetA_continue_tx
c_func
(paren
id|dev
)paren
suffix:semicolon
id|arcnet_go_tx
c_func
(paren
id|dev
comma
l_int|1
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* if segnum==numsegs, the transmission is finished;&n;&t;&t; * free the skb right away.&n;&t;&t; */
r_if
c_cond
(paren
id|out-&gt;segnum
op_eq
id|out-&gt;numsegs
)paren
(brace
multiline_comment|/* transmit completed */
id|out-&gt;segnum
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|out-&gt;skb
)paren
id|dev_kfree_skb
c_func
(paren
id|out-&gt;skb
comma
id|FREE_WRITE
)paren
suffix:semicolon
id|out-&gt;skb
op_assign
l_int|NULL
suffix:semicolon
)brace
)brace
id|dev-&gt;trans_start
op_assign
id|jiffies
suffix:semicolon
id|lp-&gt;intx
op_decrement
suffix:semicolon
multiline_comment|/* make sure we didn&squot;t ignore a TX IRQ while we were in here */
id|lp-&gt;intmask
op_or_assign
id|TXFREEflag
suffix:semicolon
id|SETMASK
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* After an RFC1201 split packet has been set up, this function calls&n; * arcnetAS_prepare_tx to load the next segment into the card.  This function&n; * does NOT automatically call arcnet_go_tx.&n; */
DECL|function|arcnetA_continue_tx
r_static
r_void
id|arcnetA_continue_tx
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
r_struct
id|arcnet_local
op_star
id|lp
op_assign
(paren
r_struct
id|arcnet_local
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_int
id|ioaddr
op_assign
id|IOADDR
comma
id|maxsegsize
op_assign
id|XMTU
op_minus
l_int|4
suffix:semicolon
r_struct
id|Outgoing
op_star
id|out
op_assign
op_amp
(paren
id|lp-&gt;outgoing
)paren
suffix:semicolon
id|BUGMSG
c_func
(paren
id|D_DURING
comma
l_string|&quot;continue_tx called (status=%Xh, intx=%d, intxh=%d, intmask=%Xh&bslash;n&quot;
comma
id|ARCSTATUS
comma
id|lp-&gt;intx
comma
id|lp-&gt;in_txhandler
comma
id|lp-&gt;intmask
)paren
suffix:semicolon
r_if
c_cond
(paren
id|lp-&gt;txready
)paren
(brace
id|BUGMSG
c_func
(paren
id|D_NORMAL
comma
l_string|&quot;continue_tx: called with packet in buffer!&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|out-&gt;segnum
op_ge
id|out-&gt;numsegs
)paren
(brace
id|BUGMSG
c_func
(paren
id|D_NORMAL
comma
l_string|&quot;continue_tx: building segment %d of %d!&bslash;n&quot;
comma
id|out-&gt;segnum
op_plus
l_int|1
comma
id|out-&gt;numsegs
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|out-&gt;segnum
)paren
multiline_comment|/* first packet */
id|out-&gt;hdr-&gt;split_flag
op_assign
(paren
(paren
id|out-&gt;numsegs
op_minus
l_int|2
)paren
op_lshift
l_int|1
)paren
op_plus
l_int|1
suffix:semicolon
r_else
id|out-&gt;hdr-&gt;split_flag
op_assign
id|out-&gt;segnum
op_lshift
l_int|1
suffix:semicolon
id|out-&gt;seglen
op_assign
id|maxsegsize
suffix:semicolon
r_if
c_cond
(paren
id|out-&gt;seglen
OG
id|out-&gt;dataleft
)paren
id|out-&gt;seglen
op_assign
id|out-&gt;dataleft
suffix:semicolon
id|BUGMSG
c_func
(paren
id|D_TX
comma
l_string|&quot;building packet #%d (%d bytes) of %d (%d total), splitflag=%d&bslash;n&quot;
comma
id|out-&gt;segnum
op_plus
l_int|1
comma
id|out-&gt;seglen
comma
id|out-&gt;numsegs
comma
id|out-&gt;length
comma
id|out-&gt;hdr-&gt;split_flag
)paren
suffix:semicolon
id|arcnetAS_prepare_tx
c_func
(paren
id|dev
comma
(paren
(paren
r_char
op_star
)paren
id|out-&gt;hdr
)paren
op_plus
id|EXTRA_CLIENTDATA
comma
r_sizeof
(paren
r_struct
id|ClientData
)paren
op_minus
id|EXTRA_CLIENTDATA
comma
id|out-&gt;data
comma
id|out-&gt;seglen
comma
id|out-&gt;hdr-&gt;daddr
comma
l_int|1
)paren
suffix:semicolon
id|out-&gt;dataleft
op_sub_assign
id|out-&gt;seglen
suffix:semicolon
id|out-&gt;data
op_add_assign
id|out-&gt;seglen
suffix:semicolon
id|out-&gt;segnum
op_increment
suffix:semicolon
)brace
multiline_comment|/* Given an skb, copy a packet into the ARCnet buffers for later transmission&n; * by arcnet_go_tx.&n; */
r_static
r_void
DECL|function|arcnetAS_prepare_tx
id|arcnetAS_prepare_tx
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
id|u_char
op_star
id|hdr
comma
r_int
id|hdrlen
comma
r_char
op_star
id|data
comma
r_int
id|length
comma
r_int
id|daddr
comma
r_int
id|exceptA
)paren
(brace
r_struct
id|arcnet_local
op_star
id|lp
op_assign
(paren
r_struct
id|arcnet_local
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_struct
id|ClientData
op_star
id|arcsoft
suffix:semicolon
r_union
id|ArcPacket
op_star
id|arcpacket
op_assign
(paren
r_union
id|ArcPacket
op_star
)paren
id|phys_to_virt
c_func
(paren
id|dev-&gt;mem_start
op_plus
l_int|512
op_star
(paren
id|lp-&gt;txbuf
op_xor
l_int|1
)paren
)paren
suffix:semicolon
r_int
id|offset
suffix:semicolon
macro_line|#ifdef SLOW_XMIT_COPY
r_char
op_star
id|iptr
comma
op_star
id|iend
comma
op_star
id|optr
suffix:semicolon
macro_line|#endif
id|lp-&gt;txbuf
op_assign
id|lp-&gt;txbuf
op_xor
l_int|1
suffix:semicolon
multiline_comment|/* XOR with 1 to alternate between 2 and 3 */
id|length
op_add_assign
id|hdrlen
suffix:semicolon
id|BUGMSG
c_func
(paren
id|D_TX
comma
l_string|&quot;arcnetAS_prep_tx: hdr:%ph, length:%d, data:%ph&bslash;n&quot;
comma
id|hdr
comma
id|length
comma
id|data
)paren
suffix:semicolon
macro_line|#ifndef SLOW_XMIT_COPY
multiline_comment|/* clean out the page to make debugging make more sense :) */
id|BUGLVL
c_func
(paren
id|D_DURING
)paren
id|memset_io
c_func
(paren
id|dev-&gt;mem_start
op_plus
id|lp-&gt;txbuf
op_star
l_int|512
comma
l_int|0x42
comma
l_int|512
)paren
suffix:semicolon
macro_line|#endif
id|arcpacket-&gt;hardheader.destination
op_assign
id|daddr
suffix:semicolon
multiline_comment|/* load packet into shared memory */
r_if
c_cond
(paren
id|length
op_le
id|MTU
)paren
multiline_comment|/* Normal (256-byte) Packet */
(brace
id|arcpacket-&gt;hardheader.offset1
op_assign
id|offset
op_assign
l_int|256
op_minus
id|length
suffix:semicolon
id|arcsoft
op_assign
(paren
r_struct
id|ClientData
op_star
)paren
(paren
op_amp
id|arcpacket-&gt;raw
(braket
id|offset
)braket
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|length
op_ge
id|MinTU
)paren
multiline_comment|/* Extended (512-byte) Packet */
(brace
id|arcpacket-&gt;hardheader.offset1
op_assign
l_int|0
suffix:semicolon
id|arcpacket-&gt;hardheader.offset2
op_assign
id|offset
op_assign
l_int|512
op_minus
id|length
suffix:semicolon
id|arcsoft
op_assign
(paren
r_struct
id|ClientData
op_star
)paren
(paren
op_amp
id|arcpacket-&gt;raw
(braket
id|offset
)braket
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|exceptA
)paren
multiline_comment|/* RFC1201 Exception Packet */
(brace
id|arcpacket-&gt;hardheader.offset1
op_assign
l_int|0
suffix:semicolon
id|arcpacket-&gt;hardheader.offset2
op_assign
id|offset
op_assign
l_int|512
op_minus
id|length
op_minus
l_int|4
suffix:semicolon
id|arcsoft
op_assign
(paren
r_struct
id|ClientData
op_star
)paren
(paren
op_amp
id|arcpacket-&gt;raw
(braket
id|offset
op_plus
l_int|4
)braket
)paren
suffix:semicolon
multiline_comment|/* exception-specific stuff - these four bytes&n;&t;&t; * make the packet long enough to fit in a 512-byte&n;&t;&t; * frame.&n;&t;&t; */
id|arcpacket-&gt;raw
(braket
id|offset
op_plus
l_int|0
)braket
op_assign
id|hdr
(braket
l_int|0
)braket
suffix:semicolon
id|arcpacket-&gt;raw
(braket
id|offset
op_plus
l_int|1
)braket
op_assign
l_int|0xFF
suffix:semicolon
multiline_comment|/* FF flag */
id|arcpacket-&gt;raw
(braket
id|offset
op_plus
l_int|2
)braket
op_assign
l_int|0xFF
suffix:semicolon
multiline_comment|/* FF padding */
id|arcpacket-&gt;raw
(braket
id|offset
op_plus
l_int|3
)braket
op_assign
l_int|0xFF
suffix:semicolon
multiline_comment|/* FF padding */
)brace
r_else
multiline_comment|/* &quot;other&quot; Exception packet */
(brace
multiline_comment|/* RFC1051 - set 4 trailing bytes to 0 */
id|memset
c_func
(paren
op_amp
id|arcpacket-&gt;raw
(braket
l_int|508
)braket
comma
l_int|0
comma
l_int|4
)paren
suffix:semicolon
multiline_comment|/* now round up to MinTU */
id|arcpacket-&gt;hardheader.offset1
op_assign
l_int|0
suffix:semicolon
id|arcpacket-&gt;hardheader.offset2
op_assign
id|offset
op_assign
l_int|512
op_minus
id|MinTU
suffix:semicolon
id|arcsoft
op_assign
(paren
r_struct
id|ClientData
op_star
)paren
(paren
op_amp
id|arcpacket-&gt;raw
(braket
id|offset
)braket
)paren
suffix:semicolon
)brace
multiline_comment|/* copy the packet into ARCnet shmem&n;&t; *  - the first bytes of ClientData header are skipped&n;&t; */
id|memcpy
c_func
(paren
(paren
id|u_char
op_star
)paren
id|arcsoft
comma
(paren
id|u_char
op_star
)paren
id|hdr
comma
id|hdrlen
)paren
suffix:semicolon
macro_line|#ifdef SLOW_XMIT_COPY
r_for
c_loop
(paren
id|iptr
op_assign
id|data
comma
id|iend
op_assign
id|iptr
op_plus
id|length
op_minus
id|hdrlen
comma
id|optr
op_assign
(paren
r_char
op_star
)paren
id|arcsoft
op_plus
id|hdrlen
suffix:semicolon
id|iptr
OL
id|iend
suffix:semicolon
id|iptr
op_increment
comma
id|optr
op_increment
)paren
(brace
op_star
id|optr
op_assign
op_star
id|iptr
suffix:semicolon
multiline_comment|/*udelay(5);*/
)brace
macro_line|#else
id|memcpy
c_func
(paren
(paren
id|u_char
op_star
)paren
id|arcsoft
op_plus
id|hdrlen
comma
id|data
comma
id|length
op_minus
id|hdrlen
)paren
suffix:semicolon
macro_line|#endif
id|BUGMSG
c_func
(paren
id|D_DURING
comma
l_string|&quot;transmitting packet to station %02Xh (%d bytes)&bslash;n&quot;
comma
id|daddr
comma
id|length
)paren
suffix:semicolon
id|BUGLVL
c_func
(paren
id|D_TX
)paren
id|arcnet_dump_packet
c_func
(paren
id|dev
comma
id|arcpacket-&gt;raw
comma
id|length
OG
id|MTU
comma
l_string|&quot;tx&quot;
)paren
suffix:semicolon
id|lp-&gt;lastload_dest
op_assign
id|daddr
suffix:semicolon
id|lp-&gt;txready
op_assign
id|lp-&gt;txbuf
suffix:semicolon
multiline_comment|/* packet is ready for sending */
)brace
multiline_comment|/* Actually start transmitting a packet that was placed in the card&squot;s&n; * buffer by arcnetAS_prepare_tx.  Returns 1 if a Tx is really started.&n; *&n; * This should probably always be called with the INTMASK register set to 0,&n; * so go_tx is not called recursively.&n; *&n; * The enable_irq flag determines whether to actually write INTMASK value&n; * to the card; TXFREEflag is always OR&squot;ed into the memory variable either&n; * way.&n; */
r_static
r_int
DECL|function|arcnet_go_tx
id|arcnet_go_tx
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
r_int
id|enable_irq
)paren
(brace
r_struct
id|arcnet_local
op_star
id|lp
op_assign
(paren
r_struct
id|arcnet_local
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_int
id|ioaddr
op_assign
id|IOADDR
suffix:semicolon
id|BUGMSG
c_func
(paren
id|D_DURING
comma
l_string|&quot;go_tx: status=%Xh, intmask=%Xh, txready=%d, sending=%d&bslash;n&quot;
comma
id|ARCSTATUS
comma
id|lp-&gt;intmask
comma
id|lp-&gt;txready
comma
id|lp-&gt;sending
)paren
suffix:semicolon
r_if
c_cond
(paren
id|lp-&gt;sending
op_logical_or
op_logical_neg
id|lp-&gt;txready
)paren
(brace
r_if
c_cond
(paren
id|enable_irq
op_logical_and
id|lp-&gt;sending
)paren
(brace
id|lp-&gt;intmask
op_or_assign
id|TXFREEflag
suffix:semicolon
id|SETMASK
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* start sending */
id|ACOMMAND
c_func
(paren
id|TXcmd
op_or
(paren
id|lp-&gt;txready
op_lshift
l_int|3
)paren
)paren
suffix:semicolon
id|lp-&gt;stats.tx_packets
op_increment
suffix:semicolon
id|lp-&gt;txready
op_assign
l_int|0
suffix:semicolon
id|lp-&gt;sending
op_increment
suffix:semicolon
id|lp-&gt;lasttrans_dest
op_assign
id|lp-&gt;lastload_dest
suffix:semicolon
id|lp-&gt;lastload_dest
op_assign
l_int|0
suffix:semicolon
id|lp-&gt;intmask
op_or_assign
id|TXFREEflag
suffix:semicolon
r_if
c_cond
(paren
id|enable_irq
)paren
id|SETMASK
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
multiline_comment|/****************************************************************************&n; *                                                                          *&n; * Interrupt handler                                                        *&n; *                                                                          *&n; ****************************************************************************/
multiline_comment|/* The typical workload of the driver:  Handle the network interface&n; * interrupts.  This doesn&squot;t do much right now except call arcnet_inthandler,&n; * which takes different parameters but may be called from other places&n; * as well.&n; */
r_static
r_void
DECL|function|arcnet_interrupt
id|arcnet_interrupt
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_struct
id|device
op_star
id|dev
op_assign
(paren
r_struct
id|device
op_star
)paren
(paren
id|irq2dev_map
(braket
id|irq
)braket
)paren
suffix:semicolon
r_int
id|ioaddr
suffix:semicolon
r_if
c_cond
(paren
id|dev
op_eq
l_int|NULL
)paren
(brace
id|BUGLVL
c_func
(paren
id|D_DURING
)paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;arcnet: irq %d for unknown device.&bslash;n&quot;
comma
id|irq
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|BUGMSG
c_func
(paren
id|D_DURING
comma
l_string|&quot;in arcnet_interrupt&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* RESET flag was enabled - if !dev-&gt;start, we must clear it right&n;&t; * away (but nothing else) since inthandler() is never called.&n;&t; */
id|ioaddr
op_assign
id|IOADDR
suffix:semicolon
multiline_comment|/* can&squot;t do this before checking dev!=NULL */
r_if
c_cond
(paren
op_logical_neg
id|dev-&gt;start
)paren
(brace
r_if
c_cond
(paren
id|ARCSTATUS
op_amp
id|RESETflag
)paren
id|ACOMMAND
c_func
(paren
id|CFLAGScmd
op_or
id|RESETclear
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/* Call the &quot;real&quot; interrupt handler. */
id|arcnet_inthandler
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
multiline_comment|/* The actual interrupt handler routine - handle various IRQ&squot;s generated&n; * by the card.&n; */
r_static
r_void
DECL|function|arcnet_inthandler
id|arcnet_inthandler
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
r_struct
id|arcnet_local
op_star
id|lp
op_assign
(paren
r_struct
id|arcnet_local
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_int
id|ioaddr
op_assign
id|IOADDR
comma
id|status
comma
id|boguscount
op_assign
l_int|3
comma
id|didsomething
suffix:semicolon
r_if
c_cond
(paren
id|IF_INTERRUPT
)paren
(brace
id|BUGMSG
c_func
(paren
id|D_NORMAL
comma
l_string|&quot;DRIVER PROBLEM!  Nested arcnet interrupts!&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
multiline_comment|/* don&squot;t even try. */
)brace
id|AINTMASK
c_func
(paren
l_int|0
)paren
suffix:semicolon
id|INTERRUPT
op_assign
l_int|1
suffix:semicolon
id|BUGMSG
c_func
(paren
id|D_DURING
comma
l_string|&quot;in arcnet_inthandler (status=%Xh, intmask=%Xh)&bslash;n&quot;
comma
id|ARCSTATUS
comma
id|lp-&gt;intmask
)paren
suffix:semicolon
r_do
(brace
id|status
op_assign
id|ARCSTATUS
suffix:semicolon
id|didsomething
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* RESET flag was enabled - card is resetting and if RX&n;&t;&t; * is disabled, it&squot;s NOT because we just got a packet.&n;&t;&t; */
r_if
c_cond
(paren
id|status
op_amp
id|RESETflag
)paren
(brace
id|BUGMSG
c_func
(paren
id|D_NORMAL
comma
l_string|&quot;spurious reset (status=%Xh)&bslash;n&quot;
comma
id|status
)paren
suffix:semicolon
id|arcnet_reset
c_func
(paren
id|dev
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* all other flag values are just garbage */
r_break
suffix:semicolon
)brace
multiline_comment|/* RX is inhibited - we must have received something. */
r_if
c_cond
(paren
id|status
op_amp
id|lp-&gt;intmask
op_amp
id|NORXflag
)paren
(brace
r_int
id|recbuf
op_assign
id|lp-&gt;recbuf
op_assign
op_logical_neg
id|lp-&gt;recbuf
suffix:semicolon
id|BUGMSG
c_func
(paren
id|D_DURING
comma
l_string|&quot;receive irq (status=%Xh)&bslash;n&quot;
comma
id|status
)paren
suffix:semicolon
multiline_comment|/* enable receive of our next packet */
id|EnableReceiver
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* Got a packet. */
id|arcnet_rx
c_func
(paren
id|dev
comma
op_logical_neg
id|recbuf
)paren
suffix:semicolon
id|didsomething
op_increment
suffix:semicolon
)brace
multiline_comment|/* it can only be an xmit-done irq if we&squot;re xmitting :) */
multiline_comment|/*if (status&amp;TXFREEflag &amp;&amp; !lp-&gt;in_txhandler &amp;&amp; lp-&gt;sending)*/
r_if
c_cond
(paren
id|status
op_amp
id|lp-&gt;intmask
op_amp
id|TXFREEflag
)paren
(brace
r_struct
id|Outgoing
op_star
id|out
op_assign
op_amp
(paren
id|lp-&gt;outgoing
)paren
suffix:semicolon
r_int
id|was_sending
op_assign
id|lp-&gt;sending
suffix:semicolon
id|lp-&gt;intmask
op_and_assign
op_complement
id|TXFREEflag
suffix:semicolon
id|lp-&gt;in_txhandler
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|was_sending
)paren
id|lp-&gt;sending
op_decrement
suffix:semicolon
id|BUGMSG
c_func
(paren
id|D_DURING
comma
l_string|&quot;TX IRQ (stat=%Xh, numsegs=%d, segnum=%d, skb=%ph)&bslash;n&quot;
comma
id|status
comma
id|out-&gt;numsegs
comma
id|out-&gt;segnum
comma
id|out-&gt;skb
)paren
suffix:semicolon
r_if
c_cond
(paren
id|was_sending
op_logical_and
op_logical_neg
(paren
id|status
op_amp
id|TXACKflag
)paren
)paren
(brace
r_if
c_cond
(paren
id|lp-&gt;lasttrans_dest
op_ne
l_int|0
)paren
(brace
id|BUGMSG
c_func
(paren
id|D_EXTRA
comma
l_string|&quot;transmit was not acknowledged! (status=%Xh, dest=%02Xh)&bslash;n&quot;
comma
id|status
comma
id|lp-&gt;lasttrans_dest
)paren
suffix:semicolon
id|lp-&gt;stats.tx_errors
op_increment
suffix:semicolon
id|lp-&gt;stats.tx_carrier_errors
op_increment
suffix:semicolon
)brace
r_else
(brace
id|BUGMSG
c_func
(paren
id|D_DURING
comma
l_string|&quot;broadcast was not acknowledged; that&squot;s normal (status=%Xh, dest=%02Xh)&bslash;n&quot;
comma
id|status
comma
id|lp-&gt;lasttrans_dest
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* send packet if there is one */
id|arcnet_go_tx
c_func
(paren
id|dev
comma
l_int|0
)paren
suffix:semicolon
id|didsomething
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|lp-&gt;intx
)paren
(brace
id|BUGMSG
c_func
(paren
id|D_DURING
comma
l_string|&quot;TXDONE while intx! (status=%Xh, intx=%d)&bslash;n&quot;
comma
id|ARCSTATUS
comma
id|lp-&gt;intx
)paren
suffix:semicolon
id|lp-&gt;in_txhandler
op_decrement
suffix:semicolon
r_continue
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|lp-&gt;outgoing.skb
)paren
(brace
id|BUGMSG
c_func
(paren
id|D_DURING
comma
l_string|&quot;TX IRQ done: no split to continue.&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* inform upper layers */
r_if
c_cond
(paren
op_logical_neg
id|lp-&gt;txready
op_logical_and
id|IF_TBUSY
)paren
(brace
id|TBUSY
op_assign
l_int|0
suffix:semicolon
id|mark_bh
c_func
(paren
id|NET_BH
)paren
suffix:semicolon
)brace
id|lp-&gt;in_txhandler
op_decrement
suffix:semicolon
r_continue
suffix:semicolon
)brace
multiline_comment|/* if more than one segment, and not all segments&n;&t;&t;&t; * are done, then continue xmit.&n;&t;&t;&t; */
r_if
c_cond
(paren
id|out-&gt;segnum
OL
id|out-&gt;numsegs
)paren
id|arcnetA_continue_tx
c_func
(paren
id|dev
)paren
suffix:semicolon
id|arcnet_go_tx
c_func
(paren
id|dev
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* if segnum==numsegs, the transmission is finished;&n;&t;&t;&t; * free the skb.&n;&t;&t;&t; */
r_if
c_cond
(paren
id|out-&gt;segnum
op_ge
id|out-&gt;numsegs
)paren
(brace
multiline_comment|/* transmit completed */
id|out-&gt;segnum
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|out-&gt;skb
)paren
id|dev_kfree_skb
c_func
(paren
id|out-&gt;skb
comma
id|FREE_WRITE
)paren
suffix:semicolon
id|out-&gt;skb
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/* inform upper layers */
r_if
c_cond
(paren
op_logical_neg
id|lp-&gt;txready
op_logical_and
id|IF_TBUSY
)paren
(brace
id|TBUSY
op_assign
l_int|0
suffix:semicolon
id|mark_bh
c_func
(paren
id|NET_BH
)paren
suffix:semicolon
)brace
)brace
id|didsomething
op_increment
suffix:semicolon
id|lp-&gt;in_txhandler
op_decrement
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|lp-&gt;txready
op_logical_and
op_logical_neg
id|lp-&gt;sending
op_logical_and
op_logical_neg
id|lp-&gt;intx
)paren
(brace
id|BUGMSG
c_func
(paren
id|D_NORMAL
comma
l_string|&quot;recovery from silent TX (status=%Xh)&bslash;n&quot;
comma
id|status
)paren
suffix:semicolon
id|arcnet_go_tx
c_func
(paren
id|dev
comma
l_int|0
)paren
suffix:semicolon
id|didsomething
op_increment
suffix:semicolon
)brace
macro_line|#ifdef DETECT_RECONFIGS
r_if
c_cond
(paren
id|status
op_amp
(paren
id|lp-&gt;intmask
)paren
op_amp
id|RECONflag
)paren
(brace
id|ACOMMAND
c_func
(paren
id|CFLAGScmd
op_or
id|CONFIGclear
)paren
suffix:semicolon
id|lp-&gt;stats.tx_carrier_errors
op_increment
suffix:semicolon
macro_line|#ifdef SHOW_RECONFIGS
id|BUGMSG
c_func
(paren
id|D_NORMAL
comma
l_string|&quot;Network reconfiguration detected (status=%Xh)&bslash;n&quot;
comma
id|status
)paren
suffix:semicolon
macro_line|#endif /* SHOW_RECONFIGS */
macro_line|#ifdef RECON_THRESHOLD
multiline_comment|/* is the RECON info empty or old? */
r_if
c_cond
(paren
op_logical_neg
id|lp-&gt;first_recon
op_logical_or
op_logical_neg
id|lp-&gt;last_recon
op_logical_or
id|jiffies
op_minus
id|lp-&gt;last_recon
OG
id|HZ
op_star
l_int|10
)paren
(brace
r_if
c_cond
(paren
id|lp-&gt;network_down
)paren
id|BUGMSG
c_func
(paren
id|D_NORMAL
comma
l_string|&quot;reconfiguration detected: cabling restored?&bslash;n&quot;
)paren
suffix:semicolon
id|lp-&gt;first_recon
op_assign
id|lp-&gt;last_recon
op_assign
id|jiffies
suffix:semicolon
id|lp-&gt;num_recons
op_assign
id|lp-&gt;network_down
op_assign
l_int|0
suffix:semicolon
id|BUGMSG
c_func
(paren
id|D_DURING
comma
l_string|&quot;recon: clearing counters.&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_else
multiline_comment|/* add to current RECON counter */
(brace
id|lp-&gt;last_recon
op_assign
id|jiffies
suffix:semicolon
id|lp-&gt;num_recons
op_increment
suffix:semicolon
id|BUGMSG
c_func
(paren
id|D_DURING
comma
l_string|&quot;recon: counter=%d, time=%lds, net=%d&bslash;n&quot;
comma
id|lp-&gt;num_recons
comma
(paren
id|lp-&gt;last_recon
op_minus
id|lp-&gt;first_recon
)paren
op_div
id|HZ
comma
id|lp-&gt;network_down
)paren
suffix:semicolon
multiline_comment|/* if network is marked up;&n;&t;&t;&t;&t; * and first_recon and last_recon are 60+ sec&n;&t;&t;&t;&t; *   apart;&n;&t;&t;&t;&t; * and the average no. of recons counted is&n;&t;&t;&t;&t; *   &gt; RECON_THRESHOLD/min;&n;&t;&t;&t;&t; * then print a warning message.&n;&t;&t;&t;&t; */
r_if
c_cond
(paren
op_logical_neg
id|lp-&gt;network_down
op_logical_and
(paren
id|lp-&gt;last_recon
op_minus
id|lp-&gt;first_recon
)paren
op_le
id|HZ
op_star
l_int|60
op_logical_and
id|lp-&gt;num_recons
op_ge
id|RECON_THRESHOLD
)paren
(brace
id|lp-&gt;network_down
op_assign
l_int|1
suffix:semicolon
id|BUGMSG
c_func
(paren
id|D_NORMAL
comma
l_string|&quot;many reconfigurations detected: cabling problem?&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
op_logical_neg
id|lp-&gt;network_down
op_logical_and
id|lp-&gt;last_recon
op_minus
id|lp-&gt;first_recon
OG
id|HZ
op_star
l_int|60
)paren
(brace
multiline_comment|/* reset counters if we&squot;ve gone for&n;&t;&t;&t;&t;&t; * over a minute.&n;&t;&t;&t;&t;&t; */
id|lp-&gt;first_recon
op_assign
id|lp-&gt;last_recon
suffix:semicolon
id|lp-&gt;num_recons
op_assign
l_int|1
suffix:semicolon
)brace
)brace
macro_line|#endif
)brace
macro_line|#ifdef RECON_THRESHOLD
r_else
r_if
c_cond
(paren
id|lp-&gt;network_down
op_logical_and
id|jiffies
op_minus
id|lp-&gt;last_recon
OG
id|HZ
op_star
l_int|10
)paren
(brace
r_if
c_cond
(paren
id|lp-&gt;network_down
)paren
id|BUGMSG
c_func
(paren
id|D_NORMAL
comma
l_string|&quot;cabling restored?&bslash;n&quot;
)paren
suffix:semicolon
id|lp-&gt;first_recon
op_assign
id|lp-&gt;last_recon
op_assign
l_int|0
suffix:semicolon
id|lp-&gt;num_recons
op_assign
id|lp-&gt;network_down
op_assign
l_int|0
suffix:semicolon
id|BUGMSG
c_func
(paren
id|D_DURING
comma
l_string|&quot;not recon: clearing counters anyway.&bslash;n&quot;
)paren
suffix:semicolon
)brace
macro_line|#endif
macro_line|#endif /* DETECT_RECONFIGS */
)brace
r_while
c_loop
(paren
op_decrement
id|boguscount
op_logical_and
id|didsomething
)paren
suffix:semicolon
id|BUGMSG
c_func
(paren
id|D_DURING
comma
l_string|&quot;net_interrupt complete (status=%Xh, count=%d)&bslash;n&quot;
comma
id|ARCSTATUS
comma
id|boguscount
)paren
suffix:semicolon
id|BUGMSG
c_func
(paren
id|D_DURING
comma
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
id|SETMASK
suffix:semicolon
multiline_comment|/* put back interrupt mask */
id|INTERRUPT
op_assign
l_int|0
suffix:semicolon
)brace
multiline_comment|/****************************************************************************&n; *                                                                          *&n; * Receiver routines                                                        *&n; *                                                                          *&n; ****************************************************************************/
multiline_comment|/* A packet has arrived; grab it from the buffers and possibly unsplit it.&n; * This is a generic packet receiver that calls arcnet??_rx depending on the&n; * protocol ID found.&n; */
r_static
r_void
DECL|function|arcnet_rx
id|arcnet_rx
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
r_int
id|recbuf
)paren
(brace
r_struct
id|arcnet_local
op_star
id|lp
op_assign
(paren
r_struct
id|arcnet_local
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_int
id|ioaddr
op_assign
id|IOADDR
suffix:semicolon
r_union
id|ArcPacket
op_star
id|arcpacket
op_assign
(paren
r_union
id|ArcPacket
op_star
)paren
id|phys_to_virt
c_func
(paren
id|dev-&gt;mem_start
op_plus
id|recbuf
op_star
l_int|512
)paren
suffix:semicolon
id|u_char
op_star
id|arcsoft
suffix:semicolon
r_int
id|length
comma
id|offset
suffix:semicolon
id|u_char
id|daddr
comma
id|saddr
suffix:semicolon
id|lp-&gt;stats.rx_packets
op_increment
suffix:semicolon
id|saddr
op_assign
id|arcpacket-&gt;hardheader.source
suffix:semicolon
id|daddr
op_assign
id|arcpacket-&gt;hardheader.destination
suffix:semicolon
multiline_comment|/* if source is 0, it&squot;s a &quot;used&quot; packet! */
r_if
c_cond
(paren
id|saddr
op_eq
l_int|0
)paren
(brace
id|BUGMSG
c_func
(paren
id|D_NORMAL
comma
l_string|&quot;discarding old packet. (status=%Xh)&bslash;n&quot;
comma
id|ARCSTATUS
)paren
suffix:semicolon
id|lp-&gt;stats.rx_errors
op_increment
suffix:semicolon
r_return
suffix:semicolon
)brace
id|arcpacket-&gt;hardheader.source
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|arcpacket-&gt;hardheader.offset1
)paren
multiline_comment|/* Normal Packet */
(brace
id|offset
op_assign
id|arcpacket-&gt;hardheader.offset1
suffix:semicolon
id|arcsoft
op_assign
op_amp
id|arcpacket-&gt;raw
(braket
id|offset
)braket
suffix:semicolon
id|length
op_assign
l_int|256
op_minus
id|offset
suffix:semicolon
)brace
r_else
multiline_comment|/* ExtendedPacket or ExceptionPacket */
(brace
id|offset
op_assign
id|arcpacket-&gt;hardheader.offset2
suffix:semicolon
id|arcsoft
op_assign
op_amp
id|arcpacket-&gt;raw
(braket
id|offset
)braket
suffix:semicolon
id|length
op_assign
l_int|512
op_minus
id|offset
suffix:semicolon
)brace
id|BUGMSG
c_func
(paren
id|D_DURING
comma
l_string|&quot;received packet from %02Xh to %02Xh (%d bytes)&bslash;n&quot;
comma
id|saddr
comma
id|daddr
comma
id|length
)paren
suffix:semicolon
multiline_comment|/* call the right receiver for the protocol */
r_switch
c_cond
(paren
id|arcsoft
(braket
l_int|0
)braket
)paren
(brace
r_case
id|ARC_P_IP
suffix:colon
r_case
id|ARC_P_ARP
suffix:colon
r_case
id|ARC_P_RARP
suffix:colon
r_case
id|ARC_P_IPX
suffix:colon
r_case
id|ARC_P_NOVELL_EC
suffix:colon
id|arcnetA_rx
c_func
(paren
id|lp-&gt;adev
comma
id|arcsoft
comma
id|length
comma
id|saddr
comma
id|daddr
)paren
suffix:semicolon
r_break
suffix:semicolon
macro_line|#ifdef CONFIG_ARCNET_ETH
r_case
id|ARC_P_ETHER
suffix:colon
id|arcnetE_rx
c_func
(paren
id|lp-&gt;edev
comma
id|arcsoft
comma
id|length
comma
id|saddr
comma
id|daddr
)paren
suffix:semicolon
r_break
suffix:semicolon
macro_line|#endif
macro_line|#ifdef CONFIG_ARCNET_1051
r_case
id|ARC_P_IP_RFC1051
suffix:colon
r_case
id|ARC_P_ARP_RFC1051
suffix:colon
id|arcnetS_rx
c_func
(paren
id|lp-&gt;sdev
comma
id|arcsoft
comma
id|length
comma
id|saddr
comma
id|daddr
)paren
suffix:semicolon
r_break
suffix:semicolon
macro_line|#endif
r_case
id|ARC_P_DATAPOINT_BOOT
suffix:colon
r_case
id|ARC_P_DATAPOINT_MOUNT
suffix:colon
r_break
suffix:semicolon
r_case
id|ARC_P_POWERLAN_BEACON
suffix:colon
r_case
id|ARC_P_POWERLAN_BEACON2
suffix:colon
r_break
suffix:semicolon
r_case
id|ARC_P_LANSOFT
suffix:colon
multiline_comment|/* don&squot;t understand.  fall through. */
r_default
suffix:colon
id|BUGMSG
c_func
(paren
id|D_EXTRA
comma
l_string|&quot;received unknown protocol %d (%Xh) from station %d.&bslash;n&quot;
comma
id|arcsoft
(braket
l_int|0
)braket
comma
id|arcsoft
(braket
l_int|0
)braket
comma
id|saddr
)paren
suffix:semicolon
id|lp-&gt;stats.rx_errors
op_increment
suffix:semicolon
id|lp-&gt;stats.rx_crc_errors
op_increment
suffix:semicolon
r_break
suffix:semicolon
)brace
id|BUGLVL
c_func
(paren
id|D_RX
)paren
id|arcnet_dump_packet
c_func
(paren
id|dev
comma
id|arcpacket-&gt;raw
comma
id|length
OG
l_int|240
comma
l_string|&quot;rx&quot;
)paren
suffix:semicolon
macro_line|#ifndef SLOW_XMIT_COPY
multiline_comment|/* clean out the page to make debugging make more sense :) */
id|BUGLVL
c_func
(paren
id|D_DURING
)paren
id|memset
c_func
(paren
(paren
r_void
op_star
)paren
id|arcpacket-&gt;raw
comma
l_int|0x42
comma
l_int|512
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/* If any worth-while packets have been received, a mark_bh(NET_BH)&n;&t; * has been done by netif_rx and Linux will handle them after we&n;&t; * return.&n;&t; */
)brace
multiline_comment|/* Packet receiver for &quot;standard&quot; RFC1201-style packets&n; */
r_static
r_void
DECL|function|arcnetA_rx
id|arcnetA_rx
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
id|u_char
op_star
id|buf
comma
r_int
id|length
comma
id|u_char
id|saddr
comma
id|u_char
id|daddr
)paren
(brace
r_struct
id|arcnet_local
op_star
id|lp
op_assign
(paren
r_struct
id|arcnet_local
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
r_struct
id|ClientData
op_star
id|arcsoft
comma
op_star
id|soft
suffix:semicolon
id|BUGMSG
c_func
(paren
id|D_DURING
comma
l_string|&quot;it&squot;s an RFC1201 packet (length=%d)&bslash;n&quot;
comma
id|length
)paren
suffix:semicolon
multiline_comment|/* compensate for EXTRA_CLIENTDATA (which isn&squot;t actually in the&n;&t; * packet)&n;&t; */
id|arcsoft
op_assign
(paren
r_struct
id|ClientData
op_star
)paren
(paren
id|buf
op_minus
id|EXTRA_CLIENTDATA
)paren
suffix:semicolon
id|length
op_add_assign
id|EXTRA_CLIENTDATA
suffix:semicolon
r_if
c_cond
(paren
id|arcsoft-&gt;split_flag
op_eq
l_int|0xFF
)paren
multiline_comment|/* Exception Packet */
(brace
id|BUGMSG
c_func
(paren
id|D_DURING
comma
l_string|&quot;compensating for exception packet&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* skip over 4-byte junkola */
id|arcsoft
op_assign
(paren
r_struct
id|ClientData
op_star
)paren
(paren
(paren
id|u_char
op_star
)paren
id|arcsoft
op_plus
l_int|4
)paren
suffix:semicolon
id|length
op_sub_assign
l_int|4
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|arcsoft-&gt;split_flag
)paren
multiline_comment|/* not split */
(brace
r_struct
id|Incoming
op_star
id|in
op_assign
op_amp
id|lp-&gt;incoming
(braket
id|saddr
)braket
suffix:semicolon
id|BUGMSG
c_func
(paren
id|D_RX
comma
l_string|&quot;incoming is not split (splitflag=%d)&bslash;n&quot;
comma
id|arcsoft-&gt;split_flag
)paren
suffix:semicolon
r_if
c_cond
(paren
id|in-&gt;skb
)paren
multiline_comment|/* already assembling one! */
(brace
id|BUGMSG
c_func
(paren
id|D_EXTRA
comma
l_string|&quot;aborting assembly (seq=%d) for unsplit packet (splitflag=%d, seq=%d)&bslash;n&quot;
comma
id|in-&gt;sequence
comma
id|arcsoft-&gt;split_flag
comma
id|arcsoft-&gt;sequence
)paren
suffix:semicolon
id|kfree_skb
c_func
(paren
id|in-&gt;skb
comma
id|FREE_WRITE
)paren
suffix:semicolon
id|lp-&gt;stats.rx_errors
op_increment
suffix:semicolon
id|lp-&gt;stats.rx_missed_errors
op_increment
suffix:semicolon
id|in-&gt;skb
op_assign
l_int|NULL
suffix:semicolon
)brace
id|in-&gt;sequence
op_assign
id|arcsoft-&gt;sequence
suffix:semicolon
id|skb
op_assign
id|alloc_skb
c_func
(paren
id|length
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
id|skb
op_eq
l_int|NULL
)paren
(brace
id|BUGMSG
c_func
(paren
id|D_NORMAL
comma
l_string|&quot;Memory squeeze, dropping packet.&bslash;n&quot;
)paren
suffix:semicolon
id|lp-&gt;stats.rx_dropped
op_increment
suffix:semicolon
r_return
suffix:semicolon
)brace
id|soft
op_assign
(paren
r_struct
id|ClientData
op_star
)paren
id|skb-&gt;data
suffix:semicolon
id|skb-&gt;len
op_assign
id|length
suffix:semicolon
id|skb-&gt;dev
op_assign
id|dev
suffix:semicolon
id|memcpy
c_func
(paren
(paren
id|u_char
op_star
)paren
id|soft
op_plus
id|EXTRA_CLIENTDATA
comma
(paren
id|u_char
op_star
)paren
id|arcsoft
op_plus
id|EXTRA_CLIENTDATA
comma
id|length
op_minus
id|EXTRA_CLIENTDATA
)paren
suffix:semicolon
id|soft-&gt;daddr
op_assign
id|daddr
suffix:semicolon
id|soft-&gt;saddr
op_assign
id|saddr
suffix:semicolon
multiline_comment|/* ARP packets have problems when sent from DOS.&n;         &t; * source address is always 0 on some systems!  So we take&n;         &t; * the hardware source addr (which is impossible to fumble)&n;         &t; * and insert it ourselves.&n;         &t; */
r_if
c_cond
(paren
id|soft-&gt;protocol_id
op_eq
id|ARC_P_ARP
)paren
(brace
r_struct
id|arphdr
op_star
id|arp
op_assign
(paren
r_struct
id|arphdr
op_star
)paren
(paren
(paren
r_char
op_star
)paren
id|soft
op_plus
r_sizeof
(paren
r_struct
id|ClientData
)paren
)paren
suffix:semicolon
multiline_comment|/* make sure addresses are the right length */
r_if
c_cond
(paren
id|arp-&gt;ar_hln
op_eq
l_int|1
op_logical_and
id|arp-&gt;ar_pln
op_eq
l_int|4
)paren
(brace
r_char
op_star
id|cptr
op_assign
(paren
r_char
op_star
)paren
(paren
id|arp
)paren
op_plus
r_sizeof
(paren
r_struct
id|arphdr
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
op_star
id|cptr
)paren
multiline_comment|/* is saddr = 00? */
(brace
id|BUGMSG
c_func
(paren
id|D_EXTRA
comma
l_string|&quot;ARP source address was 00h, set to %02Xh.&bslash;n&quot;
comma
id|saddr
)paren
suffix:semicolon
id|lp-&gt;stats.rx_crc_errors
op_increment
suffix:semicolon
op_star
id|cptr
op_assign
id|saddr
suffix:semicolon
)brace
r_else
(brace
id|BUGMSG
c_func
(paren
id|D_DURING
comma
l_string|&quot;ARP source address (%Xh) is fine.&bslash;n&quot;
comma
op_star
id|cptr
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
id|BUGMSG
c_func
(paren
id|D_NORMAL
comma
l_string|&quot;funny-shaped ARP packet. (%Xh, %Xh)&bslash;n&quot;
comma
id|arp-&gt;ar_hln
comma
id|arp-&gt;ar_pln
)paren
suffix:semicolon
id|lp-&gt;stats.rx_errors
op_increment
suffix:semicolon
id|lp-&gt;stats.rx_crc_errors
op_increment
suffix:semicolon
)brace
)brace
id|BUGLVL
c_func
(paren
id|D_SKB
)paren
id|arcnet_dump_skb
c_func
(paren
id|dev
comma
id|skb
comma
l_string|&quot;rx&quot;
)paren
suffix:semicolon
id|skb-&gt;protocol
op_assign
id|arcnetA_type_trans
c_func
(paren
id|skb
comma
id|dev
)paren
suffix:semicolon
id|netif_rx
c_func
(paren
id|skb
)paren
suffix:semicolon
)brace
r_else
multiline_comment|/* split packet */
(brace
multiline_comment|/* NOTE:  MSDOS ARP packet correction should only need to&n;&t;          * apply to unsplit packets, since ARP packets are so short.&n;&t;          *&n;&t;          * My interpretation of the RFC1201 (ARCnet) document is that&n;&t;          * if a packet is received out of order, the entire assembly&n;&t;          * process should be aborted.&n;&t;          *&n;&t;          * The RFC also mentions &quot;it is possible for successfully&n;&t;          * received packets to be retransmitted.&quot;  As of 0.40 all&n;&t;          * previously received packets are allowed, not just the&n;&t;          * most recent one.&n;&t;          *&n;&t;          * We allow multiple assembly processes, one for each&n;&t;          * ARCnet card possible on the network.  Seems rather like&n;&t;          * a waste of memory.  Necessary?&n;&t;          */
r_struct
id|Incoming
op_star
id|in
op_assign
op_amp
id|lp-&gt;incoming
(braket
id|saddr
)braket
suffix:semicolon
id|BUGMSG
c_func
(paren
id|D_RX
comma
l_string|&quot;packet is split (splitflag=%d, seq=%d)&bslash;n&quot;
comma
id|arcsoft-&gt;split_flag
comma
id|in-&gt;sequence
)paren
suffix:semicolon
r_if
c_cond
(paren
id|in-&gt;skb
op_logical_and
id|in-&gt;sequence
op_ne
id|arcsoft-&gt;sequence
)paren
(brace
id|BUGMSG
c_func
(paren
id|D_EXTRA
comma
l_string|&quot;wrong seq number (saddr=%d, expected=%d, seq=%d, splitflag=%d)&bslash;n&quot;
comma
id|saddr
comma
id|in-&gt;sequence
comma
id|arcsoft-&gt;sequence
comma
id|arcsoft-&gt;split_flag
)paren
suffix:semicolon
id|kfree_skb
c_func
(paren
id|in-&gt;skb
comma
id|FREE_WRITE
)paren
suffix:semicolon
id|in-&gt;skb
op_assign
l_int|NULL
suffix:semicolon
id|lp-&gt;stats.rx_errors
op_increment
suffix:semicolon
id|lp-&gt;stats.rx_missed_errors
op_increment
suffix:semicolon
id|in-&gt;lastpacket
op_assign
id|in-&gt;numpackets
op_assign
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|arcsoft-&gt;split_flag
op_amp
l_int|1
)paren
multiline_comment|/* first packet in split */
(brace
id|BUGMSG
c_func
(paren
id|D_RX
comma
l_string|&quot;brand new splitpacket (splitflag=%d)&bslash;n&quot;
comma
id|arcsoft-&gt;split_flag
)paren
suffix:semicolon
r_if
c_cond
(paren
id|in-&gt;skb
)paren
multiline_comment|/* already assembling one! */
(brace
id|BUGMSG
c_func
(paren
id|D_EXTRA
comma
l_string|&quot;aborting previous (seq=%d) assembly (splitflag=%d, seq=%d)&bslash;n&quot;
comma
id|in-&gt;sequence
comma
id|arcsoft-&gt;split_flag
comma
id|arcsoft-&gt;sequence
)paren
suffix:semicolon
id|lp-&gt;stats.rx_errors
op_increment
suffix:semicolon
id|lp-&gt;stats.rx_missed_errors
op_increment
suffix:semicolon
id|kfree_skb
c_func
(paren
id|in-&gt;skb
comma
id|FREE_WRITE
)paren
suffix:semicolon
)brace
id|in-&gt;sequence
op_assign
id|arcsoft-&gt;sequence
suffix:semicolon
id|in-&gt;numpackets
op_assign
(paren
(paren
r_int
)paren
id|arcsoft-&gt;split_flag
op_rshift
l_int|1
)paren
op_plus
l_int|2
suffix:semicolon
id|in-&gt;lastpacket
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|in-&gt;numpackets
OG
l_int|16
)paren
(brace
id|BUGMSG
c_func
(paren
id|D_EXTRA
comma
l_string|&quot;incoming packet more than 16 segments; dropping. (splitflag=%d)&bslash;n&quot;
comma
id|arcsoft-&gt;split_flag
)paren
suffix:semicolon
id|lp-&gt;stats.rx_errors
op_increment
suffix:semicolon
id|lp-&gt;stats.rx_length_errors
op_increment
suffix:semicolon
r_return
suffix:semicolon
)brace
id|in-&gt;skb
op_assign
id|skb
op_assign
id|alloc_skb
c_func
(paren
l_int|508
op_star
id|in-&gt;numpackets
op_plus
r_sizeof
(paren
r_struct
id|ClientData
)paren
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
id|skb
op_eq
l_int|NULL
)paren
(brace
id|BUGMSG
c_func
(paren
id|D_NORMAL
comma
l_string|&quot;(split) memory squeeze, dropping packet.&bslash;n&quot;
)paren
suffix:semicolon
id|lp-&gt;stats.rx_dropped
op_increment
suffix:semicolon
r_return
suffix:semicolon
)brace
id|soft
op_assign
(paren
r_struct
id|ClientData
op_star
)paren
id|skb-&gt;data
suffix:semicolon
id|skb-&gt;len
op_assign
r_sizeof
(paren
r_struct
id|ClientData
)paren
suffix:semicolon
id|skb-&gt;dev
op_assign
id|dev
suffix:semicolon
id|memcpy
c_func
(paren
(paren
id|u_char
op_star
)paren
id|soft
op_plus
id|EXTRA_CLIENTDATA
comma
(paren
id|u_char
op_star
)paren
id|arcsoft
op_plus
id|EXTRA_CLIENTDATA
comma
r_sizeof
(paren
r_struct
id|ClientData
)paren
op_minus
id|EXTRA_CLIENTDATA
)paren
suffix:semicolon
id|soft-&gt;split_flag
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* final packet won&squot;t be split */
)brace
r_else
multiline_comment|/* not first packet */
(brace
r_int
id|packetnum
op_assign
(paren
(paren
r_int
)paren
id|arcsoft-&gt;split_flag
op_rshift
l_int|1
)paren
op_plus
l_int|1
suffix:semicolon
multiline_comment|/* if we&squot;re not assembling, there&squot;s no point&n;&t;&t;&t; * trying to continue.&n;&t;&t;&t; */
r_if
c_cond
(paren
op_logical_neg
id|in-&gt;skb
)paren
(brace
id|BUGMSG
c_func
(paren
id|D_EXTRA
comma
l_string|&quot;can&squot;t continue split without starting first! (splitflag=%d, seq=%d)&bslash;n&quot;
comma
id|arcsoft-&gt;split_flag
comma
id|arcsoft-&gt;sequence
)paren
suffix:semicolon
id|lp-&gt;stats.rx_errors
op_increment
suffix:semicolon
id|lp-&gt;stats.rx_missed_errors
op_increment
suffix:semicolon
r_return
suffix:semicolon
)brace
id|in-&gt;lastpacket
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|packetnum
op_ne
id|in-&gt;lastpacket
)paren
multiline_comment|/* not the right flag! */
(brace
multiline_comment|/* harmless duplicate? ignore. */
r_if
c_cond
(paren
id|packetnum
op_le
id|in-&gt;lastpacket
op_minus
l_int|1
)paren
(brace
id|BUGMSG
c_func
(paren
id|D_EXTRA
comma
l_string|&quot;duplicate splitpacket ignored! (splitflag=%d)&bslash;n&quot;
comma
id|arcsoft-&gt;split_flag
)paren
suffix:semicolon
id|lp-&gt;stats.rx_errors
op_increment
suffix:semicolon
id|lp-&gt;stats.rx_frame_errors
op_increment
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/* &quot;bad&quot; duplicate, kill reassembly */
id|BUGMSG
c_func
(paren
id|D_EXTRA
comma
l_string|&quot;out-of-order splitpacket, reassembly (seq=%d) aborted (splitflag=%d, seq=%d)&bslash;n&quot;
comma
id|in-&gt;sequence
comma
id|arcsoft-&gt;split_flag
comma
id|arcsoft-&gt;sequence
)paren
suffix:semicolon
id|kfree_skb
c_func
(paren
id|in-&gt;skb
comma
id|FREE_WRITE
)paren
suffix:semicolon
id|in-&gt;skb
op_assign
l_int|NULL
suffix:semicolon
id|lp-&gt;stats.rx_errors
op_increment
suffix:semicolon
id|lp-&gt;stats.rx_missed_errors
op_increment
suffix:semicolon
id|in-&gt;lastpacket
op_assign
id|in-&gt;numpackets
op_assign
l_int|0
suffix:semicolon
r_return
suffix:semicolon
)brace
id|soft
op_assign
(paren
r_struct
id|ClientData
op_star
)paren
id|in-&gt;skb-&gt;data
suffix:semicolon
)brace
id|skb
op_assign
id|in-&gt;skb
suffix:semicolon
id|memcpy
c_func
(paren
id|skb-&gt;data
op_plus
id|skb-&gt;len
comma
(paren
id|u_char
op_star
)paren
id|arcsoft
op_plus
r_sizeof
(paren
r_struct
id|ClientData
)paren
comma
id|length
op_minus
r_sizeof
(paren
r_struct
id|ClientData
)paren
)paren
suffix:semicolon
id|skb-&gt;len
op_add_assign
id|length
op_minus
r_sizeof
(paren
r_struct
id|ClientData
)paren
suffix:semicolon
id|soft-&gt;daddr
op_assign
id|daddr
suffix:semicolon
id|soft-&gt;saddr
op_assign
id|saddr
suffix:semicolon
multiline_comment|/* are we done? */
r_if
c_cond
(paren
id|in-&gt;lastpacket
op_eq
id|in-&gt;numpackets
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|skb
op_logical_or
op_logical_neg
id|in-&gt;skb
)paren
(brace
id|BUGMSG
c_func
(paren
id|D_NORMAL
comma
l_string|&quot;?!? done reassembling packet, no skb? (skb=%ph, in-&gt;skb=%ph)&bslash;n&quot;
comma
id|skb
comma
id|in-&gt;skb
)paren
suffix:semicolon
)brace
r_else
(brace
id|in-&gt;skb
op_assign
l_int|NULL
suffix:semicolon
id|in-&gt;lastpacket
op_assign
id|in-&gt;numpackets
op_assign
l_int|0
suffix:semicolon
id|BUGLVL
c_func
(paren
id|D_SKB
)paren
id|arcnet_dump_skb
c_func
(paren
id|dev
comma
id|skb
comma
l_string|&quot;rx&quot;
)paren
suffix:semicolon
id|skb-&gt;protocol
op_assign
id|arcnetA_type_trans
c_func
(paren
id|skb
comma
id|dev
)paren
suffix:semicolon
id|netif_rx
c_func
(paren
id|skb
)paren
suffix:semicolon
)brace
)brace
)brace
)brace
multiline_comment|/****************************************************************************&n; *                                                                          *&n; * Miscellaneous routines                                                   *&n; *                                                                          *&n; ****************************************************************************/
multiline_comment|/* Get the current statistics.&t;This may be called with the card open or&n; * closed.&n; */
DECL|function|arcnet_get_stats
r_static
r_struct
id|net_device_stats
op_star
id|arcnet_get_stats
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
r_struct
id|arcnet_local
op_star
id|lp
op_assign
(paren
r_struct
id|arcnet_local
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_return
op_amp
id|lp-&gt;stats
suffix:semicolon
)brace
macro_line|#if 0&t;/* standard ARCnet cards have no promiscuous mode */
multiline_comment|/* Set or clear the multicast filter for this adaptor.&n; * num_addrs == -1&t;Promiscuous mode, receive all packets&n; * num_addrs == 0&t;Normal mode, clear multicast list&n; * num_addrs &gt; 0&t;Multicast mode, receive normal and MC packets, and do&n; *&t;&t;&t;best-effort filtering.&n; */
r_static
r_void
id|set_multicast_list
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
r_if
c_cond
(paren
id|num_addrs
)paren
(brace
multiline_comment|/* Enable promiscuous mode */
)brace
r_else
multiline_comment|/* Disable promiscuous mode, use normal mode */
)brace
macro_line|#endif
multiline_comment|/* Create the ARCnet ClientData header for an arbitrary protocol layer&n; *&n; * saddr=NULL&t;means use device source address (always will anyway)&n; * daddr=NULL&t;means leave destination address (eg unresolved arp)&n; */
DECL|function|arcnetA_header
r_int
id|arcnetA_header
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|device
op_star
id|dev
comma
r_int
r_int
id|type
comma
r_void
op_star
id|daddr
comma
r_void
op_star
id|saddr
comma
r_int
id|len
)paren
(brace
r_struct
id|ClientData
op_star
id|head
op_assign
(paren
r_struct
id|ClientData
op_star
)paren
id|skb_push
c_func
(paren
id|skb
comma
id|dev-&gt;hard_header_len
)paren
suffix:semicolon
r_struct
id|arcnet_local
op_star
id|lp
op_assign
(paren
r_struct
id|arcnet_local
op_star
)paren
(paren
id|dev-&gt;priv
)paren
suffix:semicolon
id|BUGMSG
c_func
(paren
id|D_DURING
comma
l_string|&quot;create header from %d to %d; protocol %d (%Xh); size %u.&bslash;n&quot;
comma
id|saddr
ques
c_cond
op_star
(paren
id|u_char
op_star
)paren
id|saddr
suffix:colon
op_minus
l_int|1
comma
id|daddr
ques
c_cond
op_star
(paren
id|u_char
op_star
)paren
id|daddr
suffix:colon
op_minus
l_int|1
comma
id|type
comma
id|type
comma
id|len
)paren
suffix:semicolon
multiline_comment|/* set the protocol ID according to RFC1201 */
r_switch
c_cond
(paren
id|type
)paren
(brace
r_case
id|ETH_P_IP
suffix:colon
id|head-&gt;protocol_id
op_assign
id|ARC_P_IP
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ETH_P_ARP
suffix:colon
id|head-&gt;protocol_id
op_assign
id|ARC_P_ARP
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ETH_P_RARP
suffix:colon
id|head-&gt;protocol_id
op_assign
id|ARC_P_RARP
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ETH_P_IPX
suffix:colon
r_case
id|ETH_P_802_3
suffix:colon
r_case
id|ETH_P_802_2
suffix:colon
id|head-&gt;protocol_id
op_assign
id|ARC_P_IPX
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ETH_P_ATALK
suffix:colon
id|head-&gt;protocol_id
op_assign
id|ARC_P_ATALK
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|BUGMSG
c_func
(paren
id|D_NORMAL
comma
l_string|&quot;I don&squot;t understand protocol %d (%Xh)&bslash;n&quot;
comma
id|type
comma
id|type
)paren
suffix:semicolon
id|lp-&gt;stats.tx_errors
op_increment
suffix:semicolon
id|lp-&gt;stats.tx_aborted_errors
op_increment
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * Set the source hardware address.&n;&t; *&n;&t; * This is pretty pointless for most purposes, but it can help&n;&t; * in debugging.  saddr is stored in the ClientData header and&n;&t; * removed before sending the packet (since ARCnet does not allow&n;&t; * us to change the source address in the actual packet sent)&n;&t; */
r_if
c_cond
(paren
id|saddr
)paren
(brace
id|head-&gt;saddr
op_assign
(paren
(paren
id|u_char
op_star
)paren
id|saddr
)paren
(braket
l_int|0
)braket
suffix:semicolon
)brace
r_else
id|head-&gt;saddr
op_assign
(paren
(paren
id|u_char
op_star
)paren
(paren
id|dev-&gt;dev_addr
)paren
)paren
(braket
l_int|0
)braket
suffix:semicolon
id|head-&gt;split_flag
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* split packets are done elsewhere */
id|head-&gt;sequence
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* so are sequence numbers */
multiline_comment|/* supposedly if daddr is NULL, we should ignore it... */
r_if
c_cond
(paren
id|daddr
)paren
(brace
id|head-&gt;daddr
op_assign
(paren
(paren
id|u_char
op_star
)paren
id|daddr
)paren
(braket
l_int|0
)braket
suffix:semicolon
r_return
id|dev-&gt;hard_header_len
suffix:semicolon
)brace
r_else
id|head-&gt;daddr
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* better fill one in anyway */
r_return
op_minus
id|dev-&gt;hard_header_len
suffix:semicolon
)brace
multiline_comment|/* Rebuild the ARCnet ClientData header. This is called after an ARP&n; * (or in future other address resolution) has completed on this&n; * sk_buff. We now let ARP fill in the other fields.&n; */
DECL|function|arcnetA_rebuild_header
r_int
id|arcnetA_rebuild_header
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
)paren
(brace
r_struct
id|ClientData
op_star
id|head
op_assign
(paren
r_struct
id|ClientData
op_star
)paren
id|skb-&gt;data
suffix:semicolon
r_struct
id|device
op_star
id|dev
op_assign
id|skb-&gt;dev
suffix:semicolon
r_struct
id|arcnet_local
op_star
id|lp
op_assign
(paren
r_struct
id|arcnet_local
op_star
)paren
(paren
id|dev-&gt;priv
)paren
suffix:semicolon
r_int
id|status
suffix:semicolon
multiline_comment|/*&n;&t; * Only ARP and IP are currently supported&n;&t; *&n;&t; * FIXME: Anyone want to spec IPv6 over ARCnet ?&n;&t; */
r_if
c_cond
(paren
id|head-&gt;protocol_id
op_ne
id|ARC_P_IP
)paren
(brace
id|BUGMSG
c_func
(paren
id|D_NORMAL
comma
l_string|&quot;I don&squot;t understand protocol type %d (%Xh) addresses!&bslash;n&quot;
comma
id|head-&gt;protocol_id
comma
id|head-&gt;protocol_id
)paren
suffix:semicolon
id|lp-&gt;stats.tx_errors
op_increment
suffix:semicolon
id|lp-&gt;stats.tx_aborted_errors
op_increment
suffix:semicolon
id|head-&gt;daddr
op_assign
l_int|0
suffix:semicolon
multiline_comment|/*memcpy(eth-&gt;h_source, dev-&gt;dev_addr, dev-&gt;addr_len);*/
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * Try to get ARP to resolve the header.&n;&t; */
macro_line|#ifdef CONFIG_INET
id|BUGMSG
c_func
(paren
id|D_DURING
comma
l_string|&quot;rebuild header from %d to %d; protocol %Xh&bslash;n&quot;
comma
id|head-&gt;saddr
comma
id|head-&gt;daddr
comma
id|head-&gt;protocol_id
)paren
suffix:semicolon
id|status
op_assign
id|arp_find
c_func
(paren
op_amp
(paren
id|head-&gt;daddr
)paren
comma
id|skb
)paren
ques
c_cond
l_int|1
suffix:colon
l_int|0
suffix:semicolon
id|BUGMSG
c_func
(paren
id|D_DURING
comma
l_string|&quot; rebuilt: from %d to %d; protocol %Xh&bslash;n&quot;
comma
id|head-&gt;saddr
comma
id|head-&gt;daddr
comma
id|head-&gt;protocol_id
)paren
suffix:semicolon
r_return
id|status
suffix:semicolon
macro_line|#else
r_return
l_int|0
suffix:semicolon
macro_line|#endif
)brace
multiline_comment|/* Determine a packet&squot;s protocol ID.&n; *&n; * With ARCnet we have to convert everything to Ethernet-style stuff.&n; */
DECL|function|arcnetA_type_trans
r_int
r_int
id|arcnetA_type_trans
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|device
op_star
id|dev
)paren
(brace
r_struct
id|ClientData
op_star
id|head
suffix:semicolon
r_struct
id|arcnet_local
op_star
id|lp
op_assign
(paren
r_struct
id|arcnet_local
op_star
)paren
(paren
id|dev-&gt;priv
)paren
suffix:semicolon
multiline_comment|/* Pull off the arcnet header. */
id|skb-&gt;mac.raw
op_assign
id|skb-&gt;data
suffix:semicolon
id|skb_pull
c_func
(paren
id|skb
comma
id|dev-&gt;hard_header_len
)paren
suffix:semicolon
id|head
op_assign
(paren
r_struct
id|ClientData
op_star
)paren
id|skb-&gt;mac.raw
suffix:semicolon
r_if
c_cond
(paren
id|head-&gt;daddr
op_eq
l_int|0
)paren
id|skb-&gt;pkt_type
op_assign
id|PACKET_BROADCAST
suffix:semicolon
r_else
r_if
c_cond
(paren
id|dev-&gt;flags
op_amp
id|IFF_PROMISC
)paren
(brace
multiline_comment|/* if we&squot;re not sending to ourselves :) */
r_if
c_cond
(paren
id|head-&gt;daddr
op_ne
id|dev-&gt;dev_addr
(braket
l_int|0
)braket
)paren
id|skb-&gt;pkt_type
op_assign
id|PACKET_OTHERHOST
suffix:semicolon
)brace
multiline_comment|/* now return the protocol number */
r_switch
c_cond
(paren
id|head-&gt;protocol_id
)paren
(brace
r_case
id|ARC_P_IP
suffix:colon
r_return
id|htons
c_func
(paren
id|ETH_P_IP
)paren
suffix:semicolon
r_case
id|ARC_P_ARP
suffix:colon
r_return
id|htons
c_func
(paren
id|ETH_P_ARP
)paren
suffix:semicolon
r_case
id|ARC_P_RARP
suffix:colon
r_return
id|htons
c_func
(paren
id|ETH_P_RARP
)paren
suffix:semicolon
r_case
id|ARC_P_IPX
suffix:colon
r_case
id|ARC_P_NOVELL_EC
suffix:colon
r_return
id|htons
c_func
(paren
id|ETH_P_802_3
)paren
suffix:semicolon
r_default
suffix:colon
id|lp-&gt;stats.rx_errors
op_increment
suffix:semicolon
id|lp-&gt;stats.rx_crc_errors
op_increment
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_return
id|htons
c_func
(paren
id|ETH_P_IP
)paren
suffix:semicolon
)brace
macro_line|#ifdef CONFIG_ARCNET_ETH
multiline_comment|/****************************************************************************&n; *                                                                          *&n; * Ethernet-Encap Support                                                   *&n; *                                                                          *&n; ****************************************************************************/
multiline_comment|/* Initialize the arc0e device.&n; */
DECL|function|arcnetE_init
r_static
r_int
id|arcnetE_init
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
r_struct
id|arcnet_local
op_star
id|lp
op_assign
(paren
r_struct
id|arcnet_local
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|ether_setup
c_func
(paren
id|dev
)paren
suffix:semicolon
multiline_comment|/* we&squot;re emulating ether here, not ARCnet */
id|dev-&gt;dev_addr
(braket
l_int|0
)braket
op_assign
l_int|0
suffix:semicolon
id|dev-&gt;dev_addr
(braket
l_int|5
)braket
op_assign
id|lp-&gt;stationid
suffix:semicolon
id|dev-&gt;mtu
op_assign
l_int|512
op_minus
r_sizeof
(paren
r_struct
id|HardHeader
)paren
op_minus
id|dev-&gt;hard_header_len
op_minus
l_int|1
suffix:semicolon
id|dev-&gt;open
op_assign
id|arcnetE_open_close
suffix:semicolon
id|dev-&gt;stop
op_assign
id|arcnetE_open_close
suffix:semicolon
id|dev-&gt;hard_start_xmit
op_assign
id|arcnetE_send_packet
suffix:semicolon
id|BUGMSG
c_func
(paren
id|D_NORMAL
comma
l_string|&quot;ARCnet Ethernet-Encap protocol initialized.&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Bring up/down the arc0e device - we don&squot;t actually have to do anything,&n; * since our parent arc0 handles the card I/O itself.&n; */
DECL|function|arcnetE_open_close
r_static
r_int
id|arcnetE_open_close
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Called by the kernel in order to transmit an ethernet-type packet.&n; */
r_static
r_int
DECL|function|arcnetE_send_packet
id|arcnetE_send_packet
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|device
op_star
id|dev
)paren
(brace
r_struct
id|arcnet_local
op_star
id|lp
op_assign
(paren
r_struct
id|arcnet_local
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_int
id|ioaddr
op_assign
id|IOADDR
comma
id|bad
suffix:semicolon
r_union
id|ArcPacket
op_star
id|arcpacket
op_assign
(paren
r_union
id|ArcPacket
op_star
)paren
id|phys_to_virt
c_func
(paren
id|dev-&gt;mem_start
op_plus
l_int|512
op_star
(paren
id|lp-&gt;txbuf
op_xor
l_int|1
)paren
)paren
suffix:semicolon
id|u_char
op_star
id|arcsoft
comma
id|daddr
suffix:semicolon
r_int
id|offset
comma
id|length
op_assign
id|skb-&gt;len
op_plus
l_int|1
suffix:semicolon
id|lp-&gt;intx
op_increment
suffix:semicolon
id|bad
op_assign
id|arcnet_send_packet_bad
c_func
(paren
id|skb
comma
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|bad
)paren
(brace
id|lp-&gt;intx
op_decrement
suffix:semicolon
r_return
id|bad
suffix:semicolon
)brace
id|TBUSY
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|length
OG
id|XMTU
)paren
(brace
id|BUGMSG
c_func
(paren
id|D_NORMAL
comma
l_string|&quot;MTU must be &lt;= 493 for ethernet encap (length=%d).&bslash;n&quot;
comma
id|length
)paren
suffix:semicolon
id|BUGMSG
c_func
(paren
id|D_NORMAL
comma
l_string|&quot;transmit aborted.&bslash;n&quot;
)paren
suffix:semicolon
id|dev_kfree_skb
c_func
(paren
id|skb
comma
id|FREE_WRITE
)paren
suffix:semicolon
id|lp-&gt;intx
op_decrement
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|BUGMSG
c_func
(paren
id|D_DURING
comma
l_string|&quot;starting tx sequence...&bslash;n&quot;
)paren
suffix:semicolon
id|lp-&gt;txbuf
op_assign
id|lp-&gt;txbuf
op_xor
l_int|1
suffix:semicolon
multiline_comment|/* XOR with 1 to alternate btw 2 &amp; 3 */
macro_line|#ifndef SLOW_XMIT_COPY
multiline_comment|/* clean out the page to make debugging make more sense :) */
id|BUGLVL
c_func
(paren
id|D_DURING
)paren
id|memset_io
c_func
(paren
id|dev-&gt;mem_start
op_plus
id|lp-&gt;txbuf
op_star
l_int|512
comma
l_int|0x42
comma
l_int|512
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/* broadcasts have address FF:FF:FF:FF:FF:FF in etherspeak */
r_if
c_cond
(paren
(paren
(paren
r_struct
id|ethhdr
op_star
)paren
(paren
id|skb-&gt;data
)paren
)paren
op_member_access_from_pointer
id|h_dest
(braket
l_int|0
)braket
op_eq
l_int|0xFF
)paren
id|daddr
op_assign
id|arcpacket-&gt;hardheader.destination
op_assign
l_int|0
suffix:semicolon
r_else
id|daddr
op_assign
id|arcpacket-&gt;hardheader.destination
op_assign
(paren
(paren
r_struct
id|ethhdr
op_star
)paren
(paren
id|skb-&gt;data
)paren
)paren
op_member_access_from_pointer
id|h_dest
(braket
l_int|5
)braket
suffix:semicolon
multiline_comment|/* load packet into shared memory */
id|offset
op_assign
l_int|512
op_minus
id|length
suffix:semicolon
r_if
c_cond
(paren
id|length
OG
id|MTU
)paren
multiline_comment|/* long/exception packet */
(brace
r_if
c_cond
(paren
id|length
OL
id|MinTU
)paren
id|offset
op_sub_assign
l_int|3
suffix:semicolon
id|arcpacket-&gt;hardheader.offset1
op_assign
l_int|0
suffix:semicolon
id|arcpacket-&gt;hardheader.offset2
op_assign
id|offset
suffix:semicolon
)brace
r_else
multiline_comment|/* short packet */
(brace
id|arcpacket-&gt;hardheader.offset1
op_assign
(paren
id|offset
op_sub_assign
l_int|256
)paren
suffix:semicolon
)brace
id|BUGMSG
c_func
(paren
id|D_DURING
comma
l_string|&quot; length=%Xh, offset=%Xh, offset1=%Xh, offset2=%Xh&bslash;n&quot;
comma
id|length
comma
id|offset
comma
id|arcpacket-&gt;hardheader.offset1
comma
id|arcpacket-&gt;hardheader.offset2
)paren
suffix:semicolon
id|arcsoft
op_assign
op_amp
id|arcpacket-&gt;raw
(braket
id|offset
)braket
suffix:semicolon
id|arcsoft
(braket
l_int|0
)braket
op_assign
id|ARC_P_ETHER
suffix:semicolon
id|arcsoft
op_increment
suffix:semicolon
multiline_comment|/* copy the packet into ARCnet shmem&n;&t; *  - the first bytes of ClientData header are skipped&n;&t; */
id|BUGMSG
c_func
(paren
id|D_DURING
comma
l_string|&quot;ready to memcpy&bslash;n&quot;
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|arcsoft
comma
id|skb-&gt;data
comma
id|skb-&gt;len
)paren
suffix:semicolon
id|BUGMSG
c_func
(paren
id|D_DURING
comma
l_string|&quot;transmitting packet to station %02Xh (%d bytes)&bslash;n&quot;
comma
id|daddr
comma
id|length
)paren
suffix:semicolon
id|BUGLVL
c_func
(paren
id|D_TX
)paren
id|arcnet_dump_packet
c_func
(paren
id|dev
comma
id|arcpacket-&gt;raw
comma
id|length
op_ge
l_int|240
comma
l_string|&quot;tx&quot;
)paren
suffix:semicolon
id|lp-&gt;lastload_dest
op_assign
id|daddr
suffix:semicolon
id|lp-&gt;txready
op_assign
id|lp-&gt;txbuf
suffix:semicolon
multiline_comment|/* packet is ready for sending */
id|dev_kfree_skb
c_func
(paren
id|skb
comma
id|FREE_WRITE
)paren
suffix:semicolon
r_if
c_cond
(paren
id|arcnet_go_tx
c_func
(paren
id|dev
comma
l_int|1
)paren
)paren
(brace
multiline_comment|/* inform upper layers */
id|TBUSY
op_assign
l_int|0
suffix:semicolon
id|mark_bh
c_func
(paren
id|NET_BH
)paren
suffix:semicolon
)brace
id|dev-&gt;trans_start
op_assign
id|jiffies
suffix:semicolon
id|lp-&gt;intx
op_decrement
suffix:semicolon
multiline_comment|/* make sure we didn&squot;t ignore a TX IRQ while we were in here */
id|lp-&gt;intmask
op_or_assign
id|TXFREEflag
suffix:semicolon
id|SETMASK
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Packet receiver for ethernet-encap packets.&n; */
r_static
r_void
DECL|function|arcnetE_rx
id|arcnetE_rx
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
id|u_char
op_star
id|arcsoft
comma
r_int
id|length
comma
id|u_char
id|saddr
comma
id|u_char
id|daddr
)paren
(brace
r_struct
id|arcnet_local
op_star
id|lp
op_assign
(paren
r_struct
id|arcnet_local
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
id|BUGMSG
c_func
(paren
id|D_DURING
comma
l_string|&quot;it&squot;s an ethernet-encap packet (length=%d)&bslash;n&quot;
comma
id|length
)paren
suffix:semicolon
id|skb
op_assign
id|alloc_skb
c_func
(paren
id|length
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
id|skb
op_eq
l_int|NULL
)paren
(brace
id|BUGMSG
c_func
(paren
id|D_NORMAL
comma
l_string|&quot;Memory squeeze, dropping packet.&bslash;n&quot;
)paren
suffix:semicolon
id|lp-&gt;stats.rx_dropped
op_increment
suffix:semicolon
r_return
suffix:semicolon
)brace
id|skb-&gt;len
op_assign
id|length
suffix:semicolon
id|skb-&gt;dev
op_assign
id|dev
suffix:semicolon
id|memcpy
c_func
(paren
id|skb-&gt;data
comma
(paren
id|u_char
op_star
)paren
id|arcsoft
op_plus
l_int|1
comma
id|length
op_minus
l_int|1
)paren
suffix:semicolon
id|BUGLVL
c_func
(paren
id|D_SKB
)paren
id|arcnet_dump_skb
c_func
(paren
id|dev
comma
id|skb
comma
l_string|&quot;rx&quot;
)paren
suffix:semicolon
id|skb-&gt;protocol
op_assign
id|eth_type_trans
c_func
(paren
id|skb
comma
id|dev
)paren
suffix:semicolon
id|netif_rx
c_func
(paren
id|skb
)paren
suffix:semicolon
)brace
macro_line|#endif /* CONFIG_ARCNET_ETH */
macro_line|#ifdef CONFIG_ARCNET_1051
multiline_comment|/****************************************************************************&n; *                                                                          *&n; * RFC1051 Support                                                          *&n; *                                                                          *&n; ****************************************************************************/
multiline_comment|/* Initialize the arc0s device.&n; */
DECL|function|arcnetS_init
r_static
r_int
id|arcnetS_init
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
r_struct
id|arcnet_local
op_star
id|lp
op_assign
(paren
r_struct
id|arcnet_local
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|arcnet_setup
c_func
(paren
id|dev
)paren
suffix:semicolon
multiline_comment|/* And now fill particular fields with arcnet values */
id|dev-&gt;dev_addr
(braket
l_int|0
)braket
op_assign
id|lp-&gt;stationid
suffix:semicolon
id|dev-&gt;hard_header_len
op_assign
r_sizeof
(paren
r_struct
id|S_ClientData
)paren
suffix:semicolon
id|dev-&gt;mtu
op_assign
l_int|512
op_minus
r_sizeof
(paren
r_struct
id|HardHeader
)paren
op_minus
id|dev-&gt;hard_header_len
op_plus
id|S_EXTRA_CLIENTDATA
suffix:semicolon
id|dev-&gt;open
op_assign
id|arcnetS_open_close
suffix:semicolon
id|dev-&gt;stop
op_assign
id|arcnetS_open_close
suffix:semicolon
id|dev-&gt;hard_start_xmit
op_assign
id|arcnetS_send_packet
suffix:semicolon
id|dev-&gt;hard_header
op_assign
id|arcnetS_header
suffix:semicolon
id|dev-&gt;rebuild_header
op_assign
id|arcnetS_rebuild_header
suffix:semicolon
id|BUGMSG
c_func
(paren
id|D_NORMAL
comma
l_string|&quot;ARCnet RFC1051 (NetBSD, AmiTCP) protocol initialized.&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Bring up/down the arc0s device - we don&squot;t actually have to do anything,&n; * since our parent arc0 handles the card I/O itself.&n; */
DECL|function|arcnetS_open_close
r_static
r_int
id|arcnetS_open_close
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Called by the kernel in order to transmit an RFC1051-type packet.&n; */
r_static
r_int
DECL|function|arcnetS_send_packet
id|arcnetS_send_packet
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|device
op_star
id|dev
)paren
(brace
r_struct
id|arcnet_local
op_star
id|lp
op_assign
(paren
r_struct
id|arcnet_local
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_int
id|ioaddr
op_assign
id|IOADDR
comma
id|bad
comma
id|length
suffix:semicolon
r_struct
id|S_ClientData
op_star
id|hdr
op_assign
(paren
r_struct
id|S_ClientData
op_star
)paren
id|skb-&gt;data
suffix:semicolon
id|lp-&gt;intx
op_increment
suffix:semicolon
id|bad
op_assign
id|arcnet_send_packet_bad
c_func
(paren
id|skb
comma
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|bad
)paren
(brace
id|lp-&gt;intx
op_decrement
suffix:semicolon
r_return
id|bad
suffix:semicolon
)brace
id|TBUSY
op_assign
l_int|1
suffix:semicolon
id|length
op_assign
l_int|1
OL
id|skb-&gt;len
ques
c_cond
id|skb-&gt;len
suffix:colon
l_int|1
suffix:semicolon
id|BUGLVL
c_func
(paren
id|D_SKB
)paren
id|arcnet_dump_skb
c_func
(paren
id|dev
comma
id|skb
comma
l_string|&quot;tx&quot;
)paren
suffix:semicolon
multiline_comment|/* fits in one packet? */
r_if
c_cond
(paren
id|length
op_minus
id|S_EXTRA_CLIENTDATA
op_le
id|XMTU
)paren
(brace
id|arcnetAS_prepare_tx
c_func
(paren
id|dev
comma
id|skb-&gt;data
op_plus
id|S_EXTRA_CLIENTDATA
comma
r_sizeof
(paren
r_struct
id|S_ClientData
)paren
op_minus
id|S_EXTRA_CLIENTDATA
comma
id|skb-&gt;data
op_plus
r_sizeof
(paren
r_struct
id|S_ClientData
)paren
comma
id|length
op_minus
r_sizeof
(paren
r_struct
id|S_ClientData
)paren
comma
id|hdr-&gt;daddr
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* done right away */
id|dev_kfree_skb
c_func
(paren
id|skb
comma
id|FREE_WRITE
)paren
suffix:semicolon
r_if
c_cond
(paren
id|arcnet_go_tx
c_func
(paren
id|dev
comma
l_int|1
)paren
)paren
(brace
multiline_comment|/* inform upper layers */
id|TBUSY
op_assign
l_int|0
suffix:semicolon
id|mark_bh
c_func
(paren
id|NET_BH
)paren
suffix:semicolon
)brace
)brace
r_else
multiline_comment|/* too big for one - not accepted */
(brace
id|BUGMSG
c_func
(paren
id|D_NORMAL
comma
l_string|&quot;packet too long (length=%d)&bslash;n&quot;
comma
id|length
)paren
suffix:semicolon
id|dev_kfree_skb
c_func
(paren
id|skb
comma
id|FREE_WRITE
)paren
suffix:semicolon
id|lp-&gt;stats.tx_dropped
op_increment
suffix:semicolon
id|TBUSY
op_assign
l_int|0
suffix:semicolon
id|mark_bh
c_func
(paren
id|NET_BH
)paren
suffix:semicolon
)brace
id|dev-&gt;trans_start
op_assign
id|jiffies
suffix:semicolon
id|lp-&gt;intx
op_decrement
suffix:semicolon
multiline_comment|/* make sure we didn&squot;t ignore a TX IRQ while we were in here */
id|lp-&gt;intmask
op_or_assign
id|TXFREEflag
suffix:semicolon
id|SETMASK
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Packet receiver for RFC1051 packets;&n; */
r_static
r_void
DECL|function|arcnetS_rx
id|arcnetS_rx
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
id|u_char
op_star
id|buf
comma
r_int
id|length
comma
id|u_char
id|saddr
comma
id|u_char
id|daddr
)paren
(brace
r_struct
id|arcnet_local
op_star
id|lp
op_assign
(paren
r_struct
id|arcnet_local
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
r_struct
id|S_ClientData
op_star
id|arcsoft
comma
op_star
id|soft
suffix:semicolon
id|arcsoft
op_assign
(paren
r_struct
id|S_ClientData
op_star
)paren
(paren
id|buf
op_minus
id|S_EXTRA_CLIENTDATA
)paren
suffix:semicolon
id|length
op_add_assign
id|S_EXTRA_CLIENTDATA
suffix:semicolon
id|BUGMSG
c_func
(paren
id|D_DURING
comma
l_string|&quot;it&squot;s an RFC1051 packet (length=%d)&bslash;n&quot;
comma
id|length
)paren
suffix:semicolon
(brace
multiline_comment|/* was &quot;if not split&quot; in A protocol, S is never split */
id|skb
op_assign
id|alloc_skb
c_func
(paren
id|length
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
id|skb
op_eq
l_int|NULL
)paren
(brace
id|BUGMSG
c_func
(paren
id|D_NORMAL
comma
l_string|&quot;Memory squeeze, dropping packet.&bslash;n&quot;
)paren
suffix:semicolon
id|lp-&gt;stats.rx_dropped
op_increment
suffix:semicolon
r_return
suffix:semicolon
)brace
id|soft
op_assign
(paren
r_struct
id|S_ClientData
op_star
)paren
id|skb-&gt;data
suffix:semicolon
id|skb-&gt;len
op_assign
id|length
suffix:semicolon
id|memcpy
c_func
(paren
(paren
id|u_char
op_star
)paren
id|soft
op_plus
r_sizeof
(paren
r_struct
id|S_ClientData
)paren
op_minus
id|S_EXTRA_CLIENTDATA
comma
(paren
id|u_char
op_star
)paren
id|arcsoft
op_plus
r_sizeof
(paren
r_struct
id|S_ClientData
)paren
op_minus
id|S_EXTRA_CLIENTDATA
comma
id|length
op_minus
r_sizeof
(paren
r_struct
id|S_ClientData
)paren
op_plus
id|S_EXTRA_CLIENTDATA
)paren
suffix:semicolon
id|soft-&gt;protocol_id
op_assign
id|arcsoft-&gt;protocol_id
suffix:semicolon
id|soft-&gt;daddr
op_assign
id|daddr
suffix:semicolon
id|soft-&gt;saddr
op_assign
id|saddr
suffix:semicolon
id|skb-&gt;dev
op_assign
id|dev
suffix:semicolon
multiline_comment|/* is already lp-&gt;sdev */
id|BUGLVL
c_func
(paren
id|D_SKB
)paren
id|arcnet_dump_skb
c_func
(paren
id|dev
comma
id|skb
comma
l_string|&quot;rx&quot;
)paren
suffix:semicolon
id|skb-&gt;protocol
op_assign
id|arcnetS_type_trans
c_func
(paren
id|skb
comma
id|dev
)paren
suffix:semicolon
id|netif_rx
c_func
(paren
id|skb
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* Create the ARCnet ClientData header for an arbitrary protocol layer&n; *&n; * saddr=NULL&t;means use device source address (always will anyway)&n; * daddr=NULL&t;means leave destination address (eg unresolved arp)&n; */
DECL|function|arcnetS_header
r_int
id|arcnetS_header
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|device
op_star
id|dev
comma
r_int
r_int
id|type
comma
r_void
op_star
id|daddr
comma
r_void
op_star
id|saddr
comma
r_int
id|len
)paren
(brace
r_struct
id|S_ClientData
op_star
id|head
op_assign
(paren
r_struct
id|S_ClientData
op_star
)paren
id|skb_push
c_func
(paren
id|skb
comma
id|dev-&gt;hard_header_len
)paren
suffix:semicolon
r_struct
id|arcnet_local
op_star
id|lp
op_assign
(paren
r_struct
id|arcnet_local
op_star
)paren
(paren
id|dev-&gt;priv
)paren
suffix:semicolon
multiline_comment|/* set the protocol ID according to RFC1051 */
r_switch
c_cond
(paren
id|type
)paren
(brace
r_case
id|ETH_P_IP
suffix:colon
id|head-&gt;protocol_id
op_assign
id|ARC_P_IP_RFC1051
suffix:semicolon
id|BUGMSG
c_func
(paren
id|D_DURING
comma
l_string|&quot;S_header: IP_RFC1051 packet.&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ETH_P_ARP
suffix:colon
id|head-&gt;protocol_id
op_assign
id|ARC_P_ARP_RFC1051
suffix:semicolon
id|BUGMSG
c_func
(paren
id|D_DURING
comma
l_string|&quot;S_header: ARP_RFC1051 packet.&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|BUGMSG
c_func
(paren
id|D_NORMAL
comma
l_string|&quot;I don&squot;t understand protocol %d (%Xh)&bslash;n&quot;
comma
id|type
comma
id|type
)paren
suffix:semicolon
id|lp-&gt;stats.tx_errors
op_increment
suffix:semicolon
id|lp-&gt;stats.tx_aborted_errors
op_increment
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * Set the source hardware address.&n;&t; *&n;&t; * This is pretty pointless for most purposes, but it can help&n;&t; * in debugging.  saddr is stored in the ClientData header and&n;&t; * removed before sending the packet (since ARCnet does not allow&n;&t; * us to change the source address in the actual packet sent)&n;&t; */
r_if
c_cond
(paren
id|saddr
)paren
(brace
id|head-&gt;saddr
op_assign
(paren
(paren
id|u_char
op_star
)paren
id|saddr
)paren
(braket
l_int|0
)braket
suffix:semicolon
)brace
r_else
id|head-&gt;saddr
op_assign
(paren
(paren
id|u_char
op_star
)paren
(paren
id|dev-&gt;dev_addr
)paren
)paren
(braket
l_int|0
)braket
suffix:semicolon
multiline_comment|/* supposedly if daddr is NULL, we should ignore it... */
r_if
c_cond
(paren
id|daddr
)paren
(brace
id|head-&gt;daddr
op_assign
(paren
(paren
id|u_char
op_star
)paren
id|daddr
)paren
(braket
l_int|0
)braket
suffix:semicolon
r_return
id|dev-&gt;hard_header_len
suffix:semicolon
)brace
r_else
id|head-&gt;daddr
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* better fill one in anyway */
r_return
op_minus
id|dev-&gt;hard_header_len
suffix:semicolon
)brace
multiline_comment|/* Rebuild the ARCnet ClientData header. This is called after an ARP&n; * (or in future other address resolution) has completed on this&n; * sk_buff. We now let ARP fill in the other fields.&n; */
DECL|function|arcnetS_rebuild_header
r_int
id|arcnetS_rebuild_header
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
)paren
(brace
r_struct
id|device
op_star
id|dev
op_assign
id|skb-&gt;dev
suffix:semicolon
r_struct
id|S_ClientData
op_star
id|head
op_assign
(paren
r_struct
id|S_ClientData
op_star
)paren
id|skb-&gt;data
suffix:semicolon
r_struct
id|arcnet_local
op_star
id|lp
op_assign
(paren
r_struct
id|arcnet_local
op_star
)paren
(paren
id|dev-&gt;priv
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Only ARP and IP are currently supported&n;&t; */
r_if
c_cond
(paren
id|head-&gt;protocol_id
op_ne
id|ARC_P_IP_RFC1051
)paren
(brace
id|BUGMSG
c_func
(paren
id|D_NORMAL
comma
l_string|&quot;I don&squot;t understand protocol type %d (%Xh) addresses!&bslash;n&quot;
comma
id|head-&gt;protocol_id
comma
id|head-&gt;protocol_id
)paren
suffix:semicolon
id|lp-&gt;stats.tx_errors
op_increment
suffix:semicolon
id|lp-&gt;stats.tx_aborted_errors
op_increment
suffix:semicolon
id|head-&gt;daddr
op_assign
l_int|0
suffix:semicolon
multiline_comment|/*memcpy(eth-&gt;h_source, dev-&gt;dev_addr, dev-&gt;addr_len);*/
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * Try to get ARP to resolve the header.&n;&t; */
macro_line|#ifdef CONFIG_INET
r_return
id|arp_find
c_func
(paren
op_amp
(paren
id|head-&gt;daddr
)paren
comma
id|skb
)paren
ques
c_cond
l_int|1
suffix:colon
l_int|0
suffix:semicolon
macro_line|#else
r_return
l_int|0
suffix:semicolon
macro_line|#endif
)brace
multiline_comment|/* Determine a packet&squot;s protocol ID.&n; *&n; * With ARCnet we have to convert everything to Ethernet-style stuff.&n; */
DECL|function|arcnetS_type_trans
r_int
r_int
id|arcnetS_type_trans
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|device
op_star
id|dev
)paren
(brace
r_struct
id|S_ClientData
op_star
id|head
suffix:semicolon
r_struct
id|arcnet_local
op_star
id|lp
op_assign
(paren
r_struct
id|arcnet_local
op_star
)paren
(paren
id|dev-&gt;priv
)paren
suffix:semicolon
multiline_comment|/* Pull off the arcnet header. */
id|skb-&gt;mac.raw
op_assign
id|skb-&gt;data
suffix:semicolon
id|skb_pull
c_func
(paren
id|skb
comma
id|dev-&gt;hard_header_len
)paren
suffix:semicolon
id|head
op_assign
(paren
r_struct
id|S_ClientData
op_star
)paren
id|skb-&gt;mac.raw
suffix:semicolon
r_if
c_cond
(paren
id|head-&gt;daddr
op_eq
l_int|0
)paren
id|skb-&gt;pkt_type
op_assign
id|PACKET_BROADCAST
suffix:semicolon
r_else
r_if
c_cond
(paren
id|dev-&gt;flags
op_amp
id|IFF_PROMISC
)paren
(brace
multiline_comment|/* if we&squot;re not sending to ourselves :) */
r_if
c_cond
(paren
id|head-&gt;daddr
op_ne
id|dev-&gt;dev_addr
(braket
l_int|0
)braket
)paren
id|skb-&gt;pkt_type
op_assign
id|PACKET_OTHERHOST
suffix:semicolon
)brace
multiline_comment|/* now return the protocol number */
r_switch
c_cond
(paren
id|head-&gt;protocol_id
)paren
(brace
r_case
id|ARC_P_IP_RFC1051
suffix:colon
r_return
id|htons
c_func
(paren
id|ETH_P_IP
)paren
suffix:semicolon
r_case
id|ARC_P_ARP_RFC1051
suffix:colon
r_return
id|htons
c_func
(paren
id|ETH_P_ARP
)paren
suffix:semicolon
r_case
id|ARC_P_ATALK
suffix:colon
r_return
id|htons
c_func
(paren
id|ETH_P_ATALK
)paren
suffix:semicolon
multiline_comment|/* untested appletalk */
r_default
suffix:colon
id|lp-&gt;stats.rx_errors
op_increment
suffix:semicolon
id|lp-&gt;stats.rx_crc_errors
op_increment
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_return
id|htons
c_func
(paren
id|ETH_P_IP
)paren
suffix:semicolon
)brace
macro_line|#endif&t;/* CONFIG_ARCNET_1051 */
multiline_comment|/****************************************************************************&n; *                                                                          *&n; * Kernel Loadable Module Support                                           *&n; *                                                                          *&n; ****************************************************************************/
macro_line|#ifdef MODULE
DECL|variable|devicename
r_static
r_char
id|devicename
(braket
l_int|9
)braket
op_assign
l_string|&quot;&quot;
suffix:semicolon
DECL|variable|thiscard
r_static
r_struct
id|device
id|thiscard
op_assign
(brace
id|devicename
comma
multiline_comment|/* device name is inserted by linux/drivers/net/net_init.c */
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
multiline_comment|/* I/O address, IRQ */
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|NULL
comma
id|arcnet_probe
)brace
suffix:semicolon
DECL|variable|io
r_static
r_int
id|io
op_assign
l_int|0x0
suffix:semicolon
multiline_comment|/* &lt;--- EDIT THESE LINES FOR YOUR CONFIGURATION */
DECL|variable|irqnum
r_static
r_int
id|irqnum
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* or use the insmod io= irq= shmem= options */
DECL|variable|irq
r_static
r_int
id|irq
op_assign
l_int|0
suffix:semicolon
DECL|variable|shmem
r_static
r_int
id|shmem
op_assign
l_int|0
suffix:semicolon
DECL|variable|device
r_static
r_char
op_star
id|device
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/* use eg. device=&quot;arc1&quot; to change name */
id|MODULE_PARM
c_func
(paren
id|io
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|irqnum
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|shmem
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
macro_line|#ifdef RIM_I_MODE
DECL|variable|node
r_static
r_int
id|node
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* you must specify the node ID for RIM I cards */
macro_line|#endif
DECL|function|init_module
r_int
id|init_module
c_func
(paren
r_void
)paren
(brace
r_struct
id|device
op_star
id|dev
op_assign
op_amp
id|thiscard
suffix:semicolon
r_if
c_cond
(paren
id|device
)paren
id|strcpy
c_func
(paren
id|dev-&gt;name
comma
id|device
)paren
suffix:semicolon
macro_line|#ifndef CONFIG_ARCNET_ETHNAME
r_else
r_if
c_cond
(paren
op_logical_neg
id|dev-&gt;name
(braket
l_int|0
)braket
)paren
id|strcpy
c_func
(paren
id|dev-&gt;name
comma
l_string|&quot;arc0&quot;
)paren
suffix:semicolon
macro_line|#endif
macro_line|#ifdef RIM_I_MODE
r_if
c_cond
(paren
id|node
)paren
id|io
op_assign
id|node
suffix:semicolon
macro_line|#endif
id|dev-&gt;base_addr
op_assign
id|io
suffix:semicolon
r_if
c_cond
(paren
id|irq
)paren
id|irqnum
op_assign
id|irq
suffix:semicolon
id|dev-&gt;irq
op_assign
id|irqnum
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;irq
op_eq
l_int|2
)paren
id|dev-&gt;irq
op_assign
l_int|9
suffix:semicolon
r_if
c_cond
(paren
id|shmem
)paren
(brace
id|dev-&gt;mem_start
op_assign
id|shmem
suffix:semicolon
id|dev-&gt;mem_end
op_assign
id|thiscard.mem_start
op_plus
l_int|512
op_star
l_int|4
op_minus
l_int|1
suffix:semicolon
id|dev-&gt;rmem_start
op_assign
id|thiscard.mem_start
op_plus
l_int|512
op_star
l_int|0
suffix:semicolon
id|dev-&gt;rmem_end
op_assign
id|thiscard.mem_start
op_plus
l_int|512
op_star
l_int|2
op_minus
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|register_netdev
c_func
(paren
id|dev
)paren
op_ne
l_int|0
)paren
r_return
op_minus
id|EIO
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|cleanup_module
r_void
id|cleanup_module
c_func
(paren
r_void
)paren
(brace
r_struct
id|device
op_star
id|dev
op_assign
op_amp
id|thiscard
suffix:semicolon
r_int
id|ioaddr
op_assign
id|IOADDR
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;start
)paren
id|arcnet_close
c_func
(paren
id|dev
)paren
suffix:semicolon
multiline_comment|/* Flush TX and disable RX */
r_if
c_cond
(paren
id|ioaddr
)paren
(brace
id|AINTMASK
c_func
(paren
l_int|0
)paren
suffix:semicolon
multiline_comment|/* disable IRQ&squot;s */
id|ACOMMAND
c_func
(paren
id|NOTXcmd
)paren
suffix:semicolon
multiline_comment|/* stop transmit */
id|ACOMMAND
c_func
(paren
id|NORXcmd
)paren
suffix:semicolon
multiline_comment|/* disable receive */
)brace
r_if
c_cond
(paren
id|dev-&gt;irq
)paren
(brace
id|irq2dev_map
(braket
id|dev-&gt;irq
)braket
op_assign
l_int|NULL
suffix:semicolon
id|free_irq
c_func
(paren
id|dev-&gt;irq
comma
l_int|NULL
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|dev-&gt;base_addr
)paren
id|RELEASE_REGION
c_func
(paren
id|dev-&gt;base_addr
comma
id|ARCNET_TOTAL_SIZE
)paren
suffix:semicolon
id|unregister_netdev
c_func
(paren
id|dev
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|dev-&gt;priv
)paren
suffix:semicolon
id|dev-&gt;priv
op_assign
l_int|NULL
suffix:semicolon
)brace
macro_line|#endif /* MODULE */
eof
