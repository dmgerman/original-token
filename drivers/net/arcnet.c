multiline_comment|/* arcnet.c&n;&t;Written 1994-1996 by Avery Pennarun,&n;&t;derived from skeleton.c by Donald Becker.&n;&n;&t;Contact Avery at: apenwarr@foxnet.net or&n;&t;RR #5 Pole Line Road, Thunder Bay, ON, Canada P7C 5M9&n;&t;&n;&t;**********************&n;&t;&n;&t;The original copyright was as follows:&n;&n;&t;skeleton.c Written 1993 by Donald Becker.&n;&t;Copyright 1993 United States Government as represented by the&n;        Director, National Security Agency.  This software may only be used&n;        and distributed according to the terms of the GNU Public License as&n;        modified by SRC, incorporated herein by reference.&n;         &n;&t;**********************&n;&t;&n;&t;This is ONLY A SUMMARY.  The complete ChangeLog is available in&n;&t;the full Linux-ARCnet package.&n;&n;&t;v2.30 ALPHA (96/01/10)&n;&t;  - Abandoned support for Linux 1.2 to simplify coding and allow me&n;&t;    to take advantage of new features in 1.3.&n;&t;  - Updated cabling/jumpers documentation with MUCH information that&n;&t;    people have recently (and in some cases, not so recently) sent&n;&t;    me.  I don&squot;t mind writing documentation, but the jumpers&n;&t;    database is REALLY starting to get dull.&n;&t;  - Autoprobing works as a module now - but ONLY with my fix to&n;&t;    register_netdev and unregister_netdev.  It&squot;s also much faster,&n;&t;    and uses the &quot;new-style&quot; IRQ autoprobe routines.  Autoprobe is&n;&t;    still a horrible mess and will be cleaned up further as time&n;&t;    passes.&n;&t;    &n;&t;v2.22 (95/12/08)&n;&t;  - Major cleanups, speedups, and better code-sharing.&n;&t;  - Eliminated/changed many useless/meaningless/scary debug messages&n;&t;    (and, in most cases, the bugs that caused them).&n;&t;  - Better IPX support.&n;&t;  - lp-&gt;stats updated properly.&n;&t;  - RECON checking now by default only bugs you if there are an&n;&t;    excessive number (ie. your cable is probably broken).&n;&t;  - New RFC1051-compliant &quot;arc0s&quot; virtual device by Tomasz&n;&t;    Motylewski.&n;&t;  - Excess debug messages can be compiled out for maximum&n;&t;    efficiency.&n;&n;&t;v2.00 (95/09/06)&n;&t;  - ARCnet RECON messages are now detected and logged.  These occur&n;&t;    when a new computer is powered up on the network, or in a&n;&t;    constant stream when the network cable is broken.  Thanks to&n;&t;    Tomasz Motylewski for this.  You must have D_EXTRA enabled&n;&t;    if you want these messages sent to syslog, otherwise they will&n;&t;    only show up in the network statistics (/proc/net/dev).&n;&t;  - The TX Acknowledge flag is now checked, and a log message is sent&n;&t;    if a completed transmit is not ACK&squot;d.  (I have yet to have this&n;&t;    happen to me.)&n;&t;  - Debug levels are now completely different.  See the README.&n;&t;  - Many code cleanups, with several no-longer-necessary and some&n;&t;    completely useless options removed.&n;&t;  - Multiprotocol support.  You can now use the &quot;arc0e&quot; device to&n;&t;    send &quot;Ethernet-Encapsulation&quot; packets, which are compatible with&n;&t;    Windows for Workgroups and LAN Manager, and possibly other&n;&t;    software.  See the README for more information.&n;&t;  - Documentation updates and improvements.&n;&t;  &n;&t;v1.02 (95/06/21)&n;          - A fix to make &quot;exception&quot; packets sent from Linux receivable&n;&t;    on other systems.  (The protocol_id byte was sometimes being set&n;&t;    incorrectly, and Linux wasn&squot;t checking it on receive so it&n;&t;    didn&squot;t show up)&n;&n;&t;v1.01 (95/03/24)&n;&t;  - Fixed some IPX-related bugs. (Thanks to Tomasz Motylewski&n;            &lt;motyl@tichy.ch.uj.edu.pl&gt; for the patches to make arcnet work&n;            with dosemu!)&n;            &n;&t;v1.00 (95/02/15)&n;&t;  - Initial non-alpha release.&n;&t;&n;         &n;&t;TO DO: (it it just me, or does this list only get longer?)&n;&t;&n;         - Test in systems with NON-ARCnet network cards, just to see if&n;           autoprobe kills anything.  Currently, we do cause some NE2000&squot;s&n;           to die.  Autoprobe is also way too slow and verbose, particularly&n;           if there aren&squot;t any ARCnet cards in the system.&n;         - Rewrite autoprobe.  Try the Linux-generic-autoirq function instead&n;           of the net-specific one.&n;         - Make sure RESET flag is cleared during an IRQ even if dev-&gt;start==0;&n;           mainly a portability fix.  This will confuse autoprobe a bit, so&n;           test that too.&n;         - What about cards with shared memory that can be &quot;turned off?&quot;&n;           (or that have none at all, like the SMC PC500longboard)&n;         - Autoconfigure PDI5xxPlus cards. (I now have a PDI508Plus to play&n;           with temporarily)&n;         - Try to implement promiscuous (receive-all-packets) mode available&n;           on some newer cards with COM20020 and similar chips.  I don&squot;t have&n;           one, but SMC sent me the specs.&n;         - Add support for the new 1.3.x IP header cache features.&n;         - Support printk&squot;s priority levels.&n;         - Make arcnetE_send_packet use arcnet_prepare_tx for loading the&n;           packet into ARCnet memory.&n;         - Move the SKB and memory dump code into separate functions.&n;         - ATA protocol support?? &n;         - VINES TCP/IP encapsulation?? (info needed)&n;&n;           &n;&t;Sources:&n;&t; - Crynwr arcnet.com/arcether.com packet drivers.&n;&t; - arcnet.c v0.00 dated 1/1/94 and apparently by&n;&t; &t;Donald Becker - it didn&squot;t work :)&n;&t; - skeleton.c v0.05 dated 11/16/93 by Donald Becker&n;&t; &t;(from Linux Kernel 1.1.45)&n;&t; - RFC&squot;s 1201 and 1051 - re: TCP/IP over ARCnet&n;&t; - The official ARCnet COM9026 data sheets (!) thanks to Ken&n;&t;&t;Cornetet &lt;kcornete@nyx10.cs.du.edu&gt;&n;&t; - Information on some more obscure ARCnet controller chips, thanks&n;&t;   to the nice people at SMC.&n;&t; - net/inet/eth.c (from kernel 1.1.50) for header-building info.&n;&t; - Alternate Linux ARCnet source by V.Shergin &lt;vsher@sao.stavropol.su&gt;&n;&t; - Textual information and more alternate source from Joachim Koenig&n;&t; &t;&lt;jojo@repas.de&gt;&n;*/
DECL|variable|version
r_static
r_const
r_char
op_star
id|version
op_assign
l_string|&quot;arcnet.c: v2.30 ALPHA 96/01/10 Avery Pennarun &lt;apenwarr@foxnet.net&gt;&bslash;n&quot;
suffix:semicolon
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/version.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/fcntl.h&gt;
macro_line|#include &lt;linux/interrupt.h&gt;
macro_line|#include &lt;linux/ptrace.h&gt;
macro_line|#include &lt;linux/ioport.h&gt;
macro_line|#include &lt;linux/in.h&gt;
macro_line|#include &lt;linux/malloc.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/timer.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;linux/if_arp.h&gt;
macro_line|#include &lt;linux/netdevice.h&gt;
macro_line|#include &lt;linux/etherdevice.h&gt;
macro_line|#include &lt;linux/skbuff.h&gt;
macro_line|#include &lt;asm/system.h&gt;
macro_line|#include &lt;asm/bitops.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/dma.h&gt;
macro_line|#include &lt;net/arp.h&gt;
multiline_comment|/**************************************************************************/
multiline_comment|/* The card sends the reconfiguration signal when it loses the connection to&n; * the rest of its network. It is a &squot;Hello, is anybody there?&squot; cry.  This&n; * usually happens when a new computer on the network is powered on or when&n; * the cable is broken.&n; *&n; * Define DETECT_RECONFIGS if you want to detect network reconfigurations. &n; * Recons may be a real nuisance on a larger ARCnet network; if you are a&n; * network administrator you probably would like to count them. &n; * Reconfigurations will be recorded in stats.tx_carrier_errors (the last&n; * field of the /proc/net/dev file).&n; *&n; * Define SHOW_RECONFIGS if you really want to see a log message whenever&n; * a RECON occurs.&n; */
DECL|macro|DETECT_RECONFIGS
mdefine_line|#define DETECT_RECONFIGS
DECL|macro|SHOW_RECONFIGS
macro_line|#undef SHOW_RECONFIGS
multiline_comment|/* RECON_THRESHOLD is the maximum number of RECON messages to receive within&n; * one minute before printing a &quot;cabling problem&quot; warning.  You must have&n; * DETECT_RECONFIGS enabled if you want to use this.  The default value&n; * should be fine.&n; *&n; * After that, a &quot;cabling restored&quot; message will be printed on the next IRQ&n; * if no RECON messages have been received for 10 seconds.&n; *&n; * Do not define RECON_THRESHOLD at all if you want to disable this feature.&n; */
DECL|macro|RECON_THRESHOLD
mdefine_line|#define RECON_THRESHOLD 30
multiline_comment|/* Define this if you want to make sure transmitted packets are &quot;acknowledged&quot;&n; * by the destination host, as long as they&squot;re not to the broadcast address.&n; *&n; * That way, if one segment of a split packet doesn&squot;t get through, it can be&n; * resent immediately rather than confusing the other end.  We don&squot;t&n; * actually do that yet, though.&n; *&n; * Disable this to return to 1.02-style behaviour, if you have problems.&n; */
DECL|macro|VERIFY_ACK
mdefine_line|#define VERIFY_ACK
multiline_comment|/* Define this to the minimum &quot;timeout&quot; value.  If a transmit takes longer&n; * than TX_TIMEOUT jiffies, Linux will abort the TX and retry.  On a large&n; * network, or one with heavy network traffic, this timeout may need to be&n; * increased.&n; */
DECL|macro|TX_TIMEOUT
mdefine_line|#define TX_TIMEOUT 20
multiline_comment|/* Define this if you want to make it easier to use the &quot;call trace&quot; when&n; * a kernel NULL pointer assignment occurs.  Hopefully unnecessary, most of&n; * the time.  It will make all the function names (and other things) show&n; * up as kernel symbols.  (especially handy when using arcnet as a module)&n; */
DECL|macro|static
macro_line|#undef static
multiline_comment|/**************************************************************************/
multiline_comment|/* New debugging bitflags: each option can be enabled individually.&n; *&n; * These can be set while the driver is running by typing:&n; *&t;ifconfig arc0 down metric 1xxx HOSTNAME&n; *&t;&t;where 1xxx is 1000 + the debug level you want&n; *&t;&t;and HOSTNAME is your hostname/ip address&n; * and then resetting your routes.&n; *&n; * Note: only debug flags included in the ARCNET_DEBUG_MAX define will&n; *   actually be available.  GCC will (at least, GCC 2.7.0 will) notice&n; *   lines using a BUGLVL not in ARCNET_DEBUG_MAX and automatically optimize&n; *   them out.&n; */
DECL|macro|D_NORMAL
mdefine_line|#define D_NORMAL&t;1&t;/* D_NORMAL  normal operational info&t;*/
DECL|macro|D_INIT
mdefine_line|#define&t;D_INIT&t;&t;2&t;/* D_INIT    show init/probe messages&t;*/
DECL|macro|D_EXTRA
mdefine_line|#define D_EXTRA&t;&t;4&t;/* D_EXTRA   extra information&t;&t;*/
multiline_comment|/* debug levels past this point give LOTS of output! */
DECL|macro|D_DURING
mdefine_line|#define D_DURING&t;8&t;/* D_DURING  during normal use (irq&squot;s)&t;*/
DECL|macro|D_TX
mdefine_line|#define D_TX&t;&t;16&t;/* D_TX&t;     show tx packets&t;&t;*/
DECL|macro|D_RX
mdefine_line|#define D_RX&t;&t;32&t;/* D_RX&t;     show rx packets&t;&t;*/
DECL|macro|D_SKB
mdefine_line|#define D_SKB&t;&t;64&t;/* D_SKB     dump skb&squot;s&t;&t;&t;*/
macro_line|#ifndef ARCNET_DEBUG_MAX
DECL|macro|ARCNET_DEBUG_MAX
mdefine_line|#define ARCNET_DEBUG_MAX (~0)&t;&t;/* enable ALL debug messages */
multiline_comment|/*#define ARCNET_DEBUG_MAX (D_NORMAL|D_INIT|D_EXTRA) */
multiline_comment|/*#define ARCNET_DEBUG_MAX 0&t;*/
multiline_comment|/* enable NO debug messages */
macro_line|#endif
macro_line|#ifndef ARCNET_DEBUG
DECL|macro|ARCNET_DEBUG
mdefine_line|#define ARCNET_DEBUG (D_NORMAL|D_INIT|D_EXTRA)
multiline_comment|/*#define ARCNET_DEBUG (D_NORMAL|D_INIT)*/
macro_line|#endif
DECL|variable|arcnet_debug
r_int
id|arcnet_debug
op_assign
id|ARCNET_DEBUG
suffix:semicolon
multiline_comment|/* macros to simplify debug checking */
DECL|macro|BUGLVL
mdefine_line|#define BUGLVL(x) if ((ARCNET_DEBUG_MAX)&amp;arcnet_debug&amp;(x))
DECL|macro|BUGMSG
mdefine_line|#define BUGMSG(x,msg,args...) BUGLVL(x) printk(&quot;%6s: &quot; msg, dev-&gt;name , ## args);
multiline_comment|/* Some useful multiprotocol macros */
DECL|macro|TBUSY
mdefine_line|#define TBUSY lp-&gt;adev-&gt;tbusy &bslash;&n;&t;&t;=lp-&gt;edev-&gt;tbusy &bslash;&n;&t;&t;=lp-&gt;sdev-&gt;tbusy
DECL|macro|IF_TBUSY
mdefine_line|#define IF_TBUSY (lp-&gt;adev-&gt;tbusy &bslash;&n;&t;&t;|| lp-&gt;edev-&gt;tbusy &bslash;&n;&t;&t;|| lp-&gt;sdev-&gt;tbusy)
DECL|macro|INTERRUPT
mdefine_line|#define INTERRUPT lp-&gt;adev-&gt;interrupt &bslash;&n;&t;&t;=lp-&gt;edev-&gt;interrupt &bslash;&n;&t;&t;=lp-&gt;sdev-&gt;interrupt
DECL|macro|IF_INTERRUPT
mdefine_line|#define IF_INTERRUPT (lp-&gt;adev-&gt;interrupt &bslash;&n;&t;&t;|| lp-&gt;edev-&gt;interrupt &bslash;&n;&t;&t;|| lp-&gt;sdev-&gt;interrupt)
DECL|macro|START
mdefine_line|#define START lp-&gt;adev-&gt;start &bslash;&n;&t;&t;=lp-&gt;edev-&gt;start &bslash;&n;&t;&t;=lp-&gt;sdev-&gt;start
multiline_comment|/* The number of low I/O ports used by the ethercard. */
DECL|macro|ARCNET_TOTAL_SIZE
mdefine_line|#define ARCNET_TOTAL_SIZE&t;16
multiline_comment|/* Handy defines for ARCnet specific stuff */
multiline_comment|/* COM 9026 controller chip --&gt; ARCnet register addresses */
DECL|macro|INTMASK
mdefine_line|#define INTMASK&t;(ioaddr+0)&t;&t;/* writable */
DECL|macro|STATUS
mdefine_line|#define STATUS&t;(ioaddr+0)&t;&t;/* readable */
DECL|macro|COMMAND
mdefine_line|#define COMMAND (ioaddr+1)&t;/* writable, returns random vals on read (?) */
DECL|macro|RESET
mdefine_line|#define RESET  (ioaddr+8)&t;&t;/* software reset writable */
DECL|macro|SETMASK
mdefine_line|#define SETMASK outb(lp-&gt;intmask,INTMASK);
multiline_comment|/* Time needed for various things (in clock ticks, 1/100 sec) */
multiline_comment|/* We mostly don&squot;t bother with these - watch out. */
DECL|macro|RESETtime
mdefine_line|#define RESETtime 30&t;&t;/* reset */
multiline_comment|/* these are the max/min lengths of packet data. (including&n;&t; * ClientData header)&n;&t; * note: packet sizes 250, 251, 252 are impossible (God knows why)&n;&t; *  so exception packets become necessary.&n;&t; *&n;&t; * These numbers are compared with the length of the full packet,&n;&t; * including ClientData header.&n;&t; */
DECL|macro|MTU
mdefine_line|#define MTU&t;253&t;/* normal packet max size */
DECL|macro|MinTU
mdefine_line|#define MinTU&t;257&t;/* extended packet min size */
DECL|macro|XMTU
mdefine_line|#define XMTU&t;508&t;/* extended packet max size */
multiline_comment|/* status/interrupt mask bit fields */
DECL|macro|TXFREEflag
mdefine_line|#define TXFREEflag&t;0x01            /* transmitter available */
DECL|macro|TXACKflag
mdefine_line|#define TXACKflag       0x02            /* transmitted msg. ackd */
DECL|macro|RECONflag
mdefine_line|#define RECONflag       0x04            /* system reconfigured */
DECL|macro|TESTflag
mdefine_line|#define TESTflag        0x08            /* test flag */
DECL|macro|RESETflag
mdefine_line|#define RESETflag       0x10            /* power-on-reset */
DECL|macro|RES1flag
mdefine_line|#define RES1flag        0x20            /* unused */
DECL|macro|RES2flag
mdefine_line|#define RES2flag        0x40            /* unused */
DECL|macro|NORXflag
mdefine_line|#define NORXflag        0x80            /* receiver inhibited */
multiline_comment|/* in the command register, the following bits have these meanings:&n;        *                0-2     command&n;        *                3-4     page number (for enable rcv/xmt command)&n;        *                 7      receive broadcasts&n;        */
DECL|macro|NOTXcmd
mdefine_line|#define NOTXcmd         0x01            /* disable transmitter */
DECL|macro|NORXcmd
mdefine_line|#define NORXcmd         0x02            /* disable receiver */
DECL|macro|TXcmd
mdefine_line|#define TXcmd           0x03            /* enable transmitter */
DECL|macro|RXcmd
mdefine_line|#define RXcmd           0x04            /* enable receiver */
DECL|macro|CONFIGcmd
mdefine_line|#define CONFIGcmd       0x05            /* define configuration */
DECL|macro|CFLAGScmd
mdefine_line|#define CFLAGScmd       0x06            /* clear flags */
DECL|macro|TESTcmd
mdefine_line|#define TESTcmd         0x07            /* load test flags */
multiline_comment|/* flags for &quot;clear flags&quot; command */
DECL|macro|RESETclear
mdefine_line|#define RESETclear      0x08            /* power-on-reset */
DECL|macro|CONFIGclear
mdefine_line|#define CONFIGclear     0x10            /* system reconfigured */
multiline_comment|/* flags for &quot;load test flags&quot; command */
DECL|macro|TESTload
mdefine_line|#define TESTload        0x08            /* test flag (diagnostic) */
multiline_comment|/* byte deposited into first address of buffers on reset */
DECL|macro|TESTvalue
mdefine_line|#define TESTvalue       0321&t;&t; /* that&squot;s octal for 0xD1 :) */
multiline_comment|/* for &quot;enable receiver&quot; command */
DECL|macro|RXbcasts
mdefine_line|#define RXbcasts        0x80            /* receive broadcasts */
multiline_comment|/* flags for &quot;define configuration&quot; command */
DECL|macro|NORMALconf
mdefine_line|#define NORMALconf      0x00            /* 1-249 byte packets */
DECL|macro|EXTconf
mdefine_line|#define EXTconf         0x08            /* 250-504 byte packets */
multiline_comment|/* Starts receiving packets into recbuf.&n;&t; */
DECL|macro|EnableReceiver
mdefine_line|#define EnableReceiver()&t;outb(RXcmd|(recbuf&lt;&lt;3)|RXbcasts,COMMAND)
multiline_comment|/* RFC1201 Protocol ID&squot;s */
DECL|macro|ARC_P_IP
mdefine_line|#define ARC_P_IP&t;212&t;&t;/* 0xD4 */
DECL|macro|ARC_P_ARP
mdefine_line|#define ARC_P_ARP&t;213&t;&t;/* 0xD5 */
DECL|macro|ARC_P_RARP
mdefine_line|#define ARC_P_RARP&t;214&t;&t;/* 0xD6 */
DECL|macro|ARC_P_IPX
mdefine_line|#define ARC_P_IPX&t;250&t;&t;/* 0xFA */
DECL|macro|ARC_P_NOVELL_EC
mdefine_line|#define ARC_P_NOVELL_EC&t;236&t;&t;/* 0xEC */
multiline_comment|/* Old RFC1051 Protocol ID&squot;s */
DECL|macro|ARC_P_IP_RFC1051
mdefine_line|#define ARC_P_IP_RFC1051 240&t;&t;/* 0xF0 */
DECL|macro|ARC_P_ARP_RFC1051
mdefine_line|#define ARC_P_ARP_RFC1051 241&t;&t;/* 0xF1 */
multiline_comment|/* MS LanMan/WfWg protocol */
DECL|macro|ARC_P_ETHER
mdefine_line|#define ARC_P_ETHER&t;0xE8
multiline_comment|/* Unsupported/indirectly supported protocols */
DECL|macro|ARC_P_LANSOFT
mdefine_line|#define ARC_P_LANSOFT&t;251&t;&t;/* 0xFB - what is this? */
DECL|macro|ARC_P_ATALK
mdefine_line|#define ARC_P_ATALK&t;0xDD
multiline_comment|/* the header required by the card itself */
DECL|struct|HardHeader
r_struct
id|HardHeader
(brace
DECL|member|source
id|u_char
id|source
comma
multiline_comment|/* source ARCnet - filled in automagically */
DECL|member|destination
id|destination
comma
multiline_comment|/* destination ARCnet - 0 for broadcast */
DECL|member|offset1
id|offset1
comma
multiline_comment|/* offset of ClientData (256-byte packets) */
DECL|member|offset2
id|offset2
suffix:semicolon
multiline_comment|/* offset of ClientData (512-byte packets) */
)brace
suffix:semicolon
multiline_comment|/* a complete ARCnet packet */
DECL|union|ArcPacket
r_union
id|ArcPacket
(brace
DECL|member|hardheader
r_struct
id|HardHeader
id|hardheader
suffix:semicolon
multiline_comment|/* the hardware header */
DECL|member|raw
id|u_char
id|raw
(braket
l_int|512
)braket
suffix:semicolon
multiline_comment|/* raw packet info, incl ClientData */
)brace
suffix:semicolon
multiline_comment|/* the &quot;client data&quot; header - RFC1201 information&n;&t; * notice that this screws up if it&squot;s not an even number of bytes&n;&t; * &lt;sigh&gt;&n;&t; */
DECL|struct|ClientData
r_struct
id|ClientData
(brace
multiline_comment|/* data that&squot;s NOT part of real packet - we MUST get rid of it before&n;&t; * actually sending!!&n;&t; */
DECL|member|saddr
id|u_char
id|saddr
comma
multiline_comment|/* Source address - needed for IPX */
DECL|member|daddr
id|daddr
suffix:semicolon
multiline_comment|/* Destination address */
multiline_comment|/* data that IS part of real packet */
DECL|member|protocol_id
id|u_char
id|protocol_id
comma
multiline_comment|/* ARC_P_IP, ARC_P_ARP, etc */
DECL|member|split_flag
id|split_flag
suffix:semicolon
multiline_comment|/* for use with split packets */
DECL|member|sequence
id|u_short
id|sequence
suffix:semicolon
multiline_comment|/* sequence number */
)brace
suffix:semicolon
DECL|macro|EXTRA_CLIENTDATA
mdefine_line|#define EXTRA_CLIENTDATA (sizeof(struct ClientData)-4)
multiline_comment|/* the &quot;client data&quot; header - RFC1051 information&n;&t; * this also screws up if it&squot;s not an even number of bytes&n;&t; * &lt;sigh again&gt;&n;&t; */
DECL|struct|S_ClientData
r_struct
id|S_ClientData
(brace
multiline_comment|/* data that&squot;s NOT part of real packet - we MUST get rid of it before&n;&t; * actually sending!!&n;&t; */
DECL|member|saddr
id|u_char
id|saddr
comma
multiline_comment|/* Source address - needed for IPX */
DECL|member|daddr
id|daddr
comma
multiline_comment|/* Destination address */
DECL|member|junk
id|junk
suffix:semicolon
multiline_comment|/* padding to make an even length */
multiline_comment|/* data that IS part of real packet */
DECL|member|protocol_id
id|u_char
id|protocol_id
suffix:semicolon
multiline_comment|/* ARC_P_IP, ARC_P_ARP, etc */
)brace
suffix:semicolon
DECL|macro|S_EXTRA_CLIENTDATA
mdefine_line|#define S_EXTRA_CLIENTDATA (sizeof(struct S_ClientData)-1)
multiline_comment|/* &quot;Incoming&quot; is information needed for each address that could be sending&n; * to us.  Mostly for partially-received split packets.&n; */
DECL|struct|Incoming
r_struct
id|Incoming
(brace
DECL|member|skb
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
multiline_comment|/* packet data buffer             */
DECL|member|lastpacket
r_int
r_char
id|lastpacket
comma
multiline_comment|/* number of last packet (from 1) */
DECL|member|numpackets
id|numpackets
suffix:semicolon
multiline_comment|/* number of packets in split     */
DECL|member|sequence
id|u_short
id|sequence
suffix:semicolon
multiline_comment|/* sequence number of assembly&t;  */
)brace
suffix:semicolon
DECL|struct|Outgoing
r_struct
id|Outgoing
(brace
DECL|member|skb
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
multiline_comment|/* buffer from upper levels */
DECL|member|hdr
r_struct
id|ClientData
op_star
id|hdr
suffix:semicolon
multiline_comment|/* clientdata of last packet */
DECL|member|data
id|u_char
op_star
id|data
suffix:semicolon
multiline_comment|/* pointer to data in packet */
DECL|member|length
r_int
id|length
comma
multiline_comment|/* bytes total */
DECL|member|dataleft
id|dataleft
comma
multiline_comment|/* bytes left */
DECL|member|segnum
id|segnum
comma
multiline_comment|/* segment being sent */
DECL|member|numsegs
id|numsegs
comma
multiline_comment|/* number of segments */
DECL|member|seglen
id|seglen
suffix:semicolon
multiline_comment|/* length of segment */
)brace
suffix:semicolon
multiline_comment|/* Information that needs to be kept for each board. */
DECL|struct|arcnet_local
r_struct
id|arcnet_local
(brace
DECL|member|stats
r_struct
id|enet_statistics
id|stats
suffix:semicolon
DECL|member|sequence
id|u_short
id|sequence
suffix:semicolon
multiline_comment|/* sequence number (incs with each packet) */
DECL|member|stationid
id|u_char
id|stationid
comma
multiline_comment|/* our 8-bit station address */
DECL|member|recbuf
id|recbuf
comma
multiline_comment|/* receive buffer # (0 or 1) */
DECL|member|txbuf
id|txbuf
comma
multiline_comment|/* transmit buffer # (2 or 3) */
DECL|member|txready
id|txready
comma
multiline_comment|/* buffer where a packet is ready to send */
DECL|member|intmask
id|intmask
suffix:semicolon
multiline_comment|/* current value of INTMASK register */
DECL|member|intx
r_int
id|intx
comma
multiline_comment|/* in TX routine? */
DECL|member|in_txhandler
id|in_txhandler
comma
multiline_comment|/* in TX_IRQ handler? */
DECL|member|sending
id|sending
suffix:semicolon
multiline_comment|/* transmit in progress? */
macro_line|#ifdef VERIFY_ACK
DECL|member|lastload_dest
r_int
id|lastload_dest
comma
multiline_comment|/* can last loaded packet be acked? */
DECL|member|lasttrans_dest
id|lasttrans_dest
suffix:semicolon
multiline_comment|/* can last TX&squot;d packet be acked? */
macro_line|#endif
macro_line|#if defined(DETECT_RECONFIGS) &amp;&amp; defined(RECON_THRESHOLD)
DECL|member|first_recon
id|time_t
id|first_recon
comma
multiline_comment|/* time of &quot;first&quot; RECON message to count */
DECL|member|last_recon
id|last_recon
suffix:semicolon
multiline_comment|/* time of most recent RECON */
DECL|member|num_recons
r_int
id|num_recons
comma
multiline_comment|/* number of RECONs between first and last. */
DECL|member|network_down
id|network_down
suffix:semicolon
multiline_comment|/* do we think the network is down? */
macro_line|#endif
DECL|member|timer
r_struct
id|timer_list
id|timer
suffix:semicolon
multiline_comment|/* the timer interrupt struct */
DECL|member|incoming
r_struct
id|Incoming
id|incoming
(braket
l_int|256
)braket
suffix:semicolon
multiline_comment|/* one from each address */
DECL|member|outgoing
r_struct
id|Outgoing
id|outgoing
suffix:semicolon
multiline_comment|/* packet currently being sent */
DECL|member|adev
r_struct
id|device
op_star
id|adev
comma
multiline_comment|/* RFC1201 protocol device */
DECL|member|edev
op_star
id|edev
comma
multiline_comment|/* Ethernet-Encap device */
DECL|member|sdev
op_star
id|sdev
suffix:semicolon
multiline_comment|/* RFC1051 protocol device */
)brace
suffix:semicolon
multiline_comment|/* Index to functions, as function prototypes. */
r_extern
r_int
id|arcnet_probe
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_int
id|arcnet_memprobe
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
id|u_char
op_star
id|addr
)paren
suffix:semicolon
r_static
r_int
id|arcnet_ioprobe
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
r_int
id|ioaddr
)paren
suffix:semicolon
r_static
r_void
id|arcnet_setup
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_int
id|arcnetE_init
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_int
id|arcnetS_init
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_int
id|arcnet_open
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_int
id|arcnet_close
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_int
id|arcnet_reset
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_int
id|arcnet_send_packet_bad
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_int
id|arcnetA_send_packet
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_int
id|arcnetE_send_packet
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_int
id|arcnetS_send_packet
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_void
id|arcnetA_continue_tx
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_void
id|arcnetAS_prepare_tx
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
id|u_char
op_star
id|hdr
comma
r_int
id|hdrlen
comma
r_char
op_star
id|data
comma
r_int
id|length
comma
r_int
id|daddr
comma
r_int
id|exceptA
)paren
suffix:semicolon
r_static
r_int
id|arcnet_go_tx
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
r_int
id|enable_irq
)paren
suffix:semicolon
r_static
r_void
id|arcnet_interrupt
c_func
(paren
r_int
id|irq
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
suffix:semicolon
r_static
r_void
id|arcnet_inthandler
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_void
id|arcnet_rx
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
r_int
id|recbuf
)paren
suffix:semicolon
r_static
r_void
id|arcnetA_rx
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
id|u_char
op_star
id|buf
comma
r_int
id|length
comma
id|u_char
id|saddr
comma
id|u_char
id|daddr
)paren
suffix:semicolon
r_static
r_void
id|arcnetE_rx
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
id|u_char
op_star
id|arcsoft
comma
r_int
id|length
comma
id|u_char
id|saddr
comma
id|u_char
id|daddr
)paren
suffix:semicolon
r_static
r_void
id|arcnetS_rx
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
id|u_char
op_star
id|buf
comma
r_int
id|length
comma
id|u_char
id|saddr
comma
id|u_char
id|daddr
)paren
suffix:semicolon
r_static
r_struct
id|enet_statistics
op_star
id|arcnet_get_stats
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
suffix:semicolon
multiline_comment|/*&n;static void set_multicast_list(struct device *dev);&n;*/
multiline_comment|/* functions for header/arp/etc building */
r_int
id|arcnetA_header
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|device
op_star
id|dev
comma
r_int
r_int
id|type
comma
r_void
op_star
id|daddr
comma
r_void
op_star
id|saddr
comma
r_int
id|len
)paren
suffix:semicolon
r_int
id|arcnetS_header
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|device
op_star
id|dev
comma
r_int
r_int
id|type
comma
r_void
op_star
id|daddr
comma
r_void
op_star
id|saddr
comma
r_int
id|len
)paren
suffix:semicolon
r_int
id|arcnetA_rebuild_header
c_func
(paren
r_void
op_star
id|eth
comma
r_struct
id|device
op_star
id|dev
comma
r_int
r_int
id|raddr
comma
r_struct
id|sk_buff
op_star
id|skb
)paren
suffix:semicolon
r_int
id|arcnetS_rebuild_header
c_func
(paren
r_void
op_star
id|eth
comma
r_struct
id|device
op_star
id|dev
comma
r_int
r_int
id|raddr
comma
r_struct
id|sk_buff
op_star
id|skb
)paren
suffix:semicolon
r_int
r_int
id|arcnetA_type_trans
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|device
op_star
id|dev
)paren
suffix:semicolon
r_int
r_int
id|arcnetS_type_trans
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|device
op_star
id|dev
)paren
suffix:semicolon
macro_line|#ifdef MODULE
r_int
id|init_module
c_func
(paren
r_void
)paren
suffix:semicolon
r_void
id|cleanup_module
c_func
(paren
r_void
)paren
suffix:semicolon
macro_line|#endif
DECL|macro|tx_done
mdefine_line|#define tx_done(dev) 1
DECL|macro|JIFFER
mdefine_line|#define JIFFER(time) for (delayval=0; delayval&lt;(time*10); delayval++) &bslash;&n;&t;&t;udelay(1000);
multiline_comment|/****************************************************************************&n; *                                                                          *&n; * Probe and initialization                                                 *&n; *                                                                          *&n; ****************************************************************************/
multiline_comment|/* Check for a network adaptor of this type, and return &squot;0&squot; if one exists.&n; *  If dev-&gt;base_addr == 0, probe all likely locations.&n; *  If dev-&gt;base_addr == 1, always return failure.&n; *  If dev-&gt;base_addr == 2, allocate space for the device and return success&n; *  (detachable devices only).&n; */
r_int
DECL|function|arcnet_probe
id|arcnet_probe
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
multiline_comment|/* I refuse to probe anything less than 0x200, because anyone using&n;&t; * an address like that should probably be shot.&n;&t; */
r_int
op_star
id|port
comma
id|ports
(braket
)braket
op_assign
(brace
multiline_comment|/* first the suggested values! */
l_int|0x300
comma
l_int|0x2E0
comma
l_int|0x2F0
comma
l_int|0x2D0
comma
multiline_comment|/* ...now everything else possible. */
l_int|0x200
comma
l_int|0x210
comma
l_int|0x220
comma
l_int|0x230
comma
l_int|0x240
comma
l_int|0x250
comma
l_int|0x260
comma
l_int|0x270
comma
l_int|0x280
comma
l_int|0x290
comma
l_int|0x2a0
comma
l_int|0x2b0
comma
l_int|0x2c0
comma
l_int|0x310
comma
l_int|0x320
comma
l_int|0x330
comma
l_int|0x340
comma
l_int|0x350
comma
l_int|0x360
comma
l_int|0x370
comma
l_int|0x380
comma
l_int|0x390
comma
l_int|0x3a0
comma
multiline_comment|/* video ports, */
l_int|0x3e0
comma
l_int|0x3f0
comma
multiline_comment|/* a null ends the list */
l_int|0
)brace
suffix:semicolon
multiline_comment|/* I&squot;m not going to probe below 0xA0000 either, for similar reasons.&n;&t; */
r_int
r_int
op_star
id|addr
comma
id|addrs
(braket
)braket
op_assign
(brace
l_int|0xD0000
comma
l_int|0xE0000
comma
l_int|0xA0000
comma
l_int|0xB0000
comma
l_int|0xC0000
comma
l_int|0xF0000
comma
multiline_comment|/* from &lt;mdrejhon@magi.com&gt; */
l_int|0xE1000
comma
l_int|0xDD000
comma
l_int|0xDC000
comma
l_int|0xD9000
comma
l_int|0xD8000
comma
l_int|0xD5000
comma
l_int|0xD4000
comma
l_int|0xD1000
comma
l_int|0xCD000
comma
l_int|0xCC000
comma
l_int|0xC9000
comma
l_int|0xC8000
comma
l_int|0xC5000
comma
l_int|0xC4000
comma
multiline_comment|/* terminator */
l_int|0
)brace
suffix:semicolon
r_int
id|base_addr
op_assign
id|dev-&gt;base_addr
comma
id|status
op_assign
l_int|0
suffix:semicolon
r_int
id|delayval
comma
id|ioaddr
suffix:semicolon
r_struct
id|arcnet_local
op_star
id|lp
suffix:semicolon
id|printk
c_func
(paren
id|version
)paren
suffix:semicolon
macro_line|#if 1
id|BUGLVL
c_func
(paren
id|D_NORMAL
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;arcnet: ***&bslash;n&quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;arcnet: * Read README.arcnet for important release notes!&bslash;n&quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;arcnet: *&bslash;n&quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;arcnet: * This is an ALPHA version!  (Last stable release: v2.00)  E-mail me if&bslash;n&quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;arcnet: * you have any questions, comments, or bug reports.&bslash;n&quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;arcnet: ***&bslash;n&quot;
)paren
suffix:semicolon
)brace
macro_line|#else
id|BUGLVL
c_func
(paren
id|D_EXTRA
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;arcnet: ***&bslash;n&quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;arcnet: * Read README.arcnet for important release notes!&bslash;n&quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;arcnet: *&bslash;n&quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;arcnet: * This version should be stable, but please e-mail&bslash;n&quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;arcnet: * me if you have any questions or comments.&bslash;n&quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;arcnet: ***&bslash;n&quot;
)paren
suffix:semicolon
)brace
macro_line|#endif
id|BUGMSG
c_func
(paren
id|D_INIT
comma
l_string|&quot;given: base %lXh, IRQ %d, shmem %lXh&bslash;n&quot;
comma
id|dev-&gt;base_addr
comma
id|dev-&gt;irq
comma
id|dev-&gt;mem_start
)paren
suffix:semicolon
r_if
c_cond
(paren
id|base_addr
OG
l_int|0x1ff
)paren
multiline_comment|/* Check a single specified location. */
id|status
op_assign
id|arcnet_ioprobe
c_func
(paren
id|dev
comma
id|base_addr
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
id|base_addr
OG
l_int|0
)paren
multiline_comment|/* Don&squot;t probe at all. */
r_return
op_minus
id|ENXIO
suffix:semicolon
r_else
r_for
c_loop
(paren
id|port
op_assign
op_amp
id|ports
(braket
l_int|0
)braket
suffix:semicolon
op_star
id|port
suffix:semicolon
id|port
op_increment
)paren
(brace
r_if
c_cond
(paren
id|check_region
c_func
(paren
op_star
id|port
comma
id|ARCNET_TOTAL_SIZE
)paren
)paren
(brace
id|BUGMSG
c_func
(paren
id|D_INIT
comma
l_string|&quot;Skipping %Xh because of check_region...&bslash;n&quot;
comma
op_star
id|port
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
id|status
op_assign
id|arcnet_ioprobe
c_func
(paren
id|dev
comma
op_star
id|port
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|status
)paren
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|status
)paren
r_return
id|status
suffix:semicolon
multiline_comment|/* arcnet_ioprobe set this */
id|ioaddr
op_assign
id|dev-&gt;base_addr
suffix:semicolon
multiline_comment|/* ioprobe turned out okay.  Now reset the card, so we have&n;&t; * a test byte to look for in shared memory...&n;&t; */
id|BUGMSG
c_func
(paren
id|D_INIT
comma
l_string|&quot;ioprobe okay!  Waiting for reset...&bslash;n&quot;
)paren
suffix:semicolon
id|inb
c_func
(paren
id|RESET
)paren
suffix:semicolon
id|JIFFER
c_func
(paren
id|RESETtime
)paren
suffix:semicolon
multiline_comment|/* okay, now we have to find the shared memory area. */
id|BUGMSG
c_func
(paren
id|D_INIT
comma
l_string|&quot;starting memory probe, given %lXh&bslash;n&quot;
comma
id|dev-&gt;mem_start
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;mem_start
)paren
multiline_comment|/* value given - probe just that one */
(brace
id|status
op_assign
id|arcnet_memprobe
c_func
(paren
id|dev
comma
(paren
id|u_char
op_star
)paren
id|dev-&gt;mem_start
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
)paren
r_return
id|status
suffix:semicolon
)brace
r_else
multiline_comment|/* no value given - probe everything */
(brace
r_for
c_loop
(paren
id|addr
op_assign
op_amp
id|addrs
(braket
l_int|0
)braket
suffix:semicolon
op_star
id|addr
suffix:semicolon
id|addr
op_increment
)paren
(brace
id|status
op_assign
id|arcnet_memprobe
c_func
(paren
id|dev
comma
(paren
id|u_char
op_star
)paren
(paren
op_star
id|addr
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|status
)paren
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|status
)paren
r_return
id|status
suffix:semicolon
)brace
multiline_comment|/* now reserve the irq... */
(brace
r_int
id|irqval
op_assign
id|request_irq
c_func
(paren
id|dev-&gt;irq
comma
op_amp
id|arcnet_interrupt
comma
l_int|0
comma
l_string|&quot;arcnet&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|irqval
)paren
(brace
id|BUGMSG
c_func
(paren
id|D_NORMAL
comma
l_string|&quot;unable to get IRQ %d (irqval=%d).&bslash;n&quot;
comma
id|dev-&gt;irq
comma
id|irqval
)paren
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
id|irq2dev_map
(braket
id|dev-&gt;irq
)braket
op_assign
id|dev
suffix:semicolon
)brace
multiline_comment|/* Grab the region so we can find another board if autoIRQ fails. */
id|request_region
c_func
(paren
id|dev-&gt;base_addr
comma
id|ARCNET_TOTAL_SIZE
comma
l_string|&quot;arcnet&quot;
)paren
suffix:semicolon
id|BUGMSG
c_func
(paren
id|D_NORMAL
comma
l_string|&quot;ARCnet card found at %03lXh, IRQ %d, ShMem at %lXh.&bslash;n&quot;
comma
id|dev-&gt;base_addr
comma
id|dev-&gt;irq
comma
id|dev-&gt;mem_start
)paren
suffix:semicolon
multiline_comment|/* Initialize the device structure. */
id|dev-&gt;priv
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|arcnet_local
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;priv
op_eq
l_int|NULL
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|memset
c_func
(paren
id|dev-&gt;priv
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|arcnet_local
)paren
)paren
suffix:semicolon
id|lp
op_assign
(paren
r_struct
id|arcnet_local
op_star
)paren
(paren
id|dev-&gt;priv
)paren
suffix:semicolon
id|dev-&gt;open
op_assign
id|arcnet_open
suffix:semicolon
id|dev-&gt;stop
op_assign
id|arcnet_close
suffix:semicolon
id|dev-&gt;hard_start_xmit
op_assign
id|arcnetA_send_packet
suffix:semicolon
id|dev-&gt;get_stats
op_assign
id|arcnet_get_stats
suffix:semicolon
multiline_comment|/*dev-&gt;set_multicast_list = &amp;set_multicast_list;*/
multiline_comment|/* Fill in the fields of the device structure with generic&n;&t; * values.&n;&t; */
id|arcnet_setup
c_func
(paren
id|dev
)paren
suffix:semicolon
multiline_comment|/* And now fill particular fields with arcnet values */
id|dev-&gt;mtu
op_assign
l_int|1500
suffix:semicolon
multiline_comment|/* completely arbitrary - agrees with ether, though */
id|dev-&gt;hard_header_len
op_assign
r_sizeof
(paren
r_struct
id|ClientData
)paren
suffix:semicolon
id|BUGMSG
c_func
(paren
id|D_DURING
comma
l_string|&quot;ClientData header size is %d.&bslash;n&quot;
comma
r_sizeof
(paren
r_struct
id|ClientData
)paren
)paren
suffix:semicolon
id|BUGMSG
c_func
(paren
id|D_DURING
comma
l_string|&quot;HardHeader size is %d.&bslash;n&quot;
comma
r_sizeof
(paren
r_struct
id|HardHeader
)paren
)paren
suffix:semicolon
multiline_comment|/* since we strip EXTRA_CLIENTDATA bytes off before sending,&n;&t;&t; * we let Linux add that many bytes to the packet data...&n;&t;&t; */
id|BUGMSG
c_func
(paren
id|D_INIT
comma
l_string|&quot;arcnet_probe: resetting card.&bslash;n&quot;
)paren
suffix:semicolon
id|arcnet_reset
c_func
(paren
id|dev
)paren
suffix:semicolon
id|BUGMSG
c_func
(paren
id|D_NORMAL
comma
l_string|&quot;We appear to be station %d (%02Xh)&bslash;n&quot;
comma
id|lp-&gt;stationid
comma
id|lp-&gt;stationid
)paren
suffix:semicolon
r_if
c_cond
(paren
id|lp-&gt;stationid
op_eq
l_int|0
)paren
id|BUGMSG
c_func
(paren
id|D_NORMAL
comma
l_string|&quot;WARNING!  Station address 0 is reserved for broadcasts!&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|lp-&gt;stationid
op_eq
l_int|255
)paren
id|BUGMSG
c_func
(paren
id|D_NORMAL
comma
l_string|&quot;WARNING!  Station address 255 may confuse DOS networking programs!&bslash;n&quot;
)paren
suffix:semicolon
id|dev-&gt;dev_addr
(braket
l_int|0
)braket
op_assign
id|lp-&gt;stationid
suffix:semicolon
id|lp-&gt;sequence
op_assign
l_int|1
suffix:semicolon
id|lp-&gt;recbuf
op_assign
l_int|0
suffix:semicolon
id|dev-&gt;hard_header
op_assign
id|arcnetA_header
suffix:semicolon
id|dev-&gt;rebuild_header
op_assign
id|arcnetA_rebuild_header
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|arcnet_ioprobe
r_int
id|arcnet_ioprobe
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
r_int
id|ioaddr
)paren
(brace
r_int
id|airq
suffix:semicolon
r_int
r_int
id|airqmask
suffix:semicolon
id|BUGMSG
c_func
(paren
id|D_INIT
comma
l_string|&quot;probing address %Xh&bslash;n&quot;
comma
id|ioaddr
)paren
suffix:semicolon
id|BUGMSG
c_func
(paren
id|D_INIT
comma
l_string|&quot; status1=%Xh&bslash;n&quot;
comma
id|inb
c_func
(paren
id|STATUS
)paren
)paren
suffix:semicolon
multiline_comment|/* very simple - all we have to do is reset the card, and if there&squot;s&n;&t; * no irq, it&squot;s not an ARCnet.  We can also kill two birds with&n;&t; * one stone because we detect the IRQ at the same time :)&n;&t; *&n;&t; * BUT: some newer cards don&squot;t seem to IRQ upon reset, or worse,&n;&t; * don&squot;t reset when BASE+0x08 is read.  This code is no longer&n;&t; * so simple, and in fact quite dangerous.  It should be redesigned.&n;&t; */
macro_line|#if 0
multiline_comment|/* reset the card by reading the reset port */
id|inb
c_func
(paren
id|RESET
)paren
suffix:semicolon
id|JIFFER
c_func
(paren
id|RESETtime
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/* if status port is FF, there&squot;s certainly no arcnet... give up. */
r_if
c_cond
(paren
id|inb
c_func
(paren
id|STATUS
)paren
op_eq
l_int|0xFF
)paren
(brace
id|BUGMSG
c_func
(paren
id|D_INIT
comma
l_string|&quot; probe failed.  Status port empty.&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
macro_line|#if 0
multiline_comment|/* we&squot;ll try to be reasonably sure it&squot;s an arcnet by making sure&n;&t; * the value of the COMMAND port changes automatically once in a&n;&t; * while.  I have no idea what those values ARE, but at least&n;&t; * they work.&n;&t; */
(brace
r_int
id|initval
comma
id|curval
suffix:semicolon
id|curval
op_assign
id|initval
op_assign
id|inb
c_func
(paren
id|COMMAND
)paren
suffix:semicolon
id|delayval
op_assign
id|jiffies
op_plus
l_int|5
suffix:semicolon
r_while
c_loop
(paren
id|delayval
op_ge
id|jiffies
op_logical_and
id|curval
op_eq
id|initval
)paren
id|curval
op_assign
id|inb
c_func
(paren
id|COMMAND
)paren
suffix:semicolon
r_if
c_cond
(paren
id|curval
op_eq
id|initval
)paren
(brace
id|BUGLVL
c_func
(paren
id|D_INIT
comma
l_string|&quot; probe failed.  never-changing command port (%02Xh).&bslash;n&quot;
comma
id|initval
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
)brace
macro_line|#endif
id|BUGMSG
c_func
(paren
id|D_INIT
comma
l_string|&quot; status2=%Xh&bslash;n&quot;
comma
id|inb
c_func
(paren
id|STATUS
)paren
)paren
suffix:semicolon
multiline_comment|/* now we turn the reset bit off so we can IRQ next reset... */
id|outb
c_func
(paren
id|CFLAGScmd
op_or
id|RESETclear
op_or
id|CONFIGclear
comma
id|COMMAND
)paren
suffix:semicolon
r_if
c_cond
(paren
id|inb
c_func
(paren
id|STATUS
)paren
op_amp
id|RESETflag
)paren
multiline_comment|/* reset flag STILL on */
(brace
id|BUGMSG
c_func
(paren
id|D_INIT
comma
l_string|&quot; probe failed.  eternal reset flag1...(status=%Xh)&bslash;n&quot;
comma
id|inb
c_func
(paren
id|STATUS
)paren
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
id|outb
c_func
(paren
id|NORXcmd
comma
id|COMMAND
)paren
suffix:semicolon
id|outb
c_func
(paren
l_int|0
comma
id|INTMASK
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|1
)paren
suffix:semicolon
multiline_comment|/* set up automatic IRQ detection */
id|airqmask
op_assign
id|probe_irq_on
c_func
(paren
)paren
suffix:semicolon
id|BUGMSG
c_func
(paren
id|D_INIT
comma
l_string|&quot; airqmask=%lXh&bslash;n&quot;
comma
id|airqmask
)paren
suffix:semicolon
multiline_comment|/* if we do this, we&squot;re sure to get an IRQ since the card&n;&t; * has just reset and the NORXflag is on until we tell it to&n;&t; * start receiving.&n;&t; */
id|outb
c_func
(paren
id|NORXflag
comma
id|INTMASK
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|1
)paren
suffix:semicolon
id|outb
c_func
(paren
l_int|0
comma
id|INTMASK
)paren
suffix:semicolon
multiline_comment|/* and turn the reset flag back off.  On some systems, we NEED to do&n;&t; * this before we re-enable the IRQ!&n;&t; */
id|outb
c_func
(paren
id|CFLAGScmd
op_or
id|RESETclear
op_or
id|CONFIGclear
comma
id|COMMAND
)paren
suffix:semicolon
multiline_comment|/* get autoirq results */
id|airq
op_assign
id|probe_irq_off
c_func
(paren
id|airqmask
)paren
suffix:semicolon
r_if
c_cond
(paren
id|airq
OG
l_int|0
)paren
(brace
id|BUGMSG
c_func
(paren
id|D_INIT
comma
l_string|&quot; autoirq is %d&bslash;n&quot;
comma
id|airq
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|airq
OL
l_int|0
)paren
(brace
id|BUGMSG
c_func
(paren
id|D_INIT
comma
l_string|&quot; autoirq MAY be %d (please send mail to Avery)&bslash;n&quot;
comma
op_minus
id|airq
)paren
suffix:semicolon
id|airq
op_assign
l_int|0
suffix:semicolon
)brace
multiline_comment|/* if there was no autoirq AND the user hasn&squot;t set any defaults,&n;&t; * give up.&n;&t; */
r_if
c_cond
(paren
op_logical_neg
id|airq
op_logical_and
op_logical_neg
(paren
id|dev-&gt;base_addr
op_logical_and
id|dev-&gt;irq
)paren
)paren
(brace
id|BUGMSG
c_func
(paren
id|D_INIT
comma
l_string|&quot; probe failed.  no autoirq...&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
multiline_comment|/* otherwise we probably have a card.  Let&squot;s make sure. */
macro_line|#if 0
r_if
c_cond
(paren
id|inb
c_func
(paren
id|STATUS
)paren
op_amp
id|RESETflag
)paren
multiline_comment|/* reset flag on */
(brace
multiline_comment|/* now we turn the reset bit off */
id|outb
c_func
(paren
id|CFLAGScmd
op_or
id|RESETclear
op_or
id|CONFIGclear
comma
id|COMMAND
)paren
suffix:semicolon
)brace
macro_line|#endif
r_if
c_cond
(paren
id|inb
c_func
(paren
id|STATUS
)paren
op_amp
id|RESETflag
)paren
multiline_comment|/* reset flag STILL on */
(brace
id|BUGMSG
c_func
(paren
id|D_INIT
comma
l_string|&quot; probe failed.  eternal reset flag...(status=%Xh)&bslash;n&quot;
comma
id|inb
c_func
(paren
id|STATUS
)paren
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
multiline_comment|/* okay, we&squot;ve got a real, live ARCnet on our hands.&n;&t; * I hope.&n;&t; */
r_if
c_cond
(paren
op_logical_neg
id|dev-&gt;base_addr
)paren
id|dev-&gt;base_addr
op_assign
id|ioaddr
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;irq
OL
l_int|2
)paren
multiline_comment|/* &quot;Auto-IRQ&quot; */
(brace
multiline_comment|/* we already did the autoirq above, so store the value */
id|dev-&gt;irq
op_assign
id|airq
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|dev-&gt;irq
op_eq
l_int|2
)paren
(brace
id|BUGMSG
c_func
(paren
id|D_NORMAL
comma
l_string|&quot;IRQ2 == IRQ9, don&squot;t worry.&bslash;n&quot;
)paren
suffix:semicolon
id|dev-&gt;irq
op_assign
l_int|9
suffix:semicolon
)brace
id|BUGMSG
c_func
(paren
id|D_INIT
comma
l_string|&quot;irq and base address seem okay. (%lXh, IRQ %d)&bslash;n&quot;
comma
id|dev-&gt;base_addr
comma
id|dev-&gt;irq
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* A memory probe that is called after the card is reset.&n; * It checks for the official TESTvalue in byte 0 and makes sure the buffer&n; * has certain characteristics of an ARCnet.&n; */
DECL|function|arcnet_memprobe
r_int
id|arcnet_memprobe
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
id|u_char
op_star
id|addr
)paren
(brace
id|BUGMSG
c_func
(paren
id|D_INIT
comma
l_string|&quot;probing memory at %lXh&bslash;n&quot;
comma
(paren
id|u_long
)paren
id|addr
)paren
suffix:semicolon
id|dev-&gt;mem_start
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* ARCnet memory byte 0 is TESTvalue */
r_if
c_cond
(paren
id|addr
(braket
l_int|0
)braket
op_ne
id|TESTvalue
)paren
(brace
id|BUGMSG
c_func
(paren
id|D_INIT
comma
l_string|&quot; probe failed.  addr=%lXh, addr[0]=%Xh (not %Xh)&bslash;n&quot;
comma
(paren
r_int
r_int
)paren
id|addr
comma
id|addr
(braket
l_int|0
)braket
comma
id|TESTvalue
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
multiline_comment|/* now verify the shared memory writability */
id|addr
(braket
l_int|0
)braket
op_assign
l_int|0x42
suffix:semicolon
r_if
c_cond
(paren
id|addr
(braket
l_int|0
)braket
op_ne
l_int|0x42
)paren
(brace
id|BUGMSG
c_func
(paren
id|D_INIT
comma
l_string|&quot; probe failed.  addr=%lXh, addr[0]=%Xh (not 42h)&bslash;n&quot;
comma
(paren
r_int
r_int
)paren
id|addr
comma
id|addr
(braket
l_int|0
)braket
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
multiline_comment|/* got it!  fill in dev */
id|dev-&gt;mem_start
op_assign
(paren
r_int
r_int
)paren
id|addr
suffix:semicolon
id|dev-&gt;mem_end
op_assign
id|dev-&gt;mem_start
op_plus
l_int|512
op_star
l_int|4
op_minus
l_int|1
suffix:semicolon
id|dev-&gt;rmem_start
op_assign
id|dev-&gt;mem_start
op_plus
l_int|512
op_star
l_int|0
suffix:semicolon
id|dev-&gt;rmem_end
op_assign
id|dev-&gt;mem_start
op_plus
l_int|512
op_star
l_int|2
op_minus
l_int|1
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Do a hardware reset on the card.&n; */
DECL|function|arcnet_reset
r_int
id|arcnet_reset
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
r_struct
id|arcnet_local
op_star
id|lp
op_assign
(paren
r_struct
id|arcnet_local
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_int
id|ioaddr
op_assign
id|dev-&gt;base_addr
suffix:semicolon
r_int
id|delayval
comma
id|recbuf
op_assign
id|lp-&gt;recbuf
suffix:semicolon
id|u_char
op_star
id|cardmem
suffix:semicolon
id|lp-&gt;intmask
op_assign
l_int|0
suffix:semicolon
id|SETMASK
suffix:semicolon
multiline_comment|/* no IRQ&squot;s, please! */
id|BUGMSG
c_func
(paren
id|D_INIT
comma
l_string|&quot;Resetting %s (status=%Xh)&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|inb
c_func
(paren
id|STATUS
)paren
)paren
suffix:semicolon
id|inb
c_func
(paren
id|RESET
)paren
suffix:semicolon
multiline_comment|/* Reset by reading this port */
id|JIFFER
c_func
(paren
id|RESETtime
)paren
suffix:semicolon
id|outb
c_func
(paren
id|CFLAGScmd
op_or
id|RESETclear
comma
id|COMMAND
)paren
suffix:semicolon
multiline_comment|/* clear flags &amp; end reset */
id|outb
c_func
(paren
id|CFLAGScmd
op_or
id|CONFIGclear
comma
id|COMMAND
)paren
suffix:semicolon
multiline_comment|/* after a reset, the first byte of shared mem is TESTvalue and the&n;&t; * second byte is our 8-bit ARCnet address.&n;&t; */
id|cardmem
op_assign
(paren
id|u_char
op_star
)paren
id|dev-&gt;mem_start
suffix:semicolon
r_if
c_cond
(paren
id|cardmem
(braket
l_int|0
)braket
op_ne
id|TESTvalue
)paren
(brace
id|BUGMSG
c_func
(paren
id|D_INIT
comma
l_string|&quot;reset failed: TESTvalue not present.&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
id|lp-&gt;stationid
op_assign
id|cardmem
(braket
l_int|1
)braket
suffix:semicolon
multiline_comment|/* save address for later use */
multiline_comment|/* clear out status variables */
id|recbuf
op_assign
id|lp-&gt;recbuf
op_assign
l_int|0
suffix:semicolon
id|lp-&gt;txbuf
op_assign
l_int|2
suffix:semicolon
multiline_comment|/* enable extended (512-byte) packets */
id|outb
c_func
(paren
id|CONFIGcmd
op_or
id|EXTconf
comma
id|COMMAND
)paren
suffix:semicolon
multiline_comment|/* clean out all the memory to make debugging make more sense :) */
id|BUGLVL
c_func
(paren
id|D_DURING
)paren
id|memset
c_func
(paren
(paren
r_void
op_star
)paren
id|dev-&gt;mem_start
comma
l_int|0x42
comma
l_int|2048
)paren
suffix:semicolon
multiline_comment|/* and enable receive of our first packet to the first buffer */
id|EnableReceiver
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* re-enable interrupts */
id|lp-&gt;intmask
op_or_assign
id|NORXflag
suffix:semicolon
macro_line|#ifdef DETECT_RECONFIGS
id|lp-&gt;intmask
op_or_assign
id|RECONflag
suffix:semicolon
macro_line|#endif
id|SETMASK
suffix:semicolon
multiline_comment|/* done!  return success. */
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * Setup a struct device for ARCnet.  This should really be in net_init.c&n; * but since there are three different ARCnet devices ANYWAY... &lt;gargle&gt;&n; *&n; * Actually, the whole idea of having all this kernel-dependent stuff (ie.&n; * &quot;new-style flags&quot;) setup per-net-device is kind of weird anyway.&n; *&n; * Intelligent defaults?!  Nah.&n; */
DECL|function|arcnet_setup
r_void
id|arcnet_setup
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|DEV_NUMBUFFS
suffix:semicolon
id|i
op_increment
)paren
id|skb_queue_head_init
c_func
(paren
op_amp
id|dev-&gt;buffs
(braket
id|i
)braket
)paren
suffix:semicolon
id|dev-&gt;broadcast
(braket
l_int|0
)braket
op_assign
l_int|0x00
suffix:semicolon
multiline_comment|/* broadcasts on ARCnet are address 0 */
id|dev-&gt;addr_len
op_assign
l_int|1
suffix:semicolon
id|dev-&gt;type
op_assign
id|ARPHRD_ARCNET
suffix:semicolon
id|dev-&gt;tx_queue_len
op_assign
l_int|30
suffix:semicolon
multiline_comment|/* Fairly long queue, arcnet is quite speedy */
multiline_comment|/* New-style flags. */
id|dev-&gt;flags
op_assign
id|IFF_BROADCAST
suffix:semicolon
id|dev-&gt;family
op_assign
id|AF_INET
suffix:semicolon
id|dev-&gt;pa_addr
op_assign
l_int|0
suffix:semicolon
id|dev-&gt;pa_brdaddr
op_assign
l_int|0
suffix:semicolon
id|dev-&gt;pa_mask
op_assign
l_int|0
suffix:semicolon
id|dev-&gt;pa_alen
op_assign
l_int|4
suffix:semicolon
)brace
multiline_comment|/* Initialize the arc0e device.&n; */
DECL|function|arcnetE_init
r_static
r_int
id|arcnetE_init
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
r_struct
id|arcnet_local
op_star
id|lp
op_assign
(paren
r_struct
id|arcnet_local
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|ether_setup
c_func
(paren
id|dev
)paren
suffix:semicolon
multiline_comment|/* we&squot;re emulating ether here, not ARCnet */
id|dev-&gt;dev_addr
(braket
l_int|0
)braket
op_assign
l_int|0
suffix:semicolon
id|dev-&gt;dev_addr
(braket
l_int|5
)braket
op_assign
id|lp-&gt;stationid
suffix:semicolon
id|dev-&gt;mtu
op_assign
l_int|512
op_minus
r_sizeof
(paren
r_struct
id|HardHeader
)paren
op_minus
id|dev-&gt;hard_header_len
op_minus
l_int|1
suffix:semicolon
id|dev-&gt;open
op_assign
l_int|NULL
suffix:semicolon
id|dev-&gt;stop
op_assign
l_int|NULL
suffix:semicolon
id|dev-&gt;hard_start_xmit
op_assign
id|arcnetE_send_packet
suffix:semicolon
id|BUGMSG
c_func
(paren
id|D_EXTRA
comma
l_string|&quot;ARCnet Ethernet-Encap protocol initialized.&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Initialize the arc0s device.&n; */
DECL|function|arcnetS_init
r_static
r_int
id|arcnetS_init
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
r_struct
id|arcnet_local
op_star
id|lp
op_assign
(paren
r_struct
id|arcnet_local
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|arcnet_setup
c_func
(paren
id|dev
)paren
suffix:semicolon
multiline_comment|/* And now fill particular fields with arcnet values */
id|dev-&gt;dev_addr
(braket
l_int|0
)braket
op_assign
id|lp-&gt;stationid
suffix:semicolon
id|dev-&gt;hard_header_len
op_assign
r_sizeof
(paren
r_struct
id|S_ClientData
)paren
suffix:semicolon
id|dev-&gt;mtu
op_assign
l_int|512
op_minus
r_sizeof
(paren
r_struct
id|HardHeader
)paren
op_minus
id|dev-&gt;hard_header_len
op_plus
id|S_EXTRA_CLIENTDATA
suffix:semicolon
id|dev-&gt;open
op_assign
l_int|NULL
suffix:semicolon
id|dev-&gt;stop
op_assign
l_int|NULL
suffix:semicolon
id|dev-&gt;hard_start_xmit
op_assign
id|arcnetS_send_packet
suffix:semicolon
id|dev-&gt;hard_header
op_assign
id|arcnetS_header
suffix:semicolon
id|dev-&gt;rebuild_header
op_assign
id|arcnetS_rebuild_header
suffix:semicolon
id|BUGMSG
c_func
(paren
id|D_EXTRA
comma
l_string|&quot;ARCnet RFC1051 (NetBSD, AmiTCP) protocol initialized.&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/****************************************************************************&n; *                                                                          *&n; * Open and close the driver                                                *&n; *                                                                          *&n; ****************************************************************************/
multiline_comment|/* Open/initialize the board.  This is called sometime after booting when&n; * the &squot;ifconfig&squot; program is run.&n; *&n; * This routine should set everything up anew at each open, even&n; * registers that &quot;should&quot; only need to be set once at boot, so that&n; * there is non-reboot way to recover if something goes wrong.&n; */
r_static
r_int
DECL|function|arcnet_open
id|arcnet_open
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
r_struct
id|arcnet_local
op_star
id|lp
op_assign
(paren
r_struct
id|arcnet_local
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_int
id|ioaddr
op_assign
id|dev-&gt;base_addr
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;metric
op_ge
l_int|1000
)paren
(brace
id|arcnet_debug
op_assign
id|dev-&gt;metric
op_minus
l_int|1000
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;%6s: debug level set to %d&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|arcnet_debug
)paren
suffix:semicolon
id|dev-&gt;metric
op_assign
l_int|1
suffix:semicolon
)brace
id|BUGLVL
c_func
(paren
id|D_EXTRA
)paren
id|printk
c_func
(paren
id|version
)paren
suffix:semicolon
id|BUGMSG
c_func
(paren
id|D_EXTRA
comma
l_string|&quot;arcnet_open: resetting card.&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* try to reset - twice if it fails the first time */
r_if
c_cond
(paren
id|arcnet_reset
c_func
(paren
id|dev
)paren
op_logical_and
id|arcnet_reset
c_func
(paren
id|dev
)paren
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
id|dev-&gt;tbusy
op_assign
l_int|0
suffix:semicolon
id|dev-&gt;interrupt
op_assign
l_int|0
suffix:semicolon
id|lp-&gt;intx
op_assign
l_int|0
suffix:semicolon
id|lp-&gt;in_txhandler
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* The RFC1201 driver is the default - just store */
id|lp-&gt;adev
op_assign
id|dev
suffix:semicolon
id|BUGMSG
c_func
(paren
id|D_EXTRA
comma
l_string|&quot;ARCnet RFC1201 protocol initialized.&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* Initialize the ethernet-encap protocol driver */
id|lp-&gt;edev
op_assign
(paren
r_struct
id|device
op_star
)paren
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|device
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|lp-&gt;edev
op_eq
l_int|NULL
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|memcpy
c_func
(paren
id|lp-&gt;edev
comma
id|dev
comma
r_sizeof
(paren
r_struct
id|device
)paren
)paren
suffix:semicolon
id|lp-&gt;edev-&gt;name
op_assign
(paren
r_char
op_star
)paren
id|kmalloc
c_func
(paren
l_int|10
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|lp-&gt;edev-&gt;name
op_eq
l_int|NULL
)paren
(brace
id|kfree
c_func
(paren
id|lp-&gt;edev
)paren
suffix:semicolon
id|lp-&gt;edev
op_assign
l_int|NULL
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|sprintf
c_func
(paren
id|lp-&gt;edev-&gt;name
comma
l_string|&quot;%se&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|lp-&gt;edev-&gt;init
op_assign
id|arcnetE_init
suffix:semicolon
id|register_netdev
c_func
(paren
id|lp-&gt;edev
)paren
suffix:semicolon
multiline_comment|/* Initialize the RFC1051-encap protocol driver */
id|lp-&gt;sdev
op_assign
(paren
r_struct
id|device
op_star
)paren
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|device
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|lp-&gt;sdev
comma
id|dev
comma
r_sizeof
(paren
r_struct
id|device
)paren
)paren
suffix:semicolon
id|lp-&gt;sdev-&gt;name
op_assign
(paren
r_char
op_star
)paren
id|kmalloc
c_func
(paren
l_int|10
comma
id|GFP_KERNEL
)paren
suffix:semicolon
id|sprintf
c_func
(paren
id|lp-&gt;sdev-&gt;name
comma
l_string|&quot;%ss&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|lp-&gt;sdev-&gt;init
op_assign
id|arcnetS_init
suffix:semicolon
id|register_netdev
c_func
(paren
id|lp-&gt;sdev
)paren
suffix:semicolon
multiline_comment|/* we&squot;re started */
id|START
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* make sure we&squot;re ready to receive IRQ&squot;s.&n;&t; * arcnet_reset sets this for us, but if we receive one before&n;&t; * START is set to 1, it could be ignored.  So, we turn IRQ&squot;s&n;&t; * off, then on again to clean out the IRQ controller.&n;&t; */
id|outb
c_func
(paren
l_int|0
comma
id|INTMASK
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|1
)paren
suffix:semicolon
multiline_comment|/* give it time to set the mask before&n;&t;&t;&t; * we reset it again. (may not even be&n;&t;&t;&t; * necessary)&n;&t;&t;&t; */
id|SETMASK
suffix:semicolon
id|MOD_INC_USE_COUNT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* The inverse routine to arcnet_open - shuts down the card.&n; */
r_static
r_int
DECL|function|arcnet_close
id|arcnet_close
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
r_int
id|ioaddr
op_assign
id|dev-&gt;base_addr
suffix:semicolon
r_struct
id|arcnet_local
op_star
id|lp
op_assign
(paren
r_struct
id|arcnet_local
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|TBUSY
op_assign
l_int|1
suffix:semicolon
id|START
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Flush TX and disable RX */
id|lp-&gt;intmask
op_assign
l_int|0
suffix:semicolon
id|SETMASK
suffix:semicolon
multiline_comment|/* no IRQ&squot;s (except RESET, of course) */
id|outb
c_func
(paren
id|NOTXcmd
comma
id|COMMAND
)paren
suffix:semicolon
multiline_comment|/* stop transmit */
id|outb
c_func
(paren
id|NORXcmd
comma
id|COMMAND
)paren
suffix:semicolon
multiline_comment|/* disable receive */
multiline_comment|/* reset more flags */
id|INTERRUPT
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* do NOT free lp-&gt;adev!!  It&squot;s static! */
id|lp-&gt;adev
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/* free the ethernet-encap protocol device */
id|lp-&gt;edev-&gt;priv
op_assign
l_int|NULL
suffix:semicolon
id|dev_close
c_func
(paren
id|lp-&gt;edev
)paren
suffix:semicolon
id|unregister_netdev
c_func
(paren
id|lp-&gt;edev
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|lp-&gt;edev-&gt;name
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|lp-&gt;edev
)paren
suffix:semicolon
id|lp-&gt;edev
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/* free the RFC1051-encap protocol device */
id|lp-&gt;sdev-&gt;priv
op_assign
l_int|NULL
suffix:semicolon
id|dev_close
c_func
(paren
id|lp-&gt;sdev
)paren
suffix:semicolon
id|unregister_netdev
c_func
(paren
id|lp-&gt;sdev
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|lp-&gt;sdev-&gt;name
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|lp-&gt;sdev
)paren
suffix:semicolon
id|lp-&gt;sdev
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/* Update the statistics here. (not necessary in ARCnet) */
id|MOD_DEC_USE_COUNT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/****************************************************************************&n; *                                                                          *&n; * Transmitter routines                                                     *&n; *                                                                          *&n; ****************************************************************************/
multiline_comment|/* Generic error checking routine for arcnet??_send_packet&n; */
r_static
r_int
DECL|function|arcnet_send_packet_bad
id|arcnet_send_packet_bad
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|device
op_star
id|dev
)paren
(brace
r_struct
id|arcnet_local
op_star
id|lp
op_assign
(paren
r_struct
id|arcnet_local
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_int
id|ioaddr
op_assign
id|dev-&gt;base_addr
suffix:semicolon
id|BUGMSG
c_func
(paren
id|D_DURING
comma
l_string|&quot;transmit requested (status=%Xh, inTX=%d)&bslash;n&quot;
comma
id|inb
c_func
(paren
id|STATUS
)paren
comma
id|lp-&gt;intx
)paren
suffix:semicolon
r_if
c_cond
(paren
id|lp-&gt;in_txhandler
)paren
(brace
id|BUGMSG
c_func
(paren
id|D_NORMAL
comma
l_string|&quot;send_packet called while in txhandler!&bslash;n&quot;
)paren
suffix:semicolon
id|lp-&gt;stats.tx_dropped
op_increment
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|lp-&gt;intx
OG
l_int|1
)paren
(brace
id|BUGMSG
c_func
(paren
id|D_NORMAL
comma
l_string|&quot;send_packet called while intx!&bslash;n&quot;
)paren
suffix:semicolon
id|lp-&gt;stats.tx_dropped
op_increment
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|IF_TBUSY
)paren
(brace
multiline_comment|/* If we get here, some higher level has decided we are broken.&n;&t;&t;   There should really be a &quot;kick me&quot; function call instead. */
r_int
id|tickssofar
op_assign
id|jiffies
op_minus
id|dev-&gt;trans_start
suffix:semicolon
multiline_comment|/*int recbuf=lp-&gt;recbuf;*/
r_int
id|status
op_assign
id|inb
c_func
(paren
id|STATUS
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tickssofar
OL
id|TX_TIMEOUT
)paren
(brace
id|BUGMSG
c_func
(paren
id|D_DURING
comma
l_string|&quot;premature kickme! (status=%Xh ticks=%d o.skb=%ph numsegs=%d segnum=%d&bslash;n&quot;
comma
id|status
comma
id|tickssofar
comma
id|lp-&gt;outgoing.skb
comma
id|lp-&gt;outgoing.numsegs
comma
id|lp-&gt;outgoing.segnum
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
id|lp-&gt;intmask
op_and_assign
op_complement
id|TXFREEflag
suffix:semicolon
id|SETMASK
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
id|TXFREEflag
)paren
multiline_comment|/* transmit _DID_ finish */
(brace
id|BUGMSG
c_func
(paren
id|D_NORMAL
comma
l_string|&quot;tx timeout - missed IRQ? (status=%Xh, inTXh=%d, ticks=%d, mask=%Xh)&bslash;n&quot;
comma
id|status
comma
id|lp-&gt;in_txhandler
comma
id|tickssofar
comma
id|lp-&gt;intmask
)paren
suffix:semicolon
id|lp-&gt;stats.tx_errors
op_increment
suffix:semicolon
)brace
r_else
(brace
id|BUGMSG
c_func
(paren
id|D_NORMAL
comma
l_string|&quot;tx timed out (status=%Xh, inTXh=%d, tickssofar=%d, intmask=%Xh)&bslash;n&quot;
comma
id|status
comma
id|lp-&gt;in_txhandler
comma
id|tickssofar
comma
id|lp-&gt;intmask
)paren
suffix:semicolon
id|lp-&gt;stats.tx_errors
op_increment
suffix:semicolon
id|lp-&gt;stats.tx_aborted_errors
op_increment
suffix:semicolon
id|outb
c_func
(paren
id|NOTXcmd
comma
id|COMMAND
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|lp-&gt;outgoing.skb
)paren
(brace
id|dev_kfree_skb
c_func
(paren
id|lp-&gt;outgoing.skb
comma
id|FREE_WRITE
)paren
suffix:semicolon
id|lp-&gt;stats.tx_dropped
op_increment
suffix:semicolon
)brace
id|lp-&gt;outgoing.skb
op_assign
l_int|NULL
suffix:semicolon
id|TBUSY
op_assign
l_int|0
suffix:semicolon
id|lp-&gt;txready
op_assign
l_int|0
suffix:semicolon
id|lp-&gt;sending
op_assign
l_int|0
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
multiline_comment|/* If some higher layer thinks we&squot;ve missed a tx-done interrupt&n;&t;   we are passed NULL. Caution: dev_tint() handles the cli()/sti()&n;&t;   itself. */
r_if
c_cond
(paren
id|skb
op_eq
l_int|NULL
)paren
(brace
id|BUGMSG
c_func
(paren
id|D_NORMAL
comma
l_string|&quot;tx passed null skb (status=%Xh, inTX=%d, tickssofar=%ld)&bslash;n&quot;
comma
id|inb
c_func
(paren
id|STATUS
)paren
comma
id|lp-&gt;intx
comma
id|jiffies
op_minus
id|dev-&gt;trans_start
)paren
suffix:semicolon
id|lp-&gt;stats.tx_errors
op_increment
suffix:semicolon
id|dev_tint
c_func
(paren
id|dev
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|lp-&gt;txready
)paren
multiline_comment|/* transmit already in progress! */
(brace
id|BUGMSG
c_func
(paren
id|D_NORMAL
comma
l_string|&quot;trying to start new packet while busy! (status=%Xh)&bslash;n&quot;
comma
id|inb
c_func
(paren
id|STATUS
)paren
)paren
suffix:semicolon
id|lp-&gt;intmask
op_and_assign
op_complement
id|TXFREEflag
suffix:semicolon
id|SETMASK
suffix:semicolon
id|outb
c_func
(paren
id|NOTXcmd
comma
id|COMMAND
)paren
suffix:semicolon
multiline_comment|/* abort current send */
id|arcnet_inthandler
c_func
(paren
id|dev
)paren
suffix:semicolon
multiline_comment|/* fake an interrupt */
id|lp-&gt;stats.tx_errors
op_increment
suffix:semicolon
id|lp-&gt;stats.tx_fifo_errors
op_increment
suffix:semicolon
id|lp-&gt;txready
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* we definitely need this line! */
r_return
l_int|1
suffix:semicolon
)brace
multiline_comment|/* Block a timer-based transmit from overlapping.  This could better be&n;&t;   done with atomic_swap(1, dev-&gt;tbusy), but set_bit() works as well. */
r_if
c_cond
(paren
id|set_bit
c_func
(paren
l_int|0
comma
(paren
r_void
op_star
)paren
op_amp
id|dev-&gt;tbusy
)paren
op_ne
l_int|0
)paren
(brace
id|BUGMSG
c_func
(paren
id|D_NORMAL
comma
l_string|&quot;transmitter called with busy bit set! (status=%Xh, inTX=%d, tickssofar=%ld)&bslash;n&quot;
comma
id|inb
c_func
(paren
id|STATUS
)paren
comma
id|lp-&gt;intx
comma
id|jiffies
op_minus
id|dev-&gt;trans_start
)paren
suffix:semicolon
id|lp-&gt;stats.tx_errors
op_increment
suffix:semicolon
id|lp-&gt;stats.tx_fifo_errors
op_increment
suffix:semicolon
r_return
op_minus
id|EBUSY
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Called by the kernel in order to transmit a packet.&n; */
r_static
r_int
DECL|function|arcnetA_send_packet
id|arcnetA_send_packet
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|device
op_star
id|dev
)paren
(brace
r_struct
id|arcnet_local
op_star
id|lp
op_assign
(paren
r_struct
id|arcnet_local
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_int
id|ioaddr
op_assign
id|dev-&gt;base_addr
comma
id|bad
suffix:semicolon
r_struct
id|Outgoing
op_star
id|out
op_assign
op_amp
(paren
id|lp-&gt;outgoing
)paren
suffix:semicolon
id|lp-&gt;intx
op_increment
suffix:semicolon
id|bad
op_assign
id|arcnet_send_packet_bad
c_func
(paren
id|skb
comma
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|bad
)paren
(brace
id|lp-&gt;intx
op_decrement
suffix:semicolon
r_return
id|bad
suffix:semicolon
)brace
id|TBUSY
op_assign
l_int|1
suffix:semicolon
id|out-&gt;length
op_assign
l_int|1
OL
id|skb-&gt;len
ques
c_cond
id|skb-&gt;len
suffix:colon
l_int|1
suffix:semicolon
id|out-&gt;hdr
op_assign
(paren
r_struct
id|ClientData
op_star
)paren
id|skb-&gt;data
suffix:semicolon
id|out-&gt;skb
op_assign
id|skb
suffix:semicolon
id|BUGLVL
c_func
(paren
id|D_SKB
)paren
(brace
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|skb-&gt;len
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|i
op_mod
l_int|16
op_eq
l_int|0
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;&bslash;n[%04hX] &quot;
comma
id|i
)paren
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;%02hX &quot;
comma
(paren
(paren
r_int
r_char
op_star
)paren
id|skb-&gt;data
)paren
(braket
id|i
)braket
)paren
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
)brace
id|out-&gt;hdr-&gt;sequence
op_assign
(paren
id|lp-&gt;sequence
op_increment
)paren
suffix:semicolon
multiline_comment|/* fits in one packet? */
r_if
c_cond
(paren
id|out-&gt;length
op_minus
id|EXTRA_CLIENTDATA
op_le
id|XMTU
)paren
(brace
id|BUGMSG
c_func
(paren
id|D_DURING
comma
l_string|&quot;not splitting %d-byte packet. (split_flag=%d)&bslash;n&quot;
comma
id|out-&gt;length
comma
id|out-&gt;hdr-&gt;split_flag
)paren
suffix:semicolon
r_if
c_cond
(paren
id|out-&gt;hdr-&gt;split_flag
)paren
id|BUGMSG
c_func
(paren
id|D_NORMAL
comma
l_string|&quot;short packet has split_flag set?! (split_flag=%d)&bslash;n&quot;
comma
id|out-&gt;hdr-&gt;split_flag
)paren
suffix:semicolon
id|out-&gt;numsegs
op_assign
l_int|1
suffix:semicolon
id|out-&gt;segnum
op_assign
l_int|1
suffix:semicolon
id|arcnetAS_prepare_tx
c_func
(paren
id|dev
comma
(paren
(paren
r_char
op_star
)paren
id|out-&gt;hdr
)paren
op_plus
id|EXTRA_CLIENTDATA
comma
r_sizeof
(paren
r_struct
id|ClientData
)paren
op_minus
id|EXTRA_CLIENTDATA
comma
(paren
(paren
r_char
op_star
)paren
id|skb-&gt;data
)paren
op_plus
r_sizeof
(paren
r_struct
id|ClientData
)paren
comma
id|out-&gt;length
op_minus
r_sizeof
(paren
r_struct
id|ClientData
)paren
comma
id|out-&gt;hdr-&gt;daddr
comma
l_int|1
)paren
suffix:semicolon
multiline_comment|/* done right away */
id|dev_kfree_skb
c_func
(paren
id|out-&gt;skb
comma
id|FREE_WRITE
)paren
suffix:semicolon
id|out-&gt;skb
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
id|arcnet_go_tx
c_func
(paren
id|dev
comma
l_int|1
)paren
)paren
(brace
multiline_comment|/* inform upper layers */
id|TBUSY
op_assign
l_int|0
suffix:semicolon
id|mark_bh
c_func
(paren
id|NET_BH
)paren
suffix:semicolon
)brace
)brace
r_else
multiline_comment|/* too big for one - split it */
(brace
r_int
id|maxsegsize
op_assign
id|XMTU
op_minus
l_int|4
suffix:semicolon
id|out-&gt;data
op_assign
(paren
id|u_char
op_star
)paren
id|skb-&gt;data
op_plus
r_sizeof
(paren
r_struct
id|ClientData
)paren
suffix:semicolon
id|out-&gt;dataleft
op_assign
id|out-&gt;length
op_minus
r_sizeof
(paren
r_struct
id|ClientData
)paren
suffix:semicolon
id|out-&gt;numsegs
op_assign
(paren
id|out-&gt;dataleft
op_plus
id|maxsegsize
op_minus
l_int|1
)paren
op_div
id|maxsegsize
suffix:semicolon
id|out-&gt;segnum
op_assign
l_int|0
suffix:semicolon
id|BUGMSG
c_func
(paren
id|D_TX
comma
l_string|&quot;packet (%d bytes) split into %d fragments:&bslash;n&quot;
comma
id|out-&gt;length
comma
id|out-&gt;numsegs
)paren
suffix:semicolon
multiline_comment|/* if a packet waiting, launch it */
id|arcnet_go_tx
c_func
(paren
id|dev
comma
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|lp-&gt;txready
)paren
(brace
multiline_comment|/* prepare a packet, launch it and prepare&n;&t;&t;&t; * another.&n;&t;&t;&t; */
id|arcnetA_continue_tx
c_func
(paren
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|arcnet_go_tx
c_func
(paren
id|dev
comma
l_int|1
)paren
)paren
(brace
id|arcnetA_continue_tx
c_func
(paren
id|dev
)paren
suffix:semicolon
id|arcnet_go_tx
c_func
(paren
id|dev
comma
l_int|1
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* if segnum==numsegs, the transmission is finished;&n;&t;&t; * free the skb right away.&n;&t;&t; */
r_if
c_cond
(paren
id|out-&gt;segnum
op_eq
id|out-&gt;numsegs
)paren
(brace
multiline_comment|/* transmit completed */
id|out-&gt;segnum
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|out-&gt;skb
)paren
id|dev_kfree_skb
c_func
(paren
id|out-&gt;skb
comma
id|FREE_WRITE
)paren
suffix:semicolon
id|out-&gt;skb
op_assign
l_int|NULL
suffix:semicolon
)brace
)brace
id|dev-&gt;trans_start
op_assign
id|jiffies
suffix:semicolon
id|lp-&gt;intx
op_decrement
suffix:semicolon
multiline_comment|/* make sure we didn&squot;t ignore a TX IRQ while we were in here */
id|lp-&gt;intmask
op_or_assign
id|TXFREEflag
suffix:semicolon
id|SETMASK
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Called by the kernel in order to transmit an ethernet-type packet.&n; */
r_static
r_int
DECL|function|arcnetE_send_packet
id|arcnetE_send_packet
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|device
op_star
id|dev
)paren
(brace
r_struct
id|arcnet_local
op_star
id|lp
op_assign
(paren
r_struct
id|arcnet_local
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_int
id|ioaddr
op_assign
id|dev-&gt;base_addr
comma
id|bad
suffix:semicolon
r_union
id|ArcPacket
op_star
id|arcpacket
op_assign
(paren
r_union
id|ArcPacket
op_star
)paren
(paren
id|dev-&gt;mem_start
op_plus
l_int|512
op_star
(paren
id|lp-&gt;txbuf
op_xor
l_int|1
)paren
)paren
suffix:semicolon
id|u_char
op_star
id|arcsoft
comma
id|daddr
suffix:semicolon
r_int
id|offset
comma
id|length
op_assign
id|skb-&gt;len
op_plus
l_int|1
suffix:semicolon
id|lp-&gt;intx
op_increment
suffix:semicolon
id|bad
op_assign
id|arcnet_send_packet_bad
c_func
(paren
id|skb
comma
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|bad
)paren
(brace
id|lp-&gt;intx
op_decrement
suffix:semicolon
r_return
id|bad
suffix:semicolon
)brace
id|TBUSY
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|length
OG
id|XMTU
)paren
(brace
id|BUGMSG
c_func
(paren
id|D_NORMAL
comma
l_string|&quot;MTU must be &lt;= 493 for ethernet encap (length=%d).&bslash;n&quot;
comma
id|length
)paren
suffix:semicolon
id|BUGMSG
c_func
(paren
id|D_NORMAL
comma
l_string|&quot;transmit aborted.&bslash;n&quot;
)paren
suffix:semicolon
id|dev_kfree_skb
c_func
(paren
id|skb
comma
id|FREE_WRITE
)paren
suffix:semicolon
id|lp-&gt;intx
op_decrement
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|BUGMSG
c_func
(paren
id|D_DURING
comma
l_string|&quot;starting tx sequence...&bslash;n&quot;
)paren
suffix:semicolon
id|lp-&gt;txbuf
op_assign
id|lp-&gt;txbuf
op_xor
l_int|1
suffix:semicolon
multiline_comment|/* XOR with 1 to alternate btw 2 &amp; 3 */
multiline_comment|/* clean out the page to make debugging make more sense :) */
id|BUGLVL
c_func
(paren
id|D_DURING
)paren
id|memset
c_func
(paren
(paren
r_void
op_star
)paren
id|dev-&gt;mem_start
op_plus
id|lp-&gt;txbuf
op_star
l_int|512
comma
l_int|0x42
comma
l_int|512
)paren
suffix:semicolon
multiline_comment|/* broadcasts have address FF:FF:FF:FF:FF:FF in etherspeak */
r_if
c_cond
(paren
(paren
(paren
r_struct
id|ethhdr
op_star
)paren
(paren
id|skb-&gt;data
)paren
)paren
op_member_access_from_pointer
id|h_dest
(braket
l_int|0
)braket
op_eq
l_int|0xFF
)paren
id|daddr
op_assign
id|arcpacket-&gt;hardheader.destination
op_assign
l_int|0
suffix:semicolon
r_else
id|daddr
op_assign
id|arcpacket-&gt;hardheader.destination
op_assign
(paren
(paren
r_struct
id|ethhdr
op_star
)paren
(paren
id|skb-&gt;data
)paren
)paren
op_member_access_from_pointer
id|h_dest
(braket
l_int|5
)braket
suffix:semicolon
multiline_comment|/* load packet into shared memory */
id|offset
op_assign
l_int|512
op_minus
id|length
suffix:semicolon
r_if
c_cond
(paren
id|length
OG
id|MTU
)paren
multiline_comment|/* long/exception packet */
(brace
r_if
c_cond
(paren
id|length
OL
id|MinTU
)paren
id|offset
op_sub_assign
l_int|3
suffix:semicolon
id|arcpacket-&gt;hardheader.offset1
op_assign
l_int|0
suffix:semicolon
id|arcpacket-&gt;hardheader.offset2
op_assign
id|offset
suffix:semicolon
)brace
r_else
multiline_comment|/* short packet */
(brace
id|arcpacket-&gt;hardheader.offset1
op_assign
(paren
id|offset
op_sub_assign
l_int|256
)paren
suffix:semicolon
)brace
id|BUGMSG
c_func
(paren
id|D_DURING
comma
l_string|&quot; length=%Xh, offset=%Xh, offset1=%Xh, offset2=%Xh&bslash;n&quot;
comma
id|length
comma
id|offset
comma
id|arcpacket-&gt;hardheader.offset1
comma
id|arcpacket-&gt;hardheader.offset2
)paren
suffix:semicolon
id|arcsoft
op_assign
op_amp
id|arcpacket-&gt;raw
(braket
id|offset
)braket
suffix:semicolon
id|arcsoft
(braket
l_int|0
)braket
op_assign
id|ARC_P_ETHER
suffix:semicolon
id|arcsoft
op_increment
suffix:semicolon
multiline_comment|/* copy the packet into ARCnet shmem&n;&t; *  - the first bytes of ClientData header are skipped&n;&t; */
id|BUGMSG
c_func
(paren
id|D_DURING
comma
l_string|&quot;ready to memcpy&bslash;n&quot;
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|arcsoft
comma
id|skb-&gt;data
comma
id|skb-&gt;len
)paren
suffix:semicolon
id|BUGMSG
c_func
(paren
id|D_DURING
comma
l_string|&quot;transmitting packet to station %02Xh (%d bytes)&bslash;n&quot;
comma
id|daddr
comma
id|length
)paren
suffix:semicolon
id|BUGLVL
c_func
(paren
id|D_TX
)paren
(brace
r_int
id|countx
comma
id|county
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;%6s: packet dump [tx] follows:&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_for
c_loop
(paren
id|county
op_assign
l_int|0
suffix:semicolon
id|county
OL
l_int|16
op_plus
(paren
id|length
op_ge
l_int|240
)paren
op_star
l_int|16
suffix:semicolon
id|county
op_increment
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;&bslash;n[%04X] &quot;
comma
id|county
op_star
l_int|16
)paren
suffix:semicolon
r_for
c_loop
(paren
id|countx
op_assign
l_int|0
suffix:semicolon
id|countx
OL
l_int|16
suffix:semicolon
id|countx
op_increment
)paren
id|printk
c_func
(paren
l_string|&quot;%02X &quot;
comma
id|arcpacket-&gt;raw
(braket
id|county
op_star
l_int|16
op_plus
id|countx
)braket
)paren
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
)brace
macro_line|#ifdef VERIFY_ACK
id|lp-&gt;lastload_dest
op_assign
id|daddr
suffix:semicolon
macro_line|#endif
id|lp-&gt;txready
op_assign
id|lp-&gt;txbuf
suffix:semicolon
multiline_comment|/* packet is ready for sending */
id|dev_kfree_skb
c_func
(paren
id|skb
comma
id|FREE_WRITE
)paren
suffix:semicolon
r_if
c_cond
(paren
id|arcnet_go_tx
c_func
(paren
id|dev
comma
l_int|1
)paren
)paren
(brace
multiline_comment|/* inform upper layers */
id|TBUSY
op_assign
l_int|0
suffix:semicolon
id|mark_bh
c_func
(paren
id|NET_BH
)paren
suffix:semicolon
)brace
id|dev-&gt;trans_start
op_assign
id|jiffies
suffix:semicolon
id|lp-&gt;intx
op_decrement
suffix:semicolon
multiline_comment|/* make sure we didn&squot;t ignore a TX IRQ while we were in here */
id|lp-&gt;intmask
op_or_assign
id|TXFREEflag
suffix:semicolon
id|SETMASK
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Called by the kernel in order to transmit an RFC1051-type packet.&n; */
r_static
r_int
DECL|function|arcnetS_send_packet
id|arcnetS_send_packet
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|device
op_star
id|dev
)paren
(brace
r_struct
id|arcnet_local
op_star
id|lp
op_assign
(paren
r_struct
id|arcnet_local
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_int
id|ioaddr
op_assign
id|dev-&gt;base_addr
comma
id|bad
comma
id|length
suffix:semicolon
r_struct
id|S_ClientData
op_star
id|hdr
op_assign
(paren
r_struct
id|S_ClientData
op_star
)paren
id|skb-&gt;data
suffix:semicolon
id|lp-&gt;intx
op_increment
suffix:semicolon
id|bad
op_assign
id|arcnet_send_packet_bad
c_func
(paren
id|skb
comma
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|bad
)paren
(brace
id|lp-&gt;intx
op_decrement
suffix:semicolon
r_return
id|bad
suffix:semicolon
)brace
id|TBUSY
op_assign
l_int|1
suffix:semicolon
id|length
op_assign
l_int|1
OL
id|skb-&gt;len
ques
c_cond
id|skb-&gt;len
suffix:colon
l_int|1
suffix:semicolon
id|BUGLVL
c_func
(paren
id|D_SKB
)paren
(brace
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|skb-&gt;len
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|i
op_mod
l_int|16
op_eq
l_int|0
)paren
id|printk
c_func
(paren
l_string|&quot;&bslash;n[%04hX] &quot;
comma
id|i
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;%02hX &quot;
comma
(paren
(paren
r_int
r_char
op_star
)paren
id|skb-&gt;data
)paren
(braket
id|i
)braket
)paren
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/* fits in one packet? */
r_if
c_cond
(paren
id|length
op_minus
id|S_EXTRA_CLIENTDATA
op_le
id|XMTU
)paren
(brace
id|arcnetAS_prepare_tx
c_func
(paren
id|dev
comma
id|skb-&gt;data
op_plus
id|S_EXTRA_CLIENTDATA
comma
r_sizeof
(paren
r_struct
id|S_ClientData
)paren
op_minus
id|S_EXTRA_CLIENTDATA
comma
id|skb-&gt;data
op_plus
r_sizeof
(paren
r_struct
id|S_ClientData
)paren
comma
id|length
op_minus
r_sizeof
(paren
r_struct
id|S_ClientData
)paren
comma
id|hdr-&gt;daddr
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* done right away */
id|dev_kfree_skb
c_func
(paren
id|skb
comma
id|FREE_WRITE
)paren
suffix:semicolon
r_if
c_cond
(paren
id|arcnet_go_tx
c_func
(paren
id|dev
comma
l_int|1
)paren
)paren
(brace
multiline_comment|/* inform upper layers */
id|TBUSY
op_assign
l_int|0
suffix:semicolon
id|mark_bh
c_func
(paren
id|NET_BH
)paren
suffix:semicolon
)brace
)brace
r_else
multiline_comment|/* too big for one - not accepted */
(brace
id|BUGMSG
c_func
(paren
id|D_NORMAL
comma
l_string|&quot;packet too long (length=%d)&bslash;n&quot;
comma
id|length
)paren
suffix:semicolon
id|dev_kfree_skb
c_func
(paren
id|skb
comma
id|FREE_WRITE
)paren
suffix:semicolon
id|lp-&gt;stats.tx_dropped
op_increment
suffix:semicolon
id|TBUSY
op_assign
l_int|0
suffix:semicolon
id|mark_bh
c_func
(paren
id|NET_BH
)paren
suffix:semicolon
)brace
id|dev-&gt;trans_start
op_assign
id|jiffies
suffix:semicolon
id|lp-&gt;intx
op_decrement
suffix:semicolon
multiline_comment|/* make sure we didn&squot;t ignore a TX IRQ while we were in here */
id|lp-&gt;intmask
op_or_assign
id|TXFREEflag
suffix:semicolon
id|SETMASK
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* After an RFC1201 split packet has been set up, this function calls&n; * arcnetAS_prepare_tx to load the next segment into the card.  This function&n; * does NOT automatically call arcnet_go_tx.&n; */
DECL|function|arcnetA_continue_tx
r_static
r_void
id|arcnetA_continue_tx
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
r_struct
id|arcnet_local
op_star
id|lp
op_assign
(paren
r_struct
id|arcnet_local
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_int
id|ioaddr
op_assign
id|dev-&gt;base_addr
comma
id|maxsegsize
op_assign
id|XMTU
op_minus
l_int|4
suffix:semicolon
r_struct
id|Outgoing
op_star
id|out
op_assign
op_amp
(paren
id|lp-&gt;outgoing
)paren
suffix:semicolon
id|BUGMSG
c_func
(paren
id|D_DURING
comma
l_string|&quot;continue_tx called (status=%Xh, intx=%d, intxh=%d, intmask=%Xh&bslash;n&quot;
comma
id|inb
c_func
(paren
id|STATUS
)paren
comma
id|lp-&gt;intx
comma
id|lp-&gt;in_txhandler
comma
id|lp-&gt;intmask
)paren
suffix:semicolon
r_if
c_cond
(paren
id|lp-&gt;txready
)paren
(brace
id|BUGMSG
c_func
(paren
id|D_NORMAL
comma
l_string|&quot;continue_tx: called with packet in buffer!&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|out-&gt;segnum
op_ge
id|out-&gt;numsegs
)paren
(brace
id|BUGMSG
c_func
(paren
id|D_NORMAL
comma
l_string|&quot;continue_tx: building segment %d of %d!&bslash;n&quot;
comma
id|out-&gt;segnum
op_plus
l_int|1
comma
id|out-&gt;numsegs
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|out-&gt;segnum
)paren
multiline_comment|/* first packet */
id|out-&gt;hdr-&gt;split_flag
op_assign
(paren
(paren
id|out-&gt;numsegs
op_minus
l_int|2
)paren
op_lshift
l_int|1
)paren
op_plus
l_int|1
suffix:semicolon
r_else
id|out-&gt;hdr-&gt;split_flag
op_assign
id|out-&gt;segnum
op_lshift
l_int|1
suffix:semicolon
id|out-&gt;seglen
op_assign
id|maxsegsize
suffix:semicolon
r_if
c_cond
(paren
id|out-&gt;seglen
OG
id|out-&gt;dataleft
)paren
id|out-&gt;seglen
op_assign
id|out-&gt;dataleft
suffix:semicolon
id|BUGMSG
c_func
(paren
id|D_TX
comma
l_string|&quot;building packet #%d (%d bytes) of %d (%d total), splitflag=%d&bslash;n&quot;
comma
id|out-&gt;segnum
op_plus
l_int|1
comma
id|out-&gt;seglen
comma
id|out-&gt;numsegs
comma
id|out-&gt;length
comma
id|out-&gt;hdr-&gt;split_flag
)paren
suffix:semicolon
id|arcnetAS_prepare_tx
c_func
(paren
id|dev
comma
(paren
(paren
r_char
op_star
)paren
id|out-&gt;hdr
)paren
op_plus
id|EXTRA_CLIENTDATA
comma
r_sizeof
(paren
r_struct
id|ClientData
)paren
op_minus
id|EXTRA_CLIENTDATA
comma
id|out-&gt;data
comma
id|out-&gt;seglen
comma
id|out-&gt;hdr-&gt;daddr
comma
l_int|1
)paren
suffix:semicolon
id|out-&gt;dataleft
op_sub_assign
id|out-&gt;seglen
suffix:semicolon
id|out-&gt;data
op_add_assign
id|out-&gt;seglen
suffix:semicolon
id|out-&gt;segnum
op_increment
suffix:semicolon
)brace
multiline_comment|/* Given an skb, copy a packet into the ARCnet buffers for later transmission&n; * by arcnet_go_tx.&n; */
r_static
r_void
DECL|function|arcnetAS_prepare_tx
id|arcnetAS_prepare_tx
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
id|u_char
op_star
id|hdr
comma
r_int
id|hdrlen
comma
r_char
op_star
id|data
comma
r_int
id|length
comma
r_int
id|daddr
comma
r_int
id|exceptA
)paren
(brace
r_struct
id|arcnet_local
op_star
id|lp
op_assign
(paren
r_struct
id|arcnet_local
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_struct
id|ClientData
op_star
id|arcsoft
suffix:semicolon
r_union
id|ArcPacket
op_star
id|arcpacket
op_assign
(paren
r_union
id|ArcPacket
op_star
)paren
(paren
id|dev-&gt;mem_start
op_plus
l_int|512
op_star
(paren
id|lp-&gt;txbuf
op_xor
l_int|1
)paren
)paren
suffix:semicolon
r_int
id|offset
suffix:semicolon
id|lp-&gt;txbuf
op_assign
id|lp-&gt;txbuf
op_xor
l_int|1
suffix:semicolon
multiline_comment|/* XOR with 1 to alternate between 2 and 3 */
id|length
op_add_assign
id|hdrlen
suffix:semicolon
id|BUGMSG
c_func
(paren
id|D_TX
comma
l_string|&quot;arcnetAS_prep_tx: hdr:%ph, length:%d, data:%ph&bslash;n&quot;
comma
id|hdr
comma
id|length
comma
id|data
)paren
suffix:semicolon
multiline_comment|/* clean out the page to make debugging make more sense :) */
id|BUGLVL
c_func
(paren
id|D_DURING
)paren
id|memset
c_func
(paren
(paren
r_void
op_star
)paren
id|dev-&gt;mem_start
op_plus
id|lp-&gt;txbuf
op_star
l_int|512
comma
l_int|0x42
comma
l_int|512
)paren
suffix:semicolon
id|arcpacket-&gt;hardheader.destination
op_assign
id|daddr
suffix:semicolon
multiline_comment|/* load packet into shared memory */
r_if
c_cond
(paren
id|length
op_le
id|MTU
)paren
multiline_comment|/* Normal (256-byte) Packet */
(brace
id|arcpacket-&gt;hardheader.offset1
op_assign
id|offset
op_assign
l_int|256
op_minus
id|length
suffix:semicolon
id|arcsoft
op_assign
(paren
r_struct
id|ClientData
op_star
)paren
(paren
op_amp
id|arcpacket-&gt;raw
(braket
id|offset
)braket
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|length
op_ge
id|MinTU
)paren
multiline_comment|/* Extended (512-byte) Packet */
(brace
id|arcpacket-&gt;hardheader.offset1
op_assign
l_int|0
suffix:semicolon
id|arcpacket-&gt;hardheader.offset2
op_assign
id|offset
op_assign
l_int|512
op_minus
id|length
suffix:semicolon
id|arcsoft
op_assign
(paren
r_struct
id|ClientData
op_star
)paren
(paren
op_amp
id|arcpacket-&gt;raw
(braket
id|offset
)braket
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|exceptA
)paren
multiline_comment|/* RFC1201 Exception Packet */
(brace
id|arcpacket-&gt;hardheader.offset1
op_assign
l_int|0
suffix:semicolon
id|arcpacket-&gt;hardheader.offset2
op_assign
id|offset
op_assign
l_int|512
op_minus
id|length
op_minus
l_int|4
suffix:semicolon
id|arcsoft
op_assign
(paren
r_struct
id|ClientData
op_star
)paren
(paren
op_amp
id|arcpacket-&gt;raw
(braket
id|offset
op_plus
l_int|4
)braket
)paren
suffix:semicolon
multiline_comment|/* exception-specific stuff - these four bytes&n;&t;&t; * make the packet long enough to fit in a 512-byte&n;&t;&t; * frame.&n;&t;&t; */
id|arcpacket-&gt;raw
(braket
id|offset
op_plus
l_int|0
)braket
op_assign
id|hdr
(braket
l_int|0
)braket
suffix:semicolon
id|arcpacket-&gt;raw
(braket
id|offset
op_plus
l_int|1
)braket
op_assign
l_int|0xFF
suffix:semicolon
multiline_comment|/* FF flag */
id|arcpacket-&gt;raw
(braket
id|offset
op_plus
l_int|2
)braket
op_assign
l_int|0xFF
suffix:semicolon
multiline_comment|/* FF padding */
id|arcpacket-&gt;raw
(braket
id|offset
op_plus
l_int|3
)braket
op_assign
l_int|0xFF
suffix:semicolon
multiline_comment|/* FF padding */
)brace
r_else
multiline_comment|/* &quot;other&quot; Exception packet */
(brace
multiline_comment|/* RFC1051 - set 4 trailing bytes to 0 */
id|memset
c_func
(paren
op_amp
id|arcpacket-&gt;raw
(braket
l_int|508
)braket
comma
l_int|0
comma
l_int|4
)paren
suffix:semicolon
multiline_comment|/* now round up to MinTU */
id|arcpacket-&gt;hardheader.offset1
op_assign
l_int|0
suffix:semicolon
id|arcpacket-&gt;hardheader.offset2
op_assign
id|offset
op_assign
l_int|512
op_minus
id|MinTU
suffix:semicolon
id|arcsoft
op_assign
(paren
r_struct
id|ClientData
op_star
)paren
(paren
op_amp
id|arcpacket-&gt;raw
(braket
id|offset
)braket
)paren
suffix:semicolon
)brace
multiline_comment|/* copy the packet into ARCnet shmem&n;&t; *  - the first bytes of ClientData header are skipped&n;&t; */
id|memcpy
c_func
(paren
(paren
id|u_char
op_star
)paren
id|arcsoft
comma
(paren
id|u_char
op_star
)paren
id|hdr
comma
id|hdrlen
)paren
suffix:semicolon
id|memcpy
c_func
(paren
(paren
id|u_char
op_star
)paren
id|arcsoft
op_plus
id|hdrlen
comma
id|data
comma
id|length
op_minus
id|hdrlen
)paren
suffix:semicolon
id|BUGMSG
c_func
(paren
id|D_DURING
comma
l_string|&quot;transmitting packet to station %02Xh (%d bytes)&bslash;n&quot;
comma
id|daddr
comma
id|length
)paren
suffix:semicolon
id|BUGLVL
c_func
(paren
id|D_TX
)paren
(brace
r_int
id|countx
comma
id|county
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;%6s: packet dump [tx] follows:&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_for
c_loop
(paren
id|county
op_assign
l_int|0
suffix:semicolon
id|county
OL
l_int|16
op_plus
(paren
id|length
OG
id|MTU
)paren
op_star
l_int|16
suffix:semicolon
id|county
op_increment
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;&bslash;n[%04X] &quot;
comma
id|county
op_star
l_int|16
)paren
suffix:semicolon
r_for
c_loop
(paren
id|countx
op_assign
l_int|0
suffix:semicolon
id|countx
OL
l_int|16
suffix:semicolon
id|countx
op_increment
)paren
id|printk
c_func
(paren
l_string|&quot;%02X &quot;
comma
id|arcpacket-&gt;raw
(braket
id|county
op_star
l_int|16
op_plus
id|countx
)braket
)paren
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
)brace
macro_line|#ifdef VERIFY_ACK
id|lp-&gt;lastload_dest
op_assign
id|daddr
suffix:semicolon
macro_line|#endif
id|lp-&gt;txready
op_assign
id|lp-&gt;txbuf
suffix:semicolon
multiline_comment|/* packet is ready for sending */
)brace
multiline_comment|/* Actually start transmitting a packet that was placed in the card&squot;s&n; * buffer by arcnetAS_prepare_tx.  Returns 1 if a Tx is really started.&n; *&n; * This should probably always be called with the INTMASK register set to 0,&n; * so go_tx is not called recursively.&n; *&n; * The enable_irq flag determines whether to actually write INTMASK value&n; * to the card; TXFREEflag is always OR&squot;ed into the memory variable either&n; * way.&n; */
r_static
r_int
DECL|function|arcnet_go_tx
id|arcnet_go_tx
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
r_int
id|enable_irq
)paren
(brace
r_struct
id|arcnet_local
op_star
id|lp
op_assign
(paren
r_struct
id|arcnet_local
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_int
id|ioaddr
op_assign
id|dev-&gt;base_addr
suffix:semicolon
id|BUGMSG
c_func
(paren
id|D_DURING
comma
l_string|&quot;go_tx: status=%Xh, intmask=%Xh, txready=%d, sending=%d&bslash;n&quot;
comma
id|inb
c_func
(paren
id|STATUS
)paren
comma
id|lp-&gt;intmask
comma
id|lp-&gt;txready
comma
id|lp-&gt;sending
)paren
suffix:semicolon
r_if
c_cond
(paren
id|lp-&gt;sending
op_logical_or
op_logical_neg
id|lp-&gt;txready
)paren
(brace
r_if
c_cond
(paren
id|enable_irq
op_logical_and
id|lp-&gt;sending
)paren
(brace
id|lp-&gt;intmask
op_or_assign
id|TXFREEflag
suffix:semicolon
id|SETMASK
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* start sending */
id|outb
c_func
(paren
id|TXcmd
op_or
(paren
id|lp-&gt;txready
op_lshift
l_int|3
)paren
comma
id|COMMAND
)paren
suffix:semicolon
id|lp-&gt;stats.tx_packets
op_increment
suffix:semicolon
id|lp-&gt;txready
op_assign
l_int|0
suffix:semicolon
id|lp-&gt;sending
op_increment
suffix:semicolon
macro_line|#ifdef VERIFY_ACK&t;
id|lp-&gt;lasttrans_dest
op_assign
id|lp-&gt;lastload_dest
suffix:semicolon
id|lp-&gt;lastload_dest
op_assign
l_int|0
suffix:semicolon
macro_line|#endif
id|lp-&gt;intmask
op_or_assign
id|TXFREEflag
suffix:semicolon
r_if
c_cond
(paren
id|enable_irq
)paren
id|SETMASK
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
multiline_comment|/****************************************************************************&n; *                                                                          *&n; * Interrupt handler                                                        *&n; *                                                                          *&n; ****************************************************************************/
multiline_comment|/* The typical workload of the driver:  Handle the network interface&n; * interrupts.  This doesn&squot;t do much right now except call arcnet_inthandler,&n; * which takes different parameters but may be called from other places&n; * as well.&n; */
r_static
r_void
DECL|function|arcnet_interrupt
id|arcnet_interrupt
c_func
(paren
r_int
id|irq
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_struct
id|device
op_star
id|dev
op_assign
(paren
r_struct
id|device
op_star
)paren
(paren
id|irq2dev_map
(braket
id|irq
)braket
)paren
suffix:semicolon
id|BUGMSG
c_func
(paren
id|D_DURING
comma
l_string|&quot;in arcnet_interrupt&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dev
op_eq
l_int|NULL
)paren
(brace
id|BUGLVL
c_func
(paren
id|D_EXTRA
)paren
id|printk
c_func
(paren
l_string|&quot;arcnet: irq %d for unknown device.&bslash;n&quot;
comma
id|irq
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|dev-&gt;start
)paren
r_return
suffix:semicolon
id|arcnet_inthandler
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
multiline_comment|/* The actual interrupt handler routine - handle various IRQ&squot;s generated&n; * by the card.&n; */
r_static
r_void
DECL|function|arcnet_inthandler
id|arcnet_inthandler
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
r_struct
id|arcnet_local
op_star
id|lp
op_assign
(paren
r_struct
id|arcnet_local
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_int
id|ioaddr
op_assign
id|dev-&gt;base_addr
comma
id|status
comma
id|boguscount
op_assign
l_int|3
comma
id|didsomething
suffix:semicolon
r_if
c_cond
(paren
id|IF_INTERRUPT
)paren
(brace
id|BUGMSG
c_func
(paren
id|D_NORMAL
comma
l_string|&quot;DRIVER PROBLEM!  Nested arcnet interrupts!&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
multiline_comment|/* don&squot;t even try. */
)brace
id|outb
c_func
(paren
l_int|0
comma
id|INTMASK
)paren
suffix:semicolon
id|INTERRUPT
op_assign
l_int|1
suffix:semicolon
id|BUGMSG
c_func
(paren
id|D_DURING
comma
l_string|&quot;in arcnet_inthandler (status=%Xh, intmask=%Xh)&bslash;n&quot;
comma
id|inb
c_func
(paren
id|STATUS
)paren
comma
id|lp-&gt;intmask
)paren
suffix:semicolon
r_do
(brace
id|status
op_assign
id|inb
c_func
(paren
id|STATUS
)paren
suffix:semicolon
id|didsomething
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* RESET flag was enabled - card is resetting and if RX&n;&t;&t; * is disabled, it&squot;s NOT because we just got a packet.&n;&t;&t; */
r_if
c_cond
(paren
id|status
op_amp
id|RESETflag
)paren
(brace
id|outb
c_func
(paren
id|CFLAGScmd
op_or
id|RESETclear
comma
id|COMMAND
)paren
suffix:semicolon
id|BUGMSG
c_func
(paren
id|D_INIT
comma
l_string|&quot;reset irq (status=%Xh)&bslash;n&quot;
comma
id|status
)paren
suffix:semicolon
)brace
macro_line|#ifdef DETECT_RECONFIGS
r_if
c_cond
(paren
id|status
op_amp
(paren
id|lp-&gt;intmask
)paren
op_amp
id|RECONflag
)paren
(brace
id|outb
c_func
(paren
id|CFLAGScmd
op_or
id|CONFIGclear
comma
id|COMMAND
)paren
suffix:semicolon
id|lp-&gt;stats.tx_carrier_errors
op_increment
suffix:semicolon
macro_line|#ifdef SHOW_RECONFIGS
id|BUGMSG
c_func
(paren
id|D_NORMAL
comma
l_string|&quot;Network reconfiguration detected (status=%Xh)&bslash;n&quot;
comma
id|status
)paren
suffix:semicolon
macro_line|#endif /* SHOW_RECONFIGS */
macro_line|#ifdef RECON_THRESHOLD
multiline_comment|/* is the RECON info empty or old? */
r_if
c_cond
(paren
op_logical_neg
id|lp-&gt;first_recon
op_logical_or
op_logical_neg
id|lp-&gt;last_recon
op_logical_or
id|jiffies
op_minus
id|lp-&gt;last_recon
OG
id|HZ
op_star
l_int|10
)paren
(brace
r_if
c_cond
(paren
id|lp-&gt;network_down
)paren
id|BUGMSG
c_func
(paren
id|D_NORMAL
comma
l_string|&quot;reconfiguration detected: cabling restored?&bslash;n&quot;
)paren
suffix:semicolon
id|lp-&gt;first_recon
op_assign
id|lp-&gt;last_recon
op_assign
id|jiffies
suffix:semicolon
id|lp-&gt;num_recons
op_assign
id|lp-&gt;network_down
op_assign
l_int|0
suffix:semicolon
id|BUGMSG
c_func
(paren
id|D_DURING
comma
l_string|&quot;recon: clearing counters.&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_else
multiline_comment|/* add to current RECON counter */
(brace
id|lp-&gt;last_recon
op_assign
id|jiffies
suffix:semicolon
id|lp-&gt;num_recons
op_increment
suffix:semicolon
id|BUGMSG
c_func
(paren
id|D_DURING
comma
l_string|&quot;recon: counter=%d, time=%lds, net=%d&bslash;n&quot;
comma
id|lp-&gt;num_recons
comma
(paren
id|lp-&gt;last_recon
op_minus
id|lp-&gt;first_recon
)paren
op_div
id|HZ
comma
id|lp-&gt;network_down
)paren
suffix:semicolon
multiline_comment|/* if network is marked up;&n;&t;&t;&t;&t; * and first_recon and last_recon are 60+ sec&n;&t;&t;&t;&t; *   apart;&n;&t;&t;&t;&t; * and the average no. of recons counted is&n;&t;&t;&t;&t; *   &gt; RECON_THRESHOLD/min;&n;&t;&t;&t;&t; * then print a warning message.&n;&t;&t;&t;&t; */
r_if
c_cond
(paren
op_logical_neg
id|lp-&gt;network_down
op_logical_and
(paren
id|lp-&gt;last_recon
op_minus
id|lp-&gt;first_recon
)paren
op_le
id|HZ
op_star
l_int|60
op_logical_and
id|lp-&gt;num_recons
op_ge
id|RECON_THRESHOLD
)paren
(brace
id|lp-&gt;network_down
op_assign
l_int|1
suffix:semicolon
id|BUGMSG
c_func
(paren
id|D_NORMAL
comma
l_string|&quot;many reconfigurations detected: cabling problem?&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
op_logical_neg
id|lp-&gt;network_down
op_logical_and
id|lp-&gt;last_recon
op_minus
id|lp-&gt;first_recon
OG
id|HZ
op_star
l_int|60
)paren
(brace
multiline_comment|/* reset counters if we&squot;ve gone for&n;&t;&t;&t;&t;&t; * over a minute.&n;&t;&t;&t;&t;&t; */
id|lp-&gt;first_recon
op_assign
id|lp-&gt;last_recon
suffix:semicolon
id|lp-&gt;num_recons
op_assign
l_int|1
suffix:semicolon
)brace
)brace
macro_line|#endif
)brace
macro_line|#ifdef RECON_THRESHOLD
r_else
r_if
c_cond
(paren
id|lp-&gt;network_down
op_logical_and
id|jiffies
op_minus
id|lp-&gt;last_recon
OG
id|HZ
op_star
l_int|10
)paren
(brace
r_if
c_cond
(paren
id|lp-&gt;network_down
)paren
id|BUGMSG
c_func
(paren
id|D_NORMAL
comma
l_string|&quot;cabling restored?&bslash;n&quot;
)paren
suffix:semicolon
id|lp-&gt;first_recon
op_assign
id|lp-&gt;last_recon
op_assign
l_int|0
suffix:semicolon
id|lp-&gt;num_recons
op_assign
id|lp-&gt;network_down
op_assign
l_int|0
suffix:semicolon
id|BUGMSG
c_func
(paren
id|D_DURING
comma
l_string|&quot;not recon: clearing counters anyway.&bslash;n&quot;
)paren
suffix:semicolon
)brace
macro_line|#endif
macro_line|#endif /* DETECT_RECONFIGS */
multiline_comment|/* RX is inhibited - we must have received something. */
r_if
c_cond
(paren
id|status
op_amp
id|lp-&gt;intmask
op_amp
id|NORXflag
)paren
(brace
r_int
id|recbuf
op_assign
id|lp-&gt;recbuf
op_assign
op_logical_neg
id|lp-&gt;recbuf
suffix:semicolon
id|BUGMSG
c_func
(paren
id|D_DURING
comma
l_string|&quot;receive irq (status=%Xh)&bslash;n&quot;
comma
id|status
)paren
suffix:semicolon
multiline_comment|/* enable receive of our next packet */
id|EnableReceiver
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* Got a packet. */
id|arcnet_rx
c_func
(paren
id|dev
comma
op_logical_neg
id|recbuf
)paren
suffix:semicolon
id|didsomething
op_increment
suffix:semicolon
)brace
multiline_comment|/* it can only be an xmit-done irq if we&squot;re xmitting :) */
multiline_comment|/*if (status&amp;TXFREEflag &amp;&amp; !lp-&gt;in_txhandler &amp;&amp; lp-&gt;sending)*/
r_if
c_cond
(paren
id|status
op_amp
id|lp-&gt;intmask
op_amp
id|TXFREEflag
)paren
(brace
r_struct
id|Outgoing
op_star
id|out
op_assign
op_amp
(paren
id|lp-&gt;outgoing
)paren
suffix:semicolon
r_int
id|was_sending
op_assign
id|lp-&gt;sending
suffix:semicolon
id|lp-&gt;intmask
op_and_assign
op_complement
id|TXFREEflag
suffix:semicolon
id|lp-&gt;in_txhandler
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|was_sending
)paren
id|lp-&gt;sending
op_decrement
suffix:semicolon
id|BUGMSG
c_func
(paren
id|D_DURING
comma
l_string|&quot;TX IRQ (stat=%Xh, numsegs=%d, segnum=%d, skb=%ph)&bslash;n&quot;
comma
id|status
comma
id|out-&gt;numsegs
comma
id|out-&gt;segnum
comma
id|out-&gt;skb
)paren
suffix:semicolon
macro_line|#ifdef VERIFY_ACK
r_if
c_cond
(paren
id|was_sending
op_logical_and
op_logical_neg
(paren
id|status
op_amp
id|TXACKflag
)paren
)paren
(brace
r_if
c_cond
(paren
id|lp-&gt;lasttrans_dest
op_ne
l_int|0
)paren
(brace
id|BUGMSG
c_func
(paren
id|D_NORMAL
comma
l_string|&quot;transmit was not acknowledged! (status=%Xh, dest=%d)&bslash;n&quot;
comma
id|status
comma
id|lp-&gt;lasttrans_dest
)paren
suffix:semicolon
id|lp-&gt;stats.tx_errors
op_increment
suffix:semicolon
id|lp-&gt;stats.tx_carrier_errors
op_increment
suffix:semicolon
)brace
r_else
(brace
id|BUGMSG
c_func
(paren
id|D_DURING
comma
l_string|&quot;broadcast was not acknowledged; that&squot;s normal (status=%Xh, dest=%d)&bslash;n&quot;
comma
id|status
comma
id|lp-&gt;lasttrans_dest
)paren
suffix:semicolon
)brace
)brace
macro_line|#endif
multiline_comment|/* send packet if there is one */
id|arcnet_go_tx
c_func
(paren
id|dev
comma
l_int|0
)paren
suffix:semicolon
id|didsomething
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|lp-&gt;intx
)paren
(brace
id|BUGMSG
c_func
(paren
id|D_DURING
comma
l_string|&quot;TXDONE while intx! (status=%Xh, intx=%d)&bslash;n&quot;
comma
id|inb
c_func
(paren
id|STATUS
)paren
comma
id|lp-&gt;intx
)paren
suffix:semicolon
id|lp-&gt;in_txhandler
op_decrement
suffix:semicolon
r_continue
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|lp-&gt;outgoing.skb
)paren
(brace
id|BUGMSG
c_func
(paren
id|D_DURING
comma
l_string|&quot;TX IRQ done: no split to continue.&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* inform upper layers */
r_if
c_cond
(paren
op_logical_neg
id|lp-&gt;txready
op_logical_and
id|IF_TBUSY
)paren
(brace
id|TBUSY
op_assign
l_int|0
suffix:semicolon
id|mark_bh
c_func
(paren
id|NET_BH
)paren
suffix:semicolon
)brace
id|lp-&gt;in_txhandler
op_decrement
suffix:semicolon
r_continue
suffix:semicolon
)brace
multiline_comment|/* if more than one segment, and not all segments&n;&t;&t;&t; * are done, then continue xmit.&n;&t;&t;&t; */
r_if
c_cond
(paren
id|out-&gt;segnum
OL
id|out-&gt;numsegs
)paren
id|arcnetA_continue_tx
c_func
(paren
id|dev
)paren
suffix:semicolon
id|arcnet_go_tx
c_func
(paren
id|dev
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* if segnum==numsegs, the transmission is finished;&n;&t;&t;&t; * free the skb.&n;&t;&t;&t; */
r_if
c_cond
(paren
id|out-&gt;segnum
op_ge
id|out-&gt;numsegs
)paren
(brace
multiline_comment|/* transmit completed */
id|out-&gt;segnum
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|out-&gt;skb
)paren
id|dev_kfree_skb
c_func
(paren
id|out-&gt;skb
comma
id|FREE_WRITE
)paren
suffix:semicolon
id|out-&gt;skb
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/* inform upper layers */
r_if
c_cond
(paren
op_logical_neg
id|lp-&gt;txready
op_logical_and
id|IF_TBUSY
)paren
(brace
id|TBUSY
op_assign
l_int|0
suffix:semicolon
id|mark_bh
c_func
(paren
id|NET_BH
)paren
suffix:semicolon
)brace
)brace
id|didsomething
op_increment
suffix:semicolon
id|lp-&gt;in_txhandler
op_decrement
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|lp-&gt;txready
op_logical_and
op_logical_neg
id|lp-&gt;sending
op_logical_and
op_logical_neg
id|lp-&gt;intx
)paren
(brace
id|BUGMSG
c_func
(paren
id|D_NORMAL
comma
l_string|&quot;recovery from silent TX (status=%Xh)&bslash;n&quot;
comma
id|status
)paren
suffix:semicolon
id|arcnet_go_tx
c_func
(paren
id|dev
comma
l_int|0
)paren
suffix:semicolon
id|didsomething
op_increment
suffix:semicolon
)brace
)brace
r_while
c_loop
(paren
op_decrement
id|boguscount
op_logical_and
id|didsomething
)paren
suffix:semicolon
id|BUGMSG
c_func
(paren
id|D_DURING
comma
l_string|&quot;net_interrupt complete (status=%Xh, count=%d)&bslash;n&bslash;n&quot;
comma
id|inb
c_func
(paren
id|STATUS
)paren
comma
id|boguscount
)paren
suffix:semicolon
id|SETMASK
suffix:semicolon
multiline_comment|/* put back interrupt mask */
id|INTERRUPT
op_assign
l_int|0
suffix:semicolon
)brace
multiline_comment|/****************************************************************************&n; *                                                                          *&n; * Receiver routines                                                        *&n; *                                                                          *&n; ****************************************************************************/
multiline_comment|/* A packet has arrived; grab it from the buffers and possibly unsplit it.&n; * This is a generic packet receiver that calls arcnet??_rx depending on the&n; * protocol ID found.&n; */
r_static
r_void
DECL|function|arcnet_rx
id|arcnet_rx
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
r_int
id|recbuf
)paren
(brace
r_struct
id|arcnet_local
op_star
id|lp
op_assign
(paren
r_struct
id|arcnet_local
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_int
id|ioaddr
op_assign
id|dev-&gt;base_addr
suffix:semicolon
r_union
id|ArcPacket
op_star
id|arcpacket
op_assign
(paren
r_union
id|ArcPacket
op_star
)paren
(paren
id|dev-&gt;mem_start
op_plus
id|recbuf
op_star
l_int|512
)paren
suffix:semicolon
id|u_char
op_star
id|arcsoft
suffix:semicolon
r_int
id|length
comma
id|offset
suffix:semicolon
id|u_char
id|daddr
comma
id|saddr
suffix:semicolon
id|lp-&gt;stats.rx_packets
op_increment
suffix:semicolon
id|saddr
op_assign
id|arcpacket-&gt;hardheader.source
suffix:semicolon
id|daddr
op_assign
id|arcpacket-&gt;hardheader.destination
suffix:semicolon
multiline_comment|/* if source is 0, it&squot;s a &quot;used&quot; packet! */
r_if
c_cond
(paren
id|saddr
op_eq
l_int|0
)paren
(brace
id|BUGMSG
c_func
(paren
id|D_NORMAL
comma
l_string|&quot;discarding old packet. (status=%Xh)&bslash;n&quot;
comma
id|inb
c_func
(paren
id|STATUS
)paren
)paren
suffix:semicolon
id|lp-&gt;stats.rx_errors
op_increment
suffix:semicolon
r_return
suffix:semicolon
)brace
id|arcpacket-&gt;hardheader.source
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|arcpacket-&gt;hardheader.offset1
)paren
multiline_comment|/* Normal Packet */
(brace
id|offset
op_assign
id|arcpacket-&gt;hardheader.offset1
suffix:semicolon
id|arcsoft
op_assign
op_amp
id|arcpacket-&gt;raw
(braket
id|offset
)braket
suffix:semicolon
id|length
op_assign
l_int|256
op_minus
id|offset
suffix:semicolon
)brace
r_else
multiline_comment|/* ExtendedPacket or ExceptionPacket */
(brace
id|offset
op_assign
id|arcpacket-&gt;hardheader.offset2
suffix:semicolon
id|arcsoft
op_assign
op_amp
id|arcpacket-&gt;raw
(braket
id|offset
)braket
suffix:semicolon
id|length
op_assign
l_int|512
op_minus
id|offset
suffix:semicolon
)brace
id|BUGMSG
c_func
(paren
id|D_DURING
comma
l_string|&quot;received packet from %02Xh to %02Xh (%d bytes)&bslash;n&quot;
comma
id|saddr
comma
id|daddr
comma
id|length
)paren
suffix:semicolon
multiline_comment|/* call the right receiver for the protocol */
r_switch
c_cond
(paren
id|arcsoft
(braket
l_int|0
)braket
)paren
(brace
r_case
id|ARC_P_IP
suffix:colon
r_case
id|ARC_P_ARP
suffix:colon
r_case
id|ARC_P_RARP
suffix:colon
r_case
id|ARC_P_IPX
suffix:colon
r_case
id|ARC_P_NOVELL_EC
suffix:colon
id|arcnetA_rx
c_func
(paren
id|lp-&gt;adev
comma
id|arcsoft
comma
id|length
comma
id|saddr
comma
id|daddr
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ARC_P_ETHER
suffix:colon
id|arcnetE_rx
c_func
(paren
id|lp-&gt;edev
comma
id|arcsoft
comma
id|length
comma
id|saddr
comma
id|daddr
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ARC_P_IP_RFC1051
suffix:colon
r_case
id|ARC_P_ARP_RFC1051
suffix:colon
id|arcnetS_rx
c_func
(paren
id|lp-&gt;sdev
comma
id|arcsoft
comma
id|length
comma
id|saddr
comma
id|daddr
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ARC_P_LANSOFT
suffix:colon
multiline_comment|/* don&squot;t understand.  fall through. */
r_default
suffix:colon
id|BUGMSG
c_func
(paren
id|D_NORMAL
comma
l_string|&quot;received unknown protocol %d (%Xh) from station %d.&bslash;n&quot;
comma
id|arcsoft
(braket
l_int|0
)braket
comma
id|arcsoft
(braket
l_int|0
)braket
comma
id|saddr
)paren
suffix:semicolon
id|lp-&gt;stats.rx_errors
op_increment
suffix:semicolon
id|lp-&gt;stats.rx_crc_errors
op_increment
suffix:semicolon
r_break
suffix:semicolon
)brace
id|BUGLVL
c_func
(paren
id|D_RX
)paren
(brace
r_int
id|countx
comma
id|county
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;%6s: packet dump [rx] follows:&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_for
c_loop
(paren
id|county
op_assign
l_int|0
suffix:semicolon
id|county
OL
l_int|16
op_plus
(paren
id|length
OG
l_int|240
)paren
op_star
l_int|16
suffix:semicolon
id|county
op_increment
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;&bslash;n[%04X] &quot;
comma
id|county
op_star
l_int|16
)paren
suffix:semicolon
r_for
c_loop
(paren
id|countx
op_assign
l_int|0
suffix:semicolon
id|countx
OL
l_int|16
suffix:semicolon
id|countx
op_increment
)paren
id|printk
c_func
(paren
l_string|&quot;%02X &quot;
comma
id|arcpacket-&gt;raw
(braket
id|county
op_star
l_int|16
op_plus
id|countx
)braket
)paren
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/* clean out the page to make debugging make more sense :) */
id|BUGLVL
c_func
(paren
id|D_DURING
)paren
id|memset
c_func
(paren
(paren
r_void
op_star
)paren
id|arcpacket-&gt;raw
comma
l_int|0x42
comma
l_int|512
)paren
suffix:semicolon
multiline_comment|/* If any worth-while packets have been received, a mark_bh(NET_BH)&n;&t; * has been done by netif_rx and Linux will handle them after we&n;&t; * return.&n;&t; */
)brace
multiline_comment|/* Packet receiver for &quot;standard&quot; RFC1201-style packets&n; */
r_static
r_void
DECL|function|arcnetA_rx
id|arcnetA_rx
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
id|u_char
op_star
id|buf
comma
r_int
id|length
comma
id|u_char
id|saddr
comma
id|u_char
id|daddr
)paren
(brace
r_struct
id|arcnet_local
op_star
id|lp
op_assign
(paren
r_struct
id|arcnet_local
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
r_struct
id|ClientData
op_star
id|arcsoft
comma
op_star
id|soft
suffix:semicolon
id|BUGMSG
c_func
(paren
id|D_DURING
comma
l_string|&quot;it&squot;s an RFC1201 packet (length=%d)&bslash;n&quot;
comma
id|length
)paren
suffix:semicolon
multiline_comment|/* compensate for EXTRA_CLIENTDATA (which isn&squot;t actually in the&n;&t; * packet)&n;&t; */
id|arcsoft
op_assign
(paren
r_struct
id|ClientData
op_star
)paren
(paren
id|buf
op_minus
id|EXTRA_CLIENTDATA
)paren
suffix:semicolon
id|length
op_add_assign
id|EXTRA_CLIENTDATA
suffix:semicolon
r_if
c_cond
(paren
id|arcsoft-&gt;split_flag
op_eq
l_int|0xFF
)paren
multiline_comment|/* Exception Packet */
(brace
id|BUGMSG
c_func
(paren
id|D_DURING
comma
l_string|&quot;compensating for exception packet&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* skip over 4-byte junkola */
id|arcsoft
op_assign
(paren
r_struct
id|ClientData
op_star
)paren
(paren
(paren
id|u_char
op_star
)paren
id|arcsoft
op_plus
l_int|4
)paren
suffix:semicolon
id|length
op_sub_assign
l_int|4
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|arcsoft-&gt;split_flag
)paren
multiline_comment|/* not split */
(brace
r_struct
id|Incoming
op_star
id|in
op_assign
op_amp
id|lp-&gt;incoming
(braket
id|saddr
)braket
suffix:semicolon
id|BUGMSG
c_func
(paren
id|D_RX
comma
l_string|&quot;incoming is not split (splitflag=%d)&bslash;n&quot;
comma
id|arcsoft-&gt;split_flag
)paren
suffix:semicolon
r_if
c_cond
(paren
id|in-&gt;skb
)paren
multiline_comment|/* already assembling one! */
(brace
id|BUGMSG
c_func
(paren
id|D_NORMAL
comma
l_string|&quot;aborting assembly (seq=%d) for unsplit packet (splitflag=%d, seq=%d)&bslash;n&quot;
comma
id|in-&gt;sequence
comma
id|arcsoft-&gt;split_flag
comma
id|arcsoft-&gt;sequence
)paren
suffix:semicolon
id|kfree_skb
c_func
(paren
id|in-&gt;skb
comma
id|FREE_WRITE
)paren
suffix:semicolon
id|lp-&gt;stats.rx_errors
op_increment
suffix:semicolon
id|lp-&gt;stats.rx_missed_errors
op_increment
suffix:semicolon
id|in-&gt;skb
op_assign
l_int|NULL
suffix:semicolon
)brace
id|in-&gt;sequence
op_assign
id|arcsoft-&gt;sequence
suffix:semicolon
id|skb
op_assign
id|alloc_skb
c_func
(paren
id|length
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
id|skb
op_eq
l_int|NULL
)paren
(brace
id|BUGMSG
c_func
(paren
id|D_NORMAL
comma
l_string|&quot;Memory squeeze, dropping packet.&bslash;n&quot;
)paren
suffix:semicolon
id|lp-&gt;stats.rx_dropped
op_increment
suffix:semicolon
r_return
suffix:semicolon
)brace
id|soft
op_assign
(paren
r_struct
id|ClientData
op_star
)paren
id|skb-&gt;data
suffix:semicolon
id|skb-&gt;len
op_assign
id|length
suffix:semicolon
id|skb-&gt;dev
op_assign
id|dev
suffix:semicolon
id|memcpy
c_func
(paren
(paren
id|u_char
op_star
)paren
id|soft
op_plus
id|EXTRA_CLIENTDATA
comma
(paren
id|u_char
op_star
)paren
id|arcsoft
op_plus
id|EXTRA_CLIENTDATA
comma
id|length
op_minus
id|EXTRA_CLIENTDATA
)paren
suffix:semicolon
id|soft-&gt;daddr
op_assign
id|daddr
suffix:semicolon
id|soft-&gt;saddr
op_assign
id|saddr
suffix:semicolon
multiline_comment|/* ARP packets have problems when sent from DOS.&n;         &t; * source address is always 0 on some systems!  So we take&n;         &t; * the hardware source addr (which is impossible to fumble)&n;         &t; * and insert it ourselves.&n;         &t; */
r_if
c_cond
(paren
id|soft-&gt;protocol_id
op_eq
id|ARC_P_ARP
)paren
(brace
r_struct
id|arphdr
op_star
id|arp
op_assign
(paren
r_struct
id|arphdr
op_star
)paren
(paren
(paren
r_char
op_star
)paren
id|soft
op_plus
r_sizeof
(paren
r_struct
id|ClientData
)paren
)paren
suffix:semicolon
multiline_comment|/* make sure addresses are the right length */
r_if
c_cond
(paren
id|arp-&gt;ar_hln
op_eq
l_int|1
op_logical_and
id|arp-&gt;ar_pln
op_eq
l_int|4
)paren
(brace
r_char
op_star
id|cptr
op_assign
(paren
r_char
op_star
)paren
(paren
id|arp
)paren
op_plus
r_sizeof
(paren
r_struct
id|arphdr
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
op_star
id|cptr
)paren
multiline_comment|/* is saddr = 00? */
(brace
id|BUGMSG
c_func
(paren
id|D_EXTRA
comma
l_string|&quot;ARP source address was 00h, set to %02Xh.&bslash;n&quot;
comma
id|saddr
)paren
suffix:semicolon
id|lp-&gt;stats.rx_crc_errors
op_increment
suffix:semicolon
op_star
id|cptr
op_assign
id|saddr
suffix:semicolon
)brace
r_else
(brace
id|BUGMSG
c_func
(paren
id|D_DURING
comma
l_string|&quot;ARP source address (%Xh) is fine.&bslash;n&quot;
comma
op_star
id|cptr
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
id|BUGMSG
c_func
(paren
id|D_NORMAL
comma
l_string|&quot;funny-shaped ARP packet. (%Xh, %Xh)&bslash;n&quot;
comma
id|arp-&gt;ar_hln
comma
id|arp-&gt;ar_pln
)paren
suffix:semicolon
id|lp-&gt;stats.rx_errors
op_increment
suffix:semicolon
id|lp-&gt;stats.rx_crc_errors
op_increment
suffix:semicolon
)brace
)brace
id|BUGLVL
c_func
(paren
id|D_SKB
)paren
(brace
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|skb-&gt;len
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|i
op_mod
l_int|16
op_eq
l_int|0
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;&bslash;n[%04hX] &quot;
comma
id|i
)paren
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;%02hX &quot;
comma
(paren
(paren
r_int
r_char
op_star
)paren
id|skb-&gt;data
)paren
(braket
id|i
)braket
)paren
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
)brace
id|skb-&gt;protocol
op_assign
id|arcnetA_type_trans
c_func
(paren
id|skb
comma
id|dev
)paren
suffix:semicolon
id|netif_rx
c_func
(paren
id|skb
)paren
suffix:semicolon
)brace
r_else
multiline_comment|/* split packet */
(brace
multiline_comment|/* NOTE:  MSDOS ARP packet correction should only need to&n;&t;          * apply to unsplit packets, since ARP packets are so short.&n;&t;          *&n;&t;          * My interpretation of the RFC1201 (ARCnet) document is that&n;&t;          * if a packet is received out of order, the entire assembly&n;&t;          * process should be aborted.&n;&t;          *&n;&t;          * The RFC also mentions &quot;it is possible for successfully&n;&t;          * received packets to be retransmitted.&quot;  As of 0.40 all&n;&t;          * previously received packets are allowed, not just the&n;&t;          * most recent one.&n;&t;          *&n;&t;          * We allow multiple assembly processes, one for each&n;&t;          * ARCnet card possible on the network.  Seems rather like&n;&t;          * a waste of memory.  Necessary?&n;&t;          */
r_struct
id|Incoming
op_star
id|in
op_assign
op_amp
id|lp-&gt;incoming
(braket
id|saddr
)braket
suffix:semicolon
id|BUGMSG
c_func
(paren
id|D_RX
comma
l_string|&quot;packet is split (splitflag=%d, seq=%d)&bslash;n&quot;
comma
id|arcsoft-&gt;split_flag
comma
id|in-&gt;sequence
)paren
suffix:semicolon
r_if
c_cond
(paren
id|in-&gt;skb
op_logical_and
id|in-&gt;sequence
op_ne
id|arcsoft-&gt;sequence
)paren
(brace
id|BUGMSG
c_func
(paren
id|D_NORMAL
comma
l_string|&quot;wrong seq number, aborting assembly (saddr=%d, expected=%d, seq=%d, splitflag=%d)&bslash;n&quot;
comma
id|saddr
comma
id|in-&gt;sequence
comma
id|arcsoft-&gt;sequence
comma
id|arcsoft-&gt;split_flag
)paren
suffix:semicolon
id|kfree_skb
c_func
(paren
id|in-&gt;skb
comma
id|FREE_WRITE
)paren
suffix:semicolon
id|in-&gt;skb
op_assign
l_int|NULL
suffix:semicolon
id|lp-&gt;stats.rx_errors
op_increment
suffix:semicolon
id|lp-&gt;stats.rx_missed_errors
op_increment
suffix:semicolon
id|in-&gt;lastpacket
op_assign
id|in-&gt;numpackets
op_assign
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|arcsoft-&gt;split_flag
op_amp
l_int|1
)paren
multiline_comment|/* first packet in split */
(brace
id|BUGMSG
c_func
(paren
id|D_RX
comma
l_string|&quot;brand new splitpacket (splitflag=%d)&bslash;n&quot;
comma
id|arcsoft-&gt;split_flag
)paren
suffix:semicolon
r_if
c_cond
(paren
id|in-&gt;skb
)paren
multiline_comment|/* already assembling one! */
(brace
id|BUGMSG
c_func
(paren
id|D_NORMAL
comma
l_string|&quot;aborting previous (seq=%d) assembly (splitflag=%d, seq=%d)&bslash;n&quot;
comma
id|in-&gt;sequence
comma
id|arcsoft-&gt;split_flag
comma
id|arcsoft-&gt;sequence
)paren
suffix:semicolon
id|lp-&gt;stats.rx_errors
op_increment
suffix:semicolon
id|lp-&gt;stats.rx_missed_errors
op_increment
suffix:semicolon
id|kfree_skb
c_func
(paren
id|in-&gt;skb
comma
id|FREE_WRITE
)paren
suffix:semicolon
)brace
id|in-&gt;sequence
op_assign
id|arcsoft-&gt;sequence
suffix:semicolon
id|in-&gt;numpackets
op_assign
(paren
(paren
r_int
)paren
id|arcsoft-&gt;split_flag
op_rshift
l_int|1
)paren
op_plus
l_int|2
suffix:semicolon
id|in-&gt;lastpacket
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|in-&gt;numpackets
OG
l_int|16
)paren
(brace
id|BUGMSG
c_func
(paren
id|D_NORMAL
comma
l_string|&quot;incoming packet more than 16 segments; dropping. (splitflag=%d)&bslash;n&quot;
comma
id|arcsoft-&gt;split_flag
)paren
suffix:semicolon
id|lp-&gt;stats.rx_errors
op_increment
suffix:semicolon
id|lp-&gt;stats.rx_length_errors
op_increment
suffix:semicolon
r_return
suffix:semicolon
)brace
id|in-&gt;skb
op_assign
id|skb
op_assign
id|alloc_skb
c_func
(paren
l_int|508
op_star
id|in-&gt;numpackets
op_plus
r_sizeof
(paren
r_struct
id|ClientData
)paren
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
id|skb
op_eq
l_int|NULL
)paren
(brace
id|BUGMSG
c_func
(paren
id|D_NORMAL
comma
l_string|&quot;(split) memory squeeze, dropping packet.&bslash;n&quot;
)paren
suffix:semicolon
id|lp-&gt;stats.rx_dropped
op_increment
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/* I don&squot;t know what this is for, but it DOES avoid&n;&t;                 * warnings...&n;&t;                 */
id|skb-&gt;free
op_assign
l_int|1
suffix:semicolon
id|soft
op_assign
(paren
r_struct
id|ClientData
op_star
)paren
id|skb-&gt;data
suffix:semicolon
id|skb-&gt;len
op_assign
r_sizeof
(paren
r_struct
id|ClientData
)paren
suffix:semicolon
id|skb-&gt;dev
op_assign
id|dev
suffix:semicolon
id|memcpy
c_func
(paren
(paren
id|u_char
op_star
)paren
id|soft
op_plus
id|EXTRA_CLIENTDATA
comma
(paren
id|u_char
op_star
)paren
id|arcsoft
op_plus
id|EXTRA_CLIENTDATA
comma
r_sizeof
(paren
r_struct
id|ClientData
)paren
op_minus
id|EXTRA_CLIENTDATA
)paren
suffix:semicolon
id|soft-&gt;split_flag
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* final packet won&squot;t be split */
)brace
r_else
multiline_comment|/* not first packet */
(brace
r_int
id|packetnum
op_assign
(paren
(paren
r_int
)paren
id|arcsoft-&gt;split_flag
op_rshift
l_int|1
)paren
op_plus
l_int|1
suffix:semicolon
multiline_comment|/* if we&squot;re not assembling, there&squot;s no point&n;&t;&t;&t; * trying to continue.&n;&t;&t;&t; */
r_if
c_cond
(paren
op_logical_neg
id|in-&gt;skb
)paren
(brace
id|BUGMSG
c_func
(paren
id|D_NORMAL
comma
l_string|&quot;can&squot;t continue split without starting first! (splitflag=%d, seq=%d)&bslash;n&quot;
comma
id|arcsoft-&gt;split_flag
comma
id|arcsoft-&gt;sequence
)paren
suffix:semicolon
id|lp-&gt;stats.rx_errors
op_increment
suffix:semicolon
id|lp-&gt;stats.rx_missed_errors
op_increment
suffix:semicolon
r_return
suffix:semicolon
)brace
id|in-&gt;lastpacket
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|packetnum
op_ne
id|in-&gt;lastpacket
)paren
multiline_comment|/* not the right flag! */
(brace
multiline_comment|/* harmless duplicate? ignore. */
r_if
c_cond
(paren
id|packetnum
op_le
id|in-&gt;lastpacket
op_minus
l_int|1
)paren
(brace
id|BUGMSG
c_func
(paren
id|D_NORMAL
comma
l_string|&quot;duplicate splitpacket ignored! (splitflag=%d)&bslash;n&quot;
comma
id|arcsoft-&gt;split_flag
)paren
suffix:semicolon
id|lp-&gt;stats.rx_errors
op_increment
suffix:semicolon
id|lp-&gt;stats.rx_frame_errors
op_increment
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/* &quot;bad&quot; duplicate, kill reassembly */
id|BUGMSG
c_func
(paren
id|D_NORMAL
comma
l_string|&quot;out-of-order splitpacket, reassembly (seq=%d) aborted (splitflag=%d, seq=%d)&bslash;n&quot;
comma
id|in-&gt;sequence
comma
id|arcsoft-&gt;split_flag
comma
id|arcsoft-&gt;sequence
)paren
suffix:semicolon
id|kfree_skb
c_func
(paren
id|in-&gt;skb
comma
id|FREE_WRITE
)paren
suffix:semicolon
id|in-&gt;skb
op_assign
l_int|NULL
suffix:semicolon
id|lp-&gt;stats.rx_errors
op_increment
suffix:semicolon
id|lp-&gt;stats.rx_missed_errors
op_increment
suffix:semicolon
id|in-&gt;lastpacket
op_assign
id|in-&gt;numpackets
op_assign
l_int|0
suffix:semicolon
r_return
suffix:semicolon
)brace
id|soft
op_assign
(paren
r_struct
id|ClientData
op_star
)paren
id|in-&gt;skb-&gt;data
suffix:semicolon
)brace
id|skb
op_assign
id|in-&gt;skb
suffix:semicolon
id|memcpy
c_func
(paren
id|skb-&gt;data
op_plus
id|skb-&gt;len
comma
(paren
id|u_char
op_star
)paren
id|arcsoft
op_plus
r_sizeof
(paren
r_struct
id|ClientData
)paren
comma
id|length
op_minus
r_sizeof
(paren
r_struct
id|ClientData
)paren
)paren
suffix:semicolon
id|skb-&gt;len
op_add_assign
id|length
op_minus
r_sizeof
(paren
r_struct
id|ClientData
)paren
suffix:semicolon
id|soft-&gt;daddr
op_assign
id|daddr
suffix:semicolon
id|soft-&gt;saddr
op_assign
id|saddr
suffix:semicolon
multiline_comment|/* are we done? */
r_if
c_cond
(paren
id|in-&gt;lastpacket
op_eq
id|in-&gt;numpackets
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|skb
op_logical_or
op_logical_neg
id|in-&gt;skb
)paren
(brace
id|BUGMSG
c_func
(paren
id|D_NORMAL
comma
l_string|&quot;?!? done reassembling packet, no skb? (skb=%ph, in-&gt;skb=%ph)&bslash;n&quot;
comma
id|skb
comma
id|in-&gt;skb
)paren
suffix:semicolon
)brace
r_else
(brace
id|in-&gt;skb
op_assign
l_int|NULL
suffix:semicolon
id|in-&gt;lastpacket
op_assign
id|in-&gt;numpackets
op_assign
l_int|0
suffix:semicolon
id|BUGLVL
c_func
(paren
id|D_SKB
)paren
(brace
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|skb-&gt;len
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|i
op_mod
l_int|16
op_eq
l_int|0
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;&bslash;n[%04hX] &quot;
comma
id|i
)paren
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;%02hX &quot;
comma
(paren
(paren
r_int
r_char
op_star
)paren
id|skb-&gt;data
)paren
(braket
id|i
)braket
)paren
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
)brace
id|skb-&gt;protocol
op_assign
id|arcnetA_type_trans
c_func
(paren
id|skb
comma
id|dev
)paren
suffix:semicolon
id|netif_rx
c_func
(paren
id|skb
)paren
suffix:semicolon
)brace
)brace
)brace
)brace
multiline_comment|/* Packet receiver for non-standard ethernet-style packets&n; */
r_static
r_void
DECL|function|arcnetE_rx
id|arcnetE_rx
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
id|u_char
op_star
id|arcsoft
comma
r_int
id|length
comma
id|u_char
id|saddr
comma
id|u_char
id|daddr
)paren
(brace
r_struct
id|arcnet_local
op_star
id|lp
op_assign
(paren
r_struct
id|arcnet_local
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
id|BUGMSG
c_func
(paren
id|D_DURING
comma
l_string|&quot;it&squot;s an ethernet-encap packet (length=%d)&bslash;n&quot;
comma
id|length
)paren
suffix:semicolon
id|skb
op_assign
id|alloc_skb
c_func
(paren
id|length
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
id|skb
op_eq
l_int|NULL
)paren
(brace
id|BUGMSG
c_func
(paren
id|D_NORMAL
comma
l_string|&quot;Memory squeeze, dropping packet.&bslash;n&quot;
)paren
suffix:semicolon
id|lp-&gt;stats.rx_dropped
op_increment
suffix:semicolon
r_return
suffix:semicolon
)brace
id|skb-&gt;len
op_assign
id|length
suffix:semicolon
id|skb-&gt;dev
op_assign
id|dev
suffix:semicolon
id|memcpy
c_func
(paren
id|skb-&gt;data
comma
(paren
id|u_char
op_star
)paren
id|arcsoft
op_plus
l_int|1
comma
id|length
op_minus
l_int|1
)paren
suffix:semicolon
id|BUGLVL
c_func
(paren
id|D_SKB
)paren
(brace
r_int
id|i
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;%6s: rx skb dump follows:&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|skb-&gt;len
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|i
op_mod
l_int|16
op_eq
l_int|0
)paren
id|printk
c_func
(paren
l_string|&quot;&bslash;n[%04hX] &quot;
comma
id|i
)paren
suffix:semicolon
r_else
id|printk
c_func
(paren
l_string|&quot;%02hX &quot;
comma
(paren
(paren
id|u_char
op_star
)paren
id|skb-&gt;data
)paren
(braket
id|i
)braket
)paren
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
)brace
id|skb-&gt;protocol
op_assign
id|eth_type_trans
c_func
(paren
id|skb
comma
id|dev
)paren
suffix:semicolon
id|netif_rx
c_func
(paren
id|skb
)paren
suffix:semicolon
)brace
multiline_comment|/* Packet receiver for RFC1051 packets; &n; */
r_static
r_void
DECL|function|arcnetS_rx
id|arcnetS_rx
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
id|u_char
op_star
id|buf
comma
r_int
id|length
comma
id|u_char
id|saddr
comma
id|u_char
id|daddr
)paren
(brace
r_struct
id|arcnet_local
op_star
id|lp
op_assign
(paren
r_struct
id|arcnet_local
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
r_struct
id|S_ClientData
op_star
id|arcsoft
comma
op_star
id|soft
suffix:semicolon
id|arcsoft
op_assign
(paren
r_struct
id|S_ClientData
op_star
)paren
(paren
id|buf
op_minus
id|S_EXTRA_CLIENTDATA
)paren
suffix:semicolon
id|length
op_add_assign
id|S_EXTRA_CLIENTDATA
suffix:semicolon
id|BUGMSG
c_func
(paren
id|D_DURING
comma
l_string|&quot;it&squot;s an RFC1051 packet (length=%d)&bslash;n&quot;
comma
id|length
)paren
suffix:semicolon
(brace
multiline_comment|/* was &quot;if not split&quot; in A protocol, S is never split */
id|skb
op_assign
id|alloc_skb
c_func
(paren
id|length
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
id|skb
op_eq
l_int|NULL
)paren
(brace
id|BUGMSG
c_func
(paren
id|D_NORMAL
comma
l_string|&quot;Memory squeeze, dropping packet.&bslash;n&quot;
)paren
suffix:semicolon
id|lp-&gt;stats.rx_dropped
op_increment
suffix:semicolon
r_return
suffix:semicolon
)brace
id|soft
op_assign
(paren
r_struct
id|S_ClientData
op_star
)paren
id|skb-&gt;data
suffix:semicolon
id|skb-&gt;len
op_assign
id|length
suffix:semicolon
id|memcpy
c_func
(paren
(paren
id|u_char
op_star
)paren
id|soft
op_plus
r_sizeof
(paren
r_struct
id|S_ClientData
)paren
op_minus
id|S_EXTRA_CLIENTDATA
comma
(paren
id|u_char
op_star
)paren
id|arcsoft
op_plus
r_sizeof
(paren
r_struct
id|S_ClientData
)paren
op_minus
id|S_EXTRA_CLIENTDATA
comma
id|length
op_minus
r_sizeof
(paren
r_struct
id|S_ClientData
)paren
op_plus
id|S_EXTRA_CLIENTDATA
)paren
suffix:semicolon
id|soft-&gt;protocol_id
op_assign
id|arcsoft-&gt;protocol_id
suffix:semicolon
id|soft-&gt;daddr
op_assign
id|daddr
suffix:semicolon
id|soft-&gt;saddr
op_assign
id|saddr
suffix:semicolon
id|skb-&gt;dev
op_assign
id|dev
suffix:semicolon
multiline_comment|/* is already lp-&gt;sdev */
id|BUGLVL
c_func
(paren
id|D_SKB
)paren
(brace
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|skb-&gt;len
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|i
op_mod
l_int|16
op_eq
l_int|0
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;&bslash;n[%04hX] &quot;
comma
id|i
)paren
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;%02hX &quot;
comma
(paren
(paren
r_int
r_char
op_star
)paren
id|skb-&gt;data
)paren
(braket
id|i
)braket
)paren
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
)brace
id|skb-&gt;protocol
op_assign
id|arcnetS_type_trans
c_func
(paren
id|skb
comma
id|dev
)paren
suffix:semicolon
id|netif_rx
c_func
(paren
id|skb
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/****************************************************************************&n; *                                                                          *&n; * Miscellaneous routines                                                   *&n; *                                                                          *&n; ****************************************************************************/
multiline_comment|/* Get the current statistics.&t;This may be called with the card open or&n; * closed.&n; */
r_static
r_struct
id|enet_statistics
op_star
DECL|function|arcnet_get_stats
id|arcnet_get_stats
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
r_struct
id|arcnet_local
op_star
id|lp
op_assign
(paren
r_struct
id|arcnet_local
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_return
op_amp
id|lp-&gt;stats
suffix:semicolon
)brace
macro_line|#if 0
multiline_comment|/* Set or clear the multicast filter for this adaptor.&n; * num_addrs == -1&t;Promiscuous mode, receive all packets&n; * num_addrs == 0&t;Normal mode, clear multicast list&n; * num_addrs &gt; 0&t;Multicast mode, receive normal and MC packets, and do&n; *&t;&t;&t;best-effort filtering.&n; */
r_static
r_void
id|set_multicast_list
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
macro_line|#if 0&t;  /* no promiscuous mode at all on most ARCnet models */
r_struct
id|arcnet_local
op_star
id|lp
op_assign
(paren
r_struct
id|arcnet_local
op_star
)paren
(paren
id|dev-&gt;priv
)paren
suffix:semicolon
r_int
id|ioaddr
op_assign
id|dev-&gt;base_addr
suffix:semicolon
r_if
c_cond
(paren
id|num_addrs
)paren
(brace
id|outw
c_func
(paren
l_int|69
comma
id|ioaddr
)paren
suffix:semicolon
multiline_comment|/* Enable promiscuous mode */
)brace
r_else
id|outw
c_func
(paren
l_int|99
comma
id|ioaddr
)paren
suffix:semicolon
multiline_comment|/* Disable promiscuous mode, use normal mode */
macro_line|#endif
)brace
macro_line|#endif
multiline_comment|/* Create the ARCnet ClientData header for an arbitrary protocol layer&n; *&n; * saddr=NULL&t;means use device source address (always will anyway)&n; * daddr=NULL&t;means leave destination address (eg unresolved arp)&n; */
DECL|function|arcnetA_header
r_int
id|arcnetA_header
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|device
op_star
id|dev
comma
r_int
r_int
id|type
comma
r_void
op_star
id|daddr
comma
r_void
op_star
id|saddr
comma
r_int
id|len
)paren
(brace
r_struct
id|ClientData
op_star
id|head
op_assign
(paren
r_struct
id|ClientData
op_star
)paren
id|skb_push
c_func
(paren
id|skb
comma
id|dev-&gt;hard_header_len
)paren
suffix:semicolon
r_struct
id|arcnet_local
op_star
id|lp
op_assign
(paren
r_struct
id|arcnet_local
op_star
)paren
(paren
id|dev-&gt;priv
)paren
suffix:semicolon
id|BUGMSG
c_func
(paren
id|D_DURING
comma
l_string|&quot;create header from %d to %d; protocol %d (%Xh); size %u.&bslash;n&quot;
comma
id|saddr
ques
c_cond
op_star
(paren
id|u_char
op_star
)paren
id|saddr
suffix:colon
op_minus
l_int|1
comma
id|daddr
ques
c_cond
op_star
(paren
id|u_char
op_star
)paren
id|daddr
suffix:colon
op_minus
l_int|1
comma
id|type
comma
id|type
comma
id|len
)paren
suffix:semicolon
multiline_comment|/* set the protocol ID according to RFC1201 */
r_switch
c_cond
(paren
id|type
)paren
(brace
r_case
id|ETH_P_IP
suffix:colon
id|head-&gt;protocol_id
op_assign
id|ARC_P_IP
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ETH_P_ARP
suffix:colon
id|head-&gt;protocol_id
op_assign
id|ARC_P_ARP
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ETH_P_RARP
suffix:colon
id|head-&gt;protocol_id
op_assign
id|ARC_P_RARP
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ETH_P_IPX
suffix:colon
r_case
id|ETH_P_802_3
suffix:colon
r_case
id|ETH_P_802_2
suffix:colon
id|head-&gt;protocol_id
op_assign
id|ARC_P_IPX
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ETH_P_ATALK
suffix:colon
id|head-&gt;protocol_id
op_assign
id|ARC_P_ATALK
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|BUGMSG
c_func
(paren
id|D_NORMAL
comma
l_string|&quot;I don&squot;t understand protocol %d (%Xh)&bslash;n&quot;
comma
id|type
comma
id|type
)paren
suffix:semicolon
id|lp-&gt;stats.tx_errors
op_increment
suffix:semicolon
id|lp-&gt;stats.tx_aborted_errors
op_increment
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * Set the source hardware address.&n;&t; *&n;&t; * This is pretty pointless for most purposes, but it can help&n;&t; * in debugging.  saddr is stored in the ClientData header and&n;&t; * removed before sending the packet (since ARCnet does not allow&n;&t; * us to change the source address in the actual packet sent)&n;&t; */
r_if
c_cond
(paren
id|saddr
)paren
(brace
id|head-&gt;saddr
op_assign
(paren
(paren
id|u_char
op_star
)paren
id|saddr
)paren
(braket
l_int|0
)braket
suffix:semicolon
)brace
r_else
id|head-&gt;saddr
op_assign
(paren
(paren
id|u_char
op_star
)paren
(paren
id|dev-&gt;dev_addr
)paren
)paren
(braket
l_int|0
)braket
suffix:semicolon
id|head-&gt;split_flag
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* split packets are done elsewhere */
id|head-&gt;sequence
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* so are sequence numbers */
multiline_comment|/* supposedly if daddr is NULL, we should ignore it... */
r_if
c_cond
(paren
id|daddr
)paren
(brace
id|head-&gt;daddr
op_assign
(paren
(paren
id|u_char
op_star
)paren
id|daddr
)paren
(braket
l_int|0
)braket
suffix:semicolon
r_return
id|dev-&gt;hard_header_len
suffix:semicolon
)brace
r_else
id|head-&gt;daddr
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* better fill one in anyway */
r_return
op_minus
id|dev-&gt;hard_header_len
suffix:semicolon
)brace
multiline_comment|/* Create the ARCnet ClientData header for an arbitrary protocol layer&n; *&n; * saddr=NULL&t;means use device source address (always will anyway)&n; * daddr=NULL&t;means leave destination address (eg unresolved arp)&n; */
DECL|function|arcnetS_header
r_int
id|arcnetS_header
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|device
op_star
id|dev
comma
r_int
r_int
id|type
comma
r_void
op_star
id|daddr
comma
r_void
op_star
id|saddr
comma
r_int
id|len
)paren
(brace
r_struct
id|S_ClientData
op_star
id|head
op_assign
(paren
r_struct
id|S_ClientData
op_star
)paren
id|skb_push
c_func
(paren
id|skb
comma
id|dev-&gt;hard_header_len
)paren
suffix:semicolon
r_struct
id|arcnet_local
op_star
id|lp
op_assign
(paren
r_struct
id|arcnet_local
op_star
)paren
(paren
id|dev-&gt;priv
)paren
suffix:semicolon
multiline_comment|/* set the protocol ID according to RFC1051 */
r_switch
c_cond
(paren
id|type
)paren
(brace
r_case
id|ETH_P_IP
suffix:colon
id|head-&gt;protocol_id
op_assign
id|ARC_P_IP_RFC1051
suffix:semicolon
id|BUGMSG
c_func
(paren
id|D_DURING
comma
l_string|&quot;S_header: IP_RFC1051 packet.&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ETH_P_ARP
suffix:colon
id|head-&gt;protocol_id
op_assign
id|ARC_P_ARP_RFC1051
suffix:semicolon
id|BUGMSG
c_func
(paren
id|D_DURING
comma
l_string|&quot;S_header: ARP_RFC1051 packet.&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|BUGMSG
c_func
(paren
id|D_NORMAL
comma
l_string|&quot;I don&squot;t understand protocol %d (%Xh)&bslash;n&quot;
comma
id|type
comma
id|type
)paren
suffix:semicolon
id|lp-&gt;stats.tx_errors
op_increment
suffix:semicolon
id|lp-&gt;stats.tx_aborted_errors
op_increment
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * Set the source hardware address.&n;&t; *&n;&t; * This is pretty pointless for most purposes, but it can help&n;&t; * in debugging.  saddr is stored in the ClientData header and&n;&t; * removed before sending the packet (since ARCnet does not allow&n;&t; * us to change the source address in the actual packet sent)&n;&t; */
r_if
c_cond
(paren
id|saddr
)paren
(brace
id|head-&gt;saddr
op_assign
(paren
(paren
id|u_char
op_star
)paren
id|saddr
)paren
(braket
l_int|0
)braket
suffix:semicolon
)brace
r_else
id|head-&gt;saddr
op_assign
(paren
(paren
id|u_char
op_star
)paren
(paren
id|dev-&gt;dev_addr
)paren
)paren
(braket
l_int|0
)braket
suffix:semicolon
multiline_comment|/* supposedly if daddr is NULL, we should ignore it... */
r_if
c_cond
(paren
id|daddr
)paren
(brace
id|head-&gt;daddr
op_assign
(paren
(paren
id|u_char
op_star
)paren
id|daddr
)paren
(braket
l_int|0
)braket
suffix:semicolon
r_return
id|dev-&gt;hard_header_len
suffix:semicolon
)brace
r_else
id|head-&gt;daddr
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* better fill one in anyway */
r_return
op_minus
id|dev-&gt;hard_header_len
suffix:semicolon
)brace
multiline_comment|/* Rebuild the ARCnet ClientData header. This is called after an ARP&n; * (or in future other address resolution) has completed on this&n; * sk_buff. We now let ARP fill in the other fields.&n; */
DECL|function|arcnetA_rebuild_header
r_int
id|arcnetA_rebuild_header
c_func
(paren
r_void
op_star
id|buff
comma
r_struct
id|device
op_star
id|dev
comma
r_int
r_int
id|dst
comma
r_struct
id|sk_buff
op_star
id|skb
)paren
(brace
r_struct
id|ClientData
op_star
id|head
op_assign
(paren
r_struct
id|ClientData
op_star
)paren
id|buff
suffix:semicolon
r_struct
id|arcnet_local
op_star
id|lp
op_assign
(paren
r_struct
id|arcnet_local
op_star
)paren
(paren
id|dev-&gt;priv
)paren
suffix:semicolon
r_int
id|status
suffix:semicolon
multiline_comment|/*&n;&t; * Only ARP and IP are currently supported&n;&t; */
r_if
c_cond
(paren
id|head-&gt;protocol_id
op_ne
id|ARC_P_IP
)paren
(brace
id|BUGMSG
c_func
(paren
id|D_NORMAL
comma
l_string|&quot;I don&squot;t understand protocol type %d (%Xh) addresses!&bslash;n&quot;
comma
id|head-&gt;protocol_id
comma
id|head-&gt;protocol_id
)paren
suffix:semicolon
id|lp-&gt;stats.tx_errors
op_increment
suffix:semicolon
id|lp-&gt;stats.tx_aborted_errors
op_increment
suffix:semicolon
id|head-&gt;daddr
op_assign
l_int|0
suffix:semicolon
multiline_comment|/*memcpy(eth-&gt;h_source, dev-&gt;dev_addr, dev-&gt;addr_len);*/
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * Try and get ARP to resolve the header.&n;&t; */
macro_line|#ifdef CONFIG_INET&t; 
id|BUGMSG
c_func
(paren
id|D_DURING
comma
l_string|&quot;rebuild header from %d to %d; protocol %Xh&bslash;n&quot;
comma
id|head-&gt;saddr
comma
id|head-&gt;daddr
comma
id|head-&gt;protocol_id
)paren
suffix:semicolon
id|status
op_assign
id|arp_find
c_func
(paren
op_amp
(paren
id|head-&gt;daddr
)paren
comma
id|dst
comma
id|dev
comma
id|dev-&gt;pa_addr
comma
id|skb
)paren
ques
c_cond
l_int|1
suffix:colon
l_int|0
suffix:semicolon
id|BUGMSG
c_func
(paren
id|D_DURING
comma
l_string|&quot; rebuilt: from %d to %d; protocol %Xh&bslash;n&quot;
comma
id|head-&gt;saddr
comma
id|head-&gt;daddr
comma
id|head-&gt;protocol_id
)paren
suffix:semicolon
r_return
id|status
suffix:semicolon
macro_line|#else
r_return
l_int|0
suffix:semicolon
macro_line|#endif&t;
)brace
DECL|function|arcnetS_rebuild_header
r_int
id|arcnetS_rebuild_header
c_func
(paren
r_void
op_star
id|buff
comma
r_struct
id|device
op_star
id|dev
comma
r_int
r_int
id|dst
comma
r_struct
id|sk_buff
op_star
id|skb
)paren
(brace
r_struct
id|S_ClientData
op_star
id|head
op_assign
(paren
r_struct
id|S_ClientData
op_star
)paren
id|buff
suffix:semicolon
r_struct
id|arcnet_local
op_star
id|lp
op_assign
(paren
r_struct
id|arcnet_local
op_star
)paren
(paren
id|dev-&gt;priv
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Only ARP and IP are currently supported&n;&t; */
r_if
c_cond
(paren
id|head-&gt;protocol_id
op_ne
id|ARC_P_IP_RFC1051
)paren
(brace
id|BUGMSG
c_func
(paren
id|D_NORMAL
comma
l_string|&quot;I don&squot;t understand protocol type %d (%Xh) addresses!&bslash;n&quot;
comma
id|head-&gt;protocol_id
comma
id|head-&gt;protocol_id
)paren
suffix:semicolon
id|lp-&gt;stats.tx_errors
op_increment
suffix:semicolon
id|lp-&gt;stats.tx_aborted_errors
op_increment
suffix:semicolon
id|head-&gt;daddr
op_assign
l_int|0
suffix:semicolon
multiline_comment|/*memcpy(eth-&gt;h_source, dev-&gt;dev_addr, dev-&gt;addr_len);*/
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * Try and get ARP to resolve the header.&n;&t; */
macro_line|#ifdef CONFIG_INET&t; 
r_return
id|arp_find
c_func
(paren
op_amp
(paren
id|head-&gt;daddr
)paren
comma
id|dst
comma
id|dev
comma
id|dev-&gt;pa_addr
comma
id|skb
)paren
ques
c_cond
l_int|1
suffix:colon
l_int|0
suffix:semicolon
macro_line|#else
r_return
l_int|0
suffix:semicolon
macro_line|#endif&t;
)brace
multiline_comment|/* Determine a packet&squot;s protocol ID.&n; *&n; * With ARCnet we have to convert everything to Ethernet-style stuff.&n; */
DECL|function|arcnetA_type_trans
r_int
r_int
id|arcnetA_type_trans
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|device
op_star
id|dev
)paren
(brace
r_struct
id|ClientData
op_star
id|head
suffix:semicolon
r_struct
id|arcnet_local
op_star
id|lp
op_assign
(paren
r_struct
id|arcnet_local
op_star
)paren
(paren
id|dev-&gt;priv
)paren
suffix:semicolon
multiline_comment|/* Pull off the arcnet header. */
id|skb-&gt;mac.raw
op_assign
id|skb-&gt;data
suffix:semicolon
id|skb_pull
c_func
(paren
id|skb
comma
id|dev-&gt;hard_header_len
)paren
suffix:semicolon
id|head
op_assign
(paren
r_struct
id|ClientData
op_star
)paren
id|skb-&gt;mac.raw
suffix:semicolon
r_if
c_cond
(paren
id|head-&gt;daddr
op_eq
l_int|0
)paren
id|skb-&gt;pkt_type
op_assign
id|PACKET_BROADCAST
suffix:semicolon
r_else
r_if
c_cond
(paren
id|dev-&gt;flags
op_amp
id|IFF_PROMISC
)paren
(brace
multiline_comment|/* if we&squot;re not sending to ourselves :) */
r_if
c_cond
(paren
id|head-&gt;daddr
op_ne
id|dev-&gt;dev_addr
(braket
l_int|0
)braket
)paren
id|skb-&gt;pkt_type
op_assign
id|PACKET_OTHERHOST
suffix:semicolon
)brace
multiline_comment|/* now return the protocol number */
r_switch
c_cond
(paren
id|head-&gt;protocol_id
)paren
(brace
r_case
id|ARC_P_IP
suffix:colon
r_return
id|htons
c_func
(paren
id|ETH_P_IP
)paren
suffix:semicolon
r_case
id|ARC_P_ARP
suffix:colon
r_return
id|htons
c_func
(paren
id|ETH_P_ARP
)paren
suffix:semicolon
r_case
id|ARC_P_RARP
suffix:colon
r_return
id|htons
c_func
(paren
id|ETH_P_RARP
)paren
suffix:semicolon
r_case
id|ARC_P_IPX
suffix:colon
r_case
id|ARC_P_NOVELL_EC
suffix:colon
r_return
id|htons
c_func
(paren
id|ETH_P_802_3
)paren
suffix:semicolon
r_default
suffix:colon
id|BUGMSG
c_func
(paren
id|D_NORMAL
comma
l_string|&quot;received packet of unknown protocol id %d (%Xh)&bslash;n&quot;
comma
id|head-&gt;protocol_id
comma
id|head-&gt;protocol_id
)paren
suffix:semicolon
id|lp-&gt;stats.rx_errors
op_increment
suffix:semicolon
id|lp-&gt;stats.rx_crc_errors
op_increment
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_return
id|htons
c_func
(paren
id|ETH_P_IP
)paren
suffix:semicolon
)brace
DECL|function|arcnetS_type_trans
r_int
r_int
id|arcnetS_type_trans
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|device
op_star
id|dev
)paren
(brace
r_struct
id|S_ClientData
op_star
id|head
suffix:semicolon
r_struct
id|arcnet_local
op_star
id|lp
op_assign
(paren
r_struct
id|arcnet_local
op_star
)paren
(paren
id|dev-&gt;priv
)paren
suffix:semicolon
multiline_comment|/* Pull off the arcnet header. */
id|skb-&gt;mac.raw
op_assign
id|skb-&gt;data
suffix:semicolon
id|skb_pull
c_func
(paren
id|skb
comma
id|dev-&gt;hard_header_len
)paren
suffix:semicolon
id|head
op_assign
(paren
r_struct
id|S_ClientData
op_star
)paren
id|skb-&gt;mac.raw
suffix:semicolon
r_if
c_cond
(paren
id|head-&gt;daddr
op_eq
l_int|0
)paren
id|skb-&gt;pkt_type
op_assign
id|PACKET_BROADCAST
suffix:semicolon
r_else
r_if
c_cond
(paren
id|dev-&gt;flags
op_amp
id|IFF_PROMISC
)paren
(brace
multiline_comment|/* if we&squot;re not sending to ourselves :) */
r_if
c_cond
(paren
id|head-&gt;daddr
op_ne
id|dev-&gt;dev_addr
(braket
l_int|0
)braket
)paren
id|skb-&gt;pkt_type
op_assign
id|PACKET_OTHERHOST
suffix:semicolon
)brace
multiline_comment|/* now return the protocol number */
r_switch
c_cond
(paren
id|head-&gt;protocol_id
)paren
(brace
r_case
id|ARC_P_IP_RFC1051
suffix:colon
r_return
id|htons
c_func
(paren
id|ETH_P_IP
)paren
suffix:semicolon
r_case
id|ARC_P_ARP_RFC1051
suffix:colon
r_return
id|htons
c_func
(paren
id|ETH_P_ARP
)paren
suffix:semicolon
r_case
id|ARC_P_ATALK
suffix:colon
r_return
id|htons
c_func
(paren
id|ETH_P_ATALK
)paren
suffix:semicolon
multiline_comment|/* untested appletalk */
r_default
suffix:colon
id|BUGMSG
c_func
(paren
id|D_NORMAL
comma
l_string|&quot;received packet of unknown protocol id %d (%Xh)&bslash;n&quot;
comma
id|head-&gt;protocol_id
comma
id|head-&gt;protocol_id
)paren
suffix:semicolon
id|lp-&gt;stats.rx_errors
op_increment
suffix:semicolon
id|lp-&gt;stats.rx_crc_errors
op_increment
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_return
id|htons
c_func
(paren
id|ETH_P_IP
)paren
suffix:semicolon
)brace
multiline_comment|/****************************************************************************&n; *                                                                          *&n; * Kernel Loadable Module Support                                           *&n; *                                                                          *&n; ****************************************************************************/
macro_line|#ifdef MODULE
DECL|variable|devicename
r_static
r_char
id|devicename
(braket
l_int|9
)braket
op_assign
(brace
l_int|0
comma
)brace
suffix:semicolon
DECL|variable|thiscard
r_static
r_struct
id|device
id|thiscard
op_assign
(brace
id|devicename
comma
multiline_comment|/* device name is inserted by linux/drivers/net/net_init.c */
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
multiline_comment|/* I/O address, IRQ */
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|NULL
comma
id|arcnet_probe
)brace
suffix:semicolon
DECL|variable|io
r_static
r_int
id|io
op_assign
l_int|0x0
suffix:semicolon
multiline_comment|/* &lt;--- EDIT THESE LINES FOR YOUR CONFIGURATION */
DECL|variable|irqnum
r_static
r_int
id|irqnum
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* or use the insmod io= irqnum= shmem= options */
DECL|variable|shmem
r_static
r_int
id|shmem
op_assign
l_int|0
suffix:semicolon
DECL|variable|num
r_static
r_int
id|num
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* number of device (ie for 0 for arc0, 1 for arc1...) */
r_int
DECL|function|init_module
id|init_module
c_func
(paren
r_void
)paren
(brace
id|sprintf
c_func
(paren
id|thiscard.name
comma
l_string|&quot;arc%d&quot;
comma
id|num
)paren
suffix:semicolon
id|thiscard.base_addr
op_assign
id|io
suffix:semicolon
id|thiscard.irq
op_assign
id|irqnum
suffix:semicolon
r_if
c_cond
(paren
id|thiscard.irq
op_eq
l_int|2
)paren
id|thiscard.irq
op_assign
l_int|9
suffix:semicolon
r_if
c_cond
(paren
id|shmem
)paren
(brace
id|thiscard.mem_start
op_assign
id|shmem
suffix:semicolon
id|thiscard.mem_end
op_assign
id|thiscard.mem_start
op_plus
l_int|512
op_star
l_int|4
op_minus
l_int|1
suffix:semicolon
id|thiscard.rmem_start
op_assign
id|thiscard.mem_start
op_plus
l_int|512
op_star
l_int|0
suffix:semicolon
id|thiscard.rmem_end
op_assign
id|thiscard.mem_start
op_plus
l_int|512
op_star
l_int|2
op_minus
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|register_netdev
c_func
(paren
op_amp
id|thiscard
)paren
op_ne
l_int|0
)paren
r_return
op_minus
id|EIO
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_void
DECL|function|cleanup_module
id|cleanup_module
c_func
(paren
r_void
)paren
(brace
r_int
id|ioaddr
op_assign
id|thiscard.base_addr
suffix:semicolon
r_if
c_cond
(paren
id|thiscard.start
)paren
id|arcnet_close
c_func
(paren
op_amp
id|thiscard
)paren
suffix:semicolon
multiline_comment|/* Flush TX and disable RX */
r_if
c_cond
(paren
id|ioaddr
)paren
(brace
id|outb
c_func
(paren
l_int|0
comma
id|INTMASK
)paren
suffix:semicolon
multiline_comment|/* disable IRQ&squot;s */
id|outb
c_func
(paren
id|NOTXcmd
comma
id|COMMAND
)paren
suffix:semicolon
multiline_comment|/* stop transmit */
id|outb
c_func
(paren
id|NORXcmd
comma
id|COMMAND
)paren
suffix:semicolon
multiline_comment|/* disable receive */
)brace
r_if
c_cond
(paren
id|thiscard.irq
)paren
(brace
id|free_irq
c_func
(paren
id|thiscard.irq
)paren
suffix:semicolon
multiline_comment|/* very important! */
id|irq2dev_map
(braket
id|thiscard.irq
)braket
op_assign
l_int|NULL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|thiscard.base_addr
)paren
id|release_region
c_func
(paren
id|thiscard.base_addr
comma
id|ARCNET_TOTAL_SIZE
)paren
suffix:semicolon
id|unregister_netdev
c_func
(paren
op_amp
id|thiscard
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|thiscard.priv
)paren
suffix:semicolon
id|thiscard.priv
op_assign
l_int|NULL
suffix:semicolon
)brace
macro_line|#endif /* MODULE */
"&f;"
multiline_comment|/*&n; * Local variables:&n; *  compile-command: &quot;gcc -D__KERNEL__ -I/usr/src/linux/net/inet -Wall -Wstrict-prototypes -O6 -m486 -c arcnet.c&quot;&n; *  version-control: t&n; *  kept-new-versions: 5&n; *  tab-width: 8&n; * End:&n; */
eof
