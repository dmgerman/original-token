multiline_comment|/* drivers/net/eepro100.c: An Intel i82557-559 Ethernet driver for Linux. */
multiline_comment|/*&n;   NOTICE: For use with late 2.3 kernels only.&n;   May not compile for kernels 2.3.43-47.&n;&t;Written 1996-1999 by Donald Becker.&n;&n;&t;The driver also contains updates by different kernel developers&n;&t;(see incomplete list below).&n;&t;Current maintainer is Andrey V. Savochkin &lt;saw@saw.sw.com.sg&gt;.&n;&t;Please use this email address and linux-kernel mailing list for bug reports.&n;&n;&t;This software may be used and distributed according to the terms&n;&t;of the GNU Public License, incorporated herein by reference.&n;&n;&t;This driver is for the Intel EtherExpress Pro100 (Speedo3) design.&n;&t;It should work with all i82557/558/559 boards.&n;&n;&t;Version history:&n;&t;1998 Apr - 2000 Feb  Andrey V. Savochkin &lt;saw@saw.sw.com.sg&gt;&n;&t;&t;Serious fixes for multicast filter list setting, TX timeout routine;&n;&t;&t;RX ring refilling logic;  other stuff&n;&t;2000 Feb  Jeff Garzik &lt;jgarzik@mandrakesoft.com&gt;&n;&t;&t;Convert to new PCI driver interface&n;&t;2000 Mar 24  Dragan Stancevic &lt;visitor@valinux.com&gt;&n;&t;&t;Disabled FC and ER, to avoid lockups when when we get FCP interrupts.&n;&t;2000 Jul 17 Goutham Rao &lt;goutham.rao@intel.com&gt;&n;&t;&t;PCI DMA API fixes, adding pci_dma_sync_single calls where neccesary&n;*/
DECL|variable|version
r_static
r_const
r_char
op_star
id|version
op_assign
l_string|&quot;eepro100.c:v1.09j-t 9/29/99 Donald Becker http://cesdis.gsfc.nasa.gov/linux/drivers/eepro100.html&bslash;n&quot;
l_string|&quot;eepro100.c: $Revision: 1.35 $ 2000/11/17 Modified by Andrey V. Savochkin &lt;saw@saw.sw.com.sg&gt; and others&bslash;n&quot;
suffix:semicolon
multiline_comment|/* A few user-configurable values that apply to all boards.&n;   First set is undocumented and spelled per Intel recommendations. */
DECL|variable|congenb
r_static
r_int
id|congenb
multiline_comment|/* = 0 */
suffix:semicolon
multiline_comment|/* Enable congestion control in the DP83840. */
DECL|variable|txfifo
r_static
r_int
id|txfifo
op_assign
l_int|8
suffix:semicolon
multiline_comment|/* Tx FIFO threshold in 4 byte units, 0-15 */
DECL|variable|rxfifo
r_static
r_int
id|rxfifo
op_assign
l_int|8
suffix:semicolon
multiline_comment|/* Rx FIFO threshold, default 32 bytes. */
multiline_comment|/* Tx/Rx DMA burst length, 0-127, 0 == no preemption, tx==128 -&gt; disabled. */
DECL|variable|txdmacount
r_static
r_int
id|txdmacount
op_assign
l_int|128
suffix:semicolon
DECL|variable|rxdmacount
r_static
r_int
id|rxdmacount
multiline_comment|/* = 0 */
suffix:semicolon
multiline_comment|/* Set the copy breakpoint for the copy-only-tiny-buffer Rx method.&n;   Lower values use more memory, but are faster. */
macro_line|#if defined(__alpha__) || defined(__sparc__)
DECL|variable|rx_copybreak
r_static
r_int
id|rx_copybreak
op_assign
l_int|1518
suffix:semicolon
macro_line|#else
DECL|variable|rx_copybreak
r_static
r_int
id|rx_copybreak
op_assign
l_int|200
suffix:semicolon
macro_line|#endif
multiline_comment|/* Maximum events (Rx packets, etc.) to handle at each interrupt. */
DECL|variable|max_interrupt_work
r_static
r_int
id|max_interrupt_work
op_assign
l_int|20
suffix:semicolon
multiline_comment|/* Maximum number of multicast addresses to filter (vs. rx-all-multicast) */
DECL|variable|multicast_filter_limit
r_static
r_int
id|multicast_filter_limit
op_assign
l_int|64
suffix:semicolon
multiline_comment|/* &squot;options&squot; is used to pass a transceiver override or full-duplex flag&n;   e.g. &quot;options=16&quot; for FD, &quot;options=32&quot; for 100mbps-only. */
DECL|variable|full_duplex
r_static
r_int
id|full_duplex
(braket
)braket
op_assign
(brace
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
)brace
suffix:semicolon
DECL|variable|options
r_static
r_int
id|options
(braket
)braket
op_assign
(brace
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
)brace
suffix:semicolon
DECL|variable|debug
r_static
r_int
id|debug
op_assign
op_minus
l_int|1
suffix:semicolon
multiline_comment|/* The debug level */
multiline_comment|/* A few values that may be tweaked. */
multiline_comment|/* The ring sizes should be a power of two for efficiency. */
DECL|macro|TX_RING_SIZE
mdefine_line|#define TX_RING_SIZE&t;32
DECL|macro|RX_RING_SIZE
mdefine_line|#define RX_RING_SIZE&t;32
multiline_comment|/* How much slots multicast filter setup may take.&n;   Do not descrease without changing set_rx_mode() implementaion. */
DECL|macro|TX_MULTICAST_SIZE
mdefine_line|#define TX_MULTICAST_SIZE   2
DECL|macro|TX_MULTICAST_RESERV
mdefine_line|#define TX_MULTICAST_RESERV (TX_MULTICAST_SIZE*2)
multiline_comment|/* Actual number of TX packets queued, must be&n;   &lt;= TX_RING_SIZE-TX_MULTICAST_RESERV. */
DECL|macro|TX_QUEUE_LIMIT
mdefine_line|#define TX_QUEUE_LIMIT  (TX_RING_SIZE-TX_MULTICAST_RESERV)
multiline_comment|/* Hysteresis marking queue as no longer full. */
DECL|macro|TX_QUEUE_UNFULL
mdefine_line|#define TX_QUEUE_UNFULL (TX_QUEUE_LIMIT-4)
multiline_comment|/* Operational parameters that usually are not changed. */
multiline_comment|/* Time in jiffies before concluding the transmitter is hung. */
DECL|macro|TX_TIMEOUT
mdefine_line|#define TX_TIMEOUT&t;&t;(2*HZ)
multiline_comment|/* Size of an pre-allocated Rx buffer: &lt;Ethernet MTU&gt; + slack.*/
DECL|macro|PKT_BUF_SZ
mdefine_line|#define PKT_BUF_SZ&t;&t;1536
macro_line|#if !defined(__OPTIMIZE__)  ||  !defined(__KERNEL__)
macro_line|#warning  You must compile this file with the correct options!
macro_line|#warning  See the last lines of the source file.
macro_line|#error You must compile this driver with &quot;-O&quot;.
macro_line|#endif
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/version.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#if defined(MODVERSIONS)
macro_line|#include &lt;linux/modversions.h&gt;
macro_line|#endif
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/ioport.h&gt;
macro_line|#include &lt;linux/malloc.h&gt;
macro_line|#include &lt;linux/interrupt.h&gt;
macro_line|#include &lt;linux/timer.h&gt;
macro_line|#include &lt;linux/pci.h&gt;
macro_line|#include &lt;linux/spinlock.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;asm/bitops.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;linux/netdevice.h&gt;
macro_line|#include &lt;linux/etherdevice.h&gt;
macro_line|#include &lt;linux/skbuff.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
id|MODULE_AUTHOR
c_func
(paren
l_string|&quot;Maintainer: Andrey V. Savochkin &lt;saw@saw.sw.com.sg&gt;&quot;
)paren
suffix:semicolon
id|MODULE_DESCRIPTION
c_func
(paren
l_string|&quot;Intel i82557/i82558/i82559 PCI EtherExpressPro driver&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|debug
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|options
comma
l_string|&quot;1-&quot;
id|__MODULE_STRING
c_func
(paren
l_int|8
)paren
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|full_duplex
comma
l_string|&quot;1-&quot;
id|__MODULE_STRING
c_func
(paren
l_int|8
)paren
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|congenb
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|txfifo
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|rxfifo
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|txdmacount
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|rxdmacount
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|rx_copybreak
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|max_interrupt_work
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|multicast_filter_limit
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
DECL|macro|RUN_AT
mdefine_line|#define RUN_AT(x) (jiffies + (x))
multiline_comment|/* ACPI power states don&squot;t universally work (yet) */
macro_line|#ifndef CONFIG_EEPRO100_PM
DECL|macro|pci_set_power_state
macro_line|#undef pci_set_power_state
DECL|macro|pci_set_power_state
mdefine_line|#define pci_set_power_state null_set_power_state
DECL|function|null_set_power_state
r_static
r_inline
r_int
id|null_set_power_state
c_func
(paren
r_struct
id|pci_dev
op_star
id|dev
comma
r_int
id|state
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#endif /* CONFIG_EEPRO100_PM */
DECL|macro|netdevice_start
mdefine_line|#define netdevice_start(dev)
DECL|macro|netdevice_stop
mdefine_line|#define netdevice_stop(dev)
DECL|macro|netif_set_tx_timeout
mdefine_line|#define netif_set_tx_timeout(dev, tf, tm) &bslash;&n;&t;&t;&t;&t;&t;&t;&t;&t;do { &bslash;&n;&t;&t;&t;&t;&t;&t;&t;&t;&t;(dev)-&gt;tx_timeout = (tf); &bslash;&n;&t;&t;&t;&t;&t;&t;&t;&t;&t;(dev)-&gt;watchdog_timeo = (tm); &bslash;&n;&t;&t;&t;&t;&t;&t;&t;&t;} while(0)
DECL|macro|netif_device_attach
mdefine_line|#define netif_device_attach(dev) netif_start_queue(dev)
DECL|macro|netif_device_detach
mdefine_line|#define netif_device_detach(dev) netif_stop_queue(dev)
macro_line|#ifndef PCI_DEVICE_ID_INTEL_ID1029
DECL|macro|PCI_DEVICE_ID_INTEL_ID1029
mdefine_line|#define PCI_DEVICE_ID_INTEL_ID1029 0x1029
macro_line|#endif
macro_line|#ifndef PCI_DEVICE_ID_INTEL_ID1030
DECL|macro|PCI_DEVICE_ID_INTEL_ID1030
mdefine_line|#define PCI_DEVICE_ID_INTEL_ID1030 0x1030
macro_line|#endif
DECL|variable|speedo_debug
r_int
id|speedo_debug
op_assign
l_int|1
suffix:semicolon
multiline_comment|/*&n;&t;&t;&t;&t;Theory of Operation&n;&n;I. Board Compatibility&n;&n;This device driver is designed for the Intel i82557 &quot;Speedo3&quot; chip, Intel&squot;s&n;single-chip fast Ethernet controller for PCI, as used on the Intel&n;EtherExpress Pro 100 adapter.&n;&n;II. Board-specific settings&n;&n;PCI bus devices are configured by the system at boot time, so no jumpers&n;need to be set on the board.  The system BIOS should be set to assign the&n;PCI INTA signal to an otherwise unused system IRQ line.  While it&squot;s&n;possible to share PCI interrupt lines, it negatively impacts performance and&n;only recent kernels support it.&n;&n;III. Driver operation&n;&n;IIIA. General&n;The Speedo3 is very similar to other Intel network chips, that is to say&n;&quot;apparently designed on a different planet&quot;.  This chips retains the complex&n;Rx and Tx descriptors and multiple buffers pointers as previous chips, but&n;also has simplified Tx and Rx buffer modes.  This driver uses the &quot;flexible&quot;&n;Tx mode, but in a simplified lower-overhead manner: it associates only a&n;single buffer descriptor with each frame descriptor.&n;&n;Despite the extra space overhead in each receive skbuff, the driver must use&n;the simplified Rx buffer mode to assure that only a single data buffer is&n;associated with each RxFD. The driver implements this by reserving space&n;for the Rx descriptor at the head of each Rx skbuff.&n;&n;The Speedo-3 has receive and command unit base addresses that are added to&n;almost all descriptor pointers.  The driver sets these to zero, so that all&n;pointer fields are absolute addresses.&n;&n;The System Control Block (SCB) of some previous Intel chips exists on the&n;chip in both PCI I/O and memory space.  This driver uses the I/O space&n;registers, but might switch to memory mapped mode to better support non-x86&n;processors.&n;&n;IIIB. Transmit structure&n;&n;The driver must use the complex Tx command+descriptor mode in order to&n;have a indirect pointer to the skbuff data section.  Each Tx command block&n;(TxCB) is associated with two immediately appended Tx Buffer Descriptor&n;(TxBD).  A fixed ring of these TxCB+TxBD pairs are kept as part of the&n;speedo_private data structure for each adapter instance.&n;&n;The newer i82558 explicitly supports this structure, and can read the two&n;TxBDs in the same PCI burst as the TxCB.&n;&n;This ring structure is used for all normal transmit packets, but the&n;transmit packet descriptors aren&squot;t long enough for most non-Tx commands such&n;as CmdConfigure.  This is complicated by the possibility that the chip has&n;already loaded the link address in the previous descriptor.  So for these&n;commands we convert the next free descriptor on the ring to a NoOp, and point&n;that descriptor&squot;s link to the complex command.&n;&n;An additional complexity of these non-transmit commands are that they may be&n;added asynchronous to the normal transmit queue, so we disable interrupts&n;whenever the Tx descriptor ring is manipulated.&n;&n;A notable aspect of these special configure commands is that they do&n;work with the normal Tx ring entry scavenge method.  The Tx ring scavenge&n;is done at interrupt time using the &squot;dirty_tx&squot; index, and checking for the&n;command-complete bit.  While the setup frames may have the NoOp command on the&n;Tx ring marked as complete, but not have completed the setup command, this&n;is not a problem.  The tx_ring entry can be still safely reused, as the&n;tx_skbuff[] entry is always empty for config_cmd and mc_setup frames.&n;&n;Commands may have bits set e.g. CmdSuspend in the command word to either&n;suspend or stop the transmit/command unit.  This driver always flags the last&n;command with CmdSuspend, erases the CmdSuspend in the previous command, and&n;then issues a CU_RESUME.&n;Note: Watch out for the potential race condition here: imagine&n;&t;erasing the previous suspend&n;&t;&t;the chip processes the previous command&n;&t;&t;the chip processes the final command, and suspends&n;&t;doing the CU_RESUME&n;&t;&t;the chip processes the next-yet-valid post-final-command.&n;So blindly sending a CU_RESUME is only safe if we do it immediately after&n;after erasing the previous CmdSuspend, without the possibility of an&n;intervening delay.  Thus the resume command is always within the&n;interrupts-disabled region.  This is a timing dependence, but handling this&n;condition in a timing-independent way would considerably complicate the code.&n;&n;Note: In previous generation Intel chips, restarting the command unit was a&n;notoriously slow process.  This is presumably no longer true.&n;&n;IIIC. Receive structure&n;&n;Because of the bus-master support on the Speedo3 this driver uses the new&n;SKBUFF_RX_COPYBREAK scheme, rather than a fixed intermediate receive buffer.&n;This scheme allocates full-sized skbuffs as receive buffers.  The value&n;SKBUFF_RX_COPYBREAK is used as the copying breakpoint: it is chosen to&n;trade-off the memory wasted by passing the full-sized skbuff to the queue&n;layer for all frames vs. the copying cost of copying a frame to a&n;correctly-sized skbuff.&n;&n;For small frames the copying cost is negligible (esp. considering that we&n;are pre-loading the cache with immediately useful header information), so we&n;allocate a new, minimally-sized skbuff.  For large frames the copying cost&n;is non-trivial, and the larger copy might flush the cache of useful data, so&n;we pass up the skbuff the packet was received into.&n;&n;IV. Notes&n;&n;Thanks to Steve Williams of Intel for arranging the non-disclosure agreement&n;that stated that I could disclose the information.  But I still resent&n;having to sign an Intel NDA when I&squot;m helping Intel sell their own product!&n;&n;*/
r_static
r_int
id|speedo_found1
c_func
(paren
r_struct
id|pci_dev
op_star
id|pdev
comma
r_int
id|ioaddr
comma
r_int
id|fnd_cnt
comma
r_int
id|acpi_idle_state
)paren
suffix:semicolon
DECL|enum|pci_flags_bit
r_enum
id|pci_flags_bit
(brace
DECL|enumerator|PCI_USES_IO
DECL|enumerator|PCI_USES_MEM
DECL|enumerator|PCI_USES_MASTER
id|PCI_USES_IO
op_assign
l_int|1
comma
id|PCI_USES_MEM
op_assign
l_int|2
comma
id|PCI_USES_MASTER
op_assign
l_int|4
comma
DECL|enumerator|PCI_ADDR0
DECL|enumerator|PCI_ADDR1
DECL|enumerator|PCI_ADDR2
DECL|enumerator|PCI_ADDR3
id|PCI_ADDR0
op_assign
l_int|0x10
op_lshift
l_int|0
comma
id|PCI_ADDR1
op_assign
l_int|0x10
op_lshift
l_int|1
comma
id|PCI_ADDR2
op_assign
l_int|0x10
op_lshift
l_int|2
comma
id|PCI_ADDR3
op_assign
l_int|0x10
op_lshift
l_int|3
comma
)brace
suffix:semicolon
DECL|function|io_inw
r_static
r_inline
r_int
r_int
id|io_inw
c_func
(paren
r_int
r_int
id|port
)paren
(brace
r_return
id|inw
c_func
(paren
id|port
)paren
suffix:semicolon
)brace
DECL|function|io_outw
r_static
r_inline
r_void
id|io_outw
c_func
(paren
r_int
r_int
id|val
comma
r_int
r_int
id|port
)paren
(brace
id|outw
c_func
(paren
id|val
comma
id|port
)paren
suffix:semicolon
)brace
macro_line|#ifndef USE_IO
multiline_comment|/* Currently alpha headers define in/out macros.&n;   Undefine them.  2000/03/30  SAW */
DECL|macro|inb
macro_line|#undef inb
DECL|macro|inw
macro_line|#undef inw
DECL|macro|inl
macro_line|#undef inl
DECL|macro|outb
macro_line|#undef outb
DECL|macro|outw
macro_line|#undef outw
DECL|macro|outl
macro_line|#undef outl
DECL|macro|inb
mdefine_line|#define inb readb
DECL|macro|inw
mdefine_line|#define inw readw
DECL|macro|inl
mdefine_line|#define inl readl
DECL|macro|outb
mdefine_line|#define outb writeb
DECL|macro|outw
mdefine_line|#define outw writew
DECL|macro|outl
mdefine_line|#define outl writel
macro_line|#endif
multiline_comment|/* How to wait for the command unit to accept a command.&n;   Typically this takes 0 ticks. */
DECL|function|wait_for_cmd_done
r_static
r_inline
r_void
id|wait_for_cmd_done
c_func
(paren
r_int
id|cmd_ioaddr
)paren
(brace
r_int
id|wait
op_assign
l_int|1000
suffix:semicolon
r_do
suffix:semicolon
r_while
c_loop
(paren
id|inb
c_func
(paren
id|cmd_ioaddr
)paren
op_logical_and
op_decrement
id|wait
op_ge
l_int|0
)paren
(brace
suffix:semicolon
)brace
macro_line|#ifndef final_version
r_if
c_cond
(paren
id|wait
OL
l_int|0
)paren
id|printk
c_func
(paren
id|KERN_ALERT
l_string|&quot;eepro100: wait_for_cmd_done timeout!&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
)brace
multiline_comment|/* Offsets to the various registers.&n;   All accesses need not be longword aligned. */
DECL|enum|speedo_offsets
r_enum
id|speedo_offsets
(brace
DECL|enumerator|SCBStatus
DECL|enumerator|SCBCmd
id|SCBStatus
op_assign
l_int|0
comma
id|SCBCmd
op_assign
l_int|2
comma
multiline_comment|/* Rx/Command Unit command and status. */
DECL|enumerator|SCBPointer
id|SCBPointer
op_assign
l_int|4
comma
multiline_comment|/* General purpose pointer. */
DECL|enumerator|SCBPort
id|SCBPort
op_assign
l_int|8
comma
multiline_comment|/* Misc. commands and operands.  */
DECL|enumerator|SCBflash
DECL|enumerator|SCBeeprom
id|SCBflash
op_assign
l_int|12
comma
id|SCBeeprom
op_assign
l_int|14
comma
multiline_comment|/* EEPROM and flash memory control. */
DECL|enumerator|SCBCtrlMDI
id|SCBCtrlMDI
op_assign
l_int|16
comma
multiline_comment|/* MDI interface control. */
DECL|enumerator|SCBEarlyRx
id|SCBEarlyRx
op_assign
l_int|20
comma
multiline_comment|/* Early receive byte count. */
)brace
suffix:semicolon
multiline_comment|/* Commands that can be put in a command list entry. */
DECL|enum|commands
r_enum
id|commands
(brace
DECL|enumerator|CmdNOp
DECL|enumerator|CmdIASetup
DECL|enumerator|CmdConfigure
id|CmdNOp
op_assign
l_int|0
comma
id|CmdIASetup
op_assign
l_int|0x10000
comma
id|CmdConfigure
op_assign
l_int|0x20000
comma
DECL|enumerator|CmdMulticastList
DECL|enumerator|CmdTx
DECL|enumerator|CmdTDR
id|CmdMulticastList
op_assign
l_int|0x30000
comma
id|CmdTx
op_assign
l_int|0x40000
comma
id|CmdTDR
op_assign
l_int|0x50000
comma
DECL|enumerator|CmdDump
DECL|enumerator|CmdDiagnose
id|CmdDump
op_assign
l_int|0x60000
comma
id|CmdDiagnose
op_assign
l_int|0x70000
comma
DECL|enumerator|CmdSuspend
id|CmdSuspend
op_assign
l_int|0x40000000
comma
multiline_comment|/* Suspend after completion. */
DECL|enumerator|CmdIntr
id|CmdIntr
op_assign
l_int|0x20000000
comma
multiline_comment|/* Interrupt after completion. */
DECL|enumerator|CmdTxFlex
id|CmdTxFlex
op_assign
l_int|0x00080000
comma
multiline_comment|/* Use &quot;Flexible mode&quot; for CmdTx command. */
)brace
suffix:semicolon
multiline_comment|/* Clear CmdSuspend (1&lt;&lt;30) avoiding interference with the card access to the&n;   status bits.  Previous driver versions used separate 16 bit fields for&n;   commands and statuses.  --SAW&n;   FIXME: it may not work on non-IA32 architectures.&n; */
macro_line|#if defined(__LITTLE_ENDIAN)
DECL|macro|clear_suspend
mdefine_line|#define clear_suspend(cmd)  ((__u16 *)&amp;(cmd)-&gt;cmd_status)[1] &amp;= ~0x4000
macro_line|#elif defined(__BIG_ENDIAN)
DECL|macro|clear_suspend
mdefine_line|#define clear_suspend(cmd)  ((__u16 *)&amp;(cmd)-&gt;cmd_status)[1] &amp;= ~0x0040
macro_line|#else
macro_line|#error Unsupported byteorder
macro_line|#endif
DECL|enum|SCBCmdBits
r_enum
id|SCBCmdBits
(brace
DECL|enumerator|SCBMaskCmdDone
DECL|enumerator|SCBMaskRxDone
DECL|enumerator|SCBMaskCmdIdle
id|SCBMaskCmdDone
op_assign
l_int|0x8000
comma
id|SCBMaskRxDone
op_assign
l_int|0x4000
comma
id|SCBMaskCmdIdle
op_assign
l_int|0x2000
comma
DECL|enumerator|SCBMaskRxSuspend
DECL|enumerator|SCBMaskEarlyRx
DECL|enumerator|SCBMaskFlowCtl
id|SCBMaskRxSuspend
op_assign
l_int|0x1000
comma
id|SCBMaskEarlyRx
op_assign
l_int|0x0800
comma
id|SCBMaskFlowCtl
op_assign
l_int|0x0400
comma
DECL|enumerator|SCBTriggerIntr
DECL|enumerator|SCBMaskAll
id|SCBTriggerIntr
op_assign
l_int|0x0200
comma
id|SCBMaskAll
op_assign
l_int|0x0100
comma
multiline_comment|/* The rest are Rx and Tx commands. */
DECL|enumerator|CUStart
DECL|enumerator|CUResume
DECL|enumerator|CUStatsAddr
DECL|enumerator|CUShowStats
id|CUStart
op_assign
l_int|0x0010
comma
id|CUResume
op_assign
l_int|0x0020
comma
id|CUStatsAddr
op_assign
l_int|0x0040
comma
id|CUShowStats
op_assign
l_int|0x0050
comma
DECL|enumerator|CUCmdBase
id|CUCmdBase
op_assign
l_int|0x0060
comma
multiline_comment|/* CU Base address (set to zero) . */
DECL|enumerator|CUDumpStats
id|CUDumpStats
op_assign
l_int|0x0070
comma
multiline_comment|/* Dump then reset stats counters. */
DECL|enumerator|RxStart
DECL|enumerator|RxResume
DECL|enumerator|RxAbort
DECL|enumerator|RxAddrLoad
id|RxStart
op_assign
l_int|0x0001
comma
id|RxResume
op_assign
l_int|0x0002
comma
id|RxAbort
op_assign
l_int|0x0004
comma
id|RxAddrLoad
op_assign
l_int|0x0006
comma
DECL|enumerator|RxResumeNoResources
id|RxResumeNoResources
op_assign
l_int|0x0007
comma
)brace
suffix:semicolon
DECL|enum|SCBPort_cmds
r_enum
id|SCBPort_cmds
(brace
DECL|enumerator|PortReset
DECL|enumerator|PortSelfTest
DECL|enumerator|PortPartialReset
DECL|enumerator|PortDump
id|PortReset
op_assign
l_int|0
comma
id|PortSelfTest
op_assign
l_int|1
comma
id|PortPartialReset
op_assign
l_int|2
comma
id|PortDump
op_assign
l_int|3
comma
)brace
suffix:semicolon
multiline_comment|/* The Speedo3 Rx and Tx frame/buffer descriptors. */
DECL|struct|descriptor
r_struct
id|descriptor
(brace
multiline_comment|/* A generic descriptor. */
DECL|member|cmd_status
id|s32
id|cmd_status
suffix:semicolon
multiline_comment|/* All command and status fields. */
DECL|member|link
id|u32
id|link
suffix:semicolon
multiline_comment|/* struct descriptor *  */
DECL|member|params
r_int
r_char
id|params
(braket
l_int|0
)braket
suffix:semicolon
)brace
suffix:semicolon
multiline_comment|/* The Speedo3 Rx and Tx buffer descriptors. */
DECL|struct|RxFD
r_struct
id|RxFD
(brace
multiline_comment|/* Receive frame descriptor. */
DECL|member|status
id|s32
id|status
suffix:semicolon
DECL|member|link
id|u32
id|link
suffix:semicolon
multiline_comment|/* struct RxFD * */
DECL|member|rx_buf_addr
id|u32
id|rx_buf_addr
suffix:semicolon
multiline_comment|/* void * */
DECL|member|count
id|u32
id|count
suffix:semicolon
)brace
suffix:semicolon
multiline_comment|/* Selected elements of the Tx/RxFD.status word. */
DECL|enum|RxFD_bits
r_enum
id|RxFD_bits
(brace
DECL|enumerator|RxComplete
DECL|enumerator|RxOK
id|RxComplete
op_assign
l_int|0x8000
comma
id|RxOK
op_assign
l_int|0x2000
comma
DECL|enumerator|RxErrCRC
DECL|enumerator|RxErrAlign
DECL|enumerator|RxErrTooBig
DECL|enumerator|RxErrSymbol
id|RxErrCRC
op_assign
l_int|0x0800
comma
id|RxErrAlign
op_assign
l_int|0x0400
comma
id|RxErrTooBig
op_assign
l_int|0x0200
comma
id|RxErrSymbol
op_assign
l_int|0x0010
comma
DECL|enumerator|RxEth2Type
DECL|enumerator|RxNoMatch
DECL|enumerator|RxNoIAMatch
id|RxEth2Type
op_assign
l_int|0x0020
comma
id|RxNoMatch
op_assign
l_int|0x0004
comma
id|RxNoIAMatch
op_assign
l_int|0x0002
comma
DECL|enumerator|TxUnderrun
DECL|enumerator|StatusComplete
id|TxUnderrun
op_assign
l_int|0x1000
comma
id|StatusComplete
op_assign
l_int|0x8000
comma
)brace
suffix:semicolon
DECL|macro|CONFIG_DATA_SIZE
mdefine_line|#define CONFIG_DATA_SIZE 22
DECL|struct|TxFD
r_struct
id|TxFD
(brace
multiline_comment|/* Transmit frame descriptor set. */
DECL|member|status
id|s32
id|status
suffix:semicolon
DECL|member|link
id|u32
id|link
suffix:semicolon
multiline_comment|/* void * */
DECL|member|tx_desc_addr
id|u32
id|tx_desc_addr
suffix:semicolon
multiline_comment|/* Always points to the tx_buf_addr element. */
DECL|member|count
id|s32
id|count
suffix:semicolon
multiline_comment|/* # of TBD (=1), Tx start thresh., etc. */
multiline_comment|/* This constitutes two &quot;TBD&quot; entries -- we only use one. */
DECL|macro|TX_DESCR_BUF_OFFSET
mdefine_line|#define TX_DESCR_BUF_OFFSET 16
DECL|member|tx_buf_addr0
id|u32
id|tx_buf_addr0
suffix:semicolon
multiline_comment|/* void *, frame to be transmitted.  */
DECL|member|tx_buf_size0
id|s32
id|tx_buf_size0
suffix:semicolon
multiline_comment|/* Length of Tx frame. */
DECL|member|tx_buf_addr1
id|u32
id|tx_buf_addr1
suffix:semicolon
multiline_comment|/* void *, frame to be transmitted.  */
DECL|member|tx_buf_size1
id|s32
id|tx_buf_size1
suffix:semicolon
multiline_comment|/* Length of Tx frame. */
multiline_comment|/* the structure must have space for at least CONFIG_DATA_SIZE starting&n;&t; * from tx_desc_addr field */
)brace
suffix:semicolon
multiline_comment|/* Multicast filter setting block.  --SAW */
DECL|struct|speedo_mc_block
r_struct
id|speedo_mc_block
(brace
DECL|member|next
r_struct
id|speedo_mc_block
op_star
id|next
suffix:semicolon
DECL|member|tx
r_int
r_int
id|tx
suffix:semicolon
DECL|member|frame_dma
id|dma_addr_t
id|frame_dma
suffix:semicolon
DECL|member|len
r_int
r_int
id|len
suffix:semicolon
DECL|member|frame
r_struct
id|descriptor
id|frame
id|__attribute__
(paren
(paren
id|__aligned__
c_func
(paren
l_int|16
)paren
)paren
)paren
suffix:semicolon
)brace
suffix:semicolon
multiline_comment|/* Elements of the dump_statistics block. This block must be lword aligned. */
DECL|struct|speedo_stats
r_struct
id|speedo_stats
(brace
DECL|member|tx_good_frames
id|u32
id|tx_good_frames
suffix:semicolon
DECL|member|tx_coll16_errs
id|u32
id|tx_coll16_errs
suffix:semicolon
DECL|member|tx_late_colls
id|u32
id|tx_late_colls
suffix:semicolon
DECL|member|tx_underruns
id|u32
id|tx_underruns
suffix:semicolon
DECL|member|tx_lost_carrier
id|u32
id|tx_lost_carrier
suffix:semicolon
DECL|member|tx_deferred
id|u32
id|tx_deferred
suffix:semicolon
DECL|member|tx_one_colls
id|u32
id|tx_one_colls
suffix:semicolon
DECL|member|tx_multi_colls
id|u32
id|tx_multi_colls
suffix:semicolon
DECL|member|tx_total_colls
id|u32
id|tx_total_colls
suffix:semicolon
DECL|member|rx_good_frames
id|u32
id|rx_good_frames
suffix:semicolon
DECL|member|rx_crc_errs
id|u32
id|rx_crc_errs
suffix:semicolon
DECL|member|rx_align_errs
id|u32
id|rx_align_errs
suffix:semicolon
DECL|member|rx_resource_errs
id|u32
id|rx_resource_errs
suffix:semicolon
DECL|member|rx_overrun_errs
id|u32
id|rx_overrun_errs
suffix:semicolon
DECL|member|rx_colls_errs
id|u32
id|rx_colls_errs
suffix:semicolon
DECL|member|rx_runt_errs
id|u32
id|rx_runt_errs
suffix:semicolon
DECL|member|done_marker
id|u32
id|done_marker
suffix:semicolon
)brace
suffix:semicolon
DECL|enum|Rx_ring_state_bits
r_enum
id|Rx_ring_state_bits
(brace
DECL|enumerator|RrNoMem
DECL|enumerator|RrPostponed
DECL|enumerator|RrNoResources
DECL|enumerator|RrOOMReported
id|RrNoMem
op_assign
l_int|1
comma
id|RrPostponed
op_assign
l_int|2
comma
id|RrNoResources
op_assign
l_int|4
comma
id|RrOOMReported
op_assign
l_int|8
comma
)brace
suffix:semicolon
multiline_comment|/* Do not change the position (alignment) of the first few elements!&n;   The later elements are grouped for cache locality.&n;&n;   Unfortunately, all the positions have been shifted since there.&n;   A new re-alignment is required.  2000/03/06  SAW */
DECL|struct|speedo_private
r_struct
id|speedo_private
(brace
DECL|member|tx_ring
r_struct
id|TxFD
op_star
id|tx_ring
suffix:semicolon
multiline_comment|/* Commands (usually CmdTxPacket). */
DECL|member|rx_ringp
r_struct
id|RxFD
op_star
id|rx_ringp
(braket
id|RX_RING_SIZE
)braket
suffix:semicolon
multiline_comment|/* Rx descriptor, used as ring. */
multiline_comment|/* The addresses of a Tx/Rx-in-place packets/buffers. */
DECL|member|tx_skbuff
r_struct
id|sk_buff
op_star
id|tx_skbuff
(braket
id|TX_RING_SIZE
)braket
suffix:semicolon
DECL|member|rx_skbuff
r_struct
id|sk_buff
op_star
id|rx_skbuff
(braket
id|RX_RING_SIZE
)braket
suffix:semicolon
multiline_comment|/* Mapped addresses of the rings. */
DECL|member|tx_ring_dma
id|dma_addr_t
id|tx_ring_dma
suffix:semicolon
DECL|macro|TX_RING_ELEM_DMA
mdefine_line|#define TX_RING_ELEM_DMA(sp, n) ((sp)-&gt;tx_ring_dma + (n)*sizeof(struct TxFD))
DECL|member|rx_ring_dma
id|dma_addr_t
id|rx_ring_dma
(braket
id|RX_RING_SIZE
)braket
suffix:semicolon
DECL|member|last_cmd
r_struct
id|descriptor
op_star
id|last_cmd
suffix:semicolon
multiline_comment|/* Last command sent. */
DECL|member|cur_tx
DECL|member|dirty_tx
r_int
r_int
id|cur_tx
comma
id|dirty_tx
suffix:semicolon
multiline_comment|/* The ring entries to be free()ed. */
DECL|member|lock
id|spinlock_t
id|lock
suffix:semicolon
multiline_comment|/* Group with Tx control cache line. */
DECL|member|tx_threshold
id|u32
id|tx_threshold
suffix:semicolon
multiline_comment|/* The value for txdesc.count. */
DECL|member|last_rxf
r_struct
id|RxFD
op_star
id|last_rxf
suffix:semicolon
multiline_comment|/* Last filled RX buffer. */
DECL|member|last_rxf_dma
id|dma_addr_t
id|last_rxf_dma
suffix:semicolon
DECL|member|cur_rx
DECL|member|dirty_rx
r_int
r_int
id|cur_rx
comma
id|dirty_rx
suffix:semicolon
multiline_comment|/* The next free ring entry */
DECL|member|last_rx_time
r_int
id|last_rx_time
suffix:semicolon
multiline_comment|/* Last Rx, in jiffies, to handle Rx hang. */
DECL|member|product_name
r_const
r_char
op_star
id|product_name
suffix:semicolon
DECL|member|stats
r_struct
id|net_device_stats
id|stats
suffix:semicolon
DECL|member|lstats
r_struct
id|speedo_stats
op_star
id|lstats
suffix:semicolon
DECL|member|lstats_dma
id|dma_addr_t
id|lstats_dma
suffix:semicolon
DECL|member|chip_id
r_int
id|chip_id
suffix:semicolon
DECL|member|pdev
r_struct
id|pci_dev
op_star
id|pdev
suffix:semicolon
DECL|member|timer
r_struct
id|timer_list
id|timer
suffix:semicolon
multiline_comment|/* Media selection timer. */
DECL|member|mc_setup_head
r_struct
id|speedo_mc_block
op_star
id|mc_setup_head
suffix:semicolon
multiline_comment|/* Multicast setup frame list head. */
DECL|member|mc_setup_tail
r_struct
id|speedo_mc_block
op_star
id|mc_setup_tail
suffix:semicolon
multiline_comment|/* Multicast setup frame list tail. */
DECL|member|in_interrupt
r_int
id|in_interrupt
suffix:semicolon
multiline_comment|/* Word-aligned dev-&gt;interrupt */
DECL|member|acpi_pwr
r_int
r_char
id|acpi_pwr
suffix:semicolon
DECL|member|rx_mode
r_char
id|rx_mode
suffix:semicolon
multiline_comment|/* Current PROMISC/ALLMULTI setting. */
DECL|member|tx_full
r_int
r_int
id|tx_full
suffix:colon
l_int|1
suffix:semicolon
multiline_comment|/* The Tx queue is full. */
DECL|member|full_duplex
r_int
r_int
id|full_duplex
suffix:colon
l_int|1
suffix:semicolon
multiline_comment|/* Full-duplex operation requested. */
DECL|member|flow_ctrl
r_int
r_int
id|flow_ctrl
suffix:colon
l_int|1
suffix:semicolon
multiline_comment|/* Use 802.3x flow control. */
DECL|member|rx_bug
r_int
r_int
id|rx_bug
suffix:colon
l_int|1
suffix:semicolon
multiline_comment|/* Work around receiver hang errata. */
DECL|member|default_port
r_int
r_char
id|default_port
suffix:colon
l_int|8
suffix:semicolon
multiline_comment|/* Last dev-&gt;if_port value. */
DECL|member|rx_ring_state
r_int
r_char
id|rx_ring_state
suffix:semicolon
multiline_comment|/* RX ring status flags. */
DECL|member|phy
r_int
r_int
id|phy
(braket
l_int|2
)braket
suffix:semicolon
multiline_comment|/* PHY media interfaces available. */
DECL|member|advertising
r_int
r_int
id|advertising
suffix:semicolon
multiline_comment|/* Current PHY advertised caps. */
DECL|member|partner
r_int
r_int
id|partner
suffix:semicolon
multiline_comment|/* Link partner caps. */
)brace
suffix:semicolon
multiline_comment|/* The parameters for a CmdConfigure operation.&n;   There are so many options that it would be difficult to document each bit.&n;   We mostly use the default or recommended settings. */
DECL|variable|i82557_config_cmd
r_const
r_char
id|i82557_config_cmd
(braket
id|CONFIG_DATA_SIZE
)braket
op_assign
(brace
l_int|22
comma
l_int|0x08
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0x32
comma
l_int|0x03
comma
l_int|1
comma
multiline_comment|/* 1=Use MII  0=Use AUI */
l_int|0
comma
l_int|0x2E
comma
l_int|0
comma
l_int|0x60
comma
l_int|0
comma
l_int|0xf2
comma
l_int|0x48
comma
l_int|0
comma
l_int|0x40
comma
l_int|0xf2
comma
l_int|0x80
comma
multiline_comment|/* 0x40=Force full-duplex */
l_int|0x3f
comma
l_int|0x05
comma
)brace
suffix:semicolon
DECL|variable|i82558_config_cmd
r_const
r_char
id|i82558_config_cmd
(braket
id|CONFIG_DATA_SIZE
)braket
op_assign
(brace
l_int|22
comma
l_int|0x08
comma
l_int|0
comma
l_int|1
comma
l_int|0
comma
l_int|0
comma
l_int|0x22
comma
l_int|0x03
comma
l_int|1
comma
multiline_comment|/* 1=Use MII  0=Use AUI */
l_int|0
comma
l_int|0x2E
comma
l_int|0
comma
l_int|0x60
comma
l_int|0x08
comma
l_int|0x88
comma
l_int|0x68
comma
l_int|0
comma
l_int|0x40
comma
l_int|0xf2
comma
l_int|0x84
comma
multiline_comment|/* Disable FC */
l_int|0x31
comma
l_int|0x05
comma
)brace
suffix:semicolon
multiline_comment|/* PHY media interface chips. */
DECL|variable|phys
r_static
r_const
r_char
op_star
id|phys
(braket
)braket
op_assign
(brace
l_string|&quot;None&quot;
comma
l_string|&quot;i82553-A/B&quot;
comma
l_string|&quot;i82553-C&quot;
comma
l_string|&quot;i82503&quot;
comma
l_string|&quot;DP83840&quot;
comma
l_string|&quot;80c240&quot;
comma
l_string|&quot;80c24&quot;
comma
l_string|&quot;i82555&quot;
comma
l_string|&quot;unknown-8&quot;
comma
l_string|&quot;unknown-9&quot;
comma
l_string|&quot;DP83840A&quot;
comma
l_string|&quot;unknown-11&quot;
comma
l_string|&quot;unknown-12&quot;
comma
l_string|&quot;unknown-13&quot;
comma
l_string|&quot;unknown-14&quot;
comma
l_string|&quot;unknown-15&quot;
comma
)brace
suffix:semicolon
DECL|enum|phy_chips
DECL|enumerator|NonSuchPhy
DECL|enumerator|I82553AB
DECL|enumerator|I82553C
DECL|enumerator|I82503
DECL|enumerator|DP83840
DECL|enumerator|S80C240
r_enum
id|phy_chips
(brace
id|NonSuchPhy
op_assign
l_int|0
comma
id|I82553AB
comma
id|I82553C
comma
id|I82503
comma
id|DP83840
comma
id|S80C240
comma
DECL|enumerator|S80C24
DECL|enumerator|I82555
DECL|enumerator|DP83840A
id|S80C24
comma
id|I82555
comma
id|DP83840A
op_assign
l_int|10
comma
)brace
suffix:semicolon
DECL|variable|is_mii
r_static
r_const
r_char
id|is_mii
(braket
)braket
op_assign
(brace
l_int|0
comma
l_int|1
comma
l_int|1
comma
l_int|0
comma
l_int|1
comma
l_int|1
comma
l_int|0
comma
l_int|1
)brace
suffix:semicolon
DECL|macro|EE_READ_CMD
mdefine_line|#define EE_READ_CMD&t;&t;(6)
r_static
r_int
id|eepro100_init_one
c_func
(paren
r_struct
id|pci_dev
op_star
id|pdev
comma
r_const
r_struct
id|pci_device_id
op_star
id|ent
)paren
suffix:semicolon
r_static
r_void
id|eepro100_remove_one
(paren
r_struct
id|pci_dev
op_star
id|pdev
)paren
suffix:semicolon
macro_line|#ifdef CONFIG_EEPRO100_PM
r_static
r_void
id|eepro100_suspend
(paren
r_struct
id|pci_dev
op_star
id|pdev
)paren
suffix:semicolon
r_static
r_void
id|eepro100_resume
(paren
r_struct
id|pci_dev
op_star
id|pdev
)paren
suffix:semicolon
macro_line|#endif
r_static
r_int
id|do_eeprom_cmd
c_func
(paren
r_int
id|ioaddr
comma
r_int
id|cmd
comma
r_int
id|cmd_len
)paren
suffix:semicolon
r_static
r_int
id|mdio_read
c_func
(paren
r_int
id|ioaddr
comma
r_int
id|phy_id
comma
r_int
id|location
)paren
suffix:semicolon
r_static
r_int
id|mdio_write
c_func
(paren
r_int
id|ioaddr
comma
r_int
id|phy_id
comma
r_int
id|location
comma
r_int
id|value
)paren
suffix:semicolon
r_static
r_int
id|speedo_open
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_void
id|speedo_resume
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_void
id|speedo_timer
c_func
(paren
r_int
r_int
id|data
)paren
suffix:semicolon
r_static
r_void
id|speedo_init_rx_ring
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_void
id|speedo_tx_timeout
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_int
id|speedo_start_xmit
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_void
id|speedo_refill_rx_buffers
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_int
id|force
)paren
suffix:semicolon
r_static
r_int
id|speedo_rx
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_void
id|speedo_tx_buffer_gc
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_void
id|speedo_interrupt
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_instance
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
suffix:semicolon
r_static
r_int
id|speedo_close
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_struct
id|net_device_stats
op_star
id|speedo_get_stats
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_int
id|speedo_ioctl
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_struct
id|ifreq
op_star
id|rq
comma
r_int
id|cmd
)paren
suffix:semicolon
r_static
r_void
id|set_rx_mode
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_void
id|speedo_show_state
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
"&f;"
macro_line|#ifdef honor_default_port
multiline_comment|/* Optional driver feature to allow forcing the transceiver setting.&n;   Not recommended. */
DECL|variable|mii_ctrl
r_static
r_int
id|mii_ctrl
(braket
l_int|8
)braket
op_assign
(brace
l_int|0x3300
comma
l_int|0x3100
comma
l_int|0x0000
comma
l_int|0x0100
comma
l_int|0x2000
comma
l_int|0x2100
comma
l_int|0x0400
comma
l_int|0x3100
)brace
suffix:semicolon
macro_line|#endif
DECL|function|eepro100_init_one
r_static
r_int
id|__devinit
id|eepro100_init_one
(paren
r_struct
id|pci_dev
op_star
id|pdev
comma
r_const
r_struct
id|pci_device_id
op_star
id|ent
)paren
(brace
r_int
r_int
id|ioaddr
suffix:semicolon
r_int
id|irq
suffix:semicolon
r_int
id|acpi_idle_state
op_assign
l_int|0
comma
id|pm
suffix:semicolon
r_static
r_int
id|cards_found
multiline_comment|/* = 0 */
suffix:semicolon
r_static
r_int
id|did_version
multiline_comment|/* = 0 */
suffix:semicolon
multiline_comment|/* Already printed version info. */
r_if
c_cond
(paren
id|speedo_debug
OG
l_int|0
op_logical_and
id|did_version
op_increment
op_eq
l_int|0
)paren
id|printk
c_func
(paren
id|version
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|request_region
c_func
(paren
id|pci_resource_start
c_func
(paren
id|pdev
comma
l_int|1
)paren
comma
id|pci_resource_len
c_func
(paren
id|pdev
comma
l_int|1
)paren
comma
l_string|&quot;eepro100&quot;
)paren
)paren
(brace
id|printk
(paren
id|KERN_ERR
l_string|&quot;eepro100: cannot reserve I/O ports&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|err_out_none
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|request_mem_region
c_func
(paren
id|pci_resource_start
c_func
(paren
id|pdev
comma
l_int|0
)paren
comma
id|pci_resource_len
c_func
(paren
id|pdev
comma
l_int|0
)paren
comma
l_string|&quot;eepro100&quot;
)paren
)paren
(brace
id|printk
(paren
id|KERN_ERR
l_string|&quot;eepro100: cannot reserve MMIO region&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|err_out_free_pio_region
suffix:semicolon
)brace
id|irq
op_assign
id|pdev-&gt;irq
suffix:semicolon
macro_line|#ifdef USE_IO
id|ioaddr
op_assign
id|pci_resource_start
c_func
(paren
id|pdev
comma
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|speedo_debug
OG
l_int|2
)paren
id|printk
c_func
(paren
l_string|&quot;Found Intel i82557 PCI Speedo at I/O %#lx, IRQ %d.&bslash;n&quot;
comma
id|ioaddr
comma
id|irq
)paren
suffix:semicolon
macro_line|#else
id|ioaddr
op_assign
(paren
r_int
r_int
)paren
id|ioremap
c_func
(paren
id|pci_resource_start
c_func
(paren
id|pdev
comma
l_int|0
)paren
comma
id|pci_resource_len
c_func
(paren
id|pdev
comma
l_int|0
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ioaddr
)paren
(brace
id|printk
(paren
id|KERN_ERR
l_string|&quot;eepro100: cannot remap MMIO region %lx @ %lx&bslash;n&quot;
comma
id|pci_resource_len
c_func
(paren
id|pdev
comma
l_int|0
)paren
comma
id|pci_resource_start
c_func
(paren
id|pdev
comma
l_int|0
)paren
)paren
suffix:semicolon
r_goto
id|err_out_free_mmio_region
suffix:semicolon
)brace
r_if
c_cond
(paren
id|speedo_debug
OG
l_int|2
)paren
id|printk
c_func
(paren
l_string|&quot;Found Intel i82557 PCI Speedo, MMIO at %#lx, IRQ %d.&bslash;n&quot;
comma
id|pci_resource_start
c_func
(paren
id|pdev
comma
l_int|0
)paren
comma
id|irq
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/* save power state b4 pci_enable_device overwrites it */
id|pm
op_assign
id|pci_find_capability
c_func
(paren
id|pdev
comma
id|PCI_CAP_ID_PM
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pm
)paren
(brace
id|u16
id|pwr_command
suffix:semicolon
id|pci_read_config_word
c_func
(paren
id|pdev
comma
id|pm
op_plus
id|PCI_PM_CTRL
comma
op_amp
id|pwr_command
)paren
suffix:semicolon
id|acpi_idle_state
op_assign
id|pwr_command
op_amp
id|PCI_PM_CTRL_STATE_MASK
suffix:semicolon
)brace
r_if
c_cond
(paren
id|pci_enable_device
c_func
(paren
id|pdev
)paren
)paren
r_goto
id|err_out_free_mmio_region
suffix:semicolon
id|pci_set_master
c_func
(paren
id|pdev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|speedo_found1
c_func
(paren
id|pdev
comma
id|ioaddr
comma
id|cards_found
comma
id|acpi_idle_state
)paren
op_eq
l_int|0
)paren
id|cards_found
op_increment
suffix:semicolon
r_else
r_goto
id|err_out_iounmap
suffix:semicolon
r_return
l_int|0
suffix:semicolon
id|err_out_iounmap
suffix:colon
suffix:semicolon
macro_line|#ifndef USE_IO
id|iounmap
(paren
(paren
r_void
op_star
)paren
id|ioaddr
)paren
suffix:semicolon
macro_line|#endif
id|err_out_free_mmio_region
suffix:colon
id|release_mem_region
c_func
(paren
id|pci_resource_start
c_func
(paren
id|pdev
comma
l_int|0
)paren
comma
id|pci_resource_len
c_func
(paren
id|pdev
comma
l_int|0
)paren
)paren
suffix:semicolon
id|err_out_free_pio_region
suffix:colon
id|release_region
c_func
(paren
id|pci_resource_start
c_func
(paren
id|pdev
comma
l_int|1
)paren
comma
id|pci_resource_len
c_func
(paren
id|pdev
comma
l_int|1
)paren
)paren
suffix:semicolon
id|err_out_none
suffix:colon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
DECL|function|speedo_found1
r_static
r_int
id|speedo_found1
c_func
(paren
r_struct
id|pci_dev
op_star
id|pdev
comma
r_int
id|ioaddr
comma
r_int
id|card_idx
comma
r_int
id|acpi_idle_state
)paren
(brace
r_struct
id|net_device
op_star
id|dev
suffix:semicolon
r_struct
id|speedo_private
op_star
id|sp
suffix:semicolon
r_const
r_char
op_star
id|product
suffix:semicolon
r_int
id|i
comma
id|option
suffix:semicolon
id|u16
id|eeprom
(braket
l_int|0x100
)braket
suffix:semicolon
r_int
id|size
suffix:semicolon
r_void
op_star
id|tx_ring_space
suffix:semicolon
id|dma_addr_t
id|tx_ring_dma
suffix:semicolon
id|size
op_assign
id|TX_RING_SIZE
op_star
r_sizeof
(paren
r_struct
id|TxFD
)paren
op_plus
r_sizeof
(paren
r_struct
id|speedo_stats
)paren
suffix:semicolon
id|tx_ring_space
op_assign
id|pci_alloc_consistent
c_func
(paren
id|pdev
comma
id|size
comma
op_amp
id|tx_ring_dma
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tx_ring_space
op_eq
l_int|NULL
)paren
r_return
op_minus
l_int|1
suffix:semicolon
id|dev
op_assign
id|init_etherdev
c_func
(paren
l_int|NULL
comma
r_sizeof
(paren
r_struct
id|speedo_private
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dev
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;eepro100: Could not allocate ethernet device.&bslash;n&quot;
)paren
suffix:semicolon
id|pci_free_consistent
c_func
(paren
id|pdev
comma
id|size
comma
id|tx_ring_space
comma
id|tx_ring_dma
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|dev-&gt;mem_start
OG
l_int|0
)paren
id|option
op_assign
id|dev-&gt;mem_start
suffix:semicolon
r_else
r_if
c_cond
(paren
id|card_idx
op_ge
l_int|0
op_logical_and
id|options
(braket
id|card_idx
)braket
op_ge
l_int|0
)paren
id|option
op_assign
id|options
(braket
id|card_idx
)braket
suffix:semicolon
r_else
id|option
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Read the station address EEPROM before doing the reset.&n;&t;   Nominally his should even be done before accepting the device, but&n;&t;   then we wouldn&squot;t have a device name with which to report the error.&n;&t;   The size test is for 6 bit vs. 8 bit address serial EEPROMs.&n;&t;*/
(brace
r_int
r_int
id|iobase
suffix:semicolon
r_int
id|read_cmd
comma
id|ee_size
suffix:semicolon
id|u16
id|sum
suffix:semicolon
r_int
id|j
suffix:semicolon
multiline_comment|/* Use IO only to avoid postponed writes and satisfy EEPROM timing&n;&t;&t;   requirements. */
id|iobase
op_assign
id|pci_resource_start
c_func
(paren
id|pdev
comma
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|do_eeprom_cmd
c_func
(paren
id|iobase
comma
id|EE_READ_CMD
op_lshift
l_int|24
comma
l_int|27
)paren
op_amp
l_int|0xffe0000
)paren
op_eq
l_int|0xffe0000
)paren
(brace
id|ee_size
op_assign
l_int|0x100
suffix:semicolon
id|read_cmd
op_assign
id|EE_READ_CMD
op_lshift
l_int|24
suffix:semicolon
)brace
r_else
(brace
id|ee_size
op_assign
l_int|0x40
suffix:semicolon
id|read_cmd
op_assign
id|EE_READ_CMD
op_lshift
l_int|22
suffix:semicolon
)brace
r_for
c_loop
(paren
id|j
op_assign
l_int|0
comma
id|i
op_assign
l_int|0
comma
id|sum
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|ee_size
suffix:semicolon
id|i
op_increment
)paren
(brace
id|u16
id|value
op_assign
id|do_eeprom_cmd
c_func
(paren
id|iobase
comma
id|read_cmd
op_or
(paren
id|i
op_lshift
l_int|16
)paren
comma
l_int|27
)paren
suffix:semicolon
id|eeprom
(braket
id|i
)braket
op_assign
id|value
suffix:semicolon
id|sum
op_add_assign
id|value
suffix:semicolon
r_if
c_cond
(paren
id|i
OL
l_int|3
)paren
(brace
id|dev-&gt;dev_addr
(braket
id|j
op_increment
)braket
op_assign
id|value
suffix:semicolon
id|dev-&gt;dev_addr
(braket
id|j
op_increment
)braket
op_assign
id|value
op_rshift
l_int|8
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|sum
op_ne
l_int|0xBABA
)paren
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: Invalid EEPROM checksum %#4.4x, &quot;
l_string|&quot;check settings before activating this device!&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|sum
)paren
suffix:semicolon
multiline_comment|/* Don&squot;t  unregister_netdev(dev);  as the EEPro may actually be&n;&t;&t;   usable, especially if the MAC address is set later.&n;&t;&t;   On the other hand, it may be unusable if MDI data is corrupted. */
)brace
multiline_comment|/* Reset the chip: stop Tx and Rx processes and clear counters.&n;&t;   This takes less than 10usec and will easily finish before the next&n;&t;   action. */
id|outl
c_func
(paren
id|PortReset
comma
id|ioaddr
op_plus
id|SCBPort
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|10
)paren
suffix:semicolon
r_if
c_cond
(paren
id|eeprom
(braket
l_int|3
)braket
op_amp
l_int|0x0100
)paren
id|product
op_assign
l_string|&quot;OEM i82557/i82558 10/100 Ethernet&quot;
suffix:semicolon
r_else
id|product
op_assign
id|pdev-&gt;name
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: %s, &quot;
comma
id|dev-&gt;name
comma
id|product
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|5
suffix:semicolon
id|i
op_increment
)paren
id|printk
c_func
(paren
l_string|&quot;%2.2X:&quot;
comma
id|dev-&gt;dev_addr
(braket
id|i
)braket
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;%2.2X, &quot;
comma
id|dev-&gt;dev_addr
(braket
id|i
)braket
)paren
suffix:semicolon
macro_line|#ifdef USE_IO
id|printk
c_func
(paren
l_string|&quot;I/O at %#3lx, &quot;
comma
id|ioaddr
)paren
suffix:semicolon
macro_line|#endif
id|printk
c_func
(paren
l_string|&quot;IRQ %d.&bslash;n&quot;
comma
id|pdev-&gt;irq
)paren
suffix:semicolon
macro_line|#if 1 || defined(kernel_bloat)
multiline_comment|/* OK, this is pure kernel bloat.  I don&squot;t like it when other drivers&n;&t;   waste non-pageable kernel space to emit similar messages, but I need&n;&t;   them for bug reports. */
(brace
r_const
r_char
op_star
id|connectors
(braket
)braket
op_assign
(brace
l_string|&quot; RJ45&quot;
comma
l_string|&quot; BNC&quot;
comma
l_string|&quot; AUI&quot;
comma
l_string|&quot; MII&quot;
)brace
suffix:semicolon
multiline_comment|/* The self-test results must be paragraph aligned. */
r_volatile
id|s32
op_star
id|self_test_results
suffix:semicolon
r_int
id|boguscnt
op_assign
l_int|16000
suffix:semicolon
multiline_comment|/* Timeout for set-test. */
r_if
c_cond
(paren
id|eeprom
(braket
l_int|3
)braket
op_amp
l_int|0x03
)paren
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;  Receiver lock-up bug exists -- enabling&quot;
l_string|&quot; work-around.&bslash;n&quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;  Board assembly %4.4x%2.2x-%3.3d, Physical&quot;
l_string|&quot; connectors present:&quot;
comma
id|eeprom
(braket
l_int|8
)braket
comma
id|eeprom
(braket
l_int|9
)braket
op_rshift
l_int|8
comma
id|eeprom
(braket
l_int|9
)braket
op_amp
l_int|0xff
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|4
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
id|eeprom
(braket
l_int|5
)braket
op_amp
(paren
l_int|1
op_lshift
id|i
)paren
)paren
id|printk
c_func
(paren
id|connectors
(braket
id|i
)braket
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;&bslash;n&quot;
id|KERN_INFO
l_string|&quot;  Primary interface chip %s PHY #%d.&bslash;n&quot;
comma
id|phys
(braket
(paren
id|eeprom
(braket
l_int|6
)braket
op_rshift
l_int|8
)paren
op_amp
l_int|15
)braket
comma
id|eeprom
(braket
l_int|6
)braket
op_amp
l_int|0x1f
)paren
suffix:semicolon
r_if
c_cond
(paren
id|eeprom
(braket
l_int|7
)braket
op_amp
l_int|0x0700
)paren
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;    Secondary interface chip %s.&bslash;n&quot;
comma
id|phys
(braket
(paren
id|eeprom
(braket
l_int|7
)braket
op_rshift
l_int|8
)paren
op_amp
l_int|7
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
(paren
id|eeprom
(braket
l_int|6
)braket
op_rshift
l_int|8
)paren
op_amp
l_int|0x3f
)paren
op_eq
id|DP83840
op_logical_or
(paren
(paren
id|eeprom
(braket
l_int|6
)braket
op_rshift
l_int|8
)paren
op_amp
l_int|0x3f
)paren
op_eq
id|DP83840A
)paren
(brace
r_int
id|mdi_reg23
op_assign
id|mdio_read
c_func
(paren
id|ioaddr
comma
id|eeprom
(braket
l_int|6
)braket
op_amp
l_int|0x1f
comma
l_int|23
)paren
op_or
l_int|0x0422
suffix:semicolon
r_if
c_cond
(paren
id|congenb
)paren
id|mdi_reg23
op_or_assign
l_int|0x0100
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;  DP83840 specific setup, setting register 23 to %4.4x.&bslash;n&quot;
comma
id|mdi_reg23
)paren
suffix:semicolon
id|mdio_write
c_func
(paren
id|ioaddr
comma
id|eeprom
(braket
l_int|6
)braket
op_amp
l_int|0x1f
comma
l_int|23
comma
id|mdi_reg23
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|option
op_ge
l_int|0
)paren
op_logical_and
(paren
id|option
op_amp
l_int|0x70
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;  Forcing %dMbs %s-duplex operation.&bslash;n&quot;
comma
(paren
id|option
op_amp
l_int|0x20
ques
c_cond
l_int|100
suffix:colon
l_int|10
)paren
comma
(paren
id|option
op_amp
l_int|0x10
ques
c_cond
l_string|&quot;full&quot;
suffix:colon
l_string|&quot;half&quot;
)paren
)paren
suffix:semicolon
id|mdio_write
c_func
(paren
id|ioaddr
comma
id|eeprom
(braket
l_int|6
)braket
op_amp
l_int|0x1f
comma
l_int|0
comma
(paren
(paren
id|option
op_amp
l_int|0x20
)paren
ques
c_cond
l_int|0x2000
suffix:colon
l_int|0
)paren
op_or
multiline_comment|/* 100mbps? */
(paren
(paren
id|option
op_amp
l_int|0x10
)paren
ques
c_cond
l_int|0x0100
suffix:colon
l_int|0
)paren
)paren
suffix:semicolon
multiline_comment|/* Full duplex? */
)brace
multiline_comment|/* Perform a system self-test. */
id|self_test_results
op_assign
(paren
id|s32
op_star
)paren
(paren
(paren
(paren
(paren
r_int
)paren
id|tx_ring_space
)paren
op_plus
l_int|15
)paren
op_amp
op_complement
l_int|0xf
)paren
suffix:semicolon
id|self_test_results
(braket
l_int|0
)braket
op_assign
l_int|0
suffix:semicolon
id|self_test_results
(braket
l_int|1
)braket
op_assign
op_minus
l_int|1
suffix:semicolon
id|outl
c_func
(paren
id|tx_ring_dma
op_or
id|PortSelfTest
comma
id|ioaddr
op_plus
id|SCBPort
)paren
suffix:semicolon
r_do
(brace
id|udelay
c_func
(paren
l_int|10
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
id|self_test_results
(braket
l_int|1
)braket
op_eq
op_minus
l_int|1
op_logical_and
op_decrement
id|boguscnt
op_ge
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|boguscnt
OL
l_int|0
)paren
(brace
multiline_comment|/* Test optimized out. */
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;Self test failed, status %8.8x:&bslash;n&quot;
id|KERN_ERR
l_string|&quot; Failure to initialize the i82557.&bslash;n&quot;
id|KERN_ERR
l_string|&quot; Verify that the card is a bus-master&quot;
l_string|&quot; capable slot.&bslash;n&quot;
comma
id|self_test_results
(braket
l_int|1
)braket
)paren
suffix:semicolon
)brace
r_else
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;  General self-test: %s.&bslash;n&quot;
id|KERN_INFO
l_string|&quot;  Serial sub-system self-test: %s.&bslash;n&quot;
id|KERN_INFO
l_string|&quot;  Internal registers self-test: %s.&bslash;n&quot;
id|KERN_INFO
l_string|&quot;  ROM checksum self-test: %s (%#8.8x).&bslash;n&quot;
comma
id|self_test_results
(braket
l_int|1
)braket
op_amp
l_int|0x1000
ques
c_cond
l_string|&quot;failed&quot;
suffix:colon
l_string|&quot;passed&quot;
comma
id|self_test_results
(braket
l_int|1
)braket
op_amp
l_int|0x0020
ques
c_cond
l_string|&quot;failed&quot;
suffix:colon
l_string|&quot;passed&quot;
comma
id|self_test_results
(braket
l_int|1
)braket
op_amp
l_int|0x0008
ques
c_cond
l_string|&quot;failed&quot;
suffix:colon
l_string|&quot;passed&quot;
comma
id|self_test_results
(braket
l_int|1
)braket
op_amp
l_int|0x0004
ques
c_cond
l_string|&quot;failed&quot;
suffix:colon
l_string|&quot;passed&quot;
comma
id|self_test_results
(braket
l_int|0
)braket
)paren
suffix:semicolon
)brace
macro_line|#endif  /* kernel_bloat */
id|outl
c_func
(paren
id|PortReset
comma
id|ioaddr
op_plus
id|SCBPort
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|10
)paren
suffix:semicolon
multiline_comment|/* Return the chip to its original power state. */
id|pci_set_power_state
c_func
(paren
id|pdev
comma
id|acpi_idle_state
)paren
suffix:semicolon
id|pdev-&gt;driver_data
op_assign
id|dev
suffix:semicolon
id|dev-&gt;base_addr
op_assign
id|ioaddr
suffix:semicolon
id|dev-&gt;irq
op_assign
id|pdev-&gt;irq
suffix:semicolon
id|sp
op_assign
id|dev-&gt;priv
suffix:semicolon
id|sp-&gt;pdev
op_assign
id|pdev
suffix:semicolon
id|sp-&gt;acpi_pwr
op_assign
id|acpi_idle_state
suffix:semicolon
id|sp-&gt;tx_ring
op_assign
id|tx_ring_space
suffix:semicolon
id|sp-&gt;tx_ring_dma
op_assign
id|tx_ring_dma
suffix:semicolon
id|sp-&gt;lstats
op_assign
(paren
r_struct
id|speedo_stats
op_star
)paren
(paren
id|sp-&gt;tx_ring
op_plus
id|TX_RING_SIZE
)paren
suffix:semicolon
id|sp-&gt;lstats_dma
op_assign
id|cpu_to_le32
c_func
(paren
id|TX_RING_ELEM_DMA
c_func
(paren
id|sp
comma
id|TX_RING_SIZE
)paren
)paren
suffix:semicolon
id|init_timer
c_func
(paren
op_amp
id|sp-&gt;timer
)paren
suffix:semicolon
multiline_comment|/* used in ioctl() */
id|sp-&gt;full_duplex
op_assign
id|option
op_ge
l_int|0
op_logical_and
(paren
id|option
op_amp
l_int|0x10
)paren
ques
c_cond
l_int|1
suffix:colon
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|card_idx
op_ge
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|full_duplex
(braket
id|card_idx
)braket
op_ge
l_int|0
)paren
id|sp-&gt;full_duplex
op_assign
id|full_duplex
(braket
id|card_idx
)braket
suffix:semicolon
)brace
id|sp-&gt;default_port
op_assign
id|option
op_ge
l_int|0
ques
c_cond
(paren
id|option
op_amp
l_int|0x0f
)paren
suffix:colon
l_int|0
suffix:semicolon
id|sp-&gt;phy
(braket
l_int|0
)braket
op_assign
id|eeprom
(braket
l_int|6
)braket
suffix:semicolon
id|sp-&gt;phy
(braket
l_int|1
)braket
op_assign
id|eeprom
(braket
l_int|7
)braket
suffix:semicolon
id|sp-&gt;rx_bug
op_assign
(paren
id|eeprom
(braket
l_int|3
)braket
op_amp
l_int|0x03
)paren
op_eq
l_int|3
ques
c_cond
l_int|0
suffix:colon
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|sp-&gt;rx_bug
)paren
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;  Receiver lock-up workaround activated.&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* The Speedo-specific entries in the device structure. */
id|dev-&gt;open
op_assign
op_amp
id|speedo_open
suffix:semicolon
id|dev-&gt;hard_start_xmit
op_assign
op_amp
id|speedo_start_xmit
suffix:semicolon
id|netif_set_tx_timeout
c_func
(paren
id|dev
comma
op_amp
id|speedo_tx_timeout
comma
id|TX_TIMEOUT
)paren
suffix:semicolon
id|dev-&gt;stop
op_assign
op_amp
id|speedo_close
suffix:semicolon
id|dev-&gt;get_stats
op_assign
op_amp
id|speedo_get_stats
suffix:semicolon
id|dev-&gt;set_multicast_list
op_assign
op_amp
id|set_rx_mode
suffix:semicolon
id|dev-&gt;do_ioctl
op_assign
op_amp
id|speedo_ioctl
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
"&f;"
multiline_comment|/* Serial EEPROM section.&n;   A &quot;bit&quot; grungy, but we work our way through bit-by-bit :-&gt;. */
multiline_comment|/*  EEPROM_Ctrl bits. */
DECL|macro|EE_SHIFT_CLK
mdefine_line|#define EE_SHIFT_CLK&t;0x01&t;/* EEPROM shift clock. */
DECL|macro|EE_CS
mdefine_line|#define EE_CS&t;&t;&t;0x02&t;/* EEPROM chip select. */
DECL|macro|EE_DATA_WRITE
mdefine_line|#define EE_DATA_WRITE&t;0x04&t;/* EEPROM chip data in. */
DECL|macro|EE_DATA_READ
mdefine_line|#define EE_DATA_READ&t;0x08&t;/* EEPROM chip data out. */
DECL|macro|EE_ENB
mdefine_line|#define EE_ENB&t;&t;&t;(0x4800 | EE_CS)
DECL|macro|EE_WRITE_0
mdefine_line|#define EE_WRITE_0&t;&t;0x4802
DECL|macro|EE_WRITE_1
mdefine_line|#define EE_WRITE_1&t;&t;0x4806
DECL|macro|EE_OFFSET
mdefine_line|#define EE_OFFSET&t;&t;SCBeeprom
multiline_comment|/* The fixes for the code were kindly provided by Dragan Stancevic&n;   &lt;visitor@valinux.com&gt; to strictly follow Intel specifications of EEPROM&n;   access timing.&n;   The publicly available sheet 64486302 (sec. 3.1) specifies 1us access&n;   interval for serial EEPROM.  However, it looks like that there is an&n;   additional requirement dictating larger udelay&squot;s in the code below.&n;   2000/05/24  SAW */
DECL|function|do_eeprom_cmd
r_static
r_int
id|do_eeprom_cmd
c_func
(paren
r_int
id|ioaddr
comma
r_int
id|cmd
comma
r_int
id|cmd_len
)paren
(brace
r_int
id|retval
op_assign
l_int|0
suffix:semicolon
r_int
id|ee_addr
op_assign
id|ioaddr
op_plus
id|SCBeeprom
suffix:semicolon
id|io_outw
c_func
(paren
id|EE_ENB
comma
id|ee_addr
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|2
)paren
suffix:semicolon
id|io_outw
c_func
(paren
id|EE_ENB
op_or
id|EE_SHIFT_CLK
comma
id|ee_addr
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|2
)paren
suffix:semicolon
multiline_comment|/* Shift the command bits out. */
r_do
(brace
r_int
id|dataval
op_assign
(paren
id|cmd
op_amp
(paren
l_int|1
op_lshift
id|cmd_len
)paren
)paren
ques
c_cond
id|EE_WRITE_1
suffix:colon
id|EE_WRITE_0
suffix:semicolon
id|io_outw
c_func
(paren
id|dataval
comma
id|ee_addr
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|2
)paren
suffix:semicolon
id|io_outw
c_func
(paren
id|dataval
op_or
id|EE_SHIFT_CLK
comma
id|ee_addr
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|2
)paren
suffix:semicolon
id|retval
op_assign
(paren
id|retval
op_lshift
l_int|1
)paren
op_or
(paren
(paren
id|io_inw
c_func
(paren
id|ee_addr
)paren
op_amp
id|EE_DATA_READ
)paren
ques
c_cond
l_int|1
suffix:colon
l_int|0
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
op_decrement
id|cmd_len
op_ge
l_int|0
)paren
suffix:semicolon
id|io_outw
c_func
(paren
id|EE_ENB
comma
id|ee_addr
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|2
)paren
suffix:semicolon
multiline_comment|/* Terminate the EEPROM access. */
id|io_outw
c_func
(paren
id|EE_ENB
op_amp
op_complement
id|EE_CS
comma
id|ee_addr
)paren
suffix:semicolon
r_return
id|retval
suffix:semicolon
)brace
DECL|function|mdio_read
r_static
r_int
id|mdio_read
c_func
(paren
r_int
id|ioaddr
comma
r_int
id|phy_id
comma
r_int
id|location
)paren
(brace
r_int
id|val
comma
id|boguscnt
op_assign
l_int|64
op_star
l_int|10
suffix:semicolon
multiline_comment|/* &lt;64 usec. to complete, typ 27 ticks */
id|outl
c_func
(paren
l_int|0x08000000
op_or
(paren
id|location
op_lshift
l_int|16
)paren
op_or
(paren
id|phy_id
op_lshift
l_int|21
)paren
comma
id|ioaddr
op_plus
id|SCBCtrlMDI
)paren
suffix:semicolon
r_do
(brace
id|val
op_assign
id|inl
c_func
(paren
id|ioaddr
op_plus
id|SCBCtrlMDI
)paren
suffix:semicolon
r_if
c_cond
(paren
op_decrement
id|boguscnt
OL
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot; mdio_read() timed out with val = %8.8x.&bslash;n&quot;
comma
id|val
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
r_while
c_loop
(paren
op_logical_neg
(paren
id|val
op_amp
l_int|0x10000000
)paren
)paren
suffix:semicolon
r_return
id|val
op_amp
l_int|0xffff
suffix:semicolon
)brace
DECL|function|mdio_write
r_static
r_int
id|mdio_write
c_func
(paren
r_int
id|ioaddr
comma
r_int
id|phy_id
comma
r_int
id|location
comma
r_int
id|value
)paren
(brace
r_int
id|val
comma
id|boguscnt
op_assign
l_int|64
op_star
l_int|10
suffix:semicolon
multiline_comment|/* &lt;64 usec. to complete, typ 27 ticks */
id|outl
c_func
(paren
l_int|0x04000000
op_or
(paren
id|location
op_lshift
l_int|16
)paren
op_or
(paren
id|phy_id
op_lshift
l_int|21
)paren
op_or
id|value
comma
id|ioaddr
op_plus
id|SCBCtrlMDI
)paren
suffix:semicolon
r_do
(brace
id|val
op_assign
id|inl
c_func
(paren
id|ioaddr
op_plus
id|SCBCtrlMDI
)paren
suffix:semicolon
r_if
c_cond
(paren
op_decrement
id|boguscnt
OL
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot; mdio_write() timed out with val = %8.8x.&bslash;n&quot;
comma
id|val
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
r_while
c_loop
(paren
op_logical_neg
(paren
id|val
op_amp
l_int|0x10000000
)paren
)paren
suffix:semicolon
r_return
id|val
op_amp
l_int|0xffff
suffix:semicolon
)brace
"&f;"
r_static
r_int
DECL|function|speedo_open
id|speedo_open
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|speedo_private
op_star
id|sp
op_assign
(paren
r_struct
id|speedo_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_int
id|ioaddr
op_assign
id|dev-&gt;base_addr
suffix:semicolon
r_int
id|retval
suffix:semicolon
r_if
c_cond
(paren
id|speedo_debug
OG
l_int|1
)paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%s: speedo_open() irq %d.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|dev-&gt;irq
)paren
suffix:semicolon
id|MOD_INC_USE_COUNT
suffix:semicolon
id|pci_set_power_state
c_func
(paren
id|sp-&gt;pdev
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* Set up the Tx queue early.. */
id|sp-&gt;cur_tx
op_assign
l_int|0
suffix:semicolon
id|sp-&gt;dirty_tx
op_assign
l_int|0
suffix:semicolon
id|sp-&gt;last_cmd
op_assign
l_int|0
suffix:semicolon
id|sp-&gt;tx_full
op_assign
l_int|0
suffix:semicolon
id|spin_lock_init
c_func
(paren
op_amp
id|sp-&gt;lock
)paren
suffix:semicolon
id|sp-&gt;in_interrupt
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* .. we can safely take handler calls during init. */
id|retval
op_assign
id|request_irq
c_func
(paren
id|dev-&gt;irq
comma
op_amp
id|speedo_interrupt
comma
id|SA_SHIRQ
comma
id|dev-&gt;name
comma
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|retval
)paren
(brace
id|MOD_DEC_USE_COUNT
suffix:semicolon
r_return
id|retval
suffix:semicolon
)brace
id|dev-&gt;if_port
op_assign
id|sp-&gt;default_port
suffix:semicolon
macro_line|#ifdef oh_no_you_dont_unless_you_honour_the_options_passed_in_to_us
multiline_comment|/* Retrigger negotiation to reset previous errors. */
r_if
c_cond
(paren
(paren
id|sp-&gt;phy
(braket
l_int|0
)braket
op_amp
l_int|0x8000
)paren
op_eq
l_int|0
)paren
(brace
r_int
id|phy_addr
op_assign
id|sp-&gt;phy
(braket
l_int|0
)braket
op_amp
l_int|0x1f
suffix:semicolon
multiline_comment|/* Use 0x3300 for restarting NWay, other values to force xcvr:&n;&t;&t;   0x0000 10-HD&n;&t;&t;   0x0100 10-FD&n;&t;&t;   0x2000 100-HD&n;&t;&t;   0x2100 100-FD&n;&t;&t;*/
macro_line|#ifdef honor_default_port
id|mdio_write
c_func
(paren
id|ioaddr
comma
id|phy_addr
comma
l_int|0
comma
id|mii_ctrl
(braket
id|dev-&gt;default_port
op_amp
l_int|7
)braket
)paren
suffix:semicolon
macro_line|#else
id|mdio_write
c_func
(paren
id|ioaddr
comma
id|phy_addr
comma
l_int|0
comma
l_int|0x3300
)paren
suffix:semicolon
macro_line|#endif
)brace
macro_line|#endif
id|speedo_init_rx_ring
c_func
(paren
id|dev
)paren
suffix:semicolon
multiline_comment|/* Fire up the hardware. */
id|outw
c_func
(paren
id|SCBMaskAll
comma
id|ioaddr
op_plus
id|SCBCmd
)paren
suffix:semicolon
id|speedo_resume
c_func
(paren
id|dev
)paren
suffix:semicolon
id|netdevice_start
c_func
(paren
id|dev
)paren
suffix:semicolon
id|netif_start_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
multiline_comment|/* Setup the chip and configure the multicast list. */
id|sp-&gt;mc_setup_head
op_assign
l_int|NULL
suffix:semicolon
id|sp-&gt;mc_setup_tail
op_assign
l_int|NULL
suffix:semicolon
id|sp-&gt;flow_ctrl
op_assign
id|sp-&gt;partner
op_assign
l_int|0
suffix:semicolon
id|sp-&gt;rx_mode
op_assign
op_minus
l_int|1
suffix:semicolon
multiline_comment|/* Invalid -&gt; always reset the mode. */
id|set_rx_mode
c_func
(paren
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|sp-&gt;phy
(braket
l_int|0
)braket
op_amp
l_int|0x8000
)paren
op_eq
l_int|0
)paren
id|sp-&gt;advertising
op_assign
id|mdio_read
c_func
(paren
id|ioaddr
comma
id|sp-&gt;phy
(braket
l_int|0
)braket
op_amp
l_int|0x1f
comma
l_int|4
)paren
suffix:semicolon
r_if
c_cond
(paren
id|speedo_debug
OG
l_int|2
)paren
(brace
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%s: Done speedo_open(), status %8.8x.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|inw
c_func
(paren
id|ioaddr
op_plus
id|SCBStatus
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/* Set the timer.  The timer serves a dual purpose:&n;&t;   1) to monitor the media interface (e.g. link beat) and perhaps switch&n;&t;   to an alternate media type&n;&t;   2) to monitor Rx activity, and restart the Rx process if the receiver&n;&t;   hangs. */
id|sp-&gt;timer.expires
op_assign
id|RUN_AT
c_func
(paren
(paren
l_int|24
op_star
id|HZ
)paren
op_div
l_int|10
)paren
suffix:semicolon
multiline_comment|/* 2.4 sec. */
id|sp-&gt;timer.data
op_assign
(paren
r_int
r_int
)paren
id|dev
suffix:semicolon
id|sp-&gt;timer.function
op_assign
op_amp
id|speedo_timer
suffix:semicolon
multiline_comment|/* timer handler */
id|add_timer
c_func
(paren
op_amp
id|sp-&gt;timer
)paren
suffix:semicolon
multiline_comment|/* No need to wait for the command unit to accept here. */
r_if
c_cond
(paren
(paren
id|sp-&gt;phy
(braket
l_int|0
)braket
op_amp
l_int|0x8000
)paren
op_eq
l_int|0
)paren
id|mdio_read
c_func
(paren
id|ioaddr
comma
id|sp-&gt;phy
(braket
l_int|0
)braket
op_amp
l_int|0x1f
comma
l_int|0
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Start the chip hardware after a full reset. */
DECL|function|speedo_resume
r_static
r_void
id|speedo_resume
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|speedo_private
op_star
id|sp
op_assign
(paren
r_struct
id|speedo_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_int
id|ioaddr
op_assign
id|dev-&gt;base_addr
suffix:semicolon
multiline_comment|/* Start with a Tx threshold of 256 (0x..20.... 8 byte units). */
id|sp-&gt;tx_threshold
op_assign
l_int|0x01208000
suffix:semicolon
multiline_comment|/* Set the segment registers to &squot;0&squot;. */
id|wait_for_cmd_done
c_func
(paren
id|ioaddr
op_plus
id|SCBCmd
)paren
suffix:semicolon
id|outl
c_func
(paren
l_int|0
comma
id|ioaddr
op_plus
id|SCBPointer
)paren
suffix:semicolon
id|inl
c_func
(paren
id|ioaddr
op_plus
id|SCBPointer
)paren
suffix:semicolon
multiline_comment|/* XXX */
id|outb
c_func
(paren
id|RxAddrLoad
comma
id|ioaddr
op_plus
id|SCBCmd
)paren
suffix:semicolon
id|wait_for_cmd_done
c_func
(paren
id|ioaddr
op_plus
id|SCBCmd
)paren
suffix:semicolon
id|outb
c_func
(paren
id|CUCmdBase
comma
id|ioaddr
op_plus
id|SCBCmd
)paren
suffix:semicolon
multiline_comment|/* Load the statistics block and rx ring addresses. */
id|wait_for_cmd_done
c_func
(paren
id|ioaddr
op_plus
id|SCBCmd
)paren
suffix:semicolon
id|outl
c_func
(paren
id|sp-&gt;lstats_dma
comma
id|ioaddr
op_plus
id|SCBPointer
)paren
suffix:semicolon
id|inl
c_func
(paren
id|ioaddr
op_plus
id|SCBPointer
)paren
suffix:semicolon
multiline_comment|/* XXX */
id|outb
c_func
(paren
id|CUStatsAddr
comma
id|ioaddr
op_plus
id|SCBCmd
)paren
suffix:semicolon
id|sp-&gt;lstats-&gt;done_marker
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|sp-&gt;rx_ringp
(braket
id|sp-&gt;cur_rx
op_mod
id|RX_RING_SIZE
)braket
op_eq
l_int|NULL
)paren
(brace
r_if
c_cond
(paren
id|speedo_debug
OG
l_int|2
)paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%s: NULL cur_rx in speedo_resume().&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
)brace
r_else
(brace
id|wait_for_cmd_done
c_func
(paren
id|ioaddr
op_plus
id|SCBCmd
)paren
suffix:semicolon
id|outl
c_func
(paren
id|sp-&gt;rx_ring_dma
(braket
id|sp-&gt;cur_rx
op_mod
id|RX_RING_SIZE
)braket
comma
id|ioaddr
op_plus
id|SCBPointer
)paren
suffix:semicolon
id|outb
c_func
(paren
id|RxStart
comma
id|ioaddr
op_plus
id|SCBCmd
)paren
suffix:semicolon
)brace
id|wait_for_cmd_done
c_func
(paren
id|ioaddr
op_plus
id|SCBCmd
)paren
suffix:semicolon
id|outb
c_func
(paren
id|CUDumpStats
comma
id|ioaddr
op_plus
id|SCBCmd
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|30
)paren
suffix:semicolon
multiline_comment|/* Fill the first command with our physical address. */
(brace
r_struct
id|descriptor
op_star
id|ias_cmd
suffix:semicolon
id|ias_cmd
op_assign
(paren
r_struct
id|descriptor
op_star
)paren
op_amp
id|sp-&gt;tx_ring
(braket
id|sp-&gt;cur_tx
op_increment
op_mod
id|TX_RING_SIZE
)braket
suffix:semicolon
multiline_comment|/* Avoid a bug(?!) here by marking the command already completed. */
id|ias_cmd-&gt;cmd_status
op_assign
id|cpu_to_le32
c_func
(paren
(paren
id|CmdSuspend
op_or
id|CmdIASetup
)paren
op_or
l_int|0xa000
)paren
suffix:semicolon
id|ias_cmd-&gt;link
op_assign
id|cpu_to_le32
c_func
(paren
id|TX_RING_ELEM_DMA
c_func
(paren
id|sp
comma
id|sp-&gt;cur_tx
op_mod
id|TX_RING_SIZE
)paren
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|ias_cmd-&gt;params
comma
id|dev-&gt;dev_addr
comma
l_int|6
)paren
suffix:semicolon
id|sp-&gt;last_cmd
op_assign
id|ias_cmd
suffix:semicolon
)brace
multiline_comment|/* Start the chip&squot;s Tx process and unmask interrupts. */
id|wait_for_cmd_done
c_func
(paren
id|ioaddr
op_plus
id|SCBCmd
)paren
suffix:semicolon
id|outl
c_func
(paren
id|cpu_to_le32
c_func
(paren
id|TX_RING_ELEM_DMA
c_func
(paren
id|sp
comma
id|sp-&gt;dirty_tx
op_mod
id|TX_RING_SIZE
)paren
)paren
comma
id|ioaddr
op_plus
id|SCBPointer
)paren
suffix:semicolon
multiline_comment|/* We are not ACK-ing FCP and ER in the interrupt handler yet so they should&n;&t;   remain masked --Dragan */
id|outw
c_func
(paren
id|CUStart
op_or
id|SCBMaskEarlyRx
op_or
id|SCBMaskFlowCtl
comma
id|ioaddr
op_plus
id|SCBCmd
)paren
suffix:semicolon
)brace
multiline_comment|/* Media monitoring and control. */
DECL|function|speedo_timer
r_static
r_void
id|speedo_timer
c_func
(paren
r_int
r_int
id|data
)paren
(brace
r_struct
id|net_device
op_star
id|dev
op_assign
(paren
r_struct
id|net_device
op_star
)paren
id|data
suffix:semicolon
r_struct
id|speedo_private
op_star
id|sp
op_assign
(paren
r_struct
id|speedo_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_int
id|ioaddr
op_assign
id|dev-&gt;base_addr
suffix:semicolon
r_int
id|phy_num
op_assign
id|sp-&gt;phy
(braket
l_int|0
)braket
op_amp
l_int|0x1f
suffix:semicolon
multiline_comment|/* We have MII and lost link beat. */
r_if
c_cond
(paren
(paren
id|sp-&gt;phy
(braket
l_int|0
)braket
op_amp
l_int|0x8000
)paren
op_eq
l_int|0
)paren
(brace
r_int
id|partner
op_assign
id|mdio_read
c_func
(paren
id|ioaddr
comma
id|phy_num
comma
l_int|5
)paren
suffix:semicolon
r_if
c_cond
(paren
id|partner
op_ne
id|sp-&gt;partner
)paren
(brace
r_int
id|flow_ctrl
op_assign
id|sp-&gt;advertising
op_amp
id|partner
op_amp
l_int|0x0400
ques
c_cond
l_int|1
suffix:colon
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|speedo_debug
OG
l_int|2
)paren
(brace
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%s: Link status change.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%s: Old partner %x, new %x, adv %x.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|sp-&gt;partner
comma
id|partner
comma
id|sp-&gt;advertising
)paren
suffix:semicolon
)brace
id|sp-&gt;partner
op_assign
id|partner
suffix:semicolon
r_if
c_cond
(paren
id|flow_ctrl
op_ne
id|sp-&gt;flow_ctrl
)paren
(brace
id|sp-&gt;flow_ctrl
op_assign
id|flow_ctrl
suffix:semicolon
id|sp-&gt;rx_mode
op_assign
op_minus
l_int|1
suffix:semicolon
multiline_comment|/* Trigger a reload. */
)brace
multiline_comment|/* Clear sticky bit. */
id|mdio_read
c_func
(paren
id|ioaddr
comma
id|phy_num
comma
l_int|1
)paren
suffix:semicolon
multiline_comment|/* If link beat has returned... */
r_if
c_cond
(paren
id|mdio_read
c_func
(paren
id|ioaddr
comma
id|phy_num
comma
l_int|1
)paren
op_amp
l_int|0x0004
)paren
id|dev-&gt;flags
op_or_assign
id|IFF_RUNNING
suffix:semicolon
r_else
id|dev-&gt;flags
op_and_assign
op_complement
id|IFF_RUNNING
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|speedo_debug
OG
l_int|3
)paren
(brace
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%s: Media control tick, status %4.4x.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|inw
c_func
(paren
id|ioaddr
op_plus
id|SCBStatus
)paren
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|sp-&gt;rx_mode
OL
l_int|0
op_logical_or
(paren
id|sp-&gt;rx_bug
op_logical_and
id|jiffies
op_minus
id|sp-&gt;last_rx_time
OG
l_int|2
op_star
id|HZ
)paren
)paren
(brace
multiline_comment|/* We haven&squot;t received a packet in a Long Time.  We might have been&n;&t;&t;   bitten by the receiver hang bug.  This can be cleared by sending&n;&t;&t;   a set multicast list command. */
r_if
c_cond
(paren
id|speedo_debug
OG
l_int|3
)paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%s: Sending a multicast list set command&quot;
l_string|&quot; from a timer routine,&quot;
l_string|&quot; m=%d, j=%ld, l=%ld.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|sp-&gt;rx_mode
comma
id|jiffies
comma
id|sp-&gt;last_rx_time
)paren
suffix:semicolon
id|set_rx_mode
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
multiline_comment|/* We must continue to monitor the media. */
id|sp-&gt;timer.expires
op_assign
id|RUN_AT
c_func
(paren
l_int|2
op_star
id|HZ
)paren
suffix:semicolon
multiline_comment|/* 2.0 sec. */
id|add_timer
c_func
(paren
op_amp
id|sp-&gt;timer
)paren
suffix:semicolon
macro_line|#if defined(timer_exit)
id|timer_exit
c_func
(paren
op_amp
id|sp-&gt;timer
)paren
suffix:semicolon
macro_line|#endif
)brace
DECL|function|speedo_show_state
r_static
r_void
id|speedo_show_state
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|speedo_private
op_star
id|sp
op_assign
(paren
r_struct
id|speedo_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_int
id|i
suffix:semicolon
multiline_comment|/* Print a few items for debugging. */
r_if
c_cond
(paren
id|speedo_debug
OG
l_int|0
)paren
(brace
r_int
id|i
suffix:semicolon
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%s: Tx ring dump,  Tx queue %u / %u:&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|sp-&gt;cur_tx
comma
id|sp-&gt;dirty_tx
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|TX_RING_SIZE
suffix:semicolon
id|i
op_increment
)paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%s:  %c%c%2d %8.8x.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|i
op_eq
id|sp-&gt;dirty_tx
op_mod
id|TX_RING_SIZE
ques
c_cond
l_char|&squot;*&squot;
suffix:colon
l_char|&squot; &squot;
comma
id|i
op_eq
id|sp-&gt;cur_tx
op_mod
id|TX_RING_SIZE
ques
c_cond
l_char|&squot;=&squot;
suffix:colon
l_char|&squot; &squot;
comma
id|i
comma
id|sp-&gt;tx_ring
(braket
id|i
)braket
dot
id|status
)paren
suffix:semicolon
)brace
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%s: Printing Rx ring&quot;
l_string|&quot; (next to receive into %u, dirty index %u).&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|sp-&gt;cur_rx
comma
id|sp-&gt;dirty_rx
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|RX_RING_SIZE
suffix:semicolon
id|i
op_increment
)paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%s: %c%c%c%2d %8.8x.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|sp-&gt;rx_ringp
(braket
id|i
)braket
op_eq
id|sp-&gt;last_rxf
ques
c_cond
l_char|&squot;l&squot;
suffix:colon
l_char|&squot; &squot;
comma
id|i
op_eq
id|sp-&gt;dirty_rx
op_mod
id|RX_RING_SIZE
ques
c_cond
l_char|&squot;*&squot;
suffix:colon
l_char|&squot; &squot;
comma
id|i
op_eq
id|sp-&gt;cur_rx
op_mod
id|RX_RING_SIZE
ques
c_cond
l_char|&squot;=&squot;
suffix:colon
l_char|&squot; &squot;
comma
id|i
comma
(paren
id|sp-&gt;rx_ringp
(braket
id|i
)braket
op_ne
l_int|NULL
)paren
ques
c_cond
(paren
r_int
)paren
id|sp-&gt;rx_ringp
(braket
id|i
)braket
op_member_access_from_pointer
id|status
suffix:colon
l_int|0
)paren
suffix:semicolon
macro_line|#if 0
(brace
r_int
id|ioaddr
op_assign
id|dev-&gt;base_addr
suffix:semicolon
r_int
id|phy_num
op_assign
id|sp-&gt;phy
(braket
l_int|0
)braket
op_amp
l_int|0x1f
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|16
suffix:semicolon
id|i
op_increment
)paren
(brace
multiline_comment|/* FIXME: what does it mean?  --SAW */
r_if
c_cond
(paren
id|i
op_eq
l_int|6
)paren
id|i
op_assign
l_int|21
suffix:semicolon
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%s:  PHY index %d register %d is %4.4x.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|phy_num
comma
id|i
comma
id|mdio_read
c_func
(paren
id|ioaddr
comma
id|phy_num
comma
id|i
)paren
)paren
suffix:semicolon
)brace
)brace
macro_line|#endif
)brace
multiline_comment|/* Initialize the Rx and Tx rings, along with various &squot;dev&squot; bits. */
r_static
r_void
DECL|function|speedo_init_rx_ring
id|speedo_init_rx_ring
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|speedo_private
op_star
id|sp
op_assign
(paren
r_struct
id|speedo_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_struct
id|RxFD
op_star
id|rxf
comma
op_star
id|last_rxf
op_assign
l_int|NULL
suffix:semicolon
id|dma_addr_t
id|last_rxf_dma
op_assign
l_int|0
multiline_comment|/* to shut up the compiler */
suffix:semicolon
r_int
id|i
suffix:semicolon
id|sp-&gt;cur_rx
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|RX_RING_SIZE
suffix:semicolon
id|i
op_increment
)paren
(brace
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
id|skb
op_assign
id|dev_alloc_skb
c_func
(paren
id|PKT_BUF_SZ
op_plus
r_sizeof
(paren
r_struct
id|RxFD
)paren
)paren
suffix:semicolon
id|sp-&gt;rx_skbuff
(braket
id|i
)braket
op_assign
id|skb
suffix:semicolon
r_if
c_cond
(paren
id|skb
op_eq
l_int|NULL
)paren
r_break
suffix:semicolon
multiline_comment|/* OK.  Just initially short of Rx bufs. */
id|skb-&gt;dev
op_assign
id|dev
suffix:semicolon
multiline_comment|/* Mark as being used by this device. */
id|rxf
op_assign
(paren
r_struct
id|RxFD
op_star
)paren
id|skb-&gt;tail
suffix:semicolon
id|sp-&gt;rx_ringp
(braket
id|i
)braket
op_assign
id|rxf
suffix:semicolon
id|sp-&gt;rx_ring_dma
(braket
id|i
)braket
op_assign
id|pci_map_single
c_func
(paren
id|sp-&gt;pdev
comma
id|rxf
comma
id|PKT_BUF_SZ
op_plus
r_sizeof
(paren
r_struct
id|RxFD
)paren
comma
id|PCI_DMA_BIDIRECTIONAL
)paren
suffix:semicolon
id|skb_reserve
c_func
(paren
id|skb
comma
r_sizeof
(paren
r_struct
id|RxFD
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|last_rxf
)paren
(brace
id|last_rxf-&gt;link
op_assign
id|cpu_to_le32
c_func
(paren
id|sp-&gt;rx_ring_dma
(braket
id|i
)braket
)paren
suffix:semicolon
id|pci_dma_sync_single
c_func
(paren
id|sp-&gt;pdev
comma
id|last_rxf_dma
comma
r_sizeof
(paren
r_struct
id|RxFD
)paren
comma
id|PCI_DMA_TODEVICE
)paren
suffix:semicolon
)brace
id|last_rxf
op_assign
id|rxf
suffix:semicolon
id|last_rxf_dma
op_assign
id|sp-&gt;rx_ring_dma
(braket
id|i
)braket
suffix:semicolon
id|rxf-&gt;status
op_assign
id|cpu_to_le32
c_func
(paren
l_int|0x00000001
)paren
suffix:semicolon
multiline_comment|/* &squot;1&squot; is flag value only. */
id|rxf-&gt;link
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* None yet. */
multiline_comment|/* This field unused by i82557. */
id|rxf-&gt;rx_buf_addr
op_assign
l_int|0xffffffff
suffix:semicolon
id|rxf-&gt;count
op_assign
id|cpu_to_le32
c_func
(paren
id|PKT_BUF_SZ
op_lshift
l_int|16
)paren
suffix:semicolon
id|pci_dma_sync_single
c_func
(paren
id|sp-&gt;pdev
comma
id|sp-&gt;rx_ring_dma
(braket
id|i
)braket
comma
r_sizeof
(paren
r_struct
id|RxFD
)paren
comma
id|PCI_DMA_TODEVICE
)paren
suffix:semicolon
)brace
id|sp-&gt;dirty_rx
op_assign
(paren
r_int
r_int
)paren
(paren
id|i
op_minus
id|RX_RING_SIZE
)paren
suffix:semicolon
multiline_comment|/* Mark the last entry as end-of-list. */
id|last_rxf-&gt;status
op_assign
id|cpu_to_le32
c_func
(paren
l_int|0xC0000002
)paren
suffix:semicolon
multiline_comment|/* &squot;2&squot; is flag value only. */
id|pci_dma_sync_single
c_func
(paren
id|sp-&gt;pdev
comma
id|sp-&gt;rx_ring_dma
(braket
id|RX_RING_SIZE
op_minus
l_int|1
)braket
comma
r_sizeof
(paren
r_struct
id|RxFD
)paren
comma
id|PCI_DMA_TODEVICE
)paren
suffix:semicolon
id|sp-&gt;last_rxf
op_assign
id|last_rxf
suffix:semicolon
id|sp-&gt;last_rxf_dma
op_assign
id|last_rxf_dma
suffix:semicolon
)brace
DECL|function|speedo_purge_tx
r_static
r_void
id|speedo_purge_tx
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|speedo_private
op_star
id|sp
op_assign
(paren
r_struct
id|speedo_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_int
id|entry
suffix:semicolon
r_while
c_loop
(paren
(paren
r_int
)paren
(paren
id|sp-&gt;cur_tx
op_minus
id|sp-&gt;dirty_tx
)paren
OG
l_int|0
)paren
(brace
id|entry
op_assign
id|sp-&gt;dirty_tx
op_mod
id|TX_RING_SIZE
suffix:semicolon
r_if
c_cond
(paren
id|sp-&gt;tx_skbuff
(braket
id|entry
)braket
)paren
(brace
id|sp-&gt;stats.tx_errors
op_increment
suffix:semicolon
id|pci_unmap_single
c_func
(paren
id|sp-&gt;pdev
comma
id|le32_to_cpu
c_func
(paren
id|sp-&gt;tx_ring
(braket
id|entry
)braket
dot
id|tx_buf_addr0
)paren
comma
id|sp-&gt;tx_skbuff
(braket
id|entry
)braket
op_member_access_from_pointer
id|len
comma
id|PCI_DMA_TODEVICE
)paren
suffix:semicolon
id|dev_kfree_skb_irq
c_func
(paren
id|sp-&gt;tx_skbuff
(braket
id|entry
)braket
)paren
suffix:semicolon
id|sp-&gt;tx_skbuff
(braket
id|entry
)braket
op_assign
l_int|0
suffix:semicolon
)brace
id|sp-&gt;dirty_tx
op_increment
suffix:semicolon
)brace
r_while
c_loop
(paren
id|sp-&gt;mc_setup_head
op_ne
l_int|NULL
)paren
(brace
r_struct
id|speedo_mc_block
op_star
id|t
suffix:semicolon
r_if
c_cond
(paren
id|speedo_debug
OG
l_int|1
)paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%s: freeing mc frame.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|pci_unmap_single
c_func
(paren
id|sp-&gt;pdev
comma
id|sp-&gt;mc_setup_head-&gt;frame_dma
comma
id|sp-&gt;mc_setup_head-&gt;len
comma
id|PCI_DMA_TODEVICE
)paren
suffix:semicolon
id|t
op_assign
id|sp-&gt;mc_setup_head-&gt;next
suffix:semicolon
id|kfree
c_func
(paren
id|sp-&gt;mc_setup_head
)paren
suffix:semicolon
id|sp-&gt;mc_setup_head
op_assign
id|t
suffix:semicolon
)brace
id|sp-&gt;mc_setup_tail
op_assign
l_int|NULL
suffix:semicolon
id|sp-&gt;tx_full
op_assign
l_int|0
suffix:semicolon
id|netif_wake_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
DECL|function|reset_mii
r_static
r_void
id|reset_mii
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|speedo_private
op_star
id|sp
op_assign
(paren
r_struct
id|speedo_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_int
id|ioaddr
op_assign
id|dev-&gt;base_addr
suffix:semicolon
multiline_comment|/* Reset the MII transceiver, suggested by Fred Young @ scalable.com. */
r_if
c_cond
(paren
(paren
id|sp-&gt;phy
(braket
l_int|0
)braket
op_amp
l_int|0x8000
)paren
op_eq
l_int|0
)paren
(brace
r_int
id|phy_addr
op_assign
id|sp-&gt;phy
(braket
l_int|0
)braket
op_amp
l_int|0x1f
suffix:semicolon
r_int
id|advertising
op_assign
id|mdio_read
c_func
(paren
id|ioaddr
comma
id|phy_addr
comma
l_int|4
)paren
suffix:semicolon
r_int
id|mii_bmcr
op_assign
id|mdio_read
c_func
(paren
id|ioaddr
comma
id|phy_addr
comma
l_int|0
)paren
suffix:semicolon
id|mdio_write
c_func
(paren
id|ioaddr
comma
id|phy_addr
comma
l_int|0
comma
l_int|0x0400
)paren
suffix:semicolon
id|mdio_write
c_func
(paren
id|ioaddr
comma
id|phy_addr
comma
l_int|1
comma
l_int|0x0000
)paren
suffix:semicolon
id|mdio_write
c_func
(paren
id|ioaddr
comma
id|phy_addr
comma
l_int|4
comma
l_int|0x0000
)paren
suffix:semicolon
id|mdio_write
c_func
(paren
id|ioaddr
comma
id|phy_addr
comma
l_int|0
comma
l_int|0x8000
)paren
suffix:semicolon
macro_line|#ifdef honor_default_port
id|mdio_write
c_func
(paren
id|ioaddr
comma
id|phy_addr
comma
l_int|0
comma
id|mii_ctrl
(braket
id|dev-&gt;default_port
op_amp
l_int|7
)braket
)paren
suffix:semicolon
macro_line|#else
id|mdio_read
c_func
(paren
id|ioaddr
comma
id|phy_addr
comma
l_int|0
)paren
suffix:semicolon
id|mdio_write
c_func
(paren
id|ioaddr
comma
id|phy_addr
comma
l_int|0
comma
id|mii_bmcr
)paren
suffix:semicolon
id|mdio_write
c_func
(paren
id|ioaddr
comma
id|phy_addr
comma
l_int|4
comma
id|advertising
)paren
suffix:semicolon
macro_line|#endif
)brace
)brace
DECL|function|speedo_tx_timeout
r_static
r_void
id|speedo_tx_timeout
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|speedo_private
op_star
id|sp
op_assign
(paren
r_struct
id|speedo_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_int
id|ioaddr
op_assign
id|dev-&gt;base_addr
suffix:semicolon
r_int
id|status
op_assign
id|inw
c_func
(paren
id|ioaddr
op_plus
id|SCBStatus
)paren
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: Transmit timed out: status %4.4x &quot;
l_string|&quot; %4.4x at %d/%d command %8.8x.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|status
comma
id|inw
c_func
(paren
id|ioaddr
op_plus
id|SCBCmd
)paren
comma
id|sp-&gt;dirty_tx
comma
id|sp-&gt;cur_tx
comma
id|sp-&gt;tx_ring
(braket
id|sp-&gt;dirty_tx
op_mod
id|TX_RING_SIZE
)braket
dot
id|status
)paren
suffix:semicolon
id|speedo_show_state
c_func
(paren
id|dev
)paren
suffix:semicolon
macro_line|#if 0
r_if
c_cond
(paren
(paren
id|status
op_amp
l_int|0x00C0
)paren
op_ne
l_int|0x0080
op_logical_and
(paren
id|status
op_amp
l_int|0x003C
)paren
op_eq
l_int|0x0010
)paren
(brace
multiline_comment|/* Only the command unit has stopped. */
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: Trying to restart the transmitter...&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|outl
(paren
id|cpu_to_le32
(paren
id|TX_RING_ELEM_DMA
(paren
id|sp
comma
id|dirty_tx
op_mod
id|TX_RING_SIZE
)braket
)paren
)paren
comma
id|ioaddr
op_plus
id|SCBPointer
)paren
suffix:semicolon
id|outw
c_func
(paren
id|CUStart
comma
id|ioaddr
op_plus
id|SCBCmd
)paren
suffix:semicolon
id|reset_mii
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
r_else
(brace
macro_line|#else
(brace
macro_line|#endif
id|del_timer_sync
c_func
(paren
op_amp
id|sp-&gt;timer
)paren
suffix:semicolon
multiline_comment|/* Reset the Tx and Rx units. */
id|outl
c_func
(paren
id|PortReset
comma
id|ioaddr
op_plus
id|SCBPort
)paren
suffix:semicolon
multiline_comment|/* We may get spurious interrupts here.  But I don&squot;t think that they&n;&t;&t;   may do much harm.  1999/12/09 SAW */
id|udelay
c_func
(paren
l_int|10
)paren
suffix:semicolon
multiline_comment|/* Disable interrupts. */
id|outw
c_func
(paren
id|SCBMaskAll
comma
id|ioaddr
op_plus
id|SCBCmd
)paren
suffix:semicolon
id|synchronize_irq
c_func
(paren
)paren
suffix:semicolon
id|speedo_tx_buffer_gc
c_func
(paren
id|dev
)paren
suffix:semicolon
multiline_comment|/* Free as much as possible.&n;&t;&t;   It helps to recover from a hang because of out-of-memory.&n;&t;&t;   It also simplifies speedo_resume() in case TX ring is full or&n;&t;&t;   close-to-be full. */
id|speedo_purge_tx
c_func
(paren
id|dev
)paren
suffix:semicolon
id|speedo_refill_rx_buffers
c_func
(paren
id|dev
comma
l_int|1
)paren
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|sp-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|speedo_resume
c_func
(paren
id|dev
)paren
suffix:semicolon
id|sp-&gt;rx_mode
op_assign
op_minus
l_int|1
suffix:semicolon
id|dev-&gt;trans_start
op_assign
id|jiffies
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|sp-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|set_rx_mode
c_func
(paren
id|dev
)paren
suffix:semicolon
multiline_comment|/* it takes the spinlock itself --SAW */
multiline_comment|/* Reset MII transceiver.  Do it before starting the timer to serialize&n;&t;&t;   mdio_xxx operations.  Yes, it&squot;s a paranoya :-)  2000/05/09 SAW */
id|reset_mii
c_func
(paren
id|dev
)paren
suffix:semicolon
id|sp-&gt;timer.expires
op_assign
id|RUN_AT
c_func
(paren
l_int|2
op_star
id|HZ
)paren
suffix:semicolon
id|add_timer
c_func
(paren
op_amp
id|sp-&gt;timer
)paren
suffix:semicolon
)brace
r_return
suffix:semicolon
)brace
r_static
r_int
DECL|function|speedo_start_xmit
id|speedo_start_xmit
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|speedo_private
op_star
id|sp
op_assign
(paren
r_struct
id|speedo_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_int
id|ioaddr
op_assign
id|dev-&gt;base_addr
suffix:semicolon
r_int
id|entry
suffix:semicolon
(brace
multiline_comment|/* Prevent interrupts from changing the Tx ring from underneath us. */
r_int
r_int
id|flags
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|sp-&gt;lock
comma
id|flags
)paren
suffix:semicolon
multiline_comment|/* Check if there are enough space. */
r_if
c_cond
(paren
(paren
r_int
)paren
(paren
id|sp-&gt;cur_tx
op_minus
id|sp-&gt;dirty_tx
)paren
op_ge
id|TX_QUEUE_LIMIT
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: incorrect tbusy state, fixed.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|netif_stop_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
id|sp-&gt;tx_full
op_assign
l_int|1
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|sp-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
multiline_comment|/* Calculate the Tx descriptor entry. */
id|entry
op_assign
id|sp-&gt;cur_tx
op_increment
op_mod
id|TX_RING_SIZE
suffix:semicolon
id|sp-&gt;tx_skbuff
(braket
id|entry
)braket
op_assign
id|skb
suffix:semicolon
id|sp-&gt;tx_ring
(braket
id|entry
)braket
dot
id|status
op_assign
id|cpu_to_le32
c_func
(paren
id|CmdSuspend
op_or
id|CmdTx
op_or
id|CmdTxFlex
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|entry
op_amp
(paren
(paren
id|TX_RING_SIZE
op_rshift
l_int|2
)paren
op_minus
l_int|1
)paren
)paren
)paren
id|sp-&gt;tx_ring
(braket
id|entry
)braket
dot
id|status
op_or_assign
id|cpu_to_le32
c_func
(paren
id|CmdIntr
)paren
suffix:semicolon
id|sp-&gt;tx_ring
(braket
id|entry
)braket
dot
id|link
op_assign
id|cpu_to_le32
c_func
(paren
id|TX_RING_ELEM_DMA
c_func
(paren
id|sp
comma
id|sp-&gt;cur_tx
op_mod
id|TX_RING_SIZE
)paren
)paren
suffix:semicolon
id|sp-&gt;tx_ring
(braket
id|entry
)braket
dot
id|tx_desc_addr
op_assign
id|cpu_to_le32
c_func
(paren
id|TX_RING_ELEM_DMA
c_func
(paren
id|sp
comma
id|entry
)paren
op_plus
id|TX_DESCR_BUF_OFFSET
)paren
suffix:semicolon
multiline_comment|/* The data region is always in one buffer descriptor. */
id|sp-&gt;tx_ring
(braket
id|entry
)braket
dot
id|count
op_assign
id|cpu_to_le32
c_func
(paren
id|sp-&gt;tx_threshold
)paren
suffix:semicolon
id|sp-&gt;tx_ring
(braket
id|entry
)braket
dot
id|tx_buf_addr0
op_assign
id|cpu_to_le32
c_func
(paren
id|pci_map_single
c_func
(paren
id|sp-&gt;pdev
comma
id|skb-&gt;data
comma
id|skb-&gt;len
comma
id|PCI_DMA_TODEVICE
)paren
)paren
suffix:semicolon
id|sp-&gt;tx_ring
(braket
id|entry
)braket
dot
id|tx_buf_size0
op_assign
id|cpu_to_le32
c_func
(paren
id|skb-&gt;len
)paren
suffix:semicolon
multiline_comment|/* Trigger the command unit resume. */
id|wait_for_cmd_done
c_func
(paren
id|ioaddr
op_plus
id|SCBCmd
)paren
suffix:semicolon
id|clear_suspend
c_func
(paren
id|sp-&gt;last_cmd
)paren
suffix:semicolon
multiline_comment|/* We want the time window between clearing suspend flag on the previous&n;&t;&t;   command and resuming CU to be as small as possible.&n;&t;&t;   Interrupts in between are very undesired.  --SAW */
id|outb
c_func
(paren
id|CUResume
comma
id|ioaddr
op_plus
id|SCBCmd
)paren
suffix:semicolon
id|sp-&gt;last_cmd
op_assign
(paren
r_struct
id|descriptor
op_star
)paren
op_amp
id|sp-&gt;tx_ring
(braket
id|entry
)braket
suffix:semicolon
multiline_comment|/* Leave room for set_rx_mode(). If there is no more space than reserved&n;&t;&t;   for multicast filter mark the ring as full. */
r_if
c_cond
(paren
(paren
r_int
)paren
(paren
id|sp-&gt;cur_tx
op_minus
id|sp-&gt;dirty_tx
)paren
op_ge
id|TX_QUEUE_LIMIT
)paren
(brace
id|netif_stop_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
id|sp-&gt;tx_full
op_assign
l_int|1
suffix:semicolon
)brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|sp-&gt;lock
comma
id|flags
)paren
suffix:semicolon
)brace
id|dev-&gt;trans_start
op_assign
id|jiffies
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|speedo_tx_buffer_gc
r_static
r_void
id|speedo_tx_buffer_gc
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_int
r_int
id|dirty_tx
suffix:semicolon
r_struct
id|speedo_private
op_star
id|sp
op_assign
(paren
r_struct
id|speedo_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|dirty_tx
op_assign
id|sp-&gt;dirty_tx
suffix:semicolon
r_while
c_loop
(paren
(paren
r_int
)paren
(paren
id|sp-&gt;cur_tx
op_minus
id|dirty_tx
)paren
OG
l_int|0
)paren
(brace
r_int
id|entry
op_assign
id|dirty_tx
op_mod
id|TX_RING_SIZE
suffix:semicolon
r_int
id|status
op_assign
id|le32_to_cpu
c_func
(paren
id|sp-&gt;tx_ring
(braket
id|entry
)braket
dot
id|status
)paren
suffix:semicolon
r_if
c_cond
(paren
id|speedo_debug
OG
l_int|5
)paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot; scavenge candidate %d status %4.4x.&bslash;n&quot;
comma
id|entry
comma
id|status
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|status
op_amp
id|StatusComplete
)paren
op_eq
l_int|0
)paren
r_break
suffix:semicolon
multiline_comment|/* It still hasn&squot;t been processed. */
r_if
c_cond
(paren
id|status
op_amp
id|TxUnderrun
)paren
r_if
c_cond
(paren
id|sp-&gt;tx_threshold
OL
l_int|0x01e08000
)paren
(brace
r_if
c_cond
(paren
id|speedo_debug
OG
l_int|2
)paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%s: TX underrun, threshold adjusted.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|sp-&gt;tx_threshold
op_add_assign
l_int|0x00040000
suffix:semicolon
)brace
multiline_comment|/* Free the original skb. */
r_if
c_cond
(paren
id|sp-&gt;tx_skbuff
(braket
id|entry
)braket
)paren
(brace
id|sp-&gt;stats.tx_packets
op_increment
suffix:semicolon
multiline_comment|/* Count only user packets. */
id|sp-&gt;stats.tx_bytes
op_add_assign
id|sp-&gt;tx_skbuff
(braket
id|entry
)braket
op_member_access_from_pointer
id|len
suffix:semicolon
id|pci_unmap_single
c_func
(paren
id|sp-&gt;pdev
comma
id|le32_to_cpu
c_func
(paren
id|sp-&gt;tx_ring
(braket
id|entry
)braket
dot
id|tx_buf_addr0
)paren
comma
id|sp-&gt;tx_skbuff
(braket
id|entry
)braket
op_member_access_from_pointer
id|len
comma
id|PCI_DMA_TODEVICE
)paren
suffix:semicolon
id|dev_kfree_skb_irq
c_func
(paren
id|sp-&gt;tx_skbuff
(braket
id|entry
)braket
)paren
suffix:semicolon
id|sp-&gt;tx_skbuff
(braket
id|entry
)braket
op_assign
l_int|0
suffix:semicolon
)brace
id|dirty_tx
op_increment
suffix:semicolon
)brace
r_if
c_cond
(paren
id|speedo_debug
op_logical_and
(paren
r_int
)paren
(paren
id|sp-&gt;cur_tx
op_minus
id|dirty_tx
)paren
OG
id|TX_RING_SIZE
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;out-of-sync dirty pointer, %d vs. %d,&quot;
l_string|&quot; full=%d.&bslash;n&quot;
comma
id|dirty_tx
comma
id|sp-&gt;cur_tx
comma
id|sp-&gt;tx_full
)paren
suffix:semicolon
id|dirty_tx
op_add_assign
id|TX_RING_SIZE
suffix:semicolon
)brace
r_while
c_loop
(paren
id|sp-&gt;mc_setup_head
op_ne
l_int|NULL
op_logical_and
(paren
r_int
)paren
(paren
id|dirty_tx
op_minus
id|sp-&gt;mc_setup_head-&gt;tx
op_minus
l_int|1
)paren
OG
l_int|0
)paren
(brace
r_struct
id|speedo_mc_block
op_star
id|t
suffix:semicolon
r_if
c_cond
(paren
id|speedo_debug
OG
l_int|1
)paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%s: freeing mc frame.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|pci_unmap_single
c_func
(paren
id|sp-&gt;pdev
comma
id|sp-&gt;mc_setup_head-&gt;frame_dma
comma
id|sp-&gt;mc_setup_head-&gt;len
comma
id|PCI_DMA_TODEVICE
)paren
suffix:semicolon
id|t
op_assign
id|sp-&gt;mc_setup_head-&gt;next
suffix:semicolon
id|kfree
c_func
(paren
id|sp-&gt;mc_setup_head
)paren
suffix:semicolon
id|sp-&gt;mc_setup_head
op_assign
id|t
suffix:semicolon
)brace
r_if
c_cond
(paren
id|sp-&gt;mc_setup_head
op_eq
l_int|NULL
)paren
id|sp-&gt;mc_setup_tail
op_assign
l_int|NULL
suffix:semicolon
id|sp-&gt;dirty_tx
op_assign
id|dirty_tx
suffix:semicolon
)brace
multiline_comment|/* The interrupt handler does all of the Rx thread work and cleans up&n;   after the Tx thread. */
DECL|function|speedo_interrupt
r_static
r_void
id|speedo_interrupt
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_instance
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_struct
id|net_device
op_star
id|dev
op_assign
(paren
r_struct
id|net_device
op_star
)paren
id|dev_instance
suffix:semicolon
r_struct
id|speedo_private
op_star
id|sp
suffix:semicolon
r_int
id|ioaddr
comma
id|boguscnt
op_assign
id|max_interrupt_work
suffix:semicolon
r_int
r_int
id|status
suffix:semicolon
macro_line|#ifndef final_version
r_if
c_cond
(paren
id|dev
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;speedo_interrupt(): irq %d for unknown device.&bslash;n&quot;
comma
id|irq
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
macro_line|#endif
id|ioaddr
op_assign
id|dev-&gt;base_addr
suffix:semicolon
id|sp
op_assign
(paren
r_struct
id|speedo_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
macro_line|#ifndef final_version
multiline_comment|/* A lock to prevent simultaneous entry on SMP machines. */
r_if
c_cond
(paren
id|test_and_set_bit
c_func
(paren
l_int|0
comma
(paren
r_void
op_star
)paren
op_amp
id|sp-&gt;in_interrupt
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: SMP simultaneous entry of an interrupt handler.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|sp-&gt;in_interrupt
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Avoid halting machine. */
r_return
suffix:semicolon
)brace
macro_line|#endif
r_do
(brace
id|status
op_assign
id|inw
c_func
(paren
id|ioaddr
op_plus
id|SCBStatus
)paren
suffix:semicolon
multiline_comment|/* Acknowledge all of the current interrupt sources ASAP. */
multiline_comment|/* Will change from 0xfc00 to 0xff00 when we start handling&n;&t;&t;   FCP and ER interrupts --Dragan */
id|outw
c_func
(paren
id|status
op_amp
l_int|0xfc00
comma
id|ioaddr
op_plus
id|SCBStatus
)paren
suffix:semicolon
r_if
c_cond
(paren
id|speedo_debug
OG
l_int|4
)paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%s: interrupt  status=%#4.4x.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|status
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|status
op_amp
l_int|0xfc00
)paren
op_eq
l_int|0
)paren
r_break
suffix:semicolon
multiline_comment|/* Always check if all rx buffers are allocated.  --SAW */
id|speedo_refill_rx_buffers
c_func
(paren
id|dev
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|status
op_amp
l_int|0x5000
)paren
op_logical_or
multiline_comment|/* Packet received, or Rx error. */
(paren
id|sp-&gt;rx_ring_state
op_amp
(paren
id|RrNoMem
op_or
id|RrPostponed
)paren
)paren
op_eq
id|RrPostponed
)paren
multiline_comment|/* Need to gather the postponed packet. */
id|speedo_rx
c_func
(paren
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
l_int|0x1000
)paren
(brace
id|spin_lock
c_func
(paren
op_amp
id|sp-&gt;lock
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|status
op_amp
l_int|0x003c
)paren
op_eq
l_int|0x0028
)paren
(brace
multiline_comment|/* No more Rx buffers. */
r_struct
id|RxFD
op_star
id|rxf
suffix:semicolon
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: card reports no RX buffers.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|rxf
op_assign
id|sp-&gt;rx_ringp
(braket
id|sp-&gt;cur_rx
op_mod
id|RX_RING_SIZE
)braket
suffix:semicolon
r_if
c_cond
(paren
id|rxf
op_eq
l_int|NULL
)paren
(brace
r_if
c_cond
(paren
id|speedo_debug
OG
l_int|2
)paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%s: NULL cur_rx in speedo_interrupt().&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|sp-&gt;rx_ring_state
op_or_assign
id|RrNoMem
op_or
id|RrNoResources
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|rxf
op_eq
id|sp-&gt;last_rxf
)paren
(brace
r_if
c_cond
(paren
id|speedo_debug
OG
l_int|2
)paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%s: cur_rx is last in speedo_interrupt().&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|sp-&gt;rx_ring_state
op_or_assign
id|RrNoMem
op_or
id|RrNoResources
suffix:semicolon
)brace
r_else
id|outb
c_func
(paren
id|RxResumeNoResources
comma
id|ioaddr
op_plus
id|SCBCmd
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
(paren
id|status
op_amp
l_int|0x003c
)paren
op_eq
l_int|0x0008
)paren
(brace
multiline_comment|/* No resources. */
r_struct
id|RxFD
op_star
id|rxf
suffix:semicolon
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: card reports no resources.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|rxf
op_assign
id|sp-&gt;rx_ringp
(braket
id|sp-&gt;cur_rx
op_mod
id|RX_RING_SIZE
)braket
suffix:semicolon
r_if
c_cond
(paren
id|rxf
op_eq
l_int|NULL
)paren
(brace
r_if
c_cond
(paren
id|speedo_debug
OG
l_int|2
)paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%s: NULL cur_rx in speedo_interrupt().&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|sp-&gt;rx_ring_state
op_or_assign
id|RrNoMem
op_or
id|RrNoResources
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|rxf
op_eq
id|sp-&gt;last_rxf
)paren
(brace
r_if
c_cond
(paren
id|speedo_debug
OG
l_int|2
)paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%s: cur_rx is last in speedo_interrupt().&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|sp-&gt;rx_ring_state
op_or_assign
id|RrNoMem
op_or
id|RrNoResources
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* Restart the receiver. */
id|outl
c_func
(paren
id|sp-&gt;rx_ring_dma
(braket
id|sp-&gt;cur_rx
op_mod
id|RX_RING_SIZE
)braket
comma
id|ioaddr
op_plus
id|SCBPointer
)paren
suffix:semicolon
id|outb
c_func
(paren
id|RxStart
comma
id|ioaddr
op_plus
id|SCBCmd
)paren
suffix:semicolon
)brace
)brace
id|sp-&gt;stats.rx_errors
op_increment
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|sp-&gt;lock
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|sp-&gt;rx_ring_state
op_amp
(paren
id|RrNoMem
op_or
id|RrNoResources
)paren
)paren
op_eq
id|RrNoResources
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: restart the receiver after a possible hang.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|sp-&gt;lock
)paren
suffix:semicolon
multiline_comment|/* Restart the receiver.&n;&t;&t;&t;   I&squot;m not sure if it&squot;s always right to restart the receiver&n;&t;&t;&t;   here but I don&squot;t know another way to prevent receiver hangs.&n;&t;&t;&t;   1999/12/25 SAW */
id|outl
c_func
(paren
id|sp-&gt;rx_ring_dma
(braket
id|sp-&gt;cur_rx
op_mod
id|RX_RING_SIZE
)braket
comma
id|ioaddr
op_plus
id|SCBPointer
)paren
suffix:semicolon
id|outb
c_func
(paren
id|RxStart
comma
id|ioaddr
op_plus
id|SCBCmd
)paren
suffix:semicolon
id|sp-&gt;rx_ring_state
op_and_assign
op_complement
id|RrNoResources
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|sp-&gt;lock
)paren
suffix:semicolon
)brace
multiline_comment|/* User interrupt, Command/Tx unit interrupt or CU not active. */
r_if
c_cond
(paren
id|status
op_amp
l_int|0xA400
)paren
(brace
id|spin_lock
c_func
(paren
op_amp
id|sp-&gt;lock
)paren
suffix:semicolon
id|speedo_tx_buffer_gc
c_func
(paren
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sp-&gt;tx_full
op_logical_and
(paren
r_int
)paren
(paren
id|sp-&gt;cur_tx
op_minus
id|sp-&gt;dirty_tx
)paren
OL
id|TX_QUEUE_UNFULL
)paren
(brace
multiline_comment|/* The ring is no longer full. */
id|sp-&gt;tx_full
op_assign
l_int|0
suffix:semicolon
id|netif_wake_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
multiline_comment|/* Attention: under a spinlock.  --SAW */
)brace
id|spin_unlock
c_func
(paren
op_amp
id|sp-&gt;lock
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
op_decrement
id|boguscnt
OL
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: Too much work at interrupt, status=0x%4.4x.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|status
)paren
suffix:semicolon
multiline_comment|/* Clear all interrupt sources. */
multiline_comment|/* Will change from 0xfc00 to 0xff00 when we start handling&n;&t;&t;&t;   FCP and ER interrupts --Dragan */
id|outw
c_func
(paren
l_int|0xfc00
comma
id|ioaddr
op_plus
id|SCBStatus
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
r_while
c_loop
(paren
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|speedo_debug
OG
l_int|3
)paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%s: exiting interrupt, status=%#4.4x.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|inw
c_func
(paren
id|ioaddr
op_plus
id|SCBStatus
)paren
)paren
suffix:semicolon
id|clear_bit
c_func
(paren
l_int|0
comma
(paren
r_void
op_star
)paren
op_amp
id|sp-&gt;in_interrupt
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
DECL|function|speedo_rx_alloc
r_static
r_inline
r_struct
id|RxFD
op_star
id|speedo_rx_alloc
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_int
id|entry
)paren
(brace
r_struct
id|speedo_private
op_star
id|sp
op_assign
(paren
r_struct
id|speedo_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_struct
id|RxFD
op_star
id|rxf
suffix:semicolon
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
multiline_comment|/* Get a fresh skbuff to replace the consumed one. */
id|skb
op_assign
id|dev_alloc_skb
c_func
(paren
id|PKT_BUF_SZ
op_plus
r_sizeof
(paren
r_struct
id|RxFD
)paren
)paren
suffix:semicolon
id|sp-&gt;rx_skbuff
(braket
id|entry
)braket
op_assign
id|skb
suffix:semicolon
r_if
c_cond
(paren
id|skb
op_eq
l_int|NULL
)paren
(brace
id|sp-&gt;rx_ringp
(braket
id|entry
)braket
op_assign
l_int|NULL
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
id|rxf
op_assign
id|sp-&gt;rx_ringp
(braket
id|entry
)braket
op_assign
(paren
r_struct
id|RxFD
op_star
)paren
id|skb-&gt;tail
suffix:semicolon
id|sp-&gt;rx_ring_dma
(braket
id|entry
)braket
op_assign
id|pci_map_single
c_func
(paren
id|sp-&gt;pdev
comma
id|rxf
comma
id|PKT_BUF_SZ
op_plus
r_sizeof
(paren
r_struct
id|RxFD
)paren
comma
id|PCI_DMA_FROMDEVICE
)paren
suffix:semicolon
id|skb-&gt;dev
op_assign
id|dev
suffix:semicolon
id|skb_reserve
c_func
(paren
id|skb
comma
r_sizeof
(paren
r_struct
id|RxFD
)paren
)paren
suffix:semicolon
id|rxf-&gt;rx_buf_addr
op_assign
l_int|0xffffffff
suffix:semicolon
id|pci_dma_sync_single
c_func
(paren
id|sp-&gt;pdev
comma
id|sp-&gt;rx_ring_dma
(braket
id|entry
)braket
comma
r_sizeof
(paren
r_struct
id|RxFD
)paren
comma
id|PCI_DMA_TODEVICE
)paren
suffix:semicolon
r_return
id|rxf
suffix:semicolon
)brace
DECL|function|speedo_rx_link
r_static
r_inline
r_void
id|speedo_rx_link
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_int
id|entry
comma
r_struct
id|RxFD
op_star
id|rxf
comma
id|dma_addr_t
id|rxf_dma
)paren
(brace
r_struct
id|speedo_private
op_star
id|sp
op_assign
(paren
r_struct
id|speedo_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|rxf-&gt;status
op_assign
id|cpu_to_le32
c_func
(paren
l_int|0xC0000001
)paren
suffix:semicolon
multiline_comment|/* &squot;1&squot; for driver use only. */
id|rxf-&gt;link
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* None yet. */
id|rxf-&gt;count
op_assign
id|cpu_to_le32
c_func
(paren
id|PKT_BUF_SZ
op_lshift
l_int|16
)paren
suffix:semicolon
id|sp-&gt;last_rxf-&gt;link
op_assign
id|cpu_to_le32
c_func
(paren
id|rxf_dma
)paren
suffix:semicolon
id|sp-&gt;last_rxf-&gt;status
op_and_assign
id|cpu_to_le32
c_func
(paren
op_complement
l_int|0xC0000000
)paren
suffix:semicolon
id|pci_dma_sync_single
c_func
(paren
id|sp-&gt;pdev
comma
id|sp-&gt;last_rxf_dma
comma
r_sizeof
(paren
r_struct
id|RxFD
)paren
comma
id|PCI_DMA_TODEVICE
)paren
suffix:semicolon
id|sp-&gt;last_rxf
op_assign
id|rxf
suffix:semicolon
id|sp-&gt;last_rxf_dma
op_assign
id|rxf_dma
suffix:semicolon
)brace
DECL|function|speedo_refill_rx_buf
r_static
r_int
id|speedo_refill_rx_buf
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_int
id|force
)paren
(brace
r_struct
id|speedo_private
op_star
id|sp
op_assign
(paren
r_struct
id|speedo_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_int
id|entry
suffix:semicolon
r_struct
id|RxFD
op_star
id|rxf
suffix:semicolon
id|entry
op_assign
id|sp-&gt;dirty_rx
op_mod
id|RX_RING_SIZE
suffix:semicolon
r_if
c_cond
(paren
id|sp-&gt;rx_skbuff
(braket
id|entry
)braket
op_eq
l_int|NULL
)paren
(brace
id|rxf
op_assign
id|speedo_rx_alloc
c_func
(paren
id|dev
comma
id|entry
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rxf
op_eq
l_int|NULL
)paren
(brace
r_int
r_int
id|forw
suffix:semicolon
r_int
id|forw_entry
suffix:semicolon
r_if
c_cond
(paren
id|speedo_debug
OG
l_int|2
op_logical_or
op_logical_neg
(paren
id|sp-&gt;rx_ring_state
op_amp
id|RrOOMReported
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: can&squot;t fill rx buffer (force %d)!&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|force
)paren
suffix:semicolon
id|speedo_show_state
c_func
(paren
id|dev
)paren
suffix:semicolon
id|sp-&gt;rx_ring_state
op_or_assign
id|RrOOMReported
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|force
)paren
r_return
op_minus
l_int|1
suffix:semicolon
multiline_comment|/* Better luck next time!  */
multiline_comment|/* Borrow an skb from one of next entries. */
r_for
c_loop
(paren
id|forw
op_assign
id|sp-&gt;dirty_rx
op_plus
l_int|1
suffix:semicolon
id|forw
op_ne
id|sp-&gt;cur_rx
suffix:semicolon
id|forw
op_increment
)paren
r_if
c_cond
(paren
id|sp-&gt;rx_skbuff
(braket
id|forw
op_mod
id|RX_RING_SIZE
)braket
op_ne
l_int|NULL
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
id|forw
op_eq
id|sp-&gt;cur_rx
)paren
r_return
op_minus
l_int|1
suffix:semicolon
id|forw_entry
op_assign
id|forw
op_mod
id|RX_RING_SIZE
suffix:semicolon
id|sp-&gt;rx_skbuff
(braket
id|entry
)braket
op_assign
id|sp-&gt;rx_skbuff
(braket
id|forw_entry
)braket
suffix:semicolon
id|sp-&gt;rx_skbuff
(braket
id|forw_entry
)braket
op_assign
l_int|NULL
suffix:semicolon
id|rxf
op_assign
id|sp-&gt;rx_ringp
(braket
id|forw_entry
)braket
suffix:semicolon
id|sp-&gt;rx_ringp
(braket
id|forw_entry
)braket
op_assign
l_int|NULL
suffix:semicolon
id|sp-&gt;rx_ringp
(braket
id|entry
)braket
op_assign
id|rxf
suffix:semicolon
)brace
)brace
r_else
(brace
id|rxf
op_assign
id|sp-&gt;rx_ringp
(braket
id|entry
)braket
suffix:semicolon
)brace
id|speedo_rx_link
c_func
(paren
id|dev
comma
id|entry
comma
id|rxf
comma
id|sp-&gt;rx_ring_dma
(braket
id|entry
)braket
)paren
suffix:semicolon
id|sp-&gt;dirty_rx
op_increment
suffix:semicolon
id|sp-&gt;rx_ring_state
op_and_assign
op_complement
(paren
id|RrNoMem
op_or
id|RrOOMReported
)paren
suffix:semicolon
multiline_comment|/* Mark the progress. */
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|speedo_refill_rx_buffers
r_static
r_void
id|speedo_refill_rx_buffers
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_int
id|force
)paren
(brace
r_struct
id|speedo_private
op_star
id|sp
op_assign
(paren
r_struct
id|speedo_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
multiline_comment|/* Refill the RX ring. */
r_while
c_loop
(paren
(paren
r_int
)paren
(paren
id|sp-&gt;cur_rx
op_minus
id|sp-&gt;dirty_rx
)paren
OG
l_int|0
op_logical_and
id|speedo_refill_rx_buf
c_func
(paren
id|dev
comma
id|force
)paren
op_ne
op_minus
l_int|1
)paren
suffix:semicolon
)brace
r_static
r_int
DECL|function|speedo_rx
id|speedo_rx
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|speedo_private
op_star
id|sp
op_assign
(paren
r_struct
id|speedo_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_int
id|entry
op_assign
id|sp-&gt;cur_rx
op_mod
id|RX_RING_SIZE
suffix:semicolon
r_int
id|rx_work_limit
op_assign
id|sp-&gt;dirty_rx
op_plus
id|RX_RING_SIZE
op_minus
id|sp-&gt;cur_rx
suffix:semicolon
r_int
id|alloc_ok
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|speedo_debug
OG
l_int|4
)paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot; In speedo_rx().&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* If we own the next entry, it&squot;s a new packet. Send it up. */
r_while
c_loop
(paren
id|sp-&gt;rx_ringp
(braket
id|entry
)braket
op_ne
l_int|NULL
)paren
(brace
r_int
id|status
suffix:semicolon
r_int
id|pkt_len
suffix:semicolon
id|pci_dma_sync_single
c_func
(paren
id|sp-&gt;pdev
comma
id|sp-&gt;rx_ring_dma
(braket
id|entry
)braket
comma
r_sizeof
(paren
r_struct
id|RxFD
)paren
comma
id|PCI_DMA_FROMDEVICE
)paren
suffix:semicolon
id|status
op_assign
id|le32_to_cpu
c_func
(paren
id|sp-&gt;rx_ringp
(braket
id|entry
)braket
op_member_access_from_pointer
id|status
)paren
suffix:semicolon
id|pkt_len
op_assign
id|le32_to_cpu
c_func
(paren
id|sp-&gt;rx_ringp
(braket
id|entry
)braket
op_member_access_from_pointer
id|count
)paren
op_amp
l_int|0x3fff
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|status
op_amp
id|RxComplete
)paren
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
op_decrement
id|rx_work_limit
OL
l_int|0
)paren
r_break
suffix:semicolon
multiline_comment|/* Check for a rare out-of-memory case: the current buffer is&n;&t;&t;   the last buffer allocated in the RX ring.  --SAW */
r_if
c_cond
(paren
id|sp-&gt;last_rxf
op_eq
id|sp-&gt;rx_ringp
(braket
id|entry
)braket
)paren
(brace
multiline_comment|/* Postpone the packet.  It&squot;ll be reaped at an interrupt when this&n;&t;&t;&t;   packet is no longer the last packet in the ring. */
r_if
c_cond
(paren
id|speedo_debug
OG
l_int|2
)paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%s: RX packet postponed!&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|sp-&gt;rx_ring_state
op_or_assign
id|RrPostponed
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|speedo_debug
OG
l_int|4
)paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;  speedo_rx() status %8.8x len %d.&bslash;n&quot;
comma
id|status
comma
id|pkt_len
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|status
op_amp
(paren
id|RxErrTooBig
op_or
id|RxOK
op_or
l_int|0x0f90
)paren
)paren
op_ne
id|RxOK
)paren
(brace
r_if
c_cond
(paren
id|status
op_amp
id|RxErrTooBig
)paren
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: Ethernet frame overran the Rx buffer, &quot;
l_string|&quot;status %8.8x!&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|status
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
op_logical_neg
(paren
id|status
op_amp
id|RxOK
)paren
)paren
(brace
multiline_comment|/* There was a fatal error.  This *should* be impossible. */
id|sp-&gt;stats.rx_errors
op_increment
suffix:semicolon
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: Anomalous event in speedo_rx(), &quot;
l_string|&quot;status %8.8x.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|status
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
multiline_comment|/* Check if the packet is long enough to just accept without&n;&t;&t;&t;   copying to a properly sized skbuff. */
r_if
c_cond
(paren
id|pkt_len
OL
id|rx_copybreak
op_logical_and
(paren
id|skb
op_assign
id|dev_alloc_skb
c_func
(paren
id|pkt_len
op_plus
l_int|2
)paren
)paren
op_ne
l_int|0
)paren
(brace
id|skb-&gt;dev
op_assign
id|dev
suffix:semicolon
id|skb_reserve
c_func
(paren
id|skb
comma
l_int|2
)paren
suffix:semicolon
multiline_comment|/* Align IP on 16 byte boundaries */
multiline_comment|/* &squot;skb_put()&squot; points to the start of sk_buff data area. */
id|pci_dma_sync_single
c_func
(paren
id|sp-&gt;pdev
comma
id|sp-&gt;rx_ring_dma
(braket
id|entry
)braket
comma
r_sizeof
(paren
r_struct
id|RxFD
)paren
op_plus
id|pkt_len
comma
id|PCI_DMA_FROMDEVICE
)paren
suffix:semicolon
macro_line|#if 1 || USE_IP_CSUM
multiline_comment|/* Packet is in one chunk -- we can copy + cksum. */
id|eth_copy_and_sum
c_func
(paren
id|skb
comma
id|sp-&gt;rx_skbuff
(braket
id|entry
)braket
op_member_access_from_pointer
id|tail
comma
id|pkt_len
comma
l_int|0
)paren
suffix:semicolon
id|skb_put
c_func
(paren
id|skb
comma
id|pkt_len
)paren
suffix:semicolon
macro_line|#else
id|memcpy
c_func
(paren
id|skb_put
c_func
(paren
id|skb
comma
id|pkt_len
)paren
comma
id|sp-&gt;rx_skbuff
(braket
id|entry
)braket
op_member_access_from_pointer
id|tail
comma
id|pkt_len
)paren
suffix:semicolon
macro_line|#endif
)brace
r_else
(brace
multiline_comment|/* Pass up the already-filled skbuff. */
id|skb
op_assign
id|sp-&gt;rx_skbuff
(braket
id|entry
)braket
suffix:semicolon
r_if
c_cond
(paren
id|skb
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: Inconsistent Rx descriptor chain.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|sp-&gt;rx_skbuff
(braket
id|entry
)braket
op_assign
l_int|NULL
suffix:semicolon
id|skb_put
c_func
(paren
id|skb
comma
id|pkt_len
)paren
suffix:semicolon
id|sp-&gt;rx_ringp
(braket
id|entry
)braket
op_assign
l_int|NULL
suffix:semicolon
id|pci_unmap_single
c_func
(paren
id|sp-&gt;pdev
comma
id|sp-&gt;rx_ring_dma
(braket
id|entry
)braket
comma
id|PKT_BUF_SZ
op_plus
r_sizeof
(paren
r_struct
id|RxFD
)paren
comma
id|PCI_DMA_FROMDEVICE
)paren
suffix:semicolon
)brace
id|skb-&gt;protocol
op_assign
id|eth_type_trans
c_func
(paren
id|skb
comma
id|dev
)paren
suffix:semicolon
id|netif_rx
c_func
(paren
id|skb
)paren
suffix:semicolon
id|sp-&gt;stats.rx_packets
op_increment
suffix:semicolon
id|sp-&gt;stats.rx_bytes
op_add_assign
id|pkt_len
suffix:semicolon
)brace
id|entry
op_assign
(paren
op_increment
id|sp-&gt;cur_rx
)paren
op_mod
id|RX_RING_SIZE
suffix:semicolon
id|sp-&gt;rx_ring_state
op_and_assign
op_complement
id|RrPostponed
suffix:semicolon
multiline_comment|/* Refill the recently taken buffers.&n;&t;&t;   Do it one-by-one to handle traffic bursts better. */
r_if
c_cond
(paren
id|alloc_ok
op_logical_and
id|speedo_refill_rx_buf
c_func
(paren
id|dev
comma
l_int|0
)paren
op_eq
op_minus
l_int|1
)paren
id|alloc_ok
op_assign
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Try hard to refill the recently taken buffers. */
id|speedo_refill_rx_buffers
c_func
(paren
id|dev
comma
l_int|1
)paren
suffix:semicolon
id|sp-&gt;last_rx_time
op_assign
id|jiffies
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_int
DECL|function|speedo_close
id|speedo_close
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_int
id|ioaddr
op_assign
id|dev-&gt;base_addr
suffix:semicolon
r_struct
id|speedo_private
op_star
id|sp
op_assign
(paren
r_struct
id|speedo_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_int
id|i
suffix:semicolon
id|netdevice_stop
c_func
(paren
id|dev
)paren
suffix:semicolon
id|netif_stop_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|speedo_debug
OG
l_int|1
)paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%s: Shutting down ethercard, status was %4.4x.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|inw
c_func
(paren
id|ioaddr
op_plus
id|SCBStatus
)paren
)paren
suffix:semicolon
multiline_comment|/* Shut off the media monitoring timer. */
id|del_timer_sync
c_func
(paren
op_amp
id|sp-&gt;timer
)paren
suffix:semicolon
multiline_comment|/* Shutting down the chip nicely fails to disable flow control. So.. */
id|outl
c_func
(paren
id|PortPartialReset
comma
id|ioaddr
op_plus
id|SCBPort
)paren
suffix:semicolon
id|free_irq
c_func
(paren
id|dev-&gt;irq
comma
id|dev
)paren
suffix:semicolon
multiline_comment|/* Print a few items for debugging. */
r_if
c_cond
(paren
id|speedo_debug
OG
l_int|3
)paren
id|speedo_show_state
c_func
(paren
id|dev
)paren
suffix:semicolon
multiline_comment|/* Free all the skbuffs in the Rx and Tx queues. */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|RX_RING_SIZE
suffix:semicolon
id|i
op_increment
)paren
(brace
r_struct
id|sk_buff
op_star
id|skb
op_assign
id|sp-&gt;rx_skbuff
(braket
id|i
)braket
suffix:semicolon
id|sp-&gt;rx_skbuff
(braket
id|i
)braket
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Clear the Rx descriptors. */
r_if
c_cond
(paren
id|skb
)paren
(brace
id|pci_unmap_single
c_func
(paren
id|sp-&gt;pdev
comma
id|sp-&gt;rx_ring_dma
(braket
id|i
)braket
comma
id|PKT_BUF_SZ
op_plus
r_sizeof
(paren
r_struct
id|RxFD
)paren
comma
id|PCI_DMA_FROMDEVICE
)paren
suffix:semicolon
id|dev_kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
)brace
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|TX_RING_SIZE
suffix:semicolon
id|i
op_increment
)paren
(brace
r_struct
id|sk_buff
op_star
id|skb
op_assign
id|sp-&gt;tx_skbuff
(braket
id|i
)braket
suffix:semicolon
id|sp-&gt;tx_skbuff
(braket
id|i
)braket
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Clear the Tx descriptors. */
r_if
c_cond
(paren
id|skb
)paren
(brace
id|pci_unmap_single
c_func
(paren
id|sp-&gt;pdev
comma
id|le32_to_cpu
c_func
(paren
id|sp-&gt;tx_ring
(braket
id|i
)braket
dot
id|tx_buf_addr0
)paren
comma
id|skb-&gt;len
comma
id|PCI_DMA_TODEVICE
)paren
suffix:semicolon
id|dev_kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* Free multicast setting blocks. */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|sp-&gt;mc_setup_head
op_ne
l_int|NULL
suffix:semicolon
id|i
op_increment
)paren
(brace
r_struct
id|speedo_mc_block
op_star
id|t
suffix:semicolon
id|t
op_assign
id|sp-&gt;mc_setup_head-&gt;next
suffix:semicolon
id|kfree
c_func
(paren
id|sp-&gt;mc_setup_head
)paren
suffix:semicolon
id|sp-&gt;mc_setup_head
op_assign
id|t
suffix:semicolon
)brace
id|sp-&gt;mc_setup_tail
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
id|speedo_debug
OG
l_int|0
)paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%s: %d multicast blocks dropped.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|i
)paren
suffix:semicolon
id|pci_set_power_state
c_func
(paren
id|sp-&gt;pdev
comma
l_int|2
)paren
suffix:semicolon
id|MOD_DEC_USE_COUNT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* The Speedo-3 has an especially awkward and unusable method of getting&n;   statistics out of the chip.  It takes an unpredictable length of time&n;   for the dump-stats command to complete.  To avoid a busy-wait loop we&n;   update the stats with the previous dump results, and then trigger a&n;   new dump.&n;&n;   Oh, and incoming frames are dropped while executing dump-stats!&n;   */
r_static
r_struct
id|net_device_stats
op_star
DECL|function|speedo_get_stats
id|speedo_get_stats
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|speedo_private
op_star
id|sp
op_assign
(paren
r_struct
id|speedo_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_int
id|ioaddr
op_assign
id|dev-&gt;base_addr
suffix:semicolon
multiline_comment|/* Update only if the previous dump finished. */
r_if
c_cond
(paren
id|sp-&gt;lstats-&gt;done_marker
op_eq
id|le32_to_cpu
c_func
(paren
l_int|0xA007
)paren
)paren
(brace
id|sp-&gt;stats.tx_aborted_errors
op_add_assign
id|le32_to_cpu
c_func
(paren
id|sp-&gt;lstats-&gt;tx_coll16_errs
)paren
suffix:semicolon
id|sp-&gt;stats.tx_window_errors
op_add_assign
id|le32_to_cpu
c_func
(paren
id|sp-&gt;lstats-&gt;tx_late_colls
)paren
suffix:semicolon
id|sp-&gt;stats.tx_fifo_errors
op_add_assign
id|le32_to_cpu
c_func
(paren
id|sp-&gt;lstats-&gt;tx_underruns
)paren
suffix:semicolon
id|sp-&gt;stats.tx_fifo_errors
op_add_assign
id|le32_to_cpu
c_func
(paren
id|sp-&gt;lstats-&gt;tx_lost_carrier
)paren
suffix:semicolon
multiline_comment|/*sp-&gt;stats.tx_deferred += le32_to_cpu(sp-&gt;lstats-&gt;tx_deferred);*/
id|sp-&gt;stats.collisions
op_add_assign
id|le32_to_cpu
c_func
(paren
id|sp-&gt;lstats-&gt;tx_total_colls
)paren
suffix:semicolon
id|sp-&gt;stats.rx_crc_errors
op_add_assign
id|le32_to_cpu
c_func
(paren
id|sp-&gt;lstats-&gt;rx_crc_errs
)paren
suffix:semicolon
id|sp-&gt;stats.rx_frame_errors
op_add_assign
id|le32_to_cpu
c_func
(paren
id|sp-&gt;lstats-&gt;rx_align_errs
)paren
suffix:semicolon
id|sp-&gt;stats.rx_over_errors
op_add_assign
id|le32_to_cpu
c_func
(paren
id|sp-&gt;lstats-&gt;rx_resource_errs
)paren
suffix:semicolon
id|sp-&gt;stats.rx_fifo_errors
op_add_assign
id|le32_to_cpu
c_func
(paren
id|sp-&gt;lstats-&gt;rx_overrun_errs
)paren
suffix:semicolon
id|sp-&gt;stats.rx_length_errors
op_add_assign
id|le32_to_cpu
c_func
(paren
id|sp-&gt;lstats-&gt;rx_runt_errs
)paren
suffix:semicolon
id|sp-&gt;lstats-&gt;done_marker
op_assign
l_int|0x0000
suffix:semicolon
r_if
c_cond
(paren
id|netif_running
c_func
(paren
id|dev
)paren
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
multiline_comment|/* Take a spinlock to make wait_for_cmd_done and sending the&n;&t;&t;&t;   command atomic.  --SAW */
id|spin_lock_irqsave
c_func
(paren
op_amp
id|sp-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|wait_for_cmd_done
c_func
(paren
id|ioaddr
op_plus
id|SCBCmd
)paren
suffix:semicolon
id|outb
c_func
(paren
id|CUDumpStats
comma
id|ioaddr
op_plus
id|SCBCmd
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|sp-&gt;lock
comma
id|flags
)paren
suffix:semicolon
)brace
)brace
r_return
op_amp
id|sp-&gt;stats
suffix:semicolon
)brace
DECL|function|speedo_ioctl
r_static
r_int
id|speedo_ioctl
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_struct
id|ifreq
op_star
id|rq
comma
r_int
id|cmd
)paren
(brace
r_struct
id|speedo_private
op_star
id|sp
op_assign
(paren
r_struct
id|speedo_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_int
id|ioaddr
op_assign
id|dev-&gt;base_addr
suffix:semicolon
id|u16
op_star
id|data
op_assign
(paren
id|u16
op_star
)paren
op_amp
id|rq-&gt;ifr_data
suffix:semicolon
r_int
id|phy
op_assign
id|sp-&gt;phy
(braket
l_int|0
)braket
op_amp
l_int|0x1f
suffix:semicolon
r_int
id|saved_acpi
suffix:semicolon
r_int
id|t
suffix:semicolon
r_switch
c_cond
(paren
id|cmd
)paren
(brace
r_case
id|SIOCDEVPRIVATE
suffix:colon
multiline_comment|/* Get the address of the PHY in use. */
id|data
(braket
l_int|0
)braket
op_assign
id|phy
suffix:semicolon
r_case
id|SIOCDEVPRIVATE
op_plus
l_int|1
suffix:colon
multiline_comment|/* Read the specified MII register. */
multiline_comment|/* FIXME: these operations need to be serialized with MDIO&n;&t;&t;   access from the timeout handler.&n;&t;&t;   They are currently serialized only with MDIO access from the&n;&t;&t;   timer routine.  2000/05/09 SAW */
id|saved_acpi
op_assign
id|pci_set_power_state
c_func
(paren
id|sp-&gt;pdev
comma
l_int|0
)paren
suffix:semicolon
id|t
op_assign
id|del_timer_sync
c_func
(paren
op_amp
id|sp-&gt;timer
)paren
suffix:semicolon
id|data
(braket
l_int|3
)braket
op_assign
id|mdio_read
c_func
(paren
id|ioaddr
comma
id|data
(braket
l_int|0
)braket
comma
id|data
(braket
l_int|1
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
id|t
)paren
id|add_timer
c_func
(paren
op_amp
id|sp-&gt;timer
)paren
suffix:semicolon
multiline_comment|/* may be set to the past  --SAW */
id|pci_set_power_state
c_func
(paren
id|sp-&gt;pdev
comma
id|saved_acpi
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
r_case
id|SIOCDEVPRIVATE
op_plus
l_int|2
suffix:colon
multiline_comment|/* Write the specified MII register */
r_if
c_cond
(paren
op_logical_neg
id|capable
c_func
(paren
id|CAP_NET_ADMIN
)paren
)paren
r_return
op_minus
id|EPERM
suffix:semicolon
id|saved_acpi
op_assign
id|pci_set_power_state
c_func
(paren
id|sp-&gt;pdev
comma
l_int|0
)paren
suffix:semicolon
id|t
op_assign
id|del_timer_sync
c_func
(paren
op_amp
id|sp-&gt;timer
)paren
suffix:semicolon
id|mdio_write
c_func
(paren
id|ioaddr
comma
id|data
(braket
l_int|0
)braket
comma
id|data
(braket
l_int|1
)braket
comma
id|data
(braket
l_int|2
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
id|t
)paren
id|add_timer
c_func
(paren
op_amp
id|sp-&gt;timer
)paren
suffix:semicolon
multiline_comment|/* may be set to the past  --SAW */
id|pci_set_power_state
c_func
(paren
id|sp-&gt;pdev
comma
id|saved_acpi
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
r_default
suffix:colon
r_return
op_minus
id|EOPNOTSUPP
suffix:semicolon
)brace
)brace
multiline_comment|/* Set or clear the multicast filter for this adaptor.&n;   This is very ugly with Intel chips -- we usually have to execute an&n;   entire configuration command, plus process a multicast command.&n;   This is complicated.  We must put a large configuration command and&n;   an arbitrarily-sized multicast command in the transmit list.&n;   To minimize the disruption -- the previous command might have already&n;   loaded the link -- we convert the current command block, normally a Tx&n;   command, into a no-op and link it to the new command.&n;*/
DECL|function|set_rx_mode
r_static
r_void
id|set_rx_mode
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|speedo_private
op_star
id|sp
op_assign
(paren
r_struct
id|speedo_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_int
id|ioaddr
op_assign
id|dev-&gt;base_addr
suffix:semicolon
r_struct
id|descriptor
op_star
id|last_cmd
suffix:semicolon
r_char
id|new_rx_mode
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_int
id|entry
comma
id|i
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;flags
op_amp
id|IFF_PROMISC
)paren
(brace
multiline_comment|/* Set promiscuous. */
id|new_rx_mode
op_assign
l_int|3
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
(paren
id|dev-&gt;flags
op_amp
id|IFF_ALLMULTI
)paren
op_logical_or
id|dev-&gt;mc_count
OG
id|multicast_filter_limit
)paren
(brace
id|new_rx_mode
op_assign
l_int|1
suffix:semicolon
)brace
r_else
id|new_rx_mode
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|speedo_debug
OG
l_int|3
)paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%s: set_rx_mode %d -&gt; %d&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|sp-&gt;rx_mode
comma
id|new_rx_mode
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
r_int
)paren
(paren
id|sp-&gt;cur_tx
op_minus
id|sp-&gt;dirty_tx
)paren
OG
id|TX_RING_SIZE
op_minus
id|TX_MULTICAST_SIZE
)paren
(brace
multiline_comment|/* The Tx ring is full -- don&squot;t add anything!  Hope the mode will be&n;&t;&t; * set again later. */
id|sp-&gt;rx_mode
op_assign
op_minus
l_int|1
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|new_rx_mode
op_ne
id|sp-&gt;rx_mode
)paren
(brace
id|u8
op_star
id|config_cmd_data
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|sp-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|entry
op_assign
id|sp-&gt;cur_tx
op_increment
op_mod
id|TX_RING_SIZE
suffix:semicolon
id|last_cmd
op_assign
id|sp-&gt;last_cmd
suffix:semicolon
id|sp-&gt;last_cmd
op_assign
(paren
r_struct
id|descriptor
op_star
)paren
op_amp
id|sp-&gt;tx_ring
(braket
id|entry
)braket
suffix:semicolon
id|sp-&gt;tx_skbuff
(braket
id|entry
)braket
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Redundant. */
id|sp-&gt;tx_ring
(braket
id|entry
)braket
dot
id|status
op_assign
id|cpu_to_le32
c_func
(paren
id|CmdSuspend
op_or
id|CmdConfigure
)paren
suffix:semicolon
id|sp-&gt;tx_ring
(braket
id|entry
)braket
dot
id|link
op_assign
id|cpu_to_le32
c_func
(paren
id|TX_RING_ELEM_DMA
c_func
(paren
id|sp
comma
(paren
id|entry
op_plus
l_int|1
)paren
op_mod
id|TX_RING_SIZE
)paren
)paren
suffix:semicolon
id|config_cmd_data
op_assign
(paren
r_void
op_star
)paren
op_amp
id|sp-&gt;tx_ring
(braket
id|entry
)braket
dot
id|tx_desc_addr
suffix:semicolon
multiline_comment|/* Construct a full CmdConfig frame. */
id|memcpy
c_func
(paren
id|config_cmd_data
comma
id|i82558_config_cmd
comma
id|CONFIG_DATA_SIZE
)paren
suffix:semicolon
id|config_cmd_data
(braket
l_int|1
)braket
op_assign
(paren
id|txfifo
op_lshift
l_int|4
)paren
op_or
id|rxfifo
suffix:semicolon
id|config_cmd_data
(braket
l_int|4
)braket
op_assign
id|rxdmacount
suffix:semicolon
id|config_cmd_data
(braket
l_int|5
)braket
op_assign
id|txdmacount
op_plus
l_int|0x80
suffix:semicolon
id|config_cmd_data
(braket
l_int|15
)braket
op_or_assign
(paren
id|new_rx_mode
op_amp
l_int|2
)paren
ques
c_cond
l_int|1
suffix:colon
l_int|0
suffix:semicolon
multiline_comment|/* 0x80 doesn&squot;t disable FC 0x84 does.&n;&t;&t;   Disable Flow control since we are not ACK-ing any FC interrupts&n;&t;&t;   for now. --Dragan */
id|config_cmd_data
(braket
l_int|19
)braket
op_assign
l_int|0x84
suffix:semicolon
id|config_cmd_data
(braket
l_int|19
)braket
op_or_assign
id|sp-&gt;full_duplex
ques
c_cond
l_int|0x40
suffix:colon
l_int|0
suffix:semicolon
id|config_cmd_data
(braket
l_int|21
)braket
op_assign
(paren
id|new_rx_mode
op_amp
l_int|1
)paren
ques
c_cond
l_int|0x0D
suffix:colon
l_int|0x05
suffix:semicolon
r_if
c_cond
(paren
id|sp-&gt;phy
(braket
l_int|0
)braket
op_amp
l_int|0x8000
)paren
(brace
multiline_comment|/* Use the AUI port instead. */
id|config_cmd_data
(braket
l_int|15
)braket
op_or_assign
l_int|0x80
suffix:semicolon
id|config_cmd_data
(braket
l_int|8
)braket
op_assign
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Trigger the command unit resume. */
id|wait_for_cmd_done
c_func
(paren
id|ioaddr
op_plus
id|SCBCmd
)paren
suffix:semicolon
id|clear_suspend
c_func
(paren
id|last_cmd
)paren
suffix:semicolon
id|outb
c_func
(paren
id|CUResume
comma
id|ioaddr
op_plus
id|SCBCmd
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
r_int
)paren
(paren
id|sp-&gt;cur_tx
op_minus
id|sp-&gt;dirty_tx
)paren
op_ge
id|TX_QUEUE_LIMIT
)paren
(brace
id|netif_stop_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
id|sp-&gt;tx_full
op_assign
l_int|1
suffix:semicolon
)brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|sp-&gt;lock
comma
id|flags
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|new_rx_mode
op_eq
l_int|0
op_logical_and
id|dev-&gt;mc_count
OL
l_int|4
)paren
(brace
multiline_comment|/* The simple case of 0-3 multicast list entries occurs often, and&n;&t;&t;   fits within one tx_ring[] entry. */
r_struct
id|dev_mc_list
op_star
id|mclist
suffix:semicolon
id|u16
op_star
id|setup_params
comma
op_star
id|eaddrs
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|sp-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|entry
op_assign
id|sp-&gt;cur_tx
op_increment
op_mod
id|TX_RING_SIZE
suffix:semicolon
id|last_cmd
op_assign
id|sp-&gt;last_cmd
suffix:semicolon
id|sp-&gt;last_cmd
op_assign
(paren
r_struct
id|descriptor
op_star
)paren
op_amp
id|sp-&gt;tx_ring
(braket
id|entry
)braket
suffix:semicolon
id|sp-&gt;tx_skbuff
(braket
id|entry
)braket
op_assign
l_int|0
suffix:semicolon
id|sp-&gt;tx_ring
(braket
id|entry
)braket
dot
id|status
op_assign
id|cpu_to_le32
c_func
(paren
id|CmdSuspend
op_or
id|CmdMulticastList
)paren
suffix:semicolon
id|sp-&gt;tx_ring
(braket
id|entry
)braket
dot
id|link
op_assign
id|cpu_to_le32
c_func
(paren
id|TX_RING_ELEM_DMA
c_func
(paren
id|sp
comma
(paren
id|entry
op_plus
l_int|1
)paren
op_mod
id|TX_RING_SIZE
)paren
)paren
suffix:semicolon
id|sp-&gt;tx_ring
(braket
id|entry
)braket
dot
id|tx_desc_addr
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Really MC list count. */
id|setup_params
op_assign
(paren
id|u16
op_star
)paren
op_amp
id|sp-&gt;tx_ring
(braket
id|entry
)braket
dot
id|tx_desc_addr
suffix:semicolon
op_star
id|setup_params
op_increment
op_assign
id|cpu_to_le16
c_func
(paren
id|dev-&gt;mc_count
op_star
l_int|6
)paren
suffix:semicolon
multiline_comment|/* Fill in the multicast addresses. */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
comma
id|mclist
op_assign
id|dev-&gt;mc_list
suffix:semicolon
id|i
OL
id|dev-&gt;mc_count
suffix:semicolon
id|i
op_increment
comma
id|mclist
op_assign
id|mclist-&gt;next
)paren
(brace
id|eaddrs
op_assign
(paren
id|u16
op_star
)paren
id|mclist-&gt;dmi_addr
suffix:semicolon
op_star
id|setup_params
op_increment
op_assign
op_star
id|eaddrs
op_increment
suffix:semicolon
op_star
id|setup_params
op_increment
op_assign
op_star
id|eaddrs
op_increment
suffix:semicolon
op_star
id|setup_params
op_increment
op_assign
op_star
id|eaddrs
op_increment
suffix:semicolon
)brace
id|wait_for_cmd_done
c_func
(paren
id|ioaddr
op_plus
id|SCBCmd
)paren
suffix:semicolon
id|clear_suspend
c_func
(paren
id|last_cmd
)paren
suffix:semicolon
multiline_comment|/* Immediately trigger the command unit resume. */
id|outb
c_func
(paren
id|CUResume
comma
id|ioaddr
op_plus
id|SCBCmd
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
r_int
)paren
(paren
id|sp-&gt;cur_tx
op_minus
id|sp-&gt;dirty_tx
)paren
op_ge
id|TX_QUEUE_LIMIT
)paren
(brace
id|netif_stop_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
id|sp-&gt;tx_full
op_assign
l_int|1
suffix:semicolon
)brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|sp-&gt;lock
comma
id|flags
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|new_rx_mode
op_eq
l_int|0
)paren
(brace
r_struct
id|dev_mc_list
op_star
id|mclist
suffix:semicolon
id|u16
op_star
id|setup_params
comma
op_star
id|eaddrs
suffix:semicolon
r_struct
id|speedo_mc_block
op_star
id|mc_blk
suffix:semicolon
r_struct
id|descriptor
op_star
id|mc_setup_frm
suffix:semicolon
r_int
id|i
suffix:semicolon
id|mc_blk
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
op_star
id|mc_blk
)paren
op_plus
l_int|2
op_plus
id|multicast_filter_limit
op_star
l_int|6
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mc_blk
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: Failed to allocate a setup frame.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|sp-&gt;rx_mode
op_assign
op_minus
l_int|1
suffix:semicolon
multiline_comment|/* We failed, try again. */
r_return
suffix:semicolon
)brace
id|mc_blk-&gt;next
op_assign
l_int|NULL
suffix:semicolon
id|mc_blk-&gt;len
op_assign
l_int|2
op_plus
id|multicast_filter_limit
op_star
l_int|6
suffix:semicolon
id|mc_blk-&gt;frame_dma
op_assign
id|pci_map_single
c_func
(paren
id|sp-&gt;pdev
comma
op_amp
id|mc_blk-&gt;frame
comma
id|mc_blk-&gt;len
comma
id|PCI_DMA_TODEVICE
)paren
suffix:semicolon
id|mc_setup_frm
op_assign
op_amp
id|mc_blk-&gt;frame
suffix:semicolon
multiline_comment|/* Fill the setup frame. */
r_if
c_cond
(paren
id|speedo_debug
OG
l_int|1
)paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%s: Constructing a setup frame at %p.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|mc_setup_frm
)paren
suffix:semicolon
id|mc_setup_frm-&gt;cmd_status
op_assign
id|cpu_to_le32
c_func
(paren
id|CmdSuspend
op_or
id|CmdIntr
op_or
id|CmdMulticastList
)paren
suffix:semicolon
multiline_comment|/* Link set below. */
id|setup_params
op_assign
(paren
id|u16
op_star
)paren
op_amp
id|mc_setup_frm-&gt;params
suffix:semicolon
op_star
id|setup_params
op_increment
op_assign
id|cpu_to_le16
c_func
(paren
id|dev-&gt;mc_count
op_star
l_int|6
)paren
suffix:semicolon
multiline_comment|/* Fill in the multicast addresses. */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
comma
id|mclist
op_assign
id|dev-&gt;mc_list
suffix:semicolon
id|i
OL
id|dev-&gt;mc_count
suffix:semicolon
id|i
op_increment
comma
id|mclist
op_assign
id|mclist-&gt;next
)paren
(brace
id|eaddrs
op_assign
(paren
id|u16
op_star
)paren
id|mclist-&gt;dmi_addr
suffix:semicolon
op_star
id|setup_params
op_increment
op_assign
op_star
id|eaddrs
op_increment
suffix:semicolon
op_star
id|setup_params
op_increment
op_assign
op_star
id|eaddrs
op_increment
suffix:semicolon
op_star
id|setup_params
op_increment
op_assign
op_star
id|eaddrs
op_increment
suffix:semicolon
)brace
multiline_comment|/* Disable interrupts while playing with the Tx Cmd list. */
id|spin_lock_irqsave
c_func
(paren
op_amp
id|sp-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sp-&gt;mc_setup_tail
)paren
id|sp-&gt;mc_setup_tail-&gt;next
op_assign
id|mc_blk
suffix:semicolon
r_else
id|sp-&gt;mc_setup_head
op_assign
id|mc_blk
suffix:semicolon
id|sp-&gt;mc_setup_tail
op_assign
id|mc_blk
suffix:semicolon
id|mc_blk-&gt;tx
op_assign
id|sp-&gt;cur_tx
suffix:semicolon
id|entry
op_assign
id|sp-&gt;cur_tx
op_increment
op_mod
id|TX_RING_SIZE
suffix:semicolon
id|last_cmd
op_assign
id|sp-&gt;last_cmd
suffix:semicolon
id|sp-&gt;last_cmd
op_assign
id|mc_setup_frm
suffix:semicolon
multiline_comment|/* Change the command to a NoOp, pointing to the CmdMulti command. */
id|sp-&gt;tx_skbuff
(braket
id|entry
)braket
op_assign
l_int|0
suffix:semicolon
id|sp-&gt;tx_ring
(braket
id|entry
)braket
dot
id|status
op_assign
id|cpu_to_le32
c_func
(paren
id|CmdNOp
)paren
suffix:semicolon
id|sp-&gt;tx_ring
(braket
id|entry
)braket
dot
id|link
op_assign
id|cpu_to_le32
c_func
(paren
id|mc_blk-&gt;frame_dma
)paren
suffix:semicolon
multiline_comment|/* Set the link in the setup frame. */
id|mc_setup_frm-&gt;link
op_assign
id|cpu_to_le32
c_func
(paren
id|TX_RING_ELEM_DMA
c_func
(paren
id|sp
comma
(paren
id|entry
op_plus
l_int|1
)paren
op_mod
id|TX_RING_SIZE
)paren
)paren
suffix:semicolon
id|pci_dma_sync_single
c_func
(paren
id|sp-&gt;pdev
comma
id|mc_blk-&gt;frame_dma
comma
id|mc_blk-&gt;len
comma
id|PCI_DMA_TODEVICE
)paren
suffix:semicolon
id|wait_for_cmd_done
c_func
(paren
id|ioaddr
op_plus
id|SCBCmd
)paren
suffix:semicolon
id|clear_suspend
c_func
(paren
id|last_cmd
)paren
suffix:semicolon
multiline_comment|/* Immediately trigger the command unit resume. */
id|outb
c_func
(paren
id|CUResume
comma
id|ioaddr
op_plus
id|SCBCmd
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
r_int
)paren
(paren
id|sp-&gt;cur_tx
op_minus
id|sp-&gt;dirty_tx
)paren
op_ge
id|TX_QUEUE_LIMIT
)paren
(brace
id|netif_stop_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
id|sp-&gt;tx_full
op_assign
l_int|1
suffix:semicolon
)brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|sp-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|speedo_debug
OG
l_int|5
)paren
id|printk
c_func
(paren
l_string|&quot; CmdMCSetup frame length %d in entry %d.&bslash;n&quot;
comma
id|dev-&gt;mc_count
comma
id|entry
)paren
suffix:semicolon
)brace
id|sp-&gt;rx_mode
op_assign
id|new_rx_mode
suffix:semicolon
)brace
"&f;"
macro_line|#ifdef CONFIG_EEPRO100_PM
DECL|function|eepro100_suspend
r_static
r_void
id|eepro100_suspend
c_func
(paren
r_struct
id|pci_dev
op_star
id|pdev
)paren
(brace
r_struct
id|net_device
op_star
id|dev
op_assign
id|pdev-&gt;driver_data
suffix:semicolon
r_int
id|ioaddr
op_assign
id|dev-&gt;base_addr
suffix:semicolon
id|netif_device_detach
c_func
(paren
id|dev
)paren
suffix:semicolon
id|outl
c_func
(paren
id|PortPartialReset
comma
id|ioaddr
op_plus
id|SCBPort
)paren
suffix:semicolon
multiline_comment|/* XXX call pci_set_power_state ()? */
)brace
DECL|function|eepro100_resume
r_static
r_void
id|eepro100_resume
c_func
(paren
r_struct
id|pci_dev
op_star
id|pdev
)paren
(brace
r_struct
id|net_device
op_star
id|dev
op_assign
id|pdev-&gt;driver_data
suffix:semicolon
r_struct
id|speedo_private
op_star
id|sp
op_assign
(paren
r_struct
id|speedo_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_int
id|ioaddr
op_assign
id|dev-&gt;base_addr
suffix:semicolon
multiline_comment|/* I&squot;m absolutely uncertain if this part of code may work.&n;&t;   The problems are:&n;&t;    - correct hardware reinitialization;&n;&t;&t;- correct driver behavior between different steps of the&n;&t;&t;  reinitialization;&n;&t;&t;- serialization with other driver calls.&n;&t;   2000/03/08  SAW */
id|outw
c_func
(paren
id|SCBMaskAll
comma
id|ioaddr
op_plus
id|SCBCmd
)paren
suffix:semicolon
id|speedo_resume
c_func
(paren
id|dev
)paren
suffix:semicolon
id|netif_device_attach
c_func
(paren
id|dev
)paren
suffix:semicolon
id|sp-&gt;rx_mode
op_assign
op_minus
l_int|1
suffix:semicolon
id|sp-&gt;flow_ctrl
op_assign
id|sp-&gt;partner
op_assign
l_int|0
suffix:semicolon
id|set_rx_mode
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
macro_line|#endif /* CONFIG_EEPRO100_PM */
DECL|function|eepro100_remove_one
r_static
r_void
id|__devexit
id|eepro100_remove_one
(paren
r_struct
id|pci_dev
op_star
id|pdev
)paren
(brace
r_struct
id|net_device
op_star
id|dev
op_assign
id|pdev-&gt;driver_data
suffix:semicolon
r_struct
id|speedo_private
op_star
id|sp
op_assign
(paren
r_struct
id|speedo_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|unregister_netdev
c_func
(paren
id|dev
)paren
suffix:semicolon
id|release_region
c_func
(paren
id|pci_resource_start
c_func
(paren
id|pdev
comma
l_int|1
)paren
comma
id|pci_resource_len
c_func
(paren
id|pdev
comma
l_int|1
)paren
)paren
suffix:semicolon
id|release_mem_region
c_func
(paren
id|pci_resource_start
c_func
(paren
id|pdev
comma
l_int|0
)paren
comma
id|pci_resource_len
c_func
(paren
id|pdev
comma
l_int|0
)paren
)paren
suffix:semicolon
macro_line|#ifndef USE_IO
id|iounmap
c_func
(paren
(paren
r_char
op_star
)paren
id|dev-&gt;base_addr
)paren
suffix:semicolon
macro_line|#endif
id|pci_free_consistent
c_func
(paren
id|pdev
comma
id|TX_RING_SIZE
op_star
r_sizeof
(paren
r_struct
id|TxFD
)paren
op_plus
r_sizeof
(paren
r_struct
id|speedo_stats
)paren
comma
id|sp-&gt;tx_ring
comma
id|sp-&gt;tx_ring_dma
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
"&f;"
DECL|variable|__devinitdata
r_static
r_struct
id|pci_device_id
id|eepro100_pci_tbl
(braket
)braket
id|__devinitdata
op_assign
(brace
(brace
id|PCI_VENDOR_ID_INTEL
comma
id|PCI_DEVICE_ID_INTEL_82557
comma
id|PCI_ANY_ID
comma
id|PCI_ANY_ID
comma
)brace
comma
(brace
id|PCI_VENDOR_ID_INTEL
comma
id|PCI_DEVICE_ID_INTEL_82559ER
comma
id|PCI_ANY_ID
comma
id|PCI_ANY_ID
comma
)brace
comma
(brace
id|PCI_VENDOR_ID_INTEL
comma
id|PCI_DEVICE_ID_INTEL_ID1029
comma
id|PCI_ANY_ID
comma
id|PCI_ANY_ID
comma
)brace
comma
(brace
id|PCI_VENDOR_ID_INTEL
comma
id|PCI_DEVICE_ID_INTEL_ID1030
comma
id|PCI_ANY_ID
comma
id|PCI_ANY_ID
comma
)brace
comma
(brace
id|PCI_VENDOR_ID_INTEL
comma
id|PCI_DEVICE_ID_INTEL_82820FW_4
comma
id|PCI_ANY_ID
comma
id|PCI_ANY_ID
comma
)brace
comma
(brace
l_int|0
comma
)brace
)brace
suffix:semicolon
id|MODULE_DEVICE_TABLE
c_func
(paren
id|pci
comma
id|eepro100_pci_tbl
)paren
suffix:semicolon
DECL|variable|eepro100_driver
r_static
r_struct
id|pci_driver
id|eepro100_driver
op_assign
(brace
id|name
suffix:colon
l_string|&quot;eepro100&quot;
comma
id|id_table
suffix:colon
id|eepro100_pci_tbl
comma
id|probe
suffix:colon
id|eepro100_init_one
comma
id|remove
suffix:colon
id|eepro100_remove_one
comma
macro_line|#ifdef CONFIG_EEPRO100_PM
id|suspend
suffix:colon
id|eepro100_suspend
comma
id|resume
suffix:colon
id|eepro100_resume
comma
macro_line|#endif
)brace
suffix:semicolon
macro_line|#if LINUX_VERSION_CODE &lt; KERNEL_VERSION(2,3,48)
DECL|function|pci_module_init
r_static
r_int
id|pci_module_init
c_func
(paren
r_struct
id|pci_driver
op_star
id|pdev
)paren
(brace
r_int
id|rc
suffix:semicolon
id|rc
op_assign
id|pci_register_driver
c_func
(paren
id|pdev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
op_le
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: No cards found, driver not installed.&bslash;n&quot;
comma
id|pdev-&gt;name
)paren
suffix:semicolon
id|pci_unregister_driver
c_func
(paren
id|pdev
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#endif
DECL|function|eepro100_init_module
r_static
r_int
id|__init
id|eepro100_init_module
c_func
(paren
r_void
)paren
(brace
r_if
c_cond
(paren
id|debug
op_ge
l_int|0
op_logical_and
id|speedo_debug
op_ne
id|debug
)paren
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;eepro100.c: Debug level is %d.&bslash;n&quot;
comma
id|debug
)paren
suffix:semicolon
r_if
c_cond
(paren
id|debug
op_ge
l_int|0
)paren
id|speedo_debug
op_assign
id|debug
suffix:semicolon
r_return
id|pci_module_init
c_func
(paren
op_amp
id|eepro100_driver
)paren
suffix:semicolon
)brace
DECL|function|eepro100_cleanup_module
r_static
r_void
id|__exit
id|eepro100_cleanup_module
c_func
(paren
r_void
)paren
(brace
id|pci_unregister_driver
c_func
(paren
op_amp
id|eepro100_driver
)paren
suffix:semicolon
)brace
DECL|variable|eepro100_init_module
id|module_init
c_func
(paren
id|eepro100_init_module
)paren
suffix:semicolon
DECL|variable|eepro100_cleanup_module
id|module_exit
c_func
(paren
id|eepro100_cleanup_module
)paren
suffix:semicolon
"&f;"
multiline_comment|/*&n; * Local variables:&n; *  compile-command: &quot;gcc -DMODULE -D__KERNEL__ -I/usr/src/linux/net/inet -Wall -Wstrict-prototypes -O6 -c eepro100.c `[ -f /usr/include/linux/modversions.h ] &amp;&amp; echo -DMODVERSIONS`&quot;&n; *  c-indent-level: 4&n; *  c-basic-offset: 4&n; *  tab-width: 4&n; * End:&n; */
eof
