multiline_comment|/*****************************************************************************/
multiline_comment|/*&n; *&t;sm_wss.c  -- soundcard radio modem driver, WSS (half duplex) driver&n; *&n; *&t;Copyright (C) 1996  Thomas Sailer (sailer@ife.ee.ethz.ch)&n; *&n; *&t;This program is free software; you can redistribute it and/or modify&n; *&t;it under the terms of the GNU General Public License as published by&n; *&t;the Free Software Foundation; either version 2 of the License, or&n; *&t;(at your option) any later version.&n; *&n; *&t;This program is distributed in the hope that it will be useful,&n; *&t;but WITHOUT ANY WARRANTY; without even the implied warranty of&n; *&t;MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the&n; *&t;GNU General Public License for more details.&n; *&n; *&t;You should have received a copy of the GNU General Public License&n; *&t;along with this program; if not, write to the Free Software&n; *&t;Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.&n; *&n; *  Please note that the GPL allows you to use the driver, NOT the radio.&n; *  In order to use the radio, you need a license from the communications&n; *  authority of your country.&n; *&n; */
macro_line|#include &lt;linux/ptrace.h&gt;
macro_line|#include &lt;linux/interrupt.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/dma.h&gt;
macro_line|#include &lt;linux/ioport.h&gt;
macro_line|#include &lt;linux/soundmodem.h&gt;
macro_line|#include &quot;sm.h&quot;
multiline_comment|/* --------------------------------------------------------------------- */
multiline_comment|/*&n; * currently this module is supposed to support both module styles, i.e.&n; * the old one present up to about 2.1.9, and the new one functioning&n; * starting with 2.1.21. The reason is I have a kit allowing to compile&n; * this module also under 2.0.x which was requested by several people.&n; * This will go in 2.2&n; */
macro_line|#include &lt;linux/version.h&gt;
macro_line|#if LINUX_VERSION_CODE &gt;= 0x20100
macro_line|#include &lt;asm/uaccess.h&gt;
macro_line|#else
macro_line|#include &lt;asm/segment.h&gt;
macro_line|#include &lt;linux/mm.h&gt;
DECL|macro|put_user
macro_line|#undef put_user
DECL|macro|get_user
macro_line|#undef get_user
DECL|macro|put_user
mdefine_line|#define put_user(x,ptr) ({ __put_user((unsigned long)(x),(ptr),sizeof(*(ptr))); 0; })
DECL|macro|get_user
mdefine_line|#define get_user(x,ptr) ({ x = ((__typeof__(*(ptr)))__get_user((ptr),sizeof(*(ptr)))); 0; })
DECL|function|copy_from_user
r_extern
r_inline
r_int
id|copy_from_user
c_func
(paren
r_void
op_star
id|to
comma
r_const
r_void
op_star
id|from
comma
r_int
r_int
id|n
)paren
(brace
r_int
id|i
op_assign
id|verify_area
c_func
(paren
id|VERIFY_READ
comma
id|from
comma
id|n
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
)paren
r_return
id|i
suffix:semicolon
id|memcpy_fromfs
c_func
(paren
id|to
comma
id|from
comma
id|n
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|copy_to_user
r_extern
r_inline
r_int
id|copy_to_user
c_func
(paren
r_void
op_star
id|to
comma
r_const
r_void
op_star
id|from
comma
r_int
r_int
id|n
)paren
(brace
r_int
id|i
op_assign
id|verify_area
c_func
(paren
id|VERIFY_WRITE
comma
id|to
comma
id|n
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
)paren
r_return
id|i
suffix:semicolon
id|memcpy_tofs
c_func
(paren
id|to
comma
id|from
comma
id|n
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#endif
multiline_comment|/* --------------------------------------------------------------------- */
DECL|struct|sc_state_wss
r_struct
id|sc_state_wss
(brace
DECL|member|revwss
DECL|member|revid
DECL|member|revv
DECL|member|revcid
r_int
r_char
id|revwss
comma
id|revid
comma
id|revv
comma
id|revcid
suffix:semicolon
DECL|member|fmt
r_int
r_char
id|fmt
(braket
l_int|2
)braket
suffix:semicolon
DECL|member|crystal
r_int
r_char
id|crystal
suffix:semicolon
DECL|member|dmabuflen
r_int
r_int
id|dmabuflen
suffix:semicolon
DECL|member|dmabuf
r_int
r_char
op_star
id|dmabuf
suffix:semicolon
DECL|member|dmabufidx
r_int
r_char
id|dmabufidx
suffix:semicolon
DECL|member|ptt
r_int
r_char
id|ptt
suffix:semicolon
multiline_comment|/* Full Duplex extensions */
DECL|member|dmabuf2
r_int
r_char
op_star
id|dmabuf2
suffix:semicolon
)brace
suffix:semicolon
DECL|macro|SCSTATE
mdefine_line|#define SCSTATE ((struct sc_state_wss *)(&amp;sm-&gt;hw))
multiline_comment|/* --------------------------------------------------------------------- */
DECL|macro|WSS_CONFIG
mdefine_line|#define WSS_CONFIG(iobase)       (iobase+0)
DECL|macro|WSS_STATUS
mdefine_line|#define WSS_STATUS(iobase)       (iobase+3)
DECL|macro|WSS_CODEC_IA
mdefine_line|#define WSS_CODEC_IA(iobase)     (iobase+4)
DECL|macro|WSS_CODEC_ID
mdefine_line|#define WSS_CODEC_ID(iobase)     (iobase+5)
DECL|macro|WSS_CODEC_STATUS
mdefine_line|#define WSS_CODEC_STATUS(iobase) (iobase+6)
DECL|macro|WSS_CODEC_DATA
mdefine_line|#define WSS_CODEC_DATA(iobase)   (iobase+7)
DECL|macro|WSS_EXTENT
mdefine_line|#define WSS_EXTENT   8
multiline_comment|/* --------------------------------------------------------------------- */
DECL|function|write_codec
r_static
r_void
id|write_codec
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
r_int
r_char
id|idx
comma
r_int
r_char
id|data
)paren
(brace
r_int
id|timeout
op_assign
l_int|900000
suffix:semicolon
multiline_comment|/* wait until codec ready */
r_while
c_loop
(paren
id|timeout
OG
l_int|0
op_logical_and
id|inb
c_func
(paren
id|WSS_CODEC_IA
c_func
(paren
id|dev-&gt;base_addr
)paren
)paren
op_amp
l_int|0x80
)paren
id|timeout
op_decrement
suffix:semicolon
id|outb
c_func
(paren
id|idx
comma
id|WSS_CODEC_IA
c_func
(paren
id|dev-&gt;base_addr
)paren
)paren
suffix:semicolon
id|outb
c_func
(paren
id|data
comma
id|WSS_CODEC_ID
c_func
(paren
id|dev-&gt;base_addr
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/* --------------------------------------------------------------------- */
DECL|function|read_codec
r_static
r_int
r_char
id|read_codec
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
r_int
r_char
id|idx
)paren
(brace
r_int
id|timeout
op_assign
l_int|900000
suffix:semicolon
multiline_comment|/* wait until codec ready */
r_while
c_loop
(paren
id|timeout
OG
l_int|0
op_logical_and
id|inb
c_func
(paren
id|WSS_CODEC_IA
c_func
(paren
id|dev-&gt;base_addr
)paren
)paren
op_amp
l_int|0x80
)paren
id|timeout
op_decrement
suffix:semicolon
id|outb
c_func
(paren
id|idx
op_amp
l_int|0x1f
comma
id|WSS_CODEC_IA
c_func
(paren
id|dev-&gt;base_addr
)paren
)paren
suffix:semicolon
r_return
id|inb
c_func
(paren
id|WSS_CODEC_ID
c_func
(paren
id|dev-&gt;base_addr
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/* --------------------------------------------------------------------- */
DECL|function|wss_ack_int
r_extern
r_void
r_inline
id|wss_ack_int
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
id|outb
c_func
(paren
l_int|0
comma
id|WSS_CODEC_STATUS
c_func
(paren
id|dev-&gt;base_addr
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/* --------------------------------------------------------------------- */
DECL|variable|wss_srate_tab
r_static
r_int
id|wss_srate_tab
(braket
l_int|16
)braket
op_assign
(brace
l_int|8000
comma
l_int|5510
comma
l_int|16000
comma
l_int|11025
comma
l_int|27420
comma
l_int|18900
comma
l_int|32000
comma
l_int|22050
comma
op_minus
l_int|1
comma
l_int|37800
comma
op_minus
l_int|1
comma
l_int|44100
comma
l_int|48000
comma
l_int|33075
comma
l_int|9600
comma
l_int|6620
)brace
suffix:semicolon
DECL|function|wss_srate_index
r_static
r_int
id|wss_srate_index
c_func
(paren
r_int
id|srate
)paren
(brace
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
(paren
r_sizeof
(paren
id|wss_srate_tab
)paren
op_div
r_sizeof
(paren
id|wss_srate_tab
(braket
l_int|0
)braket
)paren
)paren
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
id|srate
op_eq
id|wss_srate_tab
(braket
id|i
)braket
op_logical_and
id|wss_srate_tab
(braket
id|i
)braket
OG
l_int|0
)paren
r_return
id|i
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
multiline_comment|/* --------------------------------------------------------------------- */
DECL|function|wss_set_codec_fmt
r_static
r_int
id|wss_set_codec_fmt
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
r_struct
id|sm_state
op_star
id|sm
comma
r_int
r_char
id|fmt
comma
r_char
id|fdx
comma
r_char
id|fullcalib
)paren
(brace
r_int
r_int
id|time
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* Clock and data format register */
id|write_codec
c_func
(paren
id|dev
comma
l_int|0x48
comma
id|fmt
)paren
suffix:semicolon
r_if
c_cond
(paren
id|SCSTATE-&gt;crystal
)paren
(brace
id|write_codec
c_func
(paren
id|dev
comma
l_int|0x5c
comma
id|fmt
op_amp
l_int|0xf0
)paren
suffix:semicolon
multiline_comment|/* MCE and interface config reg */
id|write_codec
c_func
(paren
id|dev
comma
l_int|0x49
comma
(paren
id|fdx
ques
c_cond
l_int|0
suffix:colon
l_int|0x4
)paren
op_or
(paren
id|fullcalib
ques
c_cond
l_int|0x18
suffix:colon
l_int|0
)paren
)paren
suffix:semicolon
)brace
r_else
multiline_comment|/* MCE and interface config reg */
id|write_codec
c_func
(paren
id|dev
comma
l_int|0x49
comma
id|fdx
ques
c_cond
l_int|0x8
suffix:colon
l_int|0xc
)paren
suffix:semicolon
id|outb
c_func
(paren
l_int|0xb
comma
id|WSS_CODEC_IA
c_func
(paren
id|dev-&gt;base_addr
)paren
)paren
suffix:semicolon
multiline_comment|/* leave MCE */
multiline_comment|/*&n;&t; * wait for ACI start&n;&t; */
id|time
op_assign
l_int|1000
suffix:semicolon
r_while
c_loop
(paren
op_logical_neg
(paren
id|read_codec
c_func
(paren
id|dev
comma
l_int|0x0b
)paren
op_amp
l_int|0x20
)paren
)paren
r_if
c_cond
(paren
op_logical_neg
(paren
op_decrement
id|time
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: ad1848 auto calibration timed out (1)&bslash;n&quot;
comma
id|sm_drvname
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * wait for ACI end&n;&t; */
id|sti
c_func
(paren
)paren
suffix:semicolon
id|time
op_assign
id|jiffies
op_plus
id|HZ
op_div
l_int|4
suffix:semicolon
r_while
c_loop
(paren
(paren
id|read_codec
c_func
(paren
id|dev
comma
l_int|0x0b
)paren
op_amp
l_int|0x20
)paren
op_logical_and
(paren
(paren
r_int
)paren
(paren
id|jiffies
op_minus
id|time
)paren
OL
l_int|0
)paren
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
r_int
)paren
(paren
id|jiffies
op_minus
id|time
)paren
op_ge
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: ad1848 auto calibration timed out (2)&bslash;n&quot;
comma
id|sm_drvname
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* --------------------------------------------------------------------- */
DECL|function|wss_init_codec
r_static
r_int
id|wss_init_codec
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
r_struct
id|sm_state
op_star
id|sm
comma
r_char
id|fdx
comma
r_int
r_char
id|src_l
comma
r_int
r_char
id|src_r
comma
r_int
id|igain_l
comma
r_int
id|igain_r
comma
r_int
id|ogain_l
comma
r_int
id|ogain_r
)paren
(brace
r_int
r_char
id|tmp
comma
id|reg0
comma
id|reg1
comma
id|reg6
comma
id|reg7
suffix:semicolon
r_static
r_const
r_int
r_char
id|irqtab
(braket
l_int|16
)braket
op_assign
(brace
op_minus
l_int|1
comma
op_minus
l_int|1
comma
l_int|0x10
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
l_int|0x08
comma
op_minus
l_int|1
comma
l_int|0x10
comma
l_int|0x18
comma
l_int|0x20
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
)brace
suffix:semicolon
r_static
r_const
r_int
r_char
id|dmatab
(braket
l_int|4
)braket
op_assign
(brace
l_int|1
comma
l_int|2
comma
op_minus
l_int|1
comma
l_int|3
)brace
suffix:semicolon
id|tmp
op_assign
id|inb
c_func
(paren
id|WSS_STATUS
c_func
(paren
id|dev-&gt;base_addr
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|tmp
op_amp
l_int|0x3f
)paren
op_ne
l_int|0x04
op_logical_and
(paren
id|tmp
op_amp
l_int|0x3f
)paren
op_ne
l_int|0x00
op_logical_and
(paren
id|tmp
op_amp
l_int|0x3f
)paren
op_ne
l_int|0x0f
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;sm: WSS card id register not found, &quot;
l_string|&quot;address 0x%lx, ID register 0x%02x&bslash;n&quot;
comma
id|dev-&gt;base_addr
comma
(paren
r_int
)paren
id|tmp
)paren
suffix:semicolon
multiline_comment|/* return -1; */
id|SCSTATE-&gt;revwss
op_assign
l_int|0
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
(paren
id|tmp
op_amp
l_int|0x80
)paren
op_logical_and
(paren
(paren
id|dev-&gt;dma
op_eq
l_int|0
)paren
op_logical_or
(paren
(paren
id|dev-&gt;irq
op_ge
l_int|8
)paren
op_logical_and
(paren
id|dev-&gt;irq
op_ne
l_int|9
)paren
)paren
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: WSS: DMA0 and/or IRQ8..IRQ15 &quot;
l_string|&quot;(except IRQ9) cannot be used on an 8bit &quot;
l_string|&quot;card&bslash;n&quot;
comma
id|sm_drvname
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|dev-&gt;irq
OG
l_int|15
op_logical_or
id|irqtab
(braket
id|dev-&gt;irq
)braket
op_eq
op_minus
l_int|1
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: WSS: invalid interrupt %d&bslash;n&quot;
comma
id|sm_drvname
comma
(paren
r_int
)paren
id|dev-&gt;irq
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|dev-&gt;dma
OG
l_int|3
op_logical_or
id|dmatab
(braket
id|dev-&gt;dma
)braket
op_eq
op_minus
l_int|1
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: WSS: invalid dma channel %d&bslash;n&quot;
comma
id|sm_drvname
comma
(paren
r_int
)paren
id|dev-&gt;dma
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|tmp
op_assign
id|irqtab
(braket
id|dev-&gt;irq
)braket
op_or
id|dmatab
(braket
id|dev-&gt;dma
)braket
suffix:semicolon
multiline_comment|/* irq probe */
id|outb
c_func
(paren
(paren
id|tmp
op_amp
l_int|0x38
)paren
op_or
l_int|0x40
comma
id|WSS_CONFIG
c_func
(paren
id|dev-&gt;base_addr
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|inb
c_func
(paren
id|WSS_STATUS
c_func
(paren
id|dev-&gt;base_addr
)paren
)paren
op_amp
l_int|0x40
)paren
)paren
(brace
id|outb
c_func
(paren
l_int|0
comma
id|WSS_CONFIG
c_func
(paren
id|dev-&gt;base_addr
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: WSS: IRQ%d is not free!&bslash;n&quot;
comma
id|sm_drvname
comma
id|dev-&gt;irq
)paren
suffix:semicolon
)brace
id|outb
c_func
(paren
id|tmp
comma
id|WSS_CONFIG
c_func
(paren
id|dev-&gt;base_addr
)paren
)paren
suffix:semicolon
id|SCSTATE-&gt;revwss
op_assign
id|inb
c_func
(paren
id|WSS_STATUS
c_func
(paren
id|dev-&gt;base_addr
)paren
)paren
op_amp
l_int|0x3f
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * initialize the codec&n;&t; */
r_if
c_cond
(paren
id|igain_l
OL
l_int|0
)paren
id|igain_l
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|igain_r
OL
l_int|0
)paren
id|igain_r
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|ogain_l
OG
l_int|0
)paren
id|ogain_l
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|ogain_r
OG
l_int|0
)paren
id|ogain_r
op_assign
l_int|0
suffix:semicolon
id|reg0
op_assign
(paren
id|src_l
op_lshift
l_int|6
)paren
op_amp
l_int|0xc0
suffix:semicolon
id|reg1
op_assign
(paren
id|src_r
op_lshift
l_int|6
)paren
op_amp
l_int|0xc0
suffix:semicolon
r_if
c_cond
(paren
id|reg0
op_eq
l_int|0x80
op_logical_and
id|igain_l
op_ge
l_int|20
)paren
(brace
id|reg0
op_or_assign
l_int|0x20
suffix:semicolon
id|igain_l
op_sub_assign
l_int|20
suffix:semicolon
)brace
r_if
c_cond
(paren
id|reg1
op_eq
l_int|0x80
op_logical_and
id|igain_r
op_ge
l_int|20
)paren
(brace
id|reg1
op_or_assign
l_int|0x20
suffix:semicolon
id|igain_r
op_sub_assign
l_int|20
suffix:semicolon
)brace
r_if
c_cond
(paren
id|igain_l
OG
l_int|23
)paren
id|igain_l
op_assign
l_int|23
suffix:semicolon
r_if
c_cond
(paren
id|igain_r
OG
l_int|23
)paren
id|igain_r
op_assign
l_int|23
suffix:semicolon
id|reg0
op_or_assign
id|igain_l
op_star
l_int|2
op_div
l_int|3
suffix:semicolon
id|reg1
op_or_assign
id|igain_r
op_star
l_int|2
op_div
l_int|3
suffix:semicolon
id|reg6
op_assign
(paren
id|ogain_l
OL
op_minus
l_int|95
)paren
ques
c_cond
l_int|0x80
suffix:colon
(paren
id|ogain_l
op_star
(paren
op_minus
l_int|2
)paren
op_div
l_int|3
)paren
suffix:semicolon
id|reg7
op_assign
(paren
id|ogain_r
OL
op_minus
l_int|95
)paren
ques
c_cond
l_int|0x80
suffix:colon
(paren
id|ogain_r
op_star
(paren
op_minus
l_int|2
)paren
op_div
l_int|3
)paren
suffix:semicolon
id|write_codec
c_func
(paren
id|dev
comma
l_int|9
comma
l_int|0
)paren
suffix:semicolon
id|write_codec
c_func
(paren
id|dev
comma
l_int|0
comma
l_int|0x45
)paren
suffix:semicolon
r_if
c_cond
(paren
id|read_codec
c_func
(paren
id|dev
comma
l_int|0
)paren
op_ne
l_int|0x45
)paren
r_goto
id|codec_err
suffix:semicolon
id|write_codec
c_func
(paren
id|dev
comma
l_int|0
comma
l_int|0xaa
)paren
suffix:semicolon
r_if
c_cond
(paren
id|read_codec
c_func
(paren
id|dev
comma
l_int|0
)paren
op_ne
l_int|0xaa
)paren
r_goto
id|codec_err
suffix:semicolon
id|write_codec
c_func
(paren
id|dev
comma
l_int|12
comma
l_int|0x40
)paren
suffix:semicolon
multiline_comment|/* enable MODE2 */
id|write_codec
c_func
(paren
id|dev
comma
l_int|16
comma
l_int|0
)paren
suffix:semicolon
id|write_codec
c_func
(paren
id|dev
comma
l_int|0
comma
l_int|0x45
)paren
suffix:semicolon
id|SCSTATE-&gt;crystal
op_assign
(paren
id|read_codec
c_func
(paren
id|dev
comma
l_int|16
)paren
op_ne
l_int|0x45
)paren
suffix:semicolon
id|write_codec
c_func
(paren
id|dev
comma
l_int|0
comma
l_int|0xaa
)paren
suffix:semicolon
id|SCSTATE-&gt;crystal
op_and_assign
(paren
id|read_codec
c_func
(paren
id|dev
comma
l_int|16
)paren
op_ne
l_int|0xaa
)paren
suffix:semicolon
r_if
c_cond
(paren
id|SCSTATE-&gt;crystal
)paren
(brace
id|SCSTATE-&gt;revcid
op_assign
id|read_codec
c_func
(paren
id|dev
comma
l_int|0x19
)paren
suffix:semicolon
id|SCSTATE-&gt;revv
op_assign
(paren
id|SCSTATE-&gt;revcid
op_rshift
l_int|5
)paren
op_amp
l_int|7
suffix:semicolon
id|SCSTATE-&gt;revcid
op_and_assign
l_int|7
suffix:semicolon
id|write_codec
c_func
(paren
id|dev
comma
l_int|0x10
comma
l_int|0x80
)paren
suffix:semicolon
multiline_comment|/* maximum output level */
id|write_codec
c_func
(paren
id|dev
comma
l_int|0x11
comma
l_int|0x02
)paren
suffix:semicolon
multiline_comment|/* xtal enable and no HPF */
id|write_codec
c_func
(paren
id|dev
comma
l_int|0x12
comma
l_int|0x80
)paren
suffix:semicolon
multiline_comment|/* left line input control */
id|write_codec
c_func
(paren
id|dev
comma
l_int|0x13
comma
l_int|0x80
)paren
suffix:semicolon
multiline_comment|/* right line input control */
id|write_codec
c_func
(paren
id|dev
comma
l_int|0x16
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* disable alternative freq sel */
id|write_codec
c_func
(paren
id|dev
comma
l_int|0x1a
comma
l_int|0xe0
)paren
suffix:semicolon
multiline_comment|/* mono IO disable */
id|write_codec
c_func
(paren
id|dev
comma
l_int|0x1b
comma
l_int|0x00
)paren
suffix:semicolon
multiline_comment|/* left out no att */
id|write_codec
c_func
(paren
id|dev
comma
l_int|0x1d
comma
l_int|0x00
)paren
suffix:semicolon
multiline_comment|/* right out no att */
)brace
r_if
c_cond
(paren
id|wss_set_codec_fmt
c_func
(paren
id|dev
comma
id|sm
comma
id|SCSTATE-&gt;fmt
(braket
l_int|0
)braket
comma
id|fdx
comma
l_int|1
)paren
)paren
r_goto
id|codec_err
suffix:semicolon
id|write_codec
c_func
(paren
id|dev
comma
l_int|0
comma
id|reg0
)paren
suffix:semicolon
multiline_comment|/* left input control */
id|write_codec
c_func
(paren
id|dev
comma
l_int|1
comma
id|reg1
)paren
suffix:semicolon
multiline_comment|/* right input control */
id|write_codec
c_func
(paren
id|dev
comma
l_int|2
comma
l_int|0x80
)paren
suffix:semicolon
multiline_comment|/* left aux#1 input control */
id|write_codec
c_func
(paren
id|dev
comma
l_int|3
comma
l_int|0x80
)paren
suffix:semicolon
multiline_comment|/* right aux#1 input control */
id|write_codec
c_func
(paren
id|dev
comma
l_int|4
comma
l_int|0x80
)paren
suffix:semicolon
multiline_comment|/* left aux#2 input control */
id|write_codec
c_func
(paren
id|dev
comma
l_int|5
comma
l_int|0x80
)paren
suffix:semicolon
multiline_comment|/* right aux#2 input control */
id|write_codec
c_func
(paren
id|dev
comma
l_int|6
comma
id|reg6
)paren
suffix:semicolon
multiline_comment|/* left dac control */
id|write_codec
c_func
(paren
id|dev
comma
l_int|7
comma
id|reg7
)paren
suffix:semicolon
multiline_comment|/* right dac control */
id|write_codec
c_func
(paren
id|dev
comma
l_int|0xa
comma
l_int|0x2
)paren
suffix:semicolon
multiline_comment|/* pin control register */
id|write_codec
c_func
(paren
id|dev
comma
l_int|0xd
comma
l_int|0x0
)paren
suffix:semicolon
multiline_comment|/* digital mix control */
id|SCSTATE-&gt;revid
op_assign
id|read_codec
c_func
(paren
id|dev
comma
l_int|0xc
)paren
op_amp
l_int|0xf
suffix:semicolon
multiline_comment|/*&n;&t; * print revisions&n;&t; */
r_if
c_cond
(paren
id|SCSTATE-&gt;crystal
)paren
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Crystal CODEC ID %d, Chip revision %d, &quot;
l_string|&quot; Chip ID %d&bslash;n&quot;
comma
id|sm_drvname
comma
(paren
r_int
)paren
id|SCSTATE-&gt;revid
comma
(paren
r_int
)paren
id|SCSTATE-&gt;revv
comma
(paren
r_int
)paren
id|SCSTATE-&gt;revcid
)paren
suffix:semicolon
r_else
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: WSS revision %d, CODEC revision %d&bslash;n&quot;
comma
id|sm_drvname
comma
(paren
r_int
)paren
id|SCSTATE-&gt;revwss
comma
(paren
r_int
)paren
id|SCSTATE-&gt;revid
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
id|codec_err
suffix:colon
id|outb
c_func
(paren
l_int|0
comma
id|WSS_CONFIG
c_func
(paren
id|dev-&gt;base_addr
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: no WSS soundcard found at address 0x%lx&bslash;n&quot;
comma
id|sm_drvname
comma
id|dev-&gt;base_addr
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
multiline_comment|/* --------------------------------------------------------------------- */
DECL|function|setup_dma_wss
r_static
r_void
id|setup_dma_wss
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
r_struct
id|sm_state
op_star
id|sm
comma
r_int
id|send
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
r_static
r_const
r_int
r_char
id|codecmode
(braket
l_int|2
)braket
op_assign
(brace
l_int|0x0e
comma
l_int|0x0d
)brace
suffix:semicolon
r_static
r_const
r_int
r_char
id|dmamode
(braket
l_int|2
)braket
op_assign
(brace
id|DMA_MODE_READ
op_or
id|DMA_MODE_AUTOINIT
comma
id|DMA_MODE_WRITE
op_or
id|DMA_MODE_AUTOINIT
)brace
suffix:semicolon
r_int
r_char
id|oldcodecmode
suffix:semicolon
r_int
id|abrt
suffix:semicolon
r_int
r_int
id|dmabufaddr
op_assign
id|virt_to_bus
c_func
(paren
id|SCSTATE-&gt;dmabuf
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|dmabufaddr
op_amp
l_int|0xffffu
)paren
op_plus
id|SCSTATE-&gt;dmabuflen
OG
l_int|0x10000
)paren
id|panic
c_func
(paren
l_string|&quot;%s: DMA buffer violates DMA boundary!&quot;
comma
id|sm_drvname
)paren
suffix:semicolon
id|send
op_assign
op_logical_neg
op_logical_neg
id|send
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * perform the final DMA sequence to disable the codec request&n;&t; */
id|oldcodecmode
op_assign
id|read_codec
c_func
(paren
id|dev
comma
l_int|9
)paren
suffix:semicolon
id|write_codec
c_func
(paren
id|dev
comma
l_int|9
comma
l_int|0xc
)paren
suffix:semicolon
multiline_comment|/* disable codec */
id|wss_ack_int
c_func
(paren
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|read_codec
c_func
(paren
id|dev
comma
l_int|11
)paren
op_amp
l_int|0x10
)paren
(brace
id|disable_dma
c_func
(paren
id|dev-&gt;dma
)paren
suffix:semicolon
id|clear_dma_ff
c_func
(paren
id|dev-&gt;dma
)paren
suffix:semicolon
id|set_dma_mode
c_func
(paren
id|dev-&gt;dma
comma
id|dmamode
(braket
id|oldcodecmode
op_amp
l_int|1
)braket
)paren
suffix:semicolon
id|set_dma_addr
c_func
(paren
id|dev-&gt;dma
comma
id|dmabufaddr
)paren
suffix:semicolon
id|set_dma_count
c_func
(paren
id|dev-&gt;dma
comma
id|SCSTATE-&gt;dmabuflen
)paren
suffix:semicolon
id|enable_dma
c_func
(paren
id|dev-&gt;dma
)paren
suffix:semicolon
id|abrt
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
(paren
id|read_codec
c_func
(paren
id|dev
comma
l_int|11
)paren
op_amp
l_int|0x10
)paren
op_logical_or
(paren
(paren
op_increment
id|abrt
)paren
op_ge
l_int|0x10000
)paren
)paren
suffix:semicolon
)brace
id|disable_dma
c_func
(paren
id|dev-&gt;dma
)paren
suffix:semicolon
r_if
c_cond
(paren
id|read_codec
c_func
(paren
id|dev
comma
l_int|0x8
)paren
op_ne
id|SCSTATE-&gt;fmt
(braket
id|send
)braket
)paren
id|wss_set_codec_fmt
c_func
(paren
id|dev
comma
id|sm
comma
id|SCSTATE-&gt;fmt
(braket
id|send
)braket
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
id|clear_dma_ff
c_func
(paren
id|dev-&gt;dma
)paren
suffix:semicolon
id|set_dma_mode
c_func
(paren
id|dev-&gt;dma
comma
id|dmamode
(braket
id|send
)braket
)paren
suffix:semicolon
id|set_dma_addr
c_func
(paren
id|dev-&gt;dma
comma
id|dmabufaddr
)paren
suffix:semicolon
id|set_dma_count
c_func
(paren
id|dev-&gt;dma
comma
id|SCSTATE-&gt;dmabuflen
)paren
suffix:semicolon
id|enable_dma
c_func
(paren
id|dev-&gt;dma
)paren
suffix:semicolon
id|write_codec
c_func
(paren
id|dev
comma
l_int|15
comma
(paren
(paren
id|SCSTATE-&gt;dmabuflen
op_rshift
l_int|1
)paren
op_minus
l_int|1
)paren
op_amp
l_int|0xff
)paren
suffix:semicolon
id|write_codec
c_func
(paren
id|dev
comma
l_int|14
comma
(paren
(paren
id|SCSTATE-&gt;dmabuflen
op_rshift
l_int|1
)paren
op_minus
l_int|1
)paren
op_rshift
l_int|8
)paren
suffix:semicolon
r_if
c_cond
(paren
id|SCSTATE-&gt;crystal
)paren
(brace
id|write_codec
c_func
(paren
id|dev
comma
l_int|31
comma
(paren
(paren
id|SCSTATE-&gt;dmabuflen
op_rshift
l_int|1
)paren
op_minus
l_int|1
)paren
op_amp
l_int|0xff
)paren
suffix:semicolon
id|write_codec
c_func
(paren
id|dev
comma
l_int|30
comma
(paren
(paren
id|SCSTATE-&gt;dmabuflen
op_rshift
l_int|1
)paren
op_minus
l_int|1
)paren
op_rshift
l_int|8
)paren
suffix:semicolon
)brace
id|write_codec
c_func
(paren
id|dev
comma
l_int|9
comma
id|codecmode
(braket
id|send
)braket
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
multiline_comment|/* --------------------------------------------------------------------- */
DECL|function|wss_interrupt
r_static
r_void
id|wss_interrupt
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_struct
id|device
op_star
id|dev
op_assign
(paren
r_struct
id|device
op_star
)paren
id|dev_id
suffix:semicolon
r_struct
id|sm_state
op_star
id|sm
op_assign
(paren
r_struct
id|sm_state
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_int
r_char
id|new_ptt
suffix:semicolon
r_int
r_char
op_star
id|buf
suffix:semicolon
r_int
id|dmares
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dev
op_logical_or
op_logical_neg
id|sm
op_logical_or
op_logical_neg
id|sm-&gt;mode_rx
op_logical_or
op_logical_neg
id|sm-&gt;mode_tx
op_logical_or
id|sm-&gt;hdrv.magic
op_ne
id|HDLCDRV_MAGIC
)paren
r_return
suffix:semicolon
id|new_ptt
op_assign
id|hdlcdrv_ptt
c_func
(paren
op_amp
id|sm-&gt;hdrv
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|wss_ack_int
c_func
(paren
id|dev
)paren
suffix:semicolon
id|disable_dma
c_func
(paren
id|dev-&gt;dma
)paren
suffix:semicolon
id|clear_dma_ff
c_func
(paren
id|dev-&gt;dma
)paren
suffix:semicolon
id|dmares
op_assign
id|get_dma_residue
c_func
(paren
id|dev-&gt;dma
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dmares
op_le
l_int|0
)paren
id|dmares
op_assign
id|SCSTATE-&gt;dmabuflen
suffix:semicolon
id|buf
op_assign
id|SCSTATE-&gt;dmabuf
suffix:semicolon
r_if
c_cond
(paren
id|dmares
OG
id|SCSTATE-&gt;dmabuflen
op_div
l_int|2
)paren
(brace
id|buf
op_add_assign
id|SCSTATE-&gt;dmabuflen
op_div
l_int|2
suffix:semicolon
id|dmares
op_sub_assign
id|SCSTATE-&gt;dmabuflen
op_div
l_int|2
suffix:semicolon
)brace
macro_line|#ifdef SM_DEBUG
r_if
c_cond
(paren
op_logical_neg
id|sm-&gt;debug_vals.dma_residue
op_logical_or
id|dmares
OL
id|sm-&gt;debug_vals.dma_residue
)paren
id|sm-&gt;debug_vals.dma_residue
op_assign
id|dmares
suffix:semicolon
macro_line|#endif /* SM_DEBUG */
id|dmares
op_decrement
suffix:semicolon
id|write_codec
c_func
(paren
id|dev
comma
l_int|15
comma
id|dmares
op_amp
l_int|0xff
)paren
suffix:semicolon
id|write_codec
c_func
(paren
id|dev
comma
l_int|14
comma
id|dmares
op_rshift
l_int|8
)paren
suffix:semicolon
r_if
c_cond
(paren
id|SCSTATE-&gt;crystal
)paren
(brace
id|write_codec
c_func
(paren
id|dev
comma
l_int|31
comma
id|dmares
op_amp
l_int|0xff
)paren
suffix:semicolon
id|write_codec
c_func
(paren
id|dev
comma
l_int|30
comma
id|dmares
op_rshift
l_int|8
)paren
suffix:semicolon
)brace
id|enable_dma
c_func
(paren
id|dev-&gt;dma
)paren
suffix:semicolon
id|sm_int_freq
c_func
(paren
id|sm
)paren
suffix:semicolon
id|sti
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|new_ptt
op_logical_and
op_logical_neg
id|SCSTATE-&gt;ptt
)paren
(brace
multiline_comment|/* starting to transmit */
id|disable_dma
c_func
(paren
id|dev-&gt;dma
)paren
suffix:semicolon
id|sti
c_func
(paren
)paren
suffix:semicolon
id|SCSTATE-&gt;dmabufidx
op_assign
l_int|0
suffix:semicolon
id|time_exec
c_func
(paren
id|sm-&gt;debug_vals.demod_cyc
comma
id|sm-&gt;mode_rx
op_member_access_from_pointer
id|demodulator
c_func
(paren
id|sm
comma
id|buf
comma
id|SCSTATE-&gt;dmabuflen
op_div
l_int|2
)paren
)paren
suffix:semicolon
id|time_exec
c_func
(paren
id|sm-&gt;debug_vals.mod_cyc
comma
id|sm-&gt;mode_tx
op_member_access_from_pointer
id|modulator
c_func
(paren
id|sm
comma
id|SCSTATE-&gt;dmabuf
comma
id|SCSTATE-&gt;dmabuflen
op_div
l_int|2
)paren
)paren
suffix:semicolon
id|setup_dma_wss
c_func
(paren
id|dev
comma
id|sm
comma
l_int|1
)paren
suffix:semicolon
id|time_exec
c_func
(paren
id|sm-&gt;debug_vals.mod_cyc
comma
id|sm-&gt;mode_tx
op_member_access_from_pointer
id|modulator
c_func
(paren
id|sm
comma
id|SCSTATE-&gt;dmabuf
op_plus
id|SCSTATE-&gt;dmabuflen
op_div
l_int|2
comma
id|SCSTATE-&gt;dmabuflen
op_div
l_int|2
)paren
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|SCSTATE-&gt;ptt
op_eq
l_int|1
op_logical_and
op_logical_neg
id|new_ptt
)paren
(brace
multiline_comment|/* stopping transmission */
id|disable_dma
c_func
(paren
id|dev-&gt;dma
)paren
suffix:semicolon
id|sti
c_func
(paren
)paren
suffix:semicolon
id|SCSTATE-&gt;dmabufidx
op_assign
l_int|0
suffix:semicolon
id|setup_dma_wss
c_func
(paren
id|dev
comma
id|sm
comma
l_int|0
)paren
suffix:semicolon
id|SCSTATE-&gt;ptt
op_assign
l_int|0
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|SCSTATE-&gt;ptt
)paren
(brace
id|SCSTATE-&gt;ptt
op_decrement
suffix:semicolon
id|time_exec
c_func
(paren
id|sm-&gt;debug_vals.mod_cyc
comma
id|sm-&gt;mode_tx
op_member_access_from_pointer
id|modulator
c_func
(paren
id|sm
comma
id|buf
comma
id|SCSTATE-&gt;dmabuflen
op_div
l_int|2
)paren
)paren
suffix:semicolon
)brace
r_else
(brace
id|time_exec
c_func
(paren
id|sm-&gt;debug_vals.demod_cyc
comma
id|sm-&gt;mode_rx
op_member_access_from_pointer
id|demodulator
c_func
(paren
id|sm
comma
id|buf
comma
id|SCSTATE-&gt;dmabuflen
op_div
l_int|2
)paren
)paren
suffix:semicolon
id|hdlcdrv_arbitrate
c_func
(paren
id|dev
comma
op_amp
id|sm-&gt;hdrv
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|new_ptt
)paren
id|SCSTATE-&gt;ptt
op_assign
l_int|2
suffix:semicolon
id|sm_output_status
c_func
(paren
id|sm
)paren
suffix:semicolon
id|hdlcdrv_transmitter
c_func
(paren
id|dev
comma
op_amp
id|sm-&gt;hdrv
)paren
suffix:semicolon
id|hdlcdrv_receiver
c_func
(paren
id|dev
comma
op_amp
id|sm-&gt;hdrv
)paren
suffix:semicolon
)brace
multiline_comment|/* --------------------------------------------------------------------- */
DECL|function|wss_open
r_static
r_int
id|wss_open
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
r_struct
id|sm_state
op_star
id|sm
)paren
(brace
r_if
c_cond
(paren
r_sizeof
(paren
id|sm-&gt;m
)paren
OL
r_sizeof
(paren
r_struct
id|sc_state_wss
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;sm wss: wss state too big: %d &gt; %d&bslash;n&quot;
comma
r_sizeof
(paren
r_struct
id|sc_state_wss
)paren
comma
r_sizeof
(paren
id|sm-&gt;m
)paren
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|dev
op_logical_or
op_logical_neg
id|sm
op_logical_or
op_logical_neg
id|sm-&gt;mode_rx
op_logical_or
op_logical_neg
id|sm-&gt;mode_tx
)paren
r_return
op_minus
id|ENXIO
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;base_addr
op_le
l_int|0
op_logical_or
id|dev-&gt;base_addr
OG
l_int|0x1000
op_minus
id|WSS_EXTENT
op_logical_or
id|dev-&gt;irq
template_param
l_int|15
op_logical_or
id|dev-&gt;dma
OG
l_int|3
)paren
r_return
op_minus
id|ENXIO
suffix:semicolon
r_if
c_cond
(paren
id|check_region
c_func
(paren
id|dev-&gt;base_addr
comma
id|WSS_EXTENT
)paren
)paren
r_return
op_minus
id|EACCES
suffix:semicolon
multiline_comment|/*&n;&t; * check if a card is available&n;&t; */
r_if
c_cond
(paren
id|wss_init_codec
c_func
(paren
id|dev
comma
id|sm
comma
l_int|0
comma
l_int|1
comma
l_int|1
comma
l_int|0
comma
l_int|0
comma
op_minus
l_int|45
comma
op_minus
l_int|45
)paren
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
multiline_comment|/*&n;&t; * initialize some variables&n;&t; */
r_if
c_cond
(paren
op_logical_neg
(paren
id|SCSTATE-&gt;dmabuf
op_assign
id|kmalloc
c_func
(paren
id|SCSTATE-&gt;dmabuflen
comma
id|GFP_KERNEL
op_or
id|GFP_DMA
)paren
)paren
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|SCSTATE-&gt;dmabufidx
op_assign
id|SCSTATE-&gt;ptt
op_assign
l_int|0
suffix:semicolon
id|memset
c_func
(paren
op_amp
id|sm-&gt;m
comma
l_int|0
comma
r_sizeof
(paren
id|sm-&gt;m
)paren
)paren
suffix:semicolon
id|memset
c_func
(paren
op_amp
id|sm-&gt;d
comma
l_int|0
comma
r_sizeof
(paren
id|sm-&gt;d
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sm-&gt;mode_tx-&gt;init
)paren
id|sm-&gt;mode_tx
op_member_access_from_pointer
id|init
c_func
(paren
id|sm
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sm-&gt;mode_rx-&gt;init
)paren
id|sm-&gt;mode_rx
op_member_access_from_pointer
id|init
c_func
(paren
id|sm
)paren
suffix:semicolon
r_if
c_cond
(paren
id|request_dma
c_func
(paren
id|dev-&gt;dma
comma
id|sm-&gt;hwdrv-&gt;hw_name
)paren
)paren
(brace
id|kfree_s
c_func
(paren
id|SCSTATE-&gt;dmabuf
comma
id|SCSTATE-&gt;dmabuflen
)paren
suffix:semicolon
r_return
op_minus
id|EBUSY
suffix:semicolon
)brace
r_if
c_cond
(paren
id|request_irq
c_func
(paren
id|dev-&gt;irq
comma
id|wss_interrupt
comma
id|SA_INTERRUPT
comma
id|sm-&gt;hwdrv-&gt;hw_name
comma
id|dev
)paren
)paren
(brace
id|free_dma
c_func
(paren
id|dev-&gt;dma
)paren
suffix:semicolon
id|kfree_s
c_func
(paren
id|SCSTATE-&gt;dmabuf
comma
id|SCSTATE-&gt;dmabuflen
)paren
suffix:semicolon
r_return
op_minus
id|EBUSY
suffix:semicolon
)brace
id|request_region
c_func
(paren
id|dev-&gt;base_addr
comma
id|WSS_EXTENT
comma
id|sm-&gt;hwdrv-&gt;hw_name
)paren
suffix:semicolon
id|setup_dma_wss
c_func
(paren
id|dev
comma
id|sm
comma
l_int|0
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* --------------------------------------------------------------------- */
DECL|function|wss_close
r_static
r_int
id|wss_close
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
r_struct
id|sm_state
op_star
id|sm
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|dev
op_logical_or
op_logical_neg
id|sm
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
multiline_comment|/*&n;&t; * disable interrupts&n;&t; */
id|disable_dma
c_func
(paren
id|dev-&gt;dma
)paren
suffix:semicolon
id|write_codec
c_func
(paren
id|dev
comma
l_int|9
comma
l_int|0xc
)paren
suffix:semicolon
multiline_comment|/* disable codec */
id|free_irq
c_func
(paren
id|dev-&gt;irq
comma
id|dev
)paren
suffix:semicolon
id|free_dma
c_func
(paren
id|dev-&gt;dma
)paren
suffix:semicolon
id|release_region
c_func
(paren
id|dev-&gt;base_addr
comma
id|WSS_EXTENT
)paren
suffix:semicolon
id|kfree_s
c_func
(paren
id|SCSTATE-&gt;dmabuf
comma
id|SCSTATE-&gt;dmabuflen
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* --------------------------------------------------------------------- */
DECL|function|wss_sethw
r_static
r_int
id|wss_sethw
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
r_struct
id|sm_state
op_star
id|sm
comma
r_char
op_star
id|mode
)paren
(brace
r_char
op_star
id|cp
op_assign
id|strchr
c_func
(paren
id|mode
comma
l_char|&squot;.&squot;
)paren
suffix:semicolon
r_const
r_struct
id|modem_tx_info
op_star
op_star
id|mtp
op_assign
id|sm_modem_tx_table
suffix:semicolon
r_const
r_struct
id|modem_rx_info
op_star
op_star
id|mrp
suffix:semicolon
r_int
id|i
comma
id|j
comma
id|dv
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|strcmp
c_func
(paren
id|mode
comma
l_string|&quot;off&quot;
)paren
)paren
(brace
id|sm-&gt;mode_tx
op_assign
l_int|NULL
suffix:semicolon
id|sm-&gt;mode_rx
op_assign
l_int|NULL
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|cp
)paren
op_star
id|cp
op_increment
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
r_else
id|cp
op_assign
id|mode
suffix:semicolon
r_for
c_loop
(paren
suffix:semicolon
op_star
id|mtp
suffix:semicolon
id|mtp
op_increment
)paren
(brace
r_if
c_cond
(paren
(paren
op_star
id|mtp
)paren
op_member_access_from_pointer
id|loc_storage
OG
r_sizeof
(paren
id|sm-&gt;m
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: insufficient storage for modulator %s (%d)&bslash;n&quot;
comma
id|sm_drvname
comma
(paren
op_star
id|mtp
)paren
op_member_access_from_pointer
id|name
comma
(paren
op_star
id|mtp
)paren
op_member_access_from_pointer
id|loc_storage
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
(paren
op_star
id|mtp
)paren
op_member_access_from_pointer
id|name
op_logical_or
id|strcmp
c_func
(paren
(paren
op_star
id|mtp
)paren
op_member_access_from_pointer
id|name
comma
id|mode
)paren
)paren
r_continue
suffix:semicolon
r_if
c_cond
(paren
(paren
id|i
op_assign
id|wss_srate_index
c_func
(paren
(paren
op_star
id|mtp
)paren
op_member_access_from_pointer
id|srate
)paren
)paren
OL
l_int|0
)paren
r_continue
suffix:semicolon
r_for
c_loop
(paren
id|mrp
op_assign
id|sm_modem_rx_table
suffix:semicolon
op_star
id|mrp
suffix:semicolon
id|mrp
op_increment
)paren
(brace
r_if
c_cond
(paren
(paren
op_star
id|mrp
)paren
op_member_access_from_pointer
id|loc_storage
OG
r_sizeof
(paren
id|sm-&gt;d
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: insufficient storage for demodulator %s (%d)&bslash;n&quot;
comma
id|sm_drvname
comma
(paren
op_star
id|mrp
)paren
op_member_access_from_pointer
id|name
comma
(paren
op_star
id|mrp
)paren
op_member_access_from_pointer
id|loc_storage
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
op_star
id|mrp
)paren
op_member_access_from_pointer
id|name
op_logical_and
op_logical_neg
id|strcmp
c_func
(paren
(paren
op_star
id|mrp
)paren
op_member_access_from_pointer
id|name
comma
id|cp
)paren
op_logical_and
(paren
(paren
id|j
op_assign
id|wss_srate_index
c_func
(paren
(paren
op_star
id|mrp
)paren
op_member_access_from_pointer
id|srate
)paren
)paren
op_ge
l_int|0
)paren
)paren
(brace
id|sm-&gt;mode_tx
op_assign
op_star
id|mtp
suffix:semicolon
id|sm-&gt;mode_rx
op_assign
op_star
id|mrp
suffix:semicolon
id|SCSTATE-&gt;fmt
(braket
l_int|0
)braket
op_assign
id|j
suffix:semicolon
id|SCSTATE-&gt;fmt
(braket
l_int|1
)braket
op_assign
id|i
suffix:semicolon
id|dv
op_assign
id|lcm
c_func
(paren
id|sm-&gt;mode_tx-&gt;dmabuflenmodulo
comma
id|sm-&gt;mode_rx-&gt;dmabuflenmodulo
)paren
suffix:semicolon
id|SCSTATE-&gt;dmabuflen
op_assign
id|sm-&gt;mode_rx-&gt;srate
op_div
l_int|100
op_plus
id|dv
op_minus
l_int|1
suffix:semicolon
id|SCSTATE-&gt;dmabuflen
op_div_assign
id|dv
suffix:semicolon
id|SCSTATE-&gt;dmabuflen
op_mul_assign
l_int|2
op_star
id|dv
suffix:semicolon
multiline_comment|/* make sure DMA buf is even */
r_return
l_int|0
suffix:semicolon
)brace
)brace
)brace
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
multiline_comment|/* --------------------------------------------------------------------- */
DECL|function|wss_ioctl
r_static
r_int
id|wss_ioctl
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
r_struct
id|sm_state
op_star
id|sm
comma
r_struct
id|ifreq
op_star
id|ifr
comma
r_struct
id|hdlcdrv_ioctl
op_star
id|hi
comma
r_int
id|cmd
)paren
(brace
r_struct
id|sm_ioctl
id|bi
suffix:semicolon
r_int
id|i
suffix:semicolon
r_if
c_cond
(paren
id|cmd
op_ne
id|SIOCDEVPRIVATE
)paren
r_return
op_minus
id|ENOIOCTLCMD
suffix:semicolon
r_if
c_cond
(paren
id|hi-&gt;cmd
op_eq
id|HDLCDRVCTL_MODEMPARMASK
)paren
r_return
id|HDLCDRV_PARMASK_IOBASE
op_or
id|HDLCDRV_PARMASK_IRQ
op_or
id|HDLCDRV_PARMASK_DMA
op_or
id|HDLCDRV_PARMASK_SERIOBASE
op_or
id|HDLCDRV_PARMASK_PARIOBASE
op_or
id|HDLCDRV_PARMASK_MIDIIOBASE
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|bi
comma
id|ifr-&gt;ifr_data
comma
r_sizeof
(paren
id|bi
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_switch
c_cond
(paren
id|bi.cmd
)paren
(brace
r_default
suffix:colon
r_return
op_minus
id|ENOIOCTLCMD
suffix:semicolon
r_case
id|SMCTL_GETMIXER
suffix:colon
id|i
op_assign
l_int|0
suffix:semicolon
id|bi.data.mix.sample_rate
op_assign
id|sm-&gt;mode_rx-&gt;srate
suffix:semicolon
id|bi.data.mix.bit_rate
op_assign
id|sm-&gt;hdrv.par.bitrate
suffix:semicolon
id|bi.data.mix.mixer_type
op_assign
id|SCSTATE-&gt;crystal
ques
c_cond
id|SM_MIXER_CRYSTAL
suffix:colon
id|SM_MIXER_AD1848
suffix:semicolon
r_if
c_cond
(paren
(paren
(paren
id|SCSTATE-&gt;crystal
ques
c_cond
l_int|0x2c0c20fflu
suffix:colon
l_int|0x20fflu
)paren
op_rshift
id|bi.data.mix.reg
)paren
op_amp
l_int|1
)paren
(brace
id|bi.data.mix.data
op_assign
id|read_codec
c_func
(paren
id|dev
comma
id|bi.data.mix.reg
)paren
suffix:semicolon
id|i
op_assign
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
id|ifr-&gt;ifr_data
comma
op_amp
id|bi
comma
r_sizeof
(paren
id|bi
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_return
id|i
suffix:semicolon
r_case
id|SMCTL_SETMIXER
suffix:colon
r_if
c_cond
(paren
op_logical_neg
id|suser
c_func
(paren
)paren
)paren
r_return
op_minus
id|EACCES
suffix:semicolon
r_if
c_cond
(paren
(paren
id|bi.data.mix.mixer_type
op_ne
id|SM_MIXER_CRYSTAL
op_logical_or
op_logical_neg
id|SCSTATE-&gt;crystal
)paren
op_logical_and
(paren
id|bi.data.mix.mixer_type
op_ne
id|SM_MIXER_AD1848
op_logical_or
id|bi.data.mix.reg
op_ge
l_int|0x10
)paren
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
(paren
l_int|0x2c0c20fflu
op_rshift
id|bi.data.mix.reg
)paren
op_amp
l_int|1
)paren
)paren
r_return
op_minus
id|EACCES
suffix:semicolon
id|write_codec
c_func
(paren
id|dev
comma
id|bi.data.mix.reg
comma
id|bi.data.mix.data
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
id|ifr-&gt;ifr_data
comma
op_amp
id|bi
comma
r_sizeof
(paren
id|bi
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* --------------------------------------------------------------------- */
DECL|variable|sm_hw_wss
r_const
r_struct
id|hardware_info
id|sm_hw_wss
op_assign
(brace
l_string|&quot;wss&quot;
comma
r_sizeof
(paren
r_struct
id|sc_state_wss
)paren
comma
id|wss_open
comma
id|wss_close
comma
id|wss_ioctl
comma
id|wss_sethw
)brace
suffix:semicolon
multiline_comment|/* --------------------------------------------------------------------- */
DECL|function|setup_fdx_dma_wss
r_static
r_void
id|setup_fdx_dma_wss
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
r_struct
id|sm_state
op_star
id|sm
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
r_int
r_char
id|oldcodecmode
comma
id|codecdma
suffix:semicolon
r_int
id|abrt
suffix:semicolon
r_int
r_int
id|dmabufaddr1
op_assign
id|virt_to_bus
c_func
(paren
id|SCSTATE-&gt;dmabuf
)paren
suffix:semicolon
r_int
r_int
id|dmabufaddr2
op_assign
id|virt_to_bus
c_func
(paren
id|SCSTATE-&gt;dmabuf2
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
(paren
id|dmabufaddr1
op_amp
l_int|0xffffu
)paren
op_plus
id|SCSTATE-&gt;dmabuflen
OG
l_int|0x10000
)paren
op_logical_or
(paren
(paren
id|dmabufaddr2
op_amp
l_int|0xffffu
)paren
op_plus
id|SCSTATE-&gt;dmabuflen
OG
l_int|0x10000
)paren
)paren
id|panic
c_func
(paren
l_string|&quot;%s: DMA buffer violates DMA boundary!&quot;
comma
id|sm_drvname
)paren
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * perform the final DMA sequence to disable the codec request&n;&t; */
id|oldcodecmode
op_assign
id|read_codec
c_func
(paren
id|dev
comma
l_int|9
)paren
suffix:semicolon
id|write_codec
c_func
(paren
id|dev
comma
l_int|9
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* disable codec DMA */
id|wss_ack_int
c_func
(paren
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|codecdma
op_assign
id|read_codec
c_func
(paren
id|dev
comma
l_int|11
)paren
)paren
op_amp
l_int|0x10
)paren
(brace
id|disable_dma
c_func
(paren
id|dev-&gt;dma
)paren
suffix:semicolon
id|disable_dma
c_func
(paren
id|sm-&gt;hdrv.ptt_out.dma2
)paren
suffix:semicolon
id|clear_dma_ff
c_func
(paren
id|dev-&gt;dma
)paren
suffix:semicolon
id|set_dma_mode
c_func
(paren
id|dev-&gt;dma
comma
id|DMA_MODE_WRITE
op_or
id|DMA_MODE_AUTOINIT
)paren
suffix:semicolon
id|set_dma_addr
c_func
(paren
id|dev-&gt;dma
comma
id|dmabufaddr1
)paren
suffix:semicolon
id|set_dma_count
c_func
(paren
id|dev-&gt;dma
comma
id|SCSTATE-&gt;dmabuflen
)paren
suffix:semicolon
id|clear_dma_ff
c_func
(paren
id|sm-&gt;hdrv.ptt_out.dma2
)paren
suffix:semicolon
id|set_dma_mode
c_func
(paren
id|sm-&gt;hdrv.ptt_out.dma2
comma
id|DMA_MODE_READ
op_or
id|DMA_MODE_AUTOINIT
)paren
suffix:semicolon
id|set_dma_addr
c_func
(paren
id|sm-&gt;hdrv.ptt_out.dma2
comma
id|dmabufaddr2
)paren
suffix:semicolon
id|set_dma_count
c_func
(paren
id|sm-&gt;hdrv.ptt_out.dma2
comma
id|SCSTATE-&gt;dmabuflen
)paren
suffix:semicolon
id|enable_dma
c_func
(paren
id|dev-&gt;dma
)paren
suffix:semicolon
id|enable_dma
c_func
(paren
id|sm-&gt;hdrv.ptt_out.dma2
)paren
suffix:semicolon
id|abrt
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
(paren
(paren
id|codecdma
op_assign
id|read_codec
c_func
(paren
id|dev
comma
l_int|11
)paren
)paren
op_amp
l_int|0x10
)paren
op_logical_or
(paren
(paren
op_increment
id|abrt
)paren
op_ge
l_int|0x10000
)paren
)paren
suffix:semicolon
)brace
id|disable_dma
c_func
(paren
id|dev-&gt;dma
)paren
suffix:semicolon
id|disable_dma
c_func
(paren
id|sm-&gt;hdrv.ptt_out.dma2
)paren
suffix:semicolon
id|clear_dma_ff
c_func
(paren
id|dev-&gt;dma
)paren
suffix:semicolon
id|set_dma_mode
c_func
(paren
id|dev-&gt;dma
comma
id|DMA_MODE_WRITE
op_or
id|DMA_MODE_AUTOINIT
)paren
suffix:semicolon
id|set_dma_addr
c_func
(paren
id|dev-&gt;dma
comma
id|dmabufaddr1
)paren
suffix:semicolon
id|set_dma_count
c_func
(paren
id|dev-&gt;dma
comma
id|SCSTATE-&gt;dmabuflen
)paren
suffix:semicolon
id|clear_dma_ff
c_func
(paren
id|sm-&gt;hdrv.ptt_out.dma2
)paren
suffix:semicolon
id|set_dma_mode
c_func
(paren
id|sm-&gt;hdrv.ptt_out.dma2
comma
id|DMA_MODE_READ
op_or
id|DMA_MODE_AUTOINIT
)paren
suffix:semicolon
id|set_dma_addr
c_func
(paren
id|sm-&gt;hdrv.ptt_out.dma2
comma
id|dmabufaddr2
)paren
suffix:semicolon
id|set_dma_count
c_func
(paren
id|sm-&gt;hdrv.ptt_out.dma2
comma
id|SCSTATE-&gt;dmabuflen
)paren
suffix:semicolon
id|enable_dma
c_func
(paren
id|dev-&gt;dma
)paren
suffix:semicolon
id|enable_dma
c_func
(paren
id|sm-&gt;hdrv.ptt_out.dma2
)paren
suffix:semicolon
id|write_codec
c_func
(paren
id|dev
comma
l_int|15
comma
(paren
(paren
id|SCSTATE-&gt;dmabuflen
op_rshift
l_int|1
)paren
op_minus
l_int|1
)paren
op_amp
l_int|0xff
)paren
suffix:semicolon
id|write_codec
c_func
(paren
id|dev
comma
l_int|14
comma
(paren
(paren
id|SCSTATE-&gt;dmabuflen
op_rshift
l_int|1
)paren
op_minus
l_int|1
)paren
op_rshift
l_int|8
)paren
suffix:semicolon
r_if
c_cond
(paren
id|SCSTATE-&gt;crystal
)paren
(brace
id|write_codec
c_func
(paren
id|dev
comma
l_int|31
comma
(paren
(paren
id|SCSTATE-&gt;dmabuflen
op_rshift
l_int|1
)paren
op_minus
l_int|1
)paren
op_amp
l_int|0xff
)paren
suffix:semicolon
id|write_codec
c_func
(paren
id|dev
comma
l_int|30
comma
(paren
(paren
id|SCSTATE-&gt;dmabuflen
op_rshift
l_int|1
)paren
op_minus
l_int|1
)paren
op_rshift
l_int|8
)paren
suffix:semicolon
)brace
id|write_codec
c_func
(paren
id|dev
comma
l_int|9
comma
l_int|3
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
multiline_comment|/* --------------------------------------------------------------------- */
DECL|function|wssfdx_interrupt
r_static
r_void
id|wssfdx_interrupt
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_struct
id|device
op_star
id|dev
op_assign
(paren
r_struct
id|device
op_star
)paren
id|dev_id
suffix:semicolon
r_struct
id|sm_state
op_star
id|sm
op_assign
(paren
r_struct
id|sm_state
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_int
r_char
op_star
id|buf1
suffix:semicolon
r_int
r_char
op_star
id|buf2
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_int
id|dmares1
comma
id|dmares2
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dev
op_logical_or
op_logical_neg
id|sm
op_logical_or
op_logical_neg
id|sm-&gt;mode_rx
op_logical_or
op_logical_neg
id|sm-&gt;mode_tx
op_logical_or
id|sm-&gt;hdrv.magic
op_ne
id|HDLCDRV_MAGIC
)paren
r_return
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|SCSTATE-&gt;crystal
op_logical_and
(paren
op_logical_neg
(paren
id|read_codec
c_func
(paren
id|dev
comma
l_int|0x18
)paren
op_amp
l_int|0x20
)paren
)paren
)paren
(brace
multiline_comment|/* only regard Crystal Playback interrupts! */
id|wss_ack_int
c_func
(paren
id|dev
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|wss_ack_int
c_func
(paren
id|dev
)paren
suffix:semicolon
id|disable_dma
c_func
(paren
id|dev-&gt;dma
)paren
suffix:semicolon
id|disable_dma
c_func
(paren
id|sm-&gt;hdrv.ptt_out.dma2
)paren
suffix:semicolon
id|clear_dma_ff
c_func
(paren
id|dev-&gt;dma
)paren
suffix:semicolon
id|dmares1
op_assign
id|get_dma_residue
c_func
(paren
id|dev-&gt;dma
)paren
suffix:semicolon
id|clear_dma_ff
c_func
(paren
id|sm-&gt;hdrv.ptt_out.dma2
)paren
suffix:semicolon
id|dmares2
op_assign
id|get_dma_residue
c_func
(paren
id|sm-&gt;hdrv.ptt_out.dma2
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dmares1
op_le
l_int|0
)paren
id|dmares1
op_assign
id|SCSTATE-&gt;dmabuflen
suffix:semicolon
id|buf1
op_assign
id|SCSTATE-&gt;dmabuf
suffix:semicolon
r_if
c_cond
(paren
id|dmares1
OG
id|SCSTATE-&gt;dmabuflen
op_div
l_int|2
)paren
(brace
id|buf1
op_add_assign
id|SCSTATE-&gt;dmabuflen
op_div
l_int|2
suffix:semicolon
id|dmares1
op_sub_assign
id|SCSTATE-&gt;dmabuflen
op_div
l_int|2
suffix:semicolon
)brace
r_if
c_cond
(paren
id|dmares2
op_le
l_int|0
)paren
id|dmares2
op_assign
id|SCSTATE-&gt;dmabuflen
suffix:semicolon
id|buf2
op_assign
id|SCSTATE-&gt;dmabuf2
suffix:semicolon
r_if
c_cond
(paren
id|dmares2
OG
id|SCSTATE-&gt;dmabuflen
op_div
l_int|2
)paren
(brace
id|buf2
op_add_assign
id|SCSTATE-&gt;dmabuflen
op_div
l_int|2
suffix:semicolon
id|dmares2
op_sub_assign
id|SCSTATE-&gt;dmabuflen
op_div
l_int|2
suffix:semicolon
)brace
macro_line|#ifdef SM_DEBUG
r_if
c_cond
(paren
op_logical_neg
id|sm-&gt;debug_vals.dma_residue
op_logical_or
id|dmares1
OL
id|sm-&gt;debug_vals.dma_residue
)paren
id|sm-&gt;debug_vals.dma_residue
op_assign
id|dmares1
suffix:semicolon
macro_line|#endif /* SM_DEBUG */
id|dmares1
op_decrement
suffix:semicolon
id|dmares2
op_decrement
suffix:semicolon
id|write_codec
c_func
(paren
id|dev
comma
l_int|15
comma
id|dmares1
op_amp
l_int|0xff
)paren
suffix:semicolon
id|write_codec
c_func
(paren
id|dev
comma
l_int|14
comma
id|dmares1
op_rshift
l_int|8
)paren
suffix:semicolon
r_if
c_cond
(paren
id|SCSTATE-&gt;crystal
)paren
(brace
id|write_codec
c_func
(paren
id|dev
comma
l_int|31
comma
id|dmares2
op_amp
l_int|0xff
)paren
suffix:semicolon
id|write_codec
c_func
(paren
id|dev
comma
l_int|30
comma
id|dmares2
op_rshift
l_int|8
)paren
suffix:semicolon
)brace
id|enable_dma
c_func
(paren
id|dev-&gt;dma
)paren
suffix:semicolon
id|enable_dma
c_func
(paren
id|sm-&gt;hdrv.ptt_out.dma2
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|sm_int_freq
c_func
(paren
id|sm
)paren
suffix:semicolon
id|sti
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|SCSTATE-&gt;ptt
op_assign
id|hdlcdrv_ptt
c_func
(paren
op_amp
id|sm-&gt;hdrv
)paren
)paren
)paren
id|time_exec
c_func
(paren
id|sm-&gt;debug_vals.mod_cyc
comma
id|sm-&gt;mode_tx
op_member_access_from_pointer
id|modulator
c_func
(paren
id|sm
comma
id|buf1
comma
id|SCSTATE-&gt;dmabuflen
op_div
l_int|2
)paren
)paren
suffix:semicolon
r_else
id|time_exec
c_func
(paren
id|sm-&gt;debug_vals.mod_cyc
comma
id|memset
c_func
(paren
id|buf1
comma
l_int|0x80
comma
id|SCSTATE-&gt;dmabuflen
op_div
l_int|2
)paren
)paren
suffix:semicolon
id|time_exec
c_func
(paren
id|sm-&gt;debug_vals.demod_cyc
comma
id|sm-&gt;mode_rx
op_member_access_from_pointer
id|demodulator
c_func
(paren
id|sm
comma
id|buf2
comma
id|SCSTATE-&gt;dmabuflen
op_div
l_int|2
)paren
)paren
suffix:semicolon
id|hdlcdrv_arbitrate
c_func
(paren
id|dev
comma
op_amp
id|sm-&gt;hdrv
)paren
suffix:semicolon
id|sm_output_status
c_func
(paren
id|sm
)paren
suffix:semicolon
id|hdlcdrv_transmitter
c_func
(paren
id|dev
comma
op_amp
id|sm-&gt;hdrv
)paren
suffix:semicolon
id|hdlcdrv_receiver
c_func
(paren
id|dev
comma
op_amp
id|sm-&gt;hdrv
)paren
suffix:semicolon
)brace
multiline_comment|/* --------------------------------------------------------------------- */
DECL|function|wssfdx_open
r_static
r_int
id|wssfdx_open
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
r_struct
id|sm_state
op_star
id|sm
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|dev
op_logical_or
op_logical_neg
id|sm
op_logical_or
op_logical_neg
id|sm-&gt;mode_rx
op_logical_or
op_logical_neg
id|sm-&gt;mode_tx
)paren
r_return
op_minus
id|ENXIO
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;base_addr
op_le
l_int|0
op_logical_or
id|dev-&gt;base_addr
OG
l_int|0x1000
op_minus
id|WSS_EXTENT
op_logical_or
id|dev-&gt;irq
template_param
l_int|15
op_logical_or
id|dev-&gt;dma
OG
l_int|3
)paren
r_return
op_minus
id|ENXIO
suffix:semicolon
r_if
c_cond
(paren
id|check_region
c_func
(paren
id|dev-&gt;base_addr
comma
id|WSS_EXTENT
)paren
)paren
r_return
op_minus
id|EACCES
suffix:semicolon
multiline_comment|/*&n;&t; * check if a card is available&n;&t; */
r_if
c_cond
(paren
id|wss_init_codec
c_func
(paren
id|dev
comma
id|sm
comma
l_int|1
comma
l_int|1
comma
l_int|1
comma
l_int|0
comma
l_int|0
comma
op_minus
l_int|45
comma
op_minus
l_int|45
)paren
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
multiline_comment|/*&n;&t; * initialize some variables&n;&t; */
r_if
c_cond
(paren
op_logical_neg
(paren
id|SCSTATE-&gt;dmabuf
op_assign
id|kmalloc
c_func
(paren
id|SCSTATE-&gt;dmabuflen
comma
id|GFP_KERNEL
op_or
id|GFP_DMA
)paren
)paren
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|SCSTATE-&gt;dmabuf2
op_assign
id|kmalloc
c_func
(paren
id|SCSTATE-&gt;dmabuflen
comma
id|GFP_KERNEL
op_or
id|GFP_DMA
)paren
)paren
)paren
(brace
id|kfree_s
c_func
(paren
id|SCSTATE-&gt;dmabuf
comma
id|SCSTATE-&gt;dmabuflen
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|SCSTATE-&gt;dmabufidx
op_assign
id|SCSTATE-&gt;ptt
op_assign
l_int|0
suffix:semicolon
id|memset
c_func
(paren
op_amp
id|sm-&gt;m
comma
l_int|0
comma
r_sizeof
(paren
id|sm-&gt;m
)paren
)paren
suffix:semicolon
id|memset
c_func
(paren
op_amp
id|sm-&gt;d
comma
l_int|0
comma
r_sizeof
(paren
id|sm-&gt;d
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sm-&gt;mode_tx-&gt;init
)paren
id|sm-&gt;mode_tx
op_member_access_from_pointer
id|init
c_func
(paren
id|sm
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sm-&gt;mode_rx-&gt;init
)paren
id|sm-&gt;mode_rx
op_member_access_from_pointer
id|init
c_func
(paren
id|sm
)paren
suffix:semicolon
r_if
c_cond
(paren
id|request_dma
c_func
(paren
id|dev-&gt;dma
comma
id|sm-&gt;hwdrv-&gt;hw_name
)paren
)paren
(brace
id|kfree_s
c_func
(paren
id|SCSTATE-&gt;dmabuf
comma
id|SCSTATE-&gt;dmabuflen
)paren
suffix:semicolon
id|kfree_s
c_func
(paren
id|SCSTATE-&gt;dmabuf2
comma
id|SCSTATE-&gt;dmabuflen
)paren
suffix:semicolon
r_return
op_minus
id|EBUSY
suffix:semicolon
)brace
r_if
c_cond
(paren
id|request_dma
c_func
(paren
id|sm-&gt;hdrv.ptt_out.dma2
comma
id|sm-&gt;hwdrv-&gt;hw_name
)paren
)paren
(brace
id|kfree_s
c_func
(paren
id|SCSTATE-&gt;dmabuf
comma
id|SCSTATE-&gt;dmabuflen
)paren
suffix:semicolon
id|kfree_s
c_func
(paren
id|SCSTATE-&gt;dmabuf2
comma
id|SCSTATE-&gt;dmabuflen
)paren
suffix:semicolon
id|free_dma
c_func
(paren
id|dev-&gt;dma
)paren
suffix:semicolon
r_return
op_minus
id|EBUSY
suffix:semicolon
)brace
r_if
c_cond
(paren
id|request_irq
c_func
(paren
id|dev-&gt;irq
comma
id|wssfdx_interrupt
comma
id|SA_INTERRUPT
comma
id|sm-&gt;hwdrv-&gt;hw_name
comma
id|dev
)paren
)paren
(brace
id|kfree_s
c_func
(paren
id|SCSTATE-&gt;dmabuf
comma
id|SCSTATE-&gt;dmabuflen
)paren
suffix:semicolon
id|kfree_s
c_func
(paren
id|SCSTATE-&gt;dmabuf2
comma
id|SCSTATE-&gt;dmabuflen
)paren
suffix:semicolon
id|free_dma
c_func
(paren
id|dev-&gt;dma
)paren
suffix:semicolon
id|free_dma
c_func
(paren
id|sm-&gt;hdrv.ptt_out.dma2
)paren
suffix:semicolon
r_return
op_minus
id|EBUSY
suffix:semicolon
)brace
id|request_region
c_func
(paren
id|dev-&gt;base_addr
comma
id|WSS_EXTENT
comma
id|sm-&gt;hwdrv-&gt;hw_name
)paren
suffix:semicolon
id|setup_fdx_dma_wss
c_func
(paren
id|dev
comma
id|sm
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* --------------------------------------------------------------------- */
DECL|function|wssfdx_close
r_static
r_int
id|wssfdx_close
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
r_struct
id|sm_state
op_star
id|sm
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|dev
op_logical_or
op_logical_neg
id|sm
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
multiline_comment|/*&n;&t; * disable interrupts&n;&t; */
id|disable_dma
c_func
(paren
id|dev-&gt;dma
)paren
suffix:semicolon
id|write_codec
c_func
(paren
id|dev
comma
l_int|9
comma
l_int|0xc
)paren
suffix:semicolon
multiline_comment|/* disable codec */
id|free_irq
c_func
(paren
id|dev-&gt;irq
comma
id|dev
)paren
suffix:semicolon
id|free_dma
c_func
(paren
id|dev-&gt;dma
)paren
suffix:semicolon
id|free_dma
c_func
(paren
id|sm-&gt;hdrv.ptt_out.dma2
)paren
suffix:semicolon
id|release_region
c_func
(paren
id|dev-&gt;base_addr
comma
id|WSS_EXTENT
)paren
suffix:semicolon
id|kfree_s
c_func
(paren
id|SCSTATE-&gt;dmabuf
comma
id|SCSTATE-&gt;dmabuflen
)paren
suffix:semicolon
id|kfree_s
c_func
(paren
id|SCSTATE-&gt;dmabuf2
comma
id|SCSTATE-&gt;dmabuflen
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* --------------------------------------------------------------------- */
DECL|function|wssfdx_sethw
r_static
r_int
id|wssfdx_sethw
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
r_struct
id|sm_state
op_star
id|sm
comma
r_char
op_star
id|mode
)paren
(brace
r_char
op_star
id|cp
op_assign
id|strchr
c_func
(paren
id|mode
comma
l_char|&squot;.&squot;
)paren
suffix:semicolon
r_const
r_struct
id|modem_tx_info
op_star
op_star
id|mtp
op_assign
id|sm_modem_tx_table
suffix:semicolon
r_const
r_struct
id|modem_rx_info
op_star
op_star
id|mrp
suffix:semicolon
r_int
id|i
comma
id|dv
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|strcmp
c_func
(paren
id|mode
comma
l_string|&quot;off&quot;
)paren
)paren
(brace
id|sm-&gt;mode_tx
op_assign
l_int|NULL
suffix:semicolon
id|sm-&gt;mode_rx
op_assign
l_int|NULL
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|cp
)paren
op_star
id|cp
op_increment
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
r_else
id|cp
op_assign
id|mode
suffix:semicolon
r_for
c_loop
(paren
suffix:semicolon
op_star
id|mtp
suffix:semicolon
id|mtp
op_increment
)paren
(brace
r_if
c_cond
(paren
(paren
op_star
id|mtp
)paren
op_member_access_from_pointer
id|loc_storage
OG
r_sizeof
(paren
id|sm-&gt;m
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: insufficient storage for modulator %s (%d)&bslash;n&quot;
comma
id|sm_drvname
comma
(paren
op_star
id|mtp
)paren
op_member_access_from_pointer
id|name
comma
(paren
op_star
id|mtp
)paren
op_member_access_from_pointer
id|loc_storage
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
(paren
op_star
id|mtp
)paren
op_member_access_from_pointer
id|name
op_logical_or
id|strcmp
c_func
(paren
(paren
op_star
id|mtp
)paren
op_member_access_from_pointer
id|name
comma
id|mode
)paren
)paren
r_continue
suffix:semicolon
r_if
c_cond
(paren
(paren
id|i
op_assign
id|wss_srate_index
c_func
(paren
(paren
op_star
id|mtp
)paren
op_member_access_from_pointer
id|srate
)paren
)paren
OL
l_int|0
)paren
r_continue
suffix:semicolon
r_for
c_loop
(paren
id|mrp
op_assign
id|sm_modem_rx_table
suffix:semicolon
op_star
id|mrp
suffix:semicolon
id|mrp
op_increment
)paren
(brace
r_if
c_cond
(paren
(paren
op_star
id|mrp
)paren
op_member_access_from_pointer
id|loc_storage
OG
r_sizeof
(paren
id|sm-&gt;d
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: insufficient storage for demodulator %s (%d)&bslash;n&quot;
comma
id|sm_drvname
comma
(paren
op_star
id|mrp
)paren
op_member_access_from_pointer
id|name
comma
(paren
op_star
id|mrp
)paren
op_member_access_from_pointer
id|loc_storage
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
op_star
id|mrp
)paren
op_member_access_from_pointer
id|name
op_logical_and
op_logical_neg
id|strcmp
c_func
(paren
(paren
op_star
id|mrp
)paren
op_member_access_from_pointer
id|name
comma
id|cp
)paren
op_logical_and
(paren
op_star
id|mtp
)paren
op_member_access_from_pointer
id|srate
op_eq
(paren
op_star
id|mrp
)paren
op_member_access_from_pointer
id|srate
)paren
(brace
id|sm-&gt;mode_tx
op_assign
op_star
id|mtp
suffix:semicolon
id|sm-&gt;mode_rx
op_assign
op_star
id|mrp
suffix:semicolon
id|SCSTATE-&gt;fmt
(braket
l_int|0
)braket
op_assign
id|SCSTATE-&gt;fmt
(braket
l_int|1
)braket
op_assign
id|i
suffix:semicolon
id|dv
op_assign
id|lcm
c_func
(paren
id|sm-&gt;mode_tx-&gt;dmabuflenmodulo
comma
id|sm-&gt;mode_rx-&gt;dmabuflenmodulo
)paren
suffix:semicolon
id|SCSTATE-&gt;dmabuflen
op_assign
id|sm-&gt;mode_rx-&gt;srate
op_div
l_int|100
op_plus
id|dv
op_minus
l_int|1
suffix:semicolon
id|SCSTATE-&gt;dmabuflen
op_div_assign
id|dv
suffix:semicolon
id|SCSTATE-&gt;dmabuflen
op_mul_assign
l_int|2
op_star
id|dv
suffix:semicolon
multiline_comment|/* make sure DMA buf is even */
r_return
l_int|0
suffix:semicolon
)brace
)brace
)brace
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
multiline_comment|/* --------------------------------------------------------------------- */
DECL|function|wssfdx_ioctl
r_static
r_int
id|wssfdx_ioctl
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
r_struct
id|sm_state
op_star
id|sm
comma
r_struct
id|ifreq
op_star
id|ifr
comma
r_struct
id|hdlcdrv_ioctl
op_star
id|hi
comma
r_int
id|cmd
)paren
(brace
r_if
c_cond
(paren
id|cmd
op_ne
id|SIOCDEVPRIVATE
)paren
r_return
op_minus
id|ENOIOCTLCMD
suffix:semicolon
r_if
c_cond
(paren
id|hi-&gt;cmd
op_eq
id|HDLCDRVCTL_MODEMPARMASK
)paren
r_return
id|HDLCDRV_PARMASK_IOBASE
op_or
id|HDLCDRV_PARMASK_IRQ
op_or
id|HDLCDRV_PARMASK_DMA
op_or
id|HDLCDRV_PARMASK_DMA2
op_or
id|HDLCDRV_PARMASK_SERIOBASE
op_or
id|HDLCDRV_PARMASK_PARIOBASE
op_or
id|HDLCDRV_PARMASK_MIDIIOBASE
suffix:semicolon
r_return
id|wss_ioctl
c_func
(paren
id|dev
comma
id|sm
comma
id|ifr
comma
id|hi
comma
id|cmd
)paren
suffix:semicolon
)brace
multiline_comment|/* --------------------------------------------------------------------- */
DECL|variable|sm_hw_wssfdx
r_const
r_struct
id|hardware_info
id|sm_hw_wssfdx
op_assign
(brace
l_string|&quot;wssfdx&quot;
comma
r_sizeof
(paren
r_struct
id|sc_state_wss
)paren
comma
id|wssfdx_open
comma
id|wssfdx_close
comma
id|wssfdx_ioctl
comma
id|wssfdx_sethw
)brace
suffix:semicolon
multiline_comment|/* --------------------------------------------------------------------- */
DECL|macro|SCSTATE
macro_line|#undef SCSTATE
eof
