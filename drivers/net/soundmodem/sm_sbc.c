multiline_comment|/*****************************************************************************/
multiline_comment|/*&n; *&t;sm_sbc.h  -- soundcard radio modem driver soundblaster hardware driver&n; *&n; *&t;Copyright (C) 1996  Thomas Sailer (sailer@ife.ee.ethz.ch)&n; *&n; *&t;This program is free software; you can redistribute it and/or modify&n; *&t;it under the terms of the GNU General Public License as published by&n; *&t;the Free Software Foundation; either version 2 of the License, or&n; *&t;(at your option) any later version.&n; *&n; *&t;This program is distributed in the hope that it will be useful,&n; *&t;but WITHOUT ANY WARRANTY; without even the implied warranty of&n; *&t;MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the&n; *&t;GNU General Public License for more details.&n; *&n; *&t;You should have received a copy of the GNU General Public License&n; *&t;along with this program; if not, write to the Free Software&n; *&t;Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.&n; *&n; *  Please note that the GPL allows you to use the driver, NOT the radio.&n; *  In order to use the radio, you need a license from the communications&n; *  authority of your country.&n; *&n; */
macro_line|#include &lt;linux/ptrace.h&gt;
macro_line|#include &lt;linux/interrupt.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/dma.h&gt;
macro_line|#include &lt;linux/ioport.h&gt;
macro_line|#include &lt;linux/soundmodem.h&gt;
macro_line|#include &quot;sm.h&quot;
multiline_comment|/* --------------------------------------------------------------------- */
multiline_comment|/*&n; * currently this module is supposed to support both module styles, i.e.&n; * the old one present up to about 2.1.9, and the new one functioning&n; * starting with 2.1.21. The reason is I have a kit allowing to compile&n; * this module also under 2.0.x which was requested by several people.&n; * This will go in 2.2&n; */
macro_line|#include &lt;linux/version.h&gt;
macro_line|#if LINUX_VERSION_CODE &gt;= 0x20100
macro_line|#include &lt;asm/uaccess.h&gt;
macro_line|#else
macro_line|#include &lt;asm/segment.h&gt;
macro_line|#include &lt;linux/mm.h&gt;
DECL|macro|put_user
macro_line|#undef put_user
DECL|macro|get_user
macro_line|#undef get_user
DECL|macro|put_user
mdefine_line|#define put_user(x,ptr) ({ __put_user((unsigned long)(x),(ptr),sizeof(*(ptr))); 0; })
DECL|macro|get_user
mdefine_line|#define get_user(x,ptr) ({ x = ((__typeof__(*(ptr)))__get_user((ptr),sizeof(*(ptr)))); 0; })
DECL|function|copy_from_user
r_extern
r_inline
r_int
id|copy_from_user
c_func
(paren
r_void
op_star
id|to
comma
r_const
r_void
op_star
id|from
comma
r_int
r_int
id|n
)paren
(brace
r_int
id|i
op_assign
id|verify_area
c_func
(paren
id|VERIFY_READ
comma
id|from
comma
id|n
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
)paren
r_return
id|i
suffix:semicolon
id|memcpy_fromfs
c_func
(paren
id|to
comma
id|from
comma
id|n
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|copy_to_user
r_extern
r_inline
r_int
id|copy_to_user
c_func
(paren
r_void
op_star
id|to
comma
r_const
r_void
op_star
id|from
comma
r_int
r_int
id|n
)paren
(brace
r_int
id|i
op_assign
id|verify_area
c_func
(paren
id|VERIFY_WRITE
comma
id|to
comma
id|n
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
)paren
r_return
id|i
suffix:semicolon
id|memcpy_tofs
c_func
(paren
id|to
comma
id|from
comma
id|n
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#endif
multiline_comment|/* --------------------------------------------------------------------- */
DECL|struct|sc_state_sbc
r_struct
id|sc_state_sbc
(brace
DECL|member|revhi
DECL|member|revlo
r_int
r_char
id|revhi
comma
id|revlo
suffix:semicolon
DECL|member|fmt
r_int
r_char
id|fmt
(braket
l_int|2
)braket
suffix:semicolon
DECL|member|dmabuflen
r_int
r_int
id|dmabuflen
suffix:semicolon
DECL|member|dmabuf
r_int
r_char
op_star
id|dmabuf
suffix:semicolon
DECL|member|dmabufidx
r_int
r_char
id|dmabufidx
suffix:semicolon
DECL|member|ptt
r_int
r_char
id|ptt
suffix:semicolon
)brace
suffix:semicolon
DECL|macro|SCSTATE
mdefine_line|#define SCSTATE ((struct sc_state_sbc *)(&amp;sm-&gt;hw))
multiline_comment|/* --------------------------------------------------------------------- */
multiline_comment|/* &n; * the sbc converter&squot;s registers &n; */
DECL|macro|DSP_RESET
mdefine_line|#define DSP_RESET(iobase)        (iobase+0x6)
DECL|macro|DSP_READ_DATA
mdefine_line|#define DSP_READ_DATA(iobase)    (iobase+0xa)
DECL|macro|DSP_WRITE_DATA
mdefine_line|#define DSP_WRITE_DATA(iobase)   (iobase+0xc)
DECL|macro|DSP_WRITE_STATUS
mdefine_line|#define DSP_WRITE_STATUS(iobase) (iobase+0xc)
DECL|macro|DSP_DATA_AVAIL
mdefine_line|#define DSP_DATA_AVAIL(iobase)   (iobase+0xe)
DECL|macro|DSP_MIXER_ADDR
mdefine_line|#define DSP_MIXER_ADDR(iobase)   (iobase+0x4)
DECL|macro|DSP_MIXER_DATA
mdefine_line|#define DSP_MIXER_DATA(iobase)   (iobase+0x5)
DECL|macro|SBC_EXTENT
mdefine_line|#define SBC_EXTENT               16
multiline_comment|/* --------------------------------------------------------------------- */
multiline_comment|/*&n; * SBC commands&n; */
DECL|macro|SBC_OUTPUT
mdefine_line|#define SBC_OUTPUT             0x14
DECL|macro|SBC_INPUT
mdefine_line|#define SBC_INPUT              0x24
DECL|macro|SBC_BLOCKSIZE
mdefine_line|#define SBC_BLOCKSIZE          0x48
DECL|macro|SBC_HI_OUTPUT
mdefine_line|#define SBC_HI_OUTPUT          0x91 
DECL|macro|SBC_HI_INPUT
mdefine_line|#define SBC_HI_INPUT           0x99 
DECL|macro|SBC_LO_OUTPUT_AUTOINIT
mdefine_line|#define SBC_LO_OUTPUT_AUTOINIT 0x1c
DECL|macro|SBC_LO_INPUT_AUTOINIT
mdefine_line|#define SBC_LO_INPUT_AUTOINIT  0x2c
DECL|macro|SBC_HI_OUTPUT_AUTOINIT
mdefine_line|#define SBC_HI_OUTPUT_AUTOINIT 0x90 
DECL|macro|SBC_HI_INPUT_AUTOINIT
mdefine_line|#define SBC_HI_INPUT_AUTOINIT  0x98
DECL|macro|SBC_IMMED_INT
mdefine_line|#define SBC_IMMED_INT          0xf2
DECL|macro|SBC_GET_REVISION
mdefine_line|#define SBC_GET_REVISION       0xe1
DECL|macro|ESS_GET_REVISION
mdefine_line|#define ESS_GET_REVISION       0xe7
DECL|macro|SBC_SPEAKER_ON
mdefine_line|#define SBC_SPEAKER_ON         0xd1
DECL|macro|SBC_SPEAKER_OFF
mdefine_line|#define SBC_SPEAKER_OFF        0xd3
DECL|macro|SBC_DMA_ON
mdefine_line|#define SBC_DMA_ON             0xd0
DECL|macro|SBC_DMA_OFF
mdefine_line|#define SBC_DMA_OFF            0xd4
DECL|macro|SBC_SAMPLE_RATE
mdefine_line|#define SBC_SAMPLE_RATE        0x40
DECL|macro|SBC_MONO_8BIT
mdefine_line|#define SBC_MONO_8BIT          0xa0
DECL|macro|SBC_MONO_16BIT
mdefine_line|#define SBC_MONO_16BIT         0xa4
DECL|macro|SBC_STEREO_8BIT
mdefine_line|#define SBC_STEREO_8BIT        0xa8
DECL|macro|SBC_STEREO_16BIT
mdefine_line|#define SBC_STEREO_16BIT       0xac
DECL|macro|SBC4_OUT8_AI
mdefine_line|#define SBC4_OUT8_AI           0xc6
DECL|macro|SBC4_IN8_AI
mdefine_line|#define SBC4_IN8_AI            0xce
DECL|macro|SBC4_MODE_UNS_MONO
mdefine_line|#define SBC4_MODE_UNS_MONO     0x00
multiline_comment|/* --------------------------------------------------------------------- */
DECL|function|reset_dsp
r_static
r_int
r_inline
id|reset_dsp
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
r_int
id|i
suffix:semicolon
id|outb
c_func
(paren
l_int|1
comma
id|DSP_RESET
c_func
(paren
id|dev-&gt;base_addr
)paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|0x100
suffix:semicolon
id|i
op_increment
)paren
id|SLOW_DOWN_IO
suffix:semicolon
id|outb
c_func
(paren
l_int|0
comma
id|DSP_RESET
c_func
(paren
id|dev-&gt;base_addr
)paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|0xffff
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
id|inb
c_func
(paren
id|DSP_DATA_AVAIL
c_func
(paren
id|dev-&gt;base_addr
)paren
)paren
op_amp
l_int|0x80
)paren
r_if
c_cond
(paren
id|inb
c_func
(paren
id|DSP_READ_DATA
c_func
(paren
id|dev-&gt;base_addr
)paren
)paren
op_eq
l_int|0xaa
)paren
r_return
l_int|1
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* --------------------------------------------------------------------- */
DECL|function|write_dsp
r_static
r_void
r_inline
id|write_dsp
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
r_int
r_char
id|data
)paren
(brace
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|0xffff
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
op_logical_neg
(paren
id|inb
c_func
(paren
id|DSP_WRITE_STATUS
c_func
(paren
id|dev-&gt;base_addr
)paren
)paren
op_amp
l_int|0x80
)paren
)paren
(brace
id|outb
c_func
(paren
id|data
comma
id|DSP_WRITE_DATA
c_func
(paren
id|dev-&gt;base_addr
)paren
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
)brace
multiline_comment|/* --------------------------------------------------------------------- */
DECL|function|read_dsp
r_static
r_int
r_inline
id|read_dsp
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
r_int
r_char
op_star
id|data
)paren
(brace
r_int
id|i
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|data
)paren
r_return
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|0xffff
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
id|inb
c_func
(paren
id|DSP_DATA_AVAIL
c_func
(paren
id|dev-&gt;base_addr
)paren
)paren
op_amp
l_int|0x80
)paren
(brace
op_star
id|data
op_assign
id|inb
c_func
(paren
id|DSP_READ_DATA
c_func
(paren
id|dev-&gt;base_addr
)paren
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* --------------------------------------------------------------------- */
DECL|function|sbc_int_ack
r_static
r_void
r_inline
id|sbc_int_ack
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
id|inb
c_func
(paren
id|DSP_DATA_AVAIL
c_func
(paren
id|dev-&gt;base_addr
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/* --------------------------------------------------------------------- */
DECL|function|setup_dma_dsp
r_static
r_void
id|setup_dma_dsp
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
r_struct
id|sm_state
op_star
id|sm
comma
r_int
id|send
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
r_static
r_const
r_int
r_char
id|sbcmode
(braket
l_int|2
)braket
(braket
l_int|2
)braket
op_assign
(brace
(brace
id|SBC_LO_INPUT_AUTOINIT
comma
id|SBC_LO_OUTPUT_AUTOINIT
)brace
comma
(brace
id|SBC_HI_INPUT_AUTOINIT
comma
id|SBC_HI_OUTPUT_AUTOINIT
)brace
)brace
suffix:semicolon
r_static
r_const
r_int
r_char
id|sbc4mode
(braket
l_int|2
)braket
op_assign
(brace
id|SBC4_IN8_AI
comma
id|SBC4_OUT8_AI
)brace
suffix:semicolon
r_static
r_const
r_int
r_char
id|dmamode
(braket
l_int|2
)braket
op_assign
(brace
id|DMA_MODE_READ
op_or
id|DMA_MODE_AUTOINIT
comma
id|DMA_MODE_WRITE
op_or
id|DMA_MODE_AUTOINIT
)brace
suffix:semicolon
r_static
r_const
r_int
r_char
id|sbcskr
(braket
l_int|2
)braket
op_assign
(brace
id|SBC_SPEAKER_OFF
comma
id|SBC_SPEAKER_ON
)brace
suffix:semicolon
r_int
r_int
id|dmabufaddr
op_assign
id|virt_to_bus
c_func
(paren
id|SCSTATE-&gt;dmabuf
)paren
suffix:semicolon
id|send
op_assign
op_logical_neg
op_logical_neg
id|send
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|reset_dsp
c_func
(paren
id|dev
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: sbc: cannot reset sb dsp&bslash;n&quot;
comma
id|sm_drvname
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|dmabufaddr
op_amp
l_int|0xffff
)paren
op_plus
id|SCSTATE-&gt;dmabuflen
OG
l_int|0x10000
)paren
id|panic
c_func
(paren
l_string|&quot;sm: DMA buffer violates DMA boundary!&quot;
)paren
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|sbc_int_ack
c_func
(paren
id|dev
)paren
suffix:semicolon
id|write_dsp
c_func
(paren
id|dev
comma
id|SBC_SAMPLE_RATE
)paren
suffix:semicolon
multiline_comment|/* set sampling rate */
id|write_dsp
c_func
(paren
id|dev
comma
id|SCSTATE-&gt;fmt
(braket
id|send
)braket
)paren
suffix:semicolon
id|write_dsp
c_func
(paren
id|dev
comma
id|sbcskr
(braket
id|send
)braket
)paren
suffix:semicolon
id|disable_dma
c_func
(paren
id|dev-&gt;dma
)paren
suffix:semicolon
id|clear_dma_ff
c_func
(paren
id|dev-&gt;dma
)paren
suffix:semicolon
id|set_dma_mode
c_func
(paren
id|dev-&gt;dma
comma
id|dmamode
(braket
id|send
)braket
)paren
suffix:semicolon
id|set_dma_addr
c_func
(paren
id|dev-&gt;dma
comma
id|dmabufaddr
)paren
suffix:semicolon
id|set_dma_count
c_func
(paren
id|dev-&gt;dma
comma
id|SCSTATE-&gt;dmabuflen
)paren
suffix:semicolon
id|enable_dma
c_func
(paren
id|dev-&gt;dma
)paren
suffix:semicolon
id|sbc_int_ack
c_func
(paren
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|SCSTATE-&gt;revhi
op_ge
l_int|4
)paren
(brace
id|write_dsp
c_func
(paren
id|dev
comma
id|sbc4mode
(braket
id|send
)braket
)paren
suffix:semicolon
id|write_dsp
c_func
(paren
id|dev
comma
id|SBC4_MODE_UNS_MONO
)paren
suffix:semicolon
id|write_dsp
c_func
(paren
id|dev
comma
(paren
(paren
id|SCSTATE-&gt;dmabuflen
op_rshift
l_int|1
)paren
op_minus
l_int|1
)paren
op_amp
l_int|0xff
)paren
suffix:semicolon
id|write_dsp
c_func
(paren
id|dev
comma
(paren
(paren
id|SCSTATE-&gt;dmabuflen
op_rshift
l_int|1
)paren
op_minus
l_int|1
)paren
op_rshift
l_int|8
)paren
suffix:semicolon
)brace
r_else
(brace
id|write_dsp
c_func
(paren
id|dev
comma
id|SBC_BLOCKSIZE
)paren
suffix:semicolon
id|write_dsp
c_func
(paren
id|dev
comma
(paren
(paren
id|SCSTATE-&gt;dmabuflen
op_rshift
l_int|1
)paren
op_minus
l_int|1
)paren
op_amp
l_int|0xff
)paren
suffix:semicolon
id|write_dsp
c_func
(paren
id|dev
comma
(paren
(paren
id|SCSTATE-&gt;dmabuflen
op_rshift
l_int|1
)paren
op_minus
l_int|1
)paren
op_rshift
l_int|8
)paren
suffix:semicolon
id|write_dsp
c_func
(paren
id|dev
comma
id|sbcmode
(braket
id|SCSTATE-&gt;fmt
(braket
id|send
)braket
op_ge
l_int|180
)braket
(braket
id|send
)braket
)paren
suffix:semicolon
multiline_comment|/* hispeed mode if sample rate &gt; 13kHz */
)brace
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
multiline_comment|/* --------------------------------------------------------------------- */
DECL|function|sbc_interrupt
r_static
r_void
id|sbc_interrupt
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_struct
id|device
op_star
id|dev
op_assign
(paren
r_struct
id|device
op_star
)paren
id|dev_id
suffix:semicolon
r_struct
id|sm_state
op_star
id|sm
op_assign
(paren
r_struct
id|sm_state
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_int
r_char
id|new_ptt
suffix:semicolon
r_int
r_char
op_star
id|buf
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dev
op_logical_or
op_logical_neg
id|sm
op_logical_or
id|sm-&gt;hdrv.magic
op_ne
id|HDLCDRV_MAGIC
)paren
r_return
suffix:semicolon
id|new_ptt
op_assign
id|hdlcdrv_ptt
c_func
(paren
op_amp
id|sm-&gt;hdrv
)paren
suffix:semicolon
id|sbc_int_ack
c_func
(paren
id|dev
)paren
suffix:semicolon
id|buf
op_assign
id|SCSTATE-&gt;dmabuf
suffix:semicolon
r_if
c_cond
(paren
id|SCSTATE-&gt;dmabufidx
)paren
id|buf
op_add_assign
id|SCSTATE-&gt;dmabuflen
op_div
l_int|2
suffix:semicolon
id|SCSTATE-&gt;dmabufidx
op_assign
op_logical_neg
id|SCSTATE-&gt;dmabufidx
suffix:semicolon
id|sm_int_freq
c_func
(paren
id|sm
)paren
suffix:semicolon
id|sti
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|new_ptt
op_logical_and
op_logical_neg
id|SCSTATE-&gt;ptt
)paren
(brace
multiline_comment|/* starting to transmit */
id|disable_dma
c_func
(paren
id|dev-&gt;dma
)paren
suffix:semicolon
id|SCSTATE-&gt;dmabufidx
op_assign
l_int|0
suffix:semicolon
id|time_exec
c_func
(paren
id|sm-&gt;debug_vals.demod_cyc
comma
id|sm-&gt;mode_rx
op_member_access_from_pointer
id|demodulator
c_func
(paren
id|sm
comma
id|buf
comma
id|SCSTATE-&gt;dmabuflen
op_div
l_int|2
)paren
)paren
suffix:semicolon
id|time_exec
c_func
(paren
id|sm-&gt;debug_vals.mod_cyc
comma
id|sm-&gt;mode_tx
op_member_access_from_pointer
id|modulator
c_func
(paren
id|sm
comma
id|SCSTATE-&gt;dmabuf
comma
id|SCSTATE-&gt;dmabuflen
op_div
l_int|2
)paren
)paren
suffix:semicolon
id|setup_dma_dsp
c_func
(paren
id|dev
comma
id|sm
comma
l_int|1
)paren
suffix:semicolon
id|time_exec
c_func
(paren
id|sm-&gt;debug_vals.mod_cyc
comma
id|sm-&gt;mode_tx
op_member_access_from_pointer
id|modulator
c_func
(paren
id|sm
comma
id|SCSTATE-&gt;dmabuf
op_plus
id|SCSTATE-&gt;dmabuflen
op_div
l_int|2
comma
id|SCSTATE-&gt;dmabuflen
op_div
l_int|2
)paren
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|SCSTATE-&gt;ptt
op_eq
l_int|1
op_logical_and
op_logical_neg
id|new_ptt
)paren
(brace
multiline_comment|/* stopping transmission */
id|disable_dma
c_func
(paren
id|dev-&gt;dma
)paren
suffix:semicolon
id|SCSTATE-&gt;dmabufidx
op_assign
l_int|0
suffix:semicolon
id|setup_dma_dsp
c_func
(paren
id|dev
comma
id|sm
comma
l_int|0
)paren
suffix:semicolon
id|SCSTATE-&gt;ptt
op_assign
l_int|0
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|SCSTATE-&gt;ptt
)paren
(brace
id|SCSTATE-&gt;ptt
op_decrement
suffix:semicolon
id|time_exec
c_func
(paren
id|sm-&gt;debug_vals.mod_cyc
comma
id|sm-&gt;mode_tx
op_member_access_from_pointer
id|modulator
c_func
(paren
id|sm
comma
id|buf
comma
id|SCSTATE-&gt;dmabuflen
op_div
l_int|2
)paren
)paren
suffix:semicolon
)brace
r_else
(brace
id|time_exec
c_func
(paren
id|sm-&gt;debug_vals.demod_cyc
comma
id|sm-&gt;mode_rx
op_member_access_from_pointer
id|demodulator
c_func
(paren
id|sm
comma
id|buf
comma
id|SCSTATE-&gt;dmabuflen
op_div
l_int|2
)paren
)paren
suffix:semicolon
id|hdlcdrv_arbitrate
c_func
(paren
id|dev
comma
op_amp
id|sm-&gt;hdrv
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|new_ptt
)paren
id|SCSTATE-&gt;ptt
op_assign
l_int|2
suffix:semicolon
id|sm_output_status
c_func
(paren
id|sm
)paren
suffix:semicolon
id|hdlcdrv_transmitter
c_func
(paren
id|dev
comma
op_amp
id|sm-&gt;hdrv
)paren
suffix:semicolon
id|hdlcdrv_receiver
c_func
(paren
id|dev
comma
op_amp
id|sm-&gt;hdrv
)paren
suffix:semicolon
)brace
multiline_comment|/* --------------------------------------------------------------------- */
DECL|function|sbc_open
r_static
r_int
id|sbc_open
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
r_struct
id|sm_state
op_star
id|sm
)paren
(brace
r_if
c_cond
(paren
r_sizeof
(paren
id|sm-&gt;m
)paren
OL
r_sizeof
(paren
r_struct
id|sc_state_sbc
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;sm sbc: sbc state too big: %d &gt; %d&bslash;n&quot;
comma
r_sizeof
(paren
r_struct
id|sc_state_sbc
)paren
comma
r_sizeof
(paren
id|sm-&gt;m
)paren
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|dev
op_logical_or
op_logical_neg
id|sm
)paren
r_return
op_minus
id|ENXIO
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;base_addr
op_le
l_int|0
op_logical_or
id|dev-&gt;base_addr
OG
l_int|0x1000
op_minus
id|SBC_EXTENT
op_logical_or
id|dev-&gt;irq
template_param
l_int|15
op_logical_or
id|dev-&gt;dma
OG
l_int|3
)paren
r_return
op_minus
id|ENXIO
suffix:semicolon
r_if
c_cond
(paren
id|check_region
c_func
(paren
id|dev-&gt;base_addr
comma
id|SBC_EXTENT
)paren
)paren
r_return
op_minus
id|EACCES
suffix:semicolon
multiline_comment|/*&n;&t; * check if a card is available&n;&t; */
r_if
c_cond
(paren
op_logical_neg
id|reset_dsp
c_func
(paren
id|dev
)paren
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
id|write_dsp
c_func
(paren
id|dev
comma
id|SBC_GET_REVISION
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|read_dsp
c_func
(paren
id|dev
comma
op_amp
id|SCSTATE-&gt;revhi
)paren
op_logical_or
op_logical_neg
id|read_dsp
c_func
(paren
id|dev
comma
op_amp
id|SCSTATE-&gt;revlo
)paren
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
r_if
c_cond
(paren
id|SCSTATE-&gt;revhi
OL
l_int|2
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: your card is an antiquity, at least DSP &quot;
l_string|&quot;rev 2.00 required&bslash;n&quot;
comma
id|sm_drvname
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
r_if
c_cond
(paren
id|SCSTATE-&gt;revhi
OL
l_int|3
op_logical_and
(paren
id|SCSTATE-&gt;fmt
(braket
l_int|0
)braket
op_ge
l_int|180
op_logical_or
id|SCSTATE-&gt;fmt
(braket
l_int|1
)braket
op_ge
l_int|180
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: sbc io 0x%lx: DSP rev %d.%02d too &quot;
l_string|&quot;old, at least 3.00 required&bslash;n&quot;
comma
id|sm_drvname
comma
id|dev-&gt;base_addr
comma
id|SCSTATE-&gt;revhi
comma
id|SCSTATE-&gt;revlo
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * initialize some variables&n;&t; */
r_if
c_cond
(paren
op_logical_neg
(paren
id|SCSTATE-&gt;dmabuf
op_assign
id|kmalloc
c_func
(paren
id|SCSTATE-&gt;dmabuflen
comma
id|GFP_KERNEL
op_or
id|GFP_DMA
)paren
)paren
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|SCSTATE-&gt;dmabufidx
op_assign
id|SCSTATE-&gt;ptt
op_assign
l_int|0
suffix:semicolon
id|memset
c_func
(paren
op_amp
id|sm-&gt;m
comma
l_int|0
comma
r_sizeof
(paren
id|sm-&gt;m
)paren
)paren
suffix:semicolon
id|memset
c_func
(paren
op_amp
id|sm-&gt;d
comma
l_int|0
comma
r_sizeof
(paren
id|sm-&gt;d
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sm-&gt;mode_tx-&gt;init
)paren
id|sm-&gt;mode_tx
op_member_access_from_pointer
id|init
c_func
(paren
id|sm
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sm-&gt;mode_rx-&gt;init
)paren
id|sm-&gt;mode_rx
op_member_access_from_pointer
id|init
c_func
(paren
id|sm
)paren
suffix:semicolon
r_if
c_cond
(paren
id|request_dma
c_func
(paren
id|dev-&gt;dma
comma
id|sm-&gt;hwdrv-&gt;hw_name
)paren
)paren
(brace
id|kfree_s
c_func
(paren
id|SCSTATE-&gt;dmabuf
comma
id|SCSTATE-&gt;dmabuflen
)paren
suffix:semicolon
r_return
op_minus
id|EBUSY
suffix:semicolon
)brace
r_if
c_cond
(paren
id|request_irq
c_func
(paren
id|dev-&gt;irq
comma
id|sbc_interrupt
comma
id|SA_INTERRUPT
comma
id|sm-&gt;hwdrv-&gt;hw_name
comma
id|dev
)paren
)paren
(brace
id|free_dma
c_func
(paren
id|dev-&gt;dma
)paren
suffix:semicolon
id|kfree_s
c_func
(paren
id|SCSTATE-&gt;dmabuf
comma
id|SCSTATE-&gt;dmabuflen
)paren
suffix:semicolon
r_return
op_minus
id|EBUSY
suffix:semicolon
)brace
id|request_region
c_func
(paren
id|dev-&gt;base_addr
comma
id|SBC_EXTENT
comma
id|sm-&gt;hwdrv-&gt;hw_name
)paren
suffix:semicolon
id|setup_dma_dsp
c_func
(paren
id|dev
comma
id|sm
comma
l_int|0
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* --------------------------------------------------------------------- */
DECL|function|sbc_close
r_static
r_int
id|sbc_close
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
r_struct
id|sm_state
op_star
id|sm
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|dev
op_logical_or
op_logical_neg
id|sm
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
multiline_comment|/*&n;&t; * disable interrupts&n;&t; */
id|disable_dma
c_func
(paren
id|dev-&gt;dma
)paren
suffix:semicolon
id|reset_dsp
c_func
(paren
id|dev
)paren
suffix:semicolon
id|free_irq
c_func
(paren
id|dev-&gt;irq
comma
id|dev
)paren
suffix:semicolon
id|free_dma
c_func
(paren
id|dev-&gt;dma
)paren
suffix:semicolon
id|release_region
c_func
(paren
id|dev-&gt;base_addr
comma
id|SBC_EXTENT
)paren
suffix:semicolon
id|kfree_s
c_func
(paren
id|SCSTATE-&gt;dmabuf
comma
id|SCSTATE-&gt;dmabuflen
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* --------------------------------------------------------------------- */
DECL|function|sbc_sethw
r_static
r_int
id|sbc_sethw
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
r_struct
id|sm_state
op_star
id|sm
comma
r_char
op_star
id|mode
)paren
(brace
r_char
op_star
id|cp
op_assign
id|strchr
c_func
(paren
id|mode
comma
l_char|&squot;.&squot;
)paren
suffix:semicolon
r_const
r_struct
id|modem_tx_info
op_star
op_star
id|mtp
op_assign
id|sm_modem_tx_table
suffix:semicolon
r_const
r_struct
id|modem_rx_info
op_star
op_star
id|mrp
suffix:semicolon
r_int
id|dv
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|strcmp
c_func
(paren
id|mode
comma
l_string|&quot;off&quot;
)paren
)paren
(brace
id|sm-&gt;mode_tx
op_assign
l_int|NULL
suffix:semicolon
id|sm-&gt;mode_rx
op_assign
l_int|NULL
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|cp
)paren
op_star
id|cp
op_increment
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
r_else
id|cp
op_assign
id|mode
suffix:semicolon
r_for
c_loop
(paren
suffix:semicolon
op_star
id|mtp
suffix:semicolon
id|mtp
op_increment
)paren
(brace
r_if
c_cond
(paren
(paren
op_star
id|mtp
)paren
op_member_access_from_pointer
id|loc_storage
OG
r_sizeof
(paren
id|sm-&gt;m
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: insufficient storage for modulator %s (%d)&bslash;n&quot;
comma
id|sm_drvname
comma
(paren
op_star
id|mtp
)paren
op_member_access_from_pointer
id|name
comma
(paren
op_star
id|mtp
)paren
op_member_access_from_pointer
id|loc_storage
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
(paren
op_star
id|mtp
)paren
op_member_access_from_pointer
id|name
op_logical_or
id|strcmp
c_func
(paren
(paren
op_star
id|mtp
)paren
op_member_access_from_pointer
id|name
comma
id|mode
)paren
)paren
r_continue
suffix:semicolon
r_if
c_cond
(paren
(paren
op_star
id|mtp
)paren
op_member_access_from_pointer
id|srate
template_param
l_int|44100
)paren
r_continue
suffix:semicolon
r_for
c_loop
(paren
id|mrp
op_assign
id|sm_modem_rx_table
suffix:semicolon
op_star
id|mrp
suffix:semicolon
id|mrp
op_increment
)paren
(brace
r_if
c_cond
(paren
(paren
op_star
id|mrp
)paren
op_member_access_from_pointer
id|loc_storage
OG
r_sizeof
(paren
id|sm-&gt;d
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: insufficient storage for demodulator %s (%d)&bslash;n&quot;
comma
id|sm_drvname
comma
(paren
op_star
id|mrp
)paren
op_member_access_from_pointer
id|name
comma
(paren
op_star
id|mrp
)paren
op_member_access_from_pointer
id|loc_storage
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
op_star
id|mrp
)paren
op_member_access_from_pointer
id|name
op_logical_and
op_logical_neg
id|strcmp
c_func
(paren
(paren
op_star
id|mrp
)paren
op_member_access_from_pointer
id|name
comma
id|cp
)paren
op_logical_and
(paren
op_star
id|mrp
)paren
op_member_access_from_pointer
id|srate
op_ge
l_int|5000
op_logical_and
(paren
op_star
id|mrp
)paren
op_member_access_from_pointer
id|srate
op_le
l_int|44100
)paren
(brace
id|sm-&gt;mode_tx
op_assign
op_star
id|mtp
suffix:semicolon
id|sm-&gt;mode_rx
op_assign
op_star
id|mrp
suffix:semicolon
id|SCSTATE-&gt;fmt
(braket
l_int|0
)braket
op_assign
l_int|256
op_minus
(paren
(paren
l_int|1000000L
op_plus
id|sm-&gt;mode_rx-&gt;srate
op_div
l_int|2
)paren
op_div
id|sm-&gt;mode_rx-&gt;srate
)paren
suffix:semicolon
id|SCSTATE-&gt;fmt
(braket
l_int|1
)braket
op_assign
l_int|256
op_minus
(paren
(paren
l_int|1000000L
op_plus
id|sm-&gt;mode_tx-&gt;srate
op_div
l_int|2
)paren
op_div
id|sm-&gt;mode_tx-&gt;srate
)paren
suffix:semicolon
id|dv
op_assign
id|lcm
c_func
(paren
id|sm-&gt;mode_tx-&gt;dmabuflenmodulo
comma
id|sm-&gt;mode_rx-&gt;dmabuflenmodulo
)paren
suffix:semicolon
id|SCSTATE-&gt;dmabuflen
op_assign
id|sm-&gt;mode_rx-&gt;srate
op_div
l_int|100
op_plus
id|dv
op_minus
l_int|1
suffix:semicolon
id|SCSTATE-&gt;dmabuflen
op_div_assign
id|dv
suffix:semicolon
id|SCSTATE-&gt;dmabuflen
op_mul_assign
l_int|2
op_star
id|dv
suffix:semicolon
multiline_comment|/* make sure DMA buf is even */
r_return
l_int|0
suffix:semicolon
)brace
)brace
)brace
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
multiline_comment|/* --------------------------------------------------------------------- */
DECL|function|sbc_ioctl
r_static
r_int
id|sbc_ioctl
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
r_struct
id|sm_state
op_star
id|sm
comma
r_struct
id|ifreq
op_star
id|ifr
comma
r_struct
id|hdlcdrv_ioctl
op_star
id|hi
comma
r_int
id|cmd
)paren
(brace
r_struct
id|sm_ioctl
id|bi
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_int
id|i
suffix:semicolon
r_if
c_cond
(paren
id|cmd
op_ne
id|SIOCDEVPRIVATE
)paren
r_return
op_minus
id|ENOIOCTLCMD
suffix:semicolon
r_if
c_cond
(paren
id|hi-&gt;cmd
op_eq
id|HDLCDRVCTL_MODEMPARMASK
)paren
r_return
id|HDLCDRV_PARMASK_IOBASE
op_or
id|HDLCDRV_PARMASK_IRQ
op_or
id|HDLCDRV_PARMASK_DMA
op_or
id|HDLCDRV_PARMASK_SERIOBASE
op_or
id|HDLCDRV_PARMASK_PARIOBASE
op_or
id|HDLCDRV_PARMASK_MIDIIOBASE
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|bi
comma
id|ifr-&gt;ifr_data
comma
r_sizeof
(paren
id|bi
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_switch
c_cond
(paren
id|bi.cmd
)paren
(brace
r_default
suffix:colon
r_return
op_minus
id|ENOIOCTLCMD
suffix:semicolon
r_case
id|SMCTL_GETMIXER
suffix:colon
id|i
op_assign
l_int|0
suffix:semicolon
id|bi.data.mix.sample_rate
op_assign
id|sm-&gt;mode_rx-&gt;srate
suffix:semicolon
id|bi.data.mix.bit_rate
op_assign
id|sm-&gt;hdrv.par.bitrate
suffix:semicolon
id|bi.data.mix.mixer_type
op_assign
id|SM_MIXER_INVALID
suffix:semicolon
r_switch
c_cond
(paren
id|SCSTATE-&gt;revhi
)paren
(brace
r_case
l_int|2
suffix:colon
id|bi.data.mix.mixer_type
op_assign
id|SM_MIXER_CT1335
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|3
suffix:colon
id|bi.data.mix.mixer_type
op_assign
id|SM_MIXER_CT1345
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|4
suffix:colon
id|bi.data.mix.mixer_type
op_assign
id|SM_MIXER_CT1745
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|bi.data.mix.mixer_type
op_ne
id|SM_MIXER_INVALID
op_logical_and
id|bi.data.mix.reg
OL
l_int|0x80
)paren
(brace
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|outb
c_func
(paren
id|bi.data.mix.reg
comma
id|DSP_MIXER_ADDR
c_func
(paren
id|dev-&gt;base_addr
)paren
)paren
suffix:semicolon
id|bi.data.mix.data
op_assign
id|inb
c_func
(paren
id|DSP_MIXER_DATA
c_func
(paren
id|dev-&gt;base_addr
)paren
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|i
op_assign
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
id|ifr-&gt;ifr_data
comma
op_amp
id|bi
comma
r_sizeof
(paren
id|bi
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_return
id|i
suffix:semicolon
r_case
id|SMCTL_SETMIXER
suffix:colon
r_if
c_cond
(paren
op_logical_neg
id|suser
c_func
(paren
)paren
)paren
r_return
op_minus
id|EACCES
suffix:semicolon
r_switch
c_cond
(paren
id|SCSTATE-&gt;revhi
)paren
(brace
r_case
l_int|2
suffix:colon
r_if
c_cond
(paren
id|bi.data.mix.mixer_type
op_ne
id|SM_MIXER_CT1335
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|3
suffix:colon
r_if
c_cond
(paren
id|bi.data.mix.mixer_type
op_ne
id|SM_MIXER_CT1345
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|4
suffix:colon
r_if
c_cond
(paren
id|bi.data.mix.mixer_type
op_ne
id|SM_MIXER_CT1745
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
r_if
c_cond
(paren
id|bi.data.mix.reg
op_ge
l_int|0x80
)paren
r_return
op_minus
id|EACCES
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|outb
c_func
(paren
id|bi.data.mix.reg
comma
id|DSP_MIXER_ADDR
c_func
(paren
id|dev-&gt;base_addr
)paren
)paren
suffix:semicolon
id|outb
c_func
(paren
id|bi.data.mix.data
comma
id|DSP_MIXER_DATA
c_func
(paren
id|dev-&gt;base_addr
)paren
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
id|ifr-&gt;ifr_data
comma
op_amp
id|bi
comma
r_sizeof
(paren
id|bi
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* --------------------------------------------------------------------- */
DECL|variable|sm_hw_sbc
r_const
r_struct
id|hardware_info
id|sm_hw_sbc
op_assign
(brace
l_string|&quot;sbc&quot;
comma
r_sizeof
(paren
r_struct
id|sc_state_sbc
)paren
comma
id|sbc_open
comma
id|sbc_close
comma
id|sbc_ioctl
comma
id|sbc_sethw
)brace
suffix:semicolon
multiline_comment|/* --------------------------------------------------------------------- */
eof
