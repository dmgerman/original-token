multiline_comment|/*&t;$Id: com90xx.c,v 1.6 1997/11/09 11:05:01 mj Exp $&n;&n;&t;Derived from the original arcnet.c,&n;&t;Written 1994-1996 by Avery Pennarun,&n;&t;which was in turn derived from skeleton.c by Donald Becker.&n;&n;&t;Contact Avery at: apenwarr@bond.net or&n;&t;RR #5 Pole Line Road, Thunder Bay, ON, Canada P7C 5M9&n;&n;&t;**********************&n;&n;&t;The original copyright of skeleton.c was as follows:&n;&n;&t;skeleton.c Written 1993 by Donald Becker.&n;&t;Copyright 1993 United States Government as represented by the&n;        Director, National Security Agency.  This software may only be used&n;        and distributed according to the terms of the GNU Public License as&n;        modified by SRC, incorporated herein by reference.&n;&n;&t;**********************&n;&n;&t;For more details, see drivers/net/arcnet.c&n;&n;&t;**********************&n;*/
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/version.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/fcntl.h&gt;
macro_line|#include &lt;linux/interrupt.h&gt;
macro_line|#include &lt;linux/ptrace.h&gt;
macro_line|#include &lt;linux/ioport.h&gt;
macro_line|#include &lt;linux/in.h&gt;
macro_line|#include &lt;linux/malloc.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/timer.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;linux/netdevice.h&gt;
macro_line|#include &lt;linux/if_arp.h&gt;
macro_line|#include &lt;linux/etherdevice.h&gt;
macro_line|#include &lt;linux/skbuff.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/if_arcnet.h&gt;
macro_line|#include &lt;linux/arcdevice.h&gt;
macro_line|#include &lt;asm/system.h&gt;
macro_line|#include &lt;asm/bitops.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/dma.h&gt;
macro_line|#include &lt;net/arp.h&gt;
multiline_comment|/**************************************************************************/
multiline_comment|/* On a fast computer, the buffer copy from memory to the ARCnet card during&n; * a transmit can hog the bus just a little too long.  SLOW_XMIT_COPY&n; * replaces the fast memcpy() with a slower for() loop that seems to solve&n; * my problems with ftape.&n; *&n; * Probably a better solution would be to use memcpy_toio (more portable&n; * anyway) and modify that routine to support REALLY_SLOW_IO-style&n; * defines; ARCnet probably is not the only driver that can screw up an&n; * ftape DMA transfer.&n; *&n; * Turn this on if you have timing-sensitive DMA (ie. a tape drive) and&n; * would like to sacrifice a little bit of network speed to reduce tape&n; * write retries or some related problem.&n; */
DECL|macro|SLOW_XMIT_COPY
macro_line|#undef SLOW_XMIT_COPY
multiline_comment|/* Define this to speed up the autoprobe by assuming if only one io port and&n; * shmem are left in the list at Stage 5, they must correspond to each&n; * other.&n; *&n; * This is undefined by default because it might not always be true, and the&n; * extra check makes the autoprobe even more careful.  Speed demons can turn&n; * it on - I think it should be fine if you only have one ARCnet card&n; * installed.&n; *&n; * If no ARCnet cards are installed, this delay never happens anyway and thus&n; * the option has no effect.&n; */
DECL|macro|FAST_PROBE
macro_line|#undef FAST_PROBE
multiline_comment|/* Internal function declarations */
macro_line|#ifdef MODULE
r_static
macro_line|#endif
r_int
id|arc90xx_probe
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_void
id|arc90xx_rx
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
r_int
id|recbuf
)paren
suffix:semicolon
r_static
r_int
id|arc90xx_found
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
r_int
id|ioaddr
comma
r_int
id|airq
comma
id|u_long
id|shmem
comma
r_int
id|more
)paren
suffix:semicolon
r_static
r_void
id|arc90xx_inthandler
(paren
r_struct
id|device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_int
id|arc90xx_reset
(paren
r_struct
id|device
op_star
id|dev
comma
r_int
id|reset_delay
)paren
suffix:semicolon
r_static
r_void
id|arc90xx_setmask
(paren
r_struct
id|device
op_star
id|dev
comma
id|u_char
id|mask
)paren
suffix:semicolon
r_static
r_void
id|arc90xx_command
(paren
r_struct
id|device
op_star
id|dev
comma
id|u_char
id|command
)paren
suffix:semicolon
r_static
id|u_char
id|arc90xx_status
(paren
r_struct
id|device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_void
id|arc90xx_prepare_tx
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
id|u_char
op_star
id|hdr
comma
r_int
id|hdrlen
comma
r_char
op_star
id|data
comma
r_int
id|length
comma
r_int
id|daddr
comma
r_int
id|exceptA
comma
r_int
id|offset
)paren
suffix:semicolon
r_static
r_void
id|arc90xx_openclose
c_func
(paren
r_int
id|open
)paren
suffix:semicolon
multiline_comment|/* Module parameters */
macro_line|#ifdef MODULE
DECL|variable|io
r_static
r_int
id|io
op_assign
l_int|0x0
suffix:semicolon
multiline_comment|/* &lt;--- EDIT THESE LINES FOR YOUR CONFIGURATION */
DECL|variable|irq
r_static
r_int
id|irq
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* or use the insmod io= irq= shmem= options */
DECL|variable|shmem
r_static
r_int
id|shmem
op_assign
l_int|0
suffix:semicolon
DECL|variable|device
r_static
r_char
op_star
id|device
suffix:semicolon
multiline_comment|/* use eg. device=&quot;arc1&quot; to change name */
id|MODULE_PARM
c_func
(paren
id|io
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|irq
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|shmem
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|device
comma
l_string|&quot;s&quot;
)paren
suffix:semicolon
macro_line|#else
id|__initfunc
c_func
(paren
r_void
id|com90xx_setup
(paren
r_char
op_star
id|str
comma
r_int
op_star
id|ints
)paren
)paren
suffix:semicolon
DECL|variable|com90xx_explicit
r_char
id|__initdata
id|com90xx_explicit
op_assign
l_int|0
suffix:semicolon
r_extern
r_struct
id|device
id|arcnet_devs
(braket
)braket
suffix:semicolon
r_extern
r_char
id|arcnet_dev_names
(braket
)braket
(braket
l_int|10
)braket
suffix:semicolon
r_extern
r_int
id|arcnet_num_devs
suffix:semicolon
macro_line|#endif
multiline_comment|/* Handy defines for ARCnet specific stuff */
multiline_comment|/* The number of low I/O ports used by the card. */
DECL|macro|ARCNET_TOTAL_SIZE
mdefine_line|#define ARCNET_TOTAL_SIZE&t;16
multiline_comment|/* COM 9026 controller chip --&gt; ARCnet register addresses */
DECL|macro|_INTMASK
mdefine_line|#define _INTMASK (ioaddr+0)&t;/* writable */
DECL|macro|_STATUS
mdefine_line|#define _STATUS  (ioaddr+0)&t;/* readable */
DECL|macro|_COMMAND
mdefine_line|#define _COMMAND (ioaddr+1)&t;/* writable, returns random vals on read (?) */
DECL|macro|_RESET
mdefine_line|#define _RESET  (ioaddr+8)&t;/* software reset (on read) */
DECL|macro|_MEMDATA
mdefine_line|#define _MEMDATA  (ioaddr+12)            /* Data port for IO-mapped memory */
DECL|macro|_ADDR_HI
mdefine_line|#define _ADDR_HI  (ioaddr+15)            /* Control registers for said */
DECL|macro|_ADDR_LO
mdefine_line|#define _ADDR_LO  (ioaddr+14)
DECL|macro|_CONFIG
mdefine_line|#define _CONFIG  (ioaddr+2)      /* Configuration register */
DECL|macro|RDDATAflag
mdefine_line|#define RDDATAflag      0x00     /* Next access is a read/~write */
DECL|macro|ARCSTATUS
mdefine_line|#define ARCSTATUS&t;inb(_STATUS)
DECL|macro|ACOMMAND
mdefine_line|#define ACOMMAND(cmd) &t;outb((cmd),_COMMAND)
DECL|macro|AINTMASK
mdefine_line|#define AINTMASK(msk)&t;outb((msk),_INTMASK)
DECL|macro|SETCONF
mdefine_line|#define SETCONF&t;&t;outb(lp-&gt;config,_CONFIG)
DECL|macro|ARCRESET
mdefine_line|#define ARCRESET&t;inb(_RESET)
DECL|variable|version
r_static
r_const
r_char
op_star
id|version
op_assign
l_string|&quot;com90xx.c: v3.00 97/11/09 Avery Pennarun &lt;apenwarr@bond.net&gt; et al.&bslash;n&quot;
suffix:semicolon
multiline_comment|/****************************************************************************&n; *                                                                          *&n; * Probe and initialization                                                 *&n; *                                                                          *&n; ****************************************************************************/
multiline_comment|/* Check for an ARCnet network adaptor, and return &squot;0&squot; if one exists.&n; *  If dev-&gt;base_addr == 0, probe all likely locations.&n; *  If dev-&gt;base_addr == 1, always return failure.&n; *  If dev-&gt;base_addr == 2, allocate space for the device and return success&n; *  &t;&t;&t;    (detachable devices only).&n; *&n; * NOTE: the list of possible ports/shmems is static, so it is retained&n; * across calls to arcnet_probe.  So, if more than one ARCnet probe is made,&n; * values that were discarded once will not even be tried again.&n; *&n; * FIXME: grab all devices in one shot and eliminate the big static array.&n; */
DECL|variable|__initdata
r_static
r_int
id|ports
(braket
(paren
l_int|0x3f0
op_minus
l_int|0x200
)paren
op_div
l_int|16
op_plus
l_int|1
)braket
id|__initdata
op_assign
(brace
l_int|0
)brace
suffix:semicolon
DECL|variable|__initdata
r_static
id|u_long
id|shmems
(braket
(paren
l_int|0xFF800
op_minus
l_int|0xA0000
)paren
op_div
l_int|2048
op_plus
l_int|1
)braket
id|__initdata
op_assign
(brace
l_int|0
)brace
suffix:semicolon
DECL|function|__initfunc
id|__initfunc
c_func
(paren
r_int
id|arc90xx_probe
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
)paren
(brace
r_static
r_int
id|init_once
op_assign
l_int|0
suffix:semicolon
r_static
r_int
id|numports
op_assign
r_sizeof
(paren
id|ports
)paren
op_div
r_sizeof
(paren
id|ports
(braket
l_int|0
)braket
)paren
comma
id|numshmems
op_assign
r_sizeof
(paren
id|shmems
)paren
op_div
r_sizeof
(paren
id|shmems
(braket
l_int|0
)braket
)paren
suffix:semicolon
r_int
id|count
comma
id|status
comma
id|delayval
comma
id|ioaddr
comma
id|numprint
comma
id|airq
comma
id|retval
op_assign
op_minus
id|ENODEV
comma
id|openparen
op_assign
l_int|0
suffix:semicolon
r_int
r_int
id|airqmask
suffix:semicolon
r_int
op_star
id|port
suffix:semicolon
id|u_long
op_star
id|shmem
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|init_once
)paren
(brace
r_for
c_loop
(paren
id|count
op_assign
l_int|0x200
suffix:semicolon
id|count
op_le
l_int|0x3f0
suffix:semicolon
id|count
op_add_assign
l_int|16
)paren
id|ports
(braket
(paren
id|count
op_minus
l_int|0x200
)paren
op_div
l_int|16
)braket
op_assign
id|count
suffix:semicolon
r_for
c_loop
(paren
id|count
op_assign
l_int|0xA0000
suffix:semicolon
id|count
op_le
l_int|0xFF800
suffix:semicolon
id|count
op_add_assign
l_int|2048
)paren
id|shmems
(braket
(paren
id|count
op_minus
l_int|0xA0000
)paren
op_div
l_int|2048
)braket
op_assign
id|count
suffix:semicolon
id|BUGLVL
c_func
(paren
id|D_NORMAL
)paren
id|printk
c_func
(paren
id|version
)paren
suffix:semicolon
id|BUGMSG
c_func
(paren
id|D_DURING
comma
l_string|&quot;space used for probe buffers: %d+%d=%d bytes&bslash;n&quot;
comma
r_sizeof
(paren
id|ports
)paren
comma
r_sizeof
(paren
id|shmems
)paren
comma
r_sizeof
(paren
id|ports
)paren
op_plus
r_sizeof
(paren
id|shmems
)paren
)paren
suffix:semicolon
)brace
id|init_once
op_increment
suffix:semicolon
id|BUGMSG
c_func
(paren
id|D_INIT
comma
l_string|&quot;given: base %lXh, IRQ %d, shmem %lXh&bslash;n&quot;
comma
id|dev-&gt;base_addr
comma
id|dev-&gt;irq
comma
id|dev-&gt;mem_start
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;base_addr
OG
l_int|0x1ff
)paren
multiline_comment|/* Check a single specified port */
(brace
id|ports
(braket
l_int|0
)braket
op_assign
id|dev-&gt;base_addr
suffix:semicolon
id|numports
op_assign
l_int|1
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|dev-&gt;base_addr
OG
l_int|0
)paren
multiline_comment|/* Don&squot;t probe at all. */
r_return
op_minus
id|ENXIO
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;mem_start
)paren
(brace
id|shmems
(braket
l_int|0
)braket
op_assign
id|dev-&gt;mem_start
suffix:semicolon
id|numshmems
op_assign
l_int|1
suffix:semicolon
)brace
multiline_comment|/* Stage 1: abandon any reserved ports, or ones with status==0xFF&n;   * (empty), and reset any others by reading the reset port.&n;   */
id|BUGMSG
c_func
(paren
id|D_INIT
comma
l_string|&quot;Stage 1: &quot;
)paren
suffix:semicolon
id|numprint
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|port
op_assign
op_amp
id|ports
(braket
l_int|0
)braket
suffix:semicolon
id|port
op_minus
id|ports
OL
id|numports
suffix:semicolon
id|port
op_increment
)paren
(brace
id|numprint
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|numprint
OG
l_int|8
)paren
(brace
id|BUGMSG2
c_func
(paren
id|D_INIT
comma
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
id|BUGMSG
c_func
(paren
id|D_INIT
comma
l_string|&quot;Stage 1: &quot;
)paren
suffix:semicolon
id|numprint
op_assign
l_int|1
suffix:semicolon
)brace
id|BUGMSG2
c_func
(paren
id|D_INIT
comma
l_string|&quot;%Xh &quot;
comma
op_star
id|port
)paren
suffix:semicolon
id|ioaddr
op_assign
op_star
id|port
suffix:semicolon
r_if
c_cond
(paren
id|check_region
c_func
(paren
op_star
id|port
comma
id|ARCNET_TOTAL_SIZE
)paren
)paren
(brace
id|BUGMSG2
c_func
(paren
id|D_INIT_REASONS
comma
l_string|&quot;(check_region)&bslash;n&quot;
)paren
suffix:semicolon
id|BUGMSG
c_func
(paren
id|D_INIT_REASONS
comma
l_string|&quot;Stage 1: &quot;
)paren
suffix:semicolon
id|BUGLVL
c_func
(paren
id|D_INIT_REASONS
)paren
id|numprint
op_assign
l_int|0
suffix:semicolon
op_star
id|port
op_assign
id|ports
(braket
id|numports
op_minus
l_int|1
)braket
suffix:semicolon
id|numports
op_decrement
suffix:semicolon
id|port
op_decrement
suffix:semicolon
r_continue
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ARCSTATUS
op_eq
l_int|0xFF
)paren
(brace
id|BUGMSG2
c_func
(paren
id|D_INIT_REASONS
comma
l_string|&quot;(empty)&bslash;n&quot;
)paren
suffix:semicolon
id|BUGMSG
c_func
(paren
id|D_INIT_REASONS
comma
l_string|&quot;Stage 1: &quot;
)paren
suffix:semicolon
id|BUGLVL
c_func
(paren
id|D_INIT_REASONS
)paren
id|numprint
op_assign
l_int|0
suffix:semicolon
op_star
id|port
op_assign
id|ports
(braket
id|numports
op_minus
l_int|1
)braket
suffix:semicolon
id|numports
op_decrement
suffix:semicolon
id|port
op_decrement
suffix:semicolon
r_continue
suffix:semicolon
)brace
id|ARCRESET
suffix:semicolon
multiline_comment|/* begin resetting card */
id|BUGMSG2
c_func
(paren
id|D_INIT_REASONS
comma
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
id|BUGMSG
c_func
(paren
id|D_INIT_REASONS
comma
l_string|&quot;Stage 1: &quot;
)paren
suffix:semicolon
id|BUGLVL
c_func
(paren
id|D_INIT_REASONS
)paren
id|numprint
op_assign
l_int|0
suffix:semicolon
)brace
id|BUGMSG2
c_func
(paren
id|D_INIT
comma
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|numports
)paren
(brace
id|BUGMSG
c_func
(paren
id|D_NORMAL
comma
l_string|&quot;Stage 1: No ARCnet cards found.&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
multiline_comment|/* Stage 2: we have now reset any possible ARCnet cards, so we can&squot;t&n;   * do anything until they finish.  If D_INIT, print the list of&n;   * cards that are left.&n;   */
id|BUGMSG
c_func
(paren
id|D_INIT
comma
l_string|&quot;Stage 2: &quot;
)paren
suffix:semicolon
id|numprint
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|port
op_assign
op_amp
id|ports
(braket
l_int|0
)braket
suffix:semicolon
id|port
op_minus
id|ports
OL
id|numports
suffix:semicolon
id|port
op_increment
)paren
(brace
id|numprint
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|numprint
OG
l_int|8
)paren
(brace
id|BUGMSG2
c_func
(paren
id|D_INIT
comma
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
id|BUGMSG
c_func
(paren
id|D_INIT
comma
l_string|&quot;Stage 2: &quot;
)paren
suffix:semicolon
id|numprint
op_assign
l_int|1
suffix:semicolon
)brace
id|BUGMSG2
c_func
(paren
id|D_INIT
comma
l_string|&quot;%Xh &quot;
comma
op_star
id|port
)paren
suffix:semicolon
)brace
id|BUGMSG2
c_func
(paren
id|D_INIT
comma
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
id|JIFFER
c_func
(paren
id|RESETtime
)paren
suffix:semicolon
multiline_comment|/* Stage 3: abandon any shmem addresses that don&squot;t have the signature&n;   * 0xD1 byte in the right place, or are read-only.&n;   */
id|BUGMSG
c_func
(paren
id|D_INIT
comma
l_string|&quot;Stage 3: &quot;
)paren
suffix:semicolon
id|numprint
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|shmem
op_assign
op_amp
id|shmems
(braket
l_int|0
)braket
suffix:semicolon
id|shmem
op_minus
id|shmems
OL
id|numshmems
suffix:semicolon
id|shmem
op_increment
)paren
(brace
id|u_long
id|ptr
suffix:semicolon
id|numprint
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|numprint
OG
l_int|8
)paren
(brace
id|BUGMSG2
c_func
(paren
id|D_INIT
comma
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
id|BUGMSG
c_func
(paren
id|D_INIT
comma
l_string|&quot;Stage 3: &quot;
)paren
suffix:semicolon
id|numprint
op_assign
l_int|1
suffix:semicolon
)brace
id|BUGMSG2
c_func
(paren
id|D_INIT
comma
l_string|&quot;%lXh &quot;
comma
op_star
id|shmem
)paren
suffix:semicolon
id|ptr
op_assign
(paren
id|u_long
)paren
(paren
op_star
id|shmem
)paren
suffix:semicolon
r_if
c_cond
(paren
id|readb
c_func
(paren
id|ptr
)paren
op_ne
id|TESTvalue
)paren
(brace
id|BUGMSG2
c_func
(paren
id|D_INIT_REASONS
comma
l_string|&quot;(mem=%02Xh, not %02Xh)&bslash;n&quot;
comma
id|readb
c_func
(paren
id|ptr
)paren
comma
id|TESTvalue
)paren
suffix:semicolon
id|BUGMSG
c_func
(paren
id|D_INIT_REASONS
comma
l_string|&quot;Stage 3: &quot;
)paren
suffix:semicolon
id|BUGLVL
c_func
(paren
id|D_INIT_REASONS
)paren
id|numprint
op_assign
l_int|0
suffix:semicolon
op_star
id|shmem
op_assign
id|shmems
(braket
id|numshmems
op_minus
l_int|1
)braket
suffix:semicolon
id|numshmems
op_decrement
suffix:semicolon
id|shmem
op_decrement
suffix:semicolon
r_continue
suffix:semicolon
)brace
multiline_comment|/* By writing 0x42 to the TESTvalue location, we also make&n;       * sure no &quot;mirror&quot; shmem areas show up - if they occur&n;       * in another pass through this loop, they will be discarded&n;       * because *cptr != TESTvalue.&n;       */
id|writeb
c_func
(paren
l_int|0x42
comma
id|ptr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|readb
c_func
(paren
id|ptr
)paren
op_ne
l_int|0x42
)paren
(brace
id|BUGMSG2
c_func
(paren
id|D_INIT_REASONS
comma
l_string|&quot;(read only)&bslash;n&quot;
)paren
suffix:semicolon
id|BUGMSG
c_func
(paren
id|D_INIT_REASONS
comma
l_string|&quot;Stage 3: &quot;
)paren
suffix:semicolon
op_star
id|shmem
op_assign
id|shmems
(braket
id|numshmems
op_minus
l_int|1
)braket
suffix:semicolon
id|numshmems
op_decrement
suffix:semicolon
id|shmem
op_decrement
suffix:semicolon
r_continue
suffix:semicolon
)brace
id|BUGMSG2
c_func
(paren
id|D_INIT_REASONS
comma
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
id|BUGMSG
c_func
(paren
id|D_INIT_REASONS
comma
l_string|&quot;Stage 3: &quot;
)paren
suffix:semicolon
id|BUGLVL
c_func
(paren
id|D_INIT_REASONS
)paren
id|numprint
op_assign
l_int|0
suffix:semicolon
)brace
id|BUGMSG2
c_func
(paren
id|D_INIT
comma
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|numshmems
)paren
(brace
id|BUGMSG
c_func
(paren
id|D_NORMAL
comma
l_string|&quot;Stage 3: No ARCnet cards found.&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
multiline_comment|/* Stage 4: something of a dummy, to report the shmems that are&n;   * still possible after stage 3.&n;   */
id|BUGMSG
c_func
(paren
id|D_INIT
comma
l_string|&quot;Stage 4: &quot;
)paren
suffix:semicolon
id|numprint
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|shmem
op_assign
op_amp
id|shmems
(braket
l_int|0
)braket
suffix:semicolon
id|shmem
op_minus
id|shmems
OL
id|numshmems
suffix:semicolon
id|shmem
op_increment
)paren
(brace
id|numprint
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|numprint
OG
l_int|8
)paren
(brace
id|BUGMSG2
c_func
(paren
id|D_INIT
comma
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
id|BUGMSG
c_func
(paren
id|D_INIT
comma
l_string|&quot;Stage 4: &quot;
)paren
suffix:semicolon
id|numprint
op_assign
l_int|1
suffix:semicolon
)brace
id|BUGMSG2
c_func
(paren
id|D_INIT
comma
l_string|&quot;%lXh &quot;
comma
op_star
id|shmem
)paren
suffix:semicolon
)brace
id|BUGMSG2
c_func
(paren
id|D_INIT
comma
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* Stage 5: for any ports that have the correct status, can disable&n;   * the RESET flag, and (if no irq is given) generate an autoirq,&n;   * register an ARCnet device.&n;   *&n;   * Currently, we can only register one device per probe, so quit&n;   * after the first one is found.&n;   */
id|BUGMSG
c_func
(paren
id|D_INIT
comma
l_string|&quot;Stage 5: &quot;
)paren
suffix:semicolon
id|numprint
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|port
op_assign
op_amp
id|ports
(braket
l_int|0
)braket
suffix:semicolon
id|port
op_minus
id|ports
OL
id|numports
suffix:semicolon
id|port
op_increment
)paren
(brace
id|numprint
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|numprint
OG
l_int|8
)paren
(brace
id|BUGMSG2
c_func
(paren
id|D_INIT
comma
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
id|BUGMSG
c_func
(paren
id|D_INIT
comma
l_string|&quot;Stage 5: &quot;
)paren
suffix:semicolon
id|numprint
op_assign
l_int|1
suffix:semicolon
)brace
id|BUGMSG2
c_func
(paren
id|D_INIT
comma
l_string|&quot;%Xh &quot;
comma
op_star
id|port
)paren
suffix:semicolon
id|ioaddr
op_assign
op_star
id|port
suffix:semicolon
id|status
op_assign
id|ARCSTATUS
suffix:semicolon
r_if
c_cond
(paren
(paren
id|status
op_amp
l_int|0x9D
)paren
op_ne
(paren
id|NORXflag
op_or
id|RECONflag
op_or
id|TXFREEflag
op_or
id|RESETflag
)paren
)paren
(brace
id|BUGMSG2
c_func
(paren
id|D_INIT_REASONS
comma
l_string|&quot;(status=%Xh)&bslash;n&quot;
comma
id|status
)paren
suffix:semicolon
id|BUGMSG
c_func
(paren
id|D_INIT_REASONS
comma
l_string|&quot;Stage 5: &quot;
)paren
suffix:semicolon
id|BUGLVL
c_func
(paren
id|D_INIT_REASONS
)paren
id|numprint
op_assign
l_int|0
suffix:semicolon
op_star
id|port
op_assign
id|ports
(braket
id|numports
op_minus
l_int|1
)braket
suffix:semicolon
id|numports
op_decrement
suffix:semicolon
id|port
op_decrement
suffix:semicolon
r_continue
suffix:semicolon
)brace
id|ACOMMAND
c_func
(paren
id|CFLAGScmd
op_or
id|RESETclear
op_or
id|CONFIGclear
)paren
suffix:semicolon
id|status
op_assign
id|ARCSTATUS
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
id|RESETflag
)paren
(brace
id|BUGMSG2
c_func
(paren
id|D_INIT_REASONS
comma
l_string|&quot; (eternal reset, status=%Xh)&bslash;n&quot;
comma
id|status
)paren
suffix:semicolon
id|BUGMSG
c_func
(paren
id|D_INIT_REASONS
comma
l_string|&quot;Stage 5: &quot;
)paren
suffix:semicolon
id|BUGLVL
c_func
(paren
id|D_INIT_REASONS
)paren
id|numprint
op_assign
l_int|0
suffix:semicolon
op_star
id|port
op_assign
id|ports
(braket
id|numports
op_minus
l_int|1
)braket
suffix:semicolon
id|numports
op_decrement
suffix:semicolon
id|port
op_decrement
suffix:semicolon
r_continue
suffix:semicolon
)brace
multiline_comment|/* skip this completely if an IRQ was given, because maybe&n;       * we&squot;re on a machine that locks during autoirq!&n;       */
r_if
c_cond
(paren
op_logical_neg
id|dev-&gt;irq
)paren
(brace
multiline_comment|/* if we do this, we&squot;re sure to get an IRQ since the&n;&t;   * card has just reset and the NORXflag is on until&n;&t;   * we tell it to start receiving.&n;&t;   */
id|airqmask
op_assign
id|probe_irq_on
c_func
(paren
)paren
suffix:semicolon
id|AINTMASK
c_func
(paren
id|NORXflag
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|1
)paren
suffix:semicolon
id|AINTMASK
c_func
(paren
l_int|0
)paren
suffix:semicolon
id|airq
op_assign
id|probe_irq_off
c_func
(paren
id|airqmask
)paren
suffix:semicolon
r_if
c_cond
(paren
id|airq
op_le
l_int|0
)paren
(brace
id|BUGMSG2
c_func
(paren
id|D_INIT_REASONS
comma
l_string|&quot;(airq=%d)&bslash;n&quot;
comma
id|airq
)paren
suffix:semicolon
id|BUGMSG
c_func
(paren
id|D_INIT_REASONS
comma
l_string|&quot;Stage 5: &quot;
)paren
suffix:semicolon
id|BUGLVL
c_func
(paren
id|D_INIT_REASONS
)paren
id|numprint
op_assign
l_int|0
suffix:semicolon
op_star
id|port
op_assign
id|ports
(braket
id|numports
op_minus
l_int|1
)braket
suffix:semicolon
id|numports
op_decrement
suffix:semicolon
id|port
op_decrement
suffix:semicolon
r_continue
suffix:semicolon
)brace
)brace
r_else
(brace
id|airq
op_assign
id|dev-&gt;irq
suffix:semicolon
)brace
id|BUGMSG2
c_func
(paren
id|D_INIT
comma
l_string|&quot;(%d,&quot;
comma
id|airq
)paren
suffix:semicolon
id|openparen
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* Everything seems okay.  But which shmem, if any, puts&n;       * back its signature byte when the card is reset?&n;       *&n;       * If there are multiple cards installed, there might be&n;       * multiple shmems still in the list.&n;       */
macro_line|#ifdef FAST_PROBE
r_if
c_cond
(paren
id|numports
OG
l_int|1
op_logical_or
id|numshmems
OG
l_int|1
)paren
(brace
id|ARCRESET
suffix:semicolon
id|JIFFER
c_func
(paren
id|RESETtime
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* just one shmem and port, assume they match */
id|writeb
c_func
(paren
id|TESTvalue
comma
id|shmems
(braket
l_int|0
)braket
)paren
suffix:semicolon
)brace
macro_line|#else
id|ARCRESET
suffix:semicolon
id|JIFFER
c_func
(paren
id|RESETtime
)paren
suffix:semicolon
macro_line|#endif
r_for
c_loop
(paren
id|shmem
op_assign
op_amp
id|shmems
(braket
l_int|0
)braket
suffix:semicolon
id|shmem
op_minus
id|shmems
OL
id|numshmems
suffix:semicolon
id|shmem
op_increment
)paren
(brace
id|u_long
id|ptr
suffix:semicolon
id|ptr
op_assign
(paren
id|u_long
)paren
(paren
op_star
id|shmem
)paren
suffix:semicolon
r_if
c_cond
(paren
id|readb
c_func
(paren
id|ptr
)paren
op_eq
id|TESTvalue
)paren
multiline_comment|/* found one */
(brace
r_int
id|probe_more
suffix:semicolon
id|BUGMSG2
c_func
(paren
id|D_INIT
comma
l_string|&quot;%lXh)&bslash;n&quot;
comma
op_star
id|shmem
)paren
suffix:semicolon
id|openparen
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* register the card */
r_if
c_cond
(paren
id|init_once
op_eq
l_int|1
op_logical_and
id|numshmems
OG
l_int|1
)paren
id|probe_more
op_assign
id|numshmems
op_minus
l_int|1
suffix:semicolon
r_else
id|probe_more
op_assign
l_int|0
suffix:semicolon
id|retval
op_assign
id|arc90xx_found
c_func
(paren
id|dev
comma
op_star
id|port
comma
id|airq
comma
op_star
id|shmem
comma
id|probe_more
)paren
suffix:semicolon
r_if
c_cond
(paren
id|retval
)paren
id|openparen
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* remove shmem from the list */
op_star
id|shmem
op_assign
id|shmems
(braket
id|numshmems
op_minus
l_int|1
)braket
suffix:semicolon
id|numshmems
op_decrement
suffix:semicolon
r_break
suffix:semicolon
)brace
r_else
(brace
id|BUGMSG2
c_func
(paren
id|D_INIT_REASONS
comma
l_string|&quot;%Xh-&quot;
comma
id|readb
c_func
(paren
id|ptr
)paren
)paren
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|openparen
)paren
(brace
id|BUGMSG2
c_func
(paren
id|D_INIT
comma
l_string|&quot;no matching shmem)&bslash;n&quot;
)paren
suffix:semicolon
id|BUGMSG
c_func
(paren
id|D_INIT_REASONS
comma
l_string|&quot;Stage 5: &quot;
)paren
suffix:semicolon
id|BUGLVL
c_func
(paren
id|D_INIT_REASONS
)paren
id|numprint
op_assign
l_int|0
suffix:semicolon
)brace
op_star
id|port
op_assign
id|ports
(braket
id|numports
op_minus
l_int|1
)braket
suffix:semicolon
id|numports
op_decrement
suffix:semicolon
id|port
op_decrement
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|retval
)paren
r_break
suffix:semicolon
)brace
id|BUGMSG
c_func
(paren
id|D_INIT_REASONS
comma
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* Now put back TESTvalue on all leftover shmems.&n;   */
r_for
c_loop
(paren
id|shmem
op_assign
op_amp
id|shmems
(braket
l_int|0
)braket
suffix:semicolon
id|shmem
op_minus
id|shmems
OL
id|numshmems
suffix:semicolon
id|shmem
op_increment
)paren
id|writeb
c_func
(paren
id|TESTvalue
comma
op_star
id|shmem
)paren
suffix:semicolon
r_if
c_cond
(paren
id|retval
)paren
id|BUGMSG
c_func
(paren
id|D_NORMAL
comma
l_string|&quot;Stage 5: No ARCnet cards found.&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|retval
suffix:semicolon
)brace
multiline_comment|/* Set up the struct device associated with this card.  Called after&n; * probing succeeds.&n; */
DECL|function|__initfunc
id|__initfunc
c_func
(paren
r_static
r_int
id|arc90xx_found
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
r_int
id|ioaddr
comma
r_int
id|airq
comma
id|u_long
id|shmem
comma
r_int
id|more
)paren
)paren
(brace
r_struct
id|arcnet_local
op_star
id|lp
suffix:semicolon
id|u_long
id|first_mirror
comma
id|last_mirror
suffix:semicolon
r_int
id|mirror_size
suffix:semicolon
multiline_comment|/* reserve the irq */
r_if
c_cond
(paren
id|request_irq
c_func
(paren
id|airq
comma
op_amp
id|arcnet_interrupt
comma
l_int|0
comma
l_string|&quot;arcnet (90xx)&quot;
comma
id|dev
)paren
)paren
(brace
id|BUGMSG
c_func
(paren
id|D_NORMAL
comma
l_string|&quot;Can&squot;t get IRQ %d!&bslash;n&quot;
comma
id|airq
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
id|dev-&gt;irq
op_assign
id|airq
suffix:semicolon
multiline_comment|/* reserve the I/O region - guaranteed to work by check_region */
id|request_region
c_func
(paren
id|ioaddr
comma
id|ARCNET_TOTAL_SIZE
comma
l_string|&quot;arcnet (90xx)&quot;
)paren
suffix:semicolon
id|dev-&gt;base_addr
op_assign
id|ioaddr
suffix:semicolon
multiline_comment|/* find the real shared memory start/end points, including mirrors */
DECL|macro|BUFFER_SIZE
mdefine_line|#define BUFFER_SIZE (512)
DECL|macro|MIRROR_SIZE
mdefine_line|#define MIRROR_SIZE (BUFFER_SIZE*4)
multiline_comment|/* guess the actual size of one &quot;memory mirror&quot; - the number of&n;   * bytes between copies of the shared memory.  On most cards, it&squot;s&n;   * 2k (or there are no mirrors at all) but on some, it&squot;s 4k.&n;   */
id|mirror_size
op_assign
id|MIRROR_SIZE
suffix:semicolon
r_if
c_cond
(paren
id|readb
c_func
(paren
id|shmem
)paren
op_eq
id|TESTvalue
op_logical_and
id|readb
c_func
(paren
id|shmem
op_minus
id|mirror_size
)paren
op_ne
id|TESTvalue
op_logical_and
id|readb
c_func
(paren
id|shmem
op_minus
l_int|2
op_star
id|mirror_size
)paren
op_eq
id|TESTvalue
)paren
id|mirror_size
op_mul_assign
l_int|2
suffix:semicolon
id|first_mirror
op_assign
id|last_mirror
op_assign
id|shmem
suffix:semicolon
r_while
c_loop
(paren
id|readb
c_func
(paren
id|first_mirror
)paren
op_eq
id|TESTvalue
)paren
id|first_mirror
op_sub_assign
id|mirror_size
suffix:semicolon
id|first_mirror
op_add_assign
id|mirror_size
suffix:semicolon
r_while
c_loop
(paren
id|readb
c_func
(paren
id|last_mirror
)paren
op_eq
id|TESTvalue
)paren
id|last_mirror
op_add_assign
id|mirror_size
suffix:semicolon
id|last_mirror
op_sub_assign
id|mirror_size
suffix:semicolon
id|dev-&gt;mem_start
op_assign
id|first_mirror
suffix:semicolon
id|dev-&gt;mem_end
op_assign
id|last_mirror
op_plus
id|MIRROR_SIZE
op_minus
l_int|1
suffix:semicolon
id|dev-&gt;rmem_start
op_assign
id|dev-&gt;mem_start
op_plus
id|BUFFER_SIZE
op_star
l_int|0
suffix:semicolon
id|dev-&gt;rmem_end
op_assign
id|dev-&gt;mem_start
op_plus
id|BUFFER_SIZE
op_star
l_int|2
op_minus
l_int|1
suffix:semicolon
multiline_comment|/* Initialize the rest of the device structure. */
id|dev-&gt;priv
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|arcnet_local
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;priv
op_eq
l_int|NULL
)paren
(brace
id|free_irq
c_func
(paren
id|airq
comma
id|dev
)paren
suffix:semicolon
id|release_region
c_func
(paren
id|ioaddr
comma
id|ARCNET_TOTAL_SIZE
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|memset
c_func
(paren
id|dev-&gt;priv
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|arcnet_local
)paren
)paren
suffix:semicolon
id|lp
op_assign
(paren
r_struct
id|arcnet_local
op_star
)paren
(paren
id|dev-&gt;priv
)paren
suffix:semicolon
id|lp-&gt;card_type
op_assign
id|ARC_90xx
suffix:semicolon
id|lp-&gt;card_type_str
op_assign
l_string|&quot;COM 90xx&quot;
suffix:semicolon
id|lp-&gt;arcnet_reset
op_assign
id|arc90xx_reset
suffix:semicolon
id|lp-&gt;asetmask
op_assign
id|arc90xx_setmask
suffix:semicolon
id|lp-&gt;astatus
op_assign
id|arc90xx_status
suffix:semicolon
id|lp-&gt;acommand
op_assign
id|arc90xx_command
suffix:semicolon
id|lp-&gt;openclose_device
op_assign
id|arc90xx_openclose
suffix:semicolon
id|lp-&gt;prepare_tx
op_assign
id|arc90xx_prepare_tx
suffix:semicolon
id|lp-&gt;inthandler
op_assign
id|arc90xx_inthandler
suffix:semicolon
multiline_comment|/* Fill in the fields of the device structure with generic&n;   * values.&n;   */
id|arcnet_setup
c_func
(paren
id|dev
)paren
suffix:semicolon
multiline_comment|/* And now fill particular fields with arcnet values */
id|dev-&gt;mtu
op_assign
l_int|1500
suffix:semicolon
multiline_comment|/* completely arbitrary - agrees with ether, though */
id|dev-&gt;hard_header_len
op_assign
r_sizeof
(paren
r_struct
id|ClientData
)paren
suffix:semicolon
id|lp-&gt;sequence
op_assign
l_int|1
suffix:semicolon
id|lp-&gt;recbuf
op_assign
l_int|0
suffix:semicolon
id|BUGMSG
c_func
(paren
id|D_DURING
comma
l_string|&quot;ClientData header size is %d.&bslash;n&quot;
comma
r_sizeof
(paren
r_struct
id|ClientData
)paren
)paren
suffix:semicolon
id|BUGMSG
c_func
(paren
id|D_DURING
comma
l_string|&quot;HardHeader size is %d.&bslash;n&quot;
comma
r_sizeof
(paren
r_struct
id|archdr
)paren
)paren
suffix:semicolon
multiline_comment|/* get and check the station ID from offset 1 in shmem */
id|lp-&gt;stationid
op_assign
id|readb
c_func
(paren
id|first_mirror
op_plus
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|lp-&gt;stationid
op_eq
l_int|0
)paren
id|BUGMSG
c_func
(paren
id|D_NORMAL
comma
l_string|&quot;WARNING!  Station address 00 is reserved &quot;
l_string|&quot;for broadcasts!&bslash;n&quot;
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
id|lp-&gt;stationid
op_eq
l_int|255
)paren
id|BUGMSG
c_func
(paren
id|D_NORMAL
comma
l_string|&quot;WARNING!  Station address FF may confuse &quot;
l_string|&quot;DOS networking programs!&bslash;n&quot;
)paren
suffix:semicolon
id|dev-&gt;dev_addr
(braket
l_int|0
)braket
op_assign
id|lp-&gt;stationid
suffix:semicolon
id|BUGMSG
c_func
(paren
id|D_NORMAL
comma
l_string|&quot;ARCnet COM90xx: station %02Xh found at %03lXh, IRQ %d, &quot;
l_string|&quot;ShMem %lXh (%ld*%xh).&bslash;n&quot;
comma
id|lp-&gt;stationid
comma
id|dev-&gt;base_addr
comma
id|dev-&gt;irq
comma
id|dev-&gt;mem_start
comma
(paren
id|dev-&gt;mem_end
op_minus
id|dev-&gt;mem_start
op_plus
l_int|1
)paren
op_div
id|mirror_size
comma
id|mirror_size
)paren
suffix:semicolon
multiline_comment|/* OK. We&squot;re finished. If there are probably other cards, add other&n;   * COM90xx drivers to the device chain, so they get probed later.&n;   */
macro_line|#ifndef MODULE
r_while
c_loop
(paren
op_logical_neg
id|com90xx_explicit
op_logical_and
id|more
op_decrement
)paren
(brace
r_if
c_cond
(paren
id|arcnet_num_devs
OL
id|MAX_ARCNET_DEVS
)paren
(brace
id|arcnet_devs
(braket
id|arcnet_num_devs
)braket
dot
id|next
op_assign
id|dev-&gt;next
suffix:semicolon
id|dev-&gt;next
op_assign
op_amp
id|arcnet_devs
(braket
id|arcnet_num_devs
)braket
suffix:semicolon
id|dev
op_assign
id|dev-&gt;next
suffix:semicolon
id|dev-&gt;name
op_assign
(paren
r_char
op_star
)paren
op_amp
id|arcnet_dev_names
(braket
id|arcnet_num_devs
)braket
suffix:semicolon
id|arcnet_num_devs
op_increment
suffix:semicolon
)brace
r_else
(brace
id|BUGMSG
c_func
(paren
id|D_NORMAL
comma
l_string|&quot;Too many arcnet devices - no more will be probed for.&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|arcnet_makename
c_func
(paren
id|dev-&gt;name
)paren
suffix:semicolon
id|dev-&gt;init
op_assign
id|arc90xx_probe
suffix:semicolon
)brace
macro_line|#endif
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Do a hardware reset on the card, and set up necessary registers.&n; *&n; * This should be called as little as possible, because it disrupts the&n; * token on the network (causes a RECON) and requires a significant delay.&n; *&n; * However, it does make sure the card is in a defined state.&n; */
DECL|function|arc90xx_reset
r_int
id|arc90xx_reset
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
r_int
id|reset_delay
)paren
(brace
r_struct
id|arcnet_local
op_star
id|lp
op_assign
(paren
r_struct
id|arcnet_local
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_int
id|ioaddr
op_assign
id|dev-&gt;base_addr
suffix:semicolon
r_int
id|delayval
comma
id|recbuf
op_assign
id|lp-&gt;recbuf
suffix:semicolon
r_if
c_cond
(paren
id|reset_delay
op_eq
l_int|3
)paren
(brace
id|ARCRESET
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* no IRQ&squot;s, please! */
id|lp-&gt;intmask
op_assign
l_int|0
suffix:semicolon
id|SETMASK
suffix:semicolon
id|BUGMSG
c_func
(paren
id|D_INIT
comma
l_string|&quot;Resetting %s (status=%Xh)&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|ARCSTATUS
)paren
suffix:semicolon
r_if
c_cond
(paren
id|reset_delay
)paren
(brace
multiline_comment|/* reset the card */
id|ARCRESET
suffix:semicolon
id|JIFFER
c_func
(paren
id|RESETtime
)paren
suffix:semicolon
)brace
id|ACOMMAND
c_func
(paren
id|CFLAGScmd
op_or
id|RESETclear
)paren
suffix:semicolon
multiline_comment|/* clear flags &amp; end reset */
id|ACOMMAND
c_func
(paren
id|CFLAGScmd
op_or
id|CONFIGclear
)paren
suffix:semicolon
multiline_comment|/* verify that the ARCnet signature byte is present */
r_if
c_cond
(paren
id|readb
c_func
(paren
id|dev-&gt;mem_start
)paren
op_ne
id|TESTvalue
)paren
(brace
id|BUGMSG
c_func
(paren
id|D_NORMAL
comma
l_string|&quot;reset failed: TESTvalue not present.&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
multiline_comment|/* clear out status variables */
id|recbuf
op_assign
id|lp-&gt;recbuf
op_assign
l_int|0
suffix:semicolon
id|lp-&gt;txbuf
op_assign
l_int|2
suffix:semicolon
multiline_comment|/* enable extended (512-byte) packets */
id|ACOMMAND
c_func
(paren
id|CONFIGcmd
op_or
id|EXTconf
)paren
suffix:semicolon
macro_line|#ifndef SLOW_XMIT_COPY
multiline_comment|/* clean out all the memory to make debugging make more sense :) */
id|BUGLVL
c_func
(paren
id|D_DURING
)paren
id|memset_io
c_func
(paren
id|dev-&gt;mem_start
comma
l_int|0x42
comma
l_int|2048
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/* and enable receive of our first packet to the first buffer */
id|EnableReceiver
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* re-enable interrupts */
id|lp-&gt;intmask
op_or_assign
id|NORXflag
suffix:semicolon
macro_line|#ifdef DETECT_RECONFIGS
id|lp-&gt;intmask
op_or_assign
id|RECONflag
suffix:semicolon
macro_line|#endif
id|SETMASK
suffix:semicolon
multiline_comment|/* done!  return success. */
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|arc90xx_openclose
r_static
r_void
id|arc90xx_openclose
c_func
(paren
r_int
id|open
)paren
(brace
r_if
c_cond
(paren
id|open
)paren
id|MOD_INC_USE_COUNT
suffix:semicolon
r_else
id|MOD_DEC_USE_COUNT
suffix:semicolon
)brace
DECL|function|arc90xx_setmask
r_static
r_void
id|arc90xx_setmask
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
id|u_char
id|mask
)paren
(brace
r_int
id|ioaddr
op_assign
id|dev-&gt;base_addr
suffix:semicolon
id|AINTMASK
c_func
(paren
id|mask
)paren
suffix:semicolon
)brace
DECL|function|arc90xx_status
r_static
id|u_char
id|arc90xx_status
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
r_int
id|ioaddr
op_assign
id|dev-&gt;base_addr
suffix:semicolon
r_return
id|ARCSTATUS
suffix:semicolon
)brace
DECL|function|arc90xx_command
r_static
r_void
id|arc90xx_command
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
id|u_char
id|cmd
)paren
(brace
r_int
id|ioaddr
op_assign
id|dev-&gt;base_addr
suffix:semicolon
id|ACOMMAND
c_func
(paren
id|cmd
)paren
suffix:semicolon
)brace
multiline_comment|/* The actual interrupt handler routine - handle various IRQ&squot;s generated&n; * by the card.&n; */
r_static
r_void
DECL|function|arc90xx_inthandler
id|arc90xx_inthandler
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
r_struct
id|arcnet_local
op_star
id|lp
op_assign
(paren
r_struct
id|arcnet_local
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_int
id|ioaddr
op_assign
id|dev-&gt;base_addr
comma
id|status
comma
id|boguscount
op_assign
l_int|3
comma
id|didsomething
suffix:semicolon
id|AINTMASK
c_func
(paren
l_int|0
)paren
suffix:semicolon
id|BUGMSG
c_func
(paren
id|D_DURING
comma
l_string|&quot;in arcnet_inthandler (status=%Xh, intmask=%Xh)&bslash;n&quot;
comma
id|ARCSTATUS
comma
id|lp-&gt;intmask
)paren
suffix:semicolon
r_do
(brace
id|status
op_assign
id|ARCSTATUS
suffix:semicolon
id|didsomething
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* RESET flag was enabled - card is resetting and if RX&n;       * is disabled, it&squot;s NOT because we just got a packet.&n;       */
r_if
c_cond
(paren
id|status
op_amp
id|RESETflag
)paren
(brace
id|BUGMSG
c_func
(paren
id|D_NORMAL
comma
l_string|&quot;spurious reset (status=%Xh)&bslash;n&quot;
comma
id|status
)paren
suffix:semicolon
id|arc90xx_reset
c_func
(paren
id|dev
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* all other flag values are just garbage */
r_break
suffix:semicolon
)brace
multiline_comment|/* RX is inhibited - we must have received something. */
r_if
c_cond
(paren
id|status
op_amp
id|lp-&gt;intmask
op_amp
id|NORXflag
)paren
(brace
r_int
id|recbuf
op_assign
id|lp-&gt;recbuf
op_assign
op_logical_neg
id|lp-&gt;recbuf
suffix:semicolon
id|BUGMSG
c_func
(paren
id|D_DURING
comma
l_string|&quot;receive irq (status=%Xh)&bslash;n&quot;
comma
id|status
)paren
suffix:semicolon
multiline_comment|/* enable receive of our next packet */
id|EnableReceiver
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* Got a packet. */
id|arc90xx_rx
c_func
(paren
id|dev
comma
op_logical_neg
id|recbuf
)paren
suffix:semicolon
id|didsomething
op_increment
suffix:semicolon
)brace
multiline_comment|/* it can only be an xmit-done irq if we&squot;re xmitting :) */
multiline_comment|/*if (status&amp;TXFREEflag &amp;&amp; !lp-&gt;in_txhandler &amp;&amp; lp-&gt;sending)*/
r_if
c_cond
(paren
id|status
op_amp
id|lp-&gt;intmask
op_amp
id|TXFREEflag
)paren
(brace
r_struct
id|Outgoing
op_star
id|out
op_assign
op_amp
(paren
id|lp-&gt;outgoing
)paren
suffix:semicolon
r_int
id|was_sending
op_assign
id|lp-&gt;sending
suffix:semicolon
id|lp-&gt;intmask
op_and_assign
op_complement
id|TXFREEflag
suffix:semicolon
id|lp-&gt;in_txhandler
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|was_sending
)paren
id|lp-&gt;sending
op_decrement
suffix:semicolon
id|BUGMSG
c_func
(paren
id|D_DURING
comma
l_string|&quot;TX IRQ (stat=%Xh, numsegs=%d, segnum=%d, skb=%ph)&bslash;n&quot;
comma
id|status
comma
id|out-&gt;numsegs
comma
id|out-&gt;segnum
comma
id|out-&gt;skb
)paren
suffix:semicolon
r_if
c_cond
(paren
id|was_sending
op_logical_and
op_logical_neg
(paren
id|status
op_amp
id|TXACKflag
)paren
)paren
(brace
r_if
c_cond
(paren
id|lp-&gt;lasttrans_dest
op_ne
l_int|0
)paren
(brace
id|BUGMSG
c_func
(paren
id|D_EXTRA
comma
l_string|&quot;transmit was not acknowledged! (status=%Xh, dest=%02Xh)&bslash;n&quot;
comma
id|status
comma
id|lp-&gt;lasttrans_dest
)paren
suffix:semicolon
id|lp-&gt;stats.tx_errors
op_increment
suffix:semicolon
id|lp-&gt;stats.tx_carrier_errors
op_increment
suffix:semicolon
)brace
r_else
(brace
id|BUGMSG
c_func
(paren
id|D_DURING
comma
l_string|&quot;broadcast was not acknowledged; that&squot;s normal (status=%Xh, dest=%02Xh)&bslash;n&quot;
comma
id|status
comma
id|lp-&gt;lasttrans_dest
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* send packet if there is one */
id|arcnet_go_tx
c_func
(paren
id|dev
comma
l_int|0
)paren
suffix:semicolon
id|didsomething
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|lp-&gt;intx
)paren
(brace
id|BUGMSG
c_func
(paren
id|D_DURING
comma
l_string|&quot;TXDONE while intx! (status=%Xh, intx=%d)&bslash;n&quot;
comma
id|ARCSTATUS
comma
id|lp-&gt;intx
)paren
suffix:semicolon
id|lp-&gt;in_txhandler
op_decrement
suffix:semicolon
r_continue
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|lp-&gt;outgoing.skb
)paren
(brace
id|BUGMSG
c_func
(paren
id|D_DURING
comma
l_string|&quot;TX IRQ done: no split to continue.&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* inform upper layers */
r_if
c_cond
(paren
op_logical_neg
id|lp-&gt;txready
)paren
id|arcnet_tx_done
c_func
(paren
id|dev
comma
id|lp
)paren
suffix:semicolon
id|lp-&gt;in_txhandler
op_decrement
suffix:semicolon
r_continue
suffix:semicolon
)brace
multiline_comment|/* if more than one segment, and not all segments&n;&t;   * are done, then continue xmit.&n;&t;   */
r_if
c_cond
(paren
id|out-&gt;segnum
OL
id|out-&gt;numsegs
)paren
id|arcnetA_continue_tx
c_func
(paren
id|dev
)paren
suffix:semicolon
id|arcnet_go_tx
c_func
(paren
id|dev
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* if segnum==numsegs, the transmission is finished;&n;&t;   * free the skb.&n;&t;   */
r_if
c_cond
(paren
id|out-&gt;segnum
op_ge
id|out-&gt;numsegs
)paren
(brace
multiline_comment|/* transmit completed */
id|out-&gt;segnum
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|out-&gt;skb
)paren
(brace
id|lp-&gt;stats.tx_bytes
op_add_assign
id|out-&gt;skb-&gt;len
suffix:semicolon
id|dev_kfree_skb
c_func
(paren
id|out-&gt;skb
)paren
suffix:semicolon
)brace
id|out-&gt;skb
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/* inform upper layers */
r_if
c_cond
(paren
op_logical_neg
id|lp-&gt;txready
)paren
id|arcnet_tx_done
c_func
(paren
id|dev
comma
id|lp
)paren
suffix:semicolon
)brace
id|didsomething
op_increment
suffix:semicolon
id|lp-&gt;in_txhandler
op_decrement
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|lp-&gt;txready
op_logical_and
op_logical_neg
id|lp-&gt;sending
op_logical_and
op_logical_neg
id|lp-&gt;intx
)paren
(brace
id|BUGMSG
c_func
(paren
id|D_NORMAL
comma
l_string|&quot;recovery from silent TX (status=%Xh)&bslash;n&quot;
comma
id|status
)paren
suffix:semicolon
id|arcnet_go_tx
c_func
(paren
id|dev
comma
l_int|0
)paren
suffix:semicolon
id|didsomething
op_increment
suffix:semicolon
)brace
macro_line|#ifdef DETECT_RECONFIGS
r_if
c_cond
(paren
id|status
op_amp
(paren
id|lp-&gt;intmask
)paren
op_amp
id|RECONflag
)paren
(brace
id|ACOMMAND
c_func
(paren
id|CFLAGScmd
op_or
id|CONFIGclear
)paren
suffix:semicolon
id|lp-&gt;stats.tx_carrier_errors
op_increment
suffix:semicolon
macro_line|#ifdef SHOW_RECONFIGS
id|BUGMSG
c_func
(paren
id|D_NORMAL
comma
l_string|&quot;Network reconfiguration detected (status=%Xh)&bslash;n&quot;
comma
id|status
)paren
suffix:semicolon
macro_line|#endif /* SHOW_RECONFIGS */
macro_line|#ifdef RECON_THRESHOLD
multiline_comment|/* is the RECON info empty or old? */
r_if
c_cond
(paren
op_logical_neg
id|lp-&gt;first_recon
op_logical_or
op_logical_neg
id|lp-&gt;last_recon
op_logical_or
id|jiffies
op_minus
id|lp-&gt;last_recon
OG
id|HZ
op_star
l_int|10
)paren
(brace
r_if
c_cond
(paren
id|lp-&gt;network_down
)paren
id|BUGMSG
c_func
(paren
id|D_NORMAL
comma
l_string|&quot;reconfiguration detected: cabling restored?&bslash;n&quot;
)paren
suffix:semicolon
id|lp-&gt;first_recon
op_assign
id|lp-&gt;last_recon
op_assign
id|jiffies
suffix:semicolon
id|lp-&gt;num_recons
op_assign
id|lp-&gt;network_down
op_assign
l_int|0
suffix:semicolon
id|BUGMSG
c_func
(paren
id|D_DURING
comma
l_string|&quot;recon: clearing counters.&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_else
multiline_comment|/* add to current RECON counter */
(brace
id|lp-&gt;last_recon
op_assign
id|jiffies
suffix:semicolon
id|lp-&gt;num_recons
op_increment
suffix:semicolon
id|BUGMSG
c_func
(paren
id|D_DURING
comma
l_string|&quot;recon: counter=%d, time=%lds, net=%d&bslash;n&quot;
comma
id|lp-&gt;num_recons
comma
(paren
id|lp-&gt;last_recon
op_minus
id|lp-&gt;first_recon
)paren
op_div
id|HZ
comma
id|lp-&gt;network_down
)paren
suffix:semicolon
multiline_comment|/* if network is marked up;&n;&t;       * and first_recon and last_recon are 60+ sec&n;&t;       *   apart;&n;&t;       * and the average no. of recons counted is&n;&t;       *   &gt; RECON_THRESHOLD/min;&n;&t;       * then print a warning message.&n;&t;       */
r_if
c_cond
(paren
op_logical_neg
id|lp-&gt;network_down
op_logical_and
(paren
id|lp-&gt;last_recon
op_minus
id|lp-&gt;first_recon
)paren
op_le
id|HZ
op_star
l_int|60
op_logical_and
id|lp-&gt;num_recons
op_ge
id|RECON_THRESHOLD
)paren
(brace
id|lp-&gt;network_down
op_assign
l_int|1
suffix:semicolon
id|BUGMSG
c_func
(paren
id|D_NORMAL
comma
l_string|&quot;many reconfigurations detected: cabling problem?&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
op_logical_neg
id|lp-&gt;network_down
op_logical_and
id|lp-&gt;last_recon
op_minus
id|lp-&gt;first_recon
OG
id|HZ
op_star
l_int|60
)paren
(brace
multiline_comment|/* reset counters if we&squot;ve gone for&n;&t;&t;   * over a minute.&n;&t;&t;   */
id|lp-&gt;first_recon
op_assign
id|lp-&gt;last_recon
suffix:semicolon
id|lp-&gt;num_recons
op_assign
l_int|1
suffix:semicolon
)brace
)brace
)brace
r_else
r_if
c_cond
(paren
id|lp-&gt;network_down
op_logical_and
id|jiffies
op_minus
id|lp-&gt;last_recon
OG
id|HZ
op_star
l_int|10
)paren
(brace
r_if
c_cond
(paren
id|lp-&gt;network_down
)paren
id|BUGMSG
c_func
(paren
id|D_NORMAL
comma
l_string|&quot;cabling restored?&bslash;n&quot;
)paren
suffix:semicolon
id|lp-&gt;first_recon
op_assign
id|lp-&gt;last_recon
op_assign
l_int|0
suffix:semicolon
id|lp-&gt;num_recons
op_assign
id|lp-&gt;network_down
op_assign
l_int|0
suffix:semicolon
id|BUGMSG
c_func
(paren
id|D_DURING
comma
l_string|&quot;not recon: clearing counters anyway.&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
)brace
macro_line|#endif /* DETECT_RECONFIGS */
)brace
r_while
c_loop
(paren
op_decrement
id|boguscount
op_logical_and
id|didsomething
)paren
suffix:semicolon
id|BUGMSG
c_func
(paren
id|D_DURING
comma
l_string|&quot;net_interrupt complete (status=%Xh, count=%d)&bslash;n&quot;
comma
id|ARCSTATUS
comma
id|boguscount
)paren
suffix:semicolon
id|BUGMSG
c_func
(paren
id|D_DURING
comma
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
id|SETMASK
suffix:semicolon
multiline_comment|/* put back interrupt mask */
)brace
multiline_comment|/* A packet has arrived; grab it from the buffers and pass it to the generic&n; * arcnet_rx routing to deal with it.&n; */
r_static
r_void
DECL|function|arc90xx_rx
id|arc90xx_rx
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
r_int
id|recbuf
)paren
(brace
r_struct
id|arcnet_local
op_star
id|lp
op_assign
(paren
r_struct
id|arcnet_local
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_int
id|ioaddr
op_assign
id|dev-&gt;base_addr
suffix:semicolon
r_union
id|ArcPacket
op_star
id|arcpacket
op_assign
(paren
r_union
id|ArcPacket
op_star
)paren
id|phys_to_virt
c_func
(paren
id|dev-&gt;mem_start
op_plus
id|recbuf
op_star
l_int|512
)paren
suffix:semicolon
id|u_char
op_star
id|arcsoft
suffix:semicolon
r_int
id|length
comma
id|offset
suffix:semicolon
id|u_char
id|daddr
comma
id|saddr
suffix:semicolon
id|lp-&gt;stats.rx_packets
op_increment
suffix:semicolon
id|saddr
op_assign
id|arcpacket-&gt;hardheader.source
suffix:semicolon
multiline_comment|/* if source is 0, it&squot;s a &quot;used&quot; packet! */
r_if
c_cond
(paren
id|saddr
op_eq
l_int|0
)paren
(brace
id|BUGMSG
c_func
(paren
id|D_NORMAL
comma
l_string|&quot;discarding old packet. (status=%Xh)&bslash;n&quot;
comma
id|ARCSTATUS
)paren
suffix:semicolon
id|lp-&gt;stats.rx_errors
op_increment
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/* Set source address to zero to mark it as old */
id|arcpacket-&gt;hardheader.source
op_assign
l_int|0
suffix:semicolon
id|daddr
op_assign
id|arcpacket-&gt;hardheader.destination
suffix:semicolon
r_if
c_cond
(paren
id|arcpacket-&gt;hardheader.offset1
)paren
multiline_comment|/* Normal Packet */
(brace
id|offset
op_assign
id|arcpacket-&gt;hardheader.offset1
suffix:semicolon
id|arcsoft
op_assign
op_amp
id|arcpacket-&gt;raw
(braket
id|offset
)braket
suffix:semicolon
id|length
op_assign
l_int|256
op_minus
id|offset
suffix:semicolon
)brace
r_else
multiline_comment|/* ExtendedPacket or ExceptionPacket */
(brace
id|offset
op_assign
id|arcpacket-&gt;hardheader.offset2
suffix:semicolon
id|arcsoft
op_assign
op_amp
id|arcpacket-&gt;raw
(braket
id|offset
)braket
suffix:semicolon
id|length
op_assign
l_int|512
op_minus
id|offset
suffix:semicolon
)brace
id|arcnet_rx
c_func
(paren
id|lp
comma
id|arcsoft
comma
id|length
comma
id|saddr
comma
id|daddr
)paren
suffix:semicolon
id|BUGLVL
c_func
(paren
id|D_RX
)paren
id|arcnet_dump_packet
c_func
(paren
id|lp-&gt;adev
comma
id|arcpacket-&gt;raw
comma
id|length
OG
l_int|240
comma
l_string|&quot;rx&quot;
)paren
suffix:semicolon
macro_line|#ifndef SLOW_XMIT_COPY
multiline_comment|/* clean out the page to make debugging make more sense :) */
id|BUGLVL
c_func
(paren
id|D_DURING
)paren
id|memset
c_func
(paren
(paren
r_void
op_star
)paren
id|arcpacket-&gt;raw
comma
l_int|0x42
comma
l_int|512
)paren
suffix:semicolon
macro_line|#endif
)brace
multiline_comment|/* Given an skb, copy a packet into the ARCnet buffers for later transmission&n; * by arcnet_go_tx.&n; */
r_static
r_void
DECL|function|arc90xx_prepare_tx
id|arc90xx_prepare_tx
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
id|u_char
op_star
id|hdr
comma
r_int
id|hdrlen
comma
r_char
op_star
id|data
comma
r_int
id|length
comma
r_int
id|daddr
comma
r_int
id|exceptA
comma
r_int
id|offset
)paren
(brace
r_struct
id|arcnet_local
op_star
id|lp
op_assign
(paren
r_struct
id|arcnet_local
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_union
id|ArcPacket
op_star
id|arcpacket
op_assign
(paren
r_union
id|ArcPacket
op_star
)paren
id|phys_to_virt
c_func
(paren
id|dev-&gt;mem_start
op_plus
l_int|512
op_star
(paren
id|lp-&gt;txbuf
op_xor
l_int|1
)paren
)paren
suffix:semicolon
macro_line|#ifdef SLOW_XMIT_COPY
r_char
op_star
id|iptr
comma
op_star
id|iend
comma
op_star
id|optr
suffix:semicolon
macro_line|#endif
id|lp-&gt;txbuf
op_assign
id|lp-&gt;txbuf
op_xor
l_int|1
suffix:semicolon
multiline_comment|/* XOR with 1 to alternate between 2 and 3 */
id|length
op_add_assign
id|hdrlen
suffix:semicolon
id|BUGMSG
c_func
(paren
id|D_TX
comma
l_string|&quot;arcnetAS_prep_tx: hdr:%ph, length:%d, data:%ph&bslash;n&quot;
comma
id|hdr
comma
id|length
comma
id|data
)paren
suffix:semicolon
macro_line|#ifndef SLOW_XMIT_COPY
multiline_comment|/* clean out the page to make debugging make more sense :) */
id|BUGLVL
c_func
(paren
id|D_DURING
)paren
id|memset_io
c_func
(paren
id|dev-&gt;mem_start
op_plus
id|lp-&gt;txbuf
op_star
l_int|512
comma
l_int|0x42
comma
l_int|512
)paren
suffix:semicolon
macro_line|#endif
id|arcpacket-&gt;hardheader.destination
op_assign
id|daddr
suffix:semicolon
multiline_comment|/* load packet into shared memory */
r_if
c_cond
(paren
id|length
op_le
id|MTU
)paren
multiline_comment|/* Normal (256-byte) Packet */
id|arcpacket-&gt;hardheader.offset1
op_assign
id|offset
op_assign
id|offset
ques
c_cond
id|offset
suffix:colon
l_int|256
op_minus
id|length
suffix:semicolon
r_else
r_if
c_cond
(paren
id|length
op_ge
id|MinTU
op_logical_or
id|offset
)paren
multiline_comment|/* Extended (512-byte) Packet */
(brace
id|arcpacket-&gt;hardheader.offset1
op_assign
l_int|0
suffix:semicolon
id|arcpacket-&gt;hardheader.offset2
op_assign
id|offset
op_assign
id|offset
ques
c_cond
id|offset
suffix:colon
l_int|512
op_minus
id|length
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|exceptA
)paren
multiline_comment|/* RFC1201 Exception Packet */
(brace
id|arcpacket-&gt;hardheader.offset1
op_assign
l_int|0
suffix:semicolon
id|arcpacket-&gt;hardheader.offset2
op_assign
id|offset
op_assign
l_int|512
op_minus
id|length
op_minus
l_int|4
suffix:semicolon
multiline_comment|/* exception-specific stuff - these four bytes&n;&t;* make the packet long enough to fit in a 512-byte&n;&t;* frame.&n;&t;*/
id|arcpacket-&gt;raw
(braket
id|offset
op_plus
l_int|0
)braket
op_assign
id|hdr
(braket
l_int|0
)braket
suffix:semicolon
id|arcpacket-&gt;raw
(braket
id|offset
op_plus
l_int|1
)braket
op_assign
l_int|0xFF
suffix:semicolon
multiline_comment|/* FF flag */
id|arcpacket-&gt;raw
(braket
id|offset
op_plus
l_int|2
)braket
op_assign
l_int|0xFF
suffix:semicolon
multiline_comment|/* FF padding */
id|arcpacket-&gt;raw
(braket
id|offset
op_plus
l_int|3
)braket
op_assign
l_int|0xFF
suffix:semicolon
multiline_comment|/* FF padding */
id|offset
op_add_assign
l_int|4
suffix:semicolon
)brace
r_else
multiline_comment|/* &quot;other&quot; Exception packet */
(brace
multiline_comment|/* RFC1051 - set 4 trailing bytes to 0 */
id|memset
c_func
(paren
op_amp
id|arcpacket-&gt;raw
(braket
l_int|508
)braket
comma
l_int|0
comma
l_int|4
)paren
suffix:semicolon
multiline_comment|/* now round up to MinTU */
id|arcpacket-&gt;hardheader.offset1
op_assign
l_int|0
suffix:semicolon
id|arcpacket-&gt;hardheader.offset2
op_assign
id|offset
op_assign
l_int|512
op_minus
id|MinTU
suffix:semicolon
)brace
multiline_comment|/* copy the packet into ARCnet shmem&n;   *  - the first bytes of ClientData header are skipped&n;   */
id|memcpy
c_func
(paren
(paren
id|u_char
op_star
)paren
id|arcpacket
op_plus
id|offset
comma
(paren
id|u_char
op_star
)paren
id|hdr
comma
id|hdrlen
)paren
suffix:semicolon
macro_line|#ifdef SLOW_XMIT_COPY
r_for
c_loop
(paren
id|iptr
op_assign
id|data
comma
id|iend
op_assign
id|iptr
op_plus
id|length
op_minus
id|hdrlen
comma
id|optr
op_assign
(paren
r_char
op_star
)paren
id|arcpacket
op_plus
id|offset
op_plus
id|hdrlen
suffix:semicolon
id|iptr
OL
id|iend
suffix:semicolon
id|iptr
op_increment
comma
id|optr
op_increment
)paren
(brace
op_star
id|optr
op_assign
op_star
id|iptr
suffix:semicolon
multiline_comment|/*udelay(5);*/
)brace
macro_line|#else
id|memcpy
c_func
(paren
(paren
id|u_char
op_star
)paren
id|arcpacket
op_plus
id|offset
op_plus
id|hdrlen
comma
id|data
comma
id|length
op_minus
id|hdrlen
)paren
suffix:semicolon
macro_line|#endif
id|BUGMSG
c_func
(paren
id|D_DURING
comma
l_string|&quot;transmitting packet to station %02Xh (%d bytes)&bslash;n&quot;
comma
id|daddr
comma
id|length
)paren
suffix:semicolon
id|BUGLVL
c_func
(paren
id|D_TX
)paren
id|arcnet_dump_packet
c_func
(paren
id|dev
comma
id|arcpacket-&gt;raw
comma
id|length
OG
id|MTU
comma
l_string|&quot;tx&quot;
)paren
suffix:semicolon
id|lp-&gt;lastload_dest
op_assign
id|daddr
suffix:semicolon
id|lp-&gt;txready
op_assign
id|lp-&gt;txbuf
suffix:semicolon
multiline_comment|/* packet is ready for sending */
)brace
multiline_comment|/****************************************************************************&n; *                                                                          *&n; * Kernel Loadable Module Support                                           *&n; *                                                                          *&n; ****************************************************************************/
macro_line|#ifdef MODULE
DECL|variable|devicename
r_static
r_char
id|devicename
(braket
l_int|9
)braket
op_assign
l_string|&quot;&quot;
suffix:semicolon
DECL|variable|thiscard
r_static
r_struct
id|device
id|thiscard
op_assign
(brace
id|devicename
comma
multiline_comment|/* device name is inserted by linux/drivers/net/net_init.c */
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
multiline_comment|/* I/O address, IRQ */
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|NULL
comma
id|arc90xx_probe
)brace
suffix:semicolon
DECL|function|init_module
r_int
id|init_module
c_func
(paren
r_void
)paren
(brace
r_struct
id|device
op_star
id|dev
op_assign
op_amp
id|thiscard
suffix:semicolon
r_if
c_cond
(paren
id|device
)paren
id|strcpy
c_func
(paren
id|dev-&gt;name
comma
id|device
)paren
suffix:semicolon
r_else
id|arcnet_makename
c_func
(paren
id|dev-&gt;name
)paren
suffix:semicolon
id|dev-&gt;base_addr
op_assign
id|io
suffix:semicolon
id|dev-&gt;irq
op_assign
id|irq
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;irq
op_eq
l_int|2
)paren
id|dev-&gt;irq
op_assign
l_int|9
suffix:semicolon
r_if
c_cond
(paren
id|shmem
)paren
(brace
id|dev-&gt;mem_start
op_assign
id|shmem
suffix:semicolon
id|dev-&gt;mem_end
op_assign
id|thiscard.mem_start
op_plus
l_int|512
op_star
l_int|4
op_minus
l_int|1
suffix:semicolon
id|dev-&gt;rmem_start
op_assign
id|thiscard.mem_start
op_plus
l_int|512
op_star
l_int|0
suffix:semicolon
id|dev-&gt;rmem_end
op_assign
id|thiscard.mem_start
op_plus
l_int|512
op_star
l_int|2
op_minus
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|register_netdev
c_func
(paren
id|dev
)paren
op_ne
l_int|0
)paren
r_return
op_minus
id|EIO
suffix:semicolon
id|arcnet_use_count
c_func
(paren
l_int|1
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|cleanup_module
r_void
id|cleanup_module
c_func
(paren
r_void
)paren
(brace
r_struct
id|device
op_star
id|dev
op_assign
op_amp
id|thiscard
suffix:semicolon
r_int
id|ioaddr
op_assign
id|dev-&gt;mem_start
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;start
)paren
(paren
op_star
id|dev-&gt;stop
)paren
(paren
id|dev
)paren
suffix:semicolon
multiline_comment|/* Flush TX and disable RX */
r_if
c_cond
(paren
id|ioaddr
)paren
(brace
id|AINTMASK
c_func
(paren
l_int|0
)paren
suffix:semicolon
multiline_comment|/* disable IRQ&squot;s */
id|ACOMMAND
c_func
(paren
id|NOTXcmd
)paren
suffix:semicolon
multiline_comment|/* stop transmit */
id|ACOMMAND
c_func
(paren
id|NORXcmd
)paren
suffix:semicolon
multiline_comment|/* disable receive */
macro_line|#if defined(IO_MAPPED_BUFFERS) &amp;&amp; !defined(COM20020)
multiline_comment|/* Set the thing back to MMAP mode, in case the old&n;&t; driver is loaded later */
id|outb
c_func
(paren
(paren
id|inb
c_func
(paren
id|_CONFIG
)paren
op_amp
op_complement
id|IOMAPflag
)paren
comma
id|_CONFIG
)paren
suffix:semicolon
macro_line|#endif
)brace
r_if
c_cond
(paren
id|dev-&gt;irq
)paren
(brace
id|free_irq
c_func
(paren
id|dev-&gt;irq
comma
id|dev
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|dev-&gt;base_addr
)paren
id|release_region
c_func
(paren
id|dev-&gt;base_addr
comma
id|ARCNET_TOTAL_SIZE
)paren
suffix:semicolon
id|unregister_netdev
c_func
(paren
id|dev
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|dev-&gt;priv
)paren
suffix:semicolon
id|dev-&gt;priv
op_assign
l_int|NULL
suffix:semicolon
id|arcnet_use_count
c_func
(paren
l_int|0
)paren
suffix:semicolon
)brace
macro_line|#else
DECL|function|__initfunc
id|__initfunc
c_func
(paren
r_void
id|com90xx_setup
(paren
r_char
op_star
id|str
comma
r_int
op_star
id|ints
)paren
)paren
(brace
r_struct
id|device
op_star
id|dev
suffix:semicolon
r_if
c_cond
(paren
id|arcnet_num_devs
op_eq
id|MAX_ARCNET_DEVS
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;com90xx: Too many ARCnet devices registered (max %d).&bslash;n&quot;
comma
id|MAX_ARCNET_DEVS
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|ints
(braket
l_int|0
)braket
op_logical_and
(paren
op_logical_neg
id|str
op_logical_or
op_logical_neg
op_star
id|str
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;com90xx: Disabled.&bslash;n&quot;
)paren
suffix:semicolon
id|com90xx_explicit
op_increment
suffix:semicolon
r_return
suffix:semicolon
)brace
id|dev
op_assign
op_amp
id|arcnet_devs
(braket
id|arcnet_num_devs
)braket
suffix:semicolon
id|dev-&gt;dev_addr
(braket
l_int|3
)braket
op_assign
l_int|3
suffix:semicolon
id|dev-&gt;init
op_assign
id|arc90xx_probe
suffix:semicolon
r_switch
c_cond
(paren
id|ints
(braket
l_int|0
)braket
)paren
(brace
r_case
l_int|4
suffix:colon
multiline_comment|/* ERROR */
id|printk
c_func
(paren
l_string|&quot;com20020: Too many arguments.&bslash;n&quot;
)paren
suffix:semicolon
r_case
l_int|3
suffix:colon
multiline_comment|/* Mem address */
id|dev-&gt;mem_start
op_assign
id|ints
(braket
l_int|3
)braket
suffix:semicolon
r_case
l_int|2
suffix:colon
multiline_comment|/* IRQ */
id|dev-&gt;irq
op_assign
id|ints
(braket
l_int|2
)braket
suffix:semicolon
r_case
l_int|1
suffix:colon
multiline_comment|/* IO address */
id|dev-&gt;base_addr
op_assign
id|ints
(braket
l_int|1
)braket
suffix:semicolon
)brace
id|dev-&gt;name
op_assign
(paren
r_char
op_star
)paren
op_amp
id|arcnet_dev_names
(braket
id|arcnet_num_devs
)braket
suffix:semicolon
r_if
c_cond
(paren
id|str
)paren
id|strncpy
c_func
(paren
id|dev-&gt;name
comma
id|str
comma
l_int|9
)paren
suffix:semicolon
id|arcnet_num_devs
op_increment
suffix:semicolon
)brace
macro_line|#endif /* MODULE */
eof
