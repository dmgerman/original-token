multiline_comment|/* Intel EtherExpress 16 device driver for Linux&n; *&n; * Written by John Sullivan, 1995&n; *  based on original code by Donald Becker, with changes by&n; *  Alan Cox and Pauline Middelink.&n; *&n; * Support for 8-bit mode by Zoltan Szilagyi &lt;zoltans@cs.arizona.edu&gt;&n; *&n; * Many modifications, and currently maintained, by&n; *  Philip Blundell &lt;Philip.Blundell@pobox.com&gt;&n; * Added the Compaq LTE  Alan Cox &lt;alan@redhat.com&gt;&n; * Added MCA support Adam Fritzler &lt;mid@auk.cx&gt;&n; *&n; * Note - this driver is experimental still - it has problems on faster&n; * machines. Someone needs to sit down and go through it line by line with&n; * a databook...&n; */
multiline_comment|/* The EtherExpress 16 is a fairly simple card, based on a shared-memory&n; * design using the i82586 Ethernet coprocessor.  It bears no relationship,&n; * as far as I know, to the similarly-named &quot;EtherExpress Pro&quot; range.&n; *&n; * Historically, Linux support for these cards has been very bad.  However,&n; * things seem to be getting better slowly.&n; */
multiline_comment|/* If your card is confused about what sort of interface it has (eg it&n; * persistently reports &quot;10baseT&quot; when none is fitted), running &squot;SOFTSET /BART&squot;&n; * or &squot;SOFTSET /LISA&squot; from DOS seems to help.&n; */
multiline_comment|/* Here&squot;s the scoop on memory mapping.&n; *&n; * There are three ways to access EtherExpress card memory: either using the&n; * shared-memory mapping, or using PIO through the dataport, or using PIO&n; * through the &quot;shadow memory&quot; ports.&n; *&n; * The shadow memory system works by having the card map some of its memory&n; * as follows:&n; *&n; * (the low five bits of the SMPTR are ignored)&n; *&n; *  base+0x4000..400f      memory at SMPTR+0..15&n; *  base+0x8000..800f      memory at SMPTR+16..31&n; *  base+0xc000..c007      dubious stuff (memory at SMPTR+16..23 apparently)&n; *  base+0xc008..c00f      memory at 0x0008..0x000f&n; *&n; * This last set (the one at c008) is particularly handy because the SCB&n; * lives at 0x0008.  So that set of ports gives us easy random access to data&n; * in the SCB without having to mess around setting up pointers and the like.&n; * We always use this method to access the SCB (via the scb_xx() functions).&n; *&n; * Dataport access works by aiming the appropriate (read or write) pointer&n; * at the first address you&squot;re interested in, and then reading or writing from&n; * the dataport.  The pointers auto-increment after each transfer.  We use&n; * this for data transfer.&n; *&n; * We don&squot;t use the shared-memory system because it allegedly doesn&squot;t work on&n; * all cards, and because it&squot;s a bit more prone to go wrong (it&squot;s one more&n; * thing to configure...).&n; */
multiline_comment|/* Known bugs:&n; *&n; * - The card seems to want to give us two interrupts every time something&n; *   happens, where just one would be better.&n; */
multiline_comment|/*&n; *&n; * Note by Zoltan Szilagyi 10-12-96:&n; *&n; * I&squot;ve succeeded in eliminating the &quot;CU wedged&quot; messages, and hence the&n; * lockups, which were only occurring with cards running in 8-bit mode (&quot;force&n; * 8-bit operation&quot; in Intel&squot;s SoftSet utility). This version of the driver&n; * sets the 82586 and the ASIC to 8-bit mode at startup; it also stops the&n; * CU before submitting a packet for transmission, and then restarts it as soon&n; * as the process of handing the packet is complete. This is definitely an&n; * unnecessary slowdown if the card is running in 16-bit mode; therefore one&n; * should detect 16-bit vs 8-bit mode from the EEPROM settings and act &n; * accordingly. In 8-bit mode with this bugfix I&squot;m getting about 150 K/s for&n; * ftp&squot;s, which is significantly better than I get in DOS, so the overhead of&n; * stopping and restarting the CU with each transmit is not prohibitive in&n; * practice.&n; *&n; * Update by David Woodhouse 11/5/99:&n; *&n; * I&squot;ve seen &quot;CU wedged&quot; messages in 16-bit mode, on the Alpha architecture.&n; * I assume that this is because 16-bit accesses are actually handled as two&n; * 8-bit accesses.&n; */
macro_line|#ifdef __alpha__
DECL|macro|LOCKUP16
mdefine_line|#define LOCKUP16 1
macro_line|#endif
macro_line|#ifndef LOCKUP16
DECL|macro|LOCKUP16
mdefine_line|#define LOCKUP16 0
macro_line|#endif
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/fcntl.h&gt;
macro_line|#include &lt;linux/interrupt.h&gt;
macro_line|#include &lt;linux/ptrace.h&gt;
macro_line|#include &lt;linux/ioport.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/in.h&gt;
macro_line|#include &lt;asm/system.h&gt;
macro_line|#include &lt;asm/bitops.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/irq.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/netdevice.h&gt;
macro_line|#include &lt;linux/etherdevice.h&gt;
macro_line|#include &lt;linux/skbuff.h&gt;
macro_line|#include &lt;linux/malloc.h&gt;
macro_line|#include &lt;linux/mca.h&gt;
macro_line|#include &lt;linux/spinlock.h&gt;
macro_line|#ifndef NET_DEBUG
DECL|macro|NET_DEBUG
mdefine_line|#define NET_DEBUG 4
macro_line|#endif
macro_line|#include &quot;eexpress.h&quot;
DECL|macro|EEXP_IO_EXTENT
mdefine_line|#define EEXP_IO_EXTENT  16
multiline_comment|/*&n; * Private data declarations&n; */
DECL|struct|net_local
r_struct
id|net_local
(brace
DECL|member|stats
r_struct
id|net_device_stats
id|stats
suffix:semicolon
DECL|member|last_tx
r_int
r_int
id|last_tx
suffix:semicolon
multiline_comment|/* jiffies when last transmit started */
DECL|member|init_time
r_int
r_int
id|init_time
suffix:semicolon
multiline_comment|/* jiffies when eexp_hw_init586 called */
DECL|member|rx_first
r_int
r_int
id|rx_first
suffix:semicolon
multiline_comment|/* first rx buf, same as RX_BUF_START */
DECL|member|rx_last
r_int
r_int
id|rx_last
suffix:semicolon
multiline_comment|/* last rx buf */
DECL|member|rx_ptr
r_int
r_int
id|rx_ptr
suffix:semicolon
multiline_comment|/* first rx buf to look at */
DECL|member|tx_head
r_int
r_int
id|tx_head
suffix:semicolon
multiline_comment|/* next free tx buf */
DECL|member|tx_reap
r_int
r_int
id|tx_reap
suffix:semicolon
multiline_comment|/* first in-use tx buf */
DECL|member|tx_tail
r_int
r_int
id|tx_tail
suffix:semicolon
multiline_comment|/* previous tx buf to tx_head */
DECL|member|tx_link
r_int
r_int
id|tx_link
suffix:semicolon
multiline_comment|/* last known-executing tx buf */
DECL|member|last_tx_restart
r_int
r_int
id|last_tx_restart
suffix:semicolon
multiline_comment|/* set to tx_link when we&n;&t;&t;&t;&t;&t;     restart the CU */
DECL|member|started
r_int
r_char
id|started
suffix:semicolon
DECL|member|rx_buf_start
r_int
r_int
id|rx_buf_start
suffix:semicolon
DECL|member|rx_buf_end
r_int
r_int
id|rx_buf_end
suffix:semicolon
DECL|member|num_tx_bufs
r_int
r_int
id|num_tx_bufs
suffix:semicolon
DECL|member|num_rx_bufs
r_int
r_int
id|num_rx_bufs
suffix:semicolon
DECL|member|width
r_int
r_char
id|width
suffix:semicolon
multiline_comment|/* 0 for 16bit, 1 for 8bit */
DECL|member|was_promisc
r_int
r_char
id|was_promisc
suffix:semicolon
DECL|member|old_mc_count
r_int
r_char
id|old_mc_count
suffix:semicolon
DECL|member|lock
id|spinlock_t
id|lock
suffix:semicolon
)brace
suffix:semicolon
multiline_comment|/* This is the code and data that is downloaded to the EtherExpress card&squot;s&n; * memory at boot time.&n; */
DECL|variable|start_code
r_static
r_int
r_int
id|start_code
(braket
)braket
op_assign
(brace
multiline_comment|/* 0x0000 */
l_int|0x0001
comma
multiline_comment|/* ISCP: busy - cleared after reset */
l_int|0x0008
comma
l_int|0x0000
comma
l_int|0x0000
comma
multiline_comment|/* offset,address (lo,hi) of SCB */
l_int|0x0000
comma
l_int|0x0000
comma
multiline_comment|/* SCB: status, commands */
l_int|0x0000
comma
l_int|0x0000
comma
multiline_comment|/* links to first command block,&n;&t;&t;&t;&t;   first receive descriptor */
l_int|0x0000
comma
l_int|0x0000
comma
multiline_comment|/* CRC error, alignment error counts */
l_int|0x0000
comma
l_int|0x0000
comma
multiline_comment|/* out of resources, overrun error counts */
l_int|0x0000
comma
l_int|0x0000
comma
multiline_comment|/* pad */
l_int|0x0000
comma
l_int|0x0000
comma
multiline_comment|/* 0x20 -- start of 82586 CU program */
DECL|macro|CONF_LINK
mdefine_line|#define CONF_LINK 0x20
l_int|0x0000
comma
id|Cmd_Config
comma
l_int|0x0032
comma
multiline_comment|/* link to next command */
l_int|0x080c
comma
multiline_comment|/* 12 bytes follow : fifo threshold=8 */
l_int|0x2e40
comma
multiline_comment|/* don&squot;t rx bad frames&n;&t;&t;&t;&t; * SRDY/ARDY =&gt; ext. sync. : preamble len=8&n;&t;                         * take addresses from data buffers&n;&t;&t;&t;&t; * 6 bytes/address&n;&t;&t;&t;&t; */
l_int|0x6000
comma
multiline_comment|/* default backoff method &amp; priority&n;&t;&t;&t;&t; * interframe spacing = 0x60 */
l_int|0xf200
comma
multiline_comment|/* slot time=0x200 &n;&t;&t;&t;&t; * max collision retry = 0xf */
DECL|macro|CONF_PROMISC
mdefine_line|#define CONF_PROMISC  0x2e
l_int|0x0000
comma
multiline_comment|/* no HDLC : normal CRC : enable broadcast &n;&t;&t;&t;&t; * disable promiscuous/multicast modes */
l_int|0x003c
comma
multiline_comment|/* minimum frame length = 60 octets) */
l_int|0x0000
comma
id|Cmd_SetAddr
comma
l_int|0x003e
comma
multiline_comment|/* link to next command */
DECL|macro|CONF_HWADDR
mdefine_line|#define CONF_HWADDR  0x38
l_int|0x0000
comma
l_int|0x0000
comma
l_int|0x0000
comma
multiline_comment|/* hardware address placed here */
l_int|0x0000
comma
id|Cmd_MCast
comma
l_int|0x0076
comma
multiline_comment|/* link to next command */
DECL|macro|CONF_NR_MULTICAST
mdefine_line|#define CONF_NR_MULTICAST 0x44
l_int|0x0000
comma
multiline_comment|/* number of multicast addresses */
DECL|macro|CONF_MULTICAST
mdefine_line|#define CONF_MULTICAST 0x46
l_int|0x0000
comma
l_int|0x0000
comma
l_int|0x0000
comma
multiline_comment|/* some addresses */
l_int|0x0000
comma
l_int|0x0000
comma
l_int|0x0000
comma
l_int|0x0000
comma
l_int|0x0000
comma
l_int|0x0000
comma
l_int|0x0000
comma
l_int|0x0000
comma
l_int|0x0000
comma
l_int|0x0000
comma
l_int|0x0000
comma
l_int|0x0000
comma
l_int|0x0000
comma
l_int|0x0000
comma
l_int|0x0000
comma
l_int|0x0000
comma
l_int|0x0000
comma
l_int|0x0000
comma
l_int|0x0000
comma
l_int|0x0000
comma
l_int|0x0000
comma
DECL|macro|CONF_DIAG_RESULT
mdefine_line|#define CONF_DIAG_RESULT  0x76
l_int|0x0000
comma
id|Cmd_Diag
comma
l_int|0x007c
comma
multiline_comment|/* link to next command */
l_int|0x0000
comma
id|Cmd_TDR
op_or
id|Cmd_INT
comma
l_int|0x0084
comma
DECL|macro|CONF_TDR_RESULT
mdefine_line|#define CONF_TDR_RESULT  0x82
l_int|0x0000
comma
l_int|0x0000
comma
id|Cmd_END
op_or
id|Cmd_Nop
comma
multiline_comment|/* end of configure sequence */
l_int|0x0084
multiline_comment|/* dummy link */
)brace
suffix:semicolon
multiline_comment|/* maps irq number to EtherExpress magic value */
DECL|variable|irqrmap
r_static
r_char
id|irqrmap
(braket
)braket
op_assign
(brace
l_int|0
comma
l_int|0
comma
l_int|1
comma
l_int|2
comma
l_int|3
comma
l_int|4
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|1
comma
l_int|5
comma
l_int|6
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
)brace
suffix:semicolon
macro_line|#ifdef CONFIG_MCA
multiline_comment|/* mapping of the first four bits of the second POS register */
DECL|variable|mca_iomap
r_static
r_int
r_int
id|mca_iomap
(braket
)braket
op_assign
(brace
l_int|0x270
comma
l_int|0x260
comma
l_int|0x250
comma
l_int|0x240
comma
l_int|0x230
comma
l_int|0x220
comma
l_int|0x210
comma
l_int|0x200
comma
l_int|0x370
comma
l_int|0x360
comma
l_int|0x350
comma
l_int|0x340
comma
l_int|0x330
comma
l_int|0x320
comma
l_int|0x310
comma
l_int|0x300
)brace
suffix:semicolon
multiline_comment|/* bits 5-7 of the second POS register */
DECL|variable|mca_irqmap
r_static
r_char
id|mca_irqmap
(braket
)braket
op_assign
(brace
l_int|12
comma
l_int|9
comma
l_int|3
comma
l_int|4
comma
l_int|5
comma
l_int|10
comma
l_int|11
comma
l_int|15
)brace
suffix:semicolon
macro_line|#endif 
multiline_comment|/*&n; * Prototypes for Linux interface&n; */
r_extern
r_int
id|express_probe
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_int
id|eexp_open
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_int
id|eexp_close
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_void
id|eexp_timeout
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_struct
id|net_device_stats
op_star
id|eexp_stats
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_int
id|eexp_xmit
c_func
(paren
r_struct
id|sk_buff
op_star
id|buf
comma
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_void
id|eexp_irq
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_addr
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
suffix:semicolon
r_static
r_void
id|eexp_set_multicast
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
multiline_comment|/*&n; * Prototypes for hardware access functions&n; */
r_static
r_void
id|eexp_hw_rx_pio
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_void
id|eexp_hw_tx_pio
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_int
r_int
op_star
id|buf
comma
r_int
r_int
id|len
)paren
suffix:semicolon
r_static
r_int
id|eexp_hw_probe
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_int
r_int
id|ioaddr
)paren
suffix:semicolon
r_static
r_int
r_int
id|eexp_hw_readeeprom
c_func
(paren
r_int
r_int
id|ioaddr
comma
r_int
r_char
id|location
)paren
suffix:semicolon
r_static
r_int
r_int
id|eexp_hw_lasttxstat
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_void
id|eexp_hw_txrestart
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_void
id|eexp_hw_txinit
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_void
id|eexp_hw_rxinit
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_void
id|eexp_hw_init586
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_void
id|eexp_setup_filter
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
DECL|variable|eexp_ifmap
r_static
r_char
op_star
id|eexp_ifmap
(braket
)braket
op_assign
initialization_block
suffix:semicolon
DECL|enum|eexp_iftype
DECL|enumerator|AUI
DECL|enumerator|BNC
DECL|enumerator|TPE
r_enum
id|eexp_iftype
(brace
id|AUI
op_assign
l_int|0
comma
id|BNC
op_assign
l_int|1
comma
id|TPE
op_assign
l_int|2
)brace
suffix:semicolon
DECL|macro|STARTED_RU
mdefine_line|#define STARTED_RU      2
DECL|macro|STARTED_CU
mdefine_line|#define STARTED_CU      1
multiline_comment|/*&n; * Primitive hardware access functions.&n; */
DECL|function|scb_status
r_static
r_inline
r_int
r_int
id|scb_status
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_return
id|inw
c_func
(paren
id|dev-&gt;base_addr
op_plus
l_int|0xc008
)paren
suffix:semicolon
)brace
DECL|function|scb_rdcmd
r_static
r_inline
r_int
r_int
id|scb_rdcmd
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_return
id|inw
c_func
(paren
id|dev-&gt;base_addr
op_plus
l_int|0xc00a
)paren
suffix:semicolon
)brace
DECL|function|scb_command
r_static
r_inline
r_void
id|scb_command
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_int
r_int
id|cmd
)paren
(brace
id|outw
c_func
(paren
id|cmd
comma
id|dev-&gt;base_addr
op_plus
l_int|0xc00a
)paren
suffix:semicolon
)brace
DECL|function|scb_wrcbl
r_static
r_inline
r_void
id|scb_wrcbl
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_int
r_int
id|val
)paren
(brace
id|outw
c_func
(paren
id|val
comma
id|dev-&gt;base_addr
op_plus
l_int|0xc00c
)paren
suffix:semicolon
)brace
DECL|function|scb_wrrfa
r_static
r_inline
r_void
id|scb_wrrfa
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_int
r_int
id|val
)paren
(brace
id|outw
c_func
(paren
id|val
comma
id|dev-&gt;base_addr
op_plus
l_int|0xc00e
)paren
suffix:semicolon
)brace
DECL|function|set_loopback
r_static
r_inline
r_void
id|set_loopback
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
id|outb
c_func
(paren
id|inb
c_func
(paren
id|dev-&gt;base_addr
op_plus
id|Config
)paren
op_or
l_int|2
comma
id|dev-&gt;base_addr
op_plus
id|Config
)paren
suffix:semicolon
)brace
DECL|function|clear_loopback
r_static
r_inline
r_void
id|clear_loopback
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
id|outb
c_func
(paren
id|inb
c_func
(paren
id|dev-&gt;base_addr
op_plus
id|Config
)paren
op_amp
op_complement
l_int|2
comma
id|dev-&gt;base_addr
op_plus
id|Config
)paren
suffix:semicolon
)brace
DECL|function|SHADOW
r_static
r_inline
r_int
r_int
r_int
id|SHADOW
c_func
(paren
r_int
r_int
id|addr
)paren
(brace
id|addr
op_and_assign
l_int|0x1f
suffix:semicolon
r_if
c_cond
(paren
id|addr
OG
l_int|0xf
)paren
id|addr
op_add_assign
l_int|0x3ff0
suffix:semicolon
r_return
id|addr
op_plus
l_int|0x4000
suffix:semicolon
)brace
multiline_comment|/*&n; * Linux interface&n; */
multiline_comment|/*&n; * checks for presence of EtherExpress card&n; */
DECL|function|express_probe
r_int
id|__init
id|express_probe
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_int
r_int
op_star
id|port
suffix:semicolon
r_static
r_int
r_int
id|ports
(braket
)braket
op_assign
(brace
l_int|0x300
comma
l_int|0x310
comma
l_int|0x270
comma
l_int|0x320
comma
l_int|0x340
comma
l_int|0
)brace
suffix:semicolon
r_int
r_int
id|ioaddr
op_assign
id|dev-&gt;base_addr
suffix:semicolon
id|SET_MODULE_OWNER
c_func
(paren
id|dev
)paren
suffix:semicolon
id|dev-&gt;if_port
op_assign
l_int|0xff
suffix:semicolon
multiline_comment|/* not set */
macro_line|#ifdef CONFIG_MCA
r_if
c_cond
(paren
id|MCA_bus
)paren
(brace
r_int
id|slot
op_assign
l_int|0
suffix:semicolon
multiline_comment|/*&n;&t;&t; * Only find one card at a time.  Subsequent calls&n;&t;&t; * will find others, however, proper multicard MCA&n;&t;&t; * probing and setup can&squot;t be done with the&n;&t;&t; * old-style Space.c init routines.  -- ASF&n;&t;&t; */
r_while
c_loop
(paren
id|slot
op_ne
id|MCA_NOTFOUND
)paren
(brace
r_int
id|pos0
comma
id|pos1
suffix:semicolon
id|slot
op_assign
id|mca_find_unused_adapter
c_func
(paren
l_int|0x628B
comma
id|slot
)paren
suffix:semicolon
r_if
c_cond
(paren
id|slot
op_eq
id|MCA_NOTFOUND
)paren
r_break
suffix:semicolon
id|pos0
op_assign
id|mca_read_stored_pos
c_func
(paren
id|slot
comma
l_int|2
)paren
suffix:semicolon
id|pos1
op_assign
id|mca_read_stored_pos
c_func
(paren
id|slot
comma
l_int|3
)paren
suffix:semicolon
id|ioaddr
op_assign
id|mca_iomap
(braket
id|pos1
op_amp
l_int|0xf
)braket
suffix:semicolon
id|dev-&gt;irq
op_assign
id|mca_irqmap
(braket
(paren
id|pos1
op_rshift
l_int|4
)paren
op_amp
l_int|0x7
)braket
suffix:semicolon
multiline_comment|/*&n;&t;&t;&t; * XXX: Transciever selection is done&n;&t;&t;&t; * differently on the MCA version.  &n;&t;&t;&t; * How to get it to select something&n;&t;&t;&t; * other than external/AUI is currently&n;&t;&t;&t; * unknown.  This code is just for looks. -- ASF&n;&t;&t;&t; */
r_if
c_cond
(paren
(paren
id|pos0
op_amp
l_int|0x7
)paren
op_eq
l_int|0x1
)paren
id|dev-&gt;if_port
op_assign
id|AUI
suffix:semicolon
r_else
r_if
c_cond
(paren
(paren
id|pos0
op_amp
l_int|0x7
)paren
op_eq
l_int|0x5
)paren
(brace
r_if
c_cond
(paren
id|pos1
op_amp
l_int|0x80
)paren
id|dev-&gt;if_port
op_assign
id|BNC
suffix:semicolon
r_else
id|dev-&gt;if_port
op_assign
id|TPE
suffix:semicolon
)brace
id|mca_set_adapter_name
c_func
(paren
id|slot
comma
l_string|&quot;Intel EtherExpress 16 MCA&quot;
)paren
suffix:semicolon
id|mca_set_adapter_procfn
c_func
(paren
id|slot
comma
l_int|NULL
comma
id|dev
)paren
suffix:semicolon
id|mca_mark_as_used
c_func
(paren
id|slot
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
macro_line|#endif
r_if
c_cond
(paren
id|ioaddr
op_amp
l_int|0xfe00
)paren
r_return
id|eexp_hw_probe
c_func
(paren
id|dev
comma
id|ioaddr
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
id|ioaddr
)paren
r_return
op_minus
id|ENXIO
suffix:semicolon
r_for
c_loop
(paren
id|port
op_assign
op_amp
id|ports
(braket
l_int|0
)braket
suffix:semicolon
op_star
id|port
suffix:semicolon
id|port
op_increment
)paren
(brace
r_int
r_int
id|sum
op_assign
l_int|0
suffix:semicolon
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|4
suffix:semicolon
id|i
op_increment
)paren
(brace
r_int
r_int
id|t
suffix:semicolon
id|t
op_assign
id|inb
c_func
(paren
op_star
id|port
op_plus
id|ID_PORT
)paren
suffix:semicolon
id|sum
op_or_assign
(paren
id|t
op_rshift
l_int|4
)paren
op_lshift
(paren
(paren
id|t
op_amp
l_int|0x03
)paren
op_lshift
l_int|2
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|sum
op_eq
l_int|0xbaba
op_logical_and
op_logical_neg
id|eexp_hw_probe
c_func
(paren
id|dev
comma
op_star
id|port
)paren
)paren
r_return
l_int|0
suffix:semicolon
)brace
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
multiline_comment|/*&n; * open and initialize the adapter, ready for use&n; */
DECL|function|eexp_open
r_static
r_int
id|eexp_open
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_int
id|ret
suffix:semicolon
r_int
r_int
id|ioaddr
op_assign
id|dev-&gt;base_addr
suffix:semicolon
r_struct
id|net_local
op_star
id|lp
op_assign
(paren
r_struct
id|net_local
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
macro_line|#if NET_DEBUG &gt; 6
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%s: eexp_open()&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
op_logical_neg
id|dev-&gt;irq
op_logical_or
op_logical_neg
id|irqrmap
(braket
id|dev-&gt;irq
)braket
)paren
r_return
op_minus
id|ENXIO
suffix:semicolon
id|ret
op_assign
id|request_irq
c_func
(paren
id|dev-&gt;irq
comma
op_amp
id|eexp_irq
comma
l_int|0
comma
id|dev-&gt;name
comma
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
)paren
r_return
id|ret
suffix:semicolon
id|request_region
c_func
(paren
id|ioaddr
comma
id|EEXP_IO_EXTENT
comma
l_string|&quot;EtherExpress&quot;
)paren
suffix:semicolon
id|request_region
c_func
(paren
id|ioaddr
op_plus
l_int|0x4000
comma
l_int|16
comma
l_string|&quot;EtherExpress shadow&quot;
)paren
suffix:semicolon
id|request_region
c_func
(paren
id|ioaddr
op_plus
l_int|0x8000
comma
l_int|16
comma
l_string|&quot;EtherExpress shadow&quot;
)paren
suffix:semicolon
id|request_region
c_func
(paren
id|ioaddr
op_plus
l_int|0xc000
comma
l_int|16
comma
l_string|&quot;EtherExpress shadow&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|lp-&gt;width
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%s: forcing ASIC to 8-bit mode&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|outb
c_func
(paren
id|inb
c_func
(paren
id|dev-&gt;base_addr
op_plus
id|Config
)paren
op_amp
op_complement
l_int|4
comma
id|dev-&gt;base_addr
op_plus
id|Config
)paren
suffix:semicolon
)brace
id|eexp_hw_init586
c_func
(paren
id|dev
)paren
suffix:semicolon
id|netif_start_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
macro_line|#if NET_DEBUG &gt; 6
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%s: leaving eexp_open()&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
macro_line|#endif
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * close and disable the interface, leaving the 586 in reset.&n; */
DECL|function|eexp_close
r_static
r_int
id|eexp_close
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_int
r_int
id|ioaddr
op_assign
id|dev-&gt;base_addr
suffix:semicolon
r_struct
id|net_local
op_star
id|lp
op_assign
id|dev-&gt;priv
suffix:semicolon
r_int
id|irq
op_assign
id|dev-&gt;irq
suffix:semicolon
id|netif_stop_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
id|outb
c_func
(paren
id|SIRQ_dis
op_or
id|irqrmap
(braket
id|irq
)braket
comma
id|ioaddr
op_plus
id|SET_IRQ
)paren
suffix:semicolon
id|lp-&gt;started
op_assign
l_int|0
suffix:semicolon
id|scb_command
c_func
(paren
id|dev
comma
id|SCB_CUsuspend
op_or
id|SCB_RUsuspend
)paren
suffix:semicolon
id|outb
c_func
(paren
l_int|0
comma
id|ioaddr
op_plus
id|SIGNAL_CA
)paren
suffix:semicolon
id|free_irq
c_func
(paren
id|irq
comma
id|dev
)paren
suffix:semicolon
id|outb
c_func
(paren
id|i586_RST
comma
id|ioaddr
op_plus
id|EEPROM_Ctrl
)paren
suffix:semicolon
id|release_region
c_func
(paren
id|ioaddr
comma
id|EEXP_IO_EXTENT
)paren
suffix:semicolon
id|release_region
c_func
(paren
id|ioaddr
op_plus
l_int|0x4000
comma
l_int|16
)paren
suffix:semicolon
id|release_region
c_func
(paren
id|ioaddr
op_plus
l_int|0x8000
comma
l_int|16
)paren
suffix:semicolon
id|release_region
c_func
(paren
id|ioaddr
op_plus
l_int|0xc000
comma
l_int|16
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * Return interface stats&n; */
DECL|function|eexp_stats
r_static
r_struct
id|net_device_stats
op_star
id|eexp_stats
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|net_local
op_star
id|lp
op_assign
(paren
r_struct
id|net_local
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_return
op_amp
id|lp-&gt;stats
suffix:semicolon
)brace
multiline_comment|/*&n; * This gets called when a higher level thinks we are broken.  Check that&n; * nothing has become jammed in the CU.&n; */
DECL|function|unstick_cu
r_static
r_void
id|unstick_cu
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|net_local
op_star
id|lp
op_assign
(paren
r_struct
id|net_local
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_int
r_int
id|ioaddr
op_assign
id|dev-&gt;base_addr
suffix:semicolon
r_if
c_cond
(paren
id|lp-&gt;started
)paren
(brace
r_if
c_cond
(paren
(paren
id|jiffies
op_minus
id|dev-&gt;trans_start
)paren
OG
l_int|50
)paren
(brace
r_if
c_cond
(paren
id|lp-&gt;tx_link
op_eq
id|lp-&gt;last_tx_restart
)paren
(brace
r_int
r_int
id|boguscount
op_assign
l_int|200
comma
id|rsst
suffix:semicolon
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: Retransmit timed out, status %04x, resetting...&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|scb_status
c_func
(paren
id|dev
)paren
)paren
suffix:semicolon
id|eexp_hw_txinit
c_func
(paren
id|dev
)paren
suffix:semicolon
id|lp-&gt;last_tx_restart
op_assign
l_int|0
suffix:semicolon
id|scb_wrcbl
c_func
(paren
id|dev
comma
id|lp-&gt;tx_link
)paren
suffix:semicolon
id|scb_command
c_func
(paren
id|dev
comma
id|SCB_CUstart
)paren
suffix:semicolon
id|outb
c_func
(paren
l_int|0
comma
id|ioaddr
op_plus
id|SIGNAL_CA
)paren
suffix:semicolon
r_while
c_loop
(paren
op_logical_neg
id|SCB_complete
c_func
(paren
id|rsst
op_assign
id|scb_status
c_func
(paren
id|dev
)paren
)paren
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
op_decrement
id|boguscount
)paren
(brace
id|boguscount
op_assign
l_int|200
suffix:semicolon
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: Reset timed out status %04x, retrying...&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|rsst
)paren
suffix:semicolon
id|scb_wrcbl
c_func
(paren
id|dev
comma
id|lp-&gt;tx_link
)paren
suffix:semicolon
id|scb_command
c_func
(paren
id|dev
comma
id|SCB_CUstart
)paren
suffix:semicolon
id|outb
c_func
(paren
l_int|0
comma
id|ioaddr
op_plus
id|SIGNAL_CA
)paren
suffix:semicolon
)brace
)brace
id|netif_wake_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
r_else
(brace
r_int
r_int
id|status
op_assign
id|scb_status
c_func
(paren
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|SCB_CUdead
c_func
(paren
id|status
)paren
)paren
(brace
r_int
r_int
id|txstatus
op_assign
id|eexp_hw_lasttxstat
c_func
(paren
id|dev
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: Transmit timed out, CU not active status %04x %04x, restarting...&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|status
comma
id|txstatus
)paren
suffix:semicolon
id|eexp_hw_txrestart
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
r_else
(brace
r_int
r_int
id|txstatus
op_assign
id|eexp_hw_lasttxstat
c_func
(paren
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|netif_queue_stopped
c_func
(paren
id|dev
)paren
op_logical_and
op_logical_neg
id|txstatus
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: CU wedged, status %04x %04x, resetting...&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|status
comma
id|txstatus
)paren
suffix:semicolon
id|eexp_hw_init586
c_func
(paren
id|dev
)paren
suffix:semicolon
id|netif_wake_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
r_else
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: transmit timed out&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
)brace
)brace
)brace
)brace
)brace
r_else
(brace
r_if
c_cond
(paren
(paren
id|jiffies
op_minus
id|lp-&gt;init_time
)paren
OG
l_int|10
)paren
(brace
r_int
r_int
id|status
op_assign
id|scb_status
c_func
(paren
id|dev
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: i82586 startup timed out, status %04x, resetting...&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|status
)paren
suffix:semicolon
id|eexp_hw_init586
c_func
(paren
id|dev
)paren
suffix:semicolon
id|netif_wake_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
)brace
)brace
DECL|function|eexp_timeout
r_static
r_void
id|eexp_timeout
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|net_local
op_star
id|lp
op_assign
(paren
r_struct
id|net_local
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
macro_line|#ifdef CONFIG_SMP
r_int
r_int
id|flags
suffix:semicolon
macro_line|#endif
r_int
id|status
suffix:semicolon
id|disable_irq
c_func
(paren
id|dev-&gt;irq
)paren
suffix:semicolon
multiline_comment|/*&n;&t; *&t;Best would be to use synchronize_irq(); spin_lock() here&n;&t; *&t;lets make it work first..&n;&t; */
macro_line|#ifdef CONFIG_SMP
id|spin_lock_irqsave
c_func
(paren
op_amp
id|lp-&gt;lock
comma
id|flags
)paren
suffix:semicolon
macro_line|#endif
id|status
op_assign
id|scb_status
c_func
(paren
id|dev
)paren
suffix:semicolon
id|unstick_cu
c_func
(paren
id|dev
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: transmit timed out, %s?&quot;
comma
id|dev-&gt;name
comma
(paren
id|SCB_complete
c_func
(paren
id|status
)paren
ques
c_cond
l_string|&quot;lost interrupt&quot;
suffix:colon
l_string|&quot;board on fire&quot;
)paren
)paren
suffix:semicolon
id|lp-&gt;stats.tx_errors
op_increment
suffix:semicolon
id|lp-&gt;last_tx
op_assign
id|jiffies
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|SCB_complete
c_func
(paren
id|status
)paren
)paren
(brace
id|scb_command
c_func
(paren
id|dev
comma
id|SCB_CUabort
)paren
suffix:semicolon
id|outb
c_func
(paren
l_int|0
comma
id|dev-&gt;base_addr
op_plus
id|SIGNAL_CA
)paren
suffix:semicolon
)brace
id|netif_wake_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
macro_line|#ifdef CONFIG_SMP
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|lp-&gt;lock
comma
id|flags
)paren
suffix:semicolon
macro_line|#endif
)brace
multiline_comment|/*&n; * Called to transmit a packet, or to allow us to right ourselves&n; * if the kernel thinks we&squot;ve died.&n; */
DECL|function|eexp_xmit
r_static
r_int
id|eexp_xmit
c_func
(paren
r_struct
id|sk_buff
op_star
id|buf
comma
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|net_local
op_star
id|lp
op_assign
(paren
r_struct
id|net_local
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
macro_line|#ifdef CONFIG_SMP
r_int
r_int
id|flags
suffix:semicolon
macro_line|#endif
macro_line|#if NET_DEBUG &gt; 6
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%s: eexp_xmit()&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
macro_line|#endif
id|disable_irq
c_func
(paren
id|dev-&gt;irq
)paren
suffix:semicolon
multiline_comment|/*&n;&t; *&t;Best would be to use synchronize_irq(); spin_lock() here&n;&t; *&t;lets make it work first..&n;&t; */
macro_line|#ifdef CONFIG_SMP
id|spin_lock_irqsave
c_func
(paren
op_amp
id|lp-&gt;lock
comma
id|flags
)paren
suffix:semicolon
macro_line|#endif
(brace
r_int
r_int
id|length
op_assign
(paren
id|ETH_ZLEN
OL
id|buf-&gt;len
)paren
ques
c_cond
id|buf-&gt;len
suffix:colon
id|ETH_ZLEN
suffix:semicolon
r_int
r_int
op_star
id|data
op_assign
(paren
r_int
r_int
op_star
)paren
id|buf-&gt;data
suffix:semicolon
id|lp-&gt;stats.tx_bytes
op_add_assign
id|length
suffix:semicolon
id|eexp_hw_tx_pio
c_func
(paren
id|dev
comma
id|data
comma
id|length
)paren
suffix:semicolon
)brace
id|dev_kfree_skb
c_func
(paren
id|buf
)paren
suffix:semicolon
macro_line|#ifdef CONFIG_SMP
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|lp-&gt;lock
comma
id|flags
)paren
suffix:semicolon
macro_line|#endif
id|enable_irq
c_func
(paren
id|dev-&gt;irq
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * Handle an EtherExpress interrupt&n; * If we&squot;ve finished initializing, start the RU and CU up.&n; * If we&squot;ve already started, reap tx buffers, handle any received packets,&n; * check to make sure we&squot;ve not become wedged.&n; */
multiline_comment|/*&n; * Handle an EtherExpress interrupt&n; * If we&squot;ve finished initializing, start the RU and CU up.&n; * If we&squot;ve already started, reap tx buffers, handle any received packets,&n; * check to make sure we&squot;ve not become wedged.&n; */
DECL|function|eexp_start_irq
r_static
r_int
r_int
id|eexp_start_irq
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_int
r_int
id|status
)paren
(brace
r_int
r_int
id|ack_cmd
op_assign
id|SCB_ack
c_func
(paren
id|status
)paren
suffix:semicolon
r_struct
id|net_local
op_star
id|lp
op_assign
(paren
r_struct
id|net_local
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_int
r_int
id|ioaddr
op_assign
id|dev-&gt;base_addr
suffix:semicolon
r_if
c_cond
(paren
(paren
id|dev-&gt;flags
op_amp
id|IFF_UP
)paren
op_logical_and
op_logical_neg
(paren
id|lp-&gt;started
op_amp
id|STARTED_CU
)paren
)paren
(brace
r_int
id|diag_status
comma
id|tdr_status
suffix:semicolon
r_while
c_loop
(paren
id|SCB_CUstat
c_func
(paren
id|status
)paren
op_eq
l_int|2
)paren
id|status
op_assign
id|scb_status
c_func
(paren
id|dev
)paren
suffix:semicolon
macro_line|#if NET_DEBUG &gt; 4
id|printk
c_func
(paren
l_string|&quot;%s: CU went non-active (status %04x)&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|status
)paren
suffix:semicolon
macro_line|#endif
id|outw
c_func
(paren
id|CONF_DIAG_RESULT
op_amp
op_complement
l_int|31
comma
id|ioaddr
op_plus
id|SM_PTR
)paren
suffix:semicolon
id|diag_status
op_assign
id|inw
c_func
(paren
id|ioaddr
op_plus
id|SHADOW
c_func
(paren
id|CONF_DIAG_RESULT
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|diag_status
op_amp
l_int|1
op_lshift
l_int|11
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: 82586 failed self-test&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
op_logical_neg
(paren
id|diag_status
op_amp
l_int|1
op_lshift
l_int|13
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: 82586 self-test failed to complete&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
)brace
id|outw
c_func
(paren
id|CONF_TDR_RESULT
op_amp
op_complement
l_int|31
comma
id|ioaddr
op_plus
id|SM_PTR
)paren
suffix:semicolon
id|tdr_status
op_assign
id|inw
c_func
(paren
id|ioaddr
op_plus
id|SHADOW
c_func
(paren
id|CONF_TDR_RESULT
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tdr_status
op_amp
(paren
id|TDR_SHORT
op_or
id|TDR_OPEN
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: TDR reports cable %s at %d tick%s&bslash;n&quot;
comma
id|dev-&gt;name
comma
(paren
id|tdr_status
op_amp
id|TDR_SHORT
)paren
ques
c_cond
l_string|&quot;short&quot;
suffix:colon
l_string|&quot;broken&quot;
comma
id|tdr_status
op_amp
id|TDR_TIME
comma
(paren
(paren
id|tdr_status
op_amp
id|TDR_TIME
)paren
op_ne
l_int|1
)paren
ques
c_cond
l_string|&quot;s&quot;
suffix:colon
l_string|&quot;&quot;
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|tdr_status
op_amp
id|TDR_XCVRPROBLEM
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: TDR reports transceiver problem&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|tdr_status
op_amp
id|TDR_LINKOK
)paren
(brace
macro_line|#if NET_DEBUG &gt; 4
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%s: TDR reports link OK&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
macro_line|#endif
)brace
r_else
(brace
id|printk
c_func
(paren
l_string|&quot;%s: TDR is ga-ga (status %04x)&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|tdr_status
)paren
suffix:semicolon
)brace
id|lp-&gt;started
op_or_assign
id|STARTED_CU
suffix:semicolon
id|scb_wrcbl
c_func
(paren
id|dev
comma
id|lp-&gt;tx_link
)paren
suffix:semicolon
multiline_comment|/* if the RU isn&squot;t running, start it now */
r_if
c_cond
(paren
op_logical_neg
(paren
id|lp-&gt;started
op_amp
id|STARTED_RU
)paren
)paren
(brace
id|ack_cmd
op_or_assign
id|SCB_RUstart
suffix:semicolon
id|scb_wrrfa
c_func
(paren
id|dev
comma
id|lp-&gt;rx_buf_start
)paren
suffix:semicolon
id|lp-&gt;rx_ptr
op_assign
id|lp-&gt;rx_buf_start
suffix:semicolon
id|lp-&gt;started
op_or_assign
id|STARTED_RU
suffix:semicolon
)brace
id|ack_cmd
op_or_assign
id|SCB_CUstart
op_or
l_int|0x2000
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|dev-&gt;flags
op_amp
id|IFF_UP
)paren
op_logical_and
op_logical_neg
(paren
id|lp-&gt;started
op_amp
id|STARTED_RU
)paren
op_logical_and
id|SCB_RUstat
c_func
(paren
id|status
)paren
op_eq
l_int|4
)paren
id|lp-&gt;started
op_or_assign
id|STARTED_RU
suffix:semicolon
r_return
id|ack_cmd
suffix:semicolon
)brace
DECL|function|eexp_cmd_clear
r_static
r_void
id|eexp_cmd_clear
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_int
r_int
r_int
id|oldtime
op_assign
id|jiffies
suffix:semicolon
r_while
c_loop
(paren
id|scb_rdcmd
c_func
(paren
id|dev
)paren
op_logical_and
(paren
(paren
id|jiffies
op_minus
id|oldtime
)paren
OL
l_int|10
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|scb_rdcmd
c_func
(paren
id|dev
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%s: command didn&squot;t clear&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
)brace
)brace
DECL|function|eexp_irq
r_static
r_void
id|eexp_irq
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_info
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_struct
id|net_device
op_star
id|dev
op_assign
id|dev_info
suffix:semicolon
r_struct
id|net_local
op_star
id|lp
suffix:semicolon
r_int
r_int
id|ioaddr
comma
id|status
comma
id|ack_cmd
suffix:semicolon
r_int
r_int
id|old_read_ptr
comma
id|old_write_ptr
suffix:semicolon
r_if
c_cond
(paren
id|dev
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;eexpress: irq %d for unknown device&bslash;n&quot;
comma
id|irq
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|lp
op_assign
(paren
r_struct
id|net_local
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|ioaddr
op_assign
id|dev-&gt;base_addr
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|lp-&gt;lock
)paren
suffix:semicolon
id|old_read_ptr
op_assign
id|inw
c_func
(paren
id|ioaddr
op_plus
id|READ_PTR
)paren
suffix:semicolon
id|old_write_ptr
op_assign
id|inw
c_func
(paren
id|ioaddr
op_plus
id|WRITE_PTR
)paren
suffix:semicolon
id|outb
c_func
(paren
id|SIRQ_dis
op_or
id|irqrmap
(braket
id|irq
)braket
comma
id|ioaddr
op_plus
id|SET_IRQ
)paren
suffix:semicolon
id|status
op_assign
id|scb_status
c_func
(paren
id|dev
)paren
suffix:semicolon
macro_line|#if NET_DEBUG &gt; 4
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%s: interrupt (status %x)&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|status
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|lp-&gt;started
op_eq
(paren
id|STARTED_CU
op_or
id|STARTED_RU
)paren
)paren
(brace
r_do
(brace
id|eexp_cmd_clear
c_func
(paren
id|dev
)paren
suffix:semicolon
id|ack_cmd
op_assign
id|SCB_ack
c_func
(paren
id|status
)paren
suffix:semicolon
id|scb_command
c_func
(paren
id|dev
comma
id|ack_cmd
)paren
suffix:semicolon
id|outb
c_func
(paren
l_int|0
comma
id|ioaddr
op_plus
id|SIGNAL_CA
)paren
suffix:semicolon
id|eexp_cmd_clear
c_func
(paren
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|SCB_complete
c_func
(paren
id|status
)paren
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|eexp_hw_lasttxstat
c_func
(paren
id|dev
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%s: tx interrupt but no status&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|SCB_rxdframe
c_func
(paren
id|status
)paren
)paren
id|eexp_hw_rx_pio
c_func
(paren
id|dev
)paren
suffix:semicolon
id|status
op_assign
id|scb_status
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
id|status
op_amp
l_int|0xc000
)paren
suffix:semicolon
r_if
c_cond
(paren
id|SCB_RUdead
c_func
(paren
id|status
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: RU stopped: status %04x&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|status
)paren
suffix:semicolon
macro_line|#if 0
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: cur_rfd=%04x, cur_rbd=%04x&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|lp-&gt;cur_rfd
comma
id|lp-&gt;cur_rbd
)paren
suffix:semicolon
id|outw
c_func
(paren
id|lp-&gt;cur_rfd
comma
id|ioaddr
op_plus
id|READ_PTR
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: [%04x]&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|inw
c_func
(paren
id|ioaddr
op_plus
id|DATAPORT
)paren
)paren
suffix:semicolon
id|outw
c_func
(paren
id|lp-&gt;cur_rfd
op_plus
l_int|6
comma
id|ioaddr
op_plus
id|READ_PTR
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: rbd is %04x&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|rbd
op_assign
id|inw
c_func
(paren
id|ioaddr
op_plus
id|DATAPORT
)paren
)paren
suffix:semicolon
id|outw
c_func
(paren
id|rbd
comma
id|ioaddr
op_plus
id|READ_PTR
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: [%04x %04x] &quot;
comma
id|dev-&gt;name
comma
id|inw
c_func
(paren
id|ioaddr
op_plus
id|DATAPORT
)paren
comma
id|inw
c_func
(paren
id|ioaddr
op_plus
id|DATAPORT
)paren
)paren
suffix:semicolon
id|outw
c_func
(paren
id|rbd
op_plus
l_int|8
comma
id|ioaddr
op_plus
id|READ_PTR
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;[%04x]&bslash;n&quot;
comma
id|inw
c_func
(paren
id|ioaddr
op_plus
id|DATAPORT
)paren
)paren
suffix:semicolon
macro_line|#endif
id|lp-&gt;stats.rx_errors
op_increment
suffix:semicolon
macro_line|#if 1
id|eexp_hw_rxinit
c_func
(paren
id|dev
)paren
suffix:semicolon
macro_line|#else
id|lp-&gt;cur_rfd
op_assign
id|lp-&gt;first_rfd
suffix:semicolon
macro_line|#endif
id|scb_wrrfa
c_func
(paren
id|dev
comma
id|lp-&gt;rx_buf_start
)paren
suffix:semicolon
id|scb_command
c_func
(paren
id|dev
comma
id|SCB_RUstart
)paren
suffix:semicolon
id|outb
c_func
(paren
l_int|0
comma
id|ioaddr
op_plus
id|SIGNAL_CA
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
r_if
c_cond
(paren
id|status
op_amp
l_int|0x8000
)paren
id|ack_cmd
op_assign
id|eexp_start_irq
c_func
(paren
id|dev
comma
id|status
)paren
suffix:semicolon
r_else
id|ack_cmd
op_assign
id|SCB_ack
c_func
(paren
id|status
)paren
suffix:semicolon
id|scb_command
c_func
(paren
id|dev
comma
id|ack_cmd
)paren
suffix:semicolon
id|outb
c_func
(paren
l_int|0
comma
id|ioaddr
op_plus
id|SIGNAL_CA
)paren
suffix:semicolon
)brace
id|eexp_cmd_clear
c_func
(paren
id|dev
)paren
suffix:semicolon
id|outb
c_func
(paren
id|SIRQ_en
op_or
id|irqrmap
(braket
id|irq
)braket
comma
id|ioaddr
op_plus
id|SET_IRQ
)paren
suffix:semicolon
macro_line|#if NET_DEBUG &gt; 6 
id|printk
c_func
(paren
l_string|&quot;%s: leaving eexp_irq()&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
macro_line|#endif
id|outw
c_func
(paren
id|old_read_ptr
comma
id|ioaddr
op_plus
id|READ_PTR
)paren
suffix:semicolon
id|outw
c_func
(paren
id|old_write_ptr
comma
id|ioaddr
op_plus
id|WRITE_PTR
)paren
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|lp-&gt;lock
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/*&n; * Hardware access functions&n; */
multiline_comment|/*&n; * Set the cable type to use.&n; */
DECL|function|eexp_hw_set_interface
r_static
r_void
id|eexp_hw_set_interface
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_int
r_char
id|oldval
op_assign
id|inb
c_func
(paren
id|dev-&gt;base_addr
op_plus
l_int|0x300e
)paren
suffix:semicolon
id|oldval
op_and_assign
op_complement
l_int|0x82
suffix:semicolon
r_switch
c_cond
(paren
id|dev-&gt;if_port
)paren
(brace
r_case
id|TPE
suffix:colon
id|oldval
op_or_assign
l_int|0x2
suffix:semicolon
r_case
id|BNC
suffix:colon
id|oldval
op_or_assign
l_int|0x80
suffix:semicolon
r_break
suffix:semicolon
)brace
id|outb
c_func
(paren
id|oldval
comma
id|dev-&gt;base_addr
op_plus
l_int|0x300e
)paren
suffix:semicolon
id|mdelay
c_func
(paren
l_int|20
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Check all the receive buffers, and hand any received packets&n; * to the upper levels. Basic sanity check on each frame&n; * descriptor, though we don&squot;t bother trying to fix broken ones.&n; */
DECL|function|eexp_hw_rx_pio
r_static
r_void
id|eexp_hw_rx_pio
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|net_local
op_star
id|lp
op_assign
(paren
r_struct
id|net_local
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_int
r_int
id|rx_block
op_assign
id|lp-&gt;rx_ptr
suffix:semicolon
r_int
r_int
id|boguscount
op_assign
id|lp-&gt;num_rx_bufs
suffix:semicolon
r_int
r_int
id|ioaddr
op_assign
id|dev-&gt;base_addr
suffix:semicolon
r_int
r_int
id|status
suffix:semicolon
macro_line|#if NET_DEBUG &gt; 6
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%s: eexp_hw_rx()&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
macro_line|#endif
r_do
(brace
r_int
r_int
id|rfd_cmd
comma
id|rx_next
comma
id|pbuf
comma
id|pkt_len
suffix:semicolon
id|outw
c_func
(paren
id|rx_block
comma
id|ioaddr
op_plus
id|READ_PTR
)paren
suffix:semicolon
id|status
op_assign
id|inw
c_func
(paren
id|ioaddr
op_plus
id|DATAPORT
)paren
suffix:semicolon
r_if
c_cond
(paren
id|FD_Done
c_func
(paren
id|status
)paren
)paren
(brace
id|rfd_cmd
op_assign
id|inw
c_func
(paren
id|ioaddr
op_plus
id|DATAPORT
)paren
suffix:semicolon
id|rx_next
op_assign
id|inw
c_func
(paren
id|ioaddr
op_plus
id|DATAPORT
)paren
suffix:semicolon
id|pbuf
op_assign
id|inw
c_func
(paren
id|ioaddr
op_plus
id|DATAPORT
)paren
suffix:semicolon
id|outw
c_func
(paren
id|pbuf
comma
id|ioaddr
op_plus
id|READ_PTR
)paren
suffix:semicolon
id|pkt_len
op_assign
id|inw
c_func
(paren
id|ioaddr
op_plus
id|DATAPORT
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rfd_cmd
op_ne
l_int|0x0000
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: rfd_cmd not zero:0x%04x&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|rfd_cmd
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|pbuf
op_ne
id|rx_block
op_plus
l_int|0x16
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: rfd and rbd out of sync 0x%04x 0x%04x&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|rx_block
op_plus
l_int|0x16
comma
id|pbuf
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
(paren
id|pkt_len
op_amp
l_int|0xc000
)paren
op_ne
l_int|0xc000
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: EOF or F not set on received buffer (%04x)&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|pkt_len
op_amp
l_int|0xc000
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
op_logical_neg
id|FD_OK
c_func
(paren
id|status
)paren
)paren
(brace
id|lp-&gt;stats.rx_errors
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|FD_CRC
c_func
(paren
id|status
)paren
)paren
id|lp-&gt;stats.rx_crc_errors
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|FD_Align
c_func
(paren
id|status
)paren
)paren
id|lp-&gt;stats.rx_frame_errors
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|FD_Resrc
c_func
(paren
id|status
)paren
)paren
id|lp-&gt;stats.rx_fifo_errors
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|FD_DMA
c_func
(paren
id|status
)paren
)paren
id|lp-&gt;stats.rx_over_errors
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|FD_Short
c_func
(paren
id|status
)paren
)paren
id|lp-&gt;stats.rx_length_errors
op_increment
suffix:semicolon
)brace
r_else
(brace
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
id|pkt_len
op_and_assign
l_int|0x3fff
suffix:semicolon
id|skb
op_assign
id|dev_alloc_skb
c_func
(paren
id|pkt_len
op_plus
l_int|16
)paren
suffix:semicolon
r_if
c_cond
(paren
id|skb
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: Memory squeeze, dropping packet&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|lp-&gt;stats.rx_dropped
op_increment
suffix:semicolon
r_break
suffix:semicolon
)brace
id|skb-&gt;dev
op_assign
id|dev
suffix:semicolon
id|skb_reserve
c_func
(paren
id|skb
comma
l_int|2
)paren
suffix:semicolon
id|outw
c_func
(paren
id|pbuf
op_plus
l_int|10
comma
id|ioaddr
op_plus
id|READ_PTR
)paren
suffix:semicolon
id|insw
c_func
(paren
id|ioaddr
op_plus
id|DATAPORT
comma
id|skb_put
c_func
(paren
id|skb
comma
id|pkt_len
)paren
comma
(paren
id|pkt_len
op_plus
l_int|1
)paren
op_rshift
l_int|1
)paren
suffix:semicolon
id|skb-&gt;protocol
op_assign
id|eth_type_trans
c_func
(paren
id|skb
comma
id|dev
)paren
suffix:semicolon
id|netif_rx
c_func
(paren
id|skb
)paren
suffix:semicolon
id|lp-&gt;stats.rx_packets
op_increment
suffix:semicolon
id|lp-&gt;stats.rx_bytes
op_add_assign
id|pkt_len
suffix:semicolon
)brace
id|outw
c_func
(paren
id|rx_block
comma
id|ioaddr
op_plus
id|WRITE_PTR
)paren
suffix:semicolon
id|outw
c_func
(paren
l_int|0
comma
id|ioaddr
op_plus
id|DATAPORT
)paren
suffix:semicolon
id|outw
c_func
(paren
l_int|0
comma
id|ioaddr
op_plus
id|DATAPORT
)paren
suffix:semicolon
id|rx_block
op_assign
id|rx_next
suffix:semicolon
)brace
)brace
r_while
c_loop
(paren
id|FD_Done
c_func
(paren
id|status
)paren
op_logical_and
id|boguscount
op_decrement
)paren
suffix:semicolon
id|lp-&gt;rx_ptr
op_assign
id|rx_block
suffix:semicolon
)brace
multiline_comment|/*&n; * Hand a packet to the card for transmission&n; * If we get here, we MUST have already checked&n; * to make sure there is room in the transmit&n; * buffer region.&n; */
DECL|function|eexp_hw_tx_pio
r_static
r_void
id|eexp_hw_tx_pio
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_int
r_int
op_star
id|buf
comma
r_int
r_int
id|len
)paren
(brace
r_struct
id|net_local
op_star
id|lp
op_assign
(paren
r_struct
id|net_local
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_int
r_int
id|ioaddr
op_assign
id|dev-&gt;base_addr
suffix:semicolon
r_if
c_cond
(paren
id|LOCKUP16
op_logical_or
id|lp-&gt;width
)paren
(brace
multiline_comment|/* Stop the CU so that there is no chance that it&n;&t;&t;   jumps off to a bogus address while we are writing the&n;&t;&t;   pointer to the next transmit packet in 8-bit mode -- &n;&t;&t;   this eliminates the &quot;CU wedged&quot; errors in 8-bit mode.&n;&t;&t;   (Zoltan Szilagyi 10-12-96) */
id|scb_command
c_func
(paren
id|dev
comma
id|SCB_CUsuspend
)paren
suffix:semicolon
id|outw
c_func
(paren
l_int|0xFFFF
comma
id|ioaddr
op_plus
id|SIGNAL_CA
)paren
suffix:semicolon
)brace
id|outw
c_func
(paren
id|lp-&gt;tx_head
comma
id|ioaddr
op_plus
id|WRITE_PTR
)paren
suffix:semicolon
id|outw
c_func
(paren
l_int|0x0000
comma
id|ioaddr
op_plus
id|DATAPORT
)paren
suffix:semicolon
id|outw
c_func
(paren
id|Cmd_INT
op_or
id|Cmd_Xmit
comma
id|ioaddr
op_plus
id|DATAPORT
)paren
suffix:semicolon
id|outw
c_func
(paren
id|lp-&gt;tx_head
op_plus
l_int|0x08
comma
id|ioaddr
op_plus
id|DATAPORT
)paren
suffix:semicolon
id|outw
c_func
(paren
id|lp-&gt;tx_head
op_plus
l_int|0x0e
comma
id|ioaddr
op_plus
id|DATAPORT
)paren
suffix:semicolon
id|outw
c_func
(paren
l_int|0x0000
comma
id|ioaddr
op_plus
id|DATAPORT
)paren
suffix:semicolon
id|outw
c_func
(paren
l_int|0x0000
comma
id|ioaddr
op_plus
id|DATAPORT
)paren
suffix:semicolon
id|outw
c_func
(paren
id|lp-&gt;tx_head
op_plus
l_int|0x08
comma
id|ioaddr
op_plus
id|DATAPORT
)paren
suffix:semicolon
id|outw
c_func
(paren
l_int|0x8000
op_or
id|len
comma
id|ioaddr
op_plus
id|DATAPORT
)paren
suffix:semicolon
id|outw
c_func
(paren
op_minus
l_int|1
comma
id|ioaddr
op_plus
id|DATAPORT
)paren
suffix:semicolon
id|outw
c_func
(paren
id|lp-&gt;tx_head
op_plus
l_int|0x16
comma
id|ioaddr
op_plus
id|DATAPORT
)paren
suffix:semicolon
id|outw
c_func
(paren
l_int|0
comma
id|ioaddr
op_plus
id|DATAPORT
)paren
suffix:semicolon
id|outsw
c_func
(paren
id|ioaddr
op_plus
id|DATAPORT
comma
id|buf
comma
(paren
id|len
op_plus
l_int|1
)paren
op_rshift
l_int|1
)paren
suffix:semicolon
id|outw
c_func
(paren
id|lp-&gt;tx_tail
op_plus
l_int|0xc
comma
id|ioaddr
op_plus
id|WRITE_PTR
)paren
suffix:semicolon
id|outw
c_func
(paren
id|lp-&gt;tx_head
comma
id|ioaddr
op_plus
id|DATAPORT
)paren
suffix:semicolon
id|dev-&gt;trans_start
op_assign
id|jiffies
suffix:semicolon
id|lp-&gt;tx_tail
op_assign
id|lp-&gt;tx_head
suffix:semicolon
r_if
c_cond
(paren
id|lp-&gt;tx_head
op_eq
id|TX_BUF_START
op_plus
(paren
(paren
id|lp-&gt;num_tx_bufs
op_minus
l_int|1
)paren
op_star
id|TX_BUF_SIZE
)paren
)paren
id|lp-&gt;tx_head
op_assign
id|TX_BUF_START
suffix:semicolon
r_else
id|lp-&gt;tx_head
op_add_assign
id|TX_BUF_SIZE
suffix:semicolon
r_if
c_cond
(paren
id|lp-&gt;tx_head
op_ne
id|lp-&gt;tx_reap
)paren
id|netif_wake_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|LOCKUP16
op_logical_or
id|lp-&gt;width
)paren
(brace
multiline_comment|/* Restart the CU so that the packet can actually&n;&t;&t;   be transmitted. (Zoltan Szilagyi 10-12-96) */
id|scb_command
c_func
(paren
id|dev
comma
id|SCB_CUresume
)paren
suffix:semicolon
id|outw
c_func
(paren
l_int|0xFFFF
comma
id|ioaddr
op_plus
id|SIGNAL_CA
)paren
suffix:semicolon
)brace
id|lp-&gt;stats.tx_packets
op_increment
suffix:semicolon
id|lp-&gt;last_tx
op_assign
id|jiffies
suffix:semicolon
)brace
multiline_comment|/*&n; * Sanity check the suspected EtherExpress card&n; * Read hardware address, reset card, size memory and initialize buffer&n; * memory pointers. These are held in dev-&gt;priv, in case someone has more&n; * than one card in a machine.&n; */
DECL|function|eexp_hw_probe
r_static
r_int
id|__init
id|eexp_hw_probe
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_int
r_int
id|ioaddr
)paren
(brace
r_int
r_int
id|hw_addr
(braket
l_int|3
)braket
suffix:semicolon
r_int
r_char
id|buswidth
suffix:semicolon
r_int
r_int
id|memory_size
suffix:semicolon
r_int
id|i
suffix:semicolon
r_int
r_int
id|xsum
op_assign
l_int|0
suffix:semicolon
r_struct
id|net_local
op_star
id|lp
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;%s: EtherExpress 16 at %#x &quot;
comma
id|dev-&gt;name
comma
id|ioaddr
)paren
suffix:semicolon
id|outb
c_func
(paren
id|ASIC_RST
comma
id|ioaddr
op_plus
id|EEPROM_Ctrl
)paren
suffix:semicolon
id|outb
c_func
(paren
l_int|0
comma
id|ioaddr
op_plus
id|EEPROM_Ctrl
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|500
)paren
suffix:semicolon
id|outb
c_func
(paren
id|i586_RST
comma
id|ioaddr
op_plus
id|EEPROM_Ctrl
)paren
suffix:semicolon
id|hw_addr
(braket
l_int|0
)braket
op_assign
id|eexp_hw_readeeprom
c_func
(paren
id|ioaddr
comma
l_int|2
)paren
suffix:semicolon
id|hw_addr
(braket
l_int|1
)braket
op_assign
id|eexp_hw_readeeprom
c_func
(paren
id|ioaddr
comma
l_int|3
)paren
suffix:semicolon
id|hw_addr
(braket
l_int|2
)braket
op_assign
id|eexp_hw_readeeprom
c_func
(paren
id|ioaddr
comma
l_int|4
)paren
suffix:semicolon
multiline_comment|/* Standard Address or Compaq LTE Address */
r_if
c_cond
(paren
op_logical_neg
(paren
(paren
id|hw_addr
(braket
l_int|2
)braket
op_eq
l_int|0x00aa
op_logical_and
(paren
(paren
id|hw_addr
(braket
l_int|1
)braket
op_amp
l_int|0xff00
)paren
op_eq
l_int|0x0000
)paren
)paren
op_logical_or
(paren
id|hw_addr
(braket
l_int|2
)braket
op_eq
l_int|0x0080
op_logical_and
(paren
(paren
id|hw_addr
(braket
l_int|1
)braket
op_amp
l_int|0xff00
)paren
op_eq
l_int|0x5F00
)paren
)paren
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot; rejected: invalid address %04x%04x%04x&bslash;n&quot;
comma
id|hw_addr
(braket
l_int|2
)braket
comma
id|hw_addr
(braket
l_int|1
)braket
comma
id|hw_addr
(braket
l_int|0
)braket
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
multiline_comment|/* Calculate the EEPROM checksum.  Carry on anyway if it&squot;s bad,&n;&t; * though.&n;&t; */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|64
suffix:semicolon
id|i
op_increment
)paren
id|xsum
op_add_assign
id|eexp_hw_readeeprom
c_func
(paren
id|ioaddr
comma
id|i
)paren
suffix:semicolon
r_if
c_cond
(paren
id|xsum
op_ne
l_int|0xbaba
)paren
id|printk
c_func
(paren
l_string|&quot; (bad EEPROM xsum 0x%02x)&quot;
comma
id|xsum
)paren
suffix:semicolon
id|dev-&gt;base_addr
op_assign
id|ioaddr
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|6
suffix:semicolon
id|i
op_increment
)paren
id|dev-&gt;dev_addr
(braket
id|i
)braket
op_assign
(paren
(paren
r_int
r_char
op_star
)paren
id|hw_addr
)paren
(braket
l_int|5
op_minus
id|i
)braket
suffix:semicolon
(brace
r_static
r_char
id|irqmap
(braket
)braket
op_assign
initialization_block
suffix:semicolon
r_int
r_int
id|setupval
op_assign
id|eexp_hw_readeeprom
c_func
(paren
id|ioaddr
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* Use the IRQ from EEPROM if none was given */
r_if
c_cond
(paren
op_logical_neg
id|dev-&gt;irq
)paren
id|dev-&gt;irq
op_assign
id|irqmap
(braket
id|setupval
op_rshift
l_int|13
)braket
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;if_port
op_eq
l_int|0xff
)paren
(brace
id|dev-&gt;if_port
op_assign
op_logical_neg
(paren
id|setupval
op_amp
l_int|0x1000
)paren
ques
c_cond
id|AUI
suffix:colon
id|eexp_hw_readeeprom
c_func
(paren
id|ioaddr
comma
l_int|5
)paren
op_amp
l_int|0x1
ques
c_cond
id|TPE
suffix:colon
id|BNC
suffix:semicolon
)brace
id|buswidth
op_assign
op_logical_neg
(paren
(paren
id|setupval
op_amp
l_int|0x400
)paren
op_rshift
l_int|10
)paren
suffix:semicolon
)brace
id|dev-&gt;priv
op_assign
id|lp
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|net_local
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dev-&gt;priv
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|memset
c_func
(paren
id|dev-&gt;priv
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|net_local
)paren
)paren
suffix:semicolon
id|spin_lock_init
c_func
(paren
op_amp
id|lp-&gt;lock
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;(IRQ %d, %s connector, %d-bit bus&quot;
comma
id|dev-&gt;irq
comma
id|eexp_ifmap
(braket
id|dev-&gt;if_port
)braket
comma
id|buswidth
ques
c_cond
l_int|8
suffix:colon
l_int|16
)paren
suffix:semicolon
id|eexp_hw_set_interface
c_func
(paren
id|dev
)paren
suffix:semicolon
multiline_comment|/* Find out how much RAM we have on the card */
id|outw
c_func
(paren
l_int|0
comma
id|dev-&gt;base_addr
op_plus
id|WRITE_PTR
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|32768
suffix:semicolon
id|i
op_increment
)paren
id|outw
c_func
(paren
l_int|0
comma
id|dev-&gt;base_addr
op_plus
id|DATAPORT
)paren
suffix:semicolon
r_for
c_loop
(paren
id|memory_size
op_assign
l_int|0
suffix:semicolon
id|memory_size
OL
l_int|64
suffix:semicolon
id|memory_size
op_increment
)paren
(brace
id|outw
c_func
(paren
id|memory_size
op_lshift
l_int|10
comma
id|dev-&gt;base_addr
op_plus
id|READ_PTR
)paren
suffix:semicolon
r_if
c_cond
(paren
id|inw
c_func
(paren
id|dev-&gt;base_addr
op_plus
id|DATAPORT
)paren
)paren
r_break
suffix:semicolon
id|outw
c_func
(paren
id|memory_size
op_lshift
l_int|10
comma
id|dev-&gt;base_addr
op_plus
id|WRITE_PTR
)paren
suffix:semicolon
id|outw
c_func
(paren
id|memory_size
op_or
l_int|0x5000
comma
id|dev-&gt;base_addr
op_plus
id|DATAPORT
)paren
suffix:semicolon
id|outw
c_func
(paren
id|memory_size
op_lshift
l_int|10
comma
id|dev-&gt;base_addr
op_plus
id|READ_PTR
)paren
suffix:semicolon
r_if
c_cond
(paren
id|inw
c_func
(paren
id|dev-&gt;base_addr
op_plus
id|DATAPORT
)paren
op_ne
(paren
id|memory_size
op_or
l_int|0x5000
)paren
)paren
r_break
suffix:semicolon
)brace
multiline_comment|/* Sort out the number of buffers.  We may have 16, 32, 48 or 64k&n;&t; * of RAM to play with.&n;&t; */
id|lp-&gt;num_tx_bufs
op_assign
l_int|4
suffix:semicolon
id|lp-&gt;rx_buf_end
op_assign
l_int|0x3ff6
suffix:semicolon
r_switch
c_cond
(paren
id|memory_size
)paren
(brace
r_case
l_int|64
suffix:colon
id|lp-&gt;rx_buf_end
op_add_assign
l_int|0x4000
suffix:semicolon
r_case
l_int|48
suffix:colon
id|lp-&gt;num_tx_bufs
op_add_assign
l_int|4
suffix:semicolon
id|lp-&gt;rx_buf_end
op_add_assign
l_int|0x4000
suffix:semicolon
r_case
l_int|32
suffix:colon
id|lp-&gt;rx_buf_end
op_add_assign
l_int|0x4000
suffix:semicolon
r_case
l_int|16
suffix:colon
id|printk
c_func
(paren
l_string|&quot;, %dk RAM)&bslash;n&quot;
comma
id|memory_size
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|printk
c_func
(paren
l_string|&quot;) bad memory size (%dk).&bslash;n&quot;
comma
id|memory_size
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|dev-&gt;priv
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
r_break
suffix:semicolon
)brace
id|lp-&gt;rx_buf_start
op_assign
id|TX_BUF_START
op_plus
(paren
id|lp-&gt;num_tx_bufs
op_star
id|TX_BUF_SIZE
)paren
suffix:semicolon
id|lp-&gt;width
op_assign
id|buswidth
suffix:semicolon
id|dev-&gt;open
op_assign
id|eexp_open
suffix:semicolon
id|dev-&gt;stop
op_assign
id|eexp_close
suffix:semicolon
id|dev-&gt;hard_start_xmit
op_assign
id|eexp_xmit
suffix:semicolon
id|dev-&gt;get_stats
op_assign
id|eexp_stats
suffix:semicolon
id|dev-&gt;set_multicast_list
op_assign
op_amp
id|eexp_set_multicast
suffix:semicolon
id|dev-&gt;tx_timeout
op_assign
id|eexp_timeout
suffix:semicolon
id|dev-&gt;watchdog_timeo
op_assign
l_int|2
op_star
id|HZ
suffix:semicolon
id|ether_setup
c_func
(paren
id|dev
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * Read a word from the EtherExpress on-board serial EEPROM.&n; * The EEPROM contains 64 words of 16 bits.&n; */
DECL|function|eexp_hw_readeeprom
r_static
r_int
r_int
id|__init
id|eexp_hw_readeeprom
c_func
(paren
r_int
r_int
id|ioaddr
comma
r_int
r_char
id|location
)paren
(brace
r_int
r_int
id|cmd
op_assign
l_int|0x180
op_or
(paren
id|location
op_amp
l_int|0x7f
)paren
suffix:semicolon
r_int
r_int
id|rval
op_assign
l_int|0
comma
id|wval
op_assign
id|EC_CS
op_or
id|i586_RST
suffix:semicolon
r_int
id|i
suffix:semicolon
id|outb
c_func
(paren
id|EC_CS
op_or
id|i586_RST
comma
id|ioaddr
op_plus
id|EEPROM_Ctrl
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0x100
suffix:semicolon
id|i
suffix:semicolon
id|i
op_rshift_assign
l_int|1
)paren
(brace
r_if
c_cond
(paren
id|cmd
op_amp
id|i
)paren
id|wval
op_or_assign
id|EC_Wr
suffix:semicolon
r_else
id|wval
op_and_assign
op_complement
id|EC_Wr
suffix:semicolon
id|outb
c_func
(paren
id|wval
comma
id|ioaddr
op_plus
id|EEPROM_Ctrl
)paren
suffix:semicolon
id|outb
c_func
(paren
id|wval
op_or
id|EC_Clk
comma
id|ioaddr
op_plus
id|EEPROM_Ctrl
)paren
suffix:semicolon
id|eeprom_delay
c_func
(paren
)paren
suffix:semicolon
id|outb
c_func
(paren
id|wval
comma
id|ioaddr
op_plus
id|EEPROM_Ctrl
)paren
suffix:semicolon
id|eeprom_delay
c_func
(paren
)paren
suffix:semicolon
)brace
id|wval
op_and_assign
op_complement
id|EC_Wr
suffix:semicolon
id|outb
c_func
(paren
id|wval
comma
id|ioaddr
op_plus
id|EEPROM_Ctrl
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0x8000
suffix:semicolon
id|i
suffix:semicolon
id|i
op_rshift_assign
l_int|1
)paren
(brace
id|outb
c_func
(paren
id|wval
op_or
id|EC_Clk
comma
id|ioaddr
op_plus
id|EEPROM_Ctrl
)paren
suffix:semicolon
id|eeprom_delay
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|inb
c_func
(paren
id|ioaddr
op_plus
id|EEPROM_Ctrl
)paren
op_amp
id|EC_Rd
)paren
id|rval
op_or_assign
id|i
suffix:semicolon
id|outb
c_func
(paren
id|wval
comma
id|ioaddr
op_plus
id|EEPROM_Ctrl
)paren
suffix:semicolon
id|eeprom_delay
c_func
(paren
)paren
suffix:semicolon
)brace
id|wval
op_and_assign
op_complement
id|EC_CS
suffix:semicolon
id|outb
c_func
(paren
id|wval
op_or
id|EC_Clk
comma
id|ioaddr
op_plus
id|EEPROM_Ctrl
)paren
suffix:semicolon
id|eeprom_delay
c_func
(paren
)paren
suffix:semicolon
id|outb
c_func
(paren
id|wval
comma
id|ioaddr
op_plus
id|EEPROM_Ctrl
)paren
suffix:semicolon
id|eeprom_delay
c_func
(paren
)paren
suffix:semicolon
r_return
id|rval
suffix:semicolon
)brace
multiline_comment|/*&n; * Reap tx buffers and return last transmit status.&n; * if ==0 then either:&n; *    a) we&squot;re not transmitting anything, so why are we here?&n; *    b) we&squot;ve died.&n; * otherwise, Stat_Busy(return) means we&squot;ve still got some packets&n; * to transmit, Stat_Done(return) means our buffers should be empty&n; * again&n; */
DECL|function|eexp_hw_lasttxstat
r_static
r_int
r_int
id|eexp_hw_lasttxstat
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|net_local
op_star
id|lp
op_assign
(paren
r_struct
id|net_local
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_int
r_int
id|tx_block
op_assign
id|lp-&gt;tx_reap
suffix:semicolon
r_int
r_int
id|status
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|netif_queue_stopped
c_func
(paren
id|dev
)paren
op_logical_and
id|lp-&gt;tx_head
op_eq
id|lp-&gt;tx_reap
)paren
r_return
l_int|0x0000
suffix:semicolon
r_do
(brace
id|outw
c_func
(paren
id|tx_block
op_amp
op_complement
l_int|31
comma
id|dev-&gt;base_addr
op_plus
id|SM_PTR
)paren
suffix:semicolon
id|status
op_assign
id|inw
c_func
(paren
id|dev-&gt;base_addr
op_plus
id|SHADOW
c_func
(paren
id|tx_block
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|Stat_Done
c_func
(paren
id|status
)paren
)paren
(brace
id|lp-&gt;tx_link
op_assign
id|tx_block
suffix:semicolon
r_return
id|status
suffix:semicolon
)brace
r_else
(brace
id|lp-&gt;last_tx_restart
op_assign
l_int|0
suffix:semicolon
id|lp-&gt;stats.collisions
op_add_assign
id|Stat_NoColl
c_func
(paren
id|status
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|Stat_OK
c_func
(paren
id|status
)paren
)paren
(brace
r_char
op_star
id|whatsup
op_assign
l_int|NULL
suffix:semicolon
id|lp-&gt;stats.tx_errors
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|Stat_Abort
c_func
(paren
id|status
)paren
)paren
id|lp-&gt;stats.tx_aborted_errors
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|Stat_TNoCar
c_func
(paren
id|status
)paren
)paren
(brace
id|whatsup
op_assign
l_string|&quot;aborted, no carrier&quot;
suffix:semicolon
id|lp-&gt;stats.tx_carrier_errors
op_increment
suffix:semicolon
)brace
r_if
c_cond
(paren
id|Stat_TNoCTS
c_func
(paren
id|status
)paren
)paren
(brace
id|whatsup
op_assign
l_string|&quot;aborted, lost CTS&quot;
suffix:semicolon
id|lp-&gt;stats.tx_carrier_errors
op_increment
suffix:semicolon
)brace
r_if
c_cond
(paren
id|Stat_TNoDMA
c_func
(paren
id|status
)paren
)paren
(brace
id|whatsup
op_assign
l_string|&quot;FIFO underran&quot;
suffix:semicolon
id|lp-&gt;stats.tx_fifo_errors
op_increment
suffix:semicolon
)brace
r_if
c_cond
(paren
id|Stat_TXColl
c_func
(paren
id|status
)paren
)paren
(brace
id|whatsup
op_assign
l_string|&quot;aborted, too many collisions&quot;
suffix:semicolon
id|lp-&gt;stats.tx_aborted_errors
op_increment
suffix:semicolon
)brace
r_if
c_cond
(paren
id|whatsup
)paren
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: transmit %s&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|whatsup
)paren
suffix:semicolon
)brace
r_else
id|lp-&gt;stats.tx_packets
op_increment
suffix:semicolon
)brace
r_if
c_cond
(paren
id|tx_block
op_eq
id|TX_BUF_START
op_plus
(paren
(paren
id|lp-&gt;num_tx_bufs
op_minus
l_int|1
)paren
op_star
id|TX_BUF_SIZE
)paren
)paren
id|lp-&gt;tx_reap
op_assign
id|tx_block
op_assign
id|TX_BUF_START
suffix:semicolon
r_else
id|lp-&gt;tx_reap
op_assign
id|tx_block
op_add_assign
id|TX_BUF_SIZE
suffix:semicolon
id|netif_wake_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
id|lp-&gt;tx_reap
op_ne
id|lp-&gt;tx_head
)paren
suffix:semicolon
id|lp-&gt;tx_link
op_assign
id|lp-&gt;tx_tail
op_plus
l_int|0x08
suffix:semicolon
r_return
id|status
suffix:semicolon
)brace
multiline_comment|/*&n; * This should never happen. It is called when some higher routine detects&n; * that the CU has stopped, to try to restart it from the last packet we knew&n; * we were working on, or the idle loop if we had finished for the time.&n; */
DECL|function|eexp_hw_txrestart
r_static
r_void
id|eexp_hw_txrestart
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|net_local
op_star
id|lp
op_assign
(paren
r_struct
id|net_local
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_int
r_int
id|ioaddr
op_assign
id|dev-&gt;base_addr
suffix:semicolon
id|lp-&gt;last_tx_restart
op_assign
id|lp-&gt;tx_link
suffix:semicolon
id|scb_wrcbl
c_func
(paren
id|dev
comma
id|lp-&gt;tx_link
)paren
suffix:semicolon
id|scb_command
c_func
(paren
id|dev
comma
id|SCB_CUstart
)paren
suffix:semicolon
id|outb
c_func
(paren
l_int|0
comma
id|ioaddr
op_plus
id|SIGNAL_CA
)paren
suffix:semicolon
(brace
r_int
r_int
id|boguscount
op_assign
l_int|50
comma
id|failcount
op_assign
l_int|5
suffix:semicolon
r_while
c_loop
(paren
op_logical_neg
id|scb_status
c_func
(paren
id|dev
)paren
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
op_decrement
id|boguscount
)paren
(brace
r_if
c_cond
(paren
op_decrement
id|failcount
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: CU start timed out, status %04x, cmd %04x&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|scb_status
c_func
(paren
id|dev
)paren
comma
id|scb_rdcmd
c_func
(paren
id|dev
)paren
)paren
suffix:semicolon
id|scb_wrcbl
c_func
(paren
id|dev
comma
id|lp-&gt;tx_link
)paren
suffix:semicolon
id|scb_command
c_func
(paren
id|dev
comma
id|SCB_CUstart
)paren
suffix:semicolon
id|outb
c_func
(paren
l_int|0
comma
id|ioaddr
op_plus
id|SIGNAL_CA
)paren
suffix:semicolon
id|boguscount
op_assign
l_int|100
suffix:semicolon
)brace
r_else
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: Failed to restart CU, resetting board...&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|eexp_hw_init586
c_func
(paren
id|dev
)paren
suffix:semicolon
id|netif_wake_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
)brace
)brace
)brace
)brace
multiline_comment|/*&n; * Writes down the list of transmit buffers into card memory.  Each&n; * entry consists of an 82586 transmit command, followed by a jump&n; * pointing to itself.  When we want to transmit a packet, we write&n; * the data into the appropriate transmit buffer and then modify the&n; * preceding jump to point at the new transmit command.  This means that&n; * the 586 command unit is continuously active.&n; */
DECL|function|eexp_hw_txinit
r_static
r_void
id|eexp_hw_txinit
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|net_local
op_star
id|lp
op_assign
(paren
r_struct
id|net_local
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_int
r_int
id|tx_block
op_assign
id|TX_BUF_START
suffix:semicolon
r_int
r_int
id|curtbuf
suffix:semicolon
r_int
r_int
id|ioaddr
op_assign
id|dev-&gt;base_addr
suffix:semicolon
r_for
c_loop
(paren
id|curtbuf
op_assign
l_int|0
suffix:semicolon
id|curtbuf
OL
id|lp-&gt;num_tx_bufs
suffix:semicolon
id|curtbuf
op_increment
)paren
(brace
id|outw
c_func
(paren
id|tx_block
comma
id|ioaddr
op_plus
id|WRITE_PTR
)paren
suffix:semicolon
id|outw
c_func
(paren
l_int|0x0000
comma
id|ioaddr
op_plus
id|DATAPORT
)paren
suffix:semicolon
id|outw
c_func
(paren
id|Cmd_INT
op_or
id|Cmd_Xmit
comma
id|ioaddr
op_plus
id|DATAPORT
)paren
suffix:semicolon
id|outw
c_func
(paren
id|tx_block
op_plus
l_int|0x08
comma
id|ioaddr
op_plus
id|DATAPORT
)paren
suffix:semicolon
id|outw
c_func
(paren
id|tx_block
op_plus
l_int|0x0e
comma
id|ioaddr
op_plus
id|DATAPORT
)paren
suffix:semicolon
id|outw
c_func
(paren
l_int|0x0000
comma
id|ioaddr
op_plus
id|DATAPORT
)paren
suffix:semicolon
id|outw
c_func
(paren
l_int|0x0000
comma
id|ioaddr
op_plus
id|DATAPORT
)paren
suffix:semicolon
id|outw
c_func
(paren
id|tx_block
op_plus
l_int|0x08
comma
id|ioaddr
op_plus
id|DATAPORT
)paren
suffix:semicolon
id|outw
c_func
(paren
l_int|0x8000
comma
id|ioaddr
op_plus
id|DATAPORT
)paren
suffix:semicolon
id|outw
c_func
(paren
op_minus
l_int|1
comma
id|ioaddr
op_plus
id|DATAPORT
)paren
suffix:semicolon
id|outw
c_func
(paren
id|tx_block
op_plus
l_int|0x16
comma
id|ioaddr
op_plus
id|DATAPORT
)paren
suffix:semicolon
id|outw
c_func
(paren
l_int|0x0000
comma
id|ioaddr
op_plus
id|DATAPORT
)paren
suffix:semicolon
id|tx_block
op_add_assign
id|TX_BUF_SIZE
suffix:semicolon
)brace
id|lp-&gt;tx_head
op_assign
id|TX_BUF_START
suffix:semicolon
id|lp-&gt;tx_reap
op_assign
id|TX_BUF_START
suffix:semicolon
id|lp-&gt;tx_tail
op_assign
id|tx_block
op_minus
id|TX_BUF_SIZE
suffix:semicolon
id|lp-&gt;tx_link
op_assign
id|lp-&gt;tx_tail
op_plus
l_int|0x08
suffix:semicolon
id|lp-&gt;rx_buf_start
op_assign
id|tx_block
suffix:semicolon
)brace
multiline_comment|/*&n; * Write the circular list of receive buffer descriptors to card memory.&n; * The end of the list isn&squot;t marked, which means that the 82586 receive&n; * unit will loop until buffers become available (this avoids it giving us&n; * &quot;out of resources&quot; messages).&n; */
DECL|function|eexp_hw_rxinit
r_static
r_void
id|eexp_hw_rxinit
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|net_local
op_star
id|lp
op_assign
(paren
r_struct
id|net_local
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_int
r_int
id|rx_block
op_assign
id|lp-&gt;rx_buf_start
suffix:semicolon
r_int
r_int
id|ioaddr
op_assign
id|dev-&gt;base_addr
suffix:semicolon
id|lp-&gt;num_rx_bufs
op_assign
l_int|0
suffix:semicolon
id|lp-&gt;rx_first
op_assign
id|lp-&gt;rx_ptr
op_assign
id|rx_block
suffix:semicolon
r_do
(brace
id|lp-&gt;num_rx_bufs
op_increment
suffix:semicolon
id|outw
c_func
(paren
id|rx_block
comma
id|ioaddr
op_plus
id|WRITE_PTR
)paren
suffix:semicolon
id|outw
c_func
(paren
l_int|0
comma
id|ioaddr
op_plus
id|DATAPORT
)paren
suffix:semicolon
id|outw
c_func
(paren
l_int|0
comma
id|ioaddr
op_plus
id|DATAPORT
)paren
suffix:semicolon
id|outw
c_func
(paren
id|rx_block
op_plus
id|RX_BUF_SIZE
comma
id|ioaddr
op_plus
id|DATAPORT
)paren
suffix:semicolon
id|outw
c_func
(paren
l_int|0xffff
comma
id|ioaddr
op_plus
id|DATAPORT
)paren
suffix:semicolon
id|outw
c_func
(paren
l_int|0x0000
comma
id|ioaddr
op_plus
id|DATAPORT
)paren
suffix:semicolon
id|outw
c_func
(paren
l_int|0xdead
comma
id|ioaddr
op_plus
id|DATAPORT
)paren
suffix:semicolon
id|outw
c_func
(paren
l_int|0xdead
comma
id|ioaddr
op_plus
id|DATAPORT
)paren
suffix:semicolon
id|outw
c_func
(paren
l_int|0xdead
comma
id|ioaddr
op_plus
id|DATAPORT
)paren
suffix:semicolon
id|outw
c_func
(paren
l_int|0xdead
comma
id|ioaddr
op_plus
id|DATAPORT
)paren
suffix:semicolon
id|outw
c_func
(paren
l_int|0xdead
comma
id|ioaddr
op_plus
id|DATAPORT
)paren
suffix:semicolon
id|outw
c_func
(paren
l_int|0xdead
comma
id|ioaddr
op_plus
id|DATAPORT
)paren
suffix:semicolon
id|outw
c_func
(paren
l_int|0x0000
comma
id|ioaddr
op_plus
id|DATAPORT
)paren
suffix:semicolon
id|outw
c_func
(paren
id|rx_block
op_plus
id|RX_BUF_SIZE
op_plus
l_int|0x16
comma
id|ioaddr
op_plus
id|DATAPORT
)paren
suffix:semicolon
id|outw
c_func
(paren
id|rx_block
op_plus
l_int|0x20
comma
id|ioaddr
op_plus
id|DATAPORT
)paren
suffix:semicolon
id|outw
c_func
(paren
l_int|0
comma
id|ioaddr
op_plus
id|DATAPORT
)paren
suffix:semicolon
id|outw
c_func
(paren
id|RX_BUF_SIZE
op_minus
l_int|0x20
comma
id|ioaddr
op_plus
id|DATAPORT
)paren
suffix:semicolon
id|lp-&gt;rx_last
op_assign
id|rx_block
suffix:semicolon
id|rx_block
op_add_assign
id|RX_BUF_SIZE
suffix:semicolon
)brace
r_while
c_loop
(paren
id|rx_block
op_le
id|lp-&gt;rx_buf_end
op_minus
id|RX_BUF_SIZE
)paren
suffix:semicolon
multiline_comment|/* Make first Rx frame descriptor point to first Rx buffer&n;           descriptor */
id|outw
c_func
(paren
id|lp-&gt;rx_first
op_plus
l_int|6
comma
id|ioaddr
op_plus
id|WRITE_PTR
)paren
suffix:semicolon
id|outw
c_func
(paren
id|lp-&gt;rx_first
op_plus
l_int|0x16
comma
id|ioaddr
op_plus
id|DATAPORT
)paren
suffix:semicolon
multiline_comment|/* Close Rx frame descriptor ring */
id|outw
c_func
(paren
id|lp-&gt;rx_last
op_plus
l_int|4
comma
id|ioaddr
op_plus
id|WRITE_PTR
)paren
suffix:semicolon
id|outw
c_func
(paren
id|lp-&gt;rx_first
comma
id|ioaddr
op_plus
id|DATAPORT
)paren
suffix:semicolon
multiline_comment|/* Close Rx buffer descriptor ring */
id|outw
c_func
(paren
id|lp-&gt;rx_last
op_plus
l_int|0x16
op_plus
l_int|2
comma
id|ioaddr
op_plus
id|WRITE_PTR
)paren
suffix:semicolon
id|outw
c_func
(paren
id|lp-&gt;rx_first
op_plus
l_int|0x16
comma
id|ioaddr
op_plus
id|DATAPORT
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Un-reset the 586, and start the configuration sequence. We don&squot;t wait for&n; * this to finish, but allow the interrupt handler to start the CU and RU for&n; * us.  We can&squot;t start the receive/transmission system up before we know that&n; * the hardware is configured correctly.&n; */
DECL|function|eexp_hw_init586
r_static
r_void
id|eexp_hw_init586
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|net_local
op_star
id|lp
op_assign
(paren
r_struct
id|net_local
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_int
r_int
id|ioaddr
op_assign
id|dev-&gt;base_addr
suffix:semicolon
r_int
id|i
suffix:semicolon
macro_line|#if NET_DEBUG &gt; 6
id|printk
c_func
(paren
l_string|&quot;%s: eexp_hw_init586()&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
macro_line|#endif
id|lp-&gt;started
op_assign
l_int|0
suffix:semicolon
id|set_loopback
c_func
(paren
id|dev
)paren
suffix:semicolon
id|outb
c_func
(paren
id|SIRQ_dis
op_or
id|irqrmap
(braket
id|dev-&gt;irq
)braket
comma
id|ioaddr
op_plus
id|SET_IRQ
)paren
suffix:semicolon
multiline_comment|/* Download the startup code */
id|outw
c_func
(paren
id|lp-&gt;rx_buf_end
op_amp
op_complement
l_int|31
comma
id|ioaddr
op_plus
id|SM_PTR
)paren
suffix:semicolon
id|outw
c_func
(paren
id|lp-&gt;width
ques
c_cond
l_int|0x0001
suffix:colon
l_int|0x0000
comma
id|ioaddr
op_plus
l_int|0x8006
)paren
suffix:semicolon
id|outw
c_func
(paren
l_int|0x0000
comma
id|ioaddr
op_plus
l_int|0x8008
)paren
suffix:semicolon
id|outw
c_func
(paren
l_int|0x0000
comma
id|ioaddr
op_plus
l_int|0x800a
)paren
suffix:semicolon
id|outw
c_func
(paren
l_int|0x0000
comma
id|ioaddr
op_plus
l_int|0x800c
)paren
suffix:semicolon
id|outw
c_func
(paren
l_int|0x0000
comma
id|ioaddr
op_plus
l_int|0x800e
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
(paren
r_sizeof
(paren
id|start_code
)paren
)paren
suffix:semicolon
id|i
op_add_assign
l_int|32
)paren
(brace
r_int
id|j
suffix:semicolon
id|outw
c_func
(paren
id|i
comma
id|ioaddr
op_plus
id|SM_PTR
)paren
suffix:semicolon
r_for
c_loop
(paren
id|j
op_assign
l_int|0
suffix:semicolon
id|j
OL
l_int|16
suffix:semicolon
id|j
op_add_assign
l_int|2
)paren
id|outw
c_func
(paren
id|start_code
(braket
(paren
id|i
op_plus
id|j
)paren
op_div
l_int|2
)braket
comma
id|ioaddr
op_plus
l_int|0x4000
op_plus
id|j
)paren
suffix:semicolon
r_for
c_loop
(paren
id|j
op_assign
l_int|0
suffix:semicolon
id|j
OL
l_int|16
suffix:semicolon
id|j
op_add_assign
l_int|2
)paren
id|outw
c_func
(paren
id|start_code
(braket
(paren
id|i
op_plus
id|j
op_plus
l_int|16
)paren
op_div
l_int|2
)braket
comma
id|ioaddr
op_plus
l_int|0x8000
op_plus
id|j
)paren
suffix:semicolon
)brace
multiline_comment|/* Do we want promiscuous mode or multicast? */
id|outw
c_func
(paren
id|CONF_PROMISC
op_amp
op_complement
l_int|31
comma
id|ioaddr
op_plus
id|SM_PTR
)paren
suffix:semicolon
id|i
op_assign
id|inw
c_func
(paren
id|ioaddr
op_plus
id|SHADOW
c_func
(paren
id|CONF_PROMISC
)paren
)paren
suffix:semicolon
id|outw
c_func
(paren
(paren
id|dev-&gt;flags
op_amp
id|IFF_PROMISC
)paren
ques
c_cond
(paren
id|i
op_or
l_int|1
)paren
suffix:colon
(paren
id|i
op_amp
op_complement
l_int|1
)paren
comma
id|ioaddr
op_plus
id|SHADOW
c_func
(paren
id|CONF_PROMISC
)paren
)paren
suffix:semicolon
id|lp-&gt;was_promisc
op_assign
id|dev-&gt;flags
op_amp
id|IFF_PROMISC
suffix:semicolon
macro_line|#if 0
id|eexp_setup_filter
c_func
(paren
id|dev
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/* Write our hardware address */
id|outw
c_func
(paren
id|CONF_HWADDR
op_amp
op_complement
l_int|31
comma
id|ioaddr
op_plus
id|SM_PTR
)paren
suffix:semicolon
id|outw
c_func
(paren
(paren
(paren
r_int
r_int
op_star
)paren
id|dev-&gt;dev_addr
)paren
(braket
l_int|0
)braket
comma
id|ioaddr
op_plus
id|SHADOW
c_func
(paren
id|CONF_HWADDR
)paren
)paren
suffix:semicolon
id|outw
c_func
(paren
(paren
(paren
r_int
r_int
op_star
)paren
id|dev-&gt;dev_addr
)paren
(braket
l_int|1
)braket
comma
id|ioaddr
op_plus
id|SHADOW
c_func
(paren
id|CONF_HWADDR
op_plus
l_int|2
)paren
)paren
suffix:semicolon
id|outw
c_func
(paren
(paren
(paren
r_int
r_int
op_star
)paren
id|dev-&gt;dev_addr
)paren
(braket
l_int|2
)braket
comma
id|ioaddr
op_plus
id|SHADOW
c_func
(paren
id|CONF_HWADDR
op_plus
l_int|4
)paren
)paren
suffix:semicolon
id|eexp_hw_txinit
c_func
(paren
id|dev
)paren
suffix:semicolon
id|eexp_hw_rxinit
c_func
(paren
id|dev
)paren
suffix:semicolon
id|outb
c_func
(paren
l_int|0
comma
id|ioaddr
op_plus
id|EEPROM_Ctrl
)paren
suffix:semicolon
id|mdelay
c_func
(paren
l_int|5
)paren
suffix:semicolon
id|scb_command
c_func
(paren
id|dev
comma
l_int|0xf000
)paren
suffix:semicolon
id|outb
c_func
(paren
l_int|0
comma
id|ioaddr
op_plus
id|SIGNAL_CA
)paren
suffix:semicolon
id|outw
c_func
(paren
l_int|0
comma
id|ioaddr
op_plus
id|SM_PTR
)paren
suffix:semicolon
(brace
r_int
r_int
id|rboguscount
op_assign
l_int|50
comma
id|rfailcount
op_assign
l_int|5
suffix:semicolon
r_while
c_loop
(paren
id|inw
c_func
(paren
id|ioaddr
op_plus
l_int|0x4000
)paren
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
op_decrement
id|rboguscount
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: i82586 reset timed out, kicking...&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|scb_command
c_func
(paren
id|dev
comma
l_int|0
)paren
suffix:semicolon
id|outb
c_func
(paren
l_int|0
comma
id|ioaddr
op_plus
id|SIGNAL_CA
)paren
suffix:semicolon
id|rboguscount
op_assign
l_int|100
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
op_decrement
id|rfailcount
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: i82586 not responding, giving up.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
)brace
)brace
)brace
id|scb_wrcbl
c_func
(paren
id|dev
comma
id|CONF_LINK
)paren
suffix:semicolon
id|scb_command
c_func
(paren
id|dev
comma
l_int|0xf000
op_or
id|SCB_CUstart
)paren
suffix:semicolon
id|outb
c_func
(paren
l_int|0
comma
id|ioaddr
op_plus
id|SIGNAL_CA
)paren
suffix:semicolon
(brace
r_int
r_int
id|iboguscount
op_assign
l_int|50
comma
id|ifailcount
op_assign
l_int|5
suffix:semicolon
r_while
c_loop
(paren
op_logical_neg
id|scb_status
c_func
(paren
id|dev
)paren
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
op_decrement
id|iboguscount
)paren
(brace
r_if
c_cond
(paren
op_decrement
id|ifailcount
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: i82586 initialization timed out, status %04x, cmd %04x&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|scb_status
c_func
(paren
id|dev
)paren
comma
id|scb_rdcmd
c_func
(paren
id|dev
)paren
)paren
suffix:semicolon
id|scb_wrcbl
c_func
(paren
id|dev
comma
id|CONF_LINK
)paren
suffix:semicolon
id|scb_command
c_func
(paren
id|dev
comma
l_int|0xf000
op_or
id|SCB_CUstart
)paren
suffix:semicolon
id|outb
c_func
(paren
l_int|0
comma
id|ioaddr
op_plus
id|SIGNAL_CA
)paren
suffix:semicolon
id|iboguscount
op_assign
l_int|100
suffix:semicolon
)brace
r_else
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: Failed to initialize i82586, giving up.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
)brace
)brace
)brace
id|clear_loopback
c_func
(paren
id|dev
)paren
suffix:semicolon
id|outb
c_func
(paren
id|SIRQ_en
op_or
id|irqrmap
(braket
id|dev-&gt;irq
)braket
comma
id|ioaddr
op_plus
id|SET_IRQ
)paren
suffix:semicolon
id|lp-&gt;init_time
op_assign
id|jiffies
suffix:semicolon
macro_line|#if NET_DEBUG &gt; 6
id|printk
c_func
(paren
l_string|&quot;%s: leaving eexp_hw_init586()&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
macro_line|#endif
r_return
suffix:semicolon
)brace
DECL|function|eexp_setup_filter
r_static
r_void
id|eexp_setup_filter
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|dev_mc_list
op_star
id|dmi
op_assign
id|dev-&gt;mc_list
suffix:semicolon
r_int
r_int
id|ioaddr
op_assign
id|dev-&gt;base_addr
suffix:semicolon
r_int
id|count
op_assign
id|dev-&gt;mc_count
suffix:semicolon
r_int
id|i
suffix:semicolon
r_if
c_cond
(paren
id|count
OG
l_int|8
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: too many multicast addresses (%d)&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|count
)paren
suffix:semicolon
id|count
op_assign
l_int|8
suffix:semicolon
)brace
id|outw
c_func
(paren
id|CONF_NR_MULTICAST
op_amp
op_complement
l_int|31
comma
id|ioaddr
op_plus
id|SM_PTR
)paren
suffix:semicolon
id|outw
c_func
(paren
id|count
comma
id|ioaddr
op_plus
id|SHADOW
c_func
(paren
id|CONF_NR_MULTICAST
)paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|count
suffix:semicolon
id|i
op_increment
)paren
(brace
r_int
r_int
op_star
id|data
op_assign
(paren
r_int
r_int
op_star
)paren
id|dmi-&gt;dmi_addr
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dmi
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: too few multicast addresses&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|dmi-&gt;dmi_addrlen
op_ne
id|ETH_ALEN
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: invalid multicast address length given.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
id|outw
c_func
(paren
(paren
id|CONF_MULTICAST
op_plus
(paren
l_int|6
op_star
id|i
)paren
)paren
op_amp
op_complement
l_int|31
comma
id|ioaddr
op_plus
id|SM_PTR
)paren
suffix:semicolon
id|outw
c_func
(paren
id|data
(braket
l_int|0
)braket
comma
id|ioaddr
op_plus
id|SHADOW
c_func
(paren
id|CONF_MULTICAST
op_plus
(paren
l_int|6
op_star
id|i
)paren
)paren
)paren
suffix:semicolon
id|outw
c_func
(paren
(paren
id|CONF_MULTICAST
op_plus
(paren
l_int|6
op_star
id|i
)paren
op_plus
l_int|2
)paren
op_amp
op_complement
l_int|31
comma
id|ioaddr
op_plus
id|SM_PTR
)paren
suffix:semicolon
id|outw
c_func
(paren
id|data
(braket
l_int|1
)braket
comma
id|ioaddr
op_plus
id|SHADOW
c_func
(paren
id|CONF_MULTICAST
op_plus
(paren
l_int|6
op_star
id|i
)paren
op_plus
l_int|2
)paren
)paren
suffix:semicolon
id|outw
c_func
(paren
(paren
id|CONF_MULTICAST
op_plus
(paren
l_int|6
op_star
id|i
)paren
op_plus
l_int|4
)paren
op_amp
op_complement
l_int|31
comma
id|ioaddr
op_plus
id|SM_PTR
)paren
suffix:semicolon
id|outw
c_func
(paren
id|data
(braket
l_int|2
)braket
comma
id|ioaddr
op_plus
id|SHADOW
c_func
(paren
id|CONF_MULTICAST
op_plus
(paren
l_int|6
op_star
id|i
)paren
op_plus
l_int|4
)paren
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/*&n; * Set or clear the multicast filter for this adaptor.&n; */
r_static
r_void
DECL|function|eexp_set_multicast
id|eexp_set_multicast
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_int
r_int
id|ioaddr
op_assign
id|dev-&gt;base_addr
suffix:semicolon
r_struct
id|net_local
op_star
id|lp
op_assign
(paren
r_struct
id|net_local
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_int
id|kick
op_assign
l_int|0
comma
id|i
suffix:semicolon
r_if
c_cond
(paren
(paren
id|dev-&gt;flags
op_amp
id|IFF_PROMISC
)paren
op_ne
id|lp-&gt;was_promisc
)paren
(brace
id|outw
c_func
(paren
id|CONF_PROMISC
op_amp
op_complement
l_int|31
comma
id|ioaddr
op_plus
id|SM_PTR
)paren
suffix:semicolon
id|i
op_assign
id|inw
c_func
(paren
id|ioaddr
op_plus
id|SHADOW
c_func
(paren
id|CONF_PROMISC
)paren
)paren
suffix:semicolon
id|outw
c_func
(paren
(paren
id|dev-&gt;flags
op_amp
id|IFF_PROMISC
)paren
ques
c_cond
(paren
id|i
op_or
l_int|1
)paren
suffix:colon
(paren
id|i
op_amp
op_complement
l_int|1
)paren
comma
id|ioaddr
op_plus
id|SHADOW
c_func
(paren
id|CONF_PROMISC
)paren
)paren
suffix:semicolon
id|lp-&gt;was_promisc
op_assign
id|dev-&gt;flags
op_amp
id|IFF_PROMISC
suffix:semicolon
id|kick
op_assign
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|dev-&gt;flags
op_amp
id|IFF_PROMISC
)paren
)paren
(brace
id|eexp_setup_filter
c_func
(paren
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|lp-&gt;old_mc_count
op_ne
id|dev-&gt;mc_count
)paren
(brace
id|kick
op_assign
l_int|1
suffix:semicolon
id|lp-&gt;old_mc_count
op_assign
id|dev-&gt;mc_count
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|kick
)paren
(brace
r_int
r_int
id|oj
suffix:semicolon
id|scb_command
c_func
(paren
id|dev
comma
id|SCB_CUsuspend
)paren
suffix:semicolon
id|outb
c_func
(paren
l_int|0
comma
id|ioaddr
op_plus
id|SIGNAL_CA
)paren
suffix:semicolon
id|outb
c_func
(paren
l_int|0
comma
id|ioaddr
op_plus
id|SIGNAL_CA
)paren
suffix:semicolon
macro_line|#if 0
id|printk
c_func
(paren
l_string|&quot;%s: waiting for CU to go suspended&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
macro_line|#endif
id|oj
op_assign
id|jiffies
suffix:semicolon
r_while
c_loop
(paren
(paren
id|SCB_CUstat
c_func
(paren
id|scb_status
c_func
(paren
id|dev
)paren
)paren
op_eq
l_int|2
)paren
op_logical_and
(paren
(paren
id|jiffies
op_minus
id|oj
)paren
OL
l_int|2000
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|SCB_CUstat
c_func
(paren
id|scb_status
c_func
(paren
id|dev
)paren
)paren
op_eq
l_int|2
)paren
id|printk
c_func
(paren
l_string|&quot;%s: warning, CU didn&squot;t stop&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|lp-&gt;started
op_and_assign
op_complement
(paren
id|STARTED_CU
)paren
suffix:semicolon
id|scb_wrcbl
c_func
(paren
id|dev
comma
id|CONF_LINK
)paren
suffix:semicolon
id|scb_command
c_func
(paren
id|dev
comma
id|SCB_CUstart
)paren
suffix:semicolon
id|outb
c_func
(paren
l_int|0
comma
id|ioaddr
op_plus
id|SIGNAL_CA
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/*&n; * MODULE stuff&n; */
macro_line|#ifdef MODULE
DECL|macro|EEXP_MAX_CARDS
mdefine_line|#define EEXP_MAX_CARDS     4    /* max number of cards to support */
DECL|variable|dev_eexp
r_static
r_struct
id|net_device
id|dev_eexp
(braket
id|EEXP_MAX_CARDS
)braket
suffix:semicolon
DECL|variable|irq
r_static
r_int
id|irq
(braket
id|EEXP_MAX_CARDS
)braket
suffix:semicolon
DECL|variable|io
r_static
r_int
id|io
(braket
id|EEXP_MAX_CARDS
)braket
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|io
comma
l_string|&quot;1-&quot;
id|__MODULE_STRING
c_func
(paren
id|EEXP_MAX_CARDS
)paren
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|irq
comma
l_string|&quot;1-&quot;
id|__MODULE_STRING
c_func
(paren
id|EEXP_MAX_CARDS
)paren
l_string|&quot;i&quot;
)paren
suffix:semicolon
multiline_comment|/* Ideally the user would give us io=, irq= for every card.  If any parameters&n; * are specified, we verify and then use them.  If no parameters are given, we&n; * autoprobe for one card only.&n; */
DECL|function|init_module
r_int
id|init_module
c_func
(paren
r_void
)paren
(brace
r_int
id|this_dev
comma
id|found
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|this_dev
op_assign
l_int|0
suffix:semicolon
id|this_dev
OL
id|EEXP_MAX_CARDS
suffix:semicolon
id|this_dev
op_increment
)paren
(brace
r_struct
id|net_device
op_star
id|dev
op_assign
op_amp
id|dev_eexp
(braket
id|this_dev
)braket
suffix:semicolon
id|dev-&gt;irq
op_assign
id|irq
(braket
id|this_dev
)braket
suffix:semicolon
id|dev-&gt;base_addr
op_assign
id|io
(braket
id|this_dev
)braket
suffix:semicolon
id|dev-&gt;init
op_assign
id|express_probe
suffix:semicolon
r_if
c_cond
(paren
id|io
(braket
id|this_dev
)braket
op_eq
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|this_dev
)paren
r_break
suffix:semicolon
id|printk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;eexpress.c: Module autoprobe not recommended, give io=xx.&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|register_netdev
c_func
(paren
id|dev
)paren
op_ne
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;eexpress.c: Failed to register card at 0x%x.&bslash;n&quot;
comma
id|io
(braket
id|this_dev
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
id|found
op_ne
l_int|0
)paren
r_return
l_int|0
suffix:semicolon
r_return
op_minus
id|ENXIO
suffix:semicolon
)brace
id|found
op_increment
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|cleanup_module
r_void
id|cleanup_module
c_func
(paren
r_void
)paren
(brace
r_int
id|this_dev
suffix:semicolon
r_for
c_loop
(paren
id|this_dev
op_assign
l_int|0
suffix:semicolon
id|this_dev
OL
id|EEXP_MAX_CARDS
suffix:semicolon
id|this_dev
op_increment
)paren
(brace
r_struct
id|net_device
op_star
id|dev
op_assign
op_amp
id|dev_eexp
(braket
id|this_dev
)braket
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;priv
op_ne
l_int|NULL
)paren
(brace
id|unregister_netdev
c_func
(paren
id|dev
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|dev-&gt;priv
)paren
suffix:semicolon
id|dev-&gt;priv
op_assign
l_int|NULL
suffix:semicolon
id|release_region
c_func
(paren
id|dev-&gt;base_addr
comma
id|EEXP_IO_EXTENT
)paren
suffix:semicolon
)brace
)brace
)brace
macro_line|#endif
multiline_comment|/*&n; * Local Variables:&n; *  c-file-style: &quot;linux&quot;&n; *  tab-width: 8&n; * End:&n; */
eof
