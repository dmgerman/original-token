multiline_comment|/*&n; *  Amiga Linux/m68k Ariadne Ethernet Driver&n; *&n; *  &#xfffd; Copyright 1995 by Geert Uytterhoeven (geert@linux-m68k.org)&n; *&t;&t;&t;Peter De Schrijver&n; *&t;&t;       (Peter.DeSchrijver@linux.cc.kuleuven.ac.be)&n; *&n; *  ---------------------------------------------------------------------------&n; *&n; *  This program is based on&n; *&n; *&t;lance.c:&t;An AMD LANCE ethernet driver for linux.&n; *&t;&t;&t;Written 1993-94 by Donald Becker.&n; *&n; *&t;Am79C960:&t;PCnet(tm)-ISA Single-Chip Ethernet Controller&n; *&t;&t;&t;Advanced Micro Devices&n; *&t;&t;&t;Publication #16907, Rev. B, Amendment/0, May 1994&n; *&n; *&t;MC68230:&t;Parallel Interface/Timer (PI/T)&n; *&t;&t;&t;Motorola Semiconductors, December, 1983&n; *&n; *  ---------------------------------------------------------------------------&n; *&n; *  This file is subject to the terms and conditions of the GNU General Public&n; *  License.  See the file COPYING in the main directory of the Linux&n; *  distribution for more details.&n; *&n; *  ---------------------------------------------------------------------------&n; *&n; *  The Ariadne is a Zorro-II board made by Village Tronic. It contains:&n; *&n; *&t;- an Am79C960 PCnet-ISA Single-Chip Ethernet Controller with both&n; *&t;  10BASE-2 (thin coax) and 10BASE-T (UTP) connectors&n; *&n; *&t;- an MC68230 Parallel Interface/Timer configured as 2 parallel ports&n; */
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/stddef.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/ptrace.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/ioport.h&gt;
macro_line|#include &lt;linux/malloc.h&gt;
macro_line|#include &lt;linux/netdevice.h&gt;
macro_line|#include &lt;linux/etherdevice.h&gt;
macro_line|#include &lt;linux/interrupt.h&gt;
macro_line|#include &lt;linux/skbuff.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;asm/bitops.h&gt;
macro_line|#include &lt;asm/amigaints.h&gt;
macro_line|#include &lt;asm/amigahw.h&gt;
macro_line|#include &lt;linux/zorro.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/irq.h&gt;
macro_line|#include &quot;ariadne.h&quot;
macro_line|#ifdef ARIADNE_DEBUG
DECL|variable|ariadne_debug
r_int
id|ariadne_debug
op_assign
id|ARIADNE_DEBUG
suffix:semicolon
macro_line|#else
DECL|variable|ariadne_debug
r_int
id|ariadne_debug
op_assign
l_int|1
suffix:semicolon
macro_line|#endif
multiline_comment|/*&n;     *&t;Macros to Fix Endianness problems&n;     */
multiline_comment|/* Swap the Bytes in a WORD */
DECL|macro|swapw
mdefine_line|#define swapw(x)&t;(((x&gt;&gt;8)&amp;0x00ff)|((x&lt;&lt;8)&amp;0xff00))
multiline_comment|/* Get the Low BYTE in a WORD */
DECL|macro|lowb
mdefine_line|#define lowb(x)&t;&t;(x&amp;0xff)
multiline_comment|/* Get the Swapped High WORD in a LONG */
DECL|macro|swhighw
mdefine_line|#define swhighw(x)&t;((((x)&gt;&gt;8)&amp;0xff00)|(((x)&gt;&gt;24)&amp;0x00ff))
multiline_comment|/* Get the Swapped Low WORD in a LONG */
DECL|macro|swloww
mdefine_line|#define swloww(x)&t;((((x)&lt;&lt;8)&amp;0xff00)|(((x)&gt;&gt;8)&amp;0x00ff))
multiline_comment|/*&n;     *&t;Transmit/Receive Ring Definitions&n;     */
DECL|macro|TX_RING_SIZE
mdefine_line|#define TX_RING_SIZE&t;5
DECL|macro|RX_RING_SIZE
mdefine_line|#define RX_RING_SIZE&t;16
DECL|macro|PKT_BUF_SIZE
mdefine_line|#define PKT_BUF_SIZE&t;1520
multiline_comment|/*&n;     *&t;Private Device Data&n;     */
DECL|struct|ariadne_private
r_struct
id|ariadne_private
(brace
DECL|member|tx_ring
r_volatile
r_struct
id|TDRE
op_star
id|tx_ring
(braket
id|TX_RING_SIZE
)braket
suffix:semicolon
DECL|member|rx_ring
r_volatile
r_struct
id|RDRE
op_star
id|rx_ring
(braket
id|RX_RING_SIZE
)braket
suffix:semicolon
DECL|member|tx_buff
r_volatile
id|u_short
op_star
id|tx_buff
(braket
id|TX_RING_SIZE
)braket
suffix:semicolon
DECL|member|rx_buff
r_volatile
id|u_short
op_star
id|rx_buff
(braket
id|RX_RING_SIZE
)braket
suffix:semicolon
DECL|member|cur_tx
DECL|member|cur_rx
r_int
id|cur_tx
comma
id|cur_rx
suffix:semicolon
multiline_comment|/* The next free ring entry */
DECL|member|dirty_tx
r_int
id|dirty_tx
suffix:semicolon
multiline_comment|/* The ring entries to be free()ed. */
DECL|member|stats
r_struct
id|net_device_stats
id|stats
suffix:semicolon
DECL|member|tx_full
r_char
id|tx_full
suffix:semicolon
DECL|member|dev
r_struct
id|net_device
op_star
id|dev
suffix:semicolon
multiline_comment|/* Backpointer */
DECL|member|next_module
r_struct
id|ariadne_private
op_star
id|next_module
suffix:semicolon
)brace
suffix:semicolon
multiline_comment|/*&n;     *&t;Structure Created in the Ariadne&squot;s RAM Buffer&n;     */
DECL|struct|lancedata
r_struct
id|lancedata
(brace
DECL|member|tx_ring
r_struct
id|TDRE
id|tx_ring
(braket
id|TX_RING_SIZE
)braket
suffix:semicolon
DECL|member|rx_ring
r_struct
id|RDRE
id|rx_ring
(braket
id|RX_RING_SIZE
)braket
suffix:semicolon
DECL|member|tx_buff
id|u_short
id|tx_buff
(braket
id|TX_RING_SIZE
)braket
(braket
id|PKT_BUF_SIZE
op_div
r_sizeof
(paren
id|u_short
)paren
)braket
suffix:semicolon
DECL|member|rx_buff
id|u_short
id|rx_buff
(braket
id|RX_RING_SIZE
)braket
(braket
id|PKT_BUF_SIZE
op_div
r_sizeof
(paren
id|u_short
)paren
)braket
suffix:semicolon
)brace
suffix:semicolon
macro_line|#ifdef MODULE
DECL|variable|root_ariadne_dev
r_static
r_struct
id|ariadne_private
op_star
id|root_ariadne_dev
op_assign
l_int|NULL
suffix:semicolon
macro_line|#endif
r_static
r_int
id|ariadne_open
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_void
id|ariadne_init_ring
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_int
id|ariadne_start_xmit
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_void
id|ariadne_tx_timeout
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_int
id|ariadne_rx
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_void
id|ariadne_reset
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_void
id|ariadne_interrupt
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|data
comma
r_struct
id|pt_regs
op_star
id|fp
)paren
suffix:semicolon
r_static
r_int
id|ariadne_close
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_struct
id|net_device_stats
op_star
id|ariadne_get_stats
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
macro_line|#ifdef HAVE_MULTICAST
r_static
r_void
id|set_multicast_list
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
macro_line|#endif
DECL|function|memcpyw
r_static
r_void
id|memcpyw
c_func
(paren
r_volatile
id|u_short
op_star
id|dest
comma
id|u_short
op_star
id|src
comma
r_int
id|len
)paren
(brace
r_while
c_loop
(paren
id|len
op_ge
l_int|2
)paren
(brace
op_star
(paren
id|dest
op_increment
)paren
op_assign
op_star
(paren
id|src
op_increment
)paren
suffix:semicolon
id|len
op_sub_assign
l_int|2
suffix:semicolon
)brace
r_if
c_cond
(paren
id|len
op_eq
l_int|1
)paren
op_star
id|dest
op_assign
(paren
op_star
(paren
id|u_char
op_star
)paren
id|src
)paren
op_lshift
l_int|8
suffix:semicolon
)brace
DECL|function|ariadne_probe
r_static
r_int
id|__init
id|ariadne_probe
c_func
(paren
r_void
)paren
(brace
r_struct
id|zorro_dev
op_star
id|z
op_assign
l_int|NULL
suffix:semicolon
r_struct
id|net_device
op_star
id|dev
suffix:semicolon
r_struct
id|ariadne_private
op_star
id|priv
suffix:semicolon
r_int
id|res
op_assign
op_minus
id|ENODEV
suffix:semicolon
r_while
c_loop
(paren
(paren
id|z
op_assign
id|zorro_find_device
c_func
(paren
id|ZORRO_PROD_VILLAGE_TRONIC_ARIADNE
comma
id|z
)paren
)paren
)paren
(brace
r_int
r_int
id|board
op_assign
id|z-&gt;resource.start
suffix:semicolon
r_int
r_int
id|base_addr
op_assign
id|board
op_plus
id|ARIADNE_LANCE
suffix:semicolon
r_int
r_int
id|mem_start
op_assign
id|board
op_plus
id|ARIADNE_RAM
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|request_mem_region
c_func
(paren
id|base_addr
comma
r_sizeof
(paren
r_struct
id|Am79C960
)paren
comma
l_string|&quot;Am79C960&quot;
)paren
)paren
r_continue
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|request_mem_region
c_func
(paren
id|mem_start
comma
id|ARIADNE_RAM_SIZE
comma
l_string|&quot;RAM&quot;
)paren
)paren
(brace
id|release_mem_region
c_func
(paren
id|base_addr
comma
r_sizeof
(paren
r_struct
id|Am79C960
)paren
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
id|dev
op_assign
id|init_etherdev
c_func
(paren
l_int|NULL
comma
r_sizeof
(paren
r_struct
id|ariadne_private
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dev
op_eq
l_int|NULL
)paren
(brace
id|release_mem_region
c_func
(paren
id|base_addr
comma
r_sizeof
(paren
r_struct
id|Am79C960
)paren
)paren
suffix:semicolon
id|release_mem_region
c_func
(paren
id|mem_start
comma
id|ARIADNE_RAM_SIZE
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|priv
op_assign
(paren
r_struct
id|ariadne_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|memset
c_func
(paren
id|priv
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|ariadne_private
)paren
)paren
suffix:semicolon
id|priv-&gt;dev
op_assign
id|dev
suffix:semicolon
id|dev-&gt;dev_addr
(braket
l_int|0
)braket
op_assign
l_int|0x00
suffix:semicolon
id|dev-&gt;dev_addr
(braket
l_int|1
)braket
op_assign
l_int|0x60
suffix:semicolon
id|dev-&gt;dev_addr
(braket
l_int|2
)braket
op_assign
l_int|0x30
suffix:semicolon
id|dev-&gt;dev_addr
(braket
l_int|3
)braket
op_assign
(paren
id|z-&gt;rom.er_SerialNumber
op_rshift
l_int|16
)paren
op_amp
l_int|0xff
suffix:semicolon
id|dev-&gt;dev_addr
(braket
l_int|4
)braket
op_assign
(paren
id|z-&gt;rom.er_SerialNumber
op_rshift
l_int|8
)paren
op_amp
l_int|0xff
suffix:semicolon
id|dev-&gt;dev_addr
(braket
l_int|5
)braket
op_assign
id|z-&gt;rom.er_SerialNumber
op_amp
l_int|0xff
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;%s: Ariadne at 0x%08lx, Ethernet Address &quot;
l_string|&quot;%02x:%02x:%02x:%02x:%02x:%02x&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|board
comma
id|dev-&gt;dev_addr
(braket
l_int|0
)braket
comma
id|dev-&gt;dev_addr
(braket
l_int|1
)braket
comma
id|dev-&gt;dev_addr
(braket
l_int|2
)braket
comma
id|dev-&gt;dev_addr
(braket
l_int|3
)braket
comma
id|dev-&gt;dev_addr
(braket
l_int|4
)braket
comma
id|dev-&gt;dev_addr
(braket
l_int|5
)braket
)paren
suffix:semicolon
id|dev-&gt;base_addr
op_assign
id|ZTWO_VADDR
c_func
(paren
id|base_addr
)paren
suffix:semicolon
id|dev-&gt;mem_start
op_assign
id|ZTWO_VADDR
c_func
(paren
id|mem_start
)paren
suffix:semicolon
id|dev-&gt;mem_end
op_assign
id|dev-&gt;mem_start
op_plus
id|ARIADNE_RAM_SIZE
suffix:semicolon
id|dev-&gt;open
op_assign
op_amp
id|ariadne_open
suffix:semicolon
id|dev-&gt;stop
op_assign
op_amp
id|ariadne_close
suffix:semicolon
id|dev-&gt;hard_start_xmit
op_assign
op_amp
id|ariadne_start_xmit
suffix:semicolon
id|dev-&gt;tx_timeout
op_assign
op_amp
id|ariadne_tx_timeout
suffix:semicolon
id|dev-&gt;watchdog_timeo
op_assign
l_int|5
op_star
id|HZ
suffix:semicolon
id|dev-&gt;get_stats
op_assign
op_amp
id|ariadne_get_stats
suffix:semicolon
id|dev-&gt;set_multicast_list
op_assign
op_amp
id|set_multicast_list
suffix:semicolon
macro_line|#ifdef MODULE
id|priv-&gt;next_module
op_assign
id|root_ariadne_dev
suffix:semicolon
id|root_ariadne_dev
op_assign
id|priv
suffix:semicolon
macro_line|#endif
id|res
op_assign
l_int|0
suffix:semicolon
)brace
r_return
id|res
suffix:semicolon
)brace
DECL|function|ariadne_open
r_static
r_int
id|ariadne_open
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_volatile
r_struct
id|Am79C960
op_star
id|lance
op_assign
(paren
r_struct
id|Am79C960
op_star
)paren
id|dev-&gt;base_addr
suffix:semicolon
id|u_short
id|in
suffix:semicolon
id|u_long
id|version
suffix:semicolon
multiline_comment|/* Reset the LANCE */
id|in
op_assign
id|lance-&gt;Reset
suffix:semicolon
multiline_comment|/* Stop the LANCE */
id|lance-&gt;RAP
op_assign
id|CSR0
suffix:semicolon
multiline_comment|/* PCnet-ISA Controller Status */
id|lance-&gt;RDP
op_assign
id|STOP
suffix:semicolon
multiline_comment|/* Check the LANCE version */
id|lance-&gt;RAP
op_assign
id|CSR88
suffix:semicolon
multiline_comment|/* Chip ID */
id|version
op_assign
id|swapw
c_func
(paren
id|lance-&gt;RDP
)paren
suffix:semicolon
id|lance-&gt;RAP
op_assign
id|CSR89
suffix:semicolon
multiline_comment|/* Chip ID */
id|version
op_or_assign
id|swapw
c_func
(paren
id|lance-&gt;RDP
)paren
op_lshift
l_int|16
suffix:semicolon
r_if
c_cond
(paren
(paren
id|version
op_amp
l_int|0x00000fff
)paren
op_ne
l_int|0x00000003
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;ariadne_open: Couldn&squot;t find AMD Ethernet Chip&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EAGAIN
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|version
op_amp
l_int|0x0ffff000
)paren
op_ne
l_int|0x00003000
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;ariadne_open: Couldn&squot;t find Am79C960 (Wrong part number = %ld)&bslash;n&quot;
comma
(paren
id|version
op_amp
l_int|0x0ffff000
)paren
op_rshift
l_int|12
)paren
suffix:semicolon
r_return
op_minus
id|EAGAIN
suffix:semicolon
)brace
macro_line|#if 0
id|printk
c_func
(paren
l_string|&quot;ariadne_open: Am79C960 (PCnet-ISA) Revision %ld&bslash;n&quot;
comma
(paren
id|version
op_amp
l_int|0xf0000000
)paren
op_rshift
l_int|28
)paren
suffix:semicolon
macro_line|#endif
id|ariadne_init_ring
c_func
(paren
id|dev
)paren
suffix:semicolon
multiline_comment|/* Miscellaneous Stuff */
id|lance-&gt;RAP
op_assign
id|CSR3
suffix:semicolon
multiline_comment|/* Interrupt Masks and Deferral Control */
id|lance-&gt;RDP
op_assign
l_int|0x0000
suffix:semicolon
id|lance-&gt;RAP
op_assign
id|CSR4
suffix:semicolon
multiline_comment|/* Test and Features Control */
id|lance-&gt;RDP
op_assign
id|DPOLL
op_or
id|APAD_XMT
op_or
id|MFCOM
op_or
id|RCVCCOM
op_or
id|TXSTRTM
op_or
id|JABM
suffix:semicolon
multiline_comment|/* Set the Multicast Table */
id|lance-&gt;RAP
op_assign
id|CSR8
suffix:semicolon
multiline_comment|/* Logical Address Filter, LADRF[15:0] */
id|lance-&gt;RDP
op_assign
l_int|0x0000
suffix:semicolon
id|lance-&gt;RAP
op_assign
id|CSR9
suffix:semicolon
multiline_comment|/* Logical Address Filter, LADRF[31:16] */
id|lance-&gt;RDP
op_assign
l_int|0x0000
suffix:semicolon
id|lance-&gt;RAP
op_assign
id|CSR10
suffix:semicolon
multiline_comment|/* Logical Address Filter, LADRF[47:32] */
id|lance-&gt;RDP
op_assign
l_int|0x0000
suffix:semicolon
id|lance-&gt;RAP
op_assign
id|CSR11
suffix:semicolon
multiline_comment|/* Logical Address Filter, LADRF[63:48] */
id|lance-&gt;RDP
op_assign
l_int|0x0000
suffix:semicolon
multiline_comment|/* Set the Ethernet Hardware Address */
id|lance-&gt;RAP
op_assign
id|CSR12
suffix:semicolon
multiline_comment|/* Physical Address Register, PADR[15:0] */
id|lance-&gt;RDP
op_assign
(paren
(paren
id|u_short
op_star
)paren
op_amp
id|dev-&gt;dev_addr
(braket
l_int|0
)braket
)paren
(braket
l_int|0
)braket
suffix:semicolon
id|lance-&gt;RAP
op_assign
id|CSR13
suffix:semicolon
multiline_comment|/* Physical Address Register, PADR[31:16] */
id|lance-&gt;RDP
op_assign
(paren
(paren
id|u_short
op_star
)paren
op_amp
id|dev-&gt;dev_addr
(braket
l_int|0
)braket
)paren
(braket
l_int|1
)braket
suffix:semicolon
id|lance-&gt;RAP
op_assign
id|CSR14
suffix:semicolon
multiline_comment|/* Physical Address Register, PADR[47:32] */
id|lance-&gt;RDP
op_assign
(paren
(paren
id|u_short
op_star
)paren
op_amp
id|dev-&gt;dev_addr
(braket
l_int|0
)braket
)paren
(braket
l_int|2
)braket
suffix:semicolon
multiline_comment|/* Set the Init Block Mode */
id|lance-&gt;RAP
op_assign
id|CSR15
suffix:semicolon
multiline_comment|/* Mode Register */
id|lance-&gt;RDP
op_assign
l_int|0x0000
suffix:semicolon
multiline_comment|/* Set the Transmit Descriptor Ring Pointer */
id|lance-&gt;RAP
op_assign
id|CSR30
suffix:semicolon
multiline_comment|/* Base Address of Transmit Ring */
id|lance-&gt;RDP
op_assign
id|swloww
c_func
(paren
id|ARIADNE_RAM
op_plus
m_offsetof
(paren
r_struct
id|lancedata
comma
id|tx_ring
)paren
)paren
suffix:semicolon
id|lance-&gt;RAP
op_assign
id|CSR31
suffix:semicolon
multiline_comment|/* Base Address of transmit Ring */
id|lance-&gt;RDP
op_assign
id|swhighw
c_func
(paren
id|ARIADNE_RAM
op_plus
m_offsetof
(paren
r_struct
id|lancedata
comma
id|tx_ring
)paren
)paren
suffix:semicolon
multiline_comment|/* Set the Receive Descriptor Ring Pointer */
id|lance-&gt;RAP
op_assign
id|CSR24
suffix:semicolon
multiline_comment|/* Base Address of Receive Ring */
id|lance-&gt;RDP
op_assign
id|swloww
c_func
(paren
id|ARIADNE_RAM
op_plus
m_offsetof
(paren
r_struct
id|lancedata
comma
id|rx_ring
)paren
)paren
suffix:semicolon
id|lance-&gt;RAP
op_assign
id|CSR25
suffix:semicolon
multiline_comment|/* Base Address of Receive Ring */
id|lance-&gt;RDP
op_assign
id|swhighw
c_func
(paren
id|ARIADNE_RAM
op_plus
m_offsetof
(paren
r_struct
id|lancedata
comma
id|rx_ring
)paren
)paren
suffix:semicolon
multiline_comment|/* Set the Number of RX and TX Ring Entries */
id|lance-&gt;RAP
op_assign
id|CSR76
suffix:semicolon
multiline_comment|/* Receive Ring Length */
id|lance-&gt;RDP
op_assign
id|swapw
c_func
(paren
(paren
(paren
id|u_short
)paren
op_minus
id|RX_RING_SIZE
)paren
)paren
suffix:semicolon
id|lance-&gt;RAP
op_assign
id|CSR78
suffix:semicolon
multiline_comment|/* Transmit Ring Length */
id|lance-&gt;RDP
op_assign
id|swapw
c_func
(paren
(paren
(paren
id|u_short
)paren
op_minus
id|TX_RING_SIZE
)paren
)paren
suffix:semicolon
multiline_comment|/* Enable Media Interface Port Auto Select (10BASE-2/10BASE-T) */
id|lance-&gt;RAP
op_assign
id|ISACSR2
suffix:semicolon
multiline_comment|/* Miscellaneous Configuration */
id|lance-&gt;IDP
op_assign
id|ASEL
suffix:semicolon
multiline_comment|/* LED Control */
id|lance-&gt;RAP
op_assign
id|ISACSR5
suffix:semicolon
multiline_comment|/* LED1 Status */
id|lance-&gt;IDP
op_assign
id|PSE
op_or
id|XMTE
suffix:semicolon
id|lance-&gt;RAP
op_assign
id|ISACSR6
suffix:semicolon
multiline_comment|/* LED2 Status */
id|lance-&gt;IDP
op_assign
id|PSE
op_or
id|COLE
suffix:semicolon
id|lance-&gt;RAP
op_assign
id|ISACSR7
suffix:semicolon
multiline_comment|/* LED3 Status */
id|lance-&gt;IDP
op_assign
id|PSE
op_or
id|RCVE
suffix:semicolon
id|netif_start_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|request_irq
c_func
(paren
id|IRQ_AMIGA_PORTS
comma
id|ariadne_interrupt
comma
id|SA_SHIRQ
comma
l_string|&quot;Ariadne Ethernet&quot;
comma
id|dev
)paren
)paren
r_return
op_minus
id|EAGAIN
suffix:semicolon
id|lance-&gt;RAP
op_assign
id|CSR0
suffix:semicolon
multiline_comment|/* PCnet-ISA Controller Status */
id|lance-&gt;RDP
op_assign
id|INEA
op_or
id|STRT
suffix:semicolon
id|MOD_INC_USE_COUNT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|ariadne_init_ring
r_static
r_void
id|ariadne_init_ring
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|ariadne_private
op_star
id|priv
op_assign
(paren
r_struct
id|ariadne_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_volatile
r_struct
id|lancedata
op_star
id|lancedata
op_assign
(paren
r_struct
id|lancedata
op_star
)paren
id|dev-&gt;mem_start
suffix:semicolon
r_int
id|i
suffix:semicolon
id|netif_stop_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
id|priv-&gt;tx_full
op_assign
l_int|0
suffix:semicolon
id|priv-&gt;cur_rx
op_assign
id|priv-&gt;cur_tx
op_assign
l_int|0
suffix:semicolon
id|priv-&gt;dirty_tx
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Set up TX Ring */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|TX_RING_SIZE
suffix:semicolon
id|i
op_increment
)paren
(brace
r_volatile
r_struct
id|TDRE
op_star
id|t
op_assign
op_amp
id|lancedata-&gt;tx_ring
(braket
id|i
)braket
suffix:semicolon
id|t-&gt;TMD0
op_assign
id|swloww
c_func
(paren
id|ARIADNE_RAM
op_plus
m_offsetof
(paren
r_struct
id|lancedata
comma
id|tx_buff
(braket
id|i
)braket
)paren
)paren
suffix:semicolon
id|t-&gt;TMD1
op_assign
id|swhighw
c_func
(paren
id|ARIADNE_RAM
op_plus
m_offsetof
(paren
r_struct
id|lancedata
comma
id|tx_buff
(braket
id|i
)braket
)paren
)paren
op_or
id|TF_STP
op_or
id|TF_ENP
suffix:semicolon
id|t-&gt;TMD2
op_assign
id|swapw
c_func
(paren
(paren
id|u_short
)paren
op_minus
id|PKT_BUF_SIZE
)paren
suffix:semicolon
id|t-&gt;TMD3
op_assign
l_int|0
suffix:semicolon
id|priv-&gt;tx_ring
(braket
id|i
)braket
op_assign
op_amp
id|lancedata-&gt;tx_ring
(braket
id|i
)braket
suffix:semicolon
id|priv-&gt;tx_buff
(braket
id|i
)braket
op_assign
id|lancedata-&gt;tx_buff
(braket
id|i
)braket
suffix:semicolon
macro_line|#if 0
id|printk
c_func
(paren
l_string|&quot;TX Entry %2d at %p, Buf at %p&bslash;n&quot;
comma
id|i
comma
op_amp
id|lancedata-&gt;tx_ring
(braket
id|i
)braket
comma
id|lancedata-&gt;tx_buff
(braket
id|i
)braket
)paren
suffix:semicolon
macro_line|#endif
)brace
multiline_comment|/* Set up RX Ring */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|RX_RING_SIZE
suffix:semicolon
id|i
op_increment
)paren
(brace
r_volatile
r_struct
id|RDRE
op_star
id|r
op_assign
op_amp
id|lancedata-&gt;rx_ring
(braket
id|i
)braket
suffix:semicolon
id|r-&gt;RMD0
op_assign
id|swloww
c_func
(paren
id|ARIADNE_RAM
op_plus
m_offsetof
(paren
r_struct
id|lancedata
comma
id|rx_buff
(braket
id|i
)braket
)paren
)paren
suffix:semicolon
id|r-&gt;RMD1
op_assign
id|swhighw
c_func
(paren
id|ARIADNE_RAM
op_plus
m_offsetof
(paren
r_struct
id|lancedata
comma
id|rx_buff
(braket
id|i
)braket
)paren
)paren
op_or
id|RF_OWN
suffix:semicolon
id|r-&gt;RMD2
op_assign
id|swapw
c_func
(paren
(paren
id|u_short
)paren
op_minus
id|PKT_BUF_SIZE
)paren
suffix:semicolon
id|r-&gt;RMD3
op_assign
l_int|0x0000
suffix:semicolon
id|priv-&gt;rx_ring
(braket
id|i
)braket
op_assign
op_amp
id|lancedata-&gt;rx_ring
(braket
id|i
)braket
suffix:semicolon
id|priv-&gt;rx_buff
(braket
id|i
)braket
op_assign
id|lancedata-&gt;rx_buff
(braket
id|i
)braket
suffix:semicolon
macro_line|#if 0
id|printk
c_func
(paren
l_string|&quot;RX Entry %2d at %p, Buf at %p&bslash;n&quot;
comma
id|i
comma
op_amp
id|lancedata-&gt;rx_ring
(braket
id|i
)braket
comma
id|lancedata-&gt;rx_buff
(braket
id|i
)braket
)paren
suffix:semicolon
macro_line|#endif
)brace
)brace
DECL|function|ariadne_close
r_static
r_int
id|ariadne_close
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|ariadne_private
op_star
id|priv
op_assign
(paren
r_struct
id|ariadne_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_volatile
r_struct
id|Am79C960
op_star
id|lance
op_assign
(paren
r_struct
id|Am79C960
op_star
)paren
id|dev-&gt;base_addr
suffix:semicolon
id|netif_stop_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
id|lance-&gt;RAP
op_assign
id|CSR112
suffix:semicolon
multiline_comment|/* Missed Frame Count */
id|priv-&gt;stats.rx_missed_errors
op_assign
id|swapw
c_func
(paren
id|lance-&gt;RDP
)paren
suffix:semicolon
id|lance-&gt;RAP
op_assign
id|CSR0
suffix:semicolon
multiline_comment|/* PCnet-ISA Controller Status */
r_if
c_cond
(paren
id|ariadne_debug
OG
l_int|1
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%s: Shutting down ethercard, status was %2.2x.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|lance-&gt;RDP
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;%s: %lu packets missed&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|priv-&gt;stats.rx_missed_errors
)paren
suffix:semicolon
)brace
multiline_comment|/* We stop the LANCE here -- it occasionally polls memory if we don&squot;t. */
id|lance-&gt;RDP
op_assign
id|STOP
suffix:semicolon
id|free_irq
c_func
(paren
id|IRQ_AMIGA_PORTS
comma
id|dev
)paren
suffix:semicolon
id|MOD_DEC_USE_COUNT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|ariadne_reset
r_static
r_inline
r_void
id|ariadne_reset
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_volatile
r_struct
id|Am79C960
op_star
id|lance
op_assign
(paren
r_struct
id|Am79C960
op_star
)paren
id|dev-&gt;base_addr
suffix:semicolon
id|lance-&gt;RAP
op_assign
id|CSR0
suffix:semicolon
multiline_comment|/* PCnet-ISA Controller Status */
id|lance-&gt;RDP
op_assign
id|STOP
suffix:semicolon
id|ariadne_init_ring
c_func
(paren
id|dev
)paren
suffix:semicolon
id|lance-&gt;RDP
op_assign
id|INEA
op_or
id|STRT
suffix:semicolon
id|netif_start_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
DECL|function|ariadne_interrupt
r_static
r_void
id|ariadne_interrupt
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|data
comma
r_struct
id|pt_regs
op_star
id|fp
)paren
(brace
r_struct
id|net_device
op_star
id|dev
op_assign
(paren
r_struct
id|net_device
op_star
)paren
id|data
suffix:semicolon
r_volatile
r_struct
id|Am79C960
op_star
id|lance
op_assign
(paren
r_struct
id|Am79C960
op_star
)paren
id|dev-&gt;base_addr
suffix:semicolon
r_struct
id|ariadne_private
op_star
id|priv
suffix:semicolon
r_int
id|csr0
comma
id|boguscnt
suffix:semicolon
r_if
c_cond
(paren
id|dev
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;ariadne_interrupt(): irq for unknown device.&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|lance-&gt;RAP
op_assign
id|CSR0
suffix:semicolon
multiline_comment|/* PCnet-ISA Controller Status */
r_if
c_cond
(paren
op_logical_neg
(paren
id|lance-&gt;RDP
op_amp
id|INTR
)paren
)paren
multiline_comment|/* Check if any interrupt has been */
r_return
suffix:semicolon
multiline_comment|/* generated by the board. */
id|priv
op_assign
(paren
r_struct
id|ariadne_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|boguscnt
op_assign
l_int|10
suffix:semicolon
r_while
c_loop
(paren
(paren
id|csr0
op_assign
id|lance-&gt;RDP
)paren
op_amp
(paren
id|ERR
op_or
id|RINT
op_or
id|TINT
)paren
op_logical_and
op_decrement
id|boguscnt
op_ge
l_int|0
)paren
(brace
multiline_comment|/* Acknowledge all of the current interrupt sources ASAP. */
id|lance-&gt;RDP
op_assign
id|csr0
op_amp
op_complement
(paren
id|INEA
op_or
id|TDMD
op_or
id|STOP
op_or
id|STRT
op_or
id|INIT
)paren
suffix:semicolon
macro_line|#if 0
r_if
c_cond
(paren
id|ariadne_debug
OG
l_int|5
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%s: interrupt  csr0=%#2.2x new csr=%#2.2x.&quot;
comma
id|dev-&gt;name
comma
id|csr0
comma
id|lance-&gt;RDP
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;[&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|csr0
op_amp
id|INTR
)paren
id|printk
c_func
(paren
l_string|&quot; INTR&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|csr0
op_amp
id|INEA
)paren
id|printk
c_func
(paren
l_string|&quot; INEA&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|csr0
op_amp
id|RXON
)paren
id|printk
c_func
(paren
l_string|&quot; RXON&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|csr0
op_amp
id|TXON
)paren
id|printk
c_func
(paren
l_string|&quot; TXON&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|csr0
op_amp
id|TDMD
)paren
id|printk
c_func
(paren
l_string|&quot; TDMD&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|csr0
op_amp
id|STOP
)paren
id|printk
c_func
(paren
l_string|&quot; STOP&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|csr0
op_amp
id|STRT
)paren
id|printk
c_func
(paren
l_string|&quot; STRT&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|csr0
op_amp
id|INIT
)paren
id|printk
c_func
(paren
l_string|&quot; INIT&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|csr0
op_amp
id|ERR
)paren
id|printk
c_func
(paren
l_string|&quot; ERR&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|csr0
op_amp
id|BABL
)paren
id|printk
c_func
(paren
l_string|&quot; BABL&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|csr0
op_amp
id|CERR
)paren
id|printk
c_func
(paren
l_string|&quot; CERR&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|csr0
op_amp
id|MISS
)paren
id|printk
c_func
(paren
l_string|&quot; MISS&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|csr0
op_amp
id|MERR
)paren
id|printk
c_func
(paren
l_string|&quot; MERR&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|csr0
op_amp
id|RINT
)paren
id|printk
c_func
(paren
l_string|&quot; RINT&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|csr0
op_amp
id|TINT
)paren
id|printk
c_func
(paren
l_string|&quot; TINT&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|csr0
op_amp
id|IDON
)paren
id|printk
c_func
(paren
l_string|&quot; IDON&quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot; ]&bslash;n&quot;
)paren
suffix:semicolon
)brace
macro_line|#endif
r_if
c_cond
(paren
id|csr0
op_amp
id|RINT
)paren
multiline_comment|/* Rx interrupt */
id|ariadne_rx
c_func
(paren
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|csr0
op_amp
id|TINT
)paren
(brace
multiline_comment|/* Tx-done interrupt */
r_int
id|dirty_tx
op_assign
id|priv-&gt;dirty_tx
suffix:semicolon
r_while
c_loop
(paren
id|dirty_tx
OL
id|priv-&gt;cur_tx
)paren
(brace
r_int
id|entry
op_assign
id|dirty_tx
op_mod
id|TX_RING_SIZE
suffix:semicolon
r_int
id|status
op_assign
id|lowb
c_func
(paren
id|priv-&gt;tx_ring
(braket
id|entry
)braket
op_member_access_from_pointer
id|TMD1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
id|TF_OWN
)paren
r_break
suffix:semicolon
multiline_comment|/* It still hasn&squot;t been Txed */
id|priv-&gt;tx_ring
(braket
id|entry
)braket
op_member_access_from_pointer
id|TMD1
op_and_assign
l_int|0xff00
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
id|TF_ERR
)paren
(brace
multiline_comment|/* There was an major error, log it. */
r_int
id|err_status
op_assign
id|priv-&gt;tx_ring
(braket
id|entry
)braket
op_member_access_from_pointer
id|TMD3
suffix:semicolon
id|priv-&gt;stats.tx_errors
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|err_status
op_amp
id|EF_RTRY
)paren
id|priv-&gt;stats.tx_aborted_errors
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|err_status
op_amp
id|EF_LCAR
)paren
id|priv-&gt;stats.tx_carrier_errors
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|err_status
op_amp
id|EF_LCOL
)paren
id|priv-&gt;stats.tx_window_errors
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|err_status
op_amp
id|EF_UFLO
)paren
(brace
multiline_comment|/* Ackk!  On FIFO errors the Tx unit is turned off! */
id|priv-&gt;stats.tx_fifo_errors
op_increment
suffix:semicolon
multiline_comment|/* Remove this verbosity later! */
id|printk
c_func
(paren
l_string|&quot;%s: Tx FIFO error! Status %4.4x.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|csr0
)paren
suffix:semicolon
multiline_comment|/* Restart the chip. */
id|lance-&gt;RDP
op_assign
id|STRT
suffix:semicolon
)brace
)brace
r_else
(brace
r_if
c_cond
(paren
id|status
op_amp
(paren
id|TF_MORE
op_or
id|TF_ONE
)paren
)paren
id|priv-&gt;stats.collisions
op_increment
suffix:semicolon
id|priv-&gt;stats.tx_packets
op_increment
suffix:semicolon
)brace
id|dirty_tx
op_increment
suffix:semicolon
)brace
macro_line|#ifndef final_version
r_if
c_cond
(paren
id|priv-&gt;cur_tx
op_minus
id|dirty_tx
op_ge
id|TX_RING_SIZE
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;out-of-sync dirty pointer, %d vs. %d, full=%d.&bslash;n&quot;
comma
id|dirty_tx
comma
id|priv-&gt;cur_tx
comma
id|priv-&gt;tx_full
)paren
suffix:semicolon
id|dirty_tx
op_add_assign
id|TX_RING_SIZE
suffix:semicolon
)brace
macro_line|#endif
r_if
c_cond
(paren
id|priv-&gt;tx_full
op_logical_and
id|netif_queue_stopped
c_func
(paren
id|dev
)paren
op_logical_and
id|dirty_tx
OG
id|priv-&gt;cur_tx
op_minus
id|TX_RING_SIZE
op_plus
l_int|2
)paren
(brace
multiline_comment|/* The ring is no longer full. */
id|priv-&gt;tx_full
op_assign
l_int|0
suffix:semicolon
id|netif_wake_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
id|priv-&gt;dirty_tx
op_assign
id|dirty_tx
suffix:semicolon
)brace
multiline_comment|/* Log misc errors. */
r_if
c_cond
(paren
id|csr0
op_amp
id|BABL
)paren
id|priv-&gt;stats.tx_errors
op_increment
suffix:semicolon
multiline_comment|/* Tx babble. */
r_if
c_cond
(paren
id|csr0
op_amp
id|MISS
)paren
id|priv-&gt;stats.rx_errors
op_increment
suffix:semicolon
multiline_comment|/* Missed a Rx frame. */
r_if
c_cond
(paren
id|csr0
op_amp
id|MERR
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%s: Bus master arbitration failure, status %4.4x.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|csr0
)paren
suffix:semicolon
multiline_comment|/* Restart the chip. */
id|lance-&gt;RDP
op_assign
id|STRT
suffix:semicolon
)brace
)brace
multiline_comment|/* Clear any other interrupt, and set interrupt enable. */
id|lance-&gt;RAP
op_assign
id|CSR0
suffix:semicolon
multiline_comment|/* PCnet-ISA Controller Status */
id|lance-&gt;RDP
op_assign
id|INEA
op_or
id|BABL
op_or
id|CERR
op_or
id|MISS
op_or
id|MERR
op_or
id|IDON
suffix:semicolon
macro_line|#if 0
r_if
c_cond
(paren
id|ariadne_debug
OG
l_int|4
)paren
id|printk
c_func
(paren
l_string|&quot;%s: exiting interrupt, csr%d=%#4.4x.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|lance-&gt;RAP
comma
id|lance-&gt;RDP
)paren
suffix:semicolon
macro_line|#endif
r_return
suffix:semicolon
)brace
DECL|function|ariadne_tx_timeout
r_static
r_void
id|ariadne_tx_timeout
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_volatile
r_struct
id|Am79C960
op_star
id|lance
op_assign
(paren
r_struct
id|Am79C960
op_star
)paren
id|dev-&gt;base_addr
suffix:semicolon
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: transmit timed out, status %4.4x, resetting.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|lance-&gt;RDP
)paren
suffix:semicolon
id|ariadne_reset
c_func
(paren
id|dev
)paren
suffix:semicolon
id|netif_wake_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
DECL|function|ariadne_start_xmit
r_static
r_int
id|ariadne_start_xmit
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|ariadne_private
op_star
id|priv
op_assign
(paren
r_struct
id|ariadne_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_volatile
r_struct
id|Am79C960
op_star
id|lance
op_assign
(paren
r_struct
id|Am79C960
op_star
)paren
id|dev-&gt;base_addr
suffix:semicolon
r_int
id|entry
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
macro_line|#if 0
r_if
c_cond
(paren
id|ariadne_debug
OG
l_int|3
)paren
(brace
id|lance-&gt;RAP
op_assign
id|CSR0
suffix:semicolon
multiline_comment|/* PCnet-ISA Controller Status */
id|printk
c_func
(paren
l_string|&quot;%s: ariadne_start_xmit() called, csr0 %4.4x.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|lance-&gt;RDP
)paren
suffix:semicolon
id|lance-&gt;RDP
op_assign
l_int|0x0000
suffix:semicolon
)brace
macro_line|#endif
multiline_comment|/* Fill in a Tx ring entry */
macro_line|#if 0
id|printk
c_func
(paren
l_string|&quot;TX pkt type 0x%04x from &quot;
comma
(paren
(paren
id|u_short
op_star
)paren
id|skb-&gt;data
)paren
(braket
l_int|6
)braket
)paren
suffix:semicolon
(brace
r_int
id|i
suffix:semicolon
id|u_char
op_star
id|ptr
op_assign
op_amp
(paren
(paren
id|u_char
op_star
)paren
id|skb-&gt;data
)paren
(braket
l_int|6
)braket
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|6
suffix:semicolon
id|i
op_increment
)paren
id|printk
c_func
(paren
l_string|&quot;%02x&quot;
comma
id|ptr
(braket
id|i
)braket
)paren
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot; to &quot;
)paren
suffix:semicolon
(brace
r_int
id|i
suffix:semicolon
id|u_char
op_star
id|ptr
op_assign
(paren
id|u_char
op_star
)paren
id|skb-&gt;data
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|6
suffix:semicolon
id|i
op_increment
)paren
id|printk
c_func
(paren
l_string|&quot;%02x&quot;
comma
id|ptr
(braket
id|i
)braket
)paren
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot; data 0x%08x len %d&bslash;n&quot;
comma
(paren
r_int
)paren
id|skb-&gt;data
comma
(paren
r_int
)paren
id|skb-&gt;len
)paren
suffix:semicolon
macro_line|#endif
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|entry
op_assign
id|priv-&gt;cur_tx
op_mod
id|TX_RING_SIZE
suffix:semicolon
multiline_comment|/* Caution: the write order is important here, set the base address with&n;&t;&t;the &quot;ownership&quot; bits last. */
id|priv-&gt;tx_ring
(braket
id|entry
)braket
op_member_access_from_pointer
id|TMD2
op_assign
id|swapw
c_func
(paren
(paren
id|u_short
)paren
op_minus
id|skb-&gt;len
)paren
suffix:semicolon
id|priv-&gt;tx_ring
(braket
id|entry
)braket
op_member_access_from_pointer
id|TMD3
op_assign
l_int|0x0000
suffix:semicolon
id|memcpyw
c_func
(paren
id|priv-&gt;tx_buff
(braket
id|entry
)braket
comma
(paren
id|u_short
op_star
)paren
id|skb-&gt;data
comma
id|skb-&gt;len
op_le
id|ETH_ZLEN
ques
c_cond
id|ETH_ZLEN
suffix:colon
id|skb-&gt;len
)paren
suffix:semicolon
macro_line|#if 0
(brace
r_int
id|i
comma
id|len
suffix:semicolon
id|len
op_assign
id|skb-&gt;len
OG
l_int|64
ques
c_cond
l_int|64
suffix:colon
id|skb-&gt;len
suffix:semicolon
id|len
op_rshift_assign
l_int|1
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|len
suffix:semicolon
id|i
op_add_assign
l_int|8
)paren
(brace
r_int
id|j
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;%04x:&quot;
comma
id|i
)paren
suffix:semicolon
r_for
c_loop
(paren
id|j
op_assign
l_int|0
suffix:semicolon
(paren
id|j
OL
l_int|8
)paren
op_logical_and
(paren
(paren
id|i
op_plus
id|j
)paren
OL
id|len
)paren
suffix:semicolon
id|j
op_increment
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|j
op_amp
l_int|1
)paren
)paren
id|printk
c_func
(paren
l_string|&quot; &quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;%04x&quot;
comma
id|priv-&gt;tx_buff
(braket
id|entry
)braket
(braket
id|i
op_plus
id|j
)braket
)paren
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
)brace
)brace
macro_line|#endif
id|priv-&gt;tx_ring
(braket
id|entry
)braket
op_member_access_from_pointer
id|TMD1
op_assign
(paren
id|priv-&gt;tx_ring
(braket
id|entry
)braket
op_member_access_from_pointer
id|TMD1
op_amp
l_int|0xff00
)paren
op_or
id|TF_OWN
op_or
id|TF_STP
op_or
id|TF_ENP
suffix:semicolon
id|dev_kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
id|priv-&gt;cur_tx
op_increment
suffix:semicolon
r_if
c_cond
(paren
(paren
id|priv-&gt;cur_tx
op_ge
id|TX_RING_SIZE
)paren
op_logical_and
(paren
id|priv-&gt;dirty_tx
op_ge
id|TX_RING_SIZE
)paren
)paren
(brace
macro_line|#if 0
id|printk
c_func
(paren
l_string|&quot;*** Subtracting TX_RING_SIZE from cur_tx (%d) and dirty_tx (%d)&bslash;n&quot;
comma
id|priv-&gt;cur_tx
comma
id|priv-&gt;dirty_tx
)paren
suffix:semicolon
macro_line|#endif
id|priv-&gt;cur_tx
op_sub_assign
id|TX_RING_SIZE
suffix:semicolon
id|priv-&gt;dirty_tx
op_sub_assign
id|TX_RING_SIZE
suffix:semicolon
)brace
multiline_comment|/* Trigger an immediate send poll. */
id|lance-&gt;RAP
op_assign
id|CSR0
suffix:semicolon
multiline_comment|/* PCnet-ISA Controller Status */
id|lance-&gt;RDP
op_assign
id|INEA
op_or
id|TDMD
suffix:semicolon
id|dev-&gt;trans_start
op_assign
id|jiffies
suffix:semicolon
r_if
c_cond
(paren
id|lowb
c_func
(paren
id|priv-&gt;tx_ring
(braket
(paren
id|entry
op_plus
l_int|1
)paren
op_mod
id|TX_RING_SIZE
)braket
op_member_access_from_pointer
id|TMD1
)paren
op_ne
l_int|0
)paren
(brace
id|netif_stop_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
id|priv-&gt;tx_full
op_assign
l_int|1
suffix:semicolon
)brace
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|ariadne_rx
r_static
r_int
id|ariadne_rx
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|ariadne_private
op_star
id|priv
op_assign
(paren
r_struct
id|ariadne_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_int
id|entry
op_assign
id|priv-&gt;cur_rx
op_mod
id|RX_RING_SIZE
suffix:semicolon
r_int
id|i
suffix:semicolon
multiline_comment|/* If we own the next entry, it&squot;s a new packet. Send it up. */
r_while
c_loop
(paren
op_logical_neg
(paren
id|lowb
c_func
(paren
id|priv-&gt;rx_ring
(braket
id|entry
)braket
op_member_access_from_pointer
id|RMD1
)paren
op_amp
id|RF_OWN
)paren
)paren
(brace
r_int
id|status
op_assign
id|lowb
c_func
(paren
id|priv-&gt;rx_ring
(braket
id|entry
)braket
op_member_access_from_pointer
id|RMD1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
op_ne
(paren
id|RF_STP
op_or
id|RF_ENP
)paren
)paren
(brace
multiline_comment|/* There was an error. */
multiline_comment|/* There is a tricky error noted by John Murphy,&n;&t;&t;&lt;murf@perftech.com&gt; to Russ Nelson: Even with full-sized&n;&t;&t;buffers it&squot;s possible for a jabber packet to use two&n;&t;&t;buffers, with only the last correctly noting the error. */
r_if
c_cond
(paren
id|status
op_amp
id|RF_ENP
)paren
multiline_comment|/* Only count a general error at the end of a packet.*/
id|priv-&gt;stats.rx_errors
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
id|RF_FRAM
)paren
id|priv-&gt;stats.rx_frame_errors
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
id|RF_OFLO
)paren
id|priv-&gt;stats.rx_over_errors
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
id|RF_CRC
)paren
id|priv-&gt;stats.rx_crc_errors
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
id|RF_BUFF
)paren
id|priv-&gt;stats.rx_fifo_errors
op_increment
suffix:semicolon
id|priv-&gt;rx_ring
(braket
id|entry
)braket
op_member_access_from_pointer
id|RMD1
op_and_assign
l_int|0xff00
op_or
id|RF_STP
op_or
id|RF_ENP
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* Malloc up new buffer, compatible with net-3. */
r_int
id|pkt_len
op_assign
id|swapw
c_func
(paren
id|priv-&gt;rx_ring
(braket
id|entry
)braket
op_member_access_from_pointer
id|RMD3
)paren
suffix:semicolon
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
id|skb
op_assign
id|dev_alloc_skb
c_func
(paren
id|pkt_len
op_plus
l_int|2
)paren
suffix:semicolon
r_if
c_cond
(paren
id|skb
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%s: Memory squeeze, deferring packet.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|RX_RING_SIZE
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
id|lowb
c_func
(paren
id|priv-&gt;rx_ring
(braket
(paren
id|entry
op_plus
id|i
)paren
op_mod
id|RX_RING_SIZE
)braket
op_member_access_from_pointer
id|RMD1
)paren
op_amp
id|RF_OWN
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
id|i
OG
id|RX_RING_SIZE
op_minus
l_int|2
)paren
(brace
id|priv-&gt;stats.rx_dropped
op_increment
suffix:semicolon
id|priv-&gt;rx_ring
(braket
id|entry
)braket
op_member_access_from_pointer
id|RMD1
op_or_assign
id|RF_OWN
suffix:semicolon
id|priv-&gt;cur_rx
op_increment
suffix:semicolon
)brace
r_break
suffix:semicolon
)brace
id|skb-&gt;dev
op_assign
id|dev
suffix:semicolon
id|skb_reserve
c_func
(paren
id|skb
comma
l_int|2
)paren
suffix:semicolon
multiline_comment|/* 16 byte align */
id|skb_put
c_func
(paren
id|skb
comma
id|pkt_len
)paren
suffix:semicolon
multiline_comment|/* Make room */
id|eth_copy_and_sum
c_func
(paren
id|skb
comma
(paren
r_char
op_star
)paren
id|priv-&gt;rx_buff
(braket
id|entry
)braket
comma
id|pkt_len
comma
l_int|0
)paren
suffix:semicolon
id|skb-&gt;protocol
op_assign
id|eth_type_trans
c_func
(paren
id|skb
comma
id|dev
)paren
suffix:semicolon
macro_line|#if 0
id|printk
c_func
(paren
l_string|&quot;RX pkt type 0x%04x from &quot;
comma
(paren
(paren
id|u_short
op_star
)paren
id|skb-&gt;data
)paren
(braket
l_int|6
)braket
)paren
suffix:semicolon
(brace
r_int
id|i
suffix:semicolon
id|u_char
op_star
id|ptr
op_assign
op_amp
(paren
(paren
id|u_char
op_star
)paren
id|skb-&gt;data
)paren
(braket
l_int|6
)braket
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|6
suffix:semicolon
id|i
op_increment
)paren
id|printk
c_func
(paren
l_string|&quot;%02x&quot;
comma
id|ptr
(braket
id|i
)braket
)paren
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot; to &quot;
)paren
suffix:semicolon
(brace
r_int
id|i
suffix:semicolon
id|u_char
op_star
id|ptr
op_assign
(paren
id|u_char
op_star
)paren
id|skb-&gt;data
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|6
suffix:semicolon
id|i
op_increment
)paren
id|printk
c_func
(paren
l_string|&quot;%02x&quot;
comma
id|ptr
(braket
id|i
)braket
)paren
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot; data 0x%08x len %d&bslash;n&quot;
comma
(paren
r_int
)paren
id|skb-&gt;data
comma
(paren
r_int
)paren
id|skb-&gt;len
)paren
suffix:semicolon
macro_line|#endif
id|netif_rx
c_func
(paren
id|skb
)paren
suffix:semicolon
id|priv-&gt;stats.rx_packets
op_increment
suffix:semicolon
)brace
id|priv-&gt;rx_ring
(braket
id|entry
)braket
op_member_access_from_pointer
id|RMD1
op_or_assign
id|RF_OWN
suffix:semicolon
id|entry
op_assign
(paren
op_increment
id|priv-&gt;cur_rx
)paren
op_mod
id|RX_RING_SIZE
suffix:semicolon
)brace
id|priv-&gt;cur_rx
op_assign
id|priv-&gt;cur_rx
op_mod
id|RX_RING_SIZE
suffix:semicolon
multiline_comment|/* We should check that at least two ring entries are free.&t; If not,&n;       we should free one and mark stats-&gt;rx_dropped++. */
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|ariadne_get_stats
r_static
r_struct
id|net_device_stats
op_star
id|ariadne_get_stats
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|ariadne_private
op_star
id|priv
op_assign
(paren
r_struct
id|ariadne_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_volatile
r_struct
id|Am79C960
op_star
id|lance
op_assign
(paren
r_struct
id|Am79C960
op_star
)paren
id|dev-&gt;base_addr
suffix:semicolon
r_int
id|saved_addr
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|saved_addr
op_assign
id|lance-&gt;RAP
suffix:semicolon
id|lance-&gt;RAP
op_assign
id|CSR112
suffix:semicolon
multiline_comment|/* Missed Frame Count */
id|priv-&gt;stats.rx_missed_errors
op_assign
id|swapw
c_func
(paren
id|lance-&gt;RDP
)paren
suffix:semicolon
id|lance-&gt;RAP
op_assign
id|saved_addr
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
op_amp
id|priv-&gt;stats
suffix:semicolon
)brace
multiline_comment|/* Set or clear the multicast filter for this adaptor.&n;    num_addrs == -1&t;Promiscuous mode, receive all packets&n;    num_addrs == 0&t;Normal mode, clear multicast list&n;    num_addrs &gt; 0&t;Multicast mode, receive normal and MC packets, and do&n;&t;&t;&t;best-effort filtering.&n; */
DECL|function|set_multicast_list
r_static
r_void
id|set_multicast_list
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_volatile
r_struct
id|Am79C960
op_star
id|lance
op_assign
(paren
r_struct
id|Am79C960
op_star
)paren
id|dev-&gt;base_addr
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|netif_running
c_func
(paren
id|dev
)paren
)paren
r_return
suffix:semicolon
id|netif_stop_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
multiline_comment|/* We take the simple way out and always enable promiscuous mode. */
id|lance-&gt;RAP
op_assign
id|CSR0
suffix:semicolon
multiline_comment|/* PCnet-ISA Controller Status */
id|lance-&gt;RDP
op_assign
id|STOP
suffix:semicolon
multiline_comment|/* Temporarily stop the lance. */
id|ariadne_init_ring
c_func
(paren
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;flags
op_amp
id|IFF_PROMISC
)paren
(brace
multiline_comment|/* Log any net taps. */
id|printk
c_func
(paren
l_string|&quot;%s: Promiscuous mode enabled.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|lance-&gt;RAP
op_assign
id|CSR15
suffix:semicolon
multiline_comment|/* Mode Register */
id|lance-&gt;RDP
op_assign
id|PROM
suffix:semicolon
multiline_comment|/* Set promiscuous mode */
)brace
r_else
(brace
r_int
id|multicast_table
(braket
l_int|4
)braket
suffix:semicolon
r_int
id|num_addrs
op_assign
id|dev-&gt;mc_count
suffix:semicolon
r_int
id|i
suffix:semicolon
multiline_comment|/* We don&squot;t use the multicast table, but rely on upper-layer filtering. */
id|memset
c_func
(paren
id|multicast_table
comma
(paren
id|num_addrs
op_eq
l_int|0
)paren
ques
c_cond
l_int|0
suffix:colon
op_minus
l_int|1
comma
r_sizeof
(paren
id|multicast_table
)paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|4
suffix:semicolon
id|i
op_increment
)paren
(brace
id|lance-&gt;RAP
op_assign
id|CSR8
op_plus
(paren
id|i
op_lshift
l_int|8
)paren
suffix:semicolon
multiline_comment|/* Logical Address Filter */
id|lance-&gt;RDP
op_assign
id|swapw
c_func
(paren
id|multicast_table
(braket
id|i
)braket
)paren
suffix:semicolon
)brace
id|lance-&gt;RAP
op_assign
id|CSR15
suffix:semicolon
multiline_comment|/* Mode Register */
id|lance-&gt;RDP
op_assign
l_int|0x0000
suffix:semicolon
multiline_comment|/* Unset promiscuous mode */
)brace
id|lance-&gt;RAP
op_assign
id|CSR0
suffix:semicolon
multiline_comment|/* PCnet-ISA Controller Status */
id|lance-&gt;RDP
op_assign
id|INEA
op_or
id|STRT
op_or
id|IDON
suffix:semicolon
multiline_comment|/* Resume normal operation. */
id|netif_wake_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
DECL|function|ariadne_cleanup
r_static
r_void
id|__exit
id|ariadne_cleanup
c_func
(paren
r_void
)paren
(brace
macro_line|#ifdef MODULE
r_struct
id|ariadne_private
op_star
id|next
suffix:semicolon
r_struct
id|net_device
op_star
id|dev
suffix:semicolon
r_while
c_loop
(paren
id|root_ariadne_dev
)paren
(brace
id|next
op_assign
id|root_ariadne_dev-&gt;next_module
suffix:semicolon
id|dev
op_assign
id|root_ariadne_dev-&gt;dev
suffix:semicolon
id|unregister_netdev
c_func
(paren
id|dev
)paren
suffix:semicolon
id|release_mem_region
c_func
(paren
id|ZTWO_PADDR
c_func
(paren
id|dev-&gt;base_addr
)paren
comma
r_sizeof
(paren
r_struct
id|Am79C960
)paren
)paren
suffix:semicolon
id|release_mem_region
c_func
(paren
id|ZTWO_PADDR
c_func
(paren
id|dev-&gt;mem_start
)paren
comma
id|ARIADNE_RAM_SIZE
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|dev
)paren
suffix:semicolon
id|root_ariadne_dev
op_assign
id|next
suffix:semicolon
)brace
macro_line|#endif
)brace
DECL|variable|ariadne_probe
id|module_init
c_func
(paren
id|ariadne_probe
)paren
suffix:semicolon
DECL|variable|ariadne_cleanup
id|module_exit
c_func
(paren
id|ariadne_cleanup
)paren
suffix:semicolon
eof
