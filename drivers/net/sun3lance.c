multiline_comment|/* sun3lance.c: Ethernet driver for SUN3 Lance chip */
multiline_comment|/*&n;&n;  Sun3 Lance ethernet driver, by Sam Creasey (sammy@users.qual.net).  &n;  This driver is a part of the linux kernel, and is thus distributed&n;  under the GNU Public License.&n;  &n;  The values used in LANCE_OBIO and LANCE_IRQ seem to be empirically&n;  true for the correct IRQ and address of the lance registers.  They&n;  have not been widely tested, however.  What we probably need is a&n;  &quot;proper&quot; way to search for a device in the sun3&squot;s prom, but, alas,&n;  linux has no such thing.  &n;&n;  This driver is largely based on atarilance.c, by Roman Hodek.  Other&n;  sources of inspiration were the NetBSD sun3 am7990 driver, and the&n;  linux sparc lance driver (sunlance.c).  &n;&n;  There are more assumptions made throughout this driver, it almost&n;  certainly still needs work, but it does work at least for RARP/BOOTP and&n;  mounting the root NFS filesystem.&n;  &n;*/
DECL|variable|version
r_static
r_char
op_star
id|version
op_assign
l_string|&quot;sun3lance.c: v1.1 11/17/1999  Sam Creasey (sammy@oh.verio.com)&bslash;n&quot;
suffix:semicolon
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/stddef.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/ptrace.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/malloc.h&gt;
macro_line|#include &lt;linux/interrupt.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/ioport.h&gt;
macro_line|#include &lt;asm/setup.h&gt;
macro_line|#include &lt;asm/irq.h&gt;
macro_line|#include &lt;asm/bitops.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/idprom.h&gt;
macro_line|#include &lt;asm/pgtable.h&gt;
macro_line|#include &lt;asm/sun3mmu.h&gt;
macro_line|#include &lt;asm/dvma.h&gt;
macro_line|#include &lt;linux/netdevice.h&gt;
macro_line|#include &lt;linux/etherdevice.h&gt;
macro_line|#include &lt;linux/skbuff.h&gt;
multiline_comment|/* sun3/60 addr/irq for the lance chip.  If your sun is different,&n;   change this. */
DECL|macro|LANCE_OBIO
mdefine_line|#define LANCE_OBIO 0x120000
DECL|macro|LANCE_IRQ
mdefine_line|#define LANCE_IRQ IRQ3
multiline_comment|/* Debug level:&n; *  0 = silent, print only serious errors&n; *  1 = normal, print error messages&n; *  2 = debug, print debug infos&n; *  3 = debug, print even more debug infos (packet data)&n; */
DECL|macro|LANCE_DEBUG
mdefine_line|#define&t;LANCE_DEBUG&t;1
macro_line|#ifdef LANCE_DEBUG
DECL|variable|lance_debug
r_static
r_int
id|lance_debug
op_assign
id|LANCE_DEBUG
suffix:semicolon
macro_line|#else
DECL|variable|lance_debug
r_static
r_int
id|lance_debug
op_assign
l_int|1
suffix:semicolon
macro_line|#endif
id|MODULE_PARM
c_func
(paren
id|lance_debug
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
DECL|macro|DPRINTK
mdefine_line|#define&t;DPRINTK(n,a) &bslash;&n;&t;do {  &bslash;&n;&t;&t;if (lance_debug &gt;= n)  &bslash;&n;&t;&t;&t;printk a; &bslash;&n;&t;} while( 0 )
multiline_comment|/* we&squot;re only using 32k of memory, so we use 4 TX&n;   buffers and 16 RX buffers.  These values are expressed as log2. */
DECL|macro|TX_LOG_RING_SIZE
mdefine_line|#define TX_LOG_RING_SIZE&t;&t;&t;3
DECL|macro|RX_LOG_RING_SIZE
mdefine_line|#define RX_LOG_RING_SIZE&t;&t;&t;5
multiline_comment|/* These are the derived values */
DECL|macro|TX_RING_SIZE
mdefine_line|#define TX_RING_SIZE&t;&t;&t;(1 &lt;&lt; TX_LOG_RING_SIZE)
DECL|macro|TX_RING_LEN_BITS
mdefine_line|#define TX_RING_LEN_BITS&t;&t;(TX_LOG_RING_SIZE &lt;&lt; 5)
DECL|macro|TX_RING_MOD_MASK
mdefine_line|#define&t;TX_RING_MOD_MASK&t;&t;(TX_RING_SIZE - 1)
DECL|macro|RX_RING_SIZE
mdefine_line|#define RX_RING_SIZE&t;&t;&t;(1 &lt;&lt; RX_LOG_RING_SIZE)
DECL|macro|RX_RING_LEN_BITS
mdefine_line|#define RX_RING_LEN_BITS&t;&t;(RX_LOG_RING_SIZE &lt;&lt; 5)
DECL|macro|RX_RING_MOD_MASK
mdefine_line|#define&t;RX_RING_MOD_MASK&t;&t;(RX_RING_SIZE - 1)
multiline_comment|/* Definitions for packet buffer access: */
DECL|macro|PKT_BUF_SZ
mdefine_line|#define PKT_BUF_SZ&t;&t;1544
multiline_comment|/* Get the address of a packet buffer corresponding to a given buffer head */
DECL|macro|PKTBUF_ADDR
mdefine_line|#define&t;PKTBUF_ADDR(head)&t;(void *)((unsigned long)(MEM) | (head)-&gt;base)
multiline_comment|/* The LANCE Rx and Tx ring descriptors. */
DECL|struct|lance_rx_head
r_struct
id|lance_rx_head
(brace
DECL|member|base
r_int
r_int
id|base
suffix:semicolon
multiline_comment|/* Low word of base addr */
DECL|member|flag
r_volatile
r_int
r_char
id|flag
suffix:semicolon
DECL|member|base_hi
r_int
r_char
id|base_hi
suffix:semicolon
multiline_comment|/* High word of base addr (unused) */
DECL|member|buf_length
r_int
id|buf_length
suffix:semicolon
multiline_comment|/* This length is 2s complement! */
DECL|member|msg_length
r_volatile
r_int
id|msg_length
suffix:semicolon
multiline_comment|/* This length is &quot;normal&quot;. */
)brace
suffix:semicolon
DECL|struct|lance_tx_head
r_struct
id|lance_tx_head
(brace
DECL|member|base
r_int
r_int
id|base
suffix:semicolon
multiline_comment|/* Low word of base addr */
DECL|member|flag
r_volatile
r_int
r_char
id|flag
suffix:semicolon
DECL|member|base_hi
r_int
r_char
id|base_hi
suffix:semicolon
multiline_comment|/* High word of base addr (unused) */
DECL|member|length
r_int
id|length
suffix:semicolon
multiline_comment|/* Length is 2s complement! */
DECL|member|misc
r_volatile
r_int
id|misc
suffix:semicolon
)brace
suffix:semicolon
multiline_comment|/* The LANCE initialization block, described in databook. */
DECL|struct|lance_init_block
r_struct
id|lance_init_block
(brace
DECL|member|mode
r_int
r_int
id|mode
suffix:semicolon
multiline_comment|/* Pre-set mode */
DECL|member|hwaddr
r_int
r_char
id|hwaddr
(braket
l_int|6
)braket
suffix:semicolon
multiline_comment|/* Physical ethernet address */
DECL|member|filter
r_int
r_int
id|filter
(braket
l_int|2
)braket
suffix:semicolon
multiline_comment|/* Multicast filter (unused). */
multiline_comment|/* Receive and transmit ring base, along with length bits. */
DECL|member|rdra
r_int
r_int
id|rdra
suffix:semicolon
DECL|member|rlen
r_int
r_int
id|rlen
suffix:semicolon
DECL|member|tdra
r_int
r_int
id|tdra
suffix:semicolon
DECL|member|tlen
r_int
r_int
id|tlen
suffix:semicolon
DECL|member|pad
r_int
r_int
id|pad
(braket
l_int|4
)braket
suffix:semicolon
multiline_comment|/* is thie needed? */
)brace
suffix:semicolon
multiline_comment|/* The whole layout of the Lance shared memory */
DECL|struct|lance_memory
r_struct
id|lance_memory
(brace
DECL|member|init
r_struct
id|lance_init_block
id|init
suffix:semicolon
DECL|member|tx_head
r_struct
id|lance_tx_head
id|tx_head
(braket
id|TX_RING_SIZE
)braket
suffix:semicolon
DECL|member|rx_head
r_struct
id|lance_rx_head
id|rx_head
(braket
id|RX_RING_SIZE
)braket
suffix:semicolon
DECL|member|rx_data
r_char
id|rx_data
(braket
id|RX_RING_SIZE
)braket
(braket
id|PKT_BUF_SZ
)braket
suffix:semicolon
DECL|member|tx_data
r_char
id|tx_data
(braket
id|RX_RING_SIZE
)braket
(braket
id|PKT_BUF_SZ
)braket
suffix:semicolon
)brace
suffix:semicolon
multiline_comment|/* The driver&squot;s private device structure */
DECL|struct|lance_private
r_struct
id|lance_private
(brace
DECL|member|iobase
r_volatile
r_int
r_int
op_star
id|iobase
suffix:semicolon
DECL|member|mem
r_struct
id|lance_memory
op_star
id|mem
suffix:semicolon
DECL|member|new_rx
DECL|member|new_tx
r_int
id|new_rx
comma
id|new_tx
suffix:semicolon
multiline_comment|/* The next free ring entry */
DECL|member|old_tx
DECL|member|old_rx
r_int
id|old_tx
comma
id|old_rx
suffix:semicolon
multiline_comment|/* ring entry to be processed */
DECL|member|stats
r_struct
id|net_device_stats
id|stats
suffix:semicolon
multiline_comment|/* These two must be ints for set_bit() */
DECL|member|tx_full
r_int
id|tx_full
suffix:semicolon
DECL|member|lock
r_int
id|lock
suffix:semicolon
)brace
suffix:semicolon
multiline_comment|/* I/O register access macros */
DECL|macro|MEM
mdefine_line|#define&t;MEM&t;lp-&gt;mem
DECL|macro|DREG
mdefine_line|#define&t;DREG&t;lp-&gt;iobase[0]
DECL|macro|AREG
mdefine_line|#define&t;AREG&t;lp-&gt;iobase[1]
DECL|macro|REGA
mdefine_line|#define&t;REGA(a)&t;( AREG = (a), DREG )
multiline_comment|/* Definitions for the Lance */
multiline_comment|/* tx_head flags */
DECL|macro|TMD1_ENP
mdefine_line|#define TMD1_ENP&t;&t;0x01&t;/* end of packet */
DECL|macro|TMD1_STP
mdefine_line|#define TMD1_STP&t;&t;0x02&t;/* start of packet */
DECL|macro|TMD1_DEF
mdefine_line|#define TMD1_DEF&t;&t;0x04&t;/* deferred */
DECL|macro|TMD1_ONE
mdefine_line|#define TMD1_ONE&t;&t;0x08&t;/* one retry needed */
DECL|macro|TMD1_MORE
mdefine_line|#define TMD1_MORE&t;&t;0x10&t;/* more than one retry needed */
DECL|macro|TMD1_ERR
mdefine_line|#define TMD1_ERR&t;&t;0x40&t;/* error summary */
DECL|macro|TMD1_OWN
mdefine_line|#define TMD1_OWN &t;&t;0x80&t;/* ownership (set: chip owns) */
DECL|macro|TMD1_OWN_CHIP
mdefine_line|#define TMD1_OWN_CHIP&t;TMD1_OWN
DECL|macro|TMD1_OWN_HOST
mdefine_line|#define TMD1_OWN_HOST&t;0
multiline_comment|/* tx_head misc field */
DECL|macro|TMD3_TDR
mdefine_line|#define TMD3_TDR&t;&t;0x03FF&t;/* Time Domain Reflectometry counter */
DECL|macro|TMD3_RTRY
mdefine_line|#define TMD3_RTRY&t;&t;0x0400&t;/* failed after 16 retries */
DECL|macro|TMD3_LCAR
mdefine_line|#define TMD3_LCAR&t;&t;0x0800&t;/* carrier lost */
DECL|macro|TMD3_LCOL
mdefine_line|#define TMD3_LCOL&t;&t;0x1000&t;/* late collision */
DECL|macro|TMD3_UFLO
mdefine_line|#define TMD3_UFLO&t;&t;0x4000&t;/* underflow (late memory) */
DECL|macro|TMD3_BUFF
mdefine_line|#define TMD3_BUFF&t;&t;0x8000&t;/* buffering error (no ENP) */
multiline_comment|/* rx_head flags */
DECL|macro|RMD1_ENP
mdefine_line|#define RMD1_ENP&t;&t;0x01&t;/* end of packet */
DECL|macro|RMD1_STP
mdefine_line|#define RMD1_STP&t;&t;0x02&t;/* start of packet */
DECL|macro|RMD1_BUFF
mdefine_line|#define RMD1_BUFF&t;&t;0x04&t;/* buffer error */
DECL|macro|RMD1_CRC
mdefine_line|#define RMD1_CRC&t;&t;0x08&t;/* CRC error */
DECL|macro|RMD1_OFLO
mdefine_line|#define RMD1_OFLO&t;&t;0x10&t;/* overflow */
DECL|macro|RMD1_FRAM
mdefine_line|#define RMD1_FRAM&t;&t;0x20&t;/* framing error */
DECL|macro|RMD1_ERR
mdefine_line|#define RMD1_ERR&t;&t;0x40&t;/* error summary */
DECL|macro|RMD1_OWN
mdefine_line|#define RMD1_OWN &t;&t;0x80&t;/* ownership (set: ship owns) */
DECL|macro|RMD1_OWN_CHIP
mdefine_line|#define RMD1_OWN_CHIP&t;RMD1_OWN
DECL|macro|RMD1_OWN_HOST
mdefine_line|#define RMD1_OWN_HOST&t;0
multiline_comment|/* register names */
DECL|macro|CSR0
mdefine_line|#define CSR0&t;0&t;&t;/* mode/status */
DECL|macro|CSR1
mdefine_line|#define CSR1&t;1&t;&t;/* init block addr (low) */
DECL|macro|CSR2
mdefine_line|#define CSR2&t;2&t;&t;/* init block addr (high) */
DECL|macro|CSR3
mdefine_line|#define CSR3&t;3&t;&t;/* misc */
DECL|macro|CSR8
mdefine_line|#define CSR8&t;8&t;  &t;/* address filter */
DECL|macro|CSR15
mdefine_line|#define CSR15&t;15&t;&t;/* promiscuous mode */
multiline_comment|/* CSR0 */
multiline_comment|/* (R=readable, W=writeable, S=set on write, C=clear on write) */
DECL|macro|CSR0_INIT
mdefine_line|#define CSR0_INIT&t;0x0001&t;&t;/* initialize (RS) */
DECL|macro|CSR0_STRT
mdefine_line|#define CSR0_STRT&t;0x0002&t;&t;/* start (RS) */
DECL|macro|CSR0_STOP
mdefine_line|#define CSR0_STOP&t;0x0004&t;&t;/* stop (RS) */
DECL|macro|CSR0_TDMD
mdefine_line|#define CSR0_TDMD&t;0x0008&t;&t;/* transmit demand (RS) */
DECL|macro|CSR0_TXON
mdefine_line|#define CSR0_TXON&t;0x0010&t;&t;/* transmitter on (R) */
DECL|macro|CSR0_RXON
mdefine_line|#define CSR0_RXON&t;0x0020&t;&t;/* receiver on (R) */
DECL|macro|CSR0_INEA
mdefine_line|#define CSR0_INEA&t;0x0040&t;&t;/* interrupt enable (RW) */
DECL|macro|CSR0_INTR
mdefine_line|#define CSR0_INTR&t;0x0080&t;&t;/* interrupt active (R) */
DECL|macro|CSR0_IDON
mdefine_line|#define CSR0_IDON&t;0x0100&t;&t;/* initialization done (RC) */
DECL|macro|CSR0_TINT
mdefine_line|#define CSR0_TINT&t;0x0200&t;&t;/* transmitter interrupt (RC) */
DECL|macro|CSR0_RINT
mdefine_line|#define CSR0_RINT&t;0x0400&t;&t;/* receiver interrupt (RC) */
DECL|macro|CSR0_MERR
mdefine_line|#define CSR0_MERR&t;0x0800&t;&t;/* memory error (RC) */
DECL|macro|CSR0_MISS
mdefine_line|#define CSR0_MISS&t;0x1000&t;&t;/* missed frame (RC) */
DECL|macro|CSR0_CERR
mdefine_line|#define CSR0_CERR&t;0x2000&t;&t;/* carrier error (no heartbeat :-) (RC) */
DECL|macro|CSR0_BABL
mdefine_line|#define CSR0_BABL&t;0x4000&t;&t;/* babble: tx-ed too many bits (RC) */
DECL|macro|CSR0_ERR
mdefine_line|#define CSR0_ERR&t;0x8000&t;&t;/* error (RC) */
multiline_comment|/* CSR3 */
DECL|macro|CSR3_BCON
mdefine_line|#define CSR3_BCON&t;0x0001&t;&t;/* byte control */
DECL|macro|CSR3_ACON
mdefine_line|#define CSR3_ACON&t;0x0002&t;&t;/* ALE control */
DECL|macro|CSR3_BSWP
mdefine_line|#define CSR3_BSWP&t;0x0004&t;&t;/* byte swap (1=big endian) */
multiline_comment|/***************************** Prototypes *****************************/
r_static
r_int
id|lance_probe
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_int
id|lance_open
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_void
id|lance_init_ring
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_int
id|lance_start_xmit
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_void
id|lance_interrupt
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|fp
)paren
suffix:semicolon
r_static
r_int
id|lance_rx
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_int
id|lance_close
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_struct
id|net_device_stats
op_star
id|lance_get_stats
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_void
id|set_multicast_list
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
multiline_comment|/************************* End of Prototypes **************************/
DECL|function|sun3lance_probe
r_int
id|__init
id|sun3lance_probe
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_static
r_int
id|found
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|found
)paren
(brace
r_return
id|ENODEV
suffix:semicolon
)brace
r_if
c_cond
(paren
id|lance_probe
c_func
(paren
id|dev
)paren
)paren
(brace
id|found
op_assign
l_int|1
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_return
id|ENODEV
suffix:semicolon
)brace
DECL|function|lance_probe
r_static
r_int
id|__init
id|lance_probe
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_int
r_int
id|ioaddr
comma
id|iopte
suffix:semicolon
r_struct
id|lance_private
op_star
id|lp
suffix:semicolon
r_int
id|i
suffix:semicolon
r_static
r_int
id|did_version
op_assign
l_int|0
suffix:semicolon
r_int
id|found
op_assign
l_int|0
suffix:semicolon
r_volatile
r_int
r_int
op_star
id|ioaddr_probe
suffix:semicolon
r_int
r_int
id|tmp1
comma
id|tmp2
suffix:semicolon
multiline_comment|/* LANCE_OBIO can be found within the IO pmeg with some effort */
r_for
c_loop
(paren
id|ioaddr
op_assign
l_int|0xfe00000
suffix:semicolon
id|ioaddr
OL
(paren
l_int|0xfe00000
op_plus
id|SUN3_PMEG_SIZE
)paren
suffix:semicolon
id|ioaddr
op_add_assign
id|SUN3_PTE_SIZE
)paren
(brace
id|iopte
op_assign
id|sun3_get_pte
c_func
(paren
id|ioaddr
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|iopte
op_amp
id|SUN3_PAGE_TYPE_IO
)paren
)paren
(brace
multiline_comment|/* this an io page? */
r_continue
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
(paren
id|iopte
op_amp
id|SUN3_PAGE_PGNUM_MASK
)paren
op_lshift
id|PAGE_SHIFT
)paren
op_eq
id|LANCE_OBIO
)paren
(brace
id|found
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
op_logical_neg
id|found
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* test to see if there&squot;s really a lance here */
multiline_comment|/* (CSRO_INIT shouldn&squot;t be readable) */
id|ioaddr_probe
op_assign
(paren
r_volatile
r_int
r_int
op_star
)paren
id|ioaddr
suffix:semicolon
id|tmp1
op_assign
id|ioaddr_probe
(braket
l_int|0
)braket
suffix:semicolon
id|tmp2
op_assign
id|ioaddr_probe
(braket
l_int|1
)braket
suffix:semicolon
id|ioaddr_probe
(braket
l_int|1
)braket
op_assign
id|CSR0
suffix:semicolon
id|ioaddr_probe
(braket
l_int|0
)braket
op_assign
id|CSR0_INIT
op_or
id|CSR0_STOP
suffix:semicolon
r_if
c_cond
(paren
id|ioaddr_probe
(braket
l_int|0
)braket
op_ne
id|CSR0_STOP
)paren
(brace
id|ioaddr_probe
(braket
l_int|0
)braket
op_assign
id|tmp1
suffix:semicolon
id|ioaddr_probe
(braket
l_int|1
)braket
op_assign
id|tmp2
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|init_etherdev
c_func
(paren
id|dev
comma
r_sizeof
(paren
r_struct
id|lance_private
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dev-&gt;priv
)paren
id|dev-&gt;priv
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|lance_private
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
id|lp
op_assign
(paren
r_struct
id|lance_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|MEM
op_assign
(paren
r_struct
id|lance_memory
op_star
)paren
id|sun3_dvma_malloc
c_func
(paren
r_sizeof
(paren
r_struct
id|lance_memory
)paren
)paren
suffix:semicolon
id|lp-&gt;iobase
op_assign
(paren
r_volatile
r_int
r_int
op_star
)paren
id|ioaddr
suffix:semicolon
id|dev-&gt;base_addr
op_assign
(paren
r_int
r_int
)paren
id|ioaddr
suffix:semicolon
multiline_comment|/* informational only */
id|REGA
c_func
(paren
id|CSR0
)paren
op_assign
id|CSR0_STOP
suffix:semicolon
id|request_irq
c_func
(paren
id|LANCE_IRQ
comma
id|lance_interrupt
comma
l_int|0
comma
l_string|&quot;SUN3 Lance&quot;
comma
id|dev
)paren
suffix:semicolon
id|dev-&gt;irq
op_assign
(paren
r_int
r_int
)paren
id|LANCE_IRQ
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;%s: SUN3 Lance at io %#lx, mem %#lx, irq %d, hwaddr &quot;
comma
id|dev-&gt;name
comma
(paren
r_int
r_int
)paren
id|ioaddr
comma
(paren
r_int
r_int
)paren
id|MEM
comma
id|dev-&gt;irq
)paren
suffix:semicolon
multiline_comment|/* copy in the ethernet address from the prom */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|6
suffix:semicolon
id|i
op_increment
)paren
(brace
id|dev-&gt;dev_addr
(braket
id|i
)braket
op_assign
id|idprom-&gt;id_ethaddr
(braket
id|i
)braket
suffix:semicolon
)brace
multiline_comment|/* tell the card it&squot;s ether address, bytes swapped */
id|MEM-&gt;init.hwaddr
(braket
l_int|0
)braket
op_assign
id|dev-&gt;dev_addr
(braket
l_int|1
)braket
suffix:semicolon
id|MEM-&gt;init.hwaddr
(braket
l_int|1
)braket
op_assign
id|dev-&gt;dev_addr
(braket
l_int|0
)braket
suffix:semicolon
id|MEM-&gt;init.hwaddr
(braket
l_int|2
)braket
op_assign
id|dev-&gt;dev_addr
(braket
l_int|3
)braket
suffix:semicolon
id|MEM-&gt;init.hwaddr
(braket
l_int|3
)braket
op_assign
id|dev-&gt;dev_addr
(braket
l_int|2
)braket
suffix:semicolon
id|MEM-&gt;init.hwaddr
(braket
l_int|4
)braket
op_assign
id|dev-&gt;dev_addr
(braket
l_int|5
)braket
suffix:semicolon
id|MEM-&gt;init.hwaddr
(braket
l_int|5
)braket
op_assign
id|dev-&gt;dev_addr
(braket
l_int|4
)braket
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|6
suffix:semicolon
op_increment
id|i
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%02x%s&quot;
comma
id|dev-&gt;dev_addr
(braket
id|i
)braket
comma
(paren
id|i
OL
l_int|5
)paren
ques
c_cond
l_string|&quot;:&quot;
suffix:colon
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
)brace
id|MEM-&gt;init.mode
op_assign
l_int|0x0000
suffix:semicolon
id|MEM-&gt;init.filter
(braket
l_int|0
)braket
op_assign
l_int|0x00000000
suffix:semicolon
id|MEM-&gt;init.filter
(braket
l_int|1
)braket
op_assign
l_int|0x00000000
suffix:semicolon
id|MEM-&gt;init.rdra
op_assign
id|sun3_dvma_vtop
c_func
(paren
id|MEM-&gt;rx_head
)paren
suffix:semicolon
id|MEM-&gt;init.rlen
op_assign
(paren
id|RX_LOG_RING_SIZE
op_lshift
l_int|13
)paren
op_or
(paren
id|sun3_dvma_vtop
c_func
(paren
id|MEM-&gt;rx_head
)paren
op_rshift
l_int|16
)paren
suffix:semicolon
id|MEM-&gt;init.tdra
op_assign
id|sun3_dvma_vtop
c_func
(paren
id|MEM-&gt;tx_head
)paren
suffix:semicolon
id|MEM-&gt;init.tlen
op_assign
(paren
id|TX_LOG_RING_SIZE
op_lshift
l_int|13
)paren
op_or
(paren
id|sun3_dvma_vtop
c_func
(paren
id|MEM-&gt;tx_head
)paren
op_rshift
l_int|16
)paren
suffix:semicolon
id|DPRINTK
c_func
(paren
l_int|2
comma
(paren
l_string|&quot;initaddr: %08lx rx_ring: %08lx tx_ring: %08lx&bslash;n&quot;
comma
id|sun3_dvma_vtop
c_func
(paren
op_amp
(paren
id|MEM-&gt;init
)paren
)paren
comma
id|sun3_dvma_vtop
c_func
(paren
id|MEM-&gt;rx_head
)paren
comma
(paren
id|sun3_dvma_vtop
c_func
(paren
id|MEM-&gt;tx_head
)paren
)paren
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|did_version
op_increment
op_eq
l_int|0
)paren
id|DPRINTK
c_func
(paren
l_int|1
comma
(paren
id|version
)paren
)paren
suffix:semicolon
multiline_comment|/* The LANCE-specific entries in the device structure. */
id|dev-&gt;open
op_assign
op_amp
id|lance_open
suffix:semicolon
id|dev-&gt;hard_start_xmit
op_assign
op_amp
id|lance_start_xmit
suffix:semicolon
id|dev-&gt;stop
op_assign
op_amp
id|lance_close
suffix:semicolon
id|dev-&gt;get_stats
op_assign
op_amp
id|lance_get_stats
suffix:semicolon
id|dev-&gt;set_multicast_list
op_assign
op_amp
id|set_multicast_list
suffix:semicolon
id|dev-&gt;set_mac_address
op_assign
l_int|0
suffix:semicolon
singleline_comment|//&t;KLUDGE -- REMOVE ME
id|set_bit
c_func
(paren
id|__LINK_STATE_PRESENT
comma
op_amp
id|dev-&gt;state
)paren
suffix:semicolon
id|memset
c_func
(paren
op_amp
id|lp-&gt;stats
comma
l_int|0
comma
r_sizeof
(paren
id|lp-&gt;stats
)paren
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
DECL|function|lance_open
r_static
r_int
id|lance_open
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|lance_private
op_star
id|lp
op_assign
(paren
r_struct
id|lance_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_int
id|i
suffix:semicolon
id|DPRINTK
c_func
(paren
l_int|2
comma
(paren
l_string|&quot;%s: lance_open()&bslash;n&quot;
comma
id|dev-&gt;name
)paren
)paren
suffix:semicolon
id|REGA
c_func
(paren
id|CSR0
)paren
op_assign
id|CSR0_STOP
suffix:semicolon
multiline_comment|/* tell the lance the address of its init block */
id|REGA
c_func
(paren
id|CSR1
)paren
op_assign
id|sun3_dvma_vtop
c_func
(paren
op_amp
(paren
id|MEM-&gt;init
)paren
)paren
suffix:semicolon
id|REGA
c_func
(paren
id|CSR2
)paren
op_assign
id|sun3_dvma_vtop
c_func
(paren
op_amp
(paren
id|MEM-&gt;init
)paren
)paren
op_rshift
l_int|16
suffix:semicolon
id|lance_init_ring
c_func
(paren
id|dev
)paren
suffix:semicolon
multiline_comment|/* Re-initialize the LANCE, and start it when done. */
id|REGA
c_func
(paren
id|CSR3
)paren
op_assign
id|CSR3_BSWP
suffix:semicolon
multiline_comment|/* From now on, AREG is kept to point to CSR0 */
id|REGA
c_func
(paren
id|CSR0
)paren
op_assign
id|CSR0_INIT
suffix:semicolon
id|i
op_assign
l_int|1000000
suffix:semicolon
r_while
c_loop
(paren
op_decrement
id|i
OG
l_int|0
)paren
r_if
c_cond
(paren
id|DREG
op_amp
id|CSR0_IDON
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
id|i
OL
l_int|0
op_logical_or
(paren
id|DREG
op_amp
id|CSR0_ERR
)paren
)paren
(brace
id|DPRINTK
c_func
(paren
l_int|2
comma
(paren
l_string|&quot;lance_open(): opening %s failed, i=%d, csr0=%04x&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|i
comma
id|DREG
)paren
)paren
suffix:semicolon
id|DREG
op_assign
id|CSR0_STOP
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
id|DREG
op_assign
id|CSR0_IDON
op_or
id|CSR0_STRT
op_or
id|CSR0_INEA
suffix:semicolon
id|netif_start_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
id|DPRINTK
c_func
(paren
l_int|2
comma
(paren
l_string|&quot;%s: LANCE is open, csr0 %04x&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|DREG
)paren
)paren
suffix:semicolon
id|MOD_INC_USE_COUNT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Initialize the LANCE Rx and Tx rings. */
DECL|function|lance_init_ring
r_static
r_void
id|lance_init_ring
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|lance_private
op_star
id|lp
op_assign
(paren
r_struct
id|lance_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_int
id|i
suffix:semicolon
id|lp-&gt;lock
op_assign
l_int|0
suffix:semicolon
id|lp-&gt;tx_full
op_assign
l_int|0
suffix:semicolon
id|lp-&gt;new_rx
op_assign
id|lp-&gt;new_tx
op_assign
l_int|0
suffix:semicolon
id|lp-&gt;old_rx
op_assign
id|lp-&gt;old_tx
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|TX_RING_SIZE
suffix:semicolon
id|i
op_increment
)paren
(brace
id|MEM-&gt;tx_head
(braket
id|i
)braket
dot
id|base
op_assign
id|sun3_dvma_vtop
c_func
(paren
id|MEM-&gt;tx_data
(braket
id|i
)braket
)paren
suffix:semicolon
id|MEM-&gt;tx_head
(braket
id|i
)braket
dot
id|flag
op_assign
l_int|0
suffix:semicolon
id|MEM-&gt;tx_head
(braket
id|i
)braket
dot
id|base_hi
op_assign
(paren
id|sun3_dvma_vtop
c_func
(paren
id|MEM-&gt;tx_data
(braket
id|i
)braket
)paren
)paren
op_rshift
l_int|16
suffix:semicolon
id|MEM-&gt;tx_head
(braket
id|i
)braket
dot
id|length
op_assign
l_int|0
suffix:semicolon
id|MEM-&gt;tx_head
(braket
id|i
)braket
dot
id|misc
op_assign
l_int|0
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|RX_RING_SIZE
suffix:semicolon
id|i
op_increment
)paren
(brace
id|MEM-&gt;rx_head
(braket
id|i
)braket
dot
id|base
op_assign
id|sun3_dvma_vtop
c_func
(paren
id|MEM-&gt;rx_data
(braket
id|i
)braket
)paren
suffix:semicolon
id|MEM-&gt;rx_head
(braket
id|i
)braket
dot
id|flag
op_assign
id|TMD1_OWN_CHIP
suffix:semicolon
id|MEM-&gt;rx_head
(braket
id|i
)braket
dot
id|base_hi
op_assign
(paren
id|sun3_dvma_vtop
c_func
(paren
id|MEM-&gt;rx_data
(braket
id|i
)braket
)paren
)paren
op_rshift
l_int|16
suffix:semicolon
id|MEM-&gt;rx_head
(braket
id|i
)braket
dot
id|buf_length
op_assign
op_minus
id|PKT_BUF_SZ
op_or
l_int|0xf000
suffix:semicolon
id|MEM-&gt;rx_head
(braket
id|i
)braket
dot
id|msg_length
op_assign
l_int|0
suffix:semicolon
)brace
)brace
DECL|function|lance_start_xmit
r_static
r_int
id|lance_start_xmit
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|lance_private
op_star
id|lp
op_assign
(paren
r_struct
id|lance_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_int
id|entry
comma
id|len
suffix:semicolon
r_struct
id|lance_tx_head
op_star
id|head
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
multiline_comment|/* Transmitter timeout, serious problems. */
r_if
c_cond
(paren
id|netif_queue_stopped
c_func
(paren
id|dev
)paren
)paren
(brace
r_int
id|tickssofar
op_assign
id|jiffies
op_minus
id|dev-&gt;trans_start
suffix:semicolon
r_if
c_cond
(paren
id|tickssofar
OL
l_int|20
)paren
r_return
l_int|1
suffix:semicolon
id|DPRINTK
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;%s: transmit timed out, status %04x, resetting.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|DREG
)paren
)paren
suffix:semicolon
id|DREG
op_assign
id|CSR0_STOP
suffix:semicolon
multiline_comment|/*&n;&t;&t; * Always set BSWP after a STOP as STOP puts it back into&n;&t;&t; * little endian mode.&n;&t;&t; */
id|REGA
c_func
(paren
id|CSR3
)paren
op_assign
id|CSR3_BSWP
suffix:semicolon
id|lp-&gt;stats.tx_errors
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|lance_debug
op_ge
l_int|2
)paren
(brace
r_int
id|i
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;Ring data: old_tx %d new_tx %d%s new_rx %d&bslash;n&quot;
comma
id|lp-&gt;old_tx
comma
id|lp-&gt;new_tx
comma
id|lp-&gt;tx_full
ques
c_cond
l_string|&quot; (full)&quot;
suffix:colon
l_string|&quot;&quot;
comma
id|lp-&gt;new_rx
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|RX_RING_SIZE
suffix:semicolon
id|i
op_increment
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;rx #%d: base=%04x blen=%04x mlen=%04x&bslash;n&quot;
comma
id|i
comma
id|MEM-&gt;rx_head
(braket
id|i
)braket
dot
id|base
comma
op_minus
id|MEM-&gt;rx_head
(braket
id|i
)braket
dot
id|buf_length
comma
id|MEM-&gt;rx_head
(braket
id|i
)braket
dot
id|msg_length
)paren
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|TX_RING_SIZE
suffix:semicolon
id|i
op_increment
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;tx #%d: base=%04x len=%04x misc=%04x&bslash;n&quot;
comma
id|i
comma
id|MEM-&gt;tx_head
(braket
id|i
)braket
dot
id|base
comma
op_minus
id|MEM-&gt;tx_head
(braket
id|i
)braket
dot
id|length
comma
id|MEM-&gt;tx_head
(braket
id|i
)braket
dot
id|misc
)paren
suffix:semicolon
)brace
)brace
id|lance_init_ring
c_func
(paren
id|dev
)paren
suffix:semicolon
id|REGA
c_func
(paren
id|CSR0
)paren
op_assign
id|CSR0_INEA
op_or
id|CSR0_INIT
op_or
id|CSR0_STRT
suffix:semicolon
id|netif_start_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
id|dev-&gt;trans_start
op_assign
id|jiffies
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Block a timer-based transmit from overlapping.  This could better be&n;&t;   done with atomic_swap(1, dev-&gt;tbusy), but set_bit() works as well. */
multiline_comment|/* Block a timer-based transmit from overlapping with us by&n;&t;   stopping the queue for a bit... */
id|netif_stop_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|test_and_set_bit
c_func
(paren
l_int|0
comma
(paren
r_void
op_star
)paren
op_amp
id|lp-&gt;lock
)paren
op_ne
l_int|0
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%s: tx queue lock!.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
multiline_comment|/* don&squot;t clear dev-&gt;tbusy flag. */
r_return
l_int|1
suffix:semicolon
)brace
id|AREG
op_assign
id|CSR0
suffix:semicolon
singleline_comment|//&t;DPRINTK( 2, ( &quot;%s: lance_start_xmit() called, csr0 %4.4x.&bslash;n&quot;,
singleline_comment|//&t;&t;&t;&t;  dev-&gt;name, DREG ));
multiline_comment|/* Fill in a Tx ring entry */
macro_line|#if 0
r_if
c_cond
(paren
id|lance_debug
op_ge
l_int|3
)paren
(brace
id|u_char
op_star
id|p
suffix:semicolon
r_int
id|i
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;%s: TX pkt %d type 0x%04x from &quot;
comma
id|dev-&gt;name
comma
id|lp-&gt;new_tx
comma
(paren
(paren
id|u_short
op_star
)paren
id|skb-&gt;data
)paren
(braket
l_int|6
)braket
)paren
suffix:semicolon
r_for
c_loop
(paren
id|p
op_assign
op_amp
(paren
(paren
id|u_char
op_star
)paren
id|skb-&gt;data
)paren
(braket
l_int|6
)braket
comma
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|6
suffix:semicolon
id|i
op_increment
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%02x%s&quot;
comma
op_star
id|p
op_increment
comma
id|i
op_ne
l_int|5
ques
c_cond
l_string|&quot;:&quot;
suffix:colon
l_string|&quot;&quot;
)paren
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot; to &quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|p
op_assign
(paren
id|u_char
op_star
)paren
id|skb-&gt;data
comma
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|6
suffix:semicolon
id|i
op_increment
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%02x%s&quot;
comma
op_star
id|p
op_increment
comma
id|i
op_ne
l_int|5
ques
c_cond
l_string|&quot;:&quot;
suffix:colon
l_string|&quot;&quot;
)paren
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot; data at 0x%08x len %d&bslash;n&quot;
comma
(paren
r_int
)paren
id|skb-&gt;data
comma
(paren
r_int
)paren
id|skb-&gt;len
)paren
suffix:semicolon
)brace
macro_line|#endif&t;
multiline_comment|/* We&squot;re not prepared for the int until the last flags are set/reset.&n;&t; * And the int may happen already after setting the OWN_CHIP... */
id|save_and_cli
c_func
(paren
id|flags
)paren
suffix:semicolon
multiline_comment|/* Mask to ring buffer boundary. */
id|entry
op_assign
id|lp-&gt;new_tx
suffix:semicolon
id|head
op_assign
op_amp
(paren
id|MEM-&gt;tx_head
(braket
id|entry
)braket
)paren
suffix:semicolon
multiline_comment|/* Caution: the write order is important here, set the &quot;ownership&quot; bits&n;&t; * last.&n;&t; */
multiline_comment|/* the sun3&squot;s lance needs it&squot;s buffer padded to the minimum&n;&t;   size */
id|len
op_assign
(paren
id|ETH_ZLEN
OL
id|skb-&gt;len
)paren
ques
c_cond
id|skb-&gt;len
suffix:colon
id|ETH_ZLEN
suffix:semicolon
singleline_comment|//&t;head-&gt;length = -len;
id|head-&gt;length
op_assign
(paren
op_minus
id|len
)paren
op_or
l_int|0xf000
suffix:semicolon
id|head-&gt;misc
op_assign
l_int|0
suffix:semicolon
id|memcpy
c_func
(paren
id|PKTBUF_ADDR
c_func
(paren
id|head
)paren
comma
(paren
r_void
op_star
)paren
id|skb-&gt;data
comma
id|skb-&gt;len
)paren
suffix:semicolon
id|head-&gt;flag
op_assign
id|TMD1_OWN_CHIP
op_or
id|TMD1_ENP
op_or
id|TMD1_STP
suffix:semicolon
id|lp-&gt;new_tx
op_assign
(paren
id|lp-&gt;new_tx
op_plus
l_int|1
)paren
op_amp
id|TX_RING_MOD_MASK
suffix:semicolon
id|lp-&gt;stats.tx_bytes
op_add_assign
id|skb-&gt;len
suffix:semicolon
multiline_comment|/* Trigger an immediate send poll. */
id|REGA
c_func
(paren
id|CSR0
)paren
op_assign
id|CSR0_INEA
op_or
id|CSR0_TDMD
suffix:semicolon
id|dev-&gt;trans_start
op_assign
id|jiffies
suffix:semicolon
id|dev_kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
id|lp-&gt;lock
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
(paren
id|MEM-&gt;tx_head
(braket
(paren
id|entry
op_plus
l_int|1
)paren
op_amp
id|TX_RING_MOD_MASK
)braket
dot
id|flag
op_amp
id|TMD1_OWN
)paren
op_eq
id|TMD1_OWN_HOST
)paren
id|netif_start_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* The LANCE interrupt handler. */
DECL|function|lance_interrupt
r_static
r_void
id|lance_interrupt
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|fp
)paren
(brace
r_struct
id|net_device
op_star
id|dev
op_assign
id|dev_id
suffix:semicolon
r_struct
id|lance_private
op_star
id|lp
op_assign
id|dev-&gt;priv
suffix:semicolon
r_int
id|csr0
suffix:semicolon
r_static
r_int
id|in_interrupt
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|dev
op_eq
l_int|NULL
)paren
(brace
id|DPRINTK
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;lance_interrupt(): invalid dev_id&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|in_interrupt
)paren
id|DPRINTK
c_func
(paren
l_int|2
comma
(paren
l_string|&quot;%s: Re-entering the interrupt handler.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
)paren
suffix:semicolon
id|in_interrupt
op_assign
l_int|1
suffix:semicolon
id|still_more
suffix:colon
id|AREG
op_assign
id|CSR0
suffix:semicolon
id|csr0
op_assign
id|DREG
suffix:semicolon
multiline_comment|/* ack interrupts */
id|DREG
op_assign
id|csr0
op_amp
(paren
id|CSR0_TINT
op_or
id|CSR0_RINT
)paren
suffix:semicolon
multiline_comment|/* clear errors */
r_if
c_cond
(paren
id|csr0
op_amp
id|CSR0_ERR
)paren
(brace
id|DREG
op_assign
id|CSR0_BABL
op_or
id|CSR0_MERR
op_or
id|CSR0_CERR
op_or
id|CSR0_MISS
suffix:semicolon
)brace
id|DPRINTK
c_func
(paren
l_int|2
comma
(paren
l_string|&quot;%s: interrupt  csr0=%04x new csr=%04x.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|csr0
comma
id|DREG
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|csr0
op_amp
id|CSR0_TINT
)paren
(brace
multiline_comment|/* Tx-done interrupt */
r_int
id|old_tx
op_assign
id|lp-&gt;old_tx
suffix:semicolon
singleline_comment|//&t;&t;if(lance_debug &gt;= 3) {
singleline_comment|//&t;&t;&t;int i;
singleline_comment|//&t;&t;&t;
singleline_comment|//&t;&t;&t;printk(&quot;%s: tx int&bslash;n&quot;, dev-&gt;name);
singleline_comment|//&t;&t;&t;
singleline_comment|//&t;&t;&t;for(i = 0; i &lt; TX_RING_SIZE; i++)
singleline_comment|//&t;&t;&t;&t;printk(&quot;ring %d flag=%04x&bslash;n&quot;, i,
singleline_comment|//&t;&t;&t;&t;       MEM-&gt;tx_head[i].flag);
singleline_comment|//&t;&t;}
r_while
c_loop
(paren
id|old_tx
op_ne
id|lp-&gt;new_tx
)paren
(brace
r_struct
id|lance_tx_head
op_star
id|head
op_assign
op_amp
(paren
id|MEM-&gt;tx_head
(braket
id|old_tx
)braket
)paren
suffix:semicolon
id|DPRINTK
c_func
(paren
l_int|3
comma
(paren
l_string|&quot;on tx_ring %d&bslash;n&quot;
comma
id|old_tx
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|head-&gt;flag
op_amp
id|TMD1_OWN_CHIP
)paren
r_break
suffix:semicolon
multiline_comment|/* It still hasn&squot;t been Txed */
r_if
c_cond
(paren
id|head-&gt;flag
op_amp
id|TMD1_ERR
)paren
(brace
r_int
id|status
op_assign
id|head-&gt;misc
suffix:semicolon
id|lp-&gt;stats.tx_errors
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
id|TMD3_RTRY
)paren
id|lp-&gt;stats.tx_aborted_errors
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
id|TMD3_LCAR
)paren
id|lp-&gt;stats.tx_carrier_errors
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
id|TMD3_LCOL
)paren
id|lp-&gt;stats.tx_window_errors
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
(paren
id|TMD3_UFLO
op_or
id|TMD3_BUFF
)paren
)paren
(brace
id|lp-&gt;stats.tx_fifo_errors
op_increment
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;%s: Tx FIFO error&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|REGA
c_func
(paren
id|CSR0
)paren
op_assign
id|CSR0_STOP
suffix:semicolon
id|REGA
c_func
(paren
id|CSR3
)paren
op_assign
id|CSR3_BSWP
suffix:semicolon
id|lance_init_ring
c_func
(paren
id|dev
)paren
suffix:semicolon
id|REGA
c_func
(paren
id|CSR0
)paren
op_assign
id|CSR0_STRT
op_or
id|CSR0_INEA
suffix:semicolon
r_return
suffix:semicolon
)brace
)brace
r_else
r_if
c_cond
(paren
id|head-&gt;flag
op_amp
(paren
id|TMD1_ENP
op_or
id|TMD1_STP
)paren
)paren
(brace
id|head-&gt;flag
op_and_assign
op_complement
(paren
id|TMD1_ENP
op_or
id|TMD1_STP
)paren
suffix:semicolon
r_if
c_cond
(paren
id|head-&gt;flag
op_amp
(paren
id|TMD1_ONE
op_or
id|TMD1_MORE
)paren
)paren
(brace
id|lp-&gt;stats.collisions
op_increment
suffix:semicolon
)brace
id|lp-&gt;stats.tx_packets
op_increment
suffix:semicolon
id|DPRINTK
c_func
(paren
l_int|3
comma
(paren
l_string|&quot;cleared tx ring %d&bslash;n&quot;
comma
id|old_tx
)paren
)paren
suffix:semicolon
)brace
id|old_tx
op_assign
(paren
id|old_tx
op_plus
l_int|1
)paren
op_amp
id|TX_RING_MOD_MASK
suffix:semicolon
)brace
id|lp-&gt;old_tx
op_assign
id|old_tx
suffix:semicolon
)brace
r_if
c_cond
(paren
id|netif_queue_stopped
c_func
(paren
id|dev
)paren
)paren
(brace
multiline_comment|/* The ring is no longer full, clear tbusy. */
id|netif_start_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
id|netif_wake_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|csr0
op_amp
id|CSR0_RINT
)paren
multiline_comment|/* Rx interrupt */
id|lance_rx
c_func
(paren
id|dev
)paren
suffix:semicolon
multiline_comment|/* Log misc errors. */
r_if
c_cond
(paren
id|csr0
op_amp
id|CSR0_BABL
)paren
id|lp-&gt;stats.tx_errors
op_increment
suffix:semicolon
multiline_comment|/* Tx babble. */
r_if
c_cond
(paren
id|csr0
op_amp
id|CSR0_MISS
)paren
id|lp-&gt;stats.rx_errors
op_increment
suffix:semicolon
multiline_comment|/* Missed a Rx frame. */
r_if
c_cond
(paren
id|csr0
op_amp
id|CSR0_MERR
)paren
(brace
id|DPRINTK
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;%s: Bus master arbitration failure (?!?), &quot;
l_string|&quot;status %04x.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|csr0
)paren
)paren
suffix:semicolon
multiline_comment|/* Restart the chip. */
id|REGA
c_func
(paren
id|CSR0
)paren
op_assign
id|CSR0_STOP
suffix:semicolon
id|REGA
c_func
(paren
id|CSR3
)paren
op_assign
id|CSR3_BSWP
suffix:semicolon
id|lance_init_ring
c_func
(paren
id|dev
)paren
suffix:semicolon
id|REGA
c_func
(paren
id|CSR0
)paren
op_assign
id|CSR0_STRT
op_or
id|CSR0_INEA
suffix:semicolon
)brace
multiline_comment|/* Clear any other interrupt, and set interrupt enable. */
singleline_comment|//&t;DREG = CSR0_BABL | CSR0_CERR | CSR0_MISS | CSR0_MERR |
singleline_comment|//&t;&t;   CSR0_IDON | CSR0_INEA;
id|REGA
c_func
(paren
id|CSR0
)paren
op_assign
id|CSR0_INEA
suffix:semicolon
r_if
c_cond
(paren
id|DREG
op_amp
(paren
id|CSR0_RINT
op_or
id|CSR0_TINT
)paren
)paren
(brace
id|DPRINTK
c_func
(paren
l_int|2
comma
(paren
l_string|&quot;restarting interrupt, csr0=%#04x&bslash;n&quot;
comma
id|DREG
)paren
)paren
suffix:semicolon
r_goto
id|still_more
suffix:semicolon
)brace
id|DPRINTK
c_func
(paren
l_int|2
comma
(paren
l_string|&quot;%s: exiting interrupt, csr0=%#04x.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|DREG
)paren
)paren
suffix:semicolon
id|in_interrupt
op_assign
l_int|0
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/* get packet, toss into skbuff */
DECL|function|lance_rx
r_static
r_int
id|lance_rx
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|lance_private
op_star
id|lp
op_assign
(paren
r_struct
id|lance_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_int
id|entry
op_assign
id|lp-&gt;new_rx
suffix:semicolon
multiline_comment|/* If we own the next entry, it&squot;s a new packet. Send it up. */
r_while
c_loop
(paren
(paren
id|MEM-&gt;rx_head
(braket
id|entry
)braket
dot
id|flag
op_amp
id|RMD1_OWN
)paren
op_eq
id|RMD1_OWN_HOST
)paren
(brace
r_struct
id|lance_rx_head
op_star
id|head
op_assign
op_amp
(paren
id|MEM-&gt;rx_head
(braket
id|entry
)braket
)paren
suffix:semicolon
r_int
id|status
op_assign
id|head-&gt;flag
suffix:semicolon
r_if
c_cond
(paren
id|status
op_ne
(paren
id|RMD1_ENP
op_or
id|RMD1_STP
)paren
)paren
(brace
multiline_comment|/* There was an error. */
multiline_comment|/* There is a tricky error noted by John Murphy,&n;&t;&t;&t;   &lt;murf@perftech.com&gt; to Russ Nelson: Even with &n;&t;&t;&t;   full-sized buffers it&squot;s possible for a jabber packet to use two&n;&t;&t;&t;   buffers, with only the last correctly noting the error. */
r_if
c_cond
(paren
id|status
op_amp
id|RMD1_ENP
)paren
multiline_comment|/* Only count a general error at the */
id|lp-&gt;stats.rx_errors
op_increment
suffix:semicolon
multiline_comment|/* end of a packet.*/
r_if
c_cond
(paren
id|status
op_amp
id|RMD1_FRAM
)paren
id|lp-&gt;stats.rx_frame_errors
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
id|RMD1_OFLO
)paren
id|lp-&gt;stats.rx_over_errors
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
id|RMD1_CRC
)paren
id|lp-&gt;stats.rx_crc_errors
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
id|RMD1_BUFF
)paren
id|lp-&gt;stats.rx_fifo_errors
op_increment
suffix:semicolon
id|head-&gt;flag
op_and_assign
(paren
id|RMD1_ENP
op_or
id|RMD1_STP
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* Malloc up new buffer, compatible with net-3. */
singleline_comment|//&t;&t;&t;short pkt_len = head-&gt;msg_length;// &amp; 0xfff;
r_int
id|pkt_len
op_assign
(paren
id|head-&gt;msg_length
op_amp
l_int|0xfff
)paren
op_minus
l_int|4
suffix:semicolon
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
r_if
c_cond
(paren
id|pkt_len
OL
l_int|60
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%s: Runt packet!&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|lp-&gt;stats.rx_errors
op_increment
suffix:semicolon
)brace
r_else
(brace
id|skb
op_assign
id|dev_alloc_skb
c_func
(paren
id|pkt_len
op_plus
l_int|2
)paren
suffix:semicolon
r_if
c_cond
(paren
id|skb
op_eq
l_int|NULL
)paren
(brace
id|DPRINTK
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;%s: Memory squeeze, deferring packet.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
)paren
suffix:semicolon
id|lp-&gt;stats.rx_dropped
op_increment
suffix:semicolon
id|head-&gt;msg_length
op_assign
l_int|0
suffix:semicolon
id|head-&gt;flag
op_or_assign
id|RMD1_OWN_CHIP
suffix:semicolon
id|lp-&gt;new_rx
op_assign
(paren
id|lp-&gt;new_rx
op_plus
l_int|1
)paren
op_amp
id|RX_RING_MOD_MASK
suffix:semicolon
)brace
macro_line|#if 0
r_if
c_cond
(paren
id|lance_debug
op_ge
l_int|3
)paren
(brace
id|u_char
op_star
id|data
op_assign
id|PKTBUF_ADDR
c_func
(paren
id|head
)paren
comma
op_star
id|p
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;%s: RX pkt %d type 0x%04x from &quot;
comma
id|dev-&gt;name
comma
id|entry
comma
(paren
(paren
id|u_short
op_star
)paren
id|data
)paren
(braket
l_int|6
)braket
)paren
suffix:semicolon
r_for
c_loop
(paren
id|p
op_assign
op_amp
id|data
(braket
l_int|6
)braket
comma
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|6
suffix:semicolon
id|i
op_increment
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%02x%s&quot;
comma
op_star
id|p
op_increment
comma
id|i
op_ne
l_int|5
ques
c_cond
l_string|&quot;:&quot;
suffix:colon
l_string|&quot;&quot;
)paren
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot; to &quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|p
op_assign
id|data
comma
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|6
suffix:semicolon
id|i
op_increment
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%02x%s&quot;
comma
op_star
id|p
op_increment
comma
id|i
op_ne
l_int|5
ques
c_cond
l_string|&quot;:&quot;
suffix:colon
l_string|&quot;&quot;
)paren
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot; data %02x %02x %02x %02x %02x %02x %02x %02x &quot;
l_string|&quot;len %d at %08x&bslash;n&quot;
comma
id|data
(braket
l_int|15
)braket
comma
id|data
(braket
l_int|16
)braket
comma
id|data
(braket
l_int|17
)braket
comma
id|data
(braket
l_int|18
)braket
comma
id|data
(braket
l_int|19
)braket
comma
id|data
(braket
l_int|20
)braket
comma
id|data
(braket
l_int|21
)braket
comma
id|data
(braket
l_int|22
)braket
comma
id|pkt_len
comma
id|data
)paren
suffix:semicolon
)brace
macro_line|#endif
r_if
c_cond
(paren
id|lance_debug
op_ge
l_int|3
)paren
(brace
id|u_char
op_star
id|data
op_assign
id|PKTBUF_ADDR
c_func
(paren
id|head
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;%s: RX pkt %d type 0x%04x len %d&bslash;n &quot;
comma
id|dev-&gt;name
comma
id|entry
comma
(paren
(paren
id|u_short
op_star
)paren
id|data
)paren
(braket
l_int|6
)braket
comma
id|pkt_len
)paren
suffix:semicolon
)brace
id|skb-&gt;dev
op_assign
id|dev
suffix:semicolon
id|skb_reserve
c_func
(paren
id|skb
comma
l_int|2
)paren
suffix:semicolon
multiline_comment|/* 16 byte align */
id|skb_put
c_func
(paren
id|skb
comma
id|pkt_len
)paren
suffix:semicolon
multiline_comment|/* Make room */
singleline_comment|//&t;&t;&t;        memcpy( skb-&gt;data, PKTBUF_ADDR(head), pkt_len );
id|eth_copy_and_sum
c_func
(paren
id|skb
comma
id|PKTBUF_ADDR
c_func
(paren
id|head
)paren
comma
id|pkt_len
comma
l_int|0
)paren
suffix:semicolon
id|skb-&gt;protocol
op_assign
id|eth_type_trans
c_func
(paren
id|skb
comma
id|dev
)paren
suffix:semicolon
id|netif_rx
c_func
(paren
id|skb
)paren
suffix:semicolon
id|lp-&gt;stats.rx_packets
op_increment
suffix:semicolon
id|lp-&gt;stats.rx_bytes
op_add_assign
id|skb-&gt;len
suffix:semicolon
)brace
)brace
singleline_comment|//&t;&t;head-&gt;buf_length = -PKT_BUF_SZ | 0xf000;
id|head-&gt;msg_length
op_assign
l_int|0
suffix:semicolon
id|head-&gt;flag
op_assign
id|RMD1_OWN_CHIP
suffix:semicolon
id|entry
op_assign
id|lp-&gt;new_rx
op_assign
(paren
id|lp-&gt;new_rx
op_plus
l_int|1
)paren
op_amp
id|RX_RING_MOD_MASK
suffix:semicolon
)brace
multiline_comment|/* From lance.c (Donald Becker): */
multiline_comment|/* We should check that at least two ring entries are free.&n;&t;   If not, we should free one and mark stats-&gt;rx_dropped++. */
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|lance_close
r_static
r_int
id|lance_close
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|lance_private
op_star
id|lp
op_assign
(paren
r_struct
id|lance_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|netif_stop_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
id|AREG
op_assign
id|CSR0
suffix:semicolon
id|DPRINTK
c_func
(paren
l_int|2
comma
(paren
l_string|&quot;%s: Shutting down ethercard, status was %2.2x.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|DREG
)paren
)paren
suffix:semicolon
multiline_comment|/* We stop the LANCE here -- it occasionally polls&n;&t;   memory if we don&squot;t. */
id|DREG
op_assign
id|CSR0_STOP
suffix:semicolon
id|MOD_DEC_USE_COUNT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|lance_get_stats
r_static
r_struct
id|net_device_stats
op_star
id|lance_get_stats
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|lance_private
op_star
id|lp
op_assign
(paren
r_struct
id|lance_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_return
op_amp
id|lp-&gt;stats
suffix:semicolon
)brace
multiline_comment|/* Set or clear the multicast filter for this adaptor.&n;   num_addrs == -1&t;&t;Promiscuous mode, receive all packets&n;   num_addrs == 0&t;&t;Normal mode, clear multicast list&n;   num_addrs &gt; 0&t;&t;Multicast mode, receive normal and MC packets, and do&n;&t;&t;&t;&t;&t;&t;best-effort filtering.&n; */
multiline_comment|/* completely untested on a sun3 */
DECL|function|set_multicast_list
r_static
r_void
id|set_multicast_list
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|lance_private
op_star
id|lp
op_assign
(paren
r_struct
id|lance_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_if
c_cond
(paren
id|netif_queue_stopped
c_func
(paren
id|dev
)paren
)paren
(brace
multiline_comment|/* Only possible if board is already started */
r_return
suffix:semicolon
)brace
multiline_comment|/* We take the simple way out and always enable promiscuous mode. */
id|DREG
op_assign
id|CSR0_STOP
suffix:semicolon
multiline_comment|/* Temporarily stop the lance. */
r_if
c_cond
(paren
id|dev-&gt;flags
op_amp
id|IFF_PROMISC
)paren
(brace
multiline_comment|/* Log any net taps. */
id|DPRINTK
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;%s: Promiscuous mode enabled.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
)paren
suffix:semicolon
id|REGA
c_func
(paren
id|CSR15
)paren
op_assign
l_int|0x8000
suffix:semicolon
multiline_comment|/* Set promiscuous mode */
)brace
r_else
(brace
r_int
id|multicast_table
(braket
l_int|4
)braket
suffix:semicolon
r_int
id|num_addrs
op_assign
id|dev-&gt;mc_count
suffix:semicolon
r_int
id|i
suffix:semicolon
multiline_comment|/* We don&squot;t use the multicast table, but rely on upper-layer&n;&t;&t; * filtering. */
id|memset
c_func
(paren
id|multicast_table
comma
(paren
id|num_addrs
op_eq
l_int|0
)paren
ques
c_cond
l_int|0
suffix:colon
op_minus
l_int|1
comma
r_sizeof
(paren
id|multicast_table
)paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|4
suffix:semicolon
id|i
op_increment
)paren
(brace
id|REGA
c_func
(paren
id|CSR8
op_plus
id|i
)paren
op_assign
id|multicast_table
(braket
id|i
)braket
suffix:semicolon
)brace
id|REGA
c_func
(paren
id|CSR15
)paren
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Unset promiscuous mode */
)brace
multiline_comment|/*&n;&t; * Always set BSWP after a STOP as STOP puts it back into&n;&t; * little endian mode.&n;&t; */
id|REGA
c_func
(paren
id|CSR3
)paren
op_assign
id|CSR3_BSWP
suffix:semicolon
multiline_comment|/* Resume normal operation and reset AREG to CSR0 */
id|REGA
c_func
(paren
id|CSR0
)paren
op_assign
id|CSR0_IDON
op_or
id|CSR0_INEA
op_or
id|CSR0_STRT
suffix:semicolon
)brace
macro_line|#ifdef MODULE
DECL|variable|devicename
r_static
r_char
id|devicename
(braket
l_int|9
)braket
op_assign
(brace
l_int|0
comma
)brace
suffix:semicolon
DECL|variable|sun3lance_dev
r_static
r_struct
id|net_device
id|sun3lance_dev
op_assign
(brace
id|devicename
comma
multiline_comment|/* filled in by register_netdev() */
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
multiline_comment|/* memory */
l_int|0
comma
l_int|0
comma
multiline_comment|/* base, irq */
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|NULL
comma
id|sun3lance_probe
comma
)brace
suffix:semicolon
DECL|function|init_module
r_int
id|init_module
c_func
(paren
r_void
)paren
(brace
r_int
id|err
suffix:semicolon
r_if
c_cond
(paren
(paren
id|err
op_assign
id|register_netdev
c_func
(paren
op_amp
id|sun3lance_dev
)paren
)paren
)paren
(brace
r_if
c_cond
(paren
id|err
op_eq
op_minus
id|EIO
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;SUN3 Lance not detected.  Module not loaded.&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_return
id|err
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|cleanup_module
r_void
id|cleanup_module
c_func
(paren
r_void
)paren
(brace
id|unregister_netdev
c_func
(paren
op_amp
id|sun3lance_dev
)paren
suffix:semicolon
)brace
macro_line|#endif /* MODULE */
eof
