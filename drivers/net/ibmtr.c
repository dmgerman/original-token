multiline_comment|/* ibmtr.c:  A shared-memory IBM Token Ring 16/4 driver for linux */
multiline_comment|/*&n;&t;Written 1993 by Mark Swanson and Peter De Schrijver.&n;&t;This software may be used and distributed according to the terms&n;&t;of the GNU Public License, incorporated herein by reference.&n;&n;&t;This device driver should work with Any IBM Token Ring Card that does&n;   not use DMA.&n;&n;&t;I used Donald Becker&squot;s (becker@super.org) device driver work&n;&t;as a base for most of my initial work.&n;*/
multiline_comment|/*&n;   Changes by Peter De Schrijver (Peter.Deschrijver@linux.cc.kuleuven.ac.be) :&n;&t;&n;&t;+ changed name to ibmtr.c in anticipation of other tr boards.&n;&t;+ changed reset code and adapter open code.&n;&t;+ added SAP open code.&n;&t;+ a first attempt to write interrupt, transmit and receive routines.&n;&n;   Changes by David W. Morris (dwm@shell.portal.com) :&n;     941003 dwm: - Restructure tok_probe for multiple adapters, devices&n;                 - Add comments, misc reorg for clarity&n;                 - Flatten interrupt handler levels&n;&n;   Changes by Farzad Farid (farzy@zen.via.ecp.fr)&n;   and Pascal Andre (andre@chimay.via.ecp.fr) (March 9 1995) :&n;        - multi ring support clean up&n;        - RFC1042 compliance enhanced&n;&n;   Changes by Pascal Andre (andre@chimay.via.ecp.fr) (September 7 1995) :&n;        - bug correction in tr_tx&n;        - removed redundant information display&n;        - some code reworking&n;&n;   Warnings !!!!!!!!!!!!!!&n;      This driver is only partially sanitized for support of multiple&n;      adapters.  It will almost definately fail if more than one&n;      active adapter is identified.&n;*/
macro_line|#include &lt;linux/module.h&gt;
DECL|macro|NO_AUTODETECT
mdefine_line|#define NO_AUTODETECT 1
DECL|macro|NO_AUTODETECT
macro_line|#undef NO_AUTODETECT
DECL|macro|ENABLE_PAGING
macro_line|#undef ENABLE_PAGING
DECL|macro|FALSE
mdefine_line|#define FALSE 0
DECL|macro|TRUE
mdefine_line|#define TRUE (!FALSE)
multiline_comment|/* changes the output format of driver initialisation */
DECL|macro|TR_NEWFORMAT
mdefine_line|#define TR_NEWFORMAT&t;1
multiline_comment|/* some 95 OS send many non UI frame; this allow removing the warning */
DECL|macro|TR_FILTERNONUI
mdefine_line|#define TR_FILTERNONUI&t;1
multiline_comment|/* version and credits */
DECL|variable|version
r_static
r_const
r_char
op_star
id|version
op_assign
l_string|&quot;ibmtr.c: v1.3.24 8/7/94 Peter De Schrijver and Mark Swanson&bslash;n&quot;
l_string|&quot;   modified 10/3/94 DW Morris, 3/9/95 F Farid and P Andre, 9/7/95 P Andre&bslash;n&quot;
suffix:semicolon
DECL|variable|pcchannelid
r_static
r_char
id|pcchannelid
(braket
)braket
op_assign
initialization_block
suffix:semicolon
DECL|variable|mcchannelid
r_static
r_char
id|mcchannelid
(braket
)braket
op_assign
initialization_block
suffix:semicolon
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/timer.h&gt;
macro_line|#include &lt;linux/in.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/system.h&gt;
macro_line|#include &lt;asm/bitops.h&gt;
macro_line|#include &lt;linux/ioport.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/skbuff.h&gt;
macro_line|#include &lt;linux/interrupt.h&gt;
macro_line|#include &lt;linux/netdevice.h&gt;
macro_line|#include &lt;linux/trdevice.h&gt;
macro_line|#include &lt;stddef.h&gt;
macro_line|#include &quot;ibmtr.h&quot;
DECL|macro|DPRINTK
mdefine_line|#define DPRINTK(format, args...) printk(&quot;%s: &quot; format, dev-&gt;name , ## args)
DECL|macro|DPRINTD
mdefine_line|#define DPRINTD(format, args...) DummyCall(&quot;%s: &quot; format, dev-&gt;name , ## args)
macro_line|#ifdef TR_NEWFORMAT
multiline_comment|/* this allows displaying full adapter information */
DECL|variable|channel_def
r_const
r_char
op_star
id|channel_def
(braket
)braket
op_assign
(brace
l_string|&quot;ISA&quot;
comma
l_string|&quot;MCA&quot;
comma
l_string|&quot;ISA P&amp;P&quot;
)brace
suffix:semicolon
DECL|function|adapter_def
r_char
op_star
id|adapter_def
c_func
(paren
r_char
id|type
)paren
(brace
r_switch
c_cond
(paren
id|type
)paren
(brace
r_case
l_int|0xF
suffix:colon
r_return
l_string|&quot;Adapter/A&quot;
suffix:semicolon
r_case
l_int|0xE
suffix:colon
r_return
l_string|&quot;16/4 Adapter/II&quot;
suffix:semicolon
r_default
suffix:colon
r_return
l_string|&quot;adapter&quot;
suffix:semicolon
)brace
suffix:semicolon
)brace
suffix:semicolon
macro_line|#endif
macro_line|#if 0
r_struct
id|tok_info
id|tok_info1
suffix:semicolon
multiline_comment|/*  WARNING: this area must be replicated&n;                                 or &squot;malloced&squot; to support &gt; 1 adapter */
r_static
r_struct
id|wait_queue
op_star
id|wait_for_tok_int
op_assign
l_int|NULL
comma
op_star
id|wait_for_reset
suffix:semicolon
r_void
(paren
op_star
id|do_tok_int
)paren
(paren
r_struct
id|device
op_star
id|dev
)paren
op_assign
l_int|NULL
suffix:semicolon
macro_line|#endif
macro_line|#ifndef TR_NEWFORMAT
DECL|variable|ibmtr_debug_trace
r_int
r_char
id|ibmtr_debug_trace
op_assign
l_int|1
suffix:semicolon
multiline_comment|/*  Patch or otherwise alter to&n;                                         control tokenring tracing.  */
macro_line|#else
DECL|variable|ibmtr_debug_trace
r_int
r_char
id|ibmtr_debug_trace
op_assign
l_int|0
suffix:semicolon
macro_line|#endif
DECL|macro|TRC_INIT
mdefine_line|#define TRC_INIT 0x01              /*  Trace initialization &amp; PROBEs */
DECL|macro|TRC_INITV
mdefine_line|#define TRC_INITV 0x02             /*  verbose init trace points     */
DECL|variable|TokBaseAddrs
r_static
r_int
id|TokBaseAddrs
(braket
)braket
op_assign
initialization_block
suffix:semicolon
r_int
id|tok_probe
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
suffix:semicolon
r_int
r_char
id|get_sram_size
c_func
(paren
r_struct
id|tok_info
op_star
id|adapt_info
)paren
suffix:semicolon
r_static
r_void
id|tok_init_card
c_func
(paren
r_int
r_int
id|dev_addr
)paren
suffix:semicolon
r_static
r_void
id|tok_interrupt
c_func
(paren
r_int
id|irq
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
suffix:semicolon
r_static
r_void
id|initial_tok_int
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_void
id|open_sap
c_func
(paren
r_int
r_char
id|type
comma
r_struct
id|device
op_star
id|dev
)paren
suffix:semicolon
r_void
id|tok_open_adapter
c_func
(paren
r_int
r_int
id|dev_addr
)paren
suffix:semicolon
r_static
r_void
id|tr_rx
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_void
id|tr_tx
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_int
id|tok_open
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_int
id|tok_close
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_int
id|tok_send_packet
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_struct
id|enet_statistics
op_star
id|tok_get_stats
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
suffix:semicolon
DECL|variable|tr_timer
r_static
r_struct
id|timer_list
id|tr_timer
op_assign
initialization_block
suffix:semicolon
DECL|variable|DummyCallCount
r_int
id|DummyCallCount
op_assign
l_int|0
suffix:semicolon
multiline_comment|/*  This routine combined with the #DEFINE DPRINTD serves&n;    to workaround the gcc apparent bug.   in tr_tx() */
DECL|function|DummyCall
r_static
r_void
id|DummyCall
c_func
(paren
r_const
r_char
op_star
id|fmt
comma
dot
dot
dot
)paren
(brace
id|DummyCallCount
op_increment
suffix:semicolon
r_return
suffix:semicolon
)brace
DECL|function|PrtChanID
r_static
r_void
id|PrtChanID
c_func
(paren
r_char
op_star
id|pcid
comma
r_int
id|stride
)paren
(brace
r_int
id|i
comma
id|j
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
comma
id|j
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|24
suffix:semicolon
id|i
op_increment
comma
id|j
op_assign
id|j
op_plus
id|stride
)paren
id|printk
c_func
(paren
l_string|&quot;%1x&quot;
comma
(paren
(paren
r_int
)paren
id|pcid
(braket
id|j
)braket
)paren
op_amp
l_int|0x0f
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/* tok_probe():  Routine specified in the network device structure&n;          to probe for an IBM Token Ring Adapter.  Routine outline:&n;          I.  Interrogate hardware to determine if an adapter exists&n;              and what the speeds and feeds are&n;         II.  Setup data structures to control execution based upon&n;              adapter characteristics.&n;         III. Initialize adapter operation&n;     We expect tok_probe to be called once for each device entry&n;     which references it.&n; */
DECL|function|tok_probe
r_int
id|tok_probe
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
r_int
r_char
id|segment
op_assign
l_int|0
comma
id|intr
op_assign
l_int|0
comma
id|irq
op_assign
l_int|0
comma
id|i
op_assign
l_int|0
comma
id|j
op_assign
l_int|0
comma
id|cardpresent
op_assign
id|NOTOK
comma
id|temp
op_assign
l_int|0
suffix:semicolon
r_int
r_char
op_star
id|t_mmio
op_assign
l_int|0
suffix:semicolon
r_int
id|PIOaddr
op_assign
l_int|0
comma
id|iAddr
suffix:semicolon
r_struct
id|tok_info
op_star
id|ti
op_assign
l_int|0
suffix:semicolon
r_static
r_struct
id|tok_info
op_star
id|badti
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* if fail after kmalloc, reuse */
r_static
r_int
r_char
id|Shared_Ram_Base
op_assign
id|IBMTR_SHARED_RAM_BASE
suffix:semicolon
multiline_comment|/*  this is the major adapter probe loop.  For each call to tok_probe,&n;      we try each remaining entry in TokBaseAddrs[] as a possible&n;      adapter.  Once an entry is rejected or assigned, we zero it to&n;      avoid duplicate use or worthless trial for the tok probe call*/
r_for
c_loop
(paren
id|iAddr
op_assign
l_int|0
suffix:semicolon
id|iAddr
OL
(paren
r_sizeof
(paren
id|TokBaseAddrs
)paren
op_div
r_sizeof
(paren
r_int
)paren
)paren
op_logical_and
id|PIOaddr
op_eq
l_int|0
suffix:semicolon
id|iAddr
op_increment
)paren
(brace
r_char
op_star
id|tchanid
comma
op_star
id|cd_chanid
comma
id|ctemp
suffix:semicolon
id|PIOaddr
op_assign
id|TokBaseAddrs
(braket
id|iAddr
)braket
suffix:semicolon
multiline_comment|/* address to try           */
id|TokBaseAddrs
(braket
id|iAddr
)braket
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* (and marked already used */
r_if
c_cond
(paren
id|PIOaddr
op_eq
l_int|0
)paren
r_continue
suffix:semicolon
multiline_comment|/* already tried this addr */
r_if
c_cond
(paren
id|check_region
c_func
(paren
id|PIOaddr
comma
id|TR_IO_EXTENT
)paren
)paren
(brace
multiline_comment|/* Make sure PIO address not&n;&t;&t;&t;&t;&t;&t;   already assigned elsewhere&n;&t;&t;&t;&t;&t;&t;   before we muck with I/O&n;&t;&t;&t;&t;&t;&t;   addresses */
r_if
c_cond
(paren
id|ibmtr_debug_trace
op_amp
id|TRC_INIT
)paren
id|DPRINTK
c_func
(paren
l_string|&quot;check_region(%4hx,%d) failed.&bslash;n&quot;
comma
id|PIOaddr
comma
id|TR_IO_EXTENT
)paren
suffix:semicolon
id|PIOaddr
op_assign
l_int|0
suffix:semicolon
r_continue
suffix:semicolon
multiline_comment|/* clear to flag fail and try next */
)brace
multiline_comment|/*  Query the adapter PIO base port which will return&n;               indication of where MMIO was placed (per tech ref&n;               this assignment is done by BIOS - what is rational for&n;               where it is?).  We also have a coded interrupt address.*/
id|segment
op_assign
id|inb
c_func
(paren
id|PIOaddr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|segment
template_param
l_int|0xe0
)paren
(brace
multiline_comment|/* out of range values&n;                            so we will assume non-existant IO dev */
id|PIOaddr
op_assign
l_int|0
suffix:semicolon
r_continue
suffix:semicolon
multiline_comment|/* clear to flag fail and try next */
)brace
multiline_comment|/*  Compute the linear base address of the MMIO area&n;                     as LINUX doesn&squot;t care about segments          */
id|t_mmio
op_assign
(paren
r_char
op_star
)paren
(paren
(paren
(paren
id|segment
op_amp
l_int|0xfc
)paren
op_lshift
l_int|11
)paren
op_plus
l_int|0x80000
)paren
suffix:semicolon
id|intr
op_assign
id|segment
op_amp
l_int|0x03
suffix:semicolon
multiline_comment|/* low bits is coded interrupt # */
r_if
c_cond
(paren
id|ibmtr_debug_trace
op_amp
id|TRC_INIT
)paren
id|DPRINTK
c_func
(paren
l_string|&quot;PIOaddr: %4hx seg/intr: %2x mmio base: %p intr: %d&bslash;n&quot;
comma
id|PIOaddr
comma
(paren
r_int
)paren
id|segment
comma
id|t_mmio
comma
(paren
r_int
)paren
id|intr
)paren
suffix:semicolon
multiline_comment|/*  Now we will compare expected &squot;channelid&squot; strings with&n;        what we is there to learn of ISA/MCA or not TR card */
multiline_comment|/*  !!!WARNING:!!!! It seems pretty silly to blunder ahead&n;            w/o verification that the mmio address we have found&n;            is valid storage -- perhaps this is tolerable for current&n;            hardware state??? */
id|cd_chanid
op_assign
(paren
r_char
op_star
)paren
(paren
id|CHANNEL_ID
op_plus
id|t_mmio
)paren
suffix:semicolon
multiline_comment|/* for efficiency */
id|tchanid
op_assign
id|pcchannelid
suffix:semicolon
id|cardpresent
op_assign
id|TR_ISA
suffix:semicolon
multiline_comment|/* try ISA ? */
multiline_comment|/* suboptimize knowing first byte different */
id|ctemp
op_assign
(paren
op_star
id|cd_chanid
)paren
op_amp
l_int|0x0f
suffix:semicolon
r_if
c_cond
(paren
id|ctemp
op_ne
op_star
id|tchanid
)paren
(brace
multiline_comment|/* NOT ISA card, try MCA */
id|tchanid
op_assign
id|mcchannelid
suffix:semicolon
id|cardpresent
op_assign
id|TR_MCA
suffix:semicolon
r_if
c_cond
(paren
id|ctemp
op_ne
op_star
id|tchanid
)paren
multiline_comment|/* Neither ISA nor MCA */
id|cardpresent
op_assign
id|NOTOK
suffix:semicolon
)brace
r_if
c_cond
(paren
id|cardpresent
op_ne
id|NOTOK
)paren
(brace
multiline_comment|/* know presumed type, try rest of ID */
r_for
c_loop
(paren
id|i
op_assign
l_int|2
comma
id|j
op_assign
l_int|1
suffix:semicolon
id|i
op_le
l_int|46
suffix:semicolon
id|i
op_assign
id|i
op_plus
l_int|2
comma
id|j
op_increment
)paren
(brace
r_if
c_cond
(paren
(paren
id|cd_chanid
(braket
id|i
)braket
op_amp
l_int|0x0f
)paren
op_ne
id|tchanid
(braket
id|j
)braket
)paren
(brace
id|cardpresent
op_assign
id|NOTOK
suffix:semicolon
multiline_comment|/* match failed, not TR card */
r_break
suffix:semicolon
)brace
)brace
)brace
multiline_comment|/* If we have an ISA board check for the ISA P&amp;P version, as it has&n;       different IRQ settings */
r_if
c_cond
(paren
id|cardpresent
op_eq
id|TR_ISA
op_logical_and
(paren
op_star
(paren
id|AIPFID
op_plus
id|t_mmio
)paren
op_eq
l_int|0x0e
)paren
)paren
id|cardpresent
op_assign
id|TR_ISAPNP
suffix:semicolon
r_if
c_cond
(paren
id|cardpresent
op_eq
id|NOTOK
)paren
(brace
multiline_comment|/* &quot;channel_id&quot; did not match, report */
r_if
c_cond
(paren
id|ibmtr_debug_trace
op_amp
id|TRC_INIT
)paren
(brace
id|DPRINTK
c_func
(paren
l_string|&quot;Channel ID string not found for PIOaddr: %4hx&bslash;n&quot;
comma
id|PIOaddr
)paren
suffix:semicolon
id|DPRINTK
c_func
(paren
l_string|&quot;Expected for ISA: &quot;
)paren
suffix:semicolon
id|PrtChanID
c_func
(paren
id|pcchannelid
comma
l_int|1
)paren
suffix:semicolon
id|DPRINTK
c_func
(paren
l_string|&quot;           found: &quot;
)paren
suffix:semicolon
id|PrtChanID
c_func
(paren
id|cd_chanid
comma
l_int|2
)paren
suffix:semicolon
id|DPRINTK
c_func
(paren
l_string|&quot;Expected for MCA: &quot;
)paren
suffix:semicolon
id|PrtChanID
c_func
(paren
id|mcchannelid
comma
l_int|1
)paren
suffix:semicolon
)brace
id|PIOaddr
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* all to know not found yet */
r_continue
suffix:semicolon
)brace
multiline_comment|/* !!!! we could tighten validation by checking the HW Address&n;      against the 1-s complement..  Move the get HW logic to here */
)brace
multiline_comment|/*   The search loop has either completed with a presumed TR adapter&n;       or none found.  Check situation ... march on if possible */
r_if
c_cond
(paren
id|PIOaddr
op_eq
l_int|0
)paren
(brace
multiline_comment|/* failed to find a valid TR adapter */
r_if
c_cond
(paren
id|ibmtr_debug_trace
op_amp
id|TRC_INIT
)paren
id|DPRINTK
c_func
(paren
l_string|&quot;Unable to assign adapter to device.&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|ENODEV
suffix:semicolon
)brace
multiline_comment|/*?? Now, allocate some of the pl0 buffers for this driver.. */
r_if
c_cond
(paren
op_logical_neg
id|badti
)paren
(brace
id|ti
op_assign
(paren
r_struct
id|tok_info
op_star
)paren
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|tok_info
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ti
op_eq
l_int|NULL
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
r_else
(brace
id|ti
op_assign
id|badti
suffix:semicolon
id|badti
op_assign
l_int|NULL
suffix:semicolon
)brace
multiline_comment|/*?? dev-&gt;priv = kmalloc(sizeof(struct net_local), GFP_KERNEL); */
id|memset
c_func
(paren
id|ti
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|tok_info
)paren
)paren
suffix:semicolon
id|ti-&gt;mmio
op_assign
id|t_mmio
suffix:semicolon
id|dev-&gt;priv
op_assign
id|ti
suffix:semicolon
multiline_comment|/* this seems like the logical use of the&n;                         field ... lets try some empirical tests&n;                         using the token-info structure -- that&n;                         should fit with out future hope of multiple&n;                         adapter support as well /dwm   */
r_switch
c_cond
(paren
id|cardpresent
)paren
(brace
r_case
id|TR_ISA
suffix:colon
r_if
c_cond
(paren
id|intr
op_eq
l_int|0
)paren
id|irq
op_assign
l_int|9
suffix:semicolon
multiline_comment|/* irq2 really is irq9 */
r_if
c_cond
(paren
id|intr
op_eq
l_int|1
)paren
id|irq
op_assign
l_int|3
suffix:semicolon
r_if
c_cond
(paren
id|intr
op_eq
l_int|2
)paren
id|irq
op_assign
l_int|6
suffix:semicolon
r_if
c_cond
(paren
id|intr
op_eq
l_int|3
)paren
id|irq
op_assign
l_int|7
suffix:semicolon
id|ti-&gt;global_int_enable
op_assign
id|GLOBAL_INT_ENABLE
op_plus
(paren
(paren
id|irq
op_eq
l_int|9
)paren
ques
c_cond
l_int|2
suffix:colon
id|irq
)paren
suffix:semicolon
id|ti-&gt;sram
op_assign
l_int|NULL
suffix:semicolon
macro_line|#ifndef TR_NEWFORMAT
id|DPRINTK
c_func
(paren
l_string|&quot;ti-&gt;global_int_enable: %04X&bslash;n&quot;
comma
id|ti-&gt;global_int_enable
)paren
suffix:semicolon
macro_line|#endif
r_break
suffix:semicolon
r_case
id|TR_MCA
suffix:colon
r_if
c_cond
(paren
id|intr
op_eq
l_int|0
)paren
id|irq
op_assign
l_int|9
suffix:semicolon
r_if
c_cond
(paren
id|intr
op_eq
l_int|1
)paren
id|irq
op_assign
l_int|3
suffix:semicolon
r_if
c_cond
(paren
id|intr
op_eq
l_int|2
)paren
id|irq
op_assign
l_int|10
suffix:semicolon
r_if
c_cond
(paren
id|intr
op_eq
l_int|3
)paren
id|irq
op_assign
l_int|11
suffix:semicolon
id|ti-&gt;global_int_enable
op_assign
l_int|0
suffix:semicolon
id|ti-&gt;sram
op_assign
(paren
r_int
r_char
op_star
)paren
(paren
(paren
id|inb
c_func
(paren
id|PIOaddr
op_plus
id|ADAPTRESETREL
)paren
op_amp
l_int|0xfe
)paren
op_lshift
l_int|12
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|TR_ISAPNP
suffix:colon
r_if
c_cond
(paren
id|intr
op_eq
l_int|0
)paren
id|irq
op_assign
l_int|9
suffix:semicolon
r_if
c_cond
(paren
id|intr
op_eq
l_int|1
)paren
id|irq
op_assign
l_int|3
suffix:semicolon
r_if
c_cond
(paren
id|intr
op_eq
l_int|2
)paren
id|irq
op_assign
l_int|10
suffix:semicolon
r_if
c_cond
(paren
id|intr
op_eq
l_int|3
)paren
id|irq
op_assign
l_int|11
suffix:semicolon
r_while
c_loop
(paren
op_logical_neg
(paren
id|ti-&gt;mmio
op_plus
id|ACA_OFFSET
op_plus
id|ACA_RW
op_plus
id|RRR_EVEN
)paren
)paren
(brace
suffix:semicolon
)brace
id|ti-&gt;sram
op_assign
(paren
r_int
r_char
op_star
)paren
(paren
(paren
r_int
r_int
)paren
(paren
id|ti-&gt;mmio
op_plus
id|ACA_OFFSET
op_plus
id|ACA_RW
op_plus
id|RRR_EVEN
)paren
op_lshift
l_int|12
)paren
suffix:semicolon
id|ti-&gt;global_int_enable
op_assign
id|PIOaddr
op_plus
id|ADAPTINTREL
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ibmtr_debug_trace
op_amp
id|TRC_INIT
)paren
(brace
multiline_comment|/* just report int */
id|DPRINTK
c_func
(paren
l_string|&quot;irq=%d&quot;
comma
id|irq
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ibmtr_debug_trace
op_amp
id|TRC_INITV
)paren
(brace
multiline_comment|/* full chat in verbose only */
id|DPRINTK
c_func
(paren
l_string|&quot;, ti-&gt;mmio=%p&quot;
comma
id|ti-&gt;mmio
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;, segment=%02X&quot;
comma
id|segment
)paren
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;.&bslash;n&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/* Get hw address of token ring card */
macro_line|#ifndef TR_NEWFORMAT 
id|DPRINTK
c_func
(paren
l_string|&quot;hw address: &quot;
)paren
suffix:semicolon
macro_line|#endif
id|j
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|0x18
suffix:semicolon
id|i
op_assign
id|i
op_plus
l_int|2
)paren
(brace
id|temp
op_assign
op_star
(paren
r_char
op_star
)paren
(paren
(paren
id|ulong
)paren
id|AIP
op_plus
(paren
id|ulong
)paren
id|i
op_plus
id|ti-&gt;mmio
)paren
op_amp
l_int|0x0f
suffix:semicolon
multiline_comment|/* Tech ref states must do this */
macro_line|#ifndef TR_NEWFORMAT
id|printk
c_func
(paren
l_string|&quot;%1X&quot;
comma
id|ti-&gt;hw_address
(braket
id|j
)braket
op_assign
id|temp
)paren
suffix:semicolon
macro_line|#else
id|ti-&gt;hw_address
(braket
id|j
)braket
op_assign
id|temp
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|j
op_amp
l_int|1
)paren
(brace
id|dev-&gt;dev_addr
(braket
(paren
id|j
op_div
l_int|2
)paren
)braket
op_assign
id|ti-&gt;hw_address
(braket
id|j
)braket
op_plus
(paren
id|ti-&gt;hw_address
(braket
id|j
op_minus
l_int|1
)braket
op_lshift
l_int|4
)paren
suffix:semicolon
)brace
op_increment
id|j
suffix:semicolon
)brace
macro_line|#ifndef TR_NEWFORMAT
id|printk
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/* get Adapter type:  &squot;F&squot; = Adapter/A, &squot;E&squot; = 16/4 Adapter II,...*/
id|ti-&gt;adapter_type
op_assign
op_star
(paren
r_char
op_star
)paren
(paren
id|ti-&gt;mmio
op_plus
id|AIPADAPTYPE
)paren
suffix:semicolon
multiline_comment|/* get Data Rate:  F=4Mb, E=16Mb, D=4Mb &amp; 16Mb ?? */
id|ti-&gt;data_rate
op_assign
op_star
(paren
r_char
op_star
)paren
(paren
id|ti-&gt;mmio
op_plus
id|AIPDATARATE
)paren
suffix:semicolon
multiline_comment|/* Get Early Token Release support?: F=no, E=4Mb, D=16Mb, C=4&amp;16Mb */
id|ti-&gt;token_release
op_assign
op_star
(paren
r_char
op_star
)paren
(paren
id|ti-&gt;mmio
op_plus
id|AIPEARLYTOKEN
)paren
suffix:semicolon
multiline_comment|/* How much shared RAM is on adapter ? */
id|ti-&gt;avail_shared_ram
op_assign
id|get_sram_size
c_func
(paren
id|ti
)paren
suffix:semicolon
multiline_comment|/* We need to set or do a bunch of work here based on previous results.. */
multiline_comment|/* Support paging?  What sizes?:  F=no, E=16k, D=32k, C=16 &amp; 32k */
id|ti-&gt;shared_ram_paging
op_assign
op_star
(paren
r_char
op_star
)paren
(paren
id|ti-&gt;mmio
op_plus
id|AIPSHRAMPAGE
)paren
suffix:semicolon
multiline_comment|/* Available DHB  4Mb size:   F=2048, E=4096, D=4464 */
id|ti-&gt;dhb_size4mb
op_assign
op_star
(paren
r_char
op_star
)paren
(paren
id|ti-&gt;mmio
op_plus
id|AIP4MBDHB
)paren
suffix:semicolon
multiline_comment|/* Available DHB 16Mb size:  F=2048, E=4096, D=8192, C=16384, B=17960 */
id|ti-&gt;dhb_size16mb
op_assign
op_star
(paren
r_char
op_star
)paren
(paren
id|ti-&gt;mmio
op_plus
id|AIP16MBDHB
)paren
suffix:semicolon
macro_line|#ifndef TR_NEWFORMAT
id|DPRINTK
c_func
(paren
l_string|&quot;atype=%x, drate=%x, trel=%x, asram=%dK, srp=%x, dhb(4mb=%x, 16mb=%x)&bslash;n&quot;
comma
id|ti-&gt;adapter_type
comma
id|ti-&gt;data_rate
comma
id|ti-&gt;token_release
comma
id|ti-&gt;avail_shared_ram
op_div
l_int|2
comma
id|ti-&gt;shared_ram_paging
comma
id|ti-&gt;dhb_size4mb
comma
id|ti-&gt;dhb_size16mb
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/* We must figure out how much shared memory space this adapter&n;     will occupy so that if there are two adapters we can fit both&n;     in.  Given a choice, we will limit this adapter to 32K.  The&n;     maximum space will will use for two adapters is 64K so if the&n;     adapter we are working on demands 64K (it also doesn&squot;t support&n;     paging), then only one adapter can be supported.  */
multiline_comment|/* determine how much of total RAM is mapped into PC space */
id|ti-&gt;mapped_ram_size
op_assign
l_int|1
op_lshift
(paren
(paren
(paren
op_star
(paren
r_int
r_char
op_star
)paren
(paren
id|ti-&gt;mmio
op_plus
id|ACA_OFFSET
op_plus
id|ACA_RW
op_plus
id|RRR_ODD
)paren
)paren
op_rshift
l_int|2
)paren
op_plus
l_int|4
)paren
suffix:semicolon
id|ti-&gt;page_mask
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|ti-&gt;shared_ram_paging
op_eq
l_int|0xf
)paren
(brace
multiline_comment|/* No paging in adapter */
id|ti-&gt;mapped_ram_size
op_assign
id|ti-&gt;avail_shared_ram
suffix:semicolon
)brace
r_else
(brace
macro_line|#ifdef ENABLE_PAGING
r_int
r_char
id|pg_size
suffix:semicolon
macro_line|#endif
macro_line|#ifndef TR_NEWFORMAT
id|DPRINTK
c_func
(paren
l_string|&quot;shared ram page size: %dK&bslash;n&quot;
comma
id|ti-&gt;mapped_ram_size
op_div
l_int|2
)paren
suffix:semicolon
macro_line|#endif
macro_line|#ifdef ENABLE_PAGING
r_switch
c_cond
(paren
id|ti-&gt;shared_ram_paging
)paren
(brace
r_case
l_int|0xf
suffix:colon
r_break
suffix:semicolon
r_case
l_int|0xe
suffix:colon
id|ti-&gt;page_mask
op_assign
(paren
id|ti-&gt;mapped_ram_size
op_eq
l_int|32
)paren
ques
c_cond
l_int|0xc0
suffix:colon
l_int|0
suffix:semicolon
id|pg_size
op_assign
l_int|32
suffix:semicolon
multiline_comment|/* 16KB page size */
r_break
suffix:semicolon
r_case
l_int|0xd
suffix:colon
id|ti-&gt;page_mask
op_assign
(paren
id|ti-&gt;mapped_ram_size
op_eq
l_int|64
)paren
ques
c_cond
l_int|0x80
suffix:colon
l_int|0
suffix:semicolon
id|pg_size
op_assign
l_int|64
suffix:semicolon
multiline_comment|/* 32KB page size */
r_break
suffix:semicolon
r_case
l_int|0xc
suffix:colon
id|ti-&gt;page_mask
op_assign
(paren
id|ti-&gt;mapped_ram_size
op_eq
l_int|32
)paren
ques
c_cond
l_int|0xc0
suffix:colon
l_int|0
suffix:semicolon
id|ti-&gt;page_mask
op_assign
(paren
id|ti-&gt;mapped_ram_size
op_eq
l_int|64
)paren
ques
c_cond
l_int|0x80
suffix:colon
l_int|0
suffix:semicolon
id|DPRINTK
c_func
(paren
l_string|&quot;Dual size shared RAM page (code=0xC), don&squot;t support it!&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* nb/dwm: I did this because RRR (3,2) bits are documented as&n;&t; * R/O and I can&squot;t find how to select which page size&n;&t; * Also, the above conditional statement sequence is invalid&n;&t; *       as page_mask will always be set by the second stmt&n;&t; */
id|badti
op_assign
id|ti
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|DPRINTK
c_func
(paren
l_string|&quot;Unknown shared ram paging info %01X&bslash;n&quot;
comma
id|ti-&gt;shared_ram_paging
)paren
suffix:semicolon
id|badti
op_assign
id|ti
suffix:semicolon
multiline_comment|/* bail out if bad code */
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ti-&gt;page_mask
)paren
(brace
r_if
c_cond
(paren
id|pg_size
OG
id|ti-&gt;mapped_ram_size
)paren
(brace
id|DPRINTK
c_func
(paren
l_string|&quot;Page size (%d) &gt; mapped ram window (%d), can&squot;t page.&bslash;n&quot;
comma
id|pg_size
comma
id|ti-&gt;mapped_ram_size
)paren
suffix:semicolon
id|ti-&gt;page_mask
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* reset paging */
)brace
r_else
(brace
id|ti-&gt;mapped_ram_size
op_assign
id|ti-&gt;avail_shared_ram
suffix:semicolon
multiline_comment|/****** ?????????? *******/
id|DPRINTK
c_func
(paren
l_string|&quot;Shared RAM paging enabled. Page size : %uK&bslash;n&quot;
comma
(paren
(paren
id|ti-&gt;page_mask
op_xor
l_int|0xff
)paren
op_plus
l_int|1
)paren
op_rshift
l_int|2
)paren
suffix:semicolon
)brace
)brace
macro_line|#else
macro_line|#endif
)brace
r_if
c_cond
(paren
id|cardpresent
op_eq
id|TR_ISA
)paren
(brace
multiline_comment|/* finish figuring the shared RAM address */
r_static
r_int
r_char
id|ram_bndry_mask
(braket
)braket
op_assign
initialization_block
suffix:semicolon
r_int
r_char
id|new_base
comma
id|rrr_32
comma
id|chk_base
comma
id|rbm
suffix:semicolon
id|rrr_32
op_assign
(paren
op_star
(paren
r_int
r_char
op_star
)paren
(paren
id|ti-&gt;mmio
op_plus
id|ACA_OFFSET
op_plus
id|ACA_RW
op_plus
id|RRR_ODD
)paren
)paren
op_rshift
l_int|2
suffix:semicolon
id|rbm
op_assign
id|ram_bndry_mask
(braket
id|rrr_32
)braket
suffix:semicolon
id|new_base
op_assign
(paren
id|Shared_Ram_Base
op_plus
(paren
op_complement
id|rbm
)paren
)paren
op_amp
id|rbm
suffix:semicolon
multiline_comment|/* up to boundary */
id|chk_base
op_assign
id|new_base
op_plus
(paren
id|ti-&gt;mapped_ram_size
op_rshift
l_int|3
)paren
suffix:semicolon
r_if
c_cond
(paren
id|chk_base
OG
(paren
id|IBMTR_SHARED_RAM_BASE
op_plus
id|IBMTR_SHARED_RAM_SIZE
)paren
)paren
(brace
id|DPRINTK
c_func
(paren
l_string|&quot;Shared RAM for this adapter (%05x) exceeds driver&quot;
l_string|&quot; limit (%05x), adapter not started.&bslash;n&quot;
comma
id|chk_base
op_lshift
l_int|12
comma
(paren
id|IBMTR_SHARED_RAM_BASE
op_plus
id|IBMTR_SHARED_RAM_SIZE
)paren
op_lshift
l_int|12
)paren
suffix:semicolon
id|badti
op_assign
id|ti
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* seems cool, record what we have figured out */
id|ti-&gt;sram_base
op_assign
id|new_base
suffix:semicolon
id|Shared_Ram_Base
op_assign
id|new_base
suffix:semicolon
)brace
)brace
multiline_comment|/* dwm: irq and other final setup moved here so if we find other&n;        unrecognized values OR shared ram conflicts, we can still&n;        bail out in a rather benign fashion.    */
r_if
c_cond
(paren
id|badti
)paren
r_return
id|ENODEV
suffix:semicolon
macro_line|#ifndef TR_NEWFORMAT
id|DPRINTK
c_func
(paren
l_string|&quot;Using %dK shared RAM&bslash;n&quot;
comma
id|ti-&gt;mapped_ram_size
op_div
l_int|2
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|request_irq
(paren
id|dev-&gt;irq
op_assign
id|irq
comma
op_amp
id|tok_interrupt
comma
l_int|0
comma
l_string|&quot;IBM TR&quot;
)paren
op_ne
l_int|0
)paren
(brace
id|DPRINTK
c_func
(paren
l_string|&quot;Could not grab irq %d.  Halting Token Ring driver.&bslash;n&quot;
comma
id|irq
)paren
suffix:semicolon
id|badti
op_assign
id|ti
suffix:semicolon
multiline_comment|/*  keep track of unused tok_info */
r_return
id|ENODEV
suffix:semicolon
)brace
id|irq2dev_map
(braket
id|irq
)braket
op_assign
id|dev
suffix:semicolon
multiline_comment|/*?? Now, allocate some of the PIO PORTs for this driver.. */
id|request_region
c_func
(paren
id|PIOaddr
comma
id|TR_IO_EXTENT
comma
l_string|&quot;ibmtr&quot;
)paren
suffix:semicolon
multiline_comment|/* record PIOaddr range&n;&t;&t;&t;&t;&t;&t;    as busy */
macro_line|#ifndef TR_NEWFORMAT
id|DPRINTK
c_func
(paren
l_string|&quot;%s&quot;
comma
id|version
)paren
suffix:semicolon
multiline_comment|/* As we have passed card identification,&n;                             let the world know we&squot;re here! */
macro_line|#else
id|printk
c_func
(paren
l_string|&quot;%s&quot;
comma
id|version
)paren
suffix:semicolon
id|DPRINTK
c_func
(paren
l_string|&quot;%s %s found using irq %d, PIOaddr %4hx, %dK shared RAM.&bslash;n&quot;
comma
id|channel_def
(braket
id|cardpresent
op_minus
l_int|1
)braket
comma
id|adapter_def
c_func
(paren
id|ti-&gt;adapter_type
)paren
comma
id|irq
comma
id|PIOaddr
comma
id|ti-&gt;mapped_ram_size
op_div
l_int|2
)paren
suffix:semicolon
id|DPRINTK
c_func
(paren
l_string|&quot;Hardware address : %02X:%02X:%02X:%02X:%02X:%02X&bslash;n&quot;
comma
id|dev-&gt;dev_addr
(braket
l_int|0
)braket
comma
id|dev-&gt;dev_addr
(braket
l_int|1
)braket
comma
id|dev-&gt;dev_addr
(braket
l_int|2
)braket
comma
id|dev-&gt;dev_addr
(braket
l_int|3
)braket
comma
id|dev-&gt;dev_addr
(braket
l_int|4
)braket
comma
id|dev-&gt;dev_addr
(braket
l_int|5
)braket
)paren
suffix:semicolon
macro_line|#endif
id|dev-&gt;base_addr
op_assign
id|PIOaddr
suffix:semicolon
multiline_comment|/* set the value for device */
id|dev-&gt;open
op_assign
id|tok_open
suffix:semicolon
id|dev-&gt;stop
op_assign
id|tok_close
suffix:semicolon
id|dev-&gt;hard_start_xmit
op_assign
id|tok_send_packet
suffix:semicolon
id|dev-&gt;get_stats
op_assign
l_int|NULL
suffix:semicolon
id|dev-&gt;get_stats
op_assign
id|tok_get_stats
suffix:semicolon
id|dev-&gt;set_multicast_list
op_assign
l_int|NULL
suffix:semicolon
id|tr_setup
c_func
(paren
id|dev
)paren
suffix:semicolon
id|tok_init_card
c_func
(paren
(paren
r_int
r_int
)paren
id|dev
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
multiline_comment|/* Return 0 to indicate we have found a Token Ring card. */
)brace
multiline_comment|/* query the adapter for the size of shared RAM  */
DECL|function|get_sram_size
r_int
r_char
id|get_sram_size
c_func
(paren
r_struct
id|tok_info
op_star
id|adapt_info
)paren
(brace
r_int
r_char
id|avail_sram_code
suffix:semicolon
r_static
r_int
r_char
id|size_code
(braket
)braket
op_assign
initialization_block
suffix:semicolon
multiline_comment|/*  Adapter gives&n;                &squot;F&squot; -- use RRR bits 3,2&n;                &squot;E&squot; -- 8kb   &squot;D&squot; -- 16kb&n;                &squot;C&squot; -- 32kb  &squot;A&squot; -- 64KB&n;                &squot;B&squot; - 64KB less 512 bytes at top&n;                      (WARNING ... must zero top bytes in INIT */
id|avail_sram_code
op_assign
l_int|0xf
op_minus
op_star
(paren
id|adapt_info-&gt;mmio
op_plus
id|AIPAVAILSHRAM
)paren
suffix:semicolon
r_if
c_cond
(paren
id|avail_sram_code
)paren
(brace
r_return
id|size_code
(braket
id|avail_sram_code
)braket
suffix:semicolon
)brace
r_else
multiline_comment|/* for code &squot;F&squot;, must compute size from RRR(3,2) bits */
r_return
l_int|1
op_lshift
(paren
(paren
(paren
op_star
(paren
r_int
r_char
op_star
)paren
(paren
id|adapt_info-&gt;mmio
op_plus
id|ACA_OFFSET
op_plus
id|ACA_RW
op_plus
id|RRR_ODD
)paren
)paren
op_rshift
l_int|2
)paren
op_plus
l_int|4
)paren
suffix:semicolon
)brace
DECL|function|tok_open
r_static
r_int
id|tok_open
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
r_struct
id|tok_info
op_star
id|ti
op_assign
(paren
r_struct
id|tok_info
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_if
c_cond
(paren
id|ti-&gt;open_status
op_eq
id|CLOSED
)paren
(brace
id|tok_init_card
c_func
(paren
(paren
r_int
r_int
)paren
id|dev
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ti-&gt;open_status
op_eq
id|IN_PROGRESS
)paren
(brace
id|sleep_on
c_func
(paren
op_amp
id|ti-&gt;wait_for_reset
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ti-&gt;open_status
op_eq
id|SUCCES
)paren
(brace
id|dev-&gt;tbusy
op_assign
l_int|0
suffix:semicolon
id|dev-&gt;interrupt
op_assign
l_int|0
suffix:semicolon
id|dev-&gt;start
op_assign
l_int|1
suffix:semicolon
multiline_comment|/*  NEED to see smem size *AND* reset high 512 bytes if&n;          needed */
id|MOD_INC_USE_COUNT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_else
r_return
op_minus
id|EAGAIN
suffix:semicolon
)brace
DECL|function|tok_close
r_static
r_int
id|tok_close
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
r_struct
id|tok_info
op_star
id|ti
op_assign
(paren
r_struct
id|tok_info
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_struct
id|srb_close_adapter
op_star
id|close_adapter
op_assign
(paren
r_struct
id|srb_close_adapter
op_star
)paren
id|ti-&gt;srb
suffix:semicolon
id|close_adapter-&gt;command
op_assign
id|DIR_CLOSE_ADAPTER
suffix:semicolon
op_star
(paren
r_int
r_char
op_star
)paren
(paren
id|ti-&gt;mmio
op_plus
id|ACA_OFFSET
op_plus
id|ACA_SET
op_plus
id|ISRA_ODD
)paren
op_assign
id|CMD_IN_SRB
suffix:semicolon
id|ti-&gt;open_status
op_assign
id|CLOSED
suffix:semicolon
id|sleep_on
c_func
(paren
op_amp
id|ti-&gt;wait_for_tok_int
)paren
suffix:semicolon
r_if
c_cond
(paren
id|close_adapter-&gt;ret_code
)paren
(brace
id|DPRINTK
c_func
(paren
l_string|&quot;close adapter failed: %02X&bslash;n&quot;
comma
id|close_adapter-&gt;ret_code
)paren
suffix:semicolon
)brace
id|MOD_DEC_USE_COUNT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|tok_interrupt
r_static
r_void
id|tok_interrupt
(paren
r_int
id|irq
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_int
r_char
id|status
suffix:semicolon
r_struct
id|tok_info
op_star
id|ti
suffix:semicolon
multiline_comment|/*   int irq = -(((struct pt_regs *)reg_ptr)-&gt;orig_eax+2); */
r_struct
id|device
op_star
id|dev
op_assign
(paren
r_struct
id|device
op_star
)paren
(paren
id|irq2dev_map
(braket
id|irq
)braket
)paren
suffix:semicolon
macro_line|#if 0
id|DPRINTK
c_func
(paren
l_string|&quot;Int from tok_driver, dev : %p&bslash;n&quot;
comma
id|dev
)paren
suffix:semicolon
macro_line|#endif
id|ti
op_assign
(paren
r_struct
id|tok_info
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_switch
c_cond
(paren
id|ti-&gt;do_tok_int
)paren
(brace
r_case
id|NOT_FIRST
suffix:colon
multiline_comment|/*  Begin the regular interrupt handler HERE inline to avoid&n;            the extra levels of logic and call depth for the&n;            original solution.   */
id|dev-&gt;interrupt
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* Disable interrupts till processing is finished */
op_star
(paren
r_int
r_char
op_star
)paren
(paren
id|ti-&gt;mmio
op_plus
id|ACA_OFFSET
op_plus
id|ACA_RESET
op_plus
id|ISRP_EVEN
)paren
op_assign
(paren
op_complement
id|INT_ENABLE
)paren
suffix:semicolon
multiline_comment|/* Reset interrupt for ISA boards */
r_if
c_cond
(paren
id|ti-&gt;global_int_enable
)paren
(brace
id|outb
c_func
(paren
l_int|0
comma
id|ti-&gt;global_int_enable
)paren
suffix:semicolon
)brace
id|status
op_assign
op_star
(paren
r_int
r_char
op_star
)paren
(paren
id|ti-&gt;mmio
op_plus
id|ACA_OFFSET
op_plus
id|ACA_RW
op_plus
id|ISRP_ODD
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
id|ADAP_CHK_INT
)paren
(brace
r_int
id|i
suffix:semicolon
r_int
r_char
op_star
id|check_reason
op_assign
id|ti-&gt;mmio
op_plus
id|ntohs
c_func
(paren
op_star
(paren
r_int
r_int
op_star
)paren
(paren
id|ti-&gt;mmio
op_plus
id|ACA_OFFSET
op_plus
id|ACA_RW
op_plus
id|WWCR_EVEN
)paren
)paren
suffix:semicolon
id|DPRINTK
c_func
(paren
l_string|&quot;adapter check interrupt&bslash;n&quot;
)paren
suffix:semicolon
id|DPRINTK
c_func
(paren
l_string|&quot;8 reason bytes follow: &quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|8
suffix:semicolon
id|i
op_increment
comma
id|check_reason
op_increment
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%02X &quot;
comma
op_star
id|check_reason
)paren
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
op_star
(paren
r_int
r_char
op_star
)paren
(paren
id|ti-&gt;mmio
op_plus
id|ACA_OFFSET
op_plus
id|ACA_RESET
op_plus
id|ISRP_ODD
)paren
op_assign
(paren
op_complement
id|ADAP_CHK_INT
)paren
suffix:semicolon
op_star
(paren
r_int
r_char
op_star
)paren
(paren
id|ti-&gt;mmio
op_plus
id|ACA_OFFSET
op_plus
id|ACA_SET
op_plus
id|ISRP_EVEN
)paren
op_assign
id|INT_ENABLE
suffix:semicolon
id|dev-&gt;interrupt
op_assign
l_int|0
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
(paren
op_star
(paren
r_int
r_char
op_star
)paren
(paren
id|ti-&gt;mmio
op_plus
id|ACA_OFFSET
op_plus
id|ACA_RW
op_plus
id|ISRP_EVEN
)paren
)paren
op_amp
(paren
id|TCR_INT
op_plus
id|ERR_INT
op_plus
id|ACCESS_INT
)paren
)paren
(brace
id|DPRINTK
c_func
(paren
l_string|&quot;adapter error: ISRP_EVEN : %02x&bslash;n&quot;
comma
op_star
(paren
r_int
r_char
op_star
)paren
(paren
id|ti-&gt;mmio
op_plus
id|ACA_OFFSET
op_plus
id|ACA_RW
op_plus
id|ISRP_EVEN
)paren
)paren
suffix:semicolon
op_star
(paren
r_int
r_char
op_star
)paren
(paren
id|ti-&gt;mmio
op_plus
id|ACA_OFFSET
op_plus
id|ACA_RESET
op_plus
id|ISRP_EVEN
)paren
op_assign
op_complement
(paren
id|TCR_INT
op_plus
id|ERR_INT
op_plus
id|ACCESS_INT
)paren
suffix:semicolon
op_star
(paren
r_int
r_char
op_star
)paren
(paren
id|ti-&gt;mmio
op_plus
id|ACA_OFFSET
op_plus
id|ACA_SET
op_plus
id|ISRP_EVEN
)paren
op_assign
id|INT_ENABLE
suffix:semicolon
id|dev-&gt;interrupt
op_assign
l_int|0
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|status
op_amp
(paren
id|SRB_RESP_INT
op_plus
id|ASB_FREE_INT
op_plus
id|ARB_CMD_INT
op_plus
id|SSB_RESP_INT
)paren
)paren
(brace
r_if
c_cond
(paren
id|status
op_amp
id|SRB_RESP_INT
)paren
(brace
r_switch
c_cond
(paren
op_star
id|ti-&gt;srb
)paren
(brace
r_case
id|XMIT_DIR_FRAME
suffix:colon
(brace
r_struct
id|srb_xmit
op_star
id|xmit
op_assign
(paren
r_struct
id|srb_xmit
op_star
)paren
(paren
id|ti-&gt;srb
)paren
suffix:semicolon
r_if
c_cond
(paren
id|xmit-&gt;ret_code
op_ne
l_int|0xff
)paren
(brace
id|DPRINTK
c_func
(paren
l_string|&quot;error on xmit_dir_frame request: %02X&bslash;n&quot;
comma
id|xmit-&gt;ret_code
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ti-&gt;current_skb
)paren
(brace
id|dev_kfree_skb
c_func
(paren
id|ti-&gt;current_skb
comma
id|FREE_WRITE
)paren
suffix:semicolon
id|ti-&gt;current_skb
op_assign
l_int|NULL
suffix:semicolon
)brace
id|dev-&gt;tbusy
op_assign
l_int|0
suffix:semicolon
)brace
)brace
r_break
suffix:semicolon
r_case
id|XMIT_UI_FRAME
suffix:colon
(brace
r_struct
id|srb_xmit
op_star
id|xmit
op_assign
(paren
r_struct
id|srb_xmit
op_star
)paren
(paren
id|ti-&gt;srb
)paren
suffix:semicolon
r_if
c_cond
(paren
id|xmit-&gt;ret_code
op_ne
l_int|0xff
)paren
(brace
id|DPRINTK
c_func
(paren
l_string|&quot;error on xmit_ui_frame request: %02X&bslash;n&quot;
comma
id|xmit-&gt;ret_code
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ti-&gt;current_skb
)paren
(brace
id|dev_kfree_skb
c_func
(paren
id|ti-&gt;current_skb
comma
id|FREE_WRITE
)paren
suffix:semicolon
id|ti-&gt;current_skb
op_assign
l_int|NULL
suffix:semicolon
)brace
id|dev-&gt;tbusy
op_assign
l_int|0
suffix:semicolon
)brace
)brace
r_break
suffix:semicolon
r_case
id|DIR_OPEN_ADAPTER
suffix:colon
(brace
r_struct
id|srb_open_response
op_star
id|open_response
op_assign
(paren
r_struct
id|srb_open_response
op_star
)paren
(paren
id|ti-&gt;init_srb
)paren
suffix:semicolon
id|ti-&gt;srb
op_assign
id|ti-&gt;sram
op_plus
id|ntohs
c_func
(paren
id|open_response-&gt;srb_addr
)paren
suffix:semicolon
id|ti-&gt;ssb
op_assign
id|ti-&gt;sram
op_plus
id|ntohs
c_func
(paren
id|open_response-&gt;ssb_addr
)paren
suffix:semicolon
id|ti-&gt;arb
op_assign
id|ti-&gt;sram
op_plus
id|ntohs
c_func
(paren
id|open_response-&gt;arb_addr
)paren
suffix:semicolon
id|ti-&gt;asb
op_assign
id|ti-&gt;sram
op_plus
id|ntohs
c_func
(paren
id|open_response-&gt;asb_addr
)paren
suffix:semicolon
id|ti-&gt;current_skb
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
id|open_response-&gt;ret_code
op_eq
l_int|7
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|ti-&gt;auto_ringspeedsave
op_logical_and
(paren
id|open_response-&gt;error_code
op_eq
l_int|0x24
)paren
)paren
(brace
id|DPRINTK
c_func
(paren
l_string|&quot;open failed: Adapter speed must match ring speed if Automatic Ring Speed Save is disabled&bslash;n&quot;
)paren
suffix:semicolon
id|ti-&gt;open_status
op_assign
id|FAILURE
suffix:semicolon
id|wake_up
c_func
(paren
op_amp
id|ti-&gt;wait_for_reset
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|open_response-&gt;error_code
op_eq
l_int|0x24
)paren
(brace
id|DPRINTK
c_func
(paren
l_string|&quot;retrying open to adjust to ring speed&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
(paren
id|open_response-&gt;error_code
op_eq
l_int|0x2d
)paren
op_logical_and
id|ti-&gt;auto_ringspeedsave
)paren
(brace
id|DPRINTK
c_func
(paren
l_string|&quot;No signal detected for Auto Speed Detection&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_else
id|DPRINTK
c_func
(paren
l_string|&quot;Unrecoverable error: error code = %02X&bslash;n&quot;
comma
id|open_response-&gt;error_code
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
op_logical_neg
id|open_response-&gt;ret_code
)paren
(brace
macro_line|#ifndef TR_NEWFORMAT
id|DPRINTK
c_func
(paren
l_string|&quot;board opened...&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#else
id|DPRINTK
c_func
(paren
l_string|&quot;Adapter initialized and opened.&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
op_star
(paren
r_int
r_char
op_star
)paren
(paren
id|ti-&gt;mmio
op_plus
id|ACA_OFFSET
op_plus
id|ACA_RESET
op_plus
id|ISRP_ODD
)paren
op_assign
op_complement
(paren
id|SRB_RESP_INT
)paren
suffix:semicolon
op_star
(paren
r_int
r_char
op_star
)paren
(paren
id|ti-&gt;mmio
op_plus
id|ACA_OFFSET
op_plus
id|ACA_RESET
op_plus
id|ISRA_ODD
)paren
op_assign
op_complement
(paren
id|CMD_IN_SRB
)paren
suffix:semicolon
id|open_sap
c_func
(paren
id|EXTENDED_SAP
comma
id|dev
)paren
suffix:semicolon
multiline_comment|/* YdW probably hates me */
r_goto
id|skip_reset
suffix:semicolon
)brace
r_else
(brace
id|DPRINTK
c_func
(paren
l_string|&quot;open failed: ret_code = %02X, retrying&bslash;n&quot;
comma
id|open_response-&gt;ret_code
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ti-&gt;open_status
op_ne
id|FAILURE
)paren
(brace
id|tr_timer.expires
op_assign
id|jiffies
op_plus
id|TR_RETRY_INTERVAL
suffix:semicolon
id|tr_timer.data
op_assign
(paren
r_int
r_int
)paren
id|dev
suffix:semicolon
id|tr_timer.next
op_assign
id|tr_timer.prev
op_assign
l_int|NULL
suffix:semicolon
id|add_timer
c_func
(paren
op_amp
id|tr_timer
)paren
suffix:semicolon
)brace
)brace
r_break
suffix:semicolon
r_case
id|DIR_CLOSE_ADAPTER
suffix:colon
id|wake_up
c_func
(paren
op_amp
id|ti-&gt;wait_for_tok_int
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|DLC_OPEN_SAP
suffix:colon
(brace
r_struct
id|dlc_open_sap
op_star
id|open_sap
op_assign
(paren
r_struct
id|dlc_open_sap
op_star
)paren
id|ti-&gt;srb
suffix:semicolon
r_if
c_cond
(paren
id|open_sap-&gt;ret_code
)paren
(brace
id|DPRINTK
c_func
(paren
l_string|&quot;open_sap failed: ret_code = %02X,retrying&bslash;n&quot;
comma
id|open_sap-&gt;ret_code
)paren
suffix:semicolon
id|tr_timer.expires
op_assign
id|jiffies
op_plus
id|TR_RETRY_INTERVAL
suffix:semicolon
id|tr_timer.data
op_assign
(paren
r_int
r_int
)paren
id|dev
suffix:semicolon
id|tr_timer.next
op_assign
id|tr_timer.prev
op_assign
l_int|NULL
suffix:semicolon
id|add_timer
c_func
(paren
op_amp
id|tr_timer
)paren
suffix:semicolon
)brace
r_else
(brace
id|ti-&gt;exsap_station_id
op_assign
id|open_sap-&gt;station_id
suffix:semicolon
id|ti-&gt;open_status
op_assign
id|SUCCES
suffix:semicolon
multiline_comment|/* TR adapter is now available */
id|wake_up
c_func
(paren
op_amp
id|ti-&gt;wait_for_reset
)paren
suffix:semicolon
)brace
)brace
r_break
suffix:semicolon
r_case
id|DIR_INTERRUPT
suffix:colon
r_case
id|DIR_MOD_OPEN_PARAMS
suffix:colon
r_case
id|DIR_SET_GRP_ADDR
suffix:colon
r_case
id|DIR_SET_FUNC_ADDR
suffix:colon
r_case
id|DLC_CLOSE_SAP
suffix:colon
(brace
r_struct
id|srb_interrupt
op_star
id|intr
op_assign
(paren
r_struct
id|srb_interrupt
op_star
)paren
(paren
id|ti-&gt;srb
)paren
suffix:semicolon
r_if
c_cond
(paren
id|intr-&gt;ret_code
)paren
(brace
id|DPRINTK
c_func
(paren
l_string|&quot;error on %02X: %02X&bslash;n&quot;
comma
id|intr-&gt;command
comma
id|intr-&gt;ret_code
)paren
suffix:semicolon
)brace
)brace
r_break
suffix:semicolon
r_case
id|DIR_READ_LOG
suffix:colon
(brace
r_struct
id|srb_read_log
op_star
id|read_log
op_assign
(paren
r_struct
id|srb_read_log
op_star
)paren
(paren
id|ti-&gt;srb
)paren
suffix:semicolon
r_if
c_cond
(paren
id|read_log-&gt;ret_code
)paren
(brace
id|DPRINTK
c_func
(paren
l_string|&quot;error on dir_read_log: %02X&bslash;n&quot;
comma
id|read_log-&gt;ret_code
)paren
suffix:semicolon
)brace
r_else
(brace
id|DPRINTK
c_func
(paren
l_string|&quot;Line errors %02X, Internal errors %02X, Burst errors %02X&bslash;n&quot;
comma
id|read_log-&gt;line_errors
comma
id|read_log-&gt;internal_errors
comma
id|read_log-&gt;burst_errors
)paren
suffix:semicolon
id|DPRINTK
c_func
(paren
l_string|&quot;A/C errors %02X, Abort delimiters %02X, Lost frames %02X&bslash;n&quot;
comma
id|read_log-&gt;A_C_errors
comma
id|read_log-&gt;abort_delimiters
comma
id|read_log-&gt;lost_frames
)paren
suffix:semicolon
id|DPRINTK
c_func
(paren
l_string|&quot;Receive congestion count %02X, Frame copied errors %02X, Frequency errors %02X&bslash;n&quot;
comma
id|read_log-&gt;recv_congest_count
comma
id|read_log-&gt;frame_copied_errors
comma
id|read_log-&gt;frequency_errors
)paren
suffix:semicolon
id|DPRINTK
c_func
(paren
l_string|&quot;Token errors %02X&bslash;n&quot;
comma
id|read_log-&gt;token_errors
)paren
suffix:semicolon
)brace
id|dev-&gt;tbusy
op_assign
l_int|0
suffix:semicolon
)brace
r_break
suffix:semicolon
r_default
suffix:colon
id|DPRINTK
c_func
(paren
l_string|&quot;Unknown command %02X encountered&bslash;n&quot;
comma
op_star
(paren
id|ti-&gt;srb
)paren
)paren
suffix:semicolon
)brace
op_star
(paren
r_int
r_char
op_star
)paren
(paren
id|ti-&gt;mmio
op_plus
id|ACA_OFFSET
op_plus
id|ACA_RESET
op_plus
id|ISRA_ODD
)paren
op_assign
op_complement
(paren
id|CMD_IN_SRB
)paren
suffix:semicolon
op_star
(paren
r_int
r_char
op_star
)paren
(paren
id|ti-&gt;mmio
op_plus
id|ACA_OFFSET
op_plus
id|ACA_RESET
op_plus
id|ISRP_ODD
)paren
op_assign
op_complement
(paren
id|SRB_RESP_INT
)paren
suffix:semicolon
id|skip_reset
suffix:colon
)brace
r_if
c_cond
(paren
id|status
op_amp
id|ASB_FREE_INT
)paren
(brace
r_switch
c_cond
(paren
op_star
id|ti-&gt;asb
)paren
(brace
r_case
id|REC_DATA
suffix:colon
r_case
id|XMIT_UI_FRAME
suffix:colon
r_case
id|XMIT_DIR_FRAME
suffix:colon
r_if
c_cond
(paren
op_star
(paren
id|ti-&gt;asb
op_plus
l_int|2
)paren
op_ne
l_int|0xff
)paren
(brace
id|DPRINTK
c_func
(paren
l_string|&quot;ASB error %02X in cmd %02X&bslash;n&quot;
comma
op_star
(paren
id|ti-&gt;asb
op_plus
l_int|2
)paren
comma
op_star
(paren
id|ti-&gt;asb
)paren
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_default
suffix:colon
id|DPRINTK
c_func
(paren
l_string|&quot;unknown command in asb %02X&bslash;n&quot;
comma
op_star
id|ti-&gt;asb
)paren
suffix:semicolon
)brace
op_star
(paren
r_int
r_char
op_star
)paren
(paren
id|ti-&gt;mmio
op_plus
id|ACA_OFFSET
op_plus
id|ACA_RESET
op_plus
id|ISRP_ODD
)paren
op_assign
op_complement
(paren
id|ASB_FREE_INT
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|status
op_amp
id|ARB_CMD_INT
)paren
(brace
r_switch
c_cond
(paren
op_star
id|ti-&gt;arb
)paren
(brace
r_case
id|DLC_STATUS
suffix:colon
(brace
r_struct
id|arb_dlc_status
op_star
id|dlc_status
op_assign
(paren
r_struct
id|arb_dlc_status
op_star
)paren
(paren
id|ti-&gt;arb
)paren
suffix:semicolon
id|DPRINTK
c_func
(paren
l_string|&quot;DLC_STATUS new status: %02X on station %02X&bslash;n&quot;
comma
id|ntohs
c_func
(paren
id|dlc_status-&gt;status
)paren
comma
id|ntohs
c_func
(paren
id|dlc_status-&gt;station_id
)paren
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|REC_DATA
suffix:colon
id|tr_rx
c_func
(paren
id|dev
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|RING_STAT_CHANGE
suffix:colon
(brace
r_struct
id|arb_ring_stat_change
op_star
id|ring_stat_change
op_assign
(paren
r_struct
id|arb_ring_stat_change
op_star
)paren
(paren
id|ti-&gt;arb
)paren
suffix:semicolon
r_int
r_int
id|ring_status
op_assign
id|ntohs
c_func
(paren
id|ring_stat_change-&gt;ring_status
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ring_status
op_amp
(paren
id|SIGNAL_LOSS
op_plus
id|LOBE_FAULT
)paren
)paren
(brace
id|DPRINTK
c_func
(paren
l_string|&quot;Signal loss/Lobe fault&bslash;n&quot;
)paren
suffix:semicolon
id|DPRINTK
c_func
(paren
l_string|&quot;We try to reopen the adapter.&bslash;n&quot;
)paren
suffix:semicolon
id|tr_timer.expires
op_assign
id|jiffies
op_plus
id|TR_RETRY_INTERVAL
suffix:semicolon
id|tr_timer.data
op_assign
(paren
r_int
r_int
)paren
id|dev
suffix:semicolon
id|tr_timer.next
op_assign
id|tr_timer.prev
op_assign
l_int|NULL
suffix:semicolon
id|add_timer
c_func
(paren
op_amp
id|tr_timer
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|ring_status
op_amp
(paren
id|HARD_ERROR
op_plus
id|XMIT_BEACON
op_plus
id|AUTO_REMOVAL
op_plus
id|REMOVE_RECV
op_plus
id|RING_RECOVER
)paren
)paren
id|DPRINTK
c_func
(paren
l_string|&quot;New ring status: %02X&bslash;n&quot;
comma
id|ring_status
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ring_status
op_amp
id|LOG_OVERFLOW
)paren
(brace
op_star
(paren
id|ti-&gt;srb
)paren
op_assign
id|DIR_READ_LOG
suffix:semicolon
op_star
(paren
r_int
r_char
op_star
)paren
(paren
id|ti-&gt;mmio
op_plus
id|ACA_OFFSET
op_plus
id|ACA_SET
op_plus
id|ISRP_EVEN
)paren
op_assign
id|INT_ENABLE
suffix:semicolon
op_star
(paren
r_int
r_char
op_star
)paren
(paren
id|ti-&gt;mmio
op_plus
id|ACA_OFFSET
op_plus
id|ACA_SET
op_plus
id|ISRA_ODD
)paren
op_assign
id|CMD_IN_SRB
suffix:semicolon
id|dev-&gt;tbusy
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* really srb busy... */
)brace
)brace
r_break
suffix:semicolon
r_case
id|XMIT_DATA_REQ
suffix:colon
id|tr_tx
c_func
(paren
id|dev
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|DPRINTK
c_func
(paren
l_string|&quot;Unknown command %02X in arb&bslash;n&quot;
comma
op_star
(paren
id|ti-&gt;arb
)paren
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
op_star
(paren
r_int
r_char
op_star
)paren
(paren
id|ti-&gt;mmio
op_plus
id|ACA_OFFSET
op_plus
id|ACA_RESET
op_plus
id|ISRP_ODD
)paren
op_assign
op_complement
(paren
id|ARB_CMD_INT
)paren
suffix:semicolon
op_star
(paren
r_int
r_char
op_star
)paren
(paren
id|ti-&gt;mmio
op_plus
id|ACA_OFFSET
op_plus
id|ACA_SET
op_plus
id|ISRA_ODD
)paren
op_assign
id|ARB_FREE
suffix:semicolon
)brace
r_if
c_cond
(paren
id|status
op_amp
id|SSB_RESP_INT
)paren
(brace
r_switch
c_cond
(paren
op_star
id|ti-&gt;ssb
)paren
(brace
r_case
id|XMIT_DIR_FRAME
suffix:colon
r_case
id|XMIT_UI_FRAME
suffix:colon
r_if
c_cond
(paren
op_star
(paren
id|ti-&gt;ssb
op_plus
l_int|2
)paren
)paren
(brace
id|DPRINTK
c_func
(paren
l_string|&quot;xmit ret_code: %02X xmit error code: %02X&bslash;n&quot;
comma
op_star
(paren
id|ti-&gt;ssb
op_plus
l_int|2
)paren
comma
op_star
(paren
id|ti-&gt;ssb
op_plus
l_int|6
)paren
)paren
suffix:semicolon
)brace
r_else
id|ti-&gt;tr_stats.tx_packets
op_increment
suffix:semicolon
r_break
suffix:semicolon
r_case
id|XMIT_XID_CMD
suffix:colon
id|DPRINTK
c_func
(paren
l_string|&quot;xmit xid ret_code: %02X&bslash;n&quot;
comma
op_star
(paren
id|ti-&gt;ssb
op_plus
l_int|2
)paren
)paren
suffix:semicolon
r_default
suffix:colon
id|DPRINTK
c_func
(paren
l_string|&quot;Unknown command %02X in ssb&bslash;n&quot;
comma
op_star
(paren
id|ti-&gt;ssb
)paren
)paren
suffix:semicolon
)brace
op_star
(paren
r_int
r_char
op_star
)paren
(paren
id|ti-&gt;mmio
op_plus
id|ACA_OFFSET
op_plus
id|ACA_RESET
op_plus
id|ISRP_ODD
)paren
op_assign
op_complement
(paren
id|SSB_RESP_INT
)paren
suffix:semicolon
op_star
(paren
r_int
r_char
op_star
)paren
(paren
id|ti-&gt;mmio
op_plus
id|ACA_OFFSET
op_plus
id|ACA_SET
op_plus
id|ISRA_ODD
)paren
op_assign
id|SSB_FREE
suffix:semicolon
)brace
)brace
id|dev-&gt;interrupt
op_assign
l_int|0
suffix:semicolon
op_star
(paren
r_int
r_char
op_star
)paren
(paren
id|ti-&gt;mmio
op_plus
id|ACA_OFFSET
op_plus
id|ACA_SET
op_plus
id|ISRP_EVEN
)paren
op_assign
id|INT_ENABLE
suffix:semicolon
r_return
suffix:semicolon
r_break
suffix:semicolon
r_case
id|FIRST_INT
suffix:colon
id|initial_tok_int
c_func
(paren
id|dev
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|DPRINTK
c_func
(paren
l_string|&quot;Unexpected interrupt from tr adapter&bslash;n&quot;
)paren
suffix:semicolon
)brace
)brace
DECL|function|initial_tok_int
r_static
r_void
id|initial_tok_int
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
macro_line|#ifndef TR_NEWFORMAT
r_int
id|i
suffix:semicolon
macro_line|#endif
r_int
r_char
op_star
id|encoded_addr
suffix:semicolon
r_struct
id|tok_info
op_star
id|ti
suffix:semicolon
id|ti
op_assign
(paren
r_struct
id|tok_info
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
op_star
(paren
r_int
r_char
op_star
)paren
(paren
id|ti-&gt;mmio
op_plus
id|ACA_OFFSET
op_plus
id|ACA_RESET
op_plus
id|ISRP_EVEN
)paren
op_assign
(paren
op_complement
id|INT_ENABLE
)paren
suffix:semicolon
multiline_comment|/* Reset interrupt for ISA boards */
r_if
c_cond
(paren
id|ti-&gt;global_int_enable
)paren
(brace
id|outb
c_func
(paren
l_int|0
comma
id|ti-&gt;global_int_enable
)paren
suffix:semicolon
)brace
id|ti-&gt;do_tok_int
op_assign
id|NOT_FIRST
suffix:semicolon
macro_line|#ifndef TR_NEWFORMAT
id|DPRINTK
c_func
(paren
l_string|&quot;Initial tok int received&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
op_logical_neg
id|ti-&gt;sram
)paren
(brace
multiline_comment|/* we assign the address for ISA devices */
multiline_comment|/* set RRR even to D000 for shared ram address */
op_star
(paren
r_int
r_char
op_star
)paren
(paren
id|ti-&gt;mmio
op_plus
id|ACA_OFFSET
op_plus
id|ACA_RW
op_plus
id|RRR_EVEN
)paren
op_assign
id|ti-&gt;sram_base
suffix:semicolon
id|ti-&gt;sram
op_assign
(paren
r_char
op_star
)paren
(paren
id|ti-&gt;sram_base
op_lshift
l_int|12
)paren
suffix:semicolon
)brace
id|ti-&gt;init_srb
op_assign
id|ti-&gt;sram
op_plus
id|ntohs
c_func
(paren
op_star
(paren
r_int
r_int
op_star
)paren
(paren
id|ti-&gt;mmio
op_plus
id|ACA_OFFSET
op_plus
id|WRBR_EVEN
)paren
)paren
suffix:semicolon
id|SET_PAGE
c_func
(paren
id|ntohs
c_func
(paren
op_star
(paren
r_int
r_int
op_star
)paren
(paren
id|ti-&gt;mmio
op_plus
id|ACA_OFFSET
op_plus
id|WRBR_EVEN
)paren
)paren
)paren
suffix:semicolon
macro_line|#if 0
id|DPRINTK
c_func
(paren
l_string|&quot;init_srb(%p):&quot;
comma
id|ti-&gt;init_srb
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|17
suffix:semicolon
id|i
op_increment
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%02X &quot;
comma
op_star
(paren
id|ti-&gt;init_srb
op_plus
id|i
)paren
)paren
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
macro_line|#ifndef TR_NEWFORMAT&t;&t;
id|DPRINTK
c_func
(paren
l_string|&quot;srb_init_response-&gt;encoded_address: %04X&bslash;n&quot;
comma
(paren
(paren
r_struct
id|srb_init_response
op_star
)paren
id|ti-&gt;init_srb
)paren
op_member_access_from_pointer
id|encoded_address
)paren
suffix:semicolon
id|DPRINTK
c_func
(paren
l_string|&quot;ntohs(srb_init_response-&gt;encoded_address): %04X&bslash;n&quot;
comma
id|ntohs
c_func
(paren
(paren
(paren
r_struct
id|srb_init_response
op_star
)paren
id|ti-&gt;init_srb
)paren
op_member_access_from_pointer
id|encoded_address
)paren
)paren
suffix:semicolon
macro_line|#endif
id|encoded_addr
op_assign
(paren
r_int
r_char
op_star
)paren
(paren
id|ti-&gt;sram
op_plus
id|ntohs
c_func
(paren
(paren
(paren
r_struct
id|srb_init_response
op_star
)paren
id|ti-&gt;init_srb
)paren
op_member_access_from_pointer
id|encoded_address
)paren
)paren
suffix:semicolon
macro_line|#ifndef TR_NEWFORMAT
id|DPRINTK
c_func
(paren
l_string|&quot;encoded addr (%04X,%04X,%p): &quot;
comma
(paren
(paren
r_struct
id|srb_init_response
op_star
)paren
id|ti-&gt;init_srb
)paren
op_member_access_from_pointer
id|encoded_address
comma
id|ntohs
c_func
(paren
(paren
(paren
r_struct
id|srb_init_response
op_star
)paren
id|ti-&gt;init_srb
)paren
op_member_access_from_pointer
id|encoded_address
)paren
comma
id|encoded_addr
)paren
suffix:semicolon
macro_line|#else
id|DPRINTK
c_func
(paren
l_string|&quot;Initial interrupt : shared RAM located at %p.&bslash;n&quot;
comma
id|encoded_addr
)paren
suffix:semicolon
macro_line|#endif
id|ti-&gt;auto_ringspeedsave
op_assign
(paren
(paren
r_struct
id|srb_init_response
op_star
)paren
id|ti-&gt;init_srb
)paren
op_member_access_from_pointer
id|init_status_2
op_amp
l_int|0x4
ques
c_cond
id|TRUE
suffix:colon
id|FALSE
suffix:semicolon
macro_line|#ifndef TR_NEWFORMAT
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|TR_ALEN
suffix:semicolon
id|i
op_increment
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%02X%s&quot;
comma
id|dev-&gt;dev_addr
(braket
id|i
)braket
op_assign
id|encoded_addr
(braket
id|i
)braket
comma
(paren
id|i
op_eq
id|TR_ALEN
op_minus
l_int|1
)paren
ques
c_cond
l_string|&quot;&quot;
suffix:colon
l_string|&quot;:&quot;
)paren
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
id|tok_open_adapter
c_func
(paren
(paren
r_int
r_int
)paren
id|dev
)paren
suffix:semicolon
)brace
DECL|function|tok_init_card
r_static
r_void
id|tok_init_card
c_func
(paren
r_int
r_int
id|dev_addr
)paren
(brace
r_struct
id|tok_info
op_star
id|ti
suffix:semicolon
r_int
id|PIOaddr
suffix:semicolon
r_int
id|i
suffix:semicolon
r_struct
id|device
op_star
id|dev
op_assign
(paren
r_struct
id|device
op_star
)paren
id|dev_addr
suffix:semicolon
id|PIOaddr
op_assign
id|dev-&gt;base_addr
suffix:semicolon
id|ti
op_assign
(paren
r_struct
id|tok_info
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
multiline_comment|/* Special processing for first interrupt after reset */
id|ti-&gt;do_tok_int
op_assign
id|FIRST_INT
suffix:semicolon
multiline_comment|/* Reset adapter */
id|dev-&gt;tbusy
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* nothing can be done before reset and open completed */
macro_line|#ifdef ENABLE_PAGING
r_if
c_cond
(paren
id|ti-&gt;page_mask
)paren
(brace
op_star
(paren
r_int
r_char
op_star
)paren
(paren
id|ti-&gt;mmio
op_plus
id|ACA_OFFSET
op_plus
id|ACA_RW
op_plus
id|SRPR_EVEN
)paren
op_assign
id|SRPR_ENABLE_PAGING
suffix:semicolon
)brace
macro_line|#endif
op_star
(paren
r_int
r_char
op_star
)paren
(paren
id|ti-&gt;mmio
op_plus
id|ACA_OFFSET
op_plus
id|ACA_RESET
op_plus
id|ISRP_EVEN
)paren
op_assign
op_complement
(paren
id|INT_ENABLE
)paren
suffix:semicolon
macro_line|#ifndef TR_NEWFORMAT
id|DPRINTK
c_func
(paren
l_string|&quot;resetting card&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
id|outb
c_func
(paren
l_int|0
comma
id|PIOaddr
op_plus
id|ADAPTRESET
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
id|jiffies
op_plus
l_int|5
suffix:semicolon
id|jiffies
op_le
id|i
suffix:semicolon
)paren
(brace
suffix:semicolon
)brace
multiline_comment|/* wait 50ms */
id|outb
c_func
(paren
l_int|0
comma
id|PIOaddr
op_plus
id|ADAPTRESETREL
)paren
suffix:semicolon
macro_line|#ifndef TR_NEWFORMAT
id|DPRINTK
c_func
(paren
l_string|&quot;card reset&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
id|ti-&gt;open_status
op_assign
id|IN_PROGRESS
suffix:semicolon
op_star
(paren
r_int
r_char
op_star
)paren
(paren
id|ti-&gt;mmio
op_plus
id|ACA_OFFSET
op_plus
id|ACA_SET
op_plus
id|ISRP_EVEN
)paren
op_assign
id|INT_ENABLE
suffix:semicolon
)brace
DECL|function|open_sap
r_static
r_void
id|open_sap
c_func
(paren
r_int
r_char
id|type
comma
r_struct
id|device
op_star
id|dev
)paren
(brace
r_struct
id|tok_info
op_star
id|ti
op_assign
(paren
r_struct
id|tok_info
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_struct
id|dlc_open_sap
op_star
id|open_sap
op_assign
(paren
r_struct
id|dlc_open_sap
op_star
)paren
id|ti-&gt;srb
suffix:semicolon
id|SET_PAGE
c_func
(paren
id|ti-&gt;srb
)paren
suffix:semicolon
id|memset
c_func
(paren
id|open_sap
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|dlc_open_sap
)paren
)paren
suffix:semicolon
id|open_sap-&gt;command
op_assign
id|DLC_OPEN_SAP
suffix:semicolon
id|open_sap-&gt;max_i_field
op_assign
id|htons
c_func
(paren
id|MAX_I_FIELD
)paren
suffix:semicolon
id|open_sap-&gt;sap_options
op_assign
id|SAP_OPEN_IND_SAP
op_or
id|SAP_OPEN_PRIORITY
suffix:semicolon
id|open_sap-&gt;station_count
op_assign
id|SAP_OPEN_STATION_CNT
suffix:semicolon
id|open_sap-&gt;sap_value
op_assign
id|type
suffix:semicolon
op_star
(paren
r_int
r_char
op_star
)paren
(paren
id|ti-&gt;mmio
op_plus
id|ACA_OFFSET
op_plus
id|ACA_SET
op_plus
id|ISRA_ODD
)paren
op_assign
id|CMD_IN_SRB
suffix:semicolon
)brace
DECL|function|tok_open_adapter
r_void
id|tok_open_adapter
c_func
(paren
r_int
r_int
id|dev_addr
)paren
(brace
r_struct
id|device
op_star
id|dev
op_assign
(paren
r_struct
id|device
op_star
)paren
id|dev_addr
suffix:semicolon
r_struct
id|dir_open_adapter
op_star
id|open_adapter
suffix:semicolon
r_struct
id|tok_info
op_star
id|ti
suffix:semicolon
id|ti
op_assign
(paren
r_struct
id|tok_info
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
macro_line|#ifndef TR_NEWFORMAT
id|DPRINTK
c_func
(paren
l_string|&quot;now opening the board...&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
op_star
(paren
r_int
r_char
op_star
)paren
(paren
id|ti-&gt;mmio
op_plus
id|ACA_OFFSET
op_plus
id|ACA_RESET
op_plus
id|ISRP_ODD
)paren
op_assign
op_complement
(paren
id|SRB_RESP_INT
)paren
suffix:semicolon
op_star
(paren
r_int
r_char
op_star
)paren
(paren
id|ti-&gt;mmio
op_plus
id|ACA_OFFSET
op_plus
id|ACA_RESET
op_plus
id|ISRA_ODD
)paren
op_assign
op_complement
(paren
id|CMD_IN_SRB
)paren
suffix:semicolon
id|open_adapter
op_assign
(paren
r_struct
id|dir_open_adapter
op_star
)paren
(paren
id|ti-&gt;init_srb
)paren
suffix:semicolon
id|memset
c_func
(paren
id|open_adapter
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|dir_open_adapter
)paren
)paren
suffix:semicolon
id|open_adapter-&gt;command
op_assign
id|DIR_OPEN_ADAPTER
suffix:semicolon
id|open_adapter-&gt;open_options
op_assign
id|htons
c_func
(paren
id|OPEN_PASS_BCON_MAC
)paren
suffix:semicolon
id|open_adapter-&gt;num_rcv_buf
op_assign
id|htons
c_func
(paren
id|NUM_RCV_BUF
)paren
suffix:semicolon
id|open_adapter-&gt;rcv_buf_len
op_assign
id|htons
c_func
(paren
id|RCV_BUF_LEN
)paren
suffix:semicolon
id|open_adapter-&gt;dhb_length
op_assign
id|htons
c_func
(paren
id|DHB_LENGTH
)paren
suffix:semicolon
id|open_adapter-&gt;num_dhb
op_assign
id|NUM_DHB
suffix:semicolon
id|open_adapter-&gt;dlc_max_sap
op_assign
id|DLC_MAX_SAP
suffix:semicolon
id|open_adapter-&gt;dlc_max_sta
op_assign
id|DLC_MAX_STA
suffix:semicolon
id|ti-&gt;srb
op_assign
id|ti-&gt;init_srb
suffix:semicolon
multiline_comment|/* We use this one in the interrupt handler */
op_star
(paren
r_int
r_char
op_star
)paren
(paren
id|ti-&gt;mmio
op_plus
id|ACA_OFFSET
op_plus
id|ACA_SET
op_plus
id|ISRP_EVEN
)paren
op_assign
id|INT_ENABLE
suffix:semicolon
op_star
(paren
r_int
r_char
op_star
)paren
(paren
id|ti-&gt;mmio
op_plus
id|ACA_OFFSET
op_plus
id|ACA_SET
op_plus
id|ISRA_ODD
)paren
op_assign
id|CMD_IN_SRB
suffix:semicolon
)brace
DECL|function|tr_tx
r_static
r_void
id|tr_tx
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
r_struct
id|tok_info
op_star
id|ti
op_assign
(paren
r_struct
id|tok_info
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_struct
id|asb_xmit_resp
op_star
id|xmit_resp
op_assign
(paren
r_struct
id|asb_xmit_resp
op_star
)paren
id|ti-&gt;asb
suffix:semicolon
r_struct
id|arb_xmit_req
op_star
id|xmit_req
op_assign
(paren
r_struct
id|arb_xmit_req
op_star
)paren
id|ti-&gt;arb
suffix:semicolon
r_struct
id|srb_xmit
op_star
id|xmit
op_assign
(paren
r_struct
id|srb_xmit
op_star
)paren
id|ti-&gt;srb
suffix:semicolon
r_struct
id|trh_hdr
op_star
id|trhdr
op_assign
(paren
r_struct
id|trh_hdr
op_star
)paren
id|ti-&gt;current_skb-&gt;data
suffix:semicolon
r_int
r_int
id|hdr_len
suffix:semicolon
r_int
r_char
op_star
id|dhb
suffix:semicolon
multiline_comment|/* */
id|DPRINTD
c_func
(paren
l_string|&quot;ti=%p asb=(%p,%p) arb=(%p,%p) srb=(%p,%p)&bslash;n&quot;
comma
id|ti
comma
id|ti-&gt;asb
comma
id|xmit_resp
comma
id|ti-&gt;arb
comma
id|xmit_req
comma
id|ti-&gt;srb
comma
id|xmit
)paren
suffix:semicolon
multiline_comment|/* */
macro_line|#if 0
id|DPRINTK
c_func
(paren
l_string|&quot;transmitting...&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|xmit_resp-&gt;ret_code
op_ne
l_int|0xff
)paren
(brace
id|DPRINTK
c_func
(paren
l_string|&quot;ASB not free !!!&bslash;n&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/*  in providing the transmit interrupts,&n;                         is telling us it is ready for data and&n;                         providing a shared memory address for us&n;                         to stuff with data.  Here we compute the&n;                         effective address where we will place data.*/
id|dhb
op_assign
id|ti-&gt;sram
op_plus
id|ntohs
c_func
(paren
id|xmit_req-&gt;dhb_address
)paren
suffix:semicolon
id|xmit_resp-&gt;command
op_assign
id|xmit-&gt;command
suffix:semicolon
id|xmit_resp-&gt;station_id
op_assign
id|xmit_req-&gt;station_id
suffix:semicolon
id|xmit_resp-&gt;rsap_value
op_assign
id|EXTENDED_SAP
suffix:semicolon
id|xmit_resp-&gt;cmd_corr
op_assign
id|xmit_req-&gt;cmd_corr
suffix:semicolon
id|xmit_resp-&gt;ret_code
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
(paren
id|xmit-&gt;command
op_eq
id|XMIT_XID_CMD
)paren
op_logical_or
(paren
id|xmit-&gt;command
op_eq
id|XMIT_TEST_CMD
)paren
)paren
(brace
id|xmit_resp-&gt;frame_length
op_assign
id|htons
c_func
(paren
l_int|0x11
)paren
suffix:semicolon
id|xmit_resp-&gt;hdr_length
op_assign
l_int|0x0e
suffix:semicolon
id|dhb
(braket
l_int|0
)braket
op_assign
id|AC
suffix:semicolon
id|dhb
(braket
l_int|1
)braket
op_assign
id|LLC_FRAME
suffix:semicolon
id|memset
c_func
(paren
id|dhb
op_plus
l_int|2
comma
(paren
r_int
)paren
l_int|0x0ff
comma
id|TR_ALEN
)paren
suffix:semicolon
id|memset
c_func
(paren
id|dhb
op_plus
l_int|2
op_plus
id|TR_ALEN
comma
l_int|0
comma
id|TR_ALEN
)paren
suffix:semicolon
op_star
(paren
r_int
r_char
op_star
)paren
(paren
id|ti-&gt;mmio
op_plus
id|ACA_OFFSET
op_plus
id|ACA_SET
op_plus
id|ISRA_ODD
)paren
op_assign
id|RESP_IN_ASB
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/* the token ring packet is copied from sk_buff to the adapter&n;        buffer identified in the command data received with the&n;        interrupt.  The sk_buff area was set up with a maximum&n;        sized route information field so here we must compress&n;        out the extra (all) rif fields.   */
multiline_comment|/* nb/dwm .... I re-arranged code here to avoid copy of extra&n;        bytes, ended up with fewer statements as well             */
multiline_comment|/*  TR arch. identifies if RIF present by high bit of source&n;         address.  So here we check if RIF present */
r_if
c_cond
(paren
op_logical_neg
(paren
id|trhdr-&gt;saddr
(braket
l_int|0
)braket
op_amp
l_int|0x80
)paren
)paren
(brace
id|hdr_len
op_assign
r_sizeof
(paren
r_struct
id|trh_hdr
)paren
op_minus
l_int|18
suffix:semicolon
macro_line|#if 0
id|DPRINTK
c_func
(paren
(paren
l_string|&quot;hdr_length: %d, frame length: %ld&bslash;n&quot;
comma
id|hdr_len
comma
id|ti-&gt;current_skb-&gt;len
op_minus
l_int|18
)paren
)paren
suffix:semicolon
macro_line|#endif
)brace
multiline_comment|/*  TR packet includes RIF data ... preserve it */
r_else
(brace
id|hdr_len
op_assign
(paren
(paren
id|ntohs
c_func
(paren
id|trhdr-&gt;rcf
)paren
op_amp
id|TR_RCF_LEN_MASK
)paren
op_rshift
l_int|8
)paren
op_plus
r_sizeof
(paren
r_struct
id|trh_hdr
)paren
op_minus
l_int|18
suffix:semicolon
macro_line|#if 0
multiline_comment|/* rework the following if activated, hdr_len &lt;&gt; rif_len */
id|DPRINTK
c_func
(paren
l_string|&quot;rcf: %02X rif_len: %d&bslash;n&quot;
comma
id|trhdr-&gt;rcf
comma
id|wrk_len
)paren
suffix:semicolon
id|DPRINTK
c_func
(paren
l_string|&quot;hdr_length: %d, frame length: %ld&bslash;n&quot;
comma
r_sizeof
(paren
r_struct
id|trh_hdr
)paren
op_minus
l_int|18
op_plus
id|hdr_len
comma
id|ti-&gt;current_skb-&gt;len
op_minus
l_int|18
op_plus
id|hdr_len
)paren
suffix:semicolon
macro_line|#endif
)brace
multiline_comment|/* header length including rif is computed above, now move the data&n;     and set fields appropriately.     */
id|memcpy
c_func
(paren
id|dhb
comma
id|ti-&gt;current_skb-&gt;data
comma
id|hdr_len
)paren
suffix:semicolon
id|dhb
op_add_assign
id|hdr_len
suffix:semicolon
id|xmit_resp-&gt;hdr_length
op_assign
id|hdr_len
suffix:semicolon
id|xmit_resp-&gt;frame_length
op_assign
id|htons
c_func
(paren
id|ti-&gt;current_skb-&gt;len
op_minus
r_sizeof
(paren
r_struct
id|trh_hdr
)paren
op_plus
id|hdr_len
)paren
suffix:semicolon
multiline_comment|/*  now copy the actual packet data next to hdr */
id|memcpy
c_func
(paren
id|dhb
comma
id|ti-&gt;current_skb-&gt;data
op_plus
r_sizeof
(paren
r_struct
id|trh_hdr
)paren
comma
id|ti-&gt;current_skb-&gt;len
op_minus
r_sizeof
(paren
r_struct
id|trh_hdr
)paren
)paren
suffix:semicolon
op_star
(paren
r_int
r_char
op_star
)paren
(paren
id|ti-&gt;mmio
op_plus
id|ACA_OFFSET
op_plus
id|ACA_SET
op_plus
id|ISRA_ODD
)paren
op_assign
id|RESP_IN_ASB
suffix:semicolon
id|dev-&gt;tbusy
op_assign
l_int|0
suffix:semicolon
id|dev_kfree_skb
c_func
(paren
id|ti-&gt;current_skb
comma
id|FREE_WRITE
)paren
suffix:semicolon
id|ti-&gt;current_skb
op_assign
l_int|NULL
suffix:semicolon
id|mark_bh
c_func
(paren
id|NET_BH
)paren
suffix:semicolon
)brace
DECL|function|tr_rx
r_static
r_void
id|tr_rx
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
r_struct
id|tok_info
op_star
id|ti
op_assign
(paren
r_struct
id|tok_info
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_struct
id|arb_rec_req
op_star
id|rec_req
op_assign
(paren
r_struct
id|arb_rec_req
op_star
)paren
id|ti-&gt;arb
suffix:semicolon
r_struct
id|asb_rec
op_star
id|rec_resp
op_assign
(paren
r_struct
id|asb_rec
op_star
)paren
id|ti-&gt;asb
suffix:semicolon
r_struct
id|rec_buf
op_star
id|rbuffer
suffix:semicolon
r_struct
id|trllc
op_star
id|llc
suffix:semicolon
r_int
r_char
op_star
id|data
suffix:semicolon
r_int
r_int
id|rbuffer_len
comma
id|lan_hdr_len
suffix:semicolon
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
id|rbuffer
op_assign
(paren
r_struct
id|rec_buf
op_star
)paren
(paren
id|ti-&gt;sram
op_plus
id|ntohs
c_func
(paren
id|rec_req-&gt;rec_buf_addr
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rec_resp-&gt;ret_code
op_ne
l_int|0xff
)paren
(brace
id|DPRINTK
c_func
(paren
l_string|&quot;ASB not free !!!&bslash;n&quot;
)paren
suffix:semicolon
)brace
id|rec_resp-&gt;command
op_assign
id|REC_DATA
suffix:semicolon
id|rec_resp-&gt;station_id
op_assign
id|rec_req-&gt;station_id
suffix:semicolon
id|rec_resp-&gt;rec_buf_addr
op_assign
id|rec_req-&gt;rec_buf_addr
suffix:semicolon
id|lan_hdr_len
op_assign
id|rec_req-&gt;lan_hdr_len
suffix:semicolon
id|llc
op_assign
(paren
r_struct
id|trllc
op_star
)paren
(paren
(paren
r_int
r_char
op_star
)paren
id|rbuffer
op_plus
m_offsetof
(paren
r_struct
id|rec_buf
comma
id|data
)paren
op_plus
id|lan_hdr_len
)paren
suffix:semicolon
macro_line|#if 0
id|DPRINTK
c_func
(paren
l_string|&quot;offsetof data: %02X lan_hdr_len: %02X&bslash;n&quot;
comma
m_offsetof
(paren
r_struct
id|rec_buf
comma
id|data
)paren
comma
id|lan_hdr_len
)paren
suffix:semicolon
id|DPRINTK
c_func
(paren
l_string|&quot;llc: %p rec_buf_addr: %04X ti-&gt;sram: %p&bslash;n&quot;
comma
id|llc
comma
id|ntohs
c_func
(paren
id|rec_req-&gt;rec_buf_addr
)paren
comma
id|ti-&gt;sram
)paren
suffix:semicolon
id|DPRINTK
c_func
(paren
l_string|&quot;dsap: %02X, ssap: %02X, llc: %02X, protid: %02X%02X%02X, ethertype: %04X&bslash;n&quot;
comma
id|llc-&gt;dsap
comma
id|llc-&gt;ssap
comma
id|llc-&gt;llc
comma
id|llc-&gt;protid
(braket
l_int|0
)braket
comma
id|llc-&gt;protid
(braket
l_int|1
)braket
comma
id|llc-&gt;protid
(braket
l_int|2
)braket
comma
id|llc-&gt;ethertype
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|llc-&gt;llc
op_ne
id|UI_CMD
)paren
(brace
macro_line|#ifndef TR_FILTERNONUI&t;&t;
id|DPRINTK
c_func
(paren
l_string|&quot;non-UI frame arrived. dropped. llc= %02X&bslash;n&quot;
comma
id|llc-&gt;llc
)paren
suffix:semicolon
macro_line|#endif
id|rec_resp-&gt;ret_code
op_assign
id|DATA_LOST
suffix:semicolon
id|ti-&gt;tr_stats.rx_dropped
op_increment
suffix:semicolon
op_star
(paren
r_int
r_char
op_star
)paren
(paren
id|ti-&gt;mmio
op_plus
id|ACA_OFFSET
op_plus
id|ACA_SET
op_plus
id|ISRA_ODD
)paren
op_assign
id|RESP_IN_ASB
suffix:semicolon
r_return
suffix:semicolon
)brace
macro_line|#if 0
r_if
c_cond
(paren
(paren
id|llc-&gt;dsap
op_ne
l_int|0xaa
)paren
op_logical_or
(paren
id|llc-&gt;ssap
op_ne
l_int|0xaa
)paren
)paren
(brace
r_struct
id|trh_hdr
op_star
id|trhdr
op_assign
(paren
r_struct
id|trh_hdr
op_star
)paren
(paren
(paren
r_int
r_char
op_star
)paren
id|rbuffer
op_plus
m_offsetof
(paren
r_struct
id|rec_buf
comma
id|data
)paren
)paren
suffix:semicolon
id|DPRINTK
c_func
(paren
l_string|&quot;Probably non-IP frame received.&bslash;n&quot;
)paren
suffix:semicolon
id|DPRINTK
c_func
(paren
l_string|&quot;ssap: %02X dsap: %02X saddr: %02X:%02X:%02X:%02X:%02X:%02X daddr: %02X:%02X:%02X:%02X:%02X:%02X&bslash;n&quot;
comma
id|llc-&gt;ssap
comma
id|llc-&gt;dsap
comma
id|trhdr-&gt;saddr
(braket
l_int|0
)braket
comma
id|trhdr-&gt;saddr
(braket
l_int|1
)braket
comma
id|trhdr-&gt;saddr
(braket
l_int|2
)braket
comma
id|trhdr-&gt;saddr
(braket
l_int|3
)braket
comma
id|trhdr-&gt;saddr
(braket
l_int|4
)braket
comma
id|trhdr-&gt;saddr
(braket
l_int|5
)braket
comma
id|trhdr-&gt;daddr
(braket
l_int|0
)braket
comma
id|trhdr-&gt;daddr
(braket
l_int|1
)braket
comma
id|trhdr-&gt;daddr
(braket
l_int|2
)braket
comma
id|trhdr-&gt;daddr
(braket
l_int|3
)braket
comma
id|trhdr-&gt;daddr
(braket
l_int|4
)braket
comma
id|trhdr-&gt;daddr
(braket
l_int|5
)braket
)paren
suffix:semicolon
)brace
macro_line|#endif
r_if
c_cond
(paren
op_logical_neg
(paren
id|skb
op_assign
id|dev_alloc_skb
c_func
(paren
id|ntohs
c_func
(paren
id|rec_req-&gt;frame_len
)paren
op_minus
id|lan_hdr_len
op_plus
r_sizeof
(paren
r_struct
id|trh_hdr
)paren
)paren
)paren
)paren
(brace
id|DPRINTK
c_func
(paren
l_string|&quot;out of memory. frame dropped.&bslash;n&quot;
)paren
suffix:semicolon
id|ti-&gt;tr_stats.rx_dropped
op_increment
suffix:semicolon
id|rec_resp-&gt;ret_code
op_assign
id|DATA_LOST
suffix:semicolon
op_star
(paren
r_int
r_char
op_star
)paren
(paren
id|ti-&gt;mmio
op_plus
id|ACA_OFFSET
op_plus
id|ACA_SET
op_plus
id|ISRA_ODD
)paren
op_assign
id|RESP_IN_ASB
suffix:semicolon
r_return
suffix:semicolon
)brace
id|skb_put
c_func
(paren
id|skb
comma
id|ntohs
c_func
(paren
id|rec_req-&gt;frame_len
)paren
op_minus
id|lan_hdr_len
op_plus
r_sizeof
(paren
r_struct
id|trh_hdr
)paren
)paren
suffix:semicolon
id|skb-&gt;dev
op_assign
id|dev
suffix:semicolon
macro_line|#if 0
id|DPRINTK
c_func
(paren
l_string|&quot;Now copying data...&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
id|data
op_assign
id|skb-&gt;data
suffix:semicolon
id|memcpy
c_func
(paren
id|data
comma
op_amp
(paren
id|rbuffer-&gt;data
)paren
comma
id|lan_hdr_len
)paren
suffix:semicolon
r_if
c_cond
(paren
id|lan_hdr_len
OL
r_sizeof
(paren
r_struct
id|trh_hdr
)paren
)paren
(brace
id|memset
c_func
(paren
id|data
op_plus
id|lan_hdr_len
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|trh_hdr
)paren
op_minus
id|lan_hdr_len
)paren
suffix:semicolon
)brace
id|data
op_add_assign
r_sizeof
(paren
r_struct
id|trh_hdr
)paren
suffix:semicolon
id|rbuffer_len
op_assign
id|ntohs
c_func
(paren
id|rbuffer-&gt;buf_len
)paren
op_minus
id|lan_hdr_len
suffix:semicolon
macro_line|#if 0
id|DPRINTK
c_func
(paren
l_string|&quot;rbuffer_len: %d, data: %p&bslash;n&quot;
comma
id|rbuffer_len
comma
id|data
)paren
suffix:semicolon
macro_line|#endif
id|memcpy
c_func
(paren
id|data
comma
(paren
r_int
r_char
op_star
)paren
(paren
op_amp
(paren
id|rbuffer-&gt;data
)paren
)paren
op_plus
id|lan_hdr_len
comma
id|rbuffer_len
)paren
suffix:semicolon
id|data
op_add_assign
id|rbuffer_len
suffix:semicolon
r_if
c_cond
(paren
id|rbuffer-&gt;buf_ptr
)paren
r_for
c_loop
(paren
id|rbuffer
op_assign
(paren
r_struct
id|rec_buf
op_star
)paren
(paren
id|ti-&gt;sram
op_plus
id|ntohs
c_func
(paren
id|rbuffer-&gt;buf_ptr
)paren
op_minus
l_int|2
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|data
comma
op_amp
(paren
id|rbuffer-&gt;data
)paren
comma
id|rbuffer_len
op_assign
id|ntohs
c_func
(paren
id|rbuffer-&gt;buf_len
)paren
)paren
comma
id|rbuffer-&gt;buf_ptr
suffix:semicolon
id|data
op_add_assign
id|rbuffer_len
comma
id|rbuffer
op_assign
(paren
r_struct
id|rec_buf
op_star
)paren
(paren
id|ti-&gt;sram
op_plus
id|ntohs
c_func
(paren
id|rbuffer-&gt;buf_ptr
)paren
op_minus
l_int|2
)paren
)paren
(brace
macro_line|#if 0
id|DPRINTK
c_func
(paren
l_string|&quot;buf_ptr: %d,data =%p&bslash;n&quot;
comma
id|ntohs
c_func
(paren
id|rbuffer-&gt;buf_ptr
)paren
comma
id|data
)paren
suffix:semicolon
)brace
macro_line|#endif
id|rec_resp-&gt;ret_code
op_assign
l_int|0
suffix:semicolon
op_star
(paren
r_int
r_char
op_star
)paren
(paren
id|ti-&gt;mmio
op_plus
id|ACA_OFFSET
op_plus
id|ACA_SET
op_plus
id|ISRA_ODD
)paren
op_assign
id|RESP_IN_ASB
suffix:semicolon
id|ti-&gt;tr_stats.rx_packets
op_increment
suffix:semicolon
id|skb-&gt;protocol
op_assign
id|tr_type_trans
c_func
(paren
id|skb
comma
id|dev
)paren
suffix:semicolon
id|netif_rx
c_func
(paren
id|skb
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
DECL|function|tok_send_packet
r_static
r_int
id|tok_send_packet
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|device
op_star
id|dev
)paren
(brace
r_struct
id|tok_info
op_star
id|ti
op_assign
(paren
r_struct
id|tok_info
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
macro_line|#if 0
id|DPRINTK
c_func
(paren
l_string|&quot;tada: sending packet...&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|dev-&gt;tbusy
)paren
(brace
r_int
id|ticks_waited
op_assign
id|jiffies
op_minus
id|dev-&gt;trans_start
suffix:semicolon
r_if
c_cond
(paren
id|ticks_waited
OL
l_int|5
)paren
(brace
r_return
l_int|1
suffix:semicolon
)brace
id|DPRINTK
c_func
(paren
l_string|&quot;Arrg. Transmitter busy for more than 50 msec. Donald resets adapter, but resetting&bslash;n &bslash;&n;the IBM tokenring adapter takes a long time. It might not even help when the&bslash;n &bslash;&n;ring is very busy, so we just wait a little longer and hope for the best.&bslash;n&quot;
)paren
suffix:semicolon
id|dev-&gt;trans_start
op_add_assign
l_int|5
suffix:semicolon
multiline_comment|/* we fake the transmission start time... */
r_return
l_int|1
suffix:semicolon
)brace
multiline_comment|/* Donald does this, so we do too. */
r_if
c_cond
(paren
id|skb
op_eq
l_int|NULL
)paren
(brace
id|dev_tint
c_func
(paren
id|dev
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|set_bit
c_func
(paren
l_int|0
comma
(paren
r_void
op_star
)paren
op_amp
id|dev-&gt;tbusy
)paren
op_ne
l_int|0
)paren
(brace
id|DPRINTK
c_func
(paren
l_string|&quot;Transmitter access conflict&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_else
(brace
r_struct
id|srb_xmit
op_star
id|xmit
op_assign
(paren
r_struct
id|srb_xmit
op_star
)paren
id|ti-&gt;srb
suffix:semicolon
id|ti-&gt;current_skb
op_assign
id|skb
suffix:semicolon
multiline_comment|/* save skb. We will need it when the adapter&n;                                  asks for the data */
id|xmit-&gt;command
op_assign
id|XMIT_UI_FRAME
suffix:semicolon
id|xmit-&gt;station_id
op_assign
id|ti-&gt;exsap_station_id
suffix:semicolon
op_star
(paren
r_int
r_char
op_star
)paren
(paren
id|ti-&gt;mmio
op_plus
id|ACA_OFFSET
op_plus
id|ACA_SET
op_plus
id|ISRA_ODD
)paren
op_assign
id|CMD_IN_SRB
suffix:semicolon
id|dev-&gt;trans_start
op_assign
id|jiffies
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* tok_get_stats():  Basically a scaffold routine which will return&n;         the address of the tr_statistics structure associated with&n;         this device -- the tr.... structure is a ethnet look-alike&n;         so at least for this iteration may suffice.   */
DECL|function|tok_get_stats
r_static
r_struct
id|enet_statistics
op_star
id|tok_get_stats
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
r_struct
id|tok_info
op_star
id|toki
suffix:semicolon
id|toki
op_assign
(paren
r_struct
id|tok_info
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_return
(paren
r_struct
id|enet_statistics
op_star
)paren
op_amp
id|toki-&gt;tr_stats
suffix:semicolon
)brace
macro_line|#ifdef MODULE
DECL|variable|devicename
r_static
r_char
id|devicename
(braket
l_int|9
)braket
op_assign
(brace
l_int|0
comma
)brace
suffix:semicolon
DECL|variable|dev_ibmtr
r_static
r_struct
id|device
id|dev_ibmtr
op_assign
(brace
id|devicename
comma
multiline_comment|/* device name is inserted by linux/drivers/net/net_init.c */
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|NULL
comma
id|tok_probe
)brace
suffix:semicolon
DECL|variable|io
r_static
r_int
id|io
op_assign
l_int|0xa20
suffix:semicolon
DECL|function|init_module
r_int
id|init_module
c_func
(paren
r_void
)paren
(brace
r_if
c_cond
(paren
id|io
op_eq
l_int|0
)paren
id|printk
c_func
(paren
l_string|&quot;ibmtr: You should not use auto-probing with insmod!&bslash;n&quot;
)paren
suffix:semicolon
id|dev_ibmtr.base_addr
op_assign
id|io
suffix:semicolon
id|dev_ibmtr.irq
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|register_netdev
c_func
(paren
op_amp
id|dev_ibmtr
)paren
op_ne
l_int|0
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;ibmtr: register_netdev() returned non-zero.&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
r_void
DECL|function|cleanup_module
id|cleanup_module
c_func
(paren
r_void
)paren
(brace
id|unregister_netdev
c_func
(paren
op_amp
id|dev_ibmtr
)paren
suffix:semicolon
multiline_comment|/* If we don&squot;t do this, we can&squot;t re-insmod it later. */
id|free_irq
c_func
(paren
id|dev_ibmtr.irq
)paren
suffix:semicolon
id|irq2dev_map
(braket
id|dev_ibmtr.irq
)braket
op_assign
l_int|NULL
suffix:semicolon
id|release_region
c_func
(paren
id|dev_ibmtr.base_addr
comma
id|TR_IO_EXTENT
)paren
suffix:semicolon
)brace
macro_line|#endif /* MODULE */
eof
