multiline_comment|/* ibmtr.c:  A shared-memory IBM Token Ring 16/4 driver for linux&n; *&n; *&t;Written 1993 by Mark Swanson and Peter De Schrijver.&n; *&t;This software may be used and distributed according to the terms&n; *&t;of the GNU Public License, incorporated herein by reference.&n; *&n; *&t;This device driver should work with Any IBM Token Ring Card that does&n; *&t;not use DMA.&n; *&n; *&t;I used Donald Becker&squot;s (becker@cesdis.gsfc.nasa.gov) device driver work&n; *&t;as a base for most of my initial work.&n; *&n; *&t;Changes by Peter De Schrijver (Peter.Deschrijver@linux.cc.kuleuven.ac.be) :&n; *&n; *&t;+ changed name to ibmtr.c in anticipation of other tr boards.&n; *&t;+ changed reset code and adapter open code.&n; *&t;+ added SAP open code.&n; *&t;+ a first attempt to write interrupt, transmit and receive routines.&n; *&n; *&t;Changes by David W. Morris (dwm@shell.portal.com) :&n; *&t;941003 dwm: - Restructure tok_probe for multiple adapters, devices.&n; *&t;+ Add comments, misc reorg for clarity.&n; *&t;+ Flatten interrupt handler levels.&n; *&n; *&t;Changes by Farzad Farid (farzy@zen.via.ecp.fr)&n; *&t;and Pascal Andre (andre@chimay.via.ecp.fr) (March 9 1995) :&n; *&t;+ multi ring support clean up.&n; *&t;+ RFC1042 compliance enhanced.&n; *&n; *&t;Changes by Pascal Andre (andre@chimay.via.ecp.fr) (September 7 1995) :&n; *&t;+ bug correction in tr_tx&n; *&t;+ removed redundant information display&n; *&t;+ some code reworking&n; *&n; *&t;Changes by Michel Lespinasse (walken@via.ecp.fr),&n; *&t;Yann Doussot (doussot@via.ecp.fr) and Pascal Andre (andre@via.ecp.fr)&n; *&t;(February 18, 1996) :&n; *&t;+ modified shared memory and mmio access port the driver to&n; *&t;  alpha platform (structure access -&gt; readb/writeb)&n; *&n; *&t;Changes by Steve Kipisz (bungy@ibm.net or kipisz@vnet.ibm.com)&n; *&t;(January 18 1996):&n; *&t;+ swapped WWOR and WWCR in ibmtr.h&n; *&t;+ moved some init code from tok_probe into trdev_init.  The&n; *&t;  PCMCIA code can call trdev_init to complete initializing&n; *&t;  the driver.&n; *&t;+ added -DPCMCIA to support PCMCIA&n; *&t;+ detecting PCMCIA Card Removal in interrupt handler.  If&n; *&t;  ISRP is FF, then a PCMCIA card has been removed&n; *&n; *&t;Changes by Paul Norton (pnorton@cts.com) :&n; *&t;+ restructured the READ.LOG logic to prevent the transmit SRB&n; *&t;  from being rudely overwritten before the transmit cycle is&n; *&t;  complete. (August 15 1996)&n; *&t;+ completed multiple adapter support. (November 20 1996)&n; *&t;+ implemented csum_partial_copy in tr_rx and increased receive &n; *        buffer size and count. Minor fixes. (March 15, 1997)&n;*/
macro_line|#ifdef PCMCIA
DECL|macro|MODULE
mdefine_line|#define MODULE
macro_line|#endif
macro_line|#include &lt;linux/module.h&gt;
macro_line|#ifdef PCMCIA
DECL|macro|MODULE
macro_line|#undef MODULE
macro_line|#endif
DECL|macro|NO_AUTODETECT
mdefine_line|#define NO_AUTODETECT 1
DECL|macro|NO_AUTODETECT
macro_line|#undef NO_AUTODETECT
DECL|macro|ENABLE_PAGING
macro_line|#undef ENABLE_PAGING
DECL|macro|FALSE
mdefine_line|#define FALSE 0
DECL|macro|TRUE
mdefine_line|#define TRUE (!FALSE)
multiline_comment|/* changes the output format of driver initialisation */
DECL|macro|TR_NEWFORMAT
mdefine_line|#define TR_NEWFORMAT&t;1
DECL|macro|TR_VERBOSE
mdefine_line|#define TR_VERBOSE&t;0
multiline_comment|/* some 95 OS send many non UI frame; this allow removing the warning */
DECL|macro|TR_FILTERNONUI
mdefine_line|#define TR_FILTERNONUI&t;1
multiline_comment|/* version and credits */
DECL|variable|version
r_static
r_char
op_star
id|version
op_assign
l_string|&quot;ibmtr.c: v1.3.57  8/ 7/94 Peter De Schrijver and Mark Swanson&bslash;n&quot;
l_string|&quot;         v2.1.29  3/15/97 Paul Norton &lt;pnorton@cts.com&gt;&bslash;n&quot;
suffix:semicolon
DECL|variable|pcchannelid
r_static
r_char
id|pcchannelid
(braket
)braket
op_assign
(brace
l_int|0x05
comma
l_int|0x00
comma
l_int|0x04
comma
l_int|0x09
comma
l_int|0x04
comma
l_int|0x03
comma
l_int|0x04
comma
l_int|0x0f
comma
l_int|0x03
comma
l_int|0x06
comma
l_int|0x03
comma
l_int|0x01
comma
l_int|0x03
comma
l_int|0x01
comma
l_int|0x03
comma
l_int|0x00
comma
l_int|0x03
comma
l_int|0x09
comma
l_int|0x03
comma
l_int|0x09
comma
l_int|0x03
comma
l_int|0x00
comma
l_int|0x02
comma
l_int|0x00
)brace
suffix:semicolon
DECL|variable|mcchannelid
r_static
r_char
id|mcchannelid
(braket
)braket
op_assign
(brace
l_int|0x04
comma
l_int|0x0d
comma
l_int|0x04
comma
l_int|0x01
comma
l_int|0x05
comma
l_int|0x02
comma
l_int|0x05
comma
l_int|0x03
comma
l_int|0x03
comma
l_int|0x06
comma
l_int|0x03
comma
l_int|0x03
comma
l_int|0x05
comma
l_int|0x08
comma
l_int|0x03
comma
l_int|0x04
comma
l_int|0x03
comma
l_int|0x05
comma
l_int|0x03
comma
l_int|0x01
comma
l_int|0x03
comma
l_int|0x08
comma
l_int|0x02
comma
l_int|0x00
)brace
suffix:semicolon
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/timer.h&gt;
macro_line|#include &lt;linux/in.h&gt;
macro_line|#include &lt;linux/ioport.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/skbuff.h&gt;
macro_line|#include &lt;linux/interrupt.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;linux/netdevice.h&gt;
macro_line|#include &lt;linux/trdevice.h&gt;
macro_line|#include &lt;linux/stddef.h&gt;
macro_line|#include &lt;net/checksum.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/system.h&gt;
macro_line|#include &lt;asm/bitops.h&gt;
macro_line|#include &quot;ibmtr.h&quot;
DECL|macro|DPRINTK
mdefine_line|#define DPRINTK(format, args...) printk(&quot;%s: &quot; format, dev-&gt;name , ## args)
DECL|macro|DPRINTD
mdefine_line|#define DPRINTD(format, args...) DummyCall(&quot;%s: &quot; format, dev-&gt;name , ## args)
macro_line|#if TR_NEWFORMAT
multiline_comment|/* this allows displaying full adapter information */
DECL|variable|channel_def
r_const
r_char
op_star
id|channel_def
(braket
)braket
op_assign
(brace
l_string|&quot;ISA&quot;
comma
l_string|&quot;MCA&quot;
comma
l_string|&quot;ISA P&amp;P&quot;
)brace
suffix:semicolon
DECL|function|adapter_def
r_char
op_star
id|adapter_def
c_func
(paren
r_char
id|type
)paren
(brace
r_switch
c_cond
(paren
id|type
)paren
(brace
r_case
l_int|0xF
suffix:colon
r_return
l_string|&quot;PC Adapter | PC Adapter II | Adapter/A&quot;
suffix:semicolon
r_case
l_int|0xE
suffix:colon
r_return
l_string|&quot;16/4 Adapter | 16/4 Adapter/A (long)&quot;
suffix:semicolon
r_case
l_int|0xD
suffix:colon
r_return
l_string|&quot;16/4 Adapter/A (short) | 16/4 ISA-16 Adapter&quot;
suffix:semicolon
r_case
l_int|0xC
suffix:colon
r_return
l_string|&quot;Auto 16/4 Adapter&quot;
suffix:semicolon
r_default
suffix:colon
r_return
l_string|&quot;adapter (unknown type)&quot;
suffix:semicolon
)brace
suffix:semicolon
)brace
suffix:semicolon
macro_line|#endif
macro_line|#if !TR_NEWFORMAT
DECL|variable|ibmtr_debug_trace
r_int
r_char
id|ibmtr_debug_trace
op_assign
l_int|1
suffix:semicolon
multiline_comment|/*  Patch or otherwise alter to&n;                                         control tokenring tracing.  */
macro_line|#else
DECL|variable|ibmtr_debug_trace
r_int
r_char
id|ibmtr_debug_trace
op_assign
l_int|0
suffix:semicolon
macro_line|#endif
DECL|macro|TRC_INIT
mdefine_line|#define TRC_INIT 0x01              /*  Trace initialization &amp; PROBEs */
DECL|macro|TRC_INITV
mdefine_line|#define TRC_INITV 0x02             /*  verbose init trace points     */
r_int
id|ibmtr_probe
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_int
id|ibmtr_probe1
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
r_int
id|ioaddr
)paren
suffix:semicolon
r_int
r_char
id|get_sram_size
c_func
(paren
r_struct
id|tok_info
op_star
id|adapt_info
)paren
suffix:semicolon
r_static
r_int
id|tok_init_card
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
suffix:semicolon
r_int
id|trdev_init
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
suffix:semicolon
r_void
id|tok_interrupt
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
suffix:semicolon
r_static
r_void
id|initial_tok_int
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_void
id|open_sap
c_func
(paren
r_int
r_char
id|type
comma
r_struct
id|device
op_star
id|dev
)paren
suffix:semicolon
r_void
id|tok_open_adapter
c_func
(paren
r_int
r_int
id|dev_addr
)paren
suffix:semicolon
r_static
r_void
id|tr_rx
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_void
id|tr_tx
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_int
id|tok_open
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_int
id|tok_close
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_int
id|tok_send_packet
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_struct
id|net_device_stats
op_star
id|tok_get_stats
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
suffix:semicolon
r_void
id|ibmtr_readlog
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
suffix:semicolon
r_void
id|ibmtr_reset_timer
c_func
(paren
r_struct
id|timer_list
op_star
id|tmr
comma
r_struct
id|device
op_star
id|dev
)paren
suffix:semicolon
DECL|variable|ibmtr_portlist
r_static
r_int
r_int
id|ibmtr_portlist
(braket
)braket
op_assign
(brace
l_int|0xa20
comma
l_int|0xa24
comma
l_int|0
)brace
suffix:semicolon
DECL|variable|ibmtr_mem_base
r_static
id|__u32
id|ibmtr_mem_base
op_assign
l_int|0xd0000
suffix:semicolon
DECL|function|PrtChanID
r_static
r_void
id|PrtChanID
c_func
(paren
r_char
op_star
id|pcid
comma
r_int
id|stride
)paren
(brace
r_int
id|i
comma
id|j
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
comma
id|j
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|24
suffix:semicolon
id|i
op_increment
comma
id|j
op_add_assign
id|stride
)paren
id|printk
c_func
(paren
l_string|&quot;%1x&quot;
comma
(paren
(paren
r_int
)paren
id|pcid
(braket
id|j
)braket
)paren
op_amp
l_int|0x0f
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
)brace
DECL|function|HWPrtChanID
r_static
r_void
id|HWPrtChanID
(paren
id|__u32
id|pcid
comma
r_int
id|stride
)paren
(brace
r_int
id|i
comma
id|j
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
comma
id|j
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|24
suffix:semicolon
id|i
op_increment
comma
id|j
op_add_assign
id|stride
)paren
id|printk
c_func
(paren
l_string|&quot;%1x&quot;
comma
(paren
(paren
r_int
)paren
id|readb
c_func
(paren
id|pcid
op_plus
id|j
)paren
)paren
op_amp
l_int|0x0f
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;ibmtr_probe():  Routine specified in the network device structure&n; *&t;to probe for an IBM Token Ring Adapter.  Routine outline:&n; *&t;I.    Interrogate hardware to determine if an adapter exists&n; *&t;      and what the speeds and feeds are&n; *&t;II.   Setup data structures to control execution based upon&n; *&t;      adapter characteristics.&n; *&t;III.  Initialize adapter operation&n; *&n; *&t;We expect ibmtr_probe to be called once for each device entry&n; *&t;which references it.&n; */
DECL|function|ibmtr_probe
r_int
id|ibmtr_probe
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
r_int
id|i
suffix:semicolon
r_int
id|base_addr
op_assign
id|dev
ques
c_cond
id|dev-&gt;base_addr
suffix:colon
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|base_addr
OG
l_int|0x1ff
)paren
(brace
multiline_comment|/*&n;        &t; *&t;Check a single specified location. &n; &t;&t; */
r_if
c_cond
(paren
id|ibmtr_probe1
c_func
(paren
id|dev
comma
id|base_addr
)paren
)paren
(brace
macro_line|#ifndef MODULE
id|tr_freedev
c_func
(paren
id|dev
)paren
suffix:semicolon
macro_line|#endif
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
r_else
r_return
l_int|0
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|base_addr
op_ne
l_int|0
)paren
multiline_comment|/* Don&squot;t probe at all. */
r_return
op_minus
id|ENXIO
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|ibmtr_portlist
(braket
id|i
)braket
suffix:semicolon
id|i
op_increment
)paren
(brace
r_int
id|ioaddr
op_assign
id|ibmtr_portlist
(braket
id|i
)braket
suffix:semicolon
r_if
c_cond
(paren
id|check_region
c_func
(paren
id|ioaddr
comma
id|IBMTR_IO_EXTENT
)paren
)paren
r_continue
suffix:semicolon
r_if
c_cond
(paren
id|ibmtr_probe1
c_func
(paren
id|dev
comma
id|ioaddr
)paren
)paren
(brace
macro_line|#ifndef MODULE
id|tr_freedev
c_func
(paren
id|dev
)paren
suffix:semicolon
macro_line|#endif
)brace
r_else
r_return
l_int|0
suffix:semicolon
)brace
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
DECL|function|ibmtr_probe1
r_static
r_int
id|ibmtr_probe1
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
r_int
id|PIOaddr
)paren
(brace
r_int
r_char
id|segment
op_assign
l_int|0
comma
id|intr
op_assign
l_int|0
comma
id|irq
op_assign
l_int|0
comma
id|i
op_assign
l_int|0
comma
id|j
op_assign
l_int|0
comma
id|cardpresent
op_assign
id|NOTOK
comma
id|temp
op_assign
l_int|0
suffix:semicolon
id|__u32
id|t_mmio
op_assign
l_int|0
suffix:semicolon
r_struct
id|tok_info
op_star
id|ti
op_assign
l_int|0
suffix:semicolon
id|__u32
id|cd_chanid
suffix:semicolon
r_int
r_char
op_star
id|tchanid
comma
id|ctemp
suffix:semicolon
macro_line|#ifndef MODULE
id|dev
op_assign
id|init_trdev
c_func
(paren
id|dev
comma
l_int|0
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/*&t;Query the adapter PIO base port which will return&n;&t; *&t;indication of where MMIO was placed. We also have a&n;&t; *&t;coded interrupt number.&n;&t; */
id|segment
op_assign
id|inb
c_func
(paren
id|PIOaddr
)paren
suffix:semicolon
multiline_comment|/*&n;&t; *&t;Out of range values so we&squot;ll assume non-existent IO device &n;&t; */
r_if
c_cond
(paren
id|segment
template_param
l_int|0xe0
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
multiline_comment|/*&n;&t; *&t;Compute the linear base address of the MMIO area&n;&t; *&t;as LINUX doesn&squot;t care about segments&n;&t; */
id|t_mmio
op_assign
(paren
(paren
(paren
id|__u32
)paren
(paren
id|segment
op_amp
l_int|0xfc
)paren
op_lshift
l_int|11
)paren
op_plus
l_int|0x80000
)paren
suffix:semicolon
id|intr
op_assign
id|segment
op_amp
l_int|0x03
suffix:semicolon
multiline_comment|/* low bits is coded interrupt # */
r_if
c_cond
(paren
id|ibmtr_debug_trace
op_amp
id|TRC_INIT
)paren
id|DPRINTK
c_func
(paren
l_string|&quot;PIOaddr: %4hx seg/intr: %2x mmio base: %08X intr: %d&bslash;n&quot;
comma
id|PIOaddr
comma
(paren
r_int
)paren
id|segment
comma
id|t_mmio
comma
(paren
r_int
)paren
id|intr
)paren
suffix:semicolon
multiline_comment|/*&n;&t; *&t;Now we will compare expected &squot;channelid&squot; strings with&n;&t; *&t;what we is there to learn of ISA/MCA or not TR card&n;&t; */
id|cd_chanid
op_assign
(paren
id|CHANNEL_ID
op_plus
id|t_mmio
)paren
suffix:semicolon
multiline_comment|/* for efficiency */
id|tchanid
op_assign
id|pcchannelid
suffix:semicolon
id|cardpresent
op_assign
id|TR_ISA
suffix:semicolon
multiline_comment|/* try ISA */
multiline_comment|/*&n;&t; *&t;Suboptimize knowing first byte different&n;&t; */
id|ctemp
op_assign
id|readb
c_func
(paren
id|cd_chanid
)paren
op_amp
l_int|0x0f
suffix:semicolon
r_if
c_cond
(paren
id|ctemp
op_ne
op_star
id|tchanid
)paren
(brace
multiline_comment|/* NOT ISA card, try MCA */
id|tchanid
op_assign
id|mcchannelid
suffix:semicolon
id|cardpresent
op_assign
id|TR_MCA
suffix:semicolon
r_if
c_cond
(paren
id|ctemp
op_ne
op_star
id|tchanid
)paren
multiline_comment|/* Neither ISA nor MCA */
id|cardpresent
op_assign
id|NOTOK
suffix:semicolon
)brace
r_if
c_cond
(paren
id|cardpresent
op_ne
id|NOTOK
)paren
(brace
multiline_comment|/* &n;&t;&t; *&t;Know presumed type, try rest of ID &n;&t;&t; */
r_for
c_loop
(paren
id|i
op_assign
l_int|2
comma
id|j
op_assign
l_int|1
suffix:semicolon
id|i
op_le
l_int|46
suffix:semicolon
id|i
op_assign
id|i
op_plus
l_int|2
comma
id|j
op_increment
)paren
(brace
r_if
c_cond
(paren
(paren
id|readb
c_func
(paren
id|cd_chanid
op_plus
id|i
)paren
op_amp
l_int|0x0f
)paren
op_ne
id|tchanid
(braket
id|j
)braket
)paren
(brace
id|cardpresent
op_assign
id|NOTOK
suffix:semicolon
multiline_comment|/* match failed, not TR card */
r_break
suffix:semicolon
)brace
)brace
)brace
multiline_comment|/* &n;&t; *&t;If we have an ISA board check for the ISA P&amp;P version,&n;&t; *&t;as it has different IRQ settings &n;&t; */
r_if
c_cond
(paren
id|cardpresent
op_eq
id|TR_ISA
op_logical_and
(paren
id|readb
c_func
(paren
id|AIPFID
op_plus
id|t_mmio
)paren
op_eq
l_int|0x0e
)paren
)paren
id|cardpresent
op_assign
id|TR_ISAPNP
suffix:semicolon
r_if
c_cond
(paren
id|cardpresent
op_eq
id|NOTOK
)paren
(brace
multiline_comment|/* &quot;channel_id&quot; did not match, report */
r_if
c_cond
(paren
id|ibmtr_debug_trace
op_amp
id|TRC_INIT
)paren
(brace
id|DPRINTK
c_func
(paren
l_string|&quot;Channel ID string not found for PIOaddr: %4hx&bslash;n&quot;
comma
id|PIOaddr
)paren
suffix:semicolon
id|DPRINTK
c_func
(paren
l_string|&quot;Expected for ISA: &quot;
)paren
suffix:semicolon
id|PrtChanID
c_func
(paren
id|pcchannelid
comma
l_int|1
)paren
suffix:semicolon
id|DPRINTK
c_func
(paren
l_string|&quot;           found: &quot;
)paren
suffix:semicolon
id|HWPrtChanID
c_func
(paren
id|cd_chanid
comma
l_int|2
)paren
suffix:semicolon
id|DPRINTK
c_func
(paren
l_string|&quot;Expected for MCA: &quot;
)paren
suffix:semicolon
id|PrtChanID
c_func
(paren
id|mcchannelid
comma
l_int|1
)paren
suffix:semicolon
)brace
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
multiline_comment|/* Now, allocate some of the pl0 buffers for this driver.. */
id|ti
op_assign
(paren
r_struct
id|tok_info
op_star
)paren
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|tok_info
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ti
op_eq
l_int|NULL
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|memset
c_func
(paren
id|ti
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|tok_info
)paren
)paren
suffix:semicolon
id|ti-&gt;mmio
op_assign
id|t_mmio
suffix:semicolon
id|ti-&gt;readlog_pending
op_assign
l_int|0
suffix:semicolon
id|dev-&gt;priv
op_assign
id|ti
suffix:semicolon
multiline_comment|/* this seems like the logical use of the&n;                         field ... let&squot;s try some empirical tests&n;                         using the token-info structure -- that&n;                         should fit with out future hope of multiple&n;                         adapter support as well /dwm   */
r_switch
c_cond
(paren
id|cardpresent
)paren
(brace
r_case
id|TR_ISA
suffix:colon
r_if
c_cond
(paren
id|intr
op_eq
l_int|0
)paren
id|irq
op_assign
l_int|9
suffix:semicolon
multiline_comment|/* irq2 really is irq9 */
r_if
c_cond
(paren
id|intr
op_eq
l_int|1
)paren
id|irq
op_assign
l_int|3
suffix:semicolon
r_if
c_cond
(paren
id|intr
op_eq
l_int|2
)paren
id|irq
op_assign
l_int|6
suffix:semicolon
r_if
c_cond
(paren
id|intr
op_eq
l_int|3
)paren
id|irq
op_assign
l_int|7
suffix:semicolon
id|ti-&gt;global_int_enable
op_assign
id|GLOBAL_INT_ENABLE
op_plus
(paren
(paren
id|irq
op_eq
l_int|9
)paren
ques
c_cond
l_int|2
suffix:colon
id|irq
)paren
suffix:semicolon
id|ti-&gt;adapter_int_enable
op_assign
id|PIOaddr
op_plus
id|ADAPTINTREL
suffix:semicolon
id|ti-&gt;sram
op_assign
l_int|0
suffix:semicolon
macro_line|#if !TR_NEWFORMAT
id|DPRINTK
c_func
(paren
l_string|&quot;ti-&gt;global_int_enable: %04X&bslash;n&quot;
comma
id|ti-&gt;global_int_enable
)paren
suffix:semicolon
macro_line|#endif
r_break
suffix:semicolon
r_case
id|TR_MCA
suffix:colon
r_if
c_cond
(paren
id|intr
op_eq
l_int|0
)paren
id|irq
op_assign
l_int|9
suffix:semicolon
r_if
c_cond
(paren
id|intr
op_eq
l_int|1
)paren
id|irq
op_assign
l_int|3
suffix:semicolon
r_if
c_cond
(paren
id|intr
op_eq
l_int|2
)paren
id|irq
op_assign
l_int|10
suffix:semicolon
r_if
c_cond
(paren
id|intr
op_eq
l_int|3
)paren
id|irq
op_assign
l_int|11
suffix:semicolon
id|ti-&gt;global_int_enable
op_assign
l_int|0
suffix:semicolon
id|ti-&gt;adapter_int_enable
op_assign
l_int|0
suffix:semicolon
id|ti-&gt;sram
op_assign
(paren
(paren
id|__u32
)paren
(paren
id|inb
c_func
(paren
id|PIOaddr
op_plus
id|ADAPTRESETREL
)paren
op_amp
l_int|0xfe
)paren
op_lshift
l_int|12
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|TR_ISAPNP
suffix:colon
r_if
c_cond
(paren
id|intr
op_eq
l_int|0
)paren
id|irq
op_assign
l_int|9
suffix:semicolon
r_if
c_cond
(paren
id|intr
op_eq
l_int|1
)paren
id|irq
op_assign
l_int|3
suffix:semicolon
r_if
c_cond
(paren
id|intr
op_eq
l_int|2
)paren
id|irq
op_assign
l_int|10
suffix:semicolon
r_if
c_cond
(paren
id|intr
op_eq
l_int|3
)paren
id|irq
op_assign
l_int|11
suffix:semicolon
multiline_comment|/*&n;&t;&t;&t; *&t;FIXME: this wait should have a timeout&n;&t;&t;&t; */
r_while
c_loop
(paren
op_logical_neg
id|readb
c_func
(paren
id|ti-&gt;mmio
op_plus
id|ACA_OFFSET
op_plus
id|ACA_RW
op_plus
id|RRR_EVEN
)paren
)paren
(brace
suffix:semicolon
)brace
id|ti-&gt;sram
op_assign
(paren
(paren
id|__u32
)paren
id|readb
c_func
(paren
id|ti-&gt;mmio
op_plus
id|ACA_OFFSET
op_plus
id|ACA_RW
op_plus
id|RRR_EVEN
)paren
op_lshift
l_int|12
)paren
suffix:semicolon
id|ti-&gt;global_int_enable
op_assign
id|PIOaddr
op_plus
id|ADAPTINTREL
suffix:semicolon
id|ti-&gt;adapter_int_enable
op_assign
id|PIOaddr
op_plus
id|ADAPTINTREL
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ibmtr_debug_trace
op_amp
id|TRC_INIT
)paren
(brace
multiline_comment|/* just report int */
id|DPRINTK
c_func
(paren
l_string|&quot;irq=%d&quot;
comma
id|irq
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ibmtr_debug_trace
op_amp
id|TRC_INITV
)paren
(brace
multiline_comment|/* full chat in verbose only */
id|DPRINTK
c_func
(paren
l_string|&quot;, ti-&gt;mmio=%08X&quot;
comma
id|ti-&gt;mmio
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;, segment=%02X&quot;
comma
id|segment
)paren
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;.&bslash;n&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/* Get hw address of token ring card */
macro_line|#if !TR_NEWFORMAT
id|DPRINTK
c_func
(paren
l_string|&quot;hw address: &quot;
)paren
suffix:semicolon
macro_line|#endif
id|j
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|0x18
suffix:semicolon
id|i
op_assign
id|i
op_plus
l_int|2
)paren
(brace
multiline_comment|/* technical reference states to do this */
id|temp
op_assign
id|readb
c_func
(paren
id|ti-&gt;mmio
op_plus
id|AIP
op_plus
id|i
)paren
op_amp
l_int|0x0f
suffix:semicolon
macro_line|#if !TR_NEWFORMAT
id|printk
c_func
(paren
l_string|&quot;%1X&quot;
comma
id|ti-&gt;hw_address
(braket
id|j
)braket
op_assign
id|temp
)paren
suffix:semicolon
macro_line|#else
id|ti-&gt;hw_address
(braket
id|j
)braket
op_assign
id|temp
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|j
op_amp
l_int|1
)paren
(brace
id|dev-&gt;dev_addr
(braket
(paren
id|j
op_div
l_int|2
)paren
)braket
op_assign
id|ti-&gt;hw_address
(braket
id|j
)braket
op_plus
(paren
id|ti-&gt;hw_address
(braket
id|j
op_minus
l_int|1
)braket
op_lshift
l_int|4
)paren
suffix:semicolon
)brace
op_increment
id|j
suffix:semicolon
)brace
macro_line|#ifndef TR_NEWFORMAT
id|printk
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/* get Adapter type:  &squot;F&squot; = Adapter/A, &squot;E&squot; = 16/4 Adapter II,...*/
id|ti-&gt;adapter_type
op_assign
id|readb
c_func
(paren
id|ti-&gt;mmio
op_plus
id|AIPADAPTYPE
)paren
suffix:semicolon
multiline_comment|/* get Data Rate:  F=4Mb, E=16Mb, D=4Mb &amp; 16Mb ?? */
id|ti-&gt;data_rate
op_assign
id|readb
c_func
(paren
id|ti-&gt;mmio
op_plus
id|AIPDATARATE
)paren
suffix:semicolon
multiline_comment|/* Get Early Token Release support?: F=no, E=4Mb, D=16Mb, C=4&amp;16Mb */
id|ti-&gt;token_release
op_assign
id|readb
c_func
(paren
id|ti-&gt;mmio
op_plus
id|AIPEARLYTOKEN
)paren
suffix:semicolon
multiline_comment|/* How much shared RAM is on adapter ? */
id|ti-&gt;avail_shared_ram
op_assign
id|get_sram_size
c_func
(paren
id|ti
)paren
suffix:semicolon
multiline_comment|/* We need to set or do a bunch of work here based on previous results.. */
multiline_comment|/* Support paging?  What sizes?:  F=no, E=16k, D=32k, C=16 &amp; 32k */
id|ti-&gt;shared_ram_paging
op_assign
id|readb
c_func
(paren
id|ti-&gt;mmio
op_plus
id|AIPSHRAMPAGE
)paren
suffix:semicolon
multiline_comment|/* Available DHB  4Mb size:   F=2048, E=4096, D=4464 */
id|ti-&gt;dhb_size4mb
op_assign
id|readb
c_func
(paren
id|ti-&gt;mmio
op_plus
id|AIP4MBDHB
)paren
suffix:semicolon
multiline_comment|/* Available DHB 16Mb size:  F=2048, E=4096, D=8192, C=16384, B=17960 */
id|ti-&gt;dhb_size16mb
op_assign
id|readb
c_func
(paren
id|ti-&gt;mmio
op_plus
id|AIP16MBDHB
)paren
suffix:semicolon
macro_line|#if !TR_NEWFORMAT
id|DPRINTK
c_func
(paren
l_string|&quot;atype=%x, drate=%x, trel=%x, asram=%dK, srp=%x, &quot;
l_string|&quot;dhb(4mb=%x, 16mb=%x)&bslash;n&quot;
comma
id|ti-&gt;adapter_type
comma
id|ti-&gt;data_rate
comma
id|ti-&gt;token_release
comma
id|ti-&gt;avail_shared_ram
op_div
l_int|2
comma
id|ti-&gt;shared_ram_paging
comma
id|ti-&gt;dhb_size4mb
comma
id|ti-&gt;dhb_size16mb
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/*&t;We must figure out how much shared memory space this adapter&n;&t; *&t;will occupy so that if there are two adapters we can fit both&n;&t; *&t;in.  Given a choice, we will limit this adapter to 32K.  The&n;&t; *&t;maximum space will will use for two adapters is 64K so if the&n;&t; *&t;adapter we are working on demands 64K (it also doesn&squot;t support&n;&t; *&t;paging), then only one adapter can be supported.  &n;&t; */
multiline_comment|/*&n;&t; *&t;determine how much of total RAM is mapped into PC space &n;&t; */
id|ti-&gt;mapped_ram_size
op_assign
l_int|1
op_lshift
(paren
(paren
(paren
(paren
id|readb
c_func
(paren
id|ti-&gt;mmio
op_plus
id|ACA_OFFSET
op_plus
id|ACA_RW
op_plus
id|RRR_ODD
)paren
)paren
op_rshift
l_int|2
)paren
op_amp
l_int|0x03
)paren
op_plus
l_int|4
)paren
suffix:semicolon
id|ti-&gt;page_mask
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|ti-&gt;shared_ram_paging
op_eq
l_int|0xf
)paren
(brace
multiline_comment|/* No paging in adapter */
id|ti-&gt;mapped_ram_size
op_assign
id|ti-&gt;avail_shared_ram
suffix:semicolon
)brace
r_else
(brace
macro_line|#ifdef ENABLE_PAGING
r_int
r_char
id|pg_size
suffix:semicolon
macro_line|#endif
macro_line|#if !TR_NEWFORMAT
id|DPRINTK
c_func
(paren
l_string|&quot;shared ram page size: %dK&bslash;n&quot;
comma
id|ti-&gt;mapped_ram_size
op_div
l_int|2
)paren
suffix:semicolon
macro_line|#endif
macro_line|#ifdef ENABLE_PAGING
r_switch
c_cond
(paren
id|ti-&gt;shared_ram_paging
)paren
(brace
r_case
l_int|0xf
suffix:colon
r_break
suffix:semicolon
r_case
l_int|0xe
suffix:colon
id|ti-&gt;page_mask
op_assign
(paren
id|ti-&gt;mapped_ram_size
op_eq
l_int|32
)paren
ques
c_cond
l_int|0xc0
suffix:colon
l_int|0
suffix:semicolon
id|pg_size
op_assign
l_int|32
suffix:semicolon
multiline_comment|/* 16KB page size */
r_break
suffix:semicolon
r_case
l_int|0xd
suffix:colon
id|ti-&gt;page_mask
op_assign
(paren
id|ti-&gt;mapped_ram_size
op_eq
l_int|64
)paren
ques
c_cond
l_int|0x80
suffix:colon
l_int|0
suffix:semicolon
id|pg_size
op_assign
l_int|64
suffix:semicolon
multiline_comment|/* 32KB page size */
r_break
suffix:semicolon
r_case
l_int|0xc
suffix:colon
id|ti-&gt;page_mask
op_assign
(paren
id|ti-&gt;mapped_ram_size
op_eq
l_int|32
)paren
ques
c_cond
l_int|0xc0
suffix:colon
l_int|0
suffix:semicolon
id|ti-&gt;page_mask
op_assign
(paren
id|ti-&gt;mapped_ram_size
op_eq
l_int|64
)paren
ques
c_cond
l_int|0x80
suffix:colon
l_int|0
suffix:semicolon
id|DPRINTK
c_func
(paren
l_string|&quot;Dual size shared RAM page (code=0xC), don&squot;t support it!&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* nb/dwm: I did this because RRR (3,2) bits are documented as&n;&t;&t;&t;   R/O and I can&squot;t find how to select which page size&n;&t;&t;&t;   Also, the above conditional statement sequence is invalid&n;&t;&t;&t;   as page_mask will always be set by the second stmt */
id|kfree_s
c_func
(paren
id|ti
comma
r_sizeof
(paren
r_struct
id|tok_info
)paren
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|DPRINTK
c_func
(paren
l_string|&quot;Unknown shared ram paging info %01X&bslash;n&quot;
comma
id|ti-&gt;shared_ram_paging
)paren
suffix:semicolon
id|kfree_s
c_func
(paren
id|ti
comma
r_sizeof
(paren
r_struct
id|tok_info
)paren
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ti-&gt;page_mask
)paren
(brace
r_if
c_cond
(paren
id|pg_size
OG
id|ti-&gt;mapped_ram_size
)paren
(brace
id|DPRINTK
c_func
(paren
l_string|&quot;Page size (%d) &gt; mapped ram window (%d), can&squot;t page.&bslash;n&quot;
comma
id|pg_size
comma
id|ti-&gt;mapped_ram_size
)paren
suffix:semicolon
id|ti-&gt;page_mask
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* reset paging */
)brace
r_else
(brace
id|ti-&gt;mapped_ram_size
op_assign
id|ti-&gt;avail_shared_ram
suffix:semicolon
id|DPRINTK
c_func
(paren
l_string|&quot;Shared RAM paging enabled. Page size : %uK&bslash;n&quot;
comma
(paren
(paren
id|ti-&gt;page_mask
op_xor
l_int|0xff
)paren
op_plus
l_int|1
)paren
op_rshift
l_int|2
)paren
suffix:semicolon
)brace
macro_line|#endif
)brace
multiline_comment|/* finish figuring the shared RAM address */
r_if
c_cond
(paren
id|cardpresent
op_eq
id|TR_ISA
)paren
(brace
r_static
id|__u32
id|ram_bndry_mask
(braket
)braket
op_assign
initialization_block
suffix:semicolon
id|__u32
id|new_base
comma
id|rrr_32
comma
id|chk_base
comma
id|rbm
suffix:semicolon
id|rrr_32
op_assign
(paren
(paren
id|readb
c_func
(paren
id|ti-&gt;mmio
op_plus
id|ACA_OFFSET
op_plus
id|ACA_RW
op_plus
id|RRR_ODD
)paren
)paren
op_rshift
l_int|2
)paren
op_amp
l_int|0x00000003
suffix:semicolon
id|rbm
op_assign
id|ram_bndry_mask
(braket
id|rrr_32
)braket
suffix:semicolon
id|new_base
op_assign
(paren
id|ibmtr_mem_base
op_plus
(paren
op_complement
id|rbm
)paren
)paren
op_amp
id|rbm
suffix:semicolon
multiline_comment|/* up to boundary */
id|chk_base
op_assign
id|new_base
op_plus
(paren
id|ti-&gt;mapped_ram_size
op_lshift
l_int|9
)paren
suffix:semicolon
r_if
c_cond
(paren
id|chk_base
OG
(paren
id|ibmtr_mem_base
op_plus
id|IBMTR_SHARED_RAM_SIZE
)paren
)paren
(brace
id|DPRINTK
c_func
(paren
l_string|&quot;Shared RAM for this adapter (%05x) exceeds driver&quot;
l_string|&quot; limit (%05x), adapter not started.&bslash;n&quot;
comma
id|chk_base
comma
id|ibmtr_mem_base
op_plus
id|IBMTR_SHARED_RAM_SIZE
)paren
suffix:semicolon
id|kfree_s
c_func
(paren
id|ti
comma
r_sizeof
(paren
r_struct
id|tok_info
)paren
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* seems cool, record what we have figured out */
id|ti-&gt;sram_base
op_assign
id|new_base
op_rshift
l_int|12
suffix:semicolon
id|ibmtr_mem_base
op_assign
id|chk_base
suffix:semicolon
)brace
)brace
macro_line|#if !TR_NEWFORMAT
id|DPRINTK
c_func
(paren
l_string|&quot;Using %dK shared RAM&bslash;n&quot;
comma
id|ti-&gt;mapped_ram_size
op_div
l_int|2
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|request_irq
(paren
id|dev-&gt;irq
op_assign
id|irq
comma
op_amp
id|tok_interrupt
comma
l_int|0
comma
l_string|&quot;ibmtr&quot;
comma
l_int|NULL
)paren
op_ne
l_int|0
)paren
(brace
id|DPRINTK
c_func
(paren
l_string|&quot;Could not grab irq %d.  Halting Token Ring driver.&bslash;n&quot;
comma
id|irq
)paren
suffix:semicolon
id|kfree_s
c_func
(paren
id|ti
comma
r_sizeof
(paren
r_struct
id|tok_info
)paren
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
id|irq2dev_map
(braket
id|irq
)braket
op_assign
id|dev
suffix:semicolon
multiline_comment|/*?? Now, allocate some of the PIO PORTs for this driver.. */
id|request_region
c_func
(paren
id|PIOaddr
comma
id|IBMTR_IO_EXTENT
comma
l_string|&quot;ibmtr&quot;
)paren
suffix:semicolon
multiline_comment|/* record PIOaddr range&n;&t;&t;&t;&t;&t;&t;&t;&t;  as busy */
macro_line|#if !TR_NEWFORMAT
id|DPRINTK
c_func
(paren
l_string|&quot;%s&quot;
comma
id|version
)paren
suffix:semicolon
multiline_comment|/* As we have passed card identification,&n;                                  let the world know we&squot;re here! */
macro_line|#else
r_if
c_cond
(paren
id|version
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%s&quot;
comma
id|version
)paren
suffix:semicolon
id|version
op_assign
l_int|NULL
suffix:semicolon
)brace
id|DPRINTK
c_func
(paren
l_string|&quot;%s %s found&bslash;n&quot;
comma
id|channel_def
(braket
id|cardpresent
op_minus
l_int|1
)braket
comma
id|adapter_def
c_func
(paren
id|ti-&gt;adapter_type
)paren
)paren
suffix:semicolon
id|DPRINTK
c_func
(paren
l_string|&quot;using irq %d, PIOaddr %hx, %dK shared RAM.&bslash;n&quot;
comma
id|irq
comma
id|PIOaddr
comma
id|ti-&gt;mapped_ram_size
op_div
l_int|2
)paren
suffix:semicolon
id|DPRINTK
c_func
(paren
l_string|&quot;Hardware address : %02X:%02X:%02X:%02X:%02X:%02X&bslash;n&quot;
comma
id|dev-&gt;dev_addr
(braket
l_int|0
)braket
comma
id|dev-&gt;dev_addr
(braket
l_int|1
)braket
comma
id|dev-&gt;dev_addr
(braket
l_int|2
)braket
comma
id|dev-&gt;dev_addr
(braket
l_int|3
)braket
comma
id|dev-&gt;dev_addr
(braket
l_int|4
)braket
comma
id|dev-&gt;dev_addr
(braket
l_int|5
)braket
)paren
suffix:semicolon
macro_line|#endif
id|dev-&gt;base_addr
op_assign
id|PIOaddr
suffix:semicolon
multiline_comment|/* set the value for device */
id|trdev_init
c_func
(paren
id|dev
)paren
suffix:semicolon
id|tok_init_card
c_func
(paren
id|dev
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
multiline_comment|/* Return 0 to indicate we have found a Token Ring card. */
)brace
multiline_comment|/* query the adapter for the size of shared RAM  */
DECL|function|get_sram_size
r_int
r_char
id|get_sram_size
c_func
(paren
r_struct
id|tok_info
op_star
id|adapt_info
)paren
(brace
r_int
r_char
id|avail_sram_code
suffix:semicolon
r_static
r_int
r_char
id|size_code
(braket
)braket
op_assign
initialization_block
suffix:semicolon
multiline_comment|/* Adapter gives&n;&t;   &squot;F&squot; -- use RRR bits 3,2&n;&t;   &squot;E&squot; -- 8kb   &squot;D&squot; -- 16kb&n;&t;   &squot;C&squot; -- 32kb  &squot;A&squot; -- 64KB&n;&t;   &squot;B&squot; - 64KB less 512 bytes at top&n;&t;   (WARNING ... must zero top bytes in INIT */
id|avail_sram_code
op_assign
l_int|0xf
op_minus
id|readb
c_func
(paren
id|adapt_info-&gt;mmio
op_plus
id|AIPAVAILSHRAM
)paren
suffix:semicolon
r_if
c_cond
(paren
id|avail_sram_code
)paren
r_return
id|size_code
(braket
id|avail_sram_code
)braket
suffix:semicolon
r_else
multiline_comment|/* for code &squot;F&squot;, must compute size from RRR(3,2) bits */
r_return
l_int|1
op_lshift
(paren
(paren
id|readb
c_func
(paren
id|adapt_info-&gt;mmio
op_plus
id|ACA_OFFSET
op_plus
id|ACA_RW
op_plus
id|RRR_ODD
)paren
op_rshift
l_int|2
)paren
op_plus
l_int|4
)paren
suffix:semicolon
)brace
DECL|function|trdev_init
r_int
id|trdev_init
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
r_struct
id|tok_info
op_star
id|ti
op_assign
(paren
r_struct
id|tok_info
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|ti-&gt;open_status
op_assign
id|CLOSED
suffix:semicolon
id|dev-&gt;init
op_assign
id|tok_init_card
suffix:semicolon
id|dev-&gt;open
op_assign
id|tok_open
suffix:semicolon
id|dev-&gt;stop
op_assign
id|tok_close
suffix:semicolon
id|dev-&gt;hard_start_xmit
op_assign
id|tok_send_packet
suffix:semicolon
id|dev-&gt;get_stats
op_assign
l_int|NULL
suffix:semicolon
id|dev-&gt;get_stats
op_assign
id|tok_get_stats
suffix:semicolon
id|dev-&gt;set_multicast_list
op_assign
l_int|NULL
suffix:semicolon
macro_line|#ifndef MODULE
id|tr_setup
c_func
(paren
id|dev
)paren
suffix:semicolon
macro_line|#endif
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|tok_open
r_static
r_int
id|tok_open
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
r_struct
id|tok_info
op_star
id|ti
op_assign
(paren
r_struct
id|tok_info
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_if
c_cond
(paren
id|ti-&gt;open_status
op_eq
id|CLOSED
)paren
id|tok_init_card
c_func
(paren
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ti-&gt;open_status
op_eq
id|IN_PROGRESS
)paren
id|sleep_on
c_func
(paren
op_amp
id|ti-&gt;wait_for_reset
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ti-&gt;open_status
op_eq
id|SUCCESS
)paren
(brace
id|dev-&gt;tbusy
op_assign
l_int|0
suffix:semicolon
id|dev-&gt;interrupt
op_assign
l_int|0
suffix:semicolon
id|dev-&gt;start
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* NEED to see smem size *AND* reset high 512 bytes if needed */
id|MOD_INC_USE_COUNT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_else
r_return
op_minus
id|EAGAIN
suffix:semicolon
)brace
DECL|function|tok_close
r_static
r_int
id|tok_close
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
r_struct
id|tok_info
op_star
id|ti
op_assign
(paren
r_struct
id|tok_info
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|writeb
c_func
(paren
id|DIR_CLOSE_ADAPTER
comma
id|ti-&gt;srb
op_plus
m_offsetof
(paren
r_struct
id|srb_close_adapter
comma
id|command
)paren
)paren
suffix:semicolon
id|writeb
c_func
(paren
id|CMD_IN_SRB
comma
id|ti-&gt;mmio
op_plus
id|ACA_OFFSET
op_plus
id|ACA_SET
op_plus
id|ISRA_ODD
)paren
suffix:semicolon
id|ti-&gt;open_status
op_assign
id|CLOSED
suffix:semicolon
id|sleep_on
c_func
(paren
op_amp
id|ti-&gt;wait_for_tok_int
)paren
suffix:semicolon
r_if
c_cond
(paren
id|readb
c_func
(paren
id|ti-&gt;srb
op_plus
m_offsetof
(paren
r_struct
id|srb_close_adapter
comma
id|ret_code
)paren
)paren
)paren
id|DPRINTK
c_func
(paren
l_string|&quot;close adapter failed: %02X&bslash;n&quot;
comma
(paren
r_int
)paren
id|readb
c_func
(paren
id|ti-&gt;srb
op_plus
m_offsetof
(paren
r_struct
id|srb_close_adapter
comma
id|ret_code
)paren
)paren
)paren
suffix:semicolon
id|dev-&gt;start
op_assign
l_int|0
suffix:semicolon
id|DPRINTK
c_func
(paren
l_string|&quot;Adapter closed.&bslash;n&quot;
)paren
suffix:semicolon
id|MOD_DEC_USE_COUNT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|tok_interrupt
r_void
id|tok_interrupt
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_int
r_char
id|status
suffix:semicolon
r_struct
id|tok_info
op_star
id|ti
suffix:semicolon
r_struct
id|device
op_star
id|dev
suffix:semicolon
macro_line|#if TR_VERBOSE
id|DPRINTK
c_func
(paren
l_string|&quot;Int from tok_driver, dev : %p&bslash;n&quot;
comma
id|dev
)paren
suffix:semicolon
macro_line|#endif
id|dev
op_assign
(paren
r_struct
id|device
op_star
)paren
(paren
id|irq2dev_map
(braket
id|irq
)braket
)paren
suffix:semicolon
id|ti
op_assign
(paren
r_struct
id|tok_info
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
multiline_comment|/* Disable interrupts till processing is finished */
id|dev-&gt;interrupt
op_assign
l_int|1
suffix:semicolon
id|writeb
c_func
(paren
(paren
op_complement
id|INT_ENABLE
)paren
comma
id|ti-&gt;mmio
op_plus
id|ACA_OFFSET
op_plus
id|ACA_RESET
op_plus
id|ISRP_EVEN
)paren
suffix:semicolon
multiline_comment|/* Reset interrupt for ISA boards */
r_if
c_cond
(paren
id|ti-&gt;adapter_int_enable
)paren
id|outb
c_func
(paren
l_int|0
comma
id|ti-&gt;adapter_int_enable
)paren
suffix:semicolon
r_else
id|outb
c_func
(paren
l_int|0
comma
id|ti-&gt;global_int_enable
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|ti-&gt;do_tok_int
)paren
(brace
r_case
id|NOT_FIRST
suffix:colon
multiline_comment|/*  Begin the regular interrupt handler HERE inline to avoid&n;&t;&t;    the extra levels of logic and call depth for the&n;&t;&t;    original solution.   */
id|status
op_assign
id|readb
c_func
(paren
id|ti-&gt;mmio
op_plus
id|ACA_OFFSET
op_plus
id|ACA_RW
op_plus
id|ISRP_ODD
)paren
suffix:semicolon
macro_line|#ifdef PCMCIA
multiline_comment|/* Check if the PCMCIA card was pulled. */
r_if
c_cond
(paren
id|status
op_eq
l_int|0xFF
)paren
(brace
id|DPRINTK
c_func
(paren
l_string|&quot;PCMCIA card removed.&bslash;n&quot;
)paren
suffix:semicolon
id|dev-&gt;interrupt
op_assign
l_int|0
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/* Check ISRP EVEN too. */
r_if
c_cond
(paren
id|readb
(paren
id|ti-&gt;mmio
op_plus
id|ACA_OFFSET
op_plus
id|ACA_RW
op_plus
id|ISRP_EVEN
)paren
op_eq
l_int|0xFF
)paren
(brace
id|DPRINTK
c_func
(paren
l_string|&quot;PCMCIA card removed.&bslash;n&quot;
)paren
suffix:semicolon
id|dev-&gt;interrupt
op_assign
l_int|0
suffix:semicolon
r_return
suffix:semicolon
)brace
macro_line|#endif
r_if
c_cond
(paren
id|status
op_amp
id|ADAP_CHK_INT
)paren
(brace
r_int
id|i
suffix:semicolon
id|__u32
id|check_reason
suffix:semicolon
id|check_reason
op_assign
id|ti-&gt;mmio
op_plus
id|ntohs
c_func
(paren
id|readw
c_func
(paren
id|ti-&gt;sram
op_plus
id|ACA_OFFSET
op_plus
id|ACA_RW
op_plus
id|WWCR_EVEN
)paren
)paren
suffix:semicolon
id|DPRINTK
c_func
(paren
l_string|&quot;Adapter check interrupt&bslash;n&quot;
)paren
suffix:semicolon
id|DPRINTK
c_func
(paren
l_string|&quot;8 reason bytes follow: &quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|8
suffix:semicolon
id|i
op_increment
comma
id|check_reason
op_increment
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%02X &quot;
comma
(paren
r_int
)paren
id|readb
c_func
(paren
id|check_reason
)paren
)paren
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
id|writeb
c_func
(paren
(paren
op_complement
id|ADAP_CHK_INT
)paren
comma
id|ti-&gt;mmio
op_plus
id|ACA_OFFSET
op_plus
id|ACA_RESET
op_plus
id|ISRP_ODD
)paren
suffix:semicolon
id|writeb
c_func
(paren
id|INT_ENABLE
comma
id|ti-&gt;mmio
op_plus
id|ACA_OFFSET
op_plus
id|ACA_SET
op_plus
id|ISRP_EVEN
)paren
suffix:semicolon
id|dev-&gt;interrupt
op_assign
l_int|0
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|readb
c_func
(paren
id|ti-&gt;mmio
op_plus
id|ACA_OFFSET
op_plus
id|ACA_RW
op_plus
id|ISRP_EVEN
)paren
op_amp
(paren
id|TCR_INT
op_or
id|ERR_INT
op_or
id|ACCESS_INT
)paren
)paren
(brace
id|DPRINTK
c_func
(paren
l_string|&quot;adapter error: ISRP_EVEN : %02x&bslash;n&quot;
comma
(paren
r_int
)paren
id|readb
c_func
(paren
id|ti-&gt;mmio
op_plus
id|ACA_OFFSET
op_plus
id|ACA_RW
op_plus
id|ISRP_EVEN
)paren
)paren
suffix:semicolon
id|writeb
c_func
(paren
op_complement
(paren
id|TCR_INT
op_or
id|ERR_INT
op_or
id|ACCESS_INT
)paren
comma
id|ti-&gt;mmio
op_plus
id|ACA_OFFSET
op_plus
id|ACA_RESET
op_plus
id|ISRP_EVEN
)paren
suffix:semicolon
id|writeb
c_func
(paren
id|INT_ENABLE
comma
id|ti-&gt;mmio
op_plus
id|ACA_OFFSET
op_plus
id|ACA_SET
op_plus
id|ISRP_EVEN
)paren
suffix:semicolon
id|dev-&gt;interrupt
op_assign
l_int|0
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|status
op_amp
(paren
id|SRB_RESP_INT
op_or
id|ASB_FREE_INT
op_or
id|ARB_CMD_INT
op_or
id|SSB_RESP_INT
)paren
)paren
(brace
multiline_comment|/* SRB, ASB, ARB or SSB response */
r_if
c_cond
(paren
id|status
op_amp
id|SRB_RESP_INT
)paren
(brace
multiline_comment|/* SRB response */
r_switch
c_cond
(paren
id|readb
c_func
(paren
id|ti-&gt;srb
)paren
)paren
(brace
multiline_comment|/* SRB command check */
r_case
id|XMIT_DIR_FRAME
suffix:colon
(brace
r_int
r_char
id|xmit_ret_code
suffix:semicolon
id|xmit_ret_code
op_assign
id|readb
c_func
(paren
id|ti-&gt;srb
op_plus
m_offsetof
(paren
r_struct
id|srb_xmit
comma
id|ret_code
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|xmit_ret_code
op_ne
l_int|0xff
)paren
(brace
id|DPRINTK
c_func
(paren
l_string|&quot;error on xmit_dir_frame request: %02X&bslash;n&quot;
comma
id|xmit_ret_code
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ti-&gt;current_skb
)paren
(brace
id|dev_kfree_skb
c_func
(paren
id|ti-&gt;current_skb
comma
id|FREE_WRITE
)paren
suffix:semicolon
id|ti-&gt;current_skb
op_assign
l_int|NULL
suffix:semicolon
)brace
id|dev-&gt;tbusy
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|ti-&gt;readlog_pending
)paren
id|ibmtr_readlog
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
)brace
r_break
suffix:semicolon
r_case
id|XMIT_UI_FRAME
suffix:colon
(brace
r_int
r_char
id|xmit_ret_code
suffix:semicolon
id|xmit_ret_code
op_assign
id|readb
c_func
(paren
id|ti-&gt;srb
op_plus
m_offsetof
(paren
r_struct
id|srb_xmit
comma
id|ret_code
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|xmit_ret_code
op_ne
l_int|0xff
)paren
(brace
id|DPRINTK
c_func
(paren
l_string|&quot;error on xmit_ui_frame request: %02X&bslash;n&quot;
comma
id|xmit_ret_code
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ti-&gt;current_skb
)paren
(brace
id|dev_kfree_skb
c_func
(paren
id|ti-&gt;current_skb
comma
id|FREE_WRITE
)paren
suffix:semicolon
id|ti-&gt;current_skb
op_assign
l_int|NULL
suffix:semicolon
)brace
id|dev-&gt;tbusy
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|ti-&gt;readlog_pending
)paren
id|ibmtr_readlog
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
)brace
r_break
suffix:semicolon
r_case
id|DIR_OPEN_ADAPTER
suffix:colon
(brace
r_int
r_char
id|open_ret_code
suffix:semicolon
id|__u16
id|open_error_code
suffix:semicolon
id|ti-&gt;srb
op_assign
id|ti-&gt;sram
op_plus
id|ntohs
c_func
(paren
id|readw
c_func
(paren
id|ti-&gt;init_srb
op_plus
m_offsetof
(paren
r_struct
id|srb_open_response
comma
id|srb_addr
)paren
)paren
)paren
suffix:semicolon
id|ti-&gt;ssb
op_assign
id|ti-&gt;sram
op_plus
id|ntohs
c_func
(paren
id|readw
c_func
(paren
id|ti-&gt;init_srb
op_plus
m_offsetof
(paren
r_struct
id|srb_open_response
comma
id|ssb_addr
)paren
)paren
)paren
suffix:semicolon
id|ti-&gt;arb
op_assign
id|ti-&gt;sram
op_plus
id|ntohs
c_func
(paren
id|readw
c_func
(paren
id|ti-&gt;init_srb
op_plus
m_offsetof
(paren
r_struct
id|srb_open_response
comma
id|arb_addr
)paren
)paren
)paren
suffix:semicolon
id|ti-&gt;asb
op_assign
id|ti-&gt;sram
op_plus
id|ntohs
c_func
(paren
id|readw
c_func
(paren
id|ti-&gt;init_srb
op_plus
m_offsetof
(paren
r_struct
id|srb_open_response
comma
id|asb_addr
)paren
)paren
)paren
suffix:semicolon
id|ti-&gt;current_skb
op_assign
l_int|NULL
suffix:semicolon
id|open_ret_code
op_assign
id|readb
c_func
(paren
id|ti-&gt;init_srb
op_plus
m_offsetof
(paren
r_struct
id|srb_open_response
comma
id|ret_code
)paren
)paren
suffix:semicolon
id|open_error_code
op_assign
id|ntohs
c_func
(paren
id|readw
c_func
(paren
id|ti-&gt;init_srb
op_plus
m_offsetof
(paren
r_struct
id|srb_open_response
comma
id|error_code
)paren
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|open_ret_code
op_eq
l_int|7
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|ti-&gt;auto_ringspeedsave
op_logical_and
(paren
id|open_error_code
op_eq
l_int|0x24
)paren
)paren
(brace
id|DPRINTK
c_func
(paren
l_string|&quot;Open failed: Adapter speed must match ring &quot;
l_string|&quot;speed if Automatic Ring Speed Save is disabled.&bslash;n&quot;
)paren
suffix:semicolon
id|ti-&gt;open_status
op_assign
id|FAILURE
suffix:semicolon
id|wake_up
c_func
(paren
op_amp
id|ti-&gt;wait_for_reset
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|open_error_code
op_eq
l_int|0x24
)paren
id|DPRINTK
c_func
(paren
l_string|&quot;Retrying open to adjust to ring speed.&bslash;n&quot;
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
(paren
id|open_error_code
op_eq
l_int|0x2d
)paren
op_logical_and
id|ti-&gt;auto_ringspeedsave
)paren
id|DPRINTK
c_func
(paren
l_string|&quot;No signal detected for Auto Speed Detection.&bslash;n&quot;
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
id|open_error_code
op_eq
l_int|0x11
)paren
(brace
id|ti-&gt;open_status
op_assign
id|FAILURE
suffix:semicolon
id|DPRINTK
c_func
(paren
l_string|&quot;Ring broken/disconnected.&bslash;n&quot;
)paren
suffix:semicolon
id|wake_up
c_func
(paren
op_amp
id|ti-&gt;wait_for_reset
)paren
suffix:semicolon
)brace
r_else
id|DPRINTK
c_func
(paren
l_string|&quot;Unrecoverable error: error code = %04x.&bslash;n&quot;
comma
id|open_error_code
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
op_logical_neg
id|open_ret_code
)paren
(brace
macro_line|#if !TR_NEWFORMAT
id|DPRINTK
c_func
(paren
l_string|&quot;board opened...&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#else
id|DPRINTK
c_func
(paren
l_string|&quot;Adapter initialized and opened.&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
id|writeb
c_func
(paren
op_complement
(paren
id|SRB_RESP_INT
)paren
comma
id|ti-&gt;mmio
op_plus
id|ACA_OFFSET
op_plus
id|ACA_RESET
op_plus
id|ISRP_ODD
)paren
suffix:semicolon
id|writeb
c_func
(paren
op_complement
(paren
id|CMD_IN_SRB
)paren
comma
id|ti-&gt;mmio
op_plus
id|ACA_OFFSET
op_plus
id|ACA_RESET
op_plus
id|ISRA_ODD
)paren
suffix:semicolon
id|open_sap
c_func
(paren
id|EXTENDED_SAP
comma
id|dev
)paren
suffix:semicolon
multiline_comment|/* YdW probably hates me */
r_goto
id|skip_reset
suffix:semicolon
)brace
r_else
id|DPRINTK
c_func
(paren
l_string|&quot;open failed: ret_code = %02X, retrying&bslash;n&quot;
comma
id|open_ret_code
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ti-&gt;open_status
op_ne
id|FAILURE
)paren
(brace
id|ibmtr_reset_timer
c_func
(paren
op_amp
(paren
id|ti-&gt;tr_timer
)paren
comma
id|dev
)paren
suffix:semicolon
)brace
)brace
r_break
suffix:semicolon
r_case
id|DIR_CLOSE_ADAPTER
suffix:colon
id|wake_up
c_func
(paren
op_amp
id|ti-&gt;wait_for_tok_int
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|DLC_OPEN_SAP
suffix:colon
r_if
c_cond
(paren
id|readb
c_func
(paren
id|ti-&gt;srb
op_plus
m_offsetof
(paren
r_struct
id|dlc_open_sap
comma
id|ret_code
)paren
)paren
)paren
(brace
id|DPRINTK
c_func
(paren
l_string|&quot;open_sap failed: ret_code = %02X,retrying&bslash;n&quot;
comma
(paren
r_int
)paren
id|readb
c_func
(paren
id|ti-&gt;srb
op_plus
m_offsetof
(paren
r_struct
id|dlc_open_sap
comma
id|ret_code
)paren
)paren
)paren
suffix:semicolon
id|ibmtr_reset_timer
c_func
(paren
op_amp
(paren
id|ti-&gt;tr_timer
)paren
comma
id|dev
)paren
suffix:semicolon
)brace
r_else
(brace
id|ti-&gt;exsap_station_id
op_assign
id|readw
c_func
(paren
id|ti-&gt;srb
op_plus
m_offsetof
(paren
r_struct
id|dlc_open_sap
comma
id|station_id
)paren
)paren
suffix:semicolon
id|ti-&gt;open_status
op_assign
id|SUCCESS
suffix:semicolon
multiline_comment|/* TR adapter is now available */
id|wake_up
c_func
(paren
op_amp
id|ti-&gt;wait_for_reset
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|DIR_INTERRUPT
suffix:colon
r_case
id|DIR_MOD_OPEN_PARAMS
suffix:colon
r_case
id|DIR_SET_GRP_ADDR
suffix:colon
r_case
id|DIR_SET_FUNC_ADDR
suffix:colon
r_case
id|DLC_CLOSE_SAP
suffix:colon
r_if
c_cond
(paren
id|readb
c_func
(paren
id|ti-&gt;srb
op_plus
m_offsetof
(paren
r_struct
id|srb_interrupt
comma
id|ret_code
)paren
)paren
)paren
id|DPRINTK
c_func
(paren
l_string|&quot;error on %02X: %02X&bslash;n&quot;
comma
(paren
r_int
)paren
id|readb
c_func
(paren
id|ti-&gt;srb
op_plus
m_offsetof
(paren
r_struct
id|srb_interrupt
comma
id|command
)paren
)paren
comma
(paren
r_int
)paren
id|readb
c_func
(paren
id|ti-&gt;srb
op_plus
m_offsetof
(paren
r_struct
id|srb_interrupt
comma
id|ret_code
)paren
)paren
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|DIR_READ_LOG
suffix:colon
r_if
c_cond
(paren
id|readb
c_func
(paren
id|ti-&gt;srb
op_plus
m_offsetof
(paren
r_struct
id|srb_read_log
comma
id|ret_code
)paren
)paren
)paren
id|DPRINTK
c_func
(paren
l_string|&quot;error on dir_read_log: %02X&bslash;n&quot;
comma
(paren
r_int
)paren
id|readb
c_func
(paren
id|ti-&gt;srb
op_plus
m_offsetof
(paren
r_struct
id|srb_read_log
comma
id|ret_code
)paren
)paren
)paren
suffix:semicolon
r_else
id|DPRINTK
c_func
(paren
l_string|&quot;Line errors %02X, Internal errors %02X, Burst errors %02X&bslash;n&quot;
l_string|&quot;A/C errors %02X, Abort delimiters %02X, Lost frames %02X&bslash;n&quot;
l_string|&quot;Receive congestion count %02X, Frame copied errors %02X&bslash;n&quot;
l_string|&quot;Frequency errors %02X, Token errors %02X&bslash;n&quot;
comma
(paren
r_int
)paren
id|readb
c_func
(paren
id|ti-&gt;srb
op_plus
m_offsetof
(paren
r_struct
id|srb_read_log
comma
id|line_errors
)paren
)paren
comma
(paren
r_int
)paren
id|readb
c_func
(paren
id|ti-&gt;srb
op_plus
m_offsetof
(paren
r_struct
id|srb_read_log
comma
id|internal_errors
)paren
)paren
comma
(paren
r_int
)paren
id|readb
c_func
(paren
id|ti-&gt;srb
op_plus
m_offsetof
(paren
r_struct
id|srb_read_log
comma
id|burst_errors
)paren
)paren
comma
(paren
r_int
)paren
id|readb
c_func
(paren
id|ti-&gt;srb
op_plus
m_offsetof
(paren
r_struct
id|srb_read_log
comma
id|A_C_errors
)paren
)paren
comma
(paren
r_int
)paren
id|readb
c_func
(paren
id|ti-&gt;srb
op_plus
m_offsetof
(paren
r_struct
id|srb_read_log
comma
id|abort_delimiters
)paren
)paren
comma
(paren
r_int
)paren
id|readb
c_func
(paren
id|ti-&gt;srb
op_plus
m_offsetof
(paren
r_struct
id|srb_read_log
comma
id|lost_frames
)paren
)paren
comma
(paren
r_int
)paren
id|readb
c_func
(paren
id|ti-&gt;srb
op_plus
m_offsetof
(paren
r_struct
id|srb_read_log
comma
id|recv_congest_count
)paren
)paren
comma
(paren
r_int
)paren
id|readb
c_func
(paren
id|ti-&gt;srb
op_plus
m_offsetof
(paren
r_struct
id|srb_read_log
comma
id|frame_copied_errors
)paren
)paren
comma
(paren
r_int
)paren
id|readb
c_func
(paren
id|ti-&gt;srb
op_plus
m_offsetof
(paren
r_struct
id|srb_read_log
comma
id|frequency_errors
)paren
)paren
comma
(paren
r_int
)paren
id|readb
c_func
(paren
id|ti-&gt;srb
op_plus
m_offsetof
(paren
r_struct
id|srb_read_log
comma
id|token_errors
)paren
)paren
)paren
suffix:semicolon
id|dev-&gt;tbusy
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|DPRINTK
c_func
(paren
l_string|&quot;Unknown command %02X encountered&bslash;n&quot;
comma
(paren
r_int
)paren
id|readb
c_func
(paren
id|ti-&gt;srb
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/* SRB command check */
id|writeb
c_func
(paren
op_complement
id|CMD_IN_SRB
comma
id|ti-&gt;mmio
op_plus
id|ACA_OFFSET
op_plus
id|ACA_RESET
op_plus
id|ISRA_ODD
)paren
suffix:semicolon
id|writeb
c_func
(paren
op_complement
id|SRB_RESP_INT
comma
id|ti-&gt;mmio
op_plus
id|ACA_OFFSET
op_plus
id|ACA_RESET
op_plus
id|ISRP_ODD
)paren
suffix:semicolon
id|skip_reset
suffix:colon
)brace
multiline_comment|/* SRB response */
r_if
c_cond
(paren
id|status
op_amp
id|ASB_FREE_INT
)paren
(brace
multiline_comment|/* ASB response */
r_switch
c_cond
(paren
id|readb
c_func
(paren
id|ti-&gt;asb
)paren
)paren
(brace
multiline_comment|/* ASB command check */
r_case
id|REC_DATA
suffix:colon
r_case
id|XMIT_UI_FRAME
suffix:colon
r_case
id|XMIT_DIR_FRAME
suffix:colon
r_break
suffix:semicolon
r_default
suffix:colon
id|DPRINTK
c_func
(paren
l_string|&quot;unknown command in asb %02X&bslash;n&quot;
comma
(paren
r_int
)paren
id|readb
c_func
(paren
id|ti-&gt;asb
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/* ASB command check */
r_if
c_cond
(paren
id|readb
c_func
(paren
id|ti-&gt;asb
op_plus
l_int|2
)paren
op_ne
l_int|0xff
)paren
multiline_comment|/* checks ret_code */
id|DPRINTK
c_func
(paren
l_string|&quot;ASB error %02X in cmd %02X&bslash;n&quot;
comma
(paren
r_int
)paren
id|readb
c_func
(paren
id|ti-&gt;asb
op_plus
l_int|2
)paren
comma
(paren
r_int
)paren
id|readb
c_func
(paren
id|ti-&gt;asb
)paren
)paren
suffix:semicolon
id|writeb
c_func
(paren
op_complement
id|ASB_FREE_INT
comma
id|ti-&gt;mmio
op_plus
id|ACA_OFFSET
op_plus
id|ACA_RESET
op_plus
id|ISRP_ODD
)paren
suffix:semicolon
)brace
multiline_comment|/* ASB response */
r_if
c_cond
(paren
id|status
op_amp
id|ARB_CMD_INT
)paren
(brace
multiline_comment|/* ARB response */
r_switch
c_cond
(paren
id|readb
c_func
(paren
id|ti-&gt;arb
)paren
)paren
(brace
multiline_comment|/* ARB command check */
r_case
id|DLC_STATUS
suffix:colon
id|DPRINTK
c_func
(paren
l_string|&quot;DLC_STATUS new status: %02X on station %02X&bslash;n&quot;
comma
id|ntohs
c_func
(paren
id|readw
c_func
(paren
id|ti-&gt;arb
op_plus
m_offsetof
(paren
r_struct
id|arb_dlc_status
comma
id|status
)paren
)paren
)paren
comma
id|ntohs
c_func
(paren
id|readw
c_func
(paren
id|ti-&gt;arb
op_plus
m_offsetof
(paren
r_struct
id|arb_dlc_status
comma
id|station_id
)paren
)paren
)paren
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|REC_DATA
suffix:colon
id|tr_rx
c_func
(paren
id|dev
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|RING_STAT_CHANGE
suffix:colon
(brace
r_int
r_int
id|ring_status
suffix:semicolon
id|ring_status
op_assign
id|ntohs
c_func
(paren
id|readw
c_func
(paren
id|ti-&gt;arb
op_plus
m_offsetof
(paren
r_struct
id|arb_ring_stat_change
comma
id|ring_status
)paren
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ring_status
op_amp
(paren
id|SIGNAL_LOSS
op_or
id|LOBE_FAULT
)paren
)paren
(brace
id|DPRINTK
c_func
(paren
l_string|&quot;Signal loss/Lobe fault&bslash;n&quot;
)paren
suffix:semicolon
id|DPRINTK
c_func
(paren
l_string|&quot;We try to reopen the adapter.&bslash;n&quot;
)paren
suffix:semicolon
id|ibmtr_reset_timer
c_func
(paren
op_amp
(paren
id|ti-&gt;tr_timer
)paren
comma
id|dev
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|ring_status
op_amp
(paren
id|HARD_ERROR
op_or
id|XMIT_BEACON
op_or
id|AUTO_REMOVAL
op_or
id|REMOVE_RECV
op_or
id|RING_RECOVER
)paren
)paren
id|DPRINTK
c_func
(paren
l_string|&quot;New ring status: %02X&bslash;n&quot;
comma
id|ring_status
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ring_status
op_amp
id|LOG_OVERFLOW
)paren
(brace
r_if
c_cond
(paren
id|dev-&gt;tbusy
)paren
id|ti-&gt;readlog_pending
op_assign
l_int|1
suffix:semicolon
r_else
id|ibmtr_readlog
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
)brace
r_break
suffix:semicolon
r_case
id|XMIT_DATA_REQ
suffix:colon
id|tr_tx
c_func
(paren
id|dev
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|DPRINTK
c_func
(paren
l_string|&quot;Unknown command %02X in arb&bslash;n&quot;
comma
(paren
r_int
)paren
id|readb
c_func
(paren
id|ti-&gt;arb
)paren
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
multiline_comment|/* ARB command check */
id|writeb
c_func
(paren
op_complement
id|ARB_CMD_INT
comma
id|ti-&gt;mmio
op_plus
id|ACA_OFFSET
op_plus
id|ACA_RESET
op_plus
id|ISRP_ODD
)paren
suffix:semicolon
id|writeb
c_func
(paren
id|ARB_FREE
comma
id|ti-&gt;mmio
op_plus
id|ACA_OFFSET
op_plus
id|ACA_SET
op_plus
id|ISRA_ODD
)paren
suffix:semicolon
)brace
multiline_comment|/* ARB response */
r_if
c_cond
(paren
id|status
op_amp
id|SSB_RESP_INT
)paren
(brace
multiline_comment|/* SSB response */
r_switch
c_cond
(paren
id|readb
c_func
(paren
id|ti-&gt;ssb
)paren
)paren
(brace
multiline_comment|/* SSB command check */
r_case
id|XMIT_DIR_FRAME
suffix:colon
r_case
id|XMIT_UI_FRAME
suffix:colon
r_if
c_cond
(paren
id|readb
c_func
(paren
id|ti-&gt;ssb
op_plus
l_int|2
)paren
)paren
multiline_comment|/* checks ret_code */
id|DPRINTK
c_func
(paren
l_string|&quot;xmit ret_code: %02X xmit error code: %02X&bslash;n&quot;
comma
(paren
r_int
)paren
id|readb
c_func
(paren
id|ti-&gt;ssb
op_plus
l_int|2
)paren
comma
(paren
r_int
)paren
id|readb
c_func
(paren
id|ti-&gt;ssb
op_plus
l_int|6
)paren
)paren
suffix:semicolon
r_else
id|ti-&gt;tr_stats.tx_packets
op_increment
suffix:semicolon
r_break
suffix:semicolon
r_case
id|XMIT_XID_CMD
suffix:colon
id|DPRINTK
c_func
(paren
l_string|&quot;xmit xid ret_code: %02X&bslash;n&quot;
comma
(paren
r_int
)paren
id|readb
c_func
(paren
id|ti-&gt;ssb
op_plus
l_int|2
)paren
)paren
suffix:semicolon
r_default
suffix:colon
id|DPRINTK
c_func
(paren
l_string|&quot;Unknown command %02X in ssb&bslash;n&quot;
comma
(paren
r_int
)paren
id|readb
c_func
(paren
id|ti-&gt;ssb
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/* SSB command check */
id|writeb
c_func
(paren
op_complement
id|SSB_RESP_INT
comma
id|ti-&gt;mmio
op_plus
id|ACA_OFFSET
op_plus
id|ACA_RESET
op_plus
id|ISRP_ODD
)paren
suffix:semicolon
id|writeb
c_func
(paren
id|SSB_FREE
comma
id|ti-&gt;mmio
op_plus
id|ACA_OFFSET
op_plus
id|ACA_SET
op_plus
id|ISRA_ODD
)paren
suffix:semicolon
)brace
multiline_comment|/* SSB response */
)brace
multiline_comment|/* SRB, ARB, ASB or SSB response */
id|dev-&gt;interrupt
op_assign
l_int|0
suffix:semicolon
id|writeb
c_func
(paren
id|INT_ENABLE
comma
id|ti-&gt;mmio
op_plus
id|ACA_OFFSET
op_plus
id|ACA_SET
op_plus
id|ISRP_EVEN
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|FIRST_INT
suffix:colon
id|initial_tok_int
c_func
(paren
id|dev
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|DPRINTK
c_func
(paren
l_string|&quot;Unexpected interrupt from tr adapter&bslash;n&quot;
)paren
suffix:semicolon
)brace
)brace
DECL|function|initial_tok_int
r_static
r_void
id|initial_tok_int
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
id|__u32
id|encoded_addr
suffix:semicolon
id|__u32
id|hw_encoded_addr
suffix:semicolon
r_struct
id|tok_info
op_star
id|ti
suffix:semicolon
id|ti
op_assign
(paren
r_struct
id|tok_info
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|ti-&gt;do_tok_int
op_assign
id|NOT_FIRST
suffix:semicolon
macro_line|#ifndef TR_NEWFORMAT
id|DPRINTK
c_func
(paren
l_string|&quot;Initial tok int received&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/* we assign the shared-ram address for ISA devices */
r_if
c_cond
(paren
op_logical_neg
id|ti-&gt;sram
)paren
(brace
id|writeb
c_func
(paren
id|ti-&gt;sram_base
comma
id|ti-&gt;mmio
op_plus
id|ACA_OFFSET
op_plus
id|ACA_RW
op_plus
id|RRR_EVEN
)paren
suffix:semicolon
id|ti-&gt;sram
op_assign
(paren
(paren
id|__u32
)paren
id|ti-&gt;sram_base
op_lshift
l_int|12
)paren
suffix:semicolon
)brace
id|ti-&gt;init_srb
op_assign
id|ti-&gt;sram
op_plus
id|ntohs
c_func
(paren
(paren
r_int
r_int
)paren
id|readw
c_func
(paren
id|ti-&gt;mmio
op_plus
id|ACA_OFFSET
op_plus
id|WRBR_EVEN
)paren
)paren
suffix:semicolon
id|SET_PAGE
c_func
(paren
id|ntohs
c_func
(paren
(paren
r_int
r_int
)paren
id|readw
c_func
(paren
id|ti-&gt;mmio
op_plus
id|ACA_OFFSET
op_plus
id|WRBR_EVEN
)paren
)paren
)paren
suffix:semicolon
id|dev-&gt;mem_start
op_assign
id|ti-&gt;sram
suffix:semicolon
id|dev-&gt;mem_end
op_assign
id|ti-&gt;sram
op_plus
(paren
id|ti-&gt;mapped_ram_size
op_lshift
l_int|9
)paren
op_minus
l_int|1
suffix:semicolon
macro_line|#if TR_VERBOSE
(brace
r_int
id|i
suffix:semicolon
id|DPRINTK
c_func
(paren
l_string|&quot;init_srb(%p):&quot;
comma
id|ti-&gt;init_srb
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|17
suffix:semicolon
id|i
op_increment
)paren
id|printk
c_func
(paren
l_string|&quot;%02X &quot;
comma
(paren
r_int
)paren
id|readb
c_func
(paren
id|ti-&gt;init_srb
op_plus
id|i
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
)brace
macro_line|#endif
id|hw_encoded_addr
op_assign
id|readw
c_func
(paren
id|ti-&gt;init_srb
op_plus
m_offsetof
(paren
r_struct
id|srb_init_response
comma
id|encoded_address
)paren
)paren
suffix:semicolon
macro_line|#if !TR_NEWFORMAT
id|DPRINTK
c_func
(paren
l_string|&quot;srb_init_response-&gt;encoded_address: %04X&bslash;n&quot;
comma
id|hw_encoded_addr
)paren
suffix:semicolon
id|DPRINTK
c_func
(paren
l_string|&quot;ntohs(srb_init_response-&gt;encoded_address): %04X&bslash;n&quot;
comma
id|ntohs
c_func
(paren
id|hw_encoded_addr
)paren
)paren
suffix:semicolon
macro_line|#endif
id|encoded_addr
op_assign
(paren
id|ti-&gt;sram
op_plus
id|ntohs
c_func
(paren
id|hw_encoded_addr
)paren
)paren
suffix:semicolon
macro_line|#if !TR_NEWFORMAT
id|DPRINTK
c_func
(paren
l_string|&quot;encoded addr (%04X,%04X,%08X): &quot;
comma
id|hw_encoded_addr
comma
id|ntohs
c_func
(paren
id|hw_encoded_addr
)paren
comma
id|encoded_addr
)paren
suffix:semicolon
macro_line|#else
id|DPRINTK
c_func
(paren
l_string|&quot;Initial interrupt : %s Mbps, shared RAM base %08x.&bslash;n&quot;
comma
(paren
id|readb
c_func
(paren
id|ti-&gt;init_srb
op_plus
m_offsetof
(paren
r_struct
id|srb_init_response
comma
id|init_status
)paren
)paren
op_amp
l_int|0x01
)paren
ques
c_cond
l_string|&quot;16&quot;
suffix:colon
l_string|&quot;4&quot;
comma
id|ti-&gt;sram
)paren
suffix:semicolon
macro_line|#endif
id|ti-&gt;auto_ringspeedsave
op_assign
id|readb
c_func
(paren
id|ti-&gt;init_srb
op_plus
m_offsetof
(paren
r_struct
id|srb_init_response
comma
id|init_status_2
)paren
)paren
op_amp
l_int|0x4
ques
c_cond
id|TRUE
suffix:colon
id|FALSE
suffix:semicolon
macro_line|#if !TR_NEWFORMAT
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|TR_ALEN
suffix:semicolon
id|i
op_increment
)paren
(brace
id|dev-&gt;dev_addr
(braket
id|i
)braket
op_assign
id|readb
c_func
(paren
id|encoded_addr
op_plus
id|i
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;%02X%s&quot;
comma
id|dev-&gt;dev_addr
(braket
id|i
)braket
comma
(paren
id|i
op_eq
id|TR_ALEN
op_minus
l_int|1
)paren
ques
c_cond
l_string|&quot;&quot;
suffix:colon
l_string|&quot;:&quot;
)paren
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
id|tok_open_adapter
c_func
(paren
(paren
r_int
r_int
)paren
id|dev
)paren
suffix:semicolon
)brace
DECL|function|tok_init_card
r_static
r_int
id|tok_init_card
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
r_struct
id|tok_info
op_star
id|ti
suffix:semicolon
r_int
id|PIOaddr
suffix:semicolon
r_int
id|i
suffix:semicolon
id|PIOaddr
op_assign
id|dev-&gt;base_addr
suffix:semicolon
id|ti
op_assign
(paren
r_struct
id|tok_info
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
multiline_comment|/* Special processing for first interrupt after reset */
id|ti-&gt;do_tok_int
op_assign
id|FIRST_INT
suffix:semicolon
multiline_comment|/* Reset adapter */
id|dev-&gt;tbusy
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* nothing can be done before reset and open completed */
macro_line|#ifdef ENABLE_PAGING
r_if
c_cond
(paren
id|ti-&gt;page_mask
)paren
(brace
id|writeb
c_func
(paren
id|SRPR_ENABLE_PAGING
comma
id|ti-&gt;mmio
op_plus
id|ACA_OFFSET
op_plus
id|ACA_RW
op_plus
id|SRPR_EVEN
)paren
suffix:semicolon
)brace
macro_line|#endif
id|writeb
c_func
(paren
op_complement
id|INT_ENABLE
comma
id|ti-&gt;mmio
op_plus
id|ACA_OFFSET
op_plus
id|ACA_RESET
op_plus
id|ISRP_EVEN
)paren
suffix:semicolon
macro_line|#if !TR_NEWFORMAT
id|DPRINTK
c_func
(paren
l_string|&quot;resetting card&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
id|outb
c_func
(paren
l_int|0
comma
id|PIOaddr
op_plus
id|ADAPTRESET
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
id|jiffies
op_plus
id|TR_RESET_INTERVAL
suffix:semicolon
id|jiffies
op_le
id|i
suffix:semicolon
)paren
suffix:semicolon
multiline_comment|/* wait 50ms */
id|outb
c_func
(paren
l_int|0
comma
id|PIOaddr
op_plus
id|ADAPTRESETREL
)paren
suffix:semicolon
macro_line|#if !TR_NEWFORMAT
id|DPRINTK
c_func
(paren
l_string|&quot;card reset&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
id|ti-&gt;open_status
op_assign
id|IN_PROGRESS
suffix:semicolon
id|writeb
c_func
(paren
id|INT_ENABLE
comma
id|ti-&gt;mmio
op_plus
id|ACA_OFFSET
op_plus
id|ACA_SET
op_plus
id|ISRP_EVEN
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|open_sap
r_static
r_void
id|open_sap
c_func
(paren
r_int
r_char
id|type
comma
r_struct
id|device
op_star
id|dev
)paren
(brace
r_int
id|i
suffix:semicolon
r_struct
id|tok_info
op_star
id|ti
op_assign
(paren
r_struct
id|tok_info
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|SET_PAGE
c_func
(paren
id|ti-&gt;srb
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
r_sizeof
(paren
r_struct
id|dlc_open_sap
)paren
suffix:semicolon
id|i
op_increment
)paren
id|writeb
c_func
(paren
l_int|0
comma
id|ti-&gt;srb
op_plus
id|i
)paren
suffix:semicolon
id|writeb
c_func
(paren
id|DLC_OPEN_SAP
comma
id|ti-&gt;srb
op_plus
m_offsetof
(paren
r_struct
id|dlc_open_sap
comma
id|command
)paren
)paren
suffix:semicolon
id|writew
c_func
(paren
id|htons
c_func
(paren
id|MAX_I_FIELD
)paren
comma
id|ti-&gt;srb
op_plus
m_offsetof
(paren
r_struct
id|dlc_open_sap
comma
id|max_i_field
)paren
)paren
suffix:semicolon
id|writeb
c_func
(paren
id|SAP_OPEN_IND_SAP
op_or
id|SAP_OPEN_PRIORITY
comma
id|ti-&gt;srb
op_plus
m_offsetof
(paren
r_struct
id|dlc_open_sap
comma
id|sap_options
)paren
)paren
suffix:semicolon
id|writeb
c_func
(paren
id|SAP_OPEN_STATION_CNT
comma
id|ti-&gt;srb
op_plus
m_offsetof
(paren
r_struct
id|dlc_open_sap
comma
id|station_count
)paren
)paren
suffix:semicolon
id|writeb
c_func
(paren
id|type
comma
id|ti-&gt;srb
op_plus
m_offsetof
(paren
r_struct
id|dlc_open_sap
comma
id|sap_value
)paren
)paren
suffix:semicolon
id|writeb
c_func
(paren
id|CMD_IN_SRB
comma
id|ti-&gt;mmio
op_plus
id|ACA_OFFSET
op_plus
id|ACA_SET
op_plus
id|ISRA_ODD
)paren
suffix:semicolon
)brace
DECL|function|tok_open_adapter
r_void
id|tok_open_adapter
c_func
(paren
r_int
r_int
id|dev_addr
)paren
(brace
r_struct
id|device
op_star
id|dev
op_assign
(paren
r_struct
id|device
op_star
)paren
id|dev_addr
suffix:semicolon
r_struct
id|tok_info
op_star
id|ti
suffix:semicolon
r_int
id|i
suffix:semicolon
id|ti
op_assign
(paren
r_struct
id|tok_info
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
macro_line|#if !TR_NEWFORMAT
id|DPRINTK
c_func
(paren
l_string|&quot;now opening the board...&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
id|writeb
c_func
(paren
op_complement
id|SRB_RESP_INT
comma
id|ti-&gt;mmio
op_plus
id|ACA_OFFSET
op_plus
id|ACA_RESET
op_plus
id|ISRP_ODD
)paren
suffix:semicolon
id|writeb
c_func
(paren
op_complement
id|CMD_IN_SRB
comma
id|ti-&gt;mmio
op_plus
id|ACA_OFFSET
op_plus
id|ACA_RESET
op_plus
id|ISRA_ODD
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
r_sizeof
(paren
r_struct
id|dir_open_adapter
)paren
suffix:semicolon
id|i
op_increment
)paren
id|writeb
c_func
(paren
l_int|0
comma
id|ti-&gt;init_srb
op_plus
id|i
)paren
suffix:semicolon
id|writeb
c_func
(paren
id|DIR_OPEN_ADAPTER
comma
id|ti-&gt;init_srb
op_plus
m_offsetof
(paren
r_struct
id|dir_open_adapter
comma
id|command
)paren
)paren
suffix:semicolon
id|writew
c_func
(paren
id|htons
c_func
(paren
id|OPEN_PASS_BCON_MAC
)paren
comma
id|ti-&gt;init_srb
op_plus
m_offsetof
(paren
r_struct
id|dir_open_adapter
comma
id|open_options
)paren
)paren
suffix:semicolon
id|writew
c_func
(paren
id|htons
c_func
(paren
id|NUM_RCV_BUF
)paren
comma
id|ti-&gt;init_srb
op_plus
m_offsetof
(paren
r_struct
id|dir_open_adapter
comma
id|num_rcv_buf
)paren
)paren
suffix:semicolon
id|writew
c_func
(paren
id|htons
c_func
(paren
id|RCV_BUF_LEN
)paren
comma
id|ti-&gt;init_srb
op_plus
m_offsetof
(paren
r_struct
id|dir_open_adapter
comma
id|rcv_buf_len
)paren
)paren
suffix:semicolon
id|writew
c_func
(paren
id|htons
c_func
(paren
id|DHB_LENGTH
)paren
comma
id|ti-&gt;init_srb
op_plus
m_offsetof
(paren
r_struct
id|dir_open_adapter
comma
id|dhb_length
)paren
)paren
suffix:semicolon
id|writeb
c_func
(paren
id|NUM_DHB
comma
id|ti-&gt;init_srb
op_plus
m_offsetof
(paren
r_struct
id|dir_open_adapter
comma
id|num_dhb
)paren
)paren
suffix:semicolon
id|writeb
c_func
(paren
id|DLC_MAX_SAP
comma
id|ti-&gt;init_srb
op_plus
m_offsetof
(paren
r_struct
id|dir_open_adapter
comma
id|dlc_max_sap
)paren
)paren
suffix:semicolon
id|writeb
c_func
(paren
id|DLC_MAX_STA
comma
id|ti-&gt;init_srb
op_plus
m_offsetof
(paren
r_struct
id|dir_open_adapter
comma
id|dlc_max_sta
)paren
)paren
suffix:semicolon
id|ti-&gt;srb
op_assign
id|ti-&gt;init_srb
suffix:semicolon
multiline_comment|/* We use this one in the interrupt handler */
id|writeb
c_func
(paren
id|INT_ENABLE
comma
id|ti-&gt;mmio
op_plus
id|ACA_OFFSET
op_plus
id|ACA_SET
op_plus
id|ISRP_EVEN
)paren
suffix:semicolon
id|writeb
c_func
(paren
id|CMD_IN_SRB
comma
id|ti-&gt;mmio
op_plus
id|ACA_OFFSET
op_plus
id|ACA_SET
op_plus
id|ISRA_ODD
)paren
suffix:semicolon
)brace
DECL|function|tr_tx
r_static
r_void
id|tr_tx
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
r_struct
id|tok_info
op_star
id|ti
op_assign
(paren
r_struct
id|tok_info
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_struct
id|trh_hdr
op_star
id|trhdr
op_assign
(paren
r_struct
id|trh_hdr
op_star
)paren
id|ti-&gt;current_skb-&gt;data
suffix:semicolon
r_int
r_int
id|hdr_len
suffix:semicolon
id|__u32
id|dhb
suffix:semicolon
r_int
r_char
id|xmit_command
suffix:semicolon
r_int
id|i
suffix:semicolon
r_struct
id|trllc
op_star
id|llc
suffix:semicolon
r_if
c_cond
(paren
id|readb
c_func
(paren
id|ti-&gt;asb
op_plus
m_offsetof
(paren
r_struct
id|asb_xmit_resp
comma
id|ret_code
)paren
)paren
op_ne
l_int|0xFF
)paren
id|DPRINTK
c_func
(paren
l_string|&quot;ASB not free !!!&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* in providing the transmit interrupts,&n;&t;   is telling us it is ready for data and&n;&t;   providing a shared memory address for us&n;&t;   to stuff with data.  Here we compute the&n;&t;   effective address where we will place data.*/
id|dhb
op_assign
id|ti-&gt;sram
op_plus
id|ntohs
c_func
(paren
id|readw
c_func
(paren
id|ti-&gt;arb
op_plus
m_offsetof
(paren
r_struct
id|arb_xmit_req
comma
id|dhb_address
)paren
)paren
)paren
suffix:semicolon
id|llc
op_assign
(paren
r_struct
id|trllc
op_star
)paren
op_amp
(paren
id|ti-&gt;current_skb-&gt;data
(braket
r_sizeof
(paren
r_struct
id|trh_hdr
)paren
)braket
)paren
suffix:semicolon
id|xmit_command
op_assign
id|readb
c_func
(paren
id|ti-&gt;srb
op_plus
m_offsetof
(paren
r_struct
id|srb_xmit
comma
id|command
)paren
)paren
suffix:semicolon
id|writeb
c_func
(paren
id|xmit_command
comma
id|ti-&gt;asb
op_plus
m_offsetof
(paren
r_struct
id|asb_xmit_resp
comma
id|command
)paren
)paren
suffix:semicolon
id|writew
c_func
(paren
id|readb
c_func
(paren
id|ti-&gt;srb
op_plus
m_offsetof
(paren
r_struct
id|srb_xmit
comma
id|station_id
)paren
)paren
comma
id|ti-&gt;asb
op_plus
m_offsetof
(paren
r_struct
id|asb_xmit_resp
comma
id|station_id
)paren
)paren
suffix:semicolon
id|writeb
c_func
(paren
id|llc-&gt;ssap
comma
id|ti-&gt;asb
op_plus
m_offsetof
(paren
r_struct
id|asb_xmit_resp
comma
id|rsap_value
)paren
)paren
suffix:semicolon
id|writeb
c_func
(paren
id|readb
c_func
(paren
id|ti-&gt;srb
op_plus
m_offsetof
(paren
r_struct
id|srb_xmit
comma
id|cmd_corr
)paren
)paren
comma
id|ti-&gt;asb
op_plus
m_offsetof
(paren
r_struct
id|asb_xmit_resp
comma
id|cmd_corr
)paren
)paren
suffix:semicolon
id|writeb
c_func
(paren
l_int|0
comma
id|ti-&gt;asb
op_plus
m_offsetof
(paren
r_struct
id|asb_xmit_resp
comma
id|ret_code
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|xmit_command
op_eq
id|XMIT_XID_CMD
)paren
op_logical_or
(paren
id|xmit_command
op_eq
id|XMIT_TEST_CMD
)paren
)paren
(brace
id|writew
c_func
(paren
id|htons
c_func
(paren
l_int|0x11
)paren
comma
id|ti-&gt;asb
op_plus
m_offsetof
(paren
r_struct
id|asb_xmit_resp
comma
id|frame_length
)paren
)paren
suffix:semicolon
id|writeb
c_func
(paren
l_int|0x0e
comma
id|ti-&gt;asb
op_plus
m_offsetof
(paren
r_struct
id|asb_xmit_resp
comma
id|hdr_length
)paren
)paren
suffix:semicolon
id|writeb
c_func
(paren
id|AC
comma
id|dhb
)paren
suffix:semicolon
id|writeb
c_func
(paren
id|LLC_FRAME
comma
id|dhb
op_plus
l_int|1
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|TR_ALEN
suffix:semicolon
id|i
op_increment
)paren
id|writeb
c_func
(paren
(paren
r_int
)paren
l_int|0x0FF
comma
id|dhb
op_plus
id|i
op_plus
l_int|2
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|TR_ALEN
suffix:semicolon
id|i
op_increment
)paren
id|writeb
c_func
(paren
l_int|0
comma
id|dhb
op_plus
id|i
op_plus
id|TR_ALEN
op_plus
l_int|2
)paren
suffix:semicolon
id|writeb
c_func
(paren
id|RESP_IN_ASB
comma
id|ti-&gt;mmio
op_plus
id|ACA_OFFSET
op_plus
id|ACA_SET
op_plus
id|ISRA_ODD
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/* the token ring packet is copied from sk_buff to the adapter&n;&t;   buffer identified in the command data received with the&n;&t;   interrupt.  The sk_buff area was set up with a maximum&n;&t;   sized route information field so here we must compress&n;&t;   out the extra (all) rif fields.   */
multiline_comment|/* nb/dwm .... I re-arranged code here to avoid copy of extra&n;&t;   bytes, ended up with fewer statements as well. */
multiline_comment|/* TR arch. identifies if RIF present by high bit of source&n;&t;   address.  So here we check if RIF present */
r_if
c_cond
(paren
op_logical_neg
(paren
id|trhdr-&gt;saddr
(braket
l_int|0
)braket
op_amp
l_int|0x80
)paren
)paren
(brace
multiline_comment|/* RIF present : preserve it */
id|hdr_len
op_assign
r_sizeof
(paren
r_struct
id|trh_hdr
)paren
op_minus
l_int|18
suffix:semicolon
macro_line|#if TR_VERBOSE
id|DPRINTK
c_func
(paren
l_string|&quot;hdr_length: %d, frame length: %ld&bslash;n&quot;
comma
id|hdr_len
comma
id|ti-&gt;current_skb-&gt;len
op_minus
l_int|18
)paren
suffix:semicolon
macro_line|#endif
)brace
r_else
id|hdr_len
op_assign
(paren
(paren
id|ntohs
c_func
(paren
id|trhdr-&gt;rcf
)paren
op_amp
id|TR_RCF_LEN_MASK
)paren
op_rshift
l_int|8
)paren
op_plus
r_sizeof
(paren
r_struct
id|trh_hdr
)paren
op_minus
l_int|18
suffix:semicolon
multiline_comment|/* header length including rif is computed above, now move the data&n;&t;   and set fields appropriately. */
id|memcpy_toio
c_func
(paren
id|dhb
comma
id|ti-&gt;current_skb-&gt;data
comma
id|hdr_len
)paren
suffix:semicolon
id|writeb
c_func
(paren
id|hdr_len
comma
id|ti-&gt;asb
op_plus
m_offsetof
(paren
r_struct
id|asb_xmit_resp
comma
id|hdr_length
)paren
)paren
suffix:semicolon
id|writew
c_func
(paren
id|htons
c_func
(paren
id|ti-&gt;current_skb-&gt;len
op_minus
r_sizeof
(paren
r_struct
id|trh_hdr
)paren
op_plus
id|hdr_len
)paren
comma
id|ti-&gt;asb
op_plus
m_offsetof
(paren
r_struct
id|asb_xmit_resp
comma
id|frame_length
)paren
)paren
suffix:semicolon
multiline_comment|/*  now copy the actual packet data next to hdr */
id|memcpy_toio
c_func
(paren
id|dhb
op_plus
id|hdr_len
comma
id|ti-&gt;current_skb-&gt;data
op_plus
r_sizeof
(paren
r_struct
id|trh_hdr
)paren
comma
id|ti-&gt;current_skb-&gt;len
op_minus
r_sizeof
(paren
r_struct
id|trh_hdr
)paren
)paren
suffix:semicolon
id|writeb
c_func
(paren
id|RESP_IN_ASB
comma
id|ti-&gt;mmio
op_plus
id|ACA_OFFSET
op_plus
id|ACA_SET
op_plus
id|ISRA_ODD
)paren
suffix:semicolon
id|dev-&gt;tbusy
op_assign
l_int|0
suffix:semicolon
id|dev_kfree_skb
c_func
(paren
id|ti-&gt;current_skb
comma
id|FREE_WRITE
)paren
suffix:semicolon
id|ti-&gt;current_skb
op_assign
l_int|NULL
suffix:semicolon
id|mark_bh
c_func
(paren
id|NET_BH
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ti-&gt;readlog_pending
)paren
id|ibmtr_readlog
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
DECL|function|tr_rx
r_static
r_void
id|tr_rx
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
r_struct
id|tok_info
op_star
id|ti
op_assign
(paren
r_struct
id|tok_info
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|__u32
id|rbuffer
comma
id|rbufdata
suffix:semicolon
id|__u32
id|llc
suffix:semicolon
r_int
r_char
op_star
id|data
suffix:semicolon
r_int
r_int
id|rbuffer_len
comma
id|lan_hdr_len
comma
id|hdr_len
suffix:semicolon
r_int
r_int
id|arb_frame_len
suffix:semicolon
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
r_int
r_int
id|skb_size
op_assign
l_int|0
suffix:semicolon
r_int
id|is8022
op_assign
l_int|0
suffix:semicolon
r_int
r_int
id|chksum
op_assign
l_int|0
suffix:semicolon
id|rbuffer
op_assign
(paren
id|ti-&gt;sram
op_plus
id|ntohs
c_func
(paren
id|readw
c_func
(paren
id|ti-&gt;arb
op_plus
m_offsetof
(paren
r_struct
id|arb_rec_req
comma
id|rec_buf_addr
)paren
)paren
)paren
)paren
op_plus
l_int|2
suffix:semicolon
r_if
c_cond
(paren
id|readb
c_func
(paren
id|ti-&gt;asb
op_plus
m_offsetof
(paren
r_struct
id|asb_rec
comma
id|ret_code
)paren
)paren
op_ne
l_int|0xFF
)paren
(brace
id|DPRINTK
c_func
(paren
l_string|&quot;ASB not free !!!&bslash;n&quot;
)paren
suffix:semicolon
)brace
id|writeb
c_func
(paren
id|REC_DATA
comma
id|ti-&gt;asb
op_plus
m_offsetof
(paren
r_struct
id|asb_rec
comma
id|command
)paren
)paren
suffix:semicolon
id|writew
c_func
(paren
id|readw
c_func
(paren
id|ti-&gt;arb
op_plus
m_offsetof
(paren
r_struct
id|arb_rec_req
comma
id|station_id
)paren
)paren
comma
id|ti-&gt;asb
op_plus
m_offsetof
(paren
r_struct
id|asb_rec
comma
id|station_id
)paren
)paren
suffix:semicolon
id|writew
c_func
(paren
id|readw
c_func
(paren
id|ti-&gt;arb
op_plus
m_offsetof
(paren
r_struct
id|arb_rec_req
comma
id|rec_buf_addr
)paren
)paren
comma
id|ti-&gt;asb
op_plus
m_offsetof
(paren
r_struct
id|asb_rec
comma
id|rec_buf_addr
)paren
)paren
suffix:semicolon
id|lan_hdr_len
op_assign
id|readb
c_func
(paren
id|ti-&gt;arb
op_plus
m_offsetof
(paren
r_struct
id|arb_rec_req
comma
id|lan_hdr_len
)paren
)paren
suffix:semicolon
id|llc
op_assign
(paren
id|rbuffer
op_plus
m_offsetof
(paren
r_struct
id|rec_buf
comma
id|data
)paren
op_plus
id|lan_hdr_len
)paren
suffix:semicolon
macro_line|#if TR_VERBOSE
id|DPRINTK
c_func
(paren
l_string|&quot;offsetof data: %02X lan_hdr_len: %02X&bslash;n&quot;
comma
(paren
r_int
r_int
)paren
m_offsetof
(paren
r_struct
id|rec_buf
comma
id|data
)paren
comma
(paren
r_int
r_int
)paren
id|lan_hdr_len
)paren
suffix:semicolon
id|DPRINTK
c_func
(paren
l_string|&quot;llc: %08X rec_buf_addr: %04X ti-&gt;sram: %p&bslash;n&quot;
comma
id|llc
comma
id|ntohs
c_func
(paren
id|readw
c_func
(paren
id|ti-&gt;arb
op_plus
m_offsetof
(paren
r_struct
id|arb_rec_req
comma
id|rec_buf_addr
)paren
)paren
)paren
comma
id|ti-&gt;sram
)paren
suffix:semicolon
id|DPRINTK
c_func
(paren
l_string|&quot;dsap: %02X, ssap: %02X, llc: %02X, protid: %02X%02X%02X, &quot;
l_string|&quot;ethertype: %04X&bslash;n&quot;
comma
(paren
r_int
)paren
id|readb
c_func
(paren
id|llc
op_plus
m_offsetof
(paren
r_struct
id|trllc
comma
id|dsap
)paren
)paren
comma
(paren
r_int
)paren
id|readb
c_func
(paren
id|llc
op_plus
m_offsetof
(paren
r_struct
id|trllc
comma
id|ssap
)paren
)paren
comma
(paren
r_int
)paren
id|readb
c_func
(paren
id|llc
op_plus
m_offsetof
(paren
r_struct
id|trllc
comma
id|llc
)paren
)paren
comma
(paren
r_int
)paren
id|readb
c_func
(paren
id|llc
op_plus
m_offsetof
(paren
r_struct
id|trllc
comma
id|protid
)paren
)paren
comma
(paren
r_int
)paren
id|readb
c_func
(paren
id|llc
op_plus
m_offsetof
(paren
r_struct
id|trllc
comma
id|protid
)paren
op_plus
l_int|1
)paren
comma
(paren
r_int
)paren
id|readb
c_func
(paren
id|llc
op_plus
m_offsetof
(paren
r_struct
id|trllc
comma
id|protid
)paren
op_plus
l_int|2
)paren
comma
(paren
r_int
)paren
id|readw
c_func
(paren
id|llc
op_plus
m_offsetof
(paren
r_struct
id|trllc
comma
id|ethertype
)paren
)paren
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|readb
c_func
(paren
id|llc
op_plus
m_offsetof
(paren
r_struct
id|trllc
comma
id|llc
)paren
)paren
op_ne
id|UI_CMD
)paren
(brace
id|writeb
c_func
(paren
id|DATA_LOST
comma
id|ti-&gt;asb
op_plus
m_offsetof
(paren
r_struct
id|asb_rec
comma
id|ret_code
)paren
)paren
suffix:semicolon
id|ti-&gt;tr_stats.rx_dropped
op_increment
suffix:semicolon
id|writeb
c_func
(paren
id|RESP_IN_ASB
comma
id|ti-&gt;mmio
op_plus
id|ACA_OFFSET
op_plus
id|ACA_SET
op_plus
id|ISRA_ODD
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|readb
c_func
(paren
id|llc
op_plus
m_offsetof
(paren
r_struct
id|trllc
comma
id|dsap
)paren
)paren
op_ne
l_int|0xAA
)paren
op_logical_or
(paren
id|readb
c_func
(paren
id|llc
op_plus
m_offsetof
(paren
r_struct
id|trllc
comma
id|ssap
)paren
)paren
op_ne
l_int|0xAA
)paren
)paren
(brace
id|is8022
op_assign
l_int|1
suffix:semicolon
)brace
macro_line|#if TR_VERBOSE
r_if
c_cond
(paren
id|is8022
)paren
(brace
id|__u32
id|trhhdr
suffix:semicolon
id|trhhdr
op_assign
(paren
id|rbuffer
op_plus
m_offsetof
(paren
r_struct
id|rec_buf
comma
id|data
)paren
)paren
suffix:semicolon
id|DPRINTK
c_func
(paren
l_string|&quot;Probably non-IP frame received.&bslash;n&quot;
)paren
suffix:semicolon
id|DPRINTK
c_func
(paren
l_string|&quot;ssap: %02X dsap: %02X saddr: %02X:%02X:%02X:%02X:%02X:%02X &quot;
l_string|&quot;daddr: %02X:%02X:%02X:%02X:%02X:%02X&bslash;n&quot;
comma
(paren
r_int
)paren
id|readb
c_func
(paren
id|llc
op_plus
m_offsetof
(paren
r_struct
id|trllc
comma
id|ssap
)paren
)paren
comma
(paren
r_int
)paren
id|readb
c_func
(paren
id|llc
op_plus
m_offsetof
(paren
r_struct
id|trllc
comma
id|dsap
)paren
)paren
comma
(paren
r_int
)paren
id|readb
c_func
(paren
id|trhhdr
op_plus
m_offsetof
(paren
r_struct
id|trh_hdr
comma
id|saddr
)paren
)paren
comma
(paren
r_int
)paren
id|readb
c_func
(paren
id|trhhdr
op_plus
m_offsetof
(paren
r_struct
id|trh_hdr
comma
id|saddr
)paren
op_plus
l_int|1
)paren
comma
(paren
r_int
)paren
id|readb
c_func
(paren
id|trhhdr
op_plus
m_offsetof
(paren
r_struct
id|trh_hdr
comma
id|saddr
)paren
op_plus
l_int|2
)paren
comma
(paren
r_int
)paren
id|readb
c_func
(paren
id|trhhdr
op_plus
m_offsetof
(paren
r_struct
id|trh_hdr
comma
id|saddr
)paren
op_plus
l_int|3
)paren
comma
(paren
r_int
)paren
id|readb
c_func
(paren
id|trhhdr
op_plus
m_offsetof
(paren
r_struct
id|trh_hdr
comma
id|saddr
)paren
op_plus
l_int|4
)paren
comma
(paren
r_int
)paren
id|readb
c_func
(paren
id|trhhdr
op_plus
m_offsetof
(paren
r_struct
id|trh_hdr
comma
id|saddr
)paren
op_plus
l_int|5
)paren
comma
(paren
r_int
)paren
id|readb
c_func
(paren
id|trhhdr
op_plus
m_offsetof
(paren
r_struct
id|trh_hdr
comma
id|daddr
)paren
)paren
comma
(paren
r_int
)paren
id|readb
c_func
(paren
id|trhhdr
op_plus
m_offsetof
(paren
r_struct
id|trh_hdr
comma
id|daddr
)paren
op_plus
l_int|1
)paren
comma
(paren
r_int
)paren
id|readb
c_func
(paren
id|trhhdr
op_plus
m_offsetof
(paren
r_struct
id|trh_hdr
comma
id|daddr
)paren
op_plus
l_int|2
)paren
comma
(paren
r_int
)paren
id|readb
c_func
(paren
id|trhhdr
op_plus
m_offsetof
(paren
r_struct
id|trh_hdr
comma
id|daddr
)paren
op_plus
l_int|3
)paren
comma
(paren
r_int
)paren
id|readb
c_func
(paren
id|trhhdr
op_plus
m_offsetof
(paren
r_struct
id|trh_hdr
comma
id|daddr
)paren
op_plus
l_int|4
)paren
comma
(paren
r_int
)paren
id|readb
c_func
(paren
id|trhhdr
op_plus
m_offsetof
(paren
r_struct
id|trh_hdr
comma
id|daddr
)paren
op_plus
l_int|5
)paren
)paren
suffix:semicolon
)brace
macro_line|#endif
id|arb_frame_len
op_assign
id|ntohs
c_func
(paren
id|readw
c_func
(paren
id|ti-&gt;arb
op_plus
m_offsetof
(paren
r_struct
id|arb_rec_req
comma
id|frame_len
)paren
)paren
)paren
suffix:semicolon
id|skb_size
op_assign
id|arb_frame_len
op_minus
id|lan_hdr_len
op_plus
r_sizeof
(paren
r_struct
id|trh_hdr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|is8022
)paren
(brace
id|skb_size
op_add_assign
r_sizeof
(paren
r_struct
id|trllc
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|skb
op_assign
id|dev_alloc_skb
c_func
(paren
id|skb_size
)paren
)paren
)paren
(brace
id|DPRINTK
c_func
(paren
l_string|&quot;out of memory. frame dropped.&bslash;n&quot;
)paren
suffix:semicolon
id|ti-&gt;tr_stats.rx_dropped
op_increment
suffix:semicolon
id|writeb
c_func
(paren
id|DATA_LOST
comma
id|ti-&gt;asb
op_plus
m_offsetof
(paren
r_struct
id|asb_rec
comma
id|ret_code
)paren
)paren
suffix:semicolon
id|writeb
c_func
(paren
id|RESP_IN_ASB
comma
id|ti-&gt;mmio
op_plus
id|ACA_OFFSET
op_plus
id|ACA_SET
op_plus
id|ISRA_ODD
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|skb_put
c_func
(paren
id|skb
comma
id|skb_size
)paren
suffix:semicolon
id|skb-&gt;dev
op_assign
id|dev
suffix:semicolon
id|data
op_assign
id|skb-&gt;data
suffix:semicolon
multiline_comment|/* Copy the 802.5 MAC header */
id|memcpy_fromio
c_func
(paren
id|data
comma
id|rbuffer
op_plus
m_offsetof
(paren
r_struct
id|rec_buf
comma
id|data
)paren
comma
id|lan_hdr_len
)paren
suffix:semicolon
r_if
c_cond
(paren
id|lan_hdr_len
OL
r_sizeof
(paren
r_struct
id|trh_hdr
)paren
)paren
id|memset
c_func
(paren
id|data
op_plus
id|lan_hdr_len
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|trh_hdr
)paren
op_minus
id|lan_hdr_len
)paren
suffix:semicolon
id|data
op_add_assign
r_sizeof
(paren
r_struct
id|trh_hdr
)paren
suffix:semicolon
id|rbuffer_len
op_assign
id|ntohs
c_func
(paren
id|readw
c_func
(paren
id|rbuffer
op_plus
m_offsetof
(paren
r_struct
id|rec_buf
comma
id|buf_len
)paren
)paren
)paren
op_minus
id|lan_hdr_len
suffix:semicolon
r_if
c_cond
(paren
id|is8022
)paren
(brace
multiline_comment|/* create whitewashed LLC header in skb buffer (why not the real one?) */
r_struct
id|trllc
op_star
id|local_llc
op_assign
(paren
r_struct
id|trllc
op_star
)paren
id|data
suffix:semicolon
id|memset
c_func
(paren
id|local_llc
comma
l_int|0
comma
r_sizeof
(paren
op_star
id|local_llc
)paren
)paren
suffix:semicolon
id|local_llc-&gt;ethertype
op_assign
id|htons
c_func
(paren
id|ETH_P_TR_802_2
)paren
suffix:semicolon
id|hdr_len
op_assign
r_sizeof
(paren
r_struct
id|trllc
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* Copy the LLC header and the IPv4 header */
id|hdr_len
op_assign
r_sizeof
(paren
r_struct
id|trllc
)paren
op_plus
r_sizeof
(paren
r_struct
id|iphdr
)paren
suffix:semicolon
id|memcpy_fromio
c_func
(paren
id|data
comma
id|rbuffer
op_plus
m_offsetof
(paren
r_struct
id|rec_buf
comma
id|data
)paren
op_plus
id|lan_hdr_len
comma
id|hdr_len
)paren
suffix:semicolon
)brace
id|data
op_add_assign
id|hdr_len
suffix:semicolon
id|lan_hdr_len
op_add_assign
id|hdr_len
suffix:semicolon
id|rbuffer_len
op_sub_assign
id|hdr_len
suffix:semicolon
id|rbufdata
op_assign
id|rbuffer
op_plus
m_offsetof
(paren
r_struct
id|rec_buf
comma
id|data
)paren
op_plus
id|lan_hdr_len
suffix:semicolon
multiline_comment|/* Copy the payload... */
r_for
c_loop
(paren
suffix:semicolon
suffix:semicolon
)paren
(brace
r_if
c_cond
(paren
id|is8022
)paren
id|memcpy_fromio
c_func
(paren
id|data
comma
id|rbufdata
comma
id|rbuffer_len
)paren
suffix:semicolon
r_else
id|chksum
op_assign
id|csum_partial_copy
c_func
(paren
id|bus_to_virt
c_func
(paren
id|rbufdata
)paren
comma
id|data
comma
id|rbuffer_len
comma
id|chksum
)paren
suffix:semicolon
id|rbuffer
op_assign
id|ntohs
c_func
(paren
id|readw
c_func
(paren
id|rbuffer
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|rbuffer
)paren
r_break
suffix:semicolon
id|data
op_add_assign
id|rbuffer_len
suffix:semicolon
id|rbuffer
op_add_assign
id|ti-&gt;sram
suffix:semicolon
id|rbuffer_len
op_assign
id|ntohs
c_func
(paren
id|readw
c_func
(paren
id|rbuffer
op_plus
m_offsetof
(paren
r_struct
id|rec_buf
comma
id|buf_len
)paren
)paren
)paren
suffix:semicolon
id|rbufdata
op_assign
id|rbuffer
op_plus
m_offsetof
(paren
r_struct
id|rec_buf
comma
id|data
)paren
suffix:semicolon
)brace
id|writeb
c_func
(paren
l_int|0
comma
id|ti-&gt;asb
op_plus
m_offsetof
(paren
r_struct
id|asb_rec
comma
id|ret_code
)paren
)paren
suffix:semicolon
id|writeb
c_func
(paren
id|RESP_IN_ASB
comma
id|ti-&gt;mmio
op_plus
id|ACA_OFFSET
op_plus
id|ACA_SET
op_plus
id|ISRA_ODD
)paren
suffix:semicolon
id|ti-&gt;tr_stats.rx_packets
op_increment
suffix:semicolon
id|skb-&gt;protocol
op_assign
id|tr_type_trans
c_func
(paren
id|skb
comma
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|is8022
)paren
(brace
id|skb-&gt;csum
op_assign
id|chksum
suffix:semicolon
id|skb-&gt;ip_summed
op_assign
l_int|1
suffix:semicolon
)brace
id|netif_rx
c_func
(paren
id|skb
)paren
suffix:semicolon
)brace
DECL|function|tok_send_packet
r_static
r_int
id|tok_send_packet
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|device
op_star
id|dev
)paren
(brace
r_struct
id|tok_info
op_star
id|ti
suffix:semicolon
id|ti
op_assign
(paren
r_struct
id|tok_info
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;tbusy
)paren
(brace
r_int
id|ticks_waited
suffix:semicolon
id|ticks_waited
op_assign
id|jiffies
op_minus
id|dev-&gt;trans_start
suffix:semicolon
r_if
c_cond
(paren
id|ticks_waited
OL
id|TR_BUSY_INTERVAL
)paren
r_return
l_int|1
suffix:semicolon
id|DPRINTK
c_func
(paren
l_string|&quot;Arrg. Transmitter busy.&bslash;n&quot;
)paren
suffix:semicolon
id|dev-&gt;trans_start
op_add_assign
l_int|5
suffix:semicolon
multiline_comment|/* we fake the transmission start time... */
r_return
l_int|1
suffix:semicolon
)brace
multiline_comment|/* Donald does this, so we do too. */
r_if
c_cond
(paren
id|skb
op_eq
l_int|NULL
)paren
(brace
id|dev_tint
c_func
(paren
id|dev
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|set_bit
c_func
(paren
l_int|0
comma
(paren
r_void
op_star
)paren
op_amp
id|dev-&gt;tbusy
)paren
op_ne
l_int|0
)paren
id|DPRINTK
c_func
(paren
l_string|&quot;Transmitter access conflict&bslash;n&quot;
)paren
suffix:semicolon
r_else
(brace
multiline_comment|/* Save skb; we&squot;ll need it when the adapter asks for the data */
id|ti-&gt;current_skb
op_assign
id|skb
suffix:semicolon
id|writeb
c_func
(paren
id|XMIT_UI_FRAME
comma
id|ti-&gt;srb
op_plus
m_offsetof
(paren
r_struct
id|srb_xmit
comma
id|command
)paren
)paren
suffix:semicolon
id|writew
c_func
(paren
id|ti-&gt;exsap_station_id
comma
id|ti-&gt;srb
op_plus
m_offsetof
(paren
r_struct
id|srb_xmit
comma
id|station_id
)paren
)paren
suffix:semicolon
id|writeb
c_func
(paren
id|CMD_IN_SRB
comma
(paren
id|ti-&gt;mmio
op_plus
id|ACA_OFFSET
op_plus
id|ACA_SET
op_plus
id|ISRA_ODD
)paren
)paren
suffix:semicolon
id|dev-&gt;trans_start
op_assign
id|jiffies
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|ibmtr_reset_timer
r_void
id|ibmtr_reset_timer
c_func
(paren
r_struct
id|timer_list
op_star
id|tmr
comma
r_struct
id|device
op_star
id|dev
)paren
(brace
id|tmr-&gt;expires
op_assign
id|jiffies
op_plus
id|TR_RETRY_INTERVAL
suffix:semicolon
id|tmr-&gt;data
op_assign
(paren
r_int
r_int
)paren
id|dev
suffix:semicolon
id|tmr-&gt;function
op_assign
id|tok_open_adapter
suffix:semicolon
id|init_timer
c_func
(paren
id|tmr
)paren
suffix:semicolon
id|add_timer
c_func
(paren
id|tmr
)paren
suffix:semicolon
)brace
DECL|function|ibmtr_readlog
r_void
id|ibmtr_readlog
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
r_struct
id|tok_info
op_star
id|ti
suffix:semicolon
id|ti
op_assign
(paren
r_struct
id|tok_info
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|ti-&gt;readlog_pending
op_assign
l_int|0
suffix:semicolon
id|writeb
c_func
(paren
id|DIR_READ_LOG
comma
id|ti-&gt;srb
)paren
suffix:semicolon
id|writeb
c_func
(paren
id|INT_ENABLE
comma
id|ti-&gt;mmio
op_plus
id|ACA_OFFSET
op_plus
id|ACA_SET
op_plus
id|ISRP_EVEN
)paren
suffix:semicolon
id|writeb
c_func
(paren
id|CMD_IN_SRB
comma
id|ti-&gt;mmio
op_plus
id|ACA_OFFSET
op_plus
id|ACA_SET
op_plus
id|ISRA_ODD
)paren
suffix:semicolon
id|dev-&gt;tbusy
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* really srb busy... */
)brace
multiline_comment|/* tok_get_stats():  Basically a scaffold routine which will return&n;   the address of the tr_statistics structure associated with&n;   this device -- the tr.... structure is an ethnet look-alike&n;   so at least for this iteration may suffice.   */
DECL|function|tok_get_stats
r_static
r_struct
id|net_device_stats
op_star
id|tok_get_stats
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
r_struct
id|tok_info
op_star
id|toki
suffix:semicolon
id|toki
op_assign
(paren
r_struct
id|tok_info
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_return
(paren
r_struct
id|net_device_stats
op_star
)paren
op_amp
id|toki-&gt;tr_stats
suffix:semicolon
)brace
macro_line|#ifdef MODULE
multiline_comment|/* 3COM 3C619C supports 8 interrupts, 32 I/O ports */
DECL|variable|dev_ibmtr
r_static
r_struct
id|device
op_star
id|dev_ibmtr
(braket
id|IBMTR_MAX_ADAPTERS
)braket
suffix:semicolon
DECL|variable|io
r_static
r_int
id|io
(braket
id|IBMTR_MAX_ADAPTERS
)braket
op_assign
(brace
l_int|0xa20
comma
l_int|0xa24
)brace
suffix:semicolon
DECL|variable|irq
r_static
r_int
id|irq
(braket
id|IBMTR_MAX_ADAPTERS
)braket
op_assign
(brace
l_int|0
comma
l_int|0
)brace
suffix:semicolon
DECL|variable|mem
r_static
r_int
id|mem
(braket
id|IBMTR_MAX_ADAPTERS
)braket
op_assign
(brace
l_int|0
comma
l_int|0
)brace
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|io
comma
l_string|&quot;1-&quot;
id|__MODULE_STRING
c_func
(paren
id|IBMTR_MAX_ADAPTERS
)paren
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|irq
comma
l_string|&quot;1-&quot;
id|__MODULE_STRING
c_func
(paren
id|IBMTR_MAX_ADAPTERS
)paren
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|mem
comma
l_string|&quot;1-&quot;
id|__MODULE_STRING
c_func
(paren
id|IBMTR_MAX_ADAPTERS
)paren
l_string|&quot;i&quot;
)paren
suffix:semicolon
DECL|function|init_module
r_int
id|init_module
c_func
(paren
r_void
)paren
(brace
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|io
(braket
id|i
)braket
op_logical_and
(paren
id|i
OL
id|IBMTR_MAX_ADAPTERS
)paren
suffix:semicolon
id|i
op_increment
)paren
(brace
id|irq
(braket
id|i
)braket
op_assign
l_int|0
suffix:semicolon
id|mem
(braket
id|i
)braket
op_assign
l_int|0
suffix:semicolon
id|dev_ibmtr
(braket
id|i
)braket
op_assign
l_int|NULL
suffix:semicolon
id|dev_ibmtr
(braket
id|i
)braket
op_assign
id|init_trdev
c_func
(paren
id|dev_ibmtr
(braket
id|i
)braket
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dev_ibmtr
(braket
id|i
)braket
op_eq
l_int|NULL
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|dev_ibmtr
(braket
id|i
)braket
op_member_access_from_pointer
id|base_addr
op_assign
id|io
(braket
id|i
)braket
suffix:semicolon
id|dev_ibmtr
(braket
id|i
)braket
op_member_access_from_pointer
id|irq
op_assign
id|irq
(braket
id|i
)braket
suffix:semicolon
id|dev_ibmtr
(braket
id|i
)braket
op_member_access_from_pointer
id|mem_start
op_assign
id|mem
(braket
id|i
)braket
suffix:semicolon
id|dev_ibmtr
(braket
id|i
)braket
op_member_access_from_pointer
id|init
op_assign
op_amp
id|ibmtr_probe
suffix:semicolon
r_if
c_cond
(paren
id|register_trdev
c_func
(paren
id|dev_ibmtr
(braket
id|i
)braket
)paren
op_ne
l_int|0
)paren
(brace
id|kfree_s
c_func
(paren
id|dev_ibmtr
(braket
id|i
)braket
comma
r_sizeof
(paren
r_struct
id|dev
)paren
)paren
suffix:semicolon
id|dev_ibmtr
(braket
id|i
)braket
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
id|i
op_eq
l_int|0
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;ibmtr: register_trdev() returned non-zero.&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
r_else
(brace
r_return
l_int|0
suffix:semicolon
)brace
)brace
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|cleanup_module
r_void
id|cleanup_module
c_func
(paren
r_void
)paren
(brace
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|IBMTR_MAX_ADAPTERS
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
id|dev_ibmtr
(braket
id|i
)braket
)paren
(brace
id|unregister_trdev
c_func
(paren
id|dev_ibmtr
(braket
id|i
)braket
)paren
suffix:semicolon
id|free_irq
c_func
(paren
id|dev_ibmtr
(braket
id|i
)braket
op_member_access_from_pointer
id|irq
comma
l_int|NULL
)paren
suffix:semicolon
id|irq2dev_map
(braket
id|dev_ibmtr
(braket
id|i
)braket
op_member_access_from_pointer
id|irq
)braket
op_assign
l_int|NULL
suffix:semicolon
id|release_region
c_func
(paren
id|dev_ibmtr
(braket
id|i
)braket
op_member_access_from_pointer
id|base_addr
comma
id|IBMTR_IO_EXTENT
)paren
suffix:semicolon
id|kfree_s
c_func
(paren
id|dev_ibmtr
(braket
id|i
)braket
op_member_access_from_pointer
id|priv
comma
r_sizeof
(paren
r_struct
id|tok_info
)paren
)paren
suffix:semicolon
id|kfree_s
c_func
(paren
id|dev_ibmtr
(braket
id|i
)braket
comma
r_sizeof
(paren
r_struct
id|dev
)paren
)paren
suffix:semicolon
id|dev_ibmtr
(braket
id|i
)braket
op_assign
l_int|NULL
suffix:semicolon
)brace
)brace
macro_line|#endif /* MODULE */
eof
