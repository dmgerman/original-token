multiline_comment|/* EtherLinkXL.c: A 3Com EtherLink PCI III/XL ethernet driver for linux. */
multiline_comment|/*&n;&t;Written 1996-1998 by Donald Becker.&n;&n;&t;This software may be used and distributed according to the terms&n;&t;of the GNU Public License, incorporated herein by reference.&n;&n;&t;This driver is for the 3Com &quot;Vortex&quot; and &quot;Boomerang&quot; series ethercards.&n;&t;Members of the series include Fast EtherLink 3c590/3c592/3c595/3c597&n;&t;and the EtherLink XL 3c900 and 3c905 cards.&n;&n;&t;The author may be reached as becker@CESDIS.gsfc.nasa.gov, or C/O&n;&t;Center of Excellence in Space Data and Information Sciences&n;&t;   Code 930.5, Goddard Space Flight Center, Greenbelt MD 20771&n;*/
DECL|variable|version
r_static
r_char
op_star
id|version
op_assign
l_string|&quot;3c59x.c:v0.99H 11/17/98 Donald Becker http://cesdis.gsfc.nasa.gov/linux/drivers/vortex.html&bslash;n&quot;
suffix:semicolon
multiline_comment|/* &quot;Knobs&quot; that adjust features and parameters. */
multiline_comment|/* Set the copy breakpoint for the copy-only-tiny-frames scheme.&n;   Setting to &gt; 1512 effectively disables this feature. */
DECL|variable|rx_copybreak
r_static
r_const
r_int
id|rx_copybreak
op_assign
l_int|200
suffix:semicolon
multiline_comment|/* Allow setting MTU to a larger size, bypassing the normal ethernet setup. */
DECL|variable|mtu
r_static
r_const
r_int
id|mtu
op_assign
l_int|1500
suffix:semicolon
multiline_comment|/* Maximum events (Rx packets, etc.) to handle at each interrupt. */
DECL|variable|max_interrupt_work
r_static
r_int
id|max_interrupt_work
op_assign
l_int|20
suffix:semicolon
multiline_comment|/* Put out somewhat more debugging messages. (0: no msg, 1 minimal .. 6). */
DECL|macro|vortex_debug
mdefine_line|#define vortex_debug debug
macro_line|#ifdef VORTEX_DEBUG
DECL|variable|vortex_debug
r_static
r_int
id|vortex_debug
op_assign
id|VORTEX_DEBUG
suffix:semicolon
macro_line|#else
DECL|variable|vortex_debug
r_static
r_int
id|vortex_debug
op_assign
l_int|1
suffix:semicolon
macro_line|#endif
multiline_comment|/* Some values here only for performance evaluation and path-coverage&n;   debugging. */
DECL|variable|rx_nocopy
DECL|variable|rx_copy
DECL|variable|queued_packet
DECL|variable|rx_csumhits
r_static
r_int
id|rx_nocopy
op_assign
l_int|0
comma
id|rx_copy
op_assign
l_int|0
comma
id|queued_packet
op_assign
l_int|0
comma
id|rx_csumhits
suffix:semicolon
multiline_comment|/* A few values that may be tweaked. */
multiline_comment|/* Time in jiffies before concluding the transmitter is hung. */
DECL|macro|TX_TIMEOUT
mdefine_line|#define TX_TIMEOUT  ((400*HZ)/1000)
multiline_comment|/* Keep the ring sizes a power of two for efficiency. */
DECL|macro|TX_RING_SIZE
mdefine_line|#define TX_RING_SIZE&t;16
DECL|macro|RX_RING_SIZE
mdefine_line|#define RX_RING_SIZE&t;32
DECL|macro|PKT_BUF_SZ
mdefine_line|#define PKT_BUF_SZ&t;&t;1536&t;&t;&t;/* Size of each temporary Rx buffer.*/
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/version.h&gt;
macro_line|#ifdef MODULE
macro_line|#ifdef MODVERSIONS
macro_line|#include &lt;linux/modversions.h&gt;
macro_line|#endif
macro_line|#include &lt;linux/module.h&gt;
macro_line|#else
DECL|macro|MOD_INC_USE_COUNT
mdefine_line|#define MOD_INC_USE_COUNT
DECL|macro|MOD_DEC_USE_COUNT
mdefine_line|#define MOD_DEC_USE_COUNT
macro_line|#endif
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/timer.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/in.h&gt;
macro_line|#include &lt;linux/ioport.h&gt;
macro_line|#include &lt;linux/malloc.h&gt;
macro_line|#include &lt;linux/interrupt.h&gt;
macro_line|#include &lt;linux/pci.h&gt;
macro_line|#include &lt;linux/netdevice.h&gt;
macro_line|#include &lt;linux/etherdevice.h&gt;
macro_line|#include &lt;linux/skbuff.h&gt;
macro_line|#if LINUX_VERSION_CODE &lt; 0x20155  ||  defined(CARDBUS)
macro_line|#include &lt;linux/bios32.h&gt;
macro_line|#endif
macro_line|#include &lt;asm/irq.h&gt;&t;&t;&t;/* For NR_IRQS only. */
macro_line|#include &lt;asm/bitops.h&gt;
macro_line|#include &lt;asm/io.h&gt;
multiline_comment|/* Kernel compatibility defines, some common to David Hinds&squot; PCMCIA package.&n;   This is only in the support-all-kernels source code. */
DECL|macro|RUN_AT
mdefine_line|#define RUN_AT(x) (jiffies + (x))
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#if (LINUX_VERSION_CODE &gt;= 0x20100)
DECL|variable|kernel_version
r_char
id|kernel_version
(braket
)braket
op_assign
id|UTS_RELEASE
suffix:semicolon
macro_line|#else
macro_line|#ifndef __alpha__
DECL|macro|ioremap
mdefine_line|#define ioremap(a,b) &bslash;&n;&t;(((a)&lt;0x100000) ? (void *)((u_long)(a)) : vremap(a,b))
DECL|macro|iounmap
mdefine_line|#define iounmap(v) &bslash;&n;&t;do { if ((u_long)(v) &gt; 0x100000) vfree(v); } while (0)
macro_line|#endif
macro_line|#endif
macro_line|#if LINUX_VERSION_CODE &lt;= 0x20139
DECL|macro|net_device_stats
mdefine_line|#define&t;net_device_stats enet_statistics
DECL|macro|NETSTATS_VER2
mdefine_line|#define NETSTATS_VER2
macro_line|#endif
macro_line|#if LINUX_VERSION_CODE &lt; 0x20138
DECL|macro|test_and_set_bit
mdefine_line|#define test_and_set_bit(val, addr) set_bit(val, addr)
DECL|macro|le32_to_cpu
mdefine_line|#define le32_to_cpu(val) (val)
DECL|macro|cpu_to_le32
mdefine_line|#define cpu_to_le32(val) (val)
macro_line|#endif
macro_line|#if LINUX_VERSION_CODE &lt; 0x20155
DECL|macro|PCI_SUPPORT_VER1
mdefine_line|#define PCI_SUPPORT_VER1
macro_line|#else
DECL|macro|PCI_SUPPORT_VER2
mdefine_line|#define PCI_SUPPORT_VER2
macro_line|#endif
macro_line|#if LINUX_VERSION_CODE &lt; 0x20159
DECL|macro|DEV_FREE_SKB
mdefine_line|#define DEV_FREE_SKB(skb) dev_kfree_skb (skb, FREE_WRITE);
macro_line|#else  /* Grrr, unneeded incompatible change. */
DECL|macro|DEV_FREE_SKB
mdefine_line|#define DEV_FREE_SKB(skb) dev_kfree_skb(skb);
macro_line|#endif
macro_line|#if defined(MODULE) &amp;&amp; LINUX_VERSION_CODE &gt; 0x20115
id|MODULE_AUTHOR
c_func
(paren
l_string|&quot;Donald Becker &lt;becker@cesdis.gsfc.nasa.gov&gt;&quot;
)paren
suffix:semicolon
id|MODULE_DESCRIPTION
c_func
(paren
l_string|&quot;3Com 3c590/3c900 series Vortex/Boomerang driver&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|debug
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|options
comma
l_string|&quot;1-&quot;
id|__MODULE_STRING
c_func
(paren
l_int|8
)paren
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|full_duplex
comma
l_string|&quot;1-&quot;
id|__MODULE_STRING
c_func
(paren
l_int|8
)paren
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|rx_copybreak
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|max_interrupt_work
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|compaq_ioaddr
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|compaq_irq
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|compaq_device_id
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/* Operational parameter that usually are not changed. */
multiline_comment|/* The Vortex size is twice that of the original EtherLinkIII series: the&n;   runtime register window, window 1, is now always mapped in.&n;   The Boomerang size is twice as large as the Vortex -- it has additional&n;   bus master control registers. */
DECL|macro|VORTEX_TOTAL_SIZE
mdefine_line|#define VORTEX_TOTAL_SIZE 0x20
DECL|macro|BOOMERANG_TOTAL_SIZE
mdefine_line|#define BOOMERANG_TOTAL_SIZE 0x40
multiline_comment|/* Set iff a MII transceiver on any interface requires mdio preamble.&n;   This only set with the original DP83840 on older 3c905 boards, so the extra&n;   code size of a per-interface flag is not worthwhile. */
DECL|variable|mii_preamble_required
r_static
r_char
id|mii_preamble_required
op_assign
l_int|0
suffix:semicolon
multiline_comment|/*&n;&t;&t;&t;&t;Theory of Operation&n;&n;I. Board Compatibility&n;&n;This device driver is designed for the 3Com FastEtherLink and FastEtherLink&n;XL, 3Com&squot;s PCI to 10/100baseT adapters.  It also works with the 10Mbs&n;versions of the FastEtherLink cards.  The supported product IDs are&n;  3c590, 3c592, 3c595, 3c597, 3c900, 3c905&n;&n;The related ISA 3c515 is supported with a separate driver, 3c515.c, included&n;with the kernel source or available from&n;    cesdis.gsfc.nasa.gov:/pub/linux/drivers/3c515.html&n;&n;II. Board-specific settings&n;&n;PCI bus devices are configured by the system at boot time, so no jumpers&n;need to be set on the board.  The system BIOS should be set to assign the&n;PCI INTA signal to an otherwise unused system IRQ line.&n;&n;The EEPROM settings for media type and forced-full-duplex are observed.&n;The EEPROM media type should be left at the default &quot;autoselect&quot; unless using&n;10base2 or AUI connections which cannot be reliably detected.&n;&n;III. Driver operation&n;&n;The 3c59x series use an interface that&squot;s very similar to the previous 3c5x9&n;series.  The primary interface is two programmed-I/O FIFOs, with an&n;alternate single-contiguous-region bus-master transfer (see next).&n;&n;The 3c900 &quot;Boomerang&quot; series uses a full-bus-master interface with separate&n;lists of transmit and receive descriptors, similar to the AMD LANCE/PCnet,&n;DEC Tulip and Intel Speedo3.  The first chip version retains a compatible&n;programmed-I/O interface that has been removed in &squot;B&squot; and subsequent board&n;revisions.&n;&n;One extension that is advertised in a very large font is that the adapters&n;are capable of being bus masters.  On the Vortex chip this capability was&n;only for a single contiguous region making it far less useful than the full&n;bus master capability.  There is a significant performance impact of taking&n;an extra interrupt or polling for the completion of each transfer, as well&n;as difficulty sharing the single transfer engine between the transmit and&n;receive threads.  Using DMA transfers is a win only with large blocks or&n;with the flawed versions of the Intel Orion motherboard PCI controller.&n;&n;The Boomerang chip&squot;s full-bus-master interface is useful, and has the&n;currently-unused advantages over other similar chips that queued transmit&n;packets may be reordered and receive buffer groups are associated with a&n;single frame.&n;&n;With full-bus-master support, this driver uses a &quot;RX_COPYBREAK&quot; scheme.&n;Rather than a fixed intermediate receive buffer, this scheme allocates&n;full-sized skbuffs as receive buffers.  The value RX_COPYBREAK is used as&n;the copying breakpoint: it is chosen to trade-off the memory wasted by&n;passing the full-sized skbuff to the queue layer for all frames vs. the&n;copying cost of copying a frame to a correctly-sized skbuff.&n;&n;&n;IIIC. Synchronization&n;The driver runs as two independent, single-threaded flows of control.  One&n;is the send-packet routine, which enforces single-threaded use by the&n;dev-&gt;tbusy flag.  The other thread is the interrupt handler, which is single&n;threaded by the hardware and other software.&n;&n;IV. Notes&n;&n;Thanks to Cameron Spitzer and Terry Murphy of 3Com for providing development&n;3c590, 3c595, and 3c900 boards.&n;The name &quot;Vortex&quot; is the internal 3Com project name for the PCI ASIC, and&n;the EISA version is called &quot;Demon&quot;.  According to Terry these names come&n;from rides at the local amusement park.&n;&n;The new chips support both ethernet (1.5K) and FDDI (4.5K) packet sizes!&n;This driver only supports ethernet packets because of the skbuff allocation&n;limit of 4K.&n;*/
multiline_comment|/* This table drives the PCI probe routines.  It&squot;s mostly boilerplate in all&n;   of the drivers, and will likely be provided by some future kernel.&n;*/
DECL|enum|pci_flags_bit
r_enum
id|pci_flags_bit
(brace
DECL|enumerator|PCI_USES_IO
DECL|enumerator|PCI_USES_MEM
DECL|enumerator|PCI_USES_MASTER
id|PCI_USES_IO
op_assign
l_int|1
comma
id|PCI_USES_MEM
op_assign
l_int|2
comma
id|PCI_USES_MASTER
op_assign
l_int|4
comma
DECL|enumerator|PCI_ADDR0
DECL|enumerator|PCI_ADDR1
DECL|enumerator|PCI_ADDR2
DECL|enumerator|PCI_ADDR3
id|PCI_ADDR0
op_assign
l_int|0x10
op_lshift
l_int|0
comma
id|PCI_ADDR1
op_assign
l_int|0x10
op_lshift
l_int|1
comma
id|PCI_ADDR2
op_assign
l_int|0x10
op_lshift
l_int|2
comma
id|PCI_ADDR3
op_assign
l_int|0x10
op_lshift
l_int|3
comma
)brace
suffix:semicolon
DECL|struct|pci_id_info
r_struct
id|pci_id_info
(brace
DECL|member|name
r_const
r_char
op_star
id|name
suffix:semicolon
DECL|member|vendor_id
DECL|member|device_id
DECL|member|device_id_mask
DECL|member|flags
id|u16
id|vendor_id
comma
id|device_id
comma
id|device_id_mask
comma
id|flags
suffix:semicolon
DECL|member|drv_flags
DECL|member|io_size
r_int
id|drv_flags
comma
id|io_size
suffix:semicolon
DECL|member|probe1
r_struct
id|device
op_star
(paren
op_star
id|probe1
)paren
(paren
r_int
id|pci_bus
comma
r_int
id|pci_devfn
comma
r_struct
id|device
op_star
id|dev
comma
r_int
id|ioaddr
comma
r_int
id|irq
comma
r_int
id|chip_idx
comma
r_int
id|fnd_cnt
)paren
suffix:semicolon
)brace
suffix:semicolon
DECL|enumerator|IS_VORTEX
DECL|enumerator|IS_BOOMERANG
DECL|enumerator|IS_CYCLONE
r_enum
(brace
id|IS_VORTEX
op_assign
l_int|1
comma
id|IS_BOOMERANG
op_assign
l_int|2
comma
id|IS_CYCLONE
op_assign
l_int|4
comma
DECL|enumerator|HAS_PWR_CTRL
DECL|enumerator|HAS_MII
DECL|enumerator|HAS_NWAY
DECL|enumerator|HAS_CB_FNS
id|HAS_PWR_CTRL
op_assign
l_int|0x10
comma
id|HAS_MII
op_assign
l_int|0x20
comma
id|HAS_NWAY
op_assign
l_int|0x40
comma
id|HAS_CB_FNS
op_assign
l_int|0x80
comma
)brace
suffix:semicolon
r_static
r_struct
id|device
op_star
id|vortex_probe1
c_func
(paren
r_int
id|pci_bus
comma
r_int
id|pci_devfn
comma
r_struct
id|device
op_star
id|dev
comma
r_int
id|ioaddr
comma
r_int
id|irq
comma
r_int
id|dev_id
comma
r_int
id|card_idx
)paren
suffix:semicolon
DECL|variable|pci_tbl
r_static
r_struct
id|pci_id_info
id|pci_tbl
(braket
)braket
op_assign
(brace
(brace
l_string|&quot;3c590 Vortex 10Mbps&quot;
comma
l_int|0x10B7
comma
l_int|0x5900
comma
l_int|0xffff
comma
id|PCI_USES_IO
op_or
id|PCI_USES_MASTER
comma
id|IS_VORTEX
comma
l_int|32
comma
id|vortex_probe1
)brace
comma
(brace
l_string|&quot;3c595 Vortex 100baseTx&quot;
comma
l_int|0x10B7
comma
l_int|0x5950
comma
l_int|0xffff
comma
id|PCI_USES_IO
op_or
id|PCI_USES_MASTER
comma
id|IS_VORTEX
comma
l_int|32
comma
id|vortex_probe1
)brace
comma
(brace
l_string|&quot;3c595 Vortex 100baseT4&quot;
comma
l_int|0x10B7
comma
l_int|0x5951
comma
l_int|0xffff
comma
id|PCI_USES_IO
op_or
id|PCI_USES_MASTER
comma
id|IS_VORTEX
comma
l_int|32
comma
id|vortex_probe1
)brace
comma
(brace
l_string|&quot;3c595 Vortex 100base-MII&quot;
comma
l_int|0x10B7
comma
l_int|0x5952
comma
l_int|0xffff
comma
id|PCI_USES_IO
op_or
id|PCI_USES_MASTER
comma
id|IS_VORTEX
comma
l_int|32
comma
id|vortex_probe1
)brace
comma
(brace
l_string|&quot;3Com Vortex&quot;
comma
l_int|0x10B7
comma
l_int|0x5900
comma
l_int|0xff00
comma
id|PCI_USES_IO
op_or
id|PCI_USES_MASTER
comma
id|IS_BOOMERANG
comma
l_int|64
comma
id|vortex_probe1
)brace
comma
(brace
l_string|&quot;3c900 Boomerang 10baseT&quot;
comma
l_int|0x10B7
comma
l_int|0x9000
comma
l_int|0xffff
comma
id|PCI_USES_IO
op_or
id|PCI_USES_MASTER
comma
id|IS_BOOMERANG
comma
l_int|64
comma
id|vortex_probe1
)brace
comma
(brace
l_string|&quot;3c900 Boomerang 10Mbps Combo&quot;
comma
l_int|0x10B7
comma
l_int|0x9001
comma
l_int|0xffff
comma
id|PCI_USES_IO
op_or
id|PCI_USES_MASTER
comma
id|IS_BOOMERANG
comma
l_int|64
comma
id|vortex_probe1
)brace
comma
(brace
l_string|&quot;3c900 Cyclone 10Mbps Combo&quot;
comma
l_int|0x10B7
comma
l_int|0x9005
comma
l_int|0xffff
comma
id|PCI_USES_IO
op_or
id|PCI_USES_MASTER
comma
id|IS_CYCLONE
comma
l_int|128
comma
id|vortex_probe1
)brace
comma
(brace
l_string|&quot;3c900B-FL Cyclone 10base-FL&quot;
comma
l_int|0x10B7
comma
l_int|0x900A
comma
l_int|0xffff
comma
id|PCI_USES_IO
op_or
id|PCI_USES_MASTER
comma
id|IS_CYCLONE
comma
l_int|128
comma
id|vortex_probe1
)brace
comma
(brace
l_string|&quot;3c905 Boomerang 100baseTx&quot;
comma
l_int|0x10B7
comma
l_int|0x9050
comma
l_int|0xffff
comma
id|PCI_USES_IO
op_or
id|PCI_USES_MASTER
comma
id|IS_BOOMERANG
op_or
id|HAS_MII
comma
l_int|64
comma
id|vortex_probe1
)brace
comma
(brace
l_string|&quot;3c905 Boomerang 100baseT4&quot;
comma
l_int|0x10B7
comma
l_int|0x9051
comma
l_int|0xffff
comma
id|PCI_USES_IO
op_or
id|PCI_USES_MASTER
comma
id|IS_BOOMERANG
op_or
id|HAS_MII
comma
l_int|64
comma
id|vortex_probe1
)brace
comma
(brace
l_string|&quot;3c905B Cyclone 100baseTx&quot;
comma
l_int|0x10B7
comma
l_int|0x9055
comma
l_int|0xffff
comma
id|PCI_USES_IO
op_or
id|PCI_USES_MASTER
comma
id|IS_CYCLONE
op_or
id|HAS_NWAY
comma
l_int|128
comma
id|vortex_probe1
)brace
comma
(brace
l_string|&quot;3c905B-FX Cyclone 100baseFx&quot;
comma
l_int|0x10B7
comma
l_int|0x905A
comma
l_int|0xffff
comma
id|PCI_USES_IO
op_or
id|PCI_USES_MASTER
comma
id|IS_CYCLONE
comma
l_int|128
comma
id|vortex_probe1
)brace
comma
(brace
l_string|&quot;3c980 Cyclone&quot;
comma
l_int|0x10B7
comma
l_int|0x9800
comma
l_int|0xfff0
comma
id|PCI_USES_IO
op_or
id|PCI_USES_MASTER
comma
id|IS_CYCLONE
comma
l_int|128
comma
id|vortex_probe1
)brace
comma
(brace
l_string|&quot;3c575 Boomerang CardBus&quot;
comma
l_int|0x10B7
comma
l_int|0x5057
comma
l_int|0xffff
comma
id|PCI_USES_IO
op_or
id|PCI_USES_MASTER
comma
id|IS_BOOMERANG
op_or
id|HAS_MII
comma
l_int|64
comma
id|vortex_probe1
)brace
comma
(brace
l_string|&quot;3CCFE575 Cyclone CardBus&quot;
comma
l_int|0x10B7
comma
l_int|0x5157
comma
l_int|0xffff
comma
id|PCI_USES_IO
op_or
id|PCI_USES_MASTER
comma
id|IS_CYCLONE
op_or
id|HAS_NWAY
op_or
id|HAS_CB_FNS
comma
l_int|128
comma
id|vortex_probe1
)brace
comma
(brace
l_string|&quot;3c575 series CardBus (unknown version)&quot;
comma
l_int|0x10B7
comma
l_int|0x5057
comma
l_int|0xf0ff
comma
id|PCI_USES_IO
op_or
id|PCI_USES_MASTER
comma
id|IS_BOOMERANG
op_or
id|HAS_MII
comma
l_int|64
comma
id|vortex_probe1
)brace
comma
(brace
l_string|&quot;3Com Boomerang (unknown version)&quot;
comma
l_int|0x10B7
comma
l_int|0x9000
comma
l_int|0xff00
comma
id|PCI_USES_IO
op_or
id|PCI_USES_MASTER
comma
id|IS_BOOMERANG
comma
l_int|64
comma
id|vortex_probe1
)brace
comma
(brace
l_int|0
comma
)brace
comma
multiline_comment|/* 0 terminated list. */
)brace
suffix:semicolon
multiline_comment|/* Operational definitions.&n;   These are not used by other compilation units and thus are not&n;   exported in a &quot;.h&quot; file.&n;&n;   First the windows.  There are eight register windows, with the command&n;   and status registers available in each.&n;   */
DECL|macro|EL3WINDOW
mdefine_line|#define EL3WINDOW(win_num) outw(SelectWindow + (win_num), ioaddr + EL3_CMD)
DECL|macro|EL3_CMD
mdefine_line|#define EL3_CMD 0x0e
DECL|macro|EL3_STATUS
mdefine_line|#define EL3_STATUS 0x0e
multiline_comment|/* The top five bits written to EL3_CMD are a command, the lower&n;   11 bits are the parameter, if applicable.&n;   Note that 11 parameters bits was fine for ethernet, but the new chip&n;   can handle FDDI length frames (~4500 octets) and now parameters count&n;   32-bit &squot;Dwords&squot; rather than octets. */
DECL|enum|vortex_cmd
r_enum
id|vortex_cmd
(brace
DECL|enumerator|TotalReset
DECL|enumerator|SelectWindow
DECL|enumerator|StartCoax
id|TotalReset
op_assign
l_int|0
op_lshift
l_int|11
comma
id|SelectWindow
op_assign
l_int|1
op_lshift
l_int|11
comma
id|StartCoax
op_assign
l_int|2
op_lshift
l_int|11
comma
DECL|enumerator|RxDisable
DECL|enumerator|RxEnable
DECL|enumerator|RxReset
id|RxDisable
op_assign
l_int|3
op_lshift
l_int|11
comma
id|RxEnable
op_assign
l_int|4
op_lshift
l_int|11
comma
id|RxReset
op_assign
l_int|5
op_lshift
l_int|11
comma
DECL|enumerator|UpStall
DECL|enumerator|UpUnstall
id|UpStall
op_assign
l_int|6
op_lshift
l_int|11
comma
id|UpUnstall
op_assign
(paren
l_int|6
op_lshift
l_int|11
)paren
op_plus
l_int|1
comma
DECL|enumerator|DownStall
DECL|enumerator|DownUnstall
id|DownStall
op_assign
(paren
l_int|6
op_lshift
l_int|11
)paren
op_plus
l_int|2
comma
id|DownUnstall
op_assign
(paren
l_int|6
op_lshift
l_int|11
)paren
op_plus
l_int|3
comma
DECL|enumerator|RxDiscard
DECL|enumerator|TxEnable
DECL|enumerator|TxDisable
DECL|enumerator|TxReset
id|RxDiscard
op_assign
l_int|8
op_lshift
l_int|11
comma
id|TxEnable
op_assign
l_int|9
op_lshift
l_int|11
comma
id|TxDisable
op_assign
l_int|10
op_lshift
l_int|11
comma
id|TxReset
op_assign
l_int|11
op_lshift
l_int|11
comma
DECL|enumerator|FakeIntr
DECL|enumerator|AckIntr
DECL|enumerator|SetIntrEnb
id|FakeIntr
op_assign
l_int|12
op_lshift
l_int|11
comma
id|AckIntr
op_assign
l_int|13
op_lshift
l_int|11
comma
id|SetIntrEnb
op_assign
l_int|14
op_lshift
l_int|11
comma
DECL|enumerator|SetStatusEnb
DECL|enumerator|SetRxFilter
DECL|enumerator|SetRxThreshold
id|SetStatusEnb
op_assign
l_int|15
op_lshift
l_int|11
comma
id|SetRxFilter
op_assign
l_int|16
op_lshift
l_int|11
comma
id|SetRxThreshold
op_assign
l_int|17
op_lshift
l_int|11
comma
DECL|enumerator|SetTxThreshold
DECL|enumerator|SetTxStart
id|SetTxThreshold
op_assign
l_int|18
op_lshift
l_int|11
comma
id|SetTxStart
op_assign
l_int|19
op_lshift
l_int|11
comma
DECL|enumerator|StartDMAUp
DECL|enumerator|StartDMADown
DECL|enumerator|StatsEnable
id|StartDMAUp
op_assign
l_int|20
op_lshift
l_int|11
comma
id|StartDMADown
op_assign
(paren
l_int|20
op_lshift
l_int|11
)paren
op_plus
l_int|1
comma
id|StatsEnable
op_assign
l_int|21
op_lshift
l_int|11
comma
DECL|enumerator|StatsDisable
DECL|enumerator|StopCoax
DECL|enumerator|SetFilterBit
id|StatsDisable
op_assign
l_int|22
op_lshift
l_int|11
comma
id|StopCoax
op_assign
l_int|23
op_lshift
l_int|11
comma
id|SetFilterBit
op_assign
l_int|25
op_lshift
l_int|11
comma
)brace
suffix:semicolon
multiline_comment|/* The SetRxFilter command accepts the following classes: */
DECL|enum|RxFilter
r_enum
id|RxFilter
(brace
DECL|enumerator|RxStation
DECL|enumerator|RxMulticast
DECL|enumerator|RxBroadcast
DECL|enumerator|RxProm
id|RxStation
op_assign
l_int|1
comma
id|RxMulticast
op_assign
l_int|2
comma
id|RxBroadcast
op_assign
l_int|4
comma
id|RxProm
op_assign
l_int|8
)brace
suffix:semicolon
multiline_comment|/* Bits in the general status register. */
DECL|enum|vortex_status
r_enum
id|vortex_status
(brace
DECL|enumerator|IntLatch
DECL|enumerator|HostError
DECL|enumerator|TxComplete
id|IntLatch
op_assign
l_int|0x0001
comma
id|HostError
op_assign
l_int|0x0002
comma
id|TxComplete
op_assign
l_int|0x0004
comma
DECL|enumerator|TxAvailable
DECL|enumerator|RxComplete
DECL|enumerator|RxEarly
id|TxAvailable
op_assign
l_int|0x0008
comma
id|RxComplete
op_assign
l_int|0x0010
comma
id|RxEarly
op_assign
l_int|0x0020
comma
DECL|enumerator|IntReq
DECL|enumerator|StatsFull
id|IntReq
op_assign
l_int|0x0040
comma
id|StatsFull
op_assign
l_int|0x0080
comma
DECL|enumerator|DMADone
DECL|enumerator|DownComplete
DECL|enumerator|UpComplete
id|DMADone
op_assign
l_int|1
op_lshift
l_int|8
comma
id|DownComplete
op_assign
l_int|1
op_lshift
l_int|9
comma
id|UpComplete
op_assign
l_int|1
op_lshift
l_int|10
comma
DECL|enumerator|DMAInProgress
id|DMAInProgress
op_assign
l_int|1
op_lshift
l_int|11
comma
multiline_comment|/* DMA controller is still busy.*/
DECL|enumerator|CmdInProgress
id|CmdInProgress
op_assign
l_int|1
op_lshift
l_int|12
comma
multiline_comment|/* EL3_CMD is still busy.*/
)brace
suffix:semicolon
multiline_comment|/* Register window 1 offsets, the window used in normal operation.&n;   On the Vortex this window is always mapped at offsets 0x10-0x1f. */
DECL|enum|Window1
r_enum
id|Window1
(brace
DECL|enumerator|TX_FIFO
DECL|enumerator|RX_FIFO
DECL|enumerator|RxErrors
id|TX_FIFO
op_assign
l_int|0x10
comma
id|RX_FIFO
op_assign
l_int|0x10
comma
id|RxErrors
op_assign
l_int|0x14
comma
DECL|enumerator|RxStatus
DECL|enumerator|Timer
DECL|enumerator|TxStatus
id|RxStatus
op_assign
l_int|0x18
comma
id|Timer
op_assign
l_int|0x1A
comma
id|TxStatus
op_assign
l_int|0x1B
comma
DECL|enumerator|TxFree
id|TxFree
op_assign
l_int|0x1C
comma
multiline_comment|/* Remaining free bytes in Tx buffer. */
)brace
suffix:semicolon
DECL|enum|Window0
r_enum
id|Window0
(brace
DECL|enumerator|Wn0EepromCmd
id|Wn0EepromCmd
op_assign
l_int|10
comma
multiline_comment|/* Window 0: EEPROM command register. */
DECL|enumerator|Wn0EepromData
id|Wn0EepromData
op_assign
l_int|12
comma
multiline_comment|/* Window 0: EEPROM results register. */
DECL|enumerator|IntrStatus
id|IntrStatus
op_assign
l_int|0x0E
comma
multiline_comment|/* Valid in all windows. */
)brace
suffix:semicolon
DECL|enum|Win0_EEPROM_bits
r_enum
id|Win0_EEPROM_bits
(brace
DECL|enumerator|EEPROM_Read
DECL|enumerator|EEPROM_WRITE
DECL|enumerator|EEPROM_ERASE
id|EEPROM_Read
op_assign
l_int|0x80
comma
id|EEPROM_WRITE
op_assign
l_int|0x40
comma
id|EEPROM_ERASE
op_assign
l_int|0xC0
comma
DECL|enumerator|EEPROM_EWENB
id|EEPROM_EWENB
op_assign
l_int|0x30
comma
multiline_comment|/* Enable erasing/writing for 10 msec. */
DECL|enumerator|EEPROM_EWDIS
id|EEPROM_EWDIS
op_assign
l_int|0x00
comma
multiline_comment|/* Disable EWENB before 10 msec timeout. */
)brace
suffix:semicolon
multiline_comment|/* EEPROM locations. */
DECL|enum|eeprom_offset
r_enum
id|eeprom_offset
(brace
DECL|enumerator|PhysAddr01
DECL|enumerator|PhysAddr23
DECL|enumerator|PhysAddr45
DECL|enumerator|ModelID
id|PhysAddr01
op_assign
l_int|0
comma
id|PhysAddr23
op_assign
l_int|1
comma
id|PhysAddr45
op_assign
l_int|2
comma
id|ModelID
op_assign
l_int|3
comma
DECL|enumerator|EtherLink3ID
DECL|enumerator|IFXcvrIO
DECL|enumerator|IRQLine
id|EtherLink3ID
op_assign
l_int|7
comma
id|IFXcvrIO
op_assign
l_int|8
comma
id|IRQLine
op_assign
l_int|9
comma
DECL|enumerator|NodeAddr01
DECL|enumerator|NodeAddr23
DECL|enumerator|NodeAddr45
id|NodeAddr01
op_assign
l_int|10
comma
id|NodeAddr23
op_assign
l_int|11
comma
id|NodeAddr45
op_assign
l_int|12
comma
DECL|enumerator|DriverTune
DECL|enumerator|Checksum
id|DriverTune
op_assign
l_int|13
comma
id|Checksum
op_assign
l_int|15
)brace
suffix:semicolon
DECL|enum|Window2
r_enum
id|Window2
(brace
multiline_comment|/* Window 2. */
DECL|enumerator|Wn2_ResetOptions
id|Wn2_ResetOptions
op_assign
l_int|12
comma
)brace
suffix:semicolon
DECL|enum|Window3
r_enum
id|Window3
(brace
multiline_comment|/* Window 3: MAC/config bits. */
DECL|enumerator|Wn3_Config
DECL|enumerator|Wn3_MAC_Ctrl
DECL|enumerator|Wn3_Options
id|Wn3_Config
op_assign
l_int|0
comma
id|Wn3_MAC_Ctrl
op_assign
l_int|6
comma
id|Wn3_Options
op_assign
l_int|8
comma
)brace
suffix:semicolon
DECL|union|wn3_config
r_union
id|wn3_config
(brace
DECL|member|i
r_int
id|i
suffix:semicolon
DECL|struct|w3_config_fields
r_struct
id|w3_config_fields
(brace
DECL|member|ram_size
DECL|member|ram_width
DECL|member|ram_speed
DECL|member|rom_size
r_int
r_int
id|ram_size
suffix:colon
l_int|3
comma
id|ram_width
suffix:colon
l_int|1
comma
id|ram_speed
suffix:colon
l_int|2
comma
id|rom_size
suffix:colon
l_int|2
suffix:semicolon
DECL|member|pad8
r_int
id|pad8
suffix:colon
l_int|8
suffix:semicolon
DECL|member|ram_split
DECL|member|pad18
DECL|member|xcvr
DECL|member|autoselect
r_int
r_int
id|ram_split
suffix:colon
l_int|2
comma
id|pad18
suffix:colon
l_int|2
comma
id|xcvr
suffix:colon
l_int|4
comma
id|autoselect
suffix:colon
l_int|1
suffix:semicolon
DECL|member|pad24
r_int
id|pad24
suffix:colon
l_int|7
suffix:semicolon
DECL|member|u
)brace
id|u
suffix:semicolon
)brace
suffix:semicolon
DECL|enum|Window4
r_enum
id|Window4
(brace
multiline_comment|/* Window 4: Xcvr/media bits. */
DECL|enumerator|Wn4_FIFODiag
DECL|enumerator|Wn4_NetDiag
DECL|enumerator|Wn4_PhysicalMgmt
DECL|enumerator|Wn4_Media
id|Wn4_FIFODiag
op_assign
l_int|4
comma
id|Wn4_NetDiag
op_assign
l_int|6
comma
id|Wn4_PhysicalMgmt
op_assign
l_int|8
comma
id|Wn4_Media
op_assign
l_int|10
comma
)brace
suffix:semicolon
DECL|enum|Win4_Media_bits
r_enum
id|Win4_Media_bits
(brace
DECL|enumerator|Media_SQE
id|Media_SQE
op_assign
l_int|0x0008
comma
multiline_comment|/* Enable SQE error counting for AUI. */
DECL|enumerator|Media_10TP
id|Media_10TP
op_assign
l_int|0x00C0
comma
multiline_comment|/* Enable link beat and jabber for 10baseT. */
DECL|enumerator|Media_Lnk
id|Media_Lnk
op_assign
l_int|0x0080
comma
multiline_comment|/* Enable just link beat for 100TX/100FX. */
DECL|enumerator|Media_LnkBeat
id|Media_LnkBeat
op_assign
l_int|0x0800
comma
)brace
suffix:semicolon
DECL|enum|Window7
r_enum
id|Window7
(brace
multiline_comment|/* Window 7: Bus Master control. */
DECL|enumerator|Wn7_MasterAddr
DECL|enumerator|Wn7_MasterLen
DECL|enumerator|Wn7_MasterStatus
id|Wn7_MasterAddr
op_assign
l_int|0
comma
id|Wn7_MasterLen
op_assign
l_int|6
comma
id|Wn7_MasterStatus
op_assign
l_int|12
comma
)brace
suffix:semicolon
multiline_comment|/* Boomerang bus master control registers. */
DECL|enum|MasterCtrl
r_enum
id|MasterCtrl
(brace
DECL|enumerator|PktStatus
DECL|enumerator|DownListPtr
DECL|enumerator|FragAddr
DECL|enumerator|FragLen
id|PktStatus
op_assign
l_int|0x20
comma
id|DownListPtr
op_assign
l_int|0x24
comma
id|FragAddr
op_assign
l_int|0x28
comma
id|FragLen
op_assign
l_int|0x2c
comma
DECL|enumerator|TxFreeThreshold
DECL|enumerator|UpPktStatus
DECL|enumerator|UpListPtr
id|TxFreeThreshold
op_assign
l_int|0x2f
comma
id|UpPktStatus
op_assign
l_int|0x30
comma
id|UpListPtr
op_assign
l_int|0x38
comma
)brace
suffix:semicolon
multiline_comment|/* The Rx and Tx descriptor lists.&n;   Caution Alpha hackers: these types are 32 bits!  Note also the 8 byte&n;   alignment contraint on tx_ring[] and rx_ring[]. */
DECL|macro|LAST_FRAG
mdefine_line|#define LAST_FRAG  0x80000000&t;&t;&t;/* Last Addr/Len pair in descriptor. */
DECL|struct|boom_rx_desc
r_struct
id|boom_rx_desc
(brace
DECL|member|next
id|u32
id|next
suffix:semicolon
multiline_comment|/* Last entry points to 0.   */
DECL|member|status
id|s32
id|status
suffix:semicolon
DECL|member|addr
id|u32
id|addr
suffix:semicolon
multiline_comment|/* Up to 63 addr/len pairs possible. */
DECL|member|length
id|s32
id|length
suffix:semicolon
multiline_comment|/* Set LAST_FRAG to indicate last pair. */
)brace
suffix:semicolon
multiline_comment|/* Values for the Rx status entry. */
DECL|enum|rx_desc_status
r_enum
id|rx_desc_status
(brace
DECL|enumerator|RxDComplete
DECL|enumerator|RxDError
id|RxDComplete
op_assign
l_int|0x00008000
comma
id|RxDError
op_assign
l_int|0x4000
comma
multiline_comment|/* See boomerang_rx() for actual error bits */
DECL|enumerator|IPChksumErr
DECL|enumerator|TCPChksumErr
DECL|enumerator|UDPChksumErr
id|IPChksumErr
op_assign
l_int|1
op_lshift
l_int|25
comma
id|TCPChksumErr
op_assign
l_int|1
op_lshift
l_int|26
comma
id|UDPChksumErr
op_assign
l_int|1
op_lshift
l_int|27
comma
DECL|enumerator|IPChksumValid
DECL|enumerator|TCPChksumValid
DECL|enumerator|UDPChksumValid
id|IPChksumValid
op_assign
l_int|1
op_lshift
l_int|29
comma
id|TCPChksumValid
op_assign
l_int|1
op_lshift
l_int|30
comma
id|UDPChksumValid
op_assign
l_int|1
op_lshift
l_int|31
comma
)brace
suffix:semicolon
DECL|struct|boom_tx_desc
r_struct
id|boom_tx_desc
(brace
DECL|member|next
id|u32
id|next
suffix:semicolon
multiline_comment|/* Last entry points to 0.   */
DECL|member|status
id|s32
id|status
suffix:semicolon
multiline_comment|/* bits 0:12 length, others see below.  */
DECL|member|addr
id|u32
id|addr
suffix:semicolon
DECL|member|length
id|s32
id|length
suffix:semicolon
)brace
suffix:semicolon
multiline_comment|/* Values for the Tx status entry. */
DECL|enum|tx_desc_status
r_enum
id|tx_desc_status
(brace
DECL|enumerator|CRCDisable
DECL|enumerator|TxDComplete
id|CRCDisable
op_assign
l_int|0x2000
comma
id|TxDComplete
op_assign
l_int|0x8000
comma
DECL|enumerator|AddIPChksum
DECL|enumerator|AddTCPChksum
DECL|enumerator|AddUDPChksum
id|AddIPChksum
op_assign
l_int|0x02000000
comma
id|AddTCPChksum
op_assign
l_int|0x04000000
comma
id|AddUDPChksum
op_assign
l_int|0x08000000
comma
DECL|enumerator|TxIntrUploaded
id|TxIntrUploaded
op_assign
l_int|0x80000000
comma
multiline_comment|/* IRQ when in FIFO, but maybe not sent. */
)brace
suffix:semicolon
multiline_comment|/* Chip features we care about in vp-&gt;capabilities, read from the EEPROM. */
DECL|enum|ChipCaps
DECL|enumerator|CapBusMaster
r_enum
id|ChipCaps
(brace
id|CapBusMaster
op_assign
l_int|0x20
)brace
suffix:semicolon
DECL|struct|vortex_private
r_struct
id|vortex_private
(brace
multiline_comment|/* The Rx and Tx rings should be quad-word-aligned. */
DECL|member|rx_ring
r_struct
id|boom_rx_desc
id|rx_ring
(braket
id|RX_RING_SIZE
)braket
suffix:semicolon
DECL|member|tx_ring
r_struct
id|boom_tx_desc
id|tx_ring
(braket
id|TX_RING_SIZE
)braket
suffix:semicolon
multiline_comment|/* The addresses of transmit- and receive-in-place skbuffs. */
DECL|member|rx_skbuff
r_struct
id|sk_buff
op_star
id|rx_skbuff
(braket
id|RX_RING_SIZE
)braket
suffix:semicolon
DECL|member|tx_skbuff
r_struct
id|sk_buff
op_star
id|tx_skbuff
(braket
id|TX_RING_SIZE
)braket
suffix:semicolon
DECL|member|next_module
r_struct
id|device
op_star
id|next_module
suffix:semicolon
DECL|member|priv_addr
r_void
op_star
id|priv_addr
suffix:semicolon
DECL|member|cur_rx
DECL|member|cur_tx
r_int
r_int
id|cur_rx
comma
id|cur_tx
suffix:semicolon
multiline_comment|/* The next free ring entry */
DECL|member|dirty_rx
DECL|member|dirty_tx
r_int
r_int
id|dirty_rx
comma
id|dirty_tx
suffix:semicolon
multiline_comment|/* The ring entries to be free()ed. */
DECL|member|stats
r_struct
id|net_device_stats
id|stats
suffix:semicolon
DECL|member|tx_skb
r_struct
id|sk_buff
op_star
id|tx_skb
suffix:semicolon
multiline_comment|/* Packet being eaten by bus master ctrl.  */
multiline_comment|/* PCI configuration space information. */
DECL|member|pci_bus
DECL|member|pci_devfn
id|u8
id|pci_bus
comma
id|pci_devfn
suffix:semicolon
multiline_comment|/* PCI bus location, for power management. */
DECL|member|cb_fn_base
r_char
op_star
id|cb_fn_base
suffix:semicolon
multiline_comment|/* CardBus function status addr space. */
DECL|member|chip_id
r_int
id|chip_id
suffix:semicolon
multiline_comment|/* The remainder are related to chip state, mostly media selection. */
DECL|member|in_interrupt
r_int
r_int
id|in_interrupt
suffix:semicolon
DECL|member|timer
r_struct
id|timer_list
id|timer
suffix:semicolon
multiline_comment|/* Media selection timer. */
DECL|member|options
r_int
id|options
suffix:semicolon
multiline_comment|/* User-settable misc. driver options. */
DECL|member|media_override
r_int
r_int
id|media_override
suffix:colon
l_int|3
comma
multiline_comment|/* Passed-in media type. */
DECL|member|default_media
id|default_media
suffix:colon
l_int|4
comma
multiline_comment|/* Read from the EEPROM/Wn3_Config. */
DECL|member|full_duplex
DECL|member|force_fd
DECL|member|autoselect
id|full_duplex
suffix:colon
l_int|1
comma
id|force_fd
suffix:colon
l_int|1
comma
id|autoselect
suffix:colon
l_int|1
comma
DECL|member|bus_master
id|bus_master
suffix:colon
l_int|1
comma
multiline_comment|/* Vortex can only do a fragment bus-m. */
DECL|member|full_bus_master_tx
DECL|member|full_bus_master_rx
id|full_bus_master_tx
suffix:colon
l_int|1
comma
id|full_bus_master_rx
suffix:colon
l_int|2
comma
multiline_comment|/* Boomerang  */
DECL|member|hw_csums
id|hw_csums
suffix:colon
l_int|1
comma
multiline_comment|/* Has hardware checksums. */
DECL|member|tx_full
id|tx_full
suffix:colon
l_int|1
suffix:semicolon
DECL|member|status_enable
id|u16
id|status_enable
suffix:semicolon
DECL|member|intr_enable
id|u16
id|intr_enable
suffix:semicolon
DECL|member|available_media
id|u16
id|available_media
suffix:semicolon
multiline_comment|/* From Wn3_Options. */
DECL|member|capabilities
DECL|member|info1
DECL|member|info2
id|u16
id|capabilities
comma
id|info1
comma
id|info2
suffix:semicolon
multiline_comment|/* Various, from EEPROM. */
DECL|member|advertising
id|u16
id|advertising
suffix:semicolon
multiline_comment|/* NWay media advertisement */
DECL|member|phys
r_int
r_char
id|phys
(braket
l_int|2
)braket
suffix:semicolon
multiline_comment|/* MII device addresses. */
)brace
suffix:semicolon
multiline_comment|/* The action to take with a media selection timer tick.&n;   Note that we deviate from the 3Com order by checking 10base2 before AUI.&n; */
DECL|enum|xcvr_types
r_enum
id|xcvr_types
(brace
DECL|enumerator|XCVR_10baseT
DECL|enumerator|XCVR_AUI
DECL|enumerator|XCVR_10baseTOnly
DECL|enumerator|XCVR_10base2
DECL|enumerator|XCVR_100baseTx
id|XCVR_10baseT
op_assign
l_int|0
comma
id|XCVR_AUI
comma
id|XCVR_10baseTOnly
comma
id|XCVR_10base2
comma
id|XCVR_100baseTx
comma
DECL|enumerator|XCVR_100baseFx
DECL|enumerator|XCVR_MII
DECL|enumerator|XCVR_NWAY
DECL|enumerator|XCVR_ExtMII
DECL|enumerator|XCVR_Default
id|XCVR_100baseFx
comma
id|XCVR_MII
op_assign
l_int|6
comma
id|XCVR_NWAY
op_assign
l_int|8
comma
id|XCVR_ExtMII
op_assign
l_int|9
comma
id|XCVR_Default
op_assign
l_int|10
comma
)brace
suffix:semicolon
DECL|struct|media_table
r_static
r_struct
id|media_table
(brace
DECL|member|name
r_char
op_star
id|name
suffix:semicolon
DECL|member|media_bits
r_int
r_int
id|media_bits
suffix:colon
l_int|16
comma
multiline_comment|/* Bits to set in Wn4_Media register. */
DECL|member|mask
id|mask
suffix:colon
l_int|8
comma
multiline_comment|/* The transceiver-present bit in Wn3_Config.*/
DECL|member|next
id|next
suffix:colon
l_int|8
suffix:semicolon
multiline_comment|/* The media type to try next. */
DECL|member|wait
r_int
id|wait
suffix:semicolon
multiline_comment|/* Time before we check media status. */
DECL|variable|media_tbl
)brace
id|media_tbl
(braket
)braket
op_assign
(brace
(brace
l_string|&quot;10baseT&quot;
comma
id|Media_10TP
comma
l_int|0x08
comma
id|XCVR_10base2
comma
(paren
l_int|14
op_star
id|HZ
)paren
op_div
l_int|10
)brace
comma
(brace
l_string|&quot;10Mbs AUI&quot;
comma
id|Media_SQE
comma
l_int|0x20
comma
id|XCVR_Default
comma
(paren
l_int|1
op_star
id|HZ
)paren
op_div
l_int|10
)brace
comma
(brace
l_string|&quot;undefined&quot;
comma
l_int|0
comma
l_int|0x80
comma
id|XCVR_10baseT
comma
l_int|10000
)brace
comma
(brace
l_string|&quot;10base2&quot;
comma
l_int|0
comma
l_int|0x10
comma
id|XCVR_AUI
comma
(paren
l_int|1
op_star
id|HZ
)paren
op_div
l_int|10
)brace
comma
(brace
l_string|&quot;100baseTX&quot;
comma
id|Media_Lnk
comma
l_int|0x02
comma
id|XCVR_100baseFx
comma
(paren
l_int|14
op_star
id|HZ
)paren
op_div
l_int|10
)brace
comma
(brace
l_string|&quot;100baseFX&quot;
comma
id|Media_Lnk
comma
l_int|0x04
comma
id|XCVR_MII
comma
(paren
l_int|14
op_star
id|HZ
)paren
op_div
l_int|10
)brace
comma
(brace
l_string|&quot;MII&quot;
comma
l_int|0
comma
l_int|0x41
comma
id|XCVR_10baseT
comma
l_int|3
op_star
id|HZ
)brace
comma
(brace
l_string|&quot;undefined&quot;
comma
l_int|0
comma
l_int|0x01
comma
id|XCVR_10baseT
comma
l_int|10000
)brace
comma
(brace
l_string|&quot;Autonegotiate&quot;
comma
l_int|0
comma
l_int|0x41
comma
id|XCVR_10baseT
comma
l_int|3
op_star
id|HZ
)brace
comma
(brace
l_string|&quot;MII-External&quot;
comma
l_int|0
comma
l_int|0x41
comma
id|XCVR_10baseT
comma
l_int|3
op_star
id|HZ
)brace
comma
(brace
l_string|&quot;Default&quot;
comma
l_int|0
comma
l_int|0xFF
comma
id|XCVR_10baseT
comma
l_int|10000
)brace
comma
)brace
suffix:semicolon
macro_line|#ifndef CARDBUS
r_static
r_int
id|vortex_scan
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
r_struct
id|pci_id_info
id|pci_tbl
(braket
)braket
)paren
suffix:semicolon
macro_line|#endif
r_static
r_int
id|vortex_open
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_void
id|mdio_sync
c_func
(paren
r_int
id|ioaddr
comma
r_int
id|bits
)paren
suffix:semicolon
r_static
r_int
id|mdio_read
c_func
(paren
r_int
id|ioaddr
comma
r_int
id|phy_id
comma
r_int
id|location
)paren
suffix:semicolon
r_static
r_void
id|mdio_write
c_func
(paren
r_int
id|ioaddr
comma
r_int
id|phy_id
comma
r_int
id|location
comma
r_int
id|value
)paren
suffix:semicolon
r_static
r_void
id|vortex_timer
c_func
(paren
r_int
r_int
id|arg
)paren
suffix:semicolon
r_static
r_int
id|vortex_start_xmit
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_int
id|boomerang_start_xmit
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_int
id|vortex_rx
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_int
id|boomerang_rx
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_void
id|vortex_interrupt
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
suffix:semicolon
r_static
r_int
id|vortex_close
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_void
id|update_stats
c_func
(paren
r_int
id|ioaddr
comma
r_struct
id|device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_struct
id|net_device_stats
op_star
id|vortex_get_stats
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_void
id|set_rx_mode
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_int
id|vortex_ioctl
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
r_struct
id|ifreq
op_star
id|rq
comma
r_int
id|cmd
)paren
suffix:semicolon
"&f;"
multiline_comment|/* This driver uses &squot;options&squot; to pass the media type, full-duplex flag, etc. */
multiline_comment|/* Option count limit only -- unlimited interfaces are supported. */
DECL|macro|MAX_UNITS
mdefine_line|#define MAX_UNITS 8
DECL|variable|options
r_static
r_int
id|options
(braket
id|MAX_UNITS
)braket
op_assign
(brace
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
)brace
suffix:semicolon
DECL|variable|full_duplex
r_static
r_int
id|full_duplex
(braket
id|MAX_UNITS
)braket
op_assign
(brace
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
)brace
suffix:semicolon
multiline_comment|/* A list of all installed Vortex devices, for removing the driver module. */
DECL|variable|root_vortex_dev
r_static
r_struct
id|device
op_star
id|root_vortex_dev
op_assign
l_int|NULL
suffix:semicolon
macro_line|#ifdef MODULE
macro_line|#ifndef CARDBUS
multiline_comment|/* Variables to work-around the Compaq PCI BIOS32 problem. */
DECL|variable|compaq_ioaddr
DECL|variable|compaq_irq
DECL|variable|compaq_device_id
r_static
r_int
id|compaq_ioaddr
op_assign
l_int|0
comma
id|compaq_irq
op_assign
l_int|0
comma
id|compaq_device_id
op_assign
l_int|0x5900
suffix:semicolon
macro_line|#endif
macro_line|#ifdef CARDBUS
macro_line|#include &lt;pcmcia/driver_ops.h&gt;
DECL|function|vortex_attach
r_static
id|dev_node_t
op_star
id|vortex_attach
c_func
(paren
id|dev_locator_t
op_star
id|loc
)paren
(brace
id|u16
id|dev_id
comma
id|vendor_id
suffix:semicolon
id|u32
id|io
suffix:semicolon
id|u8
id|bus
comma
id|devfn
comma
id|irq
suffix:semicolon
r_struct
id|device
op_star
id|dev
suffix:semicolon
r_int
id|chip_idx
suffix:semicolon
r_if
c_cond
(paren
id|loc-&gt;bus
op_ne
id|LOC_PCI
)paren
r_return
l_int|NULL
suffix:semicolon
id|bus
op_assign
id|loc-&gt;b.pci.bus
suffix:semicolon
id|devfn
op_assign
id|loc-&gt;b.pci.devfn
suffix:semicolon
id|pcibios_read_config_dword
c_func
(paren
id|bus
comma
id|devfn
comma
id|PCI_BASE_ADDRESS_0
comma
op_amp
id|io
)paren
suffix:semicolon
id|pcibios_read_config_byte
c_func
(paren
id|bus
comma
id|devfn
comma
id|PCI_INTERRUPT_LINE
comma
op_amp
id|irq
)paren
suffix:semicolon
id|pcibios_read_config_word
c_func
(paren
id|bus
comma
id|devfn
comma
id|PCI_VENDOR_ID
comma
op_amp
id|vendor_id
)paren
suffix:semicolon
id|pcibios_read_config_word
c_func
(paren
id|bus
comma
id|devfn
comma
id|PCI_DEVICE_ID
comma
op_amp
id|dev_id
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;vortex_attach(bus %d, function %d, device %4.4x)&bslash;n&quot;
comma
id|bus
comma
id|devfn
comma
id|dev_id
)paren
suffix:semicolon
id|io
op_and_assign
op_complement
l_int|3
suffix:semicolon
r_if
c_cond
(paren
id|io
op_eq
l_int|0
op_logical_or
id|irq
op_eq
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;The 3Com CardBus Ethernet interface was not &quot;
l_string|&quot;assigned an %s.&bslash;n&quot;
id|KERN_ERR
l_string|&quot;  It will not be activated.&bslash;n&quot;
comma
id|io
op_eq
l_int|0
ques
c_cond
l_string|&quot;I/O address&quot;
suffix:colon
l_string|&quot;IRQ&quot;
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
r_for
c_loop
(paren
id|chip_idx
op_assign
l_int|0
suffix:semicolon
id|pci_tbl
(braket
id|chip_idx
)braket
dot
id|vendor_id
suffix:semicolon
id|chip_idx
op_increment
)paren
r_if
c_cond
(paren
id|vendor_id
op_eq
id|pci_tbl
(braket
id|chip_idx
)braket
dot
id|vendor_id
op_logical_and
(paren
id|dev_id
op_amp
id|pci_tbl
(braket
id|chip_idx
)braket
dot
id|device_id_mask
)paren
op_eq
id|pci_tbl
(braket
id|chip_idx
)braket
dot
id|device_id
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
id|pci_tbl
(braket
id|chip_idx
)braket
dot
id|vendor_id
op_eq
l_int|0
)paren
(brace
multiline_comment|/* Compiled out! */
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;Unable to match chip type %4.4x %4.4x in &quot;
l_string|&quot;vortex_attach().&bslash;n&quot;
comma
id|vendor_id
comma
id|dev_id
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
id|dev
op_assign
id|vortex_probe1
c_func
(paren
id|bus
comma
id|devfn
comma
l_int|NULL
comma
id|io
comma
id|irq
comma
id|chip_idx
comma
id|MAX_UNITS
op_plus
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dev
)paren
(brace
id|dev_node_t
op_star
id|node
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
id|dev_node_t
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
id|strcpy
c_func
(paren
id|node-&gt;dev_name
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|node-&gt;major
op_assign
id|node-&gt;minor
op_assign
l_int|0
suffix:semicolon
id|node-&gt;next
op_assign
l_int|NULL
suffix:semicolon
id|MOD_INC_USE_COUNT
suffix:semicolon
r_return
id|node
suffix:semicolon
)brace
r_return
l_int|NULL
suffix:semicolon
)brace
DECL|function|vortex_detach
r_static
r_void
id|vortex_detach
c_func
(paren
id|dev_node_t
op_star
id|node
)paren
(brace
r_struct
id|device
op_star
op_star
id|devp
comma
op_star
op_star
id|next
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;vortex_detach(%s)&bslash;n&quot;
comma
id|node-&gt;dev_name
)paren
suffix:semicolon
r_for
c_loop
(paren
id|devp
op_assign
op_amp
id|root_vortex_dev
suffix:semicolon
op_star
id|devp
suffix:semicolon
id|devp
op_assign
id|next
)paren
(brace
id|next
op_assign
op_amp
(paren
(paren
r_struct
id|vortex_private
op_star
)paren
(paren
op_star
id|devp
)paren
op_member_access_from_pointer
id|priv
)paren
op_member_access_from_pointer
id|next_module
suffix:semicolon
r_if
c_cond
(paren
id|strcmp
c_func
(paren
(paren
op_star
id|devp
)paren
op_member_access_from_pointer
id|name
comma
id|node-&gt;dev_name
)paren
op_eq
l_int|0
)paren
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
op_star
id|devp
)paren
(brace
r_struct
id|device
op_star
id|dev
op_assign
op_star
id|devp
suffix:semicolon
r_struct
id|vortex_private
op_star
id|vp
op_assign
id|dev-&gt;priv
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;flags
op_amp
id|IFF_UP
)paren
id|vortex_close
c_func
(paren
id|dev
)paren
suffix:semicolon
id|dev-&gt;flags
op_and_assign
op_complement
(paren
id|IFF_UP
op_or
id|IFF_RUNNING
)paren
suffix:semicolon
id|unregister_netdev
c_func
(paren
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|vp-&gt;cb_fn_base
)paren
id|iounmap
c_func
(paren
id|vp-&gt;cb_fn_base
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|dev
)paren
suffix:semicolon
op_star
id|devp
op_assign
op_star
id|next
suffix:semicolon
id|kfree
c_func
(paren
id|vp
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|node
)paren
suffix:semicolon
id|MOD_DEC_USE_COUNT
suffix:semicolon
)brace
)brace
DECL|variable|vortex_ops
r_struct
id|driver_operations
id|vortex_ops
op_assign
(brace
l_string|&quot;3c575_cb&quot;
comma
id|vortex_attach
comma
l_int|NULL
comma
l_int|NULL
comma
id|vortex_detach
)brace
suffix:semicolon
macro_line|#endif  /* Cardbus support */
DECL|function|init_module
r_int
id|init_module
c_func
(paren
r_void
)paren
(brace
r_if
c_cond
(paren
id|vortex_debug
)paren
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s&quot;
comma
id|version
)paren
suffix:semicolon
macro_line|#ifdef CARDBUS
id|register_driver
c_func
(paren
op_amp
id|vortex_ops
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
macro_line|#else
r_return
id|vortex_scan
c_func
(paren
l_int|0
comma
id|pci_tbl
)paren
suffix:semicolon
macro_line|#endif
)brace
macro_line|#else
DECL|function|tc59x_probe
r_int
id|tc59x_probe
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
r_static
r_int
id|scanned
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|scanned
op_increment
)paren
(brace
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s&quot;
comma
id|version
)paren
suffix:semicolon
r_return
id|vortex_scan
c_func
(paren
id|dev
comma
id|pci_tbl
)paren
suffix:semicolon
)brace
macro_line|#endif  /* not MODULE */
macro_line|#ifndef CARDBUS
DECL|function|vortex_scan
r_static
r_int
id|vortex_scan
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
r_struct
id|pci_id_info
id|pci_tbl
(braket
)braket
)paren
(brace
r_int
id|cards_found
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Allow an EISA-only driver. */
macro_line|#if defined(CONFIG_PCI) || (defined(MODULE) &amp;&amp; !defined(NO_PCI))
multiline_comment|/* Ideally we would detect all cards in slot order.  That would&n;&t;   be best done a central PCI probe dispatch, which wouldn&squot;t work&n;&t;   well with the current structure.  So instead we detect 3Com cards&n;&t;   in slot order. */
r_if
c_cond
(paren
id|pcibios_present
c_func
(paren
)paren
)paren
(brace
r_static
r_int
id|pci_index
op_assign
l_int|0
suffix:semicolon
r_int
r_char
id|pci_bus
comma
id|pci_device_fn
suffix:semicolon
r_for
c_loop
(paren
suffix:semicolon
id|pci_index
OL
l_int|0xff
suffix:semicolon
id|pci_index
op_increment
)paren
(brace
id|u16
id|vendor
comma
id|device
comma
id|pci_command
comma
id|new_command
comma
id|pwr_cmd
suffix:semicolon
r_int
id|chip_idx
comma
id|irq
suffix:semicolon
r_int
id|ioaddr
suffix:semicolon
r_if
c_cond
(paren
id|pcibios_find_class
(paren
id|PCI_CLASS_NETWORK_ETHERNET
op_lshift
l_int|8
comma
id|pci_index
comma
op_amp
id|pci_bus
comma
op_amp
id|pci_device_fn
)paren
op_ne
id|PCIBIOS_SUCCESSFUL
)paren
r_break
suffix:semicolon
id|pcibios_read_config_word
c_func
(paren
id|pci_bus
comma
id|pci_device_fn
comma
id|PCI_VENDOR_ID
comma
op_amp
id|vendor
)paren
suffix:semicolon
id|pcibios_read_config_word
c_func
(paren
id|pci_bus
comma
id|pci_device_fn
comma
id|PCI_DEVICE_ID
comma
op_amp
id|device
)paren
suffix:semicolon
r_for
c_loop
(paren
id|chip_idx
op_assign
l_int|0
suffix:semicolon
id|pci_tbl
(braket
id|chip_idx
)braket
dot
id|vendor_id
suffix:semicolon
id|chip_idx
op_increment
)paren
r_if
c_cond
(paren
id|vendor
op_eq
id|pci_tbl
(braket
id|chip_idx
)braket
dot
id|vendor_id
op_logical_and
(paren
id|device
op_amp
id|pci_tbl
(braket
id|chip_idx
)braket
dot
id|device_id_mask
)paren
op_eq
id|pci_tbl
(braket
id|chip_idx
)braket
dot
id|device_id
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
id|pci_tbl
(braket
id|chip_idx
)braket
dot
id|vendor_id
op_eq
l_int|0
)paren
multiline_comment|/* Compiled out! */
r_continue
suffix:semicolon
(brace
macro_line|#if LINUX_VERSION_CODE &gt;= 0x20155
r_struct
id|pci_dev
op_star
id|pdev
op_assign
id|pci_find_slot
c_func
(paren
id|pci_bus
comma
id|pci_device_fn
)paren
suffix:semicolon
id|ioaddr
op_assign
id|pdev-&gt;base_address
(braket
l_int|0
)braket
op_amp
op_complement
l_int|3
suffix:semicolon
id|irq
op_assign
id|pdev-&gt;irq
suffix:semicolon
macro_line|#else
id|u32
id|pci_ioaddr
suffix:semicolon
id|u8
id|pci_irq_line
suffix:semicolon
id|pcibios_read_config_byte
c_func
(paren
id|pci_bus
comma
id|pci_device_fn
comma
id|PCI_INTERRUPT_LINE
comma
op_amp
id|pci_irq_line
)paren
suffix:semicolon
id|pcibios_read_config_dword
c_func
(paren
id|pci_bus
comma
id|pci_device_fn
comma
id|PCI_BASE_ADDRESS_0
comma
op_amp
id|pci_ioaddr
)paren
suffix:semicolon
id|ioaddr
op_assign
id|pci_ioaddr
op_amp
op_complement
l_int|3
suffix:semicolon
suffix:semicolon
id|irq
op_assign
id|pci_irq_line
suffix:semicolon
macro_line|#endif
)brace
multiline_comment|/* Power-up the card. */
id|pcibios_read_config_word
c_func
(paren
id|pci_bus
comma
id|pci_device_fn
comma
l_int|0xe0
comma
op_amp
id|pwr_cmd
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pwr_cmd
op_amp
l_int|0x3
)paren
(brace
multiline_comment|/* Save the ioaddr and IRQ info! */
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;  A 3Com network adapter is powered down!&quot;
l_string|&quot;  Setting the power state %4.4x-&gt;%4.4x.&bslash;n&quot;
comma
id|pwr_cmd
comma
id|pwr_cmd
op_amp
op_complement
l_int|3
)paren
suffix:semicolon
id|pcibios_write_config_word
c_func
(paren
id|pci_bus
comma
id|pci_device_fn
comma
l_int|0xe0
comma
id|pwr_cmd
op_amp
op_complement
l_int|3
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;  Setting the IRQ to %d, IOADDR to %#lx.&bslash;n&quot;
comma
id|irq
comma
id|ioaddr
)paren
suffix:semicolon
id|pcibios_write_config_byte
c_func
(paren
id|pci_bus
comma
id|pci_device_fn
comma
id|PCI_INTERRUPT_LINE
comma
id|irq
)paren
suffix:semicolon
id|pcibios_write_config_dword
c_func
(paren
id|pci_bus
comma
id|pci_device_fn
comma
id|PCI_BASE_ADDRESS_0
comma
id|ioaddr
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ioaddr
op_eq
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;  A 3Com network adapter has been found, &quot;
l_string|&quot;however it has not been assigned an I/O address.&bslash;n&quot;
l_string|&quot;  You may need to power-cycle the machine for this &quot;
l_string|&quot;device to work!&bslash;n&quot;
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
r_if
c_cond
(paren
id|check_region
c_func
(paren
id|ioaddr
comma
id|pci_tbl
(braket
id|chip_idx
)braket
dot
id|io_size
)paren
)paren
r_continue
suffix:semicolon
multiline_comment|/* Activate the card. */
id|pcibios_read_config_word
c_func
(paren
id|pci_bus
comma
id|pci_device_fn
comma
id|PCI_COMMAND
comma
op_amp
id|pci_command
)paren
suffix:semicolon
id|new_command
op_assign
id|pci_command
op_or
id|PCI_COMMAND_MASTER
op_or
id|PCI_COMMAND_IO
suffix:semicolon
r_if
c_cond
(paren
id|pci_command
op_ne
id|new_command
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;  The PCI BIOS has not enabled the device &quot;
l_string|&quot;at %d/%d. Updating PCI command %4.4x-&gt;%4.4x.&bslash;n&quot;
comma
id|pci_bus
comma
id|pci_device_fn
comma
id|pci_command
comma
id|new_command
)paren
suffix:semicolon
id|pcibios_write_config_word
c_func
(paren
id|pci_bus
comma
id|pci_device_fn
comma
id|PCI_COMMAND
comma
id|new_command
)paren
suffix:semicolon
)brace
id|dev
op_assign
id|vortex_probe1
c_func
(paren
id|pci_bus
comma
id|pci_device_fn
comma
id|dev
comma
id|ioaddr
comma
id|irq
comma
id|chip_idx
comma
id|cards_found
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dev
)paren
(brace
multiline_comment|/* Get and check the latency values.  On the 3c590 series&n;&t;&t;&t;&t;   the latency timer must be set to the maximum value to avoid&n;&t;&t;&t;&t;   data corruption that occurs when the timer expires during&n;&t;&t;&t;&t;   a transfer -- a bug in the Vortex chip only. */
id|u8
id|pci_latency
suffix:semicolon
id|u8
id|new_latency
op_assign
(paren
id|device
op_amp
l_int|0xff00
)paren
op_eq
l_int|0x5900
ques
c_cond
l_int|248
suffix:colon
l_int|32
suffix:semicolon
id|pcibios_read_config_byte
c_func
(paren
id|pci_bus
comma
id|pci_device_fn
comma
id|PCI_LATENCY_TIMER
comma
op_amp
id|pci_latency
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pci_latency
OL
id|new_latency
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Overriding PCI latency&quot;
l_string|&quot; timer (CFLT) setting of %d, new value is %d.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|pci_latency
comma
id|new_latency
)paren
suffix:semicolon
id|pcibios_write_config_byte
c_func
(paren
id|pci_bus
comma
id|pci_device_fn
comma
id|PCI_LATENCY_TIMER
comma
id|new_latency
)paren
suffix:semicolon
)brace
id|dev
op_assign
l_int|0
suffix:semicolon
id|cards_found
op_increment
suffix:semicolon
)brace
)brace
)brace
macro_line|#endif /* NO_PCI */
multiline_comment|/* Now check all slots of the EISA bus. */
r_if
c_cond
(paren
id|EISA_bus
)paren
(brace
r_static
r_int
id|ioaddr
op_assign
l_int|0x1000
suffix:semicolon
r_for
c_loop
(paren
suffix:semicolon
id|ioaddr
OL
l_int|0x9000
suffix:semicolon
id|ioaddr
op_add_assign
l_int|0x1000
)paren
(brace
r_int
id|device_id
suffix:semicolon
r_if
c_cond
(paren
id|check_region
c_func
(paren
id|ioaddr
comma
id|VORTEX_TOTAL_SIZE
)paren
)paren
r_continue
suffix:semicolon
multiline_comment|/* Check the standard EISA ID register for an encoded &squot;3Com&squot;. */
r_if
c_cond
(paren
id|inw
c_func
(paren
id|ioaddr
op_plus
l_int|0xC80
)paren
op_ne
l_int|0x6d50
)paren
r_continue
suffix:semicolon
multiline_comment|/* Check for a product that we support, 3c59{2,7} any rev. */
id|device_id
op_assign
(paren
id|inb
c_func
(paren
id|ioaddr
op_plus
l_int|0xC82
)paren
op_lshift
l_int|8
)paren
op_plus
id|inb
c_func
(paren
id|ioaddr
op_plus
l_int|0xC83
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|device_id
op_amp
l_int|0xFF00
)paren
op_ne
l_int|0x5900
)paren
r_continue
suffix:semicolon
id|vortex_probe1
c_func
(paren
l_int|0
comma
l_int|0
comma
id|dev
comma
id|ioaddr
comma
id|inw
c_func
(paren
id|ioaddr
op_plus
l_int|0xC88
)paren
op_rshift
l_int|12
comma
l_int|4
comma
id|cards_found
)paren
suffix:semicolon
id|dev
op_assign
l_int|0
suffix:semicolon
id|cards_found
op_increment
suffix:semicolon
)brace
)brace
macro_line|#ifdef MODULE
multiline_comment|/* Special code to work-around the Compaq PCI BIOS32 problem. */
r_if
c_cond
(paren
id|compaq_ioaddr
)paren
(brace
id|vortex_probe1
c_func
(paren
l_int|0
comma
l_int|0
comma
id|dev
comma
id|compaq_ioaddr
comma
id|compaq_irq
comma
id|compaq_device_id
comma
id|cards_found
op_increment
)paren
suffix:semicolon
id|dev
op_assign
l_int|0
suffix:semicolon
)brace
macro_line|#endif
r_return
id|cards_found
ques
c_cond
l_int|0
suffix:colon
op_minus
id|ENODEV
suffix:semicolon
)brace
macro_line|#endif  /* ! Cardbus */
DECL|function|vortex_probe1
r_static
r_struct
id|device
op_star
id|vortex_probe1
c_func
(paren
r_int
id|pci_bus
comma
r_int
id|pci_devfn
comma
r_struct
id|device
op_star
id|dev
comma
r_int
id|ioaddr
comma
r_int
id|irq
comma
r_int
id|chip_idx
comma
r_int
id|card_idx
)paren
(brace
r_struct
id|vortex_private
op_star
id|vp
suffix:semicolon
r_int
id|option
suffix:semicolon
r_int
r_int
id|eeprom
(braket
l_int|0x40
)braket
comma
id|checksum
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* EEPROM contents */
r_int
id|i
suffix:semicolon
id|dev
op_assign
id|init_etherdev
c_func
(paren
id|dev
comma
l_int|0
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: 3Com %s at 0x%lx, &quot;
comma
id|dev-&gt;name
comma
id|pci_tbl
(braket
id|chip_idx
)braket
dot
id|name
comma
id|ioaddr
)paren
suffix:semicolon
id|dev-&gt;base_addr
op_assign
id|ioaddr
suffix:semicolon
id|dev-&gt;irq
op_assign
id|irq
suffix:semicolon
id|dev-&gt;mtu
op_assign
id|mtu
suffix:semicolon
multiline_comment|/* Make certain the descriptor lists are aligned. */
(brace
r_void
op_star
id|mem
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
op_star
id|vp
)paren
op_plus
l_int|15
comma
id|GFP_KERNEL
)paren
suffix:semicolon
id|vp
op_assign
(paren
r_void
op_star
)paren
(paren
(paren
(paren
r_int
)paren
id|mem
op_plus
l_int|15
)paren
op_amp
op_complement
l_int|15
)paren
suffix:semicolon
id|vp-&gt;priv_addr
op_assign
id|mem
suffix:semicolon
)brace
id|memset
c_func
(paren
id|vp
comma
l_int|0
comma
r_sizeof
(paren
op_star
id|vp
)paren
)paren
suffix:semicolon
id|dev-&gt;priv
op_assign
id|vp
suffix:semicolon
id|vp-&gt;next_module
op_assign
id|root_vortex_dev
suffix:semicolon
id|root_vortex_dev
op_assign
id|dev
suffix:semicolon
id|vp-&gt;chip_id
op_assign
id|chip_idx
suffix:semicolon
id|vp-&gt;pci_bus
op_assign
id|pci_bus
suffix:semicolon
id|vp-&gt;pci_devfn
op_assign
id|pci_devfn
suffix:semicolon
multiline_comment|/* The lower four bits are the media type. */
r_if
c_cond
(paren
id|dev-&gt;mem_start
)paren
id|option
op_assign
id|dev-&gt;mem_start
suffix:semicolon
r_else
r_if
c_cond
(paren
id|card_idx
OL
id|MAX_UNITS
)paren
id|option
op_assign
id|options
(braket
id|card_idx
)braket
suffix:semicolon
r_else
id|option
op_assign
op_minus
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|option
op_ge
l_int|0
)paren
(brace
id|vp-&gt;media_override
op_assign
(paren
(paren
id|option
op_amp
l_int|7
)paren
op_eq
l_int|2
)paren
ques
c_cond
l_int|0
suffix:colon
id|option
op_amp
l_int|7
suffix:semicolon
id|vp-&gt;full_duplex
op_assign
(paren
id|option
op_amp
l_int|8
)paren
ques
c_cond
l_int|1
suffix:colon
l_int|0
suffix:semicolon
id|vp-&gt;bus_master
op_assign
(paren
id|option
op_amp
l_int|16
)paren
ques
c_cond
l_int|1
suffix:colon
l_int|0
suffix:semicolon
)brace
r_else
(brace
id|vp-&gt;media_override
op_assign
l_int|7
suffix:semicolon
id|vp-&gt;full_duplex
op_assign
l_int|0
suffix:semicolon
id|vp-&gt;bus_master
op_assign
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|card_idx
template_param
l_int|0
)paren
id|vp-&gt;full_duplex
op_assign
l_int|1
suffix:semicolon
id|vp-&gt;force_fd
op_assign
id|vp-&gt;full_duplex
suffix:semicolon
id|vp-&gt;options
op_assign
id|option
suffix:semicolon
multiline_comment|/* Read the station address from the EEPROM. */
id|EL3WINDOW
c_func
(paren
l_int|0
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|0x40
suffix:semicolon
id|i
op_increment
)paren
(brace
r_int
id|timer
suffix:semicolon
macro_line|#ifdef CARDBUS
id|outw
c_func
(paren
l_int|0x230
op_plus
id|i
comma
id|ioaddr
op_plus
id|Wn0EepromCmd
)paren
suffix:semicolon
macro_line|#else
id|outw
c_func
(paren
id|EEPROM_Read
op_plus
id|i
comma
id|ioaddr
op_plus
id|Wn0EepromCmd
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/* Pause for at least 162 us. for the read to take place. */
r_for
c_loop
(paren
id|timer
op_assign
l_int|10
suffix:semicolon
id|timer
op_ge
l_int|0
suffix:semicolon
id|timer
op_decrement
)paren
(brace
id|udelay
c_func
(paren
l_int|162
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|inw
c_func
(paren
id|ioaddr
op_plus
id|Wn0EepromCmd
)paren
op_amp
l_int|0x8000
)paren
op_eq
l_int|0
)paren
r_break
suffix:semicolon
)brace
id|eeprom
(braket
id|i
)braket
op_assign
id|inw
c_func
(paren
id|ioaddr
op_plus
id|Wn0EepromData
)paren
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|0x18
suffix:semicolon
id|i
op_increment
)paren
id|checksum
op_xor_assign
id|eeprom
(braket
id|i
)braket
suffix:semicolon
id|checksum
op_assign
(paren
id|checksum
op_xor
(paren
id|checksum
op_rshift
l_int|8
)paren
)paren
op_amp
l_int|0xff
suffix:semicolon
r_if
c_cond
(paren
id|checksum
op_ne
l_int|0x00
)paren
(brace
multiline_comment|/* Grrr, needless incompatible change 3Com. */
r_while
c_loop
(paren
id|i
OL
l_int|0x21
)paren
id|checksum
op_xor_assign
id|eeprom
(braket
id|i
op_increment
)braket
suffix:semicolon
id|checksum
op_assign
(paren
id|checksum
op_xor
(paren
id|checksum
op_rshift
l_int|8
)paren
)paren
op_amp
l_int|0xff
suffix:semicolon
)brace
r_if
c_cond
(paren
id|checksum
op_ne
l_int|0x00
)paren
id|printk
c_func
(paren
l_string|&quot; ***INVALID CHECKSUM %4.4x*** &quot;
comma
id|checksum
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|3
suffix:semicolon
id|i
op_increment
)paren
(paren
(paren
id|u16
op_star
)paren
id|dev-&gt;dev_addr
)paren
(braket
id|i
)braket
op_assign
id|htons
c_func
(paren
id|eeprom
(braket
id|i
op_plus
l_int|10
)braket
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|6
suffix:semicolon
id|i
op_increment
)paren
id|printk
c_func
(paren
l_string|&quot;%c%2.2x&quot;
comma
id|i
ques
c_cond
l_char|&squot;:&squot;
suffix:colon
l_char|&squot; &squot;
comma
id|dev-&gt;dev_addr
(braket
id|i
)braket
)paren
suffix:semicolon
macro_line|#ifdef __sparc__
id|printk
c_func
(paren
l_string|&quot;, IRQ %s&bslash;n&quot;
comma
id|__irq_itoa
c_func
(paren
id|dev-&gt;irq
)paren
)paren
suffix:semicolon
macro_line|#else
id|printk
c_func
(paren
l_string|&quot;, IRQ %d&bslash;n&quot;
comma
id|dev-&gt;irq
)paren
suffix:semicolon
multiline_comment|/* Tell them about an invalid IRQ. */
r_if
c_cond
(paren
id|vortex_debug
op_logical_and
(paren
id|dev-&gt;irq
op_le
l_int|0
op_logical_or
id|dev-&gt;irq
op_ge
id|NR_IRQS
)paren
)paren
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot; *** Warning: IRQ %d is unlikely to work! ***&bslash;n&quot;
comma
id|dev-&gt;irq
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|pci_tbl
(braket
id|vp-&gt;chip_id
)braket
dot
id|drv_flags
op_amp
id|HAS_CB_FNS
)paren
(brace
id|u32
id|fn_st_addr
suffix:semicolon
multiline_comment|/* Cardbus function status space */
id|pcibios_read_config_dword
c_func
(paren
id|pci_bus
comma
id|pci_devfn
comma
id|PCI_BASE_ADDRESS_2
comma
op_amp
id|fn_st_addr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|fn_st_addr
)paren
id|vp-&gt;cb_fn_base
op_assign
id|ioremap
c_func
(paren
id|fn_st_addr
op_amp
op_complement
l_int|3
comma
l_int|128
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;%s: CardBus functions mapped %8.8x-&gt;%p (PCMCIA committee&quot;
l_string|&quot; brain-damage).&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|fn_st_addr
comma
id|vp-&gt;cb_fn_base
)paren
suffix:semicolon
id|EL3WINDOW
c_func
(paren
l_int|2
)paren
suffix:semicolon
id|outw
c_func
(paren
l_int|0x10
op_or
id|inw
c_func
(paren
id|ioaddr
op_plus
id|Wn2_ResetOptions
)paren
comma
id|ioaddr
op_plus
id|Wn2_ResetOptions
)paren
suffix:semicolon
)brace
multiline_comment|/* Extract our information from the EEPROM data. */
id|vp-&gt;info1
op_assign
id|eeprom
(braket
l_int|13
)braket
suffix:semicolon
id|vp-&gt;info2
op_assign
id|eeprom
(braket
l_int|15
)braket
suffix:semicolon
id|vp-&gt;capabilities
op_assign
id|eeprom
(braket
l_int|16
)braket
suffix:semicolon
r_if
c_cond
(paren
id|vp-&gt;info1
op_amp
l_int|0x8000
)paren
id|vp-&gt;full_duplex
op_assign
l_int|1
suffix:semicolon
(brace
r_char
op_star
id|ram_split
(braket
)braket
op_assign
(brace
l_string|&quot;5:3&quot;
comma
l_string|&quot;3:1&quot;
comma
l_string|&quot;1:1&quot;
comma
l_string|&quot;3:5&quot;
)brace
suffix:semicolon
r_union
id|wn3_config
id|config
suffix:semicolon
id|EL3WINDOW
c_func
(paren
l_int|3
)paren
suffix:semicolon
id|vp-&gt;available_media
op_assign
id|inw
c_func
(paren
id|ioaddr
op_plus
id|Wn3_Options
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|vp-&gt;available_media
op_amp
l_int|0xff
)paren
op_eq
l_int|0
)paren
multiline_comment|/* Broken 3c916 */
id|vp-&gt;available_media
op_assign
l_int|0x40
suffix:semicolon
id|config.i
op_assign
id|inl
c_func
(paren
id|ioaddr
op_plus
id|Wn3_Config
)paren
suffix:semicolon
r_if
c_cond
(paren
id|vortex_debug
OG
l_int|1
)paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;  Internal config register is %4.4x, &quot;
l_string|&quot;transceivers %#x.&bslash;n&quot;
comma
id|config.i
comma
id|inw
c_func
(paren
id|ioaddr
op_plus
id|Wn3_Options
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;  %dK %s-wide RAM %s Rx:Tx split, %s%s interface.&bslash;n&quot;
comma
l_int|8
op_lshift
id|config.u.ram_size
comma
id|config.u.ram_width
ques
c_cond
l_string|&quot;word&quot;
suffix:colon
l_string|&quot;byte&quot;
comma
id|ram_split
(braket
id|config.u.ram_split
)braket
comma
id|config.u.autoselect
ques
c_cond
l_string|&quot;autoselect/&quot;
suffix:colon
l_string|&quot;&quot;
comma
id|config.u.xcvr
OG
id|XCVR_ExtMII
ques
c_cond
l_string|&quot;&lt;invalid transceiver&gt;&quot;
suffix:colon
id|media_tbl
(braket
id|config.u.xcvr
)braket
dot
id|name
)paren
suffix:semicolon
id|vp-&gt;default_media
op_assign
id|config.u.xcvr
suffix:semicolon
id|vp-&gt;autoselect
op_assign
id|config.u.autoselect
suffix:semicolon
)brace
r_if
c_cond
(paren
id|vp-&gt;media_override
op_ne
l_int|7
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;  Media override to transceiver type %d (%s).&bslash;n&quot;
comma
id|vp-&gt;media_override
comma
id|media_tbl
(braket
id|vp-&gt;media_override
)braket
dot
id|name
)paren
suffix:semicolon
id|dev-&gt;if_port
op_assign
id|vp-&gt;media_override
suffix:semicolon
)brace
r_else
id|dev-&gt;if_port
op_assign
id|vp-&gt;default_media
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;if_port
op_eq
id|XCVR_MII
op_logical_or
id|dev-&gt;if_port
op_eq
id|XCVR_NWAY
)paren
(brace
r_int
id|phy
comma
id|phy_idx
op_assign
l_int|0
suffix:semicolon
id|EL3WINDOW
c_func
(paren
l_int|4
)paren
suffix:semicolon
id|mii_preamble_required
op_increment
suffix:semicolon
id|mii_preamble_required
op_increment
suffix:semicolon
id|mdio_read
c_func
(paren
id|ioaddr
comma
l_int|24
comma
l_int|1
)paren
suffix:semicolon
r_for
c_loop
(paren
id|phy
op_assign
l_int|1
suffix:semicolon
id|phy
op_le
l_int|32
op_logical_and
id|phy_idx
OL
r_sizeof
(paren
id|vp-&gt;phys
)paren
suffix:semicolon
id|phy
op_increment
)paren
(brace
r_int
id|mii_status
comma
id|phyx
op_assign
id|phy
op_amp
l_int|0x1f
suffix:semicolon
id|mii_status
op_assign
id|mdio_read
c_func
(paren
id|ioaddr
comma
id|phyx
comma
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mii_status
op_logical_and
id|mii_status
op_ne
l_int|0xffff
)paren
(brace
id|vp-&gt;phys
(braket
id|phy_idx
op_increment
)braket
op_assign
id|phyx
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;  MII transceiver found at address %d,&quot;
l_string|&quot; status %4x.&bslash;n&quot;
comma
id|phyx
comma
id|mii_status
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|mii_status
op_amp
l_int|0x0040
)paren
op_eq
l_int|0
)paren
id|mii_preamble_required
op_increment
suffix:semicolon
)brace
)brace
id|mii_preamble_required
op_decrement
suffix:semicolon
r_if
c_cond
(paren
id|phy_idx
op_eq
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;  ***WARNING*** No MII transceivers found!&bslash;n&quot;
)paren
suffix:semicolon
id|vp-&gt;phys
(braket
l_int|0
)braket
op_assign
l_int|24
suffix:semicolon
)brace
r_else
(brace
id|vp-&gt;advertising
op_assign
id|mdio_read
c_func
(paren
id|ioaddr
comma
id|vp-&gt;phys
(braket
l_int|0
)braket
comma
l_int|4
)paren
suffix:semicolon
r_if
c_cond
(paren
id|vp-&gt;full_duplex
)paren
(brace
multiline_comment|/* Only advertise the FD media types. */
id|vp-&gt;advertising
op_and_assign
op_complement
l_int|0x02A0
suffix:semicolon
id|mdio_write
c_func
(paren
id|ioaddr
comma
id|vp-&gt;phys
(braket
l_int|0
)braket
comma
l_int|4
comma
id|vp-&gt;advertising
)paren
suffix:semicolon
)brace
)brace
)brace
r_if
c_cond
(paren
id|vp-&gt;capabilities
op_amp
id|CapBusMaster
)paren
(brace
id|vp-&gt;full_bus_master_tx
op_assign
l_int|1
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;  Enabling bus-master transmits and %s receives.&bslash;n&quot;
comma
(paren
id|vp-&gt;info2
op_amp
l_int|1
)paren
ques
c_cond
l_string|&quot;early&quot;
suffix:colon
l_string|&quot;whole-frame&quot;
)paren
suffix:semicolon
id|vp-&gt;full_bus_master_rx
op_assign
(paren
id|vp-&gt;info2
op_amp
l_int|1
)paren
ques
c_cond
l_int|1
suffix:colon
l_int|2
suffix:semicolon
)brace
multiline_comment|/* We do a request_region() to register /proc/ioports info. */
id|request_region
c_func
(paren
id|ioaddr
comma
id|pci_tbl
(braket
id|chip_idx
)braket
dot
id|io_size
comma
id|dev-&gt;name
)paren
suffix:semicolon
multiline_comment|/* The 3c59x-specific entries in the device structure. */
id|dev-&gt;open
op_assign
op_amp
id|vortex_open
suffix:semicolon
id|dev-&gt;hard_start_xmit
op_assign
op_amp
id|vortex_start_xmit
suffix:semicolon
id|dev-&gt;stop
op_assign
op_amp
id|vortex_close
suffix:semicolon
id|dev-&gt;get_stats
op_assign
op_amp
id|vortex_get_stats
suffix:semicolon
id|dev-&gt;do_ioctl
op_assign
op_amp
id|vortex_ioctl
suffix:semicolon
id|dev-&gt;set_multicast_list
op_assign
op_amp
id|set_rx_mode
suffix:semicolon
r_return
id|dev
suffix:semicolon
)brace
"&f;"
r_static
r_int
DECL|function|vortex_open
id|vortex_open
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
r_int
id|ioaddr
op_assign
id|dev-&gt;base_addr
suffix:semicolon
r_struct
id|vortex_private
op_star
id|vp
op_assign
(paren
r_struct
id|vortex_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_union
id|wn3_config
id|config
suffix:semicolon
r_int
id|i
suffix:semicolon
multiline_comment|/* Before initializing select the active media port. */
id|EL3WINDOW
c_func
(paren
l_int|3
)paren
suffix:semicolon
id|config.i
op_assign
id|inl
c_func
(paren
id|ioaddr
op_plus
id|Wn3_Config
)paren
suffix:semicolon
r_if
c_cond
(paren
id|vp-&gt;media_override
op_ne
l_int|7
)paren
(brace
r_if
c_cond
(paren
id|vortex_debug
OG
l_int|1
)paren
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Media override to transceiver %d (%s).&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|vp-&gt;media_override
comma
id|media_tbl
(braket
id|vp-&gt;media_override
)braket
dot
id|name
)paren
suffix:semicolon
id|dev-&gt;if_port
op_assign
id|vp-&gt;media_override
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|vp-&gt;autoselect
op_logical_and
id|pci_tbl
(braket
id|vp-&gt;chip_id
)braket
dot
id|drv_flags
op_amp
id|HAS_NWAY
)paren
(brace
id|dev-&gt;if_port
op_assign
id|XCVR_NWAY
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|vp-&gt;autoselect
)paren
(brace
multiline_comment|/* Find first available media type, starting with 100baseTx. */
id|dev-&gt;if_port
op_assign
id|XCVR_100baseTx
suffix:semicolon
r_while
c_loop
(paren
op_logical_neg
(paren
id|vp-&gt;available_media
op_amp
id|media_tbl
(braket
id|dev-&gt;if_port
)braket
dot
id|mask
)paren
)paren
id|dev-&gt;if_port
op_assign
id|media_tbl
(braket
id|dev-&gt;if_port
)braket
dot
id|next
suffix:semicolon
)brace
r_else
id|dev-&gt;if_port
op_assign
id|vp-&gt;default_media
suffix:semicolon
id|init_timer
c_func
(paren
op_amp
id|vp-&gt;timer
)paren
suffix:semicolon
id|vp-&gt;timer.expires
op_assign
id|RUN_AT
c_func
(paren
id|media_tbl
(braket
id|dev-&gt;if_port
)braket
dot
id|wait
)paren
suffix:semicolon
id|vp-&gt;timer.data
op_assign
(paren
r_int
r_int
)paren
id|dev
suffix:semicolon
id|vp-&gt;timer.function
op_assign
op_amp
id|vortex_timer
suffix:semicolon
multiline_comment|/* timer handler */
id|add_timer
c_func
(paren
op_amp
id|vp-&gt;timer
)paren
suffix:semicolon
r_if
c_cond
(paren
id|vortex_debug
OG
l_int|1
)paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%s: Initial media type %s.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|media_tbl
(braket
id|dev-&gt;if_port
)braket
dot
id|name
)paren
suffix:semicolon
id|vp-&gt;full_duplex
op_assign
id|vp-&gt;force_fd
suffix:semicolon
id|config.u.xcvr
op_assign
id|dev-&gt;if_port
suffix:semicolon
id|outl
c_func
(paren
id|config.i
comma
id|ioaddr
op_plus
id|Wn3_Config
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;if_port
op_eq
id|XCVR_MII
op_logical_or
id|dev-&gt;if_port
op_eq
id|XCVR_NWAY
)paren
(brace
r_int
id|mii_reg1
comma
id|mii_reg5
suffix:semicolon
id|EL3WINDOW
c_func
(paren
l_int|4
)paren
suffix:semicolon
multiline_comment|/* Read BMSR (reg1) only to clear old status. */
id|mii_reg1
op_assign
id|mdio_read
c_func
(paren
id|ioaddr
comma
id|vp-&gt;phys
(braket
l_int|0
)braket
comma
l_int|1
)paren
suffix:semicolon
id|mii_reg5
op_assign
id|mdio_read
c_func
(paren
id|ioaddr
comma
id|vp-&gt;phys
(braket
l_int|0
)braket
comma
l_int|5
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mii_reg5
op_eq
l_int|0xffff
op_logical_or
id|mii_reg5
op_eq
l_int|0x0000
)paren
suffix:semicolon
multiline_comment|/* No MII device or no link partner report */
r_else
r_if
c_cond
(paren
(paren
id|mii_reg5
op_amp
l_int|0x0100
)paren
op_ne
l_int|0
multiline_comment|/* 100baseTx-FD */
op_logical_or
(paren
id|mii_reg5
op_amp
l_int|0x00C0
)paren
op_eq
l_int|0x0040
)paren
multiline_comment|/* 10T-FD, but not 100-HD */
id|vp-&gt;full_duplex
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|vortex_debug
OG
l_int|1
)paren
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: MII #%d status %4.4x, link partner capability %4.4x,&quot;
l_string|&quot; setting %s-duplex.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|vp-&gt;phys
(braket
l_int|0
)braket
comma
id|mii_reg1
comma
id|mii_reg5
comma
id|vp-&gt;full_duplex
ques
c_cond
l_string|&quot;full&quot;
suffix:colon
l_string|&quot;half&quot;
)paren
suffix:semicolon
id|EL3WINDOW
c_func
(paren
l_int|3
)paren
suffix:semicolon
)brace
multiline_comment|/* Set the full-duplex bit. */
id|outb
c_func
(paren
(paren
(paren
id|vp-&gt;info1
op_amp
l_int|0x8000
)paren
op_logical_or
id|vp-&gt;full_duplex
ques
c_cond
l_int|0x20
suffix:colon
l_int|0
)paren
op_or
(paren
id|dev-&gt;mtu
OG
l_int|1500
ques
c_cond
l_int|0x40
suffix:colon
l_int|0
)paren
comma
id|ioaddr
op_plus
id|Wn3_MAC_Ctrl
)paren
suffix:semicolon
r_if
c_cond
(paren
id|vortex_debug
OG
l_int|1
)paren
(brace
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%s: vortex_open() InternalConfig %8.8x.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|config.i
)paren
suffix:semicolon
)brace
id|outw
c_func
(paren
id|TxReset
comma
id|ioaddr
op_plus
id|EL3_CMD
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|2000
suffix:semicolon
id|i
op_ge
l_int|0
suffix:semicolon
id|i
op_decrement
)paren
r_if
c_cond
(paren
op_logical_neg
(paren
id|inw
c_func
(paren
id|ioaddr
op_plus
id|EL3_STATUS
)paren
op_amp
id|CmdInProgress
)paren
)paren
r_break
suffix:semicolon
id|outw
c_func
(paren
id|RxReset
comma
id|ioaddr
op_plus
id|EL3_CMD
)paren
suffix:semicolon
multiline_comment|/* Wait a few ticks for the RxReset command to complete. */
r_for
c_loop
(paren
id|i
op_assign
l_int|2000
suffix:semicolon
id|i
op_ge
l_int|0
suffix:semicolon
id|i
op_decrement
)paren
r_if
c_cond
(paren
op_logical_neg
(paren
id|inw
c_func
(paren
id|ioaddr
op_plus
id|EL3_STATUS
)paren
op_amp
id|CmdInProgress
)paren
)paren
r_break
suffix:semicolon
id|outw
c_func
(paren
id|SetStatusEnb
op_or
l_int|0x00
comma
id|ioaddr
op_plus
id|EL3_CMD
)paren
suffix:semicolon
multiline_comment|/* Use the now-standard shared IRQ implementation. */
r_if
c_cond
(paren
id|request_irq
c_func
(paren
id|dev-&gt;irq
comma
op_amp
id|vortex_interrupt
comma
id|SA_SHIRQ
comma
id|dev-&gt;name
comma
id|dev
)paren
)paren
(brace
r_return
op_minus
id|EAGAIN
suffix:semicolon
)brace
r_if
c_cond
(paren
id|vortex_debug
OG
l_int|1
)paren
(brace
id|EL3WINDOW
c_func
(paren
l_int|4
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%s: vortex_open() irq %d media status %4.4x.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|dev-&gt;irq
comma
id|inw
c_func
(paren
id|ioaddr
op_plus
id|Wn4_Media
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/* Set the station address and mask in window 2 each time opened. */
id|EL3WINDOW
c_func
(paren
l_int|2
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|6
suffix:semicolon
id|i
op_increment
)paren
id|outb
c_func
(paren
id|dev-&gt;dev_addr
(braket
id|i
)braket
comma
id|ioaddr
op_plus
id|i
)paren
suffix:semicolon
r_for
c_loop
(paren
suffix:semicolon
id|i
OL
l_int|12
suffix:semicolon
id|i
op_add_assign
l_int|2
)paren
id|outw
c_func
(paren
l_int|0
comma
id|ioaddr
op_plus
id|i
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;if_port
op_eq
id|XCVR_10base2
)paren
multiline_comment|/* Start the thinnet transceiver. We should really wait 50ms...*/
id|outw
c_func
(paren
id|StartCoax
comma
id|ioaddr
op_plus
id|EL3_CMD
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;if_port
op_ne
id|XCVR_NWAY
)paren
(brace
id|EL3WINDOW
c_func
(paren
l_int|4
)paren
suffix:semicolon
id|outw
c_func
(paren
(paren
id|inw
c_func
(paren
id|ioaddr
op_plus
id|Wn4_Media
)paren
op_amp
op_complement
(paren
id|Media_10TP
op_or
id|Media_SQE
)paren
)paren
op_or
id|media_tbl
(braket
id|dev-&gt;if_port
)braket
dot
id|media_bits
comma
id|ioaddr
op_plus
id|Wn4_Media
)paren
suffix:semicolon
)brace
multiline_comment|/* Switch to the stats window, and clear all stats by reading. */
id|outw
c_func
(paren
id|StatsDisable
comma
id|ioaddr
op_plus
id|EL3_CMD
)paren
suffix:semicolon
id|EL3WINDOW
c_func
(paren
l_int|6
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|10
suffix:semicolon
id|i
op_increment
)paren
id|inb
c_func
(paren
id|ioaddr
op_plus
id|i
)paren
suffix:semicolon
id|inw
c_func
(paren
id|ioaddr
op_plus
l_int|10
)paren
suffix:semicolon
id|inw
c_func
(paren
id|ioaddr
op_plus
l_int|12
)paren
suffix:semicolon
multiline_comment|/* New: On the Vortex we must also clear the BadSSD counter. */
id|EL3WINDOW
c_func
(paren
l_int|4
)paren
suffix:semicolon
id|inb
c_func
(paren
id|ioaddr
op_plus
l_int|12
)paren
suffix:semicolon
multiline_comment|/* ..and on the Boomerang we enable the extra statistics bits. */
id|outw
c_func
(paren
l_int|0x0040
comma
id|ioaddr
op_plus
id|Wn4_NetDiag
)paren
suffix:semicolon
multiline_comment|/* Switch to register set 7 for normal use. */
id|EL3WINDOW
c_func
(paren
l_int|7
)paren
suffix:semicolon
r_if
c_cond
(paren
id|vp-&gt;full_bus_master_rx
)paren
(brace
multiline_comment|/* Boomerang bus master. */
id|vp-&gt;cur_rx
op_assign
id|vp-&gt;dirty_rx
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Initialize the RxEarly register as recommended. */
id|outw
c_func
(paren
id|SetRxThreshold
op_plus
(paren
l_int|1536
op_rshift
l_int|2
)paren
comma
id|ioaddr
op_plus
id|EL3_CMD
)paren
suffix:semicolon
id|outl
c_func
(paren
l_int|0x0020
comma
id|ioaddr
op_plus
id|PktStatus
)paren
suffix:semicolon
r_if
c_cond
(paren
id|vortex_debug
OG
l_int|2
)paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%s:  Filling in the Rx ring.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|RX_RING_SIZE
suffix:semicolon
id|i
op_increment
)paren
(brace
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
id|vp-&gt;rx_ring
(braket
id|i
)braket
dot
id|next
op_assign
id|cpu_to_le32
c_func
(paren
id|virt_to_bus
c_func
(paren
op_amp
id|vp-&gt;rx_ring
(braket
id|i
op_plus
l_int|1
)braket
)paren
)paren
suffix:semicolon
id|vp-&gt;rx_ring
(braket
id|i
)braket
dot
id|status
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Clear complete bit. */
id|vp-&gt;rx_ring
(braket
id|i
)braket
dot
id|length
op_assign
id|cpu_to_le32
c_func
(paren
id|PKT_BUF_SZ
op_or
id|LAST_FRAG
)paren
suffix:semicolon
id|skb
op_assign
id|dev_alloc_skb
c_func
(paren
id|PKT_BUF_SZ
)paren
suffix:semicolon
id|vp-&gt;rx_skbuff
(braket
id|i
)braket
op_assign
id|skb
suffix:semicolon
r_if
c_cond
(paren
id|skb
op_eq
l_int|NULL
)paren
r_break
suffix:semicolon
multiline_comment|/* Bad news!  */
id|skb-&gt;dev
op_assign
id|dev
suffix:semicolon
multiline_comment|/* Mark as being used by this device. */
macro_line|#if LINUX_VERSION_CODE &gt;= 0x10300
id|skb_reserve
c_func
(paren
id|skb
comma
l_int|2
)paren
suffix:semicolon
multiline_comment|/* Align IP on 16 byte boundaries */
id|vp-&gt;rx_ring
(braket
id|i
)braket
dot
id|addr
op_assign
id|cpu_to_le32
c_func
(paren
id|virt_to_bus
c_func
(paren
id|skb-&gt;tail
)paren
)paren
suffix:semicolon
macro_line|#else
id|vp-&gt;rx_ring
(braket
id|i
)braket
dot
id|addr
op_assign
id|virt_to_bus
c_func
(paren
id|skb-&gt;data
)paren
suffix:semicolon
macro_line|#endif
)brace
multiline_comment|/* Wrap the ring. */
id|vp-&gt;rx_ring
(braket
id|i
op_minus
l_int|1
)braket
dot
id|next
op_assign
id|cpu_to_le32
c_func
(paren
id|virt_to_bus
c_func
(paren
op_amp
id|vp-&gt;rx_ring
(braket
l_int|0
)braket
)paren
)paren
suffix:semicolon
id|outl
c_func
(paren
id|virt_to_bus
c_func
(paren
op_amp
id|vp-&gt;rx_ring
(braket
l_int|0
)braket
)paren
comma
id|ioaddr
op_plus
id|UpListPtr
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|vp-&gt;full_bus_master_tx
)paren
(brace
multiline_comment|/* Boomerang bus master Tx. */
id|dev-&gt;hard_start_xmit
op_assign
op_amp
id|boomerang_start_xmit
suffix:semicolon
id|vp-&gt;cur_tx
op_assign
id|vp-&gt;dirty_tx
op_assign
l_int|0
suffix:semicolon
id|outb
c_func
(paren
id|PKT_BUF_SZ
op_rshift
l_int|8
comma
id|ioaddr
op_plus
id|TxFreeThreshold
)paren
suffix:semicolon
multiline_comment|/* Room for a packet. */
multiline_comment|/* Clear the Tx ring. */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|TX_RING_SIZE
suffix:semicolon
id|i
op_increment
)paren
id|vp-&gt;tx_skbuff
(braket
id|i
)braket
op_assign
l_int|0
suffix:semicolon
id|outl
c_func
(paren
l_int|0
comma
id|ioaddr
op_plus
id|DownListPtr
)paren
suffix:semicolon
)brace
multiline_comment|/* Set reciever mode: presumably accept b-case and phys addr only. */
id|set_rx_mode
c_func
(paren
id|dev
)paren
suffix:semicolon
id|outw
c_func
(paren
id|StatsEnable
comma
id|ioaddr
op_plus
id|EL3_CMD
)paren
suffix:semicolon
multiline_comment|/* Turn on statistics. */
id|vp-&gt;in_interrupt
op_assign
l_int|0
suffix:semicolon
id|dev-&gt;tbusy
op_assign
l_int|0
suffix:semicolon
id|dev-&gt;interrupt
op_assign
l_int|0
suffix:semicolon
id|dev-&gt;start
op_assign
l_int|1
suffix:semicolon
id|outw
c_func
(paren
id|RxEnable
comma
id|ioaddr
op_plus
id|EL3_CMD
)paren
suffix:semicolon
multiline_comment|/* Enable the receiver. */
id|outw
c_func
(paren
id|TxEnable
comma
id|ioaddr
op_plus
id|EL3_CMD
)paren
suffix:semicolon
multiline_comment|/* Enable transmitter. */
multiline_comment|/* Allow status bits to be seen. */
id|vp-&gt;status_enable
op_assign
id|SetStatusEnb
op_or
id|HostError
op_or
id|IntReq
op_or
id|StatsFull
op_or
id|TxComplete
op_or
(paren
id|vp-&gt;full_bus_master_tx
ques
c_cond
id|DownComplete
suffix:colon
id|TxAvailable
)paren
op_or
(paren
id|vp-&gt;full_bus_master_rx
ques
c_cond
id|UpComplete
suffix:colon
id|RxComplete
)paren
op_or
(paren
id|vp-&gt;bus_master
ques
c_cond
id|DMADone
suffix:colon
l_int|0
)paren
suffix:semicolon
id|vp-&gt;intr_enable
op_assign
id|SetIntrEnb
op_or
id|IntLatch
op_or
id|TxAvailable
op_or
id|RxComplete
op_or
id|StatsFull
op_or
id|HostError
op_or
id|TxComplete
op_or
id|IntReq
op_or
(paren
id|vp-&gt;bus_master
ques
c_cond
id|DMADone
suffix:colon
l_int|0
)paren
op_or
id|UpComplete
op_or
id|DownComplete
suffix:semicolon
id|outw
c_func
(paren
id|vp-&gt;status_enable
comma
id|ioaddr
op_plus
id|EL3_CMD
)paren
suffix:semicolon
multiline_comment|/* Ack all pending events, and set active indicator mask. */
id|outw
c_func
(paren
id|AckIntr
op_or
id|IntLatch
op_or
id|TxAvailable
op_or
id|RxEarly
op_or
id|IntReq
comma
id|ioaddr
op_plus
id|EL3_CMD
)paren
suffix:semicolon
id|outw
c_func
(paren
id|vp-&gt;intr_enable
comma
id|ioaddr
op_plus
id|EL3_CMD
)paren
suffix:semicolon
r_if
c_cond
(paren
id|vp-&gt;cb_fn_base
)paren
multiline_comment|/* The PCMCIA people are idiots.  */
id|writel
c_func
(paren
l_int|0x8000
comma
id|vp-&gt;cb_fn_base
op_plus
l_int|4
)paren
suffix:semicolon
id|MOD_INC_USE_COUNT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|vortex_timer
r_static
r_void
id|vortex_timer
c_func
(paren
r_int
r_int
id|data
)paren
(brace
r_struct
id|device
op_star
id|dev
op_assign
(paren
r_struct
id|device
op_star
)paren
id|data
suffix:semicolon
r_struct
id|vortex_private
op_star
id|vp
op_assign
(paren
r_struct
id|vortex_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_int
id|ioaddr
op_assign
id|dev-&gt;base_addr
suffix:semicolon
r_int
id|next_tick
op_assign
l_int|0
suffix:semicolon
r_int
id|ok
op_assign
l_int|0
suffix:semicolon
r_int
id|media_status
comma
id|mii_status
comma
id|old_window
suffix:semicolon
r_if
c_cond
(paren
id|vortex_debug
OG
l_int|1
)paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%s: Media selection timer tick happened, %s.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|media_tbl
(braket
id|dev-&gt;if_port
)braket
dot
id|name
)paren
suffix:semicolon
id|disable_irq
c_func
(paren
id|dev-&gt;irq
)paren
suffix:semicolon
id|old_window
op_assign
id|inw
c_func
(paren
id|ioaddr
op_plus
id|EL3_CMD
)paren
op_rshift
l_int|13
suffix:semicolon
id|EL3WINDOW
c_func
(paren
l_int|4
)paren
suffix:semicolon
id|media_status
op_assign
id|inw
c_func
(paren
id|ioaddr
op_plus
id|Wn4_Media
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|dev-&gt;if_port
)paren
(brace
r_case
id|XCVR_10baseT
suffix:colon
r_case
id|XCVR_100baseTx
suffix:colon
r_case
id|XCVR_100baseFx
suffix:colon
r_if
c_cond
(paren
id|media_status
op_amp
id|Media_LnkBeat
)paren
(brace
id|ok
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|vortex_debug
OG
l_int|1
)paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%s: Media %s has link beat, %x.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|media_tbl
(braket
id|dev-&gt;if_port
)braket
dot
id|name
comma
id|media_status
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|vortex_debug
OG
l_int|1
)paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%s: Media %s is has no link beat, %x.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|media_tbl
(braket
id|dev-&gt;if_port
)braket
dot
id|name
comma
id|media_status
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|XCVR_MII
suffix:colon
r_case
id|XCVR_NWAY
suffix:colon
id|mii_status
op_assign
id|mdio_read
c_func
(paren
id|ioaddr
comma
id|vp-&gt;phys
(braket
l_int|0
)braket
comma
l_int|1
)paren
suffix:semicolon
id|ok
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|debug
OG
l_int|1
)paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%s: MII transceiver has status %4.4x.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|mii_status
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mii_status
op_amp
l_int|0x0004
)paren
(brace
r_int
id|mii_reg5
op_assign
id|mdio_read
c_func
(paren
id|ioaddr
comma
id|vp-&gt;phys
(braket
l_int|0
)braket
comma
l_int|5
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|vp-&gt;force_fd
op_logical_and
id|mii_reg5
op_ne
l_int|0xffff
)paren
(brace
r_int
id|duplex
op_assign
(paren
id|mii_reg5
op_amp
l_int|0x0100
)paren
op_logical_or
(paren
id|mii_reg5
op_amp
l_int|0x01C0
)paren
op_eq
l_int|0x0040
suffix:semicolon
r_if
c_cond
(paren
id|vp-&gt;full_duplex
op_ne
id|duplex
)paren
(brace
id|vp-&gt;full_duplex
op_assign
id|duplex
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Setting %s-duplex based on MII &quot;
l_string|&quot;#%d link partner capability of %4.4x.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|vp-&gt;full_duplex
ques
c_cond
l_string|&quot;full&quot;
suffix:colon
l_string|&quot;half&quot;
comma
id|vp-&gt;phys
(braket
l_int|0
)braket
comma
id|mii_reg5
)paren
suffix:semicolon
multiline_comment|/* Set the full-duplex bit. */
id|outb
c_func
(paren
(paren
id|vp-&gt;full_duplex
ques
c_cond
l_int|0x20
suffix:colon
l_int|0
)paren
op_or
(paren
id|dev-&gt;mtu
OG
l_int|1500
ques
c_cond
l_int|0x40
suffix:colon
l_int|0
)paren
comma
id|ioaddr
op_plus
id|Wn3_MAC_Ctrl
)paren
suffix:semicolon
)brace
id|next_tick
op_assign
l_int|60
op_star
id|HZ
suffix:semicolon
)brace
)brace
r_break
suffix:semicolon
r_default
suffix:colon
(brace
)brace
multiline_comment|/* Other media types handled by Tx timeouts. */
r_if
c_cond
(paren
id|vortex_debug
OG
l_int|1
)paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%s: Media %s is has no indication, %x.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|media_tbl
(braket
id|dev-&gt;if_port
)braket
dot
id|name
comma
id|media_status
)paren
suffix:semicolon
id|ok
op_assign
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|ok
)paren
(brace
r_union
id|wn3_config
id|config
suffix:semicolon
r_do
(brace
id|dev-&gt;if_port
op_assign
id|media_tbl
(braket
id|dev-&gt;if_port
)braket
dot
id|next
suffix:semicolon
)brace
r_while
c_loop
(paren
op_logical_neg
(paren
id|vp-&gt;available_media
op_amp
id|media_tbl
(braket
id|dev-&gt;if_port
)braket
dot
id|mask
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;if_port
op_eq
id|XCVR_Default
)paren
(brace
multiline_comment|/* Go back to default. */
id|dev-&gt;if_port
op_assign
id|vp-&gt;default_media
suffix:semicolon
r_if
c_cond
(paren
id|vortex_debug
OG
l_int|1
)paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%s: Media selection failing, using default &quot;
l_string|&quot;%s port.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|media_tbl
(braket
id|dev-&gt;if_port
)braket
dot
id|name
)paren
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|vortex_debug
OG
l_int|1
)paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%s: Media selection failed, now trying &quot;
l_string|&quot;%s port.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|media_tbl
(braket
id|dev-&gt;if_port
)braket
dot
id|name
)paren
suffix:semicolon
id|next_tick
op_assign
id|RUN_AT
c_func
(paren
id|media_tbl
(braket
id|dev-&gt;if_port
)braket
dot
id|wait
)paren
suffix:semicolon
)brace
id|outw
c_func
(paren
(paren
id|media_status
op_amp
op_complement
(paren
id|Media_10TP
op_or
id|Media_SQE
)paren
)paren
op_or
id|media_tbl
(braket
id|dev-&gt;if_port
)braket
dot
id|media_bits
comma
id|ioaddr
op_plus
id|Wn4_Media
)paren
suffix:semicolon
id|EL3WINDOW
c_func
(paren
l_int|3
)paren
suffix:semicolon
id|config.i
op_assign
id|inl
c_func
(paren
id|ioaddr
op_plus
id|Wn3_Config
)paren
suffix:semicolon
id|config.u.xcvr
op_assign
id|dev-&gt;if_port
suffix:semicolon
id|outl
c_func
(paren
id|config.i
comma
id|ioaddr
op_plus
id|Wn3_Config
)paren
suffix:semicolon
id|outw
c_func
(paren
id|dev-&gt;if_port
op_eq
id|XCVR_10base2
ques
c_cond
id|StartCoax
suffix:colon
id|StopCoax
comma
id|ioaddr
op_plus
id|EL3_CMD
)paren
suffix:semicolon
)brace
id|EL3WINDOW
c_func
(paren
id|old_window
)paren
suffix:semicolon
id|enable_irq
c_func
(paren
id|dev-&gt;irq
)paren
suffix:semicolon
r_if
c_cond
(paren
id|vortex_debug
OG
l_int|2
)paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%s: Media selection timer finished, %s.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|media_tbl
(braket
id|dev-&gt;if_port
)braket
dot
id|name
)paren
suffix:semicolon
r_if
c_cond
(paren
id|next_tick
)paren
(brace
id|vp-&gt;timer.expires
op_assign
id|RUN_AT
c_func
(paren
id|next_tick
)paren
suffix:semicolon
id|add_timer
c_func
(paren
op_amp
id|vp-&gt;timer
)paren
suffix:semicolon
)brace
r_return
suffix:semicolon
)brace
DECL|function|vortex_tx_timeout
r_static
r_void
id|vortex_tx_timeout
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
r_struct
id|vortex_private
op_star
id|vp
op_assign
(paren
r_struct
id|vortex_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_int
id|ioaddr
op_assign
id|dev-&gt;base_addr
suffix:semicolon
r_int
id|j
suffix:semicolon
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: transmit timed out, tx_status %2.2x status %4.4x.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|inb
c_func
(paren
id|ioaddr
op_plus
id|TxStatus
)paren
comma
id|inw
c_func
(paren
id|ioaddr
op_plus
id|EL3_STATUS
)paren
)paren
suffix:semicolon
multiline_comment|/* Slight code bloat to be user friendly. */
r_if
c_cond
(paren
(paren
id|inb
c_func
(paren
id|ioaddr
op_plus
id|TxStatus
)paren
op_amp
l_int|0x88
)paren
op_eq
l_int|0x88
)paren
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: Transmitter encountered 16 collisions --&quot;
l_string|&quot; network cable problem?&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_if
c_cond
(paren
id|inw
c_func
(paren
id|ioaddr
op_plus
id|EL3_STATUS
)paren
op_amp
id|IntLatch
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: Interrupt posted but not delivered --&quot;
l_string|&quot; IRQ blocked by another device?&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
multiline_comment|/* Bad idea here.. but we might as well handle a few events. */
id|vortex_interrupt
c_func
(paren
id|dev-&gt;irq
comma
id|dev
comma
l_int|0
)paren
suffix:semicolon
)brace
id|outw
c_func
(paren
id|TxReset
comma
id|ioaddr
op_plus
id|EL3_CMD
)paren
suffix:semicolon
r_for
c_loop
(paren
id|j
op_assign
l_int|200
suffix:semicolon
id|j
op_ge
l_int|0
suffix:semicolon
id|j
op_decrement
)paren
r_if
c_cond
(paren
op_logical_neg
(paren
id|inw
c_func
(paren
id|ioaddr
op_plus
id|EL3_STATUS
)paren
op_amp
id|CmdInProgress
)paren
)paren
r_break
suffix:semicolon
macro_line|#if ! defined(final_version) &amp;&amp; LINUX_VERSION_CODE &gt;= 0x10300
r_if
c_cond
(paren
id|vp-&gt;full_bus_master_tx
)paren
(brace
r_int
id|i
suffix:semicolon
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;  Flags; bus-master %d, full %d; dirty %d &quot;
l_string|&quot;current %d.&bslash;n&quot;
comma
id|vp-&gt;full_bus_master_tx
comma
id|vp-&gt;tx_full
comma
id|vp-&gt;dirty_tx
comma
id|vp-&gt;cur_tx
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;  Transmit list %8.8x vs. %p.&bslash;n&quot;
comma
id|inl
c_func
(paren
id|ioaddr
op_plus
id|DownListPtr
)paren
comma
op_amp
id|vp-&gt;tx_ring
(braket
id|vp-&gt;dirty_tx
op_mod
id|TX_RING_SIZE
)braket
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|TX_RING_SIZE
suffix:semicolon
id|i
op_increment
)paren
(brace
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;  %d: @%p  length %8.8x status %8.8x&bslash;n&quot;
comma
id|i
comma
op_amp
id|vp-&gt;tx_ring
(braket
id|i
)braket
comma
id|le32_to_cpu
c_func
(paren
id|vp-&gt;tx_ring
(braket
id|i
)braket
dot
id|length
)paren
comma
id|le32_to_cpu
c_func
(paren
id|vp-&gt;tx_ring
(braket
id|i
)braket
dot
id|status
)paren
)paren
suffix:semicolon
)brace
)brace
macro_line|#endif
id|vp-&gt;stats.tx_errors
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|vp-&gt;full_bus_master_tx
)paren
(brace
r_if
c_cond
(paren
id|vortex_debug
OG
l_int|0
)paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%s: Resetting the Tx ring pointer.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_if
c_cond
(paren
id|vp-&gt;cur_tx
op_minus
id|vp-&gt;dirty_tx
OG
l_int|0
op_logical_and
id|inl
c_func
(paren
id|ioaddr
op_plus
id|DownListPtr
)paren
op_eq
l_int|0
)paren
id|outl
c_func
(paren
id|virt_to_bus
c_func
(paren
op_amp
id|vp-&gt;tx_ring
(braket
id|vp-&gt;dirty_tx
op_mod
id|TX_RING_SIZE
)braket
)paren
comma
id|ioaddr
op_plus
id|DownListPtr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|vp-&gt;tx_full
op_logical_and
(paren
id|vp-&gt;cur_tx
op_minus
id|vp-&gt;dirty_tx
op_le
id|TX_RING_SIZE
op_minus
l_int|1
)paren
)paren
(brace
id|vp-&gt;tx_full
op_assign
l_int|0
suffix:semicolon
id|clear_bit
c_func
(paren
l_int|0
comma
(paren
r_void
op_star
)paren
op_amp
id|dev-&gt;tbusy
)paren
suffix:semicolon
)brace
id|outb
c_func
(paren
id|PKT_BUF_SZ
op_rshift
l_int|8
comma
id|ioaddr
op_plus
id|TxFreeThreshold
)paren
suffix:semicolon
id|outw
c_func
(paren
id|DownUnstall
comma
id|ioaddr
op_plus
id|EL3_CMD
)paren
suffix:semicolon
)brace
r_else
id|vp-&gt;stats.tx_dropped
op_increment
suffix:semicolon
multiline_comment|/* Issue Tx Enable */
id|outw
c_func
(paren
id|TxEnable
comma
id|ioaddr
op_plus
id|EL3_CMD
)paren
suffix:semicolon
id|dev-&gt;trans_start
op_assign
id|jiffies
suffix:semicolon
multiline_comment|/* Switch to register set 7 for normal use. */
id|EL3WINDOW
c_func
(paren
l_int|7
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Handle uncommon interrupt sources.  This is a separate routine to minimize&n; * the cache impact.&n; */
r_static
r_void
DECL|function|vortex_error
id|vortex_error
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
r_int
id|status
)paren
(brace
r_struct
id|vortex_private
op_star
id|vp
op_assign
(paren
r_struct
id|vortex_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_int
id|ioaddr
op_assign
id|dev-&gt;base_addr
suffix:semicolon
r_int
id|do_tx_reset
op_assign
l_int|0
suffix:semicolon
r_int
id|i
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
id|TxComplete
)paren
(brace
multiline_comment|/* Really &quot;TxError&quot; for us. */
r_int
r_char
id|tx_status
op_assign
id|inb
c_func
(paren
id|ioaddr
op_plus
id|TxStatus
)paren
suffix:semicolon
multiline_comment|/* Presumably a tx-timeout. We must merely re-enable. */
r_if
c_cond
(paren
id|vortex_debug
OG
l_int|2
op_logical_or
(paren
id|tx_status
op_ne
l_int|0x88
op_logical_and
id|vortex_debug
OG
l_int|0
)paren
)paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%s: Transmit error, Tx status register %2.2x.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|tx_status
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tx_status
op_amp
l_int|0x14
)paren
id|vp-&gt;stats.tx_fifo_errors
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|tx_status
op_amp
l_int|0x38
)paren
id|vp-&gt;stats.tx_aborted_errors
op_increment
suffix:semicolon
id|outb
c_func
(paren
l_int|0
comma
id|ioaddr
op_plus
id|TxStatus
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tx_status
op_amp
l_int|0x30
)paren
id|do_tx_reset
op_assign
l_int|1
suffix:semicolon
r_else
multiline_comment|/* Merely re-enable the transmitter. */
id|outw
c_func
(paren
id|TxEnable
comma
id|ioaddr
op_plus
id|EL3_CMD
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|status
op_amp
id|RxEarly
)paren
(brace
multiline_comment|/* Rx early is unused. */
id|vortex_rx
c_func
(paren
id|dev
)paren
suffix:semicolon
id|outw
c_func
(paren
id|AckIntr
op_or
id|RxEarly
comma
id|ioaddr
op_plus
id|EL3_CMD
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|status
op_amp
id|StatsFull
)paren
(brace
multiline_comment|/* Empty statistics. */
r_static
r_int
id|DoneDidThat
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|vortex_debug
OG
l_int|4
)paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%s: Updating stats.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|update_stats
c_func
(paren
id|ioaddr
comma
id|dev
)paren
suffix:semicolon
multiline_comment|/* HACK: Disable statistics as an interrupt source. */
multiline_comment|/* This occurs when we have the wrong media type! */
r_if
c_cond
(paren
id|DoneDidThat
op_eq
l_int|0
op_logical_and
id|inw
c_func
(paren
id|ioaddr
op_plus
id|EL3_STATUS
)paren
op_amp
id|StatsFull
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: Updating statistics failed, disabling &quot;
l_string|&quot;stats as an interrupt source.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|EL3WINDOW
c_func
(paren
l_int|5
)paren
suffix:semicolon
id|outw
c_func
(paren
id|SetIntrEnb
op_or
(paren
id|inw
c_func
(paren
id|ioaddr
op_plus
l_int|10
)paren
op_amp
op_complement
id|StatsFull
)paren
comma
id|ioaddr
op_plus
id|EL3_CMD
)paren
suffix:semicolon
id|EL3WINDOW
c_func
(paren
l_int|7
)paren
suffix:semicolon
id|DoneDidThat
op_increment
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|status
op_amp
id|IntReq
)paren
(brace
multiline_comment|/* Restore all interrupt sources.  */
id|outw
c_func
(paren
id|vp-&gt;status_enable
comma
id|ioaddr
op_plus
id|EL3_CMD
)paren
suffix:semicolon
id|outw
c_func
(paren
id|vp-&gt;intr_enable
comma
id|ioaddr
op_plus
id|EL3_CMD
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|status
op_amp
id|HostError
)paren
(brace
id|u16
id|fifo_diag
suffix:semicolon
id|EL3WINDOW
c_func
(paren
l_int|4
)paren
suffix:semicolon
id|fifo_diag
op_assign
id|inw
c_func
(paren
id|ioaddr
op_plus
id|Wn4_FIFODiag
)paren
suffix:semicolon
r_if
c_cond
(paren
id|vortex_debug
OG
l_int|0
)paren
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: Host error, FIFO diagnostic register %4.4x.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|fifo_diag
)paren
suffix:semicolon
multiline_comment|/* Adapter failure requires Tx/Rx reset and reinit. */
r_if
c_cond
(paren
id|vp-&gt;full_bus_master_tx
)paren
(brace
id|outw
c_func
(paren
id|TotalReset
op_or
l_int|0xff
comma
id|ioaddr
op_plus
id|EL3_CMD
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|2000
suffix:semicolon
id|i
op_ge
l_int|0
suffix:semicolon
id|i
op_decrement
)paren
r_if
c_cond
(paren
op_logical_neg
(paren
id|inw
c_func
(paren
id|ioaddr
op_plus
id|EL3_STATUS
)paren
op_amp
id|CmdInProgress
)paren
)paren
r_break
suffix:semicolon
multiline_comment|/* Re-enable the receiver. */
id|outw
c_func
(paren
id|RxEnable
comma
id|ioaddr
op_plus
id|EL3_CMD
)paren
suffix:semicolon
id|outw
c_func
(paren
id|TxEnable
comma
id|ioaddr
op_plus
id|EL3_CMD
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|fifo_diag
op_amp
l_int|0x0400
)paren
id|do_tx_reset
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|fifo_diag
op_amp
l_int|0x3000
)paren
(brace
id|outw
c_func
(paren
id|RxReset
comma
id|ioaddr
op_plus
id|EL3_CMD
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|2000
suffix:semicolon
id|i
op_ge
l_int|0
suffix:semicolon
id|i
op_decrement
)paren
r_if
c_cond
(paren
op_logical_neg
(paren
id|inw
c_func
(paren
id|ioaddr
op_plus
id|EL3_STATUS
)paren
op_amp
id|CmdInProgress
)paren
)paren
r_break
suffix:semicolon
multiline_comment|/* Set the Rx filter to the current state. */
id|set_rx_mode
c_func
(paren
id|dev
)paren
suffix:semicolon
id|outw
c_func
(paren
id|RxEnable
comma
id|ioaddr
op_plus
id|EL3_CMD
)paren
suffix:semicolon
multiline_comment|/* Re-enable the receiver. */
id|outw
c_func
(paren
id|AckIntr
op_or
id|HostError
comma
id|ioaddr
op_plus
id|EL3_CMD
)paren
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|do_tx_reset
)paren
(brace
r_int
id|j
suffix:semicolon
id|outw
c_func
(paren
id|TxReset
comma
id|ioaddr
op_plus
id|EL3_CMD
)paren
suffix:semicolon
r_for
c_loop
(paren
id|j
op_assign
l_int|200
suffix:semicolon
id|j
op_ge
l_int|0
suffix:semicolon
id|j
op_decrement
)paren
r_if
c_cond
(paren
op_logical_neg
(paren
id|inw
c_func
(paren
id|ioaddr
op_plus
id|EL3_STATUS
)paren
op_amp
id|CmdInProgress
)paren
)paren
r_break
suffix:semicolon
id|outw
c_func
(paren
id|TxEnable
comma
id|ioaddr
op_plus
id|EL3_CMD
)paren
suffix:semicolon
)brace
)brace
r_static
r_int
DECL|function|vortex_start_xmit
id|vortex_start_xmit
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|device
op_star
id|dev
)paren
(brace
r_struct
id|vortex_private
op_star
id|vp
op_assign
(paren
r_struct
id|vortex_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_int
id|ioaddr
op_assign
id|dev-&gt;base_addr
suffix:semicolon
r_if
c_cond
(paren
id|test_and_set_bit
c_func
(paren
l_int|0
comma
(paren
r_void
op_star
)paren
op_amp
id|dev-&gt;tbusy
)paren
op_ne
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|jiffies
op_minus
id|dev-&gt;trans_start
op_ge
id|TX_TIMEOUT
)paren
id|vortex_tx_timeout
c_func
(paren
id|dev
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
multiline_comment|/* Put out the doubleword header... */
id|outl
c_func
(paren
id|skb-&gt;len
comma
id|ioaddr
op_plus
id|TX_FIFO
)paren
suffix:semicolon
r_if
c_cond
(paren
id|vp-&gt;bus_master
)paren
(brace
multiline_comment|/* Set the bus-master controller to transfer the packet. */
id|outl
c_func
(paren
id|virt_to_bus
c_func
(paren
id|skb-&gt;data
)paren
comma
id|ioaddr
op_plus
id|Wn7_MasterAddr
)paren
suffix:semicolon
id|outw
c_func
(paren
(paren
id|skb-&gt;len
op_plus
l_int|3
)paren
op_amp
op_complement
l_int|3
comma
id|ioaddr
op_plus
id|Wn7_MasterLen
)paren
suffix:semicolon
id|vp-&gt;tx_skb
op_assign
id|skb
suffix:semicolon
id|outw
c_func
(paren
id|StartDMADown
comma
id|ioaddr
op_plus
id|EL3_CMD
)paren
suffix:semicolon
multiline_comment|/* dev-&gt;tbusy will be cleared at the DMADone interrupt. */
)brace
r_else
(brace
multiline_comment|/* ... and the packet rounded to a doubleword. */
id|outsl
c_func
(paren
id|ioaddr
op_plus
id|TX_FIFO
comma
id|skb-&gt;data
comma
(paren
id|skb-&gt;len
op_plus
l_int|3
)paren
op_rshift
l_int|2
)paren
suffix:semicolon
id|DEV_FREE_SKB
c_func
(paren
id|skb
)paren
suffix:semicolon
r_if
c_cond
(paren
id|inw
c_func
(paren
id|ioaddr
op_plus
id|TxFree
)paren
OG
l_int|1536
)paren
(brace
id|clear_bit
c_func
(paren
l_int|0
comma
(paren
r_void
op_star
)paren
op_amp
id|dev-&gt;tbusy
)paren
suffix:semicolon
)brace
r_else
multiline_comment|/* Interrupt us when the FIFO has room for max-sized packet. */
id|outw
c_func
(paren
id|SetTxThreshold
op_plus
(paren
l_int|1536
op_rshift
l_int|2
)paren
comma
id|ioaddr
op_plus
id|EL3_CMD
)paren
suffix:semicolon
)brace
id|dev-&gt;trans_start
op_assign
id|jiffies
suffix:semicolon
multiline_comment|/* Clear the Tx status stack. */
(brace
r_int
id|tx_status
suffix:semicolon
r_int
id|i
op_assign
l_int|32
suffix:semicolon
r_while
c_loop
(paren
op_decrement
id|i
OG
l_int|0
op_logical_and
(paren
id|tx_status
op_assign
id|inb
c_func
(paren
id|ioaddr
op_plus
id|TxStatus
)paren
)paren
OG
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|tx_status
op_amp
l_int|0x3C
)paren
(brace
multiline_comment|/* A Tx-disabling error occurred.  */
r_if
c_cond
(paren
id|vortex_debug
OG
l_int|2
)paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%s: Tx error, status %2.2x.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|tx_status
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tx_status
op_amp
l_int|0x04
)paren
id|vp-&gt;stats.tx_fifo_errors
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|tx_status
op_amp
l_int|0x38
)paren
id|vp-&gt;stats.tx_aborted_errors
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|tx_status
op_amp
l_int|0x30
)paren
(brace
r_int
id|j
suffix:semicolon
id|outw
c_func
(paren
id|TxReset
comma
id|ioaddr
op_plus
id|EL3_CMD
)paren
suffix:semicolon
r_for
c_loop
(paren
id|j
op_assign
l_int|200
suffix:semicolon
id|j
op_ge
l_int|0
suffix:semicolon
id|j
op_decrement
)paren
r_if
c_cond
(paren
op_logical_neg
(paren
id|inw
c_func
(paren
id|ioaddr
op_plus
id|EL3_STATUS
)paren
op_amp
id|CmdInProgress
)paren
)paren
r_break
suffix:semicolon
)brace
id|outw
c_func
(paren
id|TxEnable
comma
id|ioaddr
op_plus
id|EL3_CMD
)paren
suffix:semicolon
)brace
id|outb
c_func
(paren
l_int|0x00
comma
id|ioaddr
op_plus
id|TxStatus
)paren
suffix:semicolon
multiline_comment|/* Pop the status stack. */
)brace
)brace
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_int
DECL|function|boomerang_start_xmit
id|boomerang_start_xmit
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|device
op_star
id|dev
)paren
(brace
r_struct
id|vortex_private
op_star
id|vp
op_assign
(paren
r_struct
id|vortex_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_int
id|ioaddr
op_assign
id|dev-&gt;base_addr
suffix:semicolon
r_if
c_cond
(paren
id|test_and_set_bit
c_func
(paren
l_int|0
comma
(paren
r_void
op_star
)paren
op_amp
id|dev-&gt;tbusy
)paren
op_ne
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|jiffies
op_minus
id|dev-&gt;trans_start
op_ge
id|TX_TIMEOUT
)paren
id|vortex_tx_timeout
c_func
(paren
id|dev
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* Calculate the next Tx descriptor entry. */
r_int
id|entry
op_assign
id|vp-&gt;cur_tx
op_mod
id|TX_RING_SIZE
suffix:semicolon
r_struct
id|boom_tx_desc
op_star
id|prev_entry
op_assign
op_amp
id|vp-&gt;tx_ring
(braket
(paren
id|vp-&gt;cur_tx
op_minus
l_int|1
)paren
op_mod
id|TX_RING_SIZE
)braket
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_int
id|i
suffix:semicolon
r_if
c_cond
(paren
id|vortex_debug
OG
l_int|3
)paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%s: Trying to send a packet, Tx index %d.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|vp-&gt;cur_tx
)paren
suffix:semicolon
r_if
c_cond
(paren
id|vp-&gt;tx_full
)paren
(brace
r_if
c_cond
(paren
id|vortex_debug
OG
l_int|0
)paren
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: Tx Ring full, refusing to send buffer.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
id|vp-&gt;tx_skbuff
(braket
id|entry
)braket
op_assign
id|skb
suffix:semicolon
id|vp-&gt;tx_ring
(braket
id|entry
)braket
dot
id|next
op_assign
l_int|0
suffix:semicolon
id|vp-&gt;tx_ring
(braket
id|entry
)braket
dot
id|addr
op_assign
id|cpu_to_le32
c_func
(paren
id|virt_to_bus
c_func
(paren
id|skb-&gt;data
)paren
)paren
suffix:semicolon
id|vp-&gt;tx_ring
(braket
id|entry
)braket
dot
id|length
op_assign
id|cpu_to_le32
c_func
(paren
id|skb-&gt;len
op_or
id|LAST_FRAG
)paren
suffix:semicolon
id|vp-&gt;tx_ring
(braket
id|entry
)braket
dot
id|status
op_assign
id|cpu_to_le32
c_func
(paren
id|skb-&gt;len
op_or
id|TxIntrUploaded
)paren
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|outw
c_func
(paren
id|DownStall
comma
id|ioaddr
op_plus
id|EL3_CMD
)paren
suffix:semicolon
multiline_comment|/* Wait for the stall to complete. */
r_for
c_loop
(paren
id|i
op_assign
l_int|600
suffix:semicolon
id|i
op_ge
l_int|0
suffix:semicolon
id|i
op_decrement
)paren
r_if
c_cond
(paren
(paren
id|inw
c_func
(paren
id|ioaddr
op_plus
id|EL3_STATUS
)paren
op_amp
id|CmdInProgress
)paren
op_eq
l_int|0
)paren
r_break
suffix:semicolon
id|prev_entry-&gt;next
op_assign
id|cpu_to_le32
c_func
(paren
id|virt_to_bus
c_func
(paren
op_amp
id|vp-&gt;tx_ring
(braket
id|entry
)braket
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|inl
c_func
(paren
id|ioaddr
op_plus
id|DownListPtr
)paren
op_eq
l_int|0
)paren
(brace
id|outl
c_func
(paren
id|virt_to_bus
c_func
(paren
op_amp
id|vp-&gt;tx_ring
(braket
id|entry
)braket
)paren
comma
id|ioaddr
op_plus
id|DownListPtr
)paren
suffix:semicolon
id|queued_packet
op_increment
suffix:semicolon
)brace
id|outw
c_func
(paren
id|DownUnstall
comma
id|ioaddr
op_plus
id|EL3_CMD
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|vp-&gt;cur_tx
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|vp-&gt;cur_tx
op_minus
id|vp-&gt;dirty_tx
OG
id|TX_RING_SIZE
op_minus
l_int|1
)paren
id|vp-&gt;tx_full
op_assign
l_int|1
suffix:semicolon
r_else
(brace
multiline_comment|/* Clear previous interrupt enable. */
id|prev_entry-&gt;status
op_and_assign
id|cpu_to_le32
c_func
(paren
op_complement
id|TxIntrUploaded
)paren
suffix:semicolon
id|clear_bit
c_func
(paren
l_int|0
comma
(paren
r_void
op_star
)paren
op_amp
id|dev-&gt;tbusy
)paren
suffix:semicolon
)brace
id|dev-&gt;trans_start
op_assign
id|jiffies
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
)brace
multiline_comment|/* The interrupt handler does all of the Rx thread work and cleans up&n;   after the Tx thread. */
DECL|function|vortex_interrupt
r_static
r_void
id|vortex_interrupt
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_struct
id|device
op_star
id|dev
op_assign
id|dev_id
suffix:semicolon
r_struct
id|vortex_private
op_star
id|vp
op_assign
(paren
r_struct
id|vortex_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_int
id|ioaddr
suffix:semicolon
r_int
id|latency
comma
id|status
suffix:semicolon
r_int
id|work_done
op_assign
id|max_interrupt_work
suffix:semicolon
macro_line|#if defined(__i386__)
multiline_comment|/* A lock to prevent simultaneous entry bug on Intel SMP machines. */
r_if
c_cond
(paren
id|test_and_set_bit
c_func
(paren
l_int|0
comma
(paren
r_void
op_star
)paren
op_amp
id|dev-&gt;interrupt
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: SMP simultaneous entry of an interrupt handler.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|dev-&gt;interrupt
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Avoid halting machine. */
r_return
suffix:semicolon
)brace
macro_line|#else
r_if
c_cond
(paren
id|dev-&gt;interrupt
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: Re-entering the interrupt handler.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|dev-&gt;interrupt
op_assign
l_int|1
suffix:semicolon
macro_line|#endif
id|dev-&gt;interrupt
op_assign
l_int|1
suffix:semicolon
id|ioaddr
op_assign
id|dev-&gt;base_addr
suffix:semicolon
id|latency
op_assign
id|inb
c_func
(paren
id|ioaddr
op_plus
id|Timer
)paren
suffix:semicolon
id|status
op_assign
id|inw
c_func
(paren
id|ioaddr
op_plus
id|EL3_STATUS
)paren
suffix:semicolon
r_if
c_cond
(paren
id|vortex_debug
OG
l_int|4
)paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%s: interrupt, status %4.4x, latency %d ticks.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|status
comma
id|latency
)paren
suffix:semicolon
r_do
(brace
r_if
c_cond
(paren
id|vortex_debug
OG
l_int|5
)paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%s: In interrupt loop, status %4.4x.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|status
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
id|RxComplete
)paren
id|vortex_rx
c_func
(paren
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
id|UpComplete
)paren
(brace
id|outw
c_func
(paren
id|AckIntr
op_or
id|UpComplete
comma
id|ioaddr
op_plus
id|EL3_CMD
)paren
suffix:semicolon
id|boomerang_rx
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|status
op_amp
id|TxAvailable
)paren
(brace
r_if
c_cond
(paren
id|vortex_debug
OG
l_int|5
)paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;&t;TX room bit was handled.&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* There&squot;s room in the FIFO for a full-sized packet. */
id|outw
c_func
(paren
id|AckIntr
op_or
id|TxAvailable
comma
id|ioaddr
op_plus
id|EL3_CMD
)paren
suffix:semicolon
id|clear_bit
c_func
(paren
l_int|0
comma
(paren
r_void
op_star
)paren
op_amp
id|dev-&gt;tbusy
)paren
suffix:semicolon
id|mark_bh
c_func
(paren
id|NET_BH
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|status
op_amp
id|DownComplete
)paren
(brace
r_int
r_int
id|dirty_tx
op_assign
id|vp-&gt;dirty_tx
suffix:semicolon
r_while
c_loop
(paren
id|vp-&gt;cur_tx
op_minus
id|dirty_tx
OG
l_int|0
)paren
(brace
r_int
id|entry
op_assign
id|dirty_tx
op_mod
id|TX_RING_SIZE
suffix:semicolon
r_if
c_cond
(paren
id|inl
c_func
(paren
id|ioaddr
op_plus
id|DownListPtr
)paren
op_eq
id|virt_to_bus
c_func
(paren
op_amp
id|vp-&gt;tx_ring
(braket
id|entry
)braket
)paren
)paren
r_break
suffix:semicolon
multiline_comment|/* It still hasn&squot;t been processed. */
r_if
c_cond
(paren
id|vp-&gt;tx_skbuff
(braket
id|entry
)braket
)paren
(brace
id|DEV_FREE_SKB
c_func
(paren
id|vp-&gt;tx_skbuff
(braket
id|entry
)braket
)paren
suffix:semicolon
id|vp-&gt;tx_skbuff
(braket
id|entry
)braket
op_assign
l_int|0
suffix:semicolon
)brace
multiline_comment|/* vp-&gt;stats.tx_packets++;  Counted below. */
id|dirty_tx
op_increment
suffix:semicolon
)brace
id|vp-&gt;dirty_tx
op_assign
id|dirty_tx
suffix:semicolon
id|outw
c_func
(paren
id|AckIntr
op_or
id|DownComplete
comma
id|ioaddr
op_plus
id|EL3_CMD
)paren
suffix:semicolon
r_if
c_cond
(paren
id|vp-&gt;tx_full
op_logical_and
(paren
id|vp-&gt;cur_tx
op_minus
id|dirty_tx
op_le
id|TX_RING_SIZE
op_minus
l_int|1
)paren
)paren
(brace
id|vp-&gt;tx_full
op_assign
l_int|0
suffix:semicolon
id|clear_bit
c_func
(paren
l_int|0
comma
(paren
r_void
op_star
)paren
op_amp
id|dev-&gt;tbusy
)paren
suffix:semicolon
id|mark_bh
c_func
(paren
id|NET_BH
)paren
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|status
op_amp
id|DMADone
)paren
(brace
r_if
c_cond
(paren
id|inw
c_func
(paren
id|ioaddr
op_plus
id|Wn7_MasterStatus
)paren
op_amp
l_int|0x1000
)paren
(brace
id|outw
c_func
(paren
l_int|0x1000
comma
id|ioaddr
op_plus
id|Wn7_MasterStatus
)paren
suffix:semicolon
multiline_comment|/* Ack the event. */
id|DEV_FREE_SKB
c_func
(paren
id|vp-&gt;tx_skb
)paren
suffix:semicolon
multiline_comment|/* Release the transfered buffer */
r_if
c_cond
(paren
id|inw
c_func
(paren
id|ioaddr
op_plus
id|TxFree
)paren
OG
l_int|1536
)paren
(brace
id|clear_bit
c_func
(paren
l_int|0
comma
(paren
r_void
op_star
)paren
op_amp
id|dev-&gt;tbusy
)paren
suffix:semicolon
id|mark_bh
c_func
(paren
id|NET_BH
)paren
suffix:semicolon
)brace
r_else
multiline_comment|/* Interrupt when FIFO has room for max-sized packet. */
id|outw
c_func
(paren
id|SetTxThreshold
op_plus
(paren
l_int|1536
op_rshift
l_int|2
)paren
comma
id|ioaddr
op_plus
id|EL3_CMD
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* Check for all uncommon interrupts at once. */
r_if
c_cond
(paren
id|status
op_amp
(paren
id|HostError
op_or
id|RxEarly
op_or
id|StatsFull
op_or
id|TxComplete
op_or
id|IntReq
)paren
)paren
(brace
r_if
c_cond
(paren
id|status
op_eq
l_int|0xffff
)paren
r_break
suffix:semicolon
id|vortex_error
c_func
(paren
id|dev
comma
id|status
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
op_decrement
id|work_done
OL
l_int|0
)paren
(brace
r_if
c_cond
(paren
(paren
id|status
op_amp
(paren
l_int|0x7fe
op_minus
(paren
id|UpComplete
op_or
id|DownComplete
)paren
)paren
)paren
op_eq
l_int|0
)paren
(brace
multiline_comment|/* Just ack these and return. */
id|outw
c_func
(paren
id|AckIntr
op_or
id|UpComplete
op_or
id|DownComplete
comma
id|ioaddr
op_plus
id|EL3_CMD
)paren
suffix:semicolon
)brace
r_else
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: Too much work in interrupt, status &quot;
l_string|&quot;%4.4x.  Temporarily disabling functions (%4.4x).&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|status
comma
id|SetStatusEnb
op_or
(paren
(paren
op_complement
id|status
)paren
op_amp
l_int|0x7FE
)paren
)paren
suffix:semicolon
multiline_comment|/* Disable all pending interrupts. */
id|outw
c_func
(paren
id|SetStatusEnb
op_or
(paren
(paren
op_complement
id|status
)paren
op_amp
l_int|0x7FE
)paren
comma
id|ioaddr
op_plus
id|EL3_CMD
)paren
suffix:semicolon
id|outw
c_func
(paren
id|AckIntr
op_or
l_int|0x7FF
comma
id|ioaddr
op_plus
id|EL3_CMD
)paren
suffix:semicolon
multiline_comment|/* The timer will reenable interrupts. */
r_break
suffix:semicolon
)brace
)brace
multiline_comment|/* Acknowledge the IRQ. */
id|outw
c_func
(paren
id|AckIntr
op_or
id|IntReq
op_or
id|IntLatch
comma
id|ioaddr
op_plus
id|EL3_CMD
)paren
suffix:semicolon
r_if
c_cond
(paren
id|vp-&gt;cb_fn_base
)paren
multiline_comment|/* The PCMCIA people are idiots.  */
id|writel
c_func
(paren
l_int|0x8000
comma
id|vp-&gt;cb_fn_base
op_plus
l_int|4
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
(paren
id|status
op_assign
id|inw
c_func
(paren
id|ioaddr
op_plus
id|EL3_STATUS
)paren
)paren
op_amp
(paren
id|IntLatch
op_or
id|RxComplete
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|vortex_debug
OG
l_int|4
)paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%s: exiting interrupt, status %4.4x.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|status
)paren
suffix:semicolon
macro_line|#if defined(__i386__)
id|clear_bit
c_func
(paren
l_int|0
comma
(paren
r_void
op_star
)paren
op_amp
id|dev-&gt;interrupt
)paren
suffix:semicolon
macro_line|#else
id|dev-&gt;interrupt
op_assign
l_int|0
suffix:semicolon
macro_line|#endif
r_return
suffix:semicolon
)brace
DECL|function|vortex_rx
r_static
r_int
id|vortex_rx
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
r_struct
id|vortex_private
op_star
id|vp
op_assign
(paren
r_struct
id|vortex_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_int
id|ioaddr
op_assign
id|dev-&gt;base_addr
suffix:semicolon
r_int
id|i
suffix:semicolon
r_int
id|rx_status
suffix:semicolon
r_if
c_cond
(paren
id|vortex_debug
OG
l_int|5
)paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;   In rx_packet(), status %4.4x, rx_status %4.4x.&bslash;n&quot;
comma
id|inw
c_func
(paren
id|ioaddr
op_plus
id|EL3_STATUS
)paren
comma
id|inw
c_func
(paren
id|ioaddr
op_plus
id|RxStatus
)paren
)paren
suffix:semicolon
r_while
c_loop
(paren
(paren
id|rx_status
op_assign
id|inw
c_func
(paren
id|ioaddr
op_plus
id|RxStatus
)paren
)paren
OG
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|rx_status
op_amp
l_int|0x4000
)paren
(brace
multiline_comment|/* Error, update stats. */
r_int
r_char
id|rx_error
op_assign
id|inb
c_func
(paren
id|ioaddr
op_plus
id|RxErrors
)paren
suffix:semicolon
r_if
c_cond
(paren
id|vortex_debug
OG
l_int|2
)paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot; Rx error: status %2.2x.&bslash;n&quot;
comma
id|rx_error
)paren
suffix:semicolon
id|vp-&gt;stats.rx_errors
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|rx_error
op_amp
l_int|0x01
)paren
id|vp-&gt;stats.rx_over_errors
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|rx_error
op_amp
l_int|0x02
)paren
id|vp-&gt;stats.rx_length_errors
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|rx_error
op_amp
l_int|0x04
)paren
id|vp-&gt;stats.rx_frame_errors
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|rx_error
op_amp
l_int|0x08
)paren
id|vp-&gt;stats.rx_crc_errors
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|rx_error
op_amp
l_int|0x10
)paren
id|vp-&gt;stats.rx_length_errors
op_increment
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* The packet length: up to 4.5K!. */
r_int
id|pkt_len
op_assign
id|rx_status
op_amp
l_int|0x1fff
suffix:semicolon
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
id|skb
op_assign
id|dev_alloc_skb
c_func
(paren
id|pkt_len
op_plus
l_int|5
)paren
suffix:semicolon
r_if
c_cond
(paren
id|vortex_debug
OG
l_int|4
)paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;Receiving packet size %d status %4.4x.&bslash;n&quot;
comma
id|pkt_len
comma
id|rx_status
)paren
suffix:semicolon
r_if
c_cond
(paren
id|skb
op_ne
l_int|NULL
)paren
(brace
id|skb-&gt;dev
op_assign
id|dev
suffix:semicolon
id|skb_reserve
c_func
(paren
id|skb
comma
l_int|2
)paren
suffix:semicolon
multiline_comment|/* Align IP on 16 byte boundaries */
multiline_comment|/* &squot;skb_put()&squot; points to the start of sk_buff data area. */
r_if
c_cond
(paren
id|vp-&gt;bus_master
op_logical_and
op_logical_neg
(paren
id|inw
c_func
(paren
id|ioaddr
op_plus
id|Wn7_MasterStatus
)paren
op_amp
l_int|0x8000
)paren
)paren
(brace
id|outl
c_func
(paren
id|virt_to_bus
c_func
(paren
id|skb_put
c_func
(paren
id|skb
comma
id|pkt_len
)paren
)paren
comma
id|ioaddr
op_plus
id|Wn7_MasterAddr
)paren
suffix:semicolon
id|outw
c_func
(paren
(paren
id|skb-&gt;len
op_plus
l_int|3
)paren
op_amp
op_complement
l_int|3
comma
id|ioaddr
op_plus
id|Wn7_MasterLen
)paren
suffix:semicolon
id|outw
c_func
(paren
id|StartDMAUp
comma
id|ioaddr
op_plus
id|EL3_CMD
)paren
suffix:semicolon
r_while
c_loop
(paren
id|inw
c_func
(paren
id|ioaddr
op_plus
id|Wn7_MasterStatus
)paren
op_amp
l_int|0x8000
)paren
suffix:semicolon
)brace
r_else
(brace
id|insl
c_func
(paren
id|ioaddr
op_plus
id|RX_FIFO
comma
id|skb_put
c_func
(paren
id|skb
comma
id|pkt_len
)paren
comma
(paren
id|pkt_len
op_plus
l_int|3
)paren
op_rshift
l_int|2
)paren
suffix:semicolon
)brace
id|outw
c_func
(paren
id|RxDiscard
comma
id|ioaddr
op_plus
id|EL3_CMD
)paren
suffix:semicolon
multiline_comment|/* Pop top Rx packet. */
id|skb-&gt;protocol
op_assign
id|eth_type_trans
c_func
(paren
id|skb
comma
id|dev
)paren
suffix:semicolon
id|netif_rx
c_func
(paren
id|skb
)paren
suffix:semicolon
id|dev-&gt;last_rx
op_assign
id|jiffies
suffix:semicolon
id|vp-&gt;stats.rx_packets
op_increment
suffix:semicolon
multiline_comment|/* Wait a limited time to go to next packet. */
r_for
c_loop
(paren
id|i
op_assign
l_int|200
suffix:semicolon
id|i
op_ge
l_int|0
suffix:semicolon
id|i
op_decrement
)paren
r_if
c_cond
(paren
op_logical_neg
(paren
id|inw
c_func
(paren
id|ioaddr
op_plus
id|EL3_STATUS
)paren
op_amp
id|CmdInProgress
)paren
)paren
r_break
suffix:semicolon
r_continue
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|vortex_debug
)paren
id|printk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;%s: No memory to allocate a sk_buff of &quot;
l_string|&quot;size %d.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|pkt_len
)paren
suffix:semicolon
)brace
id|outw
c_func
(paren
id|RxDiscard
comma
id|ioaddr
op_plus
id|EL3_CMD
)paren
suffix:semicolon
id|vp-&gt;stats.rx_dropped
op_increment
suffix:semicolon
multiline_comment|/* Wait a limited time to skip this packet. */
r_for
c_loop
(paren
id|i
op_assign
l_int|200
suffix:semicolon
id|i
op_ge
l_int|0
suffix:semicolon
id|i
op_decrement
)paren
r_if
c_cond
(paren
op_logical_neg
(paren
id|inw
c_func
(paren
id|ioaddr
op_plus
id|EL3_STATUS
)paren
op_amp
id|CmdInProgress
)paren
)paren
r_break
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_int
DECL|function|boomerang_rx
id|boomerang_rx
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
r_struct
id|vortex_private
op_star
id|vp
op_assign
(paren
r_struct
id|vortex_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_int
id|entry
op_assign
id|vp-&gt;cur_rx
op_mod
id|RX_RING_SIZE
suffix:semicolon
r_int
id|ioaddr
op_assign
id|dev-&gt;base_addr
suffix:semicolon
r_int
id|rx_status
suffix:semicolon
r_int
id|rx_work_limit
op_assign
id|vp-&gt;dirty_rx
op_plus
id|RX_RING_SIZE
op_minus
id|vp-&gt;cur_rx
suffix:semicolon
r_if
c_cond
(paren
id|vortex_debug
OG
l_int|5
)paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;  In boomerang_rx(), status %4.4x, rx_status &quot;
l_string|&quot;%4.4x.&bslash;n&quot;
comma
id|inw
c_func
(paren
id|ioaddr
op_plus
id|EL3_STATUS
)paren
comma
id|inw
c_func
(paren
id|ioaddr
op_plus
id|RxStatus
)paren
)paren
suffix:semicolon
r_while
c_loop
(paren
(paren
id|rx_status
op_assign
id|le32_to_cpu
c_func
(paren
id|vp-&gt;rx_ring
(braket
id|entry
)braket
dot
id|status
)paren
)paren
op_amp
id|RxDComplete
)paren
(brace
r_if
c_cond
(paren
op_decrement
id|rx_work_limit
OL
l_int|0
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
id|rx_status
op_amp
id|RxDError
)paren
(brace
multiline_comment|/* Error, update stats. */
r_int
r_char
id|rx_error
op_assign
id|rx_status
op_rshift
l_int|16
suffix:semicolon
r_if
c_cond
(paren
id|vortex_debug
OG
l_int|2
)paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot; Rx error: status %2.2x.&bslash;n&quot;
comma
id|rx_error
)paren
suffix:semicolon
id|vp-&gt;stats.rx_errors
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|rx_error
op_amp
l_int|0x01
)paren
id|vp-&gt;stats.rx_over_errors
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|rx_error
op_amp
l_int|0x02
)paren
id|vp-&gt;stats.rx_length_errors
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|rx_error
op_amp
l_int|0x04
)paren
id|vp-&gt;stats.rx_frame_errors
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|rx_error
op_amp
l_int|0x08
)paren
id|vp-&gt;stats.rx_crc_errors
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|rx_error
op_amp
l_int|0x10
)paren
id|vp-&gt;stats.rx_length_errors
op_increment
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* The packet length: up to 4.5K!. */
r_int
id|pkt_len
op_assign
id|rx_status
op_amp
l_int|0x1fff
suffix:semicolon
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
r_if
c_cond
(paren
id|vortex_debug
OG
l_int|4
)paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;Receiving packet size %d status %4.4x.&bslash;n&quot;
comma
id|pkt_len
comma
id|rx_status
)paren
suffix:semicolon
multiline_comment|/* Check if the packet is long enough to just accept without&n;&t;&t;&t;   copying to a properly sized skbuff. */
r_if
c_cond
(paren
id|pkt_len
OL
id|rx_copybreak
op_logical_and
(paren
id|skb
op_assign
id|dev_alloc_skb
c_func
(paren
id|pkt_len
op_plus
l_int|2
)paren
)paren
op_ne
l_int|0
)paren
(brace
id|skb-&gt;dev
op_assign
id|dev
suffix:semicolon
id|skb_reserve
c_func
(paren
id|skb
comma
l_int|2
)paren
suffix:semicolon
multiline_comment|/* Align IP on 16 byte boundaries */
multiline_comment|/* &squot;skb_put()&squot; points to the start of sk_buff data area. */
id|memcpy
c_func
(paren
id|skb_put
c_func
(paren
id|skb
comma
id|pkt_len
)paren
comma
id|bus_to_virt
c_func
(paren
id|le32_to_cpu
c_func
(paren
id|vp-&gt;rx_ring
(braket
id|entry
)braket
dot
id|addr
)paren
)paren
comma
id|pkt_len
)paren
suffix:semicolon
id|rx_copy
op_increment
suffix:semicolon
)brace
r_else
(brace
r_void
op_star
id|temp
suffix:semicolon
multiline_comment|/* Pass up the skbuff already on the Rx ring. */
id|skb
op_assign
id|vp-&gt;rx_skbuff
(braket
id|entry
)braket
suffix:semicolon
id|vp-&gt;rx_skbuff
(braket
id|entry
)braket
op_assign
l_int|NULL
suffix:semicolon
id|temp
op_assign
id|skb_put
c_func
(paren
id|skb
comma
id|pkt_len
)paren
suffix:semicolon
multiline_comment|/* Remove this checking code for final release. */
r_if
c_cond
(paren
id|bus_to_virt
c_func
(paren
id|le32_to_cpu
c_func
(paren
id|vp-&gt;rx_ring
(braket
id|entry
)braket
dot
id|addr
)paren
)paren
op_ne
id|temp
)paren
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: Warning -- the skbuff addresses do not match&quot;
l_string|&quot; in boomerang_rx: %p vs. %p.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|bus_to_virt
c_func
(paren
id|le32_to_cpu
c_func
(paren
id|vp-&gt;rx_ring
(braket
id|entry
)braket
dot
id|addr
)paren
)paren
comma
id|temp
)paren
suffix:semicolon
id|rx_nocopy
op_increment
suffix:semicolon
)brace
id|skb-&gt;protocol
op_assign
id|eth_type_trans
c_func
(paren
id|skb
comma
id|dev
)paren
suffix:semicolon
(brace
multiline_comment|/* Use hardware checksum info. */
r_int
id|csum_bits
op_assign
id|rx_status
op_amp
l_int|0xee000000
suffix:semicolon
r_if
c_cond
(paren
id|csum_bits
op_logical_and
(paren
id|csum_bits
op_eq
(paren
id|IPChksumValid
op_or
id|TCPChksumValid
)paren
op_logical_or
id|csum_bits
op_eq
(paren
id|IPChksumValid
op_or
id|UDPChksumValid
)paren
)paren
)paren
(brace
id|skb-&gt;ip_summed
op_assign
id|CHECKSUM_UNNECESSARY
suffix:semicolon
id|rx_csumhits
op_increment
suffix:semicolon
)brace
)brace
id|netif_rx
c_func
(paren
id|skb
)paren
suffix:semicolon
id|dev-&gt;last_rx
op_assign
id|jiffies
suffix:semicolon
id|vp-&gt;stats.rx_packets
op_increment
suffix:semicolon
)brace
id|entry
op_assign
(paren
op_increment
id|vp-&gt;cur_rx
)paren
op_mod
id|RX_RING_SIZE
suffix:semicolon
)brace
multiline_comment|/* Refill the Rx ring buffers. */
r_for
c_loop
(paren
suffix:semicolon
id|vp-&gt;dirty_rx
OL
id|vp-&gt;cur_rx
suffix:semicolon
id|vp-&gt;dirty_rx
op_increment
)paren
(brace
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
id|entry
op_assign
id|vp-&gt;dirty_rx
op_mod
id|RX_RING_SIZE
suffix:semicolon
r_if
c_cond
(paren
id|vp-&gt;rx_skbuff
(braket
id|entry
)braket
op_eq
l_int|NULL
)paren
(brace
id|skb
op_assign
id|dev_alloc_skb
c_func
(paren
id|PKT_BUF_SZ
)paren
suffix:semicolon
r_if
c_cond
(paren
id|skb
op_eq
l_int|NULL
)paren
r_break
suffix:semicolon
multiline_comment|/* Bad news!  */
id|skb-&gt;dev
op_assign
id|dev
suffix:semicolon
multiline_comment|/* Mark as being used by this device. */
id|skb_reserve
c_func
(paren
id|skb
comma
l_int|2
)paren
suffix:semicolon
multiline_comment|/* Align IP on 16 byte boundaries */
id|vp-&gt;rx_ring
(braket
id|entry
)braket
dot
id|addr
op_assign
id|cpu_to_le32
c_func
(paren
id|virt_to_bus
c_func
(paren
id|skb-&gt;tail
)paren
)paren
suffix:semicolon
id|vp-&gt;rx_skbuff
(braket
id|entry
)braket
op_assign
id|skb
suffix:semicolon
)brace
id|vp-&gt;rx_ring
(braket
id|entry
)braket
dot
id|status
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Clear complete bit. */
id|outw
c_func
(paren
id|UpUnstall
comma
id|ioaddr
op_plus
id|EL3_CMD
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_int
DECL|function|vortex_close
id|vortex_close
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
r_struct
id|vortex_private
op_star
id|vp
op_assign
(paren
r_struct
id|vortex_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_int
id|ioaddr
op_assign
id|dev-&gt;base_addr
suffix:semicolon
r_int
id|i
suffix:semicolon
id|dev-&gt;start
op_assign
l_int|0
suffix:semicolon
id|dev-&gt;tbusy
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|vortex_debug
OG
l_int|1
)paren
(brace
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%s: vortex_close() status %4.4x, Tx status %2.2x.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|inw
c_func
(paren
id|ioaddr
op_plus
id|EL3_STATUS
)paren
comma
id|inb
c_func
(paren
id|ioaddr
op_plus
id|TxStatus
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%s: vortex close stats: rx_nocopy %d rx_copy %d&quot;
l_string|&quot; tx_queued %d Rx pre-checksummed %d.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|rx_nocopy
comma
id|rx_copy
comma
id|queued_packet
comma
id|rx_csumhits
)paren
suffix:semicolon
)brace
id|del_timer
c_func
(paren
op_amp
id|vp-&gt;timer
)paren
suffix:semicolon
multiline_comment|/* Turn off statistics ASAP.  We update vp-&gt;stats below. */
id|outw
c_func
(paren
id|StatsDisable
comma
id|ioaddr
op_plus
id|EL3_CMD
)paren
suffix:semicolon
multiline_comment|/* Disable the receiver and transmitter. */
id|outw
c_func
(paren
id|RxDisable
comma
id|ioaddr
op_plus
id|EL3_CMD
)paren
suffix:semicolon
id|outw
c_func
(paren
id|TxDisable
comma
id|ioaddr
op_plus
id|EL3_CMD
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;if_port
op_eq
id|XCVR_10base2
)paren
multiline_comment|/* Turn off thinnet power.  Green! */
id|outw
c_func
(paren
id|StopCoax
comma
id|ioaddr
op_plus
id|EL3_CMD
)paren
suffix:semicolon
id|free_irq
c_func
(paren
id|dev-&gt;irq
comma
id|dev
)paren
suffix:semicolon
id|outw
c_func
(paren
id|SetIntrEnb
op_or
l_int|0x0000
comma
id|ioaddr
op_plus
id|EL3_CMD
)paren
suffix:semicolon
id|update_stats
c_func
(paren
id|ioaddr
comma
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|vp-&gt;full_bus_master_rx
)paren
(brace
multiline_comment|/* Free Boomerang bus master Rx buffers. */
id|outl
c_func
(paren
l_int|0
comma
id|ioaddr
op_plus
id|UpListPtr
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|RX_RING_SIZE
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
id|vp-&gt;rx_skbuff
(braket
id|i
)braket
)paren
(brace
macro_line|#if LINUX_VERSION_CODE &lt; 0x20100
id|vp-&gt;rx_skbuff
(braket
id|i
)braket
op_member_access_from_pointer
id|free
op_assign
l_int|1
suffix:semicolon
macro_line|#endif
id|DEV_FREE_SKB
c_func
(paren
id|vp-&gt;rx_skbuff
(braket
id|i
)braket
)paren
suffix:semicolon
id|vp-&gt;rx_skbuff
(braket
id|i
)braket
op_assign
l_int|0
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|vp-&gt;full_bus_master_tx
)paren
(brace
multiline_comment|/* Free Boomerang bus master Tx buffers. */
id|outl
c_func
(paren
l_int|0
comma
id|ioaddr
op_plus
id|DownListPtr
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|TX_RING_SIZE
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
id|vp-&gt;tx_skbuff
(braket
id|i
)braket
)paren
(brace
id|DEV_FREE_SKB
c_func
(paren
id|vp-&gt;tx_skbuff
(braket
id|i
)braket
)paren
suffix:semicolon
id|vp-&gt;tx_skbuff
(braket
id|i
)braket
op_assign
l_int|0
suffix:semicolon
)brace
)brace
id|MOD_DEC_USE_COUNT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|vortex_get_stats
r_static
r_struct
id|net_device_stats
op_star
id|vortex_get_stats
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
r_struct
id|vortex_private
op_star
id|vp
op_assign
(paren
r_struct
id|vortex_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;start
)paren
(brace
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|update_stats
c_func
(paren
id|dev-&gt;base_addr
comma
id|dev
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
r_return
op_amp
id|vp-&gt;stats
suffix:semicolon
)brace
multiline_comment|/*  Update statistics.&n;&t;Unlike with the EL3 we need not worry about interrupts changing&n;&t;the window setting from underneath us, but we must still guard&n;&t;against a race condition with a StatsUpdate interrupt updating the&n;&t;table.  This is done by checking that the ASM (!) code generated uses&n;&t;atomic updates with &squot;+=&squot;.&n;&t;*/
DECL|function|update_stats
r_static
r_void
id|update_stats
c_func
(paren
r_int
id|ioaddr
comma
r_struct
id|device
op_star
id|dev
)paren
(brace
r_struct
id|vortex_private
op_star
id|vp
op_assign
(paren
r_struct
id|vortex_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
multiline_comment|/* Unlike the 3c5x9 we need not turn off stats updates while reading. */
multiline_comment|/* Switch to the stats window, and read everything. */
id|EL3WINDOW
c_func
(paren
l_int|6
)paren
suffix:semicolon
id|vp-&gt;stats.tx_carrier_errors
op_add_assign
id|inb
c_func
(paren
id|ioaddr
op_plus
l_int|0
)paren
suffix:semicolon
id|vp-&gt;stats.tx_heartbeat_errors
op_add_assign
id|inb
c_func
(paren
id|ioaddr
op_plus
l_int|1
)paren
suffix:semicolon
multiline_comment|/* Multiple collisions. */
id|inb
c_func
(paren
id|ioaddr
op_plus
l_int|2
)paren
suffix:semicolon
id|vp-&gt;stats.collisions
op_add_assign
id|inb
c_func
(paren
id|ioaddr
op_plus
l_int|3
)paren
suffix:semicolon
id|vp-&gt;stats.tx_window_errors
op_add_assign
id|inb
c_func
(paren
id|ioaddr
op_plus
l_int|4
)paren
suffix:semicolon
id|vp-&gt;stats.rx_fifo_errors
op_add_assign
id|inb
c_func
(paren
id|ioaddr
op_plus
l_int|5
)paren
suffix:semicolon
id|vp-&gt;stats.tx_packets
op_add_assign
id|inb
c_func
(paren
id|ioaddr
op_plus
l_int|6
)paren
suffix:semicolon
id|vp-&gt;stats.tx_packets
op_add_assign
(paren
id|inb
c_func
(paren
id|ioaddr
op_plus
l_int|9
)paren
op_amp
l_int|0x30
)paren
op_lshift
l_int|4
suffix:semicolon
multiline_comment|/* Rx packets&t;*/
id|inb
c_func
(paren
id|ioaddr
op_plus
l_int|7
)paren
suffix:semicolon
multiline_comment|/* Must read to clear */
multiline_comment|/* Tx deferrals */
id|inb
c_func
(paren
id|ioaddr
op_plus
l_int|8
)paren
suffix:semicolon
multiline_comment|/* Don&squot;t bother with register 9, an extension of registers 6&amp;7.&n;&t;   If we do use the 6&amp;7 values the atomic update assumption above&n;&t;   is invalid. */
id|inw
c_func
(paren
id|ioaddr
op_plus
l_int|10
)paren
suffix:semicolon
multiline_comment|/* Total Rx and Tx octets. */
id|inw
c_func
(paren
id|ioaddr
op_plus
l_int|12
)paren
suffix:semicolon
multiline_comment|/* New: On the Vortex we must also clear the BadSSD counter. */
id|EL3WINDOW
c_func
(paren
l_int|4
)paren
suffix:semicolon
id|inb
c_func
(paren
id|ioaddr
op_plus
l_int|12
)paren
suffix:semicolon
multiline_comment|/* We change back to window 7 (not 1) with the Vortex. */
id|EL3WINDOW
c_func
(paren
l_int|7
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
DECL|function|vortex_ioctl
r_static
r_int
id|vortex_ioctl
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
r_struct
id|ifreq
op_star
id|rq
comma
r_int
id|cmd
)paren
(brace
r_struct
id|vortex_private
op_star
id|vp
op_assign
(paren
r_struct
id|vortex_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_int
id|ioaddr
op_assign
id|dev-&gt;base_addr
suffix:semicolon
id|u16
op_star
id|data
op_assign
(paren
id|u16
op_star
)paren
op_amp
id|rq-&gt;ifr_data
suffix:semicolon
r_int
id|phy
op_assign
id|vp-&gt;phys
(braket
l_int|0
)braket
op_amp
l_int|0x1f
suffix:semicolon
r_switch
c_cond
(paren
id|cmd
)paren
(brace
r_case
id|SIOCDEVPRIVATE
suffix:colon
multiline_comment|/* Get the address of the PHY in use. */
id|data
(braket
l_int|0
)braket
op_assign
id|phy
suffix:semicolon
r_case
id|SIOCDEVPRIVATE
op_plus
l_int|1
suffix:colon
multiline_comment|/* Read the specified MII register. */
id|EL3WINDOW
c_func
(paren
l_int|4
)paren
suffix:semicolon
id|data
(braket
l_int|3
)braket
op_assign
id|mdio_read
c_func
(paren
id|ioaddr
comma
id|data
(braket
l_int|0
)braket
op_amp
l_int|0x1f
comma
id|data
(braket
l_int|1
)braket
op_amp
l_int|0x1f
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
r_case
id|SIOCDEVPRIVATE
op_plus
l_int|2
suffix:colon
multiline_comment|/* Write the specified MII register */
r_if
c_cond
(paren
op_logical_neg
id|suser
c_func
(paren
)paren
)paren
r_return
op_minus
id|EPERM
suffix:semicolon
id|EL3WINDOW
c_func
(paren
l_int|4
)paren
suffix:semicolon
id|mdio_write
c_func
(paren
id|ioaddr
comma
id|data
(braket
l_int|0
)braket
op_amp
l_int|0x1f
comma
id|data
(braket
l_int|1
)braket
op_amp
l_int|0x1f
comma
id|data
(braket
l_int|2
)braket
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
r_default
suffix:colon
r_return
op_minus
id|EOPNOTSUPP
suffix:semicolon
)brace
)brace
multiline_comment|/* Pre-Cyclone chips have no documented multicast filter, so the only&n;   multicast setting is to receive all multicast frames.  At least&n;   the chip has a very clean way to set the mode, unlike many others. */
DECL|function|set_rx_mode
r_static
r_void
id|set_rx_mode
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
r_int
id|ioaddr
op_assign
id|dev-&gt;base_addr
suffix:semicolon
r_int
id|new_mode
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;flags
op_amp
id|IFF_PROMISC
)paren
(brace
r_if
c_cond
(paren
id|vortex_debug
OG
l_int|0
)paren
id|printk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;%s: Setting promiscuous mode.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|new_mode
op_assign
id|SetRxFilter
op_or
id|RxStation
op_or
id|RxMulticast
op_or
id|RxBroadcast
op_or
id|RxProm
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
(paren
id|dev-&gt;mc_list
)paren
op_logical_or
(paren
id|dev-&gt;flags
op_amp
id|IFF_ALLMULTI
)paren
)paren
(brace
id|new_mode
op_assign
id|SetRxFilter
op_or
id|RxStation
op_or
id|RxMulticast
op_or
id|RxBroadcast
suffix:semicolon
)brace
r_else
id|new_mode
op_assign
id|SetRxFilter
op_or
id|RxStation
op_or
id|RxBroadcast
suffix:semicolon
id|outw
c_func
(paren
id|new_mode
comma
id|ioaddr
op_plus
id|EL3_CMD
)paren
suffix:semicolon
)brace
"&f;"
multiline_comment|/* MII transceiver control section.&n;   Read and write the MII registers using software-generated serial&n;   MDIO protocol.  See the MII specifications or DP83840A data sheet&n;   for details. */
multiline_comment|/* The maximum data clock rate is 2.5 Mhz.  The minimum timing is usually&n;   met by back-to-back PCI I/O cycles, but we insert a delay to avoid&n;   &quot;overclocking&quot; issues. */
DECL|macro|mdio_delay
mdefine_line|#define mdio_delay() inl(mdio_addr)
DECL|macro|MDIO_SHIFT_CLK
mdefine_line|#define MDIO_SHIFT_CLK&t;0x01
DECL|macro|MDIO_DIR_WRITE
mdefine_line|#define MDIO_DIR_WRITE&t;0x04
DECL|macro|MDIO_DATA_WRITE0
mdefine_line|#define MDIO_DATA_WRITE0 (0x00 | MDIO_DIR_WRITE)
DECL|macro|MDIO_DATA_WRITE1
mdefine_line|#define MDIO_DATA_WRITE1 (0x02 | MDIO_DIR_WRITE)
DECL|macro|MDIO_DATA_READ
mdefine_line|#define MDIO_DATA_READ&t;0x02
DECL|macro|MDIO_ENB_IN
mdefine_line|#define MDIO_ENB_IN&t;&t;0x00
multiline_comment|/* Generate the preamble required for initial synchronization and&n;   a few older transceivers. */
DECL|function|mdio_sync
r_static
r_void
id|mdio_sync
c_func
(paren
r_int
id|ioaddr
comma
r_int
id|bits
)paren
(brace
r_int
id|mdio_addr
op_assign
id|ioaddr
op_plus
id|Wn4_PhysicalMgmt
suffix:semicolon
multiline_comment|/* Establish sync by sending at least 32 logic ones. */
r_while
c_loop
(paren
op_decrement
id|bits
op_ge
l_int|0
)paren
(brace
id|outw
c_func
(paren
id|MDIO_DATA_WRITE1
comma
id|mdio_addr
)paren
suffix:semicolon
id|mdio_delay
c_func
(paren
)paren
suffix:semicolon
id|outw
c_func
(paren
id|MDIO_DATA_WRITE1
op_or
id|MDIO_SHIFT_CLK
comma
id|mdio_addr
)paren
suffix:semicolon
id|mdio_delay
c_func
(paren
)paren
suffix:semicolon
)brace
)brace
DECL|function|mdio_read
r_static
r_int
id|mdio_read
c_func
(paren
r_int
id|ioaddr
comma
r_int
id|phy_id
comma
r_int
id|location
)paren
(brace
r_int
id|i
suffix:semicolon
r_int
id|read_cmd
op_assign
(paren
l_int|0xf6
op_lshift
l_int|10
)paren
op_or
(paren
id|phy_id
op_lshift
l_int|5
)paren
op_or
id|location
suffix:semicolon
r_int
r_int
id|retval
op_assign
l_int|0
suffix:semicolon
r_int
id|mdio_addr
op_assign
id|ioaddr
op_plus
id|Wn4_PhysicalMgmt
suffix:semicolon
r_if
c_cond
(paren
id|mii_preamble_required
)paren
id|mdio_sync
c_func
(paren
id|ioaddr
comma
l_int|32
)paren
suffix:semicolon
multiline_comment|/* Shift the read command bits out. */
r_for
c_loop
(paren
id|i
op_assign
l_int|14
suffix:semicolon
id|i
op_ge
l_int|0
suffix:semicolon
id|i
op_decrement
)paren
(brace
r_int
id|dataval
op_assign
(paren
id|read_cmd
op_amp
(paren
l_int|1
op_lshift
id|i
)paren
)paren
ques
c_cond
id|MDIO_DATA_WRITE1
suffix:colon
id|MDIO_DATA_WRITE0
suffix:semicolon
id|outw
c_func
(paren
id|dataval
comma
id|mdio_addr
)paren
suffix:semicolon
id|mdio_delay
c_func
(paren
)paren
suffix:semicolon
id|outw
c_func
(paren
id|dataval
op_or
id|MDIO_SHIFT_CLK
comma
id|mdio_addr
)paren
suffix:semicolon
id|mdio_delay
c_func
(paren
)paren
suffix:semicolon
)brace
multiline_comment|/* Read the two transition, 16 data, and wire-idle bits. */
r_for
c_loop
(paren
id|i
op_assign
l_int|19
suffix:semicolon
id|i
OG
l_int|0
suffix:semicolon
id|i
op_decrement
)paren
(brace
id|outw
c_func
(paren
id|MDIO_ENB_IN
comma
id|mdio_addr
)paren
suffix:semicolon
id|mdio_delay
c_func
(paren
)paren
suffix:semicolon
id|retval
op_assign
(paren
id|retval
op_lshift
l_int|1
)paren
op_or
(paren
(paren
id|inw
c_func
(paren
id|mdio_addr
)paren
op_amp
id|MDIO_DATA_READ
)paren
ques
c_cond
l_int|1
suffix:colon
l_int|0
)paren
suffix:semicolon
id|outw
c_func
(paren
id|MDIO_ENB_IN
op_or
id|MDIO_SHIFT_CLK
comma
id|mdio_addr
)paren
suffix:semicolon
id|mdio_delay
c_func
(paren
)paren
suffix:semicolon
)brace
macro_line|#if 0
r_return
(paren
id|retval
op_rshift
l_int|1
)paren
op_amp
l_int|0x1ffff
suffix:semicolon
macro_line|#else
r_return
id|retval
op_amp
l_int|0x20000
ques
c_cond
l_int|0xffff
suffix:colon
id|retval
op_rshift
l_int|1
op_amp
l_int|0xffff
suffix:semicolon
macro_line|#endif
)brace
DECL|function|mdio_write
r_static
r_void
id|mdio_write
c_func
(paren
r_int
id|ioaddr
comma
r_int
id|phy_id
comma
r_int
id|location
comma
r_int
id|value
)paren
(brace
r_int
id|write_cmd
op_assign
l_int|0x50020000
op_or
(paren
id|phy_id
op_lshift
l_int|23
)paren
op_or
(paren
id|location
op_lshift
l_int|18
)paren
op_or
id|value
suffix:semicolon
r_int
id|mdio_addr
op_assign
id|ioaddr
op_plus
id|Wn4_PhysicalMgmt
suffix:semicolon
r_int
id|i
suffix:semicolon
r_if
c_cond
(paren
id|mii_preamble_required
)paren
id|mdio_sync
c_func
(paren
id|ioaddr
comma
l_int|32
)paren
suffix:semicolon
multiline_comment|/* Shift the command bits out. */
r_for
c_loop
(paren
id|i
op_assign
l_int|31
suffix:semicolon
id|i
op_ge
l_int|0
suffix:semicolon
id|i
op_decrement
)paren
(brace
r_int
id|dataval
op_assign
(paren
id|write_cmd
op_amp
(paren
l_int|1
op_lshift
id|i
)paren
)paren
ques
c_cond
id|MDIO_DATA_WRITE1
suffix:colon
id|MDIO_DATA_WRITE0
suffix:semicolon
id|outw
c_func
(paren
id|dataval
comma
id|mdio_addr
)paren
suffix:semicolon
id|mdio_delay
c_func
(paren
)paren
suffix:semicolon
id|outw
c_func
(paren
id|dataval
op_or
id|MDIO_SHIFT_CLK
comma
id|mdio_addr
)paren
suffix:semicolon
id|mdio_delay
c_func
(paren
)paren
suffix:semicolon
)brace
multiline_comment|/* Leave the interface idle. */
r_for
c_loop
(paren
id|i
op_assign
l_int|1
suffix:semicolon
id|i
op_ge
l_int|0
suffix:semicolon
id|i
op_decrement
)paren
(brace
id|outw
c_func
(paren
id|MDIO_ENB_IN
comma
id|mdio_addr
)paren
suffix:semicolon
id|mdio_delay
c_func
(paren
)paren
suffix:semicolon
id|outw
c_func
(paren
id|MDIO_ENB_IN
op_or
id|MDIO_SHIFT_CLK
comma
id|mdio_addr
)paren
suffix:semicolon
id|mdio_delay
c_func
(paren
)paren
suffix:semicolon
)brace
r_return
suffix:semicolon
)brace
"&f;"
macro_line|#ifdef MODULE
DECL|function|cleanup_module
r_void
id|cleanup_module
c_func
(paren
r_void
)paren
(brace
r_struct
id|device
op_star
id|next_dev
suffix:semicolon
macro_line|#ifdef CARDBUS
id|unregister_driver
c_func
(paren
op_amp
id|vortex_ops
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/* No need to check MOD_IN_USE, as sys_delete_module() checks. */
r_while
c_loop
(paren
id|root_vortex_dev
)paren
(brace
r_struct
id|vortex_private
op_star
id|vp
op_assign
(paren
r_void
op_star
)paren
(paren
id|root_vortex_dev-&gt;priv
)paren
suffix:semicolon
id|next_dev
op_assign
id|vp-&gt;next_module
suffix:semicolon
id|unregister_netdev
c_func
(paren
id|root_vortex_dev
)paren
suffix:semicolon
id|outw
c_func
(paren
id|TotalReset
comma
id|root_vortex_dev-&gt;base_addr
op_plus
id|EL3_CMD
)paren
suffix:semicolon
id|release_region
c_func
(paren
id|root_vortex_dev-&gt;base_addr
comma
id|pci_tbl
(braket
id|vp-&gt;chip_id
)braket
dot
id|io_size
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|root_vortex_dev
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|vp-&gt;priv_addr
)paren
suffix:semicolon
id|root_vortex_dev
op_assign
id|next_dev
suffix:semicolon
)brace
)brace
macro_line|#endif  /* MODULE */
"&f;"
multiline_comment|/*&n; * Local variables:&n; *  compile-command: &quot;gcc -DMODULE -D__KERNEL__ -Wall -Wstrict-prototypes -O6 -c 3c59x.c `[ -f /usr/include/linux/modversions.h ] &amp;&amp; echo -DMODVERSIONS`&quot;&n; *  SMP-compile-command: &quot;gcc -D__SMP__ -DMODULE -D__KERNEL__ -Wall -Wstrict-prototypes -O6 -c 3c59x.c&quot;&n; *  cardbus-compile-command: &quot;gcc -DCARDBUS -DMODULE -D__KERNEL__ -Wall -Wstrict-prototypes -O6 -c 3c59x.c -o 3c575_cb.o -I/usr/src/pcmcia-cs-3.0.5/include/&quot;&n; *  c-indent-level: 4&n; *  c-basic-offset: 4&n; *  tab-width: 4&n; * End:&n; */
eof
