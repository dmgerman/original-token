multiline_comment|/* 3c59x.c: A 3Com 3c590/3c595 &quot;Vortex&quot; ethernet driver for linux. */
multiline_comment|/*&n;&t;Written 1995 by Donald Becker.&n;&n;&t;This software may be used and distributed according to the terms&n;&t;of the GNU Public License, incorporated herein by reference.&n;&n;&t;This driver is for the 3Com &quot;Vortex&quot; series ethercards.  Members of&n;&t;the series include the 3c590 PCI EtherLink III and 3c595-Tx PCI Fast&n;&t;EtherLink.  It also works with the 10Mbs-only 3c590 PCI EtherLink III.&n;&n;&t;The author may be reached as becker@CESDIS.gsfc.nasa.gov, or C/O&n;&t;Center of Excellence in Space Data and Information Sciences&n;&t;   Code 930.5, Goddard Space Flight Center, Greenbelt MD 20771&n;*/
DECL|variable|version
r_static
r_char
op_star
id|version
op_assign
l_string|&quot;3c59x.c:v0.13 2/13/96 becker@cesdis.gsfc.nasa.gov&bslash;n&quot;
suffix:semicolon
multiline_comment|/* &quot;Knobs&quot; that turn on special features. */
multiline_comment|/* Allow the use of bus master transfers instead of programmed-I/O for the&n;   Tx process.  Bus master transfers are always disabled by default, but&n;   iff this is set they may be turned on using &squot;options&squot;. */
DECL|macro|VORTEX_BUS_MASTER
mdefine_line|#define VORTEX_BUS_MASTER
multiline_comment|/* Put out somewhat more debugging messages. (0 - no msg, 1 minimal msgs). */
DECL|macro|VORTEX_DEBUG
mdefine_line|#define VORTEX_DEBUG 1
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/ptrace.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/in.h&gt;
macro_line|#include &lt;linux/ioport.h&gt;
macro_line|#include &lt;linux/malloc.h&gt;
macro_line|#include &lt;linux/interrupt.h&gt;
macro_line|#include &lt;linux/pci.h&gt;
macro_line|#include &lt;linux/bios32.h&gt;
macro_line|#include &lt;linux/timer.h&gt;
macro_line|#include &lt;asm/bitops.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;linux/netdevice.h&gt;
macro_line|#include &lt;linux/etherdevice.h&gt;
macro_line|#include &lt;linux/skbuff.h&gt;
macro_line|#ifdef HAVE_SHARED_IRQ
DECL|macro|USE_SHARED_IRQ
mdefine_line|#define USE_SHARED_IRQ
macro_line|#include &lt;linux/shared_irq.h&gt;
macro_line|#endif
multiline_comment|/* The total size is twice that of the original EtherLinkIII series: the&n;   runtime register window, window 1, is now always mapped in. */
DECL|macro|VORTEX_TOTAL_SIZE
mdefine_line|#define VORTEX_TOTAL_SIZE 0x20
macro_line|#ifdef HAVE_DEVLIST
DECL|variable|tc59x_drv
r_struct
id|netdev_entry
id|tc59x_drv
op_assign
(brace
l_string|&quot;Vortex&quot;
comma
id|vortex_pci_probe
comma
id|VORTEX_TOTAL_SIZE
comma
l_int|NULL
)brace
suffix:semicolon
macro_line|#endif
macro_line|#ifdef VORTEX_DEBUG
DECL|variable|vortex_debug
r_int
id|vortex_debug
op_assign
id|VORTEX_DEBUG
suffix:semicolon
macro_line|#else
DECL|variable|vortex_debug
r_int
id|vortex_debug
op_assign
l_int|1
suffix:semicolon
macro_line|#endif
DECL|variable|product_ids
r_static
r_int
id|product_ids
(braket
)braket
op_assign
(brace
l_int|0x5900
comma
l_int|0x5950
comma
l_int|0x5951
comma
l_int|0x5952
comma
l_int|0
comma
l_int|0
)brace
suffix:semicolon
DECL|variable|product_names
r_static
r_const
r_char
op_star
id|product_names
(braket
)braket
op_assign
(brace
l_string|&quot;3c590 Vortex 10Mbps&quot;
comma
l_string|&quot;3c595 Vortex 100baseTX&quot;
comma
l_string|&quot;3c595 Vortex 100baseT4&quot;
comma
l_string|&quot;3c595 Vortex 100base-MII&quot;
comma
l_string|&quot;EISA Vortex 3c597&quot;
comma
)brace
suffix:semicolon
DECL|macro|DEMON_INDEX
mdefine_line|#define DEMON_INDEX 5&t;&t;&t;/* Caution!  Must be consistent with above! */
multiline_comment|/*&n;&t;&t;&t;&t;Theory of Operation&n;&n;I. Board Compatibility&n;&n;This device driver is designed for the 3Com FastEtherLink, 3Com&squot;s PCI to&n;10/100baseT adapter.  It also works with the 3c590, a similar product&n;with only a 10Mbs interface.&n;&n;II. Board-specific settings&n;&n;PCI bus devices are configured by the system at boot time, so no jumpers&n;need to be set on the board.  The system BIOS should be set to assign the&n;PCI INTA signal to an otherwise unused system IRQ line.  While it&squot;s&n;physically possible to shared PCI interrupt lines, the 1.2.0 kernel doesn&squot;t&n;support it.&n;&n;III. Driver operation&n;&n;The 3c59x series use an interface that&squot;s very similar to the previous 3c5x9&n;series.  The primary interface is two programmed-I/O FIFOs, with an&n;alternate single-contiguous-region bus-master transfer (see next).&n;&n;One extension that is advertised in a very large font is that the adapters&n;are capable of being bus masters.  Unfortunately this capability is only for&n;a single contiguous region making it less useful than the list of transfer&n;regions available with the DEC Tulip or AMD PCnet.  Given the significant&n;performance impact of taking an extra interrupt for each transfer, using&n;DMA transfers is a win only with large blocks.&n;&n;IIIC. Synchronization&n;The driver runs as two independent, single-threaded flows of control.  One&n;is the send-packet routine, which enforces single-threaded use by the&n;dev-&gt;tbusy flag.  The other thread is the interrupt handler, which is single&n;threaded by the hardware and other software.&n;&n;IV. Notes&n;&n;Thanks to Cameron Spitzer and Terry Murphy of 3Com for providing both&n;3c590 and 3c595 boards.&n;The name &quot;Vortex&quot; is the internal 3Com project name for the PCI ASIC, and&n;the not-yet-released (3/95) EISA version is called &quot;Demon&quot;.  According to&n;Terry these names come from rides at the local amusement park.&n;&n;The new chips support both ethernet (1.5K) and FDDI (4.5K) packet sizes!&n;This driver only supports ethernet packets because of the skbuff allocation&n;limit of 4K.&n;*/
DECL|macro|TCOM_VENDOR_ID
mdefine_line|#define TCOM_VENDOR_ID&t;0x10B7&t;&t;/* 3Com&squot;s manufacturer&squot;s ID. */
multiline_comment|/* Operational defintions.&n;   These are not used by other compilation units and thus are not&n;   exported in a &quot;.h&quot; file.&n;&n;   First the windows.  There are eight register windows, with the command&n;   and status registers available in each.&n;   */
DECL|macro|EL3WINDOW
mdefine_line|#define EL3WINDOW(win_num) outw(SelectWindow + (win_num), ioaddr + EL3_CMD)
DECL|macro|EL3_CMD
mdefine_line|#define EL3_CMD 0x0e
DECL|macro|EL3_STATUS
mdefine_line|#define EL3_STATUS 0x0e
multiline_comment|/* The top five bits written to EL3_CMD are a command, the lower&n;   11 bits are the parameter, if applicable.&n;   Note that 11 parameters bits was fine for ethernet, but the new chip&n;   can handle FDDI lenght frames (~4500 octets) and now parameters count&n;   32-bit &squot;Dwords&squot; rather than octets. */
DECL|enum|vortex_cmd
r_enum
id|vortex_cmd
(brace
DECL|enumerator|TotalReset
DECL|enumerator|SelectWindow
DECL|enumerator|StartCoax
id|TotalReset
op_assign
l_int|0
op_lshift
l_int|11
comma
id|SelectWindow
op_assign
l_int|1
op_lshift
l_int|11
comma
id|StartCoax
op_assign
l_int|2
op_lshift
l_int|11
comma
DECL|enumerator|RxDisable
DECL|enumerator|RxEnable
DECL|enumerator|RxReset
DECL|enumerator|RxDiscard
id|RxDisable
op_assign
l_int|3
op_lshift
l_int|11
comma
id|RxEnable
op_assign
l_int|4
op_lshift
l_int|11
comma
id|RxReset
op_assign
l_int|5
op_lshift
l_int|11
comma
id|RxDiscard
op_assign
l_int|8
op_lshift
l_int|11
comma
DECL|enumerator|TxEnable
DECL|enumerator|TxDisable
DECL|enumerator|TxReset
id|TxEnable
op_assign
l_int|9
op_lshift
l_int|11
comma
id|TxDisable
op_assign
l_int|10
op_lshift
l_int|11
comma
id|TxReset
op_assign
l_int|11
op_lshift
l_int|11
comma
DECL|enumerator|FakeIntr
DECL|enumerator|AckIntr
DECL|enumerator|SetIntrEnb
id|FakeIntr
op_assign
l_int|12
op_lshift
l_int|11
comma
id|AckIntr
op_assign
l_int|13
op_lshift
l_int|11
comma
id|SetIntrEnb
op_assign
l_int|14
op_lshift
l_int|11
comma
DECL|enumerator|SetStatusEnb
DECL|enumerator|SetRxFilter
DECL|enumerator|SetRxThreshold
id|SetStatusEnb
op_assign
l_int|15
op_lshift
l_int|11
comma
id|SetRxFilter
op_assign
l_int|16
op_lshift
l_int|11
comma
id|SetRxThreshold
op_assign
l_int|17
op_lshift
l_int|11
comma
DECL|enumerator|SetTxThreshold
DECL|enumerator|SetTxStart
id|SetTxThreshold
op_assign
l_int|18
op_lshift
l_int|11
comma
id|SetTxStart
op_assign
l_int|19
op_lshift
l_int|11
comma
DECL|enumerator|StartDMAUp
DECL|enumerator|StartDMADown
DECL|enumerator|StatsEnable
id|StartDMAUp
op_assign
l_int|20
op_lshift
l_int|11
comma
id|StartDMADown
op_assign
(paren
l_int|20
op_lshift
l_int|11
)paren
op_plus
l_int|1
comma
id|StatsEnable
op_assign
l_int|21
op_lshift
l_int|11
comma
DECL|enumerator|StatsDisable
DECL|enumerator|StopCoax
id|StatsDisable
op_assign
l_int|22
op_lshift
l_int|11
comma
id|StopCoax
op_assign
l_int|23
op_lshift
l_int|11
comma
)brace
suffix:semicolon
multiline_comment|/* The SetRxFilter command accepts the following classes: */
DECL|enum|RxFilter
r_enum
id|RxFilter
(brace
DECL|enumerator|RxStation
DECL|enumerator|RxMulticast
DECL|enumerator|RxBroadcast
DECL|enumerator|RxProm
id|RxStation
op_assign
l_int|1
comma
id|RxMulticast
op_assign
l_int|2
comma
id|RxBroadcast
op_assign
l_int|4
comma
id|RxProm
op_assign
l_int|8
)brace
suffix:semicolon
multiline_comment|/* Bits in the general status register. */
DECL|enum|vortex_status
r_enum
id|vortex_status
(brace
DECL|enumerator|IntLatch
DECL|enumerator|AdapterFailure
DECL|enumerator|TxComplete
id|IntLatch
op_assign
l_int|0x0001
comma
id|AdapterFailure
op_assign
l_int|0x0002
comma
id|TxComplete
op_assign
l_int|0x0004
comma
DECL|enumerator|TxAvailable
DECL|enumerator|RxComplete
DECL|enumerator|RxEarly
id|TxAvailable
op_assign
l_int|0x0008
comma
id|RxComplete
op_assign
l_int|0x0010
comma
id|RxEarly
op_assign
l_int|0x0020
comma
DECL|enumerator|IntReq
DECL|enumerator|StatsFull
DECL|enumerator|DMADone
id|IntReq
op_assign
l_int|0x0040
comma
id|StatsFull
op_assign
l_int|0x0080
comma
id|DMADone
op_assign
l_int|1
op_lshift
l_int|8
comma
DECL|enumerator|DMAInProgress
id|DMAInProgress
op_assign
l_int|1
op_lshift
l_int|11
comma
multiline_comment|/* DMA controller is still busy.*/
DECL|enumerator|CmdInProgress
id|CmdInProgress
op_assign
l_int|1
op_lshift
l_int|12
comma
multiline_comment|/* EL3_CMD is still busy.*/
)brace
suffix:semicolon
multiline_comment|/* Register window 1 offsets, the window used in normal operation.&n;   On the Vortex this window is always mapped at offsets 0x10-0x1f. */
DECL|enum|Window1
r_enum
id|Window1
(brace
DECL|enumerator|TX_FIFO
DECL|enumerator|RX_FIFO
DECL|enumerator|RxErrors
id|TX_FIFO
op_assign
l_int|0x10
comma
id|RX_FIFO
op_assign
l_int|0x10
comma
id|RxErrors
op_assign
l_int|0x14
comma
DECL|enumerator|RxStatus
DECL|enumerator|Timer
DECL|enumerator|TxStatus
id|RxStatus
op_assign
l_int|0x18
comma
id|Timer
op_assign
l_int|0x1A
comma
id|TxStatus
op_assign
l_int|0x1B
comma
DECL|enumerator|TxFree
id|TxFree
op_assign
l_int|0x1C
comma
multiline_comment|/* Remaining free bytes in Tx buffer. */
)brace
suffix:semicolon
DECL|enum|Window0
r_enum
id|Window0
(brace
DECL|enumerator|Wn0EepromCmd
id|Wn0EepromCmd
op_assign
l_int|10
comma
multiline_comment|/* Window 0: EEPROM command register. */
)brace
suffix:semicolon
DECL|enum|Win0_EEPROM_bits
r_enum
id|Win0_EEPROM_bits
(brace
DECL|enumerator|EEPROM_Read
DECL|enumerator|EEPROM_WRITE
DECL|enumerator|EEPROM_ERASE
id|EEPROM_Read
op_assign
l_int|0x80
comma
id|EEPROM_WRITE
op_assign
l_int|0x40
comma
id|EEPROM_ERASE
op_assign
l_int|0xC0
comma
DECL|enumerator|EEPROM_EWENB
id|EEPROM_EWENB
op_assign
l_int|0x30
comma
multiline_comment|/* Enable erasing/writing for 10 msec. */
DECL|enumerator|EEPROM_EWDIS
id|EEPROM_EWDIS
op_assign
l_int|0x00
comma
multiline_comment|/* Disable EWENB before 10 msec timeout. */
)brace
suffix:semicolon
multiline_comment|/* EEPROM locations. */
DECL|enum|eeprom_offset
r_enum
id|eeprom_offset
(brace
DECL|enumerator|PhysAddr01
DECL|enumerator|PhysAddr23
DECL|enumerator|PhysAddr45
DECL|enumerator|ModelID
id|PhysAddr01
op_assign
l_int|0
comma
id|PhysAddr23
op_assign
l_int|1
comma
id|PhysAddr45
op_assign
l_int|2
comma
id|ModelID
op_assign
l_int|3
comma
DECL|enumerator|EtherLink3ID
DECL|enumerator|IFXcvrIO
DECL|enumerator|IRQLine
id|EtherLink3ID
op_assign
l_int|7
comma
id|IFXcvrIO
op_assign
l_int|8
comma
id|IRQLine
op_assign
l_int|9
comma
DECL|enumerator|NodeAddr01
DECL|enumerator|NodeAddr23
DECL|enumerator|NodeAddr45
id|NodeAddr01
op_assign
l_int|10
comma
id|NodeAddr23
op_assign
l_int|11
comma
id|NodeAddr45
op_assign
l_int|12
comma
DECL|enumerator|DriverTune
DECL|enumerator|Checksum
id|DriverTune
op_assign
l_int|13
comma
id|Checksum
op_assign
l_int|15
)brace
suffix:semicolon
DECL|enum|Window3
r_enum
id|Window3
(brace
multiline_comment|/* Window 3: MAC/config bits. */
DECL|enumerator|Wn3_Config
DECL|enumerator|Wn3_MAC_Ctrl
DECL|enumerator|Wn3_Options
id|Wn3_Config
op_assign
l_int|0
comma
id|Wn3_MAC_Ctrl
op_assign
l_int|6
comma
id|Wn3_Options
op_assign
l_int|8
comma
)brace
suffix:semicolon
DECL|union|wn3_config
r_union
id|wn3_config
(brace
DECL|member|i
r_int
id|i
suffix:semicolon
DECL|struct|w3_config_fields
r_struct
id|w3_config_fields
(brace
DECL|member|ram_size
DECL|member|ram_width
DECL|member|ram_speed
DECL|member|rom_size
r_int
r_int
id|ram_size
suffix:colon
l_int|3
comma
id|ram_width
suffix:colon
l_int|1
comma
id|ram_speed
suffix:colon
l_int|2
comma
id|rom_size
suffix:colon
l_int|2
suffix:semicolon
DECL|member|pad8
r_int
id|pad8
suffix:colon
l_int|8
suffix:semicolon
DECL|member|ram_split
DECL|member|pad18
DECL|member|xcvr
DECL|member|pad21
DECL|member|autoselect
r_int
r_int
id|ram_split
suffix:colon
l_int|2
comma
id|pad18
suffix:colon
l_int|2
comma
id|xcvr
suffix:colon
l_int|3
comma
id|pad21
suffix:colon
l_int|1
comma
id|autoselect
suffix:colon
l_int|1
suffix:semicolon
DECL|member|pad24
r_int
id|pad24
suffix:colon
l_int|8
suffix:semicolon
DECL|member|u
)brace
id|u
suffix:semicolon
)brace
suffix:semicolon
DECL|enum|Window4
r_enum
id|Window4
(brace
DECL|enumerator|Wn4_Media
id|Wn4_Media
op_assign
l_int|0x0A
comma
multiline_comment|/* Window 4: Various transcvr/media bits. */
)brace
suffix:semicolon
DECL|enum|Win4_Media_bits
r_enum
id|Win4_Media_bits
(brace
DECL|enumerator|Media_TP
id|Media_TP
op_assign
l_int|0x00C0
comma
multiline_comment|/* Enable link beat and jabber for 10baseT. */
)brace
suffix:semicolon
DECL|enum|Window7
r_enum
id|Window7
(brace
multiline_comment|/* Window 7: Bus Master control. */
DECL|enumerator|Wn7_MasterAddr
DECL|enumerator|Wn7_MasterLen
DECL|enumerator|Wn7_MasterStatus
id|Wn7_MasterAddr
op_assign
l_int|0
comma
id|Wn7_MasterLen
op_assign
l_int|6
comma
id|Wn7_MasterStatus
op_assign
l_int|12
comma
)brace
suffix:semicolon
DECL|struct|vortex_private
r_struct
id|vortex_private
(brace
DECL|member|devname
r_char
id|devname
(braket
l_int|8
)braket
suffix:semicolon
multiline_comment|/* &quot;ethN&quot; string, also for kernel debug. */
DECL|member|product_name
r_const
r_char
op_star
id|product_name
suffix:semicolon
DECL|member|next_module
r_struct
id|device
op_star
id|next_module
suffix:semicolon
DECL|member|stats
r_struct
id|enet_statistics
id|stats
suffix:semicolon
macro_line|#ifdef VORTEX_BUS_MASTER
DECL|member|tx_skb
r_struct
id|sk_buff
op_star
id|tx_skb
suffix:semicolon
multiline_comment|/* Packet being eaten by bus master ctrl.  */
macro_line|#endif
DECL|member|timer
r_struct
id|timer_list
id|timer
suffix:semicolon
multiline_comment|/* Media selection timer. */
DECL|member|options
r_int
id|options
suffix:semicolon
multiline_comment|/* User-settable driver options (none yet). */
DECL|member|media_override
DECL|member|full_duplex
DECL|member|bus_master
DECL|member|autoselect
r_int
r_int
id|media_override
suffix:colon
l_int|3
comma
id|full_duplex
suffix:colon
l_int|1
comma
id|bus_master
suffix:colon
l_int|1
comma
id|autoselect
suffix:colon
l_int|1
suffix:semicolon
)brace
suffix:semicolon
DECL|variable|if_names
r_static
r_char
op_star
id|if_names
(braket
)braket
op_assign
(brace
l_string|&quot;10baseT&quot;
comma
l_string|&quot;10Mbs AUI&quot;
comma
l_string|&quot;undefined&quot;
comma
l_string|&quot;10base2&quot;
comma
l_string|&quot;100baseTX&quot;
comma
l_string|&quot;100baseFX&quot;
comma
l_string|&quot;MII&quot;
comma
l_string|&quot;undefined&quot;
)brace
suffix:semicolon
r_static
r_int
id|vortex_scan
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_int
id|vortex_found_device
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
r_int
id|ioaddr
comma
r_int
id|irq
comma
r_int
id|product_index
comma
r_int
id|options
)paren
suffix:semicolon
r_static
r_int
id|vortex_probe1
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_int
id|vortex_open
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_void
id|vortex_timer
c_func
(paren
r_int
r_int
id|arg
)paren
suffix:semicolon
r_static
r_int
id|vortex_start_xmit
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_int
id|vortex_rx
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_void
id|vortex_interrupt
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
suffix:semicolon
r_static
r_int
id|vortex_close
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_void
id|update_stats
c_func
(paren
r_int
id|addr
comma
r_struct
id|device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_struct
id|enet_statistics
op_star
id|vortex_get_stats
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_void
id|set_multicast_list
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
suffix:semicolon
"&f;"
multiline_comment|/* Unlike the other PCI cards the 59x cards don&squot;t need a large contiguous&n;   memory region, so making the driver a loadable module is feasible.&n;&n;   Unfortuneately maximizing the shared code between the integrated and&n;   module version of the driver results in a complicated set of initialization&n;   procedures.&n;   init_module() -- modules /  tc59x_init()  -- built-in&n;&t;&t;The wrappers for vortex_scan()&n;   vortex_scan()  &t;&t; The common routine that scans for PCI and EISA cards&n;   vortex_found_device() Allocate a device structure when we find a card.&n;&t;&t;&t;&t;&t;Different versions exist for modules and built-in.&n;   vortex_probe1()&t;&t;Fill in the device structure -- this is seperated&n;&t;&t;&t;&t;&t;so that the modules code can put it in dev-&gt;init.&n;*/
multiline_comment|/* This driver uses &squot;options&squot; to pass the media type, full-duplex flag, etc. */
multiline_comment|/* Note: this is the only limit on the number of cards supported!! */
DECL|variable|options
r_int
id|options
(braket
l_int|8
)braket
op_assign
(brace
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
)brace
suffix:semicolon
macro_line|#ifdef MODULE
DECL|variable|debug
r_static
r_int
id|debug
op_assign
op_minus
l_int|1
suffix:semicolon
multiline_comment|/* A list of all installed Vortex devices, for removing the driver module. */
DECL|variable|root_vortex_dev
r_static
r_struct
id|device
op_star
id|root_vortex_dev
op_assign
l_int|NULL
suffix:semicolon
r_int
DECL|function|init_module
id|init_module
c_func
(paren
r_void
)paren
(brace
r_int
id|cards_found
suffix:semicolon
r_if
c_cond
(paren
id|debug
op_ge
l_int|0
)paren
id|vortex_debug
op_assign
id|debug
suffix:semicolon
r_if
c_cond
(paren
id|vortex_debug
)paren
id|printk
c_func
(paren
id|version
)paren
suffix:semicolon
id|root_vortex_dev
op_assign
l_int|NULL
suffix:semicolon
id|cards_found
op_assign
id|vortex_scan
c_func
(paren
l_int|0
)paren
suffix:semicolon
r_return
id|cards_found
OL
l_int|0
ques
c_cond
id|cards_found
suffix:colon
l_int|0
suffix:semicolon
)brace
macro_line|#else
DECL|function|tc59x_probe
r_int
r_int
id|tc59x_probe
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
r_int
id|cards_found
op_assign
l_int|0
suffix:semicolon
id|cards_found
op_assign
id|vortex_scan
c_func
(paren
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|vortex_debug
OG
l_int|0
op_logical_and
id|cards_found
)paren
id|printk
c_func
(paren
id|version
)paren
suffix:semicolon
r_return
id|cards_found
ques
c_cond
l_int|0
suffix:colon
op_minus
id|ENODEV
suffix:semicolon
)brace
macro_line|#endif  /* not MODULE */
DECL|function|vortex_scan
r_static
r_int
id|vortex_scan
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
r_int
id|cards_found
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|pcibios_present
c_func
(paren
)paren
)paren
(brace
r_static
r_int
id|pci_index
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
suffix:semicolon
id|pci_index
OL
l_int|8
suffix:semicolon
id|pci_index
op_increment
)paren
(brace
r_int
r_char
id|pci_bus
comma
id|pci_device_fn
comma
id|pci_irq_line
comma
id|pci_latency
suffix:semicolon
r_int
r_int
id|pci_ioaddr
suffix:semicolon
r_int
r_int
id|pci_command
suffix:semicolon
r_int
id|index
suffix:semicolon
r_for
c_loop
(paren
id|index
op_assign
l_int|0
suffix:semicolon
id|product_ids
(braket
id|index
)braket
suffix:semicolon
id|index
op_increment
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|pcibios_find_device
c_func
(paren
id|TCOM_VENDOR_ID
comma
id|product_ids
(braket
id|index
)braket
comma
id|pci_index
comma
op_amp
id|pci_bus
comma
op_amp
id|pci_device_fn
)paren
)paren
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|product_ids
(braket
id|index
)braket
)paren
r_break
suffix:semicolon
id|pcibios_read_config_byte
c_func
(paren
id|pci_bus
comma
id|pci_device_fn
comma
id|PCI_INTERRUPT_LINE
comma
op_amp
id|pci_irq_line
)paren
suffix:semicolon
id|pcibios_read_config_dword
c_func
(paren
id|pci_bus
comma
id|pci_device_fn
comma
id|PCI_BASE_ADDRESS_0
comma
op_amp
id|pci_ioaddr
)paren
suffix:semicolon
multiline_comment|/* Remove I/O space marker in bit 0. */
id|pci_ioaddr
op_and_assign
op_complement
l_int|3
suffix:semicolon
macro_line|#ifdef VORTEX_BUS_MASTER
multiline_comment|/* Get and check the bus-master and latency values.&n;&t;&t;&t;   Some PCI BIOSes fail to set the master-enable bit, and&n;&t;&t;&t;   the latency timer must be set to the maximum value to avoid&n;&t;&t;&t;   data corruption that occurs when the timer expires during&n;&t;&t;&t;   a transfer.  Yes, it&squot;s a bug. */
id|pcibios_read_config_word
c_func
(paren
id|pci_bus
comma
id|pci_device_fn
comma
id|PCI_COMMAND
comma
op_amp
id|pci_command
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|pci_command
op_amp
id|PCI_COMMAND_MASTER
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;  PCI Master Bit has not been set! Setting...&bslash;n&quot;
)paren
suffix:semicolon
id|pci_command
op_or_assign
id|PCI_COMMAND_MASTER
suffix:semicolon
id|pcibios_write_config_word
c_func
(paren
id|pci_bus
comma
id|pci_device_fn
comma
id|PCI_COMMAND
comma
id|pci_command
)paren
suffix:semicolon
)brace
id|pcibios_read_config_byte
c_func
(paren
id|pci_bus
comma
id|pci_device_fn
comma
id|PCI_LATENCY_TIMER
comma
op_amp
id|pci_latency
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pci_latency
op_ne
l_int|255
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;  Overriding PCI latency timer (CFLT) setting of %d, new value is 255.&bslash;n&quot;
comma
id|pci_latency
)paren
suffix:semicolon
id|pcibios_write_config_byte
c_func
(paren
id|pci_bus
comma
id|pci_device_fn
comma
id|PCI_LATENCY_TIMER
comma
l_int|255
)paren
suffix:semicolon
)brace
macro_line|#endif  /* VORTEX_BUS_MASTER */
id|vortex_found_device
c_func
(paren
id|dev
comma
id|pci_ioaddr
comma
id|pci_irq_line
comma
id|index
comma
id|dev
op_logical_and
id|dev-&gt;mem_start
ques
c_cond
id|dev-&gt;mem_start
suffix:colon
id|options
(braket
id|cards_found
)braket
)paren
suffix:semicolon
id|dev
op_assign
l_int|0
suffix:semicolon
id|cards_found
op_increment
suffix:semicolon
)brace
)brace
multiline_comment|/* Now check all slots of the EISA bus. */
r_if
c_cond
(paren
id|EISA_bus
)paren
(brace
r_static
r_int
id|ioaddr
op_assign
l_int|0x1000
suffix:semicolon
r_for
c_loop
(paren
id|ioaddr
op_assign
l_int|0x1000
suffix:semicolon
id|ioaddr
OL
l_int|0x9000
suffix:semicolon
id|ioaddr
op_add_assign
l_int|0x1000
)paren
(brace
multiline_comment|/* Check the standard EISA ID register for an encoded &squot;3Com&squot;. */
r_if
c_cond
(paren
id|inw
c_func
(paren
id|ioaddr
op_plus
l_int|0xC80
)paren
op_ne
l_int|0x6d50
)paren
r_continue
suffix:semicolon
multiline_comment|/* Check for a product that we support. */
r_if
c_cond
(paren
(paren
id|inw
c_func
(paren
id|ioaddr
op_plus
l_int|0xC82
)paren
op_amp
l_int|0xFFF0
)paren
op_ne
l_int|0x5970
op_logical_and
(paren
id|inw
c_func
(paren
id|ioaddr
op_plus
l_int|0xC82
)paren
op_amp
l_int|0xFFF0
)paren
op_ne
l_int|0x5920
)paren
r_continue
suffix:semicolon
id|vortex_found_device
c_func
(paren
id|dev
comma
id|ioaddr
comma
id|inw
c_func
(paren
id|ioaddr
op_plus
l_int|0xC88
)paren
op_rshift
l_int|12
comma
id|DEMON_INDEX
comma
id|dev
op_logical_and
id|dev-&gt;mem_start
ques
c_cond
id|dev-&gt;mem_start
suffix:colon
id|options
(braket
id|cards_found
)braket
)paren
suffix:semicolon
id|dev
op_assign
l_int|0
suffix:semicolon
id|cards_found
op_increment
suffix:semicolon
)brace
)brace
r_return
id|cards_found
suffix:semicolon
)brace
DECL|function|vortex_found_device
r_static
r_int
id|vortex_found_device
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
r_int
id|ioaddr
comma
r_int
id|irq
comma
r_int
id|product_index
comma
r_int
id|options
)paren
(brace
r_struct
id|vortex_private
op_star
id|vp
suffix:semicolon
macro_line|#ifdef MODULE
multiline_comment|/* Allocate and fill new device structure. */
r_int
id|dev_size
op_assign
r_sizeof
(paren
r_struct
id|device
)paren
op_plus
r_sizeof
(paren
r_struct
id|vortex_private
)paren
suffix:semicolon
id|dev
op_assign
(paren
r_struct
id|device
op_star
)paren
id|kmalloc
c_func
(paren
id|dev_size
comma
id|GFP_KERNEL
)paren
suffix:semicolon
id|memset
c_func
(paren
id|dev
comma
l_int|0
comma
id|dev_size
)paren
suffix:semicolon
id|dev-&gt;priv
op_assign
(paren
(paren
r_void
op_star
)paren
id|dev
)paren
op_plus
r_sizeof
(paren
r_struct
id|device
)paren
suffix:semicolon
id|vp
op_assign
(paren
r_struct
id|vortex_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|dev-&gt;name
op_assign
id|vp-&gt;devname
suffix:semicolon
multiline_comment|/* An empty string. */
id|dev-&gt;base_addr
op_assign
id|ioaddr
suffix:semicolon
id|dev-&gt;irq
op_assign
id|irq
suffix:semicolon
id|dev-&gt;init
op_assign
id|vortex_probe1
suffix:semicolon
id|vp-&gt;product_name
op_assign
id|product_names
(braket
id|product_index
)braket
suffix:semicolon
id|vp-&gt;options
op_assign
id|options
suffix:semicolon
r_if
c_cond
(paren
id|options
op_ge
l_int|0
)paren
(brace
id|vp-&gt;media_override
op_assign
(paren
(paren
id|options
op_amp
l_int|7
)paren
op_eq
l_int|2
)paren
ques
c_cond
l_int|0
suffix:colon
id|options
op_amp
l_int|7
suffix:semicolon
id|vp-&gt;full_duplex
op_assign
(paren
id|options
op_amp
l_int|8
)paren
ques
c_cond
l_int|1
suffix:colon
l_int|0
suffix:semicolon
id|vp-&gt;bus_master
op_assign
(paren
id|options
op_amp
l_int|16
)paren
ques
c_cond
l_int|1
suffix:colon
l_int|0
suffix:semicolon
)brace
r_else
(brace
id|vp-&gt;media_override
op_assign
l_int|7
suffix:semicolon
id|vp-&gt;full_duplex
op_assign
l_int|0
suffix:semicolon
id|vp-&gt;bus_master
op_assign
l_int|0
suffix:semicolon
)brace
id|ether_setup
c_func
(paren
id|dev
)paren
suffix:semicolon
id|vp-&gt;next_module
op_assign
id|root_vortex_dev
suffix:semicolon
id|root_vortex_dev
op_assign
id|dev
suffix:semicolon
r_if
c_cond
(paren
id|register_netdev
c_func
(paren
id|dev
)paren
op_ne
l_int|0
)paren
r_return
op_minus
id|EIO
suffix:semicolon
macro_line|#else  /* not a MODULE */
r_if
c_cond
(paren
id|dev
)paren
(brace
id|dev-&gt;priv
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|vortex_private
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
id|memset
c_func
(paren
id|dev-&gt;priv
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|vortex_private
)paren
)paren
suffix:semicolon
)brace
id|dev
op_assign
id|init_etherdev
c_func
(paren
id|dev
comma
r_sizeof
(paren
r_struct
id|vortex_private
)paren
)paren
suffix:semicolon
id|dev-&gt;base_addr
op_assign
id|ioaddr
suffix:semicolon
id|dev-&gt;irq
op_assign
id|irq
suffix:semicolon
id|vp
op_assign
(paren
r_struct
id|vortex_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|vp-&gt;product_name
op_assign
id|product_names
(braket
id|product_index
)braket
suffix:semicolon
id|vp-&gt;options
op_assign
id|options
suffix:semicolon
r_if
c_cond
(paren
id|options
op_ge
l_int|0
)paren
(brace
id|vp-&gt;media_override
op_assign
(paren
(paren
id|options
op_amp
l_int|7
)paren
op_eq
l_int|2
)paren
ques
c_cond
l_int|0
suffix:colon
id|options
op_amp
l_int|7
suffix:semicolon
id|vp-&gt;full_duplex
op_assign
(paren
id|options
op_amp
l_int|8
)paren
ques
c_cond
l_int|1
suffix:colon
l_int|0
suffix:semicolon
id|vp-&gt;bus_master
op_assign
(paren
id|options
op_amp
l_int|16
)paren
ques
c_cond
l_int|1
suffix:colon
l_int|0
suffix:semicolon
)brace
r_else
(brace
id|vp-&gt;media_override
op_assign
l_int|7
suffix:semicolon
id|vp-&gt;full_duplex
op_assign
l_int|0
suffix:semicolon
id|vp-&gt;bus_master
op_assign
l_int|0
suffix:semicolon
)brace
id|vortex_probe1
c_func
(paren
id|dev
)paren
suffix:semicolon
macro_line|#endif /* MODULE */
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|vortex_probe1
r_static
r_int
id|vortex_probe1
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
r_int
id|ioaddr
op_assign
id|dev-&gt;base_addr
suffix:semicolon
r_struct
id|vortex_private
op_star
id|vp
op_assign
(paren
r_struct
id|vortex_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_int
id|i
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;%s: 3Com %s at %#3x,&quot;
comma
id|dev-&gt;name
comma
id|vp-&gt;product_name
comma
id|ioaddr
)paren
suffix:semicolon
multiline_comment|/* Read the station address from the EEPROM. */
id|EL3WINDOW
c_func
(paren
l_int|0
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|3
suffix:semicolon
id|i
op_increment
)paren
(brace
r_int
op_star
id|phys_addr
op_assign
(paren
r_int
op_star
)paren
id|dev-&gt;dev_addr
suffix:semicolon
r_int
id|timer
suffix:semicolon
id|outw
c_func
(paren
id|EEPROM_Read
op_plus
id|PhysAddr01
op_plus
id|i
comma
id|ioaddr
op_plus
id|Wn0EepromCmd
)paren
suffix:semicolon
multiline_comment|/* Pause for at least 162 us. for the read to take place. */
r_for
c_loop
(paren
id|timer
op_assign
l_int|0
suffix:semicolon
id|timer
OL
l_int|162
op_star
l_int|4
op_plus
l_int|400
suffix:semicolon
id|timer
op_increment
)paren
(brace
id|SLOW_DOWN_IO
suffix:semicolon
r_if
c_cond
(paren
(paren
id|inw
c_func
(paren
id|ioaddr
op_plus
id|Wn0EepromCmd
)paren
op_amp
l_int|0x8000
)paren
op_eq
l_int|0
)paren
r_break
suffix:semicolon
)brace
id|phys_addr
(braket
id|i
)braket
op_assign
id|htons
c_func
(paren
id|inw
c_func
(paren
id|ioaddr
op_plus
l_int|12
)paren
)paren
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|6
suffix:semicolon
id|i
op_increment
)paren
id|printk
c_func
(paren
l_string|&quot;%c%2.2x&quot;
comma
id|i
ques
c_cond
l_char|&squot;:&squot;
suffix:colon
l_char|&squot; &squot;
comma
id|dev-&gt;dev_addr
(braket
id|i
)braket
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;, IRQ %d&bslash;n&quot;
comma
id|dev-&gt;irq
)paren
suffix:semicolon
multiline_comment|/* Tell them about an invalid IRQ. */
r_if
c_cond
(paren
id|vortex_debug
op_logical_and
(paren
id|dev-&gt;irq
op_le
l_int|0
op_logical_or
id|dev-&gt;irq
OG
l_int|15
)paren
)paren
id|printk
c_func
(paren
l_string|&quot; *** Warning: this IRQ is unlikely to work!&bslash;n&quot;
)paren
suffix:semicolon
(brace
r_char
op_star
id|ram_split
(braket
)braket
op_assign
(brace
l_string|&quot;5:3&quot;
comma
l_string|&quot;3:1&quot;
comma
l_string|&quot;1:1&quot;
comma
l_string|&quot;invalid&quot;
)brace
suffix:semicolon
r_union
id|wn3_config
id|config
suffix:semicolon
id|EL3WINDOW
c_func
(paren
l_int|3
)paren
suffix:semicolon
id|config.i
op_assign
id|inl
c_func
(paren
id|ioaddr
op_plus
id|Wn3_Config
)paren
suffix:semicolon
r_if
c_cond
(paren
id|vortex_debug
OG
l_int|1
)paren
id|printk
c_func
(paren
l_string|&quot;  Internal config register is %4.4x, transceivers %#x.&bslash;n&quot;
comma
id|config.i
comma
id|inw
c_func
(paren
id|ioaddr
op_plus
id|Wn3_Options
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;  %dK %s-wide RAM %s Rx:Tx split, %s%s interface.&bslash;n&quot;
comma
l_int|8
op_lshift
id|config.u.ram_size
comma
id|config.u.ram_width
ques
c_cond
l_string|&quot;word&quot;
suffix:colon
l_string|&quot;byte&quot;
comma
id|ram_split
(braket
id|config.u.ram_split
)braket
comma
id|config.u.autoselect
ques
c_cond
l_string|&quot;autoselect/&quot;
suffix:colon
l_string|&quot;&quot;
comma
id|if_names
(braket
id|config.u.xcvr
)braket
)paren
suffix:semicolon
id|dev-&gt;if_port
op_assign
id|config.u.xcvr
suffix:semicolon
id|vp-&gt;autoselect
op_assign
id|config.u.autoselect
suffix:semicolon
)brace
multiline_comment|/* We do a request_region() only to register /proc/ioports info. */
id|request_region
c_func
(paren
id|ioaddr
comma
id|VORTEX_TOTAL_SIZE
comma
id|vp-&gt;product_name
)paren
suffix:semicolon
multiline_comment|/* The 3c59x-specific entries in the device structure. */
id|dev-&gt;open
op_assign
op_amp
id|vortex_open
suffix:semicolon
id|dev-&gt;hard_start_xmit
op_assign
op_amp
id|vortex_start_xmit
suffix:semicolon
id|dev-&gt;stop
op_assign
op_amp
id|vortex_close
suffix:semicolon
id|dev-&gt;get_stats
op_assign
op_amp
id|vortex_get_stats
suffix:semicolon
id|dev-&gt;set_multicast_list
op_assign
op_amp
id|set_multicast_list
suffix:semicolon
macro_line|#if defined (HAVE_SET_MAC_ADDR) &amp;&amp; 0
id|dev-&gt;set_mac_address
op_assign
op_amp
id|set_mac_address
suffix:semicolon
macro_line|#endif
r_return
l_int|0
suffix:semicolon
)brace
"&f;"
r_static
r_int
DECL|function|vortex_open
id|vortex_open
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
r_int
id|ioaddr
op_assign
id|dev-&gt;base_addr
suffix:semicolon
r_struct
id|vortex_private
op_star
id|vp
op_assign
(paren
r_struct
id|vortex_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_union
id|wn3_config
id|config
suffix:semicolon
r_int
id|i
suffix:semicolon
multiline_comment|/* Before initializing select the active media port. */
id|EL3WINDOW
c_func
(paren
l_int|3
)paren
suffix:semicolon
r_if
c_cond
(paren
id|vp-&gt;full_duplex
)paren
id|outb
c_func
(paren
l_int|0x20
comma
id|ioaddr
op_plus
id|Wn3_MAC_Ctrl
)paren
suffix:semicolon
multiline_comment|/* Set the full-duplex bit. */
id|config.i
op_assign
id|inl
c_func
(paren
id|ioaddr
op_plus
id|Wn3_Config
)paren
suffix:semicolon
r_if
c_cond
(paren
id|vp-&gt;media_override
op_ne
l_int|7
)paren
(brace
r_if
c_cond
(paren
id|vortex_debug
OG
l_int|1
)paren
id|printk
c_func
(paren
l_string|&quot;%s: Media override to transceiver %d (%s).&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|vp-&gt;media_override
comma
id|if_names
(braket
id|vp-&gt;media_override
)braket
)paren
suffix:semicolon
id|config.u.xcvr
op_assign
id|vp-&gt;media_override
suffix:semicolon
id|dev-&gt;if_port
op_assign
id|vp-&gt;media_override
suffix:semicolon
id|outl
c_func
(paren
id|config.i
comma
id|ioaddr
op_plus
id|Wn3_Config
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|vortex_debug
OG
l_int|1
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%s: vortex_open() InternalConfig %8.8x.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|config.i
)paren
suffix:semicolon
)brace
id|outw
c_func
(paren
id|TxReset
comma
id|ioaddr
op_plus
id|EL3_CMD
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|20
suffix:semicolon
id|i
op_ge
l_int|0
suffix:semicolon
id|i
op_decrement
)paren
r_if
c_cond
(paren
op_logical_neg
id|inw
c_func
(paren
id|ioaddr
op_plus
id|EL3_STATUS
)paren
op_amp
id|CmdInProgress
)paren
r_break
suffix:semicolon
id|outw
c_func
(paren
id|RxReset
comma
id|ioaddr
op_plus
id|EL3_CMD
)paren
suffix:semicolon
multiline_comment|/* Wait a few ticks for the RxReset command to complete. */
r_for
c_loop
(paren
id|i
op_assign
l_int|20
suffix:semicolon
id|i
op_ge
l_int|0
suffix:semicolon
id|i
op_decrement
)paren
r_if
c_cond
(paren
op_logical_neg
id|inw
c_func
(paren
id|ioaddr
op_plus
id|EL3_STATUS
)paren
op_amp
id|CmdInProgress
)paren
r_break
suffix:semicolon
id|outw
c_func
(paren
id|SetStatusEnb
op_or
l_int|0x00
comma
id|ioaddr
op_plus
id|EL3_CMD
)paren
suffix:semicolon
macro_line|#ifdef USE_SHARED_IRQ
id|i
op_assign
id|request_shared_irq
c_func
(paren
id|dev-&gt;irq
comma
op_amp
id|vortex_interrupt
comma
id|dev
comma
id|vp-&gt;product_name
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
)paren
multiline_comment|/* Error */
r_return
id|i
suffix:semicolon
macro_line|#else
r_if
c_cond
(paren
id|dev-&gt;irq
op_eq
l_int|0
op_logical_or
id|irq2dev_map
(braket
id|dev-&gt;irq
)braket
op_ne
l_int|NULL
)paren
r_return
op_minus
id|EAGAIN
suffix:semicolon
id|irq2dev_map
(braket
id|dev-&gt;irq
)braket
op_assign
id|dev
suffix:semicolon
r_if
c_cond
(paren
id|request_irq
c_func
(paren
id|dev-&gt;irq
comma
op_amp
id|vortex_interrupt
comma
l_int|0
comma
id|vp-&gt;product_name
comma
l_int|NULL
)paren
)paren
(brace
id|irq2dev_map
(braket
id|dev-&gt;irq
)braket
op_assign
l_int|NULL
suffix:semicolon
r_return
op_minus
id|EAGAIN
suffix:semicolon
)brace
macro_line|#endif
r_if
c_cond
(paren
id|vortex_debug
OG
l_int|1
)paren
(brace
id|EL3WINDOW
c_func
(paren
l_int|4
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;%s: vortex_open() irq %d media status %4.4x.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|dev-&gt;irq
comma
id|inw
c_func
(paren
id|ioaddr
op_plus
id|Wn4_Media
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/* Set the station address and mask in window 2 each time opened. */
id|EL3WINDOW
c_func
(paren
l_int|2
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|6
suffix:semicolon
id|i
op_increment
)paren
id|outb
c_func
(paren
id|dev-&gt;dev_addr
(braket
id|i
)braket
comma
id|ioaddr
op_plus
id|i
)paren
suffix:semicolon
r_for
c_loop
(paren
suffix:semicolon
id|i
OL
l_int|12
suffix:semicolon
id|i
op_add_assign
l_int|2
)paren
id|outw
c_func
(paren
l_int|0
comma
id|ioaddr
op_plus
id|i
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;if_port
op_eq
l_int|3
)paren
multiline_comment|/* Start the thinnet transceiver. We should really wait 50ms...*/
id|outw
c_func
(paren
id|StartCoax
comma
id|ioaddr
op_plus
id|EL3_CMD
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
id|dev-&gt;if_port
op_eq
l_int|0
)paren
(brace
multiline_comment|/* 10baseT interface, enabled link beat and jabber check. */
id|EL3WINDOW
c_func
(paren
l_int|4
)paren
suffix:semicolon
id|outw
c_func
(paren
id|inw
c_func
(paren
id|ioaddr
op_plus
id|Wn4_Media
)paren
op_or
id|Media_TP
comma
id|ioaddr
op_plus
id|Wn4_Media
)paren
suffix:semicolon
)brace
multiline_comment|/* Switch to the stats window, and clear all stats by reading. */
id|outw
c_func
(paren
id|StatsDisable
comma
id|ioaddr
op_plus
id|EL3_CMD
)paren
suffix:semicolon
id|EL3WINDOW
c_func
(paren
l_int|6
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|10
suffix:semicolon
id|i
op_increment
)paren
id|inb
c_func
(paren
id|ioaddr
op_plus
id|i
)paren
suffix:semicolon
id|inw
c_func
(paren
id|ioaddr
op_plus
l_int|10
)paren
suffix:semicolon
id|inw
c_func
(paren
id|ioaddr
op_plus
l_int|12
)paren
suffix:semicolon
multiline_comment|/* New: On the Vortex we must also clear the BadSSD counter. */
id|EL3WINDOW
c_func
(paren
l_int|4
)paren
suffix:semicolon
id|inb
c_func
(paren
id|ioaddr
op_plus
l_int|12
)paren
suffix:semicolon
multiline_comment|/* Switch to register set 7 for normal use. */
id|EL3WINDOW
c_func
(paren
l_int|7
)paren
suffix:semicolon
multiline_comment|/* Accept b-case and phys addr only. */
id|outw
c_func
(paren
id|SetRxFilter
op_or
id|RxStation
op_or
id|RxBroadcast
comma
id|ioaddr
op_plus
id|EL3_CMD
)paren
suffix:semicolon
id|outw
c_func
(paren
id|StatsEnable
comma
id|ioaddr
op_plus
id|EL3_CMD
)paren
suffix:semicolon
multiline_comment|/* Turn on statistics. */
id|dev-&gt;tbusy
op_assign
l_int|0
suffix:semicolon
id|dev-&gt;interrupt
op_assign
l_int|0
suffix:semicolon
id|dev-&gt;start
op_assign
l_int|1
suffix:semicolon
id|outw
c_func
(paren
id|RxEnable
comma
id|ioaddr
op_plus
id|EL3_CMD
)paren
suffix:semicolon
multiline_comment|/* Enable the receiver. */
id|outw
c_func
(paren
id|TxEnable
comma
id|ioaddr
op_plus
id|EL3_CMD
)paren
suffix:semicolon
multiline_comment|/* Enable transmitter. */
multiline_comment|/* Allow status bits to be seen. */
id|outw
c_func
(paren
id|SetStatusEnb
op_or
l_int|0xff
comma
id|ioaddr
op_plus
id|EL3_CMD
)paren
suffix:semicolon
multiline_comment|/* Ack all pending events, and set active indicator mask. */
id|outw
c_func
(paren
id|AckIntr
op_or
id|IntLatch
op_or
id|TxAvailable
op_or
id|RxEarly
op_or
id|IntReq
comma
id|ioaddr
op_plus
id|EL3_CMD
)paren
suffix:semicolon
id|outw
c_func
(paren
id|SetIntrEnb
op_or
id|IntLatch
op_or
id|TxAvailable
op_or
id|RxComplete
op_or
id|StatsFull
op_or
id|DMADone
comma
id|ioaddr
op_plus
id|EL3_CMD
)paren
suffix:semicolon
macro_line|#ifdef MODULE
id|MOD_INC_USE_COUNT
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|vp-&gt;autoselect
)paren
(brace
id|init_timer
c_func
(paren
op_amp
id|vp-&gt;timer
)paren
suffix:semicolon
id|vp-&gt;timer.expires
op_assign
(paren
l_int|14
op_star
id|HZ
)paren
op_div
l_int|10
suffix:semicolon
multiline_comment|/* 1.4 sec. */
id|vp-&gt;timer.data
op_assign
(paren
r_int
r_int
)paren
id|dev
suffix:semicolon
id|vp-&gt;timer.function
op_assign
op_amp
id|vortex_timer
suffix:semicolon
multiline_comment|/* timer handler */
id|add_timer
c_func
(paren
op_amp
id|vp-&gt;timer
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|vortex_timer
r_static
r_void
id|vortex_timer
c_func
(paren
r_int
r_int
id|data
)paren
(brace
r_struct
id|device
op_star
id|dev
op_assign
(paren
r_struct
id|device
op_star
)paren
id|data
suffix:semicolon
r_if
c_cond
(paren
id|vortex_debug
OG
l_int|2
)paren
id|printk
c_func
(paren
l_string|&quot;%s: Media selection timer tick happened.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
multiline_comment|/* ToDo: active media selection here! */
)brace
r_static
r_int
DECL|function|vortex_start_xmit
id|vortex_start_xmit
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|device
op_star
id|dev
)paren
(brace
r_struct
id|vortex_private
op_star
id|vp
op_assign
(paren
r_struct
id|vortex_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_int
id|ioaddr
op_assign
id|dev-&gt;base_addr
suffix:semicolon
multiline_comment|/* Transmitter timeout, serious problems. */
r_if
c_cond
(paren
id|dev-&gt;tbusy
)paren
(brace
r_int
id|tickssofar
op_assign
id|jiffies
op_minus
id|dev-&gt;trans_start
suffix:semicolon
r_if
c_cond
(paren
id|tickssofar
OL
l_int|40
)paren
r_return
l_int|1
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;%s: transmit timed out, tx_status %2.2x status %4.4x.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|inb
c_func
(paren
id|ioaddr
op_plus
id|TxStatus
)paren
comma
id|inw
c_func
(paren
id|ioaddr
op_plus
id|EL3_STATUS
)paren
)paren
suffix:semicolon
id|vp-&gt;stats.tx_errors
op_increment
suffix:semicolon
multiline_comment|/* Issue TX_RESET and TX_START commands. */
id|outw
c_func
(paren
id|TxReset
comma
id|ioaddr
op_plus
id|EL3_CMD
)paren
suffix:semicolon
(brace
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|20
suffix:semicolon
id|i
op_ge
l_int|0
suffix:semicolon
id|i
op_decrement
)paren
r_if
c_cond
(paren
op_logical_neg
id|inw
c_func
(paren
id|ioaddr
op_plus
id|EL3_STATUS
)paren
op_amp
id|CmdInProgress
)paren
r_break
suffix:semicolon
)brace
id|outw
c_func
(paren
id|TxEnable
comma
id|ioaddr
op_plus
id|EL3_CMD
)paren
suffix:semicolon
id|dev-&gt;trans_start
op_assign
id|jiffies
suffix:semicolon
id|dev-&gt;tbusy
op_assign
l_int|0
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|skb
op_eq
l_int|NULL
op_logical_or
id|skb-&gt;len
op_le
l_int|0
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%s: Obsolete driver layer request made: skbuff==NULL.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|dev_tint
c_func
(paren
id|dev
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Block a timer-based transmit from overlapping.  This could better be&n;&t;   done with atomic_swap(1, dev-&gt;tbusy), but set_bit() works as well.&n;&t;   If this ever occurs the queue layer is doing something evil! */
r_if
c_cond
(paren
id|set_bit
c_func
(paren
l_int|0
comma
(paren
r_void
op_star
)paren
op_amp
id|dev-&gt;tbusy
)paren
op_ne
l_int|0
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%s: Transmitter access conflict.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
multiline_comment|/* Put out the doubleword header... */
id|outl
c_func
(paren
id|skb-&gt;len
comma
id|ioaddr
op_plus
id|TX_FIFO
)paren
suffix:semicolon
macro_line|#ifdef VORTEX_BUS_MASTER
r_if
c_cond
(paren
id|vp-&gt;bus_master
)paren
(brace
multiline_comment|/* Set the bus-master controller to transfer the packet. */
id|outl
c_func
(paren
(paren
r_int
)paren
(paren
id|skb-&gt;data
)paren
comma
id|ioaddr
op_plus
id|Wn7_MasterAddr
)paren
suffix:semicolon
id|outw
c_func
(paren
(paren
id|skb-&gt;len
op_plus
l_int|3
)paren
op_amp
op_complement
l_int|3
comma
id|ioaddr
op_plus
id|Wn7_MasterLen
)paren
suffix:semicolon
id|vp-&gt;tx_skb
op_assign
id|skb
suffix:semicolon
id|outw
c_func
(paren
id|StartDMADown
comma
id|ioaddr
op_plus
id|EL3_CMD
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* ... and the packet rounded to a doubleword. */
id|outsl
c_func
(paren
id|ioaddr
op_plus
id|TX_FIFO
comma
id|skb-&gt;data
comma
(paren
id|skb-&gt;len
op_plus
l_int|3
)paren
op_rshift
l_int|2
)paren
suffix:semicolon
id|dev_kfree_skb
(paren
id|skb
comma
id|FREE_WRITE
)paren
suffix:semicolon
r_if
c_cond
(paren
id|inw
c_func
(paren
id|ioaddr
op_plus
id|TxFree
)paren
OG
l_int|1536
)paren
(brace
id|dev-&gt;tbusy
op_assign
l_int|0
suffix:semicolon
)brace
r_else
multiline_comment|/* Interrupt us when the FIFO has room for max-sized packet. */
id|outw
c_func
(paren
id|SetTxThreshold
op_plus
l_int|1536
comma
id|ioaddr
op_plus
id|EL3_CMD
)paren
suffix:semicolon
)brace
macro_line|#else
multiline_comment|/* ... and the packet rounded to a doubleword. */
id|outsl
c_func
(paren
id|ioaddr
op_plus
id|TX_FIFO
comma
id|skb-&gt;data
comma
(paren
id|skb-&gt;len
op_plus
l_int|3
)paren
op_rshift
l_int|2
)paren
suffix:semicolon
id|dev_kfree_skb
(paren
id|skb
comma
id|FREE_WRITE
)paren
suffix:semicolon
r_if
c_cond
(paren
id|inw
c_func
(paren
id|ioaddr
op_plus
id|TxFree
)paren
OG
l_int|1536
)paren
(brace
id|dev-&gt;tbusy
op_assign
l_int|0
suffix:semicolon
)brace
r_else
multiline_comment|/* Interrupt us when the FIFO has room for max-sized packet. */
id|outw
c_func
(paren
id|SetTxThreshold
op_plus
l_int|1536
comma
id|ioaddr
op_plus
id|EL3_CMD
)paren
suffix:semicolon
macro_line|#endif  /* bus master */
id|dev-&gt;trans_start
op_assign
id|jiffies
suffix:semicolon
multiline_comment|/* Clear the Tx status stack. */
(brace
r_int
id|tx_status
suffix:semicolon
r_int
id|i
op_assign
l_int|4
suffix:semicolon
r_while
c_loop
(paren
op_decrement
id|i
OG
l_int|0
op_logical_and
(paren
id|tx_status
op_assign
id|inb
c_func
(paren
id|ioaddr
op_plus
id|TxStatus
)paren
)paren
OG
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|tx_status
op_amp
l_int|0x3C
)paren
(brace
multiline_comment|/* A Tx-disabling error occured.  */
r_if
c_cond
(paren
id|vortex_debug
OG
l_int|2
)paren
id|printk
c_func
(paren
l_string|&quot;%s: Tx error, status %2.2x.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|tx_status
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tx_status
op_amp
l_int|0x04
)paren
id|vp-&gt;stats.tx_fifo_errors
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|tx_status
op_amp
l_int|0x38
)paren
id|vp-&gt;stats.tx_aborted_errors
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|tx_status
op_amp
l_int|0x30
)paren
(brace
r_int
id|j
suffix:semicolon
id|outw
c_func
(paren
id|TxReset
comma
id|ioaddr
op_plus
id|EL3_CMD
)paren
suffix:semicolon
r_for
c_loop
(paren
id|j
op_assign
l_int|20
suffix:semicolon
id|j
op_ge
l_int|0
suffix:semicolon
id|j
op_decrement
)paren
r_if
c_cond
(paren
op_logical_neg
id|inw
c_func
(paren
id|ioaddr
op_plus
id|EL3_STATUS
)paren
op_amp
id|CmdInProgress
)paren
r_break
suffix:semicolon
)brace
id|outw
c_func
(paren
id|TxEnable
comma
id|ioaddr
op_plus
id|EL3_CMD
)paren
suffix:semicolon
)brace
id|outb
c_func
(paren
l_int|0x00
comma
id|ioaddr
op_plus
id|TxStatus
)paren
suffix:semicolon
multiline_comment|/* Pop the status stack. */
)brace
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* The interrupt handler does all of the Rx thread work and cleans up&n;   after the Tx thread. */
DECL|function|vortex_interrupt
r_static
r_void
id|vortex_interrupt
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
macro_line|#ifdef USE_SHARED_IRQ
r_struct
id|device
op_star
id|dev
op_assign
(paren
r_struct
id|device
op_star
)paren
(paren
id|irq
op_eq
l_int|0
ques
c_cond
id|regs
suffix:colon
id|irq2dev_map
(braket
id|irq
)braket
)paren
suffix:semicolon
macro_line|#else
r_struct
id|device
op_star
id|dev
op_assign
(paren
r_struct
id|device
op_star
)paren
(paren
id|irq2dev_map
(braket
id|irq
)braket
)paren
suffix:semicolon
macro_line|#endif
r_struct
id|vortex_private
op_star
id|lp
suffix:semicolon
r_int
id|ioaddr
comma
id|status
suffix:semicolon
r_int
id|latency
suffix:semicolon
r_int
id|i
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|dev
op_eq
l_int|NULL
)paren
(brace
id|printk
(paren
l_string|&quot;vortex_interrupt(): irq %d for unknown device.&bslash;n&quot;
comma
id|irq
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|dev-&gt;interrupt
)paren
id|printk
c_func
(paren
l_string|&quot;%s: Re-entering the interrupt handler.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|dev-&gt;interrupt
op_assign
l_int|1
suffix:semicolon
id|ioaddr
op_assign
id|dev-&gt;base_addr
suffix:semicolon
id|latency
op_assign
id|inb
c_func
(paren
id|ioaddr
op_plus
id|Timer
)paren
suffix:semicolon
id|lp
op_assign
(paren
r_struct
id|vortex_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|status
op_assign
id|inw
c_func
(paren
id|ioaddr
op_plus
id|EL3_STATUS
)paren
suffix:semicolon
r_if
c_cond
(paren
id|vortex_debug
OG
l_int|4
)paren
id|printk
c_func
(paren
l_string|&quot;%s: interrupt, status %4.4x, timer %d.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|status
comma
id|latency
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|status
op_amp
l_int|0xE000
)paren
op_ne
l_int|0xE000
)paren
(brace
r_static
r_int
id|donedidthis
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Some interrupt controllers store a bogus interrupt from boot-time.&n;&t;&t;   Ignore a single early interrupt, but don&squot;t hang the machine for&n;&t;&t;   other interrupt problems. */
r_if
c_cond
(paren
id|donedidthis
op_increment
OG
l_int|1
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%s: Bogus interrupt, bailing. Status %4.4x, start=%d.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|status
comma
id|dev-&gt;start
)paren
suffix:semicolon
id|free_irq
c_func
(paren
id|dev-&gt;irq
comma
l_int|NULL
)paren
suffix:semicolon
)brace
)brace
r_do
(brace
r_if
c_cond
(paren
id|vortex_debug
OG
l_int|5
)paren
id|printk
c_func
(paren
l_string|&quot;%s: In interrupt loop, status %4.4x.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|status
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
id|RxComplete
)paren
id|vortex_rx
c_func
(paren
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
id|TxAvailable
)paren
(brace
r_if
c_cond
(paren
id|vortex_debug
OG
l_int|5
)paren
id|printk
c_func
(paren
l_string|&quot;&t;TX room bit was handled.&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* There&squot;s room in the FIFO for a full-sized packet. */
id|outw
c_func
(paren
id|AckIntr
op_or
id|TxAvailable
comma
id|ioaddr
op_plus
id|EL3_CMD
)paren
suffix:semicolon
id|dev-&gt;tbusy
op_assign
l_int|0
suffix:semicolon
id|mark_bh
c_func
(paren
id|NET_BH
)paren
suffix:semicolon
)brace
macro_line|#ifdef VORTEX_BUS_MASTER
r_if
c_cond
(paren
id|status
op_amp
id|DMADone
)paren
(brace
id|outw
c_func
(paren
l_int|0x1000
comma
id|ioaddr
op_plus
id|Wn7_MasterStatus
)paren
suffix:semicolon
multiline_comment|/* Ack the event. */
id|dev-&gt;tbusy
op_assign
l_int|0
suffix:semicolon
id|mark_bh
c_func
(paren
id|NET_BH
)paren
suffix:semicolon
)brace
macro_line|#endif
r_if
c_cond
(paren
id|status
op_amp
(paren
id|AdapterFailure
op_or
id|RxEarly
op_or
id|StatsFull
)paren
)paren
(brace
multiline_comment|/* Handle all uncommon interrupts at once. */
r_if
c_cond
(paren
id|status
op_amp
id|RxEarly
)paren
(brace
multiline_comment|/* Rx early is unused. */
id|vortex_rx
c_func
(paren
id|dev
)paren
suffix:semicolon
id|outw
c_func
(paren
id|AckIntr
op_or
id|RxEarly
comma
id|ioaddr
op_plus
id|EL3_CMD
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|status
op_amp
id|StatsFull
)paren
(brace
multiline_comment|/* Empty statistics. */
r_static
r_int
id|DoneDidThat
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|vortex_debug
OG
l_int|4
)paren
id|printk
c_func
(paren
l_string|&quot;%s: Updating stats.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|update_stats
c_func
(paren
id|ioaddr
comma
id|dev
)paren
suffix:semicolon
multiline_comment|/* DEBUG HACK: Disable statistics as an interrupt source. */
multiline_comment|/* This occurs when we have the wrong media type! */
r_if
c_cond
(paren
id|DoneDidThat
op_eq
l_int|0
op_logical_and
id|inw
c_func
(paren
id|ioaddr
op_plus
id|EL3_STATUS
)paren
op_amp
id|StatsFull
)paren
(brace
r_int
id|win
comma
id|reg
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;%s: Updating stats failed, disabling stats as an&quot;
l_string|&quot; interrupt source.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_for
c_loop
(paren
id|win
op_assign
l_int|0
suffix:semicolon
id|win
OL
l_int|8
suffix:semicolon
id|win
op_increment
)paren
(brace
id|EL3WINDOW
c_func
(paren
id|win
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;&bslash;n Vortex window %d:&quot;
comma
id|win
)paren
suffix:semicolon
r_for
c_loop
(paren
id|reg
op_assign
l_int|0
suffix:semicolon
id|reg
OL
l_int|16
suffix:semicolon
id|reg
op_increment
)paren
id|printk
c_func
(paren
l_string|&quot; %2.2x&quot;
comma
id|inb
c_func
(paren
id|ioaddr
op_plus
id|reg
)paren
)paren
suffix:semicolon
)brace
id|EL3WINDOW
c_func
(paren
l_int|7
)paren
suffix:semicolon
id|outw
c_func
(paren
id|SetIntrEnb
op_or
l_int|0x18
comma
id|ioaddr
op_plus
id|EL3_CMD
)paren
suffix:semicolon
id|DoneDidThat
op_increment
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|status
op_amp
id|AdapterFailure
)paren
(brace
multiline_comment|/* Adapter failure requires Rx reset and reinit. */
id|outw
c_func
(paren
id|RxReset
comma
id|ioaddr
op_plus
id|EL3_CMD
)paren
suffix:semicolon
multiline_comment|/* Set the Rx filter to the current state. */
id|outw
c_func
(paren
id|SetRxFilter
op_or
id|RxStation
op_or
id|RxBroadcast
op_or
(paren
id|dev-&gt;flags
op_amp
id|IFF_ALLMULTI
ques
c_cond
id|RxMulticast
suffix:colon
l_int|0
)paren
op_or
(paren
id|dev-&gt;flags
op_amp
id|IFF_PROMISC
ques
c_cond
id|RxProm
suffix:colon
l_int|0
)paren
comma
id|ioaddr
op_plus
id|EL3_CMD
)paren
suffix:semicolon
id|outw
c_func
(paren
id|RxEnable
comma
id|ioaddr
op_plus
id|EL3_CMD
)paren
suffix:semicolon
multiline_comment|/* Re-enable the receiver. */
id|outw
c_func
(paren
id|AckIntr
op_or
id|AdapterFailure
comma
id|ioaddr
op_plus
id|EL3_CMD
)paren
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
op_increment
id|i
OG
l_int|10
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%s: Infinite loop in interrupt, status %4.4x.  &quot;
l_string|&quot;Disabling functions (%4.4x).&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|status
comma
id|SetStatusEnb
op_or
(paren
(paren
op_complement
id|status
)paren
op_amp
l_int|0xFE
)paren
)paren
suffix:semicolon
multiline_comment|/* Disable all pending interrupts. */
id|outw
c_func
(paren
id|SetStatusEnb
op_or
(paren
(paren
op_complement
id|status
)paren
op_amp
l_int|0xFE
)paren
comma
id|ioaddr
op_plus
id|EL3_CMD
)paren
suffix:semicolon
id|outw
c_func
(paren
id|AckIntr
op_or
l_int|0xFF
comma
id|ioaddr
op_plus
id|EL3_CMD
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
multiline_comment|/* Acknowledge the IRQ. */
id|outw
c_func
(paren
id|AckIntr
op_or
id|IntReq
op_or
id|IntLatch
comma
id|ioaddr
op_plus
id|EL3_CMD
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
(paren
id|status
op_assign
id|inw
c_func
(paren
id|ioaddr
op_plus
id|EL3_STATUS
)paren
)paren
op_amp
(paren
id|IntLatch
op_or
id|RxComplete
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|vortex_debug
OG
l_int|4
)paren
id|printk
c_func
(paren
l_string|&quot;%s: exiting interrupt, status %4.4x.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|status
)paren
suffix:semicolon
id|dev-&gt;interrupt
op_assign
l_int|0
suffix:semicolon
r_return
suffix:semicolon
)brace
r_static
r_int
DECL|function|vortex_rx
id|vortex_rx
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
r_struct
id|vortex_private
op_star
id|vp
op_assign
(paren
r_struct
id|vortex_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_int
id|ioaddr
op_assign
id|dev-&gt;base_addr
suffix:semicolon
r_int
id|i
suffix:semicolon
r_int
id|rx_status
suffix:semicolon
r_if
c_cond
(paren
id|vortex_debug
OG
l_int|5
)paren
id|printk
c_func
(paren
l_string|&quot;   In rx_packet(), status %4.4x, rx_status %4.4x.&bslash;n&quot;
comma
id|inw
c_func
(paren
id|ioaddr
op_plus
id|EL3_STATUS
)paren
comma
id|inw
c_func
(paren
id|ioaddr
op_plus
id|RxStatus
)paren
)paren
suffix:semicolon
r_while
c_loop
(paren
(paren
id|rx_status
op_assign
id|inw
c_func
(paren
id|ioaddr
op_plus
id|RxStatus
)paren
)paren
OG
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|rx_status
op_amp
l_int|0x4000
)paren
(brace
multiline_comment|/* Error, update stats. */
r_int
r_char
id|rx_error
op_assign
id|inb
c_func
(paren
id|ioaddr
op_plus
id|RxErrors
)paren
suffix:semicolon
r_if
c_cond
(paren
id|vortex_debug
OG
l_int|4
)paren
id|printk
c_func
(paren
l_string|&quot; Rx error: status %2.2x.&bslash;n&quot;
comma
id|rx_error
)paren
suffix:semicolon
id|vp-&gt;stats.rx_errors
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|rx_error
op_amp
l_int|0x01
)paren
id|vp-&gt;stats.rx_over_errors
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|rx_error
op_amp
l_int|0x02
)paren
id|vp-&gt;stats.rx_length_errors
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|rx_error
op_amp
l_int|0x04
)paren
id|vp-&gt;stats.rx_frame_errors
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|rx_error
op_amp
l_int|0x08
)paren
id|vp-&gt;stats.rx_crc_errors
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|rx_error
op_amp
l_int|0x10
)paren
id|vp-&gt;stats.rx_length_errors
op_increment
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* The packet length: up to 4.5K!. */
r_int
id|pkt_len
op_assign
id|rx_status
op_amp
l_int|0x1fff
suffix:semicolon
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
id|skb
op_assign
id|dev_alloc_skb
c_func
(paren
id|pkt_len
op_plus
l_int|5
)paren
suffix:semicolon
r_if
c_cond
(paren
id|vortex_debug
OG
l_int|4
)paren
id|printk
c_func
(paren
l_string|&quot;Receiving packet size %d status %4.4x.&bslash;n&quot;
comma
id|pkt_len
comma
id|rx_status
)paren
suffix:semicolon
r_if
c_cond
(paren
id|skb
op_ne
l_int|NULL
)paren
(brace
id|skb-&gt;dev
op_assign
id|dev
suffix:semicolon
id|skb_reserve
c_func
(paren
id|skb
comma
l_int|2
)paren
suffix:semicolon
multiline_comment|/* Align IP on 16 byte boundaries */
multiline_comment|/* &squot;skb_put()&squot; points to the start of sk_buff data area. */
id|insl
c_func
(paren
id|ioaddr
op_plus
id|RX_FIFO
comma
id|skb_put
c_func
(paren
id|skb
comma
id|pkt_len
)paren
comma
(paren
id|pkt_len
op_plus
l_int|3
)paren
op_rshift
l_int|2
)paren
suffix:semicolon
id|skb-&gt;protocol
op_assign
id|eth_type_trans
c_func
(paren
id|skb
comma
id|dev
)paren
suffix:semicolon
id|netif_rx
c_func
(paren
id|skb
)paren
suffix:semicolon
id|outw
c_func
(paren
id|RxDiscard
comma
id|ioaddr
op_plus
id|EL3_CMD
)paren
suffix:semicolon
multiline_comment|/* Pop top Rx packet. */
multiline_comment|/* Wait a limited time to go to next packet. */
r_for
c_loop
(paren
id|i
op_assign
l_int|200
suffix:semicolon
id|i
op_ge
l_int|0
suffix:semicolon
id|i
op_decrement
)paren
r_if
c_cond
(paren
op_logical_neg
id|inw
c_func
(paren
id|ioaddr
op_plus
id|EL3_STATUS
)paren
op_amp
id|CmdInProgress
)paren
r_break
suffix:semicolon
id|vp-&gt;stats.rx_packets
op_increment
suffix:semicolon
r_continue
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|vortex_debug
)paren
id|printk
c_func
(paren
l_string|&quot;%s: Couldn&squot;t allocate a sk_buff of size %d.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|pkt_len
)paren
suffix:semicolon
)brace
id|vp-&gt;stats.rx_dropped
op_increment
suffix:semicolon
id|outw
c_func
(paren
id|RxDiscard
comma
id|ioaddr
op_plus
id|EL3_CMD
)paren
suffix:semicolon
multiline_comment|/* Wait a limited time to skip this packet. */
r_for
c_loop
(paren
id|i
op_assign
l_int|200
suffix:semicolon
id|i
op_ge
l_int|0
suffix:semicolon
id|i
op_decrement
)paren
r_if
c_cond
(paren
op_logical_neg
id|inw
c_func
(paren
id|ioaddr
op_plus
id|EL3_STATUS
)paren
op_amp
id|CmdInProgress
)paren
r_break
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_int
DECL|function|vortex_close
id|vortex_close
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
r_int
id|ioaddr
op_assign
id|dev-&gt;base_addr
suffix:semicolon
id|dev-&gt;start
op_assign
l_int|0
suffix:semicolon
id|dev-&gt;tbusy
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|vortex_debug
OG
l_int|1
)paren
id|printk
c_func
(paren
l_string|&quot;%s: vortex_close() status %4.4x, Tx status %2.2x.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|inw
c_func
(paren
id|ioaddr
op_plus
id|EL3_STATUS
)paren
comma
id|inb
c_func
(paren
id|ioaddr
op_plus
id|TxStatus
)paren
)paren
suffix:semicolon
multiline_comment|/* Turn off statistics ASAP.  We update lp-&gt;stats below. */
id|outw
c_func
(paren
id|StatsDisable
comma
id|ioaddr
op_plus
id|EL3_CMD
)paren
suffix:semicolon
multiline_comment|/* Disable the receiver and transmitter. */
id|outw
c_func
(paren
id|RxDisable
comma
id|ioaddr
op_plus
id|EL3_CMD
)paren
suffix:semicolon
id|outw
c_func
(paren
id|TxDisable
comma
id|ioaddr
op_plus
id|EL3_CMD
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;if_port
op_eq
l_int|3
)paren
multiline_comment|/* Turn off thinnet power.  Green! */
id|outw
c_func
(paren
id|StopCoax
comma
id|ioaddr
op_plus
id|EL3_CMD
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
id|dev-&gt;if_port
op_eq
l_int|0
)paren
(brace
multiline_comment|/* Disable link beat and jabber, if_port may change ere next open(). */
id|EL3WINDOW
c_func
(paren
l_int|4
)paren
suffix:semicolon
id|outw
c_func
(paren
id|inw
c_func
(paren
id|ioaddr
op_plus
id|Wn4_Media
)paren
op_amp
op_complement
id|Media_TP
comma
id|ioaddr
op_plus
id|Wn4_Media
)paren
suffix:semicolon
)brace
macro_line|#ifdef USE_SHARED_IRQ
id|free_shared_irq
c_func
(paren
id|dev-&gt;irq
comma
id|dev
)paren
suffix:semicolon
macro_line|#else
id|free_irq
c_func
(paren
id|dev-&gt;irq
comma
l_int|NULL
)paren
suffix:semicolon
multiline_comment|/* Mmmm, we should diable all interrupt sources here. */
id|irq2dev_map
(braket
id|dev-&gt;irq
)braket
op_assign
l_int|0
suffix:semicolon
macro_line|#endif
id|update_stats
c_func
(paren
id|ioaddr
comma
id|dev
)paren
suffix:semicolon
macro_line|#ifdef MODULE
id|MOD_DEC_USE_COUNT
suffix:semicolon
macro_line|#endif
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_struct
id|enet_statistics
op_star
DECL|function|vortex_get_stats
id|vortex_get_stats
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
r_struct
id|vortex_private
op_star
id|vp
op_assign
(paren
r_struct
id|vortex_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|update_stats
c_func
(paren
id|dev-&gt;base_addr
comma
id|dev
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
op_amp
id|vp-&gt;stats
suffix:semicolon
)brace
multiline_comment|/*  Update statistics.&n;&t;Unlike with the EL3 we need not worry about interrupts changing&n;&t;the window setting from underneath us, but we must still guard&n;&t;against a race condition with a StatsUpdate interrupt updating the&n;&t;table.  This is done by checking that the ASM (!) code generated uses&n;&t;atomic updates with &squot;+=&squot;.&n;&t;*/
DECL|function|update_stats
r_static
r_void
id|update_stats
c_func
(paren
r_int
id|ioaddr
comma
r_struct
id|device
op_star
id|dev
)paren
(brace
r_struct
id|vortex_private
op_star
id|vp
op_assign
(paren
r_struct
id|vortex_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
multiline_comment|/* Unlike the 3c5x9 we need not turn off stats updates while reading. */
multiline_comment|/* Switch to the stats window, and read everything. */
id|EL3WINDOW
c_func
(paren
l_int|6
)paren
suffix:semicolon
id|vp-&gt;stats.tx_carrier_errors
op_add_assign
id|inb
c_func
(paren
id|ioaddr
op_plus
l_int|0
)paren
suffix:semicolon
id|vp-&gt;stats.tx_heartbeat_errors
op_add_assign
id|inb
c_func
(paren
id|ioaddr
op_plus
l_int|1
)paren
suffix:semicolon
multiline_comment|/* Multiple collisions. */
id|inb
c_func
(paren
id|ioaddr
op_plus
l_int|2
)paren
suffix:semicolon
id|vp-&gt;stats.collisions
op_add_assign
id|inb
c_func
(paren
id|ioaddr
op_plus
l_int|3
)paren
suffix:semicolon
id|vp-&gt;stats.tx_window_errors
op_add_assign
id|inb
c_func
(paren
id|ioaddr
op_plus
l_int|4
)paren
suffix:semicolon
id|vp-&gt;stats.rx_fifo_errors
op_add_assign
id|inb
c_func
(paren
id|ioaddr
op_plus
l_int|5
)paren
suffix:semicolon
id|vp-&gt;stats.tx_packets
op_add_assign
id|inb
c_func
(paren
id|ioaddr
op_plus
l_int|6
)paren
suffix:semicolon
id|vp-&gt;stats.tx_packets
op_add_assign
(paren
id|inb
c_func
(paren
id|ioaddr
op_plus
l_int|9
)paren
op_amp
l_int|0x30
)paren
op_lshift
l_int|4
suffix:semicolon
multiline_comment|/* Rx packets&t;*/
id|inb
c_func
(paren
id|ioaddr
op_plus
l_int|7
)paren
suffix:semicolon
multiline_comment|/* Must read to clear */
multiline_comment|/* Tx deferrals */
id|inb
c_func
(paren
id|ioaddr
op_plus
l_int|8
)paren
suffix:semicolon
multiline_comment|/* Don&squot;t bother with register 9, an extention of registers 6&amp;7.&n;&t;   If we do use the 6&amp;7 values the atomic update assumption above&n;&t;   is invalid. */
id|inw
c_func
(paren
id|ioaddr
op_plus
l_int|10
)paren
suffix:semicolon
multiline_comment|/* Total Rx and Tx octets. */
id|inw
c_func
(paren
id|ioaddr
op_plus
l_int|12
)paren
suffix:semicolon
multiline_comment|/* New: On the Vortex we must also clear the BadSSD counter. */
id|EL3WINDOW
c_func
(paren
l_int|4
)paren
suffix:semicolon
id|inb
c_func
(paren
id|ioaddr
op_plus
l_int|12
)paren
suffix:semicolon
multiline_comment|/* We change back to window 7 (not 1) with the Vortex. */
id|EL3WINDOW
c_func
(paren
l_int|7
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/* There are two version of set_multicast_list() to support both v1.2 and&n;   v1.4 kernels. */
r_static
r_void
DECL|function|set_multicast_list
id|set_multicast_list
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
r_int
id|ioaddr
op_assign
id|dev-&gt;base_addr
suffix:semicolon
r_if
c_cond
(paren
(paren
id|dev-&gt;mc_list
)paren
op_logical_or
(paren
id|dev-&gt;flags
op_amp
id|IFF_ALLMULTI
)paren
)paren
(brace
id|outw
c_func
(paren
id|SetRxFilter
op_or
id|RxStation
op_or
id|RxMulticast
op_or
id|RxBroadcast
comma
id|ioaddr
op_plus
id|EL3_CMD
)paren
suffix:semicolon
r_if
c_cond
(paren
id|vortex_debug
OG
l_int|3
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%s: Setting Rx multicast mode, %d addresses.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|dev-&gt;mc_count
)paren
suffix:semicolon
)brace
)brace
r_else
r_if
c_cond
(paren
id|dev-&gt;flags
op_amp
id|IFF_PROMISC
)paren
(brace
id|outw
c_func
(paren
id|SetRxFilter
op_or
id|RxStation
op_or
id|RxMulticast
op_or
id|RxBroadcast
op_or
id|RxProm
comma
id|ioaddr
op_plus
id|EL3_CMD
)paren
suffix:semicolon
)brace
r_else
id|outw
c_func
(paren
id|SetRxFilter
op_or
id|RxStation
op_or
id|RxBroadcast
comma
id|ioaddr
op_plus
id|EL3_CMD
)paren
suffix:semicolon
)brace
"&f;"
macro_line|#ifdef MODULE
r_void
DECL|function|cleanup_module
id|cleanup_module
c_func
(paren
r_void
)paren
(brace
r_struct
id|device
op_star
id|next_dev
suffix:semicolon
multiline_comment|/* No need to check MOD_IN_USE, as sys_delete_module() checks. */
r_while
c_loop
(paren
id|root_vortex_dev
)paren
(brace
id|next_dev
op_assign
(paren
(paren
r_struct
id|vortex_private
op_star
)paren
id|root_vortex_dev-&gt;priv
)paren
op_member_access_from_pointer
id|next_module
suffix:semicolon
id|unregister_netdev
c_func
(paren
id|root_vortex_dev
)paren
suffix:semicolon
id|release_region
c_func
(paren
id|root_vortex_dev-&gt;base_addr
comma
id|VORTEX_TOTAL_SIZE
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|root_vortex_dev
)paren
suffix:semicolon
id|root_vortex_dev
op_assign
id|next_dev
suffix:semicolon
)brace
)brace
macro_line|#endif /* MODULE */
"&f;"
multiline_comment|/*&n; * Local variables:&n; *  compile-command: &quot;gcc -DMODULE -D__KERNEL__ -I/usr/src/linux/net/inet -Wall -Wstrict-prototypes -O6 -m486 -c 3c59x.c -o 3c59x.o&quot;&n; *  c-indent-level: 4&n; *  tab-width: 4&n; * End:&n; */
eof
