multiline_comment|/* &n;**&n;**  RCpci45.c  &n;**&n;**&n;**&n;**  ---------------------------------------------------------------------&n;**  ---     Copyright (c) 1998, 1999, RedCreek Communications Inc.    ---&n;**  ---                   All rights reserved.                        ---&n;**  ---------------------------------------------------------------------&n;**&n;** Written by Pete Popov and Brian Moyle.&n;**&n;** Known Problems&n;** &n;** None known at this time.&n;**&n;**  TODO:&n;**      -Get rid of the wait loops in the API and replace them&n;**       with system independent delays ...something like&n;**       &quot;delayms(2)&quot;.  However, under normal circumstances, the &n;**       delays are very short so they&squot;re not a problem.&n;**&n;**  This program is free software; you can redistribute it and/or modify&n;**  it under the terms of the GNU General Public License as published by&n;**  the Free Software Foundation; either version 2 of the License, or&n;**  (at your option) any later version.&n;&n;**  This program is distributed in the hope that it will be useful,&n;**  but WITHOUT ANY WARRANTY; without even the implied warranty of&n;**  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the&n;**  GNU General Public License for more details.&n;&n;**  You should have received a copy of the GNU General Public License&n;**  along with this program; if not, write to the Free Software&n;**  Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.&n;**&n;**   &n;**  Rasmus Andersen, December 2000: Converted to new PCI API.&n;**&n;**  Pete Popov, January 11,99: Fixed a couple of 2.1.x problems &n;**  (virt_to_bus() not called), tested it under 2.2pre5 (as a module), and &n;**  added a #define(s) to enable the use of the same file for both, the 2.0.x &n;**  kernels as well as the 2.1.x.&n;**&n;**  Ported to 2.1.x by Alan Cox 1998/12/9. &n;**&n;**  Sometime in mid 1998, written by Pete Popov and Brian Moyle.&n;**&n;***************************************************************************/
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/ptrace.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/in.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/ioport.h&gt;
macro_line|#include &lt;linux/malloc.h&gt;
macro_line|#include &lt;linux/interrupt.h&gt;
macro_line|#include &lt;linux/pci.h&gt;
macro_line|#include &lt;linux/timer.h&gt;
macro_line|#include &lt;asm/irq.h&gt;            /* For NR_IRQS only. */
macro_line|#include &lt;asm/bitops.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/uaccess.h&gt;
macro_line|#include &lt;linux/if_ether.h&gt;
macro_line|#include &lt;linux/netdevice.h&gt;
macro_line|#include &lt;linux/etherdevice.h&gt;
macro_line|#include &lt;linux/skbuff.h&gt;
DECL|variable|__initdata
r_static
r_char
id|version
(braket
)braket
id|__initdata
op_assign
l_string|&quot;RedCreek Communications PCI linux driver version 2.03&bslash;n&quot;
suffix:semicolon
DECL|macro|RC_LINUX_MODULE
mdefine_line|#define RC_LINUX_MODULE
macro_line|#include &quot;rclanmtl.h&quot;
macro_line|#include &quot;rcif.h&quot;
DECL|macro|RUN_AT
mdefine_line|#define RUN_AT(x) (jiffies + (x))
DECL|macro|NEW_MULTICAST
mdefine_line|#define NEW_MULTICAST
macro_line|#include &lt;linux/delay.h&gt;
multiline_comment|/* PCI/45 Configuration space values */
DECL|macro|RC_PCI45_VENDOR_ID
mdefine_line|#define RC_PCI45_VENDOR_ID  0x4916
DECL|macro|RC_PCI45_DEVICE_ID
mdefine_line|#define RC_PCI45_DEVICE_ID  0x1960
DECL|macro|MAX_ETHER_SIZE
mdefine_line|#define MAX_ETHER_SIZE        1520  
DECL|macro|MAX_NMBR_RCV_BUFFERS
mdefine_line|#define MAX_NMBR_RCV_BUFFERS    96
DECL|macro|RC_POSTED_BUFFERS_LOW_MARK
mdefine_line|#define RC_POSTED_BUFFERS_LOW_MARK MAX_NMBR_RCV_BUFFERS-16
DECL|macro|BD_SIZE
mdefine_line|#define BD_SIZE 3           /* Bucket Descriptor size */
DECL|macro|BD_LEN_OFFSET
mdefine_line|#define BD_LEN_OFFSET 2     /* Bucket Descriptor offset to length field */
multiline_comment|/* RedCreek LAN device Target ID */
DECL|macro|RC_LAN_TARGET_ID
mdefine_line|#define RC_LAN_TARGET_ID  0x10 
multiline_comment|/* RedCreek&squot;s OSM default LAN receive Initiator */
DECL|macro|DEFAULT_RECV_INIT_CONTEXT
mdefine_line|#define DEFAULT_RECV_INIT_CONTEXT  0xA17  
DECL|variable|DriverControlWord
r_static
id|U32
id|DriverControlWord
op_assign
l_int|0
suffix:semicolon
r_static
r_void
id|rc_timer
c_func
(paren
r_int
r_int
)paren
suffix:semicolon
multiline_comment|/*&n; * Driver Private Area, DPA.&n; */
r_typedef
r_struct
(brace
multiline_comment|/* &n;     *    pointer to the device structure which is part&n;     * of the interface to the Linux kernel.&n;     */
DECL|member|dev
r_struct
id|net_device
op_star
id|dev
suffix:semicolon
DECL|member|id
id|U8
id|id
suffix:semicolon
multiline_comment|/* the AdapterID */
DECL|member|pci_addr
id|U32
id|pci_addr
suffix:semicolon
multiline_comment|/* the pci address of the adapter */
DECL|member|bus
id|U32
id|bus
suffix:semicolon
DECL|member|function
id|U32
id|function
suffix:semicolon
DECL|member|timer
r_struct
id|timer_list
id|timer
suffix:semicolon
multiline_comment|/*  timer */
DECL|member|stats
r_struct
id|net_device_stats
id|stats
suffix:semicolon
multiline_comment|/* the statistics structure */
DECL|member|numOutRcvBuffers
r_int
r_int
id|numOutRcvBuffers
suffix:semicolon
multiline_comment|/* number of outstanding receive buffers*/
DECL|member|shutdown
r_int
r_char
id|shutdown
suffix:semicolon
DECL|member|reboot
r_int
r_char
id|reboot
suffix:semicolon
DECL|member|nexus
r_int
r_char
id|nexus
suffix:semicolon
DECL|member|PLanApiPA
id|PU8
id|PLanApiPA
suffix:semicolon
multiline_comment|/* Pointer to Lan Api Private Area */
)brace
DECL|typedef|DPA
DECL|typedef|PDPA
id|DPA
comma
op_star
id|PDPA
suffix:semicolon
DECL|macro|MAX_ADAPTERS
mdefine_line|#define MAX_ADAPTERS 32
DECL|variable|PCIAdapters
r_static
id|PDPA
id|PCIAdapters
(braket
id|MAX_ADAPTERS
)braket
suffix:semicolon
r_static
r_int
id|RCinit
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_int
id|RCopen
c_func
(paren
r_struct
id|net_device
op_star
)paren
suffix:semicolon
r_static
r_int
id|RC_xmit_packet
c_func
(paren
r_struct
id|sk_buff
op_star
comma
r_struct
id|net_device
op_star
)paren
suffix:semicolon
r_static
r_void
id|RCinterrupt
c_func
(paren
r_int
comma
r_void
op_star
comma
r_struct
id|pt_regs
op_star
)paren
suffix:semicolon
r_static
r_int
id|RCclose
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_struct
id|net_device_stats
op_star
id|RCget_stats
c_func
(paren
r_struct
id|net_device
op_star
)paren
suffix:semicolon
r_static
r_int
id|RCioctl
c_func
(paren
r_struct
id|net_device
op_star
comma
r_struct
id|ifreq
op_star
comma
r_int
)paren
suffix:semicolon
r_static
r_int
id|RCconfig
c_func
(paren
r_struct
id|net_device
op_star
comma
r_struct
id|ifmap
op_star
)paren
suffix:semicolon
r_static
r_void
id|RCxmit_callback
c_func
(paren
id|U32
comma
id|U16
comma
id|PU32
comma
id|U16
)paren
suffix:semicolon
r_static
r_void
id|RCrecv_callback
c_func
(paren
id|U32
comma
id|U8
comma
id|U32
comma
id|PU32
comma
id|U16
)paren
suffix:semicolon
r_static
r_void
id|RCreset_callback
c_func
(paren
id|U32
comma
id|U32
comma
id|U32
comma
id|U16
)paren
suffix:semicolon
r_static
r_void
id|RCreboot_callback
c_func
(paren
id|U32
comma
id|U32
comma
id|U32
comma
id|U16
)paren
suffix:semicolon
r_static
r_int
id|RC_allocate_and_post_buffers
c_func
(paren
r_struct
id|net_device
op_star
comma
r_int
)paren
suffix:semicolon
DECL|variable|__devinitdata
r_static
r_struct
id|pci_device_id
id|rcpci45_pci_table
(braket
)braket
id|__devinitdata
op_assign
(brace
(brace
id|RC_PCI45_VENDOR_ID
comma
id|RC_PCI45_DEVICE_ID
comma
id|PCI_ANY_ID
comma
id|PCI_ANY_ID
comma
l_int|0
comma
l_int|0
comma
l_int|0
)brace
comma
(brace
l_int|0
comma
)brace
)brace
suffix:semicolon
id|MODULE_DEVICE_TABLE
c_func
(paren
id|pci
comma
id|rcpci45_pci_table
)paren
suffix:semicolon
DECL|function|rcpci45_remove_one
r_static
r_void
id|rcpci45_remove_one
c_func
(paren
r_struct
id|pci_dev
op_star
id|pdev
)paren
(brace
r_struct
id|net_device
op_star
id|dev
op_assign
id|pdev-&gt;driver_data
suffix:semicolon
id|PDPA
id|pDpa
op_assign
id|dev-&gt;priv
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dev
)paren
(brace
id|printk
(paren
id|KERN_ERR
l_string|&quot;remove non-existent device&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;IOP reset: 0x%x&bslash;n&quot;
comma
id|RCResetIOP
c_func
(paren
id|pDpa-&gt;id
)paren
)paren
suffix:semicolon
id|unregister_netdev
c_func
(paren
id|dev
)paren
suffix:semicolon
id|iounmap
c_func
(paren
(paren
r_void
op_star
)paren
id|dev-&gt;base_addr
)paren
suffix:semicolon
id|free_irq
c_func
(paren
id|dev-&gt;irq
comma
id|dev
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
DECL|function|RCinit
r_static
r_int
id|RCinit
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
id|dev-&gt;open
op_assign
op_amp
id|RCopen
suffix:semicolon
id|dev-&gt;hard_start_xmit
op_assign
op_amp
id|RC_xmit_packet
suffix:semicolon
id|dev-&gt;stop
op_assign
op_amp
id|RCclose
suffix:semicolon
id|dev-&gt;get_stats
op_assign
op_amp
id|RCget_stats
suffix:semicolon
id|dev-&gt;do_ioctl
op_assign
op_amp
id|RCioctl
suffix:semicolon
id|dev-&gt;set_config
op_assign
op_amp
id|RCconfig
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|rcpci45_init_one
r_static
r_int
id|rcpci45_init_one
c_func
(paren
r_struct
id|pci_dev
op_star
id|pdev
comma
r_const
r_struct
id|pci_device_id
op_star
id|ent
)paren
(brace
r_int
id|dev_size
op_assign
l_int|32768
suffix:semicolon
r_int
r_int
op_star
id|vaddr
op_assign
l_int|0
suffix:semicolon
id|PDPA
id|pDpa
suffix:semicolon
r_int
id|init_status
suffix:semicolon
r_int
id|memaddr
op_assign
id|pci_resource_start
c_func
(paren
id|pdev
comma
l_int|0
)paren
suffix:semicolon
r_int
id|card_idx
suffix:semicolon
r_struct
id|net_device
op_star
id|dev
suffix:semicolon
r_static
r_int
id|card_counter
op_assign
l_int|0
suffix:semicolon
id|card_idx
op_assign
id|card_counter
op_increment
suffix:semicolon
multiline_comment|/* Yeah, icky hack. */
multiline_comment|/* &n;     * Allocate and fill new device structure. &n;     * We need enough for struct net_device plus DPA plus the LAN API private&n;     * area, which requires a minimum of 16KB.  The top of the allocated&n;     * area will be assigned to struct net_device; the next chunk will be&n;     * assigned to DPA; and finally, the rest will be assigned to the&n;     * the LAN API layer.&n;     */
id|dev
op_assign
(paren
r_struct
id|net_device
op_star
)paren
id|kmalloc
c_func
(paren
id|dev_size
comma
id|GFP_DMA
op_or
id|GFP_KERNEL
op_or
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dev
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;rcpci45 driver: unable to kmalloc dev struct&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
id|memset
c_func
(paren
id|dev
comma
l_int|0
comma
id|dev_size
)paren
suffix:semicolon
id|pdev-&gt;driver_data
op_assign
id|dev
suffix:semicolon
multiline_comment|/*&n;     * dev-&gt;priv will point to the start of DPA.&n;     */
id|dev-&gt;priv
op_assign
(paren
r_void
op_star
)paren
(paren
(paren
(paren
r_int
)paren
id|dev
op_plus
r_sizeof
(paren
r_struct
id|net_device
)paren
op_plus
l_int|15
)paren
op_amp
op_complement
l_int|15
)paren
suffix:semicolon
macro_line|#ifdef RCDEBUG
id|printk
c_func
(paren
l_string|&quot;rc: dev = 0x%x, dev-&gt;priv = 0x%x&bslash;n&quot;
comma
(paren
id|uint
)paren
id|dev
comma
(paren
id|uint
)paren
id|dev-&gt;priv
)paren
suffix:semicolon
macro_line|#endif
id|pDpa
op_assign
id|dev-&gt;priv
suffix:semicolon
id|pDpa-&gt;dev
op_assign
id|dev
suffix:semicolon
multiline_comment|/* this is just for easy reference */
id|pDpa-&gt;function
op_assign
id|pdev-&gt;devfn
suffix:semicolon
id|pDpa-&gt;bus
op_assign
(paren
r_int
r_char
)paren
id|pdev-&gt;bus-&gt;number
suffix:semicolon
id|pDpa-&gt;id
op_assign
id|card_idx
suffix:semicolon
multiline_comment|/* the device number */
id|pDpa-&gt;pci_addr
op_assign
id|memaddr
suffix:semicolon
id|PCIAdapters
(braket
id|card_idx
)braket
op_assign
id|pDpa
suffix:semicolon
macro_line|#ifdef RCDEBUG
id|printk
c_func
(paren
l_string|&quot;rc: pDpa = 0x%x, id = %d &bslash;n&quot;
comma
(paren
id|uint
)paren
id|pDpa
comma
(paren
id|uint
)paren
id|pDpa-&gt;id
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/*&n;     * Save the starting address of the LAN API private area.  We&squot;ll&n;     * pass that to RCInitI2OMsgLayer().&n;     */
id|pDpa-&gt;PLanApiPA
op_assign
(paren
r_void
op_star
)paren
(paren
(paren
(paren
r_int
)paren
id|pDpa
op_plus
r_sizeof
(paren
id|DPA
)paren
op_plus
l_int|0xff
)paren
op_amp
op_complement
l_int|0xff
)paren
suffix:semicolon
macro_line|#ifdef RCDEBUG
id|printk
c_func
(paren
l_string|&quot;rc: pDpa-&gt;PLanApiPA = 0x%x&bslash;n&quot;
comma
(paren
id|uint
)paren
id|pDpa-&gt;PLanApiPA
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/* The adapter is accessable through memory-access read/write, not&n;     * I/O read/write.  Thus, we need to map it to some virtual address&n;     * area in order to access the registers are normal memory.&n;     */
id|vaddr
op_assign
(paren
id|ulong
op_star
)paren
id|ioremap
(paren
id|memaddr
comma
l_int|2
op_star
l_int|32768
)paren
suffix:semicolon
macro_line|#ifdef RCDEBUG
id|printk
c_func
(paren
l_string|&quot;rc: RCfound_device: 0x%x, priv = 0x%x, vaddr = 0x%x&bslash;n&quot;
comma
(paren
id|uint
)paren
id|dev
comma
(paren
id|uint
)paren
id|dev-&gt;priv
comma
(paren
id|uint
)paren
id|vaddr
)paren
suffix:semicolon
macro_line|#endif
id|dev-&gt;base_addr
op_assign
(paren
r_int
r_int
)paren
id|vaddr
suffix:semicolon
id|dev-&gt;irq
op_assign
id|pdev-&gt;irq
suffix:semicolon
multiline_comment|/*&n;     * Request a shared interrupt line.&n;     */
r_if
c_cond
(paren
id|request_irq
c_func
(paren
id|dev-&gt;irq
comma
(paren
r_void
op_star
)paren
id|RCinterrupt
comma
id|SA_INTERRUPT
op_or
id|SA_SHIRQ
comma
l_string|&quot;RedCreek VPN Adapter&quot;
comma
id|dev
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;RC PCI 45: %s: unable to get IRQ %d&bslash;n&quot;
comma
(paren
id|PU8
)paren
id|dev-&gt;name
comma
(paren
id|uint
)paren
id|dev-&gt;irq
)paren
suffix:semicolon
id|iounmap
c_func
(paren
id|vaddr
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|dev
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
id|init_status
op_assign
id|RCInitI2OMsgLayer
c_func
(paren
id|pDpa-&gt;id
comma
id|dev-&gt;base_addr
comma
id|pDpa-&gt;PLanApiPA
comma
(paren
id|PU8
)paren
id|virt_to_bus
c_func
(paren
(paren
r_void
op_star
)paren
id|pDpa-&gt;PLanApiPA
)paren
comma
(paren
id|PFNTXCALLBACK
)paren
id|RCxmit_callback
comma
(paren
id|PFNRXCALLBACK
)paren
id|RCrecv_callback
comma
(paren
id|PFNCALLBACK
)paren
id|RCreboot_callback
)paren
suffix:semicolon
r_if
c_cond
(paren
id|init_status
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;rc: Unable to initialize msg layer&bslash;n&quot;
)paren
suffix:semicolon
id|free_irq
c_func
(paren
id|dev-&gt;irq
comma
id|dev
)paren
suffix:semicolon
id|iounmap
c_func
(paren
id|vaddr
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|dev
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|RCGetMAC
c_func
(paren
id|pDpa-&gt;id
comma
id|dev-&gt;dev_addr
comma
l_int|NULL
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;rc: Unable to get adapter MAC&bslash;n&quot;
)paren
suffix:semicolon
id|free_irq
c_func
(paren
id|dev-&gt;irq
comma
id|dev
)paren
suffix:semicolon
id|iounmap
c_func
(paren
id|vaddr
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|dev
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
id|DriverControlWord
op_or_assign
id|WARM_REBOOT_CAPABLE
suffix:semicolon
id|RCReportDriverCapability
c_func
(paren
id|pDpa-&gt;id
comma
id|DriverControlWord
)paren
suffix:semicolon
id|dev-&gt;init
op_assign
op_amp
id|RCinit
suffix:semicolon
id|ether_setup
c_func
(paren
id|dev
)paren
suffix:semicolon
multiline_comment|/* linux kernel interface */
r_if
c_cond
(paren
id|register_netdev
c_func
(paren
id|dev
)paren
op_ne
l_int|0
)paren
multiline_comment|/* linux kernel interface */
(brace
id|printk
c_func
(paren
l_string|&quot;rc: unable to register device &bslash;n&quot;
)paren
suffix:semicolon
id|free_irq
c_func
(paren
id|dev-&gt;irq
comma
id|dev
)paren
suffix:semicolon
id|iounmap
c_func
(paren
id|vaddr
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|dev
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;%s: RedCreek Communications IPSEC VPN adapter&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
multiline_comment|/* success */
)brace
DECL|variable|rcpci45_driver
r_static
r_struct
id|pci_driver
id|rcpci45_driver
op_assign
(brace
id|name
suffix:colon
l_string|&quot;rcpci45&quot;
comma
id|id_table
suffix:colon
id|rcpci45_pci_table
comma
id|probe
suffix:colon
id|rcpci45_init_one
comma
id|remove
suffix:colon
id|rcpci45_remove_one
comma
)brace
suffix:semicolon
DECL|function|rcpci_init_module
r_static
r_int
id|__init
id|rcpci_init_module
(paren
r_void
)paren
(brace
r_int
id|rc
op_assign
id|pci_module_init
c_func
(paren
op_amp
id|rcpci45_driver
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|rc
)paren
id|printk
c_func
(paren
id|version
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
r_static
r_int
DECL|function|RCopen
id|RCopen
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_int
id|post_buffers
op_assign
id|MAX_NMBR_RCV_BUFFERS
suffix:semicolon
id|PDPA
id|pDpa
op_assign
(paren
id|PDPA
)paren
id|dev-&gt;priv
suffix:semicolon
r_int
id|count
op_assign
l_int|0
suffix:semicolon
r_int
id|requested
op_assign
l_int|0
suffix:semicolon
macro_line|#ifdef RCDEBUG
id|printk
c_func
(paren
l_string|&quot;rc: RCopen&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
id|RCEnableI2OInterrupts
c_func
(paren
id|pDpa-&gt;id
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pDpa-&gt;nexus
)paren
(brace
multiline_comment|/* This is not the first time RCopen is called.  Thus,&n;         * the interface was previously opened and later closed&n;         * by RCclose().  RCclose() does a Shutdown; to wake up&n;         * the adapter, a reset is mandatory before we can post&n;         * receive buffers.  However, if the adapter initiated &n;         * a reboot while the interface was closed -- and interrupts&n;         * were turned off -- we need will need to reinitialize&n;         * the adapter, rather than simply waking it up.  &n;         */
id|printk
c_func
(paren
l_string|&quot;rc: Waking up adapter...&bslash;n&quot;
)paren
suffix:semicolon
id|RCResetLANCard
c_func
(paren
id|pDpa-&gt;id
comma
l_int|0
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
)brace
r_else
(brace
id|pDpa-&gt;nexus
op_assign
l_int|1
suffix:semicolon
)brace
r_while
c_loop
(paren
id|post_buffers
)paren
(brace
r_if
c_cond
(paren
id|post_buffers
OG
id|MAX_NMBR_POST_BUFFERS_PER_MSG
)paren
id|requested
op_assign
id|MAX_NMBR_POST_BUFFERS_PER_MSG
suffix:semicolon
r_else
id|requested
op_assign
id|post_buffers
suffix:semicolon
id|count
op_assign
id|RC_allocate_and_post_buffers
c_func
(paren
id|dev
comma
id|requested
)paren
suffix:semicolon
r_if
c_cond
(paren
id|count
OL
id|requested
)paren
(brace
multiline_comment|/*&n;             * Check to see if we were able to post any buffers at all.&n;             */
r_if
c_cond
(paren
id|post_buffers
op_eq
id|MAX_NMBR_RCV_BUFFERS
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;rc: Error RCopen: not able to allocate any buffers&bslash;r&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;rc: Warning RCopen: not able to allocate all requested buffers&bslash;r&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
multiline_comment|/* we&squot;ll try to post more buffers later */
)brace
r_else
id|post_buffers
op_sub_assign
id|count
suffix:semicolon
)brace
id|pDpa-&gt;numOutRcvBuffers
op_assign
id|MAX_NMBR_RCV_BUFFERS
op_minus
id|post_buffers
suffix:semicolon
id|pDpa-&gt;shutdown
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* just in case */
macro_line|#ifdef RCDEBUG
id|printk
c_func
(paren
l_string|&quot;rc: RCopen: posted %d buffers&bslash;n&quot;
comma
(paren
id|uint
)paren
id|pDpa-&gt;numOutRcvBuffers
)paren
suffix:semicolon
macro_line|#endif
id|MOD_INC_USE_COUNT
suffix:semicolon
id|netif_start_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_int
DECL|function|RC_xmit_packet
id|RC_xmit_packet
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|net_device
op_star
id|dev
)paren
(brace
id|PDPA
id|pDpa
op_assign
(paren
id|PDPA
)paren
id|dev-&gt;priv
suffix:semicolon
id|singleTCB
id|tcb
suffix:semicolon
id|psingleTCB
id|ptcb
op_assign
op_amp
id|tcb
suffix:semicolon
id|RC_RETURN
id|status
op_assign
l_int|0
suffix:semicolon
id|netif_stop_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pDpa-&gt;shutdown
op_logical_or
id|pDpa-&gt;reboot
)paren
(brace
macro_line|#ifdef RCDEBUG
id|printk
c_func
(paren
l_string|&quot;rc: RC_xmit_packet: tbusy!&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
r_return
l_int|1
suffix:semicolon
)brace
multiline_comment|/*&n;     * The user is free to reuse the TCB after RCI2OSendPacket() returns, since&n;     * the function copies the necessary info into its own private space.  Thus,&n;     * our TCB can be a local structure.  The skb, on the other hand, will be&n;     * freed up in our interrupt handler.&n;     */
id|ptcb-&gt;bcount
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* &n;     * we&squot;ll get the context when the adapter interrupts us to tell us that&n;     * the transmision is done. At that time, we can free skb.&n;     */
id|ptcb-&gt;b.context
op_assign
(paren
id|U32
)paren
id|skb
suffix:semicolon
id|ptcb-&gt;b.scount
op_assign
l_int|1
suffix:semicolon
id|ptcb-&gt;b.size
op_assign
id|skb-&gt;len
suffix:semicolon
id|ptcb-&gt;b.addr
op_assign
id|virt_to_bus
c_func
(paren
(paren
r_void
op_star
)paren
id|skb-&gt;data
)paren
suffix:semicolon
macro_line|#ifdef RCDEBUG
id|printk
c_func
(paren
l_string|&quot;rc: RC xmit: skb = 0x%x, pDpa = 0x%x, id = %d, ptcb = 0x%x&bslash;n&quot;
comma
(paren
id|uint
)paren
id|skb
comma
(paren
id|uint
)paren
id|pDpa
comma
(paren
id|uint
)paren
id|pDpa-&gt;id
comma
(paren
id|uint
)paren
id|ptcb
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
(paren
id|status
op_assign
id|RCI2OSendPacket
c_func
(paren
id|pDpa-&gt;id
comma
(paren
id|U32
)paren
l_int|NULL
comma
(paren
id|PRCTCB
)paren
id|ptcb
)paren
)paren
op_ne
id|RC_RTN_NO_ERROR
)paren
(brace
macro_line|#ifdef RCDEBUG
id|printk
c_func
(paren
l_string|&quot;rc: RC send error 0x%x&bslash;n&quot;
comma
(paren
id|uint
)paren
id|status
)paren
suffix:semicolon
macro_line|#endif
r_return
l_int|1
suffix:semicolon
)brace
r_else
(brace
id|dev-&gt;trans_start
op_assign
id|jiffies
suffix:semicolon
id|netif_wake_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;     * That&squot;s it!&n;     */
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * RCxmit_callback()&n; *&n; * The transmit callback routine. It&squot;s called by RCProcI2OMsgQ()&n; * because the adapter is done with one or more transmit buffers and&n; * it&squot;s returning them to us, or we asked the adapter to return the&n; * outstanding transmit buffers by calling RCResetLANCard() with &n; * RC_RESOURCE_RETURN_PEND_TX_BUFFERS flag. &n; * All we need to do is free the buffers.&n; */
r_static
r_void
DECL|function|RCxmit_callback
id|RCxmit_callback
c_func
(paren
id|U32
id|Status
comma
id|U16
id|PcktCount
comma
id|PU32
id|BufferContext
comma
id|U16
id|AdapterID
)paren
(brace
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
id|PDPA
id|pDpa
suffix:semicolon
r_struct
id|net_device
op_star
id|dev
suffix:semicolon
id|pDpa
op_assign
id|PCIAdapters
(braket
id|AdapterID
)braket
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pDpa
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;rc: Fatal error: xmit callback, !pDpa&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|dev
op_assign
id|pDpa-&gt;dev
suffix:semicolon
singleline_comment|// printk(&quot;xmit_callback: Status = 0x%x&bslash;n&quot;, (uint)Status);
r_if
c_cond
(paren
id|Status
op_ne
id|I2O_REPLY_STATUS_SUCCESS
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;rc: xmit_callback: Status = 0x%x&bslash;n&quot;
comma
(paren
id|uint
)paren
id|Status
)paren
suffix:semicolon
)brace
macro_line|#ifdef RCDEBUG
r_if
c_cond
(paren
id|pDpa-&gt;shutdown
op_logical_or
id|pDpa-&gt;reboot
)paren
id|printk
c_func
(paren
l_string|&quot;rc: xmit callback: shutdown||reboot&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
macro_line|#ifdef RCDEBUG     
id|printk
c_func
(paren
l_string|&quot;rc: xmit_callback: PcktCount = %d, BC = 0x%x&bslash;n&quot;
comma
(paren
id|uint
)paren
id|PcktCount
comma
(paren
id|uint
)paren
id|BufferContext
)paren
suffix:semicolon
macro_line|#endif
r_while
c_loop
(paren
id|PcktCount
op_decrement
)paren
(brace
id|skb
op_assign
(paren
r_struct
id|sk_buff
op_star
)paren
(paren
id|BufferContext
(braket
l_int|0
)braket
)paren
suffix:semicolon
macro_line|#ifdef RCDEBUG
id|printk
c_func
(paren
l_string|&quot;rc: skb = 0x%x&bslash;n&quot;
comma
(paren
id|uint
)paren
id|skb
)paren
suffix:semicolon
macro_line|#endif
id|BufferContext
op_increment
suffix:semicolon
id|dev_kfree_skb_irq
c_func
(paren
id|skb
)paren
suffix:semicolon
)brace
id|netif_wake_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
r_static
r_void
DECL|function|RCreset_callback
id|RCreset_callback
c_func
(paren
id|U32
id|Status
comma
id|U32
id|p1
comma
id|U32
id|p2
comma
id|U16
id|AdapterID
)paren
(brace
id|PDPA
id|pDpa
suffix:semicolon
r_struct
id|net_device
op_star
id|dev
suffix:semicolon
id|pDpa
op_assign
id|PCIAdapters
(braket
id|AdapterID
)braket
suffix:semicolon
id|dev
op_assign
id|pDpa-&gt;dev
suffix:semicolon
macro_line|#ifdef RCDEBUG
id|printk
c_func
(paren
l_string|&quot;rc: RCreset_callback Status 0x%x&bslash;n&quot;
comma
(paren
id|uint
)paren
id|Status
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/*&n;     * Check to see why we were called.&n;     */
r_if
c_cond
(paren
id|pDpa-&gt;shutdown
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;rc: Shutting down interface&bslash;n&quot;
)paren
suffix:semicolon
id|pDpa-&gt;shutdown
op_assign
l_int|0
suffix:semicolon
id|pDpa-&gt;reboot
op_assign
l_int|0
suffix:semicolon
id|MOD_DEC_USE_COUNT
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|pDpa-&gt;reboot
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;rc: reboot, shutdown adapter&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/*&n;         * We don&squot;t set any of the flags in RCShutdownLANCard()&n;         * and we don&squot;t pass a callback routine to it.&n;         * The adapter will have already initiated the reboot by&n;         * the time the function returns.&n;         */
id|RCDisableI2OInterrupts
c_func
(paren
id|pDpa-&gt;id
)paren
suffix:semicolon
id|RCShutdownLANCard
c_func
(paren
id|pDpa-&gt;id
comma
l_int|0
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;rc: scheduling timer...&bslash;n&quot;
)paren
suffix:semicolon
id|init_timer
c_func
(paren
op_amp
id|pDpa-&gt;timer
)paren
suffix:semicolon
id|pDpa-&gt;timer.expires
op_assign
id|RUN_AT
c_func
(paren
(paren
l_int|40
op_star
id|HZ
)paren
op_div
l_int|10
)paren
suffix:semicolon
multiline_comment|/* 4 sec. */
id|pDpa-&gt;timer.data
op_assign
(paren
r_int
r_int
)paren
id|dev
suffix:semicolon
id|pDpa-&gt;timer.function
op_assign
op_amp
id|rc_timer
suffix:semicolon
multiline_comment|/* timer handler */
id|add_timer
c_func
(paren
op_amp
id|pDpa-&gt;timer
)paren
suffix:semicolon
)brace
)brace
r_static
r_void
DECL|function|RCreboot_callback
id|RCreboot_callback
c_func
(paren
id|U32
id|Status
comma
id|U32
id|p1
comma
id|U32
id|p2
comma
id|U16
id|AdapterID
)paren
(brace
id|PDPA
id|pDpa
suffix:semicolon
id|pDpa
op_assign
id|PCIAdapters
(braket
id|AdapterID
)braket
suffix:semicolon
macro_line|#ifdef RCDEBUG
id|printk
c_func
(paren
l_string|&quot;rc: RCreboot: rcv buffers outstanding = %d&bslash;n&quot;
comma
(paren
id|uint
)paren
id|pDpa-&gt;numOutRcvBuffers
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|pDpa-&gt;shutdown
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;rc: skipping reboot sequence -- shutdown already initiated&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|pDpa-&gt;reboot
op_assign
l_int|1
suffix:semicolon
multiline_comment|/*&n;     * OK, we reset the adapter and ask it to return all&n;     * outstanding transmit buffers as well as the posted&n;     * receive buffers.  When the adapter is done returning&n;     * those buffers, it will call our RCreset_callback() &n;     * routine.  In that routine, we&squot;ll call RCShutdownLANCard()&n;     * to tell the adapter that it&squot;s OK to start the reboot and&n;     * schedule a timer callback routine to execute 3 seconds &n;     * later; this routine will reinitialize the adapter at that time.&n;     */
id|RCResetLANCard
c_func
(paren
id|pDpa-&gt;id
comma
id|RC_RESOURCE_RETURN_POSTED_RX_BUCKETS
op_or
id|RC_RESOURCE_RETURN_PEND_TX_BUFFERS
comma
l_int|0
comma
(paren
id|PFNCALLBACK
)paren
id|RCreset_callback
)paren
suffix:semicolon
)brace
DECL|function|broadcast_packet
r_int
id|broadcast_packet
c_func
(paren
r_int
r_char
op_star
id|address
)paren
(brace
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|6
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
id|address
(braket
id|i
)braket
op_ne
l_int|0xff
)paren
r_return
l_int|0
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
multiline_comment|/*&n; * RCrecv_callback()&n; * &n; * The receive packet callback routine.  This is called by&n; * RCProcI2OMsgQ() after the adapter posts buffers which have been&n; * filled (one ethernet packet per buffer).&n; */
r_static
r_void
DECL|function|RCrecv_callback
id|RCrecv_callback
c_func
(paren
id|U32
id|Status
comma
id|U8
id|PktCount
comma
id|U32
id|BucketsRemain
comma
id|PU32
id|PacketDescBlock
comma
id|U16
id|AdapterID
)paren
(brace
id|U32
id|len
comma
id|count
suffix:semicolon
id|PDPA
id|pDpa
suffix:semicolon
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
r_struct
id|net_device
op_star
id|dev
suffix:semicolon
id|singleTCB
id|tcb
suffix:semicolon
id|psingleTCB
id|ptcb
op_assign
op_amp
id|tcb
suffix:semicolon
id|pDpa
op_assign
id|PCIAdapters
(braket
id|AdapterID
)braket
suffix:semicolon
id|dev
op_assign
id|pDpa-&gt;dev
suffix:semicolon
id|ptcb-&gt;bcount
op_assign
l_int|1
suffix:semicolon
macro_line|#ifdef RCDEBUG
id|printk
c_func
(paren
l_string|&quot;rc: RCrecv_callback: 0x%x, 0x%x, 0x%x&bslash;n&quot;
comma
(paren
id|uint
)paren
id|PktCount
comma
(paren
id|uint
)paren
id|BucketsRemain
comma
(paren
id|uint
)paren
id|PacketDescBlock
)paren
suffix:semicolon
macro_line|#endif
macro_line|#ifdef RCDEBUG
r_if
c_cond
(paren
(paren
id|pDpa-&gt;shutdown
op_logical_or
id|pDpa-&gt;reboot
)paren
op_logical_and
op_logical_neg
id|Status
)paren
id|printk
c_func
(paren
l_string|&quot;shutdown||reboot &amp;&amp; !Status: PktCount = %d&bslash;n&quot;
comma
id|PktCount
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
(paren
id|Status
op_ne
id|I2O_REPLY_STATUS_SUCCESS
)paren
op_logical_or
id|pDpa-&gt;shutdown
)paren
(brace
multiline_comment|/*&n;             * Free whatever buffers the adapter returned, but don&squot;t&n;             * pass them to the kernel.&n;             */
r_if
c_cond
(paren
op_logical_neg
id|pDpa-&gt;shutdown
op_logical_and
op_logical_neg
id|pDpa-&gt;reboot
)paren
id|printk
c_func
(paren
l_string|&quot;rc: RCrecv error: status = 0x%x&bslash;n&quot;
comma
(paren
id|uint
)paren
id|Status
)paren
suffix:semicolon
macro_line|#ifdef RCDEBUG
r_else
id|printk
c_func
(paren
l_string|&quot;rc: Returning %d buffers, status = 0x%x&bslash;n&quot;
comma
id|PktCount
comma
(paren
id|uint
)paren
id|Status
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/*&n;             * TO DO: check the nature of the failure and put the adapter in&n;             * failed mode if it&squot;s a hard failure.  Send a reset to the adapter&n;             * and free all outstanding memory.&n;             */
r_if
c_cond
(paren
id|Status
op_eq
id|I2O_REPLY_STATUS_ABORT_NO_DATA_TRANSFER
)paren
(brace
macro_line|#ifdef RCDEBUG
id|printk
c_func
(paren
l_string|&quot;RCrecv status ABORT NO DATA TRANSFER&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
)brace
multiline_comment|/* check for reset status: I2O_REPLY_STATUS_ABORT_NO_DATA_TRANSFER */
r_if
c_cond
(paren
id|PacketDescBlock
)paren
(brace
r_while
c_loop
(paren
id|PktCount
op_decrement
)paren
(brace
id|skb
op_assign
(paren
r_struct
id|sk_buff
op_star
)paren
id|PacketDescBlock
(braket
l_int|0
)braket
suffix:semicolon
macro_line|#ifdef RCDEBUG
id|printk
c_func
(paren
l_string|&quot;free skb 0x%p&bslash;n&quot;
comma
id|skb
)paren
suffix:semicolon
macro_line|#endif
id|dev_kfree_skb
(paren
id|skb
)paren
suffix:semicolon
id|pDpa-&gt;numOutRcvBuffers
op_decrement
suffix:semicolon
id|PacketDescBlock
op_add_assign
id|BD_SIZE
suffix:semicolon
multiline_comment|/* point to next context field */
)brace
)brace
r_return
suffix:semicolon
)brace
r_else
(brace
r_while
c_loop
(paren
id|PktCount
op_decrement
)paren
(brace
id|skb
op_assign
(paren
r_struct
id|sk_buff
op_star
)paren
id|PacketDescBlock
(braket
l_int|0
)braket
suffix:semicolon
macro_line|#ifdef RCDEBUG
r_if
c_cond
(paren
id|pDpa-&gt;shutdown
)paren
id|printk
c_func
(paren
l_string|&quot;shutdown: skb=0x%x&bslash;n&quot;
comma
(paren
id|uint
)paren
id|skb
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;skb = 0x%x: 0x%x 0x%x 0x%x 0x%x 0x%x 0x%x&bslash;n&quot;
comma
(paren
id|uint
)paren
id|skb
comma
(paren
id|uint
)paren
id|skb-&gt;data
(braket
l_int|0
)braket
comma
(paren
id|uint
)paren
id|skb-&gt;data
(braket
l_int|1
)braket
comma
(paren
id|uint
)paren
id|skb-&gt;data
(braket
l_int|2
)braket
comma
(paren
id|uint
)paren
id|skb-&gt;data
(braket
l_int|3
)braket
comma
(paren
id|uint
)paren
id|skb-&gt;data
(braket
l_int|4
)braket
comma
(paren
id|uint
)paren
id|skb-&gt;data
(braket
l_int|5
)braket
)paren
suffix:semicolon
macro_line|#endif
macro_line|#ifdef PROMISCUOUS_BY_DEFAULT   /* early 2.x firmware */
r_if
c_cond
(paren
(paren
id|memcmp
c_func
(paren
id|dev-&gt;dev_addr
comma
id|skb-&gt;data
comma
l_int|6
)paren
)paren
op_logical_and
(paren
op_logical_neg
id|broadcast_packet
c_func
(paren
id|skb-&gt;data
)paren
)paren
)paren
(brace
multiline_comment|/*&n;                     * Re-post the buffer to the adapter.  Since the adapter usually&n;                     * return 1 to 2 receive buffers at a time, it&squot;s not too inefficient&n;                     * post one buffer at a time but ... may be that should be &n;                     * optimized at some point.&n;                     */
id|ptcb-&gt;b.context
op_assign
(paren
id|U32
)paren
id|skb
suffix:semicolon
id|ptcb-&gt;b.scount
op_assign
l_int|1
suffix:semicolon
id|ptcb-&gt;b.size
op_assign
id|MAX_ETHER_SIZE
suffix:semicolon
id|ptcb-&gt;b.addr
op_assign
id|virt_to_bus
c_func
(paren
(paren
r_void
op_star
)paren
id|skb-&gt;data
)paren
suffix:semicolon
r_if
c_cond
(paren
id|RCPostRecvBuffers
c_func
(paren
id|pDpa-&gt;id
comma
(paren
id|PRCTCB
)paren
id|ptcb
)paren
op_ne
id|RC_RTN_NO_ERROR
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;rc: RCrecv_callback: post buffer failed!&bslash;n&quot;
)paren
suffix:semicolon
id|dev_kfree_skb
(paren
id|skb
)paren
suffix:semicolon
)brace
r_else
(brace
id|pDpa-&gt;numOutRcvBuffers
op_increment
suffix:semicolon
)brace
)brace
r_else
macro_line|#endif /* PROMISCUOUS_BY_DEFAULT */
(brace
id|len
op_assign
id|PacketDescBlock
(braket
l_int|2
)braket
suffix:semicolon
id|skb-&gt;dev
op_assign
id|dev
suffix:semicolon
id|skb_put
c_func
(paren
id|skb
comma
id|len
)paren
suffix:semicolon
multiline_comment|/* adjust length and tail */
id|skb-&gt;protocol
op_assign
id|eth_type_trans
c_func
(paren
id|skb
comma
id|dev
)paren
suffix:semicolon
id|netif_rx
c_func
(paren
id|skb
)paren
suffix:semicolon
multiline_comment|/* send the packet to the kernel */
id|dev-&gt;last_rx
op_assign
id|jiffies
suffix:semicolon
)brace
id|pDpa-&gt;numOutRcvBuffers
op_decrement
suffix:semicolon
id|PacketDescBlock
op_add_assign
id|BD_SIZE
suffix:semicolon
multiline_comment|/* point to next context field */
)brace
)brace
multiline_comment|/*&n;         * Replenish the posted receive buffers. &n;         * DO NOT replenish buffers if the driver has already&n;         * initiated a reboot or shutdown!&n;         */
r_if
c_cond
(paren
op_logical_neg
id|pDpa-&gt;shutdown
op_logical_and
op_logical_neg
id|pDpa-&gt;reboot
)paren
(brace
id|count
op_assign
id|RC_allocate_and_post_buffers
c_func
(paren
id|dev
comma
id|MAX_NMBR_RCV_BUFFERS
op_minus
id|pDpa-&gt;numOutRcvBuffers
)paren
suffix:semicolon
id|pDpa-&gt;numOutRcvBuffers
op_add_assign
id|count
suffix:semicolon
)brace
)brace
multiline_comment|/*&n; * RCinterrupt()&n; * &n; * Interrupt handler. &n; * This routine sets up a couple of pointers and calls&n; * RCProcI2OMsgQ(), which in turn process the message and&n; * calls one of our callback functions.&n; */
r_static
r_void
DECL|function|RCinterrupt
id|RCinterrupt
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
id|PDPA
id|pDpa
suffix:semicolon
r_struct
id|net_device
op_star
id|dev
op_assign
(paren
r_struct
id|net_device
op_star
)paren
(paren
id|dev_id
)paren
suffix:semicolon
id|pDpa
op_assign
(paren
id|PDPA
)paren
(paren
id|dev-&gt;priv
)paren
suffix:semicolon
macro_line|#ifdef RCDEBUG
r_if
c_cond
(paren
id|pDpa-&gt;shutdown
)paren
id|printk
c_func
(paren
l_string|&quot;rc: shutdown: service irq&bslash;n&quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;RC irq: pDpa = 0x%x, dev = 0x%x, id = %d&bslash;n&quot;
comma
(paren
id|uint
)paren
id|pDpa
comma
(paren
id|uint
)paren
id|dev
comma
(paren
id|uint
)paren
id|pDpa-&gt;id
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;dev = 0x%x&bslash;n&quot;
comma
(paren
id|uint
)paren
id|dev
)paren
suffix:semicolon
macro_line|#endif
id|RCProcI2OMsgQ
c_func
(paren
id|pDpa-&gt;id
)paren
suffix:semicolon
)brace
DECL|macro|REBOOT_REINIT_RETRY_LIMIT
mdefine_line|#define REBOOT_REINIT_RETRY_LIMIT 4
DECL|function|rc_timer
r_static
r_void
id|rc_timer
c_func
(paren
r_int
r_int
id|data
)paren
(brace
r_struct
id|net_device
op_star
id|dev
op_assign
(paren
r_struct
id|net_device
op_star
)paren
id|data
suffix:semicolon
id|PDPA
id|pDpa
op_assign
(paren
id|PDPA
)paren
(paren
id|dev-&gt;priv
)paren
suffix:semicolon
r_int
id|init_status
suffix:semicolon
r_static
r_int
id|retry
suffix:semicolon
r_int
id|post_buffers
op_assign
id|MAX_NMBR_RCV_BUFFERS
suffix:semicolon
r_int
id|count
op_assign
l_int|0
suffix:semicolon
r_int
id|requested
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|pDpa-&gt;reboot
)paren
(brace
id|init_status
op_assign
id|RCInitI2OMsgLayer
c_func
(paren
id|pDpa-&gt;id
comma
id|dev-&gt;base_addr
comma
id|pDpa-&gt;PLanApiPA
comma
(paren
id|PU8
)paren
id|virt_to_bus
c_func
(paren
(paren
r_void
op_star
)paren
id|pDpa-&gt;PLanApiPA
)paren
comma
(paren
id|PFNTXCALLBACK
)paren
id|RCxmit_callback
comma
(paren
id|PFNRXCALLBACK
)paren
id|RCrecv_callback
comma
(paren
id|PFNCALLBACK
)paren
id|RCreboot_callback
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|init_status
)paren
(brace
r_case
id|RC_RTN_NO_ERROR
suffix:colon
id|pDpa-&gt;reboot
op_assign
l_int|0
suffix:semicolon
id|pDpa-&gt;shutdown
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* just in case */
id|RCReportDriverCapability
c_func
(paren
id|pDpa-&gt;id
comma
id|DriverControlWord
)paren
suffix:semicolon
id|RCEnableI2OInterrupts
c_func
(paren
id|pDpa-&gt;id
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;flags
op_amp
id|IFF_UP
)paren
(brace
r_while
c_loop
(paren
id|post_buffers
)paren
(brace
r_if
c_cond
(paren
id|post_buffers
OG
id|MAX_NMBR_POST_BUFFERS_PER_MSG
)paren
id|requested
op_assign
id|MAX_NMBR_POST_BUFFERS_PER_MSG
suffix:semicolon
r_else
id|requested
op_assign
id|post_buffers
suffix:semicolon
id|count
op_assign
id|RC_allocate_and_post_buffers
c_func
(paren
id|dev
comma
id|requested
)paren
suffix:semicolon
id|post_buffers
op_sub_assign
id|count
suffix:semicolon
r_if
c_cond
(paren
id|count
OL
id|requested
)paren
r_break
suffix:semicolon
)brace
id|pDpa-&gt;numOutRcvBuffers
op_assign
id|MAX_NMBR_RCV_BUFFERS
op_minus
id|post_buffers
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;rc: posted %d buffers &bslash;r&bslash;n&quot;
comma
(paren
id|uint
)paren
id|pDpa-&gt;numOutRcvBuffers
)paren
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;rc: Initialization done.&bslash;n&quot;
)paren
suffix:semicolon
id|netif_wake_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
id|retry
op_assign
l_int|0
suffix:semicolon
r_return
suffix:semicolon
r_case
id|RC_RTN_FREE_Q_EMPTY
suffix:colon
id|retry
op_increment
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;rc: inbound free q empty&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|retry
op_increment
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;rc: bad status after reboot: %d&bslash;n&quot;
comma
id|init_status
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|retry
OG
id|REBOOT_REINIT_RETRY_LIMIT
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;rc: unable to reinitialize adapter after reboot&bslash;n&quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;rc: decrementing driver and closing interface&bslash;n&quot;
)paren
suffix:semicolon
id|RCDisableI2OInterrupts
c_func
(paren
id|pDpa-&gt;id
)paren
suffix:semicolon
id|dev-&gt;flags
op_and_assign
op_complement
id|IFF_UP
suffix:semicolon
id|MOD_DEC_USE_COUNT
suffix:semicolon
)brace
r_else
(brace
id|printk
c_func
(paren
l_string|&quot;rc: rescheduling timer...&bslash;n&quot;
)paren
suffix:semicolon
id|init_timer
c_func
(paren
op_amp
id|pDpa-&gt;timer
)paren
suffix:semicolon
id|pDpa-&gt;timer.expires
op_assign
id|RUN_AT
c_func
(paren
(paren
l_int|40
op_star
id|HZ
)paren
op_div
l_int|10
)paren
suffix:semicolon
multiline_comment|/* 3 sec. */
id|pDpa-&gt;timer.data
op_assign
(paren
r_int
r_int
)paren
id|dev
suffix:semicolon
id|pDpa-&gt;timer.function
op_assign
op_amp
id|rc_timer
suffix:semicolon
multiline_comment|/* timer handler */
id|add_timer
c_func
(paren
op_amp
id|pDpa-&gt;timer
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
id|printk
c_func
(paren
l_string|&quot;rc: timer??&bslash;n&quot;
)paren
suffix:semicolon
)brace
)brace
r_static
r_int
DECL|function|RCclose
id|RCclose
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
id|PDPA
id|pDpa
op_assign
(paren
id|PDPA
)paren
id|dev-&gt;priv
suffix:semicolon
id|netif_stop_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
macro_line|#ifdef RCDEBUG
id|printk
c_func
(paren
l_string|&quot;rc: RCclose&bslash;r&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|pDpa-&gt;reboot
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;rc: skipping reset -- adapter already in reboot mode&bslash;n&quot;
)paren
suffix:semicolon
id|dev-&gt;flags
op_and_assign
op_complement
id|IFF_UP
suffix:semicolon
id|pDpa-&gt;shutdown
op_assign
l_int|1
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#ifdef RCDEBUG
id|printk
c_func
(paren
l_string|&quot;rc: receive buffers outstanding: %d&bslash;n&quot;
comma
(paren
id|uint
)paren
id|pDpa-&gt;numOutRcvBuffers
)paren
suffix:semicolon
macro_line|#endif
id|pDpa-&gt;shutdown
op_assign
l_int|1
suffix:semicolon
multiline_comment|/*&n;     * We can&squot;t allow the driver to be unloaded until the adapter returns&n;     * all posted receive buffers.  It doesn&squot;t hurt to tell the adapter&n;     * to return all posted receive buffers and outstanding xmit buffers,&n;     * even if there are none.&n;     */
id|RCShutdownLANCard
c_func
(paren
id|pDpa-&gt;id
comma
id|RC_RESOURCE_RETURN_POSTED_RX_BUCKETS
op_or
id|RC_RESOURCE_RETURN_PEND_TX_BUFFERS
comma
l_int|0
comma
(paren
id|PFNCALLBACK
)paren
id|RCreset_callback
)paren
suffix:semicolon
id|dev-&gt;flags
op_and_assign
op_complement
id|IFF_UP
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_struct
id|net_device_stats
op_star
DECL|function|RCget_stats
id|RCget_stats
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
id|RCLINKSTATS
id|RCstats
suffix:semicolon
id|PDPA
id|pDpa
op_assign
id|dev-&gt;priv
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pDpa
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;rc: RCget_stats: !pDpa&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
op_logical_neg
(paren
id|dev-&gt;flags
op_amp
id|IFF_UP
)paren
)paren
(brace
macro_line|#ifdef RCDEBUG
id|printk
c_func
(paren
l_string|&quot;rc: RCget_stats: device down&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
r_return
l_int|0
suffix:semicolon
)brace
id|memset
c_func
(paren
op_amp
id|RCstats
comma
l_int|0
comma
r_sizeof
(paren
id|RCLINKSTATS
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|RCGetLinkStatistics
c_func
(paren
id|pDpa-&gt;id
comma
op_amp
id|RCstats
comma
(paren
r_void
op_star
)paren
l_int|0
)paren
)paren
op_eq
id|RC_RTN_NO_ERROR
)paren
(brace
macro_line|#ifdef RCDEBUG
id|printk
c_func
(paren
l_string|&quot;rc: TX_good 0x%x&bslash;n&quot;
comma
(paren
id|uint
)paren
id|RCstats.TX_good
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;rc: TX_maxcol 0x%x&bslash;n&quot;
comma
(paren
id|uint
)paren
id|RCstats.TX_maxcol
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;rc: TX_latecol 0x%x&bslash;n&quot;
comma
(paren
id|uint
)paren
id|RCstats.TX_latecol
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;rc: TX_urun 0x%x&bslash;n&quot;
comma
(paren
id|uint
)paren
id|RCstats.TX_urun
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;rc: TX_crs 0x%x&bslash;n&quot;
comma
(paren
id|uint
)paren
id|RCstats.TX_crs
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;rc: TX_def 0x%x&bslash;n&quot;
comma
(paren
id|uint
)paren
id|RCstats.TX_def
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;rc: TX_singlecol 0x%x&bslash;n&quot;
comma
(paren
id|uint
)paren
id|RCstats.TX_singlecol
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;rc: TX_multcol 0x%x&bslash;n&quot;
comma
(paren
id|uint
)paren
id|RCstats.TX_multcol
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;rc: TX_totcol 0x%x&bslash;n&quot;
comma
(paren
id|uint
)paren
id|RCstats.TX_totcol
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;rc: Rcv_good 0x%x&bslash;n&quot;
comma
(paren
id|uint
)paren
id|RCstats.Rcv_good
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;rc: Rcv_CRCerr 0x%x&bslash;n&quot;
comma
(paren
id|uint
)paren
id|RCstats.Rcv_CRCerr
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;rc: Rcv_alignerr 0x%x&bslash;n&quot;
comma
(paren
id|uint
)paren
id|RCstats.Rcv_alignerr
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;rc: Rcv_reserr 0x%x&bslash;n&quot;
comma
(paren
id|uint
)paren
id|RCstats.Rcv_reserr
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;rc: Rcv_orun 0x%x&bslash;n&quot;
comma
(paren
id|uint
)paren
id|RCstats.Rcv_orun
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;rc: Rcv_cdt 0x%x&bslash;n&quot;
comma
(paren
id|uint
)paren
id|RCstats.Rcv_cdt
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;rc: Rcv_runt 0x%x&bslash;n&quot;
comma
(paren
id|uint
)paren
id|RCstats.Rcv_runt
)paren
suffix:semicolon
macro_line|#endif
id|pDpa-&gt;stats.rx_packets
op_assign
id|RCstats.Rcv_good
suffix:semicolon
multiline_comment|/* total packets received    */
id|pDpa-&gt;stats.tx_packets
op_assign
id|RCstats.TX_good
suffix:semicolon
multiline_comment|/* total packets transmitted    */
id|pDpa-&gt;stats.rx_errors
op_assign
id|RCstats.Rcv_CRCerr
op_plus
id|RCstats.Rcv_alignerr
op_plus
id|RCstats.Rcv_reserr
op_plus
id|RCstats.Rcv_orun
op_plus
id|RCstats.Rcv_cdt
op_plus
id|RCstats.Rcv_runt
suffix:semicolon
multiline_comment|/* bad packets received        */
id|pDpa-&gt;stats.tx_errors
op_assign
id|RCstats.TX_urun
op_plus
id|RCstats.TX_crs
op_plus
id|RCstats.TX_def
op_plus
id|RCstats.TX_totcol
suffix:semicolon
multiline_comment|/* packet transmit problems    */
multiline_comment|/*&n;         * This needs improvement.&n;         */
id|pDpa-&gt;stats.rx_dropped
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* no space in linux buffers    */
id|pDpa-&gt;stats.tx_dropped
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* no space available in linux    */
id|pDpa-&gt;stats.multicast
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* multicast packets received    */
id|pDpa-&gt;stats.collisions
op_assign
id|RCstats.TX_totcol
suffix:semicolon
multiline_comment|/* detailed rx_errors: */
id|pDpa-&gt;stats.rx_length_errors
op_assign
l_int|0
suffix:semicolon
id|pDpa-&gt;stats.rx_over_errors
op_assign
id|RCstats.Rcv_orun
suffix:semicolon
multiline_comment|/* receiver ring buff overflow    */
id|pDpa-&gt;stats.rx_crc_errors
op_assign
id|RCstats.Rcv_CRCerr
suffix:semicolon
multiline_comment|/* recved pkt with crc error    */
id|pDpa-&gt;stats.rx_frame_errors
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* recv&squot;d frame alignment error */
id|pDpa-&gt;stats.rx_fifo_errors
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* recv&squot;r fifo overrun        */
id|pDpa-&gt;stats.rx_missed_errors
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* receiver missed packet    */
multiline_comment|/* detailed tx_errors */
id|pDpa-&gt;stats.tx_aborted_errors
op_assign
l_int|0
suffix:semicolon
id|pDpa-&gt;stats.tx_carrier_errors
op_assign
l_int|0
suffix:semicolon
id|pDpa-&gt;stats.tx_fifo_errors
op_assign
l_int|0
suffix:semicolon
id|pDpa-&gt;stats.tx_heartbeat_errors
op_assign
l_int|0
suffix:semicolon
id|pDpa-&gt;stats.tx_window_errors
op_assign
l_int|0
suffix:semicolon
r_return
(paren
(paren
r_struct
id|net_device_stats
op_star
)paren
op_amp
(paren
id|pDpa-&gt;stats
)paren
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|RCioctl
r_static
r_int
id|RCioctl
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_struct
id|ifreq
op_star
id|rq
comma
r_int
id|cmd
)paren
(brace
id|RCuser_struct
id|RCuser
suffix:semicolon
id|PDPA
id|pDpa
op_assign
id|dev-&gt;priv
suffix:semicolon
macro_line|#if RCDEBUG
id|printk
c_func
(paren
l_string|&quot;RCioctl: cmd = 0x%x&bslash;n&quot;
comma
id|cmd
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
op_logical_neg
id|capable
c_func
(paren
id|CAP_NET_ADMIN
)paren
)paren
(brace
r_return
op_minus
id|EPERM
suffix:semicolon
)brace
r_switch
c_cond
(paren
id|cmd
)paren
(brace
r_case
id|RCU_PROTOCOL_REV
suffix:colon
multiline_comment|/*&n;         * Assign user protocol revision, to tell user-level&n;         * controller program whether or not it&squot;s in sync.&n;         */
id|rq-&gt;ifr_ifru.ifru_data
op_assign
(paren
id|caddr_t
)paren
id|USER_PROTOCOL_REV
suffix:semicolon
r_break
suffix:semicolon
r_case
id|RCU_COMMAND
suffix:colon
(brace
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|RCuser
comma
id|rq-&gt;ifr_data
comma
r_sizeof
(paren
id|RCuser
)paren
)paren
)paren
(brace
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
macro_line|#ifdef RCDEBUG
id|printk
c_func
(paren
l_string|&quot;RCioctl: RCuser_cmd = 0x%x&bslash;n&quot;
comma
id|RCuser.cmd
)paren
suffix:semicolon
macro_line|#endif
r_switch
c_cond
(paren
id|RCuser.cmd
)paren
(brace
r_case
id|RCUC_GETFWVER
suffix:colon
id|printk
c_func
(paren
l_string|&quot;RC GETFWVER&bslash;n&quot;
)paren
suffix:semicolon
id|RCUD_GETFWVER
op_assign
op_amp
id|RCuser.RCUS_GETFWVER
suffix:semicolon
id|RCGetFirmwareVer
c_func
(paren
id|pDpa-&gt;id
comma
(paren
id|PU8
)paren
op_amp
id|RCUD_GETFWVER-&gt;FirmString
comma
l_int|NULL
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|RCUC_GETINFO
suffix:colon
id|printk
c_func
(paren
l_string|&quot;RC GETINFO&bslash;n&quot;
)paren
suffix:semicolon
id|RCUD_GETINFO
op_assign
op_amp
id|RCuser.RCUS_GETINFO
suffix:semicolon
id|RCUD_GETINFO
op_member_access_from_pointer
id|mem_start
op_assign
id|dev-&gt;base_addr
suffix:semicolon
id|RCUD_GETINFO
op_member_access_from_pointer
id|mem_end
op_assign
id|dev-&gt;base_addr
op_plus
l_int|2
op_star
l_int|32768
suffix:semicolon
id|RCUD_GETINFO
op_member_access_from_pointer
id|base_addr
op_assign
id|pDpa-&gt;pci_addr
suffix:semicolon
id|RCUD_GETINFO
op_member_access_from_pointer
id|irq
op_assign
id|dev-&gt;irq
suffix:semicolon
r_break
suffix:semicolon
r_case
id|RCUC_GETIPANDMASK
suffix:colon
id|printk
c_func
(paren
l_string|&quot;RC GETIPANDMASK&bslash;n&quot;
)paren
suffix:semicolon
id|RCUD_GETIPANDMASK
op_assign
op_amp
id|RCuser.RCUS_GETIPANDMASK
suffix:semicolon
id|RCGetRavlinIPandMask
c_func
(paren
id|pDpa-&gt;id
comma
(paren
id|PU32
)paren
op_amp
id|RCUD_GETIPANDMASK-&gt;IpAddr
comma
(paren
id|PU32
)paren
op_amp
id|RCUD_GETIPANDMASK-&gt;NetMask
comma
l_int|NULL
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|RCUC_GETLINKSTATISTICS
suffix:colon
id|printk
c_func
(paren
l_string|&quot;RC GETLINKSTATISTICS&bslash;n&quot;
)paren
suffix:semicolon
id|RCUD_GETLINKSTATISTICS
op_assign
op_amp
id|RCuser.RCUS_GETLINKSTATISTICS
suffix:semicolon
id|RCGetLinkStatistics
c_func
(paren
id|pDpa-&gt;id
comma
(paren
id|P_RCLINKSTATS
)paren
op_amp
id|RCUD_GETLINKSTATISTICS-&gt;StatsReturn
comma
l_int|NULL
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|RCUC_GETLINKSTATUS
suffix:colon
id|printk
c_func
(paren
l_string|&quot;RC GETLINKSTATUS&bslash;n&quot;
)paren
suffix:semicolon
id|RCUD_GETLINKSTATUS
op_assign
op_amp
id|RCuser.RCUS_GETLINKSTATUS
suffix:semicolon
id|RCGetLinkStatus
c_func
(paren
id|pDpa-&gt;id
comma
(paren
id|PU32
)paren
op_amp
id|RCUD_GETLINKSTATUS-&gt;ReturnStatus
comma
l_int|NULL
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|RCUC_GETMAC
suffix:colon
id|printk
c_func
(paren
l_string|&quot;RC GETMAC&bslash;n&quot;
)paren
suffix:semicolon
id|RCUD_GETMAC
op_assign
op_amp
id|RCuser.RCUS_GETMAC
suffix:semicolon
id|RCGetMAC
c_func
(paren
id|pDpa-&gt;id
comma
(paren
id|PU8
)paren
op_amp
id|RCUD_GETMAC-&gt;mac
comma
l_int|NULL
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|RCUC_GETPROM
suffix:colon
id|printk
c_func
(paren
l_string|&quot;RC GETPROM&bslash;n&quot;
)paren
suffix:semicolon
id|RCUD_GETPROM
op_assign
op_amp
id|RCuser.RCUS_GETPROM
suffix:semicolon
id|RCGetPromiscuousMode
c_func
(paren
id|pDpa-&gt;id
comma
(paren
id|PU32
)paren
op_amp
id|RCUD_GETPROM-&gt;PromMode
comma
l_int|NULL
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|RCUC_GETBROADCAST
suffix:colon
id|printk
c_func
(paren
l_string|&quot;RC GETBROADCAST&bslash;n&quot;
)paren
suffix:semicolon
id|RCUD_GETBROADCAST
op_assign
op_amp
id|RCuser.RCUS_GETBROADCAST
suffix:semicolon
id|RCGetBroadcastMode
c_func
(paren
id|pDpa-&gt;id
comma
(paren
id|PU32
)paren
op_amp
id|RCUD_GETBROADCAST-&gt;BroadcastMode
comma
l_int|NULL
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|RCUC_GETSPEED
suffix:colon
id|printk
c_func
(paren
l_string|&quot;RC GETSPEED&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|dev-&gt;flags
op_amp
id|IFF_UP
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;RCioctl, GETSPEED error: interface down&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENODATA
suffix:semicolon
)brace
id|RCUD_GETSPEED
op_assign
op_amp
id|RCuser.RCUS_GETSPEED
suffix:semicolon
id|RCGetLinkSpeed
c_func
(paren
id|pDpa-&gt;id
comma
(paren
id|PU32
)paren
op_amp
id|RCUD_GETSPEED-&gt;LinkSpeedCode
comma
l_int|NULL
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;RC speed = 0x%u&bslash;n&quot;
comma
id|RCUD_GETSPEED-&gt;LinkSpeedCode
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|RCUC_SETIPANDMASK
suffix:colon
id|printk
c_func
(paren
l_string|&quot;RC SETIPANDMASK&bslash;n&quot;
)paren
suffix:semicolon
id|RCUD_SETIPANDMASK
op_assign
op_amp
id|RCuser.RCUS_SETIPANDMASK
suffix:semicolon
id|printk
(paren
l_string|&quot;RC New IP Addr = %d.%d.%d.%d, &quot;
comma
(paren
id|U8
)paren
(paren
(paren
id|RCUD_SETIPANDMASK-&gt;IpAddr
)paren
op_amp
l_int|0xff
)paren
comma
(paren
id|U8
)paren
(paren
(paren
id|RCUD_SETIPANDMASK-&gt;IpAddr
op_rshift
l_int|8
)paren
op_amp
l_int|0xff
)paren
comma
(paren
id|U8
)paren
(paren
(paren
id|RCUD_SETIPANDMASK-&gt;IpAddr
op_rshift
l_int|16
)paren
op_amp
l_int|0xff
)paren
comma
(paren
id|U8
)paren
(paren
(paren
id|RCUD_SETIPANDMASK-&gt;IpAddr
op_rshift
l_int|24
)paren
op_amp
l_int|0xff
)paren
)paren
suffix:semicolon
id|printk
(paren
l_string|&quot;RC New Mask = %d.%d.%d.%d&bslash;n&quot;
comma
(paren
id|U8
)paren
(paren
(paren
id|RCUD_SETIPANDMASK-&gt;NetMask
)paren
op_amp
l_int|0xff
)paren
comma
(paren
id|U8
)paren
(paren
(paren
id|RCUD_SETIPANDMASK-&gt;NetMask
op_rshift
l_int|8
)paren
op_amp
l_int|0xff
)paren
comma
(paren
id|U8
)paren
(paren
(paren
id|RCUD_SETIPANDMASK-&gt;NetMask
op_rshift
l_int|16
)paren
op_amp
l_int|0xff
)paren
comma
(paren
id|U8
)paren
(paren
(paren
id|RCUD_SETIPANDMASK-&gt;NetMask
op_rshift
l_int|24
)paren
op_amp
l_int|0xff
)paren
)paren
suffix:semicolon
id|RCSetRavlinIPandMask
c_func
(paren
id|pDpa-&gt;id
comma
(paren
id|U32
)paren
id|RCUD_SETIPANDMASK-&gt;IpAddr
comma
(paren
id|U32
)paren
id|RCUD_SETIPANDMASK-&gt;NetMask
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|RCUC_SETMAC
suffix:colon
id|printk
c_func
(paren
l_string|&quot;RC SETMAC&bslash;n&quot;
)paren
suffix:semicolon
id|RCUD_SETMAC
op_assign
op_amp
id|RCuser.RCUS_SETMAC
suffix:semicolon
id|printk
(paren
l_string|&quot;RC New MAC addr = %02X:%02X:%02X:%02X:%02X:%02X&bslash;n&quot;
comma
(paren
id|U8
)paren
(paren
id|RCUD_SETMAC-&gt;mac
(braket
l_int|0
)braket
)paren
comma
(paren
id|U8
)paren
(paren
id|RCUD_SETMAC-&gt;mac
(braket
l_int|1
)braket
)paren
comma
(paren
id|U8
)paren
(paren
id|RCUD_SETMAC-&gt;mac
(braket
l_int|2
)braket
)paren
comma
(paren
id|U8
)paren
(paren
id|RCUD_SETMAC-&gt;mac
(braket
l_int|3
)braket
)paren
comma
(paren
id|U8
)paren
(paren
id|RCUD_SETMAC-&gt;mac
(braket
l_int|4
)braket
)paren
comma
(paren
id|U8
)paren
(paren
id|RCUD_SETMAC-&gt;mac
(braket
l_int|5
)braket
)paren
)paren
suffix:semicolon
id|RCSetMAC
c_func
(paren
id|pDpa-&gt;id
comma
(paren
id|PU8
)paren
op_amp
id|RCUD_SETMAC-&gt;mac
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|RCUC_SETSPEED
suffix:colon
id|printk
c_func
(paren
l_string|&quot;RC SETSPEED&bslash;n&quot;
)paren
suffix:semicolon
id|RCUD_SETSPEED
op_assign
op_amp
id|RCuser.RCUS_SETSPEED
suffix:semicolon
id|RCSetLinkSpeed
c_func
(paren
id|pDpa-&gt;id
comma
(paren
id|U16
)paren
id|RCUD_SETSPEED-&gt;LinkSpeedCode
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;RC New speed = 0x%x&bslash;n&quot;
comma
id|RCUD_SETSPEED-&gt;LinkSpeedCode
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|RCUC_SETPROM
suffix:colon
id|printk
c_func
(paren
l_string|&quot;RC SETPROM&bslash;n&quot;
)paren
suffix:semicolon
id|RCUD_SETPROM
op_assign
op_amp
id|RCuser.RCUS_SETPROM
suffix:semicolon
id|RCSetPromiscuousMode
c_func
(paren
id|pDpa-&gt;id
comma
(paren
id|U16
)paren
id|RCUD_SETPROM-&gt;PromMode
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;RC New prom mode = 0x%x&bslash;n&quot;
comma
id|RCUD_SETPROM-&gt;PromMode
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|RCUC_SETBROADCAST
suffix:colon
id|printk
c_func
(paren
l_string|&quot;RC SETBROADCAST&bslash;n&quot;
)paren
suffix:semicolon
id|RCUD_SETBROADCAST
op_assign
op_amp
id|RCuser.RCUS_SETBROADCAST
suffix:semicolon
id|RCSetBroadcastMode
c_func
(paren
id|pDpa-&gt;id
comma
(paren
id|U16
)paren
id|RCUD_SETBROADCAST-&gt;BroadcastMode
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;RC New broadcast mode = 0x%x&bslash;n&quot;
comma
id|RCUD_SETBROADCAST-&gt;BroadcastMode
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|printk
c_func
(paren
l_string|&quot;RC command default&bslash;n&quot;
)paren
suffix:semicolon
id|RCUD_DEFAULT
op_assign
op_amp
id|RCuser.RCUS_DEFAULT
suffix:semicolon
id|RCUD_DEFAULT
op_member_access_from_pointer
id|rc
op_assign
l_int|0x11223344
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
id|rq-&gt;ifr_data
comma
op_amp
id|RCuser
comma
r_sizeof
(paren
id|RCuser
)paren
)paren
)paren
(brace
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
r_break
suffix:semicolon
)brace
multiline_comment|/* RCU_COMMAND */
r_default
suffix:colon
id|rq-&gt;ifr_ifru.ifru_data
op_assign
(paren
id|caddr_t
)paren
l_int|0x12345678
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|RCconfig
r_static
r_int
id|RCconfig
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_struct
id|ifmap
op_star
id|map
)paren
(brace
multiline_comment|/*&n;     * To be completed ...&n;      */
id|printk
c_func
(paren
l_string|&quot;rc: RCconfig&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;flags
op_amp
id|IFF_UP
)paren
multiline_comment|/* can&squot;t act on a running interface */
r_return
op_minus
id|EBUSY
suffix:semicolon
multiline_comment|/* Don&squot;t allow changing the I/O address */
r_if
c_cond
(paren
id|map-&gt;base_addr
op_ne
id|dev-&gt;base_addr
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;RC pci45: Change I/O address not implemented&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EOPNOTSUPP
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|rcpci_cleanup_module
r_static
r_void
id|__exit
id|rcpci_cleanup_module
(paren
r_void
)paren
(brace
id|pci_unregister_driver
c_func
(paren
op_amp
id|rcpci45_driver
)paren
suffix:semicolon
)brace
DECL|variable|rcpci_init_module
id|module_init
c_func
(paren
id|rcpci_init_module
)paren
suffix:semicolon
DECL|variable|rcpci_cleanup_module
id|module_exit
c_func
(paren
id|rcpci_cleanup_module
)paren
suffix:semicolon
r_static
r_int
DECL|function|RC_allocate_and_post_buffers
id|RC_allocate_and_post_buffers
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_int
id|numBuffers
)paren
(brace
r_int
id|i
suffix:semicolon
id|PDPA
id|pDpa
op_assign
(paren
id|PDPA
)paren
id|dev-&gt;priv
suffix:semicolon
id|PU32
id|p
suffix:semicolon
id|psingleB
id|pB
suffix:semicolon
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
id|RC_RETURN
id|status
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|numBuffers
)paren
r_return
l_int|0
suffix:semicolon
r_else
r_if
c_cond
(paren
id|numBuffers
OG
id|MAX_NMBR_POST_BUFFERS_PER_MSG
)paren
(brace
macro_line|#ifdef RCDEBUG
id|printk
c_func
(paren
l_string|&quot;rc: Too many buffers requested!&bslash;n&quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;rc: attempting to allocate only 32 buffers&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
id|numBuffers
op_assign
l_int|32
suffix:semicolon
)brace
id|p
op_assign
(paren
id|PU32
)paren
id|kmalloc
c_func
(paren
r_sizeof
(paren
id|U32
)paren
op_plus
id|numBuffers
op_star
r_sizeof
(paren
id|singleB
)paren
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
macro_line|#ifdef RCDEBUG
id|printk
c_func
(paren
l_string|&quot;rc: TCB = 0x%x&bslash;n&quot;
comma
(paren
id|uint
)paren
id|p
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
op_logical_neg
id|p
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;rc: RCopen: unable to allocate TCB&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|p
(braket
l_int|0
)braket
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Buffer Count */
id|pB
op_assign
(paren
id|psingleB
)paren
(paren
(paren
id|U32
)paren
id|p
op_plus
r_sizeof
(paren
id|U32
)paren
)paren
suffix:semicolon
multiline_comment|/* point to the first buffer */
macro_line|#ifdef RCDEBUG
id|printk
c_func
(paren
l_string|&quot;rc: p[0] = 0x%x, p = 0x%x, pB = 0x%x&bslash;n&quot;
comma
(paren
id|uint
)paren
id|p
(braket
l_int|0
)braket
comma
(paren
id|uint
)paren
id|p
comma
(paren
id|uint
)paren
id|pB
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;rc: pB = 0x%x&bslash;n&quot;
comma
(paren
id|uint
)paren
id|pB
)paren
suffix:semicolon
macro_line|#endif
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|numBuffers
suffix:semicolon
id|i
op_increment
)paren
(brace
id|skb
op_assign
id|dev_alloc_skb
c_func
(paren
id|MAX_ETHER_SIZE
op_plus
l_int|2
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|skb
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;rc: Doh! RCopen: unable to allocate enough skbs!&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
op_star
id|p
op_ne
l_int|0
)paren
multiline_comment|/* did we allocate any buffers at all? */
(brace
macro_line|#ifdef RCDEBUG
id|printk
c_func
(paren
l_string|&quot;rc: will post only %d buffers &bslash;n&quot;
comma
(paren
id|uint
)paren
(paren
op_star
id|p
)paren
)paren
suffix:semicolon
macro_line|#endif
r_break
suffix:semicolon
)brace
r_else
(brace
id|kfree
c_func
(paren
id|p
)paren
suffix:semicolon
multiline_comment|/* Free the TCB */
r_return
l_int|0
suffix:semicolon
)brace
)brace
macro_line|#ifdef RCDEBUG
id|printk
c_func
(paren
l_string|&quot;post 0x%x&bslash;n&quot;
comma
(paren
id|uint
)paren
id|skb
)paren
suffix:semicolon
macro_line|#endif
id|skb_reserve
c_func
(paren
id|skb
comma
l_int|2
)paren
suffix:semicolon
multiline_comment|/* Align IP on 16 byte boundaries */
id|pB-&gt;context
op_assign
(paren
id|U32
)paren
id|skb
suffix:semicolon
id|pB-&gt;scount
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* segment count */
id|pB-&gt;size
op_assign
id|MAX_ETHER_SIZE
suffix:semicolon
id|pB-&gt;addr
op_assign
id|virt_to_bus
c_func
(paren
(paren
r_void
op_star
)paren
id|skb-&gt;data
)paren
suffix:semicolon
id|p
(braket
l_int|0
)braket
op_increment
suffix:semicolon
id|pB
op_increment
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|status
op_assign
id|RCPostRecvBuffers
c_func
(paren
id|pDpa-&gt;id
comma
(paren
id|PRCTCB
)paren
id|p
)paren
)paren
op_ne
id|RC_RTN_NO_ERROR
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;rc: Post buffer failed with error code 0x%x!&bslash;n&quot;
comma
id|status
)paren
suffix:semicolon
id|pB
op_assign
(paren
id|psingleB
)paren
(paren
(paren
id|U32
)paren
id|p
op_plus
r_sizeof
(paren
id|U32
)paren
)paren
suffix:semicolon
multiline_comment|/* point to the first buffer */
r_while
c_loop
(paren
id|p
(braket
l_int|0
)braket
)paren
(brace
id|skb
op_assign
(paren
r_struct
id|sk_buff
op_star
)paren
id|pB-&gt;context
suffix:semicolon
macro_line|#ifdef RCDEBUG
id|printk
c_func
(paren
l_string|&quot;rc: freeing 0x%x&bslash;n&quot;
comma
(paren
id|uint
)paren
id|skb
)paren
suffix:semicolon
macro_line|#endif
id|dev_kfree_skb
(paren
id|skb
)paren
suffix:semicolon
id|p
(braket
l_int|0
)braket
op_decrement
suffix:semicolon
id|pB
op_increment
suffix:semicolon
)brace
macro_line|#ifdef RCDEBUG
id|printk
c_func
(paren
l_string|&quot;rc: freed all buffers, p[0] = %ld&bslash;n&quot;
comma
id|p
(braket
l_int|0
)braket
)paren
suffix:semicolon
macro_line|#endif
)brace
id|kfree
c_func
(paren
id|p
)paren
suffix:semicolon
r_return
id|p
(braket
l_int|0
)braket
suffix:semicolon
multiline_comment|/* return the number of posted buffers */
)brace
eof
