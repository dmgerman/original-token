multiline_comment|/*&n; * sonic.c&n; *&n; * (C) 1996 by Thomas Bogendoerfer (tsbogend@bigbug.franken.de)&n; * &n; * This driver is based on work from Andreas Busse, but most of&n; * the code is rewritten.&n; * &n; * (C) 1995 by Andreas Busse (andy@waldorf-gmbh.de)&n; *&n; * A driver for the onboard Sonic ethernet controller on Mips Jazz&n; * systems (Acer Pica-61, Mips Magnum 4000, Olivetti M700 and&n; * perhaps others, too)&n; */
DECL|variable|version
r_static
r_const
r_char
op_star
id|version
op_assign
l_string|&quot;sonic.c:v0.10 6.7.96 tsbogend@bigbug.franken.de&bslash;n&quot;
suffix:semicolon
multiline_comment|/*&n; * Sources: Olivetti M700-10 Risc Personal Computer hardware handbook,&n; * National Semiconductors data sheet for the DP83932B Sonic Ethernet&n; * controller, and the files &quot;8390.c&quot; and &quot;skeleton.c&quot; in this directory.&n; */
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/fcntl.h&gt;
macro_line|#include &lt;linux/interrupt.h&gt;
macro_line|#include &lt;linux/ptrace.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/ioport.h&gt;
macro_line|#include &lt;linux/in.h&gt;
macro_line|#include &lt;linux/malloc.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;asm/bootinfo.h&gt;
macro_line|#include &lt;asm/system.h&gt;
macro_line|#include &lt;asm/bitops.h&gt;
macro_line|#include &lt;asm/pgtable.h&gt;
macro_line|#include &lt;asm/segment.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/dma.h&gt;
macro_line|#include &lt;asm/jazz.h&gt;
macro_line|#include &lt;asm/jazzdma.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/netdevice.h&gt;
macro_line|#include &lt;linux/etherdevice.h&gt;
macro_line|#include &lt;linux/skbuff.h&gt;
macro_line|#include &quot;sonic.h&quot;
multiline_comment|/* use 0 for production, 1 for verification, &gt;2 for debug */
macro_line|#ifdef SONIC_DEBUG
DECL|variable|sonic_debug
r_static
r_int
r_int
id|sonic_debug
op_assign
id|SONIC_DEBUG
suffix:semicolon
macro_line|#else 
DECL|variable|sonic_debug
r_static
r_int
r_int
id|sonic_debug
op_assign
l_int|2
suffix:semicolon
macro_line|#endif
multiline_comment|/*&n; * Some tunables for the buffer areas. Power of 2 is required&n; * the current driver uses one receive buffer for each descriptor.&n; */
DECL|macro|SONIC_NUM_RRS
mdefine_line|#define SONIC_NUM_RRS    16             /* number of receive resources */
DECL|macro|SONIC_NUM_RDS
mdefine_line|#define SONIC_NUM_RDS    SONIC_NUM_RRS  /* number of receive descriptors */
DECL|macro|SONIC_NUM_TDS
mdefine_line|#define SONIC_NUM_TDS    16      /* number of transmit descriptors */
DECL|macro|SONIC_RBSIZE
mdefine_line|#define SONIC_RBSIZE   1520      /* size of one resource buffer */
DECL|macro|SONIC_RDS_MASK
mdefine_line|#define SONIC_RDS_MASK   (SONIC_NUM_RDS-1)
DECL|macro|SONIC_TDS_MASK
mdefine_line|#define SONIC_TDS_MASK   (SONIC_NUM_TDS-1)
multiline_comment|/*&n; * Base address and interupt of the SONIC controller on JAZZ boards&n; */
r_static
r_struct
(brace
DECL|member|port
r_int
r_int
id|port
suffix:semicolon
DECL|member|irq
r_int
r_int
id|irq
suffix:semicolon
DECL|variable|sonic_portlist
)brace
id|sonic_portlist
(braket
)braket
op_assign
(brace
(brace
id|JAZZ_ETHERNET_BASE
comma
id|JAZZ_ETHERNET_IRQ
)brace
comma
(brace
l_int|0
comma
l_int|0
)brace
)brace
suffix:semicolon
multiline_comment|/* Information that need to be kept for each board. */
DECL|struct|sonic_local
r_struct
id|sonic_local
(brace
DECL|member|cda
id|sonic_cda_t
id|cda
suffix:semicolon
multiline_comment|/* virtual CPU address of CDA */
DECL|member|tda
id|sonic_td_t
id|tda
(braket
id|SONIC_NUM_TDS
)braket
suffix:semicolon
multiline_comment|/* transmit descriptor area */
DECL|member|rra
id|sonic_rr_t
id|rra
(braket
id|SONIC_NUM_RRS
)braket
suffix:semicolon
multiline_comment|/* receive resource arrea */
DECL|member|rda
id|sonic_rd_t
id|rda
(braket
id|SONIC_NUM_RDS
)braket
suffix:semicolon
multiline_comment|/* receive descriptor area */
DECL|member|tx_skb
r_struct
id|sk_buff
op_star
id|tx_skb
(braket
id|SONIC_NUM_TDS
)braket
suffix:semicolon
multiline_comment|/* skbuffs for packets to transmit */
DECL|member|tx_laddr
r_int
r_int
id|tx_laddr
(braket
id|SONIC_NUM_TDS
)braket
suffix:semicolon
multiline_comment|/* logical DMA address fro skbuffs */
DECL|member|rba
r_int
r_char
op_star
id|rba
suffix:semicolon
multiline_comment|/* start of receive buffer areas */
DECL|member|cda_laddr
r_int
r_int
id|cda_laddr
suffix:semicolon
multiline_comment|/* logical DMA address of CDA */
DECL|member|tda_laddr
r_int
r_int
id|tda_laddr
suffix:semicolon
multiline_comment|/* logical DMA address of TDA */
DECL|member|rra_laddr
r_int
r_int
id|rra_laddr
suffix:semicolon
multiline_comment|/* logical DMA address of RRA */
DECL|member|rda_laddr
r_int
r_int
id|rda_laddr
suffix:semicolon
multiline_comment|/* logical DMA address of RDA */
DECL|member|rba_laddr
r_int
r_int
id|rba_laddr
suffix:semicolon
multiline_comment|/* logical DMA address of RBA */
DECL|member|cur_tx
DECL|member|cur_rx
r_int
r_int
id|cur_tx
comma
id|cur_rx
suffix:semicolon
multiline_comment|/* current indexes to resource areas */
DECL|member|dirty_tx
DECL|member|cur_rra
r_int
r_int
id|dirty_tx
comma
id|cur_rra
suffix:semicolon
multiline_comment|/* last unacked transmit packet */
DECL|member|tx_full
r_char
id|tx_full
suffix:semicolon
DECL|member|stats
r_struct
id|enet_statistics
id|stats
suffix:semicolon
)brace
suffix:semicolon
multiline_comment|/*&n; * We cannot use station (ethernet) address prefixes to detect the&n; * sonic controller since these are board manufacturer depended.&n; * So we check for known Silicon Revision IDs instead. &n; */
DECL|variable|known_revisions
r_static
r_int
r_int
id|known_revisions
(braket
)braket
op_assign
(brace
l_int|0x04
comma
multiline_comment|/* Mips Magnum 4000 */
l_int|0xffff
multiline_comment|/* end of list */
)brace
suffix:semicolon
multiline_comment|/* Index to functions, as function prototypes. */
r_extern
r_int
id|sonic_probe
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_int
id|sonic_probe1
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
r_int
r_int
id|base_addr
comma
r_int
r_int
id|irq
)paren
suffix:semicolon
r_static
r_int
id|sonic_open
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_int
id|sonic_send_packet
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_void
id|sonic_interrupt
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
suffix:semicolon
r_static
r_void
id|sonic_rx
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_int
id|sonic_close
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_struct
id|enet_statistics
op_star
id|sonic_get_stats
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_void
id|sonic_multicast_list
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_int
id|sonic_init
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
suffix:semicolon
multiline_comment|/*&n; * Probe for a SONIC ethernet controller on a Mips Jazz board.&n; * Actually probing is superfluous but we&squot;re paranoid.&n; */
DECL|function|__initfunc
id|__initfunc
c_func
(paren
r_int
id|sonic_probe
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
)paren
(brace
r_int
r_int
id|base_addr
op_assign
id|dev
ques
c_cond
id|dev-&gt;base_addr
suffix:colon
l_int|0
suffix:semicolon
r_int
id|i
suffix:semicolon
multiline_comment|/*&n;     * Don&squot;t probe if we&squot;re not running on a Jazz board.&n;     */
r_if
c_cond
(paren
id|mips_machgroup
op_ne
id|MACH_GROUP_JAZZ
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
r_if
c_cond
(paren
id|base_addr
OG
l_int|0x1ff
)paren
multiline_comment|/* Check a single specified location. */
r_return
id|sonic_probe1
c_func
(paren
id|dev
comma
id|base_addr
comma
id|dev-&gt;irq
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
id|base_addr
op_ne
l_int|0
)paren
multiline_comment|/* Don&squot;t probe at all. */
r_return
op_minus
id|ENXIO
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|sonic_portlist
(braket
id|i
)braket
dot
id|port
suffix:semicolon
id|i
op_increment
)paren
(brace
r_int
id|base_addr
op_assign
id|sonic_portlist
(braket
id|i
)braket
dot
id|port
suffix:semicolon
r_if
c_cond
(paren
id|check_region
c_func
(paren
id|base_addr
comma
l_int|0x100
)paren
)paren
r_continue
suffix:semicolon
r_if
c_cond
(paren
id|sonic_probe1
c_func
(paren
id|dev
comma
id|base_addr
comma
id|sonic_portlist
(braket
id|i
)braket
dot
id|irq
)paren
op_eq
l_int|0
)paren
r_return
l_int|0
suffix:semicolon
)brace
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
DECL|function|__initfunc
id|__initfunc
c_func
(paren
r_static
r_int
id|sonic_probe1
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
r_int
r_int
id|base_addr
comma
r_int
r_int
id|irq
)paren
)paren
(brace
r_static
r_int
id|version_printed
op_assign
l_int|0
suffix:semicolon
r_int
r_int
id|silicon_revision
suffix:semicolon
r_int
r_int
id|val
suffix:semicolon
r_struct
id|sonic_local
op_star
id|lp
suffix:semicolon
r_int
id|i
suffix:semicolon
multiline_comment|/*&n;     * get the Silicon Revision ID. If this is one of the known&n;     * one assume that we found a SONIC ethernet controller at&n;     * the expected location.&n;     */
id|silicon_revision
op_assign
id|SONIC_READ
c_func
(paren
id|SONIC_SR
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sonic_debug
OG
l_int|1
)paren
id|printk
c_func
(paren
l_string|&quot;SONIC Silicon Revision = 0x%04x&bslash;n&quot;
comma
id|silicon_revision
)paren
suffix:semicolon
id|i
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
(paren
id|known_revisions
(braket
id|i
)braket
op_ne
l_int|0xffff
)paren
op_logical_and
(paren
id|known_revisions
(braket
id|i
)braket
op_ne
id|silicon_revision
)paren
)paren
id|i
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|known_revisions
(braket
id|i
)braket
op_eq
l_int|0xffff
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;SONIC ethernet controller not found (0x%4x)&bslash;n&quot;
comma
id|silicon_revision
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
id|request_region
c_func
(paren
id|base_addr
comma
l_int|0x100
comma
l_string|&quot;SONIC&quot;
)paren
suffix:semicolon
multiline_comment|/* Allocate a new &squot;dev&squot; if needed. */
r_if
c_cond
(paren
id|dev
op_eq
l_int|NULL
)paren
id|dev
op_assign
id|init_etherdev
c_func
(paren
l_int|0
comma
r_sizeof
(paren
r_struct
id|sonic_local
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sonic_debug
op_logical_and
id|version_printed
op_increment
op_eq
l_int|0
)paren
id|printk
c_func
(paren
id|version
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;%s: %s found at 0x%08x, &quot;
comma
id|dev-&gt;name
comma
l_string|&quot;SONIC ethernet&quot;
comma
id|base_addr
)paren
suffix:semicolon
multiline_comment|/* Fill in the &squot;dev&squot; fields. */
id|dev-&gt;base_addr
op_assign
id|base_addr
suffix:semicolon
id|dev-&gt;irq
op_assign
id|irq
suffix:semicolon
multiline_comment|/*&n;     * Put the sonic into software reset, then&n;     * retrieve and print the ethernet address.&n;     */
id|SONIC_WRITE
c_func
(paren
id|SONIC_CMD
comma
id|SONIC_CR_RST
)paren
suffix:semicolon
id|SONIC_WRITE
c_func
(paren
id|SONIC_CEP
comma
l_int|0
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|3
suffix:semicolon
id|i
op_increment
)paren
(brace
id|val
op_assign
id|SONIC_READ
c_func
(paren
id|SONIC_CAP0
op_minus
id|i
)paren
suffix:semicolon
id|dev-&gt;dev_addr
(braket
id|i
op_star
l_int|2
)braket
op_assign
id|val
suffix:semicolon
id|dev-&gt;dev_addr
(braket
id|i
op_star
l_int|2
op_plus
l_int|1
)braket
op_assign
id|val
op_rshift
l_int|8
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;HW Address &quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|6
suffix:semicolon
id|i
op_increment
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%2.2x&quot;
comma
id|dev-&gt;dev_addr
(braket
id|i
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
OL
l_int|5
)paren
id|printk
c_func
(paren
l_string|&quot;:&quot;
)paren
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot; IRQ %d&bslash;n&quot;
comma
id|irq
)paren
suffix:semicolon
multiline_comment|/* Initialize the device structure. */
r_if
c_cond
(paren
id|dev-&gt;priv
op_eq
l_int|NULL
)paren
(brace
multiline_comment|/*&n;&t; * the memory be located in the same 64kb segment&n;&t; */
id|lp
op_assign
l_int|NULL
suffix:semicolon
id|i
op_assign
l_int|0
suffix:semicolon
r_do
(brace
id|lp
op_assign
(paren
r_struct
id|sonic_local
op_star
)paren
id|kmalloc
c_func
(paren
r_sizeof
(paren
op_star
id|lp
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
r_int
r_int
)paren
id|lp
op_rshift
l_int|16
op_ne
(paren
(paren
r_int
r_int
)paren
id|lp
op_plus
r_sizeof
(paren
op_star
id|lp
)paren
)paren
op_rshift
l_int|16
)paren
(brace
multiline_comment|/* FIXME, free the memory later */
id|kfree
(paren
id|lp
)paren
suffix:semicolon
id|lp
op_assign
l_int|NULL
suffix:semicolon
)brace
)brace
r_while
c_loop
(paren
id|lp
op_eq
l_int|NULL
op_logical_and
id|i
op_increment
OL
l_int|20
)paren
suffix:semicolon
r_if
c_cond
(paren
id|lp
op_eq
l_int|NULL
)paren
(brace
id|printk
(paren
l_string|&quot;%s: couldn&squot;t allocate memory for descriptors&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|memset
c_func
(paren
id|lp
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|sonic_local
)paren
)paren
suffix:semicolon
multiline_comment|/* get the virtual dma address */
id|lp-&gt;cda_laddr
op_assign
id|vdma_alloc
c_func
(paren
id|PHYSADDR
c_func
(paren
id|lp
)paren
comma
r_sizeof
(paren
op_star
id|lp
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|lp-&gt;cda_laddr
op_eq
op_complement
l_int|0UL
)paren
(brace
id|printk
(paren
l_string|&quot;%s: couldn&squot;t get DMA page entry for descriptors&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|lp-&gt;tda_laddr
op_assign
id|lp-&gt;cda_laddr
op_plus
r_sizeof
(paren
id|lp-&gt;cda
)paren
suffix:semicolon
id|lp-&gt;rra_laddr
op_assign
id|lp-&gt;tda_laddr
op_plus
r_sizeof
(paren
id|lp-&gt;tda
)paren
suffix:semicolon
id|lp-&gt;rda_laddr
op_assign
id|lp-&gt;rra_laddr
op_plus
r_sizeof
(paren
id|lp-&gt;rra
)paren
suffix:semicolon
multiline_comment|/* allocate receive buffer area */
multiline_comment|/* FIXME, maybe we should use skbs */
r_if
c_cond
(paren
(paren
id|lp-&gt;rba
op_assign
(paren
r_char
op_star
)paren
id|kmalloc
c_func
(paren
id|SONIC_NUM_RRS
op_star
id|SONIC_RBSIZE
comma
id|GFP_KERNEL
)paren
)paren
op_eq
l_int|NULL
)paren
(brace
id|printk
(paren
l_string|&quot;%s: couldn&squot;t allocate receive buffers&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
multiline_comment|/* get virtual dma address */
r_if
c_cond
(paren
(paren
id|lp-&gt;rba_laddr
op_assign
id|vdma_alloc
c_func
(paren
id|PHYSADDR
c_func
(paren
id|lp-&gt;rba
)paren
comma
id|SONIC_NUM_RRS
op_star
id|SONIC_RBSIZE
)paren
)paren
op_eq
op_complement
l_int|0UL
)paren
(brace
id|printk
(paren
l_string|&quot;%s: couldn&squot;t get DMA page entry for receive buffers&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
multiline_comment|/* now convert pointer to KSEG1 pointer */
id|lp-&gt;rba
op_assign
(paren
r_char
op_star
)paren
id|KSEG1ADDR
c_func
(paren
id|lp-&gt;rba
)paren
suffix:semicolon
id|flush_cache_all
c_func
(paren
)paren
suffix:semicolon
id|dev-&gt;priv
op_assign
(paren
r_struct
id|sonic_local
op_star
)paren
id|KSEG1ADDR
c_func
(paren
id|lp
)paren
suffix:semicolon
)brace
id|lp
op_assign
(paren
r_struct
id|sonic_local
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|dev-&gt;open
op_assign
id|sonic_open
suffix:semicolon
id|dev-&gt;stop
op_assign
id|sonic_close
suffix:semicolon
id|dev-&gt;hard_start_xmit
op_assign
id|sonic_send_packet
suffix:semicolon
id|dev-&gt;get_stats
op_assign
id|sonic_get_stats
suffix:semicolon
id|dev-&gt;set_multicast_list
op_assign
op_amp
id|sonic_multicast_list
suffix:semicolon
multiline_comment|/* Fill in the fields of the device structure with ethernet values. */
id|ether_setup
c_func
(paren
id|dev
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * Open/initialize the SONIC controller.&n; *&n; * This routine should set everything up anew at each open, even&n; *  registers that &quot;should&quot; only need to be set once at boot, so that&n; *  there is non-reboot way to recover if something goes wrong.&n; */
DECL|function|sonic_open
r_static
r_int
id|sonic_open
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
r_if
c_cond
(paren
id|sonic_debug
OG
l_int|2
)paren
id|printk
c_func
(paren
l_string|&quot;sonic_open: initializing sonic driver.&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/*&n;     * We don&squot;t need to deal with auto-irq stuff since we&n;     * hardwire the sonic interrupt.&n;     */
multiline_comment|/*&n; * XXX Horrible work around:  We install sonic_interrupt as fast interrupt.&n; * This means that during execution of the handler interrupt are disabled&n; * covering another bug otherwise corrupting data.  This doesn&squot;t mean&n; * this glue works ok under all situations.&n; */
singleline_comment|//    if (request_irq(dev-&gt;irq, &amp;sonic_interrupt, 0, &quot;sonic&quot;, dev)) {
r_if
c_cond
(paren
id|request_irq
c_func
(paren
id|dev-&gt;irq
comma
op_amp
id|sonic_interrupt
comma
id|SA_INTERRUPT
comma
l_string|&quot;sonic&quot;
comma
id|dev
)paren
)paren
(brace
id|printk
(paren
l_string|&quot;&bslash;n%s: unable to get IRQ %d .&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|dev-&gt;irq
)paren
suffix:semicolon
r_return
id|EAGAIN
suffix:semicolon
)brace
multiline_comment|/*&n;     * Initialize the SONIC&n;     */
id|sonic_init
c_func
(paren
id|dev
)paren
suffix:semicolon
id|dev-&gt;tbusy
op_assign
l_int|0
suffix:semicolon
id|dev-&gt;interrupt
op_assign
l_int|0
suffix:semicolon
id|dev-&gt;start
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|sonic_debug
OG
l_int|2
)paren
id|printk
c_func
(paren
l_string|&quot;sonic_open: Initialization done.&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * Close the SONIC device&n; */
r_static
r_int
DECL|function|sonic_close
id|sonic_close
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
r_int
r_int
id|base_addr
op_assign
id|dev-&gt;base_addr
suffix:semicolon
r_if
c_cond
(paren
id|sonic_debug
OG
l_int|2
)paren
id|printk
(paren
l_string|&quot;sonic_close&bslash;n&quot;
)paren
suffix:semicolon
id|dev-&gt;tbusy
op_assign
l_int|1
suffix:semicolon
id|dev-&gt;start
op_assign
l_int|0
suffix:semicolon
multiline_comment|/*&n;     * stop the SONIC, disable interrupts&n;     */
id|SONIC_WRITE
c_func
(paren
id|SONIC_ISR
comma
l_int|0x7fff
)paren
suffix:semicolon
id|SONIC_WRITE
c_func
(paren
id|SONIC_IMR
comma
l_int|0
)paren
suffix:semicolon
id|SONIC_WRITE
c_func
(paren
id|SONIC_CMD
comma
id|SONIC_CR_RST
)paren
suffix:semicolon
id|free_irq
c_func
(paren
id|dev-&gt;irq
comma
id|dev
)paren
suffix:semicolon
multiline_comment|/* release the IRQ */
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * transmit packet&n; */
DECL|function|sonic_send_packet
r_static
r_int
id|sonic_send_packet
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|device
op_star
id|dev
)paren
(brace
r_struct
id|sonic_local
op_star
id|lp
op_assign
(paren
r_struct
id|sonic_local
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_int
r_int
id|base_addr
op_assign
id|dev-&gt;base_addr
suffix:semicolon
r_int
r_int
id|laddr
suffix:semicolon
r_int
id|entry
comma
id|length
suffix:semicolon
r_if
c_cond
(paren
id|sonic_debug
OG
l_int|2
)paren
id|printk
c_func
(paren
l_string|&quot;sonic_send_packet: skb=%p, dev=%p&bslash;n&quot;
comma
id|skb
comma
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;tbusy
)paren
(brace
r_int
id|tickssofar
op_assign
id|jiffies
op_minus
id|dev-&gt;trans_start
suffix:semicolon
multiline_comment|/* If we get here, some higher level has decided we are broken.&n;&t; There should really be a &quot;kick me&quot; function call instead. */
r_if
c_cond
(paren
id|sonic_debug
OG
l_int|1
)paren
id|printk
c_func
(paren
l_string|&quot;sonic_send_packet: called with dev-&gt;tbusy = 1 !&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tickssofar
OL
l_int|5
)paren
r_return
l_int|1
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;%s: transmit timed out.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
multiline_comment|/* Try to restart the adaptor. */
id|sonic_init
c_func
(paren
id|dev
)paren
suffix:semicolon
id|dev-&gt;tbusy
op_assign
l_int|0
suffix:semicolon
id|dev-&gt;trans_start
op_assign
id|jiffies
suffix:semicolon
)brace
multiline_comment|/* &n;     * Block a timer-based transmit from overlapping.  This could better be&n;     * done with atomic_swap(1, dev-&gt;tbusy), but set_bit() works as well.&n;     */
r_if
c_cond
(paren
id|test_and_set_bit
c_func
(paren
l_int|0
comma
(paren
r_void
op_star
)paren
op_amp
id|dev-&gt;tbusy
)paren
op_ne
l_int|0
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%s: Transmitter access conflict.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
multiline_comment|/*&n;     * Map the packet data into the logical DMA address space&n;     */
r_if
c_cond
(paren
(paren
id|laddr
op_assign
id|vdma_alloc
c_func
(paren
id|PHYSADDR
c_func
(paren
id|skb-&gt;data
)paren
comma
id|skb-&gt;len
)paren
)paren
op_eq
op_complement
l_int|0UL
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%s: no VDMA entry for transmit available.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|dev_kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
id|dev-&gt;tbusy
op_assign
l_int|0
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
id|entry
op_assign
id|lp-&gt;cur_tx
op_amp
id|SONIC_TDS_MASK
suffix:semicolon
id|lp-&gt;tx_laddr
(braket
id|entry
)braket
op_assign
id|laddr
suffix:semicolon
id|lp-&gt;tx_skb
(braket
id|entry
)braket
op_assign
id|skb
suffix:semicolon
id|length
op_assign
(paren
id|skb-&gt;len
OL
id|ETH_ZLEN
)paren
ques
c_cond
id|ETH_ZLEN
suffix:colon
id|skb-&gt;len
suffix:semicolon
id|flush_cache_all
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/*&n;     * Setup the transmit descriptor and issue the transmit command.&n;     */
id|lp-&gt;tda
(braket
id|entry
)braket
dot
id|tx_status
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* clear status */
id|lp-&gt;tda
(braket
id|entry
)braket
dot
id|tx_frag_count
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* single fragment */
id|lp-&gt;tda
(braket
id|entry
)braket
dot
id|tx_pktsize
op_assign
id|length
suffix:semicolon
multiline_comment|/* length of packet */
id|lp-&gt;tda
(braket
id|entry
)braket
dot
id|tx_frag_ptr_l
op_assign
id|laddr
op_amp
l_int|0xffff
suffix:semicolon
id|lp-&gt;tda
(braket
id|entry
)braket
dot
id|tx_frag_ptr_h
op_assign
id|laddr
op_rshift
l_int|16
suffix:semicolon
id|lp-&gt;tda
(braket
id|entry
)braket
dot
id|tx_frag_size
op_assign
id|length
suffix:semicolon
multiline_comment|/* if there are already packets queued, allow sending serveral packets at once */
r_if
c_cond
(paren
id|lp-&gt;dirty_tx
op_ne
id|lp-&gt;cur_tx
)paren
id|lp-&gt;tda
(braket
(paren
id|lp-&gt;cur_tx
op_minus
l_int|1
)paren
op_mod
id|SONIC_TDS_MASK
)braket
dot
id|link
op_and_assign
op_complement
id|SONIC_END_OF_LINKS
suffix:semicolon
id|lp-&gt;cur_tx
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|sonic_debug
OG
l_int|2
)paren
id|printk
c_func
(paren
l_string|&quot;sonic_send_packet: issueing Tx command&bslash;n&quot;
)paren
suffix:semicolon
id|SONIC_WRITE
c_func
(paren
id|SONIC_CMD
comma
id|SONIC_CR_TXP
)paren
suffix:semicolon
id|dev-&gt;trans_start
op_assign
id|jiffies
suffix:semicolon
r_if
c_cond
(paren
id|lp-&gt;cur_tx
OL
id|lp-&gt;dirty_tx
op_plus
id|SONIC_NUM_TDS
)paren
id|dev-&gt;tbusy
op_assign
l_int|0
suffix:semicolon
r_else
id|lp-&gt;tx_full
op_assign
l_int|1
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
"&f;"
multiline_comment|/*&n; * The typical workload of the driver:&n; * Handle the network interface interrupts.&n; */
r_static
r_void
DECL|function|sonic_interrupt
id|sonic_interrupt
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_struct
id|device
op_star
id|dev
op_assign
(paren
r_struct
id|device
op_star
)paren
id|dev_id
suffix:semicolon
r_int
r_int
id|base_addr
op_assign
id|dev-&gt;base_addr
suffix:semicolon
r_struct
id|sonic_local
op_star
id|lp
suffix:semicolon
r_int
id|status
suffix:semicolon
r_if
c_cond
(paren
id|dev
op_eq
l_int|NULL
)paren
(brace
id|printk
(paren
l_string|&quot;sonic_interrupt: irq %d for unknown device.&bslash;n&quot;
comma
id|irq
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|dev-&gt;interrupt
op_assign
l_int|1
suffix:semicolon
id|lp
op_assign
(paren
r_struct
id|sonic_local
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|status
op_assign
id|SONIC_READ
c_func
(paren
id|SONIC_ISR
)paren
suffix:semicolon
id|SONIC_WRITE
c_func
(paren
id|SONIC_ISR
comma
l_int|0x7fff
)paren
suffix:semicolon
multiline_comment|/* clear all bits */
r_if
c_cond
(paren
id|sonic_debug
OG
l_int|2
)paren
id|printk
c_func
(paren
l_string|&quot;sonic_interrupt: ISR=%x&bslash;n&quot;
comma
id|status
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
id|SONIC_INT_PKTRX
)paren
(brace
id|sonic_rx
c_func
(paren
id|dev
)paren
suffix:semicolon
multiline_comment|/* got packet(s) */
)brace
r_if
c_cond
(paren
id|status
op_amp
id|SONIC_INT_TXDN
)paren
(brace
r_int
id|dirty_tx
op_assign
id|lp-&gt;dirty_tx
suffix:semicolon
r_while
c_loop
(paren
id|dirty_tx
OL
id|lp-&gt;cur_tx
)paren
(brace
r_int
id|entry
op_assign
id|dirty_tx
op_amp
id|SONIC_TDS_MASK
suffix:semicolon
r_int
id|status
op_assign
id|lp-&gt;tda
(braket
id|entry
)braket
dot
id|tx_status
suffix:semicolon
r_if
c_cond
(paren
id|sonic_debug
OG
l_int|3
)paren
id|printk
(paren
l_string|&quot;sonic_interrupt: status %d, cur_tx %d, dirty_tx %d&bslash;n&quot;
comma
id|status
comma
id|lp-&gt;cur_tx
comma
id|lp-&gt;dirty_tx
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
op_eq
l_int|0
)paren
r_break
suffix:semicolon
multiline_comment|/* It still hasn&squot;t been Txed */
multiline_comment|/* put back EOL and free descriptor */
id|lp-&gt;tda
(braket
id|entry
)braket
dot
id|link
op_or_assign
id|SONIC_END_OF_LINKS
suffix:semicolon
id|lp-&gt;tda
(braket
id|entry
)braket
dot
id|tx_status
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
l_int|0x0001
)paren
id|lp-&gt;stats.tx_packets
op_increment
suffix:semicolon
r_else
(brace
id|lp-&gt;stats.tx_errors
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
l_int|0x0642
)paren
id|lp-&gt;stats.tx_aborted_errors
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
l_int|0x0180
)paren
id|lp-&gt;stats.tx_carrier_errors
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
l_int|0x0020
)paren
id|lp-&gt;stats.tx_window_errors
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
l_int|0x0004
)paren
id|lp-&gt;stats.tx_fifo_errors
op_increment
suffix:semicolon
)brace
multiline_comment|/* We must free the original skb */
r_if
c_cond
(paren
id|lp-&gt;tx_skb
(braket
id|entry
)braket
)paren
(brace
id|dev_kfree_skb
c_func
(paren
id|lp-&gt;tx_skb
(braket
id|entry
)braket
)paren
suffix:semicolon
id|lp-&gt;tx_skb
(braket
id|entry
)braket
op_assign
l_int|0
suffix:semicolon
)brace
multiline_comment|/* and the VDMA address */
id|vdma_free
c_func
(paren
id|lp-&gt;tx_laddr
(braket
id|entry
)braket
)paren
suffix:semicolon
id|dirty_tx
op_increment
suffix:semicolon
)brace
r_if
c_cond
(paren
id|lp-&gt;tx_full
op_logical_and
id|dev-&gt;tbusy
op_logical_and
id|dirty_tx
op_plus
id|SONIC_NUM_TDS
OG
id|lp-&gt;cur_tx
op_plus
l_int|2
)paren
(brace
multiline_comment|/* The ring is no longer full, clear tbusy. */
id|lp-&gt;tx_full
op_assign
l_int|0
suffix:semicolon
id|dev-&gt;tbusy
op_assign
l_int|0
suffix:semicolon
id|mark_bh
c_func
(paren
id|NET_BH
)paren
suffix:semicolon
)brace
id|lp-&gt;dirty_tx
op_assign
id|dirty_tx
suffix:semicolon
)brace
multiline_comment|/*&n;     * check error conditions&n;     */
r_if
c_cond
(paren
id|status
op_amp
id|SONIC_INT_RFO
)paren
(brace
id|printk
(paren
l_string|&quot;%s: receive fifo underrun&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|lp-&gt;stats.rx_fifo_errors
op_increment
suffix:semicolon
)brace
r_if
c_cond
(paren
id|status
op_amp
id|SONIC_INT_RDE
)paren
(brace
id|printk
(paren
l_string|&quot;%s: receive descriptors exhausted&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|lp-&gt;stats.rx_dropped
op_increment
suffix:semicolon
)brace
r_if
c_cond
(paren
id|status
op_amp
id|SONIC_INT_RBE
)paren
(brace
id|printk
(paren
l_string|&quot;%s: receive buffer exhausted&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|lp-&gt;stats.rx_dropped
op_increment
suffix:semicolon
)brace
r_if
c_cond
(paren
id|status
op_amp
id|SONIC_INT_RBAE
)paren
(brace
id|printk
(paren
l_string|&quot;%s: receive buffer area exhausted&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|lp-&gt;stats.rx_dropped
op_increment
suffix:semicolon
)brace
multiline_comment|/* counter overruns; all counters are 16bit wide */
r_if
c_cond
(paren
id|status
op_amp
id|SONIC_INT_FAE
)paren
id|lp-&gt;stats.rx_frame_errors
op_add_assign
l_int|65536
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
id|SONIC_INT_CRC
)paren
id|lp-&gt;stats.rx_crc_errors
op_add_assign
l_int|65536
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
id|SONIC_INT_MP
)paren
id|lp-&gt;stats.rx_missed_errors
op_add_assign
l_int|65536
suffix:semicolon
multiline_comment|/* transmit error */
r_if
c_cond
(paren
id|status
op_amp
id|SONIC_INT_TXER
)paren
id|lp-&gt;stats.tx_errors
op_increment
suffix:semicolon
multiline_comment|/*&n;     * clear interrupt bits and return&n;     */
id|SONIC_WRITE
c_func
(paren
id|SONIC_ISR
comma
id|status
)paren
suffix:semicolon
id|dev-&gt;interrupt
op_assign
l_int|0
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/*&n; * We have a good packet(s), get it/them out of the buffers.&n; */
r_static
r_void
DECL|function|sonic_rx
id|sonic_rx
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
r_int
r_int
id|base_addr
op_assign
id|dev-&gt;base_addr
suffix:semicolon
r_struct
id|sonic_local
op_star
id|lp
op_assign
(paren
r_struct
id|sonic_local
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_int
id|entry
op_assign
id|lp-&gt;cur_rx
op_amp
id|SONIC_RDS_MASK
suffix:semicolon
r_int
id|status
suffix:semicolon
r_while
c_loop
(paren
id|lp-&gt;rda
(braket
id|entry
)braket
dot
id|in_use
op_eq
l_int|0
)paren
(brace
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
r_int
id|pkt_len
suffix:semicolon
r_int
r_char
op_star
id|pkt_ptr
suffix:semicolon
id|status
op_assign
id|lp-&gt;rda
(braket
id|entry
)braket
dot
id|rx_status
suffix:semicolon
r_if
c_cond
(paren
id|sonic_debug
OG
l_int|3
)paren
id|printk
(paren
l_string|&quot;status %x, cur_rx %d, cur_rra %d&bslash;n&quot;
comma
id|status
comma
id|lp-&gt;cur_rx
comma
id|lp-&gt;cur_rra
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
id|SONIC_RCR_PRX
)paren
(brace
id|pkt_len
op_assign
id|lp-&gt;rda
(braket
id|entry
)braket
dot
id|rx_pktlen
suffix:semicolon
id|pkt_ptr
op_assign
(paren
r_char
op_star
)paren
id|KSEG1ADDR
c_func
(paren
id|vdma_log2phys
c_func
(paren
(paren
id|lp-&gt;rda
(braket
id|entry
)braket
dot
id|rx_pktptr_h
op_lshift
l_int|16
)paren
op_plus
id|lp-&gt;rda
(braket
id|entry
)braket
dot
id|rx_pktptr_l
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sonic_debug
OG
l_int|3
)paren
id|printk
(paren
l_string|&quot;pktptr %p (rba %p) h:%x l:%x, rra h:%x l:%x bsize h:%x l:%x&bslash;n&quot;
comma
id|pkt_ptr
comma
id|lp-&gt;rba
comma
id|lp-&gt;rda
(braket
id|entry
)braket
dot
id|rx_pktptr_h
comma
id|lp-&gt;rda
(braket
id|entry
)braket
dot
id|rx_pktptr_l
comma
id|lp-&gt;rra
(braket
id|lp-&gt;cur_rra
op_amp
l_int|15
)braket
dot
id|rx_bufadr_h
comma
id|lp-&gt;rra
(braket
id|lp-&gt;cur_rra
op_amp
l_int|15
)braket
dot
id|rx_bufadr_l
comma
id|SONIC_READ
c_func
(paren
id|SONIC_RBWC1
)paren
comma
id|SONIC_READ
c_func
(paren
id|SONIC_RBWC0
)paren
)paren
suffix:semicolon
multiline_comment|/* Malloc up new buffer. */
id|skb
op_assign
id|dev_alloc_skb
c_func
(paren
id|pkt_len
op_plus
l_int|2
)paren
suffix:semicolon
r_if
c_cond
(paren
id|skb
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%s: Memory squeeze, dropping packet.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|lp-&gt;stats.rx_dropped
op_increment
suffix:semicolon
r_break
suffix:semicolon
)brace
id|skb-&gt;dev
op_assign
id|dev
suffix:semicolon
id|skb_reserve
c_func
(paren
id|skb
comma
l_int|2
)paren
suffix:semicolon
multiline_comment|/* 16 byte align */
id|skb_put
c_func
(paren
id|skb
comma
id|pkt_len
)paren
suffix:semicolon
multiline_comment|/* Make room */
id|eth_copy_and_sum
c_func
(paren
id|skb
comma
id|pkt_ptr
comma
id|pkt_len
comma
l_int|0
)paren
suffix:semicolon
id|skb-&gt;protocol
op_assign
id|eth_type_trans
c_func
(paren
id|skb
comma
id|dev
)paren
suffix:semicolon
id|netif_rx
c_func
(paren
id|skb
)paren
suffix:semicolon
multiline_comment|/* pass the packet to upper layers */
id|lp-&gt;stats.rx_packets
op_increment
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* This should only happen, if we enable accepting broken packets. */
id|lp-&gt;stats.rx_errors
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
id|SONIC_RCR_FAER
)paren
id|lp-&gt;stats.rx_frame_errors
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
id|SONIC_RCR_CRCR
)paren
id|lp-&gt;stats.rx_crc_errors
op_increment
suffix:semicolon
)brace
id|lp-&gt;rda
(braket
id|entry
)braket
dot
id|in_use
op_assign
l_int|1
suffix:semicolon
id|entry
op_assign
(paren
op_increment
id|lp-&gt;cur_rx
)paren
op_amp
id|SONIC_RDS_MASK
suffix:semicolon
multiline_comment|/* now give back the buffer to the receive buffer area */
r_if
c_cond
(paren
id|status
op_amp
id|SONIC_RCR_LPKT
)paren
(brace
multiline_comment|/*&n;&t;     * this was the last packet out of the current receice buffer&n;&t;     * give the buffer back to the SONIC&n;&t;     */
id|SONIC_WRITE
c_func
(paren
id|SONIC_RWP
comma
(paren
id|lp-&gt;rra_laddr
op_plus
(paren
op_increment
id|lp-&gt;cur_rra
op_amp
l_int|15
)paren
op_star
r_sizeof
(paren
id|sonic_rr_t
)paren
)paren
op_amp
l_int|0xffff
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* If any worth-while packets have been received, dev_rint()&n;     has done a mark_bh(NET_BH) for us and will work on them&n;     when we get to the bottom-half routine. */
r_return
suffix:semicolon
)brace
multiline_comment|/*&n; * Get the current statistics.&n; * This may be called with the device open or closed.&n; */
r_static
r_struct
id|enet_statistics
op_star
DECL|function|sonic_get_stats
id|sonic_get_stats
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
r_struct
id|sonic_local
op_star
id|lp
op_assign
(paren
r_struct
id|sonic_local
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_int
r_int
id|base_addr
op_assign
id|dev-&gt;base_addr
suffix:semicolon
multiline_comment|/* read the tally counter from the SONIC and reset them */
id|lp-&gt;stats.rx_crc_errors
op_add_assign
id|SONIC_READ
c_func
(paren
id|SONIC_CRCT
)paren
suffix:semicolon
id|SONIC_WRITE
c_func
(paren
id|SONIC_CRCT
comma
l_int|0xffff
)paren
suffix:semicolon
id|lp-&gt;stats.rx_frame_errors
op_add_assign
id|SONIC_READ
c_func
(paren
id|SONIC_FAET
)paren
suffix:semicolon
id|SONIC_WRITE
c_func
(paren
id|SONIC_FAET
comma
l_int|0xffff
)paren
suffix:semicolon
id|lp-&gt;stats.rx_missed_errors
op_add_assign
id|SONIC_READ
c_func
(paren
id|SONIC_MPT
)paren
suffix:semicolon
id|SONIC_WRITE
c_func
(paren
id|SONIC_MPT
comma
l_int|0xffff
)paren
suffix:semicolon
r_return
op_amp
id|lp-&gt;stats
suffix:semicolon
)brace
multiline_comment|/*&n; * Set or clear the multicast filter for this adaptor.&n; */
r_static
r_void
DECL|function|sonic_multicast_list
id|sonic_multicast_list
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
r_struct
id|sonic_local
op_star
id|lp
op_assign
(paren
r_struct
id|sonic_local
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_int
r_int
id|base_addr
op_assign
id|dev-&gt;base_addr
suffix:semicolon
r_int
r_int
id|rcr
suffix:semicolon
r_struct
id|dev_mc_list
op_star
id|dmi
op_assign
id|dev-&gt;mc_list
suffix:semicolon
r_int
r_char
op_star
id|addr
suffix:semicolon
r_int
id|i
suffix:semicolon
id|rcr
op_assign
id|SONIC_READ
c_func
(paren
id|SONIC_RCR
)paren
op_amp
op_complement
(paren
id|SONIC_RCR_PRO
op_or
id|SONIC_RCR_AMC
)paren
suffix:semicolon
id|rcr
op_or_assign
id|SONIC_RCR_BRD
suffix:semicolon
multiline_comment|/* accept broadcast packets */
r_if
c_cond
(paren
id|dev-&gt;flags
op_amp
id|IFF_PROMISC
)paren
(brace
multiline_comment|/* set promiscuous mode */
id|rcr
op_or_assign
id|SONIC_RCR_PRO
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
(paren
id|dev-&gt;flags
op_amp
id|IFF_ALLMULTI
)paren
op_logical_or
(paren
id|dev-&gt;mc_count
OG
l_int|15
)paren
)paren
(brace
id|rcr
op_or_assign
id|SONIC_RCR_AMC
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|sonic_debug
OG
l_int|2
)paren
id|printk
(paren
l_string|&quot;sonic_multicast_list: mc_count %d&bslash;n&quot;
comma
id|dev-&gt;mc_count
)paren
suffix:semicolon
id|lp-&gt;cda.cam_enable
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* always enable our own address */
r_for
c_loop
(paren
id|i
op_assign
l_int|1
suffix:semicolon
id|i
op_le
id|dev-&gt;mc_count
suffix:semicolon
id|i
op_increment
)paren
(brace
id|addr
op_assign
id|dmi-&gt;dmi_addr
suffix:semicolon
id|dmi
op_assign
id|dmi-&gt;next
suffix:semicolon
id|lp-&gt;cda.cam_desc
(braket
id|i
)braket
dot
id|cam_frag2
op_assign
id|addr
(braket
l_int|1
)braket
op_lshift
l_int|8
op_or
id|addr
(braket
l_int|0
)braket
suffix:semicolon
id|lp-&gt;cda.cam_desc
(braket
id|i
)braket
dot
id|cam_frag1
op_assign
id|addr
(braket
l_int|3
)braket
op_lshift
l_int|8
op_or
id|addr
(braket
l_int|2
)braket
suffix:semicolon
id|lp-&gt;cda.cam_desc
(braket
id|i
)braket
dot
id|cam_frag0
op_assign
id|addr
(braket
l_int|5
)braket
op_lshift
l_int|8
op_or
id|addr
(braket
l_int|4
)braket
suffix:semicolon
id|lp-&gt;cda.cam_enable
op_or_assign
(paren
l_int|1
op_lshift
id|i
)paren
suffix:semicolon
)brace
multiline_comment|/* number of CAM entries to load */
id|SONIC_WRITE
c_func
(paren
id|SONIC_CDC
comma
id|dev-&gt;mc_count
op_plus
l_int|1
)paren
suffix:semicolon
multiline_comment|/* issue Load CAM command */
id|SONIC_WRITE
c_func
(paren
id|SONIC_CDP
comma
id|lp-&gt;cda_laddr
op_amp
l_int|0xffff
)paren
suffix:semicolon
id|SONIC_WRITE
c_func
(paren
id|SONIC_CMD
comma
id|SONIC_CR_LCAM
)paren
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|sonic_debug
OG
l_int|2
)paren
id|printk
c_func
(paren
l_string|&quot;sonic_multicast_list: setting RCR=%x&bslash;n&quot;
comma
id|rcr
)paren
suffix:semicolon
id|SONIC_WRITE
c_func
(paren
id|SONIC_RCR
comma
id|rcr
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Initialize the SONIC ethernet controller.&n; */
DECL|function|sonic_init
r_static
r_int
id|sonic_init
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
r_int
r_int
id|base_addr
op_assign
id|dev-&gt;base_addr
suffix:semicolon
r_int
r_int
id|cmd
suffix:semicolon
r_struct
id|sonic_local
op_star
id|lp
op_assign
(paren
r_struct
id|sonic_local
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_int
r_int
id|rra_start
suffix:semicolon
r_int
r_int
id|rra_end
suffix:semicolon
r_int
id|i
suffix:semicolon
multiline_comment|/*&n;     * put the Sonic into software-reset mode and&n;     * disable all interrupts&n;     */
id|SONIC_WRITE
c_func
(paren
id|SONIC_ISR
comma
l_int|0x7fff
)paren
suffix:semicolon
id|SONIC_WRITE
c_func
(paren
id|SONIC_IMR
comma
l_int|0
)paren
suffix:semicolon
id|SONIC_WRITE
c_func
(paren
id|SONIC_CMD
comma
id|SONIC_CR_RST
)paren
suffix:semicolon
multiline_comment|/*&n;     * clear software reset flag, disable receiver, clear and&n;     * enable interrupts, then completely initialize the SONIC&n;     */
id|SONIC_WRITE
c_func
(paren
id|SONIC_CMD
comma
l_int|0
)paren
suffix:semicolon
id|SONIC_WRITE
c_func
(paren
id|SONIC_CMD
comma
id|SONIC_CR_RXDIS
)paren
suffix:semicolon
multiline_comment|/*&n;     * initialize the receive resource area&n;     */
r_if
c_cond
(paren
id|sonic_debug
OG
l_int|2
)paren
id|printk
(paren
l_string|&quot;sonic_init: initialize receive resource area&bslash;n&quot;
)paren
suffix:semicolon
id|rra_start
op_assign
id|lp-&gt;rra_laddr
op_amp
l_int|0xffff
suffix:semicolon
id|rra_end
op_assign
(paren
id|rra_start
op_plus
(paren
id|SONIC_NUM_RRS
op_star
r_sizeof
(paren
id|sonic_rr_t
)paren
)paren
)paren
op_amp
l_int|0xffff
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|SONIC_NUM_RRS
suffix:semicolon
id|i
op_increment
)paren
(brace
id|lp-&gt;rra
(braket
id|i
)braket
dot
id|rx_bufadr_l
op_assign
(paren
id|lp-&gt;rba_laddr
op_plus
id|i
op_star
id|SONIC_RBSIZE
)paren
op_amp
l_int|0xffff
suffix:semicolon
id|lp-&gt;rra
(braket
id|i
)braket
dot
id|rx_bufadr_h
op_assign
(paren
id|lp-&gt;rba_laddr
op_plus
id|i
op_star
id|SONIC_RBSIZE
)paren
op_rshift
l_int|16
suffix:semicolon
id|lp-&gt;rra
(braket
id|i
)braket
dot
id|rx_bufsize_l
op_assign
id|SONIC_RBSIZE
op_rshift
l_int|1
suffix:semicolon
id|lp-&gt;rra
(braket
id|i
)braket
dot
id|rx_bufsize_h
op_assign
l_int|0
suffix:semicolon
)brace
multiline_comment|/* initialize all RRA registers */
id|SONIC_WRITE
c_func
(paren
id|SONIC_RSA
comma
id|rra_start
)paren
suffix:semicolon
id|SONIC_WRITE
c_func
(paren
id|SONIC_REA
comma
id|rra_end
)paren
suffix:semicolon
id|SONIC_WRITE
c_func
(paren
id|SONIC_RRP
comma
id|rra_start
)paren
suffix:semicolon
id|SONIC_WRITE
c_func
(paren
id|SONIC_RWP
comma
id|rra_end
)paren
suffix:semicolon
id|SONIC_WRITE
c_func
(paren
id|SONIC_URRA
comma
id|lp-&gt;rra_laddr
op_rshift
l_int|16
)paren
suffix:semicolon
id|SONIC_WRITE
c_func
(paren
id|SONIC_EOBC
comma
(paren
id|SONIC_RBSIZE
op_minus
l_int|2
)paren
op_rshift
l_int|1
)paren
suffix:semicolon
id|lp-&gt;cur_rra
op_assign
id|SONIC_NUM_RRS
op_minus
l_int|2
suffix:semicolon
multiline_comment|/* load the resource pointers */
r_if
c_cond
(paren
id|sonic_debug
OG
l_int|3
)paren
id|printk
c_func
(paren
l_string|&quot;sonic_init: issueing RRRA command&bslash;n&quot;
)paren
suffix:semicolon
id|SONIC_WRITE
c_func
(paren
id|SONIC_CMD
comma
id|SONIC_CR_RRRA
)paren
suffix:semicolon
id|i
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
id|i
op_increment
OL
l_int|100
)paren
(brace
r_if
c_cond
(paren
id|SONIC_READ
c_func
(paren
id|SONIC_CMD
)paren
op_amp
id|SONIC_CR_RRRA
)paren
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|sonic_debug
OG
l_int|2
)paren
id|printk
c_func
(paren
l_string|&quot;sonic_init: status=%x&bslash;n&quot;
comma
id|SONIC_READ
c_func
(paren
id|SONIC_CMD
)paren
)paren
suffix:semicolon
multiline_comment|/*&n;     * Initialize the receive descriptors so that they&n;     * become a circular linked list, ie. let the last&n;     * descriptor point to the first again.&n;     */
r_if
c_cond
(paren
id|sonic_debug
OG
l_int|2
)paren
id|printk
(paren
l_string|&quot;sonic_init: initialize receive descriptors&bslash;n&quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|SONIC_NUM_RDS
suffix:semicolon
id|i
op_increment
)paren
(brace
id|lp-&gt;rda
(braket
id|i
)braket
dot
id|rx_status
op_assign
l_int|0
suffix:semicolon
id|lp-&gt;rda
(braket
id|i
)braket
dot
id|rx_pktlen
op_assign
l_int|0
suffix:semicolon
id|lp-&gt;rda
(braket
id|i
)braket
dot
id|rx_pktptr_l
op_assign
l_int|0
suffix:semicolon
id|lp-&gt;rda
(braket
id|i
)braket
dot
id|rx_pktptr_h
op_assign
l_int|0
suffix:semicolon
id|lp-&gt;rda
(braket
id|i
)braket
dot
id|rx_seqno
op_assign
l_int|0
suffix:semicolon
id|lp-&gt;rda
(braket
id|i
)braket
dot
id|in_use
op_assign
l_int|1
suffix:semicolon
id|lp-&gt;rda
(braket
id|i
)braket
dot
id|link
op_assign
id|lp-&gt;rda_laddr
op_plus
(paren
id|i
op_plus
l_int|1
)paren
op_star
r_sizeof
(paren
id|sonic_rd_t
)paren
suffix:semicolon
)brace
multiline_comment|/* fix last descriptor */
id|lp-&gt;rda
(braket
id|SONIC_NUM_RDS
op_minus
l_int|1
)braket
dot
id|link
op_assign
id|lp-&gt;rda_laddr
suffix:semicolon
id|lp-&gt;cur_rx
op_assign
l_int|0
suffix:semicolon
id|SONIC_WRITE
c_func
(paren
id|SONIC_URDA
comma
id|lp-&gt;rda_laddr
op_rshift
l_int|16
)paren
suffix:semicolon
id|SONIC_WRITE
c_func
(paren
id|SONIC_CRDA
comma
id|lp-&gt;rda_laddr
op_amp
l_int|0xffff
)paren
suffix:semicolon
multiline_comment|/* &n;     * initialize transmit descriptors&n;     */
r_if
c_cond
(paren
id|sonic_debug
OG
l_int|2
)paren
id|printk
(paren
l_string|&quot;sonic_init: initialize transmit descriptors&bslash;n&quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|SONIC_NUM_TDS
suffix:semicolon
id|i
op_increment
)paren
(brace
id|lp-&gt;tda
(braket
id|i
)braket
dot
id|tx_status
op_assign
l_int|0
suffix:semicolon
id|lp-&gt;tda
(braket
id|i
)braket
dot
id|tx_config
op_assign
l_int|0
suffix:semicolon
id|lp-&gt;tda
(braket
id|i
)braket
dot
id|tx_pktsize
op_assign
l_int|0
suffix:semicolon
id|lp-&gt;tda
(braket
id|i
)braket
dot
id|tx_frag_count
op_assign
l_int|0
suffix:semicolon
id|lp-&gt;tda
(braket
id|i
)braket
dot
id|link
op_assign
(paren
id|lp-&gt;tda_laddr
op_plus
(paren
id|i
op_plus
l_int|1
)paren
op_star
r_sizeof
(paren
id|sonic_td_t
)paren
)paren
op_or
id|SONIC_END_OF_LINKS
suffix:semicolon
)brace
id|lp-&gt;tda
(braket
id|SONIC_NUM_TDS
op_minus
l_int|1
)braket
dot
id|link
op_assign
(paren
id|lp-&gt;tda_laddr
op_amp
l_int|0xffff
)paren
op_or
id|SONIC_END_OF_LINKS
suffix:semicolon
id|SONIC_WRITE
c_func
(paren
id|SONIC_UTDA
comma
id|lp-&gt;tda_laddr
op_rshift
l_int|16
)paren
suffix:semicolon
id|SONIC_WRITE
c_func
(paren
id|SONIC_CTDA
comma
id|lp-&gt;tda_laddr
op_amp
l_int|0xffff
)paren
suffix:semicolon
multiline_comment|/*&n;     * put our own address to CAM desc[0]&n;     */
id|lp-&gt;cda.cam_desc
(braket
l_int|0
)braket
dot
id|cam_frag2
op_assign
id|dev-&gt;dev_addr
(braket
l_int|1
)braket
op_lshift
l_int|8
op_or
id|dev-&gt;dev_addr
(braket
l_int|0
)braket
suffix:semicolon
id|lp-&gt;cda.cam_desc
(braket
l_int|0
)braket
dot
id|cam_frag1
op_assign
id|dev-&gt;dev_addr
(braket
l_int|3
)braket
op_lshift
l_int|8
op_or
id|dev-&gt;dev_addr
(braket
l_int|2
)braket
suffix:semicolon
id|lp-&gt;cda.cam_desc
(braket
l_int|0
)braket
dot
id|cam_frag0
op_assign
id|dev-&gt;dev_addr
(braket
l_int|5
)braket
op_lshift
l_int|8
op_or
id|dev-&gt;dev_addr
(braket
l_int|4
)braket
suffix:semicolon
id|lp-&gt;cda.cam_enable
op_assign
l_int|1
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|16
suffix:semicolon
id|i
op_increment
)paren
id|lp-&gt;cda.cam_desc
(braket
id|i
)braket
dot
id|cam_entry_pointer
op_assign
id|i
suffix:semicolon
multiline_comment|/*&n;     * initialize CAM registers&n;     */
id|SONIC_WRITE
c_func
(paren
id|SONIC_CDP
comma
id|lp-&gt;cda_laddr
op_amp
l_int|0xffff
)paren
suffix:semicolon
id|SONIC_WRITE
c_func
(paren
id|SONIC_CDC
comma
l_int|1
)paren
suffix:semicolon
multiline_comment|/*&n;     * load the CAM&n;     */
id|SONIC_WRITE
c_func
(paren
id|SONIC_CMD
comma
id|SONIC_CR_LCAM
)paren
suffix:semicolon
id|i
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
id|i
op_increment
OL
l_int|100
)paren
(brace
r_if
c_cond
(paren
id|SONIC_READ
c_func
(paren
id|SONIC_ISR
)paren
op_amp
id|SONIC_INT_LCD
)paren
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|sonic_debug
OG
l_int|2
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;sonic_init: CMD=%x, ISR=%x&bslash;n&quot;
comma
id|SONIC_READ
c_func
(paren
id|SONIC_CMD
)paren
comma
id|SONIC_READ
c_func
(paren
id|SONIC_ISR
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;     * enable receiver, disable loopback&n;     * and enable all interrupts&n;     */
id|SONIC_WRITE
c_func
(paren
id|SONIC_CMD
comma
id|SONIC_CR_RXEN
op_or
id|SONIC_CR_STP
)paren
suffix:semicolon
id|SONIC_WRITE
c_func
(paren
id|SONIC_RCR
comma
id|SONIC_RCR_DEFAULT
)paren
suffix:semicolon
id|SONIC_WRITE
c_func
(paren
id|SONIC_TCR
comma
id|SONIC_TCR_DEFAULT
)paren
suffix:semicolon
id|SONIC_WRITE
c_func
(paren
id|SONIC_ISR
comma
l_int|0x7fff
)paren
suffix:semicolon
id|SONIC_WRITE
c_func
(paren
id|SONIC_IMR
comma
id|SONIC_IMR_DEFAULT
)paren
suffix:semicolon
id|cmd
op_assign
id|SONIC_READ
c_func
(paren
id|SONIC_CMD
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|cmd
op_amp
id|SONIC_CR_RXEN
)paren
op_eq
l_int|0
op_logical_or
(paren
id|cmd
op_amp
id|SONIC_CR_STP
)paren
op_eq
l_int|0
)paren
id|printk
c_func
(paren
l_string|&quot;sonic_init: failed, status=%x&bslash;n&quot;
comma
id|cmd
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sonic_debug
OG
l_int|2
)paren
id|printk
c_func
(paren
l_string|&quot;sonic_init: new status=%x&bslash;n&quot;
comma
id|SONIC_READ
c_func
(paren
id|SONIC_CMD
)paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
"&f;"
multiline_comment|/*&n; * Local variables:&n; *  compile-command: &quot;mipsel-linux-gcc -D__KERNEL__ -D__mips64 -I/usr/src/linux/net/inet -Wall -Wstrict-prototypes -O2 -mcpu=r4000 -c sonic.c&quot;&n; *  version-control: t&n; *  kept-new-versions: 5&n; *  tab-width: 4&n; * End:&n; */
eof
