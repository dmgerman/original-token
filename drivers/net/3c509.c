multiline_comment|/* 3c509.c: A 3c509 EtherLink3 ethernet driver for linux. */
multiline_comment|/*&n;&t;Written 1993,1994 by Donald Becker.&n;&n;&t;Copyright 1994 by Donald Becker.&n;&t;Copyright 1993 United States Government as represented by the&n;&t;Director, National Security Agency.&t; This software may be used and&n;&t;distributed according to the terms of the GNU Public License,&n;&t;incorporated herein by reference.&n;&n;&t;This driver is for the 3Com EtherLinkIII series.&n;&n;&t;The author may be reached as becker@cesdis.gsfc.nasa.gov or&n;&t;C/O Center of Excellence in Space Data and Information Sciences&n;&t;&t;Code 930.5, Goddard Space Flight Center, Greenbelt MD 20771&n;&n;&t;Known limitations:&n;&t;Because of the way 3c509 ISA detection works it&squot;s difficult to predict&n;&t;a priori which of several ISA-mode cards will be detected first.&n;&n;&t;This driver does not use predictive interrupt mode, resulting in higher&n;&t;packet latency but lower overhead.  If interrupts are disabled for an&n;&t;unusually long time it could also result in missed packets, but in&n;&t;practice this rarely happens.&n;*/
DECL|variable|version
r_static
r_const
r_char
op_star
id|version
op_assign
l_string|&quot;3c509.c:1.03 10/8/94 becker@cesdis.gsfc.nasa.gov&bslash;n&quot;
suffix:semicolon
macro_line|#include &lt;linux/config.h&gt;
macro_line|#ifdef MODULE
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/version.h&gt;
macro_line|#endif
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/interrupt.h&gt;
macro_line|#include &lt;linux/ptrace.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/in.h&gt;
macro_line|#include &lt;linux/malloc.h&gt;
macro_line|#include &lt;linux/ioport.h&gt;
macro_line|#include &lt;asm/bitops.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;linux/netdevice.h&gt;
macro_line|#include &lt;linux/etherdevice.h&gt;
macro_line|#include &lt;linux/skbuff.h&gt;
macro_line|#ifdef EL3_DEBUG
DECL|variable|el3_debug
r_int
id|el3_debug
op_assign
id|EL3_DEBUG
suffix:semicolon
macro_line|#else
DECL|variable|el3_debug
r_int
id|el3_debug
op_assign
l_int|2
suffix:semicolon
macro_line|#endif
multiline_comment|/* To minimize the size of the driver source I only define operating&n;   constants if they are used several times.  You&squot;ll need the manual&n;   if you want to understand driver details. */
multiline_comment|/* Offsets from base I/O address. */
DECL|macro|EL3_DATA
mdefine_line|#define EL3_DATA 0x00
DECL|macro|EL3_CMD
mdefine_line|#define EL3_CMD 0x0e
DECL|macro|EL3_STATUS
mdefine_line|#define EL3_STATUS 0x0e
DECL|macro|ID_PORT
mdefine_line|#define ID_PORT 0x100
DECL|macro|EEPROM_READ
mdefine_line|#define&t; EEPROM_READ 0x80
DECL|macro|EL3_IO_EXTENT
mdefine_line|#define EL3_IO_EXTENT&t;16
DECL|macro|EL3WINDOW
mdefine_line|#define EL3WINDOW(win_num) outw(SelectWindow + (win_num), ioaddr + EL3_CMD)
multiline_comment|/* The top five bits written to EL3_CMD are a command, the lower&n;   11 bits are the parameter, if applicable. */
DECL|enum|c509cmd
r_enum
id|c509cmd
(brace
DECL|enumerator|TotalReset
DECL|enumerator|SelectWindow
DECL|enumerator|StartCoax
id|TotalReset
op_assign
l_int|0
op_lshift
l_int|11
comma
id|SelectWindow
op_assign
l_int|1
op_lshift
l_int|11
comma
id|StartCoax
op_assign
l_int|2
op_lshift
l_int|11
comma
DECL|enumerator|RxDisable
DECL|enumerator|RxEnable
DECL|enumerator|RxReset
DECL|enumerator|RxDiscard
id|RxDisable
op_assign
l_int|3
op_lshift
l_int|11
comma
id|RxEnable
op_assign
l_int|4
op_lshift
l_int|11
comma
id|RxReset
op_assign
l_int|5
op_lshift
l_int|11
comma
id|RxDiscard
op_assign
l_int|8
op_lshift
l_int|11
comma
DECL|enumerator|TxEnable
DECL|enumerator|TxDisable
DECL|enumerator|TxReset
id|TxEnable
op_assign
l_int|9
op_lshift
l_int|11
comma
id|TxDisable
op_assign
l_int|10
op_lshift
l_int|11
comma
id|TxReset
op_assign
l_int|11
op_lshift
l_int|11
comma
DECL|enumerator|FakeIntr
DECL|enumerator|AckIntr
DECL|enumerator|SetIntrMask
id|FakeIntr
op_assign
l_int|12
op_lshift
l_int|11
comma
id|AckIntr
op_assign
l_int|13
op_lshift
l_int|11
comma
id|SetIntrMask
op_assign
l_int|14
op_lshift
l_int|11
comma
DECL|enumerator|SetReadZero
DECL|enumerator|SetRxFilter
DECL|enumerator|SetRxThreshold
id|SetReadZero
op_assign
l_int|15
op_lshift
l_int|11
comma
id|SetRxFilter
op_assign
l_int|16
op_lshift
l_int|11
comma
id|SetRxThreshold
op_assign
l_int|17
op_lshift
l_int|11
comma
DECL|enumerator|SetTxThreshold
DECL|enumerator|SetTxStart
DECL|enumerator|StatsEnable
id|SetTxThreshold
op_assign
l_int|18
op_lshift
l_int|11
comma
id|SetTxStart
op_assign
l_int|19
op_lshift
l_int|11
comma
id|StatsEnable
op_assign
l_int|21
op_lshift
l_int|11
comma
DECL|enumerator|StatsDisable
DECL|enumerator|StopCoax
id|StatsDisable
op_assign
l_int|22
op_lshift
l_int|11
comma
id|StopCoax
op_assign
l_int|23
op_lshift
l_int|11
comma
)brace
suffix:semicolon
multiline_comment|/* The SetRxFilter command accepts the following classes: */
DECL|enum|RxFilter
r_enum
id|RxFilter
(brace
DECL|enumerator|RxStation
DECL|enumerator|RxMulticast
DECL|enumerator|RxBroadcast
DECL|enumerator|RxProm
id|RxStation
op_assign
l_int|1
comma
id|RxMulticast
op_assign
l_int|2
comma
id|RxBroadcast
op_assign
l_int|4
comma
id|RxProm
op_assign
l_int|8
)brace
suffix:semicolon
multiline_comment|/* Register window 1 offsets, the window used in normal operation. */
DECL|macro|TX_FIFO
mdefine_line|#define TX_FIFO&t;&t;0x00
DECL|macro|RX_FIFO
mdefine_line|#define RX_FIFO&t;&t;0x00
DECL|macro|RX_STATUS
mdefine_line|#define RX_STATUS &t;0x08
DECL|macro|TX_STATUS
mdefine_line|#define TX_STATUS &t;0x0B
DECL|macro|TX_FREE
mdefine_line|#define TX_FREE&t;&t;0x0C&t;&t;/* Remaining free bytes in Tx buffer. */
DECL|macro|WN0_IRQ
mdefine_line|#define WN0_IRQ&t;&t;0x08&t;&t;/* Window 0: Set IRQ line in bits 12-15. */
DECL|macro|WN4_MEDIA
mdefine_line|#define WN4_MEDIA&t;0x0A&t;&t;/* Window 4: Various transcvr/media bits. */
DECL|macro|MEDIA_TP
mdefine_line|#define  MEDIA_TP&t;0x00C0&t;&t;/* Enable link beat and jabber for 10baseT. */
DECL|struct|el3_private
r_struct
id|el3_private
(brace
DECL|member|stats
r_struct
id|enet_statistics
id|stats
suffix:semicolon
)brace
suffix:semicolon
r_static
id|ushort
id|id_read_eeprom
c_func
(paren
r_int
id|index
)paren
suffix:semicolon
r_static
id|ushort
id|read_eeprom
c_func
(paren
r_int
id|ioaddr
comma
r_int
id|index
)paren
suffix:semicolon
r_static
r_int
id|el3_open
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_int
id|el3_start_xmit
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_void
id|el3_interrupt
c_func
(paren
r_int
id|irq
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
suffix:semicolon
r_static
r_void
id|update_stats
c_func
(paren
r_int
id|addr
comma
r_struct
id|device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_struct
id|enet_statistics
op_star
id|el3_get_stats
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_int
id|el3_rx
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_int
id|el3_close
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
suffix:semicolon
macro_line|#ifdef HAVE_MULTICAST
r_static
r_void
id|set_multicast_list
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
r_int
id|num_addrs
comma
r_void
op_star
id|addrs
)paren
suffix:semicolon
macro_line|#endif
"&f;"
DECL|function|el3_probe
r_int
id|el3_probe
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
r_int
id|lrs_state
op_assign
l_int|0xff
comma
id|i
suffix:semicolon
id|ushort
id|ioaddr
comma
id|irq
comma
id|if_port
suffix:semicolon
r_int
op_star
id|phys_addr
op_assign
(paren
r_int
op_star
)paren
id|dev-&gt;dev_addr
suffix:semicolon
r_static
r_int
id|current_tag
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* First check all slots of the EISA bus.  The next slot address to&n;&t;   probe is kept in &squot;eisa_addr&squot; to support multiple probe() calls. */
r_if
c_cond
(paren
id|EISA_bus
)paren
(brace
r_static
r_int
id|eisa_addr
op_assign
l_int|0x1000
suffix:semicolon
r_while
c_loop
(paren
id|eisa_addr
OL
l_int|0x9000
)paren
(brace
id|ioaddr
op_assign
id|eisa_addr
suffix:semicolon
id|eisa_addr
op_add_assign
l_int|0x1000
suffix:semicolon
multiline_comment|/* Check the standard EISA ID register for an encoded &squot;3Com&squot;. */
r_if
c_cond
(paren
id|inw
c_func
(paren
id|ioaddr
op_plus
l_int|0xC80
)paren
op_ne
l_int|0x6d50
)paren
r_continue
suffix:semicolon
multiline_comment|/* Change the register set to the configuration window 0. */
id|outw
c_func
(paren
id|SelectWindow
op_or
l_int|0
comma
id|ioaddr
op_plus
l_int|0xC80
op_plus
id|EL3_CMD
)paren
suffix:semicolon
id|irq
op_assign
id|inw
c_func
(paren
id|ioaddr
op_plus
id|WN0_IRQ
)paren
op_rshift
l_int|12
suffix:semicolon
id|if_port
op_assign
id|inw
c_func
(paren
id|ioaddr
op_plus
l_int|6
)paren
op_rshift
l_int|14
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|3
suffix:semicolon
id|i
op_increment
)paren
id|phys_addr
(braket
id|i
)braket
op_assign
id|htons
c_func
(paren
id|read_eeprom
c_func
(paren
id|ioaddr
comma
id|i
)paren
)paren
suffix:semicolon
multiline_comment|/* Restore the &quot;Product ID&quot; to the EEPROM read register. */
id|read_eeprom
c_func
(paren
id|ioaddr
comma
l_int|3
)paren
suffix:semicolon
multiline_comment|/* Was the EISA code an add-on hack?  Nahhhhh... */
r_goto
id|found
suffix:semicolon
)brace
)brace
macro_line|#ifdef CONFIG_MCA
r_if
c_cond
(paren
id|MCA_bus
)paren
(brace
id|mca_adaptor_select_mode
c_func
(paren
l_int|1
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|8
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
(paren
id|mca_adaptor_id
c_func
(paren
id|i
)paren
op_or
l_int|1
)paren
op_eq
l_int|0x627c
)paren
(brace
id|ioaddr
op_assign
id|mca_pos_base_addr
c_func
(paren
id|i
)paren
suffix:semicolon
id|irq
op_assign
id|inw
c_func
(paren
id|ioaddr
op_plus
id|WN0_IRQ
)paren
op_rshift
l_int|12
suffix:semicolon
id|if_port
op_assign
id|inw
c_func
(paren
id|ioaddr
op_plus
l_int|6
)paren
op_rshift
l_int|14
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|3
suffix:semicolon
id|i
op_increment
)paren
id|phys_addr
(braket
id|i
)braket
op_assign
id|htons
c_func
(paren
id|read_eeprom
c_func
(paren
id|ioaddr
comma
id|i
)paren
)paren
suffix:semicolon
id|mca_adaptor_select_mode
c_func
(paren
l_int|0
)paren
suffix:semicolon
r_goto
id|found
suffix:semicolon
)brace
id|mca_adaptor_select_mode
c_func
(paren
l_int|0
)paren
suffix:semicolon
)brace
macro_line|#endif
multiline_comment|/* Next check for all ISA bus boards by sending the ID sequence to the&n;&t;   ID_PORT.  We find cards past the first by setting the &squot;current_tag&squot;&n;&t;   on cards as they are found.  Cards with their tag set will not&n;&t;   respond to subsequent ID sequences. */
r_if
c_cond
(paren
id|check_region
c_func
(paren
id|ID_PORT
comma
l_int|1
)paren
)paren
(brace
r_static
r_int
id|once
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|once
)paren
id|printk
c_func
(paren
l_string|&quot;3c509: Somebody has reserved 0x%x, can&squot;t do ID_PORT lookup, nor card auto-probing&bslash;n&quot;
comma
id|ID_PORT
)paren
suffix:semicolon
id|once
op_assign
l_int|0
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
id|outb
c_func
(paren
l_int|0x00
comma
id|ID_PORT
)paren
suffix:semicolon
id|outb
c_func
(paren
l_int|0x00
comma
id|ID_PORT
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|255
suffix:semicolon
id|i
op_increment
)paren
(brace
id|outb
c_func
(paren
id|lrs_state
comma
id|ID_PORT
)paren
suffix:semicolon
id|lrs_state
op_lshift_assign
l_int|1
suffix:semicolon
id|lrs_state
op_assign
id|lrs_state
op_amp
l_int|0x100
ques
c_cond
id|lrs_state
op_xor
l_int|0xcf
suffix:colon
id|lrs_state
suffix:semicolon
)brace
multiline_comment|/* For the first probe, clear all board&squot;s tag registers. */
r_if
c_cond
(paren
id|current_tag
op_eq
l_int|0
)paren
id|outb
c_func
(paren
l_int|0xd0
comma
id|ID_PORT
)paren
suffix:semicolon
r_else
multiline_comment|/* Otherwise kill off already-found boards. */
id|outb
c_func
(paren
l_int|0xd8
comma
id|ID_PORT
)paren
suffix:semicolon
r_if
c_cond
(paren
id|id_read_eeprom
c_func
(paren
l_int|7
)paren
op_ne
l_int|0x6d50
)paren
(brace
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
multiline_comment|/* Read in EEPROM data, which does contention-select.&n;&t;   Only the lowest address board will stay &quot;on-line&quot;.&n;&t;   3Com got the byte order backwards. */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|3
suffix:semicolon
id|i
op_increment
)paren
(brace
id|phys_addr
(braket
id|i
)braket
op_assign
id|htons
c_func
(paren
id|id_read_eeprom
c_func
(paren
id|i
)paren
)paren
suffix:semicolon
)brace
(brace
r_int
r_int
id|iobase
op_assign
id|id_read_eeprom
c_func
(paren
l_int|8
)paren
suffix:semicolon
id|if_port
op_assign
id|iobase
op_rshift
l_int|14
suffix:semicolon
id|ioaddr
op_assign
l_int|0x200
op_plus
(paren
(paren
id|iobase
op_amp
l_int|0x1f
)paren
op_lshift
l_int|4
)paren
suffix:semicolon
)brace
id|irq
op_assign
id|id_read_eeprom
c_func
(paren
l_int|9
)paren
op_rshift
l_int|12
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;base_addr
op_ne
l_int|0
op_logical_and
id|dev-&gt;base_addr
op_ne
(paren
r_int
r_int
)paren
id|ioaddr
)paren
(brace
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
multiline_comment|/* Set the adaptor tag so that the next card can be found. */
id|outb
c_func
(paren
l_int|0xd0
op_plus
op_increment
id|current_tag
comma
id|ID_PORT
)paren
suffix:semicolon
multiline_comment|/* Activate the adaptor at the EEPROM location. */
id|outb
c_func
(paren
l_int|0xff
comma
id|ID_PORT
)paren
suffix:semicolon
id|EL3WINDOW
c_func
(paren
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|inw
c_func
(paren
id|ioaddr
)paren
op_ne
l_int|0x6d50
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
multiline_comment|/* Free the interrupt so that some other card can use it. */
id|outw
c_func
(paren
l_int|0x0f00
comma
id|ioaddr
op_plus
id|WN0_IRQ
)paren
suffix:semicolon
id|found
suffix:colon
id|dev-&gt;base_addr
op_assign
id|ioaddr
suffix:semicolon
id|dev-&gt;irq
op_assign
id|irq
suffix:semicolon
id|dev-&gt;if_port
op_assign
id|if_port
suffix:semicolon
id|request_region
c_func
(paren
id|dev-&gt;base_addr
comma
id|EL3_IO_EXTENT
comma
l_string|&quot;3c509&quot;
)paren
suffix:semicolon
(brace
r_const
r_char
op_star
id|if_names
(braket
)braket
op_assign
(brace
l_string|&quot;10baseT&quot;
comma
l_string|&quot;AUI&quot;
comma
l_string|&quot;undefined&quot;
comma
l_string|&quot;BNC&quot;
)brace
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;%s: 3c509 at %#3.3lx tag %d, %s port, address &quot;
comma
id|dev-&gt;name
comma
id|dev-&gt;base_addr
comma
id|current_tag
comma
id|if_names
(braket
id|dev-&gt;if_port
)braket
)paren
suffix:semicolon
)brace
multiline_comment|/* Read in the station address. */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|6
suffix:semicolon
id|i
op_increment
)paren
id|printk
c_func
(paren
l_string|&quot; %2.2x&quot;
comma
id|dev-&gt;dev_addr
(braket
id|i
)braket
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;, IRQ %d.&bslash;n&quot;
comma
id|dev-&gt;irq
)paren
suffix:semicolon
multiline_comment|/* Make up a EL3-specific-data structure. */
id|dev-&gt;priv
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|el3_private
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
id|memset
c_func
(paren
id|dev-&gt;priv
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|el3_private
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|el3_debug
OG
l_int|0
)paren
id|printk
c_func
(paren
id|version
)paren
suffix:semicolon
multiline_comment|/* The EL3-specific entries in the device structure. */
id|dev-&gt;open
op_assign
op_amp
id|el3_open
suffix:semicolon
id|dev-&gt;hard_start_xmit
op_assign
op_amp
id|el3_start_xmit
suffix:semicolon
id|dev-&gt;stop
op_assign
op_amp
id|el3_close
suffix:semicolon
id|dev-&gt;get_stats
op_assign
op_amp
id|el3_get_stats
suffix:semicolon
macro_line|#ifdef HAVE_MULTICAST
id|dev-&gt;set_multicast_list
op_assign
op_amp
id|set_multicast_list
suffix:semicolon
macro_line|#endif
multiline_comment|/* Fill in the generic fields of the device structure. */
id|ether_setup
c_func
(paren
id|dev
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Read a word from the EEPROM using the regular EEPROM access register.&n;   Assume that we are in register window zero.&n; */
DECL|function|read_eeprom
r_static
id|ushort
id|read_eeprom
c_func
(paren
r_int
id|ioaddr
comma
r_int
id|index
)paren
(brace
r_int
id|timer
suffix:semicolon
id|outw
c_func
(paren
id|EEPROM_READ
op_plus
id|index
comma
id|ioaddr
op_plus
l_int|10
)paren
suffix:semicolon
multiline_comment|/* Pause for at least 162 us. for the read to take place. */
r_for
c_loop
(paren
id|timer
op_assign
l_int|0
suffix:semicolon
id|timer
OL
l_int|162
op_star
l_int|4
op_plus
l_int|400
suffix:semicolon
id|timer
op_increment
)paren
id|SLOW_DOWN_IO
suffix:semicolon
r_return
id|inw
c_func
(paren
id|ioaddr
op_plus
l_int|12
)paren
suffix:semicolon
)brace
multiline_comment|/* Read a word from the EEPROM when in the ISA ID probe state. */
DECL|function|id_read_eeprom
r_static
id|ushort
id|id_read_eeprom
c_func
(paren
r_int
id|index
)paren
(brace
r_int
id|timer
comma
id|bit
comma
id|word
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Issue read command, and pause for at least 162 us. for it to complete.&n;&t;   Assume extra-fast 16Mhz bus. */
id|outb
c_func
(paren
id|EEPROM_READ
op_plus
id|index
comma
id|ID_PORT
)paren
suffix:semicolon
multiline_comment|/* This should really be done by looking at one of the timer channels. */
r_for
c_loop
(paren
id|timer
op_assign
l_int|0
suffix:semicolon
id|timer
OL
l_int|162
op_star
l_int|4
op_plus
l_int|400
suffix:semicolon
id|timer
op_increment
)paren
id|SLOW_DOWN_IO
suffix:semicolon
r_for
c_loop
(paren
id|bit
op_assign
l_int|15
suffix:semicolon
id|bit
op_ge
l_int|0
suffix:semicolon
id|bit
op_decrement
)paren
id|word
op_assign
(paren
id|word
op_lshift
l_int|1
)paren
op_plus
(paren
id|inb
c_func
(paren
id|ID_PORT
)paren
op_amp
l_int|0x01
)paren
suffix:semicolon
r_if
c_cond
(paren
id|el3_debug
OG
l_int|3
)paren
id|printk
c_func
(paren
l_string|&quot;  3c509 EEPROM word %d %#4.4x.&bslash;n&quot;
comma
id|index
comma
id|word
)paren
suffix:semicolon
r_return
id|word
suffix:semicolon
)brace
"&f;"
r_static
r_int
DECL|function|el3_open
id|el3_open
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
r_int
id|ioaddr
op_assign
id|dev-&gt;base_addr
suffix:semicolon
r_int
id|i
suffix:semicolon
id|outw
c_func
(paren
id|TxReset
comma
id|ioaddr
op_plus
id|EL3_CMD
)paren
suffix:semicolon
id|outw
c_func
(paren
id|RxReset
comma
id|ioaddr
op_plus
id|EL3_CMD
)paren
suffix:semicolon
id|outw
c_func
(paren
id|SetReadZero
op_or
l_int|0x00
comma
id|ioaddr
op_plus
id|EL3_CMD
)paren
suffix:semicolon
r_if
c_cond
(paren
id|request_irq
c_func
(paren
id|dev-&gt;irq
comma
op_amp
id|el3_interrupt
comma
l_int|0
comma
l_string|&quot;3c509&quot;
)paren
)paren
(brace
r_return
op_minus
id|EAGAIN
suffix:semicolon
)brace
id|EL3WINDOW
c_func
(paren
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|el3_debug
OG
l_int|3
)paren
id|printk
c_func
(paren
l_string|&quot;%s: Opening, IRQ %d&t; status@%x %4.4x.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|dev-&gt;irq
comma
id|ioaddr
op_plus
id|EL3_STATUS
comma
id|inw
c_func
(paren
id|ioaddr
op_plus
id|EL3_STATUS
)paren
)paren
suffix:semicolon
multiline_comment|/* Activate board: this is probably unnecessary. */
id|outw
c_func
(paren
l_int|0x0001
comma
id|ioaddr
op_plus
l_int|4
)paren
suffix:semicolon
id|irq2dev_map
(braket
id|dev-&gt;irq
)braket
op_assign
id|dev
suffix:semicolon
multiline_comment|/* Set the IRQ line. */
id|outw
c_func
(paren
(paren
id|dev-&gt;irq
op_lshift
l_int|12
)paren
op_or
l_int|0x0f00
comma
id|ioaddr
op_plus
id|WN0_IRQ
)paren
suffix:semicolon
multiline_comment|/* Set the station address in window 2 each time opened. */
id|EL3WINDOW
c_func
(paren
l_int|2
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|6
suffix:semicolon
id|i
op_increment
)paren
id|outb
c_func
(paren
id|dev-&gt;dev_addr
(braket
id|i
)braket
comma
id|ioaddr
op_plus
id|i
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;if_port
op_eq
l_int|3
)paren
multiline_comment|/* Start the thinnet transceiver. We should really wait 50ms...*/
id|outw
c_func
(paren
id|StartCoax
comma
id|ioaddr
op_plus
id|EL3_CMD
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
id|dev-&gt;if_port
op_eq
l_int|0
)paren
(brace
multiline_comment|/* 10baseT interface, enabled link beat and jabber check. */
id|EL3WINDOW
c_func
(paren
l_int|4
)paren
suffix:semicolon
id|outw
c_func
(paren
id|inw
c_func
(paren
id|ioaddr
op_plus
id|WN4_MEDIA
)paren
op_or
id|MEDIA_TP
comma
id|ioaddr
op_plus
id|WN4_MEDIA
)paren
suffix:semicolon
)brace
multiline_comment|/* Switch to the stats window, and clear all stats by reading. */
id|outw
c_func
(paren
id|StatsDisable
comma
id|ioaddr
op_plus
id|EL3_CMD
)paren
suffix:semicolon
id|EL3WINDOW
c_func
(paren
l_int|6
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|9
suffix:semicolon
id|i
op_increment
)paren
id|inb
c_func
(paren
id|ioaddr
op_plus
id|i
)paren
suffix:semicolon
id|inb
c_func
(paren
id|ioaddr
op_plus
l_int|10
)paren
suffix:semicolon
id|inb
c_func
(paren
id|ioaddr
op_plus
l_int|12
)paren
suffix:semicolon
multiline_comment|/* Switch to register set 1 for normal use. */
id|EL3WINDOW
c_func
(paren
l_int|1
)paren
suffix:semicolon
multiline_comment|/* Accept b-case and phys addr only. */
id|outw
c_func
(paren
id|SetRxFilter
op_or
id|RxStation
op_or
id|RxBroadcast
comma
id|ioaddr
op_plus
id|EL3_CMD
)paren
suffix:semicolon
id|outw
c_func
(paren
id|StatsEnable
comma
id|ioaddr
op_plus
id|EL3_CMD
)paren
suffix:semicolon
multiline_comment|/* Turn on statistics. */
id|dev-&gt;interrupt
op_assign
l_int|0
suffix:semicolon
id|dev-&gt;tbusy
op_assign
l_int|0
suffix:semicolon
id|dev-&gt;start
op_assign
l_int|1
suffix:semicolon
id|outw
c_func
(paren
id|RxEnable
comma
id|ioaddr
op_plus
id|EL3_CMD
)paren
suffix:semicolon
multiline_comment|/* Enable the receiver. */
id|outw
c_func
(paren
id|TxEnable
comma
id|ioaddr
op_plus
id|EL3_CMD
)paren
suffix:semicolon
multiline_comment|/* Enable transmitter. */
multiline_comment|/* Allow status bits to be seen. */
id|outw
c_func
(paren
id|SetReadZero
op_or
l_int|0xff
comma
id|ioaddr
op_plus
id|EL3_CMD
)paren
suffix:semicolon
id|outw
c_func
(paren
id|AckIntr
op_or
l_int|0x69
comma
id|ioaddr
op_plus
id|EL3_CMD
)paren
suffix:semicolon
multiline_comment|/* Ack IRQ */
id|outw
c_func
(paren
id|SetIntrMask
op_or
l_int|0x98
comma
id|ioaddr
op_plus
id|EL3_CMD
)paren
suffix:semicolon
multiline_comment|/* Set interrupt mask. */
r_if
c_cond
(paren
id|el3_debug
OG
l_int|3
)paren
id|printk
c_func
(paren
l_string|&quot;%s: Opened 3c509  IRQ %d  status %4.4x.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|dev-&gt;irq
comma
id|inw
c_func
(paren
id|ioaddr
op_plus
id|EL3_STATUS
)paren
)paren
suffix:semicolon
macro_line|#ifdef MODULE
id|MOD_INC_USE_COUNT
suffix:semicolon
macro_line|#endif
r_return
l_int|0
suffix:semicolon
multiline_comment|/* Always succeed */
)brace
r_static
r_int
DECL|function|el3_start_xmit
id|el3_start_xmit
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|device
op_star
id|dev
)paren
(brace
r_struct
id|el3_private
op_star
id|lp
op_assign
(paren
r_struct
id|el3_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_int
id|ioaddr
op_assign
id|dev-&gt;base_addr
suffix:semicolon
multiline_comment|/* Transmitter timeout, serious problems. */
r_if
c_cond
(paren
id|dev-&gt;tbusy
)paren
(brace
r_int
id|tickssofar
op_assign
id|jiffies
op_minus
id|dev-&gt;trans_start
suffix:semicolon
r_if
c_cond
(paren
id|tickssofar
OL
l_int|10
)paren
r_return
l_int|1
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;%s: transmit timed out, tx_status %2.2x status %4.4x.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|inb
c_func
(paren
id|ioaddr
op_plus
id|TX_STATUS
)paren
comma
id|inw
c_func
(paren
id|ioaddr
op_plus
id|EL3_STATUS
)paren
)paren
suffix:semicolon
id|dev-&gt;trans_start
op_assign
id|jiffies
suffix:semicolon
multiline_comment|/* Issue TX_RESET and TX_START commands. */
id|outw
c_func
(paren
id|TxReset
comma
id|ioaddr
op_plus
id|EL3_CMD
)paren
suffix:semicolon
id|outw
c_func
(paren
id|TxEnable
comma
id|ioaddr
op_plus
id|EL3_CMD
)paren
suffix:semicolon
id|dev-&gt;tbusy
op_assign
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|skb
op_eq
l_int|NULL
)paren
(brace
id|dev_tint
c_func
(paren
id|dev
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|skb-&gt;len
op_le
l_int|0
)paren
r_return
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|el3_debug
OG
l_int|4
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%s: el3_start_xmit(length = %ld) called, status %4.4x.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|skb-&gt;len
comma
id|inw
c_func
(paren
id|ioaddr
op_plus
id|EL3_STATUS
)paren
)paren
suffix:semicolon
)brace
macro_line|#ifndef final_version
(brace
multiline_comment|/* Error-checking code, delete for 1.30. */
id|ushort
id|status
op_assign
id|inw
c_func
(paren
id|ioaddr
op_plus
id|EL3_STATUS
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
l_int|0x0001
multiline_comment|/* IRQ line active, missed one. */
op_logical_and
id|inw
c_func
(paren
id|ioaddr
op_plus
id|EL3_STATUS
)paren
op_amp
l_int|1
)paren
(brace
multiline_comment|/* Make sure. */
id|printk
c_func
(paren
l_string|&quot;%s: Missed interrupt, status then %04x now %04x&quot;
l_string|&quot;  Tx %2.2x Rx %4.4x.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|status
comma
id|inw
c_func
(paren
id|ioaddr
op_plus
id|EL3_STATUS
)paren
comma
id|inb
c_func
(paren
id|ioaddr
op_plus
id|TX_STATUS
)paren
comma
id|inw
c_func
(paren
id|ioaddr
op_plus
id|RX_STATUS
)paren
)paren
suffix:semicolon
multiline_comment|/* Fake interrupt trigger by masking, acknowledge interrupts. */
id|outw
c_func
(paren
id|SetReadZero
op_or
l_int|0x00
comma
id|ioaddr
op_plus
id|EL3_CMD
)paren
suffix:semicolon
id|outw
c_func
(paren
id|AckIntr
op_or
l_int|0x69
comma
id|ioaddr
op_plus
id|EL3_CMD
)paren
suffix:semicolon
multiline_comment|/* Ack IRQ */
id|outw
c_func
(paren
id|SetReadZero
op_or
l_int|0xff
comma
id|ioaddr
op_plus
id|EL3_CMD
)paren
suffix:semicolon
)brace
)brace
macro_line|#endif
multiline_comment|/* Avoid timer-based retransmission conflicts. */
r_if
c_cond
(paren
id|set_bit
c_func
(paren
l_int|0
comma
(paren
r_void
op_star
)paren
op_amp
id|dev-&gt;tbusy
)paren
op_ne
l_int|0
)paren
id|printk
c_func
(paren
l_string|&quot;%s: Transmitter access conflict.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_else
(brace
multiline_comment|/* Put out the doubleword header... */
id|outw
c_func
(paren
id|skb-&gt;len
comma
id|ioaddr
op_plus
id|TX_FIFO
)paren
suffix:semicolon
id|outw
c_func
(paren
l_int|0x00
comma
id|ioaddr
op_plus
id|TX_FIFO
)paren
suffix:semicolon
multiline_comment|/* ... and the packet rounded to a doubleword. */
id|outsl
c_func
(paren
id|ioaddr
op_plus
id|TX_FIFO
comma
id|skb-&gt;data
comma
(paren
id|skb-&gt;len
op_plus
l_int|3
)paren
op_rshift
l_int|2
)paren
suffix:semicolon
id|dev-&gt;trans_start
op_assign
id|jiffies
suffix:semicolon
r_if
c_cond
(paren
id|inw
c_func
(paren
id|ioaddr
op_plus
id|TX_FREE
)paren
OG
l_int|1536
)paren
(brace
id|dev-&gt;tbusy
op_assign
l_int|0
suffix:semicolon
)brace
r_else
multiline_comment|/* Interrupt us when the FIFO has room for max-sized packet. */
id|outw
c_func
(paren
id|SetTxThreshold
op_plus
l_int|1536
comma
id|ioaddr
op_plus
id|EL3_CMD
)paren
suffix:semicolon
)brace
id|dev_kfree_skb
(paren
id|skb
comma
id|FREE_WRITE
)paren
suffix:semicolon
multiline_comment|/* Clear the Tx status stack. */
(brace
r_int
id|tx_status
suffix:semicolon
r_int
id|i
op_assign
l_int|4
suffix:semicolon
r_while
c_loop
(paren
op_decrement
id|i
OG
l_int|0
op_logical_and
(paren
id|tx_status
op_assign
id|inb
c_func
(paren
id|ioaddr
op_plus
id|TX_STATUS
)paren
)paren
OG
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|tx_status
op_amp
l_int|0x38
)paren
id|lp-&gt;stats.tx_aborted_errors
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|tx_status
op_amp
l_int|0x30
)paren
id|outw
c_func
(paren
id|TxReset
comma
id|ioaddr
op_plus
id|EL3_CMD
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tx_status
op_amp
l_int|0x3C
)paren
id|outw
c_func
(paren
id|TxEnable
comma
id|ioaddr
op_plus
id|EL3_CMD
)paren
suffix:semicolon
id|outb
c_func
(paren
l_int|0x00
comma
id|ioaddr
op_plus
id|TX_STATUS
)paren
suffix:semicolon
multiline_comment|/* Pop the status stack. */
)brace
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* The EL3 interrupt handler. */
r_static
r_void
DECL|function|el3_interrupt
id|el3_interrupt
c_func
(paren
r_int
id|irq
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_struct
id|device
op_star
id|dev
op_assign
(paren
r_struct
id|device
op_star
)paren
(paren
id|irq2dev_map
(braket
id|irq
)braket
)paren
suffix:semicolon
r_int
id|ioaddr
comma
id|status
suffix:semicolon
r_int
id|i
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|dev
op_eq
l_int|NULL
)paren
(brace
id|printk
(paren
l_string|&quot;el3_interrupt(): irq %d for unknown device.&bslash;n&quot;
comma
id|irq
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|dev-&gt;interrupt
)paren
id|printk
c_func
(paren
l_string|&quot;%s: Re-entering the interrupt handler.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|dev-&gt;interrupt
op_assign
l_int|1
suffix:semicolon
id|ioaddr
op_assign
id|dev-&gt;base_addr
suffix:semicolon
id|status
op_assign
id|inw
c_func
(paren
id|ioaddr
op_plus
id|EL3_STATUS
)paren
suffix:semicolon
r_if
c_cond
(paren
id|el3_debug
OG
l_int|4
)paren
id|printk
c_func
(paren
l_string|&quot;%s: interrupt, status %4.4x.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|status
)paren
suffix:semicolon
r_while
c_loop
(paren
(paren
id|status
op_assign
id|inw
c_func
(paren
id|ioaddr
op_plus
id|EL3_STATUS
)paren
)paren
op_amp
l_int|0x91
)paren
(brace
r_if
c_cond
(paren
id|status
op_amp
l_int|0x10
)paren
id|el3_rx
c_func
(paren
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
l_int|0x08
)paren
(brace
r_if
c_cond
(paren
id|el3_debug
OG
l_int|5
)paren
id|printk
c_func
(paren
l_string|&quot;&t;TX room bit was handled.&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* There&squot;s room in the FIFO for a full-sized packet. */
id|outw
c_func
(paren
id|AckIntr
op_or
l_int|0x08
comma
id|ioaddr
op_plus
id|EL3_CMD
)paren
suffix:semicolon
id|dev-&gt;tbusy
op_assign
l_int|0
suffix:semicolon
id|mark_bh
c_func
(paren
id|NET_BH
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|status
op_amp
l_int|0x80
)paren
multiline_comment|/* Statistics full. */
id|update_stats
c_func
(paren
id|ioaddr
comma
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
op_increment
id|i
OG
l_int|10
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%s: Infinite loop in interrupt, status %4.4x.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|status
)paren
suffix:semicolon
multiline_comment|/* Clear all interrupts. */
id|outw
c_func
(paren
id|AckIntr
op_or
l_int|0xFF
comma
id|ioaddr
op_plus
id|EL3_CMD
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
multiline_comment|/* Acknowledge the IRQ. */
id|outw
c_func
(paren
id|AckIntr
op_or
l_int|0x41
comma
id|ioaddr
op_plus
id|EL3_CMD
)paren
suffix:semicolon
multiline_comment|/* Ack IRQ */
)brace
r_if
c_cond
(paren
id|el3_debug
OG
l_int|4
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%s: exiting interrupt, status %4.4x.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|inw
c_func
(paren
id|ioaddr
op_plus
id|EL3_STATUS
)paren
)paren
suffix:semicolon
)brace
id|dev-&gt;interrupt
op_assign
l_int|0
suffix:semicolon
r_return
suffix:semicolon
)brace
r_static
r_struct
id|enet_statistics
op_star
DECL|function|el3_get_stats
id|el3_get_stats
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
r_struct
id|el3_private
op_star
id|lp
op_assign
(paren
r_struct
id|el3_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|update_stats
c_func
(paren
id|dev-&gt;base_addr
comma
id|dev
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
op_amp
id|lp-&gt;stats
suffix:semicolon
)brace
multiline_comment|/*  Update statistics.  We change to register window 6, so this should be run&n;&t;single-threaded if the device is active. This is expected to be a rare&n;&t;operation, and it&squot;s simpler for the rest of the driver to assume that&n;&t;window 1 is always valid rather than use a special window-state variable.&n;&t;*/
DECL|function|update_stats
r_static
r_void
id|update_stats
c_func
(paren
r_int
id|ioaddr
comma
r_struct
id|device
op_star
id|dev
)paren
(brace
r_struct
id|el3_private
op_star
id|lp
op_assign
(paren
r_struct
id|el3_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_if
c_cond
(paren
id|el3_debug
OG
l_int|5
)paren
id|printk
c_func
(paren
l_string|&quot;   Updating the statistics.&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* Turn off statistics updates while reading. */
id|outw
c_func
(paren
id|StatsDisable
comma
id|ioaddr
op_plus
id|EL3_CMD
)paren
suffix:semicolon
multiline_comment|/* Switch to the stats window, and read everything. */
id|EL3WINDOW
c_func
(paren
l_int|6
)paren
suffix:semicolon
id|lp-&gt;stats.tx_carrier_errors
op_add_assign
id|inb
c_func
(paren
id|ioaddr
op_plus
l_int|0
)paren
suffix:semicolon
id|lp-&gt;stats.tx_heartbeat_errors
op_add_assign
id|inb
c_func
(paren
id|ioaddr
op_plus
l_int|1
)paren
suffix:semicolon
multiline_comment|/* Multiple collisions. */
id|inb
c_func
(paren
id|ioaddr
op_plus
l_int|2
)paren
suffix:semicolon
id|lp-&gt;stats.collisions
op_add_assign
id|inb
c_func
(paren
id|ioaddr
op_plus
l_int|3
)paren
suffix:semicolon
id|lp-&gt;stats.tx_window_errors
op_add_assign
id|inb
c_func
(paren
id|ioaddr
op_plus
l_int|4
)paren
suffix:semicolon
id|lp-&gt;stats.rx_fifo_errors
op_add_assign
id|inb
c_func
(paren
id|ioaddr
op_plus
l_int|5
)paren
suffix:semicolon
id|lp-&gt;stats.tx_packets
op_add_assign
id|inb
c_func
(paren
id|ioaddr
op_plus
l_int|6
)paren
suffix:semicolon
multiline_comment|/* Rx packets&t;*/
id|inb
c_func
(paren
id|ioaddr
op_plus
l_int|7
)paren
suffix:semicolon
multiline_comment|/* Tx deferrals */
id|inb
c_func
(paren
id|ioaddr
op_plus
l_int|8
)paren
suffix:semicolon
id|inw
c_func
(paren
id|ioaddr
op_plus
l_int|10
)paren
suffix:semicolon
multiline_comment|/* Total Rx and Tx octets. */
id|inw
c_func
(paren
id|ioaddr
op_plus
l_int|12
)paren
suffix:semicolon
multiline_comment|/* Back to window 1, and turn statistics back on. */
id|EL3WINDOW
c_func
(paren
l_int|1
)paren
suffix:semicolon
id|outw
c_func
(paren
id|StatsEnable
comma
id|ioaddr
op_plus
id|EL3_CMD
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_static
r_int
DECL|function|el3_rx
id|el3_rx
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
r_struct
id|el3_private
op_star
id|lp
op_assign
(paren
r_struct
id|el3_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_int
id|ioaddr
op_assign
id|dev-&gt;base_addr
suffix:semicolon
r_int
id|rx_status
suffix:semicolon
r_if
c_cond
(paren
id|el3_debug
OG
l_int|5
)paren
id|printk
c_func
(paren
l_string|&quot;   In rx_packet(), status %4.4x, rx_status %4.4x.&bslash;n&quot;
comma
id|inw
c_func
(paren
id|ioaddr
op_plus
id|EL3_STATUS
)paren
comma
id|inw
c_func
(paren
id|ioaddr
op_plus
id|RX_STATUS
)paren
)paren
suffix:semicolon
r_while
c_loop
(paren
(paren
id|rx_status
op_assign
id|inw
c_func
(paren
id|ioaddr
op_plus
id|RX_STATUS
)paren
)paren
OG
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|rx_status
op_amp
l_int|0x4000
)paren
(brace
multiline_comment|/* Error, update stats. */
r_int
id|error
op_assign
id|rx_status
op_amp
l_int|0x3800
suffix:semicolon
id|lp-&gt;stats.rx_errors
op_increment
suffix:semicolon
r_switch
c_cond
(paren
id|error
)paren
(brace
r_case
l_int|0x0000
suffix:colon
id|lp-&gt;stats.rx_over_errors
op_increment
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x0800
suffix:colon
id|lp-&gt;stats.rx_length_errors
op_increment
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x1000
suffix:colon
id|lp-&gt;stats.rx_frame_errors
op_increment
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x1800
suffix:colon
id|lp-&gt;stats.rx_length_errors
op_increment
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x2000
suffix:colon
id|lp-&gt;stats.rx_frame_errors
op_increment
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x2800
suffix:colon
id|lp-&gt;stats.rx_crc_errors
op_increment
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
r_else
(brace
r_int
id|pkt_len
op_assign
id|rx_status
op_amp
l_int|0x7ff
suffix:semicolon
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
id|skb
op_assign
id|dev_alloc_skb
c_func
(paren
id|pkt_len
op_plus
l_int|5
)paren
suffix:semicolon
r_if
c_cond
(paren
id|el3_debug
OG
l_int|4
)paren
id|printk
c_func
(paren
l_string|&quot;Receiving packet size %d status %4.4x.&bslash;n&quot;
comma
id|pkt_len
comma
id|rx_status
)paren
suffix:semicolon
r_if
c_cond
(paren
id|skb
op_ne
l_int|NULL
)paren
(brace
id|skb-&gt;dev
op_assign
id|dev
suffix:semicolon
id|skb_reserve
c_func
(paren
id|skb
comma
l_int|2
)paren
suffix:semicolon
multiline_comment|/* Align IP on 16 byte boundaries */
multiline_comment|/* &squot;skb-&gt;data&squot; points to the start of sk_buff data area. */
id|insl
c_func
(paren
id|ioaddr
op_plus
id|RX_FIFO
comma
id|skb_put
c_func
(paren
id|skb
comma
id|pkt_len
)paren
comma
(paren
id|pkt_len
op_plus
l_int|3
)paren
op_rshift
l_int|2
)paren
suffix:semicolon
id|skb-&gt;protocol
op_assign
id|eth_type_trans
c_func
(paren
id|skb
comma
id|dev
)paren
suffix:semicolon
id|netif_rx
c_func
(paren
id|skb
)paren
suffix:semicolon
id|outw
c_func
(paren
id|RxDiscard
comma
id|ioaddr
op_plus
id|EL3_CMD
)paren
suffix:semicolon
multiline_comment|/* Pop top Rx packet. */
id|lp-&gt;stats.rx_packets
op_increment
suffix:semicolon
r_continue
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|el3_debug
)paren
id|printk
c_func
(paren
l_string|&quot;%s: Couldn&squot;t allocate a sk_buff of size %d.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|pkt_len
)paren
suffix:semicolon
)brace
id|lp-&gt;stats.rx_dropped
op_increment
suffix:semicolon
id|outw
c_func
(paren
id|RxDiscard
comma
id|ioaddr
op_plus
id|EL3_CMD
)paren
suffix:semicolon
r_while
c_loop
(paren
id|inw
c_func
(paren
id|ioaddr
op_plus
id|EL3_STATUS
)paren
op_amp
l_int|0x1000
)paren
id|printk
c_func
(paren
l_string|&quot;&t;Waiting for 3c509 to discard packet, status %x.&bslash;n&quot;
comma
id|inw
c_func
(paren
id|ioaddr
op_plus
id|EL3_STATUS
)paren
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#ifdef HAVE_MULTICAST
multiline_comment|/* Set or clear the multicast filter for this adaptor.&n;   num_addrs == -1&t;&t;Promiscuous mode, receive all packets&n;   num_addrs == 0&t;&t;Normal mode, clear multicast list&n;   num_addrs &gt; 0&t;&t;Multicast mode, receive normal and MC packets, and do&n;&t;&t;&t;&t;&t;&t;best-effort filtering.&n; */
r_static
r_void
DECL|function|set_multicast_list
id|set_multicast_list
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
r_int
id|num_addrs
comma
r_void
op_star
id|addrs
)paren
(brace
r_int
id|ioaddr
op_assign
id|dev-&gt;base_addr
suffix:semicolon
r_if
c_cond
(paren
id|el3_debug
OG
l_int|1
)paren
(brace
r_static
r_int
id|old
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|old
op_ne
id|num_addrs
)paren
(brace
id|old
op_assign
id|num_addrs
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;%s: Setting Rx mode to %d addresses.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|num_addrs
)paren
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|num_addrs
OG
l_int|0
)paren
(brace
id|outw
c_func
(paren
id|SetRxFilter
op_or
id|RxStation
op_or
id|RxMulticast
op_or
id|RxBroadcast
comma
id|ioaddr
op_plus
id|EL3_CMD
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|num_addrs
OL
l_int|0
)paren
(brace
id|outw
c_func
(paren
id|SetRxFilter
op_or
id|RxStation
op_or
id|RxMulticast
op_or
id|RxBroadcast
op_or
id|RxProm
comma
id|ioaddr
op_plus
id|EL3_CMD
)paren
suffix:semicolon
)brace
r_else
id|outw
c_func
(paren
id|SetRxFilter
op_or
id|RxStation
op_or
id|RxBroadcast
comma
id|ioaddr
op_plus
id|EL3_CMD
)paren
suffix:semicolon
)brace
macro_line|#endif
r_static
r_int
DECL|function|el3_close
id|el3_close
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
r_int
id|ioaddr
op_assign
id|dev-&gt;base_addr
suffix:semicolon
r_if
c_cond
(paren
id|el3_debug
OG
l_int|2
)paren
id|printk
c_func
(paren
l_string|&quot;%s: Shutting down ethercard.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|dev-&gt;tbusy
op_assign
l_int|1
suffix:semicolon
id|dev-&gt;start
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Turn off statistics ASAP.  We update lp-&gt;stats below. */
id|outw
c_func
(paren
id|StatsDisable
comma
id|ioaddr
op_plus
id|EL3_CMD
)paren
suffix:semicolon
multiline_comment|/* Disable the receiver and transmitter. */
id|outw
c_func
(paren
id|RxDisable
comma
id|ioaddr
op_plus
id|EL3_CMD
)paren
suffix:semicolon
id|outw
c_func
(paren
id|TxDisable
comma
id|ioaddr
op_plus
id|EL3_CMD
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;if_port
op_eq
l_int|3
)paren
multiline_comment|/* Turn off thinnet power.  Green! */
id|outw
c_func
(paren
id|StopCoax
comma
id|ioaddr
op_plus
id|EL3_CMD
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
id|dev-&gt;if_port
op_eq
l_int|0
)paren
(brace
multiline_comment|/* Disable link beat and jabber, if_port may change ere next open(). */
id|EL3WINDOW
c_func
(paren
l_int|4
)paren
suffix:semicolon
id|outw
c_func
(paren
id|inw
c_func
(paren
id|ioaddr
op_plus
id|WN4_MEDIA
)paren
op_amp
op_complement
id|MEDIA_TP
comma
id|ioaddr
op_plus
id|WN4_MEDIA
)paren
suffix:semicolon
)brace
id|free_irq
c_func
(paren
id|dev-&gt;irq
)paren
suffix:semicolon
multiline_comment|/* Switching back to window 0 disables the IRQ. */
id|EL3WINDOW
c_func
(paren
l_int|0
)paren
suffix:semicolon
multiline_comment|/* But we explicitly zero the IRQ line select anyway. */
id|outw
c_func
(paren
l_int|0x0f00
comma
id|ioaddr
op_plus
id|WN0_IRQ
)paren
suffix:semicolon
id|irq2dev_map
(braket
id|dev-&gt;irq
)braket
op_assign
l_int|0
suffix:semicolon
id|update_stats
c_func
(paren
id|ioaddr
comma
id|dev
)paren
suffix:semicolon
macro_line|#ifdef MODULE
id|MOD_DEC_USE_COUNT
suffix:semicolon
macro_line|#endif
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#ifdef MODULE
DECL|variable|kernel_version
r_char
id|kernel_version
(braket
)braket
op_assign
id|UTS_RELEASE
suffix:semicolon
DECL|variable|devicename
r_static
r_char
id|devicename
(braket
l_int|9
)braket
op_assign
(brace
l_int|0
comma
)brace
suffix:semicolon
DECL|variable|dev_3c509
r_static
r_struct
id|device
id|dev_3c509
op_assign
(brace
id|devicename
comma
multiline_comment|/* device name is inserted by linux/drivers/net/net_init.c */
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|NULL
comma
id|el3_probe
)brace
suffix:semicolon
DECL|variable|io
r_int
id|io
op_assign
l_int|0
suffix:semicolon
DECL|variable|irq
r_int
id|irq
op_assign
l_int|0
suffix:semicolon
r_int
DECL|function|init_module
id|init_module
c_func
(paren
r_void
)paren
(brace
id|dev_3c509.base_addr
op_assign
id|io
suffix:semicolon
id|dev_3c509.irq
op_assign
id|irq
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|EISA_bus
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;3c509: WARNING! Module load-time probing works reliably only for EISA-bus!&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|register_netdev
c_func
(paren
op_amp
id|dev_3c509
)paren
op_ne
l_int|0
)paren
r_return
op_minus
id|EIO
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_void
DECL|function|cleanup_module
id|cleanup_module
c_func
(paren
r_void
)paren
(brace
r_if
c_cond
(paren
id|MOD_IN_USE
)paren
id|printk
c_func
(paren
l_string|&quot;3c509: device busy, remove delayed&bslash;n&quot;
)paren
suffix:semicolon
r_else
(brace
id|unregister_netdev
c_func
(paren
op_amp
id|dev_3c509
)paren
suffix:semicolon
id|kfree_s
c_func
(paren
id|dev_3c509.priv
comma
r_sizeof
(paren
r_struct
id|el3_private
)paren
)paren
suffix:semicolon
id|dev_3c509.priv
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/* If we don&squot;t do this, we can&squot;t re-insmod it later. */
id|release_region
c_func
(paren
id|dev_3c509.base_addr
comma
id|EL3_IO_EXTENT
)paren
suffix:semicolon
)brace
)brace
macro_line|#endif /* MODULE */
"&f;"
multiline_comment|/*&n; * Local variables:&n; *  compile-command: &quot;gcc -D__KERNEL__ -I/usr/src/linux/net/inet -Wall -Wstrict-prototypes -O6 -m486 -c 3c509.c&quot;&n; *  version-control: t&n; *  kept-new-versions: 5&n; *  tab-width: 4&n; * End:&n; */
eof
