multiline_comment|/* $Id: wic.c,v 1.0 1995/02/11 10:26:05 hayes Exp $ */
multiline_comment|/* WIC: A parallel port &quot;network&quot; driver for Linux. */
multiline_comment|/* based on the plip network driver */
DECL|variable|version
r_char
op_star
id|version
op_assign
l_string|&quot;NET3 WIC version 0.9 hayes@netplumbing.com&quot;
suffix:semicolon
multiline_comment|/*&n;  Sources:&n;&t;Ideas and protocols came from Russ Nelson&squot;s &lt;nelson@crynwr.com&gt;&n;&t;&quot;parallel.asm&quot; parallel port packet driver and from the plip.c&n;&t;parallel networking linux driver from the 1.2.13 Linux&n;&t;distribution.&n;&n;  The packet is encapsulated as if it were ethernet.&n;&n;*/
macro_line|#ifdef MODULE
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/version.h&gt;
macro_line|#else
DECL|macro|MOD_INC_USE_COUNT
mdefine_line|#define MOD_INC_USE_COUNT
DECL|macro|MOD_DEC_USE_COUNT
mdefine_line|#define MOD_DEC_USE_COUNT
macro_line|#endif
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/fcntl.h&gt;
macro_line|#include &lt;linux/interrupt.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/ptrace.h&gt;
macro_line|#include &lt;linux/if_ether.h&gt;
macro_line|#include &lt;asm/system.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;linux/in.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;linux/lp.h&gt;
macro_line|#include &lt;linux/netdevice.h&gt;
macro_line|#include &lt;linux/etherdevice.h&gt;
macro_line|#include &lt;linux/skbuff.h&gt;
macro_line|#include &lt;linux/if_wic.h&gt;
macro_line|#include &lt;linux/tqueue.h&gt;
macro_line|#include &lt;linux/ioport.h&gt;
macro_line|#include &lt;asm/bitops.h&gt;
macro_line|#include &lt;asm/irq.h&gt;
macro_line|#include &lt;asm/byteorder.h&gt;
macro_line|#include &lt;string.h&gt;
DECL|macro|NET_DEBUG
mdefine_line|#define NET_DEBUG 1
multiline_comment|/* Use 0 for production, 1 for verification, &gt;2 for debug */
macro_line|#ifndef NET_DEBUG
DECL|macro|NET_DEBUG
mdefine_line|#define NET_DEBUG 1
macro_line|#endif
DECL|variable|net_debug
r_int
r_int
id|net_debug
op_assign
id|NET_DEBUG
suffix:semicolon
multiline_comment|/* Connection time out = WIC_TRIGGER_WAIT * WIC_DELAY_UNIT usec */
DECL|macro|WIC_TRIGGER_WAIT
mdefine_line|#define WIC_TRIGGER_WAIT&t; 500
multiline_comment|/* Nibble time out = WIC_NIBBLE_WAIT * WIC_DELAY_UNIT usec */
DECL|macro|WIC_NIBBLE_WAIT
mdefine_line|#define WIC_NIBBLE_WAIT        3000
DECL|macro|PAR_DATA
mdefine_line|#define PAR_DATA(dev)&t;&t;((dev)-&gt;base_addr+0)
DECL|macro|PAR_STATUS
mdefine_line|#define PAR_STATUS(dev)&t;&t;((dev)-&gt;base_addr+1)
DECL|macro|PAR_CONTROL
mdefine_line|#define PAR_CONTROL(dev)&t;((dev)-&gt;base_addr+2)
multiline_comment|/* Bottom halfs */
r_void
id|wic_kick_bh
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
suffix:semicolon
r_void
id|wic_bh
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
suffix:semicolon
multiline_comment|/* Interrupt handler */
r_void
id|wic_interrupt
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_ptr
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
suffix:semicolon
multiline_comment|/* Functions for DEV methods */
r_int
id|wic_rebuild_header
c_func
(paren
r_void
op_star
id|buff
comma
r_struct
id|device
op_star
id|dev
comma
r_int
r_int
id|raddr
comma
r_struct
id|sk_buff
op_star
id|skb
)paren
suffix:semicolon
r_int
id|wic_tx_packet
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|device
op_star
id|dev
)paren
suffix:semicolon
r_int
id|wic_open
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
suffix:semicolon
r_int
id|wic_close
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
suffix:semicolon
r_struct
id|enet_statistics
op_star
id|wic_get_stats
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
suffix:semicolon
r_int
id|wic_config
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
r_struct
id|ifmap
op_star
id|map
)paren
suffix:semicolon
r_int
id|wic_ioctl
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
r_struct
id|ifreq
op_star
id|ifr
comma
r_int
id|cmd
)paren
suffix:semicolon
r_int
id|send_cmd
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
r_int
r_char
op_star
id|cmd
comma
r_char
id|len
)paren
suffix:semicolon
r_int
id|recv_cmd_resp
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
r_int
r_char
op_star
id|cmd
)paren
suffix:semicolon
r_int
id|send_byte
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
r_int
r_char
id|c
)paren
suffix:semicolon
r_int
id|get_byte
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
r_int
r_char
op_star
id|c
)paren
suffix:semicolon
r_int
id|ack_resp
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
suffix:semicolon
r_int
id|check_bfr
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
suffix:semicolon
r_void
id|wic_reset
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
suffix:semicolon
r_void
id|wic_set_multicast_list
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
r_int
id|num_addrs
comma
r_void
op_star
id|addrs
)paren
suffix:semicolon
DECL|macro|LOOPCNT
mdefine_line|#define LOOPCNT 30000&t;
DECL|variable|tog
r_int
r_char
id|tog
op_assign
l_int|3
suffix:semicolon
DECL|variable|save
r_int
r_char
id|save
op_assign
l_int|0
suffix:semicolon
DECL|enum|wic_connection_state
r_enum
id|wic_connection_state
(brace
DECL|enumerator|WIC_CN_NONE
id|WIC_CN_NONE
op_assign
l_int|0
comma
DECL|enumerator|WIC_CN_RECEIVE
id|WIC_CN_RECEIVE
comma
DECL|enumerator|WIC_CN_SEND
id|WIC_CN_SEND
comma
DECL|enumerator|WIC_CN_CLOSING
id|WIC_CN_CLOSING
comma
DECL|enumerator|WIC_CN_ERROR
id|WIC_CN_ERROR
)brace
suffix:semicolon
DECL|enum|wic_packet_state
r_enum
id|wic_packet_state
(brace
DECL|enumerator|WIC_PK_DONE
id|WIC_PK_DONE
op_assign
l_int|0
comma
DECL|enumerator|WIC_PK_TRIGGER
id|WIC_PK_TRIGGER
comma
DECL|enumerator|WIC_PK_LENGTH_LSB
id|WIC_PK_LENGTH_LSB
comma
DECL|enumerator|WIC_PK_LENGTH_MSB
id|WIC_PK_LENGTH_MSB
comma
DECL|enumerator|WIC_PK_DATA
id|WIC_PK_DATA
comma
DECL|enumerator|WIC_PK_CHECKSUM
id|WIC_PK_CHECKSUM
)brace
suffix:semicolon
DECL|enum|wic_nibble_state
r_enum
id|wic_nibble_state
(brace
DECL|enumerator|WIC_NB_BEGIN
id|WIC_NB_BEGIN
comma
DECL|enumerator|WIC_NB_1
id|WIC_NB_1
comma
DECL|enumerator|WIC_NB_2
id|WIC_NB_2
comma
)brace
suffix:semicolon
DECL|struct|wic_local
r_struct
id|wic_local
(brace
DECL|member|state
r_enum
id|wic_packet_state
id|state
suffix:semicolon
DECL|member|nibble
r_enum
id|wic_nibble_state
id|nibble
suffix:semicolon
r_union
(brace
r_struct
(brace
macro_line|#if defined(LITTLE_ENDIAN)
DECL|member|lsb
r_int
r_char
id|lsb
suffix:semicolon
DECL|member|msb
r_int
r_char
id|msb
suffix:semicolon
macro_line|#elif defined(BIG_ENDIAN)
r_int
r_char
id|msb
suffix:semicolon
r_int
r_char
id|lsb
suffix:semicolon
macro_line|#else
macro_line|#error&t;&quot;Please fix the endianness defines in &lt;asm/byteorder.h&gt;&quot;
macro_line|#endif&t;&t;&t;&t;&t;&t;
DECL|member|b
)brace
id|b
suffix:semicolon
DECL|member|h
r_int
r_int
id|h
suffix:semicolon
DECL|member|length
)brace
id|length
suffix:semicolon
DECL|member|byte
r_int
r_int
id|byte
suffix:semicolon
DECL|member|checksum
r_int
r_char
id|checksum
suffix:semicolon
DECL|member|data
r_int
r_char
id|data
suffix:semicolon
DECL|member|skb
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
)brace
suffix:semicolon
DECL|struct|net_local
r_struct
id|net_local
(brace
DECL|member|enet_stats
r_struct
id|enet_statistics
id|enet_stats
suffix:semicolon
DECL|member|immediate
r_struct
id|tq_struct
id|immediate
suffix:semicolon
DECL|member|deferred
r_struct
id|tq_struct
id|deferred
suffix:semicolon
DECL|member|snd_data
r_struct
id|wic_local
id|snd_data
suffix:semicolon
DECL|member|rcv_data
r_struct
id|wic_local
id|rcv_data
suffix:semicolon
DECL|member|trigger
r_int
r_int
id|trigger
suffix:semicolon
DECL|member|nibble
r_int
r_int
id|nibble
suffix:semicolon
DECL|member|connection
r_enum
id|wic_connection_state
id|connection
suffix:semicolon
DECL|member|timeout_count
r_int
r_int
id|timeout_count
suffix:semicolon
DECL|member|is_deferred
r_char
id|is_deferred
suffix:semicolon
DECL|member|orig_rebuild_header
r_int
(paren
op_star
id|orig_rebuild_header
)paren
(paren
r_void
op_star
id|eth
comma
r_struct
id|device
op_star
id|dev
comma
r_int
r_int
id|raddr
comma
r_struct
id|sk_buff
op_star
id|skb
)paren
suffix:semicolon
)brace
suffix:semicolon
multiline_comment|/* Entry point of WIC driver.&n;   Probe the hardware, and register/initialize the driver. */
r_int
DECL|function|wic_init
id|wic_init
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
r_struct
id|net_local
op_star
id|nl
suffix:semicolon
r_struct
id|wicconf
id|wc
suffix:semicolon
r_int
id|i
suffix:semicolon
multiline_comment|/* Check region before the probe */
r_if
c_cond
(paren
id|check_region
c_func
(paren
id|PAR_DATA
c_func
(paren
id|dev
)paren
comma
l_int|3
)paren
OL
l_int|0
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
multiline_comment|/* Check that there is something at base_addr. */
id|outb
c_func
(paren
l_int|0
comma
id|PAR_DATA
c_func
(paren
id|dev
)paren
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|1000
)paren
suffix:semicolon
r_if
c_cond
(paren
id|inb
c_func
(paren
id|PAR_DATA
c_func
(paren
id|dev
)paren
)paren
op_ne
l_int|0
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;%s&bslash;n&quot;
comma
id|version
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;%s: Parallel port at %#3lx, &quot;
comma
id|dev-&gt;name
comma
id|dev-&gt;base_addr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;irq
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;using assigned IRQ %d.&bslash;n&quot;
comma
id|dev-&gt;irq
)paren
suffix:semicolon
)brace
r_else
(brace
r_int
id|irq
op_assign
l_int|0
suffix:semicolon
macro_line|#ifdef MODULE
multiline_comment|/* dev-&gt;irq==0 means autoprobe, but we don&squot;t try to do so&n;&t;&t;   with module.  We can change it by ifconfig */
macro_line|#else
r_int
r_int
id|irqs
op_assign
id|probe_irq_on
c_func
(paren
)paren
suffix:semicolon
id|outb
c_func
(paren
l_int|0x00
comma
id|PAR_CONTROL
c_func
(paren
id|dev
)paren
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|1000
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|1000
)paren
suffix:semicolon
id|irq
op_assign
id|probe_irq_off
c_func
(paren
id|irqs
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|irq
OG
l_int|0
)paren
(brace
id|dev-&gt;irq
op_assign
id|irq
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;using probed IRQ %d.&bslash;n&quot;
comma
id|dev-&gt;irq
)paren
suffix:semicolon
)brace
r_else
id|printk
c_func
(paren
l_string|&quot;failed to detect IRQ(%d) --&quot;
l_string|&quot; Please set IRQ by ifconfig.&bslash;n&quot;
comma
id|irq
)paren
suffix:semicolon
)brace
id|request_region
c_func
(paren
id|PAR_DATA
c_func
(paren
id|dev
)paren
comma
l_int|3
comma
id|dev-&gt;name
)paren
suffix:semicolon
multiline_comment|/* Fill in the generic fields of the device structure. */
id|ether_setup
c_func
(paren
id|dev
)paren
suffix:semicolon
multiline_comment|/* Then, override parts of it */
id|dev-&gt;hard_start_xmit
op_assign
id|wic_tx_packet
suffix:semicolon
id|dev-&gt;open
op_assign
id|wic_open
suffix:semicolon
id|dev-&gt;stop
op_assign
id|wic_close
suffix:semicolon
id|dev-&gt;get_stats
op_assign
id|wic_get_stats
suffix:semicolon
id|dev-&gt;set_config
op_assign
id|wic_config
suffix:semicolon
id|dev-&gt;do_ioctl
op_assign
id|wic_ioctl
suffix:semicolon
id|dev-&gt;mtu
op_assign
l_int|1514
suffix:semicolon
id|dev-&gt;set_multicast_list
op_assign
id|wic_set_multicast_list
suffix:semicolon
id|dev-&gt;flags
op_assign
id|IFF_BROADCAST
op_or
id|IFF_RUNNING
op_or
id|IFF_NOTRAILERS
suffix:semicolon
multiline_comment|/* get the MAC address from the controller */
id|wc.len
op_assign
l_int|1
suffix:semicolon
id|wc.pcmd
op_assign
id|WIC_GETNET
suffix:semicolon
id|check_bfr
c_func
(paren
id|dev
)paren
suffix:semicolon
id|send_cmd
c_func
(paren
id|dev
comma
(paren
r_int
r_char
op_star
)paren
op_amp
id|wc
comma
l_int|1
)paren
suffix:semicolon
id|wc.len
op_assign
id|recv_cmd_resp
c_func
(paren
id|dev
comma
(paren
r_int
r_char
op_star
)paren
op_amp
id|wc.data
)paren
suffix:semicolon
r_while
c_loop
(paren
(paren
id|wc.len
op_eq
l_int|1
)paren
op_logical_and
(paren
id|wc.data
(braket
l_int|0
)braket
op_eq
l_int|0x7
)paren
)paren
multiline_comment|/* controller int */
id|wc.len
op_assign
id|recv_cmd_resp
c_func
(paren
id|dev
comma
(paren
r_int
r_char
op_star
)paren
op_amp
id|wc.data
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;%s:MAC address: &quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|ETH_ALEN
suffix:semicolon
id|i
op_increment
)paren
(brace
id|dev-&gt;dev_addr
(braket
id|i
)braket
op_assign
id|wc.data
(braket
id|i
)braket
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;%2x &quot;
comma
id|dev-&gt;dev_addr
(braket
id|i
)braket
)paren
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* Set the private structure */
id|dev-&gt;priv
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|net_local
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;priv
op_eq
l_int|NULL
)paren
r_return
id|EAGAIN
suffix:semicolon
id|memset
c_func
(paren
id|dev-&gt;priv
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|net_local
)paren
)paren
suffix:semicolon
id|nl
op_assign
(paren
r_struct
id|net_local
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|nl-&gt;orig_rebuild_header
op_assign
id|dev-&gt;rebuild_header
suffix:semicolon
id|dev-&gt;rebuild_header
op_assign
id|wic_rebuild_header
suffix:semicolon
multiline_comment|/* Initialize constants */
id|nl-&gt;trigger
op_assign
id|WIC_TRIGGER_WAIT
suffix:semicolon
id|nl-&gt;nibble
op_assign
id|WIC_NIBBLE_WAIT
suffix:semicolon
multiline_comment|/* Initialize task queue structures */
id|nl-&gt;immediate.next
op_assign
op_amp
id|tq_last
suffix:semicolon
id|nl-&gt;immediate.sync
op_assign
l_int|0
suffix:semicolon
id|nl-&gt;immediate.routine
op_assign
(paren
r_void
op_star
)paren
(paren
r_void
op_star
)paren
id|wic_bh
suffix:semicolon
id|nl-&gt;immediate.data
op_assign
id|dev
suffix:semicolon
id|nl-&gt;deferred.next
op_assign
op_amp
id|tq_last
suffix:semicolon
id|nl-&gt;deferred.sync
op_assign
l_int|0
suffix:semicolon
id|nl-&gt;deferred.routine
op_assign
(paren
r_void
op_star
)paren
(paren
r_void
op_star
)paren
id|wic_kick_bh
suffix:semicolon
id|nl-&gt;deferred.data
op_assign
id|dev
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Bottom half handler for the delayed request.&n;   This routine is kicked by do_timer().&n;   Request `wic_bh&squot; to be invoked. */
r_void
DECL|function|wic_kick_bh
id|wic_kick_bh
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
r_struct
id|net_local
op_star
id|nl
op_assign
(paren
r_struct
id|net_local
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_if
c_cond
(paren
id|nl-&gt;is_deferred
)paren
(brace
id|queue_task
c_func
(paren
op_amp
id|nl-&gt;immediate
comma
op_amp
id|tq_immediate
)paren
suffix:semicolon
id|mark_bh
c_func
(paren
id|IMMEDIATE_BH
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* Forward declarations of internal routines */
r_int
id|wic_none
c_func
(paren
r_struct
id|device
op_star
comma
r_struct
id|net_local
op_star
comma
r_struct
id|wic_local
op_star
comma
r_struct
id|wic_local
op_star
)paren
suffix:semicolon
r_int
id|wic_receive_packet
c_func
(paren
r_struct
id|device
op_star
comma
r_struct
id|net_local
op_star
comma
r_struct
id|wic_local
op_star
comma
r_struct
id|wic_local
op_star
)paren
suffix:semicolon
r_int
id|wic_send_packet
c_func
(paren
r_struct
id|device
op_star
comma
r_struct
id|net_local
op_star
comma
r_struct
id|wic_local
op_star
comma
r_struct
id|wic_local
op_star
)paren
suffix:semicolon
r_int
id|wic_connection_close
c_func
(paren
r_struct
id|device
op_star
comma
r_struct
id|net_local
op_star
comma
r_struct
id|wic_local
op_star
comma
r_struct
id|wic_local
op_star
)paren
suffix:semicolon
r_int
id|wic_error
c_func
(paren
r_struct
id|device
op_star
comma
r_struct
id|net_local
op_star
comma
r_struct
id|wic_local
op_star
comma
r_struct
id|wic_local
op_star
)paren
suffix:semicolon
r_int
id|wic_bh_timeout_error
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
r_struct
id|net_local
op_star
id|nl
comma
r_struct
id|wic_local
op_star
id|snd
comma
r_struct
id|wic_local
op_star
id|rcv
comma
r_int
id|error
)paren
suffix:semicolon
DECL|macro|OK
mdefine_line|#define OK        0
DECL|macro|TIMEOUT
mdefine_line|#define TIMEOUT   1
DECL|macro|ERROR
mdefine_line|#define ERROR     2
DECL|typedef|wic_func
r_typedef
r_int
(paren
op_star
id|wic_func
)paren
(paren
r_struct
id|device
op_star
id|dev
comma
r_struct
id|net_local
op_star
id|nl
comma
r_struct
id|wic_local
op_star
id|snd
comma
r_struct
id|wic_local
op_star
id|rcv
)paren
suffix:semicolon
DECL|variable|connection_state_table
id|wic_func
id|connection_state_table
(braket
)braket
op_assign
(brace
id|wic_none
comma
id|wic_receive_packet
comma
id|wic_send_packet
comma
id|wic_connection_close
comma
id|wic_error
)brace
suffix:semicolon
r_void
DECL|function|wic_set_multicast_list
id|wic_set_multicast_list
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
r_int
id|num_addrs
comma
r_void
op_star
id|addrs
)paren
(brace
r_struct
id|wicconf
id|wc
suffix:semicolon
r_struct
id|wic_net
op_star
id|wn
suffix:semicolon
id|disable_irq
c_func
(paren
id|dev-&gt;irq
)paren
suffix:semicolon
id|save
op_and_assign
l_int|0xef
suffix:semicolon
multiline_comment|/* disable */
id|outb
c_func
(paren
id|save
comma
id|PAR_CONTROL
c_func
(paren
id|dev
)paren
)paren
suffix:semicolon
id|wc.len
op_assign
l_int|1
suffix:semicolon
id|wc.pcmd
op_assign
id|WIC_GETNET
suffix:semicolon
id|check_bfr
c_func
(paren
id|dev
)paren
suffix:semicolon
id|tog
op_assign
l_int|3
suffix:semicolon
id|send_cmd
c_func
(paren
id|dev
comma
(paren
r_int
r_char
op_star
)paren
op_amp
id|wc
comma
l_int|1
)paren
suffix:semicolon
id|wc.len
op_assign
id|recv_cmd_resp
c_func
(paren
id|dev
comma
(paren
r_int
r_char
op_star
)paren
op_amp
id|wc.data
)paren
suffix:semicolon
r_while
c_loop
(paren
(paren
id|wc.len
op_eq
l_int|1
)paren
op_logical_and
(paren
id|wc.data
(braket
l_int|0
)braket
op_eq
l_int|0x7
)paren
)paren
multiline_comment|/* controller int */
id|wc.len
op_assign
id|recv_cmd_resp
c_func
(paren
id|dev
comma
(paren
r_int
r_char
op_star
)paren
op_amp
id|wc.data
)paren
suffix:semicolon
id|wn
op_assign
(paren
r_struct
id|wic_net
op_star
)paren
op_amp
id|wc.data
suffix:semicolon
r_switch
c_cond
(paren
id|num_addrs
)paren
(brace
r_case
op_minus
l_int|1
suffix:colon
multiline_comment|/* promiscuous mode */
id|wn-&gt;mode
op_or_assign
(paren
id|NET_MODE_ME
op_or
id|NET_MODE_BCAST
op_or
id|NET_MODE_MCAST
op_or
id|NET_MODE_PROM
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;%s: Setting promiscuous mode&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
multiline_comment|/* my address and bcast addresses */
id|wn-&gt;mode
op_and_assign
op_complement
(paren
id|NET_MODE_PROM
op_or
id|NET_MODE_MCAST
)paren
suffix:semicolon
id|wn-&gt;mode
op_or_assign
(paren
id|NET_MODE_ME
op_or
id|NET_MODE_BCAST
)paren
suffix:semicolon
multiline_comment|/* break; */
)brace
id|wc.len
op_assign
l_int|23
suffix:semicolon
id|wc.pcmd
op_assign
id|WIC_SETNET
suffix:semicolon
id|check_bfr
c_func
(paren
id|dev
)paren
suffix:semicolon
id|tog
op_assign
l_int|3
suffix:semicolon
id|send_cmd
c_func
(paren
id|dev
comma
(paren
r_int
r_char
op_star
)paren
op_amp
id|wc
comma
id|wc.len
)paren
suffix:semicolon
id|save
op_or_assign
l_int|0x10
suffix:semicolon
multiline_comment|/* enable */
id|outb
c_func
(paren
id|save
comma
id|PAR_CONTROL
c_func
(paren
id|dev
)paren
)paren
suffix:semicolon
id|enable_irq
c_func
(paren
id|dev-&gt;irq
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/* Bottom half handler of WIC. */
r_void
DECL|function|wic_bh
id|wic_bh
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
r_struct
id|net_local
op_star
id|nl
op_assign
(paren
r_struct
id|net_local
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_struct
id|wic_local
op_star
id|snd
op_assign
op_amp
id|nl-&gt;snd_data
suffix:semicolon
r_struct
id|wic_local
op_star
id|rcv
op_assign
op_amp
id|nl-&gt;rcv_data
suffix:semicolon
id|wic_func
id|f
suffix:semicolon
r_int
id|r
suffix:semicolon
id|nl-&gt;is_deferred
op_assign
l_int|0
suffix:semicolon
id|f
op_assign
id|connection_state_table
(braket
id|nl-&gt;connection
)braket
suffix:semicolon
r_if
c_cond
(paren
(paren
id|r
op_assign
(paren
op_star
id|f
)paren
(paren
id|dev
comma
id|nl
comma
id|snd
comma
id|rcv
)paren
)paren
op_ne
id|OK
op_logical_and
(paren
id|r
op_assign
id|wic_bh_timeout_error
c_func
(paren
id|dev
comma
id|nl
comma
id|snd
comma
id|rcv
comma
id|r
)paren
)paren
op_ne
id|OK
)paren
(brace
id|nl-&gt;is_deferred
op_assign
l_int|1
suffix:semicolon
id|queue_task
c_func
(paren
op_amp
id|nl-&gt;deferred
comma
op_amp
id|tq_timer
)paren
suffix:semicolon
)brace
)brace
r_int
DECL|function|wic_bh_timeout_error
id|wic_bh_timeout_error
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
r_struct
id|net_local
op_star
id|nl
comma
r_struct
id|wic_local
op_star
id|snd
comma
r_struct
id|wic_local
op_star
id|rcv
comma
r_int
id|error
)paren
(brace
r_int
r_char
id|c0
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|nl-&gt;connection
op_eq
id|WIC_CN_SEND
)paren
(brace
r_if
c_cond
(paren
id|error
op_ne
id|ERROR
)paren
(brace
multiline_comment|/* Timeout */
id|nl-&gt;timeout_count
op_increment
suffix:semicolon
r_if
c_cond
(paren
(paren
id|snd-&gt;state
op_eq
id|WIC_PK_TRIGGER
op_logical_and
id|nl-&gt;timeout_count
op_le
l_int|10
)paren
op_logical_or
id|nl-&gt;timeout_count
op_le
l_int|3
)paren
(brace
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
multiline_comment|/* Try again later */
r_return
id|TIMEOUT
suffix:semicolon
)brace
id|c0
op_assign
id|inb
c_func
(paren
id|PAR_STATUS
c_func
(paren
id|dev
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;%s: transmit timeout(%d,%02x)&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|snd-&gt;state
comma
id|c0
)paren
suffix:semicolon
)brace
id|nl-&gt;enet_stats.tx_errors
op_increment
suffix:semicolon
id|nl-&gt;enet_stats.tx_aborted_errors
op_increment
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|nl-&gt;connection
op_eq
id|WIC_CN_RECEIVE
)paren
(brace
r_if
c_cond
(paren
id|rcv-&gt;state
op_eq
id|WIC_PK_TRIGGER
)paren
(brace
multiline_comment|/* Transmission was interrupted. */
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
id|OK
suffix:semicolon
)brace
r_if
c_cond
(paren
id|error
op_ne
id|ERROR
)paren
(brace
multiline_comment|/* Timeout */
r_if
c_cond
(paren
op_increment
id|nl-&gt;timeout_count
op_le
l_int|3
)paren
(brace
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
multiline_comment|/* Try again later */
r_return
id|TIMEOUT
suffix:semicolon
)brace
id|c0
op_assign
id|inb
c_func
(paren
id|PAR_STATUS
c_func
(paren
id|dev
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;%s: receive timeout(%d,%02x)&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|rcv-&gt;state
comma
id|c0
)paren
suffix:semicolon
)brace
id|nl-&gt;enet_stats.rx_dropped
op_increment
suffix:semicolon
)brace
id|rcv-&gt;state
op_assign
id|WIC_PK_DONE
suffix:semicolon
r_if
c_cond
(paren
id|rcv-&gt;skb
)paren
(brace
id|rcv-&gt;skb-&gt;free
op_assign
l_int|1
suffix:semicolon
id|kfree_skb
c_func
(paren
id|rcv-&gt;skb
comma
id|FREE_READ
)paren
suffix:semicolon
id|rcv-&gt;skb
op_assign
l_int|NULL
suffix:semicolon
)brace
id|snd-&gt;state
op_assign
id|WIC_PK_DONE
suffix:semicolon
r_if
c_cond
(paren
id|snd-&gt;skb
)paren
(brace
id|snd-&gt;skb-&gt;free
op_assign
l_int|1
suffix:semicolon
id|dev_kfree_skb
c_func
(paren
id|snd-&gt;skb
comma
id|FREE_WRITE
)paren
suffix:semicolon
id|snd-&gt;skb
op_assign
l_int|NULL
suffix:semicolon
)brace
macro_line|#if (0)
id|disable_irq
c_func
(paren
id|dev-&gt;irq
)paren
suffix:semicolon
id|save
op_and_assign
l_int|0xef
suffix:semicolon
multiline_comment|/* disable */
id|outb
c_func
(paren
id|save
comma
id|PAR_CONTROL
c_func
(paren
id|dev
)paren
)paren
suffix:semicolon
id|dev-&gt;tbusy
op_assign
l_int|1
suffix:semicolon
id|outb
c_func
(paren
l_int|0x00
comma
id|PAR_DATA
c_func
(paren
id|dev
)paren
)paren
suffix:semicolon
macro_line|#endif /* (0) */
id|nl-&gt;connection
op_assign
id|WIC_CN_ERROR
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
id|TIMEOUT
suffix:semicolon
)brace
r_int
DECL|function|wic_none
id|wic_none
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
r_struct
id|net_local
op_star
id|nl
comma
r_struct
id|wic_local
op_star
id|snd
comma
r_struct
id|wic_local
op_star
id|rcv
)paren
(brace
r_return
id|OK
suffix:semicolon
)brace
multiline_comment|/* WIC_RECEIVE --- receive a byte(two nibbles)&n;   Returns OK on success, TIMEOUT on timeout */
r_inline
r_int
DECL|function|wic_receive
id|wic_receive
c_func
(paren
r_int
r_int
id|nibble_timeout
comma
r_int
r_int
id|status_addr
comma
r_enum
id|wic_nibble_state
op_star
id|ns_p
comma
r_int
r_char
op_star
id|data_p
)paren
(brace
r_int
r_int
id|cx
suffix:semicolon
id|cx
op_assign
id|LOOPCNT
suffix:semicolon
r_while
c_loop
(paren
(paren
id|inb
c_func
(paren
id|status_addr
)paren
op_amp
l_int|0x08
)paren
op_ne
(paren
(paren
id|tog
op_lshift
l_int|3
)paren
op_amp
l_int|0x08
)paren
)paren
(brace
r_if
c_cond
(paren
op_decrement
id|cx
op_eq
l_int|0
)paren
(brace
r_return
id|TIMEOUT
suffix:semicolon
)brace
)brace
op_star
id|data_p
op_assign
id|inb
c_func
(paren
id|status_addr
op_minus
l_int|1
)paren
suffix:semicolon
id|tog
op_xor_assign
l_int|0x01
suffix:semicolon
id|outb
c_func
(paren
id|tog
op_or
id|save
comma
id|status_addr
op_plus
l_int|1
)paren
suffix:semicolon
r_return
id|OK
suffix:semicolon
)brace
multiline_comment|/* WIC_RECEIVE_PACKET --- receive a packet */
r_int
DECL|function|wic_receive_packet
id|wic_receive_packet
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
r_struct
id|net_local
op_star
id|nl
comma
r_struct
id|wic_local
op_star
id|snd
comma
r_struct
id|wic_local
op_star
id|rcv
)paren
(brace
r_int
r_int
id|status_addr
op_assign
id|PAR_STATUS
c_func
(paren
id|dev
)paren
suffix:semicolon
r_int
r_int
id|nibble_timeout
op_assign
id|nl-&gt;nibble
suffix:semicolon
r_int
r_char
op_star
id|lbuf
suffix:semicolon
r_int
r_char
id|junk
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|rcv-&gt;state
)paren
(brace
r_case
id|WIC_PK_TRIGGER
suffix:colon
id|disable_irq
c_func
(paren
id|dev-&gt;irq
)paren
suffix:semicolon
id|save
op_and_assign
l_int|0xef
suffix:semicolon
multiline_comment|/* disable */
id|outb
c_func
(paren
id|save
comma
id|PAR_CONTROL
c_func
(paren
id|dev
)paren
)paren
suffix:semicolon
id|dev-&gt;interrupt
op_assign
l_int|0
suffix:semicolon
id|tog
op_and_assign
l_int|0xfe
suffix:semicolon
id|ack_resp
c_func
(paren
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|net_debug
OG
l_int|2
)paren
id|printk
c_func
(paren
l_string|&quot;%s: receive start&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|rcv-&gt;state
op_assign
id|WIC_PK_LENGTH_LSB
suffix:semicolon
id|rcv-&gt;nibble
op_assign
id|WIC_NB_BEGIN
suffix:semicolon
r_case
id|WIC_PK_LENGTH_LSB
suffix:colon
r_if
c_cond
(paren
id|net_debug
OG
l_int|2
)paren
id|printk
c_func
(paren
l_string|&quot;%s: WIC_PK_LENGTH_LSB&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_if
c_cond
(paren
id|snd-&gt;state
op_ne
id|WIC_PK_DONE
)paren
(brace
r_if
c_cond
(paren
id|wic_receive
c_func
(paren
id|nl-&gt;trigger
comma
id|status_addr
comma
op_amp
id|rcv-&gt;nibble
comma
op_amp
id|rcv-&gt;length.b.lsb
)paren
)paren
(brace
multiline_comment|/* collision, here dev-&gt;tbusy == 1 */
id|rcv-&gt;state
op_assign
id|WIC_PK_DONE
suffix:semicolon
id|nl-&gt;is_deferred
op_assign
l_int|1
suffix:semicolon
id|nl-&gt;connection
op_assign
id|WIC_CN_SEND
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|queue_task
c_func
(paren
op_amp
id|nl-&gt;deferred
comma
op_amp
id|tq_timer
)paren
suffix:semicolon
id|save
op_or_assign
l_int|0x10
suffix:semicolon
multiline_comment|/* enable */
id|outb
c_func
(paren
id|save
comma
id|PAR_CONTROL
c_func
(paren
id|dev
)paren
)paren
suffix:semicolon
id|enable_irq
c_func
(paren
id|dev-&gt;irq
)paren
suffix:semicolon
r_return
id|OK
suffix:semicolon
)brace
)brace
r_else
(brace
r_if
c_cond
(paren
id|wic_receive
c_func
(paren
id|nibble_timeout
comma
id|status_addr
comma
op_amp
id|rcv-&gt;nibble
comma
op_amp
id|rcv-&gt;length.b.lsb
)paren
)paren
(brace
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
id|TIMEOUT
suffix:semicolon
)brace
)brace
id|rcv-&gt;state
op_assign
id|WIC_PK_LENGTH_MSB
suffix:semicolon
r_case
id|WIC_PK_LENGTH_MSB
suffix:colon
r_if
c_cond
(paren
id|net_debug
OG
l_int|2
)paren
id|printk
c_func
(paren
l_string|&quot;%s: WIC_PK_LENGTH_MSB&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_if
c_cond
(paren
id|wic_receive
c_func
(paren
id|nibble_timeout
comma
id|status_addr
comma
op_amp
id|rcv-&gt;nibble
comma
op_amp
id|rcv-&gt;length.b.msb
)paren
)paren
(brace
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
id|TIMEOUT
suffix:semicolon
)brace
r_if
c_cond
(paren
id|rcv-&gt;length.h
OG
id|dev-&gt;mtu
op_logical_or
id|rcv-&gt;length.h
OL
l_int|8
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%s: bad packet size %d.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|rcv-&gt;length.h
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
id|ERROR
suffix:semicolon
)brace
multiline_comment|/* Malloc up new buffer. */
id|rcv-&gt;skb
op_assign
id|dev_alloc_skb
c_func
(paren
id|rcv-&gt;length.h
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rcv-&gt;skb
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%s: Memory squeeze.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
id|ERROR
suffix:semicolon
)brace
id|skb_put
c_func
(paren
id|rcv-&gt;skb
comma
id|rcv-&gt;length.h
)paren
suffix:semicolon
id|rcv-&gt;skb-&gt;dev
op_assign
id|dev
suffix:semicolon
id|rcv-&gt;state
op_assign
id|WIC_PK_DATA
suffix:semicolon
id|rcv-&gt;byte
op_assign
l_int|0
suffix:semicolon
id|rcv-&gt;checksum
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* sequence numbers */
r_if
c_cond
(paren
id|net_debug
OG
l_int|2
)paren
id|printk
c_func
(paren
l_string|&quot;%s: WIC_PK_SEQ&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_if
c_cond
(paren
id|wic_receive
c_func
(paren
id|nibble_timeout
comma
id|status_addr
comma
op_amp
id|rcv-&gt;nibble
comma
op_amp
id|junk
)paren
)paren
(brace
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
id|TIMEOUT
suffix:semicolon
)brace
r_if
c_cond
(paren
id|wic_receive
c_func
(paren
id|nibble_timeout
comma
id|status_addr
comma
op_amp
id|rcv-&gt;nibble
comma
op_amp
id|junk
)paren
)paren
(brace
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
id|TIMEOUT
suffix:semicolon
)brace
r_case
id|WIC_PK_DATA
suffix:colon
r_if
c_cond
(paren
id|net_debug
OG
l_int|2
)paren
id|printk
c_func
(paren
l_string|&quot;%s: WIC_PK_DATA: length %i&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|rcv-&gt;length.h
)paren
suffix:semicolon
id|lbuf
op_assign
id|rcv-&gt;skb-&gt;data
suffix:semicolon
r_do
(brace
r_if
c_cond
(paren
id|wic_receive
c_func
(paren
id|nibble_timeout
comma
id|status_addr
comma
op_amp
id|rcv-&gt;nibble
comma
op_amp
id|lbuf
(braket
id|rcv-&gt;byte
)braket
)paren
)paren
(brace
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
id|TIMEOUT
suffix:semicolon
)brace
)brace
r_while
c_loop
(paren
op_increment
id|rcv-&gt;byte
OL
(paren
id|rcv-&gt;length.h
op_minus
l_int|4
)paren
)paren
suffix:semicolon
multiline_comment|/* receive pad byte */
r_if
c_cond
(paren
id|rcv-&gt;length.h
op_amp
l_int|0x01
)paren
id|wic_receive
c_func
(paren
id|nibble_timeout
comma
id|status_addr
comma
op_amp
id|rcv-&gt;nibble
comma
op_amp
id|lbuf
(braket
id|rcv-&gt;byte
)braket
)paren
suffix:semicolon
r_do
(brace
id|rcv-&gt;checksum
op_add_assign
id|lbuf
(braket
op_decrement
id|rcv-&gt;byte
)braket
suffix:semicolon
)brace
r_while
c_loop
(paren
id|rcv-&gt;byte
)paren
suffix:semicolon
id|rcv-&gt;state
op_assign
id|WIC_PK_CHECKSUM
suffix:semicolon
r_case
id|WIC_PK_CHECKSUM
suffix:colon
r_if
c_cond
(paren
id|net_debug
OG
l_int|2
)paren
id|printk
c_func
(paren
l_string|&quot;%s: WIC_PK_CHECKSUM&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_if
c_cond
(paren
id|wic_receive
c_func
(paren
id|nibble_timeout
comma
id|status_addr
comma
op_amp
id|rcv-&gt;nibble
comma
op_amp
id|junk
)paren
)paren
(brace
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
id|TIMEOUT
suffix:semicolon
)brace
id|outb
c_func
(paren
l_int|0
comma
id|PAR_DATA
c_func
(paren
id|dev
)paren
)paren
suffix:semicolon
id|rcv-&gt;state
op_assign
id|WIC_PK_DONE
suffix:semicolon
r_case
id|WIC_PK_DONE
suffix:colon
r_if
c_cond
(paren
id|net_debug
OG
l_int|2
)paren
id|printk
c_func
(paren
l_string|&quot;%s: WIC_PK_DONE&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
multiline_comment|/* Inform the upper layer for the arrival of a packet. */
id|netif_rx
c_func
(paren
id|rcv-&gt;skb
)paren
suffix:semicolon
id|nl-&gt;enet_stats.rx_packets
op_increment
suffix:semicolon
id|rcv-&gt;skb
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
id|net_debug
OG
l_int|2
)paren
id|printk
c_func
(paren
l_string|&quot;%s: receive end&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
multiline_comment|/* Close the connection. */
r_if
c_cond
(paren
id|snd-&gt;state
op_ne
id|WIC_PK_DONE
)paren
(brace
id|nl-&gt;connection
op_assign
id|WIC_CN_SEND
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|queue_task
c_func
(paren
op_amp
id|nl-&gt;immediate
comma
op_amp
id|tq_immediate
)paren
suffix:semicolon
id|save
op_or_assign
l_int|0x10
suffix:semicolon
multiline_comment|/* enable */
id|outb
c_func
(paren
id|save
comma
id|PAR_CONTROL
c_func
(paren
id|dev
)paren
)paren
suffix:semicolon
id|enable_irq
c_func
(paren
id|dev-&gt;irq
)paren
suffix:semicolon
r_return
id|OK
suffix:semicolon
)brace
r_else
(brace
id|nl-&gt;connection
op_assign
id|WIC_CN_NONE
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|save
op_or_assign
l_int|0x10
suffix:semicolon
multiline_comment|/* enable */
id|outb
c_func
(paren
id|save
comma
id|PAR_CONTROL
c_func
(paren
id|dev
)paren
)paren
suffix:semicolon
id|enable_irq
c_func
(paren
id|dev-&gt;irq
)paren
suffix:semicolon
r_return
id|OK
suffix:semicolon
)brace
)brace
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
id|OK
suffix:semicolon
)brace
multiline_comment|/* WIC_SEND --- send a byte (two nibbles) &n;   Returns OK on success, TIMEOUT when timeout    */
r_inline
r_int
DECL|function|wic_send
id|wic_send
c_func
(paren
r_int
r_int
id|nibble_timeout
comma
r_int
r_int
id|data_addr
comma
r_enum
id|wic_nibble_state
op_star
id|ns_p
comma
r_int
r_char
id|data
)paren
(brace
r_int
r_int
id|cx
suffix:semicolon
id|cx
op_assign
id|LOOPCNT
suffix:semicolon
r_while
c_loop
(paren
(paren
id|inb
c_func
(paren
id|data_addr
op_plus
l_int|1
)paren
op_amp
l_int|0x80
)paren
op_eq
(paren
(paren
id|tog
op_lshift
l_int|7
)paren
op_amp
l_int|0x80
)paren
)paren
(brace
r_if
c_cond
(paren
op_decrement
id|cx
op_eq
l_int|0
)paren
(brace
r_return
op_minus
id|TIMEOUT
suffix:semicolon
)brace
)brace
id|outb
c_func
(paren
id|data
comma
id|data_addr
)paren
suffix:semicolon
id|outb
c_func
(paren
id|tog
op_or
id|save
comma
id|data_addr
op_plus
l_int|2
)paren
suffix:semicolon
id|tog
op_xor_assign
l_int|0x01
suffix:semicolon
r_return
id|OK
suffix:semicolon
)brace
multiline_comment|/* WIC_SEND_PACKET --- send a packet */
r_int
DECL|function|wic_send_packet
id|wic_send_packet
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
r_struct
id|net_local
op_star
id|nl
comma
r_struct
id|wic_local
op_star
id|snd
comma
r_struct
id|wic_local
op_star
id|rcv
)paren
(brace
r_int
r_int
id|data_addr
op_assign
id|PAR_DATA
c_func
(paren
id|dev
)paren
suffix:semicolon
r_int
r_int
id|nibble_timeout
op_assign
id|nl-&gt;nibble
suffix:semicolon
r_int
r_char
op_star
id|lbuf
suffix:semicolon
r_int
r_int
id|cx
suffix:semicolon
r_int
r_int
id|pad
op_assign
l_int|2
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_if
c_cond
(paren
id|snd-&gt;skb
op_eq
l_int|NULL
op_logical_or
(paren
id|lbuf
op_assign
id|snd-&gt;skb-&gt;data
)paren
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%s: send skb lost&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|snd-&gt;state
op_assign
id|WIC_PK_DONE
suffix:semicolon
id|snd-&gt;skb
op_assign
l_int|NULL
suffix:semicolon
id|save
op_or_assign
l_int|0x10
suffix:semicolon
multiline_comment|/* enable */
id|outb
c_func
(paren
id|save
comma
id|PAR_CONTROL
c_func
(paren
id|dev
)paren
)paren
suffix:semicolon
id|enable_irq
c_func
(paren
id|dev-&gt;irq
)paren
suffix:semicolon
r_return
id|ERROR
suffix:semicolon
)brace
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|snd-&gt;state
)paren
(brace
r_case
id|WIC_PK_TRIGGER
suffix:colon
r_if
c_cond
(paren
id|nl-&gt;connection
op_eq
id|WIC_CN_RECEIVE
)paren
(brace
multiline_comment|/* interrupted */
id|nl-&gt;enet_stats.collisions
op_increment
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|net_debug
OG
l_int|1
)paren
id|printk
c_func
(paren
l_string|&quot;%s: collision.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|save
op_or_assign
l_int|0x10
suffix:semicolon
multiline_comment|/* enable */
id|outb
c_func
(paren
id|save
comma
id|PAR_CONTROL
c_func
(paren
id|dev
)paren
)paren
suffix:semicolon
id|enable_irq
c_func
(paren
id|dev-&gt;irq
)paren
suffix:semicolon
r_return
id|OK
suffix:semicolon
)brace
id|disable_irq
c_func
(paren
id|dev-&gt;irq
)paren
suffix:semicolon
id|save
op_and_assign
l_int|0xef
suffix:semicolon
multiline_comment|/* disable */
id|outb
c_func
(paren
id|save
comma
id|PAR_CONTROL
c_func
(paren
id|dev
)paren
)paren
suffix:semicolon
multiline_comment|/* interrupt controller */
id|tog
op_assign
l_int|3
suffix:semicolon
id|outb
c_func
(paren
l_int|0x06
op_or
id|save
comma
id|PAR_CONTROL
c_func
(paren
id|dev
)paren
)paren
suffix:semicolon
id|cx
op_assign
id|LOOPCNT
suffix:semicolon
r_while
c_loop
(paren
(paren
id|inb
c_func
(paren
id|PAR_STATUS
c_func
(paren
id|dev
)paren
)paren
op_amp
l_int|0xe8
)paren
op_ne
l_int|0xc0
)paren
(brace
r_if
c_cond
(paren
op_decrement
id|cx
op_eq
l_int|0
)paren
(brace
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
id|TIMEOUT
suffix:semicolon
)brace
r_if
c_cond
(paren
id|cx
op_eq
l_int|10
)paren
id|outb
c_func
(paren
l_int|0x02
comma
id|PAR_CONTROL
c_func
(paren
id|dev
)paren
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|net_debug
OG
l_int|2
)paren
id|printk
c_func
(paren
l_string|&quot;%s: send start&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|snd-&gt;state
op_assign
id|WIC_PK_LENGTH_LSB
suffix:semicolon
id|snd-&gt;nibble
op_assign
id|WIC_NB_BEGIN
suffix:semicolon
id|nl-&gt;timeout_count
op_assign
l_int|0
suffix:semicolon
r_case
id|WIC_PK_LENGTH_LSB
suffix:colon
r_if
c_cond
(paren
id|snd-&gt;length.h
op_amp
l_int|0x01
)paren
id|pad
op_assign
l_int|3
suffix:semicolon
r_else
id|pad
op_assign
l_int|2
suffix:semicolon
id|snd-&gt;length.h
op_add_assign
(paren
l_int|4
op_plus
id|pad
)paren
suffix:semicolon
multiline_comment|/* len + seq + data + pad */
r_if
c_cond
(paren
id|net_debug
OG
l_int|2
)paren
id|printk
c_func
(paren
l_string|&quot;%s: WIC_PK_LENGTH_LSB: length = %i&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|snd-&gt;length.h
)paren
suffix:semicolon
r_if
c_cond
(paren
id|wic_send
c_func
(paren
id|nibble_timeout
comma
id|data_addr
comma
op_amp
id|snd-&gt;nibble
comma
id|snd-&gt;length.b.lsb
)paren
)paren
(brace
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
id|TIMEOUT
suffix:semicolon
)brace
id|snd-&gt;state
op_assign
id|WIC_PK_LENGTH_MSB
suffix:semicolon
r_case
id|WIC_PK_LENGTH_MSB
suffix:colon
r_if
c_cond
(paren
id|net_debug
OG
l_int|2
)paren
id|printk
c_func
(paren
l_string|&quot;%s: WIC_PK_LENGTH_MSB&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_if
c_cond
(paren
id|wic_send
c_func
(paren
id|nibble_timeout
comma
id|data_addr
comma
op_amp
id|snd-&gt;nibble
comma
id|snd-&gt;length.b.msb
)paren
)paren
(brace
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
id|TIMEOUT
suffix:semicolon
)brace
id|snd-&gt;state
op_assign
id|WIC_PK_DATA
suffix:semicolon
id|snd-&gt;byte
op_assign
l_int|0
suffix:semicolon
id|snd-&gt;checksum
op_assign
l_int|0
suffix:semicolon
r_case
id|WIC_PK_DATA
suffix:colon
multiline_comment|/* adjust length back to data only */
id|snd-&gt;length.h
op_sub_assign
(paren
l_int|4
op_plus
id|pad
)paren
suffix:semicolon
multiline_comment|/* len + seq + data + pad */
multiline_comment|/* send 2 byte sequence number */
r_if
c_cond
(paren
id|net_debug
OG
l_int|2
)paren
id|printk
c_func
(paren
l_string|&quot;%s: WIC_SEQ&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_if
c_cond
(paren
id|wic_send
c_func
(paren
id|nibble_timeout
comma
id|data_addr
comma
op_amp
id|snd-&gt;nibble
comma
l_int|0
)paren
)paren
(brace
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
id|TIMEOUT
suffix:semicolon
)brace
r_if
c_cond
(paren
id|wic_send
c_func
(paren
id|nibble_timeout
comma
id|data_addr
comma
op_amp
id|snd-&gt;nibble
comma
l_int|0
)paren
)paren
(brace
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
id|TIMEOUT
suffix:semicolon
)brace
r_if
c_cond
(paren
id|net_debug
OG
l_int|2
)paren
id|printk
c_func
(paren
l_string|&quot;%s: WIC_PK_DATA&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_do
(brace
r_if
c_cond
(paren
id|wic_send
c_func
(paren
id|nibble_timeout
comma
id|data_addr
comma
op_amp
id|snd-&gt;nibble
comma
id|lbuf
(braket
id|snd-&gt;byte
)braket
)paren
)paren
(brace
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
id|TIMEOUT
suffix:semicolon
)brace
)brace
r_while
c_loop
(paren
op_increment
id|snd-&gt;byte
OL
id|snd-&gt;length.h
)paren
suffix:semicolon
r_do
id|snd-&gt;checksum
op_add_assign
id|lbuf
(braket
op_decrement
id|snd-&gt;byte
)braket
suffix:semicolon
r_while
c_loop
(paren
id|snd-&gt;byte
)paren
suffix:semicolon
id|snd-&gt;state
op_assign
id|WIC_PK_CHECKSUM
suffix:semicolon
r_case
id|WIC_PK_CHECKSUM
suffix:colon
multiline_comment|/* send pad bytes */
r_if
c_cond
(paren
id|net_debug
OG
l_int|2
)paren
id|printk
c_func
(paren
l_string|&quot;%s: WIC_PK_PAD: %i bytes&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|pad
)paren
suffix:semicolon
r_while
c_loop
(paren
id|pad
op_decrement
)paren
r_if
c_cond
(paren
id|wic_send
c_func
(paren
id|nibble_timeout
comma
id|data_addr
comma
op_amp
id|snd-&gt;nibble
comma
l_int|0
)paren
)paren
(brace
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
id|TIMEOUT
suffix:semicolon
)brace
id|dev_kfree_skb
c_func
(paren
id|snd-&gt;skb
comma
id|FREE_WRITE
)paren
suffix:semicolon
id|nl-&gt;enet_stats.tx_packets
op_increment
suffix:semicolon
id|snd-&gt;state
op_assign
id|WIC_PK_DONE
suffix:semicolon
r_case
id|WIC_PK_DONE
suffix:colon
r_if
c_cond
(paren
id|net_debug
OG
l_int|2
)paren
id|printk
c_func
(paren
l_string|&quot;%s: WIC_PK_DONE&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
multiline_comment|/* Close the connection */
id|outb
(paren
l_int|0x00
comma
id|PAR_DATA
c_func
(paren
id|dev
)paren
)paren
suffix:semicolon
id|outb
c_func
(paren
id|save
comma
id|PAR_CONTROL
c_func
(paren
id|dev
)paren
)paren
suffix:semicolon
id|snd-&gt;skb
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
id|net_debug
OG
l_int|2
)paren
id|printk
c_func
(paren
l_string|&quot;%s: send end&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|nl-&gt;connection
op_assign
id|WIC_CN_CLOSING
suffix:semicolon
id|nl-&gt;is_deferred
op_assign
l_int|1
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|queue_task
c_func
(paren
op_amp
id|nl-&gt;deferred
comma
op_amp
id|tq_timer
)paren
suffix:semicolon
id|save
op_or_assign
l_int|0x10
suffix:semicolon
multiline_comment|/* enable */
id|outb
c_func
(paren
id|save
comma
id|PAR_CONTROL
c_func
(paren
id|dev
)paren
)paren
suffix:semicolon
id|enable_irq
c_func
(paren
id|dev-&gt;irq
)paren
suffix:semicolon
r_return
id|OK
suffix:semicolon
)brace
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
id|OK
suffix:semicolon
)brace
r_int
DECL|function|wic_connection_close
id|wic_connection_close
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
r_struct
id|net_local
op_star
id|nl
comma
r_struct
id|wic_local
op_star
id|snd
comma
r_struct
id|wic_local
op_star
id|rcv
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|nl-&gt;connection
op_eq
id|WIC_CN_CLOSING
)paren
(brace
id|nl-&gt;connection
op_assign
id|WIC_CN_NONE
suffix:semicolon
id|dev-&gt;tbusy
op_assign
l_int|0
suffix:semicolon
id|mark_bh
c_func
(paren
id|NET_BH
)paren
suffix:semicolon
)brace
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
id|OK
suffix:semicolon
)brace
multiline_comment|/* WIC_ERROR --- wait till other end settled */
r_int
DECL|function|wic_error
id|wic_error
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
r_struct
id|net_local
op_star
id|nl
comma
r_struct
id|wic_local
op_star
id|snd
comma
r_struct
id|wic_local
op_star
id|rcv
)paren
(brace
r_int
r_char
id|status
suffix:semicolon
id|status
op_assign
id|inb
c_func
(paren
id|PAR_STATUS
c_func
(paren
id|dev
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|status
op_amp
l_int|0xf8
)paren
op_eq
l_int|0x80
)paren
(brace
r_if
c_cond
(paren
id|net_debug
OG
l_int|2
)paren
id|printk
c_func
(paren
l_string|&quot;%s: reset interface.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|nl-&gt;connection
op_assign
id|WIC_CN_NONE
suffix:semicolon
id|dev-&gt;tbusy
op_assign
l_int|0
suffix:semicolon
id|dev-&gt;interrupt
op_assign
l_int|0
suffix:semicolon
id|save
op_or_assign
l_int|0x10
suffix:semicolon
multiline_comment|/* enable */
id|outb
c_func
(paren
id|save
comma
id|PAR_CONTROL
c_func
(paren
id|dev
)paren
)paren
suffix:semicolon
id|enable_irq
c_func
(paren
id|dev-&gt;irq
)paren
suffix:semicolon
id|mark_bh
c_func
(paren
id|NET_BH
)paren
suffix:semicolon
)brace
r_else
(brace
id|nl-&gt;is_deferred
op_assign
l_int|1
suffix:semicolon
id|queue_task
c_func
(paren
op_amp
id|nl-&gt;deferred
comma
op_amp
id|tq_timer
)paren
suffix:semicolon
)brace
r_return
id|OK
suffix:semicolon
)brace
multiline_comment|/* Handle the parallel port interrupts. */
r_void
DECL|function|wic_interrupt
id|wic_interrupt
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_ptr
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_struct
id|device
op_star
id|dev
op_assign
(paren
r_struct
id|device
op_star
)paren
id|irq2dev_map
(braket
id|irq
)braket
suffix:semicolon
r_struct
id|net_local
op_star
id|nl
op_assign
(paren
r_struct
id|net_local
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_struct
id|wic_local
op_star
id|rcv
op_assign
op_amp
id|nl-&gt;rcv_data
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_if
c_cond
(paren
id|dev
op_eq
l_int|NULL
)paren
(brace
id|printk
(paren
l_string|&quot;wic_interrupt: irq %d for unknown device.&bslash;n&quot;
comma
id|irq
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|dev-&gt;interrupt
)paren
(brace
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|check_bfr
c_func
(paren
id|dev
)paren
OL
l_int|0
)paren
(brace
r_return
suffix:semicolon
)brace
id|dev-&gt;interrupt
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|net_debug
OG
l_int|3
)paren
id|printk
c_func
(paren
l_string|&quot;%s: interrupt.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|nl-&gt;connection
)paren
(brace
r_case
id|WIC_CN_CLOSING
suffix:colon
id|dev-&gt;tbusy
op_assign
l_int|0
suffix:semicolon
r_case
id|WIC_CN_NONE
suffix:colon
r_case
id|WIC_CN_SEND
suffix:colon
id|dev-&gt;last_rx
op_assign
id|jiffies
suffix:semicolon
id|rcv-&gt;state
op_assign
id|WIC_PK_TRIGGER
suffix:semicolon
id|nl-&gt;connection
op_assign
id|WIC_CN_RECEIVE
suffix:semicolon
id|nl-&gt;timeout_count
op_assign
l_int|0
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|queue_task
c_func
(paren
op_amp
id|nl-&gt;immediate
comma
op_amp
id|tq_immediate
)paren
suffix:semicolon
id|mark_bh
c_func
(paren
id|IMMEDIATE_BH
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|WIC_CN_RECEIVE
suffix:colon
id|printk
c_func
(paren
l_string|&quot;%s: receive interrupt when receiving packet&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|WIC_CN_ERROR
suffix:colon
id|printk
c_func
(paren
l_string|&quot;%s: receive interrupt in error state&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
r_int
DECL|function|wic_rebuild_header
id|wic_rebuild_header
c_func
(paren
r_void
op_star
id|buff
comma
r_struct
id|device
op_star
id|dev
comma
r_int
r_int
id|dst
comma
r_struct
id|sk_buff
op_star
id|skb
)paren
(brace
r_struct
id|net_local
op_star
id|nl
op_assign
(paren
r_struct
id|net_local
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_struct
id|ethhdr
op_star
id|eth
op_assign
(paren
r_struct
id|ethhdr
op_star
)paren
id|buff
suffix:semicolon
r_int
id|i
suffix:semicolon
r_if
c_cond
(paren
(paren
id|dev-&gt;flags
op_amp
id|IFF_NOARP
)paren
op_eq
l_int|0
)paren
r_return
id|nl
op_member_access_from_pointer
id|orig_rebuild_header
c_func
(paren
id|buff
comma
id|dev
comma
id|dst
comma
id|skb
)paren
suffix:semicolon
r_if
c_cond
(paren
id|eth-&gt;h_proto
op_ne
id|htons
c_func
(paren
id|ETH_P_IP
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;wic_rebuild_header: Don&squot;t know how to resolve type %d addresses?&bslash;n&quot;
comma
(paren
r_int
)paren
id|eth-&gt;h_proto
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|eth-&gt;h_source
comma
id|dev-&gt;dev_addr
comma
id|dev-&gt;addr_len
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|ETH_ALEN
op_minus
r_sizeof
(paren
r_int
r_int
)paren
suffix:semicolon
id|i
op_increment
)paren
id|eth-&gt;h_dest
(braket
id|i
)braket
op_assign
l_int|0xfc
suffix:semicolon
id|memcpy
c_func
(paren
op_amp
(paren
id|eth-&gt;h_dest
(braket
id|i
)braket
)paren
comma
op_amp
id|dst
comma
r_sizeof
(paren
r_int
r_int
)paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_int
DECL|function|wic_tx_packet
id|wic_tx_packet
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|device
op_star
id|dev
)paren
(brace
r_struct
id|net_local
op_star
id|nl
op_assign
(paren
r_struct
id|net_local
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_struct
id|wic_local
op_star
id|snd
op_assign
op_amp
id|nl-&gt;snd_data
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;tbusy
)paren
r_return
l_int|1
suffix:semicolon
multiline_comment|/* If some higher layer thinks we&squot;ve missed an tx-done interrupt&n;&t;   we are passed NULL. Caution: dev_tint() handles the cli()/sti()&n;&t;   itself. */
r_if
c_cond
(paren
id|skb
op_eq
l_int|NULL
)paren
(brace
id|dev_tint
c_func
(paren
id|dev
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|set_bit
c_func
(paren
l_int|0
comma
(paren
r_void
op_star
)paren
op_amp
id|dev-&gt;tbusy
)paren
op_ne
l_int|0
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%s: Transmitter access conflict.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|skb-&gt;len
OG
id|dev-&gt;mtu
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%s: packet too big, %d.&bslash;n&quot;
comma
id|dev-&gt;name
comma
(paren
r_int
)paren
id|skb-&gt;len
)paren
suffix:semicolon
id|dev-&gt;tbusy
op_assign
l_int|0
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|net_debug
OG
l_int|2
)paren
id|printk
c_func
(paren
l_string|&quot;%s: send request&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|dev-&gt;trans_start
op_assign
id|jiffies
suffix:semicolon
id|snd-&gt;skb
op_assign
id|skb
suffix:semicolon
id|snd-&gt;length.h
op_assign
id|skb-&gt;len
suffix:semicolon
id|snd-&gt;state
op_assign
id|WIC_PK_TRIGGER
suffix:semicolon
r_if
c_cond
(paren
id|nl-&gt;connection
op_eq
id|WIC_CN_NONE
)paren
(brace
id|nl-&gt;connection
op_assign
id|WIC_CN_SEND
suffix:semicolon
id|nl-&gt;timeout_count
op_assign
l_int|0
suffix:semicolon
)brace
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|queue_task
c_func
(paren
op_amp
id|nl-&gt;immediate
comma
op_amp
id|tq_immediate
)paren
suffix:semicolon
id|mark_bh
c_func
(paren
id|IMMEDIATE_BH
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Open/initialize the board.  This is called (in the current kernel)&n;   sometime after booting when the &squot;ifconfig&squot; program is run.&n;&n;   This routine gets exclusive access to the parallel port by allocating&n;   its IRQ line.&n; */
r_int
DECL|function|wic_open
id|wic_open
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
r_struct
id|net_local
op_star
id|nl
op_assign
(paren
r_struct
id|net_local
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;irq
op_eq
l_int|0
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%s: IRQ is not set.  Please set it by ifconfig.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_return
op_minus
id|EAGAIN
suffix:semicolon
)brace
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|check_bfr
c_func
(paren
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|request_irq
c_func
(paren
id|dev-&gt;irq
comma
id|wic_interrupt
comma
l_int|0
comma
id|dev-&gt;name
comma
l_int|NULL
)paren
op_ne
l_int|0
)paren
(brace
id|sti
c_func
(paren
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;%s: couldn&squot;t get IRQ %d.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|dev-&gt;irq
)paren
suffix:semicolon
r_return
op_minus
id|EAGAIN
suffix:semicolon
)brace
id|irq2dev_map
(braket
id|dev-&gt;irq
)braket
op_assign
id|dev
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|save
op_or_assign
l_int|0x10
suffix:semicolon
multiline_comment|/* enable */
id|outb
c_func
(paren
id|save
comma
id|PAR_CONTROL
c_func
(paren
id|dev
)paren
)paren
suffix:semicolon
multiline_comment|/* Initialize the state machine. */
id|nl-&gt;rcv_data.state
op_assign
id|nl-&gt;snd_data.state
op_assign
id|WIC_PK_DONE
suffix:semicolon
id|nl-&gt;rcv_data.skb
op_assign
id|nl-&gt;snd_data.skb
op_assign
l_int|NULL
suffix:semicolon
id|nl-&gt;connection
op_assign
id|WIC_CN_NONE
suffix:semicolon
id|nl-&gt;is_deferred
op_assign
l_int|0
suffix:semicolon
id|dev-&gt;interrupt
op_assign
l_int|0
suffix:semicolon
id|dev-&gt;start
op_assign
l_int|1
suffix:semicolon
id|dev-&gt;tbusy
op_assign
l_int|0
suffix:semicolon
id|MOD_INC_USE_COUNT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* The inverse routine to wic_open (). */
r_int
DECL|function|wic_close
id|wic_close
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
r_struct
id|net_local
op_star
id|nl
op_assign
(paren
r_struct
id|net_local
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_struct
id|wic_local
op_star
id|snd
op_assign
op_amp
id|nl-&gt;snd_data
suffix:semicolon
r_struct
id|wic_local
op_star
id|rcv
op_assign
op_amp
id|nl-&gt;rcv_data
suffix:semicolon
id|dev-&gt;tbusy
op_assign
l_int|1
suffix:semicolon
id|dev-&gt;start
op_assign
l_int|0
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|free_irq
c_func
(paren
id|dev-&gt;irq
comma
l_int|NULL
)paren
suffix:semicolon
id|irq2dev_map
(braket
id|dev-&gt;irq
)braket
op_assign
l_int|NULL
suffix:semicolon
id|nl-&gt;is_deferred
op_assign
l_int|0
suffix:semicolon
id|nl-&gt;connection
op_assign
id|WIC_CN_NONE
suffix:semicolon
id|sti
c_func
(paren
)paren
suffix:semicolon
id|outb
c_func
(paren
l_int|0x00
comma
id|PAR_DATA
c_func
(paren
id|dev
)paren
)paren
suffix:semicolon
id|snd-&gt;state
op_assign
id|WIC_PK_DONE
suffix:semicolon
r_if
c_cond
(paren
id|snd-&gt;skb
)paren
(brace
id|snd-&gt;skb-&gt;free
op_assign
l_int|1
suffix:semicolon
id|dev_kfree_skb
c_func
(paren
id|snd-&gt;skb
comma
id|FREE_WRITE
)paren
suffix:semicolon
id|snd-&gt;skb
op_assign
l_int|NULL
suffix:semicolon
)brace
id|rcv-&gt;state
op_assign
id|WIC_PK_DONE
suffix:semicolon
r_if
c_cond
(paren
id|rcv-&gt;skb
)paren
(brace
id|rcv-&gt;skb-&gt;free
op_assign
l_int|1
suffix:semicolon
id|kfree_skb
c_func
(paren
id|rcv-&gt;skb
comma
id|FREE_READ
)paren
suffix:semicolon
id|rcv-&gt;skb
op_assign
l_int|NULL
suffix:semicolon
)brace
id|MOD_DEC_USE_COUNT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_struct
id|enet_statistics
op_star
DECL|function|wic_get_stats
id|wic_get_stats
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
r_struct
id|net_local
op_star
id|nl
op_assign
(paren
r_struct
id|net_local
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_struct
id|enet_statistics
op_star
id|r
op_assign
op_amp
id|nl-&gt;enet_stats
suffix:semicolon
r_return
id|r
suffix:semicolon
)brace
r_int
DECL|function|wic_config
id|wic_config
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
r_struct
id|ifmap
op_star
id|map
)paren
(brace
r_if
c_cond
(paren
id|dev-&gt;flags
op_amp
id|IFF_UP
)paren
r_return
op_minus
id|EBUSY
suffix:semicolon
r_if
c_cond
(paren
id|map-&gt;base_addr
op_ne
(paren
r_int
r_int
)paren
op_minus
l_int|1
op_logical_and
id|map-&gt;base_addr
op_ne
id|dev-&gt;base_addr
)paren
id|printk
c_func
(paren
l_string|&quot;%s: You cannot change base_addr of this interface (ignored).&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_if
c_cond
(paren
id|map-&gt;irq
op_ne
(paren
r_int
r_char
)paren
op_minus
l_int|1
)paren
id|dev-&gt;irq
op_assign
id|map-&gt;irq
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_int
DECL|function|wic_ioctl
id|wic_ioctl
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
r_struct
id|ifreq
op_star
id|rq
comma
r_int
id|cmd
)paren
(brace
r_struct
id|wicconf
id|wc
suffix:semicolon
r_int
id|err
suffix:semicolon
r_char
id|len
op_assign
l_int|0
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|err
op_assign
id|verify_area
c_func
(paren
id|VERIFY_WRITE
comma
id|rq-&gt;ifr_data
comma
r_sizeof
(paren
r_struct
id|wicconf
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
r_return
id|err
suffix:semicolon
id|memcpy_fromfs
c_func
(paren
op_amp
id|wc
comma
id|rq-&gt;ifr_data
comma
r_sizeof
(paren
r_struct
id|wicconf
)paren
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|wc.pcmd
)paren
(brace
r_case
id|WIC_AYT
suffix:colon
id|strcpy
c_func
(paren
id|wc.data
comma
id|version
)paren
suffix:semicolon
id|wc.len
op_assign
id|strlen
c_func
(paren
id|wc.data
)paren
suffix:semicolon
id|memcpy_tofs
c_func
(paren
id|rq-&gt;ifr_data
comma
op_amp
id|wc
comma
r_sizeof
(paren
r_struct
id|wicconf
)paren
)paren
suffix:semicolon
multiline_comment|/* return 0; */
r_break
suffix:semicolon
r_case
id|WIC_RESET
suffix:colon
id|wic_reset
c_func
(paren
id|dev
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
multiline_comment|/* break; */
r_case
id|WIC_SETSN
suffix:colon
id|len
op_assign
l_int|17
suffix:semicolon
r_break
suffix:semicolon
r_case
id|WIC_SETPS
suffix:colon
id|len
op_assign
l_int|3
suffix:semicolon
r_break
suffix:semicolon
r_case
id|WIC_SETAF
suffix:colon
r_case
id|WIC_SETGPF
suffix:colon
id|len
op_assign
l_int|2
suffix:semicolon
r_break
suffix:semicolon
r_case
id|WIC_SETNET
suffix:colon
id|len
op_assign
l_int|23
suffix:semicolon
r_break
suffix:semicolon
r_case
id|WIC_SETSYS
suffix:colon
id|len
op_assign
l_int|15
suffix:semicolon
r_break
suffix:semicolon
r_case
id|WIC_GETVERH
suffix:colon
r_case
id|WIC_GETNL
suffix:colon
r_case
id|WIC_GETSN
suffix:colon
r_case
id|WIC_CLRSTATS
suffix:colon
r_case
id|WIC_GETSTATS
suffix:colon
r_case
id|WIC_GETVERM
suffix:colon
r_case
id|WIC_GETNET
suffix:colon
r_case
id|WIC_GETSYS
suffix:colon
id|len
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
r_return
op_minus
id|EOPNOTSUPP
suffix:semicolon
)brace
multiline_comment|/* Wait for lock to free */
r_while
c_loop
(paren
id|set_bit
c_func
(paren
l_int|0
comma
(paren
r_void
op_star
)paren
op_amp
id|dev-&gt;tbusy
)paren
op_ne
l_int|0
)paren
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|disable_irq
c_func
(paren
id|dev-&gt;irq
)paren
suffix:semicolon
id|save
op_and_assign
l_int|0xef
suffix:semicolon
multiline_comment|/* disable */
id|outb
c_func
(paren
id|save
comma
id|PAR_CONTROL
c_func
(paren
id|dev
)paren
)paren
suffix:semicolon
id|err
op_assign
id|check_bfr
c_func
(paren
id|dev
)paren
suffix:semicolon
id|tog
op_assign
l_int|3
suffix:semicolon
id|err
op_assign
id|send_cmd
c_func
(paren
id|dev
comma
(paren
r_int
r_char
op_star
)paren
op_amp
id|wc
comma
id|len
)paren
suffix:semicolon
r_if
c_cond
(paren
id|wc.pcmd
op_amp
l_int|0x40
)paren
(brace
multiline_comment|/* response */
id|len
op_assign
(paren
r_char
)paren
id|recv_cmd_resp
c_func
(paren
id|dev
comma
id|wc.data
)paren
suffix:semicolon
r_while
c_loop
(paren
(paren
id|len
op_eq
l_int|1
)paren
op_logical_and
(paren
id|wc.data
(braket
l_int|0
)braket
op_eq
l_int|0x7
)paren
)paren
(brace
multiline_comment|/* controller int */
id|len
op_assign
(paren
r_char
)paren
id|recv_cmd_resp
c_func
(paren
id|dev
comma
id|wc.data
)paren
suffix:semicolon
)brace
id|save
op_or_assign
l_int|0x10
suffix:semicolon
multiline_comment|/* enable */
id|outb
c_func
(paren
id|save
comma
id|PAR_CONTROL
c_func
(paren
id|dev
)paren
)paren
suffix:semicolon
id|enable_irq
c_func
(paren
id|dev-&gt;irq
)paren
suffix:semicolon
id|wc.len
op_assign
(paren
id|len
OL
l_int|0
)paren
ques
c_cond
l_int|0
suffix:colon
id|len
suffix:semicolon
id|memcpy_tofs
c_func
(paren
id|rq-&gt;ifr_data
comma
op_amp
id|wc
comma
r_sizeof
(paren
r_struct
id|wicconf
)paren
)paren
suffix:semicolon
)brace
r_else
(brace
id|save
op_or_assign
l_int|0x10
suffix:semicolon
multiline_comment|/* enable */
id|outb
c_func
(paren
id|save
comma
id|PAR_CONTROL
c_func
(paren
id|dev
)paren
)paren
suffix:semicolon
id|enable_irq
c_func
(paren
id|dev-&gt;irq
)paren
suffix:semicolon
)brace
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|outb
c_func
(paren
l_int|0
comma
id|PAR_DATA
c_func
(paren
id|dev
)paren
)paren
suffix:semicolon
id|dev-&gt;tbusy
op_assign
l_int|0
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_int
DECL|function|get_byte
id|get_byte
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
r_int
r_char
op_star
id|c
)paren
(brace
r_int
r_int
id|cx
suffix:semicolon
id|cx
op_assign
id|LOOPCNT
suffix:semicolon
r_while
c_loop
(paren
(paren
id|inb
c_func
(paren
id|PAR_STATUS
c_func
(paren
id|dev
)paren
)paren
op_amp
l_int|0x08
)paren
op_ne
(paren
(paren
id|tog
op_lshift
l_int|3
)paren
op_amp
l_int|0x08
)paren
)paren
(brace
r_if
c_cond
(paren
op_decrement
id|cx
op_eq
l_int|0
)paren
(brace
r_return
op_minus
id|TIMEOUT
suffix:semicolon
)brace
)brace
multiline_comment|/* receive a byte of data */
op_star
id|c
op_assign
id|inb
c_func
(paren
id|PAR_DATA
c_func
(paren
id|dev
)paren
)paren
suffix:semicolon
id|tog
op_xor_assign
l_int|0x01
suffix:semicolon
multiline_comment|/* ack reception of data */
id|outb
c_func
(paren
id|tog
op_or
id|save
comma
id|PAR_CONTROL
c_func
(paren
id|dev
)paren
)paren
suffix:semicolon
r_return
id|OK
suffix:semicolon
)brace
r_int
DECL|function|ack_resp
id|ack_resp
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
r_int
r_int
id|cx
suffix:semicolon
id|outb
c_func
(paren
id|save
op_or
l_int|0x27
comma
id|PAR_CONTROL
c_func
(paren
id|dev
)paren
)paren
suffix:semicolon
multiline_comment|/* wait for controller to remove interrupt [Ack(low), Busy(low)] */
id|cx
op_assign
id|LOOPCNT
suffix:semicolon
r_while
c_loop
(paren
(paren
id|inb
c_func
(paren
id|PAR_STATUS
c_func
(paren
id|dev
)paren
)paren
op_amp
l_int|0xc0
)paren
op_ne
l_int|0x80
)paren
(brace
r_if
c_cond
(paren
op_decrement
id|cx
op_eq
l_int|0
)paren
(brace
r_return
op_minus
id|TIMEOUT
suffix:semicolon
)brace
)brace
id|outb
c_func
(paren
id|save
op_or
l_int|0x22
comma
id|PAR_CONTROL
c_func
(paren
id|dev
)paren
)paren
suffix:semicolon
id|cx
op_assign
id|LOOPCNT
suffix:semicolon
r_while
c_loop
(paren
(paren
id|inb
c_func
(paren
id|PAR_STATUS
c_func
(paren
id|dev
)paren
)paren
op_amp
l_int|0x08
)paren
op_eq
l_int|0x08
)paren
(brace
r_if
c_cond
(paren
op_decrement
id|cx
op_eq
l_int|0
)paren
(brace
r_return
id|TIMEOUT
suffix:semicolon
)brace
)brace
id|tog
op_or_assign
l_int|0x20
suffix:semicolon
id|tog
op_and_assign
l_int|0xfe
suffix:semicolon
r_return
id|OK
suffix:semicolon
)brace
r_void
DECL|function|wic_reset
id|wic_reset
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
r_int
r_char
id|stat
suffix:semicolon
id|stat
op_assign
id|inb
c_func
(paren
id|PAR_CONTROL
c_func
(paren
id|dev
)paren
)paren
suffix:semicolon
id|outb
c_func
(paren
l_int|0
comma
id|PAR_DATA
c_func
(paren
id|dev
)paren
)paren
suffix:semicolon
id|outb
c_func
(paren
id|stat
op_or
l_int|0x08
comma
id|PAR_CONTROL
c_func
(paren
id|dev
)paren
)paren
suffix:semicolon
id|outb
c_func
(paren
id|stat
op_amp
l_int|0xf7
comma
id|PAR_CONTROL
c_func
(paren
id|dev
)paren
)paren
suffix:semicolon
id|dev-&gt;tbusy
op_assign
l_int|0
suffix:semicolon
id|dev-&gt;interrupt
op_assign
l_int|0
suffix:semicolon
id|tog
op_assign
l_int|3
suffix:semicolon
id|save
op_assign
l_int|0
suffix:semicolon
r_return
suffix:semicolon
)brace
r_int
DECL|function|check_bfr
id|check_bfr
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
r_int
r_char
id|c0
comma
id|l
suffix:semicolon
r_if
c_cond
(paren
(paren
id|inb
c_func
(paren
id|PAR_STATUS
c_func
(paren
id|dev
)paren
)paren
op_amp
l_int|0xc8
)paren
op_eq
l_int|0x48
)paren
(brace
id|save
op_or_assign
l_int|0x80
suffix:semicolon
id|outb
c_func
(paren
l_int|0x23
op_or
id|save
comma
id|PAR_CONTROL
c_func
(paren
id|dev
)paren
)paren
suffix:semicolon
id|ack_resp
c_func
(paren
id|dev
)paren
suffix:semicolon
id|get_byte
c_func
(paren
id|dev
comma
op_amp
id|l
)paren
suffix:semicolon
multiline_comment|/* len */
r_while
c_loop
(paren
id|l
op_decrement
)paren
(brace
id|get_byte
c_func
(paren
id|dev
comma
op_amp
id|c0
)paren
suffix:semicolon
)brace
id|get_byte
c_func
(paren
id|dev
comma
op_amp
id|c0
)paren
suffix:semicolon
id|save
op_and_assign
l_int|0x7f
suffix:semicolon
id|outb
c_func
(paren
l_int|0
comma
id|PAR_DATA
c_func
(paren
id|dev
)paren
)paren
suffix:semicolon
r_return
op_minus
id|l
suffix:semicolon
)brace
r_else
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
r_int
DECL|function|recv_cmd_resp
id|recv_cmd_resp
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
r_int
r_char
op_star
id|buf
)paren
(brace
r_int
r_char
id|cksum
op_assign
l_int|0
suffix:semicolon
r_int
id|err
suffix:semicolon
r_int
r_char
id|c0
op_assign
l_int|0
suffix:semicolon
r_int
id|len
suffix:semicolon
r_int
id|savelen
suffix:semicolon
r_int
r_int
id|cx
suffix:semicolon
r_int
id|i
suffix:semicolon
id|tog
op_and_assign
l_int|0xfe
suffix:semicolon
id|cx
op_assign
id|LOOPCNT
suffix:semicolon
r_while
c_loop
(paren
(paren
id|inb
c_func
(paren
id|PAR_STATUS
c_func
(paren
id|dev
)paren
)paren
op_amp
l_int|0xc8
)paren
op_ne
l_int|0x48
)paren
(brace
r_if
c_cond
(paren
op_decrement
id|cx
op_eq
l_int|0
)paren
(brace
multiline_comment|/* clear Busy */
id|outb
c_func
(paren
l_int|0
comma
id|PAR_DATA
c_func
(paren
id|dev
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;rcv_cmd_resp: timeout&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|TIMEOUT
suffix:semicolon
)brace
)brace
multiline_comment|/* acknowledge the interrupt */
id|i
op_assign
id|ack_resp
c_func
(paren
id|dev
)paren
suffix:semicolon
multiline_comment|/* get length */
id|err
op_assign
id|get_byte
c_func
(paren
id|dev
comma
op_amp
id|c0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
OL
l_int|0
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;get_byte1: failed&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
id|len
op_assign
id|c0
suffix:semicolon
id|savelen
op_assign
id|len
suffix:semicolon
multiline_comment|/* get data */
r_while
c_loop
(paren
id|len
op_decrement
)paren
(brace
id|err
op_assign
id|get_byte
c_func
(paren
id|dev
comma
op_amp
id|c0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
OL
l_int|0
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;get_byte2: failed&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
id|outb
c_func
(paren
l_int|0
comma
id|PAR_DATA
c_func
(paren
id|dev
)paren
)paren
suffix:semicolon
op_star
id|buf
op_assign
id|c0
suffix:semicolon
id|cksum
op_add_assign
id|c0
suffix:semicolon
id|buf
op_increment
suffix:semicolon
)brace
multiline_comment|/* get cksum */
id|err
op_assign
id|get_byte
c_func
(paren
id|dev
comma
op_amp
id|c0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
OL
l_int|0
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;get_byte3: failed&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
r_if
c_cond
(paren
id|cksum
op_ne
id|c0
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;cksum failed&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
l_int|3
suffix:semicolon
)brace
multiline_comment|/* get trailing byte, if any... */
id|get_byte
c_func
(paren
id|dev
comma
op_amp
id|c0
)paren
suffix:semicolon
r_return
id|savelen
suffix:semicolon
)brace
r_int
DECL|function|send_byte
id|send_byte
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
r_int
r_char
id|c
)paren
(brace
r_int
r_int
id|cx
suffix:semicolon
id|cx
op_assign
id|LOOPCNT
suffix:semicolon
r_while
c_loop
(paren
(paren
id|inb
c_func
(paren
id|PAR_STATUS
c_func
(paren
id|dev
)paren
)paren
op_amp
l_int|0x80
)paren
op_eq
(paren
(paren
id|tog
op_lshift
l_int|7
)paren
op_amp
l_int|0x80
)paren
)paren
(brace
r_if
c_cond
(paren
op_decrement
id|cx
op_eq
l_int|0
)paren
(brace
r_return
op_minus
id|TIMEOUT
suffix:semicolon
)brace
)brace
id|outb
c_func
(paren
id|c
comma
id|PAR_DATA
c_func
(paren
id|dev
)paren
)paren
suffix:semicolon
id|outb
c_func
(paren
id|save
op_or
id|tog
comma
id|PAR_CONTROL
c_func
(paren
id|dev
)paren
)paren
suffix:semicolon
id|tog
op_xor_assign
l_int|0x01
suffix:semicolon
r_return
id|OK
suffix:semicolon
)brace
r_int
DECL|function|send_cmd
id|send_cmd
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
r_int
r_char
op_star
id|cmd
comma
r_char
id|len
)paren
(brace
r_int
r_char
id|cksum
op_assign
l_int|0
suffix:semicolon
r_int
id|err
op_assign
l_int|0
suffix:semicolon
r_int
r_int
id|cx
suffix:semicolon
multiline_comment|/* interrupt controller */
id|outb
c_func
(paren
id|save
op_or
l_int|0x04
comma
id|PAR_CONTROL
c_func
(paren
id|dev
)paren
)paren
suffix:semicolon
multiline_comment|/* wait for ACK */
id|cx
op_assign
id|LOOPCNT
suffix:semicolon
r_while
c_loop
(paren
(paren
id|inb
c_func
(paren
id|PAR_STATUS
c_func
(paren
id|dev
)paren
)paren
op_amp
l_int|0xe8
)paren
op_ne
l_int|0xc0
)paren
(brace
r_if
c_cond
(paren
op_decrement
id|cx
op_eq
l_int|0
)paren
r_return
op_minus
id|TIMEOUT
suffix:semicolon
r_if
c_cond
(paren
id|cx
op_eq
l_int|10
)paren
id|outb
c_func
(paren
l_int|0x02
comma
id|PAR_CONTROL
c_func
(paren
id|dev
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/* cmd coming... */
id|outb
c_func
(paren
id|save
op_or
l_int|0x02
comma
id|PAR_CONTROL
c_func
(paren
id|dev
)paren
)paren
suffix:semicolon
multiline_comment|/* send length byte */
id|err
op_assign
id|send_byte
c_func
(paren
id|dev
comma
(paren
r_int
r_char
)paren
id|len
)paren
suffix:semicolon
multiline_comment|/* send data */
r_while
c_loop
(paren
id|len
op_decrement
)paren
(brace
id|err
op_assign
id|send_byte
c_func
(paren
id|dev
comma
op_star
id|cmd
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
OL
l_int|0
)paren
(brace
r_return
id|err
suffix:semicolon
)brace
id|cksum
op_add_assign
op_star
id|cmd
suffix:semicolon
id|cmd
op_increment
suffix:semicolon
)brace
multiline_comment|/* send cksum byte */
id|err
op_assign
id|send_byte
c_func
(paren
id|dev
comma
id|cksum
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
OL
l_int|0
)paren
r_return
id|err
suffix:semicolon
id|cx
op_assign
id|LOOPCNT
suffix:semicolon
r_while
c_loop
(paren
(paren
id|inb
c_func
(paren
id|PAR_STATUS
c_func
(paren
id|dev
)paren
)paren
op_amp
l_int|0x80
)paren
op_eq
(paren
(paren
id|tog
op_lshift
l_int|7
)paren
op_amp
l_int|0x80
)paren
)paren
(brace
r_if
c_cond
(paren
op_decrement
id|cx
op_eq
l_int|0
)paren
r_return
op_minus
id|TIMEOUT
suffix:semicolon
)brace
id|save
op_or_assign
l_int|0x80
suffix:semicolon
id|outb
c_func
(paren
id|save
op_or
l_int|0x23
comma
id|PAR_CONTROL
c_func
(paren
id|dev
)paren
)paren
suffix:semicolon
id|outb
c_func
(paren
l_int|0
comma
id|PAR_DATA
c_func
(paren
id|dev
)paren
)paren
suffix:semicolon
r_return
id|OK
suffix:semicolon
)brace
macro_line|#ifdef MODULE
DECL|variable|kernel_version
r_char
id|kernel_version
(braket
)braket
op_assign
id|UTS_RELEASE
suffix:semicolon
DECL|variable|dev_wic0
r_struct
id|device
id|dev_wic0
op_assign
(brace
l_string|&quot;wic0&quot;
multiline_comment|/*&quot;wic&quot;*/
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
multiline_comment|/* memory */
l_int|0x3BC
comma
l_int|5
comma
multiline_comment|/* base, irq */
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|NULL
comma
id|wic_init
)brace
suffix:semicolon
DECL|variable|dev_wic1
r_struct
id|device
id|dev_wic1
op_assign
(brace
l_string|&quot;wic1&quot;
multiline_comment|/*&quot;wic&quot;*/
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
multiline_comment|/* memory */
l_int|0x378
comma
l_int|7
comma
multiline_comment|/* base, irq */
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|NULL
comma
id|wic_init
)brace
suffix:semicolon
DECL|variable|dev_wic2
r_struct
id|device
id|dev_wic2
op_assign
(brace
l_string|&quot;wic2&quot;
multiline_comment|/*&quot;wic&quot;*/
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
multiline_comment|/* memory */
l_int|0x278
comma
l_int|2
comma
multiline_comment|/* base, irq */
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|NULL
comma
id|wic_init
)brace
suffix:semicolon
r_int
DECL|function|init_module
id|init_module
c_func
(paren
r_void
)paren
(brace
r_int
id|devices
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|register_netdev
c_func
(paren
op_amp
id|dev_wic0
)paren
op_ne
l_int|0
)paren
id|devices
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|register_netdev
c_func
(paren
op_amp
id|dev_wic1
)paren
op_ne
l_int|0
)paren
id|devices
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|register_netdev
c_func
(paren
op_amp
id|dev_wic2
)paren
op_ne
l_int|0
)paren
id|devices
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|devices
op_eq
l_int|0
)paren
r_return
op_minus
id|EIO
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_void
DECL|function|cleanup_module
id|cleanup_module
c_func
(paren
r_void
)paren
(brace
r_if
c_cond
(paren
id|dev_wic0.priv
)paren
(brace
id|unregister_netdev
c_func
(paren
op_amp
id|dev_wic0
)paren
suffix:semicolon
id|release_region
c_func
(paren
id|PAR_DATA
c_func
(paren
op_amp
id|dev_wic0
)paren
comma
l_int|3
)paren
suffix:semicolon
id|kfree_s
c_func
(paren
id|dev_wic0.priv
comma
r_sizeof
(paren
r_struct
id|net_local
)paren
)paren
suffix:semicolon
id|dev_wic0.priv
op_assign
l_int|NULL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|dev_wic1.priv
)paren
(brace
id|unregister_netdev
c_func
(paren
op_amp
id|dev_wic1
)paren
suffix:semicolon
id|release_region
c_func
(paren
id|PAR_DATA
c_func
(paren
op_amp
id|dev_wic1
)paren
comma
l_int|3
)paren
suffix:semicolon
id|kfree_s
c_func
(paren
id|dev_wic1.priv
comma
r_sizeof
(paren
r_struct
id|net_local
)paren
)paren
suffix:semicolon
id|dev_wic1.priv
op_assign
l_int|NULL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|dev_wic2.priv
)paren
(brace
id|unregister_netdev
c_func
(paren
op_amp
id|dev_wic2
)paren
suffix:semicolon
id|release_region
c_func
(paren
id|PAR_DATA
c_func
(paren
op_amp
id|dev_wic2
)paren
comma
l_int|3
)paren
suffix:semicolon
id|kfree_s
c_func
(paren
id|dev_wic2.priv
comma
r_sizeof
(paren
r_struct
id|net_local
)paren
)paren
suffix:semicolon
id|dev_wic2.priv
op_assign
l_int|NULL
suffix:semicolon
)brace
)brace
macro_line|#endif /* MODULE */
multiline_comment|/*&n; * Local variables:&n; * compile-command: &quot;gcc -DMODULE -DCONFIG_MODVERSIONS -D__KERNEL__ -Wall -Wstrict-prototypes -O2 -g -fomit-frame-pointer -pipe -m486 -c wic.c&quot;&n; * End:&n; */
eof
