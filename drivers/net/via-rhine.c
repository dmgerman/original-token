multiline_comment|/* via-rhine.c: A Linux Ethernet device driver for VIA Rhine family chips. */
multiline_comment|/*&n;&t;Written 1998 by Donald Becker.&n;&n;&t;This software may be used and distributed according to the terms&n;&t;of the GNU Public License (GPL), incorporated herein by reference.&n;&t;Drivers derived from this code also fall under the GPL and must retain&n;&t;this authorship and copyright notice.&n;&n;&t;This driver is designed for the VIA VT86c100A Rhine-II PCI Fast Ethernet&n;&t;controller.  It also works with the older 3043 Rhine-I chip.&n;&n;&t;The author may be reached as becker@cesdis.edu, or&n;&t;Donald Becker&n;&t;312 Severn Ave. #W302&n;&t;Annapolis MD 21403&n;&n;&t;Support and updates available at&n;&t;http://cesdis.gsfc.nasa.gov/linux/drivers/via-rhine.html&n;*/
DECL|variable|versionA
r_static
r_const
r_char
op_star
id|versionA
op_assign
l_string|&quot;via-rhine.c:v1.00 9/5/98  Written by Donald Becker&bslash;n&quot;
suffix:semicolon
DECL|variable|versionB
r_static
r_const
r_char
op_star
id|versionB
op_assign
l_string|&quot;  http://cesdis.gsfc.nasa.gov/linux/drivers/via-rhine.html&bslash;n&quot;
suffix:semicolon
multiline_comment|/* A few user-configurable values.   These may be modified when a driver&n;   module is loaded.*/
DECL|variable|debug
r_static
r_int
id|debug
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* 1 normal messages, 0 quiet .. 7 verbose. */
DECL|variable|max_interrupt_work
r_static
r_int
id|max_interrupt_work
op_assign
l_int|20
suffix:semicolon
DECL|variable|min_pci_latency
r_static
r_int
id|min_pci_latency
op_assign
l_int|64
suffix:semicolon
multiline_comment|/* Set the copy breakpoint for the copy-only-tiny-frames scheme.&n;   Setting to &gt; 1518 effectively disables this feature. */
DECL|variable|rx_copybreak
r_static
r_int
id|rx_copybreak
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Used to pass the media type, etc.&n;   Both &squot;options[]&squot; and &squot;full_duplex[]&squot; should exist for driver&n;   interoperability.&n;   The media type is usually passed in &squot;options[]&squot;.&n;*/
DECL|macro|MAX_UNITS
mdefine_line|#define MAX_UNITS 8&t;&t;/* More are supported, limit only on options */
DECL|variable|options
r_static
r_int
id|options
(braket
id|MAX_UNITS
)braket
op_assign
(brace
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
)brace
suffix:semicolon
DECL|variable|full_duplex
r_static
r_int
id|full_duplex
(braket
id|MAX_UNITS
)braket
op_assign
(brace
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
)brace
suffix:semicolon
multiline_comment|/* Maximum number of multicast addresses to filter (vs. rx-all-multicast).&n;   The Rhine has a 64 element 8390-like hash table.  */
DECL|variable|multicast_filter_limit
r_static
r_const
r_int
id|multicast_filter_limit
op_assign
l_int|32
suffix:semicolon
multiline_comment|/* Operational parameters that are set at compile time. */
multiline_comment|/* Keep the ring sizes a power of two for compile efficiency.&n;   The compiler will convert &lt;unsigned&gt;&squot;%&squot;&lt;2^N&gt; into a bit mask.&n;   Making the Tx ring too large decreases the effectiveness of channel&n;   bonding and packet priority.&n;   There are no ill effects from too-large receive rings. */
DECL|macro|TX_RING_SIZE
mdefine_line|#define TX_RING_SIZE&t;8
DECL|macro|RX_RING_SIZE
mdefine_line|#define RX_RING_SIZE&t;16
multiline_comment|/* Operational parameters that usually are not changed. */
multiline_comment|/* Time in jiffies before concluding the transmitter is hung. */
DECL|macro|TX_TIMEOUT
mdefine_line|#define TX_TIMEOUT  (2*HZ)
DECL|macro|PKT_BUF_SZ
mdefine_line|#define PKT_BUF_SZ&t;&t;1536&t;&t;&t;/* Size of each temporary Rx buffer.*/
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/version.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/timer.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/ioport.h&gt;
macro_line|#include &lt;linux/malloc.h&gt;
macro_line|#include &lt;linux/interrupt.h&gt;
macro_line|#include &lt;linux/pci.h&gt;
macro_line|#include &lt;linux/netdevice.h&gt;
macro_line|#include &lt;linux/etherdevice.h&gt;
macro_line|#include &lt;linux/skbuff.h&gt;
macro_line|#include &lt;asm/processor.h&gt;&t;&t;/* Processor type for cache alignment. */
macro_line|#include &lt;asm/bitops.h&gt;
macro_line|#include &lt;asm/io.h&gt;
multiline_comment|/* This driver was written to use PCI memory space, however some boards&n;   only work with I/O space accesses. */
DECL|macro|VIA_USE_IO
mdefine_line|#define VIA_USE_IO
macro_line|#ifdef VIA_USE_IO
DECL|macro|readb
macro_line|#undef readb
DECL|macro|readw
macro_line|#undef readw
DECL|macro|readl
macro_line|#undef readl
DECL|macro|writeb
macro_line|#undef writeb
DECL|macro|writew
macro_line|#undef writew
DECL|macro|writel
macro_line|#undef writel
DECL|macro|readb
mdefine_line|#define readb inb
DECL|macro|readw
mdefine_line|#define readw inw
DECL|macro|readl
mdefine_line|#define readl inl
DECL|macro|writeb
mdefine_line|#define writeb outb
DECL|macro|writew
mdefine_line|#define writew outw
DECL|macro|writel
mdefine_line|#define writel outl
macro_line|#endif
multiline_comment|/* Kernel compatibility defines, some common to David Hind&squot;s PCMCIA package.&n;   This is only in the support-all-kernels source code. */
DECL|macro|RUN_AT
mdefine_line|#define RUN_AT(x) (jiffies + (x))
macro_line|#if (LINUX_VERSION_CODE &gt;= 0x20100)
macro_line|#else
macro_line|#ifndef __alpha__
DECL|macro|ioremap
mdefine_line|#define ioremap vremap
DECL|macro|iounmap
mdefine_line|#define iounmap vfree
macro_line|#endif
macro_line|#endif
macro_line|#if defined(MODULE) &amp;&amp; LINUX_VERSION_CODE &gt; 0x20115
id|MODULE_AUTHOR
c_func
(paren
l_string|&quot;Donald Becker &lt;becker@cesdis.gsfc.nasa.gov&gt;&quot;
)paren
suffix:semicolon
id|MODULE_DESCRIPTION
c_func
(paren
l_string|&quot;VIA Rhine PCI Fast Ethernet driver&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|max_interrupt_work
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|min_pci_latency
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|debug
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|rx_copybreak
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|options
comma
l_string|&quot;1-&quot;
id|__MODULE_STRING
c_func
(paren
id|MAX_UNITS
)paren
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|full_duplex
comma
l_string|&quot;1-&quot;
id|__MODULE_STRING
c_func
(paren
id|MAX_UNITS
)paren
l_string|&quot;i&quot;
)paren
suffix:semicolon
macro_line|#endif
macro_line|#if LINUX_VERSION_CODE &lt; 0x20123
DECL|macro|test_and_set_bit
mdefine_line|#define test_and_set_bit(val, addr) set_bit(val, addr)
macro_line|#endif
macro_line|#if LINUX_VERSION_CODE &lt;= 0x20139
DECL|macro|net_device_stats
mdefine_line|#define&t;net_device_stats enet_statistics
macro_line|#else
DECL|macro|NETSTATS_VER2
mdefine_line|#define NETSTATS_VER2
macro_line|#endif
macro_line|#if LINUX_VERSION_CODE &lt; 0x20155  ||  defined(CARDBUS)
multiline_comment|/* Grrrr, the PCI code changed, but did not consider CardBus... */
macro_line|#include &lt;linux/bios32.h&gt;
DECL|macro|PCI_SUPPORT_VER1
mdefine_line|#define PCI_SUPPORT_VER1
macro_line|#else
DECL|macro|PCI_SUPPORT_VER2
mdefine_line|#define PCI_SUPPORT_VER2
macro_line|#endif
macro_line|#if LINUX_VERSION_CODE &lt; 0x20159
DECL|macro|dev_free_skb
mdefine_line|#define dev_free_skb(skb) dev_kfree_skb(skb, FREE_WRITE);
macro_line|#else
DECL|macro|dev_free_skb
mdefine_line|#define dev_free_skb(skb) dev_kfree_skb(skb);
macro_line|#endif
multiline_comment|/*&n;&t;&t;&t;&t;Theory of Operation&n;&n;I. Board Compatibility&n;&n;This driver is designed for the VIA 86c100A Rhine-II PCI Fast Ethernet&n;controller.&n;&n;II. Board-specific settings&n;&n;Boards with this chip are functional only in a bus-master PCI slot.&n;&n;Many operational settings are loaded from the EEPROM to the Config word at&n;offset 0x78.  This driver assumes that they are correct.&n;If this driver is compiled to use PCI memory space operations the EEPROM&n;must be configured to enable memory ops.&n;&n;III. Driver operation&n;&n;IIIa. Ring buffers&n;&n;This driver uses two statically allocated fixed-size descriptor lists&n;formed into rings by a branch from the final descriptor to the beginning of&n;the list.  The ring sizes are set at compile time by RX/TX_RING_SIZE.&n;&n;IIIb/c. Transmit/Receive Structure&n;&n;This driver attempts to use a zero-copy receive and transmit scheme.&n;&n;Alas, all data buffers are required to start on a 32 bit boundary, so&n;the driver must often copy transmit packets into bounce buffers.&n;&n;The driver allocates full frame size skbuffs for the Rx ring buffers at&n;open() time and passes the skb-&gt;data field to the chip as receive data&n;buffers.  When an incoming frame is less than RX_COPYBREAK bytes long,&n;a fresh skbuff is allocated and the frame is copied to the new skbuff.&n;When the incoming frame is larger, the skbuff is passed directly up the&n;protocol stack.  Buffers consumed this way are replaced by newly allocated&n;skbuffs in the last phase of netdev_rx().&n;&n;The RX_COPYBREAK value is chosen to trade-off the memory wasted by&n;using a full-sized skbuff for small frames vs. the copying costs of larger&n;frames.  New boards are typically used in generously configured machines&n;and the underfilled buffers have negligible impact compared to the benefit of&n;a single allocation size, so the default value of zero results in never&n;copying packets.  When copying is done, the cost is usually mitigated by using&n;a combined copy/checksum routine.  Copying also preloads the cache, which is&n;most useful with small frames.&n;&n;Since the VIA chips are only able to transfer data to buffers on 32 bit&n;boundaries, the the IP header at offset 14 in an ethernet frame isn&squot;t&n;longword aligned for further processing.  Copying these unaligned buffers&n;has the beneficial effect of 16-byte aligning the IP header.&n;&n;IIId. Synchronization&n;&n;The driver runs as two independent, single-threaded flows of control.  One&n;is the send-packet routine, which enforces single-threaded use by the&n;dev-&gt;tbusy flag.  The other thread is the interrupt handler, which is single&n;threaded by the hardware and interrupt handling software.&n;&n;The send packet thread has partial control over the Tx ring and &squot;dev-&gt;tbusy&squot;&n;flag.  It sets the tbusy flag whenever it&squot;s queuing a Tx packet. If the next&n;queue slot is empty, it clears the tbusy flag when finished otherwise it sets&n;the &squot;lp-&gt;tx_full&squot; flag.&n;&n;The interrupt handler has exclusive control over the Rx ring and records stats&n;from the Tx ring.  After reaping the stats, it marks the Tx queue entry as&n;empty by incrementing the dirty_tx mark. Iff the &squot;lp-&gt;tx_full&squot; flag is set, it&n;clears both the tx_full and tbusy flags.&n;&n;IV. Notes&n;&n;IVb. References&n;&n;Preliminary VT86C100A manual from http://www.via.com.tw/&n;http://cesdis.gsfc.nasa.gov/linux/misc/100mbps.html&n;http://cesdis.gsfc.nasa.gov/linux/misc/NWay.html&n;&n;IVc. Errata&n;&n;The VT86C100A manual is not reliable information.&n;The chip does not handle unaligned transmit or receive buffers, resulting&n;in significant performance degradation for bounce buffer copies on transmit&n;and unaligned IP headers on receive.&n;The chip does not pad to minimum transmit length.&n;&n;*/
"&f;"
multiline_comment|/* This table drives the PCI probe routines.  It&squot;s mostly boilerplate in all&n;   of the drivers, and will likely be provided by some future kernel.&n;   Note the matching code -- the first table entry matchs all 56** cards but&n;   second only the 1234 card.&n;*/
DECL|enum|pci_flags_bit
r_enum
id|pci_flags_bit
(brace
DECL|enumerator|PCI_USES_IO
DECL|enumerator|PCI_USES_MEM
DECL|enumerator|PCI_USES_MASTER
id|PCI_USES_IO
op_assign
l_int|1
comma
id|PCI_USES_MEM
op_assign
l_int|2
comma
id|PCI_USES_MASTER
op_assign
l_int|4
comma
DECL|enumerator|PCI_ADDR0
DECL|enumerator|PCI_ADDR1
DECL|enumerator|PCI_ADDR2
DECL|enumerator|PCI_ADDR3
id|PCI_ADDR0
op_assign
l_int|0x10
op_lshift
l_int|0
comma
id|PCI_ADDR1
op_assign
l_int|0x10
op_lshift
l_int|1
comma
id|PCI_ADDR2
op_assign
l_int|0x10
op_lshift
l_int|2
comma
id|PCI_ADDR3
op_assign
l_int|0x10
op_lshift
l_int|3
comma
)brace
suffix:semicolon
DECL|struct|pci_id_info
r_struct
id|pci_id_info
(brace
DECL|member|name
r_const
r_char
op_star
id|name
suffix:semicolon
DECL|member|vendor_id
DECL|member|device_id
DECL|member|device_id_mask
DECL|member|flags
id|u16
id|vendor_id
comma
id|device_id
comma
id|device_id_mask
comma
id|flags
suffix:semicolon
DECL|member|io_size
r_int
id|io_size
suffix:semicolon
DECL|member|probe1
r_struct
id|device
op_star
(paren
op_star
id|probe1
)paren
(paren
r_int
id|pci_bus
comma
r_int
id|pci_devfn
comma
r_struct
id|device
op_star
id|dev
comma
r_int
id|ioaddr
comma
r_int
id|irq
comma
r_int
id|chip_idx
comma
r_int
id|fnd_cnt
)paren
suffix:semicolon
)brace
suffix:semicolon
r_static
r_struct
id|device
op_star
id|via_probe1
c_func
(paren
r_int
id|pci_bus
comma
r_int
id|pci_devfn
comma
r_struct
id|device
op_star
id|dev
comma
r_int
id|ioaddr
comma
r_int
id|irq
comma
r_int
id|chp_idx
comma
r_int
id|fnd_cnt
)paren
suffix:semicolon
DECL|variable|pci_tbl
r_static
r_struct
id|pci_id_info
id|pci_tbl
(braket
)braket
op_assign
(brace
(brace
l_string|&quot;VIA VT86C100A Rhine-II&quot;
comma
l_int|0x1106
comma
l_int|0x6100
comma
l_int|0xffff
comma
id|PCI_USES_MEM
op_or
id|PCI_USES_IO
op_or
id|PCI_USES_MEM
op_or
id|PCI_USES_MASTER
comma
l_int|128
comma
id|via_probe1
)brace
comma
(brace
l_string|&quot;VIA VT3043 Rhine&quot;
comma
l_int|0x1106
comma
l_int|0x3043
comma
l_int|0xffff
comma
id|PCI_USES_IO
op_or
id|PCI_USES_MEM
op_or
id|PCI_USES_MASTER
comma
l_int|128
comma
id|via_probe1
)brace
comma
(brace
l_int|0
comma
)brace
comma
multiline_comment|/* 0 terminated list. */
)brace
suffix:semicolon
multiline_comment|/* A chip capabilities table, matching the entries in pci_tbl[] above. */
DECL|enum|chip_capability_flags
DECL|enumerator|CanHaveMII
r_enum
id|chip_capability_flags
(brace
id|CanHaveMII
op_assign
l_int|1
comma
)brace
suffix:semicolon
DECL|struct|chip_info
r_struct
id|chip_info
(brace
DECL|member|io_size
r_int
id|io_size
suffix:semicolon
DECL|member|flags
r_int
id|flags
suffix:semicolon
DECL|variable|cap_tbl
)brace
r_static
id|cap_tbl
(braket
)braket
op_assign
(brace
(brace
l_int|128
comma
id|CanHaveMII
comma
)brace
comma
(brace
l_int|128
comma
id|CanHaveMII
comma
)brace
comma
)brace
suffix:semicolon
multiline_comment|/* Offsets to the device registers.&n;*/
DECL|enum|register_offsets
r_enum
id|register_offsets
(brace
DECL|enumerator|StationAddr
DECL|enumerator|RxConfig
DECL|enumerator|TxConfig
DECL|enumerator|ChipCmd
id|StationAddr
op_assign
l_int|0x00
comma
id|RxConfig
op_assign
l_int|0x06
comma
id|TxConfig
op_assign
l_int|0x07
comma
id|ChipCmd
op_assign
l_int|0x08
comma
DECL|enumerator|IntrStatus
DECL|enumerator|IntrEnable
id|IntrStatus
op_assign
l_int|0x0C
comma
id|IntrEnable
op_assign
l_int|0x0E
comma
DECL|enumerator|MulticastFilter0
DECL|enumerator|MulticastFilter1
id|MulticastFilter0
op_assign
l_int|0x10
comma
id|MulticastFilter1
op_assign
l_int|0x14
comma
DECL|enumerator|RxRingPtr
DECL|enumerator|TxRingPtr
id|RxRingPtr
op_assign
l_int|0x18
comma
id|TxRingPtr
op_assign
l_int|0x1C
comma
DECL|enumerator|MIIPhyAddr
DECL|enumerator|MIIStatus
DECL|enumerator|PCIConfig
id|MIIPhyAddr
op_assign
l_int|0x6C
comma
id|MIIStatus
op_assign
l_int|0x6D
comma
id|PCIConfig
op_assign
l_int|0x6E
comma
DECL|enumerator|MIICmd
DECL|enumerator|MIIRegAddr
DECL|enumerator|MIIData
id|MIICmd
op_assign
l_int|0x70
comma
id|MIIRegAddr
op_assign
l_int|0x71
comma
id|MIIData
op_assign
l_int|0x72
comma
DECL|enumerator|Config
DECL|enumerator|RxMissed
DECL|enumerator|RxCRCErrs
id|Config
op_assign
l_int|0x78
comma
id|RxMissed
op_assign
l_int|0x7C
comma
id|RxCRCErrs
op_assign
l_int|0x7E
comma
)brace
suffix:semicolon
multiline_comment|/* Bits in the interrupt status/mask registers. */
DECL|enum|intr_status_bits
r_enum
id|intr_status_bits
(brace
DECL|enumerator|IntrRxDone
DECL|enumerator|IntrRxErr
DECL|enumerator|IntrRxEmpty
id|IntrRxDone
op_assign
l_int|0x0001
comma
id|IntrRxErr
op_assign
l_int|0x0004
comma
id|IntrRxEmpty
op_assign
l_int|0x0020
comma
DECL|enumerator|IntrTxDone
DECL|enumerator|IntrTxAbort
DECL|enumerator|IntrTxUnderrun
id|IntrTxDone
op_assign
l_int|0x0002
comma
id|IntrTxAbort
op_assign
l_int|0x0008
comma
id|IntrTxUnderrun
op_assign
l_int|0x0010
comma
DECL|enumerator|IntrPCIErr
id|IntrPCIErr
op_assign
l_int|0x0040
comma
DECL|enumerator|IntrStatsMax
DECL|enumerator|IntrRxEarly
DECL|enumerator|IntrMIIChange
id|IntrStatsMax
op_assign
l_int|0x0080
comma
id|IntrRxEarly
op_assign
l_int|0x0100
comma
id|IntrMIIChange
op_assign
l_int|0x0200
comma
DECL|enumerator|IntrRxOverflow
DECL|enumerator|IntrRxDropped
DECL|enumerator|IntrRxNoBuf
id|IntrRxOverflow
op_assign
l_int|0x0400
comma
id|IntrRxDropped
op_assign
l_int|0x0800
comma
id|IntrRxNoBuf
op_assign
l_int|0x1000
comma
DECL|enumerator|IntrTxAborted
DECL|enumerator|IntrLinkChange
id|IntrTxAborted
op_assign
l_int|0x2000
comma
id|IntrLinkChange
op_assign
l_int|0x4000
comma
DECL|enumerator|IntrRxWakeUp
id|IntrRxWakeUp
op_assign
l_int|0x8000
comma
DECL|enumerator|IntrNormalSummary
DECL|enumerator|IntrAbnormalSummary
id|IntrNormalSummary
op_assign
l_int|0x0003
comma
id|IntrAbnormalSummary
op_assign
l_int|0x8260
comma
)brace
suffix:semicolon
multiline_comment|/* The Rx and Tx buffer descriptors. */
DECL|struct|rx_desc
r_struct
id|rx_desc
(brace
DECL|member|rx_status
id|u16
id|rx_status
suffix:semicolon
DECL|member|rx_length
id|u16
id|rx_length
suffix:semicolon
DECL|member|desc_length
id|u32
id|desc_length
suffix:semicolon
DECL|member|addr
id|u32
id|addr
suffix:semicolon
DECL|member|next_desc
id|u32
id|next_desc
suffix:semicolon
)brace
suffix:semicolon
DECL|struct|tx_desc
r_struct
id|tx_desc
(brace
DECL|member|tx_status
id|u16
id|tx_status
suffix:semicolon
DECL|member|tx_own
id|u16
id|tx_own
suffix:semicolon
DECL|member|desc_length
id|u32
id|desc_length
suffix:semicolon
DECL|member|addr
id|u32
id|addr
suffix:semicolon
DECL|member|next_desc
id|u32
id|next_desc
suffix:semicolon
)brace
suffix:semicolon
multiline_comment|/* Bits in *_desc.status */
DECL|enum|rx_status_bits
r_enum
id|rx_status_bits
(brace
DECL|enumerator|RxDescOwn
DECL|enumerator|RxOK
DECL|enumerator|RxWholePkt
DECL|enumerator|RxErr
id|RxDescOwn
op_assign
l_int|0x80000000
comma
id|RxOK
op_assign
l_int|0x8000
comma
id|RxWholePkt
op_assign
l_int|0x0300
comma
id|RxErr
op_assign
l_int|0x008F
)brace
suffix:semicolon
DECL|enum|desc_status_bits
r_enum
id|desc_status_bits
(brace
DECL|enumerator|DescOwn
DECL|enumerator|DescEndPacket
DECL|enumerator|DescIntr
id|DescOwn
op_assign
l_int|0x8000
comma
id|DescEndPacket
op_assign
l_int|0x4000
comma
id|DescIntr
op_assign
l_int|0x1000
comma
)brace
suffix:semicolon
multiline_comment|/* Bits in ChipCmd. */
DECL|enum|chip_cmd_bits
r_enum
id|chip_cmd_bits
(brace
DECL|enumerator|CmdInit
DECL|enumerator|CmdStart
DECL|enumerator|CmdStop
DECL|enumerator|CmdRxOn
id|CmdInit
op_assign
l_int|0x0001
comma
id|CmdStart
op_assign
l_int|0x0002
comma
id|CmdStop
op_assign
l_int|0x0004
comma
id|CmdRxOn
op_assign
l_int|0x0008
comma
DECL|enumerator|CmdTxOn
DECL|enumerator|CmdTxDemand
DECL|enumerator|CmdRxDemand
id|CmdTxOn
op_assign
l_int|0x0010
comma
id|CmdTxDemand
op_assign
l_int|0x0020
comma
id|CmdRxDemand
op_assign
l_int|0x0040
comma
DECL|enumerator|CmdEarlyRx
DECL|enumerator|CmdEarlyTx
DECL|enumerator|CmdFDuplex
id|CmdEarlyRx
op_assign
l_int|0x0100
comma
id|CmdEarlyTx
op_assign
l_int|0x0200
comma
id|CmdFDuplex
op_assign
l_int|0x0400
comma
DECL|enumerator|CmdNoTxPoll
DECL|enumerator|CmdReset
id|CmdNoTxPoll
op_assign
l_int|0x0800
comma
id|CmdReset
op_assign
l_int|0x8000
comma
)brace
suffix:semicolon
DECL|struct|netdev_private
r_struct
id|netdev_private
(brace
multiline_comment|/* Descriptor rings first for alignment. */
DECL|member|rx_ring
r_struct
id|rx_desc
id|rx_ring
(braket
id|RX_RING_SIZE
)braket
suffix:semicolon
DECL|member|tx_ring
r_struct
id|tx_desc
id|tx_ring
(braket
id|TX_RING_SIZE
)braket
suffix:semicolon
multiline_comment|/* The addresses of receive-in-place skbuffs. */
DECL|member|rx_skbuff
r_struct
id|sk_buff
op_star
id|rx_skbuff
(braket
id|RX_RING_SIZE
)braket
suffix:semicolon
multiline_comment|/* The saved address of a sent-in-place packet/buffer, for later free(). */
DECL|member|tx_skbuff
r_struct
id|sk_buff
op_star
id|tx_skbuff
(braket
id|TX_RING_SIZE
)braket
suffix:semicolon
DECL|member|tx_buf
r_int
r_char
op_star
id|tx_buf
(braket
id|TX_RING_SIZE
)braket
suffix:semicolon
multiline_comment|/* Tx bounce buffers */
DECL|member|tx_bufs
r_int
r_char
op_star
id|tx_bufs
suffix:semicolon
multiline_comment|/* Tx bounce buffer region. */
DECL|member|next_module
r_struct
id|device
op_star
id|next_module
suffix:semicolon
multiline_comment|/* Link for devices of this type. */
DECL|member|stats
r_struct
id|net_device_stats
id|stats
suffix:semicolon
DECL|member|timer
r_struct
id|timer_list
id|timer
suffix:semicolon
multiline_comment|/* Media monitoring timer. */
DECL|member|pci_bus
DECL|member|pci_devfn
r_int
r_char
id|pci_bus
comma
id|pci_devfn
suffix:semicolon
multiline_comment|/* Frequently used values: keep some adjacent for cache effect. */
DECL|member|chip_id
r_int
id|chip_id
suffix:semicolon
DECL|member|in_interrupt
r_int
id|in_interrupt
suffix:semicolon
multiline_comment|/* Word-long for SMP locks. */
DECL|member|rx_head_desc
r_struct
id|rx_desc
op_star
id|rx_head_desc
suffix:semicolon
DECL|member|cur_rx
DECL|member|dirty_rx
r_int
r_int
id|cur_rx
comma
id|dirty_rx
suffix:semicolon
multiline_comment|/* Producer/consumer ring indices */
DECL|member|cur_tx
DECL|member|dirty_tx
r_int
r_int
id|cur_tx
comma
id|dirty_tx
suffix:semicolon
DECL|member|rx_buf_sz
r_int
r_int
id|rx_buf_sz
suffix:semicolon
multiline_comment|/* Based on MTU+slack. */
DECL|member|chip_cmd
id|u16
id|chip_cmd
suffix:semicolon
multiline_comment|/* Current setting for ChipCmd */
DECL|member|tx_full
r_int
r_int
id|tx_full
suffix:colon
l_int|1
suffix:semicolon
multiline_comment|/* The Tx queue is full. */
multiline_comment|/* These values are keep track of the transceiver/media in use. */
DECL|member|full_duplex
r_int
r_int
id|full_duplex
suffix:colon
l_int|1
suffix:semicolon
multiline_comment|/* Full-duplex operation requested. */
DECL|member|duplex_lock
r_int
r_int
id|duplex_lock
suffix:colon
l_int|1
suffix:semicolon
DECL|member|medialock
r_int
r_int
id|medialock
suffix:colon
l_int|1
suffix:semicolon
multiline_comment|/* Do not sense media. */
DECL|member|default_port
r_int
r_int
id|default_port
suffix:colon
l_int|4
suffix:semicolon
multiline_comment|/* Last dev-&gt;if_port value. */
DECL|member|tx_thresh
DECL|member|rx_thresh
id|u8
id|tx_thresh
comma
id|rx_thresh
suffix:semicolon
multiline_comment|/* MII transceiver section. */
DECL|member|mii_cnt
r_int
id|mii_cnt
suffix:semicolon
multiline_comment|/* MII device addresses. */
DECL|member|advertising
id|u16
id|advertising
suffix:semicolon
multiline_comment|/* NWay media advertisement */
DECL|member|phys
r_int
r_char
id|phys
(braket
l_int|2
)braket
suffix:semicolon
multiline_comment|/* MII device addresses. */
)brace
suffix:semicolon
r_static
r_int
id|mdio_read
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
r_int
id|phy_id
comma
r_int
id|location
)paren
suffix:semicolon
r_static
r_void
id|mdio_write
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
r_int
id|phy_id
comma
r_int
id|location
comma
r_int
id|value
)paren
suffix:semicolon
r_static
r_int
id|netdev_open
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_void
id|check_duplex
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_void
id|netdev_timer
c_func
(paren
r_int
r_int
id|data
)paren
suffix:semicolon
r_static
r_void
id|tx_timeout
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_void
id|init_ring
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_int
id|start_tx
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_void
id|intr_handler
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_instance
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
suffix:semicolon
r_static
r_int
id|netdev_rx
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_void
id|netdev_error
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
r_int
id|intr_status
)paren
suffix:semicolon
r_static
r_void
id|set_rx_mode
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_struct
id|net_device_stats
op_star
id|get_stats
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_int
id|mii_ioctl
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
r_struct
id|ifreq
op_star
id|rq
comma
r_int
id|cmd
)paren
suffix:semicolon
r_static
r_int
id|netdev_close
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
suffix:semicolon
"&f;"
multiline_comment|/* A list of our installed devices, for removing the driver module. */
DECL|variable|root_net_dev
r_static
r_struct
id|device
op_star
id|root_net_dev
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/* Ideally we would detect all network cards in slot order.  That would&n;   be best done a central PCI probe dispatch, which wouldn&squot;t work&n;   well when dynamically adding drivers.  So instead we detect just the&n;   cards we know about in slot order. */
DECL|function|pci_etherdev_probe
r_static
r_int
id|pci_etherdev_probe
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
r_struct
id|pci_id_info
id|pci_tbl
(braket
)braket
)paren
(brace
r_int
id|cards_found
op_assign
l_int|0
suffix:semicolon
r_int
id|pci_index
op_assign
l_int|0
suffix:semicolon
r_int
r_char
id|pci_bus
comma
id|pci_device_fn
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pcibios_present
c_func
(paren
)paren
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
r_for
c_loop
(paren
suffix:semicolon
id|pci_index
OL
l_int|0xff
suffix:semicolon
id|pci_index
op_increment
)paren
(brace
id|u16
id|vendor
comma
id|device
comma
id|pci_command
comma
id|new_command
suffix:semicolon
r_int
id|chip_idx
comma
id|irq
suffix:semicolon
r_int
id|pciaddr
suffix:semicolon
r_int
id|ioaddr
suffix:semicolon
r_if
c_cond
(paren
id|pcibios_find_class
(paren
id|PCI_CLASS_NETWORK_ETHERNET
op_lshift
l_int|8
comma
id|pci_index
comma
op_amp
id|pci_bus
comma
op_amp
id|pci_device_fn
)paren
op_ne
id|PCIBIOS_SUCCESSFUL
)paren
r_break
suffix:semicolon
id|pcibios_read_config_word
c_func
(paren
id|pci_bus
comma
id|pci_device_fn
comma
id|PCI_VENDOR_ID
comma
op_amp
id|vendor
)paren
suffix:semicolon
id|pcibios_read_config_word
c_func
(paren
id|pci_bus
comma
id|pci_device_fn
comma
id|PCI_DEVICE_ID
comma
op_amp
id|device
)paren
suffix:semicolon
r_for
c_loop
(paren
id|chip_idx
op_assign
l_int|0
suffix:semicolon
id|pci_tbl
(braket
id|chip_idx
)braket
dot
id|vendor_id
suffix:semicolon
id|chip_idx
op_increment
)paren
r_if
c_cond
(paren
id|vendor
op_eq
id|pci_tbl
(braket
id|chip_idx
)braket
dot
id|vendor_id
op_logical_and
(paren
id|device
op_amp
id|pci_tbl
(braket
id|chip_idx
)braket
dot
id|device_id_mask
)paren
op_eq
id|pci_tbl
(braket
id|chip_idx
)braket
dot
id|device_id
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
id|pci_tbl
(braket
id|chip_idx
)braket
dot
id|vendor_id
op_eq
l_int|0
)paren
multiline_comment|/* Compiled out! */
r_continue
suffix:semicolon
(brace
macro_line|#if defined(PCI_SUPPORT_VER2)
r_struct
id|pci_dev
op_star
id|pdev
op_assign
id|pci_find_slot
c_func
(paren
id|pci_bus
comma
id|pci_device_fn
)paren
suffix:semicolon
macro_line|#ifdef VIA_USE_IO
id|pciaddr
op_assign
id|pdev-&gt;base_address
(braket
l_int|0
)braket
suffix:semicolon
macro_line|#else
id|pciaddr
op_assign
id|pdev-&gt;base_address
(braket
l_int|1
)braket
suffix:semicolon
macro_line|#endif
id|irq
op_assign
id|pdev-&gt;irq
suffix:semicolon
macro_line|#else
id|u32
id|pci_memaddr
suffix:semicolon
id|u8
id|pci_irq_line
suffix:semicolon
id|pcibios_read_config_byte
c_func
(paren
id|pci_bus
comma
id|pci_device_fn
comma
id|PCI_INTERRUPT_LINE
comma
op_amp
id|pci_irq_line
)paren
suffix:semicolon
macro_line|#ifdef VIA_USE_IO
id|pcibios_read_config_dword
c_func
(paren
id|pci_bus
comma
id|pci_device_fn
comma
id|PCI_BASE_ADDRESS_0
comma
op_amp
id|pci_memaddr
)paren
suffix:semicolon
id|pciaddr
op_assign
id|pci_memaddr
suffix:semicolon
macro_line|#else
id|pcibios_read_config_dword
c_func
(paren
id|pci_bus
comma
id|pci_device_fn
comma
id|PCI_BASE_ADDRESS_1
comma
op_amp
id|pci_memaddr
)paren
suffix:semicolon
id|pciaddr
op_assign
id|pci_memaddr
suffix:semicolon
macro_line|#endif
id|irq
op_assign
id|pci_irq_line
suffix:semicolon
macro_line|#endif
)brace
r_if
c_cond
(paren
id|debug
OG
l_int|2
)paren
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;Found %s at PCI address %#lx, IRQ %d.&bslash;n&quot;
comma
id|pci_tbl
(braket
id|chip_idx
)braket
dot
id|name
comma
id|pciaddr
comma
id|irq
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pci_tbl
(braket
id|chip_idx
)braket
dot
id|flags
op_amp
id|PCI_USES_IO
)paren
(brace
r_if
c_cond
(paren
id|check_region
c_func
(paren
id|pciaddr
comma
id|pci_tbl
(braket
id|chip_idx
)braket
dot
id|io_size
)paren
)paren
r_continue
suffix:semicolon
id|ioaddr
op_assign
id|pciaddr
op_amp
op_complement
l_int|3
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
(paren
id|ioaddr
op_assign
(paren
r_int
)paren
id|ioremap
c_func
(paren
id|pciaddr
op_amp
op_complement
l_int|0xf
comma
id|pci_tbl
(braket
id|chip_idx
)braket
dot
id|io_size
)paren
)paren
op_eq
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;Failed to map PCI address %#lx.&bslash;n&quot;
comma
id|pciaddr
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
id|pcibios_read_config_word
c_func
(paren
id|pci_bus
comma
id|pci_device_fn
comma
id|PCI_COMMAND
comma
op_amp
id|pci_command
)paren
suffix:semicolon
id|new_command
op_assign
id|pci_command
op_or
(paren
id|pci_tbl
(braket
id|chip_idx
)braket
dot
id|flags
op_amp
l_int|7
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pci_command
op_ne
id|new_command
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;  The PCI BIOS has not enabled the&quot;
l_string|&quot; device at %d/%d!  Updating PCI command %4.4x-&gt;%4.4x.&bslash;n&quot;
comma
id|pci_bus
comma
id|pci_device_fn
comma
id|pci_command
comma
id|new_command
)paren
suffix:semicolon
id|pcibios_write_config_word
c_func
(paren
id|pci_bus
comma
id|pci_device_fn
comma
id|PCI_COMMAND
comma
id|new_command
)paren
suffix:semicolon
)brace
id|dev
op_assign
id|pci_tbl
(braket
id|chip_idx
)braket
dot
id|probe1
c_func
(paren
id|pci_bus
comma
id|pci_device_fn
comma
id|dev
comma
id|ioaddr
comma
id|irq
comma
id|chip_idx
comma
id|cards_found
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dev
op_logical_and
(paren
id|pci_tbl
(braket
id|chip_idx
)braket
dot
id|flags
op_amp
id|PCI_COMMAND_MASTER
)paren
)paren
(brace
id|u8
id|pci_latency
suffix:semicolon
id|pcibios_read_config_byte
c_func
(paren
id|pci_bus
comma
id|pci_device_fn
comma
id|PCI_LATENCY_TIMER
comma
op_amp
id|pci_latency
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pci_latency
OL
id|min_pci_latency
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;  PCI latency timer (CFLT) is &quot;
l_string|&quot;unreasonably low at %d.  Setting to %d clocks.&bslash;n&quot;
comma
id|pci_latency
comma
id|min_pci_latency
)paren
suffix:semicolon
id|pcibios_write_config_byte
c_func
(paren
id|pci_bus
comma
id|pci_device_fn
comma
id|PCI_LATENCY_TIMER
comma
id|min_pci_latency
)paren
suffix:semicolon
)brace
)brace
id|dev
op_assign
l_int|0
suffix:semicolon
id|cards_found
op_increment
suffix:semicolon
)brace
r_return
id|cards_found
ques
c_cond
l_int|0
suffix:colon
op_minus
id|ENODEV
suffix:semicolon
)brace
macro_line|#ifndef MODULE
DECL|function|via_rhine_probe
r_int
id|via_rhine_probe
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
r_return
id|pci_etherdev_probe
c_func
(paren
id|dev
comma
id|pci_tbl
)paren
suffix:semicolon
)brace
macro_line|#endif
DECL|function|via_probe1
r_static
r_struct
id|device
op_star
id|via_probe1
c_func
(paren
r_int
id|pci_bus
comma
r_int
id|pci_devfn
comma
r_struct
id|device
op_star
id|dev
comma
r_int
id|ioaddr
comma
r_int
id|irq
comma
r_int
id|chip_id
comma
r_int
id|card_idx
)paren
(brace
r_static
r_int
id|did_version
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Already printed version info */
r_struct
id|netdev_private
op_star
id|np
suffix:semicolon
r_int
id|i
comma
id|option
op_assign
id|card_idx
OL
id|MAX_UNITS
ques
c_cond
id|options
(braket
id|card_idx
)braket
suffix:colon
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|debug
OG
l_int|0
op_logical_and
id|did_version
op_increment
op_eq
l_int|0
)paren
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s&quot;
id|KERN_INFO
l_string|&quot;%s&quot;
comma
id|versionA
comma
id|versionB
)paren
suffix:semicolon
id|dev
op_assign
id|init_etherdev
c_func
(paren
id|dev
comma
l_int|0
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: %s at 0x%lx, &quot;
comma
id|dev-&gt;name
comma
id|pci_tbl
(braket
id|chip_id
)braket
dot
id|name
comma
id|ioaddr
)paren
suffix:semicolon
multiline_comment|/* Ideally we would be read the EEPROM but access may be locked. */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|6
suffix:semicolon
id|i
op_increment
)paren
id|dev-&gt;dev_addr
(braket
id|i
)braket
op_assign
id|readb
c_func
(paren
id|ioaddr
op_plus
id|StationAddr
op_plus
id|i
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|5
suffix:semicolon
id|i
op_increment
)paren
id|printk
c_func
(paren
l_string|&quot;%2.2x:&quot;
comma
id|dev-&gt;dev_addr
(braket
id|i
)braket
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;%2.2x, IRQ %d.&bslash;n&quot;
comma
id|dev-&gt;dev_addr
(braket
id|i
)braket
comma
id|irq
)paren
suffix:semicolon
macro_line|#ifdef VIA_USE_IO
id|request_region
c_func
(paren
id|ioaddr
comma
id|pci_tbl
(braket
id|chip_id
)braket
dot
id|io_size
comma
id|dev-&gt;name
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/* Reset the chip to erase previous misconfiguration. */
id|writew
c_func
(paren
id|CmdReset
comma
id|ioaddr
op_plus
id|ChipCmd
)paren
suffix:semicolon
id|dev-&gt;base_addr
op_assign
id|ioaddr
suffix:semicolon
id|dev-&gt;irq
op_assign
id|irq
suffix:semicolon
multiline_comment|/* Make certain the descriptor lists are cache-aligned. */
id|np
op_assign
(paren
r_void
op_star
)paren
(paren
(paren
(paren
r_int
)paren
id|kmalloc
c_func
(paren
r_sizeof
(paren
op_star
id|np
)paren
comma
id|GFP_KERNEL
)paren
op_plus
l_int|31
)paren
op_amp
op_complement
l_int|31
)paren
suffix:semicolon
id|memset
c_func
(paren
id|np
comma
l_int|0
comma
r_sizeof
(paren
op_star
id|np
)paren
)paren
suffix:semicolon
id|dev-&gt;priv
op_assign
id|np
suffix:semicolon
id|np-&gt;next_module
op_assign
id|root_net_dev
suffix:semicolon
id|root_net_dev
op_assign
id|dev
suffix:semicolon
id|np-&gt;pci_bus
op_assign
id|pci_bus
suffix:semicolon
id|np-&gt;pci_devfn
op_assign
id|pci_devfn
suffix:semicolon
id|np-&gt;chip_id
op_assign
id|chip_id
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;mem_start
)paren
id|option
op_assign
id|dev-&gt;mem_start
suffix:semicolon
multiline_comment|/* The lower four bits are the media type. */
r_if
c_cond
(paren
id|option
OG
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|option
op_amp
l_int|0x200
)paren
id|np-&gt;full_duplex
op_assign
l_int|1
suffix:semicolon
id|np-&gt;default_port
op_assign
id|option
op_amp
l_int|15
suffix:semicolon
r_if
c_cond
(paren
id|np-&gt;default_port
)paren
id|np-&gt;medialock
op_assign
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|card_idx
template_param
l_int|0
)paren
id|np-&gt;full_duplex
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|np-&gt;full_duplex
)paren
id|np-&gt;duplex_lock
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* The chip-specific entries in the device structure. */
id|dev-&gt;open
op_assign
op_amp
id|netdev_open
suffix:semicolon
id|dev-&gt;hard_start_xmit
op_assign
op_amp
id|start_tx
suffix:semicolon
id|dev-&gt;stop
op_assign
op_amp
id|netdev_close
suffix:semicolon
id|dev-&gt;get_stats
op_assign
op_amp
id|get_stats
suffix:semicolon
id|dev-&gt;set_multicast_list
op_assign
op_amp
id|set_rx_mode
suffix:semicolon
id|dev-&gt;do_ioctl
op_assign
op_amp
id|mii_ioctl
suffix:semicolon
r_if
c_cond
(paren
id|cap_tbl
(braket
id|np-&gt;chip_id
)braket
dot
id|flags
op_amp
id|CanHaveMII
)paren
(brace
r_int
id|phy
comma
id|phy_idx
op_assign
l_int|0
suffix:semicolon
id|np-&gt;phys
(braket
l_int|0
)braket
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* Standard for this chip. */
r_for
c_loop
(paren
id|phy
op_assign
l_int|1
suffix:semicolon
id|phy
OL
l_int|32
op_logical_and
id|phy_idx
OL
l_int|4
suffix:semicolon
id|phy
op_increment
)paren
(brace
r_int
id|mii_status
op_assign
id|mdio_read
c_func
(paren
id|dev
comma
id|phy
comma
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mii_status
op_ne
l_int|0xffff
op_logical_and
id|mii_status
op_ne
l_int|0x0000
)paren
(brace
id|np-&gt;phys
(braket
id|phy_idx
op_increment
)braket
op_assign
id|phy
suffix:semicolon
id|np-&gt;advertising
op_assign
id|mdio_read
c_func
(paren
id|dev
comma
id|phy
comma
l_int|4
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: MII PHY found at address %d, status &quot;
l_string|&quot;0x%4.4x advertising %4.4x Link %4.4x.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|phy
comma
id|mii_status
comma
id|np-&gt;advertising
comma
id|mdio_read
c_func
(paren
id|dev
comma
id|phy
comma
l_int|5
)paren
)paren
suffix:semicolon
)brace
)brace
id|np-&gt;mii_cnt
op_assign
id|phy_idx
suffix:semicolon
)brace
r_return
id|dev
suffix:semicolon
)brace
"&f;"
multiline_comment|/* Read and write over the MII Management Data I/O (MDIO) interface. */
DECL|function|mdio_read
r_static
r_int
id|mdio_read
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
r_int
id|phy_id
comma
r_int
id|regnum
)paren
(brace
r_int
id|ioaddr
op_assign
id|dev-&gt;base_addr
suffix:semicolon
r_int
id|boguscnt
op_assign
l_int|1024
suffix:semicolon
multiline_comment|/* Wait for a previous command to complete. */
r_while
c_loop
(paren
(paren
id|readb
c_func
(paren
id|ioaddr
op_plus
id|MIICmd
)paren
op_amp
l_int|0x60
)paren
op_logical_and
op_decrement
id|boguscnt
OG
l_int|0
)paren
suffix:semicolon
id|writeb
c_func
(paren
l_int|0x00
comma
id|ioaddr
op_plus
id|MIICmd
)paren
suffix:semicolon
id|writeb
c_func
(paren
id|phy_id
comma
id|ioaddr
op_plus
id|MIIPhyAddr
)paren
suffix:semicolon
id|writeb
c_func
(paren
id|regnum
comma
id|ioaddr
op_plus
id|MIIRegAddr
)paren
suffix:semicolon
id|writeb
c_func
(paren
l_int|0x40
comma
id|ioaddr
op_plus
id|MIICmd
)paren
suffix:semicolon
multiline_comment|/* Trigger read */
id|boguscnt
op_assign
l_int|1024
suffix:semicolon
r_while
c_loop
(paren
(paren
id|readb
c_func
(paren
id|ioaddr
op_plus
id|MIICmd
)paren
op_amp
l_int|0x40
)paren
op_logical_and
op_decrement
id|boguscnt
OG
l_int|0
)paren
suffix:semicolon
r_return
id|readw
c_func
(paren
id|ioaddr
op_plus
id|MIIData
)paren
suffix:semicolon
)brace
DECL|function|mdio_write
r_static
r_void
id|mdio_write
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
r_int
id|phy_id
comma
r_int
id|regnum
comma
r_int
id|value
)paren
(brace
r_int
id|ioaddr
op_assign
id|dev-&gt;base_addr
suffix:semicolon
r_int
id|boguscnt
op_assign
l_int|1024
suffix:semicolon
multiline_comment|/* Wait for a previous command to complete. */
r_while
c_loop
(paren
(paren
id|readb
c_func
(paren
id|ioaddr
op_plus
id|MIICmd
)paren
op_amp
l_int|0x60
)paren
op_logical_and
op_decrement
id|boguscnt
OG
l_int|0
)paren
suffix:semicolon
id|writeb
c_func
(paren
l_int|0x00
comma
id|ioaddr
op_plus
id|MIICmd
)paren
suffix:semicolon
id|writeb
c_func
(paren
id|phy_id
comma
id|ioaddr
op_plus
id|MIIPhyAddr
)paren
suffix:semicolon
id|writeb
c_func
(paren
id|regnum
comma
id|ioaddr
op_plus
id|MIIRegAddr
)paren
suffix:semicolon
id|writew
c_func
(paren
id|value
comma
id|ioaddr
op_plus
id|MIIData
)paren
suffix:semicolon
id|writeb
c_func
(paren
l_int|0x20
comma
id|ioaddr
op_plus
id|MIICmd
)paren
suffix:semicolon
multiline_comment|/* Trigger write. */
r_return
suffix:semicolon
)brace
"&f;"
DECL|function|netdev_open
r_static
r_int
id|netdev_open
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
r_struct
id|netdev_private
op_star
id|np
op_assign
(paren
r_struct
id|netdev_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_int
id|ioaddr
op_assign
id|dev-&gt;base_addr
suffix:semicolon
r_int
id|i
suffix:semicolon
multiline_comment|/* Reset the chip. */
id|writew
c_func
(paren
id|CmdReset
comma
id|ioaddr
op_plus
id|ChipCmd
)paren
suffix:semicolon
r_if
c_cond
(paren
id|request_irq
c_func
(paren
id|dev-&gt;irq
comma
op_amp
id|intr_handler
comma
id|SA_SHIRQ
comma
id|dev-&gt;name
comma
id|dev
)paren
)paren
r_return
op_minus
id|EAGAIN
suffix:semicolon
r_if
c_cond
(paren
id|debug
OG
l_int|1
)paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%s: netdev_open() irq %d.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|dev-&gt;irq
)paren
suffix:semicolon
id|MOD_INC_USE_COUNT
suffix:semicolon
id|init_ring
c_func
(paren
id|dev
)paren
suffix:semicolon
id|writel
c_func
(paren
id|virt_to_bus
c_func
(paren
id|np-&gt;rx_ring
)paren
comma
id|ioaddr
op_plus
id|RxRingPtr
)paren
suffix:semicolon
id|writel
c_func
(paren
id|virt_to_bus
c_func
(paren
id|np-&gt;tx_ring
)paren
comma
id|ioaddr
op_plus
id|TxRingPtr
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|6
suffix:semicolon
id|i
op_increment
)paren
id|writeb
c_func
(paren
id|dev-&gt;dev_addr
(braket
id|i
)braket
comma
id|ioaddr
op_plus
id|StationAddr
op_plus
id|i
)paren
suffix:semicolon
multiline_comment|/* Initialize other registers. */
id|writew
c_func
(paren
l_int|0x0006
comma
id|ioaddr
op_plus
id|PCIConfig
)paren
suffix:semicolon
multiline_comment|/* Tune configuration??? */
multiline_comment|/* Configure the FIFO thresholds. */
id|writeb
c_func
(paren
l_int|0x20
comma
id|ioaddr
op_plus
id|TxConfig
)paren
suffix:semicolon
multiline_comment|/* Initial threshold 32 bytes */
id|np-&gt;tx_thresh
op_assign
l_int|0x20
suffix:semicolon
id|np-&gt;rx_thresh
op_assign
l_int|0x60
suffix:semicolon
multiline_comment|/* Written in set_rx_mode(). */
r_if
c_cond
(paren
id|dev-&gt;if_port
op_eq
l_int|0
)paren
id|dev-&gt;if_port
op_assign
id|np-&gt;default_port
suffix:semicolon
id|dev-&gt;tbusy
op_assign
l_int|0
suffix:semicolon
id|dev-&gt;interrupt
op_assign
l_int|0
suffix:semicolon
id|np-&gt;in_interrupt
op_assign
l_int|0
suffix:semicolon
id|set_rx_mode
c_func
(paren
id|dev
)paren
suffix:semicolon
id|dev-&gt;start
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* Enable interrupts by setting the interrupt mask. */
id|writew
c_func
(paren
id|IntrRxDone
op_or
id|IntrRxErr
op_or
id|IntrRxEmpty
op_or
id|IntrRxOverflow
op_or
id|IntrRxDropped
op_or
id|IntrTxDone
op_or
id|IntrTxAbort
op_or
id|IntrTxUnderrun
op_or
id|IntrPCIErr
op_or
id|IntrStatsMax
op_or
id|IntrLinkChange
op_or
id|IntrMIIChange
comma
id|ioaddr
op_plus
id|IntrEnable
)paren
suffix:semicolon
id|np-&gt;chip_cmd
op_assign
id|CmdStart
op_or
id|CmdTxOn
op_or
id|CmdRxOn
op_or
id|CmdNoTxPoll
suffix:semicolon
id|writew
c_func
(paren
id|np-&gt;chip_cmd
comma
id|ioaddr
op_plus
id|ChipCmd
)paren
suffix:semicolon
id|check_duplex
c_func
(paren
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|debug
OG
l_int|2
)paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%s: Done netdev_open(), status %4.4x &quot;
l_string|&quot;MII status: %4.4x.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|readw
c_func
(paren
id|ioaddr
op_plus
id|ChipCmd
)paren
comma
id|mdio_read
c_func
(paren
id|dev
comma
id|np-&gt;phys
(braket
l_int|0
)braket
comma
l_int|1
)paren
)paren
suffix:semicolon
multiline_comment|/* Set the timer to check for link beat. */
id|init_timer
c_func
(paren
op_amp
id|np-&gt;timer
)paren
suffix:semicolon
id|np-&gt;timer.expires
op_assign
id|RUN_AT
c_func
(paren
l_int|1
)paren
suffix:semicolon
id|np-&gt;timer.data
op_assign
(paren
r_int
r_int
)paren
id|dev
suffix:semicolon
id|np-&gt;timer.function
op_assign
op_amp
id|netdev_timer
suffix:semicolon
multiline_comment|/* timer handler */
id|add_timer
c_func
(paren
op_amp
id|np-&gt;timer
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|check_duplex
r_static
r_void
id|check_duplex
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
r_struct
id|netdev_private
op_star
id|np
op_assign
(paren
r_struct
id|netdev_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_int
id|ioaddr
op_assign
id|dev-&gt;base_addr
suffix:semicolon
r_int
id|mii_reg5
op_assign
id|mdio_read
c_func
(paren
id|dev
comma
id|np-&gt;phys
(braket
l_int|0
)braket
comma
l_int|5
)paren
suffix:semicolon
r_int
id|duplex
suffix:semicolon
r_if
c_cond
(paren
id|np-&gt;duplex_lock
op_logical_or
id|mii_reg5
op_eq
l_int|0xffff
)paren
r_return
suffix:semicolon
id|duplex
op_assign
(paren
id|mii_reg5
op_amp
l_int|0x0100
)paren
op_logical_or
(paren
id|mii_reg5
op_amp
l_int|0x01C0
)paren
op_eq
l_int|0x0040
suffix:semicolon
r_if
c_cond
(paren
id|np-&gt;full_duplex
op_ne
id|duplex
)paren
(brace
id|np-&gt;full_duplex
op_assign
id|duplex
suffix:semicolon
r_if
c_cond
(paren
id|debug
)paren
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Setting %s-duplex based on MII #%d link&quot;
l_string|&quot; partner capability of %4.4x.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|duplex
ques
c_cond
l_string|&quot;full&quot;
suffix:colon
l_string|&quot;half&quot;
comma
id|np-&gt;phys
(braket
l_int|0
)braket
comma
id|mii_reg5
)paren
suffix:semicolon
r_if
c_cond
(paren
id|duplex
)paren
id|np-&gt;chip_cmd
op_or_assign
id|CmdFDuplex
suffix:semicolon
r_else
id|np-&gt;chip_cmd
op_and_assign
op_complement
id|CmdFDuplex
suffix:semicolon
id|writew
c_func
(paren
id|np-&gt;chip_cmd
comma
id|ioaddr
op_plus
id|ChipCmd
)paren
suffix:semicolon
)brace
)brace
DECL|function|netdev_timer
r_static
r_void
id|netdev_timer
c_func
(paren
r_int
r_int
id|data
)paren
(brace
r_struct
id|device
op_star
id|dev
op_assign
(paren
r_struct
id|device
op_star
)paren
id|data
suffix:semicolon
r_struct
id|netdev_private
op_star
id|np
op_assign
(paren
r_struct
id|netdev_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_int
id|ioaddr
op_assign
id|dev-&gt;base_addr
suffix:semicolon
r_int
id|next_tick
op_assign
l_int|10
op_star
id|HZ
suffix:semicolon
r_if
c_cond
(paren
id|debug
OG
l_int|3
)paren
(brace
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%s: VIA Rhine monitor tick, status %4.4x.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|readw
c_func
(paren
id|ioaddr
op_plus
id|IntrStatus
)paren
)paren
suffix:semicolon
)brace
id|check_duplex
c_func
(paren
id|dev
)paren
suffix:semicolon
id|np-&gt;timer.expires
op_assign
id|RUN_AT
c_func
(paren
id|next_tick
)paren
suffix:semicolon
id|add_timer
c_func
(paren
op_amp
id|np-&gt;timer
)paren
suffix:semicolon
)brace
DECL|function|tx_timeout
r_static
r_void
id|tx_timeout
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
r_struct
id|netdev_private
op_star
id|np
op_assign
(paren
r_struct
id|netdev_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_int
id|ioaddr
op_assign
id|dev-&gt;base_addr
suffix:semicolon
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: Transmit timed out, status %4.4x, PHY status &quot;
l_string|&quot;%4.4x, resetting...&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|readw
c_func
(paren
id|ioaddr
op_plus
id|IntrStatus
)paren
comma
id|mdio_read
c_func
(paren
id|dev
comma
id|np-&gt;phys
(braket
l_int|0
)braket
comma
l_int|1
)paren
)paren
suffix:semicolon
multiline_comment|/* Perhaps we should reinitialize the hardware here. */
id|dev-&gt;if_port
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Stop and restart the chip&squot;s Tx processes . */
multiline_comment|/* Trigger an immediate transmit demand. */
id|dev-&gt;trans_start
op_assign
id|jiffies
suffix:semicolon
id|np-&gt;stats.tx_errors
op_increment
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/* Initialize the Rx and Tx rings, along with various &squot;dev&squot; bits. */
DECL|function|init_ring
r_static
r_void
id|init_ring
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
r_struct
id|netdev_private
op_star
id|np
op_assign
(paren
r_struct
id|netdev_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_int
id|i
suffix:semicolon
id|np-&gt;tx_full
op_assign
l_int|0
suffix:semicolon
id|np-&gt;cur_rx
op_assign
id|np-&gt;cur_tx
op_assign
l_int|0
suffix:semicolon
id|np-&gt;dirty_rx
op_assign
id|np-&gt;dirty_tx
op_assign
l_int|0
suffix:semicolon
id|np-&gt;rx_buf_sz
op_assign
(paren
id|dev-&gt;mtu
op_le
l_int|1500
ques
c_cond
id|PKT_BUF_SZ
suffix:colon
id|dev-&gt;mtu
op_plus
l_int|32
)paren
suffix:semicolon
id|np-&gt;rx_head_desc
op_assign
op_amp
id|np-&gt;rx_ring
(braket
l_int|0
)braket
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|RX_RING_SIZE
suffix:semicolon
id|i
op_increment
)paren
(brace
id|np-&gt;rx_ring
(braket
id|i
)braket
dot
id|rx_status
op_assign
l_int|0
suffix:semicolon
id|np-&gt;rx_ring
(braket
id|i
)braket
dot
id|rx_length
op_assign
l_int|0
suffix:semicolon
id|np-&gt;rx_ring
(braket
id|i
)braket
dot
id|desc_length
op_assign
id|np-&gt;rx_buf_sz
suffix:semicolon
id|np-&gt;rx_ring
(braket
id|i
)braket
dot
id|next_desc
op_assign
id|virt_to_bus
c_func
(paren
op_amp
id|np-&gt;rx_ring
(braket
id|i
op_plus
l_int|1
)braket
)paren
suffix:semicolon
id|np-&gt;rx_skbuff
(braket
id|i
)braket
op_assign
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Mark the last entry as wrapping the ring. */
id|np-&gt;rx_ring
(braket
id|i
op_minus
l_int|1
)braket
dot
id|next_desc
op_assign
id|virt_to_bus
c_func
(paren
op_amp
id|np-&gt;rx_ring
(braket
l_int|0
)braket
)paren
suffix:semicolon
multiline_comment|/* Fill in the Rx buffers. */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|RX_RING_SIZE
suffix:semicolon
id|i
op_increment
)paren
(brace
r_struct
id|sk_buff
op_star
id|skb
op_assign
id|dev_alloc_skb
c_func
(paren
id|np-&gt;rx_buf_sz
)paren
suffix:semicolon
id|np-&gt;rx_skbuff
(braket
id|i
)braket
op_assign
id|skb
suffix:semicolon
r_if
c_cond
(paren
id|skb
op_eq
l_int|NULL
)paren
r_break
suffix:semicolon
id|skb-&gt;dev
op_assign
id|dev
suffix:semicolon
multiline_comment|/* Mark as being used by this device. */
id|np-&gt;rx_ring
(braket
id|i
)braket
dot
id|addr
op_assign
id|virt_to_bus
c_func
(paren
id|skb-&gt;tail
)paren
suffix:semicolon
id|np-&gt;rx_ring
(braket
id|i
)braket
dot
id|rx_status
op_assign
l_int|0
suffix:semicolon
id|np-&gt;rx_ring
(braket
id|i
)braket
dot
id|rx_length
op_assign
id|DescOwn
suffix:semicolon
)brace
id|np-&gt;dirty_rx
op_assign
(paren
r_int
r_int
)paren
(paren
id|i
op_minus
id|RX_RING_SIZE
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|TX_RING_SIZE
suffix:semicolon
id|i
op_increment
)paren
(brace
id|np-&gt;tx_skbuff
(braket
id|i
)braket
op_assign
l_int|0
suffix:semicolon
id|np-&gt;tx_ring
(braket
id|i
)braket
dot
id|tx_own
op_assign
l_int|0
suffix:semicolon
id|np-&gt;tx_ring
(braket
id|i
)braket
dot
id|desc_length
op_assign
l_int|0x00e08000
suffix:semicolon
id|np-&gt;tx_ring
(braket
id|i
)braket
dot
id|next_desc
op_assign
id|virt_to_bus
c_func
(paren
op_amp
id|np-&gt;tx_ring
(braket
id|i
op_plus
l_int|1
)braket
)paren
suffix:semicolon
id|np-&gt;tx_buf
(braket
id|i
)braket
op_assign
id|kmalloc
c_func
(paren
id|PKT_BUF_SZ
comma
id|GFP_KERNEL
)paren
suffix:semicolon
)brace
id|np-&gt;tx_ring
(braket
id|i
op_minus
l_int|1
)braket
dot
id|next_desc
op_assign
id|virt_to_bus
c_func
(paren
op_amp
id|np-&gt;tx_ring
(braket
l_int|0
)braket
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
DECL|function|start_tx
r_static
r_int
id|start_tx
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|device
op_star
id|dev
)paren
(brace
r_struct
id|netdev_private
op_star
id|np
op_assign
(paren
r_struct
id|netdev_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_int
id|entry
suffix:semicolon
multiline_comment|/* Block a timer-based transmit from overlapping.  This could better be&n;&t;   done with atomic_swap(1, dev-&gt;tbusy), but set_bit() works as well. */
r_if
c_cond
(paren
id|test_and_set_bit
c_func
(paren
l_int|0
comma
(paren
r_void
op_star
)paren
op_amp
id|dev-&gt;tbusy
)paren
op_ne
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|jiffies
op_minus
id|dev-&gt;trans_start
OL
id|TX_TIMEOUT
)paren
r_return
l_int|1
suffix:semicolon
id|tx_timeout
c_func
(paren
id|dev
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
multiline_comment|/* Caution: the write order is important here, set the field&n;&t;   with the &quot;ownership&quot; bits last. */
multiline_comment|/* Calculate the next Tx descriptor entry. */
id|entry
op_assign
id|np-&gt;cur_tx
op_mod
id|TX_RING_SIZE
suffix:semicolon
id|np-&gt;tx_skbuff
(braket
id|entry
)braket
op_assign
id|skb
suffix:semicolon
r_if
c_cond
(paren
(paren
r_int
)paren
id|skb-&gt;data
op_amp
l_int|3
)paren
(brace
multiline_comment|/* Must use alignment buffer. */
r_if
c_cond
(paren
id|np-&gt;tx_buf
(braket
id|entry
)braket
op_eq
l_int|NULL
op_logical_and
(paren
id|np-&gt;tx_buf
(braket
id|entry
)braket
op_assign
id|kmalloc
c_func
(paren
id|PKT_BUF_SZ
comma
id|GFP_KERNEL
)paren
)paren
op_eq
l_int|NULL
)paren
r_return
l_int|1
suffix:semicolon
id|memcpy
c_func
(paren
id|np-&gt;tx_buf
(braket
id|entry
)braket
comma
id|skb-&gt;data
comma
id|skb-&gt;len
)paren
suffix:semicolon
id|np-&gt;tx_ring
(braket
id|entry
)braket
dot
id|addr
op_assign
id|virt_to_bus
c_func
(paren
id|np-&gt;tx_buf
(braket
id|entry
)braket
)paren
suffix:semicolon
)brace
r_else
id|np-&gt;tx_ring
(braket
id|entry
)braket
dot
id|addr
op_assign
id|virt_to_bus
c_func
(paren
id|skb-&gt;data
)paren
suffix:semicolon
id|np-&gt;tx_ring
(braket
id|entry
)braket
dot
id|desc_length
op_assign
l_int|0x00E08000
op_or
(paren
id|skb-&gt;len
op_ge
id|ETH_ZLEN
ques
c_cond
id|skb-&gt;len
suffix:colon
id|ETH_ZLEN
)paren
suffix:semicolon
id|np-&gt;tx_ring
(braket
id|entry
)braket
dot
id|tx_own
op_assign
id|DescOwn
suffix:semicolon
id|np-&gt;cur_tx
op_increment
suffix:semicolon
multiline_comment|/* Non-x86 Todo: explicitly flush cache lines here. */
multiline_comment|/* Wake the potentially-idle transmit channel. */
id|writew
c_func
(paren
id|CmdTxDemand
op_or
id|np-&gt;chip_cmd
comma
id|dev-&gt;base_addr
op_plus
id|ChipCmd
)paren
suffix:semicolon
r_if
c_cond
(paren
id|np-&gt;cur_tx
op_minus
id|np-&gt;dirty_tx
OL
id|TX_RING_SIZE
op_minus
l_int|1
)paren
id|clear_bit
c_func
(paren
l_int|0
comma
(paren
r_void
op_star
)paren
op_amp
id|dev-&gt;tbusy
)paren
suffix:semicolon
multiline_comment|/* Typical path */
r_else
id|np-&gt;tx_full
op_assign
l_int|1
suffix:semicolon
id|dev-&gt;trans_start
op_assign
id|jiffies
suffix:semicolon
r_if
c_cond
(paren
id|debug
OG
l_int|4
)paren
(brace
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%s: Transmit frame #%d queued in slot %d.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|np-&gt;cur_tx
comma
id|entry
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* The interrupt handler does all of the Rx thread work and cleans up&n;   after the Tx thread. */
DECL|function|intr_handler
r_static
r_void
id|intr_handler
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_instance
comma
r_struct
id|pt_regs
op_star
id|rgs
)paren
(brace
r_struct
id|device
op_star
id|dev
op_assign
(paren
r_struct
id|device
op_star
)paren
id|dev_instance
suffix:semicolon
r_struct
id|netdev_private
op_star
id|np
suffix:semicolon
r_int
id|ioaddr
comma
id|boguscnt
op_assign
id|max_interrupt_work
suffix:semicolon
id|ioaddr
op_assign
id|dev-&gt;base_addr
suffix:semicolon
id|np
op_assign
(paren
r_struct
id|netdev_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
macro_line|#if defined(__i386__)
multiline_comment|/* A lock to prevent simultaneous entry bug on Intel SMP machines. */
r_if
c_cond
(paren
id|test_and_set_bit
c_func
(paren
l_int|0
comma
(paren
r_void
op_star
)paren
op_amp
id|dev-&gt;interrupt
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: SMP simultaneous entry of an interrupt handler.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|dev-&gt;interrupt
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Avoid halting machine. */
r_return
suffix:semicolon
)brace
macro_line|#else
r_if
c_cond
(paren
id|dev-&gt;interrupt
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: Re-entering the interrupt handler.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|dev-&gt;interrupt
op_assign
l_int|1
suffix:semicolon
macro_line|#endif
r_do
(brace
id|u32
id|intr_status
op_assign
id|readw
c_func
(paren
id|ioaddr
op_plus
id|IntrStatus
)paren
suffix:semicolon
multiline_comment|/* Acknowledge all of the current interrupt sources ASAP. */
id|writew
c_func
(paren
id|intr_status
op_amp
l_int|0xffff
comma
id|ioaddr
op_plus
id|IntrStatus
)paren
suffix:semicolon
r_if
c_cond
(paren
id|debug
OG
l_int|4
)paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%s: Interrupt, status %4.4x.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|intr_status
)paren
suffix:semicolon
r_if
c_cond
(paren
id|intr_status
op_eq
l_int|0
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
id|intr_status
op_amp
(paren
id|IntrRxDone
op_or
id|IntrRxErr
op_or
id|IntrRxDropped
op_or
id|IntrRxWakeUp
op_or
id|IntrRxEmpty
op_or
id|IntrRxNoBuf
)paren
)paren
id|netdev_rx
c_func
(paren
id|dev
)paren
suffix:semicolon
r_for
c_loop
(paren
suffix:semicolon
id|np-&gt;cur_tx
op_minus
id|np-&gt;dirty_tx
OG
l_int|0
suffix:semicolon
id|np-&gt;dirty_tx
op_increment
)paren
(brace
r_int
id|entry
op_assign
id|np-&gt;dirty_tx
op_mod
id|TX_RING_SIZE
suffix:semicolon
r_int
id|txstatus
suffix:semicolon
r_if
c_cond
(paren
id|np-&gt;tx_ring
(braket
id|entry
)braket
dot
id|tx_own
)paren
r_break
suffix:semicolon
id|txstatus
op_assign
id|np-&gt;tx_ring
(braket
id|entry
)braket
dot
id|tx_status
suffix:semicolon
r_if
c_cond
(paren
id|debug
OG
l_int|6
)paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot; Tx scavenge %d status %4.4x.&bslash;n&quot;
comma
id|entry
comma
id|txstatus
)paren
suffix:semicolon
r_if
c_cond
(paren
id|txstatus
op_amp
l_int|0x8000
)paren
(brace
r_if
c_cond
(paren
id|debug
OG
l_int|1
)paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%s: Transmit error, Tx status %4.4x.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|txstatus
)paren
suffix:semicolon
id|np-&gt;stats.tx_errors
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|txstatus
op_amp
l_int|0x0400
)paren
id|np-&gt;stats.tx_carrier_errors
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|txstatus
op_amp
l_int|0x0200
)paren
id|np-&gt;stats.tx_window_errors
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|txstatus
op_amp
l_int|0x0100
)paren
id|np-&gt;stats.tx_aborted_errors
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|txstatus
op_amp
l_int|0x0080
)paren
id|np-&gt;stats.tx_heartbeat_errors
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|txstatus
op_amp
l_int|0x0002
)paren
id|np-&gt;stats.tx_fifo_errors
op_increment
suffix:semicolon
macro_line|#ifdef ETHER_STATS
r_if
c_cond
(paren
id|txstatus
op_amp
l_int|0x0100
)paren
id|np-&gt;stats.collisions16
op_increment
suffix:semicolon
macro_line|#endif
multiline_comment|/* Transmitter restarted in &squot;abnormal&squot; handler. */
)brace
r_else
(brace
macro_line|#ifdef ETHER_STATS
r_if
c_cond
(paren
id|txstatus
op_amp
l_int|0x0001
)paren
id|np-&gt;stats.tx_deferred
op_increment
suffix:semicolon
macro_line|#endif
id|np-&gt;stats.collisions
op_add_assign
(paren
id|txstatus
op_rshift
l_int|3
)paren
op_amp
l_int|15
suffix:semicolon
macro_line|#if defined(NETSTATS_VER2)
id|np-&gt;stats.tx_bytes
op_add_assign
id|np-&gt;tx_ring
(braket
id|entry
)braket
dot
id|desc_length
op_amp
l_int|0x7ff
suffix:semicolon
macro_line|#endif
id|np-&gt;stats.tx_packets
op_increment
suffix:semicolon
)brace
multiline_comment|/* Free the original skb. */
id|dev_free_skb
c_func
(paren
id|np-&gt;tx_skbuff
(braket
id|entry
)braket
)paren
suffix:semicolon
id|np-&gt;tx_skbuff
(braket
id|entry
)braket
op_assign
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|np-&gt;tx_full
op_logical_and
id|dev-&gt;tbusy
op_logical_and
id|np-&gt;cur_tx
op_minus
id|np-&gt;dirty_tx
OL
id|TX_RING_SIZE
op_minus
l_int|4
)paren
(brace
multiline_comment|/* The ring is no longer full, clear tbusy. */
id|np-&gt;tx_full
op_assign
l_int|0
suffix:semicolon
id|clear_bit
c_func
(paren
l_int|0
comma
(paren
r_void
op_star
)paren
op_amp
id|dev-&gt;tbusy
)paren
suffix:semicolon
id|mark_bh
c_func
(paren
id|NET_BH
)paren
suffix:semicolon
)brace
multiline_comment|/* Abnormal error summary/uncommon events handlers. */
r_if
c_cond
(paren
id|intr_status
op_amp
(paren
id|IntrPCIErr
op_or
id|IntrLinkChange
op_or
id|IntrMIIChange
op_or
id|IntrStatsMax
op_or
id|IntrTxAbort
op_or
id|IntrTxUnderrun
)paren
)paren
id|netdev_error
c_func
(paren
id|dev
comma
id|intr_status
)paren
suffix:semicolon
r_if
c_cond
(paren
op_decrement
id|boguscnt
OL
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: Too much work at interrupt, &quot;
l_string|&quot;status=0x%4.4x.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|intr_status
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
r_while
c_loop
(paren
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|debug
OG
l_int|3
)paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%s: exiting interrupt, status=%#4.4x.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|readw
c_func
(paren
id|ioaddr
op_plus
id|IntrStatus
)paren
)paren
suffix:semicolon
macro_line|#if defined(__i386__)
id|clear_bit
c_func
(paren
l_int|0
comma
(paren
r_void
op_star
)paren
op_amp
id|dev-&gt;interrupt
)paren
suffix:semicolon
macro_line|#else
id|dev-&gt;interrupt
op_assign
l_int|0
suffix:semicolon
macro_line|#endif
r_return
suffix:semicolon
)brace
multiline_comment|/* This routine is logically part of the interrupt handler, but isolated&n;   for clarity and better register allocation. */
DECL|function|netdev_rx
r_static
r_int
id|netdev_rx
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
r_struct
id|netdev_private
op_star
id|np
op_assign
(paren
r_struct
id|netdev_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_int
id|entry
op_assign
id|np-&gt;cur_rx
op_mod
id|RX_RING_SIZE
suffix:semicolon
r_int
id|boguscnt
op_assign
id|np-&gt;dirty_rx
op_plus
id|RX_RING_SIZE
op_minus
id|np-&gt;cur_rx
suffix:semicolon
r_if
c_cond
(paren
id|debug
OG
l_int|4
)paren
(brace
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot; In netdev_rx(), entry %d status %4.4x.&bslash;n&quot;
comma
id|entry
comma
id|np-&gt;rx_head_desc-&gt;rx_length
)paren
suffix:semicolon
)brace
multiline_comment|/* If EOP is set on the next entry, it&squot;s a new packet. Send it up. */
r_while
c_loop
(paren
op_logical_neg
(paren
id|np-&gt;rx_head_desc-&gt;rx_length
op_amp
id|DescOwn
)paren
)paren
(brace
r_struct
id|rx_desc
op_star
id|desc
op_assign
id|np-&gt;rx_head_desc
suffix:semicolon
r_int
id|data_size
op_assign
id|desc-&gt;rx_length
suffix:semicolon
id|u16
id|desc_status
op_assign
id|desc-&gt;rx_status
suffix:semicolon
r_if
c_cond
(paren
id|debug
OG
l_int|4
)paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;  netdev_rx() status is %4.4x.&bslash;n&quot;
comma
id|desc_status
)paren
suffix:semicolon
r_if
c_cond
(paren
op_decrement
id|boguscnt
OL
l_int|0
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
(paren
id|desc_status
op_amp
(paren
id|RxWholePkt
op_or
id|RxErr
)paren
)paren
op_ne
id|RxWholePkt
)paren
(brace
r_if
c_cond
(paren
(paren
id|desc_status
op_amp
id|RxWholePkt
)paren
op_ne
id|RxWholePkt
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: Oversized Ethernet frame spanned &quot;
l_string|&quot;multiple buffers, entry %#x length %d status %4.4x!&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|np-&gt;cur_rx
comma
id|data_size
comma
id|desc_status
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: Oversized Ethernet frame %p vs %p.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|np-&gt;rx_head_desc
comma
op_amp
id|np-&gt;rx_ring
(braket
id|np-&gt;cur_rx
op_mod
id|RX_RING_SIZE
)braket
)paren
suffix:semicolon
id|np-&gt;stats.rx_length_errors
op_increment
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|desc_status
op_amp
id|RxErr
)paren
(brace
multiline_comment|/* There was a error. */
r_if
c_cond
(paren
id|debug
OG
l_int|2
)paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;  netdev_rx() Rx error was %8.8x.&bslash;n&quot;
comma
id|desc_status
)paren
suffix:semicolon
id|np-&gt;stats.rx_errors
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|desc_status
op_amp
l_int|0x0030
)paren
id|np-&gt;stats.rx_length_errors
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|desc_status
op_amp
l_int|0x0048
)paren
id|np-&gt;stats.rx_fifo_errors
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|desc_status
op_amp
l_int|0x0004
)paren
id|np-&gt;stats.rx_frame_errors
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|desc_status
op_amp
l_int|0x0002
)paren
id|np-&gt;stats.rx_crc_errors
op_increment
suffix:semicolon
)brace
)brace
r_else
(brace
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
multiline_comment|/* Length should omit the CRC */
id|u16
id|pkt_len
op_assign
id|data_size
op_minus
l_int|4
suffix:semicolon
multiline_comment|/* Check if the packet is long enough to accept without copying&n;&t;&t;&t;   to a minimally-sized skbuff. */
r_if
c_cond
(paren
id|pkt_len
OL
id|rx_copybreak
op_logical_and
(paren
id|skb
op_assign
id|dev_alloc_skb
c_func
(paren
id|pkt_len
op_plus
l_int|2
)paren
)paren
op_ne
l_int|NULL
)paren
(brace
id|skb-&gt;dev
op_assign
id|dev
suffix:semicolon
id|skb_reserve
c_func
(paren
id|skb
comma
l_int|2
)paren
suffix:semicolon
multiline_comment|/* 16 byte align the IP header */
macro_line|#if ! defined(__alpha__) || USE_IP_COPYSUM&t;&t;/* Avoid misaligned on Alpha */
id|eth_copy_and_sum
c_func
(paren
id|skb
comma
id|bus_to_virt
c_func
(paren
id|desc-&gt;addr
)paren
comma
id|pkt_len
comma
l_int|0
)paren
suffix:semicolon
id|skb_put
c_func
(paren
id|skb
comma
id|pkt_len
)paren
suffix:semicolon
macro_line|#else
id|memcpy
c_func
(paren
id|skb_put
c_func
(paren
id|skb
comma
id|pkt_len
)paren
comma
id|bus_to_virt
c_func
(paren
id|desc-&gt;addr
)paren
comma
id|pkt_len
)paren
suffix:semicolon
macro_line|#endif
)brace
r_else
(brace
id|skb_put
c_func
(paren
id|skb
op_assign
id|np-&gt;rx_skbuff
(braket
id|entry
)braket
comma
id|pkt_len
)paren
suffix:semicolon
id|np-&gt;rx_skbuff
(braket
id|entry
)braket
op_assign
l_int|NULL
suffix:semicolon
)brace
id|skb-&gt;protocol
op_assign
id|eth_type_trans
c_func
(paren
id|skb
comma
id|dev
)paren
suffix:semicolon
id|netif_rx
c_func
(paren
id|skb
)paren
suffix:semicolon
id|dev-&gt;last_rx
op_assign
id|jiffies
suffix:semicolon
id|np-&gt;stats.rx_packets
op_increment
suffix:semicolon
)brace
id|entry
op_assign
(paren
op_increment
id|np-&gt;cur_rx
)paren
op_mod
id|RX_RING_SIZE
suffix:semicolon
id|np-&gt;rx_head_desc
op_assign
op_amp
id|np-&gt;rx_ring
(braket
id|entry
)braket
suffix:semicolon
)brace
multiline_comment|/* Refill the Rx ring buffers. */
r_for
c_loop
(paren
suffix:semicolon
id|np-&gt;cur_rx
op_minus
id|np-&gt;dirty_rx
OG
l_int|0
suffix:semicolon
id|np-&gt;dirty_rx
op_increment
)paren
(brace
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
id|entry
op_assign
id|np-&gt;dirty_rx
op_mod
id|RX_RING_SIZE
suffix:semicolon
r_if
c_cond
(paren
id|np-&gt;rx_skbuff
(braket
id|entry
)braket
op_eq
l_int|NULL
)paren
(brace
id|skb
op_assign
id|dev_alloc_skb
c_func
(paren
id|np-&gt;rx_buf_sz
)paren
suffix:semicolon
id|np-&gt;rx_skbuff
(braket
id|entry
)braket
op_assign
id|skb
suffix:semicolon
r_if
c_cond
(paren
id|skb
op_eq
l_int|NULL
)paren
r_break
suffix:semicolon
multiline_comment|/* Better luck next round. */
id|skb-&gt;dev
op_assign
id|dev
suffix:semicolon
multiline_comment|/* Mark as being used by this device. */
id|np-&gt;rx_ring
(braket
id|entry
)braket
dot
id|addr
op_assign
id|virt_to_bus
c_func
(paren
id|skb-&gt;tail
)paren
suffix:semicolon
)brace
id|np-&gt;rx_ring
(braket
id|entry
)braket
dot
id|rx_status
op_assign
l_int|0
suffix:semicolon
id|np-&gt;rx_ring
(braket
id|entry
)braket
dot
id|rx_length
op_assign
id|DescOwn
suffix:semicolon
)brace
multiline_comment|/* Pre-emptively restart Rx engine. */
id|writew
c_func
(paren
id|CmdRxDemand
op_or
id|np-&gt;chip_cmd
comma
id|dev-&gt;base_addr
op_plus
id|ChipCmd
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|netdev_error
r_static
r_void
id|netdev_error
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
r_int
id|intr_status
)paren
(brace
r_struct
id|netdev_private
op_star
id|np
op_assign
(paren
r_struct
id|netdev_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_int
id|ioaddr
op_assign
id|dev-&gt;base_addr
suffix:semicolon
r_if
c_cond
(paren
id|intr_status
op_amp
(paren
id|IntrMIIChange
op_or
id|IntrLinkChange
)paren
)paren
(brace
r_if
c_cond
(paren
id|readb
c_func
(paren
id|ioaddr
op_plus
id|MIIStatus
)paren
op_amp
l_int|0x02
)paren
multiline_comment|/* Link failed, restart autonegotiation. */
id|mdio_write
c_func
(paren
id|dev
comma
id|np-&gt;phys
(braket
l_int|0
)braket
comma
l_int|0
comma
l_int|0x3300
)paren
suffix:semicolon
r_else
id|check_duplex
c_func
(paren
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|debug
)paren
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: MII status changed: Autonegotiation &quot;
l_string|&quot;advertising %4.4x  partner %4.4x.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|mdio_read
c_func
(paren
id|dev
comma
id|np-&gt;phys
(braket
l_int|0
)braket
comma
l_int|4
)paren
comma
id|mdio_read
c_func
(paren
id|dev
comma
id|np-&gt;phys
(braket
l_int|0
)braket
comma
l_int|5
)paren
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|intr_status
op_amp
id|IntrStatsMax
)paren
(brace
id|np-&gt;stats.rx_crc_errors
op_add_assign
id|readw
c_func
(paren
id|ioaddr
op_plus
id|RxCRCErrs
)paren
suffix:semicolon
id|np-&gt;stats.rx_missed_errors
op_add_assign
id|readw
c_func
(paren
id|ioaddr
op_plus
id|RxMissed
)paren
suffix:semicolon
id|writel
c_func
(paren
l_int|0
comma
id|RxMissed
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|intr_status
op_amp
id|IntrTxAbort
)paren
(brace
multiline_comment|/* Stats counted in Tx-done handler, just restart Tx. */
id|writew
c_func
(paren
id|CmdTxDemand
op_or
id|np-&gt;chip_cmd
comma
id|dev-&gt;base_addr
op_plus
id|ChipCmd
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|intr_status
op_amp
id|IntrTxUnderrun
)paren
(brace
r_if
c_cond
(paren
id|np-&gt;tx_thresh
OL
l_int|0xE0
)paren
id|writeb
c_func
(paren
id|np-&gt;tx_thresh
op_add_assign
l_int|0x20
comma
id|ioaddr
op_plus
id|TxConfig
)paren
suffix:semicolon
r_if
c_cond
(paren
id|debug
OG
l_int|1
)paren
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Transmitter underrun, increasing Tx &quot;
l_string|&quot;threshold setting to %2.2x.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|np-&gt;tx_thresh
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|intr_status
op_amp
op_complement
(paren
id|IntrLinkChange
op_or
id|IntrStatsMax
op_or
id|IntrTxAbort
)paren
)paren
op_logical_and
id|debug
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: Something Wicked happened! %4.4x.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|intr_status
)paren
suffix:semicolon
multiline_comment|/* Recovery for other fault sources not known. */
id|writew
c_func
(paren
id|CmdTxDemand
op_or
id|np-&gt;chip_cmd
comma
id|dev-&gt;base_addr
op_plus
id|ChipCmd
)paren
suffix:semicolon
)brace
)brace
DECL|function|get_stats
r_static
r_struct
id|enet_statistics
op_star
id|get_stats
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
r_struct
id|netdev_private
op_star
id|np
op_assign
(paren
r_struct
id|netdev_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_int
id|ioaddr
op_assign
id|dev-&gt;base_addr
suffix:semicolon
multiline_comment|/* Nominally we should lock this segment of code for SMP, although&n;&t;   the vulnerability window is very small and statistics are&n;&t;   non-critical. */
id|np-&gt;stats.rx_crc_errors
op_add_assign
id|readw
c_func
(paren
id|ioaddr
op_plus
id|RxCRCErrs
)paren
suffix:semicolon
id|np-&gt;stats.rx_missed_errors
op_add_assign
id|readw
c_func
(paren
id|ioaddr
op_plus
id|RxMissed
)paren
suffix:semicolon
id|writel
c_func
(paren
l_int|0
comma
id|RxMissed
)paren
suffix:semicolon
r_return
op_amp
id|np-&gt;stats
suffix:semicolon
)brace
multiline_comment|/* The big-endian AUTODIN II ethernet CRC calculation.&n;   N.B. Do not use for bulk data, use a table-based routine instead.&n;   This is common code and should be moved to net/core/crc.c */
DECL|variable|ethernet_polynomial
r_static
r_int
r_const
id|ethernet_polynomial
op_assign
l_int|0x04c11db7U
suffix:semicolon
DECL|function|ether_crc
r_static
r_inline
id|u32
id|ether_crc
c_func
(paren
r_int
id|length
comma
r_int
r_char
op_star
id|data
)paren
(brace
r_int
id|crc
op_assign
op_minus
l_int|1
suffix:semicolon
r_while
c_loop
(paren
op_decrement
id|length
op_ge
l_int|0
)paren
(brace
r_int
r_char
id|current_octet
op_assign
op_star
id|data
op_increment
suffix:semicolon
r_int
id|bit
suffix:semicolon
r_for
c_loop
(paren
id|bit
op_assign
l_int|0
suffix:semicolon
id|bit
OL
l_int|8
suffix:semicolon
id|bit
op_increment
comma
id|current_octet
op_rshift_assign
l_int|1
)paren
(brace
id|crc
op_assign
(paren
id|crc
op_lshift
l_int|1
)paren
op_xor
(paren
(paren
id|crc
OL
l_int|0
)paren
op_xor
(paren
id|current_octet
op_amp
l_int|1
)paren
ques
c_cond
id|ethernet_polynomial
suffix:colon
l_int|0
)paren
suffix:semicolon
)brace
)brace
r_return
id|crc
suffix:semicolon
)brace
DECL|function|set_rx_mode
r_static
r_void
id|set_rx_mode
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
r_struct
id|netdev_private
op_star
id|np
op_assign
(paren
r_struct
id|netdev_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_int
id|ioaddr
op_assign
id|dev-&gt;base_addr
suffix:semicolon
id|u32
id|mc_filter
(braket
l_int|2
)braket
suffix:semicolon
multiline_comment|/* Multicast hash filter */
id|u8
id|rx_mode
suffix:semicolon
multiline_comment|/* Note: 0x02=accept runt, 0x01=accept errs */
r_if
c_cond
(paren
id|dev-&gt;flags
op_amp
id|IFF_PROMISC
)paren
(brace
multiline_comment|/* Set promiscuous. */
multiline_comment|/* Unconditionally log net taps. */
id|printk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;%s: Promiscuous mode enabled.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|rx_mode
op_assign
l_int|0x1C
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
(paren
id|dev-&gt;mc_count
OG
id|multicast_filter_limit
)paren
op_logical_or
(paren
id|dev-&gt;flags
op_amp
id|IFF_ALLMULTI
)paren
)paren
(brace
multiline_comment|/* Too many to match, or accept all multicasts. */
id|rx_mode
op_assign
l_int|0x0C
suffix:semicolon
)brace
r_else
(brace
r_struct
id|dev_mc_list
op_star
id|mclist
suffix:semicolon
r_int
id|i
suffix:semicolon
id|memset
c_func
(paren
id|mc_filter
comma
l_int|0
comma
r_sizeof
(paren
id|mc_filter
)paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
comma
id|mclist
op_assign
id|dev-&gt;mc_list
suffix:semicolon
id|mclist
op_logical_and
id|i
OL
id|dev-&gt;mc_count
suffix:semicolon
id|i
op_increment
comma
id|mclist
op_assign
id|mclist-&gt;next
)paren
(brace
id|set_bit
c_func
(paren
id|ether_crc
c_func
(paren
id|ETH_ALEN
comma
id|mclist-&gt;dmi_addr
)paren
op_rshift
l_int|26
comma
id|mc_filter
)paren
suffix:semicolon
)brace
id|writel
c_func
(paren
id|mc_filter
(braket
l_int|0
)braket
comma
id|ioaddr
op_plus
id|MulticastFilter0
)paren
suffix:semicolon
id|writel
c_func
(paren
id|mc_filter
(braket
l_int|1
)braket
comma
id|ioaddr
op_plus
id|MulticastFilter1
)paren
suffix:semicolon
id|rx_mode
op_assign
l_int|0x0C
suffix:semicolon
)brace
id|writeb
c_func
(paren
id|np-&gt;rx_thresh
op_or
id|rx_mode
comma
id|ioaddr
op_plus
id|RxConfig
)paren
suffix:semicolon
)brace
DECL|function|mii_ioctl
r_static
r_int
id|mii_ioctl
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
r_struct
id|ifreq
op_star
id|rq
comma
r_int
id|cmd
)paren
(brace
id|u16
op_star
id|data
op_assign
(paren
id|u16
op_star
)paren
op_amp
id|rq-&gt;ifr_data
suffix:semicolon
r_switch
c_cond
(paren
id|cmd
)paren
(brace
r_case
id|SIOCDEVPRIVATE
suffix:colon
multiline_comment|/* Get the address of the PHY in use. */
id|data
(braket
l_int|0
)braket
op_assign
(paren
(paren
r_struct
id|netdev_private
op_star
)paren
id|dev-&gt;priv
)paren
op_member_access_from_pointer
id|phys
(braket
l_int|0
)braket
op_amp
l_int|0x1f
suffix:semicolon
multiline_comment|/* Fall Through */
r_case
id|SIOCDEVPRIVATE
op_plus
l_int|1
suffix:colon
multiline_comment|/* Read the specified MII register. */
id|data
(braket
l_int|3
)braket
op_assign
id|mdio_read
c_func
(paren
id|dev
comma
id|data
(braket
l_int|0
)braket
op_amp
l_int|0x1f
comma
id|data
(braket
l_int|1
)braket
op_amp
l_int|0x1f
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
r_case
id|SIOCDEVPRIVATE
op_plus
l_int|2
suffix:colon
multiline_comment|/* Write the specified MII register */
r_if
c_cond
(paren
op_logical_neg
id|suser
c_func
(paren
)paren
)paren
r_return
op_minus
id|EPERM
suffix:semicolon
id|mdio_write
c_func
(paren
id|dev
comma
id|data
(braket
l_int|0
)braket
op_amp
l_int|0x1f
comma
id|data
(braket
l_int|1
)braket
op_amp
l_int|0x1f
comma
id|data
(braket
l_int|2
)braket
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
r_default
suffix:colon
r_return
op_minus
id|EOPNOTSUPP
suffix:semicolon
)brace
)brace
DECL|function|netdev_close
r_static
r_int
id|netdev_close
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
r_int
id|ioaddr
op_assign
id|dev-&gt;base_addr
suffix:semicolon
r_struct
id|netdev_private
op_star
id|np
op_assign
(paren
r_struct
id|netdev_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_int
id|i
suffix:semicolon
id|dev-&gt;start
op_assign
l_int|0
suffix:semicolon
id|dev-&gt;tbusy
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|debug
OG
l_int|1
)paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%s: Shutting down ethercard, status was %4.4x.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|readw
c_func
(paren
id|ioaddr
op_plus
id|ChipCmd
)paren
)paren
suffix:semicolon
multiline_comment|/* Disable interrupts by clearing the interrupt mask. */
id|writew
c_func
(paren
l_int|0x0000
comma
id|ioaddr
op_plus
id|IntrEnable
)paren
suffix:semicolon
multiline_comment|/* Stop the chip&squot;s Tx and Rx processes. */
id|writew
c_func
(paren
id|CmdStop
comma
id|ioaddr
op_plus
id|ChipCmd
)paren
suffix:semicolon
id|del_timer
c_func
(paren
op_amp
id|np-&gt;timer
)paren
suffix:semicolon
id|free_irq
c_func
(paren
id|dev-&gt;irq
comma
id|dev
)paren
suffix:semicolon
multiline_comment|/* Free all the skbuffs in the Rx queue. */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|RX_RING_SIZE
suffix:semicolon
id|i
op_increment
)paren
(brace
id|np-&gt;rx_ring
(braket
id|i
)braket
dot
id|rx_length
op_assign
l_int|0
suffix:semicolon
id|np-&gt;rx_ring
(braket
id|i
)braket
dot
id|addr
op_assign
l_int|0xBADF00D0
suffix:semicolon
multiline_comment|/* An invalid address. */
r_if
c_cond
(paren
id|np-&gt;rx_skbuff
(braket
id|i
)braket
)paren
(brace
macro_line|#if LINUX_VERSION_CODE &lt; 0x20100
id|np-&gt;rx_skbuff
(braket
id|i
)braket
op_member_access_from_pointer
id|free
op_assign
l_int|1
suffix:semicolon
macro_line|#endif
id|dev_free_skb
c_func
(paren
id|np-&gt;rx_skbuff
(braket
id|i
)braket
)paren
suffix:semicolon
)brace
id|np-&gt;rx_skbuff
(braket
id|i
)braket
op_assign
l_int|0
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|TX_RING_SIZE
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|np-&gt;tx_skbuff
(braket
id|i
)braket
)paren
id|dev_free_skb
c_func
(paren
id|np-&gt;tx_skbuff
(braket
id|i
)braket
)paren
suffix:semicolon
id|np-&gt;tx_skbuff
(braket
id|i
)braket
op_assign
l_int|0
suffix:semicolon
)brace
id|MOD_DEC_USE_COUNT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
"&f;"
macro_line|#ifdef MODULE
DECL|function|init_module
r_int
id|init_module
c_func
(paren
r_void
)paren
(brace
r_if
c_cond
(paren
id|debug
)paren
multiline_comment|/* Emit version even if no cards detected. */
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s&quot;
id|KERN_INFO
l_string|&quot;%s&quot;
comma
id|versionA
comma
id|versionB
)paren
suffix:semicolon
macro_line|#ifdef CARDBUS
id|register_driver
c_func
(paren
op_amp
id|etherdev_ops
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
macro_line|#else
r_return
id|pci_etherdev_probe
c_func
(paren
l_int|NULL
comma
id|pci_tbl
)paren
suffix:semicolon
macro_line|#endif
)brace
DECL|function|cleanup_module
r_void
id|cleanup_module
c_func
(paren
r_void
)paren
(brace
macro_line|#ifdef CARDBUS
id|unregister_driver
c_func
(paren
op_amp
id|etherdev_ops
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/* No need to check MOD_IN_USE, as sys_delete_module() checks. */
r_while
c_loop
(paren
id|root_net_dev
)paren
(brace
r_struct
id|netdev_private
op_star
id|np
op_assign
(paren
r_struct
id|netdev_private
op_star
)paren
(paren
id|root_net_dev-&gt;priv
)paren
suffix:semicolon
id|unregister_netdev
c_func
(paren
id|root_net_dev
)paren
suffix:semicolon
macro_line|#ifdef VIA_USE_IO
id|release_region
c_func
(paren
id|root_net_dev-&gt;base_addr
comma
id|pci_tbl
(braket
id|np-&gt;chip_id
)braket
dot
id|io_size
)paren
suffix:semicolon
macro_line|#else
id|iounmap
c_func
(paren
(paren
r_char
op_star
)paren
(paren
id|root_net_dev-&gt;base_addr
)paren
)paren
suffix:semicolon
macro_line|#endif
id|kfree
c_func
(paren
id|root_net_dev
)paren
suffix:semicolon
id|root_net_dev
op_assign
id|np-&gt;next_module
suffix:semicolon
macro_line|#if 0
id|kfree
c_func
(paren
id|np
)paren
suffix:semicolon
multiline_comment|/* Assumption: no struct realignment. */
macro_line|#endif
)brace
)brace
macro_line|#endif  /* MODULE */
"&f;"
multiline_comment|/*&n; * Local variables:&n; *  compile-command: &quot;gcc -DMODULE -D__KERNEL__ -I/usr/src/linux/net/inet -Wall -Wstrict-prototypes -O6 -c via-rhine.c `[ -f /usr/include/linux/modversions.h ] &amp;&amp; echo -DMODVERSIONS`&quot;&n; *  SMP-compile-command: &quot;gcc -D__SMP__ -DMODULE -D__KERNEL__ -I/usr/src/linux/net/inet -Wall -Wstrict-prototypes -O6 -c via-rhine.c `[ -f /usr/include/linux/modversions.h ] &amp;&amp; echo -DMODVERSIONS`&quot;&n; *  c-indent-level: 4&n; *  c-basic-offset: 4&n; *  tab-width: 4&n; * End:&n; */
eof
