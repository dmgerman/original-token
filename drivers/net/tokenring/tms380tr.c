multiline_comment|/*&n; *  tms380tr.c: A network driver library for Texas Instruments TMS380-based&n; *              Token Ring Adapters.&n; *&n; *  Originally sktr.c: Written 1997 by Christoph Goos&n; *&n; *  A fine result of the Linux Systems Network Architecture Project.&n; *  http://www.linux-sna.org&n; *&n; *  This software may be used and distributed according to the terms&n; *  of the GNU Public License, incorporated herein by reference.&n; *&n; *  The following modules are currently available for card support:&n; *&t;- tmspci (Generic PCI card support)&n; *&t;- abyss (Madge PCI support)&n; *  &n; *  The following cards are currently lacking support, even&n; *  though they were supported in previous versions, because&n; *  their code did not get migrated into a seperate module:&n; *&t;- SysKonnect TR4/16(+) ISA&t;(SK-4190)&n; *  They are no longer supported by this driver, at least until&n; *  a module gets written for them.&n; *&n; *  Sources:&n; *  &t;- The hardware related parts of this driver are take from&n; *  &t;  the SysKonnect Token Ring driver for Windows NT.&n; *  &t;- I used the IBM Token Ring driver &squot;ibmtr.c&squot; as a base for this&n; *  &t;  driver, as well as the &squot;skeleton.c&squot; driver by Donald Becker.&n; *  &t;- Also various other drivers in the linux source tree were taken&n; *  &t;  as samples for some tasks.&n; *      - TI TMS380 Second-Generation Token Ring User&squot;s Guide&n; *  &t;- TI datasheets for respective chips&n; *  &t;- David Hein at Texas Instruments &n; *  &t;- Various Madge employees&n; *&n; *  Maintainer(s):&n; *    JS&t;Jay Schulist&t;&t;jschlst@turbolinux.com&n; *    CG&t;Christoph Goos&t;&t;cgoos@syskonnect.de&n; *    AF&t;Adam Fritzler&t;&t;mid@auk.cx&n; *    MLP       Mike Phillips           phillim@amtrak.com&n; *     &n; *  Modification History:&n; *&t;29-Aug-97&t;CG&t;Created&n; *&t;04-Apr-98&t;CG&t;Fixed problems caused by tok_timer_check&n; *&t;10-Apr-98&t;CG&t;Fixed lockups at cable disconnection&n; *&t;27-May-98&t;JS&t;Formated to Linux Kernel Format&n; *&t;31-May-98&t;JS&t;Hacked in PCI support&n; *&t;16-Jun-98&t;JS&t;Modulized for multiple cards with one driver&n; *&t;   Sep-99&t;AF&t;Renamed to tms380tr (supports more than SK&squot;s)&n; *      23-Sep-99&t;AF      Added Compaq and Thomas-Conrad PCI support&n; *&t;&t;&t;&t;Fixed a bug causing double copies on PCI&n; *&t;&t;&t;&t;Fixed for new multicast stuff (2.2/2.3)&n; *&t;25-Sep-99&t;AF&t;Uped TPL_NUM from 3 to 9&n; *&t;&t;&t;&t;Removed extraneous &squot;No free TPL&squot;&n; *&t;22-Dec-99&t;AF&t;Added Madge PCI Mk2 support and generalized&n; *&t;&t;&t;&t;parts of the initilization procedure.&n; *&t;30-Dec-99&t;AF&t;Turned tms380tr into a library ala 8390.&n; *&t;&t;&t;&t;Madge support is provided in the abyss module&n; *&t;&t;&t;&t;Generic PCI support is in the tmspci module.&n; *&n; *  To do:&n; *    1. Multi/Broadcast packet handling (this may have fixed itself)&n; *    2. Write a sktrisa module that includes the old ISA support&n; *    3. Allow modules to load their own microcode&n; *    4. Speed up the BUD process -- freezing the kernel for 3+sec is&n; *         quite unacceptable.&n; *    5. Still a few remaining stalls when the cable is unplugged.&n; */
macro_line|#ifdef MODULE
DECL|variable|version
r_static
r_const
r_char
op_star
id|version
op_assign
l_string|&quot;tms380tr.c: v1.07 21/01/2000 by Christoph Goos, Adam Fritzler&bslash;n&quot;
suffix:semicolon
macro_line|#endif
macro_line|#ifdef MODULE
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/version.h&gt;
macro_line|#endif
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/fcntl.h&gt;
macro_line|#include &lt;linux/interrupt.h&gt;
macro_line|#include &lt;linux/ptrace.h&gt;
macro_line|#include &lt;linux/ioport.h&gt;
macro_line|#include &lt;linux/in.h&gt;
macro_line|#include &lt;linux/malloc.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/time.h&gt;
macro_line|#include &lt;asm/system.h&gt;
macro_line|#include &lt;asm/bitops.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/dma.h&gt;
macro_line|#include &lt;asm/irq.h&gt;
macro_line|#include &lt;asm/uaccess.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/pci.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;linux/netdevice.h&gt;
macro_line|#include &lt;linux/etherdevice.h&gt;
macro_line|#include &lt;linux/skbuff.h&gt;
macro_line|#include &lt;linux/trdevice.h&gt;
macro_line|#include &quot;tms380tr.h&quot;&t;&t;/* Our Stuff */
macro_line|#include &quot;tms380tr_microcode.h&quot;&t;/* TI microcode for COMMprocessor */
multiline_comment|/* Use 0 for production, 1 for verification, 2 for debug, and&n; * 3 for very verbose debug.&n; */
macro_line|#ifndef TMS380TR_DEBUG
DECL|macro|TMS380TR_DEBUG
mdefine_line|#define TMS380TR_DEBUG 0
macro_line|#endif
DECL|variable|tms380tr_debug
r_static
r_int
r_int
id|tms380tr_debug
op_assign
id|TMS380TR_DEBUG
suffix:semicolon
multiline_comment|/* Index to functions, as function prototypes.&n; * Alphabetical by function name.&n; */
multiline_comment|/* &quot;A&quot; */
multiline_comment|/* &quot;B&quot; */
r_static
r_int
id|tms380tr_bringup_diags
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
multiline_comment|/* &quot;C&quot; */
r_static
r_void
id|tms380tr_cancel_tx_queue
c_func
(paren
r_struct
id|net_local
op_star
id|tp
)paren
suffix:semicolon
r_static
r_int
id|tms380tr_chipset_init
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_void
id|tms380tr_chk_irq
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
macro_line|#if 0
r_static
r_int
r_char
id|tms380tr_chk_frame
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_int
r_char
op_star
id|Addr
)paren
suffix:semicolon
macro_line|#endif
r_static
r_void
id|tms380tr_chk_outstanding_cmds
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_void
id|tms380tr_chk_src_addr
c_func
(paren
r_int
r_char
op_star
id|frame
comma
r_int
r_char
op_star
id|hw_addr
)paren
suffix:semicolon
r_static
r_int
r_char
id|tms380tr_chk_ssb
c_func
(paren
r_struct
id|net_local
op_star
id|tp
comma
r_int
r_int
id|IrqType
)paren
suffix:semicolon
r_int
id|tms380tr_close
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_void
id|tms380tr_cmd_status_irq
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
multiline_comment|/* &quot;D&quot; */
r_static
r_void
id|tms380tr_disable_interrupts
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
macro_line|#if TMS380TR_DEBUG &gt; 0
r_static
r_void
id|tms380tr_dump
c_func
(paren
r_int
r_char
op_star
id|Data
comma
r_int
id|length
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/* &quot;E&quot; */
r_static
r_void
id|tms380tr_enable_interrupts
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_void
id|tms380tr_exec_cmd
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_int
r_int
id|Command
)paren
suffix:semicolon
r_static
r_void
id|tms380tr_exec_sifcmd
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_int
r_int
id|WriteValue
)paren
suffix:semicolon
multiline_comment|/* &quot;F&quot; */
multiline_comment|/* &quot;G&quot; */
r_static
r_struct
id|net_device_stats
op_star
id|tms380tr_get_stats
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
multiline_comment|/* &quot;H&quot; */
r_static
r_void
id|tms380tr_hardware_send_packet
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_struct
id|net_local
op_star
id|tp
)paren
suffix:semicolon
multiline_comment|/* &quot;I&quot; */
r_static
r_int
id|tms380tr_init_adapter
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_int
id|tms380tr_init_card
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_void
id|tms380tr_init_ipb
c_func
(paren
r_struct
id|net_local
op_star
id|tp
)paren
suffix:semicolon
r_static
r_void
id|tms380tr_init_net_local
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_void
id|tms380tr_init_opb
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_void
id|tms380tr_interrupt
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
suffix:semicolon
multiline_comment|/* &quot;M&quot; */
multiline_comment|/* &quot;O&quot; */
r_int
id|tms380tr_open
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_void
id|tms380tr_open_adapter
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
multiline_comment|/* &quot;P&quot; */
multiline_comment|/* &quot;R&quot; */
r_static
r_void
id|tms380tr_rcv_status_irq
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_int
id|tms380tr_read_ptr
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_void
id|tms380tr_read_ram
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_int
r_char
op_star
id|Data
comma
r_int
r_int
id|Address
comma
r_int
id|Length
)paren
suffix:semicolon
r_static
r_int
id|tms380tr_reset_adapter
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_void
id|tms380tr_reset_interrupt
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_void
id|tms380tr_ring_status_irq
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
multiline_comment|/* &quot;S&quot; */
r_static
r_int
id|tms380tr_send_packet
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_void
id|tms380tr_set_multicast_list
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_int
id|tms380tr_set_mac_address
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_void
op_star
id|addr
)paren
suffix:semicolon
multiline_comment|/* &quot;T&quot; */
r_static
r_void
id|tms380tr_timer_chk
c_func
(paren
r_int
r_int
id|data
)paren
suffix:semicolon
r_static
r_void
id|tms380tr_timer_end_wait
c_func
(paren
r_int
r_int
id|data
)paren
suffix:semicolon
r_static
r_void
id|tms380tr_tx_status_irq
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
multiline_comment|/* &quot;U&quot; */
r_static
r_void
id|tms380tr_update_rcv_stats
c_func
(paren
r_struct
id|net_local
op_star
id|tp
comma
r_int
r_char
id|DataPtr
(braket
)braket
comma
r_int
r_int
id|Length
)paren
suffix:semicolon
multiline_comment|/* &quot;W&quot; */
r_void
id|tms380tr_wait
c_func
(paren
r_int
r_int
id|time
)paren
suffix:semicolon
r_static
r_void
id|tms380tr_write_rpl_status
c_func
(paren
id|RPL
op_star
id|rpl
comma
r_int
r_int
id|Status
)paren
suffix:semicolon
r_static
r_void
id|tms380tr_write_tpl_status
c_func
(paren
id|TPL
op_star
id|tpl
comma
r_int
r_int
id|Status
)paren
suffix:semicolon
DECL|macro|SIFREADB
mdefine_line|#define SIFREADB(reg) (((struct net_local *)dev-&gt;priv)-&gt;sifreadb(dev, reg))
DECL|macro|SIFWRITEB
mdefine_line|#define SIFWRITEB(val, reg) (((struct net_local *)dev-&gt;priv)-&gt;sifwriteb(dev, val, reg))
DECL|macro|SIFREADW
mdefine_line|#define SIFREADW(reg) (((struct net_local *)dev-&gt;priv)-&gt;sifreadw(dev, reg))
DECL|macro|SIFWRITEW
mdefine_line|#define SIFWRITEW(val, reg) (((struct net_local *)dev-&gt;priv)-&gt;sifwritew(dev, val, reg))
macro_line|#if TMS380TR_DEBUG &gt; 0
DECL|function|madgemc_sifprobe
r_static
r_int
id|madgemc_sifprobe
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_int
r_char
id|old
comma
id|chk1
comma
id|chk2
suffix:semicolon
id|old
op_assign
id|SIFREADB
c_func
(paren
id|SIFADR
)paren
suffix:semicolon
multiline_comment|/* Get the old SIFADR value */
id|chk1
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Begin with check value 0 */
r_do
(brace
id|madgemc_setregpage
c_func
(paren
id|dev
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* Write new SIFADR value */
id|SIFWRITEB
c_func
(paren
id|chk1
comma
id|SIFADR
)paren
suffix:semicolon
id|chk2
op_assign
id|SIFREADB
c_func
(paren
id|SIFADR
)paren
suffix:semicolon
r_if
c_cond
(paren
id|chk2
op_ne
id|chk1
)paren
r_return
op_minus
l_int|1
suffix:semicolon
id|madgemc_setregpage
c_func
(paren
id|dev
comma
l_int|1
)paren
suffix:semicolon
multiline_comment|/* Read, invert and write */
id|chk2
op_assign
id|SIFREADB
c_func
(paren
id|SIFADD
)paren
suffix:semicolon
r_if
c_cond
(paren
id|chk2
op_ne
id|chk1
)paren
r_return
op_minus
l_int|1
suffix:semicolon
id|madgemc_setregpage
c_func
(paren
id|dev
comma
l_int|0
)paren
suffix:semicolon
id|chk2
op_xor_assign
l_int|0x0FE
suffix:semicolon
id|SIFWRITEB
c_func
(paren
id|chk2
comma
id|SIFADR
)paren
suffix:semicolon
multiline_comment|/* Read, invert and compare */
id|madgemc_setregpage
c_func
(paren
id|dev
comma
l_int|1
)paren
suffix:semicolon
id|chk2
op_assign
id|SIFREADB
c_func
(paren
id|SIFADD
)paren
suffix:semicolon
id|madgemc_setregpage
c_func
(paren
id|dev
comma
l_int|0
)paren
suffix:semicolon
id|chk2
op_xor_assign
l_int|0x0FE
suffix:semicolon
r_if
c_cond
(paren
id|chk1
op_ne
id|chk2
)paren
(brace
r_return
(paren
op_minus
l_int|1
)paren
suffix:semicolon
)brace
multiline_comment|/* No adapter */
id|chk1
op_sub_assign
l_int|2
suffix:semicolon
)brace
r_while
c_loop
(paren
id|chk1
op_ne
l_int|0
)paren
(brace
suffix:semicolon
)brace
multiline_comment|/* Repeat 128 times (all byte values) */
id|madgemc_setregpage
c_func
(paren
id|dev
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* sanity */
multiline_comment|/* Restore the SIFADR value */
id|SIFWRITEB
c_func
(paren
id|old
comma
id|SIFADR
)paren
suffix:semicolon
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
macro_line|#endif
multiline_comment|/* Dummy function */
DECL|function|tms380tr_init_card
r_static
r_int
id|__init
id|tms380tr_init_card
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_if
c_cond
(paren
id|tms380tr_debug
OG
l_int|3
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%s: tms380tr_init_card&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
)brace
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Open/initialize the board. This is called sometime after&n; * booting when the &squot;ifconfig&squot; program is run.&n; *&n; * This routine should set everything up anew at each open, even&n; * registers that &quot;should&quot; only need to be set once at boot, so that&n; * there is non-reboot way to recover if something goes wrong.&n; */
DECL|function|tms380tr_open
r_int
id|tms380tr_open
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|net_local
op_star
id|tp
op_assign
(paren
r_struct
id|net_local
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_int
id|err
suffix:semicolon
multiline_comment|/* Reset the hardware here. Don&squot;t forget to set the station address. */
id|err
op_assign
id|tms380tr_chipset_init
c_func
(paren
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Chipset initialization error&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_return
(paren
op_minus
l_int|1
)paren
suffix:semicolon
)brace
id|init_timer
c_func
(paren
op_amp
id|tp-&gt;timer
)paren
suffix:semicolon
id|tp-&gt;timer.expires
op_assign
id|jiffies
op_plus
l_int|30
op_star
id|HZ
suffix:semicolon
id|tp-&gt;timer.function
op_assign
id|tms380tr_timer_end_wait
suffix:semicolon
id|tp-&gt;timer.data
op_assign
(paren
r_int
r_int
)paren
id|dev
suffix:semicolon
id|add_timer
c_func
(paren
op_amp
id|tp-&gt;timer
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Adapter RAM size: %dK&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|tms380tr_read_ptr
c_func
(paren
id|dev
)paren
)paren
suffix:semicolon
id|tms380tr_enable_interrupts
c_func
(paren
id|dev
)paren
suffix:semicolon
id|tms380tr_open_adapter
c_func
(paren
id|dev
)paren
suffix:semicolon
id|netif_start_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
multiline_comment|/* Wait for interrupt from hardware. If interrupt does not come,&n;&t; * there will be a timeout from the timer.&n;&t; */
id|tp-&gt;Sleeping
op_assign
l_int|1
suffix:semicolon
id|interruptible_sleep_on
c_func
(paren
op_amp
id|tp-&gt;wait_for_tok_int
)paren
suffix:semicolon
id|del_timer
c_func
(paren
op_amp
id|tp-&gt;timer
)paren
suffix:semicolon
multiline_comment|/* If AdapterVirtOpenFlag is 1, the adapter is now open for use */
r_if
c_cond
(paren
id|tp-&gt;AdapterVirtOpenFlag
op_eq
l_int|0
)paren
(brace
id|tms380tr_disable_interrupts
c_func
(paren
id|dev
)paren
suffix:semicolon
r_return
(paren
op_minus
l_int|1
)paren
suffix:semicolon
)brace
id|tp-&gt;StartTime
op_assign
id|jiffies
suffix:semicolon
multiline_comment|/* Start function control timer */
id|tp-&gt;timer.expires
op_assign
id|jiffies
op_plus
l_int|2
op_star
id|HZ
suffix:semicolon
id|tp-&gt;timer.function
op_assign
id|tms380tr_timer_chk
suffix:semicolon
id|tp-&gt;timer.data
op_assign
(paren
r_int
r_int
)paren
id|dev
suffix:semicolon
id|add_timer
c_func
(paren
op_amp
id|tp-&gt;timer
)paren
suffix:semicolon
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Timeout function while waiting for event&n; */
DECL|function|tms380tr_timer_end_wait
r_static
r_void
id|tms380tr_timer_end_wait
c_func
(paren
r_int
r_int
id|data
)paren
(brace
r_struct
id|net_device
op_star
id|dev
op_assign
(paren
r_struct
id|net_device
op_star
)paren
id|data
suffix:semicolon
r_struct
id|net_local
op_star
id|tp
op_assign
(paren
r_struct
id|net_local
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_if
c_cond
(paren
id|tp-&gt;Sleeping
)paren
(brace
id|tp-&gt;Sleeping
op_assign
l_int|0
suffix:semicolon
id|wake_up_interruptible
c_func
(paren
op_amp
id|tp-&gt;wait_for_tok_int
)paren
suffix:semicolon
)brace
r_return
suffix:semicolon
)brace
multiline_comment|/*&n; * Initialize the chipset&n; */
DECL|function|tms380tr_chipset_init
r_static
r_int
id|tms380tr_chipset_init
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|net_local
op_star
id|tp
op_assign
(paren
r_struct
id|net_local
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_int
id|err
suffix:semicolon
id|tms380tr_init_ipb
c_func
(paren
id|tp
)paren
suffix:semicolon
id|tms380tr_init_opb
c_func
(paren
id|dev
)paren
suffix:semicolon
id|tms380tr_init_net_local
c_func
(paren
id|dev
)paren
suffix:semicolon
id|err
op_assign
id|tms380tr_reset_adapter
c_func
(paren
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
OL
l_int|0
)paren
(brace
r_return
(paren
op_minus
l_int|1
)paren
suffix:semicolon
)brace
id|err
op_assign
id|tms380tr_bringup_diags
c_func
(paren
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
OL
l_int|0
)paren
(brace
r_return
(paren
op_minus
l_int|1
)paren
suffix:semicolon
)brace
id|err
op_assign
id|tms380tr_init_adapter
c_func
(paren
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
OL
l_int|0
)paren
(brace
r_return
(paren
op_minus
l_int|1
)paren
suffix:semicolon
)brace
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Initializes the net_local structure.&n; */
DECL|function|tms380tr_init_net_local
r_static
r_void
id|tms380tr_init_net_local
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|net_local
op_star
id|tp
op_assign
(paren
r_struct
id|net_local
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_int
id|i
suffix:semicolon
id|tp-&gt;scb.CMD
op_assign
l_int|0
suffix:semicolon
id|tp-&gt;scb.Parm
(braket
l_int|0
)braket
op_assign
l_int|0
suffix:semicolon
id|tp-&gt;scb.Parm
(braket
l_int|1
)braket
op_assign
l_int|0
suffix:semicolon
id|tp-&gt;ssb.STS
op_assign
l_int|0
suffix:semicolon
id|tp-&gt;ssb.Parm
(braket
l_int|0
)braket
op_assign
l_int|0
suffix:semicolon
id|tp-&gt;ssb.Parm
(braket
l_int|1
)braket
op_assign
l_int|0
suffix:semicolon
id|tp-&gt;ssb.Parm
(braket
l_int|2
)braket
op_assign
l_int|0
suffix:semicolon
id|tp-&gt;CMDqueue
op_assign
l_int|0
suffix:semicolon
id|tp-&gt;AdapterOpenFlag
op_assign
l_int|0
suffix:semicolon
id|tp-&gt;AdapterVirtOpenFlag
op_assign
l_int|0
suffix:semicolon
id|tp-&gt;ScbInUse
op_assign
l_int|0
suffix:semicolon
id|tp-&gt;OpenCommandIssued
op_assign
l_int|0
suffix:semicolon
id|tp-&gt;ReOpenInProgress
op_assign
l_int|0
suffix:semicolon
id|tp-&gt;HaltInProgress
op_assign
l_int|0
suffix:semicolon
id|tp-&gt;TransmitHaltScheduled
op_assign
l_int|0
suffix:semicolon
id|tp-&gt;LobeWireFaultLogged
op_assign
l_int|0
suffix:semicolon
id|tp-&gt;LastOpenStatus
op_assign
l_int|0
suffix:semicolon
id|tp-&gt;MaxPacketSize
op_assign
id|DEFAULT_PACKET_SIZE
suffix:semicolon
id|skb_queue_head_init
c_func
(paren
op_amp
id|tp-&gt;SendSkbQueue
)paren
suffix:semicolon
id|tp-&gt;QueueSkb
op_assign
id|MAX_TX_QUEUE
suffix:semicolon
multiline_comment|/* Create circular chain of transmit lists */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|TPL_NUM
suffix:semicolon
id|i
op_increment
)paren
(brace
id|tp-&gt;Tpl
(braket
id|i
)braket
dot
id|NextTPLAddr
op_assign
id|htonl
c_func
(paren
(paren
r_int
r_int
)paren
id|virt_to_bus
c_func
(paren
op_amp
id|tp-&gt;Tpl
(braket
(paren
id|i
op_plus
l_int|1
)paren
op_mod
id|TPL_NUM
)braket
)paren
)paren
suffix:semicolon
id|tp-&gt;Tpl
(braket
id|i
)braket
dot
id|Status
op_assign
l_int|0
suffix:semicolon
id|tp-&gt;Tpl
(braket
id|i
)braket
dot
id|FrameSize
op_assign
l_int|0
suffix:semicolon
id|tp-&gt;Tpl
(braket
id|i
)braket
dot
id|FragList
(braket
l_int|0
)braket
dot
id|DataCount
op_assign
l_int|0
suffix:semicolon
id|tp-&gt;Tpl
(braket
id|i
)braket
dot
id|FragList
(braket
l_int|0
)braket
dot
id|DataAddr
op_assign
l_int|0
suffix:semicolon
id|tp-&gt;Tpl
(braket
id|i
)braket
dot
id|NextTPLPtr
op_assign
op_amp
id|tp-&gt;Tpl
(braket
(paren
id|i
op_plus
l_int|1
)paren
op_mod
id|TPL_NUM
)braket
suffix:semicolon
id|tp-&gt;Tpl
(braket
id|i
)braket
dot
id|MData
op_assign
l_int|NULL
suffix:semicolon
id|tp-&gt;Tpl
(braket
id|i
)braket
dot
id|TPLIndex
op_assign
id|i
suffix:semicolon
id|tp-&gt;Tpl
(braket
id|i
)braket
dot
id|BusyFlag
op_assign
l_int|0
suffix:semicolon
)brace
id|tp-&gt;TplFree
op_assign
id|tp-&gt;TplBusy
op_assign
op_amp
id|tp-&gt;Tpl
(braket
l_int|0
)braket
suffix:semicolon
multiline_comment|/* Create circular chain of receive lists */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|RPL_NUM
suffix:semicolon
id|i
op_increment
)paren
(brace
id|tp-&gt;Rpl
(braket
id|i
)braket
dot
id|NextRPLAddr
op_assign
id|htonl
c_func
(paren
(paren
r_int
r_int
)paren
id|virt_to_bus
c_func
(paren
op_amp
id|tp-&gt;Rpl
(braket
(paren
id|i
op_plus
l_int|1
)paren
op_mod
id|RPL_NUM
)braket
)paren
)paren
suffix:semicolon
id|tp-&gt;Rpl
(braket
id|i
)braket
dot
id|Status
op_assign
(paren
id|RX_VALID
op_or
id|RX_START_FRAME
op_or
id|RX_END_FRAME
op_or
id|RX_FRAME_IRQ
)paren
suffix:semicolon
id|tp-&gt;Rpl
(braket
id|i
)braket
dot
id|FrameSize
op_assign
l_int|0
suffix:semicolon
id|tp-&gt;Rpl
(braket
id|i
)braket
dot
id|FragList
(braket
l_int|0
)braket
dot
id|DataCount
op_assign
id|cpu_to_be16
c_func
(paren
(paren
r_int
r_int
)paren
id|tp-&gt;MaxPacketSize
)paren
suffix:semicolon
multiline_comment|/* Alloc skb and point adapter to data area */
id|tp-&gt;Rpl
(braket
id|i
)braket
dot
id|Skb
op_assign
id|dev_alloc_skb
c_func
(paren
id|tp-&gt;MaxPacketSize
)paren
suffix:semicolon
multiline_comment|/* skb == NULL ? then use local buffer */
r_if
c_cond
(paren
id|tp-&gt;Rpl
(braket
id|i
)braket
dot
id|Skb
op_eq
l_int|NULL
)paren
(brace
id|tp-&gt;Rpl
(braket
id|i
)braket
dot
id|SkbStat
op_assign
id|SKB_UNAVAILABLE
suffix:semicolon
id|tp-&gt;Rpl
(braket
id|i
)braket
dot
id|FragList
(braket
l_int|0
)braket
dot
id|DataAddr
op_assign
id|htonl
c_func
(paren
id|virt_to_bus
c_func
(paren
id|tp-&gt;LocalRxBuffers
(braket
id|i
)braket
)paren
)paren
suffix:semicolon
id|tp-&gt;Rpl
(braket
id|i
)braket
dot
id|MData
op_assign
id|tp-&gt;LocalRxBuffers
(braket
id|i
)braket
suffix:semicolon
)brace
r_else
multiline_comment|/* SKB != NULL */
(brace
id|tp-&gt;Rpl
(braket
id|i
)braket
dot
id|Skb-&gt;dev
op_assign
id|dev
suffix:semicolon
id|skb_put
c_func
(paren
id|tp-&gt;Rpl
(braket
id|i
)braket
dot
id|Skb
comma
id|tp-&gt;MaxPacketSize
)paren
suffix:semicolon
multiline_comment|/* data unreachable for DMA ? then use local buffer */
r_if
c_cond
(paren
id|tp-&gt;dmalimit
op_logical_and
id|virt_to_bus
c_func
(paren
id|tp-&gt;Rpl
(braket
id|i
)braket
dot
id|Skb-&gt;data
)paren
op_plus
id|tp-&gt;MaxPacketSize
OG
id|tp-&gt;dmalimit
)paren
(brace
id|tp-&gt;Rpl
(braket
id|i
)braket
dot
id|SkbStat
op_assign
id|SKB_DATA_COPY
suffix:semicolon
id|tp-&gt;Rpl
(braket
id|i
)braket
dot
id|FragList
(braket
l_int|0
)braket
dot
id|DataAddr
op_assign
id|htonl
c_func
(paren
id|virt_to_bus
c_func
(paren
id|tp-&gt;LocalRxBuffers
(braket
id|i
)braket
)paren
)paren
suffix:semicolon
id|tp-&gt;Rpl
(braket
id|i
)braket
dot
id|MData
op_assign
id|tp-&gt;LocalRxBuffers
(braket
id|i
)braket
suffix:semicolon
)brace
r_else
multiline_comment|/* DMA directly in skb-&gt;data */
(brace
id|tp-&gt;Rpl
(braket
id|i
)braket
dot
id|SkbStat
op_assign
id|SKB_DMA_DIRECT
suffix:semicolon
id|tp-&gt;Rpl
(braket
id|i
)braket
dot
id|FragList
(braket
l_int|0
)braket
dot
id|DataAddr
op_assign
id|htonl
c_func
(paren
id|virt_to_bus
c_func
(paren
id|tp-&gt;Rpl
(braket
id|i
)braket
dot
id|Skb-&gt;data
)paren
)paren
suffix:semicolon
id|tp-&gt;Rpl
(braket
id|i
)braket
dot
id|MData
op_assign
id|tp-&gt;Rpl
(braket
id|i
)braket
dot
id|Skb-&gt;data
suffix:semicolon
)brace
)brace
id|tp-&gt;Rpl
(braket
id|i
)braket
dot
id|NextRPLPtr
op_assign
op_amp
id|tp-&gt;Rpl
(braket
(paren
id|i
op_plus
l_int|1
)paren
op_mod
id|RPL_NUM
)braket
suffix:semicolon
id|tp-&gt;Rpl
(braket
id|i
)braket
dot
id|RPLIndex
op_assign
id|i
suffix:semicolon
)brace
id|tp-&gt;RplHead
op_assign
op_amp
id|tp-&gt;Rpl
(braket
l_int|0
)braket
suffix:semicolon
id|tp-&gt;RplTail
op_assign
op_amp
id|tp-&gt;Rpl
(braket
id|RPL_NUM
op_minus
l_int|1
)braket
suffix:semicolon
id|tp-&gt;RplTail-&gt;Status
op_assign
(paren
id|RX_START_FRAME
op_or
id|RX_END_FRAME
op_or
id|RX_FRAME_IRQ
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/*&n; * Initializes the initialisation parameter block.&n; */
DECL|function|tms380tr_init_ipb
r_static
r_void
id|tms380tr_init_ipb
c_func
(paren
r_struct
id|net_local
op_star
id|tp
)paren
(brace
id|tp-&gt;ipb.Init_Options
op_assign
id|BURST_MODE
suffix:semicolon
id|tp-&gt;ipb.CMD_Status_IV
op_assign
l_int|0
suffix:semicolon
id|tp-&gt;ipb.TX_IV
op_assign
l_int|0
suffix:semicolon
id|tp-&gt;ipb.RX_IV
op_assign
l_int|0
suffix:semicolon
id|tp-&gt;ipb.Ring_Status_IV
op_assign
l_int|0
suffix:semicolon
id|tp-&gt;ipb.SCB_Clear_IV
op_assign
l_int|0
suffix:semicolon
id|tp-&gt;ipb.Adapter_CHK_IV
op_assign
l_int|0
suffix:semicolon
id|tp-&gt;ipb.RX_Burst_Size
op_assign
id|BURST_SIZE
suffix:semicolon
id|tp-&gt;ipb.TX_Burst_Size
op_assign
id|BURST_SIZE
suffix:semicolon
id|tp-&gt;ipb.DMA_Abort_Thrhld
op_assign
id|DMA_RETRIES
suffix:semicolon
id|tp-&gt;ipb.SCB_Addr
op_assign
l_int|0
suffix:semicolon
id|tp-&gt;ipb.SSB_Addr
op_assign
l_int|0
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/*&n; * Initializes the open parameter block.&n; */
DECL|function|tms380tr_init_opb
r_static
r_void
id|tms380tr_init_opb
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|net_local
op_star
id|tp
suffix:semicolon
r_int
r_int
id|Addr
suffix:semicolon
r_int
r_int
id|RplSize
op_assign
id|RPL_SIZE
suffix:semicolon
r_int
r_int
id|TplSize
op_assign
id|TPL_SIZE
suffix:semicolon
r_int
r_int
id|BufferSize
op_assign
id|BUFFER_SIZE
suffix:semicolon
r_int
id|i
suffix:semicolon
id|tp
op_assign
(paren
r_struct
id|net_local
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|tp-&gt;ocpl.OPENOptions
op_assign
l_int|0
suffix:semicolon
id|tp-&gt;ocpl.OPENOptions
op_or_assign
id|ENABLE_FULL_DUPLEX_SELECTION
suffix:semicolon
id|tp-&gt;ocpl.FullDuplex
op_assign
l_int|0
suffix:semicolon
id|tp-&gt;ocpl.FullDuplex
op_or_assign
id|OPEN_FULL_DUPLEX_OFF
suffix:semicolon
multiline_comment|/* &n;&t; * Set node address &n;&t; *&n;&t; * We go ahead and put it in the OPB even though on&n;&t; * most of the generic adapters this isn&squot;t required.&n;&t; * Its simpler this way.  -- ASF&n;&t; */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|6
suffix:semicolon
id|i
op_increment
)paren
id|tp-&gt;ocpl.NodeAddr
(braket
id|i
)braket
op_assign
(paren
(paren
r_int
r_char
op_star
)paren
id|dev-&gt;dev_addr
)paren
(braket
id|i
)braket
suffix:semicolon
id|tp-&gt;ocpl.GroupAddr
op_assign
l_int|0
suffix:semicolon
id|tp-&gt;ocpl.FunctAddr
op_assign
l_int|0
suffix:semicolon
id|tp-&gt;ocpl.RxListSize
op_assign
id|cpu_to_be16
c_func
(paren
(paren
r_int
r_int
)paren
id|RplSize
)paren
suffix:semicolon
id|tp-&gt;ocpl.TxListSize
op_assign
id|cpu_to_be16
c_func
(paren
(paren
r_int
r_int
)paren
id|TplSize
)paren
suffix:semicolon
id|tp-&gt;ocpl.BufSize
op_assign
id|cpu_to_be16
c_func
(paren
(paren
r_int
r_int
)paren
id|BufferSize
)paren
suffix:semicolon
id|tp-&gt;ocpl.Reserved
op_assign
l_int|0
suffix:semicolon
id|tp-&gt;ocpl.TXBufMin
op_assign
id|TX_BUF_MIN
suffix:semicolon
id|tp-&gt;ocpl.TXBufMax
op_assign
id|TX_BUF_MAX
suffix:semicolon
id|Addr
op_assign
id|htonl
c_func
(paren
id|virt_to_bus
c_func
(paren
id|tp-&gt;ProductID
)paren
)paren
suffix:semicolon
id|tp-&gt;ocpl.ProdIDAddr
(braket
l_int|0
)braket
op_assign
id|LOWORD
c_func
(paren
id|Addr
)paren
suffix:semicolon
id|tp-&gt;ocpl.ProdIDAddr
(braket
l_int|1
)braket
op_assign
id|HIWORD
c_func
(paren
id|Addr
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/*&n; * Send OPEN command to adapter&n; */
DECL|function|tms380tr_open_adapter
r_static
r_void
id|tms380tr_open_adapter
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|net_local
op_star
id|tp
op_assign
(paren
r_struct
id|net_local
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_if
c_cond
(paren
id|tp-&gt;OpenCommandIssued
)paren
(brace
r_return
suffix:semicolon
)brace
id|tp-&gt;OpenCommandIssued
op_assign
l_int|1
suffix:semicolon
id|tms380tr_exec_cmd
c_func
(paren
id|dev
comma
id|OC_OPEN
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/*&n; * Clear the adapter&squot;s interrupt flag. Clear system interrupt enable&n; * (SINTEN): disable adapter to system interrupts.&n; */
DECL|function|tms380tr_disable_interrupts
r_static
r_void
id|tms380tr_disable_interrupts
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
id|SIFWRITEB
c_func
(paren
l_int|0
comma
id|SIFACL
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/*&n; * Set the adapter&squot;s interrupt flag. Set system interrupt enable&n; * (SINTEN): enable adapter to system interrupts.&n; */
DECL|function|tms380tr_enable_interrupts
r_static
r_void
id|tms380tr_enable_interrupts
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
id|SIFWRITEB
c_func
(paren
id|ACL_SINTEN
comma
id|SIFACL
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/*&n; * Put command in command queue, try to execute it.&n; */
DECL|function|tms380tr_exec_cmd
r_static
r_void
id|tms380tr_exec_cmd
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_int
r_int
id|Command
)paren
(brace
r_struct
id|net_local
op_star
id|tp
op_assign
(paren
r_struct
id|net_local
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|tp-&gt;CMDqueue
op_or_assign
id|Command
suffix:semicolon
id|tms380tr_chk_outstanding_cmds
c_func
(paren
id|dev
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
DECL|function|tms380tr_timeout
r_static
r_void
id|tms380tr_timeout
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
multiline_comment|/*&n;&t; * If we get here, some higher level has decided we are broken.&n;&t; * There should really be a &quot;kick me&quot; function call instead.&n;&t; *&n;&t; * Resetting the token ring adapter takes a long time so just&n;&t; * fake transmission time and go on trying. Our own timeout&n;&t; * routine is in tms380tr_timer_chk()&n;&t; */
id|dev-&gt;trans_start
op_assign
id|jiffies
suffix:semicolon
id|netif_wake_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Gets skb from system, queues it and checks if it can be sent&n; */
DECL|function|tms380tr_send_packet
r_static
r_int
id|tms380tr_send_packet
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|net_local
op_star
id|tp
op_assign
(paren
r_struct
id|net_local
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
multiline_comment|/*&n;&t; * Block transmits from overlapping. &n;&t; */
id|netif_stop_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tp-&gt;QueueSkb
op_eq
l_int|0
)paren
(brace
r_return
(paren
l_int|1
)paren
suffix:semicolon
)brace
multiline_comment|/* Return with tbusy set: queue full */
id|tp-&gt;QueueSkb
op_decrement
suffix:semicolon
id|skb_queue_tail
c_func
(paren
op_amp
id|tp-&gt;SendSkbQueue
comma
id|skb
)paren
suffix:semicolon
id|tms380tr_hardware_send_packet
c_func
(paren
id|dev
comma
id|tp
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tp-&gt;QueueSkb
OG
l_int|0
)paren
(brace
id|netif_wake_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Move frames from internal skb queue into adapter tx queue&n; */
DECL|function|tms380tr_hardware_send_packet
r_static
r_void
id|tms380tr_hardware_send_packet
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_struct
id|net_local
op_star
id|tp
)paren
(brace
id|TPL
op_star
id|tpl
suffix:semicolon
r_int
id|length
suffix:semicolon
r_int
r_char
op_star
id|buf
comma
op_star
id|newbuf
suffix:semicolon
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
suffix:semicolon
suffix:semicolon
)paren
(brace
multiline_comment|/* Try to get a free TPL from the chain.&n;&t;&t; *&n;&t;&t; * NOTE: We *must* always leave one unused TPL in the chain, &n;&t;&t; * because otherwise the adapter might send frames twice.&n;&t;&t; */
r_if
c_cond
(paren
id|tp-&gt;TplFree-&gt;NextTPLPtr-&gt;BusyFlag
)paren
multiline_comment|/* No free TPL */
(brace
r_if
c_cond
(paren
id|tms380tr_debug
OG
l_int|0
)paren
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: No free TPL&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/* Send first buffer from queue */
id|skb
op_assign
id|skb_dequeue
c_func
(paren
op_amp
id|tp-&gt;SendSkbQueue
)paren
suffix:semicolon
r_if
c_cond
(paren
id|skb
op_eq
l_int|NULL
)paren
(brace
r_return
suffix:semicolon
)brace
id|tp-&gt;QueueSkb
op_increment
suffix:semicolon
multiline_comment|/* Is buffer reachable for Busmaster-DMA? */
r_if
c_cond
(paren
id|tp-&gt;dmalimit
op_logical_and
id|virt_to_bus
c_func
(paren
(paren
r_void
op_star
)paren
(paren
(paren
(paren
r_int
)paren
id|skb-&gt;data
)paren
op_plus
id|skb-&gt;len
)paren
)paren
OG
id|tp-&gt;dmalimit
)paren
(brace
multiline_comment|/* Copy frame to local buffer */
id|i
op_assign
id|tp-&gt;TplFree-&gt;TPLIndex
suffix:semicolon
id|length
op_assign
id|skb-&gt;len
suffix:semicolon
id|buf
op_assign
id|tp-&gt;LocalTxBuffers
(braket
id|i
)braket
suffix:semicolon
id|memcpy
c_func
(paren
id|buf
comma
id|skb-&gt;data
comma
id|length
)paren
suffix:semicolon
id|newbuf
op_assign
id|buf
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* Send direct from skb-&gt;data */
id|length
op_assign
id|skb-&gt;len
suffix:semicolon
id|newbuf
op_assign
id|skb-&gt;data
suffix:semicolon
)brace
multiline_comment|/* Source address in packet? */
id|tms380tr_chk_src_addr
c_func
(paren
id|newbuf
comma
id|dev-&gt;dev_addr
)paren
suffix:semicolon
id|tp-&gt;LastSendTime
op_assign
id|jiffies
suffix:semicolon
id|tpl
op_assign
id|tp-&gt;TplFree
suffix:semicolon
multiline_comment|/* Get the &quot;free&quot; TPL */
id|tpl-&gt;BusyFlag
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* Mark TPL as busy */
id|tp-&gt;TplFree
op_assign
id|tpl-&gt;NextTPLPtr
suffix:semicolon
multiline_comment|/* Save the skb for delayed return of skb to system */
id|tpl-&gt;Skb
op_assign
id|skb
suffix:semicolon
id|tpl-&gt;FragList
(braket
l_int|0
)braket
dot
id|DataCount
op_assign
id|cpu_to_be16
c_func
(paren
(paren
r_int
r_int
)paren
id|length
)paren
suffix:semicolon
id|tpl-&gt;FragList
(braket
l_int|0
)braket
dot
id|DataAddr
op_assign
id|htonl
c_func
(paren
id|virt_to_bus
c_func
(paren
id|newbuf
)paren
)paren
suffix:semicolon
multiline_comment|/* Write the data length in the transmit list. */
id|tpl-&gt;FrameSize
op_assign
id|cpu_to_be16
c_func
(paren
(paren
r_int
r_int
)paren
id|length
)paren
suffix:semicolon
id|tpl-&gt;MData
op_assign
id|newbuf
suffix:semicolon
multiline_comment|/* Transmit the frame and set the status values. */
id|tms380tr_write_tpl_status
c_func
(paren
id|tpl
comma
id|TX_VALID
op_or
id|TX_START_FRAME
op_or
id|TX_END_FRAME
op_or
id|TX_PASS_SRC_ADDR
op_or
id|TX_FRAME_IRQ
)paren
suffix:semicolon
multiline_comment|/* Let adapter send the frame. */
id|tms380tr_exec_sifcmd
c_func
(paren
id|dev
comma
id|CMD_TX_VALID
)paren
suffix:semicolon
)brace
r_return
suffix:semicolon
)brace
multiline_comment|/*&n; * Write the given value to the &squot;Status&squot; field of the specified TPL.&n; * NOTE: This function should be used whenever the status of any TPL must be&n; * modified by the driver, because the compiler may otherwise change the&n; * order of instructions such that writing the TPL status may be executed at&n; * an undesireable time. When this function is used, the status is always&n; * written when the function is called.&n; */
DECL|function|tms380tr_write_tpl_status
r_static
r_void
id|tms380tr_write_tpl_status
c_func
(paren
id|TPL
op_star
id|tpl
comma
r_int
r_int
id|Status
)paren
(brace
id|tpl-&gt;Status
op_assign
id|Status
suffix:semicolon
)brace
DECL|function|tms380tr_chk_src_addr
r_static
r_void
id|tms380tr_chk_src_addr
c_func
(paren
r_int
r_char
op_star
id|frame
comma
r_int
r_char
op_star
id|hw_addr
)paren
(brace
r_int
r_char
id|SRBit
suffix:semicolon
r_if
c_cond
(paren
(paren
(paren
(paren
r_int
r_int
)paren
id|frame
(braket
l_int|8
)braket
)paren
op_amp
op_complement
l_int|0x80
)paren
op_ne
l_int|0
)paren
(brace
multiline_comment|/* Compare 4 bytes */
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
r_int
r_int
)paren
id|frame
(braket
l_int|12
)braket
op_ne
l_int|0
)paren
(brace
multiline_comment|/* Compare 2 bytes */
r_return
suffix:semicolon
)brace
id|SRBit
op_assign
id|frame
(braket
l_int|8
)braket
op_amp
l_int|0x80
suffix:semicolon
id|memcpy
c_func
(paren
op_amp
id|frame
(braket
l_int|8
)braket
comma
id|hw_addr
comma
l_int|6
)paren
suffix:semicolon
id|frame
(braket
l_int|8
)braket
op_or_assign
id|SRBit
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/*&n; * The timer routine: Check if adapter still open and working, reopen if not. &n; */
DECL|function|tms380tr_timer_chk
r_static
r_void
id|tms380tr_timer_chk
c_func
(paren
r_int
r_int
id|data
)paren
(brace
r_struct
id|net_device
op_star
id|dev
op_assign
(paren
r_struct
id|net_device
op_star
)paren
id|data
suffix:semicolon
r_struct
id|net_local
op_star
id|tp
op_assign
(paren
r_struct
id|net_local
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_if
c_cond
(paren
id|tp-&gt;HaltInProgress
)paren
(brace
r_return
suffix:semicolon
)brace
id|tms380tr_chk_outstanding_cmds
c_func
(paren
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|time_before
c_func
(paren
id|tp-&gt;LastSendTime
op_plus
id|SEND_TIMEOUT
comma
id|jiffies
)paren
op_logical_and
(paren
id|tp-&gt;QueueSkb
OL
id|MAX_TX_QUEUE
op_logical_or
id|tp-&gt;TplFree
op_ne
id|tp-&gt;TplBusy
)paren
)paren
(brace
multiline_comment|/* Anything to send, but stalled to long */
id|tp-&gt;LastSendTime
op_assign
id|jiffies
suffix:semicolon
id|tms380tr_exec_cmd
c_func
(paren
id|dev
comma
id|OC_CLOSE
)paren
suffix:semicolon
multiline_comment|/* Does reopen automatically */
)brace
id|tp-&gt;timer.expires
op_assign
id|jiffies
op_plus
l_int|2
op_star
id|HZ
suffix:semicolon
id|add_timer
c_func
(paren
op_amp
id|tp-&gt;timer
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tp-&gt;AdapterOpenFlag
op_logical_or
id|tp-&gt;ReOpenInProgress
)paren
(brace
r_return
suffix:semicolon
)brace
id|tp-&gt;ReOpenInProgress
op_assign
l_int|1
suffix:semicolon
id|tms380tr_open_adapter
c_func
(paren
id|dev
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/*&n; * The typical workload of the driver: Handle the network interface interrupts.&n; */
DECL|function|tms380tr_interrupt
r_void
id|tms380tr_interrupt
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_struct
id|net_device
op_star
id|dev
op_assign
id|dev_id
suffix:semicolon
r_struct
id|net_local
op_star
id|tp
suffix:semicolon
r_int
r_int
id|irq_type
suffix:semicolon
r_if
c_cond
(paren
id|dev
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%s: irq %d for unknown device.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|irq
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|tp
op_assign
(paren
r_struct
id|net_local
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|irq_type
op_assign
id|SIFREADW
c_func
(paren
id|SIFSTS
)paren
suffix:semicolon
r_while
c_loop
(paren
id|irq_type
op_amp
id|STS_SYSTEM_IRQ
)paren
(brace
id|irq_type
op_and_assign
id|STS_IRQ_MASK
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|tms380tr_chk_ssb
c_func
(paren
id|tp
comma
id|irq_type
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: DATA LATE occurred&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_switch
c_cond
(paren
id|irq_type
)paren
(brace
r_case
id|STS_IRQ_RECEIVE_STATUS
suffix:colon
id|tms380tr_reset_interrupt
c_func
(paren
id|dev
)paren
suffix:semicolon
id|tms380tr_rcv_status_irq
c_func
(paren
id|dev
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|STS_IRQ_TRANSMIT_STATUS
suffix:colon
multiline_comment|/* Check if TRANSMIT.HALT command is complete */
r_if
c_cond
(paren
id|tp-&gt;ssb.Parm
(braket
l_int|0
)braket
op_amp
id|COMMAND_COMPLETE
)paren
(brace
id|tp-&gt;TransmitCommandActive
op_assign
l_int|0
suffix:semicolon
id|tp-&gt;TransmitHaltScheduled
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Issue a new transmit command. */
id|tms380tr_exec_cmd
c_func
(paren
id|dev
comma
id|OC_TRANSMIT
)paren
suffix:semicolon
)brace
id|tms380tr_reset_interrupt
c_func
(paren
id|dev
)paren
suffix:semicolon
id|tms380tr_tx_status_irq
c_func
(paren
id|dev
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|STS_IRQ_COMMAND_STATUS
suffix:colon
multiline_comment|/* The SSB contains status of last command&n;&t;&t;&t; * other than receive/transmit.&n;&t;&t;&t; */
id|tms380tr_cmd_status_irq
c_func
(paren
id|dev
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|STS_IRQ_SCB_CLEAR
suffix:colon
multiline_comment|/* The SCB is free for another command. */
id|tp-&gt;ScbInUse
op_assign
l_int|0
suffix:semicolon
id|tms380tr_chk_outstanding_cmds
c_func
(paren
id|dev
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|STS_IRQ_RING_STATUS
suffix:colon
id|tms380tr_ring_status_irq
c_func
(paren
id|dev
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|STS_IRQ_ADAPTER_CHECK
suffix:colon
id|tms380tr_chk_irq
c_func
(paren
id|dev
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|STS_IRQ_LLC_STATUS
suffix:colon
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;tms380tr: unexpected LLC status IRQ&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|STS_IRQ_TIMER
suffix:colon
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;tms380tr: unexpected Timer IRQ&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|STS_IRQ_RECEIVE_PENDING
suffix:colon
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;tms380tr: unexpected Receive Pending IRQ&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;Unknown Token Ring IRQ (0x%04x)&bslash;n&quot;
comma
id|irq_type
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
multiline_comment|/* Reset system interrupt if not already done. */
r_if
c_cond
(paren
id|irq_type
op_ne
id|STS_IRQ_TRANSMIT_STATUS
op_logical_and
id|irq_type
op_ne
id|STS_IRQ_RECEIVE_STATUS
)paren
(brace
id|tms380tr_reset_interrupt
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
id|irq_type
op_assign
id|SIFREADW
c_func
(paren
id|SIFSTS
)paren
suffix:semicolon
)brace
r_return
suffix:semicolon
)brace
multiline_comment|/*&n; *  Reset the INTERRUPT SYSTEM bit and issue SSB CLEAR command.&n; */
DECL|function|tms380tr_reset_interrupt
r_static
r_void
id|tms380tr_reset_interrupt
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|net_local
op_star
id|tp
op_assign
(paren
r_struct
id|net_local
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|SSB
op_star
id|ssb
op_assign
op_amp
id|tp-&gt;ssb
suffix:semicolon
multiline_comment|/*&n;&t; * [Workaround for &quot;Data Late&quot;]&n;&t; * Set all fields of the SSB to well-defined values so we can&n;&t; * check if the adapter has written the SSB.&n;&t; */
id|ssb-&gt;STS
op_assign
(paren
r_int
r_int
)paren
op_minus
l_int|1
suffix:semicolon
id|ssb-&gt;Parm
(braket
l_int|0
)braket
op_assign
(paren
r_int
r_int
)paren
op_minus
l_int|1
suffix:semicolon
id|ssb-&gt;Parm
(braket
l_int|1
)braket
op_assign
(paren
r_int
r_int
)paren
op_minus
l_int|1
suffix:semicolon
id|ssb-&gt;Parm
(braket
l_int|2
)braket
op_assign
(paren
r_int
r_int
)paren
op_minus
l_int|1
suffix:semicolon
multiline_comment|/* Free SSB by issuing SSB_CLEAR command after reading IRQ code&n;&t; * and clear STS_SYSTEM_IRQ bit: enable adapter for further interrupts.&n;&t; */
id|tms380tr_exec_sifcmd
c_func
(paren
id|dev
comma
id|CMD_SSB_CLEAR
op_or
id|CMD_CLEAR_SYSTEM_IRQ
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/*&n; * Check if the SSB has actually been written by the adapter.&n; */
DECL|function|tms380tr_chk_ssb
r_static
r_int
r_char
id|tms380tr_chk_ssb
c_func
(paren
r_struct
id|net_local
op_star
id|tp
comma
r_int
r_int
id|IrqType
)paren
(brace
id|SSB
op_star
id|ssb
op_assign
op_amp
id|tp-&gt;ssb
suffix:semicolon
multiline_comment|/* The address of the SSB. */
multiline_comment|/* C 0 1 2 INTERRUPT CODE&n;&t; * - - - - --------------&n;&t; * 1 1 1 1 TRANSMIT STATUS&n;&t; * 1 1 1 1 RECEIVE STATUS&n;&t; * 1 ? ? 0 COMMAND STATUS&n;&t; * 0 0 0 0 SCB CLEAR&n;&t; * 1 1 0 0 RING STATUS&n;&t; * 0 0 0 0 ADAPTER CHECK&n;&t; *&n;&t; * 0 = SSB field not affected by interrupt&n;&t; * 1 = SSB field is affected by interrupt&n;&t; *&n;&t; * C = SSB ADDRESS +0: COMMAND&n;&t; * 0 = SSB ADDRESS +2: STATUS 0&n;&t; * 1 = SSB ADDRESS +4: STATUS 1&n;&t; * 2 = SSB ADDRESS +6: STATUS 2&n;&t; */
multiline_comment|/* Check if this interrupt does use the SSB. */
r_if
c_cond
(paren
id|IrqType
op_ne
id|STS_IRQ_TRANSMIT_STATUS
op_logical_and
id|IrqType
op_ne
id|STS_IRQ_RECEIVE_STATUS
op_logical_and
id|IrqType
op_ne
id|STS_IRQ_COMMAND_STATUS
op_logical_and
id|IrqType
op_ne
id|STS_IRQ_RING_STATUS
)paren
(brace
r_return
(paren
l_int|1
)paren
suffix:semicolon
multiline_comment|/* SSB not involved. */
)brace
multiline_comment|/* Note: All fields of the SSB have been set to all ones (-1) after it&n;&t; * has last been used by the software (see DriverIsr()).&n;&t; *&n;&t; * Check if the affected SSB fields are still unchanged.&n;&t; */
r_if
c_cond
(paren
id|ssb-&gt;STS
op_eq
(paren
r_int
r_int
)paren
op_minus
l_int|1
)paren
(brace
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
multiline_comment|/* Command field not yet available. */
r_if
c_cond
(paren
id|IrqType
op_eq
id|STS_IRQ_COMMAND_STATUS
)paren
(brace
r_return
(paren
l_int|1
)paren
suffix:semicolon
)brace
multiline_comment|/* Status fields not always affected. */
r_if
c_cond
(paren
id|ssb-&gt;Parm
(braket
l_int|0
)braket
op_eq
(paren
r_int
r_int
)paren
op_minus
l_int|1
)paren
(brace
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
multiline_comment|/* Status 1 field not yet available. */
r_if
c_cond
(paren
id|IrqType
op_eq
id|STS_IRQ_RING_STATUS
)paren
(brace
r_return
(paren
l_int|1
)paren
suffix:semicolon
)brace
multiline_comment|/* Status 2 &amp; 3 fields not affected. */
multiline_comment|/* Note: At this point, the interrupt is either TRANSMIT or RECEIVE. */
r_if
c_cond
(paren
id|ssb-&gt;Parm
(braket
l_int|1
)braket
op_eq
(paren
r_int
r_int
)paren
op_minus
l_int|1
)paren
(brace
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
multiline_comment|/* Status 2 field not yet available. */
r_if
c_cond
(paren
id|ssb-&gt;Parm
(braket
l_int|2
)braket
op_eq
(paren
r_int
r_int
)paren
op_minus
l_int|1
)paren
(brace
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
multiline_comment|/* Status 3 field not yet available. */
r_return
(paren
l_int|1
)paren
suffix:semicolon
multiline_comment|/* All SSB fields have been written by the adapter. */
)brace
multiline_comment|/*&n; * Evaluates the command results status in the SSB status field.&n; */
DECL|function|tms380tr_cmd_status_irq
r_static
r_void
id|tms380tr_cmd_status_irq
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|net_local
op_star
id|tp
op_assign
(paren
r_struct
id|net_local
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_int
r_int
id|ssb_cmd
comma
id|ssb_parm_0
suffix:semicolon
r_int
r_int
id|ssb_parm_1
suffix:semicolon
r_char
op_star
id|open_err
op_assign
l_string|&quot;Open error -&quot;
suffix:semicolon
r_char
op_star
id|code_err
op_assign
l_string|&quot;Open code -&quot;
suffix:semicolon
multiline_comment|/* Copy the ssb values to local variables */
id|ssb_cmd
op_assign
id|tp-&gt;ssb.STS
suffix:semicolon
id|ssb_parm_0
op_assign
id|tp-&gt;ssb.Parm
(braket
l_int|0
)braket
suffix:semicolon
id|ssb_parm_1
op_assign
id|tp-&gt;ssb.Parm
(braket
l_int|1
)braket
suffix:semicolon
r_if
c_cond
(paren
id|ssb_cmd
op_eq
id|OPEN
)paren
(brace
id|tp-&gt;Sleeping
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|tp-&gt;ReOpenInProgress
)paren
(brace
id|wake_up_interruptible
c_func
(paren
op_amp
id|tp-&gt;wait_for_tok_int
)paren
suffix:semicolon
)brace
id|tp-&gt;OpenCommandIssued
op_assign
l_int|0
suffix:semicolon
id|tp-&gt;ScbInUse
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
(paren
id|ssb_parm_0
op_amp
l_int|0x00FF
)paren
op_eq
id|GOOD_COMPLETION
)paren
(brace
multiline_comment|/* Success, the adapter is open. */
id|tp-&gt;LobeWireFaultLogged
op_assign
l_int|0
suffix:semicolon
id|tp-&gt;AdapterOpenFlag
op_assign
l_int|1
suffix:semicolon
id|tp-&gt;AdapterVirtOpenFlag
op_assign
l_int|1
suffix:semicolon
id|tp-&gt;TransmitCommandActive
op_assign
l_int|0
suffix:semicolon
id|tms380tr_exec_cmd
c_func
(paren
id|dev
comma
id|OC_TRANSMIT
)paren
suffix:semicolon
id|tms380tr_exec_cmd
c_func
(paren
id|dev
comma
id|OC_RECEIVE
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tp-&gt;ReOpenInProgress
)paren
(brace
id|tp-&gt;ReOpenInProgress
op_assign
l_int|0
suffix:semicolon
)brace
r_return
suffix:semicolon
)brace
r_else
multiline_comment|/* The adapter did not open. */
(brace
r_if
c_cond
(paren
id|ssb_parm_0
op_amp
id|NODE_ADDR_ERROR
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Node address error&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ssb_parm_0
op_amp
id|LIST_SIZE_ERROR
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: List size error&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ssb_parm_0
op_amp
id|BUF_SIZE_ERROR
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Buffer size error&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ssb_parm_0
op_amp
id|TX_BUF_COUNT_ERROR
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Tx buffer count error&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ssb_parm_0
op_amp
id|INVALID_OPEN_OPTION
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Invalid open option&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ssb_parm_0
op_amp
id|OPEN_ERROR
)paren
(brace
multiline_comment|/* Show the open phase. */
r_switch
c_cond
(paren
id|ssb_parm_0
op_amp
id|OPEN_PHASES_MASK
)paren
(brace
r_case
id|LOBE_MEDIA_TEST
suffix:colon
r_if
c_cond
(paren
op_logical_neg
id|tp-&gt;LobeWireFaultLogged
)paren
(brace
id|tp-&gt;LobeWireFaultLogged
op_assign
l_int|1
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: %s Lobe wire fault (check cable !).&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|open_err
)paren
suffix:semicolon
)brace
id|tp-&gt;ReOpenInProgress
op_assign
l_int|1
suffix:semicolon
id|tp-&gt;AdapterOpenFlag
op_assign
l_int|0
suffix:semicolon
id|tp-&gt;AdapterVirtOpenFlag
op_assign
l_int|1
suffix:semicolon
id|tms380tr_open_adapter
c_func
(paren
id|dev
)paren
suffix:semicolon
r_return
suffix:semicolon
r_case
id|PHYSICAL_INSERTION
suffix:colon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: %s Physical insertion.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|open_err
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ADDRESS_VERIFICATION
suffix:colon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: %s Address verification.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|open_err
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|PARTICIPATION_IN_RING_POLL
suffix:colon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: %s Participation in ring poll.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|open_err
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|REQUEST_INITIALISATION
suffix:colon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: %s Request initialisation.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|open_err
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|FULLDUPLEX_CHECK
suffix:colon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: %s Full duplex check.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|open_err
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: %s Unknown open phase&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|open_err
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
multiline_comment|/* Show the open errors. */
r_switch
c_cond
(paren
id|ssb_parm_0
op_amp
id|OPEN_ERROR_CODES_MASK
)paren
(brace
r_case
id|OPEN_FUNCTION_FAILURE
suffix:colon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: %s OPEN_FUNCTION_FAILURE&quot;
comma
id|dev-&gt;name
comma
id|code_err
)paren
suffix:semicolon
id|tp-&gt;LastOpenStatus
op_assign
id|OPEN_FUNCTION_FAILURE
suffix:semicolon
r_break
suffix:semicolon
r_case
id|OPEN_SIGNAL_LOSS
suffix:colon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: %s OPEN_SIGNAL_LOSS&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|code_err
)paren
suffix:semicolon
id|tp-&gt;LastOpenStatus
op_assign
id|OPEN_SIGNAL_LOSS
suffix:semicolon
r_break
suffix:semicolon
r_case
id|OPEN_TIMEOUT
suffix:colon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: %s OPEN_TIMEOUT&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|code_err
)paren
suffix:semicolon
id|tp-&gt;LastOpenStatus
op_assign
id|OPEN_TIMEOUT
suffix:semicolon
r_break
suffix:semicolon
r_case
id|OPEN_RING_FAILURE
suffix:colon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: %s OPEN_RING_FAILURE&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|code_err
)paren
suffix:semicolon
id|tp-&gt;LastOpenStatus
op_assign
id|OPEN_RING_FAILURE
suffix:semicolon
r_break
suffix:semicolon
r_case
id|OPEN_RING_BEACONING
suffix:colon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: %s OPEN_RING_BEACONING&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|code_err
)paren
suffix:semicolon
id|tp-&gt;LastOpenStatus
op_assign
id|OPEN_RING_BEACONING
suffix:semicolon
r_break
suffix:semicolon
r_case
id|OPEN_DUPLICATE_NODEADDR
suffix:colon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: %s OPEN_DUPLICATE_NODEADDR&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|code_err
)paren
suffix:semicolon
id|tp-&gt;LastOpenStatus
op_assign
id|OPEN_DUPLICATE_NODEADDR
suffix:semicolon
r_break
suffix:semicolon
r_case
id|OPEN_REQUEST_INIT
suffix:colon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: %s OPEN_REQUEST_INIT&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|code_err
)paren
suffix:semicolon
id|tp-&gt;LastOpenStatus
op_assign
id|OPEN_REQUEST_INIT
suffix:semicolon
r_break
suffix:semicolon
r_case
id|OPEN_REMOVE_RECEIVED
suffix:colon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: %s OPEN_REMOVE_RECEIVED&quot;
comma
id|dev-&gt;name
comma
id|code_err
)paren
suffix:semicolon
id|tp-&gt;LastOpenStatus
op_assign
id|OPEN_REMOVE_RECEIVED
suffix:semicolon
r_break
suffix:semicolon
r_case
id|OPEN_FULLDUPLEX_SET
suffix:colon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: %s OPEN_FULLDUPLEX_SET&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|code_err
)paren
suffix:semicolon
id|tp-&gt;LastOpenStatus
op_assign
id|OPEN_FULLDUPLEX_SET
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: %s Unknown open err code&quot;
comma
id|dev-&gt;name
comma
id|code_err
)paren
suffix:semicolon
id|tp-&gt;LastOpenStatus
op_assign
id|OPEN_FUNCTION_FAILURE
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
id|tp-&gt;AdapterOpenFlag
op_assign
l_int|0
suffix:semicolon
id|tp-&gt;AdapterVirtOpenFlag
op_assign
l_int|0
suffix:semicolon
r_return
suffix:semicolon
)brace
)brace
r_else
(brace
r_if
c_cond
(paren
id|ssb_cmd
op_ne
id|READ_ERROR_LOG
)paren
(brace
r_return
suffix:semicolon
)brace
multiline_comment|/* Add values from the error log table to the MAC&n;&t;&t; * statistics counters and update the errorlogtable&n;&t;&t; * memory.&n;&t;&t; */
id|tp-&gt;MacStat.line_errors
op_add_assign
id|tp-&gt;errorlogtable.Line_Error
suffix:semicolon
id|tp-&gt;MacStat.burst_errors
op_add_assign
id|tp-&gt;errorlogtable.Burst_Error
suffix:semicolon
id|tp-&gt;MacStat.A_C_errors
op_add_assign
id|tp-&gt;errorlogtable.ARI_FCI_Error
suffix:semicolon
id|tp-&gt;MacStat.lost_frames
op_add_assign
id|tp-&gt;errorlogtable.Lost_Frame_Error
suffix:semicolon
id|tp-&gt;MacStat.recv_congest_count
op_add_assign
id|tp-&gt;errorlogtable.Rx_Congest_Error
suffix:semicolon
id|tp-&gt;MacStat.rx_errors
op_add_assign
id|tp-&gt;errorlogtable.Rx_Congest_Error
suffix:semicolon
id|tp-&gt;MacStat.frame_copied_errors
op_add_assign
id|tp-&gt;errorlogtable.Frame_Copied_Error
suffix:semicolon
id|tp-&gt;MacStat.token_errors
op_add_assign
id|tp-&gt;errorlogtable.Token_Error
suffix:semicolon
id|tp-&gt;MacStat.dummy1
op_add_assign
id|tp-&gt;errorlogtable.DMA_Bus_Error
suffix:semicolon
id|tp-&gt;MacStat.dummy1
op_add_assign
id|tp-&gt;errorlogtable.DMA_Parity_Error
suffix:semicolon
id|tp-&gt;MacStat.abort_delimiters
op_add_assign
id|tp-&gt;errorlogtable.AbortDelimeters
suffix:semicolon
id|tp-&gt;MacStat.frequency_errors
op_add_assign
id|tp-&gt;errorlogtable.Frequency_Error
suffix:semicolon
id|tp-&gt;MacStat.internal_errors
op_add_assign
id|tp-&gt;errorlogtable.Internal_Error
suffix:semicolon
)brace
r_return
suffix:semicolon
)brace
multiline_comment|/*&n; * The inverse routine to tms380tr_open().&n; */
DECL|function|tms380tr_close
r_int
id|tms380tr_close
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|net_local
op_star
id|tp
op_assign
(paren
r_struct
id|net_local
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|netif_stop_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
id|del_timer
c_func
(paren
op_amp
id|tp-&gt;timer
)paren
suffix:semicolon
multiline_comment|/* Flush the Tx and disable Rx here. */
id|tp-&gt;HaltInProgress
op_assign
l_int|1
suffix:semicolon
id|tms380tr_exec_cmd
c_func
(paren
id|dev
comma
id|OC_CLOSE
)paren
suffix:semicolon
id|tp-&gt;timer.expires
op_assign
id|jiffies
op_plus
l_int|1
op_star
id|HZ
suffix:semicolon
id|tp-&gt;timer.function
op_assign
id|tms380tr_timer_end_wait
suffix:semicolon
id|tp-&gt;timer.data
op_assign
(paren
r_int
r_int
)paren
id|dev
suffix:semicolon
id|add_timer
c_func
(paren
op_amp
id|tp-&gt;timer
)paren
suffix:semicolon
id|tms380tr_enable_interrupts
c_func
(paren
id|dev
)paren
suffix:semicolon
id|tp-&gt;Sleeping
op_assign
l_int|1
suffix:semicolon
id|interruptible_sleep_on
c_func
(paren
op_amp
id|tp-&gt;wait_for_tok_int
)paren
suffix:semicolon
id|tp-&gt;TransmitCommandActive
op_assign
l_int|0
suffix:semicolon
id|del_timer
c_func
(paren
op_amp
id|tp-&gt;timer
)paren
suffix:semicolon
id|tms380tr_disable_interrupts
c_func
(paren
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;dma
OG
l_int|0
)paren
(brace
r_int
r_int
id|flags
op_assign
id|claim_dma_lock
c_func
(paren
)paren
suffix:semicolon
id|disable_dma
c_func
(paren
id|dev-&gt;dma
)paren
suffix:semicolon
id|release_dma_lock
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
id|SIFWRITEW
c_func
(paren
l_int|0xFF00
comma
id|SIFCMD
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;dma
OG
l_int|0
)paren
(brace
multiline_comment|/* what the? */
id|SIFWRITEB
c_func
(paren
l_int|0xff
comma
id|POSREG
)paren
suffix:semicolon
)brace
id|tms380tr_cancel_tx_queue
c_func
(paren
id|tp
)paren
suffix:semicolon
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Get the current statistics. This may be called with the card open&n; * or closed.&n; */
DECL|function|tms380tr_get_stats
r_static
r_struct
id|net_device_stats
op_star
id|tms380tr_get_stats
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|net_local
op_star
id|tp
op_assign
(paren
r_struct
id|net_local
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_return
(paren
(paren
r_struct
id|net_device_stats
op_star
)paren
op_amp
id|tp-&gt;MacStat
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Set or clear the multicast filter for this adapter.&n; */
DECL|function|tms380tr_set_multicast_list
r_static
r_void
id|tms380tr_set_multicast_list
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|net_local
op_star
id|tp
op_assign
(paren
r_struct
id|net_local
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_int
r_int
id|OpenOptions
suffix:semicolon
id|OpenOptions
op_assign
id|tp-&gt;ocpl.OPENOptions
op_amp
op_complement
(paren
id|PASS_ADAPTER_MAC_FRAMES
op_or
id|PASS_ATTENTION_FRAMES
op_or
id|PASS_BEACON_MAC_FRAMES
op_or
id|COPY_ALL_MAC_FRAMES
op_or
id|COPY_ALL_NON_MAC_FRAMES
)paren
suffix:semicolon
id|tp-&gt;ocpl.FunctAddr
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;flags
op_amp
id|IFF_PROMISC
)paren
(brace
multiline_comment|/* Enable promiscuous mode */
id|OpenOptions
op_or_assign
id|COPY_ALL_NON_MAC_FRAMES
op_or
id|COPY_ALL_MAC_FRAMES
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|dev-&gt;flags
op_amp
id|IFF_ALLMULTI
)paren
(brace
multiline_comment|/* Disable promiscuous mode, use normal mode. */
id|tp-&gt;ocpl.FunctAddr
op_assign
l_int|0xFFFFFFFF
suffix:semicolon
)brace
r_else
(brace
r_int
id|i
suffix:semicolon
r_struct
id|dev_mc_list
op_star
id|mclist
op_assign
id|dev-&gt;mc_list
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|dev-&gt;mc_count
suffix:semicolon
id|i
op_increment
)paren
(brace
(paren
(paren
r_char
op_star
)paren
(paren
op_amp
id|tp-&gt;ocpl.FunctAddr
)paren
)paren
(braket
l_int|0
)braket
op_or_assign
id|mclist-&gt;dmi_addr
(braket
l_int|2
)braket
suffix:semicolon
(paren
(paren
r_char
op_star
)paren
(paren
op_amp
id|tp-&gt;ocpl.FunctAddr
)paren
)paren
(braket
l_int|1
)braket
op_or_assign
id|mclist-&gt;dmi_addr
(braket
l_int|3
)braket
suffix:semicolon
(paren
(paren
r_char
op_star
)paren
(paren
op_amp
id|tp-&gt;ocpl.FunctAddr
)paren
)paren
(braket
l_int|2
)braket
op_or_assign
id|mclist-&gt;dmi_addr
(braket
l_int|4
)braket
suffix:semicolon
(paren
(paren
r_char
op_star
)paren
(paren
op_amp
id|tp-&gt;ocpl.FunctAddr
)paren
)paren
(braket
l_int|3
)braket
op_or_assign
id|mclist-&gt;dmi_addr
(braket
l_int|5
)braket
suffix:semicolon
id|mclist
op_assign
id|mclist-&gt;next
suffix:semicolon
)brace
)brace
id|tms380tr_exec_cmd
c_func
(paren
id|dev
comma
id|OC_SET_FUNCT_ADDR
)paren
suffix:semicolon
)brace
id|tp-&gt;ocpl.OPENOptions
op_assign
id|OpenOptions
suffix:semicolon
id|tms380tr_exec_cmd
c_func
(paren
id|dev
comma
id|OC_MODIFY_OPEN_PARMS
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/*&n; * Wait for some time (microseconds)&n; */
DECL|function|tms380tr_wait
r_void
id|tms380tr_wait
c_func
(paren
r_int
r_int
id|time
)paren
(brace
macro_line|#if 0
r_int
id|tmp
suffix:semicolon
id|tmp
op_assign
id|jiffies
op_plus
id|time
op_div
(paren
l_int|1000000
op_div
id|HZ
)paren
suffix:semicolon
r_do
(brace
id|current-&gt;state
op_assign
id|TASK_INTERRUPTIBLE
suffix:semicolon
id|tmp
op_assign
id|schedule_timeout
c_func
(paren
id|tmp
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
id|time_after
c_func
(paren
id|tmp
comma
id|jiffies
)paren
)paren
(brace
suffix:semicolon
)brace
macro_line|#else
id|udelay
c_func
(paren
id|time
)paren
suffix:semicolon
macro_line|#endif
r_return
suffix:semicolon
)brace
multiline_comment|/*&n; * Write a command value to the SIFCMD register&n; */
DECL|function|tms380tr_exec_sifcmd
r_static
r_void
id|tms380tr_exec_sifcmd
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_int
r_int
id|WriteValue
)paren
(brace
r_int
r_int
id|cmd
suffix:semicolon
r_int
r_int
id|SifStsValue
suffix:semicolon
r_int
r_int
id|loop_counter
suffix:semicolon
id|WriteValue
op_assign
(paren
(paren
id|WriteValue
op_xor
id|CMD_SYSTEM_IRQ
)paren
op_or
id|CMD_INTERRUPT_ADAPTER
)paren
suffix:semicolon
id|cmd
op_assign
(paren
r_int
r_int
)paren
id|WriteValue
suffix:semicolon
id|loop_counter
op_assign
l_int|0
comma
l_int|5
op_star
l_int|800000
suffix:semicolon
r_do
(brace
id|SifStsValue
op_assign
id|SIFREADW
c_func
(paren
id|SIFSTS
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
(paren
id|SifStsValue
op_amp
id|CMD_INTERRUPT_ADAPTER
)paren
op_logical_and
id|loop_counter
op_decrement
)paren
(brace
suffix:semicolon
)brace
id|SIFWRITEW
c_func
(paren
id|cmd
comma
id|SIFCMD
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/*&n; * Processes adapter hardware reset, halts adapter and downloads firmware,&n; * clears the halt bit.&n; */
DECL|function|tms380tr_reset_adapter
r_static
r_int
id|tms380tr_reset_adapter
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|net_local
op_star
id|tp
op_assign
(paren
r_struct
id|net_local
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_int
r_int
op_star
id|fw_ptr
op_assign
(paren
r_int
r_int
op_star
)paren
op_amp
id|tms380tr_code
suffix:semicolon
r_int
r_int
id|count
comma
id|c
suffix:semicolon
multiline_comment|/* Hardware adapter reset */
id|SIFWRITEW
c_func
(paren
id|ACL_ARESET
comma
id|SIFACL
)paren
suffix:semicolon
id|tms380tr_wait
c_func
(paren
l_int|40
)paren
suffix:semicolon
id|c
op_assign
id|SIFREADW
c_func
(paren
id|SIFACL
)paren
suffix:semicolon
id|tms380tr_wait
c_func
(paren
l_int|20
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;dma
op_eq
l_int|0
)paren
multiline_comment|/* For PCI adapters */
(brace
id|c
op_and_assign
op_complement
(paren
id|ACL_NSELOUT0
op_or
id|ACL_NSELOUT1
)paren
suffix:semicolon
multiline_comment|/* Clear bits */
r_if
c_cond
(paren
id|tp-&gt;setnselout
)paren
(brace
id|c
op_or_assign
(paren
op_star
id|tp-&gt;setnselout
)paren
(paren
id|dev
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* In case a command is pending - forget it */
id|tp-&gt;ScbInUse
op_assign
l_int|0
suffix:semicolon
id|c
op_and_assign
op_complement
id|ACL_ARESET
suffix:semicolon
multiline_comment|/* Clear adapter reset bit */
id|c
op_or_assign
id|ACL_CPHALT
suffix:semicolon
multiline_comment|/* Halt adapter CPU, allow download */
id|c
op_or_assign
id|ACL_BOOT
suffix:semicolon
id|c
op_or_assign
id|ACL_SINTEN
suffix:semicolon
id|c
op_and_assign
op_complement
id|ACL_PSDMAEN
suffix:semicolon
multiline_comment|/* Clear pseudo dma bit */
id|SIFWRITEW
c_func
(paren
id|c
comma
id|SIFACL
)paren
suffix:semicolon
id|tms380tr_wait
c_func
(paren
l_int|40
)paren
suffix:semicolon
multiline_comment|/* Download firmware via DIO interface: */
r_do
(brace
multiline_comment|/* Download first address part */
id|SIFWRITEW
c_func
(paren
op_star
id|fw_ptr
comma
id|SIFADX
)paren
suffix:semicolon
id|fw_ptr
op_increment
suffix:semicolon
multiline_comment|/* Download second address part */
id|SIFWRITEW
c_func
(paren
op_star
id|fw_ptr
comma
id|SIFADD
)paren
suffix:semicolon
id|fw_ptr
op_increment
suffix:semicolon
r_if
c_cond
(paren
(paren
id|count
op_assign
op_star
id|fw_ptr
)paren
op_ne
l_int|0
)paren
multiline_comment|/* Load loop counter */
(brace
id|fw_ptr
op_increment
suffix:semicolon
multiline_comment|/* Download block data */
r_for
c_loop
(paren
suffix:semicolon
id|count
OG
l_int|0
suffix:semicolon
id|count
op_decrement
)paren
(brace
id|SIFWRITEW
c_func
(paren
op_star
id|fw_ptr
comma
id|SIFINC
)paren
suffix:semicolon
id|fw_ptr
op_increment
suffix:semicolon
)brace
)brace
r_else
multiline_comment|/* Stop, if last block downloaded */
(brace
id|c
op_assign
id|SIFREADW
c_func
(paren
id|SIFACL
)paren
suffix:semicolon
id|c
op_and_assign
(paren
op_complement
id|ACL_CPHALT
op_or
id|ACL_SINTEN
)paren
suffix:semicolon
multiline_comment|/* Clear CPHALT and start BUD */
id|SIFWRITEW
c_func
(paren
id|c
comma
id|SIFACL
)paren
suffix:semicolon
r_return
(paren
l_int|1
)paren
suffix:semicolon
)brace
)brace
r_while
c_loop
(paren
id|count
op_eq
l_int|0
)paren
(brace
suffix:semicolon
)brace
r_return
(paren
op_minus
l_int|1
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Starts bring up diagnostics of token ring adapter and evaluates&n; * diagnostic results.&n; */
DECL|function|tms380tr_bringup_diags
r_static
r_int
id|tms380tr_bringup_diags
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_int
id|loop_cnt
comma
id|retry_cnt
suffix:semicolon
r_int
r_int
id|Status
suffix:semicolon
id|tms380tr_wait
c_func
(paren
id|HALF_SECOND
)paren
suffix:semicolon
id|tms380tr_exec_sifcmd
c_func
(paren
id|dev
comma
id|EXEC_SOFT_RESET
)paren
suffix:semicolon
id|tms380tr_wait
c_func
(paren
id|HALF_SECOND
)paren
suffix:semicolon
id|retry_cnt
op_assign
id|BUD_MAX_RETRIES
suffix:semicolon
multiline_comment|/* maximal number of retrys */
r_do
(brace
id|retry_cnt
op_decrement
suffix:semicolon
r_if
c_cond
(paren
id|tms380tr_debug
OG
l_int|3
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;BUD-Status: &quot;
)paren
suffix:semicolon
)brace
id|loop_cnt
op_assign
id|BUD_MAX_LOOPCNT
suffix:semicolon
multiline_comment|/* maximum: three seconds*/
r_do
(brace
multiline_comment|/* Inspect BUD results */
id|loop_cnt
op_decrement
suffix:semicolon
id|tms380tr_wait
c_func
(paren
id|HALF_SECOND
)paren
suffix:semicolon
id|Status
op_assign
id|SIFREADW
c_func
(paren
id|SIFSTS
)paren
suffix:semicolon
id|Status
op_and_assign
id|STS_MASK
suffix:semicolon
r_if
c_cond
(paren
id|tms380tr_debug
OG
l_int|3
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot; %04X &bslash;n&quot;
comma
id|Status
)paren
suffix:semicolon
)brace
multiline_comment|/* BUD successfully completed */
r_if
c_cond
(paren
id|Status
op_eq
id|STS_INITIALIZE
)paren
(brace
r_return
(paren
l_int|1
)paren
suffix:semicolon
)brace
multiline_comment|/* Unrecoverable hardware error, BUD not completed? */
)brace
r_while
c_loop
(paren
(paren
id|loop_cnt
OG
l_int|0
)paren
op_logical_and
(paren
(paren
id|Status
op_amp
(paren
id|STS_ERROR
op_or
id|STS_TEST
)paren
)paren
op_ne
(paren
id|STS_ERROR
op_or
id|STS_TEST
)paren
)paren
)paren
(brace
suffix:semicolon
)brace
multiline_comment|/* Error preventing completion of BUD */
r_if
c_cond
(paren
id|retry_cnt
OG
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Adapter Software Reset.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|tms380tr_exec_sifcmd
c_func
(paren
id|dev
comma
id|EXEC_SOFT_RESET
)paren
suffix:semicolon
id|tms380tr_wait
c_func
(paren
id|HALF_SECOND
)paren
suffix:semicolon
)brace
)brace
r_while
c_loop
(paren
id|retry_cnt
OG
l_int|0
)paren
(brace
suffix:semicolon
)brace
id|Status
op_assign
id|SIFREADW
c_func
(paren
id|SIFSTS
)paren
suffix:semicolon
multiline_comment|/* Hardware error occurred! */
id|Status
op_and_assign
l_int|0x001f
suffix:semicolon
r_if
c_cond
(paren
id|Status
op_amp
l_int|0x0010
)paren
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: BUD Error: Timeout&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
(paren
id|Status
op_amp
l_int|0x000f
)paren
OG
l_int|6
)paren
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: BUD Error: Illegal Failure&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_else
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Bring Up Diagnostics Error (%04X) occurred&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|Status
op_amp
l_int|0x000f
)paren
suffix:semicolon
r_return
(paren
op_minus
l_int|1
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Copy initialisation data to adapter memory, beginning at address&n; * 1:0A00; Starting DMA test and evaluating result bits.&n; */
DECL|function|tms380tr_init_adapter
r_static
r_int
id|tms380tr_init_adapter
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|net_local
op_star
id|tp
op_assign
(paren
r_struct
id|net_local
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_const
r_int
r_char
id|SCB_Test
(braket
l_int|6
)braket
op_assign
(brace
l_int|0x00
comma
l_int|0x00
comma
l_int|0xC1
comma
l_int|0xE2
comma
l_int|0xD4
comma
l_int|0x8B
)brace
suffix:semicolon
r_const
r_int
r_char
id|SSB_Test
(braket
l_int|8
)braket
op_assign
(brace
l_int|0xFF
comma
l_int|0xFF
comma
l_int|0xD1
comma
l_int|0xD7
comma
l_int|0xC5
comma
l_int|0xD9
comma
l_int|0xC3
comma
l_int|0xD4
)brace
suffix:semicolon
r_void
op_star
id|ptr
op_assign
(paren
r_void
op_star
)paren
op_amp
id|tp-&gt;ipb
suffix:semicolon
r_int
r_int
op_star
id|ipb_ptr
op_assign
(paren
r_int
r_int
op_star
)paren
id|ptr
suffix:semicolon
r_int
r_char
op_star
id|cb_ptr
op_assign
(paren
r_int
r_char
op_star
)paren
op_amp
id|tp-&gt;scb
suffix:semicolon
r_int
r_char
op_star
id|sb_ptr
op_assign
(paren
r_int
r_char
op_star
)paren
op_amp
id|tp-&gt;ssb
suffix:semicolon
r_int
r_int
id|Status
suffix:semicolon
r_int
id|i
comma
id|loop_cnt
comma
id|retry_cnt
suffix:semicolon
multiline_comment|/* Normalize: byte order low/high, word order high/low! (only IPB!) */
id|tp-&gt;ipb.SCB_Addr
op_assign
id|SWAPW
c_func
(paren
id|virt_to_bus
c_func
(paren
op_amp
id|tp-&gt;scb
)paren
)paren
suffix:semicolon
id|tp-&gt;ipb.SSB_Addr
op_assign
id|SWAPW
c_func
(paren
id|virt_to_bus
c_func
(paren
op_amp
id|tp-&gt;ssb
)paren
)paren
suffix:semicolon
multiline_comment|/* Maximum: three initialization retries */
id|retry_cnt
op_assign
id|INIT_MAX_RETRIES
suffix:semicolon
r_do
(brace
id|retry_cnt
op_decrement
suffix:semicolon
multiline_comment|/* Transfer initialization block */
id|SIFWRITEW
c_func
(paren
l_int|0x0001
comma
id|SIFADX
)paren
suffix:semicolon
multiline_comment|/* To address 0001:0A00 of adapter RAM */
id|SIFWRITEW
c_func
(paren
l_int|0x0A00
comma
id|SIFADD
)paren
suffix:semicolon
multiline_comment|/* Write 11 words to adapter RAM */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|11
suffix:semicolon
id|i
op_increment
)paren
(brace
id|SIFWRITEW
c_func
(paren
id|ipb_ptr
(braket
id|i
)braket
comma
id|SIFINC
)paren
suffix:semicolon
)brace
multiline_comment|/* Execute SCB adapter command */
id|tms380tr_exec_sifcmd
c_func
(paren
id|dev
comma
id|CMD_EXECUTE
)paren
suffix:semicolon
id|loop_cnt
op_assign
id|INIT_MAX_LOOPCNT
suffix:semicolon
multiline_comment|/* Maximum: 11 seconds */
multiline_comment|/* While remaining retries, no error and not completed */
r_do
(brace
id|Status
op_assign
l_int|0
suffix:semicolon
id|loop_cnt
op_decrement
suffix:semicolon
id|tms380tr_wait
c_func
(paren
id|HALF_SECOND
)paren
suffix:semicolon
multiline_comment|/* Mask interesting status bits */
id|Status
op_assign
id|SIFREADW
c_func
(paren
id|SIFSTS
)paren
suffix:semicolon
id|Status
op_and_assign
id|STS_MASK
suffix:semicolon
)brace
r_while
c_loop
(paren
(paren
(paren
id|Status
op_amp
(paren
id|STS_INITIALIZE
op_or
id|STS_ERROR
op_or
id|STS_TEST
)paren
)paren
op_ne
l_int|0
)paren
op_logical_and
(paren
(paren
id|Status
op_amp
id|STS_ERROR
)paren
op_eq
l_int|0
)paren
op_logical_and
(paren
id|loop_cnt
op_ne
l_int|0
)paren
)paren
(brace
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|Status
op_amp
(paren
id|STS_INITIALIZE
op_or
id|STS_ERROR
op_or
id|STS_TEST
)paren
)paren
op_eq
l_int|0
)paren
(brace
multiline_comment|/* Initialization completed without error */
id|i
op_assign
l_int|0
suffix:semicolon
r_do
(brace
multiline_comment|/* Test if contents of SCB is valid */
r_if
c_cond
(paren
id|SCB_Test
(braket
id|i
)braket
op_ne
op_star
(paren
id|cb_ptr
op_plus
id|i
)paren
)paren
(brace
multiline_comment|/* DMA data error: wrong data in SCB */
r_return
(paren
op_minus
l_int|1
)paren
suffix:semicolon
)brace
id|i
op_increment
suffix:semicolon
)brace
r_while
c_loop
(paren
id|i
OL
l_int|6
)paren
(brace
suffix:semicolon
)brace
id|i
op_assign
l_int|0
suffix:semicolon
r_do
(brace
multiline_comment|/* Test if contents of SSB is valid */
r_if
c_cond
(paren
id|SSB_Test
(braket
id|i
)braket
op_ne
op_star
(paren
id|sb_ptr
op_plus
id|i
)paren
)paren
(brace
multiline_comment|/* DMA data error: wrong data in SSB */
r_return
(paren
op_minus
l_int|1
)paren
suffix:semicolon
)brace
id|i
op_increment
suffix:semicolon
)brace
r_while
c_loop
(paren
id|i
OL
l_int|8
)paren
suffix:semicolon
r_return
(paren
l_int|1
)paren
suffix:semicolon
multiline_comment|/* Adapter successfully initialized */
)brace
r_else
(brace
r_if
c_cond
(paren
(paren
id|Status
op_amp
id|STS_ERROR
)paren
op_ne
l_int|0
)paren
(brace
multiline_comment|/* Initialization error occurred */
id|Status
op_assign
id|SIFREADW
c_func
(paren
id|SIFSTS
)paren
suffix:semicolon
id|Status
op_and_assign
id|STS_ERROR_MASK
suffix:semicolon
multiline_comment|/* ShowInitialisationErrorCode(Status); */
r_return
(paren
op_minus
l_int|1
)paren
suffix:semicolon
multiline_comment|/* Unrecoverable error */
)brace
r_else
(brace
r_if
c_cond
(paren
id|retry_cnt
OG
l_int|0
)paren
(brace
multiline_comment|/* Reset adapter and try init again */
id|tms380tr_exec_sifcmd
c_func
(paren
id|dev
comma
id|EXEC_SOFT_RESET
)paren
suffix:semicolon
id|tms380tr_wait
c_func
(paren
id|HALF_SECOND
)paren
suffix:semicolon
)brace
)brace
)brace
)brace
r_while
c_loop
(paren
id|retry_cnt
OG
l_int|0
)paren
(brace
suffix:semicolon
)brace
r_return
(paren
op_minus
l_int|1
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Check for outstanding commands in command queue and tries to execute&n; * command immediately. Corresponding command flag in command queue is cleared.&n; */
DECL|function|tms380tr_chk_outstanding_cmds
r_static
r_void
id|tms380tr_chk_outstanding_cmds
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|net_local
op_star
id|tp
op_assign
(paren
r_struct
id|net_local
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_int
r_int
id|Addr
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|tp-&gt;CMDqueue
op_eq
l_int|0
)paren
(brace
r_return
suffix:semicolon
)brace
multiline_comment|/* No command execution */
multiline_comment|/* If SCB in use: no command */
r_if
c_cond
(paren
id|tp-&gt;ScbInUse
op_eq
l_int|1
)paren
(brace
r_return
suffix:semicolon
)brace
multiline_comment|/* Check if adapter is opened, avoiding COMMAND_REJECT&n;&t; * interrupt by the adapter!&n;&t; */
r_if
c_cond
(paren
id|tp-&gt;AdapterOpenFlag
op_eq
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|tp-&gt;CMDqueue
op_amp
id|OC_OPEN
)paren
(brace
multiline_comment|/* Execute OPEN command&t;*/
id|tp-&gt;CMDqueue
op_xor_assign
id|OC_OPEN
suffix:semicolon
id|Addr
op_assign
id|htonl
c_func
(paren
id|virt_to_bus
c_func
(paren
op_amp
id|tp-&gt;ocpl
)paren
)paren
suffix:semicolon
id|tp-&gt;scb.Parm
(braket
l_int|0
)braket
op_assign
id|LOWORD
c_func
(paren
id|Addr
)paren
suffix:semicolon
id|tp-&gt;scb.Parm
(braket
l_int|1
)braket
op_assign
id|HIWORD
c_func
(paren
id|Addr
)paren
suffix:semicolon
id|tp-&gt;scb.CMD
op_assign
id|OPEN
suffix:semicolon
)brace
r_else
multiline_comment|/* No OPEN command queued, but adapter closed. Note:&n;&t;&t;&t; * We&squot;ll try to re-open the adapter in DriverPoll()&n;&t;&t;&t; */
r_return
suffix:semicolon
multiline_comment|/* No adapter command issued */
)brace
r_else
(brace
multiline_comment|/* Adapter is open; evaluate command queue: try to execute&n;&t;&t; * outstanding commands (depending on priority!) CLOSE&n;&t;&t; * command queued&n;&t;&t; */
r_if
c_cond
(paren
id|tp-&gt;CMDqueue
op_amp
id|OC_CLOSE
)paren
(brace
id|tp-&gt;CMDqueue
op_xor_assign
id|OC_CLOSE
suffix:semicolon
id|tp-&gt;AdapterOpenFlag
op_assign
l_int|0
suffix:semicolon
id|tp-&gt;scb.Parm
(braket
l_int|0
)braket
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Parm[0], Parm[1] are ignored */
id|tp-&gt;scb.Parm
(braket
l_int|1
)braket
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* but should be set to zero! */
id|tp-&gt;scb.CMD
op_assign
id|CLOSE
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|tp-&gt;HaltInProgress
)paren
(brace
id|tp-&gt;CMDqueue
op_or_assign
id|OC_OPEN
suffix:semicolon
)brace
multiline_comment|/* re-open adapter */
r_else
id|tp-&gt;CMDqueue
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* no more commands */
)brace
r_else
(brace
r_if
c_cond
(paren
id|tp-&gt;CMDqueue
op_amp
id|OC_RECEIVE
)paren
(brace
id|tp-&gt;CMDqueue
op_xor_assign
id|OC_RECEIVE
suffix:semicolon
id|Addr
op_assign
id|htonl
c_func
(paren
id|virt_to_bus
c_func
(paren
id|tp-&gt;RplHead
)paren
)paren
suffix:semicolon
id|tp-&gt;scb.Parm
(braket
l_int|0
)braket
op_assign
id|LOWORD
c_func
(paren
id|Addr
)paren
suffix:semicolon
id|tp-&gt;scb.Parm
(braket
l_int|1
)braket
op_assign
id|HIWORD
c_func
(paren
id|Addr
)paren
suffix:semicolon
id|tp-&gt;scb.CMD
op_assign
id|RECEIVE
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|tp-&gt;CMDqueue
op_amp
id|OC_TRANSMIT_HALT
)paren
(brace
multiline_comment|/* NOTE: TRANSMIT.HALT must be checked &n;&t;&t;&t;&t;&t; * before TRANSMIT.&n;&t;&t;&t;&t;&t; */
id|tp-&gt;CMDqueue
op_xor_assign
id|OC_TRANSMIT_HALT
suffix:semicolon
id|tp-&gt;scb.CMD
op_assign
id|TRANSMIT_HALT
suffix:semicolon
multiline_comment|/* Parm[0] and Parm[1] are ignored&n;&t;&t;&t;&t;&t; * but should be set to zero!&n;&t;&t;&t;&t;&t; */
id|tp-&gt;scb.Parm
(braket
l_int|0
)braket
op_assign
l_int|0
suffix:semicolon
id|tp-&gt;scb.Parm
(braket
l_int|1
)braket
op_assign
l_int|0
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|tp-&gt;CMDqueue
op_amp
id|OC_TRANSMIT
)paren
(brace
multiline_comment|/* NOTE: TRANSMIT must be &n;&t;&t;&t;&t;&t;&t; * checked after TRANSMIT.HALT&n;&t;&t;&t;&t;&t;&t; */
r_if
c_cond
(paren
id|tp-&gt;TransmitCommandActive
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|tp-&gt;TransmitHaltScheduled
)paren
(brace
id|tp-&gt;TransmitHaltScheduled
op_assign
l_int|1
suffix:semicolon
id|tms380tr_exec_cmd
c_func
(paren
id|dev
comma
id|OC_TRANSMIT_HALT
)paren
suffix:semicolon
)brace
id|tp-&gt;TransmitCommandActive
op_assign
l_int|0
suffix:semicolon
r_return
suffix:semicolon
)brace
id|tp-&gt;CMDqueue
op_xor_assign
id|OC_TRANSMIT
suffix:semicolon
id|tms380tr_cancel_tx_queue
c_func
(paren
id|tp
)paren
suffix:semicolon
id|Addr
op_assign
id|htonl
c_func
(paren
id|virt_to_bus
c_func
(paren
id|tp-&gt;TplBusy
)paren
)paren
suffix:semicolon
id|tp-&gt;scb.Parm
(braket
l_int|0
)braket
op_assign
id|LOWORD
c_func
(paren
id|Addr
)paren
suffix:semicolon
id|tp-&gt;scb.Parm
(braket
l_int|1
)braket
op_assign
id|HIWORD
c_func
(paren
id|Addr
)paren
suffix:semicolon
id|tp-&gt;scb.CMD
op_assign
id|TRANSMIT
suffix:semicolon
id|tp-&gt;TransmitCommandActive
op_assign
l_int|1
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|tp-&gt;CMDqueue
op_amp
id|OC_MODIFY_OPEN_PARMS
)paren
(brace
id|tp-&gt;CMDqueue
op_xor_assign
id|OC_MODIFY_OPEN_PARMS
suffix:semicolon
id|tp-&gt;scb.Parm
(braket
l_int|0
)braket
op_assign
id|tp-&gt;ocpl.OPENOptions
suffix:semicolon
multiline_comment|/* new OPEN options*/
id|tp-&gt;scb.Parm
(braket
l_int|0
)braket
op_or_assign
id|ENABLE_FULL_DUPLEX_SELECTION
suffix:semicolon
id|tp-&gt;scb.Parm
(braket
l_int|1
)braket
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* is ignored but should be zero */
id|tp-&gt;scb.CMD
op_assign
id|MODIFY_OPEN_PARMS
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|tp-&gt;CMDqueue
op_amp
id|OC_SET_FUNCT_ADDR
)paren
(brace
id|tp-&gt;CMDqueue
op_xor_assign
id|OC_SET_FUNCT_ADDR
suffix:semicolon
id|tp-&gt;scb.Parm
(braket
l_int|0
)braket
op_assign
id|LOWORD
c_func
(paren
id|tp-&gt;ocpl.FunctAddr
)paren
suffix:semicolon
id|tp-&gt;scb.Parm
(braket
l_int|1
)braket
op_assign
id|HIWORD
c_func
(paren
id|tp-&gt;ocpl.FunctAddr
)paren
suffix:semicolon
id|tp-&gt;scb.CMD
op_assign
id|SET_FUNCT_ADDR
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|tp-&gt;CMDqueue
op_amp
id|OC_SET_GROUP_ADDR
)paren
(brace
id|tp-&gt;CMDqueue
op_xor_assign
id|OC_SET_GROUP_ADDR
suffix:semicolon
id|tp-&gt;scb.Parm
(braket
l_int|0
)braket
op_assign
id|LOWORD
c_func
(paren
id|tp-&gt;ocpl.GroupAddr
)paren
suffix:semicolon
id|tp-&gt;scb.Parm
(braket
l_int|1
)braket
op_assign
id|HIWORD
c_func
(paren
id|tp-&gt;ocpl.GroupAddr
)paren
suffix:semicolon
id|tp-&gt;scb.CMD
op_assign
id|SET_GROUP_ADDR
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|tp-&gt;CMDqueue
op_amp
id|OC_READ_ERROR_LOG
)paren
(brace
id|tp-&gt;CMDqueue
op_xor_assign
id|OC_READ_ERROR_LOG
suffix:semicolon
id|Addr
op_assign
id|htonl
c_func
(paren
id|virt_to_bus
c_func
(paren
op_amp
id|tp-&gt;errorlogtable
)paren
)paren
suffix:semicolon
id|tp-&gt;scb.Parm
(braket
l_int|0
)braket
op_assign
id|LOWORD
c_func
(paren
id|Addr
)paren
suffix:semicolon
id|tp-&gt;scb.Parm
(braket
l_int|1
)braket
op_assign
id|HIWORD
c_func
(paren
id|Addr
)paren
suffix:semicolon
id|tp-&gt;scb.CMD
op_assign
id|READ_ERROR_LOG
suffix:semicolon
)brace
r_else
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;CheckForOutstandingCommand: unknown Command&bslash;n&quot;
)paren
suffix:semicolon
id|tp-&gt;CMDqueue
op_assign
l_int|0
suffix:semicolon
r_return
suffix:semicolon
)brace
)brace
)brace
)brace
)brace
)brace
)brace
)brace
)brace
id|tp-&gt;ScbInUse
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* Set semaphore: SCB in use. */
multiline_comment|/* Execute SCB and generate IRQ when done. */
id|tms380tr_exec_sifcmd
c_func
(paren
id|dev
comma
id|CMD_EXECUTE
op_or
id|CMD_SCB_REQUEST
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/*&n; * IRQ conditions: signal loss on the ring, transmit or receive of beacon&n; * frames (disabled if bit 1 of OPEN option is set); report error MAC&n; * frame transmit (disabled if bit 2 of OPEN option is set); open or short&n; * circuit fault on the lobe is detected; remove MAC frame received;&n; * error counter overflow (255); opened adapter is the only station in ring.&n; * After some of the IRQs the adapter is closed!&n; */
DECL|function|tms380tr_ring_status_irq
r_static
r_void
id|tms380tr_ring_status_irq
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|net_local
op_star
id|tp
op_assign
(paren
r_struct
id|net_local
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|tp-&gt;CurrentRingStatus
op_assign
id|be16_to_cpu
c_func
(paren
(paren
r_int
r_int
)paren
id|tp-&gt;ssb.Parm
(braket
l_int|0
)braket
)paren
suffix:semicolon
multiline_comment|/* First: fill up statistics */
r_if
c_cond
(paren
id|tp-&gt;ssb.Parm
(braket
l_int|0
)braket
op_amp
id|SIGNAL_LOSS
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Signal Loss&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|tp-&gt;MacStat.line_errors
op_increment
suffix:semicolon
)brace
multiline_comment|/* Adapter is closed, but initialized */
r_if
c_cond
(paren
id|tp-&gt;ssb.Parm
(braket
l_int|0
)braket
op_amp
id|LOBE_WIRE_FAULT
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Lobe Wire Fault, Reopen Adapter&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|tp-&gt;MacStat.line_errors
op_increment
suffix:semicolon
)brace
r_if
c_cond
(paren
id|tp-&gt;ssb.Parm
(braket
l_int|0
)braket
op_amp
id|RING_RECOVERY
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Ring Recovery&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
)brace
multiline_comment|/* Counter overflow: read error log */
r_if
c_cond
(paren
id|tp-&gt;ssb.Parm
(braket
l_int|0
)braket
op_amp
id|COUNTER_OVERFLOW
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Counter Overflow&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|tms380tr_exec_cmd
c_func
(paren
id|dev
comma
id|OC_READ_ERROR_LOG
)paren
suffix:semicolon
)brace
multiline_comment|/* Adapter is closed, but initialized */
r_if
c_cond
(paren
id|tp-&gt;ssb.Parm
(braket
l_int|0
)braket
op_amp
id|REMOVE_RECEIVED
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Remove Received, Reopen Adapter&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
)brace
multiline_comment|/* Adapter is closed, but initialized */
r_if
c_cond
(paren
id|tp-&gt;ssb.Parm
(braket
l_int|0
)braket
op_amp
id|AUTO_REMOVAL_ERROR
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Auto Removal Error, Reopen Adapter&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|tp-&gt;ssb.Parm
(braket
l_int|0
)braket
op_amp
id|HARD_ERROR
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Hard Error&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|tp-&gt;ssb.Parm
(braket
l_int|0
)braket
op_amp
id|SOFT_ERROR
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Soft Error&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|tp-&gt;ssb.Parm
(braket
l_int|0
)braket
op_amp
id|TRANSMIT_BEACON
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Transmit Beacon&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|tp-&gt;ssb.Parm
(braket
l_int|0
)braket
op_amp
id|SINGLE_STATION
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Single Station&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
)brace
multiline_comment|/* Check if adapter has been closed */
r_if
c_cond
(paren
id|tp-&gt;ssb.Parm
(braket
l_int|0
)braket
op_amp
id|ADAPTER_CLOSED
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Adapter closed (Reopening),&quot;
l_string|&quot;QueueSkb %d, CurrentRingStat %x&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|tp-&gt;QueueSkb
comma
id|tp-&gt;CurrentRingStatus
)paren
suffix:semicolon
id|tp-&gt;AdapterOpenFlag
op_assign
l_int|0
suffix:semicolon
id|tms380tr_open_adapter
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
r_return
suffix:semicolon
)brace
multiline_comment|/*&n; * Issued if adapter has encountered an unrecoverable hardware&n; * or software error.&n; */
DECL|function|tms380tr_chk_irq
r_static
r_void
id|tms380tr_chk_irq
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_int
id|i
suffix:semicolon
r_int
r_int
id|AdapterCheckBlock
(braket
l_int|4
)braket
suffix:semicolon
r_struct
id|net_local
op_star
id|tp
op_assign
(paren
r_struct
id|net_local
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|tp-&gt;AdapterOpenFlag
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Adapter closed now */
multiline_comment|/* Page number of adapter memory */
id|SIFWRITEW
c_func
(paren
l_int|0x0001
comma
id|SIFADX
)paren
suffix:semicolon
multiline_comment|/* Address offset */
id|SIFWRITEW
c_func
(paren
id|CHECKADDR
comma
id|SIFADR
)paren
suffix:semicolon
multiline_comment|/* Reading 8 byte adapter check block. */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|4
suffix:semicolon
id|i
op_increment
)paren
(brace
id|AdapterCheckBlock
(braket
id|i
)braket
op_assign
id|SIFREADW
c_func
(paren
id|SIFINC
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|tms380tr_debug
OG
l_int|3
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%s: AdapterCheckBlock: &quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|4
suffix:semicolon
id|i
op_increment
)paren
id|printk
c_func
(paren
l_string|&quot;%04X&quot;
comma
id|AdapterCheckBlock
(braket
id|i
)braket
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_switch
c_cond
(paren
id|AdapterCheckBlock
(braket
l_int|0
)braket
)paren
(brace
r_case
id|DIO_PARITY
suffix:colon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: DIO parity error&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|DMA_READ_ABORT
suffix:colon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s DMA read operation aborted:&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|AdapterCheckBlock
(braket
l_int|1
)braket
)paren
(brace
r_case
l_int|0
suffix:colon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;Timeout&bslash;n&quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;Address: %04X %04X&bslash;n&quot;
comma
id|AdapterCheckBlock
(braket
l_int|2
)braket
comma
id|AdapterCheckBlock
(braket
l_int|3
)braket
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|1
suffix:colon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;Parity error&bslash;n&quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;Address: %04X %04X&bslash;n&quot;
comma
id|AdapterCheckBlock
(braket
l_int|2
)braket
comma
id|AdapterCheckBlock
(braket
l_int|3
)braket
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|2
suffix:colon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;Bus error&bslash;n&quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;Address: %04X %04X&bslash;n&quot;
comma
id|AdapterCheckBlock
(braket
l_int|2
)braket
comma
id|AdapterCheckBlock
(braket
l_int|3
)braket
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;Unknown error.&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|DMA_WRITE_ABORT
suffix:colon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: DMA write operation aborted: &bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|AdapterCheckBlock
(braket
l_int|1
)braket
)paren
(brace
r_case
l_int|0
suffix:colon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;Timeout&bslash;n&quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;Address: %04X %04X&bslash;n&quot;
comma
id|AdapterCheckBlock
(braket
l_int|2
)braket
comma
id|AdapterCheckBlock
(braket
l_int|3
)braket
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|1
suffix:colon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;Parity error&bslash;n&quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;Address: %04X %04X&bslash;n&quot;
comma
id|AdapterCheckBlock
(braket
l_int|2
)braket
comma
id|AdapterCheckBlock
(braket
l_int|3
)braket
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|2
suffix:colon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;Bus error&bslash;n&quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;Address: %04X %04X&bslash;n&quot;
comma
id|AdapterCheckBlock
(braket
l_int|2
)braket
comma
id|AdapterCheckBlock
(braket
l_int|3
)braket
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;Unknown error.&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|ILLEGAL_OP_CODE
suffix:colon
id|printk
c_func
(paren
l_string|&quot;%s: Illegal operation code in firmware&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
multiline_comment|/* Parm[0-3]: adapter internal register R13-R15 */
r_break
suffix:semicolon
r_case
id|PARITY_ERRORS
suffix:colon
id|printk
c_func
(paren
l_string|&quot;%s: Adapter internal bus parity error&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
multiline_comment|/* Parm[0-3]: adapter internal register R13-R15 */
r_break
suffix:semicolon
r_case
id|RAM_DATA_ERROR
suffix:colon
id|printk
c_func
(paren
l_string|&quot;%s: RAM data error&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
multiline_comment|/* Parm[0-1]: MSW/LSW address of RAM location. */
r_break
suffix:semicolon
r_case
id|RAM_PARITY_ERROR
suffix:colon
id|printk
c_func
(paren
l_string|&quot;%s: RAM parity error&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
multiline_comment|/* Parm[0-1]: MSW/LSW address of RAM location. */
r_break
suffix:semicolon
r_case
id|RING_UNDERRUN
suffix:colon
id|printk
c_func
(paren
l_string|&quot;%s: Internal DMA underrun detected&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|INVALID_IRQ
suffix:colon
id|printk
c_func
(paren
l_string|&quot;%s: Unrecognized interrupt detected&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
multiline_comment|/* Parm[0-3]: adapter internal register R13-R15 */
r_break
suffix:semicolon
r_case
id|INVALID_ERROR_IRQ
suffix:colon
id|printk
c_func
(paren
l_string|&quot;%s: Unrecognized error interrupt detected&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
multiline_comment|/* Parm[0-3]: adapter internal register R13-R15 */
r_break
suffix:semicolon
r_case
id|INVALID_XOP
suffix:colon
id|printk
c_func
(paren
l_string|&quot;%s: Unrecognized XOP request detected&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
multiline_comment|/* Parm[0-3]: adapter internal register R13-R15 */
r_break
suffix:semicolon
r_default
suffix:colon
id|printk
c_func
(paren
l_string|&quot;%s: Unknown status&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|tms380tr_chipset_init
c_func
(paren
id|dev
)paren
op_eq
l_int|1
)paren
(brace
multiline_comment|/* Restart of firmware successful */
id|tp-&gt;AdapterOpenFlag
op_assign
l_int|1
suffix:semicolon
)brace
r_return
suffix:semicolon
)brace
multiline_comment|/*&n; * Internal adapter pointer to RAM data are copied from adapter into&n; * host system.&n; */
DECL|function|tms380tr_read_ptr
r_static
r_int
id|tms380tr_read_ptr
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|net_local
op_star
id|tp
op_assign
(paren
r_struct
id|net_local
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_int
r_int
id|adapterram
suffix:semicolon
id|tms380tr_read_ram
c_func
(paren
id|dev
comma
(paren
r_int
r_char
op_star
)paren
op_amp
id|tp-&gt;intptrs.BurnedInAddrPtr
comma
id|ADAPTER_INT_PTRS
comma
l_int|16
)paren
suffix:semicolon
id|tms380tr_read_ram
c_func
(paren
id|dev
comma
(paren
r_int
r_char
op_star
)paren
op_amp
id|adapterram
comma
id|cpu_to_be16
c_func
(paren
(paren
r_int
r_int
)paren
id|tp-&gt;intptrs.AdapterRAMPtr
)paren
comma
l_int|2
)paren
suffix:semicolon
r_return
id|be16_to_cpu
c_func
(paren
id|adapterram
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Reads a number of bytes from adapter to system memory.&n; */
DECL|function|tms380tr_read_ram
r_static
r_void
id|tms380tr_read_ram
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_int
r_char
op_star
id|Data
comma
r_int
r_int
id|Address
comma
r_int
id|Length
)paren
(brace
r_int
id|i
suffix:semicolon
r_int
r_int
id|old_sifadx
comma
id|old_sifadr
comma
id|InWord
suffix:semicolon
multiline_comment|/* Save the current values */
id|old_sifadx
op_assign
id|SIFREADW
c_func
(paren
id|SIFADX
)paren
suffix:semicolon
id|old_sifadr
op_assign
id|SIFREADW
c_func
(paren
id|SIFADR
)paren
suffix:semicolon
multiline_comment|/* Page number of adapter memory */
id|SIFWRITEW
c_func
(paren
l_int|0x0001
comma
id|SIFADX
)paren
suffix:semicolon
multiline_comment|/* Address offset in adapter RAM */
id|SIFWRITEW
c_func
(paren
id|Address
comma
id|SIFADR
)paren
suffix:semicolon
multiline_comment|/* Copy len byte from adapter memory to system data area. */
id|i
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
suffix:semicolon
suffix:semicolon
)paren
(brace
id|InWord
op_assign
id|SIFREADW
c_func
(paren
id|SIFINC
)paren
suffix:semicolon
op_star
(paren
id|Data
op_plus
id|i
)paren
op_assign
id|HIBYTE
c_func
(paren
id|InWord
)paren
suffix:semicolon
multiline_comment|/* Write first byte */
r_if
c_cond
(paren
op_increment
id|i
op_eq
id|Length
)paren
(brace
multiline_comment|/* All is done break */
r_break
suffix:semicolon
)brace
op_star
(paren
id|Data
op_plus
id|i
)paren
op_assign
id|LOBYTE
c_func
(paren
id|InWord
)paren
suffix:semicolon
multiline_comment|/* Write second byte */
r_if
c_cond
(paren
op_increment
id|i
op_eq
id|Length
)paren
multiline_comment|/* All is done break */
r_break
suffix:semicolon
)brace
multiline_comment|/* Restore original values */
id|SIFWRITEW
c_func
(paren
id|old_sifadx
comma
id|SIFADX
)paren
suffix:semicolon
id|SIFWRITEW
c_func
(paren
id|old_sifadr
comma
id|SIFADR
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/*&n; * Cancel all queued packets in the transmission queue.&n; */
DECL|function|tms380tr_cancel_tx_queue
r_static
r_void
id|tms380tr_cancel_tx_queue
c_func
(paren
r_struct
id|net_local
op_star
id|tp
)paren
(brace
id|TPL
op_star
id|tpl
suffix:semicolon
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
multiline_comment|/*&n;&t; * NOTE: There must not be an active TRANSMIT command pending, when&n;&t; * this function is called.&n;&t; */
r_if
c_cond
(paren
id|tp-&gt;TransmitCommandActive
)paren
(brace
r_return
suffix:semicolon
)brace
r_for
c_loop
(paren
suffix:semicolon
suffix:semicolon
)paren
(brace
id|tpl
op_assign
id|tp-&gt;TplBusy
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|tpl-&gt;BusyFlag
)paren
(brace
r_break
suffix:semicolon
)brace
multiline_comment|/* &quot;Remove&quot; TPL from busy list. */
id|tp-&gt;TplBusy
op_assign
id|tpl-&gt;NextTPLPtr
suffix:semicolon
id|tms380tr_write_tpl_status
c_func
(paren
id|tpl
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* Clear VALID bit */
id|tpl-&gt;BusyFlag
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* &quot;free&quot; TPL */
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;Cancel tx (%08lXh).&bslash;n&quot;
comma
(paren
r_int
r_int
)paren
id|tpl
)paren
suffix:semicolon
id|dev_kfree_skb
c_func
(paren
id|tpl-&gt;Skb
)paren
suffix:semicolon
)brace
r_for
c_loop
(paren
suffix:semicolon
suffix:semicolon
)paren
(brace
id|skb
op_assign
id|skb_dequeue
c_func
(paren
op_amp
id|tp-&gt;SendSkbQueue
)paren
suffix:semicolon
r_if
c_cond
(paren
id|skb
op_eq
l_int|NULL
)paren
(brace
r_break
suffix:semicolon
)brace
id|tp-&gt;QueueSkb
op_increment
suffix:semicolon
id|dev_kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
)brace
r_return
suffix:semicolon
)brace
multiline_comment|/*&n; * This function is called whenever a transmit interrupt is generated by the&n; * adapter. For a command complete interrupt, it is checked if we have to&n; * issue a new transmit command or not.&n; */
DECL|function|tms380tr_tx_status_irq
r_static
r_void
id|tms380tr_tx_status_irq
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|net_local
op_star
id|tp
op_assign
(paren
r_struct
id|net_local
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_int
r_char
id|HighByte
comma
id|HighAc
comma
id|LowAc
suffix:semicolon
id|TPL
op_star
id|tpl
suffix:semicolon
multiline_comment|/* NOTE: At this point the SSB from TRANSMIT STATUS is no longer&n;&t; * available, because the CLEAR SSB command has already been issued.&n;&t; *&n;&t; * Process all complete transmissions.&n;&t; */
r_for
c_loop
(paren
suffix:semicolon
suffix:semicolon
)paren
(brace
id|tpl
op_assign
id|tp-&gt;TplBusy
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|tpl-&gt;BusyFlag
op_logical_or
(paren
id|tpl-&gt;Status
op_amp
(paren
id|TX_VALID
op_or
id|TX_FRAME_COMPLETE
)paren
)paren
op_ne
id|TX_FRAME_COMPLETE
)paren
(brace
r_break
suffix:semicolon
)brace
multiline_comment|/* &quot;Remove&quot; TPL from busy list. */
id|tp-&gt;TplBusy
op_assign
id|tpl-&gt;NextTPLPtr
suffix:semicolon
multiline_comment|/* Check the transmit status field only for directed frames*/
r_if
c_cond
(paren
id|DIRECTED_FRAME
c_func
(paren
id|tpl
)paren
op_logical_and
(paren
id|tpl-&gt;Status
op_amp
id|TX_ERROR
)paren
op_eq
l_int|0
)paren
(brace
id|HighByte
op_assign
id|GET_TRANSMIT_STATUS_HIGH_BYTE
c_func
(paren
id|tpl-&gt;Status
)paren
suffix:semicolon
id|HighAc
op_assign
id|GET_FRAME_STATUS_HIGH_AC
c_func
(paren
id|HighByte
)paren
suffix:semicolon
id|LowAc
op_assign
id|GET_FRAME_STATUS_LOW_AC
c_func
(paren
id|HighByte
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|HighAc
op_ne
id|LowAc
)paren
op_logical_or
(paren
id|HighAc
op_eq
id|AC_NOT_RECOGNIZED
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: (DA=%08lX not recognized)&quot;
comma
id|dev-&gt;name
comma
op_star
(paren
r_int
r_int
op_star
)paren
op_amp
id|tpl-&gt;MData
(braket
l_int|2
op_plus
l_int|2
)braket
)paren
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|tms380tr_debug
OG
l_int|3
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%s: Directed frame tx&squot;d&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
)brace
)brace
)brace
r_else
(brace
r_if
c_cond
(paren
op_logical_neg
id|DIRECTED_FRAME
c_func
(paren
id|tpl
)paren
)paren
(brace
r_if
c_cond
(paren
id|tms380tr_debug
OG
l_int|3
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%s: Broadcast frame tx&squot;d&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
)brace
)brace
)brace
id|tp-&gt;MacStat.tx_packets
op_increment
suffix:semicolon
id|dev_kfree_skb
c_func
(paren
id|tpl-&gt;Skb
)paren
suffix:semicolon
id|tpl-&gt;BusyFlag
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* &quot;free&quot; TPL */
)brace
id|netif_wake_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tp-&gt;QueueSkb
OL
id|MAX_TX_QUEUE
)paren
(brace
id|tms380tr_hardware_send_packet
c_func
(paren
id|dev
comma
id|tp
)paren
suffix:semicolon
)brace
r_return
suffix:semicolon
)brace
multiline_comment|/*&n; * Called if a frame receive interrupt is generated by the adapter.&n; * Check if the frame is valid and indicate it to system.&n; */
DECL|function|tms380tr_rcv_status_irq
r_static
r_void
id|tms380tr_rcv_status_irq
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|net_local
op_star
id|tp
op_assign
(paren
r_struct
id|net_local
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_int
r_char
op_star
id|ReceiveDataPtr
suffix:semicolon
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
r_int
r_int
id|Length
comma
id|Length2
suffix:semicolon
id|RPL
op_star
id|rpl
suffix:semicolon
id|RPL
op_star
id|SaveHead
suffix:semicolon
multiline_comment|/* NOTE: At this point the SSB from RECEIVE STATUS is no longer&n;&t; * available, because the CLEAR SSB command has already been issued.&n;&t; *&n;&t; * Process all complete receives.&n;&t; */
r_for
c_loop
(paren
suffix:semicolon
suffix:semicolon
)paren
(brace
id|rpl
op_assign
id|tp-&gt;RplHead
suffix:semicolon
r_if
c_cond
(paren
id|rpl-&gt;Status
op_amp
id|RX_VALID
)paren
(brace
r_break
suffix:semicolon
)brace
multiline_comment|/* RPL still in use by adapter */
multiline_comment|/* Forward RPLHead pointer to next list. */
id|SaveHead
op_assign
id|tp-&gt;RplHead
suffix:semicolon
id|tp-&gt;RplHead
op_assign
id|rpl-&gt;NextRPLPtr
suffix:semicolon
multiline_comment|/* Get the frame size (Byte swap for Intel).&n;&t;&t; * Do this early (see workaround comment below)&n;&t;&t; */
id|Length
op_assign
id|be16_to_cpu
c_func
(paren
(paren
r_int
r_int
)paren
id|rpl-&gt;FrameSize
)paren
suffix:semicolon
multiline_comment|/* Check if the Frame_Start, Frame_End and&n;&t;&t; * Frame_Complete bits are set.&n;&t;&t; */
r_if
c_cond
(paren
(paren
id|rpl-&gt;Status
op_amp
id|VALID_SINGLE_BUFFER_FRAME
)paren
op_eq
id|VALID_SINGLE_BUFFER_FRAME
)paren
(brace
id|ReceiveDataPtr
op_assign
id|rpl-&gt;MData
suffix:semicolon
multiline_comment|/* Workaround for delayed write of FrameSize on ISA&n;&t;&t;&t; * (FrameSize is false but valid-bit is reset)&n;&t;&t;&t; * Frame size is set to zero when the RPL is freed.&n;&t;&t;&t; * Length2 is there because there have also been&n;&t;&t;&t; * cases where the FrameSize was partially written&n;&t;&t;&t; */
id|Length2
op_assign
id|be16_to_cpu
c_func
(paren
(paren
r_int
r_int
)paren
id|rpl-&gt;FrameSize
)paren
suffix:semicolon
r_if
c_cond
(paren
id|Length
op_eq
l_int|0
op_logical_or
id|Length
op_ne
id|Length2
)paren
(brace
id|tp-&gt;RplHead
op_assign
id|SaveHead
suffix:semicolon
r_break
suffix:semicolon
multiline_comment|/* Return to tms380tr_interrupt */
)brace
macro_line|#if 0  &t;&t;/* This might happen for multicast or broadcast packets.&n;&t;&t;   The upper layers are expected to handle this, not here */
multiline_comment|/* Drop frames sent by myself */
r_if
c_cond
(paren
id|tms380tr_chk_frame
c_func
(paren
id|dev
comma
id|rpl-&gt;MData
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Received my own frame&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rpl-&gt;Skb
op_ne
l_int|NULL
)paren
(brace
id|dev_kfree_skb
c_func
(paren
id|rpl-&gt;Skb
)paren
suffix:semicolon
)brace
)brace
r_else
macro_line|#endif
(brace
id|tms380tr_update_rcv_stats
c_func
(paren
id|tp
comma
id|ReceiveDataPtr
comma
id|Length
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tms380tr_debug
OG
l_int|3
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%s: Packet Length %04X (%d)&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|Length
comma
id|Length
)paren
suffix:semicolon
)brace
multiline_comment|/* Indicate the received frame to system the&n;&t;&t;&t;&t; * adapter does the Source-Routing padding for &n;&t;&t;&t;&t; * us. See: OpenOptions in tms380tr_init_opb()&n;&t;&t;&t;&t; */
id|skb
op_assign
id|rpl-&gt;Skb
suffix:semicolon
r_if
c_cond
(paren
id|rpl-&gt;SkbStat
op_eq
id|SKB_UNAVAILABLE
)paren
(brace
multiline_comment|/* Try again to allocate skb */
id|skb
op_assign
id|dev_alloc_skb
c_func
(paren
id|tp-&gt;MaxPacketSize
)paren
suffix:semicolon
r_if
c_cond
(paren
id|skb
op_eq
l_int|NULL
)paren
(brace
multiline_comment|/* Update Stats ?? */
)brace
r_else
(brace
id|skb-&gt;dev
op_assign
id|dev
suffix:semicolon
id|skb_put
c_func
(paren
id|skb
comma
id|tp-&gt;MaxPacketSize
)paren
suffix:semicolon
id|rpl-&gt;SkbStat
op_assign
id|SKB_DATA_COPY
suffix:semicolon
id|ReceiveDataPtr
op_assign
id|rpl-&gt;MData
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|rpl-&gt;SkbStat
op_eq
id|SKB_DATA_COPY
op_logical_or
id|rpl-&gt;SkbStat
op_eq
id|SKB_DMA_DIRECT
)paren
(brace
r_if
c_cond
(paren
id|rpl-&gt;SkbStat
op_eq
id|SKB_DATA_COPY
)paren
(brace
id|memmove
c_func
(paren
id|skb-&gt;data
comma
id|ReceiveDataPtr
comma
id|Length
)paren
suffix:semicolon
)brace
multiline_comment|/* Deliver frame to system */
id|rpl-&gt;Skb
op_assign
l_int|NULL
suffix:semicolon
id|skb_trim
c_func
(paren
id|skb
comma
id|Length
)paren
suffix:semicolon
id|skb-&gt;protocol
op_assign
id|tr_type_trans
c_func
(paren
id|skb
comma
id|dev
)paren
suffix:semicolon
id|netif_rx
c_func
(paren
id|skb
)paren
suffix:semicolon
)brace
)brace
)brace
r_else
multiline_comment|/* Invalid frame */
(brace
r_if
c_cond
(paren
id|rpl-&gt;Skb
op_ne
l_int|NULL
)paren
(brace
id|dev_kfree_skb
c_func
(paren
id|rpl-&gt;Skb
)paren
suffix:semicolon
)brace
multiline_comment|/* Skip list. */
r_if
c_cond
(paren
id|rpl-&gt;Status
op_amp
id|RX_START_FRAME
)paren
(brace
multiline_comment|/* Frame start bit is set -&gt; overflow. */
id|tp-&gt;MacStat.rx_errors
op_increment
suffix:semicolon
)brace
)brace
multiline_comment|/* Allocate new skb for rpl */
id|rpl-&gt;Skb
op_assign
id|dev_alloc_skb
c_func
(paren
id|tp-&gt;MaxPacketSize
)paren
suffix:semicolon
multiline_comment|/* skb == NULL ? then use local buffer */
r_if
c_cond
(paren
id|rpl-&gt;Skb
op_eq
l_int|NULL
)paren
(brace
id|rpl-&gt;SkbStat
op_assign
id|SKB_UNAVAILABLE
suffix:semicolon
id|rpl-&gt;FragList
(braket
l_int|0
)braket
dot
id|DataAddr
op_assign
id|htonl
c_func
(paren
id|virt_to_bus
c_func
(paren
id|tp-&gt;LocalRxBuffers
(braket
id|rpl-&gt;RPLIndex
)braket
)paren
)paren
suffix:semicolon
id|rpl-&gt;MData
op_assign
id|tp-&gt;LocalRxBuffers
(braket
id|rpl-&gt;RPLIndex
)braket
suffix:semicolon
)brace
r_else
multiline_comment|/* skb != NULL */
(brace
id|rpl-&gt;Skb-&gt;dev
op_assign
id|dev
suffix:semicolon
id|skb_put
c_func
(paren
id|rpl-&gt;Skb
comma
id|tp-&gt;MaxPacketSize
)paren
suffix:semicolon
multiline_comment|/* Data unreachable for DMA ? then use local buffer */
r_if
c_cond
(paren
id|tp-&gt;dmalimit
op_logical_and
id|virt_to_bus
c_func
(paren
id|rpl-&gt;Skb-&gt;data
)paren
op_plus
id|tp-&gt;MaxPacketSize
OG
id|tp-&gt;dmalimit
)paren
(brace
id|rpl-&gt;SkbStat
op_assign
id|SKB_DATA_COPY
suffix:semicolon
id|rpl-&gt;FragList
(braket
l_int|0
)braket
dot
id|DataAddr
op_assign
id|htonl
c_func
(paren
id|virt_to_bus
c_func
(paren
id|tp-&gt;LocalRxBuffers
(braket
id|rpl-&gt;RPLIndex
)braket
)paren
)paren
suffix:semicolon
id|rpl-&gt;MData
op_assign
id|tp-&gt;LocalRxBuffers
(braket
id|rpl-&gt;RPLIndex
)braket
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* DMA directly in skb-&gt;data */
id|rpl-&gt;SkbStat
op_assign
id|SKB_DMA_DIRECT
suffix:semicolon
id|rpl-&gt;FragList
(braket
l_int|0
)braket
dot
id|DataAddr
op_assign
id|htonl
c_func
(paren
id|virt_to_bus
c_func
(paren
id|rpl-&gt;Skb-&gt;data
)paren
)paren
suffix:semicolon
id|rpl-&gt;MData
op_assign
id|rpl-&gt;Skb-&gt;data
suffix:semicolon
)brace
)brace
id|rpl-&gt;FragList
(braket
l_int|0
)braket
dot
id|DataCount
op_assign
id|cpu_to_be16
c_func
(paren
(paren
r_int
r_int
)paren
id|tp-&gt;MaxPacketSize
)paren
suffix:semicolon
id|rpl-&gt;FrameSize
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Pass the last RPL back to the adapter */
id|tp-&gt;RplTail-&gt;FrameSize
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Reset the CSTAT field in the list. */
id|tms380tr_write_rpl_status
c_func
(paren
id|tp-&gt;RplTail
comma
id|RX_VALID
op_or
id|RX_FRAME_IRQ
)paren
suffix:semicolon
multiline_comment|/* Current RPL becomes last one in list. */
id|tp-&gt;RplTail
op_assign
id|tp-&gt;RplTail-&gt;NextRPLPtr
suffix:semicolon
multiline_comment|/* Inform adapter about RPL valid. */
id|tms380tr_exec_sifcmd
c_func
(paren
id|dev
comma
id|CMD_RX_VALID
)paren
suffix:semicolon
)brace
r_return
suffix:semicolon
)brace
multiline_comment|/*&n; * This function should be used whenever the status of any RPL must be&n; * modified by the driver, because the compiler may otherwise change the&n; * order of instructions such that writing the RPL status may be executed&n; * at an undesireable time. When this function is used, the status is&n; * always written when the function is called.&n; */
DECL|function|tms380tr_write_rpl_status
r_static
r_void
id|tms380tr_write_rpl_status
c_func
(paren
id|RPL
op_star
id|rpl
comma
r_int
r_int
id|Status
)paren
(brace
id|rpl-&gt;Status
op_assign
id|Status
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/*&n; * The function updates the statistic counters in mac-&gt;MacStat.&n; * It differtiates between directed and broadcast/multicast ( ==functional)&n; * frames.&n; */
DECL|function|tms380tr_update_rcv_stats
r_static
r_void
id|tms380tr_update_rcv_stats
c_func
(paren
r_struct
id|net_local
op_star
id|tp
comma
r_int
r_char
id|DataPtr
(braket
)braket
comma
r_int
r_int
id|Length
)paren
(brace
id|tp-&gt;MacStat.rx_packets
op_increment
suffix:semicolon
id|tp-&gt;MacStat.rx_bytes
op_add_assign
id|Length
suffix:semicolon
multiline_comment|/* Test functional bit */
r_if
c_cond
(paren
id|DataPtr
(braket
l_int|2
)braket
op_amp
id|GROUP_BIT
)paren
(brace
id|tp-&gt;MacStat.multicast
op_increment
suffix:semicolon
)brace
r_return
suffix:semicolon
)brace
macro_line|#if 0
multiline_comment|/*&n; * Check if it is a frame of myself. Compare source address with my current&n; * address in reverse direction, and mask out the TR_RII.&n; */
r_static
r_int
r_char
id|tms380tr_chk_frame
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_int
r_char
op_star
id|Addr
)paren
(brace
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|5
suffix:semicolon
id|i
OG
l_int|0
suffix:semicolon
id|i
op_decrement
)paren
(brace
r_if
c_cond
(paren
id|Addr
(braket
l_int|8
op_plus
id|i
)braket
op_ne
id|dev-&gt;dev_addr
(braket
id|i
)braket
)paren
(brace
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* Mask out RIF bit. */
r_if
c_cond
(paren
(paren
id|Addr
(braket
l_int|8
)braket
op_amp
op_complement
id|TR_RII
)paren
op_ne
(paren
r_int
r_char
)paren
(paren
id|dev-&gt;dev_addr
(braket
l_int|0
)braket
)paren
)paren
(brace
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
r_return
(paren
l_int|1
)paren
suffix:semicolon
multiline_comment|/* It is my frame. */
)brace
macro_line|#endif
DECL|function|tms380tr_set_mac_address
r_static
r_int
id|tms380tr_set_mac_address
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_void
op_star
id|addr
)paren
(brace
r_struct
id|net_local
op_star
id|tp
op_assign
(paren
r_struct
id|net_local
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_struct
id|sockaddr
op_star
id|saddr
op_assign
id|addr
suffix:semicolon
r_if
c_cond
(paren
id|tp-&gt;AdapterOpenFlag
op_logical_or
id|tp-&gt;AdapterVirtOpenFlag
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: Cannot set MAC/LAA address while card is open&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
id|memcpy
c_func
(paren
id|dev-&gt;dev_addr
comma
id|saddr-&gt;sa_data
comma
id|dev-&gt;addr_len
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#if TMS380TR_DEBUG &gt; 0
multiline_comment|/*&n; * Dump Packet (data)&n; */
DECL|function|tms380tr_dump
r_static
r_void
id|tms380tr_dump
c_func
(paren
r_int
r_char
op_star
id|Data
comma
r_int
id|length
)paren
(brace
r_int
id|i
comma
id|j
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
comma
id|j
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|length
op_div
l_int|8
suffix:semicolon
id|i
op_increment
comma
id|j
op_add_assign
l_int|8
)paren
(brace
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%02x %02x %02x %02x %02x %02x %02x %02x&bslash;n&quot;
comma
id|Data
(braket
id|j
op_plus
l_int|0
)braket
comma
id|Data
(braket
id|j
op_plus
l_int|1
)braket
comma
id|Data
(braket
id|j
op_plus
l_int|2
)braket
comma
id|Data
(braket
id|j
op_plus
l_int|3
)braket
comma
id|Data
(braket
id|j
op_plus
l_int|4
)braket
comma
id|Data
(braket
id|j
op_plus
l_int|5
)braket
comma
id|Data
(braket
id|j
op_plus
l_int|6
)braket
comma
id|Data
(braket
id|j
op_plus
l_int|7
)braket
)paren
suffix:semicolon
)brace
r_return
suffix:semicolon
)brace
macro_line|#endif
DECL|function|tmsdev_init
r_int
id|tmsdev_init
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_if
c_cond
(paren
id|dev-&gt;priv
op_eq
l_int|NULL
)paren
(brace
r_struct
id|net_local
op_star
id|tms_local
suffix:semicolon
id|dev-&gt;priv
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|net_local
)paren
comma
id|GFP_KERNEL
op_or
id|GFP_DMA
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;priv
op_eq
l_int|NULL
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|memset
c_func
(paren
id|dev-&gt;priv
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|net_local
)paren
)paren
suffix:semicolon
id|tms_local
op_assign
(paren
r_struct
id|net_local
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|init_waitqueue_head
c_func
(paren
op_amp
id|tms_local-&gt;wait_for_tok_int
)paren
suffix:semicolon
)brace
multiline_comment|/* These can be overridden by the card driver if needed */
id|dev-&gt;init
op_assign
id|tms380tr_init_card
suffix:semicolon
id|dev-&gt;open
op_assign
id|tms380tr_open
suffix:semicolon
id|dev-&gt;stop
op_assign
id|tms380tr_close
suffix:semicolon
id|dev-&gt;do_ioctl
op_assign
l_int|NULL
suffix:semicolon
id|dev-&gt;hard_start_xmit
op_assign
id|tms380tr_send_packet
suffix:semicolon
id|dev-&gt;tx_timeout
op_assign
id|tms380tr_timeout
suffix:semicolon
id|dev-&gt;watchdog_timeo
op_assign
id|HZ
suffix:semicolon
id|dev-&gt;get_stats
op_assign
id|tms380tr_get_stats
suffix:semicolon
id|dev-&gt;set_multicast_list
op_assign
op_amp
id|tms380tr_set_multicast_list
suffix:semicolon
id|dev-&gt;set_mac_address
op_assign
id|tms380tr_set_mac_address
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#ifdef MODULE
DECL|variable|tms380tr_open
id|EXPORT_SYMBOL
c_func
(paren
id|tms380tr_open
)paren
suffix:semicolon
DECL|variable|tms380tr_close
id|EXPORT_SYMBOL
c_func
(paren
id|tms380tr_close
)paren
suffix:semicolon
DECL|variable|tms380tr_interrupt
id|EXPORT_SYMBOL
c_func
(paren
id|tms380tr_interrupt
)paren
suffix:semicolon
DECL|variable|tmsdev_init
id|EXPORT_SYMBOL
c_func
(paren
id|tmsdev_init
)paren
suffix:semicolon
DECL|variable|tms380tr_wait
id|EXPORT_SYMBOL
c_func
(paren
id|tms380tr_wait
)paren
suffix:semicolon
DECL|variable|TMS380_module
r_struct
id|module
op_star
id|TMS380_module
op_assign
l_int|NULL
suffix:semicolon
DECL|function|init_module
r_int
id|init_module
c_func
(paren
r_void
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%s&quot;
comma
id|version
)paren
suffix:semicolon
id|TMS380_module
op_assign
op_amp
id|__this_module
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|cleanup_module
r_void
id|cleanup_module
c_func
(paren
r_void
)paren
(brace
id|TMS380_module
op_assign
l_int|NULL
suffix:semicolon
)brace
macro_line|#endif
"&f;"
multiline_comment|/*&n; * Local variables:&n; *  compile-command: &quot;gcc -DMODVERSIONS  -DMODULE -D__KERNEL__ -Wall -Wstrict-prototypes -O6 -fomit-frame-pointer -I/usr/src/linux/drivers/net/tokenring/ -c tms380tr.c&quot;&n; *  alt-compile-command: &quot;gcc -DMODULE -D__KERNEL__ -Wall -Wstrict-prototypes -O6 -fomit-frame-pointer -I/usr/src/linux/drivers/net/tokenring/ -c tms380tr.c&quot;&n; *  c-set-style &quot;K&amp;R&quot;&n; *  c-indent-level: 8&n; *  c-basic-offset: 8&n; *  tab-width: 8&n; * End:&n; */
eof
