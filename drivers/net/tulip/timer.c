multiline_comment|/*&n;&t;drivers/net/tulip/timer.c&n;&n;&t;Maintained by Jeff Garzik &lt;jgarzik@mandrakesoft.com&gt;&n;&t;Copyright 2000  The Linux Kernel Team&n;&t;Written/copyright 1994-1999 by Donald Becker.&n;&n;&t;This software may be used and distributed according to the terms&n;&t;of the GNU Public License, incorporated herein by reference.&n;&n;&t;Please refer to Documentation/networking/tulip.txt for more&n;&t;information on this driver.&n;&n;*/
macro_line|#include &quot;tulip.h&quot;
DECL|function|tulip_timer
r_void
id|tulip_timer
c_func
(paren
r_int
r_int
id|data
)paren
(brace
r_struct
id|net_device
op_star
id|dev
op_assign
(paren
r_struct
id|net_device
op_star
)paren
id|data
suffix:semicolon
r_struct
id|tulip_private
op_star
id|tp
op_assign
(paren
r_struct
id|tulip_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_int
id|ioaddr
op_assign
id|dev-&gt;base_addr
suffix:semicolon
id|u32
id|csr12
op_assign
id|inl
c_func
(paren
id|ioaddr
op_plus
id|CSR12
)paren
suffix:semicolon
r_int
id|next_tick
op_assign
l_int|2
op_star
id|HZ
suffix:semicolon
r_if
c_cond
(paren
id|tulip_debug
OG
l_int|2
)paren
(brace
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%s: Media selection tick, %s, status %8.8x mode&quot;
l_string|&quot; %8.8x SIA %8.8x %8.8x %8.8x %8.8x.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|medianame
(braket
id|dev-&gt;if_port
)braket
comma
id|inl
c_func
(paren
id|ioaddr
op_plus
id|CSR5
)paren
comma
id|inl
c_func
(paren
id|ioaddr
op_plus
id|CSR6
)paren
comma
id|csr12
comma
id|inl
c_func
(paren
id|ioaddr
op_plus
id|CSR13
)paren
comma
id|inl
c_func
(paren
id|ioaddr
op_plus
id|CSR14
)paren
comma
id|inl
c_func
(paren
id|ioaddr
op_plus
id|CSR15
)paren
)paren
suffix:semicolon
)brace
r_switch
c_cond
(paren
id|tp-&gt;chip_id
)paren
(brace
r_case
id|DC21040
suffix:colon
r_if
c_cond
(paren
op_logical_neg
id|tp-&gt;medialock
op_logical_and
id|csr12
op_amp
l_int|0x0002
)paren
(brace
multiline_comment|/* Network error */
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: No link beat found.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|dev-&gt;if_port
op_assign
(paren
id|dev-&gt;if_port
op_eq
l_int|2
ques
c_cond
l_int|0
suffix:colon
l_int|2
)paren
suffix:semicolon
id|tulip_select_media
c_func
(paren
id|dev
comma
l_int|0
)paren
suffix:semicolon
id|dev-&gt;trans_start
op_assign
id|jiffies
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|DC21041
suffix:colon
r_if
c_cond
(paren
id|tulip_debug
OG
l_int|2
)paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%s: 21041 media tick  CSR12 %8.8x.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|csr12
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tp-&gt;medialock
)paren
r_break
suffix:semicolon
r_switch
c_cond
(paren
id|dev-&gt;if_port
)paren
(brace
r_case
l_int|0
suffix:colon
r_case
l_int|3
suffix:colon
r_case
l_int|4
suffix:colon
r_if
c_cond
(paren
id|csr12
op_amp
l_int|0x0004
)paren
(brace
multiline_comment|/*LnkFail */
multiline_comment|/* 10baseT is dead.  Check for activity on alternate port. */
id|tp-&gt;mediasense
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|csr12
op_amp
l_int|0x0200
)paren
id|dev-&gt;if_port
op_assign
l_int|2
suffix:semicolon
r_else
id|dev-&gt;if_port
op_assign
l_int|1
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: No 21041 10baseT link beat, Media switched to %s.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|medianame
(braket
id|dev-&gt;if_port
)braket
)paren
suffix:semicolon
id|outl
c_func
(paren
l_int|0
comma
id|ioaddr
op_plus
id|CSR13
)paren
suffix:semicolon
multiline_comment|/* Reset */
id|outl
c_func
(paren
id|t21041_csr14
(braket
id|dev-&gt;if_port
)braket
comma
id|ioaddr
op_plus
id|CSR14
)paren
suffix:semicolon
id|outl
c_func
(paren
id|t21041_csr15
(braket
id|dev-&gt;if_port
)braket
comma
id|ioaddr
op_plus
id|CSR15
)paren
suffix:semicolon
id|outl
c_func
(paren
id|t21041_csr13
(braket
id|dev-&gt;if_port
)braket
comma
id|ioaddr
op_plus
id|CSR13
)paren
suffix:semicolon
id|next_tick
op_assign
l_int|10
op_star
id|HZ
suffix:semicolon
multiline_comment|/* 2.4 sec. */
)brace
r_else
id|next_tick
op_assign
l_int|30
op_star
id|HZ
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|1
suffix:colon
multiline_comment|/* 10base2 */
r_case
l_int|2
suffix:colon
multiline_comment|/* AUI */
r_if
c_cond
(paren
id|csr12
op_amp
l_int|0x0100
)paren
(brace
id|next_tick
op_assign
(paren
l_int|30
op_star
id|HZ
)paren
suffix:semicolon
multiline_comment|/* 30 sec. */
id|tp-&gt;mediasense
op_assign
l_int|0
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
(paren
id|csr12
op_amp
l_int|0x0004
)paren
op_eq
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: 21041 media switched to 10baseT.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|dev-&gt;if_port
op_assign
l_int|0
suffix:semicolon
id|tulip_select_media
c_func
(paren
id|dev
comma
l_int|0
)paren
suffix:semicolon
id|next_tick
op_assign
(paren
l_int|24
op_star
id|HZ
)paren
op_div
l_int|10
suffix:semicolon
multiline_comment|/* 2.4 sec. */
)brace
r_else
r_if
c_cond
(paren
id|tp-&gt;mediasense
op_logical_or
(paren
id|csr12
op_amp
l_int|0x0002
)paren
)paren
(brace
id|dev-&gt;if_port
op_assign
l_int|3
op_minus
id|dev-&gt;if_port
suffix:semicolon
multiline_comment|/* Swap ports. */
id|tulip_select_media
c_func
(paren
id|dev
comma
l_int|0
)paren
suffix:semicolon
id|next_tick
op_assign
l_int|20
op_star
id|HZ
suffix:semicolon
)brace
r_else
(brace
id|next_tick
op_assign
l_int|20
op_star
id|HZ
suffix:semicolon
)brace
r_break
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|DC21140
suffix:colon
r_case
id|DC21142
suffix:colon
r_case
id|MX98713
suffix:colon
r_case
id|COMPEX9881
suffix:colon
r_case
id|DM910X
suffix:colon
r_default
suffix:colon
(brace
)brace
(brace
r_struct
id|medialeaf
op_star
id|mleaf
suffix:semicolon
r_int
r_char
op_star
id|p
suffix:semicolon
r_if
c_cond
(paren
id|tp-&gt;mtable
op_eq
l_int|NULL
)paren
(brace
multiline_comment|/* No EEPROM info, use generic code. */
multiline_comment|/* Not much that can be done.&n;&t;&t;&t;   Assume this a generic MII or SYM transceiver. */
id|next_tick
op_assign
l_int|60
op_star
id|HZ
suffix:semicolon
r_if
c_cond
(paren
id|tulip_debug
OG
l_int|2
)paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%s: network media monitor CSR6 %8.8x &quot;
l_string|&quot;CSR12 0x%2.2x.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|inl
c_func
(paren
id|ioaddr
op_plus
id|CSR6
)paren
comma
id|csr12
op_amp
l_int|0xff
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|mleaf
op_assign
op_amp
id|tp-&gt;mtable-&gt;mleaf
(braket
id|tp-&gt;cur_index
)braket
suffix:semicolon
id|p
op_assign
id|mleaf-&gt;leafdata
suffix:semicolon
r_switch
c_cond
(paren
id|mleaf-&gt;type
)paren
(brace
r_case
l_int|0
suffix:colon
r_case
l_int|4
suffix:colon
(brace
multiline_comment|/* Type 0 serial or 4 SYM transceiver.  Check the link beat bit. */
r_int
id|offset
op_assign
id|mleaf-&gt;type
op_eq
l_int|4
ques
c_cond
l_int|5
suffix:colon
l_int|2
suffix:semicolon
id|s8
id|bitnum
op_assign
id|p
(braket
id|offset
)braket
suffix:semicolon
r_if
c_cond
(paren
id|p
(braket
id|offset
op_plus
l_int|1
)braket
op_amp
l_int|0x80
)paren
(brace
r_if
c_cond
(paren
id|tulip_debug
OG
l_int|1
)paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%s: Transceiver monitor tick &quot;
l_string|&quot;CSR12=%#2.2x, no media sense.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|csr12
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mleaf-&gt;type
op_eq
l_int|4
)paren
(brace
r_if
c_cond
(paren
id|mleaf-&gt;media
op_eq
l_int|3
op_logical_and
(paren
id|csr12
op_amp
l_int|0x02
)paren
)paren
r_goto
id|select_next_media
suffix:semicolon
)brace
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|tulip_debug
OG
l_int|2
)paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%s: Transceiver monitor tick: CSR12=%#2.2x&quot;
l_string|&quot; bit %d is %d, expecting %d.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|csr12
comma
(paren
id|bitnum
op_rshift
l_int|1
)paren
op_amp
l_int|7
comma
(paren
id|csr12
op_amp
(paren
l_int|1
op_lshift
(paren
(paren
id|bitnum
op_rshift
l_int|1
)paren
op_amp
l_int|7
)paren
)paren
)paren
op_ne
l_int|0
comma
(paren
id|bitnum
op_ge
l_int|0
)paren
)paren
suffix:semicolon
multiline_comment|/* Check that the specified bit has the proper value. */
r_if
c_cond
(paren
(paren
id|bitnum
OL
l_int|0
)paren
op_ne
(paren
(paren
id|csr12
op_amp
(paren
l_int|1
op_lshift
(paren
(paren
id|bitnum
op_rshift
l_int|1
)paren
op_amp
l_int|7
)paren
)paren
)paren
op_ne
l_int|0
)paren
)paren
(brace
r_if
c_cond
(paren
id|tulip_debug
OG
l_int|2
)paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%s: Link beat detected for %s.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|medianame
(braket
id|mleaf-&gt;media
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|p
(braket
l_int|2
)braket
op_amp
l_int|0x61
)paren
op_eq
l_int|0x01
)paren
multiline_comment|/* Bogus Znyx board. */
r_goto
id|actually_mii
suffix:semicolon
id|netif_carrier_on
c_func
(paren
id|dev
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|netif_carrier_off
c_func
(paren
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tp-&gt;medialock
)paren
r_break
suffix:semicolon
id|select_next_media
suffix:colon
r_if
c_cond
(paren
op_decrement
id|tp-&gt;cur_index
OL
l_int|0
)paren
(brace
multiline_comment|/* We start again, but should instead look for default. */
id|tp-&gt;cur_index
op_assign
id|tp-&gt;mtable-&gt;leafcount
op_minus
l_int|1
suffix:semicolon
)brace
id|dev-&gt;if_port
op_assign
id|tp-&gt;mtable-&gt;mleaf
(braket
id|tp-&gt;cur_index
)braket
dot
id|media
suffix:semicolon
r_if
c_cond
(paren
id|tulip_media_cap
(braket
id|dev-&gt;if_port
)braket
op_amp
id|MediaIsFD
)paren
r_goto
id|select_next_media
suffix:semicolon
multiline_comment|/* Skip FD entries. */
r_if
c_cond
(paren
id|tulip_debug
OG
l_int|1
)paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%s: No link beat on media %s,&quot;
l_string|&quot; trying transceiver type %s.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|medianame
(braket
id|mleaf-&gt;media
op_amp
l_int|15
)braket
comma
id|medianame
(braket
id|tp-&gt;mtable-&gt;mleaf
(braket
id|tp-&gt;cur_index
)braket
dot
id|media
)braket
)paren
suffix:semicolon
id|tulip_select_media
c_func
(paren
id|dev
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* Restart the transmit process. */
id|tulip_restart_rxtx
c_func
(paren
id|tp
comma
id|tp-&gt;csr6
)paren
suffix:semicolon
id|next_tick
op_assign
(paren
l_int|24
op_star
id|HZ
)paren
op_div
l_int|10
suffix:semicolon
r_break
suffix:semicolon
)brace
r_case
l_int|1
suffix:colon
r_case
l_int|3
suffix:colon
multiline_comment|/* 21140, 21142 MII */
id|actually_mii
suffix:colon
r_if
c_cond
(paren
id|tulip_check_duplex
c_func
(paren
id|dev
)paren
OL
l_int|0
)paren
id|netif_carrier_off
c_func
(paren
id|dev
)paren
suffix:semicolon
r_else
id|netif_carrier_on
c_func
(paren
id|dev
)paren
suffix:semicolon
id|next_tick
op_assign
l_int|60
op_star
id|HZ
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|2
suffix:colon
multiline_comment|/* 21142 serial block has no link beat. */
r_default
suffix:colon
r_break
suffix:semicolon
)brace
)brace
r_break
suffix:semicolon
)brace
multiline_comment|/* mod_timer synchronizes us with potential add_timer calls&n;&t; * from interrupts.&n;&t; */
id|mod_timer
c_func
(paren
op_amp
id|tp-&gt;timer
comma
id|RUN_AT
c_func
(paren
id|next_tick
)paren
)paren
suffix:semicolon
)brace
DECL|function|mxic_timer
r_void
id|mxic_timer
c_func
(paren
r_int
r_int
id|data
)paren
(brace
r_struct
id|net_device
op_star
id|dev
op_assign
(paren
r_struct
id|net_device
op_star
)paren
id|data
suffix:semicolon
r_struct
id|tulip_private
op_star
id|tp
op_assign
(paren
r_struct
id|tulip_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_int
id|ioaddr
op_assign
id|dev-&gt;base_addr
suffix:semicolon
r_int
id|next_tick
op_assign
l_int|60
op_star
id|HZ
suffix:semicolon
r_if
c_cond
(paren
id|tulip_debug
OG
l_int|3
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: MXIC negotiation status %8.8x.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|inl
c_func
(paren
id|ioaddr
op_plus
id|CSR12
)paren
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|next_tick
)paren
(brace
id|mod_timer
c_func
(paren
op_amp
id|tp-&gt;timer
comma
id|RUN_AT
c_func
(paren
id|next_tick
)paren
)paren
suffix:semicolon
)brace
)brace
DECL|function|comet_timer
r_void
id|comet_timer
c_func
(paren
r_int
r_int
id|data
)paren
(brace
r_struct
id|net_device
op_star
id|dev
op_assign
(paren
r_struct
id|net_device
op_star
)paren
id|data
suffix:semicolon
r_struct
id|tulip_private
op_star
id|tp
op_assign
(paren
r_struct
id|tulip_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_int
id|ioaddr
op_assign
id|dev-&gt;base_addr
suffix:semicolon
r_int
id|next_tick
op_assign
l_int|60
op_star
id|HZ
suffix:semicolon
r_if
c_cond
(paren
id|tulip_debug
OG
l_int|1
)paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%s: Comet link status %4.4x partner capability &quot;
l_string|&quot;%4.4x.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|inl
c_func
(paren
id|ioaddr
op_plus
l_int|0xB8
)paren
comma
id|inl
c_func
(paren
id|ioaddr
op_plus
l_int|0xC8
)paren
)paren
suffix:semicolon
multiline_comment|/* mod_timer synchronizes us with potential add_timer calls&n;&t; * from interrupts.&n;&t; */
id|mod_timer
c_func
(paren
op_amp
id|tp-&gt;timer
comma
id|RUN_AT
c_func
(paren
id|next_tick
)paren
)paren
suffix:semicolon
)brace
eof
