multiline_comment|/*&n; * Network device driver for the BMAC ethernet controller on&n; * Apple Powermacs.  Assumes it&squot;s under a DBDMA controller.&n; *&n; * Copyright (C) 1998 Randy Gobbel.&n; *&n; * May 1999, Al Viro: proper release of /proc/net/bmac entry, switched to&n; * dynamic procfs inode.&n; */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/netdevice.h&gt;
macro_line|#include &lt;linux/etherdevice.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/timer.h&gt;
macro_line|#include &lt;linux/proc_fs.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;asm/prom.h&gt;
macro_line|#include &lt;asm/dbdma.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/page.h&gt;
macro_line|#include &lt;asm/pgtable.h&gt;
macro_line|#include &lt;asm/feature.h&gt;
macro_line|#ifdef CONFIG_PMAC_PBOOK
macro_line|#include &lt;linux/adb.h&gt;
macro_line|#include &lt;linux/pmu.h&gt;
macro_line|#include &lt;asm/irq.h&gt;
macro_line|#endif
macro_line|#include &quot;bmac.h&quot;
DECL|macro|trunc_page
mdefine_line|#define trunc_page(x)&t;((void *)(((unsigned long)(x)) &amp; ~((unsigned long)(PAGE_SIZE - 1))))
DECL|macro|round_page
mdefine_line|#define round_page(x)&t;trunc_page(((unsigned long)(x)) + ((unsigned long)(PAGE_SIZE - 1)))
multiline_comment|/*&n; * CRC polynomial - used in working out multicast filter bits.&n; */
DECL|macro|ENET_CRCPOLY
mdefine_line|#define ENET_CRCPOLY 0x04c11db7
multiline_comment|/* switch to use multicast code lifted from sunhme driver */
DECL|macro|SUNHME_MULTICAST
mdefine_line|#define SUNHME_MULTICAST
DECL|macro|N_RX_RING
mdefine_line|#define N_RX_RING&t;64
DECL|macro|N_TX_RING
mdefine_line|#define N_TX_RING&t;32
DECL|macro|MAX_TX_ACTIVE
mdefine_line|#define MAX_TX_ACTIVE&t;1
DECL|macro|ETHERCRC
mdefine_line|#define ETHERCRC&t;4
DECL|macro|ETHERMINPACKET
mdefine_line|#define ETHERMINPACKET&t;64
DECL|macro|ETHERMTU
mdefine_line|#define ETHERMTU&t;1500
DECL|macro|RX_BUFLEN
mdefine_line|#define RX_BUFLEN&t;(ETHERMTU + 14 + ETHERCRC + 2)
DECL|macro|TX_TIMEOUT
mdefine_line|#define TX_TIMEOUT&t;HZ&t;/* 1 second */
multiline_comment|/* Bits in transmit DMA status */
DECL|macro|TX_DMA_ERR
mdefine_line|#define TX_DMA_ERR&t;0x80
DECL|macro|XXDEBUG
mdefine_line|#define XXDEBUG(args)
DECL|struct|bmac_data
r_struct
id|bmac_data
(brace
multiline_comment|/* volatile struct bmac *bmac; */
DECL|member|queue
r_struct
id|sk_buff_head
op_star
id|queue
suffix:semicolon
DECL|member|tx_dma
r_volatile
r_struct
id|dbdma_regs
op_star
id|tx_dma
suffix:semicolon
DECL|member|tx_dma_intr
r_int
id|tx_dma_intr
suffix:semicolon
DECL|member|rx_dma
r_volatile
r_struct
id|dbdma_regs
op_star
id|rx_dma
suffix:semicolon
DECL|member|rx_dma_intr
r_int
id|rx_dma_intr
suffix:semicolon
DECL|member|tx_cmds
r_volatile
r_struct
id|dbdma_cmd
op_star
id|tx_cmds
suffix:semicolon
multiline_comment|/* xmit dma command list */
DECL|member|rx_cmds
r_volatile
r_struct
id|dbdma_cmd
op_star
id|rx_cmds
suffix:semicolon
multiline_comment|/* recv dma command list */
DECL|member|node
r_struct
id|device_node
op_star
id|node
suffix:semicolon
DECL|member|is_bmac_plus
r_int
id|is_bmac_plus
suffix:semicolon
DECL|member|rx_bufs
r_struct
id|sk_buff
op_star
id|rx_bufs
(braket
id|N_RX_RING
)braket
suffix:semicolon
DECL|member|rx_fill
r_int
id|rx_fill
suffix:semicolon
DECL|member|rx_empty
r_int
id|rx_empty
suffix:semicolon
DECL|member|tx_bufs
r_struct
id|sk_buff
op_star
id|tx_bufs
(braket
id|N_TX_RING
)braket
suffix:semicolon
DECL|member|tx_fill
r_int
id|tx_fill
suffix:semicolon
DECL|member|tx_empty
r_int
id|tx_empty
suffix:semicolon
DECL|member|tx_fullup
r_int
r_char
id|tx_fullup
suffix:semicolon
DECL|member|stats
r_struct
id|net_device_stats
id|stats
suffix:semicolon
DECL|member|tx_timeout
r_struct
id|timer_list
id|tx_timeout
suffix:semicolon
DECL|member|timeout_active
r_int
id|timeout_active
suffix:semicolon
DECL|member|reset_and_enabled
r_int
id|reset_and_enabled
suffix:semicolon
DECL|member|rx_allocated
r_int
id|rx_allocated
suffix:semicolon
DECL|member|tx_allocated
r_int
id|tx_allocated
suffix:semicolon
DECL|member|hash_use_count
r_int
r_int
id|hash_use_count
(braket
l_int|64
)braket
suffix:semicolon
DECL|member|hash_table_mask
r_int
r_int
id|hash_table_mask
(braket
l_int|4
)braket
suffix:semicolon
DECL|member|next_bmac
r_struct
id|net_device
op_star
id|next_bmac
suffix:semicolon
)brace
suffix:semicolon
DECL|struct|bmac_reg_entry
r_typedef
r_struct
id|bmac_reg_entry
(brace
DECL|member|name
r_char
op_star
id|name
suffix:semicolon
DECL|member|reg_offset
r_int
r_int
id|reg_offset
suffix:semicolon
DECL|typedef|bmac_reg_entry_t
)brace
id|bmac_reg_entry_t
suffix:semicolon
DECL|macro|N_REG_ENTRIES
mdefine_line|#define N_REG_ENTRIES 31
DECL|variable|reg_entries
id|bmac_reg_entry_t
id|reg_entries
(braket
id|N_REG_ENTRIES
)braket
op_assign
(brace
(brace
l_string|&quot;MEMADD&quot;
comma
id|MEMADD
)brace
comma
(brace
l_string|&quot;MEMDATAHI&quot;
comma
id|MEMDATAHI
)brace
comma
(brace
l_string|&quot;MEMDATALO&quot;
comma
id|MEMDATALO
)brace
comma
(brace
l_string|&quot;TXPNTR&quot;
comma
id|TXPNTR
)brace
comma
(brace
l_string|&quot;RXPNTR&quot;
comma
id|RXPNTR
)brace
comma
(brace
l_string|&quot;IPG1&quot;
comma
id|IPG1
)brace
comma
(brace
l_string|&quot;IPG2&quot;
comma
id|IPG2
)brace
comma
(brace
l_string|&quot;ALIMIT&quot;
comma
id|ALIMIT
)brace
comma
(brace
l_string|&quot;SLOT&quot;
comma
id|SLOT
)brace
comma
(brace
l_string|&quot;PALEN&quot;
comma
id|PALEN
)brace
comma
(brace
l_string|&quot;PAPAT&quot;
comma
id|PAPAT
)brace
comma
(brace
l_string|&quot;TXSFD&quot;
comma
id|TXSFD
)brace
comma
(brace
l_string|&quot;JAM&quot;
comma
id|JAM
)brace
comma
(brace
l_string|&quot;TXCFG&quot;
comma
id|TXCFG
)brace
comma
(brace
l_string|&quot;TXMAX&quot;
comma
id|TXMAX
)brace
comma
(brace
l_string|&quot;TXMIN&quot;
comma
id|TXMIN
)brace
comma
(brace
l_string|&quot;PAREG&quot;
comma
id|PAREG
)brace
comma
(brace
l_string|&quot;DCNT&quot;
comma
id|DCNT
)brace
comma
(brace
l_string|&quot;NCCNT&quot;
comma
id|NCCNT
)brace
comma
(brace
l_string|&quot;NTCNT&quot;
comma
id|NTCNT
)brace
comma
(brace
l_string|&quot;EXCNT&quot;
comma
id|EXCNT
)brace
comma
(brace
l_string|&quot;LTCNT&quot;
comma
id|LTCNT
)brace
comma
(brace
l_string|&quot;TXSM&quot;
comma
id|TXSM
)brace
comma
(brace
l_string|&quot;RXCFG&quot;
comma
id|RXCFG
)brace
comma
(brace
l_string|&quot;RXMAX&quot;
comma
id|RXMAX
)brace
comma
(brace
l_string|&quot;RXMIN&quot;
comma
id|RXMIN
)brace
comma
(brace
l_string|&quot;FRCNT&quot;
comma
id|FRCNT
)brace
comma
(brace
l_string|&quot;AECNT&quot;
comma
id|AECNT
)brace
comma
(brace
l_string|&quot;FECNT&quot;
comma
id|FECNT
)brace
comma
(brace
l_string|&quot;RXSM&quot;
comma
id|RXSM
)brace
comma
(brace
l_string|&quot;RXCV&quot;
comma
id|RXCV
)brace
)brace
suffix:semicolon
DECL|variable|bmac_devs
r_struct
id|net_device
op_star
id|bmac_devs
op_assign
l_int|NULL
suffix:semicolon
macro_line|#ifdef CONFIG_PMAC_PBOOK
r_int
id|bmac_sleep_notify
c_func
(paren
r_struct
id|pmu_sleep_notifier
op_star
id|self
comma
r_int
id|when
)paren
suffix:semicolon
DECL|variable|bmac_sleep_notifier
r_static
r_struct
id|pmu_sleep_notifier
id|bmac_sleep_notifier
op_assign
(brace
id|bmac_sleep_notify
comma
id|SLEEP_LEVEL_NET
comma
)brace
suffix:semicolon
macro_line|#endif
multiline_comment|/*&n; * Number of bytes of private data per BMAC: allow enough for&n; * the rx and tx dma commands plus a branch dma command each,&n; * and another 16 bytes to allow us to align the dma command&n; * buffers on a 16 byte boundary.&n; */
DECL|macro|PRIV_BYTES
mdefine_line|#define PRIV_BYTES&t;(sizeof(struct bmac_data) &bslash;&n;&t;+ (N_RX_RING + N_TX_RING + 4) * sizeof(struct dbdma_cmd) &bslash;&n;&t;+ sizeof(struct sk_buff_head))
r_static
r_int
r_char
id|bitrev
c_func
(paren
r_int
r_char
id|b
)paren
suffix:semicolon
r_static
r_void
id|bmac_probe1
c_func
(paren
r_struct
id|device_node
op_star
id|bmac
comma
r_int
id|is_bmac_plus
)paren
suffix:semicolon
r_static
r_int
id|bmac_open
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_int
id|bmac_close
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_int
id|bmac_transmit_packet
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_struct
id|net_device_stats
op_star
id|bmac_stats
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_void
id|bmac_set_multicast
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_int
id|bmac_reset_and_enable
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_int
id|enable
)paren
suffix:semicolon
r_static
r_void
id|bmac_start_chip
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_int
id|bmac_init_chip
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_void
id|bmac_init_registers
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_void
id|bmac_reset_chip
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_int
id|bmac_set_address
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_void
op_star
id|addr
)paren
suffix:semicolon
r_static
r_void
id|bmac_misc_intr
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
suffix:semicolon
r_static
r_void
id|bmac_txdma_intr
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
suffix:semicolon
r_static
r_void
id|bmac_rxdma_intr
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
suffix:semicolon
r_static
r_void
id|bmac_set_timeout
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_void
id|bmac_tx_timeout
c_func
(paren
r_int
r_int
id|data
)paren
suffix:semicolon
r_static
r_int
id|bmac_proc_info
(paren
r_char
op_star
id|buffer
comma
r_char
op_star
op_star
id|start
comma
id|off_t
id|offset
comma
r_int
id|length
)paren
suffix:semicolon
r_static
r_int
id|bmac_output
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_void
id|bmac_start
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
DECL|macro|DBDMA_SET
mdefine_line|#define&t;DBDMA_SET(x)&t;( ((x) | (x) &lt;&lt; 16) )
DECL|macro|DBDMA_CLEAR
mdefine_line|#define&t;DBDMA_CLEAR(x)&t;( (x) &lt;&lt; 16)
r_static
id|__inline__
r_void
DECL|function|dbdma_st32
id|dbdma_st32
c_func
(paren
r_volatile
r_int
r_int
op_star
id|a
comma
r_int
r_int
id|x
)paren
(brace
id|__asm__
r_volatile
(paren
l_string|&quot;stwbrx %0,0,%1&quot;
suffix:colon
suffix:colon
l_string|&quot;r&quot;
(paren
id|x
)paren
comma
l_string|&quot;r&quot;
(paren
id|a
)paren
suffix:colon
l_string|&quot;memory&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_static
id|__inline__
r_int
r_int
DECL|function|dbdma_ld32
id|dbdma_ld32
c_func
(paren
r_volatile
r_int
r_int
op_star
id|a
)paren
(brace
r_int
r_int
id|swap
suffix:semicolon
id|__asm__
r_volatile
(paren
l_string|&quot;lwbrx %0,0,%1&quot;
suffix:colon
l_string|&quot;=r&quot;
(paren
id|swap
)paren
suffix:colon
l_string|&quot;r&quot;
(paren
id|a
)paren
)paren
suffix:semicolon
r_return
id|swap
suffix:semicolon
)brace
r_void
DECL|function|dbdma_stop
id|dbdma_stop
c_func
(paren
r_volatile
r_struct
id|dbdma_regs
op_star
id|dmap
)paren
(brace
id|dbdma_st32
c_func
(paren
(paren
r_volatile
r_int
r_int
op_star
)paren
op_amp
id|dmap-&gt;control
comma
id|DBDMA_CLEAR
c_func
(paren
id|RUN
)paren
op_or
id|DBDMA_SET
c_func
(paren
id|FLUSH
)paren
)paren
suffix:semicolon
id|eieio
c_func
(paren
)paren
suffix:semicolon
r_while
c_loop
(paren
id|dbdma_ld32
c_func
(paren
(paren
r_volatile
r_int
r_int
op_star
)paren
op_amp
id|dmap-&gt;status
)paren
op_amp
(paren
id|ACTIVE
op_or
id|FLUSH
)paren
)paren
id|eieio
c_func
(paren
)paren
suffix:semicolon
)brace
r_static
r_void
DECL|function|dbdma_continue
id|dbdma_continue
c_func
(paren
r_volatile
r_struct
id|dbdma_regs
op_star
id|dmap
)paren
(brace
id|dbdma_st32
c_func
(paren
(paren
r_volatile
r_int
r_int
op_star
)paren
op_amp
id|dmap-&gt;control
comma
id|DBDMA_SET
c_func
(paren
id|RUN
op_or
id|WAKE
)paren
op_or
id|DBDMA_CLEAR
c_func
(paren
id|PAUSE
op_or
id|DEAD
)paren
)paren
suffix:semicolon
id|eieio
c_func
(paren
)paren
suffix:semicolon
)brace
r_static
r_void
DECL|function|dbdma_reset
id|dbdma_reset
c_func
(paren
r_volatile
r_struct
id|dbdma_regs
op_star
id|dmap
)paren
(brace
id|dbdma_st32
c_func
(paren
(paren
r_volatile
r_int
r_int
op_star
)paren
op_amp
id|dmap-&gt;control
comma
id|DBDMA_CLEAR
c_func
(paren
id|ACTIVE
op_or
id|DEAD
op_or
id|WAKE
op_or
id|FLUSH
op_or
id|PAUSE
op_or
id|RUN
)paren
)paren
suffix:semicolon
id|eieio
c_func
(paren
)paren
suffix:semicolon
r_while
c_loop
(paren
id|dbdma_ld32
c_func
(paren
(paren
r_volatile
r_int
r_int
op_star
)paren
op_amp
id|dmap-&gt;status
)paren
op_amp
id|RUN
)paren
id|eieio
c_func
(paren
)paren
suffix:semicolon
)brace
r_static
r_void
DECL|function|dbdma_setcmd
id|dbdma_setcmd
c_func
(paren
r_volatile
r_struct
id|dbdma_cmd
op_star
id|cp
comma
r_int
r_int
id|cmd
comma
r_int
id|count
comma
r_int
r_int
id|addr
comma
r_int
r_int
id|cmd_dep
)paren
(brace
id|out_le16
c_func
(paren
op_amp
id|cp-&gt;command
comma
id|cmd
)paren
suffix:semicolon
id|out_le16
c_func
(paren
op_amp
id|cp-&gt;req_count
comma
id|count
)paren
suffix:semicolon
id|out_le32
c_func
(paren
op_amp
id|cp-&gt;phy_addr
comma
id|addr
)paren
suffix:semicolon
id|out_le32
c_func
(paren
op_amp
id|cp-&gt;cmd_dep
comma
id|cmd_dep
)paren
suffix:semicolon
id|out_le16
c_func
(paren
op_amp
id|cp-&gt;xfer_status
comma
l_int|0
)paren
suffix:semicolon
id|out_le16
c_func
(paren
op_amp
id|cp-&gt;res_count
comma
l_int|0
)paren
suffix:semicolon
)brace
r_static
id|__inline__
DECL|function|bmwrite
r_void
id|bmwrite
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_int
r_int
id|reg_offset
comma
r_int
id|data
)paren
(brace
id|out_le16
c_func
(paren
(paren
r_void
op_star
)paren
id|dev-&gt;base_addr
op_plus
id|reg_offset
comma
id|data
)paren
suffix:semicolon
)brace
r_static
id|__inline__
DECL|function|bmread
r_volatile
r_int
r_int
id|bmread
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_int
r_int
id|reg_offset
)paren
(brace
r_return
id|in_le16
c_func
(paren
(paren
r_void
op_star
)paren
id|dev-&gt;base_addr
op_plus
id|reg_offset
)paren
suffix:semicolon
)brace
r_static
r_void
DECL|function|bmac_reset_chip
id|bmac_reset_chip
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|bmac_data
op_star
id|bp
op_assign
(paren
r_struct
id|bmac_data
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_volatile
r_struct
id|dbdma_regs
op_star
id|rd
op_assign
id|bp-&gt;rx_dma
suffix:semicolon
r_volatile
r_struct
id|dbdma_regs
op_star
id|td
op_assign
id|bp-&gt;tx_dma
suffix:semicolon
id|dbdma_reset
c_func
(paren
id|rd
)paren
suffix:semicolon
id|dbdma_reset
c_func
(paren
id|td
)paren
suffix:semicolon
id|feature_set
c_func
(paren
id|bp-&gt;node
comma
id|FEATURE_BMac_IO_enable
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|10000
)paren
suffix:semicolon
id|feature_set
c_func
(paren
id|bp-&gt;node
comma
id|FEATURE_BMac_reset
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|10000
)paren
suffix:semicolon
id|feature_clear
c_func
(paren
id|bp-&gt;node
comma
id|FEATURE_BMac_reset
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|10000
)paren
suffix:semicolon
)brace
DECL|macro|MIFDELAY
mdefine_line|#define MIFDELAY&t;udelay(10)
r_static
r_int
r_int
DECL|function|bmac_mif_readbits
id|bmac_mif_readbits
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_int
id|nb
)paren
(brace
r_int
r_int
id|val
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
op_decrement
id|nb
op_ge
l_int|0
)paren
(brace
id|bmwrite
c_func
(paren
id|dev
comma
id|MIFCSR
comma
l_int|0
)paren
suffix:semicolon
id|MIFDELAY
suffix:semicolon
r_if
c_cond
(paren
id|bmread
c_func
(paren
id|dev
comma
id|MIFCSR
)paren
op_amp
l_int|8
)paren
id|val
op_or_assign
l_int|1
op_lshift
id|nb
suffix:semicolon
id|bmwrite
c_func
(paren
id|dev
comma
id|MIFCSR
comma
l_int|1
)paren
suffix:semicolon
id|MIFDELAY
suffix:semicolon
)brace
id|bmwrite
c_func
(paren
id|dev
comma
id|MIFCSR
comma
l_int|0
)paren
suffix:semicolon
id|MIFDELAY
suffix:semicolon
id|bmwrite
c_func
(paren
id|dev
comma
id|MIFCSR
comma
l_int|1
)paren
suffix:semicolon
id|MIFDELAY
suffix:semicolon
r_return
id|val
suffix:semicolon
)brace
r_static
r_void
DECL|function|bmac_mif_writebits
id|bmac_mif_writebits
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_int
r_int
id|val
comma
r_int
id|nb
)paren
(brace
r_int
id|b
suffix:semicolon
r_while
c_loop
(paren
op_decrement
id|nb
op_ge
l_int|0
)paren
(brace
id|b
op_assign
(paren
id|val
op_amp
(paren
l_int|1
op_lshift
id|nb
)paren
)paren
ques
c_cond
l_int|6
suffix:colon
l_int|4
suffix:semicolon
id|bmwrite
c_func
(paren
id|dev
comma
id|MIFCSR
comma
id|b
)paren
suffix:semicolon
id|MIFDELAY
suffix:semicolon
id|bmwrite
c_func
(paren
id|dev
comma
id|MIFCSR
comma
id|b
op_or
l_int|1
)paren
suffix:semicolon
id|MIFDELAY
suffix:semicolon
)brace
)brace
r_static
r_int
r_int
DECL|function|bmac_mif_read
id|bmac_mif_read
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_int
r_int
id|addr
)paren
(brace
r_int
r_int
id|val
suffix:semicolon
id|bmwrite
c_func
(paren
id|dev
comma
id|MIFCSR
comma
l_int|4
)paren
suffix:semicolon
id|MIFDELAY
suffix:semicolon
id|bmac_mif_writebits
c_func
(paren
id|dev
comma
op_complement
l_int|0U
comma
l_int|32
)paren
suffix:semicolon
id|bmac_mif_writebits
c_func
(paren
id|dev
comma
l_int|6
comma
l_int|4
)paren
suffix:semicolon
id|bmac_mif_writebits
c_func
(paren
id|dev
comma
id|addr
comma
l_int|10
)paren
suffix:semicolon
id|bmwrite
c_func
(paren
id|dev
comma
id|MIFCSR
comma
l_int|2
)paren
suffix:semicolon
id|MIFDELAY
suffix:semicolon
id|bmwrite
c_func
(paren
id|dev
comma
id|MIFCSR
comma
l_int|1
)paren
suffix:semicolon
id|MIFDELAY
suffix:semicolon
id|val
op_assign
id|bmac_mif_readbits
c_func
(paren
id|dev
comma
l_int|17
)paren
suffix:semicolon
id|bmwrite
c_func
(paren
id|dev
comma
id|MIFCSR
comma
l_int|4
)paren
suffix:semicolon
id|MIFDELAY
suffix:semicolon
r_return
id|val
suffix:semicolon
)brace
r_static
r_void
DECL|function|bmac_mif_write
id|bmac_mif_write
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_int
r_int
id|addr
comma
r_int
r_int
id|val
)paren
(brace
id|bmwrite
c_func
(paren
id|dev
comma
id|MIFCSR
comma
l_int|4
)paren
suffix:semicolon
id|MIFDELAY
suffix:semicolon
id|bmac_mif_writebits
c_func
(paren
id|dev
comma
op_complement
l_int|0U
comma
l_int|32
)paren
suffix:semicolon
id|bmac_mif_writebits
c_func
(paren
id|dev
comma
l_int|5
comma
l_int|4
)paren
suffix:semicolon
id|bmac_mif_writebits
c_func
(paren
id|dev
comma
id|addr
comma
l_int|10
)paren
suffix:semicolon
id|bmac_mif_writebits
c_func
(paren
id|dev
comma
l_int|2
comma
l_int|2
)paren
suffix:semicolon
id|bmac_mif_writebits
c_func
(paren
id|dev
comma
id|val
comma
l_int|16
)paren
suffix:semicolon
id|bmac_mif_writebits
c_func
(paren
id|dev
comma
l_int|3
comma
l_int|2
)paren
suffix:semicolon
)brace
r_static
r_void
DECL|function|bmac_init_registers
id|bmac_init_registers
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|bmac_data
op_star
id|bp
op_assign
(paren
r_struct
id|bmac_data
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_volatile
r_int
r_int
id|regValue
suffix:semicolon
r_int
r_int
op_star
id|pWord16
suffix:semicolon
r_int
id|i
suffix:semicolon
multiline_comment|/* XXDEBUG((&quot;bmac: enter init_registers&bslash;n&quot;)); */
id|bmwrite
c_func
(paren
id|dev
comma
id|RXRST
comma
id|RxResetValue
)paren
suffix:semicolon
id|bmwrite
c_func
(paren
id|dev
comma
id|TXRST
comma
id|TxResetBit
)paren
suffix:semicolon
id|i
op_assign
l_int|100
suffix:semicolon
r_do
(brace
op_decrement
id|i
suffix:semicolon
id|udelay
c_func
(paren
l_int|10000
)paren
suffix:semicolon
id|regValue
op_assign
id|bmread
c_func
(paren
id|dev
comma
id|TXRST
)paren
suffix:semicolon
multiline_comment|/* wait for reset to clear..acknowledge */
)brace
r_while
c_loop
(paren
(paren
id|regValue
op_amp
id|TxResetBit
)paren
op_logical_and
id|i
OG
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|bp-&gt;is_bmac_plus
)paren
(brace
id|regValue
op_assign
id|bmread
c_func
(paren
id|dev
comma
id|XCVRIF
)paren
suffix:semicolon
id|regValue
op_or_assign
id|ClkBit
op_or
id|SerialMode
op_or
id|COLActiveLow
suffix:semicolon
id|bmwrite
c_func
(paren
id|dev
comma
id|XCVRIF
comma
id|regValue
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|10000
)paren
suffix:semicolon
)brace
id|bmwrite
c_func
(paren
id|dev
comma
id|RSEED
comma
(paren
r_int
r_int
)paren
l_int|0x1968
)paren
suffix:semicolon
id|regValue
op_assign
id|bmread
c_func
(paren
id|dev
comma
id|XIFC
)paren
suffix:semicolon
id|regValue
op_or_assign
id|TxOutputEnable
suffix:semicolon
id|bmwrite
c_func
(paren
id|dev
comma
id|XIFC
comma
id|regValue
)paren
suffix:semicolon
id|bmread
c_func
(paren
id|dev
comma
id|PAREG
)paren
suffix:semicolon
multiline_comment|/* set collision counters to 0 */
id|bmwrite
c_func
(paren
id|dev
comma
id|NCCNT
comma
l_int|0
)paren
suffix:semicolon
id|bmwrite
c_func
(paren
id|dev
comma
id|NTCNT
comma
l_int|0
)paren
suffix:semicolon
id|bmwrite
c_func
(paren
id|dev
comma
id|EXCNT
comma
l_int|0
)paren
suffix:semicolon
id|bmwrite
c_func
(paren
id|dev
comma
id|LTCNT
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* set rx counters to 0 */
id|bmwrite
c_func
(paren
id|dev
comma
id|FRCNT
comma
l_int|0
)paren
suffix:semicolon
id|bmwrite
c_func
(paren
id|dev
comma
id|LECNT
comma
l_int|0
)paren
suffix:semicolon
id|bmwrite
c_func
(paren
id|dev
comma
id|AECNT
comma
l_int|0
)paren
suffix:semicolon
id|bmwrite
c_func
(paren
id|dev
comma
id|FECNT
comma
l_int|0
)paren
suffix:semicolon
id|bmwrite
c_func
(paren
id|dev
comma
id|RXCV
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* set tx fifo information */
id|bmwrite
c_func
(paren
id|dev
comma
id|TXTH
comma
l_int|4
)paren
suffix:semicolon
multiline_comment|/* 4 octets before tx starts */
id|bmwrite
c_func
(paren
id|dev
comma
id|TXFIFOCSR
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* first disable txFIFO */
id|bmwrite
c_func
(paren
id|dev
comma
id|TXFIFOCSR
comma
id|TxFIFOEnable
)paren
suffix:semicolon
multiline_comment|/* set rx fifo information */
id|bmwrite
c_func
(paren
id|dev
comma
id|RXFIFOCSR
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* first disable rxFIFO */
id|bmwrite
c_func
(paren
id|dev
comma
id|RXFIFOCSR
comma
id|RxFIFOEnable
)paren
suffix:semicolon
singleline_comment|//bmwrite(dev, TXCFG, TxMACEnable);&t;       &t;/* TxNeverGiveUp maybe later */
id|bmread
c_func
(paren
id|dev
comma
id|STATUS
)paren
suffix:semicolon
multiline_comment|/* read it just to clear it */
multiline_comment|/* zero out the chip Hash Filter registers */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|4
suffix:semicolon
id|i
op_increment
)paren
id|bp-&gt;hash_table_mask
(braket
id|i
)braket
op_assign
l_int|0
suffix:semicolon
id|bmwrite
c_func
(paren
id|dev
comma
id|BHASH3
comma
id|bp-&gt;hash_table_mask
(braket
l_int|0
)braket
)paren
suffix:semicolon
multiline_comment|/* bits 15 - 0 */
id|bmwrite
c_func
(paren
id|dev
comma
id|BHASH2
comma
id|bp-&gt;hash_table_mask
(braket
l_int|1
)braket
)paren
suffix:semicolon
multiline_comment|/* bits 31 - 16 */
id|bmwrite
c_func
(paren
id|dev
comma
id|BHASH1
comma
id|bp-&gt;hash_table_mask
(braket
l_int|2
)braket
)paren
suffix:semicolon
multiline_comment|/* bits 47 - 32 */
id|bmwrite
c_func
(paren
id|dev
comma
id|BHASH0
comma
id|bp-&gt;hash_table_mask
(braket
l_int|3
)braket
)paren
suffix:semicolon
multiline_comment|/* bits 63 - 48 */
id|pWord16
op_assign
(paren
r_int
r_int
op_star
)paren
id|dev-&gt;dev_addr
suffix:semicolon
id|bmwrite
c_func
(paren
id|dev
comma
id|MADD0
comma
op_star
id|pWord16
op_increment
)paren
suffix:semicolon
id|bmwrite
c_func
(paren
id|dev
comma
id|MADD1
comma
op_star
id|pWord16
op_increment
)paren
suffix:semicolon
id|bmwrite
c_func
(paren
id|dev
comma
id|MADD2
comma
op_star
id|pWord16
)paren
suffix:semicolon
id|bmwrite
c_func
(paren
id|dev
comma
id|RXCFG
comma
id|RxCRCNoStrip
op_or
id|RxHashFilterEnable
op_or
id|RxRejectOwnPackets
)paren
suffix:semicolon
id|bmwrite
c_func
(paren
id|dev
comma
id|INTDISABLE
comma
id|EnableNormal
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
macro_line|#if 0
r_static
r_void
id|bmac_disable_interrupts
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
id|bmwrite
c_func
(paren
id|dev
comma
id|INTDISABLE
comma
id|DisableAll
)paren
suffix:semicolon
)brace
r_static
r_void
id|bmac_enable_interrupts
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
id|bmwrite
c_func
(paren
id|dev
comma
id|INTDISABLE
comma
id|EnableNormal
)paren
suffix:semicolon
)brace
macro_line|#endif
r_static
r_void
DECL|function|bmac_start_chip
id|bmac_start_chip
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|bmac_data
op_star
id|bp
op_assign
(paren
r_struct
id|bmac_data
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_volatile
r_struct
id|dbdma_regs
op_star
id|rd
op_assign
id|bp-&gt;rx_dma
suffix:semicolon
r_int
r_int
id|oldConfig
suffix:semicolon
multiline_comment|/* enable rx dma channel */
id|dbdma_continue
c_func
(paren
id|rd
)paren
suffix:semicolon
id|oldConfig
op_assign
id|bmread
c_func
(paren
id|dev
comma
id|TXCFG
)paren
suffix:semicolon
id|bmwrite
c_func
(paren
id|dev
comma
id|TXCFG
comma
id|oldConfig
op_or
id|TxMACEnable
)paren
suffix:semicolon
multiline_comment|/* turn on rx plus any other bits already on (promiscuous possibly) */
id|oldConfig
op_assign
id|bmread
c_func
(paren
id|dev
comma
id|RXCFG
)paren
suffix:semicolon
id|bmwrite
c_func
(paren
id|dev
comma
id|RXCFG
comma
id|oldConfig
op_or
id|RxMACEnable
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|20000
)paren
suffix:semicolon
)brace
r_static
r_void
DECL|function|bmac_init_phy
id|bmac_init_phy
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_int
r_int
id|addr
suffix:semicolon
r_struct
id|bmac_data
op_star
id|bp
op_assign
(paren
r_struct
id|bmac_data
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;phy registers:&quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|addr
op_assign
l_int|0
suffix:semicolon
id|addr
OL
l_int|32
suffix:semicolon
op_increment
id|addr
)paren
(brace
r_if
c_cond
(paren
(paren
id|addr
op_amp
l_int|7
)paren
op_eq
l_int|0
)paren
id|printk
c_func
(paren
l_string|&quot;&bslash;n&quot;
id|KERN_DEBUG
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot; %.4x&quot;
comma
id|bmac_mif_read
c_func
(paren
id|dev
comma
id|addr
)paren
)paren
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|bp-&gt;is_bmac_plus
)paren
(brace
r_int
r_int
id|capable
comma
id|ctrl
suffix:semicolon
id|ctrl
op_assign
id|bmac_mif_read
c_func
(paren
id|dev
comma
l_int|0
)paren
suffix:semicolon
id|capable
op_assign
(paren
(paren
id|bmac_mif_read
c_func
(paren
id|dev
comma
l_int|1
)paren
op_amp
l_int|0xf800
)paren
op_rshift
l_int|6
)paren
op_or
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|bmac_mif_read
c_func
(paren
id|dev
comma
l_int|4
)paren
op_ne
id|capable
op_logical_or
(paren
id|ctrl
op_amp
l_int|0x1000
)paren
op_eq
l_int|0
)paren
(brace
id|bmac_mif_write
c_func
(paren
id|dev
comma
l_int|4
comma
id|capable
)paren
suffix:semicolon
id|bmac_mif_write
c_func
(paren
id|dev
comma
l_int|0
comma
l_int|0x1200
)paren
suffix:semicolon
)brace
r_else
id|bmac_mif_write
c_func
(paren
id|dev
comma
l_int|0
comma
l_int|0x1000
)paren
suffix:semicolon
)brace
)brace
r_static
r_int
DECL|function|bmac_init_chip
id|bmac_init_chip
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
id|bmac_init_phy
c_func
(paren
id|dev
)paren
suffix:semicolon
id|bmac_init_registers
c_func
(paren
id|dev
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
macro_line|#ifdef CONFIG_PMAC_PBOOK
r_int
DECL|function|bmac_sleep_notify
id|bmac_sleep_notify
c_func
(paren
r_struct
id|pmu_sleep_notifier
op_star
id|self
comma
r_int
id|when
)paren
(brace
r_struct
id|bmac_data
op_star
id|bp
suffix:semicolon
r_if
c_cond
(paren
id|bmac_devs
op_eq
l_int|0
)paren
r_return
id|PBOOK_SLEEP_OK
suffix:semicolon
id|bp
op_assign
(paren
r_struct
id|bmac_data
op_star
)paren
id|bmac_devs-&gt;priv
suffix:semicolon
r_switch
c_cond
(paren
id|when
)paren
(brace
r_case
id|PBOOK_SLEEP_REQUEST
suffix:colon
r_break
suffix:semicolon
r_case
id|PBOOK_SLEEP_REJECT
suffix:colon
r_break
suffix:semicolon
r_case
id|PBOOK_SLEEP_NOW
suffix:colon
multiline_comment|/* prolly should wait for dma to finish &amp; turn off the chip */
id|disable_irq
c_func
(paren
id|bmac_devs-&gt;irq
)paren
suffix:semicolon
id|disable_irq
c_func
(paren
id|bp-&gt;tx_dma_intr
)paren
suffix:semicolon
id|disable_irq
c_func
(paren
id|bp-&gt;rx_dma_intr
)paren
suffix:semicolon
id|feature_set
c_func
(paren
id|bp-&gt;node
comma
id|FEATURE_BMac_reset
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|10000
)paren
suffix:semicolon
id|feature_clear
c_func
(paren
id|bp-&gt;node
comma
id|FEATURE_BMac_IO_enable
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|10000
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|PBOOK_WAKE
suffix:colon
multiline_comment|/* see if this is enough */
id|bmac_reset_and_enable
c_func
(paren
id|bmac_devs
comma
l_int|1
)paren
suffix:semicolon
id|enable_irq
c_func
(paren
id|bmac_devs-&gt;irq
)paren
suffix:semicolon
id|enable_irq
c_func
(paren
id|bp-&gt;tx_dma_intr
)paren
suffix:semicolon
id|enable_irq
c_func
(paren
id|bp-&gt;rx_dma_intr
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_return
id|PBOOK_SLEEP_OK
suffix:semicolon
)brace
macro_line|#endif
DECL|function|bmac_set_address
r_static
r_int
id|bmac_set_address
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_void
op_star
id|addr
)paren
(brace
r_int
r_char
op_star
id|p
op_assign
id|addr
suffix:semicolon
r_int
r_int
op_star
id|pWord16
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_int
id|i
suffix:semicolon
id|XXDEBUG
c_func
(paren
(paren
l_string|&quot;bmac: enter set_address&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|6
suffix:semicolon
op_increment
id|i
)paren
(brace
id|dev-&gt;dev_addr
(braket
id|i
)braket
op_assign
id|p
(braket
id|i
)braket
suffix:semicolon
)brace
multiline_comment|/* load up the hardware address */
id|pWord16
op_assign
(paren
r_int
r_int
op_star
)paren
id|dev-&gt;dev_addr
suffix:semicolon
id|bmwrite
c_func
(paren
id|dev
comma
id|MADD0
comma
op_star
id|pWord16
op_increment
)paren
suffix:semicolon
id|bmwrite
c_func
(paren
id|dev
comma
id|MADD1
comma
op_star
id|pWord16
op_increment
)paren
suffix:semicolon
id|bmwrite
c_func
(paren
id|dev
comma
id|MADD2
comma
op_star
id|pWord16
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|XXDEBUG
c_func
(paren
(paren
l_string|&quot;bmac: exit set_address&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|bmac_set_timeout
r_static
r_inline
r_void
id|bmac_set_timeout
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|bmac_data
op_star
id|bp
op_assign
(paren
r_struct
id|bmac_data
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|bp-&gt;timeout_active
)paren
id|del_timer
c_func
(paren
op_amp
id|bp-&gt;tx_timeout
)paren
suffix:semicolon
id|bp-&gt;tx_timeout.expires
op_assign
id|jiffies
op_plus
id|TX_TIMEOUT
suffix:semicolon
id|bp-&gt;tx_timeout.function
op_assign
id|bmac_tx_timeout
suffix:semicolon
id|bp-&gt;tx_timeout.data
op_assign
(paren
r_int
r_int
)paren
id|dev
suffix:semicolon
id|add_timer
c_func
(paren
op_amp
id|bp-&gt;tx_timeout
)paren
suffix:semicolon
id|bp-&gt;timeout_active
op_assign
l_int|1
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
r_static
r_void
DECL|function|bmac_construct_xmt
id|bmac_construct_xmt
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_volatile
r_struct
id|dbdma_cmd
op_star
id|cp
)paren
(brace
r_void
op_star
id|vaddr
suffix:semicolon
r_int
r_int
id|baddr
suffix:semicolon
r_int
r_int
id|len
suffix:semicolon
id|len
op_assign
id|skb-&gt;len
suffix:semicolon
id|vaddr
op_assign
id|skb-&gt;data
suffix:semicolon
id|baddr
op_assign
id|virt_to_bus
c_func
(paren
id|vaddr
)paren
suffix:semicolon
id|dbdma_setcmd
c_func
(paren
id|cp
comma
(paren
id|OUTPUT_LAST
op_or
id|INTR_ALWAYS
op_or
id|WAIT_IFCLR
)paren
comma
id|len
comma
id|baddr
comma
l_int|0
)paren
suffix:semicolon
)brace
r_static
r_void
DECL|function|bmac_construct_rxbuff
id|bmac_construct_rxbuff
c_func
(paren
r_int
r_char
op_star
id|addr
comma
r_volatile
r_struct
id|dbdma_cmd
op_star
id|cp
)paren
(brace
id|dbdma_setcmd
c_func
(paren
id|cp
comma
(paren
id|INPUT_LAST
op_or
id|INTR_ALWAYS
)paren
comma
id|RX_BUFLEN
comma
id|virt_to_bus
c_func
(paren
id|addr
)paren
comma
l_int|0
)paren
suffix:semicolon
)brace
multiline_comment|/* Bit-reverse one byte of an ethernet hardware address. */
r_static
r_int
r_char
DECL|function|bitrev
id|bitrev
c_func
(paren
r_int
r_char
id|b
)paren
(brace
r_int
id|d
op_assign
l_int|0
comma
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|8
suffix:semicolon
op_increment
id|i
comma
id|b
op_rshift_assign
l_int|1
)paren
id|d
op_assign
(paren
id|d
op_lshift
l_int|1
)paren
op_or
(paren
id|b
op_amp
l_int|1
)paren
suffix:semicolon
r_return
id|d
suffix:semicolon
)brace
r_static
r_int
DECL|function|bmac_init_tx_ring
id|bmac_init_tx_ring
c_func
(paren
r_struct
id|bmac_data
op_star
id|bp
)paren
(brace
r_volatile
r_struct
id|dbdma_regs
op_star
id|td
op_assign
id|bp-&gt;tx_dma
suffix:semicolon
id|memset
c_func
(paren
(paren
r_char
op_star
)paren
id|bp-&gt;tx_cmds
comma
l_int|0
comma
(paren
id|N_TX_RING
op_plus
l_int|1
)paren
op_star
r_sizeof
(paren
r_struct
id|dbdma_cmd
)paren
)paren
suffix:semicolon
id|bp-&gt;tx_empty
op_assign
l_int|0
suffix:semicolon
id|bp-&gt;tx_fill
op_assign
l_int|0
suffix:semicolon
id|bp-&gt;tx_fullup
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* put a branch at the end of the tx command list */
id|dbdma_setcmd
c_func
(paren
op_amp
id|bp-&gt;tx_cmds
(braket
id|N_TX_RING
)braket
comma
(paren
id|DBDMA_NOP
op_or
id|BR_ALWAYS
)paren
comma
l_int|0
comma
l_int|0
comma
id|virt_to_bus
c_func
(paren
id|bp-&gt;tx_cmds
)paren
)paren
suffix:semicolon
multiline_comment|/* reset tx dma */
id|dbdma_reset
c_func
(paren
id|td
)paren
suffix:semicolon
id|out_le32
c_func
(paren
op_amp
id|td-&gt;wait_sel
comma
l_int|0x00200020
)paren
suffix:semicolon
id|out_le32
c_func
(paren
op_amp
id|td-&gt;cmdptr
comma
id|virt_to_bus
c_func
(paren
id|bp-&gt;tx_cmds
)paren
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
r_static
r_int
DECL|function|bmac_init_rx_ring
id|bmac_init_rx_ring
c_func
(paren
r_struct
id|bmac_data
op_star
id|bp
)paren
(brace
r_volatile
r_struct
id|dbdma_regs
op_star
id|rd
op_assign
id|bp-&gt;rx_dma
suffix:semicolon
r_int
id|i
suffix:semicolon
multiline_comment|/* initialize list of sk_buffs for receiving and set up recv dma */
r_if
c_cond
(paren
op_logical_neg
id|bp-&gt;rx_allocated
)paren
(brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|N_RX_RING
suffix:semicolon
id|i
op_increment
)paren
(brace
id|bp-&gt;rx_bufs
(braket
id|i
)braket
op_assign
id|dev_alloc_skb
c_func
(paren
id|RX_BUFLEN
op_plus
l_int|2
)paren
suffix:semicolon
r_if
c_cond
(paren
id|bp-&gt;rx_bufs
(braket
id|i
)braket
op_eq
l_int|NULL
)paren
r_return
l_int|0
suffix:semicolon
id|skb_reserve
c_func
(paren
id|bp-&gt;rx_bufs
(braket
id|i
)braket
comma
l_int|2
)paren
suffix:semicolon
)brace
id|bp-&gt;rx_allocated
op_assign
l_int|1
suffix:semicolon
)brace
id|memset
c_func
(paren
(paren
r_char
op_star
)paren
id|bp-&gt;rx_cmds
comma
l_int|0
comma
(paren
id|N_RX_RING
op_plus
l_int|1
)paren
op_star
r_sizeof
(paren
r_struct
id|dbdma_cmd
)paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|N_RX_RING
suffix:semicolon
id|i
op_increment
)paren
id|bmac_construct_rxbuff
c_func
(paren
id|bp-&gt;rx_bufs
(braket
id|i
)braket
op_member_access_from_pointer
id|data
comma
op_amp
id|bp-&gt;rx_cmds
(braket
id|i
)braket
)paren
suffix:semicolon
id|bp-&gt;rx_empty
op_assign
l_int|0
suffix:semicolon
id|bp-&gt;rx_fill
op_assign
id|i
suffix:semicolon
multiline_comment|/* Put a branch back to the beginning of the receive command list */
id|dbdma_setcmd
c_func
(paren
op_amp
id|bp-&gt;rx_cmds
(braket
id|N_RX_RING
)braket
comma
(paren
id|DBDMA_NOP
op_or
id|BR_ALWAYS
)paren
comma
l_int|0
comma
l_int|0
comma
id|virt_to_bus
c_func
(paren
id|bp-&gt;rx_cmds
)paren
)paren
suffix:semicolon
multiline_comment|/* start rx dma */
id|dbdma_reset
c_func
(paren
id|rd
)paren
suffix:semicolon
id|out_le32
c_func
(paren
op_amp
id|rd-&gt;cmdptr
comma
id|virt_to_bus
c_func
(paren
id|bp-&gt;rx_cmds
)paren
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
DECL|function|bmac_transmit_packet
r_static
r_int
id|bmac_transmit_packet
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|bmac_data
op_star
id|bp
op_assign
(paren
r_struct
id|bmac_data
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_volatile
r_struct
id|dbdma_regs
op_star
id|td
op_assign
id|bp-&gt;tx_dma
suffix:semicolon
r_int
id|i
suffix:semicolon
multiline_comment|/* see if there&squot;s a free slot in the tx ring */
multiline_comment|/* XXDEBUG((&quot;bmac_xmit_start: empty=%d fill=%d&bslash;n&quot;, */
multiline_comment|/* &t;     bp-&gt;tx_empty, bp-&gt;tx_fill)); */
id|i
op_assign
id|bp-&gt;tx_fill
op_plus
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|i
op_ge
id|N_TX_RING
)paren
id|i
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|i
op_eq
id|bp-&gt;tx_empty
)paren
(brace
id|netif_stop_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
id|bp-&gt;tx_fullup
op_assign
l_int|1
suffix:semicolon
id|XXDEBUG
c_func
(paren
(paren
l_string|&quot;bmac_transmit_packet: tx ring full&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
multiline_comment|/* can&squot;t take it at the moment */
)brace
id|dbdma_setcmd
c_func
(paren
op_amp
id|bp-&gt;tx_cmds
(braket
id|i
)braket
comma
id|DBDMA_STOP
comma
l_int|0
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
id|bmac_construct_xmt
c_func
(paren
id|skb
comma
op_amp
id|bp-&gt;tx_cmds
(braket
id|bp-&gt;tx_fill
)braket
)paren
suffix:semicolon
id|bp-&gt;tx_bufs
(braket
id|bp-&gt;tx_fill
)braket
op_assign
id|skb
suffix:semicolon
id|bp-&gt;tx_fill
op_assign
id|i
suffix:semicolon
id|bp-&gt;stats.tx_bytes
op_add_assign
id|skb-&gt;len
suffix:semicolon
id|dbdma_continue
c_func
(paren
id|td
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|variable|rxintcount
r_static
r_int
id|rxintcount
op_assign
l_int|0
suffix:semicolon
DECL|function|bmac_rxdma_intr
r_static
r_void
id|bmac_rxdma_intr
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_struct
id|net_device
op_star
id|dev
op_assign
(paren
r_struct
id|net_device
op_star
)paren
id|dev_id
suffix:semicolon
r_struct
id|bmac_data
op_star
id|bp
op_assign
(paren
r_struct
id|bmac_data
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_volatile
r_struct
id|dbdma_regs
op_star
id|rd
op_assign
id|bp-&gt;rx_dma
suffix:semicolon
r_volatile
r_struct
id|dbdma_cmd
op_star
id|cp
suffix:semicolon
r_int
id|i
comma
id|nb
comma
id|stat
suffix:semicolon
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
r_int
r_int
id|residual
suffix:semicolon
r_int
id|last
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_increment
id|rxintcount
OL
l_int|10
)paren
(brace
id|XXDEBUG
c_func
(paren
(paren
l_string|&quot;bmac_rxdma_intr&bslash;n&quot;
)paren
)paren
suffix:semicolon
)brace
id|last
op_assign
op_minus
l_int|1
suffix:semicolon
id|i
op_assign
id|bp-&gt;rx_empty
suffix:semicolon
r_while
c_loop
(paren
l_int|1
)paren
(brace
id|cp
op_assign
op_amp
id|bp-&gt;rx_cmds
(braket
id|i
)braket
suffix:semicolon
id|stat
op_assign
id|ld_le16
c_func
(paren
op_amp
id|cp-&gt;xfer_status
)paren
suffix:semicolon
id|residual
op_assign
id|ld_le16
c_func
(paren
op_amp
id|cp-&gt;res_count
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|stat
op_amp
id|ACTIVE
)paren
op_eq
l_int|0
)paren
r_break
suffix:semicolon
id|nb
op_assign
id|RX_BUFLEN
op_minus
id|residual
op_minus
l_int|2
suffix:semicolon
r_if
c_cond
(paren
id|nb
OL
(paren
id|ETHERMINPACKET
op_minus
id|ETHERCRC
)paren
)paren
(brace
id|skb
op_assign
l_int|NULL
suffix:semicolon
id|bp-&gt;stats.rx_length_errors
op_increment
suffix:semicolon
id|bp-&gt;stats.rx_errors
op_increment
suffix:semicolon
)brace
r_else
id|skb
op_assign
id|bp-&gt;rx_bufs
(braket
id|i
)braket
suffix:semicolon
r_if
c_cond
(paren
id|skb
op_ne
l_int|NULL
)paren
(brace
id|nb
op_sub_assign
id|ETHERCRC
suffix:semicolon
id|skb_put
c_func
(paren
id|skb
comma
id|nb
)paren
suffix:semicolon
id|skb-&gt;dev
op_assign
id|dev
suffix:semicolon
id|skb-&gt;protocol
op_assign
id|eth_type_trans
c_func
(paren
id|skb
comma
id|dev
)paren
suffix:semicolon
id|netif_rx
c_func
(paren
id|skb
)paren
suffix:semicolon
id|bp-&gt;rx_bufs
(braket
id|i
)braket
op_assign
id|dev_alloc_skb
c_func
(paren
id|RX_BUFLEN
op_plus
l_int|2
)paren
suffix:semicolon
id|skb_reserve
c_func
(paren
id|bp-&gt;rx_bufs
(braket
id|i
)braket
comma
l_int|2
)paren
suffix:semicolon
id|bmac_construct_rxbuff
c_func
(paren
id|bp-&gt;rx_bufs
(braket
id|i
)braket
op_member_access_from_pointer
id|data
comma
op_amp
id|bp-&gt;rx_cmds
(braket
id|i
)braket
)paren
suffix:semicolon
op_increment
id|bp-&gt;stats.rx_packets
suffix:semicolon
id|bp-&gt;stats.rx_bytes
op_add_assign
id|nb
suffix:semicolon
)brace
r_else
(brace
op_increment
id|bp-&gt;stats.rx_dropped
suffix:semicolon
)brace
id|st_le16
c_func
(paren
op_amp
id|cp-&gt;res_count
comma
l_int|0
)paren
suffix:semicolon
id|st_le16
c_func
(paren
op_amp
id|cp-&gt;xfer_status
comma
l_int|0
)paren
suffix:semicolon
id|last
op_assign
id|i
suffix:semicolon
r_if
c_cond
(paren
op_increment
id|i
op_ge
id|N_RX_RING
)paren
id|i
op_assign
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|last
op_ne
op_minus
l_int|1
)paren
(brace
id|bp-&gt;rx_fill
op_assign
id|last
suffix:semicolon
id|bp-&gt;rx_empty
op_assign
id|i
suffix:semicolon
)brace
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|dbdma_continue
c_func
(paren
id|rd
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rxintcount
OL
l_int|10
)paren
(brace
id|XXDEBUG
c_func
(paren
(paren
l_string|&quot;bmac_rxdma_intr done&bslash;n&quot;
)paren
)paren
suffix:semicolon
)brace
)brace
DECL|variable|txintcount
r_static
r_int
id|txintcount
op_assign
l_int|0
suffix:semicolon
DECL|function|bmac_txdma_intr
r_static
r_void
id|bmac_txdma_intr
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_struct
id|net_device
op_star
id|dev
op_assign
(paren
r_struct
id|net_device
op_star
)paren
id|dev_id
suffix:semicolon
r_struct
id|bmac_data
op_star
id|bp
op_assign
(paren
r_struct
id|bmac_data
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_volatile
r_struct
id|dbdma_cmd
op_star
id|cp
suffix:semicolon
r_int
id|stat
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|txintcount
op_increment
OL
l_int|10
)paren
(brace
id|XXDEBUG
c_func
(paren
(paren
l_string|&quot;bmac_txdma_intr&bslash;n&quot;
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/*     del_timer(&amp;bp-&gt;tx_timeout); */
multiline_comment|/*     bp-&gt;timeout_active = 0; */
r_while
c_loop
(paren
l_int|1
)paren
(brace
id|cp
op_assign
op_amp
id|bp-&gt;tx_cmds
(braket
id|bp-&gt;tx_empty
)braket
suffix:semicolon
id|stat
op_assign
id|ld_le16
c_func
(paren
op_amp
id|cp-&gt;xfer_status
)paren
suffix:semicolon
r_if
c_cond
(paren
id|txintcount
OL
l_int|10
)paren
(brace
id|XXDEBUG
c_func
(paren
(paren
l_string|&quot;bmac_txdma_xfer_stat=%#0x&bslash;n&quot;
comma
id|stat
)paren
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|stat
op_amp
id|ACTIVE
)paren
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
id|bp-&gt;tx_bufs
(braket
id|bp-&gt;tx_empty
)braket
)paren
(brace
op_increment
id|bp-&gt;stats.tx_packets
suffix:semicolon
id|dev_kfree_skb_irq
c_func
(paren
id|bp-&gt;tx_bufs
(braket
id|bp-&gt;tx_empty
)braket
)paren
suffix:semicolon
)brace
id|bp-&gt;tx_bufs
(braket
id|bp-&gt;tx_empty
)braket
op_assign
l_int|NULL
suffix:semicolon
id|bp-&gt;tx_fullup
op_assign
l_int|0
suffix:semicolon
id|netif_wake_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
op_increment
id|bp-&gt;tx_empty
op_ge
id|N_TX_RING
)paren
id|bp-&gt;tx_empty
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|bp-&gt;tx_empty
op_eq
id|bp-&gt;tx_fill
)paren
r_break
suffix:semicolon
)brace
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|txintcount
OL
l_int|10
)paren
(brace
id|XXDEBUG
c_func
(paren
(paren
l_string|&quot;bmac_txdma_intr done-&gt;bmac_start&bslash;n&quot;
)paren
)paren
suffix:semicolon
)brace
id|bmac_start
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
DECL|function|bmac_stats
r_static
r_struct
id|net_device_stats
op_star
id|bmac_stats
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|bmac_data
op_star
id|p
op_assign
(paren
r_struct
id|bmac_data
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_return
op_amp
id|p-&gt;stats
suffix:semicolon
)brace
macro_line|#ifndef SUNHME_MULTICAST
multiline_comment|/* Real fast bit-reversal algorithm, 6-bit values */
DECL|variable|reverse6
r_static
r_int
id|reverse6
(braket
l_int|64
)braket
op_assign
(brace
l_int|0x0
comma
l_int|0x20
comma
l_int|0x10
comma
l_int|0x30
comma
l_int|0x8
comma
l_int|0x28
comma
l_int|0x18
comma
l_int|0x38
comma
l_int|0x4
comma
l_int|0x24
comma
l_int|0x14
comma
l_int|0x34
comma
l_int|0xc
comma
l_int|0x2c
comma
l_int|0x1c
comma
l_int|0x3c
comma
l_int|0x2
comma
l_int|0x22
comma
l_int|0x12
comma
l_int|0x32
comma
l_int|0xa
comma
l_int|0x2a
comma
l_int|0x1a
comma
l_int|0x3a
comma
l_int|0x6
comma
l_int|0x26
comma
l_int|0x16
comma
l_int|0x36
comma
l_int|0xe
comma
l_int|0x2e
comma
l_int|0x1e
comma
l_int|0x3e
comma
l_int|0x1
comma
l_int|0x21
comma
l_int|0x11
comma
l_int|0x31
comma
l_int|0x9
comma
l_int|0x29
comma
l_int|0x19
comma
l_int|0x39
comma
l_int|0x5
comma
l_int|0x25
comma
l_int|0x15
comma
l_int|0x35
comma
l_int|0xd
comma
l_int|0x2d
comma
l_int|0x1d
comma
l_int|0x3d
comma
l_int|0x3
comma
l_int|0x23
comma
l_int|0x13
comma
l_int|0x33
comma
l_int|0xb
comma
l_int|0x2b
comma
l_int|0x1b
comma
l_int|0x3b
comma
l_int|0x7
comma
l_int|0x27
comma
l_int|0x17
comma
l_int|0x37
comma
l_int|0xf
comma
l_int|0x2f
comma
l_int|0x1f
comma
l_int|0x3f
)brace
suffix:semicolon
r_static
r_int
r_int
DECL|function|crc416
id|crc416
c_func
(paren
r_int
r_int
id|curval
comma
r_int
r_int
id|nxtval
)paren
(brace
r_register
r_int
r_int
id|counter
comma
id|cur
op_assign
id|curval
comma
id|next
op_assign
id|nxtval
suffix:semicolon
r_register
r_int
id|high_crc_set
comma
id|low_data_set
suffix:semicolon
multiline_comment|/* Swap bytes */
id|next
op_assign
(paren
(paren
id|next
op_amp
l_int|0x00FF
)paren
op_lshift
l_int|8
)paren
op_or
(paren
id|next
op_rshift
l_int|8
)paren
suffix:semicolon
multiline_comment|/* Compute bit-by-bit */
r_for
c_loop
(paren
id|counter
op_assign
l_int|0
suffix:semicolon
id|counter
OL
l_int|16
suffix:semicolon
op_increment
id|counter
)paren
(brace
multiline_comment|/* is high CRC bit set? */
r_if
c_cond
(paren
(paren
id|cur
op_amp
l_int|0x80000000
)paren
op_eq
l_int|0
)paren
id|high_crc_set
op_assign
l_int|0
suffix:semicolon
r_else
id|high_crc_set
op_assign
l_int|1
suffix:semicolon
id|cur
op_assign
id|cur
op_lshift
l_int|1
suffix:semicolon
r_if
c_cond
(paren
(paren
id|next
op_amp
l_int|0x0001
)paren
op_eq
l_int|0
)paren
id|low_data_set
op_assign
l_int|0
suffix:semicolon
r_else
id|low_data_set
op_assign
l_int|1
suffix:semicolon
id|next
op_assign
id|next
op_rshift
l_int|1
suffix:semicolon
multiline_comment|/* do the XOR */
r_if
c_cond
(paren
id|high_crc_set
op_xor
id|low_data_set
)paren
id|cur
op_assign
id|cur
op_xor
id|ENET_CRCPOLY
suffix:semicolon
)brace
r_return
id|cur
suffix:semicolon
)brace
r_static
r_int
r_int
DECL|function|bmac_crc
id|bmac_crc
c_func
(paren
r_int
r_int
op_star
id|address
)paren
(brace
r_int
r_int
id|newcrc
suffix:semicolon
id|XXDEBUG
c_func
(paren
(paren
l_string|&quot;bmac_crc: addr=%#04x, %#04x, %#04x&bslash;n&quot;
comma
op_star
id|address
comma
id|address
(braket
l_int|1
)braket
comma
id|address
(braket
l_int|2
)braket
)paren
)paren
suffix:semicolon
id|newcrc
op_assign
id|crc416
c_func
(paren
l_int|0xffffffff
comma
op_star
id|address
)paren
suffix:semicolon
multiline_comment|/* address bits 47 - 32 */
id|newcrc
op_assign
id|crc416
c_func
(paren
id|newcrc
comma
id|address
(braket
l_int|1
)braket
)paren
suffix:semicolon
multiline_comment|/* address bits 31 - 16 */
id|newcrc
op_assign
id|crc416
c_func
(paren
id|newcrc
comma
id|address
(braket
l_int|2
)braket
)paren
suffix:semicolon
multiline_comment|/* address bits 15 - 0  */
r_return
id|newcrc
suffix:semicolon
)brace
multiline_comment|/*&n; * Add requested mcast addr to BMac&squot;s hash table filter.&n; *&n; */
r_static
r_void
DECL|function|bmac_addhash
id|bmac_addhash
c_func
(paren
r_struct
id|bmac_data
op_star
id|bp
comma
r_int
r_char
op_star
id|addr
)paren
(brace
r_int
r_int
id|crc
suffix:semicolon
r_int
r_int
id|mask
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
op_star
id|addr
)paren
)paren
r_return
suffix:semicolon
id|crc
op_assign
id|bmac_crc
c_func
(paren
(paren
r_int
r_int
op_star
)paren
id|addr
)paren
op_amp
l_int|0x3f
suffix:semicolon
multiline_comment|/* Big-endian alert! */
id|crc
op_assign
id|reverse6
(braket
id|crc
)braket
suffix:semicolon
multiline_comment|/* Hyperfast bit-reversing algorithm */
r_if
c_cond
(paren
id|bp-&gt;hash_use_count
(braket
id|crc
)braket
op_increment
)paren
r_return
suffix:semicolon
multiline_comment|/* This bit is already set */
id|mask
op_assign
id|crc
op_mod
l_int|16
suffix:semicolon
id|mask
op_assign
(paren
r_int
r_char
)paren
l_int|1
op_lshift
id|mask
suffix:semicolon
id|bp-&gt;hash_use_count
(braket
id|crc
op_div
l_int|16
)braket
op_or_assign
id|mask
suffix:semicolon
)brace
r_static
r_void
DECL|function|bmac_removehash
id|bmac_removehash
c_func
(paren
r_struct
id|bmac_data
op_star
id|bp
comma
r_int
r_char
op_star
id|addr
)paren
(brace
r_int
r_int
id|crc
suffix:semicolon
r_int
r_char
id|mask
suffix:semicolon
multiline_comment|/* Now, delete the address from the filter copy, as indicated */
id|crc
op_assign
id|bmac_crc
c_func
(paren
(paren
r_int
r_int
op_star
)paren
id|addr
)paren
op_amp
l_int|0x3f
suffix:semicolon
multiline_comment|/* Big-endian alert! */
id|crc
op_assign
id|reverse6
(braket
id|crc
)braket
suffix:semicolon
multiline_comment|/* Hyperfast bit-reversing algorithm */
r_if
c_cond
(paren
id|bp-&gt;hash_use_count
(braket
id|crc
)braket
op_eq
l_int|0
)paren
r_return
suffix:semicolon
multiline_comment|/* That bit wasn&squot;t in use! */
r_if
c_cond
(paren
op_decrement
id|bp-&gt;hash_use_count
(braket
id|crc
)braket
)paren
r_return
suffix:semicolon
multiline_comment|/* That bit is still in use */
id|mask
op_assign
id|crc
op_mod
l_int|16
suffix:semicolon
id|mask
op_assign
(paren
(paren
r_int
r_char
)paren
l_int|1
op_lshift
id|mask
)paren
op_xor
l_int|0xffff
suffix:semicolon
multiline_comment|/* To turn off bit */
id|bp-&gt;hash_table_mask
(braket
id|crc
op_div
l_int|16
)braket
op_and_assign
id|mask
suffix:semicolon
)brace
multiline_comment|/*&n; * Sync the adapter with the software copy of the multicast mask&n; *  (logical address filter).&n; */
r_static
r_void
DECL|function|bmac_rx_off
id|bmac_rx_off
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_int
r_int
id|rx_cfg
suffix:semicolon
id|rx_cfg
op_assign
id|bmread
c_func
(paren
id|dev
comma
id|RXCFG
)paren
suffix:semicolon
id|rx_cfg
op_and_assign
op_complement
id|RxMACEnable
suffix:semicolon
id|bmwrite
c_func
(paren
id|dev
comma
id|RXCFG
comma
id|rx_cfg
)paren
suffix:semicolon
r_do
(brace
id|rx_cfg
op_assign
id|bmread
c_func
(paren
id|dev
comma
id|RXCFG
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
id|rx_cfg
op_amp
id|RxMACEnable
)paren
suffix:semicolon
)brace
r_int
r_int
DECL|function|bmac_rx_on
id|bmac_rx_on
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_int
id|hash_enable
comma
r_int
id|promisc_enable
)paren
(brace
r_int
r_int
id|rx_cfg
suffix:semicolon
id|rx_cfg
op_assign
id|bmread
c_func
(paren
id|dev
comma
id|RXCFG
)paren
suffix:semicolon
id|rx_cfg
op_or_assign
id|RxMACEnable
suffix:semicolon
r_if
c_cond
(paren
id|hash_enable
)paren
id|rx_cfg
op_or_assign
id|RxHashFilterEnable
suffix:semicolon
r_else
id|rx_cfg
op_and_assign
op_complement
id|RxHashFilterEnable
suffix:semicolon
r_if
c_cond
(paren
id|promisc_enable
)paren
id|rx_cfg
op_or_assign
id|RxPromiscEnable
suffix:semicolon
r_else
id|rx_cfg
op_and_assign
op_complement
id|RxPromiscEnable
suffix:semicolon
id|bmwrite
c_func
(paren
id|dev
comma
id|RXRST
comma
id|RxResetValue
)paren
suffix:semicolon
id|bmwrite
c_func
(paren
id|dev
comma
id|RXFIFOCSR
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* first disable rxFIFO */
id|bmwrite
c_func
(paren
id|dev
comma
id|RXFIFOCSR
comma
id|RxFIFOEnable
)paren
suffix:semicolon
id|bmwrite
c_func
(paren
id|dev
comma
id|RXCFG
comma
id|rx_cfg
)paren
suffix:semicolon
r_return
id|rx_cfg
suffix:semicolon
)brace
r_static
r_void
DECL|function|bmac_update_hash_table_mask
id|bmac_update_hash_table_mask
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_struct
id|bmac_data
op_star
id|bp
)paren
(brace
id|bmwrite
c_func
(paren
id|dev
comma
id|BHASH3
comma
id|bp-&gt;hash_table_mask
(braket
l_int|0
)braket
)paren
suffix:semicolon
multiline_comment|/* bits 15 - 0 */
id|bmwrite
c_func
(paren
id|dev
comma
id|BHASH2
comma
id|bp-&gt;hash_table_mask
(braket
l_int|1
)braket
)paren
suffix:semicolon
multiline_comment|/* bits 31 - 16 */
id|bmwrite
c_func
(paren
id|dev
comma
id|BHASH1
comma
id|bp-&gt;hash_table_mask
(braket
l_int|2
)braket
)paren
suffix:semicolon
multiline_comment|/* bits 47 - 32 */
id|bmwrite
c_func
(paren
id|dev
comma
id|BHASH0
comma
id|bp-&gt;hash_table_mask
(braket
l_int|3
)braket
)paren
suffix:semicolon
multiline_comment|/* bits 63 - 48 */
)brace
macro_line|#if 0
r_static
r_void
id|bmac_add_multi
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_struct
id|bmac_data
op_star
id|bp
comma
r_int
r_char
op_star
id|addr
)paren
(brace
multiline_comment|/* XXDEBUG((&quot;bmac: enter bmac_add_multi&bslash;n&quot;)); */
id|bmac_addhash
c_func
(paren
id|bp
comma
id|addr
)paren
suffix:semicolon
id|bmac_rx_off
c_func
(paren
id|dev
)paren
suffix:semicolon
id|bmac_update_hash_table_mask
c_func
(paren
id|dev
comma
id|bp
)paren
suffix:semicolon
id|bmac_rx_on
c_func
(paren
id|dev
comma
l_int|1
comma
(paren
id|dev-&gt;flags
op_amp
id|IFF_PROMISC
)paren
ques
c_cond
l_int|1
suffix:colon
l_int|0
)paren
suffix:semicolon
multiline_comment|/* XXDEBUG((&quot;bmac: exit bmac_add_multi&bslash;n&quot;)); */
)brace
r_static
r_void
id|bmac_remove_multi
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_struct
id|bmac_data
op_star
id|bp
comma
r_int
r_char
op_star
id|addr
)paren
(brace
id|bmac_removehash
c_func
(paren
id|bp
comma
id|addr
)paren
suffix:semicolon
id|bmac_rx_off
c_func
(paren
id|dev
)paren
suffix:semicolon
id|bmac_update_hash_table_mask
c_func
(paren
id|dev
comma
id|bp
)paren
suffix:semicolon
id|bmac_rx_on
c_func
(paren
id|dev
comma
l_int|1
comma
(paren
id|dev-&gt;flags
op_amp
id|IFF_PROMISC
)paren
ques
c_cond
l_int|1
suffix:colon
l_int|0
)paren
suffix:semicolon
)brace
macro_line|#endif
multiline_comment|/* Set or clear the multicast filter for this adaptor.&n;    num_addrs == -1&t;Promiscuous mode, receive all packets&n;    num_addrs == 0&t;Normal mode, clear multicast list&n;    num_addrs &gt; 0&t;Multicast mode, receive normal and MC packets, and do&n;&t;&t;&t;best-effort filtering.&n; */
DECL|function|bmac_set_multicast
r_static
r_void
id|bmac_set_multicast
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|dev_mc_list
op_star
id|dmi
suffix:semicolon
r_struct
id|bmac_data
op_star
id|bp
op_assign
(paren
r_struct
id|bmac_data
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_int
id|num_addrs
op_assign
id|dev-&gt;mc_count
suffix:semicolon
r_int
r_int
id|rx_cfg
suffix:semicolon
r_int
id|i
suffix:semicolon
id|XXDEBUG
c_func
(paren
(paren
l_string|&quot;bmac: enter bmac_set_multicast, n_addrs=%d&bslash;n&quot;
comma
id|num_addrs
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|dev-&gt;flags
op_amp
id|IFF_ALLMULTI
)paren
op_logical_or
(paren
id|dev-&gt;mc_count
OG
l_int|64
)paren
)paren
(brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|4
suffix:semicolon
id|i
op_increment
)paren
id|bp-&gt;hash_table_mask
(braket
id|i
)braket
op_assign
l_int|0xffff
suffix:semicolon
id|bmac_update_hash_table_mask
c_func
(paren
id|dev
comma
id|bp
)paren
suffix:semicolon
id|rx_cfg
op_assign
id|bmac_rx_on
c_func
(paren
id|dev
comma
l_int|1
comma
l_int|0
)paren
suffix:semicolon
id|XXDEBUG
c_func
(paren
(paren
l_string|&quot;bmac: all multi, rx_cfg=%#08x&bslash;n&quot;
)paren
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
(paren
id|dev-&gt;flags
op_amp
id|IFF_PROMISC
)paren
op_logical_or
(paren
id|num_addrs
OL
l_int|0
)paren
)paren
(brace
id|rx_cfg
op_assign
id|bmread
c_func
(paren
id|dev
comma
id|RXCFG
)paren
suffix:semicolon
id|rx_cfg
op_or_assign
id|RxPromiscEnable
suffix:semicolon
id|bmwrite
c_func
(paren
id|dev
comma
id|RXCFG
comma
id|rx_cfg
)paren
suffix:semicolon
id|rx_cfg
op_assign
id|bmac_rx_on
c_func
(paren
id|dev
comma
l_int|0
comma
l_int|1
)paren
suffix:semicolon
id|XXDEBUG
c_func
(paren
(paren
l_string|&quot;bmac: promisc mode enabled, rx_cfg=%#08x&bslash;n&quot;
comma
id|rx_cfg
)paren
)paren
suffix:semicolon
)brace
r_else
(brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|4
suffix:semicolon
id|i
op_increment
)paren
id|bp-&gt;hash_table_mask
(braket
id|i
)braket
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|64
suffix:semicolon
id|i
op_increment
)paren
id|bp-&gt;hash_use_count
(braket
id|i
)braket
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|num_addrs
op_eq
l_int|0
)paren
(brace
id|rx_cfg
op_assign
id|bmac_rx_on
c_func
(paren
id|dev
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
id|XXDEBUG
c_func
(paren
(paren
l_string|&quot;bmac: multi disabled, rx_cfg=%#08x&bslash;n&quot;
comma
id|rx_cfg
)paren
)paren
suffix:semicolon
)brace
r_else
(brace
r_for
c_loop
(paren
id|dmi
op_assign
id|dev-&gt;mc_list
suffix:semicolon
id|dmi
op_ne
l_int|NULL
suffix:semicolon
id|dmi
op_assign
id|dmi-&gt;next
)paren
id|bmac_addhash
c_func
(paren
id|bp
comma
id|dmi-&gt;dmi_addr
)paren
suffix:semicolon
id|bmac_update_hash_table_mask
c_func
(paren
id|dev
comma
id|bp
)paren
suffix:semicolon
id|rx_cfg
op_assign
id|bmac_rx_on
c_func
(paren
id|dev
comma
l_int|1
comma
l_int|0
)paren
suffix:semicolon
id|XXDEBUG
c_func
(paren
(paren
l_string|&quot;bmac: multi enabled, rx_cfg=%#08x&bslash;n&quot;
comma
id|rx_cfg
)paren
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* XXDEBUG((&quot;bmac: exit bmac_set_multicast&bslash;n&quot;)); */
)brace
macro_line|#else /* ifdef SUNHME_MULTICAST */
multiline_comment|/* The version of set_multicast below was lifted from sunhme.c */
DECL|macro|CRC_POLYNOMIAL_BE
mdefine_line|#define CRC_POLYNOMIAL_BE 0x04c11db7UL  /* Ethernet CRC, big endian */
DECL|macro|CRC_POLYNOMIAL_LE
mdefine_line|#define CRC_POLYNOMIAL_LE 0xedb88320UL  /* Ethernet CRC, little endian */
DECL|function|bmac_set_multicast
r_static
r_void
id|bmac_set_multicast
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|dev_mc_list
op_star
id|dmi
op_assign
id|dev-&gt;mc_list
suffix:semicolon
r_char
op_star
id|addrs
suffix:semicolon
r_int
id|i
comma
id|j
comma
id|bit
comma
id|byte
suffix:semicolon
r_int
r_int
id|rx_cfg
suffix:semicolon
id|u32
id|crc
comma
id|poly
op_assign
id|CRC_POLYNOMIAL_LE
suffix:semicolon
r_if
c_cond
(paren
(paren
id|dev-&gt;flags
op_amp
id|IFF_ALLMULTI
)paren
op_logical_or
(paren
id|dev-&gt;mc_count
OG
l_int|64
)paren
)paren
(brace
id|bmwrite
c_func
(paren
id|dev
comma
id|BHASH0
comma
l_int|0xffff
)paren
suffix:semicolon
id|bmwrite
c_func
(paren
id|dev
comma
id|BHASH1
comma
l_int|0xffff
)paren
suffix:semicolon
id|bmwrite
c_func
(paren
id|dev
comma
id|BHASH2
comma
l_int|0xffff
)paren
suffix:semicolon
id|bmwrite
c_func
(paren
id|dev
comma
id|BHASH3
comma
l_int|0xffff
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|dev-&gt;flags
op_amp
id|IFF_PROMISC
)paren
(brace
id|rx_cfg
op_assign
id|bmread
c_func
(paren
id|dev
comma
id|RXCFG
)paren
suffix:semicolon
id|rx_cfg
op_or_assign
id|RxPromiscEnable
suffix:semicolon
id|bmwrite
c_func
(paren
id|dev
comma
id|RXCFG
comma
id|rx_cfg
)paren
suffix:semicolon
)brace
r_else
(brace
id|u16
id|hash_table
(braket
l_int|4
)braket
suffix:semicolon
id|rx_cfg
op_assign
id|bmread
c_func
(paren
id|dev
comma
id|RXCFG
)paren
suffix:semicolon
id|rx_cfg
op_and_assign
op_complement
id|RxPromiscEnable
suffix:semicolon
id|bmwrite
c_func
(paren
id|dev
comma
id|RXCFG
comma
id|rx_cfg
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|4
suffix:semicolon
id|i
op_increment
)paren
(brace
id|hash_table
(braket
id|i
)braket
op_assign
l_int|0
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|dev-&gt;mc_count
suffix:semicolon
id|i
op_increment
)paren
(brace
id|addrs
op_assign
id|dmi-&gt;dmi_addr
suffix:semicolon
id|dmi
op_assign
id|dmi-&gt;next
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
op_star
id|addrs
op_amp
l_int|1
)paren
)paren
(brace
r_continue
suffix:semicolon
)brace
id|crc
op_assign
l_int|0xffffffffU
suffix:semicolon
r_for
c_loop
(paren
id|byte
op_assign
l_int|0
suffix:semicolon
id|byte
OL
l_int|6
suffix:semicolon
id|byte
op_increment
)paren
(brace
r_for
c_loop
(paren
id|bit
op_assign
op_star
id|addrs
op_increment
comma
id|j
op_assign
l_int|0
suffix:semicolon
id|j
OL
l_int|8
suffix:semicolon
id|j
op_increment
comma
id|bit
op_rshift_assign
l_int|1
)paren
(brace
r_int
id|test
suffix:semicolon
id|test
op_assign
(paren
(paren
id|bit
op_xor
id|crc
)paren
op_amp
l_int|0x01
)paren
suffix:semicolon
id|crc
op_rshift_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|test
)paren
(brace
id|crc
op_assign
id|crc
op_xor
id|poly
suffix:semicolon
)brace
)brace
)brace
id|crc
op_rshift_assign
l_int|26
suffix:semicolon
id|hash_table
(braket
id|crc
op_rshift
l_int|4
)braket
op_or_assign
l_int|1
op_lshift
(paren
id|crc
op_amp
l_int|0xf
)paren
suffix:semicolon
)brace
id|bmwrite
c_func
(paren
id|dev
comma
id|BHASH0
comma
id|hash_table
(braket
l_int|0
)braket
)paren
suffix:semicolon
id|bmwrite
c_func
(paren
id|dev
comma
id|BHASH1
comma
id|hash_table
(braket
l_int|1
)braket
)paren
suffix:semicolon
id|bmwrite
c_func
(paren
id|dev
comma
id|BHASH2
comma
id|hash_table
(braket
l_int|2
)braket
)paren
suffix:semicolon
id|bmwrite
c_func
(paren
id|dev
comma
id|BHASH3
comma
id|hash_table
(braket
l_int|3
)braket
)paren
suffix:semicolon
)brace
)brace
macro_line|#endif /* SUNHME_MULTICAST */
DECL|variable|miscintcount
r_static
r_int
id|miscintcount
op_assign
l_int|0
suffix:semicolon
DECL|function|bmac_misc_intr
r_static
r_void
id|bmac_misc_intr
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_struct
id|net_device
op_star
id|dev
op_assign
(paren
r_struct
id|net_device
op_star
)paren
id|dev_id
suffix:semicolon
r_struct
id|bmac_data
op_star
id|bp
op_assign
(paren
r_struct
id|bmac_data
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_int
r_int
id|status
op_assign
id|bmread
c_func
(paren
id|dev
comma
id|STATUS
)paren
suffix:semicolon
r_if
c_cond
(paren
id|miscintcount
op_increment
OL
l_int|10
)paren
(brace
id|XXDEBUG
c_func
(paren
(paren
l_string|&quot;bmac_misc_intr&bslash;n&quot;
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/* XXDEBUG((&quot;bmac_misc_intr, status=%#08x&bslash;n&quot;, status)); */
multiline_comment|/*     bmac_txdma_intr_inner(irq, dev_id, regs); */
multiline_comment|/*   if (status &amp; FrameReceived) bp-&gt;stats.rx_dropped++; */
r_if
c_cond
(paren
id|status
op_amp
id|RxErrorMask
)paren
id|bp-&gt;stats.rx_errors
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
id|RxCRCCntExp
)paren
id|bp-&gt;stats.rx_crc_errors
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
id|RxLenCntExp
)paren
id|bp-&gt;stats.rx_length_errors
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
id|RxOverFlow
)paren
id|bp-&gt;stats.rx_over_errors
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
id|RxAlignCntExp
)paren
id|bp-&gt;stats.rx_frame_errors
op_increment
suffix:semicolon
multiline_comment|/*   if (status &amp; FrameSent) bp-&gt;stats.tx_dropped++; */
r_if
c_cond
(paren
id|status
op_amp
id|TxErrorMask
)paren
id|bp-&gt;stats.tx_errors
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
id|TxUnderrun
)paren
id|bp-&gt;stats.tx_fifo_errors
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
id|TxNormalCollExp
)paren
id|bp-&gt;stats.collisions
op_increment
suffix:semicolon
)brace
multiline_comment|/*&n; * Procedure for reading EEPROM&n; */
DECL|macro|SROMAddressLength
mdefine_line|#define SROMAddressLength&t;5
DECL|macro|DataInOn
mdefine_line|#define DataInOn&t;&t;0x0008
DECL|macro|DataInOff
mdefine_line|#define DataInOff&t;&t;0x0000
DECL|macro|Clk
mdefine_line|#define Clk&t;&t;&t;0x0002
DECL|macro|ChipSelect
mdefine_line|#define ChipSelect&t;&t;0x0001
DECL|macro|SDIShiftCount
mdefine_line|#define SDIShiftCount&t;&t;3
DECL|macro|SD0ShiftCount
mdefine_line|#define SD0ShiftCount&t;&t;2
DECL|macro|DelayValue
mdefine_line|#define&t;DelayValue&t;&t;1000&t;/* number of microseconds */
DECL|macro|SROMStartOffset
mdefine_line|#define SROMStartOffset&t;&t;10&t;/* this is in words */
DECL|macro|SROMReadCount
mdefine_line|#define SROMReadCount&t;&t;3&t;/* number of words to read from SROM */
DECL|macro|SROMAddressBits
mdefine_line|#define SROMAddressBits&t;&t;6
DECL|macro|EnetAddressOffset
mdefine_line|#define EnetAddressOffset&t;20
r_static
r_int
r_char
DECL|function|bmac_clock_out_bit
id|bmac_clock_out_bit
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_int
r_int
id|data
suffix:semicolon
r_int
r_int
id|val
suffix:semicolon
id|bmwrite
c_func
(paren
id|dev
comma
id|SROMCSR
comma
id|ChipSelect
op_or
id|Clk
)paren
suffix:semicolon
id|udelay
c_func
(paren
id|DelayValue
)paren
suffix:semicolon
id|data
op_assign
id|bmread
c_func
(paren
id|dev
comma
id|SROMCSR
)paren
suffix:semicolon
id|udelay
c_func
(paren
id|DelayValue
)paren
suffix:semicolon
id|val
op_assign
(paren
id|data
op_rshift
id|SD0ShiftCount
)paren
op_amp
l_int|1
suffix:semicolon
id|bmwrite
c_func
(paren
id|dev
comma
id|SROMCSR
comma
id|ChipSelect
)paren
suffix:semicolon
id|udelay
c_func
(paren
id|DelayValue
)paren
suffix:semicolon
r_return
id|val
suffix:semicolon
)brace
r_static
r_void
DECL|function|bmac_clock_in_bit
id|bmac_clock_in_bit
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_int
r_int
id|val
)paren
(brace
r_int
r_int
id|data
suffix:semicolon
r_if
c_cond
(paren
id|val
op_ne
l_int|0
op_logical_and
id|val
op_ne
l_int|1
)paren
r_return
suffix:semicolon
id|data
op_assign
(paren
id|val
op_lshift
id|SDIShiftCount
)paren
suffix:semicolon
id|bmwrite
c_func
(paren
id|dev
comma
id|SROMCSR
comma
id|data
op_or
id|ChipSelect
)paren
suffix:semicolon
id|udelay
c_func
(paren
id|DelayValue
)paren
suffix:semicolon
id|bmwrite
c_func
(paren
id|dev
comma
id|SROMCSR
comma
id|data
op_or
id|ChipSelect
op_or
id|Clk
)paren
suffix:semicolon
id|udelay
c_func
(paren
id|DelayValue
)paren
suffix:semicolon
id|bmwrite
c_func
(paren
id|dev
comma
id|SROMCSR
comma
id|data
op_or
id|ChipSelect
)paren
suffix:semicolon
id|udelay
c_func
(paren
id|DelayValue
)paren
suffix:semicolon
)brace
r_static
r_void
DECL|function|reset_and_select_srom
id|reset_and_select_srom
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
multiline_comment|/* first reset */
id|bmwrite
c_func
(paren
id|dev
comma
id|SROMCSR
comma
l_int|0
)paren
suffix:semicolon
id|udelay
c_func
(paren
id|DelayValue
)paren
suffix:semicolon
multiline_comment|/* send it the read command (110) */
id|bmac_clock_in_bit
c_func
(paren
id|dev
comma
l_int|1
)paren
suffix:semicolon
id|bmac_clock_in_bit
c_func
(paren
id|dev
comma
l_int|1
)paren
suffix:semicolon
id|bmac_clock_in_bit
c_func
(paren
id|dev
comma
l_int|0
)paren
suffix:semicolon
)brace
r_static
r_int
r_int
DECL|function|read_srom
id|read_srom
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_int
r_int
id|addr
comma
r_int
r_int
id|addr_len
)paren
(brace
r_int
r_int
id|data
comma
id|val
suffix:semicolon
r_int
id|i
suffix:semicolon
multiline_comment|/* send out the address we want to read from */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|addr_len
suffix:semicolon
id|i
op_increment
)paren
(brace
id|val
op_assign
id|addr
op_rshift
(paren
id|addr_len
op_minus
id|i
op_minus
l_int|1
)paren
suffix:semicolon
id|bmac_clock_in_bit
c_func
(paren
id|dev
comma
id|val
op_amp
l_int|1
)paren
suffix:semicolon
)brace
multiline_comment|/* Now read in the 16-bit data */
id|data
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|16
suffix:semicolon
id|i
op_increment
)paren
(brace
id|val
op_assign
id|bmac_clock_out_bit
c_func
(paren
id|dev
)paren
suffix:semicolon
id|data
op_lshift_assign
l_int|1
suffix:semicolon
id|data
op_or_assign
id|val
suffix:semicolon
)brace
id|bmwrite
c_func
(paren
id|dev
comma
id|SROMCSR
comma
l_int|0
)paren
suffix:semicolon
r_return
id|data
suffix:semicolon
)brace
multiline_comment|/*&n; * It looks like Cogent and SMC use different methods for calculating&n; * checksums. What a pain..&n; */
r_static
r_int
DECL|function|bmac_verify_checksum
id|bmac_verify_checksum
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_int
r_int
id|data
comma
id|storedCS
suffix:semicolon
id|reset_and_select_srom
c_func
(paren
id|dev
)paren
suffix:semicolon
id|data
op_assign
id|read_srom
c_func
(paren
id|dev
comma
l_int|3
comma
id|SROMAddressBits
)paren
suffix:semicolon
id|storedCS
op_assign
(paren
(paren
id|data
op_rshift
l_int|8
)paren
op_amp
l_int|0x0ff
)paren
op_or
(paren
(paren
id|data
op_lshift
l_int|8
)paren
op_amp
l_int|0xff00
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_void
DECL|function|bmac_get_station_address
id|bmac_get_station_address
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_int
r_char
op_star
id|ea
)paren
(brace
r_int
id|i
suffix:semicolon
r_int
r_int
id|data
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|6
suffix:semicolon
id|i
op_increment
)paren
(brace
id|reset_and_select_srom
c_func
(paren
id|dev
)paren
suffix:semicolon
id|data
op_assign
id|read_srom
c_func
(paren
id|dev
comma
id|i
op_plus
id|EnetAddressOffset
op_div
l_int|2
comma
id|SROMAddressBits
)paren
suffix:semicolon
id|ea
(braket
l_int|2
op_star
id|i
)braket
op_assign
id|bitrev
c_func
(paren
id|data
op_amp
l_int|0x0ff
)paren
suffix:semicolon
id|ea
(braket
l_int|2
op_star
id|i
op_plus
l_int|1
)braket
op_assign
id|bitrev
c_func
(paren
(paren
id|data
op_rshift
l_int|8
)paren
op_amp
l_int|0x0ff
)paren
suffix:semicolon
)brace
)brace
DECL|function|bmac_reset_and_enable
r_static
r_int
id|bmac_reset_and_enable
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_int
id|enable
)paren
(brace
r_struct
id|bmac_data
op_star
id|bp
op_assign
id|dev-&gt;priv
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
r_int
r_char
op_star
id|data
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|bp-&gt;reset_and_enabled
op_assign
l_int|0
suffix:semicolon
id|bmac_reset_chip
c_func
(paren
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|enable
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|bmac_init_tx_ring
c_func
(paren
id|bp
)paren
op_logical_or
op_logical_neg
id|bmac_init_rx_ring
c_func
(paren
id|bp
)paren
)paren
r_return
l_int|0
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|bmac_init_chip
c_func
(paren
id|dev
)paren
)paren
r_return
l_int|0
suffix:semicolon
id|bmac_start_chip
c_func
(paren
id|dev
)paren
suffix:semicolon
id|bmwrite
c_func
(paren
id|dev
comma
id|INTDISABLE
comma
id|EnableNormal
)paren
suffix:semicolon
id|bp-&gt;reset_and_enabled
op_assign
l_int|1
suffix:semicolon
multiline_comment|/*&n;&t;&t; * It seems that the bmac can&squot;t receive until it&squot;s transmitted&n;&t;&t; * a packet.  So we give it a dummy packet to transmit.&n;&t;&t; */
id|skb
op_assign
id|dev_alloc_skb
c_func
(paren
id|ETHERMINPACKET
)paren
suffix:semicolon
id|data
op_assign
id|skb_put
c_func
(paren
id|skb
comma
id|ETHERMINPACKET
)paren
suffix:semicolon
id|memset
c_func
(paren
id|data
comma
l_int|0
comma
id|ETHERMINPACKET
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|data
comma
id|dev-&gt;dev_addr
comma
l_int|6
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|data
op_plus
l_int|6
comma
id|dev-&gt;dev_addr
comma
l_int|6
)paren
suffix:semicolon
id|bmac_transmit_packet
c_func
(paren
id|skb
comma
id|dev
)paren
suffix:semicolon
)brace
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
DECL|function|bmac_probe
r_static
r_int
id|__init
id|bmac_probe
c_func
(paren
r_void
)paren
(brace
r_struct
id|device_node
op_star
id|bmac
suffix:semicolon
r_for
c_loop
(paren
id|bmac
op_assign
id|find_devices
c_func
(paren
l_string|&quot;bmac&quot;
)paren
suffix:semicolon
id|bmac
op_ne
l_int|0
suffix:semicolon
id|bmac
op_assign
id|bmac-&gt;next
)paren
id|bmac_probe1
c_func
(paren
id|bmac
comma
l_int|0
)paren
suffix:semicolon
r_for
c_loop
(paren
id|bmac
op_assign
id|find_compatible_devices
c_func
(paren
l_string|&quot;network&quot;
comma
l_string|&quot;bmac+&quot;
)paren
suffix:semicolon
id|bmac
op_ne
l_int|0
suffix:semicolon
id|bmac
op_assign
id|bmac-&gt;next
)paren
id|bmac_probe1
c_func
(paren
id|bmac
comma
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|bmac_devs
op_ne
l_int|0
)paren
(brace
id|proc_net_create
(paren
l_string|&quot;bmac&quot;
comma
l_int|0
comma
id|bmac_proc_info
)paren
suffix:semicolon
macro_line|#ifdef CONFIG_PMAC_PBOOK
id|pmu_register_sleep_notifier
c_func
(paren
op_amp
id|bmac_sleep_notifier
)paren
suffix:semicolon
macro_line|#endif
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|bmac_probe1
r_static
r_void
id|__init
id|bmac_probe1
c_func
(paren
r_struct
id|device_node
op_star
id|bmac
comma
r_int
id|is_bmac_plus
)paren
(brace
r_int
id|j
comma
id|rev
comma
id|ret
suffix:semicolon
r_struct
id|bmac_data
op_star
id|bp
suffix:semicolon
r_int
r_char
op_star
id|addr
suffix:semicolon
r_struct
id|net_device
op_star
id|dev
suffix:semicolon
r_if
c_cond
(paren
id|bmac-&gt;n_addrs
op_ne
l_int|3
op_logical_or
id|bmac-&gt;n_intrs
op_ne
l_int|3
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;can&squot;t use BMAC %s: need 3 addrs and 3 intrs&bslash;n&quot;
comma
id|bmac-&gt;full_name
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|addr
op_assign
id|get_property
c_func
(paren
id|bmac
comma
l_string|&quot;mac-address&quot;
comma
l_int|NULL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|addr
op_eq
l_int|NULL
)paren
(brace
id|addr
op_assign
id|get_property
c_func
(paren
id|bmac
comma
l_string|&quot;local-mac-address&quot;
comma
l_int|NULL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|addr
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;Can&squot;t get mac-address for BMAC %s&bslash;n&quot;
comma
id|bmac-&gt;full_name
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
)brace
id|dev
op_assign
id|init_etherdev
c_func
(paren
l_int|NULL
comma
id|PRIV_BYTES
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dev
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;init_etherdev failed, out of memory for BMAC %s&bslash;n&quot;
comma
id|bmac-&gt;full_name
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|SET_MODULE_OWNER
c_func
(paren
id|dev
)paren
suffix:semicolon
id|dev-&gt;base_addr
op_assign
(paren
r_int
r_int
)paren
id|ioremap
c_func
(paren
id|bmac-&gt;addrs
(braket
l_int|0
)braket
dot
id|address
comma
id|bmac-&gt;addrs
(braket
l_int|0
)braket
dot
id|size
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dev-&gt;base_addr
)paren
r_goto
id|err_out
suffix:semicolon
id|dev-&gt;irq
op_assign
id|bmac-&gt;intrs
(braket
l_int|0
)braket
dot
id|line
suffix:semicolon
id|bmwrite
c_func
(paren
id|dev
comma
id|INTDISABLE
comma
id|DisableAll
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: BMAC%s at&quot;
comma
id|dev-&gt;name
comma
(paren
id|is_bmac_plus
ques
c_cond
l_string|&quot;+&quot;
suffix:colon
l_string|&quot;&quot;
)paren
)paren
suffix:semicolon
id|rev
op_assign
id|addr
(braket
l_int|0
)braket
op_eq
l_int|0
op_logical_and
id|addr
(braket
l_int|1
)braket
op_eq
l_int|0xA0
suffix:semicolon
r_for
c_loop
(paren
id|j
op_assign
l_int|0
suffix:semicolon
id|j
OL
l_int|6
suffix:semicolon
op_increment
id|j
)paren
(brace
id|dev-&gt;dev_addr
(braket
id|j
)braket
op_assign
id|rev
ques
c_cond
id|bitrev
c_func
(paren
id|addr
(braket
id|j
)braket
)paren
suffix:colon
id|addr
(braket
id|j
)braket
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;%c%.2x&quot;
comma
(paren
id|j
ques
c_cond
l_char|&squot;:&squot;
suffix:colon
l_char|&squot; &squot;
)paren
comma
id|dev-&gt;dev_addr
(braket
id|j
)braket
)paren
suffix:semicolon
)brace
id|XXDEBUG
c_func
(paren
(paren
l_string|&quot;, base_addr=%#0lx&quot;
comma
id|dev-&gt;base_addr
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
id|dev-&gt;open
op_assign
id|bmac_open
suffix:semicolon
id|dev-&gt;stop
op_assign
id|bmac_close
suffix:semicolon
id|dev-&gt;hard_start_xmit
op_assign
id|bmac_output
suffix:semicolon
id|dev-&gt;get_stats
op_assign
id|bmac_stats
suffix:semicolon
id|dev-&gt;set_multicast_list
op_assign
id|bmac_set_multicast
suffix:semicolon
id|dev-&gt;set_mac_address
op_assign
id|bmac_set_address
suffix:semicolon
id|bmac_get_station_address
c_func
(paren
id|dev
comma
id|addr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|bmac_verify_checksum
c_func
(paren
id|dev
)paren
op_ne
l_int|0
)paren
r_goto
id|err_out_iounmap
suffix:semicolon
id|bp
op_assign
(paren
r_struct
id|bmac_data
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|bp-&gt;is_bmac_plus
op_assign
id|is_bmac_plus
suffix:semicolon
id|bp-&gt;tx_dma
op_assign
(paren
r_volatile
r_struct
id|dbdma_regs
op_star
)paren
id|ioremap
c_func
(paren
id|bmac-&gt;addrs
(braket
l_int|1
)braket
dot
id|address
comma
id|bmac-&gt;addrs
(braket
l_int|1
)braket
dot
id|size
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|bp-&gt;tx_dma
)paren
r_goto
id|err_out_iounmap
suffix:semicolon
id|bp-&gt;tx_dma_intr
op_assign
id|bmac-&gt;intrs
(braket
l_int|1
)braket
dot
id|line
suffix:semicolon
id|bp-&gt;rx_dma
op_assign
(paren
r_volatile
r_struct
id|dbdma_regs
op_star
)paren
id|ioremap
c_func
(paren
id|bmac-&gt;addrs
(braket
l_int|2
)braket
dot
id|address
comma
id|bmac-&gt;addrs
(braket
l_int|2
)braket
dot
id|size
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|bp-&gt;rx_dma
)paren
r_goto
id|err_out_iounmap_tx
suffix:semicolon
id|bp-&gt;rx_dma_intr
op_assign
id|bmac-&gt;intrs
(braket
l_int|2
)braket
dot
id|line
suffix:semicolon
id|bp-&gt;tx_cmds
op_assign
(paren
r_volatile
r_struct
id|dbdma_cmd
op_star
)paren
id|DBDMA_ALIGN
c_func
(paren
id|bp
op_plus
l_int|1
)paren
suffix:semicolon
id|bp-&gt;rx_cmds
op_assign
id|bp-&gt;tx_cmds
op_plus
id|N_TX_RING
op_plus
l_int|1
suffix:semicolon
id|bp-&gt;queue
op_assign
(paren
r_struct
id|sk_buff_head
op_star
)paren
(paren
id|bp-&gt;rx_cmds
op_plus
id|N_RX_RING
op_plus
l_int|1
)paren
suffix:semicolon
id|skb_queue_head_init
c_func
(paren
id|bp-&gt;queue
)paren
suffix:semicolon
id|bp-&gt;node
op_assign
id|bmac
suffix:semicolon
id|memset
c_func
(paren
(paren
r_char
op_star
)paren
id|bp-&gt;tx_cmds
comma
l_int|0
comma
(paren
id|N_TX_RING
op_plus
id|N_RX_RING
op_plus
l_int|2
)paren
op_star
r_sizeof
(paren
r_struct
id|dbdma_cmd
)paren
)paren
suffix:semicolon
multiline_comment|/*     init_timer(&amp;bp-&gt;tx_timeout); */
multiline_comment|/*     bp-&gt;timeout_active = 0; */
id|ret
op_assign
id|request_irq
c_func
(paren
id|dev-&gt;irq
comma
id|bmac_misc_intr
comma
l_int|0
comma
l_string|&quot;BMAC-misc&quot;
comma
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;BMAC: can&squot;t get irq %d&bslash;n&quot;
comma
id|dev-&gt;irq
)paren
suffix:semicolon
r_goto
id|err_out_iounmap_rx
suffix:semicolon
)brace
id|ret
op_assign
id|request_irq
c_func
(paren
id|bmac-&gt;intrs
(braket
l_int|1
)braket
dot
id|line
comma
id|bmac_txdma_intr
comma
l_int|0
comma
l_string|&quot;BMAC-txdma&quot;
comma
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;BMAC: can&squot;t get irq %d&bslash;n&quot;
comma
id|bmac-&gt;intrs
(braket
l_int|1
)braket
dot
id|line
)paren
suffix:semicolon
r_goto
id|err_out_irq0
suffix:semicolon
)brace
id|ret
op_assign
id|request_irq
c_func
(paren
id|bmac-&gt;intrs
(braket
l_int|2
)braket
dot
id|line
comma
id|bmac_rxdma_intr
comma
l_int|0
comma
l_string|&quot;BMAC-rxdma&quot;
comma
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;BMAC: can&squot;t get irq %d&bslash;n&quot;
comma
id|bmac-&gt;intrs
(braket
l_int|2
)braket
dot
id|line
)paren
suffix:semicolon
r_goto
id|err_out_irq1
suffix:semicolon
)brace
id|bp-&gt;next_bmac
op_assign
id|bmac_devs
suffix:semicolon
id|bmac_devs
op_assign
id|dev
suffix:semicolon
r_return
suffix:semicolon
id|err_out_irq1
suffix:colon
id|free_irq
c_func
(paren
id|bmac-&gt;intrs
(braket
l_int|1
)braket
dot
id|line
comma
id|dev
)paren
suffix:semicolon
id|err_out_irq0
suffix:colon
id|free_irq
c_func
(paren
id|dev-&gt;irq
comma
id|dev
)paren
suffix:semicolon
id|err_out_iounmap_rx
suffix:colon
id|iounmap
c_func
(paren
(paren
r_void
op_star
)paren
id|bp-&gt;rx_dma
)paren
suffix:semicolon
id|err_out_iounmap_tx
suffix:colon
id|iounmap
c_func
(paren
(paren
r_void
op_star
)paren
id|bp-&gt;tx_dma
)paren
suffix:semicolon
id|err_out_iounmap
suffix:colon
id|iounmap
c_func
(paren
(paren
r_void
op_star
)paren
id|dev-&gt;base_addr
)paren
suffix:semicolon
id|err_out
suffix:colon
id|unregister_netdev
c_func
(paren
id|dev
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
DECL|function|bmac_open
r_static
r_int
id|bmac_open
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
multiline_comment|/* XXDEBUG((&quot;bmac: enter open&bslash;n&quot;)); */
multiline_comment|/* reset the chip */
r_if
c_cond
(paren
op_logical_neg
id|bmac_reset_and_enable
c_func
(paren
id|dev
comma
l_int|1
)paren
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|dev-&gt;flags
op_or_assign
id|IFF_RUNNING
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|bmac_close
r_static
r_int
id|bmac_close
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|bmac_data
op_star
id|bp
op_assign
(paren
r_struct
id|bmac_data
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_volatile
r_struct
id|dbdma_regs
op_star
id|rd
op_assign
id|bp-&gt;rx_dma
suffix:semicolon
r_volatile
r_struct
id|dbdma_regs
op_star
id|td
op_assign
id|bp-&gt;tx_dma
suffix:semicolon
r_int
r_int
id|config
suffix:semicolon
r_int
id|i
suffix:semicolon
id|dev-&gt;flags
op_and_assign
op_complement
(paren
id|IFF_UP
op_or
id|IFF_RUNNING
)paren
suffix:semicolon
multiline_comment|/* disable rx and tx */
id|config
op_assign
id|bmread
c_func
(paren
id|dev
comma
id|RXCFG
)paren
suffix:semicolon
id|bmwrite
c_func
(paren
id|dev
comma
id|RXCFG
comma
(paren
id|config
op_amp
op_complement
id|RxMACEnable
)paren
)paren
suffix:semicolon
id|config
op_assign
id|bmread
c_func
(paren
id|dev
comma
id|TXCFG
)paren
suffix:semicolon
id|bmwrite
c_func
(paren
id|dev
comma
id|TXCFG
comma
(paren
id|config
op_amp
op_complement
id|TxMACEnable
)paren
)paren
suffix:semicolon
id|bmwrite
c_func
(paren
id|dev
comma
id|INTDISABLE
comma
id|DisableAll
)paren
suffix:semicolon
multiline_comment|/* disable all intrs */
multiline_comment|/* disable rx and tx dma */
id|st_le32
c_func
(paren
op_amp
id|rd-&gt;control
comma
id|DBDMA_CLEAR
c_func
(paren
id|RUN
op_or
id|PAUSE
op_or
id|FLUSH
op_or
id|WAKE
)paren
)paren
suffix:semicolon
multiline_comment|/* clear run bit */
id|st_le32
c_func
(paren
op_amp
id|td-&gt;control
comma
id|DBDMA_CLEAR
c_func
(paren
id|RUN
op_or
id|PAUSE
op_or
id|FLUSH
op_or
id|WAKE
)paren
)paren
suffix:semicolon
multiline_comment|/* clear run bit */
multiline_comment|/* free some skb&squot;s */
id|XXDEBUG
c_func
(paren
(paren
l_string|&quot;bmac: free rx bufs&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|N_RX_RING
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|bp-&gt;rx_bufs
(braket
id|i
)braket
op_ne
l_int|NULL
)paren
(brace
id|dev_kfree_skb
c_func
(paren
id|bp-&gt;rx_bufs
(braket
id|i
)braket
)paren
suffix:semicolon
id|bp-&gt;rx_bufs
(braket
id|i
)braket
op_assign
l_int|NULL
suffix:semicolon
)brace
)brace
id|bp-&gt;rx_allocated
op_assign
l_int|0
suffix:semicolon
id|XXDEBUG
c_func
(paren
(paren
l_string|&quot;bmac: free tx bufs&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|N_TX_RING
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|bp-&gt;tx_bufs
(braket
id|i
)braket
op_ne
l_int|NULL
)paren
(brace
id|dev_kfree_skb
c_func
(paren
id|bp-&gt;tx_bufs
(braket
id|i
)braket
)paren
suffix:semicolon
id|bp-&gt;tx_bufs
(braket
id|i
)braket
op_assign
l_int|NULL
suffix:semicolon
)brace
)brace
id|bp-&gt;reset_and_enabled
op_assign
l_int|0
suffix:semicolon
id|XXDEBUG
c_func
(paren
(paren
l_string|&quot;bmac: all bufs freed&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_void
DECL|function|bmac_start
id|bmac_start
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|bmac_data
op_star
id|bp
op_assign
id|dev-&gt;priv
suffix:semicolon
r_int
id|i
suffix:semicolon
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
r_while
c_loop
(paren
l_int|1
)paren
(brace
id|i
op_assign
id|bp-&gt;tx_fill
op_plus
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|i
op_ge
id|N_TX_RING
)paren
id|i
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|i
op_eq
id|bp-&gt;tx_empty
)paren
r_break
suffix:semicolon
id|skb
op_assign
id|skb_dequeue
c_func
(paren
id|bp-&gt;queue
)paren
suffix:semicolon
r_if
c_cond
(paren
id|skb
op_eq
l_int|NULL
)paren
r_break
suffix:semicolon
id|bmac_transmit_packet
c_func
(paren
id|skb
comma
id|dev
)paren
suffix:semicolon
)brace
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
r_static
r_int
DECL|function|bmac_output
id|bmac_output
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|bmac_data
op_star
id|bp
op_assign
id|dev-&gt;priv
suffix:semicolon
id|skb_queue_tail
c_func
(paren
id|bp-&gt;queue
comma
id|skb
)paren
suffix:semicolon
id|bmac_start
c_func
(paren
id|dev
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|bmac_tx_timeout
r_static
r_void
id|bmac_tx_timeout
c_func
(paren
r_int
r_int
id|data
)paren
(brace
r_struct
id|net_device
op_star
id|dev
op_assign
(paren
r_struct
id|net_device
op_star
)paren
id|data
suffix:semicolon
r_struct
id|bmac_data
op_star
id|bp
op_assign
(paren
r_struct
id|bmac_data
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_volatile
r_struct
id|dbdma_regs
op_star
id|td
op_assign
id|bp-&gt;tx_dma
suffix:semicolon
r_volatile
r_struct
id|dbdma_regs
op_star
id|rd
op_assign
id|bp-&gt;rx_dma
suffix:semicolon
r_volatile
r_struct
id|dbdma_cmd
op_star
id|cp
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_int
r_int
id|config
comma
id|oldConfig
suffix:semicolon
r_int
id|i
suffix:semicolon
id|XXDEBUG
c_func
(paren
(paren
l_string|&quot;bmac: tx_timeout called&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|bp-&gt;timeout_active
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* update various counters */
multiline_comment|/*     &t;bmac_handle_misc_intrs(bp, 0); */
id|cp
op_assign
op_amp
id|bp-&gt;tx_cmds
(braket
id|bp-&gt;tx_empty
)braket
suffix:semicolon
multiline_comment|/*&t;XXDEBUG((KERN_DEBUG &quot;bmac: tx dmastat=%x %x runt=%d pr=%x fs=%x fc=%x&bslash;n&quot;, */
multiline_comment|/* &t;   ld_le32(&amp;td-&gt;status), ld_le16(&amp;cp-&gt;xfer_status), bp-&gt;tx_bad_runt, */
multiline_comment|/* &t;   mb-&gt;pr, mb-&gt;xmtfs, mb-&gt;fifofc)); */
multiline_comment|/* turn off both tx and rx and reset the chip */
id|config
op_assign
id|bmread
c_func
(paren
id|dev
comma
id|RXCFG
)paren
suffix:semicolon
id|bmwrite
c_func
(paren
id|dev
comma
id|RXCFG
comma
(paren
id|config
op_amp
op_complement
id|RxMACEnable
)paren
)paren
suffix:semicolon
id|config
op_assign
id|bmread
c_func
(paren
id|dev
comma
id|TXCFG
)paren
suffix:semicolon
id|bmwrite
c_func
(paren
id|dev
comma
id|TXCFG
comma
(paren
id|config
op_amp
op_complement
id|TxMACEnable
)paren
)paren
suffix:semicolon
id|out_le32
c_func
(paren
op_amp
id|td-&gt;control
comma
id|DBDMA_CLEAR
c_func
(paren
id|RUN
op_or
id|PAUSE
op_or
id|FLUSH
op_or
id|WAKE
op_or
id|ACTIVE
op_or
id|DEAD
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;bmac: transmit timeout - resetting&bslash;n&quot;
)paren
suffix:semicolon
id|bmac_reset_chip
c_func
(paren
id|dev
)paren
suffix:semicolon
multiline_comment|/* restart rx dma */
id|cp
op_assign
id|bus_to_virt
c_func
(paren
id|ld_le32
c_func
(paren
op_amp
id|rd-&gt;cmdptr
)paren
)paren
suffix:semicolon
id|out_le32
c_func
(paren
op_amp
id|rd-&gt;control
comma
id|DBDMA_CLEAR
c_func
(paren
id|RUN
op_or
id|PAUSE
op_or
id|FLUSH
op_or
id|WAKE
op_or
id|ACTIVE
op_or
id|DEAD
)paren
)paren
suffix:semicolon
id|out_le16
c_func
(paren
op_amp
id|cp-&gt;xfer_status
comma
l_int|0
)paren
suffix:semicolon
id|out_le32
c_func
(paren
op_amp
id|rd-&gt;cmdptr
comma
id|virt_to_bus
c_func
(paren
id|cp
)paren
)paren
suffix:semicolon
id|out_le32
c_func
(paren
op_amp
id|rd-&gt;control
comma
id|DBDMA_SET
c_func
(paren
id|RUN
op_or
id|WAKE
)paren
)paren
suffix:semicolon
multiline_comment|/* fix up the transmit side */
id|XXDEBUG
c_func
(paren
(paren
id|KERN_DEBUG
l_string|&quot;bmac: tx empty=%d fill=%d fullup=%d&bslash;n&quot;
comma
id|bp-&gt;tx_empty
comma
id|bp-&gt;tx_fill
comma
id|bp-&gt;tx_fullup
)paren
)paren
suffix:semicolon
id|i
op_assign
id|bp-&gt;tx_empty
suffix:semicolon
op_increment
id|bp-&gt;stats.tx_errors
suffix:semicolon
r_if
c_cond
(paren
id|i
op_ne
id|bp-&gt;tx_fill
)paren
(brace
id|dev_kfree_skb
c_func
(paren
id|bp-&gt;tx_bufs
(braket
id|i
)braket
)paren
suffix:semicolon
id|bp-&gt;tx_bufs
(braket
id|i
)braket
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
op_increment
id|i
op_ge
id|N_TX_RING
)paren
id|i
op_assign
l_int|0
suffix:semicolon
id|bp-&gt;tx_empty
op_assign
id|i
suffix:semicolon
)brace
id|bp-&gt;tx_fullup
op_assign
l_int|0
suffix:semicolon
id|netif_wake_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
op_ne
id|bp-&gt;tx_fill
)paren
(brace
id|cp
op_assign
op_amp
id|bp-&gt;tx_cmds
(braket
id|i
)braket
suffix:semicolon
id|out_le16
c_func
(paren
op_amp
id|cp-&gt;xfer_status
comma
l_int|0
)paren
suffix:semicolon
id|out_le16
c_func
(paren
op_amp
id|cp-&gt;command
comma
id|OUTPUT_LAST
)paren
suffix:semicolon
id|out_le32
c_func
(paren
op_amp
id|td-&gt;cmdptr
comma
id|virt_to_bus
c_func
(paren
id|cp
)paren
)paren
suffix:semicolon
id|out_le32
c_func
(paren
op_amp
id|td-&gt;control
comma
id|DBDMA_SET
c_func
(paren
id|RUN
)paren
)paren
suffix:semicolon
multiline_comment|/* &t;bmac_set_timeout(dev); */
id|XXDEBUG
c_func
(paren
(paren
id|KERN_DEBUG
l_string|&quot;bmac: starting %d&bslash;n&quot;
comma
id|i
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/* turn it back on */
id|oldConfig
op_assign
id|bmread
c_func
(paren
id|dev
comma
id|RXCFG
)paren
suffix:semicolon
id|bmwrite
c_func
(paren
id|dev
comma
id|RXCFG
comma
id|oldConfig
op_or
id|RxMACEnable
)paren
suffix:semicolon
id|oldConfig
op_assign
id|bmread
c_func
(paren
id|dev
comma
id|TXCFG
)paren
suffix:semicolon
id|bmwrite
c_func
(paren
id|dev
comma
id|TXCFG
comma
id|oldConfig
op_or
id|TxMACEnable
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
macro_line|#if 0
r_static
r_void
id|dump_dbdma
c_func
(paren
r_volatile
r_struct
id|dbdma_cmd
op_star
id|cp
comma
r_int
id|count
)paren
(brace
r_int
id|i
comma
op_star
id|ip
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|count
suffix:semicolon
id|i
op_increment
)paren
(brace
id|ip
op_assign
(paren
r_int
op_star
)paren
(paren
id|cp
op_plus
id|i
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;dbdma req 0x%x addr 0x%x baddr 0x%x xfer/res 0x%x&bslash;n&quot;
comma
id|ld_le32
c_func
(paren
id|ip
op_plus
l_int|0
)paren
comma
id|ld_le32
c_func
(paren
id|ip
op_plus
l_int|1
)paren
comma
id|ld_le32
c_func
(paren
id|ip
op_plus
l_int|2
)paren
comma
id|ld_le32
c_func
(paren
id|ip
op_plus
l_int|3
)paren
)paren
suffix:semicolon
)brace
)brace
macro_line|#endif
r_static
r_int
DECL|function|bmac_proc_info
id|bmac_proc_info
c_func
(paren
r_char
op_star
id|buffer
comma
r_char
op_star
op_star
id|start
comma
id|off_t
id|offset
comma
r_int
id|length
)paren
(brace
r_int
id|len
op_assign
l_int|0
suffix:semicolon
id|off_t
id|pos
op_assign
l_int|0
suffix:semicolon
id|off_t
id|begin
op_assign
l_int|0
suffix:semicolon
r_int
id|i
suffix:semicolon
r_if
c_cond
(paren
id|bmac_devs
op_eq
l_int|NULL
)paren
r_return
(paren
op_minus
id|ENOSYS
)paren
suffix:semicolon
id|len
op_add_assign
id|sprintf
c_func
(paren
id|buffer
comma
l_string|&quot;BMAC counters &amp; registers&bslash;n&quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|N_REG_ENTRIES
suffix:semicolon
id|i
op_increment
)paren
(brace
id|len
op_add_assign
id|sprintf
c_func
(paren
id|buffer
op_plus
id|len
comma
l_string|&quot;%s: %#08x&bslash;n&quot;
comma
id|reg_entries
(braket
id|i
)braket
dot
id|name
comma
id|bmread
c_func
(paren
id|bmac_devs
comma
id|reg_entries
(braket
id|i
)braket
dot
id|reg_offset
)paren
)paren
suffix:semicolon
id|pos
op_assign
id|begin
op_plus
id|len
suffix:semicolon
r_if
c_cond
(paren
id|pos
OL
id|offset
)paren
(brace
id|len
op_assign
l_int|0
suffix:semicolon
id|begin
op_assign
id|pos
suffix:semicolon
)brace
r_if
c_cond
(paren
id|pos
OG
id|offset
op_plus
id|length
)paren
r_break
suffix:semicolon
)brace
op_star
id|start
op_assign
id|buffer
op_plus
(paren
id|offset
op_minus
id|begin
)paren
suffix:semicolon
id|len
op_sub_assign
(paren
id|offset
op_minus
id|begin
)paren
suffix:semicolon
r_if
c_cond
(paren
id|len
OG
id|length
)paren
id|len
op_assign
id|length
suffix:semicolon
r_return
id|len
suffix:semicolon
)brace
id|MODULE_AUTHOR
c_func
(paren
l_string|&quot;Randy Gobbel/Paul Mackerras&quot;
)paren
suffix:semicolon
id|MODULE_DESCRIPTION
c_func
(paren
l_string|&quot;PowerMac BMAC ethernet driver.&quot;
)paren
suffix:semicolon
DECL|function|bmac_cleanup
r_static
r_void
id|__exit
id|bmac_cleanup
(paren
r_void
)paren
(brace
r_struct
id|bmac_data
op_star
id|bp
suffix:semicolon
r_struct
id|net_device
op_star
id|dev
suffix:semicolon
r_if
c_cond
(paren
id|bmac_devs
op_eq
l_int|0
)paren
r_return
suffix:semicolon
macro_line|#ifdef CONFIG_PMAC_PBOOK
id|pmu_unregister_sleep_notifier
c_func
(paren
op_amp
id|bmac_sleep_notifier
)paren
suffix:semicolon
macro_line|#endif
id|proc_net_remove
c_func
(paren
l_string|&quot;bmac&quot;
)paren
suffix:semicolon
r_do
(brace
id|dev
op_assign
id|bmac_devs
suffix:semicolon
id|bp
op_assign
(paren
r_struct
id|bmac_data
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|bmac_devs
op_assign
id|bp-&gt;next_bmac
suffix:semicolon
id|free_irq
c_func
(paren
id|dev-&gt;irq
comma
id|dev
)paren
suffix:semicolon
id|free_irq
c_func
(paren
id|bp-&gt;tx_dma_intr
comma
id|dev
)paren
suffix:semicolon
id|free_irq
c_func
(paren
id|bp-&gt;rx_dma_intr
comma
id|dev
)paren
suffix:semicolon
id|unregister_netdev
c_func
(paren
id|dev
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
id|bmac_devs
op_ne
l_int|NULL
)paren
suffix:semicolon
)brace
DECL|variable|bmac_probe
id|module_init
c_func
(paren
id|bmac_probe
)paren
suffix:semicolon
DECL|variable|bmac_cleanup
id|module_exit
c_func
(paren
id|bmac_cleanup
)paren
suffix:semicolon
eof
