multiline_comment|/*****************************************************************************&n;* sdla_ppp.c&t;WANPIPE(tm) Multiprotocol WAN Link Driver. PPP module.&n;*&n;* Author:&t;Gene Kozin&t;&lt;genek@compuserve.com&gt;&n;*&n;* Copyright:&t;(c) 1995-1997 Sangoma Technologies Inc.&n;*&n;*&t;&t;This program is free software; you can redistribute it and/or&n;*&t;&t;modify it under the terms of the GNU General Public License&n;*&t;&t;as published by the Free Software Foundation; either version&n;*&t;&t;2 of the License, or (at your option) any later version.&n;* ============================================================================&n;* Jun 29, 1997  Alan Cox&t;o Dumped the idiot UDP management system.&n;*&n;* May 22, 1997&t;Jaspreet Singh&t;o Added change in the PPP_SET_CONFIG command for&n;*&t;&t;&t;&t;508 card to reflect changes in the new &n;*&t;&t;&t;&t;ppp508.sfm for supporting:continous transmission&n;*&t;&t;&t;&t;of Configure-Request packets without receiving a&n;*&t;&t;&t;&t;reply &t;&t;&t;&t;&n;*&t;&t;&t;&t;OR-ed 0x300 to conf_flags &n;*&t;&t;&t;        o Changed connect_tmout from 900 to 0&n;* May 21, 1997&t;Jaspreet Singh  o Fixed UDP Management for multiple boards&n;* Apr 25, 1997  Farhan Thawar    o added UDP Management stuff&n;* Mar 11, 1997  Farhan Thawar   Version 3.1.1&n;*                                o fixed (+1) bug in rx_intr()&n;*                                o changed if_send() to return 0 if&n;*                                  wandev.critical() is true&n;*                                o free socket buffer in if_send() if&n;*                                  returning 0 &n;* Jan 15, 1997&t;Gene Kozin&t;Version 3.1.0&n;*&t;&t;&t;&t; o implemented exec() entry point&n;* Jan 06, 1997&t;Gene Kozin&t;Initial version.&n;*****************************************************************************/
macro_line|#if&t;!defined(__KERNEL__) || !defined(MODULE)
macro_line|#error&t;This code MUST be compiled as a kernel module!
macro_line|#endif
macro_line|#include &lt;linux/kernel.h&gt;&t;/* printk(), and other useful stuff */
macro_line|#include &lt;linux/stddef.h&gt;&t;/* offsetof(), etc. */
macro_line|#include &lt;linux/errno.h&gt;&t;/* return codes */
macro_line|#include &lt;linux/string.h&gt;&t;/* inline memset(), etc. */
macro_line|#include &lt;linux/malloc.h&gt;&t;/* kmalloc(), kfree() */
macro_line|#include &lt;linux/wanrouter.h&gt;&t;/* WAN router definitions */
macro_line|#include &lt;linux/wanpipe.h&gt;&t;/* WANPIPE common user API definitions */
macro_line|#include &lt;linux/if_arp.h&gt;&t;/* ARPHRD_* defines */
macro_line|#include &lt;linux/init.h&gt;&t;&t;/* __initfunc et al. */
macro_line|#include &lt;asm/byteorder.h&gt;&t;/* htons(), etc. */
macro_line|#include &lt;asm/uaccess.h&gt;
DECL|macro|_GNUC_
mdefine_line|#define&t;_GNUC_
macro_line|#include &lt;linux/sdla_ppp.h&gt;&t;/* PPP firmware API definitions */
multiline_comment|/****** Defines &amp; Macros ****************************************************/
macro_line|#ifdef&t;_DEBUG_
DECL|macro|STATIC
mdefine_line|#define&t;STATIC
macro_line|#else
DECL|macro|STATIC
mdefine_line|#define&t;STATIC&t;&t;static
macro_line|#endif
DECL|macro|CMD_OK
mdefine_line|#define&t;CMD_OK&t;&t;0&t;/* normal firmware return code */
DECL|macro|CMD_TIMEOUT
mdefine_line|#define&t;CMD_TIMEOUT&t;0xFF&t;/* firmware command timed out */
DECL|macro|PPP_DFLT_MTU
mdefine_line|#define&t;PPP_DFLT_MTU&t;1500&t;/* default MTU */
DECL|macro|PPP_MAX_MTU
mdefine_line|#define&t;PPP_MAX_MTU&t;4000&t;/* maximum MTU */
DECL|macro|PPP_HDR_LEN
mdefine_line|#define PPP_HDR_LEN&t;1
DECL|macro|CONNECT_TIMEOUT
mdefine_line|#define&t;CONNECT_TIMEOUT&t;(90*HZ)&t;/* link connection timeout */
DECL|macro|HOLD_DOWN_TIME
mdefine_line|#define&t;HOLD_DOWN_TIME&t;(30*HZ)&t;/* link hold down time */
multiline_comment|/****** Function Prototypes *************************************************/
multiline_comment|/* WAN link driver entry points. These are called by the WAN router module. */
r_static
r_int
id|update
c_func
(paren
id|wan_device_t
op_star
id|wandev
)paren
suffix:semicolon
r_static
r_int
id|new_if
c_func
(paren
id|wan_device_t
op_star
id|wandev
comma
r_struct
id|device
op_star
id|dev
comma
id|wanif_conf_t
op_star
id|conf
)paren
suffix:semicolon
r_static
r_int
id|del_if
c_func
(paren
id|wan_device_t
op_star
id|wandev
comma
r_struct
id|device
op_star
id|dev
)paren
suffix:semicolon
multiline_comment|/* WANPIPE-specific entry points */
r_static
r_int
id|wpp_exec
c_func
(paren
r_struct
id|sdla
op_star
id|card
comma
r_void
op_star
id|u_cmd
comma
r_void
op_star
id|u_data
)paren
suffix:semicolon
multiline_comment|/* Network device interface */
r_static
r_int
id|if_init
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_int
id|if_open
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_int
id|if_close
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_int
id|if_header
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|device
op_star
id|dev
comma
r_int
r_int
id|type
comma
r_void
op_star
id|daddr
comma
r_void
op_star
id|saddr
comma
r_int
id|len
)paren
suffix:semicolon
r_static
r_int
id|if_rebuild_hdr
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
)paren
suffix:semicolon
r_static
r_int
id|if_send
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_struct
id|enet_statistics
op_star
id|if_stats
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
suffix:semicolon
multiline_comment|/* PPP firmware interface functions */
r_static
r_int
id|ppp_read_version
c_func
(paren
id|sdla_t
op_star
id|card
comma
r_char
op_star
id|str
)paren
suffix:semicolon
r_static
r_int
id|ppp_configure
c_func
(paren
id|sdla_t
op_star
id|card
comma
r_void
op_star
id|data
)paren
suffix:semicolon
r_static
r_int
id|ppp_set_intr_mode
c_func
(paren
id|sdla_t
op_star
id|card
comma
r_int
id|mode
)paren
suffix:semicolon
r_static
r_int
id|ppp_comm_enable
c_func
(paren
id|sdla_t
op_star
id|card
)paren
suffix:semicolon
r_static
r_int
id|ppp_comm_disable
c_func
(paren
id|sdla_t
op_star
id|card
)paren
suffix:semicolon
r_static
r_int
id|ppp_get_err_stats
c_func
(paren
id|sdla_t
op_star
id|card
)paren
suffix:semicolon
r_static
r_int
id|ppp_send
c_func
(paren
id|sdla_t
op_star
id|card
comma
r_void
op_star
id|data
comma
r_int
id|len
comma
r_int
id|proto
)paren
suffix:semicolon
r_static
r_int
id|ppp_error
c_func
(paren
id|sdla_t
op_star
id|card
comma
r_int
id|err
comma
id|ppp_mbox_t
op_star
id|mb
)paren
suffix:semicolon
multiline_comment|/* Interrupt handlers */
id|STATIC
r_void
id|wpp_isr
c_func
(paren
id|sdla_t
op_star
id|card
)paren
suffix:semicolon
r_static
r_void
id|rx_intr
c_func
(paren
id|sdla_t
op_star
id|card
)paren
suffix:semicolon
r_static
r_void
id|tx_intr
c_func
(paren
id|sdla_t
op_star
id|card
)paren
suffix:semicolon
multiline_comment|/* Background polling routines */
r_static
r_void
id|wpp_poll
c_func
(paren
id|sdla_t
op_star
id|card
)paren
suffix:semicolon
r_static
r_void
id|poll_active
c_func
(paren
id|sdla_t
op_star
id|card
)paren
suffix:semicolon
r_static
r_void
id|poll_connecting
c_func
(paren
id|sdla_t
op_star
id|card
)paren
suffix:semicolon
r_static
r_void
id|poll_disconnected
c_func
(paren
id|sdla_t
op_star
id|card
)paren
suffix:semicolon
multiline_comment|/* Miscellaneous functions */
r_static
r_int
id|config502
c_func
(paren
id|sdla_t
op_star
id|card
)paren
suffix:semicolon
r_static
r_int
id|config508
c_func
(paren
id|sdla_t
op_star
id|card
)paren
suffix:semicolon
r_static
r_void
id|show_disc_cause
c_func
(paren
id|sdla_t
op_star
id|card
comma
r_int
id|cause
)paren
suffix:semicolon
r_static
r_int
r_char
id|bps_to_speed_code
c_func
(paren
r_int
r_int
id|bps
)paren
suffix:semicolon
DECL|variable|TracingEnabled
r_static
r_char
id|TracingEnabled
suffix:semicolon
multiline_comment|/****** Public Functions ****************************************************/
multiline_comment|/*============================================================================&n; * PPP protocol initialization routine.&n; *&n; * This routine is called by the main WANPIPE module during setup.  At this&n; * point adapter is completely initialized and firmware is running.&n; *  o read firmware version (to make sure it&squot;s alive)&n; *  o configure adapter&n; *  o initialize protocol-specific fields of the adapter data space.&n; *&n; * Return:&t;0&t;o.k.&n; *&t;&t;&lt; 0&t;failure.&n; */
DECL|function|__initfunc
id|__initfunc
c_func
(paren
r_int
id|wpp_init
c_func
(paren
id|sdla_t
op_star
id|card
comma
id|wandev_conf_t
op_star
id|conf
)paren
)paren
(brace
r_union
(brace
r_char
id|str
(braket
l_int|80
)braket
suffix:semicolon
)brace
id|u
suffix:semicolon
multiline_comment|/* Verify configuration ID */
r_if
c_cond
(paren
id|conf-&gt;config_id
op_ne
id|WANCONFIG_PPP
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: invalid configuration ID %u!&bslash;n&quot;
comma
id|card-&gt;devname
comma
id|conf-&gt;config_id
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
multiline_comment|/* Initialize protocol-specific fields */
r_switch
c_cond
(paren
id|card-&gt;hw.fwid
)paren
(brace
r_case
id|SFID_PPP502
suffix:colon
id|card-&gt;mbox
op_assign
(paren
r_void
op_star
)paren
(paren
id|card-&gt;hw.dpmbase
op_plus
id|PPP502_MB_OFFS
)paren
suffix:semicolon
id|card-&gt;flags
op_assign
(paren
r_void
op_star
)paren
(paren
id|card-&gt;hw.dpmbase
op_plus
id|PPP502_FLG_OFFS
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SFID_PPP508
suffix:colon
id|card-&gt;mbox
op_assign
(paren
r_void
op_star
)paren
(paren
id|card-&gt;hw.dpmbase
op_plus
id|PPP508_MB_OFFS
)paren
suffix:semicolon
id|card-&gt;flags
op_assign
(paren
r_void
op_star
)paren
(paren
id|card-&gt;hw.dpmbase
op_plus
id|PPP508_FLG_OFFS
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
multiline_comment|/* Read firmware version.  Note that when adapter initializes, it&n;&t; * clears the mailbox, so it may appear that the first command was&n;&t; * executed successfully when in fact it was merely erased. To work&n;&t; * around this, we execute the first command twice.&n;&t; */
r_if
c_cond
(paren
id|ppp_read_version
c_func
(paren
id|card
comma
l_int|NULL
)paren
op_logical_or
id|ppp_read_version
c_func
(paren
id|card
comma
id|u.str
)paren
)paren
r_return
op_minus
id|EIO
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: running PPP firmware v%s&bslash;n&quot;
comma
id|card-&gt;devname
comma
id|u.str
)paren
suffix:semicolon
multiline_comment|/* Adjust configuration and set defaults */
id|card-&gt;wandev.mtu
op_assign
(paren
id|conf-&gt;mtu
)paren
ques
c_cond
id|min
c_func
(paren
id|conf-&gt;mtu
comma
id|PPP_MAX_MTU
)paren
suffix:colon
id|PPP_DFLT_MTU
suffix:semicolon
id|card-&gt;wandev.bps
op_assign
id|conf-&gt;bps
suffix:semicolon
id|card-&gt;wandev.interface
op_assign
id|conf-&gt;interface
suffix:semicolon
id|card-&gt;wandev.clocking
op_assign
id|conf-&gt;clocking
suffix:semicolon
id|card-&gt;wandev.station
op_assign
id|conf-&gt;station
suffix:semicolon
id|card-&gt;isr
op_assign
op_amp
id|wpp_isr
suffix:semicolon
id|card-&gt;poll
op_assign
op_amp
id|wpp_poll
suffix:semicolon
id|card-&gt;exec
op_assign
op_amp
id|wpp_exec
suffix:semicolon
id|card-&gt;wandev.update
op_assign
op_amp
id|update
suffix:semicolon
id|card-&gt;wandev.new_if
op_assign
op_amp
id|new_if
suffix:semicolon
id|card-&gt;wandev.del_if
op_assign
op_amp
id|del_if
suffix:semicolon
id|card-&gt;wandev.state
op_assign
id|WAN_DISCONNECTED
suffix:semicolon
id|card-&gt;wandev.udp_port
op_assign
id|conf-&gt;udp_port
suffix:semicolon
id|TracingEnabled
op_assign
l_char|&squot;0&squot;
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/******* WAN Device Driver Entry Points *************************************/
multiline_comment|/*============================================================================&n; * Update device status &amp; statistics.&n; */
DECL|function|update
r_static
r_int
id|update
c_func
(paren
id|wan_device_t
op_star
id|wandev
)paren
(brace
id|sdla_t
op_star
id|card
suffix:semicolon
multiline_comment|/* sanity checks */
r_if
c_cond
(paren
(paren
id|wandev
op_eq
l_int|NULL
)paren
op_logical_or
(paren
id|wandev
op_member_access_from_pointer
r_private
op_eq
l_int|NULL
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_if
c_cond
(paren
id|wandev-&gt;state
op_eq
id|WAN_UNCONFIGURED
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
r_if
c_cond
(paren
id|test_and_set_bit
c_func
(paren
l_int|0
comma
(paren
r_void
op_star
)paren
op_amp
id|wandev-&gt;critical
)paren
)paren
r_return
op_minus
id|EAGAIN
suffix:semicolon
id|card
op_assign
id|wandev
op_member_access_from_pointer
r_private
suffix:semicolon
id|ppp_get_err_stats
c_func
(paren
id|card
)paren
suffix:semicolon
id|wandev-&gt;critical
op_assign
l_int|0
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*============================================================================&n; * Create new logical channel.&n; * This routine is called by the router when ROUTER_IFNEW IOCTL is being&n; * handled.&n; * o parse media- and hardware-specific configuration&n; * o make sure that a new channel can be created&n; * o allocate resources, if necessary&n; * o prepare network device structure for registaration.&n; *&n; * Return:&t;0&t;o.k.&n; *&t;&t;&lt; 0&t;failure (channel will not be created)&n; */
DECL|function|new_if
r_static
r_int
id|new_if
c_func
(paren
id|wan_device_t
op_star
id|wandev
comma
r_struct
id|device
op_star
id|dev
comma
id|wanif_conf_t
op_star
id|conf
)paren
(brace
id|sdla_t
op_star
id|card
op_assign
id|wandev
op_member_access_from_pointer
r_private
suffix:semicolon
r_if
c_cond
(paren
id|wandev-&gt;ndev
)paren
r_return
op_minus
id|EEXIST
suffix:semicolon
r_if
c_cond
(paren
(paren
id|conf-&gt;name
(braket
l_int|0
)braket
op_eq
l_char|&squot;&bslash;0&squot;
)paren
op_logical_or
(paren
id|strlen
c_func
(paren
id|conf-&gt;name
)paren
OG
id|WAN_IFNAME_SZ
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: invalid interface name!&bslash;n&quot;
comma
id|card-&gt;devname
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
multiline_comment|/* initialize data */
id|strcpy
c_func
(paren
id|card-&gt;u.p.if_name
comma
id|conf-&gt;name
)paren
suffix:semicolon
multiline_comment|/* prepare network device data space for registration */
id|dev-&gt;name
op_assign
id|card-&gt;u.p.if_name
suffix:semicolon
id|dev-&gt;init
op_assign
op_amp
id|if_init
suffix:semicolon
id|dev-&gt;priv
op_assign
id|card
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*============================================================================&n; * Delete logical channel.&n; */
DECL|function|del_if
r_static
r_int
id|del_if
c_func
(paren
id|wan_device_t
op_star
id|wandev
comma
r_struct
id|device
op_star
id|dev
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/****** WANPIPE-specific entry points ***************************************/
multiline_comment|/*============================================================================&n; * Execute adapter interface command.&n; */
DECL|function|wpp_exec
r_static
r_int
id|wpp_exec
c_func
(paren
r_struct
id|sdla
op_star
id|card
comma
r_void
op_star
id|u_cmd
comma
r_void
op_star
id|u_data
)paren
(brace
id|ppp_mbox_t
op_star
id|mbox
op_assign
id|card-&gt;mbox
suffix:semicolon
r_int
id|len
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
(paren
r_void
op_star
)paren
op_amp
id|mbox-&gt;cmd
comma
id|u_cmd
comma
r_sizeof
(paren
id|ppp_cmd_t
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
id|len
op_assign
id|mbox-&gt;cmd.length
suffix:semicolon
r_if
c_cond
(paren
id|len
)paren
(brace
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
(paren
r_void
op_star
)paren
op_amp
id|mbox-&gt;data
comma
id|u_data
comma
id|len
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
multiline_comment|/* execute command */
r_if
c_cond
(paren
op_logical_neg
id|sdla_exec
c_func
(paren
id|mbox
)paren
)paren
r_return
op_minus
id|EIO
suffix:semicolon
multiline_comment|/* return result */
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
id|u_cmd
comma
(paren
r_void
op_star
)paren
op_amp
id|mbox-&gt;cmd
comma
r_sizeof
(paren
id|ppp_cmd_t
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
id|len
op_assign
id|mbox-&gt;cmd.length
suffix:semicolon
r_if
c_cond
(paren
id|len
op_logical_and
id|u_data
op_logical_and
id|copy_to_user
c_func
(paren
id|u_data
comma
(paren
r_void
op_star
)paren
op_amp
id|mbox-&gt;data
comma
id|len
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/****** Network Device Interface ********************************************/
multiline_comment|/*============================================================================&n; * Initialize Linux network interface.&n; *&n; * This routine is called only once for each interface, during Linux network&n; * interface registration.  Returning anything but zero will fail interface&n; * registration.&n; */
DECL|function|if_init
r_static
r_int
id|if_init
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
id|sdla_t
op_star
id|card
op_assign
id|dev-&gt;priv
suffix:semicolon
id|wan_device_t
op_star
id|wandev
op_assign
op_amp
id|card-&gt;wandev
suffix:semicolon
r_int
id|i
suffix:semicolon
multiline_comment|/* Initialize device driver entry points */
id|dev-&gt;open
op_assign
op_amp
id|if_open
suffix:semicolon
id|dev-&gt;stop
op_assign
op_amp
id|if_close
suffix:semicolon
id|dev-&gt;hard_header
op_assign
op_amp
id|if_header
suffix:semicolon
id|dev-&gt;rebuild_header
op_assign
op_amp
id|if_rebuild_hdr
suffix:semicolon
id|dev-&gt;hard_start_xmit
op_assign
op_amp
id|if_send
suffix:semicolon
id|dev-&gt;get_stats
op_assign
op_amp
id|if_stats
suffix:semicolon
multiline_comment|/* Initialize media-specific parameters */
id|dev-&gt;family
op_assign
id|AF_INET
suffix:semicolon
multiline_comment|/* address family */
id|dev-&gt;type
op_assign
id|ARPHRD_PPP
suffix:semicolon
multiline_comment|/* ARP h/w type */
id|dev-&gt;mtu
op_assign
id|wandev-&gt;mtu
suffix:semicolon
id|dev-&gt;hard_header_len
op_assign
id|PPP_HDR_LEN
suffix:semicolon
multiline_comment|/* media header length */
multiline_comment|/* Initialize hardware parameters (just for reference) */
id|dev-&gt;irq
op_assign
id|wandev-&gt;irq
suffix:semicolon
id|dev-&gt;dma
op_assign
id|wandev-&gt;dma
suffix:semicolon
id|dev-&gt;base_addr
op_assign
id|wandev-&gt;ioport
suffix:semicolon
id|dev-&gt;mem_start
op_assign
id|wandev-&gt;maddr
suffix:semicolon
id|dev-&gt;mem_end
op_assign
id|wandev-&gt;maddr
op_plus
id|wandev-&gt;msize
op_minus
l_int|1
suffix:semicolon
multiline_comment|/* Set transmit buffer queue length */
id|dev-&gt;tx_queue_len
op_assign
l_int|30
suffix:semicolon
multiline_comment|/* Initialize socket buffers */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|DEV_NUMBUFFS
suffix:semicolon
op_increment
id|i
)paren
id|skb_queue_head_init
c_func
(paren
op_amp
id|dev-&gt;buffs
(braket
id|i
)braket
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*============================================================================&n; * Open network interface.&n; * o enable communications and interrupts.&n; * o prevent module from unloading by incrementing use count&n; *&n; * Return 0 if O.k. or errno.&n; */
DECL|function|if_open
r_static
r_int
id|if_open
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
id|sdla_t
op_star
id|card
op_assign
id|dev-&gt;priv
suffix:semicolon
r_int
id|err
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;start
)paren
r_return
op_minus
id|EBUSY
multiline_comment|/* only one open is allowed */
suffix:semicolon
r_if
c_cond
(paren
id|test_and_set_bit
c_func
(paren
l_int|0
comma
(paren
r_void
op_star
)paren
op_amp
id|card-&gt;wandev.critical
)paren
)paren
r_return
op_minus
id|EAGAIN
suffix:semicolon
suffix:semicolon
r_if
c_cond
(paren
(paren
id|card-&gt;hw.fwid
op_eq
id|SFID_PPP502
)paren
ques
c_cond
id|config502
c_func
(paren
id|card
)paren
suffix:colon
id|config508
c_func
(paren
id|card
)paren
)paren
(brace
id|err
op_assign
op_minus
id|EIO
suffix:semicolon
r_goto
id|split
suffix:semicolon
)brace
multiline_comment|/* Initialize Rx/Tx buffer control fields */
r_if
c_cond
(paren
id|card-&gt;hw.fwid
op_eq
id|SFID_PPP502
)paren
(brace
id|ppp502_buf_info_t
op_star
id|info
op_assign
(paren
r_void
op_star
)paren
(paren
id|card-&gt;hw.dpmbase
op_plus
id|PPP502_BUF_OFFS
)paren
suffix:semicolon
id|card-&gt;u.p.txbuf_base
op_assign
(paren
r_void
op_star
)paren
(paren
id|card-&gt;hw.dpmbase
op_plus
id|info-&gt;txb_offs
)paren
suffix:semicolon
id|card-&gt;u.p.txbuf_last
op_assign
(paren
id|ppp_buf_ctl_t
op_star
)paren
id|card-&gt;u.p.txbuf_base
op_plus
(paren
id|info-&gt;txb_num
op_minus
l_int|1
)paren
suffix:semicolon
id|card-&gt;u.p.rxbuf_base
op_assign
(paren
r_void
op_star
)paren
(paren
id|card-&gt;hw.dpmbase
op_plus
id|info-&gt;rxb_offs
)paren
suffix:semicolon
id|card-&gt;u.p.rxbuf_last
op_assign
(paren
id|ppp_buf_ctl_t
op_star
)paren
id|card-&gt;u.p.rxbuf_base
op_plus
(paren
id|info-&gt;rxb_num
op_minus
l_int|1
)paren
suffix:semicolon
)brace
r_else
(brace
id|ppp508_buf_info_t
op_star
id|info
op_assign
(paren
r_void
op_star
)paren
(paren
id|card-&gt;hw.dpmbase
op_plus
id|PPP508_BUF_OFFS
)paren
suffix:semicolon
id|card-&gt;u.p.txbuf_base
op_assign
(paren
r_void
op_star
)paren
(paren
id|card-&gt;hw.dpmbase
op_plus
(paren
id|info-&gt;txb_ptr
op_minus
id|PPP508_MB_VECT
)paren
)paren
suffix:semicolon
id|card-&gt;u.p.txbuf_last
op_assign
(paren
id|ppp_buf_ctl_t
op_star
)paren
id|card-&gt;u.p.txbuf_base
op_plus
(paren
id|info-&gt;txb_num
op_minus
l_int|1
)paren
suffix:semicolon
id|card-&gt;u.p.rxbuf_base
op_assign
(paren
r_void
op_star
)paren
(paren
id|card-&gt;hw.dpmbase
op_plus
(paren
id|info-&gt;rxb_ptr
op_minus
id|PPP508_MB_VECT
)paren
)paren
suffix:semicolon
id|card-&gt;u.p.rxbuf_last
op_assign
(paren
id|ppp_buf_ctl_t
op_star
)paren
id|card-&gt;u.p.rxbuf_base
op_plus
(paren
id|info-&gt;rxb_num
op_minus
l_int|1
)paren
suffix:semicolon
id|card-&gt;u.p.rx_base
op_assign
id|info-&gt;rxb_base
suffix:semicolon
id|card-&gt;u.p.rx_top
op_assign
id|info-&gt;rxb_end
suffix:semicolon
)brace
id|card-&gt;u.p.txbuf
op_assign
id|card-&gt;u.p.txbuf_base
suffix:semicolon
id|card-&gt;rxmb
op_assign
id|card-&gt;u.p.rxbuf_base
suffix:semicolon
r_if
c_cond
(paren
id|ppp_set_intr_mode
c_func
(paren
id|card
comma
l_int|0x03
)paren
op_logical_or
id|ppp_comm_enable
c_func
(paren
id|card
)paren
)paren
(brace
id|err
op_assign
op_minus
id|EIO
suffix:semicolon
r_goto
id|split
suffix:semicolon
)brace
id|wanpipe_set_state
c_func
(paren
id|card
comma
id|WAN_CONNECTING
)paren
suffix:semicolon
id|wanpipe_open
c_func
(paren
id|card
)paren
suffix:semicolon
id|dev-&gt;mtu
op_assign
id|min
c_func
(paren
id|dev-&gt;mtu
comma
id|card-&gt;wandev.mtu
)paren
suffix:semicolon
id|dev-&gt;interrupt
op_assign
l_int|0
suffix:semicolon
id|dev-&gt;tbusy
op_assign
l_int|0
suffix:semicolon
id|dev-&gt;start
op_assign
l_int|1
suffix:semicolon
id|split
suffix:colon
id|card-&gt;wandev.critical
op_assign
l_int|0
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
multiline_comment|/*============================================================================&n; * Close network interface.&n; * o if this is the last open, then disable communications and interrupts.&n; * o reset flags.&n; */
DECL|function|if_close
r_static
r_int
id|if_close
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
id|sdla_t
op_star
id|card
op_assign
id|dev-&gt;priv
suffix:semicolon
r_if
c_cond
(paren
id|test_and_set_bit
c_func
(paren
l_int|0
comma
(paren
r_void
op_star
)paren
op_amp
id|card-&gt;wandev.critical
)paren
)paren
r_return
op_minus
id|EAGAIN
suffix:semicolon
suffix:semicolon
id|dev-&gt;start
op_assign
l_int|0
suffix:semicolon
id|wanpipe_close
c_func
(paren
id|card
)paren
suffix:semicolon
id|wanpipe_set_state
c_func
(paren
id|card
comma
id|WAN_DISCONNECTED
)paren
suffix:semicolon
id|ppp_set_intr_mode
c_func
(paren
id|card
comma
l_int|0
)paren
suffix:semicolon
id|ppp_comm_disable
c_func
(paren
id|card
)paren
suffix:semicolon
id|card-&gt;wandev.critical
op_assign
l_int|0
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*============================================================================&n; * Build media header.&n; *&n; * The trick here is to put packet type (Ethertype) into &squot;protocol&squot; field of&n; * the socket buffer, so that we don&squot;t forget it.  If packet type is not&n; * supported, set skb-&gt;protocol to 0 and discard packet later.&n; *&n; * Return:&t;media header length.&n; */
DECL|function|if_header
r_static
r_int
id|if_header
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|device
op_star
id|dev
comma
r_int
r_int
id|type
comma
r_void
op_star
id|daddr
comma
r_void
op_star
id|saddr
comma
r_int
id|len
)paren
(brace
r_switch
c_cond
(paren
id|type
)paren
(brace
r_case
id|ETH_P_IP
suffix:colon
r_case
id|ETH_P_IPX
suffix:colon
id|skb-&gt;protocol
op_assign
id|type
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|skb-&gt;protocol
op_assign
l_int|0
suffix:semicolon
)brace
r_return
id|PPP_HDR_LEN
suffix:semicolon
)brace
multiline_comment|/*============================================================================&n; * Re-build media header.&n; *&n; * Return:&t;1&t;physical address resolved.&n; *&t;&t;0&t;physical address not resolved&n; */
DECL|function|if_rebuild_hdr
r_static
r_int
id|if_rebuild_hdr
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
)paren
(brace
id|sdla_t
op_star
id|card
op_assign
id|skb-&gt;dev-&gt;priv
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: rebuild_header() called for interface %s!&bslash;n&quot;
comma
id|card-&gt;devname
comma
id|skb-&gt;dev-&gt;name
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
multiline_comment|/*============================================================================&n; * Send a packet on a network interface.&n; * o set tbusy flag (marks start of the transmission) to block a timer-based&n; *   transmit from overlapping.&n; * o check link state. If link is not up, then drop the packet.&n; * o execute adapter send command.&n; * o free socket buffer&n; *&n; * Return:&t;0&t;complete (socket buffer must be freed)&n; *&t;&t;non-0&t;packet may be re-transmitted (tbusy must be set)&n; *&n; * Notes:&n; * 1. This routine is called either by the protocol stack or by the &quot;net&n; *    bottom half&quot; (with interrupts enabled).&n; * 2. Setting tbusy flag will inhibit further transmit requests from the&n; *    protocol stack and can be used for flow control with protocol layer.&n; */
DECL|function|if_send
r_static
r_int
id|if_send
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|device
op_star
id|dev
)paren
(brace
id|sdla_t
op_star
id|card
op_assign
id|dev-&gt;priv
suffix:semicolon
r_int
id|retry
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|test_and_set_bit
c_func
(paren
l_int|0
comma
(paren
r_void
op_star
)paren
op_amp
id|card-&gt;wandev.critical
)paren
)paren
(brace
macro_line|#ifdef _DEBUG_
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: if_send() hit critical section!&bslash;n&quot;
comma
id|card-&gt;devname
)paren
suffix:semicolon
macro_line|#endif
r_return
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|test_and_set_bit
c_func
(paren
l_int|0
comma
(paren
r_void
op_star
)paren
op_amp
id|dev-&gt;tbusy
)paren
)paren
(brace
macro_line|#ifdef _DEBUG_
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Tx collision on interface %s!&bslash;n&quot;
comma
id|card-&gt;devname
comma
id|dev-&gt;name
)paren
suffix:semicolon
macro_line|#endif
op_increment
id|card-&gt;wandev.stats.collisions
suffix:semicolon
id|retry
op_assign
l_int|1
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|card-&gt;wandev.state
op_ne
id|WAN_CONNECTED
)paren
op_increment
id|card-&gt;wandev.stats.tx_dropped
suffix:semicolon
r_else
r_if
c_cond
(paren
op_logical_neg
id|skb-&gt;protocol
)paren
op_increment
id|card-&gt;wandev.stats.tx_errors
suffix:semicolon
r_else
r_if
c_cond
(paren
id|ppp_send
c_func
(paren
id|card
comma
id|skb-&gt;data
comma
id|skb-&gt;len
comma
id|skb-&gt;protocol
)paren
)paren
(brace
id|ppp_flags_t
op_star
id|flags
op_assign
id|card-&gt;flags
suffix:semicolon
id|flags-&gt;imask
op_or_assign
l_int|0x02
suffix:semicolon
multiline_comment|/* unmask Tx interrupts */
id|retry
op_assign
l_int|1
suffix:semicolon
)brace
r_else
op_increment
id|card-&gt;wandev.stats.tx_packets
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|retry
)paren
(brace
id|dev_kfree_skb
c_func
(paren
id|skb
comma
id|FREE_WRITE
)paren
suffix:semicolon
id|dev-&gt;tbusy
op_assign
l_int|0
suffix:semicolon
)brace
id|card-&gt;wandev.critical
op_assign
l_int|0
suffix:semicolon
r_return
id|retry
suffix:semicolon
)brace
multiline_comment|/*============================================================================&n; * Get ethernet-style interface statistics.&n; * Return a pointer to struct enet_statistics.&n; */
DECL|function|if_stats
r_static
r_struct
id|enet_statistics
op_star
id|if_stats
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
id|sdla_t
op_star
id|card
op_assign
id|dev-&gt;priv
suffix:semicolon
r_return
op_amp
id|card-&gt;wandev.stats
suffix:semicolon
)brace
multiline_comment|/****** PPP Firmware Interface Functions ************************************/
multiline_comment|/*============================================================================&n; * Read firmware code version.&n; *&t;Put code version as ASCII string in str. &n; */
DECL|function|ppp_read_version
r_static
r_int
id|ppp_read_version
c_func
(paren
id|sdla_t
op_star
id|card
comma
r_char
op_star
id|str
)paren
(brace
id|ppp_mbox_t
op_star
id|mb
op_assign
id|card-&gt;mbox
suffix:semicolon
r_int
id|err
suffix:semicolon
id|memset
c_func
(paren
op_amp
id|mb-&gt;cmd
comma
l_int|0
comma
r_sizeof
(paren
id|ppp_cmd_t
)paren
)paren
suffix:semicolon
id|mb-&gt;cmd.command
op_assign
id|PPP_READ_CODE_VERSION
suffix:semicolon
id|err
op_assign
id|sdla_exec
c_func
(paren
id|mb
)paren
ques
c_cond
id|mb-&gt;cmd.result
suffix:colon
id|CMD_TIMEOUT
suffix:semicolon
r_if
c_cond
(paren
id|err
op_ne
id|CMD_OK
)paren
id|ppp_error
c_func
(paren
id|card
comma
id|err
comma
id|mb
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
id|str
)paren
(brace
r_int
id|len
op_assign
id|mb-&gt;cmd.length
suffix:semicolon
id|memcpy
c_func
(paren
id|str
comma
id|mb-&gt;data
comma
id|len
)paren
suffix:semicolon
id|str
(braket
id|len
)braket
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
)brace
r_return
id|err
suffix:semicolon
)brace
multiline_comment|/*============================================================================&n; * Configure PPP firmware.&n; */
DECL|function|ppp_configure
r_static
r_int
id|ppp_configure
c_func
(paren
id|sdla_t
op_star
id|card
comma
r_void
op_star
id|data
)paren
(brace
id|ppp_mbox_t
op_star
id|mb
op_assign
id|card-&gt;mbox
suffix:semicolon
r_int
id|data_len
op_assign
(paren
id|card-&gt;hw.fwid
op_eq
id|SFID_PPP502
)paren
ques
c_cond
r_sizeof
(paren
id|ppp502_conf_t
)paren
suffix:colon
r_sizeof
(paren
id|ppp508_conf_t
)paren
suffix:semicolon
r_int
id|err
suffix:semicolon
id|memset
c_func
(paren
op_amp
id|mb-&gt;cmd
comma
l_int|0
comma
r_sizeof
(paren
id|ppp_cmd_t
)paren
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|mb-&gt;data
comma
id|data
comma
id|data_len
)paren
suffix:semicolon
id|mb-&gt;cmd.length
op_assign
id|data_len
suffix:semicolon
id|mb-&gt;cmd.command
op_assign
id|PPP_SET_CONFIG
suffix:semicolon
id|err
op_assign
id|sdla_exec
c_func
(paren
id|mb
)paren
ques
c_cond
id|mb-&gt;cmd.result
suffix:colon
id|CMD_TIMEOUT
suffix:semicolon
r_if
c_cond
(paren
id|err
op_ne
id|CMD_OK
)paren
id|ppp_error
c_func
(paren
id|card
comma
id|err
comma
id|mb
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
multiline_comment|/*============================================================================&n; * Set interrupt mode.&n; */
DECL|function|ppp_set_intr_mode
r_static
r_int
id|ppp_set_intr_mode
c_func
(paren
id|sdla_t
op_star
id|card
comma
r_int
id|mode
)paren
(brace
id|ppp_mbox_t
op_star
id|mb
op_assign
id|card-&gt;mbox
suffix:semicolon
r_int
id|err
suffix:semicolon
id|memset
c_func
(paren
op_amp
id|mb-&gt;cmd
comma
l_int|0
comma
r_sizeof
(paren
id|ppp_cmd_t
)paren
)paren
suffix:semicolon
id|mb-&gt;data
(braket
l_int|0
)braket
op_assign
id|mode
suffix:semicolon
r_switch
c_cond
(paren
id|card-&gt;hw.fwid
)paren
(brace
r_case
id|SFID_PPP502
suffix:colon
id|mb-&gt;cmd.length
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SFID_PPP508
suffix:colon
r_default
suffix:colon
id|mb-&gt;data
(braket
l_int|1
)braket
op_assign
id|card-&gt;hw.irq
suffix:semicolon
id|mb-&gt;cmd.length
op_assign
l_int|2
suffix:semicolon
)brace
id|mb-&gt;cmd.command
op_assign
id|PPP_SET_INTR_FLAGS
suffix:semicolon
id|err
op_assign
id|sdla_exec
c_func
(paren
id|mb
)paren
ques
c_cond
id|mb-&gt;cmd.result
suffix:colon
id|CMD_TIMEOUT
suffix:semicolon
r_if
c_cond
(paren
id|err
op_ne
id|CMD_OK
)paren
id|ppp_error
c_func
(paren
id|card
comma
id|err
comma
id|mb
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
multiline_comment|/*============================================================================&n; * Enable communications.&n; */
DECL|function|ppp_comm_enable
r_static
r_int
id|ppp_comm_enable
c_func
(paren
id|sdla_t
op_star
id|card
)paren
(brace
id|ppp_mbox_t
op_star
id|mb
op_assign
id|card-&gt;mbox
suffix:semicolon
r_int
id|err
suffix:semicolon
id|memset
c_func
(paren
op_amp
id|mb-&gt;cmd
comma
l_int|0
comma
r_sizeof
(paren
id|ppp_cmd_t
)paren
)paren
suffix:semicolon
id|mb-&gt;cmd.command
op_assign
id|PPP_COMM_ENABLE
suffix:semicolon
id|err
op_assign
id|sdla_exec
c_func
(paren
id|mb
)paren
ques
c_cond
id|mb-&gt;cmd.result
suffix:colon
id|CMD_TIMEOUT
suffix:semicolon
r_if
c_cond
(paren
id|err
op_ne
id|CMD_OK
)paren
id|ppp_error
c_func
(paren
id|card
comma
id|err
comma
id|mb
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
multiline_comment|/*============================================================================&n; * Disable communications.&n; */
DECL|function|ppp_comm_disable
r_static
r_int
id|ppp_comm_disable
c_func
(paren
id|sdla_t
op_star
id|card
)paren
(brace
id|ppp_mbox_t
op_star
id|mb
op_assign
id|card-&gt;mbox
suffix:semicolon
r_int
id|err
suffix:semicolon
id|memset
c_func
(paren
op_amp
id|mb-&gt;cmd
comma
l_int|0
comma
r_sizeof
(paren
id|ppp_cmd_t
)paren
)paren
suffix:semicolon
id|mb-&gt;cmd.command
op_assign
id|PPP_COMM_DISABLE
suffix:semicolon
id|err
op_assign
id|sdla_exec
c_func
(paren
id|mb
)paren
ques
c_cond
id|mb-&gt;cmd.result
suffix:colon
id|CMD_TIMEOUT
suffix:semicolon
r_if
c_cond
(paren
id|err
op_ne
id|CMD_OK
)paren
id|ppp_error
c_func
(paren
id|card
comma
id|err
comma
id|mb
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
multiline_comment|/*============================================================================&n; * Get communications error statistics.&n; */
DECL|function|ppp_get_err_stats
r_static
r_int
id|ppp_get_err_stats
c_func
(paren
id|sdla_t
op_star
id|card
)paren
(brace
id|ppp_mbox_t
op_star
id|mb
op_assign
id|card-&gt;mbox
suffix:semicolon
r_int
id|err
suffix:semicolon
id|memset
c_func
(paren
op_amp
id|mb-&gt;cmd
comma
l_int|0
comma
r_sizeof
(paren
id|ppp_cmd_t
)paren
)paren
suffix:semicolon
id|mb-&gt;cmd.command
op_assign
id|PPP_READ_ERROR_STATS
suffix:semicolon
id|err
op_assign
id|sdla_exec
c_func
(paren
id|mb
)paren
ques
c_cond
id|mb-&gt;cmd.result
suffix:colon
id|CMD_TIMEOUT
suffix:semicolon
r_if
c_cond
(paren
id|err
op_eq
id|CMD_OK
)paren
(brace
id|ppp_err_stats_t
op_star
id|stats
op_assign
(paren
r_void
op_star
)paren
id|mb-&gt;data
suffix:semicolon
id|card-&gt;wandev.stats.rx_over_errors
op_assign
id|stats-&gt;rx_overrun
suffix:semicolon
id|card-&gt;wandev.stats.rx_crc_errors
op_assign
id|stats-&gt;rx_bad_crc
suffix:semicolon
id|card-&gt;wandev.stats.rx_missed_errors
op_assign
id|stats-&gt;rx_abort
suffix:semicolon
id|card-&gt;wandev.stats.rx_length_errors
op_assign
id|stats-&gt;rx_lost
suffix:semicolon
id|card-&gt;wandev.stats.tx_aborted_errors
op_assign
id|stats-&gt;tx_abort
suffix:semicolon
)brace
r_else
id|ppp_error
c_func
(paren
id|card
comma
id|err
comma
id|mb
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
multiline_comment|/*============================================================================&n; * Send packet.&n; *&t;Return:&t;0 - o.k.&n; *&t;&t;1 - no transmit buffers available&n; */
DECL|function|ppp_send
r_static
r_int
id|ppp_send
c_func
(paren
id|sdla_t
op_star
id|card
comma
r_void
op_star
id|data
comma
r_int
id|len
comma
r_int
id|proto
)paren
(brace
id|ppp_buf_ctl_t
op_star
id|txbuf
op_assign
id|card-&gt;u.p.txbuf
suffix:semicolon
r_int
r_int
id|addr
comma
id|cpu_flags
suffix:semicolon
r_if
c_cond
(paren
id|txbuf-&gt;flag
)paren
r_return
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|card-&gt;hw.fwid
op_eq
id|SFID_PPP502
)paren
id|addr
op_assign
(paren
id|txbuf-&gt;buf.o_p
(braket
l_int|1
)braket
op_lshift
l_int|8
)paren
op_plus
id|txbuf-&gt;buf.o_p
(braket
l_int|0
)braket
suffix:semicolon
r_else
id|addr
op_assign
id|txbuf-&gt;buf.ptr
suffix:semicolon
id|save_flags
c_func
(paren
id|cpu_flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|sdla_poke
c_func
(paren
op_amp
id|card-&gt;hw
comma
id|addr
comma
id|data
comma
id|len
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|cpu_flags
)paren
suffix:semicolon
id|txbuf-&gt;length
op_assign
id|len
suffix:semicolon
multiline_comment|/* frame length */
r_if
c_cond
(paren
id|proto
op_eq
id|ETH_P_IPX
)paren
id|txbuf-&gt;proto
op_assign
l_int|0x01
multiline_comment|/* protocol ID */
suffix:semicolon
id|txbuf-&gt;flag
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* start transmission */
multiline_comment|/* Update transmit buffer control fields */
id|card-&gt;u.p.txbuf
op_assign
op_increment
id|txbuf
suffix:semicolon
r_if
c_cond
(paren
(paren
r_void
op_star
)paren
id|txbuf
OG
id|card-&gt;u.p.txbuf_last
)paren
id|card-&gt;u.p.txbuf
op_assign
id|card-&gt;u.p.txbuf_base
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/****** Firmware Error Handler **********************************************/
multiline_comment|/*============================================================================&n; * Firmware error handler.&n; *&t;This routine is called whenever firmware command returns non-zero&n; *&t;return code.&n; *&n; * Return zero if previous command has to be cancelled.&n; */
DECL|function|ppp_error
r_static
r_int
id|ppp_error
c_func
(paren
id|sdla_t
op_star
id|card
comma
r_int
id|err
comma
id|ppp_mbox_t
op_star
id|mb
)paren
(brace
r_int
id|cmd
op_assign
id|mb-&gt;cmd.command
suffix:semicolon
r_switch
c_cond
(paren
id|err
)paren
(brace
r_case
id|CMD_TIMEOUT
suffix:colon
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: command 0x%02X timed out!&bslash;n&quot;
comma
id|card-&gt;devname
comma
id|cmd
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: command 0x%02X returned 0x%02X!&bslash;n&quot;
comma
id|card-&gt;devname
comma
id|cmd
comma
id|err
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/****** Interrupt Handlers **************************************************/
multiline_comment|/*============================================================================&n; * PPP interrupt service routine.&n; */
DECL|function|wpp_isr
id|STATIC
r_void
id|wpp_isr
c_func
(paren
id|sdla_t
op_star
id|card
)paren
(brace
id|ppp_flags_t
op_star
id|flags
op_assign
id|card-&gt;flags
suffix:semicolon
r_switch
c_cond
(paren
id|flags-&gt;iflag
)paren
(brace
r_case
l_int|0x01
suffix:colon
multiline_comment|/* receive interrupt */
id|rx_intr
c_func
(paren
id|card
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x02
suffix:colon
multiline_comment|/* transmit interrupt */
id|flags-&gt;imask
op_and_assign
op_complement
l_int|0x02
suffix:semicolon
id|tx_intr
c_func
(paren
id|card
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
multiline_comment|/* unexpected interrupt */
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: spurious interrupt 0x%02X!&bslash;n&quot;
comma
id|card-&gt;devname
comma
id|flags-&gt;iflag
)paren
suffix:semicolon
)brace
id|flags-&gt;iflag
op_assign
l_int|0
suffix:semicolon
)brace
multiline_comment|/*============================================================================&n; * Receive interrupt handler.&n; */
DECL|function|rx_intr
r_static
r_void
id|rx_intr
c_func
(paren
id|sdla_t
op_star
id|card
)paren
(brace
id|ppp_buf_ctl_t
op_star
id|rxbuf
op_assign
id|card-&gt;rxmb
suffix:semicolon
r_struct
id|device
op_star
id|dev
op_assign
id|card-&gt;wandev.dev
suffix:semicolon
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
r_int
id|len
suffix:semicolon
r_void
op_star
id|buf
suffix:semicolon
r_if
c_cond
(paren
id|rxbuf-&gt;flag
op_ne
l_int|0x01
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: corrupted Rx buffer @ 0x%X!&bslash;n&quot;
comma
id|card-&gt;devname
comma
(paren
r_int
)paren
id|rxbuf
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|dev
op_logical_or
op_logical_neg
id|dev-&gt;start
)paren
r_goto
id|rx_done
suffix:semicolon
id|len
op_assign
id|rxbuf-&gt;length
suffix:semicolon
multiline_comment|/* Allocate socket buffer */
id|skb
op_assign
id|dev_alloc_skb
c_func
(paren
id|len
)paren
suffix:semicolon
r_if
c_cond
(paren
id|skb
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: no socket buffers available!&bslash;n&quot;
comma
id|card-&gt;devname
)paren
suffix:semicolon
op_increment
id|card-&gt;wandev.stats.rx_dropped
suffix:semicolon
r_goto
id|rx_done
suffix:semicolon
)brace
multiline_comment|/* Copy data to the socket buffer */
r_if
c_cond
(paren
id|card-&gt;hw.fwid
op_eq
id|SFID_PPP502
)paren
(brace
r_int
id|addr
op_assign
(paren
id|rxbuf-&gt;buf.o_p
(braket
l_int|1
)braket
op_lshift
l_int|8
)paren
op_plus
id|rxbuf-&gt;buf.o_p
(braket
l_int|0
)braket
suffix:semicolon
id|buf
op_assign
id|skb_put
c_func
(paren
id|skb
comma
id|len
)paren
suffix:semicolon
id|sdla_peek
c_func
(paren
op_amp
id|card-&gt;hw
comma
id|addr
comma
id|buf
comma
id|len
)paren
suffix:semicolon
)brace
r_else
(brace
r_int
id|addr
op_assign
id|rxbuf-&gt;buf.ptr
suffix:semicolon
r_if
c_cond
(paren
(paren
id|addr
op_plus
id|len
)paren
OG
id|card-&gt;u.p.rx_top
op_plus
l_int|1
)paren
(brace
r_int
id|tmp
op_assign
id|card-&gt;u.p.rx_top
op_minus
id|addr
op_plus
l_int|1
suffix:semicolon
id|buf
op_assign
id|skb_put
c_func
(paren
id|skb
comma
id|tmp
)paren
suffix:semicolon
id|sdla_peek
c_func
(paren
op_amp
id|card-&gt;hw
comma
id|addr
comma
id|buf
comma
id|tmp
)paren
suffix:semicolon
id|addr
op_assign
id|card-&gt;u.p.rx_base
suffix:semicolon
id|len
op_sub_assign
id|tmp
suffix:semicolon
)brace
id|buf
op_assign
id|skb_put
c_func
(paren
id|skb
comma
id|len
)paren
suffix:semicolon
id|sdla_peek
c_func
(paren
op_amp
id|card-&gt;hw
comma
id|addr
comma
id|buf
comma
id|len
)paren
suffix:semicolon
)brace
multiline_comment|/* Decapsulate packet */
r_switch
c_cond
(paren
id|rxbuf-&gt;proto
)paren
(brace
r_case
l_int|0x00
suffix:colon
id|skb-&gt;protocol
op_assign
id|htons
c_func
(paren
id|ETH_P_IP
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x01
suffix:colon
id|skb-&gt;protocol
op_assign
id|htons
c_func
(paren
id|ETH_P_IPX
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
multiline_comment|/* Pass it up the protocol stack */
id|skb-&gt;dev
op_assign
id|dev
suffix:semicolon
id|netif_rx
c_func
(paren
id|skb
)paren
suffix:semicolon
op_increment
id|card-&gt;wandev.stats.rx_packets
suffix:semicolon
id|rx_done
suffix:colon
multiline_comment|/* Release buffer element and calculate a pointer to the next one */
id|rxbuf-&gt;flag
op_assign
(paren
id|card-&gt;hw.fwid
op_eq
id|SFID_PPP502
)paren
ques
c_cond
l_int|0xFF
suffix:colon
l_int|0x00
suffix:semicolon
id|card-&gt;rxmb
op_assign
op_increment
id|rxbuf
suffix:semicolon
r_if
c_cond
(paren
(paren
r_void
op_star
)paren
id|rxbuf
OG
id|card-&gt;u.p.rxbuf_last
)paren
id|card-&gt;rxmb
op_assign
id|card-&gt;u.p.rxbuf_base
suffix:semicolon
)brace
multiline_comment|/*============================================================================&n; * Transmit interrupt handler.&n; */
DECL|function|tx_intr
r_static
r_void
id|tx_intr
c_func
(paren
id|sdla_t
op_star
id|card
)paren
(brace
r_struct
id|device
op_star
id|dev
op_assign
id|card-&gt;wandev.dev
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dev
op_logical_or
op_logical_neg
id|dev-&gt;start
)paren
r_return
suffix:semicolon
id|dev-&gt;tbusy
op_assign
l_int|0
suffix:semicolon
id|mark_bh
c_func
(paren
id|NET_BH
)paren
suffix:semicolon
)brace
multiline_comment|/****** Background Polling Routines  ****************************************/
multiline_comment|/*============================================================================&n; * Main polling routine.&n; * This routine is repeatedly called by the WANPIPE &squot;thread&squot; to allow for&n; * time-dependent housekeeping work.&n; *&n; * Notes:&n; * 1. This routine may be called on interrupt context with all interrupts&n; *    enabled. Beware!&n; */
DECL|function|wpp_poll
r_static
r_void
id|wpp_poll
c_func
(paren
id|sdla_t
op_star
id|card
)paren
(brace
r_switch
c_cond
(paren
id|card-&gt;wandev.state
)paren
(brace
r_case
id|WAN_CONNECTED
suffix:colon
id|poll_active
c_func
(paren
id|card
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|WAN_CONNECTING
suffix:colon
id|poll_connecting
c_func
(paren
id|card
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|WAN_DISCONNECTED
suffix:colon
id|poll_disconnected
c_func
(paren
id|card
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
multiline_comment|/*============================================================================&n; * Monitor active link phase.&n; */
DECL|function|poll_active
r_static
r_void
id|poll_active
c_func
(paren
id|sdla_t
op_star
id|card
)paren
(brace
id|ppp_flags_t
op_star
id|flags
op_assign
id|card-&gt;flags
suffix:semicolon
r_if
c_cond
(paren
id|flags-&gt;disc_cause
op_amp
l_int|0x03
)paren
(brace
id|wanpipe_set_state
c_func
(paren
id|card
comma
id|WAN_DISCONNECTED
)paren
suffix:semicolon
id|show_disc_cause
c_func
(paren
id|card
comma
id|flags-&gt;disc_cause
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/*============================================================================&n; * Monitor link establishment phase.&n; * o if connection timed out, disconnect the link.&n; */
DECL|function|poll_connecting
r_static
r_void
id|poll_connecting
c_func
(paren
id|sdla_t
op_star
id|card
)paren
(brace
id|ppp_flags_t
op_star
id|flags
op_assign
id|card-&gt;flags
suffix:semicolon
r_if
c_cond
(paren
id|flags-&gt;lcp_state
op_eq
l_int|0x09
)paren
(brace
id|wanpipe_set_state
c_func
(paren
id|card
comma
id|WAN_CONNECTED
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|flags-&gt;disc_cause
op_amp
l_int|0x03
)paren
(brace
id|wanpipe_set_state
c_func
(paren
id|card
comma
id|WAN_DISCONNECTED
)paren
suffix:semicolon
id|show_disc_cause
c_func
(paren
id|card
comma
id|flags-&gt;disc_cause
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/*============================================================================&n; * Monitor physical link disconnected phase.&n; *  o if interface is up and the hold-down timeout has expired, then retry&n; *    connection.&n; */
DECL|function|poll_disconnected
r_static
r_void
id|poll_disconnected
c_func
(paren
id|sdla_t
op_star
id|card
)paren
(brace
r_struct
id|device
op_star
id|dev
op_assign
id|card-&gt;wandev.dev
suffix:semicolon
r_if
c_cond
(paren
id|dev
op_logical_and
id|dev-&gt;start
op_logical_and
(paren
(paren
id|jiffies
op_minus
id|card-&gt;state_tick
)paren
OG
id|HOLD_DOWN_TIME
)paren
)paren
(brace
id|wanpipe_set_state
c_func
(paren
id|card
comma
id|WAN_CONNECTING
)paren
suffix:semicolon
id|ppp_comm_enable
c_func
(paren
id|card
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/****** Miscellaneous Functions *********************************************/
multiline_comment|/*============================================================================&n; * Configure S502 adapter.&n; */
DECL|function|config502
r_static
r_int
id|config502
c_func
(paren
id|sdla_t
op_star
id|card
)paren
(brace
id|ppp502_conf_t
id|cfg
suffix:semicolon
multiline_comment|/* Prepare PPP configuration structure */
id|memset
c_func
(paren
op_amp
id|cfg
comma
l_int|0
comma
r_sizeof
(paren
id|ppp502_conf_t
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|card-&gt;wandev.clocking
)paren
id|cfg.line_speed
op_assign
id|bps_to_speed_code
c_func
(paren
id|card-&gt;wandev.bps
)paren
suffix:semicolon
id|cfg.txbuf_num
op_assign
l_int|4
suffix:semicolon
id|cfg.mtu_local
op_assign
id|card-&gt;wandev.mtu
suffix:semicolon
id|cfg.mtu_remote
op_assign
id|card-&gt;wandev.mtu
suffix:semicolon
id|cfg.restart_tmr
op_assign
l_int|30
suffix:semicolon
id|cfg.auth_rsrt_tmr
op_assign
l_int|30
suffix:semicolon
id|cfg.auth_wait_tmr
op_assign
l_int|300
suffix:semicolon
id|cfg.mdm_fail_tmr
op_assign
l_int|5
suffix:semicolon
id|cfg.dtr_drop_tmr
op_assign
l_int|1
suffix:semicolon
id|cfg.connect_tmout
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* changed it from 900 */
id|cfg.conf_retry
op_assign
l_int|10
suffix:semicolon
id|cfg.term_retry
op_assign
l_int|2
suffix:semicolon
id|cfg.fail_retry
op_assign
l_int|5
suffix:semicolon
id|cfg.auth_retry
op_assign
l_int|10
suffix:semicolon
id|cfg.ip_options
op_assign
l_int|0x80
suffix:semicolon
id|cfg.ipx_options
op_assign
l_int|0xA0
suffix:semicolon
id|cfg.conf_flags
op_or_assign
l_int|0x0E
suffix:semicolon
multiline_comment|/*&n;   cfg.ip_local         = dev-&gt;pa_addr;&n;   cfg.ip_remote                = dev-&gt;pa_dstaddr;&n; */
r_return
id|ppp_configure
c_func
(paren
id|card
comma
op_amp
id|cfg
)paren
suffix:semicolon
)brace
multiline_comment|/*============================================================================&n; * Configure S508 adapter.&n; */
DECL|function|config508
r_static
r_int
id|config508
c_func
(paren
id|sdla_t
op_star
id|card
)paren
(brace
id|ppp508_conf_t
id|cfg
suffix:semicolon
multiline_comment|/* Prepare PPP configuration structure */
id|memset
c_func
(paren
op_amp
id|cfg
comma
l_int|0
comma
r_sizeof
(paren
id|ppp508_conf_t
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|card-&gt;wandev.clocking
)paren
id|cfg.line_speed
op_assign
id|card-&gt;wandev.bps
suffix:semicolon
r_if
c_cond
(paren
id|card-&gt;wandev.interface
op_eq
id|WANOPT_RS232
)paren
id|cfg.conf_flags
op_or_assign
l_int|0x0020
suffix:semicolon
suffix:semicolon
id|cfg.conf_flags
op_or_assign
l_int|0x300
suffix:semicolon
multiline_comment|/*send Configure-Request packets forever */
id|cfg.txbuf_percent
op_assign
l_int|60
suffix:semicolon
multiline_comment|/* % of Tx bufs */
id|cfg.mtu_local
op_assign
id|card-&gt;wandev.mtu
suffix:semicolon
id|cfg.mtu_remote
op_assign
id|card-&gt;wandev.mtu
suffix:semicolon
id|cfg.restart_tmr
op_assign
l_int|30
suffix:semicolon
id|cfg.auth_rsrt_tmr
op_assign
l_int|30
suffix:semicolon
id|cfg.auth_wait_tmr
op_assign
l_int|300
suffix:semicolon
id|cfg.mdm_fail_tmr
op_assign
l_int|5
suffix:semicolon
id|cfg.dtr_drop_tmr
op_assign
l_int|1
suffix:semicolon
id|cfg.connect_tmout
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* changed it from 900 */
id|cfg.conf_retry
op_assign
l_int|10
suffix:semicolon
id|cfg.term_retry
op_assign
l_int|2
suffix:semicolon
id|cfg.fail_retry
op_assign
l_int|5
suffix:semicolon
id|cfg.auth_retry
op_assign
l_int|10
suffix:semicolon
id|cfg.ip_options
op_assign
l_int|0x80
suffix:semicolon
id|cfg.ipx_options
op_assign
l_int|0xA0
suffix:semicolon
multiline_comment|/*&n;   cfg.ip_local         = dev-&gt;pa_addr;&n;   cfg.ip_remote                = dev-&gt;pa_dstaddr;&n; */
r_return
id|ppp_configure
c_func
(paren
id|card
comma
op_amp
id|cfg
)paren
suffix:semicolon
)brace
multiline_comment|/*============================================================================&n; * Show disconnection cause.&n; */
DECL|function|show_disc_cause
r_static
r_void
id|show_disc_cause
c_func
(paren
id|sdla_t
op_star
id|card
comma
r_int
id|cause
)paren
(brace
r_if
c_cond
(paren
id|cause
op_amp
l_int|0x0002
)paren
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: link terminated by peer&bslash;n&quot;
comma
id|card-&gt;devname
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
id|cause
op_amp
l_int|0x0004
)paren
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: link terminated by user&bslash;n&quot;
comma
id|card-&gt;devname
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
id|cause
op_amp
l_int|0x0008
)paren
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: authentication failed&bslash;n&quot;
comma
id|card-&gt;devname
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
id|cause
op_amp
l_int|0x0010
)paren
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: authentication protocol negotiation failed&bslash;n&quot;
comma
id|card-&gt;devname
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
id|cause
op_amp
l_int|0x0020
)paren
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: peer&squot;s request for authentication rejected&bslash;n&quot;
comma
id|card-&gt;devname
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
id|cause
op_amp
l_int|0x0040
)paren
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: MRU option rejected by peer&bslash;n&quot;
comma
id|card-&gt;devname
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
id|cause
op_amp
l_int|0x0080
)paren
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: peer&squot;s MRU was too small&bslash;n&quot;
comma
id|card-&gt;devname
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
id|cause
op_amp
l_int|0x0100
)paren
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: failed to negotiate peer&squot;s LCP options&bslash;n&quot;
comma
id|card-&gt;devname
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
id|cause
op_amp
l_int|0x0200
)paren
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: failed to negotiate peer&squot;s IPCP options&bslash;n&quot;
comma
id|card-&gt;devname
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
id|cause
op_amp
l_int|0x0400
)paren
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: failed to negotiate peer&squot;s IPXCP options&bslash;n&quot;
comma
id|card-&gt;devname
)paren
suffix:semicolon
)brace
multiline_comment|/*============================================================================&n; * Convert line speed in bps to a number used by S502 code.&n; */
DECL|function|bps_to_speed_code
r_static
r_int
r_char
id|bps_to_speed_code
c_func
(paren
r_int
r_int
id|bps
)paren
(brace
r_int
r_char
id|number
suffix:semicolon
r_if
c_cond
(paren
id|bps
op_le
l_int|1200
)paren
id|number
op_assign
l_int|0x01
suffix:semicolon
r_else
r_if
c_cond
(paren
id|bps
op_le
l_int|2400
)paren
id|number
op_assign
l_int|0x02
suffix:semicolon
r_else
r_if
c_cond
(paren
id|bps
op_le
l_int|4800
)paren
id|number
op_assign
l_int|0x03
suffix:semicolon
r_else
r_if
c_cond
(paren
id|bps
op_le
l_int|9600
)paren
id|number
op_assign
l_int|0x04
suffix:semicolon
r_else
r_if
c_cond
(paren
id|bps
op_le
l_int|19200
)paren
id|number
op_assign
l_int|0x05
suffix:semicolon
r_else
r_if
c_cond
(paren
id|bps
op_le
l_int|38400
)paren
id|number
op_assign
l_int|0x06
suffix:semicolon
r_else
r_if
c_cond
(paren
id|bps
op_le
l_int|45000
)paren
id|number
op_assign
l_int|0x07
suffix:semicolon
r_else
r_if
c_cond
(paren
id|bps
op_le
l_int|56000
)paren
id|number
op_assign
l_int|0x08
suffix:semicolon
r_else
r_if
c_cond
(paren
id|bps
op_le
l_int|64000
)paren
id|number
op_assign
l_int|0x09
suffix:semicolon
r_else
r_if
c_cond
(paren
id|bps
op_le
l_int|74000
)paren
id|number
op_assign
l_int|0x0A
suffix:semicolon
r_else
r_if
c_cond
(paren
id|bps
op_le
l_int|112000
)paren
id|number
op_assign
l_int|0x0B
suffix:semicolon
r_else
r_if
c_cond
(paren
id|bps
op_le
l_int|128000
)paren
id|number
op_assign
l_int|0x0C
suffix:semicolon
r_else
id|number
op_assign
l_int|0x0D
suffix:semicolon
r_return
id|number
suffix:semicolon
)brace
multiline_comment|/****** End *****************************************************************/
eof
