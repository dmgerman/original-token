multiline_comment|/* znet.c: An Zenith Z-Note ethernet driver for linux. */
DECL|variable|version
r_static
r_const
r_char
op_star
id|version
op_assign
l_string|&quot;znet.c:v1.02 9/23/94 becker@cesdis.gsfc.nasa.gov&bslash;n&quot;
suffix:semicolon
multiline_comment|/*&n;&t;Written by Donald Becker.&n;&n;&t;The author may be reached as becker@cesdis.gsfc.nasa.gov.&n;&t;This driver is based on the Linux skeleton driver.  The copyright of the&n;&t;skeleton driver is held by the United States Government, as represented&n;&t;by DIRNSA, and it is released under the GPL.&n;&n;&t;Thanks to Mike Hollick for alpha testing and suggestions.&n;&n;  References:&n;&t;   The Crynwr packet driver.&n;&n;&t;  &quot;82593 CSMA/CD Core LAN Controller&quot; Intel datasheet, 1992&n;&t;  Intel Microcommunications Databook, Vol. 1, 1990.&n;    As usual with Intel, the documentation is incomplete and inaccurate.&n;&t;I had to read the Crynwr packet driver to figure out how to actually&n;&t;use the i82593, and guess at what register bits matched the loosely&n;&t;related i82586.&n;&n;&t;&t;&t;&t;&t;Theory of Operation&n;&n;&t;The i82593 used in the Zenith Z-Note series operates using two(!) slave&n;&t;DMA&t;channels, one interrupt, and one 8-bit I/O port.&n;&n;&t;While there&t;several ways to configure &squot;593 DMA system, I chose the one&n;&t;that seemed commensurate with the highest system performance in the face&n;&t;of moderate interrupt latency: Both DMA channels are configured as&n;&t;recirculating ring buffers, with one channel (#0) dedicated to Rx and&n;&t;the other channel (#1) to Tx and configuration.  (Note that this is&n;&t;different than the Crynwr driver, where the Tx DMA channel is initialized&n;&t;before each operation.  That approach simplifies operation and Tx error&n;&t;recovery, but requires additional I/O in normal operation and precludes&n;&t;transmit buffer&t;chaining.)&n;&n;&t;Both rings are set to 8192 bytes using {TX,RX}_RING_SIZE.  This provides&n;&t;a reasonable ring size for Rx, while simplifying DMA buffer allocation --&n;&t;DMA buffers must not cross a 128K boundary.  (In truth the size selection&n;&t;was influenced by my lack of &squot;593 documentation.  I thus was constrained&n;&t;to use the Crynwr &squot;593 initialization table, which sets the Rx ring size&n;&t;to 8K.)&n;&n;&t;Despite my usual low opinion about Intel-designed parts, I must admit&n;&t;that the bulk data handling of the i82593 is a good design for&n;&t;an integrated system, like a laptop, where using two slave DMA channels&n;&t;doesn&squot;t pose a problem.  I still take issue with using only a single I/O&n;&t;port.  In the same controlled environment there are essentially no&n;&t;limitations on I/O space, and using multiple locations would eliminate&n;&t;the&t;need for multiple operations when looking at status registers,&n;&t;setting the Rx ring boundary, or switching to promiscuous mode.&n;&n;&t;I also question Zenith&squot;s selection of the &squot;593: one of the advertised&n;&t;advantages of earlier Intel parts was that if you figured out the magic&n;&t;initialization incantation you could use the same part on many different&n;&t;network types.  Zenith&squot;s use of the &quot;FriendlyNet&quot; (sic) connector rather&n;&t;than an&t;on-board transceiver leads me to believe that they were planning&n;&t;to take advantage of this.  But, uhmmm, the &squot;593 omits all but ethernet&n;&t;functionality from the serial subsystem.&n; */
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/ptrace.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/interrupt.h&gt;
macro_line|#include &lt;linux/ioport.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;asm/system.h&gt;
macro_line|#include &lt;asm/bitops.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/dma.h&gt;
macro_line|#include &lt;linux/netdevice.h&gt;
macro_line|#include &lt;linux/etherdevice.h&gt;
macro_line|#include &lt;linux/skbuff.h&gt;
macro_line|#include &lt;linux/if_arp.h&gt;
macro_line|#ifndef ZNET_DEBUG
DECL|macro|ZNET_DEBUG
mdefine_line|#define ZNET_DEBUG 1
macro_line|#endif
DECL|variable|znet_debug
r_static
r_int
r_int
id|znet_debug
op_assign
id|ZNET_DEBUG
suffix:semicolon
multiline_comment|/* The DMA modes we need aren&squot;t in &lt;dma.h&gt;. */
DECL|macro|DMA_RX_MODE
mdefine_line|#define DMA_RX_MODE&t;&t;0x14&t;/* Auto init, I/O to mem, ++, demand. */
DECL|macro|DMA_TX_MODE
mdefine_line|#define DMA_TX_MODE&t;&t;0x18&t;/* Auto init, Mem to I/O, ++, demand. */
DECL|macro|dma_page_eq
mdefine_line|#define dma_page_eq(ptr1, ptr2) ((long)(ptr1)&gt;&gt;17 == (long)(ptr2)&gt;&gt;17)
DECL|macro|DMA_BUF_SIZE
mdefine_line|#define DMA_BUF_SIZE 8192
DECL|macro|RX_BUF_SIZE
mdefine_line|#define RX_BUF_SIZE 8192
DECL|macro|TX_BUF_SIZE
mdefine_line|#define TX_BUF_SIZE 8192
multiline_comment|/* Commands to the i82593 channel 0. */
DECL|macro|CMD0_CHNL_0
mdefine_line|#define CMD0_CHNL_0&t;&t;&t;0x00
DECL|macro|CMD0_CHNL_1
mdefine_line|#define CMD0_CHNL_1&t;&t;&t;0x10&t;&t;/* Switch to channel 1. */
DECL|macro|CMD0_NOP
mdefine_line|#define CMD0_NOP (CMD0_CHNL_0)
DECL|macro|CMD0_PORT_1
mdefine_line|#define CMD0_PORT_1&t;CMD0_CHNL_1
DECL|macro|CMD1_PORT_0
mdefine_line|#define CMD1_PORT_0&t;1
DECL|macro|CMD0_IA_SETUP
mdefine_line|#define CMD0_IA_SETUP&t;&t;1
DECL|macro|CMD0_CONFIGURE
mdefine_line|#define CMD0_CONFIGURE&t;&t;2
DECL|macro|CMD0_MULTICAST_LIST
mdefine_line|#define CMD0_MULTICAST_LIST 3
DECL|macro|CMD0_TRANSMIT
mdefine_line|#define CMD0_TRANSMIT&t;&t;4
DECL|macro|CMD0_DUMP
mdefine_line|#define CMD0_DUMP&t;&t;&t;6
DECL|macro|CMD0_DIAGNOSE
mdefine_line|#define CMD0_DIAGNOSE&t;&t;7
DECL|macro|CMD0_Rx_ENABLE
mdefine_line|#define CMD0_Rx_ENABLE&t;&t;8
DECL|macro|CMD0_Rx_DISABLE
mdefine_line|#define CMD0_Rx_DISABLE&t;&t;10
DECL|macro|CMD0_Rx_STOP
mdefine_line|#define CMD0_Rx_STOP&t;&t;11
DECL|macro|CMD0_RETRANSMIT
mdefine_line|#define CMD0_RETRANSMIT&t;&t;12
DECL|macro|CMD0_ABORT
mdefine_line|#define CMD0_ABORT&t;&t;&t;13
DECL|macro|CMD0_RESET
mdefine_line|#define CMD0_RESET&t;&t;&t;14
DECL|macro|CMD0_ACK
mdefine_line|#define CMD0_ACK 0x80
DECL|macro|CMD0_STAT0
mdefine_line|#define CMD0_STAT0 (0 &lt;&lt; 5)
DECL|macro|CMD0_STAT1
mdefine_line|#define CMD0_STAT1 (1 &lt;&lt; 5)
DECL|macro|CMD0_STAT2
mdefine_line|#define CMD0_STAT2 (2 &lt;&lt; 5)
DECL|macro|CMD0_STAT3
mdefine_line|#define CMD0_STAT3 (3 &lt;&lt; 5)
DECL|macro|TX_TIMEOUT
mdefine_line|#define TX_TIMEOUT&t;10
DECL|macro|net_local
mdefine_line|#define net_local znet_private
DECL|struct|znet_private
r_struct
id|znet_private
(brace
DECL|member|rx_dma
DECL|member|tx_dma
r_int
id|rx_dma
comma
id|tx_dma
suffix:semicolon
DECL|member|stats
r_struct
id|net_device_stats
id|stats
suffix:semicolon
DECL|member|lock
id|spinlock_t
id|lock
suffix:semicolon
multiline_comment|/* The starting, current, and end pointers for the packet buffers. */
DECL|member|rx_start
DECL|member|rx_cur
DECL|member|rx_end
id|ushort
op_star
id|rx_start
comma
op_star
id|rx_cur
comma
op_star
id|rx_end
suffix:semicolon
DECL|member|tx_start
DECL|member|tx_cur
DECL|member|tx_end
id|ushort
op_star
id|tx_start
comma
op_star
id|tx_cur
comma
op_star
id|tx_end
suffix:semicolon
DECL|member|tx_buf_len
id|ushort
id|tx_buf_len
suffix:semicolon
multiline_comment|/* Tx buffer length, in words. */
)brace
suffix:semicolon
multiline_comment|/* Only one can be built-in;-&gt; */
DECL|variable|zn
r_static
r_struct
id|znet_private
id|zn
suffix:semicolon
DECL|variable|dma_buffer1
r_static
id|ushort
id|dma_buffer1
(braket
id|DMA_BUF_SIZE
op_div
l_int|2
)braket
suffix:semicolon
DECL|variable|dma_buffer2
r_static
id|ushort
id|dma_buffer2
(braket
id|DMA_BUF_SIZE
op_div
l_int|2
)braket
suffix:semicolon
DECL|variable|dma_buffer3
r_static
id|ushort
id|dma_buffer3
(braket
id|DMA_BUF_SIZE
op_div
l_int|2
op_plus
l_int|8
)braket
suffix:semicolon
multiline_comment|/* The configuration block.  What an undocumented nightmare.  The first&n;   set of values are those suggested (without explanation) for ethernet&n;   in the Intel 82586 databook.&t; The rest appear to be completely undocumented,&n;   except for cryptic notes in the Crynwr packet driver.  This driver uses&n;   the Crynwr values verbatim. */
DECL|variable|i593_init
r_static
r_int
r_char
id|i593_init
(braket
)braket
op_assign
(brace
l_int|0xAA
comma
multiline_comment|/* 0: 16-byte input &amp; 80-byte output FIFO. */
multiline_comment|/*&t;  threshold, 96-byte FIFO, 82593 mode. */
l_int|0x88
comma
multiline_comment|/* 1: Continuous w/interrupts, 128-clock DMA.*/
l_int|0x2E
comma
multiline_comment|/* 2: 8-byte preamble, NO address insertion, */
multiline_comment|/*&t;  6-byte Ethernet address, loopback off.*/
l_int|0x00
comma
multiline_comment|/* 3: Default priorities &amp; backoff methods. */
l_int|0x60
comma
multiline_comment|/* 4: 96-bit interframe spacing. */
l_int|0x00
comma
multiline_comment|/* 5: 512-bit slot time (low-order). */
l_int|0xF2
comma
multiline_comment|/* 6: Slot time (high-order), 15 COLL retries. */
l_int|0x00
comma
multiline_comment|/* 7: Promisc-off, broadcast-on, default CRC. */
l_int|0x00
comma
multiline_comment|/* 8: Default carrier-sense, collision-detect. */
l_int|0x40
comma
multiline_comment|/* 9: 64-byte minimum frame length. */
l_int|0x5F
comma
multiline_comment|/* A: Type/length checks OFF, no CRC input,&n;&t;&t;&t;&t;&t;&t;   &quot;jabber&quot; termination, etc. */
l_int|0x00
comma
multiline_comment|/* B: Full-duplex disabled. */
l_int|0x3F
comma
multiline_comment|/* C: Default multicast addresses &amp; backoff. */
l_int|0x07
comma
multiline_comment|/* D: Default IFS retriggering. */
l_int|0x31
comma
multiline_comment|/* E: Internal retransmit, drop &quot;runt&quot; packets,&n;&t;&t;&t;&t;&t;&t;   synchr. DRQ deassertion, 6 status bytes. */
l_int|0x22
comma
multiline_comment|/* F: Receive ring-buffer size (8K), &n;&t;&t;&t;&t;&t;&t;   receive-stop register enable. */
)brace
suffix:semicolon
DECL|struct|netidblk
r_struct
id|netidblk
(brace
DECL|member|magic
r_char
id|magic
(braket
l_int|8
)braket
suffix:semicolon
multiline_comment|/* The magic number (string) &quot;NETIDBLK&quot; */
DECL|member|netid
r_int
r_char
id|netid
(braket
l_int|8
)braket
suffix:semicolon
multiline_comment|/* The physical station address */
DECL|member|nettype
DECL|member|globalopt
r_char
id|nettype
comma
id|globalopt
suffix:semicolon
DECL|member|vendor
r_char
id|vendor
(braket
l_int|8
)braket
suffix:semicolon
multiline_comment|/* The machine vendor and product name. */
DECL|member|product
r_char
id|product
(braket
l_int|8
)braket
suffix:semicolon
DECL|member|irq1
DECL|member|irq2
r_char
id|irq1
comma
id|irq2
suffix:semicolon
multiline_comment|/* Interrupts, only one is currently used.&t;*/
DECL|member|dma1
DECL|member|dma2
r_char
id|dma1
comma
id|dma2
suffix:semicolon
DECL|member|dma_mem_misc
r_int
id|dma_mem_misc
(braket
l_int|8
)braket
suffix:semicolon
multiline_comment|/* DMA buffer locations (unused in Linux). */
DECL|member|iobase1
DECL|member|iosize1
r_int
id|iobase1
comma
id|iosize1
suffix:semicolon
DECL|member|iobase2
DECL|member|iosize2
r_int
id|iobase2
comma
id|iosize2
suffix:semicolon
multiline_comment|/* Second iobase unused. */
DECL|member|driver_options
r_char
id|driver_options
suffix:semicolon
multiline_comment|/* Misc. bits */
DECL|member|pad
r_char
id|pad
suffix:semicolon
)brace
suffix:semicolon
r_int
id|znet_probe
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_int
id|znet_open
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_int
id|znet_send_packet
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_void
id|znet_interrupt
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
suffix:semicolon
r_static
r_void
id|znet_rx
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_int
id|znet_close
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_struct
id|net_device_stats
op_star
id|net_get_stats
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_void
id|set_multicast_list
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_void
id|hardware_init
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_void
id|update_stop_hit
c_func
(paren
r_int
id|ioaddr
comma
r_int
r_int
id|rx_stop_offset
)paren
suffix:semicolon
r_static
r_void
id|znet_tx_timeout
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
macro_line|#ifdef notdef
DECL|variable|znet_sigaction
r_static
r_struct
id|sigaction
id|znet_sigaction
op_assign
(brace
op_amp
id|znet_interrupt
comma
l_int|0
comma
l_int|0
comma
l_int|NULL
comma
)brace
suffix:semicolon
macro_line|#endif
"&f;"
multiline_comment|/* The Z-Note probe is pretty easy.  The NETIDBLK exists in the safe-to-probe&n;   BIOS area.  We just scan for the signature, and pull the vital parameters&n;   out of the structure. */
DECL|function|znet_probe
r_int
id|__init
id|znet_probe
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_int
id|i
suffix:semicolon
r_struct
id|netidblk
op_star
id|netinfo
suffix:semicolon
r_char
op_star
id|p
suffix:semicolon
multiline_comment|/* This code scans the region 0xf0000 to 0xfffff for a &quot;NETIDBLK&quot;. */
r_for
c_loop
(paren
id|p
op_assign
(paren
r_char
op_star
)paren
id|phys_to_virt
c_func
(paren
l_int|0xf0000
)paren
suffix:semicolon
id|p
OL
(paren
r_char
op_star
)paren
id|phys_to_virt
c_func
(paren
l_int|0x100000
)paren
suffix:semicolon
id|p
op_increment
)paren
r_if
c_cond
(paren
op_star
id|p
op_eq
l_char|&squot;N&squot;
op_logical_and
id|strncmp
c_func
(paren
id|p
comma
l_string|&quot;NETIDBLK&quot;
comma
l_int|8
)paren
op_eq
l_int|0
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
id|p
op_ge
(paren
r_char
op_star
)paren
id|phys_to_virt
c_func
(paren
l_int|0x100000
)paren
)paren
(brace
r_if
c_cond
(paren
id|znet_debug
OG
l_int|1
)paren
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;No Z-Note ethernet adaptor found.&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
id|netinfo
op_assign
(paren
r_struct
id|netidblk
op_star
)paren
id|p
suffix:semicolon
id|dev-&gt;base_addr
op_assign
id|netinfo-&gt;iobase1
suffix:semicolon
id|dev-&gt;irq
op_assign
id|netinfo-&gt;irq1
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: ZNET at %#3lx,&quot;
comma
id|dev-&gt;name
comma
id|dev-&gt;base_addr
)paren
suffix:semicolon
multiline_comment|/* The station address is in the &quot;netidblk&quot; at 0x0f0000. */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|6
suffix:semicolon
id|i
op_increment
)paren
id|printk
c_func
(paren
l_string|&quot; %2.2x&quot;
comma
id|dev-&gt;dev_addr
(braket
id|i
)braket
op_assign
id|netinfo-&gt;netid
(braket
id|i
)braket
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;, using IRQ %d DMA %d and %d.&bslash;n&quot;
comma
id|dev-&gt;irq
comma
id|netinfo-&gt;dma1
comma
id|netinfo-&gt;dma2
)paren
suffix:semicolon
r_if
c_cond
(paren
id|znet_debug
OG
l_int|1
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: vendor &squot;%16.16s&squot; IRQ1 %d IRQ2 %d DMA1 %d DMA2 %d.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|netinfo-&gt;vendor
comma
id|netinfo-&gt;irq1
comma
id|netinfo-&gt;irq2
comma
id|netinfo-&gt;dma1
comma
id|netinfo-&gt;dma2
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: iobase1 %#x size %d iobase2 %#x size %d net type %2.2x.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|netinfo-&gt;iobase1
comma
id|netinfo-&gt;iosize1
comma
id|netinfo-&gt;iobase2
comma
id|netinfo-&gt;iosize2
comma
id|netinfo-&gt;nettype
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|znet_debug
OG
l_int|0
)paren
id|printk
c_func
(paren
l_string|&quot;%s%s&quot;
comma
id|KERN_INFO
comma
id|version
)paren
suffix:semicolon
id|dev-&gt;priv
op_assign
(paren
r_void
op_star
)paren
op_amp
id|zn
suffix:semicolon
id|zn.rx_dma
op_assign
id|netinfo-&gt;dma1
suffix:semicolon
id|zn.tx_dma
op_assign
id|netinfo-&gt;dma2
suffix:semicolon
id|zn.lock
op_assign
id|SPIN_LOCK_UNLOCKED
suffix:semicolon
multiline_comment|/* These should never fail.  You can&squot;t add devices to a sealed box! */
r_if
c_cond
(paren
id|request_irq
c_func
(paren
id|dev-&gt;irq
comma
op_amp
id|znet_interrupt
comma
l_int|0
comma
l_string|&quot;ZNet&quot;
comma
id|dev
)paren
op_logical_or
id|request_dma
c_func
(paren
id|zn.rx_dma
comma
l_string|&quot;ZNet rx&quot;
)paren
op_logical_or
id|request_dma
c_func
(paren
id|zn.tx_dma
comma
l_string|&quot;ZNet tx&quot;
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: Not opened -- resource busy?!?&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_return
op_minus
id|EBUSY
suffix:semicolon
)brace
multiline_comment|/* Allocate buffer memory.&t;We can cross a 128K boundary, so we&n;&t;   must be careful about the allocation.  It&squot;s easiest to waste 8K. */
r_if
c_cond
(paren
id|dma_page_eq
c_func
(paren
id|dma_buffer1
comma
op_amp
id|dma_buffer1
(braket
id|RX_BUF_SIZE
op_div
l_int|2
op_minus
l_int|1
)braket
)paren
)paren
id|zn.rx_start
op_assign
id|dma_buffer1
suffix:semicolon
r_else
id|zn.rx_start
op_assign
id|dma_buffer2
suffix:semicolon
r_if
c_cond
(paren
id|dma_page_eq
c_func
(paren
id|dma_buffer3
comma
op_amp
id|dma_buffer3
(braket
id|RX_BUF_SIZE
op_div
l_int|2
op_minus
l_int|1
)braket
)paren
)paren
id|zn.tx_start
op_assign
id|dma_buffer3
suffix:semicolon
r_else
id|zn.tx_start
op_assign
id|dma_buffer2
suffix:semicolon
id|zn.rx_end
op_assign
id|zn.rx_start
op_plus
id|RX_BUF_SIZE
op_div
l_int|2
suffix:semicolon
id|zn.tx_buf_len
op_assign
id|TX_BUF_SIZE
op_div
l_int|2
suffix:semicolon
id|zn.tx_end
op_assign
id|zn.tx_start
op_plus
id|zn.tx_buf_len
suffix:semicolon
multiline_comment|/* The ZNET-specific entries in the device structure. */
id|dev-&gt;open
op_assign
op_amp
id|znet_open
suffix:semicolon
id|dev-&gt;hard_start_xmit
op_assign
op_amp
id|znet_send_packet
suffix:semicolon
id|dev-&gt;stop
op_assign
op_amp
id|znet_close
suffix:semicolon
id|dev-&gt;get_stats
op_assign
id|net_get_stats
suffix:semicolon
id|dev-&gt;set_multicast_list
op_assign
op_amp
id|set_multicast_list
suffix:semicolon
id|dev-&gt;tx_timeout
op_assign
id|znet_tx_timeout
suffix:semicolon
id|dev-&gt;watchdog_timeo
op_assign
id|TX_TIMEOUT
suffix:semicolon
multiline_comment|/* Fill in the &squot;dev&squot; with ethernet-generic values. */
id|ether_setup
c_func
(paren
id|dev
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
"&f;"
DECL|function|znet_open
r_static
r_int
id|znet_open
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_int
id|ioaddr
op_assign
id|dev-&gt;base_addr
suffix:semicolon
r_if
c_cond
(paren
id|znet_debug
OG
l_int|2
)paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%s: znet_open() called.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
multiline_comment|/* Turn on the 82501 SIA, using zenith-specific magic. */
id|outb
c_func
(paren
l_int|0x10
comma
l_int|0xe6
)paren
suffix:semicolon
multiline_comment|/* Select LAN control register */
id|outb
c_func
(paren
id|inb
c_func
(paren
l_int|0xe7
)paren
op_or
l_int|0x84
comma
l_int|0xe7
)paren
suffix:semicolon
multiline_comment|/* Turn on LAN power (bit 2). */
multiline_comment|/* According to the Crynwr driver we should wait 50 msec. for the&n;&t;   LAN clock to stabilize.  My experiments indicates that the &squot;593 can&n;&t;   be initialized immediately.  The delay is probably needed for the&n;&t;   DC-to-DC converter to come up to full voltage, and for the oscillator&n;&t;   to be spot-on at 20Mhz before transmitting.&n;&t;   Until this proves to be a problem we rely on the higher layers for the&n;&t;   delay and save allocating a timer entry. */
multiline_comment|/* This follows the packet driver&squot;s lead, and checks for success. */
r_if
c_cond
(paren
id|inb
c_func
(paren
id|ioaddr
)paren
op_ne
l_int|0x10
op_logical_and
id|inb
c_func
(paren
id|ioaddr
)paren
op_ne
l_int|0x00
)paren
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: Problem turning on the transceiver power.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|hardware_init
c_func
(paren
id|dev
)paren
suffix:semicolon
id|netif_start_queue
(paren
id|dev
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|znet_tx_timeout
r_static
r_void
id|znet_tx_timeout
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_int
id|ioaddr
op_assign
id|dev-&gt;base_addr
suffix:semicolon
id|ushort
id|event
comma
id|tx_status
comma
id|rx_offset
comma
id|state
suffix:semicolon
id|outb
(paren
id|CMD0_STAT0
comma
id|ioaddr
)paren
suffix:semicolon
id|event
op_assign
id|inb
(paren
id|ioaddr
)paren
suffix:semicolon
id|outb
(paren
id|CMD0_STAT1
comma
id|ioaddr
)paren
suffix:semicolon
id|tx_status
op_assign
id|inw
(paren
id|ioaddr
)paren
suffix:semicolon
id|outb
(paren
id|CMD0_STAT2
comma
id|ioaddr
)paren
suffix:semicolon
id|rx_offset
op_assign
id|inw
(paren
id|ioaddr
)paren
suffix:semicolon
id|outb
(paren
id|CMD0_STAT3
comma
id|ioaddr
)paren
suffix:semicolon
id|state
op_assign
id|inb
(paren
id|ioaddr
)paren
suffix:semicolon
id|printk
(paren
id|KERN_WARNING
l_string|&quot;%s: transmit timed out, status %02x %04x %04x %02x,&quot;
l_string|&quot; resetting.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|event
comma
id|tx_status
comma
id|rx_offset
comma
id|state
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tx_status
op_eq
l_int|0x0400
)paren
id|printk
(paren
id|KERN_WARNING
l_string|&quot;%s: Tx carrier error, check transceiver cable.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|outb
(paren
id|CMD0_RESET
comma
id|ioaddr
)paren
suffix:semicolon
id|hardware_init
(paren
id|dev
)paren
suffix:semicolon
id|netif_start_queue
(paren
id|dev
)paren
suffix:semicolon
)brace
DECL|function|znet_send_packet
r_static
r_int
id|znet_send_packet
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_int
id|ioaddr
op_assign
id|dev-&gt;base_addr
suffix:semicolon
r_struct
id|net_local
op_star
id|lp
op_assign
(paren
r_struct
id|net_local
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_if
c_cond
(paren
id|znet_debug
OG
l_int|4
)paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%s: ZNet_send_packet.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|netif_stop_queue
(paren
id|dev
)paren
suffix:semicolon
multiline_comment|/* Check that the part hasn&squot;t reset itself, probably from suspend. */
id|outb
c_func
(paren
id|CMD0_STAT0
comma
id|ioaddr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|inw
c_func
(paren
id|ioaddr
)paren
op_eq
l_int|0x0010
op_logical_and
id|inw
c_func
(paren
id|ioaddr
)paren
op_eq
l_int|0x0000
op_logical_and
id|inw
c_func
(paren
id|ioaddr
)paren
op_eq
l_int|0x0010
)paren
id|hardware_init
c_func
(paren
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
l_int|1
)paren
(brace
r_int
id|length
op_assign
id|ETH_ZLEN
OL
id|skb-&gt;len
ques
c_cond
id|skb-&gt;len
suffix:colon
id|ETH_ZLEN
suffix:semicolon
r_int
r_char
op_star
id|buf
op_assign
(paren
r_void
op_star
)paren
id|skb-&gt;data
suffix:semicolon
id|ushort
op_star
id|tx_link
op_assign
id|zn.tx_cur
op_minus
l_int|1
suffix:semicolon
id|ushort
id|rnd_len
op_assign
(paren
id|length
op_plus
l_int|1
)paren
op_rshift
l_int|1
suffix:semicolon
id|lp-&gt;stats.tx_bytes
op_add_assign
id|length
suffix:semicolon
(brace
r_int
id|dma_port
op_assign
(paren
(paren
id|zn.tx_dma
op_amp
l_int|3
)paren
op_lshift
l_int|2
)paren
op_plus
id|IO_DMA2_BASE
suffix:semicolon
r_int
id|addr
op_assign
id|inb
c_func
(paren
id|dma_port
)paren
suffix:semicolon
id|addr
op_or_assign
id|inb
c_func
(paren
id|dma_port
)paren
op_lshift
l_int|8
suffix:semicolon
id|addr
op_lshift_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
(paren
(paren
r_int
)paren
id|zn.tx_cur
op_amp
l_int|0x1ffff
)paren
op_ne
id|addr
)paren
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;Address mismatch at Tx: %#x vs %#x.&bslash;n&quot;
comma
(paren
r_int
)paren
id|zn.tx_cur
op_amp
l_int|0xffff
comma
id|addr
)paren
suffix:semicolon
id|zn.tx_cur
op_assign
(paren
id|ushort
op_star
)paren
(paren
(paren
(paren
r_int
)paren
id|zn.tx_cur
op_amp
l_int|0xfe0000
)paren
op_or
id|addr
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|zn.tx_cur
op_ge
id|zn.tx_end
)paren
id|zn.tx_cur
op_assign
id|zn.tx_start
suffix:semicolon
op_star
id|zn.tx_cur
op_increment
op_assign
id|length
suffix:semicolon
r_if
c_cond
(paren
id|zn.tx_cur
op_plus
id|rnd_len
op_plus
l_int|1
OG
id|zn.tx_end
)paren
(brace
r_int
id|semi_cnt
op_assign
(paren
id|zn.tx_end
op_minus
id|zn.tx_cur
)paren
op_lshift
l_int|1
suffix:semicolon
multiline_comment|/* Cvrt to byte cnt. */
id|memcpy
c_func
(paren
id|zn.tx_cur
comma
id|buf
comma
id|semi_cnt
)paren
suffix:semicolon
id|rnd_len
op_sub_assign
id|semi_cnt
op_rshift
l_int|1
suffix:semicolon
id|memcpy
c_func
(paren
id|zn.tx_start
comma
id|buf
op_plus
id|semi_cnt
comma
id|length
op_minus
id|semi_cnt
)paren
suffix:semicolon
id|zn.tx_cur
op_assign
id|zn.tx_start
op_plus
id|rnd_len
suffix:semicolon
)brace
r_else
(brace
id|memcpy
c_func
(paren
id|zn.tx_cur
comma
id|buf
comma
id|skb-&gt;len
)paren
suffix:semicolon
id|zn.tx_cur
op_add_assign
id|rnd_len
suffix:semicolon
)brace
op_star
id|zn.tx_cur
op_increment
op_assign
l_int|0
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|lp-&gt;lock
comma
id|flags
)paren
suffix:semicolon
(brace
op_star
id|tx_link
op_assign
id|CMD0_TRANSMIT
op_plus
id|CMD0_CHNL_1
suffix:semicolon
multiline_comment|/* Is this always safe to do? */
id|outb
c_func
(paren
id|CMD0_TRANSMIT
op_plus
id|CMD0_CHNL_1
comma
id|ioaddr
)paren
suffix:semicolon
)brace
id|spin_unlock_irqrestore
(paren
op_amp
id|lp-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|dev-&gt;trans_start
op_assign
id|jiffies
suffix:semicolon
id|netif_start_queue
(paren
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|znet_debug
OG
l_int|4
)paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%s: Transmitter queued, length %d.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|length
)paren
suffix:semicolon
)brace
id|dev_kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* The ZNET interrupt handler. */
DECL|function|znet_interrupt
r_static
r_void
id|znet_interrupt
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_struct
id|net_device
op_star
id|dev
op_assign
id|dev_id
suffix:semicolon
r_struct
id|net_local
op_star
id|lp
op_assign
(paren
r_struct
id|net_local
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_int
id|ioaddr
suffix:semicolon
r_int
id|boguscnt
op_assign
l_int|20
suffix:semicolon
r_if
c_cond
(paren
id|dev
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;znet_interrupt(): IRQ %d for unknown device.&bslash;n&quot;
comma
id|irq
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|spin_lock
(paren
op_amp
id|lp-&gt;lock
)paren
suffix:semicolon
id|ioaddr
op_assign
id|dev-&gt;base_addr
suffix:semicolon
id|outb
c_func
(paren
id|CMD0_STAT0
comma
id|ioaddr
)paren
suffix:semicolon
r_do
(brace
id|ushort
id|status
op_assign
id|inb
c_func
(paren
id|ioaddr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|znet_debug
OG
l_int|5
)paren
(brace
id|ushort
id|result
comma
id|rx_ptr
comma
id|running
suffix:semicolon
id|outb
c_func
(paren
id|CMD0_STAT1
comma
id|ioaddr
)paren
suffix:semicolon
id|result
op_assign
id|inw
c_func
(paren
id|ioaddr
)paren
suffix:semicolon
id|outb
c_func
(paren
id|CMD0_STAT2
comma
id|ioaddr
)paren
suffix:semicolon
id|rx_ptr
op_assign
id|inw
c_func
(paren
id|ioaddr
)paren
suffix:semicolon
id|outb
c_func
(paren
id|CMD0_STAT3
comma
id|ioaddr
)paren
suffix:semicolon
id|running
op_assign
id|inb
c_func
(paren
id|ioaddr
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%s: interrupt, status %02x, %04x %04x %02x serial %d.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|status
comma
id|result
comma
id|rx_ptr
comma
id|running
comma
id|boguscnt
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|status
op_amp
l_int|0x80
)paren
op_eq
l_int|0
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
(paren
id|status
op_amp
l_int|0x0F
)paren
op_eq
l_int|4
)paren
(brace
multiline_comment|/* Transmit done. */
r_int
id|tx_status
suffix:semicolon
id|outb
c_func
(paren
id|CMD0_STAT1
comma
id|ioaddr
)paren
suffix:semicolon
id|tx_status
op_assign
id|inw
c_func
(paren
id|ioaddr
)paren
suffix:semicolon
multiline_comment|/* It&squot;s undocumented, but tx_status seems to match the i82586. */
r_if
c_cond
(paren
id|tx_status
op_amp
l_int|0x2000
)paren
(brace
id|lp-&gt;stats.tx_packets
op_increment
suffix:semicolon
id|lp-&gt;stats.collisions
op_add_assign
id|tx_status
op_amp
l_int|0xf
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|tx_status
op_amp
l_int|0x0600
)paren
id|lp-&gt;stats.tx_carrier_errors
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|tx_status
op_amp
l_int|0x0100
)paren
id|lp-&gt;stats.tx_fifo_errors
op_increment
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|tx_status
op_amp
l_int|0x0040
)paren
)paren
id|lp-&gt;stats.tx_heartbeat_errors
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|tx_status
op_amp
l_int|0x0020
)paren
id|lp-&gt;stats.tx_aborted_errors
op_increment
suffix:semicolon
multiline_comment|/* ...and the catch-all. */
r_if
c_cond
(paren
(paren
id|tx_status
op_or
l_int|0x0760
)paren
op_ne
l_int|0x0760
)paren
id|lp-&gt;stats.tx_errors
op_increment
suffix:semicolon
)brace
id|netif_wake_queue
(paren
id|dev
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|status
op_amp
l_int|0x40
)paren
op_logical_or
(paren
id|status
op_amp
l_int|0x0f
)paren
op_eq
l_int|11
)paren
(brace
id|znet_rx
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
multiline_comment|/* Clear the interrupts we&squot;ve handled. */
id|outb
c_func
(paren
id|CMD0_ACK
comma
id|ioaddr
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
id|boguscnt
op_decrement
)paren
suffix:semicolon
id|spin_unlock
(paren
op_amp
id|lp-&gt;lock
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
DECL|function|znet_rx
r_static
r_void
id|znet_rx
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|net_local
op_star
id|lp
op_assign
(paren
r_struct
id|net_local
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_int
id|ioaddr
op_assign
id|dev-&gt;base_addr
suffix:semicolon
r_int
id|boguscount
op_assign
l_int|1
suffix:semicolon
r_int
id|next_frame_end_offset
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Offset of next frame start. */
r_int
op_star
id|cur_frame_end
suffix:semicolon
r_int
id|cur_frame_end_offset
suffix:semicolon
id|outb
c_func
(paren
id|CMD0_STAT2
comma
id|ioaddr
)paren
suffix:semicolon
id|cur_frame_end_offset
op_assign
id|inw
c_func
(paren
id|ioaddr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cur_frame_end_offset
op_eq
id|zn.rx_cur
op_minus
id|zn.rx_start
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: Interrupted, but nothing to receive, offset %03x.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|cur_frame_end_offset
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/* Use same method as the Crynwr driver: construct a forward list in&n;&t;   the same area of the backwards links we now have.  This allows us to&n;&t;   pass packets to the upper layers in the order they were received --&n;&t;   important for fast-path sequential operations. */
r_while
c_loop
(paren
id|zn.rx_start
op_plus
id|cur_frame_end_offset
op_ne
id|zn.rx_cur
op_logical_and
op_increment
id|boguscount
OL
l_int|5
)paren
(brace
r_int
r_int
id|hi_cnt
comma
id|lo_cnt
comma
id|hi_status
comma
id|lo_status
suffix:semicolon
r_int
id|count
comma
id|status
suffix:semicolon
r_if
c_cond
(paren
id|cur_frame_end_offset
OL
l_int|4
)paren
(brace
multiline_comment|/* Oh no, we have a special case: the frame trailer wraps around&n;&t;&t;&t;   the end of the ring buffer.  We&squot;ve saved space at the end of&n;&t;&t;&t;   the ring buffer for just this problem. */
id|memcpy
c_func
(paren
id|zn.rx_end
comma
id|zn.rx_start
comma
l_int|8
)paren
suffix:semicolon
id|cur_frame_end_offset
op_add_assign
(paren
id|RX_BUF_SIZE
op_div
l_int|2
)paren
suffix:semicolon
)brace
id|cur_frame_end
op_assign
id|zn.rx_start
op_plus
id|cur_frame_end_offset
op_minus
l_int|4
suffix:semicolon
id|lo_status
op_assign
op_star
id|cur_frame_end
op_increment
suffix:semicolon
id|hi_status
op_assign
op_star
id|cur_frame_end
op_increment
suffix:semicolon
id|status
op_assign
(paren
(paren
id|hi_status
op_amp
l_int|0xff
)paren
op_lshift
l_int|8
)paren
op_plus
(paren
id|lo_status
op_amp
l_int|0xff
)paren
suffix:semicolon
id|lo_cnt
op_assign
op_star
id|cur_frame_end
op_increment
suffix:semicolon
id|hi_cnt
op_assign
op_star
id|cur_frame_end
op_increment
suffix:semicolon
id|count
op_assign
(paren
(paren
id|hi_cnt
op_amp
l_int|0xff
)paren
op_lshift
l_int|8
)paren
op_plus
(paren
id|lo_cnt
op_amp
l_int|0xff
)paren
suffix:semicolon
r_if
c_cond
(paren
id|znet_debug
OG
l_int|5
)paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;Constructing trailer at location %03x, %04x %04x %04x %04x&quot;
l_string|&quot; count %#x status %04x.&bslash;n&quot;
comma
id|cur_frame_end_offset
op_lshift
l_int|1
comma
id|lo_status
comma
id|hi_status
comma
id|lo_cnt
comma
id|hi_cnt
comma
id|count
comma
id|status
)paren
suffix:semicolon
id|cur_frame_end
(braket
op_minus
l_int|4
)braket
op_assign
id|status
suffix:semicolon
id|cur_frame_end
(braket
op_minus
l_int|3
)braket
op_assign
id|next_frame_end_offset
suffix:semicolon
id|cur_frame_end
(braket
op_minus
l_int|2
)braket
op_assign
id|count
suffix:semicolon
id|next_frame_end_offset
op_assign
id|cur_frame_end_offset
suffix:semicolon
id|cur_frame_end_offset
op_sub_assign
(paren
(paren
id|count
op_plus
l_int|1
)paren
op_rshift
l_int|1
)paren
op_plus
l_int|3
suffix:semicolon
r_if
c_cond
(paren
id|cur_frame_end_offset
OL
l_int|0
)paren
id|cur_frame_end_offset
op_add_assign
id|RX_BUF_SIZE
op_div
l_int|2
suffix:semicolon
)brace
suffix:semicolon
multiline_comment|/* Now step  forward through the list. */
r_do
(brace
id|ushort
op_star
id|this_rfp_ptr
op_assign
id|zn.rx_start
op_plus
id|next_frame_end_offset
suffix:semicolon
r_int
id|status
op_assign
id|this_rfp_ptr
(braket
op_minus
l_int|4
)braket
suffix:semicolon
r_int
id|pkt_len
op_assign
id|this_rfp_ptr
(braket
op_minus
l_int|2
)braket
suffix:semicolon
r_if
c_cond
(paren
id|znet_debug
OG
l_int|5
)paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;Looking at trailer ending at %04x status %04x length %03x&quot;
l_string|&quot; next %04x.&bslash;n&quot;
comma
id|next_frame_end_offset
op_lshift
l_int|1
comma
id|status
comma
id|pkt_len
comma
id|this_rfp_ptr
(braket
op_minus
l_int|3
)braket
op_lshift
l_int|1
)paren
suffix:semicolon
multiline_comment|/* Once again we must assume that the i82586 docs apply. */
r_if
c_cond
(paren
op_logical_neg
(paren
id|status
op_amp
l_int|0x2000
)paren
)paren
(brace
multiline_comment|/* There was an error. */
id|lp-&gt;stats.rx_errors
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
l_int|0x0800
)paren
id|lp-&gt;stats.rx_crc_errors
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
l_int|0x0400
)paren
id|lp-&gt;stats.rx_frame_errors
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
l_int|0x0200
)paren
id|lp-&gt;stats.rx_over_errors
op_increment
suffix:semicolon
multiline_comment|/* Wrong. */
r_if
c_cond
(paren
id|status
op_amp
l_int|0x0100
)paren
id|lp-&gt;stats.rx_fifo_errors
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
l_int|0x0080
)paren
id|lp-&gt;stats.rx_length_errors
op_increment
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|pkt_len
OG
l_int|1536
)paren
(brace
id|lp-&gt;stats.rx_length_errors
op_increment
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* Malloc up new buffer. */
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
id|skb
op_assign
id|dev_alloc_skb
c_func
(paren
id|pkt_len
)paren
suffix:semicolon
r_if
c_cond
(paren
id|skb
op_eq
l_int|NULL
)paren
(brace
r_if
c_cond
(paren
id|znet_debug
)paren
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: Memory squeeze, dropping packet.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|lp-&gt;stats.rx_dropped
op_increment
suffix:semicolon
r_break
suffix:semicolon
)brace
id|skb-&gt;dev
op_assign
id|dev
suffix:semicolon
r_if
c_cond
(paren
op_amp
id|zn.rx_cur
(braket
(paren
id|pkt_len
op_plus
l_int|1
)paren
op_rshift
l_int|1
)braket
OG
id|zn.rx_end
)paren
(brace
r_int
id|semi_cnt
op_assign
(paren
id|zn.rx_end
op_minus
id|zn.rx_cur
)paren
op_lshift
l_int|1
suffix:semicolon
id|memcpy
c_func
(paren
id|skb_put
c_func
(paren
id|skb
comma
id|semi_cnt
)paren
comma
id|zn.rx_cur
comma
id|semi_cnt
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|skb_put
c_func
(paren
id|skb
comma
id|pkt_len
op_minus
id|semi_cnt
)paren
comma
id|zn.rx_start
comma
id|pkt_len
op_minus
id|semi_cnt
)paren
suffix:semicolon
)brace
r_else
(brace
id|memcpy
c_func
(paren
id|skb_put
c_func
(paren
id|skb
comma
id|pkt_len
)paren
comma
id|zn.rx_cur
comma
id|pkt_len
)paren
suffix:semicolon
r_if
c_cond
(paren
id|znet_debug
OG
l_int|6
)paren
(brace
r_int
r_int
op_star
id|packet
op_assign
(paren
r_int
r_int
op_star
)paren
id|skb-&gt;data
suffix:semicolon
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;Packet data is %08x %08x %08x %08x.&bslash;n&quot;
comma
id|packet
(braket
l_int|0
)braket
comma
id|packet
(braket
l_int|1
)braket
comma
id|packet
(braket
l_int|2
)braket
comma
id|packet
(braket
l_int|3
)braket
)paren
suffix:semicolon
)brace
)brace
id|skb-&gt;protocol
op_assign
id|eth_type_trans
c_func
(paren
id|skb
comma
id|dev
)paren
suffix:semicolon
id|netif_rx
c_func
(paren
id|skb
)paren
suffix:semicolon
id|lp-&gt;stats.rx_packets
op_increment
suffix:semicolon
)brace
id|zn.rx_cur
op_assign
id|this_rfp_ptr
suffix:semicolon
r_if
c_cond
(paren
id|zn.rx_cur
op_ge
id|zn.rx_end
)paren
id|zn.rx_cur
op_sub_assign
id|RX_BUF_SIZE
op_div
l_int|2
suffix:semicolon
id|update_stop_hit
c_func
(paren
id|ioaddr
comma
(paren
id|zn.rx_cur
op_minus
id|zn.rx_start
)paren
op_lshift
l_int|1
)paren
suffix:semicolon
id|next_frame_end_offset
op_assign
id|this_rfp_ptr
(braket
op_minus
l_int|3
)braket
suffix:semicolon
r_if
c_cond
(paren
id|next_frame_end_offset
op_eq
l_int|0
)paren
multiline_comment|/* Read all the frames? */
r_break
suffix:semicolon
multiline_comment|/* Done for now */
id|this_rfp_ptr
op_assign
id|zn.rx_start
op_plus
id|next_frame_end_offset
suffix:semicolon
)brace
r_while
c_loop
(paren
op_decrement
id|boguscount
)paren
suffix:semicolon
multiline_comment|/* If any worth-while packets have been received, dev_rint()&n;&t;   has done a mark_bh(INET_BH) for us and will work on them&n;&t;   when we get to the bottom-half routine. */
r_return
suffix:semicolon
)brace
multiline_comment|/* The inverse routine to znet_open(). */
DECL|function|znet_close
r_static
r_int
id|znet_close
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
r_int
id|ioaddr
op_assign
id|dev-&gt;base_addr
suffix:semicolon
id|netif_stop_queue
(paren
id|dev
)paren
suffix:semicolon
id|outb
c_func
(paren
id|CMD0_RESET
comma
id|ioaddr
)paren
suffix:semicolon
multiline_comment|/* CMD0_RESET */
id|flags
op_assign
id|claim_dma_lock
c_func
(paren
)paren
suffix:semicolon
id|disable_dma
c_func
(paren
id|zn.rx_dma
)paren
suffix:semicolon
id|disable_dma
c_func
(paren
id|zn.tx_dma
)paren
suffix:semicolon
id|release_dma_lock
c_func
(paren
id|flags
)paren
suffix:semicolon
id|free_irq
c_func
(paren
id|dev-&gt;irq
comma
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|znet_debug
OG
l_int|1
)paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%s: Shutting down ethercard.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
multiline_comment|/* Turn off transceiver power. */
id|outb
c_func
(paren
l_int|0x10
comma
l_int|0xe6
)paren
suffix:semicolon
multiline_comment|/* Select LAN control register */
id|outb
c_func
(paren
id|inb
c_func
(paren
l_int|0xe7
)paren
op_amp
op_complement
l_int|0x84
comma
l_int|0xe7
)paren
suffix:semicolon
multiline_comment|/* Turn on LAN power (bit 2). */
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Get the current statistics.&t;This may be called with the card open or&n;   closed. */
DECL|function|net_get_stats
r_static
r_struct
id|net_device_stats
op_star
id|net_get_stats
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|net_local
op_star
id|lp
op_assign
(paren
r_struct
id|net_local
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_return
op_amp
id|lp-&gt;stats
suffix:semicolon
)brace
multiline_comment|/* Set or clear the multicast filter for this adaptor.&n;   As a side effect this routine must also initialize the device parameters.&n;   This is taken advantage of in open().&n;&n;   N.B. that we change i593_init[] in place.  This (properly) makes the&n;   mode change persistent, but must be changed if this code is moved to&n;   a multiple adaptor environment.&n; */
DECL|function|set_multicast_list
r_static
r_void
id|set_multicast_list
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_int
id|ioaddr
op_assign
id|dev-&gt;base_addr
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;flags
op_amp
id|IFF_PROMISC
)paren
(brace
multiline_comment|/* Enable promiscuous mode */
id|i593_init
(braket
l_int|7
)braket
op_and_assign
op_complement
l_int|3
suffix:semicolon
id|i593_init
(braket
l_int|7
)braket
op_or_assign
l_int|1
suffix:semicolon
id|i593_init
(braket
l_int|13
)braket
op_and_assign
op_complement
l_int|8
suffix:semicolon
id|i593_init
(braket
l_int|13
)braket
op_or_assign
l_int|8
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|dev-&gt;mc_list
op_logical_or
(paren
id|dev-&gt;flags
op_amp
id|IFF_ALLMULTI
)paren
)paren
(brace
multiline_comment|/* Enable accept-all-multicast mode */
id|i593_init
(braket
l_int|7
)braket
op_and_assign
op_complement
l_int|3
suffix:semicolon
id|i593_init
(braket
l_int|7
)braket
op_or_assign
l_int|0
suffix:semicolon
id|i593_init
(braket
l_int|13
)braket
op_and_assign
op_complement
l_int|8
suffix:semicolon
id|i593_init
(braket
l_int|13
)braket
op_or_assign
l_int|8
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* Enable normal mode. */
id|i593_init
(braket
l_int|7
)braket
op_and_assign
op_complement
l_int|3
suffix:semicolon
id|i593_init
(braket
l_int|7
)braket
op_or_assign
l_int|0
suffix:semicolon
id|i593_init
(braket
l_int|13
)braket
op_and_assign
op_complement
l_int|8
suffix:semicolon
id|i593_init
(braket
l_int|13
)braket
op_or_assign
l_int|0
suffix:semicolon
)brace
op_star
id|zn.tx_cur
op_increment
op_assign
r_sizeof
(paren
id|i593_init
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|zn.tx_cur
comma
id|i593_init
comma
r_sizeof
(paren
id|i593_init
)paren
)paren
suffix:semicolon
id|zn.tx_cur
op_add_assign
r_sizeof
(paren
id|i593_init
)paren
op_div
l_int|2
suffix:semicolon
id|outb
c_func
(paren
id|CMD0_CONFIGURE
op_plus
id|CMD0_CHNL_1
comma
id|ioaddr
)paren
suffix:semicolon
macro_line|#ifdef not_tested
r_if
c_cond
(paren
id|num_addrs
OG
l_int|0
)paren
(brace
r_int
id|addrs_len
op_assign
l_int|6
op_star
id|num_addrs
suffix:semicolon
op_star
id|zn.tx_cur
op_increment
op_assign
id|addrs_len
suffix:semicolon
id|memcpy
c_func
(paren
id|zn.tx_cur
comma
id|addrs
comma
id|addrs_len
)paren
suffix:semicolon
id|outb
c_func
(paren
id|CMD0_MULTICAST_LIST
op_plus
id|CMD0_CHNL_1
comma
id|ioaddr
)paren
suffix:semicolon
id|zn.tx_cur
op_add_assign
id|addrs_len
op_rshift
l_int|1
suffix:semicolon
)brace
macro_line|#endif
)brace
DECL|function|show_dma
r_void
id|show_dma
c_func
(paren
r_void
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
r_int
id|dma_port
op_assign
(paren
(paren
id|zn.tx_dma
op_amp
l_int|3
)paren
op_lshift
l_int|2
)paren
op_plus
id|IO_DMA2_BASE
suffix:semicolon
r_int
id|addr
op_assign
id|inb
c_func
(paren
id|dma_port
)paren
suffix:semicolon
id|addr
op_or_assign
id|inb
c_func
(paren
id|dma_port
)paren
op_lshift
l_int|8
suffix:semicolon
id|flags
op_assign
id|claim_dma_lock
c_func
(paren
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;Addr: %04x cnt:%3x...&quot;
comma
id|addr
op_lshift
l_int|1
comma
id|get_dma_residue
c_func
(paren
id|zn.tx_dma
)paren
)paren
suffix:semicolon
id|release_dma_lock
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
multiline_comment|/* Initialize the hardware.  We have to do this when the board is open()ed&n;   or when we come out of suspend mode. */
DECL|function|hardware_init
r_static
r_void
id|hardware_init
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
r_int
id|ioaddr
op_assign
id|dev-&gt;base_addr
suffix:semicolon
id|zn.rx_cur
op_assign
id|zn.rx_start
suffix:semicolon
id|zn.tx_cur
op_assign
id|zn.tx_start
suffix:semicolon
multiline_comment|/* Reset the chip, and start it up. */
id|outb
c_func
(paren
id|CMD0_RESET
comma
id|ioaddr
)paren
suffix:semicolon
id|flags
op_assign
id|claim_dma_lock
c_func
(paren
)paren
suffix:semicolon
id|disable_dma
c_func
(paren
id|zn.rx_dma
)paren
suffix:semicolon
multiline_comment|/* reset by an interrupting task. */
id|clear_dma_ff
c_func
(paren
id|zn.rx_dma
)paren
suffix:semicolon
id|set_dma_mode
c_func
(paren
id|zn.rx_dma
comma
id|DMA_RX_MODE
)paren
suffix:semicolon
id|set_dma_addr
c_func
(paren
id|zn.rx_dma
comma
(paren
r_int
r_int
)paren
id|zn.rx_start
)paren
suffix:semicolon
id|set_dma_count
c_func
(paren
id|zn.rx_dma
comma
id|RX_BUF_SIZE
)paren
suffix:semicolon
id|enable_dma
c_func
(paren
id|zn.rx_dma
)paren
suffix:semicolon
multiline_comment|/* Now set up the Tx channel. */
id|disable_dma
c_func
(paren
id|zn.tx_dma
)paren
suffix:semicolon
id|clear_dma_ff
c_func
(paren
id|zn.tx_dma
)paren
suffix:semicolon
id|set_dma_mode
c_func
(paren
id|zn.tx_dma
comma
id|DMA_TX_MODE
)paren
suffix:semicolon
id|set_dma_addr
c_func
(paren
id|zn.tx_dma
comma
(paren
r_int
r_int
)paren
id|zn.tx_start
)paren
suffix:semicolon
id|set_dma_count
c_func
(paren
id|zn.tx_dma
comma
id|zn.tx_buf_len
op_lshift
l_int|1
)paren
suffix:semicolon
id|enable_dma
c_func
(paren
id|zn.tx_dma
)paren
suffix:semicolon
id|release_dma_lock
c_func
(paren
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|znet_debug
OG
l_int|1
)paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%s: Initializing the i82593, tx buf %p... &quot;
comma
id|dev-&gt;name
comma
id|zn.tx_start
)paren
suffix:semicolon
multiline_comment|/* Do an empty configure command, just like the Crynwr driver.  This&n;&t;   resets to chip to its default values. */
op_star
id|zn.tx_cur
op_increment
op_assign
l_int|0
suffix:semicolon
op_star
id|zn.tx_cur
op_increment
op_assign
l_int|0
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;stat:%02x &quot;
comma
id|inb
c_func
(paren
id|ioaddr
)paren
)paren
suffix:semicolon
id|show_dma
c_func
(paren
)paren
suffix:semicolon
id|outb
c_func
(paren
id|CMD0_CONFIGURE
op_plus
id|CMD0_CHNL_1
comma
id|ioaddr
)paren
suffix:semicolon
op_star
id|zn.tx_cur
op_increment
op_assign
r_sizeof
(paren
id|i593_init
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|zn.tx_cur
comma
id|i593_init
comma
r_sizeof
(paren
id|i593_init
)paren
)paren
suffix:semicolon
id|zn.tx_cur
op_add_assign
r_sizeof
(paren
id|i593_init
)paren
op_div
l_int|2
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;stat:%02x &quot;
comma
id|inb
c_func
(paren
id|ioaddr
)paren
)paren
suffix:semicolon
id|show_dma
c_func
(paren
)paren
suffix:semicolon
id|outb
c_func
(paren
id|CMD0_CONFIGURE
op_plus
id|CMD0_CHNL_1
comma
id|ioaddr
)paren
suffix:semicolon
op_star
id|zn.tx_cur
op_increment
op_assign
l_int|6
suffix:semicolon
id|memcpy
c_func
(paren
id|zn.tx_cur
comma
id|dev-&gt;dev_addr
comma
l_int|6
)paren
suffix:semicolon
id|zn.tx_cur
op_add_assign
l_int|3
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;stat:%02x &quot;
comma
id|inb
c_func
(paren
id|ioaddr
)paren
)paren
suffix:semicolon
id|show_dma
c_func
(paren
)paren
suffix:semicolon
id|outb
c_func
(paren
id|CMD0_IA_SETUP
op_plus
id|CMD0_CHNL_1
comma
id|ioaddr
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;stat:%02x &quot;
comma
id|inb
c_func
(paren
id|ioaddr
)paren
)paren
suffix:semicolon
id|show_dma
c_func
(paren
)paren
suffix:semicolon
id|update_stop_hit
c_func
(paren
id|ioaddr
comma
l_int|8192
)paren
suffix:semicolon
r_if
c_cond
(paren
id|znet_debug
OG
l_int|1
)paren
id|printk
c_func
(paren
l_string|&quot;enabling Rx.&bslash;n&quot;
)paren
suffix:semicolon
id|outb
c_func
(paren
id|CMD0_Rx_ENABLE
op_plus
id|CMD0_CHNL_0
comma
id|ioaddr
)paren
suffix:semicolon
id|netif_start_queue
(paren
id|dev
)paren
suffix:semicolon
)brace
DECL|function|update_stop_hit
r_static
r_void
id|update_stop_hit
c_func
(paren
r_int
id|ioaddr
comma
r_int
r_int
id|rx_stop_offset
)paren
(brace
id|outb
c_func
(paren
id|CMD0_PORT_1
comma
id|ioaddr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|znet_debug
OG
l_int|5
)paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;Updating stop hit with value %02x.&bslash;n&quot;
comma
(paren
id|rx_stop_offset
op_rshift
l_int|6
)paren
op_or
l_int|0x80
)paren
suffix:semicolon
id|outb
c_func
(paren
(paren
id|rx_stop_offset
op_rshift
l_int|6
)paren
op_or
l_int|0x80
comma
id|ioaddr
)paren
suffix:semicolon
id|outb
c_func
(paren
id|CMD1_PORT_0
comma
id|ioaddr
)paren
suffix:semicolon
)brace
"&f;"
multiline_comment|/*&n; * Local variables:&n; *  compile-command: &quot;gcc -D__KERNEL__ -I/usr/src/linux/net/inet -Wall -Wstrict-prototypes -O6 -m486 -c znet.c&quot;&n; *  version-control: t&n; *  kept-new-versions: 5&n; *  c-indent-level: 4&n; *  tab-width: 4&n; * End:&n; */
eof
