multiline_comment|/* sis900.c: A SiS 900/7016 PCI Fast Ethernet driver for Linux.&n;   Copyright 1999 Silicon Integrated System Corporation &n;   Revision:&t;1.06.03&t;Dec 23 1999&n;   &n;   Modified from the driver which is originally written by Donald Becker. &n;   &n;   This software may be used and distributed according to the terms&n;   of the GNU Public License (GPL), incorporated herein by reference.&n;   Drivers based on this skeleton fall under the GPL and must retain&n;   the authorship (implicit copyright) notice.&n;   &n;   References:&n;   SiS 7016 Fast Ethernet PCI Bus 10/100 Mbps LAN Controller with OnNow Support,&n;   preliminary Rev. 1.0 Jan. 14, 1998&n;   SiS 900 Fast Ethernet PCI Bus 10/100 Mbps LAN Single Chip with OnNow Support,&n;   preliminary Rev. 1.0 Nov. 10, 1998&n;   SiS 7014 Single Chip 100BASE-TX/10BASE-T Physical Layer Solution,&n;   preliminary Rev. 1.0 Jan. 18, 1998&n;   http://www.sis.com.tw/support/databook.htm&n;   &n;   Rev 1.06.03 Dec. 23 1999 Ollie Lho Third release&n;   Rev 1.06.02 Nov. 23 1999 Ollie Lho bug in mac probing fixed &n;   Rev 1.06.01 Nov. 16 1999 Ollie Lho CRC calculation provide by Joseph Zbiciak (im14u2c@primenet.com)&n;   Rev 1.06 Nov. 4 1999 Ollie Lho (ollie@sis.com.tw) Second release&n;   Rev 1.05.05 Oct. 29 1999 Ollie Lho (ollie@sis.com.tw) Single buffer Tx/Rx  &n;   Chin-Shan Li (lcs@sis.com.tw) Added AMD Am79c901 HomePNA PHY support&n;   Rev 1.05 Aug. 7 1999 Jim Huang (cmhuang@sis.com.tw) Initial release&n;*/
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/version.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/timer.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/ioport.h&gt;
macro_line|#include &lt;linux/malloc.h&gt;
macro_line|#include &lt;linux/interrupt.h&gt;
macro_line|#include &lt;linux/pci.h&gt;
macro_line|#include &lt;linux/netdevice.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/etherdevice.h&gt;
macro_line|#include &lt;linux/skbuff.h&gt;
macro_line|#include &lt;asm/processor.h&gt;      /* Processor type for cache alignment. */
macro_line|#include &lt;asm/bitops.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &quot;sis900.h&quot;
DECL|variable|version
r_static
r_const
r_char
op_star
id|version
op_assign
l_string|&quot;sis900.c: v1.06.03  12/23/99&bslash;n&quot;
suffix:semicolon
DECL|variable|max_interrupt_work
r_static
r_int
id|max_interrupt_work
op_assign
l_int|20
suffix:semicolon
DECL|macro|sis900_debug
mdefine_line|#define sis900_debug debug
DECL|variable|sis900_debug
r_static
r_int
id|sis900_debug
op_assign
l_int|0
suffix:semicolon
DECL|variable|multicast_filter_limit
r_static
r_int
id|multicast_filter_limit
op_assign
l_int|128
suffix:semicolon
multiline_comment|/* Time in jiffies before concluding the transmitter is hung. */
DECL|macro|TX_TIMEOUT
mdefine_line|#define TX_TIMEOUT  (4*HZ)
DECL|struct|mac_chip_info
r_struct
id|mac_chip_info
(brace
DECL|member|name
r_const
r_char
op_star
id|name
suffix:semicolon
DECL|member|vendor_id
DECL|member|device_id
DECL|member|flags
id|u16
id|vendor_id
comma
id|device_id
comma
id|flags
suffix:semicolon
DECL|member|io_size
r_int
id|io_size
suffix:semicolon
DECL|member|probe
r_struct
id|net_device
op_star
(paren
op_star
id|probe
)paren
(paren
r_struct
id|mac_chip_info
op_star
id|mac
comma
r_struct
id|pci_dev
op_star
id|pci_dev
comma
r_struct
id|net_device
op_star
id|net_dev
)paren
suffix:semicolon
)brace
suffix:semicolon
r_static
r_struct
id|net_device
op_star
id|sis900_mac_probe
(paren
r_struct
id|mac_chip_info
op_star
id|mac
comma
r_struct
id|pci_dev
op_star
id|pci_dev
comma
r_struct
id|net_device
op_star
id|net_dev
)paren
suffix:semicolon
DECL|variable|mac_chip_table
r_static
r_struct
id|mac_chip_info
id|mac_chip_table
(braket
)braket
op_assign
(brace
(brace
l_string|&quot;SiS 900 PCI Fast Ethernet&quot;
comma
id|PCI_VENDOR_ID_SI
comma
id|PCI_DEVICE_ID_SI_900
comma
id|PCI_COMMAND_IO
op_or
id|PCI_COMMAND_MASTER
comma
id|SIS900_TOTAL_SIZE
comma
id|sis900_mac_probe
)brace
comma
(brace
l_string|&quot;SiS 7016 PCI Fast Ethernet&quot;
comma
id|PCI_VENDOR_ID_SI
comma
id|PCI_DEVICE_ID_SI_7016
comma
id|PCI_COMMAND_IO
op_or
id|PCI_COMMAND_MASTER
comma
id|SIS900_TOTAL_SIZE
comma
id|sis900_mac_probe
)brace
comma
(brace
l_int|0
comma
)brace
comma
multiline_comment|/* 0 terminated list. */
)brace
suffix:semicolon
r_static
r_void
id|sis900_read_mode
c_func
(paren
r_struct
id|net_device
op_star
id|net_dev
comma
r_int
id|phy_addr
comma
r_int
op_star
id|speed
comma
r_int
op_star
id|duplex
)paren
suffix:semicolon
r_static
r_void
id|amd79c901_read_mode
c_func
(paren
r_struct
id|net_device
op_star
id|net_dev
comma
r_int
id|phy_addr
comma
r_int
op_star
id|speed
comma
r_int
op_star
id|duplex
)paren
suffix:semicolon
DECL|struct|mii_chip_info
r_static
r_struct
id|mii_chip_info
(brace
DECL|member|name
r_const
r_char
op_star
id|name
suffix:semicolon
DECL|member|phy_id0
id|u16
id|phy_id0
suffix:semicolon
DECL|member|phy_id1
id|u16
id|phy_id1
suffix:semicolon
DECL|member|read_mode
r_void
(paren
op_star
id|read_mode
)paren
(paren
r_struct
id|net_device
op_star
id|net_dev
comma
r_int
id|phy_addr
comma
r_int
op_star
id|speed
comma
r_int
op_star
id|duplex
)paren
suffix:semicolon
DECL|variable|mii_chip_table
)brace
id|mii_chip_table
(braket
)braket
op_assign
(brace
(brace
l_string|&quot;SiS 900 Internal MII PHY&quot;
comma
l_int|0x001d
comma
l_int|0x8000
comma
id|sis900_read_mode
)brace
comma
(brace
l_string|&quot;SiS 7014 Physical Layer Solution&quot;
comma
l_int|0x0016
comma
l_int|0xf830
comma
id|sis900_read_mode
)brace
comma
(brace
l_string|&quot;AMD 79C901 10BASE-T PHY&quot;
comma
l_int|0x0000
comma
l_int|0x35b9
comma
id|amd79c901_read_mode
)brace
comma
(brace
l_string|&quot;AMD 79C901 HomePNA PHY&quot;
comma
l_int|0x0000
comma
l_int|0x35c8
comma
id|amd79c901_read_mode
)brace
comma
(brace
l_int|0
comma
)brace
comma
)brace
suffix:semicolon
DECL|struct|mii_phy
r_struct
id|mii_phy
(brace
DECL|member|next
r_struct
id|mii_phy
op_star
id|next
suffix:semicolon
DECL|member|chip_info
r_struct
id|mii_chip_info
op_star
id|chip_info
suffix:semicolon
DECL|member|phy_addr
r_int
id|phy_addr
suffix:semicolon
DECL|member|status
id|u16
id|status
suffix:semicolon
)brace
suffix:semicolon
DECL|struct|_BufferDesc
r_typedef
r_struct
id|_BufferDesc
(brace
DECL|member|link
id|u32
id|link
suffix:semicolon
DECL|member|cmdsts
id|u32
id|cmdsts
suffix:semicolon
DECL|member|bufptr
id|u32
id|bufptr
suffix:semicolon
DECL|typedef|BufferDesc
)brace
id|BufferDesc
suffix:semicolon
DECL|struct|sis900_private
r_struct
id|sis900_private
(brace
DECL|member|next_module
r_struct
id|net_device
op_star
id|next_module
suffix:semicolon
DECL|member|stats
r_struct
id|net_device_stats
id|stats
suffix:semicolon
DECL|member|pci_dev
r_struct
id|pci_dev
op_star
id|pci_dev
suffix:semicolon
DECL|member|lock
id|spinlock_t
id|lock
suffix:semicolon
DECL|member|mac
r_struct
id|mac_chip_info
op_star
id|mac
suffix:semicolon
DECL|member|mii
r_struct
id|mii_phy
op_star
id|mii
suffix:semicolon
DECL|member|cur_phy
r_int
r_int
id|cur_phy
suffix:semicolon
DECL|member|timer
r_struct
id|timer_list
id|timer
suffix:semicolon
multiline_comment|/* Link status detection timer. */
DECL|member|cur_rx
DECL|member|dirty_rx
r_int
r_int
id|cur_rx
comma
id|dirty_rx
suffix:semicolon
DECL|member|cur_tx
DECL|member|dirty_tx
r_int
r_int
id|cur_tx
comma
id|dirty_tx
suffix:semicolon
multiline_comment|/* The saved address of a sent/receive-in-place packet buffer */
DECL|member|tx_skbuff
r_struct
id|sk_buff
op_star
id|tx_skbuff
(braket
id|NUM_TX_DESC
)braket
suffix:semicolon
DECL|member|rx_skbuff
r_struct
id|sk_buff
op_star
id|rx_skbuff
(braket
id|NUM_RX_DESC
)braket
suffix:semicolon
DECL|member|tx_ring
id|BufferDesc
id|tx_ring
(braket
id|NUM_TX_DESC
)braket
suffix:semicolon
DECL|member|rx_ring
id|BufferDesc
id|rx_ring
(braket
id|NUM_RX_DESC
)braket
suffix:semicolon
DECL|member|tx_full
r_int
r_int
id|tx_full
suffix:semicolon
multiline_comment|/* The Tx queue is full.    */
DECL|member|LinkOn
r_int
id|LinkOn
suffix:semicolon
)brace
suffix:semicolon
id|MODULE_AUTHOR
c_func
(paren
l_string|&quot;Jim Huang &lt;cmhuang@sis.com.tw&gt;&quot;
)paren
suffix:semicolon
id|MODULE_DESCRIPTION
c_func
(paren
l_string|&quot;SiS 900 PCI Fast Ethernet driver&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|multicast_filter_limit
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|max_interrupt_work
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|debug
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
r_static
r_int
id|sis900_open
c_func
(paren
r_struct
id|net_device
op_star
id|net_dev
)paren
suffix:semicolon
r_static
r_int
id|sis900_mii_probe
(paren
r_struct
id|net_device
op_star
id|net_dev
)paren
suffix:semicolon
r_static
r_void
id|sis900_init_rxfilter
(paren
r_struct
id|net_device
op_star
id|net_dev
)paren
suffix:semicolon
r_static
id|u16
id|read_eeprom
c_func
(paren
r_int
id|ioaddr
comma
r_int
id|location
)paren
suffix:semicolon
r_static
id|u16
id|mdio_read
c_func
(paren
r_struct
id|net_device
op_star
id|net_dev
comma
r_int
id|phy_id
comma
r_int
id|location
)paren
suffix:semicolon
r_static
r_void
id|mdio_write
c_func
(paren
r_struct
id|net_device
op_star
id|net_dev
comma
r_int
id|phy_id
comma
r_int
id|location
comma
r_int
id|val
)paren
suffix:semicolon
r_static
r_void
id|sis900_timer
c_func
(paren
r_int
r_int
id|data
)paren
suffix:semicolon
r_static
r_void
id|sis900_check_mode
(paren
r_struct
id|net_device
op_star
id|net_dev
comma
r_struct
id|mii_phy
op_star
id|mii_phy
)paren
suffix:semicolon
r_static
r_void
id|sis900_tx_timeout
c_func
(paren
r_struct
id|net_device
op_star
id|net_dev
)paren
suffix:semicolon
r_static
r_void
id|sis900_init_tx_ring
c_func
(paren
r_struct
id|net_device
op_star
id|net_dev
)paren
suffix:semicolon
r_static
r_void
id|sis900_init_rx_ring
c_func
(paren
r_struct
id|net_device
op_star
id|net_dev
)paren
suffix:semicolon
r_static
r_int
id|sis900_start_xmit
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|net_device
op_star
id|net_dev
)paren
suffix:semicolon
r_static
r_int
id|sis900_rx
c_func
(paren
r_struct
id|net_device
op_star
id|net_dev
)paren
suffix:semicolon
r_static
r_void
id|sis900_finish_xmit
(paren
r_struct
id|net_device
op_star
id|net_dev
)paren
suffix:semicolon
r_static
r_void
id|sis900_interrupt
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_instance
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
suffix:semicolon
r_static
r_int
id|sis900_close
c_func
(paren
r_struct
id|net_device
op_star
id|net_dev
)paren
suffix:semicolon
r_static
r_int
id|mii_ioctl
c_func
(paren
r_struct
id|net_device
op_star
id|net_dev
comma
r_struct
id|ifreq
op_star
id|rq
comma
r_int
id|cmd
)paren
suffix:semicolon
r_static
r_struct
id|enet_statistics
op_star
id|sis900_get_stats
c_func
(paren
r_struct
id|net_device
op_star
id|net_dev
)paren
suffix:semicolon
r_static
id|u16
id|sis900_compute_hashtable_index
c_func
(paren
id|u8
op_star
id|addr
)paren
suffix:semicolon
r_static
r_void
id|set_rx_mode
c_func
(paren
r_struct
id|net_device
op_star
id|net_dev
)paren
suffix:semicolon
r_static
r_void
id|sis900_reset
c_func
(paren
r_struct
id|net_device
op_star
id|net_dev
)paren
suffix:semicolon
multiline_comment|/* A list of all installed SiS900 devices, for removing the driver module. */
DECL|variable|root_sis900_dev
r_static
r_struct
id|net_device
op_star
id|root_sis900_dev
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/* walk through every ethernet PCI devices to see if some of them are matched with our card list*/
DECL|function|sis900_probe
r_static
r_int
id|__init
id|sis900_probe
(paren
r_void
)paren
(brace
r_int
id|found
op_assign
l_int|0
suffix:semicolon
r_struct
id|pci_dev
op_star
id|pci_dev
op_assign
l_int|NULL
suffix:semicolon
r_while
c_loop
(paren
(paren
id|pci_dev
op_assign
id|pci_find_class
(paren
id|PCI_CLASS_NETWORK_ETHERNET
op_lshift
l_int|8
comma
id|pci_dev
)paren
)paren
op_ne
l_int|NULL
)paren
(brace
multiline_comment|/* pci_dev contains all ethernet devices */
id|u32
id|pci_io_base
suffix:semicolon
r_struct
id|mac_chip_info
op_star
id|mac
suffix:semicolon
r_struct
id|net_device
op_star
id|net_dev
op_assign
l_int|NULL
suffix:semicolon
r_for
c_loop
(paren
id|mac
op_assign
id|mac_chip_table
suffix:semicolon
id|mac-&gt;vendor_id
suffix:semicolon
id|mac
op_increment
)paren
(brace
multiline_comment|/* try to match our card list */
r_if
c_cond
(paren
id|pci_dev-&gt;vendor
op_eq
id|mac-&gt;vendor_id
op_logical_and
id|pci_dev-&gt;device
op_eq
id|mac-&gt;device_id
)paren
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|mac-&gt;vendor_id
op_eq
l_int|0
)paren
multiline_comment|/* pci_dev does not match any of our cards */
r_continue
suffix:semicolon
multiline_comment|/* now, pci_dev should be either 900 or 7016 */
id|pci_io_base
op_assign
id|pci_dev-&gt;resource
(braket
l_int|0
)braket
dot
id|start
suffix:semicolon
r_if
c_cond
(paren
(paren
id|mac-&gt;flags
op_amp
id|PCI_COMMAND_IO
)paren
op_logical_and
id|check_region
c_func
(paren
id|pci_io_base
comma
id|mac-&gt;io_size
)paren
)paren
r_continue
suffix:semicolon
multiline_comment|/* setup various bits in PCI command register */
id|pci_enable_device
(paren
id|pci_dev
)paren
suffix:semicolon
id|pci_set_master
c_func
(paren
id|pci_dev
)paren
suffix:semicolon
multiline_comment|/* do the real low level jobs */
id|net_dev
op_assign
id|mac
op_member_access_from_pointer
id|probe
c_func
(paren
id|mac
comma
id|pci_dev
comma
id|net_dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|net_dev
op_ne
l_int|NULL
)paren
(brace
id|found
op_increment
suffix:semicolon
)brace
id|net_dev
op_assign
l_int|NULL
suffix:semicolon
)brace
r_return
id|found
ques
c_cond
l_int|0
suffix:colon
op_minus
id|ENODEV
suffix:semicolon
)brace
DECL|function|sis900_mac_probe
r_static
r_struct
id|net_device
op_star
id|sis900_mac_probe
(paren
r_struct
id|mac_chip_info
op_star
id|mac
comma
r_struct
id|pci_dev
op_star
id|pci_dev
comma
r_struct
id|net_device
op_star
id|net_dev
)paren
(brace
r_struct
id|sis900_private
op_star
id|sis_priv
suffix:semicolon
r_int
id|ioaddr
op_assign
id|pci_dev-&gt;resource
(braket
l_int|0
)braket
dot
id|start
suffix:semicolon
r_int
id|irq
op_assign
id|pci_dev-&gt;irq
suffix:semicolon
r_static
r_int
id|did_version
op_assign
l_int|0
suffix:semicolon
id|u16
id|signature
suffix:semicolon
r_int
id|i
suffix:semicolon
r_if
c_cond
(paren
id|did_version
op_increment
op_eq
l_int|0
)paren
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s&quot;
comma
id|version
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|net_dev
op_assign
id|init_etherdev
c_func
(paren
id|net_dev
comma
l_int|0
)paren
)paren
op_eq
l_int|NULL
)paren
r_return
l_int|NULL
suffix:semicolon
multiline_comment|/* check to see if we have sane EEPROM */
id|signature
op_assign
(paren
id|u16
)paren
id|read_eeprom
c_func
(paren
id|ioaddr
comma
id|EEPROMSignature
)paren
suffix:semicolon
r_if
c_cond
(paren
id|signature
op_eq
l_int|0xffff
op_logical_or
id|signature
op_eq
l_int|0x0000
)paren
(brace
id|printk
(paren
id|KERN_INFO
l_string|&quot;%s: Error EERPOM read %x&bslash;n&quot;
comma
id|net_dev-&gt;name
comma
id|signature
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: %s at %#lx, IRQ %d, &quot;
comma
id|net_dev-&gt;name
comma
id|mac-&gt;name
comma
id|ioaddr
comma
id|irq
)paren
suffix:semicolon
multiline_comment|/* get MAC address from EEPROM */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|3
suffix:semicolon
id|i
op_increment
)paren
(paren
(paren
id|u16
op_star
)paren
(paren
id|net_dev-&gt;dev_addr
)paren
)paren
(braket
id|i
)braket
op_assign
id|read_eeprom
c_func
(paren
id|ioaddr
comma
id|i
op_plus
id|EEPROMMACAddr
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|5
suffix:semicolon
id|i
op_increment
)paren
id|printk
c_func
(paren
l_string|&quot;%2.2x:&quot;
comma
(paren
id|u8
)paren
id|net_dev-&gt;dev_addr
(braket
id|i
)braket
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;%2.2x.&bslash;n&quot;
comma
id|net_dev-&gt;dev_addr
(braket
id|i
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|net_dev-&gt;priv
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|sis900_private
)paren
comma
id|GFP_KERNEL
)paren
)paren
op_eq
l_int|NULL
)paren
(brace
id|unregister_netdevice
c_func
(paren
id|net_dev
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
id|sis_priv
op_assign
id|net_dev-&gt;priv
suffix:semicolon
id|memset
c_func
(paren
id|sis_priv
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|sis900_private
)paren
)paren
suffix:semicolon
multiline_comment|/* We do a request_region() to register /proc/ioports info. */
id|request_region
c_func
(paren
id|ioaddr
comma
id|mac-&gt;io_size
comma
id|net_dev-&gt;name
)paren
suffix:semicolon
id|net_dev-&gt;base_addr
op_assign
id|ioaddr
suffix:semicolon
id|net_dev-&gt;irq
op_assign
id|irq
suffix:semicolon
id|sis_priv-&gt;pci_dev
op_assign
id|pci_dev
suffix:semicolon
id|sis_priv-&gt;mac
op_assign
id|mac
suffix:semicolon
id|sis_priv-&gt;lock
op_assign
id|SPIN_LOCK_UNLOCKED
suffix:semicolon
multiline_comment|/* probe for mii transciver */
r_if
c_cond
(paren
id|sis900_mii_probe
c_func
(paren
id|net_dev
)paren
op_eq
l_int|0
)paren
(brace
id|unregister_netdev
c_func
(paren
id|net_dev
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|sis_priv
)paren
suffix:semicolon
id|release_region
c_func
(paren
id|ioaddr
comma
id|mac-&gt;io_size
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
id|sis_priv-&gt;next_module
op_assign
id|root_sis900_dev
suffix:semicolon
id|root_sis900_dev
op_assign
id|net_dev
suffix:semicolon
multiline_comment|/* The SiS900-specific entries in the device structure. */
id|net_dev-&gt;open
op_assign
op_amp
id|sis900_open
suffix:semicolon
id|net_dev-&gt;hard_start_xmit
op_assign
op_amp
id|sis900_start_xmit
suffix:semicolon
id|net_dev-&gt;stop
op_assign
op_amp
id|sis900_close
suffix:semicolon
id|net_dev-&gt;get_stats
op_assign
op_amp
id|sis900_get_stats
suffix:semicolon
id|net_dev-&gt;set_multicast_list
op_assign
op_amp
id|set_rx_mode
suffix:semicolon
id|net_dev-&gt;do_ioctl
op_assign
op_amp
id|mii_ioctl
suffix:semicolon
id|net_dev-&gt;tx_timeout
op_assign
id|sis900_tx_timeout
suffix:semicolon
id|net_dev-&gt;watchdog_timeo
op_assign
id|TX_TIMEOUT
suffix:semicolon
r_return
id|net_dev
suffix:semicolon
)brace
DECL|function|sis900_mii_probe
r_static
r_int
id|sis900_mii_probe
(paren
r_struct
id|net_device
op_star
id|net_dev
)paren
(brace
r_struct
id|sis900_private
op_star
id|sis_priv
op_assign
(paren
r_struct
id|sis900_private
op_star
)paren
id|net_dev-&gt;priv
suffix:semicolon
r_int
id|phy_addr
suffix:semicolon
id|sis_priv-&gt;mii
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/* search for total of 32 possible mii phy addresses */
r_for
c_loop
(paren
id|phy_addr
op_assign
l_int|0
suffix:semicolon
id|phy_addr
OL
l_int|32
suffix:semicolon
id|phy_addr
op_increment
)paren
(brace
id|u16
id|mii_status
suffix:semicolon
id|u16
id|phy_id0
comma
id|phy_id1
suffix:semicolon
r_int
id|i
suffix:semicolon
id|mii_status
op_assign
id|mdio_read
c_func
(paren
id|net_dev
comma
id|phy_addr
comma
id|MII_STATUS
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mii_status
op_eq
l_int|0xffff
op_logical_or
id|mii_status
op_eq
l_int|0x0000
)paren
multiline_comment|/* the mii is not accessable, try next one */
r_continue
suffix:semicolon
id|phy_id0
op_assign
id|mdio_read
c_func
(paren
id|net_dev
comma
id|phy_addr
comma
id|MII_PHY_ID0
)paren
suffix:semicolon
id|phy_id1
op_assign
id|mdio_read
c_func
(paren
id|net_dev
comma
id|phy_addr
comma
id|MII_PHY_ID1
)paren
suffix:semicolon
multiline_comment|/* search our mii table for the current mii */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|mii_chip_table
(braket
id|i
)braket
dot
id|phy_id1
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
id|phy_id0
op_eq
id|mii_chip_table
(braket
id|i
)braket
dot
id|phy_id0
)paren
(brace
r_struct
id|mii_phy
op_star
id|mii_phy
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: %s transceiver found at address %d.&bslash;n&quot;
comma
id|net_dev-&gt;name
comma
id|mii_chip_table
(braket
id|i
)braket
dot
id|name
comma
id|phy_addr
)paren
suffix:semicolon
suffix:semicolon
r_if
c_cond
(paren
(paren
id|mii_phy
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|mii_phy
)paren
comma
id|GFP_KERNEL
)paren
)paren
op_ne
l_int|NULL
)paren
(brace
id|mii_phy-&gt;chip_info
op_assign
id|mii_chip_table
op_plus
id|i
suffix:semicolon
id|mii_phy-&gt;phy_addr
op_assign
id|phy_addr
suffix:semicolon
id|mii_phy-&gt;status
op_assign
id|mdio_read
c_func
(paren
id|net_dev
comma
id|phy_addr
comma
id|MII_STATUS
)paren
suffix:semicolon
id|mii_phy-&gt;next
op_assign
id|sis_priv-&gt;mii
suffix:semicolon
id|sis_priv-&gt;mii
op_assign
id|mii_phy
suffix:semicolon
)brace
multiline_comment|/* the current mii is on our mii_info_table, &n;&t;&t;&t;&t;   try next address */
r_break
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|sis_priv-&gt;mii
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: No MII transceivers found!&bslash;n&quot;
comma
id|net_dev-&gt;name
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* arbitrary choose that last PHY and current PHY */
id|sis_priv-&gt;cur_phy
op_assign
id|sis_priv-&gt;mii-&gt;phy_addr
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Using %s as default&bslash;n&quot;
comma
id|net_dev-&gt;name
comma
id|sis_priv-&gt;mii-&gt;chip_info-&gt;name
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sis_priv-&gt;mii-&gt;status
op_amp
id|MII_STAT_LINK
)paren
id|sis_priv-&gt;LinkOn
op_assign
id|TRUE
suffix:semicolon
r_else
id|sis_priv-&gt;LinkOn
op_assign
id|FALSE
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
multiline_comment|/* Delay between EEPROM clock transitions. */
DECL|macro|eeprom_delay
mdefine_line|#define eeprom_delay()  inl(ee_addr)
multiline_comment|/* Read Serial EEPROM through EEPROM Access Register, Note that location is &n;   in word (16 bits) unit */
DECL|function|read_eeprom
r_static
id|u16
id|read_eeprom
c_func
(paren
r_int
id|ioaddr
comma
r_int
id|location
)paren
(brace
r_int
id|i
suffix:semicolon
id|u16
id|retval
op_assign
l_int|0
suffix:semicolon
r_int
id|ee_addr
op_assign
id|ioaddr
op_plus
id|mear
suffix:semicolon
id|u32
id|read_cmd
op_assign
id|location
op_or
id|EEread
suffix:semicolon
id|outl
c_func
(paren
l_int|0
comma
id|ee_addr
)paren
suffix:semicolon
id|eeprom_delay
c_func
(paren
)paren
suffix:semicolon
id|outl
c_func
(paren
id|EECLK
comma
id|ee_addr
)paren
suffix:semicolon
id|eeprom_delay
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* Shift the read command (9) bits out. */
r_for
c_loop
(paren
id|i
op_assign
l_int|8
suffix:semicolon
id|i
op_ge
l_int|0
suffix:semicolon
id|i
op_decrement
)paren
(brace
id|u32
id|dataval
op_assign
(paren
id|read_cmd
op_amp
(paren
l_int|1
op_lshift
id|i
)paren
)paren
ques
c_cond
id|EEDI
op_or
id|EECS
suffix:colon
id|EECS
suffix:semicolon
id|outl
c_func
(paren
id|dataval
comma
id|ee_addr
)paren
suffix:semicolon
id|eeprom_delay
c_func
(paren
)paren
suffix:semicolon
id|outl
c_func
(paren
id|dataval
op_or
id|EECLK
comma
id|ee_addr
)paren
suffix:semicolon
id|eeprom_delay
c_func
(paren
)paren
suffix:semicolon
)brace
id|outb
c_func
(paren
id|EECS
comma
id|ee_addr
)paren
suffix:semicolon
id|eeprom_delay
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* read the 16-bits data in */
r_for
c_loop
(paren
id|i
op_assign
l_int|16
suffix:semicolon
id|i
OG
l_int|0
suffix:semicolon
id|i
op_decrement
)paren
(brace
id|outl
c_func
(paren
id|EECS
comma
id|ee_addr
)paren
suffix:semicolon
id|eeprom_delay
c_func
(paren
)paren
suffix:semicolon
id|outl
c_func
(paren
id|EECS
op_or
id|EECLK
comma
id|ee_addr
)paren
suffix:semicolon
id|eeprom_delay
c_func
(paren
)paren
suffix:semicolon
id|retval
op_assign
(paren
id|retval
op_lshift
l_int|1
)paren
op_or
(paren
(paren
id|inl
c_func
(paren
id|ee_addr
)paren
op_amp
id|EEDO
)paren
ques
c_cond
l_int|1
suffix:colon
l_int|0
)paren
suffix:semicolon
id|eeprom_delay
c_func
(paren
)paren
suffix:semicolon
)brace
multiline_comment|/* Terminate the EEPROM access. */
id|outl
c_func
(paren
l_int|0
comma
id|ee_addr
)paren
suffix:semicolon
id|eeprom_delay
c_func
(paren
)paren
suffix:semicolon
id|outl
c_func
(paren
id|EECLK
comma
id|ee_addr
)paren
suffix:semicolon
r_return
(paren
id|retval
)paren
suffix:semicolon
)brace
multiline_comment|/* Read and write the MII management registers using software-generated&n;   serial MDIO protocol. Note that the command bits and data bits are&n;   send out seperately */
DECL|macro|mdio_delay
mdefine_line|#define mdio_delay()    inl(mdio_addr)
DECL|function|mdio_idle
r_static
r_void
id|mdio_idle
c_func
(paren
r_int
id|mdio_addr
)paren
(brace
id|outl
c_func
(paren
id|MDIO
op_or
id|MDDIR
comma
id|mdio_addr
)paren
suffix:semicolon
id|mdio_delay
c_func
(paren
)paren
suffix:semicolon
id|outl
c_func
(paren
id|MDIO
op_or
id|MDDIR
op_or
id|MDC
comma
id|mdio_addr
)paren
suffix:semicolon
)brace
multiline_comment|/* Syncronize the MII management interface by shifting 32 one bits out. */
DECL|function|mdio_reset
r_static
r_void
id|mdio_reset
c_func
(paren
r_int
id|mdio_addr
)paren
(brace
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|31
suffix:semicolon
id|i
op_ge
l_int|0
suffix:semicolon
id|i
op_decrement
)paren
(brace
id|outl
c_func
(paren
id|MDDIR
op_or
id|MDIO
comma
id|mdio_addr
)paren
suffix:semicolon
id|mdio_delay
c_func
(paren
)paren
suffix:semicolon
id|outl
c_func
(paren
id|MDDIR
op_or
id|MDIO
op_or
id|MDC
comma
id|mdio_addr
)paren
suffix:semicolon
id|mdio_delay
c_func
(paren
)paren
suffix:semicolon
)brace
r_return
suffix:semicolon
)brace
DECL|function|mdio_read
r_static
id|u16
id|mdio_read
c_func
(paren
r_struct
id|net_device
op_star
id|net_dev
comma
r_int
id|phy_id
comma
r_int
id|location
)paren
(brace
r_int
id|mdio_addr
op_assign
id|net_dev-&gt;base_addr
op_plus
id|mear
suffix:semicolon
r_int
id|mii_cmd
op_assign
id|MIIread
op_or
(paren
id|phy_id
op_lshift
id|MIIpmdShift
)paren
op_or
(paren
id|location
op_lshift
id|MIIregShift
)paren
suffix:semicolon
id|u16
id|retval
op_assign
l_int|0
suffix:semicolon
r_int
id|i
suffix:semicolon
id|mdio_reset
c_func
(paren
id|mdio_addr
)paren
suffix:semicolon
id|mdio_idle
c_func
(paren
id|mdio_addr
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|15
suffix:semicolon
id|i
op_ge
l_int|0
suffix:semicolon
id|i
op_decrement
)paren
(brace
r_int
id|dataval
op_assign
(paren
id|mii_cmd
op_amp
(paren
l_int|1
op_lshift
id|i
)paren
)paren
ques
c_cond
id|MDDIR
op_or
id|MDIO
suffix:colon
id|MDDIR
suffix:semicolon
id|outl
c_func
(paren
id|dataval
comma
id|mdio_addr
)paren
suffix:semicolon
id|mdio_delay
c_func
(paren
)paren
suffix:semicolon
id|outl
c_func
(paren
id|dataval
op_or
id|MDC
comma
id|mdio_addr
)paren
suffix:semicolon
id|mdio_delay
c_func
(paren
)paren
suffix:semicolon
)brace
multiline_comment|/* Read the 16 data bits. */
r_for
c_loop
(paren
id|i
op_assign
l_int|16
suffix:semicolon
id|i
OG
l_int|0
suffix:semicolon
id|i
op_decrement
)paren
(brace
id|outl
c_func
(paren
l_int|0
comma
id|mdio_addr
)paren
suffix:semicolon
id|mdio_delay
c_func
(paren
)paren
suffix:semicolon
id|retval
op_assign
(paren
id|retval
op_lshift
l_int|1
)paren
op_or
(paren
(paren
id|inl
c_func
(paren
id|mdio_addr
)paren
op_amp
id|MDIO
)paren
ques
c_cond
l_int|1
suffix:colon
l_int|0
)paren
suffix:semicolon
id|outl
c_func
(paren
id|MDC
comma
id|mdio_addr
)paren
suffix:semicolon
id|mdio_delay
c_func
(paren
)paren
suffix:semicolon
)brace
r_return
id|retval
suffix:semicolon
)brace
DECL|function|mdio_write
r_static
r_void
id|mdio_write
c_func
(paren
r_struct
id|net_device
op_star
id|net_dev
comma
r_int
id|phy_id
comma
r_int
id|location
comma
r_int
id|value
)paren
(brace
r_int
id|mdio_addr
op_assign
id|net_dev-&gt;base_addr
op_plus
id|mear
suffix:semicolon
r_int
id|mii_cmd
op_assign
id|MIIwrite
op_or
(paren
id|phy_id
op_lshift
id|MIIpmdShift
)paren
op_or
(paren
id|location
op_lshift
id|MIIregShift
)paren
suffix:semicolon
r_int
id|i
suffix:semicolon
id|mdio_reset
c_func
(paren
id|mdio_addr
)paren
suffix:semicolon
id|mdio_idle
c_func
(paren
id|mdio_addr
)paren
suffix:semicolon
multiline_comment|/* Shift the command bits out. */
r_for
c_loop
(paren
id|i
op_assign
l_int|15
suffix:semicolon
id|i
op_ge
l_int|0
suffix:semicolon
id|i
op_decrement
)paren
(brace
r_int
id|dataval
op_assign
(paren
id|mii_cmd
op_amp
(paren
l_int|1
op_lshift
id|i
)paren
)paren
ques
c_cond
id|MDDIR
op_or
id|MDIO
suffix:colon
id|MDDIR
suffix:semicolon
id|outb
c_func
(paren
id|dataval
comma
id|mdio_addr
)paren
suffix:semicolon
id|mdio_delay
c_func
(paren
)paren
suffix:semicolon
id|outb
c_func
(paren
id|dataval
op_or
id|MDC
comma
id|mdio_addr
)paren
suffix:semicolon
id|mdio_delay
c_func
(paren
)paren
suffix:semicolon
)brace
id|mdio_delay
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* Shift the value bits out. */
r_for
c_loop
(paren
id|i
op_assign
l_int|15
suffix:semicolon
id|i
op_ge
l_int|0
suffix:semicolon
id|i
op_decrement
)paren
(brace
r_int
id|dataval
op_assign
(paren
id|value
op_amp
(paren
l_int|1
op_lshift
id|i
)paren
)paren
ques
c_cond
id|MDDIR
op_or
id|MDIO
suffix:colon
id|MDDIR
suffix:semicolon
id|outl
c_func
(paren
id|dataval
comma
id|mdio_addr
)paren
suffix:semicolon
id|mdio_delay
c_func
(paren
)paren
suffix:semicolon
id|outl
c_func
(paren
id|dataval
op_or
id|MDC
comma
id|mdio_addr
)paren
suffix:semicolon
id|mdio_delay
c_func
(paren
)paren
suffix:semicolon
)brace
id|mdio_delay
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* Clear out extra bits. */
r_for
c_loop
(paren
id|i
op_assign
l_int|2
suffix:semicolon
id|i
OG
l_int|0
suffix:semicolon
id|i
op_decrement
)paren
(brace
id|outb
c_func
(paren
l_int|0
comma
id|mdio_addr
)paren
suffix:semicolon
id|mdio_delay
c_func
(paren
)paren
suffix:semicolon
id|outb
c_func
(paren
id|MDC
comma
id|mdio_addr
)paren
suffix:semicolon
id|mdio_delay
c_func
(paren
)paren
suffix:semicolon
)brace
r_return
suffix:semicolon
)brace
r_static
r_int
DECL|function|sis900_open
id|sis900_open
c_func
(paren
r_struct
id|net_device
op_star
id|net_dev
)paren
(brace
r_struct
id|sis900_private
op_star
id|sis_priv
op_assign
(paren
r_struct
id|sis900_private
op_star
)paren
id|net_dev-&gt;priv
suffix:semicolon
r_int
id|ioaddr
op_assign
id|net_dev-&gt;base_addr
suffix:semicolon
multiline_comment|/* Soft reset the chip. */
id|sis900_reset
c_func
(paren
id|net_dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|request_irq
c_func
(paren
id|net_dev-&gt;irq
comma
op_amp
id|sis900_interrupt
comma
id|SA_SHIRQ
comma
id|net_dev-&gt;name
comma
id|net_dev
)paren
)paren
(brace
r_return
op_minus
id|EAGAIN
suffix:semicolon
)brace
id|MOD_INC_USE_COUNT
suffix:semicolon
id|sis900_init_rxfilter
c_func
(paren
id|net_dev
)paren
suffix:semicolon
id|sis900_init_tx_ring
c_func
(paren
id|net_dev
)paren
suffix:semicolon
id|sis900_init_rx_ring
c_func
(paren
id|net_dev
)paren
suffix:semicolon
id|set_rx_mode
c_func
(paren
id|net_dev
)paren
suffix:semicolon
id|netif_start_queue
c_func
(paren
id|net_dev
)paren
suffix:semicolon
multiline_comment|/* Enable all known interrupts by setting the interrupt mask. */
id|outl
c_func
(paren
(paren
id|RxSOVR
op_or
id|RxORN
op_or
id|RxERR
op_or
id|RxOK
op_or
id|TxURN
op_or
id|TxERR
op_or
id|TxIDLE
)paren
comma
id|ioaddr
op_plus
id|imr
)paren
suffix:semicolon
id|outl
c_func
(paren
id|RxENA
comma
id|ioaddr
op_plus
id|cr
)paren
suffix:semicolon
id|outl
c_func
(paren
id|IE
comma
id|ioaddr
op_plus
id|ier
)paren
suffix:semicolon
id|sis900_check_mode
c_func
(paren
id|net_dev
comma
id|sis_priv-&gt;mii
)paren
suffix:semicolon
multiline_comment|/* Set the timer to switch to check for link beat and perhaps switch&n;&t;   to an alternate media type. */
id|init_timer
c_func
(paren
op_amp
id|sis_priv-&gt;timer
)paren
suffix:semicolon
id|sis_priv-&gt;timer.expires
op_assign
id|jiffies
op_plus
id|HZ
suffix:semicolon
id|sis_priv-&gt;timer.data
op_assign
(paren
r_int
r_int
)paren
id|net_dev
suffix:semicolon
id|sis_priv-&gt;timer.function
op_assign
op_amp
id|sis900_timer
suffix:semicolon
id|add_timer
c_func
(paren
op_amp
id|sis_priv-&gt;timer
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* set receive filter address to our MAC address */
r_static
r_void
DECL|function|sis900_init_rxfilter
id|sis900_init_rxfilter
(paren
r_struct
id|net_device
op_star
id|net_dev
)paren
(brace
r_int
id|ioaddr
op_assign
id|net_dev-&gt;base_addr
suffix:semicolon
id|u32
id|rfcrSave
suffix:semicolon
id|u32
id|i
suffix:semicolon
id|rfcrSave
op_assign
id|inl
c_func
(paren
id|rfcr
op_plus
id|ioaddr
)paren
suffix:semicolon
multiline_comment|/* disable packet filtering before setting filter */
id|outl
c_func
(paren
id|rfcrSave
op_amp
op_complement
id|RFEN
comma
id|rfcr
)paren
suffix:semicolon
multiline_comment|/* load MAC addr to filter data register */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|3
suffix:semicolon
id|i
op_increment
)paren
(brace
id|u32
id|w
suffix:semicolon
id|w
op_assign
(paren
id|u32
)paren
op_star
(paren
(paren
id|u16
op_star
)paren
(paren
id|net_dev-&gt;dev_addr
)paren
op_plus
id|i
)paren
suffix:semicolon
id|outl
c_func
(paren
(paren
id|i
op_lshift
id|RFADDR_shift
)paren
comma
id|ioaddr
op_plus
id|rfcr
)paren
suffix:semicolon
id|outl
c_func
(paren
id|w
comma
id|ioaddr
op_plus
id|rfdr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sis900_debug
OG
l_int|2
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Receive Filter Addrss[%d]=%x&bslash;n&quot;
comma
id|net_dev-&gt;name
comma
id|i
comma
id|inl
c_func
(paren
id|ioaddr
op_plus
id|rfdr
)paren
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* enable packet filitering */
id|outl
c_func
(paren
id|rfcrSave
op_or
id|RFEN
comma
id|rfcr
op_plus
id|ioaddr
)paren
suffix:semicolon
)brace
multiline_comment|/* Initialize the Tx ring. */
r_static
r_void
DECL|function|sis900_init_tx_ring
id|sis900_init_tx_ring
c_func
(paren
r_struct
id|net_device
op_star
id|net_dev
)paren
(brace
r_struct
id|sis900_private
op_star
id|sis_priv
op_assign
(paren
r_struct
id|sis900_private
op_star
)paren
id|net_dev-&gt;priv
suffix:semicolon
r_int
id|ioaddr
op_assign
id|net_dev-&gt;base_addr
suffix:semicolon
r_int
id|i
suffix:semicolon
id|sis_priv-&gt;tx_full
op_assign
l_int|0
suffix:semicolon
id|sis_priv-&gt;dirty_tx
op_assign
id|sis_priv-&gt;cur_tx
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|NUM_TX_DESC
suffix:semicolon
id|i
op_increment
)paren
(brace
id|sis_priv-&gt;tx_skbuff
(braket
id|i
)braket
op_assign
l_int|NULL
suffix:semicolon
id|sis_priv-&gt;tx_ring
(braket
id|i
)braket
dot
id|link
op_assign
(paren
id|u32
)paren
id|virt_to_bus
c_func
(paren
op_amp
id|sis_priv-&gt;tx_ring
(braket
id|i
op_plus
l_int|1
)braket
)paren
suffix:semicolon
id|sis_priv-&gt;tx_ring
(braket
id|i
)braket
dot
id|cmdsts
op_assign
l_int|0
suffix:semicolon
id|sis_priv-&gt;tx_ring
(braket
id|i
)braket
dot
id|bufptr
op_assign
l_int|0
suffix:semicolon
)brace
id|sis_priv-&gt;tx_ring
(braket
id|i
op_minus
l_int|1
)braket
dot
id|link
op_assign
(paren
id|u32
)paren
id|virt_to_bus
c_func
(paren
op_amp
id|sis_priv-&gt;tx_ring
(braket
l_int|0
)braket
)paren
suffix:semicolon
multiline_comment|/* load Transmit Descriptor Register */
id|outl
c_func
(paren
id|virt_to_bus
c_func
(paren
op_amp
id|sis_priv-&gt;tx_ring
(braket
l_int|0
)braket
)paren
comma
id|ioaddr
op_plus
id|txdp
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sis900_debug
OG
l_int|2
)paren
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: TX descriptor register loaded with: %8.8x&bslash;n&quot;
comma
id|net_dev-&gt;name
comma
id|inl
c_func
(paren
id|ioaddr
op_plus
id|txdp
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/* Initialize the Rx descriptor ring, pre-allocate recevie buffers */
r_static
r_void
DECL|function|sis900_init_rx_ring
id|sis900_init_rx_ring
c_func
(paren
r_struct
id|net_device
op_star
id|net_dev
)paren
(brace
r_struct
id|sis900_private
op_star
id|sis_priv
op_assign
(paren
r_struct
id|sis900_private
op_star
)paren
id|net_dev-&gt;priv
suffix:semicolon
r_int
id|ioaddr
op_assign
id|net_dev-&gt;base_addr
suffix:semicolon
r_int
id|i
suffix:semicolon
id|sis_priv-&gt;cur_rx
op_assign
l_int|0
suffix:semicolon
id|sis_priv-&gt;dirty_rx
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* init RX descriptor */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|NUM_RX_DESC
suffix:semicolon
id|i
op_increment
)paren
(brace
id|sis_priv-&gt;rx_skbuff
(braket
id|i
)braket
op_assign
l_int|NULL
suffix:semicolon
id|sis_priv-&gt;rx_ring
(braket
id|i
)braket
dot
id|link
op_assign
(paren
id|u32
)paren
id|virt_to_bus
c_func
(paren
op_amp
id|sis_priv-&gt;rx_ring
(braket
id|i
op_plus
l_int|1
)braket
)paren
suffix:semicolon
id|sis_priv-&gt;rx_ring
(braket
id|i
)braket
dot
id|cmdsts
op_assign
l_int|0
suffix:semicolon
id|sis_priv-&gt;rx_ring
(braket
id|i
)braket
dot
id|bufptr
op_assign
l_int|0
suffix:semicolon
)brace
id|sis_priv-&gt;rx_ring
(braket
id|i
op_minus
l_int|1
)braket
dot
id|link
op_assign
(paren
id|u32
)paren
id|virt_to_bus
c_func
(paren
op_amp
id|sis_priv-&gt;rx_ring
(braket
l_int|0
)braket
)paren
suffix:semicolon
multiline_comment|/* allocate sock buffers */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|NUM_RX_DESC
suffix:semicolon
id|i
op_increment
)paren
(brace
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
r_if
c_cond
(paren
(paren
id|skb
op_assign
id|dev_alloc_skb
c_func
(paren
id|RX_BUF_SIZE
)paren
)paren
op_eq
l_int|NULL
)paren
(brace
multiline_comment|/* not enough memory for skbuff, this makes a &quot;hole&quot;&n;&t;&t;&t;   on the buffer ring, it is not clear how the &n;&t;&t;&t;   hardware will react to this kind of degenerated &n;&t;&t;&t;   buffer */
r_break
suffix:semicolon
)brace
id|skb-&gt;dev
op_assign
id|net_dev
suffix:semicolon
id|sis_priv-&gt;rx_skbuff
(braket
id|i
)braket
op_assign
id|skb
suffix:semicolon
id|sis_priv-&gt;rx_ring
(braket
id|i
)braket
dot
id|cmdsts
op_assign
id|RX_BUF_SIZE
suffix:semicolon
id|sis_priv-&gt;rx_ring
(braket
id|i
)braket
dot
id|bufptr
op_assign
id|virt_to_bus
c_func
(paren
id|skb-&gt;tail
)paren
suffix:semicolon
)brace
id|sis_priv-&gt;dirty_rx
op_assign
(paren
r_int
r_int
)paren
(paren
id|i
op_minus
id|NUM_RX_DESC
)paren
suffix:semicolon
multiline_comment|/* load Receive Descriptor Register */
id|outl
c_func
(paren
id|virt_to_bus
c_func
(paren
op_amp
id|sis_priv-&gt;rx_ring
(braket
l_int|0
)braket
)paren
comma
id|ioaddr
op_plus
id|rxdp
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sis900_debug
OG
l_int|2
)paren
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: RX descriptor register loaded with: %8.8x&bslash;n&quot;
comma
id|net_dev-&gt;name
comma
id|inl
c_func
(paren
id|ioaddr
op_plus
id|rxdp
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/* on each timer ticks we check two things, Link Status (ON/OFF) and &n;   Link Mode (10/100/Full/Half)&n; */
DECL|function|sis900_timer
r_static
r_void
id|sis900_timer
c_func
(paren
r_int
r_int
id|data
)paren
(brace
r_struct
id|net_device
op_star
id|net_dev
op_assign
(paren
r_struct
id|net_device
op_star
)paren
id|data
suffix:semicolon
r_struct
id|sis900_private
op_star
id|sis_priv
op_assign
(paren
r_struct
id|sis900_private
op_star
)paren
id|net_dev-&gt;priv
suffix:semicolon
r_struct
id|mii_phy
op_star
id|mii_phy
op_assign
id|sis_priv-&gt;mii
suffix:semicolon
r_static
r_int
id|next_tick
op_assign
l_int|5
op_star
id|HZ
suffix:semicolon
id|u16
id|status
suffix:semicolon
id|status
op_assign
id|mdio_read
c_func
(paren
id|net_dev
comma
id|sis_priv-&gt;cur_phy
comma
id|MII_STATUS
)paren
suffix:semicolon
multiline_comment|/* current mii phy is failed to link, try another one */
r_while
c_loop
(paren
op_logical_neg
(paren
id|status
op_amp
id|MII_STAT_LINK
)paren
)paren
(brace
r_if
c_cond
(paren
id|mii_phy-&gt;next
op_eq
l_int|NULL
)paren
(brace
r_if
c_cond
(paren
id|sis_priv-&gt;LinkOn
)paren
(brace
multiline_comment|/* link stat change from ON to OFF */
id|next_tick
op_assign
id|HZ
suffix:semicolon
id|sis_priv-&gt;LinkOn
op_assign
id|FALSE
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Media Link Off&bslash;n&quot;
comma
id|net_dev-&gt;name
)paren
suffix:semicolon
)brace
id|sis_priv-&gt;timer.expires
op_assign
id|jiffies
op_plus
id|next_tick
suffix:semicolon
id|add_timer
c_func
(paren
op_amp
id|sis_priv-&gt;timer
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|mii_phy
op_assign
id|mii_phy-&gt;next
suffix:semicolon
id|status
op_assign
id|mdio_read
c_func
(paren
id|net_dev
comma
id|mii_phy-&gt;phy_addr
comma
id|MII_STATUS
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|sis_priv-&gt;LinkOn
)paren
(brace
multiline_comment|/* link stat change forn OFF to ON, read and report link mode */
id|sis_priv-&gt;LinkOn
op_assign
id|TRUE
suffix:semicolon
id|next_tick
op_assign
l_int|5
op_star
id|HZ
suffix:semicolon
multiline_comment|/* change what cur_phy means */
r_if
c_cond
(paren
id|mii_phy-&gt;phy_addr
op_ne
id|sis_priv-&gt;cur_phy
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Changing transceiver to %s&bslash;n&quot;
comma
id|net_dev-&gt;name
comma
id|mii_phy-&gt;chip_info-&gt;name
)paren
suffix:semicolon
id|status
op_assign
id|mdio_read
c_func
(paren
id|net_dev
comma
id|sis_priv-&gt;cur_phy
comma
id|MII_CONTROL
)paren
suffix:semicolon
id|mdio_write
c_func
(paren
id|net_dev
comma
id|sis_priv-&gt;cur_phy
comma
id|MII_CONTROL
comma
id|status
op_or
id|MII_CNTL_ISOLATE
)paren
suffix:semicolon
id|status
op_assign
id|mdio_read
c_func
(paren
id|net_dev
comma
id|mii_phy-&gt;phy_addr
comma
id|MII_CONTROL
)paren
suffix:semicolon
id|mdio_write
c_func
(paren
id|net_dev
comma
id|mii_phy-&gt;phy_addr
comma
id|MII_CONTROL
comma
id|status
op_amp
op_complement
id|MII_CNTL_ISOLATE
)paren
suffix:semicolon
id|sis_priv-&gt;cur_phy
op_assign
id|mii_phy-&gt;phy_addr
suffix:semicolon
)brace
id|sis900_check_mode
c_func
(paren
id|net_dev
comma
id|mii_phy
)paren
suffix:semicolon
)brace
id|sis_priv-&gt;timer.expires
op_assign
id|jiffies
op_plus
id|next_tick
suffix:semicolon
id|add_timer
c_func
(paren
op_amp
id|sis_priv-&gt;timer
)paren
suffix:semicolon
)brace
DECL|function|sis900_check_mode
r_static
r_void
id|sis900_check_mode
(paren
r_struct
id|net_device
op_star
id|net_dev
comma
r_struct
id|mii_phy
op_star
id|mii_phy
)paren
(brace
r_struct
id|sis900_private
op_star
id|sis_priv
op_assign
(paren
r_struct
id|sis900_private
op_star
)paren
id|net_dev-&gt;priv
suffix:semicolon
r_int
id|ioaddr
op_assign
id|net_dev-&gt;base_addr
suffix:semicolon
r_int
id|speed
comma
id|duplex
suffix:semicolon
id|u32
id|tx_flags
op_assign
l_int|0
comma
id|rx_flags
op_assign
l_int|0
suffix:semicolon
id|mii_phy-&gt;chip_info
op_member_access_from_pointer
id|read_mode
c_func
(paren
id|net_dev
comma
id|sis_priv-&gt;cur_phy
comma
op_amp
id|speed
comma
op_amp
id|duplex
)paren
suffix:semicolon
id|tx_flags
op_assign
id|TxATP
op_or
(paren
id|TX_DMA_BURST
op_lshift
id|TxMXDMA_shift
)paren
op_or
(paren
id|TX_FILL_THRESH
op_lshift
id|TxFILLT_shift
)paren
suffix:semicolon
id|rx_flags
op_assign
id|RX_DMA_BURST
op_lshift
id|RxMXDMA_shift
suffix:semicolon
r_if
c_cond
(paren
id|speed
op_eq
id|HW_SPEED_HOME
op_logical_or
id|speed
op_eq
id|HW_SPEED_10_MBPS
)paren
(brace
id|rx_flags
op_or_assign
(paren
id|RxDRNT_10
op_lshift
id|RxDRNT_shift
)paren
suffix:semicolon
id|tx_flags
op_or_assign
(paren
id|TxDRNT_10
op_lshift
id|TxDRNT_shift
)paren
suffix:semicolon
)brace
r_else
(brace
id|rx_flags
op_or_assign
(paren
id|RxDRNT_100
op_lshift
id|RxDRNT_shift
)paren
suffix:semicolon
id|tx_flags
op_or_assign
(paren
id|TxDRNT_100
op_lshift
id|TxDRNT_shift
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|duplex
op_eq
id|FDX_CAPABLE_FULL_SELECTED
)paren
(brace
id|tx_flags
op_or_assign
(paren
id|TxCSI
op_or
id|TxHBI
)paren
suffix:semicolon
id|rx_flags
op_or_assign
id|RxATX
suffix:semicolon
)brace
id|outl
(paren
id|tx_flags
comma
id|ioaddr
op_plus
id|txcfg
)paren
suffix:semicolon
id|outl
(paren
id|rx_flags
comma
id|ioaddr
op_plus
id|rxcfg
)paren
suffix:semicolon
)brace
DECL|function|sis900_read_mode
r_static
r_void
id|sis900_read_mode
c_func
(paren
r_struct
id|net_device
op_star
id|net_dev
comma
r_int
id|phy_addr
comma
r_int
op_star
id|speed
comma
r_int
op_star
id|duplex
)paren
(brace
r_int
id|i
op_assign
l_int|0
suffix:semicolon
id|u32
id|status
suffix:semicolon
multiline_comment|/* STSOUT register is Latched on Transition, read operation updates it */
r_while
c_loop
(paren
id|i
op_increment
OL
l_int|2
)paren
id|status
op_assign
id|mdio_read
c_func
(paren
id|net_dev
comma
id|phy_addr
comma
id|MII_STSOUT
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
id|MII_STSOUT_SPD
)paren
op_star
id|speed
op_assign
id|HW_SPEED_100_MBPS
suffix:semicolon
r_else
op_star
id|speed
op_assign
id|HW_SPEED_10_MBPS
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
id|MII_STSOUT_DPLX
)paren
op_star
id|duplex
op_assign
id|FDX_CAPABLE_FULL_SELECTED
suffix:semicolon
r_else
op_star
id|duplex
op_assign
id|FDX_CAPABLE_HALF_SELECTED
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
id|MII_STSOUT_LINK_FAIL
)paren
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Media Link Off&bslash;n&quot;
comma
id|net_dev-&gt;name
)paren
suffix:semicolon
r_else
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Media Link On %s %s-duplex &bslash;n&quot;
comma
id|net_dev-&gt;name
comma
op_star
id|speed
op_eq
id|HW_SPEED_100_MBPS
ques
c_cond
l_string|&quot;100mbps&quot;
suffix:colon
l_string|&quot;10mbps&quot;
comma
op_star
id|duplex
op_eq
id|FDX_CAPABLE_FULL_SELECTED
ques
c_cond
l_string|&quot;full&quot;
suffix:colon
l_string|&quot;half&quot;
)paren
suffix:semicolon
)brace
DECL|function|amd79c901_read_mode
r_static
r_void
id|amd79c901_read_mode
c_func
(paren
r_struct
id|net_device
op_star
id|net_dev
comma
r_int
id|phy_addr
comma
r_int
op_star
id|speed
comma
r_int
op_star
id|duplex
)paren
(brace
r_int
id|i
suffix:semicolon
id|u16
id|status
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|2
suffix:semicolon
id|i
op_increment
)paren
id|status
op_assign
id|mdio_read
c_func
(paren
id|net_dev
comma
id|phy_addr
comma
id|MII_STATUS
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
id|MII_STAT_CAN_AUTO
)paren
(brace
multiline_comment|/* 10BASE-T PHY */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|2
suffix:semicolon
id|i
op_increment
)paren
id|status
op_assign
id|mdio_read
c_func
(paren
id|net_dev
comma
id|phy_addr
comma
id|MII_STATUS_SUMMARY
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
id|MII_STSSUM_SPD
)paren
op_star
id|speed
op_assign
id|HW_SPEED_100_MBPS
suffix:semicolon
r_else
op_star
id|speed
op_assign
id|HW_SPEED_10_MBPS
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
id|MII_STSSUM_DPLX
)paren
op_star
id|duplex
op_assign
id|FDX_CAPABLE_FULL_SELECTED
suffix:semicolon
r_else
op_star
id|duplex
op_assign
id|FDX_CAPABLE_HALF_SELECTED
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
id|MII_STSSUM_LINK
)paren
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Media Link On %s %s-duplex &bslash;n&quot;
comma
id|net_dev-&gt;name
comma
op_star
id|speed
op_eq
id|HW_SPEED_100_MBPS
ques
c_cond
l_string|&quot;100mbps&quot;
suffix:colon
l_string|&quot;10mbps&quot;
comma
op_star
id|duplex
op_eq
id|FDX_CAPABLE_FULL_SELECTED
ques
c_cond
l_string|&quot;full&quot;
suffix:colon
l_string|&quot;half&quot;
)paren
suffix:semicolon
r_else
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Media Link Off&bslash;n&quot;
comma
id|net_dev-&gt;name
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* HomePNA */
op_star
id|speed
op_assign
id|HW_SPEED_HOME
suffix:semicolon
op_star
id|duplex
op_assign
id|FDX_CAPABLE_HALF_SELECTED
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
id|MII_STAT_LINK
)paren
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Media Link On 1mbps half-duplex &bslash;n&quot;
comma
id|net_dev-&gt;name
)paren
suffix:semicolon
r_else
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Media Link Off&bslash;n&quot;
comma
id|net_dev-&gt;name
)paren
suffix:semicolon
)brace
)brace
DECL|function|sis900_tx_timeout
r_static
r_void
id|sis900_tx_timeout
c_func
(paren
r_struct
id|net_device
op_star
id|net_dev
)paren
(brace
r_struct
id|sis900_private
op_star
id|sis_priv
op_assign
(paren
r_struct
id|sis900_private
op_star
)paren
id|net_dev-&gt;priv
suffix:semicolon
r_int
id|ioaddr
op_assign
id|net_dev-&gt;base_addr
suffix:semicolon
r_int
id|i
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Transmit timeout, status %8.8x %8.8x &bslash;n&quot;
comma
id|net_dev-&gt;name
comma
id|inl
c_func
(paren
id|ioaddr
op_plus
id|cr
)paren
comma
id|inl
c_func
(paren
id|ioaddr
op_plus
id|isr
)paren
)paren
suffix:semicolon
multiline_comment|/* Disable interrupts by clearing the interrupt mask. */
id|outl
c_func
(paren
l_int|0x0000
comma
id|ioaddr
op_plus
id|imr
)paren
suffix:semicolon
multiline_comment|/* discard unsent packets, should this code section be protected by&n;&t;   cli(), sti() ?? */
id|sis_priv-&gt;dirty_tx
op_assign
id|sis_priv-&gt;cur_tx
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|NUM_TX_DESC
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|sis_priv-&gt;tx_skbuff
(braket
id|i
)braket
op_ne
l_int|NULL
)paren
(brace
id|dev_kfree_skb
c_func
(paren
id|sis_priv-&gt;tx_skbuff
(braket
id|i
)braket
)paren
suffix:semicolon
id|sis_priv-&gt;tx_skbuff
(braket
id|i
)braket
op_assign
l_int|0
suffix:semicolon
id|sis_priv-&gt;tx_ring
(braket
id|i
)braket
dot
id|cmdsts
op_assign
l_int|0
suffix:semicolon
id|sis_priv-&gt;tx_ring
(braket
id|i
)braket
dot
id|bufptr
op_assign
l_int|0
suffix:semicolon
id|sis_priv-&gt;stats.tx_dropped
op_increment
suffix:semicolon
)brace
)brace
id|net_dev-&gt;trans_start
op_assign
id|jiffies
suffix:semicolon
id|sis_priv-&gt;tx_full
op_assign
l_int|0
suffix:semicolon
id|netif_start_queue
c_func
(paren
id|net_dev
)paren
suffix:semicolon
multiline_comment|/* FIXME: Should we restart the transmission thread here  ?? */
multiline_comment|/* Enable all known interrupts by setting the interrupt mask. */
id|outl
c_func
(paren
(paren
id|RxSOVR
op_or
id|RxORN
op_or
id|RxERR
op_or
id|RxOK
op_or
id|TxURN
op_or
id|TxERR
op_or
id|TxIDLE
)paren
comma
id|ioaddr
op_plus
id|imr
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_static
r_int
DECL|function|sis900_start_xmit
id|sis900_start_xmit
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|net_device
op_star
id|net_dev
)paren
(brace
r_struct
id|sis900_private
op_star
id|sis_priv
op_assign
(paren
r_struct
id|sis900_private
op_star
)paren
id|net_dev-&gt;priv
suffix:semicolon
r_int
id|ioaddr
op_assign
id|net_dev-&gt;base_addr
suffix:semicolon
r_int
r_int
id|entry
suffix:semicolon
multiline_comment|/* Calculate the next Tx descriptor entry. */
id|entry
op_assign
id|sis_priv-&gt;cur_tx
op_mod
id|NUM_TX_DESC
suffix:semicolon
id|sis_priv-&gt;tx_skbuff
(braket
id|entry
)braket
op_assign
id|skb
suffix:semicolon
multiline_comment|/* set the transmit buffer descriptor and enable Transmit State Machine */
id|sis_priv-&gt;tx_ring
(braket
id|entry
)braket
dot
id|bufptr
op_assign
id|virt_to_bus
c_func
(paren
id|skb-&gt;data
)paren
suffix:semicolon
id|sis_priv-&gt;tx_ring
(braket
id|entry
)braket
dot
id|cmdsts
op_assign
(paren
id|OWN
op_or
id|skb-&gt;len
)paren
suffix:semicolon
id|outl
c_func
(paren
id|TxENA
comma
id|ioaddr
op_plus
id|cr
)paren
suffix:semicolon
r_if
c_cond
(paren
op_increment
id|sis_priv-&gt;cur_tx
op_minus
id|sis_priv-&gt;dirty_tx
OL
id|NUM_TX_DESC
)paren
(brace
multiline_comment|/* Typical path, clear tbusy to indicate more &n;&t;&t;   transmission is possible */
id|netif_start_queue
c_func
(paren
id|net_dev
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* no more transmit descriptor avaiable, tbusy remain set */
id|sis_priv-&gt;tx_full
op_assign
l_int|1
suffix:semicolon
)brace
id|net_dev-&gt;trans_start
op_assign
id|jiffies
suffix:semicolon
r_if
c_cond
(paren
id|sis900_debug
OG
l_int|3
)paren
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Queued Tx packet at %p size %d &quot;
l_string|&quot;to slot %d.&bslash;n&quot;
comma
id|net_dev-&gt;name
comma
id|skb-&gt;data
comma
(paren
r_int
)paren
id|skb-&gt;len
comma
id|entry
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* The interrupt handler does all of the Rx thread work and cleans up&n;   after the Tx thread. */
DECL|function|sis900_interrupt
r_static
r_void
id|sis900_interrupt
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_instance
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_struct
id|net_device
op_star
id|net_dev
op_assign
(paren
r_struct
id|net_device
op_star
)paren
id|dev_instance
suffix:semicolon
r_struct
id|sis900_private
op_star
id|sis_priv
op_assign
(paren
r_struct
id|sis900_private
op_star
)paren
id|net_dev-&gt;priv
suffix:semicolon
r_int
id|boguscnt
op_assign
id|max_interrupt_work
suffix:semicolon
r_int
id|ioaddr
op_assign
id|net_dev-&gt;base_addr
suffix:semicolon
id|u32
id|status
suffix:semicolon
id|spin_lock
(paren
op_amp
id|sis_priv-&gt;lock
)paren
suffix:semicolon
r_do
(brace
id|status
op_assign
id|inl
c_func
(paren
id|ioaddr
op_plus
id|isr
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|status
op_amp
(paren
id|HIBERR
op_or
id|TxURN
op_or
id|TxERR
op_or
id|TxIDLE
op_or
id|RxORN
op_or
id|RxERR
op_or
id|RxOK
)paren
)paren
op_eq
l_int|0
)paren
multiline_comment|/* nothing intresting happened */
r_break
suffix:semicolon
multiline_comment|/* why dow&squot;t we break after Tx/Rx case ?? keyword: full-duplex */
r_if
c_cond
(paren
id|status
op_amp
(paren
id|RxORN
op_or
id|RxERR
op_or
id|RxOK
)paren
)paren
multiline_comment|/* Rx interrupt */
id|sis900_rx
c_func
(paren
id|net_dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
(paren
id|TxURN
op_or
id|TxERR
op_or
id|TxIDLE
)paren
)paren
multiline_comment|/* Tx interrupt */
id|sis900_finish_xmit
c_func
(paren
id|net_dev
)paren
suffix:semicolon
multiline_comment|/* something strange happened !!! */
r_if
c_cond
(paren
id|status
op_amp
id|HIBERR
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Abnormal interrupt,&quot;
l_string|&quot;status %#8.8x.&bslash;n&quot;
comma
id|net_dev-&gt;name
comma
id|status
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
op_decrement
id|boguscnt
OL
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Too much work at interrupt, &quot;
l_string|&quot;interrupt status = %#8.8x.&bslash;n&quot;
comma
id|net_dev-&gt;name
comma
id|status
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
r_while
c_loop
(paren
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sis900_debug
OG
l_int|3
)paren
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: exiting interrupt, &quot;
l_string|&quot;interrupt status = 0x%#8.8x.&bslash;n&quot;
comma
id|net_dev-&gt;name
comma
id|inl
c_func
(paren
id|ioaddr
op_plus
id|isr
)paren
)paren
suffix:semicolon
id|spin_unlock
(paren
op_amp
id|sis_priv-&gt;lock
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/* Process receive interrupt events, put buffer to higher layer and refill buffer pool &n;   Note: This fucntion is called by interrupt handler, don&squot;t do &quot;too much&quot; work here */
DECL|function|sis900_rx
r_static
r_int
id|sis900_rx
c_func
(paren
r_struct
id|net_device
op_star
id|net_dev
)paren
(brace
r_struct
id|sis900_private
op_star
id|sis_priv
op_assign
(paren
r_struct
id|sis900_private
op_star
)paren
id|net_dev-&gt;priv
suffix:semicolon
r_int
id|ioaddr
op_assign
id|net_dev-&gt;base_addr
suffix:semicolon
r_int
r_int
id|entry
op_assign
id|sis_priv-&gt;cur_rx
op_mod
id|NUM_RX_DESC
suffix:semicolon
id|u32
id|rx_status
op_assign
id|sis_priv-&gt;rx_ring
(braket
id|entry
)braket
dot
id|cmdsts
suffix:semicolon
r_if
c_cond
(paren
id|sis900_debug
OG
l_int|3
)paren
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;sis900_rx, cur_rx:%4.4d, dirty_rx:%4.4d &quot;
l_string|&quot;status:0x%8.8x&bslash;n&quot;
comma
id|sis_priv-&gt;cur_rx
comma
id|sis_priv-&gt;dirty_rx
comma
id|rx_status
)paren
suffix:semicolon
r_while
c_loop
(paren
id|rx_status
op_amp
id|OWN
)paren
(brace
r_int
r_int
id|rx_size
suffix:semicolon
id|rx_size
op_assign
(paren
id|rx_status
op_amp
id|DSIZE
)paren
op_minus
id|CRC_SIZE
suffix:semicolon
r_if
c_cond
(paren
id|rx_status
op_amp
(paren
id|ABORT
op_or
id|OVERRUN
op_or
id|TOOLONG
op_or
id|RUNT
op_or
id|RXISERR
op_or
id|CRCERR
op_or
id|FAERR
)paren
)paren
(brace
multiline_comment|/* corrupted packet received */
r_if
c_cond
(paren
id|sis900_debug
OG
l_int|3
)paren
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Corrupted packet &quot;
l_string|&quot;received, buffer status = 0x%8.8x.&bslash;n&quot;
comma
id|net_dev-&gt;name
comma
id|rx_status
)paren
suffix:semicolon
id|sis_priv-&gt;stats.rx_errors
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|rx_status
op_amp
id|OVERRUN
)paren
id|sis_priv-&gt;stats.rx_over_errors
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|rx_status
op_amp
(paren
id|TOOLONG
op_or
id|RUNT
)paren
)paren
id|sis_priv-&gt;stats.rx_length_errors
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|rx_status
op_amp
(paren
id|RXISERR
op_or
id|FAERR
)paren
)paren
id|sis_priv-&gt;stats.rx_frame_errors
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|rx_status
op_amp
id|CRCERR
)paren
id|sis_priv-&gt;stats.rx_crc_errors
op_increment
suffix:semicolon
multiline_comment|/* reset buffer descriptor state */
id|sis_priv-&gt;rx_ring
(braket
id|entry
)braket
dot
id|cmdsts
op_assign
id|RX_BUF_SIZE
suffix:semicolon
)brace
r_else
(brace
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
multiline_comment|/* This situation should never happen, but due to&n;&t;&t;&t;   some unknow bugs, it is possible that&n;&t;&t;&t;   we are working on NULL sk_buff :-( */
r_if
c_cond
(paren
id|sis_priv-&gt;rx_skbuff
(braket
id|entry
)braket
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: NULL pointer &quot;
l_string|&quot;encountered in Rx ring, skipping&bslash;n&quot;
comma
id|net_dev-&gt;name
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|skb
op_assign
id|sis_priv-&gt;rx_skbuff
(braket
id|entry
)braket
suffix:semicolon
id|sis_priv-&gt;rx_skbuff
(braket
id|entry
)braket
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/* reset buffer descriptor state */
id|sis_priv-&gt;rx_ring
(braket
id|entry
)braket
dot
id|cmdsts
op_assign
l_int|0
suffix:semicolon
id|sis_priv-&gt;rx_ring
(braket
id|entry
)braket
dot
id|bufptr
op_assign
l_int|0
suffix:semicolon
id|skb_put
c_func
(paren
id|skb
comma
id|rx_size
)paren
suffix:semicolon
id|skb-&gt;protocol
op_assign
id|eth_type_trans
c_func
(paren
id|skb
comma
id|net_dev
)paren
suffix:semicolon
id|netif_rx
c_func
(paren
id|skb
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|rx_status
op_amp
id|BCAST
)paren
op_eq
id|MCAST
)paren
id|sis_priv-&gt;stats.multicast
op_increment
suffix:semicolon
id|net_dev-&gt;last_rx
op_assign
id|jiffies
suffix:semicolon
id|sis_priv-&gt;stats.rx_bytes
op_add_assign
id|rx_size
suffix:semicolon
id|sis_priv-&gt;stats.rx_packets
op_increment
suffix:semicolon
)brace
id|sis_priv-&gt;cur_rx
op_increment
suffix:semicolon
id|entry
op_assign
id|sis_priv-&gt;cur_rx
op_mod
id|NUM_RX_DESC
suffix:semicolon
id|rx_status
op_assign
id|sis_priv-&gt;rx_ring
(braket
id|entry
)braket
dot
id|cmdsts
suffix:semicolon
)brace
singleline_comment|// while
multiline_comment|/* refill the Rx buffer, what if the rate of refilling is slower than &n;&t;   consuming ?? */
r_for
c_loop
(paren
suffix:semicolon
id|sis_priv-&gt;cur_rx
op_minus
id|sis_priv-&gt;dirty_rx
OG
l_int|0
suffix:semicolon
id|sis_priv-&gt;dirty_rx
op_increment
)paren
(brace
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
id|entry
op_assign
id|sis_priv-&gt;dirty_rx
op_mod
id|NUM_RX_DESC
suffix:semicolon
r_if
c_cond
(paren
id|sis_priv-&gt;rx_skbuff
(braket
id|entry
)braket
op_eq
l_int|NULL
)paren
(brace
r_if
c_cond
(paren
(paren
id|skb
op_assign
id|dev_alloc_skb
c_func
(paren
id|RX_BUF_SIZE
)paren
)paren
op_eq
l_int|NULL
)paren
(brace
multiline_comment|/* not enough memory for skbuff, this makes a &quot;hole&quot;&n;&t;&t;&t;&t;   on the buffer ring, it is not clear how the &n;&t;&t;&t;&t;   hardware will react to this kind of degenerated &n;&t;&t;&t;&t;   buffer */
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Memory squeeze,&quot;
l_string|&quot;deferring packet.&bslash;n&quot;
comma
id|net_dev-&gt;name
)paren
suffix:semicolon
id|sis_priv-&gt;stats.rx_dropped
op_increment
suffix:semicolon
r_break
suffix:semicolon
)brace
id|skb-&gt;dev
op_assign
id|net_dev
suffix:semicolon
id|sis_priv-&gt;rx_skbuff
(braket
id|entry
)braket
op_assign
id|skb
suffix:semicolon
id|sis_priv-&gt;rx_ring
(braket
id|entry
)braket
dot
id|cmdsts
op_assign
id|RX_BUF_SIZE
suffix:semicolon
id|sis_priv-&gt;rx_ring
(braket
id|entry
)braket
dot
id|bufptr
op_assign
id|virt_to_bus
c_func
(paren
id|skb-&gt;tail
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* re-enable the potentially idle receive state matchine */
id|outl
c_func
(paren
id|RxENA
comma
id|ioaddr
op_plus
id|cr
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* finish up transmission of packets, check for error condition and free skbuff etc.&n;   Note: This fucntion is called by interrupt handler, don&squot;t do &quot;too much&quot; work here */
DECL|function|sis900_finish_xmit
r_static
r_void
id|sis900_finish_xmit
(paren
r_struct
id|net_device
op_star
id|net_dev
)paren
(brace
r_struct
id|sis900_private
op_star
id|sis_priv
op_assign
(paren
r_struct
id|sis900_private
op_star
)paren
id|net_dev-&gt;priv
suffix:semicolon
r_for
c_loop
(paren
suffix:semicolon
id|sis_priv-&gt;dirty_tx
OL
id|sis_priv-&gt;cur_tx
suffix:semicolon
id|sis_priv-&gt;dirty_tx
op_increment
)paren
(brace
r_int
r_int
id|entry
suffix:semicolon
id|u32
id|tx_status
suffix:semicolon
id|entry
op_assign
id|sis_priv-&gt;dirty_tx
op_mod
id|NUM_TX_DESC
suffix:semicolon
id|tx_status
op_assign
id|sis_priv-&gt;tx_ring
(braket
id|entry
)braket
dot
id|cmdsts
suffix:semicolon
r_if
c_cond
(paren
id|tx_status
op_amp
id|OWN
)paren
(brace
multiline_comment|/* The packet is not transmited yet (owned by hardware) !&n;&t;&t;&t;   Note: the interrupt is generated only when Tx Machine&n;&t;&t;&t;   is idle, so this is an almost impossible case */
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|tx_status
op_amp
(paren
id|ABORT
op_or
id|UNDERRUN
op_or
id|OWCOLL
)paren
)paren
(brace
multiline_comment|/* packet unsuccessfully transmited */
r_if
c_cond
(paren
id|sis900_debug
OG
l_int|3
)paren
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Transmit &quot;
l_string|&quot;error, Tx status %8.8x.&bslash;n&quot;
comma
id|net_dev-&gt;name
comma
id|tx_status
)paren
suffix:semicolon
id|sis_priv-&gt;stats.tx_errors
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|tx_status
op_amp
id|UNDERRUN
)paren
id|sis_priv-&gt;stats.tx_fifo_errors
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|tx_status
op_amp
id|ABORT
)paren
id|sis_priv-&gt;stats.tx_aborted_errors
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|tx_status
op_amp
id|NOCARRIER
)paren
id|sis_priv-&gt;stats.tx_carrier_errors
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|tx_status
op_amp
id|OWCOLL
)paren
id|sis_priv-&gt;stats.tx_window_errors
op_increment
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* packet successfully transmited */
id|sis_priv-&gt;stats.collisions
op_add_assign
(paren
id|tx_status
op_amp
id|COLCNT
)paren
op_rshift
l_int|16
suffix:semicolon
id|sis_priv-&gt;stats.tx_bytes
op_add_assign
id|tx_status
op_amp
id|DSIZE
suffix:semicolon
id|sis_priv-&gt;stats.tx_packets
op_increment
suffix:semicolon
)brace
multiline_comment|/* Free the original skb. */
id|dev_kfree_skb
c_func
(paren
id|sis_priv-&gt;tx_skbuff
(braket
id|entry
)braket
)paren
suffix:semicolon
id|sis_priv-&gt;tx_skbuff
(braket
id|entry
)braket
op_assign
l_int|NULL
suffix:semicolon
id|sis_priv-&gt;tx_ring
(braket
id|entry
)braket
dot
id|bufptr
op_assign
l_int|0
suffix:semicolon
id|sis_priv-&gt;tx_ring
(braket
id|entry
)braket
dot
id|cmdsts
op_assign
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|sis_priv-&gt;tx_full
op_logical_and
id|test_bit
c_func
(paren
id|LINK_STATE_XOFF
comma
op_amp
id|net_dev-&gt;flags
)paren
op_logical_and
id|sis_priv-&gt;cur_tx
op_minus
id|sis_priv-&gt;dirty_tx
OL
id|NUM_TX_DESC
op_minus
l_int|4
)paren
(brace
multiline_comment|/* The ring is no longer full, clear tbusy, tx_full and&n;&t;&t;   schedule more transmission by marking NET_BH */
id|sis_priv-&gt;tx_full
op_assign
l_int|0
suffix:semicolon
id|netif_wake_queue
(paren
id|net_dev
)paren
suffix:semicolon
)brace
)brace
r_static
r_int
DECL|function|sis900_close
id|sis900_close
c_func
(paren
r_struct
id|net_device
op_star
id|net_dev
)paren
(brace
r_int
id|ioaddr
op_assign
id|net_dev-&gt;base_addr
suffix:semicolon
r_struct
id|sis900_private
op_star
id|sis_priv
op_assign
(paren
r_struct
id|sis900_private
op_star
)paren
id|net_dev-&gt;priv
suffix:semicolon
r_int
id|i
suffix:semicolon
id|netif_stop_queue
c_func
(paren
id|net_dev
)paren
suffix:semicolon
multiline_comment|/* Disable interrupts by clearing the interrupt mask. */
id|outl
c_func
(paren
l_int|0x0000
comma
id|ioaddr
op_plus
id|imr
)paren
suffix:semicolon
id|outl
c_func
(paren
l_int|0x0000
comma
id|ioaddr
op_plus
id|ier
)paren
suffix:semicolon
multiline_comment|/* Stop the chip&squot;s Tx and Rx Status Machine */
id|outl
c_func
(paren
id|RxDIS
op_or
id|TxDIS
comma
id|ioaddr
op_plus
id|cr
)paren
suffix:semicolon
id|del_timer
c_func
(paren
op_amp
id|sis_priv-&gt;timer
)paren
suffix:semicolon
id|free_irq
c_func
(paren
id|net_dev-&gt;irq
comma
id|net_dev
)paren
suffix:semicolon
multiline_comment|/* Free Tx and RX skbuff */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|NUM_RX_DESC
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|sis_priv-&gt;rx_skbuff
(braket
id|i
)braket
op_ne
l_int|NULL
)paren
id|dev_kfree_skb
c_func
(paren
id|sis_priv-&gt;rx_skbuff
(braket
id|i
)braket
)paren
suffix:semicolon
id|sis_priv-&gt;rx_skbuff
(braket
id|i
)braket
op_assign
l_int|0
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|NUM_TX_DESC
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|sis_priv-&gt;tx_skbuff
(braket
id|i
)braket
op_ne
l_int|NULL
)paren
id|dev_kfree_skb
c_func
(paren
id|sis_priv-&gt;tx_skbuff
(braket
id|i
)braket
)paren
suffix:semicolon
id|sis_priv-&gt;tx_skbuff
(braket
id|i
)braket
op_assign
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Green! Put the chip in low-power mode. */
id|MOD_DEC_USE_COUNT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|mii_ioctl
r_static
r_int
id|mii_ioctl
c_func
(paren
r_struct
id|net_device
op_star
id|net_dev
comma
r_struct
id|ifreq
op_star
id|rq
comma
r_int
id|cmd
)paren
(brace
r_struct
id|sis900_private
op_star
id|sis_priv
op_assign
(paren
r_struct
id|sis900_private
op_star
)paren
id|net_dev-&gt;priv
suffix:semicolon
id|u16
op_star
id|data
op_assign
(paren
id|u16
op_star
)paren
op_amp
id|rq-&gt;ifr_data
suffix:semicolon
r_switch
c_cond
(paren
id|cmd
)paren
(brace
r_case
id|SIOCDEVPRIVATE
suffix:colon
multiline_comment|/* Get the address of the PHY in use. */
id|data
(braket
l_int|0
)braket
op_assign
id|sis_priv-&gt;mii-&gt;phy_addr
suffix:semicolon
multiline_comment|/* Fall Through */
r_case
id|SIOCDEVPRIVATE
op_plus
l_int|1
suffix:colon
multiline_comment|/* Read the specified MII register. */
id|data
(braket
l_int|3
)braket
op_assign
id|mdio_read
c_func
(paren
id|net_dev
comma
id|data
(braket
l_int|0
)braket
op_amp
l_int|0x1f
comma
id|data
(braket
l_int|1
)braket
op_amp
l_int|0x1f
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
r_case
id|SIOCDEVPRIVATE
op_plus
l_int|2
suffix:colon
multiline_comment|/* Write the specified MII register */
r_if
c_cond
(paren
op_logical_neg
id|suser
c_func
(paren
)paren
)paren
r_return
op_minus
id|EPERM
suffix:semicolon
id|mdio_write
c_func
(paren
id|net_dev
comma
id|data
(braket
l_int|0
)braket
op_amp
l_int|0x1f
comma
id|data
(braket
l_int|1
)braket
op_amp
l_int|0x1f
comma
id|data
(braket
l_int|2
)braket
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
r_default
suffix:colon
r_return
op_minus
id|EOPNOTSUPP
suffix:semicolon
)brace
)brace
r_static
r_struct
id|enet_statistics
op_star
DECL|function|sis900_get_stats
id|sis900_get_stats
c_func
(paren
r_struct
id|net_device
op_star
id|net_dev
)paren
(brace
r_struct
id|sis900_private
op_star
id|sis_priv
op_assign
(paren
r_struct
id|sis900_private
op_star
)paren
id|net_dev-&gt;priv
suffix:semicolon
r_return
op_amp
id|sis_priv-&gt;stats
suffix:semicolon
)brace
multiline_comment|/* SiS 900 uses the most sigificant 7 bits to index a 128 bits multicast hash table, which makes&n;   this function a little bit different from other drivers */
DECL|function|sis900_compute_hashtable_index
r_static
id|u16
id|sis900_compute_hashtable_index
c_func
(paren
id|u8
op_star
id|addr
)paren
(brace
multiline_comment|/* what is the correct value of the POLYNOMIAL ??&n;   Donald Becker use 0x04C11DB7U&n;   Joseph Zbiciak im14u2c@primenet.com gives me the&n;   correct answer, thank you Joe !! */
DECL|macro|POLYNOMIAL
mdefine_line|#define POLYNOMIAL 0x04C11DB7L
id|u32
id|crc
op_assign
l_int|0xffffffff
comma
id|msb
suffix:semicolon
r_int
id|i
comma
id|j
suffix:semicolon
id|u32
id|byte
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|6
suffix:semicolon
id|i
op_increment
)paren
(brace
id|byte
op_assign
op_star
id|addr
op_increment
suffix:semicolon
r_for
c_loop
(paren
id|j
op_assign
l_int|0
suffix:semicolon
id|j
OL
l_int|8
suffix:semicolon
id|j
op_increment
)paren
(brace
id|msb
op_assign
id|crc
op_rshift
l_int|31
suffix:semicolon
id|crc
op_lshift_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|msb
op_xor
(paren
id|byte
op_amp
l_int|1
)paren
)paren
(brace
id|crc
op_xor_assign
id|POLYNOMIAL
suffix:semicolon
)brace
id|byte
op_rshift_assign
l_int|1
suffix:semicolon
)brace
)brace
multiline_comment|/* leave 7 most siginifant bits */
r_return
(paren
(paren
r_int
)paren
(paren
id|crc
op_rshift
l_int|25
)paren
)paren
suffix:semicolon
)brace
DECL|function|set_rx_mode
r_static
r_void
id|set_rx_mode
c_func
(paren
r_struct
id|net_device
op_star
id|net_dev
)paren
(brace
r_int
id|ioaddr
op_assign
id|net_dev-&gt;base_addr
suffix:semicolon
id|u16
id|mc_filter
(braket
l_int|8
)braket
suffix:semicolon
multiline_comment|/* 128 bits multicast hash table */
r_int
id|i
suffix:semicolon
id|u32
id|rx_mode
suffix:semicolon
r_if
c_cond
(paren
id|net_dev-&gt;flags
op_amp
id|IFF_PROMISC
)paren
(brace
multiline_comment|/* Accept any kinds of packets */
id|rx_mode
op_assign
id|RFPromiscuous
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|8
suffix:semicolon
id|i
op_increment
)paren
id|mc_filter
(braket
id|i
)braket
op_assign
l_int|0xffff
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
(paren
id|net_dev-&gt;mc_count
OG
id|multicast_filter_limit
)paren
op_logical_or
(paren
id|net_dev-&gt;flags
op_amp
id|IFF_ALLMULTI
)paren
)paren
(brace
multiline_comment|/* too many multicast addresses or accept all multicast packet */
id|rx_mode
op_assign
id|RFAAB
op_or
id|RFAAM
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|8
suffix:semicolon
id|i
op_increment
)paren
id|mc_filter
(braket
id|i
)braket
op_assign
l_int|0xffff
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* Accept Broadcast packet, destination address matchs our MAC address,&n;&t;&t;   use Receive Filter to reject unwanted MCAST packet */
r_struct
id|dev_mc_list
op_star
id|mclist
suffix:semicolon
id|rx_mode
op_assign
id|RFAAB
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|8
suffix:semicolon
id|i
op_increment
)paren
id|mc_filter
(braket
id|i
)braket
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
comma
id|mclist
op_assign
id|net_dev-&gt;mc_list
suffix:semicolon
id|mclist
op_logical_and
id|i
OL
id|net_dev-&gt;mc_count
suffix:semicolon
id|i
op_increment
comma
id|mclist
op_assign
id|mclist-&gt;next
)paren
id|set_bit
c_func
(paren
id|sis900_compute_hashtable_index
c_func
(paren
id|mclist-&gt;dmi_addr
)paren
comma
id|mc_filter
)paren
suffix:semicolon
)brace
multiline_comment|/* update Multicast Hash Table in Receive Filter */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|8
suffix:semicolon
id|i
op_increment
)paren
(brace
multiline_comment|/* why plus 0x04 ??, That makes the correct value for hash table. */
id|outl
c_func
(paren
(paren
id|u32
)paren
(paren
l_int|0x00000004
op_plus
id|i
)paren
op_lshift
id|RFADDR_shift
comma
id|ioaddr
op_plus
id|rfcr
)paren
suffix:semicolon
id|outl
c_func
(paren
id|mc_filter
(braket
id|i
)braket
comma
id|ioaddr
op_plus
id|rfdr
)paren
suffix:semicolon
)brace
id|outl
c_func
(paren
id|RFEN
op_or
id|rx_mode
comma
id|ioaddr
op_plus
id|rfcr
)paren
suffix:semicolon
multiline_comment|/* sis900 is capatable of looping back packet at MAC level for debugging purpose */
r_if
c_cond
(paren
id|net_dev-&gt;flags
op_amp
id|IFF_LOOPBACK
)paren
(brace
id|u32
id|cr_saved
suffix:semicolon
multiline_comment|/* We must disable Tx/Rx before setting loopback mode */
id|cr_saved
op_assign
id|inl
c_func
(paren
id|ioaddr
op_plus
id|cr
)paren
suffix:semicolon
id|outl
c_func
(paren
id|cr_saved
op_or
id|TxDIS
op_or
id|RxDIS
comma
id|ioaddr
op_plus
id|cr
)paren
suffix:semicolon
multiline_comment|/* enable loopback */
id|outl
c_func
(paren
id|inl
c_func
(paren
id|ioaddr
op_plus
id|txcfg
)paren
op_or
id|TxMLB
comma
id|ioaddr
op_plus
id|txcfg
)paren
suffix:semicolon
id|outl
c_func
(paren
id|inl
c_func
(paren
id|ioaddr
op_plus
id|rxcfg
)paren
op_or
id|RxATX
comma
id|ioaddr
op_plus
id|rxcfg
)paren
suffix:semicolon
multiline_comment|/* restore cr */
id|outl
c_func
(paren
id|cr_saved
comma
id|ioaddr
op_plus
id|cr
)paren
suffix:semicolon
)brace
r_return
suffix:semicolon
)brace
DECL|function|sis900_reset
r_static
r_void
id|sis900_reset
c_func
(paren
r_struct
id|net_device
op_star
id|net_dev
)paren
(brace
r_int
id|ioaddr
op_assign
id|net_dev-&gt;base_addr
suffix:semicolon
r_int
id|i
op_assign
l_int|0
suffix:semicolon
id|u32
id|status
op_assign
id|TxRCMP
op_or
id|RxRCMP
suffix:semicolon
id|outl
c_func
(paren
l_int|0
comma
id|ioaddr
op_plus
id|ier
)paren
suffix:semicolon
id|outl
c_func
(paren
l_int|0
comma
id|ioaddr
op_plus
id|imr
)paren
suffix:semicolon
id|outl
c_func
(paren
l_int|0
comma
id|ioaddr
op_plus
id|rfcr
)paren
suffix:semicolon
id|outl
c_func
(paren
id|RxRESET
op_or
id|TxRESET
op_or
id|RESET
comma
id|ioaddr
op_plus
id|cr
)paren
suffix:semicolon
multiline_comment|/* Check that the chip has finished the reset. */
r_while
c_loop
(paren
id|status
op_logical_and
(paren
id|i
op_increment
OL
l_int|1000
)paren
)paren
(brace
id|status
op_xor_assign
(paren
id|inl
c_func
(paren
id|isr
op_plus
id|ioaddr
)paren
op_amp
id|status
)paren
suffix:semicolon
)brace
id|outl
c_func
(paren
id|PESEL
comma
id|ioaddr
op_plus
id|cfg
)paren
suffix:semicolon
)brace
DECL|function|sis900_cleanup_module
r_static
r_void
id|__exit
id|sis900_cleanup_module
c_func
(paren
r_void
)paren
(brace
multiline_comment|/* No need to check MOD_IN_USE, as sys_delete_module() checks. */
r_while
c_loop
(paren
id|root_sis900_dev
)paren
(brace
r_struct
id|sis900_private
op_star
id|sis_priv
op_assign
(paren
r_struct
id|sis900_private
op_star
)paren
id|root_sis900_dev-&gt;priv
suffix:semicolon
r_struct
id|net_device
op_star
id|next_dev
op_assign
id|sis_priv-&gt;next_module
suffix:semicolon
id|unregister_netdev
c_func
(paren
id|root_sis900_dev
)paren
suffix:semicolon
id|release_region
c_func
(paren
id|root_sis900_dev-&gt;base_addr
comma
id|sis_priv-&gt;mac-&gt;io_size
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|sis_priv
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|root_sis900_dev
)paren
suffix:semicolon
id|root_sis900_dev
op_assign
id|next_dev
suffix:semicolon
)brace
)brace
DECL|variable|sis900_probe
id|module_init
c_func
(paren
id|sis900_probe
)paren
suffix:semicolon
DECL|variable|sis900_cleanup_module
id|module_exit
c_func
(paren
id|sis900_cleanup_module
)paren
suffix:semicolon
eof
