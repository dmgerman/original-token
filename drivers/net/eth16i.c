multiline_comment|/* eth16i.c An ICL EtherTeam 16i and 32 EISA ethernet driver for Linux&n;   &n;   Written 1994-1999 by Mika Kuoppala&n;   &n;   Copyright (C) 1994-1999 by Mika Kuoppala&n;   Based on skeleton.c and heavily on at1700.c by Donald Becker&n;&n;   This software may be used and distributed according to the terms&n;   of the GNU Public Licence, incorporated herein by reference.&n;&n;   The author may be reached as miku@iki.fi&n;&n;   This driver supports following cards :&n;&t;- ICL EtherTeam 16i&n;&t;- ICL EtherTeam 32 EISA &n;&t;  (Uses true 32 bit transfers rather than 16i compability mode)&n;&n;   Example Module usage:&n;        insmod eth16i.o io=0x2a0 mediatype=bnc&n;&n;&t;mediatype can be one of the following: bnc,tp,dix,auto,eprom&n;&n;&t;&squot;auto&squot; will try to autoprobe mediatype.&n;&t;&squot;eprom&squot; will use whatever type defined in eprom.&n;&n;   I have benchmarked driver with PII/300Mhz as a ftp client&n;   and 486/33Mhz as a ftp server. Top speed was 1128.37 kilobytes/sec.&n;   &n;   Sources:&n;     - skeleton.c  a sample network driver core for linux,&n;       written by Donald Becker &lt;becker@CESDIS.gsfc.nasa.gov&gt;&n;     - at1700.c a driver for Allied Telesis AT1700, written &n;       by Donald Becker.&n;     - e16iSRV.asm a Netware 3.X Server Driver for ICL EtherTeam16i&n;       written by Markku Viima&n;     - The Fujitsu MB86965 databook.&n;   &n;   Author thanks following persons due to their valueble assistance:    &n;        Markku Viima (ICL)&n;&t;Ari Valve (ICL)      &n;&t;Donald Becker&n;&t;Kurt Huwig &lt;kurt@huwig.de&gt;&n;&n;   Revision history:&n;&n;   Version&t;Date&t;&t;Description&n;   &n;   0.01         15.12-94        Initial version (card detection)&n;   0.02         23.01-95        Interrupt is now hooked correctly&n;   0.03         01.02-95        Rewrote initialization part&n;   0.04         07.02-95        Base skeleton done...&n;                                Made a few changes to signature checking&n;                                to make it a bit reliable.&n;                                - fixed bug in tx_buf mapping&n;                                - fixed bug in initialization (DLC_EN&n;                                  wasn&squot;t enabled when initialization&n;                                  was done.)&n;   0.05         08.02-95        If there were more than one packet to send,&n;                                transmit was jammed due to invalid&n;                                register write...now fixed&n;   0.06         19.02-95        Rewrote interrupt handling        &n;   0.07         13.04-95        Wrote EEPROM read routines&n;                                Card configuration now set according to&n;                                data read from EEPROM&n;   0.08         23.06-95        Wrote part that tries to probe used interface&n;                                port if AUTO is selected&n;&n;   0.09         01.09-95        Added module support&n;   &n;   0.10         04.09-95        Fixed receive packet allocation to work&n;                                with kernels &gt; 1.3.x&n;      &n;   0.20&t;&t;20.09-95&t;Added support for EtherTeam32 EISA&t;&n;&n;   0.21         17.10-95        Removed the unnecessary extern &n;&t;&t;&t;&t;init_etherdev() declaration. Some&n;&t;&t;&t;&t;other cleanups.&n;   &t;&t;&t;&t;&n;   0.22&t;&t;22.02-96&t;Receive buffer was not flushed&n;&t;&t;&t;&t;correctly when faulty packet was&n;&t;&t;&t;&t;received. Now fixed.&n;&n;   0.23&t;&t;26.02-96&t;Made resetting the adapter&t;&n;&t;&t;&t; &t;more reliable.&n;   &n;   0.24&t;&t;27.02-96&t;Rewrote faulty packet handling in eth16i_rx&n;&n;   0.25&t;&t;22.05-96&t;kfree() was missing from cleanup_module.&n;&n;   0.26&t;&t;11.06-96&t;Sometimes card was not found by &n;&t;&t;&t;&t;check_signature(). Now made more reliable.&n;   &n;   0.27&t;&t;23.06-96&t;Oops. 16 consecutive collisions halted &n;&t;&t;&t;&t;adapter. Now will try to retransmit &n;&t;&t;&t;&t;MAX_COL_16 times before finally giving up.&n;   &n;   0.28&t;        28.10-97&t;Added dev_id parameter (NULL) for free_irq&n;&n;   0.29         29.10-97        Multiple card support for module users&n;&n;   0.30         30.10-97        Fixed irq allocation bug.&n;                                (request_irq moved from probe to open)&n;&n;   0.30a        21.08-98        Card detection made more relaxed. Driver&n;                                had problems with some TCP/IP-PROM boots&n;&t;&t;&t;&t;to find the card. Suggested by &n;&t;&t;&t;&t;Kurt Huwig &lt;kurt@huwig.de&gt;&n;&n;   0.31         28.08-98        Media interface port can now be selected&n;                                with module parameters or kernel&n;&t;&t;&t;&t;boot parameters. &n;&n;   0.32         31.08-98        IRQ was never freed if open/close &n;                                pair wasn&squot;t called. Now fixed.&n;   &n;   0.33         10.09-98        When eth16i_open() was called after&n;                                eth16i_close() chip never recovered.&n;&t;&t;&t;&t;Now more shallow reset is made on&n;&t;&t;&t;&t;close.&n;&n;   0.34         29.06-99&t;Fixed one bad #ifdef.&n;&t;&t;&t;&t;Changed ioaddr -&gt; io for consistency&n;&n;   0.35         01.07-99        transmit,-receive bytes were never&n;                                updated in stats. &n;&n;   Bugs:&n;&t;In some cases the media interface autoprobing code doesn&squot;t find &n;&t;the correct interface type. In this case you can &n;&t;manually choose the interface type in DOS with E16IC.EXE which is &n;&t;configuration software for EtherTeam16i and EtherTeam32 cards.&n;&t;This is also true for IRQ setting. You cannot use module&n;&t;parameter to configure IRQ of the card (yet). &n;&n;   To do:&n;&t;- Real multicast support&n;&t;- Rewrite the media interface autoprobing code. Its _horrible_ !&n;&t;- Possibly merge all the MB86965 specific code to external&n;&t;  module for use by eth16.c and Donald&squot;s at1700.c&n;&t;- IRQ configuration with module parameter. I will do&n;&t;  this when i will get enough info about setting&n;&t;  irq without configuration utility.&n;*/
DECL|variable|version
r_static
r_char
op_star
id|version
op_assign
l_string|&quot;eth16i.c: v0.35 01-Jul-1999 Mika Kuoppala (miku@iki.fi)&bslash;n&quot;
suffix:semicolon
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/types.h&gt;&t;&t;  
macro_line|#include &lt;linux/fcntl.h&gt;&t;&t;  
macro_line|#include &lt;linux/interrupt.h&gt;&t;&t;  
macro_line|#include &lt;linux/ptrace.h&gt;&t;&t;  
macro_line|#include &lt;linux/ioport.h&gt;&t;&t;  
macro_line|#include &lt;linux/in.h&gt;&t;&t;  
macro_line|#include &lt;linux/malloc.h&gt;&t;&t;  
macro_line|#include &lt;linux/string.h&gt;&t;&t;  
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/spinlock.h&gt;
macro_line|#include &lt;linux/netdevice.h&gt;
macro_line|#include &lt;linux/etherdevice.h&gt;
macro_line|#include &lt;linux/skbuff.h&gt;
macro_line|#include &lt;asm/system.h&gt;&t;&t;  
macro_line|#include &lt;asm/bitops.h&gt;&t;&t;  
macro_line|#include &lt;asm/io.h&gt;&t;&t;  
macro_line|#include &lt;asm/dma.h&gt;
multiline_comment|/* Few macros */
DECL|macro|BIT
mdefine_line|#define BIT(a)&t;&t;       ( (1 &lt;&lt; (a)) )  
DECL|macro|BITSET
mdefine_line|#define BITSET(ioaddr, bnum)   ((outb(((inb(ioaddr)) | (bnum)), ioaddr))) 
DECL|macro|BITCLR
mdefine_line|#define BITCLR(ioaddr, bnum)   ((outb(((inb(ioaddr)) &amp; (~(bnum))), ioaddr)))
multiline_comment|/* This is the I/O address space for Etherteam 16i adapter. */
DECL|macro|ETH16I_IO_EXTENT
mdefine_line|#define ETH16I_IO_EXTENT       32
multiline_comment|/* Ticks before deciding that transmit has timed out */
DECL|macro|TX_TIMEOUT
mdefine_line|#define TX_TIMEOUT             (400*HZ/1000)
multiline_comment|/* Maximum loop count when receiving packets */
DECL|macro|MAX_RX_LOOP
mdefine_line|#define MAX_RX_LOOP            20
multiline_comment|/* Some interrupt masks */
DECL|macro|ETH16I_INTR_ON
mdefine_line|#define ETH16I_INTR_ON&t;       0xef8a       /* Higher is receive mask */
DECL|macro|ETH16I_INTR_OFF
mdefine_line|#define ETH16I_INTR_OFF&t;       0x0000
multiline_comment|/* Buffers header status byte meanings */
DECL|macro|PKT_GOOD
mdefine_line|#define PKT_GOOD               BIT(5)
DECL|macro|PKT_GOOD_RMT
mdefine_line|#define PKT_GOOD_RMT           BIT(4)
DECL|macro|PKT_SHORT
mdefine_line|#define PKT_SHORT              BIT(3)
DECL|macro|PKT_ALIGN_ERR
mdefine_line|#define PKT_ALIGN_ERR          BIT(2)
DECL|macro|PKT_CRC_ERR
mdefine_line|#define PKT_CRC_ERR            BIT(1)
DECL|macro|PKT_RX_BUF_OVERFLOW
mdefine_line|#define PKT_RX_BUF_OVERFLOW    BIT(0)
multiline_comment|/* Transmit status register (DLCR0) */
DECL|macro|TX_STATUS_REG
mdefine_line|#define TX_STATUS_REG          0
DECL|macro|TX_DONE
mdefine_line|#define TX_DONE                BIT(7)
DECL|macro|NET_BUSY
mdefine_line|#define NET_BUSY               BIT(6)
DECL|macro|TX_PKT_RCD
mdefine_line|#define TX_PKT_RCD             BIT(5)
DECL|macro|CR_LOST
mdefine_line|#define CR_LOST                BIT(4)
DECL|macro|TX_JABBER_ERR
mdefine_line|#define TX_JABBER_ERR&t;       BIT(3)
DECL|macro|COLLISION
mdefine_line|#define COLLISION              BIT(2)
DECL|macro|COLLISIONS_16
mdefine_line|#define COLLISIONS_16          BIT(1)
multiline_comment|/* Receive status register (DLCR1) */
DECL|macro|RX_STATUS_REG
mdefine_line|#define RX_STATUS_REG          1
DECL|macro|RX_PKT
mdefine_line|#define RX_PKT                 BIT(7)  /* Packet received */
DECL|macro|BUS_RD_ERR
mdefine_line|#define BUS_RD_ERR             BIT(6)
DECL|macro|SHORT_PKT_ERR
mdefine_line|#define SHORT_PKT_ERR          BIT(3)
DECL|macro|ALIGN_ERR
mdefine_line|#define ALIGN_ERR              BIT(2)
DECL|macro|CRC_ERR
mdefine_line|#define CRC_ERR                BIT(1)
DECL|macro|RX_BUF_OVERFLOW
mdefine_line|#define RX_BUF_OVERFLOW        BIT(0)
multiline_comment|/* Transmit Interrupt Enable Register (DLCR2) */
DECL|macro|TX_INTR_REG
mdefine_line|#define TX_INTR_REG            2
DECL|macro|TX_INTR_DONE
mdefine_line|#define TX_INTR_DONE           BIT(7)
DECL|macro|TX_INTR_COL
mdefine_line|#define TX_INTR_COL            BIT(2)
DECL|macro|TX_INTR_16_COL
mdefine_line|#define TX_INTR_16_COL         BIT(1)
multiline_comment|/* Receive Interrupt Enable Register (DLCR3) */
DECL|macro|RX_INTR_REG
mdefine_line|#define RX_INTR_REG            3
DECL|macro|RX_INTR_RECEIVE
mdefine_line|#define RX_INTR_RECEIVE        BIT(7)
DECL|macro|RX_INTR_SHORT_PKT
mdefine_line|#define RX_INTR_SHORT_PKT      BIT(3)
DECL|macro|RX_INTR_CRC_ERR
mdefine_line|#define RX_INTR_CRC_ERR        BIT(1)
DECL|macro|RX_INTR_BUF_OVERFLOW
mdefine_line|#define RX_INTR_BUF_OVERFLOW   BIT(0)
multiline_comment|/* Transmit Mode Register (DLCR4) */
DECL|macro|TRANSMIT_MODE_REG
mdefine_line|#define TRANSMIT_MODE_REG      4
DECL|macro|LOOPBACK_CONTROL
mdefine_line|#define LOOPBACK_CONTROL       BIT(1)
DECL|macro|CONTROL_OUTPUT
mdefine_line|#define CONTROL_OUTPUT         BIT(2)
multiline_comment|/* Receive Mode Register (DLCR5) */
DECL|macro|RECEIVE_MODE_REG
mdefine_line|#define RECEIVE_MODE_REG       5
DECL|macro|RX_BUFFER_EMPTY
mdefine_line|#define RX_BUFFER_EMPTY        BIT(6)
DECL|macro|ACCEPT_BAD_PACKETS
mdefine_line|#define ACCEPT_BAD_PACKETS     BIT(5)
DECL|macro|RECEIVE_SHORT_ADDR
mdefine_line|#define RECEIVE_SHORT_ADDR     BIT(4)
DECL|macro|ACCEPT_SHORT_PACKETS
mdefine_line|#define ACCEPT_SHORT_PACKETS   BIT(3)
DECL|macro|REMOTE_RESET
mdefine_line|#define REMOTE_RESET           BIT(2)
DECL|macro|ADDRESS_FILTER_MODE
mdefine_line|#define ADDRESS_FILTER_MODE    BIT(1) | BIT(0)
DECL|macro|REJECT_ALL
mdefine_line|#define REJECT_ALL             0
DECL|macro|ACCEPT_ALL
mdefine_line|#define ACCEPT_ALL             3
DECL|macro|MODE_1
mdefine_line|#define MODE_1                 1            /* NODE ID, BC, MC, 2-24th bit */
DECL|macro|MODE_2
mdefine_line|#define MODE_2                 2            /* NODE ID, BC, MC, Hash Table */
multiline_comment|/* Configuration Register 0 (DLCR6) */
DECL|macro|CONFIG_REG_0
mdefine_line|#define CONFIG_REG_0           6
DECL|macro|DLC_EN
mdefine_line|#define DLC_EN                 BIT(7)
DECL|macro|SRAM_CYCLE_TIME_100NS
mdefine_line|#define SRAM_CYCLE_TIME_100NS  BIT(6)
DECL|macro|SYSTEM_BUS_WIDTH_8
mdefine_line|#define SYSTEM_BUS_WIDTH_8     BIT(5)       /* 1 = 8bit, 0 = 16bit */
DECL|macro|BUFFER_WIDTH_8
mdefine_line|#define BUFFER_WIDTH_8         BIT(4)       /* 1 = 8bit, 0 = 16bit */
DECL|macro|TBS1
mdefine_line|#define TBS1                   BIT(3)       
DECL|macro|TBS0
mdefine_line|#define TBS0                   BIT(2)
DECL|macro|SRAM_BS1
mdefine_line|#define SRAM_BS1               BIT(1)       /* 00=8kb,  01=16kb  */
DECL|macro|SRAM_BS0
mdefine_line|#define SRAM_BS0               BIT(0)       /* 10=32kb, 11=64kb  */
macro_line|#ifndef ETH16I_TX_BUF_SIZE                   /* 0 = 2kb, 1 = 4kb  */ 
DECL|macro|ETH16I_TX_BUF_SIZE
mdefine_line|#define ETH16I_TX_BUF_SIZE     3             /* 2 = 8kb, 3 = 16kb */
macro_line|#endif                                      
DECL|macro|TX_BUF_1x2048
mdefine_line|#define TX_BUF_1x2048          0
DECL|macro|TX_BUF_2x2048
mdefine_line|#define TX_BUF_2x2048          1
DECL|macro|TX_BUF_2x4098
mdefine_line|#define TX_BUF_2x4098          2
DECL|macro|TX_BUF_2x8192
mdefine_line|#define TX_BUF_2x8192          3
multiline_comment|/* Configuration Register 1 (DLCR7) */
DECL|macro|CONFIG_REG_1
mdefine_line|#define CONFIG_REG_1           7
DECL|macro|POWERUP
mdefine_line|#define POWERUP                BIT(5)
multiline_comment|/* Transmit start register */
DECL|macro|TRANSMIT_START_REG
mdefine_line|#define TRANSMIT_START_REG     10
DECL|macro|TRANSMIT_START_RB
mdefine_line|#define TRANSMIT_START_RB      2
DECL|macro|TX_START
mdefine_line|#define TX_START               BIT(7)       /* Rest of register bit indicate*/
multiline_comment|/* number of packets in tx buffer*/
multiline_comment|/* Node ID registers (DLCR8-13) */
DECL|macro|NODE_ID_0
mdefine_line|#define NODE_ID_0              8
DECL|macro|NODE_ID_RB
mdefine_line|#define NODE_ID_RB             0
multiline_comment|/* Hash Table registers (HT8-15) */
DECL|macro|HASH_TABLE_0
mdefine_line|#define HASH_TABLE_0           8
DECL|macro|HASH_TABLE_RB
mdefine_line|#define HASH_TABLE_RB          1
multiline_comment|/* Buffer memory ports */
DECL|macro|BUFFER_MEM_PORT_LB
mdefine_line|#define BUFFER_MEM_PORT_LB     8
DECL|macro|DATAPORT
mdefine_line|#define DATAPORT               BUFFER_MEM_PORT_LB
DECL|macro|BUFFER_MEM_PORT_HB
mdefine_line|#define BUFFER_MEM_PORT_HB     9
multiline_comment|/* 16 Collision control register (BMPR11) */
DECL|macro|COL_16_REG
mdefine_line|#define COL_16_REG             11
DECL|macro|HALT_ON_16
mdefine_line|#define HALT_ON_16             0x00
DECL|macro|RETRANS_AND_HALT_ON_16
mdefine_line|#define RETRANS_AND_HALT_ON_16 0x02
multiline_comment|/* Maximum number of attempts to send after 16 concecutive collisions */
DECL|macro|MAX_COL_16
mdefine_line|#define MAX_COL_16&t;       10
multiline_comment|/* DMA Burst and Transceiver Mode Register (BMPR13) */
DECL|macro|TRANSCEIVER_MODE_REG
mdefine_line|#define TRANSCEIVER_MODE_REG   13
DECL|macro|TRANSCEIVER_MODE_RB
mdefine_line|#define TRANSCEIVER_MODE_RB    2         
DECL|macro|IO_BASE_UNLOCK
mdefine_line|#define IO_BASE_UNLOCK&t;       BIT(7)
DECL|macro|LOWER_SQUELCH_TRESH
mdefine_line|#define LOWER_SQUELCH_TRESH    BIT(6)
DECL|macro|LINK_TEST_DISABLE
mdefine_line|#define LINK_TEST_DISABLE      BIT(5)
DECL|macro|AUI_SELECT
mdefine_line|#define AUI_SELECT             BIT(4)
DECL|macro|DIS_AUTO_PORT_SEL
mdefine_line|#define DIS_AUTO_PORT_SEL      BIT(3)
multiline_comment|/* Filter Self Receive Register (BMPR14)  */
DECL|macro|FILTER_SELF_RX_REG
mdefine_line|#define FILTER_SELF_RX_REG     14
DECL|macro|SKIP_RX_PACKET
mdefine_line|#define SKIP_RX_PACKET         BIT(2)
DECL|macro|FILTER_SELF_RECEIVE
mdefine_line|#define FILTER_SELF_RECEIVE    BIT(0)
multiline_comment|/* EEPROM Control Register (BMPR 16) */
DECL|macro|EEPROM_CTRL_REG
mdefine_line|#define EEPROM_CTRL_REG        16
multiline_comment|/* EEPROM Data Register (BMPR 17) */
DECL|macro|EEPROM_DATA_REG
mdefine_line|#define EEPROM_DATA_REG        17
multiline_comment|/* NMC93CSx6 EEPROM Control Bits */
DECL|macro|CS_0
mdefine_line|#define CS_0                   0x00
DECL|macro|CS_1
mdefine_line|#define CS_1                   0x20
DECL|macro|SK_0
mdefine_line|#define SK_0                   0x00
DECL|macro|SK_1
mdefine_line|#define SK_1                   0x40
DECL|macro|DI_0
mdefine_line|#define DI_0                   0x00
DECL|macro|DI_1
mdefine_line|#define DI_1                   0x80
multiline_comment|/* NMC93CSx6 EEPROM Instructions */
DECL|macro|EEPROM_READ
mdefine_line|#define EEPROM_READ            0x80
multiline_comment|/* NMC93CSx6 EEPROM Addresses */
DECL|macro|E_NODEID_0
mdefine_line|#define E_NODEID_0             0x02
DECL|macro|E_NODEID_1
mdefine_line|#define E_NODEID_1             0x03
DECL|macro|E_NODEID_2
mdefine_line|#define E_NODEID_2             0x04
DECL|macro|E_PORT_SELECT
mdefine_line|#define E_PORT_SELECT          0x14
DECL|macro|E_PORT_BNC
mdefine_line|#define E_PORT_BNC           0x00
DECL|macro|E_PORT_DIX
mdefine_line|#define E_PORT_DIX           0x01
DECL|macro|E_PORT_TP
mdefine_line|#define E_PORT_TP            0x02
DECL|macro|E_PORT_AUTO
mdefine_line|#define E_PORT_AUTO          0x03
DECL|macro|E_PORT_FROM_EPROM
mdefine_line|#define E_PORT_FROM_EPROM    0x04
DECL|macro|E_PRODUCT_CFG
mdefine_line|#define E_PRODUCT_CFG          0x30
multiline_comment|/* Macro to slow down io between EEPROM clock transitions */
DECL|macro|eeprom_slow_io
mdefine_line|#define eeprom_slow_io() do { int _i = 40; while(--_i &gt; 0) { inb(0x80); }}while(0)
multiline_comment|/* Jumperless Configuration Register (BMPR19) */
DECL|macro|JUMPERLESS_CONFIG
mdefine_line|#define JUMPERLESS_CONFIG      19
multiline_comment|/* ID ROM registers, writing to them also resets some parts of chip */
DECL|macro|ID_ROM_0
mdefine_line|#define ID_ROM_0               24
DECL|macro|ID_ROM_7
mdefine_line|#define ID_ROM_7               31
DECL|macro|RESET
mdefine_line|#define RESET                  ID_ROM_0
multiline_comment|/* This is the I/O address list to be probed when seeking the card */
DECL|variable|eth16i_portlist
r_static
r_int
r_int
id|eth16i_portlist
(braket
)braket
op_assign
(brace
l_int|0x260
comma
l_int|0x280
comma
l_int|0x2A0
comma
l_int|0x240
comma
l_int|0x340
comma
l_int|0x320
comma
l_int|0x380
comma
l_int|0x300
comma
l_int|0
)brace
suffix:semicolon
DECL|variable|eth32i_portlist
r_static
r_int
r_int
id|eth32i_portlist
(braket
)braket
op_assign
(brace
l_int|0x1000
comma
l_int|0x2000
comma
l_int|0x3000
comma
l_int|0x4000
comma
l_int|0x5000
comma
l_int|0x6000
comma
l_int|0x7000
comma
l_int|0x8000
comma
l_int|0x9000
comma
l_int|0xA000
comma
l_int|0xB000
comma
l_int|0xC000
comma
l_int|0xD000
comma
l_int|0xE000
comma
l_int|0xF000
comma
l_int|0
)brace
suffix:semicolon
multiline_comment|/* This is the Interrupt lookup table for Eth16i card */
DECL|variable|eth16i_irqmap
r_static
r_int
r_int
id|eth16i_irqmap
(braket
)braket
op_assign
(brace
l_int|9
comma
l_int|10
comma
l_int|5
comma
l_int|15
comma
l_int|0
)brace
suffix:semicolon
DECL|macro|NUM_OF_ISA_IRQS
mdefine_line|#define NUM_OF_ISA_IRQS    4
multiline_comment|/* This is the Interrupt lookup table for Eth32i card */
DECL|variable|eth32i_irqmap
r_static
r_int
r_int
id|eth32i_irqmap
(braket
)braket
op_assign
(brace
l_int|3
comma
l_int|5
comma
l_int|7
comma
l_int|9
comma
l_int|10
comma
l_int|11
comma
l_int|12
comma
l_int|15
comma
l_int|0
)brace
suffix:semicolon
DECL|macro|EISA_IRQ_REG
mdefine_line|#define EISA_IRQ_REG&t;0xc89
DECL|macro|NUM_OF_EISA_IRQS
mdefine_line|#define NUM_OF_EISA_IRQS   8
DECL|variable|eth16i_tx_buf_map
r_static
r_int
r_int
id|eth16i_tx_buf_map
(braket
)braket
op_assign
(brace
l_int|2048
comma
l_int|2048
comma
l_int|4096
comma
l_int|8192
)brace
suffix:semicolon
DECL|variable|boot
r_static
r_int
r_int
id|boot
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* Use 0 for production, 1 for verification, &gt;2 for debug */
macro_line|#ifndef ETH16I_DEBUG
DECL|macro|ETH16I_DEBUG
mdefine_line|#define ETH16I_DEBUG 0
macro_line|#endif
DECL|variable|eth16i_debug
r_static
r_int
r_int
id|eth16i_debug
op_assign
id|ETH16I_DEBUG
suffix:semicolon
multiline_comment|/* Information for each board */
DECL|struct|eth16i_local
r_struct
id|eth16i_local
(brace
DECL|member|stats
r_struct
id|net_device_stats
id|stats
suffix:semicolon
DECL|member|tx_started
r_int
r_char
id|tx_started
suffix:semicolon
DECL|member|tx_buf_busy
r_int
r_char
id|tx_buf_busy
suffix:semicolon
DECL|member|tx_queue
r_int
r_int
id|tx_queue
suffix:semicolon
multiline_comment|/* Number of packets in transmit buffer */
DECL|member|tx_queue_len
r_int
r_int
id|tx_queue_len
suffix:semicolon
DECL|member|tx_buf_size
r_int
r_int
id|tx_buf_size
suffix:semicolon
DECL|member|open_time
r_int
r_int
id|open_time
suffix:semicolon
DECL|member|tx_buffered_packets
r_int
r_int
id|tx_buffered_packets
suffix:semicolon
DECL|member|tx_buffered_bytes
r_int
r_int
id|tx_buffered_bytes
suffix:semicolon
DECL|member|col_16
r_int
r_int
id|col_16
suffix:semicolon
DECL|member|lock
id|spinlock_t
id|lock
suffix:semicolon
)brace
suffix:semicolon
multiline_comment|/* Function prototypes */
r_extern
r_int
id|eth16i_probe
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_int
id|eth16i_probe1
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_int
id|ioaddr
)paren
suffix:semicolon
r_static
r_int
id|eth16i_check_signature
c_func
(paren
r_int
id|ioaddr
)paren
suffix:semicolon
r_static
r_int
id|eth16i_probe_port
c_func
(paren
r_int
id|ioaddr
)paren
suffix:semicolon
r_static
r_void
id|eth16i_set_port
c_func
(paren
r_int
id|ioaddr
comma
r_int
id|porttype
)paren
suffix:semicolon
r_static
r_int
id|eth16i_send_probe_packet
c_func
(paren
r_int
id|ioaddr
comma
r_int
r_char
op_star
id|b
comma
r_int
id|l
)paren
suffix:semicolon
r_static
r_int
id|eth16i_receive_probe_packet
c_func
(paren
r_int
id|ioaddr
)paren
suffix:semicolon
r_static
r_int
id|eth16i_get_irq
c_func
(paren
r_int
id|ioaddr
)paren
suffix:semicolon
r_static
r_int
id|eth16i_read_eeprom
c_func
(paren
r_int
id|ioaddr
comma
r_int
id|offset
)paren
suffix:semicolon
r_static
r_int
id|eth16i_read_eeprom_word
c_func
(paren
r_int
id|ioaddr
)paren
suffix:semicolon
r_static
r_void
id|eth16i_eeprom_cmd
c_func
(paren
r_int
id|ioaddr
comma
r_int
r_char
id|command
)paren
suffix:semicolon
r_static
r_int
id|eth16i_open
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_int
id|eth16i_close
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_int
id|eth16i_tx
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_void
id|eth16i_rx
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_void
id|eth16i_timeout
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_void
id|eth16i_interrupt
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
suffix:semicolon
r_static
r_void
id|eth16i_reset
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_void
id|eth16i_timeout
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_void
id|eth16i_skip_packet
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_void
id|eth16i_multicast
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_void
id|eth16i_select_regbank
c_func
(paren
r_int
r_char
id|regbank
comma
r_int
id|ioaddr
)paren
suffix:semicolon
r_static
r_void
id|eth16i_initialize
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
macro_line|#if 0
r_static
r_int
id|eth16i_set_irq
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
macro_line|#endif
macro_line|#ifdef MODULE
r_static
id|ushort
id|eth16i_parse_mediatype
c_func
(paren
r_const
r_char
op_star
id|s
)paren
suffix:semicolon
macro_line|#endif
r_static
r_struct
id|net_device_stats
op_star
id|eth16i_get_stats
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
DECL|variable|cardname
r_static
r_char
op_star
id|cardname
op_assign
l_string|&quot;ICL EtherTeam 16i/32&quot;
suffix:semicolon
DECL|function|eth16i_probe
r_int
id|__init
id|eth16i_probe
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_int
id|i
suffix:semicolon
r_int
id|ioaddr
suffix:semicolon
r_int
id|base_addr
op_assign
id|dev-&gt;base_addr
suffix:semicolon
id|SET_MODULE_OWNER
c_func
(paren
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|eth16i_debug
OG
l_int|4
)paren
(brace
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;Probing started for %s&bslash;n&quot;
comma
id|cardname
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|base_addr
OG
l_int|0x1ff
)paren
(brace
multiline_comment|/* Check only single location */
r_return
id|eth16i_probe1
c_func
(paren
id|dev
comma
id|base_addr
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|base_addr
op_ne
l_int|0
)paren
(brace
multiline_comment|/* Don&squot;t probe at all */
r_return
op_minus
id|ENXIO
suffix:semicolon
)brace
multiline_comment|/* Seek card from the ISA io address space */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
(paren
id|ioaddr
op_assign
id|eth16i_portlist
(braket
id|i
)braket
)paren
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
id|eth16i_probe1
c_func
(paren
id|dev
comma
id|ioaddr
)paren
op_eq
l_int|0
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Seek card from the EISA io address space */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
(paren
id|ioaddr
op_assign
id|eth32i_portlist
(braket
id|i
)braket
)paren
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
id|eth16i_probe1
c_func
(paren
id|dev
comma
id|ioaddr
)paren
op_eq
l_int|0
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
DECL|function|eth16i_probe1
r_static
r_int
id|__init
id|eth16i_probe1
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_int
id|ioaddr
)paren
(brace
r_struct
id|eth16i_local
op_star
id|lp
suffix:semicolon
r_static
r_int
id|version_printed
suffix:semicolon
r_int
id|retval
suffix:semicolon
id|boot
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* To inform initilization that we are in boot probe */
multiline_comment|/* Let&squot;s grab the region */
r_if
c_cond
(paren
op_logical_neg
id|request_region
c_func
(paren
id|ioaddr
comma
id|ETH16I_IO_EXTENT
comma
id|dev-&gt;name
)paren
)paren
r_return
op_minus
id|EBUSY
suffix:semicolon
multiline_comment|/*&n;&t;  The MB86985 chip has on register which holds information in which &n;&t;  io address the chip lies. First read this register and compare&n;&t;  it to our current io address and if match then this could&n;&t;  be our chip.&n;&t;  */
r_if
c_cond
(paren
id|ioaddr
OL
l_int|0x1000
)paren
(brace
r_if
c_cond
(paren
id|eth16i_portlist
(braket
(paren
id|inb
c_func
(paren
id|ioaddr
op_plus
id|JUMPERLESS_CONFIG
)paren
op_amp
l_int|0x07
)paren
)braket
op_ne
id|ioaddr
)paren
(brace
id|retval
op_assign
op_minus
id|ENODEV
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
)brace
multiline_comment|/* Now we will go a bit deeper and try to find the chip&squot;s signature */
r_if
c_cond
(paren
id|eth16i_check_signature
c_func
(paren
id|ioaddr
)paren
op_ne
l_int|0
)paren
(brace
id|retval
op_assign
op_minus
id|ENODEV
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
multiline_comment|/* &n;&t;   Now it seems that we have found a ethernet chip in this particular&n;&t;   ioaddr. The MB86985 chip has this feature, that when you read a &n;&t;   certain register it will increase it&squot;s io base address to next&n;&t;   configurable slot. Now when we have found the chip, first thing is&n;&t;   to make sure that the chip&squot;s ioaddr will hold still here.&n;&t;   */
id|eth16i_select_regbank
c_func
(paren
id|TRANSCEIVER_MODE_RB
comma
id|ioaddr
)paren
suffix:semicolon
id|outb
c_func
(paren
l_int|0x00
comma
id|ioaddr
op_plus
id|TRANSCEIVER_MODE_REG
)paren
suffix:semicolon
id|outb
c_func
(paren
l_int|0x00
comma
id|ioaddr
op_plus
id|RESET
)paren
suffix:semicolon
multiline_comment|/* Reset some parts of chip */
id|BITSET
c_func
(paren
id|ioaddr
op_plus
id|CONFIG_REG_0
comma
id|BIT
c_func
(paren
l_int|7
)paren
)paren
suffix:semicolon
multiline_comment|/* Disable the data link */
r_if
c_cond
(paren
(paren
id|eth16i_debug
op_amp
id|version_printed
op_increment
)paren
op_eq
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s&quot;
comma
id|version
)paren
suffix:semicolon
)brace
id|dev-&gt;base_addr
op_assign
id|ioaddr
suffix:semicolon
id|dev-&gt;irq
op_assign
id|eth16i_get_irq
c_func
(paren
id|ioaddr
)paren
suffix:semicolon
multiline_comment|/* Try to obtain interrupt vector */
r_if
c_cond
(paren
(paren
id|retval
op_assign
id|request_irq
c_func
(paren
id|dev-&gt;irq
comma
(paren
r_void
op_star
)paren
op_amp
id|eth16i_interrupt
comma
l_int|0
comma
id|dev-&gt;name
comma
id|dev
)paren
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: %s at %#3x, but is unusable due conflicting IRQ %d.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|cardname
comma
id|ioaddr
comma
id|dev-&gt;irq
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: %s at %#3x, IRQ %d, &quot;
comma
id|dev-&gt;name
comma
id|cardname
comma
id|ioaddr
comma
id|dev-&gt;irq
)paren
suffix:semicolon
multiline_comment|/* Now we will have to lock the chip&squot;s io address */
id|eth16i_select_regbank
c_func
(paren
id|TRANSCEIVER_MODE_RB
comma
id|ioaddr
)paren
suffix:semicolon
id|outb
c_func
(paren
l_int|0x38
comma
id|ioaddr
op_plus
id|TRANSCEIVER_MODE_REG
)paren
suffix:semicolon
id|eth16i_initialize
c_func
(paren
id|dev
)paren
suffix:semicolon
multiline_comment|/* Initialize rest of the chip&squot;s registers */
multiline_comment|/* Now let&squot;s same some energy by shutting down the chip ;) */
id|BITCLR
c_func
(paren
id|ioaddr
op_plus
id|CONFIG_REG_1
comma
id|POWERUP
)paren
suffix:semicolon
multiline_comment|/* Initialize the device structure */
r_if
c_cond
(paren
id|dev-&gt;priv
op_eq
l_int|NULL
)paren
(brace
id|dev-&gt;priv
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|eth16i_local
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;priv
op_eq
l_int|NULL
)paren
(brace
id|free_irq
c_func
(paren
id|dev-&gt;irq
comma
id|dev
)paren
suffix:semicolon
id|retval
op_assign
op_minus
id|ENOMEM
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
)brace
id|memset
c_func
(paren
id|dev-&gt;priv
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|eth16i_local
)paren
)paren
suffix:semicolon
id|dev-&gt;open
op_assign
id|eth16i_open
suffix:semicolon
id|dev-&gt;stop
op_assign
id|eth16i_close
suffix:semicolon
id|dev-&gt;hard_start_xmit
op_assign
id|eth16i_tx
suffix:semicolon
id|dev-&gt;get_stats
op_assign
id|eth16i_get_stats
suffix:semicolon
id|dev-&gt;set_multicast_list
op_assign
id|eth16i_multicast
suffix:semicolon
id|dev-&gt;tx_timeout
op_assign
id|eth16i_timeout
suffix:semicolon
id|dev-&gt;watchdog_timeo
op_assign
id|TX_TIMEOUT
suffix:semicolon
id|lp
op_assign
(paren
r_struct
id|eth16i_local
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|spin_lock_init
c_func
(paren
op_amp
id|lp-&gt;lock
)paren
suffix:semicolon
multiline_comment|/* Fill in the fields of the device structure with ethernet values. */
id|ether_setup
c_func
(paren
id|dev
)paren
suffix:semicolon
id|boot
op_assign
l_int|0
suffix:semicolon
r_return
l_int|0
suffix:semicolon
id|out
suffix:colon
id|release_region
c_func
(paren
id|ioaddr
comma
id|ETH16I_IO_EXTENT
)paren
suffix:semicolon
r_return
id|retval
suffix:semicolon
)brace
DECL|function|eth16i_initialize
r_static
r_void
id|eth16i_initialize
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_int
id|ioaddr
op_assign
id|dev-&gt;base_addr
suffix:semicolon
r_int
id|i
comma
id|node_w
op_assign
l_int|0
suffix:semicolon
r_int
r_char
id|node_byte
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Setup station address */
id|eth16i_select_regbank
c_func
(paren
id|NODE_ID_RB
comma
id|ioaddr
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|3
suffix:semicolon
id|i
op_increment
)paren
(brace
r_int
r_int
id|node_val
op_assign
id|eth16i_read_eeprom
c_func
(paren
id|ioaddr
comma
id|E_NODEID_0
op_plus
id|i
)paren
suffix:semicolon
(paren
(paren
r_int
r_int
op_star
)paren
id|dev-&gt;dev_addr
)paren
(braket
id|i
)braket
op_assign
id|ntohs
c_func
(paren
id|node_val
)paren
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|6
suffix:semicolon
id|i
op_increment
)paren
(brace
id|outb
c_func
(paren
(paren
(paren
r_int
r_char
op_star
)paren
id|dev-&gt;dev_addr
)paren
(braket
id|i
)braket
comma
id|ioaddr
op_plus
id|NODE_ID_0
op_plus
id|i
)paren
suffix:semicolon
r_if
c_cond
(paren
id|boot
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%02x&quot;
comma
id|inb
c_func
(paren
id|ioaddr
op_plus
id|NODE_ID_0
op_plus
id|i
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
op_ne
l_int|5
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;:&quot;
)paren
suffix:semicolon
)brace
)brace
)brace
multiline_comment|/* Now we will set multicast addresses to accept none */
id|eth16i_select_regbank
c_func
(paren
id|HASH_TABLE_RB
comma
id|ioaddr
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|8
suffix:semicolon
id|i
op_increment
)paren
(brace
id|outb
c_func
(paren
l_int|0x00
comma
id|ioaddr
op_plus
id|HASH_TABLE_0
op_plus
id|i
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;&t;  Now let&squot;s disable the transmitter and receiver, set the buffer ram &n;&t;  cycle time, bus width and buffer data path width. Also we shall&n;&t;  set transmit buffer size and total buffer size.&n;&t;  */
id|eth16i_select_regbank
c_func
(paren
l_int|2
comma
id|ioaddr
)paren
suffix:semicolon
id|node_byte
op_assign
l_int|0
suffix:semicolon
id|node_w
op_assign
id|eth16i_read_eeprom
c_func
(paren
id|ioaddr
comma
id|E_PRODUCT_CFG
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|node_w
op_amp
l_int|0xFF00
)paren
op_eq
l_int|0x0800
)paren
(brace
id|node_byte
op_or_assign
id|BUFFER_WIDTH_8
suffix:semicolon
)brace
id|node_byte
op_or_assign
id|SRAM_BS1
suffix:semicolon
r_if
c_cond
(paren
(paren
id|node_w
op_amp
l_int|0x00FF
)paren
op_eq
l_int|64
)paren
(brace
id|node_byte
op_or_assign
id|SRAM_BS0
suffix:semicolon
)brace
id|node_byte
op_or_assign
id|DLC_EN
op_or
id|SRAM_CYCLE_TIME_100NS
op_or
(paren
id|ETH16I_TX_BUF_SIZE
op_lshift
l_int|2
)paren
suffix:semicolon
id|outb
c_func
(paren
id|node_byte
comma
id|ioaddr
op_plus
id|CONFIG_REG_0
)paren
suffix:semicolon
multiline_comment|/* We shall halt the transmitting, if 16 collisions are detected */
id|outb
c_func
(paren
id|HALT_ON_16
comma
id|ioaddr
op_plus
id|COL_16_REG
)paren
suffix:semicolon
macro_line|#ifdef MODULE
multiline_comment|/* if_port already set by init_module() */
macro_line|#else
id|dev-&gt;if_port
op_assign
(paren
id|dev-&gt;mem_start
OL
id|E_PORT_FROM_EPROM
)paren
ques
c_cond
id|dev-&gt;mem_start
suffix:colon
id|E_PORT_FROM_EPROM
suffix:semicolon
macro_line|#endif
multiline_comment|/* Set interface port type */
r_if
c_cond
(paren
id|boot
)paren
(brace
r_char
op_star
id|porttype
(braket
)braket
op_assign
(brace
l_string|&quot;BNC&quot;
comma
l_string|&quot;DIX&quot;
comma
l_string|&quot;TP&quot;
comma
l_string|&quot;AUTO&quot;
comma
l_string|&quot;FROM_EPROM&quot;
)brace
suffix:semicolon
r_switch
c_cond
(paren
id|dev-&gt;if_port
)paren
(brace
r_case
id|E_PORT_FROM_EPROM
suffix:colon
id|dev-&gt;if_port
op_assign
id|eth16i_read_eeprom
c_func
(paren
id|ioaddr
comma
id|E_PORT_SELECT
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|E_PORT_AUTO
suffix:colon
id|dev-&gt;if_port
op_assign
id|eth16i_probe_port
c_func
(paren
id|ioaddr
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|E_PORT_BNC
suffix:colon
r_case
id|E_PORT_TP
suffix:colon
r_case
id|E_PORT_DIX
suffix:colon
r_break
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot; %s interface.&bslash;n&quot;
comma
id|porttype
(braket
id|dev-&gt;if_port
)braket
)paren
suffix:semicolon
id|eth16i_set_port
c_func
(paren
id|ioaddr
comma
id|dev-&gt;if_port
)paren
suffix:semicolon
)brace
multiline_comment|/* Set Receive Mode to normal operation */
id|outb
c_func
(paren
id|MODE_2
comma
id|ioaddr
op_plus
id|RECEIVE_MODE_REG
)paren
suffix:semicolon
)brace
DECL|function|eth16i_probe_port
r_static
r_int
id|eth16i_probe_port
c_func
(paren
r_int
id|ioaddr
)paren
(brace
r_int
id|i
suffix:semicolon
r_int
id|retcode
suffix:semicolon
r_int
r_char
id|dummy_packet
(braket
l_int|64
)braket
suffix:semicolon
multiline_comment|/* Powerup the chip */
id|outb
c_func
(paren
l_int|0xc0
op_or
id|POWERUP
comma
id|ioaddr
op_plus
id|CONFIG_REG_1
)paren
suffix:semicolon
id|BITSET
c_func
(paren
id|ioaddr
op_plus
id|CONFIG_REG_0
comma
id|DLC_EN
)paren
suffix:semicolon
id|eth16i_select_regbank
c_func
(paren
id|NODE_ID_RB
comma
id|ioaddr
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|6
suffix:semicolon
id|i
op_increment
)paren
(brace
id|dummy_packet
(braket
id|i
)braket
op_assign
id|inb
c_func
(paren
id|ioaddr
op_plus
id|NODE_ID_0
op_plus
id|i
)paren
suffix:semicolon
id|dummy_packet
(braket
id|i
op_plus
l_int|6
)braket
op_assign
id|inb
c_func
(paren
id|ioaddr
op_plus
id|NODE_ID_0
op_plus
id|i
)paren
suffix:semicolon
)brace
id|dummy_packet
(braket
l_int|12
)braket
op_assign
l_int|0x00
suffix:semicolon
id|dummy_packet
(braket
l_int|13
)braket
op_assign
l_int|0x04
suffix:semicolon
id|memset
c_func
(paren
id|dummy_packet
op_plus
l_int|14
comma
l_int|0
comma
r_sizeof
(paren
id|dummy_packet
)paren
op_minus
l_int|14
)paren
suffix:semicolon
id|eth16i_select_regbank
c_func
(paren
l_int|2
comma
id|ioaddr
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|3
suffix:semicolon
id|i
op_increment
)paren
(brace
id|BITSET
c_func
(paren
id|ioaddr
op_plus
id|CONFIG_REG_0
comma
id|DLC_EN
)paren
suffix:semicolon
id|BITCLR
c_func
(paren
id|ioaddr
op_plus
id|CONFIG_REG_0
comma
id|DLC_EN
)paren
suffix:semicolon
id|eth16i_set_port
c_func
(paren
id|ioaddr
comma
id|i
)paren
suffix:semicolon
r_if
c_cond
(paren
id|eth16i_debug
OG
l_int|1
)paren
(brace
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;Set port number %d&bslash;n&quot;
comma
id|i
)paren
suffix:semicolon
)brace
id|retcode
op_assign
id|eth16i_send_probe_packet
c_func
(paren
id|ioaddr
comma
id|dummy_packet
comma
l_int|64
)paren
suffix:semicolon
r_if
c_cond
(paren
id|retcode
op_eq
l_int|0
)paren
(brace
id|retcode
op_assign
id|eth16i_receive_probe_packet
c_func
(paren
id|ioaddr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|retcode
op_ne
op_minus
l_int|1
)paren
(brace
r_if
c_cond
(paren
id|eth16i_debug
OG
l_int|1
)paren
(brace
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;Eth16i interface port found at %d&bslash;n&quot;
comma
id|i
)paren
suffix:semicolon
)brace
r_return
id|i
suffix:semicolon
)brace
)brace
r_else
(brace
r_if
c_cond
(paren
id|eth16i_debug
OG
l_int|1
)paren
(brace
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;TRANSMIT_DONE timeout when probing interface port&bslash;n&quot;
)paren
suffix:semicolon
)brace
)brace
)brace
r_if
c_cond
(paren
id|eth16i_debug
OG
l_int|1
)paren
(brace
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;Using default port&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_return
id|E_PORT_BNC
suffix:semicolon
)brace
DECL|function|eth16i_set_port
r_static
r_void
id|eth16i_set_port
c_func
(paren
r_int
id|ioaddr
comma
r_int
id|porttype
)paren
(brace
r_int
r_int
id|temp
op_assign
l_int|0
suffix:semicolon
id|eth16i_select_regbank
c_func
(paren
id|TRANSCEIVER_MODE_RB
comma
id|ioaddr
)paren
suffix:semicolon
id|outb
c_func
(paren
id|LOOPBACK_CONTROL
comma
id|ioaddr
op_plus
id|TRANSMIT_MODE_REG
)paren
suffix:semicolon
id|temp
op_or_assign
id|DIS_AUTO_PORT_SEL
suffix:semicolon
r_switch
c_cond
(paren
id|porttype
)paren
(brace
r_case
id|E_PORT_BNC
suffix:colon
id|temp
op_or_assign
id|AUI_SELECT
suffix:semicolon
r_break
suffix:semicolon
r_case
id|E_PORT_TP
suffix:colon
r_break
suffix:semicolon
r_case
id|E_PORT_DIX
suffix:colon
id|temp
op_or_assign
id|AUI_SELECT
suffix:semicolon
id|BITSET
c_func
(paren
id|ioaddr
op_plus
id|TRANSMIT_MODE_REG
comma
id|CONTROL_OUTPUT
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|outb
c_func
(paren
id|temp
comma
id|ioaddr
op_plus
id|TRANSCEIVER_MODE_REG
)paren
suffix:semicolon
r_if
c_cond
(paren
id|eth16i_debug
OG
l_int|1
)paren
(brace
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;TRANSMIT_MODE_REG = %x&bslash;n&quot;
comma
id|inb
c_func
(paren
id|ioaddr
op_plus
id|TRANSMIT_MODE_REG
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;TRANSCEIVER_MODE_REG = %x&bslash;n&quot;
comma
id|inb
c_func
(paren
id|ioaddr
op_plus
id|TRANSCEIVER_MODE_REG
)paren
)paren
suffix:semicolon
)brace
)brace
DECL|function|eth16i_send_probe_packet
r_static
r_int
id|eth16i_send_probe_packet
c_func
(paren
r_int
id|ioaddr
comma
r_int
r_char
op_star
id|b
comma
r_int
id|l
)paren
(brace
r_int
id|starttime
suffix:semicolon
id|outb
c_func
(paren
l_int|0xff
comma
id|ioaddr
op_plus
id|TX_STATUS_REG
)paren
suffix:semicolon
id|outw
c_func
(paren
id|l
comma
id|ioaddr
op_plus
id|DATAPORT
)paren
suffix:semicolon
id|outsw
c_func
(paren
id|ioaddr
op_plus
id|DATAPORT
comma
(paren
r_int
r_int
op_star
)paren
id|b
comma
(paren
id|l
op_plus
l_int|1
)paren
op_rshift
l_int|1
)paren
suffix:semicolon
id|starttime
op_assign
id|jiffies
suffix:semicolon
id|outb
c_func
(paren
id|TX_START
op_or
l_int|1
comma
id|ioaddr
op_plus
id|TRANSMIT_START_REG
)paren
suffix:semicolon
r_while
c_loop
(paren
(paren
id|inb
c_func
(paren
id|ioaddr
op_plus
id|TX_STATUS_REG
)paren
op_amp
l_int|0x80
)paren
op_eq
l_int|0
)paren
(brace
r_if
c_cond
(paren
(paren
id|jiffies
op_minus
id|starttime
)paren
OG
id|TX_TIMEOUT
)paren
(brace
r_return
op_minus
l_int|1
suffix:semicolon
)brace
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|eth16i_receive_probe_packet
r_static
r_int
id|eth16i_receive_probe_packet
c_func
(paren
r_int
id|ioaddr
)paren
(brace
r_int
id|starttime
suffix:semicolon
id|starttime
op_assign
id|jiffies
suffix:semicolon
r_while
c_loop
(paren
(paren
id|inb
c_func
(paren
id|ioaddr
op_plus
id|TX_STATUS_REG
)paren
op_amp
l_int|0x20
)paren
op_eq
l_int|0
)paren
(brace
r_if
c_cond
(paren
(paren
id|jiffies
op_minus
id|starttime
)paren
OG
id|TX_TIMEOUT
)paren
(brace
r_if
c_cond
(paren
id|eth16i_debug
OG
l_int|1
)paren
(brace
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;Timeout occurred waiting transmit packet received&bslash;n&quot;
)paren
suffix:semicolon
)brace
id|starttime
op_assign
id|jiffies
suffix:semicolon
r_while
c_loop
(paren
(paren
id|inb
c_func
(paren
id|ioaddr
op_plus
id|RX_STATUS_REG
)paren
op_amp
l_int|0x80
)paren
op_eq
l_int|0
)paren
(brace
r_if
c_cond
(paren
(paren
id|jiffies
op_minus
id|starttime
)paren
OG
id|TX_TIMEOUT
)paren
(brace
r_if
c_cond
(paren
id|eth16i_debug
OG
l_int|1
)paren
(brace
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;Timeout occurred waiting receive packet&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_return
op_minus
l_int|1
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|eth16i_debug
OG
l_int|1
)paren
(brace
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;RECEIVE_PACKET&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
multiline_comment|/* Found receive packet */
)brace
)brace
r_if
c_cond
(paren
id|eth16i_debug
OG
l_int|1
)paren
(brace
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;TRANSMIT_PACKET_RECEIVED %x&bslash;n&quot;
comma
id|inb
c_func
(paren
id|ioaddr
op_plus
id|TX_STATUS_REG
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;RX_STATUS_REG = %x&bslash;n&quot;
comma
id|inb
c_func
(paren
id|ioaddr
op_plus
id|RX_STATUS_REG
)paren
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
multiline_comment|/* Return success */
)brace
macro_line|#if 0
r_static
r_int
id|eth16i_set_irq
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_const
r_int
id|ioaddr
op_assign
id|dev-&gt;base_addr
suffix:semicolon
r_const
r_int
id|irq
op_assign
id|dev-&gt;irq
suffix:semicolon
r_int
id|i
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|ioaddr
OL
l_int|0x1000
)paren
(brace
r_while
c_loop
(paren
id|eth16i_irqmap
(braket
id|i
)braket
op_logical_and
id|eth16i_irqmap
(braket
id|i
)braket
op_ne
id|irq
)paren
(brace
id|i
op_increment
suffix:semicolon
)brace
r_if
c_cond
(paren
id|i
OL
id|NUM_OF_ISA_IRQS
)paren
(brace
id|u8
id|cbyte
op_assign
id|inb
c_func
(paren
id|ioaddr
op_plus
id|JUMPERLESS_CONFIG
)paren
suffix:semicolon
id|cbyte
op_assign
(paren
id|cbyte
op_amp
l_int|0x3F
)paren
op_or
(paren
id|i
op_lshift
l_int|6
)paren
suffix:semicolon
id|outb
c_func
(paren
id|cbyte
comma
id|ioaddr
op_plus
id|JUMPERLESS_CONFIG
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
)brace
r_else
(brace
id|printk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;%s: EISA Interrupt cannot be set. Use EISA Configuration utility.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
)brace
r_return
op_minus
l_int|1
suffix:semicolon
)brace
macro_line|#endif
DECL|function|eth16i_get_irq
r_static
r_int
id|eth16i_get_irq
c_func
(paren
r_int
id|ioaddr
)paren
(brace
r_int
r_char
id|cbyte
suffix:semicolon
r_if
c_cond
(paren
id|ioaddr
OL
l_int|0x1000
)paren
(brace
id|cbyte
op_assign
id|inb
c_func
(paren
id|ioaddr
op_plus
id|JUMPERLESS_CONFIG
)paren
suffix:semicolon
r_return
id|eth16i_irqmap
(braket
(paren
(paren
id|cbyte
op_amp
l_int|0xC0
)paren
op_rshift
l_int|6
)paren
)braket
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* Oh..the card is EISA so method getting IRQ different */
r_int
r_int
id|index
op_assign
l_int|0
suffix:semicolon
id|cbyte
op_assign
id|inb
c_func
(paren
id|ioaddr
op_plus
id|EISA_IRQ_REG
)paren
suffix:semicolon
r_while
c_loop
(paren
(paren
id|cbyte
op_amp
l_int|0x01
)paren
op_eq
l_int|0
)paren
(brace
id|cbyte
op_assign
id|cbyte
op_rshift
l_int|1
suffix:semicolon
id|index
op_increment
suffix:semicolon
)brace
r_return
id|eth32i_irqmap
(braket
id|index
)braket
suffix:semicolon
)brace
)brace
DECL|function|eth16i_check_signature
r_static
r_int
id|eth16i_check_signature
c_func
(paren
r_int
id|ioaddr
)paren
(brace
r_int
id|i
suffix:semicolon
r_int
r_char
id|creg
(braket
l_int|4
)braket
op_assign
(brace
l_int|0
)brace
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|4
suffix:semicolon
id|i
op_increment
)paren
(brace
id|creg
(braket
id|i
)braket
op_assign
id|inb
c_func
(paren
id|ioaddr
op_plus
id|TRANSMIT_MODE_REG
op_plus
id|i
)paren
suffix:semicolon
r_if
c_cond
(paren
id|eth16i_debug
OG
l_int|1
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;eth16i: read signature byte %x at %x&bslash;n&quot;
comma
id|creg
(braket
id|i
)braket
comma
id|ioaddr
op_plus
id|TRANSMIT_MODE_REG
op_plus
id|i
)paren
suffix:semicolon
)brace
)brace
id|creg
(braket
l_int|0
)braket
op_and_assign
l_int|0x0F
suffix:semicolon
multiline_comment|/* Mask collision cnr */
id|creg
(braket
l_int|2
)braket
op_and_assign
l_int|0x7F
suffix:semicolon
multiline_comment|/* Mask DCLEN bit */
macro_line|#if 0
multiline_comment|/* &n;&t;   This was removed because the card was sometimes left to state&n;&t;   from which it couldn&squot;t be find anymore. If there is need&n;&t;   to more strict check still this have to be fixed.&n;&t;   */
r_if
c_cond
(paren
op_logical_neg
(paren
(paren
id|creg
(braket
l_int|0
)braket
op_eq
l_int|0x06
)paren
op_logical_and
(paren
id|creg
(braket
l_int|1
)braket
op_eq
l_int|0x41
)paren
)paren
)paren
(brace
r_if
c_cond
(paren
id|creg
(braket
l_int|1
)braket
op_ne
l_int|0x42
)paren
(brace
r_return
op_minus
l_int|1
suffix:semicolon
)brace
)brace
macro_line|#endif
r_if
c_cond
(paren
op_logical_neg
(paren
(paren
id|creg
(braket
l_int|2
)braket
op_eq
l_int|0x36
)paren
op_logical_and
(paren
id|creg
(braket
l_int|3
)braket
op_eq
l_int|0xE0
)paren
)paren
)paren
(brace
id|creg
(braket
l_int|2
)braket
op_and_assign
l_int|0x40
suffix:semicolon
id|creg
(braket
l_int|3
)braket
op_and_assign
l_int|0x03
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
(paren
id|creg
(braket
l_int|2
)braket
op_eq
l_int|0x40
)paren
op_logical_and
(paren
id|creg
(braket
l_int|3
)braket
op_eq
l_int|0x00
)paren
)paren
)paren
(brace
r_return
op_minus
l_int|1
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|eth16i_read_eeprom
c_func
(paren
id|ioaddr
comma
id|E_NODEID_0
)paren
op_ne
l_int|0
)paren
(brace
r_return
op_minus
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|eth16i_read_eeprom
c_func
(paren
id|ioaddr
comma
id|E_NODEID_1
)paren
op_amp
l_int|0xFF00
)paren
op_ne
l_int|0x4B00
)paren
(brace
r_return
op_minus
l_int|1
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|eth16i_read_eeprom
r_static
r_int
id|eth16i_read_eeprom
c_func
(paren
r_int
id|ioaddr
comma
r_int
id|offset
)paren
(brace
r_int
id|data
op_assign
l_int|0
suffix:semicolon
id|eth16i_eeprom_cmd
c_func
(paren
id|ioaddr
comma
id|EEPROM_READ
op_or
id|offset
)paren
suffix:semicolon
id|outb
c_func
(paren
id|CS_1
comma
id|ioaddr
op_plus
id|EEPROM_CTRL_REG
)paren
suffix:semicolon
id|data
op_assign
id|eth16i_read_eeprom_word
c_func
(paren
id|ioaddr
)paren
suffix:semicolon
id|outb
c_func
(paren
id|CS_0
op_or
id|SK_0
comma
id|ioaddr
op_plus
id|EEPROM_CTRL_REG
)paren
suffix:semicolon
r_return
id|data
suffix:semicolon
)brace
DECL|function|eth16i_read_eeprom_word
r_static
r_int
id|eth16i_read_eeprom_word
c_func
(paren
r_int
id|ioaddr
)paren
(brace
r_int
id|i
suffix:semicolon
r_int
id|data
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|16
suffix:semicolon
id|i
OG
l_int|0
suffix:semicolon
id|i
op_decrement
)paren
(brace
id|outb
c_func
(paren
id|CS_1
op_or
id|SK_0
comma
id|ioaddr
op_plus
id|EEPROM_CTRL_REG
)paren
suffix:semicolon
id|eeprom_slow_io
c_func
(paren
)paren
suffix:semicolon
id|outb
c_func
(paren
id|CS_1
op_or
id|SK_1
comma
id|ioaddr
op_plus
id|EEPROM_CTRL_REG
)paren
suffix:semicolon
id|eeprom_slow_io
c_func
(paren
)paren
suffix:semicolon
id|data
op_assign
(paren
id|data
op_lshift
l_int|1
)paren
op_or
(paren
(paren
id|inb
c_func
(paren
id|ioaddr
op_plus
id|EEPROM_DATA_REG
)paren
op_amp
id|DI_1
)paren
ques
c_cond
l_int|1
suffix:colon
l_int|0
)paren
suffix:semicolon
id|eeprom_slow_io
c_func
(paren
)paren
suffix:semicolon
)brace
r_return
id|data
suffix:semicolon
)brace
DECL|function|eth16i_eeprom_cmd
r_static
r_void
id|eth16i_eeprom_cmd
c_func
(paren
r_int
id|ioaddr
comma
r_int
r_char
id|command
)paren
(brace
r_int
id|i
suffix:semicolon
id|outb
c_func
(paren
id|CS_0
op_or
id|SK_0
comma
id|ioaddr
op_plus
id|EEPROM_CTRL_REG
)paren
suffix:semicolon
id|outb
c_func
(paren
id|DI_0
comma
id|ioaddr
op_plus
id|EEPROM_DATA_REG
)paren
suffix:semicolon
id|outb
c_func
(paren
id|CS_1
op_or
id|SK_0
comma
id|ioaddr
op_plus
id|EEPROM_CTRL_REG
)paren
suffix:semicolon
id|outb
c_func
(paren
id|DI_1
comma
id|ioaddr
op_plus
id|EEPROM_DATA_REG
)paren
suffix:semicolon
id|outb
c_func
(paren
id|CS_1
op_or
id|SK_1
comma
id|ioaddr
op_plus
id|EEPROM_CTRL_REG
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|7
suffix:semicolon
id|i
op_ge
l_int|0
suffix:semicolon
id|i
op_decrement
)paren
(brace
r_int
id|cmd
op_assign
(paren
(paren
id|command
op_amp
(paren
l_int|1
op_lshift
id|i
)paren
)paren
ques
c_cond
id|DI_1
suffix:colon
id|DI_0
)paren
suffix:semicolon
id|outb
c_func
(paren
id|cmd
comma
id|ioaddr
op_plus
id|EEPROM_DATA_REG
)paren
suffix:semicolon
id|outb
c_func
(paren
id|CS_1
op_or
id|SK_0
comma
id|ioaddr
op_plus
id|EEPROM_CTRL_REG
)paren
suffix:semicolon
id|eeprom_slow_io
c_func
(paren
)paren
suffix:semicolon
id|outb
c_func
(paren
id|CS_1
op_or
id|SK_1
comma
id|ioaddr
op_plus
id|EEPROM_CTRL_REG
)paren
suffix:semicolon
id|eeprom_slow_io
c_func
(paren
)paren
suffix:semicolon
)brace
)brace
DECL|function|eth16i_open
r_static
r_int
id|eth16i_open
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|eth16i_local
op_star
id|lp
op_assign
(paren
r_struct
id|eth16i_local
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_int
id|ioaddr
op_assign
id|dev-&gt;base_addr
suffix:semicolon
multiline_comment|/* Powerup the chip */
id|outb
c_func
(paren
l_int|0xc0
op_or
id|POWERUP
comma
id|ioaddr
op_plus
id|CONFIG_REG_1
)paren
suffix:semicolon
multiline_comment|/* Initialize the chip */
id|eth16i_initialize
c_func
(paren
id|dev
)paren
suffix:semicolon
multiline_comment|/* Set the transmit buffer size */
id|lp-&gt;tx_buf_size
op_assign
id|eth16i_tx_buf_map
(braket
id|ETH16I_TX_BUF_SIZE
op_amp
l_int|0x03
)braket
suffix:semicolon
r_if
c_cond
(paren
id|eth16i_debug
OG
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%s: transmit buffer size %d&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|lp-&gt;tx_buf_size
)paren
suffix:semicolon
)brace
multiline_comment|/* Now enable Transmitter and Receiver sections */
id|BITCLR
c_func
(paren
id|ioaddr
op_plus
id|CONFIG_REG_0
comma
id|DLC_EN
)paren
suffix:semicolon
multiline_comment|/* Now switch to register bank 2, for run time operation */
id|eth16i_select_regbank
c_func
(paren
l_int|2
comma
id|ioaddr
)paren
suffix:semicolon
id|lp-&gt;open_time
op_assign
id|jiffies
suffix:semicolon
id|lp-&gt;tx_started
op_assign
l_int|0
suffix:semicolon
id|lp-&gt;tx_queue
op_assign
l_int|0
suffix:semicolon
id|lp-&gt;tx_queue_len
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Turn on interrupts*/
id|outw
c_func
(paren
id|ETH16I_INTR_ON
comma
id|ioaddr
op_plus
id|TX_INTR_REG
)paren
suffix:semicolon
id|netif_start_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|eth16i_close
r_static
r_int
id|eth16i_close
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|eth16i_local
op_star
id|lp
op_assign
(paren
r_struct
id|eth16i_local
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_int
id|ioaddr
op_assign
id|dev-&gt;base_addr
suffix:semicolon
id|eth16i_reset
c_func
(paren
id|dev
)paren
suffix:semicolon
multiline_comment|/* Turn off interrupts*/
id|outw
c_func
(paren
id|ETH16I_INTR_OFF
comma
id|ioaddr
op_plus
id|TX_INTR_REG
)paren
suffix:semicolon
id|netif_stop_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
id|lp-&gt;open_time
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Disable transmit and receive */
id|BITSET
c_func
(paren
id|ioaddr
op_plus
id|CONFIG_REG_0
comma
id|DLC_EN
)paren
suffix:semicolon
multiline_comment|/* Reset the chip */
multiline_comment|/* outb(0xff, ioaddr + RESET); */
multiline_comment|/* outw(0xffff, ioaddr + TX_STATUS_REG);    */
id|outb
c_func
(paren
l_int|0x00
comma
id|ioaddr
op_plus
id|CONFIG_REG_1
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|eth16i_timeout
r_static
r_void
id|eth16i_timeout
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|eth16i_local
op_star
id|lp
op_assign
(paren
r_struct
id|eth16i_local
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_int
id|ioaddr
op_assign
id|dev-&gt;base_addr
suffix:semicolon
multiline_comment|/* &n;&t;   If we get here, some higher level has decided that &n;&t;   we are broken. There should really be a &quot;kick me&quot; &n;&t;   function call instead. &n;&t;   */
id|outw
c_func
(paren
id|ETH16I_INTR_OFF
comma
id|ioaddr
op_plus
id|TX_INTR_REG
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: transmit timed out with status %04x, %s ?&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|inw
c_func
(paren
id|ioaddr
op_plus
id|TX_STATUS_REG
)paren
comma
(paren
id|inb
c_func
(paren
id|ioaddr
op_plus
id|TX_STATUS_REG
)paren
op_amp
id|TX_DONE
)paren
ques
c_cond
l_string|&quot;IRQ conflict&quot;
suffix:colon
l_string|&quot;network cable problem&quot;
)paren
suffix:semicolon
id|dev-&gt;trans_start
op_assign
id|jiffies
suffix:semicolon
multiline_comment|/* Let&squot;s dump all registers */
r_if
c_cond
(paren
id|eth16i_debug
OG
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%s: timeout: %02x %02x %02x %02x %02x %02x %02x %02x.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|inb
c_func
(paren
id|ioaddr
op_plus
l_int|0
)paren
comma
id|inb
c_func
(paren
id|ioaddr
op_plus
l_int|1
)paren
comma
id|inb
c_func
(paren
id|ioaddr
op_plus
l_int|2
)paren
comma
id|inb
c_func
(paren
id|ioaddr
op_plus
l_int|3
)paren
comma
id|inb
c_func
(paren
id|ioaddr
op_plus
l_int|4
)paren
comma
id|inb
c_func
(paren
id|ioaddr
op_plus
l_int|5
)paren
comma
id|inb
c_func
(paren
id|ioaddr
op_plus
l_int|6
)paren
comma
id|inb
c_func
(paren
id|ioaddr
op_plus
l_int|7
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%s: transmit start reg: %02x. collision reg %02x&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|inb
c_func
(paren
id|ioaddr
op_plus
id|TRANSMIT_START_REG
)paren
comma
id|inb
c_func
(paren
id|ioaddr
op_plus
id|COL_16_REG
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;lp-&gt;tx_queue = %d&bslash;n&quot;
comma
id|lp-&gt;tx_queue
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;lp-&gt;tx_queue_len = %d&bslash;n&quot;
comma
id|lp-&gt;tx_queue_len
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;lp-&gt;tx_started = %d&bslash;n&quot;
comma
id|lp-&gt;tx_started
)paren
suffix:semicolon
)brace
id|lp-&gt;stats.tx_errors
op_increment
suffix:semicolon
id|eth16i_reset
c_func
(paren
id|dev
)paren
suffix:semicolon
id|dev-&gt;trans_start
op_assign
id|jiffies
suffix:semicolon
id|outw
c_func
(paren
id|ETH16I_INTR_ON
comma
id|ioaddr
op_plus
id|TX_INTR_REG
)paren
suffix:semicolon
id|netif_wake_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
DECL|function|eth16i_tx
r_static
r_int
id|eth16i_tx
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|eth16i_local
op_star
id|lp
op_assign
(paren
r_struct
id|eth16i_local
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_int
id|ioaddr
op_assign
id|dev-&gt;base_addr
suffix:semicolon
r_int
id|status
op_assign
l_int|0
suffix:semicolon
id|ushort
id|length
op_assign
id|ETH_ZLEN
OL
id|skb-&gt;len
ques
c_cond
id|skb-&gt;len
suffix:colon
id|ETH_ZLEN
suffix:semicolon
r_int
r_char
op_star
id|buf
op_assign
id|skb-&gt;data
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|netif_stop_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
multiline_comment|/* Turn off TX interrupts */
id|outw
c_func
(paren
id|ETH16I_INTR_OFF
comma
id|ioaddr
op_plus
id|TX_INTR_REG
)paren
suffix:semicolon
multiline_comment|/* We would be better doing the disable_irq tricks the 3c509 does,&n;&t;   that would make this suck a lot less */
id|spin_lock_irqsave
c_func
(paren
op_amp
id|lp-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|length
op_plus
l_int|2
)paren
OG
(paren
id|lp-&gt;tx_buf_size
op_minus
id|lp-&gt;tx_queue_len
)paren
)paren
(brace
r_if
c_cond
(paren
id|eth16i_debug
OG
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: Transmit buffer full.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
id|outw
c_func
(paren
id|length
comma
id|ioaddr
op_plus
id|DATAPORT
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ioaddr
OL
l_int|0x1000
)paren
(brace
id|outsw
c_func
(paren
id|ioaddr
op_plus
id|DATAPORT
comma
id|buf
comma
(paren
id|length
op_plus
l_int|1
)paren
op_rshift
l_int|1
)paren
suffix:semicolon
)brace
r_else
(brace
r_int
r_char
id|frag
op_assign
id|length
op_mod
l_int|4
suffix:semicolon
id|outsl
c_func
(paren
id|ioaddr
op_plus
id|DATAPORT
comma
id|buf
comma
id|length
op_rshift
l_int|2
)paren
suffix:semicolon
r_if
c_cond
(paren
id|frag
op_ne
l_int|0
)paren
(brace
id|outsw
c_func
(paren
id|ioaddr
op_plus
id|DATAPORT
comma
(paren
id|buf
op_plus
(paren
id|length
op_amp
l_int|0xFFFC
)paren
)paren
comma
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|frag
op_eq
l_int|3
)paren
(brace
id|outsw
c_func
(paren
id|ioaddr
op_plus
id|DATAPORT
comma
(paren
id|buf
op_plus
(paren
id|length
op_amp
l_int|0xFFFC
)paren
op_plus
l_int|2
)paren
comma
l_int|1
)paren
suffix:semicolon
)brace
)brace
)brace
id|lp-&gt;tx_buffered_packets
op_increment
suffix:semicolon
id|lp-&gt;tx_buffered_bytes
op_assign
id|length
suffix:semicolon
id|lp-&gt;tx_queue
op_increment
suffix:semicolon
id|lp-&gt;tx_queue_len
op_add_assign
id|length
op_plus
l_int|2
suffix:semicolon
)brace
id|lp-&gt;tx_buf_busy
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|lp-&gt;tx_started
op_eq
l_int|0
)paren
(brace
multiline_comment|/* If the transmitter is idle..always trigger a transmit */
id|outb
c_func
(paren
id|TX_START
op_or
id|lp-&gt;tx_queue
comma
id|ioaddr
op_plus
id|TRANSMIT_START_REG
)paren
suffix:semicolon
id|lp-&gt;tx_queue
op_assign
l_int|0
suffix:semicolon
id|lp-&gt;tx_queue_len
op_assign
l_int|0
suffix:semicolon
id|dev-&gt;trans_start
op_assign
id|jiffies
suffix:semicolon
id|lp-&gt;tx_started
op_assign
l_int|1
suffix:semicolon
id|netif_wake_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|lp-&gt;tx_queue_len
OL
id|lp-&gt;tx_buf_size
op_minus
(paren
id|ETH_FRAME_LEN
op_plus
l_int|2
)paren
)paren
(brace
multiline_comment|/* There is still more room for one more packet in tx buffer */
id|netif_wake_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|lp-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|outw
c_func
(paren
id|ETH16I_INTR_ON
comma
id|ioaddr
op_plus
id|TX_INTR_REG
)paren
suffix:semicolon
multiline_comment|/* Turn TX interrupts back on */
multiline_comment|/* outb(TX_INTR_DONE | TX_INTR_16_COL, ioaddr + TX_INTR_REG); */
id|status
op_assign
l_int|0
suffix:semicolon
id|dev_kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|eth16i_rx
r_static
r_void
id|eth16i_rx
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|eth16i_local
op_star
id|lp
op_assign
(paren
r_struct
id|eth16i_local
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_int
id|ioaddr
op_assign
id|dev-&gt;base_addr
suffix:semicolon
r_int
id|boguscount
op_assign
id|MAX_RX_LOOP
suffix:semicolon
multiline_comment|/* Loop until all packets have been read */
r_while
c_loop
(paren
(paren
id|inb
c_func
(paren
id|ioaddr
op_plus
id|RECEIVE_MODE_REG
)paren
op_amp
id|RX_BUFFER_EMPTY
)paren
op_eq
l_int|0
)paren
(brace
multiline_comment|/* Read status byte from receive buffer */
id|ushort
id|status
op_assign
id|inw
c_func
(paren
id|ioaddr
op_plus
id|DATAPORT
)paren
suffix:semicolon
multiline_comment|/* Get the size of the packet from receive buffer */
id|ushort
id|pkt_len
op_assign
id|inw
c_func
(paren
id|ioaddr
op_plus
id|DATAPORT
)paren
suffix:semicolon
r_if
c_cond
(paren
id|eth16i_debug
OG
l_int|4
)paren
(brace
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%s: Receiving packet mode %02x status %04x.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|inb
c_func
(paren
id|ioaddr
op_plus
id|RECEIVE_MODE_REG
)paren
comma
id|status
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|status
op_amp
id|PKT_GOOD
)paren
)paren
(brace
id|lp-&gt;stats.rx_errors
op_increment
suffix:semicolon
r_if
c_cond
(paren
(paren
id|pkt_len
OL
id|ETH_ZLEN
)paren
op_logical_or
(paren
id|pkt_len
OG
id|ETH_FRAME_LEN
)paren
)paren
(brace
id|lp-&gt;stats.rx_length_errors
op_increment
suffix:semicolon
id|eth16i_reset
c_func
(paren
id|dev
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_else
(brace
id|eth16i_skip_packet
c_func
(paren
id|dev
)paren
suffix:semicolon
id|lp-&gt;stats.rx_dropped
op_increment
suffix:semicolon
)brace
)brace
r_else
(brace
multiline_comment|/* Ok so now we should have a good packet */
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
id|skb
op_assign
id|dev_alloc_skb
c_func
(paren
id|pkt_len
op_plus
l_int|3
)paren
suffix:semicolon
r_if
c_cond
(paren
id|skb
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: Could&squot;n allocate memory for packet (len %d)&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|pkt_len
)paren
suffix:semicolon
id|eth16i_skip_packet
c_func
(paren
id|dev
)paren
suffix:semicolon
id|lp-&gt;stats.rx_dropped
op_increment
suffix:semicolon
r_break
suffix:semicolon
)brace
id|skb-&gt;dev
op_assign
id|dev
suffix:semicolon
id|skb_reserve
c_func
(paren
id|skb
comma
l_int|2
)paren
suffix:semicolon
multiline_comment|/* &n;&t;&t;&t;   Now let&squot;s get the packet out of buffer.&n;&t;&t;&t;   size is (pkt_len + 1) &gt;&gt; 1, cause we are now reading words&n;&t;&t;&t;   and it have to be even aligned.&n;&t;&t;&t;   */
r_if
c_cond
(paren
id|ioaddr
OL
l_int|0x1000
)paren
(brace
id|insw
c_func
(paren
id|ioaddr
op_plus
id|DATAPORT
comma
id|skb_put
c_func
(paren
id|skb
comma
id|pkt_len
)paren
comma
(paren
id|pkt_len
op_plus
l_int|1
)paren
op_rshift
l_int|1
)paren
suffix:semicolon
)brace
r_else
(brace
r_int
r_char
op_star
id|buf
op_assign
id|skb_put
c_func
(paren
id|skb
comma
id|pkt_len
)paren
suffix:semicolon
r_int
r_char
id|frag
op_assign
id|pkt_len
op_mod
l_int|4
suffix:semicolon
id|insl
c_func
(paren
id|ioaddr
op_plus
id|DATAPORT
comma
id|buf
comma
id|pkt_len
op_rshift
l_int|2
)paren
suffix:semicolon
r_if
c_cond
(paren
id|frag
op_ne
l_int|0
)paren
(brace
r_int
r_int
id|rest
(braket
l_int|2
)braket
suffix:semicolon
id|rest
(braket
l_int|0
)braket
op_assign
id|inw
c_func
(paren
id|ioaddr
op_plus
id|DATAPORT
)paren
suffix:semicolon
r_if
c_cond
(paren
id|frag
op_eq
l_int|3
)paren
(brace
id|rest
(braket
l_int|1
)braket
op_assign
id|inw
c_func
(paren
id|ioaddr
op_plus
id|DATAPORT
)paren
suffix:semicolon
)brace
id|memcpy
c_func
(paren
id|buf
op_plus
(paren
id|pkt_len
op_amp
l_int|0xfffc
)paren
comma
(paren
r_char
op_star
)paren
id|rest
comma
id|frag
)paren
suffix:semicolon
)brace
)brace
id|skb-&gt;protocol
op_assign
id|eth_type_trans
c_func
(paren
id|skb
comma
id|dev
)paren
suffix:semicolon
id|netif_rx
c_func
(paren
id|skb
)paren
suffix:semicolon
id|lp-&gt;stats.rx_packets
op_increment
suffix:semicolon
id|lp-&gt;stats.rx_bytes
op_add_assign
id|pkt_len
suffix:semicolon
r_if
c_cond
(paren
id|eth16i_debug
OG
l_int|5
)paren
(brace
r_int
id|i
suffix:semicolon
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%s: Received packet of length %d.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|pkt_len
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|14
suffix:semicolon
id|i
op_increment
)paren
(brace
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot; %02x&quot;
comma
id|skb-&gt;data
(braket
id|i
)braket
)paren
suffix:semicolon
)brace
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;.&bslash;n&quot;
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* else */
r_if
c_cond
(paren
op_decrement
id|boguscount
op_le
l_int|0
)paren
(brace
r_break
suffix:semicolon
)brace
)brace
multiline_comment|/* while */
)brace
DECL|function|eth16i_interrupt
r_static
r_void
id|eth16i_interrupt
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_struct
id|net_device
op_star
id|dev
op_assign
id|dev_id
suffix:semicolon
r_struct
id|eth16i_local
op_star
id|lp
suffix:semicolon
r_int
id|ioaddr
op_assign
l_int|0
comma
id|status
suffix:semicolon
id|ioaddr
op_assign
id|dev-&gt;base_addr
suffix:semicolon
id|lp
op_assign
(paren
r_struct
id|eth16i_local
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
multiline_comment|/* Turn off all interrupts from adapter */
id|outw
c_func
(paren
id|ETH16I_INTR_OFF
comma
id|ioaddr
op_plus
id|TX_INTR_REG
)paren
suffix:semicolon
multiline_comment|/* eth16i_tx wont be called */
id|spin_lock
c_func
(paren
op_amp
id|lp-&gt;lock
)paren
suffix:semicolon
id|status
op_assign
id|inw
c_func
(paren
id|ioaddr
op_plus
id|TX_STATUS_REG
)paren
suffix:semicolon
multiline_comment|/* Get the status */
id|outw
c_func
(paren
id|status
comma
id|ioaddr
op_plus
id|TX_STATUS_REG
)paren
suffix:semicolon
multiline_comment|/* Clear status bits */
r_if
c_cond
(paren
id|eth16i_debug
OG
l_int|3
)paren
(brace
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%s: Interrupt with status %04x.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|status
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|status
op_amp
l_int|0x7f00
)paren
(brace
id|lp-&gt;stats.rx_errors
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
(paren
id|BUS_RD_ERR
op_lshift
l_int|8
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: Bus read error.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|status
op_amp
(paren
id|SHORT_PKT_ERR
op_lshift
l_int|8
)paren
)paren
(brace
id|lp-&gt;stats.rx_length_errors
op_increment
suffix:semicolon
)brace
r_if
c_cond
(paren
id|status
op_amp
(paren
id|ALIGN_ERR
op_lshift
l_int|8
)paren
)paren
(brace
id|lp-&gt;stats.rx_frame_errors
op_increment
suffix:semicolon
)brace
r_if
c_cond
(paren
id|status
op_amp
(paren
id|CRC_ERR
op_lshift
l_int|8
)paren
)paren
(brace
id|lp-&gt;stats.rx_crc_errors
op_increment
suffix:semicolon
)brace
r_if
c_cond
(paren
id|status
op_amp
(paren
id|RX_BUF_OVERFLOW
op_lshift
l_int|8
)paren
)paren
(brace
id|lp-&gt;stats.rx_over_errors
op_increment
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|status
op_amp
l_int|0x001a
)paren
(brace
id|lp-&gt;stats.tx_errors
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
id|CR_LOST
)paren
(brace
id|lp-&gt;stats.tx_carrier_errors
op_increment
suffix:semicolon
)brace
r_if
c_cond
(paren
id|status
op_amp
id|TX_JABBER_ERR
)paren
(brace
id|lp-&gt;stats.tx_window_errors
op_increment
suffix:semicolon
)brace
macro_line|#if 0&t;       
r_if
c_cond
(paren
id|status
op_amp
id|COLLISION
)paren
(brace
id|lp-&gt;stats.collisions
op_add_assign
(paren
(paren
id|inb
c_func
(paren
id|ioaddr
op_plus
id|TRANSMIT_MODE_REG
)paren
op_amp
l_int|0xF0
)paren
op_rshift
l_int|4
)paren
suffix:semicolon
)brace
macro_line|#endif
r_if
c_cond
(paren
id|status
op_amp
id|COLLISIONS_16
)paren
(brace
r_if
c_cond
(paren
id|lp-&gt;col_16
OL
id|MAX_COL_16
)paren
(brace
id|lp-&gt;col_16
op_increment
suffix:semicolon
id|lp-&gt;stats.collisions
op_increment
suffix:semicolon
multiline_comment|/* Resume transmitting, skip failed packet */
id|outb
c_func
(paren
l_int|0x02
comma
id|ioaddr
op_plus
id|COL_16_REG
)paren
suffix:semicolon
)brace
r_else
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: bailing out due to many consecutive 16-in-a-row collisions. Network cable problem?&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
)brace
)brace
)brace
r_if
c_cond
(paren
id|status
op_amp
l_int|0x00ff
)paren
(brace
multiline_comment|/* Let&squot;s check the transmit status reg */
r_if
c_cond
(paren
id|status
op_amp
id|TX_DONE
)paren
(brace
multiline_comment|/* The transmit has been done */
id|lp-&gt;stats.tx_packets
op_assign
id|lp-&gt;tx_buffered_packets
suffix:semicolon
id|lp-&gt;stats.tx_bytes
op_add_assign
id|lp-&gt;tx_buffered_bytes
suffix:semicolon
id|lp-&gt;col_16
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|lp-&gt;tx_queue
)paren
(brace
multiline_comment|/* Is there still packets ? */
multiline_comment|/* There was packet(s) so start transmitting and write also&n;&t;&t;&t;&t;   how many packets there is to be sended */
id|outb
c_func
(paren
id|TX_START
op_or
id|lp-&gt;tx_queue
comma
id|ioaddr
op_plus
id|TRANSMIT_START_REG
)paren
suffix:semicolon
id|lp-&gt;tx_queue
op_assign
l_int|0
suffix:semicolon
id|lp-&gt;tx_queue_len
op_assign
l_int|0
suffix:semicolon
id|lp-&gt;tx_started
op_assign
l_int|1
suffix:semicolon
)brace
r_else
(brace
id|lp-&gt;tx_started
op_assign
l_int|0
suffix:semicolon
)brace
id|netif_wake_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
(paren
id|status
op_amp
l_int|0x8000
)paren
op_logical_or
(paren
(paren
id|inb
c_func
(paren
id|ioaddr
op_plus
id|RECEIVE_MODE_REG
)paren
op_amp
id|RX_BUFFER_EMPTY
)paren
op_eq
l_int|0
)paren
)paren
(brace
id|eth16i_rx
c_func
(paren
id|dev
)paren
suffix:semicolon
multiline_comment|/* We have packet in receive buffer */
)brace
multiline_comment|/* Turn interrupts back on */
id|outw
c_func
(paren
id|ETH16I_INTR_ON
comma
id|ioaddr
op_plus
id|TX_INTR_REG
)paren
suffix:semicolon
r_if
c_cond
(paren
id|lp-&gt;tx_queue_len
OL
id|lp-&gt;tx_buf_size
op_minus
(paren
id|ETH_FRAME_LEN
op_plus
l_int|2
)paren
)paren
(brace
multiline_comment|/* There is still more room for one more packet in tx buffer */
id|netif_wake_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
id|spin_unlock
c_func
(paren
op_amp
id|lp-&gt;lock
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
DECL|function|eth16i_skip_packet
r_static
r_void
id|eth16i_skip_packet
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_int
id|ioaddr
op_assign
id|dev-&gt;base_addr
suffix:semicolon
id|inw
c_func
(paren
id|ioaddr
op_plus
id|DATAPORT
)paren
suffix:semicolon
id|inw
c_func
(paren
id|ioaddr
op_plus
id|DATAPORT
)paren
suffix:semicolon
id|inw
c_func
(paren
id|ioaddr
op_plus
id|DATAPORT
)paren
suffix:semicolon
id|outb
c_func
(paren
id|SKIP_RX_PACKET
comma
id|ioaddr
op_plus
id|FILTER_SELF_RX_REG
)paren
suffix:semicolon
r_while
c_loop
(paren
id|inb
c_func
(paren
id|ioaddr
op_plus
id|FILTER_SELF_RX_REG
)paren
op_ne
l_int|0
)paren
(brace
suffix:semicolon
)brace
)brace
DECL|function|eth16i_reset
r_static
r_void
id|eth16i_reset
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|eth16i_local
op_star
id|lp
op_assign
(paren
r_struct
id|eth16i_local
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_int
id|ioaddr
op_assign
id|dev-&gt;base_addr
suffix:semicolon
r_if
c_cond
(paren
id|eth16i_debug
OG
l_int|1
)paren
(brace
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%s: Resetting device.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
)brace
id|BITSET
c_func
(paren
id|ioaddr
op_plus
id|CONFIG_REG_0
comma
id|DLC_EN
)paren
suffix:semicolon
id|outw
c_func
(paren
l_int|0xffff
comma
id|ioaddr
op_plus
id|TX_STATUS_REG
)paren
suffix:semicolon
id|eth16i_select_regbank
c_func
(paren
l_int|2
comma
id|ioaddr
)paren
suffix:semicolon
id|lp-&gt;tx_started
op_assign
l_int|0
suffix:semicolon
id|lp-&gt;tx_buf_busy
op_assign
l_int|0
suffix:semicolon
id|lp-&gt;tx_queue
op_assign
l_int|0
suffix:semicolon
id|lp-&gt;tx_queue_len
op_assign
l_int|0
suffix:semicolon
id|BITCLR
c_func
(paren
id|ioaddr
op_plus
id|CONFIG_REG_0
comma
id|DLC_EN
)paren
suffix:semicolon
)brace
DECL|function|eth16i_multicast
r_static
r_void
id|eth16i_multicast
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_int
id|ioaddr
op_assign
id|dev-&gt;base_addr
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;mc_count
op_logical_or
id|dev-&gt;flags
op_amp
(paren
id|IFF_ALLMULTI
op_or
id|IFF_PROMISC
)paren
)paren
(brace
id|dev-&gt;flags
op_or_assign
id|IFF_PROMISC
suffix:semicolon
multiline_comment|/* Must do this */
id|outb
c_func
(paren
l_int|3
comma
id|ioaddr
op_plus
id|RECEIVE_MODE_REG
)paren
suffix:semicolon
)brace
r_else
(brace
id|outb
c_func
(paren
l_int|2
comma
id|ioaddr
op_plus
id|RECEIVE_MODE_REG
)paren
suffix:semicolon
)brace
)brace
DECL|function|eth16i_get_stats
r_static
r_struct
id|net_device_stats
op_star
id|eth16i_get_stats
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|eth16i_local
op_star
id|lp
op_assign
(paren
r_struct
id|eth16i_local
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_return
op_amp
id|lp-&gt;stats
suffix:semicolon
)brace
DECL|function|eth16i_select_regbank
r_static
r_void
id|eth16i_select_regbank
c_func
(paren
r_int
r_char
id|banknbr
comma
r_int
id|ioaddr
)paren
(brace
r_int
r_char
id|data
suffix:semicolon
id|data
op_assign
id|inb
c_func
(paren
id|ioaddr
op_plus
id|CONFIG_REG_1
)paren
suffix:semicolon
id|outb
c_func
(paren
(paren
(paren
id|data
op_amp
l_int|0xF3
)paren
op_or
(paren
(paren
id|banknbr
op_amp
l_int|0x03
)paren
op_lshift
l_int|2
)paren
)paren
comma
id|ioaddr
op_plus
id|CONFIG_REG_1
)paren
suffix:semicolon
)brace
macro_line|#ifdef MODULE
DECL|function|eth16i_parse_mediatype
r_static
id|ushort
id|eth16i_parse_mediatype
c_func
(paren
r_const
r_char
op_star
id|s
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|s
)paren
(brace
r_return
id|E_PORT_FROM_EPROM
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|strncmp
c_func
(paren
id|s
comma
l_string|&quot;bnc&quot;
comma
l_int|3
)paren
)paren
r_return
id|E_PORT_BNC
suffix:semicolon
r_else
r_if
c_cond
(paren
op_logical_neg
id|strncmp
c_func
(paren
id|s
comma
l_string|&quot;tp&quot;
comma
l_int|2
)paren
)paren
r_return
id|E_PORT_TP
suffix:semicolon
r_else
r_if
c_cond
(paren
op_logical_neg
id|strncmp
c_func
(paren
id|s
comma
l_string|&quot;dix&quot;
comma
l_int|3
)paren
)paren
r_return
id|E_PORT_DIX
suffix:semicolon
r_else
r_if
c_cond
(paren
op_logical_neg
id|strncmp
c_func
(paren
id|s
comma
l_string|&quot;auto&quot;
comma
l_int|4
)paren
)paren
r_return
id|E_PORT_AUTO
suffix:semicolon
r_else
r_return
id|E_PORT_FROM_EPROM
suffix:semicolon
)brace
DECL|macro|MAX_ETH16I_CARDS
mdefine_line|#define MAX_ETH16I_CARDS 4  /* Max number of Eth16i cards per module */
DECL|variable|dev_eth16i
r_static
r_struct
id|net_device
id|dev_eth16i
(braket
id|MAX_ETH16I_CARDS
)braket
suffix:semicolon
DECL|variable|io
r_static
r_int
id|io
(braket
id|MAX_ETH16I_CARDS
)braket
suffix:semicolon
macro_line|#if 0
r_static
r_int
id|irq
(braket
id|MAX_ETH16I_CARDS
)braket
suffix:semicolon
macro_line|#endif
DECL|variable|mediatype
r_static
r_char
op_star
id|mediatype
(braket
id|MAX_ETH16I_CARDS
)braket
suffix:semicolon
DECL|variable|debug
r_static
r_int
id|debug
op_assign
op_minus
l_int|1
suffix:semicolon
macro_line|#if (LINUX_VERSION_CODE &gt;= 0x20115) 
id|MODULE_AUTHOR
c_func
(paren
l_string|&quot;Mika Kuoppala &lt;miku@iki.fi&gt;&quot;
)paren
suffix:semicolon
id|MODULE_DESCRIPTION
c_func
(paren
l_string|&quot;ICL EtherTeam 16i/32 driver&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|io
comma
l_string|&quot;1-&quot;
id|__MODULE_STRING
c_func
(paren
id|MAX_ETH16I_CARDS
)paren
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|io
comma
l_string|&quot;eth16i io base address&quot;
)paren
suffix:semicolon
macro_line|#if 0
id|MODULE_PARM
c_func
(paren
id|irq
comma
l_string|&quot;1-&quot;
id|__MODULE_STRING
c_func
(paren
id|MAX_ETH16I_CARDS
)paren
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|irq
comma
l_string|&quot;eth16i interrupt request number&quot;
)paren
suffix:semicolon
macro_line|#endif
id|MODULE_PARM
c_func
(paren
id|mediatype
comma
l_string|&quot;1-&quot;
id|__MODULE_STRING
c_func
(paren
id|MAX_ETH16I_CARDS
)paren
l_string|&quot;s&quot;
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|mediatype
comma
l_string|&quot;eth16i interfaceport mediatype&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|debug
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|debug
comma
l_string|&quot;eth16i debug level (0-4)&quot;
)paren
suffix:semicolon
macro_line|#endif
DECL|function|init_module
r_int
id|init_module
c_func
(paren
r_void
)paren
(brace
r_int
id|this_dev
comma
id|found
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|this_dev
op_assign
l_int|0
suffix:semicolon
id|this_dev
OL
id|MAX_ETH16I_CARDS
suffix:semicolon
id|this_dev
op_increment
)paren
(brace
r_struct
id|net_device
op_star
id|dev
op_assign
op_amp
id|dev_eth16i
(braket
id|this_dev
)braket
suffix:semicolon
id|dev-&gt;irq
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* irq[this_dev]; */
id|dev-&gt;base_addr
op_assign
id|io
(braket
id|this_dev
)braket
suffix:semicolon
id|dev-&gt;init
op_assign
id|eth16i_probe
suffix:semicolon
r_if
c_cond
(paren
id|debug
op_ne
op_minus
l_int|1
)paren
(brace
id|eth16i_debug
op_assign
id|debug
suffix:semicolon
)brace
r_if
c_cond
(paren
id|eth16i_debug
OG
l_int|1
)paren
(brace
id|printk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;eth16i(%d): interface type %s&bslash;n&quot;
comma
id|this_dev
comma
id|mediatype
(braket
id|this_dev
)braket
ques
c_cond
id|mediatype
(braket
id|this_dev
)braket
suffix:colon
l_string|&quot;none&quot;
)paren
suffix:semicolon
)brace
id|dev-&gt;if_port
op_assign
id|eth16i_parse_mediatype
c_func
(paren
id|mediatype
(braket
id|this_dev
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
id|io
(braket
id|this_dev
)braket
op_eq
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|this_dev
op_ne
l_int|0
)paren
(brace
r_break
suffix:semicolon
)brace
multiline_comment|/* Only autoprobe 1st one */
id|printk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;eth16i.c: Presently autoprobing (not recommended) for a single card.&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|register_netdev
c_func
(paren
id|dev
)paren
op_ne
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;eth16i.c No Eth16i card found (i/o = 0x%x).&bslash;n&quot;
comma
id|io
(braket
id|this_dev
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
id|found
op_ne
l_int|0
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
r_return
op_minus
id|ENXIO
suffix:semicolon
)brace
id|found
op_increment
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|cleanup_module
r_void
id|cleanup_module
c_func
(paren
r_void
)paren
(brace
r_int
id|this_dev
suffix:semicolon
r_for
c_loop
(paren
id|this_dev
op_assign
l_int|0
suffix:semicolon
id|this_dev
OL
id|MAX_ETH16I_CARDS
suffix:semicolon
id|this_dev
op_increment
)paren
(brace
r_struct
id|net_device
op_star
id|dev
op_assign
op_amp
id|dev_eth16i
(braket
id|this_dev
)braket
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;priv
op_ne
l_int|NULL
)paren
(brace
id|unregister_netdev
c_func
(paren
id|dev
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|dev-&gt;priv
)paren
suffix:semicolon
id|dev-&gt;priv
op_assign
l_int|NULL
suffix:semicolon
id|free_irq
c_func
(paren
id|dev-&gt;irq
comma
id|dev
)paren
suffix:semicolon
id|release_region
c_func
(paren
id|dev-&gt;base_addr
comma
id|ETH16I_IO_EXTENT
)paren
suffix:semicolon
)brace
)brace
)brace
macro_line|#endif /* MODULE */
multiline_comment|/*&n; * Local variables:&n; *  compile-command: &quot;gcc -DMODULE -D__KERNEL__ -Wall -Wstrict-prototypes -O6 -c eth16i.c&quot;&n; *  alt-compile-command: &quot;gcc -DMODVERSIONS -DMODULE -D__KERNEL__ -Wall -Wstrict -prototypes -O6 -c eth16i.c&quot;&n; *  tab-width: 8&n; *  c-basic-offset: 8&n; *  c-indent-level: 8&n; * End:&n; */
multiline_comment|/* End of file eth16i.c */
eof
