multiline_comment|/*&n; * Network device driver for the GMAC ethernet controller on&n; * Apple G4 Powermacs.&n; *&n; * Copyright (C) 2000 Paul Mackerras &amp; Ben. Herrenschmidt&n; * &n; * portions based on sunhme.c by David S. Miller&n; *&n; * Changes:&n; * Arnaldo Carvalho de Melo &lt;acme@conectiva.com.br&gt; - 08/06/2000&n; * - check init_etherdev return in gmac_probe1&n; * BenH &lt;bh40@calva.net&gt; - 03/09/2000&n; * - Add support for new PHYs&n; * - Add some PowerBook sleep code&n; * &n; */
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/fcntl.h&gt;
macro_line|#include &lt;linux/interrupt.h&gt;
macro_line|#include &lt;linux/netdevice.h&gt;
macro_line|#include &lt;linux/etherdevice.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/timer.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/pci.h&gt;
macro_line|#include &lt;asm/prom.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/pgtable.h&gt;
macro_line|#include &lt;asm/feature.h&gt;
macro_line|#include &lt;asm/keylargo.h&gt;
macro_line|#include &lt;asm/pci-bridge.h&gt;
macro_line|#ifdef CONFIG_PMAC_PBOOK
macro_line|#include &lt;linux/adb.h&gt;
macro_line|#include &lt;linux/pmu.h&gt;
macro_line|#include &lt;asm/irq.h&gt;
macro_line|#endif
macro_line|#include &quot;gmac.h&quot;
DECL|macro|DEBUG_PHY
mdefine_line|#define DEBUG_PHY
multiline_comment|/* Driver version 1.3, kernel 2.4.x */
DECL|macro|GMAC_VERSION
mdefine_line|#define GMAC_VERSION&t;&quot;v1.3k4&quot;
DECL|variable|dummy_buf
r_static
r_int
r_char
id|dummy_buf
(braket
id|RX_BUF_ALLOC_SIZE
op_plus
id|RX_OFFSET
op_plus
id|GMAC_BUFFER_ALIGN
)braket
suffix:semicolon
DECL|variable|gmacs
r_static
r_struct
id|net_device
op_star
id|gmacs
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/* Prototypes */
r_static
r_int
id|mii_read
c_func
(paren
r_struct
id|gmac
op_star
id|gm
comma
r_int
id|phy
comma
r_int
id|r
)paren
suffix:semicolon
r_static
r_int
id|mii_write
c_func
(paren
r_struct
id|gmac
op_star
id|gm
comma
r_int
id|phy
comma
r_int
id|r
comma
r_int
id|v
)paren
suffix:semicolon
r_static
r_void
id|mii_poll_start
c_func
(paren
r_struct
id|gmac
op_star
id|gm
)paren
suffix:semicolon
r_static
r_void
id|mii_poll_stop
c_func
(paren
r_struct
id|gmac
op_star
id|gm
)paren
suffix:semicolon
r_static
r_void
id|mii_interrupt
c_func
(paren
r_struct
id|gmac
op_star
id|gm
)paren
suffix:semicolon
r_static
r_int
id|mii_lookup_and_reset
c_func
(paren
r_struct
id|gmac
op_star
id|gm
)paren
suffix:semicolon
r_static
r_void
id|mii_setup_phy
c_func
(paren
r_struct
id|gmac
op_star
id|gm
)paren
suffix:semicolon
r_static
r_int
id|mii_do_reset_phy
c_func
(paren
r_struct
id|gmac
op_star
id|gm
comma
r_int
id|phy_addr
)paren
suffix:semicolon
r_static
r_void
id|mii_init_BCM5400
c_func
(paren
r_struct
id|gmac
op_star
id|gm
)paren
suffix:semicolon
r_static
r_void
id|gmac_set_power
c_func
(paren
r_struct
id|gmac
op_star
id|gm
comma
r_int
id|power_up
)paren
suffix:semicolon
r_static
r_int
id|gmac_powerup_and_reset
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_void
id|gmac_set_gigabit_mode
c_func
(paren
r_struct
id|gmac
op_star
id|gm
comma
r_int
id|gigabit
)paren
suffix:semicolon
r_static
r_void
id|gmac_set_duplex_mode
c_func
(paren
r_struct
id|gmac
op_star
id|gm
comma
r_int
id|full_duplex
)paren
suffix:semicolon
r_static
r_void
id|gmac_mac_init
c_func
(paren
r_struct
id|gmac
op_star
id|gm
comma
r_int
r_char
op_star
id|mac_addr
)paren
suffix:semicolon
r_static
r_void
id|gmac_init_rings
c_func
(paren
r_struct
id|gmac
op_star
id|gm
comma
r_int
id|from_irq
)paren
suffix:semicolon
r_static
r_void
id|gmac_start_dma
c_func
(paren
r_struct
id|gmac
op_star
id|gm
)paren
suffix:semicolon
r_static
r_void
id|gmac_stop_dma
c_func
(paren
r_struct
id|gmac
op_star
id|gm
)paren
suffix:semicolon
r_static
r_void
id|gmac_set_multicast
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_int
id|gmac_open
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_int
id|gmac_close
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_void
id|gmac_tx_timeout
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_int
id|gmac_xmit_start
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_void
id|gmac_tx_cleanup
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_int
id|force_cleanup
)paren
suffix:semicolon
r_static
r_void
id|gmac_receive
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_void
id|gmac_interrupt
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
suffix:semicolon
r_static
r_struct
id|net_device_stats
op_star
id|gmac_stats
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_int
id|gmac_probe
c_func
(paren
r_void
)paren
suffix:semicolon
r_static
r_void
id|gmac_probe1
c_func
(paren
r_struct
id|device_node
op_star
id|gmac
)paren
suffix:semicolon
macro_line|#ifdef CONFIG_PMAC_PBOOK
r_int
id|gmac_sleep_notify
c_func
(paren
r_struct
id|pmu_sleep_notifier
op_star
id|self
comma
r_int
id|when
)paren
suffix:semicolon
DECL|variable|gmac_sleep_notifier
r_static
r_struct
id|pmu_sleep_notifier
id|gmac_sleep_notifier
op_assign
(brace
id|gmac_sleep_notify
comma
id|SLEEP_LEVEL_NET
comma
)brace
suffix:semicolon
macro_line|#endif
multiline_comment|/*&n; * Read via the mii interface from a PHY register&n; */
r_static
r_int
DECL|function|mii_read
id|mii_read
c_func
(paren
r_struct
id|gmac
op_star
id|gm
comma
r_int
id|phy
comma
r_int
id|r
)paren
(brace
r_int
id|timeout
suffix:semicolon
id|GM_OUT
c_func
(paren
id|GM_MIF_FRAME_CTL_DATA
comma
(paren
l_int|0x01
op_lshift
id|GM_MIF_FRAME_START_SHIFT
)paren
op_or
(paren
l_int|0x02
op_lshift
id|GM_MIF_FRAME_OPCODE_SHIFT
)paren
op_or
id|GM_MIF_FRAME_TURNAROUND_HI
op_or
(paren
id|phy
op_lshift
id|GM_MIF_FRAME_PHY_ADDR_SHIFT
)paren
op_or
(paren
id|r
op_lshift
id|GM_MIF_FRAME_REG_ADDR_SHIFT
)paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|timeout
op_assign
l_int|1000
suffix:semicolon
id|timeout
OG
l_int|0
suffix:semicolon
op_decrement
id|timeout
)paren
(brace
id|udelay
c_func
(paren
l_int|20
)paren
suffix:semicolon
r_if
c_cond
(paren
id|GM_IN
c_func
(paren
id|GM_MIF_FRAME_CTL_DATA
)paren
op_amp
id|GM_MIF_FRAME_TURNAROUND_LO
)paren
r_return
id|GM_IN
c_func
(paren
id|GM_MIF_FRAME_CTL_DATA
)paren
op_amp
id|GM_MIF_FRAME_DATA_MASK
suffix:semicolon
)brace
r_return
op_minus
l_int|1
suffix:semicolon
)brace
multiline_comment|/*&n; * Write on the mii interface to a PHY register&n; */
r_static
r_int
DECL|function|mii_write
id|mii_write
c_func
(paren
r_struct
id|gmac
op_star
id|gm
comma
r_int
id|phy
comma
r_int
id|r
comma
r_int
id|v
)paren
(brace
r_int
id|timeout
suffix:semicolon
id|GM_OUT
c_func
(paren
id|GM_MIF_FRAME_CTL_DATA
comma
(paren
l_int|0x01
op_lshift
id|GM_MIF_FRAME_START_SHIFT
)paren
op_or
(paren
l_int|0x01
op_lshift
id|GM_MIF_FRAME_OPCODE_SHIFT
)paren
op_or
id|GM_MIF_FRAME_TURNAROUND_HI
op_or
(paren
id|phy
op_lshift
id|GM_MIF_FRAME_PHY_ADDR_SHIFT
)paren
op_or
(paren
id|r
op_lshift
id|GM_MIF_FRAME_REG_ADDR_SHIFT
)paren
op_or
(paren
id|v
op_amp
id|GM_MIF_FRAME_DATA_MASK
)paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|timeout
op_assign
l_int|1000
suffix:semicolon
id|timeout
OG
l_int|0
suffix:semicolon
op_decrement
id|timeout
)paren
(brace
id|udelay
c_func
(paren
l_int|20
)paren
suffix:semicolon
r_if
c_cond
(paren
id|GM_IN
c_func
(paren
id|GM_MIF_FRAME_CTL_DATA
)paren
op_amp
id|GM_MIF_FRAME_TURNAROUND_LO
)paren
r_return
l_int|0
suffix:semicolon
)brace
r_return
op_minus
l_int|1
suffix:semicolon
)brace
multiline_comment|/*&n; * Start MIF autopolling of the PHY status register&n; */
r_static
r_void
DECL|function|mii_poll_start
id|mii_poll_start
c_func
(paren
r_struct
id|gmac
op_star
id|gm
)paren
(brace
r_int
r_int
id|tmp
suffix:semicolon
multiline_comment|/* Start the MIF polling on the external transceiver. */
id|tmp
op_assign
id|GM_IN
c_func
(paren
id|GM_MIF_CFG
)paren
suffix:semicolon
id|tmp
op_and_assign
op_complement
(paren
id|GM_MIF_CFGPR_MASK
op_or
id|GM_MIF_CFGPD_MASK
)paren
suffix:semicolon
id|tmp
op_or_assign
(paren
(paren
id|gm-&gt;phy_addr
op_amp
l_int|0x1f
)paren
op_lshift
id|GM_MIF_CFGPD_SHIFT
)paren
suffix:semicolon
id|tmp
op_or_assign
(paren
id|MII_SR
op_lshift
id|GM_MIF_CFGPR_SHIFT
)paren
suffix:semicolon
id|tmp
op_or_assign
id|GM_MIF_CFGPE
suffix:semicolon
id|GM_OUT
c_func
(paren
id|GM_MIF_CFG
comma
id|tmp
)paren
suffix:semicolon
multiline_comment|/* Let the bits set. */
id|udelay
c_func
(paren
id|GM_MIF_POLL_DELAY
)paren
suffix:semicolon
id|GM_OUT
c_func
(paren
id|GM_MIF_IRQ_MASK
comma
l_int|0xffc0
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Stop MIF autopolling of the PHY status register&n; */
r_static
r_void
DECL|function|mii_poll_stop
id|mii_poll_stop
c_func
(paren
r_struct
id|gmac
op_star
id|gm
)paren
(brace
id|GM_OUT
c_func
(paren
id|GM_MIF_IRQ_MASK
comma
l_int|0xffff
)paren
suffix:semicolon
id|GM_BIC
c_func
(paren
id|GM_MIF_CFG
comma
id|GM_MIF_CFGPE
)paren
suffix:semicolon
id|udelay
c_func
(paren
id|GM_MIF_POLL_DELAY
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Called when the MIF detect a change of the PHY status&n; * &n; * handles monitoring the link and updating GMAC with the correct&n; * duplex mode.&n; * &n; * Note: Are we missing status changes ? In this case, we&squot;ll have to&n; * a timer and control the autoneg. process more closely. Also, we may&n; * want to stop rx and tx side when the link is down.&n; */
multiline_comment|/* Link modes of the BCM5400 PHY */
DECL|variable|phy_BCM5400_link_table
r_static
r_int
id|phy_BCM5400_link_table
(braket
l_int|8
)braket
(braket
l_int|3
)braket
op_assign
(brace
(brace
l_int|0
comma
l_int|0
comma
l_int|0
)brace
comma
multiline_comment|/* No link */
(brace
l_int|0
comma
l_int|0
comma
l_int|0
)brace
comma
multiline_comment|/* 10BT Half Duplex */
(brace
l_int|1
comma
l_int|0
comma
l_int|0
)brace
comma
multiline_comment|/* 10BT Full Duplex */
(brace
l_int|0
comma
l_int|1
comma
l_int|0
)brace
comma
multiline_comment|/* 100BT Half Duplex */
(brace
l_int|0
comma
l_int|1
comma
l_int|0
)brace
comma
multiline_comment|/* 100BT Half Duplex */
(brace
l_int|1
comma
l_int|1
comma
l_int|0
)brace
comma
multiline_comment|/* 100BT Full Duplex*/
(brace
l_int|1
comma
l_int|0
comma
l_int|1
)brace
comma
multiline_comment|/* 1000BT */
(brace
l_int|1
comma
l_int|0
comma
l_int|1
)brace
comma
multiline_comment|/* 1000BT */
)brace
suffix:semicolon
r_static
r_void
DECL|function|mii_interrupt
id|mii_interrupt
c_func
(paren
r_struct
id|gmac
op_star
id|gm
)paren
(brace
r_int
id|phy_status
suffix:semicolon
r_int
id|lpar_ability
suffix:semicolon
id|mii_poll_stop
c_func
(paren
id|gm
)paren
suffix:semicolon
multiline_comment|/* May the status change before polling is re-enabled ? */
id|mii_poll_start
c_func
(paren
id|gm
)paren
suffix:semicolon
multiline_comment|/* We read the Auxilliary Status Summary register */
id|phy_status
op_assign
id|mii_read
c_func
(paren
id|gm
comma
id|gm-&gt;phy_addr
comma
id|MII_SR
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|phy_status
op_xor
id|gm-&gt;phy_status
)paren
op_amp
(paren
id|MII_SR_ASSC
op_or
id|MII_SR_LKS
)paren
)paren
(brace
r_int
id|full_duplex
op_assign
l_int|0
suffix:semicolon
r_int
id|link_100
op_assign
l_int|0
suffix:semicolon
r_int
id|gigabit
op_assign
l_int|0
suffix:semicolon
macro_line|#ifdef DEBUG_PHY
id|printk
c_func
(paren
l_string|&quot;Link state change, phy_status: 0x%04x&bslash;n&quot;
comma
id|phy_status
)paren
suffix:semicolon
macro_line|#endif
id|gm-&gt;phy_status
op_assign
id|phy_status
suffix:semicolon
id|lpar_ability
op_assign
id|mii_read
c_func
(paren
id|gm
comma
id|gm-&gt;phy_addr
comma
id|MII_ANLPA
)paren
suffix:semicolon
r_if
c_cond
(paren
id|lpar_ability
op_amp
id|MII_ANLPA_PAUS
)paren
id|GM_BIS
c_func
(paren
id|GM_MAC_CTRL_CONFIG
comma
id|GM_MAC_CTRL_CONF_SND_PAUSE_EN
)paren
suffix:semicolon
r_else
id|GM_BIC
c_func
(paren
id|GM_MAC_CTRL_CONFIG
comma
id|GM_MAC_CTRL_CONF_SND_PAUSE_EN
)paren
suffix:semicolon
multiline_comment|/* Link ? Check for speed and duplex */
r_if
c_cond
(paren
(paren
id|phy_status
op_amp
id|MII_SR_LKS
)paren
op_logical_and
(paren
id|phy_status
op_amp
id|MII_SR_ASSC
)paren
)paren
(brace
r_int
id|restart
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|gm-&gt;phy_type
op_eq
id|PHY_B5201
)paren
(brace
r_int
id|aux_stat
op_assign
id|mii_read
c_func
(paren
id|gm
comma
id|gm-&gt;phy_addr
comma
id|MII_BCM5201_AUXCTLSTATUS
)paren
suffix:semicolon
macro_line|#ifdef DEBUG_PHY
id|printk
c_func
(paren
l_string|&quot;    Link up ! BCM5201 aux_stat: 0x%04x&bslash;n&quot;
comma
id|aux_stat
)paren
suffix:semicolon
macro_line|#endif
id|full_duplex
op_assign
(paren
(paren
id|aux_stat
op_amp
id|MII_BCM5201_AUXCTLSTATUS_DUPLEX
)paren
op_ne
l_int|0
)paren
suffix:semicolon
id|link_100
op_assign
(paren
(paren
id|aux_stat
op_amp
id|MII_BCM5201_AUXCTLSTATUS_SPEED
)paren
op_ne
l_int|0
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|gm-&gt;phy_type
op_eq
id|PHY_B5400
)paren
(brace
r_int
id|aux_stat
op_assign
id|mii_read
c_func
(paren
id|gm
comma
id|gm-&gt;phy_addr
comma
id|MII_BCM5400_AUXSTATUS
)paren
suffix:semicolon
r_int
id|link
op_assign
(paren
id|aux_stat
op_amp
id|MII_BCM5400_AUXSTATUS_LINKMODE_MASK
)paren
op_rshift
id|MII_BCM5400_AUXSTATUS_LINKMODE_SHIFT
suffix:semicolon
macro_line|#ifdef DEBUG_PHY
id|printk
c_func
(paren
l_string|&quot;    Link up ! BCM5400 aux_stat: 0x%04x (link mode: %d)&bslash;n&quot;
comma
id|aux_stat
comma
id|link
)paren
suffix:semicolon
macro_line|#endif
id|full_duplex
op_assign
id|phy_BCM5400_link_table
(braket
id|link
)braket
(braket
l_int|0
)braket
suffix:semicolon
id|link_100
op_assign
id|phy_BCM5400_link_table
(braket
id|link
)braket
(braket
l_int|1
)braket
suffix:semicolon
id|gigabit
op_assign
id|phy_BCM5400_link_table
(braket
id|link
)braket
(braket
l_int|2
)braket
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|gm-&gt;phy_type
op_eq
id|PHY_LXT971
)paren
(brace
r_int
id|stat2
op_assign
id|mii_read
c_func
(paren
id|gm
comma
id|gm-&gt;phy_addr
comma
id|MII_LXT971_STATUS2
)paren
suffix:semicolon
macro_line|#ifdef DEBUG_PHY
id|printk
c_func
(paren
l_string|&quot;    Link up ! LXT971 stat2: 0x%04x&bslash;n&quot;
comma
id|stat2
)paren
suffix:semicolon
macro_line|#endif
id|full_duplex
op_assign
(paren
(paren
id|stat2
op_amp
id|MII_LXT971_STATUS2_FULLDUPLEX
)paren
op_ne
l_int|0
)paren
suffix:semicolon
id|link_100
op_assign
(paren
(paren
id|stat2
op_amp
id|MII_LXT971_STATUS2_SPEED
)paren
op_ne
l_int|0
)paren
suffix:semicolon
)brace
macro_line|#ifdef DEBUG_PHY
id|printk
c_func
(paren
l_string|&quot;    full_duplex: %d, speed: %s&bslash;n&quot;
comma
id|full_duplex
comma
id|gigabit
ques
c_cond
l_string|&quot;1000&quot;
suffix:colon
(paren
id|link_100
ques
c_cond
l_string|&quot;100&quot;
suffix:colon
l_string|&quot;10&quot;
)paren
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|gigabit
op_ne
id|gm-&gt;gigabit
)paren
(brace
id|gm-&gt;gigabit
op_assign
id|gigabit
suffix:semicolon
id|gmac_set_gigabit_mode
c_func
(paren
id|gm
comma
id|gm-&gt;gigabit
)paren
suffix:semicolon
id|restart
op_assign
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|full_duplex
op_ne
id|gm-&gt;full_duplex
)paren
(brace
id|gm-&gt;full_duplex
op_assign
id|full_duplex
suffix:semicolon
id|gmac_set_duplex_mode
c_func
(paren
id|gm
comma
id|gm-&gt;full_duplex
)paren
suffix:semicolon
id|restart
op_assign
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|restart
)paren
id|gmac_start_dma
c_func
(paren
id|gm
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
op_logical_neg
(paren
id|phy_status
op_amp
id|MII_SR_LKS
)paren
)paren
(brace
macro_line|#ifdef DEBUG_PHY
id|printk
c_func
(paren
l_string|&quot;    Link down !&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
)brace
)brace
)brace
r_static
r_int
DECL|function|mii_do_reset_phy
id|mii_do_reset_phy
c_func
(paren
r_struct
id|gmac
op_star
id|gm
comma
r_int
id|phy_addr
)paren
(brace
r_int
id|mii_control
comma
id|timeout
suffix:semicolon
id|mii_control
op_assign
id|mii_read
c_func
(paren
id|gm
comma
id|phy_addr
comma
id|MII_CR
)paren
suffix:semicolon
id|mii_write
c_func
(paren
id|gm
comma
id|phy_addr
comma
id|MII_CR
comma
id|mii_control
op_or
id|MII_CR_RST
)paren
suffix:semicolon
id|mdelay
c_func
(paren
l_int|10
)paren
suffix:semicolon
r_for
c_loop
(paren
id|timeout
op_assign
l_int|100
suffix:semicolon
id|timeout
OG
l_int|0
suffix:semicolon
op_decrement
id|timeout
)paren
(brace
id|mii_control
op_assign
id|mii_read
c_func
(paren
id|gm
comma
id|phy_addr
comma
id|MII_CR
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mii_control
op_eq
op_minus
l_int|1
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s PHY died after reset !&bslash;n&quot;
comma
id|gm-&gt;dev-&gt;name
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|mii_control
op_amp
id|MII_CR_RST
)paren
op_eq
l_int|0
)paren
r_break
suffix:semicolon
id|mdelay
c_func
(paren
l_int|10
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|mii_control
op_amp
id|MII_CR_RST
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s PHY reset timeout !&bslash;n&quot;
comma
id|gm-&gt;dev-&gt;name
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
id|mii_write
c_func
(paren
id|gm
comma
id|phy_addr
comma
id|MII_CR
comma
id|mii_control
op_amp
op_complement
id|MII_CR_ISOL
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_void
DECL|function|mii_init_BCM5400
id|mii_init_BCM5400
c_func
(paren
r_struct
id|gmac
op_star
id|gm
)paren
(brace
r_int
id|data
suffix:semicolon
id|data
op_assign
id|mii_read
c_func
(paren
id|gm
comma
id|gm-&gt;phy_addr
comma
id|MII_BCM5400_AUXCONTROL
)paren
suffix:semicolon
id|data
op_or_assign
id|MII_BCM5400_AUXCONTROL_PWR10BASET
suffix:semicolon
id|mii_write
c_func
(paren
id|gm
comma
id|gm-&gt;phy_addr
comma
id|MII_BCM5400_AUXCONTROL
comma
id|data
)paren
suffix:semicolon
id|data
op_assign
id|mii_read
c_func
(paren
id|gm
comma
id|gm-&gt;phy_addr
comma
id|MII_BCM5400_GB_CONTROL
)paren
suffix:semicolon
id|data
op_or_assign
id|MII_BCM5400_GB_CONTROL_FULLDUPLEXCAP
suffix:semicolon
id|mii_write
c_func
(paren
id|gm
comma
id|gm-&gt;phy_addr
comma
id|MII_BCM5400_GB_CONTROL
comma
id|data
)paren
suffix:semicolon
id|mdelay
c_func
(paren
l_int|10
)paren
suffix:semicolon
id|mii_do_reset_phy
c_func
(paren
id|gm
comma
l_int|0x1f
)paren
suffix:semicolon
id|data
op_assign
id|mii_read
c_func
(paren
id|gm
comma
l_int|0x1f
comma
id|MII_BCM5201_MULTIPHY
)paren
suffix:semicolon
id|data
op_or_assign
id|MII_BCM5201_MULTIPHY_SERIALMODE
suffix:semicolon
id|mii_write
c_func
(paren
id|gm
comma
l_int|0x1f
comma
id|MII_BCM5201_MULTIPHY
comma
id|data
)paren
suffix:semicolon
id|data
op_assign
id|mii_read
c_func
(paren
id|gm
comma
id|gm-&gt;phy_addr
comma
id|MII_BCM5400_AUXCONTROL
)paren
suffix:semicolon
id|data
op_and_assign
op_complement
id|MII_BCM5400_AUXCONTROL_PWR10BASET
suffix:semicolon
id|mii_write
c_func
(paren
id|gm
comma
id|gm-&gt;phy_addr
comma
id|MII_BCM5400_AUXCONTROL
comma
id|data
)paren
suffix:semicolon
)brace
r_static
r_int
DECL|function|mii_lookup_and_reset
id|mii_lookup_and_reset
c_func
(paren
r_struct
id|gmac
op_star
id|gm
)paren
(brace
r_int
id|i
comma
id|mii_status
comma
id|mii_control
suffix:semicolon
id|gm-&gt;phy_addr
op_assign
op_minus
l_int|1
suffix:semicolon
id|gm-&gt;phy_type
op_assign
id|PHY_UNKNOWN
suffix:semicolon
multiline_comment|/* Hard reset the PHY */
id|feature_set_gmac_phy_reset
c_func
(paren
id|gm-&gt;of_node
comma
id|KL_GPIO_ETH_PHY_RESET_ASSERT
)paren
suffix:semicolon
id|mdelay
c_func
(paren
l_int|10
)paren
suffix:semicolon
id|feature_set_gmac_phy_reset
c_func
(paren
id|gm-&gt;of_node
comma
id|KL_GPIO_ETH_PHY_RESET_RELEASE
)paren
suffix:semicolon
id|mdelay
c_func
(paren
l_int|10
)paren
suffix:semicolon
multiline_comment|/* Find the PHY */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
op_le
l_int|31
suffix:semicolon
id|i
op_increment
)paren
(brace
id|mii_control
op_assign
id|mii_read
c_func
(paren
id|gm
comma
id|i
comma
id|MII_CR
)paren
suffix:semicolon
id|mii_status
op_assign
id|mii_read
c_func
(paren
id|gm
comma
id|i
comma
id|MII_SR
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mii_control
op_ne
op_minus
l_int|1
op_logical_and
id|mii_status
op_ne
op_minus
l_int|1
op_logical_and
(paren
id|mii_control
op_ne
l_int|0xffff
op_logical_or
id|mii_status
op_ne
l_int|0xffff
)paren
)paren
r_break
suffix:semicolon
)brace
id|gm-&gt;phy_addr
op_assign
id|i
suffix:semicolon
r_if
c_cond
(paren
id|gm-&gt;phy_addr
OG
l_int|31
)paren
r_return
l_int|0
suffix:semicolon
multiline_comment|/* Reset it */
r_if
c_cond
(paren
id|mii_do_reset_phy
c_func
(paren
id|gm
comma
id|gm-&gt;phy_addr
)paren
)paren
r_goto
id|fail
suffix:semicolon
multiline_comment|/* Read the PHY ID */
id|gm-&gt;phy_id
op_assign
(paren
id|mii_read
c_func
(paren
id|gm
comma
id|gm-&gt;phy_addr
comma
id|MII_ID0
)paren
op_lshift
l_int|16
)paren
op_or
id|mii_read
c_func
(paren
id|gm
comma
id|gm-&gt;phy_addr
comma
id|MII_ID1
)paren
suffix:semicolon
macro_line|#ifdef DEBUG_PHY
id|printk
c_func
(paren
l_string|&quot;%s PHY ID: 0x%08x&bslash;n&quot;
comma
id|gm-&gt;dev-&gt;name
comma
id|gm-&gt;phy_id
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
(paren
id|gm-&gt;phy_id
op_amp
id|MII_BCM5400_MASK
)paren
op_eq
id|MII_BCM5400_ID
)paren
(brace
id|gm-&gt;phy_type
op_assign
id|PHY_B5400
suffix:semicolon
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s Found Broadcom BCM5400 PHY (Gigabit)&bslash;n&quot;
comma
id|gm-&gt;dev-&gt;name
)paren
suffix:semicolon
id|mii_init_BCM5400
c_func
(paren
id|gm
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
(paren
id|gm-&gt;phy_id
op_amp
id|MII_BCM5201_MASK
)paren
op_eq
id|MII_BCM5201_ID
)paren
(brace
id|gm-&gt;phy_type
op_assign
id|PHY_B5201
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s Found Broadcom BCM5201 PHY&bslash;n&quot;
comma
id|gm-&gt;dev-&gt;name
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
(paren
id|gm-&gt;phy_id
op_amp
id|MII_LXT971_MASK
)paren
op_eq
id|MII_LXT971_ID
)paren
(brace
id|gm-&gt;phy_type
op_assign
id|PHY_LXT971
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s Found LevelOne LX971 PHY&bslash;n&quot;
comma
id|gm-&gt;dev-&gt;name
)paren
suffix:semicolon
)brace
r_else
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: Warning ! Unknown PHY ID 0x%08x !&bslash;n&quot;
comma
id|gm-&gt;dev-&gt;name
comma
id|gm-&gt;phy_id
)paren
suffix:semicolon
)brace
r_return
l_int|1
suffix:semicolon
id|fail
suffix:colon
id|gm-&gt;phy_addr
op_assign
op_minus
l_int|1
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* &n; * Setup the PHY autonegociation parameters&n; * &n; * Code to force the PHY duplex mode and speed should be&n; * added here&n; */
r_static
r_void
DECL|function|mii_setup_phy
id|mii_setup_phy
c_func
(paren
r_struct
id|gmac
op_star
id|gm
)paren
(brace
r_int
id|data
suffix:semicolon
multiline_comment|/* Stop auto-negociation */
id|data
op_assign
id|mii_read
c_func
(paren
id|gm
comma
id|gm-&gt;phy_addr
comma
id|MII_CR
)paren
suffix:semicolon
id|mii_write
c_func
(paren
id|gm
comma
id|gm-&gt;phy_addr
comma
id|MII_CR
comma
id|data
op_amp
op_complement
id|MII_CR_ASSE
)paren
suffix:semicolon
multiline_comment|/* Set advertisement to 10/100 and Half/Full duplex&n;&t; * (full capabilities) */
id|data
op_assign
id|mii_read
c_func
(paren
id|gm
comma
id|gm-&gt;phy_addr
comma
id|MII_ANA
)paren
suffix:semicolon
id|data
op_or_assign
id|MII_ANA_TXAM
op_or
id|MII_ANA_FDAM
op_or
id|MII_ANA_10M
suffix:semicolon
id|mii_write
c_func
(paren
id|gm
comma
id|gm-&gt;phy_addr
comma
id|MII_ANA
comma
id|data
)paren
suffix:semicolon
multiline_comment|/* Restart auto-negociation */
id|data
op_assign
id|mii_read
c_func
(paren
id|gm
comma
id|gm-&gt;phy_addr
comma
id|MII_CR
)paren
suffix:semicolon
id|data
op_or_assign
id|MII_CR_ASSE
suffix:semicolon
id|mii_write
c_func
(paren
id|gm
comma
id|gm-&gt;phy_addr
comma
id|MII_CR
comma
id|data
)paren
suffix:semicolon
id|data
op_or_assign
id|MII_CR_RAN
suffix:semicolon
id|mii_write
c_func
(paren
id|gm
comma
id|gm-&gt;phy_addr
comma
id|MII_CR
comma
id|data
)paren
suffix:semicolon
)brace
multiline_comment|/* &n; * Turn On/Off the gmac cell inside Uni-N&n; * &n; * ToDo: Add code to support powering down of the PHY.&n; */
r_static
r_void
DECL|function|gmac_set_power
id|gmac_set_power
c_func
(paren
r_struct
id|gmac
op_star
id|gm
comma
r_int
id|power_up
)paren
(brace
r_if
c_cond
(paren
id|power_up
)paren
(brace
id|feature_set_gmac_power
c_func
(paren
id|gm-&gt;of_node
comma
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|gm-&gt;pci_devfn
op_ne
l_int|0xff
)paren
(brace
id|u16
id|cmd
suffix:semicolon
multiline_comment|/*&n;&t;&t;&t; * Make sure PCI is correctly configured&n;&t;&t;&t; *&n;&t;&t;&t; * We use old pci_bios versions of the function since, by&n;&t;&t;&t; * default, gmac is not powered up, and so will be absent&n;&t;&t;&t; * from the kernel initial PCI lookup. &n;&t;&t;&t; * &n;&t;&t;&t; * Should be replaced by 2.4 new PCI mecanisms and really&n;&t;&t;&t; * regiser the device.&n;&t;&t;&t; */
id|pcibios_read_config_word
c_func
(paren
id|gm-&gt;pci_bus
comma
id|gm-&gt;pci_devfn
comma
id|PCI_COMMAND
comma
op_amp
id|cmd
)paren
suffix:semicolon
id|cmd
op_or_assign
id|PCI_COMMAND_MEMORY
op_or
id|PCI_COMMAND_MASTER
op_or
id|PCI_COMMAND_INVALIDATE
suffix:semicolon
id|pcibios_write_config_word
c_func
(paren
id|gm-&gt;pci_bus
comma
id|gm-&gt;pci_devfn
comma
id|PCI_COMMAND
comma
id|cmd
)paren
suffix:semicolon
id|pcibios_write_config_byte
c_func
(paren
id|gm-&gt;pci_bus
comma
id|gm-&gt;pci_devfn
comma
id|PCI_LATENCY_TIMER
comma
l_int|16
)paren
suffix:semicolon
id|pcibios_write_config_byte
c_func
(paren
id|gm-&gt;pci_bus
comma
id|gm-&gt;pci_devfn
comma
id|PCI_CACHE_LINE_SIZE
comma
l_int|8
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
multiline_comment|/* FIXME: Add PHY power down */
id|gm-&gt;phy_type
op_assign
l_int|0
suffix:semicolon
id|feature_set_gmac_power
c_func
(paren
id|gm-&gt;of_node
comma
l_int|0
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/*&n; * Makes sure the GMAC cell is powered up, and reset it&n; */
r_static
r_int
DECL|function|gmac_powerup_and_reset
id|gmac_powerup_and_reset
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|gmac
op_star
id|gm
op_assign
(paren
r_struct
id|gmac
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_int
id|timeout
suffix:semicolon
multiline_comment|/* turn on GB clock */
id|gmac_set_power
c_func
(paren
id|gm
comma
l_int|1
)paren
suffix:semicolon
multiline_comment|/* Perform a software reset */
id|GM_OUT
c_func
(paren
id|GM_RESET
comma
id|GM_RESET_TX
op_or
id|GM_RESET_RX
)paren
suffix:semicolon
r_for
c_loop
(paren
id|timeout
op_assign
l_int|100
suffix:semicolon
id|timeout
OG
l_int|0
suffix:semicolon
op_decrement
id|timeout
)paren
(brace
id|mdelay
c_func
(paren
l_int|10
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|GM_IN
c_func
(paren
id|GM_RESET
)paren
op_amp
(paren
id|GM_RESET_TX
op_or
id|GM_RESET_RX
)paren
)paren
op_eq
l_int|0
)paren
(brace
multiline_comment|/* Mask out all chips interrupts */
id|GM_OUT
c_func
(paren
id|GM_IRQ_MASK
comma
l_int|0xffffffff
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
)brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s reset failed!&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|gmac_set_power
c_func
(paren
id|gm
comma
l_int|0
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
multiline_comment|/*&n; * Set the MAC duplex mode.&n; * &n; * Side effect: stops Tx MAC&n; */
r_static
r_void
DECL|function|gmac_set_duplex_mode
id|gmac_set_duplex_mode
c_func
(paren
r_struct
id|gmac
op_star
id|gm
comma
r_int
id|full_duplex
)paren
(brace
multiline_comment|/* Stop Tx MAC */
id|GM_BIC
c_func
(paren
id|GM_MAC_TX_CONFIG
comma
id|GM_MAC_TX_CONF_ENABLE
)paren
suffix:semicolon
r_while
c_loop
(paren
id|GM_IN
c_func
(paren
id|GM_MAC_TX_CONFIG
)paren
op_amp
id|GM_MAC_TX_CONF_ENABLE
)paren
(brace
suffix:semicolon
)brace
r_if
c_cond
(paren
id|full_duplex
)paren
(brace
id|GM_BIS
c_func
(paren
id|GM_MAC_TX_CONFIG
comma
id|GM_MAC_TX_CONF_IGNORE_CARRIER
op_or
id|GM_MAC_TX_CONF_IGNORE_COLL
)paren
suffix:semicolon
id|GM_BIC
c_func
(paren
id|GM_MAC_XIF_CONFIG
comma
id|GM_MAC_XIF_CONF_DISABLE_ECHO
)paren
suffix:semicolon
)brace
r_else
(brace
id|GM_BIC
c_func
(paren
id|GM_MAC_TX_CONFIG
comma
id|GM_MAC_TX_CONF_IGNORE_CARRIER
op_or
id|GM_MAC_TX_CONF_IGNORE_COLL
)paren
suffix:semicolon
id|GM_BIS
c_func
(paren
id|GM_MAC_XIF_CONFIG
comma
id|GM_MAC_XIF_CONF_DISABLE_ECHO
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* Set the MAC gigabit mode. Side effect: stops Tx MAC */
r_static
r_void
DECL|function|gmac_set_gigabit_mode
id|gmac_set_gigabit_mode
c_func
(paren
r_struct
id|gmac
op_star
id|gm
comma
r_int
id|gigabit
)paren
(brace
multiline_comment|/* Stop Tx MAC */
id|GM_BIC
c_func
(paren
id|GM_MAC_TX_CONFIG
comma
id|GM_MAC_TX_CONF_ENABLE
)paren
suffix:semicolon
r_while
c_loop
(paren
id|GM_IN
c_func
(paren
id|GM_MAC_TX_CONFIG
)paren
op_amp
id|GM_MAC_TX_CONF_ENABLE
)paren
(brace
suffix:semicolon
)brace
r_if
c_cond
(paren
id|gigabit
)paren
(brace
id|GM_BIS
c_func
(paren
id|GM_MAC_XIF_CONFIG
comma
id|GM_MAC_XIF_CONF_GMII_MODE
)paren
suffix:semicolon
)brace
r_else
(brace
id|GM_BIC
c_func
(paren
id|GM_MAC_XIF_CONFIG
comma
id|GM_MAC_XIF_CONF_GMII_MODE
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/*&n; * Initialize a bunch of registers to put the chip into a known&n; * and hopefully happy state&n; */
r_static
r_void
DECL|function|gmac_mac_init
id|gmac_mac_init
c_func
(paren
r_struct
id|gmac
op_star
id|gm
comma
r_int
r_char
op_star
id|mac_addr
)paren
(brace
r_int
id|i
comma
id|fifo_size
suffix:semicolon
multiline_comment|/* Set random seed to low bits of MAC address */
id|GM_OUT
c_func
(paren
id|GM_MAC_RANDOM_SEED
comma
id|mac_addr
(braket
l_int|5
)braket
op_or
(paren
id|mac_addr
(braket
l_int|4
)braket
op_lshift
l_int|8
)paren
)paren
suffix:semicolon
multiline_comment|/* Configure the data path mode to MII/GII */
id|GM_OUT
c_func
(paren
id|GM_PCS_DATAPATH_MODE
comma
id|GM_PCS_DATAPATH_MII
)paren
suffix:semicolon
multiline_comment|/* Configure XIF to MII mode. Full duplex led is set&n;&t; * by Apple, so...&n;&t; */
id|GM_OUT
c_func
(paren
id|GM_MAC_XIF_CONFIG
comma
id|GM_MAC_XIF_CONF_TX_MII_OUT_EN
op_or
id|GM_MAC_XIF_CONF_FULL_DPLX_LED
)paren
suffix:semicolon
multiline_comment|/* Mask out all MAC interrupts */
id|GM_OUT
c_func
(paren
id|GM_MAC_TX_MASK
comma
l_int|0xffff
)paren
suffix:semicolon
id|GM_OUT
c_func
(paren
id|GM_MAC_RX_MASK
comma
l_int|0xffff
)paren
suffix:semicolon
id|GM_OUT
c_func
(paren
id|GM_MAC_CTRLSTAT_MASK
comma
l_int|0xff
)paren
suffix:semicolon
multiline_comment|/* Setup bits of MAC */
id|GM_OUT
c_func
(paren
id|GM_MAC_SND_PAUSE
comma
id|GM_MAC_SND_PAUSE_DEFAULT
)paren
suffix:semicolon
id|GM_OUT
c_func
(paren
id|GM_MAC_CTRL_CONFIG
comma
id|GM_MAC_CTRL_CONF_RCV_PAUSE_EN
)paren
suffix:semicolon
multiline_comment|/* Configure GEM DMA */
id|GM_OUT
c_func
(paren
id|GM_GCONF
comma
id|GM_GCONF_BURST_SZ
op_or
(paren
l_int|31
op_lshift
id|GM_GCONF_TXDMA_LIMIT_SHIFT
)paren
op_or
(paren
l_int|31
op_lshift
id|GM_GCONF_RXDMA_LIMIT_SHIFT
)paren
)paren
suffix:semicolon
id|GM_OUT
c_func
(paren
id|GM_TX_CONF
comma
(paren
id|GM_TX_CONF_FIFO_THR_DEFAULT
op_lshift
id|GM_TX_CONF_FIFO_THR_SHIFT
)paren
op_or
id|NTX_CONF
)paren
suffix:semicolon
multiline_comment|/* 34 byte offset for checksum computation.  This works because ip_input() will clear out&n;&t; * the skb-&gt;csum and skb-&gt;ip_summed fields and recompute the csum if IP options are&n;&t; * present in the header.  34 == (ethernet header len) + sizeof(struct iphdr)&n; &t;*/
id|GM_OUT
c_func
(paren
id|GM_RX_CONF
comma
(paren
id|RX_OFFSET
op_lshift
id|GM_RX_CONF_FBYTE_OFF_SHIFT
)paren
op_or
(paren
l_int|0x22
op_lshift
id|GM_RX_CONF_CHK_START_SHIFT
)paren
op_or
(paren
id|GM_RX_CONF_DMA_THR_DEFAULT
op_lshift
id|GM_RX_CONF_DMA_THR_SHIFT
)paren
op_or
id|NRX_CONF
)paren
suffix:semicolon
multiline_comment|/* Configure other bits of MAC */
id|GM_OUT
c_func
(paren
id|GM_MAC_INTR_PKT_GAP0
comma
id|GM_MAC_INTR_PKT_GAP0_DEFAULT
)paren
suffix:semicolon
id|GM_OUT
c_func
(paren
id|GM_MAC_INTR_PKT_GAP1
comma
id|GM_MAC_INTR_PKT_GAP1_DEFAULT
)paren
suffix:semicolon
id|GM_OUT
c_func
(paren
id|GM_MAC_INTR_PKT_GAP2
comma
id|GM_MAC_INTR_PKT_GAP2_DEFAULT
)paren
suffix:semicolon
id|GM_OUT
c_func
(paren
id|GM_MAC_MIN_FRAME_SIZE
comma
id|GM_MAC_MIN_FRAME_SIZE_DEFAULT
)paren
suffix:semicolon
id|GM_OUT
c_func
(paren
id|GM_MAC_MAX_FRAME_SIZE
comma
id|GM_MAC_MAX_FRAME_SIZE_DEFAULT
)paren
suffix:semicolon
id|GM_OUT
c_func
(paren
id|GM_MAC_PREAMBLE_LEN
comma
id|GM_MAC_PREAMBLE_LEN_DEFAULT
)paren
suffix:semicolon
id|GM_OUT
c_func
(paren
id|GM_MAC_JAM_SIZE
comma
id|GM_MAC_JAM_SIZE_DEFAULT
)paren
suffix:semicolon
id|GM_OUT
c_func
(paren
id|GM_MAC_ATTEMPT_LIMIT
comma
id|GM_MAC_ATTEMPT_LIMIT_DEFAULT
)paren
suffix:semicolon
id|GM_OUT
c_func
(paren
id|GM_MAC_SLOT_TIME
comma
id|GM_MAC_SLOT_TIME_DEFAULT
)paren
suffix:semicolon
id|GM_OUT
c_func
(paren
id|GM_MAC_CONTROL_TYPE
comma
id|GM_MAC_CONTROL_TYPE_DEFAULT
)paren
suffix:semicolon
multiline_comment|/* Setup MAC addresses, clear filters, clear hash table */
id|GM_OUT
c_func
(paren
id|GM_MAC_ADDR_NORMAL0
comma
(paren
id|mac_addr
(braket
l_int|4
)braket
op_lshift
l_int|8
)paren
op_plus
id|mac_addr
(braket
l_int|5
)braket
)paren
suffix:semicolon
id|GM_OUT
c_func
(paren
id|GM_MAC_ADDR_NORMAL1
comma
(paren
id|mac_addr
(braket
l_int|2
)braket
op_lshift
l_int|8
)paren
op_plus
id|mac_addr
(braket
l_int|3
)braket
)paren
suffix:semicolon
id|GM_OUT
c_func
(paren
id|GM_MAC_ADDR_NORMAL2
comma
(paren
id|mac_addr
(braket
l_int|0
)braket
op_lshift
l_int|8
)paren
op_plus
id|mac_addr
(braket
l_int|1
)braket
)paren
suffix:semicolon
id|GM_OUT
c_func
(paren
id|GM_MAC_ADDR_ALT0
comma
l_int|0
)paren
suffix:semicolon
id|GM_OUT
c_func
(paren
id|GM_MAC_ADDR_ALT1
comma
l_int|0
)paren
suffix:semicolon
id|GM_OUT
c_func
(paren
id|GM_MAC_ADDR_ALT2
comma
l_int|0
)paren
suffix:semicolon
id|GM_OUT
c_func
(paren
id|GM_MAC_ADDR_CTRL0
comma
l_int|0x0001
)paren
suffix:semicolon
id|GM_OUT
c_func
(paren
id|GM_MAC_ADDR_CTRL1
comma
l_int|0xc200
)paren
suffix:semicolon
id|GM_OUT
c_func
(paren
id|GM_MAC_ADDR_CTRL2
comma
l_int|0x0180
)paren
suffix:semicolon
id|GM_OUT
c_func
(paren
id|GM_MAC_ADDR_FILTER0
comma
l_int|0
)paren
suffix:semicolon
id|GM_OUT
c_func
(paren
id|GM_MAC_ADDR_FILTER1
comma
l_int|0
)paren
suffix:semicolon
id|GM_OUT
c_func
(paren
id|GM_MAC_ADDR_FILTER2
comma
l_int|0
)paren
suffix:semicolon
id|GM_OUT
c_func
(paren
id|GM_MAC_ADDR_FILTER_MASK1_2
comma
l_int|0
)paren
suffix:semicolon
id|GM_OUT
c_func
(paren
id|GM_MAC_ADDR_FILTER_MASK0
comma
l_int|0
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|27
suffix:semicolon
op_increment
id|i
)paren
id|GM_OUT
c_func
(paren
id|GM_MAC_ADDR_FILTER_HASH0
op_plus
id|i
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* Clear stat counters */
id|GM_OUT
c_func
(paren
id|GM_MAC_COLLISION_CTR
comma
l_int|0
)paren
suffix:semicolon
id|GM_OUT
c_func
(paren
id|GM_MAC_FIRST_COLLISION_CTR
comma
l_int|0
)paren
suffix:semicolon
id|GM_OUT
c_func
(paren
id|GM_MAC_EXCS_COLLISION_CTR
comma
l_int|0
)paren
suffix:semicolon
id|GM_OUT
c_func
(paren
id|GM_MAC_LATE_COLLISION_CTR
comma
l_int|0
)paren
suffix:semicolon
id|GM_OUT
c_func
(paren
id|GM_MAC_DEFER_TIMER_COUNTER
comma
l_int|0
)paren
suffix:semicolon
id|GM_OUT
c_func
(paren
id|GM_MAC_PEAK_ATTEMPTS
comma
l_int|0
)paren
suffix:semicolon
id|GM_OUT
c_func
(paren
id|GM_MAC_RX_FRAME_CTR
comma
l_int|0
)paren
suffix:semicolon
id|GM_OUT
c_func
(paren
id|GM_MAC_RX_LEN_ERR_CTR
comma
l_int|0
)paren
suffix:semicolon
id|GM_OUT
c_func
(paren
id|GM_MAC_RX_ALIGN_ERR_CTR
comma
l_int|0
)paren
suffix:semicolon
id|GM_OUT
c_func
(paren
id|GM_MAC_RX_CRC_ERR_CTR
comma
l_int|0
)paren
suffix:semicolon
id|GM_OUT
c_func
(paren
id|GM_MAC_RX_CODE_VIOLATION_CTR
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* default to half duplex */
id|GM_OUT
c_func
(paren
id|GM_MAC_TX_CONFIG
comma
l_int|0
)paren
suffix:semicolon
id|GM_OUT
c_func
(paren
id|GM_MAC_RX_CONFIG
comma
l_int|0
)paren
suffix:semicolon
id|gmac_set_duplex_mode
c_func
(paren
id|gm
comma
id|gm-&gt;full_duplex
)paren
suffix:semicolon
multiline_comment|/* Setup pause thresholds */
id|fifo_size
op_assign
id|GM_IN
c_func
(paren
id|GM_RX_FIFO_SIZE
)paren
suffix:semicolon
id|GM_OUT
c_func
(paren
id|GM_RX_PTH
comma
(paren
(paren
id|fifo_size
op_minus
(paren
(paren
id|GM_MAC_MAX_FRAME_SIZE_ALIGN
op_plus
l_int|8
)paren
op_star
l_int|2
op_div
id|GM_RX_PTH_UNITS
)paren
)paren
op_lshift
id|GM_RX_PTH_OFF_SHIFT
)paren
op_or
(paren
(paren
id|fifo_size
op_minus
(paren
(paren
id|GM_MAC_MAX_FRAME_SIZE_ALIGN
op_plus
l_int|8
)paren
op_star
l_int|3
op_div
id|GM_RX_PTH_UNITS
)paren
)paren
op_lshift
id|GM_RX_PTH_ON_SHIFT
)paren
)paren
suffix:semicolon
multiline_comment|/* Setup interrupt blanking */
r_if
c_cond
(paren
id|GM_IN
c_func
(paren
id|GM_BIF_CFG
)paren
op_amp
id|GM_BIF_CFG_M66EN
)paren
id|GM_OUT
c_func
(paren
id|GM_RX_BLANK
comma
(paren
l_int|5
op_lshift
id|GM_RX_BLANK_INTR_PACKETS_SHIFT
)paren
op_or
(paren
l_int|8
op_lshift
id|GM_RX_BLANK_INTR_TIME_SHIFT
)paren
)paren
suffix:semicolon
r_else
id|GM_OUT
c_func
(paren
id|GM_RX_BLANK
comma
(paren
l_int|5
op_lshift
id|GM_RX_BLANK_INTR_PACKETS_SHIFT
)paren
op_or
(paren
l_int|4
op_lshift
id|GM_RX_BLANK_INTR_TIME_SHIFT
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Fill the Rx and Tx rings with good initial values, alloc&n; * fresh Rx skb&squot;s.&n; */
r_static
r_void
DECL|function|gmac_init_rings
id|gmac_init_rings
c_func
(paren
r_struct
id|gmac
op_star
id|gm
comma
r_int
id|from_irq
)paren
(brace
r_int
id|i
suffix:semicolon
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
r_int
r_char
op_star
id|data
suffix:semicolon
r_struct
id|gmac_dma_desc
op_star
id|ring
suffix:semicolon
r_int
id|gfp_flags
op_assign
id|GFP_KERNEL
suffix:semicolon
r_if
c_cond
(paren
id|from_irq
op_logical_or
id|in_interrupt
c_func
(paren
)paren
)paren
id|gfp_flags
op_assign
id|GFP_ATOMIC
suffix:semicolon
multiline_comment|/* init rx ring */
id|ring
op_assign
(paren
r_struct
id|gmac_dma_desc
op_star
)paren
id|gm-&gt;rxring
suffix:semicolon
id|memset
c_func
(paren
id|ring
comma
l_int|0
comma
id|NRX
op_star
r_sizeof
(paren
r_struct
id|gmac_dma_desc
)paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|NRX
suffix:semicolon
op_increment
id|i
comma
op_increment
id|ring
)paren
(brace
id|data
op_assign
id|dummy_buf
suffix:semicolon
id|gm-&gt;rx_buff
(braket
id|i
)braket
op_assign
id|skb
op_assign
id|gmac_alloc_skb
c_func
(paren
id|RX_BUF_ALLOC_SIZE
comma
id|gfp_flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|skb
op_ne
l_int|0
)paren
(brace
id|skb-&gt;dev
op_assign
id|gm-&gt;dev
suffix:semicolon
id|skb_put
c_func
(paren
id|skb
comma
id|ETH_FRAME_LEN
op_plus
id|RX_OFFSET
)paren
suffix:semicolon
id|skb_reserve
c_func
(paren
id|skb
comma
id|RX_OFFSET
)paren
suffix:semicolon
id|data
op_assign
id|skb-&gt;data
op_minus
id|RX_OFFSET
suffix:semicolon
)brace
id|st_le32
c_func
(paren
op_amp
id|ring-&gt;lo_addr
comma
id|virt_to_bus
c_func
(paren
id|data
)paren
)paren
suffix:semicolon
id|st_le32
c_func
(paren
op_amp
id|ring-&gt;size
comma
id|RX_SZ_OWN
op_or
(paren
(paren
id|RX_BUF_ALLOC_SIZE
op_minus
id|RX_OFFSET
)paren
op_lshift
id|RX_SZ_SHIFT
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/* init tx ring */
id|ring
op_assign
(paren
r_struct
id|gmac_dma_desc
op_star
)paren
id|gm-&gt;txring
suffix:semicolon
id|memset
c_func
(paren
id|ring
comma
l_int|0
comma
id|NTX
op_star
r_sizeof
(paren
r_struct
id|gmac_dma_desc
)paren
)paren
suffix:semicolon
id|gm-&gt;next_rx
op_assign
l_int|0
suffix:semicolon
id|gm-&gt;next_tx
op_assign
l_int|0
suffix:semicolon
id|gm-&gt;tx_gone
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* set pointers in chip */
id|mb
c_func
(paren
)paren
suffix:semicolon
id|GM_OUT
c_func
(paren
id|GM_RX_DESC_HI
comma
l_int|0
)paren
suffix:semicolon
id|GM_OUT
c_func
(paren
id|GM_RX_DESC_LO
comma
id|virt_to_bus
c_func
(paren
id|gm-&gt;rxring
)paren
)paren
suffix:semicolon
id|GM_OUT
c_func
(paren
id|GM_TX_DESC_HI
comma
l_int|0
)paren
suffix:semicolon
id|GM_OUT
c_func
(paren
id|GM_TX_DESC_LO
comma
id|virt_to_bus
c_func
(paren
id|gm-&gt;txring
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Start the Tx and Rx DMA engines and enable interrupts&n; * &n; * Note: The various mdelay(20); come from Darwin implentation. Some&n; * tests (doc ?) are needed to replace those with something more intrusive.&n; */
r_static
r_void
DECL|function|gmac_start_dma
id|gmac_start_dma
c_func
(paren
r_struct
id|gmac
op_star
id|gm
)paren
(brace
multiline_comment|/* Enable Tx and Rx */
id|GM_BIS
c_func
(paren
id|GM_TX_CONF
comma
id|GM_TX_CONF_DMA_EN
)paren
suffix:semicolon
id|mdelay
c_func
(paren
l_int|20
)paren
suffix:semicolon
id|GM_BIS
c_func
(paren
id|GM_RX_CONF
comma
id|GM_RX_CONF_DMA_EN
)paren
suffix:semicolon
id|mdelay
c_func
(paren
l_int|20
)paren
suffix:semicolon
id|GM_BIS
c_func
(paren
id|GM_MAC_RX_CONFIG
comma
id|GM_MAC_RX_CONF_ENABLE
)paren
suffix:semicolon
id|mdelay
c_func
(paren
l_int|20
)paren
suffix:semicolon
id|GM_BIS
c_func
(paren
id|GM_MAC_TX_CONFIG
comma
id|GM_MAC_TX_CONF_ENABLE
)paren
suffix:semicolon
id|mdelay
c_func
(paren
l_int|20
)paren
suffix:semicolon
multiline_comment|/* Kick the receiver and enable interrupts */
id|GM_OUT
c_func
(paren
id|GM_RX_KICK
comma
id|NRX
)paren
suffix:semicolon
id|GM_BIC
c_func
(paren
id|GM_IRQ_MASK
comma
id|GM_IRQ_TX_INT_ME
op_or
id|GM_IRQ_TX_ALL
op_or
id|GM_IRQ_RX_DONE
op_or
id|GM_IRQ_RX_TAG_ERR
op_or
id|GM_IRQ_MAC_RX
op_or
id|GM_IRQ_MIF
op_or
id|GM_IRQ_BUS_ERROR
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Stop the Tx and Rx DMA engines after disabling interrupts&n; * &n; * Note: The various mdelay(20); come from Darwin implentation. Some&n; * tests (doc ?) are needed to replace those with something more intrusive.&n; */
r_static
r_void
DECL|function|gmac_stop_dma
id|gmac_stop_dma
c_func
(paren
r_struct
id|gmac
op_star
id|gm
)paren
(brace
multiline_comment|/* disable interrupts */
id|GM_OUT
c_func
(paren
id|GM_IRQ_MASK
comma
l_int|0xffffffff
)paren
suffix:semicolon
multiline_comment|/* Enable Tx and Rx */
id|GM_BIC
c_func
(paren
id|GM_TX_CONF
comma
id|GM_TX_CONF_DMA_EN
)paren
suffix:semicolon
id|mdelay
c_func
(paren
l_int|20
)paren
suffix:semicolon
id|GM_BIC
c_func
(paren
id|GM_RX_CONF
comma
id|GM_RX_CONF_DMA_EN
)paren
suffix:semicolon
id|mdelay
c_func
(paren
l_int|20
)paren
suffix:semicolon
id|GM_BIC
c_func
(paren
id|GM_MAC_RX_CONFIG
comma
id|GM_MAC_RX_CONF_ENABLE
)paren
suffix:semicolon
id|mdelay
c_func
(paren
l_int|20
)paren
suffix:semicolon
id|GM_BIC
c_func
(paren
id|GM_MAC_TX_CONFIG
comma
id|GM_MAC_TX_CONF_ENABLE
)paren
suffix:semicolon
id|mdelay
c_func
(paren
l_int|20
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Configure promisc mode and setup multicast hash table&n; * filter&n; */
DECL|macro|CRC_POLY
mdefine_line|#define CRC_POLY&t;0xedb88320
r_static
r_void
DECL|function|gmac_set_multicast
id|gmac_set_multicast
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|gmac
op_star
id|gm
op_assign
(paren
r_struct
id|gmac
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_struct
id|dev_mc_list
op_star
id|dmi
op_assign
id|dev-&gt;mc_list
suffix:semicolon
r_int
id|i
comma
id|j
comma
id|k
comma
id|b
suffix:semicolon
r_int
r_int
id|crc
suffix:semicolon
r_int
id|multicast_hash
op_assign
l_int|0
suffix:semicolon
r_int
id|multicast_all
op_assign
l_int|0
suffix:semicolon
r_int
id|promisc
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Lock out others. */
id|netif_stop_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;flags
op_amp
id|IFF_PROMISC
)paren
id|promisc
op_assign
l_int|1
suffix:semicolon
r_else
r_if
c_cond
(paren
(paren
id|dev-&gt;flags
op_amp
id|IFF_ALLMULTI
)paren
multiline_comment|/* || (dev-&gt;mc_count &gt; XXX) */
)paren
(brace
id|multicast_all
op_assign
l_int|1
suffix:semicolon
)brace
r_else
(brace
id|u16
id|hash_table
(braket
l_int|16
)braket
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|16
suffix:semicolon
id|i
op_increment
)paren
(brace
id|hash_table
(braket
id|i
)braket
op_assign
l_int|0
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|dev-&gt;mc_count
suffix:semicolon
id|i
op_increment
)paren
(brace
id|crc
op_assign
op_complement
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|j
op_assign
l_int|0
suffix:semicolon
id|j
OL
l_int|6
suffix:semicolon
op_increment
id|j
)paren
(brace
id|b
op_assign
id|dmi-&gt;dmi_addr
(braket
id|j
)braket
suffix:semicolon
r_for
c_loop
(paren
id|k
op_assign
l_int|0
suffix:semicolon
id|k
OL
l_int|8
suffix:semicolon
op_increment
id|k
)paren
(brace
r_if
c_cond
(paren
(paren
id|crc
op_xor
id|b
)paren
op_amp
l_int|1
)paren
id|crc
op_assign
(paren
id|crc
op_rshift
l_int|1
)paren
op_xor
id|CRC_POLY
suffix:semicolon
r_else
id|crc
op_rshift_assign
l_int|1
suffix:semicolon
id|b
op_rshift_assign
l_int|1
suffix:semicolon
)brace
)brace
id|j
op_assign
id|crc
op_rshift
l_int|24
suffix:semicolon
multiline_comment|/* bit number in multicast_filter */
id|hash_table
(braket
id|j
op_rshift
l_int|4
)braket
op_or_assign
l_int|1
op_lshift
(paren
l_int|15
op_minus
(paren
id|j
op_amp
l_int|0xf
)paren
)paren
suffix:semicolon
id|dmi
op_assign
id|dmi-&gt;next
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|16
suffix:semicolon
id|i
op_increment
)paren
id|GM_OUT
c_func
(paren
id|GM_MAC_ADDR_FILTER_HASH0
op_plus
(paren
id|i
op_star
l_int|4
)paren
comma
id|hash_table
(braket
id|i
)braket
)paren
suffix:semicolon
id|GM_BIS
c_func
(paren
id|GM_MAC_RX_CONFIG
comma
id|GM_MAC_RX_CONF_HASH_ENABLE
)paren
suffix:semicolon
id|multicast_hash
op_assign
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|promisc
)paren
id|GM_BIS
c_func
(paren
id|GM_MAC_RX_CONFIG
comma
id|GM_MAC_RX_CONF_RX_ALL
)paren
suffix:semicolon
r_else
id|GM_BIC
c_func
(paren
id|GM_MAC_RX_CONFIG
comma
id|GM_MAC_RX_CONF_RX_ALL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|multicast_hash
)paren
id|GM_BIS
c_func
(paren
id|GM_MAC_RX_CONFIG
comma
id|GM_MAC_RX_CONF_HASH_ENABLE
)paren
suffix:semicolon
r_else
id|GM_BIC
c_func
(paren
id|GM_MAC_RX_CONFIG
comma
id|GM_MAC_RX_CONF_HASH_ENABLE
)paren
suffix:semicolon
r_if
c_cond
(paren
id|multicast_all
)paren
id|GM_BIS
c_func
(paren
id|GM_MAC_RX_CONFIG
comma
id|GM_MAC_RX_CONF_RX_ALL_MULTI
)paren
suffix:semicolon
r_else
id|GM_BIC
c_func
(paren
id|GM_MAC_RX_CONFIG
comma
id|GM_MAC_RX_CONF_RX_ALL_MULTI
)paren
suffix:semicolon
multiline_comment|/* Let us get going again. */
id|netif_wake_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Open the interface&n; */
r_static
r_int
DECL|function|gmac_open
id|gmac_open
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_int
id|ret
suffix:semicolon
r_struct
id|gmac
op_star
id|gm
op_assign
(paren
r_struct
id|gmac
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
multiline_comment|/* Power up and reset chip */
r_if
c_cond
(paren
id|gmac_powerup_and_reset
c_func
(paren
id|dev
)paren
)paren
r_return
op_minus
id|EIO
suffix:semicolon
multiline_comment|/* Get our interrupt */
id|ret
op_assign
id|request_irq
c_func
(paren
id|dev-&gt;irq
comma
id|gmac_interrupt
comma
l_int|0
comma
id|dev-&gt;name
comma
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s can&squot;t get irq %d&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|dev-&gt;irq
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
id|gm-&gt;full_duplex
op_assign
l_int|0
suffix:semicolon
id|gm-&gt;phy_status
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Find a PHY */
r_if
c_cond
(paren
op_logical_neg
id|mii_lookup_and_reset
c_func
(paren
id|gm
)paren
)paren
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s WARNING ! Can&squot;t find PHY&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
multiline_comment|/* Configure the PHY */
id|mii_setup_phy
c_func
(paren
id|gm
)paren
suffix:semicolon
multiline_comment|/* Initialize the descriptor rings */
id|gmac_init_rings
c_func
(paren
id|gm
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* Initialize the MAC */
id|gmac_mac_init
c_func
(paren
id|gm
comma
id|dev-&gt;dev_addr
)paren
suffix:semicolon
multiline_comment|/* Initialize the multicast tables &amp; promisc mode if any */
id|gmac_set_multicast
c_func
(paren
id|dev
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Check out PHY status and start auto-poll&n;&t; * &n;&t; * Note: do this before enabling interrutps&n;&t; */
id|mii_interrupt
c_func
(paren
id|gm
)paren
suffix:semicolon
multiline_comment|/* Start the chip */
id|gmac_start_dma
c_func
(paren
id|gm
)paren
suffix:semicolon
id|gm-&gt;opened
op_assign
l_int|1
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* &n; * Close the interface&n; */
r_static
r_int
DECL|function|gmac_close
id|gmac_close
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|gmac
op_star
id|gm
op_assign
(paren
r_struct
id|gmac
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_int
id|i
suffix:semicolon
id|gm-&gt;opened
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Stop chip and interrupts */
id|gmac_stop_dma
c_func
(paren
id|gm
)paren
suffix:semicolon
multiline_comment|/* Stop polling PHY */
id|mii_poll_stop
c_func
(paren
id|gm
)paren
suffix:semicolon
multiline_comment|/* Free interrupt */
id|free_irq
c_func
(paren
id|dev-&gt;irq
comma
id|dev
)paren
suffix:semicolon
multiline_comment|/* Shut down chip */
id|gmac_set_power
c_func
(paren
id|gm
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* Empty rings of any remaining gremlins */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|NRX
suffix:semicolon
op_increment
id|i
)paren
(brace
r_if
c_cond
(paren
id|gm-&gt;rx_buff
(braket
id|i
)braket
op_ne
l_int|0
)paren
(brace
id|dev_kfree_skb
c_func
(paren
id|gm-&gt;rx_buff
(braket
id|i
)braket
)paren
suffix:semicolon
id|gm-&gt;rx_buff
(braket
id|i
)braket
op_assign
l_int|0
suffix:semicolon
)brace
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|NTX
suffix:semicolon
op_increment
id|i
)paren
(brace
r_if
c_cond
(paren
id|gm-&gt;tx_buff
(braket
id|i
)braket
op_ne
l_int|0
)paren
(brace
id|dev_kfree_skb
c_func
(paren
id|gm-&gt;tx_buff
(braket
id|i
)braket
)paren
suffix:semicolon
id|gm-&gt;tx_buff
(braket
id|i
)braket
op_assign
l_int|0
suffix:semicolon
)brace
)brace
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#ifdef CONFIG_PMAC_PBOOK
r_int
DECL|function|gmac_sleep_notify
id|gmac_sleep_notify
c_func
(paren
r_struct
id|pmu_sleep_notifier
op_star
id|self
comma
r_int
id|when
)paren
(brace
r_struct
id|gmac
op_star
id|gm
suffix:semicolon
r_int
id|i
suffix:semicolon
multiline_comment|/* XXX should handle more than one */
r_if
c_cond
(paren
id|gmacs
op_eq
l_int|NULL
)paren
r_return
id|PBOOK_SLEEP_OK
suffix:semicolon
id|gm
op_assign
(paren
r_struct
id|gmac
op_star
)paren
id|gmacs-&gt;priv
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|gm-&gt;opened
)paren
r_return
id|PBOOK_SLEEP_OK
suffix:semicolon
r_switch
c_cond
(paren
id|when
)paren
(brace
r_case
id|PBOOK_SLEEP_REQUEST
suffix:colon
r_break
suffix:semicolon
r_case
id|PBOOK_SLEEP_REJECT
suffix:colon
r_break
suffix:semicolon
r_case
id|PBOOK_SLEEP_NOW
suffix:colon
id|disable_irq
c_func
(paren
id|gm-&gt;dev-&gt;irq
)paren
suffix:semicolon
id|netif_stop_queue
c_func
(paren
id|gm-&gt;dev
)paren
suffix:semicolon
id|gmac_stop_dma
c_func
(paren
id|gm
)paren
suffix:semicolon
id|mii_poll_stop
c_func
(paren
id|gm
)paren
suffix:semicolon
id|gmac_set_power
c_func
(paren
id|gm
comma
l_int|0
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|NRX
suffix:semicolon
op_increment
id|i
)paren
(brace
r_if
c_cond
(paren
id|gm-&gt;rx_buff
(braket
id|i
)braket
op_ne
l_int|0
)paren
(brace
id|dev_kfree_skb
c_func
(paren
id|gm-&gt;rx_buff
(braket
id|i
)braket
)paren
suffix:semicolon
id|gm-&gt;rx_buff
(braket
id|i
)braket
op_assign
l_int|0
suffix:semicolon
)brace
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|NTX
suffix:semicolon
op_increment
id|i
)paren
(brace
r_if
c_cond
(paren
id|gm-&gt;tx_buff
(braket
id|i
)braket
op_ne
l_int|0
)paren
(brace
id|dev_kfree_skb
c_func
(paren
id|gm-&gt;tx_buff
(braket
id|i
)braket
)paren
suffix:semicolon
id|gm-&gt;tx_buff
(braket
id|i
)braket
op_assign
l_int|0
suffix:semicolon
)brace
)brace
r_break
suffix:semicolon
r_case
id|PBOOK_WAKE
suffix:colon
multiline_comment|/* see if this is enough */
id|gmac_powerup_and_reset
c_func
(paren
id|gm-&gt;dev
)paren
suffix:semicolon
id|gm-&gt;full_duplex
op_assign
l_int|0
suffix:semicolon
id|gm-&gt;phy_status
op_assign
l_int|0
suffix:semicolon
id|mii_lookup_and_reset
c_func
(paren
id|gm
)paren
suffix:semicolon
id|mii_setup_phy
c_func
(paren
id|gm
)paren
suffix:semicolon
id|gmac_init_rings
c_func
(paren
id|gm
comma
l_int|0
)paren
suffix:semicolon
id|gmac_mac_init
c_func
(paren
id|gm
comma
id|gm-&gt;dev-&gt;dev_addr
)paren
suffix:semicolon
id|gmac_set_multicast
c_func
(paren
id|gm-&gt;dev
)paren
suffix:semicolon
id|mii_interrupt
c_func
(paren
id|gm
)paren
suffix:semicolon
id|gmac_start_dma
c_func
(paren
id|gm
)paren
suffix:semicolon
id|netif_start_queue
c_func
(paren
id|gm-&gt;dev
)paren
suffix:semicolon
id|enable_irq
c_func
(paren
id|gm-&gt;dev-&gt;irq
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_return
id|PBOOK_SLEEP_OK
suffix:semicolon
)brace
macro_line|#endif /* CONFIG_PMAC_PBOOK */
multiline_comment|/*&n; * Handle a transmit timeout&n; */
r_static
r_void
DECL|function|gmac_tx_timeout
id|gmac_tx_timeout
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|gmac
op_star
id|gm
op_assign
(paren
r_struct
id|gmac
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_int
id|i
comma
id|timeout
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|printk
(paren
id|KERN_ERR
l_string|&quot;%s: transmit timed out, resetting&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|gm-&gt;lock
comma
id|flags
)paren
suffix:semicolon
multiline_comment|/* Stop chip */
id|gmac_stop_dma
c_func
(paren
id|gm
)paren
suffix:semicolon
multiline_comment|/* Empty Tx ring of any remaining gremlins */
id|gmac_tx_cleanup
c_func
(paren
id|dev
comma
l_int|1
)paren
suffix:semicolon
multiline_comment|/* Empty Rx ring of any remaining gremlins */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|NRX
suffix:semicolon
op_increment
id|i
)paren
(brace
r_if
c_cond
(paren
id|gm-&gt;rx_buff
(braket
id|i
)braket
op_ne
l_int|0
)paren
(brace
id|dev_kfree_skb_irq
c_func
(paren
id|gm-&gt;rx_buff
(braket
id|i
)braket
)paren
suffix:semicolon
id|gm-&gt;rx_buff
(braket
id|i
)braket
op_assign
l_int|0
suffix:semicolon
)brace
)brace
multiline_comment|/* Perform a software reset */
id|GM_OUT
c_func
(paren
id|GM_RESET
comma
id|GM_RESET_TX
op_or
id|GM_RESET_RX
)paren
suffix:semicolon
r_for
c_loop
(paren
id|timeout
op_assign
l_int|100
suffix:semicolon
id|timeout
OG
l_int|0
suffix:semicolon
op_decrement
id|timeout
)paren
(brace
id|mdelay
c_func
(paren
l_int|10
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|GM_IN
c_func
(paren
id|GM_RESET
)paren
op_amp
(paren
id|GM_RESET_TX
op_or
id|GM_RESET_RX
)paren
)paren
op_eq
l_int|0
)paren
(brace
multiline_comment|/* Mask out all chips interrupts */
id|GM_OUT
c_func
(paren
id|GM_IRQ_MASK
comma
l_int|0xffffffff
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
op_logical_neg
id|timeout
)paren
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s reset chip failed !&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
multiline_comment|/* Create fresh rings */
id|gmac_init_rings
c_func
(paren
id|gm
comma
l_int|1
)paren
suffix:semicolon
multiline_comment|/* re-initialize the MAC */
id|gmac_mac_init
c_func
(paren
id|gm
comma
id|dev-&gt;dev_addr
)paren
suffix:semicolon
multiline_comment|/* re-initialize the multicast tables &amp; promisc mode if any */
id|gmac_set_multicast
c_func
(paren
id|dev
)paren
suffix:semicolon
multiline_comment|/* Restart PHY auto-poll */
id|mii_interrupt
c_func
(paren
id|gm
)paren
suffix:semicolon
multiline_comment|/* Restart chip */
id|gmac_start_dma
c_func
(paren
id|gm
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|gm-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|netif_wake_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Add a packet to the transmit ring&n; */
r_static
r_int
DECL|function|gmac_xmit_start
id|gmac_xmit_start
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|gmac
op_star
id|gm
op_assign
(paren
r_struct
id|gmac
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_volatile
r_struct
id|gmac_dma_desc
op_star
id|dp
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_int
id|i
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|gm-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|i
op_assign
id|gm-&gt;next_tx
suffix:semicolon
r_if
c_cond
(paren
id|gm-&gt;tx_buff
(braket
id|i
)braket
op_ne
l_int|0
)paren
(brace
multiline_comment|/* &n;&t;&t; * Buffer is full, can&squot;t send this packet at the moment&n;&t;&t; * &n;&t;&t; * Can this ever happen in 2.4 ?&n;&t;&t; */
id|netif_stop_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|gm-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
id|gm-&gt;next_tx
op_assign
(paren
id|i
op_plus
l_int|1
)paren
op_amp
(paren
id|NTX
op_minus
l_int|1
)paren
suffix:semicolon
id|gm-&gt;tx_buff
(braket
id|i
)braket
op_assign
id|skb
suffix:semicolon
id|dp
op_assign
op_amp
id|gm-&gt;txring
(braket
id|i
)braket
suffix:semicolon
multiline_comment|/* FIXME: Interrupt on all packet for now, change this to every N packet,&n;&t; * with N to be adjusted&n;&t; */
id|dp-&gt;flags
op_assign
id|TX_FL_INTERRUPT
suffix:semicolon
id|dp-&gt;hi_addr
op_assign
l_int|0
suffix:semicolon
id|st_le32
c_func
(paren
op_amp
id|dp-&gt;lo_addr
comma
id|virt_to_bus
c_func
(paren
id|skb-&gt;data
)paren
)paren
suffix:semicolon
id|mb
c_func
(paren
)paren
suffix:semicolon
id|st_le32
c_func
(paren
op_amp
id|dp-&gt;size
comma
id|TX_SZ_SOP
op_or
id|TX_SZ_EOP
op_or
id|skb-&gt;len
)paren
suffix:semicolon
id|mb
c_func
(paren
)paren
suffix:semicolon
id|GM_OUT
c_func
(paren
id|GM_TX_KICK
comma
id|gm-&gt;next_tx
)paren
suffix:semicolon
r_if
c_cond
(paren
id|gm-&gt;tx_buff
(braket
id|gm-&gt;next_tx
)braket
op_ne
l_int|0
)paren
id|netif_stop_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|gm-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|dev-&gt;trans_start
op_assign
id|jiffies
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * Handle servicing of the transmit ring by deallocating used&n; * Tx packets and restoring flow control when necessary&n; */
r_static
r_void
DECL|function|gmac_tx_cleanup
id|gmac_tx_cleanup
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_int
id|force_cleanup
)paren
(brace
r_struct
id|gmac
op_star
id|gm
op_assign
(paren
r_struct
id|gmac
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_volatile
r_struct
id|gmac_dma_desc
op_star
id|dp
suffix:semicolon
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
r_int
id|gone
comma
id|i
suffix:semicolon
id|i
op_assign
id|gm-&gt;tx_gone
suffix:semicolon
multiline_comment|/* Note: If i==gone, we empty the entire ring. This works because&n;&t; * if the ring was empty, we wouldn&squot;t have received the interrupt&n;&t; */
r_do
(brace
id|gone
op_assign
id|GM_IN
c_func
(paren
id|GM_TX_COMP
)paren
suffix:semicolon
id|skb
op_assign
id|gm-&gt;tx_buff
(braket
id|i
)braket
suffix:semicolon
r_if
c_cond
(paren
id|skb
op_eq
l_int|NULL
)paren
r_break
suffix:semicolon
id|dp
op_assign
op_amp
id|gm-&gt;txring
(braket
id|i
)braket
suffix:semicolon
r_if
c_cond
(paren
id|force_cleanup
)paren
op_increment
id|gm-&gt;stats.tx_errors
suffix:semicolon
r_else
(brace
op_increment
id|gm-&gt;stats.tx_packets
suffix:semicolon
id|gm-&gt;stats.tx_bytes
op_add_assign
id|skb-&gt;len
suffix:semicolon
)brace
id|gm-&gt;tx_buff
(braket
id|i
)braket
op_assign
l_int|NULL
suffix:semicolon
id|dev_kfree_skb_irq
c_func
(paren
id|skb
)paren
suffix:semicolon
r_if
c_cond
(paren
op_increment
id|i
op_ge
id|NTX
)paren
id|i
op_assign
l_int|0
suffix:semicolon
)brace
r_while
c_loop
(paren
id|force_cleanup
op_logical_or
id|i
op_ne
id|gone
)paren
suffix:semicolon
id|gm-&gt;tx_gone
op_assign
id|i
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|force_cleanup
op_logical_and
id|netif_queue_stopped
c_func
(paren
id|dev
)paren
op_logical_and
(paren
id|gm-&gt;tx_buff
(braket
id|gm-&gt;next_tx
)braket
op_eq
l_int|0
)paren
)paren
id|netif_wake_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Handle servicing of receive ring&n; */
r_static
r_void
DECL|function|gmac_receive
id|gmac_receive
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|gmac
op_star
id|gm
op_assign
(paren
r_struct
id|gmac
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_int
id|i
op_assign
id|gm-&gt;next_rx
suffix:semicolon
r_volatile
r_struct
id|gmac_dma_desc
op_star
id|dp
suffix:semicolon
r_struct
id|sk_buff
op_star
id|skb
comma
op_star
id|new_skb
suffix:semicolon
r_int
id|len
comma
id|flags
comma
id|drop
comma
id|last
suffix:semicolon
r_int
r_char
op_star
id|data
suffix:semicolon
id|u16
id|csum
suffix:semicolon
id|last
op_assign
op_minus
l_int|1
suffix:semicolon
r_for
c_loop
(paren
suffix:semicolon
suffix:semicolon
)paren
(brace
id|dp
op_assign
op_amp
id|gm-&gt;rxring
(braket
id|i
)braket
suffix:semicolon
multiline_comment|/* Buffer not yet filled, no more Rx buffers to handle */
r_if
c_cond
(paren
id|ld_le32
c_func
(paren
op_amp
id|dp-&gt;size
)paren
op_amp
id|RX_SZ_OWN
)paren
r_break
suffix:semicolon
multiline_comment|/* Get packet length, flags, etc... */
id|len
op_assign
(paren
id|ld_le32
c_func
(paren
op_amp
id|dp-&gt;size
)paren
op_rshift
l_int|16
)paren
op_amp
l_int|0x7fff
suffix:semicolon
id|flags
op_assign
id|ld_le32
c_func
(paren
op_amp
id|dp-&gt;flags
)paren
suffix:semicolon
id|skb
op_assign
id|gm-&gt;rx_buff
(braket
id|i
)braket
suffix:semicolon
id|drop
op_assign
l_int|0
suffix:semicolon
id|new_skb
op_assign
l_int|NULL
suffix:semicolon
id|csum
op_assign
id|ld_le32
c_func
(paren
op_amp
id|dp-&gt;size
)paren
op_amp
id|RX_SZ_CKSUM_MASK
suffix:semicolon
multiline_comment|/* Handle errors */
r_if
c_cond
(paren
(paren
id|len
OL
id|ETH_ZLEN
)paren
op_logical_or
(paren
id|flags
op_amp
id|RX_FL_CRC_ERROR
)paren
op_logical_or
(paren
op_logical_neg
id|skb
)paren
)paren
(brace
op_increment
id|gm-&gt;stats.rx_errors
suffix:semicolon
r_if
c_cond
(paren
id|len
OL
id|ETH_ZLEN
)paren
op_increment
id|gm-&gt;stats.rx_length_errors
suffix:semicolon
r_if
c_cond
(paren
id|flags
op_amp
id|RX_FL_CRC_ERROR
)paren
op_increment
id|gm-&gt;stats.rx_crc_errors
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|skb
)paren
(brace
op_increment
id|gm-&gt;stats.rx_dropped
suffix:semicolon
id|skb
op_assign
id|gmac_alloc_skb
c_func
(paren
id|RX_BUF_ALLOC_SIZE
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
id|skb
)paren
(brace
id|gm-&gt;rx_buff
(braket
id|i
)braket
op_assign
id|skb
suffix:semicolon
id|skb-&gt;dev
op_assign
id|dev
suffix:semicolon
id|skb_put
c_func
(paren
id|skb
comma
id|ETH_FRAME_LEN
op_plus
id|RX_OFFSET
)paren
suffix:semicolon
id|skb_reserve
c_func
(paren
id|skb
comma
id|RX_OFFSET
)paren
suffix:semicolon
)brace
)brace
id|drop
op_assign
l_int|1
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* Large packet, alloc a new skb for the ring */
r_if
c_cond
(paren
id|len
OG
id|RX_COPY_THRESHOLD
)paren
(brace
id|new_skb
op_assign
id|gmac_alloc_skb
c_func
(paren
id|RX_BUF_ALLOC_SIZE
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|new_skb
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Out of SKBs in Rx, packet dropped !&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|drop
op_assign
l_int|1
suffix:semicolon
op_increment
id|gm-&gt;stats.rx_dropped
suffix:semicolon
r_goto
id|finish
suffix:semicolon
)brace
id|gm-&gt;rx_buff
(braket
id|i
)braket
op_assign
id|new_skb
suffix:semicolon
id|new_skb-&gt;dev
op_assign
id|dev
suffix:semicolon
id|skb_put
c_func
(paren
id|new_skb
comma
id|ETH_FRAME_LEN
op_plus
id|RX_OFFSET
)paren
suffix:semicolon
id|skb_reserve
c_func
(paren
id|new_skb
comma
id|RX_OFFSET
)paren
suffix:semicolon
id|skb_trim
c_func
(paren
id|skb
comma
id|len
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* Small packet, copy it to a new small skb */
r_struct
id|sk_buff
op_star
id|copy_skb
op_assign
id|dev_alloc_skb
c_func
(paren
id|len
op_plus
id|RX_OFFSET
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|copy_skb
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Out of SKBs in Rx, packet dropped !&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|drop
op_assign
l_int|1
suffix:semicolon
op_increment
id|gm-&gt;stats.rx_dropped
suffix:semicolon
r_goto
id|finish
suffix:semicolon
)brace
id|copy_skb-&gt;dev
op_assign
id|dev
suffix:semicolon
id|skb_reserve
c_func
(paren
id|copy_skb
comma
id|RX_OFFSET
)paren
suffix:semicolon
id|skb_put
c_func
(paren
id|copy_skb
comma
id|len
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|copy_skb-&gt;data
comma
id|skb-&gt;data
comma
id|len
)paren
suffix:semicolon
id|new_skb
op_assign
id|skb
suffix:semicolon
id|skb
op_assign
id|copy_skb
suffix:semicolon
)brace
)brace
id|finish
suffix:colon
multiline_comment|/* Need to drop packet ? */
r_if
c_cond
(paren
id|drop
)paren
(brace
id|new_skb
op_assign
id|skb
suffix:semicolon
id|skb
op_assign
l_int|NULL
suffix:semicolon
)brace
multiline_comment|/* Put back ring entry */
id|data
op_assign
id|new_skb
ques
c_cond
(paren
id|new_skb-&gt;data
op_minus
id|RX_OFFSET
)paren
suffix:colon
id|dummy_buf
suffix:semicolon
id|dp-&gt;hi_addr
op_assign
l_int|0
suffix:semicolon
id|st_le32
c_func
(paren
op_amp
id|dp-&gt;lo_addr
comma
id|virt_to_bus
c_func
(paren
id|data
)paren
)paren
suffix:semicolon
id|mb
c_func
(paren
)paren
suffix:semicolon
id|st_le32
c_func
(paren
op_amp
id|dp-&gt;size
comma
id|RX_SZ_OWN
op_or
(paren
(paren
id|RX_BUF_ALLOC_SIZE
op_minus
id|RX_OFFSET
)paren
op_lshift
id|RX_SZ_SHIFT
)paren
)paren
suffix:semicolon
multiline_comment|/* Got Rx packet ? */
r_if
c_cond
(paren
id|skb
)paren
(brace
multiline_comment|/* Yes, baby, keep that hot ;) */
r_if
c_cond
(paren
op_logical_neg
(paren
id|csum
op_xor
l_int|0xffff
)paren
)paren
(brace
id|skb-&gt;ip_summed
op_assign
id|CHECKSUM_UNNECESSARY
suffix:semicolon
)brace
r_else
id|skb-&gt;ip_summed
op_assign
id|CHECKSUM_NONE
suffix:semicolon
id|skb-&gt;ip_summed
op_assign
id|CHECKSUM_NONE
suffix:semicolon
id|skb-&gt;protocol
op_assign
id|eth_type_trans
c_func
(paren
id|skb
comma
id|dev
)paren
suffix:semicolon
id|netif_rx
c_func
(paren
id|skb
)paren
suffix:semicolon
id|gm-&gt;stats.rx_bytes
op_add_assign
id|skb-&gt;len
suffix:semicolon
op_increment
id|gm-&gt;stats.rx_packets
suffix:semicolon
)brace
id|last
op_assign
id|i
suffix:semicolon
r_if
c_cond
(paren
op_increment
id|i
op_ge
id|NRX
)paren
id|i
op_assign
l_int|0
suffix:semicolon
)brace
id|gm-&gt;next_rx
op_assign
id|i
suffix:semicolon
r_if
c_cond
(paren
id|last
op_ge
l_int|0
)paren
(brace
id|mb
c_func
(paren
)paren
suffix:semicolon
id|GM_OUT
c_func
(paren
id|GM_RX_KICK
comma
id|last
op_amp
l_int|0xfffffffc
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/*&n; * Service chip interrupts&n; */
r_static
r_void
DECL|function|gmac_interrupt
id|gmac_interrupt
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_struct
id|net_device
op_star
id|dev
op_assign
(paren
r_struct
id|net_device
op_star
)paren
id|dev_id
suffix:semicolon
r_struct
id|gmac
op_star
id|gm
op_assign
(paren
r_struct
id|gmac
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_int
r_int
id|status
suffix:semicolon
id|status
op_assign
id|GM_IN
c_func
(paren
id|GM_IRQ_STATUS
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
(paren
id|GM_IRQ_BUS_ERROR
op_or
id|GM_IRQ_MIF
)paren
)paren
id|GM_OUT
c_func
(paren
id|GM_IRQ_ACK
comma
id|status
op_amp
(paren
id|GM_IRQ_BUS_ERROR
op_or
id|GM_IRQ_MIF
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
(paren
id|GM_IRQ_RX_TAG_ERR
op_or
id|GM_IRQ_BUS_ERROR
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: IRQ Error status: 0x%08x&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|status
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|status
op_amp
id|GM_IRQ_MIF
)paren
(brace
id|spin_lock
c_func
(paren
op_amp
id|gm-&gt;lock
)paren
suffix:semicolon
id|mii_interrupt
c_func
(paren
id|gm
)paren
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|gm-&gt;lock
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|status
op_amp
id|GM_IRQ_RX_DONE
)paren
(brace
id|spin_lock
c_func
(paren
op_amp
id|gm-&gt;lock
)paren
suffix:semicolon
id|gmac_receive
c_func
(paren
id|dev
)paren
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|gm-&gt;lock
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|status
op_amp
(paren
id|GM_IRQ_TX_INT_ME
op_or
id|GM_IRQ_TX_ALL
)paren
)paren
(brace
id|spin_lock
c_func
(paren
op_amp
id|gm-&gt;lock
)paren
suffix:semicolon
id|gmac_tx_cleanup
c_func
(paren
id|dev
comma
l_int|0
)paren
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|gm-&gt;lock
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/*&n; * Retreive some error stats from chip and return them&n; * to above layer&n; */
r_static
r_struct
id|net_device_stats
op_star
DECL|function|gmac_stats
id|gmac_stats
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|gmac
op_star
id|gm
op_assign
(paren
r_struct
id|gmac
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_struct
id|net_device_stats
op_star
id|stats
op_assign
op_amp
id|gm-&gt;stats
suffix:semicolon
r_if
c_cond
(paren
id|gm
op_logical_and
id|gm-&gt;opened
)paren
(brace
id|stats-&gt;rx_crc_errors
op_add_assign
id|GM_IN
c_func
(paren
id|GM_MAC_RX_CRC_ERR_CTR
)paren
suffix:semicolon
id|GM_OUT
c_func
(paren
id|GM_MAC_RX_CRC_ERR_CTR
comma
l_int|0
)paren
suffix:semicolon
id|stats-&gt;rx_frame_errors
op_add_assign
id|GM_IN
c_func
(paren
id|GM_MAC_RX_ALIGN_ERR_CTR
)paren
suffix:semicolon
id|GM_OUT
c_func
(paren
id|GM_MAC_RX_ALIGN_ERR_CTR
comma
l_int|0
)paren
suffix:semicolon
id|stats-&gt;rx_length_errors
op_add_assign
id|GM_IN
c_func
(paren
id|GM_MAC_RX_LEN_ERR_CTR
)paren
suffix:semicolon
id|GM_OUT
c_func
(paren
id|GM_MAC_RX_LEN_ERR_CTR
comma
l_int|0
)paren
suffix:semicolon
id|stats-&gt;tx_aborted_errors
op_add_assign
id|GM_IN
c_func
(paren
id|GM_MAC_EXCS_COLLISION_CTR
)paren
suffix:semicolon
id|stats-&gt;collisions
op_add_assign
(paren
id|GM_IN
c_func
(paren
id|GM_MAC_EXCS_COLLISION_CTR
)paren
op_plus
id|GM_IN
c_func
(paren
id|GM_MAC_LATE_COLLISION_CTR
)paren
)paren
suffix:semicolon
id|GM_OUT
c_func
(paren
id|GM_MAC_EXCS_COLLISION_CTR
comma
l_int|0
)paren
suffix:semicolon
id|GM_OUT
c_func
(paren
id|GM_MAC_LATE_COLLISION_CTR
comma
l_int|0
)paren
suffix:semicolon
)brace
r_return
id|stats
suffix:semicolon
)brace
r_static
r_int
id|__init
DECL|function|gmac_probe
id|gmac_probe
c_func
(paren
r_void
)paren
(brace
r_struct
id|device_node
op_star
id|gmac
suffix:semicolon
multiline_comment|/* We bump use count during probe since get_free_page can sleep&n;&t; * which can be a race condition if module is unloaded at this&n;&t; * point.&n;&t; */
id|MOD_INC_USE_COUNT
suffix:semicolon
multiline_comment|/*&n;&t; * We don&squot;t use PCI scanning on pmac since the GMAC cell is disabled&n;&t; * by default, and thus absent from kernel original PCI probing.&n;&t; */
r_for
c_loop
(paren
id|gmac
op_assign
id|find_compatible_devices
c_func
(paren
l_string|&quot;network&quot;
comma
l_string|&quot;gmac&quot;
)paren
suffix:semicolon
id|gmac
op_ne
l_int|0
suffix:semicolon
id|gmac
op_assign
id|gmac-&gt;next
)paren
id|gmac_probe1
c_func
(paren
id|gmac
)paren
suffix:semicolon
id|MOD_DEC_USE_COUNT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_void
DECL|function|gmac_probe1
id|gmac_probe1
c_func
(paren
r_struct
id|device_node
op_star
id|gmac
)paren
(brace
r_struct
id|gmac
op_star
id|gm
suffix:semicolon
r_int
r_int
id|tx_descpage
comma
id|rx_descpage
suffix:semicolon
r_int
r_char
op_star
id|addr
suffix:semicolon
r_struct
id|net_device
op_star
id|dev
suffix:semicolon
r_int
id|i
suffix:semicolon
r_if
c_cond
(paren
id|gmac-&gt;n_addrs
OL
l_int|1
op_logical_or
id|gmac-&gt;n_intrs
OL
l_int|1
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;can&squot;t use GMAC %s: %d addrs and %d intrs&bslash;n&quot;
comma
id|gmac-&gt;full_name
comma
id|gmac-&gt;n_addrs
comma
id|gmac-&gt;n_intrs
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|addr
op_assign
id|get_property
c_func
(paren
id|gmac
comma
l_string|&quot;local-mac-address&quot;
comma
l_int|NULL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|addr
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;Can&squot;t get mac-address for GMAC %s&bslash;n&quot;
comma
id|gmac-&gt;full_name
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|tx_descpage
op_assign
id|get_free_page
c_func
(paren
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tx_descpage
op_eq
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;GMAC: can&squot;t get a page for tx descriptors&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|rx_descpage
op_assign
id|get_free_page
c_func
(paren
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rx_descpage
op_eq
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;GMAC: can&squot;t get a page for rx descriptors&bslash;n&quot;
)paren
suffix:semicolon
id|free_page
c_func
(paren
id|tx_descpage
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|dev
op_assign
id|init_etherdev
c_func
(paren
l_int|NULL
comma
r_sizeof
(paren
r_struct
id|gmac
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dev
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;GMAC: init_etherdev failed, out of memory&bslash;n&quot;
)paren
suffix:semicolon
id|free_page
c_func
(paren
id|tx_descpage
)paren
suffix:semicolon
id|free_page
c_func
(paren
id|rx_descpage
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|SET_MODULE_OWNER
c_func
(paren
id|dev
)paren
suffix:semicolon
id|gm
op_assign
id|dev-&gt;priv
suffix:semicolon
id|dev-&gt;base_addr
op_assign
id|gmac-&gt;addrs
(braket
l_int|0
)braket
dot
id|address
suffix:semicolon
id|gm-&gt;regs
op_assign
(paren
r_volatile
r_int
r_int
op_star
)paren
id|ioremap
c_func
(paren
id|gmac-&gt;addrs
(braket
l_int|0
)braket
dot
id|address
comma
l_int|0x10000
)paren
suffix:semicolon
id|dev-&gt;irq
op_assign
id|gmac-&gt;intrs
(braket
l_int|0
)braket
dot
id|line
suffix:semicolon
id|gm-&gt;dev
op_assign
id|dev
suffix:semicolon
id|gm-&gt;of_node
op_assign
id|gmac
suffix:semicolon
id|spin_lock_init
c_func
(paren
op_amp
id|gm-&gt;lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pci_device_from_OF_node
c_func
(paren
id|gmac
comma
op_amp
id|gm-&gt;pci_bus
comma
op_amp
id|gm-&gt;pci_devfn
)paren
)paren
(brace
id|gm-&gt;pci_bus
op_assign
id|gm-&gt;pci_devfn
op_assign
l_int|0xff
suffix:semicolon
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;Can&squot;t locate GMAC PCI entry&bslash;n&quot;
)paren
suffix:semicolon
)brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: GMAC at&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|6
suffix:semicolon
op_increment
id|i
)paren
(brace
id|dev-&gt;dev_addr
(braket
id|i
)braket
op_assign
id|addr
(braket
id|i
)braket
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;%c%.2x&quot;
comma
(paren
id|i
ques
c_cond
l_char|&squot;:&squot;
suffix:colon
l_char|&squot; &squot;
)paren
comma
id|addr
(braket
id|i
)braket
)paren
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;, driver &quot;
id|GMAC_VERSION
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
id|gm-&gt;tx_desc_page
op_assign
id|tx_descpage
suffix:semicolon
id|gm-&gt;rx_desc_page
op_assign
id|rx_descpage
suffix:semicolon
id|gm-&gt;rxring
op_assign
(paren
r_volatile
r_struct
id|gmac_dma_desc
op_star
)paren
id|rx_descpage
suffix:semicolon
id|gm-&gt;txring
op_assign
(paren
r_volatile
r_struct
id|gmac_dma_desc
op_star
)paren
id|tx_descpage
suffix:semicolon
id|gm-&gt;phy_addr
op_assign
l_int|0
suffix:semicolon
id|gm-&gt;opened
op_assign
l_int|0
suffix:semicolon
id|dev-&gt;open
op_assign
id|gmac_open
suffix:semicolon
id|dev-&gt;stop
op_assign
id|gmac_close
suffix:semicolon
id|dev-&gt;hard_start_xmit
op_assign
id|gmac_xmit_start
suffix:semicolon
id|dev-&gt;get_stats
op_assign
id|gmac_stats
suffix:semicolon
id|dev-&gt;set_multicast_list
op_assign
op_amp
id|gmac_set_multicast
suffix:semicolon
id|dev-&gt;tx_timeout
op_assign
op_amp
id|gmac_tx_timeout
suffix:semicolon
id|dev-&gt;watchdog_timeo
op_assign
l_int|5
op_star
id|HZ
suffix:semicolon
id|ether_setup
c_func
(paren
id|dev
)paren
suffix:semicolon
id|gm-&gt;next_gmac
op_assign
id|gmacs
suffix:semicolon
id|gmacs
op_assign
id|dev
suffix:semicolon
macro_line|#ifdef CONFIG_PMAC_PBOOK
id|pmu_register_sleep_notifier
c_func
(paren
op_amp
id|gmac_sleep_notifier
)paren
suffix:semicolon
macro_line|#endif
)brace
id|MODULE_AUTHOR
c_func
(paren
l_string|&quot;Paul Mackerras/Ben Herrenschmidt&quot;
)paren
suffix:semicolon
id|MODULE_DESCRIPTION
c_func
(paren
l_string|&quot;PowerMac GMAC driver.&quot;
)paren
suffix:semicolon
DECL|function|gmac_cleanup_module
r_static
r_void
id|__exit
id|gmac_cleanup_module
c_func
(paren
r_void
)paren
(brace
r_struct
id|gmac
op_star
id|gm
suffix:semicolon
r_struct
id|net_device
op_star
id|dev
suffix:semicolon
r_while
c_loop
(paren
(paren
id|dev
op_assign
id|gmacs
)paren
op_ne
l_int|NULL
)paren
(brace
id|gm
op_assign
(paren
r_struct
id|gmac
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|unregister_netdev
c_func
(paren
id|dev
)paren
suffix:semicolon
id|free_page
c_func
(paren
id|gm-&gt;tx_desc_page
)paren
suffix:semicolon
id|free_page
c_func
(paren
id|gm-&gt;rx_desc_page
)paren
suffix:semicolon
id|gmacs
op_assign
id|gm-&gt;next_gmac
suffix:semicolon
id|kfree
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
)brace
DECL|variable|gmac_probe
id|module_init
c_func
(paren
id|gmac_probe
)paren
suffix:semicolon
DECL|variable|gmac_cleanup_module
id|module_exit
c_func
(paren
id|gmac_cleanup_module
)paren
suffix:semicolon
eof
