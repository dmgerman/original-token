multiline_comment|/*&t;ni5010.c: A network driver for the MiCom-Interlan NI5010 ethercard.&n; *&n; *&t;Copyright 1996,1997 Jan-Pascal van Best and Andreas Mohr.&n; *&n; *&t;This software may be used and distributed according to the terms&n; *&t;of the GNU Public License, incorporated herein by reference.&n; *&n; * &t;The authors may be reached as:&n; *&t;&t;jvbest@wi.leidenuniv.nl&t;&t;a.mohr@mailto.de&n; * &t;or by snail mail as&n; * &t;&t;Jan-Pascal van Best&t;&t;Andreas Mohr&n; *&t;&t;Klikspaanweg 58-4&t;&t;Stauferstr. 6&n; *&t;&t;2324 LZ  Leiden&t;&t;&t;D-71272 Renningen&n; *&t;&t;The Netherlands&t;&t;&t;Germany&n; *&n; *&t;Sources:&n; * &t; &t;Donald Becker&squot;s &quot;skeleton.c&quot;&n; *  &t;&t;Crynwr ni5010 packet driver&n; *&n; *&t;Changes:&n; *&t;&t;v0.0: First test version&n; *&t;&t;v0.1: First working version&n; *&t;&t;v0.2:&n; *&t;&t;v0.3-&gt;v0.90: Now demand setting io and irq when loading as module&n; *&t;970430&t;v0.91: modified for Linux 2.1.14&n; *&t;&t;v0.92: Implemented Andreas&squot; (better) NI5010 probe&n; *&t;970503&t;v0.93: Fixed auto-irq failure on warm reboot (JB)&n; *&t;970623&t;v1.00: First kernel version (AM)&n; *&t;970814&t;v1.01: Added detection of onboard receive buffer size (AM)&n; *&t;Bugs:&n; *&t;&t;- None known...&n; *&t;&t;- Note that you have to patch ifconfig for the new /proc/net/dev&n; *&t;&t;format. It gives incorrect stats otherwise.&n; *&n; *&t;To do:&n; *&t;&t;Fix all bugs :-)&n; *&t;&t;Move some stuff to chipset_init()&n; *&t;&t;Handle xmt errors other than collisions&n; *&t;&t;Complete merge with Andreas&squot; driver&n; *&t;&t;Implement ring buffers (Is this useful? You can&squot;t squeeze&n; *&t;&t;&t;too many packet in a 2k buffer!)&n; *&t;&t;Implement DMA (Again, is this useful? Some docs says DMA is&n; *&t;&t;&t;slower than programmed I/O)&n; *&n; *&t;Compile with:&n; *&t;&t;gcc -O2 -fomit-frame-pointer -m486 -D__KERNEL__ &bslash;&n; *&t;&t;&t;-DMODULE -c ni5010.c &n; *&n; *&t;Insert with e.g.:&n; *&t;&t;insmod ni5010.o io=0x300 irq=5 &t;&n; */
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/ioport.h&gt;
macro_line|#include &lt;linux/malloc.h&gt;
macro_line|#include &lt;linux/interrupt.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;asm/bitops.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/dma.h&gt;
macro_line|#include &lt;linux/netdevice.h&gt;
macro_line|#include &lt;linux/etherdevice.h&gt;
macro_line|#include &lt;linux/skbuff.h&gt;
macro_line|#include &quot;ni5010.h&quot;
DECL|variable|boardname
r_static
r_const
r_char
op_star
id|boardname
op_assign
l_string|&quot;NI5010&quot;
suffix:semicolon
DECL|variable|version
r_static
r_char
op_star
id|version
op_assign
l_string|&quot;ni5010.c: v1.00 06/23/97 Jan-Pascal van Best and Andreas Mohr&bslash;n&quot;
suffix:semicolon
multiline_comment|/* bufsize_rcv == 0 means autoprobing */
DECL|variable|bufsize_rcv
r_static
r_int
r_int
id|bufsize_rcv
op_assign
l_int|0
suffix:semicolon
DECL|macro|jumpered_interrupts
mdefine_line|#define jumpered_interrupts&t;/* IRQ line jumpered on board */
DECL|macro|jumpered_dma
macro_line|#undef jumpered_dma&t;&t;/* No DMA used */
DECL|macro|FULL_IODETECT
macro_line|#undef FULL_IODETECT&t;&t;/* Only detect in portlist */
macro_line|#ifndef FULL_IODETECT
multiline_comment|/* A zero-terminated list of I/O addresses to be probed. */
DECL|variable|__initdata
r_static
r_int
r_int
id|ni5010_portlist
(braket
)braket
id|__initdata
op_assign
(brace
l_int|0x300
comma
l_int|0x320
comma
l_int|0x340
comma
l_int|0x360
comma
l_int|0x380
comma
l_int|0x3a0
comma
l_int|0
)brace
suffix:semicolon
macro_line|#endif
multiline_comment|/* Use 0 for production, 1 for verification, &gt;2 for debug */
macro_line|#ifndef NI5010_DEBUG
DECL|macro|NI5010_DEBUG
mdefine_line|#define NI5010_DEBUG 0
macro_line|#endif
multiline_comment|/* Information that needs to be kept for each board. */
DECL|struct|ni5010_local
r_struct
id|ni5010_local
(brace
DECL|member|stats
r_struct
id|net_device_stats
id|stats
suffix:semicolon
DECL|member|o_pkt_size
r_int
id|o_pkt_size
suffix:semicolon
DECL|member|i_pkt_size
r_int
id|i_pkt_size
suffix:semicolon
)brace
suffix:semicolon
multiline_comment|/* Index to functions, as function prototypes. */
r_extern
r_int
id|ni5010_probe
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_int
id|ni5010_probe1
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_int
id|ioaddr
)paren
suffix:semicolon
r_static
r_int
id|ni5010_open
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_int
id|ni5010_send_packet
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_void
id|ni5010_interrupt
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
suffix:semicolon
r_static
r_void
id|ni5010_rx
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_void
id|ni5010_timeout
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_int
id|ni5010_close
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_struct
id|net_device_stats
op_star
id|ni5010_get_stats
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_void
id|ni5010_set_multicast_list
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_void
id|reset_receiver
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_int
id|process_xmt_interrupt
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
DECL|macro|tx_done
mdefine_line|#define tx_done(dev) 1
r_static
r_void
id|hardware_send_packet
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_char
op_star
id|buf
comma
r_int
id|length
)paren
suffix:semicolon
r_static
r_void
id|chipset_init
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_int
id|startp
)paren
suffix:semicolon
r_static
r_void
id|dump_packet
c_func
(paren
r_void
op_star
id|buf
comma
r_int
id|len
)paren
suffix:semicolon
r_static
r_void
id|show_registers
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
DECL|function|ni5010_probe
r_int
id|__init
id|ni5010_probe
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_int
op_star
id|port
suffix:semicolon
r_int
id|base_addr
op_assign
id|dev-&gt;base_addr
suffix:semicolon
id|PRINTK2
c_func
(paren
(paren
id|KERN_DEBUG
l_string|&quot;%s: Entering ni5010_probe&bslash;n&quot;
comma
id|dev-&gt;name
)paren
)paren
suffix:semicolon
id|SET_MODULE_OWNER
c_func
(paren
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|base_addr
OG
l_int|0x1ff
)paren
multiline_comment|/* Check a single specified location. */
r_return
id|ni5010_probe1
c_func
(paren
id|dev
comma
id|base_addr
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
id|base_addr
op_ne
l_int|0
)paren
multiline_comment|/* Don&squot;t probe at all. */
r_return
op_minus
id|ENXIO
suffix:semicolon
macro_line|#ifdef FULL_IODETECT
r_for
c_loop
(paren
r_int
id|ioaddr
op_assign
l_int|0x200
suffix:semicolon
id|ioaddr
OL
l_int|0x400
suffix:semicolon
id|ioaddr
op_add_assign
l_int|0x20
)paren
(brace
r_if
c_cond
(paren
id|check_region
c_func
(paren
id|ioaddr
comma
id|NI5010_IO_EXTENT
)paren
)paren
r_continue
suffix:semicolon
r_if
c_cond
(paren
id|ni5010_probe1
c_func
(paren
id|dev
comma
id|ioaddr
)paren
op_eq
l_int|0
)paren
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#else
r_for
c_loop
(paren
id|port
op_assign
id|ni5010_portlist
suffix:semicolon
op_star
id|port
suffix:semicolon
id|port
op_increment
)paren
(brace
r_int
id|ioaddr
op_assign
op_star
id|port
suffix:semicolon
r_if
c_cond
(paren
id|check_region
c_func
(paren
id|ioaddr
comma
id|NI5010_IO_EXTENT
)paren
)paren
r_continue
suffix:semicolon
r_if
c_cond
(paren
id|ni5010_probe1
c_func
(paren
id|dev
comma
id|ioaddr
)paren
op_eq
l_int|0
)paren
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#endif&t;/* FULL_IODETECT */
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
DECL|function|rd_port
r_static
r_inline
r_int
id|rd_port
c_func
(paren
r_int
id|ioaddr
)paren
(brace
id|inb
c_func
(paren
id|IE_RBUF
)paren
suffix:semicolon
r_return
id|inb
c_func
(paren
id|IE_SAPROM
)paren
suffix:semicolon
)brace
DECL|function|trigger_irq
r_static
r_void
id|__init
id|trigger_irq
c_func
(paren
r_int
id|ioaddr
)paren
(brace
id|outb
c_func
(paren
l_int|0x00
comma
id|EDLC_RESET
)paren
suffix:semicolon
multiline_comment|/* Clear EDLC hold RESET state */
id|outb
c_func
(paren
l_int|0x00
comma
id|IE_RESET
)paren
suffix:semicolon
multiline_comment|/* Board reset */
id|outb
c_func
(paren
l_int|0x00
comma
id|EDLC_XMASK
)paren
suffix:semicolon
multiline_comment|/* Disable all Xmt interrupts */
id|outb
c_func
(paren
l_int|0x00
comma
id|EDLC_RMASK
)paren
suffix:semicolon
multiline_comment|/* Disable all Rcv interrupt */
id|outb
c_func
(paren
l_int|0xff
comma
id|EDLC_XCLR
)paren
suffix:semicolon
multiline_comment|/* Clear all pending Xmt interrupts */
id|outb
c_func
(paren
l_int|0xff
comma
id|EDLC_RCLR
)paren
suffix:semicolon
multiline_comment|/* Clear all pending Rcv interrupts */
multiline_comment|/*&n;&t;&t; * Transmit packet mode: Ignore parity, Power xcvr,&n;&t;&t; * &t;Enable loopback&n;&t;&t; */
id|outb
c_func
(paren
id|XMD_IG_PAR
op_or
id|XMD_T_MODE
op_or
id|XMD_LBC
comma
id|EDLC_XMODE
)paren
suffix:semicolon
id|outb
c_func
(paren
id|RMD_BROADCAST
comma
id|EDLC_RMODE
)paren
suffix:semicolon
multiline_comment|/* Receive normal&amp;broadcast */
id|outb
c_func
(paren
id|XM_ALL
comma
id|EDLC_XMASK
)paren
suffix:semicolon
multiline_comment|/* Enable all Xmt interrupts */
id|udelay
c_func
(paren
l_int|50
)paren
suffix:semicolon
multiline_comment|/* FIXME: Necessary? */
id|outb
c_func
(paren
id|MM_EN_XMT
op_or
id|MM_MUX
comma
id|IE_MMODE
)paren
suffix:semicolon
multiline_comment|/* Start transmission */
)brace
multiline_comment|/*&n; *      This is the real probe routine.  Linux has a history of friendly device&n; *      probes on the ISA bus.  A good device probes avoids doing writes, and&n; *      verifies that the correct device exists and functions.&n; */
DECL|function|ni5010_probe1
r_static
r_int
id|__init
id|ni5010_probe1
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_int
id|ioaddr
)paren
(brace
r_static
r_int
id|version_printed
op_assign
l_int|0
suffix:semicolon
r_int
id|i
suffix:semicolon
r_int
r_int
id|data
op_assign
l_int|0
suffix:semicolon
r_int
id|boguscount
op_assign
l_int|40
suffix:semicolon
multiline_comment|/*&n;&t; * This is no &quot;official&quot; probe method, I&squot;ve rather tested which&n;&t; * probe works best with my seven NI5010 cards&n;&t; * (they have very different serial numbers)&n;&t; * Suggestions or failure reports are very, very welcome !&n;&t; * But I think it is a relatively good probe method&n;&t; * since it doesn&squot;t use any &quot;outb&quot;&n;&t; * It should be nearly 100% reliable !&n;&t; * well-known WARNING: this probe method (like many others)&n;&t; * will hang the system if a NE2000 card region is probed !&n;&t; *&n;&t; *   - Andreas&n;&t; */
id|PRINTK2
c_func
(paren
(paren
id|KERN_DEBUG
l_string|&quot;%s: entering ni5010_probe1(%#3x)&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|ioaddr
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|inb
c_func
(paren
id|ioaddr
op_plus
l_int|0
)paren
op_eq
l_int|0xff
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
r_while
c_loop
(paren
(paren
id|rd_port
c_func
(paren
id|ioaddr
)paren
op_amp
id|rd_port
c_func
(paren
id|ioaddr
)paren
op_amp
id|rd_port
c_func
(paren
id|ioaddr
)paren
op_amp
id|rd_port
c_func
(paren
id|ioaddr
)paren
op_amp
id|rd_port
c_func
(paren
id|ioaddr
)paren
op_amp
id|rd_port
c_func
(paren
id|ioaddr
)paren
)paren
op_ne
l_int|0xff
)paren
(brace
r_if
c_cond
(paren
id|boguscount
op_decrement
op_eq
l_int|0
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
id|PRINTK2
c_func
(paren
(paren
id|KERN_DEBUG
l_string|&quot;%s: I/O #1 passed!&bslash;n&quot;
comma
id|dev-&gt;name
)paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|32
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
(paren
id|data
op_assign
id|rd_port
c_func
(paren
id|ioaddr
)paren
)paren
op_ne
l_int|0xff
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
id|data
op_eq
l_int|0xff
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
id|PRINTK2
c_func
(paren
(paren
id|KERN_DEBUG
l_string|&quot;%s: I/O #2 passed!&bslash;n&quot;
comma
id|dev-&gt;name
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|data
op_eq
id|SA_ADDR0
)paren
op_logical_and
(paren
id|rd_port
c_func
(paren
id|ioaddr
)paren
op_eq
id|SA_ADDR1
)paren
op_logical_and
(paren
id|rd_port
c_func
(paren
id|ioaddr
)paren
op_eq
id|SA_ADDR2
)paren
)paren
(brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|4
suffix:semicolon
id|i
op_increment
)paren
id|rd_port
c_func
(paren
id|ioaddr
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|rd_port
c_func
(paren
id|ioaddr
)paren
op_ne
id|NI5010_MAGICVAL1
)paren
op_logical_or
(paren
id|rd_port
c_func
(paren
id|ioaddr
)paren
op_ne
id|NI5010_MAGICVAL2
)paren
)paren
(brace
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
)brace
r_else
r_return
op_minus
id|ENODEV
suffix:semicolon
id|PRINTK2
c_func
(paren
(paren
id|KERN_DEBUG
l_string|&quot;%s: I/O #3 passed!&bslash;n&quot;
comma
id|dev-&gt;name
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|NI5010_DEBUG
op_logical_and
id|version_printed
op_increment
op_eq
l_int|0
)paren
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s&quot;
comma
id|version
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;NI5010 ethercard probe at 0x%x: &quot;
comma
id|ioaddr
)paren
suffix:semicolon
id|dev-&gt;base_addr
op_assign
id|ioaddr
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|6
suffix:semicolon
id|i
op_increment
)paren
(brace
id|outw
c_func
(paren
id|i
comma
id|IE_GP
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;%2.2x &quot;
comma
id|dev-&gt;dev_addr
(braket
id|i
)braket
op_assign
id|inb
c_func
(paren
id|IE_SAPROM
)paren
)paren
suffix:semicolon
)brace
id|PRINTK2
c_func
(paren
(paren
id|KERN_DEBUG
l_string|&quot;%s: I/O #4 passed!&bslash;n&quot;
comma
id|dev-&gt;name
)paren
)paren
suffix:semicolon
macro_line|#ifdef jumpered_interrupts
r_if
c_cond
(paren
id|dev-&gt;irq
op_eq
l_int|0xff
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
id|dev-&gt;irq
OL
l_int|2
)paren
(brace
id|PRINTK2
c_func
(paren
(paren
id|KERN_DEBUG
l_string|&quot;%s: I/O #5 passed!&bslash;n&quot;
comma
id|dev-&gt;name
)paren
)paren
suffix:semicolon
id|autoirq_setup
c_func
(paren
l_int|0
)paren
suffix:semicolon
id|trigger_irq
c_func
(paren
id|ioaddr
)paren
suffix:semicolon
id|dev-&gt;irq
op_assign
id|autoirq_report
c_func
(paren
l_int|2
)paren
suffix:semicolon
id|PRINTK2
c_func
(paren
(paren
id|KERN_DEBUG
l_string|&quot;%s: I/O #6 passed!&bslash;n&quot;
comma
id|dev-&gt;name
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;irq
op_eq
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: no IRQ found!&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_return
op_minus
id|EAGAIN
suffix:semicolon
)brace
id|PRINTK2
c_func
(paren
(paren
id|KERN_DEBUG
l_string|&quot;%s: I/O #7 passed!&bslash;n&quot;
comma
id|dev-&gt;name
)paren
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|dev-&gt;irq
op_eq
l_int|2
)paren
(brace
id|dev-&gt;irq
op_assign
l_int|9
suffix:semicolon
)brace
macro_line|#endif&t;/* jumpered_irq */
id|PRINTK2
c_func
(paren
(paren
id|KERN_DEBUG
l_string|&quot;%s: I/O #9 passed!&bslash;n&quot;
comma
id|dev-&gt;name
)paren
)paren
suffix:semicolon
multiline_comment|/* DMA is not supported (yet?), so no use detecting it */
r_if
c_cond
(paren
id|dev-&gt;priv
op_eq
l_int|NULL
)paren
(brace
id|dev-&gt;priv
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|ni5010_local
)paren
comma
id|GFP_KERNEL
op_or
id|GFP_DMA
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;priv
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: Failed to allocate private memory&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
)brace
id|PRINTK2
c_func
(paren
(paren
id|KERN_DEBUG
l_string|&quot;%s: I/O #10 passed!&bslash;n&quot;
comma
id|dev-&gt;name
)paren
)paren
suffix:semicolon
multiline_comment|/* get the size of the onboard receive buffer&n; * higher addresses than bufsize are wrapped into real buffer&n; * i.e. data for offs. 0x801 is written to 0x1 with a 2K onboard buffer&n; */
r_if
c_cond
(paren
op_logical_neg
id|bufsize_rcv
)paren
(brace
id|outb
c_func
(paren
l_int|1
comma
id|IE_MMODE
)paren
suffix:semicolon
multiline_comment|/* Put Rcv buffer on system bus */
id|outw
c_func
(paren
l_int|0
comma
id|IE_GP
)paren
suffix:semicolon
multiline_comment|/* Point GP at start of packet */
id|outb
c_func
(paren
l_int|0
comma
id|IE_RBUF
)paren
suffix:semicolon
multiline_comment|/* set buffer byte 0 to 0 */
r_for
c_loop
(paren
id|i
op_assign
l_int|1
suffix:semicolon
id|i
OL
l_int|0xff
suffix:semicolon
id|i
op_increment
)paren
(brace
id|outw
c_func
(paren
id|i
op_lshift
l_int|8
comma
id|IE_GP
)paren
suffix:semicolon
multiline_comment|/* Point GP at packet size to be tested */
id|outb
c_func
(paren
id|i
comma
id|IE_RBUF
)paren
suffix:semicolon
id|outw
c_func
(paren
l_int|0x0
comma
id|IE_GP
)paren
suffix:semicolon
multiline_comment|/* Point GP at start of packet */
id|data
op_assign
id|inb
c_func
(paren
id|IE_RBUF
)paren
suffix:semicolon
r_if
c_cond
(paren
id|data
op_eq
id|i
)paren
r_break
suffix:semicolon
)brace
id|bufsize_rcv
op_assign
id|i
op_lshift
l_int|8
suffix:semicolon
id|outw
c_func
(paren
l_int|0
comma
id|IE_GP
)paren
suffix:semicolon
multiline_comment|/* Point GP at start of packet */
id|outb
c_func
(paren
l_int|0
comma
id|IE_RBUF
)paren
suffix:semicolon
multiline_comment|/* set buffer byte 0 to 0 again */
)brace
id|printk
c_func
(paren
l_string|&quot;// bufsize rcv/xmt=%d/%d&bslash;n&quot;
comma
id|bufsize_rcv
comma
id|NI5010_BUFSIZE
)paren
suffix:semicolon
id|memset
c_func
(paren
id|dev-&gt;priv
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|ni5010_local
)paren
)paren
suffix:semicolon
multiline_comment|/* Grab the region so we can find another board if autoIRQ fails. */
id|request_region
c_func
(paren
id|ioaddr
comma
id|NI5010_IO_EXTENT
comma
id|boardname
)paren
suffix:semicolon
id|dev-&gt;open
op_assign
id|ni5010_open
suffix:semicolon
id|dev-&gt;stop
op_assign
id|ni5010_close
suffix:semicolon
id|dev-&gt;hard_start_xmit
op_assign
id|ni5010_send_packet
suffix:semicolon
id|dev-&gt;get_stats
op_assign
id|ni5010_get_stats
suffix:semicolon
id|dev-&gt;set_multicast_list
op_assign
id|ni5010_set_multicast_list
suffix:semicolon
id|dev-&gt;tx_timeout
op_assign
id|ni5010_timeout
suffix:semicolon
id|dev-&gt;watchdog_timeo
op_assign
id|HZ
op_div
l_int|20
suffix:semicolon
multiline_comment|/* Fill in the fields of the device structure with ethernet values. */
id|ether_setup
c_func
(paren
id|dev
)paren
suffix:semicolon
id|dev-&gt;flags
op_and_assign
op_complement
id|IFF_MULTICAST
suffix:semicolon
multiline_comment|/* Multicast doesn&squot;t work */
multiline_comment|/* Shut up the ni5010 */
id|outb
c_func
(paren
l_int|0
comma
id|EDLC_RMASK
)paren
suffix:semicolon
multiline_comment|/* Mask all receive interrupts */
id|outb
c_func
(paren
l_int|0
comma
id|EDLC_XMASK
)paren
suffix:semicolon
multiline_comment|/* Mask all xmit interrupts */
id|outb
c_func
(paren
l_int|0xff
comma
id|EDLC_RCLR
)paren
suffix:semicolon
multiline_comment|/* Kill all pending rcv interrupts */
id|outb
c_func
(paren
l_int|0xff
comma
id|EDLC_XCLR
)paren
suffix:semicolon
multiline_comment|/* Kill all pending xmt interrupts */
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: NI5010 found at 0x%x, using IRQ %d&quot;
comma
id|dev-&gt;name
comma
id|ioaddr
comma
id|dev-&gt;irq
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;dma
)paren
id|printk
c_func
(paren
l_string|&quot; &amp; DMA %d&quot;
comma
id|dev-&gt;dma
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;.&bslash;n&quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;Join the NI5010 driver development team!&bslash;n&quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;Mail to a.mohr@mailto.de or jvbest@wi.leidenuniv.nl&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* &n; * Open/initialize the board.  This is called (in the current kernel)&n; * sometime after booting when the &squot;ifconfig&squot; program is run.&n; *&n; * This routine should set everything up anew at each open, even&n; * registers that &quot;should&quot; only need to be set once at boot, so that&n; * there is non-reboot way to recover if something goes wrong.&n; */
DECL|function|ni5010_open
r_static
r_int
id|ni5010_open
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_int
id|ioaddr
op_assign
id|dev-&gt;base_addr
suffix:semicolon
r_int
id|i
suffix:semicolon
id|PRINTK2
c_func
(paren
(paren
id|KERN_DEBUG
l_string|&quot;%s: entering ni5010_open()&bslash;n&quot;
comma
id|dev-&gt;name
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|request_irq
c_func
(paren
id|dev-&gt;irq
comma
op_amp
id|ni5010_interrupt
comma
l_int|0
comma
id|boardname
comma
id|dev
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: Cannot get irq %#2x&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|dev-&gt;irq
)paren
suffix:semicolon
r_return
op_minus
id|EAGAIN
suffix:semicolon
)brace
id|PRINTK3
c_func
(paren
(paren
id|KERN_DEBUG
l_string|&quot;%s: passed open() #1&bslash;n&quot;
comma
id|dev-&gt;name
)paren
)paren
suffix:semicolon
multiline_comment|/*&n;         * Always allocate the DMA channel after the IRQ,&n;         * and clean up on failure.&n;         */
macro_line|#ifdef jumpered_dma
r_if
c_cond
(paren
id|request_dma
c_func
(paren
id|dev-&gt;dma
comma
id|cardname
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: Cannot get dma %#2x&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|dev-&gt;dma
)paren
suffix:semicolon
id|free_irq
c_func
(paren
id|dev-&gt;irq
comma
l_int|NULL
)paren
suffix:semicolon
r_return
op_minus
id|EAGAIN
suffix:semicolon
)brace
macro_line|#endif&t;/* jumpered_dma */
id|PRINTK3
c_func
(paren
(paren
id|KERN_DEBUG
l_string|&quot;%s: passed open() #2&bslash;n&quot;
comma
id|dev-&gt;name
)paren
)paren
suffix:semicolon
multiline_comment|/* Reset the hardware here.  Don&squot;t forget to set the station address. */
id|outb
c_func
(paren
id|RS_RESET
comma
id|EDLC_RESET
)paren
suffix:semicolon
multiline_comment|/* Hold up EDLC_RESET while configing board */
id|outb
c_func
(paren
l_int|0
comma
id|IE_RESET
)paren
suffix:semicolon
multiline_comment|/* Hardware reset of ni5010 board */
id|outb
c_func
(paren
id|XMD_LBC
comma
id|EDLC_XMODE
)paren
suffix:semicolon
multiline_comment|/* Only loopback xmits */
id|PRINTK3
c_func
(paren
(paren
id|KERN_DEBUG
l_string|&quot;%s: passed open() #3&bslash;n&quot;
comma
id|dev-&gt;name
)paren
)paren
suffix:semicolon
multiline_comment|/* Set the station address */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|6
suffix:semicolon
id|i
op_increment
)paren
(brace
id|outb
c_func
(paren
id|dev-&gt;dev_addr
(braket
id|i
)braket
comma
id|EDLC_ADDR
op_plus
id|i
)paren
suffix:semicolon
)brace
id|PRINTK3
c_func
(paren
(paren
id|KERN_DEBUG
l_string|&quot;%s: Initialising ni5010&bslash;n&quot;
comma
id|dev-&gt;name
)paren
)paren
suffix:semicolon
id|outb
c_func
(paren
l_int|0
comma
id|EDLC_XMASK
)paren
suffix:semicolon
multiline_comment|/* No xmit interrupts for now */
id|outb
c_func
(paren
id|XMD_IG_PAR
op_or
id|XMD_T_MODE
op_or
id|XMD_LBC
comma
id|EDLC_XMODE
)paren
suffix:semicolon
multiline_comment|/* Normal packet xmit mode */
id|outb
c_func
(paren
l_int|0xff
comma
id|EDLC_XCLR
)paren
suffix:semicolon
multiline_comment|/* Clear all pending xmit interrupts */
id|outb
c_func
(paren
id|RMD_BROADCAST
comma
id|EDLC_RMODE
)paren
suffix:semicolon
multiline_comment|/* Receive broadcast and normal packets */
id|reset_receiver
c_func
(paren
id|dev
)paren
suffix:semicolon
multiline_comment|/* Ready ni5010 for receiving packets */
id|outb
c_func
(paren
l_int|0
comma
id|EDLC_RESET
)paren
suffix:semicolon
multiline_comment|/* Un-reset the ni5010 */
id|netif_start_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|NI5010_DEBUG
)paren
id|show_registers
c_func
(paren
id|dev
)paren
suffix:semicolon
id|PRINTK
c_func
(paren
(paren
id|KERN_DEBUG
l_string|&quot;%s: open successful&bslash;n&quot;
comma
id|dev-&gt;name
)paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|reset_receiver
r_static
r_void
id|reset_receiver
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_int
id|ioaddr
op_assign
id|dev-&gt;base_addr
suffix:semicolon
id|PRINTK3
c_func
(paren
(paren
id|KERN_DEBUG
l_string|&quot;%s: resetting receiver&bslash;n&quot;
comma
id|dev-&gt;name
)paren
)paren
suffix:semicolon
id|outw
c_func
(paren
l_int|0
comma
id|IE_GP
)paren
suffix:semicolon
multiline_comment|/* Receive packet at start of buffer */
id|outb
c_func
(paren
l_int|0xff
comma
id|EDLC_RCLR
)paren
suffix:semicolon
multiline_comment|/* Clear all pending rcv interrupts */
id|outb
c_func
(paren
l_int|0
comma
id|IE_MMODE
)paren
suffix:semicolon
multiline_comment|/* Put EDLC to rcv buffer */
id|outb
c_func
(paren
id|MM_EN_RCV
comma
id|IE_MMODE
)paren
suffix:semicolon
multiline_comment|/* Enable rcv */
id|outb
c_func
(paren
l_int|0xff
comma
id|EDLC_RMASK
)paren
suffix:semicolon
multiline_comment|/* Enable all rcv interrupts */
)brace
DECL|function|ni5010_timeout
r_static
r_void
id|ni5010_timeout
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: transmit timed out, %s?&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|tx_done
c_func
(paren
id|dev
)paren
ques
c_cond
l_string|&quot;IRQ conflict&quot;
suffix:colon
l_string|&quot;network cable problem&quot;
)paren
suffix:semicolon
multiline_comment|/* Try to restart the adaptor. */
multiline_comment|/* FIXME: Give it a real kick here */
id|chipset_init
c_func
(paren
id|dev
comma
l_int|1
)paren
suffix:semicolon
id|dev-&gt;trans_start
op_assign
id|jiffies
suffix:semicolon
id|netif_wake_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
DECL|function|ni5010_send_packet
r_static
r_int
id|ni5010_send_packet
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_int
id|length
op_assign
id|ETH_ZLEN
OL
id|skb-&gt;len
ques
c_cond
id|skb-&gt;len
suffix:colon
id|ETH_ZLEN
suffix:semicolon
id|PRINTK2
c_func
(paren
(paren
id|KERN_DEBUG
l_string|&quot;%s: entering ni5010_send_packet&bslash;n&quot;
comma
id|dev-&gt;name
)paren
)paren
suffix:semicolon
multiline_comment|/* &n;         * Block sending&n;&t; */
id|netif_stop_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
id|hardware_send_packet
c_func
(paren
id|dev
comma
(paren
r_int
r_char
op_star
)paren
id|skb-&gt;data
comma
id|length
)paren
suffix:semicolon
id|dev-&gt;trans_start
op_assign
id|jiffies
suffix:semicolon
id|dev_kfree_skb
(paren
id|skb
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* &n; * The typical workload of the driver:&n; * Handle the network interface interrupts. &n; */
DECL|function|ni5010_interrupt
r_static
r_void
id|ni5010_interrupt
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_struct
id|net_device
op_star
id|dev
op_assign
id|dev_id
suffix:semicolon
r_struct
id|ni5010_local
op_star
id|lp
suffix:semicolon
r_int
id|ioaddr
comma
id|status
suffix:semicolon
r_int
id|xmit_was_error
op_assign
l_int|0
suffix:semicolon
id|PRINTK2
c_func
(paren
(paren
id|KERN_DEBUG
l_string|&quot;%s: entering ni5010_interrupt&bslash;n&quot;
comma
id|dev-&gt;name
)paren
)paren
suffix:semicolon
id|ioaddr
op_assign
id|dev-&gt;base_addr
suffix:semicolon
id|lp
op_assign
(paren
r_struct
id|ni5010_local
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|status
op_assign
id|inb
c_func
(paren
id|IE_ISTAT
)paren
suffix:semicolon
id|PRINTK3
c_func
(paren
(paren
id|KERN_DEBUG
l_string|&quot;%s: IE_ISTAT = %#02x&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|status
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|status
op_amp
id|IS_R_INT
)paren
op_eq
l_int|0
)paren
id|ni5010_rx
c_func
(paren
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|status
op_amp
id|IS_X_INT
)paren
op_eq
l_int|0
)paren
(brace
id|xmit_was_error
op_assign
id|process_xmt_interrupt
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|status
op_amp
id|IS_DMA_INT
)paren
op_eq
l_int|0
)paren
(brace
id|PRINTK
c_func
(paren
(paren
id|KERN_DEBUG
l_string|&quot;%s: DMA complete (???)&bslash;n&quot;
comma
id|dev-&gt;name
)paren
)paren
suffix:semicolon
id|outb
c_func
(paren
l_int|0
comma
id|IE_DMA_RST
)paren
suffix:semicolon
multiline_comment|/* Reset DMA int */
)brace
r_if
c_cond
(paren
op_logical_neg
id|xmit_was_error
)paren
id|reset_receiver
c_func
(paren
id|dev
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
DECL|function|dump_packet
r_static
r_void
id|dump_packet
c_func
(paren
r_void
op_star
id|buf
comma
r_int
id|len
)paren
(brace
r_int
id|i
suffix:semicolon
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;Packet length = %#4x&bslash;n&quot;
comma
id|len
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|len
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|i
op_mod
l_int|16
op_eq
l_int|0
)paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%#4.4x&quot;
comma
id|i
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
op_mod
l_int|2
op_eq
l_int|0
)paren
id|printk
c_func
(paren
l_string|&quot; &quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;%2.2x&quot;
comma
(paren
(paren
r_int
r_char
op_star
)paren
id|buf
)paren
(braket
id|i
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
op_mod
l_int|16
op_eq
l_int|15
)paren
id|printk
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/* We have a good packet, get it out of the buffer. */
DECL|function|ni5010_rx
r_static
r_void
id|ni5010_rx
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|ni5010_local
op_star
id|lp
op_assign
(paren
r_struct
id|ni5010_local
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_int
id|ioaddr
op_assign
id|dev-&gt;base_addr
suffix:semicolon
r_int
r_char
id|rcv_stat
suffix:semicolon
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
id|PRINTK2
c_func
(paren
(paren
id|KERN_DEBUG
l_string|&quot;%s: entering ni5010_rx()&bslash;n&quot;
comma
id|dev-&gt;name
)paren
)paren
suffix:semicolon
id|rcv_stat
op_assign
id|inb
c_func
(paren
id|EDLC_RSTAT
)paren
suffix:semicolon
id|PRINTK3
c_func
(paren
(paren
id|KERN_DEBUG
l_string|&quot;%s: EDLC_RSTAT = %#2x&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|rcv_stat
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|rcv_stat
op_amp
id|RS_VALID_BITS
)paren
op_ne
id|RS_PKT_OK
)paren
(brace
id|PRINTK
c_func
(paren
(paren
id|KERN_INFO
l_string|&quot;%s: receive error.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
)paren
suffix:semicolon
id|lp-&gt;stats.rx_errors
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|rcv_stat
op_amp
id|RS_RUNT
)paren
id|lp-&gt;stats.rx_length_errors
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|rcv_stat
op_amp
id|RS_ALIGN
)paren
id|lp-&gt;stats.rx_frame_errors
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|rcv_stat
op_amp
id|RS_CRC_ERR
)paren
id|lp-&gt;stats.rx_crc_errors
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|rcv_stat
op_amp
id|RS_OFLW
)paren
id|lp-&gt;stats.rx_fifo_errors
op_increment
suffix:semicolon
id|outb
c_func
(paren
l_int|0xff
comma
id|EDLC_RCLR
)paren
suffix:semicolon
multiline_comment|/* Clear the interrupt */
r_return
suffix:semicolon
)brace
id|outb
c_func
(paren
l_int|0xff
comma
id|EDLC_RCLR
)paren
suffix:semicolon
multiline_comment|/* Clear the interrupt */
id|lp-&gt;i_pkt_size
op_assign
id|inw
c_func
(paren
id|IE_RCNT
)paren
suffix:semicolon
r_if
c_cond
(paren
id|lp-&gt;i_pkt_size
OG
id|ETH_FRAME_LEN
op_logical_or
id|lp-&gt;i_pkt_size
OL
l_int|10
)paren
(brace
id|PRINTK
c_func
(paren
(paren
id|KERN_DEBUG
l_string|&quot;%s: Packet size error, packet size = %#4.4x&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|lp-&gt;i_pkt_size
)paren
)paren
suffix:semicolon
id|lp-&gt;stats.rx_errors
op_increment
suffix:semicolon
id|lp-&gt;stats.rx_length_errors
op_increment
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/* Malloc up new buffer. */
id|skb
op_assign
id|dev_alloc_skb
c_func
(paren
id|lp-&gt;i_pkt_size
op_plus
l_int|3
)paren
suffix:semicolon
r_if
c_cond
(paren
id|skb
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: Memory squeeze, dropping packet.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|lp-&gt;stats.rx_dropped
op_increment
suffix:semicolon
r_return
suffix:semicolon
)brace
id|skb-&gt;dev
op_assign
id|dev
suffix:semicolon
id|skb_reserve
c_func
(paren
id|skb
comma
l_int|2
)paren
suffix:semicolon
multiline_comment|/* Read packet into buffer */
id|outb
c_func
(paren
id|MM_MUX
comma
id|IE_MMODE
)paren
suffix:semicolon
multiline_comment|/* Rcv buffer to system bus */
id|outw
c_func
(paren
l_int|0
comma
id|IE_GP
)paren
suffix:semicolon
multiline_comment|/* Seek to beginning of packet */
id|insb
c_func
(paren
id|IE_RBUF
comma
id|skb_put
c_func
(paren
id|skb
comma
id|lp-&gt;i_pkt_size
)paren
comma
id|lp-&gt;i_pkt_size
)paren
suffix:semicolon
r_if
c_cond
(paren
id|NI5010_DEBUG
op_ge
l_int|4
)paren
id|dump_packet
c_func
(paren
id|skb-&gt;data
comma
id|skb-&gt;len
)paren
suffix:semicolon
id|skb-&gt;protocol
op_assign
id|eth_type_trans
c_func
(paren
id|skb
comma
id|dev
)paren
suffix:semicolon
id|netif_rx
c_func
(paren
id|skb
)paren
suffix:semicolon
id|lp-&gt;stats.rx_packets
op_increment
suffix:semicolon
id|lp-&gt;stats.rx_bytes
op_add_assign
id|lp-&gt;i_pkt_size
suffix:semicolon
id|PRINTK2
c_func
(paren
(paren
id|KERN_DEBUG
l_string|&quot;%s: Received packet, size=%#4.4x&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|lp-&gt;i_pkt_size
)paren
)paren
suffix:semicolon
)brace
DECL|function|process_xmt_interrupt
r_static
r_int
id|process_xmt_interrupt
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|ni5010_local
op_star
id|lp
op_assign
(paren
r_struct
id|ni5010_local
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_int
id|ioaddr
op_assign
id|dev-&gt;base_addr
suffix:semicolon
r_int
id|xmit_stat
suffix:semicolon
id|PRINTK2
c_func
(paren
(paren
id|KERN_DEBUG
l_string|&quot;%s: entering process_xmt_interrupt&bslash;n&quot;
comma
id|dev-&gt;name
)paren
)paren
suffix:semicolon
id|xmit_stat
op_assign
id|inb
c_func
(paren
id|EDLC_XSTAT
)paren
suffix:semicolon
id|PRINTK3
c_func
(paren
(paren
id|KERN_DEBUG
l_string|&quot;%s: EDLC_XSTAT = %2.2x&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|xmit_stat
)paren
)paren
suffix:semicolon
id|outb
c_func
(paren
l_int|0
comma
id|EDLC_XMASK
)paren
suffix:semicolon
multiline_comment|/* Disable xmit IRQ&squot;s */
id|outb
c_func
(paren
l_int|0xff
comma
id|EDLC_XCLR
)paren
suffix:semicolon
multiline_comment|/* Clear all pending xmit IRQ&squot;s */
r_if
c_cond
(paren
id|xmit_stat
op_amp
id|XS_COLL
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;ether collision&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* FIXME: remove */
id|PRINTK
c_func
(paren
(paren
id|KERN_DEBUG
l_string|&quot;%s: collision detected, retransmitting&bslash;n&quot;
comma
id|dev-&gt;name
)paren
)paren
suffix:semicolon
id|outw
c_func
(paren
id|NI5010_BUFSIZE
op_minus
id|lp-&gt;o_pkt_size
comma
id|IE_GP
)paren
suffix:semicolon
multiline_comment|/* outb(0, IE_MMODE); */
multiline_comment|/* xmt buf on sysbus FIXME: needed ? */
id|outb
c_func
(paren
id|MM_EN_XMT
op_or
id|MM_MUX
comma
id|IE_MMODE
)paren
suffix:semicolon
id|outb
c_func
(paren
id|XM_ALL
comma
id|EDLC_XMASK
)paren
suffix:semicolon
multiline_comment|/* Enable xmt IRQ&squot;s */
id|lp-&gt;stats.collisions
op_increment
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
multiline_comment|/* FIXME: handle other xmt error conditions */
id|lp-&gt;stats.tx_packets
op_increment
suffix:semicolon
id|lp-&gt;stats.tx_bytes
op_add_assign
id|lp-&gt;o_pkt_size
suffix:semicolon
id|netif_wake_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
id|PRINTK2
c_func
(paren
(paren
id|KERN_DEBUG
l_string|&quot;%s: sent packet, size=%#4.4x&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|lp-&gt;o_pkt_size
)paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* The inverse routine to ni5010_open(). */
DECL|function|ni5010_close
r_static
r_int
id|ni5010_close
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_int
id|ioaddr
op_assign
id|dev-&gt;base_addr
suffix:semicolon
id|PRINTK2
c_func
(paren
(paren
id|KERN_DEBUG
l_string|&quot;%s: entering ni5010_close&bslash;n&quot;
comma
id|dev-&gt;name
)paren
)paren
suffix:semicolon
macro_line|#ifdef jumpered_interrupts&t;
id|free_irq
c_func
(paren
id|dev-&gt;irq
comma
l_int|NULL
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/* Put card in held-RESET state */
id|outb
c_func
(paren
l_int|0
comma
id|IE_MMODE
)paren
suffix:semicolon
id|outb
c_func
(paren
id|RS_RESET
comma
id|EDLC_RESET
)paren
suffix:semicolon
id|netif_stop_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
id|PRINTK
c_func
(paren
(paren
id|KERN_DEBUG
l_string|&quot;%s: %s closed down&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|boardname
)paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Get the current statistics.&t;This may be called with the card open or&n;   closed. */
DECL|function|ni5010_get_stats
r_static
r_struct
id|net_device_stats
op_star
id|ni5010_get_stats
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|ni5010_local
op_star
id|lp
op_assign
(paren
r_struct
id|ni5010_local
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|PRINTK2
c_func
(paren
(paren
id|KERN_DEBUG
l_string|&quot;%s: entering ni5010_get_stats&bslash;n&quot;
comma
id|dev-&gt;name
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|NI5010_DEBUG
)paren
id|show_registers
c_func
(paren
id|dev
)paren
suffix:semicolon
multiline_comment|/* cli(); */
multiline_comment|/* Update the statistics from the device registers. */
multiline_comment|/* We do this in the interrupt handler */
multiline_comment|/* sti(); */
r_return
op_amp
id|lp-&gt;stats
suffix:semicolon
)brace
multiline_comment|/* Set or clear the multicast filter for this adaptor.&n;   num_addrs == -1      Promiscuous mode, receive all packets&n;   num_addrs == 0       Normal mode, clear multicast list&n;   num_addrs &gt; 0        Multicast mode, receive normal and MC packets, and do&n;                        best-effort filtering.&n;*/
DECL|function|ni5010_set_multicast_list
r_static
r_void
id|ni5010_set_multicast_list
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_int
id|ioaddr
op_assign
id|dev-&gt;base_addr
suffix:semicolon
id|PRINTK2
c_func
(paren
(paren
id|KERN_DEBUG
l_string|&quot;%s: entering set_multicast_list&bslash;n&quot;
comma
id|dev-&gt;name
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;flags
op_amp
id|IFF_PROMISC
op_logical_or
id|dev-&gt;flags
op_amp
id|IFF_ALLMULTI
)paren
(brace
id|dev-&gt;flags
op_or_assign
id|IFF_PROMISC
suffix:semicolon
id|outb
c_func
(paren
id|RMD_PROMISC
comma
id|EDLC_RMODE
)paren
suffix:semicolon
multiline_comment|/* Enable promiscuous mode */
id|PRINTK
c_func
(paren
(paren
id|KERN_DEBUG
l_string|&quot;%s: Entering promiscuous mode&bslash;n&quot;
comma
id|dev-&gt;name
)paren
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|dev-&gt;mc_list
)paren
(brace
multiline_comment|/* Sorry, multicast not supported */
id|PRINTK
c_func
(paren
(paren
id|KERN_DEBUG
l_string|&quot;%s: No multicast, entering broadcast mode&bslash;n&quot;
comma
id|dev-&gt;name
)paren
)paren
suffix:semicolon
id|outb
c_func
(paren
id|RMD_BROADCAST
comma
id|EDLC_RMODE
)paren
suffix:semicolon
)brace
r_else
(brace
id|PRINTK
c_func
(paren
(paren
id|KERN_DEBUG
l_string|&quot;%s: Entering broadcast mode&bslash;n&quot;
comma
id|dev-&gt;name
)paren
)paren
suffix:semicolon
id|outb
c_func
(paren
id|RMD_BROADCAST
comma
id|EDLC_RMODE
)paren
suffix:semicolon
multiline_comment|/* Disable promiscuous mode, use normal mode */
)brace
)brace
DECL|function|hardware_send_packet
r_static
r_void
id|hardware_send_packet
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_char
op_star
id|buf
comma
r_int
id|length
)paren
(brace
r_struct
id|ni5010_local
op_star
id|lp
op_assign
(paren
r_struct
id|ni5010_local
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_int
id|ioaddr
op_assign
id|dev-&gt;base_addr
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_int
r_int
id|buf_offs
suffix:semicolon
id|PRINTK2
c_func
(paren
(paren
id|KERN_DEBUG
l_string|&quot;%s: entering hardware_send_packet&bslash;n&quot;
comma
id|dev-&gt;name
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|length
OG
id|ETH_FRAME_LEN
)paren
(brace
id|PRINTK
c_func
(paren
(paren
id|KERN_WARNING
l_string|&quot;%s: packet too large, not possible&bslash;n&quot;
comma
id|dev-&gt;name
)paren
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|NI5010_DEBUG
)paren
id|show_registers
c_func
(paren
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|inb
c_func
(paren
id|IE_ISTAT
)paren
op_amp
id|IS_EN_XMT
)paren
(brace
id|PRINTK
c_func
(paren
(paren
id|KERN_WARNING
l_string|&quot;%s: sending packet while already transmitting, not possible&bslash;n&quot;
comma
id|dev-&gt;name
)paren
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|NI5010_DEBUG
OG
l_int|3
)paren
id|dump_packet
c_func
(paren
id|buf
comma
id|length
)paren
suffix:semicolon
id|buf_offs
op_assign
id|NI5010_BUFSIZE
op_minus
id|length
suffix:semicolon
id|lp-&gt;o_pkt_size
op_assign
id|length
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|outb
c_func
(paren
l_int|0
comma
id|EDLC_RMASK
)paren
suffix:semicolon
multiline_comment|/* Mask all receive interrupts */
id|outb
c_func
(paren
l_int|0
comma
id|IE_MMODE
)paren
suffix:semicolon
multiline_comment|/* Put Xmit buffer on system bus */
id|outb
c_func
(paren
l_int|0xff
comma
id|EDLC_RCLR
)paren
suffix:semicolon
multiline_comment|/* Clear out pending rcv interrupts */
id|outw
c_func
(paren
id|buf_offs
comma
id|IE_GP
)paren
suffix:semicolon
multiline_comment|/* Point GP at start of packet */
id|outsb
c_func
(paren
id|IE_XBUF
comma
id|buf
comma
id|length
)paren
suffix:semicolon
multiline_comment|/* Put data in buffer */
id|outw
c_func
(paren
id|buf_offs
comma
id|IE_GP
)paren
suffix:semicolon
multiline_comment|/* Rewrite where packet starts */
multiline_comment|/* should work without that outb() (Crynwr used it) */
multiline_comment|/*outb(MM_MUX, IE_MMODE);*/
multiline_comment|/* Xmt buffer to EDLC bus */
id|outb
c_func
(paren
id|MM_EN_XMT
op_or
id|MM_MUX
comma
id|IE_MMODE
)paren
suffix:semicolon
multiline_comment|/* Begin transmission */
id|outb
c_func
(paren
id|XM_ALL
comma
id|EDLC_XMASK
)paren
suffix:semicolon
multiline_comment|/* Cause interrupt after completion or fail */
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|netif_wake_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|NI5010_DEBUG
)paren
id|show_registers
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
DECL|function|chipset_init
r_static
r_void
id|chipset_init
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_int
id|startp
)paren
(brace
multiline_comment|/* FIXME: Move some stuff here */
id|PRINTK3
c_func
(paren
(paren
id|KERN_DEBUG
l_string|&quot;%s: doing NOTHING in chipset_init&bslash;n&quot;
comma
id|dev-&gt;name
)paren
)paren
suffix:semicolon
)brace
DECL|function|show_registers
r_static
r_void
id|show_registers
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_int
id|ioaddr
op_assign
id|dev-&gt;base_addr
suffix:semicolon
id|PRINTK3
c_func
(paren
(paren
id|KERN_DEBUG
l_string|&quot;%s: XSTAT %#2.2x&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|inb
c_func
(paren
id|EDLC_XSTAT
)paren
)paren
)paren
suffix:semicolon
id|PRINTK3
c_func
(paren
(paren
id|KERN_DEBUG
l_string|&quot;%s: XMASK %#2.2x&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|inb
c_func
(paren
id|EDLC_XMASK
)paren
)paren
)paren
suffix:semicolon
id|PRINTK3
c_func
(paren
(paren
id|KERN_DEBUG
l_string|&quot;%s: RSTAT %#2.2x&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|inb
c_func
(paren
id|EDLC_RSTAT
)paren
)paren
)paren
suffix:semicolon
id|PRINTK3
c_func
(paren
(paren
id|KERN_DEBUG
l_string|&quot;%s: RMASK %#2.2x&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|inb
c_func
(paren
id|EDLC_RMASK
)paren
)paren
)paren
suffix:semicolon
id|PRINTK3
c_func
(paren
(paren
id|KERN_DEBUG
l_string|&quot;%s: RMODE %#2.2x&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|inb
c_func
(paren
id|EDLC_RMODE
)paren
)paren
)paren
suffix:semicolon
id|PRINTK3
c_func
(paren
(paren
id|KERN_DEBUG
l_string|&quot;%s: XMODE %#2.2x&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|inb
c_func
(paren
id|EDLC_XMODE
)paren
)paren
)paren
suffix:semicolon
id|PRINTK3
c_func
(paren
(paren
id|KERN_DEBUG
l_string|&quot;%s: ISTAT %#2.2x&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|inb
c_func
(paren
id|IE_ISTAT
)paren
)paren
)paren
suffix:semicolon
)brace
macro_line|#ifdef MODULE
DECL|variable|dev_ni5010
r_static
r_struct
id|net_device
id|dev_ni5010
suffix:semicolon
DECL|variable|io
r_static
r_int
id|io
suffix:semicolon
DECL|variable|irq
r_static
r_int
id|irq
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|io
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|irq
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
DECL|function|init_module
r_int
id|init_module
c_func
(paren
r_void
)paren
(brace
r_int
id|result
suffix:semicolon
id|PRINTK2
c_func
(paren
(paren
id|KERN_DEBUG
l_string|&quot;%s: entering init_module&bslash;n&quot;
comma
id|boardname
)paren
)paren
suffix:semicolon
multiline_comment|/*&n;&t;if(io &lt;= 0 || irq == 0){&n;&t;   &t;printk(KERN_WARNING &quot;%s: Autoprobing not allowed for modules.&bslash;n&quot;, boardname);&n;&t;&t;printk(KERN_WARNING &quot;%s: Set symbols &squot;io&squot; and &squot;irq&squot;&bslash;n&quot;, boardname);&n;&t;   &t;return -EINVAL;&n;&t;}&n;&t;*/
r_if
c_cond
(paren
id|io
op_le
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: Autoprobing for modules is hazardous, trying anyway..&bslash;n&quot;
comma
id|boardname
)paren
suffix:semicolon
)brace
id|PRINTK2
c_func
(paren
(paren
id|KERN_DEBUG
l_string|&quot;%s: init_module irq=%#2x, io=%#3x&bslash;n&quot;
comma
id|boardname
comma
id|irq
comma
id|io
)paren
)paren
suffix:semicolon
id|dev_ni5010.irq
op_assign
id|irq
suffix:semicolon
id|dev_ni5010.base_addr
op_assign
id|io
suffix:semicolon
id|dev_ni5010.init
op_assign
id|ni5010_probe
suffix:semicolon
r_if
c_cond
(paren
(paren
id|result
op_assign
id|register_netdev
c_func
(paren
op_amp
id|dev_ni5010
)paren
)paren
op_ne
l_int|0
)paren
(brace
id|PRINTK
c_func
(paren
(paren
id|KERN_WARNING
l_string|&quot;%s: register_netdev returned %d.&bslash;n&quot;
comma
id|boardname
comma
id|result
)paren
)paren
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
r_void
DECL|function|cleanup_module
id|cleanup_module
c_func
(paren
r_void
)paren
(brace
id|PRINTK2
c_func
(paren
(paren
id|KERN_DEBUG
l_string|&quot;%s: entering cleanup_module&bslash;n&quot;
comma
id|boardname
)paren
)paren
suffix:semicolon
id|unregister_netdev
c_func
(paren
op_amp
id|dev_ni5010
)paren
suffix:semicolon
id|release_region
c_func
(paren
id|dev_ni5010.base_addr
comma
id|NI5010_IO_EXTENT
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dev_ni5010.priv
op_ne
l_int|NULL
)paren
(brace
id|kfree
c_func
(paren
id|dev_ni5010.priv
)paren
suffix:semicolon
id|dev_ni5010.priv
op_assign
l_int|NULL
suffix:semicolon
)brace
)brace
macro_line|#endif /* MODULE */
multiline_comment|/*&n; * Local variables:&n; *  compile-command: &quot;gcc -D__KERNEL__ -I/usr/src/linux/net/inet -Wall -Wstrict-prototypes -O6 -m486 -c ni5010.c&quot;&n; *  version-control: t&n; *  kept-new-versions: 5&n; *  tab-width: 4&n; * End:&n; */
eof
