multiline_comment|/* mvme147.c  : the  Linux/mvme147/lance ethernet driver&n; *&n; * Copyright (C) 05/1998 Peter Maydell &lt;pmaydell@chiark.greenend.org.uk&gt;&n; * Based on the Sun Lance driver and the NetBSD HP Lance driver&n; * Uses the generic 7990.c LANCE code.&n; */
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/interrupt.h&gt;
macro_line|#include &lt;linux/ptrace.h&gt;
macro_line|#include &lt;linux/ioport.h&gt;
macro_line|#include &lt;linux/malloc.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;asm/system.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/pgtable.h&gt;
multiline_comment|/* Used for the temporal inet entries and routing */
macro_line|#include &lt;linux/socket.h&gt;
macro_line|#include &lt;linux/route.h&gt;
macro_line|#include &lt;linux/dio.h&gt;
macro_line|#include &lt;linux/netdevice.h&gt;
macro_line|#include &lt;linux/etherdevice.h&gt;
macro_line|#include &lt;linux/skbuff.h&gt;
macro_line|#include &lt;asm/mvme147hw.h&gt;
multiline_comment|/* We have 16834 bytes of RAM for the init block and buffers. This places&n; * an upper limit on the number of buffers we can use. NetBSD uses 8 Rx&n; * buffers and 2 Tx buffers.&n; */
DECL|macro|LANCE_LOG_TX_BUFFERS
mdefine_line|#define LANCE_LOG_TX_BUFFERS 1
DECL|macro|LANCE_LOG_RX_BUFFERS
mdefine_line|#define LANCE_LOG_RX_BUFFERS 3
macro_line|#include &quot;7990.h&quot;                                 /* use generic LANCE code */
multiline_comment|/* Our private data structure */
DECL|struct|m147lance_private
r_struct
id|m147lance_private
(brace
DECL|member|lance
r_struct
id|lance_private
id|lance
suffix:semicolon
DECL|member|base
r_void
op_star
id|base
suffix:semicolon
DECL|member|ram
r_void
op_star
id|ram
suffix:semicolon
)brace
suffix:semicolon
multiline_comment|/* function prototypes... This is easy because all the grot is in the&n; * generic LANCE support. All we have to support is probing for boards,&n; * plus board-specific init, open and close actions.&n; * Oh, and we need to tell the generic code how to read and write LANCE registers...&n; */
r_int
id|mvme147lance_probe
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_int
id|m147lance_open
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_int
id|m147lance_close
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_void
id|m147lance_writerap
c_func
(paren
r_struct
id|m147lance_private
op_star
id|lp
comma
r_int
r_int
id|value
)paren
suffix:semicolon
r_static
r_void
id|m147lance_writerdp
c_func
(paren
r_struct
id|m147lance_private
op_star
id|lp
comma
r_int
r_int
id|value
)paren
suffix:semicolon
r_static
r_int
r_int
id|m147lance_readrdp
c_func
(paren
r_struct
id|m147lance_private
op_star
id|lp
)paren
suffix:semicolon
DECL|typedef|writerap_t
r_typedef
r_void
(paren
op_star
id|writerap_t
)paren
(paren
r_void
op_star
comma
r_int
r_int
)paren
suffix:semicolon
DECL|typedef|writerdp_t
r_typedef
r_void
(paren
op_star
id|writerdp_t
)paren
(paren
r_void
op_star
comma
r_int
r_int
)paren
suffix:semicolon
DECL|typedef|readrdp_t
r_typedef
r_int
r_int
(paren
op_star
id|readrdp_t
)paren
(paren
r_void
op_star
)paren
suffix:semicolon
macro_line|#ifdef MODULE
DECL|variable|root_m147lance_dev
r_static
r_struct
id|m147lance_private
op_star
id|root_m147lance_dev
op_assign
l_int|NULL
suffix:semicolon
macro_line|#endif
multiline_comment|/* Initialise the one and only on-board 7990 */
DECL|function|mvme147lance_probe
r_int
id|__init
id|mvme147lance_probe
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_static
r_int
id|called
op_assign
l_int|0
suffix:semicolon
r_static
r_const
r_char
id|name
(braket
)braket
op_assign
l_string|&quot;MVME147 LANCE&quot;
suffix:semicolon
r_struct
id|m147lance_private
op_star
id|lp
suffix:semicolon
id|u_long
op_star
id|addr
suffix:semicolon
id|u_long
id|address
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|MACH_IS_MVME147
op_logical_or
id|called
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
id|called
op_increment
suffix:semicolon
id|SET_MODULE_OWNER
c_func
(paren
id|dev
)paren
suffix:semicolon
id|dev-&gt;priv
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|m147lance_private
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;priv
op_eq
l_int|NULL
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|memset
c_func
(paren
id|dev-&gt;priv
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|m147lance_private
)paren
)paren
suffix:semicolon
multiline_comment|/* Fill the dev fields */
id|dev-&gt;base_addr
op_assign
(paren
r_int
r_int
)paren
id|MVME147_LANCE_BASE
suffix:semicolon
id|dev-&gt;open
op_assign
op_amp
id|m147lance_open
suffix:semicolon
id|dev-&gt;stop
op_assign
op_amp
id|m147lance_close
suffix:semicolon
id|dev-&gt;hard_start_xmit
op_assign
op_amp
id|lance_start_xmit
suffix:semicolon
id|dev-&gt;get_stats
op_assign
op_amp
id|lance_get_stats
suffix:semicolon
id|dev-&gt;set_multicast_list
op_assign
op_amp
id|lance_set_multicast
suffix:semicolon
id|dev-&gt;tx_timeout
op_assign
op_amp
id|lance_tx_timeout
suffix:semicolon
id|dev-&gt;dma
op_assign
l_int|0
suffix:semicolon
id|addr
op_assign
(paren
id|u_long
op_star
)paren
id|ETHERNET_ADDRESS
suffix:semicolon
id|address
op_assign
op_star
id|addr
suffix:semicolon
id|dev-&gt;dev_addr
(braket
l_int|0
)braket
op_assign
l_int|0x08
suffix:semicolon
id|dev-&gt;dev_addr
(braket
l_int|1
)braket
op_assign
l_int|0x00
suffix:semicolon
id|dev-&gt;dev_addr
(braket
l_int|2
)braket
op_assign
l_int|0x3e
suffix:semicolon
id|address
op_assign
id|address
op_rshift
l_int|8
suffix:semicolon
id|dev-&gt;dev_addr
(braket
l_int|5
)braket
op_assign
id|address
op_amp
l_int|0xff
suffix:semicolon
id|address
op_assign
id|address
op_rshift
l_int|8
suffix:semicolon
id|dev-&gt;dev_addr
(braket
l_int|4
)braket
op_assign
id|address
op_amp
l_int|0xff
suffix:semicolon
id|address
op_assign
id|address
op_rshift
l_int|8
suffix:semicolon
id|dev-&gt;dev_addr
(braket
l_int|3
)braket
op_assign
id|address
op_amp
l_int|0xff
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;%s: MVME147 at 0x%08lx, irq %d, Hardware Address %02x:%02x:%02x:%02x:%02x:%02x&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|dev-&gt;base_addr
comma
id|MVME147_LANCE_IRQ
comma
id|dev-&gt;dev_addr
(braket
l_int|0
)braket
comma
id|dev-&gt;dev_addr
(braket
l_int|1
)braket
comma
id|dev-&gt;dev_addr
(braket
l_int|2
)braket
comma
id|dev-&gt;dev_addr
(braket
l_int|3
)braket
comma
id|dev-&gt;dev_addr
(braket
l_int|4
)braket
comma
id|dev-&gt;dev_addr
(braket
l_int|5
)braket
)paren
suffix:semicolon
id|lp
op_assign
(paren
r_struct
id|m147lance_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|lp-&gt;ram
op_assign
(paren
r_void
op_star
)paren
id|__get_dma_pages
c_func
(paren
id|GFP_ATOMIC
comma
l_int|3
)paren
suffix:semicolon
multiline_comment|/* 16K */
r_if
c_cond
(paren
op_logical_neg
id|lp-&gt;ram
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%s: No memory for LANCE buffers&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
id|lp-&gt;lance.name
op_assign
(paren
r_char
op_star
)paren
id|name
suffix:semicolon
multiline_comment|/* discards const, shut up gcc */
id|lp-&gt;lance.ll
op_assign
(paren
r_struct
id|lance_regs
op_star
)paren
(paren
id|dev-&gt;base_addr
)paren
suffix:semicolon
id|lp-&gt;lance.init_block
op_assign
(paren
r_struct
id|lance_init_block
op_star
)paren
(paren
id|lp-&gt;ram
)paren
suffix:semicolon
multiline_comment|/* CPU addr */
id|lp-&gt;lance.lance_init_block
op_assign
(paren
r_struct
id|lance_init_block
op_star
)paren
(paren
id|lp-&gt;ram
)paren
suffix:semicolon
multiline_comment|/* LANCE addr of same RAM */
id|lp-&gt;lance.busmaster_regval
op_assign
id|LE_C3_BSWP
suffix:semicolon
multiline_comment|/* we&squot;re bigendian */
id|lp-&gt;lance.irq
op_assign
id|MVME147_LANCE_IRQ
suffix:semicolon
id|lp-&gt;lance.writerap
op_assign
(paren
id|writerap_t
)paren
id|m147lance_writerap
suffix:semicolon
id|lp-&gt;lance.writerdp
op_assign
(paren
id|writerdp_t
)paren
id|m147lance_writerdp
suffix:semicolon
id|lp-&gt;lance.readrdp
op_assign
(paren
id|readrdp_t
)paren
id|m147lance_readrdp
suffix:semicolon
id|lp-&gt;lance.lance_log_rx_bufs
op_assign
id|LANCE_LOG_RX_BUFFERS
suffix:semicolon
id|lp-&gt;lance.lance_log_tx_bufs
op_assign
id|LANCE_LOG_TX_BUFFERS
suffix:semicolon
id|lp-&gt;lance.rx_ring_mod_mask
op_assign
id|RX_RING_MOD_MASK
suffix:semicolon
id|lp-&gt;lance.tx_ring_mod_mask
op_assign
id|TX_RING_MOD_MASK
suffix:semicolon
id|ether_setup
c_func
(paren
id|dev
)paren
suffix:semicolon
macro_line|#ifdef MODULE
id|dev-&gt;ifindex
op_assign
id|dev_new_index
c_func
(paren
)paren
suffix:semicolon
id|lp-&gt;next_module
op_assign
id|root_m147lance_dev
suffix:semicolon
id|root_m147lance_dev
op_assign
id|lp
suffix:semicolon
macro_line|#endif /* MODULE */
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|m147lance_writerap
r_static
r_void
id|m147lance_writerap
c_func
(paren
r_struct
id|m147lance_private
op_star
id|lp
comma
r_int
r_int
id|value
)paren
(brace
id|lp-&gt;lance.ll-&gt;rap
op_assign
id|value
suffix:semicolon
)brace
DECL|function|m147lance_writerdp
r_static
r_void
id|m147lance_writerdp
c_func
(paren
r_struct
id|m147lance_private
op_star
id|lp
comma
r_int
r_int
id|value
)paren
(brace
id|lp-&gt;lance.ll-&gt;rdp
op_assign
id|value
suffix:semicolon
)brace
DECL|function|m147lance_readrdp
r_static
r_int
r_int
id|m147lance_readrdp
c_func
(paren
r_struct
id|m147lance_private
op_star
id|lp
)paren
(brace
r_return
id|lp-&gt;lance.ll-&gt;rdp
suffix:semicolon
)brace
DECL|function|m147lance_open
r_static
r_int
id|m147lance_open
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_int
id|status
suffix:semicolon
id|status
op_assign
id|lance_open
c_func
(paren
id|dev
)paren
suffix:semicolon
multiline_comment|/* call generic lance open code */
r_if
c_cond
(paren
id|status
)paren
r_return
id|status
suffix:semicolon
multiline_comment|/* enable interrupts at board level. */
id|m147_pcc-&gt;lan_cntrl
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* clear the interrupts (if any) */
id|m147_pcc-&gt;lan_cntrl
op_assign
l_int|0x08
op_or
l_int|0x04
suffix:semicolon
multiline_comment|/* Enable irq 4 */
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|m147lance_close
r_static
r_int
id|m147lance_close
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
multiline_comment|/* disable interrupts at boardlevel */
id|m147_pcc-&gt;lan_cntrl
op_assign
l_int|0x0
suffix:semicolon
multiline_comment|/* disable interrupts */
id|lance_close
c_func
(paren
id|dev
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#ifdef MODULE
DECL|function|init_module
r_int
id|init_module
c_func
(paren
r_void
)paren
(brace
id|root_lance_dev
op_assign
l_int|NULL
suffix:semicolon
r_return
id|mvme147lance_probe
c_func
(paren
l_int|NULL
)paren
suffix:semicolon
)brace
DECL|function|cleanup_module
r_void
id|cleanup_module
c_func
(paren
r_void
)paren
(brace
multiline_comment|/* Walk the chain of devices, unregistering them */
r_struct
id|m147lance_private
op_star
id|lp
suffix:semicolon
r_while
c_loop
(paren
id|root_m147lance_dev
)paren
(brace
id|lp
op_assign
id|root_m147lance_dev-&gt;next_module
suffix:semicolon
id|unregister_netdev
c_func
(paren
id|root_lance_dev-&gt;dev
)paren
suffix:semicolon
id|free_pages
c_func
(paren
id|lp-&gt;ram
comma
l_int|3
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|root_lance_dev-&gt;dev
)paren
suffix:semicolon
id|root_lance_dev
op_assign
id|lp
suffix:semicolon
)brace
)brace
macro_line|#endif /* MODULE */
eof
