multiline_comment|/* $Id: ptifddi.c,v 1.13 2000/07/11 22:35:22 davem Exp $&n; * ptifddi.c: Network driver for Performance Technologies single-attach&n; *            and dual-attach FDDI sbus cards.&n; *&n; * Copyright (C) 1996 David S. Miller (davem@caip.rutgers.edu)&n; */
DECL|variable|version
r_static
r_char
op_star
id|version
op_assign
l_string|&quot;ptifddi.c:v1.0 10/Dec/96 David S. Miller (davem@caipfs.rutgers.edu)&bslash;n&quot;
suffix:semicolon
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &quot;ptifddi.h&quot;
macro_line|#include &quot;ptifddi_asm.h&quot;
macro_line|#ifdef MODULE
DECL|variable|root_pti_dev
r_static
r_struct
id|ptifddi
op_star
id|root_pti_dev
op_assign
l_int|NULL
suffix:semicolon
macro_line|#endif
DECL|function|pti_reset
r_static
r_inline
r_void
id|pti_reset
c_func
(paren
r_struct
id|ptifddi
op_star
id|pp
)paren
(brace
id|pp-&gt;reset
op_assign
l_int|1
suffix:semicolon
)brace
DECL|function|pti_unreset
r_static
r_inline
r_void
id|pti_unreset
c_func
(paren
r_struct
id|ptifddi
op_star
id|pp
)paren
(brace
id|pp-&gt;unreset
op_assign
l_int|1
suffix:semicolon
)brace
DECL|function|pti_load_code_base
r_static
r_inline
r_void
id|pti_load_code_base
c_func
(paren
r_struct
id|dfddi_ram
op_star
id|rp
comma
r_int
r_int
id|addr
)paren
(brace
id|rp-&gt;loader_addr
op_assign
(paren
(paren
id|addr
op_lshift
l_int|8
)paren
op_amp
l_int|0xff00
)paren
op_or
(paren
(paren
id|addr
op_rshift
l_int|8
)paren
op_amp
l_int|0x00ff
)paren
suffix:semicolon
)brace
DECL|function|pti_clear_dpram
r_static
r_inline
r_void
id|pti_clear_dpram
c_func
(paren
r_struct
id|ptifddi
op_star
id|pp
)paren
(brace
id|memset
c_func
(paren
id|pp-&gt;dpram
comma
l_int|0
comma
id|DPRAM_SIZE
)paren
suffix:semicolon
)brace
DECL|macro|CARD_TEST_TIMEOUT
mdefine_line|#define CARD_TEST_TIMEOUT&t;100000
DECL|function|pti_card_test
r_static
r_inline
r_int
id|pti_card_test
c_func
(paren
r_struct
id|ptifddi
op_star
id|pp
)paren
(brace
r_struct
id|dfddi_ram
op_star
id|rp
op_assign
id|pp-&gt;dpram
suffix:semicolon
r_int
r_char
op_star
id|code
op_assign
op_amp
id|rp-&gt;loader
suffix:semicolon
r_int
r_char
op_star
id|status
op_assign
(paren
r_int
r_char
op_star
)paren
id|rp
suffix:semicolon
r_int
id|clicks
op_assign
id|CARD_TEST_TIMEOUT
suffix:semicolon
multiline_comment|/* Clear it out. */
id|pti_clear_dpram
c_func
(paren
id|pp
)paren
suffix:semicolon
multiline_comment|/* Load test data. */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|test_firmware_size
suffix:semicolon
id|i
op_increment
)paren
(brace
id|code
(braket
id|i
)braket
op_assign
id|test_firmware
(braket
id|i
)braket
suffix:semicolon
)brace
multiline_comment|/* Tell card where to execute the code. */
id|pti_load_code_base
c_func
(paren
id|pp
comma
id|test_firmware_dev_addr
)paren
suffix:semicolon
multiline_comment|/* Clear test run status in dpram. */
op_star
id|status
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Reset single attach state machine before the test. */
id|rp-&gt;reset
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* Unreset, to get the test code running. */
id|pti_unreset
c_func
(paren
id|pp
)paren
suffix:semicolon
multiline_comment|/* Wait for dpram status to become 5, else fail if we time out. */
r_while
c_loop
(paren
op_decrement
id|clicks
)paren
(brace
r_if
c_cond
(paren
op_star
id|status
op_eq
l_int|5
)paren
(brace
id|pti_reset
c_func
(paren
id|pp
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|udelay
c_func
(paren
l_int|20
)paren
suffix:semicolon
)brace
r_return
l_int|1
suffix:semicolon
)brace
DECL|function|pti_init_firmware_loader
r_static
r_inline
r_void
id|pti_init_firmware_loader
c_func
(paren
r_struct
id|ptifddi
op_star
id|pp
)paren
(brace
r_struct
id|dfddi_ram
op_star
id|rp
op_assign
id|pp-&gt;dpram
suffix:semicolon
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|firmware_loader_size
suffix:semicolon
id|i
op_increment
)paren
(brace
id|rp-&gt;loader.loader_firmware
(braket
id|i
)braket
op_assign
id|firmware_loader
(braket
id|i
)braket
suffix:semicolon
)brace
)brace
DECL|function|pti_load_main_firmware
r_static
r_inline
r_void
id|pti_load_main_firmware
c_func
(paren
r_struct
id|ptifddi
op_star
id|pp
)paren
(brace
r_struct
id|dfddi_ram
op_star
id|rp
op_assign
id|pp-&gt;dpram
suffix:semicolon
r_struct
id|dpram_loader
op_star
id|lp
op_assign
op_amp
id|rp.loader
suffix:semicolon
r_int
id|i
suffix:semicolon
)brace
DECL|function|pti_init_rings
r_static
r_void
id|pti_init_rings
c_func
(paren
r_struct
id|ptifddi
op_star
id|pp
comma
r_int
id|from_irq
)paren
(brace
)brace
DECL|function|pti_init
r_static
r_int
id|pti_init
c_func
(paren
r_struct
id|ptifddi
op_star
id|pp
comma
r_int
id|from_irq
)paren
(brace
)brace
DECL|function|pti_is_not_so_happy
r_static
r_void
id|pti_is_not_so_happy
c_func
(paren
r_struct
id|ptifddi
op_star
id|pp
)paren
(brace
)brace
DECL|function|pti_tx
r_static
r_inline
r_void
id|pti_tx
c_func
(paren
r_struct
id|ptifddi
op_star
id|pp
comma
r_struct
id|net_device
op_star
id|dev
)paren
(brace
)brace
DECL|function|myri_rx
r_static
r_inline
r_void
id|myri_rx
c_func
(paren
r_struct
id|ptifddi
op_star
id|pp
comma
r_struct
id|net_device
op_star
id|dev
)paren
(brace
)brace
DECL|function|pti_interrupt
r_static
r_void
id|pti_interrupt
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_struct
id|net_device
op_star
id|dev
op_assign
(paren
r_struct
id|net_device
op_star
)paren
id|dev_id
suffix:semicolon
r_struct
id|ptifddi
op_star
id|pp
op_assign
(paren
r_struct
id|ptifddi
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
)brace
DECL|function|pti_open
r_static
r_int
id|pti_open
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|ptifddi
op_star
id|pp
op_assign
(paren
r_struct
id|ptifddi
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_return
id|pti_init
c_func
(paren
id|pp
comma
id|in_interrupt
c_func
(paren
)paren
)paren
suffix:semicolon
)brace
DECL|function|pti_close
r_static
r_int
id|pti_close
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|ptifddi
op_star
id|pp
op_assign
(paren
r_struct
id|ptifddi
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|pti_start_xmit
r_static
r_int
id|pti_start_xmit
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|ptifddi
op_star
id|pp
op_assign
(paren
r_struct
id|ptifddi
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
)brace
DECL|function|pti_get_stats
r_static
r_struct
id|net_device_stats
op_star
id|pti_get_stats
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_return
op_amp
(paren
(paren
(paren
r_struct
id|ptifddi
op_star
)paren
id|dev-&gt;priv
)paren
op_member_access_from_pointer
id|enet_stats
)paren
suffix:semicolon
)brace
DECL|function|pti_set_multicast
r_static
r_void
id|pti_set_multicast
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
)brace
DECL|function|pti_fddi_init
r_static
r_inline
r_int
id|pti_fddi_init
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_struct
id|sbus_dev
op_star
id|sdev
comma
r_int
id|num
)paren
(brace
r_static
r_int
id|version_printed
op_assign
l_int|0
suffix:semicolon
r_struct
id|ptifddi
op_star
id|pp
suffix:semicolon
r_int
id|i
suffix:semicolon
id|dev
op_assign
id|init_fddidev
c_func
(paren
l_int|0
comma
r_sizeof
(paren
r_struct
id|ptifddi
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|version_printed
op_increment
op_eq
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|version
)paren
suffix:semicolon
)brace
multiline_comment|/* Register 0 mapping contains DPRAM. */
id|pp-&gt;dpram
op_assign
(paren
r_struct
id|dfddi_ram
op_star
)paren
id|sbus_ioremap
c_func
(paren
op_amp
id|sdep-&gt;resource
(braket
l_int|0
)braket
comma
l_int|0
comma
r_sizeof
(paren
id|sturct
id|dfddi_ram
)paren
comma
l_string|&quot;PTI FDDI DPRAM&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pp-&gt;dpram
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;ptiFDDI: Cannot map DPRAM I/O area.&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
multiline_comment|/* Next, register 1 contains reset byte. */
id|pp-&gt;reset
op_assign
(paren
r_int
r_char
op_star
)paren
id|sbus_ioremap
c_func
(paren
op_amp
id|sdep-&gt;resource
(braket
l_int|1
)braket
comma
l_int|0
comma
l_int|1
comma
l_string|&quot;PTI FDDI RESET Byte&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pp-&gt;reset
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;ptiFDDI: Cannot map RESET byte.&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
multiline_comment|/* Register 2 contains unreset byte. */
id|pp-&gt;unreset
op_assign
(paren
r_int
r_char
op_star
)paren
id|sbus_ioremap
c_func
(paren
op_amp
id|sdep-&gt;resource
(braket
l_int|2
)braket
comma
l_int|0
comma
l_int|1
comma
l_string|&quot;PTI FDDI UNRESET Byte&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pp-&gt;unreset
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;ptiFDDI: Cannot map UNRESET byte.&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
multiline_comment|/* Reset the card. */
id|pti_reset
c_func
(paren
id|pp
)paren
suffix:semicolon
multiline_comment|/* Run boot-up card tests. */
id|i
op_assign
id|pti_card_test
c_func
(paren
id|pp
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;ptiFDDI: Bootup card test fails.&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
multiline_comment|/* Clear DPRAM, start afresh. */
id|pti_clear_dpram
c_func
(paren
id|pp
)paren
suffix:semicolon
multiline_comment|/* Init the firmware loader. */
id|pti_init_firmware_loader
c_func
(paren
id|pp
)paren
suffix:semicolon
multiline_comment|/* Now load main card FDDI firmware, using the loader. */
id|pti_load_main_firmware
c_func
(paren
id|pp
)paren
suffix:semicolon
)brace
DECL|function|ptifddi_sbus_probe
r_int
id|__init
id|ptifddi_sbus_probe
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|sbus_bus
op_star
id|bus
suffix:semicolon
r_struct
id|sbus_dev
op_star
id|sdev
op_assign
l_int|0
suffix:semicolon
r_static
r_int
id|called
op_assign
l_int|0
suffix:semicolon
r_int
id|cards
op_assign
l_int|0
comma
id|v
suffix:semicolon
r_if
c_cond
(paren
id|called
)paren
(brace
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
id|called
op_increment
suffix:semicolon
id|for_each_sbus
c_func
(paren
id|bus
)paren
(brace
id|for_each_sbusdev
c_func
(paren
id|sdev
comma
id|bus
)paren
(brace
r_if
c_cond
(paren
id|cards
)paren
(brace
id|dev
op_assign
l_int|NULL
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|strcmp
c_func
(paren
id|sdev-&gt;prom_name
comma
l_string|&quot;PTI,sbs600&quot;
)paren
op_logical_or
op_logical_neg
id|strcmp
c_func
(paren
id|sdev-&gt;prom_name
comma
l_string|&quot;DPV,fddid&quot;
)paren
)paren
(brace
id|cards
op_increment
suffix:semicolon
id|DET
c_func
(paren
(paren
l_string|&quot;Found PTI FDDI as %s&bslash;n&quot;
comma
id|sdev-&gt;prom_name
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|v
op_assign
id|pti_fddi_init
c_func
(paren
id|dev
comma
id|sdev
comma
(paren
id|cards
op_minus
l_int|1
)paren
)paren
)paren
)paren
(brace
r_return
id|v
suffix:semicolon
)brace
)brace
)brace
)brace
r_if
c_cond
(paren
op_logical_neg
id|cards
)paren
(brace
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#ifdef MODULE
r_int
DECL|function|init_module
id|init_module
c_func
(paren
r_void
)paren
(brace
id|root_pti_dev
op_assign
l_int|NULL
suffix:semicolon
r_return
id|ptifddi_sbus_probe
c_func
(paren
l_int|NULL
)paren
suffix:semicolon
)brace
r_void
DECL|function|cleanup_module
id|cleanup_module
c_func
(paren
r_void
)paren
(brace
r_struct
id|ptifddi
op_star
id|pp
suffix:semicolon
multiline_comment|/* No need to check MOD_IN_USE, as sys_delete_module() checks. */
r_while
c_loop
(paren
id|root_pti_dev
)paren
(brace
id|pp
op_assign
id|root_pti_dev-&gt;next_module
suffix:semicolon
id|unregister_netdev
c_func
(paren
id|root_pti_dev-&gt;dev
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|root_pti_dev-&gt;dev
)paren
suffix:semicolon
id|root_pti_dev
op_assign
id|mp
suffix:semicolon
)brace
)brace
macro_line|#endif /* MODULE */
eof
