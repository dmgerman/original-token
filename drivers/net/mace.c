multiline_comment|/*&n; * Network device driver for the MACE ethernet controller on&n; * Apple Powermacs.  Assumes it&squot;s under a DBDMA controller.&n; *&n; * Copyright (C) 1996 Paul Mackerras.&n; */
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/version.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/netdevice.h&gt;
macro_line|#include &lt;linux/etherdevice.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/timer.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;asm/prom.h&gt;
macro_line|#include &lt;asm/dbdma.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/pgtable.h&gt;
macro_line|#include &quot;mace.h&quot;
DECL|variable|mace_devs
r_static
r_struct
id|net_device
op_star
id|mace_devs
op_assign
l_int|NULL
suffix:semicolon
DECL|macro|N_RX_RING
mdefine_line|#define N_RX_RING&t;8
DECL|macro|N_TX_RING
mdefine_line|#define N_TX_RING&t;6
DECL|macro|MAX_TX_ACTIVE
mdefine_line|#define MAX_TX_ACTIVE&t;1
DECL|macro|NCMDS_TX
mdefine_line|#define NCMDS_TX&t;1&t;/* dma commands per element in tx ring */
DECL|macro|RX_BUFLEN
mdefine_line|#define RX_BUFLEN&t;(ETH_FRAME_LEN + 8)
DECL|macro|TX_TIMEOUT
mdefine_line|#define TX_TIMEOUT&t;HZ&t;/* 1 second */
multiline_comment|/* Bits in transmit DMA status */
DECL|macro|TX_DMA_ERR
mdefine_line|#define TX_DMA_ERR&t;0x80
DECL|struct|mace_data
r_struct
id|mace_data
(brace
DECL|member|mace
r_volatile
r_struct
id|mace
op_star
id|mace
suffix:semicolon
DECL|member|tx_dma
r_volatile
r_struct
id|dbdma_regs
op_star
id|tx_dma
suffix:semicolon
DECL|member|tx_dma_intr
r_int
id|tx_dma_intr
suffix:semicolon
DECL|member|rx_dma
r_volatile
r_struct
id|dbdma_regs
op_star
id|rx_dma
suffix:semicolon
DECL|member|rx_dma_intr
r_int
id|rx_dma_intr
suffix:semicolon
DECL|member|tx_cmds
r_volatile
r_struct
id|dbdma_cmd
op_star
id|tx_cmds
suffix:semicolon
multiline_comment|/* xmit dma command list */
DECL|member|rx_cmds
r_volatile
r_struct
id|dbdma_cmd
op_star
id|rx_cmds
suffix:semicolon
multiline_comment|/* recv dma command list */
DECL|member|rx_bufs
r_struct
id|sk_buff
op_star
id|rx_bufs
(braket
id|N_RX_RING
)braket
suffix:semicolon
DECL|member|rx_fill
r_int
id|rx_fill
suffix:semicolon
DECL|member|rx_empty
r_int
id|rx_empty
suffix:semicolon
DECL|member|tx_bufs
r_struct
id|sk_buff
op_star
id|tx_bufs
(braket
id|N_TX_RING
)braket
suffix:semicolon
DECL|member|tx_fill
r_int
id|tx_fill
suffix:semicolon
DECL|member|tx_empty
r_int
id|tx_empty
suffix:semicolon
DECL|member|maccc
r_int
r_char
id|maccc
suffix:semicolon
DECL|member|tx_fullup
r_int
r_char
id|tx_fullup
suffix:semicolon
DECL|member|tx_active
r_int
r_char
id|tx_active
suffix:semicolon
DECL|member|tx_bad_runt
r_int
r_char
id|tx_bad_runt
suffix:semicolon
DECL|member|stats
r_struct
id|net_device_stats
id|stats
suffix:semicolon
DECL|member|tx_timeout
r_struct
id|timer_list
id|tx_timeout
suffix:semicolon
DECL|member|timeout_active
r_int
id|timeout_active
suffix:semicolon
DECL|member|next_mace
r_struct
id|net_device
op_star
id|next_mace
suffix:semicolon
)brace
suffix:semicolon
multiline_comment|/*&n; * Number of bytes of private data per MACE: allow enough for&n; * the rx and tx dma commands plus a branch dma command each,&n; * and another 16 bytes to allow us to align the dma command&n; * buffers on a 16 byte boundary.&n; */
DECL|macro|PRIV_BYTES
mdefine_line|#define PRIV_BYTES&t;(sizeof(struct mace_data) &bslash;&n;&t;+ (N_RX_RING + NCMDS_TX * N_TX_RING + 3) * sizeof(struct dbdma_cmd))
r_static
r_int
id|bitrev
c_func
(paren
r_int
)paren
suffix:semicolon
r_static
r_int
id|mace_probe
c_func
(paren
r_void
)paren
suffix:semicolon
r_static
r_void
id|mace_probe1
c_func
(paren
r_struct
id|device_node
op_star
id|mace
)paren
suffix:semicolon
r_static
r_int
id|mace_open
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_int
id|mace_close
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_int
id|mace_xmit_start
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_struct
id|net_device_stats
op_star
id|mace_stats
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_void
id|mace_set_multicast
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_void
id|mace_reset
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_int
id|mace_set_address
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_void
op_star
id|addr
)paren
suffix:semicolon
r_static
r_void
id|mace_interrupt
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
suffix:semicolon
r_static
r_void
id|mace_txdma_intr
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
suffix:semicolon
r_static
r_void
id|mace_rxdma_intr
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
suffix:semicolon
r_static
r_void
id|mace_set_timeout
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_void
id|mace_tx_timeout
c_func
(paren
r_int
r_int
id|data
)paren
suffix:semicolon
r_static
r_inline
r_void
id|dbdma_reset
c_func
(paren
r_volatile
r_struct
id|dbdma_regs
op_star
id|dma
)paren
suffix:semicolon
r_static
r_inline
r_void
id|mace_clean_rings
c_func
(paren
r_struct
id|mace_data
op_star
id|mp
)paren
suffix:semicolon
r_static
r_void
id|__mace_set_address
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_void
op_star
id|addr
)paren
suffix:semicolon
multiline_comment|/*&n; * If we can&squot;t get a skbuff when we need it, we use this area for DMA.&n; */
DECL|variable|dummy_buf
r_static
r_int
r_char
id|dummy_buf
(braket
id|RX_BUFLEN
op_plus
l_int|2
)braket
suffix:semicolon
multiline_comment|/* Bit-reverse one byte of an ethernet hardware address. */
r_static
r_inline
r_int
DECL|function|bitrev
id|bitrev
c_func
(paren
r_int
id|b
)paren
(brace
r_int
id|d
op_assign
l_int|0
comma
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|8
suffix:semicolon
op_increment
id|i
comma
id|b
op_rshift_assign
l_int|1
)paren
id|d
op_assign
(paren
id|d
op_lshift
l_int|1
)paren
op_or
(paren
id|b
op_amp
l_int|1
)paren
suffix:semicolon
r_return
id|d
suffix:semicolon
)brace
DECL|function|mace_probe
r_static
r_int
id|__init
id|mace_probe
c_func
(paren
r_void
)paren
(brace
r_struct
id|device_node
op_star
id|mace
suffix:semicolon
r_for
c_loop
(paren
id|mace
op_assign
id|find_devices
c_func
(paren
l_string|&quot;mace&quot;
)paren
suffix:semicolon
id|mace
op_ne
l_int|NULL
suffix:semicolon
id|mace
op_assign
id|mace-&gt;next
)paren
id|mace_probe1
c_func
(paren
id|mace
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|mace_probe1
r_static
r_void
id|__init
id|mace_probe1
c_func
(paren
r_struct
id|device_node
op_star
id|mace
)paren
(brace
r_int
id|j
comma
id|rev
suffix:semicolon
r_struct
id|net_device
op_star
id|dev
suffix:semicolon
r_struct
id|mace_data
op_star
id|mp
suffix:semicolon
r_int
r_char
op_star
id|addr
suffix:semicolon
r_if
c_cond
(paren
id|mace-&gt;n_addrs
op_ne
l_int|3
op_logical_or
id|mace-&gt;n_intrs
op_ne
l_int|3
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;can&squot;t use MACE %s: need 3 addrs and 3 irqs&bslash;n&quot;
comma
id|mace-&gt;full_name
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|addr
op_assign
id|get_property
c_func
(paren
id|mace
comma
l_string|&quot;mac-address&quot;
comma
l_int|NULL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|addr
op_eq
l_int|NULL
)paren
(brace
id|addr
op_assign
id|get_property
c_func
(paren
id|mace
comma
l_string|&quot;local-mac-address&quot;
comma
l_int|NULL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|addr
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;Can&squot;t get mac-address for MACE %s&bslash;n&quot;
comma
id|mace-&gt;full_name
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
)brace
id|dev
op_assign
id|init_etherdev
c_func
(paren
l_int|0
comma
id|PRIV_BYTES
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dev
)paren
r_return
suffix:semicolon
id|SET_MODULE_OWNER
c_func
(paren
id|dev
)paren
suffix:semicolon
id|mp
op_assign
id|dev-&gt;priv
suffix:semicolon
id|dev-&gt;base_addr
op_assign
id|mace-&gt;addrs
(braket
l_int|0
)braket
dot
id|address
suffix:semicolon
id|mp-&gt;mace
op_assign
(paren
r_volatile
r_struct
id|mace
op_star
)paren
id|ioremap
c_func
(paren
id|mace-&gt;addrs
(braket
l_int|0
)braket
dot
id|address
comma
l_int|0x1000
)paren
suffix:semicolon
id|dev-&gt;irq
op_assign
id|mace-&gt;intrs
(braket
l_int|0
)braket
dot
id|line
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: MACE at&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|rev
op_assign
id|addr
(braket
l_int|0
)braket
op_eq
l_int|0
op_logical_and
id|addr
(braket
l_int|1
)braket
op_eq
l_int|0xA0
suffix:semicolon
r_for
c_loop
(paren
id|j
op_assign
l_int|0
suffix:semicolon
id|j
OL
l_int|6
suffix:semicolon
op_increment
id|j
)paren
(brace
id|dev-&gt;dev_addr
(braket
id|j
)braket
op_assign
id|rev
ques
c_cond
id|bitrev
c_func
(paren
id|addr
(braket
id|j
)braket
)paren
suffix:colon
id|addr
(braket
id|j
)braket
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;%c%.2x&quot;
comma
(paren
id|j
ques
c_cond
l_char|&squot;:&squot;
suffix:colon
l_char|&squot; &squot;
)paren
comma
id|dev-&gt;dev_addr
(braket
id|j
)braket
)paren
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;, chip revision %d.%d&bslash;n&quot;
comma
id|in_8
c_func
(paren
op_amp
id|mp-&gt;mace-&gt;chipid_hi
)paren
comma
id|in_8
c_func
(paren
op_amp
id|mp-&gt;mace-&gt;chipid_lo
)paren
)paren
suffix:semicolon
id|mp
op_assign
(paren
r_struct
id|mace_data
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|mp-&gt;maccc
op_assign
id|ENXMT
op_or
id|ENRCV
suffix:semicolon
id|mp-&gt;tx_dma
op_assign
(paren
r_volatile
r_struct
id|dbdma_regs
op_star
)paren
id|ioremap
c_func
(paren
id|mace-&gt;addrs
(braket
l_int|1
)braket
dot
id|address
comma
l_int|0x1000
)paren
suffix:semicolon
id|mp-&gt;tx_dma_intr
op_assign
id|mace-&gt;intrs
(braket
l_int|1
)braket
dot
id|line
suffix:semicolon
id|mp-&gt;rx_dma
op_assign
(paren
r_volatile
r_struct
id|dbdma_regs
op_star
)paren
id|ioremap
c_func
(paren
id|mace-&gt;addrs
(braket
l_int|2
)braket
dot
id|address
comma
l_int|0x1000
)paren
suffix:semicolon
id|mp-&gt;rx_dma_intr
op_assign
id|mace-&gt;intrs
(braket
l_int|2
)braket
dot
id|line
suffix:semicolon
id|mp-&gt;tx_cmds
op_assign
(paren
r_volatile
r_struct
id|dbdma_cmd
op_star
)paren
id|DBDMA_ALIGN
c_func
(paren
id|mp
op_plus
l_int|1
)paren
suffix:semicolon
id|mp-&gt;rx_cmds
op_assign
id|mp-&gt;tx_cmds
op_plus
id|NCMDS_TX
op_star
id|N_TX_RING
op_plus
l_int|1
suffix:semicolon
id|memset
c_func
(paren
op_amp
id|mp-&gt;stats
comma
l_int|0
comma
r_sizeof
(paren
id|mp-&gt;stats
)paren
)paren
suffix:semicolon
id|memset
c_func
(paren
(paren
r_char
op_star
)paren
id|mp-&gt;tx_cmds
comma
l_int|0
comma
(paren
id|NCMDS_TX
op_star
id|N_TX_RING
op_plus
id|N_RX_RING
op_plus
l_int|2
)paren
op_star
r_sizeof
(paren
r_struct
id|dbdma_cmd
)paren
)paren
suffix:semicolon
id|init_timer
c_func
(paren
op_amp
id|mp-&gt;tx_timeout
)paren
suffix:semicolon
id|mp-&gt;timeout_active
op_assign
l_int|0
suffix:semicolon
id|dev-&gt;open
op_assign
id|mace_open
suffix:semicolon
id|dev-&gt;stop
op_assign
id|mace_close
suffix:semicolon
id|dev-&gt;hard_start_xmit
op_assign
id|mace_xmit_start
suffix:semicolon
id|dev-&gt;get_stats
op_assign
id|mace_stats
suffix:semicolon
id|dev-&gt;set_multicast_list
op_assign
id|mace_set_multicast
suffix:semicolon
id|dev-&gt;set_mac_address
op_assign
id|mace_set_address
suffix:semicolon
id|ether_setup
c_func
(paren
id|dev
)paren
suffix:semicolon
id|mace_reset
c_func
(paren
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|request_irq
c_func
(paren
id|dev-&gt;irq
comma
id|mace_interrupt
comma
l_int|0
comma
l_string|&quot;MACE&quot;
comma
id|dev
)paren
)paren
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;MACE: can&squot;t get irq %d&bslash;n&quot;
comma
id|dev-&gt;irq
)paren
suffix:semicolon
r_if
c_cond
(paren
id|request_irq
c_func
(paren
id|mace-&gt;intrs
(braket
l_int|1
)braket
dot
id|line
comma
id|mace_txdma_intr
comma
l_int|0
comma
l_string|&quot;MACE-txdma&quot;
comma
id|dev
)paren
)paren
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;MACE: can&squot;t get irq %d&bslash;n&quot;
comma
id|mace-&gt;intrs
(braket
l_int|1
)braket
dot
id|line
)paren
suffix:semicolon
r_if
c_cond
(paren
id|request_irq
c_func
(paren
id|mace-&gt;intrs
(braket
l_int|2
)braket
dot
id|line
comma
id|mace_rxdma_intr
comma
l_int|0
comma
l_string|&quot;MACE-rxdma&quot;
comma
id|dev
)paren
)paren
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;MACE: can&squot;t get irq %d&bslash;n&quot;
comma
id|mace-&gt;intrs
(braket
l_int|2
)braket
dot
id|line
)paren
suffix:semicolon
id|mp-&gt;next_mace
op_assign
id|mace_devs
suffix:semicolon
id|mace_devs
op_assign
id|dev
suffix:semicolon
)brace
DECL|function|dbdma_reset
r_static
r_void
id|dbdma_reset
c_func
(paren
r_volatile
r_struct
id|dbdma_regs
op_star
id|dma
)paren
(brace
r_int
id|i
suffix:semicolon
id|out_le32
c_func
(paren
op_amp
id|dma-&gt;control
comma
(paren
id|WAKE
op_or
id|FLUSH
op_or
id|PAUSE
op_or
id|RUN
)paren
op_lshift
l_int|16
)paren
suffix:semicolon
multiline_comment|/*&n;     * Yes this looks peculiar, but apparently it needs to be this&n;     * way on some machines.&n;     */
r_for
c_loop
(paren
id|i
op_assign
l_int|200
suffix:semicolon
id|i
OG
l_int|0
suffix:semicolon
op_decrement
id|i
)paren
r_if
c_cond
(paren
id|ld_le32
c_func
(paren
op_amp
id|dma-&gt;control
)paren
op_amp
id|RUN
)paren
id|udelay
c_func
(paren
l_int|1
)paren
suffix:semicolon
)brace
DECL|function|mace_reset
r_static
r_void
id|mace_reset
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|mace_data
op_star
id|mp
op_assign
(paren
r_struct
id|mace_data
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_volatile
r_struct
id|mace
op_star
id|mb
op_assign
id|mp-&gt;mace
suffix:semicolon
r_int
id|i
suffix:semicolon
multiline_comment|/* soft-reset the chip */
id|i
op_assign
l_int|200
suffix:semicolon
r_while
c_loop
(paren
op_decrement
id|i
)paren
(brace
id|out_8
c_func
(paren
op_amp
id|mb-&gt;biucc
comma
id|SWRST
)paren
suffix:semicolon
r_if
c_cond
(paren
id|in_8
c_func
(paren
op_amp
id|mb-&gt;biucc
)paren
op_amp
id|SWRST
)paren
(brace
id|udelay
c_func
(paren
l_int|10
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|i
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;mace: cannot reset chip!&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|out_8
c_func
(paren
op_amp
id|mb-&gt;imr
comma
l_int|0xff
)paren
suffix:semicolon
multiline_comment|/* disable all intrs for now */
id|i
op_assign
id|in_8
c_func
(paren
op_amp
id|mb-&gt;ir
)paren
suffix:semicolon
id|out_8
c_func
(paren
op_amp
id|mb-&gt;maccc
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* turn off tx, rx */
id|out_8
c_func
(paren
op_amp
id|mb-&gt;biucc
comma
id|XMTSP_64
)paren
suffix:semicolon
id|out_8
c_func
(paren
op_amp
id|mb-&gt;utr
comma
id|RTRD
)paren
suffix:semicolon
id|out_8
c_func
(paren
op_amp
id|mb-&gt;fifocc
comma
id|RCVFW_32
op_or
id|XMTFW_16
op_or
id|XMTFWU
op_or
id|RCVFWU
op_or
id|XMTBRST
)paren
suffix:semicolon
id|out_8
c_func
(paren
op_amp
id|mb-&gt;xmtfc
comma
id|AUTO_PAD_XMIT
)paren
suffix:semicolon
multiline_comment|/* auto-pad short frames */
id|out_8
c_func
(paren
op_amp
id|mb-&gt;rcvfc
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* load up the hardware address */
id|__mace_set_address
c_func
(paren
id|dev
comma
id|dev-&gt;dev_addr
)paren
suffix:semicolon
multiline_comment|/* clear the multicast filter */
id|out_8
c_func
(paren
op_amp
id|mb-&gt;iac
comma
id|ADDRCHG
op_or
id|LOGADDR
)paren
suffix:semicolon
r_while
c_loop
(paren
(paren
id|in_8
c_func
(paren
op_amp
id|mb-&gt;iac
)paren
op_amp
id|ADDRCHG
)paren
op_ne
l_int|0
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|8
suffix:semicolon
op_increment
id|i
)paren
(brace
id|out_8
c_func
(paren
op_amp
id|mb-&gt;ladrf
comma
l_int|0
)paren
suffix:semicolon
)brace
multiline_comment|/* done changing address */
id|out_8
c_func
(paren
op_amp
id|mb-&gt;iac
comma
l_int|0
)paren
suffix:semicolon
id|out_8
c_func
(paren
op_amp
id|mb-&gt;plscc
comma
id|PORTSEL_GPSI
op_plus
id|ENPLSIO
)paren
suffix:semicolon
)brace
DECL|function|__mace_set_address
r_static
r_void
id|__mace_set_address
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_void
op_star
id|addr
)paren
(brace
r_volatile
r_struct
id|mace
op_star
id|mb
op_assign
(paren
(paren
r_struct
id|mace_data
op_star
)paren
id|dev-&gt;priv
)paren
op_member_access_from_pointer
id|mace
suffix:semicolon
r_int
r_char
op_star
id|p
op_assign
id|addr
suffix:semicolon
r_int
id|i
suffix:semicolon
multiline_comment|/* load up the hardware address */
id|out_8
c_func
(paren
op_amp
id|mb-&gt;iac
comma
id|ADDRCHG
op_or
id|PHYADDR
)paren
suffix:semicolon
r_while
c_loop
(paren
(paren
id|in_8
c_func
(paren
op_amp
id|mb-&gt;iac
)paren
op_amp
id|ADDRCHG
)paren
op_ne
l_int|0
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|6
suffix:semicolon
op_increment
id|i
)paren
id|out_8
c_func
(paren
op_amp
id|mb-&gt;padr
comma
id|dev-&gt;dev_addr
(braket
id|i
)braket
op_assign
id|p
(braket
id|i
)braket
)paren
suffix:semicolon
)brace
DECL|function|mace_set_address
r_static
r_int
id|mace_set_address
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_void
op_star
id|addr
)paren
(brace
r_struct
id|mace_data
op_star
id|mp
op_assign
(paren
r_struct
id|mace_data
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_volatile
r_struct
id|mace
op_star
id|mb
op_assign
id|mp-&gt;mace
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|__mace_set_address
c_func
(paren
id|dev
comma
id|addr
)paren
suffix:semicolon
id|out_8
c_func
(paren
op_amp
id|mb-&gt;iac
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* note: setting ADDRCHG clears ENRCV */
id|out_8
c_func
(paren
op_amp
id|mb-&gt;maccc
comma
id|mp-&gt;maccc
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|mace_open
r_static
r_int
id|mace_open
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|mace_data
op_star
id|mp
op_assign
(paren
r_struct
id|mace_data
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_volatile
r_struct
id|mace
op_star
id|mb
op_assign
id|mp-&gt;mace
suffix:semicolon
r_volatile
r_struct
id|dbdma_regs
op_star
id|rd
op_assign
id|mp-&gt;rx_dma
suffix:semicolon
r_volatile
r_struct
id|dbdma_regs
op_star
id|td
op_assign
id|mp-&gt;tx_dma
suffix:semicolon
r_volatile
r_struct
id|dbdma_cmd
op_star
id|cp
suffix:semicolon
r_int
id|i
suffix:semicolon
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
r_int
r_char
op_star
id|data
suffix:semicolon
multiline_comment|/* reset the chip */
id|mace_reset
c_func
(paren
id|dev
)paren
suffix:semicolon
multiline_comment|/* initialize list of sk_buffs for receiving and set up recv dma */
id|mace_clean_rings
c_func
(paren
id|mp
)paren
suffix:semicolon
id|memset
c_func
(paren
(paren
r_char
op_star
)paren
id|mp-&gt;rx_cmds
comma
l_int|0
comma
id|N_RX_RING
op_star
r_sizeof
(paren
r_struct
id|dbdma_cmd
)paren
)paren
suffix:semicolon
id|cp
op_assign
id|mp-&gt;rx_cmds
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|N_RX_RING
op_minus
l_int|1
suffix:semicolon
op_increment
id|i
)paren
(brace
id|skb
op_assign
id|dev_alloc_skb
c_func
(paren
id|RX_BUFLEN
op_plus
l_int|2
)paren
suffix:semicolon
r_if
c_cond
(paren
id|skb
op_eq
l_int|0
)paren
(brace
id|data
op_assign
id|dummy_buf
suffix:semicolon
)brace
r_else
(brace
id|skb_reserve
c_func
(paren
id|skb
comma
l_int|2
)paren
suffix:semicolon
multiline_comment|/* so IP header lands on 4-byte bdry */
id|data
op_assign
id|skb-&gt;data
suffix:semicolon
)brace
id|mp-&gt;rx_bufs
(braket
id|i
)braket
op_assign
id|skb
suffix:semicolon
id|st_le16
c_func
(paren
op_amp
id|cp-&gt;req_count
comma
id|RX_BUFLEN
)paren
suffix:semicolon
id|st_le16
c_func
(paren
op_amp
id|cp-&gt;command
comma
id|INPUT_LAST
op_plus
id|INTR_ALWAYS
)paren
suffix:semicolon
id|st_le32
c_func
(paren
op_amp
id|cp-&gt;phy_addr
comma
id|virt_to_bus
c_func
(paren
id|data
)paren
)paren
suffix:semicolon
id|cp-&gt;xfer_status
op_assign
l_int|0
suffix:semicolon
op_increment
id|cp
suffix:semicolon
)brace
id|mp-&gt;rx_bufs
(braket
id|i
)braket
op_assign
l_int|0
suffix:semicolon
id|st_le16
c_func
(paren
op_amp
id|cp-&gt;command
comma
id|DBDMA_STOP
)paren
suffix:semicolon
id|mp-&gt;rx_fill
op_assign
id|i
suffix:semicolon
id|mp-&gt;rx_empty
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Put a branch back to the beginning of the receive command list */
op_increment
id|cp
suffix:semicolon
id|st_le16
c_func
(paren
op_amp
id|cp-&gt;command
comma
id|DBDMA_NOP
op_plus
id|BR_ALWAYS
)paren
suffix:semicolon
id|st_le32
c_func
(paren
op_amp
id|cp-&gt;cmd_dep
comma
id|virt_to_bus
c_func
(paren
id|mp-&gt;rx_cmds
)paren
)paren
suffix:semicolon
multiline_comment|/* start rx dma */
id|out_le32
c_func
(paren
op_amp
id|rd-&gt;control
comma
(paren
id|RUN
op_or
id|PAUSE
op_or
id|FLUSH
op_or
id|WAKE
)paren
op_lshift
l_int|16
)paren
suffix:semicolon
multiline_comment|/* clear run bit */
id|out_le32
c_func
(paren
op_amp
id|rd-&gt;cmdptr
comma
id|virt_to_bus
c_func
(paren
id|mp-&gt;rx_cmds
)paren
)paren
suffix:semicolon
id|out_le32
c_func
(paren
op_amp
id|rd-&gt;control
comma
(paren
id|RUN
op_lshift
l_int|16
)paren
op_or
id|RUN
)paren
suffix:semicolon
multiline_comment|/* put a branch at the end of the tx command list */
id|cp
op_assign
id|mp-&gt;tx_cmds
op_plus
id|NCMDS_TX
op_star
id|N_TX_RING
suffix:semicolon
id|st_le16
c_func
(paren
op_amp
id|cp-&gt;command
comma
id|DBDMA_NOP
op_plus
id|BR_ALWAYS
)paren
suffix:semicolon
id|st_le32
c_func
(paren
op_amp
id|cp-&gt;cmd_dep
comma
id|virt_to_bus
c_func
(paren
id|mp-&gt;tx_cmds
)paren
)paren
suffix:semicolon
multiline_comment|/* reset tx dma */
id|out_le32
c_func
(paren
op_amp
id|td-&gt;control
comma
(paren
id|RUN
op_or
id|PAUSE
op_or
id|FLUSH
op_or
id|WAKE
)paren
op_lshift
l_int|16
)paren
suffix:semicolon
id|out_le32
c_func
(paren
op_amp
id|td-&gt;cmdptr
comma
id|virt_to_bus
c_func
(paren
id|mp-&gt;tx_cmds
)paren
)paren
suffix:semicolon
id|mp-&gt;tx_fill
op_assign
l_int|0
suffix:semicolon
id|mp-&gt;tx_empty
op_assign
l_int|0
suffix:semicolon
id|mp-&gt;tx_fullup
op_assign
l_int|0
suffix:semicolon
id|mp-&gt;tx_active
op_assign
l_int|0
suffix:semicolon
id|mp-&gt;tx_bad_runt
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* turn it on! */
id|out_8
c_func
(paren
op_amp
id|mb-&gt;maccc
comma
id|mp-&gt;maccc
)paren
suffix:semicolon
multiline_comment|/* enable all interrupts except receive interrupts */
id|out_8
c_func
(paren
op_amp
id|mb-&gt;imr
comma
id|RCVINT
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|mace_clean_rings
r_static
r_inline
r_void
id|mace_clean_rings
c_func
(paren
r_struct
id|mace_data
op_star
id|mp
)paren
(brace
r_int
id|i
suffix:semicolon
multiline_comment|/* free some skb&squot;s */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|N_RX_RING
suffix:semicolon
op_increment
id|i
)paren
(brace
r_if
c_cond
(paren
id|mp-&gt;rx_bufs
(braket
id|i
)braket
op_ne
l_int|0
)paren
(brace
id|dev_kfree_skb
c_func
(paren
id|mp-&gt;rx_bufs
(braket
id|i
)braket
)paren
suffix:semicolon
id|mp-&gt;rx_bufs
(braket
id|i
)braket
op_assign
l_int|0
suffix:semicolon
)brace
)brace
r_for
c_loop
(paren
id|i
op_assign
id|mp-&gt;tx_empty
suffix:semicolon
id|i
op_ne
id|mp-&gt;tx_fill
suffix:semicolon
)paren
(brace
id|dev_kfree_skb
c_func
(paren
id|mp-&gt;tx_bufs
(braket
id|i
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
op_increment
id|i
op_ge
id|N_TX_RING
)paren
id|i
op_assign
l_int|0
suffix:semicolon
)brace
)brace
DECL|function|mace_close
r_static
r_int
id|mace_close
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|mace_data
op_star
id|mp
op_assign
(paren
r_struct
id|mace_data
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_volatile
r_struct
id|mace
op_star
id|mb
op_assign
id|mp-&gt;mace
suffix:semicolon
r_volatile
r_struct
id|dbdma_regs
op_star
id|rd
op_assign
id|mp-&gt;rx_dma
suffix:semicolon
r_volatile
r_struct
id|dbdma_regs
op_star
id|td
op_assign
id|mp-&gt;tx_dma
suffix:semicolon
multiline_comment|/* disable rx and tx */
id|out_8
c_func
(paren
op_amp
id|mb-&gt;maccc
comma
l_int|0
)paren
suffix:semicolon
id|out_8
c_func
(paren
op_amp
id|mb-&gt;imr
comma
l_int|0xff
)paren
suffix:semicolon
multiline_comment|/* disable all intrs */
multiline_comment|/* disable rx and tx dma */
id|st_le32
c_func
(paren
op_amp
id|rd-&gt;control
comma
(paren
id|RUN
op_or
id|PAUSE
op_or
id|FLUSH
op_or
id|WAKE
)paren
op_lshift
l_int|16
)paren
suffix:semicolon
multiline_comment|/* clear run bit */
id|st_le32
c_func
(paren
op_amp
id|td-&gt;control
comma
(paren
id|RUN
op_or
id|PAUSE
op_or
id|FLUSH
op_or
id|WAKE
)paren
op_lshift
l_int|16
)paren
suffix:semicolon
multiline_comment|/* clear run bit */
id|mace_clean_rings
c_func
(paren
id|mp
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|mace_set_timeout
r_static
r_inline
r_void
id|mace_set_timeout
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|mace_data
op_star
id|mp
op_assign
(paren
r_struct
id|mace_data
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mp-&gt;timeout_active
)paren
id|del_timer
c_func
(paren
op_amp
id|mp-&gt;tx_timeout
)paren
suffix:semicolon
id|mp-&gt;tx_timeout.expires
op_assign
id|jiffies
op_plus
id|TX_TIMEOUT
suffix:semicolon
id|mp-&gt;tx_timeout.function
op_assign
id|mace_tx_timeout
suffix:semicolon
id|mp-&gt;tx_timeout.data
op_assign
(paren
r_int
r_int
)paren
id|dev
suffix:semicolon
id|add_timer
c_func
(paren
op_amp
id|mp-&gt;tx_timeout
)paren
suffix:semicolon
id|mp-&gt;timeout_active
op_assign
l_int|1
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
DECL|function|mace_xmit_start
r_static
r_int
id|mace_xmit_start
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|mace_data
op_star
id|mp
op_assign
(paren
r_struct
id|mace_data
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_volatile
r_struct
id|dbdma_regs
op_star
id|td
op_assign
id|mp-&gt;tx_dma
suffix:semicolon
r_volatile
r_struct
id|dbdma_cmd
op_star
id|cp
comma
op_star
id|np
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_int
id|fill
comma
id|next
comma
id|len
suffix:semicolon
multiline_comment|/* see if there&squot;s a free slot in the tx ring */
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|fill
op_assign
id|mp-&gt;tx_fill
suffix:semicolon
id|next
op_assign
id|fill
op_plus
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|next
op_ge
id|N_TX_RING
)paren
id|next
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|next
op_eq
id|mp-&gt;tx_empty
)paren
(brace
id|netif_stop_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
id|mp-&gt;tx_fullup
op_assign
l_int|1
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
multiline_comment|/* can&squot;t take it at the moment */
)brace
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
multiline_comment|/* partially fill in the dma command block */
id|len
op_assign
id|skb-&gt;len
suffix:semicolon
r_if
c_cond
(paren
id|len
OG
id|ETH_FRAME_LEN
)paren
(brace
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;mace: xmit frame too long (%d)&bslash;n&quot;
comma
id|len
)paren
suffix:semicolon
id|len
op_assign
id|ETH_FRAME_LEN
suffix:semicolon
)brace
id|mp-&gt;tx_bufs
(braket
id|fill
)braket
op_assign
id|skb
suffix:semicolon
id|cp
op_assign
id|mp-&gt;tx_cmds
op_plus
id|NCMDS_TX
op_star
id|fill
suffix:semicolon
id|st_le16
c_func
(paren
op_amp
id|cp-&gt;req_count
comma
id|len
)paren
suffix:semicolon
id|st_le32
c_func
(paren
op_amp
id|cp-&gt;phy_addr
comma
id|virt_to_bus
c_func
(paren
id|skb-&gt;data
)paren
)paren
suffix:semicolon
id|np
op_assign
id|mp-&gt;tx_cmds
op_plus
id|NCMDS_TX
op_star
id|next
suffix:semicolon
id|out_le16
c_func
(paren
op_amp
id|np-&gt;command
comma
id|DBDMA_STOP
)paren
suffix:semicolon
multiline_comment|/* poke the tx dma channel */
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|mp-&gt;tx_fill
op_assign
id|next
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|mp-&gt;tx_bad_runt
op_logical_and
id|mp-&gt;tx_active
OL
id|MAX_TX_ACTIVE
)paren
(brace
id|out_le16
c_func
(paren
op_amp
id|cp-&gt;xfer_status
comma
l_int|0
)paren
suffix:semicolon
id|out_le16
c_func
(paren
op_amp
id|cp-&gt;command
comma
id|OUTPUT_LAST
)paren
suffix:semicolon
id|out_le32
c_func
(paren
op_amp
id|td-&gt;control
comma
(paren
(paren
id|RUN
op_or
id|WAKE
)paren
op_lshift
l_int|16
)paren
op_plus
(paren
id|RUN
op_or
id|WAKE
)paren
)paren
suffix:semicolon
op_increment
id|mp-&gt;tx_active
suffix:semicolon
id|mace_set_timeout
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
op_increment
id|next
op_ge
id|N_TX_RING
)paren
id|next
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|next
op_eq
id|mp-&gt;tx_empty
)paren
id|netif_stop_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|mace_stats
r_static
r_struct
id|net_device_stats
op_star
id|mace_stats
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|mace_data
op_star
id|p
op_assign
(paren
r_struct
id|mace_data
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_return
op_amp
id|p-&gt;stats
suffix:semicolon
)brace
multiline_comment|/*&n; * CRC polynomial - used in working out multicast filter bits.&n; */
DECL|macro|CRC_POLY
mdefine_line|#define CRC_POLY&t;0xedb88320
DECL|function|mace_set_multicast
r_static
r_void
id|mace_set_multicast
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|mace_data
op_star
id|mp
op_assign
(paren
r_struct
id|mace_data
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_volatile
r_struct
id|mace
op_star
id|mb
op_assign
id|mp-&gt;mace
suffix:semicolon
r_int
id|i
comma
id|j
comma
id|k
comma
id|b
suffix:semicolon
r_int
r_int
id|crc
suffix:semicolon
id|mp-&gt;maccc
op_and_assign
op_complement
id|PROM
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;flags
op_amp
id|IFF_PROMISC
)paren
(brace
id|mp-&gt;maccc
op_or_assign
id|PROM
suffix:semicolon
)brace
r_else
(brace
r_int
r_char
id|multicast_filter
(braket
l_int|8
)braket
suffix:semicolon
r_struct
id|dev_mc_list
op_star
id|dmi
op_assign
id|dev-&gt;mc_list
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;flags
op_amp
id|IFF_ALLMULTI
)paren
(brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|8
suffix:semicolon
id|i
op_increment
)paren
id|multicast_filter
(braket
id|i
)braket
op_assign
l_int|0xff
suffix:semicolon
)brace
r_else
(brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|8
suffix:semicolon
id|i
op_increment
)paren
id|multicast_filter
(braket
id|i
)braket
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|dev-&gt;mc_count
suffix:semicolon
id|i
op_increment
)paren
(brace
id|crc
op_assign
op_complement
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|j
op_assign
l_int|0
suffix:semicolon
id|j
OL
l_int|6
suffix:semicolon
op_increment
id|j
)paren
(brace
id|b
op_assign
id|dmi-&gt;dmi_addr
(braket
id|j
)braket
suffix:semicolon
r_for
c_loop
(paren
id|k
op_assign
l_int|0
suffix:semicolon
id|k
OL
l_int|8
suffix:semicolon
op_increment
id|k
)paren
(brace
r_if
c_cond
(paren
(paren
id|crc
op_xor
id|b
)paren
op_amp
l_int|1
)paren
id|crc
op_assign
(paren
id|crc
op_rshift
l_int|1
)paren
op_xor
id|CRC_POLY
suffix:semicolon
r_else
id|crc
op_rshift_assign
l_int|1
suffix:semicolon
id|b
op_rshift_assign
l_int|1
suffix:semicolon
)brace
)brace
id|j
op_assign
id|crc
op_rshift
l_int|26
suffix:semicolon
multiline_comment|/* bit number in multicast_filter */
id|multicast_filter
(braket
id|j
op_rshift
l_int|3
)braket
op_or_assign
l_int|1
op_lshift
(paren
id|j
op_amp
l_int|7
)paren
suffix:semicolon
id|dmi
op_assign
id|dmi-&gt;next
suffix:semicolon
)brace
)brace
macro_line|#if 0
id|printk
c_func
(paren
l_string|&quot;Multicast filter :&quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|8
suffix:semicolon
id|i
op_increment
)paren
id|printk
c_func
(paren
l_string|&quot;%02x &quot;
comma
id|multicast_filter
(braket
id|i
)braket
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
id|out_8
c_func
(paren
op_amp
id|mb-&gt;iac
comma
id|ADDRCHG
op_or
id|LOGADDR
)paren
suffix:semicolon
r_while
c_loop
(paren
(paren
id|in_8
c_func
(paren
op_amp
id|mb-&gt;iac
)paren
op_amp
id|ADDRCHG
)paren
op_ne
l_int|0
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|8
suffix:semicolon
op_increment
id|i
)paren
(brace
id|out_8
c_func
(paren
op_amp
id|mb-&gt;ladrf
comma
id|multicast_filter
(braket
id|i
)braket
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* reset maccc */
id|out_8
c_func
(paren
op_amp
id|mb-&gt;maccc
comma
id|mp-&gt;maccc
)paren
suffix:semicolon
)brace
DECL|function|mace_handle_misc_intrs
r_static
r_void
id|mace_handle_misc_intrs
c_func
(paren
r_struct
id|mace_data
op_star
id|mp
comma
r_int
id|intr
)paren
(brace
r_volatile
r_struct
id|mace
op_star
id|mb
op_assign
id|mp-&gt;mace
suffix:semicolon
r_static
r_int
id|mace_babbles
comma
id|mace_jabbers
suffix:semicolon
r_if
c_cond
(paren
id|intr
op_amp
id|MPCO
)paren
id|mp-&gt;stats.rx_missed_errors
op_add_assign
l_int|256
suffix:semicolon
id|mp-&gt;stats.rx_missed_errors
op_add_assign
id|in_8
c_func
(paren
op_amp
id|mb-&gt;mpc
)paren
suffix:semicolon
multiline_comment|/* reading clears it */
r_if
c_cond
(paren
id|intr
op_amp
id|RNTPCO
)paren
id|mp-&gt;stats.rx_length_errors
op_add_assign
l_int|256
suffix:semicolon
id|mp-&gt;stats.rx_length_errors
op_add_assign
id|in_8
c_func
(paren
op_amp
id|mb-&gt;rntpc
)paren
suffix:semicolon
multiline_comment|/* reading clears it */
r_if
c_cond
(paren
id|intr
op_amp
id|CERR
)paren
op_increment
id|mp-&gt;stats.tx_heartbeat_errors
suffix:semicolon
r_if
c_cond
(paren
id|intr
op_amp
id|BABBLE
)paren
r_if
c_cond
(paren
id|mace_babbles
op_increment
OL
l_int|4
)paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;mace: babbling transmitter&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|intr
op_amp
id|JABBER
)paren
r_if
c_cond
(paren
id|mace_jabbers
op_increment
OL
l_int|4
)paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;mace: jabbering transceiver&bslash;n&quot;
)paren
suffix:semicolon
)brace
DECL|function|mace_interrupt
r_static
r_void
id|mace_interrupt
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_struct
id|net_device
op_star
id|dev
op_assign
(paren
r_struct
id|net_device
op_star
)paren
id|dev_id
suffix:semicolon
r_struct
id|mace_data
op_star
id|mp
op_assign
(paren
r_struct
id|mace_data
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_volatile
r_struct
id|mace
op_star
id|mb
op_assign
id|mp-&gt;mace
suffix:semicolon
r_volatile
r_struct
id|dbdma_regs
op_star
id|td
op_assign
id|mp-&gt;tx_dma
suffix:semicolon
r_volatile
r_struct
id|dbdma_cmd
op_star
id|cp
suffix:semicolon
r_int
id|intr
comma
id|fs
comma
id|i
comma
id|stat
comma
id|x
suffix:semicolon
r_int
id|xcount
comma
id|dstat
suffix:semicolon
multiline_comment|/* static int mace_last_fs, mace_last_xcount; */
id|intr
op_assign
id|in_8
c_func
(paren
op_amp
id|mb-&gt;ir
)paren
suffix:semicolon
multiline_comment|/* read interrupt register */
id|in_8
c_func
(paren
op_amp
id|mb-&gt;xmtrc
)paren
suffix:semicolon
multiline_comment|/* get retries */
id|mace_handle_misc_intrs
c_func
(paren
id|mp
comma
id|intr
)paren
suffix:semicolon
id|i
op_assign
id|mp-&gt;tx_empty
suffix:semicolon
r_while
c_loop
(paren
id|in_8
c_func
(paren
op_amp
id|mb-&gt;pr
)paren
op_amp
id|XMTSV
)paren
(brace
id|del_timer
c_func
(paren
op_amp
id|mp-&gt;tx_timeout
)paren
suffix:semicolon
id|mp-&gt;timeout_active
op_assign
l_int|0
suffix:semicolon
multiline_comment|/*&n;&t; * Clear any interrupt indication associated with this status&n;&t; * word.  This appears to unlatch any error indication from&n;&t; * the DMA controller.&n;&t; */
id|intr
op_assign
id|in_8
c_func
(paren
op_amp
id|mb-&gt;ir
)paren
suffix:semicolon
r_if
c_cond
(paren
id|intr
op_ne
l_int|0
)paren
id|mace_handle_misc_intrs
c_func
(paren
id|mp
comma
id|intr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mp-&gt;tx_bad_runt
)paren
(brace
id|fs
op_assign
id|in_8
c_func
(paren
op_amp
id|mb-&gt;xmtfs
)paren
suffix:semicolon
id|mp-&gt;tx_bad_runt
op_assign
l_int|0
suffix:semicolon
id|out_8
c_func
(paren
op_amp
id|mb-&gt;xmtfc
comma
id|AUTO_PAD_XMIT
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
id|dstat
op_assign
id|ld_le32
c_func
(paren
op_amp
id|td-&gt;status
)paren
suffix:semicolon
multiline_comment|/* stop DMA controller */
id|out_le32
c_func
(paren
op_amp
id|td-&gt;control
comma
id|RUN
op_lshift
l_int|16
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * xcount is the number of complete frames which have been&n;&t; * written to the fifo but for which status has not been read.&n;&t; */
id|xcount
op_assign
(paren
id|in_8
c_func
(paren
op_amp
id|mb-&gt;fifofc
)paren
op_rshift
id|XMTFC_SH
)paren
op_amp
id|XMTFC_MASK
suffix:semicolon
r_if
c_cond
(paren
id|xcount
op_eq
l_int|0
op_logical_or
(paren
id|dstat
op_amp
id|DEAD
)paren
)paren
(brace
multiline_comment|/*&n;&t;     * If a packet was aborted before the DMA controller has&n;&t;     * finished transferring it, it seems that there are 2 bytes&n;&t;     * which are stuck in some buffer somewhere.  These will get&n;&t;     * transmitted as soon as we read the frame status (which&n;&t;     * reenables the transmit data transfer request).  Turning&n;&t;     * off the DMA controller and/or resetting the MACE doesn&squot;t&n;&t;     * help.  So we disable auto-padding and FCS transmission&n;&t;     * so the two bytes will only be a runt packet which should&n;&t;     * be ignored by other stations.&n;&t;     */
id|out_8
c_func
(paren
op_amp
id|mb-&gt;xmtfc
comma
id|DXMTFCS
)paren
suffix:semicolon
)brace
id|fs
op_assign
id|in_8
c_func
(paren
op_amp
id|mb-&gt;xmtfs
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|fs
op_amp
id|XMTSV
)paren
op_eq
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;mace: xmtfs not valid! (fs=%x xc=%d ds=%x)&bslash;n&quot;
comma
id|fs
comma
id|xcount
comma
id|dstat
)paren
suffix:semicolon
id|mace_reset
c_func
(paren
id|dev
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t; * XXX mace likes to hang the machine after a xmtfs error.&n;&t;&t; * This is hard to reproduce, reseting *may* help&n;&t;&t; */
)brace
id|cp
op_assign
id|mp-&gt;tx_cmds
op_plus
id|NCMDS_TX
op_star
id|i
suffix:semicolon
id|stat
op_assign
id|ld_le16
c_func
(paren
op_amp
id|cp-&gt;xfer_status
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|fs
op_amp
(paren
id|UFLO
op_or
id|LCOL
op_or
id|LCAR
op_or
id|RTRY
)paren
)paren
op_logical_or
(paren
id|dstat
op_amp
id|DEAD
)paren
op_logical_or
id|xcount
op_eq
l_int|0
)paren
(brace
multiline_comment|/*&n;&t;     * Check whether there were in fact 2 bytes written to&n;&t;     * the transmit FIFO.&n;&t;     */
id|udelay
c_func
(paren
l_int|1
)paren
suffix:semicolon
id|x
op_assign
(paren
id|in_8
c_func
(paren
op_amp
id|mb-&gt;fifofc
)paren
op_rshift
id|XMTFC_SH
)paren
op_amp
id|XMTFC_MASK
suffix:semicolon
r_if
c_cond
(paren
id|x
op_ne
l_int|0
)paren
(brace
multiline_comment|/* there were two bytes with an end-of-packet indication */
id|mp-&gt;tx_bad_runt
op_assign
l_int|1
suffix:semicolon
id|mace_set_timeout
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/*&n;&t;&t; * Either there weren&squot;t the two bytes buffered up, or they&n;&t;&t; * didn&squot;t have an end-of-packet indication.&n;&t;&t; * We flush the transmit FIFO just in case (by setting the&n;&t;&t; * XMTFWU bit with the transmitter disabled).&n;&t;&t; */
id|out_8
c_func
(paren
op_amp
id|mb-&gt;maccc
comma
id|in_8
c_func
(paren
op_amp
id|mb-&gt;maccc
)paren
op_amp
op_complement
id|ENXMT
)paren
suffix:semicolon
id|out_8
c_func
(paren
op_amp
id|mb-&gt;fifocc
comma
id|in_8
c_func
(paren
op_amp
id|mb-&gt;fifocc
)paren
op_or
id|XMTFWU
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|1
)paren
suffix:semicolon
id|out_8
c_func
(paren
op_amp
id|mb-&gt;maccc
comma
id|in_8
c_func
(paren
op_amp
id|mb-&gt;maccc
)paren
op_or
id|ENXMT
)paren
suffix:semicolon
id|out_8
c_func
(paren
op_amp
id|mb-&gt;xmtfc
comma
id|AUTO_PAD_XMIT
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* dma should have finished */
r_if
c_cond
(paren
id|i
op_eq
id|mp-&gt;tx_fill
)paren
(brace
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;mace: tx ring ran out? (fs=%x xc=%d ds=%x)&bslash;n&quot;
comma
id|fs
comma
id|xcount
comma
id|dstat
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
multiline_comment|/* Update stats */
r_if
c_cond
(paren
id|fs
op_amp
(paren
id|UFLO
op_or
id|LCOL
op_or
id|LCAR
op_or
id|RTRY
)paren
)paren
(brace
op_increment
id|mp-&gt;stats.tx_errors
suffix:semicolon
r_if
c_cond
(paren
id|fs
op_amp
id|LCAR
)paren
op_increment
id|mp-&gt;stats.tx_carrier_errors
suffix:semicolon
r_if
c_cond
(paren
id|fs
op_amp
(paren
id|UFLO
op_or
id|LCOL
op_or
id|RTRY
)paren
)paren
op_increment
id|mp-&gt;stats.tx_aborted_errors
suffix:semicolon
)brace
r_else
(brace
id|mp-&gt;stats.tx_bytes
op_add_assign
id|mp-&gt;tx_bufs
(braket
id|i
)braket
op_member_access_from_pointer
id|len
suffix:semicolon
op_increment
id|mp-&gt;stats.tx_packets
suffix:semicolon
)brace
id|dev_kfree_skb_irq
c_func
(paren
id|mp-&gt;tx_bufs
(braket
id|i
)braket
)paren
suffix:semicolon
op_decrement
id|mp-&gt;tx_active
suffix:semicolon
r_if
c_cond
(paren
op_increment
id|i
op_ge
id|N_TX_RING
)paren
id|i
op_assign
l_int|0
suffix:semicolon
macro_line|#if 0
id|mace_last_fs
op_assign
id|fs
suffix:semicolon
id|mace_last_xcount
op_assign
id|xcount
suffix:semicolon
macro_line|#endif
)brace
r_if
c_cond
(paren
id|i
op_ne
id|mp-&gt;tx_empty
)paren
(brace
id|mp-&gt;tx_fullup
op_assign
l_int|0
suffix:semicolon
id|netif_wake_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
id|mp-&gt;tx_empty
op_assign
id|i
suffix:semicolon
id|i
op_add_assign
id|mp-&gt;tx_active
suffix:semicolon
r_if
c_cond
(paren
id|i
op_ge
id|N_TX_RING
)paren
id|i
op_sub_assign
id|N_TX_RING
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|mp-&gt;tx_bad_runt
op_logical_and
id|i
op_ne
id|mp-&gt;tx_fill
op_logical_and
id|mp-&gt;tx_active
OL
id|MAX_TX_ACTIVE
)paren
(brace
r_do
(brace
multiline_comment|/* set up the next one */
id|cp
op_assign
id|mp-&gt;tx_cmds
op_plus
id|NCMDS_TX
op_star
id|i
suffix:semicolon
id|out_le16
c_func
(paren
op_amp
id|cp-&gt;xfer_status
comma
l_int|0
)paren
suffix:semicolon
id|out_le16
c_func
(paren
op_amp
id|cp-&gt;command
comma
id|OUTPUT_LAST
)paren
suffix:semicolon
op_increment
id|mp-&gt;tx_active
suffix:semicolon
r_if
c_cond
(paren
op_increment
id|i
op_ge
id|N_TX_RING
)paren
id|i
op_assign
l_int|0
suffix:semicolon
)brace
r_while
c_loop
(paren
id|i
op_ne
id|mp-&gt;tx_fill
op_logical_and
id|mp-&gt;tx_active
OL
id|MAX_TX_ACTIVE
)paren
suffix:semicolon
id|out_le32
c_func
(paren
op_amp
id|td-&gt;control
comma
(paren
(paren
id|RUN
op_or
id|WAKE
)paren
op_lshift
l_int|16
)paren
op_plus
(paren
id|RUN
op_or
id|WAKE
)paren
)paren
suffix:semicolon
id|mace_set_timeout
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
)brace
DECL|function|mace_tx_timeout
r_static
r_void
id|mace_tx_timeout
c_func
(paren
r_int
r_int
id|data
)paren
(brace
r_struct
id|net_device
op_star
id|dev
op_assign
(paren
r_struct
id|net_device
op_star
)paren
id|data
suffix:semicolon
r_struct
id|mace_data
op_star
id|mp
op_assign
(paren
r_struct
id|mace_data
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_volatile
r_struct
id|mace
op_star
id|mb
op_assign
id|mp-&gt;mace
suffix:semicolon
r_volatile
r_struct
id|dbdma_regs
op_star
id|td
op_assign
id|mp-&gt;tx_dma
suffix:semicolon
r_volatile
r_struct
id|dbdma_regs
op_star
id|rd
op_assign
id|mp-&gt;rx_dma
suffix:semicolon
r_volatile
r_struct
id|dbdma_cmd
op_star
id|cp
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_int
id|i
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|mp-&gt;timeout_active
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|mp-&gt;tx_active
op_eq
l_int|0
op_logical_and
op_logical_neg
id|mp-&gt;tx_bad_runt
)paren
r_goto
id|out
suffix:semicolon
multiline_comment|/* update various counters */
id|mace_handle_misc_intrs
c_func
(paren
id|mp
comma
id|in_8
c_func
(paren
op_amp
id|mb-&gt;ir
)paren
)paren
suffix:semicolon
id|cp
op_assign
id|mp-&gt;tx_cmds
op_plus
id|NCMDS_TX
op_star
id|mp-&gt;tx_empty
suffix:semicolon
multiline_comment|/* turn off both tx and rx and reset the chip */
id|out_8
c_func
(paren
op_amp
id|mb-&gt;maccc
comma
l_int|0
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;mace: transmit timeout - resetting&bslash;n&quot;
)paren
suffix:semicolon
id|dbdma_reset
c_func
(paren
id|td
)paren
suffix:semicolon
id|mace_reset
c_func
(paren
id|dev
)paren
suffix:semicolon
multiline_comment|/* restart rx dma */
id|cp
op_assign
id|bus_to_virt
c_func
(paren
id|ld_le32
c_func
(paren
op_amp
id|rd-&gt;cmdptr
)paren
)paren
suffix:semicolon
id|dbdma_reset
c_func
(paren
id|rd
)paren
suffix:semicolon
id|out_le16
c_func
(paren
op_amp
id|cp-&gt;xfer_status
comma
l_int|0
)paren
suffix:semicolon
id|out_le32
c_func
(paren
op_amp
id|rd-&gt;cmdptr
comma
id|virt_to_bus
c_func
(paren
id|cp
)paren
)paren
suffix:semicolon
id|out_le32
c_func
(paren
op_amp
id|rd-&gt;control
comma
(paren
id|RUN
op_lshift
l_int|16
)paren
op_or
id|RUN
)paren
suffix:semicolon
multiline_comment|/* fix up the transmit side */
id|i
op_assign
id|mp-&gt;tx_empty
suffix:semicolon
id|mp-&gt;tx_active
op_assign
l_int|0
suffix:semicolon
op_increment
id|mp-&gt;stats.tx_errors
suffix:semicolon
r_if
c_cond
(paren
id|mp-&gt;tx_bad_runt
)paren
(brace
id|mp-&gt;tx_bad_runt
op_assign
l_int|0
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|i
op_ne
id|mp-&gt;tx_fill
)paren
(brace
id|dev_kfree_skb
c_func
(paren
id|mp-&gt;tx_bufs
(braket
id|i
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
op_increment
id|i
op_ge
id|N_TX_RING
)paren
id|i
op_assign
l_int|0
suffix:semicolon
id|mp-&gt;tx_empty
op_assign
id|i
suffix:semicolon
)brace
id|mp-&gt;tx_fullup
op_assign
l_int|0
suffix:semicolon
id|netif_wake_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
op_ne
id|mp-&gt;tx_fill
)paren
(brace
id|cp
op_assign
id|mp-&gt;tx_cmds
op_plus
id|NCMDS_TX
op_star
id|i
suffix:semicolon
id|out_le16
c_func
(paren
op_amp
id|cp-&gt;xfer_status
comma
l_int|0
)paren
suffix:semicolon
id|out_le16
c_func
(paren
op_amp
id|cp-&gt;command
comma
id|OUTPUT_LAST
)paren
suffix:semicolon
id|out_le32
c_func
(paren
op_amp
id|td-&gt;cmdptr
comma
id|virt_to_bus
c_func
(paren
id|cp
)paren
)paren
suffix:semicolon
id|out_le32
c_func
(paren
op_amp
id|td-&gt;control
comma
(paren
id|RUN
op_lshift
l_int|16
)paren
op_or
id|RUN
)paren
suffix:semicolon
op_increment
id|mp-&gt;tx_active
suffix:semicolon
id|mace_set_timeout
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
multiline_comment|/* turn it back on */
id|out_8
c_func
(paren
op_amp
id|mb-&gt;imr
comma
id|RCVINT
)paren
suffix:semicolon
id|out_8
c_func
(paren
op_amp
id|mb-&gt;maccc
comma
id|mp-&gt;maccc
)paren
suffix:semicolon
id|out
suffix:colon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
DECL|function|mace_txdma_intr
r_static
r_void
id|mace_txdma_intr
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
)brace
DECL|function|mace_rxdma_intr
r_static
r_void
id|mace_rxdma_intr
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_struct
id|net_device
op_star
id|dev
op_assign
(paren
r_struct
id|net_device
op_star
)paren
id|dev_id
suffix:semicolon
r_struct
id|mace_data
op_star
id|mp
op_assign
(paren
r_struct
id|mace_data
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_volatile
r_struct
id|dbdma_regs
op_star
id|rd
op_assign
id|mp-&gt;rx_dma
suffix:semicolon
r_volatile
r_struct
id|dbdma_cmd
op_star
id|cp
comma
op_star
id|np
suffix:semicolon
r_int
id|i
comma
id|nb
comma
id|stat
comma
id|next
suffix:semicolon
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
r_int
id|frame_status
suffix:semicolon
r_static
r_int
id|mace_lost_status
suffix:semicolon
r_int
r_char
op_star
id|data
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
id|mp-&gt;rx_empty
suffix:semicolon
id|i
op_ne
id|mp-&gt;rx_fill
suffix:semicolon
)paren
(brace
id|cp
op_assign
id|mp-&gt;rx_cmds
op_plus
id|i
suffix:semicolon
id|stat
op_assign
id|ld_le16
c_func
(paren
op_amp
id|cp-&gt;xfer_status
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|stat
op_amp
id|ACTIVE
)paren
op_eq
l_int|0
)paren
(brace
id|next
op_assign
id|i
op_plus
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|next
op_ge
id|N_RX_RING
)paren
id|next
op_assign
l_int|0
suffix:semicolon
id|np
op_assign
id|mp-&gt;rx_cmds
op_plus
id|next
suffix:semicolon
r_if
c_cond
(paren
id|next
op_ne
id|mp-&gt;rx_fill
op_logical_and
(paren
id|ld_le16
c_func
(paren
op_amp
id|np-&gt;xfer_status
)paren
op_amp
id|ACTIVE
)paren
op_ne
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;mace: lost a status word&bslash;n&quot;
)paren
suffix:semicolon
op_increment
id|mace_lost_status
suffix:semicolon
)brace
r_else
r_break
suffix:semicolon
)brace
id|nb
op_assign
id|ld_le16
c_func
(paren
op_amp
id|cp-&gt;req_count
)paren
op_minus
id|ld_le16
c_func
(paren
op_amp
id|cp-&gt;res_count
)paren
suffix:semicolon
id|out_le16
c_func
(paren
op_amp
id|cp-&gt;command
comma
id|DBDMA_STOP
)paren
suffix:semicolon
multiline_comment|/* got a packet, have a look at it */
id|skb
op_assign
id|mp-&gt;rx_bufs
(braket
id|i
)braket
suffix:semicolon
r_if
c_cond
(paren
id|skb
op_eq
l_int|0
)paren
(brace
op_increment
id|mp-&gt;stats.rx_dropped
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|nb
OG
l_int|8
)paren
(brace
id|data
op_assign
id|skb-&gt;data
suffix:semicolon
id|frame_status
op_assign
(paren
id|data
(braket
id|nb
op_minus
l_int|3
)braket
op_lshift
l_int|8
)paren
op_plus
id|data
(braket
id|nb
op_minus
l_int|4
)braket
suffix:semicolon
r_if
c_cond
(paren
id|frame_status
op_amp
(paren
id|RS_OFLO
op_or
id|RS_CLSN
op_or
id|RS_FRAMERR
op_or
id|RS_FCSERR
)paren
)paren
(brace
op_increment
id|mp-&gt;stats.rx_errors
suffix:semicolon
r_if
c_cond
(paren
id|frame_status
op_amp
id|RS_OFLO
)paren
op_increment
id|mp-&gt;stats.rx_over_errors
suffix:semicolon
r_if
c_cond
(paren
id|frame_status
op_amp
id|RS_FRAMERR
)paren
op_increment
id|mp-&gt;stats.rx_frame_errors
suffix:semicolon
r_if
c_cond
(paren
id|frame_status
op_amp
id|RS_FCSERR
)paren
op_increment
id|mp-&gt;stats.rx_crc_errors
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* Mace feature AUTO_STRIP_RCV is on by default, dropping the&n;&t;&t; * FCS on frames with 802.3 headers. This means that Ethernet&n;&t;&t; * frames have 8 extra octets at the end, while 802.3 frames&n;&t;&t; * have only 4. We need to correctly account for this. */
r_if
c_cond
(paren
op_star
(paren
r_int
r_int
op_star
)paren
(paren
id|data
op_plus
l_int|12
)paren
OL
l_int|1536
)paren
multiline_comment|/* 802.3 header */
id|nb
op_sub_assign
l_int|4
suffix:semicolon
r_else
multiline_comment|/* Ethernet header; mace includes FCS */
id|nb
op_sub_assign
l_int|8
suffix:semicolon
id|skb_put
c_func
(paren
id|skb
comma
id|nb
)paren
suffix:semicolon
id|skb-&gt;dev
op_assign
id|dev
suffix:semicolon
id|skb-&gt;protocol
op_assign
id|eth_type_trans
c_func
(paren
id|skb
comma
id|dev
)paren
suffix:semicolon
id|netif_rx
c_func
(paren
id|skb
)paren
suffix:semicolon
id|mp-&gt;rx_bufs
(braket
id|i
)braket
op_assign
l_int|0
suffix:semicolon
id|mp-&gt;stats.rx_bytes
op_add_assign
id|skb-&gt;len
suffix:semicolon
op_increment
id|mp-&gt;stats.rx_packets
suffix:semicolon
)brace
)brace
r_else
(brace
op_increment
id|mp-&gt;stats.rx_errors
suffix:semicolon
op_increment
id|mp-&gt;stats.rx_length_errors
suffix:semicolon
)brace
multiline_comment|/* advance to next */
r_if
c_cond
(paren
op_increment
id|i
op_ge
id|N_RX_RING
)paren
id|i
op_assign
l_int|0
suffix:semicolon
)brace
id|mp-&gt;rx_empty
op_assign
id|i
suffix:semicolon
id|i
op_assign
id|mp-&gt;rx_fill
suffix:semicolon
r_for
c_loop
(paren
suffix:semicolon
suffix:semicolon
)paren
(brace
id|next
op_assign
id|i
op_plus
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|next
op_ge
id|N_RX_RING
)paren
id|next
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|next
op_eq
id|mp-&gt;rx_empty
)paren
r_break
suffix:semicolon
id|cp
op_assign
id|mp-&gt;rx_cmds
op_plus
id|i
suffix:semicolon
id|skb
op_assign
id|mp-&gt;rx_bufs
(braket
id|i
)braket
suffix:semicolon
r_if
c_cond
(paren
id|skb
op_eq
l_int|0
)paren
(brace
id|skb
op_assign
id|dev_alloc_skb
c_func
(paren
id|RX_BUFLEN
op_plus
l_int|2
)paren
suffix:semicolon
r_if
c_cond
(paren
id|skb
op_ne
l_int|0
)paren
(brace
id|skb_reserve
c_func
(paren
id|skb
comma
l_int|2
)paren
suffix:semicolon
id|mp-&gt;rx_bufs
(braket
id|i
)braket
op_assign
id|skb
suffix:semicolon
)brace
)brace
id|st_le16
c_func
(paren
op_amp
id|cp-&gt;req_count
comma
id|RX_BUFLEN
)paren
suffix:semicolon
id|data
op_assign
id|skb
ques
c_cond
id|skb-&gt;data
suffix:colon
id|dummy_buf
suffix:semicolon
id|st_le32
c_func
(paren
op_amp
id|cp-&gt;phy_addr
comma
id|virt_to_bus
c_func
(paren
id|data
)paren
)paren
suffix:semicolon
id|out_le16
c_func
(paren
op_amp
id|cp-&gt;xfer_status
comma
l_int|0
)paren
suffix:semicolon
id|out_le16
c_func
(paren
op_amp
id|cp-&gt;command
comma
id|INPUT_LAST
op_plus
id|INTR_ALWAYS
)paren
suffix:semicolon
macro_line|#if 0
r_if
c_cond
(paren
(paren
id|ld_le32
c_func
(paren
op_amp
id|rd-&gt;status
)paren
op_amp
id|ACTIVE
)paren
op_ne
l_int|0
)paren
(brace
id|out_le32
c_func
(paren
op_amp
id|rd-&gt;control
comma
(paren
id|PAUSE
op_lshift
l_int|16
)paren
op_or
id|PAUSE
)paren
suffix:semicolon
r_while
c_loop
(paren
(paren
id|in_le32
c_func
(paren
op_amp
id|rd-&gt;status
)paren
op_amp
id|ACTIVE
)paren
op_ne
l_int|0
)paren
suffix:semicolon
)brace
macro_line|#endif
id|i
op_assign
id|next
suffix:semicolon
)brace
r_if
c_cond
(paren
id|i
op_ne
id|mp-&gt;rx_fill
)paren
(brace
id|out_le32
c_func
(paren
op_amp
id|rd-&gt;control
comma
(paren
(paren
id|RUN
op_or
id|WAKE
)paren
op_lshift
l_int|16
)paren
op_or
(paren
id|RUN
op_or
id|WAKE
)paren
)paren
suffix:semicolon
id|mp-&gt;rx_fill
op_assign
id|i
suffix:semicolon
)brace
)brace
id|MODULE_AUTHOR
c_func
(paren
l_string|&quot;Paul Mackerras&quot;
)paren
suffix:semicolon
id|MODULE_DESCRIPTION
c_func
(paren
l_string|&quot;PowerMac MACE driver.&quot;
)paren
suffix:semicolon
DECL|function|mace_cleanup
r_static
r_void
id|__exit
id|mace_cleanup
(paren
r_void
)paren
(brace
r_struct
id|net_device
op_star
id|dev
suffix:semicolon
r_struct
id|mace_data
op_star
id|mp
suffix:semicolon
r_while
c_loop
(paren
(paren
id|dev
op_assign
id|mace_devs
)paren
op_ne
l_int|0
)paren
(brace
id|mp
op_assign
(paren
r_struct
id|mace_data
op_star
)paren
id|mace_devs-&gt;priv
suffix:semicolon
id|mace_devs
op_assign
id|mp-&gt;next_mace
suffix:semicolon
id|free_irq
c_func
(paren
id|dev-&gt;irq
comma
id|dev
)paren
suffix:semicolon
id|free_irq
c_func
(paren
id|mp-&gt;tx_dma_intr
comma
id|dev
)paren
suffix:semicolon
id|free_irq
c_func
(paren
id|mp-&gt;rx_dma_intr
comma
id|dev
)paren
suffix:semicolon
id|unregister_netdev
c_func
(paren
id|dev
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
)brace
DECL|variable|mace_probe
id|module_init
c_func
(paren
id|mace_probe
)paren
suffix:semicolon
DECL|variable|mace_cleanup
id|module_exit
c_func
(paren
id|mace_cleanup
)paren
suffix:semicolon
eof
