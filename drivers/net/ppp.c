multiline_comment|/* PPP for Linux&n;*/
multiline_comment|/*&n;   Sources:&n;&n;   slip.c&n;&n;   RFC1331: The Point-to-Point Protocol (PPP) for the Transmission of&n;   Multi-protocol Datagrams over Point-to-Point Links&n;&n;   RFC1332: IPCP&n;&n;   ppp-2.0&n;&n;   Flags for this module (any combination is acceptable for testing.):&n;&n;   NET02D&t;      -&t;Define if using Net-2-Debugged in kernels earlier&n;   &t;&t;&t;than v1.1.4.&n;&n;   NEW_TTY_DRIVERS    -&t;Define if using new Ted Ts&squot;o&squot;s alpha TTY drivers&n;   &t;&t;&t;from tsx-11.mit.edu. From Ted Ts&squot;o.&n;&n;   OPTIMIZE_FLAG_TIME -&t;Number of jiffies to force sending of leading flag&n;&t;&t;&t;character. This is normally set to ((HZ * 3) / 2).&n;&t;&t;&t;This is 1.5 seconds. If not defined then the leading&n;&t;&t;&t;flag is always sent.  &n;*/
multiline_comment|/* #define NET02D&t;&t;&t;&t;-* */
DECL|macro|NEW_TTY_DRIVERS
mdefine_line|#define NEW_TTY_DRIVERS&t;&t;&t;&t;/* */
DECL|macro|OPTIMIZE_FLAG_TIME
mdefine_line|#define OPTIMIZE_FLAG_TIME  ((HZ * 3)/2)&t;/* */
DECL|macro|CHECK_CHARACTERS
mdefine_line|#define CHECK_CHARACTERS
macro_line|#ifdef MODULE
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/version.h&gt;
macro_line|#endif
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/fcntl.h&gt;
macro_line|#include &lt;linux/interrupt.h&gt;
macro_line|#include &lt;linux/ptrace.h&gt;
macro_line|#include &lt;linux/ioport.h&gt;
macro_line|#include &lt;linux/in.h&gt;
macro_line|#include &lt;linux/malloc.h&gt;
macro_line|#include &lt;linux/tty.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/sched.h&gt;   /* to get the struct task_struct */
macro_line|#include &lt;linux/string.h&gt;  /* used in new tty drivers */
macro_line|#include &lt;linux/signal.h&gt;  /* used in new tty drivers */
macro_line|#include &lt;asm/system.h&gt;
macro_line|#include &lt;asm/bitops.h&gt;
macro_line|#include &lt;asm/segment.h&gt;
macro_line|#ifdef NET02D&t;&t;&t;&t;/* v1.1.4 net code and earlier */
macro_line|#include &lt;dev.h&gt;
macro_line|#include &lt;skbuff.h&gt;
macro_line|#include &lt;inet.h&gt;
DECL|macro|skb_queue_head_init
mdefine_line|#define&t;skb_queue_head_init(buf)&t;*(buf) = NULL
macro_line|#else&t;&t;&t;&t;&t;/* v1.1.5 and later */
macro_line|#include &lt;linux/netdevice.h&gt;
macro_line|#include &lt;linux/skbuff.h&gt;
macro_line|#include &lt;linux/inet.h&gt;
macro_line|#endif
macro_line|#include &lt;linux/if_ppp.h&gt;
macro_line|#include &lt;linux/ip.h&gt;
macro_line|#include &lt;linux/tcp.h&gt;
macro_line|#include &quot;slhc.h&quot;
macro_line|#include &lt;linux/if_arp.h&gt;
macro_line|#ifndef ARPHRD_PPP
DECL|macro|ARPHRD_PPP
mdefine_line|#define ARPHRD_PPP 0
macro_line|#endif
DECL|macro|PRINTK
mdefine_line|#define PRINTK(p) printk p ;
DECL|macro|ASSERT
mdefine_line|#define ASSERT(p) if (!p) PRINTK ((KERN_CRIT &quot;assertion failed: &quot; # p))
DECL|macro|PRINTKN
mdefine_line|#define PRINTKN(n,p) {if (ppp_debug &gt;= n) PRINTK (p)}
DECL|macro|CHECK_PPP
mdefine_line|#define CHECK_PPP(a)  if (!ppp-&gt;inuse) { PRINTK ((ppp_warning, __LINE__)) return a;}
DECL|macro|CHECK_PPP_VOID
mdefine_line|#define CHECK_PPP_VOID()  if (!ppp-&gt;inuse) { PRINTK ((ppp_warning, __LINE__)) return;}
DECL|macro|in_xmap
mdefine_line|#define in_xmap(ppp,c)&t;(ppp-&gt;xmit_async_map[(c) &gt;&gt; 5] &amp; (1 &lt;&lt; ((c) &amp; 0x1f)))
DECL|macro|in_rmap
mdefine_line|#define in_rmap(ppp,c)&t;((((unsigned int) (unsigned char) (c)) &lt; 0x20) &amp;&amp; &bslash;&n;&t;&t;&t;ppp-&gt;recv_async_map &amp; (1 &lt;&lt; (c)))
DECL|macro|bset
mdefine_line|#define bset(p,b)&t;((p)[(b) &gt;&gt; 5] |= (1 &lt;&lt; ((b) &amp; 0x1f)))
DECL|variable|ppp_debug
r_int
id|ppp_debug
op_assign
l_int|2
suffix:semicolon
DECL|variable|ppp_debug_netpackets
r_int
id|ppp_debug_netpackets
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Define this string only once for all macro invocations */
DECL|variable|ppp_warning
r_static
r_char
id|ppp_warning
(braket
)braket
op_assign
id|KERN_WARNING
l_string|&quot;PPP: ALERT! not INUSE! %d&bslash;n&quot;
suffix:semicolon
r_int
id|ppp_init
c_func
(paren
r_struct
id|device
op_star
)paren
suffix:semicolon
r_static
r_void
id|ppp_init_ctrl_blk
c_func
(paren
r_struct
id|ppp
op_star
)paren
suffix:semicolon
r_static
r_int
id|ppp_dev_open
c_func
(paren
r_struct
id|device
op_star
)paren
suffix:semicolon
r_static
r_int
id|ppp_dev_ioctl
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
r_struct
id|ifreq
op_star
id|ifr
comma
r_int
id|cmd
)paren
suffix:semicolon
r_static
r_int
id|ppp_dev_close
c_func
(paren
r_struct
id|device
op_star
)paren
suffix:semicolon
r_static
r_void
id|ppp_kick_tty
c_func
(paren
r_struct
id|ppp
op_star
)paren
suffix:semicolon
macro_line|#ifdef NEW_TTY_DRIVERS
DECL|macro|ppp_find
mdefine_line|#define ppp_find(tty) ((struct ppp *) tty-&gt;disc_data)
macro_line|#else
r_static
r_void
id|ppp_output_done
c_func
(paren
r_void
op_star
)paren
suffix:semicolon
r_static
r_void
id|ppp_unesc
c_func
(paren
r_struct
id|ppp
op_star
id|ppp
comma
r_int
r_char
op_star
id|c
comma
r_int
id|n
)paren
suffix:semicolon
r_static
r_struct
id|ppp
op_star
id|ppp_find
c_func
(paren
r_struct
id|tty_struct
op_star
)paren
suffix:semicolon
macro_line|#endif
r_static
r_void
id|ppp_doframe
c_func
(paren
r_struct
id|ppp
op_star
)paren
suffix:semicolon
r_static
r_int
id|ppp_do_ip
c_func
(paren
r_struct
id|ppp
op_star
comma
r_int
r_int
comma
r_int
r_char
op_star
comma
r_int
)paren
suffix:semicolon
r_static
r_int
id|ppp_us_queue
c_func
(paren
r_struct
id|ppp
op_star
comma
r_int
r_int
comma
r_int
r_char
op_star
comma
r_int
)paren
suffix:semicolon
r_static
r_int
id|ppp_xmit
c_func
(paren
r_struct
id|sk_buff
op_star
comma
r_struct
id|device
op_star
)paren
suffix:semicolon
macro_line|#ifdef NET02D
r_static
r_int
id|ppp_header
c_func
(paren
r_int
r_char
op_star
id|buff
comma
r_struct
id|device
op_star
id|dev
comma
r_int
r_int
id|type
comma
r_int
r_int
id|daddr
comma
r_int
r_int
id|saddr
comma
r_int
id|len
)paren
suffix:semicolon
r_static
r_int
id|ppp_rebuild_header
c_func
(paren
r_void
op_star
id|buff
comma
r_struct
id|device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_void
id|ppp_add_arp
c_func
(paren
r_int
r_int
id|addr
comma
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|device
op_star
id|dev
)paren
suffix:semicolon
macro_line|#else
r_static
r_int
id|ppp_header
c_func
(paren
r_struct
id|sk_buff
op_star
comma
r_struct
id|device
op_star
comma
r_int
r_int
comma
r_void
op_star
comma
r_void
op_star
comma
r_int
)paren
suffix:semicolon
r_static
r_int
id|ppp_rebuild_header
c_func
(paren
r_void
op_star
comma
r_struct
id|device
op_star
comma
r_int
r_int
comma
r_struct
id|sk_buff
op_star
)paren
suffix:semicolon
macro_line|#endif
r_static
r_struct
id|enet_statistics
op_star
id|ppp_get_stats
(paren
r_struct
id|device
op_star
)paren
suffix:semicolon
r_static
r_struct
id|ppp
op_star
id|ppp_alloc
c_func
(paren
r_void
)paren
suffix:semicolon
r_static
r_int
id|ppp_lock
c_func
(paren
r_struct
id|ppp
op_star
)paren
suffix:semicolon
r_static
r_void
id|ppp_unlock
c_func
(paren
r_struct
id|ppp
op_star
)paren
suffix:semicolon
r_static
r_void
id|ppp_add_fcs
c_func
(paren
r_struct
id|ppp
op_star
)paren
suffix:semicolon
r_static
r_int
id|ppp_check_fcs
c_func
(paren
r_struct
id|ppp
op_star
)paren
suffix:semicolon
r_static
r_void
id|ppp_print_buffer
c_func
(paren
r_const
r_char
op_star
comma
r_const
r_char
op_star
comma
r_int
comma
r_int
)paren
suffix:semicolon
r_static
r_int
id|ppp_read
c_func
(paren
r_struct
id|tty_struct
op_star
comma
r_struct
id|file
op_star
comma
r_int
r_char
op_star
comma
r_int
r_int
)paren
suffix:semicolon
r_static
r_int
id|ppp_write
c_func
(paren
r_struct
id|tty_struct
op_star
comma
r_struct
id|file
op_star
comma
r_const
r_int
r_char
op_star
comma
r_int
r_int
)paren
suffix:semicolon
r_static
r_int
id|ppp_ioctl
c_func
(paren
r_struct
id|tty_struct
op_star
comma
r_struct
id|file
op_star
comma
r_int
r_int
comma
r_int
r_int
)paren
suffix:semicolon
r_static
r_int
id|ppp_select
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
comma
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|filp
comma
r_int
id|sel_type
comma
id|select_table
op_star
id|wait
)paren
suffix:semicolon
r_static
r_int
id|ppp_open
c_func
(paren
r_struct
id|tty_struct
op_star
)paren
suffix:semicolon
r_static
r_void
id|ppp_close
c_func
(paren
r_struct
id|tty_struct
op_star
)paren
suffix:semicolon
macro_line|#ifdef NEW_TTY_DRIVERS
r_static
r_int
id|ppp_receive_room
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
)paren
suffix:semicolon
r_static
r_void
id|ppp_receive_buf
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
comma
r_const
r_int
r_char
op_star
id|cp
comma
r_char
op_star
id|fp
comma
r_int
id|count
)paren
suffix:semicolon
r_static
r_void
id|ppp_write_wakeup
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
)paren
suffix:semicolon
macro_line|#else
r_static
r_void
id|ppp_tty_input_ready
c_func
(paren
r_struct
id|tty_struct
op_star
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/* FCS table from RFC1331 */
DECL|variable|fcstab
r_static
r_int
r_int
id|fcstab
(braket
l_int|256
)braket
op_assign
(brace
l_int|0x0000
comma
l_int|0x1189
comma
l_int|0x2312
comma
l_int|0x329b
comma
l_int|0x4624
comma
l_int|0x57ad
comma
l_int|0x6536
comma
l_int|0x74bf
comma
l_int|0x8c48
comma
l_int|0x9dc1
comma
l_int|0xaf5a
comma
l_int|0xbed3
comma
l_int|0xca6c
comma
l_int|0xdbe5
comma
l_int|0xe97e
comma
l_int|0xf8f7
comma
l_int|0x1081
comma
l_int|0x0108
comma
l_int|0x3393
comma
l_int|0x221a
comma
l_int|0x56a5
comma
l_int|0x472c
comma
l_int|0x75b7
comma
l_int|0x643e
comma
l_int|0x9cc9
comma
l_int|0x8d40
comma
l_int|0xbfdb
comma
l_int|0xae52
comma
l_int|0xdaed
comma
l_int|0xcb64
comma
l_int|0xf9ff
comma
l_int|0xe876
comma
l_int|0x2102
comma
l_int|0x308b
comma
l_int|0x0210
comma
l_int|0x1399
comma
l_int|0x6726
comma
l_int|0x76af
comma
l_int|0x4434
comma
l_int|0x55bd
comma
l_int|0xad4a
comma
l_int|0xbcc3
comma
l_int|0x8e58
comma
l_int|0x9fd1
comma
l_int|0xeb6e
comma
l_int|0xfae7
comma
l_int|0xc87c
comma
l_int|0xd9f5
comma
l_int|0x3183
comma
l_int|0x200a
comma
l_int|0x1291
comma
l_int|0x0318
comma
l_int|0x77a7
comma
l_int|0x662e
comma
l_int|0x54b5
comma
l_int|0x453c
comma
l_int|0xbdcb
comma
l_int|0xac42
comma
l_int|0x9ed9
comma
l_int|0x8f50
comma
l_int|0xfbef
comma
l_int|0xea66
comma
l_int|0xd8fd
comma
l_int|0xc974
comma
l_int|0x4204
comma
l_int|0x538d
comma
l_int|0x6116
comma
l_int|0x709f
comma
l_int|0x0420
comma
l_int|0x15a9
comma
l_int|0x2732
comma
l_int|0x36bb
comma
l_int|0xce4c
comma
l_int|0xdfc5
comma
l_int|0xed5e
comma
l_int|0xfcd7
comma
l_int|0x8868
comma
l_int|0x99e1
comma
l_int|0xab7a
comma
l_int|0xbaf3
comma
l_int|0x5285
comma
l_int|0x430c
comma
l_int|0x7197
comma
l_int|0x601e
comma
l_int|0x14a1
comma
l_int|0x0528
comma
l_int|0x37b3
comma
l_int|0x263a
comma
l_int|0xdecd
comma
l_int|0xcf44
comma
l_int|0xfddf
comma
l_int|0xec56
comma
l_int|0x98e9
comma
l_int|0x8960
comma
l_int|0xbbfb
comma
l_int|0xaa72
comma
l_int|0x6306
comma
l_int|0x728f
comma
l_int|0x4014
comma
l_int|0x519d
comma
l_int|0x2522
comma
l_int|0x34ab
comma
l_int|0x0630
comma
l_int|0x17b9
comma
l_int|0xef4e
comma
l_int|0xfec7
comma
l_int|0xcc5c
comma
l_int|0xddd5
comma
l_int|0xa96a
comma
l_int|0xb8e3
comma
l_int|0x8a78
comma
l_int|0x9bf1
comma
l_int|0x7387
comma
l_int|0x620e
comma
l_int|0x5095
comma
l_int|0x411c
comma
l_int|0x35a3
comma
l_int|0x242a
comma
l_int|0x16b1
comma
l_int|0x0738
comma
l_int|0xffcf
comma
l_int|0xee46
comma
l_int|0xdcdd
comma
l_int|0xcd54
comma
l_int|0xb9eb
comma
l_int|0xa862
comma
l_int|0x9af9
comma
l_int|0x8b70
comma
l_int|0x8408
comma
l_int|0x9581
comma
l_int|0xa71a
comma
l_int|0xb693
comma
l_int|0xc22c
comma
l_int|0xd3a5
comma
l_int|0xe13e
comma
l_int|0xf0b7
comma
l_int|0x0840
comma
l_int|0x19c9
comma
l_int|0x2b52
comma
l_int|0x3adb
comma
l_int|0x4e64
comma
l_int|0x5fed
comma
l_int|0x6d76
comma
l_int|0x7cff
comma
l_int|0x9489
comma
l_int|0x8500
comma
l_int|0xb79b
comma
l_int|0xa612
comma
l_int|0xd2ad
comma
l_int|0xc324
comma
l_int|0xf1bf
comma
l_int|0xe036
comma
l_int|0x18c1
comma
l_int|0x0948
comma
l_int|0x3bd3
comma
l_int|0x2a5a
comma
l_int|0x5ee5
comma
l_int|0x4f6c
comma
l_int|0x7df7
comma
l_int|0x6c7e
comma
l_int|0xa50a
comma
l_int|0xb483
comma
l_int|0x8618
comma
l_int|0x9791
comma
l_int|0xe32e
comma
l_int|0xf2a7
comma
l_int|0xc03c
comma
l_int|0xd1b5
comma
l_int|0x2942
comma
l_int|0x38cb
comma
l_int|0x0a50
comma
l_int|0x1bd9
comma
l_int|0x6f66
comma
l_int|0x7eef
comma
l_int|0x4c74
comma
l_int|0x5dfd
comma
l_int|0xb58b
comma
l_int|0xa402
comma
l_int|0x9699
comma
l_int|0x8710
comma
l_int|0xf3af
comma
l_int|0xe226
comma
l_int|0xd0bd
comma
l_int|0xc134
comma
l_int|0x39c3
comma
l_int|0x284a
comma
l_int|0x1ad1
comma
l_int|0x0b58
comma
l_int|0x7fe7
comma
l_int|0x6e6e
comma
l_int|0x5cf5
comma
l_int|0x4d7c
comma
l_int|0xc60c
comma
l_int|0xd785
comma
l_int|0xe51e
comma
l_int|0xf497
comma
l_int|0x8028
comma
l_int|0x91a1
comma
l_int|0xa33a
comma
l_int|0xb2b3
comma
l_int|0x4a44
comma
l_int|0x5bcd
comma
l_int|0x6956
comma
l_int|0x78df
comma
l_int|0x0c60
comma
l_int|0x1de9
comma
l_int|0x2f72
comma
l_int|0x3efb
comma
l_int|0xd68d
comma
l_int|0xc704
comma
l_int|0xf59f
comma
l_int|0xe416
comma
l_int|0x90a9
comma
l_int|0x8120
comma
l_int|0xb3bb
comma
l_int|0xa232
comma
l_int|0x5ac5
comma
l_int|0x4b4c
comma
l_int|0x79d7
comma
l_int|0x685e
comma
l_int|0x1ce1
comma
l_int|0x0d68
comma
l_int|0x3ff3
comma
l_int|0x2e7a
comma
l_int|0xe70e
comma
l_int|0xf687
comma
l_int|0xc41c
comma
l_int|0xd595
comma
l_int|0xa12a
comma
l_int|0xb0a3
comma
l_int|0x8238
comma
l_int|0x93b1
comma
l_int|0x6b46
comma
l_int|0x7acf
comma
l_int|0x4854
comma
l_int|0x59dd
comma
l_int|0x2d62
comma
l_int|0x3ceb
comma
l_int|0x0e70
comma
l_int|0x1ff9
comma
l_int|0xf78f
comma
l_int|0xe606
comma
l_int|0xd49d
comma
l_int|0xc514
comma
l_int|0xb1ab
comma
l_int|0xa022
comma
l_int|0x92b9
comma
l_int|0x8330
comma
l_int|0x7bc7
comma
l_int|0x6a4e
comma
l_int|0x58d5
comma
l_int|0x495c
comma
l_int|0x3de3
comma
l_int|0x2c6a
comma
l_int|0x1ef1
comma
l_int|0x0f78
)brace
suffix:semicolon
DECL|variable|ppp_ldisc
r_struct
id|tty_ldisc
id|ppp_ldisc
suffix:semicolon
DECL|variable|ppp_ctrl
r_static
r_struct
id|ppp
id|ppp_ctrl
(braket
id|PPP_NRUNIT
)braket
suffix:semicolon
multiline_comment|/*************************************************************&n; * INITIALIZATION&n; *************************************************************/
DECL|variable|first_time
r_static
r_int
id|first_time
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* called at boot time for each ppp device */
r_int
DECL|function|ppp_init
id|ppp_init
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
r_struct
id|ppp
op_star
id|ppp
suffix:semicolon
r_int
id|i
suffix:semicolon
id|ppp
op_assign
op_amp
id|ppp_ctrl
(braket
id|dev-&gt;base_addr
)braket
suffix:semicolon
r_if
c_cond
(paren
id|first_time
)paren
(brace
id|first_time
op_assign
l_int|0
suffix:semicolon
id|printk
(paren
id|KERN_INFO
l_string|&quot;PPP: version %s (%d channels)&quot;
macro_line|#ifdef NET02D
l_string|&quot; NET02D&quot;
macro_line|#endif
macro_line|#ifdef NEW_TTY_DRIVERS
l_string|&quot; NEW_TTY_DRIVERS&quot;
macro_line|#endif
macro_line|#ifdef OPTIMIZE_FLAG_TIME
l_string|&quot; OPTIMIZE_FLAGS&quot;
macro_line|#endif
l_string|&quot;&bslash;n&quot;
comma
id|PPP_VERSION
comma
id|PPP_NRUNIT
)paren
suffix:semicolon
id|printk
(paren
id|KERN_INFO
l_string|&quot;TCP compression code copyright 1989 Regents of the &quot;
l_string|&quot;University of California&bslash;n&quot;
)paren
suffix:semicolon
(paren
r_void
)paren
id|memset
c_func
(paren
op_amp
id|ppp_ldisc
comma
l_int|0
comma
r_sizeof
(paren
id|ppp_ldisc
)paren
)paren
suffix:semicolon
id|ppp_ldisc.open
op_assign
id|ppp_open
suffix:semicolon
id|ppp_ldisc.close
op_assign
id|ppp_close
suffix:semicolon
id|ppp_ldisc.read
op_assign
id|ppp_read
suffix:semicolon
id|ppp_ldisc.write
op_assign
id|ppp_write
suffix:semicolon
id|ppp_ldisc.ioctl
op_assign
id|ppp_ioctl
suffix:semicolon
id|ppp_ldisc.select
op_assign
id|ppp_select
suffix:semicolon
macro_line|#ifdef NEW_TTY_DRIVERS
id|ppp_ldisc.magic
op_assign
id|TTY_LDISC_MAGIC
suffix:semicolon
id|ppp_ldisc.receive_room
op_assign
id|ppp_receive_room
suffix:semicolon
id|ppp_ldisc.receive_buf
op_assign
id|ppp_receive_buf
suffix:semicolon
id|ppp_ldisc.write_wakeup
op_assign
id|ppp_write_wakeup
suffix:semicolon
macro_line|#else
id|ppp_ldisc.handler
op_assign
id|ppp_tty_input_ready
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
(paren
id|i
op_assign
id|tty_register_ldisc
c_func
(paren
id|N_PPP
comma
op_amp
id|ppp_ldisc
)paren
)paren
op_eq
l_int|0
)paren
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;PPP line discipline registered.&bslash;n&quot;
)paren
suffix:semicolon
r_else
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;error registering line discipline: %d&bslash;n&quot;
comma
id|i
)paren
suffix:semicolon
)brace
multiline_comment|/* initialize PPP control block */
id|ppp_init_ctrl_blk
(paren
id|ppp
)paren
suffix:semicolon
id|ppp-&gt;inuse
op_assign
l_int|0
suffix:semicolon
id|ppp-&gt;line
op_assign
id|dev-&gt;base_addr
suffix:semicolon
id|ppp-&gt;tty
op_assign
l_int|NULL
suffix:semicolon
id|ppp-&gt;dev
op_assign
id|dev
suffix:semicolon
multiline_comment|/* clear statistics */
id|memset
(paren
op_amp
id|ppp-&gt;stats
comma
l_char|&squot;&bslash;0&squot;
comma
r_sizeof
(paren
r_struct
id|ppp_stats
)paren
)paren
suffix:semicolon
multiline_comment|/* device INFO */
id|dev-&gt;mtu
op_assign
id|PPP_MTU
suffix:semicolon
id|dev-&gt;hard_start_xmit
op_assign
id|ppp_xmit
suffix:semicolon
id|dev-&gt;open
op_assign
id|ppp_dev_open
suffix:semicolon
id|dev-&gt;stop
op_assign
id|ppp_dev_close
suffix:semicolon
id|dev-&gt;get_stats
op_assign
id|ppp_get_stats
suffix:semicolon
id|dev-&gt;hard_header
op_assign
id|ppp_header
suffix:semicolon
id|dev-&gt;rebuild_header
op_assign
id|ppp_rebuild_header
suffix:semicolon
id|dev-&gt;hard_header_len
op_assign
l_int|0
suffix:semicolon
id|dev-&gt;addr_len
op_assign
l_int|0
suffix:semicolon
id|dev-&gt;type
op_assign
id|ARPHRD_PPP
suffix:semicolon
macro_line|#ifdef NET02D
id|dev-&gt;add_arp
op_assign
id|ppp_add_arp
suffix:semicolon
id|dev-&gt;queue_xmit
op_assign
id|dev_queue_xmit
suffix:semicolon
macro_line|#else
id|dev-&gt;do_ioctl
op_assign
id|ppp_dev_ioctl
suffix:semicolon
macro_line|#endif
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|DEV_NUMBUFFS
suffix:semicolon
id|i
op_increment
)paren
id|skb_queue_head_init
c_func
(paren
op_amp
id|dev-&gt;buffs
(braket
id|i
)braket
)paren
suffix:semicolon
multiline_comment|/* = NULL if NET02D */
multiline_comment|/* New-style flags */
id|dev-&gt;flags
op_assign
id|IFF_POINTOPOINT
suffix:semicolon
id|dev-&gt;family
op_assign
id|AF_INET
suffix:semicolon
id|dev-&gt;pa_addr
op_assign
l_int|0
suffix:semicolon
id|dev-&gt;pa_brdaddr
op_assign
l_int|0
suffix:semicolon
id|dev-&gt;pa_mask
op_assign
l_int|0
suffix:semicolon
id|dev-&gt;pa_alen
op_assign
l_int|4
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_void
DECL|function|ppp_init_ctrl_blk
id|ppp_init_ctrl_blk
c_func
(paren
r_struct
id|ppp
op_star
id|ppp
)paren
(brace
id|ppp-&gt;magic
op_assign
id|PPP_MAGIC
suffix:semicolon
id|ppp-&gt;sending
op_assign
l_int|0
suffix:semicolon
id|ppp-&gt;toss
op_assign
l_int|0xFE
suffix:semicolon
id|ppp-&gt;escape
op_assign
l_int|0
suffix:semicolon
id|ppp-&gt;flags
op_assign
l_int|0
suffix:semicolon
id|ppp-&gt;mtu
op_assign
id|PPP_MTU
suffix:semicolon
id|ppp-&gt;mru
op_assign
id|PPP_MRU
suffix:semicolon
id|ppp-&gt;fcs
op_assign
l_int|0
suffix:semicolon
id|memset
(paren
id|ppp-&gt;xmit_async_map
comma
l_int|0
comma
r_sizeof
(paren
id|ppp-&gt;xmit_async_map
)paren
)paren
suffix:semicolon
id|ppp-&gt;xmit_async_map
(braket
l_int|0
)braket
op_assign
l_int|0xffffffff
suffix:semicolon
id|ppp-&gt;xmit_async_map
(braket
l_int|3
)braket
op_assign
l_int|0x60000000
suffix:semicolon
id|ppp-&gt;recv_async_map
op_assign
l_int|0x00000000
suffix:semicolon
id|ppp-&gt;slcomp
op_assign
l_int|NULL
suffix:semicolon
id|ppp-&gt;rbuff
op_assign
l_int|NULL
suffix:semicolon
id|ppp-&gt;xbuff
op_assign
l_int|NULL
suffix:semicolon
id|ppp-&gt;cbuff
op_assign
l_int|NULL
suffix:semicolon
id|ppp-&gt;rhead
op_assign
l_int|NULL
suffix:semicolon
id|ppp-&gt;rend
op_assign
l_int|NULL
suffix:semicolon
id|ppp-&gt;rcount
op_assign
l_int|0
suffix:semicolon
id|ppp-&gt;xhead
op_assign
l_int|NULL
suffix:semicolon
id|ppp-&gt;xtail
op_assign
l_int|NULL
suffix:semicolon
id|ppp-&gt;us_rbuff
op_assign
l_int|NULL
suffix:semicolon
id|ppp-&gt;us_rbuff_end
op_assign
l_int|NULL
suffix:semicolon
id|ppp-&gt;us_rbuff_head
op_assign
l_int|NULL
suffix:semicolon
id|ppp-&gt;us_rbuff_tail
op_assign
l_int|NULL
suffix:semicolon
id|ppp-&gt;read_wait
op_assign
l_int|NULL
suffix:semicolon
id|ppp-&gt;write_wait
op_assign
l_int|NULL
suffix:semicolon
id|ppp-&gt;us_rbuff_lock
op_assign
l_int|0
suffix:semicolon
id|ppp-&gt;inp_sig
op_assign
l_int|0
suffix:semicolon
id|ppp-&gt;inp_sig_pid
op_assign
l_int|0
suffix:semicolon
macro_line|#ifdef OPTIMIZE_FLAG_TIME /* ensure flag will always be sent first time */
id|ppp-&gt;last_xmit
op_assign
id|jiffies
op_minus
id|OPTIMIZE_FLAG_TIME
suffix:semicolon
macro_line|#else
id|ppp-&gt;last_xmit
op_assign
l_int|0
suffix:semicolon
macro_line|#endif
multiline_comment|/* clear statistics */
id|memset
(paren
op_amp
id|ppp-&gt;stats
comma
l_char|&squot;&bslash;0&squot;
comma
r_sizeof
(paren
r_struct
id|ppp_stats
)paren
)paren
suffix:semicolon
multiline_comment|/* Reset the demand dial information */
id|ppp-&gt;ddinfo.ip_sjiffies
op_assign
id|ppp-&gt;ddinfo.ip_rjiffies
op_assign
id|ppp-&gt;ddinfo.nip_sjiffies
op_assign
id|ppp-&gt;ddinfo.nip_rjiffies
op_assign
id|jiffies
suffix:semicolon
)brace
multiline_comment|/*&n; * MTU has been changed by the IP layer. Unfortunately we are not told&n; * about this, but we spot it ourselves and fix things up. We could be&n; * in an upcall from the tty driver, or in an ip packet queue.&n; */
r_static
r_void
DECL|function|ppp_changedmtu
id|ppp_changedmtu
(paren
r_struct
id|ppp
op_star
id|ppp
comma
r_int
id|new_mtu
comma
r_int
id|new_mru
)paren
(brace
r_struct
id|device
op_star
id|dev
suffix:semicolon
r_int
r_char
op_star
id|new_rbuff
comma
op_star
id|new_xbuff
comma
op_star
id|new_cbuff
suffix:semicolon
r_int
r_char
op_star
id|old_rbuff
comma
op_star
id|old_xbuff
comma
op_star
id|old_cbuff
suffix:semicolon
r_int
id|mtu
comma
id|mru
suffix:semicolon
multiline_comment|/*&n; *  Allocate the buffer from the kernel for the data&n; */
id|dev
op_assign
id|ppp-&gt;dev
suffix:semicolon
id|mru
op_assign
id|new_mru
suffix:semicolon
id|mtu
op_assign
id|new_mtu
suffix:semicolon
multiline_comment|/* RFC 1331, section 7.2 says the minimum value is 1500 bytes */
r_if
c_cond
(paren
id|mru
OL
id|PPP_MRU
)paren
id|mru
op_assign
id|PPP_MRU
suffix:semicolon
id|mtu
op_assign
(paren
id|mtu
op_star
l_int|2
)paren
op_plus
l_int|20
suffix:semicolon
id|mru
op_assign
(paren
id|mru
op_star
l_int|2
)paren
op_plus
l_int|20
suffix:semicolon
id|PRINTKN
(paren
l_int|2
comma
(paren
id|KERN_INFO
l_string|&quot;ppp: channel %s mtu = %d, mru = %d&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|new_mtu
comma
id|new_mru
)paren
)paren
suffix:semicolon
id|new_xbuff
op_assign
(paren
r_int
r_char
op_star
)paren
id|kmalloc
c_func
(paren
id|mtu
op_plus
l_int|4
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
id|new_rbuff
op_assign
(paren
r_int
r_char
op_star
)paren
id|kmalloc
c_func
(paren
id|mru
op_plus
l_int|4
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
id|new_cbuff
op_assign
(paren
r_int
r_char
op_star
)paren
id|kmalloc
c_func
(paren
id|mru
op_plus
l_int|4
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
multiline_comment|/*&n; *  If the buffers failed to allocate then complain.&n; */
r_if
c_cond
(paren
id|new_xbuff
op_eq
l_int|NULL
op_logical_or
id|new_rbuff
op_eq
l_int|NULL
op_logical_or
id|new_cbuff
op_eq
l_int|NULL
)paren
(brace
id|PRINTKN
(paren
l_int|2
comma
(paren
id|KERN_ERR
l_string|&quot;ppp: failed to allocate new buffers&bslash;n&quot;
)paren
)paren
suffix:semicolon
multiline_comment|/*&n; *  Release new buffer pointers if the updates were not performed&n; */
r_if
c_cond
(paren
id|new_rbuff
op_ne
l_int|NULL
)paren
id|kfree
(paren
id|new_rbuff
)paren
suffix:semicolon
r_if
c_cond
(paren
id|new_xbuff
op_ne
l_int|NULL
)paren
id|kfree
(paren
id|new_xbuff
)paren
suffix:semicolon
r_if
c_cond
(paren
id|new_cbuff
op_ne
l_int|NULL
)paren
id|kfree
(paren
id|new_cbuff
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; *  Update the pointers to the new buffer structures.&n; */
r_else
(brace
id|cli
c_func
(paren
)paren
suffix:semicolon
id|old_xbuff
op_assign
id|ppp-&gt;xbuff
suffix:semicolon
id|old_rbuff
op_assign
id|ppp-&gt;rbuff
suffix:semicolon
id|old_cbuff
op_assign
id|ppp-&gt;cbuff
suffix:semicolon
id|ppp-&gt;xbuff
op_assign
id|new_xbuff
suffix:semicolon
id|ppp-&gt;rbuff
op_assign
id|new_rbuff
suffix:semicolon
id|ppp-&gt;cbuff
op_assign
id|new_cbuff
suffix:semicolon
id|dev-&gt;mem_start
op_assign
(paren
r_int
r_int
)paren
id|new_xbuff
suffix:semicolon
id|dev-&gt;mem_end
op_assign
(paren
r_int
r_int
)paren
(paren
id|dev-&gt;mem_start
op_plus
id|mtu
)paren
suffix:semicolon
id|dev-&gt;rmem_start
op_assign
(paren
r_int
r_int
)paren
id|new_rbuff
suffix:semicolon
id|ppp-&gt;rend
op_assign
(paren
r_int
r_char
op_star
)paren
id|dev-&gt;rmem_end
op_assign
(paren
r_int
r_int
)paren
(paren
id|dev-&gt;rmem_start
op_plus
id|mru
)paren
suffix:semicolon
id|ppp-&gt;rhead
op_assign
id|new_rbuff
suffix:semicolon
multiline_comment|/*&n; *  Update the parameters for the new buffer sizes&n; */
id|ppp-&gt;toss
op_assign
l_int|0xFE
suffix:semicolon
id|ppp-&gt;escape
op_assign
l_int|0
suffix:semicolon
id|ppp-&gt;sending
op_assign
l_int|0
suffix:semicolon
id|ppp-&gt;rcount
op_assign
l_int|0
suffix:semicolon
id|ppp-&gt;mru
op_assign
id|new_mru
suffix:semicolon
id|ppp-&gt;mtu
op_assign
id|dev-&gt;mtu
op_assign
id|new_mtu
suffix:semicolon
id|sti
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/*&n; *  Release old buffer pointers&n; */
r_if
c_cond
(paren
id|old_rbuff
op_ne
l_int|NULL
)paren
id|kfree
(paren
id|old_rbuff
)paren
suffix:semicolon
r_if
c_cond
(paren
id|old_xbuff
op_ne
l_int|NULL
)paren
id|kfree
(paren
id|old_xbuff
)paren
suffix:semicolon
r_if
c_cond
(paren
id|old_cbuff
op_ne
l_int|NULL
)paren
id|kfree
(paren
id|old_cbuff
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* called when we abandon the PPP line discipline */
r_static
r_void
DECL|function|ppp_release
id|ppp_release
c_func
(paren
r_struct
id|ppp
op_star
id|ppp
)paren
(brace
macro_line|#ifdef NEW_TTY_DRIVERS
r_if
c_cond
(paren
id|ppp-&gt;tty
op_ne
l_int|NULL
op_logical_and
id|ppp-&gt;tty-&gt;disc_data
op_eq
id|ppp
)paren
id|ppp-&gt;tty-&gt;disc_data
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/* Break the tty-&gt;ppp link */
macro_line|#endif
r_if
c_cond
(paren
id|ppp-&gt;dev
)paren
(brace
id|dev_close
(paren
id|ppp-&gt;dev
)paren
suffix:semicolon
id|ppp-&gt;dev-&gt;flags
op_assign
l_int|0
suffix:semicolon
)brace
id|kfree
(paren
id|ppp-&gt;xbuff
)paren
suffix:semicolon
id|kfree
(paren
id|ppp-&gt;cbuff
)paren
suffix:semicolon
id|kfree
(paren
id|ppp-&gt;rbuff
)paren
suffix:semicolon
id|kfree
(paren
id|ppp-&gt;us_rbuff
)paren
suffix:semicolon
id|ppp-&gt;xbuff
op_assign
id|ppp-&gt;cbuff
op_assign
id|ppp-&gt;rbuff
op_assign
id|ppp-&gt;us_rbuff
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
id|ppp-&gt;slcomp
)paren
(brace
id|slhc_free
c_func
(paren
id|ppp-&gt;slcomp
)paren
suffix:semicolon
id|ppp-&gt;slcomp
op_assign
l_int|NULL
suffix:semicolon
)brace
id|ppp-&gt;inuse
op_assign
l_int|0
suffix:semicolon
id|ppp-&gt;tty
op_assign
l_int|NULL
suffix:semicolon
)brace
r_static
r_void
DECL|function|ppp_close
id|ppp_close
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
)paren
(brace
r_struct
id|ppp
op_star
id|ppp
op_assign
id|ppp_find
c_func
(paren
id|tty
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ppp
op_eq
l_int|NULL
op_logical_or
id|ppp-&gt;magic
op_ne
id|PPP_MAGIC
)paren
(brace
id|PRINTKN
(paren
l_int|1
comma
(paren
id|KERN_WARNING
l_string|&quot;ppp: trying to close unopened tty!&bslash;n&quot;
)paren
)paren
suffix:semicolon
)brace
r_else
(brace
id|CHECK_PPP_VOID
c_func
(paren
)paren
suffix:semicolon
id|ppp_release
(paren
id|ppp
)paren
suffix:semicolon
id|PRINTKN
(paren
l_int|2
comma
(paren
id|KERN_INFO
l_string|&quot;ppp: channel %s closing.&bslash;n&quot;
comma
id|ppp-&gt;dev-&gt;name
)paren
)paren
suffix:semicolon
macro_line|#ifdef MODULE
id|MOD_DEC_USE_COUNT
suffix:semicolon
macro_line|#endif
)brace
)brace
multiline_comment|/* called when PPP line discipline is selected on a tty */
r_static
r_int
DECL|function|ppp_open
id|ppp_open
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
)paren
(brace
r_struct
id|ppp
op_star
id|ppp
op_assign
id|ppp_find
c_func
(paren
id|tty
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ppp
)paren
(brace
id|PRINTKN
(paren
l_int|1
comma
(paren
id|KERN_ERR
l_string|&quot;ppp_open: gack! tty already associated to %s!&bslash;n&quot;
comma
id|ppp-&gt;magic
op_eq
id|PPP_MAGIC
ques
c_cond
id|ppp-&gt;dev-&gt;name
suffix:colon
l_string|&quot;unknown&quot;
)paren
)paren
suffix:semicolon
r_return
op_minus
id|EEXIST
suffix:semicolon
)brace
id|ppp
op_assign
id|ppp_alloc
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ppp
op_eq
l_int|NULL
)paren
(brace
id|PRINTKN
(paren
l_int|1
comma
(paren
id|KERN_ERR
l_string|&quot;ppp_open: couldn&squot;t allocate ppp channel&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_return
op_minus
id|ENFILE
suffix:semicolon
)brace
multiline_comment|/* make sure the channel is actually open */
id|ppp_init_ctrl_blk
(paren
id|ppp
)paren
suffix:semicolon
id|ppp-&gt;tty
op_assign
id|tty
suffix:semicolon
macro_line|#ifdef NEW_TTY_DRIVERS
id|tty-&gt;disc_data
op_assign
id|ppp
suffix:semicolon
r_if
c_cond
(paren
id|tty-&gt;driver.flush_buffer
)paren
id|tty-&gt;driver
dot
id|flush_buffer
c_func
(paren
id|tty
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tty-&gt;ldisc.flush_buffer
)paren
id|tty-&gt;ldisc
dot
id|flush_buffer
c_func
(paren
id|tty
)paren
suffix:semicolon
macro_line|#else
id|tty_read_flush
(paren
id|tty
)paren
suffix:semicolon
id|tty_write_flush
(paren
id|tty
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
(paren
id|ppp-&gt;slcomp
op_assign
id|slhc_init
c_func
(paren
l_int|16
comma
l_int|16
)paren
)paren
op_eq
l_int|NULL
)paren
(brace
id|PRINTKN
(paren
l_int|1
comma
(paren
id|KERN_ERR
l_string|&quot;ppp: no space for compression buffers!&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|ppp_release
(paren
id|ppp
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
multiline_comment|/* Define the buffers for operation */
id|ppp_changedmtu
(paren
id|ppp
comma
id|ppp-&gt;dev-&gt;mtu
comma
id|ppp-&gt;mru
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ppp-&gt;rbuff
op_eq
l_int|NULL
)paren
(brace
id|ppp_release
(paren
id|ppp
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
multiline_comment|/* Allocate a user-level receive buffer */
id|ppp-&gt;us_rbuff
op_assign
(paren
r_int
r_char
op_star
)paren
id|kmalloc
(paren
id|RBUFSIZE
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ppp-&gt;us_rbuff
op_eq
l_int|NULL
)paren
(brace
id|PRINTKN
(paren
l_int|1
comma
(paren
id|KERN_ERR
l_string|&quot;ppp: no space for user receive buffer&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|ppp_release
(paren
id|ppp
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|ppp-&gt;us_rbuff_head
op_assign
id|ppp-&gt;us_rbuff_tail
op_assign
id|ppp-&gt;us_rbuff
suffix:semicolon
id|ppp-&gt;us_rbuff_end
op_assign
id|ppp-&gt;us_rbuff
op_plus
id|RBUFSIZE
suffix:semicolon
id|PRINTKN
(paren
l_int|2
comma
(paren
id|KERN_INFO
l_string|&quot;ppp: channel %s open&bslash;n&quot;
comma
id|ppp-&gt;dev-&gt;name
)paren
)paren
suffix:semicolon
macro_line|#ifdef MODULE
id|MOD_INC_USE_COUNT
suffix:semicolon
macro_line|#endif
r_return
(paren
id|ppp-&gt;line
)paren
suffix:semicolon
)brace
multiline_comment|/* called when ppp interface goes &quot;up&quot;.  here this just means we start&n;   passing IP packets */
r_static
r_int
DECL|function|ppp_dev_open
id|ppp_dev_open
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
r_struct
id|ppp
op_star
id|ppp
op_assign
op_amp
id|ppp_ctrl
(braket
id|dev-&gt;base_addr
)braket
suffix:semicolon
multiline_comment|/* reset POINTOPOINT every time, since dev_close zaps it! */
id|dev-&gt;flags
op_or_assign
id|IFF_POINTOPOINT
suffix:semicolon
r_if
c_cond
(paren
id|ppp-&gt;tty
op_eq
l_int|NULL
)paren
(brace
id|PRINTKN
(paren
l_int|1
comma
(paren
id|KERN_ERR
l_string|&quot;ppp: %s not connected to a TTY! can&squot;t go open!&bslash;n&quot;
comma
id|dev-&gt;name
)paren
)paren
suffix:semicolon
r_return
op_minus
id|ENXIO
suffix:semicolon
)brace
id|PRINTKN
(paren
l_int|2
comma
(paren
id|KERN_INFO
l_string|&quot;ppp: channel %s going up for IP packets!&bslash;n&quot;
comma
id|dev-&gt;name
)paren
)paren
suffix:semicolon
id|CHECK_PPP
c_func
(paren
op_minus
id|ENXIO
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_int
DECL|function|ppp_dev_close
id|ppp_dev_close
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
r_struct
id|ppp
op_star
id|ppp
op_assign
op_amp
id|ppp_ctrl
(braket
id|dev-&gt;base_addr
)braket
suffix:semicolon
r_if
c_cond
(paren
id|ppp-&gt;tty
op_eq
l_int|NULL
)paren
(brace
id|PRINTKN
(paren
l_int|1
comma
(paren
id|KERN_ERR
l_string|&quot;ppp: %s not connected to a TTY! can&squot;t go down!&bslash;n&quot;
comma
id|dev-&gt;name
)paren
)paren
suffix:semicolon
r_return
op_minus
id|ENXIO
suffix:semicolon
)brace
id|PRINTKN
(paren
l_int|2
comma
(paren
id|KERN_INFO
l_string|&quot;ppp: channel %s going down for IP packets!&bslash;n&quot;
comma
id|dev-&gt;name
)paren
)paren
suffix:semicolon
id|CHECK_PPP
c_func
(paren
op_minus
id|ENXIO
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#ifndef NET02D
DECL|function|ppp_dev_ioctl
r_static
r_int
id|ppp_dev_ioctl
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
r_struct
id|ifreq
op_star
id|ifr
comma
r_int
id|cmd
)paren
(brace
r_struct
id|ppp
op_star
id|ppp
op_assign
op_amp
id|ppp_ctrl
(braket
id|dev-&gt;base_addr
)braket
suffix:semicolon
r_int
id|error
suffix:semicolon
r_struct
id|stats
(brace
r_struct
id|ppp_stats
id|ppp_stats
suffix:semicolon
r_struct
id|slcompress
id|slhc
suffix:semicolon
)brace
op_star
id|result
suffix:semicolon
id|error
op_assign
id|verify_area
(paren
id|VERIFY_WRITE
comma
id|ifr-&gt;ifr_ifru.ifru_data
comma
r_sizeof
(paren
r_struct
id|stats
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
op_eq
l_int|0
)paren
(brace
id|result
op_assign
(paren
r_struct
id|stats
op_star
)paren
id|ifr-&gt;ifr_ifru.ifru_data
suffix:semicolon
id|memcpy_tofs
(paren
op_amp
id|result-&gt;ppp_stats
comma
op_amp
id|ppp-&gt;stats
comma
r_sizeof
(paren
r_struct
id|ppp_stats
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ppp-&gt;slcomp
)paren
id|memcpy_tofs
(paren
op_amp
id|result-&gt;slhc
comma
id|ppp-&gt;slcomp
comma
r_sizeof
(paren
r_struct
id|slcompress
)paren
)paren
suffix:semicolon
)brace
r_return
id|error
suffix:semicolon
)brace
macro_line|#endif
multiline_comment|/*************************************************************&n; * TTY OUTPUT&n; *    The following function delivers a fully-formed PPP&n; *    frame in ppp-&gt;xbuff to the TTY for output.&n; *************************************************************/
macro_line|#ifdef NEW_TTY_DRIVERS
r_static
r_inline
r_void
macro_line|#else
r_static
r_void
macro_line|#endif
DECL|function|ppp_output_done
id|ppp_output_done
(paren
r_void
op_star
id|ppp
)paren
(brace
multiline_comment|/* unlock the transmitter queue */
id|ppp_unlock
(paren
(paren
r_struct
id|ppp
op_star
)paren
id|ppp
)paren
suffix:semicolon
multiline_comment|/* If the device is still up then enable the transmitter of the&n;     next frame. */
r_if
c_cond
(paren
(paren
(paren
r_struct
id|ppp
op_star
)paren
id|ppp
)paren
op_member_access_from_pointer
id|dev-&gt;flags
op_amp
id|IFF_UP
)paren
macro_line|#ifndef NET02D
id|mark_bh
(paren
id|NET_BH
)paren
suffix:semicolon
macro_line|#else
id|dev_tint
(paren
(paren
(paren
r_struct
id|ppp
op_star
)paren
id|ppp
)paren
op_member_access_from_pointer
id|dev
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/* enable any blocked process pending transmission */
id|wake_up_interruptible
(paren
op_amp
(paren
(paren
r_struct
id|ppp
op_star
)paren
id|ppp
)paren
op_member_access_from_pointer
id|write_wait
)paren
suffix:semicolon
)brace
macro_line|#ifndef NEW_TTY_DRIVERS
r_static
r_void
DECL|function|ppp_kick_tty
id|ppp_kick_tty
(paren
r_struct
id|ppp
op_star
id|ppp
)paren
(brace
r_register
r_int
id|count
op_assign
id|ppp-&gt;xhead
op_minus
id|ppp-&gt;xbuff
suffix:semicolon
r_register
r_int
id|answer
suffix:semicolon
id|ppp-&gt;stats.sbytes
op_add_assign
id|count
suffix:semicolon
id|answer
op_assign
id|tty_write_data
(paren
id|ppp-&gt;tty
comma
id|ppp-&gt;xbuff
comma
id|count
comma
id|ppp_output_done
comma
(paren
r_void
op_star
)paren
id|ppp
)paren
suffix:semicolon
r_if
c_cond
(paren
id|answer
op_eq
l_int|0
)paren
id|ppp_output_done
(paren
id|ppp
)paren
suffix:semicolon
multiline_comment|/* Should not happen */
r_else
r_if
c_cond
(paren
id|answer
OL
l_int|0
)paren
(brace
id|ppp-&gt;stats.serrors
op_increment
suffix:semicolon
id|ppp_output_done
(paren
id|ppp
)paren
suffix:semicolon
multiline_comment|/* unlock the transmitter */
)brace
)brace
macro_line|#else
r_static
r_void
DECL|function|ppp_kick_tty
id|ppp_kick_tty
(paren
r_struct
id|ppp
op_star
id|ppp
)paren
(brace
r_register
r_int
id|count
comma
id|actual
suffix:semicolon
id|count
op_assign
id|ppp-&gt;xhead
op_minus
id|ppp-&gt;xbuff
suffix:semicolon
id|actual
op_assign
id|ppp-&gt;tty-&gt;driver
dot
id|write
c_func
(paren
id|ppp-&gt;tty
comma
l_int|0
comma
id|ppp-&gt;xbuff
comma
id|count
)paren
suffix:semicolon
id|ppp-&gt;stats.sbytes
op_add_assign
id|actual
suffix:semicolon
r_if
c_cond
(paren
id|actual
op_eq
id|count
)paren
(brace
id|ppp_output_done
c_func
(paren
id|ppp
)paren
suffix:semicolon
)brace
r_else
(brace
id|ppp-&gt;xtail
op_assign
id|ppp-&gt;xbuff
op_plus
id|actual
suffix:semicolon
id|ppp-&gt;tty-&gt;flags
op_or_assign
(paren
l_int|1
op_lshift
id|TTY_DO_WRITE_WAKEUP
)paren
suffix:semicolon
)brace
)brace
DECL|function|ppp_write_wakeup
r_static
r_void
id|ppp_write_wakeup
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
)paren
(brace
r_register
r_int
id|count
comma
id|actual
suffix:semicolon
r_struct
id|ppp
op_star
id|ppp
op_assign
id|ppp_find
c_func
(paren
id|tty
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ppp
op_logical_or
id|ppp-&gt;magic
op_ne
id|PPP_MAGIC
)paren
(brace
id|PRINTKN
(paren
l_int|1
comma
(paren
id|KERN_ERR
l_string|&quot;PPP: write_wakeup called but couldn&squot;t &quot;
l_string|&quot;find PPP struct.&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|ppp-&gt;xtail
)paren
r_return
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ppp-&gt;flags
op_amp
id|SC_XMIT_BUSY
)paren
(brace
id|sti
c_func
(paren
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|ppp-&gt;flags
op_or_assign
id|SC_XMIT_BUSY
suffix:semicolon
id|sti
c_func
(paren
)paren
suffix:semicolon
id|count
op_assign
id|ppp-&gt;xhead
op_minus
id|ppp-&gt;xtail
suffix:semicolon
id|actual
op_assign
id|tty-&gt;driver
dot
id|write
c_func
(paren
id|tty
comma
l_int|0
comma
id|ppp-&gt;xtail
comma
id|count
)paren
suffix:semicolon
id|ppp-&gt;stats.sbytes
op_add_assign
id|actual
suffix:semicolon
r_if
c_cond
(paren
id|actual
op_eq
id|count
)paren
(brace
id|ppp-&gt;xtail
op_assign
l_int|0
suffix:semicolon
id|tty-&gt;flags
op_and_assign
op_complement
id|TTY_DO_WRITE_WAKEUP
suffix:semicolon
id|ppp_output_done
c_func
(paren
id|ppp
)paren
suffix:semicolon
)brace
r_else
(brace
id|ppp-&gt;xtail
op_add_assign
id|actual
suffix:semicolon
)brace
id|ppp-&gt;flags
op_and_assign
op_complement
id|SC_XMIT_BUSY
suffix:semicolon
)brace
macro_line|#endif
multiline_comment|/*************************************************************&n; * TTY INPUT&n; *    The following functions handle input that arrives from&n; *    the TTY.  It recognizes PPP frames and either hands them&n; *    to the network layer or queues them for delivery to a&n; *    user process reading this TTY.&n; *************************************************************/
multiline_comment|/* stuff a single character into the receive buffer */
r_static
r_inline
r_void
DECL|function|ppp_enqueue
id|ppp_enqueue
c_func
(paren
r_struct
id|ppp
op_star
id|ppp
comma
r_int
r_char
id|c
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ppp-&gt;rhead
OL
id|ppp-&gt;rend
)paren
(brace
op_star
id|ppp-&gt;rhead
op_assign
id|c
suffix:semicolon
id|ppp-&gt;rhead
op_increment
suffix:semicolon
id|ppp-&gt;rcount
op_increment
suffix:semicolon
)brace
r_else
id|ppp-&gt;stats.roverrun
op_increment
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
macro_line|#ifdef CHECK_CHARACTERS
DECL|variable|paritytab
r_static
r_int
id|paritytab
(braket
l_int|8
)braket
op_assign
(brace
l_int|0x96696996
comma
l_int|0x69969669
comma
l_int|0x69969669
comma
l_int|0x96696996
comma
l_int|0x69969669
comma
l_int|0x96696996
comma
l_int|0x96696996
comma
l_int|0x69969669
)brace
suffix:semicolon
macro_line|#endif
macro_line|#ifndef NEW_TTY_DRIVERS
r_static
r_void
DECL|function|ppp_dump_inqueue
id|ppp_dump_inqueue
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
)paren
(brace
r_int
id|head
op_assign
id|tty-&gt;read_q.head
comma
id|tail
op_assign
id|tty-&gt;read_q.tail
comma
id|i
comma
id|count
suffix:semicolon
r_char
id|buffer
(braket
l_int|8
)braket
suffix:semicolon
id|PRINTK
(paren
(paren
id|KERN_DEBUG
l_string|&quot;INQUEUE: head %d tail %d imode %x:&bslash;n&quot;
comma
id|head
comma
id|tail
comma
(paren
r_int
r_int
)paren
id|tty-&gt;termios-&gt;c_iflag
)paren
)paren
id|i
op_assign
id|tail
suffix:semicolon
id|count
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
id|i
op_ne
id|head
)paren
(brace
id|buffer
(braket
id|count
)braket
op_assign
id|tty-&gt;read_q.buf
(braket
id|i
)braket
suffix:semicolon
r_if
c_cond
(paren
op_increment
id|count
op_eq
l_int|8
)paren
(brace
id|ppp_print_buffer
(paren
l_int|NULL
comma
id|buffer
comma
l_int|8
comma
id|KERNEL_DS
)paren
suffix:semicolon
id|count
op_assign
l_int|0
suffix:semicolon
)brace
id|i
op_assign
(paren
id|i
op_plus
l_int|1
)paren
op_amp
(paren
id|TTY_BUF_SIZE
op_minus
l_int|1
)paren
suffix:semicolon
)brace
id|ppp_print_buffer
(paren
l_int|NULL
comma
id|buffer
comma
id|count
comma
id|KERNEL_DS
)paren
suffix:semicolon
)brace
multiline_comment|/* called by lower levels of TTY driver when data becomes available.&n;   all incoming data comes through this function. */
DECL|function|ppp_tty_input_ready
r_void
id|ppp_tty_input_ready
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
)paren
(brace
r_struct
id|ppp
op_star
id|ppp
op_assign
id|ppp_find
c_func
(paren
id|tty
)paren
suffix:semicolon
r_int
id|n
comma
id|error
suffix:semicolon
r_int
r_char
id|buff
(braket
l_int|128
)braket
suffix:semicolon
multiline_comment|/*  PRINTK( (KERN_DEBUG &quot;PPP: handler called.&bslash;n&quot;) ) */
r_if
c_cond
(paren
op_logical_neg
id|ppp
op_logical_or
id|ppp-&gt;magic
op_ne
id|PPP_MAGIC
)paren
(brace
id|PRINTKN
(paren
l_int|1
comma
(paren
id|KERN_ERR
l_string|&quot;PPP: handler called but couldn&squot;t find PPP struct.&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|CHECK_PPP_VOID
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* ZZZ */
r_if
c_cond
(paren
id|ppp_debug
op_ge
l_int|5
)paren
id|ppp_dump_inqueue
c_func
(paren
id|ppp-&gt;tty
)paren
suffix:semicolon
r_do
(brace
id|n
op_assign
id|tty_read_raw_data
c_func
(paren
id|tty
comma
id|buff
comma
l_int|128
)paren
suffix:semicolon
r_if
c_cond
(paren
id|n
op_eq
l_int|0
)paren
multiline_comment|/* nothing there */
r_break
suffix:semicolon
r_if
c_cond
(paren
id|ppp_debug
op_ge
l_int|5
)paren
id|ppp_print_buffer
(paren
l_string|&quot;receive buffer&quot;
comma
id|buff
comma
id|n
OG
l_int|0
ques
c_cond
id|n
suffix:colon
op_minus
id|n
comma
id|KERNEL_DS
)paren
suffix:semicolon
r_if
c_cond
(paren
id|n
OL
l_int|0
)paren
(brace
multiline_comment|/* Last character is error flag.&n;&t; Process the previous characters, then set toss flag. */
id|n
op_assign
(paren
op_minus
id|n
)paren
op_minus
l_int|1
suffix:semicolon
id|error
op_assign
id|buff
(braket
id|n
)braket
suffix:semicolon
)brace
r_else
id|error
op_assign
l_int|0
suffix:semicolon
id|ppp-&gt;stats.rbytes
op_add_assign
id|n
suffix:semicolon
id|ppp_unesc
c_func
(paren
id|ppp
comma
id|buff
comma
id|n
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
)paren
id|ppp-&gt;toss
op_assign
id|error
suffix:semicolon
)brace
r_while
c_loop
(paren
l_int|1
)paren
suffix:semicolon
)brace
multiline_comment|/* recover frame by undoing PPP escape mechanism;&n;   copies N chars of input data from C into PPP-&gt;rbuff&n;   calls ppp_doframe to dispose of any frames it finds&n;*/
r_static
r_void
DECL|function|ppp_unesc
id|ppp_unesc
c_func
(paren
r_struct
id|ppp
op_star
id|ppp
comma
r_int
r_char
op_star
id|c
comma
r_int
id|n
)paren
(brace
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|n
suffix:semicolon
id|i
op_increment
comma
id|c
op_increment
)paren
(brace
id|PRINTKN
(paren
l_int|6
comma
(paren
id|KERN_DEBUG
l_string|&quot;(%x)&quot;
comma
(paren
r_int
r_int
)paren
op_star
id|c
)paren
)paren
suffix:semicolon
macro_line|#ifdef CHECK_CHARACTERS
r_if
c_cond
(paren
op_star
id|c
op_amp
l_int|0x80
)paren
id|sc-&gt;sc_flags
op_or_assign
id|SC_RCV_B7_1
suffix:semicolon
r_else
id|sc-&gt;sc_flags
op_or_assign
id|SC_RCV_B7_0
suffix:semicolon
r_if
c_cond
(paren
id|paritytab
(braket
op_star
id|c
op_rshift
l_int|5
)braket
op_amp
(paren
l_int|1
op_lshift
(paren
op_star
id|c
op_amp
l_int|0x1F
)paren
)paren
)paren
id|sc-&gt;sc_flags
op_or_assign
id|SC_RCV_ODDP
suffix:semicolon
r_else
id|sc-&gt;sc_flags
op_or_assign
id|SC_RCV_EVNP
suffix:semicolon
macro_line|#endif
r_switch
c_cond
(paren
op_star
id|c
)paren
(brace
r_case
id|PPP_ESC
suffix:colon
multiline_comment|/* PPP_ESC: invert 0x20 in next character */
id|ppp-&gt;escape
op_assign
id|PPP_TRANS
suffix:semicolon
r_break
suffix:semicolon
r_case
id|PPP_FLAG
suffix:colon
multiline_comment|/* PPP_FLAG: end of frame */
r_if
c_cond
(paren
id|ppp-&gt;escape
)paren
multiline_comment|/* PPP_ESC just before PPP_FLAG is illegal */
id|ppp-&gt;toss
op_assign
l_int|0xFF
suffix:semicolon
r_if
c_cond
(paren
(paren
id|ppp-&gt;toss
op_amp
l_int|0x80
)paren
op_eq
l_int|0
)paren
id|ppp_doframe
c_func
(paren
id|ppp
)paren
suffix:semicolon
multiline_comment|/* pass frame on to next layers */
id|ppp-&gt;rcount
op_assign
l_int|0
suffix:semicolon
id|ppp-&gt;rhead
op_assign
id|ppp-&gt;rbuff
suffix:semicolon
id|ppp-&gt;escape
op_assign
l_int|0
suffix:semicolon
id|ppp-&gt;toss
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
(brace
)brace
multiline_comment|/* regular character */
r_if
c_cond
(paren
op_logical_neg
id|in_rmap
(paren
id|ppp
comma
op_star
id|c
)paren
)paren
(brace
r_if
c_cond
(paren
id|ppp-&gt;toss
op_eq
l_int|0
)paren
id|ppp_enqueue
(paren
id|ppp
comma
op_star
id|c
op_xor
id|ppp-&gt;escape
)paren
suffix:semicolon
id|ppp-&gt;escape
op_assign
l_int|0
suffix:semicolon
)brace
r_break
suffix:semicolon
)brace
)brace
)brace
macro_line|#else
DECL|function|ppp_receive_room
r_static
r_int
id|ppp_receive_room
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
)paren
(brace
r_return
l_int|65536
suffix:semicolon
multiline_comment|/* We can handle an infinite amount of data. :-) */
)brace
DECL|function|ppp_receive_buf
r_static
r_void
id|ppp_receive_buf
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
comma
r_const
r_int
r_char
op_star
id|cp
comma
r_char
op_star
id|fp
comma
r_int
id|count
)paren
(brace
r_register
r_struct
id|ppp
op_star
id|ppp
op_assign
id|ppp_find
(paren
id|tty
)paren
suffix:semicolon
r_int
r_char
id|c
suffix:semicolon
multiline_comment|/*  PRINTK( (&quot;PPP: handler called.&bslash;n&quot;) ); */
r_if
c_cond
(paren
op_logical_neg
id|ppp
op_logical_or
id|ppp-&gt;magic
op_ne
id|PPP_MAGIC
)paren
(brace
id|PRINTKN
(paren
l_int|1
comma
(paren
l_string|&quot;PPP: handler called but couldn&squot;t find &quot;
l_string|&quot;PPP struct.&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|CHECK_PPP_VOID
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ppp_debug
op_ge
l_int|5
)paren
(brace
id|ppp_print_buffer
(paren
l_string|&quot;receive buffer&quot;
comma
id|cp
comma
id|count
comma
id|KERNEL_DS
)paren
suffix:semicolon
)brace
id|ppp-&gt;stats.rbytes
op_add_assign
id|count
suffix:semicolon
r_while
c_loop
(paren
id|count
op_decrement
OG
l_int|0
)paren
(brace
id|c
op_assign
op_star
id|cp
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|fp
)paren
(brace
r_if
c_cond
(paren
op_star
id|fp
op_logical_and
id|ppp-&gt;toss
op_eq
l_int|0
)paren
id|ppp-&gt;toss
op_assign
op_star
id|fp
suffix:semicolon
id|fp
op_increment
suffix:semicolon
)brace
macro_line|#ifdef CHECK_CHARACTERS
r_if
c_cond
(paren
id|c
op_amp
l_int|0x80
)paren
id|ppp-&gt;flags
op_or_assign
id|SC_RCV_B7_1
suffix:semicolon
r_else
id|ppp-&gt;flags
op_or_assign
id|SC_RCV_B7_0
suffix:semicolon
r_if
c_cond
(paren
id|paritytab
(braket
id|c
op_rshift
l_int|5
)braket
op_amp
(paren
l_int|1
op_lshift
(paren
id|c
op_amp
l_int|0x1F
)paren
)paren
)paren
id|ppp-&gt;flags
op_or_assign
id|SC_RCV_ODDP
suffix:semicolon
r_else
id|ppp-&gt;flags
op_or_assign
id|SC_RCV_EVNP
suffix:semicolon
macro_line|#endif
r_switch
c_cond
(paren
id|c
)paren
(brace
r_case
id|PPP_ESC
suffix:colon
multiline_comment|/* PPP_ESC: invert 0x20 in next character */
id|ppp-&gt;escape
op_assign
id|PPP_TRANS
suffix:semicolon
r_break
suffix:semicolon
r_case
id|PPP_FLAG
suffix:colon
multiline_comment|/* PPP_FLAG: end of frame */
r_if
c_cond
(paren
id|ppp-&gt;escape
)paren
multiline_comment|/* PPP_ESC just before PPP_FLAG is &quot;cancel&quot;*/
id|ppp-&gt;toss
op_assign
l_int|0xFF
suffix:semicolon
r_if
c_cond
(paren
(paren
id|ppp-&gt;toss
op_amp
l_int|0x80
)paren
op_eq
l_int|0
)paren
id|ppp_doframe
c_func
(paren
id|ppp
)paren
suffix:semicolon
multiline_comment|/* pass frame on to next layers */
id|ppp-&gt;rcount
op_assign
l_int|0
suffix:semicolon
id|ppp-&gt;rhead
op_assign
id|ppp-&gt;rbuff
suffix:semicolon
id|ppp-&gt;escape
op_assign
l_int|0
suffix:semicolon
id|ppp-&gt;toss
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
(brace
)brace
multiline_comment|/* regular character */
r_if
c_cond
(paren
op_logical_neg
id|in_rmap
(paren
id|ppp
comma
id|c
)paren
)paren
(brace
r_if
c_cond
(paren
id|ppp-&gt;toss
op_eq
l_int|0
)paren
id|ppp_enqueue
(paren
id|ppp
comma
id|c
op_xor
id|ppp-&gt;escape
)paren
suffix:semicolon
id|ppp-&gt;escape
op_assign
l_int|0
suffix:semicolon
)brace
)brace
)brace
)brace
macro_line|#endif
multiline_comment|/* on entry, a received frame is in ppp-&gt;rbuff&n;   check it and dispose as appropriate */
r_static
r_void
DECL|function|ppp_doframe
id|ppp_doframe
c_func
(paren
r_struct
id|ppp
op_star
id|ppp
)paren
(brace
id|u_char
op_star
id|c
op_assign
id|ppp-&gt;rbuff
suffix:semicolon
id|u_short
id|proto
suffix:semicolon
r_int
id|count
op_assign
id|ppp-&gt;rcount
suffix:semicolon
multiline_comment|/* forget it if we&squot;ve already noticed an error */
r_if
c_cond
(paren
id|ppp-&gt;toss
)paren
(brace
id|PRINTKN
(paren
l_int|1
comma
(paren
id|KERN_WARNING
l_string|&quot;ppp_toss: tossing frame, reason = %d&bslash;n&quot;
comma
id|ppp-&gt;toss
)paren
)paren
suffix:semicolon
id|slhc_toss
(paren
id|ppp-&gt;slcomp
)paren
suffix:semicolon
id|ppp-&gt;stats.rerrors
op_increment
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/* do this before printing buffer to avoid generating copious output */
r_if
c_cond
(paren
id|count
op_eq
l_int|0
)paren
r_return
suffix:semicolon
r_if
c_cond
(paren
id|ppp_debug
op_ge
l_int|3
)paren
id|ppp_print_buffer
(paren
l_string|&quot;receive frame&quot;
comma
id|c
comma
id|count
comma
id|KERNEL_DS
)paren
suffix:semicolon
r_if
c_cond
(paren
id|count
OL
l_int|4
)paren
(brace
id|PRINTKN
(paren
l_int|1
comma
(paren
id|KERN_WARNING
l_string|&quot;ppp: got runt ppp frame, %d chars&bslash;n&quot;
comma
id|count
)paren
)paren
suffix:semicolon
id|slhc_toss
(paren
id|ppp-&gt;slcomp
)paren
suffix:semicolon
id|ppp-&gt;stats.runts
op_increment
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/* check PPP error detection field */
r_if
c_cond
(paren
op_logical_neg
id|ppp_check_fcs
c_func
(paren
id|ppp
)paren
)paren
(brace
id|PRINTKN
(paren
l_int|1
comma
(paren
id|KERN_WARNING
l_string|&quot;ppp: frame with bad fcs&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|slhc_toss
(paren
id|ppp-&gt;slcomp
)paren
suffix:semicolon
id|ppp-&gt;stats.rerrors
op_increment
suffix:semicolon
r_return
suffix:semicolon
)brace
id|count
op_sub_assign
l_int|2
suffix:semicolon
multiline_comment|/* ignore last two characters */
multiline_comment|/* now we have a good frame */
multiline_comment|/* figure out the protocol field */
r_if
c_cond
(paren
(paren
id|c
(braket
l_int|0
)braket
op_eq
id|PPP_ADDRESS
)paren
op_logical_and
(paren
id|c
(braket
l_int|1
)braket
op_eq
id|PPP_CONTROL
)paren
)paren
(brace
id|c
op_assign
id|c
op_plus
l_int|2
suffix:semicolon
multiline_comment|/* ADDR/CTRL not compressed, so skip */
id|count
op_sub_assign
l_int|2
suffix:semicolon
)brace
id|proto
op_assign
(paren
id|u_short
)paren
op_star
id|c
op_increment
suffix:semicolon
multiline_comment|/* PROTO compressed */
r_if
c_cond
(paren
id|proto
op_amp
l_int|1
)paren
(brace
id|count
op_decrement
suffix:semicolon
)brace
r_else
(brace
id|proto
op_assign
(paren
id|proto
op_lshift
l_int|8
)paren
op_or
(paren
id|u_short
)paren
op_star
id|c
op_increment
suffix:semicolon
multiline_comment|/* PROTO uncompressed */
id|count
op_sub_assign
l_int|2
suffix:semicolon
)brace
multiline_comment|/* Send the frame to the network if the ppp device is up */
r_if
c_cond
(paren
(paren
id|ppp-&gt;dev-&gt;flags
op_amp
id|IFF_UP
)paren
op_logical_and
id|ppp_do_ip
c_func
(paren
id|ppp
comma
id|proto
comma
id|c
comma
id|count
)paren
)paren
(brace
id|ppp-&gt;ddinfo.ip_rjiffies
op_assign
id|jiffies
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/* If we got here, it has to go to a user process doing a read,&n;     so queue it.&n;&n;     User process expects to get whole frame (for some reason), so&n;     use count+2 so as to include FCS field. */
r_if
c_cond
(paren
id|ppp_us_queue
(paren
id|ppp
comma
id|proto
comma
id|c
comma
id|count
op_plus
l_int|2
)paren
)paren
(brace
id|ppp-&gt;ddinfo.nip_rjiffies
op_assign
id|jiffies
suffix:semicolon
id|ppp-&gt;stats.rothers
op_increment
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/* couldn&squot;t cope. */
id|PRINTKN
(paren
l_int|1
comma
(paren
id|KERN_WARNING
l_string|&quot;ppp: dropping packet on the floor: nobody could take it.&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|slhc_toss
(paren
id|ppp-&gt;slcomp
)paren
suffix:semicolon
id|ppp-&gt;stats.tossed
op_increment
suffix:semicolon
)brace
multiline_comment|/* Examine packet at C, attempt to pass up to net layer. &n;   PROTO is the protocol field from the PPP frame.&n;   Return 1 if could handle it, 0 otherwise.  */
r_static
r_int
DECL|function|ppp_do_ip
id|ppp_do_ip
(paren
r_struct
id|ppp
op_star
id|ppp
comma
r_int
r_int
id|proto
comma
r_int
r_char
op_star
id|c
comma
r_int
id|count
)paren
(brace
r_int
id|flags
comma
id|done
suffix:semicolon
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
id|PRINTKN
(paren
l_int|4
comma
(paren
id|KERN_DEBUG
l_string|&quot;ppp_do_ip: proto %x len %d first byte %x&bslash;n&quot;
comma
(paren
r_int
)paren
id|proto
comma
id|count
comma
id|c
(braket
l_int|0
)braket
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ppp_debug_netpackets
)paren
(brace
id|PRINTK
(paren
(paren
l_string|&quot;KERN_DEBUG %s &lt;-- proto %x len %d&bslash;n&quot;
comma
id|ppp-&gt;dev-&gt;name
comma
(paren
r_int
)paren
id|proto
comma
id|count
)paren
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|proto
op_eq
id|PROTO_IP
)paren
(brace
id|ppp-&gt;stats.runcomp
op_increment
suffix:semicolon
r_goto
id|sendit
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|proto
op_eq
id|PROTO_VJCOMP
)paren
op_logical_and
op_logical_neg
(paren
id|ppp-&gt;flags
op_amp
id|SC_REJ_COMP_TCP
)paren
)paren
(brace
multiline_comment|/* get space for uncompressing the header */
id|done
op_assign
l_int|0
suffix:semicolon
id|save_flags
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|ppp-&gt;rhead
op_plus
l_int|80
)paren
OL
id|ppp-&gt;rend
)paren
(brace
id|ppp-&gt;rhead
op_add_assign
l_int|80
suffix:semicolon
id|ppp-&gt;rcount
op_add_assign
l_int|80
suffix:semicolon
id|done
op_assign
l_int|1
suffix:semicolon
)brace
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|done
)paren
(brace
id|PRINTKN
(paren
l_int|1
comma
(paren
id|KERN_NOTICE
l_string|&quot;ppp: no space to decompress VJ compressed TCP header.&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|ppp-&gt;stats.roverrun
op_increment
suffix:semicolon
id|slhc_toss
(paren
id|ppp-&gt;slcomp
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
id|count
op_assign
id|slhc_uncompress
c_func
(paren
id|ppp-&gt;slcomp
comma
id|c
comma
id|count
)paren
suffix:semicolon
r_if
c_cond
(paren
id|count
op_le
l_int|0
)paren
(brace
id|ppp-&gt;stats.rerrors
op_increment
suffix:semicolon
id|PRINTKN
(paren
l_int|1
comma
(paren
id|KERN_NOTICE
l_string|&quot;ppp: error in VJ decompression&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|slhc_toss
(paren
id|ppp-&gt;slcomp
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
id|ppp-&gt;stats.rcomp
op_increment
suffix:semicolon
r_goto
id|sendit
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|proto
op_eq
id|PROTO_VJUNCOMP
)paren
op_logical_and
op_logical_neg
(paren
id|ppp-&gt;flags
op_amp
id|SC_REJ_COMP_TCP
)paren
)paren
(brace
r_if
c_cond
(paren
id|slhc_remember
c_func
(paren
id|ppp-&gt;slcomp
comma
id|c
comma
id|count
)paren
op_le
l_int|0
)paren
(brace
id|ppp-&gt;stats.rerrors
op_increment
suffix:semicolon
id|PRINTKN
(paren
l_int|1
comma
(paren
id|KERN_NOTICE
l_string|&quot;ppp: error in VJ memorizing&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|slhc_toss
(paren
id|ppp-&gt;slcomp
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
id|ppp-&gt;stats.runcomp
op_increment
suffix:semicolon
r_goto
id|sendit
suffix:semicolon
)brace
multiline_comment|/* not ours */
r_return
l_int|0
suffix:semicolon
id|sendit
suffix:colon
r_if
c_cond
(paren
id|ppp_debug_netpackets
)paren
(brace
r_struct
id|iphdr
op_star
id|iph
op_assign
(paren
r_struct
id|iphdr
op_star
)paren
id|c
suffix:semicolon
id|PRINTK
(paren
(paren
id|KERN_INFO
l_string|&quot;%s &lt;--    src %x dst %x len %d&bslash;n&quot;
comma
id|ppp-&gt;dev-&gt;name
comma
id|iph-&gt;saddr
comma
id|iph-&gt;daddr
comma
id|count
)paren
)paren
)brace
multiline_comment|/* receive the frame through the network software */
id|skb
op_assign
id|dev_alloc_skb
c_func
(paren
id|count
)paren
suffix:semicolon
r_if
c_cond
(paren
id|skb
)paren
(brace
id|skb-&gt;mac.raw
op_assign
id|skb-&gt;data
suffix:semicolon
id|memcpy
c_func
(paren
id|skb_put
c_func
(paren
id|skb
comma
id|count
)paren
comma
id|c
comma
id|count
)paren
suffix:semicolon
id|skb-&gt;protocol
op_assign
id|htons
c_func
(paren
id|ETH_P_IP
)paren
suffix:semicolon
id|skb-&gt;dev
op_assign
id|ppp-&gt;dev
suffix:semicolon
id|netif_rx
c_func
(paren
id|skb
)paren
suffix:semicolon
)brace
r_return
l_int|1
suffix:semicolon
)brace
multiline_comment|/* stuff packet at BUF, length LEN, into the us_rbuff buffer&n;   prepend PROTO information */
DECL|macro|PUTC
mdefine_line|#define PUTC(c,label) *ppp-&gt;us_rbuff_head++ = c; &bslash;&n;                if (ppp-&gt;us_rbuff_head == ppp-&gt;us_rbuff_end) &bslash;&n;                     ppp-&gt;us_rbuff_head = ppp-&gt;us_rbuff; &bslash;&n;                if (ppp-&gt;us_rbuff_head == ppp-&gt;us_rbuff_tail) &bslash;&n;                     goto label;
DECL|macro|GETC
mdefine_line|#define GETC(c) c = *ppp-&gt;us_rbuff_tail++; &bslash;&n;                if (ppp-&gt;us_rbuff_tail == ppp-&gt;us_rbuff_end) &bslash;&n;                     ppp-&gt;us_rbuff_tail = ppp-&gt;us_rbuff;
r_static
r_int
DECL|function|ppp_us_queue
id|ppp_us_queue
c_func
(paren
r_struct
id|ppp
op_star
id|ppp
comma
r_int
r_int
id|proto
comma
r_int
r_char
op_star
id|buf
comma
r_int
id|len
)paren
(brace
r_int
id|totlen
suffix:semicolon
r_int
r_char
op_star
id|saved_head
suffix:semicolon
id|totlen
op_assign
id|len
op_plus
l_int|2
suffix:semicolon
multiline_comment|/* including protocol */
r_if
c_cond
(paren
id|set_bit
c_func
(paren
l_int|1
comma
op_amp
id|ppp-&gt;us_rbuff_lock
)paren
)paren
(brace
id|PRINTKN
(paren
l_int|1
comma
(paren
id|KERN_NOTICE
l_string|&quot;ppp_us_queue: can&squot;t get lock&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|saved_head
op_assign
id|ppp-&gt;us_rbuff_head
suffix:semicolon
id|PUTC
c_func
(paren
(paren
id|totlen
op_amp
l_int|0xff00
)paren
op_rshift
l_int|8
comma
id|failure
)paren
suffix:semicolon
id|PUTC
c_func
(paren
id|totlen
op_amp
l_int|0x00ff
comma
id|failure
)paren
suffix:semicolon
id|PUTC
c_func
(paren
(paren
id|proto
op_amp
l_int|0xff00
)paren
op_rshift
l_int|8
comma
id|failure
)paren
suffix:semicolon
id|PUTC
c_func
(paren
id|proto
op_amp
l_int|0x00ff
comma
id|failure
)paren
suffix:semicolon
r_while
c_loop
(paren
id|len
op_decrement
OG
l_int|0
)paren
(brace
id|PUTC
c_func
(paren
op_star
id|buf
op_increment
comma
id|failure
)paren
suffix:semicolon
)brace
id|PRINTKN
(paren
l_int|3
comma
(paren
id|KERN_INFO
l_string|&quot;ppp: successfully queued %d bytes&bslash;n&quot;
comma
id|totlen
)paren
)paren
suffix:semicolon
id|clear_bit
c_func
(paren
l_int|1
comma
op_amp
id|ppp-&gt;us_rbuff_lock
)paren
suffix:semicolon
id|wake_up_interruptible
(paren
op_amp
id|ppp-&gt;read_wait
)paren
suffix:semicolon
macro_line|#ifdef NEW_TTY_DRIVERS
id|kill_fasync
c_func
(paren
id|ppp-&gt;tty-&gt;fasync
comma
id|SIGIO
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|ppp-&gt;inp_sig
op_logical_and
id|ppp-&gt;inp_sig_pid
)paren
r_if
c_cond
(paren
id|kill_proc
(paren
id|ppp-&gt;inp_sig_pid
comma
id|ppp-&gt;inp_sig
comma
l_int|1
)paren
op_ne
l_int|0
)paren
(brace
multiline_comment|/* process is gone */
id|PRINTKN
(paren
l_int|2
comma
(paren
id|KERN_NOTICE
l_string|&quot;ppp: process that requested notification is gone&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|ppp-&gt;inp_sig
op_assign
l_int|0
suffix:semicolon
id|ppp-&gt;inp_sig_pid
op_assign
l_int|0
suffix:semicolon
)brace
r_return
l_int|1
suffix:semicolon
id|failure
suffix:colon
id|ppp-&gt;us_rbuff_head
op_assign
id|saved_head
suffix:semicolon
id|clear_bit
c_func
(paren
l_int|1
comma
op_amp
id|ppp-&gt;us_rbuff_lock
)paren
suffix:semicolon
id|PRINTKN
(paren
l_int|1
comma
(paren
id|KERN_NOTICE
l_string|&quot;ppp_us_queue: ran out of buffer space.&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*************************************************************&n; * LINE DISCIPLINE SUPPORT&n; *    The following functions form support user programs&n; *    which read and write data on a TTY with the PPP line&n; *    discipline.  Reading is done from a circular queue,&n; *    filled by the lower TTY levels.&n; *************************************************************/
multiline_comment|/* read a PPP frame from the us_rbuff circular buffer, &n;   waiting if necessary&n;*/
r_static
r_int
DECL|function|ppp_read
id|ppp_read
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
comma
r_struct
id|file
op_star
id|file
comma
r_int
r_char
op_star
id|buf
comma
r_int
r_int
id|nr
)paren
(brace
r_struct
id|ppp
op_star
id|ppp
op_assign
id|ppp_find
c_func
(paren
id|tty
)paren
suffix:semicolon
r_int
r_char
id|c
suffix:semicolon
r_int
id|len
comma
id|i
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ppp
op_logical_or
id|ppp-&gt;magic
op_ne
id|PPP_MAGIC
)paren
(brace
id|PRINTKN
(paren
l_int|1
comma
(paren
id|KERN_ERR
l_string|&quot;ppp_read: cannot find ppp channel&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
id|CHECK_PPP
c_func
(paren
op_minus
id|ENXIO
)paren
suffix:semicolon
id|PRINTKN
(paren
l_int|4
comma
(paren
id|KERN_DEBUG
l_string|&quot;ppp_read: called %p num %u&bslash;n&quot;
comma
id|buf
comma
id|nr
)paren
)paren
suffix:semicolon
r_do
(brace
multiline_comment|/* try to acquire read lock */
r_if
c_cond
(paren
id|set_bit
c_func
(paren
l_int|0
comma
op_amp
id|ppp-&gt;us_rbuff_lock
)paren
op_eq
l_int|0
)paren
(brace
multiline_comment|/* got lock */
r_if
c_cond
(paren
id|ppp-&gt;us_rbuff_head
op_eq
id|ppp-&gt;us_rbuff_tail
)paren
(brace
multiline_comment|/* no data */
id|PRINTKN
(paren
l_int|4
comma
(paren
id|KERN_DEBUG
l_string|&quot;ppp_read: no data&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|clear_bit
c_func
(paren
l_int|0
comma
op_amp
id|ppp-&gt;us_rbuff_lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ppp-&gt;inp_sig
)paren
(brace
id|PRINTKN
(paren
l_int|4
comma
(paren
id|KERN_DEBUG
l_string|&quot;ppp_read: EWOULDBLOCK&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_return
op_minus
id|EWOULDBLOCK
suffix:semicolon
)brace
r_else
r_goto
id|wait
suffix:semicolon
)brace
id|i
op_assign
id|verify_area
(paren
id|VERIFY_WRITE
comma
id|buf
comma
id|nr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
op_ne
l_int|0
)paren
(brace
id|ppp-&gt;us_rbuff_lock
op_assign
l_int|0
suffix:semicolon
r_return
id|i
suffix:semicolon
)brace
multiline_comment|/* reset the time of the last read operation */
id|ppp-&gt;ddinfo.nip_rjiffies
op_assign
id|jiffies
suffix:semicolon
id|GETC
(paren
id|c
)paren
suffix:semicolon
id|len
op_assign
id|c
op_lshift
l_int|8
suffix:semicolon
id|GETC
(paren
id|c
)paren
suffix:semicolon
id|len
op_add_assign
id|c
suffix:semicolon
id|PRINTKN
(paren
l_int|4
comma
(paren
id|KERN_DEBUG
l_string|&quot;ppp_read: len = %d&bslash;n&quot;
comma
id|len
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|len
op_plus
l_int|2
OG
id|nr
)paren
(brace
multiline_comment|/* frame too big; can&squot;t copy it, but do update us_rbuff_head */
id|PRINTKN
(paren
l_int|1
comma
(paren
id|KERN_DEBUG
l_string|&quot;ppp: read of %u bytes too small for %d frame&bslash;n&quot;
comma
id|nr
comma
id|len
op_plus
l_int|2
)paren
)paren
suffix:semicolon
id|ppp-&gt;us_rbuff_head
op_add_assign
id|len
suffix:semicolon
r_if
c_cond
(paren
id|ppp-&gt;us_rbuff_head
OG
id|ppp-&gt;us_rbuff_end
)paren
id|ppp-&gt;us_rbuff_head
op_add_assign
op_minus
(paren
id|ppp-&gt;us_rbuff_end
op_minus
id|ppp-&gt;us_rbuff
)paren
suffix:semicolon
id|clear_bit
c_func
(paren
l_int|0
comma
op_amp
id|ppp-&gt;us_rbuff_lock
)paren
suffix:semicolon
id|wake_up_interruptible
(paren
op_amp
id|ppp-&gt;read_wait
)paren
suffix:semicolon
id|ppp-&gt;stats.rgiants
op_increment
suffix:semicolon
r_return
op_minus
id|EOVERFLOW
suffix:semicolon
multiline_comment|/* ZZZ; HACK! */
)brace
r_else
(brace
multiline_comment|/* have the space: copy the packet, faking the first two bytes */
id|put_user
(paren
id|PPP_ADDRESS
comma
id|buf
op_increment
)paren
suffix:semicolon
id|put_user
(paren
id|PPP_CONTROL
comma
id|buf
op_increment
)paren
suffix:semicolon
id|i
op_assign
id|len
suffix:semicolon
r_while
c_loop
(paren
id|i
op_decrement
OG
l_int|0
)paren
(brace
id|GETC
(paren
id|c
)paren
suffix:semicolon
id|put_user
(paren
id|c
comma
id|buf
op_increment
)paren
suffix:semicolon
)brace
)brace
id|clear_bit
c_func
(paren
l_int|0
comma
op_amp
id|ppp-&gt;us_rbuff_lock
)paren
suffix:semicolon
id|PRINTKN
(paren
l_int|3
comma
(paren
id|KERN_DEBUG
l_string|&quot;ppp_read: passing %d bytes up&bslash;n&quot;
comma
id|len
op_plus
l_int|2
)paren
)paren
suffix:semicolon
id|ppp-&gt;stats.rothers
op_increment
suffix:semicolon
r_return
id|len
op_plus
l_int|2
suffix:semicolon
)brace
multiline_comment|/* need to wait */
id|wait
suffix:colon
id|current-&gt;timeout
op_assign
l_int|0
suffix:semicolon
id|PRINTKN
(paren
l_int|3
comma
(paren
id|KERN_DEBUG
l_string|&quot;ppp_read: sleeping&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|interruptible_sleep_on
(paren
op_amp
id|ppp-&gt;read_wait
)paren
suffix:semicolon
multiline_comment|/* Ensure that the ppp device is still attached. */
id|ppp
op_assign
id|ppp_find
c_func
(paren
id|tty
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ppp
op_logical_or
id|ppp-&gt;magic
op_ne
id|PPP_MAGIC
op_logical_or
op_logical_neg
id|ppp-&gt;inuse
)paren
r_return
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|current-&gt;signal
op_amp
op_complement
id|current-&gt;blocked
)paren
r_return
op_minus
id|EINTR
suffix:semicolon
)brace
r_while
c_loop
(paren
l_int|1
)paren
suffix:semicolon
)brace
multiline_comment|/* stuff a character into the transmit buffer, using PPP&squot;s way of escaping&n;   special characters.&n;   also, update ppp-&gt;fcs to take account of new character */
r_static
r_inline
r_void
DECL|function|ppp_stuff_char
id|ppp_stuff_char
c_func
(paren
r_struct
id|ppp
op_star
id|ppp
comma
r_int
r_char
id|c
)paren
(brace
r_int
id|curpt
op_assign
id|ppp-&gt;xhead
op_minus
id|ppp-&gt;xbuff
suffix:semicolon
r_if
c_cond
(paren
(paren
id|curpt
OL
l_int|0
)paren
op_logical_or
(paren
id|curpt
OG
l_int|3000
)paren
)paren
(brace
id|PRINTK
(paren
(paren
id|KERN_DEBUG
l_string|&quot;ppp_stuff_char: %p %p %d&bslash;n&quot;
comma
id|ppp-&gt;xbuff
comma
id|ppp-&gt;xhead
comma
id|curpt
)paren
)paren
)brace
r_if
c_cond
(paren
id|in_xmap
(paren
id|ppp
comma
id|c
)paren
)paren
(brace
op_star
id|ppp-&gt;xhead
op_increment
op_assign
id|PPP_ESC
suffix:semicolon
op_star
id|ppp-&gt;xhead
op_increment
op_assign
id|c
op_xor
id|PPP_TRANS
suffix:semicolon
)brace
r_else
op_star
id|ppp-&gt;xhead
op_increment
op_assign
id|c
suffix:semicolon
id|ppp-&gt;fcs
op_assign
(paren
id|ppp-&gt;fcs
op_rshift
l_int|8
)paren
op_xor
id|fcstab
(braket
(paren
id|ppp-&gt;fcs
op_xor
id|c
)paren
op_amp
l_int|0xff
)braket
suffix:semicolon
)brace
multiline_comment|/* write a frame with NR chars from BUF to TTY&n;   we have to put the FCS field on ourselves&n;*/
r_static
r_int
DECL|function|ppp_write
id|ppp_write
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
comma
r_struct
id|file
op_star
id|file
comma
r_const
r_int
r_char
op_star
id|buf
comma
r_int
r_int
id|nr
)paren
(brace
r_struct
id|ppp
op_star
id|ppp
op_assign
id|ppp_find
c_func
(paren
id|tty
)paren
suffix:semicolon
r_int
id|i
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ppp
op_logical_or
id|ppp-&gt;magic
op_ne
id|PPP_MAGIC
)paren
(brace
id|PRINTKN
(paren
l_int|1
comma
(paren
id|KERN_ERR
l_string|&quot;ppp_write: cannot find ppp unit&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
id|CHECK_PPP
c_func
(paren
op_minus
id|ENXIO
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ppp-&gt;mtu
op_ne
id|ppp-&gt;dev-&gt;mtu
)paren
multiline_comment|/* Someone has been ifconfigging */
id|ppp_changedmtu
(paren
id|ppp
comma
id|ppp-&gt;dev-&gt;mtu
comma
id|ppp-&gt;mru
)paren
suffix:semicolon
r_if
c_cond
(paren
id|nr
OG
id|ppp-&gt;mtu
)paren
(brace
id|PRINTKN
(paren
l_int|1
comma
(paren
id|KERN_WARNING
l_string|&quot;ppp_write: truncating user packet from %u to mtu %d&bslash;n&quot;
comma
id|nr
comma
id|ppp-&gt;mtu
)paren
)paren
suffix:semicolon
id|nr
op_assign
id|ppp-&gt;mtu
suffix:semicolon
)brace
id|i
op_assign
id|verify_area
(paren
id|VERIFY_READ
comma
id|buf
comma
id|nr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
op_ne
l_int|0
)paren
r_return
id|i
suffix:semicolon
r_if
c_cond
(paren
id|ppp_debug
op_ge
l_int|3
)paren
id|ppp_print_buffer
(paren
l_string|&quot;write frame&quot;
comma
id|buf
comma
id|nr
comma
id|USER_DS
)paren
suffix:semicolon
multiline_comment|/* lock this PPP unit so we will be the only writer;&n;     sleep if necessary */
r_while
c_loop
(paren
(paren
id|ppp-&gt;sending
op_eq
l_int|1
)paren
op_logical_or
op_logical_neg
id|ppp_lock
c_func
(paren
id|ppp
)paren
)paren
(brace
id|current-&gt;timeout
op_assign
l_int|0
suffix:semicolon
id|PRINTKN
(paren
l_int|3
comma
(paren
id|KERN_DEBUG
l_string|&quot;ppp_write: sleeping&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|interruptible_sleep_on
c_func
(paren
op_amp
id|ppp-&gt;write_wait
)paren
suffix:semicolon
multiline_comment|/* Ensure that the ppp device is still attached. */
id|ppp
op_assign
id|ppp_find
c_func
(paren
id|tty
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ppp
op_logical_or
id|ppp-&gt;magic
op_ne
id|PPP_MAGIC
op_logical_or
op_logical_neg
id|ppp-&gt;inuse
)paren
r_return
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|current-&gt;signal
op_amp
op_complement
id|current-&gt;blocked
)paren
r_return
op_minus
id|EINTR
suffix:semicolon
)brace
multiline_comment|/* OK, locked.  Stuff the given bytes into the buffer. */
id|PRINTKN
c_func
(paren
l_int|4
comma
(paren
id|KERN_DEBUG
l_string|&quot;ppp_write: acquired write lock&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|ppp-&gt;xhead
op_assign
id|ppp-&gt;xbuff
suffix:semicolon
macro_line|#ifdef OPTIMIZE_FLAG_TIME
r_if
c_cond
(paren
id|jiffies
op_minus
id|ppp-&gt;last_xmit
OG
id|OPTIMIZE_FLAG_TIME
)paren
op_star
id|ppp-&gt;xhead
op_increment
op_assign
id|PPP_FLAG
suffix:semicolon
id|ppp-&gt;last_xmit
op_assign
id|jiffies
suffix:semicolon
macro_line|#else      
op_star
id|ppp-&gt;xhead
op_increment
op_assign
id|PPP_FLAG
suffix:semicolon
macro_line|#endif
id|ppp-&gt;fcs
op_assign
id|PPP_FCS_INIT
suffix:semicolon
id|i
op_assign
id|nr
suffix:semicolon
r_while
c_loop
(paren
id|i
op_decrement
OG
l_int|0
)paren
id|ppp_stuff_char
c_func
(paren
id|ppp
comma
id|get_user
c_func
(paren
id|buf
op_increment
)paren
)paren
suffix:semicolon
id|ppp_add_fcs
c_func
(paren
id|ppp
)paren
suffix:semicolon
multiline_comment|/* concatenate FCS at end */
op_star
id|ppp-&gt;xhead
op_increment
op_assign
id|PPP_FLAG
suffix:semicolon
multiline_comment|/* reset the time of the last write operation */
id|ppp-&gt;ddinfo.nip_sjiffies
op_assign
id|jiffies
suffix:semicolon
r_if
c_cond
(paren
id|ppp_debug
op_ge
l_int|6
)paren
id|ppp_print_buffer
(paren
l_string|&quot;xmit buffer&quot;
comma
id|ppp-&gt;xbuff
comma
id|ppp-&gt;xhead
op_minus
id|ppp-&gt;xbuff
comma
id|KERNEL_DS
)paren
suffix:semicolon
r_else
(brace
id|PRINTKN
(paren
l_int|4
comma
(paren
id|KERN_DEBUG
l_string|&quot;ppp_write: writing %d chars&bslash;n&quot;
comma
(paren
r_int
)paren
(paren
id|ppp-&gt;xhead
op_minus
id|ppp-&gt;xbuff
)paren
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/* packet is ready-to-go */
op_increment
id|ppp-&gt;stats.sothers
suffix:semicolon
id|ppp_kick_tty
c_func
(paren
id|ppp
)paren
suffix:semicolon
r_return
(paren
r_int
)paren
id|nr
suffix:semicolon
)brace
r_static
r_int
DECL|function|ppp_ioctl
id|ppp_ioctl
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
comma
r_struct
id|file
op_star
id|file
comma
r_int
r_int
id|i
comma
r_int
r_int
id|l
)paren
(brace
r_struct
id|ppp
op_star
id|ppp
op_assign
id|ppp_find
c_func
(paren
id|tty
)paren
suffix:semicolon
r_register
r_int
id|temp_i
op_assign
l_int|0
suffix:semicolon
r_int
id|error
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ppp
op_logical_or
id|ppp-&gt;magic
op_ne
id|PPP_MAGIC
)paren
(brace
id|PRINTK
(paren
(paren
id|KERN_ERR
l_string|&quot;ppp_ioctl: can&squot;t find PPP block from tty!&bslash;n&quot;
)paren
)paren
r_return
op_minus
id|EBADF
suffix:semicolon
)brace
id|CHECK_PPP
c_func
(paren
op_minus
id|ENXIO
)paren
suffix:semicolon
multiline_comment|/* This must be root user */
r_if
c_cond
(paren
op_logical_neg
id|suser
c_func
(paren
)paren
)paren
r_return
op_minus
id|EPERM
suffix:semicolon
r_switch
c_cond
(paren
id|i
)paren
(brace
r_case
id|PPPIOCSMRU
suffix:colon
id|error
op_assign
id|verify_area
(paren
id|VERIFY_READ
comma
(paren
r_void
op_star
)paren
id|l
comma
r_sizeof
(paren
id|temp_i
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
op_eq
l_int|0
)paren
(brace
id|temp_i
op_assign
id|get_user
(paren
(paren
r_int
op_star
)paren
id|l
)paren
suffix:semicolon
id|PRINTKN
(paren
l_int|3
comma
(paren
id|KERN_INFO
l_string|&quot;ppp_ioctl: set mru to %d&bslash;n&quot;
comma
id|temp_i
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ppp-&gt;mru
op_ne
id|temp_i
)paren
id|ppp_changedmtu
(paren
id|ppp
comma
id|ppp-&gt;dev-&gt;mtu
comma
id|temp_i
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|PPPIOCGFLAGS
suffix:colon
id|error
op_assign
id|verify_area
(paren
id|VERIFY_WRITE
comma
(paren
r_void
op_star
)paren
id|l
comma
r_sizeof
(paren
id|temp_i
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
op_eq
l_int|0
)paren
(brace
id|temp_i
op_assign
(paren
id|ppp-&gt;flags
op_amp
id|SC_MASK
)paren
suffix:semicolon
macro_line|#ifndef CHECK_CHARACTERS /* Don&squot;t generate errors if we don&squot;t check chars. */
id|temp_i
op_or_assign
id|SC_RCV_B7_1
op_or
id|SC_RCV_B7_0
op_or
id|SC_RCV_ODDP
op_or
id|SC_RCV_EVNP
suffix:semicolon
macro_line|#endif
id|put_user
(paren
id|temp_i
comma
(paren
r_int
op_star
)paren
id|l
)paren
suffix:semicolon
id|PRINTKN
(paren
l_int|3
comma
(paren
id|KERN_DEBUG
l_string|&quot;ppp_ioctl: get flags: addr %lx flags %x&bslash;n&quot;
comma
id|l
comma
id|temp_i
)paren
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|PPPIOCSFLAGS
suffix:colon
id|error
op_assign
id|verify_area
(paren
id|VERIFY_READ
comma
(paren
r_void
op_star
)paren
id|l
comma
r_sizeof
(paren
id|temp_i
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
op_eq
l_int|0
)paren
(brace
id|temp_i
op_assign
id|get_user
(paren
(paren
r_int
op_star
)paren
id|l
)paren
suffix:semicolon
id|ppp-&gt;flags
op_xor_assign
(paren
(paren
id|ppp-&gt;flags
op_xor
id|temp_i
)paren
op_amp
id|SC_MASK
)paren
suffix:semicolon
id|PRINTKN
(paren
l_int|3
comma
(paren
id|KERN_INFO
l_string|&quot;ppp_ioctl: set flags to %x&bslash;n&quot;
comma
id|temp_i
)paren
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|PPPIOCGASYNCMAP
suffix:colon
id|error
op_assign
id|verify_area
(paren
id|VERIFY_WRITE
comma
(paren
r_void
op_star
)paren
id|l
comma
r_sizeof
(paren
id|temp_i
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
op_eq
l_int|0
)paren
(brace
id|put_user
(paren
id|ppp-&gt;xmit_async_map
(braket
l_int|0
)braket
comma
(paren
r_int
op_star
)paren
id|l
)paren
suffix:semicolon
id|PRINTKN
(paren
l_int|3
comma
(paren
id|KERN_INFO
l_string|&quot;ppp_ioctl: get asyncmap: addr %lx asyncmap %lx&bslash;n&quot;
comma
id|l
comma
(paren
r_int
r_int
)paren
id|ppp-&gt;xmit_async_map
(braket
l_int|0
)braket
)paren
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|PPPIOCSASYNCMAP
suffix:colon
id|error
op_assign
id|verify_area
(paren
id|VERIFY_READ
comma
(paren
r_void
op_star
)paren
id|l
comma
r_sizeof
(paren
id|temp_i
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
op_eq
l_int|0
)paren
(brace
id|ppp-&gt;xmit_async_map
(braket
l_int|0
)braket
op_assign
id|get_user
(paren
(paren
r_int
op_star
)paren
id|l
)paren
suffix:semicolon
id|bset
(paren
id|ppp-&gt;xmit_async_map
comma
id|PPP_FLAG
)paren
suffix:semicolon
id|bset
(paren
id|ppp-&gt;xmit_async_map
comma
id|PPP_ESC
)paren
suffix:semicolon
id|PRINTKN
(paren
l_int|3
comma
(paren
id|KERN_INFO
l_string|&quot;ppp_ioctl: set xmit asyncmap %lx&bslash;n&quot;
comma
(paren
r_int
r_int
)paren
id|ppp-&gt;xmit_async_map
(braket
l_int|0
)braket
)paren
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|PPPIOCRASYNCMAP
suffix:colon
id|error
op_assign
id|verify_area
(paren
id|VERIFY_READ
comma
(paren
r_void
op_star
)paren
id|l
comma
r_sizeof
(paren
id|temp_i
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
op_eq
l_int|0
)paren
(brace
id|ppp-&gt;recv_async_map
op_assign
id|get_user
(paren
(paren
r_int
op_star
)paren
id|l
)paren
suffix:semicolon
id|PRINTKN
(paren
l_int|3
comma
(paren
id|KERN_INFO
l_string|&quot;ppp_ioctl: set recv asyncmap %lx&bslash;n&quot;
comma
(paren
r_int
r_int
)paren
id|ppp-&gt;recv_async_map
)paren
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|PPPIOCGUNIT
suffix:colon
id|error
op_assign
id|verify_area
(paren
id|VERIFY_WRITE
comma
(paren
r_void
op_star
)paren
id|l
comma
r_sizeof
(paren
id|temp_i
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
op_eq
l_int|0
)paren
(brace
id|put_user
(paren
id|ppp-&gt;dev-&gt;base_addr
comma
(paren
r_int
op_star
)paren
id|l
)paren
suffix:semicolon
id|PRINTKN
(paren
l_int|3
comma
(paren
id|KERN_INFO
l_string|&quot;ppp_ioctl: get unit: %ld&quot;
comma
id|ppp-&gt;dev-&gt;base_addr
)paren
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|PPPIOCSINPSIG
suffix:colon
id|error
op_assign
id|verify_area
(paren
id|VERIFY_READ
comma
(paren
r_void
op_star
)paren
id|l
comma
r_sizeof
(paren
id|temp_i
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
op_eq
l_int|0
)paren
(brace
id|ppp-&gt;inp_sig
op_assign
id|get_user
(paren
(paren
r_int
op_star
)paren
id|l
)paren
suffix:semicolon
id|ppp-&gt;inp_sig_pid
op_assign
id|current-&gt;pid
suffix:semicolon
id|PRINTKN
(paren
l_int|3
comma
(paren
id|KERN_INFO
l_string|&quot;ppp_ioctl: set input signal %d&bslash;n&quot;
comma
id|ppp-&gt;inp_sig
)paren
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|PPPIOCSDEBUG
suffix:colon
id|error
op_assign
id|verify_area
(paren
id|VERIFY_READ
comma
(paren
r_void
op_star
)paren
id|l
comma
r_sizeof
(paren
id|temp_i
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
op_eq
l_int|0
)paren
(brace
id|ppp_debug
op_assign
id|get_user
(paren
(paren
r_int
op_star
)paren
id|l
)paren
suffix:semicolon
id|ppp_debug_netpackets
op_assign
(paren
id|ppp_debug
op_amp
l_int|0xff00
)paren
op_rshift
l_int|8
suffix:semicolon
id|ppp_debug
op_and_assign
l_int|0xff
suffix:semicolon
id|PRINTKN
(paren
l_int|1
comma
(paren
id|KERN_INFO
l_string|&quot;ppp_ioctl: set debug level %d, netpacket %d&bslash;n&quot;
comma
id|ppp_debug
comma
id|ppp_debug_netpackets
)paren
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|PPPIOCGDEBUG
suffix:colon
id|error
op_assign
id|verify_area
(paren
id|VERIFY_WRITE
comma
(paren
r_void
op_star
)paren
id|l
comma
r_sizeof
(paren
id|temp_i
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
op_eq
l_int|0
)paren
(brace
id|put_user
(paren
(paren
r_int
)paren
(paren
id|ppp_debug
op_or
(paren
id|ppp_debug_netpackets
op_lshift
l_int|8
)paren
)paren
comma
(paren
r_int
op_star
)paren
id|l
)paren
suffix:semicolon
id|PRINTKN
(paren
l_int|3
comma
(paren
id|KERN_INFO
l_string|&quot;ppp_ioctl: get debug level %d&bslash;n&quot;
comma
id|ppp_debug
op_or
(paren
id|ppp_debug_netpackets
op_lshift
l_int|8
)paren
)paren
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|PPPIOCGSTAT
suffix:colon
id|error
op_assign
id|verify_area
(paren
id|VERIFY_WRITE
comma
(paren
r_void
op_star
)paren
id|l
comma
r_sizeof
(paren
r_struct
id|ppp_stats
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
op_eq
l_int|0
)paren
(brace
id|memcpy_tofs
(paren
(paren
r_void
op_star
)paren
id|l
comma
op_amp
id|ppp-&gt;stats
comma
r_sizeof
(paren
r_struct
id|ppp_stats
)paren
)paren
suffix:semicolon
id|PRINTKN
(paren
l_int|3
comma
(paren
id|KERN_INFO
l_string|&quot;ppp_ioctl: read statistics&bslash;n&quot;
)paren
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|PPPIOCGTIME
suffix:colon
id|error
op_assign
id|verify_area
(paren
id|VERIFY_WRITE
comma
(paren
r_void
op_star
)paren
id|l
comma
r_sizeof
(paren
r_struct
id|ppp_ddinfo
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
op_eq
l_int|0
)paren
(brace
r_struct
id|ppp_ddinfo
id|cur_ddinfo
suffix:semicolon
r_int
r_int
id|cur_jiffies
op_assign
id|jiffies
suffix:semicolon
multiline_comment|/* change absolute times to relative times. */
id|cur_ddinfo.ip_sjiffies
op_assign
id|cur_jiffies
op_minus
id|ppp-&gt;ddinfo.ip_sjiffies
suffix:semicolon
id|cur_ddinfo.ip_rjiffies
op_assign
id|cur_jiffies
op_minus
id|ppp-&gt;ddinfo.ip_rjiffies
suffix:semicolon
id|cur_ddinfo.nip_sjiffies
op_assign
id|cur_jiffies
op_minus
id|ppp-&gt;ddinfo.nip_sjiffies
suffix:semicolon
id|cur_ddinfo.nip_rjiffies
op_assign
id|cur_jiffies
op_minus
id|ppp-&gt;ddinfo.nip_rjiffies
suffix:semicolon
id|memcpy_tofs
(paren
(paren
r_void
op_star
)paren
id|l
comma
op_amp
id|cur_ddinfo
comma
r_sizeof
(paren
r_struct
id|ppp_ddinfo
)paren
)paren
suffix:semicolon
id|PRINTKN
(paren
l_int|3
comma
(paren
id|KERN_INFO
l_string|&quot;ppp_ioctl: read demand dial info&bslash;n&quot;
)paren
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|PPPIOCGXASYNCMAP
suffix:colon
id|error
op_assign
id|verify_area
(paren
id|VERIFY_WRITE
comma
(paren
r_void
op_star
)paren
id|l
comma
r_sizeof
(paren
id|ppp-&gt;xmit_async_map
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
op_eq
l_int|0
)paren
(brace
id|memcpy_tofs
(paren
(paren
r_void
op_star
)paren
id|l
comma
id|ppp-&gt;xmit_async_map
comma
r_sizeof
(paren
id|ppp-&gt;xmit_async_map
)paren
)paren
suffix:semicolon
id|PRINTKN
(paren
l_int|3
comma
(paren
id|KERN_INFO
l_string|&quot;ppp_ioctl: get xasyncmap: addr %lx&bslash;n&quot;
comma
id|l
)paren
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|PPPIOCSXASYNCMAP
suffix:colon
id|error
op_assign
id|verify_area
(paren
id|VERIFY_READ
comma
(paren
r_void
op_star
)paren
id|l
comma
r_sizeof
(paren
id|ppp-&gt;xmit_async_map
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
op_eq
l_int|0
)paren
(brace
id|__u32
id|temp_tbl
(braket
l_int|8
)braket
suffix:semicolon
id|memcpy_fromfs
(paren
id|temp_tbl
comma
(paren
r_void
op_star
)paren
id|l
comma
r_sizeof
(paren
id|ppp-&gt;xmit_async_map
)paren
)paren
suffix:semicolon
id|temp_tbl
(braket
l_int|1
)braket
op_assign
l_int|0x00000000
suffix:semicolon
multiline_comment|/* must not escape 0x20 - 0x3f */
id|temp_tbl
(braket
l_int|2
)braket
op_and_assign
op_complement
l_int|0x40000000
suffix:semicolon
multiline_comment|/* must not escape 0x5e        */
id|temp_tbl
(braket
l_int|3
)braket
op_or_assign
l_int|0x60000000
suffix:semicolon
multiline_comment|/* must escape 0x7d and 0x7e   */
r_if
c_cond
(paren
(paren
id|temp_tbl
(braket
l_int|2
)braket
op_amp
id|temp_tbl
(braket
l_int|3
)braket
)paren
op_ne
l_int|0
op_logical_or
(paren
id|temp_tbl
(braket
l_int|4
)braket
op_amp
id|temp_tbl
(braket
l_int|5
)braket
)paren
op_ne
l_int|0
op_logical_or
(paren
id|temp_tbl
(braket
l_int|6
)braket
op_amp
id|temp_tbl
(braket
l_int|7
)braket
)paren
op_ne
l_int|0
)paren
id|error
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_else
(brace
id|memcpy
(paren
id|ppp-&gt;xmit_async_map
comma
id|temp_tbl
comma
r_sizeof
(paren
id|ppp-&gt;xmit_async_map
)paren
)paren
suffix:semicolon
id|PRINTKN
(paren
l_int|3
comma
(paren
id|KERN_INFO
l_string|&quot;ppp_ioctl: set xasyncmap&bslash;n&quot;
)paren
)paren
suffix:semicolon
)brace
)brace
r_break
suffix:semicolon
r_case
id|PPPIOCSMAXCID
suffix:colon
id|error
op_assign
id|verify_area
(paren
id|VERIFY_READ
comma
(paren
r_void
op_star
)paren
id|l
comma
r_sizeof
(paren
id|temp_i
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
op_eq
l_int|0
)paren
(brace
id|temp_i
op_assign
id|get_user
(paren
(paren
r_int
op_star
)paren
id|l
)paren
op_plus
l_int|1
suffix:semicolon
id|PRINTKN
(paren
l_int|3
comma
(paren
id|KERN_INFO
l_string|&quot;ppp_ioctl: set maxcid to %d&bslash;n&quot;
comma
id|temp_i
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ppp-&gt;slcomp
op_ne
l_int|NULL
)paren
id|slhc_free
(paren
id|ppp-&gt;slcomp
)paren
suffix:semicolon
id|ppp-&gt;slcomp
op_assign
id|slhc_init
(paren
id|temp_i
comma
id|temp_i
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ppp-&gt;slcomp
op_eq
l_int|NULL
)paren
(brace
id|PRINTKN
(paren
l_int|1
comma
(paren
id|KERN_ERR
l_string|&quot;ppp: no space for compression buffers!&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|ppp_release
(paren
id|ppp
)paren
suffix:semicolon
id|error
op_assign
op_minus
id|ENOMEM
suffix:semicolon
)brace
)brace
r_break
suffix:semicolon
macro_line|#ifdef NEW_TTY_DRIVERS
multiline_comment|/* Allow stty to read, but not set, the serial port */
r_case
id|TCGETS
suffix:colon
r_case
id|TCGETA
suffix:colon
id|error
op_assign
id|n_tty_ioctl
c_func
(paren
id|tty
comma
id|file
comma
id|i
comma
id|l
)paren
suffix:semicolon
r_break
suffix:semicolon
macro_line|#endif
multiline_comment|/*&n; *  All other ioctl() events will come here.&n; */
r_default
suffix:colon
id|PRINTKN
(paren
l_int|1
comma
(paren
id|KERN_ERR
l_string|&quot;ppp_ioctl: invalid ioctl: %x, addr %lx&bslash;n&quot;
comma
id|i
comma
id|l
)paren
)paren
suffix:semicolon
macro_line|#ifdef NEW_TTY_DRIVERS
id|error
op_assign
op_minus
id|ENOIOCTLCMD
suffix:semicolon
macro_line|#else
id|error
op_assign
op_minus
id|EINVAL
suffix:semicolon
macro_line|#endif
r_break
suffix:semicolon
)brace
r_return
id|error
suffix:semicolon
)brace
r_static
r_int
DECL|function|ppp_select
id|ppp_select
(paren
r_struct
id|tty_struct
op_star
id|tty
comma
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|filp
comma
r_int
id|sel_type
comma
id|select_table
op_star
id|wait
)paren
(brace
r_struct
id|ppp
op_star
id|ppp
op_assign
id|ppp_find
(paren
id|tty
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ppp
op_logical_or
id|ppp-&gt;magic
op_ne
id|PPP_MAGIC
)paren
(brace
id|PRINTK
(paren
(paren
id|KERN_ERR
l_string|&quot;ppp_select: can&squot;t find PPP block from tty!&bslash;n&quot;
)paren
)paren
r_return
op_minus
id|EBADF
suffix:semicolon
)brace
multiline_comment|/* If the PPP protocol is no longer active, return false */
id|CHECK_PPP
(paren
l_int|0
)paren
suffix:semicolon
multiline_comment|/* Process the request based upon the type desired */
r_switch
c_cond
(paren
id|sel_type
)paren
(brace
r_case
id|SEL_IN
suffix:colon
r_if
c_cond
(paren
id|set_bit
c_func
(paren
l_int|0
comma
op_amp
id|ppp-&gt;us_rbuff_lock
)paren
op_eq
l_int|0
)paren
(brace
multiline_comment|/* Test for the presence of data in the queue */
r_if
c_cond
(paren
id|ppp-&gt;us_rbuff_head
op_ne
id|ppp-&gt;us_rbuff_tail
)paren
(brace
id|clear_bit
(paren
l_int|0
comma
op_amp
id|ppp-&gt;us_rbuff_lock
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
id|clear_bit
(paren
l_int|0
comma
op_amp
id|ppp-&gt;us_rbuff_lock
)paren
suffix:semicolon
)brace
multiline_comment|/* fall through */
r_case
id|SEL_EX
suffix:colon
multiline_comment|/* Is there a pending error condition? */
r_if
c_cond
(paren
id|tty-&gt;packet
op_logical_and
id|tty-&gt;link-&gt;ctrl_status
)paren
r_return
l_int|1
suffix:semicolon
multiline_comment|/* closed? */
r_if
c_cond
(paren
id|tty-&gt;flags
op_amp
(paren
l_int|1
op_lshift
id|TTY_SLAVE_CLOSED
)paren
)paren
r_return
l_int|1
suffix:semicolon
multiline_comment|/* If the tty is disconnected, then this is an exception too */
r_if
c_cond
(paren
id|tty_hung_up_p
c_func
(paren
id|filp
)paren
)paren
r_return
l_int|1
suffix:semicolon
id|select_wait
(paren
op_amp
id|ppp-&gt;read_wait
comma
id|wait
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SEL_OUT
suffix:colon
r_if
c_cond
(paren
id|ppp_lock
(paren
id|ppp
)paren
)paren
(brace
r_if
c_cond
(paren
id|ppp-&gt;sending
op_eq
l_int|0
)paren
(brace
id|ppp_unlock
(paren
id|ppp
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
id|ppp_unlock
(paren
id|ppp
)paren
suffix:semicolon
)brace
id|select_wait
(paren
op_amp
id|ppp-&gt;write_wait
comma
id|wait
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*************************************************************&n; * NETWORK OUTPUT&n; *    This routine accepts requests from the network layer&n; *    and attempts to deliver the packets.&n; *    It also includes various routines we are compelled to&n; *    have to make the network layer work (arp, etc...).&n; *************************************************************/
r_int
DECL|function|ppp_xmit
id|ppp_xmit
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|device
op_star
id|dev
)paren
(brace
r_struct
id|tty_struct
op_star
id|tty
suffix:semicolon
r_struct
id|ppp
op_star
id|ppp
suffix:semicolon
r_int
r_char
op_star
id|p
suffix:semicolon
r_int
r_int
id|proto
suffix:semicolon
r_int
id|len
suffix:semicolon
multiline_comment|/* just a little sanity check. */
r_if
c_cond
(paren
id|skb
op_eq
l_int|NULL
)paren
(brace
id|PRINTKN
c_func
(paren
l_int|3
comma
(paren
id|KERN_WARNING
l_string|&quot;ppp_xmit: null packet!&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Get pointers to the various components */
id|ppp
op_assign
op_amp
id|ppp_ctrl
(braket
id|dev-&gt;base_addr
)braket
suffix:semicolon
id|tty
op_assign
id|ppp-&gt;tty
suffix:semicolon
id|p
op_assign
id|skb-&gt;data
suffix:semicolon
id|len
op_assign
id|skb-&gt;len
suffix:semicolon
id|proto
op_assign
id|PROTO_IP
suffix:semicolon
id|PRINTKN
c_func
(paren
l_int|4
comma
(paren
id|KERN_DEBUG
l_string|&quot;ppp_xmit [%s]: skb %lX busy %d&bslash;n&quot;
comma
id|dev-&gt;name
comma
(paren
r_int
r_int
r_int
)paren
id|skb
comma
id|ppp-&gt;sending
)paren
)paren
suffix:semicolon
multiline_comment|/* avoid race conditions when the link fails */
r_if
c_cond
(paren
op_logical_neg
id|ppp-&gt;inuse
)paren
(brace
id|dev_kfree_skb
c_func
(paren
id|skb
comma
id|FREE_WRITE
)paren
suffix:semicolon
id|dev_close
(paren
id|dev
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|tty
op_eq
l_int|NULL
)paren
(brace
id|PRINTKN
c_func
(paren
l_int|1
comma
(paren
id|KERN_ERR
l_string|&quot;ppp_xmit: %s not connected to a TTY!&bslash;n&quot;
comma
id|dev-&gt;name
)paren
)paren
suffix:semicolon
r_goto
id|done
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|dev-&gt;flags
op_amp
id|IFF_UP
)paren
)paren
(brace
id|PRINTKN
c_func
(paren
l_int|1
comma
(paren
id|KERN_WARNING
l_string|&quot;ppp_xmit: packet sent on interface %s, which is down for IP&bslash;n&quot;
comma
id|dev-&gt;name
)paren
)paren
suffix:semicolon
r_goto
id|done
suffix:semicolon
)brace
macro_line|#ifdef CURED_AGES_AGO
multiline_comment|/* get length from IP header as per Alan Cox bugfix for slip.c */
r_if
c_cond
(paren
id|len
OL
r_sizeof
(paren
r_struct
id|iphdr
)paren
)paren
(brace
id|PRINTKN
c_func
(paren
l_int|0
comma
(paren
id|KERN_ERR
l_string|&quot;ppp_xmit: given runt packet, ignoring&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_goto
id|done
suffix:semicolon
)brace
id|len
op_assign
id|ntohs
c_func
(paren
(paren
(paren
r_struct
id|iphdr
op_star
)paren
(paren
id|skb-&gt;data
)paren
)paren
op_member_access_from_pointer
id|tot_len
)paren
suffix:semicolon
macro_line|#endif  
multiline_comment|/* If doing demand dial then divert the first frame to pppd. */
r_if
c_cond
(paren
id|ppp-&gt;flags
op_amp
id|SC_IP_DOWN
)paren
(brace
r_if
c_cond
(paren
(paren
id|ppp-&gt;flags
op_amp
id|SC_IP_FLUSH
)paren
op_eq
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|ppp_us_queue
(paren
id|ppp
comma
id|proto
comma
id|p
comma
id|len
)paren
)paren
id|ppp-&gt;flags
op_or_assign
id|SC_IP_FLUSH
suffix:semicolon
)brace
r_goto
id|done
suffix:semicolon
)brace
multiline_comment|/* Attempt to acquire send lock */
r_if
c_cond
(paren
id|ppp-&gt;sending
op_logical_or
op_logical_neg
id|ppp_lock
c_func
(paren
id|ppp
)paren
)paren
(brace
id|PRINTKN
c_func
(paren
l_int|3
comma
(paren
id|KERN_WARNING
l_string|&quot;ppp_xmit: busy&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|ppp-&gt;stats.sbusy
op_increment
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
id|ppp-&gt;xhead
op_assign
id|ppp-&gt;xbuff
suffix:semicolon
multiline_comment|/* try to compress, if VJ compression mode is on */
r_if
c_cond
(paren
id|ppp-&gt;flags
op_amp
id|SC_COMP_TCP
)paren
(brace
id|len
op_assign
id|slhc_compress
c_func
(paren
id|ppp-&gt;slcomp
comma
id|p
comma
id|len
comma
id|ppp-&gt;cbuff
comma
op_amp
id|p
comma
op_logical_neg
(paren
id|ppp-&gt;flags
op_amp
id|SC_NO_TCP_CCID
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|p
(braket
l_int|0
)braket
op_amp
id|SL_TYPE_COMPRESSED_TCP
)paren
id|proto
op_assign
id|PROTO_VJCOMP
suffix:semicolon
r_else
(brace
r_if
c_cond
(paren
id|p
(braket
l_int|0
)braket
op_ge
id|SL_TYPE_UNCOMPRESSED_TCP
)paren
(brace
id|proto
op_assign
id|PROTO_VJUNCOMP
suffix:semicolon
id|p
(braket
l_int|0
)braket
op_assign
(paren
id|p
(braket
l_int|0
)braket
op_amp
l_int|0x0f
)paren
op_or
l_int|0x40
suffix:semicolon
)brace
)brace
)brace
multiline_comment|/* increment appropriate counter */
r_if
c_cond
(paren
id|proto
op_eq
id|PROTO_VJCOMP
)paren
op_increment
id|ppp-&gt;stats.scomp
suffix:semicolon
r_else
op_increment
id|ppp-&gt;stats.suncomp
suffix:semicolon
r_if
c_cond
(paren
id|ppp_debug_netpackets
)paren
(brace
r_struct
id|iphdr
op_star
id|iph
op_assign
(paren
r_struct
id|iphdr
op_star
)paren
id|skb-&gt;data
suffix:semicolon
id|PRINTK
(paren
(paren
id|KERN_DEBUG
l_string|&quot;%s ==&gt; proto %x len %d src %x dst %x proto %d&bslash;n&quot;
comma
id|dev-&gt;name
comma
(paren
r_int
)paren
id|proto
comma
(paren
r_int
)paren
id|len
comma
(paren
r_int
)paren
id|iph-&gt;saddr
comma
(paren
r_int
)paren
id|iph-&gt;daddr
comma
(paren
r_int
)paren
id|iph-&gt;protocol
)paren
)paren
)brace
multiline_comment|/* start of frame:   FLAG  ALL_STATIONS  CONTROL  &lt;protohi&gt; &lt;protolo&gt; */
macro_line|#ifdef OPTIMIZE_FLAG_TIME
r_if
c_cond
(paren
id|jiffies
op_minus
id|ppp-&gt;last_xmit
OG
id|OPTIMIZE_FLAG_TIME
)paren
op_star
id|ppp-&gt;xhead
op_increment
op_assign
id|PPP_FLAG
suffix:semicolon
id|ppp-&gt;last_xmit
op_assign
id|jiffies
suffix:semicolon
macro_line|#else      
op_star
id|ppp-&gt;xhead
op_increment
op_assign
id|PPP_FLAG
suffix:semicolon
macro_line|#endif
id|ppp-&gt;fcs
op_assign
id|PPP_FCS_INIT
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|ppp-&gt;flags
op_amp
id|SC_COMP_AC
)paren
)paren
(brace
id|ppp_stuff_char
c_func
(paren
id|ppp
comma
id|PPP_ADDRESS
)paren
suffix:semicolon
id|ppp_stuff_char
c_func
(paren
id|ppp
comma
id|PPP_CONTROL
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|ppp-&gt;flags
op_amp
id|SC_COMP_PROT
)paren
op_logical_or
(paren
id|proto
op_amp
l_int|0xff00
)paren
)paren
id|ppp_stuff_char
c_func
(paren
id|ppp
comma
id|proto
op_rshift
l_int|8
)paren
suffix:semicolon
id|ppp_stuff_char
c_func
(paren
id|ppp
comma
id|proto
op_amp
l_int|0xff
)paren
suffix:semicolon
multiline_comment|/* data part */
r_while
c_loop
(paren
id|len
op_decrement
OG
l_int|0
)paren
id|ppp_stuff_char
c_func
(paren
id|ppp
comma
op_star
id|p
op_increment
)paren
suffix:semicolon
multiline_comment|/* fcs and flag */
id|ppp_add_fcs
c_func
(paren
id|ppp
)paren
suffix:semicolon
op_star
id|ppp-&gt;xhead
op_increment
op_assign
id|PPP_FLAG
suffix:semicolon
multiline_comment|/* update the time for demand dial function */
id|ppp-&gt;ddinfo.ip_sjiffies
op_assign
id|jiffies
suffix:semicolon
multiline_comment|/* send it! */
r_if
c_cond
(paren
id|ppp_debug
op_ge
l_int|6
)paren
id|ppp_print_buffer
(paren
l_string|&quot;xmit buffer&quot;
comma
id|ppp-&gt;xbuff
comma
id|ppp-&gt;xhead
op_minus
id|ppp-&gt;xbuff
comma
id|KERNEL_DS
)paren
suffix:semicolon
r_else
(brace
id|PRINTKN
(paren
l_int|4
comma
(paren
id|KERN_DEBUG
l_string|&quot;ppp_write: writing %d chars&bslash;n&quot;
comma
(paren
r_int
)paren
(paren
id|ppp-&gt;xhead
op_minus
id|ppp-&gt;xbuff
)paren
)paren
)paren
suffix:semicolon
)brace
id|ppp_kick_tty
c_func
(paren
id|ppp
)paren
suffix:semicolon
id|done
suffix:colon
id|dev_kfree_skb
c_func
(paren
id|skb
comma
id|FREE_WRITE
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#ifdef NET02D
r_static
r_int
DECL|function|ppp_header
id|ppp_header
c_func
(paren
r_int
r_char
op_star
id|buff
comma
r_struct
id|device
op_star
id|dev
comma
r_int
r_int
id|type
comma
r_int
r_int
id|daddr
comma
r_int
r_int
id|saddr
comma
r_int
id|len
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_int
DECL|function|ppp_rebuild_header
id|ppp_rebuild_header
c_func
(paren
r_void
op_star
id|buff
comma
r_struct
id|device
op_star
id|dev
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_void
DECL|function|ppp_add_arp
id|ppp_add_arp
c_func
(paren
r_int
r_int
id|addr
comma
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|device
op_star
id|dev
)paren
(brace
)brace
macro_line|#else
r_static
r_int
DECL|function|ppp_header
id|ppp_header
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|device
op_star
id|dev
comma
r_int
r_int
id|type
comma
r_void
op_star
id|daddr
comma
r_void
op_star
id|saddr
comma
r_int
id|len
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_int
DECL|function|ppp_rebuild_header
id|ppp_rebuild_header
c_func
(paren
r_void
op_star
id|buff
comma
r_struct
id|device
op_star
id|dev
comma
r_int
r_int
id|raddr
comma
r_struct
id|sk_buff
op_star
id|skb
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#endif
r_static
r_struct
id|enet_statistics
op_star
DECL|function|ppp_get_stats
id|ppp_get_stats
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
r_struct
id|ppp
op_star
id|ppp
op_assign
op_amp
id|ppp_ctrl
(braket
id|dev-&gt;base_addr
)braket
suffix:semicolon
r_static
r_struct
id|enet_statistics
id|ppp_stats
suffix:semicolon
id|ppp_stats.rx_packets
op_assign
id|ppp-&gt;stats.rcomp
op_plus
id|ppp-&gt;stats.runcomp
suffix:semicolon
id|ppp_stats.rx_errors
op_assign
id|ppp-&gt;stats.rerrors
suffix:semicolon
id|ppp_stats.rx_dropped
op_assign
id|ppp-&gt;stats.tossed
suffix:semicolon
id|ppp_stats.rx_fifo_errors
op_assign
l_int|0
suffix:semicolon
id|ppp_stats.rx_length_errors
op_assign
id|ppp-&gt;stats.runts
suffix:semicolon
id|ppp_stats.rx_over_errors
op_assign
id|ppp-&gt;stats.roverrun
suffix:semicolon
id|ppp_stats.rx_crc_errors
op_assign
l_int|0
suffix:semicolon
id|ppp_stats.rx_frame_errors
op_assign
l_int|0
suffix:semicolon
id|ppp_stats.tx_packets
op_assign
id|ppp-&gt;stats.scomp
op_plus
id|ppp-&gt;stats.suncomp
suffix:semicolon
id|ppp_stats.tx_errors
op_assign
id|ppp-&gt;stats.serrors
suffix:semicolon
id|ppp_stats.tx_dropped
op_assign
l_int|0
suffix:semicolon
id|ppp_stats.tx_fifo_errors
op_assign
l_int|0
suffix:semicolon
id|ppp_stats.collisions
op_assign
id|ppp-&gt;stats.sbusy
suffix:semicolon
id|ppp_stats.tx_carrier_errors
op_assign
l_int|0
suffix:semicolon
id|ppp_stats.tx_aborted_errors
op_assign
l_int|0
suffix:semicolon
id|ppp_stats.tx_window_errors
op_assign
l_int|0
suffix:semicolon
id|ppp_stats.tx_heartbeat_errors
op_assign
l_int|0
suffix:semicolon
id|PRINTKN
(paren
l_int|3
comma
(paren
id|KERN_INFO
l_string|&quot;ppp_get_stats called&quot;
)paren
)paren
suffix:semicolon
r_return
op_amp
id|ppp_stats
suffix:semicolon
)brace
multiline_comment|/*************************************************************&n; * UTILITIES&n; *    Miscellany called by various functions above.&n; *************************************************************/
macro_line|#ifndef NEW_TTY_DRIVERS
multiline_comment|/* find a PPP channel given a TTY */
r_struct
id|ppp
op_star
DECL|function|ppp_find
id|ppp_find
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
)paren
(brace
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|PPP_NRUNIT
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
id|ppp_ctrl
(braket
id|i
)braket
dot
id|inuse
op_logical_and
(paren
id|ppp_ctrl
(braket
id|i
)braket
dot
id|tty
op_eq
id|tty
)paren
)paren
r_return
op_amp
id|ppp_ctrl
(braket
id|i
)braket
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
macro_line|#endif
multiline_comment|/* allocate a PPP channel */
r_static
r_struct
id|ppp
op_star
DECL|function|ppp_alloc
id|ppp_alloc
c_func
(paren
r_void
)paren
(brace
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|PPP_NRUNIT
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
op_logical_neg
id|set_bit
c_func
(paren
l_int|0
comma
op_amp
id|ppp_ctrl
(braket
id|i
)braket
dot
id|inuse
)paren
)paren
r_return
op_amp
id|ppp_ctrl
(braket
id|i
)braket
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
multiline_comment|/* marks a PPP interface &squot;busy&squot;.  user processes will wait, if&n;   they try to write, and the network code will refrain from sending&n;   return nonzero if succeeded in acquiring lock&n;*/
r_static
r_int
DECL|function|ppp_lock
id|ppp_lock
c_func
(paren
r_struct
id|ppp
op_star
id|ppp
)paren
(brace
r_int
id|flags
comma
id|locked
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|locked
op_assign
id|ppp-&gt;sending
suffix:semicolon
id|ppp-&gt;sending
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|ppp-&gt;dev-&gt;flags
op_amp
id|IFF_UP
)paren
id|ppp-&gt;dev-&gt;tbusy
op_assign
l_int|1
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
id|locked
op_eq
l_int|0
suffix:semicolon
)brace
r_static
r_void
DECL|function|ppp_unlock
id|ppp_unlock
c_func
(paren
r_struct
id|ppp
op_star
id|ppp
)paren
(brace
r_int
id|flags
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|ppp-&gt;sending
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|ppp-&gt;dev-&gt;flags
op_amp
id|IFF_UP
)paren
id|ppp-&gt;dev-&gt;tbusy
op_assign
l_int|0
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
multiline_comment|/* FCS support functions */
r_static
r_void
DECL|function|ppp_add_fcs
id|ppp_add_fcs
c_func
(paren
r_struct
id|ppp
op_star
id|ppp
)paren
(brace
r_int
r_int
id|fcs
op_assign
id|ppp-&gt;fcs
suffix:semicolon
id|fcs
op_xor_assign
l_int|0xffff
suffix:semicolon
id|ppp_stuff_char
c_func
(paren
id|ppp
comma
id|fcs
op_amp
l_int|0x00ff
)paren
suffix:semicolon
id|ppp_stuff_char
c_func
(paren
id|ppp
comma
(paren
id|fcs
op_amp
l_int|0xff00
)paren
op_rshift
l_int|8
)paren
suffix:semicolon
id|ASSERT
(paren
id|ppp-&gt;fcs
op_eq
id|PPP_FCS_GOOD
)paren
suffix:semicolon
id|PRINTKN
(paren
l_int|4
comma
(paren
id|KERN_DEBUG
l_string|&quot;ppp_add_fcs: fcs is %lx&bslash;n&quot;
comma
(paren
r_int
)paren
(paren
r_int
r_int
)paren
id|fcs
)paren
)paren
suffix:semicolon
)brace
r_static
r_int
DECL|function|ppp_check_fcs
id|ppp_check_fcs
c_func
(paren
r_struct
id|ppp
op_star
id|ppp
)paren
(brace
r_int
r_int
id|fcs
op_assign
id|PPP_FCS_INIT
comma
id|msgfcs
suffix:semicolon
r_int
r_char
op_star
id|c
op_assign
id|ppp-&gt;rbuff
suffix:semicolon
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|ppp-&gt;rcount
op_minus
l_int|2
suffix:semicolon
id|i
op_increment
comma
id|c
op_increment
)paren
id|fcs
op_assign
(paren
id|fcs
op_rshift
l_int|8
)paren
op_xor
id|fcstab
(braket
(paren
id|fcs
op_xor
op_star
id|c
)paren
op_amp
l_int|0xff
)braket
suffix:semicolon
id|fcs
op_xor_assign
l_int|0xffff
suffix:semicolon
id|msgfcs
op_assign
(paren
id|c
(braket
l_int|1
)braket
op_lshift
l_int|8
)paren
op_plus
id|c
(braket
l_int|0
)braket
suffix:semicolon
id|PRINTKN
(paren
l_int|4
comma
(paren
id|KERN_INFO
l_string|&quot;ppp_check_fcs: got %lx want %lx&bslash;n&quot;
comma
(paren
r_int
r_int
)paren
id|msgfcs
comma
(paren
r_int
r_int
)paren
id|fcs
)paren
)paren
suffix:semicolon
r_return
id|fcs
op_eq
id|msgfcs
suffix:semicolon
)brace
DECL|variable|hex
r_static
r_char
id|hex
(braket
)braket
op_assign
l_string|&quot;0123456789ABCDEF&quot;
suffix:semicolon
DECL|function|ppp_print_hex
r_static
r_inline
r_void
id|ppp_print_hex
(paren
r_register
r_char
op_star
id|out
comma
r_const
r_char
op_star
id|in
comma
r_int
id|count
)paren
(brace
r_register
r_int
r_char
id|next_ch
suffix:semicolon
r_while
c_loop
(paren
id|count
op_decrement
OG
l_int|0
)paren
(brace
id|next_ch
op_assign
(paren
r_int
r_char
)paren
id|get_user
(paren
id|in
)paren
suffix:semicolon
op_star
id|out
op_increment
op_assign
id|hex
(braket
(paren
id|next_ch
op_rshift
l_int|4
)paren
op_amp
l_int|0x0F
)braket
suffix:semicolon
op_star
id|out
op_increment
op_assign
id|hex
(braket
id|next_ch
op_amp
l_int|0x0F
)braket
suffix:semicolon
op_increment
id|out
suffix:semicolon
op_increment
id|in
suffix:semicolon
)brace
)brace
DECL|function|ppp_print_char
r_static
r_inline
r_void
id|ppp_print_char
(paren
r_register
r_char
op_star
id|out
comma
r_const
r_char
op_star
id|in
comma
r_int
id|count
)paren
(brace
r_register
r_int
r_char
id|next_ch
suffix:semicolon
r_while
c_loop
(paren
id|count
op_decrement
OG
l_int|0
)paren
(brace
id|next_ch
op_assign
(paren
r_int
r_char
)paren
id|get_user
(paren
id|in
)paren
suffix:semicolon
r_if
c_cond
(paren
id|next_ch
template_param
l_int|0x7e
)paren
op_star
id|out
op_increment
op_assign
l_char|&squot;.&squot;
suffix:semicolon
r_else
(brace
op_star
id|out
op_increment
op_assign
id|next_ch
suffix:semicolon
r_if
c_cond
(paren
id|next_ch
op_eq
l_char|&squot;%&squot;
)paren
multiline_comment|/* printk/syslogd has a bug !! */
op_star
id|out
op_increment
op_assign
l_char|&squot;%&squot;
suffix:semicolon
)brace
op_increment
id|in
suffix:semicolon
)brace
op_star
id|out
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
)brace
DECL|function|ppp_print_buffer
r_static
r_void
id|ppp_print_buffer
c_func
(paren
r_const
r_char
op_star
id|name
comma
r_const
r_char
op_star
id|buf
comma
r_int
id|count
comma
r_int
id|seg
)paren
(brace
r_char
id|line
(braket
l_int|44
)braket
suffix:semicolon
r_int
id|old_fs
op_assign
id|get_fs
c_func
(paren
)paren
suffix:semicolon
id|set_fs
(paren
id|seg
)paren
suffix:semicolon
r_if
c_cond
(paren
id|name
op_ne
l_int|NULL
)paren
id|PRINTK
(paren
(paren
id|KERN_DEBUG
l_string|&quot;ppp: %s, count = %d&bslash;n&quot;
comma
id|name
comma
id|count
)paren
)paren
suffix:semicolon
r_while
c_loop
(paren
id|count
OG
l_int|8
)paren
(brace
id|memset
(paren
id|line
comma
l_char|&squot; &squot;
comma
r_sizeof
(paren
id|line
)paren
)paren
suffix:semicolon
id|ppp_print_hex
(paren
id|line
comma
id|buf
comma
l_int|8
)paren
suffix:semicolon
id|ppp_print_char
(paren
op_amp
id|line
(braket
l_int|8
op_star
l_int|3
)braket
comma
id|buf
comma
l_int|8
)paren
suffix:semicolon
id|PRINTK
(paren
(paren
id|KERN_DEBUG
l_string|&quot;%s&bslash;n&quot;
comma
id|line
)paren
)paren
suffix:semicolon
id|count
op_sub_assign
l_int|8
suffix:semicolon
id|buf
op_add_assign
l_int|8
suffix:semicolon
)brace
r_if
c_cond
(paren
id|count
OG
l_int|0
)paren
(brace
id|memset
(paren
id|line
comma
l_char|&squot; &squot;
comma
r_sizeof
(paren
id|line
)paren
)paren
suffix:semicolon
id|ppp_print_hex
(paren
id|line
comma
id|buf
comma
id|count
)paren
suffix:semicolon
id|ppp_print_char
(paren
op_amp
id|line
(braket
l_int|8
op_star
l_int|3
)braket
comma
id|buf
comma
id|count
)paren
suffix:semicolon
id|PRINTK
(paren
(paren
id|KERN_DEBUG
l_string|&quot;%s&bslash;n&quot;
comma
id|line
)paren
)paren
suffix:semicolon
)brace
id|set_fs
(paren
id|old_fs
)paren
suffix:semicolon
)brace
macro_line|#ifdef MODULE
DECL|variable|kernel_version
r_char
id|kernel_version
(braket
)braket
op_assign
id|UTS_RELEASE
suffix:semicolon
DECL|variable|dev_ppp
r_static
r_struct
id|device
id|dev_ppp
(braket
id|PPP_NRUNIT
)braket
op_assign
(brace
(brace
l_string|&quot;ppp0&quot;
comma
multiline_comment|/* ppp */
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
multiline_comment|/* memory */
l_int|0
comma
l_int|0
comma
multiline_comment|/* base, irq */
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|NULL
comma
id|ppp_init
comma
)brace
comma
(brace
l_string|&quot;ppp1&quot;
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|1
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|NULL
comma
id|ppp_init
)brace
comma
(brace
l_string|&quot;ppp2&quot;
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|2
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|NULL
comma
id|ppp_init
)brace
comma
(brace
l_string|&quot;ppp3&quot;
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|3
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|NULL
comma
id|ppp_init
)brace
macro_line|#ifdef PPP_PPP_LOTS
comma
(brace
l_string|&quot;ppp4&quot;
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|4
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|NULL
comma
id|ppp_init
)brace
comma
(brace
l_string|&quot;ppp5&quot;
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|5
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|NULL
comma
id|ppp_init
)brace
comma
(brace
l_string|&quot;ppp6&quot;
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|6
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|NULL
comma
id|ppp_init
)brace
comma
(brace
l_string|&quot;ppp7&quot;
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|7
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|NULL
comma
id|ppp_init
)brace
comma
(brace
l_string|&quot;ppp8&quot;
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|8
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|NULL
comma
id|ppp_init
)brace
comma
(brace
l_string|&quot;ppp9&quot;
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|9
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|NULL
comma
id|ppp_init
)brace
comma
(brace
l_string|&quot;ppp10&quot;
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|10
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|NULL
comma
id|ppp_init
)brace
comma
(brace
l_string|&quot;ppp11&quot;
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|11
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|NULL
comma
id|ppp_init
)brace
comma
(brace
l_string|&quot;ppp12&quot;
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|12
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|NULL
comma
id|ppp_init
)brace
comma
(brace
l_string|&quot;ppp13&quot;
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|13
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|NULL
comma
id|ppp_init
)brace
comma
(brace
l_string|&quot;ppp14&quot;
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|14
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|NULL
comma
id|ppp_init
)brace
comma
(brace
l_string|&quot;ppp15&quot;
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|15
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|NULL
comma
id|ppp_init
)brace
macro_line|#endif
)brace
suffix:semicolon
r_int
DECL|function|init_module
id|init_module
c_func
(paren
r_void
)paren
(brace
r_int
id|err
suffix:semicolon
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|PPP_NRUNIT
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
(paren
id|err
op_assign
id|register_netdev
c_func
(paren
op_amp
id|dev_ppp
(braket
id|i
)braket
)paren
)paren
)paren
(brace
r_if
c_cond
(paren
id|err
op_eq
op_minus
id|EEXIST
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;PPP: devices already present. Module not loaded.&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_return
id|err
suffix:semicolon
)brace
)brace
r_return
l_int|0
suffix:semicolon
)brace
r_void
DECL|function|cleanup_module
id|cleanup_module
c_func
(paren
r_void
)paren
(brace
r_int
id|i
suffix:semicolon
r_if
c_cond
(paren
id|MOD_IN_USE
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;PPP: device busy, remove delayed&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|PPP_NRUNIT
suffix:semicolon
id|i
op_increment
)paren
(brace
id|unregister_netdev
c_func
(paren
op_amp
id|dev_ppp
(braket
id|i
)braket
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|i
op_assign
id|tty_register_ldisc
c_func
(paren
id|N_PPP
comma
l_int|NULL
)paren
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;PPP: can&squot;t unregister line discipline (err = %d)&bslash;n&quot;
comma
id|i
)paren
suffix:semicolon
)brace
)brace
macro_line|#endif
eof
