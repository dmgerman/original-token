multiline_comment|/*&n; * Linux ethernet device driver for the 3Com Etherlink Plus (3C505)&n; * &t;By Craig Southeren and Juha Laiho&n; *&n; * 3c505.c&t;This module implements an interface to the 3Com&n; *&t;&t;Etherlink Plus (3c505) ethernet card. Linux device &n; *&t;&t;driver interface reverse engineered from the Linux 3C509&n; *&t;&t;device drivers. Some 3C505 information gleaned from&n; *&t;&t;the Crynwr packet driver. Still this driver would not&n; *&t;&t;be here without 3C505 technical reference provided by&n; *&t;&t;3Com.&n; *&n; * Version:&t;@(#)3c505.c&t;0.8.1&t;26-Jun-95&n; *&n; * Authors:&t;Linux 3c505 device driver by&n; *&t;&t;&t;Craig Southeren, &lt;craigs@ineluki.apana.org.au&gt;&n; *              Final debugging by&n; *&t;&t;&t;Andrew Tridgell, &lt;tridge@nimbus.anu.edu.au&gt;&n; *&t;&t;Auto irq/address, tuning, cleanup and v1.1.4+ kernel mods by&n; *&t;&t;&t;Juha Laiho, &lt;jlaiho@ichaos.nullnet.fi&gt;&n; *              Linux 3C509 driver by&n; *             &t;&t;Donald Becker, &lt;becker@super.org&gt;&n; *&t;&t;Crynwr packet driver by&n; *&t;&t;&t;Krishnan Gopalan and Gregg Stefancik,&n; * &t;&t;&t;   Clemson University Engineering Computer Operations.&n; *&t;&t;&t;Portions of the code have been adapted from the 3c505&n; *&t;&t;&t;   driver for NCSA Telnet by Bruce Orchard and later&n; *&t;&t;&t;   modified by Warren Van Houten and krus@diku.dk.&n; *              3C505 technical information provided by&n; *                      Terry Murphy, of 3Com Network Adapter Division&n; *&t;&t;Linux 1.3.0 changes by&n; *&t;&t;&t;Alan Cox &lt;Alan.Cox@linux.org&gt;&n; *                     &n; */
macro_line|#ifdef MODULE
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/version.h&gt;
macro_line|#endif
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/interrupt.h&gt;
macro_line|#include &lt;linux/ptrace.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/in.h&gt;
macro_line|#include &lt;linux/malloc.h&gt;
macro_line|#include &lt;linux/ioport.h&gt;
macro_line|#include &lt;asm/bitops.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;linux/netdevice.h&gt;
macro_line|#include &lt;linux/etherdevice.h&gt;
macro_line|#include &lt;linux/skbuff.h&gt;
macro_line|#include &quot;3c505.h&quot;
multiline_comment|/*********************************************************&n; *&n; *  define debug messages here as common strings to reduce space&n; *&n; *********************************************************/
DECL|variable|filename
r_static
r_const
r_char
op_star
id|filename
op_assign
id|__FILE__
suffix:semicolon
DECL|variable|null_msg
r_static
r_const
r_char
op_star
id|null_msg
op_assign
l_string|&quot;*** NULL at %s:%s (line %d) ***&bslash;n&quot;
suffix:semicolon
DECL|macro|CHECK_NULL
mdefine_line|#define CHECK_NULL(p) &bslash;&n;&t;if (!p) printk(null_msg, filename,__FUNCTION__,__LINE__)
DECL|variable|timeout_msg
r_static
r_const
r_char
op_star
id|timeout_msg
op_assign
l_string|&quot;*** timeout at %s:%s (line %d) ***&bslash;n&quot;
suffix:semicolon
DECL|macro|TIMEOUT_MSG
mdefine_line|#define TIMEOUT_MSG(lineno) &bslash;&n;&t;printk(timeout_msg, filename,__FUNCTION__,(lineno))
DECL|variable|invalid_pcb_msg
r_static
r_const
r_char
op_star
id|invalid_pcb_msg
op_assign
l_string|&quot;*** invalid pcb length %d at %s:%s (line %d) ***&bslash;n&quot;
suffix:semicolon
DECL|macro|INVALID_PCB_MSG
mdefine_line|#define INVALID_PCB_MSG(len) &bslash;&n;&t;printk(invalid_pcb_msg, (len),filename,__FUNCTION__,__LINE__)
DECL|variable|search_msg
r_static
r_const
r_char
op_star
id|search_msg
op_assign
l_string|&quot;%s: Looking for 3c505 adapter at address %#x...&quot;
suffix:semicolon
DECL|variable|stilllooking_msg
r_static
r_const
r_char
op_star
id|stilllooking_msg
op_assign
l_string|&quot;still looking...&quot;
suffix:semicolon
DECL|variable|found_msg
r_static
r_const
r_char
op_star
id|found_msg
op_assign
l_string|&quot;found.&bslash;n&quot;
suffix:semicolon
DECL|variable|notfound_msg
r_static
r_const
r_char
op_star
id|notfound_msg
op_assign
l_string|&quot;not found (reason = %d)&bslash;n&quot;
suffix:semicolon
DECL|variable|couldnot_msg
r_static
r_const
r_char
op_star
id|couldnot_msg
op_assign
l_string|&quot;%s: 3c505 not found&bslash;n&quot;
suffix:semicolon
multiline_comment|/*********************************************************&n; *&n; *  various other debug stuff&n; *&n; *********************************************************/
macro_line|#ifdef ELP_DEBUG
DECL|variable|elp_debug
r_static
r_int
id|elp_debug
op_assign
id|ELP_DEBUG
suffix:semicolon
macro_line|#else
DECL|variable|elp_debug
r_static
r_int
id|elp_debug
op_assign
l_int|0
suffix:semicolon
macro_line|#endif
multiline_comment|/*&n; *  0 = no messages (well, some)&n; *  1 = messages when high level commands performed&n; *  2 = messages when low level commands performed&n; *  3 = messages when interrupts received&n; */
DECL|macro|ELP_VERSION
mdefine_line|#define&t;ELP_VERSION&t;&quot;0.8.1&quot;
multiline_comment|/*****************************************************************&n; *&n; * useful macros&n; *&n; *****************************************************************/
macro_line|#ifndef&t;TRUE
DECL|macro|TRUE
mdefine_line|#define&t;TRUE&t;1
macro_line|#endif
macro_line|#ifndef&t;FALSE
DECL|macro|FALSE
mdefine_line|#define&t;FALSE&t;0
macro_line|#endif
multiline_comment|/*****************************************************************&n; *&n; * List of I/O-addresses we try to auto-sense&n; * Last element MUST BE 0!&n; *****************************************************************/
DECL|variable|addr_list
r_const
r_int
id|addr_list
(braket
)braket
op_assign
initialization_block
suffix:semicolon
multiline_comment|/*****************************************************************&n; *&n; * Functions for I/O (note the inline !)&n; *&n; *****************************************************************/
r_static
r_inline
r_int
r_char
DECL|function|inb_status
id|inb_status
(paren
r_int
r_int
id|base_addr
)paren
(brace
r_return
id|inb
c_func
(paren
id|base_addr
op_plus
id|PORT_STATUS
)paren
suffix:semicolon
)brace
r_static
r_inline
r_int
r_char
DECL|function|inb_control
id|inb_control
(paren
r_int
r_int
id|base_addr
)paren
(brace
r_return
id|inb
c_func
(paren
id|base_addr
op_plus
id|PORT_CONTROL
)paren
suffix:semicolon
)brace
r_static
r_inline
r_int
DECL|function|inb_command
id|inb_command
(paren
r_int
r_int
id|base_addr
)paren
(brace
r_return
id|inb
c_func
(paren
id|base_addr
op_plus
id|PORT_COMMAND
)paren
suffix:semicolon
)brace
r_static
r_inline
r_void
DECL|function|outb_control
id|outb_control
(paren
r_int
r_char
id|val
comma
r_int
r_int
id|base_addr
)paren
(brace
id|outb
c_func
(paren
id|val
comma
id|base_addr
op_plus
id|PORT_CONTROL
)paren
suffix:semicolon
)brace
r_static
r_inline
r_void
DECL|function|outb_command
id|outb_command
(paren
r_int
r_char
id|val
comma
r_int
r_int
id|base_addr
)paren
(brace
id|outb
c_func
(paren
id|val
comma
id|base_addr
op_plus
id|PORT_COMMAND
)paren
suffix:semicolon
)brace
r_static
r_inline
r_int
r_int
DECL|function|inw_data
id|inw_data
(paren
r_int
r_int
id|base_addr
)paren
(brace
r_return
id|inw
c_func
(paren
id|base_addr
op_plus
id|PORT_DATA
)paren
suffix:semicolon
)brace
r_static
r_inline
r_void
DECL|function|outw_data
id|outw_data
(paren
r_int
r_int
id|val
comma
r_int
r_int
id|base_addr
)paren
(brace
id|outw
c_func
(paren
id|val
comma
id|base_addr
op_plus
id|PORT_DATA
)paren
suffix:semicolon
)brace
multiline_comment|/*****************************************************************&n; *&n; *  structure to hold context information for adapter&n; *&n; *****************************************************************/
r_typedef
r_struct
(brace
DECL|member|got
r_volatile
r_int
id|got
(braket
id|NUM_TRANSMIT_CMDS
)braket
suffix:semicolon
multiline_comment|/* flags for command completion */
DECL|member|tx_pcb
id|pcb_struct
id|tx_pcb
suffix:semicolon
multiline_comment|/* PCB for foreground sending */
DECL|member|rx_pcb
id|pcb_struct
id|rx_pcb
suffix:semicolon
multiline_comment|/* PCB for foreground receiving */
DECL|member|itx_pcb
id|pcb_struct
id|itx_pcb
suffix:semicolon
multiline_comment|/* PCB for background sending */
DECL|member|irx_pcb
id|pcb_struct
id|irx_pcb
suffix:semicolon
multiline_comment|/* PCB for background receiving */
DECL|member|stats
r_struct
id|enet_statistics
id|stats
suffix:semicolon
DECL|typedef|elp_device
)brace
id|elp_device
suffix:semicolon
DECL|variable|reset_count
r_static
r_int
id|reset_count
op_assign
l_int|0
suffix:semicolon
multiline_comment|/*****************************************************************&n; *&n; *  useful functions for accessing the adapter&n; *&n; *****************************************************************/
multiline_comment|/*&n; * use this routine when accessing the ASF bits as they are&n; * changed asynchronously by the adapter&n; */
multiline_comment|/* get adapter PCB status */
DECL|macro|GET_ASF
mdefine_line|#define&t;GET_ASF(addr) &bslash;&n;&t;(get_status(addr)&amp;ASF_PCB_MASK)
r_static
r_inline
r_int
DECL|function|get_status
id|get_status
(paren
r_int
r_int
id|base_addr
)paren
(brace
r_int
id|timeout
op_assign
id|jiffies
op_plus
l_int|10
suffix:semicolon
r_register
r_int
id|stat1
suffix:semicolon
r_do
(brace
id|stat1
op_assign
id|inb_status
c_func
(paren
id|base_addr
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
id|stat1
op_ne
id|inb_status
c_func
(paren
id|base_addr
)paren
op_logical_and
id|jiffies
OL
id|timeout
)paren
suffix:semicolon
r_if
c_cond
(paren
id|jiffies
op_ge
id|timeout
)paren
id|TIMEOUT_MSG
c_func
(paren
id|__LINE__
)paren
suffix:semicolon
r_return
id|stat1
suffix:semicolon
)brace
r_static
r_inline
r_void
DECL|function|set_hsf
id|set_hsf
(paren
r_int
r_int
id|base_addr
comma
r_int
id|hsf
)paren
(brace
id|cli
c_func
(paren
)paren
suffix:semicolon
id|outb_control
c_func
(paren
(paren
id|inb_control
c_func
(paren
id|base_addr
)paren
op_amp
op_complement
id|HSF_PCB_MASK
)paren
op_or
id|hsf
comma
id|base_addr
)paren
suffix:semicolon
id|sti
c_func
(paren
)paren
suffix:semicolon
)brace
DECL|macro|WAIT_HCRE
mdefine_line|#define WAIT_HCRE(addr,toval) wait_hcre((addr),(toval),__LINE__)
r_static
r_inline
r_int
DECL|function|wait_hcre
id|wait_hcre
(paren
r_int
r_int
id|base_addr
comma
r_int
id|toval
comma
r_int
id|lineno
)paren
(brace
r_int
id|timeout
op_assign
id|jiffies
op_plus
id|toval
suffix:semicolon
r_while
c_loop
(paren
(paren
(paren
id|inb_status
c_func
(paren
id|base_addr
)paren
op_amp
id|HCRE
)paren
op_eq
l_int|0
)paren
op_logical_and
(paren
id|jiffies
op_le
id|timeout
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|jiffies
op_ge
id|timeout
)paren
(brace
id|TIMEOUT_MSG
c_func
(paren
id|lineno
)paren
suffix:semicolon
r_return
id|FALSE
suffix:semicolon
)brace
r_return
id|TRUE
suffix:semicolon
)brace
r_static
r_inline
r_int
DECL|function|wait_fast_hcre
id|wait_fast_hcre
(paren
r_int
r_int
id|base_addr
comma
r_int
id|toval
comma
r_int
id|lineno
)paren
(brace
r_int
id|timeout
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
(paren
(paren
id|inb_status
c_func
(paren
id|base_addr
)paren
op_amp
id|HCRE
)paren
op_eq
l_int|0
)paren
op_logical_and
(paren
id|timeout
op_increment
OL
id|toval
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|timeout
op_ge
id|toval
)paren
(brace
id|sti
c_func
(paren
)paren
suffix:semicolon
id|TIMEOUT_MSG
c_func
(paren
id|lineno
)paren
suffix:semicolon
r_return
id|FALSE
suffix:semicolon
)brace
r_return
id|TRUE
suffix:semicolon
)brace
r_static
r_int
id|start_receive
(paren
r_struct
id|device
op_star
comma
id|pcb_struct
op_star
)paren
suffix:semicolon
r_static
r_void
id|adapter_hard_reset
(paren
r_struct
id|device
op_star
)paren
suffix:semicolon
r_inline
r_static
r_void
DECL|function|adapter_reset
id|adapter_reset
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
r_int
id|timeout
suffix:semicolon
r_int
r_char
id|orig_hcr
op_assign
id|inb_control
c_func
(paren
id|dev-&gt;base_addr
)paren
suffix:semicolon
id|elp_device
op_star
id|adapter
op_assign
id|dev-&gt;priv
suffix:semicolon
id|outb_control
c_func
(paren
l_int|0
comma
id|dev-&gt;base_addr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|inb_status
c_func
(paren
id|dev-&gt;base_addr
)paren
op_amp
id|ACRF
)paren
(brace
r_do
(brace
id|inb_command
c_func
(paren
id|dev-&gt;base_addr
)paren
suffix:semicolon
id|timeout
op_assign
id|jiffies
op_plus
l_int|2
suffix:semicolon
r_while
c_loop
(paren
(paren
id|jiffies
op_le
id|timeout
)paren
op_logical_and
op_logical_neg
(paren
id|inb_status
c_func
(paren
id|dev-&gt;base_addr
)paren
op_amp
id|ACRF
)paren
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
id|inb_status
c_func
(paren
id|dev-&gt;base_addr
)paren
op_amp
id|ACRF
)paren
suffix:semicolon
id|set_hsf
c_func
(paren
id|dev-&gt;base_addr
comma
id|HSF_PCB_NAK
)paren
suffix:semicolon
)brace
id|outb_control
c_func
(paren
id|inb_control
c_func
(paren
id|dev-&gt;base_addr
)paren
op_or
id|ATTN
op_or
id|DIR
comma
id|dev-&gt;base_addr
)paren
suffix:semicolon
id|timeout
op_assign
id|jiffies
op_plus
l_int|1
suffix:semicolon
r_while
c_loop
(paren
id|jiffies
op_le
id|timeout
)paren
suffix:semicolon
id|outb_control
c_func
(paren
id|inb_control
c_func
(paren
id|dev-&gt;base_addr
)paren
op_amp
op_complement
id|ATTN
comma
id|dev-&gt;base_addr
)paren
suffix:semicolon
id|timeout
op_assign
id|jiffies
op_plus
l_int|1
suffix:semicolon
r_while
c_loop
(paren
id|jiffies
op_le
id|timeout
)paren
suffix:semicolon
id|outb_control
c_func
(paren
id|inb_control
c_func
(paren
id|dev-&gt;base_addr
)paren
op_or
id|FLSH
comma
id|dev-&gt;base_addr
)paren
suffix:semicolon
id|timeout
op_assign
id|jiffies
op_plus
l_int|1
suffix:semicolon
r_while
c_loop
(paren
id|jiffies
op_le
id|timeout
)paren
suffix:semicolon
id|outb_control
c_func
(paren
id|inb_control
c_func
(paren
id|dev-&gt;base_addr
)paren
op_amp
op_complement
id|FLSH
comma
id|dev-&gt;base_addr
)paren
suffix:semicolon
id|timeout
op_assign
id|jiffies
op_plus
l_int|1
suffix:semicolon
r_while
c_loop
(paren
id|jiffies
op_le
id|timeout
)paren
suffix:semicolon
id|outb_control
c_func
(paren
id|orig_hcr
comma
id|dev-&gt;base_addr
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|start_receive
c_func
(paren
id|dev
comma
op_amp
id|adapter-&gt;tx_pcb
)paren
)paren
id|printk
c_func
(paren
l_string|&quot;%s: start receive command failed &bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
)brace
multiline_comment|/*****************************************************************&n; *&n; * send_pcb&n; *   Send a PCB to the adapter. &n; *&n; *&t;output byte to command reg  --&lt;--+&n; *&t;wait until HCRE is non zero      |&n; *&t;loop until all bytes sent   --&gt;--+&n; *&t;set HSF1 and HSF2 to 1&n; *&t;output pcb length&n; *&t;wait until ASF give ACK or NAK&n; *&t;set HSF1 and HSF2 to 0&n; *&n; *****************************************************************/
r_static
r_int
DECL|function|send_pcb
id|send_pcb
(paren
r_struct
id|device
op_star
id|dev
comma
id|pcb_struct
op_star
id|pcb
)paren
(brace
r_int
id|i
suffix:semicolon
r_int
id|timeout
suffix:semicolon
r_int
id|cont
suffix:semicolon
multiline_comment|/*&n;&t; * load each byte into the command register and&n;&t; * wait for the HCRE bit to indicate the adapter&n;&t; * had read the byte&n;&t; */
id|set_hsf
c_func
(paren
id|dev-&gt;base_addr
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|cont
op_assign
id|WAIT_HCRE
c_func
(paren
id|dev-&gt;base_addr
comma
l_int|5
)paren
)paren
)paren
(brace
id|cli
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pcb-&gt;command
op_eq
id|CMD_TRANSMIT_PACKET
)paren
id|outb_control
c_func
(paren
id|inb_control
c_func
(paren
id|dev-&gt;base_addr
)paren
op_amp
op_complement
id|DIR
comma
id|dev-&gt;base_addr
)paren
suffix:semicolon
id|outb_command
c_func
(paren
id|pcb-&gt;command
comma
id|dev-&gt;base_addr
)paren
suffix:semicolon
id|sti
c_func
(paren
)paren
suffix:semicolon
id|cont
op_assign
id|WAIT_HCRE
c_func
(paren
id|dev-&gt;base_addr
comma
l_int|5
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|cont
)paren
(brace
id|outb_command
c_func
(paren
id|pcb-&gt;length
comma
id|dev-&gt;base_addr
)paren
suffix:semicolon
id|cont
op_assign
id|WAIT_HCRE
c_func
(paren
id|dev-&gt;base_addr
comma
l_int|5
)paren
suffix:semicolon
)brace
id|cli
c_func
(paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|cont
op_logical_and
(paren
id|i
OL
id|pcb-&gt;length
)paren
suffix:semicolon
id|i
op_increment
)paren
(brace
id|outb_command
c_func
(paren
id|pcb-&gt;data.raw
(braket
id|i
)braket
comma
id|dev-&gt;base_addr
)paren
suffix:semicolon
id|cont
op_assign
id|wait_fast_hcre
c_func
(paren
id|dev-&gt;base_addr
comma
l_int|20000
comma
id|__LINE__
)paren
suffix:semicolon
)brace
multiline_comment|/* if wait_fast_hcre() failed, has already done sti() */
multiline_comment|/* set the host status bits to indicate end of PCB */
multiline_comment|/* send the total packet length as well */
multiline_comment|/* wait for the adapter to indicate that it has read the PCB */
r_if
c_cond
(paren
id|cont
)paren
(brace
id|set_hsf
c_func
(paren
id|dev-&gt;base_addr
comma
id|HSF_PCB_END
)paren
suffix:semicolon
id|outb_command
c_func
(paren
l_int|2
op_plus
id|pcb-&gt;length
comma
id|dev-&gt;base_addr
)paren
suffix:semicolon
id|sti
c_func
(paren
)paren
suffix:semicolon
id|timeout
op_assign
id|jiffies
op_plus
l_int|7
suffix:semicolon
r_while
c_loop
(paren
id|jiffies
OL
id|timeout
)paren
(brace
id|i
op_assign
id|GET_ASF
c_func
(paren
id|dev-&gt;base_addr
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|i
op_eq
id|ASF_PCB_ACK
)paren
op_logical_or
(paren
id|i
op_eq
id|ASF_PCB_NAK
)paren
)paren
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|i
op_eq
id|ASF_PCB_ACK
)paren
(brace
id|reset_count
op_assign
l_int|0
suffix:semicolon
r_return
id|TRUE
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|i
op_eq
id|ASF_PCB_NAK
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%s: PCB send was NAKed&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
)brace
r_else
(brace
id|printk
c_func
(paren
l_string|&quot;%s: timeout after sending PCB&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
)brace
)brace
r_else
id|printk
c_func
(paren
l_string|&quot;%s: timeout in middle of sending PCB&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|adapter_reset
c_func
(paren
id|dev
)paren
suffix:semicolon
r_return
id|FALSE
suffix:semicolon
)brace
multiline_comment|/*****************************************************************&n; *&n; * receive_pcb&n; *   Read a PCB to the adapter&n; *&n; *&t;wait for ACRF to be non-zero        ---&lt;---+&n; *&t;input a byte                               |&n; *&t;if ASF1 and ASF2 were not both one         |&n; *&t;&t;before byte was read, loop      ---&gt;---+&n; *&t;set HSF1 and HSF2 for ack&n; *&n; *****************************************************************/
r_static
r_int
DECL|function|receive_pcb
id|receive_pcb
(paren
r_struct
id|device
op_star
id|dev
comma
id|pcb_struct
op_star
id|pcb
)paren
(brace
r_int
id|i
comma
id|j
suffix:semicolon
r_int
id|total_length
suffix:semicolon
r_int
id|stat
suffix:semicolon
r_int
id|timeout
suffix:semicolon
id|CHECK_NULL
c_func
(paren
id|pcb
)paren
suffix:semicolon
id|CHECK_NULL
c_func
(paren
id|dev
)paren
suffix:semicolon
id|set_hsf
c_func
(paren
id|dev-&gt;base_addr
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* get the command code */
id|timeout
op_assign
id|jiffies
op_plus
l_int|2
suffix:semicolon
r_while
c_loop
(paren
(paren
(paren
id|stat
op_assign
id|get_status
c_func
(paren
id|dev-&gt;base_addr
)paren
)paren
op_amp
id|ACRF
)paren
op_eq
l_int|0
op_logical_and
id|jiffies
OL
id|timeout
)paren
suffix:semicolon
r_if
c_cond
(paren
id|jiffies
op_ge
id|timeout
)paren
(brace
id|TIMEOUT_MSG
c_func
(paren
id|__LINE__
)paren
suffix:semicolon
r_return
id|FALSE
suffix:semicolon
)brace
id|pcb-&gt;command
op_assign
id|inb_command
c_func
(paren
id|dev-&gt;base_addr
)paren
suffix:semicolon
multiline_comment|/* read the data length */
id|timeout
op_assign
id|jiffies
op_plus
l_int|3
suffix:semicolon
r_while
c_loop
(paren
(paren
(paren
id|stat
op_assign
id|get_status
c_func
(paren
id|dev-&gt;base_addr
)paren
)paren
op_amp
id|ACRF
)paren
op_eq
l_int|0
op_logical_and
id|jiffies
OL
id|timeout
)paren
suffix:semicolon
r_if
c_cond
(paren
id|jiffies
op_ge
id|timeout
)paren
(brace
id|TIMEOUT_MSG
c_func
(paren
id|__LINE__
)paren
suffix:semicolon
r_return
id|FALSE
suffix:semicolon
)brace
id|pcb-&gt;length
op_assign
id|inb_command
c_func
(paren
id|dev-&gt;base_addr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pcb-&gt;length
OG
id|MAX_PCB_DATA
)paren
(brace
id|INVALID_PCB_MSG
c_func
(paren
id|pcb-&gt;length
)paren
suffix:semicolon
id|adapter_reset
c_func
(paren
id|dev
)paren
suffix:semicolon
r_return
id|FALSE
suffix:semicolon
)brace
multiline_comment|/* read the data */
id|cli
c_func
(paren
)paren
suffix:semicolon
id|i
op_assign
l_int|0
suffix:semicolon
r_do
(brace
id|j
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
(paren
(paren
id|stat
op_assign
id|get_status
c_func
(paren
id|dev-&gt;base_addr
)paren
)paren
op_amp
id|ACRF
)paren
op_eq
l_int|0
op_logical_and
id|j
op_increment
OL
l_int|20000
)paren
suffix:semicolon
id|pcb-&gt;data.raw
(braket
id|i
op_increment
)braket
op_assign
id|inb_command
c_func
(paren
id|dev-&gt;base_addr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
OG
id|MAX_PCB_DATA
)paren
id|INVALID_PCB_MSG
c_func
(paren
id|i
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
(paren
id|stat
op_amp
id|ASF_PCB_MASK
)paren
op_ne
id|ASF_PCB_END
op_logical_and
id|j
OL
l_int|20000
)paren
suffix:semicolon
id|sti
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|j
op_ge
l_int|20000
)paren
(brace
id|TIMEOUT_MSG
c_func
(paren
id|__LINE__
)paren
suffix:semicolon
r_return
id|FALSE
suffix:semicolon
)brace
multiline_comment|/* woops, the last &quot;data&quot; byte was really the length! */
id|total_length
op_assign
id|pcb-&gt;data.raw
(braket
op_decrement
id|i
)braket
suffix:semicolon
multiline_comment|/* safety check total length vs data length */
r_if
c_cond
(paren
id|total_length
op_ne
(paren
id|pcb-&gt;length
op_plus
l_int|2
)paren
)paren
(brace
r_if
c_cond
(paren
id|elp_debug
op_ge
l_int|2
)paren
id|printk
c_func
(paren
l_string|&quot;%s: mangled PCB received&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|set_hsf
c_func
(paren
id|dev-&gt;base_addr
comma
id|HSF_PCB_NAK
)paren
suffix:semicolon
r_return
id|FALSE
suffix:semicolon
)brace
id|set_hsf
c_func
(paren
id|dev-&gt;base_addr
comma
id|HSF_PCB_ACK
)paren
suffix:semicolon
id|reset_count
op_assign
l_int|0
suffix:semicolon
r_return
id|TRUE
suffix:semicolon
)brace
r_static
r_void
DECL|function|adapter_hard_reset
id|adapter_hard_reset
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
r_int
id|timeout
suffix:semicolon
id|CHECK_NULL
c_func
(paren
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|elp_debug
OG
l_int|0
)paren
id|printk
c_func
(paren
l_string|&quot;%s: Resetting the adapter, please wait (approx 20 s)&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * take FLSH and ATTN high&n;&t; */
id|outb_control
c_func
(paren
id|ATTN
op_or
id|FLSH
comma
id|dev-&gt;base_addr
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * wait for a little bit&n;&t; */
r_for
c_loop
(paren
id|timeout
op_assign
id|jiffies
op_plus
l_int|20
suffix:semicolon
id|jiffies
op_le
id|timeout
suffix:semicolon
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * now take them low&n;&t; */
id|outb_control
c_func
(paren
l_int|0
comma
id|dev-&gt;base_addr
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * wait for a little bit&n;&t; */
r_for
c_loop
(paren
id|timeout
op_assign
id|jiffies
op_plus
l_int|20
suffix:semicolon
id|jiffies
op_le
id|timeout
suffix:semicolon
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * now hang around until the board gets it&squot;s act together&n;&t; */
r_for
c_loop
(paren
id|timeout
op_assign
id|jiffies
op_plus
(paren
l_int|100
op_star
l_int|15
)paren
suffix:semicolon
id|jiffies
op_le
id|timeout
suffix:semicolon
)paren
r_if
c_cond
(paren
id|GET_ASF
c_func
(paren
id|dev-&gt;base_addr
)paren
op_ne
id|ASF_PCB_END
)paren
r_break
suffix:semicolon
)brace
multiline_comment|/******************************************************&n; *&n; *  queue a receive command on the adapter so we will get an&n; *  interrupt when a packet is received.&n; *&n; ******************************************************/
r_static
r_int
DECL|function|start_receive
id|start_receive
(paren
r_struct
id|device
op_star
id|dev
comma
id|pcb_struct
op_star
id|tx_pcb
)paren
(brace
id|CHECK_NULL
c_func
(paren
id|dev
)paren
suffix:semicolon
id|CHECK_NULL
c_func
(paren
id|tx_pcb
)paren
suffix:semicolon
r_if
c_cond
(paren
id|elp_debug
op_ge
l_int|3
)paren
id|printk
c_func
(paren
l_string|&quot;%s: restarting receiver&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|tx_pcb-&gt;command
op_assign
id|CMD_RECEIVE_PACKET
suffix:semicolon
id|tx_pcb-&gt;length
op_assign
r_sizeof
(paren
r_struct
id|Rcv_pkt
)paren
suffix:semicolon
id|tx_pcb-&gt;data.rcv_pkt.buf_seg
op_assign
id|tx_pcb-&gt;data.rcv_pkt.buf_ofs
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Unused */
id|tx_pcb-&gt;data.rcv_pkt.buf_len
op_assign
l_int|1600
suffix:semicolon
id|tx_pcb-&gt;data.rcv_pkt.timeout
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* set timeout to zero */
r_return
id|send_pcb
c_func
(paren
id|dev
comma
id|tx_pcb
)paren
suffix:semicolon
)brace
multiline_comment|/******************************************************&n; *&n; * extract a packet from the adapter&n; * this routine is only called from within the interrupt&n; * service routine, so no cli/sti calls are needed&n; * note that the length is always assumed to be even&n; *&n; ******************************************************/
r_static
r_void
DECL|function|receive_packet
id|receive_packet
(paren
r_struct
id|device
op_star
id|dev
comma
r_int
id|len
)paren
(brace
r_register
r_int
id|i
suffix:semicolon
r_int
r_int
op_star
id|ptr
suffix:semicolon
r_int
id|timeout
suffix:semicolon
r_int
id|rlen
suffix:semicolon
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
id|elp_device
op_star
id|adapter
suffix:semicolon
id|CHECK_NULL
c_func
(paren
id|dev
)paren
suffix:semicolon
id|adapter
op_assign
id|dev-&gt;priv
suffix:semicolon
r_if
c_cond
(paren
id|len
op_le
l_int|0
op_logical_or
(paren
(paren
id|len
op_amp
op_complement
l_int|1
)paren
op_ne
id|len
)paren
)paren
r_if
c_cond
(paren
id|elp_debug
op_ge
l_int|3
)paren
(brace
id|sti
c_func
(paren
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;*** bad packet len %d at %s(%d)&bslash;n&quot;
comma
id|len
comma
id|filename
comma
id|__LINE__
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
)brace
id|rlen
op_assign
(paren
id|len
op_plus
l_int|1
)paren
op_amp
op_complement
l_int|1
suffix:semicolon
id|skb
op_assign
id|dev_alloc_skb
c_func
(paren
id|rlen
op_plus
l_int|2
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * make sure the data register is going the right way&n;&t; */
id|outb_control
c_func
(paren
id|inb_control
c_func
(paren
id|dev-&gt;base_addr
)paren
op_or
id|DIR
comma
id|dev-&gt;base_addr
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * if buffer could not be allocated, swallow it&n;&t; */
r_if
c_cond
(paren
id|skb
op_eq
l_int|NULL
)paren
(brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
(paren
id|rlen
op_div
l_int|2
)paren
suffix:semicolon
id|i
op_increment
)paren
(brace
id|timeout
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
(paren
id|inb_status
c_func
(paren
id|dev-&gt;base_addr
)paren
op_amp
id|HRDY
)paren
op_eq
l_int|0
op_logical_and
id|timeout
op_increment
OL
l_int|20000
)paren
suffix:semicolon
r_if
c_cond
(paren
id|timeout
op_ge
l_int|20000
)paren
(brace
id|sti
c_func
(paren
)paren
suffix:semicolon
id|TIMEOUT_MSG
c_func
(paren
id|__LINE__
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|inw_data
c_func
(paren
id|dev-&gt;base_addr
)paren
suffix:semicolon
)brace
id|adapter-&gt;stats.rx_dropped
op_increment
suffix:semicolon
)brace
r_else
(brace
id|skb_reserve
c_func
(paren
id|skb
comma
l_int|2
)paren
suffix:semicolon
multiline_comment|/* 16 byte alignment */
id|skb-&gt;dev
op_assign
id|dev
suffix:semicolon
multiline_comment|/*&n;&t;&t; * now read the data from the adapter&n;&t;&t; */
id|ptr
op_assign
(paren
r_int
r_int
op_star
)paren
id|skb_put
c_func
(paren
id|skb
comma
id|len
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
(paren
id|rlen
op_div
l_int|2
)paren
suffix:semicolon
id|i
op_increment
)paren
(brace
id|timeout
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
(paren
id|inb_status
c_func
(paren
id|dev-&gt;base_addr
)paren
op_amp
id|HRDY
)paren
op_eq
l_int|0
op_logical_and
id|timeout
op_increment
OL
l_int|20000
)paren
suffix:semicolon
r_if
c_cond
(paren
id|timeout
op_ge
l_int|20000
)paren
(brace
id|sti
c_func
(paren
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;*** timeout at %s(%d) reading word %d of %d ***&bslash;n&quot;
comma
id|filename
comma
id|__LINE__
comma
id|i
comma
id|rlen
op_div
l_int|2
)paren
suffix:semicolon
id|kfree_skb
c_func
(paren
id|skb
comma
id|FREE_WRITE
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
op_star
id|ptr
op_assign
id|inw_data
c_func
(paren
id|dev-&gt;base_addr
)paren
suffix:semicolon
id|ptr
op_increment
suffix:semicolon
)brace
id|sti
c_func
(paren
)paren
suffix:semicolon
id|skb-&gt;protocol
op_assign
id|eth_type_trans
c_func
(paren
id|skb
comma
id|dev
)paren
suffix:semicolon
id|netif_rx
c_func
(paren
id|skb
)paren
suffix:semicolon
)brace
id|outb_control
c_func
(paren
id|inb_control
c_func
(paren
id|dev-&gt;base_addr
)paren
op_amp
op_complement
id|DIR
comma
id|dev-&gt;base_addr
)paren
suffix:semicolon
)brace
multiline_comment|/******************************************************&n; *&n; * interrupt handler&n; *&n; ******************************************************/
r_static
r_void
DECL|function|elp_interrupt
id|elp_interrupt
(paren
r_int
id|irq
comma
r_struct
id|pt_regs
op_star
id|reg_ptr
)paren
(brace
r_int
id|len
suffix:semicolon
r_int
id|dlen
suffix:semicolon
r_struct
id|device
op_star
id|dev
suffix:semicolon
id|elp_device
op_star
id|adapter
suffix:semicolon
r_int
id|timeout
suffix:semicolon
r_if
c_cond
(paren
id|irq
template_param
l_int|15
)paren
(brace
id|printk
(paren
l_string|&quot;elp_interrupt(): illegal IRQ number found in interrupt routine (%i)&bslash;n&quot;
comma
id|irq
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|dev
op_assign
id|irq2dev_map
(braket
id|irq
)braket
suffix:semicolon
r_if
c_cond
(paren
id|dev
op_eq
l_int|NULL
)paren
(brace
id|printk
(paren
l_string|&quot;elp_interrupt(): irq %d for unknown device.&bslash;n&quot;
comma
id|irq
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|adapter
op_assign
(paren
id|elp_device
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|CHECK_NULL
c_func
(paren
id|adapter
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;interrupt
)paren
r_if
c_cond
(paren
id|elp_debug
op_ge
l_int|2
)paren
id|printk
c_func
(paren
l_string|&quot;%s: Re-entering the interrupt handler.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|dev-&gt;interrupt
op_assign
l_int|1
suffix:semicolon
multiline_comment|/*&n;&t; * allow interrupts (we need timers!)&n;&t; */
id|sti
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * receive a PCB from the adapter&n;&t; */
id|timeout
op_assign
id|jiffies
op_plus
l_int|3
suffix:semicolon
r_while
c_loop
(paren
(paren
id|inb_status
c_func
(paren
id|dev-&gt;base_addr
)paren
op_amp
id|ACRF
)paren
op_ne
l_int|0
op_logical_and
id|jiffies
OL
id|timeout
)paren
(brace
r_if
c_cond
(paren
id|receive_pcb
c_func
(paren
id|dev
comma
op_amp
id|adapter-&gt;irx_pcb
)paren
)paren
(brace
r_switch
c_cond
(paren
id|adapter-&gt;irx_pcb.command
)paren
(brace
multiline_comment|/*&n;&t;&t;&t;&t; * received a packet - this must be handled fast&n;&t;&t;&t;&t; */
r_case
id|CMD_RECEIVE_PACKET_COMPLETE
suffix:colon
multiline_comment|/* if the device isn&squot;t open, don&squot;t pass packets up the stack */
r_if
c_cond
(paren
id|dev-&gt;start
op_eq
l_int|0
)paren
r_break
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* Set direction of adapter FIFO */
id|outb_control
c_func
(paren
id|inb_control
c_func
(paren
id|dev-&gt;base_addr
)paren
op_or
id|DIR
comma
id|dev-&gt;base_addr
)paren
suffix:semicolon
id|len
op_assign
id|adapter-&gt;irx_pcb.data.rcv_resp.pkt_len
suffix:semicolon
id|dlen
op_assign
id|adapter-&gt;irx_pcb.data.rcv_resp.buf_len
suffix:semicolon
r_if
c_cond
(paren
id|adapter-&gt;irx_pcb.data.rcv_resp.timeout
op_ne
l_int|0
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%s: interrupt - packet not received correctly&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|sti
c_func
(paren
)paren
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|elp_debug
op_ge
l_int|3
)paren
(brace
id|sti
c_func
(paren
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;%s: interrupt - packet received of length %i (%i)&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|len
comma
id|dlen
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
)brace
id|receive_packet
c_func
(paren
id|dev
comma
id|dlen
)paren
suffix:semicolon
id|sti
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|elp_debug
op_ge
l_int|3
)paren
id|printk
c_func
(paren
l_string|&quot;%s: packet received&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|dev-&gt;start
op_logical_and
op_logical_neg
id|start_receive
c_func
(paren
id|dev
comma
op_amp
id|adapter-&gt;itx_pcb
)paren
)paren
r_if
c_cond
(paren
id|elp_debug
op_ge
l_int|2
)paren
id|printk
c_func
(paren
l_string|&quot;%s: interrupt - failed to send receive start PCB&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_if
c_cond
(paren
id|elp_debug
op_ge
l_int|3
)paren
id|printk
c_func
(paren
l_string|&quot;%s: receive procedure complete&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_break
suffix:semicolon
multiline_comment|/*&n;&t;&t;&t;&t; * 82586 configured correctly&n;&t;&t;&t;&t; */
r_case
id|CMD_CONFIGURE_82586_RESPONSE
suffix:colon
id|adapter-&gt;got
(braket
id|CMD_CONFIGURE_82586
)braket
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|elp_debug
op_ge
l_int|3
)paren
id|printk
c_func
(paren
l_string|&quot;%s: interrupt - configure response received&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_break
suffix:semicolon
multiline_comment|/*&n;&t;&t;&t;&t; * Adapter memory configuration&n;&t;&t;&t;&t; */
r_case
id|CMD_CONFIGURE_ADAPTER_RESPONSE
suffix:colon
id|adapter-&gt;got
(braket
id|CMD_CONFIGURE_ADAPTER_MEMORY
)braket
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|elp_debug
op_ge
l_int|3
)paren
id|printk
c_func
(paren
l_string|&quot;%s: Adapter memory configuration %s.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|adapter-&gt;irx_pcb.data.failed
ques
c_cond
l_string|&quot;failed&quot;
suffix:colon
l_string|&quot;succeeded&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
multiline_comment|/*&n;&t;&t;&t;&t; * Multicast list loading&n;&t;&t;&t;&t; */
r_case
id|CMD_LOAD_MULTICAST_RESPONSE
suffix:colon
id|adapter-&gt;got
(braket
id|CMD_LOAD_MULTICAST_LIST
)braket
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|elp_debug
op_ge
l_int|3
)paren
id|printk
c_func
(paren
l_string|&quot;%s: Multicast address list loading %s.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|adapter-&gt;irx_pcb.data.failed
ques
c_cond
l_string|&quot;failed&quot;
suffix:colon
l_string|&quot;succeeded&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
multiline_comment|/*&n;&t;&t;&t;&t; * Station address setting&n;&t;&t;&t;&t; */
r_case
id|CMD_SET_ADDRESS_RESPONSE
suffix:colon
id|adapter-&gt;got
(braket
id|CMD_SET_STATION_ADDRESS
)braket
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|elp_debug
op_ge
l_int|3
)paren
id|printk
c_func
(paren
l_string|&quot;%s: Ethernet address setting %s.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|adapter-&gt;irx_pcb.data.failed
ques
c_cond
l_string|&quot;failed&quot;
suffix:colon
l_string|&quot;succeeded&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
multiline_comment|/*&n;&t;&t;&t;&t; * received board statistics&n;&t;&t;&t;&t; */
r_case
id|CMD_NETWORK_STATISTICS_RESPONSE
suffix:colon
id|adapter-&gt;stats.rx_packets
op_add_assign
id|adapter-&gt;irx_pcb.data.netstat.tot_recv
suffix:semicolon
id|adapter-&gt;stats.tx_packets
op_add_assign
id|adapter-&gt;irx_pcb.data.netstat.tot_xmit
suffix:semicolon
id|adapter-&gt;stats.rx_crc_errors
op_add_assign
id|adapter-&gt;irx_pcb.data.netstat.err_CRC
suffix:semicolon
id|adapter-&gt;stats.rx_frame_errors
op_add_assign
id|adapter-&gt;irx_pcb.data.netstat.err_align
suffix:semicolon
id|adapter-&gt;stats.rx_fifo_errors
op_add_assign
id|adapter-&gt;irx_pcb.data.netstat.err_ovrrun
suffix:semicolon
id|adapter-&gt;got
(braket
id|CMD_NETWORK_STATISTICS
)braket
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|elp_debug
op_ge
l_int|3
)paren
id|printk
c_func
(paren
l_string|&quot;%s: interrupt - statistics response received&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_break
suffix:semicolon
multiline_comment|/*&n;&t;&t;&t;&t; * sent a packet&n;&t;&t;&t;&t; */
r_case
id|CMD_TRANSMIT_PACKET_COMPLETE
suffix:colon
r_if
c_cond
(paren
id|elp_debug
op_ge
l_int|3
)paren
id|printk
c_func
(paren
l_string|&quot;%s: interrupt - packet sent&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;start
op_eq
l_int|0
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
id|adapter-&gt;irx_pcb.data.xmit_resp.c_stat
op_ne
l_int|0
)paren
r_if
c_cond
(paren
id|elp_debug
op_ge
l_int|2
)paren
id|printk
c_func
(paren
l_string|&quot;%s: interrupt - error sending packet %4.4x&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|adapter-&gt;irx_pcb.data.xmit_resp.c_stat
)paren
suffix:semicolon
id|dev-&gt;tbusy
op_assign
l_int|0
suffix:semicolon
id|mark_bh
c_func
(paren
id|NET_BH
)paren
suffix:semicolon
r_break
suffix:semicolon
multiline_comment|/*&n;&t;&t;&t;&t; * some unknown PCB&n;&t;&t;&t;&t; */
r_default
suffix:colon
id|printk
c_func
(paren
l_string|&quot;%s: unknown PCB received - %2.2x&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|adapter-&gt;irx_pcb.command
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
r_else
(brace
id|printk
c_func
(paren
l_string|&quot;%s: failed to read PCB on interrupt&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|adapter_reset
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/*&n;&t; * indicate no longer in interrupt routine&n;&t; */
id|dev-&gt;interrupt
op_assign
l_int|0
suffix:semicolon
)brace
multiline_comment|/******************************************************&n; *&n; * open the board&n; *&n; ******************************************************/
r_static
r_int
DECL|function|elp_open
id|elp_open
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
id|elp_device
op_star
id|adapter
suffix:semicolon
id|CHECK_NULL
c_func
(paren
id|dev
)paren
suffix:semicolon
id|adapter
op_assign
id|dev-&gt;priv
suffix:semicolon
r_if
c_cond
(paren
id|elp_debug
op_ge
l_int|3
)paren
id|printk
c_func
(paren
l_string|&quot;%s: request to open device&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * make sure we actually found the device&n;&t; */
r_if
c_cond
(paren
id|adapter
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%s: Opening a non-existent physical device&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_return
op_minus
id|EAGAIN
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * disable interrupts on the board&n;&t; */
id|outb_control
c_func
(paren
l_int|0x00
comma
id|dev-&gt;base_addr
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * clear any pending interrupts&n;&t; */
id|inb_command
c_func
(paren
id|dev-&gt;base_addr
)paren
suffix:semicolon
id|adapter_reset
c_func
(paren
id|dev
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * interrupt routine not entered&n;&t; */
id|dev-&gt;interrupt
op_assign
l_int|0
suffix:semicolon
multiline_comment|/*&n;&t; *  transmitter not busy &n;&t; */
id|dev-&gt;tbusy
op_assign
l_int|0
suffix:semicolon
multiline_comment|/*&n;&t; * make sure we can find the device header given the interrupt number&n;&t; */
id|irq2dev_map
(braket
id|dev-&gt;irq
)braket
op_assign
id|dev
suffix:semicolon
multiline_comment|/*&n;&t; * install our interrupt service routine&n;&t; */
r_if
c_cond
(paren
id|request_irq
c_func
(paren
id|dev-&gt;irq
comma
op_amp
id|elp_interrupt
comma
l_int|0
comma
l_string|&quot;3c505&quot;
)paren
)paren
(brace
id|irq2dev_map
(braket
id|dev-&gt;irq
)braket
op_assign
l_int|NULL
suffix:semicolon
r_return
op_minus
id|EAGAIN
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * enable interrupts on the board&n;&t; */
id|outb_control
c_func
(paren
id|CMDE
comma
id|dev-&gt;base_addr
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * device is now officially open!&n;&t; */
id|dev-&gt;start
op_assign
l_int|1
suffix:semicolon
multiline_comment|/*&n;&t; * configure adapter memory: we need 10 multicast addresses, default==0&n;&t; */
r_if
c_cond
(paren
id|elp_debug
op_ge
l_int|3
)paren
id|printk
c_func
(paren
l_string|&quot;%s: sending 3c505 memory configuration command&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|adapter-&gt;tx_pcb.command
op_assign
id|CMD_CONFIGURE_ADAPTER_MEMORY
suffix:semicolon
id|adapter-&gt;tx_pcb.data.memconf.cmd_q
op_assign
l_int|10
suffix:semicolon
id|adapter-&gt;tx_pcb.data.memconf.rcv_q
op_assign
l_int|20
suffix:semicolon
id|adapter-&gt;tx_pcb.data.memconf.mcast
op_assign
l_int|10
suffix:semicolon
id|adapter-&gt;tx_pcb.data.memconf.frame
op_assign
l_int|20
suffix:semicolon
id|adapter-&gt;tx_pcb.data.memconf.rcv_b
op_assign
l_int|20
suffix:semicolon
id|adapter-&gt;tx_pcb.data.memconf.progs
op_assign
l_int|0
suffix:semicolon
id|adapter-&gt;tx_pcb.length
op_assign
r_sizeof
(paren
r_struct
id|Memconf
)paren
suffix:semicolon
id|adapter-&gt;got
(braket
id|CMD_CONFIGURE_ADAPTER_MEMORY
)braket
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|send_pcb
c_func
(paren
id|dev
comma
op_amp
id|adapter-&gt;tx_pcb
)paren
)paren
id|printk
c_func
(paren
l_string|&quot;%s: couldn&squot;t send memory configuration command&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_else
(brace
r_int
id|timeout
op_assign
id|jiffies
op_plus
id|TIMEOUT
suffix:semicolon
r_while
c_loop
(paren
id|adapter-&gt;got
(braket
id|CMD_CONFIGURE_ADAPTER_MEMORY
)braket
op_eq
l_int|0
op_logical_and
id|jiffies
OL
id|timeout
)paren
suffix:semicolon
r_if
c_cond
(paren
id|jiffies
op_ge
id|timeout
)paren
id|TIMEOUT_MSG
c_func
(paren
id|__LINE__
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * configure adapter to receive broadcast messages and wait for response&n;&t; */
r_if
c_cond
(paren
id|elp_debug
op_ge
l_int|3
)paren
id|printk
c_func
(paren
l_string|&quot;%s: sending 82586 configure command&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|adapter-&gt;tx_pcb.command
op_assign
id|CMD_CONFIGURE_82586
suffix:semicolon
id|adapter-&gt;tx_pcb.data.configure
op_assign
id|NO_LOOPBACK
op_or
id|RECV_BROAD
suffix:semicolon
id|adapter-&gt;tx_pcb.length
op_assign
l_int|2
suffix:semicolon
id|adapter-&gt;got
(braket
id|CMD_CONFIGURE_82586
)braket
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|send_pcb
c_func
(paren
id|dev
comma
op_amp
id|adapter-&gt;tx_pcb
)paren
)paren
id|printk
c_func
(paren
l_string|&quot;%s: couldn&squot;t send 82586 configure command&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_else
(brace
r_int
id|timeout
op_assign
id|jiffies
op_plus
id|TIMEOUT
suffix:semicolon
r_while
c_loop
(paren
id|adapter-&gt;got
(braket
id|CMD_CONFIGURE_82586
)braket
op_eq
l_int|0
op_logical_and
id|jiffies
OL
id|timeout
)paren
suffix:semicolon
r_if
c_cond
(paren
id|jiffies
op_ge
id|timeout
)paren
id|TIMEOUT_MSG
c_func
(paren
id|__LINE__
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * queue receive commands to provide buffering&n;&t; */
r_if
c_cond
(paren
op_logical_neg
id|start_receive
c_func
(paren
id|dev
comma
op_amp
id|adapter-&gt;tx_pcb
)paren
)paren
id|printk
c_func
(paren
l_string|&quot;%s: start receive command failed &bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_if
c_cond
(paren
id|elp_debug
op_ge
l_int|3
)paren
id|printk
c_func
(paren
l_string|&quot;%s: start receive command sent&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
macro_line|#ifdef MODULE
id|MOD_INC_USE_COUNT
suffix:semicolon
macro_line|#endif
r_return
l_int|0
suffix:semicolon
multiline_comment|/* Always succeed */
)brace
multiline_comment|/******************************************************&n; *&n; * send a packet to the adapter&n; *&n; ******************************************************/
r_static
r_int
DECL|function|send_packet
id|send_packet
(paren
r_struct
id|device
op_star
id|dev
comma
r_int
r_char
op_star
id|ptr
comma
r_int
id|len
)paren
(brace
r_int
id|i
suffix:semicolon
r_int
id|timeout
op_assign
l_int|0
suffix:semicolon
id|elp_device
op_star
id|adapter
suffix:semicolon
multiline_comment|/*&n;&t; * make sure the length is even and no shorter than 60 bytes&n;&t; */
r_int
r_int
id|nlen
op_assign
(paren
(paren
(paren
id|len
OL
l_int|60
)paren
ques
c_cond
l_int|60
suffix:colon
id|len
)paren
op_plus
l_int|1
)paren
op_amp
(paren
op_complement
l_int|1
)paren
suffix:semicolon
id|CHECK_NULL
c_func
(paren
id|dev
)paren
suffix:semicolon
id|CHECK_NULL
c_func
(paren
id|ptr
)paren
suffix:semicolon
id|adapter
op_assign
id|dev-&gt;priv
suffix:semicolon
r_if
c_cond
(paren
id|nlen
OL
id|len
)paren
id|printk
c_func
(paren
l_string|&quot;Warning, bad length nlen=%d len=%d %s(%d)&bslash;n&quot;
comma
id|nlen
comma
id|len
comma
id|filename
comma
id|__LINE__
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * send the adapter a transmit packet command. Ignore segment and offset&n;&t; * and make sure the length is even&n;&t; */
id|adapter-&gt;tx_pcb.command
op_assign
id|CMD_TRANSMIT_PACKET
suffix:semicolon
id|adapter-&gt;tx_pcb.length
op_assign
r_sizeof
(paren
r_struct
id|Xmit_pkt
)paren
suffix:semicolon
id|adapter-&gt;tx_pcb.data.xmit_pkt.buf_ofs
op_assign
id|adapter-&gt;tx_pcb.data.xmit_pkt.buf_seg
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Unused */
id|adapter-&gt;tx_pcb.data.xmit_pkt.pkt_len
op_assign
id|nlen
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|send_pcb
c_func
(paren
id|dev
comma
op_amp
id|adapter-&gt;tx_pcb
)paren
)paren
(brace
r_return
id|FALSE
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * write data to the adapter&n;&t; */
id|cli
c_func
(paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
(paren
id|nlen
op_div
l_int|2
)paren
suffix:semicolon
id|i
op_increment
)paren
(brace
r_while
c_loop
(paren
(paren
(paren
id|inb_status
c_func
(paren
id|dev-&gt;base_addr
)paren
op_amp
id|HRDY
)paren
op_eq
l_int|0
)paren
op_logical_and
(paren
id|timeout
op_increment
OL
l_int|20000
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|timeout
op_ge
l_int|20000
)paren
(brace
id|sti
c_func
(paren
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;%s: timeout at %s(%d) writing word %d of %d ***&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|filename
comma
id|__LINE__
comma
id|i
comma
id|nlen
op_div
l_int|2
)paren
suffix:semicolon
r_return
id|FALSE
suffix:semicolon
)brace
id|outw_data
c_func
(paren
op_star
(paren
r_int
op_star
)paren
id|ptr
comma
id|dev-&gt;base_addr
)paren
suffix:semicolon
id|ptr
op_add_assign
l_int|2
suffix:semicolon
)brace
id|sti
c_func
(paren
)paren
suffix:semicolon
r_return
id|TRUE
suffix:semicolon
)brace
multiline_comment|/******************************************************&n; *&n; * start the transmitter&n; *    return 0 if sent OK, else return 1&n; *&n; ******************************************************/
r_static
r_int
DECL|function|elp_start_xmit
id|elp_start_xmit
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|device
op_star
id|dev
)paren
(brace
id|CHECK_NULL
c_func
(paren
id|dev
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * not sure what this does, but the 3c509 driver does it, so...&n;&t; */
r_if
c_cond
(paren
id|skb
op_eq
l_int|NULL
)paren
(brace
id|dev_tint
c_func
(paren
id|dev
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * if we ended up with a munged length, don&squot;t send it&n;&t; */
r_if
c_cond
(paren
id|skb-&gt;len
op_le
l_int|0
)paren
r_return
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|elp_debug
op_ge
l_int|3
)paren
id|printk
c_func
(paren
l_string|&quot;%s: request to send packet of length %d&bslash;n&quot;
comma
id|dev-&gt;name
comma
(paren
r_int
)paren
id|skb-&gt;len
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * if the transmitter is still busy, we have a transmit timeout...&n;&t; */
r_if
c_cond
(paren
id|dev-&gt;tbusy
)paren
(brace
r_int
id|tickssofar
op_assign
id|jiffies
op_minus
id|dev-&gt;trans_start
suffix:semicolon
r_int
id|stat
suffix:semicolon
r_if
c_cond
(paren
id|tickssofar
OL
l_int|50
)paren
multiline_comment|/* was 500, AJT */
r_return
l_int|1
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;%s: transmit timed out, not resetting adapter&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
(paren
id|stat
op_assign
id|inb_status
c_func
(paren
id|dev-&gt;base_addr
)paren
)paren
op_amp
id|ACRF
)paren
op_ne
l_int|0
)paren
id|printk
c_func
(paren
l_string|&quot;%s: hmmm...seemed to have missed an interrupt!&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;%s: status %#02x&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|stat
)paren
suffix:semicolon
id|dev-&gt;trans_start
op_assign
id|jiffies
suffix:semicolon
id|dev-&gt;tbusy
op_assign
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * send the packet at skb-&gt;data for skb-&gt;len&n;&t; */
r_if
c_cond
(paren
op_logical_neg
id|send_packet
c_func
(paren
id|dev
comma
id|skb-&gt;data
comma
id|skb-&gt;len
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%s: send packet PCB failed&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|elp_debug
op_ge
l_int|3
)paren
id|printk
c_func
(paren
l_string|&quot;%s: packet of length %d sent&bslash;n&quot;
comma
id|dev-&gt;name
comma
(paren
r_int
)paren
id|skb-&gt;len
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * start the transmit timeout&n;&t; */
id|dev-&gt;trans_start
op_assign
id|jiffies
suffix:semicolon
multiline_comment|/*&n;&t; * the transmitter is now busy&n;&t; */
id|dev-&gt;tbusy
op_assign
l_int|1
suffix:semicolon
multiline_comment|/*&n;&t; * free the buffer&n;&t; */
id|dev_kfree_skb
c_func
(paren
id|skb
comma
id|FREE_WRITE
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/******************************************************&n; *&n; * return statistics on the board&n; *&n; ******************************************************/
r_static
r_struct
id|enet_statistics
op_star
DECL|function|elp_get_stats
id|elp_get_stats
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
id|elp_device
op_star
id|adapter
op_assign
(paren
id|elp_device
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_if
c_cond
(paren
id|elp_debug
op_ge
l_int|3
)paren
id|printk
c_func
(paren
l_string|&quot;%s: request for stats&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
multiline_comment|/* If the device is closed, just return the latest stats we have,&n;&t;   - we cannot ask from the adapter without interrupts */
r_if
c_cond
(paren
op_logical_neg
id|dev-&gt;start
)paren
r_return
op_amp
id|adapter-&gt;stats
suffix:semicolon
multiline_comment|/* send a get statistics command to the board */
id|adapter-&gt;tx_pcb.command
op_assign
id|CMD_NETWORK_STATISTICS
suffix:semicolon
id|adapter-&gt;tx_pcb.length
op_assign
l_int|0
suffix:semicolon
id|adapter-&gt;got
(braket
id|CMD_NETWORK_STATISTICS
)braket
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|send_pcb
c_func
(paren
id|dev
comma
op_amp
id|adapter-&gt;tx_pcb
)paren
)paren
id|printk
c_func
(paren
l_string|&quot;%s: couldn&squot;t send get statistics command&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_else
(brace
r_int
id|timeout
op_assign
id|jiffies
op_plus
id|TIMEOUT
suffix:semicolon
r_while
c_loop
(paren
id|adapter-&gt;got
(braket
id|CMD_NETWORK_STATISTICS
)braket
op_eq
l_int|0
op_logical_and
id|jiffies
OL
id|timeout
)paren
suffix:semicolon
r_if
c_cond
(paren
id|jiffies
op_ge
id|timeout
)paren
(brace
id|TIMEOUT_MSG
c_func
(paren
id|__LINE__
)paren
suffix:semicolon
r_return
op_amp
id|adapter-&gt;stats
suffix:semicolon
)brace
)brace
multiline_comment|/* statistics are now up to date */
r_return
op_amp
id|adapter-&gt;stats
suffix:semicolon
)brace
multiline_comment|/******************************************************&n; *&n; * close the board&n; *&n; ******************************************************/
r_static
r_int
DECL|function|elp_close
id|elp_close
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
id|elp_device
op_star
id|adapter
suffix:semicolon
id|CHECK_NULL
c_func
(paren
id|dev
)paren
suffix:semicolon
id|adapter
op_assign
id|dev-&gt;priv
suffix:semicolon
id|CHECK_NULL
c_func
(paren
id|adapter
)paren
suffix:semicolon
r_if
c_cond
(paren
id|elp_debug
op_ge
l_int|3
)paren
id|printk
c_func
(paren
l_string|&quot;%s: request to close device&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
multiline_comment|/* Someone may request the device statistic information even when&n;&t; * the interface is closed. The following will update the statistics&n;&t; * structure in the driver, so we&squot;ll be able to give current statistics.&n;&t; */
(paren
r_void
)paren
id|elp_get_stats
c_func
(paren
id|dev
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * disable interrupts on the board&n;&t; */
id|outb_control
c_func
(paren
l_int|0x00
comma
id|dev-&gt;base_addr
)paren
suffix:semicolon
multiline_comment|/*&n;&t; *  flag transmitter as busy (i.e. not available)&n;&t; */
id|dev-&gt;tbusy
op_assign
l_int|1
suffix:semicolon
multiline_comment|/*&n;&t; *  indicate device is closed&n;&t; */
id|dev-&gt;start
op_assign
l_int|0
suffix:semicolon
multiline_comment|/*&n;&t; * release the IRQ&n;&t; */
id|free_irq
c_func
(paren
id|dev-&gt;irq
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * and we no longer have to map irq to dev either&n;&t; */
id|irq2dev_map
(braket
id|dev-&gt;irq
)braket
op_assign
l_int|0
suffix:semicolon
macro_line|#ifdef MODULE
id|MOD_DEC_USE_COUNT
suffix:semicolon
macro_line|#endif
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/************************************************************&n; *&n; * Set multicast list&n; * num_addrs==0: clear mc_list&n; * num_addrs==-1: set promiscuous mode&n; * num_addrs&gt;0: set mc_list&n; *&n; ************************************************************/
r_static
r_void
DECL|function|elp_set_mc_list
id|elp_set_mc_list
(paren
r_struct
id|device
op_star
id|dev
comma
r_int
id|num_addrs
comma
r_void
op_star
id|addrs
)paren
(brace
id|elp_device
op_star
id|adapter
op_assign
(paren
id|elp_device
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_int
id|i
suffix:semicolon
r_if
c_cond
(paren
id|elp_debug
op_ge
l_int|3
)paren
id|printk
c_func
(paren
l_string|&quot;%s: request to set multicast list&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_if
c_cond
(paren
id|num_addrs
op_ne
op_minus
l_int|1
)paren
(brace
multiline_comment|/* send a &quot;load multicast list&quot; command to the board, max 10 addrs/cmd */
multiline_comment|/* if num_addrs==0 the list will be cleared */
id|adapter-&gt;tx_pcb.command
op_assign
id|CMD_LOAD_MULTICAST_LIST
suffix:semicolon
id|adapter-&gt;tx_pcb.length
op_assign
l_int|6
op_star
id|num_addrs
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|num_addrs
suffix:semicolon
id|i
op_increment
)paren
id|memcpy
c_func
(paren
id|adapter-&gt;tx_pcb.data.multicast
(braket
id|i
)braket
comma
id|addrs
op_plus
l_int|6
op_star
id|i
comma
l_int|6
)paren
suffix:semicolon
id|adapter-&gt;got
(braket
id|CMD_LOAD_MULTICAST_LIST
)braket
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|send_pcb
c_func
(paren
id|dev
comma
op_amp
id|adapter-&gt;tx_pcb
)paren
)paren
id|printk
c_func
(paren
l_string|&quot;%s: couldn&squot;t send set_multicast command&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_else
(brace
r_int
id|timeout
op_assign
id|jiffies
op_plus
id|TIMEOUT
suffix:semicolon
r_while
c_loop
(paren
id|adapter-&gt;got
(braket
id|CMD_LOAD_MULTICAST_LIST
)braket
op_eq
l_int|0
op_logical_and
id|jiffies
OL
id|timeout
)paren
suffix:semicolon
r_if
c_cond
(paren
id|jiffies
op_ge
id|timeout
)paren
(brace
id|TIMEOUT_MSG
c_func
(paren
id|__LINE__
)paren
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|num_addrs
)paren
id|adapter-&gt;tx_pcb.data.configure
op_assign
id|NO_LOOPBACK
op_or
id|RECV_BROAD
op_or
id|RECV_MULTI
suffix:semicolon
r_else
multiline_comment|/* num_addrs == 0 */
id|adapter-&gt;tx_pcb.data.configure
op_assign
id|NO_LOOPBACK
op_or
id|RECV_BROAD
suffix:semicolon
)brace
r_else
multiline_comment|/* num_addrs == -1 */
id|adapter-&gt;tx_pcb.data.configure
op_assign
id|NO_LOOPBACK
op_or
id|RECV_PROMISC
suffix:semicolon
multiline_comment|/*&n;&t; * configure adapter to receive messages (as specified above)&n;&t; * and wait for response&n;&t; */
r_if
c_cond
(paren
id|elp_debug
op_ge
l_int|3
)paren
id|printk
c_func
(paren
l_string|&quot;%s: sending 82586 configure command&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|adapter-&gt;tx_pcb.command
op_assign
id|CMD_CONFIGURE_82586
suffix:semicolon
id|adapter-&gt;tx_pcb.length
op_assign
l_int|2
suffix:semicolon
id|adapter-&gt;got
(braket
id|CMD_CONFIGURE_82586
)braket
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|send_pcb
c_func
(paren
id|dev
comma
op_amp
id|adapter-&gt;tx_pcb
)paren
)paren
id|printk
c_func
(paren
l_string|&quot;%s: couldn&squot;t send 82586 configure command&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_else
(brace
r_int
id|timeout
op_assign
id|jiffies
op_plus
id|TIMEOUT
suffix:semicolon
r_while
c_loop
(paren
id|adapter-&gt;got
(braket
id|CMD_CONFIGURE_82586
)braket
op_eq
l_int|0
op_logical_and
id|jiffies
OL
id|timeout
)paren
suffix:semicolon
r_if
c_cond
(paren
id|jiffies
op_ge
id|timeout
)paren
id|TIMEOUT_MSG
c_func
(paren
id|__LINE__
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/******************************************************&n; *&n; * initialise Etherlink Plus board&n; *&n; ******************************************************/
r_static
r_void
DECL|function|elp_init
id|elp_init
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
id|elp_device
op_star
id|adapter
suffix:semicolon
id|CHECK_NULL
c_func
(paren
id|dev
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * set ptrs to various functions&n;&t; */
id|dev-&gt;open
op_assign
id|elp_open
suffix:semicolon
multiline_comment|/* local */
id|dev-&gt;stop
op_assign
id|elp_close
suffix:semicolon
multiline_comment|/* local */
id|dev-&gt;get_stats
op_assign
id|elp_get_stats
suffix:semicolon
multiline_comment|/* local */
id|dev-&gt;hard_start_xmit
op_assign
id|elp_start_xmit
suffix:semicolon
multiline_comment|/* local */
id|dev-&gt;set_multicast_list
op_assign
id|elp_set_mc_list
suffix:semicolon
multiline_comment|/* local */
multiline_comment|/* Setup the generic properties */
id|ether_setup
c_func
(paren
id|dev
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * setup ptr to adapter specific information&n;&t; */
id|adapter
op_assign
(paren
id|elp_device
op_star
)paren
(paren
id|dev-&gt;priv
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
id|elp_device
)paren
comma
id|GFP_KERNEL
)paren
)paren
suffix:semicolon
id|CHECK_NULL
c_func
(paren
id|adapter
)paren
suffix:semicolon
id|memset
c_func
(paren
op_amp
(paren
id|adapter-&gt;stats
)paren
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|enet_statistics
)paren
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * memory information&n;&t; */
id|dev-&gt;mem_start
op_assign
id|dev-&gt;mem_end
op_assign
id|dev-&gt;rmem_end
op_assign
id|dev-&gt;rmem_start
op_assign
l_int|0
suffix:semicolon
)brace
multiline_comment|/************************************************************&n; *&n; * A couple of tests to see if there&squot;s 3C505 or not&n; * Called only by elp_autodetect&n; ************************************************************/
r_static
r_int
DECL|function|elp_sense
id|elp_sense
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
r_int
id|timeout
suffix:semicolon
r_int
id|addr
op_assign
id|dev-&gt;base_addr
suffix:semicolon
r_const
r_char
op_star
id|name
op_assign
id|dev-&gt;name
suffix:semicolon
id|byte
id|orig_HCR
op_assign
id|inb_control
c_func
(paren
id|addr
)paren
comma
id|orig_HSR
op_assign
id|inb_status
c_func
(paren
id|addr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|elp_debug
OG
l_int|0
)paren
id|printk
c_func
(paren
id|search_msg
comma
id|name
comma
id|addr
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
(paren
id|orig_HCR
op_eq
l_int|0xff
)paren
op_logical_and
(paren
id|orig_HSR
op_eq
l_int|0xff
)paren
)paren
op_logical_or
(paren
(paren
id|orig_HCR
op_amp
id|DIR
)paren
op_ne
(paren
id|orig_HSR
op_amp
id|DIR
)paren
)paren
)paren
(brace
r_if
c_cond
(paren
id|elp_debug
OG
l_int|0
)paren
id|printk
c_func
(paren
id|notfound_msg
comma
l_int|1
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
multiline_comment|/* It can&squot;t be 3c505 if HCR.DIR != HSR.DIR */
)brace
multiline_comment|/* Wait for a while; the adapter may still be booting up */
r_if
c_cond
(paren
id|elp_debug
OG
l_int|0
)paren
id|printk
c_func
(paren
id|stilllooking_msg
)paren
suffix:semicolon
r_for
c_loop
(paren
id|timeout
op_assign
id|jiffies
op_plus
(paren
l_int|100
op_star
l_int|15
)paren
suffix:semicolon
id|jiffies
op_le
id|timeout
suffix:semicolon
)paren
r_if
c_cond
(paren
id|GET_ASF
c_func
(paren
id|addr
)paren
op_ne
id|ASF_PCB_END
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
id|orig_HCR
op_amp
id|DIR
)paren
(brace
multiline_comment|/* If HCR.DIR is up, we pull it down. HSR.DIR should follow. */
id|outb_control
c_func
(paren
id|orig_HCR
op_amp
op_complement
id|DIR
comma
id|addr
)paren
suffix:semicolon
id|timeout
op_assign
id|jiffies
op_plus
l_int|30
suffix:semicolon
r_while
c_loop
(paren
id|jiffies
OL
id|timeout
)paren
suffix:semicolon
r_if
c_cond
(paren
id|inb_status
c_func
(paren
id|addr
)paren
op_amp
id|DIR
)paren
(brace
id|outb_control
c_func
(paren
id|orig_HCR
comma
id|addr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|elp_debug
OG
l_int|0
)paren
id|printk
c_func
(paren
id|notfound_msg
comma
l_int|2
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
)brace
r_else
(brace
multiline_comment|/* If HCR.DIR is down, we pull it up. HSR.DIR should follow. */
id|outb_control
c_func
(paren
id|orig_HCR
op_or
id|DIR
comma
id|addr
)paren
suffix:semicolon
id|timeout
op_assign
id|jiffies
op_plus
l_int|300
suffix:semicolon
r_while
c_loop
(paren
id|jiffies
OL
id|timeout
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|inb_status
c_func
(paren
id|addr
)paren
op_amp
id|DIR
)paren
)paren
(brace
id|outb_control
c_func
(paren
id|orig_HCR
comma
id|addr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|elp_debug
OG
l_int|0
)paren
id|printk
c_func
(paren
id|notfound_msg
comma
l_int|3
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
)brace
multiline_comment|/*&n;&t; * It certainly looks like a 3c505. If it has DMA enabled, it needs&n;&t; * a hard reset. Also, do a hard reset if selected at the compile time.&n;&t; */
r_if
c_cond
(paren
id|elp_debug
OG
l_int|0
)paren
id|printk
c_func
(paren
id|found_msg
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
(paren
id|orig_HCR
op_eq
l_int|0x35
)paren
op_logical_and
(paren
id|orig_HSR
op_eq
l_int|0x5b
)paren
)paren
op_logical_or
id|ELP_NEED_HARD_RESET
)paren
id|adapter_hard_reset
c_func
(paren
id|dev
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*************************************************************&n; *&n; * Search through addr_list[] and try to find a 3C505&n; * Called only by eplus_probe&n; *************************************************************/
r_static
r_int
DECL|function|elp_autodetect
id|elp_autodetect
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
r_int
id|idx
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* if base address set, then only check that address&n;&t;otherwise, run through the table */
r_if
c_cond
(paren
id|dev-&gt;base_addr
op_ne
l_int|0
)paren
(brace
multiline_comment|/* dev-&gt;base_addr == 0 ==&gt; plain autodetect */
r_if
c_cond
(paren
id|elp_sense
c_func
(paren
id|dev
)paren
op_eq
l_int|0
)paren
r_return
id|dev-&gt;base_addr
suffix:semicolon
)brace
r_else
r_while
c_loop
(paren
(paren
id|dev-&gt;base_addr
op_assign
id|addr_list
(braket
id|idx
op_increment
)braket
)paren
)paren
(brace
r_if
c_cond
(paren
id|elp_sense
c_func
(paren
id|dev
)paren
op_eq
l_int|0
)paren
r_return
id|dev-&gt;base_addr
suffix:semicolon
)brace
multiline_comment|/* could not find an adapter */
r_if
c_cond
(paren
id|elp_debug
OG
l_int|0
)paren
id|printk
c_func
(paren
id|couldnot_msg
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
multiline_comment|/* Because of this, the layer above will return -ENODEV */
)brace
multiline_comment|/******************************************************&n; *&n; * probe for an Etherlink Plus board at the specified address&n; *&n; ******************************************************/
r_int
DECL|function|elplus_probe
id|elplus_probe
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
id|elp_device
id|adapter
suffix:semicolon
r_int
id|i
suffix:semicolon
id|CHECK_NULL
c_func
(paren
id|dev
)paren
suffix:semicolon
multiline_comment|/*&n;&t; *  setup adapter structure&n;&t; */
id|dev-&gt;base_addr
op_assign
id|elp_autodetect
c_func
(paren
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|dev-&gt;base_addr
)paren
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
multiline_comment|/*&n;&t; *  As we enter here from bootup, the adapter should have IRQs enabled,&n;&t; *  but we can as well enable them anyway.&n;&t; */
id|outb_control
c_func
(paren
id|inb_control
c_func
(paren
id|dev-&gt;base_addr
)paren
op_or
id|CMDE
comma
id|dev-&gt;base_addr
)paren
suffix:semicolon
id|autoirq_setup
c_func
(paren
l_int|0
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * use ethernet address command to probe for board in polled mode&n;&t; * (this also makes us the IRQ that we need for automatic detection)&n;&t; */
id|adapter.tx_pcb.command
op_assign
id|CMD_STATION_ADDRESS
suffix:semicolon
id|adapter.tx_pcb.length
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|send_pcb
(paren
id|dev
comma
op_amp
id|adapter.tx_pcb
)paren
op_logical_or
op_logical_neg
id|receive_pcb
c_func
(paren
id|dev
comma
op_amp
id|adapter.rx_pcb
)paren
op_logical_or
(paren
id|adapter.rx_pcb.command
op_ne
id|CMD_ADDRESS_RESPONSE
)paren
op_logical_or
(paren
id|adapter.rx_pcb.length
op_ne
l_int|6
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%s: not responding to first PCB&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
r_if
c_cond
(paren
id|dev-&gt;irq
)paren
(brace
multiline_comment|/* Is there a preset IRQ? */
r_if
c_cond
(paren
id|dev-&gt;irq
op_ne
id|autoirq_report
c_func
(paren
l_int|0
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%s: Detected IRQ doesn&squot;t match user-defined one.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
multiline_comment|/* if dev-&gt;irq == autoirq_report(0), all is well */
)brace
r_else
multiline_comment|/* No preset IRQ; just use what we can detect */
id|dev-&gt;irq
op_assign
id|autoirq_report
c_func
(paren
l_int|0
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|dev-&gt;irq
)paren
(brace
multiline_comment|/* Legal, sane? */
r_case
l_int|0
suffix:colon
id|printk
c_func
(paren
l_string|&quot;%s: No IRQ reported by autoirq_report().&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;%s: Check the jumpers of your 3c505 board.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
r_case
l_int|1
suffix:colon
r_case
l_int|6
suffix:colon
r_case
l_int|8
suffix:colon
r_case
l_int|13
suffix:colon
id|printk
c_func
(paren
l_string|&quot;%s: Impossible IRQ %d reported by autoirq_report().&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|dev-&gt;irq
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
multiline_comment|/*&n;&t; *  Now we have the IRQ number so we can disable the interrupts from&n;&t; *  the board until the board is opened.&n;&t; */
id|outb_control
c_func
(paren
id|inb_control
c_func
(paren
id|dev-&gt;base_addr
)paren
op_amp
op_complement
id|CMDE
comma
id|dev-&gt;base_addr
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * copy ethernet address into structure&n;&t; */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|6
suffix:semicolon
id|i
op_increment
)paren
id|dev-&gt;dev_addr
(braket
id|i
)braket
op_assign
id|adapter.rx_pcb.data.eth_addr
(braket
id|i
)braket
suffix:semicolon
multiline_comment|/*&n;&t; * print remainder of startup message&n;&t; */
id|printk
c_func
(paren
l_string|&quot;%s: 3c505 card found at I/O %#lx using IRQ%d&quot;
l_string|&quot; has address %02x:%02x:%02x:%02x:%02x:%02x&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|dev-&gt;base_addr
comma
id|dev-&gt;irq
comma
id|dev-&gt;dev_addr
(braket
l_int|0
)braket
comma
id|dev-&gt;dev_addr
(braket
l_int|1
)braket
comma
id|dev-&gt;dev_addr
(braket
l_int|2
)braket
comma
id|dev-&gt;dev_addr
(braket
l_int|3
)braket
comma
id|dev-&gt;dev_addr
(braket
l_int|4
)braket
comma
id|dev-&gt;dev_addr
(braket
l_int|5
)braket
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * and reserve the address region&n;&t; */
id|request_region
c_func
(paren
id|dev-&gt;base_addr
comma
l_int|16
comma
l_string|&quot;3c505&quot;
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * initialise the device&n;&t; */
id|elp_init
c_func
(paren
id|dev
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#ifdef MODULE
DECL|variable|kernel_version
r_char
id|kernel_version
(braket
)braket
op_assign
id|UTS_RELEASE
suffix:semicolon
DECL|variable|dev_3c505
r_static
r_struct
id|device
id|dev_3c505
op_assign
(brace
l_string|&quot;        &quot;
multiline_comment|/*&quot;3c505&quot;*/
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|NULL
comma
id|elplus_probe
)brace
suffix:semicolon
DECL|variable|io
r_int
id|io
op_assign
l_int|0x300
suffix:semicolon
DECL|variable|irq
r_int
id|irq
op_assign
l_int|0
suffix:semicolon
DECL|function|init_module
r_int
id|init_module
c_func
(paren
r_void
)paren
(brace
r_if
c_cond
(paren
id|io
op_eq
l_int|0
)paren
id|printk
c_func
(paren
l_string|&quot;3c505: You should not use auto-probing with insmod!&bslash;n&quot;
)paren
suffix:semicolon
id|dev_3c505.base_addr
op_assign
id|io
suffix:semicolon
id|dev_3c505.irq
op_assign
id|irq
suffix:semicolon
r_if
c_cond
(paren
id|register_netdev
c_func
(paren
op_amp
id|dev_3c505
)paren
op_ne
l_int|0
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;3c505: register_netdev() returned non-zero.&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
r_void
DECL|function|cleanup_module
id|cleanup_module
c_func
(paren
r_void
)paren
(brace
r_if
c_cond
(paren
id|MOD_IN_USE
)paren
id|printk
c_func
(paren
l_string|&quot;3c505: device busy, remove delayed&bslash;n&quot;
)paren
suffix:semicolon
r_else
(brace
id|unregister_netdev
c_func
(paren
op_amp
id|dev_3c505
)paren
suffix:semicolon
)brace
)brace
macro_line|#endif /* MODULE */
eof
