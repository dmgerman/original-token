multiline_comment|/*&n; * Linux ethernet device driver for the 3Com Etherlink Plus (3C505)&n; * &t;By Craig Southeren&n; *&n; * 3c505.c&t;This module implements an interface to the 3Com&n; *&t;&t;Etherlink Plus (3c505) ethernet card. Linux device &n; *&t;&t;driver interface reverse engineered from the Linux 3C509&n; *&t;&t;device drivers. Vital 3C505 information gleaned from&n; *&t;&t;the Crynwr packet driver&n; *&n; * Version:&t;@(#)3c505.c&t;0.1&t;23/09/93&n; *&n; * Authors:&t;Linux 3c505 device driver by:&n; *&t;&t;&t;Craig Southeren, &lt;geoffw@extro.ucc.su.oz.au&gt;&n; *              Linux 3C509 driver by:&n; *             &t;&t;Donald Becker, &lt;becker@super.org&gt;&n; *&t;&t;Crynwr packet driver by&n; *&t;&t;&t;Krishnan Gopalan and Gregg Stefancik,&n; * &t;&t;&t;   Clemson Univesity Engineering Computer Operations.&n; *&t;&t;&t;Portions of the code have been adapted from the 3c505&n; *&t;&t;&t;   driver for NCSA Telnet by Bruce Orchard and later&n; *&t;&t;&t;   modified by Warren Van Houten and krus@diku.dk.&n; *              3C505 technical information provided by&n; *                      Terry Murphy, of 3Com Network Adapter Division&n; *&t;&t;Special thanks to Juha Laiho, &lt;jlaiho@ichaos.nullnet.fi&gt;&n; *                     &n; */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/interrupt.h&gt;
macro_line|#include &lt;linux/ptrace.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/in.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#ifndef port_read
macro_line|#include &quot;iow.h&quot;
macro_line|#endif
macro_line|#include &lt;linux/netdevice.h&gt;
macro_line|#include &lt;linux/etherdevice.h&gt;
macro_line|#include &lt;linux/skbuff.h&gt;
macro_line|#include &quot;3c505.h&quot;
macro_line|#ifdef ELP_DEBUG
DECL|variable|elp_debug
r_static
r_int
id|elp_debug
op_assign
id|ELP_DEBUG
suffix:semicolon
macro_line|#else
DECL|variable|elp_debug
r_static
r_int
id|elp_debug
op_assign
l_int|0
suffix:semicolon
macro_line|#endif
multiline_comment|/*&n; *  0 = no messages&n; *  1 = messages when high level commands performed&n; *  2 = messages when low level commands performed&n; *  3 = messages when interrupts received&n; */
DECL|macro|ELP_VERSION
mdefine_line|#define&t;ELP_VERSION&t;&quot;0.1.0&quot;
r_extern
r_struct
id|device
op_star
id|irq2dev_map
(braket
l_int|16
)braket
suffix:semicolon
multiline_comment|/*****************************************************************&n; *&n; * useful macros&n; *&n; *****************************************************************/
DECL|macro|INB
mdefine_line|#define&t;INB(port)&t;inb((unsigned short)port) 
DECL|macro|OUTB
mdefine_line|#define&t;OUTB(val,port)&t;outb((unsigned char)val,(unsigned short)port);
macro_line|#ifndef&t;TRUE
DECL|macro|TRUE
mdefine_line|#define&t;TRUE&t;1
macro_line|#endif
macro_line|#ifndef&t;FALSE
DECL|macro|FALSE
mdefine_line|#define&t;FALSE&t;0
macro_line|#endif
multiline_comment|/*****************************************************************&n; *&n; * PCB structure&n; *&n; *****************************************************************/
r_typedef
r_struct
(brace
DECL|member|command
r_int
r_char
id|command
suffix:semicolon
multiline_comment|/* PCB command code */
DECL|member|length
r_int
r_char
id|length
suffix:semicolon
multiline_comment|/* PCB data length */
DECL|member|data
r_int
r_char
id|data
(braket
id|MAX_PCB_DATA
)braket
suffix:semicolon
multiline_comment|/* PCB data */
DECL|typedef|pcb_struct
)brace
id|pcb_struct
suffix:semicolon
multiline_comment|/*****************************************************************&n; *&n; *  structure to hold context information for adapter&n; *&n; *****************************************************************/
r_typedef
r_struct
(brace
DECL|member|io_addr
r_int
id|io_addr
suffix:semicolon
multiline_comment|/* base I/O address */
DECL|member|got_configure
r_int
id|got_configure
suffix:semicolon
multiline_comment|/* set to TRUE when configure response received */
DECL|member|tx_pcb
id|pcb_struct
id|tx_pcb
suffix:semicolon
multiline_comment|/* PCB for foreground sending */
DECL|member|rx_pcb
id|pcb_struct
id|rx_pcb
suffix:semicolon
multiline_comment|/* PCB for foreground receiving */
DECL|member|itx_pcb
id|pcb_struct
id|itx_pcb
suffix:semicolon
multiline_comment|/* PCB for background sending */
DECL|member|irx_pcb
id|pcb_struct
id|irx_pcb
suffix:semicolon
multiline_comment|/* PCB for background receiving */
DECL|member|stats
r_struct
id|enet_statistics
id|stats
suffix:semicolon
DECL|typedef|elp_device
)brace
id|elp_device
suffix:semicolon
multiline_comment|/*****************************************************************&n; *&n; *  useful functions for accessing the adapter&n; *&n; *****************************************************************/
multiline_comment|/*&n; * use this routine when accessing the ASF bits as they are&n; * changed asynchronously by the adapter&n; */
multiline_comment|/* get adapter PCB status */
DECL|macro|GET_ASF
mdefine_line|#define&t;GET_ASF()  &t;(get_status(adapter)&amp;ASF_PCB_MASK)
DECL|macro|GET_STATUS
mdefine_line|#define&t;GET_STATUS()  &t;(get_status(adapter))
DECL|function|get_status
r_static
r_int
id|get_status
(paren
id|elp_device
op_star
id|adapter
)paren
(brace
r_register
r_int
id|stat1
suffix:semicolon
r_do
(brace
id|stat1
op_assign
id|INB
c_func
(paren
id|adapter-&gt;io_addr
op_plus
id|PORT_STATUS
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
id|stat1
op_ne
id|INB
c_func
(paren
id|adapter-&gt;io_addr
op_plus
id|PORT_STATUS
)paren
)paren
suffix:semicolon
r_return
id|stat1
suffix:semicolon
)brace
DECL|macro|SET_HSF
mdefine_line|#define&t;SET_HSF(hsf)&t;(set_hsf(adapter,hsf))
DECL|function|set_hsf
r_static
r_void
id|set_hsf
(paren
id|elp_device
op_star
id|adapter
comma
r_int
id|hsf
)paren
(brace
id|cli
c_func
(paren
)paren
suffix:semicolon
id|OUTB
c_func
(paren
(paren
id|INB
c_func
(paren
id|adapter-&gt;io_addr
op_plus
id|PORT_CONTROL
)paren
op_amp
(paren
op_complement
id|HSF_PCB_MASK
)paren
)paren
op_or
id|hsf
comma
id|adapter-&gt;io_addr
op_plus
id|PORT_CONTROL
)paren
suffix:semicolon
id|sti
c_func
(paren
)paren
suffix:semicolon
)brace
DECL|macro|WAIT_HCRE
mdefine_line|#define&t;WAIT_HCRE(toval)&t;(wait_hcre(adapter,toval))
DECL|function|wait_hcre
r_static
r_int
id|wait_hcre
c_func
(paren
id|elp_device
op_star
id|adapter
comma
r_int
id|toval
)paren
(brace
r_int
id|timeout
op_assign
id|jiffies
op_plus
id|toval
suffix:semicolon
r_while
c_loop
(paren
(paren
(paren
id|INB
c_func
(paren
id|adapter-&gt;io_addr
op_plus
id|PORT_STATUS
)paren
op_amp
id|STATUS_HCRE
)paren
op_eq
l_int|0
)paren
op_logical_and
(paren
id|jiffies
op_le
id|timeout
)paren
)paren
(brace
suffix:semicolon
)brace
r_if
c_cond
(paren
id|jiffies
OG
id|timeout
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;elp0: timeout waiting for HCRE&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|FALSE
suffix:semicolon
)brace
r_return
id|TRUE
suffix:semicolon
)brace
multiline_comment|/*****************************************************************&n; *&n; * send_pcb&n; *   Send a PCB to the adapter. &n; *&n; *&t;output byte to command reg  --&lt;--+&n; *&t;wait until HCRE is non zero      |&n; *&t;loop until all bytes sent   --&gt;--+&n; *&t;set HSF1 and HSF2 to 1&n; *&t;output pcb length&n; *&t;wait until ASF give ACK or NAK&n; *&t;set HSF1 and HSF2 to 0&n; *&n; *****************************************************************/
DECL|function|send_pcb
r_static
r_int
id|send_pcb
c_func
(paren
id|elp_device
op_star
id|adapter
comma
id|pcb_struct
op_star
id|pcb
)paren
(brace
r_int
id|i
suffix:semicolon
r_int
id|cont
suffix:semicolon
r_int
id|retry
op_assign
l_int|0
suffix:semicolon
r_int
id|timeout
suffix:semicolon
r_while
c_loop
(paren
l_int|1
)paren
(brace
id|cont
op_assign
l_int|1
suffix:semicolon
multiline_comment|/*&n;     * load each byte into the command register and&n;     * wait for the HCRE bit to indicate the adapter&n;     * had read the byte&n;     */
id|SET_HSF
c_func
(paren
l_int|0
)paren
suffix:semicolon
id|OUTB
c_func
(paren
id|pcb-&gt;command
comma
(paren
id|adapter-&gt;io_addr
)paren
op_plus
id|PORT_COMMAND
)paren
suffix:semicolon
id|cont
op_assign
id|WAIT_HCRE
c_func
(paren
l_int|5
)paren
suffix:semicolon
multiline_comment|/* SET_HSF(0);  */
r_if
c_cond
(paren
id|cont
)paren
(brace
id|OUTB
c_func
(paren
id|pcb-&gt;length
comma
(paren
id|adapter-&gt;io_addr
)paren
op_plus
id|PORT_COMMAND
)paren
suffix:semicolon
id|cont
op_assign
id|WAIT_HCRE
c_func
(paren
l_int|2
)paren
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|cont
op_logical_and
(paren
id|i
OL
id|pcb-&gt;length
)paren
suffix:semicolon
id|i
op_increment
)paren
(brace
id|OUTB
c_func
(paren
id|pcb-&gt;data
(braket
id|i
)braket
comma
(paren
id|adapter-&gt;io_addr
)paren
op_plus
id|PORT_COMMAND
)paren
suffix:semicolon
id|cont
op_assign
id|WAIT_HCRE
c_func
(paren
l_int|2
)paren
suffix:semicolon
)brace
multiline_comment|/* set the host status bits to indicate end of PCB */
multiline_comment|/* send the total packet length as well */
multiline_comment|/* wait for the adapter to indicate that it has read the PCB */
r_if
c_cond
(paren
id|cont
)paren
(brace
id|SET_HSF
c_func
(paren
id|HSF_PCB_END
)paren
suffix:semicolon
id|OUTB
c_func
(paren
l_int|2
op_plus
id|pcb-&gt;length
comma
id|adapter-&gt;io_addr
op_plus
id|PORT_COMMAND
)paren
suffix:semicolon
id|timeout
op_assign
id|jiffies
op_plus
l_int|6
suffix:semicolon
r_while
c_loop
(paren
id|jiffies
OL
id|timeout
)paren
(brace
id|i
op_assign
id|GET_ASF
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|i
op_eq
id|ASF_PCB_ACK
)paren
op_logical_or
(paren
id|i
op_eq
id|ASF_PCB_NAK
)paren
)paren
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|i
op_eq
id|ASF_PCB_ACK
)paren
(brace
id|SET_HSF
c_func
(paren
l_int|0
)paren
suffix:semicolon
r_return
id|TRUE
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|i
op_assign
id|ASF_PCB_NAK
)paren
(brace
id|SET_HSF
c_func
(paren
l_int|0
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;elp0: PCB send was NAKed&bslash;n&quot;
)paren
suffix:semicolon
(brace
r_int
id|to
op_assign
id|jiffies
op_plus
l_int|5
suffix:semicolon
r_while
c_loop
(paren
id|jiffies
OL
id|to
)paren
suffix:semicolon
)brace
)brace
)brace
r_if
c_cond
(paren
id|elp_debug
op_ge
l_int|6
)paren
id|printk
c_func
(paren
l_string|&quot;elp0: NAK/timeout on send PCB&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|retry
op_increment
op_amp
l_int|7
)paren
op_eq
l_int|0
)paren
id|printk
c_func
(paren
l_string|&quot;elp0: retry #%i on send PCB&bslash;n&quot;
comma
id|retry
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/*****************************************************************&n; *&n; * receive_pcb&n; *   Read a PCB to the adapter&n; *&n; *&t;wait for ACRF to be non-zero         ---&lt;---+&n; *      input a byte                                |&n; *      if ASF1 and ASF2 were not both one          |&n; *           before byte was read, loop      ---&gt;---+&n; *      set HSF1 and HSF2 for ack&n; *&n; *****************************************************************/
DECL|function|receive_pcb
r_static
r_int
id|receive_pcb
c_func
(paren
id|elp_device
op_star
id|adapter
comma
id|pcb_struct
op_star
id|pcb
)paren
(brace
r_int
id|i
suffix:semicolon
r_int
id|total_length
suffix:semicolon
r_int
id|stat
suffix:semicolon
multiline_comment|/* get the command code */
r_while
c_loop
(paren
(paren
(paren
id|stat
op_assign
id|GET_STATUS
c_func
(paren
)paren
)paren
op_amp
id|STATUS_ACRF
)paren
op_eq
l_int|0
)paren
suffix:semicolon
id|SET_HSF
c_func
(paren
l_int|0
)paren
suffix:semicolon
id|pcb-&gt;command
op_assign
id|INB
c_func
(paren
id|adapter-&gt;io_addr
op_plus
id|PORT_COMMAND
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|stat
op_amp
id|ASF_PCB_MASK
)paren
op_ne
id|ASF_PCB_END
)paren
(brace
multiline_comment|/* read the data length */
r_while
c_loop
(paren
(paren
(paren
id|stat
op_assign
id|GET_STATUS
c_func
(paren
)paren
)paren
op_amp
id|STATUS_ACRF
)paren
op_eq
l_int|0
)paren
suffix:semicolon
id|pcb-&gt;length
op_assign
id|INB
c_func
(paren
id|adapter-&gt;io_addr
op_plus
id|PORT_COMMAND
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|stat
op_amp
id|ASF_PCB_MASK
)paren
op_ne
id|ASF_PCB_END
)paren
(brace
multiline_comment|/* read the data */
id|i
op_assign
l_int|0
suffix:semicolon
r_do
(brace
r_while
c_loop
(paren
(paren
(paren
id|stat
op_assign
id|GET_STATUS
c_func
(paren
)paren
)paren
op_amp
id|STATUS_ACRF
)paren
op_eq
l_int|0
)paren
suffix:semicolon
id|pcb-&gt;data
(braket
id|i
op_increment
)braket
op_assign
id|INB
c_func
(paren
id|adapter-&gt;io_addr
op_plus
id|PORT_COMMAND
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
(paren
id|stat
op_amp
id|ASF_PCB_MASK
)paren
op_ne
id|ASF_PCB_END
)paren
suffix:semicolon
multiline_comment|/* woops, the last &quot;data&quot; byte was really the length! */
id|total_length
op_assign
id|pcb-&gt;data
(braket
op_decrement
id|i
)braket
suffix:semicolon
multiline_comment|/* safety check total length vs data length */
r_if
c_cond
(paren
id|total_length
op_ne
(paren
id|pcb-&gt;length
op_plus
l_int|2
)paren
)paren
(brace
r_if
c_cond
(paren
id|elp_debug
op_ge
l_int|6
)paren
id|printk
c_func
(paren
l_string|&quot;elp0: mangled PCB received&bslash;n&quot;
)paren
suffix:semicolon
id|SET_HSF
c_func
(paren
id|HSF_PCB_NAK
)paren
suffix:semicolon
r_return
id|FALSE
suffix:semicolon
)brace
id|SET_HSF
c_func
(paren
id|HSF_PCB_ACK
)paren
suffix:semicolon
r_return
id|TRUE
suffix:semicolon
)brace
)brace
id|SET_HSF
c_func
(paren
id|HSF_PCB_NAK
)paren
suffix:semicolon
r_return
id|FALSE
suffix:semicolon
)brace
DECL|function|adapter_hard_reset
r_static
r_void
id|adapter_hard_reset
c_func
(paren
id|elp_device
op_star
id|adapter
)paren
(brace
r_int
id|timeout
suffix:semicolon
multiline_comment|/*&n;   * take FLSH and ATTN high&n;   */
id|OUTB
c_func
(paren
id|CONTROL_ATTN
op_or
id|CONTROL_FLSH
comma
id|adapter-&gt;io_addr
op_plus
id|PORT_CONTROL
)paren
suffix:semicolon
multiline_comment|/*&n;   * wait for a little bit&n;   */
r_for
c_loop
(paren
id|timeout
op_assign
id|jiffies
op_plus
l_int|20
suffix:semicolon
id|jiffies
op_le
id|timeout
suffix:semicolon
)paren
suffix:semicolon
multiline_comment|/*&n;   * now take them low&n;   */
id|OUTB
c_func
(paren
l_int|0
comma
id|adapter-&gt;io_addr
op_plus
id|PORT_CONTROL
)paren
suffix:semicolon
multiline_comment|/*&n;   * wait for a little bit&n;   */
r_for
c_loop
(paren
id|timeout
op_assign
id|jiffies
op_plus
l_int|20
suffix:semicolon
id|jiffies
op_le
id|timeout
suffix:semicolon
)paren
suffix:semicolon
multiline_comment|/*&n;   * now hang around until the board gets it&squot;s act together&n;   */
r_for
c_loop
(paren
id|timeout
op_assign
id|jiffies
op_plus
(paren
l_int|100
op_star
l_int|15
)paren
suffix:semicolon
id|jiffies
op_le
id|timeout
suffix:semicolon
)paren
r_if
c_cond
(paren
id|GET_ASF
c_func
(paren
)paren
op_ne
id|ASF_PCB_END
)paren
r_break
suffix:semicolon
)brace
DECL|function|adapter_reset
r_static
r_void
id|adapter_reset
c_func
(paren
id|elp_device
op_star
id|adapter
)paren
(brace
r_int
id|timeout
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|OUTB
c_func
(paren
id|CONTROL_ATTN
op_or
id|INB
c_func
(paren
id|adapter-&gt;io_addr
op_plus
id|PORT_CONTROL
)paren
comma
id|adapter-&gt;io_addr
op_plus
id|PORT_CONTROL
)paren
suffix:semicolon
id|sti
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/*&n;   * wait for a little bit&n;   */
r_for
c_loop
(paren
id|timeout
op_assign
id|jiffies
op_plus
l_int|20
suffix:semicolon
id|jiffies
op_le
id|timeout
suffix:semicolon
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|OUTB
c_func
(paren
id|INB
c_func
(paren
id|adapter-&gt;io_addr
op_plus
id|PORT_CONTROL
)paren
op_amp
op_complement
(paren
id|CONTROL_ATTN
)paren
comma
id|adapter-&gt;io_addr
op_plus
id|PORT_CONTROL
)paren
suffix:semicolon
id|sti
c_func
(paren
)paren
suffix:semicolon
)brace
multiline_comment|/******************************************************&n; *&n; *  queue a receive command on the adapter so we will get an&n; *  interrupt when a packet is received.&n; *&n; ******************************************************/
DECL|function|start_receive
r_static
r_int
id|start_receive
c_func
(paren
id|elp_device
op_star
id|adapter
comma
id|pcb_struct
op_star
id|tx_pcb
)paren
(brace
r_if
c_cond
(paren
id|elp_debug
OG
l_int|3
)paren
id|printk
c_func
(paren
l_string|&quot;elp0: restarting receiver&bslash;n&quot;
)paren
suffix:semicolon
id|tx_pcb-&gt;command
op_assign
id|CMD_RECEIVE_PACKET
suffix:semicolon
id|tx_pcb-&gt;length
op_assign
l_int|8
suffix:semicolon
id|tx_pcb-&gt;data
(braket
l_int|4
)braket
op_assign
l_int|1600
op_amp
l_int|0xff
suffix:semicolon
id|tx_pcb-&gt;data
(braket
l_int|5
)braket
op_assign
l_int|1600
op_rshift
l_int|8
suffix:semicolon
id|tx_pcb-&gt;data
(braket
l_int|6
)braket
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* set timeout to zero */
id|tx_pcb-&gt;data
(braket
l_int|7
)braket
op_assign
l_int|0
suffix:semicolon
r_return
id|send_pcb
c_func
(paren
id|adapter
comma
id|tx_pcb
)paren
suffix:semicolon
)brace
multiline_comment|/******************************************************&n; *&n; * extract a packet from the adapter&n; * this routine is only called from within the interrupt&n; * service routine, so no cli/sti calls are needed&n; * note that the length is always assumed to be even&n; *&n; ******************************************************/
DECL|function|receive_packet
r_static
r_void
id|receive_packet
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
id|elp_device
op_star
id|adapter
comma
r_int
id|len
)paren
(brace
r_register
r_int
id|i
suffix:semicolon
r_int
r_int
op_star
id|ptr
suffix:semicolon
r_int
id|d
suffix:semicolon
multiline_comment|/*&n;   * allocate a buffer to put the packet into.&n;   */
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
id|skb
op_assign
id|alloc_skb
c_func
(paren
id|len
op_plus
l_int|3
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
multiline_comment|/*&n;   * make sure the data register is going the right way&n;   */
id|OUTB
c_func
(paren
id|INB
c_func
(paren
id|adapter-&gt;io_addr
op_plus
id|PORT_CONTROL
)paren
op_or
id|CONTROL_DIR
comma
id|adapter-&gt;io_addr
op_plus
id|PORT_CONTROL
)paren
suffix:semicolon
multiline_comment|/*&n;   * if buffer could not be allocated, swallow it&n;   */
r_if
c_cond
(paren
id|skb
op_eq
l_int|NULL
)paren
(brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
(paren
id|len
op_div
l_int|2
)paren
suffix:semicolon
id|i
op_increment
)paren
(brace
r_while
c_loop
(paren
(paren
id|INB
c_func
(paren
id|adapter-&gt;io_addr
op_plus
id|PORT_STATUS
)paren
op_amp
id|STATUS_HRDY
)paren
op_eq
l_int|0
)paren
suffix:semicolon
id|d
op_assign
id|inw
c_func
(paren
id|adapter-&gt;io_addr
op_plus
id|PORT_DATA
)paren
suffix:semicolon
)brace
id|adapter-&gt;stats.rx_dropped
op_increment
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/*&n;     * now read the data from the adapter&n;     */
id|ptr
op_assign
(paren
r_int
r_int
op_star
)paren
(paren
id|skb-&gt;data
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
(paren
id|len
op_div
l_int|2
)paren
suffix:semicolon
id|i
op_increment
)paren
(brace
r_while
c_loop
(paren
(paren
id|INB
c_func
(paren
id|adapter-&gt;io_addr
op_plus
id|PORT_STATUS
)paren
op_amp
id|STATUS_HRDY
)paren
op_eq
l_int|0
)paren
(brace
suffix:semicolon
)brace
op_star
id|ptr
op_assign
id|inw
c_func
(paren
id|adapter-&gt;io_addr
op_plus
id|PORT_DATA
)paren
suffix:semicolon
id|ptr
op_increment
suffix:semicolon
)brace
multiline_comment|/*&n;     * the magic routine &quot;dev_rint&quot; passes the packet up the&n;     * protocol chain. If it returns 0, we can assume the packet was&n;     * swallowed up. If not, then we are responsible for freeing memory&n;     */
r_if
c_cond
(paren
id|dev_rint
c_func
(paren
(paren
r_int
r_char
op_star
)paren
id|skb
comma
id|len
comma
id|IN_SKBUFF
comma
id|dev
)paren
op_ne
l_int|0
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%s: receive buffers full.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|kfree_skb
c_func
(paren
id|skb
comma
id|FREE_READ
)paren
suffix:semicolon
)brace
)brace
id|OUTB
c_func
(paren
id|INB
c_func
(paren
id|adapter-&gt;io_addr
op_plus
id|PORT_CONTROL
)paren
op_amp
(paren
op_complement
id|CONTROL_DIR
)paren
comma
id|adapter-&gt;io_addr
op_plus
id|PORT_CONTROL
)paren
suffix:semicolon
)brace
multiline_comment|/******************************************************&n; *&n; * interrupt handler&n; *&n; ******************************************************/
DECL|function|elp_interrupt
r_static
r_void
id|elp_interrupt
c_func
(paren
r_int
id|reg_ptr
)paren
(brace
r_int
id|len
suffix:semicolon
r_int
id|dlen
suffix:semicolon
r_int
id|irq
op_assign
op_minus
(paren
(paren
(paren
r_struct
id|pt_regs
op_star
)paren
id|reg_ptr
)paren
op_member_access_from_pointer
id|orig_eax
op_plus
l_int|2
)paren
suffix:semicolon
r_struct
id|device
op_star
id|dev
suffix:semicolon
id|elp_device
op_star
id|adapter
suffix:semicolon
r_if
c_cond
(paren
id|irq
template_param
l_int|15
)paren
(brace
id|printk
(paren
l_string|&quot;elp0: illegal IRQ number found in interrupt routine (%i)&bslash;n&quot;
comma
id|irq
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|irq
op_ne
l_int|0xc
)paren
(brace
id|printk
(paren
l_string|&quot;elp0: warning - interrupt routine has incorrect IRQ of %i&bslash;n&quot;
comma
id|irq
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|dev
op_assign
id|irq2dev_map
(braket
id|irq
)braket
suffix:semicolon
id|adapter
op_assign
(paren
id|elp_device
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_if
c_cond
(paren
id|dev
op_eq
l_int|NULL
)paren
(brace
id|printk
(paren
l_string|&quot;elp_interrupt(): irq %d for unknown device.&bslash;n&quot;
comma
id|irq
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|dev-&gt;interrupt
)paren
r_if
c_cond
(paren
id|elp_debug
op_ge
l_int|3
)paren
id|printk
c_func
(paren
l_string|&quot;%s: Re-entering the interrupt handler.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|dev-&gt;interrupt
op_assign
l_int|1
suffix:semicolon
multiline_comment|/*&n;   * allow interrupts (we need timers!)&n;   */
id|sti
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/*&n;   * receive a PCB from the adapter&n;   */
r_while
c_loop
(paren
(paren
id|INB
c_func
(paren
id|adapter-&gt;io_addr
op_plus
id|PORT_STATUS
)paren
op_amp
id|STATUS_ACRF
)paren
op_ne
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|receive_pcb
c_func
(paren
id|adapter
comma
op_amp
id|adapter-&gt;irx_pcb
)paren
)paren
(brace
r_switch
c_cond
(paren
id|adapter-&gt;irx_pcb.command
)paren
(brace
multiline_comment|/*&n;         * 82586 configured correctly&n;         */
r_case
id|CMD_CONFIGURE_82586_RESPONSE
suffix:colon
id|adapter-&gt;got_configure
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|elp_debug
op_ge
l_int|3
)paren
id|printk
c_func
(paren
l_string|&quot;%s: interrupt - configure response received&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_break
suffix:semicolon
multiline_comment|/*&n;         * received a packet&n;         */
r_case
id|CMD_RECEIVE_PACKET_COMPLETE
suffix:colon
id|len
op_assign
id|adapter-&gt;irx_pcb.data
(braket
l_int|6
)braket
op_plus
(paren
id|adapter-&gt;irx_pcb.data
(braket
l_int|7
)braket
op_lshift
l_int|8
)paren
suffix:semicolon
id|dlen
op_assign
id|adapter-&gt;irx_pcb.data
(braket
l_int|4
)braket
op_plus
(paren
id|adapter-&gt;irx_pcb.data
(braket
l_int|5
)braket
op_lshift
l_int|8
)paren
suffix:semicolon
r_if
c_cond
(paren
id|adapter-&gt;irx_pcb.data
(braket
l_int|8
)braket
op_ne
l_int|0
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%s: interrupt - packet not received correctly&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|elp_debug
op_ge
l_int|3
)paren
id|printk
c_func
(paren
l_string|&quot;%s: interrupt - packet received of length %i (%i)&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|len
comma
id|dlen
)paren
suffix:semicolon
id|receive_packet
c_func
(paren
id|dev
comma
id|adapter
comma
id|dlen
)paren
suffix:semicolon
r_if
c_cond
(paren
id|elp_debug
op_ge
l_int|3
)paren
id|printk
c_func
(paren
l_string|&quot;%s: packet received&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|adapter-&gt;stats.rx_packets
op_increment
suffix:semicolon
)brace
r_if
c_cond
(paren
id|dev-&gt;start
op_logical_and
op_logical_neg
id|start_receive
c_func
(paren
id|adapter
comma
op_amp
id|adapter-&gt;itx_pcb
)paren
)paren
r_if
c_cond
(paren
id|elp_debug
op_ge
l_int|2
)paren
id|printk
c_func
(paren
l_string|&quot;%s: interrupt - failed to send receive start PCB&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_if
c_cond
(paren
id|elp_debug
op_ge
l_int|3
)paren
id|printk
c_func
(paren
l_string|&quot;%s: receive procedure complete&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_break
suffix:semicolon
multiline_comment|/*&n;         * sent a packet&n;         */
r_case
id|CMD_TRANSMIT_PACKET_COMPLETE
suffix:colon
r_if
c_cond
(paren
id|elp_debug
op_ge
l_int|3
)paren
id|printk
c_func
(paren
l_string|&quot;%s: interrupt - packet sent&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_if
c_cond
(paren
id|adapter-&gt;irx_pcb.data
(braket
l_int|4
)braket
op_ne
l_int|0
)paren
r_if
c_cond
(paren
id|elp_debug
op_ge
l_int|2
)paren
id|printk
c_func
(paren
l_string|&quot;%s: interrupt - error sending packet %4.4x&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|adapter-&gt;irx_pcb.data
(braket
l_int|4
)braket
op_plus
(paren
id|adapter-&gt;irx_pcb.data
(braket
l_int|5
)braket
op_lshift
l_int|8
)paren
)paren
suffix:semicolon
id|dev-&gt;tbusy
op_assign
l_int|0
suffix:semicolon
id|mark_bh
c_func
(paren
id|INET_BH
)paren
suffix:semicolon
id|adapter-&gt;stats.tx_packets
op_increment
suffix:semicolon
r_break
suffix:semicolon
multiline_comment|/*&n;         * some unknown PCB&n;         */
r_default
suffix:colon
id|printk
c_func
(paren
l_string|&quot;%s: unknown PCB received - %2.2x&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|adapter-&gt;irx_pcb.command
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
r_else
id|printk
c_func
(paren
l_string|&quot;%s: failed to read PCB on interrupt&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;   * indicate no longer in interrupt routine&n;   */
id|dev-&gt;interrupt
op_assign
l_int|0
suffix:semicolon
)brace
multiline_comment|/******************************************************&n; *&n; * open the board&n; *&n; ******************************************************/
DECL|function|elp_open
r_static
r_int
id|elp_open
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
id|elp_device
op_star
id|adapter
op_assign
(paren
id|elp_device
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_if
c_cond
(paren
id|elp_debug
op_ge
l_int|1
)paren
id|printk
c_func
(paren
l_string|&quot;%s: request to open device&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
multiline_comment|/*&n;   * make sure we actually found the device&n;   */
r_if
c_cond
(paren
id|adapter
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%s: Opening a non-existent physical device&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_return
op_minus
id|EAGAIN
suffix:semicolon
)brace
multiline_comment|/*&n;   * interrupt routine not entered&n;   */
id|dev-&gt;interrupt
op_assign
l_int|0
suffix:semicolon
multiline_comment|/*&n;   *  transmitter not busy &n;   */
id|dev-&gt;tbusy
op_assign
l_int|0
suffix:semicolon
multiline_comment|/*&n;   * install our interrupt service routine&n;   */
r_if
c_cond
(paren
id|request_irq
c_func
(paren
id|dev-&gt;irq
comma
op_amp
id|elp_interrupt
)paren
)paren
r_return
op_minus
id|EAGAIN
suffix:semicolon
multiline_comment|/*&n;   * make sure we can find the device header given the interrupt number&n;   */
id|irq2dev_map
(braket
id|dev-&gt;irq
)braket
op_assign
id|dev
suffix:semicolon
multiline_comment|/*&n;   * enable interrupts on the board&n;   */
id|OUTB
c_func
(paren
id|CONTROL_CMDE
comma
id|adapter-&gt;io_addr
op_plus
id|PORT_CONTROL
)paren
suffix:semicolon
multiline_comment|/*&n;   * device is now offically open!&n;   */
id|dev-&gt;start
op_assign
l_int|1
suffix:semicolon
multiline_comment|/*&n;   * configure adapter to receive broadcast messages and wait for response&n;   */
r_if
c_cond
(paren
id|elp_debug
op_ge
l_int|2
)paren
id|printk
c_func
(paren
l_string|&quot;%s: sending 82586 configure command&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|adapter-&gt;tx_pcb.command
op_assign
id|CMD_CONFIGURE_82586
suffix:semicolon
id|adapter-&gt;tx_pcb.data
(braket
l_int|0
)braket
op_assign
l_int|1
suffix:semicolon
id|adapter-&gt;tx_pcb.data
(braket
l_int|1
)braket
op_assign
l_int|0
suffix:semicolon
id|adapter-&gt;tx_pcb.length
op_assign
l_int|2
suffix:semicolon
id|adapter-&gt;got_configure
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|send_pcb
c_func
(paren
id|adapter
comma
op_amp
id|adapter-&gt;tx_pcb
)paren
)paren
id|printk
c_func
(paren
l_string|&quot;%s: couldn&squot;t send 82586 configure command&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_else
r_while
c_loop
(paren
id|adapter-&gt;got_configure
op_eq
l_int|0
)paren
suffix:semicolon
multiline_comment|/*&n;   * queue a receive command to start things rolling&n;   */
r_if
c_cond
(paren
op_logical_neg
id|start_receive
c_func
(paren
id|adapter
comma
op_amp
id|adapter-&gt;tx_pcb
)paren
)paren
id|printk
c_func
(paren
l_string|&quot;%s: start receive command failed &bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_if
c_cond
(paren
id|elp_debug
op_ge
l_int|2
)paren
id|printk
c_func
(paren
l_string|&quot;%s: start receive command sent&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
multiline_comment|/* Always succeed */
)brace
multiline_comment|/******************************************************&n; *&n; * close the board&n; *&n; ******************************************************/
DECL|function|elp_close
r_static
r_int
id|elp_close
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
id|elp_device
op_star
id|adapter
op_assign
(paren
id|elp_device
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_if
c_cond
(paren
id|elp_debug
op_ge
l_int|1
)paren
id|printk
c_func
(paren
l_string|&quot;%s: request to close device&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
multiline_comment|/*&n;   * disable interrupts on the board&n;   */
id|OUTB
c_func
(paren
l_int|0x00
comma
id|adapter-&gt;io_addr
op_plus
id|PORT_CONTROL
)paren
suffix:semicolon
multiline_comment|/*&n;   *  flag transmitter as busy (i.e. not available)&n;   */
id|dev-&gt;tbusy
op_assign
l_int|1
suffix:semicolon
multiline_comment|/*&n;   *  indicate device is closed&n;   */
id|dev-&gt;start
op_assign
l_int|0
suffix:semicolon
multiline_comment|/*&n;   * release the IRQ&n;   */
id|free_irq
c_func
(paren
id|dev-&gt;irq
)paren
suffix:semicolon
multiline_comment|/*&n;   * and we no longer have to map irq to dev either&n;   */
id|irq2dev_map
(braket
id|dev-&gt;irq
)braket
op_assign
l_int|0
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/******************************************************&n; *&n; * send a packet to the adapter&n; *&n; ******************************************************/
DECL|function|send_packet
r_static
r_int
id|send_packet
(paren
id|elp_device
op_star
id|adapter
comma
r_int
r_char
op_star
id|ptr
comma
r_int
id|len
)paren
(brace
r_int
id|i
suffix:semicolon
multiline_comment|/*&n;   * make sure the length is even and no shorter than 60 bytes&n;   */
r_int
r_int
id|nlen
op_assign
(paren
(paren
(paren
id|len
OL
l_int|60
)paren
ques
c_cond
l_int|60
suffix:colon
id|len
)paren
op_plus
l_int|1
)paren
op_amp
(paren
op_complement
l_int|1
)paren
suffix:semicolon
multiline_comment|/*&n;   * send the adapter a transmit packet command. Ignore segment and offset&n;   * and make sure the length is even&n;   */
id|adapter-&gt;tx_pcb.command
op_assign
id|CMD_TRANSMIT_PACKET
suffix:semicolon
id|adapter-&gt;tx_pcb.length
op_assign
l_int|6
suffix:semicolon
id|adapter-&gt;tx_pcb.data
(braket
l_int|4
)braket
op_assign
id|nlen
op_amp
l_int|0xff
suffix:semicolon
id|adapter-&gt;tx_pcb.data
(braket
l_int|5
)braket
op_assign
id|nlen
op_rshift
l_int|8
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|send_pcb
c_func
(paren
id|adapter
comma
op_amp
id|adapter-&gt;tx_pcb
)paren
)paren
r_return
id|FALSE
suffix:semicolon
multiline_comment|/*&n;   * make sure the data register is going the right way&n;   */
id|cli
c_func
(paren
)paren
suffix:semicolon
id|OUTB
c_func
(paren
id|INB
c_func
(paren
id|adapter-&gt;io_addr
op_plus
id|PORT_CONTROL
)paren
op_amp
(paren
op_complement
id|CONTROL_DIR
)paren
comma
id|adapter-&gt;io_addr
op_plus
id|PORT_CONTROL
)paren
suffix:semicolon
id|sti
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/*&n;   * write data to the adapter&n;   */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
(paren
id|nlen
op_div
l_int|2
)paren
suffix:semicolon
id|i
op_increment
)paren
(brace
r_while
c_loop
(paren
(paren
id|INB
c_func
(paren
id|adapter-&gt;io_addr
op_plus
id|PORT_STATUS
)paren
op_amp
id|STATUS_HRDY
)paren
op_eq
l_int|0
)paren
suffix:semicolon
id|outw
c_func
(paren
op_star
(paren
r_int
op_star
)paren
id|ptr
comma
id|adapter-&gt;io_addr
op_plus
id|PORT_DATA
)paren
suffix:semicolon
id|ptr
op_add_assign
l_int|2
suffix:semicolon
)brace
r_return
id|TRUE
suffix:semicolon
)brace
multiline_comment|/******************************************************&n; *&n; * start the transmitter&n; *    return 0 if sent OK, else return 1&n; *&n; ******************************************************/
DECL|function|elp_start_xmit
r_static
r_int
id|elp_start_xmit
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|device
op_star
id|dev
)paren
(brace
id|elp_device
op_star
id|adapter
op_assign
(paren
id|elp_device
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
multiline_comment|/*&n;   * not sure what this does, but the 3c609 driver does it, so...&n;   */
r_if
c_cond
(paren
id|skb
op_eq
l_int|NULL
)paren
(brace
id|dev_tint
c_func
(paren
id|dev
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n;   * if we ended up with a munged length, don&squot;t send it&n;   */
r_if
c_cond
(paren
id|skb-&gt;len
op_le
l_int|0
)paren
r_return
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|elp_debug
op_ge
l_int|1
)paren
id|printk
c_func
(paren
l_string|&quot;%s: request to send packet of length %i&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|skb-&gt;len
)paren
suffix:semicolon
multiline_comment|/*&n;   * if the transmitter is still busy, we have a transmit timeout...&n;   */
r_if
c_cond
(paren
id|dev-&gt;tbusy
)paren
(brace
r_int
id|tickssofar
op_assign
id|jiffies
op_minus
id|dev-&gt;trans_start
suffix:semicolon
r_if
c_cond
(paren
id|tickssofar
OL
l_int|500
)paren
r_return
l_int|1
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;%s: transmit timed out, resetting adapter&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|INB
c_func
(paren
id|adapter-&gt;io_addr
op_plus
id|PORT_STATUS
)paren
op_amp
id|STATUS_ACRF
)paren
op_ne
l_int|0
)paren
id|printk
c_func
(paren
l_string|&quot;%s: hmmm...seemed to have missed an interrupt!&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|adapter_reset
c_func
(paren
id|adapter
)paren
suffix:semicolon
id|dev-&gt;trans_start
op_assign
id|jiffies
suffix:semicolon
id|dev-&gt;tbusy
op_assign
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n;   * send the packet at (void *)(skb+1) for skb-&gt;len&n;   */
r_if
c_cond
(paren
op_logical_neg
id|send_packet
c_func
(paren
id|adapter
comma
(paren
r_int
r_char
op_star
)paren
(paren
id|skb-&gt;data
)paren
comma
id|skb-&gt;len
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%s: send packet PCB failed&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|elp_debug
op_ge
l_int|2
)paren
id|printk
c_func
(paren
l_string|&quot;%s: packet of length %i sent&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|skb-&gt;len
)paren
suffix:semicolon
multiline_comment|/*&n;   * start the transmit timeout&n;   */
id|dev-&gt;trans_start
op_assign
id|jiffies
suffix:semicolon
multiline_comment|/*&n;   * the transmitter is now busy&n;   */
id|dev-&gt;tbusy
op_assign
l_int|1
suffix:semicolon
multiline_comment|/*&n;   * if we have been asked to free the buffer, do so&n;   */
id|dev_kfree_skb
c_func
(paren
id|skb
comma
id|FREE_WRITE
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/******************************************************&n; *&n; * return statistics on the board&n; *&n; ******************************************************/
DECL|function|elp_get_stats
r_static
r_struct
id|enet_statistics
op_star
id|elp_get_stats
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
r_if
c_cond
(paren
id|elp_debug
op_ge
l_int|1
)paren
id|printk
c_func
(paren
l_string|&quot;%s: request for stats&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|elp_device
op_star
id|adapter
op_assign
(paren
id|elp_device
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_return
op_amp
id|adapter-&gt;stats
suffix:semicolon
)brace
multiline_comment|/******************************************************&n; *&n; * initialise Etherlink Pus board&n; *&n; ******************************************************/
DECL|function|elp_init
r_static
r_void
id|elp_init
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
r_int
id|i
suffix:semicolon
id|elp_device
op_star
id|adapter
suffix:semicolon
multiline_comment|/*&n;   * NULL out buffer pointers&n;   */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|DEV_NUMBUFFS
suffix:semicolon
id|i
op_increment
)paren
id|dev-&gt;buffs
(braket
id|i
)braket
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/*&n;   * set ptrs to various functions&n;   */
id|dev-&gt;open
op_assign
id|elp_open
suffix:semicolon
multiline_comment|/* local */
id|dev-&gt;stop
op_assign
id|elp_close
suffix:semicolon
multiline_comment|/* local */
id|dev-&gt;get_stats
op_assign
id|elp_get_stats
suffix:semicolon
multiline_comment|/* local */
id|dev-&gt;hard_start_xmit
op_assign
id|elp_start_xmit
suffix:semicolon
multiline_comment|/* local */
id|dev-&gt;hard_header
op_assign
id|eth_header
suffix:semicolon
multiline_comment|/* eth.c */
id|dev-&gt;add_arp
op_assign
id|eth_add_arp
suffix:semicolon
multiline_comment|/* eth.c */
id|dev-&gt;rebuild_header
op_assign
id|eth_rebuild_header
suffix:semicolon
multiline_comment|/* eth.c */
id|dev-&gt;type_trans
op_assign
id|eth_type_trans
suffix:semicolon
multiline_comment|/* eth.c */
id|dev-&gt;queue_xmit
op_assign
id|dev_queue_xmit
suffix:semicolon
multiline_comment|/* dev.c */
multiline_comment|/*&n;   * setup ptr to adapter specific information&n;   */
id|adapter
op_assign
(paren
id|elp_device
op_star
)paren
(paren
id|dev-&gt;priv
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
id|elp_device
)paren
comma
id|GFP_KERNEL
)paren
)paren
suffix:semicolon
id|adapter-&gt;io_addr
op_assign
id|dev-&gt;base_addr
suffix:semicolon
id|memset
c_func
(paren
op_amp
(paren
id|adapter-&gt;stats
)paren
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|enet_statistics
)paren
)paren
suffix:semicolon
multiline_comment|/*&n;   * Ethernet information&n;   */
id|dev-&gt;type
op_assign
id|ARPHRD_ETHER
suffix:semicolon
id|dev-&gt;hard_header_len
op_assign
id|ETH_HLEN
suffix:semicolon
id|dev-&gt;mtu
op_assign
l_int|1500
suffix:semicolon
multiline_comment|/* eth_mtu */
id|dev-&gt;addr_len
op_assign
id|ETH_ALEN
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|dev-&gt;addr_len
suffix:semicolon
id|i
op_increment
)paren
id|dev-&gt;broadcast
(braket
id|i
)braket
op_assign
l_int|0xff
suffix:semicolon
multiline_comment|/*&n;   * New-style flags. &n;   */
id|dev-&gt;flags
op_assign
id|IFF_BROADCAST
suffix:semicolon
id|dev-&gt;family
op_assign
id|AF_INET
suffix:semicolon
id|dev-&gt;pa_addr
op_assign
l_int|0
suffix:semicolon
id|dev-&gt;pa_brdaddr
op_assign
l_int|0
suffix:semicolon
id|dev-&gt;pa_mask
op_assign
l_int|0
suffix:semicolon
id|dev-&gt;pa_alen
op_assign
r_sizeof
(paren
r_int
r_int
)paren
suffix:semicolon
multiline_comment|/*&n;   * memory information&n;   */
id|dev-&gt;mem_start
op_assign
id|dev-&gt;mem_end
op_assign
id|dev-&gt;rmem_end
op_assign
id|dev-&gt;mem_start
op_assign
l_int|0
suffix:semicolon
)brace
multiline_comment|/******************************************************&n; *&n; * probe for an Etherlink Plus board at the specified address&n; * by attempting to get the ethernet address. &n; *&n; ******************************************************/
DECL|function|elp_probe
r_int
id|elp_probe
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
id|elp_device
id|adapter
suffix:semicolon
r_int
id|i
suffix:semicolon
multiline_comment|/*&n;   *  setup adapter structure&n;   */
id|adapter.io_addr
op_assign
id|dev-&gt;base_addr
suffix:semicolon
id|printk
(paren
l_string|&quot;%s: probing for 3c505...&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
multiline_comment|/*&n;   * get the adapter&squot;s undivided attention (if it&squot;s there!)&n;   */
id|adapter_hard_reset
c_func
(paren
op_amp
id|adapter
)paren
suffix:semicolon
multiline_comment|/*&n;   * use ethernet address command to probe for board in polled mode&n;   */
id|adapter.tx_pcb.command
op_assign
id|CMD_STATION_ADDRESS
suffix:semicolon
id|adapter.tx_pcb.length
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|send_pcb
(paren
op_amp
id|adapter
comma
op_amp
id|adapter.tx_pcb
)paren
op_logical_or
op_logical_neg
id|receive_pcb
c_func
(paren
op_amp
id|adapter
comma
op_amp
id|adapter.rx_pcb
)paren
op_logical_or
(paren
id|adapter.rx_pcb.command
op_ne
id|CMD_ADDRESS_RESPONSE
)paren
op_logical_or
(paren
id|adapter.rx_pcb.length
op_ne
l_int|6
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;not found&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|6
suffix:semicolon
id|i
op_increment
)paren
id|dev-&gt;dev_addr
(braket
id|i
)braket
op_assign
id|adapter.rx_pcb.data
(braket
id|i
)braket
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;found at port 0x%x, address = %s&bslash;n&quot;
comma
id|dev-&gt;base_addr
comma
id|eth_print
c_func
(paren
id|dev-&gt;dev_addr
)paren
)paren
suffix:semicolon
id|elp_init
c_func
(paren
id|dev
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
eof
