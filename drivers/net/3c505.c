multiline_comment|/*&n; * Linux Ethernet device driver for the 3Com Etherlink Plus (3C505)&n; *      By Craig Southeren, Juha Laiho and Philip Blundell&n; *&n; * 3c505.c      This module implements an interface to the 3Com&n; *              Etherlink Plus (3c505) Ethernet card. Linux device&n; *              driver interface reverse engineered from the Linux 3C509&n; *              device drivers. Some 3C505 information gleaned from&n; *              the Crynwr packet driver. Still this driver would not&n; *              be here without 3C505 technical reference provided by&n; *              3Com.&n; *&n; * $Id: 3c505.c,v 1.10 1996/04/16 13:06:27 phil Exp $&n; *&n; * Authors:     Linux 3c505 device driver by&n; *                      Craig Southeren, &lt;craigs@ineluki.apana.org.au&gt;&n; *              Final debugging by&n; *                      Andrew Tridgell, &lt;tridge@nimbus.anu.edu.au&gt;&n; *              Auto irq/address, tuning, cleanup and v1.1.4+ kernel mods by&n; *                      Juha Laiho, &lt;jlaiho@ichaos.nullnet.fi&gt;&n; *              Linux 3C509 driver by&n; *                      Donald Becker, &lt;becker@super.org&gt;&n; *              Crynwr packet driver by&n; *                      Krishnan Gopalan and Gregg Stefancik,&n; *                      Clemson University Engineering Computer Operations.&n; *                      Portions of the code have been adapted from the 3c505&n; *                         driver for NCSA Telnet by Bruce Orchard and later&n; *                         modified by Warren Van Houten and krus@diku.dk.&n; *              3C505 technical information provided by&n; *                      Terry Murphy, of 3Com Network Adapter Division&n; *              Linux 1.3.0 changes by&n; *                      Alan Cox &lt;Alan.Cox@linux.org&gt;&n; *              More debugging, DMA support, currently maintained by&n; *                      Philip Blundell &lt;Philip.Blundell@pobox.com&gt;&n; *              Multicard/soft configurable dma channel/rev 2 hardware support&n; *                      by Christopher Collins &lt;ccollins@pcug.org.au&gt;&n; */
multiline_comment|/* Theory of operation:&n; *&n; * The 3c505 is quite an intelligent board.  All communication with it is done&n; * by means of Primary Command Blocks (PCBs); these are transferred using PIO&n; * through the command register.  The card has 256k of on-board RAM, which is&n; * used to buffer received packets.  It might seem at first that more buffers&n; * are better, but in fact this isn&squot;t true.  From my tests, it seems that&n; * more than about 10 buffers are unnecessary, and there is a noticeable&n; * performance hit in having more active on the card.  So the majority of the&n; * card&squot;s memory isn&squot;t, in fact, used.  Sadly, the card only has one transmit&n; * buffer and, short of loading our own firmware into it (which is what some&n; * drivers resort to) there&squot;s nothing we can do about this.&n; *&n; * We keep up to 4 &quot;receive packet&quot; commands active on the board at a time.&n; * When a packet comes in, so long as there is a receive command active, the&n; * board will send us a &quot;packet received&quot; PCB and then add the data for that&n; * packet to the DMA queue.  If a DMA transfer is not already in progress, we&n; * set one up to start uploading the data.  We have to maintain a list of&n; * backlogged receive packets, because the card may decide to tell us about&n; * a newly-arrived packet at any time, and we may not be able to start a DMA&n; * transfer immediately (ie one may already be going on).  We can&squot;t NAK the&n; * PCB, because then it would throw the packet away.&n; *&n; * Trying to send a PCB to the card at the wrong moment seems to have bad&n; * effects.  If we send it a transmit PCB while a receive DMA is happening,&n; * it will just NAK the PCB and so we will have wasted our time.  Worse, it&n; * sometimes seems to interrupt the transfer.  The majority of the low-level&n; * code is protected by one huge semaphore -- &quot;busy&quot; -- which is set whenever&n; * it probably isn&squot;t safe to do anything to the card.  The receive routine&n; * must gain a lock on &quot;busy&quot; before it can start a DMA transfer, and the&n; * transmit routine must gain a lock before it sends the first PCB to the card.&n; * The send_pcb() routine also has an internal semaphore to protect it against&n; * being re-entered (which would be disastrous) -- this is needed because&n; * several things can happen asynchronously (re-priming the receiver and&n; * asking the card for statistics, for example).  send_pcb() will also refuse&n; * to talk to the card at all if a DMA upload is happening.  The higher-level&n; * networking code will reschedule a later retry if some part of the driver&n; * is blocked.  In practice, this doesn&squot;t seem to happen very often.&n; */
multiline_comment|/* This driver may now work with revision 2.x hardware, since all the read&n; * operations on the HCR have been removed (we now keep our own softcopy).&n; * But I don&squot;t have an old card to test it on.&n; *&n; * This has had the bad effect that the autoprobe routine is now a bit&n; * less friendly to other devices.  However, it was never very good.&n; * before, so I doubt it will hurt anybody.&n; */
multiline_comment|/* The driver is a mess.  I took Craig&squot;s and Juha&squot;s code, and hacked it firstly&n; * to make it more reliable, and secondly to add DMA mode.  Many things could&n; * probably be done better; the concurrency protection is particularly awful.&n; */
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/interrupt.h&gt;
macro_line|#include &lt;linux/ptrace.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/in.h&gt;
macro_line|#include &lt;linux/malloc.h&gt;
macro_line|#include &lt;linux/ioport.h&gt;
macro_line|#include &lt;linux/spinlock.h&gt;
macro_line|#include &lt;asm/bitops.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/dma.h&gt;
macro_line|#include &lt;linux/netdevice.h&gt;
macro_line|#include &lt;linux/etherdevice.h&gt;
macro_line|#include &lt;linux/skbuff.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &quot;3c505.h&quot;
multiline_comment|/*********************************************************&n; *&n; *  define debug messages here as common strings to reduce space&n; *&n; *********************************************************/
DECL|variable|filename
r_static
r_const
r_char
op_star
id|filename
op_assign
id|__FILE__
suffix:semicolon
DECL|variable|timeout_msg
r_static
r_const
r_char
op_star
id|timeout_msg
op_assign
l_string|&quot;*** timeout at %s:%s (line %d) ***&bslash;n&quot;
suffix:semicolon
DECL|macro|TIMEOUT_MSG
mdefine_line|#define TIMEOUT_MSG(lineno) &bslash;&n;&t;printk(timeout_msg, filename,__FUNCTION__,(lineno))
DECL|variable|invalid_pcb_msg
r_static
r_const
r_char
op_star
id|invalid_pcb_msg
op_assign
l_string|&quot;*** invalid pcb length %d at %s:%s (line %d) ***&bslash;n&quot;
suffix:semicolon
DECL|macro|INVALID_PCB_MSG
mdefine_line|#define INVALID_PCB_MSG(len) &bslash;&n;&t;printk(invalid_pcb_msg, (len),filename,__FUNCTION__,__LINE__)
DECL|variable|__initdata
r_static
r_char
id|search_msg
(braket
)braket
id|__initdata
op_assign
l_string|&quot;%s: Looking for 3c505 adapter at address %#x...&quot;
suffix:semicolon
DECL|variable|__initdata
r_static
r_char
id|stilllooking_msg
(braket
)braket
id|__initdata
op_assign
l_string|&quot;still looking...&quot;
suffix:semicolon
DECL|variable|__initdata
r_static
r_char
id|found_msg
(braket
)braket
id|__initdata
op_assign
l_string|&quot;found.&bslash;n&quot;
suffix:semicolon
DECL|variable|__initdata
r_static
r_char
id|notfound_msg
(braket
)braket
id|__initdata
op_assign
l_string|&quot;not found (reason = %d)&bslash;n&quot;
suffix:semicolon
DECL|variable|__initdata
r_static
r_char
id|couldnot_msg
(braket
)braket
id|__initdata
op_assign
l_string|&quot;%s: 3c505 not found&bslash;n&quot;
suffix:semicolon
multiline_comment|/*********************************************************&n; *&n; *  various other debug stuff&n; *&n; *********************************************************/
macro_line|#ifdef ELP_DEBUG
DECL|variable|elp_debug
r_static
r_const
r_int
id|elp_debug
op_assign
id|ELP_DEBUG
suffix:semicolon
macro_line|#else
DECL|variable|elp_debug
r_static
r_const
r_int
id|elp_debug
op_assign
l_int|0
suffix:semicolon
macro_line|#endif
multiline_comment|/*&n; *  0 = no messages (well, some)&n; *  1 = messages when high level commands performed&n; *  2 = messages when low level commands performed&n; *  3 = messages when interrupts received&n; */
multiline_comment|/*****************************************************************&n; *&n; * useful macros&n; *&n; *****************************************************************/
macro_line|#ifndef&t;TRUE
DECL|macro|TRUE
mdefine_line|#define&t;TRUE&t;1
macro_line|#endif
macro_line|#ifndef&t;FALSE
DECL|macro|FALSE
mdefine_line|#define&t;FALSE&t;0
macro_line|#endif
multiline_comment|/*****************************************************************&n; *&n; * List of I/O-addresses we try to auto-sense&n; * Last element MUST BE 0!&n; *****************************************************************/
DECL|variable|__initdata
r_static
r_int
id|addr_list
(braket
)braket
id|__initdata
op_assign
(brace
l_int|0x300
comma
l_int|0x280
comma
l_int|0x310
comma
l_int|0
)brace
suffix:semicolon
multiline_comment|/* Dma Memory related stuff */
DECL|function|dma_mem_alloc
r_static
r_int
r_int
id|dma_mem_alloc
c_func
(paren
r_int
id|size
)paren
(brace
r_int
id|order
op_assign
id|get_order
c_func
(paren
id|size
)paren
suffix:semicolon
r_return
id|__get_dma_pages
c_func
(paren
id|GFP_KERNEL
comma
id|order
)paren
suffix:semicolon
)brace
multiline_comment|/*****************************************************************&n; *&n; * Functions for I/O (note the inline !)&n; *&n; *****************************************************************/
DECL|function|inb_status
r_static
r_inline
r_int
r_char
id|inb_status
c_func
(paren
r_int
r_int
id|base_addr
)paren
(brace
r_return
id|inb
c_func
(paren
id|base_addr
op_plus
id|PORT_STATUS
)paren
suffix:semicolon
)brace
DECL|function|inb_command
r_static
r_inline
r_int
id|inb_command
c_func
(paren
r_int
r_int
id|base_addr
)paren
(brace
r_return
id|inb
c_func
(paren
id|base_addr
op_plus
id|PORT_COMMAND
)paren
suffix:semicolon
)brace
DECL|function|outb_control
r_static
r_inline
r_void
id|outb_control
c_func
(paren
r_int
r_char
id|val
comma
r_struct
id|net_device
op_star
id|dev
)paren
(brace
id|outb
c_func
(paren
id|val
comma
id|dev-&gt;base_addr
op_plus
id|PORT_CONTROL
)paren
suffix:semicolon
(paren
(paren
id|elp_device
op_star
)paren
(paren
id|dev-&gt;priv
)paren
)paren
op_member_access_from_pointer
id|hcr_val
op_assign
id|val
suffix:semicolon
)brace
DECL|macro|HCR_VAL
mdefine_line|#define HCR_VAL(x)   (((elp_device *)((x)-&gt;priv))-&gt;hcr_val)
DECL|function|outb_command
r_static
r_inline
r_void
id|outb_command
c_func
(paren
r_int
r_char
id|val
comma
r_int
r_int
id|base_addr
)paren
(brace
id|outb
c_func
(paren
id|val
comma
id|base_addr
op_plus
id|PORT_COMMAND
)paren
suffix:semicolon
)brace
DECL|function|inw_data
r_static
r_inline
r_int
r_int
id|inw_data
c_func
(paren
r_int
r_int
id|base_addr
)paren
(brace
r_return
id|inw
c_func
(paren
id|base_addr
op_plus
id|PORT_DATA
)paren
suffix:semicolon
)brace
DECL|function|outw_data
r_static
r_inline
r_void
id|outw_data
c_func
(paren
r_int
r_int
id|val
comma
r_int
r_int
id|base_addr
)paren
(brace
id|outw
c_func
(paren
id|val
comma
id|base_addr
op_plus
id|PORT_DATA
)paren
suffix:semicolon
)brace
DECL|function|backlog_next
r_static
r_inline
r_int
r_int
id|backlog_next
c_func
(paren
r_int
r_int
id|n
)paren
(brace
r_return
(paren
id|n
op_plus
l_int|1
)paren
op_mod
id|BACKLOG_SIZE
suffix:semicolon
)brace
multiline_comment|/*****************************************************************&n; *&n; *  useful functions for accessing the adapter&n; *&n; *****************************************************************/
multiline_comment|/*&n; * use this routine when accessing the ASF bits as they are&n; * changed asynchronously by the adapter&n; */
multiline_comment|/* get adapter PCB status */
DECL|macro|GET_ASF
mdefine_line|#define&t;GET_ASF(addr) &bslash;&n;&t;(get_status(addr)&amp;ASF_PCB_MASK)
DECL|function|get_status
r_static
r_inline
r_int
id|get_status
c_func
(paren
r_int
r_int
id|base_addr
)paren
(brace
r_int
id|timeout
op_assign
id|jiffies
op_plus
l_int|10
op_star
id|HZ
op_div
l_int|100
suffix:semicolon
r_register
r_int
id|stat1
suffix:semicolon
r_do
(brace
id|stat1
op_assign
id|inb_status
c_func
(paren
id|base_addr
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
id|stat1
op_ne
id|inb_status
c_func
(paren
id|base_addr
)paren
op_logical_and
id|time_before
c_func
(paren
id|jiffies
comma
id|timeout
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|time_after_eq
c_func
(paren
id|jiffies
comma
id|timeout
)paren
)paren
id|TIMEOUT_MSG
c_func
(paren
id|__LINE__
)paren
suffix:semicolon
r_return
id|stat1
suffix:semicolon
)brace
DECL|function|set_hsf
r_static
r_inline
r_void
id|set_hsf
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_int
id|hsf
)paren
(brace
id|cli
c_func
(paren
)paren
suffix:semicolon
id|outb_control
c_func
(paren
(paren
id|HCR_VAL
c_func
(paren
id|dev
)paren
op_amp
op_complement
id|HSF_PCB_MASK
)paren
op_or
id|hsf
comma
id|dev
)paren
suffix:semicolon
id|sti
c_func
(paren
)paren
suffix:semicolon
)brace
r_static
r_int
id|start_receive
c_func
(paren
r_struct
id|net_device
op_star
comma
id|pcb_struct
op_star
)paren
suffix:semicolon
DECL|function|adapter_reset
r_inline
r_static
r_void
id|adapter_reset
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_int
id|timeout
suffix:semicolon
id|elp_device
op_star
id|adapter
op_assign
id|dev-&gt;priv
suffix:semicolon
r_int
r_char
id|orig_hcr
op_assign
id|adapter-&gt;hcr_val
suffix:semicolon
id|outb_control
c_func
(paren
l_int|0
comma
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|inb_status
c_func
(paren
id|dev-&gt;base_addr
)paren
op_amp
id|ACRF
)paren
(brace
r_do
(brace
id|inb_command
c_func
(paren
id|dev-&gt;base_addr
)paren
suffix:semicolon
id|timeout
op_assign
id|jiffies
op_plus
l_int|2
op_star
id|HZ
op_div
l_int|100
suffix:semicolon
r_while
c_loop
(paren
id|time_before_eq
c_func
(paren
id|jiffies
comma
id|timeout
)paren
op_logical_and
op_logical_neg
(paren
id|inb_status
c_func
(paren
id|dev-&gt;base_addr
)paren
op_amp
id|ACRF
)paren
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
id|inb_status
c_func
(paren
id|dev-&gt;base_addr
)paren
op_amp
id|ACRF
)paren
suffix:semicolon
id|set_hsf
c_func
(paren
id|dev
comma
id|HSF_PCB_NAK
)paren
suffix:semicolon
)brace
id|outb_control
c_func
(paren
id|adapter-&gt;hcr_val
op_or
id|ATTN
op_or
id|DIR
comma
id|dev
)paren
suffix:semicolon
id|timeout
op_assign
id|jiffies
op_plus
l_int|1
op_star
id|HZ
op_div
l_int|100
suffix:semicolon
r_while
c_loop
(paren
id|time_before_eq
c_func
(paren
id|jiffies
comma
id|timeout
)paren
)paren
suffix:semicolon
id|outb_control
c_func
(paren
id|adapter-&gt;hcr_val
op_amp
op_complement
id|ATTN
comma
id|dev
)paren
suffix:semicolon
id|timeout
op_assign
id|jiffies
op_plus
l_int|1
op_star
id|HZ
op_div
l_int|100
suffix:semicolon
r_while
c_loop
(paren
id|time_before_eq
c_func
(paren
id|jiffies
comma
id|timeout
)paren
)paren
suffix:semicolon
id|outb_control
c_func
(paren
id|adapter-&gt;hcr_val
op_or
id|FLSH
comma
id|dev
)paren
suffix:semicolon
id|timeout
op_assign
id|jiffies
op_plus
l_int|1
op_star
id|HZ
op_div
l_int|100
suffix:semicolon
r_while
c_loop
(paren
id|time_before_eq
c_func
(paren
id|jiffies
comma
id|timeout
)paren
)paren
suffix:semicolon
id|outb_control
c_func
(paren
id|adapter-&gt;hcr_val
op_amp
op_complement
id|FLSH
comma
id|dev
)paren
suffix:semicolon
id|timeout
op_assign
id|jiffies
op_plus
l_int|1
op_star
id|HZ
op_div
l_int|100
suffix:semicolon
r_while
c_loop
(paren
id|time_before_eq
c_func
(paren
id|jiffies
comma
id|timeout
)paren
)paren
suffix:semicolon
id|outb_control
c_func
(paren
id|orig_hcr
comma
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|start_receive
c_func
(paren
id|dev
comma
op_amp
id|adapter-&gt;tx_pcb
)paren
)paren
id|printk
c_func
(paren
l_string|&quot;%s: start receive command failed &bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
)brace
multiline_comment|/* Check to make sure that a DMA transfer hasn&squot;t timed out.  This should&n; * never happen in theory, but seems to occur occasionally if the card gets&n; * prodded at the wrong time.&n; */
DECL|function|check_3c505_dma
r_static
r_inline
r_void
id|check_3c505_dma
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
id|elp_device
op_star
id|adapter
op_assign
id|dev-&gt;priv
suffix:semicolon
r_if
c_cond
(paren
id|adapter-&gt;dmaing
op_logical_and
id|time_after
c_func
(paren
id|jiffies
comma
id|adapter-&gt;current_dma.start_time
op_plus
l_int|10
)paren
)paren
(brace
r_int
r_int
id|flags
comma
id|f
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;%s: DMA %s timed out, %d bytes left&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|adapter-&gt;current_dma.direction
ques
c_cond
l_string|&quot;download&quot;
suffix:colon
l_string|&quot;upload&quot;
comma
id|get_dma_residue
c_func
(paren
id|dev-&gt;dma
)paren
)paren
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|adapter-&gt;dmaing
op_assign
l_int|0
suffix:semicolon
id|adapter-&gt;busy
op_assign
l_int|0
suffix:semicolon
id|f
op_assign
id|claim_dma_lock
c_func
(paren
)paren
suffix:semicolon
id|disable_dma
c_func
(paren
id|dev-&gt;dma
)paren
suffix:semicolon
id|release_dma_lock
c_func
(paren
id|f
)paren
suffix:semicolon
r_if
c_cond
(paren
id|adapter-&gt;rx_active
)paren
id|adapter-&gt;rx_active
op_decrement
suffix:semicolon
id|outb_control
c_func
(paren
id|adapter-&gt;hcr_val
op_amp
op_complement
(paren
id|DMAE
op_or
id|TCEN
op_or
id|DIR
)paren
comma
id|dev
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* Primitive functions used by send_pcb() */
DECL|function|send_pcb_slow
r_static
r_inline
r_int
r_int
id|send_pcb_slow
c_func
(paren
r_int
r_int
id|base_addr
comma
r_int
r_char
id|byte
)paren
(brace
r_int
r_int
id|timeout
suffix:semicolon
id|outb_command
c_func
(paren
id|byte
comma
id|base_addr
)paren
suffix:semicolon
r_for
c_loop
(paren
id|timeout
op_assign
id|jiffies
op_plus
l_int|5
op_star
id|HZ
op_div
l_int|100
suffix:semicolon
id|time_before
c_func
(paren
id|jiffies
comma
id|timeout
)paren
suffix:semicolon
)paren
(brace
r_if
c_cond
(paren
id|inb_status
c_func
(paren
id|base_addr
)paren
op_amp
id|HCRE
)paren
r_return
id|FALSE
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;3c505: send_pcb_slow timed out&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|TRUE
suffix:semicolon
)brace
DECL|function|send_pcb_fast
r_static
r_inline
r_int
r_int
id|send_pcb_fast
c_func
(paren
r_int
r_int
id|base_addr
comma
r_int
r_char
id|byte
)paren
(brace
r_int
r_int
id|timeout
suffix:semicolon
id|outb_command
c_func
(paren
id|byte
comma
id|base_addr
)paren
suffix:semicolon
r_for
c_loop
(paren
id|timeout
op_assign
l_int|0
suffix:semicolon
id|timeout
OL
l_int|40000
suffix:semicolon
id|timeout
op_increment
)paren
(brace
r_if
c_cond
(paren
id|inb_status
c_func
(paren
id|base_addr
)paren
op_amp
id|HCRE
)paren
r_return
id|FALSE
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;3c505: send_pcb_fast timed out&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|TRUE
suffix:semicolon
)brace
multiline_comment|/* Check to see if the receiver needs restarting, and kick it if so */
DECL|function|prime_rx
r_static
r_inline
r_void
id|prime_rx
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
id|elp_device
op_star
id|adapter
op_assign
id|dev-&gt;priv
suffix:semicolon
r_while
c_loop
(paren
id|adapter-&gt;rx_active
OL
id|ELP_RX_PCBS
op_logical_and
id|netif_running
c_func
(paren
id|dev
)paren
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|start_receive
c_func
(paren
id|dev
comma
op_amp
id|adapter-&gt;itx_pcb
)paren
)paren
r_break
suffix:semicolon
)brace
)brace
multiline_comment|/*****************************************************************&n; *&n; * send_pcb&n; *   Send a PCB to the adapter.&n; *&n; *&t;output byte to command reg  --&lt;--+&n; *&t;wait until HCRE is non zero      |&n; *&t;loop until all bytes sent   --&gt;--+&n; *&t;set HSF1 and HSF2 to 1&n; *&t;output pcb length&n; *&t;wait until ASF give ACK or NAK&n; *&t;set HSF1 and HSF2 to 0&n; *&n; *****************************************************************/
multiline_comment|/* This can be quite slow -- the adapter is allowed to take up to 40ms&n; * to respond to the initial interrupt.&n; *&n; * We run initially with interrupts turned on, but with a semaphore set&n; * so that nobody tries to re-enter this code.  Once the first byte has&n; * gone through, we turn interrupts off and then send the others (the&n; * timeout is reduced to 500us).&n; */
DECL|function|send_pcb
r_static
r_int
id|send_pcb
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
id|pcb_struct
op_star
id|pcb
)paren
(brace
r_int
id|i
suffix:semicolon
r_int
id|timeout
suffix:semicolon
id|elp_device
op_star
id|adapter
op_assign
id|dev-&gt;priv
suffix:semicolon
id|check_3c505_dma
c_func
(paren
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|adapter-&gt;dmaing
op_logical_and
id|adapter-&gt;current_dma.direction
op_eq
l_int|0
)paren
r_return
id|FALSE
suffix:semicolon
multiline_comment|/* Avoid contention */
r_if
c_cond
(paren
id|test_and_set_bit
c_func
(paren
l_int|1
comma
op_amp
id|adapter-&gt;send_pcb_semaphore
)paren
)paren
(brace
r_if
c_cond
(paren
id|elp_debug
op_ge
l_int|3
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%s: send_pcb entered while threaded&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
)brace
r_return
id|FALSE
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * load each byte into the command register and&n;&t; * wait for the HCRE bit to indicate the adapter&n;&t; * had read the byte&n;&t; */
id|set_hsf
c_func
(paren
id|dev
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|send_pcb_slow
c_func
(paren
id|dev-&gt;base_addr
comma
id|pcb-&gt;command
)paren
)paren
r_goto
m_abort
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|send_pcb_fast
c_func
(paren
id|dev-&gt;base_addr
comma
id|pcb-&gt;length
)paren
)paren
r_goto
id|sti_abort
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|pcb-&gt;length
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|send_pcb_fast
c_func
(paren
id|dev-&gt;base_addr
comma
id|pcb-&gt;data.raw
(braket
id|i
)braket
)paren
)paren
r_goto
id|sti_abort
suffix:semicolon
)brace
id|outb_control
c_func
(paren
id|adapter-&gt;hcr_val
op_or
l_int|3
comma
id|dev
)paren
suffix:semicolon
multiline_comment|/* signal end of PCB */
id|outb_command
c_func
(paren
l_int|2
op_plus
id|pcb-&gt;length
comma
id|dev-&gt;base_addr
)paren
suffix:semicolon
multiline_comment|/* now wait for the acknowledgement */
id|sti
c_func
(paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|timeout
op_assign
id|jiffies
op_plus
l_int|5
op_star
id|HZ
op_div
l_int|100
suffix:semicolon
id|time_before
c_func
(paren
id|jiffies
comma
id|timeout
)paren
suffix:semicolon
)paren
(brace
r_switch
c_cond
(paren
id|GET_ASF
c_func
(paren
id|dev-&gt;base_addr
)paren
)paren
(brace
r_case
id|ASF_PCB_ACK
suffix:colon
id|adapter-&gt;send_pcb_semaphore
op_assign
l_int|0
suffix:semicolon
r_return
id|TRUE
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ASF_PCB_NAK
suffix:colon
macro_line|#ifdef ELP_DEBUG
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%s: send_pcb got NAK&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
macro_line|#endif
r_goto
m_abort
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|elp_debug
op_ge
l_int|1
)paren
id|printk
c_func
(paren
l_string|&quot;%s: timeout waiting for PCB acknowledge (status %02x)&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|inb_status
c_func
(paren
id|dev-&gt;base_addr
)paren
)paren
suffix:semicolon
id|sti_abort
suffix:colon
id|sti
c_func
(paren
)paren
suffix:semicolon
m_abort
suffix:colon
id|adapter-&gt;send_pcb_semaphore
op_assign
l_int|0
suffix:semicolon
r_return
id|FALSE
suffix:semicolon
)brace
multiline_comment|/*****************************************************************&n; *&n; * receive_pcb&n; *   Read a PCB from the adapter&n; *&n; *&t;wait for ACRF to be non-zero        ---&lt;---+&n; *&t;input a byte                               |&n; *&t;if ASF1 and ASF2 were not both one         |&n; *&t;&t;before byte was read, loop      ---&gt;---+&n; *&t;set HSF1 and HSF2 for ack&n; *&n; *****************************************************************/
DECL|function|receive_pcb
r_static
r_int
id|receive_pcb
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
id|pcb_struct
op_star
id|pcb
)paren
(brace
r_int
id|i
comma
id|j
suffix:semicolon
r_int
id|total_length
suffix:semicolon
r_int
id|stat
suffix:semicolon
r_int
id|timeout
suffix:semicolon
id|elp_device
op_star
id|adapter
op_assign
id|dev-&gt;priv
suffix:semicolon
id|set_hsf
c_func
(paren
id|dev
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* get the command code */
id|timeout
op_assign
id|jiffies
op_plus
l_int|2
op_star
id|HZ
op_div
l_int|100
suffix:semicolon
r_while
c_loop
(paren
(paren
(paren
id|stat
op_assign
id|get_status
c_func
(paren
id|dev-&gt;base_addr
)paren
)paren
op_amp
id|ACRF
)paren
op_eq
l_int|0
op_logical_and
id|time_before
c_func
(paren
id|jiffies
comma
id|timeout
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|time_after_eq
c_func
(paren
id|jiffies
comma
id|timeout
)paren
)paren
(brace
id|TIMEOUT_MSG
c_func
(paren
id|__LINE__
)paren
suffix:semicolon
r_return
id|FALSE
suffix:semicolon
)brace
id|pcb-&gt;command
op_assign
id|inb_command
c_func
(paren
id|dev-&gt;base_addr
)paren
suffix:semicolon
multiline_comment|/* read the data length */
id|timeout
op_assign
id|jiffies
op_plus
l_int|3
op_star
id|HZ
op_div
l_int|100
suffix:semicolon
r_while
c_loop
(paren
(paren
(paren
id|stat
op_assign
id|get_status
c_func
(paren
id|dev-&gt;base_addr
)paren
)paren
op_amp
id|ACRF
)paren
op_eq
l_int|0
op_logical_and
id|time_before
c_func
(paren
id|jiffies
comma
id|timeout
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|time_after_eq
c_func
(paren
id|jiffies
comma
id|timeout
)paren
)paren
(brace
id|TIMEOUT_MSG
c_func
(paren
id|__LINE__
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;%s: status %02x&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|stat
)paren
suffix:semicolon
r_return
id|FALSE
suffix:semicolon
)brace
id|pcb-&gt;length
op_assign
id|inb_command
c_func
(paren
id|dev-&gt;base_addr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pcb-&gt;length
OG
id|MAX_PCB_DATA
)paren
(brace
id|INVALID_PCB_MSG
c_func
(paren
id|pcb-&gt;length
)paren
suffix:semicolon
id|adapter_reset
c_func
(paren
id|dev
)paren
suffix:semicolon
r_return
id|FALSE
suffix:semicolon
)brace
multiline_comment|/* read the data */
id|cli
c_func
(paren
)paren
suffix:semicolon
id|i
op_assign
l_int|0
suffix:semicolon
r_do
(brace
id|j
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
(paren
(paren
id|stat
op_assign
id|get_status
c_func
(paren
id|dev-&gt;base_addr
)paren
)paren
op_amp
id|ACRF
)paren
op_eq
l_int|0
op_logical_and
id|j
op_increment
OL
l_int|20000
)paren
suffix:semicolon
id|pcb-&gt;data.raw
(braket
id|i
op_increment
)braket
op_assign
id|inb_command
c_func
(paren
id|dev-&gt;base_addr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
OG
id|MAX_PCB_DATA
)paren
id|INVALID_PCB_MSG
c_func
(paren
id|i
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
(paren
id|stat
op_amp
id|ASF_PCB_MASK
)paren
op_ne
id|ASF_PCB_END
op_logical_and
id|j
OL
l_int|20000
)paren
suffix:semicolon
id|sti
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|j
op_ge
l_int|20000
)paren
(brace
id|TIMEOUT_MSG
c_func
(paren
id|__LINE__
)paren
suffix:semicolon
r_return
id|FALSE
suffix:semicolon
)brace
multiline_comment|/* woops, the last &quot;data&quot; byte was really the length! */
id|total_length
op_assign
id|pcb-&gt;data.raw
(braket
op_decrement
id|i
)braket
suffix:semicolon
multiline_comment|/* safety check total length vs data length */
r_if
c_cond
(paren
id|total_length
op_ne
(paren
id|pcb-&gt;length
op_plus
l_int|2
)paren
)paren
(brace
r_if
c_cond
(paren
id|elp_debug
op_ge
l_int|2
)paren
id|printk
c_func
(paren
l_string|&quot;%s: mangled PCB received&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|set_hsf
c_func
(paren
id|dev
comma
id|HSF_PCB_NAK
)paren
suffix:semicolon
r_return
id|FALSE
suffix:semicolon
)brace
r_if
c_cond
(paren
id|pcb-&gt;command
op_eq
id|CMD_RECEIVE_PACKET_COMPLETE
)paren
(brace
r_if
c_cond
(paren
id|test_and_set_bit
c_func
(paren
l_int|0
comma
(paren
r_void
op_star
)paren
op_amp
id|adapter-&gt;busy
)paren
)paren
(brace
r_if
c_cond
(paren
id|backlog_next
c_func
(paren
id|adapter-&gt;rx_backlog.in
)paren
op_eq
id|adapter-&gt;rx_backlog.out
)paren
(brace
id|set_hsf
c_func
(paren
id|dev
comma
id|HSF_PCB_NAK
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;%s: PCB rejected, transfer in progress and backlog full&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|pcb-&gt;command
op_assign
l_int|0
suffix:semicolon
r_return
id|TRUE
suffix:semicolon
)brace
r_else
(brace
id|pcb-&gt;command
op_assign
l_int|0xff
suffix:semicolon
)brace
)brace
)brace
id|set_hsf
c_func
(paren
id|dev
comma
id|HSF_PCB_ACK
)paren
suffix:semicolon
r_return
id|TRUE
suffix:semicolon
)brace
multiline_comment|/******************************************************&n; *&n; *  queue a receive command on the adapter so we will get an&n; *  interrupt when a packet is received.&n; *&n; ******************************************************/
DECL|function|start_receive
r_static
r_int
id|start_receive
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
id|pcb_struct
op_star
id|tx_pcb
)paren
(brace
r_int
id|status
suffix:semicolon
id|elp_device
op_star
id|adapter
op_assign
id|dev-&gt;priv
suffix:semicolon
r_if
c_cond
(paren
id|elp_debug
op_ge
l_int|3
)paren
id|printk
c_func
(paren
l_string|&quot;%s: restarting receiver&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|tx_pcb-&gt;command
op_assign
id|CMD_RECEIVE_PACKET
suffix:semicolon
id|tx_pcb-&gt;length
op_assign
r_sizeof
(paren
r_struct
id|Rcv_pkt
)paren
suffix:semicolon
id|tx_pcb-&gt;data.rcv_pkt.buf_seg
op_assign
id|tx_pcb-&gt;data.rcv_pkt.buf_ofs
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Unused */
id|tx_pcb-&gt;data.rcv_pkt.buf_len
op_assign
l_int|1600
suffix:semicolon
id|tx_pcb-&gt;data.rcv_pkt.timeout
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* set timeout to zero */
id|status
op_assign
id|send_pcb
c_func
(paren
id|dev
comma
id|tx_pcb
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
)paren
id|adapter-&gt;rx_active
op_increment
suffix:semicolon
r_return
id|status
suffix:semicolon
)brace
multiline_comment|/******************************************************&n; *&n; * extract a packet from the adapter&n; * this routine is only called from within the interrupt&n; * service routine, so no cli/sti calls are needed&n; * note that the length is always assumed to be even&n; *&n; ******************************************************/
DECL|function|receive_packet
r_static
r_void
id|receive_packet
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_int
id|len
)paren
(brace
r_int
id|rlen
suffix:semicolon
id|elp_device
op_star
id|adapter
op_assign
id|dev-&gt;priv
suffix:semicolon
r_void
op_star
id|target
suffix:semicolon
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|rlen
op_assign
(paren
id|len
op_plus
l_int|1
)paren
op_amp
op_complement
l_int|1
suffix:semicolon
id|skb
op_assign
id|dev_alloc_skb
c_func
(paren
id|rlen
op_plus
l_int|2
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|skb
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%s: memory squeeze, dropping packet&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|target
op_assign
id|adapter-&gt;dma_buffer
suffix:semicolon
id|adapter-&gt;current_dma.target
op_assign
l_int|NULL
suffix:semicolon
)brace
r_else
(brace
id|skb_reserve
c_func
(paren
id|skb
comma
l_int|2
)paren
suffix:semicolon
id|target
op_assign
id|skb_put
c_func
(paren
id|skb
comma
id|rlen
)paren
suffix:semicolon
r_if
c_cond
(paren
id|virt_to_bus
c_func
(paren
id|target
op_plus
id|rlen
)paren
op_ge
id|MAX_DMA_ADDRESS
)paren
(brace
id|adapter-&gt;current_dma.target
op_assign
id|target
suffix:semicolon
id|target
op_assign
id|adapter-&gt;dma_buffer
suffix:semicolon
)brace
r_else
(brace
id|adapter-&gt;current_dma.target
op_assign
l_int|NULL
suffix:semicolon
)brace
)brace
multiline_comment|/* if this happens, we die */
r_if
c_cond
(paren
id|test_and_set_bit
c_func
(paren
l_int|0
comma
(paren
r_void
op_star
)paren
op_amp
id|adapter-&gt;dmaing
)paren
)paren
id|printk
c_func
(paren
l_string|&quot;%s: rx blocked, DMA in progress, dir %d&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|adapter-&gt;current_dma.direction
)paren
suffix:semicolon
id|skb-&gt;dev
op_assign
id|dev
suffix:semicolon
id|adapter-&gt;current_dma.direction
op_assign
l_int|0
suffix:semicolon
id|adapter-&gt;current_dma.length
op_assign
id|rlen
suffix:semicolon
id|adapter-&gt;current_dma.skb
op_assign
id|skb
suffix:semicolon
id|adapter-&gt;current_dma.start_time
op_assign
id|jiffies
suffix:semicolon
id|outb_control
c_func
(paren
id|adapter-&gt;hcr_val
op_or
id|DIR
op_or
id|TCEN
op_or
id|DMAE
comma
id|dev
)paren
suffix:semicolon
id|flags
op_assign
id|claim_dma_lock
c_func
(paren
)paren
suffix:semicolon
id|disable_dma
c_func
(paren
id|dev-&gt;dma
)paren
suffix:semicolon
id|clear_dma_ff
c_func
(paren
id|dev-&gt;dma
)paren
suffix:semicolon
id|set_dma_mode
c_func
(paren
id|dev-&gt;dma
comma
l_int|0x04
)paren
suffix:semicolon
multiline_comment|/* dma read */
id|set_dma_addr
c_func
(paren
id|dev-&gt;dma
comma
id|virt_to_bus
c_func
(paren
id|target
)paren
)paren
suffix:semicolon
id|set_dma_count
c_func
(paren
id|dev-&gt;dma
comma
id|rlen
)paren
suffix:semicolon
id|enable_dma
c_func
(paren
id|dev-&gt;dma
)paren
suffix:semicolon
id|release_dma_lock
c_func
(paren
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|elp_debug
op_ge
l_int|3
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%s: rx DMA transfer started&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|adapter-&gt;rx_active
)paren
id|adapter-&gt;rx_active
op_decrement
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|adapter-&gt;busy
)paren
id|printk
c_func
(paren
l_string|&quot;%s: receive_packet called, busy not set.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
)brace
multiline_comment|/******************************************************&n; *&n; * interrupt handler&n; *&n; ******************************************************/
DECL|function|elp_interrupt
r_static
r_void
id|elp_interrupt
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|reg_ptr
)paren
(brace
r_int
id|len
suffix:semicolon
r_int
id|dlen
suffix:semicolon
r_int
id|icount
op_assign
l_int|0
suffix:semicolon
r_struct
id|net_device
op_star
id|dev
suffix:semicolon
id|elp_device
op_star
id|adapter
suffix:semicolon
r_int
id|timeout
suffix:semicolon
id|dev
op_assign
id|dev_id
suffix:semicolon
id|adapter
op_assign
(paren
id|elp_device
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|adapter-&gt;lock
)paren
suffix:semicolon
r_do
(brace
multiline_comment|/*&n;&t;&t; * has a DMA transfer finished?&n;&t;&t; */
r_if
c_cond
(paren
id|inb_status
c_func
(paren
id|dev-&gt;base_addr
)paren
op_amp
id|DONE
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|adapter-&gt;dmaing
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%s: phantom DMA completed&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|elp_debug
op_ge
l_int|3
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%s: %s DMA complete, status %02x&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|adapter-&gt;current_dma.direction
ques
c_cond
l_string|&quot;tx&quot;
suffix:colon
l_string|&quot;rx&quot;
comma
id|inb_status
c_func
(paren
id|dev-&gt;base_addr
)paren
)paren
suffix:semicolon
)brace
id|outb_control
c_func
(paren
id|adapter-&gt;hcr_val
op_amp
op_complement
(paren
id|DMAE
op_or
id|TCEN
op_or
id|DIR
)paren
comma
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|adapter-&gt;current_dma.direction
)paren
(brace
id|dev_kfree_skb_irq
c_func
(paren
id|adapter-&gt;current_dma.skb
)paren
suffix:semicolon
)brace
r_else
(brace
r_struct
id|sk_buff
op_star
id|skb
op_assign
id|adapter-&gt;current_dma.skb
suffix:semicolon
r_if
c_cond
(paren
id|skb
)paren
(brace
r_if
c_cond
(paren
id|adapter-&gt;current_dma.target
)paren
(brace
multiline_comment|/* have already done the skb_put() */
id|memcpy
c_func
(paren
id|adapter-&gt;current_dma.target
comma
id|adapter-&gt;dma_buffer
comma
id|adapter-&gt;current_dma.length
)paren
suffix:semicolon
)brace
id|skb-&gt;protocol
op_assign
id|eth_type_trans
c_func
(paren
id|skb
comma
id|dev
)paren
suffix:semicolon
id|adapter-&gt;stats.rx_bytes
op_add_assign
id|skb-&gt;len
suffix:semicolon
id|netif_rx
c_func
(paren
id|skb
)paren
suffix:semicolon
)brace
)brace
id|adapter-&gt;dmaing
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|adapter-&gt;rx_backlog.in
op_ne
id|adapter-&gt;rx_backlog.out
)paren
(brace
r_int
id|t
op_assign
id|adapter-&gt;rx_backlog.length
(braket
id|adapter-&gt;rx_backlog.out
)braket
suffix:semicolon
id|adapter-&gt;rx_backlog.out
op_assign
id|backlog_next
c_func
(paren
id|adapter-&gt;rx_backlog.out
)paren
suffix:semicolon
r_if
c_cond
(paren
id|elp_debug
op_ge
l_int|2
)paren
id|printk
c_func
(paren
l_string|&quot;%s: receiving backlogged packet (%d)&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|t
)paren
suffix:semicolon
id|receive_packet
c_func
(paren
id|dev
comma
id|t
)paren
suffix:semicolon
)brace
r_else
(brace
id|adapter-&gt;busy
op_assign
l_int|0
suffix:semicolon
)brace
)brace
r_else
(brace
multiline_comment|/* has one timed out? */
id|check_3c505_dma
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;&t;&t; * receive a PCB from the adapter&n;&t;&t; */
id|timeout
op_assign
id|jiffies
op_plus
l_int|3
op_star
id|HZ
op_div
l_int|100
suffix:semicolon
r_while
c_loop
(paren
(paren
id|inb_status
c_func
(paren
id|dev-&gt;base_addr
)paren
op_amp
id|ACRF
)paren
op_ne
l_int|0
op_logical_and
id|time_before
c_func
(paren
id|jiffies
comma
id|timeout
)paren
)paren
(brace
r_if
c_cond
(paren
id|receive_pcb
c_func
(paren
id|dev
comma
op_amp
id|adapter-&gt;irx_pcb
)paren
)paren
(brace
r_switch
c_cond
(paren
id|adapter-&gt;irx_pcb.command
)paren
(brace
r_case
l_int|0
suffix:colon
r_break
suffix:semicolon
multiline_comment|/*&n;&t;&t;&t;&t;&t; * received a packet - this must be handled fast&n;&t;&t;&t;&t;&t; */
r_case
l_int|0xff
suffix:colon
r_case
id|CMD_RECEIVE_PACKET_COMPLETE
suffix:colon
multiline_comment|/* if the device isn&squot;t open, don&squot;t pass packets up the stack */
r_if
c_cond
(paren
op_logical_neg
id|netif_running
c_func
(paren
id|dev
)paren
)paren
r_break
suffix:semicolon
id|len
op_assign
id|adapter-&gt;irx_pcb.data.rcv_resp.pkt_len
suffix:semicolon
id|dlen
op_assign
id|adapter-&gt;irx_pcb.data.rcv_resp.buf_len
suffix:semicolon
r_if
c_cond
(paren
id|adapter-&gt;irx_pcb.data.rcv_resp.timeout
op_ne
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: interrupt - packet not received correctly&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|elp_debug
op_ge
l_int|3
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%s: interrupt - packet received of length %i (%i)&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|len
comma
id|dlen
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|adapter-&gt;irx_pcb.command
op_eq
l_int|0xff
)paren
(brace
r_if
c_cond
(paren
id|elp_debug
op_ge
l_int|2
)paren
id|printk
c_func
(paren
l_string|&quot;%s: adding packet to backlog (len = %d)&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|dlen
)paren
suffix:semicolon
id|adapter-&gt;rx_backlog.length
(braket
id|adapter-&gt;rx_backlog.in
)braket
op_assign
id|dlen
suffix:semicolon
id|adapter-&gt;rx_backlog.in
op_assign
id|backlog_next
c_func
(paren
id|adapter-&gt;rx_backlog.in
)paren
suffix:semicolon
)brace
r_else
(brace
id|receive_packet
c_func
(paren
id|dev
comma
id|dlen
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|elp_debug
op_ge
l_int|3
)paren
id|printk
c_func
(paren
l_string|&quot;%s: packet received&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
multiline_comment|/*&n;&t;&t;&t;&t;&t; * 82586 configured correctly&n;&t;&t;&t;&t;&t; */
r_case
id|CMD_CONFIGURE_82586_RESPONSE
suffix:colon
id|adapter-&gt;got
(braket
id|CMD_CONFIGURE_82586
)braket
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|elp_debug
op_ge
l_int|3
)paren
id|printk
c_func
(paren
l_string|&quot;%s: interrupt - configure response received&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_break
suffix:semicolon
multiline_comment|/*&n;&t;&t;&t;&t;&t; * Adapter memory configuration&n;&t;&t;&t;&t;&t; */
r_case
id|CMD_CONFIGURE_ADAPTER_RESPONSE
suffix:colon
id|adapter-&gt;got
(braket
id|CMD_CONFIGURE_ADAPTER_MEMORY
)braket
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|elp_debug
op_ge
l_int|3
)paren
id|printk
c_func
(paren
l_string|&quot;%s: Adapter memory configuration %s.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|adapter-&gt;irx_pcb.data.failed
ques
c_cond
l_string|&quot;failed&quot;
suffix:colon
l_string|&quot;succeeded&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
multiline_comment|/*&n;&t;&t;&t;&t;&t; * Multicast list loading&n;&t;&t;&t;&t;&t; */
r_case
id|CMD_LOAD_MULTICAST_RESPONSE
suffix:colon
id|adapter-&gt;got
(braket
id|CMD_LOAD_MULTICAST_LIST
)braket
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|elp_debug
op_ge
l_int|3
)paren
id|printk
c_func
(paren
l_string|&quot;%s: Multicast address list loading %s.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|adapter-&gt;irx_pcb.data.failed
ques
c_cond
l_string|&quot;failed&quot;
suffix:colon
l_string|&quot;succeeded&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
multiline_comment|/*&n;&t;&t;&t;&t;&t; * Station address setting&n;&t;&t;&t;&t;&t; */
r_case
id|CMD_SET_ADDRESS_RESPONSE
suffix:colon
id|adapter-&gt;got
(braket
id|CMD_SET_STATION_ADDRESS
)braket
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|elp_debug
op_ge
l_int|3
)paren
id|printk
c_func
(paren
l_string|&quot;%s: Ethernet address setting %s.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|adapter-&gt;irx_pcb.data.failed
ques
c_cond
l_string|&quot;failed&quot;
suffix:colon
l_string|&quot;succeeded&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
multiline_comment|/*&n;&t;&t;&t;&t;&t; * received board statistics&n;&t;&t;&t;&t;&t; */
r_case
id|CMD_NETWORK_STATISTICS_RESPONSE
suffix:colon
id|adapter-&gt;stats.rx_packets
op_add_assign
id|adapter-&gt;irx_pcb.data.netstat.tot_recv
suffix:semicolon
id|adapter-&gt;stats.tx_packets
op_add_assign
id|adapter-&gt;irx_pcb.data.netstat.tot_xmit
suffix:semicolon
id|adapter-&gt;stats.rx_crc_errors
op_add_assign
id|adapter-&gt;irx_pcb.data.netstat.err_CRC
suffix:semicolon
id|adapter-&gt;stats.rx_frame_errors
op_add_assign
id|adapter-&gt;irx_pcb.data.netstat.err_align
suffix:semicolon
id|adapter-&gt;stats.rx_fifo_errors
op_add_assign
id|adapter-&gt;irx_pcb.data.netstat.err_ovrrun
suffix:semicolon
id|adapter-&gt;stats.rx_over_errors
op_add_assign
id|adapter-&gt;irx_pcb.data.netstat.err_res
suffix:semicolon
id|adapter-&gt;got
(braket
id|CMD_NETWORK_STATISTICS
)braket
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|elp_debug
op_ge
l_int|3
)paren
id|printk
c_func
(paren
l_string|&quot;%s: interrupt - statistics response received&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_break
suffix:semicolon
multiline_comment|/*&n;&t;&t;&t;&t;&t; * sent a packet&n;&t;&t;&t;&t;&t; */
r_case
id|CMD_TRANSMIT_PACKET_COMPLETE
suffix:colon
r_if
c_cond
(paren
id|elp_debug
op_ge
l_int|3
)paren
id|printk
c_func
(paren
l_string|&quot;%s: interrupt - packet sent&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|netif_running
c_func
(paren
id|dev
)paren
)paren
r_break
suffix:semicolon
r_switch
c_cond
(paren
id|adapter-&gt;irx_pcb.data.xmit_resp.c_stat
)paren
(brace
r_case
l_int|0xffff
suffix:colon
id|adapter-&gt;stats.tx_aborted_errors
op_increment
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: transmit timed out, network cable problem?&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0xfffe
suffix:colon
id|adapter-&gt;stats.tx_fifo_errors
op_increment
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: transmit timed out, FIFO underrun&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|netif_wake_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
r_break
suffix:semicolon
multiline_comment|/*&n;&t;&t;&t;&t;&t; * some unknown PCB&n;&t;&t;&t;&t;&t; */
r_default
suffix:colon
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%s: unknown PCB received - %2.2x&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|adapter-&gt;irx_pcb.command
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
r_else
(brace
id|printk
c_func
(paren
l_string|&quot;%s: failed to read PCB on interrupt&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|adapter_reset
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
)brace
)brace
r_while
c_loop
(paren
id|icount
op_increment
OL
l_int|5
op_logical_and
(paren
id|inb_status
c_func
(paren
id|dev-&gt;base_addr
)paren
op_amp
(paren
id|ACRF
op_or
id|DONE
)paren
)paren
)paren
suffix:semicolon
id|prime_rx
c_func
(paren
id|dev
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * indicate no longer in interrupt routine&n;&t; */
id|spin_unlock
c_func
(paren
op_amp
id|adapter-&gt;lock
)paren
suffix:semicolon
)brace
multiline_comment|/******************************************************&n; *&n; * open the board&n; *&n; ******************************************************/
DECL|function|elp_open
r_static
r_int
id|elp_open
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
id|elp_device
op_star
id|adapter
suffix:semicolon
r_int
id|retval
suffix:semicolon
id|adapter
op_assign
id|dev-&gt;priv
suffix:semicolon
r_if
c_cond
(paren
id|elp_debug
op_ge
l_int|3
)paren
id|printk
c_func
(paren
l_string|&quot;%s: request to open device&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * make sure we actually found the device&n;&t; */
r_if
c_cond
(paren
id|adapter
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%s: Opening a non-existent physical device&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_return
op_minus
id|EAGAIN
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * disable interrupts on the board&n;&t; */
id|outb_control
c_func
(paren
l_int|0
comma
id|dev
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * clear any pending interrupts&n;&t; */
id|inb_command
c_func
(paren
id|dev-&gt;base_addr
)paren
suffix:semicolon
id|adapter_reset
c_func
(paren
id|dev
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * no receive PCBs active&n;&t; */
id|adapter-&gt;rx_active
op_assign
l_int|0
suffix:semicolon
id|adapter-&gt;busy
op_assign
l_int|0
suffix:semicolon
id|adapter-&gt;send_pcb_semaphore
op_assign
l_int|0
suffix:semicolon
id|adapter-&gt;rx_backlog.in
op_assign
l_int|0
suffix:semicolon
id|adapter-&gt;rx_backlog.out
op_assign
l_int|0
suffix:semicolon
id|spin_lock_init
c_func
(paren
op_amp
id|adapter-&gt;lock
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * install our interrupt service routine&n;&t; */
r_if
c_cond
(paren
(paren
id|retval
op_assign
id|request_irq
c_func
(paren
id|dev-&gt;irq
comma
op_amp
id|elp_interrupt
comma
l_int|0
comma
id|dev-&gt;name
comma
id|dev
)paren
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: could not allocate IRQ%d&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|dev-&gt;irq
)paren
suffix:semicolon
r_return
id|retval
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|retval
op_assign
id|request_dma
c_func
(paren
id|dev-&gt;dma
comma
id|dev-&gt;name
)paren
)paren
)paren
(brace
id|free_irq
c_func
(paren
id|dev-&gt;irq
comma
id|dev
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: could not allocate DMA%d channel&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|dev-&gt;dma
)paren
suffix:semicolon
r_return
id|retval
suffix:semicolon
)brace
id|adapter-&gt;dma_buffer
op_assign
(paren
r_void
op_star
)paren
id|dma_mem_alloc
c_func
(paren
id|DMA_BUFFER_SIZE
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|adapter-&gt;dma_buffer
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: could not allocate DMA buffer&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|free_dma
c_func
(paren
id|dev-&gt;dma
)paren
suffix:semicolon
id|free_irq
c_func
(paren
id|dev-&gt;irq
comma
id|dev
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|adapter-&gt;dmaing
op_assign
l_int|0
suffix:semicolon
multiline_comment|/*&n;&t; * enable interrupts on the board&n;&t; */
id|outb_control
c_func
(paren
id|CMDE
comma
id|dev
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * configure adapter memory: we need 10 multicast addresses, default==0&n;&t; */
r_if
c_cond
(paren
id|elp_debug
op_ge
l_int|3
)paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%s: sending 3c505 memory configuration command&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|adapter-&gt;tx_pcb.command
op_assign
id|CMD_CONFIGURE_ADAPTER_MEMORY
suffix:semicolon
id|adapter-&gt;tx_pcb.data.memconf.cmd_q
op_assign
l_int|10
suffix:semicolon
id|adapter-&gt;tx_pcb.data.memconf.rcv_q
op_assign
l_int|20
suffix:semicolon
id|adapter-&gt;tx_pcb.data.memconf.mcast
op_assign
l_int|10
suffix:semicolon
id|adapter-&gt;tx_pcb.data.memconf.frame
op_assign
l_int|20
suffix:semicolon
id|adapter-&gt;tx_pcb.data.memconf.rcv_b
op_assign
l_int|20
suffix:semicolon
id|adapter-&gt;tx_pcb.data.memconf.progs
op_assign
l_int|0
suffix:semicolon
id|adapter-&gt;tx_pcb.length
op_assign
r_sizeof
(paren
r_struct
id|Memconf
)paren
suffix:semicolon
id|adapter-&gt;got
(braket
id|CMD_CONFIGURE_ADAPTER_MEMORY
)braket
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|send_pcb
c_func
(paren
id|dev
comma
op_amp
id|adapter-&gt;tx_pcb
)paren
)paren
id|printk
c_func
(paren
l_string|&quot;%s: couldn&squot;t send memory configuration command&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_else
(brace
r_int
id|timeout
op_assign
id|jiffies
op_plus
id|TIMEOUT
suffix:semicolon
r_while
c_loop
(paren
id|adapter-&gt;got
(braket
id|CMD_CONFIGURE_ADAPTER_MEMORY
)braket
op_eq
l_int|0
op_logical_and
id|time_before
c_func
(paren
id|jiffies
comma
id|timeout
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|time_after_eq
c_func
(paren
id|jiffies
comma
id|timeout
)paren
)paren
id|TIMEOUT_MSG
c_func
(paren
id|__LINE__
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * configure adapter to receive broadcast messages and wait for response&n;&t; */
r_if
c_cond
(paren
id|elp_debug
op_ge
l_int|3
)paren
id|printk
c_func
(paren
l_string|&quot;%s: sending 82586 configure command&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|adapter-&gt;tx_pcb.command
op_assign
id|CMD_CONFIGURE_82586
suffix:semicolon
id|adapter-&gt;tx_pcb.data.configure
op_assign
id|NO_LOOPBACK
op_or
id|RECV_BROAD
suffix:semicolon
id|adapter-&gt;tx_pcb.length
op_assign
l_int|2
suffix:semicolon
id|adapter-&gt;got
(braket
id|CMD_CONFIGURE_82586
)braket
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|send_pcb
c_func
(paren
id|dev
comma
op_amp
id|adapter-&gt;tx_pcb
)paren
)paren
id|printk
c_func
(paren
l_string|&quot;%s: couldn&squot;t send 82586 configure command&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_else
(brace
r_int
id|timeout
op_assign
id|jiffies
op_plus
id|TIMEOUT
suffix:semicolon
r_while
c_loop
(paren
id|adapter-&gt;got
(braket
id|CMD_CONFIGURE_82586
)braket
op_eq
l_int|0
op_logical_and
id|time_before
c_func
(paren
id|jiffies
comma
id|timeout
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|time_after_eq
c_func
(paren
id|jiffies
comma
id|timeout
)paren
)paren
id|TIMEOUT_MSG
c_func
(paren
id|__LINE__
)paren
suffix:semicolon
)brace
multiline_comment|/* enable burst-mode DMA */
multiline_comment|/* outb(0x1, dev-&gt;base_addr + PORT_AUXDMA); */
multiline_comment|/*&n;&t; * queue receive commands to provide buffering&n;&t; */
id|prime_rx
c_func
(paren
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|elp_debug
op_ge
l_int|3
)paren
id|printk
c_func
(paren
l_string|&quot;%s: %d receive PCBs active&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|adapter-&gt;rx_active
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * device is now officially open!&n;&t; */
id|netif_start_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/******************************************************&n; *&n; * send a packet to the adapter&n; *&n; ******************************************************/
DECL|function|send_packet
r_static
r_int
id|send_packet
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_struct
id|sk_buff
op_star
id|skb
)paren
(brace
id|elp_device
op_star
id|adapter
op_assign
id|dev-&gt;priv
suffix:semicolon
r_int
r_int
id|target
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
multiline_comment|/*&n;&t; * make sure the length is even and no shorter than 60 bytes&n;&t; */
r_int
r_int
id|nlen
op_assign
(paren
(paren
(paren
id|skb-&gt;len
OL
l_int|60
)paren
ques
c_cond
l_int|60
suffix:colon
id|skb-&gt;len
)paren
op_plus
l_int|1
)paren
op_amp
(paren
op_complement
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|test_and_set_bit
c_func
(paren
l_int|0
comma
(paren
r_void
op_star
)paren
op_amp
id|adapter-&gt;busy
)paren
)paren
(brace
r_if
c_cond
(paren
id|elp_debug
op_ge
l_int|2
)paren
id|printk
c_func
(paren
l_string|&quot;%s: transmit blocked&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_return
id|FALSE
suffix:semicolon
)brace
id|adapter-&gt;stats.tx_bytes
op_add_assign
id|nlen
suffix:semicolon
multiline_comment|/*&n;&t; * send the adapter a transmit packet command. Ignore segment and offset&n;&t; * and make sure the length is even&n;&t; */
id|adapter-&gt;tx_pcb.command
op_assign
id|CMD_TRANSMIT_PACKET
suffix:semicolon
id|adapter-&gt;tx_pcb.length
op_assign
r_sizeof
(paren
r_struct
id|Xmit_pkt
)paren
suffix:semicolon
id|adapter-&gt;tx_pcb.data.xmit_pkt.buf_ofs
op_assign
id|adapter-&gt;tx_pcb.data.xmit_pkt.buf_seg
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Unused */
id|adapter-&gt;tx_pcb.data.xmit_pkt.pkt_len
op_assign
id|nlen
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|send_pcb
c_func
(paren
id|dev
comma
op_amp
id|adapter-&gt;tx_pcb
)paren
)paren
(brace
id|adapter-&gt;busy
op_assign
l_int|0
suffix:semicolon
r_return
id|FALSE
suffix:semicolon
)brace
multiline_comment|/* if this happens, we die */
r_if
c_cond
(paren
id|test_and_set_bit
c_func
(paren
l_int|0
comma
(paren
r_void
op_star
)paren
op_amp
id|adapter-&gt;dmaing
)paren
)paren
id|printk
c_func
(paren
l_string|&quot;%s: tx: DMA %d in progress&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|adapter-&gt;current_dma.direction
)paren
suffix:semicolon
id|adapter-&gt;current_dma.direction
op_assign
l_int|1
suffix:semicolon
id|adapter-&gt;current_dma.start_time
op_assign
id|jiffies
suffix:semicolon
id|target
op_assign
id|virt_to_bus
c_func
(paren
id|skb-&gt;data
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|target
op_plus
id|nlen
)paren
op_ge
id|MAX_DMA_ADDRESS
)paren
(brace
id|memcpy
c_func
(paren
id|adapter-&gt;dma_buffer
comma
id|skb-&gt;data
comma
id|nlen
)paren
suffix:semicolon
id|target
op_assign
id|virt_to_bus
c_func
(paren
id|adapter-&gt;dma_buffer
)paren
suffix:semicolon
)brace
id|adapter-&gt;current_dma.skb
op_assign
id|skb
suffix:semicolon
id|flags
op_assign
id|claim_dma_lock
c_func
(paren
)paren
suffix:semicolon
id|disable_dma
c_func
(paren
id|dev-&gt;dma
)paren
suffix:semicolon
id|clear_dma_ff
c_func
(paren
id|dev-&gt;dma
)paren
suffix:semicolon
id|set_dma_mode
c_func
(paren
id|dev-&gt;dma
comma
l_int|0x48
)paren
suffix:semicolon
multiline_comment|/* dma memory -&gt; io */
id|set_dma_addr
c_func
(paren
id|dev-&gt;dma
comma
id|target
)paren
suffix:semicolon
id|set_dma_count
c_func
(paren
id|dev-&gt;dma
comma
id|nlen
)paren
suffix:semicolon
id|outb_control
c_func
(paren
id|adapter-&gt;hcr_val
op_or
id|DMAE
op_or
id|TCEN
comma
id|dev
)paren
suffix:semicolon
id|enable_dma
c_func
(paren
id|dev-&gt;dma
)paren
suffix:semicolon
id|release_dma_lock
c_func
(paren
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|elp_debug
op_ge
l_int|3
)paren
id|printk
c_func
(paren
l_string|&quot;%s: DMA transfer started&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_return
id|TRUE
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;The upper layer thinks we timed out&n; */
DECL|function|elp_timeout
r_static
r_void
id|elp_timeout
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
id|elp_device
op_star
id|adapter
op_assign
id|dev-&gt;priv
suffix:semicolon
r_int
id|stat
suffix:semicolon
id|stat
op_assign
id|inb_status
c_func
(paren
id|dev-&gt;base_addr
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: transmit timed out, lost %s?&bslash;n&quot;
comma
id|dev-&gt;name
comma
(paren
id|stat
op_amp
id|ACRF
)paren
ques
c_cond
l_string|&quot;interrupt&quot;
suffix:colon
l_string|&quot;command&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|elp_debug
op_ge
l_int|1
)paren
id|printk
c_func
(paren
l_string|&quot;%s: status %#02x&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|stat
)paren
suffix:semicolon
id|dev-&gt;trans_start
op_assign
id|jiffies
suffix:semicolon
id|adapter-&gt;stats.tx_dropped
op_increment
suffix:semicolon
id|netif_wake_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
multiline_comment|/******************************************************&n; *&n; * start the transmitter&n; *    return 0 if sent OK, else return 1&n; *&n; ******************************************************/
DECL|function|elp_start_xmit
r_static
r_int
id|elp_start_xmit
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
id|elp_device
op_star
id|adapter
op_assign
id|dev-&gt;priv
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|adapter-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|check_3c505_dma
c_func
(paren
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|elp_debug
op_ge
l_int|3
)paren
id|printk
c_func
(paren
l_string|&quot;%s: request to send packet of length %d&bslash;n&quot;
comma
id|dev-&gt;name
comma
(paren
r_int
)paren
id|skb-&gt;len
)paren
suffix:semicolon
id|netif_stop_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * send the packet at skb-&gt;data for skb-&gt;len&n;&t; */
r_if
c_cond
(paren
op_logical_neg
id|send_packet
c_func
(paren
id|dev
comma
id|skb
)paren
)paren
(brace
r_if
c_cond
(paren
id|elp_debug
op_ge
l_int|2
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%s: failed to transmit packet&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
)brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|adapter-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|elp_debug
op_ge
l_int|3
)paren
id|printk
c_func
(paren
l_string|&quot;%s: packet of length %d sent&bslash;n&quot;
comma
id|dev-&gt;name
comma
(paren
r_int
)paren
id|skb-&gt;len
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * start the transmit timeout&n;&t; */
id|dev-&gt;trans_start
op_assign
id|jiffies
suffix:semicolon
id|prime_rx
c_func
(paren
id|dev
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|adapter-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|netif_start_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/******************************************************&n; *&n; * return statistics on the board&n; *&n; ******************************************************/
DECL|function|elp_get_stats
r_static
r_struct
id|net_device_stats
op_star
id|elp_get_stats
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
id|elp_device
op_star
id|adapter
op_assign
(paren
id|elp_device
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_if
c_cond
(paren
id|elp_debug
op_ge
l_int|3
)paren
id|printk
c_func
(paren
l_string|&quot;%s: request for stats&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
multiline_comment|/* If the device is closed, just return the latest stats we have,&n;&t;   - we cannot ask from the adapter without interrupts */
r_if
c_cond
(paren
op_logical_neg
id|netif_running
c_func
(paren
id|dev
)paren
)paren
r_return
op_amp
id|adapter-&gt;stats
suffix:semicolon
multiline_comment|/* send a get statistics command to the board */
id|adapter-&gt;tx_pcb.command
op_assign
id|CMD_NETWORK_STATISTICS
suffix:semicolon
id|adapter-&gt;tx_pcb.length
op_assign
l_int|0
suffix:semicolon
id|adapter-&gt;got
(braket
id|CMD_NETWORK_STATISTICS
)braket
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|send_pcb
c_func
(paren
id|dev
comma
op_amp
id|adapter-&gt;tx_pcb
)paren
)paren
id|printk
c_func
(paren
l_string|&quot;%s: couldn&squot;t send get statistics command&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_else
(brace
r_int
id|timeout
op_assign
id|jiffies
op_plus
id|TIMEOUT
suffix:semicolon
r_while
c_loop
(paren
id|adapter-&gt;got
(braket
id|CMD_NETWORK_STATISTICS
)braket
op_eq
l_int|0
op_logical_and
id|time_before
c_func
(paren
id|jiffies
comma
id|timeout
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|time_after_eq
c_func
(paren
id|jiffies
comma
id|timeout
)paren
)paren
(brace
id|TIMEOUT_MSG
c_func
(paren
id|__LINE__
)paren
suffix:semicolon
r_return
op_amp
id|adapter-&gt;stats
suffix:semicolon
)brace
)brace
multiline_comment|/* statistics are now up to date */
r_return
op_amp
id|adapter-&gt;stats
suffix:semicolon
)brace
multiline_comment|/******************************************************&n; *&n; * close the board&n; *&n; ******************************************************/
DECL|function|elp_close
r_static
r_int
id|elp_close
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
id|elp_device
op_star
id|adapter
suffix:semicolon
id|adapter
op_assign
id|dev-&gt;priv
suffix:semicolon
r_if
c_cond
(paren
id|elp_debug
op_ge
l_int|3
)paren
id|printk
c_func
(paren
l_string|&quot;%s: request to close device&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|netif_stop_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
multiline_comment|/* Someone may request the device statistic information even when&n;&t; * the interface is closed. The following will update the statistics&n;&t; * structure in the driver, so we&squot;ll be able to give current statistics.&n;&t; */
(paren
r_void
)paren
id|elp_get_stats
c_func
(paren
id|dev
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * disable interrupts on the board&n;&t; */
id|outb_control
c_func
(paren
l_int|0
comma
id|dev
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * release the IRQ&n;&t; */
id|free_irq
c_func
(paren
id|dev-&gt;irq
comma
id|dev
)paren
suffix:semicolon
id|free_dma
c_func
(paren
id|dev-&gt;dma
)paren
suffix:semicolon
id|free_pages
c_func
(paren
(paren
r_int
r_int
)paren
id|adapter-&gt;dma_buffer
comma
id|get_order
c_func
(paren
id|DMA_BUFFER_SIZE
)paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/************************************************************&n; *&n; * Set multicast list&n; * num_addrs==0: clear mc_list&n; * num_addrs==-1: set promiscuous mode&n; * num_addrs&gt;0: set mc_list&n; *&n; ************************************************************/
DECL|function|elp_set_mc_list
r_static
r_void
id|elp_set_mc_list
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
id|elp_device
op_star
id|adapter
op_assign
(paren
id|elp_device
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_struct
id|dev_mc_list
op_star
id|dmi
op_assign
id|dev-&gt;mc_list
suffix:semicolon
r_int
id|i
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_if
c_cond
(paren
id|elp_debug
op_ge
l_int|3
)paren
id|printk
c_func
(paren
l_string|&quot;%s: request to set multicast list&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|adapter-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|dev-&gt;flags
op_amp
(paren
id|IFF_PROMISC
op_or
id|IFF_ALLMULTI
)paren
)paren
)paren
(brace
multiline_comment|/* send a &quot;load multicast list&quot; command to the board, max 10 addrs/cmd */
multiline_comment|/* if num_addrs==0 the list will be cleared */
id|adapter-&gt;tx_pcb.command
op_assign
id|CMD_LOAD_MULTICAST_LIST
suffix:semicolon
id|adapter-&gt;tx_pcb.length
op_assign
l_int|6
op_star
id|dev-&gt;mc_count
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|dev-&gt;mc_count
suffix:semicolon
id|i
op_increment
)paren
(brace
id|memcpy
c_func
(paren
id|adapter-&gt;tx_pcb.data.multicast
(braket
id|i
)braket
comma
id|dmi-&gt;dmi_addr
comma
l_int|6
)paren
suffix:semicolon
id|dmi
op_assign
id|dmi-&gt;next
suffix:semicolon
)brace
id|adapter-&gt;got
(braket
id|CMD_LOAD_MULTICAST_LIST
)braket
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|send_pcb
c_func
(paren
id|dev
comma
op_amp
id|adapter-&gt;tx_pcb
)paren
)paren
id|printk
c_func
(paren
l_string|&quot;%s: couldn&squot;t send set_multicast command&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_else
(brace
r_int
id|timeout
op_assign
id|jiffies
op_plus
id|TIMEOUT
suffix:semicolon
r_while
c_loop
(paren
id|adapter-&gt;got
(braket
id|CMD_LOAD_MULTICAST_LIST
)braket
op_eq
l_int|0
op_logical_and
id|time_before
c_func
(paren
id|jiffies
comma
id|timeout
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|time_after_eq
c_func
(paren
id|jiffies
comma
id|timeout
)paren
)paren
(brace
id|TIMEOUT_MSG
c_func
(paren
id|__LINE__
)paren
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|dev-&gt;mc_count
)paren
id|adapter-&gt;tx_pcb.data.configure
op_assign
id|NO_LOOPBACK
op_or
id|RECV_BROAD
op_or
id|RECV_MULTI
suffix:semicolon
r_else
multiline_comment|/* num_addrs == 0 */
id|adapter-&gt;tx_pcb.data.configure
op_assign
id|NO_LOOPBACK
op_or
id|RECV_BROAD
suffix:semicolon
)brace
r_else
id|adapter-&gt;tx_pcb.data.configure
op_assign
id|NO_LOOPBACK
op_or
id|RECV_PROMISC
suffix:semicolon
multiline_comment|/*&n;&t; * configure adapter to receive messages (as specified above)&n;&t; * and wait for response&n;&t; */
r_if
c_cond
(paren
id|elp_debug
op_ge
l_int|3
)paren
id|printk
c_func
(paren
l_string|&quot;%s: sending 82586 configure command&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|adapter-&gt;tx_pcb.command
op_assign
id|CMD_CONFIGURE_82586
suffix:semicolon
id|adapter-&gt;tx_pcb.length
op_assign
l_int|2
suffix:semicolon
id|adapter-&gt;got
(braket
id|CMD_CONFIGURE_82586
)braket
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|send_pcb
c_func
(paren
id|dev
comma
op_amp
id|adapter-&gt;tx_pcb
)paren
)paren
(brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|adapter-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;%s: couldn&squot;t send 82586 configure command&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
)brace
r_else
(brace
r_int
id|timeout
op_assign
id|jiffies
op_plus
id|TIMEOUT
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|adapter-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_while
c_loop
(paren
id|adapter-&gt;got
(braket
id|CMD_CONFIGURE_82586
)braket
op_eq
l_int|0
op_logical_and
id|time_before
c_func
(paren
id|jiffies
comma
id|timeout
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|time_after_eq
c_func
(paren
id|jiffies
comma
id|timeout
)paren
)paren
id|TIMEOUT_MSG
c_func
(paren
id|__LINE__
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/******************************************************&n; *&n; * initialise Etherlink Plus board&n; *&n; ******************************************************/
DECL|function|elp_init
r_static
r_inline
r_void
id|elp_init
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
id|elp_device
op_star
id|adapter
op_assign
id|dev-&gt;priv
suffix:semicolon
multiline_comment|/*&n;&t; * set ptrs to various functions&n;&t; */
id|dev-&gt;open
op_assign
id|elp_open
suffix:semicolon
multiline_comment|/* local */
id|dev-&gt;stop
op_assign
id|elp_close
suffix:semicolon
multiline_comment|/* local */
id|dev-&gt;get_stats
op_assign
id|elp_get_stats
suffix:semicolon
multiline_comment|/* local */
id|dev-&gt;hard_start_xmit
op_assign
id|elp_start_xmit
suffix:semicolon
multiline_comment|/* local */
id|dev-&gt;tx_timeout
op_assign
id|elp_timeout
suffix:semicolon
multiline_comment|/* local */
id|dev-&gt;watchdog_timeo
op_assign
l_int|10
op_star
id|HZ
suffix:semicolon
id|dev-&gt;set_multicast_list
op_assign
id|elp_set_mc_list
suffix:semicolon
multiline_comment|/* local */
multiline_comment|/* Setup the generic properties */
id|ether_setup
c_func
(paren
id|dev
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * setup ptr to adapter specific information&n;&t; */
id|memset
c_func
(paren
op_amp
(paren
id|adapter-&gt;stats
)paren
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|net_device_stats
)paren
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * memory information&n;&t; */
id|dev-&gt;mem_start
op_assign
id|dev-&gt;mem_end
op_assign
id|dev-&gt;rmem_end
op_assign
id|dev-&gt;rmem_start
op_assign
l_int|0
suffix:semicolon
)brace
multiline_comment|/************************************************************&n; *&n; * A couple of tests to see if there&squot;s 3C505 or not&n; * Called only by elp_autodetect&n; ************************************************************/
DECL|function|elp_sense
r_static
r_int
id|__init
id|elp_sense
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_int
id|timeout
suffix:semicolon
r_int
id|addr
op_assign
id|dev-&gt;base_addr
suffix:semicolon
r_const
r_char
op_star
id|name
op_assign
id|dev-&gt;name
suffix:semicolon
r_int
id|flags
suffix:semicolon
id|byte
id|orig_HSR
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|request_region
c_func
(paren
id|addr
comma
id|ELP_IO_EXTENT
comma
l_string|&quot;3c505&quot;
)paren
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
id|orig_HSR
op_assign
id|inb_status
c_func
(paren
id|addr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|elp_debug
OG
l_int|0
)paren
id|printk
c_func
(paren
id|search_msg
comma
id|name
comma
id|addr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|orig_HSR
op_eq
l_int|0xff
)paren
(brace
r_if
c_cond
(paren
id|elp_debug
OG
l_int|0
)paren
id|printk
c_func
(paren
id|notfound_msg
comma
l_int|1
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
multiline_comment|/* Enable interrupts - we need timers! */
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|sti
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* Wait for a while; the adapter may still be booting up */
r_if
c_cond
(paren
id|elp_debug
OG
l_int|0
)paren
id|printk
c_func
(paren
id|stilllooking_msg
)paren
suffix:semicolon
r_if
c_cond
(paren
id|orig_HSR
op_amp
id|DIR
)paren
(brace
multiline_comment|/* If HCR.DIR is up, we pull it down. HSR.DIR should follow. */
id|outb
c_func
(paren
l_int|0
comma
id|dev-&gt;base_addr
op_plus
id|PORT_CONTROL
)paren
suffix:semicolon
id|timeout
op_assign
id|jiffies
op_plus
l_int|30
op_star
id|HZ
op_div
l_int|100
suffix:semicolon
r_while
c_loop
(paren
id|time_before
c_func
(paren
id|jiffies
comma
id|timeout
)paren
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|inb_status
c_func
(paren
id|addr
)paren
op_amp
id|DIR
)paren
(brace
r_if
c_cond
(paren
id|elp_debug
OG
l_int|0
)paren
id|printk
c_func
(paren
id|notfound_msg
comma
l_int|2
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
)brace
r_else
(brace
multiline_comment|/* If HCR.DIR is down, we pull it up. HSR.DIR should follow. */
id|outb
c_func
(paren
id|DIR
comma
id|dev-&gt;base_addr
op_plus
id|PORT_CONTROL
)paren
suffix:semicolon
id|timeout
op_assign
id|jiffies
op_plus
l_int|30
op_star
id|HZ
op_div
l_int|100
suffix:semicolon
r_while
c_loop
(paren
id|time_before
c_func
(paren
id|jiffies
comma
id|timeout
)paren
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|inb_status
c_func
(paren
id|addr
)paren
op_amp
id|DIR
)paren
)paren
(brace
r_if
c_cond
(paren
id|elp_debug
OG
l_int|0
)paren
id|printk
c_func
(paren
id|notfound_msg
comma
l_int|3
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
)brace
multiline_comment|/*&n;&t; * It certainly looks like a 3c505.&n;&t; */
r_if
c_cond
(paren
id|elp_debug
OG
l_int|0
)paren
id|printk
c_func
(paren
id|found_msg
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
id|out
suffix:colon
id|release_region
c_func
(paren
id|addr
comma
id|ELP_IO_EXTENT
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
multiline_comment|/*************************************************************&n; *&n; * Search through addr_list[] and try to find a 3C505&n; * Called only by eplus_probe&n; *************************************************************/
DECL|function|elp_autodetect
r_static
r_int
id|__init
id|elp_autodetect
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_int
id|idx
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* if base address set, then only check that address&n;&t;   otherwise, run through the table */
r_if
c_cond
(paren
id|dev-&gt;base_addr
op_ne
l_int|0
)paren
(brace
multiline_comment|/* dev-&gt;base_addr == 0 ==&gt; plain autodetect */
r_if
c_cond
(paren
id|elp_sense
c_func
(paren
id|dev
)paren
op_eq
l_int|0
)paren
r_return
id|dev-&gt;base_addr
suffix:semicolon
)brace
r_else
r_while
c_loop
(paren
(paren
id|dev-&gt;base_addr
op_assign
id|addr_list
(braket
id|idx
op_increment
)braket
)paren
)paren
(brace
r_if
c_cond
(paren
id|elp_sense
c_func
(paren
id|dev
)paren
op_eq
l_int|0
)paren
r_return
id|dev-&gt;base_addr
suffix:semicolon
)brace
multiline_comment|/* could not find an adapter */
r_if
c_cond
(paren
id|elp_debug
OG
l_int|0
)paren
id|printk
c_func
(paren
id|couldnot_msg
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
multiline_comment|/* Because of this, the layer above will return -ENODEV */
)brace
multiline_comment|/******************************************************&n; *&n; * probe for an Etherlink Plus board at the specified address&n; *&n; ******************************************************/
multiline_comment|/* There are three situations we need to be able to detect here:&n;&n; *  a) the card is idle&n; *  b) the card is still booting up&n; *  c) the card is stuck in a strange state (some DOS drivers do this)&n; *&n; * In case (a), all is well.  In case (b), we wait 10 seconds to see if the&n; * card finishes booting, and carry on if so.  In case (c), we do a hard reset,&n; * loop round, and hope for the best.&n; *&n; * This is all very unpleasant, but hopefully avoids the problems with the old&n; * probe code (which had a 15-second delay if the card was idle, and didn&squot;t&n; * work at all if it was in a weird state).&n; */
DECL|function|elplus_probe
r_int
id|__init
id|elplus_probe
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
id|elp_device
op_star
id|adapter
suffix:semicolon
r_int
id|i
comma
id|tries
comma
id|tries1
comma
id|timeout
comma
id|okay
suffix:semicolon
r_int
r_int
id|cookie
op_assign
l_int|0
suffix:semicolon
id|SET_MODULE_OWNER
c_func
(paren
id|dev
)paren
suffix:semicolon
multiline_comment|/*&n;&t; *  setup adapter structure&n;&t; */
id|dev-&gt;base_addr
op_assign
id|elp_autodetect
c_func
(paren
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|dev-&gt;base_addr
)paren
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
multiline_comment|/*&n;&t; * setup ptr to adapter specific information&n;&t; */
id|adapter
op_assign
(paren
id|elp_device
op_star
)paren
(paren
id|dev-&gt;priv
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
id|elp_device
)paren
comma
id|GFP_KERNEL
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|adapter
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%s: out of memory&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
id|adapter-&gt;send_pcb_semaphore
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|tries1
op_assign
l_int|0
suffix:semicolon
id|tries1
OL
l_int|3
suffix:semicolon
id|tries1
op_increment
)paren
(brace
id|outb_control
c_func
(paren
(paren
id|adapter-&gt;hcr_val
op_or
id|CMDE
)paren
op_amp
op_complement
id|DIR
comma
id|dev
)paren
suffix:semicolon
multiline_comment|/* First try to write just one byte, to see if the card is&n;&t;&t; * responding at all normally.&n;&t;&t; */
id|timeout
op_assign
id|jiffies
op_plus
l_int|5
op_star
id|HZ
op_div
l_int|100
suffix:semicolon
id|okay
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
id|time_before
c_func
(paren
id|jiffies
comma
id|timeout
)paren
op_logical_and
op_logical_neg
(paren
id|inb_status
c_func
(paren
id|dev-&gt;base_addr
)paren
op_amp
id|HCRE
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|inb_status
c_func
(paren
id|dev-&gt;base_addr
)paren
op_amp
id|HCRE
)paren
)paren
(brace
id|outb_command
c_func
(paren
l_int|0
comma
id|dev-&gt;base_addr
)paren
suffix:semicolon
multiline_comment|/* send a spurious byte */
id|timeout
op_assign
id|jiffies
op_plus
l_int|5
op_star
id|HZ
op_div
l_int|100
suffix:semicolon
r_while
c_loop
(paren
id|time_before
c_func
(paren
id|jiffies
comma
id|timeout
)paren
op_logical_and
op_logical_neg
(paren
id|inb_status
c_func
(paren
id|dev-&gt;base_addr
)paren
op_amp
id|HCRE
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|inb_status
c_func
(paren
id|dev-&gt;base_addr
)paren
op_amp
id|HCRE
)paren
id|okay
op_assign
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|okay
)paren
(brace
multiline_comment|/* Nope, it&squot;s ignoring the command register.  This means that&n;&t;&t;&t; * either it&squot;s still booting up, or it&squot;s died.&n;&t;&t;&t; */
id|printk
c_func
(paren
l_string|&quot;%s: command register wouldn&squot;t drain, &quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|inb_status
c_func
(paren
id|dev-&gt;base_addr
)paren
op_amp
l_int|7
)paren
op_eq
l_int|3
)paren
(brace
multiline_comment|/* If the adapter status is 3, it *could* still be booting.&n;&t;&t;&t;&t; * Give it the benefit of the doubt for 10 seconds.&n;&t;&t;&t;&t; */
id|printk
c_func
(paren
l_string|&quot;assuming 3c505 still starting&bslash;n&quot;
)paren
suffix:semicolon
id|timeout
op_assign
id|jiffies
op_plus
l_int|10
op_star
id|HZ
suffix:semicolon
r_while
c_loop
(paren
id|time_before
c_func
(paren
id|jiffies
comma
id|timeout
)paren
op_logical_and
(paren
id|inb_status
c_func
(paren
id|dev-&gt;base_addr
)paren
op_amp
l_int|7
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|inb_status
c_func
(paren
id|dev-&gt;base_addr
)paren
op_amp
l_int|7
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%s: 3c505 failed to start&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
)brace
r_else
(brace
id|okay
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* It started */
)brace
)brace
r_else
(brace
multiline_comment|/* Otherwise, it must just be in a strange&n;&t;&t;&t;&t; * state.  We probably need to kick it.&n;&t;&t;&t;&t; */
id|printk
c_func
(paren
l_string|&quot;3c505 is sulking&bslash;n&quot;
)paren
suffix:semicolon
)brace
)brace
r_for
c_loop
(paren
id|tries
op_assign
l_int|0
suffix:semicolon
id|tries
OL
l_int|5
op_logical_and
id|okay
suffix:semicolon
id|tries
op_increment
)paren
(brace
multiline_comment|/*&n;&t;&t;&t; * Try to set the Ethernet address, to make sure that the board&n;&t;&t;&t; * is working.&n;&t;&t;&t; */
id|adapter-&gt;tx_pcb.command
op_assign
id|CMD_STATION_ADDRESS
suffix:semicolon
id|adapter-&gt;tx_pcb.length
op_assign
l_int|0
suffix:semicolon
id|cookie
op_assign
id|probe_irq_on
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|send_pcb
c_func
(paren
id|dev
comma
op_amp
id|adapter-&gt;tx_pcb
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%s: could not send first PCB&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|probe_irq_off
c_func
(paren
id|cookie
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|receive_pcb
c_func
(paren
id|dev
comma
op_amp
id|adapter-&gt;rx_pcb
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%s: could not read first PCB&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|probe_irq_off
c_func
(paren
id|cookie
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|adapter-&gt;rx_pcb.command
op_ne
id|CMD_ADDRESS_RESPONSE
)paren
op_logical_or
(paren
id|adapter-&gt;rx_pcb.length
op_ne
l_int|6
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%s: first PCB wrong (%d, %d)&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|adapter-&gt;rx_pcb.command
comma
id|adapter-&gt;rx_pcb.length
)paren
suffix:semicolon
id|probe_irq_off
c_func
(paren
id|cookie
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
r_goto
id|okay
suffix:semicolon
)brace
multiline_comment|/* It&squot;s broken.  Do a hard reset to re-initialise the board,&n;&t;&t; * and try again.&n;&t;&t; */
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: resetting adapter&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|outb_control
c_func
(paren
id|adapter-&gt;hcr_val
op_or
id|FLSH
op_or
id|ATTN
comma
id|dev
)paren
suffix:semicolon
id|outb_control
c_func
(paren
id|adapter-&gt;hcr_val
op_amp
op_complement
(paren
id|FLSH
op_or
id|ATTN
)paren
comma
id|dev
)paren
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;%s: failed to initialise 3c505&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|release_region
c_func
(paren
id|dev-&gt;base_addr
comma
id|ELP_IO_EXTENT
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
id|okay
suffix:colon
r_if
c_cond
(paren
id|dev-&gt;irq
)paren
(brace
multiline_comment|/* Is there a preset IRQ? */
r_int
id|rpt
op_assign
id|probe_irq_off
c_func
(paren
id|cookie
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;irq
op_ne
id|rpt
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%s: warning, irq %d configured but %d detected&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|dev-&gt;irq
comma
id|rpt
)paren
suffix:semicolon
)brace
multiline_comment|/* if dev-&gt;irq == probe_irq_off(cookie), all is well */
)brace
r_else
multiline_comment|/* No preset IRQ; just use what we can detect */
id|dev-&gt;irq
op_assign
id|probe_irq_off
c_func
(paren
id|cookie
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|dev-&gt;irq
)paren
(brace
multiline_comment|/* Legal, sane? */
r_case
l_int|0
suffix:colon
id|printk
c_func
(paren
l_string|&quot;%s: IRQ probe failed: check 3c505 jumpers.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
r_case
l_int|1
suffix:colon
r_case
l_int|6
suffix:colon
r_case
l_int|8
suffix:colon
r_case
l_int|13
suffix:colon
id|printk
c_func
(paren
l_string|&quot;%s: Impossible IRQ %d reported by probe_irq_off().&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|dev-&gt;irq
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
multiline_comment|/*&n;&t; *  Now we have the IRQ number so we can disable the interrupts from&n;&t; *  the board until the board is opened.&n;&t; */
id|outb_control
c_func
(paren
id|adapter-&gt;hcr_val
op_amp
op_complement
id|CMDE
comma
id|dev
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * copy Ethernet address into structure&n;&t; */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|6
suffix:semicolon
id|i
op_increment
)paren
id|dev-&gt;dev_addr
(braket
id|i
)braket
op_assign
id|adapter-&gt;rx_pcb.data.eth_addr
(braket
id|i
)braket
suffix:semicolon
multiline_comment|/* find a DMA channel */
r_if
c_cond
(paren
op_logical_neg
id|dev-&gt;dma
)paren
(brace
r_if
c_cond
(paren
id|dev-&gt;mem_start
)paren
(brace
id|dev-&gt;dma
op_assign
id|dev-&gt;mem_start
op_amp
l_int|7
suffix:semicolon
)brace
r_else
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: warning, DMA channel not specified, using default&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|dev-&gt;dma
op_assign
id|ELP_DMA
suffix:semicolon
)brace
)brace
multiline_comment|/*&n;&t; * print remainder of startup message&n;&t; */
id|printk
c_func
(paren
l_string|&quot;%s: 3c505 at %#lx, irq %d, dma %d, &quot;
comma
id|dev-&gt;name
comma
id|dev-&gt;base_addr
comma
id|dev-&gt;irq
comma
id|dev-&gt;dma
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;addr %02x:%02x:%02x:%02x:%02x:%02x, &quot;
comma
id|dev-&gt;dev_addr
(braket
l_int|0
)braket
comma
id|dev-&gt;dev_addr
(braket
l_int|1
)braket
comma
id|dev-&gt;dev_addr
(braket
l_int|2
)braket
comma
id|dev-&gt;dev_addr
(braket
l_int|3
)braket
comma
id|dev-&gt;dev_addr
(braket
l_int|4
)braket
comma
id|dev-&gt;dev_addr
(braket
l_int|5
)braket
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * read more information from the adapter&n;&t; */
id|adapter-&gt;tx_pcb.command
op_assign
id|CMD_ADAPTER_INFO
suffix:semicolon
id|adapter-&gt;tx_pcb.length
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|send_pcb
c_func
(paren
id|dev
comma
op_amp
id|adapter-&gt;tx_pcb
)paren
op_logical_or
op_logical_neg
id|receive_pcb
c_func
(paren
id|dev
comma
op_amp
id|adapter-&gt;rx_pcb
)paren
op_logical_or
(paren
id|adapter-&gt;rx_pcb.command
op_ne
id|CMD_ADAPTER_INFO_RESPONSE
)paren
op_logical_or
(paren
id|adapter-&gt;rx_pcb.length
op_ne
l_int|10
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;not responding to second PCB&bslash;n&quot;
)paren
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;rev %d.%d, %dk&bslash;n&quot;
comma
id|adapter-&gt;rx_pcb.data.info.major_vers
comma
id|adapter-&gt;rx_pcb.data.info.minor_vers
comma
id|adapter-&gt;rx_pcb.data.info.RAM_sz
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * reconfigure the adapter memory to better suit our purposes&n;&t; */
id|adapter-&gt;tx_pcb.command
op_assign
id|CMD_CONFIGURE_ADAPTER_MEMORY
suffix:semicolon
id|adapter-&gt;tx_pcb.length
op_assign
l_int|12
suffix:semicolon
id|adapter-&gt;tx_pcb.data.memconf.cmd_q
op_assign
l_int|8
suffix:semicolon
id|adapter-&gt;tx_pcb.data.memconf.rcv_q
op_assign
l_int|8
suffix:semicolon
id|adapter-&gt;tx_pcb.data.memconf.mcast
op_assign
l_int|10
suffix:semicolon
id|adapter-&gt;tx_pcb.data.memconf.frame
op_assign
l_int|10
suffix:semicolon
id|adapter-&gt;tx_pcb.data.memconf.rcv_b
op_assign
l_int|10
suffix:semicolon
id|adapter-&gt;tx_pcb.data.memconf.progs
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|send_pcb
c_func
(paren
id|dev
comma
op_amp
id|adapter-&gt;tx_pcb
)paren
op_logical_or
op_logical_neg
id|receive_pcb
c_func
(paren
id|dev
comma
op_amp
id|adapter-&gt;rx_pcb
)paren
op_logical_or
(paren
id|adapter-&gt;rx_pcb.command
op_ne
id|CMD_CONFIGURE_ADAPTER_RESPONSE
)paren
op_logical_or
(paren
id|adapter-&gt;rx_pcb.length
op_ne
l_int|2
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%s: could not configure adapter memory&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|adapter-&gt;rx_pcb.data.configure
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%s: adapter configuration failed&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * initialise the device&n;&t; */
id|elp_init
c_func
(paren
id|dev
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#ifdef MODULE
DECL|variable|dev_3c505
r_static
r_struct
id|net_device
id|dev_3c505
(braket
id|ELP_MAX_CARDS
)braket
suffix:semicolon
DECL|variable|io
r_static
r_int
id|io
(braket
id|ELP_MAX_CARDS
)braket
suffix:semicolon
DECL|variable|irq
r_static
r_int
id|irq
(braket
id|ELP_MAX_CARDS
)braket
suffix:semicolon
DECL|variable|dma
r_static
r_int
id|dma
(braket
id|ELP_MAX_CARDS
)braket
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|io
comma
l_string|&quot;1-&quot;
id|__MODULE_STRING
c_func
(paren
id|ELP_MAX_CARDS
)paren
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|irq
comma
l_string|&quot;1-&quot;
id|__MODULE_STRING
c_func
(paren
id|ELP_MAX_CARDS
)paren
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|dma
comma
l_string|&quot;1-&quot;
id|__MODULE_STRING
c_func
(paren
id|ELP_MAX_CARDS
)paren
l_string|&quot;i&quot;
)paren
suffix:semicolon
DECL|function|init_module
r_int
id|init_module
c_func
(paren
r_void
)paren
(brace
r_int
id|this_dev
comma
id|found
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|this_dev
op_assign
l_int|0
suffix:semicolon
id|this_dev
OL
id|ELP_MAX_CARDS
suffix:semicolon
id|this_dev
op_increment
)paren
(brace
r_struct
id|net_device
op_star
id|dev
op_assign
op_amp
id|dev_3c505
(braket
id|this_dev
)braket
suffix:semicolon
id|dev-&gt;irq
op_assign
id|irq
(braket
id|this_dev
)braket
suffix:semicolon
id|dev-&gt;base_addr
op_assign
id|io
(braket
id|this_dev
)braket
suffix:semicolon
id|dev-&gt;init
op_assign
id|elplus_probe
suffix:semicolon
r_if
c_cond
(paren
id|dma
(braket
id|this_dev
)braket
)paren
(brace
id|dev-&gt;dma
op_assign
id|dma
(braket
id|this_dev
)braket
suffix:semicolon
)brace
r_else
(brace
id|dev-&gt;dma
op_assign
id|ELP_DMA
suffix:semicolon
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;3c505.c: warning, using default DMA channel,&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|io
(braket
id|this_dev
)braket
op_eq
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|this_dev
)paren
r_break
suffix:semicolon
id|printk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;3c505.c: module autoprobe not recommended, give io=xx.&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|register_netdev
c_func
(paren
id|dev
)paren
op_ne
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;3c505.c: Failed to register card at 0x%x.&bslash;n&quot;
comma
id|io
(braket
id|this_dev
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
id|found
op_ne
l_int|0
)paren
r_return
l_int|0
suffix:semicolon
r_return
op_minus
id|ENXIO
suffix:semicolon
)brace
id|found
op_increment
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|cleanup_module
r_void
id|cleanup_module
c_func
(paren
r_void
)paren
(brace
r_int
id|this_dev
suffix:semicolon
r_for
c_loop
(paren
id|this_dev
op_assign
l_int|0
suffix:semicolon
id|this_dev
OL
id|ELP_MAX_CARDS
suffix:semicolon
id|this_dev
op_increment
)paren
(brace
r_struct
id|net_device
op_star
id|dev
op_assign
op_amp
id|dev_3c505
(braket
id|this_dev
)braket
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;priv
op_ne
l_int|NULL
)paren
(brace
id|unregister_netdev
c_func
(paren
id|dev
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|dev-&gt;priv
)paren
suffix:semicolon
id|dev-&gt;priv
op_assign
l_int|NULL
suffix:semicolon
id|release_region
c_func
(paren
id|dev-&gt;base_addr
comma
id|ELP_IO_EXTENT
)paren
suffix:semicolon
)brace
)brace
)brace
macro_line|#endif&t;&t;&t;&t;/* MODULE */
eof
