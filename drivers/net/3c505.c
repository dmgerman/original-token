multiline_comment|/*&n; * Linux ethernet device driver for the 3Com Etherlink Plus (3C505)&n; * &t;By Craig Southeren&n; *&n; * elplus.c&t;This module implements an interface to the 3Com&n; *&t;&t;Etherlink Plus (3c505) ethernet card. Linux device &n; *&t;&t;driver interface reverse engineered from the Linux 3C509&n; *&t;&t;device drivers. Vital 3C505 information gleaned from&n; *&t;&t;the Crynwr packet driver&n; *&n; * Version:&t;@(#)elplus.c&t;0.5&t;11-Jun-94&n; *&n; * Authors:&t;Linux 3c505 device driver by:&n; *&t;&t;&t;Craig Southeren, &lt;geoffw@extro.ucc.su.oz.au&gt;&n; *              Final debugging by:&n; *&t;&t;&t;Andrew Tridgell, &lt;tridge@nimbus.anu.edu.au&gt;&n; *&t;&t;Auto irq, auto detect, cleanup and v1.1.4+ kernel mods by:&n; *&t;&t;&t;Juha Laiho, &lt;jlaiho@ichaos.nullnet.fi&gt;&n; *              Linux 3C509 driver by:&n; *             &t;&t;Donald Becker, &lt;becker@super.org&gt;&n; *&t;&t;Crynwr packet driver by&n; *&t;&t;&t;Krishnan Gopalan and Gregg Stefancik,&n; * &t;&t;&t;   Clemson University Engineering Computer Operations.&n; *&t;&t;&t;Portions of the code have been adapted from the 3c505&n; *&t;&t;&t;   driver for NCSA Telnet by Bruce Orchard and later&n; *&t;&t;&t;   modified by Warren Van Houten and krus@diku.dk.&n; *              3C505 technical information provided by&n; *                      Terry Murphy, of 3Com Network Adapter Division&n; *                     &n; */
multiline_comment|/*********************************************************&n; *&n; *  set ELP_KERNEL_TYPE to the following values depending upon&n; *  the kernel type:&n; *       0   = 0.99pl14 or earlier&n; *       1   = 0.99pl15 through 1.1.3&n; *       2   = 1.1.4 through 1.1.11&n; *       3   = 1.1.12 through 1.1.19&n; *       4   = 1.1.20&n; *&n; *********************************************************/
DECL|macro|ELP_KERNEL_TYPE
mdefine_line|#define&t;ELP_KERNEL_TYPE&t;4
multiline_comment|/*********************************************************&n; *&n; *  set ELP_NEED_HARD_RESET to 1, if having problems with&n; *  &quot;warm resets&quot; from DOS. Bootup will then take some more&n; *  time, as the adapter will perform self-test upon hard&n; *  reset. This misbehaviour is reported to happen at least&n; *  after use of Windows real-mode NDIS drivers.&n; *&n; *********************************************************/
DECL|macro|ELP_NEED_HARD_RESET
mdefine_line|#define ELP_NEED_HARD_RESET 0
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/interrupt.h&gt;
macro_line|#include &lt;linux/ptrace.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/in.h&gt;
macro_line|#include &lt;linux/malloc.h&gt;
macro_line|#include &lt;linux/ioport.h&gt;
macro_line|#include &lt;asm/bitops.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#if (ELP_KERNEL_TYPE &lt; 2)
macro_line|#include &quot;dev.h&quot;
macro_line|#include &quot;eth.h&quot;
macro_line|#include &quot;skbuff.h&quot;
macro_line|#include &quot;arp.h&quot;
macro_line|#else
macro_line|#include &lt;linux/netdevice.h&gt;
macro_line|#include &lt;linux/etherdevice.h&gt;
macro_line|#include &lt;linux/skbuff.h&gt;
macro_line|#endif
macro_line|#ifndef port_read
macro_line|#include &quot;iow.h&quot;
macro_line|#endif
macro_line|#include &quot;3c505.h&quot;
DECL|macro|ELPLUS_DEBUG
mdefine_line|#define ELPLUS_DEBUG 0
multiline_comment|/*********************************************************&n; *&n; *  define debug messages here as common strings to reduce space&n; *&n; *********************************************************/
DECL|variable|filename
r_static
r_char
op_star
id|filename
op_assign
id|__FILE__
suffix:semicolon
DECL|variable|null_msg
r_static
r_char
op_star
id|null_msg
op_assign
l_string|&quot;*** NULL at %s(%d) ***&bslash;n&quot;
suffix:semicolon
DECL|macro|CHECK_NULL
mdefine_line|#define CHECK_NULL(p) if (!p) printk(null_msg, filename, __LINE__)
DECL|variable|timeout_msg
r_static
r_char
op_star
id|timeout_msg
op_assign
l_string|&quot;*** timeout at %s(%d) ***&bslash;n&quot;
suffix:semicolon
DECL|macro|TIMEOUT_MSG
mdefine_line|#define TIMEOUT_MSG()     printk(timeout_msg, filename,__LINE__)
DECL|variable|invalid_pcb_msg
r_static
r_char
op_star
id|invalid_pcb_msg
op_assign
l_string|&quot;*** invalid pcb length %d at %s(%d) ***&bslash;n&quot;
suffix:semicolon
DECL|variable|search_msg
r_static
r_char
op_star
id|search_msg
op_assign
l_string|&quot;%s: Looking for 3c505 adapter at address 0x%x...&quot;
suffix:semicolon
DECL|variable|stilllooking_msg
r_static
r_char
op_star
id|stilllooking_msg
op_assign
l_string|&quot;still looking...&quot;
suffix:semicolon
DECL|variable|found_msg
r_static
r_char
op_star
id|found_msg
op_assign
l_string|&quot;found.&bslash;n&quot;
suffix:semicolon
DECL|variable|notfound_msg
r_static
r_char
op_star
id|notfound_msg
op_assign
l_string|&quot;not found (reason = %d)&bslash;n&quot;
suffix:semicolon
DECL|variable|couldnot_msg
r_static
r_char
op_star
id|couldnot_msg
op_assign
l_string|&quot;%s: 3c505 not found&bslash;n&quot;
suffix:semicolon
multiline_comment|/*********************************************************&n; *&n; *  various other debug stuff&n; *&n; *********************************************************/
macro_line|#ifdef ELPLUS_DEBUG
DECL|variable|elp_debug
r_static
r_int
id|elp_debug
op_assign
id|ELPLUS_DEBUG
suffix:semicolon
macro_line|#else
DECL|variable|elp_debug
r_static
r_int
id|elp_debug
op_assign
l_int|0
suffix:semicolon
macro_line|#endif
macro_line|#if (ELP_KERNEL_TYPE &lt; 2)
r_extern
r_void
id|skb_check
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_int
comma
r_char
op_star
)paren
suffix:semicolon
macro_line|#ifndef IS_SKB
DECL|macro|IS_SKB
mdefine_line|#define IS_SKB(skb)&t;skb_check((skb),__LINE__,filename)
macro_line|#endif
macro_line|#else
macro_line|#ifndef IS_SKB
DECL|macro|IS_SKB
mdefine_line|#define IS_SKB(skb)&t;skb_check((skb),0,__LINE__,filename)
macro_line|#endif
macro_line|#endif
multiline_comment|/*&n; *  0 = no messages&n; *  1 = messages when high level commands performed&n; *  2 = messages when low level commands performed&n; *  3 = messages when interrupts received&n; */
DECL|macro|ELPLUS_VERSION
mdefine_line|#define&t;ELPLUS_VERSION&t;&quot;0.4.0&quot;
multiline_comment|/*****************************************************************&n; *&n; * useful macros&n; *&n; *****************************************************************/
multiline_comment|/*&n; *  kernels before pl15 used an unobvious method for accessing&n; *  the skb data area&n; */
macro_line|#if (ELP_KERNEL_TYPE &lt; 1)
DECL|macro|SKB_DATA
mdefine_line|#define&t;SKB_DATA&t;(skb+1)
macro_line|#else
DECL|macro|SKB_DATA
mdefine_line|#define&t;SKB_DATA&t;(skb-&gt;data) 
macro_line|#endif
multiline_comment|/*&n; *  not all kernels before 1.1.4 had an alloc_skb function (apparently!!)&n; */
macro_line|#if (ELP_KERNEL_TYPE &lt; 2)
macro_line|#ifndef HAVE_ALLOC_SKB
DECL|macro|alloc_skb
mdefine_line|#define alloc_skb(size, priority) (struct sk_buff *) kmalloc(size,priority)
macro_line|#endif
macro_line|#endif
DECL|macro|INB
mdefine_line|#define&t;INB(port)&t;inb((unsigned short)(port)) 
DECL|macro|OUTB
mdefine_line|#define&t;OUTB(val,port)&t;outb((unsigned char)(val),(unsigned short)(port));
macro_line|#ifndef&t;TRUE
DECL|macro|TRUE
mdefine_line|#define&t;TRUE&t;1
macro_line|#endif
macro_line|#ifndef&t;FALSE
DECL|macro|FALSE
mdefine_line|#define&t;FALSE&t;0
macro_line|#endif
multiline_comment|/*****************************************************************&n; *&n; * List of I/O-addresses we try to auto-sense&n; * Last element MUST BE 0!&n; *****************************************************************/
DECL|variable|addr_list
r_const
r_int
id|addr_list
(braket
)braket
op_assign
initialization_block
suffix:semicolon
multiline_comment|/*****************************************************************&n; *&n; * PCB structure&n; *&n; *****************************************************************/
macro_line|#include &quot;3c505dta.h&quot;
multiline_comment|/*****************************************************************&n; *&n; *  structure to hold context information for adapter&n; *&n; *****************************************************************/
r_typedef
r_struct
(brace
DECL|member|io_addr
r_int
id|io_addr
suffix:semicolon
multiline_comment|/* base I/O address */
DECL|member|name
r_char
op_star
id|name
suffix:semicolon
multiline_comment|/* used for debug output */
DECL|member|got
r_int
id|got
(braket
id|NUM_TRANSMIT_CMDS
)braket
suffix:semicolon
multiline_comment|/* flags for command completion */
DECL|member|tx_pcb
id|pcb_struct
id|tx_pcb
suffix:semicolon
multiline_comment|/* PCB for foreground sending */
DECL|member|rx_pcb
id|pcb_struct
id|rx_pcb
suffix:semicolon
multiline_comment|/* PCB for foreground receiving */
DECL|member|itx_pcb
id|pcb_struct
id|itx_pcb
suffix:semicolon
multiline_comment|/* PCB for background sending */
DECL|member|irx_pcb
id|pcb_struct
id|irx_pcb
suffix:semicolon
multiline_comment|/* PCB for background receiving */
DECL|member|stats
r_struct
id|enet_statistics
id|stats
suffix:semicolon
DECL|typedef|elp_device
)brace
id|elp_device
suffix:semicolon
multiline_comment|/*****************************************************************&n; *&n; *  useful functions for accessing the adapter&n; *&n; *****************************************************************/
multiline_comment|/*&n; * use this routine when accessing the ASF bits as they are&n; * changed asynchronously by the adapter&n; */
multiline_comment|/* get adapter PCB status */
DECL|macro|GET_ASF
mdefine_line|#define&t;GET_ASF()  &t;(get_status(adapter)&amp;ASF_PCB_MASK)
DECL|macro|GET_STATUS
mdefine_line|#define&t;GET_STATUS()  &t;(get_status(adapter))
DECL|function|get_status
r_static
r_int
id|get_status
(paren
id|elp_device
op_star
id|adapter
)paren
(brace
r_int
id|timeout
op_assign
id|jiffies
op_plus
id|TIMEOUT
suffix:semicolon
r_register
r_int
id|stat1
suffix:semicolon
r_do
(brace
id|stat1
op_assign
id|INB
c_func
(paren
id|adapter-&gt;io_addr
op_plus
id|PORT_STATUS
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
id|stat1
op_ne
id|INB
c_func
(paren
id|adapter-&gt;io_addr
op_plus
id|PORT_STATUS
)paren
op_logical_and
id|jiffies
OL
id|timeout
)paren
suffix:semicolon
r_if
c_cond
(paren
id|jiffies
op_ge
id|timeout
)paren
id|TIMEOUT_MSG
c_func
(paren
)paren
suffix:semicolon
r_return
id|stat1
suffix:semicolon
)brace
DECL|macro|SET_HSF
mdefine_line|#define&t;SET_HSF(hsf)&t;(set_hsf(adapter,hsf))
DECL|function|set_hsf
r_static
r_void
id|set_hsf
(paren
id|elp_device
op_star
id|adapter
comma
r_int
id|hsf
)paren
(brace
id|cli
c_func
(paren
)paren
suffix:semicolon
id|OUTB
c_func
(paren
(paren
id|INB
c_func
(paren
id|adapter-&gt;io_addr
op_plus
id|PORT_CONTROL
)paren
op_amp
(paren
op_complement
id|HSF_PCB_MASK
)paren
)paren
op_or
id|hsf
comma
id|adapter-&gt;io_addr
op_plus
id|PORT_CONTROL
)paren
suffix:semicolon
id|sti
c_func
(paren
)paren
suffix:semicolon
)brace
DECL|macro|WAIT_HCRE
mdefine_line|#define&t;WAIT_HCRE(toval)&t;(wait_hcre(adapter,toval))
DECL|function|wait_hcre
r_static
r_int
id|wait_hcre
c_func
(paren
id|elp_device
op_star
id|adapter
comma
r_int
id|toval
)paren
(brace
r_int
id|timeout
op_assign
id|jiffies
op_plus
id|toval
suffix:semicolon
r_while
c_loop
(paren
(paren
(paren
id|INB
c_func
(paren
id|adapter-&gt;io_addr
op_plus
id|PORT_STATUS
)paren
op_amp
id|STATUS_HCRE
)paren
op_eq
l_int|0
)paren
op_logical_and
(paren
id|jiffies
op_le
id|timeout
)paren
)paren
(brace
suffix:semicolon
)brace
r_if
c_cond
(paren
id|jiffies
op_ge
id|timeout
)paren
(brace
id|TIMEOUT_MSG
c_func
(paren
)paren
suffix:semicolon
r_return
id|FALSE
suffix:semicolon
)brace
r_return
id|TRUE
suffix:semicolon
)brace
multiline_comment|/*****************************************************************&n; *&n; * send_pcb&n; *   Send a PCB to the adapter. &n; *&n; *&t;output byte to command reg  --&lt;--+&n; *&t;wait until HCRE is non zero      |&n; *&t;loop until all bytes sent   --&gt;--+&n; *&t;set HSF1 and HSF2 to 1&n; *&t;output pcb length&n; *&t;wait until ASF give ACK or NAK&n; *&t;set HSF1 and HSF2 to 0&n; *&n; *****************************************************************/
DECL|function|send_pcb
r_static
r_int
id|send_pcb
c_func
(paren
id|elp_device
op_star
id|adapter
comma
id|pcb_struct
op_star
id|pcb
)paren
(brace
r_int
id|i
suffix:semicolon
r_int
id|cont
suffix:semicolon
r_int
id|retry
op_assign
l_int|0
suffix:semicolon
r_int
id|timeout
suffix:semicolon
id|CHECK_NULL
c_func
(paren
id|pcb
)paren
suffix:semicolon
id|CHECK_NULL
c_func
(paren
id|adapter
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pcb-&gt;length
OG
id|MAX_PCB_DATA
)paren
id|printk
c_func
(paren
id|invalid_pcb_msg
comma
id|pcb-&gt;length
comma
id|filename
comma
id|__LINE__
)paren
suffix:semicolon
r_while
c_loop
(paren
l_int|1
)paren
(brace
id|cont
op_assign
l_int|1
suffix:semicolon
multiline_comment|/*&n;     * load each byte into the command register and&n;     * wait for the HCRE bit to indicate the adapter&n;     * had read the byte&n;     */
id|SET_HSF
c_func
(paren
l_int|0
)paren
suffix:semicolon
id|OUTB
c_func
(paren
id|pcb-&gt;command
comma
(paren
id|adapter-&gt;io_addr
)paren
op_plus
id|PORT_COMMAND
)paren
suffix:semicolon
id|cont
op_assign
id|WAIT_HCRE
c_func
(paren
l_int|5
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cont
)paren
(brace
id|OUTB
c_func
(paren
id|pcb-&gt;length
comma
(paren
id|adapter-&gt;io_addr
)paren
op_plus
id|PORT_COMMAND
)paren
suffix:semicolon
id|cont
op_assign
id|WAIT_HCRE
c_func
(paren
l_int|2
)paren
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|cont
op_logical_and
(paren
id|i
OL
id|pcb-&gt;length
)paren
suffix:semicolon
id|i
op_increment
)paren
(brace
id|OUTB
c_func
(paren
id|pcb-&gt;data.raw
(braket
id|i
)braket
comma
(paren
id|adapter-&gt;io_addr
)paren
op_plus
id|PORT_COMMAND
)paren
suffix:semicolon
id|cont
op_assign
id|WAIT_HCRE
c_func
(paren
l_int|2
)paren
suffix:semicolon
)brace
multiline_comment|/* set the host status bits to indicate end of PCB */
multiline_comment|/* send the total packet length as well */
multiline_comment|/* wait for the adapter to indicate that it has read the PCB */
r_if
c_cond
(paren
id|cont
)paren
(brace
id|SET_HSF
c_func
(paren
id|HSF_PCB_END
)paren
suffix:semicolon
id|OUTB
c_func
(paren
l_int|2
op_plus
id|pcb-&gt;length
comma
id|adapter-&gt;io_addr
op_plus
id|PORT_COMMAND
)paren
suffix:semicolon
id|timeout
op_assign
id|jiffies
op_plus
l_int|6
suffix:semicolon
r_while
c_loop
(paren
id|jiffies
OL
id|timeout
)paren
(brace
id|i
op_assign
id|GET_ASF
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|i
op_eq
id|ASF_PCB_ACK
)paren
op_logical_or
(paren
id|i
op_eq
id|ASF_PCB_NAK
)paren
)paren
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|jiffies
op_ge
id|timeout
)paren
id|TIMEOUT_MSG
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
op_eq
id|ASF_PCB_ACK
)paren
(brace
id|SET_HSF
c_func
(paren
l_int|0
)paren
suffix:semicolon
r_return
id|TRUE
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|i
op_eq
id|ASF_PCB_NAK
)paren
(brace
id|SET_HSF
c_func
(paren
l_int|0
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;%s: PCB send was NAKed&bslash;n&quot;
comma
id|adapter-&gt;name
)paren
suffix:semicolon
(brace
r_int
id|to
op_assign
id|jiffies
op_plus
l_int|5
suffix:semicolon
r_while
c_loop
(paren
id|jiffies
OL
id|to
)paren
suffix:semicolon
)brace
)brace
)brace
r_if
c_cond
(paren
id|elp_debug
op_ge
l_int|2
)paren
id|printk
c_func
(paren
l_string|&quot;%s: NAK/timeout on send PCB&bslash;n&quot;
comma
id|adapter-&gt;name
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|retry
op_increment
op_amp
l_int|7
)paren
op_eq
l_int|0
)paren
id|printk
c_func
(paren
l_string|&quot;%s: retry #%i on send PCB&bslash;n&quot;
comma
id|adapter-&gt;name
comma
id|retry
)paren
suffix:semicolon
)brace
r_return
id|FALSE
suffix:semicolon
)brace
multiline_comment|/*****************************************************************&n; *&n; * receive_pcb&n; *   Read a PCB to the adapter&n; *&n; *&t;wait for ACRF to be non-zero         ---&lt;---+&n; *      input a byte                                |&n; *      if ASF1 and ASF2 were not both one          |&n; *           before byte was read, loop      ---&gt;---+&n; *      set HSF1 and HSF2 for ack&n; *&n; *****************************************************************/
DECL|function|receive_pcb
r_static
r_int
id|receive_pcb
c_func
(paren
id|elp_device
op_star
id|adapter
comma
id|pcb_struct
op_star
id|pcb
)paren
(brace
r_int
id|i
suffix:semicolon
r_int
id|total_length
suffix:semicolon
r_int
id|stat
suffix:semicolon
r_int
id|timeout
suffix:semicolon
id|CHECK_NULL
c_func
(paren
id|pcb
)paren
suffix:semicolon
id|CHECK_NULL
c_func
(paren
id|adapter
)paren
suffix:semicolon
multiline_comment|/* get the command code */
id|timeout
op_assign
id|jiffies
op_plus
id|TIMEOUT
suffix:semicolon
r_while
c_loop
(paren
(paren
(paren
id|stat
op_assign
id|GET_STATUS
c_func
(paren
)paren
)paren
op_amp
id|STATUS_ACRF
)paren
op_eq
l_int|0
op_logical_and
id|jiffies
OL
id|timeout
)paren
suffix:semicolon
r_if
c_cond
(paren
id|jiffies
op_ge
id|timeout
)paren
id|TIMEOUT_MSG
c_func
(paren
)paren
suffix:semicolon
id|SET_HSF
c_func
(paren
l_int|0
)paren
suffix:semicolon
id|pcb-&gt;command
op_assign
id|INB
c_func
(paren
id|adapter-&gt;io_addr
op_plus
id|PORT_COMMAND
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|stat
op_amp
id|ASF_PCB_MASK
)paren
op_ne
id|ASF_PCB_END
)paren
(brace
multiline_comment|/* read the data length */
id|timeout
op_assign
id|jiffies
op_plus
id|TIMEOUT
suffix:semicolon
r_while
c_loop
(paren
(paren
(paren
id|stat
op_assign
id|GET_STATUS
c_func
(paren
)paren
)paren
op_amp
id|STATUS_ACRF
)paren
op_eq
l_int|0
op_logical_and
id|jiffies
OL
id|timeout
)paren
suffix:semicolon
r_if
c_cond
(paren
id|jiffies
op_ge
id|timeout
)paren
id|TIMEOUT_MSG
c_func
(paren
)paren
suffix:semicolon
id|pcb-&gt;length
op_assign
id|INB
c_func
(paren
id|adapter-&gt;io_addr
op_plus
id|PORT_COMMAND
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pcb-&gt;length
OG
id|MAX_PCB_DATA
)paren
id|printk
c_func
(paren
id|invalid_pcb_msg
comma
id|pcb-&gt;length
comma
id|filename
comma
id|__LINE__
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|stat
op_amp
id|ASF_PCB_MASK
)paren
op_ne
id|ASF_PCB_END
)paren
(brace
multiline_comment|/* read the data */
id|i
op_assign
l_int|0
suffix:semicolon
id|timeout
op_assign
id|jiffies
op_plus
id|TIMEOUT
suffix:semicolon
r_do
(brace
r_while
c_loop
(paren
(paren
(paren
id|stat
op_assign
id|GET_STATUS
c_func
(paren
)paren
)paren
op_amp
id|STATUS_ACRF
)paren
op_eq
l_int|0
op_logical_and
id|jiffies
OL
id|timeout
)paren
suffix:semicolon
id|pcb-&gt;data.raw
(braket
id|i
op_increment
)braket
op_assign
id|INB
c_func
(paren
id|adapter-&gt;io_addr
op_plus
id|PORT_COMMAND
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
OG
id|MAX_PCB_DATA
)paren
id|printk
c_func
(paren
id|invalid_pcb_msg
comma
id|i
comma
id|filename
comma
id|__LINE__
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
(paren
id|stat
op_amp
id|ASF_PCB_MASK
)paren
op_ne
id|ASF_PCB_END
op_logical_and
id|jiffies
OL
id|timeout
)paren
suffix:semicolon
r_if
c_cond
(paren
id|jiffies
op_ge
id|timeout
)paren
id|TIMEOUT_MSG
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* woops, the last &quot;data&quot; byte was really the length! */
id|total_length
op_assign
id|pcb-&gt;data.raw
(braket
op_decrement
id|i
)braket
suffix:semicolon
multiline_comment|/* safety check total length vs data length */
r_if
c_cond
(paren
id|total_length
op_ne
(paren
id|pcb-&gt;length
op_plus
l_int|2
)paren
)paren
(brace
r_if
c_cond
(paren
id|elp_debug
op_ge
l_int|2
)paren
id|printk
c_func
(paren
l_string|&quot;%s: mangled PCB received&bslash;n&quot;
comma
id|adapter-&gt;name
)paren
suffix:semicolon
id|SET_HSF
c_func
(paren
id|HSF_PCB_NAK
)paren
suffix:semicolon
r_return
id|FALSE
suffix:semicolon
)brace
id|SET_HSF
c_func
(paren
id|HSF_PCB_ACK
)paren
suffix:semicolon
r_return
id|TRUE
suffix:semicolon
)brace
)brace
id|SET_HSF
c_func
(paren
id|HSF_PCB_NAK
)paren
suffix:semicolon
r_return
id|FALSE
suffix:semicolon
)brace
macro_line|#if ELP_NEED_HARD_RESET
DECL|function|adapter_hard_reset
r_static
r_void
id|adapter_hard_reset
c_func
(paren
id|elp_device
op_star
id|adapter
)paren
(brace
r_int
id|timeout
suffix:semicolon
id|CHECK_NULL
c_func
(paren
id|adapter
)paren
suffix:semicolon
multiline_comment|/*&n;   * take FLSH and ATTN high&n;   */
id|OUTB
c_func
(paren
id|CONTROL_ATTN
op_or
id|CONTROL_FLSH
comma
id|adapter-&gt;io_addr
op_plus
id|PORT_CONTROL
)paren
suffix:semicolon
multiline_comment|/*&n;   * wait for a little bit&n;   */
r_for
c_loop
(paren
id|timeout
op_assign
id|jiffies
op_plus
l_int|20
suffix:semicolon
id|jiffies
op_le
id|timeout
suffix:semicolon
)paren
suffix:semicolon
multiline_comment|/*&n;   * now take them low&n;   */
id|OUTB
c_func
(paren
l_int|0
comma
id|adapter-&gt;io_addr
op_plus
id|PORT_CONTROL
)paren
suffix:semicolon
multiline_comment|/*&n;   * wait for a little bit&n;   */
r_for
c_loop
(paren
id|timeout
op_assign
id|jiffies
op_plus
l_int|20
suffix:semicolon
id|jiffies
op_le
id|timeout
suffix:semicolon
)paren
suffix:semicolon
multiline_comment|/*&n;   * now hang around until the board gets it&squot;s act together&n;   */
r_for
c_loop
(paren
id|timeout
op_assign
id|jiffies
op_plus
(paren
l_int|100
op_star
l_int|15
)paren
suffix:semicolon
id|jiffies
op_le
id|timeout
suffix:semicolon
)paren
r_if
c_cond
(paren
id|GET_ASF
c_func
(paren
)paren
op_ne
id|ASF_PCB_END
)paren
r_break
suffix:semicolon
)brace
macro_line|#endif /* ELP_NEED_HARD_RESET */
DECL|function|adapter_reset
r_static
r_void
id|adapter_reset
c_func
(paren
id|elp_device
op_star
id|adapter
)paren
(brace
r_int
id|timeout
suffix:semicolon
id|CHECK_NULL
c_func
(paren
id|adapter
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|OUTB
c_func
(paren
id|CONTROL_ATTN
op_or
id|INB
c_func
(paren
id|adapter-&gt;io_addr
op_plus
id|PORT_CONTROL
)paren
comma
id|adapter-&gt;io_addr
op_plus
id|PORT_CONTROL
)paren
suffix:semicolon
id|sti
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/*&n;   * wait for a little bit&n;   */
r_for
c_loop
(paren
id|timeout
op_assign
id|jiffies
op_plus
l_int|20
suffix:semicolon
id|jiffies
op_le
id|timeout
suffix:semicolon
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|OUTB
c_func
(paren
id|INB
c_func
(paren
id|adapter-&gt;io_addr
op_plus
id|PORT_CONTROL
)paren
op_amp
op_complement
(paren
id|CONTROL_ATTN
)paren
comma
id|adapter-&gt;io_addr
op_plus
id|PORT_CONTROL
)paren
suffix:semicolon
id|sti
c_func
(paren
)paren
suffix:semicolon
)brace
multiline_comment|/******************************************************&n; *&n; *  queue a receive command on the adapter so we will get an&n; *  interrupt when a packet is received.&n; *&n; ******************************************************/
DECL|function|start_receive
r_static
r_int
id|start_receive
c_func
(paren
id|elp_device
op_star
id|adapter
comma
id|pcb_struct
op_star
id|tx_pcb
)paren
(brace
id|CHECK_NULL
c_func
(paren
id|adapter
)paren
suffix:semicolon
id|CHECK_NULL
c_func
(paren
id|tx_pcb
)paren
suffix:semicolon
r_if
c_cond
(paren
id|elp_debug
op_ge
l_int|3
)paren
id|printk
c_func
(paren
l_string|&quot;%s: restarting receiver&bslash;n&quot;
comma
id|adapter-&gt;name
)paren
suffix:semicolon
id|tx_pcb-&gt;command
op_assign
id|CMD_RECEIVE_PACKET
suffix:semicolon
id|tx_pcb-&gt;length
op_assign
r_sizeof
(paren
r_struct
id|Rcv_pkt
)paren
suffix:semicolon
id|tx_pcb-&gt;data.rcv_pkt.buf_seg
op_assign
id|tx_pcb-&gt;data.rcv_pkt.buf_ofs
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Unused */
id|tx_pcb-&gt;data.rcv_pkt.buf_len
op_assign
l_int|1600
suffix:semicolon
id|tx_pcb-&gt;data.rcv_pkt.timeout
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* set timeout to zero */
r_return
id|send_pcb
c_func
(paren
id|adapter
comma
id|tx_pcb
)paren
suffix:semicolon
)brace
multiline_comment|/******************************************************&n; *&n; * extract a packet from the adapter&n; * this routine is only called from within the interrupt&n; * service routine, so no cli/sti calls are needed&n; * note that the length is always assumed to be even&n; *&n; ******************************************************/
DECL|function|receive_packet
r_static
r_void
id|receive_packet
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
id|elp_device
op_star
id|adapter
comma
r_int
id|len
)paren
(brace
r_register
r_int
id|i
suffix:semicolon
r_int
r_int
op_star
id|ptr
suffix:semicolon
r_int
id|d
suffix:semicolon
r_int
id|timeout
suffix:semicolon
r_int
id|rlen
suffix:semicolon
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
multiline_comment|/*&n;   * allocate a buffer to put the packet into.&n;   * (for kernels prior to 1.1.4 only)&n;   */
macro_line|#if (ELP_KERNEL_TYPE &lt; 2)
r_int
id|sksize
op_assign
r_sizeof
(paren
r_struct
id|sk_buff
)paren
op_plus
id|len
op_plus
l_int|4
suffix:semicolon
macro_line|#endif
id|CHECK_NULL
c_func
(paren
id|dev
)paren
suffix:semicolon
id|CHECK_NULL
c_func
(paren
id|adapter
)paren
suffix:semicolon
r_if
c_cond
(paren
id|len
op_le
l_int|0
op_logical_or
(paren
(paren
id|len
op_amp
op_complement
l_int|1
)paren
op_ne
id|len
)paren
)paren
r_if
c_cond
(paren
id|elp_debug
op_ge
l_int|3
)paren
id|printk
c_func
(paren
l_string|&quot;*** bad packet len %d at %s(%d)&bslash;n&quot;
comma
id|len
comma
id|filename
comma
id|__LINE__
)paren
suffix:semicolon
id|rlen
op_assign
(paren
id|len
op_plus
l_int|1
)paren
op_amp
op_complement
l_int|1
suffix:semicolon
macro_line|#if (ELP_KERNEL_TYPE &lt; 2)
id|skb
op_assign
id|alloc_skb
c_func
(paren
id|sksize
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
macro_line|#else
id|skb
op_assign
id|alloc_skb
c_func
(paren
id|rlen
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/*&n;   * make sure the data register is going the right way&n;   */
id|OUTB
c_func
(paren
id|INB
c_func
(paren
id|adapter-&gt;io_addr
op_plus
id|PORT_CONTROL
)paren
op_or
id|CONTROL_DIR
comma
id|adapter-&gt;io_addr
op_plus
id|PORT_CONTROL
)paren
suffix:semicolon
multiline_comment|/*&n;   * if buffer could not be allocated, swallow it&n;   */
r_if
c_cond
(paren
id|skb
op_eq
l_int|NULL
)paren
(brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
(paren
id|rlen
op_div
l_int|2
)paren
suffix:semicolon
id|i
op_increment
)paren
(brace
id|timeout
op_assign
id|jiffies
op_plus
id|TIMEOUT
suffix:semicolon
r_while
c_loop
(paren
(paren
id|INB
c_func
(paren
id|adapter-&gt;io_addr
op_plus
id|PORT_STATUS
)paren
op_amp
id|STATUS_HRDY
)paren
op_eq
l_int|0
op_logical_and
id|jiffies
OL
id|timeout
)paren
suffix:semicolon
r_if
c_cond
(paren
id|jiffies
op_ge
id|timeout
)paren
id|TIMEOUT_MSG
c_func
(paren
)paren
suffix:semicolon
id|d
op_assign
id|inw
c_func
(paren
id|adapter-&gt;io_addr
op_plus
id|PORT_DATA
)paren
suffix:semicolon
)brace
id|adapter-&gt;stats.rx_dropped
op_increment
suffix:semicolon
)brace
r_else
(brace
id|skb-&gt;lock
op_assign
l_int|0
suffix:semicolon
id|skb-&gt;len
op_assign
id|rlen
suffix:semicolon
id|skb-&gt;dev
op_assign
id|dev
suffix:semicolon
multiline_comment|/*&n; * for kernels before 1.1.4, the driver allocated the buffer&n; */
macro_line|#if (ELP_KERNEL_TYPE &lt; 2)
id|skb-&gt;mem_len
op_assign
id|sksize
suffix:semicolon
id|skb-&gt;mem_addr
op_assign
id|skb
suffix:semicolon
macro_line|#endif
multiline_comment|/*&n;     * now read the data from the adapter&n;     */
id|ptr
op_assign
(paren
r_int
r_int
op_star
)paren
id|SKB_DATA
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
(paren
id|rlen
op_div
l_int|2
)paren
suffix:semicolon
id|i
op_increment
)paren
(brace
id|timeout
op_assign
id|jiffies
op_plus
id|TIMEOUT
suffix:semicolon
r_while
c_loop
(paren
(paren
id|INB
c_func
(paren
id|adapter-&gt;io_addr
op_plus
id|PORT_STATUS
)paren
op_amp
id|STATUS_HRDY
)paren
op_eq
l_int|0
op_logical_and
id|jiffies
OL
id|timeout
)paren
suffix:semicolon
r_if
c_cond
(paren
id|jiffies
op_ge
id|timeout
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;*** timeout at %s(%d) reading word %d of %d ***&bslash;n&quot;
comma
id|filename
comma
id|__LINE__
comma
id|i
comma
id|rlen
op_div
l_int|2
)paren
suffix:semicolon
macro_line|#if (ELP_KERNEL_TYPE &lt; 2)
id|kfree_s
c_func
(paren
id|skb
comma
id|sksize
)paren
suffix:semicolon
macro_line|#else
id|kfree_s
c_func
(paren
id|skb
comma
id|rlen
)paren
suffix:semicolon
macro_line|#endif
r_return
suffix:semicolon
)brace
op_star
id|ptr
op_assign
id|inw
c_func
(paren
id|adapter-&gt;io_addr
op_plus
id|PORT_DATA
)paren
suffix:semicolon
id|ptr
op_increment
suffix:semicolon
)brace
multiline_comment|/*&n;     * the magic routine &quot;dev_rint&quot; passes the packet up the&n;     * protocol chain. If it returns 0, we can assume the packet was&n;     * swallowed up. If not, then we are responsible for freeing memory&n;     */
id|IS_SKB
c_func
(paren
id|skb
)paren
suffix:semicolon
multiline_comment|/*&n; * for kernels before 1.1.4, the driver allocated the buffer, so it had&n; * to free it&n; */
macro_line|#if (ELP_KERNEL_TYPE &lt; 2)
r_if
c_cond
(paren
id|dev_rint
c_func
(paren
(paren
r_int
r_char
op_star
)paren
id|skb
comma
id|rlen
comma
id|IN_SKBUFF
comma
id|dev
)paren
op_ne
l_int|0
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%s: receive buffers full.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|kfree_s
c_func
(paren
id|skb
comma
id|sksize
)paren
suffix:semicolon
)brace
macro_line|#else
id|netif_rx
c_func
(paren
id|skb
)paren
suffix:semicolon
macro_line|#endif
)brace
id|OUTB
c_func
(paren
id|INB
c_func
(paren
id|adapter-&gt;io_addr
op_plus
id|PORT_CONTROL
)paren
op_amp
(paren
op_complement
id|CONTROL_DIR
)paren
comma
id|adapter-&gt;io_addr
op_plus
id|PORT_CONTROL
)paren
suffix:semicolon
)brace
multiline_comment|/******************************************************&n; *&n; * interrupt handler&n; *&n; ******************************************************/
DECL|function|elp_interrupt
r_static
r_void
id|elp_interrupt
c_func
(paren
r_int
id|reg_ptr
)paren
(brace
r_int
id|len
suffix:semicolon
r_int
id|dlen
suffix:semicolon
r_int
id|irq
op_assign
op_minus
(paren
(paren
(paren
r_struct
id|pt_regs
op_star
)paren
id|reg_ptr
)paren
op_member_access_from_pointer
id|orig_eax
op_plus
l_int|2
)paren
suffix:semicolon
r_struct
id|device
op_star
id|dev
suffix:semicolon
id|elp_device
op_star
id|adapter
suffix:semicolon
r_int
id|timeout
suffix:semicolon
r_if
c_cond
(paren
id|irq
template_param
l_int|15
)paren
(brace
id|printk
(paren
l_string|&quot;elp_interrupt(): illegal IRQ number found in interrupt routine (%i)&bslash;n&quot;
comma
id|irq
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/* FIXME: How do I do this kind of check without a fixed IRQ? */
macro_line|#if 0
r_if
c_cond
(paren
id|irq
op_ne
id|ELP_IRQ
)paren
(brace
id|printk
(paren
l_string|&quot;elp_interrupt(): - interrupt routine has incorrect IRQ of %i&bslash;n&quot;
comma
id|irq
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
macro_line|#endif
id|dev
op_assign
id|irq2dev_map
(braket
id|irq
)braket
suffix:semicolon
r_if
c_cond
(paren
id|dev
op_eq
l_int|NULL
)paren
(brace
id|printk
(paren
l_string|&quot;elp_interrupt(): irq %d for unknown device.&bslash;n&quot;
comma
id|irq
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|adapter
op_assign
(paren
id|elp_device
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|CHECK_NULL
c_func
(paren
id|adapter
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;interrupt
)paren
r_if
c_cond
(paren
id|elp_debug
op_ge
l_int|2
)paren
id|printk
c_func
(paren
l_string|&quot;%s: Re-entering the interrupt handler.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|dev-&gt;interrupt
op_assign
l_int|1
suffix:semicolon
multiline_comment|/*&n;   * allow interrupts (we need timers!)&n;   */
id|sti
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/*&n;   * receive a PCB from the adapter&n;   */
id|timeout
op_assign
id|jiffies
op_plus
id|TIMEOUT
suffix:semicolon
r_while
c_loop
(paren
(paren
id|INB
c_func
(paren
id|adapter-&gt;io_addr
op_plus
id|PORT_STATUS
)paren
op_amp
id|STATUS_ACRF
)paren
op_ne
l_int|0
op_logical_and
id|jiffies
OL
id|timeout
)paren
(brace
r_if
c_cond
(paren
id|receive_pcb
c_func
(paren
id|adapter
comma
op_amp
id|adapter-&gt;irx_pcb
)paren
)paren
(brace
r_switch
c_cond
(paren
id|adapter-&gt;irx_pcb.command
)paren
(brace
multiline_comment|/*&n;         * 82586 configured correctly&n;         */
r_case
id|CMD_CONFIGURE_82586_RESPONSE
suffix:colon
id|adapter-&gt;got
(braket
id|CMD_CONFIGURE_82586
)braket
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|elp_debug
op_ge
l_int|3
)paren
id|printk
c_func
(paren
l_string|&quot;%s: interrupt - configure response received&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_break
suffix:semicolon
multiline_comment|/*&n;&t; * Adapter memory configuration&n;&t; */
r_case
id|CMD_CONFIGURE_ADAPTER_RESPONSE
suffix:colon
id|adapter-&gt;got
(braket
id|CMD_CONFIGURE_ADAPTER_MEMORY
)braket
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|elp_debug
op_ge
l_int|3
)paren
id|printk
c_func
(paren
l_string|&quot;%s: Adapter memory configuration %s.&quot;
comma
id|dev-&gt;name
comma
id|adapter-&gt;irx_pcb.data.failed
ques
c_cond
l_string|&quot;failed&quot;
suffix:colon
l_string|&quot;succeeded&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
multiline_comment|/*&n;&t; * Multicast list loading&n;&t; */
r_case
id|CMD_LOAD_MULTICAST_RESPONSE
suffix:colon
id|adapter-&gt;got
(braket
id|CMD_LOAD_MULTICAST_LIST
)braket
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|elp_debug
op_ge
l_int|3
)paren
id|printk
c_func
(paren
l_string|&quot;%s: Multicast address list loading %s.&quot;
comma
id|dev-&gt;name
comma
id|adapter-&gt;irx_pcb.data.failed
ques
c_cond
l_string|&quot;failed&quot;
suffix:colon
l_string|&quot;succeeded&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
multiline_comment|/*&n;&t; * Station address setting&n;&t; */
r_case
id|CMD_SET_ADDRESS_RESPONSE
suffix:colon
id|adapter-&gt;got
(braket
id|CMD_SET_STATION_ADDRESS
)braket
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|elp_debug
op_ge
l_int|3
)paren
id|printk
c_func
(paren
l_string|&quot;%s: Ethernet address setting %s.&quot;
comma
id|dev-&gt;name
comma
id|adapter-&gt;irx_pcb.data.failed
ques
c_cond
l_string|&quot;failed&quot;
suffix:colon
l_string|&quot;succeeded&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
multiline_comment|/*&n;         * received board statistics&n;         */
r_case
id|CMD_NETWORK_STATISTICS_RESPONSE
suffix:colon
id|adapter-&gt;stats.rx_packets
op_add_assign
id|adapter-&gt;irx_pcb.data.netstat.tot_recv
suffix:semicolon
id|adapter-&gt;stats.tx_packets
op_add_assign
id|adapter-&gt;irx_pcb.data.netstat.tot_xmit
suffix:semicolon
id|adapter-&gt;stats.rx_crc_errors
op_add_assign
id|adapter-&gt;irx_pcb.data.netstat.err_CRC
suffix:semicolon
id|adapter-&gt;stats.rx_frame_errors
op_add_assign
id|adapter-&gt;irx_pcb.data.netstat.err_align
suffix:semicolon
id|adapter-&gt;stats.rx_fifo_errors
op_add_assign
id|adapter-&gt;irx_pcb.data.netstat.err_ovrrun
suffix:semicolon
id|adapter-&gt;got
(braket
id|CMD_NETWORK_STATISTICS
)braket
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|elp_debug
op_ge
l_int|3
)paren
id|printk
c_func
(paren
l_string|&quot;%s: interrupt - statistics response received&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_break
suffix:semicolon
multiline_comment|/*&n;         * received a packet&n;         */
r_case
id|CMD_RECEIVE_PACKET_COMPLETE
suffix:colon
multiline_comment|/* if the device isn&squot;t open, don&squot;t pass packets up the stack */
r_if
c_cond
(paren
id|dev-&gt;start
op_eq
l_int|0
)paren
r_break
suffix:semicolon
id|len
op_assign
id|adapter-&gt;irx_pcb.data.rcv_resp.pkt_len
suffix:semicolon
id|dlen
op_assign
id|adapter-&gt;irx_pcb.data.rcv_resp.buf_len
suffix:semicolon
r_if
c_cond
(paren
id|adapter-&gt;irx_pcb.data.rcv_resp.timeout
op_ne
l_int|0
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%s: interrupt - packet not received correctly&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|elp_debug
op_ge
l_int|3
)paren
id|printk
c_func
(paren
l_string|&quot;%s: interrupt - packet received of length %i (%i)&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|len
comma
id|dlen
)paren
suffix:semicolon
id|receive_packet
c_func
(paren
id|dev
comma
id|adapter
comma
id|dlen
)paren
suffix:semicolon
r_if
c_cond
(paren
id|elp_debug
op_ge
l_int|3
)paren
id|printk
c_func
(paren
l_string|&quot;%s: packet received&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|dev-&gt;start
op_logical_and
op_logical_neg
id|start_receive
c_func
(paren
id|adapter
comma
op_amp
id|adapter-&gt;itx_pcb
)paren
)paren
r_if
c_cond
(paren
id|elp_debug
op_ge
l_int|2
)paren
id|printk
c_func
(paren
l_string|&quot;%s: interrupt - failed to send receive start PCB&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_if
c_cond
(paren
id|elp_debug
op_ge
l_int|3
)paren
id|printk
c_func
(paren
l_string|&quot;%s: receive procedure complete&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_break
suffix:semicolon
multiline_comment|/*&n;         * sent a packet&n;         */
r_case
id|CMD_TRANSMIT_PACKET_COMPLETE
suffix:colon
r_if
c_cond
(paren
id|elp_debug
op_ge
l_int|3
)paren
id|printk
c_func
(paren
l_string|&quot;%s: interrupt - packet sent&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;start
op_eq
l_int|0
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
id|adapter-&gt;irx_pcb.data.xmit_resp.c_stat
op_ne
l_int|0
)paren
r_if
c_cond
(paren
id|elp_debug
op_ge
l_int|2
)paren
id|printk
c_func
(paren
l_string|&quot;%s: interrupt - error sending packet %4.4x&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|adapter-&gt;irx_pcb.data.xmit_resp.c_stat
)paren
suffix:semicolon
id|dev-&gt;tbusy
op_assign
l_int|0
suffix:semicolon
macro_line|#if (ELP_KERNEL_TYPE &lt; 3)
id|mark_bh
c_func
(paren
id|INET_BH
)paren
suffix:semicolon
macro_line|#else
id|mark_bh
c_func
(paren
id|NET_BH
)paren
suffix:semicolon
macro_line|#endif
r_break
suffix:semicolon
multiline_comment|/*&n;         * some unknown PCB&n;         */
r_default
suffix:colon
id|printk
c_func
(paren
l_string|&quot;%s: unknown PCB received - %2.2x&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|adapter-&gt;irx_pcb.command
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
r_else
id|printk
c_func
(paren
l_string|&quot;%s: failed to read PCB on interrupt&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|jiffies
op_ge
id|timeout
)paren
id|TIMEOUT_MSG
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/*&n;   * indicate no longer in interrupt routine&n;   */
id|dev-&gt;interrupt
op_assign
l_int|0
suffix:semicolon
)brace
multiline_comment|/******************************************************&n; *&n; * open the board&n; *&n; ******************************************************/
DECL|function|elp_open
r_static
r_int
id|elp_open
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
id|elp_device
op_star
id|adapter
op_assign
(paren
id|elp_device
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|CHECK_NULL
c_func
(paren
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|elp_debug
op_ge
l_int|3
)paren
id|printk
c_func
(paren
l_string|&quot;%s: request to open device&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
multiline_comment|/*&n;   * make sure we actually found the device&n;   */
r_if
c_cond
(paren
id|adapter
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%s: Opening a non-existent physical device&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_return
op_minus
id|EAGAIN
suffix:semicolon
)brace
multiline_comment|/*&n;   * disable interrupts on the board&n;   */
id|OUTB
c_func
(paren
l_int|0x00
comma
id|adapter-&gt;io_addr
op_plus
id|PORT_CONTROL
)paren
suffix:semicolon
multiline_comment|/*&n;   * clear any pending interrupts&n;   */
id|INB
c_func
(paren
id|adapter-&gt;io_addr
op_plus
id|PORT_COMMAND
)paren
suffix:semicolon
multiline_comment|/*&n;   * interrupt routine not entered&n;   */
id|dev-&gt;interrupt
op_assign
l_int|0
suffix:semicolon
multiline_comment|/*&n;   *  transmitter not busy &n;   */
id|dev-&gt;tbusy
op_assign
l_int|0
suffix:semicolon
multiline_comment|/*&n;   * install our interrupt service routine&n;   */
r_if
c_cond
(paren
id|request_irq
c_func
(paren
id|dev-&gt;irq
comma
op_amp
id|elp_interrupt
comma
l_int|0
comma
l_string|&quot;3c505&quot;
)paren
)paren
r_return
op_minus
id|EAGAIN
suffix:semicolon
multiline_comment|/*&n;   * make sure we can find the device header given the interrupt number&n;   */
id|irq2dev_map
(braket
id|dev-&gt;irq
)braket
op_assign
id|dev
suffix:semicolon
multiline_comment|/*&n;   * enable interrupts on the board&n;   */
id|OUTB
c_func
(paren
id|CONTROL_CMDE
comma
id|adapter-&gt;io_addr
op_plus
id|PORT_CONTROL
)paren
suffix:semicolon
multiline_comment|/*&n;   * device is now officially open!&n;   */
id|dev-&gt;start
op_assign
l_int|1
suffix:semicolon
multiline_comment|/*&n;   * configure adapter memory: we need 10 multicast addresses, default==0&n;   */
r_if
c_cond
(paren
id|elp_debug
op_ge
l_int|3
)paren
id|printk
c_func
(paren
l_string|&quot;%s: sending 3c505 memory configuration command&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|adapter-&gt;tx_pcb.command
op_assign
id|CMD_CONFIGURE_ADAPTER_MEMORY
suffix:semicolon
id|adapter-&gt;tx_pcb.data.memconf.cmd_q
op_assign
l_int|10
suffix:semicolon
id|adapter-&gt;tx_pcb.data.memconf.rcv_q
op_assign
l_int|20
suffix:semicolon
id|adapter-&gt;tx_pcb.data.memconf.mcast
op_assign
l_int|10
suffix:semicolon
id|adapter-&gt;tx_pcb.data.memconf.frame
op_assign
l_int|20
suffix:semicolon
id|adapter-&gt;tx_pcb.data.memconf.rcv_b
op_assign
l_int|20
suffix:semicolon
id|adapter-&gt;tx_pcb.data.memconf.progs
op_assign
l_int|0
suffix:semicolon
id|adapter-&gt;tx_pcb.length
op_assign
r_sizeof
(paren
r_struct
id|Memconf
)paren
suffix:semicolon
id|adapter-&gt;got
(braket
id|CMD_CONFIGURE_ADAPTER_MEMORY
)braket
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|send_pcb
c_func
(paren
id|adapter
comma
op_amp
id|adapter-&gt;tx_pcb
)paren
)paren
id|printk
c_func
(paren
l_string|&quot;%s: couldn&squot;t send memory configuration command&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_else
(brace
r_int
id|timeout
op_assign
id|jiffies
op_plus
id|TIMEOUT
suffix:semicolon
r_while
c_loop
(paren
id|adapter-&gt;got
(braket
id|CMD_CONFIGURE_ADAPTER_MEMORY
)braket
op_eq
l_int|0
op_logical_and
id|jiffies
OL
id|timeout
)paren
suffix:semicolon
r_if
c_cond
(paren
id|jiffies
op_ge
id|timeout
)paren
id|TIMEOUT_MSG
c_func
(paren
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;   * configure adapter to receive broadcast messages and wait for response&n;   */
r_if
c_cond
(paren
id|elp_debug
op_ge
l_int|3
)paren
id|printk
c_func
(paren
l_string|&quot;%s: sending 82586 configure command&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|adapter-&gt;tx_pcb.command
op_assign
id|CMD_CONFIGURE_82586
suffix:semicolon
id|adapter-&gt;tx_pcb.data.configure
op_assign
id|NO_LOOPBACK
op_or
id|RECV_BROAD
suffix:semicolon
id|adapter-&gt;tx_pcb.length
op_assign
l_int|2
suffix:semicolon
id|adapter-&gt;got
(braket
id|CMD_CONFIGURE_82586
)braket
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|send_pcb
c_func
(paren
id|adapter
comma
op_amp
id|adapter-&gt;tx_pcb
)paren
)paren
id|printk
c_func
(paren
l_string|&quot;%s: couldn&squot;t send 82586 configure command&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_else
(brace
r_int
id|timeout
op_assign
id|jiffies
op_plus
id|TIMEOUT
suffix:semicolon
r_while
c_loop
(paren
id|adapter-&gt;got
(braket
id|CMD_CONFIGURE_82586
)braket
op_eq
l_int|0
op_logical_and
id|jiffies
OL
id|timeout
)paren
suffix:semicolon
r_if
c_cond
(paren
id|jiffies
op_ge
id|timeout
)paren
id|TIMEOUT_MSG
c_func
(paren
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;   * queue receive commands to provide buffering&n;   */
r_if
c_cond
(paren
op_logical_neg
id|start_receive
c_func
(paren
id|adapter
comma
op_amp
id|adapter-&gt;tx_pcb
)paren
)paren
id|printk
c_func
(paren
l_string|&quot;%s: start receive command failed &bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_if
c_cond
(paren
id|elp_debug
op_ge
l_int|3
)paren
id|printk
c_func
(paren
l_string|&quot;%s: start receive command sent&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
multiline_comment|/* Always succeed */
)brace
multiline_comment|/******************************************************&n; *&n; * send a packet to the adapter&n; *&n; ******************************************************/
DECL|function|send_packet
r_static
r_int
id|send_packet
(paren
id|elp_device
op_star
id|adapter
comma
r_int
r_char
op_star
id|ptr
comma
r_int
id|len
)paren
(brace
r_int
id|i
suffix:semicolon
multiline_comment|/*&n;   * make sure the length is even and no shorter than 60 bytes&n;   */
r_int
r_int
id|nlen
op_assign
(paren
(paren
(paren
id|len
OL
l_int|60
)paren
ques
c_cond
l_int|60
suffix:colon
id|len
)paren
op_plus
l_int|1
)paren
op_amp
(paren
op_complement
l_int|1
)paren
suffix:semicolon
id|CHECK_NULL
c_func
(paren
id|adapter
)paren
suffix:semicolon
id|CHECK_NULL
c_func
(paren
id|ptr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|nlen
OL
id|len
)paren
id|printk
c_func
(paren
l_string|&quot;Warning, bad length nlen=%d len=%d %s(%d)&bslash;n&quot;
comma
id|nlen
comma
id|len
comma
id|filename
comma
id|__LINE__
)paren
suffix:semicolon
multiline_comment|/*&n;   * send the adapter a transmit packet command. Ignore segment and offset&n;   * and make sure the length is even&n;   */
id|adapter-&gt;tx_pcb.command
op_assign
id|CMD_TRANSMIT_PACKET
suffix:semicolon
id|adapter-&gt;tx_pcb.length
op_assign
r_sizeof
(paren
r_struct
id|Xmit_pkt
)paren
suffix:semicolon
id|adapter-&gt;tx_pcb.data.xmit_pkt.buf_ofs
op_assign
id|adapter-&gt;tx_pcb.data.xmit_pkt.buf_seg
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Unused */
id|adapter-&gt;tx_pcb.data.xmit_pkt.pkt_len
op_assign
id|nlen
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|send_pcb
c_func
(paren
id|adapter
comma
op_amp
id|adapter-&gt;tx_pcb
)paren
)paren
r_return
id|FALSE
suffix:semicolon
multiline_comment|/*&n;   * make sure the data register is going the right way&n;   */
id|cli
c_func
(paren
)paren
suffix:semicolon
id|OUTB
c_func
(paren
id|INB
c_func
(paren
id|adapter-&gt;io_addr
op_plus
id|PORT_CONTROL
)paren
op_amp
(paren
op_complement
id|CONTROL_DIR
)paren
comma
id|adapter-&gt;io_addr
op_plus
id|PORT_CONTROL
)paren
suffix:semicolon
id|sti
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/*&n;   * write data to the adapter&n;   */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
(paren
id|nlen
op_div
l_int|2
)paren
suffix:semicolon
id|i
op_increment
)paren
(brace
r_int
id|timeout
op_assign
id|jiffies
op_plus
id|TIMEOUT
suffix:semicolon
r_while
c_loop
(paren
(paren
id|INB
c_func
(paren
id|adapter-&gt;io_addr
op_plus
id|PORT_STATUS
)paren
op_amp
id|STATUS_HRDY
)paren
op_eq
l_int|0
op_logical_and
id|jiffies
OL
id|timeout
)paren
suffix:semicolon
r_if
c_cond
(paren
id|jiffies
op_ge
id|timeout
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;*** timeout at %s(%d) writing word %d of %d ***&bslash;n&quot;
comma
id|filename
comma
id|__LINE__
comma
id|i
comma
id|nlen
op_div
l_int|2
)paren
suffix:semicolon
r_return
id|FALSE
suffix:semicolon
)brace
id|outw
c_func
(paren
op_star
(paren
r_int
op_star
)paren
id|ptr
comma
id|adapter-&gt;io_addr
op_plus
id|PORT_DATA
)paren
suffix:semicolon
id|ptr
op_add_assign
l_int|2
suffix:semicolon
)brace
r_return
id|TRUE
suffix:semicolon
)brace
multiline_comment|/******************************************************&n; *&n; * start the transmitter&n; *    return 0 if sent OK, else return 1&n; *&n; ******************************************************/
DECL|function|elp_start_xmit
r_static
r_int
id|elp_start_xmit
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|device
op_star
id|dev
)paren
(brace
id|elp_device
op_star
id|adapter
op_assign
(paren
id|elp_device
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|CHECK_NULL
c_func
(paren
id|dev
)paren
suffix:semicolon
multiline_comment|/*&n;   * not sure what this does, but the 3c509 driver does it, so...&n;   */
r_if
c_cond
(paren
id|skb
op_eq
l_int|NULL
)paren
(brace
id|dev_tint
c_func
(paren
id|dev
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n;   * Fill in the ethernet header &n;   * (for kernels prior to 1.1.4 only)&n;   */
macro_line|#if (ELP_KERNEL_TYPE &lt; 2)
id|IS_SKB
c_func
(paren
id|skb
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|skb-&gt;arp
op_logical_and
id|dev
op_member_access_from_pointer
id|rebuild_header
c_func
(paren
id|SKB_DATA
comma
id|dev
)paren
)paren
(brace
id|skb-&gt;dev
op_assign
id|dev
suffix:semicolon
id|IS_SKB
c_func
(paren
id|skb
)paren
suffix:semicolon
id|arp_queue
(paren
id|skb
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#endif
multiline_comment|/*&n;   * if we ended up with a munged length, don&squot;t send it&n;   */
r_if
c_cond
(paren
id|skb-&gt;len
op_le
l_int|0
)paren
r_return
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|elp_debug
op_ge
l_int|3
)paren
id|printk
c_func
(paren
l_string|&quot;%s: request to send packet of length %d&bslash;n&quot;
comma
id|dev-&gt;name
comma
(paren
r_int
)paren
id|skb-&gt;len
)paren
suffix:semicolon
multiline_comment|/*&n;   * if the transmitter is still busy, we have a transmit timeout...&n;   */
r_if
c_cond
(paren
id|dev-&gt;tbusy
)paren
(brace
r_int
id|tickssofar
op_assign
id|jiffies
op_minus
id|dev-&gt;trans_start
suffix:semicolon
r_if
c_cond
(paren
id|tickssofar
OL
l_int|200
)paren
multiline_comment|/* was 500, AJT */
r_return
l_int|1
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;%s: transmit timed out, resetting adapter&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|INB
c_func
(paren
id|adapter-&gt;io_addr
op_plus
id|PORT_STATUS
)paren
op_amp
id|STATUS_ACRF
)paren
op_ne
l_int|0
)paren
id|printk
c_func
(paren
l_string|&quot;%s: hmmm...seemed to have missed an interrupt!&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|adapter_reset
c_func
(paren
id|adapter
)paren
suffix:semicolon
id|dev-&gt;trans_start
op_assign
id|jiffies
suffix:semicolon
id|dev-&gt;tbusy
op_assign
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n;   * send the packet at skb-&gt;data for skb-&gt;len&n;   */
r_if
c_cond
(paren
op_logical_neg
id|send_packet
c_func
(paren
id|adapter
comma
(paren
r_int
r_char
op_star
)paren
id|SKB_DATA
comma
id|skb-&gt;len
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%s: send packet PCB failed&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|elp_debug
op_ge
l_int|3
)paren
id|printk
c_func
(paren
l_string|&quot;%s: packet of length %d sent&bslash;n&quot;
comma
id|dev-&gt;name
comma
(paren
r_int
)paren
id|skb-&gt;len
)paren
suffix:semicolon
multiline_comment|/*&n;   * start the transmit timeout&n;   */
id|dev-&gt;trans_start
op_assign
id|jiffies
suffix:semicolon
multiline_comment|/*&n;   * the transmitter is now busy&n;   */
id|dev-&gt;tbusy
op_assign
l_int|1
suffix:semicolon
multiline_comment|/*&n;   * if we have been asked to free the buffer, do so&n;   */
macro_line|#if (ELP_KERNEL_TYPE &lt; 4)
r_if
c_cond
(paren
id|skb-&gt;free
)paren
(brace
id|IS_SKB
c_func
(paren
id|skb
)paren
suffix:semicolon
id|kfree_skb
c_func
(paren
id|skb
comma
id|FREE_WRITE
)paren
suffix:semicolon
)brace
macro_line|#else
id|dev_kfree_skb
c_func
(paren
id|skb
comma
id|FREE_WRITE
)paren
suffix:semicolon
macro_line|#endif
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/******************************************************&n; *&n; * return statistics on the board&n; *&n; ******************************************************/
DECL|function|elp_get_stats
r_static
r_struct
id|enet_statistics
op_star
id|elp_get_stats
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
id|elp_device
op_star
id|adapter
op_assign
(paren
id|elp_device
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_if
c_cond
(paren
id|elp_debug
op_ge
l_int|3
)paren
id|printk
c_func
(paren
l_string|&quot;%s: request for stats&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
multiline_comment|/* If the device is closed, just return the latest stats we have,&n;     - we cannot ask from the adapter without interrupts */
r_if
c_cond
(paren
op_logical_neg
id|dev-&gt;start
)paren
r_return
op_amp
id|adapter-&gt;stats
suffix:semicolon
multiline_comment|/* send a get statistics command to the board */
id|adapter-&gt;tx_pcb.command
op_assign
id|CMD_NETWORK_STATISTICS
suffix:semicolon
id|adapter-&gt;tx_pcb.length
op_assign
l_int|0
suffix:semicolon
id|adapter-&gt;got
(braket
id|CMD_NETWORK_STATISTICS
)braket
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|send_pcb
c_func
(paren
id|adapter
comma
op_amp
id|adapter-&gt;tx_pcb
)paren
)paren
id|printk
c_func
(paren
l_string|&quot;%s: couldn&squot;t send get statistics command&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_else
(brace
r_int
id|timeout
op_assign
id|jiffies
op_plus
id|TIMEOUT
suffix:semicolon
r_while
c_loop
(paren
id|adapter-&gt;got
(braket
id|CMD_NETWORK_STATISTICS
)braket
op_eq
l_int|0
op_logical_and
id|jiffies
OL
id|timeout
)paren
suffix:semicolon
r_if
c_cond
(paren
id|jiffies
op_ge
id|timeout
)paren
(brace
id|TIMEOUT_MSG
c_func
(paren
)paren
suffix:semicolon
r_return
op_amp
id|adapter-&gt;stats
suffix:semicolon
)brace
)brace
multiline_comment|/* statistics are now up to date */
r_return
op_amp
id|adapter-&gt;stats
suffix:semicolon
)brace
multiline_comment|/******************************************************&n; *&n; * close the board&n; *&n; ******************************************************/
DECL|function|elp_close
r_static
r_int
id|elp_close
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
id|elp_device
op_star
id|adapter
op_assign
(paren
id|elp_device
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|CHECK_NULL
c_func
(paren
id|dev
)paren
suffix:semicolon
id|CHECK_NULL
c_func
(paren
id|adapter
)paren
suffix:semicolon
r_if
c_cond
(paren
id|elp_debug
op_ge
l_int|3
)paren
id|printk
c_func
(paren
l_string|&quot;%s: request to close device&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
multiline_comment|/* Someone may request the device statistic information even when&n;   * the interface is closed. The following will update the statistics&n;   * structure in the driver, so we&squot;ll be able to give current statistics.&n;   */
(paren
r_void
)paren
id|elp_get_stats
c_func
(paren
id|dev
)paren
suffix:semicolon
multiline_comment|/*&n;   * disable interrupts on the board&n;   */
id|OUTB
c_func
(paren
l_int|0x00
comma
id|adapter-&gt;io_addr
op_plus
id|PORT_CONTROL
)paren
suffix:semicolon
multiline_comment|/*&n;   *  flag transmitter as busy (i.e. not available)&n;   */
id|dev-&gt;tbusy
op_assign
l_int|1
suffix:semicolon
multiline_comment|/*&n;   *  indicate device is closed&n;   */
id|dev-&gt;start
op_assign
l_int|0
suffix:semicolon
multiline_comment|/*&n;   * release the IRQ&n;   */
id|free_irq
c_func
(paren
id|dev-&gt;irq
)paren
suffix:semicolon
multiline_comment|/*&n;   * and we no longer have to map irq to dev either&n;   */
id|irq2dev_map
(braket
id|dev-&gt;irq
)braket
op_assign
l_int|0
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/************************************************************&n; *&n; * Set multicast list&n; * num_addrs==0: clear mc_list&n; * num_addrs==-1: set promiscuous mode&n; * num_addrs&gt;0: set mc_list&n; *&n; ************************************************************/
DECL|function|elp_set_mc_list
r_static
r_void
id|elp_set_mc_list
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
r_int
id|num_addrs
comma
r_void
op_star
id|addrs
)paren
(brace
id|elp_device
op_star
id|adapter
op_assign
(paren
id|elp_device
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_int
id|i
suffix:semicolon
r_if
c_cond
(paren
id|elp_debug
op_ge
l_int|3
)paren
id|printk
c_func
(paren
l_string|&quot;%s: request to set multicast list&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_if
c_cond
(paren
id|num_addrs
op_ne
op_minus
l_int|1
)paren
(brace
multiline_comment|/* send a &quot;load multicast list&quot; command to the board, max 10 addrs/cmd */
multiline_comment|/* if num_addrs==0 the list will be cleared */
id|adapter-&gt;tx_pcb.command
op_assign
id|CMD_LOAD_MULTICAST_LIST
suffix:semicolon
id|adapter-&gt;tx_pcb.length
op_assign
l_int|6
op_star
id|num_addrs
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|num_addrs
suffix:semicolon
id|i
op_increment
)paren
id|memcpy
c_func
(paren
id|adapter-&gt;tx_pcb.data.multicast
(braket
id|i
)braket
comma
id|addrs
op_plus
l_int|6
op_star
id|i
comma
l_int|6
)paren
suffix:semicolon
id|adapter-&gt;got
(braket
id|CMD_LOAD_MULTICAST_LIST
)braket
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|send_pcb
c_func
(paren
id|adapter
comma
op_amp
id|adapter-&gt;tx_pcb
)paren
)paren
id|printk
c_func
(paren
l_string|&quot;%s: couldn&squot;t send set_multicast command&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_else
(brace
r_int
id|timeout
op_assign
id|jiffies
op_plus
id|TIMEOUT
suffix:semicolon
r_while
c_loop
(paren
id|adapter-&gt;got
(braket
id|CMD_LOAD_MULTICAST_LIST
)braket
op_eq
l_int|0
op_logical_and
id|jiffies
OL
id|timeout
)paren
suffix:semicolon
r_if
c_cond
(paren
id|jiffies
op_ge
id|timeout
)paren
(brace
id|TIMEOUT_MSG
c_func
(paren
)paren
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|num_addrs
)paren
id|adapter-&gt;tx_pcb.data.configure
op_assign
id|NO_LOOPBACK
op_or
id|RECV_BROAD
op_or
id|RECV_MULTI
suffix:semicolon
r_else
multiline_comment|/* num_addrs == 0 */
id|adapter-&gt;tx_pcb.data.configure
op_assign
id|NO_LOOPBACK
op_or
id|RECV_BROAD
suffix:semicolon
)brace
r_else
multiline_comment|/* num_addrs == -1 */
id|adapter-&gt;tx_pcb.data.configure
op_assign
id|NO_LOOPBACK
op_or
id|RECV_ALL
suffix:semicolon
multiline_comment|/*&n;   * configure adapter to receive messages (as specified above)&n;   * and wait for response&n;   */
r_if
c_cond
(paren
id|elp_debug
op_ge
l_int|3
)paren
id|printk
c_func
(paren
l_string|&quot;%s: sending 82586 configure command&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|adapter-&gt;tx_pcb.command
op_assign
id|CMD_CONFIGURE_82586
suffix:semicolon
id|adapter-&gt;tx_pcb.length
op_assign
l_int|2
suffix:semicolon
id|adapter-&gt;got
(braket
id|CMD_CONFIGURE_82586
)braket
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|send_pcb
c_func
(paren
id|adapter
comma
op_amp
id|adapter-&gt;tx_pcb
)paren
)paren
id|printk
c_func
(paren
l_string|&quot;%s: couldn&squot;t send 82586 configure command&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_else
(brace
r_int
id|timeout
op_assign
id|jiffies
op_plus
id|TIMEOUT
suffix:semicolon
r_while
c_loop
(paren
id|adapter-&gt;got
(braket
id|CMD_CONFIGURE_82586
)braket
op_eq
l_int|0
op_logical_and
id|jiffies
OL
id|timeout
)paren
suffix:semicolon
r_if
c_cond
(paren
id|jiffies
op_ge
id|timeout
)paren
id|TIMEOUT_MSG
c_func
(paren
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/******************************************************&n; *&n; * initialise Etherlink Plus board&n; *&n; ******************************************************/
DECL|function|elp_init
r_static
r_void
id|elp_init
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
id|elp_device
op_star
id|adapter
suffix:semicolon
id|CHECK_NULL
c_func
(paren
id|dev
)paren
suffix:semicolon
multiline_comment|/*&n;   * NULL out buffer pointers&n;   * (kernels prior to 1.1.4 only)&n;   */
macro_line|#if (ELP_KERNEL_TYPE &lt; 2)
(brace
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|DEV_NUMBUFFS
suffix:semicolon
id|i
op_increment
)paren
id|dev-&gt;buffs
(braket
id|i
)braket
op_assign
l_int|NULL
suffix:semicolon
)brace
macro_line|#endif
multiline_comment|/*&n;   * set ptrs to various functions&n;   */
id|dev-&gt;open
op_assign
id|elp_open
suffix:semicolon
multiline_comment|/* local */
id|dev-&gt;stop
op_assign
id|elp_close
suffix:semicolon
multiline_comment|/* local */
id|dev-&gt;get_stats
op_assign
id|elp_get_stats
suffix:semicolon
multiline_comment|/* local */
id|dev-&gt;hard_start_xmit
op_assign
id|elp_start_xmit
suffix:semicolon
multiline_comment|/* local */
id|dev-&gt;set_multicast_list
op_assign
id|elp_set_mc_list
suffix:semicolon
multiline_comment|/* local */
macro_line|#if (ELP_KERNEL_TYPE &lt; 2)
id|dev-&gt;hard_header
op_assign
id|eth_header
suffix:semicolon
multiline_comment|/* eth.c */
id|dev-&gt;add_arp
op_assign
id|eth_add_arp
suffix:semicolon
multiline_comment|/* eth.c */
id|dev-&gt;rebuild_header
op_assign
id|eth_rebuild_header
suffix:semicolon
multiline_comment|/* eth.c */
id|dev-&gt;type_trans
op_assign
id|eth_type_trans
suffix:semicolon
multiline_comment|/* eth.c */
id|dev-&gt;queue_xmit
op_assign
id|dev_queue_xmit
suffix:semicolon
multiline_comment|/* dev.c */
macro_line|#else
multiline_comment|/* Setup the generic properties */
id|ether_setup
c_func
(paren
id|dev
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/*&n;   * setup ptr to adapter specific information&n;   */
id|adapter
op_assign
(paren
id|elp_device
op_star
)paren
(paren
id|dev-&gt;priv
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
id|elp_device
)paren
comma
id|GFP_KERNEL
)paren
)paren
suffix:semicolon
id|CHECK_NULL
c_func
(paren
id|adapter
)paren
suffix:semicolon
id|adapter-&gt;io_addr
op_assign
id|dev-&gt;base_addr
suffix:semicolon
id|adapter-&gt;name
op_assign
id|dev-&gt;name
suffix:semicolon
id|memset
c_func
(paren
op_amp
(paren
id|adapter-&gt;stats
)paren
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|enet_statistics
)paren
)paren
suffix:semicolon
multiline_comment|/*&n;   * Ethernet information&n;   * (for kernels prior to 1.1.4 only)&n;   */
macro_line|#if (ELP_KERNEL_TYPE &lt; 2)
id|dev-&gt;type
op_assign
id|ARPHRD_ETHER
suffix:semicolon
id|dev-&gt;hard_header_len
op_assign
id|ETH_HLEN
suffix:semicolon
id|dev-&gt;mtu
op_assign
l_int|1500
suffix:semicolon
multiline_comment|/* eth_mtu */
id|dev-&gt;addr_len
op_assign
id|ETH_ALEN
suffix:semicolon
(brace
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|dev-&gt;addr_len
suffix:semicolon
id|i
op_increment
)paren
id|dev-&gt;broadcast
(braket
id|i
)braket
op_assign
l_int|0xff
suffix:semicolon
)brace
multiline_comment|/*&n;   * New-style flags. &n;   */
id|dev-&gt;flags
op_assign
id|IFF_BROADCAST
suffix:semicolon
id|dev-&gt;family
op_assign
id|AF_INET
suffix:semicolon
id|dev-&gt;pa_addr
op_assign
l_int|0
suffix:semicolon
id|dev-&gt;pa_brdaddr
op_assign
l_int|0
suffix:semicolon
id|dev-&gt;pa_mask
op_assign
l_int|0
suffix:semicolon
id|dev-&gt;pa_alen
op_assign
r_sizeof
(paren
r_int
r_int
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/*&n;   * memory information&n;   */
id|dev-&gt;mem_start
op_assign
id|dev-&gt;mem_end
op_assign
id|dev-&gt;rmem_end
op_assign
id|dev-&gt;mem_start
op_assign
l_int|0
suffix:semicolon
macro_line|#if ELP_NEED_HARD_RESET
id|adapter_hard_reset
c_func
(paren
id|adapter
)paren
suffix:semicolon
macro_line|#else
id|adapter_reset
c_func
(paren
id|adapter
)paren
suffix:semicolon
macro_line|#endif
)brace
multiline_comment|/************************************************************&n; *&n; * A couple of tests to see if there&squot;s 3C505 or not&n; * Called only by elp_autodetect&n; ************************************************************/
DECL|function|elp_sense
r_static
r_int
id|elp_sense
c_func
(paren
r_int
id|addr
)paren
(brace
r_int
id|timeout
suffix:semicolon
id|byte
id|orig_HCR
op_assign
id|INB
c_func
(paren
id|addr
op_plus
id|PORT_CONTROL
)paren
comma
id|orig_HSR
op_assign
id|INB
c_func
(paren
id|addr
op_plus
id|PORT_STATUS
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
(paren
id|orig_HCR
op_eq
l_int|0xff
)paren
op_logical_and
(paren
id|orig_HSR
op_eq
l_int|0xff
)paren
)paren
op_logical_or
(paren
(paren
id|orig_HCR
op_amp
id|CONTROL_DIR
)paren
op_ne
(paren
id|orig_HSR
op_amp
id|STATUS_DIR
)paren
)paren
)paren
r_return
l_int|1
suffix:semicolon
multiline_comment|/* It can&squot;t be 3c505 if HCR.DIR != HSR.DIR */
multiline_comment|/* Wait for a while; the adapter may still be booting up */
r_if
c_cond
(paren
id|elp_debug
OG
l_int|0
)paren
id|printk
c_func
(paren
id|stilllooking_msg
)paren
suffix:semicolon
r_for
c_loop
(paren
id|timeout
op_assign
id|jiffies
op_plus
(paren
l_int|100
op_star
l_int|15
)paren
suffix:semicolon
id|jiffies
op_le
id|timeout
suffix:semicolon
)paren
r_if
c_cond
(paren
(paren
id|INB
c_func
(paren
id|addr
op_plus
id|PORT_STATUS
)paren
op_amp
id|ASF_PCB_MASK
)paren
op_ne
id|ASF_PCB_END
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
id|orig_HCR
op_amp
id|CONTROL_DIR
)paren
(brace
multiline_comment|/* If HCR.DIR is up, we pull it down. HSR.DIR should follow. */
id|OUTB
c_func
(paren
id|orig_HCR
op_amp
op_complement
id|CONTROL_DIR
comma
id|addr
op_plus
id|PORT_CONTROL
)paren
suffix:semicolon
id|timeout
op_assign
id|jiffies
op_plus
l_int|30
suffix:semicolon
r_while
c_loop
(paren
id|jiffies
OL
id|timeout
)paren
suffix:semicolon
r_if
c_cond
(paren
id|INB
c_func
(paren
id|addr
op_plus
id|PORT_STATUS
)paren
op_amp
id|STATUS_DIR
)paren
(brace
id|OUTB
c_func
(paren
id|orig_HCR
comma
id|addr
op_plus
id|PORT_CONTROL
)paren
suffix:semicolon
r_return
l_int|2
suffix:semicolon
)brace
)brace
r_else
(brace
multiline_comment|/* If HCR.DIR is down, we pull it up. HSR.DIR should follow. */
id|OUTB
c_func
(paren
id|orig_HCR
op_or
id|CONTROL_DIR
comma
id|addr
op_plus
id|PORT_CONTROL
)paren
suffix:semicolon
id|timeout
op_assign
id|jiffies
op_plus
l_int|300
suffix:semicolon
r_while
c_loop
(paren
id|jiffies
OL
id|timeout
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|INB
c_func
(paren
id|addr
op_plus
id|PORT_STATUS
)paren
op_amp
id|STATUS_DIR
)paren
)paren
(brace
id|OUTB
c_func
(paren
id|orig_HCR
comma
id|addr
op_plus
id|PORT_CONTROL
)paren
suffix:semicolon
r_return
l_int|3
suffix:semicolon
)brace
)brace
r_return
l_int|0
suffix:semicolon
multiline_comment|/* It certainly looks like a 3c505. */
)brace
multiline_comment|/*************************************************************&n; *&n; * Search through addr_list[] and try to find a 3C505&n; * Called only by eplus_probe&n; *************************************************************/
DECL|function|elp_autodetect
r_static
r_int
id|elp_autodetect
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
r_int
id|idx
op_assign
l_int|0
comma
id|addr
suffix:semicolon
multiline_comment|/* if base address set, then only check that address&n;     otherwise, run through the table */
r_if
c_cond
(paren
(paren
id|addr
op_assign
id|dev-&gt;base_addr
)paren
)paren
(brace
multiline_comment|/* dev-&gt;base_addr == 0 ==&gt; plain autodetect */
r_if
c_cond
(paren
id|elp_debug
OG
l_int|0
)paren
id|printk
c_func
(paren
id|search_msg
comma
id|dev-&gt;name
comma
id|addr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|elp_sense
c_func
(paren
id|addr
)paren
op_eq
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|elp_debug
OG
l_int|0
)paren
id|printk
c_func
(paren
id|found_msg
)paren
suffix:semicolon
r_return
id|addr
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|elp_debug
OG
l_int|0
)paren
id|printk
c_func
(paren
id|notfound_msg
)paren
suffix:semicolon
)brace
r_else
r_while
c_loop
(paren
(paren
id|addr
op_assign
id|addr_list
(braket
id|idx
op_increment
)braket
)paren
)paren
(brace
r_if
c_cond
(paren
id|elp_debug
OG
l_int|0
)paren
id|printk
c_func
(paren
id|search_msg
comma
id|dev-&gt;name
comma
id|addr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|elp_sense
c_func
(paren
id|addr
)paren
op_eq
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|elp_debug
OG
l_int|0
)paren
id|printk
c_func
(paren
id|found_msg
)paren
suffix:semicolon
r_return
id|addr
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|elp_debug
OG
l_int|0
)paren
id|printk
c_func
(paren
id|notfound_msg
)paren
suffix:semicolon
)brace
multiline_comment|/* could not find an adapter */
r_if
c_cond
(paren
id|elp_debug
op_eq
l_int|0
)paren
id|printk
c_func
(paren
id|couldnot_msg
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
multiline_comment|/* Because of this, the layer above will return -ENODEV */
)brace
multiline_comment|/******************************************************&n; *&n; * probe for an Etherlink Plus board at the specified address&n; *&n; ******************************************************/
DECL|function|elplus_probe
r_int
id|elplus_probe
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
id|elp_device
id|adapter
suffix:semicolon
r_int
id|i
suffix:semicolon
id|CHECK_NULL
c_func
(paren
id|dev
)paren
suffix:semicolon
multiline_comment|/*&n;   *  setup adapter structure&n;   */
id|adapter.io_addr
op_assign
id|dev-&gt;base_addr
op_assign
id|elp_autodetect
c_func
(paren
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|adapter.io_addr
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
multiline_comment|/*&n;   *  As we enter here from bootup, the adapter should have IRQs enabled,&n;   *  but we can as well enable them anyway.&n;   */
id|OUTB
c_func
(paren
id|INB
c_func
(paren
id|dev-&gt;base_addr
op_plus
id|PORT_CONTROL
)paren
op_or
id|CONTROL_CMDE
comma
id|dev-&gt;base_addr
op_plus
id|PORT_CONTROL
)paren
suffix:semicolon
id|autoirq_setup
c_func
(paren
l_int|0
)paren
suffix:semicolon
multiline_comment|/*&n;   * use ethernet address command to probe for board in polled mode&n;   * (this also makes us the IRQ that we need for automatic detection)&n;   */
id|adapter.tx_pcb.command
op_assign
id|CMD_STATION_ADDRESS
suffix:semicolon
id|adapter.tx_pcb.length
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|send_pcb
(paren
op_amp
id|adapter
comma
op_amp
id|adapter.tx_pcb
)paren
op_logical_or
op_logical_neg
id|receive_pcb
c_func
(paren
op_amp
id|adapter
comma
op_amp
id|adapter.rx_pcb
)paren
op_logical_or
(paren
id|adapter.rx_pcb.command
op_ne
id|CMD_ADDRESS_RESPONSE
)paren
op_logical_or
(paren
id|adapter.rx_pcb.length
op_ne
l_int|6
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%s: not responding to first PCB&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
r_if
c_cond
(paren
id|dev-&gt;irq
)paren
(brace
multiline_comment|/* Is there a preset IRQ? */
r_if
c_cond
(paren
id|dev-&gt;irq
op_ne
id|autoirq_report
c_func
(paren
l_int|0
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%s: Detected IRQ doesn&squot;t match user-defined one.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
multiline_comment|/* if dev-&gt;irq == autoirq_report(0), all is well */
)brace
r_else
multiline_comment|/* No preset IRQ; just use what we can detect */
id|dev-&gt;irq
op_assign
id|autoirq_report
c_func
(paren
l_int|0
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|dev-&gt;irq
)paren
(brace
multiline_comment|/* Legal, sane? */
r_case
l_int|0
suffix:colon
id|printk
c_func
(paren
l_string|&quot;%s: No IRQ reported by autoirq_report().&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;%s: Check the jumpers of your 3c505 board.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
r_case
l_int|1
suffix:colon
r_case
l_int|6
suffix:colon
r_case
l_int|8
suffix:colon
r_case
l_int|13
suffix:colon
id|printk
c_func
(paren
l_string|&quot;%s: Impossible IRQ %d reported by autoirq_report().&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|dev-&gt;irq
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
multiline_comment|/*&n;   *  Now we have the IRQ number so we can disable the interrupts from&n;   *  the board until the board is opened.&n;   */
id|OUTB
c_func
(paren
id|INB
c_func
(paren
id|dev-&gt;base_addr
op_plus
id|PORT_CONTROL
)paren
op_amp
op_complement
id|CONTROL_CMDE
comma
id|dev-&gt;base_addr
op_plus
id|PORT_CONTROL
)paren
suffix:semicolon
multiline_comment|/*&n;   * copy ethernet address into structure&n;   */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|6
suffix:semicolon
id|i
op_increment
)paren
id|dev-&gt;dev_addr
(braket
id|i
)braket
op_assign
id|adapter.rx_pcb.data.eth_addr
(braket
id|i
)braket
suffix:semicolon
multiline_comment|/*&n;   * print remainder of startup message&n;   */
macro_line|#if (ELP_KERNEL_TYPE &lt; 2)
id|printk
c_func
(paren
l_string|&quot;%s: 3c505 card found at I/O 0x%x using IRQ%d has address %s&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|dev-&gt;base_addr
comma
id|dev-&gt;irq
comma
id|eth_print
c_func
(paren
id|dev-&gt;dev_addr
)paren
)paren
suffix:semicolon
macro_line|#else
id|printk
c_func
(paren
l_string|&quot;%s: 3c505 card found at I/O 0x%x using IRQ%d has address %02x:%02x:%02x:%02x:%02x:%02x&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|dev-&gt;base_addr
comma
id|dev-&gt;irq
comma
id|dev-&gt;dev_addr
(braket
l_int|0
)braket
comma
id|dev-&gt;dev_addr
(braket
l_int|1
)braket
comma
id|dev-&gt;dev_addr
(braket
l_int|2
)braket
comma
id|dev-&gt;dev_addr
(braket
l_int|3
)braket
comma
id|dev-&gt;dev_addr
(braket
l_int|4
)braket
comma
id|dev-&gt;dev_addr
(braket
l_int|5
)braket
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/*&n;   * initialise the device&n;   */
id|elp_init
c_func
(paren
id|dev
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
eof
