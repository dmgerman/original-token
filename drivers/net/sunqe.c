multiline_comment|/* sunqe.c: Sparc QuadEthernet 10baseT SBUS card driver.&n; *          Once again I am out to prove that every ethernet&n; *          controller out there can be most efficiently programmed&n; *          if you make it look like a LANCE.&n; *&n; * Copyright (C) 1996 David S. Miller (davem@caip.rutgers.edu)&n; */
DECL|variable|version
r_static
r_char
op_star
id|version
op_assign
l_string|&quot;sunqe.c:v1.1 8/Nov/96 David S. Miller (davem@caipfs.rutgers.edu)&bslash;n&quot;
suffix:semicolon
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/fcntl.h&gt;
macro_line|#include &lt;linux/interrupt.h&gt;
macro_line|#include &lt;linux/ptrace.h&gt;
macro_line|#include &lt;linux/ioport.h&gt;
macro_line|#include &lt;linux/in.h&gt;
macro_line|#include &lt;linux/malloc.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;asm/system.h&gt;
macro_line|#include &lt;asm/bitops.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/dma.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;asm/byteorder.h&gt;
macro_line|#include &lt;asm/idprom.h&gt;
macro_line|#include &lt;asm/sbus.h&gt;
macro_line|#include &lt;asm/openprom.h&gt;
macro_line|#include &lt;asm/oplib.h&gt;
macro_line|#include &lt;asm/auxio.h&gt;
macro_line|#include &lt;asm/system.h&gt;
macro_line|#include &lt;asm/pgtable.h&gt;
macro_line|#include &lt;linux/netdevice.h&gt;
macro_line|#include &lt;linux/etherdevice.h&gt;
macro_line|#include &lt;linux/skbuff.h&gt;
macro_line|#include &quot;sunqe.h&quot;
macro_line|#ifdef MODULE
DECL|variable|root_qec_dev
r_static
r_struct
id|sunqec
op_star
id|root_qec_dev
op_assign
l_int|NULL
suffix:semicolon
macro_line|#endif
DECL|macro|QEC_RESET_TRIES
mdefine_line|#define QEC_RESET_TRIES 200
DECL|function|qec_global_reset
r_static
r_inline
r_int
id|qec_global_reset
c_func
(paren
r_struct
id|qe_globreg
op_star
id|gregs
)paren
(brace
r_int
id|tries
op_assign
id|QEC_RESET_TRIES
suffix:semicolon
id|gregs-&gt;ctrl
op_assign
id|GLOB_CTRL_RESET
suffix:semicolon
r_while
c_loop
(paren
op_decrement
id|tries
)paren
(brace
r_if
c_cond
(paren
id|gregs-&gt;ctrl
op_amp
id|GLOB_CTRL_RESET
)paren
(brace
id|udelay
c_func
(paren
l_int|20
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|tries
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;QuadEther: AIEEE cannot reset the QEC!&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
DECL|macro|MACE_RESET_RETRIES
mdefine_line|#define MACE_RESET_RETRIES 200
DECL|macro|QE_RESET_RETRIES
mdefine_line|#define QE_RESET_RETRIES   200
DECL|function|qe_stop
r_static
r_inline
r_int
id|qe_stop
c_func
(paren
r_struct
id|sunqe
op_star
id|qep
)paren
(brace
r_struct
id|qe_creg
op_star
id|cregs
op_assign
id|qep-&gt;qcregs
suffix:semicolon
r_struct
id|qe_mregs
op_star
id|mregs
op_assign
id|qep-&gt;mregs
suffix:semicolon
r_int
id|tries
suffix:semicolon
multiline_comment|/* Reset the MACE, then the QEC channel. */
id|mregs-&gt;bconfig
op_assign
id|MREGS_BCONFIG_RESET
suffix:semicolon
id|tries
op_assign
id|MACE_RESET_RETRIES
suffix:semicolon
r_while
c_loop
(paren
op_decrement
id|tries
)paren
(brace
r_if
c_cond
(paren
id|mregs-&gt;bconfig
op_amp
id|MREGS_BCONFIG_RESET
)paren
(brace
id|udelay
c_func
(paren
l_int|20
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|tries
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;QuadEther: AIEEE cannot reset the MACE!&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|cregs-&gt;ctrl
op_assign
id|CREG_CTRL_RESET
suffix:semicolon
id|tries
op_assign
id|QE_RESET_RETRIES
suffix:semicolon
r_while
c_loop
(paren
op_decrement
id|tries
)paren
(brace
r_if
c_cond
(paren
id|cregs-&gt;ctrl
op_amp
id|CREG_CTRL_RESET
)paren
(brace
id|udelay
c_func
(paren
l_int|20
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|tries
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;QuadEther: Cannot reset QE channel!&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|qe_clean_rings
r_static
r_inline
r_void
id|qe_clean_rings
c_func
(paren
r_struct
id|sunqe
op_star
id|qep
)paren
(brace
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|RX_RING_SIZE
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|qep-&gt;rx_skbs
(braket
id|i
)braket
op_ne
l_int|NULL
)paren
(brace
id|dev_kfree_skb
c_func
(paren
id|qep-&gt;rx_skbs
(braket
id|i
)braket
comma
id|FREE_READ
)paren
suffix:semicolon
id|qep-&gt;rx_skbs
(braket
id|i
)braket
op_assign
l_int|NULL
suffix:semicolon
)brace
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|TX_RING_SIZE
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|qep-&gt;tx_skbs
(braket
id|i
)braket
op_ne
l_int|NULL
)paren
(brace
id|dev_kfree_skb
c_func
(paren
id|qep-&gt;tx_skbs
(braket
id|i
)braket
comma
id|FREE_WRITE
)paren
suffix:semicolon
id|qep-&gt;tx_skbs
(braket
id|i
)braket
op_assign
l_int|NULL
suffix:semicolon
)brace
)brace
)brace
DECL|function|qe_init_rings
r_static
r_void
id|qe_init_rings
c_func
(paren
r_struct
id|sunqe
op_star
id|qep
comma
r_int
id|from_irq
)paren
(brace
r_struct
id|qe_init_block
op_star
id|qb
op_assign
id|qep-&gt;qe_block
suffix:semicolon
r_struct
id|device
op_star
id|dev
op_assign
id|qep-&gt;dev
suffix:semicolon
r_int
id|i
comma
id|gfp_flags
op_assign
id|GFP_KERNEL
suffix:semicolon
r_if
c_cond
(paren
id|from_irq
op_logical_or
id|in_interrupt
c_func
(paren
)paren
)paren
(brace
id|gfp_flags
op_assign
id|GFP_ATOMIC
suffix:semicolon
)brace
id|qep-&gt;rx_new
op_assign
id|qep-&gt;rx_old
op_assign
id|qep-&gt;tx_new
op_assign
id|qep-&gt;tx_old
op_assign
l_int|0
suffix:semicolon
id|qe_clean_rings
c_func
(paren
id|qep
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|RX_RING_SIZE
suffix:semicolon
id|i
op_increment
)paren
(brace
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
id|skb
op_assign
id|qe_alloc_skb
c_func
(paren
id|RX_BUF_ALLOC_SIZE
comma
id|gfp_flags
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|skb
)paren
(brace
r_continue
suffix:semicolon
)brace
id|qep-&gt;rx_skbs
(braket
id|i
)braket
op_assign
id|skb
suffix:semicolon
id|skb-&gt;dev
op_assign
id|dev
suffix:semicolon
id|skb_put
c_func
(paren
id|skb
comma
id|ETH_FRAME_LEN
)paren
suffix:semicolon
id|skb_reserve
c_func
(paren
id|skb
comma
l_int|34
)paren
suffix:semicolon
multiline_comment|/* FIX FOR ULTRA */
id|qb-&gt;qe_rxd
(braket
id|i
)braket
dot
id|rx_addr
op_assign
(paren
r_int
r_int
)paren
id|skb-&gt;data
suffix:semicolon
id|qb-&gt;qe_rxd
(braket
id|i
)braket
dot
id|rx_flags
op_assign
(paren
id|RXD_OWN
op_or
(paren
(paren
id|RX_BUF_ALLOC_SIZE
op_minus
l_int|34
)paren
op_amp
id|RXD_LENGTH
)paren
)paren
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|TX_RING_SIZE
suffix:semicolon
id|i
op_increment
)paren
(brace
id|qb-&gt;qe_txd
(braket
id|i
)braket
dot
id|tx_flags
op_assign
id|qb-&gt;qe_txd
(braket
id|i
)braket
dot
id|tx_addr
op_assign
l_int|0
suffix:semicolon
)brace
)brace
DECL|function|sun4c_qe_init_rings
r_static
r_void
id|sun4c_qe_init_rings
c_func
(paren
r_struct
id|sunqe
op_star
id|qep
)paren
(brace
r_struct
id|qe_init_block
op_star
id|qb
op_assign
id|qep-&gt;qe_block
suffix:semicolon
r_struct
id|sunqe_buffers
op_star
id|qbufs
op_assign
id|qep-&gt;sun4c_buffers
suffix:semicolon
id|__u32
id|qbufs_dvma
op_assign
id|qep-&gt;s4c_buf_dvma
suffix:semicolon
r_int
id|i
suffix:semicolon
id|qep-&gt;rx_new
op_assign
id|qep-&gt;rx_old
op_assign
id|qep-&gt;tx_new
op_assign
id|qep-&gt;tx_old
op_assign
l_int|0
suffix:semicolon
id|memset
c_func
(paren
id|qbufs
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|sunqe_buffers
)paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|RX_RING_SIZE
suffix:semicolon
id|i
op_increment
)paren
(brace
id|qb-&gt;qe_rxd
(braket
id|i
)braket
dot
id|rx_flags
op_assign
id|qb-&gt;qe_rxd
(braket
id|i
)braket
dot
id|rx_addr
op_assign
l_int|0
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|SUN4C_RX_RING_SIZE
suffix:semicolon
id|i
op_increment
)paren
(brace
id|qb-&gt;qe_rxd
(braket
id|i
)braket
dot
id|rx_addr
op_assign
id|qbufs_dvma
op_plus
id|qebuf_offset
c_func
(paren
id|rx_buf
comma
id|i
)paren
suffix:semicolon
id|qb-&gt;qe_rxd
(braket
id|i
)braket
dot
id|rx_flags
op_assign
(paren
id|RXD_OWN
op_or
(paren
(paren
id|SUN4C_RX_BUFF_SIZE
)paren
op_amp
id|RXD_LENGTH
)paren
)paren
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|TX_RING_SIZE
suffix:semicolon
id|i
op_increment
)paren
(brace
id|qb-&gt;qe_txd
(braket
id|i
)braket
dot
id|tx_flags
op_assign
id|qb-&gt;qe_txd
(braket
id|i
)braket
dot
id|tx_addr
op_assign
l_int|0
suffix:semicolon
)brace
)brace
DECL|function|qe_init
r_static
r_int
id|qe_init
c_func
(paren
r_struct
id|sunqe
op_star
id|qep
comma
r_int
id|from_irq
)paren
(brace
r_struct
id|sunqec
op_star
id|qecp
op_assign
id|qep-&gt;parent
suffix:semicolon
r_struct
id|qe_creg
op_star
id|cregs
op_assign
id|qep-&gt;qcregs
suffix:semicolon
r_struct
id|qe_mregs
op_star
id|mregs
op_assign
id|qep-&gt;mregs
suffix:semicolon
r_struct
id|qe_globreg
op_star
id|gregs
op_assign
id|qecp-&gt;gregs
suffix:semicolon
r_int
r_char
op_star
id|e
op_assign
op_amp
id|qep-&gt;dev-&gt;dev_addr
(braket
l_int|0
)braket
suffix:semicolon
r_volatile
r_int
r_char
id|garbage
suffix:semicolon
r_int
id|i
suffix:semicolon
multiline_comment|/* Shut it up. */
r_if
c_cond
(paren
id|qe_stop
c_func
(paren
id|qep
)paren
)paren
(brace
r_return
op_minus
id|EAGAIN
suffix:semicolon
)brace
multiline_comment|/* Setup initial rx/tx init block pointers. */
id|cregs-&gt;rxds
op_assign
id|qep-&gt;qblock_dvma
op_plus
id|qib_offset
c_func
(paren
id|qe_rxd
comma
l_int|0
)paren
suffix:semicolon
id|cregs-&gt;txds
op_assign
id|qep-&gt;qblock_dvma
op_plus
id|qib_offset
c_func
(paren
id|qe_txd
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* Enable the various irq&squot;s. */
id|cregs-&gt;rimask
op_assign
l_int|0
suffix:semicolon
id|cregs-&gt;timask
op_assign
l_int|0
suffix:semicolon
id|cregs-&gt;qmask
op_assign
l_int|0
suffix:semicolon
id|cregs-&gt;mmask
op_assign
id|CREG_MMASK_RXCOLL
suffix:semicolon
multiline_comment|/* Setup the FIFO pointers into QEC local memory. */
id|cregs-&gt;rxwbufptr
op_assign
id|cregs-&gt;rxrbufptr
op_assign
id|qep-&gt;channel
op_star
id|gregs-&gt;msize
suffix:semicolon
id|cregs-&gt;txwbufptr
op_assign
id|cregs-&gt;txrbufptr
op_assign
id|cregs-&gt;rxrbufptr
op_plus
id|gregs-&gt;rsize
suffix:semicolon
multiline_comment|/* Clear the channel collision counter. */
id|cregs-&gt;ccnt
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* For 10baseT, inter frame space nor throttle seems to be necessary. */
id|cregs-&gt;pipg
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Now dork with the AMD MACE. */
id|mregs-&gt;txfcntl
op_assign
id|MREGS_TXFCNTL_AUTOPAD
suffix:semicolon
multiline_comment|/* Save us some tx work. */
id|mregs-&gt;rxfcntl
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* The QEC dma&squot;s the rx&squot;d packets from local memory out to main memory,&n;&t; * and therefore it interrupts when the packet reception is &quot;complete&quot;.&n;&t; * So don&squot;t listen for the MACE talking about it.&n;&t; */
id|mregs-&gt;imask
op_assign
(paren
id|MREGS_IMASK_COLL
op_or
id|MREGS_IMASK_RXIRQ
)paren
suffix:semicolon
id|mregs-&gt;bconfig
op_assign
(paren
id|MREGS_BCONFIG_BSWAP
op_or
id|MREGS_BCONFIG_64TS
)paren
suffix:semicolon
id|mregs-&gt;fconfig
op_assign
(paren
id|MREGS_FCONFIG_TXF16
op_or
id|MREGS_FCONFIG_RXF32
op_or
id|MREGS_FCONFIG_RFWU
op_or
id|MREGS_FCONFIG_TFWU
)paren
suffix:semicolon
multiline_comment|/* Only usable interface on QuadEther is twisted pair. */
id|mregs-&gt;plsconfig
op_assign
(paren
id|MREGS_PLSCONFIG_TP
)paren
suffix:semicolon
multiline_comment|/* Tell MACE we are changing the ether address. */
id|mregs-&gt;iaconfig
op_assign
(paren
id|MREGS_IACONFIG_ACHNGE
op_or
id|MREGS_IACONFIG_PARESET
)paren
suffix:semicolon
id|mregs-&gt;ethaddr
op_assign
id|e
(braket
l_int|0
)braket
suffix:semicolon
id|mregs-&gt;ethaddr
op_assign
id|e
(braket
l_int|1
)braket
suffix:semicolon
id|mregs-&gt;ethaddr
op_assign
id|e
(braket
l_int|2
)braket
suffix:semicolon
id|mregs-&gt;ethaddr
op_assign
id|e
(braket
l_int|3
)braket
suffix:semicolon
id|mregs-&gt;ethaddr
op_assign
id|e
(braket
l_int|4
)braket
suffix:semicolon
id|mregs-&gt;ethaddr
op_assign
id|e
(braket
l_int|5
)braket
suffix:semicolon
multiline_comment|/* Clear out the address filter. */
id|mregs-&gt;iaconfig
op_assign
(paren
id|MREGS_IACONFIG_ACHNGE
op_or
id|MREGS_IACONFIG_LARESET
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|8
suffix:semicolon
id|i
op_increment
)paren
(brace
id|mregs-&gt;filter
op_assign
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Address changes are now complete. */
id|mregs-&gt;iaconfig
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|sparc_cpu_model
op_eq
id|sun4c
)paren
(brace
id|sun4c_qe_init_rings
c_func
(paren
id|qep
)paren
suffix:semicolon
)brace
r_else
id|qe_init_rings
c_func
(paren
id|qep
comma
id|from_irq
)paren
suffix:semicolon
multiline_comment|/* Wait a little bit for the link to come up... */
r_if
c_cond
(paren
op_logical_neg
(paren
id|mregs-&gt;phyconfig
op_amp
id|MREGS_PHYCONFIG_LTESTDIS
)paren
)paren
(brace
id|udelay
c_func
(paren
l_int|5000
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|mregs-&gt;phyconfig
op_amp
id|MREGS_PHYCONFIG_LSTAT
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%s: Warning, link state is down.&bslash;n&quot;
comma
id|qep-&gt;dev-&gt;name
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* Missed packet counter is cleared on a read. */
id|garbage
op_assign
id|mregs-&gt;mpcnt
suffix:semicolon
multiline_comment|/* Turn on the MACE receiver and transmitter. */
id|mregs-&gt;mconfig
op_assign
(paren
id|MREGS_MCONFIG_TXENAB
op_or
id|MREGS_MCONFIG_RXENAB
)paren
suffix:semicolon
multiline_comment|/* QEC should now start to show interrupts. */
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Grrr, certain error conditions completely lock up the AMD MACE,&n; * so when we get these we _must_ reset the chip.&n; */
DECL|function|qe_is_bolixed
r_static
r_int
id|qe_is_bolixed
c_func
(paren
r_struct
id|sunqe
op_star
id|qep
comma
r_int
r_int
id|qe_status
)paren
(brace
r_struct
id|device
op_star
id|dev
op_assign
id|qep-&gt;dev
suffix:semicolon
r_int
id|mace_hwbug_workaround
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|qe_status
op_amp
id|CREG_STAT_EDEFER
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%s: Excessive transmit defers.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|qep-&gt;net_stats.tx_errors
op_increment
suffix:semicolon
)brace
r_if
c_cond
(paren
id|qe_status
op_amp
id|CREG_STAT_CLOSS
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%s: Carrier lost, link down?&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|qep-&gt;net_stats.tx_errors
op_increment
suffix:semicolon
id|qep-&gt;net_stats.tx_carrier_errors
op_increment
suffix:semicolon
)brace
r_if
c_cond
(paren
id|qe_status
op_amp
id|CREG_STAT_ERETRIES
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%s: Excessive transmit retries (more than 16).&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|qep-&gt;net_stats.tx_errors
op_increment
suffix:semicolon
id|mace_hwbug_workaround
op_assign
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|qe_status
op_amp
id|CREG_STAT_LCOLL
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%s: Late transmit collision.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|qep-&gt;net_stats.tx_errors
op_increment
suffix:semicolon
id|qep-&gt;net_stats.collisions
op_increment
suffix:semicolon
id|mace_hwbug_workaround
op_assign
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|qe_status
op_amp
id|CREG_STAT_FUFLOW
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%s: Transmit fifo underflow, driver bug.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|qep-&gt;net_stats.tx_errors
op_increment
suffix:semicolon
id|mace_hwbug_workaround
op_assign
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|qe_status
op_amp
id|CREG_STAT_JERROR
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%s: Jabber error.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|qe_status
op_amp
id|CREG_STAT_BERROR
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%s: Babble error.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|qe_status
op_amp
id|CREG_STAT_CCOFLOW
)paren
(brace
id|qep-&gt;net_stats.tx_errors
op_add_assign
l_int|256
suffix:semicolon
id|qep-&gt;net_stats.collisions
op_add_assign
l_int|256
suffix:semicolon
)brace
r_if
c_cond
(paren
id|qe_status
op_amp
id|CREG_STAT_TXDERROR
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%s: Transmit descriptor is bogus, driver bug.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|qep-&gt;net_stats.tx_errors
op_increment
suffix:semicolon
id|qep-&gt;net_stats.tx_aborted_errors
op_increment
suffix:semicolon
id|mace_hwbug_workaround
op_assign
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|qe_status
op_amp
id|CREG_STAT_TXLERR
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%s: Transmit late error.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|qep-&gt;net_stats.tx_errors
op_increment
suffix:semicolon
id|mace_hwbug_workaround
op_assign
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|qe_status
op_amp
id|CREG_STAT_TXPERR
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%s: Transmit DMA parity error.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|qep-&gt;net_stats.tx_errors
op_increment
suffix:semicolon
id|qep-&gt;net_stats.tx_aborted_errors
op_increment
suffix:semicolon
id|mace_hwbug_workaround
op_assign
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|qe_status
op_amp
id|CREG_STAT_TXSERR
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%s: Transmit DMA sbus error ack.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|qep-&gt;net_stats.tx_errors
op_increment
suffix:semicolon
id|qep-&gt;net_stats.tx_aborted_errors
op_increment
suffix:semicolon
id|mace_hwbug_workaround
op_assign
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|qe_status
op_amp
id|CREG_STAT_RCCOFLOW
)paren
(brace
id|qep-&gt;net_stats.rx_errors
op_add_assign
l_int|256
suffix:semicolon
id|qep-&gt;net_stats.collisions
op_add_assign
l_int|256
suffix:semicolon
)brace
r_if
c_cond
(paren
id|qe_status
op_amp
id|CREG_STAT_RUOFLOW
)paren
(brace
id|qep-&gt;net_stats.rx_errors
op_add_assign
l_int|256
suffix:semicolon
id|qep-&gt;net_stats.rx_over_errors
op_add_assign
l_int|256
suffix:semicolon
)brace
r_if
c_cond
(paren
id|qe_status
op_amp
id|CREG_STAT_MCOFLOW
)paren
(brace
id|qep-&gt;net_stats.rx_errors
op_add_assign
l_int|256
suffix:semicolon
id|qep-&gt;net_stats.rx_missed_errors
op_add_assign
l_int|256
suffix:semicolon
)brace
r_if
c_cond
(paren
id|qe_status
op_amp
id|CREG_STAT_RXFOFLOW
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%s: Receive fifo overflow.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|qep-&gt;net_stats.rx_errors
op_increment
suffix:semicolon
id|qep-&gt;net_stats.rx_over_errors
op_increment
suffix:semicolon
)brace
r_if
c_cond
(paren
id|qe_status
op_amp
id|CREG_STAT_RLCOLL
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%s: Late receive collision.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|qep-&gt;net_stats.rx_errors
op_increment
suffix:semicolon
id|qep-&gt;net_stats.collisions
op_increment
suffix:semicolon
)brace
r_if
c_cond
(paren
id|qe_status
op_amp
id|CREG_STAT_FCOFLOW
)paren
(brace
id|qep-&gt;net_stats.rx_errors
op_add_assign
l_int|256
suffix:semicolon
id|qep-&gt;net_stats.rx_frame_errors
op_add_assign
l_int|256
suffix:semicolon
)brace
r_if
c_cond
(paren
id|qe_status
op_amp
id|CREG_STAT_CECOFLOW
)paren
(brace
id|qep-&gt;net_stats.rx_errors
op_add_assign
l_int|256
suffix:semicolon
id|qep-&gt;net_stats.rx_crc_errors
op_add_assign
l_int|256
suffix:semicolon
)brace
r_if
c_cond
(paren
id|qe_status
op_amp
id|CREG_STAT_RXDROP
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%s: Receive packet dropped.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|qep-&gt;net_stats.rx_errors
op_increment
suffix:semicolon
id|qep-&gt;net_stats.rx_dropped
op_increment
suffix:semicolon
id|qep-&gt;net_stats.rx_missed_errors
op_increment
suffix:semicolon
)brace
r_if
c_cond
(paren
id|qe_status
op_amp
id|CREG_STAT_RXSMALL
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%s: Receive buffer too small, driver bug.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|qep-&gt;net_stats.rx_errors
op_increment
suffix:semicolon
id|qep-&gt;net_stats.rx_length_errors
op_increment
suffix:semicolon
)brace
r_if
c_cond
(paren
id|qe_status
op_amp
id|CREG_STAT_RXLERR
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%s: Receive late error.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|qep-&gt;net_stats.rx_errors
op_increment
suffix:semicolon
id|mace_hwbug_workaround
op_assign
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|qe_status
op_amp
id|CREG_STAT_RXPERR
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%s: Receive DMA parity error.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|qep-&gt;net_stats.rx_errors
op_increment
suffix:semicolon
id|qep-&gt;net_stats.rx_missed_errors
op_increment
suffix:semicolon
id|mace_hwbug_workaround
op_assign
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|qe_status
op_amp
id|CREG_STAT_RXSERR
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%s: Receive DMA sbus error ack.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|qep-&gt;net_stats.rx_errors
op_increment
suffix:semicolon
id|qep-&gt;net_stats.rx_missed_errors
op_increment
suffix:semicolon
id|mace_hwbug_workaround
op_assign
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|mace_hwbug_workaround
)paren
(brace
id|qe_init
c_func
(paren
id|qep
comma
l_int|1
)paren
suffix:semicolon
)brace
r_return
id|mace_hwbug_workaround
suffix:semicolon
)brace
multiline_comment|/* Per-QE transmit complete interrupt service routine. */
DECL|function|qe_tx
r_static
r_inline
r_void
id|qe_tx
c_func
(paren
r_struct
id|sunqe
op_star
id|qep
)paren
(brace
r_struct
id|qe_txd
op_star
id|txbase
op_assign
op_amp
id|qep-&gt;qe_block-&gt;qe_txd
(braket
l_int|0
)braket
suffix:semicolon
r_struct
id|qe_txd
op_star
id|this
suffix:semicolon
r_int
id|elem
op_assign
id|qep-&gt;tx_old
suffix:semicolon
r_while
c_loop
(paren
id|elem
op_ne
id|qep-&gt;tx_new
)paren
(brace
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
id|this
op_assign
op_amp
id|txbase
(braket
id|elem
)braket
suffix:semicolon
r_if
c_cond
(paren
id|this-&gt;tx_flags
op_amp
id|TXD_OWN
)paren
(brace
r_break
suffix:semicolon
)brace
id|skb
op_assign
id|qep-&gt;tx_skbs
(braket
id|elem
)braket
suffix:semicolon
id|qep-&gt;tx_skbs
(braket
id|elem
)braket
op_assign
l_int|NULL
suffix:semicolon
id|qep-&gt;net_stats.tx_bytes
op_add_assign
id|skb-&gt;len
suffix:semicolon
id|dev_kfree_skb
c_func
(paren
id|skb
comma
id|FREE_WRITE
)paren
suffix:semicolon
id|qep-&gt;net_stats.tx_packets
op_increment
suffix:semicolon
id|elem
op_assign
id|NEXT_TX
c_func
(paren
id|elem
)paren
suffix:semicolon
)brace
id|qep-&gt;tx_old
op_assign
id|elem
suffix:semicolon
)brace
DECL|function|sun4c_qe_tx
r_static
r_inline
r_void
id|sun4c_qe_tx
c_func
(paren
r_struct
id|sunqe
op_star
id|qep
)paren
(brace
r_struct
id|qe_txd
op_star
id|txbase
op_assign
op_amp
id|qep-&gt;qe_block-&gt;qe_txd
(braket
l_int|0
)braket
suffix:semicolon
r_struct
id|qe_txd
op_star
id|this
suffix:semicolon
r_int
id|elem
op_assign
id|qep-&gt;tx_old
suffix:semicolon
r_while
c_loop
(paren
id|elem
op_ne
id|qep-&gt;tx_new
)paren
(brace
id|this
op_assign
op_amp
id|txbase
(braket
id|elem
)braket
suffix:semicolon
r_if
c_cond
(paren
id|this-&gt;tx_flags
op_amp
id|TXD_OWN
)paren
(brace
r_break
suffix:semicolon
)brace
id|qep-&gt;net_stats.tx_packets
op_increment
suffix:semicolon
id|elem
op_assign
id|NEXT_TX
c_func
(paren
id|elem
)paren
suffix:semicolon
)brace
id|qep-&gt;tx_old
op_assign
id|elem
suffix:semicolon
)brace
multiline_comment|/* Per-QE receive interrupt service routine.  Just like on the happy meal&n; * we receive directly into skb&squot;s with a small packet copy water mark.&n; */
DECL|function|qe_rx
r_static
r_inline
r_void
id|qe_rx
c_func
(paren
r_struct
id|sunqe
op_star
id|qep
)paren
(brace
r_struct
id|qe_rxd
op_star
id|rxbase
op_assign
op_amp
id|qep-&gt;qe_block-&gt;qe_rxd
(braket
l_int|0
)braket
suffix:semicolon
r_struct
id|qe_rxd
op_star
id|this
suffix:semicolon
r_int
id|elem
op_assign
id|qep-&gt;rx_new
comma
id|drops
op_assign
l_int|0
suffix:semicolon
id|this
op_assign
op_amp
id|rxbase
(braket
id|elem
)braket
suffix:semicolon
r_while
c_loop
(paren
op_logical_neg
(paren
id|this-&gt;rx_flags
op_amp
id|RXD_OWN
)paren
)paren
(brace
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
r_int
r_int
id|flags
op_assign
id|this-&gt;rx_flags
suffix:semicolon
r_int
id|len
op_assign
(paren
id|flags
op_amp
id|RXD_LENGTH
)paren
op_minus
l_int|4
suffix:semicolon
multiline_comment|/* QE adds ether FCS size to len */
multiline_comment|/* Check for errors. */
r_if
c_cond
(paren
id|len
OL
id|ETH_ZLEN
)paren
(brace
id|qep-&gt;net_stats.rx_errors
op_increment
suffix:semicolon
id|qep-&gt;net_stats.rx_length_errors
op_increment
suffix:semicolon
id|drop_it
suffix:colon
multiline_comment|/* Return it to the QE. */
id|qep-&gt;net_stats.rx_dropped
op_increment
suffix:semicolon
id|this-&gt;rx_addr
op_assign
(paren
r_int
r_int
)paren
id|qep-&gt;rx_skbs
(braket
id|elem
)braket
op_member_access_from_pointer
id|data
suffix:semicolon
id|this-&gt;rx_flags
op_assign
(paren
id|RXD_OWN
op_or
(paren
id|RX_BUF_ALLOC_SIZE
op_amp
id|RXD_LENGTH
)paren
)paren
suffix:semicolon
r_goto
id|next
suffix:semicolon
)brace
id|skb
op_assign
id|qep-&gt;rx_skbs
(braket
id|elem
)braket
suffix:semicolon
r_if
c_cond
(paren
id|len
OG
id|RX_COPY_THRESHOLD
)paren
(brace
r_struct
id|sk_buff
op_star
id|new_skb
suffix:semicolon
multiline_comment|/* Now refill the entry, if we can. */
id|new_skb
op_assign
id|qe_alloc_skb
c_func
(paren
id|RX_BUF_ALLOC_SIZE
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|new_skb
)paren
(brace
id|drops
op_increment
suffix:semicolon
r_goto
id|drop_it
suffix:semicolon
)brace
id|qep-&gt;rx_skbs
(braket
id|elem
)braket
op_assign
id|new_skb
suffix:semicolon
id|new_skb-&gt;dev
op_assign
id|qep-&gt;dev
suffix:semicolon
id|skb_put
c_func
(paren
id|new_skb
comma
id|ETH_FRAME_LEN
)paren
suffix:semicolon
id|skb_reserve
c_func
(paren
id|new_skb
comma
l_int|34
)paren
suffix:semicolon
multiline_comment|/* FIX FOR ULTRA */
id|rxbase
(braket
id|elem
)braket
dot
id|rx_addr
op_assign
(paren
r_int
r_int
)paren
id|new_skb-&gt;data
suffix:semicolon
id|rxbase
(braket
id|elem
)braket
dot
id|rx_flags
op_assign
(paren
id|RXD_OWN
op_or
(paren
(paren
id|RX_BUF_ALLOC_SIZE
op_minus
l_int|34
)paren
op_amp
id|RXD_LENGTH
)paren
)paren
suffix:semicolon
multiline_comment|/* Trim the original skb for the netif. */
id|skb_trim
c_func
(paren
id|skb
comma
id|len
)paren
suffix:semicolon
)brace
r_else
(brace
r_struct
id|sk_buff
op_star
id|copy_skb
op_assign
id|dev_alloc_skb
c_func
(paren
id|len
op_plus
l_int|2
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|copy_skb
)paren
(brace
id|drops
op_increment
suffix:semicolon
r_goto
id|drop_it
suffix:semicolon
)brace
id|copy_skb-&gt;dev
op_assign
id|qep-&gt;dev
suffix:semicolon
id|skb_reserve
c_func
(paren
id|copy_skb
comma
l_int|2
)paren
suffix:semicolon
id|skb_put
c_func
(paren
id|copy_skb
comma
id|len
)paren
suffix:semicolon
id|eth_copy_and_sum
c_func
(paren
id|copy_skb
comma
(paren
r_int
r_char
op_star
)paren
id|skb-&gt;data
comma
id|len
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* Reuse original ring buffer. */
id|rxbase
(braket
id|elem
)braket
dot
id|rx_addr
op_assign
(paren
r_int
r_int
)paren
id|skb-&gt;data
suffix:semicolon
id|rxbase
(braket
id|elem
)braket
dot
id|rx_flags
op_assign
(paren
id|RXD_OWN
op_or
(paren
(paren
id|RX_BUF_ALLOC_SIZE
op_minus
l_int|34
)paren
op_amp
id|RXD_LENGTH
)paren
)paren
suffix:semicolon
id|skb
op_assign
id|copy_skb
suffix:semicolon
)brace
multiline_comment|/* No checksums are done by this card ;-( */
id|skb-&gt;protocol
op_assign
id|eth_type_trans
c_func
(paren
id|skb
comma
id|qep-&gt;dev
)paren
suffix:semicolon
id|netif_rx
c_func
(paren
id|skb
)paren
suffix:semicolon
id|qep-&gt;net_stats.rx_packets
op_increment
suffix:semicolon
id|next
suffix:colon
id|elem
op_assign
id|NEXT_RX
c_func
(paren
id|elem
)paren
suffix:semicolon
id|this
op_assign
op_amp
id|rxbase
(braket
id|elem
)braket
suffix:semicolon
)brace
id|qep-&gt;rx_new
op_assign
id|elem
suffix:semicolon
r_if
c_cond
(paren
id|drops
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%s: Memory squeeze, deferring packet.&bslash;n&quot;
comma
id|qep-&gt;dev-&gt;name
)paren
suffix:semicolon
)brace
)brace
DECL|function|sun4c_qe_rx
r_static
r_inline
r_void
id|sun4c_qe_rx
c_func
(paren
r_struct
id|sunqe
op_star
id|qep
)paren
(brace
r_struct
id|qe_rxd
op_star
id|rxbase
op_assign
op_amp
id|qep-&gt;qe_block-&gt;qe_rxd
(braket
l_int|0
)braket
suffix:semicolon
r_struct
id|qe_rxd
op_star
id|this
suffix:semicolon
r_struct
id|sunqe_buffers
op_star
id|qbufs
op_assign
id|qep-&gt;sun4c_buffers
suffix:semicolon
id|__u32
id|qbufs_dvma
op_assign
id|qep-&gt;s4c_buf_dvma
suffix:semicolon
r_int
id|elem
op_assign
id|qep-&gt;rx_new
comma
id|drops
op_assign
l_int|0
suffix:semicolon
id|this
op_assign
op_amp
id|rxbase
(braket
id|elem
)braket
suffix:semicolon
r_while
c_loop
(paren
op_logical_neg
(paren
id|this-&gt;rx_flags
op_amp
id|RXD_OWN
)paren
)paren
(brace
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
r_int
r_char
op_star
id|this_qbuf
op_assign
id|qbufs-&gt;rx_buf
(braket
id|elem
op_amp
(paren
id|SUN4C_RX_RING_SIZE
op_minus
l_int|1
)paren
)braket
suffix:semicolon
id|__u32
id|this_qbuf_dvma
op_assign
id|qbufs_dvma
op_plus
id|qebuf_offset
c_func
(paren
id|rx_buf
comma
(paren
id|elem
op_amp
(paren
id|SUN4C_RX_RING_SIZE
op_minus
l_int|1
)paren
)paren
)paren
suffix:semicolon
r_struct
id|qe_rxd
op_star
id|end_rxd
op_assign
op_amp
id|rxbase
(braket
(paren
id|elem
op_plus
id|SUN4C_RX_RING_SIZE
)paren
op_amp
(paren
id|RX_RING_SIZE
op_minus
l_int|1
)paren
)braket
suffix:semicolon
r_int
r_int
id|flags
op_assign
id|this-&gt;rx_flags
suffix:semicolon
r_int
id|len
op_assign
(paren
id|flags
op_amp
id|RXD_LENGTH
)paren
op_minus
l_int|4
suffix:semicolon
multiline_comment|/* QE adds ether FCS size to len */
multiline_comment|/* Check for errors. */
r_if
c_cond
(paren
id|len
OL
id|ETH_ZLEN
)paren
(brace
id|qep-&gt;net_stats.rx_errors
op_increment
suffix:semicolon
id|qep-&gt;net_stats.rx_length_errors
op_increment
suffix:semicolon
id|qep-&gt;net_stats.rx_dropped
op_increment
suffix:semicolon
)brace
r_else
(brace
id|skb
op_assign
id|dev_alloc_skb
c_func
(paren
id|len
op_plus
l_int|2
)paren
suffix:semicolon
r_if
c_cond
(paren
id|skb
op_eq
l_int|0
)paren
(brace
id|drops
op_increment
suffix:semicolon
id|qep-&gt;net_stats.rx_dropped
op_increment
suffix:semicolon
)brace
r_else
(brace
id|skb-&gt;dev
op_assign
id|qep-&gt;dev
suffix:semicolon
id|skb_reserve
c_func
(paren
id|skb
comma
l_int|2
)paren
suffix:semicolon
id|skb_put
c_func
(paren
id|skb
comma
id|len
)paren
suffix:semicolon
id|eth_copy_and_sum
c_func
(paren
id|skb
comma
(paren
r_int
r_char
op_star
)paren
id|this_qbuf
comma
id|len
comma
l_int|0
)paren
suffix:semicolon
id|skb-&gt;protocol
op_assign
id|eth_type_trans
c_func
(paren
id|skb
comma
id|qep-&gt;dev
)paren
suffix:semicolon
id|netif_rx
c_func
(paren
id|skb
)paren
suffix:semicolon
id|qep-&gt;net_stats.rx_packets
op_increment
suffix:semicolon
)brace
)brace
id|end_rxd-&gt;rx_addr
op_assign
id|this_qbuf_dvma
suffix:semicolon
id|end_rxd-&gt;rx_flags
op_assign
(paren
id|RXD_OWN
op_or
(paren
id|SUN4C_RX_BUFF_SIZE
op_amp
id|RXD_LENGTH
)paren
)paren
suffix:semicolon
id|elem
op_assign
id|NEXT_RX
c_func
(paren
id|elem
)paren
suffix:semicolon
id|this
op_assign
op_amp
id|rxbase
(braket
id|elem
)braket
suffix:semicolon
)brace
id|qep-&gt;rx_new
op_assign
id|elem
suffix:semicolon
r_if
c_cond
(paren
id|drops
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%s: Memory squeeze, deferring packet.&bslash;n&quot;
comma
id|qep-&gt;dev-&gt;name
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* Interrupts for all QE&squot;s get filtered out via the QEC master controller,&n; * so we just run through each qe and check to see who is signaling&n; * and thus needs to be serviced.&n; */
DECL|function|qec_interrupt
r_static
r_void
id|qec_interrupt
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_struct
id|sunqec
op_star
id|qecp
op_assign
(paren
r_struct
id|sunqec
op_star
)paren
id|dev_id
suffix:semicolon
r_int
r_int
id|qec_status
suffix:semicolon
r_int
id|channel
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Latch the status now. */
id|qec_status
op_assign
id|qecp-&gt;gregs-&gt;stat
suffix:semicolon
r_while
c_loop
(paren
id|channel
OL
l_int|4
)paren
(brace
r_if
c_cond
(paren
id|qec_status
op_amp
l_int|0xf
)paren
(brace
r_struct
id|sunqe
op_star
id|qep
op_assign
id|qecp-&gt;qes
(braket
id|channel
)braket
suffix:semicolon
r_struct
id|device
op_star
id|dev
op_assign
id|qep-&gt;dev
suffix:semicolon
r_int
r_int
id|qe_status
suffix:semicolon
id|dev-&gt;interrupt
op_assign
l_int|1
suffix:semicolon
id|qe_status
op_assign
id|qep-&gt;qcregs-&gt;stat
suffix:semicolon
r_if
c_cond
(paren
id|qe_status
op_amp
id|CREG_STAT_ERRORS
)paren
r_if
c_cond
(paren
id|qe_is_bolixed
c_func
(paren
id|qep
comma
id|qe_status
)paren
)paren
(brace
r_goto
id|next
suffix:semicolon
)brace
r_if
c_cond
(paren
id|qe_status
op_amp
id|CREG_STAT_RXIRQ
)paren
(brace
id|qe_rx
c_func
(paren
id|qep
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|qe_status
op_amp
id|CREG_STAT_TXIRQ
)paren
(brace
id|qe_tx
c_func
(paren
id|qep
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|dev-&gt;tbusy
op_logical_and
(paren
id|TX_BUFFS_AVAIL
c_func
(paren
id|qep
)paren
op_ge
l_int|0
)paren
)paren
(brace
id|dev-&gt;tbusy
op_assign
l_int|0
suffix:semicolon
id|mark_bh
c_func
(paren
id|NET_BH
)paren
suffix:semicolon
)brace
id|next
suffix:colon
id|dev-&gt;interrupt
op_assign
l_int|0
suffix:semicolon
)brace
id|qec_status
op_rshift_assign
l_int|4
suffix:semicolon
id|channel
op_increment
suffix:semicolon
)brace
)brace
DECL|function|sun4c_qec_interrupt
r_static
r_void
id|sun4c_qec_interrupt
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_struct
id|sunqec
op_star
id|qecp
op_assign
(paren
r_struct
id|sunqec
op_star
)paren
id|dev_id
suffix:semicolon
r_int
r_int
id|qec_status
suffix:semicolon
r_int
id|channel
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Latch the status now. */
id|qec_status
op_assign
id|qecp-&gt;gregs-&gt;stat
suffix:semicolon
r_while
c_loop
(paren
id|channel
OL
l_int|4
)paren
(brace
r_if
c_cond
(paren
id|qec_status
op_amp
l_int|0xf
)paren
(brace
r_struct
id|sunqe
op_star
id|qep
op_assign
id|qecp-&gt;qes
(braket
id|channel
)braket
suffix:semicolon
r_struct
id|device
op_star
id|dev
op_assign
id|qep-&gt;dev
suffix:semicolon
r_int
r_int
id|qe_status
suffix:semicolon
id|dev-&gt;interrupt
op_assign
l_int|1
suffix:semicolon
id|qe_status
op_assign
id|qep-&gt;qcregs-&gt;stat
suffix:semicolon
r_if
c_cond
(paren
id|qe_status
op_amp
id|CREG_STAT_ERRORS
)paren
r_if
c_cond
(paren
id|qe_is_bolixed
c_func
(paren
id|qep
comma
id|qe_status
)paren
)paren
(brace
r_goto
id|next
suffix:semicolon
)brace
r_if
c_cond
(paren
id|qe_status
op_amp
id|CREG_STAT_RXIRQ
)paren
(brace
id|sun4c_qe_rx
c_func
(paren
id|qep
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|qe_status
op_amp
id|CREG_STAT_TXIRQ
)paren
(brace
id|sun4c_qe_tx
c_func
(paren
id|qep
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|dev-&gt;tbusy
op_logical_and
(paren
id|SUN4C_TX_BUFFS_AVAIL
c_func
(paren
id|qep
)paren
op_ge
l_int|0
)paren
)paren
(brace
id|dev-&gt;tbusy
op_assign
l_int|0
suffix:semicolon
id|mark_bh
c_func
(paren
id|NET_BH
)paren
suffix:semicolon
)brace
id|next
suffix:colon
id|dev-&gt;interrupt
op_assign
l_int|0
suffix:semicolon
)brace
id|qec_status
op_rshift_assign
l_int|4
suffix:semicolon
id|channel
op_increment
suffix:semicolon
)brace
)brace
DECL|function|qe_open
r_static
r_int
id|qe_open
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
r_struct
id|sunqe
op_star
id|qep
op_assign
(paren
r_struct
id|sunqe
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_int
id|res
suffix:semicolon
id|res
op_assign
id|qe_init
c_func
(paren
id|qep
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|res
)paren
(brace
id|MOD_INC_USE_COUNT
suffix:semicolon
)brace
r_return
id|res
suffix:semicolon
)brace
DECL|function|qe_close
r_static
r_int
id|qe_close
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
r_struct
id|sunqe
op_star
id|qep
op_assign
(paren
r_struct
id|sunqe
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|qe_stop
c_func
(paren
id|qep
)paren
suffix:semicolon
id|qe_clean_rings
c_func
(paren
id|qep
)paren
suffix:semicolon
id|MOD_DEC_USE_COUNT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Get a packet queued to go onto the wire. */
DECL|function|qe_start_xmit
r_static
r_int
id|qe_start_xmit
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|device
op_star
id|dev
)paren
(brace
r_struct
id|sunqe
op_star
id|qep
op_assign
(paren
r_struct
id|sunqe
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_int
id|len
comma
id|entry
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;tbusy
)paren
(brace
r_return
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|set_bit
c_func
(paren
l_int|0
comma
(paren
r_void
op_star
)paren
op_amp
id|dev-&gt;tbusy
)paren
op_ne
l_int|0
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%s: Transmitter access conflict.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|TX_BUFFS_AVAIL
c_func
(paren
id|qep
)paren
)paren
(brace
r_return
l_int|1
suffix:semicolon
)brace
id|len
op_assign
id|skb-&gt;len
suffix:semicolon
id|entry
op_assign
id|qep-&gt;tx_new
suffix:semicolon
multiline_comment|/* Avoid a race... */
id|qep-&gt;qe_block-&gt;qe_txd
(braket
id|entry
)braket
dot
id|tx_flags
op_assign
id|TXD_UPDATE
suffix:semicolon
id|qep-&gt;tx_skbs
(braket
id|entry
)braket
op_assign
id|skb
suffix:semicolon
multiline_comment|/* FIX FOR ULTRA */
id|qep-&gt;qe_block-&gt;qe_txd
(braket
id|entry
)braket
dot
id|tx_addr
op_assign
(paren
r_int
r_int
)paren
id|skb-&gt;data
suffix:semicolon
id|qep-&gt;qe_block-&gt;qe_txd
(braket
id|entry
)braket
dot
id|tx_flags
op_assign
(paren
id|TXD_OWN
op_or
id|TXD_SOP
op_or
id|TXD_EOP
op_or
(paren
id|len
op_amp
id|TXD_LENGTH
)paren
)paren
suffix:semicolon
id|qep-&gt;tx_new
op_assign
id|NEXT_TX
c_func
(paren
id|entry
)paren
suffix:semicolon
multiline_comment|/* Get it going. */
id|qep-&gt;qcregs-&gt;ctrl
op_assign
id|CREG_CTRL_TWAKEUP
suffix:semicolon
r_if
c_cond
(paren
id|TX_BUFFS_AVAIL
c_func
(paren
id|qep
)paren
)paren
(brace
id|dev-&gt;tbusy
op_assign
l_int|0
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|sun4c_qe_start_xmit
r_static
r_int
id|sun4c_qe_start_xmit
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|device
op_star
id|dev
)paren
(brace
r_struct
id|sunqe
op_star
id|qep
op_assign
(paren
r_struct
id|sunqe
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_struct
id|sunqe_buffers
op_star
id|qbufs
op_assign
id|qep-&gt;sun4c_buffers
suffix:semicolon
id|__u32
id|txbuf_dvma
comma
id|qbufs_dvma
op_assign
id|qep-&gt;s4c_buf_dvma
suffix:semicolon
r_int
r_char
op_star
id|txbuf
suffix:semicolon
r_int
id|len
comma
id|entry
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;tbusy
)paren
(brace
r_return
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|set_bit
c_func
(paren
l_int|0
comma
(paren
r_void
op_star
)paren
op_amp
id|dev-&gt;tbusy
)paren
op_ne
l_int|0
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%s: Transmitter access conflict.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|SUN4C_TX_BUFFS_AVAIL
c_func
(paren
id|qep
)paren
)paren
(brace
r_return
l_int|1
suffix:semicolon
)brace
id|len
op_assign
id|skb-&gt;len
suffix:semicolon
id|entry
op_assign
id|qep-&gt;tx_new
suffix:semicolon
id|txbuf
op_assign
op_amp
id|qbufs-&gt;tx_buf
(braket
id|entry
op_amp
(paren
id|SUN4C_TX_RING_SIZE
op_minus
l_int|1
)paren
)braket
(braket
l_int|0
)braket
suffix:semicolon
id|txbuf_dvma
op_assign
id|qbufs_dvma
op_plus
id|qebuf_offset
c_func
(paren
id|tx_buf
comma
(paren
id|entry
op_amp
(paren
id|SUN4C_TX_RING_SIZE
op_minus
l_int|1
)paren
)paren
)paren
suffix:semicolon
multiline_comment|/* Avoid a race... */
id|qep-&gt;qe_block-&gt;qe_txd
(braket
id|entry
)braket
dot
id|tx_flags
op_assign
id|TXD_UPDATE
suffix:semicolon
id|memcpy
c_func
(paren
id|txbuf
comma
id|skb-&gt;data
comma
id|len
)paren
suffix:semicolon
id|qep-&gt;qe_block-&gt;qe_txd
(braket
id|entry
)braket
dot
id|tx_addr
op_assign
id|txbuf_dvma
suffix:semicolon
id|qep-&gt;qe_block-&gt;qe_txd
(braket
id|entry
)braket
dot
id|tx_flags
op_assign
(paren
id|TXD_OWN
op_or
id|TXD_SOP
op_or
id|TXD_EOP
op_or
(paren
id|len
op_amp
id|TXD_LENGTH
)paren
)paren
suffix:semicolon
id|qep-&gt;tx_new
op_assign
id|NEXT_TX
c_func
(paren
id|entry
)paren
suffix:semicolon
multiline_comment|/* Get it going. */
id|qep-&gt;qcregs-&gt;ctrl
op_assign
id|CREG_CTRL_TWAKEUP
suffix:semicolon
id|qep-&gt;net_stats.tx_bytes
op_add_assign
id|skb-&gt;len
suffix:semicolon
id|dev_kfree_skb
c_func
(paren
id|skb
comma
id|FREE_WRITE
)paren
suffix:semicolon
r_if
c_cond
(paren
id|SUN4C_TX_BUFFS_AVAIL
c_func
(paren
id|qep
)paren
)paren
(brace
id|dev-&gt;tbusy
op_assign
l_int|0
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|qe_get_stats
r_static
r_struct
id|net_device_stats
op_star
id|qe_get_stats
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
r_struct
id|sunqe
op_star
id|qep
op_assign
(paren
r_struct
id|sunqe
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_return
op_amp
id|qep-&gt;net_stats
suffix:semicolon
)brace
DECL|macro|CRC_POLYNOMIAL_BE
mdefine_line|#define CRC_POLYNOMIAL_BE 0x04c11db7UL  /* Ethernet CRC, big endian */
DECL|macro|CRC_POLYNOMIAL_LE
mdefine_line|#define CRC_POLYNOMIAL_LE 0xedb88320UL  /* Ethernet CRC, little endian */
DECL|function|qe_set_multicast
r_static
r_void
id|qe_set_multicast
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
r_struct
id|sunqe
op_star
id|qep
op_assign
(paren
r_struct
id|sunqe
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_struct
id|dev_mc_list
op_star
id|dmi
op_assign
id|dev-&gt;mc_list
suffix:semicolon
r_int
r_char
id|new_mconfig
op_assign
(paren
id|MREGS_MCONFIG_TXENAB
op_or
id|MREGS_MCONFIG_RXENAB
)paren
suffix:semicolon
r_char
op_star
id|addrs
suffix:semicolon
r_int
id|i
comma
id|j
comma
id|bit
comma
id|byte
suffix:semicolon
id|u32
id|crc
comma
id|poly
op_assign
id|CRC_POLYNOMIAL_LE
suffix:semicolon
multiline_comment|/* Lock out others. */
id|set_bit
c_func
(paren
l_int|0
comma
(paren
r_void
op_star
)paren
op_amp
id|dev-&gt;tbusy
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|dev-&gt;flags
op_amp
id|IFF_ALLMULTI
)paren
op_logical_or
(paren
id|dev-&gt;mc_count
OG
l_int|64
)paren
)paren
(brace
id|qep-&gt;mregs-&gt;iaconfig
op_assign
id|MREGS_IACONFIG_ACHNGE
op_or
id|MREGS_IACONFIG_LARESET
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|8
suffix:semicolon
id|i
op_increment
)paren
(brace
id|qep-&gt;mregs-&gt;filter
op_assign
l_int|0xff
suffix:semicolon
)brace
id|qep-&gt;mregs-&gt;iaconfig
op_assign
l_int|0
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|dev-&gt;flags
op_amp
id|IFF_PROMISC
)paren
(brace
id|new_mconfig
op_or_assign
id|MREGS_MCONFIG_PROMISC
suffix:semicolon
)brace
r_else
(brace
id|u16
id|hash_table
(braket
l_int|4
)braket
suffix:semicolon
r_int
r_char
op_star
id|hbytes
op_assign
(paren
r_int
r_char
op_star
)paren
op_amp
id|hash_table
(braket
l_int|0
)braket
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|4
suffix:semicolon
id|i
op_increment
)paren
(brace
id|hash_table
(braket
id|i
)braket
op_assign
l_int|0
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|dev-&gt;mc_count
suffix:semicolon
id|i
op_increment
)paren
(brace
id|addrs
op_assign
id|dmi-&gt;dmi_addr
suffix:semicolon
id|dmi
op_assign
id|dmi-&gt;next
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
op_star
id|addrs
op_amp
l_int|1
)paren
)paren
(brace
r_continue
suffix:semicolon
)brace
id|crc
op_assign
l_int|0xffffffffU
suffix:semicolon
r_for
c_loop
(paren
id|byte
op_assign
l_int|0
suffix:semicolon
id|byte
OL
l_int|6
suffix:semicolon
id|byte
op_increment
)paren
(brace
r_for
c_loop
(paren
id|bit
op_assign
op_star
id|addrs
op_increment
comma
id|j
op_assign
l_int|0
suffix:semicolon
id|j
OL
l_int|8
suffix:semicolon
id|j
op_increment
comma
id|bit
op_rshift_assign
l_int|1
)paren
(brace
r_int
id|test
suffix:semicolon
id|test
op_assign
(paren
(paren
id|bit
op_xor
id|crc
)paren
op_amp
l_int|0x01
)paren
suffix:semicolon
id|crc
op_rshift_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|test
)paren
(brace
id|crc
op_assign
id|crc
op_xor
id|poly
suffix:semicolon
)brace
)brace
)brace
id|crc
op_rshift_assign
l_int|26
suffix:semicolon
id|hash_table
(braket
id|crc
op_rshift
l_int|4
)braket
op_or_assign
l_int|1
op_lshift
(paren
id|crc
op_amp
l_int|0xf
)paren
suffix:semicolon
)brace
multiline_comment|/* Program the qe with the new filter value. */
id|qep-&gt;mregs-&gt;iaconfig
op_assign
id|MREGS_IACONFIG_ACHNGE
op_or
id|MREGS_IACONFIG_LARESET
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|8
suffix:semicolon
id|i
op_increment
)paren
(brace
id|qep-&gt;mregs-&gt;filter
op_assign
op_star
id|hbytes
op_increment
suffix:semicolon
)brace
id|qep-&gt;mregs-&gt;iaconfig
op_assign
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Any change of the logical address filter, the physical address,&n;&t; * or enabling/disabling promiscuous mode causes the MACE to disable&n;&t; * the receiver.  So we must re-enable them here or else the MACE&n;&t; * refuses to listen to anything on the network.  Sheesh, took&n;&t; * me a day or two to find this bug.&n;&t; */
id|qep-&gt;mregs-&gt;mconfig
op_assign
id|new_mconfig
suffix:semicolon
multiline_comment|/* Let us get going again. */
id|dev-&gt;tbusy
op_assign
l_int|0
suffix:semicolon
)brace
multiline_comment|/* This is only called once at boot time for each card probed. */
DECL|function|qec_init_once
r_static
r_inline
r_void
id|qec_init_once
c_func
(paren
r_struct
id|sunqec
op_star
id|qecp
comma
r_struct
id|linux_sbus_device
op_star
id|qsdev
)paren
(brace
r_int
r_char
id|bsizes
op_assign
id|qecp-&gt;qec_bursts
suffix:semicolon
r_if
c_cond
(paren
id|bsizes
op_amp
id|DMA_BURST32
)paren
(brace
id|qecp-&gt;gregs-&gt;ctrl
op_assign
id|GLOB_CTRL_B32
suffix:semicolon
)brace
r_else
id|qecp-&gt;gregs-&gt;ctrl
op_assign
id|GLOB_CTRL_B16
suffix:semicolon
multiline_comment|/* Packetsize only used in 100baseT BigMAC configurations,&n;&t; * set it to zero just to be on the safe side.&n;&t; */
id|qecp-&gt;gregs-&gt;psize
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Set the local memsize register, divided up to one piece per QE channel. */
id|qecp-&gt;gregs-&gt;msize
op_assign
(paren
id|qsdev-&gt;reg_addrs
(braket
l_int|1
)braket
dot
id|reg_size
op_rshift
l_int|2
)paren
suffix:semicolon
multiline_comment|/* Divide up the local QEC memory amongst the 4 QE receiver and&n;&t; * transmitter FIFOs.  Basically it is (total / 2 / num_channels).&n;&t; */
id|qecp-&gt;gregs-&gt;rsize
op_assign
id|qecp-&gt;gregs-&gt;tsize
op_assign
(paren
id|qsdev-&gt;reg_addrs
(braket
l_int|1
)braket
dot
id|reg_size
op_rshift
l_int|2
)paren
op_rshift
l_int|1
suffix:semicolon
)brace
multiline_comment|/* Four QE&squot;s per QEC card. */
DECL|function|qec_ether_init
r_static
r_int
id|qec_ether_init
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
r_struct
id|linux_sbus_device
op_star
id|sdev
)paren
(brace
r_static
r_int
id|version_printed
op_assign
l_int|0
suffix:semicolon
r_struct
id|device
op_star
id|qe_devs
(braket
l_int|4
)braket
suffix:semicolon
r_struct
id|sunqe
op_star
id|qeps
(braket
l_int|4
)braket
suffix:semicolon
r_struct
id|linux_sbus_device
op_star
id|qesdevs
(braket
l_int|4
)braket
suffix:semicolon
r_struct
id|sunqec
op_star
id|qecp
suffix:semicolon
r_struct
id|linux_prom_ranges
id|qranges
(braket
l_int|8
)braket
suffix:semicolon
r_int
r_char
id|bsizes
comma
id|bsizes_more
comma
id|num_qranges
suffix:semicolon
r_int
id|i
comma
id|j
comma
id|res
op_assign
id|ENOMEM
suffix:semicolon
id|dev
op_assign
id|init_etherdev
c_func
(paren
l_int|0
comma
r_sizeof
(paren
r_struct
id|sunqe
)paren
)paren
suffix:semicolon
id|qe_devs
(braket
l_int|0
)braket
op_assign
id|dev
suffix:semicolon
id|qeps
(braket
l_int|0
)braket
op_assign
(paren
r_struct
id|sunqe
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|qeps
(braket
l_int|0
)braket
op_member_access_from_pointer
id|channel
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|j
op_assign
l_int|0
suffix:semicolon
id|j
OL
l_int|6
suffix:semicolon
id|j
op_increment
)paren
(brace
id|qe_devs
(braket
l_int|0
)braket
op_member_access_from_pointer
id|dev_addr
(braket
id|j
)braket
op_assign
id|idprom-&gt;id_ethaddr
(braket
id|j
)braket
suffix:semicolon
)brace
r_if
c_cond
(paren
id|version_printed
op_increment
op_eq
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|version
)paren
suffix:semicolon
)brace
id|qe_devs
(braket
l_int|1
)braket
op_assign
id|qe_devs
(braket
l_int|2
)braket
op_assign
id|qe_devs
(braket
l_int|3
)braket
op_assign
l_int|NULL
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|1
suffix:semicolon
id|i
OL
l_int|4
suffix:semicolon
id|i
op_increment
)paren
(brace
id|qe_devs
(braket
id|i
)braket
op_assign
id|init_etherdev
c_func
(paren
l_int|0
comma
r_sizeof
(paren
r_struct
id|sunqe
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|qe_devs
(braket
id|i
)braket
op_eq
l_int|NULL
op_logical_or
id|qe_devs
(braket
id|i
)braket
op_member_access_from_pointer
id|priv
op_eq
l_int|NULL
)paren
(brace
r_goto
id|qec_free_devs
suffix:semicolon
)brace
id|qeps
(braket
id|i
)braket
op_assign
(paren
r_struct
id|sunqe
op_star
)paren
id|qe_devs
(braket
id|i
)braket
op_member_access_from_pointer
id|priv
suffix:semicolon
r_for
c_loop
(paren
id|j
op_assign
l_int|0
suffix:semicolon
id|j
OL
l_int|6
suffix:semicolon
id|j
op_increment
)paren
(brace
id|qe_devs
(braket
id|i
)braket
op_member_access_from_pointer
id|dev_addr
(braket
id|j
)braket
op_assign
id|idprom-&gt;id_ethaddr
(braket
id|j
)braket
suffix:semicolon
)brace
id|qeps
(braket
id|i
)braket
op_member_access_from_pointer
id|channel
op_assign
id|i
suffix:semicolon
)brace
id|qecp
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|sunqec
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|qecp
op_eq
l_int|NULL
)paren
(brace
r_goto
id|qec_free_devs
suffix:semicolon
)brace
id|qecp-&gt;qec_sbus_dev
op_assign
id|sdev
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|4
suffix:semicolon
id|i
op_increment
)paren
(brace
id|qecp-&gt;qes
(braket
id|i
)braket
op_assign
id|qeps
(braket
id|i
)braket
suffix:semicolon
id|qeps
(braket
id|i
)braket
op_member_access_from_pointer
id|dev
op_assign
id|qe_devs
(braket
id|i
)braket
suffix:semicolon
id|qeps
(braket
id|i
)braket
op_member_access_from_pointer
id|parent
op_assign
id|qecp
suffix:semicolon
)brace
multiline_comment|/* Link in channel 0. */
id|i
op_assign
id|prom_getintdefault
c_func
(paren
id|sdev-&gt;child-&gt;prom_node
comma
l_string|&quot;channel#&quot;
comma
op_minus
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
op_eq
op_minus
l_int|1
)paren
(brace
id|res
op_assign
id|ENODEV
suffix:semicolon
r_goto
id|qec_free_devs
suffix:semicolon
)brace
id|qesdevs
(braket
id|i
)braket
op_assign
id|sdev-&gt;child
suffix:semicolon
id|qe_devs
(braket
id|i
)braket
op_member_access_from_pointer
id|base_addr
op_assign
(paren
r_int
)paren
id|qesdevs
(braket
id|i
)braket
suffix:semicolon
multiline_comment|/* Link in channel 1. */
id|i
op_assign
id|prom_getintdefault
c_func
(paren
id|sdev-&gt;child-&gt;next-&gt;prom_node
comma
l_string|&quot;channel#&quot;
comma
op_minus
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
op_eq
op_minus
l_int|1
)paren
(brace
id|res
op_assign
id|ENODEV
suffix:semicolon
r_goto
id|qec_free_devs
suffix:semicolon
)brace
id|qesdevs
(braket
id|i
)braket
op_assign
id|sdev-&gt;child-&gt;next
suffix:semicolon
id|qe_devs
(braket
id|i
)braket
op_member_access_from_pointer
id|base_addr
op_assign
(paren
r_int
)paren
id|qesdevs
(braket
id|i
)braket
suffix:semicolon
multiline_comment|/* Link in channel 2. */
id|i
op_assign
id|prom_getintdefault
c_func
(paren
id|sdev-&gt;child-&gt;next-&gt;next-&gt;prom_node
comma
l_string|&quot;channel#&quot;
comma
op_minus
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
op_eq
op_minus
l_int|1
)paren
(brace
id|res
op_assign
id|ENODEV
suffix:semicolon
r_goto
id|qec_free_devs
suffix:semicolon
)brace
id|qesdevs
(braket
id|i
)braket
op_assign
id|sdev-&gt;child-&gt;next-&gt;next
suffix:semicolon
id|qe_devs
(braket
id|i
)braket
op_member_access_from_pointer
id|base_addr
op_assign
(paren
r_int
)paren
id|qesdevs
(braket
id|i
)braket
suffix:semicolon
multiline_comment|/* Link in channel 3. */
id|i
op_assign
id|prom_getintdefault
c_func
(paren
id|sdev-&gt;child-&gt;next-&gt;next-&gt;next-&gt;prom_node
comma
l_string|&quot;channel#&quot;
comma
op_minus
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
op_eq
op_minus
l_int|1
)paren
(brace
id|res
op_assign
id|ENODEV
suffix:semicolon
r_goto
id|qec_free_devs
suffix:semicolon
)brace
id|qesdevs
(braket
id|i
)braket
op_assign
id|sdev-&gt;child-&gt;next-&gt;next-&gt;next
suffix:semicolon
id|qe_devs
(braket
id|i
)braket
op_member_access_from_pointer
id|base_addr
op_assign
(paren
r_int
)paren
id|qesdevs
(braket
id|i
)braket
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|4
suffix:semicolon
id|i
op_increment
)paren
(brace
id|qeps
(braket
id|i
)braket
op_member_access_from_pointer
id|qe_sbusdev
op_assign
id|qesdevs
(braket
id|i
)braket
suffix:semicolon
)brace
multiline_comment|/* This is a bit of fun, get QEC ranges. */
id|i
op_assign
id|prom_getproperty
c_func
(paren
id|sdev-&gt;prom_node
comma
l_string|&quot;ranges&quot;
comma
(paren
r_char
op_star
)paren
op_amp
id|qranges
(braket
l_int|0
)braket
comma
r_sizeof
(paren
id|qranges
)paren
)paren
suffix:semicolon
id|num_qranges
op_assign
(paren
id|i
op_div
r_sizeof
(paren
r_struct
id|linux_prom_ranges
)paren
)paren
suffix:semicolon
multiline_comment|/* Now, apply all the ranges, QEC ranges then the SBUS ones for each QE. */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|4
suffix:semicolon
id|i
op_increment
)paren
(brace
r_for
c_loop
(paren
id|j
op_assign
l_int|0
suffix:semicolon
id|j
OL
l_int|2
suffix:semicolon
id|j
op_increment
)paren
(brace
r_int
id|k
suffix:semicolon
r_for
c_loop
(paren
id|k
op_assign
l_int|0
suffix:semicolon
id|k
OL
id|num_qranges
suffix:semicolon
id|k
op_increment
)paren
r_if
c_cond
(paren
id|qesdevs
(braket
id|i
)braket
op_member_access_from_pointer
id|reg_addrs
(braket
id|j
)braket
dot
id|which_io
op_eq
id|qranges
(braket
id|k
)braket
dot
id|ot_child_space
)paren
(brace
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|k
op_ge
id|num_qranges
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;QuadEther: Aieee, bogus QEC range for &quot;
l_string|&quot;space %08x&bslash;n&quot;
comma
id|qesdevs
(braket
id|i
)braket
op_member_access_from_pointer
id|reg_addrs
(braket
id|j
)braket
dot
id|which_io
)paren
suffix:semicolon
)brace
id|qesdevs
(braket
id|i
)braket
op_member_access_from_pointer
id|reg_addrs
(braket
id|j
)braket
dot
id|which_io
op_assign
id|qranges
(braket
id|k
)braket
dot
id|ot_parent_space
suffix:semicolon
id|qesdevs
(braket
id|i
)braket
op_member_access_from_pointer
id|reg_addrs
(braket
id|j
)braket
dot
id|phys_addr
op_add_assign
id|qranges
(braket
id|k
)braket
dot
id|ot_parent_base
suffix:semicolon
)brace
id|prom_apply_sbus_ranges
c_func
(paren
id|qesdevs
(braket
id|i
)braket
op_member_access_from_pointer
id|my_bus
comma
op_amp
id|qesdevs
(braket
id|i
)braket
op_member_access_from_pointer
id|reg_addrs
(braket
l_int|0
)braket
comma
l_int|2
comma
id|qesdevs
(braket
id|i
)braket
)paren
suffix:semicolon
)brace
multiline_comment|/* Now map in the registers, QEC globals first. */
id|prom_apply_sbus_ranges
c_func
(paren
id|sdev-&gt;my_bus
comma
op_amp
id|sdev-&gt;reg_addrs
(braket
l_int|0
)braket
comma
id|sdev-&gt;num_registers
comma
id|sdev
)paren
suffix:semicolon
id|qecp-&gt;gregs
op_assign
id|sparc_alloc_io
c_func
(paren
id|sdev-&gt;reg_addrs
(braket
l_int|0
)braket
dot
id|phys_addr
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|qe_globreg
)paren
comma
l_string|&quot;QEC Global Registers&quot;
comma
id|sdev-&gt;reg_addrs
(braket
l_int|0
)braket
dot
id|which_io
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|qecp-&gt;gregs
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;QuadEther: Cannot map QEC global registers.&bslash;n&quot;
)paren
suffix:semicolon
id|res
op_assign
id|ENODEV
suffix:semicolon
r_goto
id|qec_free_devs
suffix:semicolon
)brace
multiline_comment|/* Make sure the QEC is in MACE mode. */
r_if
c_cond
(paren
(paren
id|qecp-&gt;gregs-&gt;ctrl
op_amp
l_int|0xf0000000
)paren
op_ne
id|GLOB_CTRL_MMODE
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;QuadEther: AIEEE, QEC is not in MACE mode!&bslash;n&quot;
)paren
suffix:semicolon
id|res
op_assign
id|ENODEV
suffix:semicolon
r_goto
id|qec_free_devs
suffix:semicolon
)brace
multiline_comment|/* Reset the QEC. */
r_if
c_cond
(paren
id|qec_global_reset
c_func
(paren
id|qecp-&gt;gregs
)paren
)paren
(brace
id|res
op_assign
id|ENODEV
suffix:semicolon
r_goto
id|qec_free_devs
suffix:semicolon
)brace
multiline_comment|/* Find and set the burst sizes for the QEC, since it does&n;&t; * the actual dma for all 4 channels.&n;&t; */
id|bsizes
op_assign
id|prom_getintdefault
c_func
(paren
id|sdev-&gt;prom_node
comma
l_string|&quot;burst-sizes&quot;
comma
l_int|0xff
)paren
suffix:semicolon
id|bsizes
op_and_assign
l_int|0xff
suffix:semicolon
id|bsizes_more
op_assign
id|prom_getintdefault
c_func
(paren
id|sdev-&gt;my_bus-&gt;prom_node
comma
l_string|&quot;burst-sizes&quot;
comma
l_int|0xff
)paren
suffix:semicolon
r_if
c_cond
(paren
id|bsizes_more
op_ne
l_int|0xff
)paren
(brace
id|bsizes
op_and_assign
id|bsizes_more
suffix:semicolon
)brace
r_if
c_cond
(paren
id|bsizes
op_eq
l_int|0xff
op_logical_or
(paren
id|bsizes
op_amp
id|DMA_BURST16
)paren
op_eq
l_int|0
op_logical_or
(paren
id|bsizes
op_amp
id|DMA_BURST32
)paren
op_eq
l_int|0
)paren
(brace
id|bsizes
op_assign
(paren
id|DMA_BURST32
op_minus
l_int|1
)paren
suffix:semicolon
)brace
id|qecp-&gt;qec_bursts
op_assign
id|bsizes
suffix:semicolon
multiline_comment|/* Perform one time QEC initialization, we never touch the QEC&n;&t; * globals again after this.&n;&t; */
id|qec_init_once
c_func
(paren
id|qecp
comma
id|sdev
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|4
suffix:semicolon
id|i
op_increment
)paren
(brace
multiline_comment|/* Map in QEC per-channel control registers. */
id|qeps
(braket
id|i
)braket
op_member_access_from_pointer
id|qcregs
op_assign
id|sparc_alloc_io
c_func
(paren
id|qesdevs
(braket
id|i
)braket
op_member_access_from_pointer
id|reg_addrs
(braket
l_int|0
)braket
dot
id|phys_addr
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|qe_creg
)paren
comma
l_string|&quot;QEC Per-Channel Registers&quot;
comma
id|qesdevs
(braket
id|i
)braket
op_member_access_from_pointer
id|reg_addrs
(braket
l_int|0
)braket
dot
id|which_io
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|qeps
(braket
id|i
)braket
op_member_access_from_pointer
id|qcregs
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;QuadEther: Cannot map QE %d&squot;s channel registers.&bslash;n&quot;
comma
id|i
)paren
suffix:semicolon
id|res
op_assign
id|ENODEV
suffix:semicolon
r_goto
id|qec_free_devs
suffix:semicolon
)brace
multiline_comment|/* Map in per-channel AMD MACE registers. */
id|qeps
(braket
id|i
)braket
op_member_access_from_pointer
id|mregs
op_assign
id|sparc_alloc_io
c_func
(paren
id|qesdevs
(braket
id|i
)braket
op_member_access_from_pointer
id|reg_addrs
(braket
l_int|1
)braket
dot
id|phys_addr
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|qe_mregs
)paren
comma
l_string|&quot;QE MACE Registers&quot;
comma
id|qesdevs
(braket
id|i
)braket
op_member_access_from_pointer
id|reg_addrs
(braket
l_int|1
)braket
dot
id|which_io
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|qeps
(braket
id|i
)braket
op_member_access_from_pointer
id|mregs
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;QuadEther: Cannot map QE %d&squot;s MACE registers.&bslash;n&quot;
comma
id|i
)paren
suffix:semicolon
id|res
op_assign
id|ENODEV
suffix:semicolon
r_goto
id|qec_free_devs
suffix:semicolon
)brace
id|qeps
(braket
id|i
)braket
op_member_access_from_pointer
id|qe_block
op_assign
(paren
r_struct
id|qe_init_block
op_star
)paren
id|sparc_dvma_malloc
c_func
(paren
id|PAGE_SIZE
comma
l_string|&quot;QE Init Block&quot;
comma
op_amp
id|qeps
(braket
id|i
)braket
op_member_access_from_pointer
id|qblock_dvma
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sparc_cpu_model
op_eq
id|sun4c
)paren
(brace
id|qeps
(braket
id|i
)braket
op_member_access_from_pointer
id|sun4c_buffers
op_assign
(paren
r_struct
id|sunqe_buffers
op_star
)paren
id|sparc_dvma_malloc
c_func
(paren
r_sizeof
(paren
r_struct
id|sunqe_buffers
)paren
comma
l_string|&quot;QE RX/TX Buffers&quot;
comma
op_amp
id|qeps
(braket
id|i
)braket
op_member_access_from_pointer
id|s4c_buf_dvma
)paren
suffix:semicolon
)brace
r_else
id|qeps
(braket
id|i
)braket
op_member_access_from_pointer
id|sun4c_buffers
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Stop this QE. */
id|qe_stop
c_func
(paren
id|qeps
(braket
id|i
)braket
)paren
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|4
suffix:semicolon
id|i
op_increment
)paren
(brace
id|qe_devs
(braket
id|i
)braket
op_member_access_from_pointer
id|open
op_assign
id|qe_open
suffix:semicolon
id|qe_devs
(braket
id|i
)braket
op_member_access_from_pointer
id|stop
op_assign
id|qe_close
suffix:semicolon
r_if
c_cond
(paren
id|sparc_cpu_model
op_eq
id|sun4c
)paren
(brace
id|qe_devs
(braket
id|i
)braket
op_member_access_from_pointer
id|hard_start_xmit
op_assign
id|sun4c_qe_start_xmit
suffix:semicolon
)brace
r_else
id|qe_devs
(braket
id|i
)braket
op_member_access_from_pointer
id|hard_start_xmit
op_assign
id|qe_start_xmit
suffix:semicolon
id|qe_devs
(braket
id|i
)braket
op_member_access_from_pointer
id|get_stats
op_assign
id|qe_get_stats
suffix:semicolon
id|qe_devs
(braket
id|i
)braket
op_member_access_from_pointer
id|set_multicast_list
op_assign
id|qe_set_multicast
suffix:semicolon
id|qe_devs
(braket
id|i
)braket
op_member_access_from_pointer
id|irq
op_assign
(paren
r_int
r_char
)paren
id|sdev-&gt;irqs
(braket
l_int|0
)braket
dot
id|pri
suffix:semicolon
id|qe_devs
(braket
id|i
)braket
op_member_access_from_pointer
id|dma
op_assign
l_int|0
suffix:semicolon
id|ether_setup
c_func
(paren
id|qe_devs
(braket
id|i
)braket
)paren
suffix:semicolon
)brace
multiline_comment|/* QEC receives interrupts from each QE, then it send the actual&n;&t; * IRQ to the cpu itself.  Since QEC is the single point of&n;&t; * interrupt for all QE channels we register the IRQ handler&n;&t; * for it now.&n;&t; */
r_if
c_cond
(paren
id|sparc_cpu_model
op_eq
id|sun4c
)paren
(brace
r_if
c_cond
(paren
id|request_irq
c_func
(paren
id|sdev-&gt;irqs
(braket
l_int|0
)braket
dot
id|pri
comma
op_amp
id|sun4c_qec_interrupt
comma
id|SA_SHIRQ
comma
l_string|&quot;QuadEther&quot;
comma
(paren
r_void
op_star
)paren
id|qecp
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;QuadEther: Can&squot;t register QEC master irq handler.&bslash;n&quot;
)paren
suffix:semicolon
id|res
op_assign
id|EAGAIN
suffix:semicolon
r_goto
id|qec_free_devs
suffix:semicolon
)brace
)brace
r_else
(brace
r_if
c_cond
(paren
id|request_irq
c_func
(paren
id|sdev-&gt;irqs
(braket
l_int|0
)braket
dot
id|pri
comma
op_amp
id|qec_interrupt
comma
id|SA_SHIRQ
comma
l_string|&quot;QuadEther&quot;
comma
(paren
r_void
op_star
)paren
id|qecp
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;QuadEther: Can&squot;t register QEC master irq handler.&bslash;n&quot;
)paren
suffix:semicolon
id|res
op_assign
id|EAGAIN
suffix:semicolon
r_goto
id|qec_free_devs
suffix:semicolon
)brace
)brace
multiline_comment|/* Report the QE channels. */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|4
suffix:semicolon
id|i
op_increment
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%s: QuadEthernet channel[%d] &quot;
comma
id|qe_devs
(braket
id|i
)braket
op_member_access_from_pointer
id|name
comma
id|i
)paren
suffix:semicolon
r_for
c_loop
(paren
id|j
op_assign
l_int|0
suffix:semicolon
id|j
OL
l_int|6
suffix:semicolon
id|j
op_increment
)paren
(brace
id|printk
(paren
l_string|&quot;%2.2x%c&quot;
comma
id|qe_devs
(braket
id|i
)braket
op_member_access_from_pointer
id|dev_addr
(braket
id|j
)braket
comma
id|j
op_eq
l_int|5
ques
c_cond
l_char|&squot; &squot;
suffix:colon
l_char|&squot;:&squot;
)paren
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
)brace
macro_line|#ifdef MODULE
multiline_comment|/* We are home free at this point, link the qe&squot;s into&n;&t; * the master list for later module unloading.&n;&t; */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|4
suffix:semicolon
id|i
op_increment
)paren
(brace
id|qe_devs
(braket
id|i
)braket
op_member_access_from_pointer
id|ifindex
op_assign
id|dev_new_index
c_func
(paren
)paren
suffix:semicolon
)brace
id|qecp-&gt;next_module
op_assign
id|root_qec_dev
suffix:semicolon
id|root_qec_dev
op_assign
id|qecp
suffix:semicolon
macro_line|#endif
r_return
l_int|0
suffix:semicolon
id|qec_free_devs
suffix:colon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|4
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|qe_devs
(braket
id|i
)braket
)paren
(brace
r_if
c_cond
(paren
id|qe_devs
(braket
id|i
)braket
op_member_access_from_pointer
id|priv
)paren
(brace
id|kfree
c_func
(paren
id|qe_devs
(braket
id|i
)braket
op_member_access_from_pointer
id|priv
)paren
suffix:semicolon
)brace
id|kfree
c_func
(paren
id|qe_devs
(braket
id|i
)braket
)paren
suffix:semicolon
)brace
)brace
r_return
id|res
suffix:semicolon
)brace
DECL|function|qec_probe
r_int
id|qec_probe
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
r_struct
id|linux_sbus
op_star
id|bus
suffix:semicolon
r_struct
id|linux_sbus_device
op_star
id|sdev
op_assign
l_int|0
suffix:semicolon
r_static
r_int
id|called
op_assign
l_int|0
suffix:semicolon
r_int
id|cards
op_assign
l_int|0
comma
id|v
suffix:semicolon
r_if
c_cond
(paren
id|called
)paren
(brace
r_return
id|ENODEV
suffix:semicolon
)brace
id|called
op_increment
suffix:semicolon
id|for_each_sbus
c_func
(paren
id|bus
)paren
(brace
id|for_each_sbusdev
c_func
(paren
id|sdev
comma
id|bus
)paren
(brace
r_if
c_cond
(paren
id|cards
)paren
(brace
id|dev
op_assign
l_int|NULL
suffix:semicolon
)brace
multiline_comment|/* QEC can be parent of either QuadEthernet or BigMAC&n;&t;&t;&t; * children.&n;&t;&t;&t; */
r_if
c_cond
(paren
op_logical_neg
id|strcmp
c_func
(paren
id|sdev-&gt;prom_name
comma
l_string|&quot;qec&quot;
)paren
op_logical_and
id|sdev-&gt;child
op_logical_and
op_logical_neg
id|strcmp
c_func
(paren
id|sdev-&gt;child-&gt;prom_name
comma
l_string|&quot;qe&quot;
)paren
op_logical_and
id|sdev-&gt;child-&gt;next
op_logical_and
op_logical_neg
id|strcmp
c_func
(paren
id|sdev-&gt;child-&gt;next-&gt;prom_name
comma
l_string|&quot;qe&quot;
)paren
op_logical_and
id|sdev-&gt;child-&gt;next-&gt;next
op_logical_and
op_logical_neg
id|strcmp
c_func
(paren
id|sdev-&gt;child-&gt;next-&gt;next-&gt;prom_name
comma
l_string|&quot;qe&quot;
)paren
op_logical_and
id|sdev-&gt;child-&gt;next-&gt;next-&gt;next
op_logical_and
op_logical_neg
id|strcmp
c_func
(paren
id|sdev-&gt;child-&gt;next-&gt;next-&gt;next-&gt;prom_name
comma
l_string|&quot;qe&quot;
)paren
)paren
(brace
id|cards
op_increment
suffix:semicolon
r_if
c_cond
(paren
(paren
id|v
op_assign
id|qec_ether_init
c_func
(paren
id|dev
comma
id|sdev
)paren
)paren
)paren
(brace
r_return
id|v
suffix:semicolon
)brace
)brace
)brace
)brace
r_if
c_cond
(paren
op_logical_neg
id|cards
)paren
(brace
r_return
id|ENODEV
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#ifdef MODULE
r_int
DECL|function|init_module
id|init_module
c_func
(paren
r_void
)paren
(brace
id|root_qec_dev
op_assign
l_int|NULL
suffix:semicolon
r_return
id|qec_probe
c_func
(paren
l_int|NULL
)paren
suffix:semicolon
)brace
r_void
DECL|function|cleanup_module
id|cleanup_module
c_func
(paren
r_void
)paren
(brace
r_struct
id|sunqec
op_star
id|next_qec
suffix:semicolon
r_int
id|i
suffix:semicolon
multiline_comment|/* No need to check MOD_IN_USE, as sys_delete_module() checks. */
r_while
c_loop
(paren
id|root_qec_dev
)paren
(brace
id|next_qec
op_assign
id|root_qec_dev-&gt;next_module
suffix:semicolon
multiline_comment|/* Release all four QE channels, then the QEC itself. */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|4
suffix:semicolon
id|i
op_increment
)paren
(brace
id|unregister_netdev
c_func
(paren
id|root_qec_dev-&gt;qes
(braket
id|i
)braket
op_member_access_from_pointer
id|dev
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|root_qec_dev-&gt;qes
(braket
id|i
)braket
)paren
suffix:semicolon
)brace
id|free_irq
c_func
(paren
id|root_qec_dev-&gt;qec_sbus_dev-&gt;irqs
(braket
l_int|0
)braket
dot
id|pri
comma
(paren
r_void
op_star
)paren
id|root_qec_dev
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|root_qec_dev
)paren
suffix:semicolon
id|root_qec_dev
op_assign
id|next_qec
suffix:semicolon
)brace
)brace
macro_line|#endif /* MODULE */
eof
