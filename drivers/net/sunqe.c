multiline_comment|/* $Id: sunqe.c,v 1.47 2000/10/22 16:08:38 davem Exp $&n; * sunqe.c: Sparc QuadEthernet 10baseT SBUS card driver.&n; *          Once again I am out to prove that every ethernet&n; *          controller out there can be most efficiently programmed&n; *          if you make it look like a LANCE.&n; *&n; * Copyright (C) 1996, 1999 David S. Miller (davem@redhat.com)&n; */
DECL|variable|version
r_static
r_char
op_star
id|version
op_assign
l_string|&quot;sunqe.c:v2.9 9/11/99 David S. Miller (davem@redhat.com)&bslash;n&quot;
suffix:semicolon
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/fcntl.h&gt;
macro_line|#include &lt;linux/interrupt.h&gt;
macro_line|#include &lt;linux/ptrace.h&gt;
macro_line|#include &lt;linux/ioport.h&gt;
macro_line|#include &lt;linux/in.h&gt;
macro_line|#include &lt;linux/malloc.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;asm/system.h&gt;
macro_line|#include &lt;asm/bitops.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/dma.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;asm/byteorder.h&gt;
macro_line|#include &lt;asm/idprom.h&gt;
macro_line|#include &lt;asm/sbus.h&gt;
macro_line|#include &lt;asm/openprom.h&gt;
macro_line|#include &lt;asm/oplib.h&gt;
macro_line|#include &lt;asm/auxio.h&gt;
macro_line|#include &lt;asm/pgtable.h&gt;
macro_line|#include &lt;asm/irq.h&gt;
macro_line|#include &lt;linux/netdevice.h&gt;
macro_line|#include &lt;linux/etherdevice.h&gt;
macro_line|#include &lt;linux/skbuff.h&gt;
macro_line|#include &quot;sunqe.h&quot;
DECL|variable|root_qec_dev
r_static
r_struct
id|sunqec
op_star
id|root_qec_dev
op_assign
l_int|NULL
suffix:semicolon
r_static
r_void
id|qe_set_multicast
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
DECL|macro|QEC_RESET_TRIES
mdefine_line|#define QEC_RESET_TRIES 200
DECL|function|qec_global_reset
r_static
r_inline
r_int
id|qec_global_reset
c_func
(paren
r_int
r_int
id|gregs
)paren
(brace
r_int
id|tries
op_assign
id|QEC_RESET_TRIES
suffix:semicolon
id|sbus_writel
c_func
(paren
id|GLOB_CTRL_RESET
comma
id|gregs
op_plus
id|GLOB_CTRL
)paren
suffix:semicolon
r_while
c_loop
(paren
op_decrement
id|tries
)paren
(brace
id|u32
id|tmp
op_assign
id|sbus_readl
c_func
(paren
id|gregs
op_plus
id|GLOB_CTRL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tmp
op_amp
id|GLOB_CTRL_RESET
)paren
(brace
id|udelay
c_func
(paren
l_int|20
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|tries
)paren
r_return
l_int|0
suffix:semicolon
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;QuadEther: AIEEE cannot reset the QEC!&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
DECL|macro|MACE_RESET_RETRIES
mdefine_line|#define MACE_RESET_RETRIES 200
DECL|macro|QE_RESET_RETRIES
mdefine_line|#define QE_RESET_RETRIES   200
DECL|function|qe_stop
r_static
r_inline
r_int
id|qe_stop
c_func
(paren
r_struct
id|sunqe
op_star
id|qep
)paren
(brace
r_int
r_int
id|cregs
op_assign
id|qep-&gt;qcregs
suffix:semicolon
r_int
r_int
id|mregs
op_assign
id|qep-&gt;mregs
suffix:semicolon
r_int
id|tries
suffix:semicolon
multiline_comment|/* Reset the MACE, then the QEC channel. */
id|sbus_writeb
c_func
(paren
id|MREGS_BCONFIG_RESET
comma
id|mregs
op_plus
id|MREGS_BCONFIG
)paren
suffix:semicolon
id|tries
op_assign
id|MACE_RESET_RETRIES
suffix:semicolon
r_while
c_loop
(paren
op_decrement
id|tries
)paren
(brace
id|u8
id|tmp
op_assign
id|sbus_readb
c_func
(paren
id|mregs
op_plus
id|MREGS_BCONFIG
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tmp
op_amp
id|MREGS_BCONFIG_RESET
)paren
(brace
id|udelay
c_func
(paren
l_int|20
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|tries
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;QuadEther: AIEEE cannot reset the MACE!&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|sbus_writel
c_func
(paren
id|CREG_CTRL_RESET
comma
id|cregs
op_plus
id|CREG_CTRL
)paren
suffix:semicolon
id|tries
op_assign
id|QE_RESET_RETRIES
suffix:semicolon
r_while
c_loop
(paren
op_decrement
id|tries
)paren
(brace
id|u32
id|tmp
op_assign
id|sbus_readl
c_func
(paren
id|cregs
op_plus
id|CREG_CTRL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tmp
op_amp
id|CREG_CTRL_RESET
)paren
(brace
id|udelay
c_func
(paren
l_int|20
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|tries
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;QuadEther: Cannot reset QE channel!&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|qe_init_rings
r_static
r_void
id|qe_init_rings
c_func
(paren
r_struct
id|sunqe
op_star
id|qep
)paren
(brace
r_struct
id|qe_init_block
op_star
id|qb
op_assign
id|qep-&gt;qe_block
suffix:semicolon
r_struct
id|sunqe_buffers
op_star
id|qbufs
op_assign
id|qep-&gt;buffers
suffix:semicolon
id|__u32
id|qbufs_dvma
op_assign
id|qep-&gt;buffers_dvma
suffix:semicolon
r_int
id|i
suffix:semicolon
id|qep-&gt;rx_new
op_assign
id|qep-&gt;rx_old
op_assign
id|qep-&gt;tx_new
op_assign
id|qep-&gt;tx_old
op_assign
l_int|0
suffix:semicolon
id|memset
c_func
(paren
id|qb
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|qe_init_block
)paren
)paren
suffix:semicolon
id|memset
c_func
(paren
id|qbufs
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|sunqe_buffers
)paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|RX_RING_SIZE
suffix:semicolon
id|i
op_increment
)paren
(brace
id|qb-&gt;qe_rxd
(braket
id|i
)braket
dot
id|rx_addr
op_assign
id|qbufs_dvma
op_plus
id|qebuf_offset
c_func
(paren
id|rx_buf
comma
id|i
)paren
suffix:semicolon
id|qb-&gt;qe_rxd
(braket
id|i
)braket
dot
id|rx_flags
op_assign
(paren
id|RXD_OWN
op_or
(paren
(paren
id|RXD_PKT_SZ
)paren
op_amp
id|RXD_LENGTH
)paren
)paren
suffix:semicolon
)brace
)brace
DECL|function|qe_init
r_static
r_int
id|qe_init
c_func
(paren
r_struct
id|sunqe
op_star
id|qep
comma
r_int
id|from_irq
)paren
(brace
r_struct
id|sunqec
op_star
id|qecp
op_assign
id|qep-&gt;parent
suffix:semicolon
r_int
r_int
id|cregs
op_assign
id|qep-&gt;qcregs
suffix:semicolon
r_int
r_int
id|mregs
op_assign
id|qep-&gt;mregs
suffix:semicolon
r_int
r_int
id|gregs
op_assign
id|qecp-&gt;gregs
suffix:semicolon
r_int
r_char
op_star
id|e
op_assign
op_amp
id|qep-&gt;dev-&gt;dev_addr
(braket
l_int|0
)braket
suffix:semicolon
id|u32
id|tmp
suffix:semicolon
r_int
id|i
suffix:semicolon
multiline_comment|/* Shut it up. */
r_if
c_cond
(paren
id|qe_stop
c_func
(paren
id|qep
)paren
)paren
r_return
op_minus
id|EAGAIN
suffix:semicolon
multiline_comment|/* Setup initial rx/tx init block pointers. */
id|sbus_writel
c_func
(paren
id|qep-&gt;qblock_dvma
op_plus
id|qib_offset
c_func
(paren
id|qe_rxd
comma
l_int|0
)paren
comma
id|cregs
op_plus
id|CREG_RXDS
)paren
suffix:semicolon
id|sbus_writel
c_func
(paren
id|qep-&gt;qblock_dvma
op_plus
id|qib_offset
c_func
(paren
id|qe_txd
comma
l_int|0
)paren
comma
id|cregs
op_plus
id|CREG_TXDS
)paren
suffix:semicolon
multiline_comment|/* Enable/mask the various irq&squot;s. */
id|sbus_writel
c_func
(paren
l_int|0
comma
id|cregs
op_plus
id|CREG_RIMASK
)paren
suffix:semicolon
id|sbus_writel
c_func
(paren
l_int|1
comma
id|cregs
op_plus
id|CREG_TIMASK
)paren
suffix:semicolon
id|sbus_writel
c_func
(paren
l_int|0
comma
id|cregs
op_plus
id|CREG_QMASK
)paren
suffix:semicolon
id|sbus_writel
c_func
(paren
id|CREG_MMASK_RXCOLL
comma
id|cregs
op_plus
id|CREG_MMASK
)paren
suffix:semicolon
multiline_comment|/* Setup the FIFO pointers into QEC local memory. */
id|tmp
op_assign
id|qep-&gt;channel
op_star
id|sbus_readl
c_func
(paren
id|gregs
op_plus
id|GLOB_MSIZE
)paren
suffix:semicolon
id|sbus_writel
c_func
(paren
id|tmp
comma
id|cregs
op_plus
id|CREG_RXRBUFPTR
)paren
suffix:semicolon
id|sbus_writel
c_func
(paren
id|tmp
comma
id|cregs
op_plus
id|CREG_RXWBUFPTR
)paren
suffix:semicolon
id|tmp
op_assign
id|sbus_readl
c_func
(paren
id|cregs
op_plus
id|CREG_RXRBUFPTR
)paren
op_plus
id|sbus_readl
c_func
(paren
id|gregs
op_plus
id|GLOB_RSIZE
)paren
suffix:semicolon
id|sbus_writel
c_func
(paren
id|tmp
comma
id|cregs
op_plus
id|CREG_TXRBUFPTR
)paren
suffix:semicolon
id|sbus_writel
c_func
(paren
id|tmp
comma
id|cregs
op_plus
id|CREG_TXWBUFPTR
)paren
suffix:semicolon
multiline_comment|/* Clear the channel collision counter. */
id|sbus_writel
c_func
(paren
l_int|0
comma
id|cregs
op_plus
id|CREG_CCNT
)paren
suffix:semicolon
multiline_comment|/* For 10baseT, inter frame space nor throttle seems to be necessary. */
id|sbus_writel
c_func
(paren
l_int|0
comma
id|cregs
op_plus
id|CREG_PIPG
)paren
suffix:semicolon
multiline_comment|/* Now dork with the AMD MACE. */
id|sbus_writeb
c_func
(paren
id|MREGS_PHYCONFIG_AUTO
comma
id|mregs
op_plus
id|MREGS_PHYCONFIG
)paren
suffix:semicolon
id|sbus_writeb
c_func
(paren
id|MREGS_TXFCNTL_AUTOPAD
comma
id|mregs
op_plus
id|MREGS_TXFCNTL
)paren
suffix:semicolon
id|sbus_writeb
c_func
(paren
l_int|0
comma
id|mregs
op_plus
id|MREGS_RXFCNTL
)paren
suffix:semicolon
multiline_comment|/* The QEC dma&squot;s the rx&squot;d packets from local memory out to main memory,&n;&t; * and therefore it interrupts when the packet reception is &quot;complete&quot;.&n;&t; * So don&squot;t listen for the MACE talking about it.&n;&t; */
id|sbus_writeb
c_func
(paren
id|MREGS_IMASK_COLL
op_or
id|MREGS_IMASK_RXIRQ
comma
id|mregs
op_plus
id|MREGS_IMASK
)paren
suffix:semicolon
id|sbus_writeb
c_func
(paren
id|MREGS_BCONFIG_BSWAP
op_or
id|MREGS_BCONFIG_64TS
comma
id|mregs
op_plus
id|MREGS_BCONFIG
)paren
suffix:semicolon
id|sbus_writeb
c_func
(paren
(paren
id|MREGS_FCONFIG_TXF16
op_or
id|MREGS_FCONFIG_RXF32
op_or
id|MREGS_FCONFIG_RFWU
op_or
id|MREGS_FCONFIG_TFWU
)paren
comma
id|mregs
op_plus
id|MREGS_FCONFIG
)paren
suffix:semicolon
multiline_comment|/* Only usable interface on QuadEther is twisted pair. */
id|sbus_writeb
c_func
(paren
id|MREGS_PLSCONFIG_TP
comma
id|mregs
op_plus
id|MREGS_PLSCONFIG
)paren
suffix:semicolon
multiline_comment|/* Tell MACE we are changing the ether address. */
id|sbus_writeb
c_func
(paren
id|MREGS_IACONFIG_ACHNGE
op_or
id|MREGS_IACONFIG_PARESET
comma
id|mregs
op_plus
id|MREGS_IACONFIG
)paren
suffix:semicolon
r_while
c_loop
(paren
(paren
id|sbus_readb
c_func
(paren
id|mregs
op_plus
id|MREGS_IACONFIG
)paren
op_amp
id|MREGS_IACONFIG_ACHNGE
)paren
op_ne
l_int|0
)paren
id|barrier
c_func
(paren
)paren
suffix:semicolon
id|sbus_writeb
c_func
(paren
id|e
(braket
l_int|0
)braket
comma
id|mregs
op_plus
id|MREGS_ETHADDR
)paren
suffix:semicolon
id|sbus_writeb
c_func
(paren
id|e
(braket
l_int|1
)braket
comma
id|mregs
op_plus
id|MREGS_ETHADDR
)paren
suffix:semicolon
id|sbus_writeb
c_func
(paren
id|e
(braket
l_int|2
)braket
comma
id|mregs
op_plus
id|MREGS_ETHADDR
)paren
suffix:semicolon
id|sbus_writeb
c_func
(paren
id|e
(braket
l_int|3
)braket
comma
id|mregs
op_plus
id|MREGS_ETHADDR
)paren
suffix:semicolon
id|sbus_writeb
c_func
(paren
id|e
(braket
l_int|4
)braket
comma
id|mregs
op_plus
id|MREGS_ETHADDR
)paren
suffix:semicolon
id|sbus_writeb
c_func
(paren
id|e
(braket
l_int|5
)braket
comma
id|mregs
op_plus
id|MREGS_ETHADDR
)paren
suffix:semicolon
multiline_comment|/* Clear out the address filter. */
id|sbus_writeb
c_func
(paren
id|MREGS_IACONFIG_ACHNGE
op_or
id|MREGS_IACONFIG_LARESET
comma
id|mregs
op_plus
id|MREGS_IACONFIG
)paren
suffix:semicolon
r_while
c_loop
(paren
(paren
id|sbus_readb
c_func
(paren
id|mregs
op_plus
id|MREGS_IACONFIG
)paren
op_amp
id|MREGS_IACONFIG_ACHNGE
)paren
op_ne
l_int|0
)paren
id|barrier
c_func
(paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|8
suffix:semicolon
id|i
op_increment
)paren
id|sbus_writeb
c_func
(paren
l_int|0
comma
id|mregs
op_plus
id|MREGS_FILTER
)paren
suffix:semicolon
multiline_comment|/* Address changes are now complete. */
id|sbus_writeb
c_func
(paren
l_int|0
comma
id|mregs
op_plus
id|MREGS_IACONFIG
)paren
suffix:semicolon
id|qe_init_rings
c_func
(paren
id|qep
)paren
suffix:semicolon
multiline_comment|/* Wait a little bit for the link to come up... */
id|mdelay
c_func
(paren
l_int|5
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|sbus_readb
c_func
(paren
id|mregs
op_plus
id|MREGS_PHYCONFIG
)paren
op_amp
id|MREGS_PHYCONFIG_LTESTDIS
)paren
)paren
(brace
r_int
id|tries
op_assign
l_int|50
suffix:semicolon
r_while
c_loop
(paren
id|tries
op_decrement
)paren
(brace
id|u8
id|tmp
suffix:semicolon
id|mdelay
c_func
(paren
l_int|5
)paren
suffix:semicolon
id|barrier
c_func
(paren
)paren
suffix:semicolon
id|tmp
op_assign
id|sbus_readb
c_func
(paren
id|mregs
op_plus
id|MREGS_PHYCONFIG
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|tmp
op_amp
id|MREGS_PHYCONFIG_LSTAT
)paren
op_ne
l_int|0
)paren
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|tries
op_eq
l_int|0
)paren
id|printk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;%s: Warning, link state is down.&bslash;n&quot;
comma
id|qep-&gt;dev-&gt;name
)paren
suffix:semicolon
)brace
multiline_comment|/* Missed packet counter is cleared on a read. */
id|sbus_readb
c_func
(paren
id|mregs
op_plus
id|MREGS_MPCNT
)paren
suffix:semicolon
multiline_comment|/* Reload multicast information, this will enable the receiver&n;&t; * and transmitter.&n;&t; */
id|qe_set_multicast
c_func
(paren
id|qep-&gt;dev
)paren
suffix:semicolon
multiline_comment|/* QEC should now start to show interrupts. */
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Grrr, certain error conditions completely lock up the AMD MACE,&n; * so when we get these we _must_ reset the chip.&n; */
DECL|function|qe_is_bolixed
r_static
r_int
id|qe_is_bolixed
c_func
(paren
r_struct
id|sunqe
op_star
id|qep
comma
id|u32
id|qe_status
)paren
(brace
r_struct
id|net_device
op_star
id|dev
op_assign
id|qep-&gt;dev
suffix:semicolon
r_int
id|mace_hwbug_workaround
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|qe_status
op_amp
id|CREG_STAT_EDEFER
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: Excessive transmit defers.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|qep-&gt;net_stats.tx_errors
op_increment
suffix:semicolon
)brace
r_if
c_cond
(paren
id|qe_status
op_amp
id|CREG_STAT_CLOSS
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: Carrier lost, link down?&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|qep-&gt;net_stats.tx_errors
op_increment
suffix:semicolon
id|qep-&gt;net_stats.tx_carrier_errors
op_increment
suffix:semicolon
)brace
r_if
c_cond
(paren
id|qe_status
op_amp
id|CREG_STAT_ERETRIES
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: Excessive transmit retries (more than 16).&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|qep-&gt;net_stats.tx_errors
op_increment
suffix:semicolon
id|mace_hwbug_workaround
op_assign
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|qe_status
op_amp
id|CREG_STAT_LCOLL
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: Late transmit collision.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|qep-&gt;net_stats.tx_errors
op_increment
suffix:semicolon
id|qep-&gt;net_stats.collisions
op_increment
suffix:semicolon
id|mace_hwbug_workaround
op_assign
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|qe_status
op_amp
id|CREG_STAT_FUFLOW
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: Transmit fifo underflow, driver bug.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|qep-&gt;net_stats.tx_errors
op_increment
suffix:semicolon
id|mace_hwbug_workaround
op_assign
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|qe_status
op_amp
id|CREG_STAT_JERROR
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: Jabber error.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|qe_status
op_amp
id|CREG_STAT_BERROR
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: Babble error.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|qe_status
op_amp
id|CREG_STAT_CCOFLOW
)paren
(brace
id|qep-&gt;net_stats.tx_errors
op_add_assign
l_int|256
suffix:semicolon
id|qep-&gt;net_stats.collisions
op_add_assign
l_int|256
suffix:semicolon
)brace
r_if
c_cond
(paren
id|qe_status
op_amp
id|CREG_STAT_TXDERROR
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: Transmit descriptor is bogus, driver bug.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|qep-&gt;net_stats.tx_errors
op_increment
suffix:semicolon
id|qep-&gt;net_stats.tx_aborted_errors
op_increment
suffix:semicolon
id|mace_hwbug_workaround
op_assign
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|qe_status
op_amp
id|CREG_STAT_TXLERR
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: Transmit late error.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|qep-&gt;net_stats.tx_errors
op_increment
suffix:semicolon
id|mace_hwbug_workaround
op_assign
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|qe_status
op_amp
id|CREG_STAT_TXPERR
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: Transmit DMA parity error.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|qep-&gt;net_stats.tx_errors
op_increment
suffix:semicolon
id|qep-&gt;net_stats.tx_aborted_errors
op_increment
suffix:semicolon
id|mace_hwbug_workaround
op_assign
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|qe_status
op_amp
id|CREG_STAT_TXSERR
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: Transmit DMA sbus error ack.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|qep-&gt;net_stats.tx_errors
op_increment
suffix:semicolon
id|qep-&gt;net_stats.tx_aborted_errors
op_increment
suffix:semicolon
id|mace_hwbug_workaround
op_assign
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|qe_status
op_amp
id|CREG_STAT_RCCOFLOW
)paren
(brace
id|qep-&gt;net_stats.rx_errors
op_add_assign
l_int|256
suffix:semicolon
id|qep-&gt;net_stats.collisions
op_add_assign
l_int|256
suffix:semicolon
)brace
r_if
c_cond
(paren
id|qe_status
op_amp
id|CREG_STAT_RUOFLOW
)paren
(brace
id|qep-&gt;net_stats.rx_errors
op_add_assign
l_int|256
suffix:semicolon
id|qep-&gt;net_stats.rx_over_errors
op_add_assign
l_int|256
suffix:semicolon
)brace
r_if
c_cond
(paren
id|qe_status
op_amp
id|CREG_STAT_MCOFLOW
)paren
(brace
id|qep-&gt;net_stats.rx_errors
op_add_assign
l_int|256
suffix:semicolon
id|qep-&gt;net_stats.rx_missed_errors
op_add_assign
l_int|256
suffix:semicolon
)brace
r_if
c_cond
(paren
id|qe_status
op_amp
id|CREG_STAT_RXFOFLOW
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: Receive fifo overflow.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|qep-&gt;net_stats.rx_errors
op_increment
suffix:semicolon
id|qep-&gt;net_stats.rx_over_errors
op_increment
suffix:semicolon
)brace
r_if
c_cond
(paren
id|qe_status
op_amp
id|CREG_STAT_RLCOLL
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: Late receive collision.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|qep-&gt;net_stats.rx_errors
op_increment
suffix:semicolon
id|qep-&gt;net_stats.collisions
op_increment
suffix:semicolon
)brace
r_if
c_cond
(paren
id|qe_status
op_amp
id|CREG_STAT_FCOFLOW
)paren
(brace
id|qep-&gt;net_stats.rx_errors
op_add_assign
l_int|256
suffix:semicolon
id|qep-&gt;net_stats.rx_frame_errors
op_add_assign
l_int|256
suffix:semicolon
)brace
r_if
c_cond
(paren
id|qe_status
op_amp
id|CREG_STAT_CECOFLOW
)paren
(brace
id|qep-&gt;net_stats.rx_errors
op_add_assign
l_int|256
suffix:semicolon
id|qep-&gt;net_stats.rx_crc_errors
op_add_assign
l_int|256
suffix:semicolon
)brace
r_if
c_cond
(paren
id|qe_status
op_amp
id|CREG_STAT_RXDROP
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: Receive packet dropped.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|qep-&gt;net_stats.rx_errors
op_increment
suffix:semicolon
id|qep-&gt;net_stats.rx_dropped
op_increment
suffix:semicolon
id|qep-&gt;net_stats.rx_missed_errors
op_increment
suffix:semicolon
)brace
r_if
c_cond
(paren
id|qe_status
op_amp
id|CREG_STAT_RXSMALL
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: Receive buffer too small, driver bug.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|qep-&gt;net_stats.rx_errors
op_increment
suffix:semicolon
id|qep-&gt;net_stats.rx_length_errors
op_increment
suffix:semicolon
)brace
r_if
c_cond
(paren
id|qe_status
op_amp
id|CREG_STAT_RXLERR
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: Receive late error.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|qep-&gt;net_stats.rx_errors
op_increment
suffix:semicolon
id|mace_hwbug_workaround
op_assign
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|qe_status
op_amp
id|CREG_STAT_RXPERR
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: Receive DMA parity error.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|qep-&gt;net_stats.rx_errors
op_increment
suffix:semicolon
id|qep-&gt;net_stats.rx_missed_errors
op_increment
suffix:semicolon
id|mace_hwbug_workaround
op_assign
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|qe_status
op_amp
id|CREG_STAT_RXSERR
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: Receive DMA sbus error ack.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|qep-&gt;net_stats.rx_errors
op_increment
suffix:semicolon
id|qep-&gt;net_stats.rx_missed_errors
op_increment
suffix:semicolon
id|mace_hwbug_workaround
op_assign
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|mace_hwbug_workaround
)paren
id|qe_init
c_func
(paren
id|qep
comma
l_int|1
)paren
suffix:semicolon
r_return
id|mace_hwbug_workaround
suffix:semicolon
)brace
multiline_comment|/* Per-QE receive interrupt service routine.  Just like on the happy meal&n; * we receive directly into skb&squot;s with a small packet copy water mark.&n; */
DECL|function|qe_rx
r_static
r_void
id|qe_rx
c_func
(paren
r_struct
id|sunqe
op_star
id|qep
)paren
(brace
r_struct
id|qe_rxd
op_star
id|rxbase
op_assign
op_amp
id|qep-&gt;qe_block-&gt;qe_rxd
(braket
l_int|0
)braket
suffix:semicolon
r_struct
id|qe_rxd
op_star
id|this
suffix:semicolon
r_struct
id|sunqe_buffers
op_star
id|qbufs
op_assign
id|qep-&gt;buffers
suffix:semicolon
id|__u32
id|qbufs_dvma
op_assign
id|qep-&gt;buffers_dvma
suffix:semicolon
r_int
id|elem
op_assign
id|qep-&gt;rx_new
comma
id|drops
op_assign
l_int|0
suffix:semicolon
id|u32
id|flags
suffix:semicolon
id|this
op_assign
op_amp
id|rxbase
(braket
id|elem
)braket
suffix:semicolon
r_while
c_loop
(paren
op_logical_neg
(paren
(paren
id|flags
op_assign
id|this-&gt;rx_flags
)paren
op_amp
id|RXD_OWN
)paren
)paren
(brace
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
r_int
r_char
op_star
id|this_qbuf
op_assign
op_amp
id|qbufs-&gt;rx_buf
(braket
id|elem
op_amp
(paren
id|RX_RING_SIZE
op_minus
l_int|1
)paren
)braket
(braket
l_int|0
)braket
suffix:semicolon
id|__u32
id|this_qbuf_dvma
op_assign
id|qbufs_dvma
op_plus
id|qebuf_offset
c_func
(paren
id|rx_buf
comma
(paren
id|elem
op_amp
(paren
id|RX_RING_SIZE
op_minus
l_int|1
)paren
)paren
)paren
suffix:semicolon
r_struct
id|qe_rxd
op_star
id|end_rxd
op_assign
op_amp
id|rxbase
(braket
(paren
id|elem
op_plus
id|RX_RING_SIZE
)paren
op_amp
(paren
id|RX_RING_MAXSIZE
op_minus
l_int|1
)paren
)braket
suffix:semicolon
r_int
id|len
op_assign
(paren
id|flags
op_amp
id|RXD_LENGTH
)paren
op_minus
l_int|4
suffix:semicolon
multiline_comment|/* QE adds ether FCS size to len */
multiline_comment|/* Check for errors. */
r_if
c_cond
(paren
id|len
OL
id|ETH_ZLEN
)paren
(brace
id|qep-&gt;net_stats.rx_errors
op_increment
suffix:semicolon
id|qep-&gt;net_stats.rx_length_errors
op_increment
suffix:semicolon
id|qep-&gt;net_stats.rx_dropped
op_increment
suffix:semicolon
)brace
r_else
(brace
id|skb
op_assign
id|dev_alloc_skb
c_func
(paren
id|len
op_plus
l_int|2
)paren
suffix:semicolon
r_if
c_cond
(paren
id|skb
op_eq
l_int|NULL
)paren
(brace
id|drops
op_increment
suffix:semicolon
id|qep-&gt;net_stats.rx_dropped
op_increment
suffix:semicolon
)brace
r_else
(brace
id|skb-&gt;dev
op_assign
id|qep-&gt;dev
suffix:semicolon
id|skb_reserve
c_func
(paren
id|skb
comma
l_int|2
)paren
suffix:semicolon
id|skb_put
c_func
(paren
id|skb
comma
id|len
)paren
suffix:semicolon
id|eth_copy_and_sum
c_func
(paren
id|skb
comma
(paren
r_int
r_char
op_star
)paren
id|this_qbuf
comma
id|len
comma
l_int|0
)paren
suffix:semicolon
id|skb-&gt;protocol
op_assign
id|eth_type_trans
c_func
(paren
id|skb
comma
id|qep-&gt;dev
)paren
suffix:semicolon
id|netif_rx
c_func
(paren
id|skb
)paren
suffix:semicolon
id|qep-&gt;net_stats.rx_packets
op_increment
suffix:semicolon
id|qep-&gt;net_stats.rx_bytes
op_add_assign
id|len
suffix:semicolon
)brace
)brace
id|end_rxd-&gt;rx_addr
op_assign
id|this_qbuf_dvma
suffix:semicolon
id|end_rxd-&gt;rx_flags
op_assign
(paren
id|RXD_OWN
op_or
(paren
(paren
id|RXD_PKT_SZ
)paren
op_amp
id|RXD_LENGTH
)paren
)paren
suffix:semicolon
id|elem
op_assign
id|NEXT_RX
c_func
(paren
id|elem
)paren
suffix:semicolon
id|this
op_assign
op_amp
id|rxbase
(braket
id|elem
)braket
suffix:semicolon
)brace
id|qep-&gt;rx_new
op_assign
id|elem
suffix:semicolon
r_if
c_cond
(paren
id|drops
)paren
id|printk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;%s: Memory squeeze, deferring packet.&bslash;n&quot;
comma
id|qep-&gt;dev-&gt;name
)paren
suffix:semicolon
)brace
r_static
r_void
id|qe_tx_reclaim
c_func
(paren
r_struct
id|sunqe
op_star
id|qep
)paren
suffix:semicolon
multiline_comment|/* Interrupts for all QE&squot;s get filtered out via the QEC master controller,&n; * so we just run through each qe and check to see who is signaling&n; * and thus needs to be serviced.&n; */
DECL|function|qec_interrupt
r_static
r_void
id|qec_interrupt
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_struct
id|sunqec
op_star
id|qecp
op_assign
(paren
r_struct
id|sunqec
op_star
)paren
id|dev_id
suffix:semicolon
id|u32
id|qec_status
suffix:semicolon
r_int
id|channel
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Latch the status now. */
id|qec_status
op_assign
id|sbus_readl
c_func
(paren
id|qecp-&gt;gregs
op_plus
id|GLOB_STAT
)paren
suffix:semicolon
r_while
c_loop
(paren
id|channel
OL
l_int|4
)paren
(brace
r_if
c_cond
(paren
id|qec_status
op_amp
l_int|0xf
)paren
(brace
r_struct
id|sunqe
op_star
id|qep
op_assign
id|qecp-&gt;qes
(braket
id|channel
)braket
suffix:semicolon
id|u32
id|qe_status
suffix:semicolon
id|qe_status
op_assign
id|sbus_readl
c_func
(paren
id|qep-&gt;qcregs
op_plus
id|CREG_STAT
)paren
suffix:semicolon
r_if
c_cond
(paren
id|qe_status
op_amp
id|CREG_STAT_ERRORS
)paren
(brace
r_if
c_cond
(paren
id|qe_is_bolixed
c_func
(paren
id|qep
comma
id|qe_status
)paren
)paren
r_goto
id|next
suffix:semicolon
)brace
r_if
c_cond
(paren
id|qe_status
op_amp
id|CREG_STAT_RXIRQ
)paren
id|qe_rx
c_func
(paren
id|qep
)paren
suffix:semicolon
r_if
c_cond
(paren
id|netif_queue_stopped
c_func
(paren
id|qep-&gt;dev
)paren
op_logical_and
(paren
id|qe_status
op_amp
id|CREG_STAT_TXIRQ
)paren
)paren
(brace
id|spin_lock
c_func
(paren
op_amp
id|qep-&gt;lock
)paren
suffix:semicolon
id|qe_tx_reclaim
c_func
(paren
id|qep
)paren
suffix:semicolon
r_if
c_cond
(paren
id|TX_BUFFS_AVAIL
c_func
(paren
id|qep
)paren
OG
l_int|0
)paren
(brace
multiline_comment|/* Wake net queue and return to&n;&t;&t;&t;&t;&t; * lazy tx reclaim.&n;&t;&t;&t;&t;&t; */
id|netif_wake_queue
c_func
(paren
id|qep-&gt;dev
)paren
suffix:semicolon
id|sbus_writel
c_func
(paren
l_int|1
comma
id|qep-&gt;qcregs
op_plus
id|CREG_TIMASK
)paren
suffix:semicolon
)brace
id|spin_unlock
c_func
(paren
op_amp
id|qep-&gt;lock
)paren
suffix:semicolon
)brace
id|next
suffix:colon
)brace
id|qec_status
op_rshift_assign
l_int|4
suffix:semicolon
id|channel
op_increment
suffix:semicolon
)brace
)brace
DECL|function|qe_open
r_static
r_int
id|qe_open
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|sunqe
op_star
id|qep
op_assign
(paren
r_struct
id|sunqe
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_int
id|res
suffix:semicolon
id|qep-&gt;mconfig
op_assign
(paren
id|MREGS_MCONFIG_TXENAB
op_or
id|MREGS_MCONFIG_RXENAB
op_or
id|MREGS_MCONFIG_MBAENAB
)paren
suffix:semicolon
id|res
op_assign
id|qe_init
c_func
(paren
id|qep
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|res
)paren
id|MOD_INC_USE_COUNT
suffix:semicolon
r_return
id|res
suffix:semicolon
)brace
DECL|function|qe_close
r_static
r_int
id|qe_close
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|sunqe
op_star
id|qep
op_assign
(paren
r_struct
id|sunqe
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|qe_stop
c_func
(paren
id|qep
)paren
suffix:semicolon
id|MOD_DEC_USE_COUNT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Reclaim TX&squot;d frames from the ring.  This must always run under&n; * the IRQ protected qep-&gt;lock.&n; */
DECL|function|qe_tx_reclaim
r_static
r_void
id|qe_tx_reclaim
c_func
(paren
r_struct
id|sunqe
op_star
id|qep
)paren
(brace
r_struct
id|qe_txd
op_star
id|txbase
op_assign
op_amp
id|qep-&gt;qe_block-&gt;qe_txd
(braket
l_int|0
)braket
suffix:semicolon
r_int
id|elem
op_assign
id|qep-&gt;tx_old
suffix:semicolon
r_while
c_loop
(paren
id|elem
op_ne
id|qep-&gt;tx_new
)paren
(brace
id|u32
id|flags
op_assign
id|txbase
(braket
id|elem
)braket
dot
id|tx_flags
suffix:semicolon
r_if
c_cond
(paren
id|flags
op_amp
id|TXD_OWN
)paren
r_break
suffix:semicolon
id|elem
op_assign
id|NEXT_TX
c_func
(paren
id|elem
)paren
suffix:semicolon
)brace
id|qep-&gt;tx_old
op_assign
id|elem
suffix:semicolon
)brace
DECL|function|qe_tx_timeout
r_static
r_void
id|qe_tx_timeout
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|sunqe
op_star
id|qep
op_assign
(paren
r_struct
id|sunqe
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_int
id|tx_full
suffix:semicolon
id|spin_lock_irq
c_func
(paren
op_amp
id|qep-&gt;lock
)paren
suffix:semicolon
multiline_comment|/* Try to reclaim, if that frees up some tx&n;&t; * entries, we&squot;re fine.&n;&t; */
id|qe_tx_reclaim
c_func
(paren
id|qep
)paren
suffix:semicolon
id|tx_full
op_assign
id|TX_BUFFS_AVAIL
c_func
(paren
id|qep
)paren
op_le
l_int|0
suffix:semicolon
id|spin_unlock_irq
c_func
(paren
op_amp
id|qep-&gt;lock
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|tx_full
)paren
r_goto
id|out
suffix:semicolon
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: transmit timed out, resetting&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|qe_init
c_func
(paren
id|qep
comma
l_int|1
)paren
suffix:semicolon
id|out
suffix:colon
id|netif_wake_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
multiline_comment|/* Get a packet queued to go onto the wire. */
DECL|function|qe_start_xmit
r_static
r_int
id|qe_start_xmit
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|sunqe
op_star
id|qep
op_assign
(paren
r_struct
id|sunqe
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_struct
id|sunqe_buffers
op_star
id|qbufs
op_assign
id|qep-&gt;buffers
suffix:semicolon
id|__u32
id|txbuf_dvma
comma
id|qbufs_dvma
op_assign
id|qep-&gt;buffers_dvma
suffix:semicolon
r_int
r_char
op_star
id|txbuf
suffix:semicolon
r_int
id|len
comma
id|entry
suffix:semicolon
id|spin_lock_irq
c_func
(paren
op_amp
id|qep-&gt;lock
)paren
suffix:semicolon
id|qe_tx_reclaim
c_func
(paren
id|qep
)paren
suffix:semicolon
id|len
op_assign
id|skb-&gt;len
suffix:semicolon
id|entry
op_assign
id|qep-&gt;tx_new
suffix:semicolon
id|txbuf
op_assign
op_amp
id|qbufs-&gt;tx_buf
(braket
id|entry
op_amp
(paren
id|TX_RING_SIZE
op_minus
l_int|1
)paren
)braket
(braket
l_int|0
)braket
suffix:semicolon
id|txbuf_dvma
op_assign
id|qbufs_dvma
op_plus
id|qebuf_offset
c_func
(paren
id|tx_buf
comma
(paren
id|entry
op_amp
(paren
id|TX_RING_SIZE
op_minus
l_int|1
)paren
)paren
)paren
suffix:semicolon
multiline_comment|/* Avoid a race... */
id|qep-&gt;qe_block-&gt;qe_txd
(braket
id|entry
)braket
dot
id|tx_flags
op_assign
id|TXD_UPDATE
suffix:semicolon
id|memcpy
c_func
(paren
id|txbuf
comma
id|skb-&gt;data
comma
id|len
)paren
suffix:semicolon
id|qep-&gt;qe_block-&gt;qe_txd
(braket
id|entry
)braket
dot
id|tx_addr
op_assign
id|txbuf_dvma
suffix:semicolon
id|qep-&gt;qe_block-&gt;qe_txd
(braket
id|entry
)braket
dot
id|tx_flags
op_assign
(paren
id|TXD_OWN
op_or
id|TXD_SOP
op_or
id|TXD_EOP
op_or
(paren
id|len
op_amp
id|TXD_LENGTH
)paren
)paren
suffix:semicolon
id|qep-&gt;tx_new
op_assign
id|NEXT_TX
c_func
(paren
id|entry
)paren
suffix:semicolon
multiline_comment|/* Get it going. */
id|dev-&gt;trans_start
op_assign
id|jiffies
suffix:semicolon
id|sbus_writel
c_func
(paren
id|CREG_CTRL_TWAKEUP
comma
id|qep-&gt;qcregs
op_plus
id|CREG_CTRL
)paren
suffix:semicolon
id|qep-&gt;net_stats.tx_packets
op_increment
suffix:semicolon
id|qep-&gt;net_stats.tx_bytes
op_add_assign
id|len
suffix:semicolon
r_if
c_cond
(paren
id|TX_BUFFS_AVAIL
c_func
(paren
id|qep
)paren
op_le
l_int|0
)paren
(brace
multiline_comment|/* Halt the net queue and enable tx interrupts.&n;&t;&t; * When the tx queue empties the tx irq handler&n;&t;&t; * will wake up the queue and return us back to&n;&t;&t; * the lazy tx reclaim scheme.&n;&t;&t; */
id|netif_stop_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
id|sbus_writel
c_func
(paren
l_int|0
comma
id|qep-&gt;qcregs
op_plus
id|CREG_TIMASK
)paren
suffix:semicolon
)brace
id|spin_unlock_irq
c_func
(paren
op_amp
id|qep-&gt;lock
)paren
suffix:semicolon
id|dev_kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|qe_get_stats
r_static
r_struct
id|net_device_stats
op_star
id|qe_get_stats
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|sunqe
op_star
id|qep
op_assign
(paren
r_struct
id|sunqe
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_return
op_amp
id|qep-&gt;net_stats
suffix:semicolon
)brace
DECL|macro|CRC_POLYNOMIAL_BE
mdefine_line|#define CRC_POLYNOMIAL_BE 0x04c11db7UL  /* Ethernet CRC, big endian */
DECL|macro|CRC_POLYNOMIAL_LE
mdefine_line|#define CRC_POLYNOMIAL_LE 0xedb88320UL  /* Ethernet CRC, little endian */
DECL|function|qe_set_multicast
r_static
r_void
id|qe_set_multicast
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|sunqe
op_star
id|qep
op_assign
(paren
r_struct
id|sunqe
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_struct
id|dev_mc_list
op_star
id|dmi
op_assign
id|dev-&gt;mc_list
suffix:semicolon
id|u8
id|new_mconfig
op_assign
id|qep-&gt;mconfig
suffix:semicolon
r_char
op_star
id|addrs
suffix:semicolon
r_int
id|i
comma
id|j
comma
id|bit
comma
id|byte
suffix:semicolon
id|u32
id|crc
comma
id|poly
op_assign
id|CRC_POLYNOMIAL_LE
suffix:semicolon
multiline_comment|/* Lock out others. */
id|netif_stop_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|dev-&gt;flags
op_amp
id|IFF_ALLMULTI
)paren
op_logical_or
(paren
id|dev-&gt;mc_count
OG
l_int|64
)paren
)paren
(brace
id|sbus_writeb
c_func
(paren
id|MREGS_IACONFIG_ACHNGE
op_or
id|MREGS_IACONFIG_LARESET
comma
id|qep-&gt;mregs
op_plus
id|MREGS_IACONFIG
)paren
suffix:semicolon
r_while
c_loop
(paren
(paren
id|sbus_readb
c_func
(paren
id|qep-&gt;mregs
op_plus
id|MREGS_IACONFIG
)paren
op_amp
id|MREGS_IACONFIG_ACHNGE
)paren
op_ne
l_int|0
)paren
id|barrier
c_func
(paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|8
suffix:semicolon
id|i
op_increment
)paren
id|sbus_writeb
c_func
(paren
l_int|0xff
comma
id|qep-&gt;mregs
op_plus
id|MREGS_FILTER
)paren
suffix:semicolon
id|sbus_writeb
c_func
(paren
l_int|0
comma
id|qep-&gt;mregs
op_plus
id|MREGS_IACONFIG
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|dev-&gt;flags
op_amp
id|IFF_PROMISC
)paren
(brace
id|new_mconfig
op_or_assign
id|MREGS_MCONFIG_PROMISC
suffix:semicolon
)brace
r_else
(brace
id|u16
id|hash_table
(braket
l_int|4
)braket
suffix:semicolon
id|u8
op_star
id|hbytes
op_assign
(paren
r_int
r_char
op_star
)paren
op_amp
id|hash_table
(braket
l_int|0
)braket
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|4
suffix:semicolon
id|i
op_increment
)paren
id|hash_table
(braket
id|i
)braket
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|dev-&gt;mc_count
suffix:semicolon
id|i
op_increment
)paren
(brace
id|addrs
op_assign
id|dmi-&gt;dmi_addr
suffix:semicolon
id|dmi
op_assign
id|dmi-&gt;next
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
op_star
id|addrs
op_amp
l_int|1
)paren
)paren
r_continue
suffix:semicolon
id|crc
op_assign
l_int|0xffffffffU
suffix:semicolon
r_for
c_loop
(paren
id|byte
op_assign
l_int|0
suffix:semicolon
id|byte
OL
l_int|6
suffix:semicolon
id|byte
op_increment
)paren
(brace
r_for
c_loop
(paren
id|bit
op_assign
op_star
id|addrs
op_increment
comma
id|j
op_assign
l_int|0
suffix:semicolon
id|j
OL
l_int|8
suffix:semicolon
id|j
op_increment
comma
id|bit
op_rshift_assign
l_int|1
)paren
(brace
r_int
id|test
suffix:semicolon
id|test
op_assign
(paren
(paren
id|bit
op_xor
id|crc
)paren
op_amp
l_int|0x01
)paren
suffix:semicolon
id|crc
op_rshift_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|test
)paren
id|crc
op_assign
id|crc
op_xor
id|poly
suffix:semicolon
)brace
)brace
id|crc
op_rshift_assign
l_int|26
suffix:semicolon
id|hash_table
(braket
id|crc
op_rshift
l_int|4
)braket
op_or_assign
l_int|1
op_lshift
(paren
id|crc
op_amp
l_int|0xf
)paren
suffix:semicolon
)brace
multiline_comment|/* Program the qe with the new filter value. */
id|sbus_writeb
c_func
(paren
id|MREGS_IACONFIG_ACHNGE
op_or
id|MREGS_IACONFIG_LARESET
comma
id|qep-&gt;mregs
op_plus
id|MREGS_IACONFIG
)paren
suffix:semicolon
r_while
c_loop
(paren
(paren
id|sbus_readb
c_func
(paren
id|qep-&gt;mregs
op_plus
id|MREGS_IACONFIG
)paren
op_amp
id|MREGS_IACONFIG_ACHNGE
)paren
op_ne
l_int|0
)paren
id|barrier
c_func
(paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|8
suffix:semicolon
id|i
op_increment
)paren
(brace
id|u8
id|tmp
op_assign
op_star
id|hbytes
op_increment
suffix:semicolon
id|sbus_writeb
c_func
(paren
id|tmp
comma
id|qep-&gt;mregs
op_plus
id|MREGS_FILTER
)paren
suffix:semicolon
)brace
id|sbus_writeb
c_func
(paren
l_int|0
comma
id|qep-&gt;mregs
op_plus
id|MREGS_IACONFIG
)paren
suffix:semicolon
)brace
multiline_comment|/* Any change of the logical address filter, the physical address,&n;&t; * or enabling/disabling promiscuous mode causes the MACE to disable&n;&t; * the receiver.  So we must re-enable them here or else the MACE&n;&t; * refuses to listen to anything on the network.  Sheesh, took&n;&t; * me a day or two to find this bug.&n;&t; */
id|qep-&gt;mconfig
op_assign
id|new_mconfig
suffix:semicolon
id|sbus_writeb
c_func
(paren
id|qep-&gt;mconfig
comma
id|qep-&gt;mregs
op_plus
id|MREGS_MCONFIG
)paren
suffix:semicolon
multiline_comment|/* Let us get going again. */
id|netif_wake_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
multiline_comment|/* This is only called once at boot time for each card probed. */
DECL|function|qec_init_once
r_static
r_inline
r_void
id|qec_init_once
c_func
(paren
r_struct
id|sunqec
op_star
id|qecp
comma
r_struct
id|sbus_dev
op_star
id|qsdev
)paren
(brace
id|u8
id|bsizes
op_assign
id|qecp-&gt;qec_bursts
suffix:semicolon
r_if
c_cond
(paren
id|sbus_can_burst64
c_func
(paren
id|qsdev
)paren
op_logical_and
(paren
id|bsizes
op_amp
id|DMA_BURST64
)paren
)paren
(brace
id|sbus_writel
c_func
(paren
id|GLOB_CTRL_B64
comma
id|qecp-&gt;gregs
op_plus
id|GLOB_CTRL
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|bsizes
op_amp
id|DMA_BURST32
)paren
(brace
id|sbus_writel
c_func
(paren
id|GLOB_CTRL_B32
comma
id|qecp-&gt;gregs
op_plus
id|GLOB_CTRL
)paren
suffix:semicolon
)brace
r_else
(brace
id|sbus_writel
c_func
(paren
id|GLOB_CTRL_B16
comma
id|qecp-&gt;gregs
op_plus
id|GLOB_CTRL
)paren
suffix:semicolon
)brace
multiline_comment|/* Packetsize only used in 100baseT BigMAC configurations,&n;&t; * set it to zero just to be on the safe side.&n;&t; */
id|sbus_writel
c_func
(paren
id|GLOB_PSIZE_2048
comma
id|qecp-&gt;gregs
op_plus
id|GLOB_PSIZE
)paren
suffix:semicolon
multiline_comment|/* Set the local memsize register, divided up to one piece per QE channel. */
id|sbus_writel
c_func
(paren
(paren
id|qsdev-&gt;reg_addrs
(braket
l_int|1
)braket
dot
id|reg_size
op_rshift
l_int|2
)paren
comma
id|qecp-&gt;gregs
op_plus
id|GLOB_MSIZE
)paren
suffix:semicolon
multiline_comment|/* Divide up the local QEC memory amongst the 4 QE receiver and&n;&t; * transmitter FIFOs.  Basically it is (total / 2 / num_channels).&n;&t; */
id|sbus_writel
c_func
(paren
(paren
id|qsdev-&gt;reg_addrs
(braket
l_int|1
)braket
dot
id|reg_size
op_rshift
l_int|2
)paren
op_rshift
l_int|1
comma
id|qecp-&gt;gregs
op_plus
id|GLOB_TSIZE
)paren
suffix:semicolon
id|sbus_writel
c_func
(paren
(paren
id|qsdev-&gt;reg_addrs
(braket
l_int|1
)braket
dot
id|reg_size
op_rshift
l_int|2
)paren
op_rshift
l_int|1
comma
id|qecp-&gt;gregs
op_plus
id|GLOB_RSIZE
)paren
suffix:semicolon
)brace
multiline_comment|/* Four QE&squot;s per QEC card. */
DECL|function|qec_ether_init
r_static
r_int
id|__init
id|qec_ether_init
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_struct
id|sbus_dev
op_star
id|sdev
)paren
(brace
r_static
r_int
id|version_printed
op_assign
l_int|0
suffix:semicolon
r_struct
id|net_device
op_star
id|qe_devs
(braket
l_int|4
)braket
suffix:semicolon
r_struct
id|sunqe
op_star
id|qeps
(braket
l_int|4
)braket
suffix:semicolon
r_struct
id|sbus_dev
op_star
id|qesdevs
(braket
l_int|4
)braket
suffix:semicolon
r_struct
id|sunqec
op_star
id|qecp
op_assign
l_int|NULL
suffix:semicolon
id|u8
id|bsizes
comma
id|bsizes_more
suffix:semicolon
r_int
id|i
comma
id|j
comma
id|res
op_assign
id|ENOMEM
suffix:semicolon
id|dev
op_assign
id|init_etherdev
c_func
(paren
l_int|0
comma
r_sizeof
(paren
r_struct
id|sunqe
)paren
)paren
suffix:semicolon
id|qe_devs
(braket
l_int|0
)braket
op_assign
id|dev
suffix:semicolon
id|qeps
(braket
l_int|0
)braket
op_assign
(paren
r_struct
id|sunqe
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|qeps
(braket
l_int|0
)braket
op_member_access_from_pointer
id|channel
op_assign
l_int|0
suffix:semicolon
id|spin_lock_init
c_func
(paren
op_amp
id|qeps
(braket
l_int|0
)braket
op_member_access_from_pointer
id|lock
)paren
suffix:semicolon
r_for
c_loop
(paren
id|j
op_assign
l_int|0
suffix:semicolon
id|j
OL
l_int|6
suffix:semicolon
id|j
op_increment
)paren
id|qe_devs
(braket
l_int|0
)braket
op_member_access_from_pointer
id|dev_addr
(braket
id|j
)braket
op_assign
id|idprom-&gt;id_ethaddr
(braket
id|j
)braket
suffix:semicolon
r_if
c_cond
(paren
id|version_printed
op_increment
op_eq
l_int|0
)paren
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s&quot;
comma
id|version
)paren
suffix:semicolon
id|qe_devs
(braket
l_int|1
)braket
op_assign
id|qe_devs
(braket
l_int|2
)braket
op_assign
id|qe_devs
(braket
l_int|3
)braket
op_assign
l_int|NULL
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|1
suffix:semicolon
id|i
OL
l_int|4
suffix:semicolon
id|i
op_increment
)paren
(brace
id|qe_devs
(braket
id|i
)braket
op_assign
id|init_etherdev
c_func
(paren
l_int|0
comma
r_sizeof
(paren
r_struct
id|sunqe
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|qe_devs
(braket
id|i
)braket
op_eq
l_int|NULL
op_logical_or
id|qe_devs
(braket
id|i
)braket
op_member_access_from_pointer
id|priv
op_eq
l_int|NULL
)paren
r_goto
id|qec_free_devs
suffix:semicolon
id|qeps
(braket
id|i
)braket
op_assign
(paren
r_struct
id|sunqe
op_star
)paren
id|qe_devs
(braket
id|i
)braket
op_member_access_from_pointer
id|priv
suffix:semicolon
r_for
c_loop
(paren
id|j
op_assign
l_int|0
suffix:semicolon
id|j
OL
l_int|6
suffix:semicolon
id|j
op_increment
)paren
id|qe_devs
(braket
id|i
)braket
op_member_access_from_pointer
id|dev_addr
(braket
id|j
)braket
op_assign
id|idprom-&gt;id_ethaddr
(braket
id|j
)braket
suffix:semicolon
id|qeps
(braket
id|i
)braket
op_member_access_from_pointer
id|channel
op_assign
id|i
suffix:semicolon
)brace
id|qecp
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|sunqec
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|qecp
op_eq
l_int|NULL
)paren
r_goto
id|qec_free_devs
suffix:semicolon
id|qecp-&gt;qec_sdev
op_assign
id|sdev
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|4
suffix:semicolon
id|i
op_increment
)paren
(brace
id|qecp-&gt;qes
(braket
id|i
)braket
op_assign
id|qeps
(braket
id|i
)braket
suffix:semicolon
id|qeps
(braket
id|i
)braket
op_member_access_from_pointer
id|dev
op_assign
id|qe_devs
(braket
id|i
)braket
suffix:semicolon
id|qeps
(braket
id|i
)braket
op_member_access_from_pointer
id|parent
op_assign
id|qecp
suffix:semicolon
)brace
multiline_comment|/* Link in channel 0. */
id|i
op_assign
id|prom_getintdefault
c_func
(paren
id|sdev-&gt;child-&gt;prom_node
comma
l_string|&quot;channel#&quot;
comma
op_minus
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
op_eq
op_minus
l_int|1
)paren
(brace
id|res
op_assign
id|ENODEV
suffix:semicolon
r_goto
id|qec_free_devs
suffix:semicolon
)brace
id|qesdevs
(braket
id|i
)braket
op_assign
id|sdev-&gt;child
suffix:semicolon
multiline_comment|/* Link in channel 1. */
id|i
op_assign
id|prom_getintdefault
c_func
(paren
id|sdev-&gt;child-&gt;next-&gt;prom_node
comma
l_string|&quot;channel#&quot;
comma
op_minus
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
op_eq
op_minus
l_int|1
)paren
(brace
id|res
op_assign
id|ENODEV
suffix:semicolon
r_goto
id|qec_free_devs
suffix:semicolon
)brace
id|qesdevs
(braket
id|i
)braket
op_assign
id|sdev-&gt;child-&gt;next
suffix:semicolon
multiline_comment|/* Link in channel 2. */
id|i
op_assign
id|prom_getintdefault
c_func
(paren
id|sdev-&gt;child-&gt;next-&gt;next-&gt;prom_node
comma
l_string|&quot;channel#&quot;
comma
op_minus
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
op_eq
op_minus
l_int|1
)paren
(brace
id|res
op_assign
id|ENODEV
suffix:semicolon
r_goto
id|qec_free_devs
suffix:semicolon
)brace
id|qesdevs
(braket
id|i
)braket
op_assign
id|sdev-&gt;child-&gt;next-&gt;next
suffix:semicolon
multiline_comment|/* Link in channel 3. */
id|i
op_assign
id|prom_getintdefault
c_func
(paren
id|sdev-&gt;child-&gt;next-&gt;next-&gt;next-&gt;prom_node
comma
l_string|&quot;channel#&quot;
comma
op_minus
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
op_eq
op_minus
l_int|1
)paren
(brace
id|res
op_assign
id|ENODEV
suffix:semicolon
r_goto
id|qec_free_devs
suffix:semicolon
)brace
id|qesdevs
(braket
id|i
)braket
op_assign
id|sdev-&gt;child-&gt;next-&gt;next-&gt;next
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|4
suffix:semicolon
id|i
op_increment
)paren
id|qeps
(braket
id|i
)braket
op_member_access_from_pointer
id|qe_sdev
op_assign
id|qesdevs
(braket
id|i
)braket
suffix:semicolon
multiline_comment|/* Now map in the registers, QEC globals first. */
id|qecp-&gt;gregs
op_assign
id|sbus_ioremap
c_func
(paren
op_amp
id|sdev-&gt;resource
(braket
l_int|0
)braket
comma
l_int|0
comma
id|GLOB_REG_SIZE
comma
l_string|&quot;QEC Global Registers&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|qecp-&gt;gregs
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;QuadEther: Cannot map QEC global registers.&bslash;n&quot;
)paren
suffix:semicolon
id|res
op_assign
id|ENODEV
suffix:semicolon
r_goto
id|qec_free_devs
suffix:semicolon
)brace
multiline_comment|/* Make sure the QEC is in MACE mode. */
r_if
c_cond
(paren
(paren
id|sbus_readl
c_func
(paren
id|qecp-&gt;gregs
op_plus
id|GLOB_CTRL
)paren
op_amp
l_int|0xf0000000
)paren
op_ne
id|GLOB_CTRL_MMODE
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;QuadEther: AIEEE, QEC is not in MACE mode!&bslash;n&quot;
)paren
suffix:semicolon
id|res
op_assign
id|ENODEV
suffix:semicolon
r_goto
id|qec_free_devs
suffix:semicolon
)brace
multiline_comment|/* Reset the QEC. */
r_if
c_cond
(paren
id|qec_global_reset
c_func
(paren
id|qecp-&gt;gregs
)paren
)paren
(brace
id|res
op_assign
id|ENODEV
suffix:semicolon
r_goto
id|qec_free_devs
suffix:semicolon
)brace
multiline_comment|/* Find and set the burst sizes for the QEC, since it does&n;&t; * the actual dma for all 4 channels.&n;&t; */
id|bsizes
op_assign
id|prom_getintdefault
c_func
(paren
id|sdev-&gt;prom_node
comma
l_string|&quot;burst-sizes&quot;
comma
l_int|0xff
)paren
suffix:semicolon
id|bsizes
op_and_assign
l_int|0xff
suffix:semicolon
id|bsizes_more
op_assign
id|prom_getintdefault
c_func
(paren
id|sdev-&gt;bus-&gt;prom_node
comma
l_string|&quot;burst-sizes&quot;
comma
l_int|0xff
)paren
suffix:semicolon
r_if
c_cond
(paren
id|bsizes_more
op_ne
l_int|0xff
)paren
id|bsizes
op_and_assign
id|bsizes_more
suffix:semicolon
r_if
c_cond
(paren
id|bsizes
op_eq
l_int|0xff
op_logical_or
(paren
id|bsizes
op_amp
id|DMA_BURST16
)paren
op_eq
l_int|0
op_logical_or
(paren
id|bsizes
op_amp
id|DMA_BURST32
)paren
op_eq
l_int|0
)paren
id|bsizes
op_assign
(paren
id|DMA_BURST32
op_minus
l_int|1
)paren
suffix:semicolon
id|qecp-&gt;qec_bursts
op_assign
id|bsizes
suffix:semicolon
multiline_comment|/* Perform one time QEC initialization, we never touch the QEC&n;&t; * globals again after this.&n;&t; */
id|qec_init_once
c_func
(paren
id|qecp
comma
id|sdev
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|4
suffix:semicolon
id|i
op_increment
)paren
(brace
multiline_comment|/* Map in QEC per-channel control registers. */
id|qeps
(braket
id|i
)braket
op_member_access_from_pointer
id|qcregs
op_assign
id|sbus_ioremap
c_func
(paren
op_amp
id|qesdevs
(braket
id|i
)braket
op_member_access_from_pointer
id|resource
(braket
l_int|0
)braket
comma
l_int|0
comma
id|CREG_REG_SIZE
comma
l_string|&quot;QEC Channel Registers&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|qeps
(braket
id|i
)braket
op_member_access_from_pointer
id|qcregs
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;QuadEther: Cannot map QE %d&squot;s channel registers.&bslash;n&quot;
comma
id|i
)paren
suffix:semicolon
id|res
op_assign
id|ENODEV
suffix:semicolon
r_goto
id|qec_free_devs
suffix:semicolon
)brace
multiline_comment|/* Map in per-channel AMD MACE registers. */
id|qeps
(braket
id|i
)braket
op_member_access_from_pointer
id|mregs
op_assign
id|sbus_ioremap
c_func
(paren
op_amp
id|qesdevs
(braket
id|i
)braket
op_member_access_from_pointer
id|resource
(braket
l_int|1
)braket
comma
l_int|0
comma
id|MREGS_REG_SIZE
comma
l_string|&quot;QE MACE Registers&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|qeps
(braket
id|i
)braket
op_member_access_from_pointer
id|mregs
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;QuadEther: Cannot map QE %d&squot;s MACE registers.&bslash;n&quot;
comma
id|i
)paren
suffix:semicolon
id|res
op_assign
id|ENODEV
suffix:semicolon
r_goto
id|qec_free_devs
suffix:semicolon
)brace
id|qeps
(braket
id|i
)braket
op_member_access_from_pointer
id|qe_block
op_assign
id|sbus_alloc_consistent
c_func
(paren
id|qesdevs
(braket
id|i
)braket
comma
id|PAGE_SIZE
comma
op_amp
id|qeps
(braket
id|i
)braket
op_member_access_from_pointer
id|qblock_dvma
)paren
suffix:semicolon
id|qeps
(braket
id|i
)braket
op_member_access_from_pointer
id|buffers
op_assign
id|sbus_alloc_consistent
c_func
(paren
id|qesdevs
(braket
id|i
)braket
comma
r_sizeof
(paren
r_struct
id|sunqe_buffers
)paren
comma
op_amp
id|qeps
(braket
id|i
)braket
op_member_access_from_pointer
id|buffers_dvma
)paren
suffix:semicolon
r_if
c_cond
(paren
id|qeps
(braket
id|i
)braket
op_member_access_from_pointer
id|qe_block
op_eq
l_int|NULL
op_logical_or
id|qeps
(braket
id|i
)braket
op_member_access_from_pointer
id|qblock_dvma
op_eq
l_int|0
op_logical_or
id|qeps
(braket
id|i
)braket
op_member_access_from_pointer
id|buffers
op_eq
l_int|NULL
op_logical_or
id|qeps
(braket
id|i
)braket
op_member_access_from_pointer
id|buffers_dvma
op_eq
l_int|0
)paren
(brace
id|res
op_assign
id|ENODEV
suffix:semicolon
r_goto
id|qec_free_devs
suffix:semicolon
)brace
multiline_comment|/* Stop this QE. */
id|qe_stop
c_func
(paren
id|qeps
(braket
id|i
)braket
)paren
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|4
suffix:semicolon
id|i
op_increment
)paren
(brace
id|qe_devs
(braket
id|i
)braket
op_member_access_from_pointer
id|open
op_assign
id|qe_open
suffix:semicolon
id|qe_devs
(braket
id|i
)braket
op_member_access_from_pointer
id|stop
op_assign
id|qe_close
suffix:semicolon
id|qe_devs
(braket
id|i
)braket
op_member_access_from_pointer
id|hard_start_xmit
op_assign
id|qe_start_xmit
suffix:semicolon
id|qe_devs
(braket
id|i
)braket
op_member_access_from_pointer
id|get_stats
op_assign
id|qe_get_stats
suffix:semicolon
id|qe_devs
(braket
id|i
)braket
op_member_access_from_pointer
id|set_multicast_list
op_assign
id|qe_set_multicast
suffix:semicolon
id|qe_devs
(braket
id|i
)braket
op_member_access_from_pointer
id|tx_timeout
op_assign
id|qe_tx_timeout
suffix:semicolon
id|qe_devs
(braket
id|i
)braket
op_member_access_from_pointer
id|watchdog_timeo
op_assign
l_int|5
op_star
id|HZ
suffix:semicolon
id|qe_devs
(braket
id|i
)braket
op_member_access_from_pointer
id|irq
op_assign
id|sdev-&gt;irqs
(braket
l_int|0
)braket
suffix:semicolon
id|qe_devs
(braket
id|i
)braket
op_member_access_from_pointer
id|dma
op_assign
l_int|0
suffix:semicolon
id|ether_setup
c_func
(paren
id|qe_devs
(braket
id|i
)braket
)paren
suffix:semicolon
)brace
multiline_comment|/* QEC receives interrupts from each QE, then it sends the actual&n;&t; * IRQ to the cpu itself.  Since QEC is the single point of&n;&t; * interrupt for all QE channels we register the IRQ handler&n;&t; * for it now.&n;&t; */
r_if
c_cond
(paren
id|request_irq
c_func
(paren
id|sdev-&gt;irqs
(braket
l_int|0
)braket
comma
op_amp
id|qec_interrupt
comma
id|SA_SHIRQ
comma
l_string|&quot;QuadEther&quot;
comma
(paren
r_void
op_star
)paren
id|qecp
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;QuadEther: Can&squot;t register QEC master irq handler.&bslash;n&quot;
)paren
suffix:semicolon
id|res
op_assign
id|EAGAIN
suffix:semicolon
r_goto
id|qec_free_devs
suffix:semicolon
)brace
multiline_comment|/* Report the QE channels. */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|4
suffix:semicolon
id|i
op_increment
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: QuadEthernet channel[%d] &quot;
comma
id|qe_devs
(braket
id|i
)braket
op_member_access_from_pointer
id|name
comma
id|i
)paren
suffix:semicolon
r_for
c_loop
(paren
id|j
op_assign
l_int|0
suffix:semicolon
id|j
OL
l_int|6
suffix:semicolon
id|j
op_increment
)paren
id|printk
(paren
l_string|&quot;%2.2x%c&quot;
comma
id|qe_devs
(braket
id|i
)braket
op_member_access_from_pointer
id|dev_addr
(braket
id|j
)braket
comma
id|j
op_eq
l_int|5
ques
c_cond
l_char|&squot; &squot;
suffix:colon
l_char|&squot;:&squot;
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/* We are home free at this point, link the qe&squot;s into&n;&t; * the master list for later driver exit.&n;&t; */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|4
suffix:semicolon
id|i
op_increment
)paren
id|qe_devs
(braket
id|i
)braket
op_member_access_from_pointer
id|ifindex
op_assign
id|dev_new_index
c_func
(paren
)paren
suffix:semicolon
id|qecp-&gt;next_module
op_assign
id|root_qec_dev
suffix:semicolon
id|root_qec_dev
op_assign
id|qecp
suffix:semicolon
r_return
l_int|0
suffix:semicolon
id|qec_free_devs
suffix:colon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|4
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|qe_devs
(braket
id|i
)braket
op_ne
l_int|NULL
)paren
(brace
r_if
c_cond
(paren
id|qe_devs
(braket
id|i
)braket
op_member_access_from_pointer
id|priv
)paren
(brace
r_struct
id|sunqe
op_star
id|qe
op_assign
(paren
r_struct
id|sunqe
op_star
)paren
id|qe_devs
(braket
id|i
)braket
op_member_access_from_pointer
id|priv
suffix:semicolon
r_if
c_cond
(paren
id|qe-&gt;qcregs
)paren
id|sbus_iounmap
c_func
(paren
id|qe-&gt;qcregs
comma
id|CREG_REG_SIZE
)paren
suffix:semicolon
r_if
c_cond
(paren
id|qe-&gt;mregs
)paren
id|sbus_iounmap
c_func
(paren
id|qe-&gt;mregs
comma
id|MREGS_REG_SIZE
)paren
suffix:semicolon
r_if
c_cond
(paren
id|qe-&gt;qe_block
op_ne
l_int|NULL
)paren
id|sbus_free_consistent
c_func
(paren
id|qe-&gt;qe_sdev
comma
id|PAGE_SIZE
comma
id|qe-&gt;qe_block
comma
id|qe-&gt;qblock_dvma
)paren
suffix:semicolon
r_if
c_cond
(paren
id|qe-&gt;buffers
op_ne
l_int|NULL
)paren
id|sbus_free_consistent
c_func
(paren
id|qe-&gt;qe_sdev
comma
r_sizeof
(paren
r_struct
id|sunqe_buffers
)paren
comma
id|qe-&gt;buffers
comma
id|qe-&gt;buffers_dvma
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|qe_devs
(braket
id|i
)braket
op_member_access_from_pointer
id|priv
)paren
suffix:semicolon
)brace
id|kfree
c_func
(paren
id|qe_devs
(braket
id|i
)braket
)paren
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|qecp
op_ne
l_int|NULL
)paren
(brace
r_if
c_cond
(paren
id|qecp-&gt;gregs
)paren
id|sbus_iounmap
c_func
(paren
id|qecp-&gt;gregs
comma
id|GLOB_REG_SIZE
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|qecp
)paren
suffix:semicolon
)brace
r_return
id|res
suffix:semicolon
)brace
DECL|function|qec_match
r_static
r_int
id|__init
id|qec_match
c_func
(paren
r_struct
id|sbus_dev
op_star
id|sdev
)paren
(brace
r_struct
id|sbus_dev
op_star
id|sibling
suffix:semicolon
r_int
id|i
suffix:semicolon
r_if
c_cond
(paren
id|strcmp
c_func
(paren
id|sdev-&gt;prom_name
comma
l_string|&quot;qec&quot;
)paren
op_ne
l_int|0
)paren
r_return
l_int|0
suffix:semicolon
multiline_comment|/* QEC can be parent of either QuadEthernet or BigMAC&n;&t; * children.  Do not confuse this with qfe/SUNW,qfe&n;&t; * which is a quad-happymeal card and handled by&n;&t; * a different driver.&n;&t; */
id|sibling
op_assign
id|sdev-&gt;child
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|4
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|sibling
op_eq
l_int|NULL
)paren
r_return
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|strcmp
c_func
(paren
id|sibling-&gt;prom_name
comma
l_string|&quot;qe&quot;
)paren
op_ne
l_int|0
)paren
r_return
l_int|0
suffix:semicolon
id|sibling
op_assign
id|sibling-&gt;next
suffix:semicolon
)brace
r_return
l_int|1
suffix:semicolon
)brace
DECL|function|qec_probe
r_static
r_int
id|__init
id|qec_probe
c_func
(paren
r_void
)paren
(brace
r_struct
id|net_device
op_star
id|dev
op_assign
l_int|NULL
suffix:semicolon
r_struct
id|sbus_bus
op_star
id|bus
suffix:semicolon
r_struct
id|sbus_dev
op_star
id|sdev
op_assign
l_int|0
suffix:semicolon
r_static
r_int
id|called
op_assign
l_int|0
suffix:semicolon
r_int
id|cards
op_assign
l_int|0
comma
id|v
suffix:semicolon
id|root_qec_dev
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
id|called
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
id|called
op_increment
suffix:semicolon
id|for_each_sbus
c_func
(paren
id|bus
)paren
(brace
id|for_each_sbusdev
c_func
(paren
id|sdev
comma
id|bus
)paren
(brace
r_if
c_cond
(paren
id|cards
)paren
id|dev
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
id|qec_match
c_func
(paren
id|sdev
)paren
)paren
(brace
id|cards
op_increment
suffix:semicolon
r_if
c_cond
(paren
(paren
id|v
op_assign
id|qec_ether_init
c_func
(paren
id|dev
comma
id|sdev
)paren
)paren
)paren
r_return
id|v
suffix:semicolon
)brace
)brace
)brace
r_if
c_cond
(paren
op_logical_neg
id|cards
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|qec_cleanup
r_static
r_void
id|__exit
id|qec_cleanup
c_func
(paren
r_void
)paren
(brace
r_struct
id|sunqec
op_star
id|next_qec
suffix:semicolon
r_int
id|i
suffix:semicolon
r_while
c_loop
(paren
id|root_qec_dev
)paren
(brace
id|next_qec
op_assign
id|root_qec_dev-&gt;next_module
suffix:semicolon
multiline_comment|/* Release all four QE channels, then the QEC itself. */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|4
suffix:semicolon
id|i
op_increment
)paren
(brace
id|unregister_netdev
c_func
(paren
id|root_qec_dev-&gt;qes
(braket
id|i
)braket
op_member_access_from_pointer
id|dev
)paren
suffix:semicolon
id|sbus_iounmap
c_func
(paren
id|root_qec_dev-&gt;qes
(braket
id|i
)braket
op_member_access_from_pointer
id|qcregs
comma
id|CREG_REG_SIZE
)paren
suffix:semicolon
id|sbus_iounmap
c_func
(paren
id|root_qec_dev-&gt;qes
(braket
id|i
)braket
op_member_access_from_pointer
id|mregs
comma
id|MREGS_REG_SIZE
)paren
suffix:semicolon
id|sbus_free_consistent
c_func
(paren
id|root_qec_dev-&gt;qes
(braket
id|i
)braket
op_member_access_from_pointer
id|qe_sdev
comma
id|PAGE_SIZE
comma
id|root_qec_dev-&gt;qes
(braket
id|i
)braket
op_member_access_from_pointer
id|qe_block
comma
id|root_qec_dev-&gt;qes
(braket
id|i
)braket
op_member_access_from_pointer
id|qblock_dvma
)paren
suffix:semicolon
id|sbus_free_consistent
c_func
(paren
id|root_qec_dev-&gt;qes
(braket
id|i
)braket
op_member_access_from_pointer
id|qe_sdev
comma
r_sizeof
(paren
r_struct
id|sunqe_buffers
)paren
comma
id|root_qec_dev-&gt;qes
(braket
id|i
)braket
op_member_access_from_pointer
id|buffers
comma
id|root_qec_dev-&gt;qes
(braket
id|i
)braket
op_member_access_from_pointer
id|buffers_dvma
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|root_qec_dev-&gt;qes
(braket
id|i
)braket
op_member_access_from_pointer
id|dev
)paren
suffix:semicolon
)brace
id|free_irq
c_func
(paren
id|root_qec_dev-&gt;qec_sdev-&gt;irqs
(braket
l_int|0
)braket
comma
(paren
r_void
op_star
)paren
id|root_qec_dev
)paren
suffix:semicolon
id|sbus_iounmap
c_func
(paren
id|root_qec_dev-&gt;gregs
comma
id|GLOB_REG_SIZE
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|root_qec_dev
)paren
suffix:semicolon
id|root_qec_dev
op_assign
id|next_qec
suffix:semicolon
)brace
)brace
DECL|variable|qec_probe
id|module_init
c_func
(paren
id|qec_probe
)paren
suffix:semicolon
DECL|variable|qec_cleanup
id|module_exit
c_func
(paren
id|qec_cleanup
)paren
suffix:semicolon
eof
