multiline_comment|/*******************************************************************************&n; *&n; *  Linux ThunderLAN Driver&n; *&n; *  tlan.c&n; *  by James Banks&n; *&n; *  (C) 1997-1998 Caldera, Inc.&n; *  (C) 1998 James Banks&n; *  (C) 1999, 2000 Torben Mathiasen&n; *&n; *  This software may be used and distributed according to the terms&n; *  of the GNU Public License, incorporated herein by reference.&n; *&n; ** This file is best viewed/edited with columns&gt;=132.&n; *&n; ** Useful (if not required) reading:&n; *&n; *&t;&t;Texas Instruments, ThunderLAN Programmer&squot;s Guide,&n; *&t;&t;&t;TI Literature Number SPWU013A&n; *&t;&t;&t;available in PDF format from www.ti.com&n; *&t;&t;Level One, LXT901 and LXT970 Data Sheets&n; *&t;&t;&t;available in PDF format from www.level1.com&n; *&t;&t;National Semiconductor, DP83840A Data Sheet&n; *&t;&t;&t;available in PDF format from www.national.com&n; *&t;&t;Microchip Technology, 24C01A/02A/04A Data Sheet&n; *&t;&t;&t;available in PDF format from www.microchip.com&n; *&n; * Change History&n; *&n; *&t;Tigran Aivazian &lt;tigran@sco.com&gt;:&t;TLan_PciProbe() now uses&n; *&t;&t;&t;&t;&t;&t;new PCI BIOS interface.&n; *&t;Alan Cox&t;&lt;alan@redhat.com&gt;:&t;Fixed the out of memory&n; *&t;&t;&t;&t;&t;&t;handling.&n; *      &n; *&t;Torben Mathiasen &lt;torben.mathiasen@compaq.com&gt; New Maintainer!&n; *&n; *&t;v1.1 Dec 20, 1999    - Removed linux version checking&n; *&t;&t;&t;       Patch from Tigran Aivazian. &n; *&t;&t;&t;     - v1.1 includes Alan&squot;s SMP updates.&n; *&t;&t;&t;     - We still have problems on SMP though,&n; *&t;&t;&t;       but I&squot;m looking into that. &n; *&t;&t;&t;&n; *&t;v1.2 Jan 02, 2000    - Hopefully fixed the SMP deadlock.&n; *&t;&t;&t;     - Removed dependency of HZ being 100.&n; *&t;&t;&t;     - We now allow higher priority timers to &n; *&t;&t;&t;       overwrite timers like TLAN_TIMER_ACTIVITY&n; *&t;&t;&t;       Patch from John Cagle &lt;john.cagle@compaq.com&gt;.&n; *&t;&t;&t;     - Fixed a few compiler warnings.&n; *&n; *&t;v1.3 Feb 04, 2000    - Fixed the remaining HZ issues.&n; *&t;&t;&t;     - Removed call to pci_present(). &n; *&t;&t;&t;     - Removed SA_INTERRUPT flag from irq handler.&n; *&t;&t;&t;     - Added __init and __initdata to reduce resisdent &n; *&t;&t;&t;       code size.&n; *&t;&t;&t;     - Driver now uses module_init/module_exit.&n; *&t;&t;&t;     - Rewrote init_module and tlan_probe to&n; *&t;&t;&t;       share a lot more code. We now use tlan_probe&n; *&t;&t;&t;       with builtin and module driver.&n; *&t;&t;&t;     - Driver ported to new net API. &n; *&t;&t;&t;     - tlan.txt has been reworked to reflect current &n; *&t;&t;&t;       driver (almost)&n; *&t;&t;&t;     - Other minor stuff&n; *&n; *&t;v1.4 Feb 10, 2000    - Updated with more changes required after Dave&squot;s&n; *&t;                       network cleanup in 2.3.43pre7 (Tigran &amp; myself)&n; *&t;                     - Minor stuff.&n; *&n; *&t;v1.5 March 22, 2000  - Fixed another timer bug that would hang the driver&n; *&t;&t;&t;       if no cable/link were present.&n; *&t;&t;&t;     - Cosmetic changes.&n; *&t;&t;&t;     - TODO: Port completely to new PCI/DMA API&n; *&t;&t;&t;     &t;     Auto-Neg fallback.&n; *&n; * &t;v1.6 April 04, 2000  - Fixed driver support for kernel-parameters. Haven&squot;t&n; * &t;&t;&t;       tested it though, as the kernel support is currently &n; * &t;&t;&t;       broken (2.3.99p4p3).&n; * &t;&t;&t;     - Updated tlan.txt accordingly.&n; * &t;&t;&t;     - Adjusted minimum/maximum frame length.&n; * &t;&t;&t;     - There is now a TLAN website up at &n; * &t;&t;&t;       http://tlan.kernel.dk&n; *&n; * &t;v1.7 April 07, 2000  - Started to implement custom ioctls. Driver now&n; * &t;&t;&t;       reports PHY information when used with Donald&n; * &t;&t;&t;       Beckers userspace MII diagnostics utility.&n; *&n; * &t;v1.8 April 23, 2000  - Fixed support for forced speed/duplex settings.&n; * &t;&t;&t;     - Added link information to Auto-Neg and forced&n; * &t;&t;&t;       modes. When NIC operates with auto-neg the driver&n; * &t;&t;&t;       will report Link speed &amp; duplex modes as well as&n; * &t;&t;&t;       link partner abilities. When forced link is used,&n; * &t;&t;&t;       the driver will report status of the established&n; * &t;&t;&t;       link.&n; * &t;&t;&t;       Please read tlan.txt for additional information. &n; * &t;&t;&t;     - Removed call to check_region(), and used &n; * &t;&t;&t;       return value of request_region() instead.&n; *&t;&n; *&t;v1.8a May 28, 2000   - Minor updates.&n; *&n; *&t;v1.9 July 25, 2000   - Fixed a few remaining Full-Duplex issues.&n; *&t;                     - Updated with timer fixes from Andrew Morton.&n; *&t;                     - Fixed module race in TLan_Open.&n; *&t;                     - Added routine to monitor PHY status.&n; *&t;                     - Added activity led support for Proliant devices.&n; *&n; *&t;v1.10 Aug 30, 2000   - Added support for EISA based tlan controllers &n; *&t;&t;&t;       like the Compaq NetFlex3/E. &n; *&t;&t;&t;     - Rewrote tlan_probe to better handle multiple&n; *&t;&t;&t;       bus probes. Probing and device setup is now&n; *&t;&t;&t;       done through TLan_Probe and TLan_init_one. Actual&n; *&t;&t;&t;       hardware probe is done with kernel API and &n; *&t;&t;&t;       TLan_EisaProbe.&n; *&t;&t;&t;     - Adjusted debug information for probing.&n; *&t;&t;&t;     - Fixed bug that would cause general debug information &n; *&t;&t;&t;       to be printed after driver removal. &n; *&t;&t;&t;     - Added transmit timeout handling.&n; *&t;&t;&t;     - Fixed OOM return values in tlan_probe. &n; *&t;&t;&t;     - Fixed possible mem leak in tlan_exit &n; *&t;&t;&t;       (now tlan_remove_one).&n; *&t;&t;&t;     - Fixed timer bug in TLan_phyMonitor.&n; *&t;&t;&t;     - This driver version is alpha quality, please&n; *&t;&t;&t;       send me any bug issues you may encounter.&n; *&n; *&t;v1.11 Aug 31, 2000   - Do not try to register irq 0 if no irq line was &n; *&t;&t;&t;       set for EISA cards.&n; *&t;&t;&t;     - Added support for NetFlex3/E with nibble-rate&n; *&t;&t;&t;       10Base-T PHY. This is untestet as I haven&squot;t got&n; *&t;&t;&t;       one of these cards.&n; *&t;&t;&t;     - Fixed timer being added twice.&n; *&t;&t;&t;     - Disabled PhyMonitoring by default as this is&n; *&t;&t;&t;       work in progress. Define MONITOR to enable it.&n; *&t;&t;&t;     - Now we don&squot;t display link info with PHYs that&n; *&t;&t;&t;       doesn&squot;t support it (level1).&n; *&t;&t;&t;     - Incresed tx_timeout beacuse of auto-neg.&n; *&t;&t;&t;     - Adjusted timers for forced speeds.&n; *&n; *&t;v1.12 Oct 12, 2000   - Minor fixes (memleak, init, etc.)&n; *&n; *******************************************************************************/
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &quot;tlan.h&quot;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/ioport.h&gt;
macro_line|#include &lt;linux/pci.h&gt;
macro_line|#include &lt;linux/etherdevice.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;linux/spinlock.h&gt;
DECL|typedef|TLanIntVectorFunc
r_typedef
id|u32
(paren
id|TLanIntVectorFunc
)paren
(paren
r_struct
id|net_device
op_star
comma
id|u16
)paren
suffix:semicolon
multiline_comment|/* For removing EISA devices */
DECL|variable|TLan_Eisa_Devices
r_static
r_struct
id|net_device
op_star
id|TLan_Eisa_Devices
suffix:semicolon
DECL|variable|TLanDevicesInstalled
r_static
r_int
id|TLanDevicesInstalled
suffix:semicolon
multiline_comment|/* Force speed, duplex and aui settings */
DECL|variable|aui
r_static
r_int
id|aui
suffix:semicolon
DECL|variable|duplex
r_static
r_int
id|duplex
suffix:semicolon
DECL|variable|speed
r_static
r_int
id|speed
suffix:semicolon
id|MODULE_AUTHOR
c_func
(paren
l_string|&quot;Maintainer: Torben Mathiasen &lt;torben.mathiasen@compaq.com&gt;&quot;
)paren
suffix:semicolon
id|MODULE_DESCRIPTION
c_func
(paren
l_string|&quot;Driver for TI ThunderLAN based ethernet PCI adapters&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|aui
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|duplex
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|speed
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|debug
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|EXPORT_NO_SYMBOLS
suffix:semicolon
multiline_comment|/* Define this to enable Link beat monitoring */
DECL|macro|MONITOR
macro_line|#undef MONITOR
multiline_comment|/* Turn on debugging. See linux/Documentation/networking/tlan.txt for details */
DECL|variable|debug
r_static
r_int
id|debug
suffix:semicolon
DECL|variable|bbuf
r_static
r_int
id|bbuf
suffix:semicolon
DECL|variable|TLanPadBuffer
r_static
id|u8
op_star
id|TLanPadBuffer
suffix:semicolon
DECL|variable|TLanSignature
r_static
r_char
id|TLanSignature
(braket
)braket
op_assign
l_string|&quot;TLAN&quot;
suffix:semicolon
DECL|variable|tlan_banner
r_static
r_const
r_char
op_star
id|tlan_banner
op_assign
l_string|&quot;ThunderLAN driver v1.12&bslash;n&quot;
suffix:semicolon
DECL|variable|tlan_have_pci
r_static
r_int
id|tlan_have_pci
suffix:semicolon
DECL|variable|tlan_have_eisa
r_static
r_int
id|tlan_have_eisa
suffix:semicolon
DECL|variable|media
r_const
r_char
op_star
id|media
(braket
)braket
op_assign
(brace
l_string|&quot;10BaseT-HD &quot;
comma
l_string|&quot;10BaseT-FD &quot;
comma
l_string|&quot;100baseTx-HD &quot;
comma
l_string|&quot;100baseTx-FD&quot;
comma
l_string|&quot;100baseT4&quot;
comma
l_int|0
)brace
suffix:semicolon
DECL|variable|media_map
r_int
id|media_map
(braket
)braket
op_assign
(brace
l_int|0x0020
comma
l_int|0x0040
comma
l_int|0x0080
comma
l_int|0x0100
comma
l_int|0x0200
comma
)brace
suffix:semicolon
DECL|struct|board
r_static
r_struct
id|board
(brace
DECL|member|deviceLabel
r_const
r_char
op_star
id|deviceLabel
suffix:semicolon
DECL|member|flags
id|u32
id|flags
suffix:semicolon
DECL|member|addrOfs
id|u16
id|addrOfs
suffix:semicolon
DECL|variable|__devinitdata
)brace
id|board_info
(braket
)braket
id|__devinitdata
op_assign
(brace
(brace
l_string|&quot;Compaq Netelligent 10 T PCI UTP&quot;
comma
id|TLAN_ADAPTER_ACTIVITY_LED
comma
l_int|0x83
)brace
comma
(brace
l_string|&quot;Compaq Netelligent 10/100 TX PCI UTP&quot;
comma
id|TLAN_ADAPTER_ACTIVITY_LED
comma
l_int|0x83
)brace
comma
(brace
l_string|&quot;Compaq Integrated NetFlex-3/P&quot;
comma
id|TLAN_ADAPTER_NONE
comma
l_int|0x83
)brace
comma
(brace
l_string|&quot;Compaq NetFlex-3/P&quot;
comma
id|TLAN_ADAPTER_UNMANAGED_PHY
op_or
id|TLAN_ADAPTER_BIT_RATE_PHY
comma
l_int|0x83
)brace
comma
(brace
l_string|&quot;Compaq NetFlex-3/P&quot;
comma
id|TLAN_ADAPTER_NONE
comma
l_int|0x83
)brace
comma
(brace
l_string|&quot;Compaq Netelligent Integrated 10/100 TX UTP&quot;
comma
id|TLAN_ADAPTER_ACTIVITY_LED
comma
l_int|0x83
)brace
comma
(brace
l_string|&quot;Compaq Netelligent Dual 10/100 TX PCI UTP&quot;
comma
id|TLAN_ADAPTER_NONE
comma
l_int|0x83
)brace
comma
(brace
l_string|&quot;Compaq Netelligent 10/100 TX Embedded UTP&quot;
comma
id|TLAN_ADAPTER_NONE
comma
l_int|0x83
)brace
comma
(brace
l_string|&quot;Olicom OC-2183/2185&quot;
comma
id|TLAN_ADAPTER_USE_INTERN_10
comma
l_int|0x83
)brace
comma
(brace
l_string|&quot;Olicom OC-2325&quot;
comma
id|TLAN_ADAPTER_UNMANAGED_PHY
comma
l_int|0xF8
)brace
comma
(brace
l_string|&quot;Olicom OC-2326&quot;
comma
id|TLAN_ADAPTER_USE_INTERN_10
comma
l_int|0xF8
)brace
comma
(brace
l_string|&quot;Compaq Netelligent 10/100 TX UTP&quot;
comma
id|TLAN_ADAPTER_ACTIVITY_LED
comma
l_int|0x83
)brace
comma
(brace
l_string|&quot;Compaq Netelligent 10 T/2 PCI UTP/Coax&quot;
comma
id|TLAN_ADAPTER_NONE
comma
l_int|0x83
)brace
comma
(brace
l_string|&quot;Compaq NetFlex-3/E&quot;
comma
id|TLAN_ADAPTER_ACTIVITY_LED
op_or
multiline_comment|/* EISA card */
id|TLAN_ADAPTER_UNMANAGED_PHY
op_or
id|TLAN_ADAPTER_BIT_RATE_PHY
comma
l_int|0x83
)brace
comma
(brace
l_string|&quot;Compaq NetFlex-3/E&quot;
comma
id|TLAN_ADAPTER_ACTIVITY_LED
comma
l_int|0x83
)brace
comma
multiline_comment|/* EISA card */
)brace
suffix:semicolon
DECL|variable|__devinitdata
r_static
r_struct
id|pci_device_id
id|tlan_pci_tbl
(braket
)braket
id|__devinitdata
op_assign
(brace
(brace
id|PCI_VENDOR_ID_COMPAQ
comma
id|PCI_DEVICE_ID_NETELLIGENT_10
comma
id|PCI_ANY_ID
comma
id|PCI_ANY_ID
comma
l_int|0
comma
l_int|0
comma
l_int|0
)brace
comma
(brace
id|PCI_VENDOR_ID_COMPAQ
comma
id|PCI_DEVICE_ID_NETELLIGENT_10_100
comma
id|PCI_ANY_ID
comma
id|PCI_ANY_ID
comma
l_int|0
comma
l_int|0
comma
l_int|1
)brace
comma
(brace
id|PCI_VENDOR_ID_COMPAQ
comma
id|PCI_DEVICE_ID_NETFLEX_3P_INTEGRATED
comma
id|PCI_ANY_ID
comma
id|PCI_ANY_ID
comma
l_int|0
comma
l_int|0
comma
l_int|2
)brace
comma
(brace
id|PCI_VENDOR_ID_COMPAQ
comma
id|PCI_DEVICE_ID_NETFLEX_3P
comma
id|PCI_ANY_ID
comma
id|PCI_ANY_ID
comma
l_int|0
comma
l_int|0
comma
l_int|3
)brace
comma
(brace
id|PCI_VENDOR_ID_COMPAQ
comma
id|PCI_DEVICE_ID_NETFLEX_3P_BNC
comma
id|PCI_ANY_ID
comma
id|PCI_ANY_ID
comma
l_int|0
comma
l_int|0
comma
l_int|4
)brace
comma
(brace
id|PCI_VENDOR_ID_COMPAQ
comma
id|PCI_DEVICE_ID_NETELLIGENT_10_100_PROLIANT
comma
id|PCI_ANY_ID
comma
id|PCI_ANY_ID
comma
l_int|0
comma
l_int|0
comma
l_int|5
)brace
comma
(brace
id|PCI_VENDOR_ID_COMPAQ
comma
id|PCI_DEVICE_ID_NETELLIGENT_10_100_DUAL
comma
id|PCI_ANY_ID
comma
id|PCI_ANY_ID
comma
l_int|0
comma
l_int|0
comma
l_int|6
)brace
comma
(brace
id|PCI_VENDOR_ID_COMPAQ
comma
id|PCI_DEVICE_ID_DESKPRO_4000_5233MMX
comma
id|PCI_ANY_ID
comma
id|PCI_ANY_ID
comma
l_int|0
comma
l_int|0
comma
l_int|7
)brace
comma
(brace
id|PCI_VENDOR_ID_OLICOM
comma
id|PCI_DEVICE_ID_OLICOM_OC2183
comma
id|PCI_ANY_ID
comma
id|PCI_ANY_ID
comma
l_int|0
comma
l_int|0
comma
l_int|8
)brace
comma
(brace
id|PCI_VENDOR_ID_OLICOM
comma
id|PCI_DEVICE_ID_OLICOM_OC2325
comma
id|PCI_ANY_ID
comma
id|PCI_ANY_ID
comma
l_int|0
comma
l_int|0
comma
l_int|9
)brace
comma
(brace
id|PCI_VENDOR_ID_OLICOM
comma
id|PCI_DEVICE_ID_OLICOM_OC2326
comma
id|PCI_ANY_ID
comma
id|PCI_ANY_ID
comma
l_int|0
comma
l_int|0
comma
l_int|10
)brace
comma
(brace
id|PCI_VENDOR_ID_COMPAQ
comma
id|PCI_DEVICE_ID_NETELLIGENT_10_100_WS_5100
comma
id|PCI_ANY_ID
comma
id|PCI_ANY_ID
comma
l_int|0
comma
l_int|0
comma
l_int|11
)brace
comma
(brace
id|PCI_VENDOR_ID_COMPAQ
comma
id|PCI_DEVICE_ID_NETELLIGENT_10_T2
comma
id|PCI_ANY_ID
comma
id|PCI_ANY_ID
comma
l_int|0
comma
l_int|0
comma
l_int|12
)brace
comma
(brace
l_int|0
comma
)brace
)brace
suffix:semicolon
id|MODULE_DEVICE_TABLE
c_func
(paren
id|pci
comma
id|tlan_pci_tbl
)paren
suffix:semicolon
r_static
r_void
id|TLan_EisaProbe
c_func
(paren
r_void
)paren
suffix:semicolon
r_static
r_void
id|TLan_Eisa_Cleanup
c_func
(paren
r_void
)paren
suffix:semicolon
r_static
r_int
id|TLan_Init
c_func
(paren
r_struct
id|net_device
op_star
)paren
suffix:semicolon
r_static
r_int
id|TLan_Open
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_int
id|TLan_StartTx
c_func
(paren
r_struct
id|sk_buff
op_star
comma
r_struct
id|net_device
op_star
)paren
suffix:semicolon
r_static
r_void
id|TLan_HandleInterrupt
c_func
(paren
r_int
comma
r_void
op_star
comma
r_struct
id|pt_regs
op_star
)paren
suffix:semicolon
r_static
r_int
id|TLan_Close
c_func
(paren
r_struct
id|net_device
op_star
)paren
suffix:semicolon
r_static
r_struct
id|net_device_stats
op_star
id|TLan_GetStats
c_func
(paren
r_struct
id|net_device
op_star
)paren
suffix:semicolon
r_static
r_void
id|TLan_SetMulticastList
c_func
(paren
r_struct
id|net_device
op_star
)paren
suffix:semicolon
r_static
r_int
id|TLan_ioctl
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_struct
id|ifreq
op_star
id|rq
comma
r_int
id|cmd
)paren
suffix:semicolon
r_static
r_int
id|TLan_probe1
c_func
(paren
r_struct
id|pci_dev
op_star
id|pdev
comma
r_int
id|ioaddr
comma
r_int
id|irq
comma
r_int
id|rev
comma
r_const
r_struct
id|pci_device_id
op_star
id|ent
)paren
suffix:semicolon
r_static
r_void
id|TLan_tx_timeout
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_int
id|tlan_init_one
c_func
(paren
r_struct
id|pci_dev
op_star
id|pdev
comma
r_const
r_struct
id|pci_device_id
op_star
id|ent
)paren
suffix:semicolon
r_static
id|u32
id|TLan_HandleInvalid
c_func
(paren
r_struct
id|net_device
op_star
comma
id|u16
)paren
suffix:semicolon
r_static
id|u32
id|TLan_HandleTxEOF
c_func
(paren
r_struct
id|net_device
op_star
comma
id|u16
)paren
suffix:semicolon
r_static
id|u32
id|TLan_HandleStatOverflow
c_func
(paren
r_struct
id|net_device
op_star
comma
id|u16
)paren
suffix:semicolon
r_static
id|u32
id|TLan_HandleRxEOF
c_func
(paren
r_struct
id|net_device
op_star
comma
id|u16
)paren
suffix:semicolon
r_static
id|u32
id|TLan_HandleDummy
c_func
(paren
r_struct
id|net_device
op_star
comma
id|u16
)paren
suffix:semicolon
r_static
id|u32
id|TLan_HandleTxEOC
c_func
(paren
r_struct
id|net_device
op_star
comma
id|u16
)paren
suffix:semicolon
r_static
id|u32
id|TLan_HandleStatusCheck
c_func
(paren
r_struct
id|net_device
op_star
comma
id|u16
)paren
suffix:semicolon
r_static
id|u32
id|TLan_HandleRxEOC
c_func
(paren
r_struct
id|net_device
op_star
comma
id|u16
)paren
suffix:semicolon
r_static
r_void
id|TLan_Timer
c_func
(paren
r_int
r_int
)paren
suffix:semicolon
r_static
r_void
id|TLan_ResetLists
c_func
(paren
r_struct
id|net_device
op_star
)paren
suffix:semicolon
r_static
r_void
id|TLan_FreeLists
c_func
(paren
r_struct
id|net_device
op_star
)paren
suffix:semicolon
r_static
r_void
id|TLan_PrintDio
c_func
(paren
id|u16
)paren
suffix:semicolon
r_static
r_void
id|TLan_PrintList
c_func
(paren
id|TLanList
op_star
comma
r_char
op_star
comma
r_int
)paren
suffix:semicolon
r_static
r_void
id|TLan_ReadAndClearStats
c_func
(paren
r_struct
id|net_device
op_star
comma
r_int
)paren
suffix:semicolon
r_static
r_void
id|TLan_ResetAdapter
c_func
(paren
r_struct
id|net_device
op_star
)paren
suffix:semicolon
r_static
r_void
id|TLan_FinishReset
c_func
(paren
r_struct
id|net_device
op_star
)paren
suffix:semicolon
r_static
r_void
id|TLan_SetMac
c_func
(paren
r_struct
id|net_device
op_star
comma
r_int
id|areg
comma
r_char
op_star
id|mac
)paren
suffix:semicolon
r_static
r_void
id|TLan_PhyPrint
c_func
(paren
r_struct
id|net_device
op_star
)paren
suffix:semicolon
r_static
r_void
id|TLan_PhyDetect
c_func
(paren
r_struct
id|net_device
op_star
)paren
suffix:semicolon
r_static
r_void
id|TLan_PhyPowerDown
c_func
(paren
r_struct
id|net_device
op_star
)paren
suffix:semicolon
r_static
r_void
id|TLan_PhyPowerUp
c_func
(paren
r_struct
id|net_device
op_star
)paren
suffix:semicolon
r_static
r_void
id|TLan_PhyReset
c_func
(paren
r_struct
id|net_device
op_star
)paren
suffix:semicolon
r_static
r_void
id|TLan_PhyStartLink
c_func
(paren
r_struct
id|net_device
op_star
)paren
suffix:semicolon
r_static
r_void
id|TLan_PhyFinishAutoNeg
c_func
(paren
r_struct
id|net_device
op_star
)paren
suffix:semicolon
macro_line|#ifdef MONITOR
r_static
r_void
id|TLan_PhyMonitor
c_func
(paren
r_struct
id|net_device
op_star
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/*&n;static int&t;TLan_PhyNop( struct net_device * );&n;static int&t;TLan_PhyInternalCheck( struct net_device * );&n;static int&t;TLan_PhyInternalService( struct net_device * );&n;static int&t;TLan_PhyDp83840aCheck( struct net_device * );&n;*/
r_static
r_int
id|TLan_MiiReadReg
c_func
(paren
r_struct
id|net_device
op_star
comma
id|u16
comma
id|u16
comma
id|u16
op_star
)paren
suffix:semicolon
r_static
r_void
id|TLan_MiiSendData
c_func
(paren
id|u16
comma
id|u32
comma
r_int
)paren
suffix:semicolon
r_static
r_void
id|TLan_MiiSync
c_func
(paren
id|u16
)paren
suffix:semicolon
r_static
r_void
id|TLan_MiiWriteReg
c_func
(paren
r_struct
id|net_device
op_star
comma
id|u16
comma
id|u16
comma
id|u16
)paren
suffix:semicolon
r_static
r_void
id|TLan_EeSendStart
c_func
(paren
id|u16
)paren
suffix:semicolon
r_static
r_int
id|TLan_EeSendByte
c_func
(paren
id|u16
comma
id|u8
comma
r_int
)paren
suffix:semicolon
r_static
r_void
id|TLan_EeReceiveByte
c_func
(paren
id|u16
comma
id|u8
op_star
comma
r_int
)paren
suffix:semicolon
r_static
r_int
id|TLan_EeReadByte
c_func
(paren
r_struct
id|net_device
op_star
comma
id|u8
comma
id|u8
op_star
)paren
suffix:semicolon
DECL|variable|TLanIntVector
r_static
id|TLanIntVectorFunc
op_star
id|TLanIntVector
(braket
id|TLAN_INT_NUMBER_OF_INTS
)braket
op_assign
(brace
id|TLan_HandleInvalid
comma
id|TLan_HandleTxEOF
comma
id|TLan_HandleStatOverflow
comma
id|TLan_HandleRxEOF
comma
id|TLan_HandleDummy
comma
id|TLan_HandleTxEOC
comma
id|TLan_HandleStatusCheck
comma
id|TLan_HandleRxEOC
)brace
suffix:semicolon
r_static
r_inline
r_void
DECL|function|TLan_SetTimer
id|TLan_SetTimer
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
id|u32
id|ticks
comma
id|u32
id|type
)paren
(brace
id|TLanPrivateInfo
op_star
id|priv
op_assign
(paren
id|TLanPrivateInfo
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|priv-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|priv-&gt;timer.function
op_ne
l_int|NULL
op_logical_and
id|priv-&gt;timerType
op_ne
id|TLAN_TIMER_ACTIVITY
)paren
(brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|priv-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|priv-&gt;timer.function
op_assign
op_amp
id|TLan_Timer
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|priv-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|priv-&gt;timer.data
op_assign
(paren
r_int
r_int
)paren
id|dev
suffix:semicolon
id|priv-&gt;timerSetAt
op_assign
id|jiffies
suffix:semicolon
id|priv-&gt;timerType
op_assign
id|type
suffix:semicolon
id|mod_timer
c_func
(paren
op_amp
id|priv-&gt;timer
comma
id|jiffies
op_plus
id|ticks
)paren
suffix:semicolon
)brace
multiline_comment|/* TLan_SetTimer */
multiline_comment|/*****************************************************************************&n;******************************************************************************&n;&n;&t;ThunderLAN Driver Primary Functions&n;&n;&t;These functions are more or less common to all Linux network drivers.&n;&n;******************************************************************************&n;*****************************************************************************/
multiline_comment|/***************************************************************&n;&t; *&t;tlan_remove_one&n;&t; *&n;&t; *&t;Returns:&n;&t; *&t;&t;Nothing&n;&t; *&t;Parms:&n;&t; *&t;&t;None&n;&t; *&n;&t; *&t;Goes through the TLanDevices list and frees the device&n;&t; *&t;structs and memory associated with each device (lists&n;&t; *&t;and buffers).  It also ureserves the IO port regions&n;&t; *&t;associated with this device.&n;&t; *&n;&t; **************************************************************/
DECL|function|tlan_remove_one
r_static
r_void
id|__devexit
id|tlan_remove_one
c_func
(paren
r_struct
id|pci_dev
op_star
id|pdev
)paren
(brace
r_struct
id|net_device
op_star
id|dev
op_assign
id|pdev-&gt;driver_data
suffix:semicolon
id|TLanPrivateInfo
op_star
id|priv
op_assign
(paren
id|TLanPrivateInfo
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|unregister_netdev
c_func
(paren
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|priv-&gt;dmaStorage
)paren
(brace
id|kfree
c_func
(paren
id|priv-&gt;dmaStorage
)paren
suffix:semicolon
)brace
id|release_region
c_func
(paren
id|dev-&gt;base_addr
comma
l_int|0x10
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
DECL|variable|tlan_driver
r_static
r_struct
id|pci_driver
id|tlan_driver
op_assign
(brace
id|name
suffix:colon
l_string|&quot;tlan&quot;
comma
id|id_table
suffix:colon
id|tlan_pci_tbl
comma
id|probe
suffix:colon
id|tlan_init_one
comma
id|remove
suffix:colon
id|tlan_remove_one
comma
)brace
suffix:semicolon
DECL|function|tlan_probe
r_static
r_int
id|__init
id|tlan_probe
c_func
(paren
r_void
)paren
(brace
r_static
r_int
id|pad_allocated
op_assign
l_int|0
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s&quot;
comma
id|tlan_banner
)paren
suffix:semicolon
id|TLanPadBuffer
op_assign
(paren
id|u8
op_star
)paren
id|kmalloc
c_func
(paren
id|TLAN_MIN_FRAME_SIZE
comma
(paren
id|GFP_KERNEL
op_or
id|GFP_DMA
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|TLanPadBuffer
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;TLAN: Could not allocate memory for pad buffer.&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|memset
c_func
(paren
id|TLanPadBuffer
comma
l_int|0
comma
id|TLAN_MIN_FRAME_SIZE
)paren
suffix:semicolon
id|pad_allocated
op_assign
l_int|1
suffix:semicolon
id|TLAN_DBG
c_func
(paren
id|TLAN_DEBUG_PROBE
comma
l_string|&quot;Starting PCI Probe....&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* Use new style PCI probing. Now the kernel will&n;&t;   do most of this for us */
id|pci_module_init
c_func
(paren
op_amp
id|tlan_driver
)paren
suffix:semicolon
id|TLAN_DBG
c_func
(paren
id|TLAN_DEBUG_PROBE
comma
l_string|&quot;Starting EISA Probe....&bslash;n&quot;
)paren
suffix:semicolon
id|TLan_EisaProbe
c_func
(paren
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;TLAN: %d device%s installed, PCI: %d  EISA: %d&bslash;n&quot;
comma
id|TLanDevicesInstalled
comma
id|TLanDevicesInstalled
op_eq
l_int|1
ques
c_cond
l_string|&quot;&quot;
suffix:colon
l_string|&quot;s&quot;
comma
id|tlan_have_pci
comma
id|tlan_have_eisa
)paren
suffix:semicolon
r_return
(paren
(paren
id|TLanDevicesInstalled
OG
l_int|0
)paren
ques
c_cond
l_int|0
suffix:colon
op_minus
id|ENODEV
)paren
suffix:semicolon
)brace
DECL|function|tlan_init_one
r_static
r_int
id|__devinit
id|tlan_init_one
c_func
(paren
r_struct
id|pci_dev
op_star
id|pdev
comma
r_const
r_struct
id|pci_device_id
op_star
id|ent
)paren
(brace
r_return
id|TLan_probe1
c_func
(paren
id|pdev
comma
id|pci_resource_start
c_func
(paren
id|pdev
comma
l_int|0
)paren
comma
id|pdev-&gt;irq
comma
l_int|0
comma
id|ent
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;&t;***************************************************************&n;&t; *&t;tlan_probe1&n;&t; *&n;&t; *&t;Returns:&n;&t; *&t;&t;0 on success, error code on error&n;&t; *&t;Parms: &n;&t; *&t;&t;none&n;&t; *&n;&t; *&t;The name is lower case to fit in with all the rest of&n;&t; *&t;the netcard_probe names.  This function looks for &n;&t; *&t;another TLan based adapter, setting it up with the&n;&t; *&t;allocated device struct if one is found.&n;&t; *&t;tlan_probe has been ported to the new net API and&n;&t; *&t;now allocates its own device structure. This function&n;&t; *&t;is also used by modules.&n;&t; *&n;&t; **************************************************************/
DECL|function|TLan_probe1
r_static
r_int
id|__devinit
id|TLan_probe1
c_func
(paren
r_struct
id|pci_dev
op_star
id|pdev
comma
r_int
id|ioaddr
comma
r_int
id|irq
comma
r_int
id|rev
comma
r_const
r_struct
id|pci_device_id
op_star
id|ent
)paren
(brace
r_struct
id|net_device
op_star
id|dev
suffix:semicolon
id|TLanPrivateInfo
op_star
id|priv
suffix:semicolon
id|u8
id|pci_rev
suffix:semicolon
id|u16
id|device_id
suffix:semicolon
id|dev
op_assign
id|init_etherdev
c_func
(paren
l_int|NULL
comma
r_sizeof
(paren
id|TLanPrivateInfo
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dev
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;TLAN: Could not allocate memory for device.&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|SET_MODULE_OWNER
c_func
(paren
id|dev
)paren
suffix:semicolon
id|priv
op_assign
id|dev-&gt;priv
suffix:semicolon
id|dev-&gt;base_addr
op_assign
id|ioaddr
suffix:semicolon
id|dev-&gt;irq
op_assign
id|irq
suffix:semicolon
multiline_comment|/* Is this a PCI device? */
r_if
c_cond
(paren
id|pdev
)paren
(brace
id|priv-&gt;adapter
op_assign
op_amp
id|board_info
(braket
id|ent-&gt;driver_data
)braket
suffix:semicolon
r_if
c_cond
(paren
id|pci_enable_device
c_func
(paren
id|pdev
)paren
)paren
(brace
id|unregister_netdev
c_func
(paren
id|dev
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|dev
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|pci_read_config_byte
(paren
id|pdev
comma
id|PCI_REVISION_ID
comma
op_amp
id|pci_rev
)paren
suffix:semicolon
id|priv-&gt;adapterRev
op_assign
id|pci_rev
suffix:semicolon
id|pci_set_master
c_func
(paren
id|pdev
)paren
suffix:semicolon
id|pdev-&gt;driver_data
op_assign
id|dev
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* EISA card */
multiline_comment|/* This is a hack. We need to know which board structure&n;&t;&t; * is suited for this adapter */
id|device_id
op_assign
id|inw
c_func
(paren
id|ioaddr
op_plus
id|EISA_ID2
)paren
suffix:semicolon
id|priv-&gt;is_eisa
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|device_id
op_eq
l_int|0x20F1
)paren
(brace
id|priv-&gt;adapter
op_assign
op_amp
id|board_info
(braket
l_int|13
)braket
suffix:semicolon
multiline_comment|/* NetFlex-3/E */
id|priv-&gt;adapterRev
op_assign
l_int|23
suffix:semicolon
multiline_comment|/* TLAN 2.3 */
)brace
r_else
(brace
id|priv-&gt;adapter
op_assign
op_amp
id|board_info
(braket
l_int|14
)braket
suffix:semicolon
id|priv-&gt;adapterRev
op_assign
l_int|10
suffix:semicolon
multiline_comment|/* TLAN 1.0 */
)brace
)brace
multiline_comment|/* Kernel parameters */
r_if
c_cond
(paren
id|dev-&gt;mem_start
)paren
(brace
id|priv-&gt;aui
op_assign
id|dev-&gt;mem_start
op_amp
l_int|0x01
suffix:semicolon
id|priv-&gt;duplex
op_assign
(paren
(paren
id|dev-&gt;mem_start
op_amp
l_int|0x06
)paren
op_eq
l_int|0x06
)paren
ques
c_cond
l_int|0
suffix:colon
(paren
id|dev-&gt;mem_start
op_amp
l_int|0x06
)paren
op_rshift
l_int|1
suffix:semicolon
id|priv-&gt;speed
op_assign
(paren
(paren
id|dev-&gt;mem_start
op_amp
l_int|0x18
)paren
op_eq
l_int|0x18
)paren
ques
c_cond
l_int|0
suffix:colon
(paren
id|dev-&gt;mem_start
op_amp
l_int|0x18
)paren
op_rshift
l_int|3
suffix:semicolon
r_if
c_cond
(paren
id|priv-&gt;speed
op_eq
l_int|0x1
)paren
(brace
id|priv-&gt;speed
op_assign
id|TLAN_SPEED_10
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|priv-&gt;speed
op_eq
l_int|0x2
)paren
(brace
id|priv-&gt;speed
op_assign
id|TLAN_SPEED_100
suffix:semicolon
)brace
id|debug
op_assign
id|priv-&gt;debug
op_assign
id|dev-&gt;mem_end
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
(paren
id|duplex
op_ne
l_int|1
)paren
op_logical_and
(paren
id|duplex
op_ne
l_int|2
)paren
)paren
id|duplex
op_assign
l_int|0
suffix:semicolon
id|priv-&gt;duplex
op_assign
id|duplex
suffix:semicolon
r_if
c_cond
(paren
(paren
id|speed
op_ne
l_int|10
)paren
op_logical_and
(paren
id|speed
op_ne
l_int|100
)paren
)paren
id|speed
op_assign
l_int|0
suffix:semicolon
id|priv-&gt;aui
op_assign
id|aui
suffix:semicolon
id|priv-&gt;speed
op_assign
id|speed
suffix:semicolon
id|priv-&gt;debug
op_assign
id|debug
suffix:semicolon
)brace
id|spin_lock_init
c_func
(paren
op_amp
id|priv-&gt;lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|TLan_Init
c_func
(paren
id|dev
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;TLAN: Could not register device.&bslash;n&quot;
)paren
suffix:semicolon
id|unregister_netdev
c_func
(paren
id|dev
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|dev
)paren
suffix:semicolon
r_return
op_minus
id|EAGAIN
suffix:semicolon
)brace
r_else
(brace
id|TLanDevicesInstalled
op_increment
suffix:semicolon
multiline_comment|/* pdev is NULL if this is an EISA device */
r_if
c_cond
(paren
id|pdev
)paren
id|tlan_have_pci
op_increment
suffix:semicolon
r_else
(brace
id|priv-&gt;nextDevice
op_assign
id|TLan_Eisa_Devices
suffix:semicolon
id|TLan_Eisa_Devices
op_assign
id|dev
suffix:semicolon
id|tlan_have_eisa
op_increment
suffix:semicolon
)brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;TLAN: %s irq=%2d, io=%04x, %s, Rev. %d&bslash;n&quot;
comma
id|dev-&gt;name
comma
(paren
r_int
)paren
id|dev-&gt;irq
comma
(paren
r_int
)paren
id|dev-&gt;base_addr
comma
id|priv-&gt;adapter-&gt;deviceLabel
comma
id|priv-&gt;adapterRev
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
)brace
DECL|function|TLan_Eisa_Cleanup
r_static
r_void
id|TLan_Eisa_Cleanup
c_func
(paren
r_void
)paren
(brace
r_struct
id|net_device
op_star
id|dev
suffix:semicolon
id|TLanPrivateInfo
op_star
id|priv
suffix:semicolon
r_while
c_loop
(paren
id|tlan_have_eisa
)paren
(brace
id|dev
op_assign
id|TLan_Eisa_Devices
suffix:semicolon
id|priv
op_assign
(paren
id|TLanPrivateInfo
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_if
c_cond
(paren
id|priv-&gt;dmaStorage
)paren
(brace
id|kfree
c_func
(paren
id|priv-&gt;dmaStorage
)paren
suffix:semicolon
)brace
id|release_region
c_func
(paren
id|dev-&gt;base_addr
comma
l_int|0x10
)paren
suffix:semicolon
id|unregister_netdev
c_func
(paren
id|dev
)paren
suffix:semicolon
id|TLan_Eisa_Devices
op_assign
id|priv-&gt;nextDevice
suffix:semicolon
id|kfree
c_func
(paren
id|dev
)paren
suffix:semicolon
id|tlan_have_eisa
op_decrement
suffix:semicolon
)brace
)brace
DECL|function|tlan_exit
r_static
r_void
id|__exit
id|tlan_exit
c_func
(paren
r_void
)paren
(brace
r_if
c_cond
(paren
id|tlan_have_pci
)paren
id|pci_unregister_driver
c_func
(paren
op_amp
id|tlan_driver
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tlan_have_eisa
)paren
id|TLan_Eisa_Cleanup
c_func
(paren
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|TLanPadBuffer
)paren
suffix:semicolon
)brace
multiline_comment|/* Module loading/unloading */
DECL|variable|tlan_probe
id|module_init
c_func
(paren
id|tlan_probe
)paren
suffix:semicolon
DECL|variable|tlan_exit
id|module_exit
c_func
(paren
id|tlan_exit
)paren
suffix:semicolon
multiline_comment|/**************************************************************&n;&t; * &t;TLan_EisaProbe&n;&t; *&n;&t; *  &t;Returns: 0 on success, 1 otherwise&n;&t; *&n;&t; *  &t;Parms:&t; None&n;&t; *&n;&t; *&n;&t; *  &t;This functions probes for EISA devices and calls &n;&t; *  &t;TLan_probe1 when one is found. &n;&t; *&n;&t; *************************************************************/
DECL|function|TLan_EisaProbe
r_static
r_void
id|__init
id|TLan_EisaProbe
(paren
r_void
)paren
(brace
r_int
id|ioaddr
suffix:semicolon
r_int
id|rc
op_assign
op_minus
id|ENODEV
suffix:semicolon
r_int
id|irq
suffix:semicolon
id|u16
id|device_id
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|EISA_bus
)paren
(brace
id|TLAN_DBG
c_func
(paren
id|TLAN_DEBUG_PROBE
comma
l_string|&quot;No EISA bus present&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/* Loop through all slots of the EISA bus */
r_for
c_loop
(paren
id|ioaddr
op_assign
l_int|0x1000
suffix:semicolon
id|ioaddr
OL
l_int|0x9000
suffix:semicolon
id|ioaddr
op_add_assign
l_int|0x1000
)paren
(brace
id|TLAN_DBG
c_func
(paren
id|TLAN_DEBUG_PROBE
comma
l_string|&quot;EISA_ID 0x%4x: 0x%4x&bslash;n&quot;
comma
(paren
r_int
)paren
id|ioaddr
op_plus
l_int|0xC80
comma
id|inw
c_func
(paren
id|ioaddr
op_plus
id|EISA_ID
)paren
)paren
suffix:semicolon
id|TLAN_DBG
c_func
(paren
id|TLAN_DEBUG_PROBE
comma
l_string|&quot;EISA_ID 0x%4x: 0x%4x&bslash;n&quot;
comma
(paren
r_int
)paren
id|ioaddr
op_plus
l_int|0xC82
comma
id|inw
c_func
(paren
id|ioaddr
op_plus
id|EISA_ID2
)paren
)paren
suffix:semicolon
id|TLAN_DBG
c_func
(paren
id|TLAN_DEBUG_PROBE
comma
l_string|&quot;Probing for EISA adapter at IO: 0x%4x : &quot;
comma
(paren
r_int
)paren
id|ioaddr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|request_region
c_func
(paren
id|ioaddr
comma
l_int|0x10
comma
id|TLanSignature
)paren
op_eq
l_int|NULL
)paren
r_goto
id|out
suffix:semicolon
r_if
c_cond
(paren
id|inw
c_func
(paren
id|ioaddr
op_plus
id|EISA_ID
)paren
op_ne
l_int|0x110E
)paren
(brace
id|release_region
c_func
(paren
id|ioaddr
comma
l_int|0x10
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|device_id
op_assign
id|inw
c_func
(paren
id|ioaddr
op_plus
id|EISA_ID2
)paren
suffix:semicolon
r_if
c_cond
(paren
id|device_id
op_ne
l_int|0x20F1
op_logical_and
id|device_id
op_ne
l_int|0x40F1
)paren
(brace
id|release_region
(paren
id|ioaddr
comma
l_int|0x10
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
r_if
c_cond
(paren
id|inb
c_func
(paren
id|ioaddr
op_plus
id|EISA_CR
)paren
op_ne
l_int|0x1
)paren
(brace
multiline_comment|/* Check if adapter is enabled */
id|release_region
(paren
id|ioaddr
comma
l_int|0x10
)paren
suffix:semicolon
r_goto
id|out2
suffix:semicolon
)brace
r_if
c_cond
(paren
id|debug
op_eq
l_int|0x10
)paren
id|printk
c_func
(paren
l_string|&quot;Found one&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* Get irq from board */
r_switch
c_cond
(paren
id|inb
c_func
(paren
id|ioaddr
op_plus
l_int|0xCC0
)paren
)paren
(brace
r_case
(paren
l_int|0x10
)paren
suffix:colon
id|irq
op_assign
l_int|5
suffix:semicolon
r_break
suffix:semicolon
r_case
(paren
l_int|0x20
)paren
suffix:colon
id|irq
op_assign
l_int|9
suffix:semicolon
r_break
suffix:semicolon
r_case
(paren
l_int|0x40
)paren
suffix:colon
id|irq
op_assign
l_int|10
suffix:semicolon
r_break
suffix:semicolon
r_case
(paren
l_int|0x80
)paren
suffix:colon
id|irq
op_assign
l_int|11
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
r_goto
id|out
suffix:semicolon
)brace
multiline_comment|/* Setup the newly found eisa adapter */
id|rc
op_assign
id|TLan_probe1
c_func
(paren
l_int|NULL
comma
id|ioaddr
comma
id|irq
comma
l_int|12
comma
l_int|NULL
)paren
suffix:semicolon
r_continue
suffix:semicolon
id|out
suffix:colon
r_if
c_cond
(paren
id|debug
op_eq
l_int|0x10
)paren
id|printk
c_func
(paren
l_string|&quot;None found&bslash;n&quot;
)paren
suffix:semicolon
r_continue
suffix:semicolon
id|out2
suffix:colon
r_if
c_cond
(paren
id|debug
op_eq
l_int|0x10
)paren
id|printk
c_func
(paren
l_string|&quot;Card found but it is not enabled, skipping&bslash;n&quot;
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
)brace
multiline_comment|/* TLan_EisaProbe */
multiline_comment|/***************************************************************&n;&t; *&t;TLan_Init&n;&t; *&n;&t; *&t;Returns:&n;&t; *&t;&t;0 on success, error code otherwise.&n;&t; *&t;Parms:&n;&t; *&t;&t;dev&t;The structure of the device to be&n;&t; *&t;&t;&t;init&squot;ed.&n;&t; *&n;&t; *&t;This function completes the initialization of the&n;&t; *&t;device structure and driver.  It reserves the IO&n;&t; *&t;addresses, allocates memory for the lists and bounce&n;&t; *&t;buffers, retrieves the MAC address from the eeprom&n;&t; *&t;and assignes the device&squot;s methods.&n;&t; *&t;&n;&t; **************************************************************/
DECL|function|TLan_Init
r_static
r_int
id|TLan_Init
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_int
id|dma_size
suffix:semicolon
r_int
id|err
suffix:semicolon
r_int
id|i
suffix:semicolon
id|TLanPrivateInfo
op_star
id|priv
suffix:semicolon
id|priv
op_assign
(paren
id|TLanPrivateInfo
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|priv-&gt;is_eisa
)paren
multiline_comment|/* EISA devices have already requested IO */
r_if
c_cond
(paren
op_logical_neg
id|request_region
c_func
(paren
id|dev-&gt;base_addr
comma
l_int|0x10
comma
id|TLanSignature
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;TLAN: %s: IO port region 0x%lx size 0x%x in use.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|dev-&gt;base_addr
comma
l_int|0x10
)paren
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
r_if
c_cond
(paren
id|bbuf
)paren
(brace
id|dma_size
op_assign
(paren
id|TLAN_NUM_RX_LISTS
op_plus
id|TLAN_NUM_TX_LISTS
)paren
op_star
(paren
r_sizeof
(paren
id|TLanList
)paren
op_plus
id|TLAN_MAX_FRAME_SIZE
)paren
suffix:semicolon
)brace
r_else
(brace
id|dma_size
op_assign
(paren
id|TLAN_NUM_RX_LISTS
op_plus
id|TLAN_NUM_TX_LISTS
)paren
op_star
(paren
r_sizeof
(paren
id|TLanList
)paren
)paren
suffix:semicolon
)brace
id|priv-&gt;dmaStorage
op_assign
id|kmalloc
c_func
(paren
id|dma_size
comma
id|GFP_KERNEL
op_or
id|GFP_DMA
)paren
suffix:semicolon
r_if
c_cond
(paren
id|priv-&gt;dmaStorage
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;TLAN:  Could not allocate lists and buffers for %s.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|memset
c_func
(paren
id|priv-&gt;dmaStorage
comma
l_int|0
comma
id|dma_size
)paren
suffix:semicolon
id|priv-&gt;rxList
op_assign
(paren
id|TLanList
op_star
)paren
(paren
(paren
(paren
(paren
id|u32
)paren
id|priv-&gt;dmaStorage
)paren
op_plus
l_int|7
)paren
op_amp
l_int|0xFFFFFFF8
)paren
suffix:semicolon
id|priv-&gt;txList
op_assign
id|priv-&gt;rxList
op_plus
id|TLAN_NUM_RX_LISTS
suffix:semicolon
r_if
c_cond
(paren
id|bbuf
)paren
(brace
id|priv-&gt;rxBuffer
op_assign
(paren
id|u8
op_star
)paren
(paren
id|priv-&gt;txList
op_plus
id|TLAN_NUM_TX_LISTS
)paren
suffix:semicolon
id|priv-&gt;txBuffer
op_assign
id|priv-&gt;rxBuffer
op_plus
(paren
id|TLAN_NUM_RX_LISTS
op_star
id|TLAN_MAX_FRAME_SIZE
)paren
suffix:semicolon
)brace
id|err
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|6
suffix:semicolon
id|i
op_increment
)paren
id|err
op_or_assign
id|TLan_EeReadByte
c_func
(paren
id|dev
comma
(paren
id|u8
)paren
id|priv-&gt;adapter-&gt;addrOfs
op_plus
id|i
comma
(paren
id|u8
op_star
)paren
op_amp
id|dev-&gt;dev_addr
(braket
id|i
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;TLAN: %s: Error reading MAC from eeprom: %d&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|err
)paren
suffix:semicolon
)brace
id|dev-&gt;addr_len
op_assign
l_int|6
suffix:semicolon
multiline_comment|/* Device methods */
id|dev-&gt;open
op_assign
op_amp
id|TLan_Open
suffix:semicolon
id|dev-&gt;hard_start_xmit
op_assign
op_amp
id|TLan_StartTx
suffix:semicolon
id|dev-&gt;stop
op_assign
op_amp
id|TLan_Close
suffix:semicolon
id|dev-&gt;get_stats
op_assign
op_amp
id|TLan_GetStats
suffix:semicolon
id|dev-&gt;set_multicast_list
op_assign
op_amp
id|TLan_SetMulticastList
suffix:semicolon
id|dev-&gt;do_ioctl
op_assign
op_amp
id|TLan_ioctl
suffix:semicolon
id|dev-&gt;tx_timeout
op_assign
op_amp
id|TLan_tx_timeout
suffix:semicolon
id|dev-&gt;watchdog_timeo
op_assign
id|TX_TIMEOUT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* TLan_Init */
multiline_comment|/***************************************************************&n;&t; *&t;TLan_Open&n;&t; *&n;&t; *&t;Returns:&n;&t; *&t;&t;0 on success, error code otherwise.&n;&t; *&t;Parms:&n;&t; *&t;&t;dev&t;Structure of device to be opened.&n;&t; *&n;&t; *&t;This routine puts the driver and TLAN adapter in a&n;&t; *&t;state where it is ready to send and receive packets.&n;&t; *&t;It allocates the IRQ, resets and brings the adapter&n;&t; *&t;out of reset, and allows interrupts.  It also delays&n;&t; *&t;the startup for autonegotiation or sends a Rx GO&n;&t; *&t;command to the adapter, as appropriate.&n;&t; *&n;&t; **************************************************************/
DECL|function|TLan_Open
r_static
r_int
id|TLan_Open
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
id|TLanPrivateInfo
op_star
id|priv
op_assign
(paren
id|TLanPrivateInfo
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_int
id|err
suffix:semicolon
id|priv-&gt;tlanRev
op_assign
id|TLan_DioRead8
c_func
(paren
id|dev-&gt;base_addr
comma
id|TLAN_DEF_REVISION
)paren
suffix:semicolon
id|err
op_assign
id|request_irq
c_func
(paren
id|dev-&gt;irq
comma
id|TLan_HandleInterrupt
comma
id|SA_SHIRQ
comma
id|TLanSignature
comma
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;TLAN:  Cannot open %s because IRQ %d is already in use.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|dev-&gt;irq
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
id|init_timer
c_func
(paren
op_amp
id|priv-&gt;timer
)paren
suffix:semicolon
id|netif_start_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
multiline_comment|/* NOTE: It might not be necessary to read the stats before a&n;&t;&t;&t; reset if you don&squot;t care what the values are.&n;&t;*/
id|TLan_ResetLists
c_func
(paren
id|dev
)paren
suffix:semicolon
id|TLan_ReadAndClearStats
c_func
(paren
id|dev
comma
id|TLAN_IGNORE
)paren
suffix:semicolon
id|TLan_ResetAdapter
c_func
(paren
id|dev
)paren
suffix:semicolon
id|TLAN_DBG
c_func
(paren
id|TLAN_DEBUG_GNRL
comma
l_string|&quot;%s: Opened.  TLAN Chip Rev: %x&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|priv-&gt;tlanRev
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* TLan_Open */
multiline_comment|/**************************************************************&n;&t; *&t;TLan_ioctl&n;&t; *&t;&n;&t; *&t;Returns:&n;&t; *&t;&t;0 on success, error code otherwise&n;&t; *&t;Params:&n;&t; *&t;&t;dev&t;structure of device to receive ioctl.&n;&t; *&t;&t;&n;&t; *&t;&t;rq&t;ifreq structure to hold userspace data.&n;&t; *&n;&t; *&t;&t;cmd&t;ioctl command.&n;&t; *&n;&t; *&n;&t; *************************************************************/
DECL|function|TLan_ioctl
r_static
r_int
id|TLan_ioctl
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_struct
id|ifreq
op_star
id|rq
comma
r_int
id|cmd
)paren
(brace
id|TLanPrivateInfo
op_star
id|priv
op_assign
(paren
id|TLanPrivateInfo
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|u16
op_star
id|data
op_assign
(paren
id|u16
op_star
)paren
op_amp
id|rq-&gt;ifr_data
suffix:semicolon
id|u32
id|phy
op_assign
id|priv-&gt;phy
(braket
id|priv-&gt;phyNum
)braket
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|priv-&gt;phyOnline
)paren
r_return
op_minus
id|EAGAIN
suffix:semicolon
r_switch
c_cond
(paren
id|cmd
)paren
(brace
r_case
id|SIOCDEVPRIVATE
suffix:colon
id|data
(braket
l_int|0
)braket
op_assign
id|phy
suffix:semicolon
r_case
id|SIOCDEVPRIVATE
op_plus
l_int|1
suffix:colon
multiline_comment|/* Read MII register */
id|TLan_MiiReadReg
c_func
(paren
id|dev
comma
id|data
(braket
l_int|0
)braket
comma
id|data
(braket
l_int|1
)braket
comma
op_amp
id|data
(braket
l_int|3
)braket
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
r_case
id|SIOCDEVPRIVATE
op_plus
l_int|2
suffix:colon
multiline_comment|/* Write MII register */
r_if
c_cond
(paren
op_logical_neg
id|capable
c_func
(paren
id|CAP_NET_ADMIN
)paren
)paren
r_return
op_minus
id|EPERM
suffix:semicolon
id|TLan_MiiWriteReg
c_func
(paren
id|dev
comma
id|data
(braket
l_int|0
)braket
comma
id|data
(braket
l_int|1
)braket
comma
id|data
(braket
l_int|2
)braket
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
r_default
suffix:colon
r_return
op_minus
id|EOPNOTSUPP
suffix:semicolon
)brace
)brace
multiline_comment|/* tlan_ioctl */
multiline_comment|/***************************************************************&n;&t; * &t;TLan_tx_timeout&n;&t; *&n;&t; * &t;Returns: nothing&n;&t; *&n;&t; * &t;Params:&n;&t; * &t;&t;dev&t;structure of device which timed out &n;&t; * &t;&t;&t;during transmit.&n;&t; *&n;&t; **************************************************************/
DECL|function|TLan_tx_timeout
r_static
r_void
id|TLan_tx_timeout
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
id|TLAN_DBG
c_func
(paren
id|TLAN_DEBUG_GNRL
comma
l_string|&quot;%s: Transmit timed out.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
multiline_comment|/* Ok so we timed out, lets see what we can do about it...*/
id|TLan_ResetLists
c_func
(paren
id|dev
)paren
suffix:semicolon
id|TLan_ReadAndClearStats
c_func
(paren
id|dev
comma
id|TLAN_IGNORE
)paren
suffix:semicolon
id|TLan_ResetAdapter
c_func
(paren
id|dev
)paren
suffix:semicolon
id|dev-&gt;trans_start
op_assign
id|jiffies
suffix:semicolon
id|netif_wake_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
multiline_comment|/***************************************************************&n;&t; *&t;TLan_StartTx&n;&t; *  &n;&t; *&t;Returns:&n;&t; *&t;&t;0 on success, non-zero on failure.&n;&t; *&t;Parms:&n;&t; *&t;&t;skb&t;A pointer to the sk_buff containing the&n;&t; *&t;&t;&t;frame to be sent.&n;&t; *&t;&t;dev&t;The device to send the data on.&n;&t; *&n;&t; *&t;This function adds a frame to the Tx list to be sent&n;&t; *&t;ASAP.  First it&t;verifies that the adapter is ready and&n;&t; *&t;there is room in the queue.  Then it sets up the next&n;&t; *&t;available list, copies the frame to the&t;corresponding&n;&t; *&t;buffer.  If the adapter Tx channel is idle, it gives&n;&t; *&t;the adapter a Tx Go command on the list, otherwise it&n;&t; *&t;sets the forward address of the previous list to point&n;&t; *&t;to this one.  Then it frees the sk_buff.&n;&t; *&n;&t; **************************************************************/
DECL|function|TLan_StartTx
r_static
r_int
id|TLan_StartTx
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|net_device
op_star
id|dev
)paren
(brace
id|TLanPrivateInfo
op_star
id|priv
op_assign
(paren
id|TLanPrivateInfo
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|TLanList
op_star
id|tail_list
suffix:semicolon
id|u8
op_star
id|tail_buffer
suffix:semicolon
r_int
id|pad
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|priv-&gt;phyOnline
)paren
(brace
id|TLAN_DBG
c_func
(paren
id|TLAN_DEBUG_TX
comma
l_string|&quot;TRANSMIT:  %s PHY is not ready&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|dev_kfree_skb_any
c_func
(paren
id|skb
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|tail_list
op_assign
id|priv-&gt;txList
op_plus
id|priv-&gt;txTail
suffix:semicolon
r_if
c_cond
(paren
id|tail_list-&gt;cStat
op_ne
id|TLAN_CSTAT_UNUSED
)paren
(brace
id|TLAN_DBG
c_func
(paren
id|TLAN_DEBUG_TX
comma
l_string|&quot;TRANSMIT:  %s is busy (Head=%d Tail=%d)&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|priv-&gt;txHead
comma
id|priv-&gt;txTail
)paren
suffix:semicolon
id|netif_stop_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
id|priv-&gt;txBusyCount
op_increment
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
id|tail_list-&gt;forward
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|bbuf
)paren
(brace
id|tail_buffer
op_assign
id|priv-&gt;txBuffer
op_plus
(paren
id|priv-&gt;txTail
op_star
id|TLAN_MAX_FRAME_SIZE
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|tail_buffer
comma
id|skb-&gt;data
comma
id|skb-&gt;len
)paren
suffix:semicolon
)brace
r_else
(brace
id|tail_list-&gt;buffer
(braket
l_int|0
)braket
dot
id|address
op_assign
id|virt_to_bus
c_func
(paren
id|skb-&gt;data
)paren
suffix:semicolon
id|tail_list-&gt;buffer
(braket
l_int|9
)braket
dot
id|address
op_assign
(paren
id|u32
)paren
id|skb
suffix:semicolon
)brace
id|pad
op_assign
id|TLAN_MIN_FRAME_SIZE
op_minus
id|skb-&gt;len
suffix:semicolon
r_if
c_cond
(paren
id|pad
OG
l_int|0
)paren
(brace
id|tail_list-&gt;frameSize
op_assign
(paren
id|u16
)paren
id|skb-&gt;len
op_plus
id|pad
suffix:semicolon
id|tail_list-&gt;buffer
(braket
l_int|0
)braket
dot
id|count
op_assign
(paren
id|u32
)paren
id|skb-&gt;len
suffix:semicolon
id|tail_list-&gt;buffer
(braket
l_int|1
)braket
dot
id|count
op_assign
id|TLAN_LAST_BUFFER
op_or
(paren
id|u32
)paren
id|pad
suffix:semicolon
id|tail_list-&gt;buffer
(braket
l_int|1
)braket
dot
id|address
op_assign
id|virt_to_bus
c_func
(paren
id|TLanPadBuffer
)paren
suffix:semicolon
)brace
r_else
(brace
id|tail_list-&gt;frameSize
op_assign
(paren
id|u16
)paren
id|skb-&gt;len
suffix:semicolon
id|tail_list-&gt;buffer
(braket
l_int|0
)braket
dot
id|count
op_assign
id|TLAN_LAST_BUFFER
op_or
(paren
id|u32
)paren
id|skb-&gt;len
suffix:semicolon
id|tail_list-&gt;buffer
(braket
l_int|1
)braket
dot
id|count
op_assign
l_int|0
suffix:semicolon
id|tail_list-&gt;buffer
(braket
l_int|1
)braket
dot
id|address
op_assign
l_int|0
suffix:semicolon
)brace
id|spin_lock_irqsave
c_func
(paren
op_amp
id|priv-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|tail_list-&gt;cStat
op_assign
id|TLAN_CSTAT_READY
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|priv-&gt;txInProgress
)paren
(brace
id|priv-&gt;txInProgress
op_assign
l_int|1
suffix:semicolon
id|outw
c_func
(paren
l_int|0x4
comma
id|dev-&gt;base_addr
op_plus
id|TLAN_HOST_INT
)paren
suffix:semicolon
id|TLAN_DBG
c_func
(paren
id|TLAN_DEBUG_TX
comma
l_string|&quot;TRANSMIT:  Starting TX on buffer %d&bslash;n&quot;
comma
id|priv-&gt;txTail
)paren
suffix:semicolon
id|outl
c_func
(paren
id|virt_to_bus
c_func
(paren
id|tail_list
)paren
comma
id|dev-&gt;base_addr
op_plus
id|TLAN_CH_PARM
)paren
suffix:semicolon
id|outl
c_func
(paren
id|TLAN_HC_GO
op_or
id|TLAN_HC_ACK
comma
id|dev-&gt;base_addr
op_plus
id|TLAN_HOST_CMD
)paren
suffix:semicolon
)brace
r_else
(brace
id|TLAN_DBG
c_func
(paren
id|TLAN_DEBUG_TX
comma
l_string|&quot;TRANSMIT:  Adding buffer %d to TX channel&bslash;n&quot;
comma
id|priv-&gt;txTail
)paren
suffix:semicolon
r_if
c_cond
(paren
id|priv-&gt;txTail
op_eq
l_int|0
)paren
(brace
(paren
id|priv-&gt;txList
op_plus
(paren
id|TLAN_NUM_TX_LISTS
op_minus
l_int|1
)paren
)paren
op_member_access_from_pointer
id|forward
op_assign
id|virt_to_bus
c_func
(paren
id|tail_list
)paren
suffix:semicolon
)brace
r_else
(brace
(paren
id|priv-&gt;txList
op_plus
(paren
id|priv-&gt;txTail
op_minus
l_int|1
)paren
)paren
op_member_access_from_pointer
id|forward
op_assign
id|virt_to_bus
c_func
(paren
id|tail_list
)paren
suffix:semicolon
)brace
)brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|priv-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|CIRC_INC
c_func
(paren
id|priv-&gt;txTail
comma
id|TLAN_NUM_TX_LISTS
)paren
suffix:semicolon
r_if
c_cond
(paren
id|bbuf
)paren
id|dev_kfree_skb_any
c_func
(paren
id|skb
)paren
suffix:semicolon
id|dev-&gt;trans_start
op_assign
id|jiffies
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* TLan_StartTx */
multiline_comment|/***************************************************************&n;&t; *&t;TLan_HandleInterrupt&n;&t; *  &n;&t; *&t;Returns:&t;&n;&t; *&t;&t;Nothing&n;&t; *&t;Parms:&n;&t; *&t;&t;irq&t;The line on which the interrupt&n;&t; *&t;&t;&t;occurred.&n;&t; *&t;&t;dev_id&t;A pointer to the device assigned to&n;&t; *&t;&t;&t;this irq line.&n;&t; *&t;&t;regs&t;???&n;&t; *&n;&t; *&t;This function handles an interrupt generated by its&n;&t; *&t;assigned TLAN adapter.  The function deactivates&n;&t; *&t;interrupts on its adapter, records the type of&n;&t; *&t;interrupt, executes the appropriate subhandler, and&n;&t; *&t;acknowdges the interrupt to the adapter (thus&n;&t; *&t;re-enabling adapter interrupts.&n;&t; *&n;&t; **************************************************************/
DECL|function|TLan_HandleInterrupt
r_static
r_void
id|TLan_HandleInterrupt
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
id|u32
id|ack
suffix:semicolon
r_struct
id|net_device
op_star
id|dev
suffix:semicolon
id|u32
id|host_cmd
suffix:semicolon
id|u16
id|host_int
suffix:semicolon
r_int
id|type
suffix:semicolon
id|TLanPrivateInfo
op_star
id|priv
suffix:semicolon
id|dev
op_assign
(paren
r_struct
id|net_device
op_star
)paren
id|dev_id
suffix:semicolon
id|priv
op_assign
(paren
id|TLanPrivateInfo
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|priv-&gt;lock
)paren
suffix:semicolon
id|host_int
op_assign
id|inw
c_func
(paren
id|dev-&gt;base_addr
op_plus
id|TLAN_HOST_INT
)paren
suffix:semicolon
id|outw
c_func
(paren
id|host_int
comma
id|dev-&gt;base_addr
op_plus
id|TLAN_HOST_INT
)paren
suffix:semicolon
id|type
op_assign
(paren
id|host_int
op_amp
id|TLAN_HI_IT_MASK
)paren
op_rshift
l_int|2
suffix:semicolon
id|ack
op_assign
id|TLanIntVector
(braket
id|type
)braket
(paren
id|dev
comma
id|host_int
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ack
)paren
(brace
id|host_cmd
op_assign
id|TLAN_HC_ACK
op_or
id|ack
op_or
(paren
id|type
op_lshift
l_int|18
)paren
suffix:semicolon
id|outl
c_func
(paren
id|host_cmd
comma
id|dev-&gt;base_addr
op_plus
id|TLAN_HOST_CMD
)paren
suffix:semicolon
)brace
id|spin_unlock
c_func
(paren
op_amp
id|priv-&gt;lock
)paren
suffix:semicolon
)brace
multiline_comment|/* TLan_HandleInterrupts */
multiline_comment|/***************************************************************&n;&t; *&t;TLan_Close&n;&t; *  &n;&t; * &t;Returns:&n;&t; *&t;&t;An error code.&n;&t; *&t;Parms:&n;&t; *&t;&t;dev&t;The device structure of the device to&n;&t; *&t;&t;&t;close.&n;&t; *&n;&t; *&t;This function shuts down the adapter.  It records any&n;&t; *&t;stats, puts the adapter into reset state, deactivates&n;&t; *&t;its time as needed, and&t;frees the irq it is using.&n;&t; *&n;&t; **************************************************************/
DECL|function|TLan_Close
r_static
r_int
id|TLan_Close
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
id|TLanPrivateInfo
op_star
id|priv
op_assign
(paren
id|TLanPrivateInfo
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|netif_stop_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
id|TLan_ReadAndClearStats
c_func
(paren
id|dev
comma
id|TLAN_RECORD
)paren
suffix:semicolon
id|outl
c_func
(paren
id|TLAN_HC_AD_RST
comma
id|dev-&gt;base_addr
op_plus
id|TLAN_HOST_CMD
)paren
suffix:semicolon
r_if
c_cond
(paren
id|priv-&gt;timer.function
op_ne
l_int|NULL
)paren
(brace
id|del_timer_sync
c_func
(paren
op_amp
id|priv-&gt;timer
)paren
suffix:semicolon
id|priv-&gt;timer.function
op_assign
l_int|NULL
suffix:semicolon
)brace
id|free_irq
c_func
(paren
id|dev-&gt;irq
comma
id|dev
)paren
suffix:semicolon
id|TLan_FreeLists
c_func
(paren
id|dev
)paren
suffix:semicolon
id|TLAN_DBG
c_func
(paren
id|TLAN_DEBUG_GNRL
comma
l_string|&quot;Device %s closed.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* TLan_Close */
multiline_comment|/***************************************************************&n;&t; *&t;TLan_GetStats&n;&t; *  &n;&t; *&t;Returns:&n;&t; *&t;&t;A pointer to the device&squot;s statistics structure.&n;&t; *&t;Parms:&n;&t; *&t;&t;dev&t;The device structure to return the&n;&t; *&t;&t;&t;stats for.&n;&t; *&n;&t; *&t;This function updates the devices statistics by reading&n;&t; *&t;the TLAN chip&squot;s onboard registers.  Then it returns the&n;&t; *&t;address of the statistics structure.&n;&t; *&n;&t; **************************************************************/
DECL|function|TLan_GetStats
r_static
r_struct
id|net_device_stats
op_star
id|TLan_GetStats
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
id|TLanPrivateInfo
op_star
id|priv
op_assign
(paren
id|TLanPrivateInfo
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_int
id|i
suffix:semicolon
multiline_comment|/* Should only read stats if open ? */
id|TLan_ReadAndClearStats
c_func
(paren
id|dev
comma
id|TLAN_RECORD
)paren
suffix:semicolon
id|TLAN_DBG
c_func
(paren
id|TLAN_DEBUG_RX
comma
l_string|&quot;RECEIVE:  %s EOC count = %d&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|priv-&gt;rxEocCount
)paren
suffix:semicolon
id|TLAN_DBG
c_func
(paren
id|TLAN_DEBUG_TX
comma
l_string|&quot;TRANSMIT:  %s Busy count = %d&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|priv-&gt;txBusyCount
)paren
suffix:semicolon
r_if
c_cond
(paren
id|debug
op_amp
id|TLAN_DEBUG_GNRL
)paren
(brace
id|TLan_PrintDio
c_func
(paren
id|dev-&gt;base_addr
)paren
suffix:semicolon
id|TLan_PhyPrint
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|debug
op_amp
id|TLAN_DEBUG_LIST
)paren
(brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|TLAN_NUM_RX_LISTS
suffix:semicolon
id|i
op_increment
)paren
id|TLan_PrintList
c_func
(paren
id|priv-&gt;rxList
op_plus
id|i
comma
l_string|&quot;RX&quot;
comma
id|i
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|TLAN_NUM_TX_LISTS
suffix:semicolon
id|i
op_increment
)paren
id|TLan_PrintList
c_func
(paren
id|priv-&gt;txList
op_plus
id|i
comma
l_string|&quot;TX&quot;
comma
id|i
)paren
suffix:semicolon
)brace
r_return
(paren
op_amp
(paren
(paren
id|TLanPrivateInfo
op_star
)paren
id|dev-&gt;priv
)paren
op_member_access_from_pointer
id|stats
)paren
suffix:semicolon
)brace
multiline_comment|/* TLan_GetStats */
multiline_comment|/***************************************************************&n;&t; *&t;TLan_SetMulticastList&n;&t; *  &n;&t; *&t;Returns:&n;&t; *&t;&t;Nothing&n;&t; *&t;Parms:&n;&t; *&t;&t;dev&t;The device structure to set the&n;&t; *&t;&t;&t;multicast list for.&n;&t; *&n;&t; *&t;This function sets the TLAN adaptor to various receive&n;&t; *&t;modes.  If the IFF_PROMISC flag is set, promiscuous&n;&t; *&t;mode is acitviated.  Otherwise,&t;promiscuous mode is&n;&t; *&t;turned off.  If the IFF_ALLMULTI flag is set, then&n;&t; *&t;the hash table is set to receive all group addresses.&n;&t; *&t;Otherwise, the first three multicast addresses are&n;&t; *&t;stored in AREG_1-3, and the rest are selected via the&n;&t; *&t;hash table, as necessary.&n;&t; *&n;&t; **************************************************************/
DECL|function|TLan_SetMulticastList
r_static
r_void
id|TLan_SetMulticastList
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|dev_mc_list
op_star
id|dmi
op_assign
id|dev-&gt;mc_list
suffix:semicolon
id|u32
id|hash1
op_assign
l_int|0
suffix:semicolon
id|u32
id|hash2
op_assign
l_int|0
suffix:semicolon
r_int
id|i
suffix:semicolon
id|u32
id|offset
suffix:semicolon
id|u8
id|tmp
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;flags
op_amp
id|IFF_PROMISC
)paren
(brace
id|tmp
op_assign
id|TLan_DioRead8
c_func
(paren
id|dev-&gt;base_addr
comma
id|TLAN_NET_CMD
)paren
suffix:semicolon
id|TLan_DioWrite8
c_func
(paren
id|dev-&gt;base_addr
comma
id|TLAN_NET_CMD
comma
id|tmp
op_or
id|TLAN_NET_CMD_CAF
)paren
suffix:semicolon
)brace
r_else
(brace
id|tmp
op_assign
id|TLan_DioRead8
c_func
(paren
id|dev-&gt;base_addr
comma
id|TLAN_NET_CMD
)paren
suffix:semicolon
id|TLan_DioWrite8
c_func
(paren
id|dev-&gt;base_addr
comma
id|TLAN_NET_CMD
comma
id|tmp
op_amp
op_complement
id|TLAN_NET_CMD_CAF
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;flags
op_amp
id|IFF_ALLMULTI
)paren
(brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|3
suffix:semicolon
id|i
op_increment
)paren
id|TLan_SetMac
c_func
(paren
id|dev
comma
id|i
op_plus
l_int|1
comma
l_int|NULL
)paren
suffix:semicolon
id|TLan_DioWrite32
c_func
(paren
id|dev-&gt;base_addr
comma
id|TLAN_HASH_1
comma
l_int|0xFFFFFFFF
)paren
suffix:semicolon
id|TLan_DioWrite32
c_func
(paren
id|dev-&gt;base_addr
comma
id|TLAN_HASH_2
comma
l_int|0xFFFFFFFF
)paren
suffix:semicolon
)brace
r_else
(brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|dev-&gt;mc_count
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|i
OL
l_int|3
)paren
(brace
id|TLan_SetMac
c_func
(paren
id|dev
comma
id|i
op_plus
l_int|1
comma
(paren
r_char
op_star
)paren
op_amp
id|dmi-&gt;dmi_addr
)paren
suffix:semicolon
)brace
r_else
(brace
id|offset
op_assign
id|TLan_HashFunc
c_func
(paren
(paren
id|u8
op_star
)paren
op_amp
id|dmi-&gt;dmi_addr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|offset
OL
l_int|32
)paren
id|hash1
op_or_assign
(paren
l_int|1
op_lshift
id|offset
)paren
suffix:semicolon
r_else
id|hash2
op_or_assign
(paren
l_int|1
op_lshift
(paren
id|offset
op_minus
l_int|32
)paren
)paren
suffix:semicolon
)brace
id|dmi
op_assign
id|dmi-&gt;next
suffix:semicolon
)brace
r_for
c_loop
(paren
suffix:semicolon
id|i
OL
l_int|3
suffix:semicolon
id|i
op_increment
)paren
id|TLan_SetMac
c_func
(paren
id|dev
comma
id|i
op_plus
l_int|1
comma
l_int|NULL
)paren
suffix:semicolon
id|TLan_DioWrite32
c_func
(paren
id|dev-&gt;base_addr
comma
id|TLAN_HASH_1
comma
id|hash1
)paren
suffix:semicolon
id|TLan_DioWrite32
c_func
(paren
id|dev-&gt;base_addr
comma
id|TLAN_HASH_2
comma
id|hash2
)paren
suffix:semicolon
)brace
)brace
)brace
multiline_comment|/* TLan_SetMulticastList */
multiline_comment|/*****************************************************************************&n;******************************************************************************&n;&n;        ThunderLAN Driver Interrupt Vectors and Table&n;&n;&t;Please see Chap. 4, &quot;Interrupt Handling&quot; of the &quot;ThunderLAN&n;&t;Programmer&squot;s Guide&quot; for more informations on handling interrupts&n;&t;generated by TLAN based adapters.  &n;&n;******************************************************************************&n;*****************************************************************************/
multiline_comment|/***************************************************************&n;&t; *&t;TLan_HandleInvalid&n;&t; *&n;&t; *&t;Returns:&n;&t; *&t;&t;0&n;&t; *&t;Parms:&n;&t; *&t;&t;dev&t;&t;Device assigned the IRQ that was&n;&t; *&t;&t;&t;&t;raised.&n;&t; *&t;&t;host_int&t;The contents of the HOST_INT&n;&t; *&t;&t;&t;&t;port.&n;&t; *&n;&t; *&t;This function handles invalid interrupts.  This should&n;&t; *&t;never happen unless some other adapter is trying to use&n;&t; *&t;the IRQ line assigned to the device.&n;&t; *&n;&t; **************************************************************/
DECL|function|TLan_HandleInvalid
id|u32
id|TLan_HandleInvalid
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
id|u16
id|host_int
)paren
(brace
id|host_int
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* printk( &quot;TLAN:  Invalid interrupt on %s.&bslash;n&quot;, dev-&gt;name ); */
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* TLan_HandleInvalid */
multiline_comment|/***************************************************************&n;&t; *&t;TLan_HandleTxEOF&n;&t; *&n;&t; *&t;Returns:&n;&t; *&t;&t;1&n;&t; *&t;Parms:&n;&t; *&t;&t;dev&t;&t;Device assigned the IRQ that was&n;&t; *&t;&t;&t;&t;raised.&n;&t; *&t;&t;host_int&t;The contents of the HOST_INT&n;&t; *&t;&t;&t;&t;port.&n;&t; *&n;&t; *&t;This function handles Tx EOF interrupts which are raised&n;&t; *&t;by the adapter when it has completed sending the&n;&t; *&t;contents of a buffer.  If detemines which list/buffer&n;&t; *&t;was completed and resets it.  If the buffer was the last&n;&t; *&t;in the channel (EOC), then the function checks to see if&n;&t; *&t;another buffer is ready to send, and if so, sends a Tx&n;&t; *&t;Go command.  Finally, the driver activates/continues the&n;&t; *&t;activity LED.&n;&t; *&n;&t; **************************************************************/
DECL|function|TLan_HandleTxEOF
id|u32
id|TLan_HandleTxEOF
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
id|u16
id|host_int
)paren
(brace
id|TLanPrivateInfo
op_star
id|priv
op_assign
(paren
id|TLanPrivateInfo
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_int
id|eoc
op_assign
l_int|0
suffix:semicolon
id|TLanList
op_star
id|head_list
suffix:semicolon
id|u32
id|ack
op_assign
l_int|1
suffix:semicolon
id|TLAN_DBG
c_func
(paren
id|TLAN_DEBUG_TX
comma
l_string|&quot;TRANSMIT:  Handling TX EOF (Head=%d Tail=%d)&bslash;n&quot;
comma
id|priv-&gt;txHead
comma
id|priv-&gt;txTail
)paren
suffix:semicolon
id|host_int
op_assign
l_int|0
suffix:semicolon
id|head_list
op_assign
id|priv-&gt;txList
op_plus
id|priv-&gt;txHead
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|bbuf
)paren
(brace
id|dev_kfree_skb_irq
c_func
(paren
(paren
r_struct
id|sk_buff
op_star
)paren
id|head_list-&gt;buffer
(braket
l_int|9
)braket
dot
id|address
)paren
suffix:semicolon
id|head_list-&gt;buffer
(braket
l_int|9
)braket
dot
id|address
op_assign
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|head_list-&gt;cStat
op_amp
id|TLAN_CSTAT_EOC
)paren
id|eoc
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|head_list-&gt;cStat
op_amp
id|TLAN_CSTAT_FRM_CMP
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;TLAN:  Received interrupt for uncompleted TX frame.&bslash;n&quot;
)paren
suffix:semicolon
)brace
id|priv-&gt;stats.tx_bytes
op_add_assign
id|head_list-&gt;frameSize
suffix:semicolon
id|head_list-&gt;cStat
op_assign
id|TLAN_CSTAT_UNUSED
suffix:semicolon
id|netif_start_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
id|CIRC_INC
c_func
(paren
id|priv-&gt;txHead
comma
id|TLAN_NUM_TX_LISTS
)paren
suffix:semicolon
r_if
c_cond
(paren
id|eoc
)paren
(brace
id|TLAN_DBG
c_func
(paren
id|TLAN_DEBUG_TX
comma
l_string|&quot;TRANSMIT:  Handling TX EOC (Head=%d Tail=%d)&bslash;n&quot;
comma
id|priv-&gt;txHead
comma
id|priv-&gt;txTail
)paren
suffix:semicolon
id|head_list
op_assign
id|priv-&gt;txList
op_plus
id|priv-&gt;txHead
suffix:semicolon
r_if
c_cond
(paren
(paren
id|head_list-&gt;cStat
op_amp
id|TLAN_CSTAT_READY
)paren
op_eq
id|TLAN_CSTAT_READY
)paren
(brace
id|outl
c_func
(paren
id|virt_to_bus
c_func
(paren
id|head_list
)paren
comma
id|dev-&gt;base_addr
op_plus
id|TLAN_CH_PARM
)paren
suffix:semicolon
id|ack
op_or_assign
id|TLAN_HC_GO
suffix:semicolon
)brace
r_else
(brace
id|priv-&gt;txInProgress
op_assign
l_int|0
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|priv-&gt;adapter-&gt;flags
op_amp
id|TLAN_ADAPTER_ACTIVITY_LED
)paren
(brace
id|TLan_DioWrite8
c_func
(paren
id|dev-&gt;base_addr
comma
id|TLAN_LED_REG
comma
id|TLAN_LED_LINK
op_or
id|TLAN_LED_ACT
)paren
suffix:semicolon
r_if
c_cond
(paren
id|priv-&gt;timer.function
op_eq
l_int|NULL
)paren
(brace
id|priv-&gt;timer.function
op_assign
op_amp
id|TLan_Timer
suffix:semicolon
id|priv-&gt;timer.data
op_assign
(paren
r_int
r_int
)paren
id|dev
suffix:semicolon
id|priv-&gt;timer.expires
op_assign
id|jiffies
op_plus
id|TLAN_TIMER_ACT_DELAY
suffix:semicolon
id|priv-&gt;timerSetAt
op_assign
id|jiffies
suffix:semicolon
id|priv-&gt;timerType
op_assign
id|TLAN_TIMER_ACTIVITY
suffix:semicolon
id|add_timer
c_func
(paren
op_amp
id|priv-&gt;timer
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|priv-&gt;timerType
op_eq
id|TLAN_TIMER_ACTIVITY
)paren
(brace
id|priv-&gt;timerSetAt
op_assign
id|jiffies
suffix:semicolon
)brace
)brace
r_return
id|ack
suffix:semicolon
)brace
multiline_comment|/* TLan_HandleTxEOF */
multiline_comment|/***************************************************************&n;&t; *&t;TLan_HandleStatOverflow&n;&t; *&n;&t; *&t;Returns:&n;&t; *&t;&t;1&n;&t; *&t;Parms:&n;&t; *&t;&t;dev&t;&t;Device assigned the IRQ that was&n;&t; *&t;&t;&t;&t;raised.&n;&t; *&t;&t;host_int&t;The contents of the HOST_INT&n;&t; *&t;&t;&t;&t;port.&n;&t; *&n;&t; *&t;This function handles the Statistics Overflow interrupt&n;&t; *&t;which means that one or more of the TLAN statistics&n;&t; *&t;registers has reached 1/2 capacity and needs to be read.&n;&t; *&n;&t; **************************************************************/
DECL|function|TLan_HandleStatOverflow
id|u32
id|TLan_HandleStatOverflow
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
id|u16
id|host_int
)paren
(brace
id|host_int
op_assign
l_int|0
suffix:semicolon
id|TLan_ReadAndClearStats
c_func
(paren
id|dev
comma
id|TLAN_RECORD
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
multiline_comment|/* TLan_HandleStatOverflow */
multiline_comment|/***************************************************************&n;&t; *&t;TLan_HandleRxEOF&n;&t; *&n;&t; *&t;Returns:&n;&t; *&t;&t;1&n;&t; *&t;Parms:&n;&t; *&t;&t;dev&t;&t;Device assigned the IRQ that was&n;&t; *&t;&t;&t;&t;raised.&n;&t; *&t;&t;host_int&t;The contents of the HOST_INT&n;&t; *&t;&t;&t;&t;port.&n;&t; *&n;&t; *&t;This function handles the Rx EOF interrupt which&n;&t; *&t;indicates a frame has been received by the adapter from&n;&t; *&t;the net and the frame has been transferred to memory.&n;&t; *&t;The function determines the bounce buffer the frame has&n;&t; *&t;been loaded into, creates a new sk_buff big enough to&n;&t; *&t;hold the frame, and sends it to protocol stack.  It&n;&t; *&t;then resets the used buffer and appends it to the end&n;&t; *&t;of the list.  If the frame was the last in the Rx&n;&t; *&t;channel (EOC), the function restarts the receive channel&n;&t; *&t;by sending an Rx Go command to the adapter.  Then it&n;&t; *&t;activates/continues the the activity LED.&n;&t; *&n;&t; **************************************************************/
DECL|function|TLan_HandleRxEOF
id|u32
id|TLan_HandleRxEOF
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
id|u16
id|host_int
)paren
(brace
id|TLanPrivateInfo
op_star
id|priv
op_assign
(paren
id|TLanPrivateInfo
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|u32
id|ack
op_assign
l_int|1
suffix:semicolon
r_int
id|eoc
op_assign
l_int|0
suffix:semicolon
id|u8
op_star
id|head_buffer
suffix:semicolon
id|TLanList
op_star
id|head_list
suffix:semicolon
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
id|TLanList
op_star
id|tail_list
suffix:semicolon
r_void
op_star
id|t
suffix:semicolon
id|TLAN_DBG
c_func
(paren
id|TLAN_DEBUG_RX
comma
l_string|&quot;RECEIVE:  Handling RX EOF (Head=%d Tail=%d)&bslash;n&quot;
comma
id|priv-&gt;rxHead
comma
id|priv-&gt;rxTail
)paren
suffix:semicolon
id|host_int
op_assign
l_int|0
suffix:semicolon
id|head_list
op_assign
id|priv-&gt;rxList
op_plus
id|priv-&gt;rxHead
suffix:semicolon
id|tail_list
op_assign
id|priv-&gt;rxList
op_plus
id|priv-&gt;rxTail
suffix:semicolon
r_if
c_cond
(paren
id|head_list-&gt;cStat
op_amp
id|TLAN_CSTAT_EOC
)paren
(brace
id|eoc
op_assign
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|head_list-&gt;cStat
op_amp
id|TLAN_CSTAT_FRM_CMP
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;TLAN:  Received interrupt for uncompleted RX frame.&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|bbuf
)paren
(brace
id|skb
op_assign
id|dev_alloc_skb
c_func
(paren
id|head_list-&gt;frameSize
op_plus
l_int|7
)paren
suffix:semicolon
r_if
c_cond
(paren
id|skb
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;TLAN:  Couldn&squot;t allocate memory for received data.&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_else
(brace
id|head_buffer
op_assign
id|priv-&gt;rxBuffer
op_plus
(paren
id|priv-&gt;rxHead
op_star
id|TLAN_MAX_FRAME_SIZE
)paren
suffix:semicolon
id|skb-&gt;dev
op_assign
id|dev
suffix:semicolon
id|skb_reserve
c_func
(paren
id|skb
comma
l_int|2
)paren
suffix:semicolon
id|t
op_assign
(paren
r_void
op_star
)paren
id|skb_put
c_func
(paren
id|skb
comma
id|head_list-&gt;frameSize
)paren
suffix:semicolon
id|priv-&gt;stats.rx_bytes
op_add_assign
id|head_list-&gt;frameSize
suffix:semicolon
id|memcpy
c_func
(paren
id|t
comma
id|head_buffer
comma
id|head_list-&gt;frameSize
)paren
suffix:semicolon
id|skb-&gt;protocol
op_assign
id|eth_type_trans
c_func
(paren
id|skb
comma
id|dev
)paren
suffix:semicolon
id|netif_rx
c_func
(paren
id|skb
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
r_struct
id|sk_buff
op_star
id|new_skb
suffix:semicolon
multiline_comment|/*&n;&t;&t; *&t;I changed the algorithm here. What we now do&n;&t;&t; *&t;is allocate the new frame. If this fails we&n;&t;&t; *&t;simply recycle the frame.&n;&t;&t; */
id|new_skb
op_assign
id|dev_alloc_skb
c_func
(paren
id|TLAN_MAX_FRAME_SIZE
op_plus
l_int|7
)paren
suffix:semicolon
r_if
c_cond
(paren
id|new_skb
op_ne
l_int|NULL
)paren
(brace
multiline_comment|/* If this ever happened it would be a problem */
multiline_comment|/* not any more - ac */
id|skb
op_assign
(paren
r_struct
id|sk_buff
op_star
)paren
id|head_list-&gt;buffer
(braket
l_int|9
)braket
dot
id|address
suffix:semicolon
id|head_list-&gt;buffer
(braket
l_int|9
)braket
dot
id|address
op_assign
l_int|0
suffix:semicolon
id|skb_trim
c_func
(paren
id|skb
comma
id|head_list-&gt;frameSize
)paren
suffix:semicolon
id|priv-&gt;stats.rx_bytes
op_add_assign
id|head_list-&gt;frameSize
suffix:semicolon
id|skb-&gt;protocol
op_assign
id|eth_type_trans
c_func
(paren
id|skb
comma
id|dev
)paren
suffix:semicolon
id|netif_rx
c_func
(paren
id|skb
)paren
suffix:semicolon
id|new_skb-&gt;dev
op_assign
id|dev
suffix:semicolon
id|skb_reserve
c_func
(paren
id|new_skb
comma
l_int|2
)paren
suffix:semicolon
id|t
op_assign
(paren
r_void
op_star
)paren
id|skb_put
c_func
(paren
id|new_skb
comma
id|TLAN_MAX_FRAME_SIZE
)paren
suffix:semicolon
id|head_list-&gt;buffer
(braket
l_int|0
)braket
dot
id|address
op_assign
id|virt_to_bus
c_func
(paren
id|t
)paren
suffix:semicolon
id|head_list-&gt;buffer
(braket
l_int|9
)braket
dot
id|address
op_assign
(paren
id|u32
)paren
id|new_skb
suffix:semicolon
)brace
r_else
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;TLAN:  Couldn&squot;t allocate memory for received data.&bslash;n&quot;
)paren
suffix:semicolon
)brace
id|head_list-&gt;forward
op_assign
l_int|0
suffix:semicolon
id|head_list-&gt;frameSize
op_assign
id|TLAN_MAX_FRAME_SIZE
suffix:semicolon
id|head_list-&gt;buffer
(braket
l_int|0
)braket
dot
id|count
op_assign
id|TLAN_MAX_FRAME_SIZE
op_or
id|TLAN_LAST_BUFFER
suffix:semicolon
id|tail_list-&gt;forward
op_assign
id|virt_to_bus
c_func
(paren
id|head_list
)paren
suffix:semicolon
id|CIRC_INC
c_func
(paren
id|priv-&gt;rxHead
comma
id|TLAN_NUM_RX_LISTS
)paren
suffix:semicolon
id|CIRC_INC
c_func
(paren
id|priv-&gt;rxTail
comma
id|TLAN_NUM_RX_LISTS
)paren
suffix:semicolon
r_if
c_cond
(paren
id|eoc
)paren
(brace
id|TLAN_DBG
c_func
(paren
id|TLAN_DEBUG_RX
comma
l_string|&quot;RECEIVE:  Handling RX EOC (Head=%d Tail=%d)&bslash;n&quot;
comma
id|priv-&gt;rxHead
comma
id|priv-&gt;rxTail
)paren
suffix:semicolon
id|head_list
op_assign
id|priv-&gt;rxList
op_plus
id|priv-&gt;rxHead
suffix:semicolon
id|outl
c_func
(paren
id|virt_to_bus
c_func
(paren
id|head_list
)paren
comma
id|dev-&gt;base_addr
op_plus
id|TLAN_CH_PARM
)paren
suffix:semicolon
id|ack
op_or_assign
id|TLAN_HC_GO
op_or
id|TLAN_HC_RT
suffix:semicolon
id|priv-&gt;rxEocCount
op_increment
suffix:semicolon
)brace
r_if
c_cond
(paren
id|priv-&gt;adapter-&gt;flags
op_amp
id|TLAN_ADAPTER_ACTIVITY_LED
)paren
(brace
id|TLan_DioWrite8
c_func
(paren
id|dev-&gt;base_addr
comma
id|TLAN_LED_REG
comma
id|TLAN_LED_LINK
op_or
id|TLAN_LED_ACT
)paren
suffix:semicolon
r_if
c_cond
(paren
id|priv-&gt;timer.function
op_eq
l_int|NULL
)paren
(brace
id|priv-&gt;timer.function
op_assign
op_amp
id|TLan_Timer
suffix:semicolon
id|priv-&gt;timer.data
op_assign
(paren
r_int
r_int
)paren
id|dev
suffix:semicolon
id|priv-&gt;timer.expires
op_assign
id|jiffies
op_plus
id|TLAN_TIMER_ACT_DELAY
suffix:semicolon
id|priv-&gt;timerSetAt
op_assign
id|jiffies
suffix:semicolon
id|priv-&gt;timerType
op_assign
id|TLAN_TIMER_ACTIVITY
suffix:semicolon
id|add_timer
c_func
(paren
op_amp
id|priv-&gt;timer
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|priv-&gt;timerType
op_eq
id|TLAN_TIMER_ACTIVITY
)paren
(brace
id|priv-&gt;timerSetAt
op_assign
id|jiffies
suffix:semicolon
)brace
)brace
id|dev-&gt;last_rx
op_assign
id|jiffies
suffix:semicolon
r_return
id|ack
suffix:semicolon
)brace
multiline_comment|/* TLan_HandleRxEOF */
multiline_comment|/***************************************************************&n;&t; *&t;TLan_HandleDummy&n;&t; *&n;&t; *&t;Returns:&n;&t; *&t;&t;1&n;&t; *&t;Parms:&n;&t; *&t;&t;dev&t;&t;Device assigned the IRQ that was&n;&t; *&t;&t;&t;&t;raised.&n;&t; *&t;&t;host_int&t;The contents of the HOST_INT&n;&t; *&t;&t;&t;&t;port.&n;&t; *&n;&t; *&t;This function handles the Dummy interrupt, which is&n;&t; *&t;raised whenever a test interrupt is generated by setting&n;&t; *&t;the Req_Int bit of HOST_CMD to 1.&n;&t; *&n;&t; **************************************************************/
DECL|function|TLan_HandleDummy
id|u32
id|TLan_HandleDummy
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
id|u16
id|host_int
)paren
(brace
id|host_int
op_assign
l_int|0
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;TLAN:  Test interrupt on %s.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
multiline_comment|/* TLan_HandleDummy */
multiline_comment|/***************************************************************&n;&t; *&t;TLan_HandleTxEOC&n;&t; *&n;&t; *&t;Returns:&n;&t; *&t;&t;1&n;&t; *&t;Parms:&n;&t; *&t;&t;dev&t;&t;Device assigned the IRQ that was&n;&t; *&t;&t;&t;&t;raised.&n;&t; *&t;&t;host_int&t;The contents of the HOST_INT&n;&t; *&t;&t;&t;&t;port.&n;&t; *&n;&t; *&t;This driver is structured to determine EOC occurances by&n;&t; *&t;reading the CSTAT member of the list structure.  Tx EOC&n;&t; *&t;interrupts are disabled via the DIO INTDIS register.&n;&t; *&t;However, TLAN chips before revision 3.0 didn&squot;t have this&n;&t; *&t;functionality, so process EOC events if this is the&n;&t; *&t;case.&n;&t; *&n;&t; **************************************************************/
DECL|function|TLan_HandleTxEOC
id|u32
id|TLan_HandleTxEOC
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
id|u16
id|host_int
)paren
(brace
id|TLanPrivateInfo
op_star
id|priv
op_assign
(paren
id|TLanPrivateInfo
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|TLanList
op_star
id|head_list
suffix:semicolon
id|u32
id|ack
op_assign
l_int|1
suffix:semicolon
id|host_int
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|priv-&gt;tlanRev
OL
l_int|0x30
)paren
(brace
id|TLAN_DBG
c_func
(paren
id|TLAN_DEBUG_TX
comma
l_string|&quot;TRANSMIT:  Handling TX EOC (Head=%d Tail=%d) -- IRQ&bslash;n&quot;
comma
id|priv-&gt;txHead
comma
id|priv-&gt;txTail
)paren
suffix:semicolon
id|head_list
op_assign
id|priv-&gt;txList
op_plus
id|priv-&gt;txHead
suffix:semicolon
r_if
c_cond
(paren
(paren
id|head_list-&gt;cStat
op_amp
id|TLAN_CSTAT_READY
)paren
op_eq
id|TLAN_CSTAT_READY
)paren
(brace
id|outl
c_func
(paren
id|virt_to_bus
c_func
(paren
id|head_list
)paren
comma
id|dev-&gt;base_addr
op_plus
id|TLAN_CH_PARM
)paren
suffix:semicolon
id|ack
op_or_assign
id|TLAN_HC_GO
suffix:semicolon
)brace
r_else
(brace
id|priv-&gt;txInProgress
op_assign
l_int|0
suffix:semicolon
)brace
)brace
r_return
id|ack
suffix:semicolon
)brace
multiline_comment|/* TLan_HandleTxEOC */
multiline_comment|/***************************************************************&n;&t; *&t;TLan_HandleStatusCheck&n;&t; *&n;&t; *&t;Returns:&n;&t; *&t;&t;0 if Adapter check, 1 if Network Status check.&n;&t; *&t;Parms:&n;&t; *&t;&t;dev&t;&t;Device assigned the IRQ that was&n;&t; *&t;&t;&t;&t;raised.&n;&t; *&t;&t;host_int&t;The contents of the HOST_INT&n;&t; *&t;&t;&t;&t;port.&n;&t; *&n;&t; *&t;This function handles Adapter Check/Network Status&n;&t; *&t;interrupts generated by the adapter.  It checks the&n;&t; *&t;vector in the HOST_INT register to determine if it is&n;&t; *&t;an Adapter Check interrupt.  If so, it resets the&n;&t; *&t;adapter.  Otherwise it clears the status registers&n;&t; *&t;and services the PHY.&n;&t; *&n;&t; **************************************************************/
DECL|function|TLan_HandleStatusCheck
id|u32
id|TLan_HandleStatusCheck
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
id|u16
id|host_int
)paren
(brace
id|TLanPrivateInfo
op_star
id|priv
op_assign
(paren
id|TLanPrivateInfo
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|u32
id|ack
suffix:semicolon
id|u32
id|error
suffix:semicolon
id|u8
id|net_sts
suffix:semicolon
id|u32
id|phy
suffix:semicolon
id|u16
id|tlphy_ctl
suffix:semicolon
id|u16
id|tlphy_sts
suffix:semicolon
id|ack
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|host_int
op_amp
id|TLAN_HI_IV_MASK
)paren
(brace
id|error
op_assign
id|inl
c_func
(paren
id|dev-&gt;base_addr
op_plus
id|TLAN_CH_PARM
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;TLAN:  %s: Adaptor Error = 0x%x&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|error
)paren
suffix:semicolon
id|TLan_ReadAndClearStats
c_func
(paren
id|dev
comma
id|TLAN_RECORD
)paren
suffix:semicolon
id|outl
c_func
(paren
id|TLAN_HC_AD_RST
comma
id|dev-&gt;base_addr
op_plus
id|TLAN_HOST_CMD
)paren
suffix:semicolon
id|TLan_FreeLists
c_func
(paren
id|dev
)paren
suffix:semicolon
id|TLan_ResetLists
c_func
(paren
id|dev
)paren
suffix:semicolon
id|TLan_ResetAdapter
c_func
(paren
id|dev
)paren
suffix:semicolon
id|netif_start_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
id|ack
op_assign
l_int|0
suffix:semicolon
)brace
r_else
(brace
id|TLAN_DBG
c_func
(paren
id|TLAN_DEBUG_GNRL
comma
l_string|&quot;%s: Status Check&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|phy
op_assign
id|priv-&gt;phy
(braket
id|priv-&gt;phyNum
)braket
suffix:semicolon
id|net_sts
op_assign
id|TLan_DioRead8
c_func
(paren
id|dev-&gt;base_addr
comma
id|TLAN_NET_STS
)paren
suffix:semicolon
r_if
c_cond
(paren
id|net_sts
)paren
(brace
id|TLan_DioWrite8
c_func
(paren
id|dev-&gt;base_addr
comma
id|TLAN_NET_STS
comma
id|net_sts
)paren
suffix:semicolon
id|TLAN_DBG
c_func
(paren
id|TLAN_DEBUG_GNRL
comma
l_string|&quot;%s:    Net_Sts = %x&bslash;n&quot;
comma
id|dev-&gt;name
comma
(paren
r_int
)paren
id|net_sts
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|net_sts
op_amp
id|TLAN_NET_STS_MIRQ
)paren
op_logical_and
(paren
id|priv-&gt;phyNum
op_eq
l_int|0
)paren
)paren
(brace
id|TLan_MiiReadReg
c_func
(paren
id|dev
comma
id|phy
comma
id|TLAN_TLPHY_STS
comma
op_amp
id|tlphy_sts
)paren
suffix:semicolon
id|TLan_MiiReadReg
c_func
(paren
id|dev
comma
id|phy
comma
id|TLAN_TLPHY_CTL
comma
op_amp
id|tlphy_ctl
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|tlphy_sts
op_amp
id|TLAN_TS_POLOK
)paren
op_logical_and
op_logical_neg
(paren
id|tlphy_ctl
op_amp
id|TLAN_TC_SWAPOL
)paren
)paren
(brace
id|tlphy_ctl
op_or_assign
id|TLAN_TC_SWAPOL
suffix:semicolon
id|TLan_MiiWriteReg
c_func
(paren
id|dev
comma
id|phy
comma
id|TLAN_TLPHY_CTL
comma
id|tlphy_ctl
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
(paren
id|tlphy_sts
op_amp
id|TLAN_TS_POLOK
)paren
op_logical_and
(paren
id|tlphy_ctl
op_amp
id|TLAN_TC_SWAPOL
)paren
)paren
(brace
id|tlphy_ctl
op_and_assign
op_complement
id|TLAN_TC_SWAPOL
suffix:semicolon
id|TLan_MiiWriteReg
c_func
(paren
id|dev
comma
id|phy
comma
id|TLAN_TLPHY_CTL
comma
id|tlphy_ctl
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|debug
)paren
(brace
id|TLan_PhyPrint
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
)brace
)brace
r_return
id|ack
suffix:semicolon
)brace
multiline_comment|/* TLan_HandleStatusCheck */
multiline_comment|/***************************************************************&n;&t; *&t;TLan_HandleRxEOC&n;&t; *&n;&t; *&t;Returns:&n;&t; *&t;&t;1&n;&t; *&t;Parms:&n;&t; *&t;&t;dev&t;&t;Device assigned the IRQ that was&n;&t; *&t;&t;&t;&t;raised.&n;&t; *&t;&t;host_int&t;The contents of the HOST_INT&n;&t; *&t;&t;&t;&t;port.&n;&t; *&n;&t; *&t;This driver is structured to determine EOC occurances by&n;&t; *&t;reading the CSTAT member of the list structure.  Rx EOC&n;&t; *&t;interrupts are disabled via the DIO INTDIS register.&n;&t; *&t;However, TLAN chips before revision 3.0 didn&squot;t have this&n;&t; *&t;CSTAT member or a INTDIS register, so if this chip is&n;&t; *&t;pre-3.0, process EOC interrupts normally.&n;&t; *&n;&t; **************************************************************/
DECL|function|TLan_HandleRxEOC
id|u32
id|TLan_HandleRxEOC
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
id|u16
id|host_int
)paren
(brace
id|TLanPrivateInfo
op_star
id|priv
op_assign
(paren
id|TLanPrivateInfo
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|TLanList
op_star
id|head_list
suffix:semicolon
id|u32
id|ack
op_assign
l_int|1
suffix:semicolon
id|host_int
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|priv-&gt;tlanRev
OL
l_int|0x30
)paren
(brace
id|TLAN_DBG
c_func
(paren
id|TLAN_DEBUG_RX
comma
l_string|&quot;RECEIVE:  Handling RX EOC (Head=%d Tail=%d) -- IRQ&bslash;n&quot;
comma
id|priv-&gt;rxHead
comma
id|priv-&gt;rxTail
)paren
suffix:semicolon
id|head_list
op_assign
id|priv-&gt;rxList
op_plus
id|priv-&gt;rxHead
suffix:semicolon
id|outl
c_func
(paren
id|virt_to_bus
c_func
(paren
id|head_list
)paren
comma
id|dev-&gt;base_addr
op_plus
id|TLAN_CH_PARM
)paren
suffix:semicolon
id|ack
op_or_assign
id|TLAN_HC_GO
op_or
id|TLAN_HC_RT
suffix:semicolon
id|priv-&gt;rxEocCount
op_increment
suffix:semicolon
)brace
r_return
id|ack
suffix:semicolon
)brace
multiline_comment|/* TLan_HandleRxEOC */
multiline_comment|/*****************************************************************************&n;******************************************************************************&n;&n;&t;ThunderLAN Driver Timer Function&n;&n;******************************************************************************&n;*****************************************************************************/
multiline_comment|/***************************************************************&n;&t; *&t;TLan_Timer&n;&t; *&n;&t; *&t;Returns:&n;&t; *&t;&t;Nothing&n;&t; *&t;Parms:&n;&t; *&t;&t;data&t;A value given to add timer when&n;&t; *&t;&t;&t;add_timer was called.&n;&t; *&n;&t; *&t;This function handles timed functionality for the&n;&t; *&t;TLAN driver.  The two current timer uses are for&n;&t; *&t;delaying for autonegotionation and driving the ACT LED.&n;&t; *&t;-&t;Autonegotiation requires being allowed about&n;&t; *&t;&t;2 1/2 seconds before attempting to transmit a&n;&t; *&t;&t;packet.  It would be a very bad thing to hang&n;&t; *&t;&t;the kernel this long, so the driver doesn&squot;t&n;&t; *&t;&t;allow transmission &squot;til after this time, for&n;&t; *&t;&t;certain PHYs.  It would be much nicer if all&n;&t; *&t;&t;PHYs were interrupt-capable like the internal&n;&t; *&t;&t;PHY.&n;&t; *&t;-&t;The ACT LED, which shows adapter activity, is&n;&t; *&t;&t;driven by the driver, and so must be left on&n;&t; *&t;&t;for a short period to power up the LED so it&n;&t; *&t;&t;can be seen.  This delay can be changed by&n;&t; *&t;&t;changing the TLAN_TIMER_ACT_DELAY in tlan.h,&n;&t; *&t;&t;if desired.  100 ms  produces a slightly&n;&t; *&t;&t;sluggish response.&n;&t; *&n;&t; **************************************************************/
DECL|function|TLan_Timer
r_void
id|TLan_Timer
c_func
(paren
r_int
r_int
id|data
)paren
(brace
r_struct
id|net_device
op_star
id|dev
op_assign
(paren
r_struct
id|net_device
op_star
)paren
id|data
suffix:semicolon
id|TLanPrivateInfo
op_star
id|priv
op_assign
(paren
id|TLanPrivateInfo
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|u32
id|elapsed
suffix:semicolon
r_int
r_int
id|flags
op_assign
l_int|0
suffix:semicolon
id|priv-&gt;timer.function
op_assign
l_int|NULL
suffix:semicolon
r_switch
c_cond
(paren
id|priv-&gt;timerType
)paren
(brace
macro_line|#ifdef MONITOR&t;&t;
r_case
id|TLAN_TIMER_LINK_BEAT
suffix:colon
id|TLan_PhyMonitor
c_func
(paren
id|dev
)paren
suffix:semicolon
r_break
suffix:semicolon
macro_line|#endif
r_case
id|TLAN_TIMER_PHY_PDOWN
suffix:colon
id|TLan_PhyPowerDown
c_func
(paren
id|dev
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|TLAN_TIMER_PHY_PUP
suffix:colon
id|TLan_PhyPowerUp
c_func
(paren
id|dev
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|TLAN_TIMER_PHY_RESET
suffix:colon
id|TLan_PhyReset
c_func
(paren
id|dev
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|TLAN_TIMER_PHY_START_LINK
suffix:colon
id|TLan_PhyStartLink
c_func
(paren
id|dev
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|TLAN_TIMER_PHY_FINISH_AN
suffix:colon
id|TLan_PhyFinishAutoNeg
c_func
(paren
id|dev
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|TLAN_TIMER_FINISH_RESET
suffix:colon
id|TLan_FinishReset
c_func
(paren
id|dev
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|TLAN_TIMER_ACTIVITY
suffix:colon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|priv-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|priv-&gt;timer.function
op_eq
l_int|NULL
)paren
(brace
id|elapsed
op_assign
id|jiffies
op_minus
id|priv-&gt;timerSetAt
suffix:semicolon
r_if
c_cond
(paren
id|elapsed
op_ge
id|TLAN_TIMER_ACT_DELAY
)paren
(brace
id|TLan_DioWrite8
c_func
(paren
id|dev-&gt;base_addr
comma
id|TLAN_LED_REG
comma
id|TLAN_LED_LINK
)paren
suffix:semicolon
)brace
r_else
(brace
id|priv-&gt;timer.function
op_assign
op_amp
id|TLan_Timer
suffix:semicolon
id|priv-&gt;timer.expires
op_assign
id|priv-&gt;timerSetAt
op_plus
id|TLAN_TIMER_ACT_DELAY
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|priv-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|add_timer
c_func
(paren
op_amp
id|priv-&gt;timer
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|priv-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
r_break
suffix:semicolon
)brace
)brace
multiline_comment|/* TLan_Timer */
multiline_comment|/*****************************************************************************&n;******************************************************************************&n;&n;&t;ThunderLAN Driver Adapter Related Routines&n;&n;******************************************************************************&n;*****************************************************************************/
multiline_comment|/***************************************************************&n;&t; *&t;TLan_ResetLists&n;&t; *  &n;&t; *&t;Returns:&n;&t; *&t;&t;Nothing&n;&t; *&t;Parms:&n;&t; *&t;&t;dev&t;The device structure with the list&n;&t; *&t;&t;&t;stuctures to be reset.&n;&t; *&n;&t; *&t;This routine sets the variables associated with managing&n;&t; *&t;the TLAN lists to their initial values.&n;&t; *&n;&t; **************************************************************/
DECL|function|TLan_ResetLists
r_void
id|TLan_ResetLists
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
id|TLanPrivateInfo
op_star
id|priv
op_assign
(paren
id|TLanPrivateInfo
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_int
id|i
suffix:semicolon
id|TLanList
op_star
id|list
suffix:semicolon
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
r_void
op_star
id|t
op_assign
l_int|NULL
suffix:semicolon
id|priv-&gt;txHead
op_assign
l_int|0
suffix:semicolon
id|priv-&gt;txTail
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|TLAN_NUM_TX_LISTS
suffix:semicolon
id|i
op_increment
)paren
(brace
id|list
op_assign
id|priv-&gt;txList
op_plus
id|i
suffix:semicolon
id|list-&gt;cStat
op_assign
id|TLAN_CSTAT_UNUSED
suffix:semicolon
r_if
c_cond
(paren
id|bbuf
)paren
(brace
id|list-&gt;buffer
(braket
l_int|0
)braket
dot
id|address
op_assign
id|virt_to_bus
c_func
(paren
id|priv-&gt;txBuffer
op_plus
(paren
id|i
op_star
id|TLAN_MAX_FRAME_SIZE
)paren
)paren
suffix:semicolon
)brace
r_else
(brace
id|list-&gt;buffer
(braket
l_int|0
)braket
dot
id|address
op_assign
l_int|0
suffix:semicolon
)brace
id|list-&gt;buffer
(braket
l_int|2
)braket
dot
id|count
op_assign
l_int|0
suffix:semicolon
id|list-&gt;buffer
(braket
l_int|2
)braket
dot
id|address
op_assign
l_int|0
suffix:semicolon
)brace
id|priv-&gt;rxHead
op_assign
l_int|0
suffix:semicolon
id|priv-&gt;rxTail
op_assign
id|TLAN_NUM_RX_LISTS
op_minus
l_int|1
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|TLAN_NUM_RX_LISTS
suffix:semicolon
id|i
op_increment
)paren
(brace
id|list
op_assign
id|priv-&gt;rxList
op_plus
id|i
suffix:semicolon
id|list-&gt;cStat
op_assign
id|TLAN_CSTAT_READY
suffix:semicolon
id|list-&gt;frameSize
op_assign
id|TLAN_MAX_FRAME_SIZE
suffix:semicolon
id|list-&gt;buffer
(braket
l_int|0
)braket
dot
id|count
op_assign
id|TLAN_MAX_FRAME_SIZE
op_or
id|TLAN_LAST_BUFFER
suffix:semicolon
r_if
c_cond
(paren
id|bbuf
)paren
(brace
id|list-&gt;buffer
(braket
l_int|0
)braket
dot
id|address
op_assign
id|virt_to_bus
c_func
(paren
id|priv-&gt;rxBuffer
op_plus
(paren
id|i
op_star
id|TLAN_MAX_FRAME_SIZE
)paren
)paren
suffix:semicolon
)brace
r_else
(brace
id|skb
op_assign
id|dev_alloc_skb
c_func
(paren
id|TLAN_MAX_FRAME_SIZE
op_plus
l_int|7
)paren
suffix:semicolon
r_if
c_cond
(paren
id|skb
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;TLAN:  Couldn&squot;t allocate memory for received data.&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* If this ever happened it would be a problem */
)brace
r_else
(brace
id|skb-&gt;dev
op_assign
id|dev
suffix:semicolon
id|skb_reserve
c_func
(paren
id|skb
comma
l_int|2
)paren
suffix:semicolon
id|t
op_assign
(paren
r_void
op_star
)paren
id|skb_put
c_func
(paren
id|skb
comma
id|TLAN_MAX_FRAME_SIZE
)paren
suffix:semicolon
)brace
id|list-&gt;buffer
(braket
l_int|0
)braket
dot
id|address
op_assign
id|virt_to_bus
c_func
(paren
id|t
)paren
suffix:semicolon
id|list-&gt;buffer
(braket
l_int|9
)braket
dot
id|address
op_assign
(paren
id|u32
)paren
id|skb
suffix:semicolon
)brace
id|list-&gt;buffer
(braket
l_int|1
)braket
dot
id|count
op_assign
l_int|0
suffix:semicolon
id|list-&gt;buffer
(braket
l_int|1
)braket
dot
id|address
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|i
OL
id|TLAN_NUM_RX_LISTS
op_minus
l_int|1
)paren
id|list-&gt;forward
op_assign
id|virt_to_bus
c_func
(paren
id|list
op_plus
l_int|1
)paren
suffix:semicolon
r_else
id|list-&gt;forward
op_assign
l_int|0
suffix:semicolon
)brace
)brace
multiline_comment|/* TLan_ResetLists */
DECL|function|TLan_FreeLists
r_void
id|TLan_FreeLists
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
id|TLanPrivateInfo
op_star
id|priv
op_assign
(paren
id|TLanPrivateInfo
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_int
id|i
suffix:semicolon
id|TLanList
op_star
id|list
suffix:semicolon
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|bbuf
)paren
(brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|TLAN_NUM_TX_LISTS
suffix:semicolon
id|i
op_increment
)paren
(brace
id|list
op_assign
id|priv-&gt;txList
op_plus
id|i
suffix:semicolon
id|skb
op_assign
(paren
r_struct
id|sk_buff
op_star
)paren
id|list-&gt;buffer
(braket
l_int|9
)braket
dot
id|address
suffix:semicolon
r_if
c_cond
(paren
id|skb
)paren
(brace
id|dev_kfree_skb_any
c_func
(paren
id|skb
)paren
suffix:semicolon
id|list-&gt;buffer
(braket
l_int|9
)braket
dot
id|address
op_assign
l_int|0
suffix:semicolon
)brace
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|TLAN_NUM_RX_LISTS
suffix:semicolon
id|i
op_increment
)paren
(brace
id|list
op_assign
id|priv-&gt;rxList
op_plus
id|i
suffix:semicolon
id|skb
op_assign
(paren
r_struct
id|sk_buff
op_star
)paren
id|list-&gt;buffer
(braket
l_int|9
)braket
dot
id|address
suffix:semicolon
r_if
c_cond
(paren
id|skb
)paren
(brace
id|dev_kfree_skb_any
c_func
(paren
id|skb
)paren
suffix:semicolon
id|list-&gt;buffer
(braket
l_int|9
)braket
dot
id|address
op_assign
l_int|0
suffix:semicolon
)brace
)brace
)brace
)brace
multiline_comment|/* TLan_FreeLists */
multiline_comment|/***************************************************************&n;&t; *&t;TLan_PrintDio&n;&t; *  &n;&t; *&t;Returns:&n;&t; *&t;&t;Nothing&n;&t; *&t;Parms:&n;&t; *&t;&t;io_base&t;&t;Base IO port of the device of&n;&t; *&t;&t;&t;&t;which to print DIO registers.&n;&t; *&n;&t; *&t;This function prints out all the the internal (DIO)&n;&t; *&t;registers of a TLAN chip.&n;&t; *&n;&t; **************************************************************/
DECL|function|TLan_PrintDio
r_void
id|TLan_PrintDio
c_func
(paren
id|u16
id|io_base
)paren
(brace
id|u32
id|data0
comma
id|data1
suffix:semicolon
r_int
id|i
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;TLAN:   Contents of internal registers for io base 0x%04hx.&bslash;n&quot;
comma
id|io_base
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;TLAN:      Off.  +0         +4&bslash;n&quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|0x4C
suffix:semicolon
id|i
op_add_assign
l_int|8
)paren
(brace
id|data0
op_assign
id|TLan_DioRead32
c_func
(paren
id|io_base
comma
id|i
)paren
suffix:semicolon
id|data1
op_assign
id|TLan_DioRead32
c_func
(paren
id|io_base
comma
id|i
op_plus
l_int|0x4
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;TLAN:      0x%02x  0x%08x 0x%08x&bslash;n&quot;
comma
id|i
comma
id|data0
comma
id|data1
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* TLan_PrintDio */
multiline_comment|/***************************************************************&n;&t; *&t;TLan_PrintList&n;&t; *  &n;&t; *&t;Returns:&n;&t; *&t;&t;Nothing&n;&t; *&t;Parms:&n;&t; *&t;&t;list&t;A pointer to the TLanList structure to&n;&t; *&t;&t;&t;be printed.&n;&t; *&t;&t;type&t;A string to designate type of list,&n;&t; *&t;&t;&t;&quot;Rx&quot; or &quot;Tx&quot;.&n;&t; *&t;&t;num&t;The index of the list.&n;&t; *&n;&t; *&t;This function prints out the contents of the list&n;&t; *&t;pointed to by the list parameter.&n;&t; *&n;&t; **************************************************************/
DECL|function|TLan_PrintList
r_void
id|TLan_PrintList
c_func
(paren
id|TLanList
op_star
id|list
comma
r_char
op_star
id|type
comma
r_int
id|num
)paren
(brace
r_int
id|i
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;TLAN:   %s List %d at 0x%08x&bslash;n&quot;
comma
id|type
comma
id|num
comma
(paren
id|u32
)paren
id|list
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;TLAN:      Forward    = 0x%08x&bslash;n&quot;
comma
id|list-&gt;forward
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;TLAN:      CSTAT      = 0x%04hx&bslash;n&quot;
comma
id|list-&gt;cStat
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;TLAN:      Frame Size = 0x%04hx&bslash;n&quot;
comma
id|list-&gt;frameSize
)paren
suffix:semicolon
multiline_comment|/* for ( i = 0; i &lt; 10; i++ ) { */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|2
suffix:semicolon
id|i
op_increment
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;TLAN:      Buffer[%d].count, addr = 0x%08x, 0x%08x&bslash;n&quot;
comma
id|i
comma
id|list-&gt;buffer
(braket
id|i
)braket
dot
id|count
comma
id|list-&gt;buffer
(braket
id|i
)braket
dot
id|address
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* TLan_PrintList */
multiline_comment|/***************************************************************&n;&t; *&t;TLan_ReadAndClearStats&n;&t; *&n;&t; *&t;Returns:&n;&t; *&t;&t;Nothing&n;&t; *&t;Parms:&n;&t; *&t;&t;dev&t;Pointer to device structure of adapter&n;&t; *&t;&t;&t;to which to read stats.&n;&t; *&t;&t;record&t;Flag indicating whether to add &n;&t; *&n;&t; *&t;This functions reads all the internal status registers&n;&t; *&t;of the TLAN chip, which clears them as a side effect.&n;&t; *&t;It then either adds the values to the device&squot;s status&n;&t; *&t;struct, or discards them, depending on whether record&n;&t; *&t;is TLAN_RECORD (!=0)  or TLAN_IGNORE (==0).&n;&t; *&n;&t; **************************************************************/
DECL|function|TLan_ReadAndClearStats
r_void
id|TLan_ReadAndClearStats
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_int
id|record
)paren
(brace
id|TLanPrivateInfo
op_star
id|priv
op_assign
(paren
id|TLanPrivateInfo
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|u32
id|tx_good
comma
id|tx_under
suffix:semicolon
id|u32
id|rx_good
comma
id|rx_over
suffix:semicolon
id|u32
id|def_tx
comma
id|crc
comma
id|code
suffix:semicolon
id|u32
id|multi_col
comma
id|single_col
suffix:semicolon
id|u32
id|excess_col
comma
id|late_col
comma
id|loss
suffix:semicolon
id|outw
c_func
(paren
id|TLAN_GOOD_TX_FRMS
comma
id|dev-&gt;base_addr
op_plus
id|TLAN_DIO_ADR
)paren
suffix:semicolon
id|tx_good
op_assign
id|inb
c_func
(paren
id|dev-&gt;base_addr
op_plus
id|TLAN_DIO_DATA
)paren
suffix:semicolon
id|tx_good
op_add_assign
id|inb
c_func
(paren
id|dev-&gt;base_addr
op_plus
id|TLAN_DIO_DATA
op_plus
l_int|1
)paren
op_lshift
l_int|8
suffix:semicolon
id|tx_good
op_add_assign
id|inb
c_func
(paren
id|dev-&gt;base_addr
op_plus
id|TLAN_DIO_DATA
op_plus
l_int|2
)paren
op_lshift
l_int|16
suffix:semicolon
id|tx_under
op_assign
id|inb
c_func
(paren
id|dev-&gt;base_addr
op_plus
id|TLAN_DIO_DATA
op_plus
l_int|3
)paren
suffix:semicolon
id|outw
c_func
(paren
id|TLAN_GOOD_RX_FRMS
comma
id|dev-&gt;base_addr
op_plus
id|TLAN_DIO_ADR
)paren
suffix:semicolon
id|rx_good
op_assign
id|inb
c_func
(paren
id|dev-&gt;base_addr
op_plus
id|TLAN_DIO_DATA
)paren
suffix:semicolon
id|rx_good
op_add_assign
id|inb
c_func
(paren
id|dev-&gt;base_addr
op_plus
id|TLAN_DIO_DATA
op_plus
l_int|1
)paren
op_lshift
l_int|8
suffix:semicolon
id|rx_good
op_add_assign
id|inb
c_func
(paren
id|dev-&gt;base_addr
op_plus
id|TLAN_DIO_DATA
op_plus
l_int|2
)paren
op_lshift
l_int|16
suffix:semicolon
id|rx_over
op_assign
id|inb
c_func
(paren
id|dev-&gt;base_addr
op_plus
id|TLAN_DIO_DATA
op_plus
l_int|3
)paren
suffix:semicolon
id|outw
c_func
(paren
id|TLAN_DEFERRED_TX
comma
id|dev-&gt;base_addr
op_plus
id|TLAN_DIO_ADR
)paren
suffix:semicolon
id|def_tx
op_assign
id|inb
c_func
(paren
id|dev-&gt;base_addr
op_plus
id|TLAN_DIO_DATA
)paren
suffix:semicolon
id|def_tx
op_add_assign
id|inb
c_func
(paren
id|dev-&gt;base_addr
op_plus
id|TLAN_DIO_DATA
op_plus
l_int|1
)paren
op_lshift
l_int|8
suffix:semicolon
id|crc
op_assign
id|inb
c_func
(paren
id|dev-&gt;base_addr
op_plus
id|TLAN_DIO_DATA
op_plus
l_int|2
)paren
suffix:semicolon
id|code
op_assign
id|inb
c_func
(paren
id|dev-&gt;base_addr
op_plus
id|TLAN_DIO_DATA
op_plus
l_int|3
)paren
suffix:semicolon
id|outw
c_func
(paren
id|TLAN_MULTICOL_FRMS
comma
id|dev-&gt;base_addr
op_plus
id|TLAN_DIO_ADR
)paren
suffix:semicolon
id|multi_col
op_assign
id|inb
c_func
(paren
id|dev-&gt;base_addr
op_plus
id|TLAN_DIO_DATA
)paren
suffix:semicolon
id|multi_col
op_add_assign
id|inb
c_func
(paren
id|dev-&gt;base_addr
op_plus
id|TLAN_DIO_DATA
op_plus
l_int|1
)paren
op_lshift
l_int|8
suffix:semicolon
id|single_col
op_assign
id|inb
c_func
(paren
id|dev-&gt;base_addr
op_plus
id|TLAN_DIO_DATA
op_plus
l_int|2
)paren
suffix:semicolon
id|single_col
op_add_assign
id|inb
c_func
(paren
id|dev-&gt;base_addr
op_plus
id|TLAN_DIO_DATA
op_plus
l_int|3
)paren
op_lshift
l_int|8
suffix:semicolon
id|outw
c_func
(paren
id|TLAN_EXCESSCOL_FRMS
comma
id|dev-&gt;base_addr
op_plus
id|TLAN_DIO_ADR
)paren
suffix:semicolon
id|excess_col
op_assign
id|inb
c_func
(paren
id|dev-&gt;base_addr
op_plus
id|TLAN_DIO_DATA
)paren
suffix:semicolon
id|late_col
op_assign
id|inb
c_func
(paren
id|dev-&gt;base_addr
op_plus
id|TLAN_DIO_DATA
op_plus
l_int|1
)paren
suffix:semicolon
id|loss
op_assign
id|inb
c_func
(paren
id|dev-&gt;base_addr
op_plus
id|TLAN_DIO_DATA
op_plus
l_int|2
)paren
suffix:semicolon
r_if
c_cond
(paren
id|record
)paren
(brace
id|priv-&gt;stats.rx_packets
op_add_assign
id|rx_good
suffix:semicolon
id|priv-&gt;stats.rx_errors
op_add_assign
id|rx_over
op_plus
id|crc
op_plus
id|code
suffix:semicolon
id|priv-&gt;stats.tx_packets
op_add_assign
id|tx_good
suffix:semicolon
id|priv-&gt;stats.tx_errors
op_add_assign
id|tx_under
op_plus
id|loss
suffix:semicolon
id|priv-&gt;stats.collisions
op_add_assign
id|multi_col
op_plus
id|single_col
op_plus
id|excess_col
op_plus
id|late_col
suffix:semicolon
id|priv-&gt;stats.rx_over_errors
op_add_assign
id|rx_over
suffix:semicolon
id|priv-&gt;stats.rx_crc_errors
op_add_assign
id|crc
suffix:semicolon
id|priv-&gt;stats.rx_frame_errors
op_add_assign
id|code
suffix:semicolon
id|priv-&gt;stats.tx_aborted_errors
op_add_assign
id|tx_under
suffix:semicolon
id|priv-&gt;stats.tx_carrier_errors
op_add_assign
id|loss
suffix:semicolon
)brace
)brace
multiline_comment|/* TLan_ReadAndClearStats */
multiline_comment|/***************************************************************&n;&t; *&t;TLan_Reset&n;&t; *&n;&t; *&t;Returns:&n;&t; *&t;&t;0&n;&t; *&t;Parms:&n;&t; *&t;&t;dev&t;Pointer to device structure of adapter&n;&t; *&t;&t;&t;to be reset.&n;&t; *&n;&t; *&t;This function resets the adapter and it&squot;s physical&n;&t; *&t;device.  See Chap. 3, pp. 9-10 of the &quot;ThunderLAN&n;&t; *&t;Programmer&squot;s Guide&quot; for details.  The routine tries to&n;&t; *&t;implement what is detailed there, though adjustments&n;&t; *&t;have been made.&n;&t; *&n;&t; **************************************************************/
r_void
DECL|function|TLan_ResetAdapter
id|TLan_ResetAdapter
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
id|TLanPrivateInfo
op_star
id|priv
op_assign
(paren
id|TLanPrivateInfo
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_int
id|i
suffix:semicolon
id|u32
id|addr
suffix:semicolon
id|u32
id|data
suffix:semicolon
id|u8
id|data8
suffix:semicolon
id|priv-&gt;tlanFullDuplex
op_assign
id|FALSE
suffix:semicolon
id|priv-&gt;phyOnline
op_assign
l_int|0
suffix:semicolon
multiline_comment|/*  1.&t;Assert reset bit. */
id|data
op_assign
id|inl
c_func
(paren
id|dev-&gt;base_addr
op_plus
id|TLAN_HOST_CMD
)paren
suffix:semicolon
id|data
op_or_assign
id|TLAN_HC_AD_RST
suffix:semicolon
id|outl
c_func
(paren
id|data
comma
id|dev-&gt;base_addr
op_plus
id|TLAN_HOST_CMD
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|1000
)paren
suffix:semicolon
multiline_comment|/*  2.&t;Turn off interrupts. ( Probably isn&squot;t necessary ) */
id|data
op_assign
id|inl
c_func
(paren
id|dev-&gt;base_addr
op_plus
id|TLAN_HOST_CMD
)paren
suffix:semicolon
id|data
op_or_assign
id|TLAN_HC_INT_OFF
suffix:semicolon
id|outl
c_func
(paren
id|data
comma
id|dev-&gt;base_addr
op_plus
id|TLAN_HOST_CMD
)paren
suffix:semicolon
multiline_comment|/*  3.&t;Clear AREGs and HASHs. */
r_for
c_loop
(paren
id|i
op_assign
id|TLAN_AREG_0
suffix:semicolon
id|i
op_le
id|TLAN_HASH_2
suffix:semicolon
id|i
op_add_assign
l_int|4
)paren
(brace
id|TLan_DioWrite32
c_func
(paren
id|dev-&gt;base_addr
comma
(paren
id|u16
)paren
id|i
comma
l_int|0
)paren
suffix:semicolon
)brace
multiline_comment|/*  4.&t;Setup NetConfig register. */
id|data
op_assign
id|TLAN_NET_CFG_1FRAG
op_or
id|TLAN_NET_CFG_1CHAN
op_or
id|TLAN_NET_CFG_PHY_EN
suffix:semicolon
id|TLan_DioWrite16
c_func
(paren
id|dev-&gt;base_addr
comma
id|TLAN_NET_CONFIG
comma
(paren
id|u16
)paren
id|data
)paren
suffix:semicolon
multiline_comment|/*  5.&t;Load Ld_Tmr and Ld_Thr in HOST_CMD. */
id|outl
c_func
(paren
id|TLAN_HC_LD_TMR
op_or
l_int|0x0
comma
id|dev-&gt;base_addr
op_plus
id|TLAN_HOST_CMD
)paren
suffix:semicolon
id|outl
c_func
(paren
id|TLAN_HC_LD_THR
op_or
l_int|0x1
comma
id|dev-&gt;base_addr
op_plus
id|TLAN_HOST_CMD
)paren
suffix:semicolon
multiline_comment|/*  6.&t;Unreset the MII by setting NMRST (in NetSio) to 1. */
id|outw
c_func
(paren
id|TLAN_NET_SIO
comma
id|dev-&gt;base_addr
op_plus
id|TLAN_DIO_ADR
)paren
suffix:semicolon
id|addr
op_assign
id|dev-&gt;base_addr
op_plus
id|TLAN_DIO_DATA
op_plus
id|TLAN_NET_SIO
suffix:semicolon
id|TLan_SetBit
c_func
(paren
id|TLAN_NET_SIO_NMRST
comma
id|addr
)paren
suffix:semicolon
multiline_comment|/*  7.&t;Setup the remaining registers. */
r_if
c_cond
(paren
id|priv-&gt;tlanRev
op_ge
l_int|0x30
)paren
(brace
id|data8
op_assign
id|TLAN_ID_TX_EOC
op_or
id|TLAN_ID_RX_EOC
suffix:semicolon
id|TLan_DioWrite8
c_func
(paren
id|dev-&gt;base_addr
comma
id|TLAN_INT_DIS
comma
id|data8
)paren
suffix:semicolon
)brace
id|TLan_PhyDetect
c_func
(paren
id|dev
)paren
suffix:semicolon
id|data
op_assign
id|TLAN_NET_CFG_1FRAG
op_or
id|TLAN_NET_CFG_1CHAN
suffix:semicolon
r_if
c_cond
(paren
id|priv-&gt;adapter-&gt;flags
op_amp
id|TLAN_ADAPTER_BIT_RATE_PHY
)paren
(brace
id|data
op_or_assign
id|TLAN_NET_CFG_BIT
suffix:semicolon
r_if
c_cond
(paren
id|priv-&gt;aui
op_eq
l_int|1
)paren
(brace
id|TLan_DioWrite8
c_func
(paren
id|dev-&gt;base_addr
comma
id|TLAN_ACOMMIT
comma
l_int|0x0a
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|priv-&gt;duplex
op_eq
id|TLAN_DUPLEX_FULL
)paren
(brace
id|TLan_DioWrite8
c_func
(paren
id|dev-&gt;base_addr
comma
id|TLAN_ACOMMIT
comma
l_int|0x00
)paren
suffix:semicolon
id|priv-&gt;tlanFullDuplex
op_assign
id|TRUE
suffix:semicolon
)brace
r_else
(brace
id|TLan_DioWrite8
c_func
(paren
id|dev-&gt;base_addr
comma
id|TLAN_ACOMMIT
comma
l_int|0x08
)paren
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|priv-&gt;phyNum
op_eq
l_int|0
)paren
(brace
id|data
op_or_assign
id|TLAN_NET_CFG_PHY_EN
suffix:semicolon
)brace
id|TLan_DioWrite16
c_func
(paren
id|dev-&gt;base_addr
comma
id|TLAN_NET_CONFIG
comma
(paren
id|u16
)paren
id|data
)paren
suffix:semicolon
r_if
c_cond
(paren
id|priv-&gt;adapter-&gt;flags
op_amp
id|TLAN_ADAPTER_UNMANAGED_PHY
)paren
(brace
id|TLan_FinishReset
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
r_else
(brace
id|TLan_PhyPowerDown
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* TLan_ResetAdapter */
r_void
DECL|function|TLan_FinishReset
id|TLan_FinishReset
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
id|TLanPrivateInfo
op_star
id|priv
op_assign
(paren
id|TLanPrivateInfo
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|u8
id|data
suffix:semicolon
id|u32
id|phy
suffix:semicolon
id|u8
id|sio
suffix:semicolon
id|u16
id|status
suffix:semicolon
id|u16
id|partner
suffix:semicolon
id|u16
id|tlphy_ctl
suffix:semicolon
id|u16
id|tlphy_par
suffix:semicolon
id|u16
id|tlphy_id1
comma
id|tlphy_id2
suffix:semicolon
r_int
id|i
suffix:semicolon
id|phy
op_assign
id|priv-&gt;phy
(braket
id|priv-&gt;phyNum
)braket
suffix:semicolon
id|data
op_assign
id|TLAN_NET_CMD_NRESET
op_or
id|TLAN_NET_CMD_NWRAP
suffix:semicolon
r_if
c_cond
(paren
id|priv-&gt;tlanFullDuplex
)paren
(brace
id|data
op_or_assign
id|TLAN_NET_CMD_DUPLEX
suffix:semicolon
)brace
id|TLan_DioWrite8
c_func
(paren
id|dev-&gt;base_addr
comma
id|TLAN_NET_CMD
comma
id|data
)paren
suffix:semicolon
id|data
op_assign
id|TLAN_NET_MASK_MASK4
op_or
id|TLAN_NET_MASK_MASK5
suffix:semicolon
r_if
c_cond
(paren
id|priv-&gt;phyNum
op_eq
l_int|0
)paren
(brace
id|data
op_or_assign
id|TLAN_NET_MASK_MASK7
suffix:semicolon
)brace
id|TLan_DioWrite8
c_func
(paren
id|dev-&gt;base_addr
comma
id|TLAN_NET_MASK
comma
id|data
)paren
suffix:semicolon
id|TLan_DioWrite16
c_func
(paren
id|dev-&gt;base_addr
comma
id|TLAN_MAX_RX
comma
id|TLAN_MAX_FRAME_SIZE
)paren
suffix:semicolon
id|TLan_MiiReadReg
c_func
(paren
id|dev
comma
id|phy
comma
id|MII_GEN_ID_HI
comma
op_amp
id|tlphy_id1
)paren
suffix:semicolon
id|TLan_MiiReadReg
c_func
(paren
id|dev
comma
id|phy
comma
id|MII_GEN_ID_LO
comma
op_amp
id|tlphy_id2
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|priv-&gt;adapter-&gt;flags
op_amp
id|TLAN_ADAPTER_UNMANAGED_PHY
)paren
op_logical_or
(paren
id|priv-&gt;aui
)paren
)paren
(brace
id|status
op_assign
id|MII_GS_LINK
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;TLAN:  %s: Link forced.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
)brace
r_else
(brace
id|TLan_MiiReadReg
c_func
(paren
id|dev
comma
id|phy
comma
id|MII_GEN_STS
comma
op_amp
id|status
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|1000
)paren
suffix:semicolon
id|TLan_MiiReadReg
c_func
(paren
id|dev
comma
id|phy
comma
id|MII_GEN_STS
comma
op_amp
id|status
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|status
op_amp
id|MII_GS_LINK
)paren
op_logical_and
multiline_comment|/* We only support link info on Nat.Sem. PHY&squot;s */
(paren
id|tlphy_id1
op_eq
id|NAT_SEM_ID1
)paren
op_logical_and
(paren
id|tlphy_id2
op_eq
id|NAT_SEM_ID2
)paren
)paren
(brace
id|TLan_MiiReadReg
c_func
(paren
id|dev
comma
id|phy
comma
id|MII_AN_LPA
comma
op_amp
id|partner
)paren
suffix:semicolon
id|TLan_MiiReadReg
c_func
(paren
id|dev
comma
id|phy
comma
id|TLAN_TLPHY_PAR
comma
op_amp
id|tlphy_par
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;TLAN: %s: Link active with &quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|tlphy_par
op_amp
id|TLAN_PHY_AN_EN_STAT
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;forced 10%sMbps %s-Duplex&bslash;n&quot;
comma
id|tlphy_par
op_amp
id|TLAN_PHY_SPEED_100
ques
c_cond
l_string|&quot;&quot;
suffix:colon
l_string|&quot;0&quot;
comma
id|tlphy_par
op_amp
id|TLAN_PHY_DUPLEX_FULL
ques
c_cond
l_string|&quot;Full&quot;
suffix:colon
l_string|&quot;Half&quot;
)paren
suffix:semicolon
)brace
r_else
(brace
id|printk
c_func
(paren
l_string|&quot;AutoNegotiation enabled, at 10%sMbps %s-Duplex&bslash;n&quot;
comma
id|tlphy_par
op_amp
id|TLAN_PHY_SPEED_100
ques
c_cond
l_string|&quot;&quot;
suffix:colon
l_string|&quot;0&quot;
comma
id|tlphy_par
op_amp
id|TLAN_PHY_DUPLEX_FULL
ques
c_cond
l_string|&quot;Full&quot;
suffix:colon
l_string|&quot;Half&quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;TLAN: Partner capability: &quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|5
suffix:semicolon
id|i
op_le
l_int|10
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
id|partner
op_amp
(paren
l_int|1
op_lshift
id|i
)paren
)paren
id|printk
c_func
(paren
l_string|&quot;%s&quot;
comma
id|media
(braket
id|i
op_minus
l_int|5
)braket
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
)brace
id|TLan_DioWrite8
c_func
(paren
id|dev-&gt;base_addr
comma
id|TLAN_LED_REG
comma
id|TLAN_LED_LINK
)paren
suffix:semicolon
macro_line|#ifdef MONITOR&t;&t;&t;
multiline_comment|/* We have link beat..for now anyway */
id|priv-&gt;link
op_assign
l_int|1
suffix:semicolon
multiline_comment|/*Enabling link beat monitoring */
id|TLan_SetTimer
c_func
(paren
id|dev
comma
(paren
l_int|10
op_star
id|HZ
)paren
comma
id|TLAN_TIMER_LINK_BEAT
)paren
suffix:semicolon
macro_line|#endif 
)brace
r_else
r_if
c_cond
(paren
id|status
op_amp
id|MII_GS_LINK
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;TLAN: %s: Link active&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|TLan_DioWrite8
c_func
(paren
id|dev-&gt;base_addr
comma
id|TLAN_LED_REG
comma
id|TLAN_LED_LINK
)paren
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|priv-&gt;phyNum
op_eq
l_int|0
)paren
(brace
id|TLan_MiiReadReg
c_func
(paren
id|dev
comma
id|phy
comma
id|TLAN_TLPHY_CTL
comma
op_amp
id|tlphy_ctl
)paren
suffix:semicolon
id|tlphy_ctl
op_or_assign
id|TLAN_TC_INTEN
suffix:semicolon
id|TLan_MiiWriteReg
c_func
(paren
id|dev
comma
id|phy
comma
id|TLAN_TLPHY_CTL
comma
id|tlphy_ctl
)paren
suffix:semicolon
id|sio
op_assign
id|TLan_DioRead8
c_func
(paren
id|dev-&gt;base_addr
comma
id|TLAN_NET_SIO
)paren
suffix:semicolon
id|sio
op_or_assign
id|TLAN_NET_SIO_MINTEN
suffix:semicolon
id|TLan_DioWrite8
c_func
(paren
id|dev-&gt;base_addr
comma
id|TLAN_NET_SIO
comma
id|sio
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|status
op_amp
id|MII_GS_LINK
)paren
(brace
id|TLan_SetMac
c_func
(paren
id|dev
comma
l_int|0
comma
id|dev-&gt;dev_addr
)paren
suffix:semicolon
id|priv-&gt;phyOnline
op_assign
l_int|1
suffix:semicolon
id|outb
c_func
(paren
(paren
id|TLAN_HC_INT_ON
op_rshift
l_int|8
)paren
comma
id|dev-&gt;base_addr
op_plus
id|TLAN_HOST_CMD
op_plus
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|debug
op_ge
l_int|1
op_logical_and
id|debug
op_ne
id|TLAN_DEBUG_PROBE
)paren
(brace
id|outb
c_func
(paren
(paren
id|TLAN_HC_REQ_INT
op_rshift
l_int|8
)paren
comma
id|dev-&gt;base_addr
op_plus
id|TLAN_HOST_CMD
op_plus
l_int|1
)paren
suffix:semicolon
)brace
id|outl
c_func
(paren
id|virt_to_bus
c_func
(paren
id|priv-&gt;rxList
)paren
comma
id|dev-&gt;base_addr
op_plus
id|TLAN_CH_PARM
)paren
suffix:semicolon
id|outl
c_func
(paren
id|TLAN_HC_GO
op_or
id|TLAN_HC_RT
comma
id|dev-&gt;base_addr
op_plus
id|TLAN_HOST_CMD
)paren
suffix:semicolon
)brace
r_else
(brace
id|printk
c_func
(paren
l_string|&quot;TLAN: %s: Link inactive, will retry in 10 secs...&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|TLan_SetTimer
c_func
(paren
id|dev
comma
(paren
l_int|10
op_star
id|HZ
)paren
comma
id|TLAN_TIMER_FINISH_RESET
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
)brace
multiline_comment|/* TLan_FinishReset */
multiline_comment|/***************************************************************&n;&t; *&t;TLan_SetMac&n;&t; *&n;&t; *&t;Returns:&n;&t; *&t;&t;Nothing&n;&t; *&t;Parms:&n;&t; *&t;&t;dev&t;Pointer to device structure of adapter&n;&t; *&t;&t;&t;on which to change the AREG.&n;&t; *&t;&t;areg&t;The AREG to set the address in (0 - 3).&n;&t; *&t;&t;mac&t;A pointer to an array of chars.  Each&n;&t; *&t;&t;&t;element stores one byte of the address.&n;&t; *&t;&t;&t;IE, it isn&squot;t in ascii.&n;&t; *&n;&t; *&t;This function transfers a MAC address to one of the&n;&t; *&t;TLAN AREGs (address registers).  The TLAN chip locks&n;&t; *&t;the register on writing to offset 0 and unlocks the&n;&t; *&t;register after writing to offset 5.  If NULL is passed&n;&t; *&t;in mac, then the AREG is filled with 0&squot;s.&n;&t; *&n;&t; **************************************************************/
DECL|function|TLan_SetMac
r_void
id|TLan_SetMac
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_int
id|areg
comma
r_char
op_star
id|mac
)paren
(brace
r_int
id|i
suffix:semicolon
id|areg
op_mul_assign
l_int|6
suffix:semicolon
r_if
c_cond
(paren
id|mac
op_ne
l_int|NULL
)paren
(brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|6
suffix:semicolon
id|i
op_increment
)paren
id|TLan_DioWrite8
c_func
(paren
id|dev-&gt;base_addr
comma
id|TLAN_AREG_0
op_plus
id|areg
op_plus
id|i
comma
id|mac
(braket
id|i
)braket
)paren
suffix:semicolon
)brace
r_else
(brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|6
suffix:semicolon
id|i
op_increment
)paren
id|TLan_DioWrite8
c_func
(paren
id|dev-&gt;base_addr
comma
id|TLAN_AREG_0
op_plus
id|areg
op_plus
id|i
comma
l_int|0
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* TLan_SetMac */
multiline_comment|/*****************************************************************************&n;******************************************************************************&n;&n;&t;ThunderLAN Driver PHY Layer Routines&n;&n;******************************************************************************&n;*****************************************************************************/
multiline_comment|/*********************************************************************&n;&t; *&t;TLan_PhyPrint&n;&t; *&n;&t; *&t;Returns:&n;&t; *&t;&t;Nothing&n;&t; *&t;Parms:&n;&t; *&t;&t;dev&t;A pointer to the device structure of the&n;&t; *&t;&t;&t;TLAN device having the PHYs to be detailed.&n;&t; *&t;&t;&t;&t;&n;&t; *&t;This function prints the registers a PHY (aka tranceiver).&n;&t; *&n;&t; ********************************************************************/
DECL|function|TLan_PhyPrint
r_void
id|TLan_PhyPrint
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
id|TLanPrivateInfo
op_star
id|priv
op_assign
(paren
id|TLanPrivateInfo
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|u16
id|i
comma
id|data0
comma
id|data1
comma
id|data2
comma
id|data3
comma
id|phy
suffix:semicolon
id|phy
op_assign
id|priv-&gt;phy
(braket
id|priv-&gt;phyNum
)braket
suffix:semicolon
r_if
c_cond
(paren
id|priv-&gt;adapter-&gt;flags
op_amp
id|TLAN_ADAPTER_UNMANAGED_PHY
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;TLAN:   Device %s, Unmanaged PHY.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|phy
op_le
id|TLAN_PHY_MAX_ADDR
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;TLAN:   Device %s, PHY 0x%02x.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|phy
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;TLAN:      Off.  +0     +1     +2     +3 &bslash;n&quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|0x20
suffix:semicolon
id|i
op_add_assign
l_int|4
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;TLAN:      0x%02x&quot;
comma
id|i
)paren
suffix:semicolon
id|TLan_MiiReadReg
c_func
(paren
id|dev
comma
id|phy
comma
id|i
comma
op_amp
id|data0
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot; 0x%04hx&quot;
comma
id|data0
)paren
suffix:semicolon
id|TLan_MiiReadReg
c_func
(paren
id|dev
comma
id|phy
comma
id|i
op_plus
l_int|1
comma
op_amp
id|data1
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot; 0x%04hx&quot;
comma
id|data1
)paren
suffix:semicolon
id|TLan_MiiReadReg
c_func
(paren
id|dev
comma
id|phy
comma
id|i
op_plus
l_int|2
comma
op_amp
id|data2
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot; 0x%04hx&quot;
comma
id|data2
)paren
suffix:semicolon
id|TLan_MiiReadReg
c_func
(paren
id|dev
comma
id|phy
comma
id|i
op_plus
l_int|3
comma
op_amp
id|data3
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot; 0x%04hx&bslash;n&quot;
comma
id|data3
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
id|printk
c_func
(paren
l_string|&quot;TLAN:   Device %s, Invalid PHY.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* TLan_PhyPrint */
multiline_comment|/*********************************************************************&n;&t; *&t;TLan_PhyDetect&n;&t; *&n;&t; *&t;Returns:&n;&t; *&t;&t;Nothing&n;&t; *&t;Parms:&n;&t; *&t;&t;dev&t;A pointer to the device structure of the adapter&n;&t; *&t;&t;&t;for which the PHY needs determined.&n;&t; *&n;&t; *&t;So far I&squot;ve found that adapters which have external PHYs&n;&t; *&t;may also use the internal PHY for part of the functionality.&n;&t; *&t;(eg, AUI/Thinnet).  This function finds out if this TLAN&n;&t; *&t;chip has an internal PHY, and then finds the first external&n;&t; *&t;PHY (starting from address 0) if it exists).&n;&t; *&n;&t; ********************************************************************/
DECL|function|TLan_PhyDetect
r_void
id|TLan_PhyDetect
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
id|TLanPrivateInfo
op_star
id|priv
op_assign
(paren
id|TLanPrivateInfo
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|u16
id|control
suffix:semicolon
id|u16
id|hi
suffix:semicolon
id|u16
id|lo
suffix:semicolon
id|u32
id|phy
suffix:semicolon
r_if
c_cond
(paren
id|priv-&gt;adapter-&gt;flags
op_amp
id|TLAN_ADAPTER_UNMANAGED_PHY
)paren
(brace
id|priv-&gt;phyNum
op_assign
l_int|0xFFFF
suffix:semicolon
r_return
suffix:semicolon
)brace
id|TLan_MiiReadReg
c_func
(paren
id|dev
comma
id|TLAN_PHY_MAX_ADDR
comma
id|MII_GEN_ID_HI
comma
op_amp
id|hi
)paren
suffix:semicolon
r_if
c_cond
(paren
id|hi
op_ne
l_int|0xFFFF
)paren
(brace
id|priv-&gt;phy
(braket
l_int|0
)braket
op_assign
id|TLAN_PHY_MAX_ADDR
suffix:semicolon
)brace
r_else
(brace
id|priv-&gt;phy
(braket
l_int|0
)braket
op_assign
id|TLAN_PHY_NONE
suffix:semicolon
)brace
id|priv-&gt;phy
(braket
l_int|1
)braket
op_assign
id|TLAN_PHY_NONE
suffix:semicolon
r_for
c_loop
(paren
id|phy
op_assign
l_int|0
suffix:semicolon
id|phy
op_le
id|TLAN_PHY_MAX_ADDR
suffix:semicolon
id|phy
op_increment
)paren
(brace
id|TLan_MiiReadReg
c_func
(paren
id|dev
comma
id|phy
comma
id|MII_GEN_CTL
comma
op_amp
id|control
)paren
suffix:semicolon
id|TLan_MiiReadReg
c_func
(paren
id|dev
comma
id|phy
comma
id|MII_GEN_ID_HI
comma
op_amp
id|hi
)paren
suffix:semicolon
id|TLan_MiiReadReg
c_func
(paren
id|dev
comma
id|phy
comma
id|MII_GEN_ID_LO
comma
op_amp
id|lo
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|control
op_ne
l_int|0xFFFF
)paren
op_logical_or
(paren
id|hi
op_ne
l_int|0xFFFF
)paren
op_logical_or
(paren
id|lo
op_ne
l_int|0xFFFF
)paren
)paren
(brace
id|TLAN_DBG
c_func
(paren
id|TLAN_DEBUG_GNRL
comma
l_string|&quot;PHY found at %02x %04x %04x %04x&bslash;n&quot;
comma
id|phy
comma
id|control
comma
id|hi
comma
id|lo
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|priv-&gt;phy
(braket
l_int|1
)braket
op_eq
id|TLAN_PHY_NONE
)paren
op_logical_and
(paren
id|phy
op_ne
id|TLAN_PHY_MAX_ADDR
)paren
)paren
(brace
id|priv-&gt;phy
(braket
l_int|1
)braket
op_assign
id|phy
suffix:semicolon
)brace
)brace
)brace
r_if
c_cond
(paren
id|priv-&gt;phy
(braket
l_int|1
)braket
op_ne
id|TLAN_PHY_NONE
)paren
(brace
id|priv-&gt;phyNum
op_assign
l_int|1
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|priv-&gt;phy
(braket
l_int|0
)braket
op_ne
id|TLAN_PHY_NONE
)paren
(brace
id|priv-&gt;phyNum
op_assign
l_int|0
suffix:semicolon
)brace
r_else
(brace
id|printk
c_func
(paren
l_string|&quot;TLAN:  Cannot initialize device, no PHY was found!&bslash;n&quot;
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* TLan_PhyDetect */
DECL|function|TLan_PhyPowerDown
r_void
id|TLan_PhyPowerDown
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
id|TLanPrivateInfo
op_star
id|priv
op_assign
(paren
id|TLanPrivateInfo
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|u16
id|value
suffix:semicolon
id|TLAN_DBG
c_func
(paren
id|TLAN_DEBUG_GNRL
comma
l_string|&quot;%s: Powering down PHY(s).&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|value
op_assign
id|MII_GC_PDOWN
op_or
id|MII_GC_LOOPBK
op_or
id|MII_GC_ISOLATE
suffix:semicolon
id|TLan_MiiSync
c_func
(paren
id|dev-&gt;base_addr
)paren
suffix:semicolon
id|TLan_MiiWriteReg
c_func
(paren
id|dev
comma
id|priv-&gt;phy
(braket
id|priv-&gt;phyNum
)braket
comma
id|MII_GEN_CTL
comma
id|value
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|priv-&gt;phyNum
op_eq
l_int|0
)paren
op_logical_and
(paren
id|priv-&gt;phy
(braket
l_int|1
)braket
op_ne
id|TLAN_PHY_NONE
)paren
op_logical_and
(paren
op_logical_neg
(paren
id|priv-&gt;adapter-&gt;flags
op_amp
id|TLAN_ADAPTER_USE_INTERN_10
)paren
)paren
)paren
(brace
id|TLan_MiiSync
c_func
(paren
id|dev-&gt;base_addr
)paren
suffix:semicolon
id|TLan_MiiWriteReg
c_func
(paren
id|dev
comma
id|priv-&gt;phy
(braket
l_int|1
)braket
comma
id|MII_GEN_CTL
comma
id|value
)paren
suffix:semicolon
)brace
multiline_comment|/* Wait for 50 ms and powerup&n;&t; * This is abitrary.  It is intended to make sure the&n;&t; * tranceiver settles.&n;&t; */
id|TLan_SetTimer
c_func
(paren
id|dev
comma
(paren
id|HZ
op_div
l_int|20
)paren
comma
id|TLAN_TIMER_PHY_PUP
)paren
suffix:semicolon
)brace
multiline_comment|/* TLan_PhyPowerDown */
DECL|function|TLan_PhyPowerUp
r_void
id|TLan_PhyPowerUp
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
id|TLanPrivateInfo
op_star
id|priv
op_assign
(paren
id|TLanPrivateInfo
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|u16
id|value
suffix:semicolon
id|TLAN_DBG
c_func
(paren
id|TLAN_DEBUG_GNRL
comma
l_string|&quot;%s: Powering up PHY.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|TLan_MiiSync
c_func
(paren
id|dev-&gt;base_addr
)paren
suffix:semicolon
id|value
op_assign
id|MII_GC_LOOPBK
suffix:semicolon
id|TLan_MiiWriteReg
c_func
(paren
id|dev
comma
id|priv-&gt;phy
(braket
id|priv-&gt;phyNum
)braket
comma
id|MII_GEN_CTL
comma
id|value
)paren
suffix:semicolon
id|TLan_MiiSync
c_func
(paren
id|dev-&gt;base_addr
)paren
suffix:semicolon
multiline_comment|/* Wait for 500 ms and reset the&n;&t; * tranceiver.  The TLAN docs say both 50 ms and&n;&t; * 500 ms, so do the longer, just in case.&n;&t; */
id|TLan_SetTimer
c_func
(paren
id|dev
comma
(paren
id|HZ
op_div
l_int|20
)paren
comma
id|TLAN_TIMER_PHY_RESET
)paren
suffix:semicolon
)brace
multiline_comment|/* TLan_PhyPowerUp */
DECL|function|TLan_PhyReset
r_void
id|TLan_PhyReset
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
id|TLanPrivateInfo
op_star
id|priv
op_assign
(paren
id|TLanPrivateInfo
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|u16
id|phy
suffix:semicolon
id|u16
id|value
suffix:semicolon
id|phy
op_assign
id|priv-&gt;phy
(braket
id|priv-&gt;phyNum
)braket
suffix:semicolon
id|TLAN_DBG
c_func
(paren
id|TLAN_DEBUG_GNRL
comma
l_string|&quot;%s: Reseting PHY.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|TLan_MiiSync
c_func
(paren
id|dev-&gt;base_addr
)paren
suffix:semicolon
id|value
op_assign
id|MII_GC_LOOPBK
op_or
id|MII_GC_RESET
suffix:semicolon
id|TLan_MiiWriteReg
c_func
(paren
id|dev
comma
id|phy
comma
id|MII_GEN_CTL
comma
id|value
)paren
suffix:semicolon
id|TLan_MiiReadReg
c_func
(paren
id|dev
comma
id|phy
comma
id|MII_GEN_CTL
comma
op_amp
id|value
)paren
suffix:semicolon
r_while
c_loop
(paren
id|value
op_amp
id|MII_GC_RESET
)paren
(brace
id|TLan_MiiReadReg
c_func
(paren
id|dev
comma
id|phy
comma
id|MII_GEN_CTL
comma
op_amp
id|value
)paren
suffix:semicolon
)brace
multiline_comment|/* Wait for 500 ms and initialize.&n;&t; * I don&squot;t remember why I wait this long.&n;&t; * I&squot;ve changed this to 50ms, as it seems long enough.&n;&t; */
id|TLan_SetTimer
c_func
(paren
id|dev
comma
(paren
id|HZ
op_div
l_int|20
)paren
comma
id|TLAN_TIMER_PHY_START_LINK
)paren
suffix:semicolon
)brace
multiline_comment|/* TLan_PhyReset */
DECL|function|TLan_PhyStartLink
r_void
id|TLan_PhyStartLink
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
id|TLanPrivateInfo
op_star
id|priv
op_assign
(paren
id|TLanPrivateInfo
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|u16
id|ability
suffix:semicolon
id|u16
id|control
suffix:semicolon
id|u16
id|data
suffix:semicolon
id|u16
id|phy
suffix:semicolon
id|u16
id|status
suffix:semicolon
id|u16
id|tctl
suffix:semicolon
id|phy
op_assign
id|priv-&gt;phy
(braket
id|priv-&gt;phyNum
)braket
suffix:semicolon
id|TLAN_DBG
c_func
(paren
id|TLAN_DEBUG_GNRL
comma
l_string|&quot;%s: Trying to activate link.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|TLan_MiiReadReg
c_func
(paren
id|dev
comma
id|phy
comma
id|MII_GEN_STS
comma
op_amp
id|status
)paren
suffix:semicolon
id|TLan_MiiReadReg
c_func
(paren
id|dev
comma
id|phy
comma
id|MII_GEN_STS
comma
op_amp
id|ability
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|status
op_amp
id|MII_GS_AUTONEG
)paren
op_logical_and
(paren
op_logical_neg
id|priv-&gt;aui
)paren
)paren
(brace
id|ability
op_assign
id|status
op_rshift
l_int|11
suffix:semicolon
r_if
c_cond
(paren
id|priv-&gt;speed
op_eq
id|TLAN_SPEED_10
op_logical_and
id|priv-&gt;duplex
op_eq
id|TLAN_DUPLEX_HALF
)paren
(brace
id|TLan_MiiWriteReg
c_func
(paren
id|dev
comma
id|phy
comma
id|MII_GEN_CTL
comma
l_int|0x0000
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|priv-&gt;speed
op_eq
id|TLAN_SPEED_10
op_logical_and
id|priv-&gt;duplex
op_eq
id|TLAN_DUPLEX_FULL
)paren
(brace
id|priv-&gt;tlanFullDuplex
op_assign
id|TRUE
suffix:semicolon
id|TLan_MiiWriteReg
c_func
(paren
id|dev
comma
id|phy
comma
id|MII_GEN_CTL
comma
l_int|0x0100
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|priv-&gt;speed
op_eq
id|TLAN_SPEED_100
op_logical_and
id|priv-&gt;duplex
op_eq
id|TLAN_DUPLEX_HALF
)paren
(brace
id|TLan_MiiWriteReg
c_func
(paren
id|dev
comma
id|phy
comma
id|MII_GEN_CTL
comma
l_int|0x2000
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|priv-&gt;speed
op_eq
id|TLAN_SPEED_100
op_logical_and
id|priv-&gt;duplex
op_eq
id|TLAN_DUPLEX_FULL
)paren
(brace
id|priv-&gt;tlanFullDuplex
op_assign
id|TRUE
suffix:semicolon
id|TLan_MiiWriteReg
c_func
(paren
id|dev
comma
id|phy
comma
id|MII_GEN_CTL
comma
l_int|0x2100
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* Set Auto-Neg advertisement */
id|TLan_MiiWriteReg
c_func
(paren
id|dev
comma
id|phy
comma
id|MII_AN_ADV
comma
(paren
id|ability
op_lshift
l_int|5
)paren
op_or
l_int|1
)paren
suffix:semicolon
multiline_comment|/* Enablee Auto-Neg */
id|TLan_MiiWriteReg
c_func
(paren
id|dev
comma
id|phy
comma
id|MII_GEN_CTL
comma
l_int|0x1000
)paren
suffix:semicolon
multiline_comment|/* Restart Auto-Neg */
id|TLan_MiiWriteReg
c_func
(paren
id|dev
comma
id|phy
comma
id|MII_GEN_CTL
comma
l_int|0x1200
)paren
suffix:semicolon
multiline_comment|/* Wait for 4 sec for autonegotiation&n;&t;&t; &t;* to complete.  The max spec time is less than this&n;&t;&t; &t;* but the card need additional time to start AN.&n;&t;&t; &t;* .5 sec should be plenty extra.&n;&t;&t; &t;*/
id|printk
c_func
(paren
l_string|&quot;TLAN: %s: Starting autonegotiation.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|TLan_SetTimer
c_func
(paren
id|dev
comma
(paren
l_int|2
op_star
id|HZ
)paren
comma
id|TLAN_TIMER_PHY_FINISH_AN
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
(paren
id|priv-&gt;aui
)paren
op_logical_and
(paren
id|priv-&gt;phyNum
op_ne
l_int|0
)paren
)paren
(brace
id|priv-&gt;phyNum
op_assign
l_int|0
suffix:semicolon
id|data
op_assign
id|TLAN_NET_CFG_1FRAG
op_or
id|TLAN_NET_CFG_1CHAN
op_or
id|TLAN_NET_CFG_PHY_EN
suffix:semicolon
id|TLan_DioWrite16
c_func
(paren
id|dev-&gt;base_addr
comma
id|TLAN_NET_CONFIG
comma
id|data
)paren
suffix:semicolon
id|TLan_SetTimer
c_func
(paren
id|dev
comma
(paren
l_int|40
op_star
id|HZ
op_div
l_int|1000
)paren
comma
id|TLAN_TIMER_PHY_PDOWN
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|priv-&gt;phyNum
op_eq
l_int|0
)paren
(brace
id|TLan_MiiReadReg
c_func
(paren
id|dev
comma
id|phy
comma
id|TLAN_TLPHY_CTL
comma
op_amp
id|tctl
)paren
suffix:semicolon
r_if
c_cond
(paren
id|priv-&gt;aui
)paren
(brace
id|tctl
op_or_assign
id|TLAN_TC_AUISEL
suffix:semicolon
)brace
r_else
(brace
id|tctl
op_and_assign
op_complement
id|TLAN_TC_AUISEL
suffix:semicolon
id|control
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|priv-&gt;duplex
op_eq
id|TLAN_DUPLEX_FULL
)paren
(brace
id|control
op_or_assign
id|MII_GC_DUPLEX
suffix:semicolon
id|priv-&gt;tlanFullDuplex
op_assign
id|TRUE
suffix:semicolon
)brace
r_if
c_cond
(paren
id|priv-&gt;speed
op_eq
id|TLAN_SPEED_100
)paren
(brace
id|control
op_or_assign
id|MII_GC_SPEEDSEL
suffix:semicolon
)brace
id|TLan_MiiWriteReg
c_func
(paren
id|dev
comma
id|phy
comma
id|MII_GEN_CTL
comma
id|control
)paren
suffix:semicolon
)brace
id|TLan_MiiWriteReg
c_func
(paren
id|dev
comma
id|phy
comma
id|TLAN_TLPHY_CTL
comma
id|tctl
)paren
suffix:semicolon
)brace
multiline_comment|/* Wait for 2 sec to give the tranceiver time&n;&t; * to establish link.&n;&t; */
id|TLan_SetTimer
c_func
(paren
id|dev
comma
(paren
l_int|4
op_star
id|HZ
)paren
comma
id|TLAN_TIMER_FINISH_RESET
)paren
suffix:semicolon
)brace
multiline_comment|/* TLan_PhyStartLink */
DECL|function|TLan_PhyFinishAutoNeg
r_void
id|TLan_PhyFinishAutoNeg
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
id|TLanPrivateInfo
op_star
id|priv
op_assign
(paren
id|TLanPrivateInfo
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|u16
id|an_adv
suffix:semicolon
id|u16
id|an_lpa
suffix:semicolon
id|u16
id|data
suffix:semicolon
id|u16
id|mode
suffix:semicolon
id|u16
id|phy
suffix:semicolon
id|u16
id|status
suffix:semicolon
id|phy
op_assign
id|priv-&gt;phy
(braket
id|priv-&gt;phyNum
)braket
suffix:semicolon
id|TLan_MiiReadReg
c_func
(paren
id|dev
comma
id|phy
comma
id|MII_GEN_STS
comma
op_amp
id|status
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|1000
)paren
suffix:semicolon
id|TLan_MiiReadReg
c_func
(paren
id|dev
comma
id|phy
comma
id|MII_GEN_STS
comma
op_amp
id|status
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|status
op_amp
id|MII_GS_AUTOCMPLT
)paren
)paren
(brace
multiline_comment|/* Wait for 8 sec to give the process&n;&t;&t; * more time.  Perhaps we should fail after a while.&n;&t;&t; */
id|printk
c_func
(paren
l_string|&quot;TLAN: Giving autonegotiation more time.&bslash;n&quot;
)paren
suffix:semicolon
id|TLan_SetTimer
c_func
(paren
id|dev
comma
(paren
l_int|8
op_star
id|HZ
)paren
comma
id|TLAN_TIMER_PHY_FINISH_AN
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;TLAN: %s: Autonegotiation complete.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|TLan_MiiReadReg
c_func
(paren
id|dev
comma
id|phy
comma
id|MII_AN_ADV
comma
op_amp
id|an_adv
)paren
suffix:semicolon
id|TLan_MiiReadReg
c_func
(paren
id|dev
comma
id|phy
comma
id|MII_AN_LPA
comma
op_amp
id|an_lpa
)paren
suffix:semicolon
id|mode
op_assign
id|an_adv
op_amp
id|an_lpa
op_amp
l_int|0x03E0
suffix:semicolon
r_if
c_cond
(paren
id|mode
op_amp
l_int|0x0100
)paren
(brace
id|priv-&gt;tlanFullDuplex
op_assign
id|TRUE
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
op_logical_neg
(paren
id|mode
op_amp
l_int|0x0080
)paren
op_logical_and
(paren
id|mode
op_amp
l_int|0x0040
)paren
)paren
(brace
id|priv-&gt;tlanFullDuplex
op_assign
id|TRUE
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
op_logical_neg
(paren
id|mode
op_amp
l_int|0x0180
)paren
)paren
op_logical_and
(paren
id|priv-&gt;adapter-&gt;flags
op_amp
id|TLAN_ADAPTER_USE_INTERN_10
)paren
op_logical_and
(paren
id|priv-&gt;phyNum
op_ne
l_int|0
)paren
)paren
(brace
id|priv-&gt;phyNum
op_assign
l_int|0
suffix:semicolon
id|data
op_assign
id|TLAN_NET_CFG_1FRAG
op_or
id|TLAN_NET_CFG_1CHAN
op_or
id|TLAN_NET_CFG_PHY_EN
suffix:semicolon
id|TLan_DioWrite16
c_func
(paren
id|dev-&gt;base_addr
comma
id|TLAN_NET_CONFIG
comma
id|data
)paren
suffix:semicolon
id|TLan_SetTimer
c_func
(paren
id|dev
comma
(paren
l_int|400
op_star
id|HZ
op_div
l_int|1000
)paren
comma
id|TLAN_TIMER_PHY_PDOWN
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|priv-&gt;phyNum
op_eq
l_int|0
)paren
(brace
r_if
c_cond
(paren
(paren
id|priv-&gt;duplex
op_eq
id|TLAN_DUPLEX_FULL
)paren
op_logical_or
(paren
id|an_adv
op_amp
id|an_lpa
op_amp
l_int|0x0040
)paren
)paren
(brace
id|TLan_MiiWriteReg
c_func
(paren
id|dev
comma
id|phy
comma
id|MII_GEN_CTL
comma
id|MII_GC_AUTOENB
op_or
id|MII_GC_DUPLEX
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;TLAN:  Starting internal PHY with FULL-DUPLEX&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_else
(brace
id|TLan_MiiWriteReg
c_func
(paren
id|dev
comma
id|phy
comma
id|MII_GEN_CTL
comma
id|MII_GC_AUTOENB
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;TLAN:  Starting internal PHY with HALF-DUPLEX&bslash;n&quot;
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* Wait for 100 ms.  No reason in partiticular.&n;&t; */
id|TLan_SetTimer
c_func
(paren
id|dev
comma
(paren
id|HZ
op_div
l_int|10
)paren
comma
id|TLAN_TIMER_FINISH_RESET
)paren
suffix:semicolon
)brace
multiline_comment|/* TLan_PhyFinishAutoNeg */
macro_line|#ifdef MONITOR
multiline_comment|/*********************************************************************&n;        *&n;        *      TLan_phyMonitor&n;        *&n;        *      Returns: &n;        *              None&n;        *&n;        *      Params:&n;        *              dev             The device structure of this device.&n;        *&n;        *      &n;        *      This function monitors PHY condition by reading the status&n;        *      register via the MII bus. This can be used to give info&n;        *      about link changes (up/down), and possible switch to alternate&n;        *      media.&n;        *&n;        * ******************************************************************/
DECL|function|TLan_PhyMonitor
r_void
id|TLan_PhyMonitor
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
id|TLanPrivateInfo
op_star
id|priv
op_assign
(paren
id|TLanPrivateInfo
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|u16
id|phy
suffix:semicolon
id|u16
id|phy_status
suffix:semicolon
id|phy
op_assign
id|priv-&gt;phy
(braket
id|priv-&gt;phyNum
)braket
suffix:semicolon
multiline_comment|/* Get PHY status register */
id|TLan_MiiReadReg
c_func
(paren
id|dev
comma
id|phy
comma
id|MII_GEN_STS
comma
op_amp
id|phy_status
)paren
suffix:semicolon
multiline_comment|/* Check if link has been lost */
r_if
c_cond
(paren
op_logical_neg
(paren
id|phy_status
op_amp
id|MII_GS_LINK
)paren
)paren
(brace
r_if
c_cond
(paren
id|priv-&gt;link
)paren
(brace
id|priv-&gt;link
op_assign
l_int|0
suffix:semicolon
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;TLAN: %s has lost link&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|dev-&gt;flags
op_and_assign
op_complement
id|IFF_RUNNING
suffix:semicolon
id|TLan_SetTimer
c_func
(paren
id|dev
comma
(paren
l_int|2
op_star
id|HZ
)paren
comma
id|TLAN_TIMER_LINK_BEAT
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
)brace
multiline_comment|/* Link restablished? */
r_if
c_cond
(paren
(paren
id|phy_status
op_amp
id|MII_GS_LINK
)paren
op_logical_and
op_logical_neg
id|priv-&gt;link
)paren
(brace
id|priv-&gt;link
op_assign
l_int|1
suffix:semicolon
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;TLAN: %s has reestablished link&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|dev-&gt;flags
op_or_assign
id|IFF_RUNNING
suffix:semicolon
)brace
multiline_comment|/* Setup a new monitor */
id|TLan_SetTimer
c_func
(paren
id|dev
comma
(paren
l_int|2
op_star
id|HZ
)paren
comma
id|TLAN_TIMER_LINK_BEAT
)paren
suffix:semicolon
)brace
macro_line|#endif /* MONITOR */
multiline_comment|/*****************************************************************************&n;******************************************************************************&n;&n;&t;ThunderLAN Driver MII Routines&n;&n;&t;These routines are based on the information in Chap. 2 of the&n;&t;&quot;ThunderLAN Programmer&squot;s Guide&quot;, pp. 15-24.&n;&n;******************************************************************************&n;*****************************************************************************/
multiline_comment|/***************************************************************&n;&t; *&t;TLan_MiiReadReg&n;&t; *&n;&t; *&t;Returns:&n;&t; *&t;&t;0&t;if ack received ok&n;&t; *&t;&t;1&t;otherwise.&n;&t; *&n;&t; *&t;Parms:&n;&t; *&t;&t;dev&t;&t;The device structure containing&n;&t; *&t;&t;&t;&t;The io address and interrupt count&n;&t; *&t;&t;&t;&t;for this device.&n;&t; *&t;&t;phy&t;&t;The address of the PHY to be queried.&n;&t; *&t;&t;reg&t;&t;The register whose contents are to be&n;&t; *&t;&t;&t;&t;retreived.&n;&t; *&t;&t;val&t;&t;A pointer to a variable to store the&n;&t; *&t;&t;&t;&t;retrieved value.&n;&t; *&n;&t; *&t;This function uses the TLAN&squot;s MII bus to retreive the contents&n;&t; *&t;of a given register on a PHY.  It sends the appropriate info&n;&t; *&t;and then reads the 16-bit register value from the MII bus via&n;&t; *&t;the TLAN SIO register.&n;&t; *&n;&t; **************************************************************/
DECL|function|TLan_MiiReadReg
r_int
id|TLan_MiiReadReg
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
id|u16
id|phy
comma
id|u16
id|reg
comma
id|u16
op_star
id|val
)paren
(brace
id|u8
id|nack
suffix:semicolon
id|u16
id|sio
comma
id|tmp
suffix:semicolon
id|u32
id|i
suffix:semicolon
r_int
id|err
suffix:semicolon
r_int
id|minten
suffix:semicolon
id|TLanPrivateInfo
op_star
id|priv
op_assign
(paren
id|TLanPrivateInfo
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_int
r_int
id|flags
op_assign
l_int|0
suffix:semicolon
id|err
op_assign
id|FALSE
suffix:semicolon
id|outw
c_func
(paren
id|TLAN_NET_SIO
comma
id|dev-&gt;base_addr
op_plus
id|TLAN_DIO_ADR
)paren
suffix:semicolon
id|sio
op_assign
id|dev-&gt;base_addr
op_plus
id|TLAN_DIO_DATA
op_plus
id|TLAN_NET_SIO
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|priv-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|TLan_MiiSync
c_func
(paren
id|dev-&gt;base_addr
)paren
suffix:semicolon
id|minten
op_assign
id|TLan_GetBit
c_func
(paren
id|TLAN_NET_SIO_MINTEN
comma
id|sio
)paren
suffix:semicolon
r_if
c_cond
(paren
id|minten
)paren
id|TLan_ClearBit
c_func
(paren
id|TLAN_NET_SIO_MINTEN
comma
id|sio
)paren
suffix:semicolon
id|TLan_MiiSendData
c_func
(paren
id|dev-&gt;base_addr
comma
l_int|0x1
comma
l_int|2
)paren
suffix:semicolon
multiline_comment|/* Start ( 01b ) */
id|TLan_MiiSendData
c_func
(paren
id|dev-&gt;base_addr
comma
l_int|0x2
comma
l_int|2
)paren
suffix:semicolon
multiline_comment|/* Read  ( 10b ) */
id|TLan_MiiSendData
c_func
(paren
id|dev-&gt;base_addr
comma
id|phy
comma
l_int|5
)paren
suffix:semicolon
multiline_comment|/* Device #      */
id|TLan_MiiSendData
c_func
(paren
id|dev-&gt;base_addr
comma
id|reg
comma
l_int|5
)paren
suffix:semicolon
multiline_comment|/* Register #    */
id|TLan_ClearBit
c_func
(paren
id|TLAN_NET_SIO_MTXEN
comma
id|sio
)paren
suffix:semicolon
multiline_comment|/* Change direction */
id|TLan_ClearBit
c_func
(paren
id|TLAN_NET_SIO_MCLK
comma
id|sio
)paren
suffix:semicolon
multiline_comment|/* Clock Idle bit */
id|TLan_SetBit
c_func
(paren
id|TLAN_NET_SIO_MCLK
comma
id|sio
)paren
suffix:semicolon
id|TLan_ClearBit
c_func
(paren
id|TLAN_NET_SIO_MCLK
comma
id|sio
)paren
suffix:semicolon
multiline_comment|/* Wait 300ns */
id|nack
op_assign
id|TLan_GetBit
c_func
(paren
id|TLAN_NET_SIO_MDATA
comma
id|sio
)paren
suffix:semicolon
multiline_comment|/* Check for ACK */
id|TLan_SetBit
c_func
(paren
id|TLAN_NET_SIO_MCLK
comma
id|sio
)paren
suffix:semicolon
multiline_comment|/* Finish ACK */
r_if
c_cond
(paren
id|nack
)paren
(brace
multiline_comment|/* No ACK, so fake it */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|16
suffix:semicolon
id|i
op_increment
)paren
(brace
id|TLan_ClearBit
c_func
(paren
id|TLAN_NET_SIO_MCLK
comma
id|sio
)paren
suffix:semicolon
id|TLan_SetBit
c_func
(paren
id|TLAN_NET_SIO_MCLK
comma
id|sio
)paren
suffix:semicolon
)brace
id|tmp
op_assign
l_int|0xffff
suffix:semicolon
id|err
op_assign
id|TRUE
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* ACK, so read data */
r_for
c_loop
(paren
id|tmp
op_assign
l_int|0
comma
id|i
op_assign
l_int|0x8000
suffix:semicolon
id|i
suffix:semicolon
id|i
op_rshift_assign
l_int|1
)paren
(brace
id|TLan_ClearBit
c_func
(paren
id|TLAN_NET_SIO_MCLK
comma
id|sio
)paren
suffix:semicolon
r_if
c_cond
(paren
id|TLan_GetBit
c_func
(paren
id|TLAN_NET_SIO_MDATA
comma
id|sio
)paren
)paren
id|tmp
op_or_assign
id|i
suffix:semicolon
id|TLan_SetBit
c_func
(paren
id|TLAN_NET_SIO_MCLK
comma
id|sio
)paren
suffix:semicolon
)brace
)brace
id|TLan_ClearBit
c_func
(paren
id|TLAN_NET_SIO_MCLK
comma
id|sio
)paren
suffix:semicolon
multiline_comment|/* Idle cycle */
id|TLan_SetBit
c_func
(paren
id|TLAN_NET_SIO_MCLK
comma
id|sio
)paren
suffix:semicolon
r_if
c_cond
(paren
id|minten
)paren
id|TLan_SetBit
c_func
(paren
id|TLAN_NET_SIO_MINTEN
comma
id|sio
)paren
suffix:semicolon
op_star
id|val
op_assign
id|tmp
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|priv-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
multiline_comment|/* TLan_MiiReadReg */
multiline_comment|/***************************************************************&n;&t; *&t;TLan_MiiSendData&n;&t; *&n;&t; *&t;Returns:&n;&t; *&t;&t;Nothing&n;&t; *&t;Parms:&n;&t; *&t;&t;base_port&t;The base IO port of the adapter&t;in&n;&t; *&t;&t;&t;&t;question.&n;&t; *&t;&t;dev&t;&t;The address of the PHY to be queried.&n;&t; *&t;&t;data&t;&t;The value to be placed on the MII bus.&n;&t; *&t;&t;num_bits&t;The number of bits in data that are to&n;&t; *&t;&t;&t;&t;be placed on the MII bus.&n;&t; *&n;&t; *&t;This function sends on sequence of bits on the MII&n;&t; *&t;configuration bus.&n;&t; *&n;&t; **************************************************************/
DECL|function|TLan_MiiSendData
r_void
id|TLan_MiiSendData
c_func
(paren
id|u16
id|base_port
comma
id|u32
id|data
comma
r_int
id|num_bits
)paren
(brace
id|u16
id|sio
suffix:semicolon
id|u32
id|i
suffix:semicolon
r_if
c_cond
(paren
id|num_bits
op_eq
l_int|0
)paren
r_return
suffix:semicolon
id|outw
c_func
(paren
id|TLAN_NET_SIO
comma
id|base_port
op_plus
id|TLAN_DIO_ADR
)paren
suffix:semicolon
id|sio
op_assign
id|base_port
op_plus
id|TLAN_DIO_DATA
op_plus
id|TLAN_NET_SIO
suffix:semicolon
id|TLan_SetBit
c_func
(paren
id|TLAN_NET_SIO_MTXEN
comma
id|sio
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
(paren
l_int|0x1
op_lshift
(paren
id|num_bits
op_minus
l_int|1
)paren
)paren
suffix:semicolon
id|i
suffix:semicolon
id|i
op_rshift_assign
l_int|1
)paren
(brace
id|TLan_ClearBit
c_func
(paren
id|TLAN_NET_SIO_MCLK
comma
id|sio
)paren
suffix:semicolon
(paren
r_void
)paren
id|TLan_GetBit
c_func
(paren
id|TLAN_NET_SIO_MCLK
comma
id|sio
)paren
suffix:semicolon
r_if
c_cond
(paren
id|data
op_amp
id|i
)paren
id|TLan_SetBit
c_func
(paren
id|TLAN_NET_SIO_MDATA
comma
id|sio
)paren
suffix:semicolon
r_else
id|TLan_ClearBit
c_func
(paren
id|TLAN_NET_SIO_MDATA
comma
id|sio
)paren
suffix:semicolon
id|TLan_SetBit
c_func
(paren
id|TLAN_NET_SIO_MCLK
comma
id|sio
)paren
suffix:semicolon
(paren
r_void
)paren
id|TLan_GetBit
c_func
(paren
id|TLAN_NET_SIO_MCLK
comma
id|sio
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* TLan_MiiSendData */
multiline_comment|/***************************************************************&n;&t; *&t;TLan_MiiSync&n;&t; *&n;&t; *&t;Returns:&n;&t; *&t;&t;Nothing&n;&t; *&t;Parms:&n;&t; *&t;&t;base_port&t;The base IO port of the adapter in&n;&t; *&t;&t;&t;&t;question.&n;&t; *&n;&t; *&t;This functions syncs all PHYs in terms of the MII configuration&n;&t; *&t;bus.&n;&t; *&n;&t; **************************************************************/
DECL|function|TLan_MiiSync
r_void
id|TLan_MiiSync
c_func
(paren
id|u16
id|base_port
)paren
(brace
r_int
id|i
suffix:semicolon
id|u16
id|sio
suffix:semicolon
id|outw
c_func
(paren
id|TLAN_NET_SIO
comma
id|base_port
op_plus
id|TLAN_DIO_ADR
)paren
suffix:semicolon
id|sio
op_assign
id|base_port
op_plus
id|TLAN_DIO_DATA
op_plus
id|TLAN_NET_SIO
suffix:semicolon
id|TLan_ClearBit
c_func
(paren
id|TLAN_NET_SIO_MTXEN
comma
id|sio
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|32
suffix:semicolon
id|i
op_increment
)paren
(brace
id|TLan_ClearBit
c_func
(paren
id|TLAN_NET_SIO_MCLK
comma
id|sio
)paren
suffix:semicolon
id|TLan_SetBit
c_func
(paren
id|TLAN_NET_SIO_MCLK
comma
id|sio
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* TLan_MiiSync */
multiline_comment|/***************************************************************&n;&t; *&t;TLan_MiiWriteReg&n;&t; *&n;&t; *&t;Returns:&n;&t; *&t;&t;Nothing&n;&t; *&t;Parms:&n;&t; *&t;&t;dev&t;&t;The device structure for the device&n;&t; *&t;&t;&t;&t;to write to.&n;&t; *&t;&t;phy&t;&t;The address of the PHY to be written to.&n;&t; *&t;&t;reg&t;&t;The register whose contents are to be&n;&t; *&t;&t;&t;&t;written.&n;&t; *&t;&t;val&t;&t;The value to be written to the register.&n;&t; *&n;&t; *&t;This function uses the TLAN&squot;s MII bus to write the contents of a&n;&t; *&t;given register on a PHY.  It sends the appropriate info and then&n;&t; *&t;writes the 16-bit register value from the MII configuration bus&n;&t; *&t;via the TLAN SIO register.&n;&t; *&n;&t; **************************************************************/
DECL|function|TLan_MiiWriteReg
r_void
id|TLan_MiiWriteReg
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
id|u16
id|phy
comma
id|u16
id|reg
comma
id|u16
id|val
)paren
(brace
id|u16
id|sio
suffix:semicolon
r_int
id|minten
suffix:semicolon
r_int
r_int
id|flags
op_assign
l_int|0
suffix:semicolon
id|TLanPrivateInfo
op_star
id|priv
op_assign
(paren
id|TLanPrivateInfo
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|outw
c_func
(paren
id|TLAN_NET_SIO
comma
id|dev-&gt;base_addr
op_plus
id|TLAN_DIO_ADR
)paren
suffix:semicolon
id|sio
op_assign
id|dev-&gt;base_addr
op_plus
id|TLAN_DIO_DATA
op_plus
id|TLAN_NET_SIO
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|priv-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|TLan_MiiSync
c_func
(paren
id|dev-&gt;base_addr
)paren
suffix:semicolon
id|minten
op_assign
id|TLan_GetBit
c_func
(paren
id|TLAN_NET_SIO_MINTEN
comma
id|sio
)paren
suffix:semicolon
r_if
c_cond
(paren
id|minten
)paren
id|TLan_ClearBit
c_func
(paren
id|TLAN_NET_SIO_MINTEN
comma
id|sio
)paren
suffix:semicolon
id|TLan_MiiSendData
c_func
(paren
id|dev-&gt;base_addr
comma
l_int|0x1
comma
l_int|2
)paren
suffix:semicolon
multiline_comment|/* Start ( 01b ) */
id|TLan_MiiSendData
c_func
(paren
id|dev-&gt;base_addr
comma
l_int|0x1
comma
l_int|2
)paren
suffix:semicolon
multiline_comment|/* Write ( 01b ) */
id|TLan_MiiSendData
c_func
(paren
id|dev-&gt;base_addr
comma
id|phy
comma
l_int|5
)paren
suffix:semicolon
multiline_comment|/* Device #      */
id|TLan_MiiSendData
c_func
(paren
id|dev-&gt;base_addr
comma
id|reg
comma
l_int|5
)paren
suffix:semicolon
multiline_comment|/* Register #    */
id|TLan_MiiSendData
c_func
(paren
id|dev-&gt;base_addr
comma
l_int|0x2
comma
l_int|2
)paren
suffix:semicolon
multiline_comment|/* Send ACK */
id|TLan_MiiSendData
c_func
(paren
id|dev-&gt;base_addr
comma
id|val
comma
l_int|16
)paren
suffix:semicolon
multiline_comment|/* Send Data */
id|TLan_ClearBit
c_func
(paren
id|TLAN_NET_SIO_MCLK
comma
id|sio
)paren
suffix:semicolon
multiline_comment|/* Idle cycle */
id|TLan_SetBit
c_func
(paren
id|TLAN_NET_SIO_MCLK
comma
id|sio
)paren
suffix:semicolon
r_if
c_cond
(paren
id|minten
)paren
id|TLan_SetBit
c_func
(paren
id|TLAN_NET_SIO_MINTEN
comma
id|sio
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|priv-&gt;lock
comma
id|flags
)paren
suffix:semicolon
)brace
multiline_comment|/* TLan_MiiWriteReg */
multiline_comment|/*****************************************************************************&n;******************************************************************************&n;&n;&t;ThunderLAN Driver Eeprom routines&n;&n;&t;The Compaq Netelligent 10 and 10/100 cards use a Microchip 24C02A&n;&t;EEPROM.  These functions are based on information in Microchip&squot;s&n;&t;data sheet.  I don&squot;t know how well this functions will work with&n;&t;other EEPROMs.&n;&n;******************************************************************************&n;*****************************************************************************/
multiline_comment|/***************************************************************&n;&t; *&t;TLan_EeSendStart&n;&t; *&n;&t; *&t;Returns:&n;&t; *&t;&t;Nothing&n;&t; *&t;Parms:&t;&n;&t; *&t;&t;io_base&t;&t;The IO port base address for the&n;&t; *&t;&t;&t;&t;TLAN device with the EEPROM to&n;&t; *&t;&t;&t;&t;use.&n;&t; *&n;&t; *&t;This function sends a start cycle to an EEPROM attached&n;&t; *&t;to a TLAN chip.&n;&t; *&n;&t; **************************************************************/
DECL|function|TLan_EeSendStart
r_void
id|TLan_EeSendStart
c_func
(paren
id|u16
id|io_base
)paren
(brace
id|u16
id|sio
suffix:semicolon
id|outw
c_func
(paren
id|TLAN_NET_SIO
comma
id|io_base
op_plus
id|TLAN_DIO_ADR
)paren
suffix:semicolon
id|sio
op_assign
id|io_base
op_plus
id|TLAN_DIO_DATA
op_plus
id|TLAN_NET_SIO
suffix:semicolon
id|TLan_SetBit
c_func
(paren
id|TLAN_NET_SIO_ECLOK
comma
id|sio
)paren
suffix:semicolon
id|TLan_SetBit
c_func
(paren
id|TLAN_NET_SIO_EDATA
comma
id|sio
)paren
suffix:semicolon
id|TLan_SetBit
c_func
(paren
id|TLAN_NET_SIO_ETXEN
comma
id|sio
)paren
suffix:semicolon
id|TLan_ClearBit
c_func
(paren
id|TLAN_NET_SIO_EDATA
comma
id|sio
)paren
suffix:semicolon
id|TLan_ClearBit
c_func
(paren
id|TLAN_NET_SIO_ECLOK
comma
id|sio
)paren
suffix:semicolon
)brace
multiline_comment|/* TLan_EeSendStart */
multiline_comment|/***************************************************************&n;&t; *&t;TLan_EeSendByte&n;&t; *&n;&t; *&t;Returns:&n;&t; *&t;&t;If the correct ack was received, 0, otherwise 1&n;&t; *&t;Parms:&t;io_base&t;&t;The IO port base address for the&n;&t; *&t;&t;&t;&t;TLAN device with the EEPROM to&n;&t; *&t;&t;&t;&t;use.&n;&t; *&t;&t;data&t;&t;The 8 bits of information to&n;&t; *&t;&t;&t;&t;send to the EEPROM.&n;&t; *&t;&t;stop&t;&t;If TLAN_EEPROM_STOP is passed, a&n;&t; *&t;&t;&t;&t;stop cycle is sent after the&n;&t; *&t;&t;&t;&t;byte is sent after the ack is&n;&t; *&t;&t;&t;&t;read.&n;&t; *&n;&t; *&t;This function sends a byte on the serial EEPROM line,&n;&t; *&t;driving the clock to send each bit. The function then&n;&t; *&t;reverses transmission direction and reads an acknowledge&n;&t; *&t;bit.&n;&t; *&n;&t; **************************************************************/
DECL|function|TLan_EeSendByte
r_int
id|TLan_EeSendByte
c_func
(paren
id|u16
id|io_base
comma
id|u8
id|data
comma
r_int
id|stop
)paren
(brace
r_int
id|err
suffix:semicolon
id|u8
id|place
suffix:semicolon
id|u16
id|sio
suffix:semicolon
id|outw
c_func
(paren
id|TLAN_NET_SIO
comma
id|io_base
op_plus
id|TLAN_DIO_ADR
)paren
suffix:semicolon
id|sio
op_assign
id|io_base
op_plus
id|TLAN_DIO_DATA
op_plus
id|TLAN_NET_SIO
suffix:semicolon
multiline_comment|/* Assume clock is low, tx is enabled; */
r_for
c_loop
(paren
id|place
op_assign
l_int|0x80
suffix:semicolon
id|place
op_ne
l_int|0
suffix:semicolon
id|place
op_rshift_assign
l_int|1
)paren
(brace
r_if
c_cond
(paren
id|place
op_amp
id|data
)paren
id|TLan_SetBit
c_func
(paren
id|TLAN_NET_SIO_EDATA
comma
id|sio
)paren
suffix:semicolon
r_else
id|TLan_ClearBit
c_func
(paren
id|TLAN_NET_SIO_EDATA
comma
id|sio
)paren
suffix:semicolon
id|TLan_SetBit
c_func
(paren
id|TLAN_NET_SIO_ECLOK
comma
id|sio
)paren
suffix:semicolon
id|TLan_ClearBit
c_func
(paren
id|TLAN_NET_SIO_ECLOK
comma
id|sio
)paren
suffix:semicolon
)brace
id|TLan_ClearBit
c_func
(paren
id|TLAN_NET_SIO_ETXEN
comma
id|sio
)paren
suffix:semicolon
id|TLan_SetBit
c_func
(paren
id|TLAN_NET_SIO_ECLOK
comma
id|sio
)paren
suffix:semicolon
id|err
op_assign
id|TLan_GetBit
c_func
(paren
id|TLAN_NET_SIO_EDATA
comma
id|sio
)paren
suffix:semicolon
id|TLan_ClearBit
c_func
(paren
id|TLAN_NET_SIO_ECLOK
comma
id|sio
)paren
suffix:semicolon
id|TLan_SetBit
c_func
(paren
id|TLAN_NET_SIO_ETXEN
comma
id|sio
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
op_logical_neg
id|err
)paren
op_logical_and
id|stop
)paren
(brace
id|TLan_ClearBit
c_func
(paren
id|TLAN_NET_SIO_EDATA
comma
id|sio
)paren
suffix:semicolon
multiline_comment|/* STOP, raise data while clock is high */
id|TLan_SetBit
c_func
(paren
id|TLAN_NET_SIO_ECLOK
comma
id|sio
)paren
suffix:semicolon
id|TLan_SetBit
c_func
(paren
id|TLAN_NET_SIO_EDATA
comma
id|sio
)paren
suffix:semicolon
)brace
r_return
(paren
id|err
)paren
suffix:semicolon
)brace
multiline_comment|/* TLan_EeSendByte */
multiline_comment|/***************************************************************&n;&t; *&t;TLan_EeReceiveByte&n;&t; *&n;&t; *&t;Returns:&n;&t; *&t;&t;Nothing&n;&t; *&t;Parms:&n;&t; *&t;&t;io_base&t;&t;The IO port base address for the&n;&t; *&t;&t;&t;&t;TLAN device with the EEPROM to&n;&t; *&t;&t;&t;&t;use.&n;&t; *&t;&t;data&t;&t;An address to a char to hold the&n;&t; *&t;&t;&t;&t;data sent from the EEPROM.&n;&t; *&t;&t;stop&t;&t;If TLAN_EEPROM_STOP is passed, a&n;&t; *&t;&t;&t;&t;stop cycle is sent after the&n;&t; *&t;&t;&t;&t;byte is received, and no ack is&n;&t; *&t;&t;&t;&t;sent.&n;&t; *&n;&t; *&t;This function receives 8 bits of data from the EEPROM&n;&t; *&t;over the serial link.  It then sends and ack bit, or no&n;&t; *&t;ack and a stop bit.  This function is used to retrieve&n;&t; *&t;data after the address of a byte in the EEPROM has been&n;&t; *&t;sent.&n;&t; *&n;&t; **************************************************************/
DECL|function|TLan_EeReceiveByte
r_void
id|TLan_EeReceiveByte
c_func
(paren
id|u16
id|io_base
comma
id|u8
op_star
id|data
comma
r_int
id|stop
)paren
(brace
id|u8
id|place
suffix:semicolon
id|u16
id|sio
suffix:semicolon
id|outw
c_func
(paren
id|TLAN_NET_SIO
comma
id|io_base
op_plus
id|TLAN_DIO_ADR
)paren
suffix:semicolon
id|sio
op_assign
id|io_base
op_plus
id|TLAN_DIO_DATA
op_plus
id|TLAN_NET_SIO
suffix:semicolon
op_star
id|data
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Assume clock is low, tx is enabled; */
id|TLan_ClearBit
c_func
(paren
id|TLAN_NET_SIO_ETXEN
comma
id|sio
)paren
suffix:semicolon
r_for
c_loop
(paren
id|place
op_assign
l_int|0x80
suffix:semicolon
id|place
suffix:semicolon
id|place
op_rshift_assign
l_int|1
)paren
(brace
id|TLan_SetBit
c_func
(paren
id|TLAN_NET_SIO_ECLOK
comma
id|sio
)paren
suffix:semicolon
r_if
c_cond
(paren
id|TLan_GetBit
c_func
(paren
id|TLAN_NET_SIO_EDATA
comma
id|sio
)paren
)paren
op_star
id|data
op_or_assign
id|place
suffix:semicolon
id|TLan_ClearBit
c_func
(paren
id|TLAN_NET_SIO_ECLOK
comma
id|sio
)paren
suffix:semicolon
)brace
id|TLan_SetBit
c_func
(paren
id|TLAN_NET_SIO_ETXEN
comma
id|sio
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|stop
)paren
(brace
id|TLan_ClearBit
c_func
(paren
id|TLAN_NET_SIO_EDATA
comma
id|sio
)paren
suffix:semicolon
multiline_comment|/* Ack = 0 */
id|TLan_SetBit
c_func
(paren
id|TLAN_NET_SIO_ECLOK
comma
id|sio
)paren
suffix:semicolon
id|TLan_ClearBit
c_func
(paren
id|TLAN_NET_SIO_ECLOK
comma
id|sio
)paren
suffix:semicolon
)brace
r_else
(brace
id|TLan_SetBit
c_func
(paren
id|TLAN_NET_SIO_EDATA
comma
id|sio
)paren
suffix:semicolon
multiline_comment|/* No ack = 1 (?) */
id|TLan_SetBit
c_func
(paren
id|TLAN_NET_SIO_ECLOK
comma
id|sio
)paren
suffix:semicolon
id|TLan_ClearBit
c_func
(paren
id|TLAN_NET_SIO_ECLOK
comma
id|sio
)paren
suffix:semicolon
id|TLan_ClearBit
c_func
(paren
id|TLAN_NET_SIO_EDATA
comma
id|sio
)paren
suffix:semicolon
multiline_comment|/* STOP, raise data while clock is high */
id|TLan_SetBit
c_func
(paren
id|TLAN_NET_SIO_ECLOK
comma
id|sio
)paren
suffix:semicolon
id|TLan_SetBit
c_func
(paren
id|TLAN_NET_SIO_EDATA
comma
id|sio
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* TLan_EeReceiveByte */
multiline_comment|/***************************************************************&n;&t; *&t;TLan_EeReadByte&n;&t; *&n;&t; *&t;Returns:&n;&t; *&t;&t;No error = 0, else, the stage at which the error&n;&t; *&t;&t;occurred.&n;&t; *&t;Parms:&n;&t; *&t;&t;io_base&t;&t;The IO port base address for the&n;&t; *&t;&t;&t;&t;TLAN device with the EEPROM to&n;&t; *&t;&t;&t;&t;use.&n;&t; *&t;&t;ee_addr&t;&t;The address of the byte in the&n;&t; *&t;&t;&t;&t;EEPROM whose contents are to be&n;&t; *&t;&t;&t;&t;retrieved.&n;&t; *&t;&t;data&t;&t;An address to a char to hold the&n;&t; *&t;&t;&t;&t;data obtained from the EEPROM.&n;&t; *&n;&t; *&t;This function reads a byte of information from an byte&n;&t; *&t;cell in the EEPROM.&n;&t; *&n;&t; **************************************************************/
DECL|function|TLan_EeReadByte
r_int
id|TLan_EeReadByte
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
id|u8
id|ee_addr
comma
id|u8
op_star
id|data
)paren
(brace
r_int
id|err
suffix:semicolon
id|TLanPrivateInfo
op_star
id|priv
op_assign
(paren
id|TLanPrivateInfo
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_int
r_int
id|flags
op_assign
l_int|0
suffix:semicolon
r_int
id|ret
op_assign
l_int|0
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|priv-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|TLan_EeSendStart
c_func
(paren
id|dev-&gt;base_addr
)paren
suffix:semicolon
id|err
op_assign
id|TLan_EeSendByte
c_func
(paren
id|dev-&gt;base_addr
comma
l_int|0xA0
comma
id|TLAN_EEPROM_ACK
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
(brace
id|ret
op_assign
l_int|1
suffix:semicolon
r_goto
id|fail
suffix:semicolon
)brace
id|err
op_assign
id|TLan_EeSendByte
c_func
(paren
id|dev-&gt;base_addr
comma
id|ee_addr
comma
id|TLAN_EEPROM_ACK
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
(brace
id|ret
op_assign
l_int|2
suffix:semicolon
r_goto
id|fail
suffix:semicolon
)brace
id|TLan_EeSendStart
c_func
(paren
id|dev-&gt;base_addr
)paren
suffix:semicolon
id|err
op_assign
id|TLan_EeSendByte
c_func
(paren
id|dev-&gt;base_addr
comma
l_int|0xA1
comma
id|TLAN_EEPROM_ACK
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
(brace
id|ret
op_assign
l_int|3
suffix:semicolon
r_goto
id|fail
suffix:semicolon
)brace
id|TLan_EeReceiveByte
c_func
(paren
id|dev-&gt;base_addr
comma
id|data
comma
id|TLAN_EEPROM_STOP
)paren
suffix:semicolon
id|fail
suffix:colon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|priv-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
multiline_comment|/* TLan_EeReadByte */
eof
