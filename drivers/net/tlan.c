multiline_comment|/********************************************************************&n; *&n; *  Linux ThunderLAN Driver&n; *&n; *  tlan.c&n; *  by James Banks, james.banks@caldera.com&n; *&n; *  (C) 1997 Caldera, Inc.&n; *&n; *  This software may be used and distributed according to the terms&n; *  of the GNU Public License, incorporated herein by reference.&n; *&n; ** This file is best viewed/edited with tabstop=4 and colums&gt;=132.&n; *&n; ** Useful (if not required) reading:&n; *&n; *&t;&t;Texas Instruments, ThunderLAN Programmer&squot;s Guide,&n; *&t;&t;&t;TI Literature Number SPWU013A&n; *&t;&t;&t;available in PDF format from www.ti.com&n; *&t;&t;National Semiconductor, DP83840A Data Sheet&n; *&t;&t;&t;available in PDF format from www.national.com&n; *&t;&t;Microchip Technology, 24C01A/02A/04A Data Sheet&n; *&t;&t;&t;available in PDF format from www.microchip.com&n; *&n; ********************************************************************/
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &quot;tlan.h&quot;
macro_line|#include &lt;linux/ioport.h&gt;
macro_line|#include &lt;linux/pci.h&gt;
macro_line|#include &lt;linux/etherdevice.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
DECL|typedef|TLanIntVectorFunc
r_typedef
id|u32
(paren
id|TLanIntVectorFunc
)paren
(paren
r_struct
id|device
op_star
comma
id|u16
)paren
suffix:semicolon
macro_line|#ifdef MODULE
DECL|variable|TLanDevices
r_static
r_struct
id|device
op_star
id|TLanDevices
op_assign
l_int|NULL
suffix:semicolon
DECL|variable|TLanDevicesInstalled
r_static
r_int
id|TLanDevicesInstalled
op_assign
l_int|0
suffix:semicolon
macro_line|#endif
DECL|variable|debug
r_static
r_int
id|debug
op_assign
l_int|0
suffix:semicolon
DECL|variable|aui
r_static
r_int
id|aui
op_assign
l_int|0
suffix:semicolon
DECL|variable|TLanPadBuffer
r_static
id|u8
op_star
id|TLanPadBuffer
suffix:semicolon
DECL|variable|TLanSignature
r_static
r_char
id|TLanSignature
(braket
)braket
op_assign
l_string|&quot;TLAN&quot;
suffix:semicolon
DECL|variable|TLanVersionMajor
r_static
r_int
id|TLanVersionMajor
op_assign
l_int|0
suffix:semicolon
DECL|variable|TLanVersionMinor
r_static
r_int
id|TLanVersionMinor
op_assign
l_int|38
suffix:semicolon
DECL|variable|TLanDeviceList
r_static
id|TLanPciId
id|TLanDeviceList
(braket
)braket
op_assign
(brace
(brace
id|PCI_VENDOR_ID_COMPAQ
comma
id|PCI_DEVICE_ID_NETELLIGENT_10
comma
l_string|&quot;Compaq Netelligent 10&quot;
)brace
comma
(brace
id|PCI_VENDOR_ID_COMPAQ
comma
id|PCI_DEVICE_ID_NETELLIGENT_10_100
comma
l_string|&quot;Compaq Netelligent 10/100&quot;
)brace
comma
(brace
id|PCI_VENDOR_ID_COMPAQ
comma
id|PCI_DEVICE_ID_NETFLEX_3P_INTEGRATED
comma
l_string|&quot;Compaq Integrated NetFlex-3/P&quot;
)brace
comma
(brace
id|PCI_VENDOR_ID_COMPAQ
comma
id|PCI_DEVICE_ID_NETFLEX_3P
comma
l_string|&quot;Compaq NetFlex-3/P&quot;
)brace
comma
(brace
id|PCI_VENDOR_ID_COMPAQ
comma
id|PCI_DEVICE_ID_NETFLEX_3P_BNC
comma
l_string|&quot;Compaq NetFlex-3/P&quot;
)brace
comma
(brace
id|PCI_VENDOR_ID_COMPAQ
comma
id|PCI_DEVICE_ID_NETELLIGENT_10_100_PROLIANT
comma
l_string|&quot;Compaq ProLiant Netelligent 10/100&quot;
)brace
comma
(brace
id|PCI_VENDOR_ID_COMPAQ
comma
id|PCI_DEVICE_ID_NETELLIGENT_10_100_DUAL
comma
l_string|&quot;Compaq Dual Port Netelligent 10/100&quot;
)brace
comma
(brace
id|PCI_VENDOR_ID_COMPAQ
comma
id|PCI_DEVICE_ID_DESKPRO_4000_5233MMX
comma
l_string|&quot;Compaq Deskpro 4000 5233MMX&quot;
)brace
comma
(brace
l_int|0
comma
l_int|0
comma
l_int|NULL
)brace
multiline_comment|/* End of List */
)brace
suffix:semicolon
r_static
r_int
id|TLan_PciProbe
c_func
(paren
id|u8
op_star
comma
id|u8
op_star
comma
r_int
op_star
comma
id|u8
op_star
comma
id|u32
op_star
comma
id|u32
op_star
)paren
suffix:semicolon
r_static
r_int
id|TLan_Init
c_func
(paren
r_struct
id|device
op_star
)paren
suffix:semicolon
r_static
r_int
id|TLan_Open
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_int
id|TLan_StartTx
c_func
(paren
r_struct
id|sk_buff
op_star
comma
r_struct
id|device
op_star
)paren
suffix:semicolon
r_static
r_void
id|TLan_HandleInterrupt
c_func
(paren
r_int
comma
r_void
op_star
comma
r_struct
id|pt_regs
op_star
)paren
suffix:semicolon
r_static
r_int
id|TLan_Close
c_func
(paren
r_struct
id|device
op_star
)paren
suffix:semicolon
r_static
r_struct
id|net_device_stats
op_star
id|TLan_GetStats
c_func
(paren
r_struct
id|device
op_star
)paren
suffix:semicolon
r_static
r_void
id|TLan_SetMulticastList
c_func
(paren
r_struct
id|device
op_star
)paren
suffix:semicolon
r_static
id|u32
id|TLan_HandleInvalid
c_func
(paren
r_struct
id|device
op_star
comma
id|u16
)paren
suffix:semicolon
r_static
id|u32
id|TLan_HandleTxEOF
c_func
(paren
r_struct
id|device
op_star
comma
id|u16
)paren
suffix:semicolon
r_static
id|u32
id|TLan_HandleStatOverflow
c_func
(paren
r_struct
id|device
op_star
comma
id|u16
)paren
suffix:semicolon
r_static
id|u32
id|TLan_HandleRxEOF
c_func
(paren
r_struct
id|device
op_star
comma
id|u16
)paren
suffix:semicolon
r_static
id|u32
id|TLan_HandleDummy
c_func
(paren
r_struct
id|device
op_star
comma
id|u16
)paren
suffix:semicolon
r_static
id|u32
id|TLan_HandleTxEOC
c_func
(paren
r_struct
id|device
op_star
comma
id|u16
)paren
suffix:semicolon
r_static
id|u32
id|TLan_HandleStatusCheck
c_func
(paren
r_struct
id|device
op_star
comma
id|u16
)paren
suffix:semicolon
r_static
id|u32
id|TLan_HandleRxEOC
c_func
(paren
r_struct
id|device
op_star
comma
id|u16
)paren
suffix:semicolon
r_static
r_void
id|TLan_Timer
c_func
(paren
r_int
r_int
)paren
suffix:semicolon
r_static
r_void
id|TLan_ResetLists
c_func
(paren
r_struct
id|device
op_star
)paren
suffix:semicolon
r_static
r_void
id|TLan_PrintDio
c_func
(paren
id|u16
)paren
suffix:semicolon
r_static
r_void
id|TLan_PrintList
c_func
(paren
id|TLanList
op_star
comma
r_char
op_star
comma
r_int
)paren
suffix:semicolon
r_static
r_void
id|TLan_ReadAndClearStats
c_func
(paren
r_struct
id|device
op_star
comma
r_int
)paren
suffix:semicolon
r_static
r_int
id|TLan_Reset
c_func
(paren
r_struct
id|device
op_star
)paren
suffix:semicolon
r_static
r_void
id|TLan_SetMac
c_func
(paren
r_struct
id|device
op_star
comma
r_int
id|areg
comma
r_char
op_star
id|mac
)paren
suffix:semicolon
r_static
r_int
id|TLan_PhyNop
c_func
(paren
r_struct
id|device
op_star
)paren
suffix:semicolon
r_static
r_void
id|TLan_PhyPrint
c_func
(paren
r_struct
id|device
op_star
)paren
suffix:semicolon
r_static
r_void
id|TLan_PhySelect
c_func
(paren
r_struct
id|device
op_star
)paren
suffix:semicolon
r_static
r_int
id|TLan_PhyInternalCheck
c_func
(paren
r_struct
id|device
op_star
)paren
suffix:semicolon
r_static
r_int
id|TLan_PhyInternalService
c_func
(paren
r_struct
id|device
op_star
)paren
suffix:semicolon
r_static
r_int
id|TLan_PhyDp83840aCheck
c_func
(paren
r_struct
id|device
op_star
)paren
suffix:semicolon
r_static
r_int
id|TLan_MiiReadReg
c_func
(paren
id|u16
comma
id|u16
comma
id|u16
comma
id|u16
op_star
)paren
suffix:semicolon
r_static
r_void
id|TLan_MiiSendData
c_func
(paren
id|u16
comma
id|u32
comma
r_int
)paren
suffix:semicolon
r_static
r_void
id|TLan_MiiSync
c_func
(paren
id|u16
)paren
suffix:semicolon
r_static
r_void
id|TLan_MiiWriteReg
c_func
(paren
id|u16
comma
id|u16
comma
id|u16
comma
id|u16
)paren
suffix:semicolon
r_static
r_void
id|TLan_EeSendStart
c_func
(paren
id|u16
)paren
suffix:semicolon
r_static
r_int
id|TLan_EeSendByte
c_func
(paren
id|u16
comma
id|u8
comma
r_int
)paren
suffix:semicolon
r_static
r_void
id|TLan_EeReceiveByte
c_func
(paren
id|u16
comma
id|u8
op_star
comma
r_int
)paren
suffix:semicolon
r_static
r_int
id|TLan_EeReadByte
c_func
(paren
id|u16
comma
id|u8
comma
id|u8
op_star
)paren
suffix:semicolon
DECL|variable|TLanIntVector
r_static
id|TLanIntVectorFunc
op_star
id|TLanIntVector
(braket
id|TLAN_INT_NUMBER_OF_INTS
)braket
op_assign
(brace
id|TLan_HandleInvalid
comma
id|TLan_HandleTxEOF
comma
id|TLan_HandleStatOverflow
comma
id|TLan_HandleRxEOF
comma
id|TLan_HandleDummy
comma
id|TLan_HandleTxEOC
comma
id|TLan_HandleStatusCheck
comma
id|TLan_HandleRxEOC
)brace
suffix:semicolon
multiline_comment|/*****************************************************************************&n;******************************************************************************&n;&n;&t;ThunderLAN Driver Primary Functions&n;&n;&t;These functions are more or less common to all Linux network drivers.&n;&n;******************************************************************************&n;*****************************************************************************/
macro_line|#ifdef MODULE
multiline_comment|/***************************************************************&n;&t; *&t;init_module&n;&t; *&n;&t; *&t;Returns:&n;&t; *&t;&t;0 if module installed ok, non-zero if not.&n;&t; *&t;Parms:&n;&t; *&t;&t;None&n;&t; *&n;&t; *&t;This function begins the setup of the driver creating a&n;&t; *&t;pad buffer, finding all TLAN devices (matching&n;&t; *&t;TLanDeviceList entries), and creating and initializing a&n;&t; *&t;device structure for each adapter.&n;&t; *&n;&t; **************************************************************/
DECL|function|init_module
r_extern
r_int
id|init_module
c_func
(paren
r_void
)paren
(brace
id|TLanPrivateInfo
op_star
id|priv
suffix:semicolon
id|u8
id|bus
suffix:semicolon
r_struct
id|device
op_star
id|dev
suffix:semicolon
r_int
id|dev_size
suffix:semicolon
id|u8
id|dfn
suffix:semicolon
id|u32
id|dl_ix
suffix:semicolon
r_int
id|failed
suffix:semicolon
r_int
id|found
suffix:semicolon
id|u32
id|io_base
suffix:semicolon
r_int
id|irq
suffix:semicolon
id|u8
id|rev
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;TLAN driver, v%d.%d, (C) 1997 Caldera, Inc.&bslash;n&quot;
comma
id|TLanVersionMajor
comma
id|TLanVersionMinor
)paren
suffix:semicolon
id|TLanPadBuffer
op_assign
(paren
id|u8
op_star
)paren
id|kmalloc
c_func
(paren
id|TLAN_MIN_FRAME_SIZE
comma
(paren
id|GFP_KERNEL
op_or
id|GFP_DMA
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|TLanPadBuffer
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;TLAN:  Could not allocate memory for pad buffer.&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|memset
c_func
(paren
id|TLanPadBuffer
comma
l_int|0
comma
id|TLAN_MIN_FRAME_SIZE
)paren
suffix:semicolon
id|dev_size
op_assign
r_sizeof
(paren
r_struct
id|device
)paren
op_plus
r_sizeof
(paren
id|TLanPrivateInfo
)paren
suffix:semicolon
r_while
c_loop
(paren
(paren
id|found
op_assign
id|TLan_PciProbe
c_func
(paren
op_amp
id|bus
comma
op_amp
id|dfn
comma
op_amp
id|irq
comma
op_amp
id|rev
comma
op_amp
id|io_base
comma
op_amp
id|dl_ix
)paren
)paren
)paren
(brace
id|dev
op_assign
(paren
r_struct
id|device
op_star
)paren
id|kmalloc
c_func
(paren
id|dev_size
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dev
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;TLAN:  Could not allocate memory for device.&bslash;n&quot;
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
id|memset
c_func
(paren
id|dev
comma
l_int|0
comma
id|dev_size
)paren
suffix:semicolon
id|dev-&gt;priv
op_assign
id|priv
op_assign
(paren
(paren
r_void
op_star
)paren
id|dev
)paren
op_plus
r_sizeof
(paren
r_struct
id|device
)paren
suffix:semicolon
id|dev-&gt;name
op_assign
id|priv-&gt;devName
suffix:semicolon
id|strcpy
c_func
(paren
id|priv-&gt;devName
comma
l_string|&quot;    &quot;
)paren
suffix:semicolon
id|dev-&gt;base_addr
op_assign
id|io_base
suffix:semicolon
id|dev-&gt;irq
op_assign
id|irq
suffix:semicolon
id|dev-&gt;init
op_assign
id|TLan_Init
suffix:semicolon
id|priv-&gt;pciBus
op_assign
id|bus
suffix:semicolon
id|priv-&gt;pciDeviceFn
op_assign
id|dfn
suffix:semicolon
id|priv-&gt;pciRevision
op_assign
id|rev
suffix:semicolon
id|priv-&gt;pciEntry
op_assign
id|dl_ix
suffix:semicolon
id|ether_setup
c_func
(paren
id|dev
)paren
suffix:semicolon
id|failed
op_assign
id|register_netdev
c_func
(paren
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|failed
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;TLAN:  Could not register network device.  Freeing struct.&bslash;n&quot;
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
r_else
(brace
id|priv-&gt;nextDevice
op_assign
id|TLanDevices
suffix:semicolon
id|TLanDevices
op_assign
id|dev
suffix:semicolon
id|TLanDevicesInstalled
op_increment
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;TLAN:  %s irq=%2d io=%04x, %s&bslash;n&quot;
comma
id|dev-&gt;name
comma
(paren
r_int
)paren
id|irq
comma
id|io_base
comma
id|TLanDeviceList
(braket
id|dl_ix
)braket
dot
id|deviceName
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* printk( &quot;TLAN:  Found %d device(s).&bslash;n&quot;, TLanDevicesInstalled ); */
r_return
(paren
(paren
id|TLanDevicesInstalled
op_ge
l_int|0
)paren
ques
c_cond
l_int|0
suffix:colon
op_minus
id|ENODEV
)paren
suffix:semicolon
)brace
multiline_comment|/* init_module */
multiline_comment|/***************************************************************&n;&t; *&t;cleanup_module&n;&t; *&n;&t; *&t;Returns:&n;&t; *&t;&t;Nothing&n;&t; *&t;Parms:&n;&t; *&t;&t;None&n;&t; *&n;&t; *&t;Goes through the TLanDevices list and frees the device&n;&t; *&t;structs and memory associated with each device (lists&n;&t; *&t;and buffers).  It also ureserves the IO port regions&n;&t; *&t;associated with this device.&n;&t; *&n;&t; **************************************************************/
DECL|function|cleanup_module
r_extern
r_void
id|cleanup_module
c_func
(paren
r_void
)paren
(brace
r_struct
id|device
op_star
id|dev
suffix:semicolon
id|TLanPrivateInfo
op_star
id|priv
suffix:semicolon
r_while
c_loop
(paren
id|TLanDevicesInstalled
)paren
(brace
id|dev
op_assign
id|TLanDevices
suffix:semicolon
id|priv
op_assign
(paren
id|TLanPrivateInfo
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_if
c_cond
(paren
id|priv-&gt;dmaStorage
)paren
id|kfree
c_func
(paren
id|priv-&gt;dmaStorage
)paren
suffix:semicolon
id|release_region
c_func
(paren
id|dev-&gt;base_addr
comma
l_int|0x10
)paren
suffix:semicolon
id|unregister_netdev
c_func
(paren
id|dev
)paren
suffix:semicolon
id|TLanDevices
op_assign
id|priv-&gt;nextDevice
suffix:semicolon
id|kfree
c_func
(paren
id|dev
)paren
suffix:semicolon
id|TLanDevicesInstalled
op_decrement
suffix:semicolon
)brace
id|kfree
c_func
(paren
id|TLanPadBuffer
)paren
suffix:semicolon
)brace
multiline_comment|/* cleanup_module */
macro_line|#else /* MODULE */
multiline_comment|/***************************************************************&n;&t; *&t;tlan_probe&n;&t; *&n;&t; *&t;Returns:&n;&t; *&t;&t;0 on success, error code on error&n;&t; *&t;Parms:&n;&t; *&t;&t;dev&t;device struct to use if adapter is&n;&t; *&t;&t;&t;found.&n;&t; *&n;&t; *&t;The name is lower case to fit in with all the rest of&n;&t; *&t;the netcard_probe names.  This function looks for a/&n;&t; *&t;another TLan based adapter, setting it up with the&n;&t; *&t;provided device struct if one is found.&n;&t; *&n;&t; **************************************************************/
DECL|function|tlan_probe
r_extern
r_int
id|tlan_probe
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
r_static
r_int
id|pad_allocated
op_assign
l_int|0
suffix:semicolon
r_int
id|found
suffix:semicolon
id|TLanPrivateInfo
op_star
id|priv
suffix:semicolon
id|u8
id|bus
comma
id|dfn
comma
id|rev
suffix:semicolon
r_int
id|irq
suffix:semicolon
id|u32
id|io_base
comma
id|dl_ix
suffix:semicolon
id|found
op_assign
id|TLan_PciProbe
c_func
(paren
op_amp
id|bus
comma
op_amp
id|dfn
comma
op_amp
id|irq
comma
op_amp
id|rev
comma
op_amp
id|io_base
comma
op_amp
id|dl_ix
)paren
suffix:semicolon
r_if
c_cond
(paren
id|found
)paren
(brace
id|dev-&gt;priv
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
id|TLanPrivateInfo
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;priv
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;TLAN:  Could not allocate memory for device.&bslash;n&quot;
)paren
suffix:semicolon
)brace
id|memset
c_func
(paren
id|dev-&gt;priv
comma
l_int|0
comma
r_sizeof
(paren
id|TLanPrivateInfo
)paren
)paren
suffix:semicolon
id|priv
op_assign
(paren
id|TLanPrivateInfo
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|dev-&gt;name
op_assign
id|priv-&gt;devName
suffix:semicolon
id|strcpy
c_func
(paren
id|priv-&gt;devName
comma
l_string|&quot;    &quot;
)paren
suffix:semicolon
id|dev
op_assign
id|init_etherdev
c_func
(paren
id|dev
comma
r_sizeof
(paren
id|TLanPrivateInfo
)paren
)paren
suffix:semicolon
id|dev-&gt;base_addr
op_assign
id|io_base
suffix:semicolon
id|dev-&gt;irq
op_assign
id|irq
suffix:semicolon
id|priv-&gt;pciBus
op_assign
id|bus
suffix:semicolon
id|priv-&gt;pciDeviceFn
op_assign
id|dfn
suffix:semicolon
id|priv-&gt;pciRevision
op_assign
id|rev
suffix:semicolon
id|priv-&gt;pciEntry
op_assign
id|dl_ix
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pad_allocated
)paren
(brace
id|TLanPadBuffer
op_assign
(paren
id|u8
op_star
)paren
id|kmalloc
c_func
(paren
id|TLAN_MIN_FRAME_SIZE
comma
id|GFP_KERNEL
op_or
id|GFP_DMA
)paren
suffix:semicolon
r_if
c_cond
(paren
id|TLanPadBuffer
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;TLAN:  Could not allocate memory for pad buffer.&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_else
(brace
id|pad_allocated
op_assign
l_int|1
suffix:semicolon
id|memset
c_func
(paren
id|TLanPadBuffer
comma
l_int|0
comma
id|TLAN_MIN_FRAME_SIZE
)paren
suffix:semicolon
)brace
)brace
id|printk
c_func
(paren
l_string|&quot;TLAN %d.%d:  %s irq=%2d io=%04x, %s&bslash;n&quot;
comma
id|TLanVersionMajor
comma
id|TLanVersionMinor
comma
id|dev-&gt;name
comma
(paren
r_int
)paren
id|irq
comma
id|io_base
comma
id|TLanDeviceList
(braket
id|dl_ix
)braket
dot
id|deviceName
)paren
suffix:semicolon
id|TLan_Init
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
r_return
(paren
(paren
id|found
)paren
ques
c_cond
l_int|0
suffix:colon
op_minus
id|ENODEV
)paren
suffix:semicolon
)brace
multiline_comment|/* tlan_probe */
macro_line|#endif /* MODULE */
multiline_comment|/***************************************************************&n;&t; *&t;TLan_PciProbe&n;&t; *&n;&t; *&t;Returns:&n;&t; *&t;&t;1 if another TLAN card was found, 0 if not.&n;&t; *&t;Parms:&n;&t; *&t;&t;pci_bus&t;&t;The PCI bus the card was found&n;&t; *&t;&t;&t;&t;on.&n;&t; *&t;&t;pci_dfn&t;&t;The PCI whatever the card was&n;&t; *&t;&t;&t;&t;found at.&n;&t; *&t;&t;pci_irq&t;&t;The IRQ of the found adapter.&n;&t; *&t;&t;pci_rev&t;&t;The revision of the adapter.&n;&t; *&t;&t;pci_io_base&t;The first IO port used by the&n;&t; *&t;&t;&t;&t;adapter.&n;&t; *&t;&t;dl_ix&t;&t;The index in the device list&n;&t; *&t;&t;&t;&t;of the adapter.&n;&t; *&n;&t; *&t;This function searches for an adapter with PCI vendor&n;&t; *&t;and device IDs matching those in the TLanDeviceList.&n;&t; *&t;The function &squot;remembers&squot; the last device it found,&n;&t; *&t;and so finds a new device (if anymore are to be found)&n;&t; *&t;each time the function is called.  It then looks up&n;&t; *&t;pertinent PCI info and returns it to the caller.&n;&t; *&n;&t; **************************************************************/
DECL|function|TLan_PciProbe
r_int
id|TLan_PciProbe
c_func
(paren
id|u8
op_star
id|pci_bus
comma
id|u8
op_star
id|pci_dfn
comma
r_int
op_star
id|pci_irq
comma
id|u8
op_star
id|pci_rev
comma
id|u32
op_star
id|pci_io_base
comma
id|u32
op_star
id|dl_ix
)paren
(brace
r_static
r_int
id|dl_index
op_assign
l_int|0
suffix:semicolon
r_static
r_int
id|pci_index
op_assign
l_int|0
suffix:semicolon
r_int
id|not_found
suffix:semicolon
id|u8
id|pci_latency
suffix:semicolon
id|u16
id|pci_command
suffix:semicolon
r_int
id|reg
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pci_present
c_func
(paren
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;TLAN:   PCI Bios not present.&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_for
c_loop
(paren
suffix:semicolon
id|TLanDeviceList
(braket
id|dl_index
)braket
dot
id|vendorId
op_ne
l_int|0
suffix:semicolon
id|dl_index
op_increment
)paren
(brace
id|not_found
op_assign
id|pcibios_find_device
c_func
(paren
id|TLanDeviceList
(braket
id|dl_index
)braket
dot
id|vendorId
comma
id|TLanDeviceList
(braket
id|dl_index
)braket
dot
id|deviceId
comma
id|pci_index
comma
id|pci_bus
comma
id|pci_dfn
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|not_found
)paren
(brace
r_struct
id|pci_dev
op_star
id|pdev
op_assign
id|pci_find_slot
c_func
(paren
op_star
id|pci_bus
comma
op_star
id|pci_dfn
)paren
suffix:semicolon
id|TLAN_DBG
c_func
(paren
id|TLAN_DEBUG_GNRL
comma
l_string|&quot;TLAN:  found: Vendor Id = 0x%hx, Device Id = 0x%hx&bslash;n&quot;
comma
id|TLanDeviceList
(braket
id|dl_index
)braket
dot
id|vendorId
comma
id|TLanDeviceList
(braket
id|dl_index
)braket
dot
id|deviceId
)paren
suffix:semicolon
id|pci_read_config_byte
(paren
id|pdev
comma
id|PCI_REVISION_ID
comma
id|pci_rev
)paren
suffix:semicolon
op_star
id|pci_irq
op_assign
id|pdev-&gt;irq
suffix:semicolon
id|pci_read_config_word
(paren
id|pdev
comma
id|PCI_COMMAND
comma
op_amp
id|pci_command
)paren
suffix:semicolon
id|pci_read_config_byte
(paren
id|pdev
comma
id|PCI_LATENCY_TIMER
comma
op_amp
id|pci_latency
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pci_latency
OL
l_int|0x10
)paren
(brace
id|pci_write_config_byte
c_func
(paren
id|pdev
comma
id|PCI_LATENCY_TIMER
comma
l_int|0xff
)paren
suffix:semicolon
id|TLAN_DBG
c_func
(paren
id|TLAN_DEBUG_GNRL
comma
l_string|&quot;TLAN:    Setting latency timer to max.&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_for
c_loop
(paren
id|reg
op_assign
l_int|0
suffix:semicolon
id|reg
op_le
l_int|5
suffix:semicolon
id|reg
op_increment
)paren
(brace
op_star
id|pci_io_base
op_assign
id|pdev-&gt;base_address
(braket
id|reg
)braket
suffix:semicolon
r_if
c_cond
(paren
(paren
id|pci_command
op_amp
id|PCI_COMMAND_IO
)paren
op_logical_and
(paren
op_star
id|pci_io_base
op_amp
l_int|0x3
)paren
)paren
(brace
op_star
id|pci_io_base
op_and_assign
id|PCI_BASE_ADDRESS_IO_MASK
suffix:semicolon
id|TLAN_DBG
c_func
(paren
id|TLAN_DEBUG_GNRL
comma
l_string|&quot;TLAN:    IO mapping is available at %x.&bslash;n&quot;
comma
op_star
id|pci_io_base
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_else
(brace
op_star
id|pci_io_base
op_assign
l_int|0
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
op_star
id|pci_io_base
op_eq
l_int|0
)paren
id|printk
c_func
(paren
l_string|&quot;TLAN:    IO mapping not available, ignoring device.&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pci_command
op_amp
id|PCI_COMMAND_MASTER
)paren
(brace
id|TLAN_DBG
c_func
(paren
id|TLAN_DEBUG_GNRL
comma
l_string|&quot;TLAN:    Bus mastering is active.&bslash;n&quot;
)paren
suffix:semicolon
)brace
id|pci_index
op_increment
suffix:semicolon
r_if
c_cond
(paren
op_star
id|pci_io_base
)paren
(brace
op_star
id|dl_ix
op_assign
id|dl_index
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
)brace
r_else
(brace
id|pci_index
op_assign
l_int|0
suffix:semicolon
)brace
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* TLan_PciProbe */
multiline_comment|/***************************************************************&n;&t; *&t;TLan_Init&n;&t; *&n;&t; *&t;Returns:&n;&t; *&t;&t;0 on success, error code otherwise.&n;&t; *&t;Parms:&n;&t; *&t;&t;dev&t;The structure of the device to be&n;&t; *&t;&t;&t;init&squot;ed.&n;&t; *&n;&t; *&t;This function completes the initialization of the&n;&t; *&t;device structure and driver.  It reserves the IO&n;&t; *&t;addresses, allocates memory for the lists and bounce&n;&t; *&t;buffers, retrieves the MAC address from the eeprom&n;&t; *&t;and assignes the device&squot;s methods.&n;&t; *&t;&n;&t; **************************************************************/
DECL|function|TLan_Init
r_int
id|TLan_Init
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
r_int
id|dma_size
suffix:semicolon
r_int
id|err
suffix:semicolon
r_int
id|i
suffix:semicolon
id|TLanPrivateInfo
op_star
id|priv
suffix:semicolon
id|priv
op_assign
(paren
id|TLanPrivateInfo
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|err
op_assign
id|check_region
c_func
(paren
id|dev-&gt;base_addr
comma
l_int|0x10
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;TLAN:  %s: Io port region 0x%lx size 0x%x in use.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|dev-&gt;base_addr
comma
l_int|0x10
)paren
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
id|request_region
c_func
(paren
id|dev-&gt;base_addr
comma
l_int|0x10
comma
id|TLanSignature
)paren
suffix:semicolon
id|dma_size
op_assign
(paren
id|TLAN_NUM_RX_LISTS
op_plus
id|TLAN_NUM_TX_LISTS
)paren
op_star
(paren
r_sizeof
(paren
id|TLanList
)paren
op_plus
id|TLAN_MAX_FRAME_SIZE
)paren
suffix:semicolon
id|priv-&gt;dmaStorage
op_assign
id|kmalloc
c_func
(paren
id|dma_size
comma
id|GFP_KERNEL
op_or
id|GFP_DMA
)paren
suffix:semicolon
r_if
c_cond
(paren
id|priv-&gt;dmaStorage
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;TLAN:  Could not allocate lists and buffers for %s.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|memset
c_func
(paren
id|priv-&gt;dmaStorage
comma
l_int|0
comma
id|dma_size
)paren
suffix:semicolon
id|priv-&gt;rxList
op_assign
(paren
id|TLanList
op_star
)paren
(paren
(paren
(paren
(paren
id|u32
)paren
id|priv-&gt;dmaStorage
)paren
op_plus
l_int|7
)paren
op_amp
l_int|0xFFFFFFF8
)paren
suffix:semicolon
id|priv-&gt;txList
op_assign
id|priv-&gt;rxList
op_plus
id|TLAN_NUM_RX_LISTS
suffix:semicolon
id|priv-&gt;rxBuffer
op_assign
(paren
id|u8
op_star
)paren
(paren
id|priv-&gt;txList
op_plus
id|TLAN_NUM_TX_LISTS
)paren
suffix:semicolon
id|priv-&gt;txBuffer
op_assign
id|priv-&gt;rxBuffer
op_plus
(paren
id|TLAN_NUM_RX_LISTS
op_star
id|TLAN_MAX_FRAME_SIZE
)paren
suffix:semicolon
id|err
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|6
suffix:semicolon
id|i
op_increment
)paren
id|err
op_or_assign
id|TLan_EeReadByte
c_func
(paren
id|dev-&gt;base_addr
comma
(paren
id|u8
)paren
l_int|0x83
op_plus
id|i
comma
(paren
id|u8
op_star
)paren
op_amp
id|dev-&gt;dev_addr
(braket
id|i
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
id|printk
c_func
(paren
l_string|&quot;TLAN:  %s: Error reading MAC from eeprom: %d&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|err
)paren
suffix:semicolon
id|dev-&gt;addr_len
op_assign
l_int|6
suffix:semicolon
id|dev-&gt;open
op_assign
op_amp
id|TLan_Open
suffix:semicolon
id|dev-&gt;hard_start_xmit
op_assign
op_amp
id|TLan_StartTx
suffix:semicolon
id|dev-&gt;stop
op_assign
op_amp
id|TLan_Close
suffix:semicolon
id|dev-&gt;get_stats
op_assign
op_amp
id|TLan_GetStats
suffix:semicolon
id|dev-&gt;set_multicast_list
op_assign
op_amp
id|TLan_SetMulticastList
suffix:semicolon
macro_line|#ifndef MODULE
id|aui
op_assign
id|dev-&gt;mem_start
op_amp
l_int|0x01
suffix:semicolon
id|debug
op_assign
id|dev-&gt;mem_end
suffix:semicolon
macro_line|#endif /* MODULE */
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* TLan_Init */
multiline_comment|/***************************************************************&n;&t; *&t;TLan_Open&n;&t; *&n;&t; *&t;Returns:&n;&t; *&t;&t;0 on success, error code otherwise.&n;&t; *&t;Parms:&n;&t; *&t;&t;dev&t;Structure of device to be opened.&n;&t; *&n;&t; *&t;This routine puts the driver and TLAN adapter in a&n;&t; *&t;state where it is ready to send and receive packets.&n;&t; *&t;It allocates the IRQ, resets and brings the adapter&n;&t; *&t;out of reset, and allows interrupts.  It also delays&n;&t; *&t;the startup for autonegotiation or sends a Rx GO&n;&t; *&t;command to the adapter, as appropriate.&n;&t; *&n;&t; **************************************************************/
DECL|function|TLan_Open
r_int
id|TLan_Open
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
r_int
id|err
suffix:semicolon
id|TLanPrivateInfo
op_star
id|priv
op_assign
(paren
id|TLanPrivateInfo
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|priv-&gt;tlanRev
op_assign
id|TLan_DioRead8
c_func
(paren
id|dev-&gt;base_addr
comma
id|TLAN_DEF_REVISION
)paren
suffix:semicolon
id|err
op_assign
id|request_irq
c_func
(paren
id|dev-&gt;irq
comma
id|TLan_HandleInterrupt
comma
id|SA_SHIRQ
comma
id|TLanSignature
comma
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;TLAN:  Cannot open %s because IRQ %d is already in use.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|dev-&gt;irq
)paren
suffix:semicolon
r_return
op_minus
id|EAGAIN
suffix:semicolon
)brace
id|MOD_INC_USE_COUNT
suffix:semicolon
id|dev-&gt;tbusy
op_assign
l_int|0
suffix:semicolon
id|dev-&gt;interrupt
op_assign
l_int|0
suffix:semicolon
id|dev-&gt;start
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* NOTE: It might not be necessary to read the stats before a&n;&t;&t;&t; reset if you don&squot;t care what the values are.&n;&t;*/
id|TLan_ResetLists
c_func
(paren
id|dev
)paren
suffix:semicolon
id|TLan_ReadAndClearStats
c_func
(paren
id|dev
comma
id|TLAN_IGNORE
)paren
suffix:semicolon
id|TLan_Reset
c_func
(paren
id|dev
)paren
suffix:semicolon
id|TLan_Reset
c_func
(paren
id|dev
)paren
suffix:semicolon
id|TLan_SetMac
c_func
(paren
id|dev
comma
l_int|0
comma
id|dev-&gt;dev_addr
)paren
suffix:semicolon
id|outb
c_func
(paren
(paren
id|TLAN_HC_INT_ON
op_rshift
l_int|8
)paren
comma
id|dev-&gt;base_addr
op_plus
id|TLAN_HOST_CMD
op_plus
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|debug
op_ge
l_int|1
)paren
id|outb
c_func
(paren
(paren
id|TLAN_HC_REQ_INT
op_rshift
l_int|8
)paren
comma
id|dev-&gt;base_addr
op_plus
id|TLAN_HOST_CMD
op_plus
l_int|1
)paren
suffix:semicolon
id|init_timer
c_func
(paren
op_amp
id|priv-&gt;timer
)paren
suffix:semicolon
id|priv-&gt;timer.data
op_assign
(paren
r_int
r_int
)paren
id|dev
suffix:semicolon
id|priv-&gt;timer.function
op_assign
op_amp
id|TLan_Timer
suffix:semicolon
r_if
c_cond
(paren
id|priv-&gt;phyFlags
op_amp
id|TLAN_PHY_AUTONEG
)paren
(brace
id|priv-&gt;timer.expires
op_assign
id|jiffies
op_plus
id|TLAN_TIMER_LINK_DELAY
suffix:semicolon
id|priv-&gt;timerSetAt
op_assign
id|jiffies
suffix:semicolon
id|priv-&gt;timerType
op_assign
id|TLAN_TIMER_LINK
suffix:semicolon
id|add_timer
c_func
(paren
op_amp
id|priv-&gt;timer
)paren
suffix:semicolon
)brace
r_else
(brace
id|outl
c_func
(paren
id|virt_to_bus
c_func
(paren
id|priv-&gt;rxList
)paren
comma
id|dev-&gt;base_addr
op_plus
id|TLAN_CH_PARM
)paren
suffix:semicolon
id|outl
c_func
(paren
id|TLAN_HC_GO
op_or
id|TLAN_HC_RT
comma
id|dev-&gt;base_addr
op_plus
id|TLAN_HOST_CMD
)paren
suffix:semicolon
)brace
id|TLAN_DBG
c_func
(paren
id|TLAN_DEBUG_GNRL
comma
l_string|&quot;TLAN:  Device %s opened.  Revision = %x&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|priv-&gt;tlanRev
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* TLan_Open */
multiline_comment|/***************************************************************&n;&t; *&t;TLan_StartTx&n;&t; *  &n;&t; *&t;Returns:&n;&t; *&t;&t;0 on success, non-zero on failure.&n;&t; *&t;Parms:&n;&t; *&t;&t;skb&t;A pointer to the sk_buff containing the&n;&t; *&t;&t;&t;frame to be sent.&n;&t; *&t;&t;dev&t;The device to send the data on.&n;&t; *&n;&t; *&t;This function adds a frame to the Tx list to be sent&n;&t; *&t;ASAP.  First it&t;verifies that the adapter is ready and&n;&t; *&t;there is room in the queue.  Then it sets up the next&n;&t; *&t;available list, copies the frame to the&t;corresponding&n;&t; *&t;buffer.  If the adapter Tx channel is idle, it gives&n;&t; *&t;the adapter a Tx Go command on the list, otherwise it&n;&t; *&t;sets the forward address of the previous list to point&n;&t; *&t;to this one.  Then it frees the sk_buff.&n;&t; *&n;&t; **************************************************************/
DECL|function|TLan_StartTx
r_int
id|TLan_StartTx
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|device
op_star
id|dev
)paren
(brace
id|TLanPrivateInfo
op_star
id|priv
op_assign
(paren
id|TLanPrivateInfo
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|TLanList
op_star
id|tail_list
suffix:semicolon
id|u8
op_star
id|tail_buffer
suffix:semicolon
r_int
id|pad
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|priv-&gt;phyOnline
)paren
(brace
id|TLAN_DBG
c_func
(paren
id|TLAN_DEBUG_TX
comma
l_string|&quot;TLAN TRANSMIT:  %s PHY is not ready&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|dev_kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|tail_list
op_assign
id|priv-&gt;txList
op_plus
id|priv-&gt;txTail
suffix:semicolon
r_if
c_cond
(paren
id|tail_list-&gt;cStat
op_ne
id|TLAN_CSTAT_UNUSED
)paren
(brace
id|TLAN_DBG
c_func
(paren
id|TLAN_DEBUG_TX
comma
l_string|&quot;TLAN TRANSMIT:  %s is busy (Head=%d Tail=%d)&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|priv-&gt;txHead
comma
id|priv-&gt;txTail
)paren
suffix:semicolon
id|dev-&gt;tbusy
op_assign
l_int|1
suffix:semicolon
id|priv-&gt;txBusyCount
op_increment
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
id|tail_list-&gt;forward
op_assign
l_int|0
suffix:semicolon
id|tail_buffer
op_assign
id|priv-&gt;txBuffer
op_plus
(paren
id|priv-&gt;txTail
op_star
id|TLAN_MAX_FRAME_SIZE
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|tail_buffer
comma
id|skb-&gt;data
comma
id|skb-&gt;len
)paren
suffix:semicolon
id|pad
op_assign
id|TLAN_MIN_FRAME_SIZE
op_minus
id|skb-&gt;len
suffix:semicolon
r_if
c_cond
(paren
id|pad
OG
l_int|0
)paren
(brace
id|tail_list-&gt;frameSize
op_assign
(paren
id|u16
)paren
id|skb-&gt;len
op_plus
id|pad
suffix:semicolon
id|tail_list-&gt;buffer
(braket
l_int|0
)braket
dot
id|count
op_assign
(paren
id|u32
)paren
id|skb-&gt;len
suffix:semicolon
id|tail_list-&gt;buffer
(braket
l_int|1
)braket
dot
id|count
op_assign
id|TLAN_LAST_BUFFER
op_or
(paren
id|u32
)paren
id|pad
suffix:semicolon
id|tail_list-&gt;buffer
(braket
l_int|1
)braket
dot
id|address
op_assign
id|virt_to_bus
c_func
(paren
id|TLanPadBuffer
)paren
suffix:semicolon
)brace
r_else
(brace
id|tail_list-&gt;frameSize
op_assign
(paren
id|u16
)paren
id|skb-&gt;len
suffix:semicolon
id|tail_list-&gt;buffer
(braket
l_int|0
)braket
dot
id|count
op_assign
id|TLAN_LAST_BUFFER
op_or
(paren
id|u32
)paren
id|skb-&gt;len
suffix:semicolon
id|tail_list-&gt;buffer
(braket
l_int|1
)braket
dot
id|count
op_assign
l_int|0
suffix:semicolon
id|tail_list-&gt;buffer
(braket
l_int|1
)braket
dot
id|address
op_assign
l_int|0
suffix:semicolon
)brace
multiline_comment|/* are we transferring? */
id|cli
c_func
(paren
)paren
suffix:semicolon
id|tail_list-&gt;cStat
op_assign
id|TLAN_CSTAT_READY
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|priv-&gt;txInProgress
)paren
(brace
id|priv-&gt;txInProgress
op_assign
l_int|1
suffix:semicolon
id|outw
c_func
(paren
l_int|0x4
comma
id|dev-&gt;base_addr
op_plus
id|TLAN_HOST_INT
)paren
suffix:semicolon
id|TLAN_DBG
c_func
(paren
id|TLAN_DEBUG_TX
comma
l_string|&quot;TLAN TRANSMIT:  Starting TX on buffer %d&bslash;n&quot;
comma
id|priv-&gt;txTail
)paren
suffix:semicolon
id|outl
c_func
(paren
id|virt_to_bus
c_func
(paren
id|tail_list
)paren
comma
id|dev-&gt;base_addr
op_plus
id|TLAN_CH_PARM
)paren
suffix:semicolon
id|outl
c_func
(paren
id|TLAN_HC_GO
op_or
id|TLAN_HC_ACK
comma
id|dev-&gt;base_addr
op_plus
id|TLAN_HOST_CMD
)paren
suffix:semicolon
)brace
r_else
(brace
id|TLAN_DBG
c_func
(paren
id|TLAN_DEBUG_TX
comma
l_string|&quot;TLAN TRANSMIT:  Adding buffer %d to TX channel&bslash;n&quot;
comma
id|priv-&gt;txTail
)paren
suffix:semicolon
r_if
c_cond
(paren
id|priv-&gt;txTail
op_eq
l_int|0
)paren
(paren
id|priv-&gt;txList
op_plus
(paren
id|TLAN_NUM_TX_LISTS
op_minus
l_int|1
)paren
)paren
op_member_access_from_pointer
id|forward
op_assign
id|virt_to_bus
c_func
(paren
id|tail_list
)paren
suffix:semicolon
r_else
(paren
id|priv-&gt;txList
op_plus
(paren
id|priv-&gt;txTail
op_minus
l_int|1
)paren
)paren
op_member_access_from_pointer
id|forward
op_assign
id|virt_to_bus
c_func
(paren
id|tail_list
)paren
suffix:semicolon
)brace
id|sti
c_func
(paren
)paren
suffix:semicolon
id|priv-&gt;txTail
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|priv-&gt;txTail
op_ge
id|TLAN_NUM_TX_LISTS
)paren
id|priv-&gt;txTail
op_assign
l_int|0
suffix:semicolon
id|dev_kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
id|dev-&gt;trans_start
op_assign
id|jiffies
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* TLan_StartTx */
multiline_comment|/***************************************************************&n;&t; *&t;TLan_HandleInterrupt&n;&t; *  &n;&t; *&t;Returns:&t;&n;&t; *&t;&t;Nothing&n;&t; *&t;Parms:&n;&t; *&t;&t;irq&t;The line on which the interrupt&n;&t; *&t;&t;&t;occurred.&n;&t; *&t;&t;dev_id&t;A pointer to the device assigned to&n;&t; *&t;&t;&t;this irq line.&n;&t; *&t;&t;regs&t;???&n;&t; *&n;&t; *&t;This function handles an interrupt generated by its&n;&t; *&t;assigned TLAN adapter.  The function deactivates&n;&t; *&t;interrupts on its adapter, records the type of&n;&t; *&t;interrupt, executes the appropriate subhandler, and&n;&t; *&t;acknowdges the interrupt to the adapter (thus&n;&t; *&t;re-enabling adapter interrupts.&n;&t; *&n;&t; **************************************************************/
DECL|function|TLan_HandleInterrupt
r_void
id|TLan_HandleInterrupt
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
id|u32
id|ack
suffix:semicolon
r_struct
id|device
op_star
id|dev
suffix:semicolon
id|u32
id|host_cmd
suffix:semicolon
id|u16
id|host_int
suffix:semicolon
r_int
id|type
suffix:semicolon
id|dev
op_assign
(paren
r_struct
id|device
op_star
)paren
id|dev_id
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;interrupt
)paren
id|printk
c_func
(paren
l_string|&quot;TLAN:   Re-entering interrupt handler for %s: %d.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|dev-&gt;interrupt
)paren
suffix:semicolon
id|dev-&gt;interrupt
op_increment
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|host_int
op_assign
id|inw
c_func
(paren
id|dev-&gt;base_addr
op_plus
id|TLAN_HOST_INT
)paren
suffix:semicolon
id|outw
c_func
(paren
id|host_int
comma
id|dev-&gt;base_addr
op_plus
id|TLAN_HOST_INT
)paren
suffix:semicolon
multiline_comment|/* Deactivate Ints */
id|type
op_assign
(paren
id|host_int
op_amp
id|TLAN_HI_IT_MASK
)paren
op_rshift
l_int|2
suffix:semicolon
id|ack
op_assign
id|TLanIntVector
(braket
id|type
)braket
(paren
id|dev
comma
id|host_int
)paren
suffix:semicolon
id|sti
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ack
)paren
(brace
id|host_cmd
op_assign
id|TLAN_HC_ACK
op_or
id|ack
op_or
(paren
id|type
op_lshift
l_int|18
)paren
suffix:semicolon
id|outl
c_func
(paren
id|host_cmd
comma
id|dev-&gt;base_addr
op_plus
id|TLAN_HOST_CMD
)paren
suffix:semicolon
)brace
id|dev-&gt;interrupt
op_decrement
suffix:semicolon
)brace
multiline_comment|/* TLan_HandleInterrupts */
multiline_comment|/***************************************************************&n;&t; *&t;TLan_Close&n;&t; *  &n;&t; * &t;Returns:&n;&t; *&t;&t;An error code.&n;&t; *&t;Parms:&n;&t; *&t;&t;dev&t;The device structure of the device to&n;&t; *&t;&t;&t;close.&n;&t; *&n;&t; *&t;This function shuts down the adapter.  It records any&n;&t; *&t;stats, puts the adapter into reset state, deactivates&n;&t; *&t;its time as needed, and&t;frees the irq it is using.&n;&t; *&n;&t; **************************************************************/
DECL|function|TLan_Close
r_int
id|TLan_Close
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
id|TLanPrivateInfo
op_star
id|priv
op_assign
(paren
id|TLanPrivateInfo
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|dev-&gt;start
op_assign
l_int|0
suffix:semicolon
id|dev-&gt;tbusy
op_assign
l_int|1
suffix:semicolon
id|TLan_ReadAndClearStats
c_func
(paren
id|dev
comma
id|TLAN_RECORD
)paren
suffix:semicolon
id|outl
c_func
(paren
id|TLAN_HC_AD_RST
comma
id|dev-&gt;base_addr
op_plus
id|TLAN_HOST_CMD
)paren
suffix:semicolon
r_if
c_cond
(paren
id|priv-&gt;timerSetAt
op_ne
l_int|0
)paren
id|del_timer
c_func
(paren
op_amp
id|priv-&gt;timer
)paren
suffix:semicolon
id|free_irq
c_func
(paren
id|dev-&gt;irq
comma
id|dev
)paren
suffix:semicolon
id|TLAN_DBG
c_func
(paren
id|TLAN_DEBUG_GNRL
comma
l_string|&quot;TLAN:   Device %s closed.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|MOD_DEC_USE_COUNT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* TLan_Close */
multiline_comment|/***************************************************************&n;&t; *&t;TLan_GetStats&n;&t; *  &n;&t; *&t;Returns:&n;&t; *&t;&t;A pointer to the device&squot;s statistics structure.&n;&t; *&t;Parms:&n;&t; *&t;&t;dev&t;The device structure to return the&n;&t; *&t;&t;&t;stats for.&n;&t; *&n;&t; *&t;This function updates the devices statistics by reading&n;&t; *&t;the TLAN chip&squot;s onboard registers.  Then it returns the&n;&t; *&t;address of the statistics structure.&n;&t; *&n;&t; **************************************************************/
DECL|function|TLan_GetStats
r_struct
id|net_device_stats
op_star
id|TLan_GetStats
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
id|TLanPrivateInfo
op_star
id|priv
op_assign
(paren
id|TLanPrivateInfo
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_int
id|i
suffix:semicolon
multiline_comment|/* Should only read stats if open ? */
id|TLan_ReadAndClearStats
c_func
(paren
id|dev
comma
id|TLAN_RECORD
)paren
suffix:semicolon
id|TLAN_DBG
c_func
(paren
id|TLAN_DEBUG_RX
comma
l_string|&quot;TLAN RECEIVE:  %s EOC count = %d&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|priv-&gt;rxEocCount
)paren
suffix:semicolon
id|TLAN_DBG
c_func
(paren
id|TLAN_DEBUG_TX
comma
l_string|&quot;TLAN TRANSMIT:  %s Busy count = %d&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|priv-&gt;txBusyCount
)paren
suffix:semicolon
r_if
c_cond
(paren
id|debug
op_amp
id|TLAN_DEBUG_GNRL
)paren
(brace
id|TLan_PrintDio
c_func
(paren
id|dev-&gt;base_addr
)paren
suffix:semicolon
id|TLan_PhyPrint
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|debug
op_amp
id|TLAN_DEBUG_LIST
)paren
(brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|TLAN_NUM_RX_LISTS
suffix:semicolon
id|i
op_increment
)paren
id|TLan_PrintList
c_func
(paren
id|priv-&gt;rxList
op_plus
id|i
comma
l_string|&quot;RX&quot;
comma
id|i
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|TLAN_NUM_TX_LISTS
suffix:semicolon
id|i
op_increment
)paren
id|TLan_PrintList
c_func
(paren
id|priv-&gt;txList
op_plus
id|i
comma
l_string|&quot;TX&quot;
comma
id|i
)paren
suffix:semicolon
)brace
r_return
(paren
op_amp
(paren
(paren
id|TLanPrivateInfo
op_star
)paren
id|dev-&gt;priv
)paren
op_member_access_from_pointer
id|stats
)paren
suffix:semicolon
)brace
multiline_comment|/* TLan_GetStats */
multiline_comment|/***************************************************************&n;&t; *&t;TLan_SetMulticastList&n;&t; *  &n;&t; *&t;Returns:&n;&t; *&t;&t;Nothing&n;&t; *&t;Parms:&n;&t; *&t;&t;dev&t;The device structure to set the&n;&t; *&t;&t;&t;multicast list for.&n;&t; *&n;&t; *&t;This function sets the TLAN adaptor to various receive&n;&t; *&t;modes.  If the IFF_PROMISC flag is set, promiscuous&n;&t; *&t;mode is acitviated.  Otherwise,&t;promiscuous mode is&n;&t; *&t;turned off.  If the IFF_ALLMULTI flag is set, then&n;&t; *&t;the hash table is set to receive all group addresses.&n;&t; *&t;Otherwise, the first three multicast addresses are&n;&t; *&t;stored in AREG_1-3, and the rest are selected via the&n;&t; *&t;hash table, as necessary.&n;&t; *&n;&t; **************************************************************/
DECL|function|TLan_SetMulticastList
r_void
id|TLan_SetMulticastList
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
r_struct
id|dev_mc_list
op_star
id|dmi
op_assign
id|dev-&gt;mc_list
suffix:semicolon
id|u32
id|hash1
op_assign
l_int|0
suffix:semicolon
id|u32
id|hash2
op_assign
l_int|0
suffix:semicolon
r_int
id|i
suffix:semicolon
id|u32
id|offset
suffix:semicolon
id|u8
id|tmp
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;flags
op_amp
id|IFF_PROMISC
)paren
(brace
id|tmp
op_assign
id|TLan_DioRead8
c_func
(paren
id|dev-&gt;base_addr
comma
id|TLAN_NET_CMD
)paren
suffix:semicolon
id|TLan_DioWrite8
c_func
(paren
id|dev-&gt;base_addr
comma
id|TLAN_NET_CMD
comma
id|tmp
op_or
id|TLAN_NET_CMD_CAF
)paren
suffix:semicolon
)brace
r_else
(brace
id|tmp
op_assign
id|TLan_DioRead8
c_func
(paren
id|dev-&gt;base_addr
comma
id|TLAN_NET_CMD
)paren
suffix:semicolon
id|TLan_DioWrite8
c_func
(paren
id|dev-&gt;base_addr
comma
id|TLAN_NET_CMD
comma
id|tmp
op_amp
op_complement
id|TLAN_NET_CMD_CAF
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;flags
op_amp
id|IFF_ALLMULTI
)paren
(brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|3
suffix:semicolon
id|i
op_increment
)paren
id|TLan_SetMac
c_func
(paren
id|dev
comma
id|i
op_plus
l_int|1
comma
l_int|NULL
)paren
suffix:semicolon
id|TLan_DioWrite32
c_func
(paren
id|dev-&gt;base_addr
comma
id|TLAN_HASH_1
comma
l_int|0xFFFFFFFF
)paren
suffix:semicolon
id|TLan_DioWrite32
c_func
(paren
id|dev-&gt;base_addr
comma
id|TLAN_HASH_2
comma
l_int|0xFFFFFFFF
)paren
suffix:semicolon
)brace
r_else
(brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|dev-&gt;mc_count
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|i
OL
l_int|3
)paren
(brace
id|TLan_SetMac
c_func
(paren
id|dev
comma
id|i
op_plus
l_int|1
comma
(paren
r_char
op_star
)paren
op_amp
id|dmi-&gt;dmi_addr
)paren
suffix:semicolon
)brace
r_else
(brace
id|offset
op_assign
id|TLan_HashFunc
c_func
(paren
(paren
id|u8
op_star
)paren
op_amp
id|dmi-&gt;dmi_addr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|offset
OL
l_int|32
)paren
id|hash1
op_or_assign
(paren
l_int|1
op_lshift
id|offset
)paren
suffix:semicolon
r_else
id|hash2
op_or_assign
(paren
l_int|1
op_lshift
(paren
id|offset
op_minus
l_int|32
)paren
)paren
suffix:semicolon
)brace
id|dmi
op_assign
id|dmi-&gt;next
suffix:semicolon
)brace
r_for
c_loop
(paren
suffix:semicolon
id|i
OL
l_int|3
suffix:semicolon
id|i
op_increment
)paren
id|TLan_SetMac
c_func
(paren
id|dev
comma
id|i
op_plus
l_int|1
comma
l_int|NULL
)paren
suffix:semicolon
id|TLan_DioWrite32
c_func
(paren
id|dev-&gt;base_addr
comma
id|TLAN_HASH_1
comma
id|hash1
)paren
suffix:semicolon
id|TLan_DioWrite32
c_func
(paren
id|dev-&gt;base_addr
comma
id|TLAN_HASH_2
comma
id|hash2
)paren
suffix:semicolon
)brace
)brace
)brace
multiline_comment|/* TLan_SetMulticastList */
multiline_comment|/*****************************************************************************&n;******************************************************************************&n;&n;        ThunderLAN Driver Interrupt Vectors and Table&n;&n;&t;Please see Chap. 4, &quot;Interrupt Handling&quot; of the &quot;ThunderLAN&n;&t;Programmer&squot;s Guide&quot; for more informations on handling interrupts&n;&t;generated by TLAN based adapters.  &n;&n;******************************************************************************&n;*****************************************************************************/
multiline_comment|/***************************************************************&n;&t; *&t;TLan_HandleInvalid&n;&t; *&n;&t; *&t;Returns:&n;&t; *&t;&t;0&n;&t; *&t;Parms:&n;&t; *&t;&t;dev&t;&t;Device assigned the IRQ that was&n;&t; *&t;&t;&t;&t;raised.&n;&t; *&t;&t;host_int&t;The contents of the HOST_INT&n;&t; *&t;&t;&t;&t;port.&n;&t; *&n;&t; *&t;This function handles invalid interrupts.  This should&n;&t; *&t;never happen unless some other adapter is trying to use&n;&t; *&t;the IRQ line assigned to the device.&n;&t; *&n;&t; **************************************************************/
DECL|function|TLan_HandleInvalid
id|u32
id|TLan_HandleInvalid
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
id|u16
id|host_int
)paren
(brace
id|host_int
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* printk( &quot;TLAN:  Invalid interrupt on %s.&bslash;n&quot;, dev-&gt;name ); */
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* TLan_HandleInvalid */
multiline_comment|/***************************************************************&n;&t; *&t;TLan_HandleTxEOF&n;&t; *&n;&t; *&t;Returns:&n;&t; *&t;&t;1&n;&t; *&t;Parms:&n;&t; *&t;&t;dev&t;&t;Device assigned the IRQ that was&n;&t; *&t;&t;&t;&t;raised.&n;&t; *&t;&t;host_int&t;The contents of the HOST_INT&n;&t; *&t;&t;&t;&t;port.&n;&t; *&n;&t; *&t;This function handles Tx EOF interrupts which are raised&n;&t; *&t;by the adapter when it has completed sending the&n;&t; *&t;contents of a buffer.  If detemines which list/buffer&n;&t; *&t;was completed and resets it.  If the buffer was the last&n;&t; *&t;in the channel (EOC), then the function checks to see if&n;&t; *&t;another buffer is ready to send, and if so, sends a Tx&n;&t; *&t;Go command.  Finally, the driver activates/continues the&n;&t; *&t;activity LED.&n;&t; *&n;&t; **************************************************************/
DECL|function|TLan_HandleTxEOF
id|u32
id|TLan_HandleTxEOF
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
id|u16
id|host_int
)paren
(brace
id|TLanPrivateInfo
op_star
id|priv
op_assign
(paren
id|TLanPrivateInfo
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_int
id|eoc
op_assign
l_int|0
suffix:semicolon
id|TLanList
op_star
id|head_list
suffix:semicolon
id|u32
id|ack
op_assign
l_int|1
suffix:semicolon
id|TLAN_DBG
c_func
(paren
id|TLAN_DEBUG_TX
comma
l_string|&quot;TLAN TRANSMIT:  Handling TX EOF (Head=%d Tail=%d)&bslash;n&quot;
comma
id|priv-&gt;txHead
comma
id|priv-&gt;txTail
)paren
suffix:semicolon
id|host_int
op_assign
l_int|0
suffix:semicolon
id|head_list
op_assign
id|priv-&gt;txList
op_plus
id|priv-&gt;txHead
suffix:semicolon
r_if
c_cond
(paren
id|head_list-&gt;cStat
op_amp
id|TLAN_CSTAT_EOC
)paren
id|eoc
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|head_list-&gt;cStat
op_amp
id|TLAN_CSTAT_FRM_CMP
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;TLAN:  Received interrupt for uncompleted TX frame.&bslash;n&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/* printk( &quot;Ack %d CSTAT=%hx&bslash;n&quot;, priv-&gt;txHead, head_list-&gt;cStat ); */
macro_line|#if LINUX_KERNEL_VERSION &gt; 0x20100
id|priv-&gt;stats-&gt;tx_bytes
op_add_assign
id|head_list-&gt;frameSize
suffix:semicolon
macro_line|#endif
id|head_list-&gt;cStat
op_assign
id|TLAN_CSTAT_UNUSED
suffix:semicolon
id|dev-&gt;tbusy
op_assign
l_int|0
suffix:semicolon
id|priv-&gt;txHead
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|priv-&gt;txHead
op_ge
id|TLAN_NUM_TX_LISTS
)paren
id|priv-&gt;txHead
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|eoc
)paren
(brace
id|TLAN_DBG
c_func
(paren
id|TLAN_DEBUG_TX
comma
l_string|&quot;TLAN TRANSMIT:  Handling TX EOC (Head=%d Tail=%d)&bslash;n&quot;
comma
id|priv-&gt;txHead
comma
id|priv-&gt;txTail
)paren
suffix:semicolon
id|head_list
op_assign
id|priv-&gt;txList
op_plus
id|priv-&gt;txHead
suffix:semicolon
r_if
c_cond
(paren
(paren
id|head_list-&gt;cStat
op_amp
id|TLAN_CSTAT_READY
)paren
op_eq
id|TLAN_CSTAT_READY
)paren
(brace
id|outl
c_func
(paren
id|virt_to_bus
c_func
(paren
id|head_list
)paren
comma
id|dev-&gt;base_addr
op_plus
id|TLAN_CH_PARM
)paren
suffix:semicolon
id|ack
op_or_assign
id|TLAN_HC_GO
suffix:semicolon
)brace
r_else
(brace
id|priv-&gt;txInProgress
op_assign
l_int|0
suffix:semicolon
)brace
)brace
id|TLan_DioWrite8
c_func
(paren
id|dev-&gt;base_addr
comma
id|TLAN_LED_REG
comma
id|TLAN_LED_LINK
op_or
id|TLAN_LED_ACT
)paren
suffix:semicolon
r_if
c_cond
(paren
id|priv-&gt;phyFlags
op_amp
id|TLAN_PHY_ACTIVITY
)paren
(brace
r_if
c_cond
(paren
id|priv-&gt;timerSetAt
op_eq
l_int|0
)paren
(brace
multiline_comment|/* printk(&quot;TxEOF Starting timer...&bslash;n&quot;); */
id|priv-&gt;timerSetAt
op_assign
id|jiffies
suffix:semicolon
id|priv-&gt;timer.expires
op_assign
id|jiffies
op_plus
id|TLAN_TIMER_ACT_DELAY
suffix:semicolon
id|priv-&gt;timerType
op_assign
id|TLAN_TIMER_ACT
suffix:semicolon
id|add_timer
c_func
(paren
op_amp
id|priv-&gt;timer
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|priv-&gt;timerType
op_eq
id|TLAN_TIMER_ACT
)paren
(brace
id|priv-&gt;timerSetAt
op_assign
id|jiffies
suffix:semicolon
multiline_comment|/* printk(&quot;TxEOF continuing timer...&bslash;n&quot;); */
)brace
)brace
r_return
id|ack
suffix:semicolon
)brace
multiline_comment|/* TLan_HandleTxEOF */
multiline_comment|/***************************************************************&n;&t; *&t;TLan_HandleStatOverflow&n;&t; *&n;&t; *&t;Returns:&n;&t; *&t;&t;1&n;&t; *&t;Parms:&n;&t; *&t;&t;dev&t;&t;Device assigned the IRQ that was&n;&t; *&t;&t;&t;&t;raised.&n;&t; *&t;&t;host_int&t;The contents of the HOST_INT&n;&t; *&t;&t;&t;&t;port.&n;&t; *&n;&t; *&t;This function handles the Statistics Overflow interrupt&n;&t; *&t;which means that one or more of the TLAN statistics&n;&t; *&t;registers has reached 1/2 capacity and needs to be read.&n;&t; *&n;&t; **************************************************************/
DECL|function|TLan_HandleStatOverflow
id|u32
id|TLan_HandleStatOverflow
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
id|u16
id|host_int
)paren
(brace
id|host_int
op_assign
l_int|0
suffix:semicolon
id|TLan_ReadAndClearStats
c_func
(paren
id|dev
comma
id|TLAN_RECORD
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
multiline_comment|/* TLan_HandleStatOverflow */
multiline_comment|/***************************************************************&n;&t; *&t;TLan_HandleRxEOF&n;&t; *&n;&t; *&t;Returns:&n;&t; *&t;&t;1&n;&t; *&t;Parms:&n;&t; *&t;&t;dev&t;&t;Device assigned the IRQ that was&n;&t; *&t;&t;&t;&t;raised.&n;&t; *&t;&t;host_int&t;The contents of the HOST_INT&n;&t; *&t;&t;&t;&t;port.&n;&t; *&n;&t; *&t;This function handles the Rx EOF interrupt which&n;&t; *&t;indicates a frame has been received by the adapter from&n;&t; *&t;the net and the frame has been transferred to memory.&n;&t; *&t;The function determines the bounce buffer the frame has&n;&t; *&t;been loaded into, creates a new sk_buff big enough to&n;&t; *&t;hold the frame, and sends it to protocol stack.  It&n;&t; *&t;then resets the used buffer and appends it to the end&n;&t; *&t;of the list.  If the frame was the last in the Rx&n;&t; *&t;channel (EOC), the function restarts the receive channel&n;&t; *&t;by sending an Rx Go command to the adapter.  Then it&n;&t; *&t;activates/continues the activity LED.&n;&t; *&n;&t; **************************************************************/
DECL|function|TLan_HandleRxEOF
id|u32
id|TLan_HandleRxEOF
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
id|u16
id|host_int
)paren
(brace
id|TLanPrivateInfo
op_star
id|priv
op_assign
(paren
id|TLanPrivateInfo
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|u32
id|ack
op_assign
l_int|1
suffix:semicolon
r_int
id|eoc
op_assign
l_int|0
suffix:semicolon
id|u8
op_star
id|head_buffer
suffix:semicolon
id|TLanList
op_star
id|head_list
suffix:semicolon
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
id|TLanList
op_star
id|tail_list
suffix:semicolon
r_void
op_star
id|t
suffix:semicolon
id|TLAN_DBG
c_func
(paren
id|TLAN_DEBUG_RX
comma
l_string|&quot;TLAN RECEIVE:  Handling RX EOF (Head=%d Tail=%d)&bslash;n&quot;
comma
id|priv-&gt;rxHead
comma
id|priv-&gt;rxTail
)paren
suffix:semicolon
id|host_int
op_assign
l_int|0
suffix:semicolon
id|head_list
op_assign
id|priv-&gt;rxList
op_plus
id|priv-&gt;rxHead
suffix:semicolon
id|tail_list
op_assign
id|priv-&gt;rxList
op_plus
id|priv-&gt;rxTail
suffix:semicolon
r_if
c_cond
(paren
id|head_list-&gt;cStat
op_amp
id|TLAN_CSTAT_EOC
)paren
id|eoc
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|head_list-&gt;cStat
op_amp
id|TLAN_CSTAT_FRM_CMP
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;TLAN:  Received interrupt for uncompleted RX frame.&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_else
(brace
id|skb
op_assign
id|dev_alloc_skb
c_func
(paren
id|head_list-&gt;frameSize
op_plus
l_int|7
)paren
suffix:semicolon
r_if
c_cond
(paren
id|skb
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;TLAN:  Couldn&squot;t allocate memory for received data.&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_else
(brace
id|head_buffer
op_assign
id|priv-&gt;rxBuffer
op_plus
(paren
id|priv-&gt;rxHead
op_star
id|TLAN_MAX_FRAME_SIZE
)paren
suffix:semicolon
id|skb-&gt;dev
op_assign
id|dev
suffix:semicolon
id|skb_reserve
c_func
(paren
id|skb
comma
l_int|2
)paren
suffix:semicolon
id|t
op_assign
(paren
r_void
op_star
)paren
id|skb_put
c_func
(paren
id|skb
comma
id|head_list-&gt;frameSize
)paren
suffix:semicolon
multiline_comment|/* printk( &quot; %hd %p %p&bslash;n&quot;, head_list-&gt;frameSize, skb-&gt;data, t ); */
macro_line|#if LINUX_KERNEL_VERSION &gt; 0x20100
id|priv-&gt;stats-&gt;rx_bytes
op_add_assign
id|head_list-&gt;frameSize
suffix:semicolon
macro_line|#endif
id|memcpy
c_func
(paren
id|t
comma
id|head_buffer
comma
id|head_list-&gt;frameSize
)paren
suffix:semicolon
id|skb-&gt;protocol
op_assign
id|eth_type_trans
c_func
(paren
id|skb
comma
id|dev
)paren
suffix:semicolon
id|netif_rx
c_func
(paren
id|skb
)paren
suffix:semicolon
)brace
)brace
id|head_list-&gt;forward
op_assign
l_int|0
suffix:semicolon
id|head_list-&gt;frameSize
op_assign
id|TLAN_MAX_FRAME_SIZE
suffix:semicolon
id|head_list-&gt;buffer
(braket
l_int|0
)braket
dot
id|count
op_assign
id|TLAN_MAX_FRAME_SIZE
op_or
id|TLAN_LAST_BUFFER
suffix:semicolon
id|tail_list-&gt;forward
op_assign
id|virt_to_bus
c_func
(paren
id|head_list
)paren
suffix:semicolon
id|priv-&gt;rxHead
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|priv-&gt;rxHead
op_ge
id|TLAN_NUM_RX_LISTS
)paren
id|priv-&gt;rxHead
op_assign
l_int|0
suffix:semicolon
id|priv-&gt;rxTail
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|priv-&gt;rxTail
op_ge
id|TLAN_NUM_RX_LISTS
)paren
id|priv-&gt;rxTail
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|eoc
)paren
(brace
id|TLAN_DBG
c_func
(paren
id|TLAN_DEBUG_RX
comma
l_string|&quot;TLAN RECEIVE:  Handling RX EOC (Head=%d Tail=%d)&bslash;n&quot;
comma
id|priv-&gt;rxHead
comma
id|priv-&gt;rxTail
)paren
suffix:semicolon
id|head_list
op_assign
id|priv-&gt;rxList
op_plus
id|priv-&gt;rxHead
suffix:semicolon
id|outl
c_func
(paren
id|virt_to_bus
c_func
(paren
id|head_list
)paren
comma
id|dev-&gt;base_addr
op_plus
id|TLAN_CH_PARM
)paren
suffix:semicolon
id|ack
op_or_assign
id|TLAN_HC_GO
op_or
id|TLAN_HC_RT
suffix:semicolon
id|priv-&gt;rxEocCount
op_increment
suffix:semicolon
)brace
id|TLan_DioWrite8
c_func
(paren
id|dev-&gt;base_addr
comma
id|TLAN_LED_REG
comma
id|TLAN_LED_LINK
op_or
id|TLAN_LED_ACT
)paren
suffix:semicolon
r_if
c_cond
(paren
id|priv-&gt;phyFlags
op_amp
id|TLAN_PHY_ACTIVITY
)paren
(brace
r_if
c_cond
(paren
id|priv-&gt;timerSetAt
op_eq
l_int|0
)paren
(brace
multiline_comment|/* printk(&quot;RxEOF Starting timer...&bslash;n&quot;); */
id|priv-&gt;timerSetAt
op_assign
id|jiffies
suffix:semicolon
id|priv-&gt;timer.expires
op_assign
id|jiffies
op_plus
id|TLAN_TIMER_ACT_DELAY
suffix:semicolon
id|priv-&gt;timerType
op_assign
id|TLAN_TIMER_ACT
suffix:semicolon
id|add_timer
c_func
(paren
op_amp
id|priv-&gt;timer
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|priv-&gt;timerType
op_eq
id|TLAN_TIMER_ACT
)paren
(brace
multiline_comment|/* printk(&quot;RxEOF tarting continuing timer...&bslash;n&quot;); */
id|priv-&gt;timerSetAt
op_assign
id|jiffies
suffix:semicolon
)brace
)brace
id|dev-&gt;last_rx
op_assign
id|jiffies
suffix:semicolon
r_return
id|ack
suffix:semicolon
)brace
multiline_comment|/* TLan_HandleRxEOF */
multiline_comment|/***************************************************************&n;&t; *&t;TLan_HandleDummy&n;&t; *&n;&t; *&t;Returns:&n;&t; *&t;&t;1&n;&t; *&t;Parms:&n;&t; *&t;&t;dev&t;&t;Device assigned the IRQ that was&n;&t; *&t;&t;&t;&t;raised.&n;&t; *&t;&t;host_int&t;The contents of the HOST_INT&n;&t; *&t;&t;&t;&t;port.&n;&t; *&n;&t; *&t;This function handles the Dummy interrupt, which is&n;&t; *&t;raised whenever a test interrupt is generated by setting&n;&t; *&t;the Req_Int bit of HOST_CMD to 1.&n;&t; *&n;&t; **************************************************************/
DECL|function|TLan_HandleDummy
id|u32
id|TLan_HandleDummy
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
id|u16
id|host_int
)paren
(brace
id|host_int
op_assign
l_int|0
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;TLAN:  Dummy interrupt on %s.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
multiline_comment|/* TLan_HandleDummy */
multiline_comment|/***************************************************************&n;&t; *&t;TLan_HandleTxEOC&n;&t; *&n;&t; *&t;Returns:&n;&t; *&t;&t;1&n;&t; *&t;Parms:&n;&t; *&t;&t;dev&t;&t;Device assigned the IRQ that was&n;&t; *&t;&t;&t;&t;raised.&n;&t; *&t;&t;host_int&t;The contents of the HOST_INT&n;&t; *&t;&t;&t;&t;port.&n;&t; *&n;&t; *&t;This driver is structured to determine EOC occurances by&n;&t; *&t;reading the CSTAT member of the list structure.  Tx EOC&n;&t; *&t;interrupts are disabled via the DIO INTDIS register.&n;&t; *&t;However, TLAN chips before revision 3.0 didn&squot;t have this&n;&t; *&t;functionality, so process EOC events if this is the&n;&t; *&t;case.&n;&t; *&n;&t; **************************************************************/
DECL|function|TLan_HandleTxEOC
id|u32
id|TLan_HandleTxEOC
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
id|u16
id|host_int
)paren
(brace
id|TLanPrivateInfo
op_star
id|priv
op_assign
(paren
id|TLanPrivateInfo
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|TLanList
op_star
id|head_list
suffix:semicolon
id|u32
id|ack
op_assign
l_int|1
suffix:semicolon
id|host_int
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|priv-&gt;tlanRev
OL
l_int|0x30
)paren
(brace
id|TLAN_DBG
c_func
(paren
id|TLAN_DEBUG_TX
comma
l_string|&quot;TLAN TRANSMIT:  Handling TX EOC (Head=%d Tail=%d) -- IRQ&bslash;n&quot;
comma
id|priv-&gt;txHead
comma
id|priv-&gt;txTail
)paren
suffix:semicolon
id|head_list
op_assign
id|priv-&gt;txList
op_plus
id|priv-&gt;txHead
suffix:semicolon
r_if
c_cond
(paren
(paren
id|head_list-&gt;cStat
op_amp
id|TLAN_CSTAT_READY
)paren
op_eq
id|TLAN_CSTAT_READY
)paren
(brace
id|outl
c_func
(paren
id|virt_to_bus
c_func
(paren
id|head_list
)paren
comma
id|dev-&gt;base_addr
op_plus
id|TLAN_CH_PARM
)paren
suffix:semicolon
id|ack
op_or_assign
id|TLAN_HC_GO
suffix:semicolon
)brace
r_else
(brace
id|priv-&gt;txInProgress
op_assign
l_int|0
suffix:semicolon
)brace
)brace
r_return
id|ack
suffix:semicolon
)brace
multiline_comment|/* TLan_HandleTxEOC */
multiline_comment|/***************************************************************&n;&t; *&t;TLan_HandleStatusCheck&n;&t; *&n;&t; *&t;Returns:&n;&t; *&t;&t;0 if Adapter check, 1 if Network Status check.&n;&t; *&t;Parms:&n;&t; *&t;&t;dev&t;&t;Device assigned the IRQ that was&n;&t; *&t;&t;&t;&t;raised.&n;&t; *&t;&t;host_int&t;The contents of the HOST_INT&n;&t; *&t;&t;&t;&t;port.&n;&t; *&n;&t; *&t;This function handles Adapter Check/Network Status&n;&t; *&t;interrupts generated by the adapter.  It checks the&n;&t; *&t;vector in the HOST_INT register to determine if it is&n;&t; *&t;an Adapter Check interrupt.  If so, it resets the&n;&t; *&t;adapter.  Otherwise it clears the status registers&n;&t; *&t;and services the PHY.&n;&t; *&n;&t; **************************************************************/
DECL|function|TLan_HandleStatusCheck
id|u32
id|TLan_HandleStatusCheck
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
id|u16
id|host_int
)paren
(brace
id|u32
id|ack
suffix:semicolon
id|u32
id|error
suffix:semicolon
id|u8
id|net_sts
suffix:semicolon
id|TLanPrivateInfo
op_star
id|priv
op_assign
(paren
id|TLanPrivateInfo
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|ack
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|host_int
op_amp
id|TLAN_HI_IV_MASK
)paren
(brace
id|error
op_assign
id|inl
c_func
(paren
id|dev-&gt;base_addr
op_plus
id|TLAN_CH_PARM
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;TLAN:   Adaptor Check on device %s err = 0x%x&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|error
)paren
suffix:semicolon
id|TLan_ReadAndClearStats
c_func
(paren
id|dev
comma
id|TLAN_RECORD
)paren
suffix:semicolon
id|outl
c_func
(paren
id|TLAN_HC_AD_RST
comma
id|dev-&gt;base_addr
op_plus
id|TLAN_HOST_CMD
)paren
suffix:semicolon
id|TLan_ResetLists
c_func
(paren
id|dev
)paren
suffix:semicolon
id|TLan_Reset
c_func
(paren
id|dev
)paren
suffix:semicolon
id|dev-&gt;tbusy
op_assign
l_int|0
suffix:semicolon
id|TLan_SetMac
c_func
(paren
id|dev
comma
l_int|0
comma
id|dev-&gt;dev_addr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|priv-&gt;timerType
op_eq
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|priv-&gt;phyFlags
op_amp
id|TLAN_PHY_AUTONEG
)paren
(brace
id|priv-&gt;timer.expires
op_assign
id|jiffies
op_plus
id|TLAN_TIMER_LINK_DELAY
suffix:semicolon
id|priv-&gt;timerSetAt
op_assign
id|jiffies
suffix:semicolon
id|priv-&gt;timerType
op_assign
id|TLAN_TIMER_LINK
suffix:semicolon
id|add_timer
c_func
(paren
op_amp
id|priv-&gt;timer
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/*printk( &quot; RX GO----&gt;&bslash;n&quot; ); */
id|outl
c_func
(paren
id|virt_to_bus
c_func
(paren
id|priv-&gt;rxList
)paren
comma
id|dev-&gt;base_addr
op_plus
id|TLAN_CH_PARM
)paren
suffix:semicolon
id|outl
c_func
(paren
id|TLAN_HC_GO
op_or
id|TLAN_HC_RT
comma
id|dev-&gt;base_addr
op_plus
id|TLAN_HOST_CMD
)paren
suffix:semicolon
)brace
)brace
id|ack
op_assign
l_int|0
suffix:semicolon
)brace
r_else
(brace
id|net_sts
op_assign
id|TLan_DioRead8
c_func
(paren
id|dev-&gt;base_addr
comma
id|TLAN_NET_STS
)paren
suffix:semicolon
r_if
c_cond
(paren
id|net_sts
)paren
id|TLan_DioWrite8
c_func
(paren
id|dev-&gt;base_addr
comma
id|TLAN_NET_STS
comma
id|net_sts
)paren
suffix:semicolon
r_if
c_cond
(paren
id|net_sts
op_amp
id|TLAN_NET_STS_MIRQ
)paren
(brace
(paren
op_star
id|priv-&gt;phyService
)paren
(paren
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|debug
)paren
(brace
id|TLan_PhyPrint
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
)brace
id|TLAN_DBG
c_func
(paren
id|TLAN_DEBUG_GNRL
comma
l_string|&quot;TLAN:  Status Check! %s Net_Sts=%x&bslash;n&quot;
comma
id|dev-&gt;name
comma
(paren
r_int
)paren
id|net_sts
)paren
suffix:semicolon
)brace
r_return
id|ack
suffix:semicolon
)brace
multiline_comment|/* TLan_HandleStatusCheck */
multiline_comment|/***************************************************************&n;&t; *&t;TLan_HandleRxEOC&n;&t; *&n;&t; *&t;Returns:&n;&t; *&t;&t;1&n;&t; *&t;Parms:&n;&t; *&t;&t;dev&t;&t;Device assigned the IRQ that was&n;&t; *&t;&t;&t;&t;raised.&n;&t; *&t;&t;host_int&t;The contents of the HOST_INT&n;&t; *&t;&t;&t;&t;port.&n;&t; *&n;&t; *&t;This driver is structured to determine EOC occurances by&n;&t; *&t;reading the CSTAT member of the list structure.  Rx EOC&n;&t; *&t;interrupts are disabled via the DIO INTDIS register.&n;&t; *&t;However, TLAN chips before revision 3.0 didn&squot;t have this&n;&t; *&t;CSTAT member or a INTDIS register, so if this chip is&n;&t; *&t;pre-3.0, process EOC interrupts normally.&n;&t; *&n;&t; **************************************************************/
DECL|function|TLan_HandleRxEOC
id|u32
id|TLan_HandleRxEOC
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
id|u16
id|host_int
)paren
(brace
id|TLanPrivateInfo
op_star
id|priv
op_assign
(paren
id|TLanPrivateInfo
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|TLanList
op_star
id|head_list
suffix:semicolon
id|u32
id|ack
op_assign
l_int|1
suffix:semicolon
id|host_int
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|priv-&gt;tlanRev
OL
l_int|0x30
)paren
(brace
id|TLAN_DBG
c_func
(paren
id|TLAN_DEBUG_RX
comma
l_string|&quot;TLAN RECEIVE:  Handling RX EOC (Head=%d Tail=%d) -- IRQ&bslash;n&quot;
comma
id|priv-&gt;rxHead
comma
id|priv-&gt;rxTail
)paren
suffix:semicolon
id|head_list
op_assign
id|priv-&gt;rxList
op_plus
id|priv-&gt;rxHead
suffix:semicolon
id|outl
c_func
(paren
id|virt_to_bus
c_func
(paren
id|head_list
)paren
comma
id|dev-&gt;base_addr
op_plus
id|TLAN_CH_PARM
)paren
suffix:semicolon
id|ack
op_or_assign
id|TLAN_HC_GO
op_or
id|TLAN_HC_RT
suffix:semicolon
id|priv-&gt;rxEocCount
op_increment
suffix:semicolon
)brace
r_return
id|ack
suffix:semicolon
)brace
multiline_comment|/* TLan_HandleRxEOC */
multiline_comment|/*****************************************************************************&n;******************************************************************************&n;&n;&t;ThunderLAN Driver Timer Function&n;&n;******************************************************************************&n;*****************************************************************************/
multiline_comment|/***************************************************************&n;&t; *&t;TLan_Timer&n;&t; *&n;&t; *&t;Returns:&n;&t; *&t;&t;Nothing&n;&t; *&t;Parms:&n;&t; *&t;&t;data&t;A value given to add timer when&n;&t; *&t;&t;&t;add_timer was called.&n;&t; *&n;&t; *&t;This function handles timed functionality for the&n;&t; *&t;TLAN driver.  The two current timer uses are for&n;&t; *&t;delaying for autonegotionation and driving the ACT LED.&n;&t; *&t;-&t;Autonegotiation requires being allowed about&n;&t; *&t;&t;2 1/2 seconds before attempting to transmit a&n;&t; *&t;&t;packet.  It would be a very bad thing to hang&n;&t; *&t;&t;the kernel this long, so the driver doesn&squot;t&n;&t; *&t;&t;allow transmission &squot;til after this time, for&n;&t; *&t;&t;certain PHYs.  It would be much nicer if all&n;&t; *&t;&t;PHYs were interrupt-capable like the internal&n;&t; *&t;&t;PHY.&n;&t; *&t;-&t;The ACT LED, which shows adapter activity, is&n;&t; *&t;&t;driven by the driver, and so must be left on&n;&t; *&t;&t;for a short period to power up the LED so it&n;&t; *&t;&t;can be seen.  This delay can be changed by&n;&t; *&t;&t;changing the TLAN_TIMER_ACT_DELAY in tlan.h,&n;&t; *&t;&t;if desired.  10 jiffies produces a slightly&n;&t; *&t;&t;sluggish response.&n;&t; *&n;&t; **************************************************************/
DECL|function|TLan_Timer
r_void
id|TLan_Timer
c_func
(paren
r_int
r_int
id|data
)paren
(brace
r_struct
id|device
op_star
id|dev
op_assign
(paren
r_struct
id|device
op_star
)paren
id|data
suffix:semicolon
id|u16
id|gen_sts
suffix:semicolon
id|TLanPrivateInfo
op_star
id|priv
op_assign
(paren
id|TLanPrivateInfo
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
multiline_comment|/* printk( &quot;TLAN:  %s Entered Timer, type = %d&bslash;n&quot;, dev-&gt;name, priv-&gt;timerType ); */
r_switch
c_cond
(paren
id|priv-&gt;timerType
)paren
(brace
r_case
id|TLAN_TIMER_LINK
suffix:colon
id|TLan_MiiReadReg
c_func
(paren
id|dev-&gt;base_addr
comma
id|priv-&gt;phyAddr
comma
id|MII_GEN_STS
comma
op_amp
id|gen_sts
)paren
suffix:semicolon
r_if
c_cond
(paren
id|gen_sts
op_amp
id|MII_GS_LINK
)paren
(brace
id|priv-&gt;phyOnline
op_assign
l_int|1
suffix:semicolon
id|outl
c_func
(paren
id|virt_to_bus
c_func
(paren
id|priv-&gt;rxList
)paren
comma
id|dev-&gt;base_addr
op_plus
id|TLAN_CH_PARM
)paren
suffix:semicolon
id|outl
c_func
(paren
id|TLAN_HC_GO
op_or
id|TLAN_HC_RT
comma
id|dev-&gt;base_addr
op_plus
id|TLAN_HOST_CMD
)paren
suffix:semicolon
id|priv-&gt;timerSetAt
op_assign
l_int|0
suffix:semicolon
id|priv-&gt;timerType
op_assign
l_int|0
suffix:semicolon
)brace
r_else
(brace
id|priv-&gt;timer.expires
op_assign
id|jiffies
op_plus
(paren
id|TLAN_TIMER_LINK_DELAY
op_star
l_int|2
)paren
suffix:semicolon
id|add_timer
c_func
(paren
op_amp
id|priv-&gt;timer
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|TLAN_TIMER_ACT
suffix:colon
r_if
c_cond
(paren
id|jiffies
op_minus
id|priv-&gt;timerSetAt
op_ge
id|TLAN_TIMER_ACT_DELAY
)paren
(brace
id|TLan_DioWrite8
c_func
(paren
id|dev-&gt;base_addr
comma
id|TLAN_LED_REG
comma
id|TLAN_LED_LINK
)paren
suffix:semicolon
id|priv-&gt;timerSetAt
op_assign
l_int|0
suffix:semicolon
id|priv-&gt;timerType
op_assign
l_int|0
suffix:semicolon
)brace
r_else
(brace
id|priv-&gt;timer.expires
op_assign
id|priv-&gt;timerSetAt
op_plus
id|TLAN_TIMER_ACT_DELAY
suffix:semicolon
id|add_timer
c_func
(paren
op_amp
id|priv-&gt;timer
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_default
suffix:colon
r_break
suffix:semicolon
)brace
)brace
multiline_comment|/* TLan_Timer */
multiline_comment|/*****************************************************************************&n;******************************************************************************&n;&n;&t;ThunderLAN Driver Adapter Related Routines&n;&n;******************************************************************************&n;*****************************************************************************/
multiline_comment|/***************************************************************&n;&t; *&t;TLan_ResetLists&n;&t; *  &n;&t; *&t;Returns:&n;&t; *&t;&t;Nothing&n;&t; *&t;Parms:&n;&t; *&t;&t;dev&t;The device structure with the list&n;&t; *&t;&t;&t;stuctures to be reset.&n;&t; *&n;&t; *&t;This routine sets the variables associated with managing&n;&t; *&t;the TLAN lists to their initial values.&n;&t; *&n;&t; **************************************************************/
DECL|function|TLan_ResetLists
r_void
id|TLan_ResetLists
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
id|TLanPrivateInfo
op_star
id|priv
op_assign
(paren
id|TLanPrivateInfo
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_int
id|i
suffix:semicolon
id|TLanList
op_star
id|list
suffix:semicolon
id|priv-&gt;txHead
op_assign
l_int|0
suffix:semicolon
id|priv-&gt;txTail
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|TLAN_NUM_TX_LISTS
suffix:semicolon
id|i
op_increment
)paren
(brace
id|list
op_assign
id|priv-&gt;txList
op_plus
id|i
suffix:semicolon
id|list-&gt;cStat
op_assign
id|TLAN_CSTAT_UNUSED
suffix:semicolon
id|list-&gt;buffer
(braket
l_int|0
)braket
dot
id|address
op_assign
id|virt_to_bus
c_func
(paren
id|priv-&gt;txBuffer
op_plus
(paren
id|i
op_star
id|TLAN_MAX_FRAME_SIZE
)paren
)paren
suffix:semicolon
id|list-&gt;buffer
(braket
l_int|2
)braket
dot
id|count
op_assign
l_int|0
suffix:semicolon
id|list-&gt;buffer
(braket
l_int|2
)braket
dot
id|address
op_assign
l_int|0
suffix:semicolon
)brace
id|priv-&gt;rxHead
op_assign
l_int|0
suffix:semicolon
id|priv-&gt;rxTail
op_assign
id|TLAN_NUM_RX_LISTS
op_minus
l_int|1
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|TLAN_NUM_RX_LISTS
suffix:semicolon
id|i
op_increment
)paren
(brace
id|list
op_assign
id|priv-&gt;rxList
op_plus
id|i
suffix:semicolon
id|list-&gt;cStat
op_assign
id|TLAN_CSTAT_READY
suffix:semicolon
id|list-&gt;frameSize
op_assign
id|TLAN_MAX_FRAME_SIZE
suffix:semicolon
id|list-&gt;buffer
(braket
l_int|0
)braket
dot
id|count
op_assign
id|TLAN_MAX_FRAME_SIZE
op_or
id|TLAN_LAST_BUFFER
suffix:semicolon
id|list-&gt;buffer
(braket
l_int|0
)braket
dot
id|address
op_assign
id|virt_to_bus
c_func
(paren
id|priv-&gt;rxBuffer
op_plus
(paren
id|i
op_star
id|TLAN_MAX_FRAME_SIZE
)paren
)paren
suffix:semicolon
id|list-&gt;buffer
(braket
l_int|1
)braket
dot
id|count
op_assign
l_int|0
suffix:semicolon
id|list-&gt;buffer
(braket
l_int|1
)braket
dot
id|address
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|i
OL
id|TLAN_NUM_RX_LISTS
op_minus
l_int|1
)paren
id|list-&gt;forward
op_assign
id|virt_to_bus
c_func
(paren
id|list
op_plus
l_int|1
)paren
suffix:semicolon
r_else
id|list-&gt;forward
op_assign
l_int|0
suffix:semicolon
)brace
)brace
multiline_comment|/* TLan_ResetLists */
multiline_comment|/***************************************************************&n;&t; *&t;TLan_PrintDio&n;&t; *  &n;&t; *&t;Returns:&n;&t; *&t;&t;Nothing&n;&t; *&t;Parms:&n;&t; *&t;&t;io_base&t;&t;Base IO port of the device of&n;&t; *&t;&t;&t;&t;which to print DIO registers.&n;&t; *&n;&t; *&t;This function prints out all the internal (DIO)&n;&t; *&t;registers of a TLAN chip.&n;&t; *&n;&t; **************************************************************/
DECL|function|TLan_PrintDio
r_void
id|TLan_PrintDio
c_func
(paren
id|u16
id|io_base
)paren
(brace
id|u32
id|data0
comma
id|data1
suffix:semicolon
r_int
id|i
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;TLAN:   Contents of internal registers for io base 0x%04hx.&bslash;n&quot;
comma
id|io_base
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;TLAN:      Off.  +0         +4&bslash;n&quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|0x4C
suffix:semicolon
id|i
op_add_assign
l_int|8
)paren
(brace
id|data0
op_assign
id|TLan_DioRead32
c_func
(paren
id|io_base
comma
id|i
)paren
suffix:semicolon
id|data1
op_assign
id|TLan_DioRead32
c_func
(paren
id|io_base
comma
id|i
op_plus
l_int|0x4
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;TLAN:      0x%02x  0x%08x 0x%08x&bslash;n&quot;
comma
id|i
comma
id|data0
comma
id|data1
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* TLan_PrintDio */
multiline_comment|/***************************************************************&n;&t; *&t;TLan_PrintList&n;&t; *  &n;&t; *&t;Returns:&n;&t; *&t;&t;Nothing&n;&t; *&t;Parms:&n;&t; *&t;&t;list&t;A pointer to the TLanList structure to&n;&t; *&t;&t;&t;be printed.&n;&t; *&t;&t;type&t;A string to designate type of list,&n;&t; *&t;&t;&t;&quot;Rx&quot; or &quot;Tx&quot;.&n;&t; *&t;&t;num&t;The index of the list.&n;&t; *&n;&t; *&t;This function prints out the contents of the list&n;&t; *&t;pointed to by the list parameter.&n;&t; *&n;&t; **************************************************************/
DECL|function|TLan_PrintList
r_void
id|TLan_PrintList
c_func
(paren
id|TLanList
op_star
id|list
comma
r_char
op_star
id|type
comma
r_int
id|num
)paren
(brace
r_int
id|i
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;TLAN:   %s List %d at 0x%08x&bslash;n&quot;
comma
id|type
comma
id|num
comma
(paren
id|u32
)paren
id|list
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;TLAN:      Forward    = 0x%08x&bslash;n&quot;
comma
id|list-&gt;forward
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;TLAN:      CSTAT      = 0x%04hx&bslash;n&quot;
comma
id|list-&gt;cStat
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;TLAN:      Frame Size = 0x%04hx&bslash;n&quot;
comma
id|list-&gt;frameSize
)paren
suffix:semicolon
multiline_comment|/* for ( i = 0; i &lt; 10; i++ ) { */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|2
suffix:semicolon
id|i
op_increment
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;TLAN:      Buffer[%d].count, addr = 0x%08x, 0x%08x&bslash;n&quot;
comma
id|i
comma
id|list-&gt;buffer
(braket
id|i
)braket
dot
id|count
comma
id|list-&gt;buffer
(braket
id|i
)braket
dot
id|address
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* TLan_PrintList */
multiline_comment|/***************************************************************&n;&t; *&t;TLan_ReadAndClearStats&n;&t; *&n;&t; *&t;Returns:&n;&t; *&t;&t;Nothing&n;&t; *&t;Parms:&n;&t; *&t;&t;dev&t;Pointer to device structure of adapter&n;&t; *&t;&t;&t;to which to read stats.&n;&t; *&t;&t;record&t;Flag indicating whether to add &n;&t; *&n;&t; *&t;This functions reads all the internal status registers&n;&t; *&t;of the TLAN chip, which clears them as a side effect.&n;&t; *&t;It then either adds the values to the device&squot;s status&n;&t; *&t;struct, or discards them, depending on whether record&n;&t; *&t;is TLAN_RECORD (!=0)  or TLAN_IGNORE (==0).&n;&t; *&n;&t; **************************************************************/
DECL|function|TLan_ReadAndClearStats
r_void
id|TLan_ReadAndClearStats
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
r_int
id|record
)paren
(brace
id|TLanPrivateInfo
op_star
id|priv
op_assign
(paren
id|TLanPrivateInfo
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|u32
id|tx_good
comma
id|tx_under
suffix:semicolon
id|u32
id|rx_good
comma
id|rx_over
suffix:semicolon
id|u32
id|def_tx
comma
id|crc
comma
id|code
suffix:semicolon
id|u32
id|multi_col
comma
id|single_col
suffix:semicolon
id|u32
id|excess_col
comma
id|late_col
comma
id|loss
suffix:semicolon
id|outw
c_func
(paren
id|TLAN_GOOD_TX_FRMS
comma
id|dev-&gt;base_addr
op_plus
id|TLAN_DIO_ADR
)paren
suffix:semicolon
id|tx_good
op_assign
id|inb
c_func
(paren
id|dev-&gt;base_addr
op_plus
id|TLAN_DIO_DATA
)paren
suffix:semicolon
id|tx_good
op_add_assign
id|inb
c_func
(paren
id|dev-&gt;base_addr
op_plus
id|TLAN_DIO_DATA
op_plus
l_int|1
)paren
op_lshift
l_int|8
suffix:semicolon
id|tx_good
op_add_assign
id|inb
c_func
(paren
id|dev-&gt;base_addr
op_plus
id|TLAN_DIO_DATA
op_plus
l_int|2
)paren
op_lshift
l_int|16
suffix:semicolon
id|tx_under
op_assign
id|inb
c_func
(paren
id|dev-&gt;base_addr
op_plus
id|TLAN_DIO_DATA
op_plus
l_int|3
)paren
suffix:semicolon
id|outw
c_func
(paren
id|TLAN_GOOD_RX_FRMS
comma
id|dev-&gt;base_addr
op_plus
id|TLAN_DIO_ADR
)paren
suffix:semicolon
id|rx_good
op_assign
id|inb
c_func
(paren
id|dev-&gt;base_addr
op_plus
id|TLAN_DIO_DATA
)paren
suffix:semicolon
id|rx_good
op_add_assign
id|inb
c_func
(paren
id|dev-&gt;base_addr
op_plus
id|TLAN_DIO_DATA
op_plus
l_int|1
)paren
op_lshift
l_int|8
suffix:semicolon
id|rx_good
op_add_assign
id|inb
c_func
(paren
id|dev-&gt;base_addr
op_plus
id|TLAN_DIO_DATA
op_plus
l_int|2
)paren
op_lshift
l_int|16
suffix:semicolon
id|rx_over
op_assign
id|inb
c_func
(paren
id|dev-&gt;base_addr
op_plus
id|TLAN_DIO_DATA
op_plus
l_int|3
)paren
suffix:semicolon
id|outw
c_func
(paren
id|TLAN_DEFERRED_TX
comma
id|dev-&gt;base_addr
op_plus
id|TLAN_DIO_ADR
)paren
suffix:semicolon
id|def_tx
op_assign
id|inb
c_func
(paren
id|dev-&gt;base_addr
op_plus
id|TLAN_DIO_DATA
)paren
suffix:semicolon
id|def_tx
op_add_assign
id|inb
c_func
(paren
id|dev-&gt;base_addr
op_plus
id|TLAN_DIO_DATA
op_plus
l_int|1
)paren
op_lshift
l_int|8
suffix:semicolon
id|crc
op_assign
id|inb
c_func
(paren
id|dev-&gt;base_addr
op_plus
id|TLAN_DIO_DATA
op_plus
l_int|2
)paren
suffix:semicolon
id|code
op_assign
id|inb
c_func
(paren
id|dev-&gt;base_addr
op_plus
id|TLAN_DIO_DATA
op_plus
l_int|3
)paren
suffix:semicolon
id|outw
c_func
(paren
id|TLAN_MULTICOL_FRMS
comma
id|dev-&gt;base_addr
op_plus
id|TLAN_DIO_ADR
)paren
suffix:semicolon
id|multi_col
op_assign
id|inb
c_func
(paren
id|dev-&gt;base_addr
op_plus
id|TLAN_DIO_DATA
)paren
suffix:semicolon
id|multi_col
op_add_assign
id|inb
c_func
(paren
id|dev-&gt;base_addr
op_plus
id|TLAN_DIO_DATA
op_plus
l_int|1
)paren
op_lshift
l_int|8
suffix:semicolon
id|single_col
op_assign
id|inb
c_func
(paren
id|dev-&gt;base_addr
op_plus
id|TLAN_DIO_DATA
op_plus
l_int|2
)paren
suffix:semicolon
id|single_col
op_add_assign
id|inb
c_func
(paren
id|dev-&gt;base_addr
op_plus
id|TLAN_DIO_DATA
op_plus
l_int|3
)paren
op_lshift
l_int|8
suffix:semicolon
id|outw
c_func
(paren
id|TLAN_EXCESSCOL_FRMS
comma
id|dev-&gt;base_addr
op_plus
id|TLAN_DIO_ADR
)paren
suffix:semicolon
id|excess_col
op_assign
id|inb
c_func
(paren
id|dev-&gt;base_addr
op_plus
id|TLAN_DIO_DATA
)paren
suffix:semicolon
id|late_col
op_assign
id|inb
c_func
(paren
id|dev-&gt;base_addr
op_plus
id|TLAN_DIO_DATA
op_plus
l_int|1
)paren
suffix:semicolon
id|loss
op_assign
id|inb
c_func
(paren
id|dev-&gt;base_addr
op_plus
id|TLAN_DIO_DATA
op_plus
l_int|2
)paren
suffix:semicolon
r_if
c_cond
(paren
id|record
)paren
(brace
id|priv-&gt;stats.rx_packets
op_add_assign
id|rx_good
suffix:semicolon
id|priv-&gt;stats.rx_errors
op_add_assign
id|rx_over
op_plus
id|crc
op_plus
id|code
suffix:semicolon
id|priv-&gt;stats.tx_packets
op_add_assign
id|tx_good
suffix:semicolon
id|priv-&gt;stats.tx_errors
op_add_assign
id|tx_under
op_plus
id|loss
suffix:semicolon
id|priv-&gt;stats.collisions
op_add_assign
id|multi_col
op_plus
id|single_col
op_plus
id|excess_col
op_plus
id|late_col
suffix:semicolon
id|priv-&gt;stats.rx_over_errors
op_add_assign
id|rx_over
suffix:semicolon
id|priv-&gt;stats.rx_crc_errors
op_add_assign
id|crc
suffix:semicolon
id|priv-&gt;stats.rx_frame_errors
op_add_assign
id|code
suffix:semicolon
id|priv-&gt;stats.tx_aborted_errors
op_add_assign
id|tx_under
suffix:semicolon
id|priv-&gt;stats.tx_carrier_errors
op_add_assign
id|loss
suffix:semicolon
)brace
)brace
multiline_comment|/* TLan_ReadAndClearStats */
multiline_comment|/***************************************************************&n;&t; *&t;TLan_Reset&n;&t; *&n;&t; *&t;Returns:&n;&t; *&t;&t;0&n;&t; *&t;Parms:&n;&t; *&t;&t;dev&t;Pointer to device structure of adapter&n;&t; *&t;&t;&t;to be reset.&n;&t; *&n;&t; *&t;This function resets the adapter and it&squot;s physical&n;&t; *&t;device.  See Chap. 3, pp. 9-10 of the &quot;ThunderLAN&n;&t; *&t;Programmer&squot;s Guide&quot; for details.  The routine tries to&n;&t; *&t;implement what is detailed there, though adjustments&n;&t; *&t;have been made.&n;&t; *&n;&t; **************************************************************/
DECL|function|TLan_Reset
r_int
id|TLan_Reset
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
id|TLanPrivateInfo
op_star
id|priv
op_assign
(paren
id|TLanPrivateInfo
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_int
id|i
suffix:semicolon
id|u32
id|addr
suffix:semicolon
id|u32
id|data
suffix:semicolon
id|u8
id|data8
suffix:semicolon
multiline_comment|/*  1.&t;Assert reset bit. */
id|data
op_assign
id|inl
c_func
(paren
id|dev-&gt;base_addr
op_plus
id|TLAN_HOST_CMD
)paren
suffix:semicolon
id|data
op_or_assign
id|TLAN_HC_AD_RST
suffix:semicolon
id|outl
c_func
(paren
id|data
comma
id|dev-&gt;base_addr
op_plus
id|TLAN_HOST_CMD
)paren
suffix:semicolon
multiline_comment|/*  2.&t;Turn off interrupts. ( Probably isn&squot;t necessary ) */
id|data
op_assign
id|inl
c_func
(paren
id|dev-&gt;base_addr
op_plus
id|TLAN_HOST_CMD
)paren
suffix:semicolon
id|data
op_or_assign
id|TLAN_HC_INT_OFF
suffix:semicolon
id|outl
c_func
(paren
id|data
comma
id|dev-&gt;base_addr
op_plus
id|TLAN_HOST_CMD
)paren
suffix:semicolon
multiline_comment|/*  3.&t;Clear AREGs and HASHs. */
r_for
c_loop
(paren
id|i
op_assign
id|TLAN_AREG_0
suffix:semicolon
id|i
op_le
id|TLAN_HASH_2
suffix:semicolon
id|i
op_add_assign
l_int|4
)paren
(brace
id|TLan_DioWrite32
c_func
(paren
id|dev-&gt;base_addr
comma
(paren
id|u16
)paren
id|i
comma
l_int|0
)paren
suffix:semicolon
)brace
multiline_comment|/*  4.&t;Setup NetConfig register. */
id|data
op_assign
id|TLAN_NET_CFG_1FRAG
op_or
id|TLAN_NET_CFG_1CHAN
op_or
id|TLAN_NET_CFG_PHY_EN
suffix:semicolon
id|TLan_DioWrite16
c_func
(paren
id|dev-&gt;base_addr
comma
id|TLAN_NET_CONFIG
comma
(paren
id|u16
)paren
id|data
)paren
suffix:semicolon
multiline_comment|/*  5.&t;Load Ld_Tmr and Ld_Thr in HOST_CMD. */
id|outl
c_func
(paren
id|TLAN_HC_LD_TMR
op_or
l_int|0x0
comma
id|dev-&gt;base_addr
op_plus
id|TLAN_HOST_CMD
)paren
suffix:semicolon
id|outl
c_func
(paren
id|TLAN_HC_LD_THR
op_or
l_int|0x1
comma
id|dev-&gt;base_addr
op_plus
id|TLAN_HOST_CMD
)paren
suffix:semicolon
multiline_comment|/*  6.&t;Unreset the MII by setting NMRST (in NetSio) to 1. */
id|outw
c_func
(paren
id|TLAN_NET_SIO
comma
id|dev-&gt;base_addr
op_plus
id|TLAN_DIO_ADR
)paren
suffix:semicolon
id|addr
op_assign
id|dev-&gt;base_addr
op_plus
id|TLAN_DIO_DATA
op_plus
id|TLAN_NET_SIO
suffix:semicolon
id|TLan_SetBit
c_func
(paren
id|TLAN_NET_SIO_NMRST
comma
id|addr
)paren
suffix:semicolon
multiline_comment|/*  7.&t;Setup the remaining registers. */
r_if
c_cond
(paren
id|priv-&gt;tlanRev
op_ge
l_int|0x30
)paren
(brace
id|data8
op_assign
id|TLAN_ID_TX_EOC
op_or
id|TLAN_ID_RX_EOC
suffix:semicolon
id|TLan_DioWrite8
c_func
(paren
id|dev-&gt;base_addr
comma
id|TLAN_INT_DIS
comma
id|data8
)paren
suffix:semicolon
)brace
id|TLan_PhySelect
c_func
(paren
id|dev
)paren
suffix:semicolon
id|data
op_assign
id|TLAN_NET_CFG_1FRAG
op_or
id|TLAN_NET_CFG_1CHAN
suffix:semicolon
r_if
c_cond
(paren
id|priv-&gt;phyFlags
op_amp
id|TLAN_PHY_BIT_RATE
)paren
(brace
id|data
op_or_assign
id|TLAN_NET_CFG_BIT
suffix:semicolon
r_if
c_cond
(paren
id|aui
op_eq
l_int|1
)paren
(brace
id|TLan_DioWrite8
c_func
(paren
id|dev-&gt;base_addr
comma
id|TLAN_ACOMMIT
comma
l_int|0x0a
)paren
suffix:semicolon
)brace
r_else
(brace
id|TLan_DioWrite8
c_func
(paren
id|dev-&gt;base_addr
comma
id|TLAN_ACOMMIT
comma
l_int|0x08
)paren
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|priv-&gt;phyFlags
op_amp
id|TLAN_PHY_INTERNAL
)paren
(brace
id|data
op_or_assign
id|TLAN_NET_CFG_PHY_EN
suffix:semicolon
)brace
id|TLan_DioWrite16
c_func
(paren
id|dev-&gt;base_addr
comma
id|TLAN_NET_CONFIG
comma
(paren
id|u16
)paren
id|data
)paren
suffix:semicolon
(paren
op_star
id|priv-&gt;phyCheck
)paren
(paren
id|dev
)paren
suffix:semicolon
id|data8
op_assign
id|TLAN_NET_CMD_NRESET
op_or
id|TLAN_NET_CMD_NWRAP
suffix:semicolon
id|TLan_DioWrite8
c_func
(paren
id|dev-&gt;base_addr
comma
id|TLAN_NET_CMD
comma
id|data8
)paren
suffix:semicolon
id|data8
op_assign
id|TLAN_NET_MASK_MASK4
op_or
id|TLAN_NET_MASK_MASK5
suffix:semicolon
r_if
c_cond
(paren
id|priv-&gt;phyFlags
op_amp
id|TLAN_PHY_INTS
)paren
(brace
id|data8
op_or_assign
id|TLAN_NET_MASK_MASK7
suffix:semicolon
)brace
id|TLan_DioWrite8
c_func
(paren
id|dev-&gt;base_addr
comma
id|TLAN_NET_MASK
comma
id|data8
)paren
suffix:semicolon
id|TLan_DioWrite16
c_func
(paren
id|dev-&gt;base_addr
comma
id|TLAN_MAX_RX
comma
id|TLAN_MAX_FRAME_SIZE
)paren
suffix:semicolon
r_if
c_cond
(paren
id|priv-&gt;phyFlags
op_amp
id|TLAN_PHY_UNMANAGED
)paren
(brace
id|priv-&gt;phyOnline
op_assign
l_int|1
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* TLan_Reset */
multiline_comment|/***************************************************************&n;&t; *&t;TLan_SetMac&n;&t; *&n;&t; *&t;Returns:&n;&t; *&t;&t;Nothing&n;&t; *&t;Parms:&n;&t; *&t;&t;dev&t;Pointer to device structure of adapter&n;&t; *&t;&t;&t;on which to change the AREG.&n;&t; *&t;&t;areg&t;The AREG to set the address in (0 - 3).&n;&t; *&t;&t;mac&t;A pointer to an array of chars.  Each&n;&t; *&t;&t;&t;element stores one byte of the address.&n;&t; *&t;&t;&t;That is, it isn&squot;t in ASCII.&n;&t; *&n;&t; *&t;This function transfers a MAC address to one of the&n;&t; *&t;TLAN AREGs (address registers).  The TLAN chip locks&n;&t; *&t;the register on writing to offset 0 and unlocks the&n;&t; *&t;register after writing to offset 5.  If NULL is passed&n;&t; *&t;in mac, then the AREG is filled with 0&squot;s.&n;&t; *&n;&t; **************************************************************/
DECL|function|TLan_SetMac
r_void
id|TLan_SetMac
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
r_int
id|areg
comma
r_char
op_star
id|mac
)paren
(brace
r_int
id|i
suffix:semicolon
id|areg
op_mul_assign
l_int|6
suffix:semicolon
r_if
c_cond
(paren
id|mac
op_ne
l_int|NULL
)paren
(brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|6
suffix:semicolon
id|i
op_increment
)paren
id|TLan_DioWrite8
c_func
(paren
id|dev-&gt;base_addr
comma
id|TLAN_AREG_0
op_plus
id|areg
op_plus
id|i
comma
id|mac
(braket
id|i
)braket
)paren
suffix:semicolon
)brace
r_else
(brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|6
suffix:semicolon
id|i
op_increment
)paren
id|TLan_DioWrite8
c_func
(paren
id|dev-&gt;base_addr
comma
id|TLAN_AREG_0
op_plus
id|areg
op_plus
id|i
comma
l_int|0
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* TLan_SetMac */
multiline_comment|/*****************************************************************************&n;******************************************************************************&n;&n;&t;ThunderLAN Driver PHY Layer Routines&n;&n;&t;The TLAN chip can drive any number of PHYs (physical devices).  Rather&n;&t;than having lots of &squot;if&squot; or &squot;#ifdef&squot; statements, I have created a&n;&t;second driver layer for the PHYs.  Each PHY can be identified from its&n;&t;id in registers 2 and 3, and can be given a Check and Service routine&n;&t;that will be called when the adapter is reset and when the adapter&n;&t;receives a Network Status interrupt, respectively.&n;&t;&n;******************************************************************************&n;*****************************************************************************/
DECL|variable|TLanPhyIdTable
r_static
id|TLanPhyIdEntry
id|TLanPhyIdTable
(braket
)braket
op_assign
(brace
(brace
l_int|0x4000
comma
l_int|0x5014
comma
op_amp
id|TLan_PhyInternalCheck
comma
op_amp
id|TLan_PhyInternalService
comma
id|TLAN_PHY_ACTIVITY
op_or
id|TLAN_PHY_INTS
op_or
id|TLAN_PHY_INTERNAL
)brace
comma
(brace
l_int|0x4000
comma
l_int|0x5015
comma
op_amp
id|TLan_PhyInternalCheck
comma
op_amp
id|TLan_PhyInternalService
comma
id|TLAN_PHY_ACTIVITY
op_or
id|TLAN_PHY_INTS
op_or
id|TLAN_PHY_INTERNAL
)brace
comma
(brace
l_int|0x4000
comma
l_int|0x5016
comma
op_amp
id|TLan_PhyInternalCheck
comma
op_amp
id|TLan_PhyInternalService
comma
id|TLAN_PHY_ACTIVITY
op_or
id|TLAN_PHY_INTS
op_or
id|TLAN_PHY_INTERNAL
)brace
comma
(brace
l_int|0x2000
comma
l_int|0x5C00
comma
op_amp
id|TLan_PhyDp83840aCheck
comma
op_amp
id|TLan_PhyNop
comma
id|TLAN_PHY_ACTIVITY
op_or
id|TLAN_PHY_AUTONEG
)brace
comma
(brace
l_int|0x2000
comma
l_int|0x5C01
comma
op_amp
id|TLan_PhyDp83840aCheck
comma
op_amp
id|TLan_PhyNop
comma
id|TLAN_PHY_ACTIVITY
op_or
id|TLAN_PHY_AUTONEG
)brace
comma
(brace
l_int|0x7810
comma
l_int|0x0000
comma
op_amp
id|TLan_PhyDp83840aCheck
comma
op_amp
id|TLan_PhyNop
comma
id|TLAN_PHY_AUTONEG
)brace
comma
(brace
l_int|0x0000
comma
l_int|0x0000
comma
l_int|NULL
comma
l_int|NULL
comma
l_int|0
)brace
)brace
suffix:semicolon
multiline_comment|/*********************************************************************&n;&t; *&t;TLan_PhyPrint&n;&t; *&n;&t; *&t;Returns:&n;&t; *&t;&t;Nothing&n;&t; *&t;Parms:&n;&t; *&t;&t;dev&t;A pointer to the device structure of the adapter&n;&t; *&t;&t;&t;which the desired PHY is located.&n;&t; *&t;&t;&t;&t;&n;&t; *&t;This function prints the registers a PHY.&n;&t; *&n;&t; ********************************************************************/
DECL|function|TLan_PhyPrint
r_void
id|TLan_PhyPrint
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
id|TLanPrivateInfo
op_star
id|priv
op_assign
(paren
id|TLanPrivateInfo
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|u16
id|i
comma
id|data0
comma
id|data1
comma
id|data2
comma
id|data3
comma
id|phy
suffix:semicolon
id|u32
id|io
suffix:semicolon
id|phy
op_assign
id|priv-&gt;phyAddr
suffix:semicolon
id|io
op_assign
id|dev-&gt;base_addr
suffix:semicolon
r_if
c_cond
(paren
(paren
id|phy
OG
l_int|0
)paren
op_logical_and
(paren
id|phy
op_le
id|TLAN_PHY_MAX_ADDR
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;TLAN:   Device %s, PHY 0x%02x.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|phy
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;TLAN:      Off.  +0     +1     +2     +3 &bslash;n&quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|0x20
suffix:semicolon
id|i
op_add_assign
l_int|4
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;TLAN:      0x%02x&quot;
comma
id|i
)paren
suffix:semicolon
id|TLan_MiiReadReg
c_func
(paren
id|io
comma
id|phy
comma
id|i
comma
op_amp
id|data0
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot; 0x%04hx&quot;
comma
id|data0
)paren
suffix:semicolon
id|TLan_MiiReadReg
c_func
(paren
id|io
comma
id|phy
comma
id|i
op_plus
l_int|1
comma
op_amp
id|data1
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot; 0x%04hx&quot;
comma
id|data1
)paren
suffix:semicolon
id|TLan_MiiReadReg
c_func
(paren
id|io
comma
id|phy
comma
id|i
op_plus
l_int|2
comma
op_amp
id|data2
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot; 0x%04hx&quot;
comma
id|data2
)paren
suffix:semicolon
id|TLan_MiiReadReg
c_func
(paren
id|io
comma
id|phy
comma
id|i
op_plus
l_int|3
comma
op_amp
id|data3
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot; 0x%04hx&bslash;n&quot;
comma
id|data3
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
id|printk
c_func
(paren
l_string|&quot;TLAN:   Device %s, PHY 0x%02x (Unmanaged/Unknown).&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|phy
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* TLan_PhyPrint */
multiline_comment|/*********************************************************************&n;&t; *&t;TLan_PhySelect&n;&t; *&n;&t; *&t;Returns:&n;&t; *&t;&t;Nothing&n;&t; *&t;Parms:&n;&t; *&t;&t;dev&t;A pointer to the device structure of the adapter&n;&t; *&t;&t;&t;for which the PHY needs determined.&n;&t; *&n;&t; *&t;This function decides which PHY amoung those attached to the&n;&t; *&t;TLAN chip is to be used.  The TLAN chip can be attached to&n;&t; *&t;multiple PHYs, and the driver needs to decide which one to&n;&t; *&t;talk to.  Currently this routine picks the PHY with the lowest&n;&t; *&t;address as the internal PHY address is 0x1F, the highest&n;&t; *&t;possible.  This strategy assumes that there can be only one&n;&t; *&t;other PHY, and, if it exists, it is the one to be used.  If&n;&t; *&t;token ring PHYs are ever supported, this routine will become&n;&t; *&t;a little more interesting...&n;&t; *&n;&t; ********************************************************************/
DECL|function|TLan_PhySelect
r_void
id|TLan_PhySelect
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
id|TLanPrivateInfo
op_star
id|priv
op_assign
(paren
id|TLanPrivateInfo
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_int
id|phy
suffix:semicolon
r_int
id|entry
suffix:semicolon
id|u16
id|id_hi
(braket
id|TLAN_PHY_MAX_ADDR
op_plus
l_int|1
)braket
suffix:semicolon
id|u16
id|id_lo
(braket
id|TLAN_PHY_MAX_ADDR
op_plus
l_int|1
)braket
suffix:semicolon
id|u16
id|hi
suffix:semicolon
id|u16
id|lo
suffix:semicolon
id|u16
id|vendor
suffix:semicolon
id|u16
id|device
suffix:semicolon
id|priv-&gt;phyCheck
op_assign
op_amp
id|TLan_PhyNop
suffix:semicolon
multiline_comment|/* Make sure these aren&squot;t ever NULL */
id|priv-&gt;phyService
op_assign
op_amp
id|TLan_PhyNop
suffix:semicolon
id|vendor
op_assign
id|TLanDeviceList
(braket
id|priv-&gt;pciEntry
)braket
dot
id|vendorId
suffix:semicolon
id|device
op_assign
id|TLanDeviceList
(braket
id|priv-&gt;pciEntry
)braket
dot
id|deviceId
suffix:semicolon
multiline_comment|/*&n;&t; * This is a bit uglier than I&squot;d like, but the 0xF130 device must&n;&t; * NOT be assigned a valid PHY as it uses an unmanaged, bit-rate&n;&t; * PHY.  It is simplest just to use another goto, rather than&n;&t; * nesting the two for loops in the if statement.&n;&t; */
r_if
c_cond
(paren
(paren
id|vendor
op_eq
id|PCI_VENDOR_ID_COMPAQ
)paren
op_logical_and
(paren
id|device
op_eq
id|PCI_DEVICE_ID_NETFLEX_3P
)paren
)paren
(brace
id|entry
op_assign
l_int|0
suffix:semicolon
id|phy
op_assign
l_int|0
suffix:semicolon
r_goto
id|FINISH
suffix:semicolon
)brace
r_for
c_loop
(paren
id|phy
op_assign
l_int|0
suffix:semicolon
id|phy
op_le
id|TLAN_PHY_MAX_ADDR
suffix:semicolon
id|phy
op_increment
)paren
(brace
id|hi
op_assign
id|lo
op_assign
l_int|0
suffix:semicolon
id|TLan_MiiReadReg
c_func
(paren
id|dev-&gt;base_addr
comma
id|phy
comma
id|MII_GEN_ID_HI
comma
op_amp
id|hi
)paren
suffix:semicolon
id|TLan_MiiReadReg
c_func
(paren
id|dev-&gt;base_addr
comma
id|phy
comma
id|MII_GEN_ID_LO
comma
op_amp
id|lo
)paren
suffix:semicolon
id|id_hi
(braket
id|phy
)braket
op_assign
id|hi
suffix:semicolon
id|id_lo
(braket
id|phy
)braket
op_assign
id|lo
suffix:semicolon
id|TLAN_DBG
c_func
(paren
id|TLAN_DEBUG_GNRL
comma
l_string|&quot;TLAN: Phy %2x, hi = %hx, lo = %hx&bslash;n&quot;
comma
id|phy
comma
id|hi
comma
id|lo
)paren
suffix:semicolon
)brace
r_for
c_loop
(paren
id|phy
op_assign
l_int|0
suffix:semicolon
id|phy
op_le
id|TLAN_PHY_MAX_ADDR
suffix:semicolon
id|phy
op_increment
)paren
(brace
r_if
c_cond
(paren
(paren
id|aui
op_eq
l_int|1
)paren
op_logical_and
(paren
id|phy
op_ne
id|TLAN_PHY_MAX_ADDR
)paren
)paren
(brace
r_if
c_cond
(paren
id|id_hi
(braket
id|phy
)braket
op_ne
l_int|0xFFFF
)paren
(brace
id|TLan_MiiSync
c_func
(paren
id|dev-&gt;base_addr
)paren
suffix:semicolon
id|TLan_MiiWriteReg
c_func
(paren
id|dev-&gt;base_addr
comma
id|phy
comma
id|MII_GEN_CTL
comma
id|MII_GC_PDOWN
op_or
id|MII_GC_LOOPBK
op_or
id|MII_GC_ISOLATE
)paren
suffix:semicolon
)brace
r_continue
suffix:semicolon
)brace
r_for
c_loop
(paren
id|entry
op_assign
l_int|0
suffix:semicolon
id|TLanPhyIdTable
(braket
id|entry
)braket
dot
id|check
suffix:semicolon
id|entry
op_increment
)paren
(brace
r_if
c_cond
(paren
(paren
id|id_hi
(braket
id|phy
)braket
op_eq
id|TLanPhyIdTable
(braket
id|entry
)braket
dot
id|idHi
)paren
op_logical_and
(paren
id|id_lo
(braket
id|phy
)braket
op_eq
id|TLanPhyIdTable
(braket
id|entry
)braket
dot
id|idLo
)paren
)paren
(brace
id|TLAN_DBG
c_func
(paren
id|TLAN_DEBUG_GNRL
comma
l_string|&quot;TLAN: Selected Phy %hx&bslash;n&quot;
comma
id|phy
)paren
suffix:semicolon
r_goto
id|FINISH
suffix:semicolon
)brace
)brace
)brace
id|entry
op_assign
l_int|0
suffix:semicolon
id|phy
op_assign
l_int|0
suffix:semicolon
id|FINISH
suffix:colon
r_if
c_cond
(paren
(paren
id|entry
op_eq
l_int|0
)paren
op_logical_and
(paren
id|phy
op_eq
l_int|0
)paren
)paren
(brace
id|priv-&gt;phyAddr
op_assign
id|phy
suffix:semicolon
id|priv-&gt;phyEntry
op_assign
id|entry
suffix:semicolon
id|priv-&gt;phyCheck
op_assign
id|TLan_PhyNop
suffix:semicolon
id|priv-&gt;phyService
op_assign
id|TLan_PhyNop
suffix:semicolon
id|priv-&gt;phyFlags
op_assign
id|TLAN_PHY_BIT_RATE
op_or
id|TLAN_PHY_UNMANAGED
op_or
id|TLAN_PHY_ACTIVITY
suffix:semicolon
)brace
r_else
(brace
id|priv-&gt;phyAddr
op_assign
id|phy
suffix:semicolon
id|priv-&gt;phyEntry
op_assign
id|entry
suffix:semicolon
id|priv-&gt;phyCheck
op_assign
id|TLanPhyIdTable
(braket
id|entry
)braket
dot
id|check
suffix:semicolon
id|priv-&gt;phyService
op_assign
id|TLanPhyIdTable
(braket
id|entry
)braket
dot
id|service
suffix:semicolon
id|priv-&gt;phyFlags
op_assign
id|TLanPhyIdTable
(braket
id|entry
)braket
dot
id|flags
suffix:semicolon
)brace
)brace
multiline_comment|/* TLan_PhySelect */
multiline_comment|/***************************************************************&n;&t; *&t;TLan_PhyNop&n;&t; *&n;&t; *&t;Returns:&n;&t; *&t;&t;Nothing&n;&t; *&t;Parms:&n;&t; *&t;&t;dev&t;A pointer to a device structure.&n;&t; *&n;&t; *&t;This function does nothing and is meant as a stand-in&n;&t; *&t;for when a Check or Service function would be&n;&t; *&t;meaningless.&n;&t; *&n;&t; **************************************************************/
DECL|function|TLan_PhyNop
r_int
id|TLan_PhyNop
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
id|dev
op_assign
l_int|NULL
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* TLan_PhyNop */
multiline_comment|/***************************************************************&n;&t; *  TLan_PhyInternalCheck&n;&t; *&n;&t; *&t;Returns:&n;&t; *&t;&t;Nothing&n;&t; *&t;Parms:&n;&t; *&t;&t;dev&t;A pointer to a device structure of the&n;&t; *&t;&t;&t;adapter&t;holding the PHY to be checked.&n;&t; *&n;&t; *&t;This function resets the internal PHY on a TLAN chip.&n;&t; *&t;See Chap. 7, &quot;Physical Interface (PHY)&quot; of &quot;ThunderLAN&n;&t; *&t;Programmer&squot;s Guide&quot;&n;&t; *&n;&t; **************************************************************/
DECL|function|TLan_PhyInternalCheck
r_int
id|TLan_PhyInternalCheck
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
id|TLanPrivateInfo
op_star
id|priv
op_assign
(paren
id|TLanPrivateInfo
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|u16
id|gen_ctl
suffix:semicolon
id|u32
id|io
suffix:semicolon
id|u16
id|phy
suffix:semicolon
id|u16
id|value
suffix:semicolon
id|u8
id|sio
suffix:semicolon
id|io
op_assign
id|dev-&gt;base_addr
suffix:semicolon
id|phy
op_assign
id|priv-&gt;phyAddr
suffix:semicolon
id|TLan_MiiReadReg
c_func
(paren
id|io
comma
id|phy
comma
id|MII_GEN_CTL
comma
op_amp
id|gen_ctl
)paren
suffix:semicolon
r_if
c_cond
(paren
id|gen_ctl
op_amp
id|MII_GC_PDOWN
)paren
(brace
id|TLan_MiiSync
c_func
(paren
id|io
)paren
suffix:semicolon
id|TLan_MiiWriteReg
c_func
(paren
id|io
comma
id|phy
comma
id|MII_GEN_CTL
comma
id|MII_GC_PDOWN
op_or
id|MII_GC_LOOPBK
op_or
id|MII_GC_ISOLATE
)paren
suffix:semicolon
id|TLan_MiiWriteReg
c_func
(paren
id|io
comma
id|phy
comma
id|MII_GEN_CTL
comma
id|MII_GC_LOOPBK
)paren
suffix:semicolon
id|mdelay
c_func
(paren
l_int|50
)paren
suffix:semicolon
id|TLan_MiiWriteReg
c_func
(paren
id|io
comma
id|phy
comma
id|MII_GEN_CTL
comma
id|MII_GC_RESET
op_or
id|MII_GC_LOOPBK
)paren
suffix:semicolon
id|TLan_MiiSync
c_func
(paren
id|io
)paren
suffix:semicolon
)brace
id|TLan_MiiReadReg
c_func
(paren
id|io
comma
id|phy
comma
id|MII_GEN_CTL
comma
op_amp
id|value
)paren
suffix:semicolon
r_while
c_loop
(paren
id|value
op_amp
id|MII_GC_RESET
)paren
id|TLan_MiiReadReg
c_func
(paren
id|io
comma
id|phy
comma
id|MII_GEN_CTL
comma
op_amp
id|value
)paren
suffix:semicolon
multiline_comment|/* TLan_MiiWriteReg( io, phy, MII_GEN_CTL, MII_GC_LOOPBK | MII_GC_DUPLEX ); */
multiline_comment|/* TLan_MiiWriteReg( io, phy, MII_GEN_CTL, MII_GC_DUPLEX ); */
id|TLan_MiiWriteReg
c_func
(paren
id|io
comma
id|phy
comma
id|MII_GEN_CTL
comma
l_int|0
)paren
suffix:semicolon
id|mdelay
c_func
(paren
l_int|500
)paren
suffix:semicolon
id|TLan_MiiReadReg
c_func
(paren
id|io
comma
id|phy
comma
id|TLAN_TLPHY_CTL
comma
op_amp
id|value
)paren
suffix:semicolon
r_if
c_cond
(paren
id|aui
)paren
id|value
op_or_assign
id|TLAN_TC_AUISEL
suffix:semicolon
r_else
id|value
op_and_assign
op_complement
id|TLAN_TC_AUISEL
suffix:semicolon
id|TLan_MiiWriteReg
c_func
(paren
id|io
comma
id|phy
comma
id|TLAN_TLPHY_CTL
comma
id|value
)paren
suffix:semicolon
multiline_comment|/* Read Possible Latched Link Status */
id|TLan_MiiReadReg
c_func
(paren
id|io
comma
id|phy
comma
id|MII_GEN_STS
comma
op_amp
id|value
)paren
suffix:semicolon
multiline_comment|/* Read Real Link Status */
id|TLan_MiiReadReg
c_func
(paren
id|io
comma
id|phy
comma
id|MII_GEN_STS
comma
op_amp
id|value
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|value
op_amp
id|MII_GS_LINK
)paren
op_logical_or
id|aui
)paren
(brace
id|priv-&gt;phyOnline
op_assign
l_int|1
suffix:semicolon
id|TLan_DioWrite8
c_func
(paren
id|io
comma
id|TLAN_LED_REG
comma
id|TLAN_LED_LINK
)paren
suffix:semicolon
)brace
r_else
(brace
id|priv-&gt;phyOnline
op_assign
l_int|0
suffix:semicolon
id|TLan_DioWrite8
c_func
(paren
id|io
comma
id|TLAN_LED_REG
comma
l_int|0
)paren
suffix:semicolon
)brace
multiline_comment|/* Enable Interrupts */
id|TLan_MiiReadReg
c_func
(paren
id|io
comma
id|phy
comma
id|TLAN_TLPHY_CTL
comma
op_amp
id|value
)paren
suffix:semicolon
id|value
op_or_assign
id|TLAN_TC_INTEN
suffix:semicolon
id|TLan_MiiWriteReg
c_func
(paren
id|io
comma
id|phy
comma
id|TLAN_TLPHY_CTL
comma
id|value
)paren
suffix:semicolon
id|sio
op_assign
id|TLan_DioRead8
c_func
(paren
id|io
comma
id|TLAN_NET_SIO
)paren
suffix:semicolon
id|sio
op_or_assign
id|TLAN_NET_SIO_MINTEN
suffix:semicolon
id|TLan_DioWrite8
c_func
(paren
id|io
comma
id|TLAN_NET_SIO
comma
id|sio
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* TLanPhyInternalCheck */
multiline_comment|/***************************************************************&n;&t; *&t;TLan_PhyInternalService&n;&t; *&n;&t; *&t;Returns:&n;&t; *&t;&t;Nothing&n;&t; *&t;Parms:&n;&t; *&t;&t;dev&t;A pointer to a device structure of the&n;&t; *&t;&t;&t;adapter&t;holding the PHY to be serviced.&n;&t; *&n;&t; *&t;This function services an interrupt generated by the&n;&t; *&t;internal PHY.  It can turn on/off the link LED.  See&n;&t; *&t;Chap. 7, &quot;Physical Interface (PHY)&quot; of &quot;ThunderLAN&n;&t; *&t;Programmer&squot;s Guide&quot;.&n;&t; *&n;&t; **************************************************************/
DECL|function|TLan_PhyInternalService
r_int
id|TLan_PhyInternalService
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
id|TLanPrivateInfo
op_star
id|priv
op_assign
(paren
id|TLanPrivateInfo
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|u16
id|tlphy_sts
suffix:semicolon
id|u16
id|gen_sts
suffix:semicolon
id|u16
id|an_exp
suffix:semicolon
id|u32
id|io
suffix:semicolon
id|u16
id|phy
suffix:semicolon
id|io
op_assign
id|dev-&gt;base_addr
suffix:semicolon
id|phy
op_assign
id|priv-&gt;phyAddr
suffix:semicolon
id|TLan_MiiReadReg
c_func
(paren
id|io
comma
id|phy
comma
id|TLAN_TLPHY_STS
comma
op_amp
id|tlphy_sts
)paren
suffix:semicolon
id|TLan_MiiReadReg
c_func
(paren
id|io
comma
id|phy
comma
id|MII_GEN_STS
comma
op_amp
id|gen_sts
)paren
suffix:semicolon
id|TLan_MiiReadReg
c_func
(paren
id|io
comma
id|phy
comma
id|MII_AN_EXP
comma
op_amp
id|an_exp
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|gen_sts
op_amp
id|MII_GS_LINK
)paren
op_logical_or
id|aui
)paren
(brace
id|priv-&gt;phyOnline
op_assign
l_int|1
suffix:semicolon
id|TLan_DioWrite8
c_func
(paren
id|io
comma
id|TLAN_LED_REG
comma
id|TLAN_LED_LINK
)paren
suffix:semicolon
)brace
r_else
(brace
id|priv-&gt;phyOnline
op_assign
l_int|0
suffix:semicolon
id|TLan_DioWrite8
c_func
(paren
id|io
comma
id|TLAN_LED_REG
comma
l_int|0
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|tlphy_sts
op_amp
id|TLAN_TS_POLOK
)paren
op_eq
l_int|0
)paren
(brace
id|u16
id|value
suffix:semicolon
id|TLan_MiiReadReg
c_func
(paren
id|io
comma
id|phy
comma
id|TLAN_TLPHY_CTL
comma
op_amp
id|value
)paren
suffix:semicolon
id|value
op_or_assign
id|TLAN_TC_SWAPOL
suffix:semicolon
id|TLan_MiiWriteReg
c_func
(paren
id|io
comma
id|phy
comma
id|TLAN_TLPHY_CTL
comma
id|value
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* TLan_PhyInternalService */
multiline_comment|/***************************************************************&n;&t; *&t;TLan_PhyDp83840aCheck&n;&t; *&n;&t; *&t;Returns:&n;&t; *&t;&t;Nothing&n;&t; *&t;Parms:&n;&t; *&t;&t;dev&t;A pointer to a device structure of the&n;&t; *&t;&t;&t;adapter holding the PHY to be reset.&n;&t; *&n;&t; *&t;This function resets a National Semiconductor DP83840A&n;&t; *&t;10/100 Mb/s PHY device.  See National Semiconductor&squot;s&n;&t; *&t;data sheet for more info.  This PHY is used on Compaq&n;&t; *&t;Netelligent 10/100 cards.&n;&t; *&n;&t; **************************************************************/
DECL|function|TLan_PhyDp83840aCheck
r_static
r_int
id|TLan_PhyDp83840aCheck
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
id|TLanPrivateInfo
op_star
id|priv
op_assign
(paren
id|TLanPrivateInfo
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|u16
id|gen_ctl
suffix:semicolon
id|u32
id|io
suffix:semicolon
id|u16
id|phy
suffix:semicolon
id|u16
id|value
suffix:semicolon
id|u8
id|sio
suffix:semicolon
id|io
op_assign
id|dev-&gt;base_addr
suffix:semicolon
id|phy
op_assign
id|priv-&gt;phyAddr
suffix:semicolon
id|TLan_MiiReadReg
c_func
(paren
id|io
comma
id|phy
comma
id|MII_GEN_CTL
comma
op_amp
id|gen_ctl
)paren
suffix:semicolon
r_if
c_cond
(paren
id|gen_ctl
op_amp
id|MII_GC_PDOWN
)paren
(brace
id|TLan_MiiSync
c_func
(paren
id|io
)paren
suffix:semicolon
id|TLan_MiiWriteReg
c_func
(paren
id|io
comma
id|phy
comma
id|MII_GEN_CTL
comma
id|MII_GC_PDOWN
op_or
id|MII_GC_LOOPBK
op_or
id|MII_GC_ISOLATE
)paren
suffix:semicolon
id|TLan_MiiWriteReg
c_func
(paren
id|io
comma
id|phy
comma
id|MII_GEN_CTL
comma
id|MII_GC_LOOPBK
)paren
suffix:semicolon
id|mdelay
c_func
(paren
l_int|500
)paren
suffix:semicolon
id|TLan_MiiWriteReg
c_func
(paren
id|io
comma
id|phy
comma
id|MII_GEN_CTL
comma
id|MII_GC_RESET
op_or
id|MII_GC_LOOPBK
)paren
suffix:semicolon
id|TLan_MiiSync
c_func
(paren
id|io
)paren
suffix:semicolon
)brace
id|TLan_MiiReadReg
c_func
(paren
id|io
comma
id|phy
comma
id|MII_GEN_CTL
comma
op_amp
id|value
)paren
suffix:semicolon
r_while
c_loop
(paren
id|value
op_amp
id|MII_GC_RESET
)paren
id|TLan_MiiReadReg
c_func
(paren
id|io
comma
id|phy
comma
id|MII_GEN_CTL
comma
op_amp
id|value
)paren
suffix:semicolon
multiline_comment|/* TLan_MiiWriteReg( io, phy, MII_GEN_CTL, MII_GC_LOOPBK | MII_GC_DUPLEX ); */
multiline_comment|/* TLan_MiiWriteReg( io, phy, MII_GEN_CTL, MII_GC_DUPLEX ); */
id|TLan_MiiWriteReg
c_func
(paren
id|io
comma
id|phy
comma
id|MII_GEN_CTL
comma
l_int|0
)paren
suffix:semicolon
id|TLan_MiiReadReg
c_func
(paren
id|io
comma
id|phy
comma
id|MII_AN_ADV
comma
op_amp
id|value
)paren
suffix:semicolon
id|value
op_and_assign
op_complement
l_int|0x0140
suffix:semicolon
id|TLan_MiiWriteReg
c_func
(paren
id|io
comma
id|phy
comma
id|MII_AN_ADV
comma
id|value
)paren
suffix:semicolon
id|TLan_MiiWriteReg
c_func
(paren
id|io
comma
id|phy
comma
id|MII_GEN_CTL
comma
l_int|0x1000
)paren
suffix:semicolon
id|TLan_MiiWriteReg
c_func
(paren
id|io
comma
id|phy
comma
id|MII_GEN_CTL
comma
l_int|0x1200
)paren
suffix:semicolon
id|mdelay
c_func
(paren
l_int|50
)paren
suffix:semicolon
macro_line|#if 0
multiline_comment|/* Read Possible Latched Link Status */
id|TLan_MiiReadReg
c_func
(paren
id|io
comma
id|phy
comma
id|MII_GEN_STS
comma
op_amp
id|value
)paren
suffix:semicolon
multiline_comment|/* Read Real Link Status */
id|TLan_MiiReadReg
c_func
(paren
id|io
comma
id|phy
comma
id|MII_GEN_STS
comma
op_amp
id|value
)paren
suffix:semicolon
r_if
c_cond
(paren
id|value
op_amp
id|MII_GS_LINK
)paren
(brace
id|priv-&gt;phyOnline
op_assign
l_int|1
suffix:semicolon
id|TLan_DioWrite8
c_func
(paren
id|io
comma
id|TLAN_LED_REG
comma
id|TLAN_LED_LINK
)paren
suffix:semicolon
)brace
r_else
(brace
id|priv-&gt;phyOnline
op_assign
l_int|0
suffix:semicolon
id|TLan_DioWrite8
c_func
(paren
id|io
comma
id|TLAN_LED_REG
comma
l_int|0
)paren
suffix:semicolon
)brace
multiline_comment|/* Enable Interrupts */
id|TLan_MiiReadReg
c_func
(paren
id|io
comma
id|phy
comma
id|TLAN_TLPHY_CTL
comma
op_amp
id|value
)paren
suffix:semicolon
id|value
op_or_assign
id|TLAN_TC_INTEN
suffix:semicolon
id|TLan_MiiWriteReg
c_func
(paren
id|io
comma
id|phy
comma
id|TLAN_TLPHY_CTL
comma
id|value
)paren
suffix:semicolon
macro_line|#endif
id|sio
op_assign
id|TLan_DioRead8
c_func
(paren
id|dev-&gt;base_addr
comma
id|TLAN_NET_SIO
)paren
suffix:semicolon
id|sio
op_and_assign
op_complement
id|TLAN_NET_SIO_MINTEN
suffix:semicolon
id|TLan_DioWrite8
c_func
(paren
id|dev-&gt;base_addr
comma
id|TLAN_NET_SIO
comma
id|sio
)paren
suffix:semicolon
multiline_comment|/*&t;priv-&gt;phyOnline = 1; */
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* TLan_PhyDp83840aCheck */
multiline_comment|/*****************************************************************************&n;******************************************************************************&n;&n;&t;ThunderLAN Driver MII Routines&n;&n;&t;These routines are based on the information in Chap. 2 of the&n;&t;&quot;ThunderLAN Programmer&squot;s Guide&quot;, pp. 15-24.&n;&n;******************************************************************************&n;*****************************************************************************/
multiline_comment|/***************************************************************&n;&t; *&t;TLan_MiiReadReg&n;&t; *&n;&t; *&t;Returns:&n;&t; *&t;&t;0&t;if ack received ok&n;&t; *&t;&t;1&t;otherwise.&n;&t; *&n;&t; *&t;Parms:&n;&t; *&t;&t;base_port&t;The base IO port of the adapter in&n;&t; *&t;&t;&t;&t;question.&n;&t; *&t;&t;dev&t;&t;The address of the PHY to be queried.&n;&t; *&t;&t;reg&t;&t;The register whose contents are to be&n;&t; *&t;&t;&t;&t;retreived.&n;&t; *&t;&t;val&t;&t;A pointer to a variable to store the&n;&t; *&t;&t;&t;&t;retrieved value.&n;&t; *&n;&t; *&t;This function uses the TLAN&squot;s MII bus to retreive the contents&n;&t; *&t;of a given register on a PHY.  It sends the appropriate info&n;&t; *&t;and then reads the 16-bit register value from the MII bus via&n;&t; *&t;the TLAN SIO register.&n;&t; *&n;&t; **************************************************************/
DECL|function|TLan_MiiReadReg
r_int
id|TLan_MiiReadReg
c_func
(paren
id|u16
id|base_port
comma
id|u16
id|dev
comma
id|u16
id|reg
comma
id|u16
op_star
id|val
)paren
(brace
id|u8
id|nack
suffix:semicolon
id|u16
id|sio
comma
id|tmp
suffix:semicolon
id|u32
id|i
suffix:semicolon
r_int
id|err
suffix:semicolon
r_int
id|minten
suffix:semicolon
id|err
op_assign
id|FALSE
suffix:semicolon
id|outw
c_func
(paren
id|TLAN_NET_SIO
comma
id|base_port
op_plus
id|TLAN_DIO_ADR
)paren
suffix:semicolon
id|sio
op_assign
id|base_port
op_plus
id|TLAN_DIO_DATA
op_plus
id|TLAN_NET_SIO
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|TLan_MiiSync
c_func
(paren
id|base_port
)paren
suffix:semicolon
id|minten
op_assign
id|TLan_GetBit
c_func
(paren
id|TLAN_NET_SIO_MINTEN
comma
id|sio
)paren
suffix:semicolon
r_if
c_cond
(paren
id|minten
)paren
id|TLan_ClearBit
c_func
(paren
id|TLAN_NET_SIO_MINTEN
comma
id|sio
)paren
suffix:semicolon
id|TLan_MiiSendData
c_func
(paren
id|base_port
comma
l_int|0x1
comma
l_int|2
)paren
suffix:semicolon
multiline_comment|/* Start ( 01b ) */
id|TLan_MiiSendData
c_func
(paren
id|base_port
comma
l_int|0x2
comma
l_int|2
)paren
suffix:semicolon
multiline_comment|/* Read  ( 10b ) */
id|TLan_MiiSendData
c_func
(paren
id|base_port
comma
id|dev
comma
l_int|5
)paren
suffix:semicolon
multiline_comment|/* Device #      */
id|TLan_MiiSendData
c_func
(paren
id|base_port
comma
id|reg
comma
l_int|5
)paren
suffix:semicolon
multiline_comment|/* Register #    */
id|TLan_ClearBit
c_func
(paren
id|TLAN_NET_SIO_MTXEN
comma
id|sio
)paren
suffix:semicolon
multiline_comment|/* Change direction */
id|TLan_ClearBit
c_func
(paren
id|TLAN_NET_SIO_MCLK
comma
id|sio
)paren
suffix:semicolon
multiline_comment|/* Clock Idle bit */
id|TLan_SetBit
c_func
(paren
id|TLAN_NET_SIO_MCLK
comma
id|sio
)paren
suffix:semicolon
id|TLan_ClearBit
c_func
(paren
id|TLAN_NET_SIO_MCLK
comma
id|sio
)paren
suffix:semicolon
multiline_comment|/* Wait 300ns */
id|nack
op_assign
id|TLan_GetBit
c_func
(paren
id|TLAN_NET_SIO_MDATA
comma
id|sio
)paren
suffix:semicolon
multiline_comment|/* Check for ACK */
id|TLan_SetBit
c_func
(paren
id|TLAN_NET_SIO_MCLK
comma
id|sio
)paren
suffix:semicolon
multiline_comment|/* Finish ACK */
r_if
c_cond
(paren
id|nack
)paren
(brace
multiline_comment|/* No ACK, so fake it */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|16
suffix:semicolon
id|i
op_increment
)paren
(brace
id|TLan_ClearBit
c_func
(paren
id|TLAN_NET_SIO_MCLK
comma
id|sio
)paren
suffix:semicolon
id|TLan_SetBit
c_func
(paren
id|TLAN_NET_SIO_MCLK
comma
id|sio
)paren
suffix:semicolon
)brace
id|tmp
op_assign
l_int|0xffff
suffix:semicolon
id|err
op_assign
id|TRUE
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* ACK, so read data */
r_for
c_loop
(paren
id|tmp
op_assign
l_int|0
comma
id|i
op_assign
l_int|0x8000
suffix:semicolon
id|i
suffix:semicolon
id|i
op_rshift_assign
l_int|1
)paren
(brace
id|TLan_ClearBit
c_func
(paren
id|TLAN_NET_SIO_MCLK
comma
id|sio
)paren
suffix:semicolon
r_if
c_cond
(paren
id|TLan_GetBit
c_func
(paren
id|TLAN_NET_SIO_MDATA
comma
id|sio
)paren
)paren
id|tmp
op_or_assign
id|i
suffix:semicolon
id|TLan_SetBit
c_func
(paren
id|TLAN_NET_SIO_MCLK
comma
id|sio
)paren
suffix:semicolon
)brace
)brace
id|TLan_ClearBit
c_func
(paren
id|TLAN_NET_SIO_MCLK
comma
id|sio
)paren
suffix:semicolon
multiline_comment|/* Idle cycle */
id|TLan_SetBit
c_func
(paren
id|TLAN_NET_SIO_MCLK
comma
id|sio
)paren
suffix:semicolon
r_if
c_cond
(paren
id|minten
)paren
id|TLan_SetBit
c_func
(paren
id|TLAN_NET_SIO_MINTEN
comma
id|sio
)paren
suffix:semicolon
op_star
id|val
op_assign
id|tmp
suffix:semicolon
id|sti
c_func
(paren
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
multiline_comment|/* TLan_MiiReadReg */
multiline_comment|/***************************************************************&n;&t; *&t;TLan_MiiSendData&n;&t; *&n;&t; *&t;Returns:&n;&t; *&t;&t;Nothing&n;&t; *&t;Parms:&n;&t; *&t;&t;base_port&t;The base IO port of the adapter&t;in&n;&t; *&t;&t;&t;&t;question.&n;&t; *&t;&t;dev&t;&t;The address of the PHY to be queried.&n;&t; *&t;&t;data&t;&t;The value to be placed on the MII bus.&n;&t; *&t;&t;num_bits&t;The number of bits in data that are to&n;&t; *&t;&t;&t;&t;be placed on the MII bus.&n;&t; *&n;&t; *&t;This function sends on sequence of bits on the MII&n;&t; *&t;configuration bus.&n;&t; *&n;&t; **************************************************************/
DECL|function|TLan_MiiSendData
r_void
id|TLan_MiiSendData
c_func
(paren
id|u16
id|base_port
comma
id|u32
id|data
comma
r_int
id|num_bits
)paren
(brace
id|u16
id|sio
suffix:semicolon
id|u32
id|i
suffix:semicolon
r_if
c_cond
(paren
id|num_bits
op_eq
l_int|0
)paren
r_return
suffix:semicolon
id|outw
c_func
(paren
id|TLAN_NET_SIO
comma
id|base_port
op_plus
id|TLAN_DIO_ADR
)paren
suffix:semicolon
id|sio
op_assign
id|base_port
op_plus
id|TLAN_DIO_DATA
op_plus
id|TLAN_NET_SIO
suffix:semicolon
id|TLan_SetBit
c_func
(paren
id|TLAN_NET_SIO_MTXEN
comma
id|sio
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
(paren
l_int|0x1
op_lshift
(paren
id|num_bits
op_minus
l_int|1
)paren
)paren
suffix:semicolon
id|i
suffix:semicolon
id|i
op_rshift_assign
l_int|1
)paren
(brace
id|TLan_ClearBit
c_func
(paren
id|TLAN_NET_SIO_MCLK
comma
id|sio
)paren
suffix:semicolon
id|TLan_GetBit
c_func
(paren
id|TLAN_NET_SIO_MCLK
comma
id|sio
)paren
suffix:semicolon
r_if
c_cond
(paren
id|data
op_amp
id|i
)paren
id|TLan_SetBit
c_func
(paren
id|TLAN_NET_SIO_MDATA
comma
id|sio
)paren
suffix:semicolon
r_else
id|TLan_ClearBit
c_func
(paren
id|TLAN_NET_SIO_MDATA
comma
id|sio
)paren
suffix:semicolon
id|TLan_SetBit
c_func
(paren
id|TLAN_NET_SIO_MCLK
comma
id|sio
)paren
suffix:semicolon
id|TLan_GetBit
c_func
(paren
id|TLAN_NET_SIO_MCLK
comma
id|sio
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* TLan_MiiSendData */
multiline_comment|/***************************************************************&n;&t; *&t;TLan_MiiSync&n;&t; *&n;&t; *&t;Returns:&n;&t; *&t;&t;Nothing&n;&t; *&t;Parms:&n;&t; *&t;&t;base_port&t;The base IO port of the adapter in&n;&t; *&t;&t;&t;&t;question.&n;&t; *&n;&t; *&t;This functions syncs all PHYs in terms of the MII configuration&n;&t; *&t;bus.&n;&t; *&n;&t; **************************************************************/
DECL|function|TLan_MiiSync
r_void
id|TLan_MiiSync
c_func
(paren
id|u16
id|base_port
)paren
(brace
r_int
id|i
suffix:semicolon
id|u16
id|sio
suffix:semicolon
id|outw
c_func
(paren
id|TLAN_NET_SIO
comma
id|base_port
op_plus
id|TLAN_DIO_ADR
)paren
suffix:semicolon
id|sio
op_assign
id|base_port
op_plus
id|TLAN_DIO_DATA
op_plus
id|TLAN_NET_SIO
suffix:semicolon
id|TLan_ClearBit
c_func
(paren
id|TLAN_NET_SIO_MTXEN
comma
id|sio
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|32
suffix:semicolon
id|i
op_increment
)paren
(brace
id|TLan_ClearBit
c_func
(paren
id|TLAN_NET_SIO_MCLK
comma
id|sio
)paren
suffix:semicolon
id|TLan_SetBit
c_func
(paren
id|TLAN_NET_SIO_MCLK
comma
id|sio
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* TLan_MiiSync */
multiline_comment|/***************************************************************&n;&t; *&t;TLan_MiiWriteReg&n;&t; *&n;&t; *&t;Returns:&n;&t; *&t;&t;Nothing&n;&t; *&t;Parms:&n;&t; *&t;&t;base_port&t;The base IO port of the adapter in&n;&t; *&t;&t;&t;&t;question.&n;&t; *&t;&t;dev&t;&t;The address of the PHY to be written to.&n;&t; *&t;&t;reg&t;&t;The register whose contents are to be&n;&t; *&t;&t;&t;&t;written.&n;&t; *&t;&t;val&t;&t;The value to be written to the register.&n;&t; *&n;&t; *&t;This function uses the TLAN&squot;s MII bus to write the contents of a&n;&t; *&t;given register on a PHY.  It sends the appropriate info and then&n;&t; *&t;writes the 16-bit register value from the MII configuration bus&n;&t; *&t;via the TLAN SIO register.&n;&t; *&n;&t; **************************************************************/
DECL|function|TLan_MiiWriteReg
r_void
id|TLan_MiiWriteReg
c_func
(paren
id|u16
id|base_port
comma
id|u16
id|dev
comma
id|u16
id|reg
comma
id|u16
id|val
)paren
(brace
id|u16
id|sio
suffix:semicolon
r_int
id|minten
suffix:semicolon
id|outw
c_func
(paren
id|TLAN_NET_SIO
comma
id|base_port
op_plus
id|TLAN_DIO_ADR
)paren
suffix:semicolon
id|sio
op_assign
id|base_port
op_plus
id|TLAN_DIO_DATA
op_plus
id|TLAN_NET_SIO
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|TLan_MiiSync
c_func
(paren
id|base_port
)paren
suffix:semicolon
id|minten
op_assign
id|TLan_GetBit
c_func
(paren
id|TLAN_NET_SIO_MINTEN
comma
id|sio
)paren
suffix:semicolon
r_if
c_cond
(paren
id|minten
)paren
id|TLan_ClearBit
c_func
(paren
id|TLAN_NET_SIO_MINTEN
comma
id|sio
)paren
suffix:semicolon
id|TLan_MiiSendData
c_func
(paren
id|base_port
comma
l_int|0x1
comma
l_int|2
)paren
suffix:semicolon
multiline_comment|/* Start ( 01b ) */
id|TLan_MiiSendData
c_func
(paren
id|base_port
comma
l_int|0x1
comma
l_int|2
)paren
suffix:semicolon
multiline_comment|/* Write ( 01b ) */
id|TLan_MiiSendData
c_func
(paren
id|base_port
comma
id|dev
comma
l_int|5
)paren
suffix:semicolon
multiline_comment|/* Device #      */
id|TLan_MiiSendData
c_func
(paren
id|base_port
comma
id|reg
comma
l_int|5
)paren
suffix:semicolon
multiline_comment|/* Register #    */
id|TLan_MiiSendData
c_func
(paren
id|base_port
comma
l_int|0x2
comma
l_int|2
)paren
suffix:semicolon
multiline_comment|/* Send ACK */
id|TLan_MiiSendData
c_func
(paren
id|base_port
comma
id|val
comma
l_int|16
)paren
suffix:semicolon
multiline_comment|/* Send Data */
id|TLan_ClearBit
c_func
(paren
id|TLAN_NET_SIO_MCLK
comma
id|sio
)paren
suffix:semicolon
multiline_comment|/* Idle cycle */
id|TLan_SetBit
c_func
(paren
id|TLAN_NET_SIO_MCLK
comma
id|sio
)paren
suffix:semicolon
r_if
c_cond
(paren
id|minten
)paren
id|TLan_SetBit
c_func
(paren
id|TLAN_NET_SIO_MINTEN
comma
id|sio
)paren
suffix:semicolon
id|sti
c_func
(paren
)paren
suffix:semicolon
)brace
multiline_comment|/* TLan_MiiWriteReg */
multiline_comment|/*****************************************************************************&n;******************************************************************************&n;&n;&t;ThunderLAN Driver Eeprom routines&n;&n;&t;The Compaq Netelligent 10 and 10/100 cards use a Microchip 24C02A&n;&t;EEPROM.  These functions are based on information in Microchip&squot;s&n;&t;data sheet.  I don&squot;t know how well this functions will work with&n;&t;other EEPROMs.&n;&n;******************************************************************************&n;*****************************************************************************/
multiline_comment|/***************************************************************&n;&t; *&t;TLan_EeSendStart&n;&t; *&n;&t; *&t;Returns:&n;&t; *&t;&t;Nothing&n;&t; *&t;Parms:&t;&n;&t; *&t;&t;io_base&t;&t;The IO port base address for the&n;&t; *&t;&t;&t;&t;TLAN device with the EEPROM to&n;&t; *&t;&t;&t;&t;use.&n;&t; *&n;&t; *&t;This function sends a start cycle to an EEPROM attached&n;&t; *&t;to a TLAN chip.&n;&t; *&n;&t; **************************************************************/
DECL|function|TLan_EeSendStart
r_void
id|TLan_EeSendStart
c_func
(paren
id|u16
id|io_base
)paren
(brace
id|u16
id|sio
suffix:semicolon
id|outw
c_func
(paren
id|TLAN_NET_SIO
comma
id|io_base
op_plus
id|TLAN_DIO_ADR
)paren
suffix:semicolon
id|sio
op_assign
id|io_base
op_plus
id|TLAN_DIO_DATA
op_plus
id|TLAN_NET_SIO
suffix:semicolon
id|TLan_SetBit
c_func
(paren
id|TLAN_NET_SIO_ECLOK
comma
id|sio
)paren
suffix:semicolon
id|TLan_SetBit
c_func
(paren
id|TLAN_NET_SIO_EDATA
comma
id|sio
)paren
suffix:semicolon
id|TLan_SetBit
c_func
(paren
id|TLAN_NET_SIO_ETXEN
comma
id|sio
)paren
suffix:semicolon
id|TLan_ClearBit
c_func
(paren
id|TLAN_NET_SIO_EDATA
comma
id|sio
)paren
suffix:semicolon
id|TLan_ClearBit
c_func
(paren
id|TLAN_NET_SIO_ECLOK
comma
id|sio
)paren
suffix:semicolon
)brace
multiline_comment|/* TLan_EeSendStart */
multiline_comment|/***************************************************************&n;&t; *&t;TLan_EeSendByte&n;&t; *&n;&t; *&t;Returns:&n;&t; *&t;&t;If the correct ack was received, 0, otherwise 1&n;&t; *&t;Parms:&t;io_base&t;&t;The IO port base address for the&n;&t; *&t;&t;&t;&t;TLAN device with the EEPROM to&n;&t; *&t;&t;&t;&t;use.&n;&t; *&t;&t;data&t;&t;The 8 bits of information to&n;&t; *&t;&t;&t;&t;send to the EEPROM.&n;&t; *&t;&t;stop&t;&t;If TLAN_EEPROM_STOP is passed, a&n;&t; *&t;&t;&t;&t;stop cycle is sent after the&n;&t; *&t;&t;&t;&t;byte is sent after the ack is&n;&t; *&t;&t;&t;&t;read.&n;&t; *&n;&t; *&t;This function sends a byte on the serial EEPROM line,&n;&t; *&t;driving the clock to send each bit. The function then&n;&t; *&t;reverses transmission direction and reads an acknowledge&n;&t; *&t;bit.&n;&t; *&n;&t; **************************************************************/
DECL|function|TLan_EeSendByte
r_int
id|TLan_EeSendByte
c_func
(paren
id|u16
id|io_base
comma
id|u8
id|data
comma
r_int
id|stop
)paren
(brace
r_int
id|err
suffix:semicolon
id|u8
id|place
suffix:semicolon
id|u16
id|sio
suffix:semicolon
id|outw
c_func
(paren
id|TLAN_NET_SIO
comma
id|io_base
op_plus
id|TLAN_DIO_ADR
)paren
suffix:semicolon
id|sio
op_assign
id|io_base
op_plus
id|TLAN_DIO_DATA
op_plus
id|TLAN_NET_SIO
suffix:semicolon
multiline_comment|/* Assume clock is low, tx is enabled; */
r_for
c_loop
(paren
id|place
op_assign
l_int|0x80
suffix:semicolon
id|place
op_ne
l_int|0
suffix:semicolon
id|place
op_rshift_assign
l_int|1
)paren
(brace
r_if
c_cond
(paren
id|place
op_amp
id|data
)paren
id|TLan_SetBit
c_func
(paren
id|TLAN_NET_SIO_EDATA
comma
id|sio
)paren
suffix:semicolon
r_else
id|TLan_ClearBit
c_func
(paren
id|TLAN_NET_SIO_EDATA
comma
id|sio
)paren
suffix:semicolon
id|TLan_SetBit
c_func
(paren
id|TLAN_NET_SIO_ECLOK
comma
id|sio
)paren
suffix:semicolon
id|TLan_ClearBit
c_func
(paren
id|TLAN_NET_SIO_ECLOK
comma
id|sio
)paren
suffix:semicolon
)brace
id|TLan_ClearBit
c_func
(paren
id|TLAN_NET_SIO_ETXEN
comma
id|sio
)paren
suffix:semicolon
id|TLan_SetBit
c_func
(paren
id|TLAN_NET_SIO_ECLOK
comma
id|sio
)paren
suffix:semicolon
id|err
op_assign
id|TLan_GetBit
c_func
(paren
id|TLAN_NET_SIO_EDATA
comma
id|sio
)paren
suffix:semicolon
id|TLan_ClearBit
c_func
(paren
id|TLAN_NET_SIO_ECLOK
comma
id|sio
)paren
suffix:semicolon
id|TLan_SetBit
c_func
(paren
id|TLAN_NET_SIO_ETXEN
comma
id|sio
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
op_logical_neg
id|err
)paren
op_logical_and
id|stop
)paren
(brace
id|TLan_ClearBit
c_func
(paren
id|TLAN_NET_SIO_EDATA
comma
id|sio
)paren
suffix:semicolon
multiline_comment|/* STOP, raise data while clock is high */
id|TLan_SetBit
c_func
(paren
id|TLAN_NET_SIO_ECLOK
comma
id|sio
)paren
suffix:semicolon
id|TLan_SetBit
c_func
(paren
id|TLAN_NET_SIO_EDATA
comma
id|sio
)paren
suffix:semicolon
)brace
r_return
(paren
id|err
)paren
suffix:semicolon
)brace
multiline_comment|/* TLan_EeSendByte */
multiline_comment|/***************************************************************&n;&t; *&t;TLan_EeReceiveByte&n;&t; *&n;&t; *&t;Returns:&n;&t; *&t;&t;Nothing&n;&t; *&t;Parms:&n;&t; *&t;&t;io_base&t;&t;The IO port base address for the&n;&t; *&t;&t;&t;&t;TLAN device with the EEPROM to&n;&t; *&t;&t;&t;&t;use.&n;&t; *&t;&t;data&t;&t;An address to a char to hold the&n;&t; *&t;&t;&t;&t;data sent from the EEPROM.&n;&t; *&t;&t;stop&t;&t;If TLAN_EEPROM_STOP is passed, a&n;&t; *&t;&t;&t;&t;stop cycle is sent after the&n;&t; *&t;&t;&t;&t;byte is received, and no ack is&n;&t; *&t;&t;&t;&t;sent.&n;&t; *&n;&t; *&t;This function receives 8 bits of data from the EEPROM&n;&t; *&t;over the serial link.  It then sends and ack bit, or no&n;&t; *&t;ack and a stop bit.  This function is used to retrieve&n;&t; *&t;data after the address of a byte in the EEPROM has been&n;&t; *&t;sent.&n;&t; *&n;&t; **************************************************************/
DECL|function|TLan_EeReceiveByte
r_void
id|TLan_EeReceiveByte
c_func
(paren
id|u16
id|io_base
comma
id|u8
op_star
id|data
comma
r_int
id|stop
)paren
(brace
id|u8
id|place
suffix:semicolon
id|u16
id|sio
suffix:semicolon
id|outw
c_func
(paren
id|TLAN_NET_SIO
comma
id|io_base
op_plus
id|TLAN_DIO_ADR
)paren
suffix:semicolon
id|sio
op_assign
id|io_base
op_plus
id|TLAN_DIO_DATA
op_plus
id|TLAN_NET_SIO
suffix:semicolon
op_star
id|data
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Assume clock is low, tx is enabled; */
id|TLan_ClearBit
c_func
(paren
id|TLAN_NET_SIO_ETXEN
comma
id|sio
)paren
suffix:semicolon
r_for
c_loop
(paren
id|place
op_assign
l_int|0x80
suffix:semicolon
id|place
suffix:semicolon
id|place
op_rshift_assign
l_int|1
)paren
(brace
id|TLan_SetBit
c_func
(paren
id|TLAN_NET_SIO_ECLOK
comma
id|sio
)paren
suffix:semicolon
r_if
c_cond
(paren
id|TLan_GetBit
c_func
(paren
id|TLAN_NET_SIO_EDATA
comma
id|sio
)paren
)paren
op_star
id|data
op_or_assign
id|place
suffix:semicolon
id|TLan_ClearBit
c_func
(paren
id|TLAN_NET_SIO_ECLOK
comma
id|sio
)paren
suffix:semicolon
)brace
id|TLan_SetBit
c_func
(paren
id|TLAN_NET_SIO_ETXEN
comma
id|sio
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|stop
)paren
(brace
id|TLan_ClearBit
c_func
(paren
id|TLAN_NET_SIO_EDATA
comma
id|sio
)paren
suffix:semicolon
multiline_comment|/* Ack = 0 */
id|TLan_SetBit
c_func
(paren
id|TLAN_NET_SIO_ECLOK
comma
id|sio
)paren
suffix:semicolon
id|TLan_ClearBit
c_func
(paren
id|TLAN_NET_SIO_ECLOK
comma
id|sio
)paren
suffix:semicolon
)brace
r_else
(brace
id|TLan_SetBit
c_func
(paren
id|TLAN_NET_SIO_EDATA
comma
id|sio
)paren
suffix:semicolon
multiline_comment|/* No ack = 1 (?) */
id|TLan_SetBit
c_func
(paren
id|TLAN_NET_SIO_ECLOK
comma
id|sio
)paren
suffix:semicolon
id|TLan_ClearBit
c_func
(paren
id|TLAN_NET_SIO_ECLOK
comma
id|sio
)paren
suffix:semicolon
id|TLan_ClearBit
c_func
(paren
id|TLAN_NET_SIO_EDATA
comma
id|sio
)paren
suffix:semicolon
multiline_comment|/* STOP, raise data while clock is high */
id|TLan_SetBit
c_func
(paren
id|TLAN_NET_SIO_ECLOK
comma
id|sio
)paren
suffix:semicolon
id|TLan_SetBit
c_func
(paren
id|TLAN_NET_SIO_EDATA
comma
id|sio
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* TLan_EeReceiveByte */
multiline_comment|/***************************************************************&n;&t; *&t;TLan_EeReadByte&n;&t; *&n;&t; *&t;Returns:&n;&t; *&t;&t;No error = 0, else, the stage at which the error&n;&t; *&t;&t;occurred.&n;&t; *&t;Parms:&n;&t; *&t;&t;io_base&t;&t;The IO port base address for the&n;&t; *&t;&t;&t;&t;TLAN device with the EEPROM to&n;&t; *&t;&t;&t;&t;use.&n;&t; *&t;&t;ee_addr&t;&t;The address of the byte in the&n;&t; *&t;&t;&t;&t;EEPROM whose contents are to be&n;&t; *&t;&t;&t;&t;retrieved.&n;&t; *&t;&t;data&t;&t;An address to a char to hold the&n;&t; *&t;&t;&t;&t;data obtained from the EEPROM.&n;&t; *&n;&t; *&t;This function reads a byte of information from an byte&n;&t; *&t;cell in the EEPROM.&n;&t; *&n;&t; **************************************************************/
DECL|function|TLan_EeReadByte
r_int
id|TLan_EeReadByte
c_func
(paren
id|u16
id|io_base
comma
id|u8
id|ee_addr
comma
id|u8
op_star
id|data
)paren
(brace
r_int
id|err
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|TLan_EeSendStart
c_func
(paren
id|io_base
)paren
suffix:semicolon
id|err
op_assign
id|TLan_EeSendByte
c_func
(paren
id|io_base
comma
l_int|0xA0
comma
id|TLAN_EEPROM_ACK
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
r_return
l_int|1
suffix:semicolon
id|err
op_assign
id|TLan_EeSendByte
c_func
(paren
id|io_base
comma
id|ee_addr
comma
id|TLAN_EEPROM_ACK
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
r_return
l_int|2
suffix:semicolon
id|TLan_EeSendStart
c_func
(paren
id|io_base
)paren
suffix:semicolon
id|err
op_assign
id|TLan_EeSendByte
c_func
(paren
id|io_base
comma
l_int|0xA1
comma
id|TLAN_EEPROM_ACK
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
r_return
l_int|3
suffix:semicolon
id|TLan_EeReceiveByte
c_func
(paren
id|io_base
comma
id|data
comma
id|TLAN_EEPROM_STOP
)paren
suffix:semicolon
id|sti
c_func
(paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* TLan_EeReadByte */
eof
