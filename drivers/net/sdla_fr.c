op_star
id|sdla_fr.c
id|WANPIPE
c_func
(paren
id|tm
)paren
id|Multiprotocol
id|WAN
id|Link
id|Driver
dot
id|Frame
id|relay
id|module
dot
op_star
op_star
id|Author
c_func
(paren
id|s
)paren
suffix:colon
id|Gene
id|Kozin
op_star
id|Jaspreet
id|Singh
template_param
op_star
op_star
id|Copyright
suffix:colon
(paren
id|c
)paren
l_int|1995
op_minus
l_int|1997
id|Sangoma
id|Technologies
id|Inc
dot
op_star
op_star
id|This
id|program
id|is
id|free
id|software
suffix:semicolon
id|you
id|can
id|redistribute
id|it
op_logical_and
op_div
op_logical_or
op_star
id|modify
id|it
id|under
id|the
id|terms
id|of
id|the
id|GNU
id|General
id|Public
id|License
op_star
id|as
id|published
id|by
id|the
id|Free
id|Software
id|Foundation
suffix:semicolon
id|either
id|version
DECL|variable|License
op_star
l_int|2
id|of
id|the
id|License
comma
op_logical_or
(paren
id|at
id|your
id|option
)paren
id|any
id|later
id|version
dot
op_star
op_eq
op_eq
op_eq
op_eq
op_eq
op_eq
op_eq
op_eq
op_eq
op_eq
op_eq
op_eq
op_eq
op_eq
op_eq
op_eq
op_eq
op_eq
op_eq
op_eq
op_eq
op_eq
op_eq
op_eq
op_eq
op_eq
op_eq
op_eq
op_eq
op_eq
op_eq
op_eq
op_eq
op_eq
op_eq
op_eq
op_eq
op_eq
op_star
id|Nov
l_int|26
comma
l_int|1997
id|Jaspreet
id|Singh
id|o
id|Improved
id|load
id|sharing
id|with
id|multiple
id|boards
op_star
id|o
id|Added
id|Cli
c_func
(paren
)paren
id|to
id|protect
id|enabling
id|of
id|interrupts
op_star
r_while
c_loop
id|polling
id|is
id|called
dot
op_star
id|Nov
l_int|24
comma
l_int|1997
id|Jaspreet
id|Singh
id|o
id|Added
id|counters
id|to
id|avoid
id|enabling
id|of
id|interrupts
op_star
id|when
id|they
id|have
id|been
id|disabled
id|by
id|another
op_star
id|interface
op_logical_or
id|routine
(paren
id|eg
dot
id|wpf_poll
)paren
dot
op_star
id|Nov
l_int|06
comma
l_int|1997
id|Jaspreet
id|Singh
id|o
id|Added
id|INTR_TEST_MODE
id|to
id|avoid
id|polling
op_star
id|routine
id|disable
id|interrupts
id|during
id|interrupt
op_star
id|testing
dot
op_star
id|Oct
l_int|20
comma
l_int|1997
id|Jaspreet
id|Singh
id|o
id|Added
id|hooks
id|in
r_for
c_loop
id|Router
id|UP
id|time
dot
op_star
id|Oct
l_int|16
comma
l_int|1997
id|Jaspreet
id|Singh
id|o
id|The
id|critical
id|flag
id|is
id|used
id|to
id|maintain
id|flow
op_star
id|control
id|by
id|avoiding
id|RACE
id|conditions
dot
id|The
op_star
id|cli
c_func
(paren
)paren
op_logical_and
id|restore_flags
c_func
(paren
)paren
id|are
id|taken
id|out
dot
op_star
id|The
id|fr_channel
id|structure
id|is
id|appended
r_for
c_loop
op_star
id|Driver
id|Statistics
dot
op_star
id|Oct
l_int|15
comma
l_int|1997
id|Farhan
id|Thawar
id|o
id|updated
id|if_send
c_func
(paren
)paren
op_logical_and
id|receive
r_for
c_loop
id|IPX
DECL|variable|Aug
op_star
id|Aug
l_int|29
comma
l_int|1997
id|Farhan
id|Thawar
id|o
id|Removed
id|most
id|of
id|the
id|cli
c_func
(paren
)paren
op_logical_and
id|sti
c_func
(paren
)paren
op_star
id|o
id|Abstracted
id|the
id|UDP
id|management
id|stuff
op_star
id|o
id|Now
id|use
id|tbusy
op_logical_and
id|critical
id|more
id|intelligently
DECL|variable|Jul
DECL|variable|T391
DECL|variable|T392
DECL|variable|N391
op_star
id|Jul
l_int|21
comma
l_int|1997
id|Jaspreet
id|Singh
id|o
id|Can
id|configure
id|T391
comma
id|T392
comma
id|N391
comma
id|N392
op_amp
id|N393
op_star
id|through
id|router.conf
dot
op_star
id|o
id|Protected
id|calls
id|to
id|sdla_peek
c_func
(paren
)paren
id|by
id|adDing
op_star
id|save_flags
c_func
(paren
)paren
comma
id|cli
c_func
(paren
)paren
op_logical_and
id|restore_flags
c_func
(paren
)paren
dot
op_star
id|o
id|Added
id|error
id|message
r_for
c_loop
id|Inactive
id|DLCIs
id|in
op_star
id|fr_event
c_func
(paren
)paren
op_logical_and
id|update_chan_state
c_func
(paren
)paren
dot
op_star
id|o
id|Fixed
id|freeing
id|up
id|of
id|buffers
r_using
id|kfree
c_func
(paren
)paren
op_star
id|when
id|packets
id|are
id|received
dot
op_star
id|Jul
l_int|07
comma
l_int|1997
id|Jaspreet
id|Singh
id|o
id|Added
id|configurable
id|TTL
r_for
c_loop
id|UDP
id|packets
op_star
id|o
id|Added
id|ability
id|to
id|discard
id|multicast
op_logical_and
op_star
id|broadcast
id|source
id|addressed
id|packets
DECL|variable|Jun
op_star
id|Jun
l_int|27
comma
l_int|1997
id|Jaspreet
id|Singh
id|o
id|Added
id|FT1
id|monitor
id|capabilities
op_star
id|New
r_case
(paren
l_int|0x44
)paren
id|statement
id|in
id|if_send
id|routine
op_star
id|Added
id|a
id|global
id|variable
id|rCount
id|to
id|keep
id|track
op_star
id|of
id|FT1
id|status
id|enabled
id|on
id|the
id|board
dot
op_star
id|May
l_int|29
comma
l_int|1997
id|Jaspreet
id|Singh
id|o
id|Fixed
id|major
id|Flow
id|Control
id|Problem
op_star
id|With
id|multiple
id|boards
id|a
id|problem
id|was
id|seen
id|where
op_star
id|the
id|second
id|board
id|always
id|stopped
id|transmitting
op_star
id|packet
id|after
id|running
r_for
c_loop
id|a
r_while
c_loop
dot
id|The
id|code
op_star
id|got
id|into
id|a
id|stage
id|where
id|the
id|interrupts
id|were
op_star
id|disabled
op_logical_and
id|dev-&gt;tbusy
id|was
id|set
id|to
l_float|1.
op_star
id|This
id|caused
id|the
id|If_send
c_func
(paren
)paren
id|routine
id|to
id|get
id|into
op_star
id|the
r_if
c_cond
id|clause
r_for
c_loop
id|it
c_func
(paren
l_int|0
comma
id|dev-&gt;tbusy
)paren
op_star
id|forever
dot
op_star
id|The
id|code
id|got
id|into
id|this
id|stage
id|due
id|to
id|an
op_star
id|interrupt
id|occuring
id|within
id|the
r_if
c_cond
id|clause
r_for
c_loop
op_star
id|set_bit
c_func
(paren
l_int|0
comma
id|dev-&gt;tbusy
)paren
dot
id|Since
id|an
id|interrupt
op_star
id|disables
id|furhter
id|transmit
id|interrupt
op_logical_and
op_star
id|makes
id|dev-&gt;tbusy
op_assign
l_int|0
comma
id|this
id|effect
id|was
id|undone
op_star
id|by
id|making
id|dev-&gt;tbusy
op_assign
l_int|1
id|in
id|the
r_if
c_cond
id|clause
dot
op_star
id|The
id|Fix
id|checks
id|to
id|see
r_if
c_cond
id|Transmit
id|interrupts
op_star
id|are
id|disabled
id|then
r_do
op_logical_neg
id|make
id|dev-&gt;tbusy
op_assign
l_int|1
op_star
id|Introduced
id|a
id|global
id|variable
suffix:colon
id|int_occur
op_logical_and
op_star
id|added
id|tx_int_enabled
id|in
id|the
id|wan_device
op_star
id|structure
dot
op_star
id|May
l_int|21
comma
l_int|1997
id|Jaspreet
id|Singh
id|o
id|Fixed
id|UDP
id|Management
r_for
c_loop
id|multiple
op_star
id|boards
dot
op_star
op_star
id|Apr
l_int|25
comma
l_int|1997
id|Farhan
id|Thawar
id|o
id|added
id|UDP
id|Management
id|stuff
op_star
id|o
id|fixed
id|bug
id|in
id|if_send
c_func
(paren
)paren
op_logical_and
id|tx_intr
c_func
(paren
)paren
id|to
op_star
id|sleep
op_logical_and
id|wakeup
id|all
id|devices
DECL|variable|Mar
op_star
id|Mar
l_int|11
comma
l_int|1997
id|Farhan
id|Thawar
id|Version
l_float|3.1
dot
l_int|1
op_star
id|o
id|fixed
(paren
op_plus
l_int|1
)paren
id|bug
id|in
id|fr508_rx_intr
c_func
(paren
)paren
op_star
id|o
id|changed
id|if_send
c_func
(paren
)paren
id|to
r_return
l_int|0
r_if
c_cond
op_star
id|wandev
dot
id|critical
c_func
(paren
)paren
id|is
l_bool|true
op_star
id|o
id|free
id|socket
id|buffer
id|in
id|if_send
c_func
(paren
)paren
r_if
c_cond
op_star
id|returning
l_int|0
op_star
id|o
id|added
id|tx_intr
c_func
(paren
)paren
id|routine
op_star
id|Jan
l_int|30
comma
l_int|1997
id|Gene
id|Kozin
id|Version
l_float|3.1
dot
l_int|0
op_star
id|o
id|implemented
id|exec
c_func
(paren
)paren
id|entry
id|point
op_star
id|o
id|fixed
id|a
id|bug
id|causing
id|driver
id|configured
id|as
op_star
id|a
id|FR
r_switch
c_cond
id|to
id|be
id|stuck
id|in
id|WAN_
op_star
id|mode
op_star
id|Jan
l_int|02
comma
l_int|1997
id|Gene
id|Kozin
id|Initial
id|version
dot
op_star
op_star
op_star
op_star
op_star
op_star
op_star
op_star
op_star
op_star
op_star
op_star
op_star
op_star
op_star
op_star
op_star
op_star
op_star
op_star
op_star
op_star
op_star
op_star
op_star
op_star
op_star
op_star
op_star
op_star
op_star
op_star
op_star
op_star
op_star
op_star
op_star
op_star
op_star
op_star
op_star
op_star
op_star
op_star
op_star
op_star
op_star
op_star
op_star
op_star
op_star
op_star
op_star
op_star
op_star
op_star
op_star
op_star
op_star
op_star
op_star
op_star
op_star
op_star
op_star
op_star
op_star
op_star
op_star
op_star
op_star
op_star
op_star
op_star
op_star
op_star
op_star
op_div
macro_line|#if&t;!defined(__KERNEL__) || !defined(MODULE)
macro_line|#error&t;This code MUST be compiled as a kernel module!
macro_line|#endif
macro_line|#include &lt;linux/config.h&gt;&t;/* OS configuration options */
macro_line|#include &lt;linux/kernel.h&gt;&t;/* printk(), and other useful stuff */
macro_line|#include &lt;linux/stddef.h&gt;&t;/* offsetof(), etc. */
macro_line|#include &lt;linux/errno.h&gt;&t;/* return codes */
macro_line|#include &lt;linux/string.h&gt;&t;/* inline memset(), etc. */
macro_line|#include &lt;linux/malloc.h&gt;&t;/* kmalloc(), kfree() */
macro_line|#include &lt;linux/init.h&gt;&t;&t;/* __initfunc */
macro_line|#include &lt;linux/wanrouter.h&gt;&t;/* WAN router definitions */
macro_line|#include &lt;linux/wanpipe.h&gt;&t;/* WANPIPE common user API definitions */
macro_line|#include &lt;linux/if_arp.h&gt;&t;/* ARPHRD_* defines */
macro_line|#include &lt;asm/byteorder.h&gt;&t;/* htons(), etc. */
macro_line|#include &lt;asm/io.h&gt;&t;&t;/* for inb(), outb(), etc. */
macro_line|#include &lt;asm/uaccess.h&gt;
macro_line|#include &lt;linux/time.h&gt;&t; &t;/* for do_gettimeofday */&t;
DECL|macro|_GNUC_
mdefine_line|#define&t;_GNUC_
macro_line|#include &lt;linux/sdla_fr.h&gt;&t;/* frame relay firmware API definitions */
multiline_comment|/****** Defines &amp; Macros ****************************************************/
DECL|macro|MAX_CMD_RETRY
mdefine_line|#define&t;MAX_CMD_RETRY&t;10&t;&t;/* max number of firmware retries */
DECL|macro|FR_HEADER_LEN
mdefine_line|#define&t;FR_HEADER_LEN&t;8&t;&t;/* max encapsulation header size */
DECL|macro|FR_CHANNEL_MTU
mdefine_line|#define&t;FR_CHANNEL_MTU&t;1500&t;&t;/* unfragmented logical channel MTU */
multiline_comment|/* Q.922 frame types */
DECL|macro|Q922_UI
mdefine_line|#define&t;Q922_UI&t;&t;0x03&t;&t;/* Unnumbered Info frame */
DECL|macro|Q922_XID
mdefine_line|#define&t;Q922_XID&t;0xAF&t;&t;/* ??? */
multiline_comment|/* DLCI configured or not */
DECL|macro|DLCI_NOT_CONFIGURED
mdefine_line|#define DLCI_NOT_CONFIGURED&t;0x00
DECL|macro|DLCI_CONFIG_PENDING
mdefine_line|#define DLCI_CONFIG_PENDING&t;0x01
DECL|macro|DLCI_CONFIGURED
mdefine_line|#define DLCI_CONFIGURED&t;&t;0x02
multiline_comment|/* CIR enabled or not */
DECL|macro|CIR_ENABLED
mdefine_line|#define CIR_ENABLED&t;0x00
DECL|macro|CIR_DISABLED
mdefine_line|#define CIR_DISABLED&t;0x01
multiline_comment|/* Interrupt mode for DLCI = 0 */
DECL|macro|BUFFER_INTR_MODE
mdefine_line|#define BUFFER_INTR_MODE&t;0x00
DECL|macro|DLCI_LIST_INTR_MODE
mdefine_line|#define DLCI_LIST_INTR_MODE&t;0x01
multiline_comment|/* Transmit Interrupt Status */
DECL|macro|DISABLED
mdefine_line|#define DISABLED &t;&t;0x00
DECL|macro|WAITING_TO_BE_ENABLED
mdefine_line|#define WAITING_TO_BE_ENABLED&t;0x01
multiline_comment|/* For handle_IPXWAN() */
DECL|macro|CVHexToAscii
mdefine_line|#define CVHexToAscii(b) (((unsigned char)(b) &gt; (unsigned char)9) ? ((unsigned char)&squot;A&squot; + ((unsigned char)(b) - (unsigned char)10)) : ((unsigned char)&squot;0&squot; + (unsigned char)(b)))
multiline_comment|/****** Data Structures *****************************************************/
multiline_comment|/* This is an extention of the &squot;struct device&squot; we create for each network&n; * interface to keep the rest of channel-specific data.&n; */
r_typedef
r_struct
id|fr_channel
(brace
r_char
id|name
(braket
id|WAN_IFNAME_SZ
op_plus
l_int|1
)braket
suffix:semicolon
multiline_comment|/* interface name, ASCIIZ */
DECL|variable|dlci_configured
r_int
id|dlci_configured
suffix:semicolon
multiline_comment|/* check whether configured or not */
DECL|variable|cir_status
r_int
id|cir_status
suffix:semicolon
multiline_comment|/* check whether CIR enabled or not */
DECL|variable|dlci
r_int
id|dlci
suffix:semicolon
multiline_comment|/* logical channel number */
DECL|variable|cir
r_int
id|cir
suffix:semicolon
multiline_comment|/* committed information rate */
DECL|variable|bc
r_int
id|bc
suffix:semicolon
multiline_comment|/* committed burst size */
DECL|variable|be
r_int
id|be
suffix:semicolon
multiline_comment|/* excess burst size */
DECL|variable|mc
r_int
id|mc
suffix:semicolon
multiline_comment|/* multicast support on or off */
DECL|variable|tx_int_status
r_int
id|tx_int_status
suffix:semicolon
multiline_comment|/* Transmit Interrupt Status */
DECL|variable|pkt_length
r_int
r_int
id|pkt_length
suffix:semicolon
multiline_comment|/* Packet Length */
DECL|variable|router_start_time
r_int
r_int
id|router_start_time
suffix:semicolon
multiline_comment|/* Router start time in seconds */
DECL|variable|tick_counter
r_int
r_int
id|tick_counter
suffix:semicolon
multiline_comment|/* counter for transmit time out */
DECL|variable|dev_pending_devtint
r_char
id|dev_pending_devtint
suffix:semicolon
multiline_comment|/* interface pending dev_tint() */
DECL|variable|state
r_char
id|state
suffix:semicolon
multiline_comment|/* channel state */
DECL|variable|dlci_int_interface
r_void
op_star
id|dlci_int_interface
suffix:semicolon
multiline_comment|/* pointer to the DLCI Interface */
DECL|variable|IB_addr
r_int
r_int
id|IB_addr
suffix:semicolon
multiline_comment|/* physical address of Interface Byte */
DECL|variable|state_tick
r_int
r_int
id|state_tick
suffix:semicolon
multiline_comment|/* time of the last state change */
DECL|variable|card
id|sdla_t
op_star
id|card
suffix:semicolon
multiline_comment|/* -&gt; owner */
DECL|variable|ifstats
r_struct
id|enet_statistics
id|ifstats
suffix:semicolon
multiline_comment|/* interface statistics */
DECL|variable|if_send_entry
r_int
r_int
id|if_send_entry
suffix:semicolon
DECL|variable|if_send_skb_null
r_int
r_int
id|if_send_skb_null
suffix:semicolon
DECL|variable|if_send_broadcast
r_int
r_int
id|if_send_broadcast
suffix:semicolon
DECL|variable|if_send_multicast
r_int
r_int
id|if_send_multicast
suffix:semicolon
DECL|variable|if_send_critical_ISR
r_int
r_int
id|if_send_critical_ISR
suffix:semicolon
DECL|variable|if_send_critical_non_ISR
r_int
r_int
id|if_send_critical_non_ISR
suffix:semicolon
DECL|variable|if_send_busy
r_int
r_int
id|if_send_busy
suffix:semicolon
DECL|variable|if_send_busy_timeout
r_int
r_int
id|if_send_busy_timeout
suffix:semicolon
DECL|variable|if_send_FPIPE_request
r_int
r_int
id|if_send_FPIPE_request
suffix:semicolon
DECL|variable|if_send_DRVSTATS_request
r_int
r_int
id|if_send_DRVSTATS_request
suffix:semicolon
DECL|variable|if_send_wan_disconnected
r_int
r_int
id|if_send_wan_disconnected
suffix:semicolon
DECL|variable|if_send_dlci_disconnected
r_int
r_int
id|if_send_dlci_disconnected
suffix:semicolon
DECL|variable|if_send_no_bfrs
r_int
r_int
id|if_send_no_bfrs
suffix:semicolon
DECL|variable|if_send_adptr_bfrs_full
r_int
r_int
id|if_send_adptr_bfrs_full
suffix:semicolon
DECL|variable|if_send_bfrs_passed_to_adptr
r_int
r_int
id|if_send_bfrs_passed_to_adptr
suffix:semicolon
DECL|variable|rx_intr_no_socket
r_int
r_int
id|rx_intr_no_socket
suffix:semicolon
DECL|variable|rx_intr_dev_not_started
r_int
r_int
id|rx_intr_dev_not_started
suffix:semicolon
DECL|variable|rx_intr_FPIPE_request
r_int
r_int
id|rx_intr_FPIPE_request
suffix:semicolon
DECL|variable|rx_intr_DRVSTATS_request
r_int
r_int
id|rx_intr_DRVSTATS_request
suffix:semicolon
DECL|variable|rx_intr_bfr_not_passed_to_stack
r_int
r_int
id|rx_intr_bfr_not_passed_to_stack
suffix:semicolon
DECL|variable|rx_intr_bfr_passed_to_stack
r_int
r_int
id|rx_intr_bfr_passed_to_stack
suffix:semicolon
DECL|variable|UDP_FPIPE_mgmt_kmalloc_err
r_int
r_int
id|UDP_FPIPE_mgmt_kmalloc_err
suffix:semicolon
DECL|variable|UDP_FPIPE_mgmt_direction_err
r_int
r_int
id|UDP_FPIPE_mgmt_direction_err
suffix:semicolon
DECL|variable|UDP_FPIPE_mgmt_adptr_type_err
r_int
r_int
id|UDP_FPIPE_mgmt_adptr_type_err
suffix:semicolon
DECL|variable|UDP_FPIPE_mgmt_adptr_cmnd_OK
r_int
r_int
id|UDP_FPIPE_mgmt_adptr_cmnd_OK
suffix:semicolon
DECL|variable|UDP_FPIPE_mgmt_adptr_cmnd_timeout
r_int
r_int
id|UDP_FPIPE_mgmt_adptr_cmnd_timeout
suffix:semicolon
DECL|variable|UDP_FPIPE_mgmt_adptr_send_passed
r_int
r_int
id|UDP_FPIPE_mgmt_adptr_send_passed
suffix:semicolon
DECL|variable|UDP_FPIPE_mgmt_adptr_send_failed
r_int
r_int
id|UDP_FPIPE_mgmt_adptr_send_failed
suffix:semicolon
DECL|variable|UDP_FPIPE_mgmt_not_passed_to_stack
r_int
r_int
id|UDP_FPIPE_mgmt_not_passed_to_stack
suffix:semicolon
DECL|variable|UDP_FPIPE_mgmt_passed_to_stack
r_int
r_int
id|UDP_FPIPE_mgmt_passed_to_stack
suffix:semicolon
DECL|variable|UDP_FPIPE_mgmt_no_socket
r_int
r_int
id|UDP_FPIPE_mgmt_no_socket
suffix:semicolon
DECL|variable|UDP_DRVSTATS_mgmt_kmalloc_err
r_int
r_int
id|UDP_DRVSTATS_mgmt_kmalloc_err
suffix:semicolon
DECL|variable|UDP_DRVSTATS_mgmt_adptr_cmnd_OK
r_int
r_int
id|UDP_DRVSTATS_mgmt_adptr_cmnd_OK
suffix:semicolon
DECL|variable|UDP_DRVSTATS_mgmt_adptr_cmnd_timeout
r_int
r_int
id|UDP_DRVSTATS_mgmt_adptr_cmnd_timeout
suffix:semicolon
DECL|variable|UDP_DRVSTATS_mgmt_adptr_send_passed
r_int
r_int
id|UDP_DRVSTATS_mgmt_adptr_send_passed
suffix:semicolon
DECL|variable|UDP_DRVSTATS_mgmt_adptr_send_failed
r_int
r_int
id|UDP_DRVSTATS_mgmt_adptr_send_failed
suffix:semicolon
DECL|variable|UDP_DRVSTATS_mgmt_not_passed_to_stack
r_int
r_int
id|UDP_DRVSTATS_mgmt_not_passed_to_stack
suffix:semicolon
DECL|variable|UDP_DRVSTATS_mgmt_passed_to_stack
r_int
r_int
id|UDP_DRVSTATS_mgmt_passed_to_stack
suffix:semicolon
DECL|variable|UDP_DRVSTATS_mgmt_no_socket
r_int
r_int
id|UDP_DRVSTATS_mgmt_no_socket
suffix:semicolon
DECL|variable|router_up_time
r_int
r_int
id|router_up_time
suffix:semicolon
)brace
id|fr_channel_t
suffix:semicolon
r_typedef
r_struct
id|dlci_status
(brace
r_int
r_int
id|dlci
id|PACKED
suffix:semicolon
r_int
r_char
id|state
id|PACKED
suffix:semicolon
)brace
id|dlci_status_t
suffix:semicolon
r_typedef
r_struct
id|dlci_IB_mapping
(brace
r_int
r_int
id|dlci
id|PACKED
suffix:semicolon
r_int
r_int
id|addr_value
id|PACKED
suffix:semicolon
)brace
id|dlci_IB_mapping_t
suffix:semicolon
multiline_comment|/* This structure is used for DLCI list Tx interrupt mode.  It is used to&n;   enable interrupt bit and set the packet length for transmission&n; */
r_typedef
r_struct
id|fr_dlci_interface
(brace
r_int
r_char
id|gen_interrupt
id|PACKED
suffix:semicolon
r_int
r_int
id|packet_length
id|PACKED
suffix:semicolon
r_int
r_char
id|reserved
id|PACKED
suffix:semicolon
)brace
id|fr_dlci_interface_t
suffix:semicolon
r_static
r_int
r_int
id|num_frames
suffix:semicolon
r_static
r_int
r_int
id|curr_trace_addr
suffix:semicolon
r_static
r_int
r_int
id|start_trace_addr
suffix:semicolon
r_static
r_int
r_int
id|available_buffer_space
suffix:semicolon
r_static
r_char
id|TracingEnabled
suffix:semicolon
multiline_comment|/* variable for keeping track of enabling/disabling FT1 monitor status */
r_static
r_int
id|rCount
op_assign
l_int|0
suffix:semicolon
r_extern
r_void
id|disable_irq
c_func
(paren
r_int
r_int
)paren
suffix:semicolon
r_extern
r_void
id|enable_irq
c_func
(paren
r_int
r_int
)paren
suffix:semicolon
multiline_comment|/* variable for keeping track of number of interrupts generated during &n; * interrupt test routine &n; */
r_static
r_int
id|Intr_test_counter
suffix:semicolon
multiline_comment|/****** Function Prototypes *************************************************/
multiline_comment|/* WAN link driver entry points. These are called by the WAN router module. */
r_static
r_int
id|update
(paren
id|wan_device_t
op_star
id|wandev
)paren
suffix:semicolon
r_static
r_int
id|new_if
(paren
id|wan_device_t
op_star
id|wandev
comma
r_struct
id|device
op_star
id|dev
comma
id|wanif_conf_t
op_star
id|conf
)paren
suffix:semicolon
r_static
r_int
id|del_if
(paren
id|wan_device_t
op_star
id|wandev
comma
r_struct
id|device
op_star
id|dev
)paren
suffix:semicolon
multiline_comment|/* WANPIPE-specific entry points */
r_static
r_int
id|wpf_exec
(paren
r_struct
id|sdla
op_star
id|card
comma
r_void
op_star
id|u_cmd
comma
r_void
op_star
id|u_data
)paren
suffix:semicolon
multiline_comment|/* Network device interface */
r_static
r_int
id|if_init
(paren
r_struct
id|device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_int
id|if_open
(paren
r_struct
id|device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_int
id|if_close
(paren
r_struct
id|device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_int
id|if_header
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|device
op_star
id|dev
comma
r_int
r_int
id|type
comma
r_void
op_star
id|daddr
comma
r_void
op_star
id|saddr
comma
r_int
id|len
)paren
suffix:semicolon
r_static
r_int
id|if_rebuild_hdr
(paren
r_struct
id|sk_buff
op_star
id|skb
)paren
suffix:semicolon
r_static
r_int
id|if_send
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_struct
id|enet_statistics
op_star
id|if_stats
(paren
r_struct
id|device
op_star
id|dev
)paren
suffix:semicolon
multiline_comment|/* Interrupt handlers */
r_static
r_void
id|fr502_isr
(paren
id|sdla_t
op_star
id|card
)paren
suffix:semicolon
r_static
r_void
id|fr508_isr
(paren
id|sdla_t
op_star
id|card
)paren
suffix:semicolon
r_static
r_void
id|fr502_rx_intr
(paren
id|sdla_t
op_star
id|card
)paren
suffix:semicolon
r_static
r_void
id|fr508_rx_intr
(paren
id|sdla_t
op_star
id|card
)paren
suffix:semicolon
r_static
r_void
id|tx_intr
(paren
id|sdla_t
op_star
id|card
)paren
suffix:semicolon
r_static
r_void
id|spur_intr
(paren
id|sdla_t
op_star
id|card
)paren
suffix:semicolon
multiline_comment|/* Background polling routines */
r_static
r_void
id|wpf_poll
(paren
id|sdla_t
op_star
id|card
)paren
suffix:semicolon
multiline_comment|/* Frame relay firmware interface functions */
r_static
r_int
id|fr_read_version
(paren
id|sdla_t
op_star
id|card
comma
r_char
op_star
id|str
)paren
suffix:semicolon
r_static
r_int
id|fr_configure
(paren
id|sdla_t
op_star
id|card
comma
id|fr_conf_t
op_star
id|conf
)paren
suffix:semicolon
r_static
r_int
id|fr_dlci_configure
(paren
id|sdla_t
op_star
id|card
comma
id|fr_dlc_conf_t
op_star
id|conf
comma
r_int
id|dlci
)paren
suffix:semicolon
r_static
r_int
id|fr_set_intr_mode
(paren
id|sdla_t
op_star
id|card
comma
r_int
id|mode
comma
r_int
id|mtu
)paren
suffix:semicolon
r_static
r_int
id|fr_comm_enable
(paren
id|sdla_t
op_star
id|card
)paren
suffix:semicolon
r_static
r_int
id|fr_comm_disable
(paren
id|sdla_t
op_star
id|card
)paren
suffix:semicolon
r_static
r_int
id|fr_get_err_stats
(paren
id|sdla_t
op_star
id|card
)paren
suffix:semicolon
r_static
r_int
id|fr_get_stats
(paren
id|sdla_t
op_star
id|card
)paren
suffix:semicolon
r_static
r_int
id|fr_add_dlci
(paren
id|sdla_t
op_star
id|card
comma
r_int
id|dlci
comma
r_int
id|num
)paren
suffix:semicolon
r_static
r_int
id|fr_activate_dlci
(paren
id|sdla_t
op_star
id|card
comma
r_int
id|dlci
comma
r_int
id|num
)paren
suffix:semicolon
r_static
r_int
id|fr_issue_isf
(paren
id|sdla_t
op_star
id|card
comma
r_int
id|isf
)paren
suffix:semicolon
r_static
r_int
id|fr502_send
(paren
id|sdla_t
op_star
id|card
comma
r_int
id|dlci
comma
r_int
id|attr
comma
r_int
id|len
comma
r_void
op_star
id|buf
)paren
suffix:semicolon
r_static
r_int
id|fr508_send
(paren
id|sdla_t
op_star
id|card
comma
r_int
id|dlci
comma
r_int
id|attr
comma
r_int
id|len
comma
r_void
op_star
id|buf
)paren
suffix:semicolon
multiline_comment|/* Firmware asynchronous event handlers */
r_static
r_int
id|fr_event
(paren
id|sdla_t
op_star
id|card
comma
r_int
id|event
comma
id|fr_mbox_t
op_star
id|mbox
)paren
suffix:semicolon
r_static
r_int
id|fr_modem_failure
(paren
id|sdla_t
op_star
id|card
comma
id|fr_mbox_t
op_star
id|mbox
)paren
suffix:semicolon
r_static
r_int
id|fr_dlci_change
(paren
id|sdla_t
op_star
id|card
comma
id|fr_mbox_t
op_star
id|mbox
)paren
suffix:semicolon
multiline_comment|/* Miscellaneous functions */
r_static
r_int
id|update_chan_state
(paren
r_struct
id|device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_void
id|set_chan_state
(paren
r_struct
id|device
op_star
id|dev
comma
r_int
id|state
)paren
suffix:semicolon
r_static
r_struct
id|device
op_star
id|find_channel
(paren
id|sdla_t
op_star
id|card
comma
r_int
id|dlci
)paren
suffix:semicolon
r_static
r_int
id|is_tx_ready
(paren
id|sdla_t
op_star
id|card
comma
id|fr_channel_t
op_star
id|chan
)paren
suffix:semicolon
r_static
r_int
r_int
id|dec_to_uint
(paren
r_int
r_char
op_star
id|str
comma
r_int
id|len
)paren
suffix:semicolon
r_static
r_int
id|reply_udp
c_func
(paren
r_int
r_char
op_star
id|data
comma
r_int
r_int
id|mbox_len
)paren
suffix:semicolon
r_static
r_int
id|intr_test
c_func
(paren
id|sdla_t
op_star
id|card
)paren
suffix:semicolon
r_static
r_void
id|init_chan_statistics
c_func
(paren
id|fr_channel_t
op_star
id|chan
)paren
suffix:semicolon
r_static
r_void
id|init_global_statistics
c_func
(paren
id|sdla_t
op_star
id|card
)paren
suffix:semicolon
r_static
r_void
id|read_DLCI_IB_mapping
c_func
(paren
id|sdla_t
op_star
id|card
comma
id|fr_channel_t
op_star
id|chan
)paren
suffix:semicolon
multiline_comment|/* Udp management functions */
r_static
r_int
id|process_udp_mgmt_pkt
c_func
(paren
r_char
id|udp_pkt_src
comma
id|sdla_t
op_star
id|card
comma
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|device
op_star
id|dev
comma
r_int
id|dlci
comma
id|fr_channel_t
op_star
id|chan
)paren
suffix:semicolon
r_static
r_int
id|process_udp_driver_call
c_func
(paren
r_char
id|udp_pkt_src
comma
id|sdla_t
op_star
id|card
comma
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|device
op_star
id|dev
comma
r_int
id|dlci
comma
id|fr_channel_t
op_star
id|chan
)paren
suffix:semicolon
r_static
r_int
id|udp_pkt_type
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
id|sdla_t
op_star
id|card
)paren
suffix:semicolon
multiline_comment|/* IPX functions */
r_static
r_void
id|switch_net_numbers
c_func
(paren
r_int
r_char
op_star
id|sendpacket
comma
r_int
r_int
id|network_number
comma
r_int
r_char
id|incoming
)paren
suffix:semicolon
r_static
r_int
id|handle_IPXWAN
c_func
(paren
r_int
r_char
op_star
id|sendpacket
comma
r_char
op_star
id|devname
comma
r_int
r_char
id|enable_IPX
comma
r_int
r_int
id|network_number
)paren
suffix:semicolon
multiline_comment|/****** Public Functions ****************************************************/
multiline_comment|/*============================================================================&n; * Frame relay protocol initialization routine.&n; *&n; * This routine is called by the main WANPIPE module during setup.  At this&n; * point adapter is completely initialized and firmware is running.&n; *  o read firmware version (to make sure it&squot;s alive)&n; *  o configure adapter&n; *  o initialize protocol-specific fields of the adapter data space.&n; *&n; * Return:&t;0&t;o.k.&n; *&t;&t;&lt; 0&t;failure.&n; */
id|__initfunc
c_func
(paren
r_int
id|wpf_init
c_func
(paren
id|sdla_t
op_star
id|card
comma
id|wandev_conf_t
op_star
id|conf
)paren
)paren
(brace
r_union
(brace
r_char
id|str
(braket
l_int|80
)braket
suffix:semicolon
id|fr_conf_t
id|cfg
suffix:semicolon
)brace
id|u
suffix:semicolon
multiline_comment|/* Verify configuration ID */
r_if
c_cond
(paren
id|conf-&gt;config_id
op_ne
id|WANCONFIG_FR
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: invalid configuration ID %u!&bslash;n&quot;
comma
id|card-&gt;devname
comma
id|conf-&gt;config_id
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
multiline_comment|/* Initialize protocol-specific fields of adapter data space */
r_switch
c_cond
(paren
id|card-&gt;hw.fwid
)paren
(brace
r_case
id|SFID_FR502
suffix:colon
id|card-&gt;mbox
op_assign
(paren
r_void
op_star
)paren
(paren
id|card-&gt;hw.dpmbase
op_plus
id|FR502_MBOX_OFFS
)paren
suffix:semicolon
id|card-&gt;rxmb
op_assign
(paren
r_void
op_star
)paren
(paren
id|card-&gt;hw.dpmbase
op_plus
id|FR502_RXMB_OFFS
)paren
suffix:semicolon
id|card-&gt;flags
op_assign
(paren
r_void
op_star
)paren
(paren
id|card-&gt;hw.dpmbase
op_plus
id|FR502_FLAG_OFFS
)paren
suffix:semicolon
id|card-&gt;isr
op_assign
op_amp
id|fr502_isr
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SFID_FR508
suffix:colon
id|card-&gt;mbox
op_assign
(paren
r_void
op_star
)paren
(paren
id|card-&gt;hw.dpmbase
op_plus
id|FR508_MBOX_OFFS
)paren
suffix:semicolon
id|card-&gt;flags
op_assign
(paren
r_void
op_star
)paren
(paren
id|card-&gt;hw.dpmbase
op_plus
id|FR508_FLAG_OFFS
)paren
suffix:semicolon
id|card-&gt;isr
op_assign
op_amp
id|fr508_isr
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
multiline_comment|/* Read firmware version.  Note that when adapter initializes, it&n;&t; * clears the mailbox, so it may appear that the first command was&n;&t; * executed successfully when in fact it was merely erased. To work&n;&t; * around this, we execute the first command twice.&n;&t; */
r_if
c_cond
(paren
id|fr_read_version
c_func
(paren
id|card
comma
l_int|NULL
)paren
op_logical_or
id|fr_read_version
c_func
(paren
id|card
comma
id|u.str
)paren
)paren
r_return
op_minus
id|EIO
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: running frame relay firmware v%s&bslash;n&quot;
comma
id|card-&gt;devname
comma
id|u.str
)paren
suffix:semicolon
multiline_comment|/* Adjust configuration */
id|conf-&gt;mtu
op_assign
id|max
c_func
(paren
id|min
c_func
(paren
id|conf-&gt;mtu
comma
l_int|4080
)paren
comma
id|FR_CHANNEL_MTU
op_plus
id|FR_HEADER_LEN
)paren
suffix:semicolon
id|conf-&gt;bps
op_assign
id|min
c_func
(paren
id|conf-&gt;bps
comma
l_int|2048000
)paren
suffix:semicolon
multiline_comment|/* Configure adapter firmware */
id|memset
c_func
(paren
op_amp
id|u.cfg
comma
l_int|0
comma
r_sizeof
(paren
id|u.cfg
)paren
)paren
suffix:semicolon
id|u.cfg.mtu
op_assign
id|conf-&gt;mtu
suffix:semicolon
id|u.cfg.t391
op_assign
l_int|10
suffix:semicolon
id|u.cfg.t392
op_assign
l_int|15
suffix:semicolon
id|u.cfg.n391
op_assign
l_int|6
suffix:semicolon
id|u.cfg.n392
op_assign
l_int|3
suffix:semicolon
id|u.cfg.n393
op_assign
l_int|4
suffix:semicolon
id|u.cfg.kbps
op_assign
id|conf-&gt;bps
op_div
l_int|1000
suffix:semicolon
id|u.cfg.cir_fwd
op_assign
l_int|16
suffix:semicolon
id|u.cfg.cir_bwd
op_assign
id|u.cfg.bc_fwd
op_assign
id|u.cfg.bc_bwd
op_assign
id|u.cfg.cir_fwd
suffix:semicolon
id|u.cfg.options
op_assign
l_int|0x0081
suffix:semicolon
multiline_comment|/* direct Rx, no CIR check */
r_switch
c_cond
(paren
id|conf-&gt;u.fr.signalling
)paren
(brace
r_case
id|WANOPT_FR_Q933
suffix:colon
id|u.cfg.options
op_or_assign
l_int|0x0200
suffix:semicolon
r_break
suffix:semicolon
r_case
id|WANOPT_FR_LMI
suffix:colon
id|u.cfg.options
op_or_assign
l_int|0x0400
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|conf-&gt;station
op_eq
id|WANOPT_CPE
)paren
(brace
id|u.cfg.options
op_or_assign
l_int|0x8000
suffix:semicolon
multiline_comment|/* auto config DLCI */
)brace
r_else
(brace
id|u.cfg.station
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* switch emulation mode */
id|card-&gt;u.f.node_dlci
op_assign
id|conf-&gt;u.fr.dlci
ques
c_cond
id|conf-&gt;u.fr.dlci
suffix:colon
l_int|16
suffix:semicolon
id|card-&gt;u.f.dlci_num
op_assign
id|min
c_func
(paren
id|max
c_func
(paren
id|conf-&gt;u.fr.dlci_num
comma
l_int|1
)paren
comma
l_int|100
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|conf-&gt;clocking
op_eq
id|WANOPT_INTERNAL
)paren
id|u.cfg.port
op_or_assign
l_int|0x0001
suffix:semicolon
r_if
c_cond
(paren
id|conf-&gt;interface
op_eq
id|WANOPT_RS232
)paren
id|u.cfg.port
op_or_assign
l_int|0x0002
suffix:semicolon
r_if
c_cond
(paren
id|conf-&gt;u.fr.t391
)paren
id|u.cfg.t391
op_assign
id|min
c_func
(paren
id|conf-&gt;u.fr.t391
comma
l_int|30
)paren
suffix:semicolon
r_if
c_cond
(paren
id|conf-&gt;u.fr.t392
)paren
id|u.cfg.t392
op_assign
id|min
c_func
(paren
id|conf-&gt;u.fr.t392
comma
l_int|30
)paren
suffix:semicolon
r_if
c_cond
(paren
id|conf-&gt;u.fr.n391
)paren
id|u.cfg.n391
op_assign
id|min
c_func
(paren
id|conf-&gt;u.fr.n391
comma
l_int|255
)paren
suffix:semicolon
r_if
c_cond
(paren
id|conf-&gt;u.fr.n392
)paren
id|u.cfg.n392
op_assign
id|min
c_func
(paren
id|conf-&gt;u.fr.n392
comma
l_int|10
)paren
suffix:semicolon
r_if
c_cond
(paren
id|conf-&gt;u.fr.n393
)paren
id|u.cfg.n393
op_assign
id|min
c_func
(paren
id|conf-&gt;u.fr.n393
comma
l_int|10
)paren
suffix:semicolon
r_if
c_cond
(paren
id|fr_configure
c_func
(paren
id|card
comma
op_amp
id|u.cfg
)paren
)paren
r_return
op_minus
id|EIO
suffix:semicolon
r_if
c_cond
(paren
id|card-&gt;hw.fwid
op_eq
id|SFID_FR508
)paren
(brace
id|fr_buf_info_t
op_star
id|buf_info
op_assign
(paren
r_void
op_star
)paren
(paren
id|card-&gt;hw.dpmbase
op_plus
id|FR508_RXBC_OFFS
)paren
suffix:semicolon
id|card-&gt;rxmb
op_assign
(paren
r_void
op_star
)paren
(paren
id|buf_info-&gt;rse_next
op_minus
id|FR_MB_VECTOR
op_plus
id|card-&gt;hw.dpmbase
)paren
suffix:semicolon
id|card-&gt;u.f.rxmb_base
op_assign
(paren
r_void
op_star
)paren
(paren
id|buf_info-&gt;rse_base
op_minus
id|FR_MB_VECTOR
op_plus
id|card-&gt;hw.dpmbase
)paren
suffix:semicolon
id|card-&gt;u.f.rxmb_last
op_assign
(paren
r_void
op_star
)paren
(paren
id|buf_info-&gt;rse_base
op_plus
(paren
id|buf_info-&gt;rse_num
op_minus
l_int|1
)paren
op_star
r_sizeof
(paren
id|fr_buf_ctl_t
)paren
op_minus
id|FR_MB_VECTOR
op_plus
id|card-&gt;hw.dpmbase
)paren
suffix:semicolon
id|card-&gt;u.f.rx_base
op_assign
id|buf_info-&gt;buf_base
suffix:semicolon
id|card-&gt;u.f.rx_top
op_assign
id|buf_info-&gt;buf_top
suffix:semicolon
)brace
id|card-&gt;wandev.mtu
op_assign
id|conf-&gt;mtu
suffix:semicolon
id|card-&gt;wandev.bps
op_assign
id|conf-&gt;bps
suffix:semicolon
id|card-&gt;wandev.interface
op_assign
id|conf-&gt;interface
suffix:semicolon
id|card-&gt;wandev.clocking
op_assign
id|conf-&gt;clocking
suffix:semicolon
id|card-&gt;wandev.station
op_assign
id|conf-&gt;station
suffix:semicolon
id|card-&gt;poll
op_assign
op_amp
id|wpf_poll
suffix:semicolon
id|card-&gt;exec
op_assign
op_amp
id|wpf_exec
suffix:semicolon
id|card-&gt;wandev.update
op_assign
op_amp
id|update
suffix:semicolon
id|card-&gt;wandev.new_if
op_assign
op_amp
id|new_if
suffix:semicolon
id|card-&gt;wandev.del_if
op_assign
op_amp
id|del_if
suffix:semicolon
id|card-&gt;wandev.state
op_assign
id|WAN_DISCONNECTED
suffix:semicolon
id|card-&gt;wandev.udp_port
op_assign
id|conf-&gt;udp_port
suffix:semicolon
id|TracingEnabled
op_assign
l_char|&squot;0&squot;
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/******* WAN Device Driver Entry Points *************************************/
multiline_comment|/*============================================================================&n; * Update device status &amp; statistics.&n; */
r_static
r_int
id|update
c_func
(paren
id|wan_device_t
op_star
id|wandev
)paren
(brace
id|sdla_t
op_star
id|card
suffix:semicolon
multiline_comment|/* sanity checks */
r_if
c_cond
(paren
(paren
id|wandev
op_eq
l_int|NULL
)paren
op_logical_or
(paren
id|wandev
op_member_access_from_pointer
r_private
op_eq
l_int|NULL
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_if
c_cond
(paren
id|wandev-&gt;state
op_eq
id|WAN_UNCONFIGURED
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
r_if
c_cond
(paren
id|test_and_set_bit
c_func
(paren
l_int|0
comma
(paren
r_void
op_star
)paren
op_amp
id|wandev-&gt;critical
)paren
)paren
r_return
op_minus
id|EAGAIN
suffix:semicolon
id|card
op_assign
id|wandev
op_member_access_from_pointer
r_private
suffix:semicolon
id|fr_get_err_stats
c_func
(paren
id|card
)paren
suffix:semicolon
id|fr_get_stats
c_func
(paren
id|card
)paren
suffix:semicolon
id|wandev-&gt;critical
op_assign
l_int|0
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*============================================================================&n; * Create new logical channel.&n; * This routine is called by the router when ROUTER_IFNEW IOCTL is being&n; * handled.&n; * o parse media- and hardware-specific configuration&n; * o make sure that a new channel can be created&n; * o allocate resources, if necessary&n; * o prepare network device structure for registaration.&n; *&n; * Return:&t;0&t;o.k.&n; *&t;&t;&lt; 0&t;failure (channel will not be created)&n; */
r_static
r_int
id|new_if
c_func
(paren
id|wan_device_t
op_star
id|wandev
comma
r_struct
id|device
op_star
id|dev
comma
id|wanif_conf_t
op_star
id|conf
)paren
(brace
id|sdla_t
op_star
id|card
op_assign
id|wandev
op_member_access_from_pointer
r_private
suffix:semicolon
id|fr_channel_t
op_star
id|chan
suffix:semicolon
r_int
id|err
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
(paren
id|conf-&gt;name
(braket
l_int|0
)braket
op_eq
l_char|&squot;&bslash;0&squot;
)paren
op_logical_or
(paren
id|strlen
c_func
(paren
id|conf-&gt;name
)paren
OG
id|WAN_IFNAME_SZ
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: invalid interface name!&bslash;n&quot;
comma
id|card-&gt;devname
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
multiline_comment|/* allocate and initialize private data */
id|chan
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
id|fr_channel_t
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|chan
op_eq
l_int|NULL
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|memset
c_func
(paren
id|chan
comma
l_int|0
comma
r_sizeof
(paren
id|fr_channel_t
)paren
)paren
suffix:semicolon
id|strcpy
c_func
(paren
id|chan-&gt;name
comma
id|conf-&gt;name
)paren
suffix:semicolon
id|chan-&gt;card
op_assign
id|card
suffix:semicolon
multiline_comment|/* verify media address */
r_if
c_cond
(paren
id|is_digit
c_func
(paren
id|conf-&gt;addr
(braket
l_int|0
)braket
)paren
)paren
(brace
r_int
id|dlci
op_assign
id|dec_to_uint
c_func
(paren
id|conf-&gt;addr
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dlci
op_logical_and
(paren
id|dlci
op_le
l_int|4095
)paren
)paren
(brace
id|chan-&gt;dlci
op_assign
id|dlci
suffix:semicolon
)brace
r_else
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: invalid DLCI %u on interface %s!&bslash;n&quot;
comma
id|wandev-&gt;name
comma
id|dlci
comma
id|chan-&gt;name
)paren
suffix:semicolon
id|err
op_assign
op_minus
id|EINVAL
suffix:semicolon
)brace
)brace
r_else
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: invalid media address on interface %s!&bslash;n&quot;
comma
id|wandev-&gt;name
comma
id|chan-&gt;name
)paren
suffix:semicolon
id|err
op_assign
op_minus
id|EINVAL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|err
)paren
(brace
id|kfree
c_func
(paren
id|chan
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
multiline_comment|/* place cir,be,bc and other channel specific information into the&n;&t; * chan structure &n;         */
r_if
c_cond
(paren
id|conf-&gt;cir
)paren
(brace
id|chan-&gt;cir
op_assign
id|max
c_func
(paren
l_int|1
comma
id|min
c_func
(paren
id|conf-&gt;cir
comma
l_int|512
)paren
)paren
suffix:semicolon
id|chan-&gt;cir_status
op_assign
id|CIR_ENABLED
suffix:semicolon
r_if
c_cond
(paren
id|conf-&gt;bc
)paren
id|chan-&gt;bc
op_assign
id|max
c_func
(paren
l_int|1
comma
id|min
c_func
(paren
id|conf-&gt;bc
comma
l_int|512
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|conf-&gt;be
)paren
id|chan-&gt;be
op_assign
id|max
c_func
(paren
l_int|0
comma
id|min
c_func
(paren
id|conf-&gt;be
comma
l_int|511
)paren
)paren
suffix:semicolon
)brace
r_else
id|chan-&gt;cir_status
op_assign
id|CIR_DISABLED
suffix:semicolon
id|chan-&gt;mc
op_assign
id|conf-&gt;mc
suffix:semicolon
id|chan-&gt;dlci_configured
op_assign
id|DLCI_NOT_CONFIGURED
suffix:semicolon
id|chan-&gt;tx_int_status
op_assign
id|DISABLED
suffix:semicolon
id|init_chan_statistics
c_func
(paren
id|chan
)paren
suffix:semicolon
multiline_comment|/* prepare network device data space for registration */
id|dev-&gt;name
op_assign
id|chan-&gt;name
suffix:semicolon
id|dev-&gt;init
op_assign
op_amp
id|if_init
suffix:semicolon
id|dev-&gt;priv
op_assign
id|chan
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*============================================================================&n; * Delete logical channel.&n; */
r_static
r_int
id|del_if
c_func
(paren
id|wan_device_t
op_star
id|wandev
comma
r_struct
id|device
op_star
id|dev
)paren
(brace
r_if
c_cond
(paren
id|dev-&gt;priv
)paren
(brace
id|kfree
c_func
(paren
id|dev-&gt;priv
)paren
suffix:semicolon
id|dev-&gt;priv
op_assign
l_int|NULL
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/****** WANPIPE-specific entry points ***************************************/
multiline_comment|/*============================================================================&n; * Execute adapter interface command.&n; */
r_static
r_int
id|wpf_exec
c_func
(paren
r_struct
id|sdla
op_star
id|card
comma
r_void
op_star
id|u_cmd
comma
r_void
op_star
id|u_data
)paren
(brace
id|fr_mbox_t
op_star
id|mbox
op_assign
id|card-&gt;mbox
suffix:semicolon
r_int
id|retry
op_assign
id|MAX_CMD_RETRY
suffix:semicolon
r_int
id|err
comma
id|len
suffix:semicolon
id|fr_cmd_t
id|cmd
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
(paren
r_void
op_star
)paren
op_amp
id|cmd
comma
id|u_cmd
comma
r_sizeof
(paren
id|cmd
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
multiline_comment|/* execute command */
r_do
(brace
id|memcpy
c_func
(paren
op_amp
id|mbox-&gt;cmd
comma
op_amp
id|cmd
comma
r_sizeof
(paren
id|cmd
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cmd.length
)paren
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
(paren
r_void
op_star
)paren
op_amp
id|mbox-&gt;data
comma
id|u_data
comma
id|cmd.length
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_if
c_cond
(paren
id|sdla_exec
c_func
(paren
id|mbox
)paren
)paren
id|err
op_assign
id|mbox-&gt;cmd.result
suffix:semicolon
r_else
r_return
op_minus
id|EIO
suffix:semicolon
)brace
r_while
c_loop
(paren
id|err
op_logical_and
id|retry
op_decrement
op_logical_and
id|fr_event
c_func
(paren
id|card
comma
id|err
comma
id|mbox
)paren
)paren
suffix:semicolon
multiline_comment|/* return result */
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
id|u_cmd
comma
(paren
r_void
op_star
)paren
op_amp
id|mbox-&gt;cmd
comma
r_sizeof
(paren
id|fr_cmd_t
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
id|len
op_assign
id|mbox-&gt;cmd.length
suffix:semicolon
r_if
c_cond
(paren
id|len
op_logical_and
id|u_data
op_logical_and
id|copy_to_user
c_func
(paren
id|u_data
comma
(paren
r_void
op_star
)paren
op_amp
id|mbox-&gt;data
comma
id|len
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/****** Network Device Interface ********************************************/
multiline_comment|/*============================================================================&n; * Initialize Linux network interface.&n; *&n; * This routine is called only once for each interface, during Linux network&n; * interface registration.  Returning anything but zero will fail interface&n; * registration.&n; */
r_static
r_int
id|if_init
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
id|fr_channel_t
op_star
id|chan
op_assign
id|dev-&gt;priv
suffix:semicolon
id|sdla_t
op_star
id|card
op_assign
id|chan-&gt;card
suffix:semicolon
id|wan_device_t
op_star
id|wandev
op_assign
op_amp
id|card-&gt;wandev
suffix:semicolon
r_int
id|i
suffix:semicolon
multiline_comment|/* Initialize device driver entry points */
id|dev-&gt;open
op_assign
op_amp
id|if_open
suffix:semicolon
id|dev-&gt;stop
op_assign
op_amp
id|if_close
suffix:semicolon
id|dev-&gt;hard_header
op_assign
op_amp
id|if_header
suffix:semicolon
id|dev-&gt;rebuild_header
op_assign
op_amp
id|if_rebuild_hdr
suffix:semicolon
id|dev-&gt;hard_start_xmit
op_assign
op_amp
id|if_send
suffix:semicolon
id|dev-&gt;get_stats
op_assign
op_amp
id|if_stats
suffix:semicolon
multiline_comment|/* Initialize media-specific parameters */
id|dev-&gt;family
op_assign
id|AF_INET
suffix:semicolon
multiline_comment|/* address family */
id|dev-&gt;type
op_assign
id|ARPHRD_DLCI
suffix:semicolon
multiline_comment|/* ARP h/w type */
id|dev-&gt;mtu
op_assign
id|FR_CHANNEL_MTU
suffix:semicolon
id|dev-&gt;hard_header_len
op_assign
id|FR_HEADER_LEN
suffix:semicolon
multiline_comment|/* media header length */
id|dev-&gt;addr_len
op_assign
l_int|2
suffix:semicolon
multiline_comment|/* hardware address length */
op_star
(paren
r_int
r_int
op_star
)paren
id|dev-&gt;dev_addr
op_assign
id|htons
c_func
(paren
id|chan-&gt;dlci
)paren
suffix:semicolon
multiline_comment|/* Initialize hardware parameters (just for reference) */
id|dev-&gt;irq
op_assign
id|wandev-&gt;irq
suffix:semicolon
id|dev-&gt;dma
op_assign
id|wandev-&gt;dma
suffix:semicolon
id|dev-&gt;base_addr
op_assign
id|wandev-&gt;ioport
suffix:semicolon
id|dev-&gt;mem_start
op_assign
id|wandev-&gt;maddr
suffix:semicolon
id|dev-&gt;mem_end
op_assign
id|wandev-&gt;maddr
op_plus
id|wandev-&gt;msize
op_minus
l_int|1
suffix:semicolon
multiline_comment|/* Set transmit buffer queue length */
id|dev-&gt;tx_queue_len
op_assign
l_int|30
suffix:semicolon
id|dev_init_buffers
c_func
(paren
id|dev
)paren
suffix:semicolon
id|set_chan_state
c_func
(paren
id|dev
comma
id|WAN_DISCONNECTED
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*============================================================================&n; * Open network interface.&n; * o if this is the first open, then enable communications and interrupts.&n; * o prevent module from unloading by incrementing use count&n; *&n; * Return 0 if O.k. or errno.&n; */
r_static
r_int
id|if_open
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
id|fr_channel_t
op_star
id|chan
op_assign
id|dev-&gt;priv
suffix:semicolon
id|sdla_t
op_star
id|card
op_assign
id|chan-&gt;card
suffix:semicolon
r_struct
id|device
op_star
id|dev2
suffix:semicolon
r_int
id|err
op_assign
l_int|0
suffix:semicolon
id|fr508_flags_t
op_star
id|flags
op_assign
id|card-&gt;flags
suffix:semicolon
r_struct
id|timeval
id|tv
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;start
)paren
r_return
op_minus
id|EBUSY
suffix:semicolon
multiline_comment|/* only one open is allowed */
r_if
c_cond
(paren
id|test_and_set_bit
c_func
(paren
l_int|0
comma
(paren
r_void
op_star
)paren
op_amp
id|card-&gt;wandev.critical
)paren
)paren
r_return
op_minus
id|EAGAIN
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|card-&gt;open_cnt
)paren
(brace
id|Intr_test_counter
op_assign
l_int|0
suffix:semicolon
id|card-&gt;intr_mode
op_assign
id|INTR_TEST_MODE
suffix:semicolon
id|err
op_assign
id|intr_test
c_func
(paren
id|card
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|err
)paren
op_logical_or
(paren
id|Intr_test_counter
op_ne
(paren
id|MAX_INTR_TEST_COUNTER
op_plus
l_int|1
)paren
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Interrupt Test Failed, Counter: %i&bslash;n&quot;
comma
id|card-&gt;devname
comma
id|Intr_test_counter
)paren
suffix:semicolon
id|err
op_assign
op_minus
id|EIO
suffix:semicolon
id|card-&gt;wandev.critical
op_assign
l_int|0
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Interrupt Test Passed, Counter: %i&bslash;n&quot;
comma
id|card-&gt;devname
comma
id|Intr_test_counter
)paren
suffix:semicolon
multiline_comment|/* The following allocates and intializes a circular&n;&t;&t; * link list of interfaces per card.&n;&t;&t; */
id|card-&gt;devs_struct
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
id|load_sharing_t
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|card-&gt;devs_struct
op_eq
l_int|NULL
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|card-&gt;dev_to_devtint_next
op_assign
id|card-&gt;devs_struct
suffix:semicolon
r_for
c_loop
(paren
id|dev2
op_assign
id|card-&gt;wandev.dev
suffix:semicolon
id|dev2
suffix:semicolon
id|dev2
op_assign
id|dev2-&gt;slave
)paren
(brace
(paren
id|card-&gt;devs_struct
)paren
op_member_access_from_pointer
id|dev_ptr
op_assign
id|dev2
suffix:semicolon
r_if
c_cond
(paren
id|dev2-&gt;slave
op_eq
l_int|NULL
)paren
(brace
(paren
id|card-&gt;devs_struct
)paren
op_member_access_from_pointer
id|next
op_assign
id|card-&gt;dev_to_devtint_next
suffix:semicolon
)brace
r_else
(brace
(paren
id|card-&gt;devs_struct
)paren
op_member_access_from_pointer
id|next
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
id|load_sharing_t
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|card-&gt;devs_struct
)paren
op_member_access_from_pointer
id|next
op_eq
l_int|NULL
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|card-&gt;devs_struct
op_assign
(paren
id|card-&gt;devs_struct
)paren
op_member_access_from_pointer
id|next
suffix:semicolon
)brace
)brace
id|card-&gt;devs_struct
op_assign
id|card-&gt;dev_to_devtint_next
suffix:semicolon
id|card-&gt;intr_mode
op_assign
id|BUFFER_INTR_MODE
suffix:semicolon
multiline_comment|/* &n;&t;&t;check all the interfaces for the device to see if CIR has&n;&t; &t;been enabled for any DLCI(s). If so then use the DLCI list&n;&t;&t;Interrupt mode for fr_set_intr_mode(), otherwise use the&t;&t;&t;default global interrupt mode&n;&t;&t;*/
r_for
c_loop
(paren
id|dev2
op_assign
id|card-&gt;wandev.dev
suffix:semicolon
id|dev2
suffix:semicolon
id|dev2
op_assign
id|dev2-&gt;slave
)paren
(brace
r_if
c_cond
(paren
(paren
(paren
id|fr_channel_t
op_star
)paren
id|dev2-&gt;priv
)paren
op_member_access_from_pointer
id|cir_status
op_eq
id|CIR_ENABLED
)paren
(brace
id|card-&gt;intr_mode
op_assign
id|DLCI_LIST_INTR_MODE
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
multiline_comment|/* &n;&t;&t; *&t;If you enable comms and then set ints, you get a Tx int as you&n;&t;&t; *&t;perform the SET_INT_TRIGGERS command. So, we only set int&n;&t;&t; *&t;triggers and then adjust the interrupt mask (to disable Tx ints)&t;&t;before enabling comms. &n;&t;&t; */
r_if
c_cond
(paren
id|card-&gt;intr_mode
op_eq
id|BUFFER_INTR_MODE
)paren
(brace
r_if
c_cond
(paren
id|fr_set_intr_mode
c_func
(paren
id|card
comma
l_int|0x03
comma
id|card-&gt;wandev.mtu
)paren
)paren
(brace
id|err
op_assign
op_minus
id|EIO
suffix:semicolon
id|card-&gt;wandev.critical
op_assign
l_int|0
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Global Buffering Tx Interrupt Mode&bslash;n&quot;
comma
id|card-&gt;devname
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|card-&gt;intr_mode
op_eq
id|DLCI_LIST_INTR_MODE
)paren
(brace
r_if
c_cond
(paren
id|fr_set_intr_mode
c_func
(paren
id|card
comma
l_int|0x83
comma
id|card-&gt;wandev.mtu
)paren
)paren
(brace
id|err
op_assign
op_minus
id|EIO
suffix:semicolon
id|card-&gt;wandev.critical
op_assign
l_int|0
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: DLCI list Tx Interrupt Mode&bslash;n&quot;
comma
id|card-&gt;devname
)paren
suffix:semicolon
)brace
id|flags-&gt;imask
op_and_assign
op_complement
l_int|0x02
suffix:semicolon
r_if
c_cond
(paren
id|fr_comm_enable
c_func
(paren
id|card
)paren
)paren
(brace
id|err
op_assign
op_minus
id|EIO
suffix:semicolon
id|card-&gt;wandev.critical
op_assign
l_int|0
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
id|wanpipe_set_state
c_func
(paren
id|card
comma
id|WAN_CONNECTED
)paren
suffix:semicolon
r_if
c_cond
(paren
id|card-&gt;wandev.station
op_eq
id|WANOPT_CPE
)paren
(brace
multiline_comment|/* CPE: issue full status enquiry */
id|fr_issue_isf
c_func
(paren
id|card
comma
id|FR_ISF_FSE
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* FR switch: activate DLCI(s) */
multiline_comment|/* For Switch emulation we have to ADD and ACTIVATE&n;&t;&t;&t; * the DLCI(s) that were configured with the SET_DLCI_&n;&t;&t;&t; * CONFIGURATION command. Add and Activate will fail if&n;&t;&t;&t; * DLCI specified is not included in the list.&n;&t;&t;&t; *&n;&t;&t;&t; * Also If_open is called once for each interface. But&n;&t;&t;&t; * it does not get in here for all the interface. So&n;&t;&t; &t; * we have to pass the entire list of DLCI(s) to add &n;&t;&t;&t; * activate routines.  &n;&t;&t;&t; */
id|fr_add_dlci
c_func
(paren
id|card
comma
id|card-&gt;u.f.node_dlci
(braket
l_int|0
)braket
comma
id|card-&gt;u.f.dlci_num
)paren
suffix:semicolon
id|fr_activate_dlci
c_func
(paren
id|card
comma
id|card-&gt;u.f.node_dlci
comma
id|card-&gt;u.f.dlci_num
)paren
suffix:semicolon
)brace
)brace
id|dev-&gt;mtu
op_assign
id|min
c_func
(paren
id|dev-&gt;mtu
comma
id|card-&gt;wandev.mtu
op_minus
id|FR_HEADER_LEN
)paren
suffix:semicolon
id|dev-&gt;interrupt
op_assign
l_int|0
suffix:semicolon
id|dev-&gt;tbusy
op_assign
l_int|0
suffix:semicolon
id|dev-&gt;start
op_assign
l_int|1
suffix:semicolon
id|wanpipe_open
c_func
(paren
id|card
)paren
suffix:semicolon
id|update_chan_state
c_func
(paren
id|dev
)paren
suffix:semicolon
id|do_gettimeofday
c_func
(paren
op_amp
id|tv
)paren
suffix:semicolon
id|chan-&gt;router_start_time
op_assign
id|tv.tv_sec
suffix:semicolon
id|card-&gt;wandev.critical
op_assign
l_int|0
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
multiline_comment|/*============================================================================&n; * Close network interface.&n; * o if this is the last open, then disable communications and interrupts.&n; * o reset flags.&n; */
r_static
r_int
id|if_close
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
id|fr_channel_t
op_star
id|chan
op_assign
id|dev-&gt;priv
suffix:semicolon
id|sdla_t
op_star
id|card
op_assign
id|chan-&gt;card
suffix:semicolon
r_if
c_cond
(paren
id|test_and_set_bit
c_func
(paren
l_int|0
comma
(paren
r_void
op_star
)paren
op_amp
id|card-&gt;wandev.critical
)paren
)paren
r_return
op_minus
id|EAGAIN
suffix:semicolon
suffix:semicolon
id|dev-&gt;start
op_assign
l_int|0
suffix:semicolon
id|wanpipe_close
c_func
(paren
id|card
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|card-&gt;open_cnt
)paren
(brace
id|wanpipe_set_state
c_func
(paren
id|card
comma
id|WAN_DISCONNECTED
)paren
suffix:semicolon
id|fr_set_intr_mode
c_func
(paren
id|card
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
id|fr_comm_disable
c_func
(paren
id|card
)paren
suffix:semicolon
)brace
id|card-&gt;wandev.critical
op_assign
l_int|0
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*============================================================================&n; * Build media header.&n; * o encapsulate packet according to encapsulation type.&n; *&n; * The trick here is to put packet type (Ethertype) into &squot;protocol&squot; field of&n; * the socket buffer, so that we don&squot;t forget it.  If encapsulation fails,&n; * set skb-&gt;protocol to 0 and discard packet later.&n; *&n; * Return:&t;media header length.&n; */
r_static
r_int
id|if_header
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|device
op_star
id|dev
comma
r_int
r_int
id|type
comma
r_void
op_star
id|daddr
comma
r_void
op_star
id|saddr
comma
r_int
id|len
)paren
(brace
r_int
id|hdr_len
op_assign
l_int|0
suffix:semicolon
id|skb-&gt;protocol
op_assign
id|type
suffix:semicolon
id|hdr_len
op_assign
id|wan_encapsulate
c_func
(paren
id|skb
comma
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|hdr_len
OL
l_int|0
)paren
(brace
id|hdr_len
op_assign
l_int|0
suffix:semicolon
id|skb-&gt;protocol
op_assign
l_int|0
suffix:semicolon
)brace
id|skb_push
c_func
(paren
id|skb
comma
l_int|1
)paren
suffix:semicolon
id|skb-&gt;data
(braket
l_int|0
)braket
op_assign
id|Q922_UI
suffix:semicolon
op_increment
id|hdr_len
suffix:semicolon
r_return
id|hdr_len
suffix:semicolon
)brace
multiline_comment|/*============================================================================&n; * Re-build media header.&n; *&n; * Return:&t;1&t;physical address resolved.&n; *&t;&t;0&t;physical address not resolved&n; */
r_static
r_int
id|if_rebuild_hdr
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
)paren
(brace
id|fr_channel_t
op_star
id|chan
op_assign
id|skb-&gt;dev-&gt;priv
suffix:semicolon
id|sdla_t
op_star
id|card
op_assign
id|chan-&gt;card
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: rebuild_header() called for interface %s!&bslash;n&quot;
comma
id|card-&gt;devname
comma
id|skb-&gt;dev-&gt;name
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
multiline_comment|/*============================================================================&n; * Send a packet on a network interface.&n; * o set tbusy flag (marks start of the transmission) to block a timer-based&n; *   transmit from overlapping.&n; * o check link state. If link is not up, then drop the packet.&n; * o check channel status. If it&squot;s down then initiate a call.&n; * o pass a packet to corresponding WAN device.&n; * o free socket buffer&n; *&n; * Return:&t;0&t;complete (socket buffer must be freed)&n; *&t;&t;non-0&t;packet may be re-transmitted (tbusy must be set)&n; *&n; * Notes:&n; * 1. This routine is called either by the protocol stack or by the &quot;net&n; *    bottom half&quot; (with interrupts enabled).&n; * 2. Setting tbusy flag will inhibit further transmit requests from the&n; *    protocol stack and can be used for flow control with protocol layer.&n; */
r_static
r_int
id|if_send
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|device
op_star
id|dev
)paren
(brace
id|fr_channel_t
op_star
id|chan
op_assign
id|dev-&gt;priv
suffix:semicolon
id|sdla_t
op_star
id|card
op_assign
id|chan-&gt;card
suffix:semicolon
r_int
id|retry
op_assign
l_int|0
comma
id|err
suffix:semicolon
r_struct
id|device
op_star
id|dev2
suffix:semicolon
id|fr508_flags_t
op_star
id|adptr_flags
op_assign
id|card-&gt;flags
suffix:semicolon
id|fr_dlci_interface_t
op_star
id|dlci_interface
op_assign
id|chan-&gt;dlci_int_interface
suffix:semicolon
r_int
r_int
id|host_cpu_flags
suffix:semicolon
r_int
id|send_data
op_assign
l_int|0
suffix:semicolon
op_increment
id|chan-&gt;if_send_entry
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;tbusy
)paren
(brace
multiline_comment|/* If our device stays busy for at least 5 seconds then we will&n;                 * kick start the device by making dev-&gt;tbusy = 0.  We expect&n;                 * that our device never stays busy more than 5 seconds. So this                 * is only used as a last resort.&n;                 */
op_increment
id|chan-&gt;if_send_busy
suffix:semicolon
op_increment
id|chan-&gt;ifstats.collisions
suffix:semicolon
r_if
c_cond
(paren
(paren
id|jiffies
op_minus
id|chan-&gt;tick_counter
)paren
OL
(paren
l_int|5
op_star
id|HZ
)paren
)paren
r_return
l_int|1
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Transmit timed out&bslash;n&quot;
comma
id|chan-&gt;name
)paren
suffix:semicolon
op_increment
id|chan-&gt;if_send_busy_timeout
suffix:semicolon
multiline_comment|/* unbusy all the interfaces on the card */
r_for
c_loop
(paren
id|dev2
op_assign
id|card-&gt;wandev.dev
suffix:semicolon
id|dev2
suffix:semicolon
id|dev2
op_assign
id|dev2-&gt;slave
)paren
id|dev2-&gt;tbusy
op_assign
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|test_and_set_bit
c_func
(paren
l_int|0
comma
(paren
r_void
op_star
)paren
op_amp
id|card-&gt;wandev.critical
)paren
)paren
(brace
macro_line|#ifdef _DEBUG_
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: if_send() hit critical section!&bslash;n&quot;
comma
id|card-&gt;devname
)paren
suffix:semicolon
macro_line|#endif
id|dev_kfree_skb
c_func
(paren
id|skb
comma
id|FREE_WRITE
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|disable_irq
c_func
(paren
id|card-&gt;hw.irq
)paren
suffix:semicolon
op_increment
id|card-&gt;irq_dis_if_send_count
suffix:semicolon
r_if
c_cond
(paren
id|test_and_set_bit
c_func
(paren
l_int|0
comma
(paren
r_void
op_star
)paren
op_amp
id|card-&gt;wandev.critical
)paren
)paren
(brace
r_if
c_cond
(paren
id|card-&gt;wandev.critical
op_eq
id|CRITICAL_IN_ISR
)paren
(brace
op_increment
id|chan-&gt;if_send_critical_ISR
suffix:semicolon
r_if
c_cond
(paren
id|card-&gt;intr_mode
op_eq
id|DLCI_LIST_INTR_MODE
)paren
(brace
multiline_comment|/* The enable_tx_int flag is set here so that if&n;&t;&t;&t; &t; * the critical flag is set due to an interrupt &n;&t;&t;&t;&t; * then we want to enable transmit interrupts &n;&t;&t;&t;&t; * again.&n;&t;&t;&t; &t; */
id|card-&gt;wandev.enable_tx_int
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* Setting this flag to WAITING_TO_BE_ENABLED &n;&t;&t;&t;&t; * specifies that interrupt bit has to be &n;&t;&t;&t;&t; * enabled for that particular interface. &n;&t;&t;&t;&t; * (delayed interrupt)&n;&t;&t;&t; &t; */
id|chan-&gt;tx_int_status
op_assign
id|WAITING_TO_BE_ENABLED
suffix:semicolon
multiline_comment|/* This is used for enabling dynamic calculation&n;&t;&t;&t;&t; * of CIRs relative to the packet length.&n;&t;&t;&t; &t; */
id|chan-&gt;pkt_length
op_assign
id|skb-&gt;len
suffix:semicolon
id|dev-&gt;tbusy
op_assign
l_int|1
suffix:semicolon
id|chan-&gt;tick_counter
op_assign
id|jiffies
suffix:semicolon
)brace
r_else
(brace
id|card-&gt;wandev.enable_tx_int
op_assign
l_int|1
suffix:semicolon
id|dev-&gt;tbusy
op_assign
l_int|1
suffix:semicolon
id|chan-&gt;tick_counter
op_assign
id|jiffies
suffix:semicolon
)brace
id|save_flags
c_func
(paren
id|host_cpu_flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
op_logical_neg
(paren
op_decrement
id|card-&gt;irq_dis_if_send_count
)paren
)paren
op_logical_and
(paren
op_logical_neg
id|card-&gt;irq_dis_poll_count
)paren
)paren
id|enable_irq
c_func
(paren
id|card-&gt;hw.irq
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|host_cpu_flags
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
op_increment
id|chan-&gt;if_send_critical_non_ISR
suffix:semicolon
op_increment
id|chan-&gt;ifstats.tx_dropped
suffix:semicolon
id|dev_kfree_skb
c_func
(paren
id|skb
comma
id|FREE_WRITE
)paren
suffix:semicolon
id|save_flags
c_func
(paren
id|host_cpu_flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
op_logical_neg
(paren
op_decrement
id|card-&gt;irq_dis_if_send_count
)paren
)paren
op_logical_and
(paren
op_logical_neg
id|card-&gt;irq_dis_poll_count
)paren
)paren
id|enable_irq
c_func
(paren
id|card-&gt;hw.irq
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|host_cpu_flags
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|card-&gt;wandev.critical
op_assign
l_int|0x21
suffix:semicolon
r_if
c_cond
(paren
id|card-&gt;wandev.state
op_ne
id|WAN_CONNECTED
)paren
(brace
op_increment
id|chan-&gt;if_send_wan_disconnected
suffix:semicolon
op_increment
id|chan-&gt;ifstats.tx_dropped
suffix:semicolon
op_increment
id|card-&gt;wandev.stats.tx_dropped
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|chan-&gt;state
op_ne
id|WAN_CONNECTED
)paren
(brace
op_increment
id|chan-&gt;if_send_dlci_disconnected
suffix:semicolon
id|update_chan_state
c_func
(paren
id|dev
)paren
suffix:semicolon
op_increment
id|chan-&gt;ifstats.tx_dropped
suffix:semicolon
op_increment
id|card-&gt;wandev.stats.tx_dropped
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
op_logical_neg
id|is_tx_ready
c_func
(paren
id|card
comma
id|chan
)paren
)paren
(brace
r_if
c_cond
(paren
id|card-&gt;intr_mode
op_eq
id|DLCI_LIST_INTR_MODE
)paren
(brace
id|dlci_interface-&gt;gen_interrupt
op_or_assign
l_int|0x40
suffix:semicolon
id|dlci_interface-&gt;packet_length
op_assign
id|skb-&gt;len
suffix:semicolon
)brace
id|dev-&gt;tbusy
op_assign
l_int|1
suffix:semicolon
id|chan-&gt;tick_counter
op_assign
id|jiffies
suffix:semicolon
id|adptr_flags-&gt;imask
op_or_assign
l_int|0x02
suffix:semicolon
op_increment
id|chan-&gt;if_send_no_bfrs
suffix:semicolon
id|retry
op_assign
l_int|1
suffix:semicolon
)brace
r_else
(brace
id|send_data
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* If it&squot;s an IPX packet */
r_if
c_cond
(paren
id|sendpacket
(braket
l_int|1
)braket
op_eq
l_int|0x00
op_logical_and
id|sendpacket
(braket
l_int|2
)braket
op_eq
l_int|0x80
op_logical_and
id|sendpacket
(braket
l_int|6
)braket
op_eq
l_int|0x81
op_logical_and
id|sendpacket
(braket
l_int|7
)braket
op_eq
l_int|0x37
)paren
(brace
r_if
c_cond
(paren
id|card-&gt;wandev.enable_IPX
)paren
(brace
id|switch_net_numbers
c_func
(paren
id|sendpacket
comma
id|card-&gt;wandev.network_number
comma
l_int|0
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* increment some statistic here! */
id|send_data
op_assign
l_int|0
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|send_data
)paren
(brace
id|err
op_assign
(paren
id|card-&gt;hw.fwid
op_eq
id|SFID_FR508
)paren
ques
c_cond
id|fr508_send
c_func
(paren
id|card
comma
id|chan-&gt;dlci
comma
l_int|0
comma
id|skb-&gt;len
comma
id|skb-&gt;data
)paren
suffix:colon
id|fr502_send
c_func
(paren
id|card
comma
id|chan-&gt;dlci
comma
l_int|0
comma
id|skb-&gt;len
comma
id|skb-&gt;data
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
(brace
r_if
c_cond
(paren
id|card-&gt;intr_mode
op_eq
id|DLCI_LIST_INTR_MODE
)paren
(brace
id|dlci_interface-&gt;gen_interrupt
op_or_assign
l_int|0x40
suffix:semicolon
id|dlci_interface-&gt;packet_length
op_assign
id|skb-&gt;len
suffix:semicolon
)brace
id|dev-&gt;tbusy
op_assign
l_int|1
suffix:semicolon
id|chan-&gt;tick_counter
op_assign
id|jiffies
suffix:semicolon
id|adptr_flags-&gt;imask
op_or_assign
l_int|0x02
suffix:semicolon
id|retry
op_assign
l_int|1
suffix:semicolon
op_increment
id|chan-&gt;if_send_adptr_bfrs_full
suffix:semicolon
op_increment
id|chan-&gt;ifstats.tx_errors
suffix:semicolon
op_increment
id|card-&gt;wandev.stats.tx_errors
suffix:semicolon
)brace
r_else
(brace
op_increment
id|chan-&gt;if_send_bfrs_passed_to_adptr
suffix:semicolon
op_increment
id|chan-&gt;ifstats.tx_packets
suffix:semicolon
op_increment
id|card-&gt;wandev.stats.tx_packets
suffix:semicolon
)brace
)brace
)brace
r_if
c_cond
(paren
op_logical_neg
id|retry
)paren
id|dev_kfree_skb
c_func
(paren
id|skb
comma
id|FREE_WRITE
)paren
suffix:semicolon
id|card-&gt;wandev.critical
op_assign
l_int|0
suffix:semicolon
id|save_flags
c_func
(paren
id|host_cpu_flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
op_logical_neg
(paren
op_decrement
id|card-&gt;irq_dis_if_send_count
)paren
)paren
op_logical_and
(paren
op_logical_neg
id|card-&gt;irq_dis_poll_count
)paren
)paren
id|enable_irq
c_func
(paren
id|card-&gt;hw.irq
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|host_cpu_flags
)paren
suffix:semicolon
r_return
id|retry
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;If incoming is 0 (outgoing)- if the net numbers is ours make it 0&n; *&t;if incoming is 1 - if the net number is 0 make it ours &n; *&n; */
r_static
r_void
id|switch_net_numbers
c_func
(paren
r_int
r_char
op_star
id|sendpacket
comma
r_int
r_int
id|network_number
comma
r_int
r_char
id|incoming
)paren
(brace
r_int
r_int
id|pnetwork_number
suffix:semicolon
id|pnetwork_number
op_assign
(paren
r_int
r_int
)paren
(paren
(paren
id|sendpacket
(braket
l_int|14
)braket
op_lshift
l_int|24
)paren
op_plus
(paren
id|sendpacket
(braket
l_int|15
)braket
op_lshift
l_int|16
)paren
op_plus
(paren
id|sendpacket
(braket
l_int|16
)braket
op_lshift
l_int|8
)paren
op_plus
id|sendpacket
(braket
l_int|17
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|incoming
)paren
(brace
r_if
c_cond
(paren
id|pnetwork_number
op_eq
id|network_number
)paren
(brace
id|sendpacket
(braket
l_int|14
)braket
op_assign
id|sendpacket
(braket
l_int|15
)braket
op_assign
id|sendpacket
(braket
l_int|16
)braket
op_assign
id|sendpacket
(braket
l_int|17
)braket
op_assign
l_int|0x00
suffix:semicolon
)brace
)brace
r_else
(brace
r_if
c_cond
(paren
id|pnetwork_number
op_eq
l_int|0
)paren
(brace
id|sendpacket
(braket
l_int|14
)braket
op_assign
(paren
r_int
r_char
)paren
(paren
id|network_number
op_rshift
l_int|24
)paren
suffix:semicolon
id|sendpacket
(braket
l_int|15
)braket
op_assign
(paren
r_int
r_char
)paren
(paren
(paren
id|network_number
op_amp
l_int|0x00FF0000
)paren
op_rshift
l_int|16
)paren
suffix:semicolon
id|sendpacket
(braket
l_int|16
)braket
op_assign
(paren
r_int
r_char
)paren
(paren
(paren
id|network_number
op_amp
l_int|0x0000FF00
)paren
op_rshift
l_int|8
)paren
suffix:semicolon
id|sendpacket
(braket
l_int|17
)braket
op_assign
(paren
r_int
r_char
)paren
(paren
id|network_number
op_amp
l_int|0x000000FF
)paren
suffix:semicolon
)brace
)brace
id|pnetwork_number
op_assign
(paren
r_int
r_int
)paren
(paren
(paren
id|sendpacket
(braket
l_int|26
)braket
op_lshift
l_int|24
)paren
op_plus
(paren
id|sendpacket
(braket
l_int|27
)braket
op_lshift
l_int|16
)paren
op_plus
(paren
id|sendpacket
(braket
l_int|28
)braket
op_lshift
l_int|8
)paren
op_plus
id|sendpacket
(braket
l_int|29
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|incoming
)paren
(brace
r_if
c_cond
(paren
id|pnetwork_number
op_eq
id|network_number
)paren
(brace
id|sendpacket
(braket
l_int|26
)braket
op_assign
id|sendpacket
(braket
l_int|27
)braket
op_assign
id|sendpacket
(braket
l_int|28
)braket
op_assign
id|sendpacket
(braket
l_int|29
)braket
op_assign
l_int|0x00
suffix:semicolon
)brace
)brace
r_else
(brace
r_if
c_cond
(paren
id|pnetwork_number
op_eq
l_int|0
)paren
(brace
id|sendpacket
(braket
l_int|26
)braket
op_assign
(paren
r_int
r_char
)paren
(paren
id|network_number
op_rshift
l_int|24
)paren
suffix:semicolon
id|sendpacket
(braket
l_int|27
)braket
op_assign
(paren
r_int
r_char
)paren
(paren
(paren
id|network_number
op_amp
l_int|0x00FF0000
)paren
op_rshift
l_int|16
)paren
suffix:semicolon
id|sendpacket
(braket
l_int|28
)braket
op_assign
(paren
r_int
r_char
)paren
(paren
(paren
id|network_number
op_amp
l_int|0x0000FF00
)paren
op_rshift
l_int|8
)paren
suffix:semicolon
id|sendpacket
(braket
l_int|29
)braket
op_assign
(paren
r_int
r_char
)paren
(paren
id|network_number
op_amp
l_int|0x000000FF
)paren
suffix:semicolon
)brace
)brace
)brace
multiline_comment|/* switch_net_numbers */
multiline_comment|/*============================================================================&n; * Get ethernet-style interface statistics.&n; * Return a pointer to struct enet_statistics.&n; */
r_static
r_struct
id|net_device_stats
op_star
id|if_stats
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
id|fr_channel_t
op_star
id|chan
op_assign
id|dev-&gt;priv
suffix:semicolon
r_return
op_amp
id|chan-&gt;ifstats
suffix:semicolon
)brace
multiline_comment|/****** Interrupt Handlers **************************************************/
multiline_comment|/*============================================================================&n; * S502 frame relay interrupt service routine.&n; */
r_static
r_void
id|fr502_isr
c_func
(paren
id|sdla_t
op_star
id|card
)paren
(brace
id|fr502_flags_t
op_star
id|flags
op_assign
id|card-&gt;flags
suffix:semicolon
r_switch
c_cond
(paren
id|flags-&gt;iflag
)paren
(brace
r_case
l_int|0x01
suffix:colon
multiline_comment|/* receive interrupt */
id|fr502_rx_intr
c_func
(paren
id|card
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x02
suffix:colon
multiline_comment|/* transmit interrupt */
id|flags-&gt;imask
op_and_assign
op_complement
l_int|0x02
suffix:semicolon
id|tx_intr
c_func
(paren
id|card
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|spur_intr
c_func
(paren
id|card
)paren
suffix:semicolon
)brace
id|flags-&gt;iflag
op_assign
l_int|0
suffix:semicolon
)brace
multiline_comment|/*============================================================================&n; * S508 frame relay interrupt service routine.&n; */
r_static
r_void
id|fr508_isr
c_func
(paren
id|sdla_t
op_star
id|card
)paren
(brace
id|fr508_flags_t
op_star
id|flags
op_assign
id|card-&gt;flags
suffix:semicolon
id|fr_buf_ctl_t
op_star
id|bctl
suffix:semicolon
r_char
op_star
id|ptr
op_assign
op_amp
id|flags-&gt;iflag
suffix:semicolon
r_struct
id|device
op_star
id|dev
op_assign
id|card-&gt;wandev.dev
suffix:semicolon
r_struct
id|device
op_star
id|dev2
suffix:semicolon
r_int
id|i
suffix:semicolon
r_int
r_int
id|host_cpu_flags
suffix:semicolon
r_int
id|disable_tx_intr
op_assign
l_int|1
suffix:semicolon
id|fr_channel_t
op_star
id|chan
suffix:semicolon
id|fr_dlci_interface_t
op_star
id|dlci_interface
suffix:semicolon
multiline_comment|/* This flag prevents nesting of interrupts.  See sdla_isr() routine&n;         * in sdlamain.c. &n;&t; */
id|card-&gt;in_isr
op_assign
l_int|1
suffix:semicolon
op_increment
id|card-&gt;statistics.isr_entry
suffix:semicolon
r_if
c_cond
(paren
id|test_and_set_bit
c_func
(paren
l_int|0
comma
(paren
r_void
op_star
)paren
op_amp
id|card-&gt;wandev.critical
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;fr508_isr: %s, wandev.critical set to 0x%02X, int type = 0x%02X&bslash;n&quot;
comma
id|card-&gt;devname
comma
id|card-&gt;wandev.critical
comma
id|flags-&gt;iflag
)paren
suffix:semicolon
op_increment
id|card-&gt;statistics.isr_already_critical
suffix:semicolon
id|card-&gt;in_isr
op_assign
l_int|0
suffix:semicolon
r_return
suffix:semicolon
)brace
id|int_occur
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* For all interrupts set the critical flag to CRITICAL_RX_INTR.&n;         * If the if_send routine is called with this flag set it will set&n;         * the enable transmit flag to 1. (for a delayed interrupt)&n;         */
id|card-&gt;wandev.critical
op_assign
id|CRITICAL_IN_ISR
suffix:semicolon
id|card-&gt;dlci_int_mode_unbusy
op_assign
l_int|0
suffix:semicolon
id|card-&gt;buff_int_mode_unbusy
op_assign
l_int|0
suffix:semicolon
r_switch
c_cond
(paren
id|flags-&gt;iflag
)paren
(brace
r_case
l_int|0x01
suffix:colon
multiline_comment|/* receive interrupt */
op_increment
id|card-&gt;statistics.isr_rx
suffix:semicolon
id|fr508_rx_intr
c_func
(paren
id|card
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x02
suffix:colon
multiline_comment|/* transmit interrupt */
op_increment
id|card-&gt;statistics.isr_tx
suffix:semicolon
id|bctl
op_assign
(paren
r_void
op_star
)paren
(paren
id|flags-&gt;tse_offs
op_minus
id|FR_MB_VECTOR
op_plus
id|card-&gt;hw.dpmbase
)paren
suffix:semicolon
id|bctl-&gt;flag
op_assign
l_int|0xA0
suffix:semicolon
r_if
c_cond
(paren
id|card-&gt;intr_mode
op_eq
id|DLCI_LIST_INTR_MODE
)paren
(brace
multiline_comment|/* Find the structure and make it unbusy */
id|dev
op_assign
id|find_channel
c_func
(paren
id|card
comma
id|flags-&gt;dlci
)paren
suffix:semicolon
id|dev-&gt;tbusy
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* This is used to perform devtint at the&n;&t;&t;&t;&t; * end of the isr &n;&t;&t;&t;&t; */
id|card-&gt;dlci_int_mode_unbusy
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* check to see if any other interfaces are&n;&t;&t;&t;&t; * busy. If so then do not disable the tx&n;&t;&t;&t;&t; * interrupts &n;&t;&t;&t;&t; */
r_for
c_loop
(paren
id|dev2
op_assign
id|card-&gt;wandev.dev
suffix:semicolon
id|dev2
suffix:semicolon
id|dev2
op_assign
id|dev2-&gt;slave
)paren
(brace
r_if
c_cond
(paren
id|dev2-&gt;tbusy
op_eq
l_int|1
)paren
(brace
id|disable_tx_intr
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|disable_tx_intr
)paren
id|flags-&gt;imask
op_and_assign
op_complement
l_int|0x02
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|card-&gt;intr_mode
op_eq
id|BUFFER_INTR_MODE
)paren
(brace
r_for
c_loop
(paren
id|dev2
op_assign
id|card-&gt;wandev.dev
suffix:semicolon
id|dev2
suffix:semicolon
id|dev2
op_assign
id|dev2-&gt;slave
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|dev2
op_logical_or
op_logical_neg
id|dev2-&gt;start
)paren
(brace
op_increment
id|card-&gt;statistics
dot
id|tx_intr_dev_not_started
suffix:semicolon
r_continue
suffix:semicolon
)brace
r_if
c_cond
(paren
id|dev2-&gt;tbusy
)paren
(brace
id|card-&gt;buff_int_mode_unbusy
op_assign
l_int|1
suffix:semicolon
(paren
(paren
id|fr_channel_t
op_star
)paren
id|dev2-&gt;priv
)paren
op_member_access_from_pointer
id|dev_pending_devtint
op_assign
l_int|1
suffix:semicolon
id|dev2-&gt;tbusy
op_assign
l_int|0
suffix:semicolon
)brace
r_else
(paren
(paren
id|fr_channel_t
op_star
)paren
id|dev2-&gt;priv
)paren
op_member_access_from_pointer
id|dev_pending_devtint
op_assign
l_int|0
suffix:semicolon
)brace
id|flags-&gt;imask
op_and_assign
op_complement
l_int|0x02
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
l_int|0x08
suffix:colon
id|Intr_test_counter
op_increment
suffix:semicolon
op_increment
id|card-&gt;statistics.isr_intr_test
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
op_increment
id|card-&gt;statistics.isr_spurious
suffix:semicolon
id|spur_intr
c_func
(paren
id|card
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Interrupt Type 0x%02X!&bslash;n&quot;
comma
id|card-&gt;devname
comma
id|flags-&gt;iflag
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: ID Bytes = &quot;
comma
id|card-&gt;devname
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|8
suffix:semicolon
id|i
op_increment
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;0x%02X &quot;
comma
op_star
(paren
id|ptr
op_plus
l_int|0x28
op_plus
id|i
)paren
)paren
suffix:semicolon
)brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|card-&gt;wandev.critical
op_assign
id|CRITICAL_INTR_HANDLED
suffix:semicolon
r_if
c_cond
(paren
id|card-&gt;wandev.enable_tx_int
)paren
(brace
r_if
c_cond
(paren
id|card-&gt;intr_mode
op_eq
id|DLCI_LIST_INTR_MODE
)paren
(brace
r_for
c_loop
(paren
id|dev2
op_assign
id|card-&gt;wandev.dev
suffix:semicolon
id|dev2
suffix:semicolon
id|dev2
op_assign
id|dev2-&gt;slave
)paren
(brace
id|chan
op_assign
id|dev2-&gt;priv
suffix:semicolon
r_if
c_cond
(paren
id|chan-&gt;tx_int_status
op_eq
id|WAITING_TO_BE_ENABLED
)paren
(brace
id|dlci_interface
op_assign
id|chan-&gt;dlci_int_interface
suffix:semicolon
id|dlci_interface-&gt;gen_interrupt
op_or_assign
l_int|0x40
suffix:semicolon
id|dlci_interface-&gt;packet_length
op_assign
id|chan-&gt;pkt_length
suffix:semicolon
id|chan-&gt;tx_int_status
op_assign
id|DISABLED
suffix:semicolon
)brace
)brace
)brace
id|card-&gt;wandev.enable_tx_int
op_assign
l_int|0
suffix:semicolon
id|flags-&gt;imask
op_or_assign
l_int|0x02
suffix:semicolon
op_increment
id|card-&gt;statistics.isr_enable_tx_int
suffix:semicolon
)brace
id|save_flags
c_func
(paren
id|host_cpu_flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|card-&gt;in_isr
op_assign
l_int|0
suffix:semicolon
id|card-&gt;wandev.critical
op_assign
l_int|0xD1
suffix:semicolon
id|flags-&gt;iflag
op_assign
l_int|0
suffix:semicolon
id|card-&gt;wandev.critical
op_assign
l_int|0
suffix:semicolon
id|restore_flags
c_func
(paren
id|host_cpu_flags
)paren
suffix:semicolon
multiline_comment|/*&n;&t; *&t;Device is now ready to send. The instant this is executed the If_Send&n;&t; *&t;routine is called. That is why this is put at the bottom of the ISR&n;&t; *&t;to prevent a endless loop condition caused by repeated Interrupts and&n;&t; *&t;enable_tx_int flag.&n;&t; */
r_if
c_cond
(paren
id|card-&gt;dlci_int_mode_unbusy
)paren
(brace
id|dev_tint
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|card-&gt;buff_int_mode_unbusy
)paren
(brace
r_for
c_loop
(paren
suffix:semicolon
suffix:semicolon
)paren
(brace
r_if
c_cond
(paren
(paren
(paren
id|fr_channel_t
op_star
)paren
(paren
(paren
id|card-&gt;devs_struct
)paren
op_member_access_from_pointer
id|dev_ptr
)paren
op_member_access_from_pointer
id|priv
)paren
op_member_access_from_pointer
id|dev_pending_devtint
op_eq
l_int|1
)paren
(brace
(paren
(paren
id|fr_channel_t
op_star
)paren
(paren
(paren
id|card-&gt;devs_struct
)paren
op_member_access_from_pointer
id|dev_ptr
)paren
op_member_access_from_pointer
id|priv
)paren
op_member_access_from_pointer
id|dev_pending_devtint
op_assign
l_int|0
suffix:semicolon
id|dev_tint
c_func
(paren
(paren
id|card-&gt;devs_struct
)paren
op_member_access_from_pointer
id|dev_ptr
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|card-&gt;devs_struct
)paren
op_member_access_from_pointer
id|next
op_eq
id|card-&gt;dev_to_devtint_next
)paren
r_break
suffix:semicolon
id|card-&gt;devs_struct
op_assign
(paren
id|card-&gt;devs_struct
)paren
op_member_access_from_pointer
id|next
suffix:semicolon
)brace
id|card-&gt;devs_struct
op_assign
(paren
id|card-&gt;dev_to_devtint_next
)paren
op_member_access_from_pointer
id|next
suffix:semicolon
id|card-&gt;dev_to_devtint_next
op_assign
id|card-&gt;devs_struct
suffix:semicolon
)brace
)brace
multiline_comment|/*============================================================================&n; * Receive interrupt handler.&n; */
r_static
r_void
id|fr502_rx_intr
c_func
(paren
id|sdla_t
op_star
id|card
)paren
(brace
id|fr_mbox_t
op_star
id|mbox
op_assign
id|card-&gt;rxmb
suffix:semicolon
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
r_struct
id|device
op_star
id|dev
suffix:semicolon
id|fr_channel_t
op_star
id|chan
suffix:semicolon
r_int
id|dlci
comma
id|len
suffix:semicolon
r_void
op_star
id|buf
suffix:semicolon
id|sdla_mapmem
c_func
(paren
op_amp
id|card-&gt;hw
comma
id|FR502_RX_VECTOR
)paren
suffix:semicolon
id|dlci
op_assign
id|mbox-&gt;cmd.dlci
suffix:semicolon
id|len
op_assign
id|mbox-&gt;cmd.length
suffix:semicolon
multiline_comment|/* Find network interface for this packet */
id|dev
op_assign
id|find_channel
c_func
(paren
id|card
comma
id|dlci
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dev
op_eq
l_int|NULL
)paren
(brace
multiline_comment|/* Invalid channel, discard packet */
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: receiving on orphaned DLCI %d!&bslash;n&quot;
comma
id|card-&gt;devname
comma
id|dlci
)paren
suffix:semicolon
id|sdla_mapmem
c_func
(paren
op_amp
id|card-&gt;hw
comma
id|FR_MB_VECTOR
)paren
suffix:semicolon
)brace
id|chan
op_assign
id|dev-&gt;priv
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dev-&gt;start
)paren
(brace
op_increment
id|chan-&gt;ifstats.rx_dropped
suffix:semicolon
id|sdla_mapmem
c_func
(paren
op_amp
id|card-&gt;hw
comma
id|FR_MB_VECTOR
)paren
suffix:semicolon
)brace
multiline_comment|/* Allocate socket buffer */
id|skb
op_assign
id|dev_alloc_skb
c_func
(paren
id|len
)paren
suffix:semicolon
r_if
c_cond
(paren
id|skb
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: no socket buffers available!&bslash;n&quot;
comma
id|card-&gt;devname
)paren
suffix:semicolon
op_increment
id|chan-&gt;ifstats.rx_dropped
suffix:semicolon
id|sdla_mapmem
c_func
(paren
op_amp
id|card-&gt;hw
comma
id|FR_MB_VECTOR
)paren
suffix:semicolon
)brace
multiline_comment|/* Copy data to the socket buffer */
id|buf
op_assign
id|skb_put
c_func
(paren
id|skb
comma
id|len
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|buf
comma
id|mbox-&gt;data
comma
id|len
)paren
suffix:semicolon
id|sdla_mapmem
c_func
(paren
op_amp
id|card-&gt;hw
comma
id|FR_MB_VECTOR
)paren
suffix:semicolon
multiline_comment|/* Decapsulate packet and pass it up the protocol stack */
id|skb-&gt;dev
op_assign
id|dev
suffix:semicolon
id|buf
op_assign
id|skb_pull
c_func
(paren
id|skb
comma
l_int|1
)paren
suffix:semicolon
multiline_comment|/* remove hardware header */
r_if
c_cond
(paren
op_logical_neg
id|wan_type_trans
c_func
(paren
id|skb
comma
id|dev
)paren
)paren
(brace
multiline_comment|/* can&squot;t decapsulate packet */
id|dev_kfree_skb
c_func
(paren
id|skb
comma
id|FREE_READ
)paren
suffix:semicolon
op_increment
id|chan-&gt;ifstats.rx_errors
suffix:semicolon
op_increment
id|card-&gt;wandev.stats.rx_errors
suffix:semicolon
)brace
r_else
(brace
id|netif_rx
c_func
(paren
id|skb
)paren
suffix:semicolon
op_increment
id|chan-&gt;ifstats.rx_packets
suffix:semicolon
op_increment
id|card-&gt;wandev.stats.rx_packets
suffix:semicolon
)brace
id|sdla_mapmem
c_func
(paren
op_amp
id|card-&gt;hw
comma
id|FR_MB_VECTOR
)paren
suffix:semicolon
)brace
multiline_comment|/*============================================================================&n; * Receive interrupt handler.&n; */
r_static
r_void
id|fr508_rx_intr
c_func
(paren
id|sdla_t
op_star
id|card
)paren
(brace
id|fr_buf_ctl_t
op_star
id|frbuf
op_assign
id|card-&gt;rxmb
suffix:semicolon
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
r_struct
id|device
op_star
id|dev
suffix:semicolon
id|fr_channel_t
op_star
id|chan
suffix:semicolon
r_int
id|dlci
comma
id|len
comma
id|offs
suffix:semicolon
r_void
op_star
id|buf
suffix:semicolon
r_int
id|rx_count
op_assign
l_int|0
suffix:semicolon
id|fr508_flags_t
op_star
id|flags
op_assign
id|card-&gt;flags
suffix:semicolon
r_char
op_star
id|ptr
op_assign
op_amp
id|flags-&gt;iflag
suffix:semicolon
r_int
id|i
comma
id|err
suffix:semicolon
r_if
c_cond
(paren
id|frbuf-&gt;flag
op_ne
l_int|0x01
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: corrupted Rx buffer @ 0x%X!&bslash;n&quot;
comma
id|card-&gt;devname
comma
(paren
r_int
)paren
id|frbuf
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: ID Bytes = &quot;
comma
id|card-&gt;devname
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|8
suffix:semicolon
id|i
op_increment
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;0x%02X &quot;
comma
op_star
(paren
id|ptr
op_plus
l_int|0x28
op_plus
id|i
)paren
)paren
suffix:semicolon
)brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
op_increment
id|card-&gt;statistics.rx_intr_corrupt_rx_bfr
suffix:semicolon
r_return
suffix:semicolon
)brace
r_do
(brace
id|len
op_assign
id|frbuf-&gt;length
suffix:semicolon
id|dlci
op_assign
id|frbuf-&gt;dlci
suffix:semicolon
id|offs
op_assign
id|frbuf-&gt;offset
suffix:semicolon
multiline_comment|/* Find network interface for this packet */
id|dev
op_assign
id|find_channel
c_func
(paren
id|card
comma
id|dlci
)paren
suffix:semicolon
id|chan
op_assign
id|dev-&gt;priv
suffix:semicolon
r_if
c_cond
(paren
id|dev
op_eq
l_int|NULL
)paren
(brace
multiline_comment|/* Invalid channel, discard packet */
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: receiving on orphaned DLCI %d!&bslash;n&quot;
comma
id|card-&gt;devname
comma
id|dlci
)paren
suffix:semicolon
op_increment
id|card-&gt;statistics.rx_intr_on_orphaned_DLCI
suffix:semicolon
)brace
r_else
(brace
id|skb
op_assign
id|dev_alloc_skb
c_func
(paren
id|len
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dev-&gt;start
op_logical_or
(paren
id|skb
op_eq
l_int|NULL
)paren
)paren
(brace
op_increment
id|chan-&gt;ifstats.rx_dropped
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;start
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: no socket buffers available!&bslash;n&quot;
comma
id|card-&gt;devname
)paren
suffix:semicolon
op_increment
id|chan-&gt;rx_intr_no_socket
suffix:semicolon
)brace
r_else
op_increment
id|chan-&gt;rx_intr_dev_not_started
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* Copy data to the socket buffer */
r_if
c_cond
(paren
(paren
id|offs
op_plus
id|len
)paren
OG
id|card-&gt;u.f.rx_top
op_plus
l_int|1
)paren
(brace
r_int
id|tmp
op_assign
id|card-&gt;u.f.rx_top
op_minus
id|offs
op_plus
l_int|1
suffix:semicolon
id|buf
op_assign
id|skb_put
c_func
(paren
id|skb
comma
id|tmp
)paren
suffix:semicolon
id|sdla_peek
c_func
(paren
op_amp
id|card-&gt;hw
comma
id|offs
comma
id|buf
comma
id|tmp
)paren
suffix:semicolon
id|offs
op_assign
id|card-&gt;u.f.rx_base
suffix:semicolon
id|len
op_sub_assign
id|tmp
suffix:semicolon
)brace
id|buf
op_assign
id|skb_put
c_func
(paren
id|skb
comma
id|len
)paren
suffix:semicolon
id|sdla_peek
c_func
(paren
op_amp
id|card-&gt;hw
comma
id|offs
comma
id|buf
comma
id|len
)paren
suffix:semicolon
macro_line|#ifdef CONFIG_SANGOMA_MANAGER
r_if
c_cond
(paren
id|management_check
c_func
(paren
id|skb
comma
id|card
)paren
)paren
(brace
op_increment
id|chan-&gt;rx_intr_DRVSTATS_request
suffix:semicolon
)brace
r_else
macro_line|#endif&t;&t;&t;&t;
r_if
c_cond
(paren
id|handle_IPXWAN
c_func
(paren
id|skb-&gt;data
comma
id|card-&gt;devname
comma
id|card-&gt;wandev.enable_IPX
comma
id|card-&gt;wandev.network_number
)paren
)paren
(brace
r_if
c_cond
(paren
id|card-&gt;wandev.enable_IPX
)paren
(brace
id|fr508_send
c_func
(paren
id|card
comma
id|dlci
comma
l_int|0
comma
id|skb-&gt;len
comma
id|skb-&gt;data
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* increment some statistic! */
)brace
)brace
r_else
(brace
multiline_comment|/* Decapsulate packet and pass it up the&n;&t;&t;&t;&t;   &t;   protocol stack */
id|skb-&gt;dev
op_assign
id|dev
suffix:semicolon
multiline_comment|/* remove hardware header */
id|buf
op_assign
id|skb_pull
c_func
(paren
id|skb
comma
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|wan_type_trans
c_func
(paren
id|skb
comma
id|dev
)paren
)paren
(brace
multiline_comment|/* can&squot;t decapsulate packet */
id|dev_kfree_skb
c_func
(paren
id|skb
comma
id|FREE_READ
)paren
suffix:semicolon
op_increment
id|chan-&gt;rx_intr_bfr_not_passed_to_stack
suffix:semicolon
op_increment
id|chan-&gt;ifstats.rx_errors
suffix:semicolon
op_increment
id|card-&gt;wandev.stats.rx_errors
suffix:semicolon
)brace
r_else
(brace
id|netif_rx
c_func
(paren
id|skb
)paren
suffix:semicolon
op_increment
id|chan-&gt;rx_intr_bfr_passed_to_stack
suffix:semicolon
op_increment
id|chan-&gt;ifstats.rx_packets
suffix:semicolon
op_increment
id|card-&gt;wandev.stats.rx_packets
suffix:semicolon
)brace
)brace
)brace
)brace
multiline_comment|/* Release buffer element and calculate a pointer to the next &n;&t;&t;   one */
id|frbuf-&gt;flag
op_assign
l_int|0
suffix:semicolon
id|card-&gt;rxmb
op_assign
op_increment
id|frbuf
suffix:semicolon
r_if
c_cond
(paren
(paren
r_void
op_star
)paren
id|frbuf
OG
id|card-&gt;u.f.rxmb_last
)paren
id|card-&gt;rxmb
op_assign
id|card-&gt;u.f.rxmb_base
suffix:semicolon
multiline_comment|/* The loop put in is temporary, that is why the break is&n; &t;&t; * placed here. (?????)&n;&t;&t; */
r_break
suffix:semicolon
id|frbuf
op_assign
id|card-&gt;rxmb
suffix:semicolon
)brace
r_while
c_loop
(paren
id|frbuf-&gt;flag
op_logical_and
(paren
(paren
op_increment
id|rx_count
)paren
OL
l_int|4
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/*============================================================================&n; * Transmit interrupt handler.&n; * o print a warning&n; * o &n; * If number of spurious interrupts exceeded some limit, then ???&n; */
r_static
r_void
id|tx_intr
c_func
(paren
id|sdla_t
op_star
id|card
)paren
(brace
r_struct
id|device
op_star
id|dev
op_assign
id|card-&gt;wandev.dev
suffix:semicolon
r_if
c_cond
(paren
id|card-&gt;intr_mode
op_eq
id|BUFFER_INTR_MODE
)paren
(brace
r_for
c_loop
(paren
suffix:semicolon
id|dev
suffix:semicolon
id|dev
op_assign
id|dev-&gt;slave
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|dev
op_logical_or
op_logical_neg
id|dev-&gt;start
)paren
(brace
op_increment
id|card-&gt;statistics.tx_intr_dev_not_started
suffix:semicolon
r_continue
suffix:semicolon
)brace
id|dev-&gt;tbusy
op_assign
l_int|0
suffix:semicolon
id|dev_tint
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
id|dev-&gt;tbusy
op_assign
l_int|0
suffix:semicolon
id|dev_tint
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/*============================================================================&n; * Spurious interrupt handler.&n; * o print a warning&n; * o &n; * If number of spurious interrupts exceeded some limit, then ???&n; */
r_static
r_void
id|spur_intr
c_func
(paren
id|sdla_t
op_star
id|card
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: spurious interrupt!&bslash;n&quot;
comma
id|card-&gt;devname
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;  Return 0 for non-IPXWAN packet&n;         1 for IPXWAN packet or IPX is not enabled!&n;&n;*/
r_static
r_int
id|handle_IPXWAN
c_func
(paren
r_int
r_char
op_star
id|sendpacket
comma
r_char
op_star
id|devname
comma
r_int
r_char
id|enable_IPX
comma
r_int
r_int
id|network_number
)paren
(brace
r_int
id|i
suffix:semicolon
r_if
c_cond
(paren
id|sendpacket
(braket
l_int|1
)braket
op_eq
l_int|0x00
op_logical_and
id|sendpacket
(braket
l_int|2
)braket
op_eq
l_int|0x80
op_logical_and
id|sendpacket
(braket
l_int|6
)braket
op_eq
l_int|0x81
op_logical_and
id|sendpacket
(braket
l_int|7
)braket
op_eq
l_int|0x37
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|enable_IPX
)paren
(brace
r_return
l_int|1
suffix:semicolon
)brace
)brace
r_else
(brace
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|sendpacket
(braket
l_int|24
)braket
op_eq
l_int|0x90
op_logical_and
id|sendpacket
(braket
l_int|25
)braket
op_eq
l_int|0x04
)paren
(brace
r_if
c_cond
(paren
id|sendpacket
(braket
l_int|10
)braket
op_eq
l_int|0x02
op_logical_and
id|sendpacket
(braket
l_int|42
)braket
op_eq
l_int|0x00
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Received IPXWAN Timer Request packet&bslash;n&quot;
comma
id|devname
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|49
suffix:semicolon
id|sendpacket
(braket
id|i
)braket
op_eq
l_int|0x00
suffix:semicolon
id|i
op_add_assign
l_int|5
)paren
(brace
r_if
c_cond
(paren
id|sendpacket
(braket
id|i
op_plus
l_int|4
)braket
op_ne
l_int|0x02
)paren
(brace
id|sendpacket
(braket
id|i
op_plus
l_int|1
)braket
op_assign
l_int|0
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|sendpacket
(braket
id|i
)braket
op_eq
l_int|0x04
)paren
(brace
id|i
op_add_assign
l_int|8
suffix:semicolon
)brace
r_for
c_loop
(paren
suffix:semicolon
id|sendpacket
(braket
id|i
)braket
op_eq
l_int|0x80
suffix:semicolon
)paren
(brace
id|sendpacket
(braket
id|i
op_plus
l_int|1
)braket
op_assign
l_int|0
suffix:semicolon
id|i
op_add_assign
(paren
id|sendpacket
(braket
id|i
op_plus
l_int|2
)braket
op_lshift
l_int|8
)paren
op_plus
(paren
id|sendpacket
(braket
id|i
op_plus
l_int|3
)braket
)paren
op_plus
l_int|4
suffix:semicolon
)brace
id|sendpacket
(braket
l_int|42
)braket
op_assign
l_int|0x01
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Sending IPXWAN Timer Response&bslash;n&quot;
comma
id|devname
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|sendpacket
(braket
l_int|42
)braket
op_eq
l_int|0x02
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Received IPXWAN Information Request packet&bslash;n&quot;
comma
id|devname
)paren
suffix:semicolon
id|sendpacket
(braket
l_int|42
)braket
op_assign
l_int|0x03
suffix:semicolon
id|sendpacket
(braket
l_int|59
)braket
op_assign
l_char|&squot;F&squot;
suffix:semicolon
id|sendpacket
(braket
l_int|60
)braket
op_assign
l_char|&squot;P&squot;
suffix:semicolon
id|sendpacket
(braket
l_int|61
)braket
op_assign
l_char|&squot;I&squot;
suffix:semicolon
id|sendpacket
(braket
l_int|62
)braket
op_assign
l_char|&squot;P&squot;
suffix:semicolon
id|sendpacket
(braket
l_int|63
)braket
op_assign
l_char|&squot;E&squot;
suffix:semicolon
id|sendpacket
(braket
l_int|64
)braket
op_assign
l_char|&squot;-&squot;
suffix:semicolon
id|sendpacket
(braket
l_int|65
)braket
op_assign
id|CVHexToAscii
c_func
(paren
id|network_number
op_rshift
l_int|28
)paren
suffix:semicolon
id|sendpacket
(braket
l_int|66
)braket
op_assign
id|CVHexToAscii
c_func
(paren
(paren
id|network_number
op_amp
l_int|0x0F000000
)paren
op_rshift
l_int|24
)paren
suffix:semicolon
id|sendpacket
(braket
l_int|67
)braket
op_assign
id|CVHexToAscii
c_func
(paren
(paren
id|network_number
op_amp
l_int|0x00F00000
)paren
op_rshift
l_int|20
)paren
suffix:semicolon
id|sendpacket
(braket
l_int|68
)braket
op_assign
id|CVHexToAscii
c_func
(paren
(paren
id|network_number
op_amp
l_int|0x000F0000
)paren
op_rshift
l_int|16
)paren
suffix:semicolon
id|sendpacket
(braket
l_int|69
)braket
op_assign
id|CVHexToAscii
c_func
(paren
(paren
id|network_number
op_amp
l_int|0x0000F000
)paren
op_rshift
l_int|12
)paren
suffix:semicolon
id|sendpacket
(braket
l_int|70
)braket
op_assign
id|CVHexToAscii
c_func
(paren
(paren
id|network_number
op_amp
l_int|0x00000F00
)paren
op_rshift
l_int|8
)paren
suffix:semicolon
id|sendpacket
(braket
l_int|71
)braket
op_assign
id|CVHexToAscii
c_func
(paren
(paren
id|network_number
op_amp
l_int|0x000000F0
)paren
op_rshift
l_int|4
)paren
suffix:semicolon
id|sendpacket
(braket
l_int|72
)braket
op_assign
id|CVHexToAscii
c_func
(paren
id|network_number
op_amp
l_int|0x0000000F
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|73
suffix:semicolon
id|i
OL
l_int|107
suffix:semicolon
id|i
op_add_assign
l_int|1
)paren
(brace
id|sendpacket
(braket
id|i
)braket
op_assign
l_int|0
suffix:semicolon
)brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Sending IPXWAN Information Response packet&bslash;n&quot;
comma
id|devname
)paren
suffix:semicolon
)brace
r_else
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Unknown IPXWAN packet!&bslash;n&quot;
comma
id|devname
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|sendpacket
(braket
l_int|43
)braket
op_assign
(paren
r_int
r_char
)paren
(paren
id|network_number
op_rshift
l_int|24
)paren
suffix:semicolon
id|sendpacket
(braket
l_int|44
)braket
op_assign
(paren
r_int
r_char
)paren
(paren
(paren
id|network_number
op_amp
l_int|0x00FF0000
)paren
op_rshift
l_int|16
)paren
suffix:semicolon
id|sendpacket
(braket
l_int|45
)braket
op_assign
(paren
r_int
r_char
)paren
(paren
(paren
id|network_number
op_amp
l_int|0x0000FF00
)paren
op_rshift
l_int|8
)paren
suffix:semicolon
id|sendpacket
(braket
l_int|46
)braket
op_assign
(paren
r_int
r_char
)paren
(paren
id|network_number
op_amp
l_int|0x000000FF
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
id|switch_net_numbers
c_func
(paren
id|sendpacket
comma
id|network_number
comma
l_int|1
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/****** Background Polling Routines  ****************************************/
multiline_comment|/*============================================================================&n; * Main polling routine.&n; * This routine is repeatedly called by the WANPIPE &squot;thead&squot; to allow for&n; * time-dependent housekeeping work.&n; *&n; * o fetch asynchronous network events.&n; *&n; * Notes:&n; * 1. This routine may be called on interrupt context with all interrupts&n; *    enabled. Beware!&n; */
r_static
r_void
id|wpf_poll
c_func
(paren
id|sdla_t
op_star
id|card
)paren
(brace
id|fr508_flags_t
op_star
id|flags
suffix:semicolon
r_int
r_int
id|host_cpu_flags
suffix:semicolon
op_increment
id|card-&gt;statistics.poll_entry
suffix:semicolon
r_if
c_cond
(paren
(paren
(paren
id|jiffies
op_minus
id|card-&gt;state_tick
)paren
OL
id|HZ
)paren
op_logical_or
(paren
id|card-&gt;intr_mode
op_eq
id|INTR_TEST_MODE
)paren
)paren
r_return
suffix:semicolon
id|disable_irq
c_func
(paren
id|card-&gt;hw.irq
)paren
suffix:semicolon
op_increment
id|card-&gt;irq_dis_poll_count
suffix:semicolon
r_if
c_cond
(paren
id|test_and_set_bit
c_func
(paren
l_int|0
comma
(paren
r_void
op_star
)paren
op_amp
id|card-&gt;wandev.critical
)paren
)paren
(brace
op_increment
id|card-&gt;statistics.poll_already_critical
suffix:semicolon
id|save_flags
c_func
(paren
id|host_cpu_flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
op_logical_neg
id|card-&gt;irq_dis_if_send_count
)paren
op_logical_and
(paren
op_logical_neg
(paren
op_decrement
id|card-&gt;irq_dis_poll_count
)paren
)paren
)paren
id|enable_irq
c_func
(paren
id|card-&gt;hw.irq
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|host_cpu_flags
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|card-&gt;wandev.critical
op_assign
l_int|0x11
suffix:semicolon
op_increment
id|card-&gt;statistics.poll_processed
suffix:semicolon
r_if
c_cond
(paren
id|flags-&gt;event
)paren
(brace
id|fr_mbox_t
op_star
id|mbox
op_assign
id|card-&gt;mbox
suffix:semicolon
r_int
id|err
suffix:semicolon
id|memset
c_func
(paren
op_amp
id|mbox-&gt;cmd
comma
l_int|0
comma
r_sizeof
(paren
id|fr_cmd_t
)paren
)paren
suffix:semicolon
id|mbox-&gt;cmd.command
op_assign
id|FR_READ_STATUS
suffix:semicolon
id|err
op_assign
id|sdla_exec
c_func
(paren
id|mbox
)paren
ques
c_cond
id|mbox-&gt;cmd.result
suffix:colon
id|CMD_TIMEOUT
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
id|fr_event
c_func
(paren
id|card
comma
id|err
comma
id|mbox
)paren
suffix:semicolon
)brace
id|card-&gt;wandev.critical
op_assign
l_int|0
suffix:semicolon
id|save_flags
c_func
(paren
id|host_cpu_flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
op_logical_neg
id|card-&gt;irq_dis_if_send_count
)paren
op_logical_and
(paren
op_logical_neg
(paren
op_decrement
id|card-&gt;irq_dis_poll_count
)paren
)paren
)paren
id|enable_irq
c_func
(paren
id|card-&gt;hw.irq
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|host_cpu_flags
)paren
suffix:semicolon
id|card-&gt;state_tick
op_assign
id|jiffies
suffix:semicolon
)brace
multiline_comment|/****** Frame Relay Firmware-Specific Functions *****************************/
multiline_comment|/*============================================================================&n; * Read firmware code version.&n; * o fill string str with firmware version info. &n; */
r_static
r_int
id|fr_read_version
c_func
(paren
id|sdla_t
op_star
id|card
comma
r_char
op_star
id|str
)paren
(brace
id|fr_mbox_t
op_star
id|mbox
op_assign
id|card-&gt;mbox
suffix:semicolon
r_int
id|retry
op_assign
id|MAX_CMD_RETRY
suffix:semicolon
r_int
id|err
suffix:semicolon
r_do
(brace
id|memset
c_func
(paren
op_amp
id|mbox-&gt;cmd
comma
l_int|0
comma
r_sizeof
(paren
id|fr_cmd_t
)paren
)paren
suffix:semicolon
id|mbox-&gt;cmd.command
op_assign
id|FR_READ_CODE_VERSION
suffix:semicolon
id|err
op_assign
id|sdla_exec
c_func
(paren
id|mbox
)paren
ques
c_cond
id|mbox-&gt;cmd.result
suffix:colon
id|CMD_TIMEOUT
suffix:semicolon
)brace
r_while
c_loop
(paren
id|err
op_logical_and
id|retry
op_decrement
op_logical_and
id|fr_event
c_func
(paren
id|card
comma
id|err
comma
id|mbox
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|err
op_logical_and
id|str
)paren
(brace
r_int
id|len
op_assign
id|mbox-&gt;cmd.length
suffix:semicolon
id|memcpy
c_func
(paren
id|str
comma
id|mbox-&gt;data
comma
id|len
)paren
suffix:semicolon
id|str
(braket
id|len
)braket
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
)brace
r_return
id|err
suffix:semicolon
)brace
multiline_comment|/*============================================================================&n; * Set global configuration.&n; */
r_static
r_int
id|fr_configure
c_func
(paren
id|sdla_t
op_star
id|card
comma
id|fr_conf_t
op_star
id|conf
)paren
(brace
id|fr_mbox_t
op_star
id|mbox
op_assign
id|card-&gt;mbox
suffix:semicolon
r_int
id|retry
op_assign
id|MAX_CMD_RETRY
suffix:semicolon
r_int
id|dlci_num
op_assign
id|card-&gt;u.f.dlci_num
suffix:semicolon
r_int
id|err
comma
id|i
suffix:semicolon
r_do
(brace
id|memset
c_func
(paren
op_amp
id|mbox-&gt;cmd
comma
l_int|0
comma
r_sizeof
(paren
id|fr_cmd_t
)paren
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|mbox-&gt;data
comma
id|conf
comma
r_sizeof
(paren
id|fr_conf_t
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dlci_num
)paren
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|dlci_num
suffix:semicolon
op_increment
id|i
)paren
(paren
(paren
id|fr_conf_t
op_star
)paren
id|mbox-&gt;data
)paren
op_member_access_from_pointer
id|dlci
(braket
id|i
)braket
op_assign
id|card-&gt;u.f.node_dlci
(braket
id|i
)braket
suffix:semicolon
id|mbox-&gt;cmd.command
op_assign
id|FR_SET_CONFIG
suffix:semicolon
id|mbox-&gt;cmd.length
op_assign
r_sizeof
(paren
id|fr_conf_t
)paren
op_plus
id|dlci_num
op_star
r_sizeof
(paren
r_int
)paren
suffix:semicolon
id|err
op_assign
id|sdla_exec
c_func
(paren
id|mbox
)paren
ques
c_cond
id|mbox-&gt;cmd.result
suffix:colon
id|CMD_TIMEOUT
suffix:semicolon
)brace
r_while
c_loop
(paren
id|err
op_logical_and
id|retry
op_decrement
op_logical_and
id|fr_event
c_func
(paren
id|card
comma
id|err
comma
id|mbox
)paren
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
multiline_comment|/*============================================================================&n; * Set DLCI configuration.&n; */
r_static
r_int
id|fr_dlci_configure
(paren
id|sdla_t
op_star
id|card
comma
id|fr_dlc_conf_t
op_star
id|conf
comma
r_int
id|dlci
)paren
(brace
id|fr_mbox_t
op_star
id|mbox
op_assign
id|card-&gt;mbox
suffix:semicolon
r_int
id|retry
op_assign
id|MAX_CMD_RETRY
suffix:semicolon
r_int
id|err
suffix:semicolon
r_do
(brace
id|memset
c_func
(paren
op_amp
id|mbox-&gt;cmd
comma
l_int|0
comma
r_sizeof
(paren
id|fr_cmd_t
)paren
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|mbox-&gt;data
comma
id|conf
comma
r_sizeof
(paren
id|fr_dlc_conf_t
)paren
)paren
suffix:semicolon
id|mbox-&gt;cmd.dlci
op_assign
(paren
r_int
r_int
)paren
id|dlci
suffix:semicolon
id|mbox-&gt;cmd.command
op_assign
id|FR_SET_CONFIG
suffix:semicolon
id|mbox-&gt;cmd.length
op_assign
l_int|0x0E
suffix:semicolon
id|err
op_assign
id|sdla_exec
c_func
(paren
id|mbox
)paren
ques
c_cond
id|mbox-&gt;cmd.result
suffix:colon
id|CMD_TIMEOUT
suffix:semicolon
)brace
r_while
c_loop
(paren
id|err
op_logical_and
id|retry
op_decrement
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
multiline_comment|/*============================================================================&n; * Set interrupt mode.&n; */
r_static
r_int
id|fr_set_intr_mode
c_func
(paren
id|sdla_t
op_star
id|card
comma
r_int
id|mode
comma
r_int
id|mtu
)paren
(brace
id|fr_mbox_t
op_star
id|mbox
op_assign
id|card-&gt;mbox
suffix:semicolon
r_int
id|retry
op_assign
id|MAX_CMD_RETRY
suffix:semicolon
r_int
id|err
suffix:semicolon
r_do
(brace
id|memset
c_func
(paren
op_amp
id|mbox-&gt;cmd
comma
l_int|0
comma
r_sizeof
(paren
id|fr_cmd_t
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|card-&gt;hw.fwid
op_eq
id|SFID_FR502
)paren
(brace
id|fr502_intr_ctl_t
op_star
id|ictl
op_assign
(paren
r_void
op_star
)paren
id|mbox-&gt;data
suffix:semicolon
id|memset
c_func
(paren
id|ictl
comma
l_int|0
comma
r_sizeof
(paren
id|fr502_intr_ctl_t
)paren
)paren
suffix:semicolon
id|ictl-&gt;mode
op_assign
id|mode
suffix:semicolon
id|ictl-&gt;tx_len
op_assign
id|mtu
suffix:semicolon
id|mbox-&gt;cmd.length
op_assign
r_sizeof
(paren
id|fr502_intr_ctl_t
)paren
suffix:semicolon
)brace
r_else
(brace
id|fr508_intr_ctl_t
op_star
id|ictl
op_assign
(paren
r_void
op_star
)paren
id|mbox-&gt;data
suffix:semicolon
id|memset
c_func
(paren
id|ictl
comma
l_int|0
comma
r_sizeof
(paren
id|fr508_intr_ctl_t
)paren
)paren
suffix:semicolon
id|ictl-&gt;mode
op_assign
id|mode
suffix:semicolon
id|ictl-&gt;tx_len
op_assign
id|mtu
suffix:semicolon
id|ictl-&gt;irq
op_assign
id|card-&gt;hw.irq
suffix:semicolon
id|mbox-&gt;cmd.length
op_assign
r_sizeof
(paren
id|fr508_intr_ctl_t
)paren
suffix:semicolon
)brace
id|mbox-&gt;cmd.command
op_assign
id|FR_SET_INTR_MODE
suffix:semicolon
id|err
op_assign
id|sdla_exec
c_func
(paren
id|mbox
)paren
ques
c_cond
id|mbox-&gt;cmd.result
suffix:colon
id|CMD_TIMEOUT
suffix:semicolon
)brace
r_while
c_loop
(paren
id|err
op_logical_and
id|retry
op_decrement
op_logical_and
id|fr_event
c_func
(paren
id|card
comma
id|err
comma
id|mbox
)paren
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
multiline_comment|/*============================================================================&n; * Enable communications.&n; */
r_static
r_int
id|fr_comm_enable
c_func
(paren
id|sdla_t
op_star
id|card
)paren
(brace
id|fr_mbox_t
op_star
id|mbox
op_assign
id|card-&gt;mbox
suffix:semicolon
r_int
id|retry
op_assign
id|MAX_CMD_RETRY
suffix:semicolon
r_int
id|err
suffix:semicolon
r_do
(brace
id|memset
c_func
(paren
op_amp
id|mbox-&gt;cmd
comma
l_int|0
comma
r_sizeof
(paren
id|fr_cmd_t
)paren
)paren
suffix:semicolon
id|mbox-&gt;cmd.command
op_assign
id|FR_COMM_ENABLE
suffix:semicolon
id|err
op_assign
id|sdla_exec
c_func
(paren
id|mbox
)paren
ques
c_cond
id|mbox-&gt;cmd.result
suffix:colon
id|CMD_TIMEOUT
suffix:semicolon
)brace
r_while
c_loop
(paren
id|err
op_logical_and
id|retry
op_decrement
op_logical_and
id|fr_event
c_func
(paren
id|card
comma
id|err
comma
id|mbox
)paren
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
multiline_comment|/*============================================================================&n; * Disable communications. &n; */
r_static
r_int
id|fr_comm_disable
c_func
(paren
id|sdla_t
op_star
id|card
)paren
(brace
id|fr_mbox_t
op_star
id|mbox
op_assign
id|card-&gt;mbox
suffix:semicolon
r_int
id|retry
op_assign
id|MAX_CMD_RETRY
suffix:semicolon
r_int
id|err
suffix:semicolon
r_do
(brace
id|memset
c_func
(paren
op_amp
id|mbox-&gt;cmd
comma
l_int|0
comma
r_sizeof
(paren
id|fr_cmd_t
)paren
)paren
suffix:semicolon
id|mbox-&gt;cmd.command
op_assign
id|FR_COMM_DISABLE
suffix:semicolon
id|err
op_assign
id|sdla_exec
c_func
(paren
id|mbox
)paren
ques
c_cond
id|mbox-&gt;cmd.result
suffix:colon
id|CMD_TIMEOUT
suffix:semicolon
)brace
r_while
c_loop
(paren
id|err
op_logical_and
id|retry
op_decrement
op_logical_and
id|fr_event
c_func
(paren
id|card
comma
id|err
comma
id|mbox
)paren
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
multiline_comment|/*============================================================================&n; * Get communications error statistics. &n; */
r_static
r_int
id|fr_get_err_stats
c_func
(paren
id|sdla_t
op_star
id|card
)paren
(brace
id|fr_mbox_t
op_star
id|mbox
op_assign
id|card-&gt;mbox
suffix:semicolon
r_int
id|retry
op_assign
id|MAX_CMD_RETRY
suffix:semicolon
r_int
id|err
suffix:semicolon
r_do
(brace
id|memset
c_func
(paren
op_amp
id|mbox-&gt;cmd
comma
l_int|0
comma
r_sizeof
(paren
id|fr_cmd_t
)paren
)paren
suffix:semicolon
id|mbox-&gt;cmd.command
op_assign
id|FR_READ_ERROR_STATS
suffix:semicolon
id|err
op_assign
id|sdla_exec
c_func
(paren
id|mbox
)paren
ques
c_cond
id|mbox-&gt;cmd.result
suffix:colon
id|CMD_TIMEOUT
suffix:semicolon
)brace
r_while
c_loop
(paren
id|err
op_logical_and
id|retry
op_decrement
op_logical_and
id|fr_event
c_func
(paren
id|card
comma
id|err
comma
id|mbox
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|err
)paren
(brace
id|fr_comm_stat_t
op_star
id|stats
op_assign
(paren
r_void
op_star
)paren
id|mbox-&gt;data
suffix:semicolon
id|card-&gt;wandev.stats.rx_over_errors
op_assign
id|stats-&gt;rx_overruns
suffix:semicolon
id|card-&gt;wandev.stats.rx_crc_errors
op_assign
id|stats-&gt;rx_bad_crc
suffix:semicolon
id|card-&gt;wandev.stats.rx_missed_errors
op_assign
id|stats-&gt;rx_aborts
suffix:semicolon
id|card-&gt;wandev.stats.rx_length_errors
op_assign
id|stats-&gt;rx_too_long
suffix:semicolon
id|card-&gt;wandev.stats.tx_aborted_errors
op_assign
id|stats-&gt;tx_aborts
suffix:semicolon
)brace
r_return
id|err
suffix:semicolon
)brace
multiline_comment|/*============================================================================&n; * Get statistics. &n; */
r_static
r_int
id|fr_get_stats
c_func
(paren
id|sdla_t
op_star
id|card
)paren
(brace
id|fr_mbox_t
op_star
id|mbox
op_assign
id|card-&gt;mbox
suffix:semicolon
r_int
id|retry
op_assign
id|MAX_CMD_RETRY
suffix:semicolon
r_int
id|err
suffix:semicolon
r_do
(brace
id|memset
c_func
(paren
op_amp
id|mbox-&gt;cmd
comma
l_int|0
comma
r_sizeof
(paren
id|fr_cmd_t
)paren
)paren
suffix:semicolon
id|mbox-&gt;cmd.command
op_assign
id|FR_READ_STATISTICS
suffix:semicolon
id|err
op_assign
id|sdla_exec
c_func
(paren
id|mbox
)paren
ques
c_cond
id|mbox-&gt;cmd.result
suffix:colon
id|CMD_TIMEOUT
suffix:semicolon
)brace
r_while
c_loop
(paren
id|err
op_logical_and
id|retry
op_decrement
op_logical_and
id|fr_event
c_func
(paren
id|card
comma
id|err
comma
id|mbox
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|err
)paren
(brace
id|fr_link_stat_t
op_star
id|stats
op_assign
(paren
r_void
op_star
)paren
id|mbox-&gt;data
suffix:semicolon
id|card-&gt;wandev.stats.rx_frame_errors
op_assign
id|stats-&gt;rx_bad_format
suffix:semicolon
id|card-&gt;wandev.stats.rx_dropped
op_assign
id|stats-&gt;rx_dropped
op_plus
id|stats-&gt;rx_dropped2
suffix:semicolon
)brace
r_return
id|err
suffix:semicolon
)brace
multiline_comment|/*============================================================================&n; * Add DLCI(s) (Access Node only!). &n; */
r_static
r_int
id|fr_add_dlci
c_func
(paren
id|sdla_t
op_star
id|card
comma
r_int
id|dlci
comma
r_int
id|num
)paren
(brace
id|fr_mbox_t
op_star
id|mbox
op_assign
id|card-&gt;mbox
suffix:semicolon
r_int
id|retry
op_assign
id|MAX_CMD_RETRY
suffix:semicolon
r_int
id|err
comma
id|i
suffix:semicolon
r_do
(brace
r_int
r_int
op_star
id|dlci_list
op_assign
(paren
r_void
op_star
)paren
id|mbox-&gt;data
suffix:semicolon
id|memset
c_func
(paren
op_amp
id|mbox-&gt;cmd
comma
l_int|0
comma
r_sizeof
(paren
id|fr_cmd_t
)paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|num
suffix:semicolon
op_increment
id|i
)paren
id|dlci_list
(braket
id|i
)braket
op_assign
id|card-&gt;u.f.node_dlci
(braket
id|i
)braket
suffix:semicolon
id|mbox-&gt;cmd.length
op_assign
id|num
op_star
r_sizeof
(paren
r_int
)paren
suffix:semicolon
id|mbox-&gt;cmd.command
op_assign
id|FR_ADD_DLCI
suffix:semicolon
id|err
op_assign
id|sdla_exec
c_func
(paren
id|mbox
)paren
ques
c_cond
id|mbox-&gt;cmd.result
suffix:colon
id|CMD_TIMEOUT
suffix:semicolon
)brace
r_while
c_loop
(paren
id|err
op_logical_and
id|retry
op_decrement
op_logical_and
id|fr_event
c_func
(paren
id|card
comma
id|err
comma
id|mbox
)paren
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
multiline_comment|/*============================================================================&n; * Activate DLCI(s) (Access Node only!). &n; */
r_static
r_int
id|fr_activate_dlci
c_func
(paren
id|sdla_t
op_star
id|card
comma
r_int
id|dlci
comma
r_int
id|num
)paren
(brace
id|fr_mbox_t
op_star
id|mbox
op_assign
id|card-&gt;mbox
suffix:semicolon
r_int
id|retry
op_assign
id|MAX_CMD_RETRY
suffix:semicolon
r_int
id|err
comma
id|i
suffix:semicolon
r_do
(brace
r_int
r_int
op_star
id|dlci_list
op_assign
(paren
r_void
op_star
)paren
id|mbox-&gt;data
suffix:semicolon
id|memset
c_func
(paren
op_amp
id|mbox-&gt;cmd
comma
l_int|0
comma
r_sizeof
(paren
id|fr_cmd_t
)paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|num
suffix:semicolon
op_increment
id|i
)paren
id|dlci_list
(braket
id|i
)braket
op_assign
id|card-&gt;u.f.node_dlci
(braket
id|i
)braket
suffix:semicolon
id|mbox-&gt;cmd.length
op_assign
id|num
op_star
r_sizeof
(paren
r_int
)paren
suffix:semicolon
id|mbox-&gt;cmd.command
op_assign
id|FR_ACTIVATE_DLCI
suffix:semicolon
id|err
op_assign
id|sdla_exec
c_func
(paren
id|mbox
)paren
ques
c_cond
id|mbox-&gt;cmd.result
suffix:colon
id|CMD_TIMEOUT
suffix:semicolon
)brace
r_while
c_loop
(paren
id|err
op_logical_and
id|retry
op_decrement
op_logical_and
id|fr_event
c_func
(paren
id|card
comma
id|err
comma
id|mbox
)paren
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
multiline_comment|/*============================================================================&n; * Issue in-channel signalling frame. &n; */
r_static
r_int
id|fr_issue_isf
c_func
(paren
id|sdla_t
op_star
id|card
comma
r_int
id|isf
)paren
(brace
id|fr_mbox_t
op_star
id|mbox
op_assign
id|card-&gt;mbox
suffix:semicolon
r_int
id|retry
op_assign
id|MAX_CMD_RETRY
suffix:semicolon
r_int
id|err
suffix:semicolon
r_do
(brace
id|memset
c_func
(paren
op_amp
id|mbox-&gt;cmd
comma
l_int|0
comma
r_sizeof
(paren
id|fr_cmd_t
)paren
)paren
suffix:semicolon
id|mbox-&gt;data
(braket
l_int|0
)braket
op_assign
id|isf
suffix:semicolon
id|mbox-&gt;cmd.length
op_assign
l_int|1
suffix:semicolon
id|mbox-&gt;cmd.command
op_assign
id|FR_ISSUE_IS_FRAME
suffix:semicolon
id|err
op_assign
id|sdla_exec
c_func
(paren
id|mbox
)paren
ques
c_cond
id|mbox-&gt;cmd.result
suffix:colon
id|CMD_TIMEOUT
suffix:semicolon
)brace
r_while
c_loop
(paren
id|err
op_logical_and
id|retry
op_decrement
op_logical_and
id|fr_event
c_func
(paren
id|card
comma
id|err
comma
id|mbox
)paren
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
multiline_comment|/*============================================================================&n; * Send a frame (S502 version). &n; */
r_static
r_int
id|fr502_send
c_func
(paren
id|sdla_t
op_star
id|card
comma
r_int
id|dlci
comma
r_int
id|attr
comma
r_int
id|len
comma
r_void
op_star
id|buf
)paren
(brace
id|fr_mbox_t
op_star
id|mbox
op_assign
id|card-&gt;mbox
suffix:semicolon
r_int
id|retry
op_assign
id|MAX_CMD_RETRY
suffix:semicolon
r_int
id|err
suffix:semicolon
r_do
(brace
id|memset
c_func
(paren
op_amp
id|mbox-&gt;cmd
comma
l_int|0
comma
r_sizeof
(paren
id|fr_cmd_t
)paren
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|mbox-&gt;data
comma
id|buf
comma
id|len
)paren
suffix:semicolon
id|mbox-&gt;cmd.dlci
op_assign
id|dlci
suffix:semicolon
id|mbox-&gt;cmd.attr
op_assign
id|attr
suffix:semicolon
id|mbox-&gt;cmd.length
op_assign
id|len
suffix:semicolon
id|mbox-&gt;cmd.command
op_assign
id|FR_WRITE
suffix:semicolon
id|err
op_assign
id|sdla_exec
c_func
(paren
id|mbox
)paren
ques
c_cond
id|mbox-&gt;cmd.result
suffix:colon
id|CMD_TIMEOUT
suffix:semicolon
)brace
r_while
c_loop
(paren
id|err
op_logical_and
id|retry
op_decrement
op_logical_and
id|fr_event
c_func
(paren
id|card
comma
id|err
comma
id|mbox
)paren
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
multiline_comment|/*============================================================================&n; * Send a frame (S508 version). &n; */
r_static
r_int
id|fr508_send
c_func
(paren
id|sdla_t
op_star
id|card
comma
r_int
id|dlci
comma
r_int
id|attr
comma
r_int
id|len
comma
r_void
op_star
id|buf
)paren
(brace
id|fr_mbox_t
op_star
id|mbox
op_assign
id|card-&gt;mbox
suffix:semicolon
r_int
id|retry
op_assign
id|MAX_CMD_RETRY
suffix:semicolon
r_int
id|err
suffix:semicolon
r_do
(brace
id|memset
c_func
(paren
op_amp
id|mbox-&gt;cmd
comma
l_int|0
comma
r_sizeof
(paren
id|fr_cmd_t
)paren
)paren
suffix:semicolon
id|mbox-&gt;cmd.dlci
op_assign
id|dlci
suffix:semicolon
id|mbox-&gt;cmd.attr
op_assign
id|attr
suffix:semicolon
id|mbox-&gt;cmd.length
op_assign
id|len
suffix:semicolon
id|mbox-&gt;cmd.command
op_assign
id|FR_WRITE
suffix:semicolon
id|err
op_assign
id|sdla_exec
c_func
(paren
id|mbox
)paren
ques
c_cond
id|mbox-&gt;cmd.result
suffix:colon
id|CMD_TIMEOUT
suffix:semicolon
)brace
r_while
c_loop
(paren
id|err
op_logical_and
id|retry
op_decrement
op_logical_and
id|fr_event
c_func
(paren
id|card
comma
id|err
comma
id|mbox
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|err
)paren
(brace
id|fr_buf_ctl_t
op_star
id|frbuf
op_assign
(paren
r_void
op_star
)paren
(paren
op_star
(paren
r_int
r_int
op_star
)paren
id|mbox-&gt;data
op_minus
id|FR_MB_VECTOR
op_plus
id|card-&gt;hw.dpmbase
)paren
suffix:semicolon
id|sdla_poke
c_func
(paren
op_amp
id|card-&gt;hw
comma
id|frbuf-&gt;offset
comma
id|buf
comma
id|len
)paren
suffix:semicolon
id|frbuf-&gt;flag
op_assign
l_int|0x01
suffix:semicolon
)brace
r_return
id|err
suffix:semicolon
)brace
multiline_comment|/****** Firmware Asynchronous Event Handlers ********************************/
multiline_comment|/*============================================================================&n; * Main asyncronous event/error handler.&n; *&t;This routine is called whenever firmware command returns non-zero&n; *&t;return code.&n; *&n; * Return zero if previous command has to be cancelled.&n; */
r_static
r_int
id|fr_event
c_func
(paren
id|sdla_t
op_star
id|card
comma
r_int
id|event
comma
id|fr_mbox_t
op_star
id|mbox
)paren
(brace
id|fr508_flags_t
op_star
id|flags
op_assign
id|card-&gt;flags
suffix:semicolon
r_char
op_star
id|ptr
op_assign
op_amp
id|flags-&gt;iflag
suffix:semicolon
r_int
id|i
suffix:semicolon
r_switch
c_cond
(paren
id|event
)paren
(brace
r_case
id|FRRES_MODEM_FAILURE
suffix:colon
r_return
id|fr_modem_failure
c_func
(paren
id|card
comma
id|mbox
)paren
suffix:semicolon
r_case
id|FRRES_CHANNEL_DOWN
suffix:colon
id|wanpipe_set_state
c_func
(paren
id|card
comma
id|WAN_DISCONNECTED
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
r_case
id|FRRES_CHANNEL_UP
suffix:colon
id|wanpipe_set_state
c_func
(paren
id|card
comma
id|WAN_CONNECTED
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
r_case
id|FRRES_DLCI_CHANGE
suffix:colon
r_return
id|fr_dlci_change
c_func
(paren
id|card
comma
id|mbox
)paren
suffix:semicolon
r_case
id|FRRES_DLCI_MISMATCH
suffix:colon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: DLCI list mismatch!&bslash;n&quot;
comma
id|card-&gt;devname
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
r_case
id|CMD_TIMEOUT
suffix:colon
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: command 0x%02X timed out!&bslash;n&quot;
comma
id|card-&gt;devname
comma
id|mbox-&gt;cmd.command
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: ID Bytes = &quot;
comma
id|card-&gt;devname
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|8
suffix:semicolon
id|i
op_increment
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;0x%02X &quot;
comma
op_star
(paren
id|ptr
op_plus
l_int|0x28
op_plus
id|i
)paren
)paren
suffix:semicolon
)brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|FRRES_DLCI_INACTIVE
suffix:colon
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: DLCI %u is inactive!&bslash;n&quot;
comma
id|card-&gt;devname
comma
id|mbox-&gt;cmd.dlci
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|FRRES_CIR_OVERFLOW
suffix:colon
r_break
suffix:semicolon
r_case
id|FRRES_BUFFER_OVERFLOW
suffix:colon
r_break
suffix:semicolon
r_default
suffix:colon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: command 0x%02X returned 0x%02X!&bslash;n&quot;
comma
id|card-&gt;devname
comma
id|mbox-&gt;cmd.command
comma
id|event
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*============================================================================&n; * Handle modem error.&n; *&n; * Return zero if previous command has to be cancelled.&n; */
r_static
r_int
id|fr_modem_failure
c_func
(paren
id|sdla_t
op_star
id|card
comma
id|fr_mbox_t
op_star
id|mbox
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: physical link down! (modem error 0x%02X)&bslash;n&quot;
comma
id|card-&gt;devname
comma
id|mbox-&gt;data
(braket
l_int|0
)braket
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|mbox-&gt;cmd.command
)paren
(brace
r_case
id|FR_WRITE
suffix:colon
r_case
id|FR_READ
suffix:colon
r_return
l_int|0
suffix:semicolon
)brace
r_return
l_int|1
suffix:semicolon
)brace
multiline_comment|/*============================================================================&n; * Handle DLCI status change.&n; *&n; * Return zero if previous command has to be cancelled.&n; */
r_static
r_int
id|fr_dlci_change
c_func
(paren
id|sdla_t
op_star
id|card
comma
id|fr_mbox_t
op_star
id|mbox
)paren
(brace
id|dlci_status_t
op_star
id|status
op_assign
(paren
r_void
op_star
)paren
id|mbox-&gt;data
suffix:semicolon
r_int
id|cnt
op_assign
id|mbox-&gt;cmd.length
op_div
r_sizeof
(paren
id|dlci_status_t
)paren
suffix:semicolon
id|fr_dlc_conf_t
id|cfg
suffix:semicolon
id|fr_channel_t
op_star
id|chan
suffix:semicolon
r_struct
id|device
op_star
id|dev2
suffix:semicolon
r_for
c_loop
(paren
suffix:semicolon
id|cnt
suffix:semicolon
op_decrement
id|cnt
comma
op_increment
id|status
)paren
(brace
r_int
r_int
id|dlci
op_assign
id|status-&gt;dlci
suffix:semicolon
r_struct
id|device
op_star
id|dev
op_assign
id|find_channel
c_func
(paren
id|card
comma
id|dlci
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dev
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: CPE contains unconfigured DLCI= %d&bslash;n&quot;
comma
id|card-&gt;devname
comma
id|dlci
)paren
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|status-&gt;state
op_amp
l_int|0x01
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: DLCI %u has been deleted!&bslash;n&quot;
comma
id|card-&gt;devname
comma
id|dlci
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dev
op_logical_and
id|dev-&gt;start
)paren
id|set_chan_state
c_func
(paren
id|dev
comma
id|WAN_DISCONNECTED
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|status-&gt;state
op_amp
l_int|0x02
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: DLCI %u becomes active!&bslash;n&quot;
comma
id|card-&gt;devname
comma
id|dlci
)paren
suffix:semicolon
id|chan
op_assign
id|dev-&gt;priv
suffix:semicolon
multiline_comment|/* This flag is used for configuring specific &n;&t;&t;&t;&t;   DLCI(s) when they become active.&n;&t;&t;&t; &t;*/
id|chan-&gt;dlci_configured
op_assign
id|DLCI_CONFIG_PENDING
suffix:semicolon
r_if
c_cond
(paren
id|dev
op_logical_and
id|dev-&gt;start
)paren
id|set_chan_state
c_func
(paren
id|dev
comma
id|WAN_CONNECTED
)paren
suffix:semicolon
)brace
)brace
)brace
r_for
c_loop
(paren
id|dev2
op_assign
id|card-&gt;wandev.dev
suffix:semicolon
id|dev2
suffix:semicolon
id|dev2
op_assign
id|dev2-&gt;slave
)paren
(brace
id|chan
op_assign
id|dev2-&gt;priv
suffix:semicolon
r_if
c_cond
(paren
id|chan-&gt;dlci_configured
op_eq
id|DLCI_CONFIG_PENDING
)paren
(brace
id|memset
c_func
(paren
op_amp
id|cfg
comma
l_int|0
comma
r_sizeof
(paren
id|cfg
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|chan-&gt;cir_status
op_eq
id|CIR_DISABLED
)paren
(brace
id|cfg.cir_fwd
op_assign
id|cfg.cir_bwd
op_assign
l_int|16
suffix:semicolon
id|cfg.bc_fwd
op_assign
id|cfg.bc_bwd
op_assign
l_int|16
suffix:semicolon
id|cfg.conf_flags
op_assign
l_int|0x0001
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: CIR Disabled for %s&bslash;n&quot;
comma
id|card-&gt;devname
comma
id|chan-&gt;name
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|chan-&gt;cir_status
op_eq
id|CIR_ENABLED
)paren
(brace
id|cfg.cir_fwd
op_assign
id|cfg.cir_bwd
op_assign
id|chan-&gt;cir
suffix:semicolon
id|cfg.bc_fwd
op_assign
id|cfg.bc_bwd
op_assign
id|chan-&gt;bc
suffix:semicolon
id|cfg.be_fwd
op_assign
id|cfg.be_bwd
op_assign
id|chan-&gt;be
suffix:semicolon
id|cfg.conf_flags
op_assign
l_int|0x0000
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: CIR Enabled for %s&bslash;n&quot;
comma
id|card-&gt;devname
comma
id|chan-&gt;name
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|fr_dlci_configure
c_func
(paren
id|card
comma
op_amp
id|cfg
comma
id|chan-&gt;dlci
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: DLCI Configure failed for %d&bslash;n&quot;
comma
id|card-&gt;devname
comma
id|chan-&gt;dlci
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
id|chan-&gt;dlci_configured
op_assign
id|DLCI_CONFIGURED
suffix:semicolon
multiline_comment|/*&n;&t;&t;&t; *&t;Read the interface byte mapping into the channel &n;&t;&t;&t; *&t;structure.&n;&t;&t;&t; */
r_if
c_cond
(paren
id|card-&gt;intr_mode
op_eq
id|DLCI_LIST_INTR_MODE
)paren
id|read_DLCI_IB_mapping
c_func
(paren
id|card
comma
id|chan
)paren
suffix:semicolon
)brace
)brace
r_return
l_int|1
suffix:semicolon
)brace
multiline_comment|/******* Miscellaneous ******************************************************/
multiline_comment|/*============================================================================&n; * Update channel state. &n; */
r_static
r_int
id|update_chan_state
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
id|fr_channel_t
op_star
id|chan
op_assign
id|dev-&gt;priv
suffix:semicolon
id|sdla_t
op_star
id|card
op_assign
id|chan-&gt;card
suffix:semicolon
id|fr_mbox_t
op_star
id|mbox
op_assign
id|card-&gt;mbox
suffix:semicolon
r_int
id|retry
op_assign
id|MAX_CMD_RETRY
suffix:semicolon
r_int
id|err
suffix:semicolon
r_int
id|dlci_found
op_assign
l_int|0
suffix:semicolon
r_do
(brace
id|memset
c_func
(paren
op_amp
id|mbox-&gt;cmd
comma
l_int|0
comma
r_sizeof
(paren
id|fr_cmd_t
)paren
)paren
suffix:semicolon
id|mbox-&gt;cmd.command
op_assign
id|FR_LIST_ACTIVE_DLCI
suffix:semicolon
id|err
op_assign
id|sdla_exec
c_func
(paren
id|mbox
)paren
ques
c_cond
id|mbox-&gt;cmd.result
suffix:colon
id|CMD_TIMEOUT
suffix:semicolon
)brace
r_while
c_loop
(paren
id|err
op_logical_and
id|retry
op_decrement
op_logical_and
id|fr_event
c_func
(paren
id|card
comma
id|err
comma
id|mbox
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|err
)paren
(brace
r_int
r_int
op_star
id|list
op_assign
(paren
r_void
op_star
)paren
id|mbox-&gt;data
suffix:semicolon
r_int
id|cnt
op_assign
id|mbox-&gt;cmd.length
op_div
r_sizeof
(paren
r_int
)paren
suffix:semicolon
r_for
c_loop
(paren
suffix:semicolon
id|cnt
suffix:semicolon
op_decrement
id|cnt
comma
op_increment
id|list
)paren
(brace
r_if
c_cond
(paren
op_star
id|list
op_eq
id|chan-&gt;dlci
)paren
(brace
id|dlci_found
op_assign
l_int|1
suffix:semicolon
id|set_chan_state
c_func
(paren
id|dev
comma
id|WAN_CONNECTED
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
op_logical_neg
id|dlci_found
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: DLCI %u is inactive&bslash;n&quot;
comma
id|card-&gt;devname
comma
id|chan-&gt;dlci
)paren
suffix:semicolon
)brace
)brace
r_return
id|err
suffix:semicolon
)brace
multiline_comment|/*============================================================================&n; * Set channel state.&n; */
r_static
r_void
id|set_chan_state
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
r_int
id|state
)paren
(brace
id|fr_channel_t
op_star
id|chan
op_assign
id|dev-&gt;priv
suffix:semicolon
id|sdla_t
op_star
id|card
op_assign
id|chan-&gt;card
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|chan-&gt;state
op_ne
id|state
)paren
(brace
r_switch
c_cond
(paren
id|state
)paren
(brace
r_case
id|WAN_CONNECTED
suffix:colon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: interface %s connected!&bslash;n&quot;
comma
id|card-&gt;devname
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|WAN_CONNECTING
suffix:colon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: interface %s connecting...&bslash;n&quot;
comma
id|card-&gt;devname
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|WAN_DISCONNECTED
suffix:colon
id|printk
(paren
id|KERN_INFO
l_string|&quot;%s: interface %s disconnected!&bslash;n&quot;
comma
id|card-&gt;devname
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|chan-&gt;state
op_assign
id|state
suffix:semicolon
)brace
id|chan-&gt;state_tick
op_assign
id|jiffies
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
multiline_comment|/*============================================================================&n; * Find network device by its channel number.&n; */
r_static
r_struct
id|device
op_star
id|find_channel
c_func
(paren
id|sdla_t
op_star
id|card
comma
r_int
id|dlci
)paren
(brace
r_struct
id|device
op_star
id|dev
suffix:semicolon
r_for
c_loop
(paren
id|dev
op_assign
id|card-&gt;wandev.dev
suffix:semicolon
id|dev
suffix:semicolon
id|dev
op_assign
id|dev-&gt;slave
)paren
r_if
c_cond
(paren
(paren
(paren
id|fr_channel_t
op_star
)paren
id|dev-&gt;priv
)paren
op_member_access_from_pointer
id|dlci
op_eq
id|dlci
)paren
r_break
suffix:semicolon
r_return
id|dev
suffix:semicolon
)brace
multiline_comment|/*============================================================================&n; * Check to see if a frame can be sent. If no transmit buffers available,&n; * enable transmit interrupts.&n; *&n; * Return:&t;1 - Tx buffer(s) available&n; *&t;&t;0 - no buffers available&n; */
r_static
r_int
id|is_tx_ready
c_func
(paren
id|sdla_t
op_star
id|card
)paren
(brace
r_if
c_cond
(paren
id|card-&gt;hw.fwid
op_eq
id|SFID_FR508
)paren
(brace
r_int
r_char
id|sb
op_assign
id|inb
c_func
(paren
id|card-&gt;hw.port
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sb
op_amp
l_int|0x02
)paren
r_return
l_int|1
suffix:semicolon
)brace
r_else
(brace
id|fr502_flags_t
op_star
id|flags
op_assign
id|card-&gt;flags
suffix:semicolon
r_if
c_cond
(paren
id|flags-&gt;tx_ready
)paren
r_return
l_int|1
suffix:semicolon
id|flags-&gt;imask
op_or_assign
l_int|0x02
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*============================================================================&n; * Convert decimal string to unsigned integer.&n; * If len != 0 then only &squot;len&squot; characters of the string are converted.&n; */
r_static
r_int
r_int
id|dec_to_uint
c_func
(paren
r_int
r_char
op_star
id|str
comma
r_int
id|len
)paren
(brace
r_int
id|val
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|len
)paren
id|len
op_assign
id|strlen
c_func
(paren
id|str
)paren
suffix:semicolon
r_for
c_loop
(paren
id|val
op_assign
l_int|0
suffix:semicolon
id|len
op_logical_and
id|is_digit
c_func
(paren
op_star
id|str
)paren
suffix:semicolon
op_increment
id|str
comma
op_decrement
id|len
)paren
id|val
op_assign
(paren
id|val
op_star
l_int|10
)paren
op_plus
(paren
op_star
id|str
op_minus
(paren
r_int
)paren
l_char|&squot;0&squot;
)paren
suffix:semicolon
r_return
id|val
suffix:semicolon
)brace
multiline_comment|/*==============================================================================&n; * Perform the Interrupt Test by running the READ_CODE_VERSION command MAX_INTR_&n; * TEST_COUNTER times.&n; */
r_static
r_int
id|intr_test
c_func
(paren
id|sdla_t
op_star
id|card
)paren
(brace
id|fr_mbox_t
op_star
id|mb
op_assign
id|card-&gt;mbox
suffix:semicolon
r_int
id|err
comma
id|i
suffix:semicolon
multiline_comment|/*&n;&t; *&t; The critical flag is unset here because we want to get into the&n;&t; *&t;ISR without the flag already set. The If_open sets the flag.&n;&t; */
id|card-&gt;wandev.critical
op_assign
l_int|0
suffix:semicolon
id|err
op_assign
id|fr_set_intr_mode
c_func
(paren
id|card
comma
l_int|0x08
comma
id|card-&gt;wandev.mtu
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
op_eq
id|CMD_OK
)paren
(brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|MAX_INTR_TEST_COUNTER
suffix:semicolon
id|i
op_increment
)paren
(brace
multiline_comment|/* Run command READ_CODE_VERSION */
id|memset
c_func
(paren
op_amp
id|mb-&gt;cmd
comma
l_int|0
comma
r_sizeof
(paren
id|fr_cmd_t
)paren
)paren
suffix:semicolon
id|mb-&gt;cmd.length
op_assign
l_int|0
suffix:semicolon
id|mb-&gt;cmd.command
op_assign
l_int|0x40
suffix:semicolon
id|err
op_assign
id|sdla_exec
c_func
(paren
id|mb
)paren
ques
c_cond
id|mb-&gt;cmd.result
suffix:colon
id|CMD_TIMEOUT
suffix:semicolon
r_if
c_cond
(paren
id|err
op_ne
id|CMD_OK
)paren
id|fr_event
c_func
(paren
id|card
comma
id|err
comma
id|mb
)paren
suffix:semicolon
)brace
)brace
r_else
r_return
id|err
suffix:semicolon
id|err
op_assign
id|fr_set_intr_mode
c_func
(paren
id|card
comma
l_int|0
comma
id|card-&gt;wandev.mtu
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
op_ne
id|CMD_OK
)paren
(brace
r_return
id|err
suffix:semicolon
)brace
id|card-&gt;wandev.critical
op_assign
l_int|1
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*==============================================================================&n; * Initializes the Statistics values in the Sdla_t structure.&n; */
r_void
id|init_global_statistics
c_func
(paren
id|sdla_t
op_star
id|card
)paren
(brace
multiline_comment|/* Intialize global statistics for a card */
id|card-&gt;statistics.isr_entry
op_assign
l_int|0
suffix:semicolon
id|card-&gt;statistics.isr_already_critical
op_assign
l_int|0
suffix:semicolon
id|card-&gt;statistics.isr_rx
op_assign
l_int|0
suffix:semicolon
id|card-&gt;statistics.isr_tx
op_assign
l_int|0
suffix:semicolon
id|card-&gt;statistics.isr_intr_test
op_assign
l_int|0
suffix:semicolon
id|card-&gt;statistics.isr_spurious
op_assign
l_int|0
suffix:semicolon
id|card-&gt;statistics.isr_enable_tx_int
op_assign
l_int|0
suffix:semicolon
id|card-&gt;statistics.rx_intr_corrupt_rx_bfr
op_assign
l_int|0
suffix:semicolon
id|card-&gt;statistics.rx_intr_on_orphaned_DLCI
op_assign
l_int|0
suffix:semicolon
id|card-&gt;statistics.tx_intr_dev_not_started
op_assign
l_int|0
suffix:semicolon
id|card-&gt;statistics.poll_entry
op_assign
l_int|0
suffix:semicolon
id|card-&gt;statistics.poll_already_critical
op_assign
l_int|0
suffix:semicolon
id|card-&gt;statistics.poll_processed
op_assign
l_int|0
suffix:semicolon
)brace
r_static
r_void
id|read_DLCI_IB_mapping
c_func
(paren
id|sdla_t
op_star
id|card
comma
id|fr_channel_t
op_star
id|chan
)paren
(brace
id|fr_mbox_t
op_star
id|mbox
op_assign
id|card-&gt;mbox
suffix:semicolon
r_int
id|retry
op_assign
id|MAX_CMD_RETRY
suffix:semicolon
id|dlci_IB_mapping_t
op_star
id|result
suffix:semicolon
r_int
id|err
comma
id|counter
comma
id|found
suffix:semicolon
r_do
(brace
id|memset
c_func
(paren
op_amp
id|mbox-&gt;cmd
comma
l_int|0
comma
r_sizeof
(paren
id|fr_cmd_t
)paren
)paren
suffix:semicolon
id|mbox-&gt;cmd.command
op_assign
id|FR_READ_DLCI_IB_MAPPING
suffix:semicolon
id|err
op_assign
id|sdla_exec
c_func
(paren
id|mbox
)paren
ques
c_cond
id|mbox-&gt;cmd.result
suffix:colon
id|CMD_TIMEOUT
suffix:semicolon
)brace
r_while
c_loop
(paren
id|err
op_logical_and
id|retry
op_decrement
op_logical_and
id|fr_event
c_func
(paren
id|card
comma
id|err
comma
id|mbox
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mbox-&gt;cmd.result
op_ne
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Read DLCI IB Mapping failed&bslash;n&quot;
comma
id|chan-&gt;name
)paren
suffix:semicolon
)brace
id|counter
op_assign
id|mbox-&gt;cmd.length
op_div
r_sizeof
(paren
id|dlci_IB_mapping_t
)paren
suffix:semicolon
id|result
op_assign
(paren
r_void
op_star
)paren
id|mbox-&gt;data
suffix:semicolon
id|found
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
suffix:semicolon
id|counter
suffix:semicolon
op_decrement
id|counter
comma
op_increment
id|result
)paren
(brace
r_if
c_cond
(paren
id|result-&gt;dlci
op_eq
id|chan-&gt;dlci
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: DLCI= %d, IB addr = %lx for %s&bslash;n&quot;
comma
id|card-&gt;devname
comma
id|result-&gt;dlci
comma
id|result-&gt;addr_value
comma
id|chan-&gt;name
)paren
suffix:semicolon
id|chan-&gt;IB_addr
op_assign
id|result-&gt;addr_value
suffix:semicolon
id|chan-&gt;dlci_int_interface
op_assign
(paren
r_void
op_star
)paren
(paren
id|card-&gt;hw.dpmbase
op_plus
(paren
id|chan-&gt;IB_addr
op_amp
l_int|0x00001FFF
)paren
)paren
suffix:semicolon
id|found
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
op_logical_neg
id|found
)paren
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: DLCI %d not found by IB MAPPING cmd&bslash;n&quot;
comma
id|card-&gt;devname
comma
id|chan-&gt;dlci
)paren
suffix:semicolon
)brace
multiline_comment|/****** End *****************************************************************/
eof
