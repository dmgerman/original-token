multiline_comment|/*&n; * Linux ARCnet driver - RFC1201 (standard) packet encapsulation&n; * &n; * Written 1994-1999 by Avery Pennarun.&n; * Derived from skeleton.c by Donald Becker.&n; *&n; * Special thanks to Contemporary Controls, Inc. (www.ccontrols.com)&n; *  for sponsoring the further development of this driver.&n; *&n; * **********************&n; *&n; * The original copyright of skeleton.c was as follows:&n; *&n; * skeleton.c Written 1993 by Donald Becker.&n; * Copyright 1993 United States Government as represented by the&n; * Director, National Security Agency.  This software may only be used&n; * and distributed according to the terms of the GNU Public License as&n; * modified by SRC, incorporated herein by reference.&n; *&n; * **********************&n; *&n; * For more details, see drivers/net/arcnet.c&n; *&n; * **********************&n; */
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/if_arp.h&gt;
macro_line|#include &lt;linux/netdevice.h&gt;
macro_line|#include &lt;linux/skbuff.h&gt;
macro_line|#include &lt;linux/arcdevice.h&gt;
DECL|macro|VERSION
mdefine_line|#define VERSION &quot;arcnet: RFC1201 &bslash;&quot;standard&bslash;&quot; (`a&squot;) encapsulation support loaded.&bslash;n&quot;
r_static
r_int
r_int
id|type_trans
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_void
id|rx
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_int
id|bufnum
comma
r_struct
id|archdr
op_star
id|pkthdr
comma
r_int
id|length
)paren
suffix:semicolon
r_static
r_int
id|build_header
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_int
r_int
id|type
comma
r_uint8
id|daddr
)paren
suffix:semicolon
r_static
r_int
id|prepare_tx
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_struct
id|archdr
op_star
id|pkt
comma
r_int
id|length
comma
r_int
id|bufnum
)paren
suffix:semicolon
r_static
r_int
id|continue_tx
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_int
id|bufnum
)paren
suffix:semicolon
DECL|variable|rfc1201_proto
r_struct
id|ArcProto
id|rfc1201_proto
op_assign
(brace
l_char|&squot;a&squot;
comma
l_int|1500
comma
multiline_comment|/* could be more, but some receivers can&squot;t handle it... */
id|rx
comma
id|build_header
comma
id|prepare_tx
comma
id|continue_tx
)brace
suffix:semicolon
DECL|function|arcnet_rfc1201_init
r_void
id|__init
id|arcnet_rfc1201_init
c_func
(paren
r_void
)paren
(brace
id|arc_proto_map
(braket
id|ARC_P_IP
)braket
op_assign
id|arc_proto_map
(braket
id|ARC_P_ARP
)braket
op_assign
id|arc_proto_map
(braket
id|ARC_P_RARP
)braket
op_assign
id|arc_proto_map
(braket
id|ARC_P_IPX
)braket
op_assign
id|arc_proto_map
(braket
id|ARC_P_NOVELL_EC
)braket
op_assign
op_amp
id|rfc1201_proto
suffix:semicolon
multiline_comment|/* if someone else already owns the broadcast, we won&squot;t take it */
r_if
c_cond
(paren
id|arc_bcast_proto
op_eq
id|arc_proto_default
)paren
id|arc_bcast_proto
op_assign
op_amp
id|rfc1201_proto
suffix:semicolon
)brace
macro_line|#ifdef MODULE
DECL|function|init_module
r_int
id|__init
id|init_module
c_func
(paren
r_void
)paren
(brace
id|printk
c_func
(paren
id|VERSION
)paren
suffix:semicolon
id|arcnet_rfc1201_init
c_func
(paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|cleanup_module
r_void
id|cleanup_module
c_func
(paren
r_void
)paren
(brace
id|arcnet_unregister_proto
c_func
(paren
op_amp
id|rfc1201_proto
)paren
suffix:semicolon
)brace
macro_line|#endif&t;&t;&t;&t;/* MODULE */
multiline_comment|/*&n; * Determine a packet&squot;s protocol ID.&n; * &n; * With ARCnet we have to convert everything to Ethernet-style stuff.&n; */
DECL|function|type_trans
r_static
r_int
r_int
id|type_trans
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|archdr
op_star
id|pkt
op_assign
(paren
r_struct
id|archdr
op_star
)paren
id|skb-&gt;data
suffix:semicolon
r_struct
id|arc_rfc1201
op_star
id|soft
op_assign
op_amp
id|pkt-&gt;soft.rfc1201
suffix:semicolon
r_struct
id|arcnet_local
op_star
id|lp
op_assign
(paren
r_struct
id|arcnet_local
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_int
id|hdr_size
op_assign
id|ARC_HDR_SIZE
op_plus
id|RFC1201_HDR_SIZE
suffix:semicolon
multiline_comment|/* Pull off the arcnet header. */
id|skb-&gt;mac.raw
op_assign
id|skb-&gt;data
suffix:semicolon
id|skb_pull
c_func
(paren
id|skb
comma
id|hdr_size
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pkt-&gt;hard.dest
op_eq
l_int|0
)paren
id|skb-&gt;pkt_type
op_assign
id|PACKET_BROADCAST
suffix:semicolon
r_else
r_if
c_cond
(paren
id|dev-&gt;flags
op_amp
id|IFF_PROMISC
)paren
(brace
multiline_comment|/* if we&squot;re not sending to ourselves :) */
r_if
c_cond
(paren
id|pkt-&gt;hard.dest
op_ne
id|dev-&gt;dev_addr
(braket
l_int|0
)braket
)paren
id|skb-&gt;pkt_type
op_assign
id|PACKET_OTHERHOST
suffix:semicolon
)brace
multiline_comment|/* now return the protocol number */
r_switch
c_cond
(paren
id|soft-&gt;proto
)paren
(brace
r_case
id|ARC_P_IP
suffix:colon
r_return
id|htons
c_func
(paren
id|ETH_P_IP
)paren
suffix:semicolon
r_case
id|ARC_P_ARP
suffix:colon
r_return
id|htons
c_func
(paren
id|ETH_P_ARP
)paren
suffix:semicolon
r_case
id|ARC_P_RARP
suffix:colon
r_return
id|htons
c_func
(paren
id|ETH_P_RARP
)paren
suffix:semicolon
r_case
id|ARC_P_IPX
suffix:colon
r_case
id|ARC_P_NOVELL_EC
suffix:colon
r_return
id|htons
c_func
(paren
id|ETH_P_802_3
)paren
suffix:semicolon
r_default
suffix:colon
id|lp-&gt;stats.rx_errors
op_increment
suffix:semicolon
id|lp-&gt;stats.rx_crc_errors
op_increment
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_return
id|htons
c_func
(paren
id|ETH_P_IP
)paren
suffix:semicolon
)brace
multiline_comment|/* packet receiver */
DECL|function|rx
r_static
r_void
id|rx
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_int
id|bufnum
comma
r_struct
id|archdr
op_star
id|pkthdr
comma
r_int
id|length
)paren
(brace
r_struct
id|arcnet_local
op_star
id|lp
op_assign
(paren
r_struct
id|arcnet_local
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
r_struct
id|archdr
op_star
id|pkt
op_assign
id|pkthdr
suffix:semicolon
r_struct
id|arc_rfc1201
op_star
id|soft
op_assign
op_amp
id|pkthdr-&gt;soft.rfc1201
suffix:semicolon
r_int
id|saddr
op_assign
id|pkt-&gt;hard.source
comma
id|ofs
suffix:semicolon
r_struct
id|Incoming
op_star
id|in
op_assign
op_amp
id|lp-&gt;rfc1201.incoming
(braket
id|saddr
)braket
suffix:semicolon
id|BUGMSG
c_func
(paren
id|D_DURING
comma
l_string|&quot;it&squot;s an RFC1201 packet (length=%d)&bslash;n&quot;
comma
id|length
)paren
suffix:semicolon
r_if
c_cond
(paren
id|length
op_ge
id|MinTU
)paren
id|ofs
op_assign
l_int|512
op_minus
id|length
suffix:semicolon
r_else
id|ofs
op_assign
l_int|256
op_minus
id|length
suffix:semicolon
r_if
c_cond
(paren
id|soft-&gt;split_flag
op_eq
l_int|0xFF
)paren
(brace
multiline_comment|/* Exception Packet */
r_if
c_cond
(paren
id|length
op_ge
l_int|4
op_plus
id|RFC1201_HDR_SIZE
)paren
id|BUGMSG
c_func
(paren
id|D_DURING
comma
l_string|&quot;compensating for exception packet&bslash;n&quot;
)paren
suffix:semicolon
r_else
(brace
id|BUGMSG
c_func
(paren
id|D_EXTRA
comma
l_string|&quot;short RFC1201 exception packet from %02Xh&quot;
comma
id|saddr
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/* skip over 4-byte junkola */
id|length
op_sub_assign
l_int|4
suffix:semicolon
id|ofs
op_add_assign
l_int|4
suffix:semicolon
id|lp-&gt;hw
dot
id|copy_from_card
c_func
(paren
id|dev
comma
id|bufnum
comma
l_int|512
op_minus
id|length
comma
id|soft
comma
r_sizeof
(paren
id|pkt-&gt;soft
)paren
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|soft-&gt;split_flag
)paren
(brace
multiline_comment|/* not split */
id|BUGMSG
c_func
(paren
id|D_RX
comma
l_string|&quot;incoming is not split (splitflag=%d)&bslash;n&quot;
comma
id|soft-&gt;split_flag
)paren
suffix:semicolon
r_if
c_cond
(paren
id|in-&gt;skb
)paren
(brace
multiline_comment|/* already assembling one! */
id|BUGMSG
c_func
(paren
id|D_EXTRA
comma
l_string|&quot;aborting assembly (seq=%d) for unsplit packet (splitflag=%d, seq=%d)&bslash;n&quot;
comma
id|in-&gt;sequence
comma
id|soft-&gt;split_flag
comma
id|soft-&gt;sequence
)paren
suffix:semicolon
id|lp-&gt;rfc1201.aborted_seq
op_assign
id|soft-&gt;sequence
suffix:semicolon
id|dev_kfree_skb_irq
c_func
(paren
id|in-&gt;skb
)paren
suffix:semicolon
id|lp-&gt;stats.rx_errors
op_increment
suffix:semicolon
id|lp-&gt;stats.rx_missed_errors
op_increment
suffix:semicolon
id|in-&gt;skb
op_assign
l_int|NULL
suffix:semicolon
)brace
id|in-&gt;sequence
op_assign
id|soft-&gt;sequence
suffix:semicolon
id|skb
op_assign
id|alloc_skb
c_func
(paren
id|length
op_plus
id|ARC_HDR_SIZE
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
id|skb
op_eq
l_int|NULL
)paren
(brace
id|BUGMSG
c_func
(paren
id|D_NORMAL
comma
l_string|&quot;Memory squeeze, dropping packet.&bslash;n&quot;
)paren
suffix:semicolon
id|lp-&gt;stats.rx_dropped
op_increment
suffix:semicolon
r_return
suffix:semicolon
)brace
id|skb_put
c_func
(paren
id|skb
comma
id|length
op_plus
id|ARC_HDR_SIZE
)paren
suffix:semicolon
id|skb-&gt;dev
op_assign
id|dev
suffix:semicolon
id|pkt
op_assign
(paren
r_struct
id|archdr
op_star
)paren
id|skb-&gt;data
suffix:semicolon
id|soft
op_assign
op_amp
id|pkt-&gt;soft.rfc1201
suffix:semicolon
multiline_comment|/* up to sizeof(pkt-&gt;soft) has already been copied from the card */
id|memcpy
c_func
(paren
id|pkt
comma
id|pkthdr
comma
r_sizeof
(paren
r_struct
id|archdr
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|length
OG
r_sizeof
(paren
id|pkt-&gt;soft
)paren
)paren
id|lp-&gt;hw
dot
id|copy_from_card
c_func
(paren
id|dev
comma
id|bufnum
comma
id|ofs
op_plus
r_sizeof
(paren
id|pkt-&gt;soft
)paren
comma
id|pkt-&gt;soft.raw
op_plus
r_sizeof
(paren
id|pkt-&gt;soft
)paren
comma
id|length
op_minus
r_sizeof
(paren
id|pkt-&gt;soft
)paren
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t; * ARP packets have problems when sent from some DOS systems: the&n;&t;&t; * source address is always 0!  So we take the hardware source addr&n;&t;&t; * (which is impossible to fumble) and insert it ourselves.&n;&t;&t; */
r_if
c_cond
(paren
id|soft-&gt;proto
op_eq
id|ARC_P_ARP
)paren
(brace
r_struct
id|arphdr
op_star
id|arp
op_assign
(paren
r_struct
id|arphdr
op_star
)paren
id|soft-&gt;payload
suffix:semicolon
multiline_comment|/* make sure addresses are the right length */
r_if
c_cond
(paren
id|arp-&gt;ar_hln
op_eq
l_int|1
op_logical_and
id|arp-&gt;ar_pln
op_eq
l_int|4
)paren
(brace
r_uint8
op_star
id|cptr
op_assign
(paren
r_uint8
op_star
)paren
id|arp
op_plus
r_sizeof
(paren
r_struct
id|arphdr
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
op_star
id|cptr
)paren
(brace
multiline_comment|/* is saddr = 00? */
id|BUGMSG
c_func
(paren
id|D_EXTRA
comma
l_string|&quot;ARP source address was 00h, set to %02Xh.&bslash;n&quot;
comma
id|saddr
)paren
suffix:semicolon
id|lp-&gt;stats.rx_crc_errors
op_increment
suffix:semicolon
op_star
id|cptr
op_assign
id|saddr
suffix:semicolon
)brace
r_else
(brace
id|BUGMSG
c_func
(paren
id|D_DURING
comma
l_string|&quot;ARP source address (%Xh) is fine.&bslash;n&quot;
comma
op_star
id|cptr
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
id|BUGMSG
c_func
(paren
id|D_NORMAL
comma
l_string|&quot;funny-shaped ARP packet. (%Xh, %Xh)&bslash;n&quot;
comma
id|arp-&gt;ar_hln
comma
id|arp-&gt;ar_pln
)paren
suffix:semicolon
id|lp-&gt;stats.rx_errors
op_increment
suffix:semicolon
id|lp-&gt;stats.rx_crc_errors
op_increment
suffix:semicolon
)brace
)brace
id|BUGLVL
c_func
(paren
id|D_SKB
)paren
id|arcnet_dump_skb
c_func
(paren
id|dev
comma
id|skb
comma
l_string|&quot;rx&quot;
)paren
suffix:semicolon
id|skb-&gt;protocol
op_assign
id|type_trans
c_func
(paren
id|skb
comma
id|dev
)paren
suffix:semicolon
id|netif_rx
c_func
(paren
id|skb
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* split packet */
multiline_comment|/*&n;&t;&t; * NOTE: MSDOS ARP packet correction should only need to apply to&n;&t;&t; * unsplit packets, since ARP packets are so short.&n;&t;&t; *&n;&t;&t; * My interpretation of the RFC1201 document is that if a packet is&n;&t;&t; * received out of order, the entire assembly process should be&n;&t;&t; * aborted.&n;&t;&t; *&n;&t;&t; * The RFC also mentions &quot;it is possible for successfully received&n;&t;&t; * packets to be retransmitted.&quot; As of 0.40 all previously received&n;&t;&t; * packets are allowed, not just the most recent one.&n;&t;&t; *&n;&t;&t; * We allow multiple assembly processes, one for each ARCnet card&n;&t;&t; * possible on the network.  Seems rather like a waste of memory,&n;&t;&t; * but there&squot;s no other way to be reliable.&n;&t;&t; */
id|BUGMSG
c_func
(paren
id|D_RX
comma
l_string|&quot;packet is split (splitflag=%d, seq=%d)&bslash;n&quot;
comma
id|soft-&gt;split_flag
comma
id|in-&gt;sequence
)paren
suffix:semicolon
r_if
c_cond
(paren
id|in-&gt;skb
op_logical_and
id|in-&gt;sequence
op_ne
id|soft-&gt;sequence
)paren
(brace
id|BUGMSG
c_func
(paren
id|D_EXTRA
comma
l_string|&quot;wrong seq number (saddr=%d, expected=%d, seq=%d, splitflag=%d)&bslash;n&quot;
comma
id|saddr
comma
id|in-&gt;sequence
comma
id|soft-&gt;sequence
comma
id|soft-&gt;split_flag
)paren
suffix:semicolon
id|dev_kfree_skb_irq
c_func
(paren
id|in-&gt;skb
)paren
suffix:semicolon
id|in-&gt;skb
op_assign
l_int|NULL
suffix:semicolon
id|lp-&gt;stats.rx_errors
op_increment
suffix:semicolon
id|lp-&gt;stats.rx_missed_errors
op_increment
suffix:semicolon
id|in-&gt;lastpacket
op_assign
id|in-&gt;numpackets
op_assign
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|soft-&gt;split_flag
op_amp
l_int|1
)paren
(brace
multiline_comment|/* first packet in split */
id|BUGMSG
c_func
(paren
id|D_RX
comma
l_string|&quot;brand new splitpacket (splitflag=%d)&bslash;n&quot;
comma
id|soft-&gt;split_flag
)paren
suffix:semicolon
r_if
c_cond
(paren
id|in-&gt;skb
)paren
(brace
multiline_comment|/* already assembling one! */
id|BUGMSG
c_func
(paren
id|D_EXTRA
comma
l_string|&quot;aborting previous (seq=%d) assembly &quot;
l_string|&quot;(splitflag=%d, seq=%d)&bslash;n&quot;
comma
id|in-&gt;sequence
comma
id|soft-&gt;split_flag
comma
id|soft-&gt;sequence
)paren
suffix:semicolon
id|lp-&gt;stats.rx_errors
op_increment
suffix:semicolon
id|lp-&gt;stats.rx_missed_errors
op_increment
suffix:semicolon
id|dev_kfree_skb_irq
c_func
(paren
id|in-&gt;skb
)paren
suffix:semicolon
)brace
id|in-&gt;sequence
op_assign
id|soft-&gt;sequence
suffix:semicolon
id|in-&gt;numpackets
op_assign
(paren
(paren
r_int
)paren
id|soft-&gt;split_flag
op_rshift
l_int|1
)paren
op_plus
l_int|2
suffix:semicolon
id|in-&gt;lastpacket
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|in-&gt;numpackets
OG
l_int|16
)paren
(brace
id|BUGMSG
c_func
(paren
id|D_EXTRA
comma
l_string|&quot;incoming packet more than 16 segments; dropping. (splitflag=%d)&bslash;n&quot;
comma
id|soft-&gt;split_flag
)paren
suffix:semicolon
id|lp-&gt;rfc1201.aborted_seq
op_assign
id|soft-&gt;sequence
suffix:semicolon
id|lp-&gt;stats.rx_errors
op_increment
suffix:semicolon
id|lp-&gt;stats.rx_length_errors
op_increment
suffix:semicolon
r_return
suffix:semicolon
)brace
id|in-&gt;skb
op_assign
id|skb
op_assign
id|alloc_skb
c_func
(paren
l_int|508
op_star
id|in-&gt;numpackets
op_plus
id|ARC_HDR_SIZE
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
id|skb
op_eq
l_int|NULL
)paren
(brace
id|BUGMSG
c_func
(paren
id|D_NORMAL
comma
l_string|&quot;(split) memory squeeze, dropping packet.&bslash;n&quot;
)paren
suffix:semicolon
id|lp-&gt;rfc1201.aborted_seq
op_assign
id|soft-&gt;sequence
suffix:semicolon
id|lp-&gt;stats.rx_dropped
op_increment
suffix:semicolon
r_return
suffix:semicolon
)brace
id|skb-&gt;dev
op_assign
id|dev
suffix:semicolon
id|pkt
op_assign
(paren
r_struct
id|archdr
op_star
)paren
id|skb-&gt;data
suffix:semicolon
id|soft
op_assign
op_amp
id|pkt-&gt;soft.rfc1201
suffix:semicolon
id|memcpy
c_func
(paren
id|pkt
comma
id|pkthdr
comma
id|ARC_HDR_SIZE
op_plus
id|RFC1201_HDR_SIZE
)paren
suffix:semicolon
id|skb_put
c_func
(paren
id|skb
comma
id|ARC_HDR_SIZE
op_plus
id|RFC1201_HDR_SIZE
)paren
suffix:semicolon
id|soft-&gt;split_flag
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* end result won&squot;t be split */
)brace
r_else
(brace
multiline_comment|/* not first packet */
r_int
id|packetnum
op_assign
(paren
(paren
r_int
)paren
id|soft-&gt;split_flag
op_rshift
l_int|1
)paren
op_plus
l_int|1
suffix:semicolon
multiline_comment|/*&n;&t;&t;&t; * if we&squot;re not assembling, there&squot;s no point trying to&n;&t;&t;&t; * continue.&n;&t;&t;&t; */
r_if
c_cond
(paren
op_logical_neg
id|in-&gt;skb
)paren
(brace
r_if
c_cond
(paren
id|lp-&gt;rfc1201.aborted_seq
op_ne
id|soft-&gt;sequence
)paren
(brace
id|BUGMSG
c_func
(paren
id|D_EXTRA
comma
l_string|&quot;can&squot;t continue split without starting &quot;
l_string|&quot;first! (splitflag=%d, seq=%d, aborted=%d)&bslash;n&quot;
comma
id|soft-&gt;split_flag
comma
id|soft-&gt;sequence
comma
id|lp-&gt;rfc1201.aborted_seq
)paren
suffix:semicolon
id|lp-&gt;stats.rx_errors
op_increment
suffix:semicolon
id|lp-&gt;stats.rx_missed_errors
op_increment
suffix:semicolon
)brace
r_return
suffix:semicolon
)brace
id|in-&gt;lastpacket
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|packetnum
op_ne
id|in-&gt;lastpacket
)paren
(brace
multiline_comment|/* not the right flag! */
multiline_comment|/* harmless duplicate? ignore. */
r_if
c_cond
(paren
id|packetnum
op_le
id|in-&gt;lastpacket
op_minus
l_int|1
)paren
(brace
id|BUGMSG
c_func
(paren
id|D_EXTRA
comma
l_string|&quot;duplicate splitpacket ignored! (splitflag=%d)&bslash;n&quot;
comma
id|soft-&gt;split_flag
)paren
suffix:semicolon
id|lp-&gt;stats.rx_errors
op_increment
suffix:semicolon
id|lp-&gt;stats.rx_frame_errors
op_increment
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/* &quot;bad&quot; duplicate, kill reassembly */
id|BUGMSG
c_func
(paren
id|D_EXTRA
comma
l_string|&quot;out-of-order splitpacket, reassembly &quot;
l_string|&quot;(seq=%d) aborted (splitflag=%d, seq=%d)&bslash;n&quot;
comma
id|in-&gt;sequence
comma
id|soft-&gt;split_flag
comma
id|soft-&gt;sequence
)paren
suffix:semicolon
id|lp-&gt;rfc1201.aborted_seq
op_assign
id|soft-&gt;sequence
suffix:semicolon
id|dev_kfree_skb_irq
c_func
(paren
id|in-&gt;skb
)paren
suffix:semicolon
id|in-&gt;skb
op_assign
l_int|NULL
suffix:semicolon
id|lp-&gt;stats.rx_errors
op_increment
suffix:semicolon
id|lp-&gt;stats.rx_missed_errors
op_increment
suffix:semicolon
id|in-&gt;lastpacket
op_assign
id|in-&gt;numpackets
op_assign
l_int|0
suffix:semicolon
r_return
suffix:semicolon
)brace
id|pkt
op_assign
(paren
r_struct
id|archdr
op_star
)paren
id|in-&gt;skb-&gt;data
suffix:semicolon
id|soft
op_assign
op_amp
id|pkt-&gt;soft.rfc1201
suffix:semicolon
)brace
id|skb
op_assign
id|in-&gt;skb
suffix:semicolon
id|lp-&gt;hw
dot
id|copy_from_card
c_func
(paren
id|dev
comma
id|bufnum
comma
id|ofs
op_plus
id|RFC1201_HDR_SIZE
comma
id|skb-&gt;data
op_plus
id|skb-&gt;len
comma
id|length
op_minus
id|RFC1201_HDR_SIZE
)paren
suffix:semicolon
id|skb_put
c_func
(paren
id|skb
comma
id|length
op_minus
id|RFC1201_HDR_SIZE
)paren
suffix:semicolon
multiline_comment|/* are we done? */
r_if
c_cond
(paren
id|in-&gt;lastpacket
op_eq
id|in-&gt;numpackets
)paren
(brace
id|in-&gt;skb
op_assign
l_int|NULL
suffix:semicolon
id|in-&gt;lastpacket
op_assign
id|in-&gt;numpackets
op_assign
l_int|0
suffix:semicolon
id|BUGMSG
c_func
(paren
id|D_SKB_SIZE
comma
l_string|&quot;skb: received %d bytes from %02X (unsplit)&bslash;n&quot;
comma
id|skb-&gt;len
comma
id|pkt-&gt;hard.source
)paren
suffix:semicolon
id|BUGMSG
c_func
(paren
id|D_SKB_SIZE
comma
l_string|&quot;skb: received %d bytes from %02X (split)&bslash;n&quot;
comma
id|skb-&gt;len
comma
id|pkt-&gt;hard.source
)paren
suffix:semicolon
id|BUGLVL
c_func
(paren
id|D_SKB
)paren
id|arcnet_dump_skb
c_func
(paren
id|dev
comma
id|skb
comma
l_string|&quot;rx&quot;
)paren
suffix:semicolon
id|skb-&gt;protocol
op_assign
id|type_trans
c_func
(paren
id|skb
comma
id|dev
)paren
suffix:semicolon
id|netif_rx
c_func
(paren
id|skb
)paren
suffix:semicolon
)brace
)brace
)brace
multiline_comment|/* Create the ARCnet hard/soft headers for RFC1201. */
DECL|function|build_header
r_static
r_int
id|build_header
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_int
r_int
id|type
comma
r_uint8
id|daddr
)paren
(brace
r_struct
id|net_device
op_star
id|dev
op_assign
id|skb-&gt;dev
suffix:semicolon
r_struct
id|arcnet_local
op_star
id|lp
op_assign
(paren
r_struct
id|arcnet_local
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_int
id|hdr_size
op_assign
id|ARC_HDR_SIZE
op_plus
id|RFC1201_HDR_SIZE
suffix:semicolon
r_struct
id|archdr
op_star
id|pkt
op_assign
(paren
r_struct
id|archdr
op_star
)paren
id|skb_push
c_func
(paren
id|skb
comma
id|hdr_size
)paren
suffix:semicolon
r_struct
id|arc_rfc1201
op_star
id|soft
op_assign
op_amp
id|pkt-&gt;soft.rfc1201
suffix:semicolon
multiline_comment|/* set the protocol ID according to RFC1201 */
r_switch
c_cond
(paren
id|type
)paren
(brace
r_case
id|ETH_P_IP
suffix:colon
id|soft-&gt;proto
op_assign
id|ARC_P_IP
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ETH_P_ARP
suffix:colon
id|soft-&gt;proto
op_assign
id|ARC_P_ARP
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ETH_P_RARP
suffix:colon
id|soft-&gt;proto
op_assign
id|ARC_P_RARP
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ETH_P_IPX
suffix:colon
r_case
id|ETH_P_802_3
suffix:colon
r_case
id|ETH_P_802_2
suffix:colon
id|soft-&gt;proto
op_assign
id|ARC_P_IPX
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ETH_P_ATALK
suffix:colon
id|soft-&gt;proto
op_assign
id|ARC_P_ATALK
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|BUGMSG
c_func
(paren
id|D_NORMAL
comma
l_string|&quot;RFC1201: I don&squot;t understand protocol %d (%Xh)&bslash;n&quot;
comma
id|type
comma
id|type
)paren
suffix:semicolon
id|lp-&gt;stats.tx_errors
op_increment
suffix:semicolon
id|lp-&gt;stats.tx_aborted_errors
op_increment
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * Set the source hardware address.&n;&t; *&n;&t; * This is pretty pointless for most purposes, but it can help in&n;&t; * debugging.  ARCnet does not allow us to change the source address in&n;&t; * the actual packet sent)&n;&t; */
id|pkt-&gt;hard.source
op_assign
op_star
id|dev-&gt;dev_addr
suffix:semicolon
id|soft-&gt;sequence
op_assign
id|htons
c_func
(paren
id|lp-&gt;rfc1201.sequence
op_increment
)paren
suffix:semicolon
id|soft-&gt;split_flag
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* split packets are done elsewhere */
multiline_comment|/* see linux/net/ethernet/eth.c to see where I got the following */
r_if
c_cond
(paren
id|dev-&gt;flags
op_amp
(paren
id|IFF_LOOPBACK
op_or
id|IFF_NOARP
)paren
)paren
(brace
multiline_comment|/* &n;&t;&t; * FIXME: fill in the last byte of the dest ipaddr here to better&n;&t;&t; * comply with RFC1051 in &quot;noarp&quot; mode.  For now, always broadcasting&n;&t;&t; * will probably at least get packets sent out :)&n;&t;&t; */
id|pkt-&gt;hard.dest
op_assign
l_int|0
suffix:semicolon
r_return
id|hdr_size
suffix:semicolon
)brace
multiline_comment|/* otherwise, drop in the dest address */
id|pkt-&gt;hard.dest
op_assign
id|daddr
suffix:semicolon
r_return
id|hdr_size
suffix:semicolon
)brace
DECL|function|load_pkt
r_static
r_void
id|load_pkt
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_struct
id|arc_hardware
op_star
id|hard
comma
r_struct
id|arc_rfc1201
op_star
id|soft
comma
r_int
id|softlen
comma
r_int
id|bufnum
)paren
(brace
r_struct
id|arcnet_local
op_star
id|lp
op_assign
(paren
r_struct
id|arcnet_local
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_int
id|ofs
suffix:semicolon
multiline_comment|/* assume length &lt;= XMTU: someone should have handled that by now. */
r_if
c_cond
(paren
id|softlen
OG
id|MinTU
)paren
(brace
id|hard-&gt;offset
(braket
l_int|0
)braket
op_assign
l_int|0
suffix:semicolon
id|hard-&gt;offset
(braket
l_int|1
)braket
op_assign
id|ofs
op_assign
l_int|512
op_minus
id|softlen
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|softlen
OG
id|MTU
)paren
(brace
multiline_comment|/* exception packet - add an extra header */
r_struct
id|arc_rfc1201
id|excsoft
suffix:semicolon
id|excsoft.proto
op_assign
id|soft-&gt;proto
suffix:semicolon
id|excsoft.split_flag
op_assign
l_int|0xff
suffix:semicolon
id|excsoft.sequence
op_assign
l_int|0xffff
suffix:semicolon
id|hard-&gt;offset
(braket
l_int|0
)braket
op_assign
l_int|0
suffix:semicolon
id|ofs
op_assign
l_int|512
op_minus
id|softlen
suffix:semicolon
id|hard-&gt;offset
(braket
l_int|1
)braket
op_assign
id|ofs
op_minus
id|RFC1201_HDR_SIZE
suffix:semicolon
id|lp-&gt;hw
dot
id|copy_to_card
c_func
(paren
id|dev
comma
id|bufnum
comma
id|ofs
op_minus
id|RFC1201_HDR_SIZE
comma
op_amp
id|excsoft
comma
id|RFC1201_HDR_SIZE
)paren
suffix:semicolon
)brace
r_else
id|hard-&gt;offset
(braket
l_int|0
)braket
op_assign
id|ofs
op_assign
l_int|256
op_minus
id|softlen
suffix:semicolon
id|lp-&gt;hw
dot
id|copy_to_card
c_func
(paren
id|dev
comma
id|bufnum
comma
l_int|0
comma
id|hard
comma
id|ARC_HDR_SIZE
)paren
suffix:semicolon
id|lp-&gt;hw
dot
id|copy_to_card
c_func
(paren
id|dev
comma
id|bufnum
comma
id|ofs
comma
id|soft
comma
id|softlen
)paren
suffix:semicolon
id|lp-&gt;lastload_dest
op_assign
id|hard-&gt;dest
suffix:semicolon
)brace
DECL|function|prepare_tx
r_static
r_int
id|prepare_tx
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_struct
id|archdr
op_star
id|pkt
comma
r_int
id|length
comma
r_int
id|bufnum
)paren
(brace
r_struct
id|arcnet_local
op_star
id|lp
op_assign
(paren
r_struct
id|arcnet_local
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_const
r_int
id|maxsegsize
op_assign
id|XMTU
op_minus
id|RFC1201_HDR_SIZE
suffix:semicolon
r_struct
id|Outgoing
op_star
id|out
suffix:semicolon
id|BUGMSG
c_func
(paren
id|D_DURING
comma
l_string|&quot;prepare_tx: txbufs=%d/%d/%d&bslash;n&quot;
comma
id|lp-&gt;next_tx
comma
id|lp-&gt;cur_tx
comma
id|bufnum
)paren
suffix:semicolon
id|length
op_sub_assign
id|ARC_HDR_SIZE
suffix:semicolon
multiline_comment|/* hard header is not included in packet length */
id|pkt-&gt;soft.rfc1201.split_flag
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* need to do a split packet? */
r_if
c_cond
(paren
id|length
OG
id|XMTU
)paren
(brace
id|out
op_assign
op_amp
id|lp-&gt;outgoing
suffix:semicolon
id|out-&gt;length
op_assign
id|length
op_minus
id|RFC1201_HDR_SIZE
suffix:semicolon
id|out-&gt;dataleft
op_assign
id|lp-&gt;outgoing.length
suffix:semicolon
id|out-&gt;numsegs
op_assign
(paren
id|out-&gt;dataleft
op_plus
id|maxsegsize
op_minus
l_int|1
)paren
op_div
id|maxsegsize
suffix:semicolon
id|out-&gt;segnum
op_assign
l_int|0
suffix:semicolon
id|BUGMSG
c_func
(paren
id|D_DURING
comma
l_string|&quot;rfc1201 prep_tx: ready for %d-segment split &quot;
l_string|&quot;(%d bytes, seq=%d)&bslash;n&quot;
comma
id|out-&gt;numsegs
comma
id|out-&gt;length
comma
id|pkt-&gt;soft.rfc1201.sequence
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
multiline_comment|/* not done */
)brace
multiline_comment|/* just load the packet into the buffers and send it off */
id|load_pkt
c_func
(paren
id|dev
comma
op_amp
id|pkt-&gt;hard
comma
op_amp
id|pkt-&gt;soft.rfc1201
comma
id|length
comma
id|bufnum
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
multiline_comment|/* done */
)brace
DECL|function|continue_tx
r_static
r_int
id|continue_tx
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_int
id|bufnum
)paren
(brace
r_struct
id|arcnet_local
op_star
id|lp
op_assign
(paren
r_struct
id|arcnet_local
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_struct
id|Outgoing
op_star
id|out
op_assign
op_amp
id|lp-&gt;outgoing
suffix:semicolon
r_struct
id|arc_hardware
op_star
id|hard
op_assign
op_amp
id|out-&gt;pkt-&gt;hard
suffix:semicolon
r_struct
id|arc_rfc1201
op_star
id|soft
op_assign
op_amp
id|out-&gt;pkt-&gt;soft.rfc1201
comma
op_star
id|newsoft
suffix:semicolon
r_int
id|maxsegsize
op_assign
id|XMTU
op_minus
id|RFC1201_HDR_SIZE
suffix:semicolon
r_int
id|seglen
suffix:semicolon
id|BUGMSG
c_func
(paren
id|D_DURING
comma
l_string|&quot;rfc1201 continue_tx: loading segment %d(+1) of %d (seq=%d)&bslash;n&quot;
comma
id|out-&gt;segnum
comma
id|out-&gt;numsegs
comma
id|soft-&gt;sequence
)paren
suffix:semicolon
multiline_comment|/* the &quot;new&quot; soft header comes right before the data chunk */
id|newsoft
op_assign
(paren
r_struct
id|arc_rfc1201
op_star
)paren
(paren
id|out-&gt;pkt-&gt;soft.raw
op_plus
id|out-&gt;length
op_minus
id|out-&gt;dataleft
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|out-&gt;segnum
)paren
multiline_comment|/* first packet; newsoft == soft */
id|newsoft-&gt;split_flag
op_assign
(paren
(paren
id|out-&gt;numsegs
op_minus
l_int|2
)paren
op_lshift
l_int|1
)paren
op_or
l_int|1
suffix:semicolon
r_else
(brace
id|newsoft-&gt;split_flag
op_assign
id|out-&gt;segnum
op_lshift
l_int|1
suffix:semicolon
id|newsoft-&gt;proto
op_assign
id|soft-&gt;proto
suffix:semicolon
id|newsoft-&gt;sequence
op_assign
id|soft-&gt;sequence
suffix:semicolon
)brace
id|seglen
op_assign
id|maxsegsize
suffix:semicolon
r_if
c_cond
(paren
id|seglen
OG
id|out-&gt;dataleft
)paren
id|seglen
op_assign
id|out-&gt;dataleft
suffix:semicolon
id|out-&gt;dataleft
op_sub_assign
id|seglen
suffix:semicolon
id|load_pkt
c_func
(paren
id|dev
comma
id|hard
comma
id|newsoft
comma
id|seglen
op_plus
id|RFC1201_HDR_SIZE
comma
id|bufnum
)paren
suffix:semicolon
id|out-&gt;segnum
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|out-&gt;segnum
op_ge
id|out-&gt;numsegs
)paren
r_return
l_int|1
suffix:semicolon
r_else
r_return
l_int|0
suffix:semicolon
)brace
eof
