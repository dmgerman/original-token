multiline_comment|/*&n; * Linux ARCnet driver - &quot;raw mode&quot; packet encapsulation (no soft headers)&n; * &n; * Written 1994-1999 by Avery Pennarun.&n; * Derived from skeleton.c by Donald Becker.&n; *&n; * Special thanks to Contemporary Controls, Inc. (www.ccontrols.com)&n; *  for sponsoring the further development of this driver.&n; *&n; * **********************&n; *&n; * The original copyright of skeleton.c was as follows:&n; *&n; * skeleton.c Written 1993 by Donald Becker.&n; * Copyright 1993 United States Government as represented by the&n; * Director, National Security Agency.  This software may only be used&n; * and distributed according to the terms of the GNU Public License as&n; * modified by SRC, incorporated herein by reference.&n; *&n; * **********************&n; *&n; * For more details, see drivers/net/arcnet.c&n; *&n; * **********************&n; */
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/if_arp.h&gt;
macro_line|#include &lt;net/arp.h&gt;
macro_line|#include &lt;linux/netdevice.h&gt;
macro_line|#include &lt;linux/skbuff.h&gt;
macro_line|#include &lt;linux/arcdevice.h&gt;
DECL|macro|VERSION
mdefine_line|#define VERSION &quot;arcnet: raw mode (`r&squot;) encapsulation support loaded.&bslash;n&quot;
r_static
r_void
id|rx
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_int
id|bufnum
comma
r_struct
id|archdr
op_star
id|pkthdr
comma
r_int
id|length
)paren
suffix:semicolon
r_static
r_int
id|build_header
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_int
r_int
id|type
comma
r_uint8
id|daddr
)paren
suffix:semicolon
r_static
r_int
id|prepare_tx
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_struct
id|archdr
op_star
id|pkt
comma
r_int
id|length
comma
r_int
id|bufnum
)paren
suffix:semicolon
DECL|variable|rawmode_proto
r_struct
id|ArcProto
id|rawmode_proto
op_assign
(brace
l_char|&squot;r&squot;
comma
id|XMTU
comma
id|rx
comma
id|build_header
comma
id|prepare_tx
)brace
suffix:semicolon
DECL|function|arcnet_raw_init
r_void
id|arcnet_raw_init
c_func
(paren
r_void
)paren
(brace
r_int
id|count
suffix:semicolon
r_for
c_loop
(paren
id|count
op_assign
l_int|0
suffix:semicolon
id|count
OL
l_int|256
suffix:semicolon
id|count
op_increment
)paren
r_if
c_cond
(paren
id|arc_proto_map
(braket
id|count
)braket
op_eq
id|arc_proto_default
)paren
id|arc_proto_map
(braket
id|count
)braket
op_assign
op_amp
id|rawmode_proto
suffix:semicolon
multiline_comment|/* for raw mode, we only set the bcast proto if there&squot;s no better one */
r_if
c_cond
(paren
id|arc_bcast_proto
op_eq
id|arc_proto_default
)paren
id|arc_bcast_proto
op_assign
op_amp
id|rawmode_proto
suffix:semicolon
id|arc_proto_default
op_assign
op_amp
id|rawmode_proto
suffix:semicolon
)brace
macro_line|#ifdef MODULE
DECL|function|init_module
r_int
id|__init
id|init_module
c_func
(paren
r_void
)paren
(brace
id|printk
c_func
(paren
id|VERSION
)paren
suffix:semicolon
id|arcnet_raw_init
c_func
(paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|cleanup_module
r_void
id|cleanup_module
c_func
(paren
r_void
)paren
(brace
id|arcnet_unregister_proto
c_func
(paren
op_amp
id|rawmode_proto
)paren
suffix:semicolon
)brace
macro_line|#endif&t;&t;&t;&t;/* MODULE */
multiline_comment|/* packet receiver */
DECL|function|rx
r_static
r_void
id|rx
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_int
id|bufnum
comma
r_struct
id|archdr
op_star
id|pkthdr
comma
r_int
id|length
)paren
(brace
r_struct
id|arcnet_local
op_star
id|lp
op_assign
(paren
r_struct
id|arcnet_local
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
r_struct
id|archdr
op_star
id|pkt
op_assign
id|pkthdr
suffix:semicolon
r_int
id|ofs
suffix:semicolon
id|BUGMSG
c_func
(paren
id|D_DURING
comma
l_string|&quot;it&squot;s a raw packet (length=%d)&bslash;n&quot;
comma
id|length
)paren
suffix:semicolon
r_if
c_cond
(paren
id|length
op_ge
id|MinTU
)paren
id|ofs
op_assign
l_int|512
op_minus
id|length
suffix:semicolon
r_else
id|ofs
op_assign
l_int|256
op_minus
id|length
suffix:semicolon
id|skb
op_assign
id|alloc_skb
c_func
(paren
id|length
op_plus
id|ARC_HDR_SIZE
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
id|skb
op_eq
l_int|NULL
)paren
(brace
id|BUGMSG
c_func
(paren
id|D_NORMAL
comma
l_string|&quot;Memory squeeze, dropping packet.&bslash;n&quot;
)paren
suffix:semicolon
id|lp-&gt;stats.rx_dropped
op_increment
suffix:semicolon
r_return
suffix:semicolon
)brace
id|skb_put
c_func
(paren
id|skb
comma
id|length
op_plus
id|ARC_HDR_SIZE
)paren
suffix:semicolon
id|skb-&gt;dev
op_assign
id|dev
suffix:semicolon
id|pkt
op_assign
(paren
r_struct
id|archdr
op_star
)paren
id|skb-&gt;data
suffix:semicolon
id|skb-&gt;mac.raw
op_assign
id|skb-&gt;data
suffix:semicolon
id|skb_pull
c_func
(paren
id|skb
comma
id|ARC_HDR_SIZE
)paren
suffix:semicolon
multiline_comment|/* up to sizeof(pkt-&gt;soft) has already been copied from the card */
id|memcpy
c_func
(paren
id|pkt
comma
id|pkthdr
comma
r_sizeof
(paren
r_struct
id|archdr
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|length
OG
r_sizeof
(paren
id|pkt-&gt;soft
)paren
)paren
id|lp-&gt;hw
dot
id|copy_from_card
c_func
(paren
id|dev
comma
id|bufnum
comma
id|ofs
op_plus
r_sizeof
(paren
id|pkt-&gt;soft
)paren
comma
id|pkt-&gt;soft.raw
op_plus
r_sizeof
(paren
id|pkt-&gt;soft
)paren
comma
id|length
op_minus
r_sizeof
(paren
id|pkt-&gt;soft
)paren
)paren
suffix:semicolon
id|BUGLVL
c_func
(paren
id|D_SKB
)paren
id|arcnet_dump_skb
c_func
(paren
id|dev
comma
id|skb
comma
l_string|&quot;rx&quot;
)paren
suffix:semicolon
id|skb-&gt;protocol
op_assign
l_int|0
suffix:semicolon
id|netif_rx
c_func
(paren
id|skb
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Create the ARCnet hard/soft headers for raw mode.&n; * There aren&squot;t any soft headers in raw mode - not even the protocol id.&n; */
DECL|function|build_header
r_static
r_int
id|build_header
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_int
r_int
id|type
comma
r_uint8
id|daddr
)paren
(brace
r_struct
id|net_device
op_star
id|dev
op_assign
id|skb-&gt;dev
suffix:semicolon
r_int
id|hdr_size
op_assign
id|ARC_HDR_SIZE
suffix:semicolon
r_struct
id|archdr
op_star
id|pkt
op_assign
(paren
r_struct
id|archdr
op_star
)paren
id|skb_push
c_func
(paren
id|skb
comma
id|hdr_size
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Set the source hardware address.&n;&t; *&n;&t; * This is pretty pointless for most purposes, but it can help in&n;&t; * debugging.  ARCnet does not allow us to change the source address in&n;&t; * the actual packet sent)&n;&t; */
id|pkt-&gt;hard.source
op_assign
op_star
id|dev-&gt;dev_addr
suffix:semicolon
multiline_comment|/* see linux/net/ethernet/eth.c to see where I got the following */
r_if
c_cond
(paren
id|dev-&gt;flags
op_amp
(paren
id|IFF_LOOPBACK
op_or
id|IFF_NOARP
)paren
)paren
(brace
multiline_comment|/* &n;&t;&t; * FIXME: fill in the last byte of the dest ipaddr here to better&n;&t;&t; * comply with RFC1051 in &quot;noarp&quot; mode.&n;&t;&t; */
id|pkt-&gt;hard.dest
op_assign
l_int|0
suffix:semicolon
r_return
id|hdr_size
suffix:semicolon
)brace
multiline_comment|/* otherwise, just fill it in and go! */
id|pkt-&gt;hard.dest
op_assign
id|daddr
suffix:semicolon
r_return
id|hdr_size
suffix:semicolon
multiline_comment|/* success */
)brace
DECL|function|prepare_tx
r_static
r_int
id|prepare_tx
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_struct
id|archdr
op_star
id|pkt
comma
r_int
id|length
comma
r_int
id|bufnum
)paren
(brace
r_struct
id|arcnet_local
op_star
id|lp
op_assign
(paren
r_struct
id|arcnet_local
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_struct
id|arc_hardware
op_star
id|hard
op_assign
op_amp
id|pkt-&gt;hard
suffix:semicolon
r_int
id|ofs
suffix:semicolon
id|BUGMSG
c_func
(paren
id|D_DURING
comma
l_string|&quot;prepare_tx: txbufs=%d/%d/%d&bslash;n&quot;
comma
id|lp-&gt;next_tx
comma
id|lp-&gt;cur_tx
comma
id|bufnum
)paren
suffix:semicolon
id|length
op_sub_assign
id|ARC_HDR_SIZE
suffix:semicolon
multiline_comment|/* hard header is not included in packet length */
r_if
c_cond
(paren
id|length
OG
id|XMTU
)paren
(brace
multiline_comment|/* should never happen! other people already check for this. */
id|BUGMSG
c_func
(paren
id|D_NORMAL
comma
l_string|&quot;Bug!  prepare_tx with size %d (&gt; %d)&bslash;n&quot;
comma
id|length
comma
id|XMTU
)paren
suffix:semicolon
id|length
op_assign
id|XMTU
suffix:semicolon
)brace
r_if
c_cond
(paren
id|length
OG
id|MinTU
)paren
(brace
id|hard-&gt;offset
(braket
l_int|0
)braket
op_assign
l_int|0
suffix:semicolon
id|hard-&gt;offset
(braket
l_int|1
)braket
op_assign
id|ofs
op_assign
l_int|512
op_minus
id|length
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|length
OG
id|MTU
)paren
(brace
id|hard-&gt;offset
(braket
l_int|0
)braket
op_assign
l_int|0
suffix:semicolon
id|hard-&gt;offset
(braket
l_int|1
)braket
op_assign
id|ofs
op_assign
l_int|512
op_minus
id|length
op_minus
l_int|3
suffix:semicolon
)brace
r_else
id|hard-&gt;offset
(braket
l_int|0
)braket
op_assign
id|ofs
op_assign
l_int|256
op_minus
id|length
suffix:semicolon
id|lp-&gt;hw
dot
id|copy_to_card
c_func
(paren
id|dev
comma
id|bufnum
comma
l_int|0
comma
id|hard
comma
id|ARC_HDR_SIZE
)paren
suffix:semicolon
id|lp-&gt;hw
dot
id|copy_to_card
c_func
(paren
id|dev
comma
id|bufnum
comma
id|ofs
comma
op_amp
id|pkt-&gt;soft
comma
id|length
)paren
suffix:semicolon
id|lp-&gt;lastload_dest
op_assign
id|hard-&gt;dest
suffix:semicolon
r_return
l_int|1
suffix:semicolon
multiline_comment|/* done */
)brace
eof
