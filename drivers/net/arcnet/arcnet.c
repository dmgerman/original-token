multiline_comment|/*&n; * Linux ARCnet driver - device-independent routines&n; * &n; * Written 1997 by David Woodhouse.&n; * Written 1994-1999 by Avery Pennarun.&n; * Written 1999-2000 by Martin Mares &lt;mj@suse.cz&gt;.&n; * Derived from skeleton.c by Donald Becker.&n; *&n; * Special thanks to Contemporary Controls, Inc. (www.ccontrols.com)&n; *  for sponsoring the further development of this driver.&n; *&n; * **********************&n; *&n; * The original copyright was as follows:&n; *&n; * skeleton.c Written 1993 by Donald Becker.&n; * Copyright 1993 United States Government as represented by the&n; * Director, National Security Agency.  This software may only be used&n; * and distributed according to the terms of the GNU Public License as&n; * modified by SRC, incorporated herein by reference.&n; *&n; * **********************&n; * &n; * The change log is now in a file called ChangeLog in this directory.&n; *&n; * Sources:&n; *  - Crynwr arcnet.com/arcether.com packet drivers.&n; *  - arcnet.c v0.00 dated 1/1/94 and apparently by &n; *     Donald Becker - it didn&squot;t work :)&n; *  - skeleton.c v0.05 dated 11/16/93 by Donald Becker&n; *     (from Linux Kernel 1.1.45)&n; *  - RFC&squot;s 1201 and 1051 - re: TCP/IP over ARCnet&n; *  - The official ARCnet COM9026 data sheets (!) thanks to&n; *     Ken Cornetet &lt;kcornete@nyx10.cs.du.edu&gt;&n; *  - The official ARCnet COM20020 data sheets.&n; *  - Information on some more obscure ARCnet controller chips, thanks&n; *     to the nice people at SMSC.&n; *  - net/inet/eth.c (from kernel 1.1.50) for header-building info.&n; *  - Alternate Linux ARCnet source by V.Shergin &lt;vsher@sao.stavropol.su&gt;&n; *  - Textual information and more alternate source from Joachim Koenig&n; *     &lt;jojo@repas.de&gt;&n; */
DECL|macro|VERSION
mdefine_line|#define VERSION &quot;arcnet: v3.93 BETA 2000/04/29 - by Avery Pennarun et al.&bslash;n&quot;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;linux/netdevice.h&gt;
macro_line|#include &lt;linux/if_arp.h&gt;
macro_line|#include &lt;net/arp.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/arcdevice.h&gt;
multiline_comment|/* &quot;do nothing&quot; functions for protocol drivers */
r_static
r_void
id|null_rx
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_int
id|bufnum
comma
r_struct
id|archdr
op_star
id|pkthdr
comma
r_int
id|length
)paren
suffix:semicolon
r_static
r_int
id|null_build_header
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_int
r_int
id|type
comma
r_uint8
id|daddr
)paren
suffix:semicolon
r_static
r_int
id|null_prepare_tx
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_struct
id|archdr
op_star
id|pkt
comma
r_int
id|length
comma
r_int
id|bufnum
)paren
suffix:semicolon
multiline_comment|/*&n; * one ArcProto per possible proto ID.  None of the elements of&n; * arc_proto_map are allowed to be NULL; they will get set to&n; * arc_proto_default instead.  It also must not be NULL; if you would like&n; * to set it to NULL, set it to &amp;arc_proto_null instead.&n; */
DECL|variable|arc_proto_map
DECL|variable|arc_proto_default
DECL|variable|arc_bcast_proto
r_struct
id|ArcProto
op_star
id|arc_proto_map
(braket
l_int|256
)braket
comma
op_star
id|arc_proto_default
comma
op_star
id|arc_bcast_proto
suffix:semicolon
DECL|variable|arc_proto_null
r_struct
id|ArcProto
id|arc_proto_null
op_assign
(brace
l_char|&squot;?&squot;
comma
id|XMTU
comma
id|null_rx
comma
id|null_build_header
comma
id|null_prepare_tx
)brace
suffix:semicolon
multiline_comment|/* Exported function prototypes */
DECL|variable|arcnet_debug
r_int
id|arcnet_debug
op_assign
id|ARCNET_DEBUG
suffix:semicolon
DECL|variable|arc_proto_map
id|EXPORT_SYMBOL
c_func
(paren
id|arc_proto_map
)paren
suffix:semicolon
DECL|variable|arc_proto_default
id|EXPORT_SYMBOL
c_func
(paren
id|arc_proto_default
)paren
suffix:semicolon
DECL|variable|arc_bcast_proto
id|EXPORT_SYMBOL
c_func
(paren
id|arc_bcast_proto
)paren
suffix:semicolon
DECL|variable|arc_proto_null
id|EXPORT_SYMBOL
c_func
(paren
id|arc_proto_null
)paren
suffix:semicolon
DECL|variable|arcnet_unregister_proto
id|EXPORT_SYMBOL
c_func
(paren
id|arcnet_unregister_proto
)paren
suffix:semicolon
DECL|variable|arcnet_debug
id|EXPORT_SYMBOL
c_func
(paren
id|arcnet_debug
)paren
suffix:semicolon
DECL|variable|arcdev_setup
id|EXPORT_SYMBOL
c_func
(paren
id|arcdev_setup
)paren
suffix:semicolon
DECL|variable|arcnet_interrupt
id|EXPORT_SYMBOL
c_func
(paren
id|arcnet_interrupt
)paren
suffix:semicolon
multiline_comment|/* Internal function prototypes */
r_static
r_int
id|arcnet_open
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_int
id|arcnet_close
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_int
id|arcnet_send_packet
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_void
id|arcnet_timeout
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_int
id|arcnet_header
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|net_device
op_star
id|dev
comma
r_int
r_int
id|type
comma
r_void
op_star
id|daddr
comma
r_void
op_star
id|saddr
comma
r_int
id|len
)paren
suffix:semicolon
r_static
r_int
id|arcnet_rebuild_header
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
)paren
suffix:semicolon
r_static
r_struct
id|net_device_stats
op_star
id|arcnet_get_stats
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_int
id|go_tx
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
DECL|function|arcnet_init
r_void
id|__init
id|arcnet_init
c_func
(paren
r_void
)paren
(brace
r_static
r_int
id|arcnet_inited
op_assign
l_int|0
suffix:semicolon
r_int
id|count
suffix:semicolon
r_if
c_cond
(paren
id|arcnet_inited
op_increment
)paren
r_return
suffix:semicolon
id|printk
c_func
(paren
id|VERSION
)paren
suffix:semicolon
macro_line|#ifdef ALPHA_WARNING
id|BUGLVL
c_func
(paren
id|D_EXTRA
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;arcnet: ***&bslash;n&quot;
l_string|&quot;arcnet: * Read arcnet.txt for important release notes!&bslash;n&quot;
l_string|&quot;arcnet: *&bslash;n&quot;
l_string|&quot;arcnet: * This is an ALPHA version! (Last stable release: v3.02)  E-mail&bslash;n&quot;
l_string|&quot;arcnet: * me if you have any questions, comments, or bug reports.&bslash;n&quot;
l_string|&quot;arcnet: ***&bslash;n&quot;
)paren
suffix:semicolon
)brace
macro_line|#endif
multiline_comment|/* initialize the protocol map */
id|arc_proto_default
op_assign
id|arc_bcast_proto
op_assign
op_amp
id|arc_proto_null
suffix:semicolon
r_for
c_loop
(paren
id|count
op_assign
l_int|0
suffix:semicolon
id|count
OL
l_int|256
suffix:semicolon
id|count
op_increment
)paren
id|arc_proto_map
(braket
id|count
)braket
op_assign
id|arc_proto_default
suffix:semicolon
id|BUGLVL
c_func
(paren
id|D_DURING
)paren
id|printk
c_func
(paren
l_string|&quot;arcnet: struct sizes: %d %d %d %d %d&bslash;n&quot;
comma
r_sizeof
(paren
r_struct
id|arc_hardware
)paren
comma
r_sizeof
(paren
r_struct
id|arc_rfc1201
)paren
comma
r_sizeof
(paren
r_struct
id|arc_rfc1051
)paren
comma
r_sizeof
(paren
r_struct
id|arc_eth_encap
)paren
comma
r_sizeof
(paren
r_struct
id|archdr
)paren
)paren
suffix:semicolon
macro_line|#ifdef CONFIG_ARCNET&t;&t;/* We&squot;re not built as a module */
id|printk
c_func
(paren
l_string|&quot;arcnet: Available protocols:&quot;
)paren
suffix:semicolon
macro_line|#ifdef CONFIG_ARCNET_1201
id|printk
c_func
(paren
l_string|&quot; RFC1201&quot;
)paren
suffix:semicolon
id|arcnet_rfc1201_init
c_func
(paren
)paren
suffix:semicolon
macro_line|#endif
macro_line|#ifdef CONFIG_ARCNET_1051
id|printk
c_func
(paren
l_string|&quot; RFC1051&quot;
)paren
suffix:semicolon
id|arcnet_rfc1051_init
c_func
(paren
)paren
suffix:semicolon
macro_line|#endif
macro_line|#ifdef CONFIG_ARCNET_RAW
id|printk
c_func
(paren
l_string|&quot; RAW&quot;
)paren
suffix:semicolon
id|arcnet_raw_init
c_func
(paren
)paren
suffix:semicolon
macro_line|#endif
id|printk
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#ifdef CONFIG_ARCNET_COM90xx
id|com90xx_probe
c_func
(paren
l_int|NULL
)paren
suffix:semicolon
macro_line|#endif
macro_line|#endif
)brace
macro_line|#ifdef MODULE
DECL|variable|debug
r_static
r_int
id|debug
op_assign
id|ARCNET_DEBUG
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|debug
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
DECL|function|init_module
r_int
id|__init
id|init_module
c_func
(paren
r_void
)paren
(brace
id|arcnet_debug
op_assign
id|debug
suffix:semicolon
id|arcnet_init
c_func
(paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|cleanup_module
r_void
id|cleanup_module
c_func
(paren
r_void
)paren
(brace
)brace
macro_line|#endif
multiline_comment|/*&n; * Dump the contents of an sk_buff&n; */
macro_line|#if ARCNET_DEBUG_MAX &amp; D_SKB
DECL|function|arcnet_dump_skb
r_void
id|arcnet_dump_skb
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_struct
id|sk_buff
op_star
id|skb
comma
r_char
op_star
id|desc
)paren
(brace
r_int
id|i
suffix:semicolon
r_int
id|flags
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%6s: skb dump (%s) follows:&quot;
comma
id|dev-&gt;name
comma
id|desc
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|skb-&gt;len
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|i
op_mod
l_int|16
op_eq
l_int|0
)paren
id|printk
c_func
(paren
l_string|&quot;&bslash;n&quot;
id|KERN_DEBUG
l_string|&quot;[%04X] &quot;
comma
id|i
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;%02X &quot;
comma
(paren
(paren
id|u_char
op_star
)paren
id|skb-&gt;data
)paren
(braket
id|i
)braket
)paren
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
DECL|variable|arcnet_dump_skb
id|EXPORT_SYMBOL
c_func
(paren
id|arcnet_dump_skb
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/*&n; * Dump the contents of an ARCnet buffer&n; */
macro_line|#if (ARCNET_DEBUG_MAX &amp; (D_RX | D_TX))
DECL|function|arcnet_dump_packet
r_void
id|arcnet_dump_packet
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_int
id|bufnum
comma
r_char
op_star
id|desc
)paren
(brace
r_struct
id|arcnet_local
op_star
id|lp
op_assign
(paren
r_struct
id|arcnet_local
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_int
id|i
comma
id|length
suffix:semicolon
r_int
id|flags
suffix:semicolon
r_static
r_uint8
id|buf
(braket
l_int|512
)braket
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|lp-&gt;hw
dot
id|copy_from_card
c_func
(paren
id|dev
comma
id|bufnum
comma
l_int|0
comma
id|buf
comma
l_int|512
)paren
suffix:semicolon
multiline_comment|/* if the offset[0] byte is nonzero, this is a 256-byte packet */
id|length
op_assign
(paren
id|buf
(braket
l_int|2
)braket
ques
c_cond
l_int|256
suffix:colon
l_int|512
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%6s: packet dump (%s) follows:&quot;
comma
id|dev-&gt;name
comma
id|desc
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|length
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|i
op_mod
l_int|16
op_eq
l_int|0
)paren
id|printk
c_func
(paren
l_string|&quot;&bslash;n&quot;
id|KERN_DEBUG
l_string|&quot;[%04X] &quot;
comma
id|i
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;%02X &quot;
comma
id|buf
(braket
id|i
)braket
)paren
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
DECL|variable|arcnet_dump_packet
id|EXPORT_SYMBOL
c_func
(paren
id|arcnet_dump_packet
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/*&n; * Unregister a protocol driver from the arc_proto_map.  Protocol drivers&n; * are responsible for registering themselves, but the unregister routine&n; * is pretty generic so we&squot;ll do it here.&n; */
DECL|function|arcnet_unregister_proto
r_void
id|arcnet_unregister_proto
c_func
(paren
r_struct
id|ArcProto
op_star
id|proto
)paren
(brace
r_int
id|count
suffix:semicolon
r_if
c_cond
(paren
id|arc_proto_default
op_eq
id|proto
)paren
id|arc_proto_default
op_assign
op_amp
id|arc_proto_null
suffix:semicolon
r_if
c_cond
(paren
id|arc_bcast_proto
op_eq
id|proto
)paren
id|arc_bcast_proto
op_assign
id|arc_proto_default
suffix:semicolon
r_for
c_loop
(paren
id|count
op_assign
l_int|0
suffix:semicolon
id|count
OL
l_int|256
suffix:semicolon
id|count
op_increment
)paren
(brace
r_if
c_cond
(paren
id|arc_proto_map
(braket
id|count
)braket
op_eq
id|proto
)paren
id|arc_proto_map
(braket
id|count
)braket
op_assign
id|arc_proto_default
suffix:semicolon
)brace
)brace
multiline_comment|/*&n; * Add a buffer to the queue.  Only the interrupt handler is allowed to do&n; * this, unless interrupts are disabled.&n; * &n; * Note: we don&squot;t check for a full queue, since there aren&squot;t enough buffers&n; * to more than fill it.&n; */
DECL|function|release_arcbuf
r_static
r_void
id|release_arcbuf
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_int
id|bufnum
)paren
(brace
r_struct
id|arcnet_local
op_star
id|lp
op_assign
(paren
r_struct
id|arcnet_local
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_int
id|i
suffix:semicolon
id|lp-&gt;buf_queue
(braket
id|lp-&gt;first_free_buf
op_increment
)braket
op_assign
id|bufnum
suffix:semicolon
id|lp-&gt;first_free_buf
op_mod_assign
l_int|5
suffix:semicolon
id|BUGLVL
c_func
(paren
id|D_DURING
)paren
(brace
id|BUGMSG
c_func
(paren
id|D_DURING
comma
l_string|&quot;release_arcbuf: freed #%d; buffer queue is now: &quot;
comma
id|bufnum
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
id|lp-&gt;next_buf
suffix:semicolon
id|i
op_ne
id|lp-&gt;first_free_buf
suffix:semicolon
id|i
op_assign
op_increment
id|i
op_mod
l_int|5
)paren
id|BUGMSG2
c_func
(paren
id|D_DURING
comma
l_string|&quot;#%d &quot;
comma
id|lp-&gt;buf_queue
(braket
id|i
)braket
)paren
suffix:semicolon
id|BUGMSG2
c_func
(paren
id|D_DURING
comma
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/*&n; * Get a buffer from the queue.  If this returns -1, there are no buffers&n; * available.&n; */
DECL|function|get_arcbuf
r_static
r_int
id|get_arcbuf
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|arcnet_local
op_star
id|lp
op_assign
(paren
r_struct
id|arcnet_local
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_int
id|buf
op_assign
op_minus
l_int|1
comma
id|i
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|atomic_dec_and_test
c_func
(paren
op_amp
id|lp-&gt;buf_lock
)paren
)paren
multiline_comment|/* already in this function */
id|BUGMSG
c_func
(paren
id|D_NORMAL
comma
l_string|&quot;get_arcbuf: overlap (%d)!&bslash;n&quot;
comma
id|lp-&gt;buf_lock.counter
)paren
suffix:semicolon
r_else
(brace
multiline_comment|/* we can continue */
r_if
c_cond
(paren
id|lp-&gt;next_buf
op_ge
l_int|5
)paren
id|lp-&gt;next_buf
op_sub_assign
l_int|5
suffix:semicolon
r_if
c_cond
(paren
id|lp-&gt;next_buf
op_eq
id|lp-&gt;first_free_buf
)paren
id|BUGMSG
c_func
(paren
id|D_NORMAL
comma
l_string|&quot;get_arcbuf: BUG: no buffers are available??&bslash;n&quot;
)paren
suffix:semicolon
r_else
(brace
id|buf
op_assign
id|lp-&gt;buf_queue
(braket
id|lp-&gt;next_buf
op_increment
)braket
suffix:semicolon
id|lp-&gt;next_buf
op_mod_assign
l_int|5
suffix:semicolon
)brace
)brace
id|BUGLVL
c_func
(paren
id|D_DURING
)paren
(brace
id|BUGMSG
c_func
(paren
id|D_DURING
comma
l_string|&quot;get_arcbuf: got #%d; buffer queue is now: &quot;
comma
id|buf
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
id|lp-&gt;next_buf
suffix:semicolon
id|i
op_ne
id|lp-&gt;first_free_buf
suffix:semicolon
id|i
op_assign
op_increment
id|i
op_mod
l_int|5
)paren
id|BUGMSG2
c_func
(paren
id|D_DURING
comma
l_string|&quot;#%d &quot;
comma
id|lp-&gt;buf_queue
(braket
id|i
)braket
)paren
suffix:semicolon
id|BUGMSG2
c_func
(paren
id|D_DURING
comma
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
)brace
id|atomic_inc
c_func
(paren
op_amp
id|lp-&gt;buf_lock
)paren
suffix:semicolon
r_return
id|buf
suffix:semicolon
)brace
DECL|function|choose_mtu
r_static
r_int
id|choose_mtu
c_func
(paren
r_void
)paren
(brace
r_int
id|count
comma
id|mtu
op_assign
l_int|65535
suffix:semicolon
multiline_comment|/* choose the smallest MTU of all available encaps */
r_for
c_loop
(paren
id|count
op_assign
l_int|0
suffix:semicolon
id|count
OL
l_int|256
suffix:semicolon
id|count
op_increment
)paren
(brace
r_if
c_cond
(paren
id|arc_proto_map
(braket
id|count
)braket
op_ne
op_amp
id|arc_proto_null
op_logical_and
id|arc_proto_map
(braket
id|count
)braket
op_member_access_from_pointer
id|mtu
OL
id|mtu
)paren
(brace
id|mtu
op_assign
id|arc_proto_map
(braket
id|count
)braket
op_member_access_from_pointer
id|mtu
suffix:semicolon
)brace
)brace
r_return
id|mtu
op_eq
l_int|65535
ques
c_cond
id|XMTU
suffix:colon
id|mtu
suffix:semicolon
)brace
multiline_comment|/* Setup a struct device for ARCnet. */
DECL|function|arcdev_setup
r_void
id|arcdev_setup
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
id|dev-&gt;type
op_assign
id|ARPHRD_ARCNET
suffix:semicolon
id|dev-&gt;hard_header_len
op_assign
r_sizeof
(paren
r_struct
id|archdr
)paren
suffix:semicolon
id|dev-&gt;mtu
op_assign
id|choose_mtu
c_func
(paren
)paren
suffix:semicolon
id|dev-&gt;addr_len
op_assign
l_int|1
suffix:semicolon
id|dev-&gt;tx_queue_len
op_assign
l_int|30
suffix:semicolon
id|dev-&gt;broadcast
(braket
l_int|0
)braket
op_assign
l_int|0x00
suffix:semicolon
multiline_comment|/* for us, broadcasts are address 0 */
id|dev-&gt;watchdog_timeo
op_assign
id|TX_TIMEOUT
suffix:semicolon
multiline_comment|/* New-style flags. */
id|dev-&gt;flags
op_assign
id|IFF_BROADCAST
suffix:semicolon
multiline_comment|/*&n;&t; * Put in this stuff here, so we don&squot;t have to export the symbols to&n;&t; * the chipset drivers.&n;&t; */
id|dev-&gt;open
op_assign
id|arcnet_open
suffix:semicolon
id|dev-&gt;stop
op_assign
id|arcnet_close
suffix:semicolon
id|dev-&gt;hard_start_xmit
op_assign
id|arcnet_send_packet
suffix:semicolon
id|dev-&gt;tx_timeout
op_assign
id|arcnet_timeout
suffix:semicolon
id|dev-&gt;get_stats
op_assign
id|arcnet_get_stats
suffix:semicolon
id|dev-&gt;hard_header
op_assign
id|arcnet_header
suffix:semicolon
id|dev-&gt;rebuild_header
op_assign
id|arcnet_rebuild_header
suffix:semicolon
id|dev_init_buffers
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Open/initialize the board.  This is called sometime after booting when&n; * the &squot;ifconfig&squot; program is run.&n; *&n; * This routine should set everything up anew at each open, even registers&n; * that &quot;should&quot; only need to be set once at boot, so that there is&n; * non-reboot way to recover if something goes wrong.&n; */
DECL|function|arcnet_open
r_static
r_int
id|arcnet_open
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|arcnet_local
op_star
id|lp
op_assign
(paren
r_struct
id|arcnet_local
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_int
id|count
comma
id|newmtu
suffix:semicolon
id|BUGLVL
c_func
(paren
id|D_PROTO
)paren
(brace
r_int
id|count
suffix:semicolon
id|BUGMSG
c_func
(paren
id|D_PROTO
comma
l_string|&quot;protocol map (default is &squot;%c&squot;): &quot;
comma
id|arc_proto_default-&gt;suffix
)paren
suffix:semicolon
r_for
c_loop
(paren
id|count
op_assign
l_int|0
suffix:semicolon
id|count
OL
l_int|256
suffix:semicolon
id|count
op_increment
)paren
id|BUGMSG2
c_func
(paren
id|D_PROTO
comma
l_string|&quot;%c&quot;
comma
id|arc_proto_map
(braket
id|count
)braket
op_member_access_from_pointer
id|suffix
)paren
suffix:semicolon
id|BUGMSG2
c_func
(paren
id|D_PROTO
comma
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
)brace
id|BUGMSG
c_func
(paren
id|D_INIT
comma
l_string|&quot;arcnet_open: resetting card.&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* try to put the card in a defined state - if it fails the first&n;&t; * time, actually reset it.&n;&t; */
r_if
c_cond
(paren
id|ARCRESET
c_func
(paren
l_int|0
)paren
op_logical_and
id|ARCRESET
c_func
(paren
l_int|1
)paren
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
id|newmtu
op_assign
id|choose_mtu
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|newmtu
OL
id|dev-&gt;mtu
)paren
id|dev-&gt;mtu
op_assign
id|newmtu
suffix:semicolon
multiline_comment|/* autodetect the encapsulation for each host. */
id|memset
c_func
(paren
id|lp-&gt;default_proto
comma
l_int|0
comma
r_sizeof
(paren
id|lp-&gt;default_proto
)paren
)paren
suffix:semicolon
multiline_comment|/* the broadcast address is special - use the &squot;bcast&squot; protocol */
r_for
c_loop
(paren
id|count
op_assign
l_int|0
suffix:semicolon
id|count
OL
l_int|256
suffix:semicolon
id|count
op_increment
)paren
(brace
r_if
c_cond
(paren
id|arc_proto_map
(braket
id|count
)braket
op_eq
id|arc_bcast_proto
)paren
(brace
id|lp-&gt;default_proto
(braket
l_int|0
)braket
op_assign
id|count
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
multiline_comment|/* initialize buffers */
id|atomic_set
c_func
(paren
op_amp
id|lp-&gt;buf_lock
comma
l_int|1
)paren
suffix:semicolon
id|lp-&gt;next_buf
op_assign
id|lp-&gt;first_free_buf
op_assign
l_int|0
suffix:semicolon
id|release_arcbuf
c_func
(paren
id|dev
comma
l_int|0
)paren
suffix:semicolon
id|release_arcbuf
c_func
(paren
id|dev
comma
l_int|1
)paren
suffix:semicolon
id|release_arcbuf
c_func
(paren
id|dev
comma
l_int|2
)paren
suffix:semicolon
id|release_arcbuf
c_func
(paren
id|dev
comma
l_int|3
)paren
suffix:semicolon
id|lp-&gt;cur_tx
op_assign
id|lp-&gt;next_tx
op_assign
op_minus
l_int|1
suffix:semicolon
id|lp-&gt;cur_rx
op_assign
op_minus
l_int|1
suffix:semicolon
id|lp-&gt;rfc1201.sequence
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* bring up the hardware driver */
id|ARCOPEN
c_func
(paren
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;dev_addr
(braket
l_int|0
)braket
op_eq
l_int|0
)paren
id|BUGMSG
c_func
(paren
id|D_NORMAL
comma
l_string|&quot;WARNING!  Station address 00 is reserved &quot;
l_string|&quot;for broadcasts!&bslash;n&quot;
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
id|dev-&gt;dev_addr
(braket
l_int|0
)braket
op_eq
l_int|255
)paren
id|BUGMSG
c_func
(paren
id|D_NORMAL
comma
l_string|&quot;WARNING!  Station address FF may confuse &quot;
l_string|&quot;DOS networking programs!&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ASTATUS
c_func
(paren
)paren
op_amp
id|RESETflag
)paren
id|ACOMMAND
c_func
(paren
id|CFLAGScmd
op_or
id|RESETclear
)paren
suffix:semicolon
multiline_comment|/* make sure we&squot;re ready to receive IRQ&squot;s. */
id|AINTMASK
c_func
(paren
l_int|0
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|1
)paren
suffix:semicolon
multiline_comment|/* give it time to set the mask before&n;&t;&t;&t;&t; * we reset it again. (may not even be&n;&t;&t;&t;&t; * necessary)&n;&t;&t;&t;&t; */
id|lp-&gt;intmask
op_assign
id|NORXflag
op_or
id|RECONflag
suffix:semicolon
id|AINTMASK
c_func
(paren
id|lp-&gt;intmask
)paren
suffix:semicolon
id|netif_start_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* The inverse routine to arcnet_open - shuts down the card. */
DECL|function|arcnet_close
r_static
r_int
id|arcnet_close
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|arcnet_local
op_star
id|lp
op_assign
(paren
r_struct
id|arcnet_local
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|netif_stop_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
multiline_comment|/* flush TX and disable RX */
id|AINTMASK
c_func
(paren
l_int|0
)paren
suffix:semicolon
id|ACOMMAND
c_func
(paren
id|NOTXcmd
)paren
suffix:semicolon
multiline_comment|/* stop transmit */
id|ACOMMAND
c_func
(paren
id|NORXcmd
)paren
suffix:semicolon
multiline_comment|/* disable receive */
id|mdelay
c_func
(paren
l_int|1
)paren
suffix:semicolon
multiline_comment|/* shut down the card */
id|ARCOPEN
c_func
(paren
l_int|0
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|arcnet_header
r_static
r_int
id|arcnet_header
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|net_device
op_star
id|dev
comma
r_int
r_int
id|type
comma
r_void
op_star
id|daddr
comma
r_void
op_star
id|saddr
comma
r_int
id|len
)paren
(brace
r_struct
id|arcnet_local
op_star
id|lp
op_assign
(paren
r_struct
id|arcnet_local
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_uint8
id|_daddr
comma
id|proto_num
suffix:semicolon
r_struct
id|ArcProto
op_star
id|proto
suffix:semicolon
id|BUGMSG
c_func
(paren
id|D_DURING
comma
l_string|&quot;create header from %d to %d; protocol %d (%Xh); size %u.&bslash;n&quot;
comma
id|saddr
ques
c_cond
op_star
(paren
r_uint8
op_star
)paren
id|saddr
suffix:colon
op_minus
l_int|1
comma
id|daddr
ques
c_cond
op_star
(paren
r_uint8
op_star
)paren
id|daddr
suffix:colon
op_minus
l_int|1
comma
id|type
comma
id|type
comma
id|len
)paren
suffix:semicolon
r_if
c_cond
(paren
id|len
op_ne
id|skb-&gt;len
)paren
id|BUGMSG
c_func
(paren
id|D_NORMAL
comma
l_string|&quot;arcnet_header: Yikes!  skb-&gt;len(%d) != len(%d)!&bslash;n&quot;
comma
id|skb-&gt;len
comma
id|len
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * if the dest addr isn&squot;t provided, we can&squot;t choose an encapsulation!&n;&t; * Store the packet type (eg. ETH_P_IP) for now, and we&squot;ll push on a&n;&t; * real header when we do rebuild_header. &n;&t; */
r_if
c_cond
(paren
op_logical_neg
id|daddr
)paren
(brace
op_star
(paren
r_uint16
op_star
)paren
id|skb_push
c_func
(paren
id|skb
comma
l_int|2
)paren
op_assign
id|type
suffix:semicolon
r_if
c_cond
(paren
id|skb-&gt;nh.raw
op_minus
id|skb-&gt;mac.raw
op_ne
l_int|2
)paren
id|BUGMSG
c_func
(paren
id|D_NORMAL
comma
l_string|&quot;arcnet_header: Yikes!  diff (%d) is not 2!&bslash;n&quot;
comma
id|skb-&gt;nh.raw
op_minus
id|skb-&gt;mac.raw
)paren
suffix:semicolon
r_return
op_minus
l_int|2
suffix:semicolon
multiline_comment|/* return error -- can&squot;t transmit yet! */
)brace
multiline_comment|/* otherwise, we can just add the header as usual. */
id|_daddr
op_assign
op_star
(paren
r_uint8
op_star
)paren
id|daddr
suffix:semicolon
id|proto_num
op_assign
id|lp-&gt;default_proto
(braket
id|_daddr
)braket
suffix:semicolon
id|proto
op_assign
id|arc_proto_map
(braket
id|proto_num
)braket
suffix:semicolon
id|BUGMSG
c_func
(paren
id|D_DURING
comma
l_string|&quot;building header for %02Xh using protocol &squot;%c&squot;&bslash;n&quot;
comma
id|proto_num
comma
id|proto-&gt;suffix
)paren
suffix:semicolon
r_if
c_cond
(paren
id|proto
op_eq
op_amp
id|arc_proto_null
op_logical_and
id|arc_bcast_proto
op_ne
id|proto
)paren
(brace
id|BUGMSG
c_func
(paren
id|D_DURING
comma
l_string|&quot;actually, let&squot;s use &squot;%c&squot; instead.&bslash;n&quot;
comma
id|arc_bcast_proto-&gt;suffix
)paren
suffix:semicolon
id|proto
op_assign
id|arc_bcast_proto
suffix:semicolon
)brace
r_return
id|proto
op_member_access_from_pointer
id|build_header
c_func
(paren
id|skb
comma
id|type
comma
id|_daddr
)paren
suffix:semicolon
)brace
multiline_comment|/* &n; * Rebuild the ARCnet hard header. This is called after an ARP (or in the&n; * future other address resolution) has completed on this sk_buff. We now&n; * let ARP fill in the destination field.&n; */
DECL|function|arcnet_rebuild_header
r_static
r_int
id|arcnet_rebuild_header
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
)paren
(brace
r_struct
id|net_device
op_star
id|dev
op_assign
id|skb-&gt;dev
suffix:semicolon
r_struct
id|arcnet_local
op_star
id|lp
op_assign
(paren
r_struct
id|arcnet_local
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_int
id|status
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* default is failure */
r_int
r_int
id|type
suffix:semicolon
r_uint8
id|daddr
suffix:semicolon
r_if
c_cond
(paren
id|skb-&gt;nh.raw
op_minus
id|skb-&gt;mac.raw
op_ne
l_int|2
)paren
(brace
id|BUGMSG
c_func
(paren
id|D_NORMAL
comma
l_string|&quot;rebuild_header: shouldn&squot;t be here! (hdrsize=%d)&bslash;n&quot;
comma
id|skb-&gt;nh.raw
op_minus
id|skb-&gt;mac.raw
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|type
op_assign
op_star
(paren
r_uint16
op_star
)paren
id|skb_pull
c_func
(paren
id|skb
comma
l_int|2
)paren
suffix:semicolon
r_if
c_cond
(paren
id|type
op_eq
id|ETH_P_IP
)paren
(brace
macro_line|#ifdef CONFIG_INET
id|BUGMSG
c_func
(paren
id|D_DURING
comma
l_string|&quot;rebuild header for ethernet protocol %Xh&bslash;n&quot;
comma
id|type
)paren
suffix:semicolon
id|status
op_assign
id|arp_find
c_func
(paren
op_amp
id|daddr
comma
id|skb
)paren
ques
c_cond
l_int|1
suffix:colon
l_int|0
suffix:semicolon
id|BUGMSG
c_func
(paren
id|D_DURING
comma
l_string|&quot; rebuilt: dest is %d; protocol %Xh&bslash;n&quot;
comma
id|daddr
comma
id|type
)paren
suffix:semicolon
macro_line|#endif
)brace
r_else
(brace
id|BUGMSG
c_func
(paren
id|D_NORMAL
comma
l_string|&quot;I don&squot;t understand ethernet protocol %Xh addresses!&bslash;n&quot;
comma
id|type
)paren
suffix:semicolon
id|lp-&gt;stats.tx_errors
op_increment
suffix:semicolon
id|lp-&gt;stats.tx_aborted_errors
op_increment
suffix:semicolon
)brace
multiline_comment|/* if we couldn&squot;t resolve the address... give up. */
r_if
c_cond
(paren
op_logical_neg
id|status
)paren
r_return
l_int|0
suffix:semicolon
multiline_comment|/* add the _real_ header this time! */
id|arc_proto_map
(braket
id|lp-&gt;default_proto
(braket
id|daddr
)braket
)braket
op_member_access_from_pointer
id|build_header
c_func
(paren
id|skb
comma
id|type
comma
id|daddr
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
multiline_comment|/* success */
)brace
multiline_comment|/* Called by the kernel in order to transmit a packet. */
DECL|function|arcnet_send_packet
r_static
r_int
id|arcnet_send_packet
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|arcnet_local
op_star
id|lp
op_assign
(paren
r_struct
id|arcnet_local
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_struct
id|archdr
op_star
id|pkt
suffix:semicolon
r_struct
id|arc_rfc1201
op_star
id|soft
suffix:semicolon
r_struct
id|ArcProto
op_star
id|proto
suffix:semicolon
r_int
id|txbuf
suffix:semicolon
id|BUGMSG
c_func
(paren
id|D_DURING
comma
l_string|&quot;transmit requested (status=%Xh, txbufs=%d/%d, len=%d)&bslash;n&quot;
comma
id|ASTATUS
c_func
(paren
)paren
comma
id|lp-&gt;cur_tx
comma
id|lp-&gt;next_tx
comma
id|skb-&gt;len
)paren
suffix:semicolon
id|pkt
op_assign
(paren
r_struct
id|archdr
op_star
)paren
id|skb-&gt;data
suffix:semicolon
id|soft
op_assign
op_amp
id|pkt-&gt;soft.rfc1201
suffix:semicolon
id|proto
op_assign
id|arc_proto_map
(braket
id|soft-&gt;proto
)braket
suffix:semicolon
id|BUGMSG
c_func
(paren
id|D_SKB_SIZE
comma
l_string|&quot;skb: transmitting %d bytes to %02X&bslash;n&quot;
comma
id|skb-&gt;len
comma
id|pkt-&gt;hard.dest
)paren
suffix:semicolon
id|BUGLVL
c_func
(paren
id|D_SKB
)paren
id|arcnet_dump_skb
c_func
(paren
id|dev
comma
id|skb
comma
l_string|&quot;tx&quot;
)paren
suffix:semicolon
multiline_comment|/* fits in one packet? */
r_if
c_cond
(paren
id|skb-&gt;len
op_minus
id|ARC_HDR_SIZE
OG
id|XMTU
op_logical_and
op_logical_neg
id|proto-&gt;continue_tx
)paren
(brace
id|BUGMSG
c_func
(paren
id|D_NORMAL
comma
l_string|&quot;fixme: packet too large: compensating badly!&bslash;n&quot;
)paren
suffix:semicolon
id|dev_kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
multiline_comment|/* don&squot;t try again */
)brace
multiline_comment|/* We&squot;re busy transmitting a packet... */
id|netif_stop_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
id|AINTMASK
c_func
(paren
l_int|0
)paren
suffix:semicolon
id|txbuf
op_assign
id|get_arcbuf
c_func
(paren
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|txbuf
op_ne
op_minus
l_int|1
)paren
(brace
r_if
c_cond
(paren
id|proto
op_member_access_from_pointer
id|prepare_tx
c_func
(paren
id|dev
comma
id|pkt
comma
id|skb-&gt;len
comma
id|txbuf
)paren
)paren
(brace
multiline_comment|/* done right away */
id|lp-&gt;stats.tx_bytes
op_add_assign
id|skb-&gt;len
suffix:semicolon
id|dev_kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* do it the &squot;split&squot; way */
id|lp-&gt;outgoing.proto
op_assign
id|proto
suffix:semicolon
id|lp-&gt;outgoing.skb
op_assign
id|skb
suffix:semicolon
id|lp-&gt;outgoing.pkt
op_assign
id|pkt
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|proto-&gt;continue_tx
)paren
id|BUGMSG
c_func
(paren
id|D_NORMAL
comma
l_string|&quot;bug! prep_tx==0, but no continue_tx!&bslash;n&quot;
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
id|proto
op_member_access_from_pointer
id|continue_tx
c_func
(paren
id|dev
comma
id|txbuf
)paren
)paren
(brace
id|BUGMSG
c_func
(paren
id|D_NORMAL
comma
l_string|&quot;bug! continue_tx finished the first time! &quot;
l_string|&quot;(proto=&squot;%c&squot;)&bslash;n&quot;
comma
id|proto-&gt;suffix
)paren
suffix:semicolon
)brace
)brace
id|lp-&gt;next_tx
op_assign
id|txbuf
suffix:semicolon
)brace
r_else
id|dev_kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
multiline_comment|/* make sure we didn&squot;t ignore a TX IRQ while we were in here */
id|AINTMASK
c_func
(paren
l_int|0
)paren
suffix:semicolon
id|lp-&gt;intmask
op_or_assign
id|TXFREEflag
suffix:semicolon
id|AINTMASK
c_func
(paren
id|lp-&gt;intmask
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
multiline_comment|/* no need to try again */
)brace
multiline_comment|/*&n; * Actually start transmitting a packet that was loaded into a buffer&n; * by prepare_tx.  This should _only_ be called by the interrupt handler.&n; */
DECL|function|go_tx
r_static
r_int
id|go_tx
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|arcnet_local
op_star
id|lp
op_assign
(paren
r_struct
id|arcnet_local
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|BUGMSG
c_func
(paren
id|D_DURING
comma
l_string|&quot;go_tx: status=%Xh, intmask=%Xh, next_tx=%d, cur_tx=%d&bslash;n&quot;
comma
id|ASTATUS
c_func
(paren
)paren
comma
id|lp-&gt;intmask
comma
id|lp-&gt;next_tx
comma
id|lp-&gt;cur_tx
)paren
suffix:semicolon
r_if
c_cond
(paren
id|lp-&gt;cur_tx
op_ne
op_minus
l_int|1
op_logical_or
id|lp-&gt;next_tx
op_eq
op_minus
l_int|1
)paren
r_return
l_int|0
suffix:semicolon
id|BUGLVL
c_func
(paren
id|D_TX
)paren
id|arcnet_dump_packet
c_func
(paren
id|dev
comma
id|lp-&gt;next_tx
comma
l_string|&quot;go_tx&quot;
)paren
suffix:semicolon
id|lp-&gt;cur_tx
op_assign
id|lp-&gt;next_tx
suffix:semicolon
id|lp-&gt;next_tx
op_assign
op_minus
l_int|1
suffix:semicolon
multiline_comment|/* start sending */
id|ACOMMAND
c_func
(paren
id|TXcmd
op_or
(paren
id|lp-&gt;cur_tx
op_lshift
l_int|3
)paren
)paren
suffix:semicolon
id|dev-&gt;trans_start
op_assign
id|jiffies
suffix:semicolon
id|lp-&gt;stats.tx_packets
op_increment
suffix:semicolon
id|lp-&gt;lasttrans_dest
op_assign
id|lp-&gt;lastload_dest
suffix:semicolon
id|lp-&gt;lastload_dest
op_assign
l_int|0
suffix:semicolon
id|lp-&gt;intmask
op_or_assign
id|TXFREEflag
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
multiline_comment|/* Called by the kernel when transmit times out */
DECL|function|arcnet_timeout
r_static
r_void
id|arcnet_timeout
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
r_struct
id|arcnet_local
op_star
id|lp
op_assign
(paren
r_struct
id|arcnet_local
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_int
id|status
op_assign
id|ASTATUS
c_func
(paren
)paren
suffix:semicolon
r_char
op_star
id|msg
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
id|TXFREEflag
)paren
(brace
multiline_comment|/* transmit _DID_ finish */
id|msg
op_assign
l_string|&quot; - missed IRQ?&quot;
suffix:semicolon
)brace
r_else
(brace
id|msg
op_assign
l_string|&quot;&quot;
suffix:semicolon
id|lp-&gt;stats.tx_aborted_errors
op_increment
suffix:semicolon
id|lp-&gt;timed_out
op_assign
l_int|1
suffix:semicolon
id|ACOMMAND
c_func
(paren
id|NOTXcmd
op_or
(paren
id|lp-&gt;cur_tx
op_lshift
l_int|3
)paren
)paren
suffix:semicolon
)brace
id|lp-&gt;stats.tx_errors
op_increment
suffix:semicolon
multiline_comment|/* make sure we didn&squot;t miss a TX IRQ */
id|AINTMASK
c_func
(paren
l_int|0
)paren
suffix:semicolon
id|lp-&gt;intmask
op_or_assign
id|TXFREEflag
suffix:semicolon
id|AINTMASK
c_func
(paren
id|lp-&gt;intmask
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|jiffies
op_minus
id|lp-&gt;last_timeout
OG
l_int|10
op_star
id|HZ
)paren
(brace
id|BUGMSG
c_func
(paren
id|D_EXTRA
comma
l_string|&quot;tx timed out%s (status=%Xh, intmask=%Xh, dest=%02Xh)&bslash;n&quot;
comma
id|msg
comma
id|status
comma
id|lp-&gt;intmask
comma
id|lp-&gt;lasttrans_dest
)paren
suffix:semicolon
id|lp-&gt;last_timeout
op_assign
id|jiffies
suffix:semicolon
)brace
)brace
multiline_comment|/*&n; * The typical workload of the driver: Handle the network interface&n; * interrupts. Establish which device needs attention, and call the correct&n; * chipset interrupt handler.&n; */
DECL|function|arcnet_interrupt
r_void
id|arcnet_interrupt
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_struct
id|net_device
op_star
id|dev
op_assign
id|dev_id
suffix:semicolon
r_struct
id|arcnet_local
op_star
id|lp
suffix:semicolon
r_int
id|recbuf
comma
id|status
comma
id|didsomething
comma
id|boguscount
suffix:semicolon
id|BUGMSG
c_func
(paren
id|D_DURING
comma
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dev
op_eq
l_int|NULL
)paren
(brace
id|BUGMSG
c_func
(paren
id|D_DURING
comma
l_string|&quot;arcnet: irq %d for unknown device.&bslash;n&quot;
comma
id|irq
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|BUGMSG
c_func
(paren
id|D_DURING
comma
l_string|&quot;in arcnet_interrupt&bslash;n&quot;
)paren
suffix:semicolon
id|lp
op_assign
(paren
r_struct
id|arcnet_local
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|lp
)paren
(brace
id|BUGMSG
c_func
(paren
id|D_DURING
comma
l_string|&quot;arcnet: irq ignored due to missing lp.&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * RESET flag was enabled - if device is not running, we must clear it right&n;&t; * away (but nothing else).&n;&t; */
r_if
c_cond
(paren
op_logical_neg
id|netif_running
c_func
(paren
id|dev
)paren
)paren
(brace
r_if
c_cond
(paren
id|ASTATUS
c_func
(paren
)paren
op_amp
id|RESETflag
)paren
id|ACOMMAND
c_func
(paren
id|CFLAGScmd
op_or
id|RESETclear
)paren
suffix:semicolon
id|AINTMASK
c_func
(paren
l_int|0
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|BUGMSG
c_func
(paren
id|D_DURING
comma
l_string|&quot;in arcnet_inthandler (status=%Xh, intmask=%Xh)&bslash;n&quot;
comma
id|ASTATUS
c_func
(paren
)paren
comma
id|lp-&gt;intmask
)paren
suffix:semicolon
id|boguscount
op_assign
l_int|5
suffix:semicolon
r_do
(brace
id|status
op_assign
id|ASTATUS
c_func
(paren
)paren
suffix:semicolon
id|didsomething
op_assign
l_int|0
suffix:semicolon
multiline_comment|/*&n;&t;&t; * RESET flag was enabled - card is resetting and if RX is&n;&t;&t; * disabled, it&squot;s NOT because we just got a packet.&n;&t;&t; * &n;&t;&t; * The card is in an undefined state.  Clear it out and start over.&n;&t;&t; */
r_if
c_cond
(paren
id|status
op_amp
id|RESETflag
)paren
(brace
id|BUGMSG
c_func
(paren
id|D_NORMAL
comma
l_string|&quot;spurious reset (status=%Xh)&bslash;n&quot;
comma
id|status
)paren
suffix:semicolon
id|arcnet_close
c_func
(paren
id|dev
)paren
suffix:semicolon
id|arcnet_open
c_func
(paren
id|dev
)paren
suffix:semicolon
multiline_comment|/* get out of the interrupt handler! */
r_break
suffix:semicolon
)brace
multiline_comment|/* &n;&t;&t; * RX is inhibited - we must have received something. Prepare to&n;&t;&t; * receive into the next buffer.&n;&t;&t; * &n;&t;&t; * We don&squot;t actually copy the received packet from the card until&n;&t;&t; * after the transmit handler runs (and possibly launches the next&n;&t;&t; * tx); this should improve latency slightly if we get both types&n;&t;&t; * of interrupts at once. &n;&t;&t; */
id|recbuf
op_assign
op_minus
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
id|lp-&gt;intmask
op_amp
id|NORXflag
)paren
(brace
id|recbuf
op_assign
id|lp-&gt;cur_rx
suffix:semicolon
id|BUGMSG
c_func
(paren
id|D_DURING
comma
l_string|&quot;Buffer #%d: receive irq (status=%Xh)&bslash;n&quot;
comma
id|recbuf
comma
id|status
)paren
suffix:semicolon
id|lp-&gt;cur_rx
op_assign
id|get_arcbuf
c_func
(paren
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|lp-&gt;cur_rx
op_ne
op_minus
l_int|1
)paren
(brace
id|BUGMSG
c_func
(paren
id|D_DURING
comma
l_string|&quot;enabling receive to buffer #%d&bslash;n&quot;
comma
id|lp-&gt;cur_rx
)paren
suffix:semicolon
id|ACOMMAND
c_func
(paren
id|RXcmd
op_or
(paren
id|lp-&gt;cur_rx
op_lshift
l_int|3
)paren
op_or
id|RXbcasts
)paren
suffix:semicolon
)brace
id|didsomething
op_increment
suffix:semicolon
)brace
multiline_comment|/* a transmit finished, and we&squot;re interested in it. */
r_if
c_cond
(paren
(paren
id|status
op_amp
id|lp-&gt;intmask
op_amp
id|TXFREEflag
)paren
op_logical_or
id|lp-&gt;timed_out
)paren
(brace
id|lp-&gt;intmask
op_and_assign
op_complement
id|TXFREEflag
suffix:semicolon
id|BUGMSG
c_func
(paren
id|D_DURING
comma
l_string|&quot;TX IRQ (stat=%Xh)&bslash;n&quot;
comma
id|status
)paren
suffix:semicolon
r_if
c_cond
(paren
id|lp-&gt;cur_tx
op_ne
op_minus
l_int|1
op_logical_and
op_logical_neg
(paren
id|status
op_amp
id|TXACKflag
)paren
op_logical_and
op_logical_neg
id|lp-&gt;timed_out
)paren
(brace
r_if
c_cond
(paren
id|lp-&gt;lasttrans_dest
op_ne
l_int|0
)paren
(brace
id|BUGMSG
c_func
(paren
id|D_EXTRA
comma
l_string|&quot;transmit was not acknowledged! &quot;
l_string|&quot;(status=%Xh, dest=%02Xh)&bslash;n&quot;
comma
id|status
comma
id|lp-&gt;lasttrans_dest
)paren
suffix:semicolon
id|lp-&gt;stats.tx_errors
op_increment
suffix:semicolon
id|lp-&gt;stats.tx_carrier_errors
op_increment
suffix:semicolon
)brace
r_else
(brace
id|BUGMSG
c_func
(paren
id|D_DURING
comma
l_string|&quot;broadcast was not acknowledged; that&squot;s normal &quot;
l_string|&quot;(status=%Xh, dest=%02Xh)&bslash;n&quot;
comma
id|status
comma
id|lp-&gt;lasttrans_dest
)paren
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|lp-&gt;cur_tx
op_ne
op_minus
l_int|1
)paren
id|release_arcbuf
c_func
(paren
id|dev
comma
id|lp-&gt;cur_tx
)paren
suffix:semicolon
id|lp-&gt;cur_tx
op_assign
op_minus
l_int|1
suffix:semicolon
id|lp-&gt;timed_out
op_assign
l_int|0
suffix:semicolon
id|didsomething
op_increment
suffix:semicolon
multiline_comment|/* send another packet if there is one */
id|go_tx
c_func
(paren
id|dev
)paren
suffix:semicolon
multiline_comment|/* continue a split packet, if any */
r_if
c_cond
(paren
id|lp-&gt;outgoing.proto
op_logical_and
id|lp-&gt;outgoing.proto-&gt;continue_tx
)paren
(brace
r_int
id|txbuf
op_assign
id|get_arcbuf
c_func
(paren
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|txbuf
op_ne
op_minus
l_int|1
)paren
(brace
r_if
c_cond
(paren
id|lp-&gt;outgoing.proto
op_member_access_from_pointer
id|continue_tx
c_func
(paren
id|dev
comma
id|txbuf
)paren
)paren
(brace
multiline_comment|/* that was the last segment */
id|lp-&gt;stats.tx_bytes
op_add_assign
id|lp-&gt;outgoing.skb-&gt;len
suffix:semicolon
id|dev_kfree_skb_irq
c_func
(paren
id|lp-&gt;outgoing.skb
)paren
suffix:semicolon
id|lp-&gt;outgoing.proto
op_assign
l_int|NULL
suffix:semicolon
)brace
id|lp-&gt;next_tx
op_assign
id|txbuf
suffix:semicolon
)brace
)brace
multiline_comment|/* inform upper layers of idleness, if necessary */
r_if
c_cond
(paren
id|lp-&gt;cur_tx
op_eq
op_minus
l_int|1
)paren
id|netif_wake_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
multiline_comment|/* now process the received packet, if any */
r_if
c_cond
(paren
id|recbuf
op_ne
op_minus
l_int|1
)paren
(brace
id|BUGLVL
c_func
(paren
id|D_RX
)paren
id|arcnet_dump_packet
c_func
(paren
id|dev
comma
id|recbuf
comma
l_string|&quot;rx irq&quot;
)paren
suffix:semicolon
id|arcnet_rx
c_func
(paren
id|dev
comma
id|recbuf
)paren
suffix:semicolon
id|release_arcbuf
c_func
(paren
id|dev
comma
id|recbuf
)paren
suffix:semicolon
id|didsomething
op_increment
suffix:semicolon
)brace
r_if
c_cond
(paren
id|status
op_amp
id|lp-&gt;intmask
op_amp
id|RECONflag
)paren
(brace
id|ACOMMAND
c_func
(paren
id|CFLAGScmd
op_or
id|CONFIGclear
)paren
suffix:semicolon
id|lp-&gt;stats.tx_carrier_errors
op_increment
suffix:semicolon
id|BUGMSG
c_func
(paren
id|D_RECON
comma
l_string|&quot;Network reconfiguration detected (status=%Xh)&bslash;n&quot;
comma
id|status
)paren
suffix:semicolon
multiline_comment|/* is the RECON info empty or old? */
r_if
c_cond
(paren
op_logical_neg
id|lp-&gt;first_recon
op_logical_or
op_logical_neg
id|lp-&gt;last_recon
op_logical_or
id|jiffies
op_minus
id|lp-&gt;last_recon
OG
id|HZ
op_star
l_int|10
)paren
(brace
r_if
c_cond
(paren
id|lp-&gt;network_down
)paren
id|BUGMSG
c_func
(paren
id|D_NORMAL
comma
l_string|&quot;reconfiguration detected: cabling restored?&bslash;n&quot;
)paren
suffix:semicolon
id|lp-&gt;first_recon
op_assign
id|lp-&gt;last_recon
op_assign
id|jiffies
suffix:semicolon
id|lp-&gt;num_recons
op_assign
id|lp-&gt;network_down
op_assign
l_int|0
suffix:semicolon
id|BUGMSG
c_func
(paren
id|D_DURING
comma
l_string|&quot;recon: clearing counters.&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* add to current RECON counter */
id|lp-&gt;last_recon
op_assign
id|jiffies
suffix:semicolon
id|lp-&gt;num_recons
op_increment
suffix:semicolon
id|BUGMSG
c_func
(paren
id|D_DURING
comma
l_string|&quot;recon: counter=%d, time=%lds, net=%d&bslash;n&quot;
comma
id|lp-&gt;num_recons
comma
(paren
id|lp-&gt;last_recon
op_minus
id|lp-&gt;first_recon
)paren
op_div
id|HZ
comma
id|lp-&gt;network_down
)paren
suffix:semicolon
multiline_comment|/* if network is marked up;&n;&t;&t;&t;&t; * and first_recon and last_recon are 60+ apart;&n;&t;&t;&t;&t; * and the average no. of recons counted is&n;&t;&t;&t;&t; *    &gt; RECON_THRESHOLD/min;&n;&t;&t;&t;&t; * then print a warning message.&n;&t;&t;&t;&t; */
r_if
c_cond
(paren
op_logical_neg
id|lp-&gt;network_down
op_logical_and
(paren
id|lp-&gt;last_recon
op_minus
id|lp-&gt;first_recon
)paren
op_le
id|HZ
op_star
l_int|60
op_logical_and
id|lp-&gt;num_recons
op_ge
id|RECON_THRESHOLD
)paren
(brace
id|lp-&gt;network_down
op_assign
l_int|1
suffix:semicolon
id|BUGMSG
c_func
(paren
id|D_NORMAL
comma
l_string|&quot;many reconfigurations detected: cabling problem?&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
op_logical_neg
id|lp-&gt;network_down
op_logical_and
id|lp-&gt;last_recon
op_minus
id|lp-&gt;first_recon
OG
id|HZ
op_star
l_int|60
)paren
(brace
multiline_comment|/* reset counters if we&squot;ve gone for over a minute. */
id|lp-&gt;first_recon
op_assign
id|lp-&gt;last_recon
suffix:semicolon
id|lp-&gt;num_recons
op_assign
l_int|1
suffix:semicolon
)brace
)brace
)brace
r_else
r_if
c_cond
(paren
id|lp-&gt;network_down
op_logical_and
id|jiffies
op_minus
id|lp-&gt;last_recon
OG
id|HZ
op_star
l_int|10
)paren
(brace
r_if
c_cond
(paren
id|lp-&gt;network_down
)paren
id|BUGMSG
c_func
(paren
id|D_NORMAL
comma
l_string|&quot;cabling restored?&bslash;n&quot;
)paren
suffix:semicolon
id|lp-&gt;first_recon
op_assign
id|lp-&gt;last_recon
op_assign
l_int|0
suffix:semicolon
id|lp-&gt;num_recons
op_assign
id|lp-&gt;network_down
op_assign
l_int|0
suffix:semicolon
id|BUGMSG
c_func
(paren
id|D_DURING
comma
l_string|&quot;not recon: clearing counters anyway.&bslash;n&quot;
)paren
suffix:semicolon
)brace
)brace
r_while
c_loop
(paren
op_decrement
id|boguscount
op_logical_and
id|didsomething
)paren
suffix:semicolon
id|BUGMSG
c_func
(paren
id|D_DURING
comma
l_string|&quot;arcnet_interrupt complete (status=%Xh, count=%d)&bslash;n&quot;
comma
id|ASTATUS
c_func
(paren
)paren
comma
id|boguscount
)paren
suffix:semicolon
id|BUGMSG
c_func
(paren
id|D_DURING
comma
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
id|AINTMASK
c_func
(paren
l_int|0
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|1
)paren
suffix:semicolon
id|AINTMASK
c_func
(paren
id|lp-&gt;intmask
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * This is a generic packet receiver that calls arcnet??_rx depending on the&n; * protocol ID found.&n; */
DECL|function|arcnet_rx
r_void
id|arcnet_rx
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_int
id|bufnum
)paren
(brace
r_struct
id|arcnet_local
op_star
id|lp
op_assign
(paren
r_struct
id|arcnet_local
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_struct
id|archdr
id|pkt
suffix:semicolon
r_struct
id|arc_rfc1201
op_star
id|soft
suffix:semicolon
r_int
id|length
comma
id|ofs
suffix:semicolon
id|soft
op_assign
op_amp
id|pkt.soft.rfc1201
suffix:semicolon
id|lp-&gt;hw
dot
id|copy_from_card
c_func
(paren
id|dev
comma
id|bufnum
comma
l_int|0
comma
op_amp
id|pkt
comma
r_sizeof
(paren
id|ARC_HDR_SIZE
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pkt.hard.offset
(braket
l_int|0
)braket
)paren
(brace
id|ofs
op_assign
id|pkt.hard.offset
(braket
l_int|0
)braket
suffix:semicolon
id|length
op_assign
l_int|256
op_minus
id|ofs
suffix:semicolon
)brace
r_else
(brace
id|ofs
op_assign
id|pkt.hard.offset
(braket
l_int|1
)braket
suffix:semicolon
id|length
op_assign
l_int|512
op_minus
id|ofs
suffix:semicolon
)brace
multiline_comment|/* get the full header, if possible */
r_if
c_cond
(paren
r_sizeof
(paren
id|pkt.soft
)paren
OL
id|length
)paren
id|lp-&gt;hw
dot
id|copy_from_card
c_func
(paren
id|dev
comma
id|bufnum
comma
id|ofs
comma
id|soft
comma
r_sizeof
(paren
id|pkt.soft
)paren
)paren
suffix:semicolon
r_else
(brace
id|memset
c_func
(paren
op_amp
id|pkt.soft
comma
l_int|0
comma
r_sizeof
(paren
id|pkt.soft
)paren
)paren
suffix:semicolon
id|lp-&gt;hw
dot
id|copy_from_card
c_func
(paren
id|dev
comma
id|bufnum
comma
id|ofs
comma
id|soft
comma
id|length
)paren
suffix:semicolon
)brace
id|BUGMSG
c_func
(paren
id|D_DURING
comma
l_string|&quot;Buffer #%d: received packet from %02Xh to %02Xh &quot;
l_string|&quot;(%d+4 bytes)&bslash;n&quot;
comma
id|bufnum
comma
id|pkt.hard.source
comma
id|pkt.hard.dest
comma
id|length
)paren
suffix:semicolon
id|lp-&gt;stats.rx_packets
op_increment
suffix:semicolon
id|lp-&gt;stats.rx_bytes
op_add_assign
id|length
op_plus
id|ARC_HDR_SIZE
suffix:semicolon
multiline_comment|/* call the right receiver for the protocol */
r_if
c_cond
(paren
id|arc_proto_map
(braket
id|soft-&gt;proto
)braket
op_ne
op_amp
id|arc_proto_null
)paren
(brace
id|BUGLVL
c_func
(paren
id|D_PROTO
)paren
(brace
r_struct
id|ArcProto
op_star
id|oldp
op_assign
id|arc_proto_map
(braket
id|lp-&gt;default_proto
(braket
id|pkt.hard.source
)braket
)braket
comma
op_star
id|newp
op_assign
id|arc_proto_map
(braket
id|soft-&gt;proto
)braket
suffix:semicolon
r_if
c_cond
(paren
id|oldp
op_ne
id|newp
)paren
(brace
id|BUGMSG
c_func
(paren
id|D_PROTO
comma
l_string|&quot;got protocol %02Xh; encap for host %02Xh is now &squot;%c&squot;&quot;
l_string|&quot; (was &squot;%c&squot;)&bslash;n&quot;
comma
id|soft-&gt;proto
comma
id|pkt.hard.source
comma
id|newp-&gt;suffix
comma
id|oldp-&gt;suffix
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* broadcasts will always be done with the last-used encap. */
id|lp-&gt;default_proto
(braket
l_int|0
)braket
op_assign
id|soft-&gt;proto
suffix:semicolon
multiline_comment|/* in striking contrast, the following isn&squot;t a hack. */
id|lp-&gt;default_proto
(braket
id|pkt.hard.source
)braket
op_assign
id|soft-&gt;proto
suffix:semicolon
)brace
multiline_comment|/* call the protocol-specific receiver. */
id|arc_proto_map
(braket
id|soft-&gt;proto
)braket
op_member_access_from_pointer
id|rx
c_func
(paren
id|dev
comma
id|bufnum
comma
op_amp
id|pkt
comma
id|length
)paren
suffix:semicolon
)brace
multiline_comment|/* &n; * Get the current statistics.  This may be called with the card open or&n; * closed.&n; */
DECL|function|arcnet_get_stats
r_static
r_struct
id|net_device_stats
op_star
id|arcnet_get_stats
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|arcnet_local
op_star
id|lp
op_assign
(paren
r_struct
id|arcnet_local
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_return
op_amp
id|lp-&gt;stats
suffix:semicolon
)brace
DECL|function|null_rx
r_static
r_void
id|null_rx
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_int
id|bufnum
comma
r_struct
id|archdr
op_star
id|pkthdr
comma
r_int
id|length
)paren
(brace
id|BUGMSG
c_func
(paren
id|D_PROTO
comma
l_string|&quot;rx: don&squot;t know how to deal with proto %02Xh from host %02Xh.&bslash;n&quot;
comma
id|pkthdr-&gt;soft.rfc1201.proto
comma
id|pkthdr-&gt;hard.source
)paren
suffix:semicolon
)brace
DECL|function|null_build_header
r_static
r_int
id|null_build_header
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_int
r_int
id|type
comma
r_uint8
id|daddr
)paren
(brace
r_struct
id|net_device
op_star
id|dev
op_assign
id|skb-&gt;dev
suffix:semicolon
r_struct
id|arcnet_local
op_star
id|lp
op_assign
(paren
r_struct
id|arcnet_local
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|BUGMSG
c_func
(paren
id|D_PROTO
comma
l_string|&quot;tx: can&squot;t build header for encap %02Xh; load a protocol driver.&bslash;n&quot;
comma
id|lp-&gt;default_proto
(braket
id|daddr
)braket
)paren
suffix:semicolon
multiline_comment|/* always fails */
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* the &quot;do nothing&quot; prepare_tx function warns that there&squot;s nothing to do. */
DECL|function|null_prepare_tx
r_static
r_int
id|null_prepare_tx
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_struct
id|archdr
op_star
id|pkt
comma
r_int
id|length
comma
r_int
id|bufnum
)paren
(brace
r_struct
id|arcnet_local
op_star
id|lp
op_assign
(paren
r_struct
id|arcnet_local
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_struct
id|arc_hardware
id|newpkt
suffix:semicolon
id|BUGMSG
c_func
(paren
id|D_PROTO
comma
l_string|&quot;tx: no encap for this host; load a protocol driver.&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* send a packet to myself -- will never get received, of course */
id|newpkt.source
op_assign
id|newpkt.dest
op_assign
id|dev-&gt;dev_addr
(braket
l_int|0
)braket
suffix:semicolon
multiline_comment|/* only one byte of actual data (and it&squot;s random) */
id|newpkt.offset
(braket
l_int|0
)braket
op_assign
l_int|0xFF
suffix:semicolon
id|lp-&gt;hw
dot
id|copy_to_card
c_func
(paren
id|dev
comma
id|bufnum
comma
l_int|0
comma
op_amp
id|newpkt
comma
id|ARC_HDR_SIZE
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
multiline_comment|/* done */
)brace
eof
